<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Budget â€” Personal Budget Tool</title>
    <meta name="description" content="An interactive personal budget tool. Track income, expenses, and savings goals." />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #FAFAFA;
        color: #1A1A1A;
        -webkit-font-smoothing: antialiased;
      }
      #my-budget-root {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        box-sizing: border-box;
      }
      #my-budget-root > * {
        width: 100%;
        max-width: 100%;
      }
      @media print {
        .no-print { display: none !important; }
        body { background: white; }
      }
    </style>
  </head>
  <body>
    <div id="my-budget-root"></div>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <script type="module">
      // Decode and execute the base64-encoded React bundle
      const encodedScript = "dmFyIF9fY3JlYXRlID0gT2JqZWN0LmNyZWF0ZTsKdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZ2V0T3duUHJvcERlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOwp2YXIgX19nZXRPd25Qcm9wTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lczsKdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CnZhciBfX2NvbW1vbkpTID0gKGNiLCBtb2QpID0+IGZ1bmN0aW9uIF9fcmVxdWlyZSgpIHsKICByZXR1cm4gbW9kIHx8ICgwLCBjYltfX2dldE93blByb3BOYW1lcyhjYilbMF1dKSgobW9kID0geyBleHBvcnRzOiB7fSB9KS5leHBvcnRzLCBtb2QpLCBtb2QuZXhwb3J0czsKfTsKdmFyIF9fZXhwb3J0ID0gKHRhcmdldCwgYWxsKSA9PiB7CiAgZm9yICh2YXIgbmFtZSBpbiBhbGwpCiAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwp9Owp2YXIgX19jb3B5UHJvcHMgPSAodG8yLCBmcm9tMiwgZXhjZXB0LCBkZXNjKSA9PiB7CiAgaWYgKGZyb20yICYmIHR5cGVvZiBmcm9tMiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGZyb20yID09PSAiZnVuY3Rpb24iKSB7CiAgICBmb3IgKGxldCBrZXkgb2YgX19nZXRPd25Qcm9wTmFtZXMoZnJvbTIpKQogICAgICBpZiAoIV9faGFzT3duUHJvcC5jYWxsKHRvMiwga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICBfX2RlZlByb3AodG8yLCBrZXksIHsgZ2V0OiAoKSA9PiBmcm9tMltrZXldLCBlbnVtZXJhYmxlOiAhKGRlc2MgPSBfX2dldE93blByb3BEZXNjKGZyb20yLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgfQogIHJldHVybiB0bzI7Cn07CnZhciBfX3RvRVNNID0gKG1vZCwgaXNOb2RlTW9kZSwgdGFyZ2V0KSA9PiAodGFyZ2V0ID0gbW9kICE9IG51bGwgPyBfX2NyZWF0ZShfX2dldFByb3RvT2YobW9kKSkgOiB7fSwgX19jb3B5UHJvcHMoCiAgLy8gSWYgdGhlIGltcG9ydGVyIGlzIGluIG5vZGUgY29tcGF0aWJpbGl0eSBtb2RlIG9yIHRoaXMgaXMgbm90IGFuIEVTTQogIC8vIGZpbGUgdGhhdCBoYXMgYmVlbiBjb252ZXJ0ZWQgdG8gYSBDb21tb25KUyBmaWxlIHVzaW5nIGEgQmFiZWwtCiAgLy8gY29tcGF0aWJsZSB0cmFuc2Zvcm0gKGkuZS4gIl9fZXNNb2R1bGUiIGhhcyBub3QgYmVlbiBzZXQpLCB0aGVuIHNldAogIC8vICJkZWZhdWx0IiB0byB0aGUgQ29tbW9uSlMgIm1vZHVsZS5leHBvcnRzIiBmb3Igbm9kZSBjb21wYXRpYmlsaXR5LgogIGlzTm9kZU1vZGUgfHwgIW1vZCB8fCAhbW9kLl9fZXNNb2R1bGUgPyBfX2RlZlByb3AodGFyZ2V0LCAiZGVmYXVsdCIsIHsgdmFsdWU6IG1vZCwgZW51bWVyYWJsZTogdHJ1ZSB9KSA6IHRhcmdldCwKICBtb2QKKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfcmVhY3RfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LmRldmVsb3BtZW50LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmICh0cnVlKSB7CiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0KG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0VmVyc2lvbiA9ICIxOC4zLjEiOwogICAgICAgIHZhciBSRUFDVF9FTEVNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5lbGVtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1BPUlRBTF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucG9ydGFsIik7CiAgICAgICAgdmFyIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mcmFnbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3RyaWN0X21vZGUiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPRklMRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb2ZpbGVyIik7CiAgICAgICAgdmFyIFJFQUNUX1BST1ZJREVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm92aWRlciIpOwogICAgICAgIHZhciBSRUFDVF9DT05URVhUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jb250ZXh0Iik7CiAgICAgICAgdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0Lm1lbW8iKTsKICAgICAgICB2YXIgUkVBQ1RfTEFaWV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubGF6eSIpOwogICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgIHZhciBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgPSBTeW1ib2wuaXRlcmF0b3I7CiAgICAgICAgdmFyIEZBVVhfSVRFUkFUT1JfU1lNQk9MID0gIkBAaXRlcmF0b3IiOwogICAgICAgIGZ1bmN0aW9uIGdldEl0ZXJhdG9yRm4obWF5YmVJdGVyYWJsZSkgewogICAgICAgICAgaWYgKG1heWJlSXRlcmFibGUgPT09IG51bGwgfHwgdHlwZW9mIG1heWJlSXRlcmFibGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1heWJlSXRlcmF0b3IgPSBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgJiYgbWF5YmVJdGVyYWJsZVtNQVlCRV9JVEVSQVRPUl9TWU1CT0xdIHx8IG1heWJlSXRlcmFibGVbRkFVWF9JVEVSQVRPUl9TWU1CT0xdOwogICAgICAgICAgaWYgKHR5cGVvZiBtYXliZUl0ZXJhdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBtYXliZUl0ZXJhdG9yOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyID0gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqIEB0eXBlIHtSZWFjdENvbXBvbmVudH0KICAgICAgICAgICAqLwogICAgICAgICAgY3VycmVudDogbnVsbAogICAgICAgIH07CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnID0gewogICAgICAgICAgdHJhbnNpdGlvbjogbnVsbAogICAgICAgIH07CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEFjdFF1ZXVlID0gewogICAgICAgICAgY3VycmVudDogbnVsbCwKICAgICAgICAgIC8vIFVzZWQgdG8gcmVwcm9kdWNlIGJlaGF2aW9yIG9mIGBiYXRjaGVkVXBkYXRlc2AgaW4gbGVnYWN5IG1vZGUuCiAgICAgICAgICBpc0JhdGNoaW5nTGVnYWN5OiBmYWxzZSwKICAgICAgICAgIGRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlOiBmYWxzZQogICAgICAgIH07CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyID0gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqIEB0eXBlIHtSZWFjdENvbXBvbmVudH0KICAgICAgICAgICAqLwogICAgICAgICAgY3VycmVudDogbnVsbAogICAgICAgIH07CiAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUgPSB7fTsKICAgICAgICB2YXIgY3VycmVudEV4dHJhU3RhY2tGcmFtZSA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRFeHRyYVN0YWNrRnJhbWUgPSBzdGFjazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgewogICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5zZXRFeHRyYVN0YWNrRnJhbWUgPSBmdW5jdGlvbihzdGFjaykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY3VycmVudEV4dHJhU3RhY2tGcmFtZSA9IHN0YWNrOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5nZXRDdXJyZW50U3RhY2sgPSBudWxsOwogICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5nZXRTdGFja0FkZGVuZHVtID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzdGFjayA9ICIiOwogICAgICAgICAgICBpZiAoY3VycmVudEV4dHJhU3RhY2tGcmFtZSkgewogICAgICAgICAgICAgIHN0YWNrICs9IGN1cnJlbnRFeHRyYVN0YWNrRnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGltcGwgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjazsKICAgICAgICAgICAgaWYgKGltcGwpIHsKICAgICAgICAgICAgICBzdGFjayArPSBpbXBsKCkgfHwgIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0YWNrOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGVuYWJsZVNjb3BlQVBJID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUNhY2hlRWxlbWVudCA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVUcmFuc2l0aW9uVHJhY2luZyA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMZWdhY3lIaWRkZW4gPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlRGVidWdUcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIFJlYWN0U2hhcmVkSW50ZXJuYWxzID0gewogICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciwKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLAogICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIKICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWUgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgICAgUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QWN0UXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybjMoZm9ybWF0MikgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygid2FybiIsIGZvcm1hdDIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiA+IDEgPyBfbGVuMiAtIDEgOiAwKSwgX2tleTIgPSAxOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoImVycm9yIiwgZm9ybWF0MiwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJpbnRXYXJuaW5nKGxldmVsLCBmb3JtYXQyLCBhcmdzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICAgIHZhciBzdGFjayA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUyLmdldFN0YWNrQWRkZW5kdW0oKTsKICAgICAgICAgICAgaWYgKHN0YWNrICE9PSAiIikgewogICAgICAgICAgICAgIGZvcm1hdDIgKz0gIiVzIjsKICAgICAgICAgICAgICBhcmdzID0gYXJncy5jb25jYXQoW3N0YWNrXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3NXaXRoRm9ybWF0ID0gYXJncy5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgIHJldHVybiBTdHJpbmcoaXRlbSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhcmdzV2l0aEZvcm1hdC51bnNoaWZ0KCJXYXJuaW5nOiAiICsgZm9ybWF0Mik7CiAgICAgICAgICAgIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKGNvbnNvbGVbbGV2ZWxdLCBjb25zb2xlLCBhcmdzV2l0aEZvcm1hdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnQgPSB7fTsKICAgICAgICBmdW5jdGlvbiB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgY2FsbGVyTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgX2NvbnN0cnVjdG9yID0gcHVibGljSW5zdGFuY2UuY29uc3RydWN0b3I7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gX2NvbnN0cnVjdG9yICYmIChfY29uc3RydWN0b3IuZGlzcGxheU5hbWUgfHwgX2NvbnN0cnVjdG9yLm5hbWUpIHx8ICJSZWFjdENsYXNzIjsKICAgICAgICAgICAgdmFyIHdhcm5pbmdLZXkgPSBjb21wb25lbnROYW1lICsgIi4iICsgY2FsbGVyTmFtZTsKICAgICAgICAgICAgaWYgKGRpZFdhcm5TdGF0ZVVwZGF0ZUZvclVubW91bnRlZENvbXBvbmVudFt3YXJuaW5nS2V5XSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlcnJvcigiQ2FuJ3QgY2FsbCAlcyBvbiBhIGNvbXBvbmVudCB0aGF0IGlzIG5vdCB5ZXQgbW91bnRlZC4gVGhpcyBpcyBhIG5vLW9wLCBidXQgaXQgbWlnaHQgaW5kaWNhdGUgYSBidWcgaW4geW91ciBhcHBsaWNhdGlvbi4gSW5zdGVhZCwgYXNzaWduIHRvIGB0aGlzLnN0YXRlYCBkaXJlY3RseSBvciBkZWZpbmUgYSBgc3RhdGUgPSB7fTtgIGNsYXNzIHByb3BlcnR5IHdpdGggdGhlIGRlc2lyZWQgc3RhdGUgaW4gdGhlICVzIGNvbXBvbmVudC4iLCBjYWxsZXJOYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yVW5tb3VudGVkQ29tcG9uZW50W3dhcm5pbmdLZXldID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlID0gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBDaGVja3Mgd2hldGhlciBvciBub3QgdGhpcyBjb21wb3NpdGUgY29tcG9uZW50IGlzIG1vdW50ZWQuCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB3ZSB3YW50IHRvIHRlc3QuCiAgICAgICAgICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIG1vdW50ZWQsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgICAqIEBwcm90ZWN0ZWQKICAgICAgICAgICAqIEBmaW5hbAogICAgICAgICAgICovCiAgICAgICAgICBpc01vdW50ZWQ6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0sCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEZvcmNlcyBhbiB1cGRhdGUuIFRoaXMgc2hvdWxkIG9ubHkgYmUgaW52b2tlZCB3aGVuIGl0IGlzIGtub3duIHdpdGgKICAgICAgICAgICAqIGNlcnRhaW50eSB0aGF0IHdlIGFyZSAqKm5vdCoqIGluIGEgRE9NIHRyYW5zYWN0aW9uLgogICAgICAgICAgICoKICAgICAgICAgICAqIFlvdSBtYXkgd2FudCB0byBjYWxsIHRoaXMgd2hlbiB5b3Uga25vdyB0aGF0IHNvbWUgZGVlcGVyIGFzcGVjdCBvZiB0aGUKICAgICAgICAgICAqIGNvbXBvbmVudCdzIHN0YXRlIGhhcyBjaGFuZ2VkIGJ1dCBgc2V0U3RhdGVgIHdhcyBub3QgY2FsbGVkLgogICAgICAgICAgICoKICAgICAgICAgICAqIFRoaXMgd2lsbCBub3QgaW52b2tlIGBzaG91bGRDb21wb25lbnRVcGRhdGVgLCBidXQgaXQgd2lsbCBpbnZva2UKICAgICAgICAgICAqIGBjb21wb25lbnRXaWxsVXBkYXRlYCBhbmQgYGNvbXBvbmVudERpZFVwZGF0ZWAuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2UgdGhhdCBzaG91bGQgcmVyZW5kZXIuCiAgICAgICAgICAgKiBAcGFyYW0gez9mdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGVkIGFmdGVyIGNvbXBvbmVudCBpcyB1cGRhdGVkLgogICAgICAgICAgICogQHBhcmFtIHs/c3RyaW5nfSBjYWxsZXJOYW1lIG5hbWUgb2YgdGhlIGNhbGxpbmcgZnVuY3Rpb24gaW4gdGhlIHB1YmxpYyBBUEkuCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqLwogICAgICAgICAgZW5xdWV1ZUZvcmNlVXBkYXRlOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSwgY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgICAgd2Fybk5vb3AocHVibGljSW5zdGFuY2UsICJmb3JjZVVwZGF0ZSIpOwogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogUmVwbGFjZXMgYWxsIG9mIHRoZSBzdGF0ZS4gQWx3YXlzIHVzZSB0aGlzIG9yIGBzZXRTdGF0ZWAgdG8gbXV0YXRlIHN0YXRlLgogICAgICAgICAgICogWW91IHNob3VsZCB0cmVhdCBgdGhpcy5zdGF0ZWAgYXMgaW1tdXRhYmxlLgogICAgICAgICAgICoKICAgICAgICAgICAqIFRoZXJlIGlzIG5vIGd1YXJhbnRlZSB0aGF0IGB0aGlzLnN0YXRlYCB3aWxsIGJlIGltbWVkaWF0ZWx5IHVwZGF0ZWQsIHNvCiAgICAgICAgICAgKiBhY2Nlc3NpbmcgYHRoaXMuc3RhdGVgIGFmdGVyIGNhbGxpbmcgdGhpcyBtZXRob2QgbWF5IHJldHVybiB0aGUgb2xkIHZhbHVlLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7UmVhY3RDbGFzc30gcHVibGljSW5zdGFuY2UgVGhlIGluc3RhbmNlIHRoYXQgc2hvdWxkIHJlcmVuZGVyLgogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGNvbXBsZXRlU3RhdGUgTmV4dCBzdGF0ZS4KICAgICAgICAgICAqIEBwYXJhbSB7P2Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsZWQgYWZ0ZXIgY29tcG9uZW50IGlzIHVwZGF0ZWQuCiAgICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IGNhbGxlck5hbWUgbmFtZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBpbiB0aGUgcHVibGljIEFQSS4KICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICBlbnF1ZXVlUmVwbGFjZVN0YXRlOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSwgY29tcGxldGVTdGF0ZSwgY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgICAgd2Fybk5vb3AocHVibGljSW5zdGFuY2UsICJyZXBsYWNlU3RhdGUiKTsKICAgICAgICAgIH0sCiAgICAgICAgICAvKioKICAgICAgICAgICAqIFNldHMgYSBzdWJzZXQgb2YgdGhlIHN0YXRlLiBUaGlzIG9ubHkgZXhpc3RzIGJlY2F1c2UgX3BlbmRpbmdTdGF0ZSBpcwogICAgICAgICAgICogaW50ZXJuYWwuIFRoaXMgcHJvdmlkZXMgYSBtZXJnaW5nIHN0cmF0ZWd5IHRoYXQgaXMgbm90IGF2YWlsYWJsZSB0byBkZWVwCiAgICAgICAgICAgKiBwcm9wZXJ0aWVzIHdoaWNoIGlzIGNvbmZ1c2luZy4gVE9ETzogRXhwb3NlIHBlbmRpbmdTdGF0ZSBvciBkb24ndCB1c2UgaXQKICAgICAgICAgICAqIGR1cmluZyB0aGUgbWVyZ2UuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2UgdGhhdCBzaG91bGQgcmVyZW5kZXIuCiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gcGFydGlhbFN0YXRlIE5leHQgcGFydGlhbCBzdGF0ZSB0byBiZSBtZXJnZWQgd2l0aCBzdGF0ZS4KICAgICAgICAgICAqIEBwYXJhbSB7P2Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsZWQgYWZ0ZXIgY29tcG9uZW50IGlzIHVwZGF0ZWQuCiAgICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IE5hbWUgb2YgdGhlIGNhbGxpbmcgZnVuY3Rpb24gaW4gdGhlIHB1YmxpYyBBUEkuCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqLwogICAgICAgICAgZW5xdWV1ZVNldFN0YXRlOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSwgcGFydGlhbFN0YXRlLCBjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgInNldFN0YXRlIik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB2YXIgYXNzaWduMiA9IE9iamVjdC5hc3NpZ247CiAgICAgICAgdmFyIGVtcHR5T2JqZWN0ID0ge307CiAgICAgICAgewogICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbXB0eU9iamVjdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIENvbXBvbmVudChwcm9wcywgY29udGV4dCwgdXBkYXRlcikgewogICAgICAgICAgdGhpcy5wcm9wcyA9IHByb3BzOwogICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIHRoaXMucmVmcyA9IGVtcHR5T2JqZWN0OwogICAgICAgICAgdGhpcy51cGRhdGVyID0gdXBkYXRlciB8fCBSZWFjdE5vb3BVcGRhdGVRdWV1ZTsKICAgICAgICB9CiAgICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50ID0ge307CiAgICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5zZXRTdGF0ZSA9IGZ1bmN0aW9uKHBhcnRpYWxTdGF0ZSwgY2FsbGJhY2spIHsKICAgICAgICAgIGlmICh0eXBlb2YgcGFydGlhbFN0YXRlICE9PSAib2JqZWN0IiAmJiB0eXBlb2YgcGFydGlhbFN0YXRlICE9PSAiZnVuY3Rpb24iICYmIHBhcnRpYWxTdGF0ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2V0U3RhdGUoLi4uKTogdGFrZXMgYW4gb2JqZWN0IG9mIHN0YXRlIHZhcmlhYmxlcyB0byB1cGRhdGUgb3IgYSBmdW5jdGlvbiB3aGljaCByZXR1cm5zIGFuIG9iamVjdCBvZiBzdGF0ZSB2YXJpYWJsZXMuIik7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnVwZGF0ZXIuZW5xdWV1ZVNldFN0YXRlKHRoaXMsIHBhcnRpYWxTdGF0ZSwgY2FsbGJhY2ssICJzZXRTdGF0ZSIpOwogICAgICAgIH07CiAgICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5mb3JjZVVwZGF0ZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICB0aGlzLnVwZGF0ZXIuZW5xdWV1ZUZvcmNlVXBkYXRlKHRoaXMsIGNhbGxiYWNrLCAiZm9yY2VVcGRhdGUiKTsKICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHZhciBkZXByZWNhdGVkQVBJcyA9IHsKICAgICAgICAgICAgaXNNb3VudGVkOiBbImlzTW91bnRlZCIsICJJbnN0ZWFkLCBtYWtlIHN1cmUgdG8gY2xlYW4gdXAgc3Vic2NyaXB0aW9ucyBhbmQgcGVuZGluZyByZXF1ZXN0cyBpbiBjb21wb25lbnRXaWxsVW5tb3VudCB0byBwcmV2ZW50IG1lbW9yeSBsZWFrcy4iXSwKICAgICAgICAgICAgcmVwbGFjZVN0YXRlOiBbInJlcGxhY2VTdGF0ZSIsICJSZWZhY3RvciB5b3VyIGNvZGUgdG8gdXNlIHNldFN0YXRlIGluc3RlYWQgKHNlZSBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svcmVhY3QvaXNzdWVzLzMyMzYpLiJdCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGRlZmluZURlcHJlY2F0aW9uV2FybmluZyA9IGZ1bmN0aW9uKG1ldGhvZE5hbWUsIGluZm8pIHsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KENvbXBvbmVudC5wcm90b3R5cGUsIG1ldGhvZE5hbWUsIHsKICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgd2FybjMoIiVzKC4uLikgaXMgZGVwcmVjYXRlZCBpbiBwbGFpbiBKYXZhU2NyaXB0IFJlYWN0IGNsYXNzZXMuICVzIiwgaW5mb1swXSwgaW5mb1sxXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgICAgZm9yICh2YXIgZm5OYW1lIGluIGRlcHJlY2F0ZWRBUElzKSB7CiAgICAgICAgICAgIGlmIChkZXByZWNhdGVkQVBJcy5oYXNPd25Qcm9wZXJ0eShmbk5hbWUpKSB7CiAgICAgICAgICAgICAgZGVmaW5lRGVwcmVjYXRpb25XYXJuaW5nKGZuTmFtZSwgZGVwcmVjYXRlZEFQSXNbZm5OYW1lXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gQ29tcG9uZW50RHVtbXkoKSB7CiAgICAgICAgfQogICAgICAgIENvbXBvbmVudER1bW15LnByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgZnVuY3Rpb24gUHVyZUNvbXBvbmVudDMocHJvcHMsIGNvbnRleHQsIHVwZGF0ZXIpIHsKICAgICAgICAgIHRoaXMucHJvcHMgPSBwcm9wczsKICAgICAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICB0aGlzLnJlZnMgPSBlbXB0eU9iamVjdDsKICAgICAgICAgIHRoaXMudXBkYXRlciA9IHVwZGF0ZXIgfHwgUmVhY3ROb29wVXBkYXRlUXVldWU7CiAgICAgICAgfQogICAgICAgIHZhciBwdXJlQ29tcG9uZW50UHJvdG90eXBlID0gUHVyZUNvbXBvbmVudDMucHJvdG90eXBlID0gbmV3IENvbXBvbmVudER1bW15KCk7CiAgICAgICAgcHVyZUNvbXBvbmVudFByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFB1cmVDb21wb25lbnQzOwogICAgICAgIGFzc2lnbjIocHVyZUNvbXBvbmVudFByb3RvdHlwZSwgQ29tcG9uZW50LnByb3RvdHlwZSk7CiAgICAgICAgcHVyZUNvbXBvbmVudFByb3RvdHlwZS5pc1B1cmVSZWFjdENvbXBvbmVudCA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUmVmKCkgewogICAgICAgICAgdmFyIHJlZk9iamVjdCA9IHsKICAgICAgICAgICAgY3VycmVudDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgT2JqZWN0LnNlYWwocmVmT2JqZWN0KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZWZPYmplY3Q7CiAgICAgICAgfQogICAgICAgIHZhciBpc0FycmF5SW1wbCA9IEFycmF5LmlzQXJyYXk7CiAgICAgICAgZnVuY3Rpb24gaXNBcnJheTIoYSkgewogICAgICAgICAgcmV0dXJuIGlzQXJyYXlJbXBsKGEpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0eXBlTmFtZSh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzVG9TdHJpbmdUYWcgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC50b1N0cmluZ1RhZzsKICAgICAgICAgICAgdmFyIHR5cGUgPSBoYXNUb1N0cmluZ1RhZyAmJiB2YWx1ZVtTeW1ib2wudG9TdHJpbmdUYWddIHx8IHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUgfHwgIk9iamVjdCI7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tLZXlTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBrZXkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUob3V0ZXJUeXBlLCBpbm5lclR5cGUsIHdyYXBwZXJOYW1lKSB7CiAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSBvdXRlclR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICBpZiAoZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlLnRhZyA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgYW4gdW5leHBlY3RlZCBvYmplY3QgaW4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKCkuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQb3J0YWwiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQcm9maWxlciI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN0cmljdE1vZGUiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2VMaXN0IjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05URVhUX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUoY29udGV4dCkgKyAiLkNvbnN1bWVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgICAgIHZhciBSRVNFUlZFRF9QUk9QUyA9IHsKICAgICAgICAgIGtleTogdHJ1ZSwKICAgICAgICAgIHJlZjogdHJ1ZSwKICAgICAgICAgIF9fc2VsZjogdHJ1ZSwKICAgICAgICAgIF9fc291cmNlOiB0cnVlCiAgICAgICAgfTsKICAgICAgICB2YXIgc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24sIHNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duLCBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnMgPSB7fTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRSZWYoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgInJlZiIpKSB7CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAicmVmIikuZ2V0OwogICAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29uZmlnLnJlZiAhPT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNWYWxpZEtleShjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCAia2V5IikpIHsKICAgICAgICAgICAgICB2YXIgZ2V0dGVyID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjb25maWcsICJrZXkiKS5nZXQ7CiAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb25maWcua2V5ICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgICAgdmFyIHdhcm5BYm91dEFjY2Vzc2luZ0tleSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93bikgewogICAgICAgICAgICAgICAgc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBga2V5YCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGJlaW5nIHJldHVybmVkLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNhbWUgdmFsdWUgd2l0aGluIHRoZSBjaGlsZCBjb21wb25lbnQsIHlvdSBzaG91bGQgcGFzcyBpdCBhcyBhIGRpZmZlcmVudCBwcm9wLiAoaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NwZWNpYWwtcHJvcHMpIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5BYm91dEFjY2Vzc2luZ0tleS5pc1JlYWN0V2FybmluZyA9IHRydWU7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICJrZXkiLCB7CiAgICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nS2V5LAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWZpbmVSZWZQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpIHsKICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICAgIHNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogYHJlZmAgaXMgbm90IGEgcHJvcC4gVHJ5aW5nIHRvIGFjY2VzcyBpdCB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBiZWluZyByZXR1cm5lZC4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzYW1lIHZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgcHJvcC4gKGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zcGVjaWFsLXByb3BzKSIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAicmVmIiwgewogICAgICAgICAgICBnZXQ6IHdhcm5BYm91dEFjY2Vzc2luZ1JlZiwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmU3RyaW5nUmVmQ2Fubm90QmVBdXRvQ29udmVydGVkKGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5yZWYgPT09ICJzdHJpbmciICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQgJiYgY29uZmlnLl9fc2VsZiAmJiBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnN0YXRlTm9kZSAhPT0gY29uZmlnLl9fc2VsZikgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSk7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcignQ29tcG9uZW50ICIlcyIgY29udGFpbnMgdGhlIHN0cmluZyByZWYgIiVzIi4gU3VwcG9ydCBmb3Igc3RyaW5nIHJlZnMgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFRoaXMgY2FzZSBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gYW4gYXJyb3cgZnVuY3Rpb24uIFdlIGFzayB5b3UgdG8gbWFudWFsbHkgZml4IHRoaXMgY2FzZSBieSB1c2luZyB1c2VSZWYoKSBvciBjcmVhdGVSZWYoKSBpbnN0ZWFkLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1zdHJpbmctcmVmJywgY29tcG9uZW50TmFtZSwgY29uZmlnLnJlZik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0RWxlbWVudCA9IGZ1bmN0aW9uKHR5cGUsIGtleSwgcmVmLCBzZWxmMiwgc291cmNlLCBvd25lciwgcHJvcHMpIHsKICAgICAgICAgIHZhciBlbGVtZW50ID0gewogICAgICAgICAgICAvLyBUaGlzIHRhZyBhbGxvd3MgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IEVsZW1lbnQKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0VMRU1FTlRfVFlQRSwKICAgICAgICAgICAgLy8gQnVpbHQtaW4gcHJvcGVydGllcyB0aGF0IGJlbG9uZyBvbiB0aGUgZWxlbWVudAogICAgICAgICAgICB0eXBlLAogICAgICAgICAgICBrZXksCiAgICAgICAgICAgIHJlZiwKICAgICAgICAgICAgcHJvcHMsCiAgICAgICAgICAgIC8vIFJlY29yZCB0aGUgY29tcG9uZW50IHJlc3BvbnNpYmxlIGZvciBjcmVhdGluZyB0aGlzIGVsZW1lbnQuCiAgICAgICAgICAgIF9vd25lcjogb3duZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIGVsZW1lbnQuX3N0b3JlID0ge307CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50Ll9zdG9yZSwgInZhbGlkYXRlZCIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgICAgIHZhbHVlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQsICJfc2VsZiIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc2VsZjIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NvdXJjZSIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc291cmNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50MzkodHlwZSwgY29uZmlnLCBjaGlsZHJlbikgewogICAgICAgICAgdmFyIHByb3BOYW1lOwogICAgICAgICAgdmFyIHByb3BzID0ge307CiAgICAgICAgICB2YXIga2V5ID0gbnVsbDsKICAgICAgICAgIHZhciByZWYgPSBudWxsOwogICAgICAgICAgdmFyIHNlbGYyID0gbnVsbDsKICAgICAgICAgIHZhciBzb3VyY2UgPSBudWxsOwogICAgICAgICAgaWYgKGNvbmZpZyAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkS2V5KGNvbmZpZykpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGNvbmZpZy5rZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIGNvbmZpZy5rZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZjIgPSBjb25maWcuX19zZWxmID09PSB2b2lkIDAgPyBudWxsIDogY29uZmlnLl9fc2VsZjsKICAgICAgICAgICAgc291cmNlID0gY29uZmlnLl9fc291cmNlID09PSB2b2lkIDAgPyBudWxsIDogY29uZmlnLl9fc291cmNlOwogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGNvbmZpZykgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgcHJvcE5hbWUpICYmICFSRVNFUlZFRF9QUk9QUy5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGNvbmZpZ1twcm9wTmFtZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGRyZW5MZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoIC0gMjsKICAgICAgICAgIGlmIChjaGlsZHJlbkxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICAgICAgfSBlbHNlIGlmIChjaGlsZHJlbkxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdmFyIGNoaWxkQXJyYXkgPSBBcnJheShjaGlsZHJlbkxlbmd0aCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW5MZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNoaWxkQXJyYXlbaV0gPSBhcmd1bWVudHNbaSArIDJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShjaGlsZEFycmF5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZEFycmF5OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgJiYgdHlwZS5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IHR5cGUuZGVmYXVsdFByb3BzOwogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGtleSB8fCByZWYpIHsKICAgICAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIiA/IHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8ICJVbmtub3duIiA6IHR5cGU7CiAgICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJlZikgewogICAgICAgICAgICAgICAgZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQodHlwZSwga2V5LCByZWYsIHNlbGYyLCBzb3VyY2UsIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xvbmVBbmRSZXBsYWNlS2V5KG9sZEVsZW1lbnQsIG5ld0tleSkgewogICAgICAgICAgdmFyIG5ld0VsZW1lbnQgPSBSZWFjdEVsZW1lbnQob2xkRWxlbWVudC50eXBlLCBuZXdLZXksIG9sZEVsZW1lbnQucmVmLCBvbGRFbGVtZW50Ll9zZWxmLCBvbGRFbGVtZW50Ll9zb3VyY2UsIG9sZEVsZW1lbnQuX293bmVyLCBvbGRFbGVtZW50LnByb3BzKTsKICAgICAgICAgIHJldHVybiBuZXdFbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbG9uZUVsZW1lbnQ4KGVsZW1lbnQsIGNvbmZpZywgY2hpbGRyZW4pIHsKICAgICAgICAgIGlmIChlbGVtZW50ID09PSBudWxsIHx8IGVsZW1lbnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlYWN0LmNsb25lRWxlbWVudCguLi4pOiBUaGUgYXJndW1lbnQgbXVzdCBiZSBhIFJlYWN0IGVsZW1lbnQsIGJ1dCB5b3UgcGFzc2VkICIgKyBlbGVtZW50ICsgIi4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wTmFtZTsKICAgICAgICAgIHZhciBwcm9wcyA9IGFzc2lnbjIoe30sIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgdmFyIHJlZiA9IGVsZW1lbnQucmVmOwogICAgICAgICAgdmFyIHNlbGYyID0gZWxlbWVudC5fc2VsZjsKICAgICAgICAgIHZhciBzb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgIGlmIChjb25maWcgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaGFzVmFsaWRSZWYoY29uZmlnKSkgewogICAgICAgICAgICAgIHJlZiA9IGNvbmZpZy5yZWY7CiAgICAgICAgICAgICAgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNWYWxpZEtleShjb25maWcpKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihjb25maWcua2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAga2V5ID0gIiIgKyBjb25maWcua2V5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGlmIChlbGVtZW50LnR5cGUgJiYgZWxlbWVudC50eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGRlZmF1bHRQcm9wcyA9IGVsZW1lbnQudHlwZS5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChwcm9wTmFtZSBpbiBjb25maWcpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsIHByb3BOYW1lKSAmJiAhUkVTRVJWRURfUFJPUFMuaGFzT3duUHJvcGVydHkocHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBpZiAoY29uZmlnW3Byb3BOYW1lXSA9PT0gdm9pZCAwICYmIGRlZmF1bHRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGRlZmF1bHRQcm9wc1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBjb25maWdbcHJvcE5hbWVdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkcmVuTGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCAtIDI7CiAgICAgICAgICBpZiAoY2hpbGRyZW5MZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgICAgICAgIH0gZWxzZSBpZiAoY2hpbGRyZW5MZW5ndGggPiAxKSB7CiAgICAgICAgICAgIHZhciBjaGlsZEFycmF5ID0gQXJyYXkoY2hpbGRyZW5MZW5ndGgpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuTGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjaGlsZEFycmF5W2ldID0gYXJndW1lbnRzW2kgKyAyXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkQXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gUmVhY3RFbGVtZW50KGVsZW1lbnQudHlwZSwga2V5LCByZWYsIHNlbGYyLCBzb3VyY2UsIG93bmVyLCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50MTUob2JqZWN0KSB7CiAgICAgICAgICByZXR1cm4gdHlwZW9mIG9iamVjdCA9PT0gIm9iamVjdCIgJiYgb2JqZWN0ICE9PSBudWxsICYmIG9iamVjdC4kJHR5cGVvZiA9PT0gUkVBQ1RfRUxFTUVOVF9UWVBFOwogICAgICAgIH0KICAgICAgICB2YXIgU0VQQVJBVE9SID0gIi4iOwogICAgICAgIHZhciBTVUJTRVBBUkFUT1IgPSAiOiI7CiAgICAgICAgZnVuY3Rpb24gZXNjYXBlKGtleSkgewogICAgICAgICAgdmFyIGVzY2FwZVJlZ2V4ID0gL1s9Ol0vZzsKICAgICAgICAgIHZhciBlc2NhcGVyTG9va3VwID0gewogICAgICAgICAgICAiPSI6ICI9MCIsCiAgICAgICAgICAgICI6IjogIj0yIgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBlc2NhcGVkU3RyaW5nID0ga2V5LnJlcGxhY2UoZXNjYXBlUmVnZXgsIGZ1bmN0aW9uKG1hdGNoKSB7CiAgICAgICAgICAgIHJldHVybiBlc2NhcGVyTG9va3VwW21hdGNoXTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuICIkIiArIGVzY2FwZWRTdHJpbmc7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNYXBzID0gZmFsc2U7CiAgICAgICAgdmFyIHVzZXJQcm92aWRlZEtleUVzY2FwZVJlZ2V4ID0gL1wvKy9nOwogICAgICAgIGZ1bmN0aW9uIGVzY2FwZVVzZXJQcm92aWRlZEtleSh0ZXh0KSB7CiAgICAgICAgICByZXR1cm4gdGV4dC5yZXBsYWNlKHVzZXJQcm92aWRlZEtleUVzY2FwZVJlZ2V4LCAiJCYvIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEVsZW1lbnRLZXkoZWxlbWVudCwgaW5kZXgpIHsKICAgICAgICAgIGlmICh0eXBlb2YgZWxlbWVudCA9PT0gIm9iamVjdCIgJiYgZWxlbWVudCAhPT0gbnVsbCAmJiBlbGVtZW50LmtleSAhPSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGVsZW1lbnQua2V5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXNjYXBlKCIiICsgZWxlbWVudC5rZXkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluZGV4LnRvU3RyaW5nKDM2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwSW50b0FycmF5KGNoaWxkcmVuLCBhcnJheSwgZXNjYXBlZFByZWZpeCwgbmFtZVNvRmFyLCBjYWxsYmFjaykgewogICAgICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgY2hpbGRyZW47CiAgICAgICAgICBpZiAodHlwZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZSA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgIGNoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnZva2VDYWxsYmFjayA9IGZhbHNlOwogICAgICAgICAgaWYgKGNoaWxkcmVuID09PSBudWxsKSB7CiAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGNoaWxkcmVuLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGludm9rZUNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBfY2hpbGQgPSBjaGlsZHJlbjsKICAgICAgICAgICAgdmFyIG1hcHBlZENoaWxkID0gY2FsbGJhY2soX2NoaWxkKTsKICAgICAgICAgICAgdmFyIGNoaWxkS2V5ID0gbmFtZVNvRmFyID09PSAiIiA/IFNFUEFSQVRPUiArIGdldEVsZW1lbnRLZXkoX2NoaWxkLCAwKSA6IG5hbWVTb0ZhcjsKICAgICAgICAgICAgaWYgKGlzQXJyYXkyKG1hcHBlZENoaWxkKSkgewogICAgICAgICAgICAgIHZhciBlc2NhcGVkQ2hpbGRLZXkgPSAiIjsKICAgICAgICAgICAgICBpZiAoY2hpbGRLZXkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXNjYXBlZENoaWxkS2V5ID0gZXNjYXBlVXNlclByb3ZpZGVkS2V5KGNoaWxkS2V5KSArICIvIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbWFwSW50b0FycmF5KG1hcHBlZENoaWxkLCBhcnJheSwgZXNjYXBlZENoaWxkS2V5LCAiIiwgZnVuY3Rpb24oYykgewogICAgICAgICAgICAgICAgcmV0dXJuIGM7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobWFwcGVkQ2hpbGQgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudDE1KG1hcHBlZENoaWxkKSkgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAobWFwcGVkQ2hpbGQua2V5ICYmICghX2NoaWxkIHx8IF9jaGlsZC5rZXkgIT09IG1hcHBlZENoaWxkLmtleSkpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKG1hcHBlZENoaWxkLmtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1hcHBlZENoaWxkID0gY2xvbmVBbmRSZXBsYWNlS2V5KAogICAgICAgICAgICAgICAgICBtYXBwZWRDaGlsZCwKICAgICAgICAgICAgICAgICAgLy8gS2VlcCBib3RoIHRoZSAobWFwcGVkKSBhbmQgb2xkIGtleXMgaWYgdGhleSBkaWZmZXIsIGp1c3QgYXMKICAgICAgICAgICAgICAgICAgLy8gdHJhdmVyc2VBbGxDaGlsZHJlbiB1c2VkIHRvIGRvIGZvciBvYmplY3RzIGFzIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAgIGVzY2FwZWRQcmVmaXggKyAvLyAkRmxvd0ZpeE1lIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIFJlYWN0LlBvcnRhbCBkb2Vzbid0IGhhdmUgYSBrZXkKICAgICAgICAgICAgICAgICAgKG1hcHBlZENoaWxkLmtleSAmJiAoIV9jaGlsZCB8fCBfY2hpbGQua2V5ICE9PSBtYXBwZWRDaGlsZC5rZXkpID8gKAogICAgICAgICAgICAgICAgICAgIC8vICRGbG93Rml4TWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgZXhpc3RpbmcgZWxlbWVudCdzIGtleSBjYW4gYmUgYSBudW1iZXIKICAgICAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaW50ZXJuYWwvc2FmZS1zdHJpbmctY29lcmNpb24KICAgICAgICAgICAgICAgICAgICBlc2NhcGVVc2VyUHJvdmlkZWRLZXkoIiIgKyBtYXBwZWRDaGlsZC5rZXkpICsgIi8iCiAgICAgICAgICAgICAgICAgICkgOiAiIikgKyBjaGlsZEtleQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXJyYXkucHVzaChtYXBwZWRDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGQ7CiAgICAgICAgICB2YXIgbmV4dE5hbWU7CiAgICAgICAgICB2YXIgc3VidHJlZUNvdW50ID0gMDsKICAgICAgICAgIHZhciBuZXh0TmFtZVByZWZpeCA9IG5hbWVTb0ZhciA9PT0gIiIgPyBTRVBBUkFUT1IgOiBuYW1lU29GYXIgKyBTVUJTRVBBUkFUT1I7CiAgICAgICAgICBpZiAoaXNBcnJheTIoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkcmVuW2ldOwogICAgICAgICAgICAgIG5leHROYW1lID0gbmV4dE5hbWVQcmVmaXggKyBnZXRFbGVtZW50S2V5KGNoaWxkLCBpKTsKICAgICAgICAgICAgICBzdWJ0cmVlQ291bnQgKz0gbWFwSW50b0FycmF5KGNoaWxkLCBhcnJheSwgZXNjYXBlZFByZWZpeCwgbmV4dE5hbWUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKGNoaWxkcmVuKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGl0ZXJhYmxlQ2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaXRlcmF0b3JGbiA9PT0gaXRlcmFibGVDaGlsZHJlbi5lbnRyaWVzKSB7CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TWFwcykgewogICAgICAgICAgICAgICAgICAgIHdhcm4zKCJVc2luZyBNYXBzIGFzIGNoaWxkcmVuIGlzIG5vdCBzdXBwb3J0ZWQuIFVzZSBhbiBhcnJheSBvZiBrZXllZCBSZWFjdEVsZW1lbnRzIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBpdGVyYXRvciA9IGl0ZXJhdG9yRm4uY2FsbChpdGVyYWJsZUNoaWxkcmVuKTsKICAgICAgICAgICAgICB2YXIgc3RlcDsKICAgICAgICAgICAgICB2YXIgaWkgPSAwOwogICAgICAgICAgICAgIHdoaWxlICghKHN0ZXAgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgICAgIGNoaWxkID0gc3RlcC52YWx1ZTsKICAgICAgICAgICAgICAgIG5leHROYW1lID0gbmV4dE5hbWVQcmVmaXggKyBnZXRFbGVtZW50S2V5KGNoaWxkLCBpaSsrKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVDb3VudCArPSBtYXBJbnRvQXJyYXkoY2hpbGQsIGFycmF5LCBlc2NhcGVkUHJlZml4LCBuZXh0TmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHZhciBjaGlsZHJlblN0cmluZyA9IFN0cmluZyhjaGlsZHJlbik7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPYmplY3RzIGFyZSBub3QgdmFsaWQgYXMgYSBSZWFjdCBjaGlsZCAoZm91bmQ6ICIgKyAoY2hpbGRyZW5TdHJpbmcgPT09ICJbb2JqZWN0IE9iamVjdF0iID8gIm9iamVjdCB3aXRoIGtleXMgeyIgKyBPYmplY3Qua2V5cyhjaGlsZHJlbikuam9pbigiLCAiKSArICJ9IiA6IGNoaWxkcmVuU3RyaW5nKSArICIpLiBJZiB5b3UgbWVhbnQgdG8gcmVuZGVyIGEgY29sbGVjdGlvbiBvZiBjaGlsZHJlbiwgdXNlIGFuIGFycmF5IGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzdWJ0cmVlQ291bnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcENoaWxkcmVuKGNoaWxkcmVuLCBmdW5jLCBjb250ZXh0KSB7CiAgICAgICAgICBpZiAoY2hpbGRyZW4gPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICB2YXIgY291bnQgPSAwOwogICAgICAgICAgbWFwSW50b0FycmF5KGNoaWxkcmVuLCByZXN1bHQsICIiLCAiIiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbChjb250ZXh0LCBjaGlsZCwgY291bnQrKyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvdW50Q2hpbGRyZW4oY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciBuID0gMDsKICAgICAgICAgIG1hcENoaWxkcmVuKGNoaWxkcmVuLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgbisrOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yRWFjaENoaWxkcmVuKGNoaWxkcmVuLCBmb3JFYWNoRnVuYywgZm9yRWFjaENvbnRleHQpIHsKICAgICAgICAgIG1hcENoaWxkcmVuKGNoaWxkcmVuLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZm9yRWFjaEZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGZvckVhY2hDb250ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG9BcnJheTIoY2hpbGRyZW4pIHsKICAgICAgICAgIHJldHVybiBtYXBDaGlsZHJlbihjaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgfSkgfHwgW107CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9ubHlDaGlsZChjaGlsZHJlbikgewogICAgICAgICAgaWYgKCFpc1ZhbGlkRWxlbWVudDE1KGNoaWxkcmVuKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlYWN0LkNoaWxkcmVuLm9ubHkgZXhwZWN0ZWQgdG8gcmVjZWl2ZSBhIHNpbmdsZSBSZWFjdCBlbGVtZW50IGNoaWxkLiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNoaWxkcmVuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVDb250ZXh0MTIoZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0NPTlRFWFRfVFlQRSwKICAgICAgICAgICAgLy8gQXMgYSB3b3JrYXJvdW5kIHRvIHN1cHBvcnQgbXVsdGlwbGUgY29uY3VycmVudCByZW5kZXJlcnMsIHdlIGNhdGVnb3JpemUKICAgICAgICAgICAgLy8gc29tZSByZW5kZXJlcnMgYXMgcHJpbWFyeSBhbmQgb3RoZXJzIGFzIHNlY29uZGFyeS4gV2Ugb25seSBleHBlY3QKICAgICAgICAgICAgLy8gdGhlcmUgdG8gYmUgdHdvIGNvbmN1cnJlbnQgcmVuZGVyZXJzIGF0IG1vc3Q6IFJlYWN0IE5hdGl2ZSAocHJpbWFyeSkgYW5kCiAgICAgICAgICAgIC8vIEZhYnJpYyAoc2Vjb25kYXJ5KTsgUmVhY3QgRE9NIChwcmltYXJ5KSBhbmQgUmVhY3QgQVJUIChzZWNvbmRhcnkpLgogICAgICAgICAgICAvLyBTZWNvbmRhcnkgcmVuZGVyZXJzIHN0b3JlIHRoZWlyIGNvbnRleHQgdmFsdWVzIG9uIHNlcGFyYXRlIGZpZWxkcy4KICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTogZGVmYXVsdFZhbHVlLAogICAgICAgICAgICBfY3VycmVudFZhbHVlMjogZGVmYXVsdFZhbHVlLAogICAgICAgICAgICAvLyBVc2VkIHRvIHRyYWNrIGhvdyBtYW55IGNvbmN1cnJlbnQgcmVuZGVyZXJzIHRoaXMgY29udGV4dCBjdXJyZW50bHkKICAgICAgICAgICAgLy8gc3VwcG9ydHMgd2l0aGluIGluIGEgc2luZ2xlIHJlbmRlcmVyLiBTdWNoIGFzIHBhcmFsbGVsIHNlcnZlciByZW5kZXJpbmcuCiAgICAgICAgICAgIF90aHJlYWRDb3VudDogMCwKICAgICAgICAgICAgLy8gVGhlc2UgYXJlIGNpcmN1bGFyCiAgICAgICAgICAgIFByb3ZpZGVyOiBudWxsLAogICAgICAgICAgICBDb25zdW1lcjogbnVsbCwKICAgICAgICAgICAgLy8gQWRkIHRoZXNlIHRvIHVzZSBzYW1lIGhpZGRlbiBjbGFzcyBpbiBWTSBhcyBTZXJ2ZXJDb250ZXh0CiAgICAgICAgICAgIF9kZWZhdWx0VmFsdWU6IG51bGwsCiAgICAgICAgICAgIF9nbG9iYWxOYW1lOiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgY29udGV4dC5Qcm92aWRlciA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX1BST1ZJREVSX1RZUEUsCiAgICAgICAgICAgIF9jb250ZXh0OiBjb250ZXh0CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdOZXN0ZWRDb250ZXh0Q29uc3VtZXJzID0gZmFsc2U7CiAgICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnN1bWVyUHJvdmlkZXIgPSBmYWxzZTsKICAgICAgICAgIHZhciBoYXNXYXJuZWRBYm91dERpc3BsYXlOYW1lT25Db25zdW1lciA9IGZhbHNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgQ29uc3VtZXIgPSB7CiAgICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0NPTlRFWFRfVFlQRSwKICAgICAgICAgICAgICBfY29udGV4dDogY29udGV4dAogICAgICAgICAgICB9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhDb25zdW1lciwgewogICAgICAgICAgICAgIFByb3ZpZGVyOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnN1bWVyUHJvdmlkZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZW5kZXJpbmcgPENvbnRleHQuQ29uc3VtZXIuUHJvdmlkZXI+IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gcmVuZGVyIDxDb250ZXh0LlByb3ZpZGVyPiBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0LlByb3ZpZGVyOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX1Byb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuUHJvdmlkZXIgPSBfUHJvdmlkZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBfY3VycmVudFZhbHVlOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5fY3VycmVudFZhbHVlOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX2N1cnJlbnRWYWx1ZSkgewogICAgICAgICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50VmFsdWUgPSBfY3VycmVudFZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTI6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0Ll9jdXJyZW50VmFsdWUyOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX2N1cnJlbnRWYWx1ZTIpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlMiA9IF9jdXJyZW50VmFsdWUyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX3RocmVhZENvdW50OiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5fdGhyZWFkQ291bnQ7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihfdGhyZWFkQ291bnQpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5fdGhyZWFkQ291bnQgPSBfdGhyZWFkQ291bnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBDb25zdW1lcjogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycykgewogICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdOZXN0ZWRDb250ZXh0Q29uc3VtZXJzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyaW5nIDxDb250ZXh0LkNvbnN1bWVyLkNvbnN1bWVyPiBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIHJlbmRlciA8Q29udGV4dC5Db25zdW1lcj4gaW5zdGVhZD8iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5Db25zdW1lcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGRpc3BsYXlOYW1lOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5kaXNwbGF5TmFtZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXREaXNwbGF5TmFtZU9uQ29uc3VtZXIpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuMygiU2V0dGluZyBgZGlzcGxheU5hbWVgIG9uIENvbnRleHQuQ29uc3VtZXIgaGFzIG5vIGVmZmVjdC4gWW91IHNob3VsZCBzZXQgaXQgZGlyZWN0bHkgb24gdGhlIGNvbnRleHQgd2l0aCBDb250ZXh0LmRpc3BsYXlOYW1lID0gJyVzJy4iLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXREaXNwbGF5TmFtZU9uQ29uc3VtZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29udGV4dC5Db25zdW1lciA9IENvbnN1bWVyOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgPSBudWxsOwogICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIyID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgIH0KICAgICAgICB2YXIgVW5pbml0aWFsaXplZCA9IC0xOwogICAgICAgIHZhciBQZW5kaW5nID0gMDsKICAgICAgICB2YXIgUmVzb2x2ZWQgPSAxOwogICAgICAgIHZhciBSZWplY3RlZCA9IDI7CiAgICAgICAgZnVuY3Rpb24gbGF6eUluaXRpYWxpemVyKHBheWxvYWQpIHsKICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFVuaW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgdmFyIGN0b3IgPSBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICAgIHZhciB0aGVuYWJsZSA9IGN0b3IoKTsKICAgICAgICAgICAgdGhlbmFibGUudGhlbihmdW5jdGlvbihtb2R1bGVPYmplY3QyKSB7CiAgICAgICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gUGVuZGluZyB8fCBwYXlsb2FkLl9zdGF0dXMgPT09IFVuaW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgICAgIHZhciByZXNvbHZlZCA9IHBheWxvYWQ7CiAgICAgICAgICAgICAgICByZXNvbHZlZC5fc3RhdHVzID0gUmVzb2x2ZWQ7CiAgICAgICAgICAgICAgICByZXNvbHZlZC5fcmVzdWx0ID0gbW9kdWxlT2JqZWN0MjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFBlbmRpbmcgfHwgcGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVqZWN0ZWQgPSBwYXlsb2FkOwogICAgICAgICAgICAgICAgcmVqZWN0ZWQuX3N0YXR1cyA9IFJlamVjdGVkOwogICAgICAgICAgICAgICAgcmVqZWN0ZWQuX3Jlc3VsdCA9IGVycm9yMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBwYXlsb2FkOwogICAgICAgICAgICAgIHBlbmRpbmcuX3N0YXR1cyA9IFBlbmRpbmc7CiAgICAgICAgICAgICAgcGVuZGluZy5fcmVzdWx0ID0gdGhlbmFibGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFJlc29sdmVkKSB7CiAgICAgICAgICAgIHZhciBtb2R1bGVPYmplY3QgPSBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAobW9kdWxlT2JqZWN0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGVycm9yKCJsYXp5OiBFeHBlY3RlZCB0aGUgcmVzdWx0IG9mIGEgZHluYW1pYyBpbXBvcnQoKSBjYWxsLiBJbnN0ZWFkIHJlY2VpdmVkOiAlc1xuXG5Zb3VyIGNvZGUgc2hvdWxkIGxvb2sgbGlrZTogXG4gIGNvbnN0IE15Q29tcG9uZW50ID0gbGF6eSgoKSA9PiBpbXBvcnQoJy4vTXlDb21wb25lbnQnKSlcblxuRGlkIHlvdSBhY2NpZGVudGFsbHkgcHV0IGN1cmx5IGJyYWNlcyBhcm91bmQgdGhlIGltcG9ydD8iLCBtb2R1bGVPYmplY3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCEoImRlZmF1bHQiIGluIG1vZHVsZU9iamVjdCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJsYXp5OiBFeHBlY3RlZCB0aGUgcmVzdWx0IG9mIGEgZHluYW1pYyBpbXBvcnQoKSBjYWxsLiBJbnN0ZWFkIHJlY2VpdmVkOiAlc1xuXG5Zb3VyIGNvZGUgc2hvdWxkIGxvb2sgbGlrZTogXG4gIGNvbnN0IE15Q29tcG9uZW50ID0gbGF6eSgoKSA9PiBpbXBvcnQoJy4vTXlDb21wb25lbnQnKSkiLCBtb2R1bGVPYmplY3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbW9kdWxlT2JqZWN0LmRlZmF1bHQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhenkoY3RvcikgewogICAgICAgICAgdmFyIHBheWxvYWQgPSB7CiAgICAgICAgICAgIC8vIFdlIHVzZSB0aGVzZSBmaWVsZHMgdG8gc3RvcmUgdGhlIHJlc3VsdC4KICAgICAgICAgICAgX3N0YXR1czogVW5pbml0aWFsaXplZCwKICAgICAgICAgICAgX3Jlc3VsdDogY3RvcgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBsYXp5VHlwZSA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0xBWllfVFlQRSwKICAgICAgICAgICAgX3BheWxvYWQ6IHBheWxvYWQsCiAgICAgICAgICAgIF9pbml0OiBsYXp5SW5pdGlhbGl6ZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIHZhciBwcm9wVHlwZXM7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGxhenlUeXBlLCB7CiAgICAgICAgICAgICAgZGVmYXVsdFByb3BzOiB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdFByb3BzOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmV3RGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5sYXp5KC4uLik6IEl0IGlzIG5vdCBzdXBwb3J0ZWQgdG8gYXNzaWduIGBkZWZhdWx0UHJvcHNgIHRvIGEgbGF6eSBjb21wb25lbnQgaW1wb3J0LiBFaXRoZXIgc3BlY2lmeSB0aGVtIHdoZXJlIHRoZSBjb21wb25lbnQgaXMgZGVmaW5lZCwgb3IgY3JlYXRlIGEgd3JhcHBpbmcgY29tcG9uZW50IGFyb3VuZCBpdC4iKTsKICAgICAgICAgICAgICAgICAgZGVmYXVsdFByb3BzID0gbmV3RGVmYXVsdFByb3BzOwogICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobGF6eVR5cGUsICJkZWZhdWx0UHJvcHMiLCB7CiAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHByb3BUeXBlczogewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb3BUeXBlczsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5ld1Byb3BUeXBlcykgewogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QubGF6eSguLi4pOiBJdCBpcyBub3Qgc3VwcG9ydGVkIHRvIGFzc2lnbiBgcHJvcFR5cGVzYCB0byBhIGxhenkgY29tcG9uZW50IGltcG9ydC4gRWl0aGVyIHNwZWNpZnkgdGhlbSB3aGVyZSB0aGUgY29tcG9uZW50IGlzIGRlZmluZWQsIG9yIGNyZWF0ZSBhIHdyYXBwaW5nIGNvbXBvbmVudCBhcm91bmQgaXQuIik7CiAgICAgICAgICAgICAgICAgIHByb3BUeXBlcyA9IG5ld1Byb3BUeXBlczsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGxhenlUeXBlLCAicHJvcFR5cGVzIiwgewogICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYXp5VHlwZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yd2FyZFJlZjE1KHJlbmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVuZGVyICE9IG51bGwgJiYgcmVuZGVyLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyKSB7CiAgICAgICAgICAgICAgZXJyb3IoImZvcndhcmRSZWYgcmVxdWlyZXMgYSByZW5kZXIgZnVuY3Rpb24gYnV0IHJlY2VpdmVkIGEgYG1lbW9gIGNvbXBvbmVudC4gSW5zdGVhZCBvZiBmb3J3YXJkUmVmKG1lbW8oLi4uKSksIHVzZSBtZW1vKGZvcndhcmRSZWYoLi4uKSkuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlbmRlciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlcXVpcmVzIGEgcmVuZGVyIGZ1bmN0aW9uIGJ1dCB3YXMgZ2l2ZW4gJXMuIiwgcmVuZGVyID09PSBudWxsID8gIm51bGwiIDogdHlwZW9mIHJlbmRlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHJlbmRlci5sZW5ndGggIT09IDAgJiYgcmVuZGVyLmxlbmd0aCAhPT0gMikgewogICAgICAgICAgICAgICAgZXJyb3IoImZvcndhcmRSZWYgcmVuZGVyIGZ1bmN0aW9ucyBhY2NlcHQgZXhhY3RseSB0d28gcGFyYW1ldGVyczogcHJvcHMgYW5kIHJlZi4gJXMiLCByZW5kZXIubGVuZ3RoID09PSAxID8gIkRpZCB5b3UgZm9yZ2V0IHRvIHVzZSB0aGUgcmVmIHBhcmFtZXRlcj8iIDogIkFueSBhZGRpdGlvbmFsIHBhcmFtZXRlciB3aWxsIGJlIHVuZGVmaW5lZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlbmRlciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHJlbmRlci5kZWZhdWx0UHJvcHMgIT0gbnVsbCB8fCByZW5kZXIucHJvcFR5cGVzICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlbmRlciBmdW5jdGlvbnMgZG8gbm90IHN1cHBvcnQgcHJvcFR5cGVzIG9yIGRlZmF1bHRQcm9wcy4gRGlkIHlvdSBhY2NpZGVudGFsbHkgcGFzcyBhIFJlYWN0IGNvbXBvbmVudD8iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyLAogICAgICAgICAgICByZW5kZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25OYW1lOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudFR5cGUsICJkaXNwbGF5TmFtZSIsIHsKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvd25OYW1lOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICBvd25OYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIGlmICghcmVuZGVyLm5hbWUgJiYgIXJlbmRlci5kaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICByZW5kZXIuZGlzcGxheU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudFR5cGU7CiAgICAgICAgfQogICAgICAgIHZhciBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFOwogICAgICAgIHsKICAgICAgICAgIFJFQUNUX01PRFVMRV9SRUZFUkVOQ0UgPSBTeW1ib2wuZm9yKCJyZWFjdC5tb2R1bGUucmVmZXJlbmNlIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciIHx8IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfUFJPRklMRVJfVFlQRSB8fCBlbmFibGVEZWJ1Z1RyYWNpbmcgfHwgdHlwZSA9PT0gUkVBQ1RfU1RSSUNUX01PREVfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSB8fCBlbmFibGVMZWdhY3lIaWRkZW4gfHwgdHlwZSA9PT0gUkVBQ1RfT0ZGU0NSRUVOX1RZUEUgfHwgZW5hYmxlU2NvcGVBUEkgfHwgZW5hYmxlQ2FjaGVFbGVtZW50IHx8IGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFMiB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9QUk9WSURFUl9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0NPTlRFWFRfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiB8fCAvLyBUaGlzIG5lZWRzIHRvIGluY2x1ZGUgYWxsIHBvc3NpYmxlIG1vZHVsZSByZWZlcmVuY2Ugb2JqZWN0CiAgICAgICAgICAgIC8vIHR5cGVzIHN1cHBvcnRlZCBieSBhbnkgRmxpZ2h0IGNvbmZpZ3VyYXRpb24gYW55d2hlcmUgc2luY2UKICAgICAgICAgICAgLy8gd2UgZG9uJ3Qga25vdyB3aGljaCBGbGlnaHQgYnVpbGQgdGhpcyB3aWxsIGVuZCB1cCBiZWluZyB1c2VkCiAgICAgICAgICAgIC8vIHdpdGguCiAgICAgICAgICAgIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01PRFVMRV9SRUZFUkVOQ0UgfHwgdHlwZS5nZXRNb2R1bGVJZCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWVtbzcodHlwZSwgY29tcGFyZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKSkgewogICAgICAgICAgICAgIGVycm9yKCJtZW1vOiBUaGUgZmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIGNvbXBvbmVudC4gSW5zdGVhZCByZWNlaXZlZDogJXMiLCB0eXBlID09PSBudWxsID8gIm51bGwiIDogdHlwZW9mIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9NRU1PX1RZUEUyLAogICAgICAgICAgICB0eXBlLAogICAgICAgICAgICBjb21wYXJlOiBjb21wYXJlID09PSB2b2lkIDAgPyBudWxsIDogY29tcGFyZQogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG93bk5hbWU7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50VHlwZSwgImRpc3BsYXlOYW1lIiwgewogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG93bk5hbWU7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgICAgIG93bk5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgaWYgKCF0eXBlLm5hbWUgJiYgIXR5cGUuZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgICAgICAgdHlwZS5kaXNwbGF5TmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50VHlwZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZURpc3BhdGNoZXIoKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpc3BhdGNoZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBob29rIGNhbGwuIEhvb2tzIGNhbiBvbmx5IGJlIGNhbGxlZCBpbnNpZGUgb2YgdGhlIGJvZHkgb2YgYSBmdW5jdGlvbiBjb21wb25lbnQuIFRoaXMgY291bGQgaGFwcGVuIGZvciBvbmUgb2YgdGhlIGZvbGxvd2luZyByZWFzb25zOlxuMS4gWW91IG1pZ2h0IGhhdmUgbWlzbWF0Y2hpbmcgdmVyc2lvbnMgb2YgUmVhY3QgYW5kIHRoZSByZW5kZXJlciAoc3VjaCBhcyBSZWFjdCBET00pXG4yLiBZb3UgbWlnaHQgYmUgYnJlYWtpbmcgdGhlIFJ1bGVzIG9mIEhvb2tzXG4zLiBZb3UgbWlnaHQgaGF2ZSBtb3JlIHRoYW4gb25lIGNvcHkgb2YgUmVhY3QgaW4gdGhlIHNhbWUgYXBwXG5TZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2ludmFsaWQtaG9vay1jYWxsIGZvciB0aXBzIGFib3V0IGhvdyB0byBkZWJ1ZyBhbmQgZml4IHRoaXMgcHJvYmxlbS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUNvbnRleHQxMihDb250ZXh0KSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb250ZXh0Ll9jb250ZXh0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgcmVhbENvbnRleHQgPSBDb250ZXh0Ll9jb250ZXh0OwogICAgICAgICAgICAgIGlmIChyZWFsQ29udGV4dC5Db25zdW1lciA9PT0gQ29udGV4dCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkNhbGxpbmcgdXNlQ29udGV4dChDb250ZXh0LkNvbnN1bWVyKSBpcyBub3Qgc3VwcG9ydGVkLCBtYXkgY2F1c2UgYnVncywgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gY2FsbCB1c2VDb250ZXh0KENvbnRleHQpIGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZWFsQ29udGV4dC5Qcm92aWRlciA9PT0gQ29udGV4dCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkNhbGxpbmcgdXNlQ29udGV4dChDb250ZXh0LlByb3ZpZGVyKSBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCB1c2VDb250ZXh0KENvbnRleHQpIGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VDb250ZXh0KENvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VTdGF0ZTEzKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlUmVmMTYoaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlRWZmZWN0MTQoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUxheW91dEVmZmVjdDkoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlQ2FsbGJhY2s4KGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZU1lbW85KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VJbXBlcmF0aXZlSGFuZGxlMyhyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZURlYnVnVmFsdWUyKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZURlYnVnVmFsdWUodmFsdWUsIGZvcm1hdHRlckZuKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlVHJhbnNpdGlvbigpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVRyYW5zaXRpb24oKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlRGVmZXJyZWRWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUlkMigpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUlkKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVN5bmNFeHRlcm5hbFN0b3JlMihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlzYWJsZWREZXB0aCA9IDA7CiAgICAgICAgdmFyIHByZXZMb2c7CiAgICAgICAgdmFyIHByZXZJbmZvOwogICAgICAgIHZhciBwcmV2V2FybjsKICAgICAgICB2YXIgcHJldkVycm9yOwogICAgICAgIHZhciBwcmV2R3JvdXA7CiAgICAgICAgdmFyIHByZXZHcm91cENvbGxhcHNlZDsKICAgICAgICB2YXIgcHJldkdyb3VwRW5kOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVkTG9nKCkgewogICAgICAgIH0KICAgICAgICBkaXNhYmxlZExvZy5fX3JlYWN0RGlzYWJsZWRMb2cgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHByZXZMb2cgPSBjb25zb2xlLmxvZzsKICAgICAgICAgICAgICBwcmV2SW5mbyA9IGNvbnNvbGUuaW5mbzsKICAgICAgICAgICAgICBwcmV2V2FybiA9IGNvbnNvbGUud2FybjsKICAgICAgICAgICAgICBwcmV2RXJyb3IgPSBjb25zb2xlLmVycm9yOwogICAgICAgICAgICAgIHByZXZHcm91cCA9IGNvbnNvbGUuZ3JvdXA7CiAgICAgICAgICAgICAgcHJldkdyb3VwQ29sbGFwc2VkID0gY29uc29sZS5ncm91cENvbGxhcHNlZDsKICAgICAgICAgICAgICBwcmV2R3JvdXBFbmQgPSBjb25zb2xlLmdyb3VwRW5kOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZGlzYWJsZWRMb2csCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgaW5mbzogcHJvcHMsCiAgICAgICAgICAgICAgICBsb2c6IHByb3BzLAogICAgICAgICAgICAgICAgd2FybjogcHJvcHMsCiAgICAgICAgICAgICAgICBlcnJvcjogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cEVuZDogcHJvcHMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaXNhYmxlZERlcHRoKys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZW5hYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlzYWJsZWREZXB0aC0tOwogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgbG9nOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkxvZwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBpbmZvOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkluZm8KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgd2FybjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZXYXJuCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGVycm9yOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkVycm9yCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwQ29sbGFwc2VkCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwRW5kCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoIDwgMCkgewogICAgICAgICAgICAgIGVycm9yKCJkaXNhYmxlZERlcHRoIGZlbGwgYmVsb3cgemVyby4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgdmFyIHByZWZpeDsKICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByZWZpeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IHgyLnN0YWNrLnRyaW0oKS5tYXRjaCgvXG4oICooYXQgKT8pLyk7CiAgICAgICAgICAgICAgICBwcmVmaXggPSBtYXRjaCAmJiBtYXRjaFsxXSB8fCAiIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICJcbiIgKyBwcmVmaXggKyBuYW1lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgIHZhciBjb21wb25lbnRGcmFtZUNhY2hlOwogICAgICAgIHsKICAgICAgICAgIHZhciBQb3NzaWJseVdlYWtNYXAgPSB0eXBlb2YgV2Vha01hcCA9PT0gImZ1bmN0aW9uIiA/IFdlYWtNYXAgOiBNYXA7CiAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlID0gbmV3IFBvc3NpYmx5V2Vha01hcCgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBjb25zdHJ1Y3QpIHsKICAgICAgICAgIGlmICghZm4gfHwgcmVlbnRyeSkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmcmFtZSA9IGNvbXBvbmVudEZyYW1lQ2FjaGUuZ2V0KGZuKTsKICAgICAgICAgICAgaWYgKGZyYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gZnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb250cm9sOwogICAgICAgICAgcmVlbnRyeSA9IHRydWU7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZSA9IEVycm9yLnByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSB2b2lkIDA7CiAgICAgICAgICB2YXIgcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgewogICAgICAgICAgICBwcmV2aW91c0Rpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICBkaXNhYmxlTG9ncygpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGNvbnN0cnVjdCkgewogICAgICAgICAgICAgIHZhciBGYWtlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEZha2UucHJvdG90eXBlLCAicHJvcHMiLCB7CiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gIm9iamVjdCIgJiYgUmVmbGVjdC5jb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KEZha2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KGZuLCBbXSwgRmFrZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIEZha2UuY2FsbCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm4uY2FsbChGYWtlLnByb3RvdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKHNhbXBsZSkgewogICAgICAgICAgICBpZiAoc2FtcGxlICYmIGNvbnRyb2wgJiYgdHlwZW9mIHNhbXBsZS5zdGFjayA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICB2YXIgc2FtcGxlTGluZXMgPSBzYW1wbGUuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIGNvbnRyb2xMaW5lcyA9IGNvbnRyb2wuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIHMgPSBzYW1wbGVMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHZhciBjID0gY29udHJvbExpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgd2hpbGUgKHMgPj0gMSAmJiBjID49IDAgJiYgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKDsgcyA+PSAxICYmIGMgPj0gMDsgcy0tLCBjLS0pIHsKICAgICAgICAgICAgICAgIGlmIChzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzICE9PSAxIHx8IGMgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICBzLS07CiAgICAgICAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYyA8IDAgfHwgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2ZyYW1lID0gIlxuIiArIHNhbXBsZUxpbmVzW3NdLnJlcGxhY2UoIiBhdCBuZXcgIiwgIiBhdCAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuLmRpc3BsYXlOYW1lICYmIF9mcmFtZS5pbmNsdWRlcygiPGFub255bW91cz4iKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIF9mcmFtZSA9IF9mcmFtZS5yZXBsYWNlKCI8YW5vbnltb3VzPiIsIGZuLmRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIF9mcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgICAgICByZWVuYWJsZUxvZ3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmFtZSA9IGZuID8gZm4uZGlzcGxheU5hbWUgfHwgZm4ubmFtZSA6ICIiOwogICAgICAgICAgdmFyIHN5bnRoZXRpY0ZyYW1lID0gbmFtZSA/IGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUpIDogIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgc3ludGhldGljRnJhbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3ludGhldGljRnJhbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZShmbiwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENvbnN0cnVjdChDb21wb25lbnQyKSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50Mi5wcm90b3R5cGU7CiAgICAgICAgICByZXR1cm4gISEocHJvdG90eXBlICYmIHByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKHR5cGUsIHNob3VsZENvbnN0cnVjdCh0eXBlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKHR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXMzID0gRnVuY3Rpb24uY2FsbC5iaW5kKGhhc093blByb3BlcnR5KTsKICAgICAgICAgICAgZm9yICh2YXIgdHlwZVNwZWNOYW1lIGluIHR5cGVTcGVjcykgewogICAgICAgICAgICAgIGlmIChoYXMzKHR5cGVTcGVjcywgdHlwZVNwZWNOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IEVycm9yKChjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIpICsgIjogIiArIGxvY2F0aW9uICsgIiB0eXBlIGAiICsgdHlwZVNwZWNOYW1lICsgImAgaXMgaW52YWxpZDsgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uLCB1c3VhbGx5IGZyb20gdGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLCBidXQgcmVjZWl2ZWQgYCIgKyB0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gKyAiYC5UaGlzIG9mdGVuIGhhcHBlbnMgYmVjYXVzZSBvZiB0eXBvcyBzdWNoIGFzIGBQcm9wVHlwZXMuZnVuY3Rpb25gIGluc3RlYWQgb2YgYFByb3BUeXBlcy5mdW5jYC4iKTsKICAgICAgICAgICAgICAgICAgICBlcnIubmFtZSA9ICJJbnZhcmlhbnQgVmlvbGF0aW9uIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdKHZhbHVlcywgdHlwZVNwZWNOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgbnVsbCwgIlNFQ1JFVF9ET19OT1RfUEFTU19USElTX09SX1lPVV9XSUxMX0JFX0ZJUkVEIik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICBlcnJvciQxID0gZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSAmJiAhKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvcikpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogdHlwZSBzcGVjaWZpY2F0aW9uIG9mICVzIGAlc2AgaXMgaW52YWxpZDsgdGhlIHR5cGUgY2hlY2tlciBmdW5jdGlvbiBtdXN0IHJldHVybiBgbnVsbGAgb3IgYW4gYEVycm9yYCBidXQgcmV0dXJuZWQgYSAlcy4gWW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBwYXNzIGFuIGFyZ3VtZW50IHRvIHRoZSB0eXBlIGNoZWNrZXIgY3JlYXRvciAoYXJyYXlPZiwgaW5zdGFuY2VPZiwgb2JqZWN0T2YsIG9uZU9mLCBvbmVPZlR5cGUsIGFuZCBzaGFwZSBhbGwgcmVxdWlyZSBhbiBhcmd1bWVudCkuIiwgY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiLCBsb2NhdGlvbiwgdHlwZVNwZWNOYW1lLCB0eXBlb2YgZXJyb3IkMSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvciAmJiAhKGVycm9yJDEubWVzc2FnZSBpbiBsb2dnZWRUeXBlRmFpbHVyZXMpKSB7CiAgICAgICAgICAgICAgICAgIGxvZ2dlZFR5cGVGYWlsdXJlc1tlcnJvciQxLm1lc3NhZ2VdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJGYWlsZWQgJXMgdHlwZTogJXMiLCBsb2NhdGlvbiwgZXJyb3IkMS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duOwogICAgICAgIHsKICAgICAgICAgIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpIHsKICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSk7CiAgICAgICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBuYW1lICsgImAuIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpIHsKICAgICAgICAgIGlmIChzb3VyY2UgIT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgZmlsZU5hbWUgPSBzb3VyY2UuZmlsZU5hbWUucmVwbGFjZSgvXi4qW1xcXC9dLywgIiIpOwogICAgICAgICAgICB2YXIgbGluZU51bWJlciA9IHNvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICByZXR1cm4gIlxuXG5DaGVjayB5b3VyIGNvZGUgYXQgIiArIGZpbGVOYW1lICsgIjoiICsgbGluZU51bWJlciArICIuIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW1Gb3JQcm9wcyhlbGVtZW50UHJvcHMpIHsKICAgICAgICAgIGlmIChlbGVtZW50UHJvcHMgIT09IG51bGwgJiYgZWxlbWVudFByb3BzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtKGVsZW1lbnRQcm9wcy5fX3NvdXJjZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBvd25lckhhc0tleVVzZVdhcm5pbmcgPSB7fTsKICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpIHsKICAgICAgICAgIHZhciBpbmZvID0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICBpZiAoIWluZm8pIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5hbWUgPSB0eXBlb2YgcGFyZW50VHlwZSA9PT0gInN0cmluZyIgPyBwYXJlbnRUeXBlIDogcGFyZW50VHlwZS5kaXNwbGF5TmFtZSB8fCBwYXJlbnRUeXBlLm5hbWU7CiAgICAgICAgICAgIGlmIChwYXJlbnROYW1lKSB7CiAgICAgICAgICAgICAgaW5mbyA9ICJcblxuQ2hlY2sgdGhlIHRvcC1sZXZlbCByZW5kZXIgY2FsbCB1c2luZyA8IiArIHBhcmVudE5hbWUgKyAiPi4iOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVFeHBsaWNpdEtleShlbGVtZW50LCBwYXJlbnRUeXBlKSB7CiAgICAgICAgICBpZiAoIWVsZW1lbnQuX3N0b3JlIHx8IGVsZW1lbnQuX3N0b3JlLnZhbGlkYXRlZCB8fCBlbGVtZW50LmtleSAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGVsZW1lbnQuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICB2YXIgY3VycmVudENvbXBvbmVudEVycm9ySW5mbyA9IGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSk7CiAgICAgICAgICBpZiAob3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSA9IHRydWU7CiAgICAgICAgICB2YXIgY2hpbGRPd25lciA9ICIiOwogICAgICAgICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fb3duZXIgIT09IFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQpIHsKICAgICAgICAgICAgY2hpbGRPd25lciA9ICIgSXQgd2FzIHBhc3NlZCBhIGNoaWxkIGZyb20gIiArIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShlbGVtZW50Ll9vd25lci50eXBlKSArICIuIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShlbGVtZW50KTsKICAgICAgICAgICAgZXJyb3IoJ0VhY2ggY2hpbGQgaW4gYSBsaXN0IHNob3VsZCBoYXZlIGEgdW5pcXVlICJrZXkiIHByb3AuJXMlcyBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dhcm5pbmcta2V5cyBmb3IgbW9yZSBpbmZvcm1hdGlvbi4nLCBjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvLCBjaGlsZE93bmVyKTsKICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVDaGlsZEtleXMobm9kZSwgcGFyZW50VHlwZSkgewogICAgICAgICAgaWYgKHR5cGVvZiBub2RlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNBcnJheTIobm9kZSkpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2RlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZVtpXTsKICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQxNShjaGlsZCkpIHsKICAgICAgICAgICAgICAgIHZhbGlkYXRlRXhwbGljaXRLZXkoY2hpbGQsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc1ZhbGlkRWxlbWVudDE1KG5vZGUpKSB7CiAgICAgICAgICAgIGlmIChub2RlLl9zdG9yZSkgewogICAgICAgICAgICAgIG5vZGUuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAobm9kZSkgewogICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4obm9kZSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmIChpdGVyYXRvckZuICE9PSBub2RlLmVudHJpZXMpIHsKICAgICAgICAgICAgICAgIHZhciBpdGVyYXRvciA9IGl0ZXJhdG9yRm4uY2FsbChub2RlKTsKICAgICAgICAgICAgICAgIHZhciBzdGVwOwogICAgICAgICAgICAgICAgd2hpbGUgKCEoc3RlcCA9IGl0ZXJhdG9yLm5leHQoKSkuZG9uZSkgewogICAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQxNShzdGVwLnZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRXhwbGljaXRLZXkoc3RlcC52YWx1ZSwgcGFyZW50VHlwZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwgfHwgdHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyIHx8IC8vIE5vdGU6IE1lbW8gb25seSBjaGVja3Mgb3V0ZXIgcHJvcHMgaGVyZS4KICAgICAgICAgICAgLy8gSW5uZXIgcHJvcHMgYXJlIGNoZWNrZWQgaW4gdGhlIHJlY29uY2lsZXIuCiAgICAgICAgICAgIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRTIpKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzID0gdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wVHlwZXMpIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhwcm9wVHlwZXMsIGVsZW1lbnQucHJvcHMsICJwcm9wIiwgbmFtZSwgZWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZS5Qcm9wVHlwZXMgIT09IHZvaWQgMCAmJiAhcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIF9uYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgIGVycm9yKCJDb21wb25lbnQgJXMgZGVjbGFyZWQgYFByb3BUeXBlc2AgaW5zdGVhZCBvZiBgcHJvcFR5cGVzYC4gRGlkIHlvdSBtaXNzcGVsbCB0aGUgcHJvcGVydHkgYXNzaWdubWVudD8iLCBfbmFtZSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS5nZXREZWZhdWx0UHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgIXR5cGUuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyBpcyBvbmx5IHVzZWQgb24gY2xhc3NpYyBSZWFjdC5jcmVhdGVDbGFzcyBkZWZpbml0aW9ucy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IG5hbWVkIGBkZWZhdWx0UHJvcHNgIGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGcmFnbWVudFByb3BzKGZyYWdtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZnJhZ21lbnQucHJvcHMpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICBpZiAoa2V5ICE9PSAiY2hpbGRyZW4iICYmIGtleSAhPT0gImtleSIpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgcHJvcCBgJXNgIHN1cHBsaWVkIHRvIGBSZWFjdC5GcmFnbWVudGAuIFJlYWN0LkZyYWdtZW50IGNhbiBvbmx5IGhhdmUgYGtleWAgYW5kIGBjaGlsZHJlbmAgcHJvcHMuIiwga2V5KTsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZyYWdtZW50LnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBgcmVmYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiIpOwogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRWxlbWVudFdpdGhWYWxpZGF0aW9uKHR5cGUsIHByb3BzLCBjaGlsZHJlbikgewogICAgICAgICAgdmFyIHZhbGlkVHlwZSA9IGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKTsKICAgICAgICAgIGlmICghdmFsaWRUeXBlKSB7CiAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgIGlmICh0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwgJiYgT2JqZWN0LmtleXModHlwZSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgaW5mbyArPSAiIFlvdSBsaWtlbHkgZm9yZ290IHRvIGV4cG9ydCB5b3VyIGNvbXBvbmVudCBmcm9tIHRoZSBmaWxlIGl0J3MgZGVmaW5lZCBpbiwgb3IgeW91IG1pZ2h0IGhhdmUgbWl4ZWQgdXAgZGVmYXVsdCBhbmQgbmFtZWQgaW1wb3J0cy4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzb3VyY2VJbmZvID0gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW1Gb3JQcm9wcyhwcm9wcyk7CiAgICAgICAgICAgIGlmIChzb3VyY2VJbmZvKSB7CiAgICAgICAgICAgICAgaW5mbyArPSBzb3VyY2VJbmZvOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGluZm8gKz0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHR5cGVTdHJpbmc7CiAgICAgICAgICAgIGlmICh0eXBlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICJudWxsIjsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5Mih0eXBlKSkgewogICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAiYXJyYXkiOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgIT09IHZvaWQgMCAmJiB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gIjwiICsgKGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJVbmtub3duIikgKyAiIC8+IjsKICAgICAgICAgICAgICBpbmZvID0gIiBEaWQgeW91IGFjY2lkZW50YWxseSBleHBvcnQgYSBKU1ggbGl0ZXJhbCBpbnN0ZWFkIG9mIGEgY29tcG9uZW50PyI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdHlwZVN0cmluZyA9IHR5cGVvZiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiUmVhY3QuY3JlYXRlRWxlbWVudDogdHlwZSBpcyBpbnZhbGlkIC0tIGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgYnVpbHQtaW4gY29tcG9uZW50cykgb3IgYSBjbGFzcy9mdW5jdGlvbiAoZm9yIGNvbXBvc2l0ZSBjb21wb25lbnRzKSBidXQgZ290OiAlcy4lcyIsIHR5cGVTdHJpbmcsIGluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQzOS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgaWYgKGVsZW1lbnQgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2YWxpZFR5cGUpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YWxpZGF0ZUNoaWxkS2V5cyhhcmd1bWVudHNbaV0sIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICB2YWxpZGF0ZUZyYWdtZW50UHJvcHMoZWxlbWVudCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0RGVwcmVjYXRlZENyZWF0ZUZhY3RvcnkgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVGYWN0b3J5V2l0aFZhbGlkYXRpb24odHlwZSkgewogICAgICAgICAgdmFyIHZhbGlkYXRlZEZhY3RvcnkgPSBjcmVhdGVFbGVtZW50V2l0aFZhbGlkYXRpb24uYmluZChudWxsLCB0eXBlKTsKICAgICAgICAgIHZhbGlkYXRlZEZhY3RvcnkudHlwZSA9IHR5cGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RGVwcmVjYXRlZENyZWF0ZUZhY3RvcnkpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXREZXByZWNhdGVkQ3JlYXRlRmFjdG9yeSA9IHRydWU7CiAgICAgICAgICAgICAgd2FybjMoIlJlYWN0LmNyZWF0ZUZhY3RvcnkoKSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gQ29uc2lkZXIgdXNpbmcgSlNYIG9yIHVzZSBSZWFjdC5jcmVhdGVFbGVtZW50KCkgZGlyZWN0bHkgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodmFsaWRhdGVkRmFjdG9yeSwgInR5cGUiLCB7CiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHdhcm4zKCJGYWN0b3J5LnR5cGUgaXMgZGVwcmVjYXRlZC4gQWNjZXNzIHRoZSBjbGFzcyBkaXJlY3RseSBiZWZvcmUgcGFzc2luZyBpdCB0byBjcmVhdGVGYWN0b3J5LiIpOwogICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICJ0eXBlIiwgewogICAgICAgICAgICAgICAgICB2YWx1ZTogdHlwZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbGlkYXRlZEZhY3Rvcnk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsb25lRWxlbWVudFdpdGhWYWxpZGF0aW9uKGVsZW1lbnQsIHByb3BzLCBjaGlsZHJlbikgewogICAgICAgICAgdmFyIG5ld0VsZW1lbnQgPSBjbG9uZUVsZW1lbnQ4LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBmb3IgKHZhciBpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YWxpZGF0ZUNoaWxkS2V5cyhhcmd1bWVudHNbaV0sIG5ld0VsZW1lbnQudHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YWxpZGF0ZVByb3BUeXBlcyhuZXdFbGVtZW50KTsKICAgICAgICAgIHJldHVybiBuZXdFbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFRyYW5zaXRpb24oc2NvcGUsIG9wdGlvbnMpIHsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0ge307CiAgICAgICAgICB2YXIgY3VycmVudFRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNjb3BlKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAocHJldlRyYW5zaXRpb24gPT09IG51bGwgJiYgY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMpIHsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGVkRmliZXJzQ291bnQgPSBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5zaXplOwogICAgICAgICAgICAgICAgaWYgKHVwZGF0ZWRGaWJlcnNDb3VudCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgIHdhcm4zKCJEZXRlY3RlZCBhIGxhcmdlIG51bWJlciBvZiB1cGRhdGVzIGluc2lkZSBzdGFydFRyYW5zaXRpb24uIElmIHRoaXMgaXMgZHVlIHRvIGEgc3Vic2NyaXB0aW9uIHBsZWFzZSByZS13cml0ZSBpdCB0byB1c2UgUmVhY3QgcHJvdmlkZWQgaG9va3MuIE90aGVyd2lzZSBjb25jdXJyZW50IG1vZGUgZ3VhcmFudGVlcyBhcmUgb2ZmIHRoZSB0YWJsZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLmNsZWFyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNZXNzYWdlQ2hhbm5lbCA9IGZhbHNlOwogICAgICAgIHZhciBlbnF1ZXVlVGFza0ltcGwgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIGVucXVldWVUYXNrKHRhc2syKSB7CiAgICAgICAgICBpZiAoZW5xdWV1ZVRhc2tJbXBsID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIHJlcXVpcmVTdHJpbmcgPSAoInJlcXVpcmUiICsgTWF0aC5yYW5kb20oKSkuc2xpY2UoMCwgNyk7CiAgICAgICAgICAgICAgdmFyIG5vZGVSZXF1aXJlID0gbW9kdWxlICYmIG1vZHVsZVtyZXF1aXJlU3RyaW5nXTsKICAgICAgICAgICAgICBlbnF1ZXVlVGFza0ltcGwgPSBub2RlUmVxdWlyZS5jYWxsKG1vZHVsZSwgInRpbWVycyIpLnNldEltbWVkaWF0ZTsKICAgICAgICAgICAgfSBjYXRjaCAoX2VycikgewogICAgICAgICAgICAgIGVucXVldWVUYXNrSW1wbCA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChkaWRXYXJuQWJvdXRNZXNzYWdlQ2hhbm5lbCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNZXNzYWdlQ2hhbm5lbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBNZXNzYWdlQ2hhbm5lbCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGlzIGJyb3dzZXIgZG9lcyBub3QgaGF2ZSBhIE1lc3NhZ2VDaGFubmVsIGltcGxlbWVudGF0aW9uLCBzbyBlbnF1ZXVpbmcgdGFza3MgdmlhIGF3YWl0IGFjdChhc3luYyAoKSA9PiAuLi4pIHdpbGwgZmFpbC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUgYXQgaHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JlYWN0L2lzc3VlcyBpZiB5b3UgZW5jb3VudGVyIHRoaXMgd2FybmluZy4iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjaGFubmVsID0gbmV3IE1lc3NhZ2VDaGFubmVsKCk7CiAgICAgICAgICAgICAgICBjaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgY2hhbm5lbC5wb3J0Mi5wb3N0TWVzc2FnZSh2b2lkIDApOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbnF1ZXVlVGFza0ltcGwodGFzazIpOwogICAgICAgIH0KICAgICAgICB2YXIgYWN0U2NvcGVEZXB0aCA9IDA7CiAgICAgICAgdmFyIGRpZFdhcm5Ob0F3YWl0QWN0ID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gYWN0KGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwcmV2QWN0U2NvcGVEZXB0aCA9IGFjdFNjb3BlRGVwdGg7CiAgICAgICAgICAgIGFjdFNjb3BlRGVwdGgrKzsKICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByZXZJc0JhdGNoaW5nTGVnYWN5ID0gUmVhY3RDdXJyZW50QWN0UXVldWUuaXNCYXRjaGluZ0xlZ2FjeTsKICAgICAgICAgICAgdmFyIHJlc3VsdDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5pc0JhdGNoaW5nTGVnYWN5ID0gdHJ1ZTsKICAgICAgICAgICAgICByZXN1bHQgPSBjYWxsYmFjaygpOwogICAgICAgICAgICAgIGlmICghcHJldklzQmF0Y2hpbmdMZWdhY3kgJiYgUmVhY3RDdXJyZW50QWN0UXVldWUuZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHZhciBxdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAocXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgZmx1c2hBY3RRdWV1ZShxdWV1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBwb3BBY3RTY29wZShwcmV2QWN0U2NvcGVEZXB0aCk7CiAgICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmlzQmF0Y2hpbmdMZWdhY3kgPSBwcmV2SXNCYXRjaGluZ0xlZ2FjeTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVzdWx0ICE9PSBudWxsICYmIHR5cGVvZiByZXN1bHQgPT09ICJvYmplY3QiICYmIHR5cGVvZiByZXN1bHQudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciB0aGVuYWJsZVJlc3VsdCA9IHJlc3VsdDsKICAgICAgICAgICAgICB2YXIgd2FzQXdhaXRlZCA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciB0aGVuYWJsZSA9IHsKICAgICAgICAgICAgICAgIHRoZW46IGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAgICAgICB3YXNBd2FpdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdGhlbmFibGVSZXN1bHQudGhlbihmdW5jdGlvbihyZXR1cm5WYWx1ZTIpIHsKICAgICAgICAgICAgICAgICAgICBwb3BBY3RTY29wZShwcmV2QWN0U2NvcGVEZXB0aCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdFNjb3BlRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUyLCByZXNvbHZlLCByZWplY3QpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJldHVyblZhbHVlMik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbihlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBwb3BBY3RTY29wZShwcmV2QWN0U2NvcGVEZXB0aCk7CiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuTm9Bd2FpdEFjdCAmJiB0eXBlb2YgUHJvbWlzZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXdhc0F3YWl0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIGRpZFdhcm5Ob0F3YWl0QWN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJZb3UgY2FsbGVkIGFjdChhc3luYyAoKSA9PiAuLi4pIHdpdGhvdXQgYXdhaXQuIFRoaXMgY291bGQgbGVhZCB0byB1bmV4cGVjdGVkIHRlc3RpbmcgYmVoYXZpb3VyLCBpbnRlcmxlYXZpbmcgbXVsdGlwbGUgYWN0IGNhbGxzIGFuZCBtaXhpbmcgdGhlaXIgc2NvcGVzLiBZb3Ugc2hvdWxkIC0gYXdhaXQgYWN0KGFzeW5jICgpID0+IC4uLik7Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRoZW5hYmxlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByZXR1cm5WYWx1ZSA9IHJlc3VsdDsKICAgICAgICAgICAgICBwb3BBY3RTY29wZShwcmV2QWN0U2NvcGVEZXB0aCk7CiAgICAgICAgICAgICAgaWYgKGFjdFNjb3BlRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgIHZhciBfcXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKF9xdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmbHVzaEFjdFF1ZXVlKF9xdWV1ZSk7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIF90aGVuYWJsZSA9IHsKICAgICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhlbmFibGU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBfdGhlbmFibGUyID0gewogICAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJldHVyblZhbHVlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhlbmFibGUyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BBY3RTY29wZShwcmV2QWN0U2NvcGVEZXB0aCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJldkFjdFNjb3BlRGVwdGggIT09IGFjdFNjb3BlRGVwdGggLSAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBzZWVtIHRvIGhhdmUgb3ZlcmxhcHBpbmcgYWN0KCkgY2FsbHMsIHRoaXMgaXMgbm90IHN1cHBvcnRlZC4gQmUgc3VyZSB0byBhd2FpdCBwcmV2aW91cyBhY3QoKSBjYWxscyBiZWZvcmUgbWFraW5nIGEgbmV3IG9uZS4gIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWN0U2NvcGVEZXB0aCA9IHByZXZBY3RTY29wZURlcHRoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWN1cnNpdmVseUZsdXNoQXN5bmNBY3RXb3JrKHJldHVyblZhbHVlLCByZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHF1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudDsKICAgICAgICAgICAgaWYgKHF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZsdXNoQWN0UXVldWUocXVldWUpOwogICAgICAgICAgICAgICAgZW5xdWV1ZVRhc2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlmIChxdWV1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJldHVyblZhbHVlKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZWN1cnNpdmVseUZsdXNoQXN5bmNBY3RXb3JrKHJldHVyblZhbHVlLCByZXNvbHZlLCByZWplY3QpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXNvbHZlKHJldHVyblZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNGbHVzaGluZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGZsdXNoQWN0UXVldWUocXVldWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFpc0ZsdXNoaW5nKSB7CiAgICAgICAgICAgICAgaXNGbHVzaGluZyA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBmb3IgKDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHF1ZXVlW2ldOwogICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBjYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoY2FsbGJhY2sgIT09IG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcXVldWUubGVuZ3RoID0gMDsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIHF1ZXVlID0gcXVldWUuc2xpY2UoaSArIDEpOwogICAgICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBpc0ZsdXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjcmVhdGVFbGVtZW50JDEgPSBjcmVhdGVFbGVtZW50V2l0aFZhbGlkYXRpb247CiAgICAgICAgdmFyIGNsb25lRWxlbWVudCQxID0gY2xvbmVFbGVtZW50V2l0aFZhbGlkYXRpb247CiAgICAgICAgdmFyIGNyZWF0ZUZhY3RvcnkgPSBjcmVhdGVGYWN0b3J5V2l0aFZhbGlkYXRpb247CiAgICAgICAgdmFyIENoaWxkcmVuMiA9IHsKICAgICAgICAgIG1hcDogbWFwQ2hpbGRyZW4sCiAgICAgICAgICBmb3JFYWNoOiBmb3JFYWNoQ2hpbGRyZW4sCiAgICAgICAgICBjb3VudDogY291bnRDaGlsZHJlbiwKICAgICAgICAgIHRvQXJyYXk6IHRvQXJyYXkyLAogICAgICAgICAgb25seTogb25seUNoaWxkCiAgICAgICAgfTsKICAgICAgICBleHBvcnRzLkNoaWxkcmVuID0gQ2hpbGRyZW4yOwogICAgICAgIGV4cG9ydHMuQ29tcG9uZW50ID0gQ29tcG9uZW50OwogICAgICAgIGV4cG9ydHMuRnJhZ21lbnQgPSBSRUFDVF9GUkFHTUVOVF9UWVBFOwogICAgICAgIGV4cG9ydHMuUHJvZmlsZXIgPSBSRUFDVF9QUk9GSUxFUl9UWVBFOwogICAgICAgIGV4cG9ydHMuUHVyZUNvbXBvbmVudCA9IFB1cmVDb21wb25lbnQzOwogICAgICAgIGV4cG9ydHMuU3RyaWN0TW9kZSA9IFJFQUNUX1NUUklDVF9NT0RFX1RZUEU7CiAgICAgICAgZXhwb3J0cy5TdXNwZW5zZSA9IFJFQUNUX1NVU1BFTlNFX1RZUEU7CiAgICAgICAgZXhwb3J0cy5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzOwogICAgICAgIGV4cG9ydHMuYWN0ID0gYWN0OwogICAgICAgIGV4cG9ydHMuY2xvbmVFbGVtZW50ID0gY2xvbmVFbGVtZW50JDE7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVDb250ZXh0ID0gY3JlYXRlQ29udGV4dDEyOwogICAgICAgIGV4cG9ydHMuY3JlYXRlRWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQkMTsKICAgICAgICBleHBvcnRzLmNyZWF0ZUZhY3RvcnkgPSBjcmVhdGVGYWN0b3J5OwogICAgICAgIGV4cG9ydHMuY3JlYXRlUmVmID0gY3JlYXRlUmVmOwogICAgICAgIGV4cG9ydHMuZm9yd2FyZFJlZiA9IGZvcndhcmRSZWYxNTsKICAgICAgICBleHBvcnRzLmlzVmFsaWRFbGVtZW50ID0gaXNWYWxpZEVsZW1lbnQxNTsKICAgICAgICBleHBvcnRzLmxhenkgPSBsYXp5OwogICAgICAgIGV4cG9ydHMubWVtbyA9IG1lbW83OwogICAgICAgIGV4cG9ydHMuc3RhcnRUcmFuc2l0aW9uID0gc3RhcnRUcmFuc2l0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfYWN0ID0gYWN0OwogICAgICAgIGV4cG9ydHMudXNlQ2FsbGJhY2sgPSB1c2VDYWxsYmFjazg7CiAgICAgICAgZXhwb3J0cy51c2VDb250ZXh0ID0gdXNlQ29udGV4dDEyOwogICAgICAgIGV4cG9ydHMudXNlRGVidWdWYWx1ZSA9IHVzZURlYnVnVmFsdWUyOwogICAgICAgIGV4cG9ydHMudXNlRGVmZXJyZWRWYWx1ZSA9IHVzZURlZmVycmVkVmFsdWU7CiAgICAgICAgZXhwb3J0cy51c2VFZmZlY3QgPSB1c2VFZmZlY3QxNDsKICAgICAgICBleHBvcnRzLnVzZUlkID0gdXNlSWQyOwogICAgICAgIGV4cG9ydHMudXNlSW1wZXJhdGl2ZUhhbmRsZSA9IHVzZUltcGVyYXRpdmVIYW5kbGUzOwogICAgICAgIGV4cG9ydHMudXNlSW5zZXJ0aW9uRWZmZWN0ID0gdXNlSW5zZXJ0aW9uRWZmZWN0OwogICAgICAgIGV4cG9ydHMudXNlTGF5b3V0RWZmZWN0ID0gdXNlTGF5b3V0RWZmZWN0OTsKICAgICAgICBleHBvcnRzLnVzZU1lbW8gPSB1c2VNZW1vOTsKICAgICAgICBleHBvcnRzLnVzZVJlZHVjZXIgPSB1c2VSZWR1Y2VyOwogICAgICAgIGV4cG9ydHMudXNlUmVmID0gdXNlUmVmMTY7CiAgICAgICAgZXhwb3J0cy51c2VTdGF0ZSA9IHVzZVN0YXRlMTM7CiAgICAgICAgZXhwb3J0cy51c2VTeW5jRXh0ZXJuYWxTdG9yZSA9IHVzZVN5bmNFeHRlcm5hbFN0b3JlMjsKICAgICAgICBleHBvcnRzLnVzZVRyYW5zaXRpb24gPSB1c2VUcmFuc2l0aW9uOwogICAgICAgIGV4cG9ydHMudmVyc2lvbiA9IFJlYWN0VmVyc2lvbjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0L2luZGV4LmpzCnZhciByZXF1aXJlX3JlYWN0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0L2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfcmVhY3RfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3NjaGVkdWxlckAwLjIzLjIvbm9kZV9tb2R1bGVzL3NjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3NjaGVkdWxlcl9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vc2NoZWR1bGVyQDAuMjMuMi9ub2RlX21vZHVsZXMvc2NoZWR1bGVyL2Nqcy9zY2hlZHVsZXIuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmICh0cnVlKSB7CiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0KG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgICAgdmFyIGVuYWJsZVNjaGVkdWxlckRlYnVnZ2luZyA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVQcm9maWxpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZnJhbWVZaWVsZE1zID0gNTsKICAgICAgICBmdW5jdGlvbiBwdXNoKGhlYXAsIG5vZGUpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGhlYXAubGVuZ3RoOwogICAgICAgICAgaGVhcC5wdXNoKG5vZGUpOwogICAgICAgICAgc2lmdFVwKGhlYXAsIG5vZGUsIGluZGV4KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGVlazMoaGVhcCkgewogICAgICAgICAgcmV0dXJuIGhlYXAubGVuZ3RoID09PSAwID8gbnVsbCA6IGhlYXBbMF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcChoZWFwKSB7CiAgICAgICAgICBpZiAoaGVhcC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmlyc3QgPSBoZWFwWzBdOwogICAgICAgICAgdmFyIGxhc3QyID0gaGVhcC5wb3AoKTsKICAgICAgICAgIGlmIChsYXN0MiAhPT0gZmlyc3QpIHsKICAgICAgICAgICAgaGVhcFswXSA9IGxhc3QyOwogICAgICAgICAgICBzaWZ0RG93bihoZWFwLCBsYXN0MiwgMCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmlyc3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNpZnRVcChoZWFwLCBub2RlLCBpKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBpOwogICAgICAgICAgd2hpbGUgKGluZGV4ID4gMCkgewogICAgICAgICAgICB2YXIgcGFyZW50SW5kZXggPSBpbmRleCAtIDEgPj4+IDE7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBoZWFwW3BhcmVudEluZGV4XTsKICAgICAgICAgICAgaWYgKGNvbXBhcmUocGFyZW50LCBub2RlKSA+IDApIHsKICAgICAgICAgICAgICBoZWFwW3BhcmVudEluZGV4XSA9IG5vZGU7CiAgICAgICAgICAgICAgaGVhcFtpbmRleF0gPSBwYXJlbnQ7CiAgICAgICAgICAgICAgaW5kZXggPSBwYXJlbnRJbmRleDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2lmdERvd24oaGVhcCwgbm9kZSwgaSkgewogICAgICAgICAgdmFyIGluZGV4ID0gaTsKICAgICAgICAgIHZhciBsZW5ndGggPSBoZWFwLmxlbmd0aDsKICAgICAgICAgIHZhciBoYWxmTGVuZ3RoID0gbGVuZ3RoID4+PiAxOwogICAgICAgICAgd2hpbGUgKGluZGV4IDwgaGFsZkxlbmd0aCkgewogICAgICAgICAgICB2YXIgbGVmdEluZGV4ID0gKGluZGV4ICsgMSkgKiAyIC0gMTsKICAgICAgICAgICAgdmFyIGxlZnQgPSBoZWFwW2xlZnRJbmRleF07CiAgICAgICAgICAgIHZhciByaWdodEluZGV4ID0gbGVmdEluZGV4ICsgMTsKICAgICAgICAgICAgdmFyIHJpZ2h0ID0gaGVhcFtyaWdodEluZGV4XTsKICAgICAgICAgICAgaWYgKGNvbXBhcmUobGVmdCwgbm9kZSkgPCAwKSB7CiAgICAgICAgICAgICAgaWYgKHJpZ2h0SW5kZXggPCBsZW5ndGggJiYgY29tcGFyZShyaWdodCwgbGVmdCkgPCAwKSB7CiAgICAgICAgICAgICAgICBoZWFwW2luZGV4XSA9IHJpZ2h0OwogICAgICAgICAgICAgICAgaGVhcFtyaWdodEluZGV4XSA9IG5vZGU7CiAgICAgICAgICAgICAgICBpbmRleCA9IHJpZ2h0SW5kZXg7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gbGVmdDsKICAgICAgICAgICAgICAgIGhlYXBbbGVmdEluZGV4XSA9IG5vZGU7CiAgICAgICAgICAgICAgICBpbmRleCA9IGxlZnRJbmRleDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmlnaHRJbmRleCA8IGxlbmd0aCAmJiBjb21wYXJlKHJpZ2h0LCBub2RlKSA8IDApIHsKICAgICAgICAgICAgICBoZWFwW2luZGV4XSA9IHJpZ2h0OwogICAgICAgICAgICAgIGhlYXBbcmlnaHRJbmRleF0gPSBub2RlOwogICAgICAgICAgICAgIGluZGV4ID0gcmlnaHRJbmRleDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGFyZShhLCBiKSB7CiAgICAgICAgICB2YXIgZGlmZiA9IGEuc29ydEluZGV4IC0gYi5zb3J0SW5kZXg7CiAgICAgICAgICByZXR1cm4gZGlmZiAhPT0gMCA/IGRpZmYgOiBhLmlkIC0gYi5pZDsKICAgICAgICB9CiAgICAgICAgdmFyIEltbWVkaWF0ZVByaW9yaXR5ID0gMTsKICAgICAgICB2YXIgVXNlckJsb2NraW5nUHJpb3JpdHkgPSAyOwogICAgICAgIHZhciBOb3JtYWxQcmlvcml0eSA9IDM7CiAgICAgICAgdmFyIExvd1ByaW9yaXR5ID0gNDsKICAgICAgICB2YXIgSWRsZVByaW9yaXR5ID0gNTsKICAgICAgICBmdW5jdGlvbiBtYXJrVGFza0Vycm9yZWQodGFzazIsIG1zKSB7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNQZXJmb3JtYW5jZU5vdyA9IHR5cGVvZiBwZXJmb3JtYW5jZSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHBlcmZvcm1hbmNlLm5vdyA9PT0gImZ1bmN0aW9uIjsKICAgICAgICBpZiAoaGFzUGVyZm9ybWFuY2VOb3cpIHsKICAgICAgICAgIHZhciBsb2NhbFBlcmZvcm1hbmNlID0gcGVyZm9ybWFuY2U7CiAgICAgICAgICBleHBvcnRzLnVuc3RhYmxlX25vdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gbG9jYWxQZXJmb3JtYW5jZS5ub3coKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBsb2NhbERhdGUyID0gRGF0ZTsKICAgICAgICAgIHZhciBpbml0aWFsVGltZSA9IGxvY2FsRGF0ZTIubm93KCk7CiAgICAgICAgICBleHBvcnRzLnVuc3RhYmxlX25vdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gbG9jYWxEYXRlMi5ub3coKSAtIGluaXRpYWxUaW1lOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIG1heFNpZ25lZDMxQml0SW50ID0gMTA3Mzc0MTgyMzsKICAgICAgICB2YXIgSU1NRURJQVRFX1BSSU9SSVRZX1RJTUVPVVQgPSAtMTsKICAgICAgICB2YXIgVVNFUl9CTE9DS0lOR19QUklPUklUWV9USU1FT1VUID0gMjUwOwogICAgICAgIHZhciBOT1JNQUxfUFJJT1JJVFlfVElNRU9VVCA9IDVlMzsKICAgICAgICB2YXIgTE9XX1BSSU9SSVRZX1RJTUVPVVQgPSAxZTQ7CiAgICAgICAgdmFyIElETEVfUFJJT1JJVFlfVElNRU9VVCA9IG1heFNpZ25lZDMxQml0SW50OwogICAgICAgIHZhciB0YXNrUXVldWUgPSBbXTsKICAgICAgICB2YXIgdGltZXJRdWV1ZSA9IFtdOwogICAgICAgIHZhciB0YXNrSWRDb3VudGVyID0gMTsKICAgICAgICB2YXIgY3VycmVudFRhc2sgPSBudWxsOwogICAgICAgIHZhciBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgIHZhciBpc1BlcmZvcm1pbmdXb3JrID0gZmFsc2U7CiAgICAgICAgdmFyIGlzSG9zdENhbGxiYWNrU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgdmFyIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICB2YXIgbG9jYWxTZXRUaW1lb3V0ID0gdHlwZW9mIHNldFRpbWVvdXQgPT09ICJmdW5jdGlvbiIgPyBzZXRUaW1lb3V0IDogbnVsbDsKICAgICAgICB2YXIgbG9jYWxDbGVhclRpbWVvdXQgPSB0eXBlb2YgY2xlYXJUaW1lb3V0ID09PSAiZnVuY3Rpb24iID8gY2xlYXJUaW1lb3V0IDogbnVsbDsKICAgICAgICB2YXIgbG9jYWxTZXRJbW1lZGlhdGUgPSB0eXBlb2Ygc2V0SW1tZWRpYXRlICE9PSAidW5kZWZpbmVkIiA/IHNldEltbWVkaWF0ZSA6IG51bGw7CiAgICAgICAgdmFyIGlzSW5wdXRQZW5kaW5nID0gdHlwZW9mIG5hdmlnYXRvciAhPT0gInVuZGVmaW5lZCIgJiYgbmF2aWdhdG9yLnNjaGVkdWxpbmcgIT09IHZvaWQgMCAmJiBuYXZpZ2F0b3Iuc2NoZWR1bGluZy5pc0lucHV0UGVuZGluZyAhPT0gdm9pZCAwID8gbmF2aWdhdG9yLnNjaGVkdWxpbmcuaXNJbnB1dFBlbmRpbmcuYmluZChuYXZpZ2F0b3Iuc2NoZWR1bGluZykgOiBudWxsOwogICAgICAgIGZ1bmN0aW9uIGFkdmFuY2VUaW1lcnMoY3VycmVudFRpbWUpIHsKICAgICAgICAgIHZhciB0aW1lciA9IHBlZWszKHRpbWVyUXVldWUpOwogICAgICAgICAgd2hpbGUgKHRpbWVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0aW1lci5jYWxsYmFjayA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHBvcCh0aW1lclF1ZXVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aW1lci5zdGFydFRpbWUgPD0gY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgICBwb3AodGltZXJRdWV1ZSk7CiAgICAgICAgICAgICAgdGltZXIuc29ydEluZGV4ID0gdGltZXIuZXhwaXJhdGlvblRpbWU7CiAgICAgICAgICAgICAgcHVzaCh0YXNrUXVldWUsIHRpbWVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGltZXIgPSBwZWVrMyh0aW1lclF1ZXVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlVGltZW91dChjdXJyZW50VGltZSkgewogICAgICAgICAgaXNIb3N0VGltZW91dFNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgYWR2YW5jZVRpbWVycyhjdXJyZW50VGltZSk7CiAgICAgICAgICBpZiAoIWlzSG9zdENhbGxiYWNrU2NoZWR1bGVkKSB7CiAgICAgICAgICAgIGlmIChwZWVrMyh0YXNrUXVldWUpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICAgIHJlcXVlc3RIb3N0Q2FsbGJhY2soZmx1c2hXb3JrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZmlyc3RUaW1lciA9IHBlZWszKHRpbWVyUXVldWUpOwogICAgICAgICAgICAgIGlmIChmaXJzdFRpbWVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXF1ZXN0SG9zdFRpbWVvdXQoaGFuZGxlVGltZW91dCwgZmlyc3RUaW1lci5zdGFydFRpbWUgLSBjdXJyZW50VGltZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoV29yayhoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpIHsKICAgICAgICAgIGlzSG9zdENhbGxiYWNrU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICBpZiAoaXNIb3N0VGltZW91dFNjaGVkdWxlZCkgewogICAgICAgICAgICBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICAgIGNhbmNlbEhvc3RUaW1lb3V0KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpc1BlcmZvcm1pbmdXb3JrID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxpbmcpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtMb29wKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMik7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VGFzayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgICAgICAgICBtYXJrVGFza0Vycm9yZWQoY3VycmVudFRhc2ssIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgY3VycmVudFRhc2suaXNRdWV1ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gd29ya0xvb3AoaGFzVGltZVJlbWFpbmluZywgaW5pdGlhbFRpbWUyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY3VycmVudFRhc2sgPSBudWxsOwogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgaXNQZXJmb3JtaW5nV29yayA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3b3JrTG9vcChoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpIHsKICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGluaXRpYWxUaW1lMjsKICAgICAgICAgIGFkdmFuY2VUaW1lcnMoY3VycmVudFRpbWUpOwogICAgICAgICAgY3VycmVudFRhc2sgPSBwZWVrMyh0YXNrUXVldWUpOwogICAgICAgICAgd2hpbGUgKGN1cnJlbnRUYXNrICE9PSBudWxsICYmICFlbmFibGVTY2hlZHVsZXJEZWJ1Z2dpbmcpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrLmV4cGlyYXRpb25UaW1lID4gY3VycmVudFRpbWUgJiYgKCFoYXNUaW1lUmVtYWluaW5nIHx8IHNob3VsZFlpZWxkVG9Ib3N0KCkpKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gY3VycmVudFRhc2suY2FsbGJhY2s7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBjdXJyZW50VGFzay5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBjdXJyZW50VGFzay5wcmlvcml0eUxldmVsOwogICAgICAgICAgICAgIHZhciBkaWRVc2VyQ2FsbGJhY2tUaW1lb3V0ID0gY3VycmVudFRhc2suZXhwaXJhdGlvblRpbWUgPD0gY3VycmVudFRpbWU7CiAgICAgICAgICAgICAgdmFyIGNvbnRpbnVhdGlvbkNhbGxiYWNrID0gY2FsbGJhY2soZGlkVXNlckNhbGxiYWNrVGltZW91dCk7CiAgICAgICAgICAgICAgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgY29udGludWF0aW9uQ2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRUYXNrLmNhbGxiYWNrID0gY29udGludWF0aW9uQ2FsbGJhY2s7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VGFzayA9PT0gcGVlazModGFza1F1ZXVlKSkgewogICAgICAgICAgICAgICAgICBwb3AodGFza1F1ZXVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYWR2YW5jZVRpbWVycyhjdXJyZW50VGltZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcG9wKHRhc2tRdWV1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudFRhc2sgPSBwZWVrMyh0YXNrUXVldWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnRUYXNrICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGZpcnN0VGltZXIgPSBwZWVrMyh0aW1lclF1ZXVlKTsKICAgICAgICAgICAgaWYgKGZpcnN0VGltZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXF1ZXN0SG9zdFRpbWVvdXQoaGFuZGxlVGltZW91dCwgZmlyc3RUaW1lci5zdGFydFRpbWUgLSBjdXJyZW50VGltZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9ydW5XaXRoUHJpb3JpdHkocHJpb3JpdHlMZXZlbCwgZXZlbnRIYW5kbGVyKSB7CiAgICAgICAgICBzd2l0Y2ggKHByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgICAgY2FzZSBJbW1lZGlhdGVQcmlvcml0eToKICAgICAgICAgICAgY2FzZSBVc2VyQmxvY2tpbmdQcmlvcml0eToKICAgICAgICAgICAgY2FzZSBOb3JtYWxQcmlvcml0eToKICAgICAgICAgICAgY2FzZSBMb3dQcmlvcml0eToKICAgICAgICAgICAgY2FzZSBJZGxlUHJpb3JpdHk6CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwcmlvcml0eUxldmVsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50SGFuZGxlcigpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwcmV2aW91c1ByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX25leHQoZXZlbnRIYW5kbGVyKSB7CiAgICAgICAgICB2YXIgcHJpb3JpdHlMZXZlbDsKICAgICAgICAgIHN3aXRjaCAoY3VycmVudFByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgICAgY2FzZSBJbW1lZGlhdGVQcmlvcml0eToKICAgICAgICAgICAgY2FzZSBVc2VyQmxvY2tpbmdQcmlvcml0eToKICAgICAgICAgICAgY2FzZSBOb3JtYWxQcmlvcml0eToKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwcmlvcml0eUxldmVsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50SGFuZGxlcigpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwcmV2aW91c1ByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3dyYXBDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgdmFyIHBhcmVudFByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHBhcmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwcmV2aW91c1ByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3NjaGVkdWxlQ2FsbGJhY2socHJpb3JpdHlMZXZlbCwgY2FsbGJhY2ssIG9wdGlvbnMpIHsKICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICB2YXIgc3RhcnRUaW1lMjsKICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gIm9iamVjdCIgJiYgb3B0aW9ucyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZGVsYXkgPSBvcHRpb25zLmRlbGF5OwogICAgICAgICAgICBpZiAodHlwZW9mIGRlbGF5ID09PSAibnVtYmVyIiAmJiBkZWxheSA+IDApIHsKICAgICAgICAgICAgICBzdGFydFRpbWUyID0gY3VycmVudFRpbWUgKyBkZWxheTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdGFydFRpbWUyID0gY3VycmVudFRpbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0aW1lb3V0OwogICAgICAgICAgc3dpdGNoIChwcmlvcml0eUxldmVsKSB7CiAgICAgICAgICAgIGNhc2UgSW1tZWRpYXRlUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IElNTUVESUFURV9QUklPUklUWV9USU1FT1VUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICAgIHRpbWVvdXQgPSBVU0VSX0JMT0NLSU5HX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgSWRsZVByaW9yaXR5OgogICAgICAgICAgICAgIHRpbWVvdXQgPSBJRExFX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgTG93UHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IExPV19QUklPUklUWV9USU1FT1VUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRpbWVvdXQgPSBOT1JNQUxfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZSA9IHN0YXJ0VGltZTIgKyB0aW1lb3V0OwogICAgICAgICAgdmFyIG5ld1Rhc2sgPSB7CiAgICAgICAgICAgIGlkOiB0YXNrSWRDb3VudGVyKyssCiAgICAgICAgICAgIGNhbGxiYWNrLAogICAgICAgICAgICBwcmlvcml0eUxldmVsLAogICAgICAgICAgICBzdGFydFRpbWU6IHN0YXJ0VGltZTIsCiAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lLAogICAgICAgICAgICBzb3J0SW5kZXg6IC0xCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKHN0YXJ0VGltZTIgPiBjdXJyZW50VGltZSkgewogICAgICAgICAgICBuZXdUYXNrLnNvcnRJbmRleCA9IHN0YXJ0VGltZTI7CiAgICAgICAgICAgIHB1c2godGltZXJRdWV1ZSwgbmV3VGFzayk7CiAgICAgICAgICAgIGlmIChwZWVrMyh0YXNrUXVldWUpID09PSBudWxsICYmIG5ld1Rhc2sgPT09IHBlZWszKHRpbWVyUXVldWUpKSB7CiAgICAgICAgICAgICAgaWYgKGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQpIHsKICAgICAgICAgICAgICAgIGNhbmNlbEhvc3RUaW1lb3V0KCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXF1ZXN0SG9zdFRpbWVvdXQoaGFuZGxlVGltZW91dCwgc3RhcnRUaW1lMiAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV3VGFzay5zb3J0SW5kZXggPSBleHBpcmF0aW9uVGltZTsKICAgICAgICAgICAgcHVzaCh0YXNrUXVldWUsIG5ld1Rhc2spOwogICAgICAgICAgICBpZiAoIWlzSG9zdENhbGxiYWNrU2NoZWR1bGVkICYmICFpc1BlcmZvcm1pbmdXb3JrKSB7CiAgICAgICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICAgIHJlcXVlc3RIb3N0Q2FsbGJhY2soZmx1c2hXb3JrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5ld1Rhc2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uKCkgewogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9jb250aW51ZUV4ZWN1dGlvbigpIHsKICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgJiYgIWlzUGVyZm9ybWluZ1dvcmspIHsKICAgICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICByZXF1ZXN0SG9zdENhbGxiYWNrKGZsdXNoV29yayk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2dldEZpcnN0Q2FsbGJhY2tOb2RlKCkgewogICAgICAgICAgcmV0dXJuIHBlZWszKHRhc2tRdWV1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2NhbmNlbENhbGxiYWNrKHRhc2syKSB7CiAgICAgICAgICB0YXNrMi5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2dldEN1cnJlbnRQcmlvcml0eUxldmVsKCkgewogICAgICAgICAgcmV0dXJuIGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgIH0KICAgICAgICB2YXIgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICB2YXIgc2NoZWR1bGVkSG9zdENhbGxiYWNrID0gbnVsbDsKICAgICAgICB2YXIgdGFza1RpbWVvdXRJRCA9IC0xOwogICAgICAgIHZhciBmcmFtZUludGVydmFsID0gZnJhbWVZaWVsZE1zOwogICAgICAgIHZhciBzdGFydFRpbWUgPSAtMTsKICAgICAgICBmdW5jdGlvbiBzaG91bGRZaWVsZFRvSG9zdCgpIHsKICAgICAgICAgIHZhciB0aW1lRWxhcHNlZCA9IGV4cG9ydHMudW5zdGFibGVfbm93KCkgLSBzdGFydFRpbWU7CiAgICAgICAgICBpZiAodGltZUVsYXBzZWQgPCBmcmFtZUludGVydmFsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0UGFpbnQoKSB7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcmNlRnJhbWVSYXRlKGZwcykgewogICAgICAgICAgaWYgKGZwcyA8IDAgfHwgZnBzID4gMTI1KSB7CiAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oImZvcmNlRnJhbWVSYXRlIHRha2VzIGEgcG9zaXRpdmUgaW50IGJldHdlZW4gMCBhbmQgMTI1LCBmb3JjaW5nIGZyYW1lIHJhdGVzIGhpZ2hlciB0aGFuIDEyNSBmcHMgaXMgbm90IHN1cHBvcnRlZCIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZnBzID4gMCkgewogICAgICAgICAgICBmcmFtZUludGVydmFsID0gTWF0aC5mbG9vcigxZTMgLyBmcHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnJhbWVJbnRlcnZhbCA9IGZyYW1lWWllbGRNczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHNjaGVkdWxlZEhvc3RDYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgICBzdGFydFRpbWUgPSBjdXJyZW50VGltZTsKICAgICAgICAgICAgdmFyIGhhc1RpbWVSZW1haW5pbmcgPSB0cnVlOwogICAgICAgICAgICB2YXIgaGFzTW9yZVdvcmsgPSB0cnVlOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGhhc01vcmVXb3JrID0gc2NoZWR1bGVkSG9zdENhbGxiYWNrKGhhc1RpbWVSZW1haW5pbmcsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBpZiAoaGFzTW9yZVdvcmspIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICBzY2hlZHVsZWRIb3N0Q2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZTsKICAgICAgICBpZiAodHlwZW9mIGxvY2FsU2V0SW1tZWRpYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBsb2NhbFNldEltbWVkaWF0ZShwZXJmb3JtV29ya1VudGlsRGVhZGxpbmUpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBNZXNzYWdlQ2hhbm5lbCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHZhciBjaGFubmVsID0gbmV3IE1lc3NhZ2VDaGFubmVsKCk7CiAgICAgICAgICB2YXIgcG9ydCA9IGNoYW5uZWwucG9ydDI7CiAgICAgICAgICBjaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZTsKICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBvcnQucG9zdE1lc3NhZ2UobnVsbCk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBsb2NhbFNldFRpbWVvdXQocGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lLCAwKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RIb3N0Q2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIHNjaGVkdWxlZEhvc3RDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgaWYgKCFpc01lc3NhZ2VMb29wUnVubmluZykgewogICAgICAgICAgICBpc01lc3NhZ2VMb29wUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RIb3N0VGltZW91dChjYWxsYmFjaywgbXMpIHsKICAgICAgICAgIHRhc2tUaW1lb3V0SUQgPSBsb2NhbFNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKGV4cG9ydHMudW5zdGFibGVfbm93KCkpOwogICAgICAgICAgfSwgbXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5jZWxIb3N0VGltZW91dCgpIHsKICAgICAgICAgIGxvY2FsQ2xlYXJUaW1lb3V0KHRhc2tUaW1lb3V0SUQpOwogICAgICAgICAgdGFza1RpbWVvdXRJRCA9IC0xOwogICAgICAgIH0KICAgICAgICB2YXIgdW5zdGFibGVfcmVxdWVzdFBhaW50ID0gcmVxdWVzdFBhaW50OwogICAgICAgIHZhciB1bnN0YWJsZV9Qcm9maWxpbmcgPSBudWxsOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfSWRsZVByaW9yaXR5ID0gSWRsZVByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfSW1tZWRpYXRlUHJpb3JpdHkgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX0xvd1ByaW9yaXR5ID0gTG93UHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eSA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfUHJvZmlsaW5nID0gdW5zdGFibGVfUHJvZmlsaW5nOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfVXNlckJsb2NraW5nUHJpb3JpdHkgPSBVc2VyQmxvY2tpbmdQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2NhbmNlbENhbGxiYWNrID0gdW5zdGFibGVfY2FuY2VsQ2FsbGJhY2s7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9jb250aW51ZUV4ZWN1dGlvbiA9IHVuc3RhYmxlX2NvbnRpbnVlRXhlY3V0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfZm9yY2VGcmFtZVJhdGUgPSBmb3JjZUZyYW1lUmF0ZTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2dldEN1cnJlbnRQcmlvcml0eUxldmVsID0gdW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9nZXRGaXJzdENhbGxiYWNrTm9kZSA9IHVuc3RhYmxlX2dldEZpcnN0Q2FsbGJhY2tOb2RlOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfbmV4dCA9IHVuc3RhYmxlX25leHQ7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9wYXVzZUV4ZWN1dGlvbiA9IHVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfcmVxdWVzdFBhaW50ID0gdW5zdGFibGVfcmVxdWVzdFBhaW50OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfcnVuV2l0aFByaW9yaXR5ID0gdW5zdGFibGVfcnVuV2l0aFByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayA9IHVuc3RhYmxlX3NjaGVkdWxlQ2FsbGJhY2s7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9zaG91bGRZaWVsZCA9IHNob3VsZFlpZWxkVG9Ib3N0OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfd3JhcENhbGxiYWNrID0gdW5zdGFibGVfd3JhcENhbGxiYWNrOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgfSkoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3NjaGVkdWxlckAwLjIzLjIvbm9kZV9tb2R1bGVzL3NjaGVkdWxlci9pbmRleC5qcwp2YXIgcmVxdWlyZV9zY2hlZHVsZXIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3NjaGVkdWxlckAwLjIzLjIvbm9kZV9tb2R1bGVzL3NjaGVkdWxlci9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3NjaGVkdWxlcl9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9janMvcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3JlYWN0X2RvbV9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9janMvcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdDM5ID0gcmVxdWlyZV9yZWFjdCgpOwogICAgICAgIHZhciBTY2hlZHVsZXIgPSByZXF1aXJlX3NjaGVkdWxlcigpOwogICAgICAgIHZhciBSZWFjdFNoYXJlZEludGVybmFscyA9IFJlYWN0MzkuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CiAgICAgICAgdmFyIHN1cHByZXNzV2FybmluZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHNldFN1cHByZXNzV2FybmluZyhuZXdTdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3VwcHJlc3NXYXJuaW5nID0gbmV3U3VwcHJlc3NXYXJuaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuMyhmb3JtYXQyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghc3VwcHJlc3NXYXJuaW5nKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygid2FybiIsIGZvcm1hdDIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFzdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjIgPiAxID8gX2xlbjIgLSAxIDogMCksIF9rZXkyID0gMTsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5MiAtIDFdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJpbnRXYXJuaW5nKCJlcnJvciIsIGZvcm1hdDIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByaW50V2FybmluZyhsZXZlbCwgZm9ybWF0MiwgYXJncykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgICAgICB2YXIgc3RhY2sgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lMi5nZXRTdGFja0FkZGVuZHVtKCk7CiAgICAgICAgICAgIGlmIChzdGFjayAhPT0gIiIpIHsKICAgICAgICAgICAgICBmb3JtYXQyICs9ICIlcyI7CiAgICAgICAgICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KFtzdGFja10pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhcmdzV2l0aEZvcm1hdCA9IGFyZ3MubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKGl0ZW0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYXJnc1dpdGhGb3JtYXQudW5zaGlmdCgiV2FybmluZzogIiArIGZvcm1hdDIpOwogICAgICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW2xldmVsXSwgY29uc29sZSwgYXJnc1dpdGhGb3JtYXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgRnVuY3Rpb25Db21wb25lbnQgPSAwOwogICAgICAgIHZhciBDbGFzc0NvbXBvbmVudCA9IDE7CiAgICAgICAgdmFyIEluZGV0ZXJtaW5hdGVDb21wb25lbnQgPSAyOwogICAgICAgIHZhciBIb3N0Um9vdCA9IDM7CiAgICAgICAgdmFyIEhvc3RQb3J0YWwgPSA0OwogICAgICAgIHZhciBIb3N0Q29tcG9uZW50ID0gNTsKICAgICAgICB2YXIgSG9zdFRleHQgPSA2OwogICAgICAgIHZhciBGcmFnbWVudDkgPSA3OwogICAgICAgIHZhciBNb2RlID0gODsKICAgICAgICB2YXIgQ29udGV4dENvbnN1bWVyID0gOTsKICAgICAgICB2YXIgQ29udGV4dFByb3ZpZGVyID0gMTA7CiAgICAgICAgdmFyIEZvcndhcmRSZWYyID0gMTE7CiAgICAgICAgdmFyIFByb2ZpbGVyID0gMTI7CiAgICAgICAgdmFyIFN1c3BlbnNlQ29tcG9uZW50ID0gMTM7CiAgICAgICAgdmFyIE1lbW9Db21wb25lbnQgPSAxNDsKICAgICAgICB2YXIgU2ltcGxlTWVtb0NvbXBvbmVudCA9IDE1OwogICAgICAgIHZhciBMYXp5Q29tcG9uZW50ID0gMTY7CiAgICAgICAgdmFyIEluY29tcGxldGVDbGFzc0NvbXBvbmVudCA9IDE3OwogICAgICAgIHZhciBEZWh5ZHJhdGVkRnJhZ21lbnQgPSAxODsKICAgICAgICB2YXIgU3VzcGVuc2VMaXN0Q29tcG9uZW50ID0gMTk7CiAgICAgICAgdmFyIFNjb3BlQ29tcG9uZW50ID0gMjE7CiAgICAgICAgdmFyIE9mZnNjcmVlbkNvbXBvbmVudCA9IDIyOwogICAgICAgIHZhciBMZWdhY3lIaWRkZW5Db21wb25lbnQgPSAyMzsKICAgICAgICB2YXIgQ2FjaGVDb21wb25lbnQgPSAyNDsKICAgICAgICB2YXIgVHJhY2luZ01hcmtlckNvbXBvbmVudCA9IDI1OwogICAgICAgIHZhciBlbmFibGVDbGllbnRSZW5kZXJGYWxsYmFja09uVGV4dE1pc21hdGNoID0gdHJ1ZTsKICAgICAgICB2YXIgZW5hYmxlTmV3UmVjb25jaWxlciA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMYXp5Q29udGV4dFByb3BhZ2F0aW9uID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVTdXNwZW5zZUF2b2lkVGhpc0ZhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgdmFyIGRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQgPSBmYWxzZTsKICAgICAgICB2YXIgd2FybkFib3V0U3RyaW5nUmVmcyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlciA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVByb2ZpbGVyVGltZXIgPSB0cnVlOwogICAgICAgIHZhciBlbmFibGVQcm9maWxlckNvbW1pdEhvb2tzID0gdHJ1ZTsKICAgICAgICB2YXIgYWxsTmF0aXZlRXZlbnRzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcyA9IHt9OwogICAgICAgIHZhciBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzID0ge307CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJUd29QaGFzZUV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lLCBkZXBlbmRlbmNpZXMpOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lICsgIkNhcHR1cmUiLCBkZXBlbmRlbmNpZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlckRpcmVjdEV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSkgewogICAgICAgICAgICAgIGVycm9yKCJFdmVudFJlZ2lzdHJ5OiBNb3JlIHRoYW4gb25lIHBsdWdpbiBhdHRlbXB0ZWQgdG8gcHVibGlzaCB0aGUgc2FtZSByZWdpc3RyYXRpb24gbmFtZSwgYCVzYC4iLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSA9IGRlcGVuZGVuY2llczsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gcmVnaXN0cmF0aW9uTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzW2xvd2VyQ2FzZWROYW1lXSA9IHJlZ2lzdHJhdGlvbk5hbWU7CiAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lID09PSAib25Eb3VibGVDbGljayIpIHsKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzLm9uZGJsY2xpY2sgPSByZWdpc3RyYXRpb25OYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlcGVuZGVuY2llcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhbGxOYXRpdmVFdmVudHMuYWRkKGRlcGVuZGVuY2llc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjYW5Vc2VET00yID0gISEodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50ICE9PSAidW5kZWZpbmVkIik7CiAgICAgICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgICAgICBmdW5jdGlvbiB0eXBlTmFtZSh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzVG9TdHJpbmdUYWcgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC50b1N0cmluZ1RhZzsKICAgICAgICAgICAgdmFyIHR5cGUgPSBoYXNUb1N0cmluZ1RhZyAmJiB2YWx1ZVtTeW1ib2wudG9TdHJpbmdUYWddIHx8IHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUgfHwgIk9iamVjdCI7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbih2YWx1ZSwgYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBgJXNgIGF0dHJpYnV0ZSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgYXR0cmlidXRlTmFtZSwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0tleVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGtleSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1Byb3BTdHJpbmdDb2VyY2lvbih2YWx1ZSwgcHJvcE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQgYCVzYCBwcm9wIGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCBwcm9wTmFtZSwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0NTU1Byb3BlcnR5U3RyaW5nQ29lcmNpb24odmFsdWUsIHByb3BOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGAlc2AgQ1NTIHByb3BlcnR5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCBwcm9wTmFtZSwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0h0bWxTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBIVE1MIG1hcmt1cCB1c2VzIGEgdmFsdWUgb2YgdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiRm9ybSBmaWVsZCB2YWx1ZXMgKHZhbHVlLCBjaGVja2VkLCBkZWZhdWx0VmFsdWUsIG9yIGRlZmF1bHRDaGVja2VkIHByb3BzKSBtdXN0IGJlIHN0cmluZ3MsIG5vdCAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJFU0VSVkVEID0gMDsKICAgICAgICB2YXIgU1RSSU5HID0gMTsKICAgICAgICB2YXIgQk9PTEVBTklTSF9TVFJJTkcgPSAyOwogICAgICAgIHZhciBCT09MRUFOID0gMzsKICAgICAgICB2YXIgT1ZFUkxPQURFRF9CT09MRUFOID0gNDsKICAgICAgICB2YXIgTlVNRVJJQyA9IDU7CiAgICAgICAgdmFyIFBPU0lUSVZFX05VTUVSSUMgPSA2OwogICAgICAgIHZhciBBVFRSSUJVVEVfTkFNRV9TVEFSVF9DSEFSID0gIjpBLVpfYS16XFx1MDBDMC1cXHUwMEQ2XFx1MDBEOC1cXHUwMEY2XFx1MDBGOC1cXHUwMkZGXFx1MDM3MC1cXHUwMzdEXFx1MDM3Ri1cXHUxRkZGXFx1MjAwQy1cXHUyMDBEXFx1MjA3MC1cXHUyMThGXFx1MkMwMC1cXHUyRkVGXFx1MzAwMS1cXHVEN0ZGXFx1RjkwMC1cXHVGRENGXFx1RkRGMC1cXHVGRkZEIjsKICAgICAgICB2YXIgQVRUUklCVVRFX05BTUVfQ0hBUiA9IEFUVFJJQlVURV9OQU1FX1NUQVJUX0NIQVIgKyAiXFwtLjAtOVxcdTAwQjdcXHUwMzAwLVxcdTAzNkZcXHUyMDNGLVxcdTIwNDAiOwogICAgICAgIHZhciBWQUxJRF9BVFRSSUJVVEVfTkFNRV9SRUdFWCA9IG5ldyBSZWdFeHAoIl5bIiArIEFUVFJJQlVURV9OQU1FX1NUQVJUX0NIQVIgKyAiXVsiICsgQVRUUklCVVRFX05BTUVfQ0hBUiArICJdKiQiKTsKICAgICAgICB2YXIgaWxsZWdhbEF0dHJpYnV0ZU5hbWVDYWNoZSA9IHt9OwogICAgICAgIHZhciB2YWxpZGF0ZWRBdHRyaWJ1dGVOYW1lQ2FjaGUgPSB7fTsKICAgICAgICBmdW5jdGlvbiBpc0F0dHJpYnV0ZU5hbWVTYWZlKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbGlkYXRlZEF0dHJpYnV0ZU5hbWVDYWNoZSwgYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChpbGxlZ2FsQXR0cmlidXRlTmFtZUNhY2hlLCBhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoVkFMSURfQVRUUklCVVRFX05BTUVfUkVHRVgudGVzdChhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICB2YWxpZGF0ZWRBdHRyaWJ1dGVOYW1lQ2FjaGVbYXR0cmlidXRlTmFtZV0gPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlsbGVnYWxBdHRyaWJ1dGVOYW1lQ2FjaGVbYXR0cmlidXRlTmFtZV0gPSB0cnVlOwogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhdHRyaWJ1dGUgbmFtZTogYCVzYCIsIGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRJZ25vcmVBdHRyaWJ1dGUobmFtZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYW1lLmxlbmd0aCA+IDIgJiYgKG5hbWVbMF0gPT09ICJvIiB8fCBuYW1lWzBdID09PSAiTyIpICYmIChuYW1lWzFdID09PSAibiIgfHwgbmFtZVsxXSA9PT0gIk4iKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgICAgICAgY2FzZSAic3ltYm9sIjoKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6IHsKICAgICAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuICFwcm9wZXJ0eUluZm8uYWNjZXB0c0Jvb2xlYW5zOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgcHJlZml4MiA9IG5hbWUudG9Mb3dlckNhc2UoKS5zbGljZSgwLCA1KTsKICAgICAgICAgICAgICAgIHJldHVybiBwcmVmaXgyICE9PSAiZGF0YS0iICYmIHByZWZpeDIgIT09ICJhcmlhLSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZVdpdGhXYXJuaW5nKG5hbWUsIHZhbHVlLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgIHN3aXRjaCAocHJvcGVydHlJbmZvLnR5cGUpIHsKICAgICAgICAgICAgICBjYXNlIEJPT0xFQU46CiAgICAgICAgICAgICAgICByZXR1cm4gIXZhbHVlOwogICAgICAgICAgICAgIGNhc2UgT1ZFUkxPQURFRF9CT09MRUFOOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09PSBmYWxzZTsKICAgICAgICAgICAgICBjYXNlIE5VTUVSSUM6CiAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4odmFsdWUpOwogICAgICAgICAgICAgIGNhc2UgUE9TSVRJVkVfTlVNRVJJQzoKICAgICAgICAgICAgICAgIHJldHVybiBpc05hTih2YWx1ZSkgfHwgdmFsdWUgPCAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFByb3BlcnR5SW5mbyhuYW1lKSB7CiAgICAgICAgICByZXR1cm4gcHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSA/IHByb3BlcnRpZXNbbmFtZV0gOiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBQcm9wZXJ0eUluZm9SZWNvcmQobmFtZSwgdHlwZSwgbXVzdFVzZVByb3BlcnR5LCBhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVOYW1lc3BhY2UsIHNhbml0aXplVVJMMiwgcmVtb3ZlRW1wdHlTdHJpbmcpIHsKICAgICAgICAgIHRoaXMuYWNjZXB0c0Jvb2xlYW5zID0gdHlwZSA9PT0gQk9PTEVBTklTSF9TVFJJTkcgfHwgdHlwZSA9PT0gQk9PTEVBTiB8fCB0eXBlID09PSBPVkVSTE9BREVEX0JPT0xFQU47CiAgICAgICAgICB0aGlzLmF0dHJpYnV0ZU5hbWUgPSBhdHRyaWJ1dGVOYW1lOwogICAgICAgICAgdGhpcy5hdHRyaWJ1dGVOYW1lc3BhY2UgPSBhdHRyaWJ1dGVOYW1lc3BhY2U7CiAgICAgICAgICB0aGlzLm11c3RVc2VQcm9wZXJ0eSA9IG11c3RVc2VQcm9wZXJ0eTsKICAgICAgICAgIHRoaXMucHJvcGVydHlOYW1lID0gbmFtZTsKICAgICAgICAgIHRoaXMudHlwZSA9IHR5cGU7CiAgICAgICAgICB0aGlzLnNhbml0aXplVVJMID0gc2FuaXRpemVVUkwyOwogICAgICAgICAgdGhpcy5yZW1vdmVFbXB0eVN0cmluZyA9IHJlbW92ZUVtcHR5U3RyaW5nOwogICAgICAgIH0KICAgICAgICB2YXIgcHJvcGVydGllcyA9IHt9OwogICAgICAgIHZhciByZXNlcnZlZFByb3BzID0gWwogICAgICAgICAgImNoaWxkcmVuIiwKICAgICAgICAgICJkYW5nZXJvdXNseVNldElubmVySFRNTCIsCiAgICAgICAgICAvLyBUT0RPOiBUaGlzIHByZXZlbnRzIHRoZSBhc3NpZ25tZW50IG9mIGRlZmF1bHRWYWx1ZSB0byByZWd1bGFyCiAgICAgICAgICAvLyBlbGVtZW50cyAobm90IGp1c3QgaW5wdXRzKS4gTm93IHRoYXQgUmVhY3RET01JbnB1dCBhc3NpZ25zIHRvIHRoZQogICAgICAgICAgLy8gZGVmYXVsdFZhbHVlIHByb3BlcnR5IC0tIGRvIHdlIG5lZWQgdGhpcz8KICAgICAgICAgICJkZWZhdWx0VmFsdWUiLAogICAgICAgICAgImRlZmF1bHRDaGVja2VkIiwKICAgICAgICAgICJpbm5lckhUTUwiLAogICAgICAgICAgInN1cHByZXNzQ29udGVudEVkaXRhYmxlV2FybmluZyIsCiAgICAgICAgICAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIiwKICAgICAgICAgICJzdHlsZSIKICAgICAgICBdOwogICAgICAgIHJlc2VydmVkUHJvcHMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgUkVTRVJWRUQsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFtbImFjY2VwdENoYXJzZXQiLCAiYWNjZXB0LWNoYXJzZXQiXSwgWyJjbGFzc05hbWUiLCAiY2xhc3MiXSwgWyJodG1sRm9yIiwgImZvciJdLCBbImh0dHBFcXVpdiIsICJodHRwLWVxdWl2Il1dLmZvckVhY2goZnVuY3Rpb24oX3JlZjIpIHsKICAgICAgICAgIHZhciBuYW1lID0gX3JlZjJbMF0sIGF0dHJpYnV0ZU5hbWUgPSBfcmVmMlsxXTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsiY29udGVudEVkaXRhYmxlIiwgImRyYWdnYWJsZSIsICJzcGVsbENoZWNrIiwgInZhbHVlIl0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTklTSF9TVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWyJhdXRvUmV2ZXJzZSIsICJleHRlcm5hbFJlc291cmNlc1JlcXVpcmVkIiwgImZvY3VzYWJsZSIsICJwcmVzZXJ2ZUFscGhhIl0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTklTSF9TVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJhbGxvd0Z1bGxTY3JlZW4iLAogICAgICAgICAgImFzeW5jIiwKICAgICAgICAgIC8vIE5vdGU6IHRoZXJlIGlzIGEgc3BlY2lhbCBjYXNlIHRoYXQgcHJldmVudHMgaXQgZnJvbSBiZWluZyB3cml0dGVuIHRvIHRoZSBET00KICAgICAgICAgIC8vIG9uIHRoZSBjbGllbnQgc2lkZSBiZWNhdXNlIHRoZSBicm93c2VycyBhcmUgaW5jb25zaXN0ZW50LiBJbnN0ZWFkIHdlIGNhbGwgZm9jdXMoKS4KICAgICAgICAgICJhdXRvRm9jdXMiLAogICAgICAgICAgImF1dG9QbGF5IiwKICAgICAgICAgICJjb250cm9scyIsCiAgICAgICAgICAiZGVmYXVsdCIsCiAgICAgICAgICAiZGVmZXIiLAogICAgICAgICAgImRpc2FibGVkIiwKICAgICAgICAgICJkaXNhYmxlUGljdHVyZUluUGljdHVyZSIsCiAgICAgICAgICAiZGlzYWJsZVJlbW90ZVBsYXliYWNrIiwKICAgICAgICAgICJmb3JtTm9WYWxpZGF0ZSIsCiAgICAgICAgICAiaGlkZGVuIiwKICAgICAgICAgICJsb29wIiwKICAgICAgICAgICJub01vZHVsZSIsCiAgICAgICAgICAibm9WYWxpZGF0ZSIsCiAgICAgICAgICAib3BlbiIsCiAgICAgICAgICAicGxheXNJbmxpbmUiLAogICAgICAgICAgInJlYWRPbmx5IiwKICAgICAgICAgICJyZXF1aXJlZCIsCiAgICAgICAgICAicmV2ZXJzZWQiLAogICAgICAgICAgInNjb3BlZCIsCiAgICAgICAgICAic2VhbWxlc3MiLAogICAgICAgICAgLy8gTWljcm9kYXRhCiAgICAgICAgICAiaXRlbVNjb3BlIgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTiwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAiY2hlY2tlZCIsCiAgICAgICAgICAvLyBOb3RlOiBgb3B0aW9uLnNlbGVjdGVkYCBpcyBub3QgdXBkYXRlZCBpZiBgc2VsZWN0Lm11bHRpcGxlYCBpcwogICAgICAgICAgLy8gZGlzYWJsZWQgd2l0aCBgcmVtb3ZlQXR0cmlidXRlYC4gV2UgaGF2ZSBzcGVjaWFsIGxvZ2ljIGZvciBoYW5kbGluZyB0aGlzLgogICAgICAgICAgIm11bHRpcGxlIiwKICAgICAgICAgICJtdXRlZCIsCiAgICAgICAgICAic2VsZWN0ZWQiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIEJPT0xFQU4sCiAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImNhcHR1cmUiLAogICAgICAgICAgImRvd25sb2FkIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBPVkVSTE9BREVEX0JPT0xFQU4sCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJjb2xzIiwKICAgICAgICAgICJyb3dzIiwKICAgICAgICAgICJzaXplIiwKICAgICAgICAgICJzcGFuIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBQT1NJVElWRV9OVU1FUklDLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbInJvd1NwYW4iLCAic3RhcnQiXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBOVU1FUklDLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIHZhciBDQU1FTElaRSA9IC9bXC1cOl0oW2Etel0pL2c7CiAgICAgICAgdmFyIGNhcGl0YWxpemUgPSBmdW5jdGlvbih0b2tlbikgewogICAgICAgICAgcmV0dXJuIHRva2VuWzFdLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgfTsKICAgICAgICBbCiAgICAgICAgICAiYWNjZW50LWhlaWdodCIsCiAgICAgICAgICAiYWxpZ25tZW50LWJhc2VsaW5lIiwKICAgICAgICAgICJhcmFiaWMtZm9ybSIsCiAgICAgICAgICAiYmFzZWxpbmUtc2hpZnQiLAogICAgICAgICAgImNhcC1oZWlnaHQiLAogICAgICAgICAgImNsaXAtcGF0aCIsCiAgICAgICAgICAiY2xpcC1ydWxlIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uLWZpbHRlcnMiLAogICAgICAgICAgImNvbG9yLXByb2ZpbGUiLAogICAgICAgICAgImNvbG9yLXJlbmRlcmluZyIsCiAgICAgICAgICAiZG9taW5hbnQtYmFzZWxpbmUiLAogICAgICAgICAgImVuYWJsZS1iYWNrZ3JvdW5kIiwKICAgICAgICAgICJmaWxsLW9wYWNpdHkiLAogICAgICAgICAgImZpbGwtcnVsZSIsCiAgICAgICAgICAiZmxvb2QtY29sb3IiLAogICAgICAgICAgImZsb29kLW9wYWNpdHkiLAogICAgICAgICAgImZvbnQtZmFtaWx5IiwKICAgICAgICAgICJmb250LXNpemUiLAogICAgICAgICAgImZvbnQtc2l6ZS1hZGp1c3QiLAogICAgICAgICAgImZvbnQtc3RyZXRjaCIsCiAgICAgICAgICAiZm9udC1zdHlsZSIsCiAgICAgICAgICAiZm9udC12YXJpYW50IiwKICAgICAgICAgICJmb250LXdlaWdodCIsCiAgICAgICAgICAiZ2x5cGgtbmFtZSIsCiAgICAgICAgICAiZ2x5cGgtb3JpZW50YXRpb24taG9yaXpvbnRhbCIsCiAgICAgICAgICAiZ2x5cGgtb3JpZW50YXRpb24tdmVydGljYWwiLAogICAgICAgICAgImhvcml6LWFkdi14IiwKICAgICAgICAgICJob3Jpei1vcmlnaW4teCIsCiAgICAgICAgICAiaW1hZ2UtcmVuZGVyaW5nIiwKICAgICAgICAgICJsZXR0ZXItc3BhY2luZyIsCiAgICAgICAgICAibGlnaHRpbmctY29sb3IiLAogICAgICAgICAgIm1hcmtlci1lbmQiLAogICAgICAgICAgIm1hcmtlci1taWQiLAogICAgICAgICAgIm1hcmtlci1zdGFydCIsCiAgICAgICAgICAib3ZlcmxpbmUtcG9zaXRpb24iLAogICAgICAgICAgIm92ZXJsaW5lLXRoaWNrbmVzcyIsCiAgICAgICAgICAicGFpbnQtb3JkZXIiLAogICAgICAgICAgInBhbm9zZS0xIiwKICAgICAgICAgICJwb2ludGVyLWV2ZW50cyIsCiAgICAgICAgICAicmVuZGVyaW5nLWludGVudCIsCiAgICAgICAgICAic2hhcGUtcmVuZGVyaW5nIiwKICAgICAgICAgICJzdG9wLWNvbG9yIiwKICAgICAgICAgICJzdG9wLW9wYWNpdHkiLAogICAgICAgICAgInN0cmlrZXRocm91Z2gtcG9zaXRpb24iLAogICAgICAgICAgInN0cmlrZXRocm91Z2gtdGhpY2tuZXNzIiwKICAgICAgICAgICJzdHJva2UtZGFzaGFycmF5IiwKICAgICAgICAgICJzdHJva2UtZGFzaG9mZnNldCIsCiAgICAgICAgICAic3Ryb2tlLWxpbmVjYXAiLAogICAgICAgICAgInN0cm9rZS1saW5lam9pbiIsCiAgICAgICAgICAic3Ryb2tlLW1pdGVybGltaXQiLAogICAgICAgICAgInN0cm9rZS1vcGFjaXR5IiwKICAgICAgICAgICJzdHJva2Utd2lkdGgiLAogICAgICAgICAgInRleHQtYW5jaG9yIiwKICAgICAgICAgICJ0ZXh0LWRlY29yYXRpb24iLAogICAgICAgICAgInRleHQtcmVuZGVyaW5nIiwKICAgICAgICAgICJ1bmRlcmxpbmUtcG9zaXRpb24iLAogICAgICAgICAgInVuZGVybGluZS10aGlja25lc3MiLAogICAgICAgICAgInVuaWNvZGUtYmlkaSIsCiAgICAgICAgICAidW5pY29kZS1yYW5nZSIsCiAgICAgICAgICAidW5pdHMtcGVyLWVtIiwKICAgICAgICAgICJ2LWFscGhhYmV0aWMiLAogICAgICAgICAgInYtaGFuZ2luZyIsCiAgICAgICAgICAidi1pZGVvZ3JhcGhpYyIsCiAgICAgICAgICAidi1tYXRoZW1hdGljYWwiLAogICAgICAgICAgInZlY3Rvci1lZmZlY3QiLAogICAgICAgICAgInZlcnQtYWR2LXkiLAogICAgICAgICAgInZlcnQtb3JpZ2luLXgiLAogICAgICAgICAgInZlcnQtb3JpZ2luLXkiLAogICAgICAgICAgIndvcmQtc3BhY2luZyIsCiAgICAgICAgICAid3JpdGluZy1tb2RlIiwKICAgICAgICAgICJ4bWxuczp4bGluayIsCiAgICAgICAgICAieC1oZWlnaHQiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoQ0FNRUxJWkUsIGNhcGl0YWxpemUpOwogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJ4bGluazphY3R1YXRlIiwKICAgICAgICAgICJ4bGluazphcmNyb2xlIiwKICAgICAgICAgICJ4bGluazpyb2xlIiwKICAgICAgICAgICJ4bGluazpzaG93IiwKICAgICAgICAgICJ4bGluazp0aXRsZSIsCiAgICAgICAgICAieGxpbms6dHlwZSIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZU5hbWUucmVwbGFjZShDQU1FTElaRSwgY2FwaXRhbGl6ZSk7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJ4bWw6YmFzZSIsCiAgICAgICAgICAieG1sOmxhbmciLAogICAgICAgICAgInhtbDpzcGFjZSIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZU5hbWUucmVwbGFjZShDQU1FTElaRSwgY2FwaXRhbGl6ZSk7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgICJodHRwOi8vd3d3LnczLm9yZy9YTUwvMTk5OC9uYW1lc3BhY2UiLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWyJ0YWJJbmRleCIsICJjcm9zc09yaWdpbiJdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1thdHRyaWJ1dGVOYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgeGxpbmtIcmVmID0gInhsaW5rSHJlZiI7CiAgICAgICAgcHJvcGVydGllc1t4bGlua0hyZWZdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICJ4bGlua0hyZWYiLAogICAgICAgICAgU1RSSU5HLAogICAgICAgICAgZmFsc2UsCiAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICJ4bGluazpocmVmIiwKICAgICAgICAgICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiwKICAgICAgICAgIHRydWUsCiAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIFsic3JjIiwgImhyZWYiLCAiYWN0aW9uIiwgImZvcm1BY3Rpb24iXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbYXR0cmlidXRlTmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICB0cnVlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICB0cnVlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIHZhciBpc0phdmFTY3JpcHRQcm90b2NvbCA9IC9eW1x1MDAwMC1cdTAwMUYgXSpqW1xyXG5cdF0qYVtcclxuXHRdKnZbXHJcblx0XSphW1xyXG5cdF0qc1tcclxuXHRdKmNbXHJcblx0XSpyW1xyXG5cdF0qaVtcclxuXHRdKnBbXHJcblx0XSp0W1xyXG5cdF0qXDovaTsKICAgICAgICB2YXIgZGlkV2FybiA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHNhbml0aXplVVJMKHVybCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm4gJiYgaXNKYXZhU2NyaXB0UHJvdG9jb2wudGVzdCh1cmwpKSB7CiAgICAgICAgICAgICAgZGlkV2FybiA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoIkEgZnV0dXJlIHZlcnNpb24gb2YgUmVhY3Qgd2lsbCBibG9jayBqYXZhc2NyaXB0OiBVUkxzIGFzIGEgc2VjdXJpdHkgcHJlY2F1dGlvbi4gVXNlIGV2ZW50IGhhbmRsZXJzIGluc3RlYWQgaWYgeW91IGNhbi4gSWYgeW91IG5lZWQgdG8gZ2VuZXJhdGUgdW5zYWZlIEhUTUwgdHJ5IHVzaW5nIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIGluc3RlYWQuIFJlYWN0IHdhcyBwYXNzZWQgJXMuIiwgSlNPTi5zdHJpbmdpZnkodXJsKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmFsdWVGb3JQcm9wZXJ0eShub2RlLCBuYW1lLCBleHBlY3RlZCwgcHJvcGVydHlJbmZvKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8ubXVzdFVzZVByb3BlcnR5KSB7CiAgICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IHByb3BlcnR5SW5mby5wcm9wZXJ0eU5hbWU7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGVbcHJvcGVydHlOYW1lXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKGV4cGVjdGVkLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby5zYW5pdGl6ZVVSTCkgewogICAgICAgICAgICAgICAgc2FuaXRpemVVUkwoIiIgKyBleHBlY3RlZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVOYW1lID0gcHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWU7CiAgICAgICAgICAgICAgdmFyIHN0cmluZ1ZhbHVlID0gbnVsbDsKICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnR5cGUgPT09IE9WRVJMT0FERURfQk9PTEVBTikgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCBleHBlY3RlZCwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnR5cGUgPT09IEJPT0xFQU4pIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RyaW5nVmFsdWUgPSBub2RlLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCBleHBlY3RlZCwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmdWYWx1ZSA9PT0gbnVsbCA/IGV4cGVjdGVkIDogc3RyaW5nVmFsdWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJpbmdWYWx1ZSA9PT0gIiIgKyBleHBlY3RlZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RyaW5nVmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFZhbHVlRm9yQXR0cmlidXRlKG5vZGUsIG5hbWUsIGV4cGVjdGVkLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzQXR0cmlidXRlTmFtZVNhZmUobmFtZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFub2RlLmhhc0F0dHJpYnV0ZShuYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdmFsdWUgPSBub2RlLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24oZXhwZWN0ZWQsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gIiIgKyBleHBlY3RlZCkgewogICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgbmFtZSwgdmFsdWUsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICB2YXIgcHJvcGVydHlJbmZvID0gZ2V0UHJvcGVydHlJbmZvKG5hbWUpOwogICAgICAgICAgaWYgKHNob3VsZElnbm9yZUF0dHJpYnV0ZShuYW1lLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSkgewogICAgICAgICAgICB2YWx1ZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcgfHwgcHJvcGVydHlJbmZvID09PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChpc0F0dHJpYnV0ZU5hbWVTYWZlKG5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIF9hdHRyaWJ1dGVOYW1lID0gbmFtZTsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKF9hdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBuYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKF9hdHRyaWJ1dGVOYW1lLCAiIiArIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG11c3RVc2VQcm9wZXJ0eSA9IHByb3BlcnR5SW5mby5tdXN0VXNlUHJvcGVydHk7CiAgICAgICAgICBpZiAobXVzdFVzZVByb3BlcnR5KSB7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eUluZm8ucHJvcGVydHlOYW1lOwogICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgdHlwZSA9IHByb3BlcnR5SW5mby50eXBlOwogICAgICAgICAgICAgIG5vZGVbcHJvcGVydHlOYW1lXSA9IHR5cGUgPT09IEJPT0xFQU4gPyBmYWxzZSA6ICIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5vZGVbcHJvcGVydHlOYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhdHRyaWJ1dGVOYW1lID0gcHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZU5hbWVzcGFjZSA9IHByb3BlcnR5SW5mby5hdHRyaWJ1dGVOYW1lc3BhY2U7CiAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX3R5cGUgPSBwcm9wZXJ0eUluZm8udHlwZTsKICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZVZhbHVlOwogICAgICAgICAgICBpZiAoX3R5cGUgPT09IEJPT0xFQU4gfHwgX3R5cGUgPT09IE9WRVJMT0FERURfQk9PTEVBTiAmJiB2YWx1ZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIGF0dHJpYnV0ZVZhbHVlID0gIiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGF0dHJpYnV0ZVZhbHVlID0gIiIgKyB2YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby5zYW5pdGl6ZVVSTCkgewogICAgICAgICAgICAgICAgc2FuaXRpemVVUkwoYXR0cmlidXRlVmFsdWUudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVOYW1lc3BhY2UpIHsKICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZU5TKGF0dHJpYnV0ZU5hbWVzcGFjZSwgYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZVZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZWxlbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9QT1JUQUxfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnBvcnRhbCIpOwogICAgICAgIHZhciBSRUFDVF9GUkFHTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZnJhZ21lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfU1RSSUNUX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN0cmljdF9tb2RlIik7CiAgICAgICAgdmFyIFJFQUNUX1BST0ZJTEVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm9maWxlciIpOwogICAgICAgIHZhciBSRUFDVF9QUk9WSURFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvdmlkZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfQ09OVEVYVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY29udGV4dCIpOwogICAgICAgIHZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0LmZvcndhcmRfcmVmIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZSIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZV9saXN0Iik7CiAgICAgICAgdmFyIFJFQUNUX01FTU9fVFlQRTIgPSBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CiAgICAgICAgdmFyIFJFQUNUX0xBWllfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmxhenkiKTsKICAgICAgICB2YXIgUkVBQ1RfU0NPUEVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnNjb3BlIik7CiAgICAgICAgdmFyIFJFQUNUX0RFQlVHX1RSQUNJTkdfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZGVidWdfdHJhY2VfbW9kZSIpOwogICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgIHZhciBSRUFDVF9MRUdBQ1lfSElEREVOX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sZWdhY3lfaGlkZGVuIik7CiAgICAgICAgdmFyIFJFQUNUX0NBQ0hFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jYWNoZSIpOwogICAgICAgIHZhciBSRUFDVF9UUkFDSU5HX01BUktFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QudHJhY2luZ19tYXJrZXIiKTsKICAgICAgICB2YXIgTUFZQkVfSVRFUkFUT1JfU1lNQk9MID0gU3ltYm9sLml0ZXJhdG9yOwogICAgICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICJAQGl0ZXJhdG9yIjsKICAgICAgICBmdW5jdGlvbiBnZXRJdGVyYXRvckZuKG1heWJlSXRlcmFibGUpIHsKICAgICAgICAgIGlmIChtYXliZUl0ZXJhYmxlID09PSBudWxsIHx8IHR5cGVvZiBtYXliZUl0ZXJhYmxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXliZUl0ZXJhdG9yID0gTUFZQkVfSVRFUkFUT1JfU1lNQk9MICYmIG1heWJlSXRlcmFibGVbTUFZQkVfSVRFUkFUT1JfU1lNQk9MXSB8fCBtYXliZUl0ZXJhYmxlW0ZBVVhfSVRFUkFUT1JfU1lNQk9MXTsKICAgICAgICAgIGlmICh0eXBlb2YgbWF5YmVJdGVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gbWF5YmVJdGVyYXRvcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgYXNzaWduMiA9IE9iamVjdC5hc3NpZ247CiAgICAgICAgdmFyIGRpc2FibGVkRGVwdGggPSAwOwogICAgICAgIHZhciBwcmV2TG9nOwogICAgICAgIHZhciBwcmV2SW5mbzsKICAgICAgICB2YXIgcHJldldhcm47CiAgICAgICAgdmFyIHByZXZFcnJvcjsKICAgICAgICB2YXIgcHJldkdyb3VwOwogICAgICAgIHZhciBwcmV2R3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgdmFyIHByZXZHcm91cEVuZDsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlZExvZygpIHsKICAgICAgICB9CiAgICAgICAgZGlzYWJsZWRMb2cuX19yZWFjdERpc2FibGVkTG9nID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICBwcmV2TG9nID0gY29uc29sZS5sb2c7CiAgICAgICAgICAgICAgcHJldkluZm8gPSBjb25zb2xlLmluZm87CiAgICAgICAgICAgICAgcHJldldhcm4gPSBjb25zb2xlLndhcm47CiAgICAgICAgICAgICAgcHJldkVycm9yID0gY29uc29sZS5lcnJvcjsKICAgICAgICAgICAgICBwcmV2R3JvdXAgPSBjb25zb2xlLmdyb3VwOwogICAgICAgICAgICAgIHByZXZHcm91cENvbGxhcHNlZCA9IGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgICAgICAgcHJldkdyb3VwRW5kID0gY29uc29sZS5ncm91cEVuZDsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IGRpc2FibGVkTG9nLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGluZm86IHByb3BzLAogICAgICAgICAgICAgICAgbG9nOiBwcm9wcywKICAgICAgICAgICAgICAgIHdhcm46IHByb3BzLAogICAgICAgICAgICAgICAgZXJyb3I6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXA6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IHByb3BzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlzYWJsZWREZXB0aCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVuYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgtLTsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGxvZzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHdhcm46IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2V2FybgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBlcnJvcjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cENvbGxhcHNlZAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cEVuZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICB2YXIgcHJlZml4OwogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0geDIuc3RhY2sudHJpbSgpLm1hdGNoKC9cbiggKihhdCApPykvKTsKICAgICAgICAgICAgICAgIHByZWZpeCA9IG1hdGNoICYmIG1hdGNoWzFdIHx8ICIiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIlxuIiArIHByZWZpeCArIG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbXBvbmVudEZyYW1lQ2FjaGU7CiAgICAgICAgewogICAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCA9IHR5cGVvZiBXZWFrTWFwID09PSAiZnVuY3Rpb24iID8gV2Vha01hcCA6IE1hcDsKICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGNvbnN0cnVjdCkgewogICAgICAgICAgaWYgKCFmbiB8fCByZWVudHJ5KSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZyYW1lID0gY29tcG9uZW50RnJhbWVDYWNoZS5nZXQoZm4pOwogICAgICAgICAgICBpZiAoZnJhbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiBmcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRyb2w7CiAgICAgICAgICByZWVudHJ5ID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlID0gRXJyb3IucHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHZvaWQgMDsKICAgICAgICAgIHZhciBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByZXZpb3VzRGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudDsKICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgZGlzYWJsZUxvZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChjb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICB2YXIgRmFrZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShGYWtlLnByb3RvdHlwZSwgInByb3BzIiwgewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09ICJvYmplY3QiICYmIFJlZmxlY3QuY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChGYWtlLCBbXSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChmbiwgW10sIEZha2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBGYWtlLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChzYW1wbGUpIHsKICAgICAgICAgICAgaWYgKHNhbXBsZSAmJiBjb250cm9sICYmIHR5cGVvZiBzYW1wbGUuc3RhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgdmFyIHNhbXBsZUxpbmVzID0gc2FtcGxlLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBjb250cm9sTGluZXMgPSBjb250cm9sLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBzID0gc2FtcGxlTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB2YXIgYyA9IGNvbnRyb2xMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHdoaWxlIChzID49IDEgJiYgYyA+PSAwICYmIHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICg7IHMgPj0gMSAmJiBjID49IDA7IHMtLSwgYy0tKSB7CiAgICAgICAgICAgICAgICBpZiAoc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICBpZiAocyAhPT0gMSB8fCBjICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgcy0tOwogICAgICAgICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGMgPCAwIHx8IHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9mcmFtZSA9ICJcbiIgKyBzYW1wbGVMaW5lc1tzXS5yZXBsYWNlKCIgYXQgbmV3ICIsICIgYXQgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbi5kaXNwbGF5TmFtZSAmJiBfZnJhbWUuaW5jbHVkZXMoIjxhbm9ueW1vdXM+IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBfZnJhbWUgPSBfZnJhbWUucmVwbGFjZSgiPGFub255bW91cz4iLCBmbi5kaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBfZnJhbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2ZyYW1lOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKHMgPj0gMSAmJiBjID49IDApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50ID0gcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgICAgIHJlZW5hYmxlTG9ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lID0gZm4gPyBmbi5kaXNwbGF5TmFtZSB8fCBmbi5uYW1lIDogIiI7CiAgICAgICAgICB2YXIgc3ludGhldGljRnJhbWUgPSBuYW1lID8gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSkgOiAiIjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBzeW50aGV0aWNGcmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzeW50aGV0aWNGcmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVDbGFzc0NvbXBvbmVudEZyYW1lKGN0b3IsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShjdG9yLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZuLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0KENvbXBvbmVudCkgewogICAgICAgICAgdmFyIHByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgICByZXR1cm4gISEocHJvdG90eXBlICYmIHByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKHR5cGUsIHNob3VsZENvbnN0cnVjdCh0eXBlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKHR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGaWJlcihmaWJlcikgewogICAgICAgICAgdmFyIG93bmVyID0gZmliZXIuX2RlYnVnT3duZXIgPyBmaWJlci5fZGVidWdPd25lci50eXBlIDogbnVsbDsKICAgICAgICAgIHZhciBzb3VyY2UgPSBmaWJlci5fZGVidWdTb3VyY2U7CiAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUpOwogICAgICAgICAgICBjYXNlIExhenlDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJMYXp5Iik7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlTGlzdCIpOwogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUpOwogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZS5yZW5kZXIpOwogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUNsYXNzQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdGFja0J5RmliZXJJbkRldkFuZFByb2Qod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICB2YXIgbm9kZSA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGluZm8gKz0gZGVzY3JpYmVGaWJlcihub2RlKTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0gd2hpbGUgKG5vZGUpOwogICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgIHJldHVybiAiXG5FcnJvciBnZW5lcmF0aW5nIHN0YWNrOiAiICsgeDIubWVzc2FnZSArICJcbiIgKyB4Mi5zdGFjazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUob3V0ZXJUeXBlLCBpbm5lclR5cGUsIHdyYXBwZXJOYW1lKSB7CiAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSBvdXRlclR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICBpZiAoZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlLnRhZyA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgYW4gdW5leHBlY3RlZCBvYmplY3QgaW4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKCkuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQb3J0YWwiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQcm9maWxlciI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN0cmljdE1vZGUiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2VMaXN0IjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05URVhUX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUoY29udGV4dCkgKyAiLkNvbnN1bWVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZSQxKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBvdXRlclR5cGUuZGlzcGxheU5hbWUgfHwgKGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUkMSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciB0YWcgPSBmaWJlci50YWcsIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIkNhY2hlIjsKICAgICAgICAgICAgY2FzZSBDb250ZXh0Q29uc3VtZXI6CiAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0eXBlOwogICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZSQxKGNvbnRleHQpICsgIi5Db25zdW1lciI7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lJDEocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgIGNhc2UgRGVoeWRyYXRlZEZyYWdtZW50OgogICAgICAgICAgICAgIHJldHVybiAiRGVoeWRyYXRlZEZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUkMSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgY2FzZSBGcmFnbWVudDk6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICByZXR1cm4gIlJvb3QiOwogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHJldHVybiAiVGV4dCI7CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiAiTW9kZSI7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiAiT2Zmc2NyZWVuIjsKICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlNjb3BlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJUcmFjaW5nTWFya2VyIjsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICB2YXIgY3VycmVudDMgPSBudWxsOwogICAgICAgIHZhciBpc1JlbmRlcmluZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb3duZXIgPSBjdXJyZW50My5fZGVidWdPd25lcjsKICAgICAgICAgICAgaWYgKG93bmVyICE9PSBudWxsICYmIHR5cGVvZiBvd25lciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXJTdGFja0luRGV2KCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGdldFN0YWNrQnlGaWJlckluRGV2QW5kUHJvZChjdXJyZW50Myk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0Q3VycmVudEZpYmVyKCkgewogICAgICAgICAgewogICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnQzID0gbnVsbDsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrID0gZmliZXIgPT09IG51bGwgPyBudWxsIDogZ2V0Q3VycmVudEZpYmVyU3RhY2tJbkRldjsKICAgICAgICAgICAgY3VycmVudDMgPSBmaWJlcjsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gY3VycmVudDM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldElzUmVuZGVyaW5nKHJlbmRlcmluZykgewogICAgICAgICAgewogICAgICAgICAgICBpc1JlbmRlcmluZyA9IHJlbmRlcmluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG9TdHJpbmcodmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUb1N0cmluZ1ZhbHVlKHZhbHVlKSB7CiAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgICAgICBjYXNlICJib29sZWFuIjoKICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGhhc1JlYWRPbmx5VmFsdWUgPSB7CiAgICAgICAgICBidXR0b246IHRydWUsCiAgICAgICAgICBjaGVja2JveDogdHJ1ZSwKICAgICAgICAgIGltYWdlOiB0cnVlLAogICAgICAgICAgaGlkZGVuOiB0cnVlLAogICAgICAgICAgcmFkaW86IHRydWUsCiAgICAgICAgICByZXNldDogdHJ1ZSwKICAgICAgICAgIHN1Ym1pdDogdHJ1ZQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY2hlY2tDb250cm9sbGVkVmFsdWVQcm9wcyh0YWdOYW1lLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIShoYXNSZWFkT25seVZhbHVlW3Byb3BzLnR5cGVdIHx8IHByb3BzLm9uQ2hhbmdlIHx8IHByb3BzLm9uSW5wdXQgfHwgcHJvcHMucmVhZE9ubHkgfHwgcHJvcHMuZGlzYWJsZWQgfHwgcHJvcHMudmFsdWUgPT0gbnVsbCkpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHByb3ZpZGVkIGEgYHZhbHVlYCBwcm9wIHRvIGEgZm9ybSBmaWVsZCB3aXRob3V0IGFuIGBvbkNoYW5nZWAgaGFuZGxlci4gVGhpcyB3aWxsIHJlbmRlciBhIHJlYWQtb25seSBmaWVsZC4gSWYgdGhlIGZpZWxkIHNob3VsZCBiZSBtdXRhYmxlIHVzZSBgZGVmYXVsdFZhbHVlYC4gT3RoZXJ3aXNlLCBzZXQgZWl0aGVyIGBvbkNoYW5nZWAgb3IgYHJlYWRPbmx5YC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIShwcm9wcy5vbkNoYW5nZSB8fCBwcm9wcy5yZWFkT25seSB8fCBwcm9wcy5kaXNhYmxlZCB8fCBwcm9wcy5jaGVja2VkID09IG51bGwpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwcm92aWRlZCBhIGBjaGVja2VkYCBwcm9wIHRvIGEgZm9ybSBmaWVsZCB3aXRob3V0IGFuIGBvbkNoYW5nZWAgaGFuZGxlci4gVGhpcyB3aWxsIHJlbmRlciBhIHJlYWQtb25seSBmaWVsZC4gSWYgdGhlIGZpZWxkIHNob3VsZCBiZSBtdXRhYmxlIHVzZSBgZGVmYXVsdENoZWNrZWRgLiBPdGhlcndpc2UsIHNldCBlaXRoZXIgYG9uQ2hhbmdlYCBvciBgcmVhZE9ubHlgLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ2hlY2thYmxlKGVsZW0pIHsKICAgICAgICAgIHZhciB0eXBlID0gZWxlbS50eXBlOwogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZSAmJiBub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmICh0eXBlID09PSAiY2hlY2tib3giIHx8IHR5cGUgPT09ICJyYWRpbyIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUcmFja2VyKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlLl92YWx1ZVRyYWNrZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaFRyYWNrZXIobm9kZSkgewogICAgICAgICAgbm9kZS5fdmFsdWVUcmFja2VyID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmFsdWVGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSAiIjsKICAgICAgICAgIGlmICghbm9kZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDaGVja2FibGUobm9kZSkpIHsKICAgICAgICAgICAgdmFsdWUgPSBub2RlLmNoZWNrZWQgPyAidHJ1ZSIgOiAiZmFsc2UiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUgPSBub2RlLnZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFja1ZhbHVlT25Ob2RlKG5vZGUpIHsKICAgICAgICAgIHZhciB2YWx1ZUZpZWxkID0gaXNDaGVja2FibGUobm9kZSkgPyAiY2hlY2tlZCIgOiAidmFsdWUiOwogICAgICAgICAgdmFyIGRlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG5vZGUuY29uc3RydWN0b3IucHJvdG90eXBlLCB2YWx1ZUZpZWxkKTsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKG5vZGVbdmFsdWVGaWVsZF0pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9ICIiICsgbm9kZVt2YWx1ZUZpZWxkXTsKICAgICAgICAgIGlmIChub2RlLmhhc093blByb3BlcnR5KHZhbHVlRmllbGQpIHx8IHR5cGVvZiBkZXNjcmlwdG9yID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgZGVzY3JpcHRvci5nZXQgIT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGRlc2NyaXB0b3Iuc2V0ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBnZXQ3ID0gZGVzY3JpcHRvci5nZXQsIHNldDQgPSBkZXNjcmlwdG9yLnNldDsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShub2RlLCB2YWx1ZUZpZWxkLCB7CiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Ny5jYWxsKHRoaXMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudFZhbHVlID0gIiIgKyB2YWx1ZTsKICAgICAgICAgICAgICBzZXQ0LmNhbGwodGhpcywgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShub2RlLCB2YWx1ZUZpZWxkLCB7CiAgICAgICAgICAgIGVudW1lcmFibGU6IGRlc2NyaXB0b3IuZW51bWVyYWJsZQogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgdHJhY2tlciA9IHsKICAgICAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VmFsdWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9ICIiICsgdmFsdWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0b3BUcmFja2luZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZGV0YWNoVHJhY2tlcihub2RlKTsKICAgICAgICAgICAgICBkZWxldGUgbm9kZVt2YWx1ZUZpZWxkXTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB0cmFja2VyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFjayhub2RlKSB7CiAgICAgICAgICBpZiAoZ2V0VHJhY2tlcihub2RlKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl92YWx1ZVRyYWNrZXIgPSB0cmFja1ZhbHVlT25Ob2RlKG5vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVWYWx1ZUlmQ2hhbmdlZChub2RlKSB7CiAgICAgICAgICBpZiAoIW5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRyYWNrZXIgPSBnZXRUcmFja2VyKG5vZGUpOwogICAgICAgICAgaWYgKCF0cmFja2VyKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhc3RWYWx1ZSA9IHRyYWNrZXIuZ2V0VmFsdWUoKTsKICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBnZXRWYWx1ZUZyb21Ob2RlKG5vZGUpOwogICAgICAgICAgaWYgKG5leHRWYWx1ZSAhPT0gbGFzdFZhbHVlKSB7CiAgICAgICAgICAgIHRyYWNrZXIuc2V0VmFsdWUobmV4dFZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEFjdGl2ZUVsZW1lbnQoZG9jKSB7CiAgICAgICAgICBkb2MgPSBkb2MgfHwgKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgPyBkb2N1bWVudCA6IHZvaWQgMCk7CiAgICAgICAgICBpZiAodHlwZW9mIGRvYyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZG9jLmFjdGl2ZUVsZW1lbnQgfHwgZG9jLmJvZHk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBkb2MuYm9keTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5WYWx1ZURlZmF1bHRWYWx1ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5Db250cm9sbGVkVG9VbmNvbnRyb2xsZWQgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGlzQ29udHJvbGxlZChwcm9wcykgewogICAgICAgICAgdmFyIHVzZXNDaGVja2VkID0gcHJvcHMudHlwZSA9PT0gImNoZWNrYm94IiB8fCBwcm9wcy50eXBlID09PSAicmFkaW8iOwogICAgICAgICAgcmV0dXJuIHVzZXNDaGVja2VkID8gcHJvcHMuY2hlY2tlZCAhPSBudWxsIDogcHJvcHMudmFsdWUgIT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFByb3BzKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgY2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CiAgICAgICAgICB2YXIgaG9zdFByb3BzID0gYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgZGVmYXVsdENoZWNrZWQ6IHZvaWQgMCwKICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGNoZWNrZWQ6IGNoZWNrZWQgIT0gbnVsbCA/IGNoZWNrZWQgOiBub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbENoZWNrZWQKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NvbnRyb2xsZWRWYWx1ZVByb3BzKCJpbnB1dCIsIHByb3BzKTsKICAgICAgICAgICAgaWYgKHByb3BzLmNoZWNrZWQgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0Q2hlY2tlZCAhPT0gdm9pZCAwICYmICFkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIGNoZWNrZWQgYW5kIGRlZmF1bHRDaGVja2VkIHByb3BzLiBJbnB1dCBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIGNoZWNrZWQgcHJvcCwgb3IgdGhlIGRlZmF1bHRDaGVja2VkIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgaW5wdXQgZWxlbWVudCBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIiwgZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB8fCAiQSBjb21wb25lbnQiLCBwcm9wcy50eXBlKTsKICAgICAgICAgICAgICBkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIHZhbHVlIGFuZCBkZWZhdWx0VmFsdWUgcHJvcHMuIElucHV0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgdmFsdWUgcHJvcCwgb3IgdGhlIGRlZmF1bHRWYWx1ZSBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIGlucHV0IGVsZW1lbnQgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50IiwgcHJvcHMudHlwZSk7CiAgICAgICAgICAgICAgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZSA9PSBudWxsID8gIiIgOiBwcm9wcy5kZWZhdWx0VmFsdWU7CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIGluaXRpYWxDaGVja2VkOiBwcm9wcy5jaGVja2VkICE9IG51bGwgPyBwcm9wcy5jaGVja2VkIDogcHJvcHMuZGVmYXVsdENoZWNrZWQsCiAgICAgICAgICAgIGluaXRpYWxWYWx1ZTogZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSAhPSBudWxsID8gcHJvcHMudmFsdWUgOiBkZWZhdWx0VmFsdWUpLAogICAgICAgICAgICBjb250cm9sbGVkOiBpc0NvbnRyb2xsZWQocHJvcHMpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDaGVja2VkKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgY2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CiAgICAgICAgICBpZiAoY2hlY2tlZCAhPSBudWxsKSB7CiAgICAgICAgICAgIHNldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgImNoZWNrZWQiLCBjaGVja2VkLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdyYXBwZXIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNvbnRyb2xsZWQgPSBpc0NvbnRyb2xsZWQocHJvcHMpOwogICAgICAgICAgICBpZiAoIW5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmIGNvbnRyb2xsZWQgJiYgIWRpZFdhcm5VbmNvbnRyb2xsZWRUb0NvbnRyb2xsZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb21wb25lbnQgaXMgY2hhbmdpbmcgYW4gdW5jb250cm9sbGVkIGlucHV0IHRvIGJlIGNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSB1bmRlZmluZWQgdG8gYSBkZWZpbmVkIHZhbHVlLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmICFjb250cm9sbGVkICYmICFkaWRXYXJuQ29udHJvbGxlZFRvVW5jb250cm9sbGVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGNoYW5naW5nIGEgY29udHJvbGxlZCBpbnB1dCB0byBiZSB1bmNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSBhIGRlZmluZWQgdG8gdW5kZWZpbmVkLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FybkNvbnRyb2xsZWRUb1VuY29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZUNoZWNrZWQoZWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgdmFyIHZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSk7CiAgICAgICAgICB2YXIgdHlwZSA9IHByb3BzLnR5cGU7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IDAgJiYgbm9kZS52YWx1ZSA9PT0gIiIgfHwgLy8gV2UgZXhwbGljaXRseSB3YW50IHRvIGNvZXJjZSB0byBudW1iZXIgaGVyZSBpZiBwb3NzaWJsZS4KICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUKICAgICAgICAgICAgICBub2RlLnZhbHVlICE9IHZhbHVlKSB7CiAgICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJzdWJtaXQiIHx8IHR5cGUgPT09ICJyZXNldCIpIHsKICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoInZhbHVlIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLmhhc093blByb3BlcnR5KCJ2YWx1ZSIpKSB7CiAgICAgICAgICAgICAgc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHByb3BzLnR5cGUsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgICBzZXREZWZhdWx0VmFsdWUobm9kZSwgcHJvcHMudHlwZSwgZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy5kZWZhdWx0VmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMuY2hlY2tlZCA9PSBudWxsICYmIHByb3BzLmRlZmF1bHRDaGVja2VkICE9IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRDaGVja2VkID0gISFwcm9wcy5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyKGVsZW1lbnQsIHByb3BzLCBpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgidmFsdWUiKSB8fCBwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBwcm9wcy50eXBlOwogICAgICAgICAgICB2YXIgaXNCdXR0b24gPSB0eXBlID09PSAic3VibWl0IiB8fCB0eXBlID09PSAicmVzZXQiOwogICAgICAgICAgICBpZiAoaXNCdXR0b24gJiYgKHByb3BzLnZhbHVlID09PSB2b2lkIDAgfHwgcHJvcHMudmFsdWUgPT09IG51bGwpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbml0aWFsVmFsdWUgPSB0b1N0cmluZyhub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlICE9PSBub2RlLnZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUudmFsdWUgPSBpbml0aWFsVmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IGluaXRpYWxWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBub2RlLm5hbWU7CiAgICAgICAgICBpZiAobmFtZSAhPT0gIiIpIHsKICAgICAgICAgICAgbm9kZS5uYW1lID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG5vZGUuZGVmYXVsdENoZWNrZWQgPSAhbm9kZS5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0Q2hlY2tlZCA9ICEhbm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxDaGVja2VkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWUgIT09ICIiKSB7CiAgICAgICAgICAgIG5vZGUubmFtZSA9IG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHVwZGF0ZVdyYXBwZXIobm9kZSwgcHJvcHMpOwogICAgICAgICAgdXBkYXRlTmFtZWRDb3VzaW5zKG5vZGUsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTmFtZWRDb3VzaW5zKHJvb3ROb2RlLCBwcm9wcykgewogICAgICAgICAgdmFyIG5hbWUgPSBwcm9wcy5uYW1lOwogICAgICAgICAgaWYgKHByb3BzLnR5cGUgPT09ICJyYWRpbyIgJiYgbmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciBxdWVyeVJvb3QgPSByb290Tm9kZTsKICAgICAgICAgICAgd2hpbGUgKHF1ZXJ5Um9vdC5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgcXVlcnlSb290ID0gcXVlcnlSb290LnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24obmFtZSwgIm5hbWUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZ3JvdXAgPSBxdWVyeVJvb3QucXVlcnlTZWxlY3RvckFsbCgiaW5wdXRbbmFtZT0iICsgSlNPTi5zdHJpbmdpZnkoIiIgKyBuYW1lKSArICddW3R5cGU9InJhZGlvIl0nKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBncm91cC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBvdGhlck5vZGUgPSBncm91cFtpXTsKICAgICAgICAgICAgICBpZiAob3RoZXJOb2RlID09PSByb290Tm9kZSB8fCBvdGhlck5vZGUuZm9ybSAhPT0gcm9vdE5vZGUuZm9ybSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBvdGhlclByb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShvdGhlck5vZGUpOwogICAgICAgICAgICAgIGlmICghb3RoZXJQcm9wcykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdERPTUlucHV0OiBNaXhpbmcgUmVhY3QgYW5kIG5vbi1SZWFjdCByYWRpbyBpbnB1dHMgd2l0aCB0aGUgc2FtZSBgbmFtZWAgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlVmFsdWVJZkNoYW5nZWQob3RoZXJOb2RlKTsKICAgICAgICAgICAgICB1cGRhdGVXcmFwcGVyKG90aGVyTm9kZSwgb3RoZXJQcm9wcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIEZvY3VzZWQgbnVtYmVyIGlucHV0cyBzeW5jaHJvbml6ZSBvbiBibHVyLiBTZWUgQ2hhbmdlRXZlbnRQbHVnaW4uanMKICAgICAgICAgICAgdHlwZSAhPT0gIm51bWJlciIgfHwgZ2V0QWN0aXZlRWxlbWVudChub2RlLm93bmVyRG9jdW1lbnQpICE9PSBub2RlCiAgICAgICAgICApIHsKICAgICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuZGVmYXVsdFZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkludmFsaWRDaGlsZCA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuSW52YWxpZElubmVySFRNTCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcHMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLnZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAib2JqZWN0IiAmJiBwcm9wcy5jaGlsZHJlbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgUmVhY3QzOS5DaGlsZHJlbi5mb3JFYWNoKHByb3BzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkID09PSAic3RyaW5nIiB8fCB0eXBlb2YgY2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkludmFsaWRDaGlsZCkgewogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgaW5mZXIgdGhlIG9wdGlvbiB2YWx1ZSBvZiBjb21wbGV4IGNoaWxkcmVuLiBQYXNzIGEgYHZhbHVlYCBwcm9wIG9yIHVzZSBhIHBsYWluIHN0cmluZyBhcyBjaGlsZHJlbiB0byA8b3B0aW9uPi4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5JbnZhbGlkSW5uZXJIVE1MKSB7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSW5uZXJIVE1MID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlBhc3MgYSBgdmFsdWVgIHByb3AgaWYgeW91IHNldCBkYW5nZXJvdXNseUlubmVySFRNTCBzbyBSZWFjdCBrbm93cyB3aGljaCB2YWx1ZSBzaG91bGQgYmUgc2VsZWN0ZWQuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcy5zZWxlY3RlZCAhPSBudWxsICYmICFkaWRXYXJuU2VsZWN0ZWRTZXRPbk9wdGlvbikgewogICAgICAgICAgICAgIGVycm9yKCJVc2UgdGhlIGBkZWZhdWx0VmFsdWVgIG9yIGB2YWx1ZWAgcHJvcHMgb24gPHNlbGVjdD4gaW5zdGVhZCBvZiBzZXR0aW5nIGBzZWxlY3RlZGAgb24gPG9wdGlvbj4uIik7CiAgICAgICAgICAgICAgZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvc3RNb3VudFdyYXBwZXIkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgaWYgKHByb3BzLnZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoInZhbHVlIiwgdG9TdHJpbmcoZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSkpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzQXJyYXlJbXBsID0gQXJyYXkuaXNBcnJheTsKICAgICAgICBmdW5jdGlvbiBpc0FycmF5MihhKSB7CiAgICAgICAgICByZXR1cm4gaXNBcnJheUltcGwoYSk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSB7CiAgICAgICAgICB2YXIgb3duZXJOYW1lID0gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKTsKICAgICAgICAgIGlmIChvd25lck5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBvd25lck5hbWUgKyAiYC4iOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgdmFsdWVQcm9wTmFtZXMgPSBbInZhbHVlIiwgImRlZmF1bHRWYWx1ZSJdOwogICAgICAgIGZ1bmN0aW9uIGNoZWNrU2VsZWN0UHJvcFR5cGVzKHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInNlbGVjdCIsIHByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YWx1ZVByb3BOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBwcm9wTmFtZSA9IHZhbHVlUHJvcE5hbWVzW2ldOwogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBwcm9wTmFtZUlzQXJyYXkgPSBpc0FycmF5Mihwcm9wc1twcm9wTmFtZV0pOwogICAgICAgICAgICAgIGlmIChwcm9wcy5tdWx0aXBsZSAmJiAhcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGFuIGFycmF5IGlmIGBtdWx0aXBsZWAgaXMgdHJ1ZS4lcyIsIHByb3BOYW1lLCBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghcHJvcHMubXVsdGlwbGUgJiYgcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGEgc2NhbGFyIHZhbHVlIGlmIGBtdWx0aXBsZWAgaXMgZmFsc2UuJXMiLCBwcm9wTmFtZSwgZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVPcHRpb25zMihub2RlLCBtdWx0aXBsZSwgcHJvcFZhbHVlLCBzZXREZWZhdWx0U2VsZWN0ZWQpIHsKICAgICAgICAgIHZhciBvcHRpb25zMiA9IG5vZGUub3B0aW9uczsKICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICB2YXIgc2VsZWN0ZWRWYWx1ZXMgPSBwcm9wVmFsdWU7CiAgICAgICAgICAgIHZhciBzZWxlY3RlZFZhbHVlID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VsZWN0ZWRWYWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBzZWxlY3RlZFZhbHVlWyIkIiArIHNlbGVjdGVkVmFsdWVzW2ldXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IG9wdGlvbnMyLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgIHZhciBzZWxlY3RlZCA9IHNlbGVjdGVkVmFsdWUuaGFzT3duUHJvcGVydHkoIiQiICsgb3B0aW9uczJbX2ldLnZhbHVlKTsKICAgICAgICAgICAgICBpZiAob3B0aW9uczJbX2ldLnNlbGVjdGVkICE9PSBzZWxlY3RlZCkgewogICAgICAgICAgICAgICAgb3B0aW9uczJbX2ldLnNlbGVjdGVkID0gc2VsZWN0ZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzZWxlY3RlZCAmJiBzZXREZWZhdWx0U2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pXS5kZWZhdWx0U2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIF9zZWxlY3RlZFZhbHVlID0gdG9TdHJpbmcoZ2V0VG9TdHJpbmdWYWx1ZShwcm9wVmFsdWUpKTsKICAgICAgICAgICAgdmFyIGRlZmF1bHRTZWxlY3RlZCA9IG51bGw7CiAgICAgICAgICAgIGZvciAodmFyIF9pMiA9IDA7IF9pMiA8IG9wdGlvbnMyLmxlbmd0aDsgX2kyKyspIHsKICAgICAgICAgICAgICBpZiAob3B0aW9uczJbX2kyXS52YWx1ZSA9PT0gX3NlbGVjdGVkVmFsdWUpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pMl0uc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHNldERlZmF1bHRTZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICBvcHRpb25zMltfaTJdLmRlZmF1bHRTZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkZWZhdWx0U2VsZWN0ZWQgPT09IG51bGwgJiYgIW9wdGlvbnMyW19pMl0uZGlzYWJsZWQpIHsKICAgICAgICAgICAgICAgIGRlZmF1bHRTZWxlY3RlZCA9IG9wdGlvbnMyW19pMl07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWZhdWx0U2VsZWN0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBkZWZhdWx0U2VsZWN0ZWQuc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICByZXR1cm4gYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgdmFsdWU6IHZvaWQgMAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRXcmFwcGVyU3RhdGUkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgewogICAgICAgICAgICBjaGVja1NlbGVjdFByb3BUeXBlcyhwcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIHdhc011bHRpcGxlOiAhIXByb3BzLm11bHRpcGxlCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDEpIHsKICAgICAgICAgICAgICBlcnJvcigiU2VsZWN0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgdmFsdWUgcHJvcCwgb3IgdGhlIGRlZmF1bHRWYWx1ZSBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIHNlbGVjdCBlbGVtZW50IGFuZCByZW1vdmUgb25lIG9mIHRoZXNlIHByb3BzLiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiKTsKICAgICAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdE1vdW50V3JhcHBlciQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICBub2RlLm11bHRpcGxlID0gISFwcm9wcy5tdWx0aXBsZTsKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgcHJvcHMuZGVmYXVsdFZhbHVlLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdFVwZGF0ZVdyYXBwZXIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB3YXNNdWx0aXBsZSA9IG5vZGUuX3dyYXBwZXJTdGF0ZS53YXNNdWx0aXBsZTsKICAgICAgICAgIG5vZGUuX3dyYXBwZXJTdGF0ZS53YXNNdWx0aXBsZSA9ICEhcHJvcHMubXVsdGlwbGU7CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHdhc011bHRpcGxlICE9PSAhIXByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgIGlmIChwcm9wcy5kZWZhdWx0VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHByb3BzLmRlZmF1bHRWYWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgcHJvcHMubXVsdGlwbGUgPyBbXSA6ICIiLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsRGVmYXVsdFZhbCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICBpZiAocHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImBkYW5nZXJvdXNseVNldElubmVySFRNTGAgZG9lcyBub3QgbWFrZSBzZW5zZSBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhvc3RQcm9wcyA9IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGRlZmF1bHRWYWx1ZTogdm9pZCAwLAogICAgICAgICAgICBjaGlsZHJlbjogdG9TdHJpbmcobm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSkKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZSQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInRleHRhcmVhIiwgcHJvcHMpOwogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbERlZmF1bHRWYWwpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgY29udGFpbnMgYSB0ZXh0YXJlYSB3aXRoIGJvdGggdmFsdWUgYW5kIGRlZmF1bHRWYWx1ZSBwcm9wcy4gVGV4dGFyZWEgZWxlbWVudHMgbXVzdCBiZSBlaXRoZXIgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgKHNwZWNpZnkgZWl0aGVyIHRoZSB2YWx1ZSBwcm9wLCBvciB0aGUgZGVmYXVsdFZhbHVlIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgdGV4dGFyZWEgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgZGlkV2FyblZhbERlZmF1bHRWYWwgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5pdGlhbFZhbHVlID0gcHJvcHMudmFsdWU7CiAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gcHJvcHMuY2hpbGRyZW4sIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgaWYgKGNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiVXNlIHRoZSBgZGVmYXVsdFZhbHVlYCBvciBgdmFsdWVgIHByb3BzIGluc3RlYWQgb2Ygc2V0dGluZyBjaGlsZHJlbiBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJZiB5b3Ugc3VwcGx5IGBkZWZhdWx0VmFsdWVgIG9uIGEgPHRleHRhcmVhPiwgZG8gbm90IHBhc3MgY2hpbGRyZW4uIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaXNBcnJheTIoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCI8dGV4dGFyZWE+IGNhbiBvbmx5IGhhdmUgYXQgbW9zdCBvbmUgY2hpbGQuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2hpbGRyZW4gPSBjaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlZmF1bHRWYWx1ZSA9IGNoaWxkcmVuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBkZWZhdWx0VmFsdWUgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbml0aWFsVmFsdWUgPSBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIGluaXRpYWxWYWx1ZTogZ2V0VG9TdHJpbmdWYWx1ZShpbml0aWFsVmFsdWUpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVXcmFwcGVyJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB2YWx1ZSA9IGdldFRvU3RyaW5nVmFsdWUocHJvcHMudmFsdWUpOwogICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IGdldFRvU3RyaW5nVmFsdWUocHJvcHMuZGVmYXVsdFZhbHVlKTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgaWYgKG5ld1ZhbHVlICE9PSBub2RlLnZhbHVlKSB7CiAgICAgICAgICAgICAgbm9kZS52YWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcy5kZWZhdWx0VmFsdWUgPT0gbnVsbCAmJiBub2RlLmRlZmF1bHRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0VmFsdWUgPSB0b1N0cmluZyhkZWZhdWx0VmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyJDMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB0ZXh0Q29udGVudCA9IG5vZGUudGV4dENvbnRlbnQ7CiAgICAgICAgICBpZiAodGV4dENvbnRlbnQgPT09IG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgaWYgKHRleHRDb250ZW50ICE9PSAiIiAmJiB0ZXh0Q29udGVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUudmFsdWUgPSB0ZXh0Q29udGVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHVwZGF0ZVdyYXBwZXIkMShlbGVtZW50LCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIHZhciBIVE1MX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIjsKICAgICAgICB2YXIgTUFUSF9OQU1FU1BBQ0UgPSAiaHR0cDovL3d3dy53My5vcmcvMTk5OC9NYXRoL01hdGhNTCI7CiAgICAgICAgdmFyIFNWR19OQU1FU1BBQ0UgPSAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciOwogICAgICAgIGZ1bmN0aW9uIGdldEludHJpbnNpY05hbWVzcGFjZSh0eXBlKSB7CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSAic3ZnIjoKICAgICAgICAgICAgICByZXR1cm4gU1ZHX05BTUVTUEFDRTsKICAgICAgICAgICAgY2FzZSAibWF0aCI6CiAgICAgICAgICAgICAgcmV0dXJuIE1BVEhfTkFNRVNQQUNFOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBIVE1MX05BTUVTUEFDRTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q2hpbGROYW1lc3BhY2UocGFyZW50TmFtZXNwYWNlLCB0eXBlKSB7CiAgICAgICAgICBpZiAocGFyZW50TmFtZXNwYWNlID09IG51bGwgfHwgcGFyZW50TmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICByZXR1cm4gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcmVudE5hbWVzcGFjZSA9PT0gU1ZHX05BTUVTUEFDRSAmJiB0eXBlID09PSAiZm9yZWlnbk9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIEhUTUxfTkFNRVNQQUNFOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhcmVudE5hbWVzcGFjZTsKICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZU1pY3Jvc29mdFVuc2FmZUxvY2FsRnVuY3Rpb24gPSBmdW5jdGlvbihmdW5jKSB7CiAgICAgICAgICBpZiAodHlwZW9mIE1TQXBwICE9PSAidW5kZWZpbmVkIiAmJiBNU0FwcC5leGVjVW5zYWZlTG9jYWxGdW5jdGlvbikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJnMCwgYXJnMSwgYXJnMiwgYXJnMykgewogICAgICAgICAgICAgIE1TQXBwLmV4ZWNVbnNhZmVMb2NhbEZ1bmN0aW9uKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmMoYXJnMCwgYXJnMSwgYXJnMiwgYXJnMyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciByZXVzYWJsZVNWR0NvbnRhaW5lcjsKICAgICAgICB2YXIgc2V0SW5uZXJIVE1MID0gY3JlYXRlTWljcm9zb2Z0VW5zYWZlTG9jYWxGdW5jdGlvbihmdW5jdGlvbihub2RlLCBodG1sKSB7CiAgICAgICAgICBpZiAobm9kZS5uYW1lc3BhY2VVUkkgPT09IFNWR19OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgaWYgKCEoImlubmVySFRNTCIgaW4gbm9kZSkpIHsKICAgICAgICAgICAgICByZXVzYWJsZVNWR0NvbnRhaW5lciA9IHJldXNhYmxlU1ZHQ29udGFpbmVyIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgIHJldXNhYmxlU1ZHQ29udGFpbmVyLmlubmVySFRNTCA9ICI8c3ZnPiIgKyBodG1sLnZhbHVlT2YoKS50b1N0cmluZygpICsgIjwvc3ZnPiI7CiAgICAgICAgICAgICAgdmFyIHN2Z05vZGUgPSByZXVzYWJsZVNWR0NvbnRhaW5lci5maXJzdENoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChub2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQ2hpbGQobm9kZS5maXJzdENoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKHN2Z05vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChzdmdOb2RlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5vZGUuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICB9KTsKICAgICAgICB2YXIgRUxFTUVOVF9OT0RFID0gMTsKICAgICAgICB2YXIgVEVYVF9OT0RFID0gMzsKICAgICAgICB2YXIgQ09NTUVOVF9OT0RFID0gODsKICAgICAgICB2YXIgRE9DVU1FTlRfTk9ERSA9IDk7CiAgICAgICAgdmFyIERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgPSAxMTsKICAgICAgICB2YXIgc2V0VGV4dENvbnRlbnQgPSBmdW5jdGlvbihub2RlLCB0ZXh0KSB7CiAgICAgICAgICBpZiAodGV4dCkgewogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IG5vZGUuZmlyc3RDaGlsZDsKICAgICAgICAgICAgaWYgKGZpcnN0Q2hpbGQgJiYgZmlyc3RDaGlsZCA9PT0gbm9kZS5sYXN0Q2hpbGQgJiYgZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5ub2RlVmFsdWUgPSB0ZXh0OwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbm9kZS50ZXh0Q29udGVudCA9IHRleHQ7CiAgICAgICAgfTsKICAgICAgICB2YXIgc2hvcnRoYW5kVG9Mb25naGFuZCA9IHsKICAgICAgICAgIGFuaW1hdGlvbjogWyJhbmltYXRpb25EZWxheSIsICJhbmltYXRpb25EaXJlY3Rpb24iLCAiYW5pbWF0aW9uRHVyYXRpb24iLCAiYW5pbWF0aW9uRmlsbE1vZGUiLCAiYW5pbWF0aW9uSXRlcmF0aW9uQ291bnQiLCAiYW5pbWF0aW9uTmFtZSIsICJhbmltYXRpb25QbGF5U3RhdGUiLCAiYW5pbWF0aW9uVGltaW5nRnVuY3Rpb24iXSwKICAgICAgICAgIGJhY2tncm91bmQ6IFsiYmFja2dyb3VuZEF0dGFjaG1lbnQiLCAiYmFja2dyb3VuZENsaXAiLCAiYmFja2dyb3VuZENvbG9yIiwgImJhY2tncm91bmRJbWFnZSIsICJiYWNrZ3JvdW5kT3JpZ2luIiwgImJhY2tncm91bmRQb3NpdGlvblgiLCAiYmFja2dyb3VuZFBvc2l0aW9uWSIsICJiYWNrZ3JvdW5kUmVwZWF0IiwgImJhY2tncm91bmRTaXplIl0sCiAgICAgICAgICBiYWNrZ3JvdW5kUG9zaXRpb246IFsiYmFja2dyb3VuZFBvc2l0aW9uWCIsICJiYWNrZ3JvdW5kUG9zaXRpb25ZIl0sCiAgICAgICAgICBib3JkZXI6IFsiYm9yZGVyQm90dG9tQ29sb3IiLCAiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyQm90dG9tV2lkdGgiLCAiYm9yZGVySW1hZ2VPdXRzZXQiLCAiYm9yZGVySW1hZ2VSZXBlYXQiLCAiYm9yZGVySW1hZ2VTbGljZSIsICJib3JkZXJJbWFnZVNvdXJjZSIsICJib3JkZXJJbWFnZVdpZHRoIiwgImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0Q29sb3IiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJSaWdodFdpZHRoIiwgImJvcmRlclRvcENvbG9yIiwgImJvcmRlclRvcFN0eWxlIiwgImJvcmRlclRvcFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJCbG9ja0VuZDogWyJib3JkZXJCbG9ja0VuZENvbG9yIiwgImJvcmRlckJsb2NrRW5kU3R5bGUiLCAiYm9yZGVyQmxvY2tFbmRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyQmxvY2tTdGFydDogWyJib3JkZXJCbG9ja1N0YXJ0Q29sb3IiLCAiYm9yZGVyQmxvY2tTdGFydFN0eWxlIiwgImJvcmRlckJsb2NrU3RhcnRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyQm90dG9tOiBbImJvcmRlckJvdHRvbUNvbG9yIiwgImJvcmRlckJvdHRvbVN0eWxlIiwgImJvcmRlckJvdHRvbVdpZHRoIl0sCiAgICAgICAgICBib3JkZXJDb2xvcjogWyJib3JkZXJCb3R0b21Db2xvciIsICJib3JkZXJMZWZ0Q29sb3IiLCAiYm9yZGVyUmlnaHRDb2xvciIsICJib3JkZXJUb3BDb2xvciJdLAogICAgICAgICAgYm9yZGVySW1hZ2U6IFsiYm9yZGVySW1hZ2VPdXRzZXQiLCAiYm9yZGVySW1hZ2VSZXBlYXQiLCAiYm9yZGVySW1hZ2VTbGljZSIsICJib3JkZXJJbWFnZVNvdXJjZSIsICJib3JkZXJJbWFnZVdpZHRoIl0sCiAgICAgICAgICBib3JkZXJJbmxpbmVFbmQ6IFsiYm9yZGVySW5saW5lRW5kQ29sb3IiLCAiYm9yZGVySW5saW5lRW5kU3R5bGUiLCAiYm9yZGVySW5saW5lRW5kV2lkdGgiXSwKICAgICAgICAgIGJvcmRlcklubGluZVN0YXJ0OiBbImJvcmRlcklubGluZVN0YXJ0Q29sb3IiLCAiYm9yZGVySW5saW5lU3RhcnRTdHlsZSIsICJib3JkZXJJbmxpbmVTdGFydFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJMZWZ0OiBbImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyTGVmdFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJSYWRpdXM6IFsiYm9yZGVyQm90dG9tTGVmdFJhZGl1cyIsICJib3JkZXJCb3R0b21SaWdodFJhZGl1cyIsICJib3JkZXJUb3BMZWZ0UmFkaXVzIiwgImJvcmRlclRvcFJpZ2h0UmFkaXVzIl0sCiAgICAgICAgICBib3JkZXJSaWdodDogWyJib3JkZXJSaWdodENvbG9yIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyUmlnaHRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyU3R5bGU6IFsiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyTGVmdFN0eWxlIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyVG9wU3R5bGUiXSwKICAgICAgICAgIGJvcmRlclRvcDogWyJib3JkZXJUb3BDb2xvciIsICJib3JkZXJUb3BTdHlsZSIsICJib3JkZXJUb3BXaWR0aCJdLAogICAgICAgICAgYm9yZGVyV2lkdGg6IFsiYm9yZGVyQm90dG9tV2lkdGgiLCAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0V2lkdGgiLCAiYm9yZGVyVG9wV2lkdGgiXSwKICAgICAgICAgIGNvbHVtblJ1bGU6IFsiY29sdW1uUnVsZUNvbG9yIiwgImNvbHVtblJ1bGVTdHlsZSIsICJjb2x1bW5SdWxlV2lkdGgiXSwKICAgICAgICAgIGNvbHVtbnM6IFsiY29sdW1uQ291bnQiLCAiY29sdW1uV2lkdGgiXSwKICAgICAgICAgIGZsZXg6IFsiZmxleEJhc2lzIiwgImZsZXhHcm93IiwgImZsZXhTaHJpbmsiXSwKICAgICAgICAgIGZsZXhGbG93OiBbImZsZXhEaXJlY3Rpb24iLCAiZmxleFdyYXAiXSwKICAgICAgICAgIGZvbnQ6IFsiZm9udEZhbWlseSIsICJmb250RmVhdHVyZVNldHRpbmdzIiwgImZvbnRLZXJuaW5nIiwgImZvbnRMYW5ndWFnZU92ZXJyaWRlIiwgImZvbnRTaXplIiwgImZvbnRTaXplQWRqdXN0IiwgImZvbnRTdHJldGNoIiwgImZvbnRTdHlsZSIsICJmb250VmFyaWFudCIsICJmb250VmFyaWFudEFsdGVybmF0ZXMiLCAiZm9udFZhcmlhbnRDYXBzIiwgImZvbnRWYXJpYW50RWFzdEFzaWFuIiwgImZvbnRWYXJpYW50TGlnYXR1cmVzIiwgImZvbnRWYXJpYW50TnVtZXJpYyIsICJmb250VmFyaWFudFBvc2l0aW9uIiwgImZvbnRXZWlnaHQiLCAibGluZUhlaWdodCJdLAogICAgICAgICAgZm9udFZhcmlhbnQ6IFsiZm9udFZhcmlhbnRBbHRlcm5hdGVzIiwgImZvbnRWYXJpYW50Q2FwcyIsICJmb250VmFyaWFudEVhc3RBc2lhbiIsICJmb250VmFyaWFudExpZ2F0dXJlcyIsICJmb250VmFyaWFudE51bWVyaWMiLCAiZm9udFZhcmlhbnRQb3NpdGlvbiJdLAogICAgICAgICAgZ2FwOiBbImNvbHVtbkdhcCIsICJyb3dHYXAiXSwKICAgICAgICAgIGdyaWQ6IFsiZ3JpZEF1dG9Db2x1bW5zIiwgImdyaWRBdXRvRmxvdyIsICJncmlkQXV0b1Jvd3MiLCAiZ3JpZFRlbXBsYXRlQXJlYXMiLCAiZ3JpZFRlbXBsYXRlQ29sdW1ucyIsICJncmlkVGVtcGxhdGVSb3dzIl0sCiAgICAgICAgICBncmlkQXJlYTogWyJncmlkQ29sdW1uRW5kIiwgImdyaWRDb2x1bW5TdGFydCIsICJncmlkUm93RW5kIiwgImdyaWRSb3dTdGFydCJdLAogICAgICAgICAgZ3JpZENvbHVtbjogWyJncmlkQ29sdW1uRW5kIiwgImdyaWRDb2x1bW5TdGFydCJdLAogICAgICAgICAgZ3JpZENvbHVtbkdhcDogWyJjb2x1bW5HYXAiXSwKICAgICAgICAgIGdyaWRHYXA6IFsiY29sdW1uR2FwIiwgInJvd0dhcCJdLAogICAgICAgICAgZ3JpZFJvdzogWyJncmlkUm93RW5kIiwgImdyaWRSb3dTdGFydCJdLAogICAgICAgICAgZ3JpZFJvd0dhcDogWyJyb3dHYXAiXSwKICAgICAgICAgIGdyaWRUZW1wbGF0ZTogWyJncmlkVGVtcGxhdGVBcmVhcyIsICJncmlkVGVtcGxhdGVDb2x1bW5zIiwgImdyaWRUZW1wbGF0ZVJvd3MiXSwKICAgICAgICAgIGxpc3RTdHlsZTogWyJsaXN0U3R5bGVJbWFnZSIsICJsaXN0U3R5bGVQb3NpdGlvbiIsICJsaXN0U3R5bGVUeXBlIl0sCiAgICAgICAgICBtYXJnaW46IFsibWFyZ2luQm90dG9tIiwgIm1hcmdpbkxlZnQiLCAibWFyZ2luUmlnaHQiLCAibWFyZ2luVG9wIl0sCiAgICAgICAgICBtYXJrZXI6IFsibWFya2VyRW5kIiwgIm1hcmtlck1pZCIsICJtYXJrZXJTdGFydCJdLAogICAgICAgICAgbWFzazogWyJtYXNrQ2xpcCIsICJtYXNrQ29tcG9zaXRlIiwgIm1hc2tJbWFnZSIsICJtYXNrTW9kZSIsICJtYXNrT3JpZ2luIiwgIm1hc2tQb3NpdGlvblgiLCAibWFza1Bvc2l0aW9uWSIsICJtYXNrUmVwZWF0IiwgIm1hc2tTaXplIl0sCiAgICAgICAgICBtYXNrUG9zaXRpb246IFsibWFza1Bvc2l0aW9uWCIsICJtYXNrUG9zaXRpb25ZIl0sCiAgICAgICAgICBvdXRsaW5lOiBbIm91dGxpbmVDb2xvciIsICJvdXRsaW5lU3R5bGUiLCAib3V0bGluZVdpZHRoIl0sCiAgICAgICAgICBvdmVyZmxvdzogWyJvdmVyZmxvd1giLCAib3ZlcmZsb3dZIl0sCiAgICAgICAgICBwYWRkaW5nOiBbInBhZGRpbmdCb3R0b20iLCAicGFkZGluZ0xlZnQiLCAicGFkZGluZ1JpZ2h0IiwgInBhZGRpbmdUb3AiXSwKICAgICAgICAgIHBsYWNlQ29udGVudDogWyJhbGlnbkNvbnRlbnQiLCAianVzdGlmeUNvbnRlbnQiXSwKICAgICAgICAgIHBsYWNlSXRlbXM6IFsiYWxpZ25JdGVtcyIsICJqdXN0aWZ5SXRlbXMiXSwKICAgICAgICAgIHBsYWNlU2VsZjogWyJhbGlnblNlbGYiLCAianVzdGlmeVNlbGYiXSwKICAgICAgICAgIHRleHREZWNvcmF0aW9uOiBbInRleHREZWNvcmF0aW9uQ29sb3IiLCAidGV4dERlY29yYXRpb25MaW5lIiwgInRleHREZWNvcmF0aW9uU3R5bGUiXSwKICAgICAgICAgIHRleHRFbXBoYXNpczogWyJ0ZXh0RW1waGFzaXNDb2xvciIsICJ0ZXh0RW1waGFzaXNTdHlsZSJdLAogICAgICAgICAgdHJhbnNpdGlvbjogWyJ0cmFuc2l0aW9uRGVsYXkiLCAidHJhbnNpdGlvbkR1cmF0aW9uIiwgInRyYW5zaXRpb25Qcm9wZXJ0eSIsICJ0cmFuc2l0aW9uVGltaW5nRnVuY3Rpb24iXSwKICAgICAgICAgIHdvcmRXcmFwOiBbIm92ZXJmbG93V3JhcCJdCiAgICAgICAgfTsKICAgICAgICB2YXIgaXNVbml0bGVzc051bWJlciA9IHsKICAgICAgICAgIGFuaW1hdGlvbkl0ZXJhdGlvbkNvdW50OiB0cnVlLAogICAgICAgICAgYXNwZWN0UmF0aW86IHRydWUsCiAgICAgICAgICBib3JkZXJJbWFnZU91dHNldDogdHJ1ZSwKICAgICAgICAgIGJvcmRlckltYWdlU2xpY2U6IHRydWUsCiAgICAgICAgICBib3JkZXJJbWFnZVdpZHRoOiB0cnVlLAogICAgICAgICAgYm94RmxleDogdHJ1ZSwKICAgICAgICAgIGJveEZsZXhHcm91cDogdHJ1ZSwKICAgICAgICAgIGJveE9yZGluYWxHcm91cDogdHJ1ZSwKICAgICAgICAgIGNvbHVtbkNvdW50OiB0cnVlLAogICAgICAgICAgY29sdW1uczogdHJ1ZSwKICAgICAgICAgIGZsZXg6IHRydWUsCiAgICAgICAgICBmbGV4R3JvdzogdHJ1ZSwKICAgICAgICAgIGZsZXhQb3NpdGl2ZTogdHJ1ZSwKICAgICAgICAgIGZsZXhTaHJpbms6IHRydWUsCiAgICAgICAgICBmbGV4TmVnYXRpdmU6IHRydWUsCiAgICAgICAgICBmbGV4T3JkZXI6IHRydWUsCiAgICAgICAgICBncmlkQXJlYTogdHJ1ZSwKICAgICAgICAgIGdyaWRSb3c6IHRydWUsCiAgICAgICAgICBncmlkUm93RW5kOiB0cnVlLAogICAgICAgICAgZ3JpZFJvd1NwYW46IHRydWUsCiAgICAgICAgICBncmlkUm93U3RhcnQ6IHRydWUsCiAgICAgICAgICBncmlkQ29sdW1uOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtbkVuZDogdHJ1ZSwKICAgICAgICAgIGdyaWRDb2x1bW5TcGFuOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtblN0YXJ0OiB0cnVlLAogICAgICAgICAgZm9udFdlaWdodDogdHJ1ZSwKICAgICAgICAgIGxpbmVDbGFtcDogdHJ1ZSwKICAgICAgICAgIGxpbmVIZWlnaHQ6IHRydWUsCiAgICAgICAgICBvcGFjaXR5OiB0cnVlLAogICAgICAgICAgb3JkZXI6IHRydWUsCiAgICAgICAgICBvcnBoYW5zOiB0cnVlLAogICAgICAgICAgdGFiU2l6ZTogdHJ1ZSwKICAgICAgICAgIHdpZG93czogdHJ1ZSwKICAgICAgICAgIHpJbmRleDogdHJ1ZSwKICAgICAgICAgIHpvb206IHRydWUsCiAgICAgICAgICAvLyBTVkctcmVsYXRlZCBwcm9wZXJ0aWVzCiAgICAgICAgICBmaWxsT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgIGZsb29kT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgIHN0b3BPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlRGFzaGFycmF5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlRGFzaG9mZnNldDogdHJ1ZSwKICAgICAgICAgIHN0cm9rZU1pdGVybGltaXQ6IHRydWUsCiAgICAgICAgICBzdHJva2VPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlV2lkdGg6IHRydWUKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHByZWZpeEtleShwcmVmaXgyLCBrZXkpIHsKICAgICAgICAgIHJldHVybiBwcmVmaXgyICsga2V5LmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsga2V5LnN1YnN0cmluZygxKTsKICAgICAgICB9CiAgICAgICAgdmFyIHByZWZpeGVzMiA9IFsiV2Via2l0IiwgIm1zIiwgIk1veiIsICJPIl07CiAgICAgICAgT2JqZWN0LmtleXMoaXNVbml0bGVzc051bWJlcikuZm9yRWFjaChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICBwcmVmaXhlczIuZm9yRWFjaChmdW5jdGlvbihwcmVmaXgyKSB7CiAgICAgICAgICAgIGlzVW5pdGxlc3NOdW1iZXJbcHJlZml4S2V5KHByZWZpeDIsIHByb3ApXSA9IGlzVW5pdGxlc3NOdW1iZXJbcHJvcF07CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiBkYW5nZXJvdXNTdHlsZVZhbHVlKG5hbWUsIHZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KSB7CiAgICAgICAgICB2YXIgaXNFbXB0eSA9IHZhbHVlID09IG51bGwgfHwgdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgfHwgdmFsdWUgPT09ICIiOwogICAgICAgICAgaWYgKGlzRW1wdHkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0N1c3RvbVByb3BlcnR5ICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgJiYgdmFsdWUgIT09IDAgJiYgIShpc1VuaXRsZXNzTnVtYmVyLmhhc093blByb3BlcnR5KG5hbWUpICYmIGlzVW5pdGxlc3NOdW1iZXJbbmFtZV0pKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSArICJweCI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ1NTUHJvcGVydHlTdHJpbmdDb2VyY2lvbih2YWx1ZSwgbmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gKCIiICsgdmFsdWUpLnRyaW0oKTsKICAgICAgICB9CiAgICAgICAgdmFyIHVwcGVyY2FzZVBhdHRlcm4gPSAvKFtBLVpdKS9nOwogICAgICAgIHZhciBtc1BhdHRlcm4gPSAvXm1zLS87CiAgICAgICAgZnVuY3Rpb24gaHlwaGVuYXRlU3R5bGVOYW1lKG5hbWUpIHsKICAgICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UodXBwZXJjYXNlUGF0dGVybiwgIi0kMSIpLnRvTG93ZXJDYXNlKCkucmVwbGFjZShtc1BhdHRlcm4sICItbXMtIik7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuVmFsaWRTdHlsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybiA9IC9eKD86d2Via2l0fG1venxvKVtBLVpdLzsKICAgICAgICAgIHZhciBtc1BhdHRlcm4kMSA9IC9eLW1zLS87CiAgICAgICAgICB2YXIgaHlwaGVuUGF0dGVybiA9IC8tKC4pL2c7CiAgICAgICAgICB2YXIgYmFkU3R5bGVWYWx1ZVdpdGhTZW1pY29sb25QYXR0ZXJuID0gLztccyokLzsKICAgICAgICAgIHZhciB3YXJuZWRTdHlsZU5hbWVzID0ge307CiAgICAgICAgICB2YXIgd2FybmVkU3R5bGVWYWx1ZXMgPSB7fTsKICAgICAgICAgIHZhciB3YXJuZWRGb3JOYU5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgdmFyIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSBmYWxzZTsKICAgICAgICAgIHZhciBjYW1lbGl6ZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoaHlwaGVuUGF0dGVybiwgZnVuY3Rpb24oXywgY2hhcmFjdGVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJhY3Rlci50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2Fybkh5cGhlbmF0ZWRTdHlsZU5hbWUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRTdHlsZU5hbWVzLmhhc093blByb3BlcnR5KG5hbWUpICYmIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FybmVkU3R5bGVOYW1lc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKAogICAgICAgICAgICAgICJVbnN1cHBvcnRlZCBzdHlsZSBwcm9wZXJ0eSAlcy4gRGlkIHlvdSBtZWFuICVzPyIsCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICAvLyBBcyBBbmRpIFNtaXRoIHN1Z2dlc3RzCiAgICAgICAgICAgICAgLy8gKGh0dHA6Ly93d3cuYW5kaXNtaXRoLmNvbS9ibG9nLzIwMTIvMDIvbW9kZXJuaXpyLXByZWZpeGVkLyksIGFuIGAtbXNgIHByZWZpeAogICAgICAgICAgICAgIC8vIGlzIGNvbnZlcnRlZCB0byBsb3dlcmNhc2UgYG1zYC4KICAgICAgICAgICAgICBjYW1lbGl6ZShuYW1lLnJlcGxhY2UobXNQYXR0ZXJuJDEsICJtcy0iKSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVOYW1lcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiB3YXJuZWRTdHlsZU5hbWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiVW5zdXBwb3J0ZWQgdmVuZG9yLXByZWZpeGVkIHN0eWxlIHByb3BlcnR5ICVzLiBEaWQgeW91IG1lYW4gJXM/IiwgbmFtZSwgbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSkpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuU3R5bGVWYWx1ZVdpdGhTZW1pY29sb24gPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVWYWx1ZXMuaGFzT3duUHJvcGVydHkodmFsdWUpICYmIHdhcm5lZFN0eWxlVmFsdWVzW3ZhbHVlXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRTdHlsZVZhbHVlc1t2YWx1ZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcihgU3R5bGUgcHJvcGVydHkgdmFsdWVzIHNob3VsZG4ndCBjb250YWluIGEgc2VtaWNvbG9uLiBUcnkgIiVzOiAlcyIgaW5zdGVhZC5gLCBuYW1lLCB2YWx1ZS5yZXBsYWNlKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybiwgIiIpKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FyblN0eWxlVmFsdWVJc05hTiA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JOYU5WYWx1ZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRGb3JOYU5WYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJgTmFOYCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JJbmZpbml0eVZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiYEluZmluaXR5YCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FyblZhbGlkU3R5bGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCItIikgPiAtMSkgewogICAgICAgICAgICAgIHdhcm5IeXBoZW5hdGVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybi50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybi50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlV2l0aFNlbWljb2xvbihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAoaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICAgICAgICB3YXJuU3R5bGVWYWx1ZUlzTmFOKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpc0Zpbml0ZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgd2FyblZhbGlkU3R5bGUkMSA9IHdhcm5WYWxpZFN0eWxlOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZURhbmdlcm91c1N0cmluZ0ZvclN0eWxlcyhzdHlsZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlcmlhbGl6ZWQgPSAiIjsKICAgICAgICAgICAgdmFyIGRlbGltaXRlciA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBzdHlsZU5hbWUgaW4gc3R5bGVzKSB7CiAgICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gc3R5bGVzW3N0eWxlTmFtZV07CiAgICAgICAgICAgICAgaWYgKHN0eWxlVmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGlzQ3VzdG9tUHJvcGVydHkgPSBzdHlsZU5hbWUuaW5kZXhPZigiLS0iKSA9PT0gMDsKICAgICAgICAgICAgICAgIHNlcmlhbGl6ZWQgKz0gZGVsaW1pdGVyICsgKGlzQ3VzdG9tUHJvcGVydHkgPyBzdHlsZU5hbWUgOiBoeXBoZW5hdGVTdHlsZU5hbWUoc3R5bGVOYW1lKSkgKyAiOiI7CiAgICAgICAgICAgICAgICBzZXJpYWxpemVkICs9IGRhbmdlcm91c1N0eWxlVmFsdWUoc3R5bGVOYW1lLCBzdHlsZVZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgICAgIGRlbGltaXRlciA9ICI7IjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0VmFsdWVGb3JTdHlsZXMobm9kZSwgc3R5bGVzKSB7CiAgICAgICAgICB2YXIgc3R5bGUyID0gbm9kZS5zdHlsZTsKICAgICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc0N1c3RvbVByb3BlcnR5ID0gc3R5bGVOYW1lLmluZGV4T2YoIi0tIikgPT09IDA7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICAgIHdhcm5WYWxpZFN0eWxlJDEoc3R5bGVOYW1lLCBzdHlsZXNbc3R5bGVOYW1lXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gZGFuZ2Vyb3VzU3R5bGVWYWx1ZShzdHlsZU5hbWUsIHN0eWxlc1tzdHlsZU5hbWVdLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgaWYgKHN0eWxlTmFtZSA9PT0gImZsb2F0IikgewogICAgICAgICAgICAgIHN0eWxlTmFtZSA9ICJjc3NGbG9hdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICBzdHlsZTIuc2V0UHJvcGVydHkoc3R5bGVOYW1lLCBzdHlsZVZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdHlsZTJbc3R5bGVOYW1lXSA9IHN0eWxlVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWx1ZUVtcHR5KHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiB8fCB2YWx1ZSA9PT0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZXMpIHsKICAgICAgICAgIHZhciBleHBhbmRlZCA9IHt9OwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHN0eWxlcykgewogICAgICAgICAgICB2YXIgbG9uZ2hhbmRzID0gc2hvcnRoYW5kVG9Mb25naGFuZFtrZXldIHx8IFtrZXldOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxvbmdoYW5kcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGV4cGFuZGVkW2xvbmdoYW5kc1tpXV0gPSBrZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleHBhbmRlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVTaG9ydGhhbmRQcm9wZXJ0eUNvbGxpc2lvbkluRGV2KHN0eWxlVXBkYXRlcywgbmV4dFN0eWxlcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIW5leHRTdHlsZXMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4cGFuZGVkVXBkYXRlcyA9IGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICB2YXIgZXhwYW5kZWRTdHlsZXMgPSBleHBhbmRTaG9ydGhhbmRNYXAobmV4dFN0eWxlcyk7CiAgICAgICAgICAgIHZhciB3YXJuZWRBYm91dCA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXhwYW5kZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsS2V5ID0gZXhwYW5kZWRVcGRhdGVzW2tleV07CiAgICAgICAgICAgICAgdmFyIGNvcnJlY3RPcmlnaW5hbEtleSA9IGV4cGFuZGVkU3R5bGVzW2tleV07CiAgICAgICAgICAgICAgaWYgKGNvcnJlY3RPcmlnaW5hbEtleSAmJiBvcmlnaW5hbEtleSAhPT0gY29ycmVjdE9yaWdpbmFsS2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IG9yaWdpbmFsS2V5ICsgIiwiICsgY29ycmVjdE9yaWdpbmFsS2V5OwogICAgICAgICAgICAgICAgaWYgKHdhcm5lZEFib3V0W3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2FybmVkQWJvdXRbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGEgc3R5bGUgcHJvcGVydHkgZHVyaW5nIHJlcmVuZGVyICglcykgd2hlbiBhIGNvbmZsaWN0aW5nIHByb3BlcnR5IGlzIHNldCAoJXMpIGNhbiBsZWFkIHRvIHN0eWxpbmcgYnVncy4gVG8gYXZvaWQgdGhpcywgZG9uJ3QgbWl4IHNob3J0aGFuZCBhbmQgbm9uLXNob3J0aGFuZCBwcm9wZXJ0aWVzIGZvciB0aGUgc2FtZSB2YWx1ZTsgaW5zdGVhZCwgcmVwbGFjZSB0aGUgc2hvcnRoYW5kIHdpdGggc2VwYXJhdGUgdmFsdWVzLiIsIGlzVmFsdWVFbXB0eShzdHlsZVVwZGF0ZXNbb3JpZ2luYWxLZXldKSA/ICJSZW1vdmluZyIgOiAiVXBkYXRpbmciLCBvcmlnaW5hbEtleSwgY29ycmVjdE9yaWdpbmFsS2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG9taXR0ZWRDbG9zZVRhZ3MgPSB7CiAgICAgICAgICBhcmVhOiB0cnVlLAogICAgICAgICAgYmFzZTogdHJ1ZSwKICAgICAgICAgIGJyOiB0cnVlLAogICAgICAgICAgY29sOiB0cnVlLAogICAgICAgICAgZW1iZWQ6IHRydWUsCiAgICAgICAgICBocjogdHJ1ZSwKICAgICAgICAgIGltZzogdHJ1ZSwKICAgICAgICAgIGlucHV0OiB0cnVlLAogICAgICAgICAga2V5Z2VuOiB0cnVlLAogICAgICAgICAgbGluazogdHJ1ZSwKICAgICAgICAgIG1ldGE6IHRydWUsCiAgICAgICAgICBwYXJhbTogdHJ1ZSwKICAgICAgICAgIHNvdXJjZTogdHJ1ZSwKICAgICAgICAgIHRyYWNrOiB0cnVlLAogICAgICAgICAgd2JyOiB0cnVlCiAgICAgICAgICAvLyBOT1RFOiBtZW51aXRlbSdzIGNsb3NlIHRhZyBzaG91bGQgYmUgb21pdHRlZCwgYnV0IHRoYXQgY2F1c2VzIHByb2JsZW1zLgogICAgICAgIH07CiAgICAgICAgdmFyIHZvaWRFbGVtZW50VGFncyA9IGFzc2lnbjIoewogICAgICAgICAgbWVudWl0ZW06IHRydWUKICAgICAgICB9LCBvbWl0dGVkQ2xvc2VUYWdzKTsKICAgICAgICB2YXIgSFRNTCA9ICJfX2h0bWwiOwogICAgICAgIGZ1bmN0aW9uIGFzc2VydFZhbGlkUHJvcHModGFnLCBwcm9wcykgewogICAgICAgICAgaWYgKCFwcm9wcykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodm9pZEVsZW1lbnRUYWdzW3RhZ10pIHsKICAgICAgICAgICAgaWYgKHByb3BzLmNoaWxkcmVuICE9IG51bGwgfHwgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcih0YWcgKyAiIGlzIGEgdm9pZCBlbGVtZW50IHRhZyBhbmQgbXVzdCBuZWl0aGVyIGhhdmUgYGNoaWxkcmVuYCBub3IgdXNlIGBkYW5nZXJvdXNseVNldElubmVySFRNTGAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChwcm9wcy5jaGlsZHJlbiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW4gb25seSBzZXQgb25lIG9mIGBjaGlsZHJlbmAgb3IgYHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9PSAib2JqZWN0IiB8fCAhKEhUTUwgaW4gcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgIG11c3QgYmUgaW4gdGhlIGZvcm0gYHtfX2h0bWw6IC4uLn1gLiBQbGVhc2UgdmlzaXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Rhbmdlcm91c2x5LXNldC1pbm5lci1odG1sIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghcHJvcHMuc3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nICYmIHByb3BzLmNvbnRlbnRFZGl0YWJsZSAmJiBwcm9wcy5jaGlsZHJlbiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGBjb250ZW50RWRpdGFibGVgIGFuZCBjb250YWlucyBgY2hpbGRyZW5gIG1hbmFnZWQgYnkgUmVhY3QuIEl0IGlzIG5vdyB5b3VyIHJlc3BvbnNpYmlsaXR5IHRvIGd1YXJhbnRlZSB0aGF0IG5vbmUgb2YgdGhvc2Ugbm9kZXMgYXJlIHVuZXhwZWN0ZWRseSBtb2RpZmllZCBvciBkdXBsaWNhdGVkLiBUaGlzIGlzIHByb2JhYmx5IG5vdCBpbnRlbnRpb25hbC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3BzLnN0eWxlICE9IG51bGwgJiYgdHlwZW9mIHByb3BzLnN0eWxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBgc3R5bGVgIHByb3AgZXhwZWN0cyBhIG1hcHBpbmcgZnJvbSBzdHlsZSBwcm9wZXJ0aWVzIHRvIHZhbHVlcywgbm90IGEgc3RyaW5nLiBGb3IgZXhhbXBsZSwgc3R5bGU9e3ttYXJnaW5SaWdodDogc3BhY2luZyArICdlbSd9fSB3aGVuIHVzaW5nIEpTWC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDdXN0b21Db21wb25lbnQodGFnTmFtZSwgcHJvcHMpIHsKICAgICAgICAgIGlmICh0YWdOYW1lLmluZGV4T2YoIi0iKSA9PT0gLTEpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBwcm9wcy5pcyA9PT0gInN0cmluZyI7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRhZ05hbWUpIHsKICAgICAgICAgICAgY2FzZSAiYW5ub3RhdGlvbi14bWwiOgogICAgICAgICAgICBjYXNlICJjb2xvci1wcm9maWxlIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLXNyYyI6CiAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS11cmkiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2UtZm9ybWF0IjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLW5hbWUiOgogICAgICAgICAgICBjYXNlICJtaXNzaW5nLWdseXBoIjoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBwb3NzaWJsZVN0YW5kYXJkTmFtZXMgPSB7CiAgICAgICAgICAvLyBIVE1MCiAgICAgICAgICBhY2NlcHQ6ICJhY2NlcHQiLAogICAgICAgICAgYWNjZXB0Y2hhcnNldDogImFjY2VwdENoYXJzZXQiLAogICAgICAgICAgImFjY2VwdC1jaGFyc2V0IjogImFjY2VwdENoYXJzZXQiLAogICAgICAgICAgYWNjZXNza2V5OiAiYWNjZXNzS2V5IiwKICAgICAgICAgIGFjdGlvbjogImFjdGlvbiIsCiAgICAgICAgICBhbGxvd2Z1bGxzY3JlZW46ICJhbGxvd0Z1bGxTY3JlZW4iLAogICAgICAgICAgYWx0OiAiYWx0IiwKICAgICAgICAgIGFzOiAiYXMiLAogICAgICAgICAgYXN5bmM6ICJhc3luYyIsCiAgICAgICAgICBhdXRvY2FwaXRhbGl6ZTogImF1dG9DYXBpdGFsaXplIiwKICAgICAgICAgIGF1dG9jb21wbGV0ZTogImF1dG9Db21wbGV0ZSIsCiAgICAgICAgICBhdXRvY29ycmVjdDogImF1dG9Db3JyZWN0IiwKICAgICAgICAgIGF1dG9mb2N1czogImF1dG9Gb2N1cyIsCiAgICAgICAgICBhdXRvcGxheTogImF1dG9QbGF5IiwKICAgICAgICAgIGF1dG9zYXZlOiAiYXV0b1NhdmUiLAogICAgICAgICAgY2FwdHVyZTogImNhcHR1cmUiLAogICAgICAgICAgY2VsbHBhZGRpbmc6ICJjZWxsUGFkZGluZyIsCiAgICAgICAgICBjZWxsc3BhY2luZzogImNlbGxTcGFjaW5nIiwKICAgICAgICAgIGNoYWxsZW5nZTogImNoYWxsZW5nZSIsCiAgICAgICAgICBjaGFyc2V0OiAiY2hhclNldCIsCiAgICAgICAgICBjaGVja2VkOiAiY2hlY2tlZCIsCiAgICAgICAgICBjaGlsZHJlbjogImNoaWxkcmVuIiwKICAgICAgICAgIGNpdGU6ICJjaXRlIiwKICAgICAgICAgIGNsYXNzOiAiY2xhc3NOYW1lIiwKICAgICAgICAgIGNsYXNzaWQ6ICJjbGFzc0lEIiwKICAgICAgICAgIGNsYXNzbmFtZTogImNsYXNzTmFtZSIsCiAgICAgICAgICBjb2xzOiAiY29scyIsCiAgICAgICAgICBjb2xzcGFuOiAiY29sU3BhbiIsCiAgICAgICAgICBjb250ZW50OiAiY29udGVudCIsCiAgICAgICAgICBjb250ZW50ZWRpdGFibGU6ICJjb250ZW50RWRpdGFibGUiLAogICAgICAgICAgY29udGV4dG1lbnU6ICJjb250ZXh0TWVudSIsCiAgICAgICAgICBjb250cm9sczogImNvbnRyb2xzIiwKICAgICAgICAgIGNvbnRyb2xzbGlzdDogImNvbnRyb2xzTGlzdCIsCiAgICAgICAgICBjb29yZHM6ICJjb29yZHMiLAogICAgICAgICAgY3Jvc3NvcmlnaW46ICJjcm9zc09yaWdpbiIsCiAgICAgICAgICBkYW5nZXJvdXNseXNldGlubmVyaHRtbDogImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwKICAgICAgICAgIGRhdGE6ICJkYXRhIiwKICAgICAgICAgIGRhdGV0aW1lOiAiZGF0ZVRpbWUiLAogICAgICAgICAgZGVmYXVsdDogImRlZmF1bHQiLAogICAgICAgICAgZGVmYXVsdGNoZWNrZWQ6ICJkZWZhdWx0Q2hlY2tlZCIsCiAgICAgICAgICBkZWZhdWx0dmFsdWU6ICJkZWZhdWx0VmFsdWUiLAogICAgICAgICAgZGVmZXI6ICJkZWZlciIsCiAgICAgICAgICBkaXI6ICJkaXIiLAogICAgICAgICAgZGlzYWJsZWQ6ICJkaXNhYmxlZCIsCiAgICAgICAgICBkaXNhYmxlcGljdHVyZWlucGljdHVyZTogImRpc2FibGVQaWN0dXJlSW5QaWN0dXJlIiwKICAgICAgICAgIGRpc2FibGVyZW1vdGVwbGF5YmFjazogImRpc2FibGVSZW1vdGVQbGF5YmFjayIsCiAgICAgICAgICBkb3dubG9hZDogImRvd25sb2FkIiwKICAgICAgICAgIGRyYWdnYWJsZTogImRyYWdnYWJsZSIsCiAgICAgICAgICBlbmN0eXBlOiAiZW5jVHlwZSIsCiAgICAgICAgICBlbnRlcmtleWhpbnQ6ICJlbnRlcktleUhpbnQiLAogICAgICAgICAgZm9yOiAiaHRtbEZvciIsCiAgICAgICAgICBmb3JtOiAiZm9ybSIsCiAgICAgICAgICBmb3JtbWV0aG9kOiAiZm9ybU1ldGhvZCIsCiAgICAgICAgICBmb3JtYWN0aW9uOiAiZm9ybUFjdGlvbiIsCiAgICAgICAgICBmb3JtZW5jdHlwZTogImZvcm1FbmNUeXBlIiwKICAgICAgICAgIGZvcm1ub3ZhbGlkYXRlOiAiZm9ybU5vVmFsaWRhdGUiLAogICAgICAgICAgZm9ybXRhcmdldDogImZvcm1UYXJnZXQiLAogICAgICAgICAgZnJhbWVib3JkZXI6ICJmcmFtZUJvcmRlciIsCiAgICAgICAgICBoZWFkZXJzOiAiaGVhZGVycyIsCiAgICAgICAgICBoZWlnaHQ6ICJoZWlnaHQiLAogICAgICAgICAgaGlkZGVuOiAiaGlkZGVuIiwKICAgICAgICAgIGhpZ2g6ICJoaWdoIiwKICAgICAgICAgIGhyZWY6ICJocmVmIiwKICAgICAgICAgIGhyZWZsYW5nOiAiaHJlZkxhbmciLAogICAgICAgICAgaHRtbGZvcjogImh0bWxGb3IiLAogICAgICAgICAgaHR0cGVxdWl2OiAiaHR0cEVxdWl2IiwKICAgICAgICAgICJodHRwLWVxdWl2IjogImh0dHBFcXVpdiIsCiAgICAgICAgICBpY29uOiAiaWNvbiIsCiAgICAgICAgICBpZDogImlkIiwKICAgICAgICAgIGltYWdlc2l6ZXM6ICJpbWFnZVNpemVzIiwKICAgICAgICAgIGltYWdlc3Jjc2V0OiAiaW1hZ2VTcmNTZXQiLAogICAgICAgICAgaW5uZXJodG1sOiAiaW5uZXJIVE1MIiwKICAgICAgICAgIGlucHV0bW9kZTogImlucHV0TW9kZSIsCiAgICAgICAgICBpbnRlZ3JpdHk6ICJpbnRlZ3JpdHkiLAogICAgICAgICAgaXM6ICJpcyIsCiAgICAgICAgICBpdGVtaWQ6ICJpdGVtSUQiLAogICAgICAgICAgaXRlbXByb3A6ICJpdGVtUHJvcCIsCiAgICAgICAgICBpdGVtcmVmOiAiaXRlbVJlZiIsCiAgICAgICAgICBpdGVtc2NvcGU6ICJpdGVtU2NvcGUiLAogICAgICAgICAgaXRlbXR5cGU6ICJpdGVtVHlwZSIsCiAgICAgICAgICBrZXlwYXJhbXM6ICJrZXlQYXJhbXMiLAogICAgICAgICAga2V5dHlwZTogImtleVR5cGUiLAogICAgICAgICAga2luZDogImtpbmQiLAogICAgICAgICAgbGFiZWw6ICJsYWJlbCIsCiAgICAgICAgICBsYW5nOiAibGFuZyIsCiAgICAgICAgICBsaXN0OiAibGlzdCIsCiAgICAgICAgICBsb29wOiAibG9vcCIsCiAgICAgICAgICBsb3c6ICJsb3ciLAogICAgICAgICAgbWFuaWZlc3Q6ICJtYW5pZmVzdCIsCiAgICAgICAgICBtYXJnaW53aWR0aDogIm1hcmdpbldpZHRoIiwKICAgICAgICAgIG1hcmdpbmhlaWdodDogIm1hcmdpbkhlaWdodCIsCiAgICAgICAgICBtYXg6ICJtYXgiLAogICAgICAgICAgbWF4bGVuZ3RoOiAibWF4TGVuZ3RoIiwKICAgICAgICAgIG1lZGlhOiAibWVkaWEiLAogICAgICAgICAgbWVkaWFncm91cDogIm1lZGlhR3JvdXAiLAogICAgICAgICAgbWV0aG9kOiAibWV0aG9kIiwKICAgICAgICAgIG1pbjogIm1pbiIsCiAgICAgICAgICBtaW5sZW5ndGg6ICJtaW5MZW5ndGgiLAogICAgICAgICAgbXVsdGlwbGU6ICJtdWx0aXBsZSIsCiAgICAgICAgICBtdXRlZDogIm11dGVkIiwKICAgICAgICAgIG5hbWU6ICJuYW1lIiwKICAgICAgICAgIG5vbW9kdWxlOiAibm9Nb2R1bGUiLAogICAgICAgICAgbm9uY2U6ICJub25jZSIsCiAgICAgICAgICBub3ZhbGlkYXRlOiAibm9WYWxpZGF0ZSIsCiAgICAgICAgICBvcGVuOiAib3BlbiIsCiAgICAgICAgICBvcHRpbXVtOiAib3B0aW11bSIsCiAgICAgICAgICBwYXR0ZXJuOiAicGF0dGVybiIsCiAgICAgICAgICBwbGFjZWhvbGRlcjogInBsYWNlaG9sZGVyIiwKICAgICAgICAgIHBsYXlzaW5saW5lOiAicGxheXNJbmxpbmUiLAogICAgICAgICAgcG9zdGVyOiAicG9zdGVyIiwKICAgICAgICAgIHByZWxvYWQ6ICJwcmVsb2FkIiwKICAgICAgICAgIHByb2ZpbGU6ICJwcm9maWxlIiwKICAgICAgICAgIHJhZGlvZ3JvdXA6ICJyYWRpb0dyb3VwIiwKICAgICAgICAgIHJlYWRvbmx5OiAicmVhZE9ubHkiLAogICAgICAgICAgcmVmZXJyZXJwb2xpY3k6ICJyZWZlcnJlclBvbGljeSIsCiAgICAgICAgICByZWw6ICJyZWwiLAogICAgICAgICAgcmVxdWlyZWQ6ICJyZXF1aXJlZCIsCiAgICAgICAgICByZXZlcnNlZDogInJldmVyc2VkIiwKICAgICAgICAgIHJvbGU6ICJyb2xlIiwKICAgICAgICAgIHJvd3M6ICJyb3dzIiwKICAgICAgICAgIHJvd3NwYW46ICJyb3dTcGFuIiwKICAgICAgICAgIHNhbmRib3g6ICJzYW5kYm94IiwKICAgICAgICAgIHNjb3BlOiAic2NvcGUiLAogICAgICAgICAgc2NvcGVkOiAic2NvcGVkIiwKICAgICAgICAgIHNjcm9sbGluZzogInNjcm9sbGluZyIsCiAgICAgICAgICBzZWFtbGVzczogInNlYW1sZXNzIiwKICAgICAgICAgIHNlbGVjdGVkOiAic2VsZWN0ZWQiLAogICAgICAgICAgc2hhcGU6ICJzaGFwZSIsCiAgICAgICAgICBzaXplOiAic2l6ZSIsCiAgICAgICAgICBzaXplczogInNpemVzIiwKICAgICAgICAgIHNwYW46ICJzcGFuIiwKICAgICAgICAgIHNwZWxsY2hlY2s6ICJzcGVsbENoZWNrIiwKICAgICAgICAgIHNyYzogInNyYyIsCiAgICAgICAgICBzcmNkb2M6ICJzcmNEb2MiLAogICAgICAgICAgc3JjbGFuZzogInNyY0xhbmciLAogICAgICAgICAgc3Jjc2V0OiAic3JjU2V0IiwKICAgICAgICAgIHN0YXJ0OiAic3RhcnQiLAogICAgICAgICAgc3RlcDogInN0ZXAiLAogICAgICAgICAgc3R5bGU6ICJzdHlsZSIsCiAgICAgICAgICBzdW1tYXJ5OiAic3VtbWFyeSIsCiAgICAgICAgICB0YWJpbmRleDogInRhYkluZGV4IiwKICAgICAgICAgIHRhcmdldDogInRhcmdldCIsCiAgICAgICAgICB0aXRsZTogInRpdGxlIiwKICAgICAgICAgIHR5cGU6ICJ0eXBlIiwKICAgICAgICAgIHVzZW1hcDogInVzZU1hcCIsCiAgICAgICAgICB2YWx1ZTogInZhbHVlIiwKICAgICAgICAgIHdpZHRoOiAid2lkdGgiLAogICAgICAgICAgd21vZGU6ICJ3bW9kZSIsCiAgICAgICAgICB3cmFwOiAid3JhcCIsCiAgICAgICAgICAvLyBTVkcKICAgICAgICAgIGFib3V0OiAiYWJvdXQiLAogICAgICAgICAgYWNjZW50aGVpZ2h0OiAiYWNjZW50SGVpZ2h0IiwKICAgICAgICAgICJhY2NlbnQtaGVpZ2h0IjogImFjY2VudEhlaWdodCIsCiAgICAgICAgICBhY2N1bXVsYXRlOiAiYWNjdW11bGF0ZSIsCiAgICAgICAgICBhZGRpdGl2ZTogImFkZGl0aXZlIiwKICAgICAgICAgIGFsaWdubWVudGJhc2VsaW5lOiAiYWxpZ25tZW50QmFzZWxpbmUiLAogICAgICAgICAgImFsaWdubWVudC1iYXNlbGluZSI6ICJhbGlnbm1lbnRCYXNlbGluZSIsCiAgICAgICAgICBhbGxvd3Jlb3JkZXI6ICJhbGxvd1Jlb3JkZXIiLAogICAgICAgICAgYWxwaGFiZXRpYzogImFscGhhYmV0aWMiLAogICAgICAgICAgYW1wbGl0dWRlOiAiYW1wbGl0dWRlIiwKICAgICAgICAgIGFyYWJpY2Zvcm06ICJhcmFiaWNGb3JtIiwKICAgICAgICAgICJhcmFiaWMtZm9ybSI6ICJhcmFiaWNGb3JtIiwKICAgICAgICAgIGFzY2VudDogImFzY2VudCIsCiAgICAgICAgICBhdHRyaWJ1dGVuYW1lOiAiYXR0cmlidXRlTmFtZSIsCiAgICAgICAgICBhdHRyaWJ1dGV0eXBlOiAiYXR0cmlidXRlVHlwZSIsCiAgICAgICAgICBhdXRvcmV2ZXJzZTogImF1dG9SZXZlcnNlIiwKICAgICAgICAgIGF6aW11dGg6ICJhemltdXRoIiwKICAgICAgICAgIGJhc2VmcmVxdWVuY3k6ICJiYXNlRnJlcXVlbmN5IiwKICAgICAgICAgIGJhc2VsaW5lc2hpZnQ6ICJiYXNlbGluZVNoaWZ0IiwKICAgICAgICAgICJiYXNlbGluZS1zaGlmdCI6ICJiYXNlbGluZVNoaWZ0IiwKICAgICAgICAgIGJhc2Vwcm9maWxlOiAiYmFzZVByb2ZpbGUiLAogICAgICAgICAgYmJveDogImJib3giLAogICAgICAgICAgYmVnaW46ICJiZWdpbiIsCiAgICAgICAgICBiaWFzOiAiYmlhcyIsCiAgICAgICAgICBieTogImJ5IiwKICAgICAgICAgIGNhbGNtb2RlOiAiY2FsY01vZGUiLAogICAgICAgICAgY2FwaGVpZ2h0OiAiY2FwSGVpZ2h0IiwKICAgICAgICAgICJjYXAtaGVpZ2h0IjogImNhcEhlaWdodCIsCiAgICAgICAgICBjbGlwOiAiY2xpcCIsCiAgICAgICAgICBjbGlwcGF0aDogImNsaXBQYXRoIiwKICAgICAgICAgICJjbGlwLXBhdGgiOiAiY2xpcFBhdGgiLAogICAgICAgICAgY2xpcHBhdGh1bml0czogImNsaXBQYXRoVW5pdHMiLAogICAgICAgICAgY2xpcHJ1bGU6ICJjbGlwUnVsZSIsCiAgICAgICAgICAiY2xpcC1ydWxlIjogImNsaXBSdWxlIiwKICAgICAgICAgIGNvbG9yOiAiY29sb3IiLAogICAgICAgICAgY29sb3JpbnRlcnBvbGF0aW9uOiAiY29sb3JJbnRlcnBvbGF0aW9uIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uIjogImNvbG9ySW50ZXJwb2xhdGlvbiIsCiAgICAgICAgICBjb2xvcmludGVycG9sYXRpb25maWx0ZXJzOiAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgICAgICAgICAiY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzIjogImNvbG9ySW50ZXJwb2xhdGlvbkZpbHRlcnMiLAogICAgICAgICAgY29sb3Jwcm9maWxlOiAiY29sb3JQcm9maWxlIiwKICAgICAgICAgICJjb2xvci1wcm9maWxlIjogImNvbG9yUHJvZmlsZSIsCiAgICAgICAgICBjb2xvcnJlbmRlcmluZzogImNvbG9yUmVuZGVyaW5nIiwKICAgICAgICAgICJjb2xvci1yZW5kZXJpbmciOiAiY29sb3JSZW5kZXJpbmciLAogICAgICAgICAgY29udGVudHNjcmlwdHR5cGU6ICJjb250ZW50U2NyaXB0VHlwZSIsCiAgICAgICAgICBjb250ZW50c3R5bGV0eXBlOiAiY29udGVudFN0eWxlVHlwZSIsCiAgICAgICAgICBjdXJzb3I6ICJjdXJzb3IiLAogICAgICAgICAgY3g6ICJjeCIsCiAgICAgICAgICBjeTogImN5IiwKICAgICAgICAgIGQ6ICJkIiwKICAgICAgICAgIGRhdGF0eXBlOiAiZGF0YXR5cGUiLAogICAgICAgICAgZGVjZWxlcmF0ZTogImRlY2VsZXJhdGUiLAogICAgICAgICAgZGVzY2VudDogImRlc2NlbnQiLAogICAgICAgICAgZGlmZnVzZWNvbnN0YW50OiAiZGlmZnVzZUNvbnN0YW50IiwKICAgICAgICAgIGRpcmVjdGlvbjogImRpcmVjdGlvbiIsCiAgICAgICAgICBkaXNwbGF5OiAiZGlzcGxheSIsCiAgICAgICAgICBkaXZpc29yOiAiZGl2aXNvciIsCiAgICAgICAgICBkb21pbmFudGJhc2VsaW5lOiAiZG9taW5hbnRCYXNlbGluZSIsCiAgICAgICAgICAiZG9taW5hbnQtYmFzZWxpbmUiOiAiZG9taW5hbnRCYXNlbGluZSIsCiAgICAgICAgICBkdXI6ICJkdXIiLAogICAgICAgICAgZHg6ICJkeCIsCiAgICAgICAgICBkeTogImR5IiwKICAgICAgICAgIGVkZ2Vtb2RlOiAiZWRnZU1vZGUiLAogICAgICAgICAgZWxldmF0aW9uOiAiZWxldmF0aW9uIiwKICAgICAgICAgIGVuYWJsZWJhY2tncm91bmQ6ICJlbmFibGVCYWNrZ3JvdW5kIiwKICAgICAgICAgICJlbmFibGUtYmFja2dyb3VuZCI6ICJlbmFibGVCYWNrZ3JvdW5kIiwKICAgICAgICAgIGVuZDogImVuZCIsCiAgICAgICAgICBleHBvbmVudDogImV4cG9uZW50IiwKICAgICAgICAgIGV4dGVybmFscmVzb3VyY2VzcmVxdWlyZWQ6ICJleHRlcm5hbFJlc291cmNlc1JlcXVpcmVkIiwKICAgICAgICAgIGZpbGw6ICJmaWxsIiwKICAgICAgICAgIGZpbGxvcGFjaXR5OiAiZmlsbE9wYWNpdHkiLAogICAgICAgICAgImZpbGwtb3BhY2l0eSI6ICJmaWxsT3BhY2l0eSIsCiAgICAgICAgICBmaWxscnVsZTogImZpbGxSdWxlIiwKICAgICAgICAgICJmaWxsLXJ1bGUiOiAiZmlsbFJ1bGUiLAogICAgICAgICAgZmlsdGVyOiAiZmlsdGVyIiwKICAgICAgICAgIGZpbHRlcnJlczogImZpbHRlclJlcyIsCiAgICAgICAgICBmaWx0ZXJ1bml0czogImZpbHRlclVuaXRzIiwKICAgICAgICAgIGZsb29kb3BhY2l0eTogImZsb29kT3BhY2l0eSIsCiAgICAgICAgICAiZmxvb2Qtb3BhY2l0eSI6ICJmbG9vZE9wYWNpdHkiLAogICAgICAgICAgZmxvb2Rjb2xvcjogImZsb29kQ29sb3IiLAogICAgICAgICAgImZsb29kLWNvbG9yIjogImZsb29kQ29sb3IiLAogICAgICAgICAgZm9jdXNhYmxlOiAiZm9jdXNhYmxlIiwKICAgICAgICAgIGZvbnRmYW1pbHk6ICJmb250RmFtaWx5IiwKICAgICAgICAgICJmb250LWZhbWlseSI6ICJmb250RmFtaWx5IiwKICAgICAgICAgIGZvbnRzaXplOiAiZm9udFNpemUiLAogICAgICAgICAgImZvbnQtc2l6ZSI6ICJmb250U2l6ZSIsCiAgICAgICAgICBmb250c2l6ZWFkanVzdDogImZvbnRTaXplQWRqdXN0IiwKICAgICAgICAgICJmb250LXNpemUtYWRqdXN0IjogImZvbnRTaXplQWRqdXN0IiwKICAgICAgICAgIGZvbnRzdHJldGNoOiAiZm9udFN0cmV0Y2giLAogICAgICAgICAgImZvbnQtc3RyZXRjaCI6ICJmb250U3RyZXRjaCIsCiAgICAgICAgICBmb250c3R5bGU6ICJmb250U3R5bGUiLAogICAgICAgICAgImZvbnQtc3R5bGUiOiAiZm9udFN0eWxlIiwKICAgICAgICAgIGZvbnR2YXJpYW50OiAiZm9udFZhcmlhbnQiLAogICAgICAgICAgImZvbnQtdmFyaWFudCI6ICJmb250VmFyaWFudCIsCiAgICAgICAgICBmb250d2VpZ2h0OiAiZm9udFdlaWdodCIsCiAgICAgICAgICAiZm9udC13ZWlnaHQiOiAiZm9udFdlaWdodCIsCiAgICAgICAgICBmb3JtYXQ6ICJmb3JtYXQiLAogICAgICAgICAgZnJvbTogImZyb20iLAogICAgICAgICAgZng6ICJmeCIsCiAgICAgICAgICBmeTogImZ5IiwKICAgICAgICAgIGcxOiAiZzEiLAogICAgICAgICAgZzI6ICJnMiIsCiAgICAgICAgICBnbHlwaG5hbWU6ICJnbHlwaE5hbWUiLAogICAgICAgICAgImdseXBoLW5hbWUiOiAiZ2x5cGhOYW1lIiwKICAgICAgICAgIGdseXBob3JpZW50YXRpb25ob3Jpem9udGFsOiAiZ2x5cGhPcmllbnRhdGlvbkhvcml6b250YWwiLAogICAgICAgICAgImdseXBoLW9yaWVudGF0aW9uLWhvcml6b250YWwiOiAiZ2x5cGhPcmllbnRhdGlvbkhvcml6b250YWwiLAogICAgICAgICAgZ2x5cGhvcmllbnRhdGlvbnZlcnRpY2FsOiAiZ2x5cGhPcmllbnRhdGlvblZlcnRpY2FsIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi12ZXJ0aWNhbCI6ICJnbHlwaE9yaWVudGF0aW9uVmVydGljYWwiLAogICAgICAgICAgZ2x5cGhyZWY6ICJnbHlwaFJlZiIsCiAgICAgICAgICBncmFkaWVudHRyYW5zZm9ybTogImdyYWRpZW50VHJhbnNmb3JtIiwKICAgICAgICAgIGdyYWRpZW50dW5pdHM6ICJncmFkaWVudFVuaXRzIiwKICAgICAgICAgIGhhbmdpbmc6ICJoYW5naW5nIiwKICAgICAgICAgIGhvcml6YWR2eDogImhvcml6QWR2WCIsCiAgICAgICAgICAiaG9yaXotYWR2LXgiOiAiaG9yaXpBZHZYIiwKICAgICAgICAgIGhvcml6b3JpZ2lueDogImhvcml6T3JpZ2luWCIsCiAgICAgICAgICAiaG9yaXotb3JpZ2luLXgiOiAiaG9yaXpPcmlnaW5YIiwKICAgICAgICAgIGlkZW9ncmFwaGljOiAiaWRlb2dyYXBoaWMiLAogICAgICAgICAgaW1hZ2VyZW5kZXJpbmc6ICJpbWFnZVJlbmRlcmluZyIsCiAgICAgICAgICAiaW1hZ2UtcmVuZGVyaW5nIjogImltYWdlUmVuZGVyaW5nIiwKICAgICAgICAgIGluMjogImluMiIsCiAgICAgICAgICBpbjogImluIiwKICAgICAgICAgIGlubGlzdDogImlubGlzdCIsCiAgICAgICAgICBpbnRlcmNlcHQ6ICJpbnRlcmNlcHQiLAogICAgICAgICAgazE6ICJrMSIsCiAgICAgICAgICBrMjogImsyIiwKICAgICAgICAgIGszOiAiazMiLAogICAgICAgICAgazQ6ICJrNCIsCiAgICAgICAgICBrOiAiayIsCiAgICAgICAgICBrZXJuZWxtYXRyaXg6ICJrZXJuZWxNYXRyaXgiLAogICAgICAgICAga2VybmVsdW5pdGxlbmd0aDogImtlcm5lbFVuaXRMZW5ndGgiLAogICAgICAgICAga2VybmluZzogImtlcm5pbmciLAogICAgICAgICAga2V5cG9pbnRzOiAia2V5UG9pbnRzIiwKICAgICAgICAgIGtleXNwbGluZXM6ICJrZXlTcGxpbmVzIiwKICAgICAgICAgIGtleXRpbWVzOiAia2V5VGltZXMiLAogICAgICAgICAgbGVuZ3RoYWRqdXN0OiAibGVuZ3RoQWRqdXN0IiwKICAgICAgICAgIGxldHRlcnNwYWNpbmc6ICJsZXR0ZXJTcGFjaW5nIiwKICAgICAgICAgICJsZXR0ZXItc3BhY2luZyI6ICJsZXR0ZXJTcGFjaW5nIiwKICAgICAgICAgIGxpZ2h0aW5nY29sb3I6ICJsaWdodGluZ0NvbG9yIiwKICAgICAgICAgICJsaWdodGluZy1jb2xvciI6ICJsaWdodGluZ0NvbG9yIiwKICAgICAgICAgIGxpbWl0aW5nY29uZWFuZ2xlOiAibGltaXRpbmdDb25lQW5nbGUiLAogICAgICAgICAgbG9jYWw6ICJsb2NhbCIsCiAgICAgICAgICBtYXJrZXJlbmQ6ICJtYXJrZXJFbmQiLAogICAgICAgICAgIm1hcmtlci1lbmQiOiAibWFya2VyRW5kIiwKICAgICAgICAgIG1hcmtlcmhlaWdodDogIm1hcmtlckhlaWdodCIsCiAgICAgICAgICBtYXJrZXJtaWQ6ICJtYXJrZXJNaWQiLAogICAgICAgICAgIm1hcmtlci1taWQiOiAibWFya2VyTWlkIiwKICAgICAgICAgIG1hcmtlcnN0YXJ0OiAibWFya2VyU3RhcnQiLAogICAgICAgICAgIm1hcmtlci1zdGFydCI6ICJtYXJrZXJTdGFydCIsCiAgICAgICAgICBtYXJrZXJ1bml0czogIm1hcmtlclVuaXRzIiwKICAgICAgICAgIG1hcmtlcndpZHRoOiAibWFya2VyV2lkdGgiLAogICAgICAgICAgbWFzazogIm1hc2siLAogICAgICAgICAgbWFza2NvbnRlbnR1bml0czogIm1hc2tDb250ZW50VW5pdHMiLAogICAgICAgICAgbWFza3VuaXRzOiAibWFza1VuaXRzIiwKICAgICAgICAgIG1hdGhlbWF0aWNhbDogIm1hdGhlbWF0aWNhbCIsCiAgICAgICAgICBtb2RlOiAibW9kZSIsCiAgICAgICAgICBudW1vY3RhdmVzOiAibnVtT2N0YXZlcyIsCiAgICAgICAgICBvZmZzZXQ6ICJvZmZzZXQiLAogICAgICAgICAgb3BhY2l0eTogIm9wYWNpdHkiLAogICAgICAgICAgb3BlcmF0b3I6ICJvcGVyYXRvciIsCiAgICAgICAgICBvcmRlcjogIm9yZGVyIiwKICAgICAgICAgIG9yaWVudDogIm9yaWVudCIsCiAgICAgICAgICBvcmllbnRhdGlvbjogIm9yaWVudGF0aW9uIiwKICAgICAgICAgIG9yaWdpbjogIm9yaWdpbiIsCiAgICAgICAgICBvdmVyZmxvdzogIm92ZXJmbG93IiwKICAgICAgICAgIG92ZXJsaW5lcG9zaXRpb246ICJvdmVybGluZVBvc2l0aW9uIiwKICAgICAgICAgICJvdmVybGluZS1wb3NpdGlvbiI6ICJvdmVybGluZVBvc2l0aW9uIiwKICAgICAgICAgIG92ZXJsaW5ldGhpY2tuZXNzOiAib3ZlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgIm92ZXJsaW5lLXRoaWNrbmVzcyI6ICJvdmVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICBwYWludG9yZGVyOiAicGFpbnRPcmRlciIsCiAgICAgICAgICAicGFpbnQtb3JkZXIiOiAicGFpbnRPcmRlciIsCiAgICAgICAgICBwYW5vc2UxOiAicGFub3NlMSIsCiAgICAgICAgICAicGFub3NlLTEiOiAicGFub3NlMSIsCiAgICAgICAgICBwYXRobGVuZ3RoOiAicGF0aExlbmd0aCIsCiAgICAgICAgICBwYXR0ZXJuY29udGVudHVuaXRzOiAicGF0dGVybkNvbnRlbnRVbml0cyIsCiAgICAgICAgICBwYXR0ZXJudHJhbnNmb3JtOiAicGF0dGVyblRyYW5zZm9ybSIsCiAgICAgICAgICBwYXR0ZXJudW5pdHM6ICJwYXR0ZXJuVW5pdHMiLAogICAgICAgICAgcG9pbnRlcmV2ZW50czogInBvaW50ZXJFdmVudHMiLAogICAgICAgICAgInBvaW50ZXItZXZlbnRzIjogInBvaW50ZXJFdmVudHMiLAogICAgICAgICAgcG9pbnRzOiAicG9pbnRzIiwKICAgICAgICAgIHBvaW50c2F0eDogInBvaW50c0F0WCIsCiAgICAgICAgICBwb2ludHNhdHk6ICJwb2ludHNBdFkiLAogICAgICAgICAgcG9pbnRzYXR6OiAicG9pbnRzQXRaIiwKICAgICAgICAgIHByZWZpeDogInByZWZpeCIsCiAgICAgICAgICBwcmVzZXJ2ZWFscGhhOiAicHJlc2VydmVBbHBoYSIsCiAgICAgICAgICBwcmVzZXJ2ZWFzcGVjdHJhdGlvOiAicHJlc2VydmVBc3BlY3RSYXRpbyIsCiAgICAgICAgICBwcmltaXRpdmV1bml0czogInByaW1pdGl2ZVVuaXRzIiwKICAgICAgICAgIHByb3BlcnR5OiAicHJvcGVydHkiLAogICAgICAgICAgcjogInIiLAogICAgICAgICAgcmFkaXVzOiAicmFkaXVzIiwKICAgICAgICAgIHJlZng6ICJyZWZYIiwKICAgICAgICAgIHJlZnk6ICJyZWZZIiwKICAgICAgICAgIHJlbmRlcmluZ2ludGVudDogInJlbmRlcmluZ0ludGVudCIsCiAgICAgICAgICAicmVuZGVyaW5nLWludGVudCI6ICJyZW5kZXJpbmdJbnRlbnQiLAogICAgICAgICAgcmVwZWF0Y291bnQ6ICJyZXBlYXRDb3VudCIsCiAgICAgICAgICByZXBlYXRkdXI6ICJyZXBlYXREdXIiLAogICAgICAgICAgcmVxdWlyZWRleHRlbnNpb25zOiAicmVxdWlyZWRFeHRlbnNpb25zIiwKICAgICAgICAgIHJlcXVpcmVkZmVhdHVyZXM6ICJyZXF1aXJlZEZlYXR1cmVzIiwKICAgICAgICAgIHJlc291cmNlOiAicmVzb3VyY2UiLAogICAgICAgICAgcmVzdGFydDogInJlc3RhcnQiLAogICAgICAgICAgcmVzdWx0OiAicmVzdWx0IiwKICAgICAgICAgIHJlc3VsdHM6ICJyZXN1bHRzIiwKICAgICAgICAgIHJvdGF0ZTogInJvdGF0ZSIsCiAgICAgICAgICByeDogInJ4IiwKICAgICAgICAgIHJ5OiAicnkiLAogICAgICAgICAgc2NhbGU6ICJzY2FsZSIsCiAgICAgICAgICBzZWN1cml0eTogInNlY3VyaXR5IiwKICAgICAgICAgIHNlZWQ6ICJzZWVkIiwKICAgICAgICAgIHNoYXBlcmVuZGVyaW5nOiAic2hhcGVSZW5kZXJpbmciLAogICAgICAgICAgInNoYXBlLXJlbmRlcmluZyI6ICJzaGFwZVJlbmRlcmluZyIsCiAgICAgICAgICBzbG9wZTogInNsb3BlIiwKICAgICAgICAgIHNwYWNpbmc6ICJzcGFjaW5nIiwKICAgICAgICAgIHNwZWN1bGFyY29uc3RhbnQ6ICJzcGVjdWxhckNvbnN0YW50IiwKICAgICAgICAgIHNwZWN1bGFyZXhwb25lbnQ6ICJzcGVjdWxhckV4cG9uZW50IiwKICAgICAgICAgIHNwZWVkOiAic3BlZWQiLAogICAgICAgICAgc3ByZWFkbWV0aG9kOiAic3ByZWFkTWV0aG9kIiwKICAgICAgICAgIHN0YXJ0b2Zmc2V0OiAic3RhcnRPZmZzZXQiLAogICAgICAgICAgc3RkZGV2aWF0aW9uOiAic3RkRGV2aWF0aW9uIiwKICAgICAgICAgIHN0ZW1oOiAic3RlbWgiLAogICAgICAgICAgc3RlbXY6ICJzdGVtdiIsCiAgICAgICAgICBzdGl0Y2h0aWxlczogInN0aXRjaFRpbGVzIiwKICAgICAgICAgIHN0b3Bjb2xvcjogInN0b3BDb2xvciIsCiAgICAgICAgICAic3RvcC1jb2xvciI6ICJzdG9wQ29sb3IiLAogICAgICAgICAgc3RvcG9wYWNpdHk6ICJzdG9wT3BhY2l0eSIsCiAgICAgICAgICAic3RvcC1vcGFjaXR5IjogInN0b3BPcGFjaXR5IiwKICAgICAgICAgIHN0cmlrZXRocm91Z2hwb3NpdGlvbjogInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC1wb3NpdGlvbiI6ICJzdHJpa2V0aHJvdWdoUG9zaXRpb24iLAogICAgICAgICAgc3RyaWtldGhyb3VnaHRoaWNrbmVzczogInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICAgICAgICAgInN0cmlrZXRocm91Z2gtdGhpY2tuZXNzIjogInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICAgICAgICAgc3RyaW5nOiAic3RyaW5nIiwKICAgICAgICAgIHN0cm9rZTogInN0cm9rZSIsCiAgICAgICAgICBzdHJva2VkYXNoYXJyYXk6ICJzdHJva2VEYXNoYXJyYXkiLAogICAgICAgICAgInN0cm9rZS1kYXNoYXJyYXkiOiAic3Ryb2tlRGFzaGFycmF5IiwKICAgICAgICAgIHN0cm9rZWRhc2hvZmZzZXQ6ICJzdHJva2VEYXNob2Zmc2V0IiwKICAgICAgICAgICJzdHJva2UtZGFzaG9mZnNldCI6ICJzdHJva2VEYXNob2Zmc2V0IiwKICAgICAgICAgIHN0cm9rZWxpbmVjYXA6ICJzdHJva2VMaW5lY2FwIiwKICAgICAgICAgICJzdHJva2UtbGluZWNhcCI6ICJzdHJva2VMaW5lY2FwIiwKICAgICAgICAgIHN0cm9rZWxpbmVqb2luOiAic3Ryb2tlTGluZWpvaW4iLAogICAgICAgICAgInN0cm9rZS1saW5lam9pbiI6ICJzdHJva2VMaW5lam9pbiIsCiAgICAgICAgICBzdHJva2VtaXRlcmxpbWl0OiAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgICAgICAgICAic3Ryb2tlLW1pdGVybGltaXQiOiAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgICAgICAgICBzdHJva2V3aWR0aDogInN0cm9rZVdpZHRoIiwKICAgICAgICAgICJzdHJva2Utd2lkdGgiOiAic3Ryb2tlV2lkdGgiLAogICAgICAgICAgc3Ryb2tlb3BhY2l0eTogInN0cm9rZU9wYWNpdHkiLAogICAgICAgICAgInN0cm9rZS1vcGFjaXR5IjogInN0cm9rZU9wYWNpdHkiLAogICAgICAgICAgc3VwcHJlc3Njb250ZW50ZWRpdGFibGV3YXJuaW5nOiAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIiwKICAgICAgICAgIHN1cHByZXNzaHlkcmF0aW9ud2FybmluZzogInN1cHByZXNzSHlkcmF0aW9uV2FybmluZyIsCiAgICAgICAgICBzdXJmYWNlc2NhbGU6ICJzdXJmYWNlU2NhbGUiLAogICAgICAgICAgc3lzdGVtbGFuZ3VhZ2U6ICJzeXN0ZW1MYW5ndWFnZSIsCiAgICAgICAgICB0YWJsZXZhbHVlczogInRhYmxlVmFsdWVzIiwKICAgICAgICAgIHRhcmdldHg6ICJ0YXJnZXRYIiwKICAgICAgICAgIHRhcmdldHk6ICJ0YXJnZXRZIiwKICAgICAgICAgIHRleHRhbmNob3I6ICJ0ZXh0QW5jaG9yIiwKICAgICAgICAgICJ0ZXh0LWFuY2hvciI6ICJ0ZXh0QW5jaG9yIiwKICAgICAgICAgIHRleHRkZWNvcmF0aW9uOiAidGV4dERlY29yYXRpb24iLAogICAgICAgICAgInRleHQtZGVjb3JhdGlvbiI6ICJ0ZXh0RGVjb3JhdGlvbiIsCiAgICAgICAgICB0ZXh0bGVuZ3RoOiAidGV4dExlbmd0aCIsCiAgICAgICAgICB0ZXh0cmVuZGVyaW5nOiAidGV4dFJlbmRlcmluZyIsCiAgICAgICAgICAidGV4dC1yZW5kZXJpbmciOiAidGV4dFJlbmRlcmluZyIsCiAgICAgICAgICB0bzogInRvIiwKICAgICAgICAgIHRyYW5zZm9ybTogInRyYW5zZm9ybSIsCiAgICAgICAgICB0eXBlb2Y6ICJ0eXBlb2YiLAogICAgICAgICAgdTE6ICJ1MSIsCiAgICAgICAgICB1MjogInUyIiwKICAgICAgICAgIHVuZGVybGluZXBvc2l0aW9uOiAidW5kZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgInVuZGVybGluZS1wb3NpdGlvbiI6ICJ1bmRlcmxpbmVQb3NpdGlvbiIsCiAgICAgICAgICB1bmRlcmxpbmV0aGlja25lc3M6ICJ1bmRlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgInVuZGVybGluZS10aGlja25lc3MiOiAidW5kZXJsaW5lVGhpY2tuZXNzIiwKICAgICAgICAgIHVuaWNvZGU6ICJ1bmljb2RlIiwKICAgICAgICAgIHVuaWNvZGViaWRpOiAidW5pY29kZUJpZGkiLAogICAgICAgICAgInVuaWNvZGUtYmlkaSI6ICJ1bmljb2RlQmlkaSIsCiAgICAgICAgICB1bmljb2RlcmFuZ2U6ICJ1bmljb2RlUmFuZ2UiLAogICAgICAgICAgInVuaWNvZGUtcmFuZ2UiOiAidW5pY29kZVJhbmdlIiwKICAgICAgICAgIHVuaXRzcGVyZW06ICJ1bml0c1BlckVtIiwKICAgICAgICAgICJ1bml0cy1wZXItZW0iOiAidW5pdHNQZXJFbSIsCiAgICAgICAgICB1bnNlbGVjdGFibGU6ICJ1bnNlbGVjdGFibGUiLAogICAgICAgICAgdmFscGhhYmV0aWM6ICJ2QWxwaGFiZXRpYyIsCiAgICAgICAgICAidi1hbHBoYWJldGljIjogInZBbHBoYWJldGljIiwKICAgICAgICAgIHZhbHVlczogInZhbHVlcyIsCiAgICAgICAgICB2ZWN0b3JlZmZlY3Q6ICJ2ZWN0b3JFZmZlY3QiLAogICAgICAgICAgInZlY3Rvci1lZmZlY3QiOiAidmVjdG9yRWZmZWN0IiwKICAgICAgICAgIHZlcnNpb246ICJ2ZXJzaW9uIiwKICAgICAgICAgIHZlcnRhZHZ5OiAidmVydEFkdlkiLAogICAgICAgICAgInZlcnQtYWR2LXkiOiAidmVydEFkdlkiLAogICAgICAgICAgdmVydG9yaWdpbng6ICJ2ZXJ0T3JpZ2luWCIsCiAgICAgICAgICAidmVydC1vcmlnaW4teCI6ICJ2ZXJ0T3JpZ2luWCIsCiAgICAgICAgICB2ZXJ0b3JpZ2lueTogInZlcnRPcmlnaW5ZIiwKICAgICAgICAgICJ2ZXJ0LW9yaWdpbi15IjogInZlcnRPcmlnaW5ZIiwKICAgICAgICAgIHZoYW5naW5nOiAidkhhbmdpbmciLAogICAgICAgICAgInYtaGFuZ2luZyI6ICJ2SGFuZ2luZyIsCiAgICAgICAgICB2aWRlb2dyYXBoaWM6ICJ2SWRlb2dyYXBoaWMiLAogICAgICAgICAgInYtaWRlb2dyYXBoaWMiOiAidklkZW9ncmFwaGljIiwKICAgICAgICAgIHZpZXdib3g6ICJ2aWV3Qm94IiwKICAgICAgICAgIHZpZXd0YXJnZXQ6ICJ2aWV3VGFyZ2V0IiwKICAgICAgICAgIHZpc2liaWxpdHk6ICJ2aXNpYmlsaXR5IiwKICAgICAgICAgIHZtYXRoZW1hdGljYWw6ICJ2TWF0aGVtYXRpY2FsIiwKICAgICAgICAgICJ2LW1hdGhlbWF0aWNhbCI6ICJ2TWF0aGVtYXRpY2FsIiwKICAgICAgICAgIHZvY2FiOiAidm9jYWIiLAogICAgICAgICAgd2lkdGhzOiAid2lkdGhzIiwKICAgICAgICAgIHdvcmRzcGFjaW5nOiAid29yZFNwYWNpbmciLAogICAgICAgICAgIndvcmQtc3BhY2luZyI6ICJ3b3JkU3BhY2luZyIsCiAgICAgICAgICB3cml0aW5nbW9kZTogIndyaXRpbmdNb2RlIiwKICAgICAgICAgICJ3cml0aW5nLW1vZGUiOiAid3JpdGluZ01vZGUiLAogICAgICAgICAgeDE6ICJ4MSIsCiAgICAgICAgICB4MjogIngyIiwKICAgICAgICAgIHg6ICJ4IiwKICAgICAgICAgIHhjaGFubmVsc2VsZWN0b3I6ICJ4Q2hhbm5lbFNlbGVjdG9yIiwKICAgICAgICAgIHhoZWlnaHQ6ICJ4SGVpZ2h0IiwKICAgICAgICAgICJ4LWhlaWdodCI6ICJ4SGVpZ2h0IiwKICAgICAgICAgIHhsaW5rYWN0dWF0ZTogInhsaW5rQWN0dWF0ZSIsCiAgICAgICAgICAieGxpbms6YWN0dWF0ZSI6ICJ4bGlua0FjdHVhdGUiLAogICAgICAgICAgeGxpbmthcmNyb2xlOiAieGxpbmtBcmNyb2xlIiwKICAgICAgICAgICJ4bGluazphcmNyb2xlIjogInhsaW5rQXJjcm9sZSIsCiAgICAgICAgICB4bGlua2hyZWY6ICJ4bGlua0hyZWYiLAogICAgICAgICAgInhsaW5rOmhyZWYiOiAieGxpbmtIcmVmIiwKICAgICAgICAgIHhsaW5rcm9sZTogInhsaW5rUm9sZSIsCiAgICAgICAgICAieGxpbms6cm9sZSI6ICJ4bGlua1JvbGUiLAogICAgICAgICAgeGxpbmtzaG93OiAieGxpbmtTaG93IiwKICAgICAgICAgICJ4bGluazpzaG93IjogInhsaW5rU2hvdyIsCiAgICAgICAgICB4bGlua3RpdGxlOiAieGxpbmtUaXRsZSIsCiAgICAgICAgICAieGxpbms6dGl0bGUiOiAieGxpbmtUaXRsZSIsCiAgICAgICAgICB4bGlua3R5cGU6ICJ4bGlua1R5cGUiLAogICAgICAgICAgInhsaW5rOnR5cGUiOiAieGxpbmtUeXBlIiwKICAgICAgICAgIHhtbGJhc2U6ICJ4bWxCYXNlIiwKICAgICAgICAgICJ4bWw6YmFzZSI6ICJ4bWxCYXNlIiwKICAgICAgICAgIHhtbGxhbmc6ICJ4bWxMYW5nIiwKICAgICAgICAgICJ4bWw6bGFuZyI6ICJ4bWxMYW5nIiwKICAgICAgICAgIHhtbG5zOiAieG1sbnMiLAogICAgICAgICAgInhtbDpzcGFjZSI6ICJ4bWxTcGFjZSIsCiAgICAgICAgICB4bWxuc3hsaW5rOiAieG1sbnNYbGluayIsCiAgICAgICAgICAieG1sbnM6eGxpbmsiOiAieG1sbnNYbGluayIsCiAgICAgICAgICB4bWxzcGFjZTogInhtbFNwYWNlIiwKICAgICAgICAgIHkxOiAieTEiLAogICAgICAgICAgeTI6ICJ5MiIsCiAgICAgICAgICB5OiAieSIsCiAgICAgICAgICB5Y2hhbm5lbHNlbGVjdG9yOiAieUNoYW5uZWxTZWxlY3RvciIsCiAgICAgICAgICB6OiAieiIsCiAgICAgICAgICB6b29tYW5kcGFuOiAiem9vbUFuZFBhbiIKICAgICAgICB9OwogICAgICAgIHZhciBhcmlhUHJvcGVydGllcyA9IHsKICAgICAgICAgICJhcmlhLWN1cnJlbnQiOiAwLAogICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICJhcmlhLWRlc2NyaXB0aW9uIjogMCwKICAgICAgICAgICJhcmlhLWRldGFpbHMiOiAwLAogICAgICAgICAgImFyaWEtZGlzYWJsZWQiOiAwLAogICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICJhcmlhLWhpZGRlbiI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEtaW52YWxpZCI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEta2V5c2hvcnRjdXRzIjogMCwKICAgICAgICAgICJhcmlhLWxhYmVsIjogMCwKICAgICAgICAgICJhcmlhLXJvbGVkZXNjcmlwdGlvbiI6IDAsCiAgICAgICAgICAvLyBXaWRnZXQgQXR0cmlidXRlcwogICAgICAgICAgImFyaWEtYXV0b2NvbXBsZXRlIjogMCwKICAgICAgICAgICJhcmlhLWNoZWNrZWQiOiAwLAogICAgICAgICAgImFyaWEtZXhwYW5kZWQiOiAwLAogICAgICAgICAgImFyaWEtaGFzcG9wdXAiOiAwLAogICAgICAgICAgImFyaWEtbGV2ZWwiOiAwLAogICAgICAgICAgImFyaWEtbW9kYWwiOiAwLAogICAgICAgICAgImFyaWEtbXVsdGlsaW5lIjogMCwKICAgICAgICAgICJhcmlhLW11bHRpc2VsZWN0YWJsZSI6IDAsCiAgICAgICAgICAiYXJpYS1vcmllbnRhdGlvbiI6IDAsCiAgICAgICAgICAiYXJpYS1wbGFjZWhvbGRlciI6IDAsCiAgICAgICAgICAiYXJpYS1wcmVzc2VkIjogMCwKICAgICAgICAgICJhcmlhLXJlYWRvbmx5IjogMCwKICAgICAgICAgICJhcmlhLXJlcXVpcmVkIjogMCwKICAgICAgICAgICJhcmlhLXNlbGVjdGVkIjogMCwKICAgICAgICAgICJhcmlhLXNvcnQiOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVtYXgiOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVtaW4iOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVub3ciOiAwLAogICAgICAgICAgImFyaWEtdmFsdWV0ZXh0IjogMCwKICAgICAgICAgIC8vIExpdmUgUmVnaW9uIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWF0b21pYyI6IDAsCiAgICAgICAgICAiYXJpYS1idXN5IjogMCwKICAgICAgICAgICJhcmlhLWxpdmUiOiAwLAogICAgICAgICAgImFyaWEtcmVsZXZhbnQiOiAwLAogICAgICAgICAgLy8gRHJhZy1hbmQtRHJvcCBBdHRyaWJ1dGVzCiAgICAgICAgICAiYXJpYS1kcm9wZWZmZWN0IjogMCwKICAgICAgICAgICJhcmlhLWdyYWJiZWQiOiAwLAogICAgICAgICAgLy8gUmVsYXRpb25zaGlwIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiOiAwLAogICAgICAgICAgImFyaWEtY29sY291bnQiOiAwLAogICAgICAgICAgImFyaWEtY29saW5kZXgiOiAwLAogICAgICAgICAgImFyaWEtY29sc3BhbiI6IDAsCiAgICAgICAgICAiYXJpYS1jb250cm9scyI6IDAsCiAgICAgICAgICAiYXJpYS1kZXNjcmliZWRieSI6IDAsCiAgICAgICAgICAiYXJpYS1lcnJvcm1lc3NhZ2UiOiAwLAogICAgICAgICAgImFyaWEtZmxvd3RvIjogMCwKICAgICAgICAgICJhcmlhLWxhYmVsbGVkYnkiOiAwLAogICAgICAgICAgImFyaWEtb3ducyI6IDAsCiAgICAgICAgICAiYXJpYS1wb3NpbnNldCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3djb3VudCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3dpbmRleCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3dzcGFuIjogMCwKICAgICAgICAgICJhcmlhLXNldHNpemUiOiAwCiAgICAgICAgfTsKICAgICAgICB2YXIgd2FybmVkUHJvcGVydGllcyA9IHt9OwogICAgICAgIHZhciByQVJJQSA9IG5ldyBSZWdFeHAoIl4oYXJpYSktWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIHZhciByQVJJQUNhbWVsID0gbmV3IFJlZ0V4cCgiXihhcmlhKVtBLVpdWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydHkodGFnTmFtZSwgbmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh3YXJuZWRQcm9wZXJ0aWVzLCBuYW1lKSAmJiB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBQ2FtZWwudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIHZhciBhcmlhTmFtZSA9ICJhcmlhLSIgKyBuYW1lLnNsaWNlKDQpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgdmFyIGNvcnJlY3ROYW1lID0gYXJpYVByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoYXJpYU5hbWUpID8gYXJpYU5hbWUgOiBudWxsOwogICAgICAgICAgICAgIGlmIChjb3JyZWN0TmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBBUklBIGF0dHJpYnV0ZSBgJXNgLiBBUklBIGF0dHJpYnV0ZXMgZm9sbG93IHRoZSBwYXR0ZXJuIGFyaWEtKiBhbmQgbXVzdCBiZSBsb3dlcmNhc2UuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmFtZSAhPT0gY29ycmVjdE5hbWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIEFSSUEgYXR0cmlidXRlIGAlc2AuIERpZCB5b3UgbWVhbiBgJXNgPyIsIG5hbWUsIGNvcnJlY3ROYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyQVJJQS50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIHZhciBzdGFuZGFyZE5hbWUgPSBhcmlhUHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkgPyBsb3dlckNhc2VkTmFtZSA6IG51bGw7CiAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5hbWUgIT09IHN0YW5kYXJkTmFtZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlVua25vd24gQVJJQSBhdHRyaWJ1dGUgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgc3RhbmRhcmROYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkludmFsaWRBUklBUHJvcHModHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGludmFsaWRQcm9wcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9IHZhbGlkYXRlUHJvcGVydHkodHlwZSwga2V5KTsKICAgICAgICAgICAgICBpZiAoIWlzVmFsaWQpIHsKICAgICAgICAgICAgICAgIGludmFsaWRQcm9wcy5wdXNoKGtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB1bmtub3duUHJvcFN0cmluZyA9IGludmFsaWRQcm9wcy5tYXAoZnVuY3Rpb24ocHJvcCkgewogICAgICAgICAgICAgIHJldHVybiAiYCIgKyBwcm9wICsgImAiOwogICAgICAgICAgICB9KS5qb2luKCIsICIpOwogICAgICAgICAgICBpZiAoaW52YWxpZFByb3BzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGFyaWEgcHJvcCAlcyBvbiA8JXM+IHRhZy4gRm9yIGRldGFpbHMsIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1hcmlhLXByb3BzIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGludmFsaWRQcm9wcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXJpYSBwcm9wcyAlcyBvbiA8JXM+IHRhZy4gRm9yIGRldGFpbHMsIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1hcmlhLXByb3BzIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydGllcyh0eXBlLCBwcm9wcykgewogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuSW52YWxpZEFSSUFQcm9wcyh0eXBlLCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVOdWxsID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0aWVzJDEodHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGUgIT09ICJpbnB1dCIgJiYgdHlwZSAhPT0gInRleHRhcmVhIiAmJiB0eXBlICE9PSAic2VsZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMgIT0gbnVsbCAmJiBwcm9wcy52YWx1ZSA9PT0gbnVsbCAmJiAhZGlkV2FyblZhbHVlTnVsbCkgewogICAgICAgICAgICAgIGRpZFdhcm5WYWx1ZU51bGwgPSB0cnVlOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSAic2VsZWN0IiAmJiBwcm9wcy5tdWx0aXBsZSkgewogICAgICAgICAgICAgICAgZXJyb3IoImB2YWx1ZWAgcHJvcCBvbiBgJXNgIHNob3VsZCBub3QgYmUgbnVsbC4gQ29uc2lkZXIgdXNpbmcgYW4gZW1wdHkgYXJyYXkgd2hlbiBgbXVsdGlwbGVgIGlzIHNldCB0byBgdHJ1ZWAgdG8gY2xlYXIgdGhlIGNvbXBvbmVudCBvciBgdW5kZWZpbmVkYCBmb3IgdW5jb250cm9sbGVkIGNvbXBvbmVudHMuIiwgdHlwZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCJgdmFsdWVgIHByb3Agb24gYCVzYCBzaG91bGQgbm90IGJlIG51bGwuIENvbnNpZGVyIHVzaW5nIGFuIGVtcHR5IHN0cmluZyB0byBjbGVhciB0aGUgY29tcG9uZW50IG9yIGB1bmRlZmluZWRgIGZvciB1bmNvbnRyb2xsZWQgY29tcG9uZW50cy4iLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHZhbGlkYXRlUHJvcGVydHkkMSA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIHdhcm5lZFByb3BlcnRpZXMkMSA9IHt9OwogICAgICAgICAgdmFyIEVWRU5UX05BTUVfUkVHRVggPSAvXm9uLi87CiAgICAgICAgICB2YXIgSU5WQUxJRF9FVkVOVF9OQU1FX1JFR0VYID0gL15vblteQS1aXS87CiAgICAgICAgICB2YXIgckFSSUEkMSA9IG5ldyBSZWdFeHAoIl4oYXJpYSktWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgICAgdmFyIHJBUklBQ2FtZWwkMSA9IG5ldyBSZWdFeHAoIl4oYXJpYSlbQS1aXVsiICsgQVRUUklCVVRFX05BTUVfQ0hBUiArICJdKiQiKTsKICAgICAgICAgIHZhbGlkYXRlUHJvcGVydHkkMSA9IGZ1bmN0aW9uKHRhZ05hbWUsIG5hbWUsIHZhbHVlLCBldmVudFJlZ2lzdHJ5KSB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFByb3BlcnRpZXMkMSwgbmFtZSkgJiYgd2FybmVkUHJvcGVydGllcyQxW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBpZiAobG93ZXJDYXNlZE5hbWUgPT09ICJvbmZvY3VzaW4iIHx8IGxvd2VyQ2FzZWROYW1lID09PSAib25mb2N1c291dCIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgdXNlcyBvbkZvY3VzIGFuZCBvbkJsdXIgaW5zdGVhZCBvZiBvbkZvY3VzSW4gYW5kIG9uRm9jdXNPdXQuIEFsbCBSZWFjdCBldmVudHMgYXJlIG5vcm1hbGl6ZWQgdG8gYnViYmxlLCBzbyBvbkZvY3VzSW4gYW5kIG9uRm9jdXNPdXQgYXJlIG5vdCBuZWVkZWQvc3VwcG9ydGVkIGJ5IFJlYWN0LiIpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV2ZW50UmVnaXN0cnkgIT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciByZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzMiA9IGV2ZW50UmVnaXN0cnkucmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcywgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lczIgPSBldmVudFJlZ2lzdHJ5LnBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXM7CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMyLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWUgPSBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMi5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkgPyBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMltsb3dlckNhc2VkTmFtZV0gOiBudWxsOwogICAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChFVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJVbmtub3duIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gSXQgd2lsbCBiZSBpZ25vcmVkLiIsIG5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChFVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICBpZiAoSU5WQUxJRF9FVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gUmVhY3QgZXZlbnRzIHVzZSB0aGUgY2FtZWxDYXNlIG5hbWluZyBjb252ZW50aW9uLCBmb3IgZXhhbXBsZSBgb25DbGlja2AuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBJDEudGVzdChuYW1lKSB8fCByQVJJQUNhbWVsJDEudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImlubmVyaHRtbCIpIHsKICAgICAgICAgICAgICBlcnJvcigiRGlyZWN0bHkgc2V0dGluZyBwcm9wZXJ0eSBgaW5uZXJIVE1MYCBpcyBub3QgcGVybWl0dGVkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgbG9va3VwIGRvY3VtZW50YXRpb24gb24gYGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImFyaWEiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBgYXJpYWAgYXR0cmlidXRlIGlzIHJlc2VydmVkIGZvciBmdXR1cmUgdXNlIGluIFJlYWN0LiBQYXNzIGluZGl2aWR1YWwgYGFyaWEtYCBhdHRyaWJ1dGVzIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobG93ZXJDYXNlZE5hbWUgPT09ICJpcyIgJiYgdmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHZvaWQgMCAmJiB0eXBlb2YgdmFsdWUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGEgYCVzYCBmb3IgYSBzdHJpbmcgYXR0cmlidXRlIGBpc2AuIElmIHRoaXMgaXMgZXhwZWN0ZWQsIGNhc3QgdGhlIHZhbHVlIHRvIGEgc3RyaW5nLiIsIHR5cGVvZiB2YWx1ZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiAmJiBpc05hTih2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgTmFOIGZvciB0aGUgYCVzYCBhdHRyaWJ1dGUuIElmIHRoaXMgaXMgZXhwZWN0ZWQsIGNhc3QgdGhlIHZhbHVlIHRvIGEgc3RyaW5nLiIsIG5hbWUpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb3BlcnR5SW5mbyA9IGdldFByb3BlcnR5SW5mbyhuYW1lKTsKICAgICAgICAgICAgdmFyIGlzUmVzZXJ2ZWQgPSBwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEOwogICAgICAgICAgICBpZiAocG9zc2libGVTdGFuZGFyZE5hbWVzLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSkgewogICAgICAgICAgICAgIHZhciBzdGFuZGFyZE5hbWUgPSBwb3NzaWJsZVN0YW5kYXJkTmFtZXNbbG93ZXJDYXNlZE5hbWVdOwogICAgICAgICAgICAgIGlmIChzdGFuZGFyZE5hbWUgIT09IG5hbWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIERPTSBwcm9wZXJ0eSBgJXNgLiBEaWQgeW91IG1lYW4gYCVzYD8iLCBuYW1lLCBzdGFuZGFyZE5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICghaXNSZXNlcnZlZCAmJiBuYW1lICE9PSBsb3dlckNhc2VkTmFtZSkgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBkb2VzIG5vdCByZWNvZ25pemUgdGhlIGAlc2AgcHJvcCBvbiBhIERPTSBlbGVtZW50LiBJZiB5b3UgaW50ZW50aW9uYWxseSB3YW50IGl0IHRvIGFwcGVhciBpbiB0aGUgRE9NIGFzIGEgY3VzdG9tIGF0dHJpYnV0ZSwgc3BlbGwgaXQgYXMgbG93ZXJjYXNlIGAlc2AgaW5zdGVhZC4gSWYgeW91IGFjY2lkZW50YWxseSBwYXNzZWQgaXQgZnJvbSBhIHBhcmVudCBjb21wb25lbnQsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gZWxlbWVudC4iLCBuYW1lLCBsb3dlckNhc2VkTmFtZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgJiYgc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBlcnJvcignUmVjZWl2ZWQgYCVzYCBmb3IgYSBub24tYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC5cblxuSWYgeW91IHdhbnQgdG8gd3JpdGUgaXQgdG8gdGhlIERPTSwgcGFzcyBhIHN0cmluZyBpbnN0ZWFkOiAlcz0iJXMiIG9yICVzPXt2YWx1ZS50b1N0cmluZygpfS4nLCB2YWx1ZSwgbmFtZSwgbmFtZSwgdmFsdWUsIG5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcignUmVjZWl2ZWQgYCVzYCBmb3IgYSBub24tYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC5cblxuSWYgeW91IHdhbnQgdG8gd3JpdGUgaXQgdG8gdGhlIERPTSwgcGFzcyBhIHN0cmluZyBpbnN0ZWFkOiAlcz0iJXMiIG9yICVzPXt2YWx1ZS50b1N0cmluZygpfS5cblxuSWYgeW91IHVzZWQgdG8gY29uZGl0aW9uYWxseSBvbWl0IGl0IHdpdGggJXM9e2NvbmRpdGlvbiAmJiB2YWx1ZX0sIHBhc3MgJXM9e2NvbmRpdGlvbiA/IHZhbHVlIDogdW5kZWZpbmVkfSBpbnN0ZWFkLicsIHZhbHVlLCBuYW1lLCBuYW1lLCB2YWx1ZSwgbmFtZSwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzUmVzZXJ2ZWQpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gImZhbHNlIiB8fCB2YWx1ZSA9PT0gInRydWUiKSAmJiBwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IEJPT0xFQU4pIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgdGhlIHN0cmluZyBgJXNgIGZvciB0aGUgYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC4gJXMgRGlkIHlvdSBtZWFuICVzPXslc30/IiwgdmFsdWUsIG5hbWUsIHZhbHVlID09PSAiZmFsc2UiID8gIlRoZSBicm93c2VyIHdpbGwgaW50ZXJwcmV0IGl0IGFzIGEgdHJ1dGh5IHZhbHVlLiIgOiAnQWx0aG91Z2ggdGhpcyB3b3JrcywgaXQgd2lsbCBub3Qgd29yayBhcyBleHBlY3RlZCBpZiB5b3UgcGFzcyB0aGUgc3RyaW5nICJmYWxzZSIuJywgbmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgd2FyblVua25vd25Qcm9wZXJ0aWVzID0gZnVuY3Rpb24odHlwZSwgcHJvcHMsIGV2ZW50UmVnaXN0cnkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9IHZhbGlkYXRlUHJvcGVydHkkMSh0eXBlLCBrZXksIHByb3BzW2tleV0sIGV2ZW50UmVnaXN0cnkpOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCkgewogICAgICAgICAgICAgICAgdW5rbm93blByb3BzLnB1c2goa2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wU3RyaW5nID0gdW5rbm93blByb3BzLm1hcChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJgIiArIHByb3AgKyAiYCI7CiAgICAgICAgICAgIH0pLmpvaW4oIiwgIik7CiAgICAgICAgICAgIGlmICh1bmtub3duUHJvcHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgdmFsdWUgZm9yIHByb3AgJXMgb24gPCVzPiB0YWcuIEVpdGhlciByZW1vdmUgaXQgZnJvbSB0aGUgZWxlbWVudCwgb3IgcGFzcyBhIHN0cmluZyBvciBudW1iZXIgdmFsdWUgdG8ga2VlcCBpdCBpbiB0aGUgRE9NLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9hdHRyaWJ1dGUtYmVoYXZpb3IgIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHVua25vd25Qcm9wcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgdmFsdWVzIGZvciBwcm9wcyAlcyBvbiA8JXM+IHRhZy4gRWl0aGVyIHJlbW92ZSB0aGVtIGZyb20gdGhlIGVsZW1lbnQsIG9yIHBhc3MgYSBzdHJpbmcgb3IgbnVtYmVyIHZhbHVlIHRvIGtlZXAgdGhlbSBpbiB0aGUgRE9NLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9hdHRyaWJ1dGUtYmVoYXZpb3IgIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnRpZXMkMih0eXBlLCBwcm9wcywgZXZlbnRSZWdpc3RyeSkgewogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuVW5rbm93blByb3BlcnRpZXModHlwZSwgcHJvcHMsIGV2ZW50UmVnaXN0cnkpOwogICAgICAgIH0KICAgICAgICB2YXIgSVNfRVZFTlRfSEFORExFX05PTl9NQU5BR0VEX05PREUgPSAxOwogICAgICAgIHZhciBJU19OT05fREVMRUdBVEVEID0gMSA8PCAxOwogICAgICAgIHZhciBJU19DQVBUVVJFX1BIQVNFID0gMSA8PCAyOwogICAgICAgIHZhciBTSE9VTERfTk9UX1BST0NFU1NfUE9MWUZJTExfRVZFTlRfUExVR0lOUyA9IElTX0VWRU5UX0hBTkRMRV9OT05fTUFOQUdFRF9OT0RFIHwgSVNfTk9OX0RFTEVHQVRFRCB8IElTX0NBUFRVUkVfUEhBU0U7CiAgICAgICAgdmFyIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gc2V0UmVwbGF5aW5nRXZlbnQoZXZlbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRSZXBsYXlpbmdFdmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBjdXJyZW50bHkgcmVwbGF5aW5nIGV2ZW50IHRvIGJlIG51bGwuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IGV2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFJlcGxheWluZ0V2ZW50KCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudFJlcGxheWluZ0V2ZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGN1cnJlbnRseSByZXBsYXlpbmcgZXZlbnQgdG8gbm90IGJlIG51bGwuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVwbGF5aW5nRXZlbnQoZXZlbnQpIHsKICAgICAgICAgIHJldHVybiBldmVudCA9PT0gY3VycmVudFJlcGxheWluZ0V2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIHRhcmdldCA9IG5hdGl2ZUV2ZW50LnRhcmdldCB8fCBuYXRpdmVFdmVudC5zcmNFbGVtZW50IHx8IHdpbmRvdzsKICAgICAgICAgIGlmICh0YXJnZXQuY29ycmVzcG9uZGluZ1VzZUVsZW1lbnQpIHsKICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LmNvcnJlc3BvbmRpbmdVc2VFbGVtZW50OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRhcmdldC5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFID8gdGFyZ2V0LnBhcmVudE5vZGUgOiB0YXJnZXQ7CiAgICAgICAgfQogICAgICAgIHZhciByZXN0b3JlSW1wbCA9IG51bGw7CiAgICAgICAgdmFyIHJlc3RvcmVUYXJnZXQgPSBudWxsOwogICAgICAgIHZhciByZXN0b3JlUXVldWUgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KHRhcmdldCkgewogICAgICAgICAgdmFyIGludGVybmFsSW5zdGFuY2UgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKHRhcmdldCk7CiAgICAgICAgICBpZiAoIWludGVybmFsSW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiByZXN0b3JlSW1wbCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbigpIG5lZWRzIHRvIGJlIGNhbGxlZCB0byBoYW5kbGUgYSB0YXJnZXQgZm9yIGNvbnRyb2xsZWQgZXZlbnRzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IGludGVybmFsSW5zdGFuY2Uuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKHN0YXRlTm9kZSkgewogICAgICAgICAgICB2YXIgX3Byb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShzdGF0ZU5vZGUpOwogICAgICAgICAgICByZXN0b3JlSW1wbChpbnRlcm5hbEluc3RhbmNlLnN0YXRlTm9kZSwgaW50ZXJuYWxJbnN0YW5jZS50eXBlLCBfcHJvcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRSZXN0b3JlSW1wbGVtZW50YXRpb24oaW1wbCkgewogICAgICAgICAgcmVzdG9yZUltcGwgPSBpbXBsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlU3RhdGVSZXN0b3JlKHRhcmdldCkgewogICAgICAgICAgaWYgKHJlc3RvcmVUYXJnZXQpIHsKICAgICAgICAgICAgaWYgKHJlc3RvcmVRdWV1ZSkgewogICAgICAgICAgICAgIHJlc3RvcmVRdWV1ZS5wdXNoKHRhcmdldCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzdG9yZVF1ZXVlID0gW3RhcmdldF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3RvcmVUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5lZWRzU3RhdGVSZXN0b3JlKCkgewogICAgICAgICAgcmV0dXJuIHJlc3RvcmVUYXJnZXQgIT09IG51bGwgfHwgcmVzdG9yZVF1ZXVlICE9PSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlU3RhdGVJZk5lZWRlZCgpIHsKICAgICAgICAgIGlmICghcmVzdG9yZVRhcmdldCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gcmVzdG9yZVRhcmdldDsKICAgICAgICAgIHZhciBxdWV1ZWRUYXJnZXRzID0gcmVzdG9yZVF1ZXVlOwogICAgICAgICAgcmVzdG9yZVRhcmdldCA9IG51bGw7CiAgICAgICAgICByZXN0b3JlUXVldWUgPSBudWxsOwogICAgICAgICAgcmVzdG9yZVN0YXRlT2ZUYXJnZXQodGFyZ2V0KTsKICAgICAgICAgIGlmIChxdWV1ZWRUYXJnZXRzKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWVkVGFyZ2V0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KHF1ZXVlZFRhcmdldHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBiYXRjaGVkVXBkYXRlc0ltcGwgPSBmdW5jdGlvbihmbiwgYm9va2tlZXBpbmcpIHsKICAgICAgICAgIHJldHVybiBmbihib29ra2VlcGluZyk7CiAgICAgICAgfTsKICAgICAgICB2YXIgZmx1c2hTeW5jSW1wbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgdmFyIGlzSW5zaWRlRXZlbnRIYW5kbGVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmluaXNoRXZlbnRIYW5kbGVyKCkgewogICAgICAgICAgdmFyIGNvbnRyb2xsZWRDb21wb25lbnRzSGF2ZVBlbmRpbmdVcGRhdGVzID0gbmVlZHNTdGF0ZVJlc3RvcmUoKTsKICAgICAgICAgIGlmIChjb250cm9sbGVkQ29tcG9uZW50c0hhdmVQZW5kaW5nVXBkYXRlcykgewogICAgICAgICAgICBmbHVzaFN5bmNJbXBsKCk7CiAgICAgICAgICAgIHJlc3RvcmVTdGF0ZUlmTmVlZGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhdGNoZWRVcGRhdGVzKGZuLCBhLCBiKSB7CiAgICAgICAgICBpZiAoaXNJbnNpZGVFdmVudEhhbmRsZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZuKGEsIGIpOwogICAgICAgICAgfQogICAgICAgICAgaXNJbnNpZGVFdmVudEhhbmRsZXIgPSB0cnVlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGJhdGNoZWRVcGRhdGVzSW1wbChmbiwgYSwgYik7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBpc0luc2lkZUV2ZW50SGFuZGxlciA9IGZhbHNlOwogICAgICAgICAgICBmaW5pc2hFdmVudEhhbmRsZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0QmF0Y2hpbmdJbXBsZW1lbnRhdGlvbihfYmF0Y2hlZFVwZGF0ZXNJbXBsLCBfZGlzY3JldGVVcGRhdGVzSW1wbCwgX2ZsdXNoU3luY0ltcGwpIHsKICAgICAgICAgIGJhdGNoZWRVcGRhdGVzSW1wbCA9IF9iYXRjaGVkVXBkYXRlc0ltcGw7CiAgICAgICAgICBmbHVzaFN5bmNJbXBsID0gX2ZsdXNoU3luY0ltcGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzSW50ZXJhY3RpdmUodGFnKSB7CiAgICAgICAgICByZXR1cm4gdGFnID09PSAiYnV0dG9uIiB8fCB0YWcgPT09ICJpbnB1dCIgfHwgdGFnID09PSAic2VsZWN0IiB8fCB0YWcgPT09ICJ0ZXh0YXJlYSI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFByZXZlbnRNb3VzZUV2ZW50KG5hbWUsIHR5cGUsIHByb3BzKSB7CiAgICAgICAgICBzd2l0Y2ggKG5hbWUpIHsKICAgICAgICAgICAgY2FzZSAib25DbGljayI6CiAgICAgICAgICAgIGNhc2UgIm9uQ2xpY2tDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Eb3VibGVDbGljayI6CiAgICAgICAgICAgIGNhc2UgIm9uRG91YmxlQ2xpY2tDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZURvd24iOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRG93bkNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlTW92ZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VNb3ZlQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VVcCI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VVcENhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRW50ZXIiOgogICAgICAgICAgICAgIHJldHVybiAhIShwcm9wcy5kaXNhYmxlZCAmJiBpc0ludGVyYWN0aXZlKHR5cGUpKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExpc3RlbmVyKGluc3QsIHJlZ2lzdHJhdGlvbk5hbWUpIHsKICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSBpbnN0LnN0YXRlTm9kZTsKICAgICAgICAgIGlmIChzdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKHN0YXRlTm9kZSk7CiAgICAgICAgICBpZiAocHJvcHMgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGlzdGVuZXIyID0gcHJvcHNbcmVnaXN0cmF0aW9uTmFtZV07CiAgICAgICAgICBpZiAoc2hvdWxkUHJldmVudE1vdXNlRXZlbnQocmVnaXN0cmF0aW9uTmFtZSwgaW5zdC50eXBlLCBwcm9wcykpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobGlzdGVuZXIyICYmIHR5cGVvZiBsaXN0ZW5lcjIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBgIiArIHJlZ2lzdHJhdGlvbk5hbWUgKyAiYCBsaXN0ZW5lciB0byBiZSBhIGZ1bmN0aW9uLCBpbnN0ZWFkIGdvdCBhIHZhbHVlIG9mIGAiICsgdHlwZW9mIGxpc3RlbmVyMiArICJgIHR5cGUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICB2YXIgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICBpZiAoY2FuVXNlRE9NMikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB7fTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9wdGlvbnMsICJwYXNzaXZlIiwgewogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZChuYW1lLCBmdW5jLCBjb250ZXh0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICB2YXIgZnVuY0FyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDMpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZnVuYy5hcHBseShjb250ZXh0LCBmdW5jQXJncyk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgdGhpcy5vbkVycm9yKGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpbnZva2VHdWFyZGVkQ2FsbGJhY2tJbXBsID0gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZDsKICAgICAgICB7CiAgICAgICAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kaXNwYXRjaEV2ZW50ID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIGRvY3VtZW50LmNyZWF0ZUV2ZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBmYWtlTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInJlYWN0Iik7CiAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwgPSBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tEZXYobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8IGRvY3VtZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBgZG9jdW1lbnRgIGdsb2JhbCB3YXMgZGVmaW5lZCB3aGVuIFJlYWN0IHdhcyBpbml0aWFsaXplZCwgYnV0IGlzIG5vdCBkZWZpbmVkIGFueW1vcmUuIFRoaXMgY2FuIGhhcHBlbiBpbiBhIHRlc3QgZW52aXJvbm1lbnQgaWYgYSBjb21wb25lbnQgc2NoZWR1bGVzIGFuIHVwZGF0ZSBmcm9tIGFuIGFzeW5jaHJvbm91cyBjYWxsYmFjaywgYnV0IHRoZSB0ZXN0IGhhcyBhbHJlYWR5IGZpbmlzaGVkIHJ1bm5pbmcuIFRvIHNvbHZlIHRoaXMsIHlvdSBjYW4gZWl0aGVyIHVubW91bnQgdGhlIGNvbXBvbmVudCBhdCB0aGUgZW5kIG9mIHlvdXIgdGVzdCAoYW5kIGVuc3VyZSB0aGF0IGFueSBhc3luY2hyb25vdXMgb3BlcmF0aW9ucyBnZXQgY2FuY2VsZWQgaW4gYGNvbXBvbmVudFdpbGxVbm1vdW50YCksIG9yIHlvdSBjYW4gY2hhbmdlIHRoZSB0ZXN0IGl0c2VsZiB0byBiZSBhc3luY2hyb25vdXMuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBldnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiRXZlbnQiKTsKICAgICAgICAgICAgICB2YXIgZGlkQ2FsbCA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciBkaWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIHdpbmRvd0V2ZW50ID0gd2luZG93LmV2ZW50OwogICAgICAgICAgICAgIHZhciB3aW5kb3dFdmVudERlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHdpbmRvdywgImV2ZW50Iik7CiAgICAgICAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUFmdGVyRGlzcGF0Y2goKSB7CiAgICAgICAgICAgICAgICBmYWtlTm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKGV2dFR5cGUsIGNhbGxDYWxsYmFjazIsIGZhbHNlKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygd2luZG93LmV2ZW50ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuaGFzT3duUHJvcGVydHkoImV2ZW50IikpIHsKICAgICAgICAgICAgICAgICAgd2luZG93LmV2ZW50ID0gd2luZG93RXZlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBmdW5jQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMyk7CiAgICAgICAgICAgICAgZnVuY3Rpb24gY2FsbENhbGxiYWNrMigpIHsKICAgICAgICAgICAgICAgIGRpZENhbGwgPSB0cnVlOwogICAgICAgICAgICAgICAgcmVzdG9yZUFmdGVyRGlzcGF0Y2goKTsKICAgICAgICAgICAgICAgIGZ1bmMuYXBwbHkoY29udGV4dCwgZnVuY0FyZ3MpOwogICAgICAgICAgICAgICAgZGlkRXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGVycm9yMjsKICAgICAgICAgICAgICB2YXIgZGlkU2V0RXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgaXNDcm9zc09yaWdpbkVycm9yID0gZmFsc2U7CiAgICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlV2luZG93RXJyb3IoZXZlbnQpIHsKICAgICAgICAgICAgICAgIGVycm9yMiA9IGV2ZW50LmVycm9yOwogICAgICAgICAgICAgICAgZGlkU2V0RXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKGVycm9yMiA9PT0gbnVsbCAmJiBldmVudC5jb2xubyA9PT0gMCAmJiBldmVudC5saW5lbm8gPT09IDApIHsKICAgICAgICAgICAgICAgICAgaXNDcm9zc09yaWdpbkVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChldmVudC5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChlcnJvcjIgIT0gbnVsbCAmJiB0eXBlb2YgZXJyb3IyID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcjIuX3N1cHByZXNzTG9nZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoaW5uZXIpIHsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGV2dFR5cGUgPSAicmVhY3QtIiArIChuYW1lID8gbmFtZSA6ICJpbnZva2VndWFyZGVkY2FsbGJhY2siKTsKICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBoYW5kbGVXaW5kb3dFcnJvcik7CiAgICAgICAgICAgICAgZmFrZU5vZGUuYWRkRXZlbnRMaXN0ZW5lcihldnRUeXBlLCBjYWxsQ2FsbGJhY2syLCBmYWxzZSk7CiAgICAgICAgICAgICAgZXZ0LmluaXRFdmVudChldnRUeXBlLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICAgIGZha2VOb2RlLmRpc3BhdGNoRXZlbnQoZXZ0KTsKICAgICAgICAgICAgICBpZiAod2luZG93RXZlbnREZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LCAiZXZlbnQiLCB3aW5kb3dFdmVudERlc2NyaXB0b3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGlkQ2FsbCAmJiBkaWRFcnJvcikgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTZXRFcnJvcikgewogICAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IoYEFuIGVycm9yIHdhcyB0aHJvd24gaW5zaWRlIG9uZSBvZiB5b3VyIGNvbXBvbmVudHMsIGJ1dCBSZWFjdCBkb2Vzbid0IGtub3cgd2hhdCBpdCB3YXMuIFRoaXMgaXMgbGlrZWx5IGR1ZSB0byBicm93c2VyIGZsYWtpbmVzcy4gUmVhY3QgZG9lcyBpdHMgYmVzdCB0byBwcmVzZXJ2ZSB0aGUgIlBhdXNlIG9uIGV4Y2VwdGlvbnMiIGJlaGF2aW9yIG9mIHRoZSBEZXZUb29scywgd2hpY2ggcmVxdWlyZXMgc29tZSBERVYtbW9kZSBvbmx5IHRyaWNrcy4gSXQncyBwb3NzaWJsZSB0aGF0IHRoZXNlIGRvbid0IHdvcmsgaW4geW91ciBicm93c2VyLiBUcnkgdHJpZ2dlcmluZyB0aGUgZXJyb3IgaW4gcHJvZHVjdGlvbiBtb2RlLCBvciBzd2l0Y2hpbmcgdG8gYSBtb2Rlcm4gYnJvd3Nlci4gSWYgeW91IHN1c3BlY3QgdGhhdCB0aGlzIGlzIGFjdHVhbGx5IGFuIGlzc3VlIHdpdGggUmVhY3QsIHBsZWFzZSBmaWxlIGFuIGlzc3VlLmApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0Nyb3NzT3JpZ2luRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKCJBIGNyb3NzLW9yaWdpbiBlcnJvciB3YXMgdGhyb3duLiBSZWFjdCBkb2Vzbid0IGhhdmUgYWNjZXNzIHRvIHRoZSBhY3R1YWwgZXJyb3Igb2JqZWN0IGluIGRldmVsb3BtZW50LiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Nyb3Nzb3JpZ2luLWVycm9yIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5vbkVycm9yKGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJlcnJvciIsIGhhbmRsZVdpbmRvd0Vycm9yKTsKICAgICAgICAgICAgICBpZiAoIWRpZENhbGwpIHsKICAgICAgICAgICAgICAgIHJlc3RvcmVBZnRlckRpc3BhdGNoKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwkMSA9IGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGw7CiAgICAgICAgdmFyIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgdmFyIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICB2YXIgaGFzUmV0aHJvd0Vycm9yID0gZmFsc2U7CiAgICAgICAgdmFyIHJldGhyb3dFcnJvciA9IG51bGw7CiAgICAgICAgdmFyIHJlcG9ydGVyID0gewogICAgICAgICAgb25FcnJvcjogZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICAgIGhhc0Vycm9yID0gdHJ1ZTsKICAgICAgICAgICAgY2F1Z2h0RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2sobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICAgIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwkMS5hcHBseShyZXBvcnRlciwgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgaWYgKGhhc0Vycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSBjbGVhckNhdWdodEVycm9yKCk7CiAgICAgICAgICAgIGlmICghaGFzUmV0aHJvd0Vycm9yKSB7CiAgICAgICAgICAgICAgaGFzUmV0aHJvd0Vycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICByZXRocm93RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0aHJvd0NhdWdodEVycm9yKCkgewogICAgICAgICAgaWYgKGhhc1JldGhyb3dFcnJvcikgewogICAgICAgICAgICB2YXIgZXJyb3IyID0gcmV0aHJvd0Vycm9yOwogICAgICAgICAgICBoYXNSZXRocm93RXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgcmV0aHJvd0Vycm9yID0gbnVsbDsKICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNDYXVnaHRFcnJvcigpIHsKICAgICAgICAgIHJldHVybiBoYXNFcnJvcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xlYXJDYXVnaHRFcnJvcigpIHsKICAgICAgICAgIGlmIChoYXNFcnJvcikgewogICAgICAgICAgICB2YXIgZXJyb3IyID0gY2F1Z2h0RXJyb3I7CiAgICAgICAgICAgIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgICAgIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIGVycm9yMjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2xlYXJDYXVnaHRFcnJvciB3YXMgY2FsbGVkIGJ1dCBubyBlcnJvciB3YXMgY2FwdHVyZWQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldDYoa2V5KSB7CiAgICAgICAgICByZXR1cm4ga2V5Ll9yZWFjdEludGVybmFsczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzMyhrZXkpIHsKICAgICAgICAgIHJldHVybiBrZXkuX3JlYWN0SW50ZXJuYWxzICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldDMoa2V5LCB2YWx1ZSkgewogICAgICAgICAga2V5Ll9yZWFjdEludGVybmFscyA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICB2YXIgTm9GbGFncyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgUGVyZm9ybWVkV29yayA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgUGxhY2VtZW50ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgVXBkYXRlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgQ2hpbGREZWxldGlvbiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNgogICAgICAgICk7CiAgICAgICAgdmFyIENvbnRlbnRSZXNldCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzIKICAgICAgICApOwogICAgICAgIHZhciBDYWxsYmFjayA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY0CiAgICAgICAgKTsKICAgICAgICB2YXIgRGlkQ2FwdHVyZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMjgKICAgICAgICApOwogICAgICAgIHZhciBGb3JjZUNsaWVudFJlbmRlciA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgKi8KICAgICAgICAgIDI1NgogICAgICAgICk7CiAgICAgICAgdmFyIFJlZjIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDUxMgogICAgICAgICk7CiAgICAgICAgdmFyIFNuYXBzaG90ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTAyNAogICAgICAgICk7CiAgICAgICAgdmFyIFBhc3NpdmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA0OAogICAgICAgICk7CiAgICAgICAgdmFyIEh5ZHJhdGluZyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDA5NgogICAgICAgICk7CiAgICAgICAgdmFyIFZpc2liaWxpdHkgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgODE5MgogICAgICAgICk7CiAgICAgICAgdmFyIFN0b3JlQ29uc2lzdGVuY3kgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgMTYzODQKICAgICAgICApOwogICAgICAgIHZhciBMaWZlY3ljbGVFZmZlY3RNYXNrID0gUGFzc2l2ZSB8IFVwZGF0ZSB8IENhbGxiYWNrIHwgUmVmMiB8IFNuYXBzaG90IHwgU3RvcmVDb25zaXN0ZW5jeTsKICAgICAgICB2YXIgSG9zdEVmZmVjdE1hc2sgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2NwogICAgICAgICk7CiAgICAgICAgdmFyIEluY29tcGxldGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzI3NjgKICAgICAgICApOwogICAgICAgIHZhciBTaG91bGRDYXB0dXJlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY1NTM2CiAgICAgICAgKTsKICAgICAgICB2YXIgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSA9ICgKICAgICAgICAgIC8qICovCiAgICAgICAgICAxMzEwNzIKICAgICAgICApOwogICAgICAgIHZhciBGb3JrZWQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwNDg1NzYKICAgICAgICApOwogICAgICAgIHZhciBSZWZTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwOTcxNTIKICAgICAgICApOwogICAgICAgIHZhciBMYXlvdXRTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQzMDQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlU3RhdGljID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgzODg2MDgKICAgICAgICApOwogICAgICAgIHZhciBNb3VudExheW91dERldiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2Nzc3MjE2CiAgICAgICAgKTsKICAgICAgICB2YXIgTW91bnRQYXNzaXZlRGV2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICovCiAgICAgICAgICAzMzU1NDQzMgogICAgICAgICk7CiAgICAgICAgdmFyIEJlZm9yZU11dGF0aW9uTWFzayA9ICgKICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSBVcGRhdGUgZmxhZyBmcm9tIGJlZm9yZSBtdXRhdGlvbiBwaGFzZSBieSByZS1sYW5kaW5nIFZpc2liaWxpdHkKICAgICAgICAgIC8vIGZsYWcgbG9naWMgKHNlZSAjMjAwNDMpCiAgICAgICAgICBVcGRhdGUgfCBTbmFwc2hvdCB8IDAKICAgICAgICApOwogICAgICAgIHZhciBNdXRhdGlvbk1hc2sgPSBQbGFjZW1lbnQgfCBVcGRhdGUgfCBDaGlsZERlbGV0aW9uIHwgQ29udGVudFJlc2V0IHwgUmVmMiB8IEh5ZHJhdGluZyB8IFZpc2liaWxpdHk7CiAgICAgICAgdmFyIExheW91dE1hc2sgPSBVcGRhdGUgfCBDYWxsYmFjayB8IFJlZjIgfCBWaXNpYmlsaXR5OwogICAgICAgIHZhciBQYXNzaXZlTWFzayA9IFBhc3NpdmUgfCBDaGlsZERlbGV0aW9uOwogICAgICAgIHZhciBTdGF0aWNNYXNrID0gTGF5b3V0U3RhdGljIHwgUGFzc2l2ZVN0YXRpYyB8IFJlZlN0YXRpYzsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICBmdW5jdGlvbiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgdmFyIG5lYXJlc3RNb3VudGVkID0gZmliZXI7CiAgICAgICAgICBpZiAoIWZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICB2YXIgbmV4dE5vZGUgPSBub2RlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgbm9kZSA9IG5leHROb2RlOwogICAgICAgICAgICAgIGlmICgobm9kZS5mbGFncyAmIChQbGFjZW1lbnQgfCBIeWRyYXRpbmcpKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgbmVhcmVzdE1vdW50ZWQgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbmV4dE5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfSB3aGlsZSAobmV4dE5vZGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2hpbGUgKG5vZGUucmV0dXJuKSB7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHJldHVybiBuZWFyZXN0TW91bnRlZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5zZUluc3RhbmNlRnJvbUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRhaW5lckZyb21GaWJlcihmaWJlcikgewogICAgICAgICAgcmV0dXJuIGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QgPyBmaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRmliZXJNb3VudGVkKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcihmaWJlcikgPT09IGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc01vdW50ZWQoY29tcG9uZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25lciA9IFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyRmliZXIgPSBvd25lcjsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBvd25lckZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoIWluc3RhbmNlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlcikgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGlzIGFjY2Vzc2luZyBpc01vdW50ZWQgaW5zaWRlIGl0cyByZW5kZXIoKSBmdW5jdGlvbi4gcmVuZGVyKCkgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIEl0IHNob3VsZCBuZXZlciBhY2Nlc3Mgc29tZXRoaW5nIHRoYXQgcmVxdWlyZXMgc3RhbGUgZGF0YSBmcm9tIHRoZSBwcmV2aW91cyByZW5kZXIsIHN1Y2ggYXMgcmVmcy4gTW92ZSB0aGlzIGxvZ2ljIHRvIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnREaWRVcGRhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKG93bmVyRmliZXIpIHx8ICJBIGNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpbnN0YW5jZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ2KGNvbXBvbmVudCk7CiAgICAgICAgICBpZiAoIWZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSA9PT0gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFzc2VydElzTW91bnRlZChmaWJlcikgewogICAgICAgICAgaWYgKGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpICE9PSBmaWJlcikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoIWFsdGVybmF0ZSkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkICE9PSBmaWJlcikgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhID0gZmliZXI7CiAgICAgICAgICB2YXIgYiA9IGFsdGVybmF0ZTsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRBID0gYS5yZXR1cm47CiAgICAgICAgICAgIGlmIChwYXJlbnRBID09PSBudWxsKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBhcmVudEIgPSBwYXJlbnRBLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKHBhcmVudEIgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV4dFBhcmVudCA9IHBhcmVudEEucmV0dXJuOwogICAgICAgICAgICAgIGlmIChuZXh0UGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhID0gYiA9IG5leHRQYXJlbnQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhcmVudEEuY2hpbGQgPT09IHBhcmVudEIuY2hpbGQpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnRBLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCkgewogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGEucmV0dXJuICE9PSBiLnJldHVybikgewogICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBkaWRGaW5kQ2hpbGQgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgX2NoaWxkID0gcGFyZW50QS5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBiID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBhID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfY2hpbGQgPSBfY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgIF9jaGlsZCA9IHBhcmVudEIuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGEpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDaGlsZCB3YXMgbm90IGZvdW5kIGluIGVpdGhlciBwYXJlbnQgc2V0LiBUaGlzIGluZGljYXRlcyBhIGJ1ZyBpbiBSZWFjdCByZWxhdGVkIHRvIHRoZSByZXR1cm4gcG9pbnRlci4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhLmFsdGVybmF0ZSAhPT0gYikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmV0dXJuIGZpYmVycyBzaG91bGQgYWx3YXlzIGJlIGVhY2ggb3RoZXJzJyBhbHRlcm5hdGVzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYS50YWcgIT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGEuc3RhdGVOb2RlLmN1cnJlbnQgPT09IGEpIHsKICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXIocGFyZW50KSB7CiAgICAgICAgICB2YXIgY3VycmVudFBhcmVudCA9IGZpbmRDdXJyZW50RmliZXJVc2luZ1Nsb3dQYXRoKHBhcmVudCk7CiAgICAgICAgICByZXR1cm4gY3VycmVudFBhcmVudCAhPT0gbnVsbCA/IGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChub2RlKSB7CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgbm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBmaW5kQ3VycmVudEhvc3RGaWJlckltcGwoY2hpbGQpOwogICAgICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFscyhwYXJlbnQpIHsKICAgICAgICAgIHZhciBjdXJyZW50UGFyZW50ID0gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgocGFyZW50KTsKICAgICAgICAgIHJldHVybiBjdXJyZW50UGFyZW50ICE9PSBudWxsID8gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzSW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwobm9kZSkgewogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyAhPT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgIHZhciBtYXRjaCA9IGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwoY2hpbGQpOwogICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIHNjaGVkdWxlQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICB2YXIgY2FuY2VsQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfY2FuY2VsQ2FsbGJhY2s7CiAgICAgICAgdmFyIHNob3VsZFlpZWxkID0gU2NoZWR1bGVyLnVuc3RhYmxlX3Nob3VsZFlpZWxkOwogICAgICAgIHZhciByZXF1ZXN0UGFpbnQgPSBTY2hlZHVsZXIudW5zdGFibGVfcmVxdWVzdFBhaW50OwogICAgICAgIHZhciBub3cgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgIHZhciBnZXRDdXJyZW50UHJpb3JpdHlMZXZlbCA9IFNjaGVkdWxlci51bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfSW1tZWRpYXRlUHJpb3JpdHk7CiAgICAgICAgdmFyIFVzZXJCbG9ja2luZ1ByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX1VzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgIHZhciBOb3JtYWxQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eTsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfTG93UHJpb3JpdHk7CiAgICAgICAgdmFyIElkbGVQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9JZGxlUHJpb3JpdHk7CiAgICAgICAgdmFyIHVuc3RhYmxlX3lpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfeWllbGRWYWx1ZTsKICAgICAgICB2YXIgdW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWU7CiAgICAgICAgdmFyIHJlbmRlcmVySUQgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZEhvb2sgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZFByb2ZpbGluZ0hvb2tzID0gbnVsbDsKICAgICAgICB2YXIgaGFzTG9nZ2VkRXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgaXNEZXZUb29sc1ByZXNlbnQgPSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIjsKICAgICAgICBmdW5jdGlvbiBpbmplY3RJbnRlcm5hbHMoaW50ZXJuYWxzMikgewogICAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBob29rID0gX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fOwogICAgICAgICAgaWYgKGhvb2suaXNEaXNhYmxlZCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaG9vay5zdXBwb3J0c0ZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGluc3RhbGxlZCB2ZXJzaW9uIG9mIFJlYWN0IERldlRvb2xzIGlzIHRvbyBvbGQgYW5kIHdpbGwgbm90IHdvcmsgd2l0aCB0aGUgY3VycmVudCB2ZXJzaW9uIG9mIFJlYWN0LiBQbGVhc2UgdXBkYXRlIFJlYWN0IERldlRvb2xzLiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtZGV2dG9vbHMiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChlbmFibGVTY2hlZHVsaW5nUHJvZmlsZXIpIHsKICAgICAgICAgICAgICBpbnRlcm5hbHMyID0gYXNzaWduMih7fSwgaW50ZXJuYWxzMiwgewogICAgICAgICAgICAgICAgZ2V0TGFuZUxhYmVsTWFwLAogICAgICAgICAgICAgICAgaW5qZWN0UHJvZmlsaW5nSG9va3MKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZW5kZXJlcklEID0gaG9vay5pbmplY3QoaW50ZXJuYWxzMik7CiAgICAgICAgICAgIGluamVjdGVkSG9vayA9IGhvb2s7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzLiIsIGVycik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChob29rLmNoZWNrRENFKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvblNjaGVkdWxlUm9vdChyb290MywgY2hpbGRyZW4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uU2NoZWR1bGVGaWJlclJvb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uU2NoZWR1bGVGaWJlclJvb3QocmVuZGVyZXJJRCwgcm9vdDMsIGNoaWxkcmVuKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uQ29tbWl0Um9vdChyb290MywgZXZlbnRQcmlvcml0eSkgewogICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJSb290ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIGRpZEVycm9yID0gKHJvb3QzLmN1cnJlbnQuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICBpZiAoZW5hYmxlUHJvZmlsZXJUaW1lcikgewogICAgICAgICAgICAgICAgdmFyIHNjaGVkdWxlclByaW9yaXR5OwogICAgICAgICAgICAgICAgc3dpdGNoIChldmVudFByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgRGlzY3JldGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gSW1tZWRpYXRlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgQ29udGludW91c0V2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBVc2VyQmxvY2tpbmdQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBEZWZhdWx0RXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIElkbGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gSWRsZVByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclJvb3QocmVuZGVyZXJJRCwgcm9vdDMsIHNjaGVkdWxlclByaW9yaXR5LCBkaWRFcnJvcik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyUm9vdChyZW5kZXJlcklELCByb290Mywgdm9pZCAwLCBkaWRFcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvblBvc3RDb21taXRSb290KHJvb3QzKSB7CiAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2sub25Qb3N0Q29tbWl0RmliZXJSb290ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uUG9zdENvbW1pdEZpYmVyUm9vdChyZW5kZXJlcklELCByb290Myk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uQ29tbWl0VW5tb3VudChmaWJlcikgewogICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJVbm1vdW50KHJlbmRlcmVySUQsIGZpYmVyKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMobmV3SXNTdHJpY3RNb2RlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdW5zdGFibGVfeWllbGRWYWx1ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHVuc3RhYmxlX3NldERpc2FibGVZaWVsZFZhbHVlKG5ld0lzU3RyaWN0TW9kZSk7CiAgICAgICAgICAgICAgc2V0U3VwcHJlc3NXYXJuaW5nKG5ld0lzU3RyaWN0TW9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLnNldFN0cmljdE1vZGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLnNldFN0cmljdE1vZGUocmVuZGVyZXJJRCwgbmV3SXNTdHJpY3RNb2RlKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5qZWN0UHJvZmlsaW5nSG9va3MocHJvZmlsaW5nSG9va3MpIHsKICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MgPSBwcm9maWxpbmdIb29rczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGFuZUxhYmVsTWFwKCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgbWFwMyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMTsKICAgICAgICAgICAgZm9yICh2YXIgaW5kZXgyID0gMDsgaW5kZXgyIDwgVG90YWxMYW5lczsgaW5kZXgyKyspIHsKICAgICAgICAgICAgICB2YXIgbGFiZWwgPSBnZXRMYWJlbEZvckxhbmUobGFuZSk7CiAgICAgICAgICAgICAgbWFwMy5zZXQobGFuZSwgbGFiZWwpOwogICAgICAgICAgICAgIGxhbmUgKj0gMjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWFwMzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbW1pdFN0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tbWl0U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudEVycm9yZWQoZmliZXIsIHRocm93blZhbHVlLCBsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50RXJyb3JlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudEVycm9yZWQoZmliZXIsIHRocm93blZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFN1c3BlbmRlZChmaWJlciwgd2FrZWFibGUsIGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRTdXNwZW5kZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRTdXNwZW5kZWQoZmliZXIsIHdha2VhYmxlLCBsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0xheW91dEVmZmVjdHNTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtMYXlvdXRFZmZlY3RzU3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Bhc3NpdmVFZmZlY3RzU3RhcnRlZChsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUGFzc2l2ZUVmZmVjdHNTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUGFzc2l2ZUVmZmVjdHNTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUGFzc2l2ZUVmZmVjdHNTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlbmRlclN0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVuZGVyWWllbGRlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlcllpZWxkZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJZaWVsZGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlbmRlclN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJTY2hlZHVsZWQobGFuZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU2NoZWR1bGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU2NoZWR1bGVkKGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtGb3JjZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrRm9yY2VVcGRhdGVTY2hlZHVsZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtGb3JjZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTm9Nb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBDb25jdXJyZW50TW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIFByb2ZpbGVNb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgU3RyaWN0TGVnYWN5TW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgKICAgICAgICApOwogICAgICAgIHZhciBTdHJpY3RFZmZlY3RzTW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAqLwogICAgICAgICAgMTYKICAgICAgICApOwogICAgICAgIHZhciBjbHozMiA9IE1hdGguY2x6MzIgPyBNYXRoLmNsejMyIDogY2x6MzJGYWxsYmFjazsKICAgICAgICB2YXIgbG9nMiA9IE1hdGgubG9nOwogICAgICAgIHZhciBMTjIgPSBNYXRoLkxOMjsKICAgICAgICBmdW5jdGlvbiBjbHozMkZhbGxiYWNrKHgyKSB7CiAgICAgICAgICB2YXIgYXNVaW50ID0geDIgPj4+IDA7CiAgICAgICAgICBpZiAoYXNVaW50ID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiAzMjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAzMSAtIChsb2cyKGFzVWludCkgLyBMTjIgfCAwKSB8IDA7CiAgICAgICAgfQogICAgICAgIHZhciBUb3RhbExhbmVzID0gMzE7CiAgICAgICAgdmFyIE5vTGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgTm9MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgU3luY0xhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgSW5wdXRDb250aW51b3VzTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgRGVmYXVsdEh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICovCiAgICAgICAgICA4CiAgICAgICAgKTsKICAgICAgICB2YXIgRGVmYXVsdExhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0MTk0MjQwCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMjgKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNTYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MTIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDI0CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA0OAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQwOTYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTggPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA4MTkyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU5ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTYzODQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEwID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2OAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTEgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY1NTM2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTMxMDcyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjYyMTQ0CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxNCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNTI0Mjg4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxNSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTA0ODU3NgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTYgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwOTcxNTIKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEzMDAyMzQyNAogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTEgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQzMDQKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmUyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA4Mzg4NjA4CiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lMyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTY3NzcyMTYKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmU0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMzU1NDQzMgogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY3MTA4ODY0CiAgICAgICAgKTsKICAgICAgICB2YXIgU29tZVJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgdmFyIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAqLwogICAgICAgICAgMTM0MjE3NzI4CiAgICAgICAgKTsKICAgICAgICB2YXIgTm9uSWRsZUxhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNjg0MzU0NTUKICAgICAgICApOwogICAgICAgIHZhciBJZGxlSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI2ODQzNTQ1NgogICAgICAgICk7CiAgICAgICAgdmFyIElkbGVMYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNTM2ODcwOTEyCiAgICAgICAgKTsKICAgICAgICB2YXIgT2Zmc2NyZWVuTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDczNzQxODI0CiAgICAgICAgKTsKICAgICAgICBmdW5jdGlvbiBnZXRMYWJlbEZvckxhbmUobGFuZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAobGFuZSAmIFN5bmNMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJTeW5jIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIklucHV0Q29udGludW91c0h5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJbnB1dENvbnRpbnVvdXNMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJbnB1dENvbnRpbnVvdXMiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgRGVmYXVsdEh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIkRlZmF1bHRIeWRyYXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgRGVmYXVsdExhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIkRlZmF1bHQiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlRyYW5zaXRpb25IeWRyYXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgVHJhbnNpdGlvbkxhbmVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJUcmFuc2l0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIFJldHJ5TGFuZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gIlJldHJ5IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlNlbGVjdGl2ZUh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJZGxlSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSWRsZUh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJZGxlTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSWRsZSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBPZmZzY3JlZW5MYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJPZmZzY3JlZW4iOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBOb1RpbWVzdGFtcCA9IC0xOwogICAgICAgIHZhciBuZXh0VHJhbnNpdGlvbkxhbmUgPSBUcmFuc2l0aW9uTGFuZTE7CiAgICAgICAgdmFyIG5leHRSZXRyeUxhbmUgPSBSZXRyeUxhbmUxOwogICAgICAgIGZ1bmN0aW9uIGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKGxhbmVzKSB7CiAgICAgICAgICBzd2l0Y2ggKGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpKSB7CiAgICAgICAgICAgIGNhc2UgU3luY0xhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIFN5bmNMYW5lOwogICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSW5wdXRDb250aW51b3VzTGFuZTsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0SHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdExhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRMYW5lOwogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTc6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lOToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEwOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE2OgogICAgICAgICAgICAgIHJldHVybiBsYW5lcyAmIFRyYW5zaXRpb25MYW5lczsKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgcmV0dXJuIGxhbmVzICYgUmV0cnlMYW5lczsKICAgICAgICAgICAgY2FzZSBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIElkbGVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBJZGxlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBJZGxlTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSWRsZUxhbmU7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuTGFuZToKICAgICAgICAgICAgICByZXR1cm4gT2Zmc2NyZWVuTGFuZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiU2hvdWxkIGhhdmUgZm91bmQgbWF0Y2hpbmcgbGFuZXMuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBsYW5lczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dExhbmVzKHJvb3QzLCB3aXBMYW5lcykgewogICAgICAgICAgdmFyIHBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIGlmIChwZW5kaW5nTGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgdmFyIHBpbmdlZExhbmVzID0gcm9vdDMucGluZ2VkTGFuZXM7CiAgICAgICAgICB2YXIgbm9uSWRsZVBlbmRpbmdMYW5lcyA9IHBlbmRpbmdMYW5lcyAmIE5vbklkbGVMYW5lczsKICAgICAgICAgIGlmIChub25JZGxlUGVuZGluZ0xhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHZhciBub25JZGxlVW5ibG9ja2VkTGFuZXMgPSBub25JZGxlUGVuZGluZ0xhbmVzICYgfnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICBpZiAobm9uSWRsZVVuYmxvY2tlZExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobm9uSWRsZVVuYmxvY2tlZExhbmVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgbm9uSWRsZVBpbmdlZExhbmVzID0gbm9uSWRsZVBlbmRpbmdMYW5lcyAmIHBpbmdlZExhbmVzOwogICAgICAgICAgICAgIGlmIChub25JZGxlUGluZ2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKG5vbklkbGVQaW5nZWRMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdW5ibG9ja2VkTGFuZXMgPSBwZW5kaW5nTGFuZXMgJiB+c3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgIGlmICh1bmJsb2NrZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKHVuYmxvY2tlZExhbmVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAocGluZ2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKHBpbmdlZExhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXh0TGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod2lwTGFuZXMgIT09IE5vTGFuZXMgJiYgd2lwTGFuZXMgIT09IG5leHRMYW5lcyAmJiAvLyBJZiB3ZSBhbHJlYWR5IHN1c3BlbmRlZCB3aXRoIGEgZGVsYXksIHRoZW4gaW50ZXJydXB0aW5nIGlzIGZpbmUuIERvbid0CiAgICAgICAgICAvLyBib3RoZXIgd2FpdGluZyB1bnRpbCB0aGUgcm9vdCBpcyBjb21wbGV0ZS4KICAgICAgICAgICh3aXBMYW5lcyAmIHN1c3BlbmRlZExhbmVzKSA9PT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgbmV4dExhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKG5leHRMYW5lcyk7CiAgICAgICAgICAgIHZhciB3aXBMYW5lID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZSh3aXBMYW5lcyk7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAvLyBUZXN0cyB3aGV0aGVyIHRoZSBuZXh0IGxhbmUgaXMgZXF1YWwgb3IgbG93ZXIgcHJpb3JpdHkgdGhhbiB0aGUgd2lwCiAgICAgICAgICAgICAgLy8gb25lLiBUaGlzIHdvcmtzIGJlY2F1c2UgdGhlIGJpdHMgZGVjcmVhc2UgaW4gcHJpb3JpdHkgYXMgeW91IGdvIGxlZnQuCiAgICAgICAgICAgICAgbmV4dExhbmUgPj0gd2lwTGFuZSB8fCAvLyBEZWZhdWx0IHByaW9yaXR5IHVwZGF0ZXMgc2hvdWxkIG5vdCBpbnRlcnJ1cHQgdHJhbnNpdGlvbiB1cGRhdGVzLiBUaGUKICAgICAgICAgICAgICAvLyBvbmx5IGRpZmZlcmVuY2UgYmV0d2VlbiBkZWZhdWx0IHVwZGF0ZXMgYW5kIHRyYW5zaXRpb24gdXBkYXRlcyBpcyB0aGF0CiAgICAgICAgICAgICAgLy8gZGVmYXVsdCB1cGRhdGVzIGRvIG5vdCBzdXBwb3J0IHJlZnJlc2ggdHJhbnNpdGlvbnMuCiAgICAgICAgICAgICAgbmV4dExhbmUgPT09IERlZmF1bHRMYW5lICYmICh3aXBMYW5lICYgVHJhbnNpdGlvbkxhbmVzKSAhPT0gTm9MYW5lcwogICAgICAgICAgICApIHsKICAgICAgICAgICAgICByZXR1cm4gd2lwTGFuZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICgobmV4dExhbmVzICYgSW5wdXRDb250aW51b3VzTGFuZSkgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgbmV4dExhbmVzIHw9IHBlbmRpbmdMYW5lcyAmIERlZmF1bHRMYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGVudGFuZ2xlZExhbmVzID0gcm9vdDMuZW50YW5nbGVkTGFuZXM7CiAgICAgICAgICBpZiAoZW50YW5nbGVkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgdmFyIGVudGFuZ2xlbWVudHMgPSByb290My5lbnRhbmdsZW1lbnRzOwogICAgICAgICAgICB2YXIgbGFuZXMgPSBuZXh0TGFuZXMgJiBlbnRhbmdsZWRMYW5lczsKICAgICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICAgIG5leHRMYW5lcyB8PSBlbnRhbmdsZW1lbnRzW2luZGV4Ml07CiAgICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXh0TGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE1vc3RSZWNlbnRFdmVudFRpbWUocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lcyA9IHJvb3QzLmV2ZW50VGltZXM7CiAgICAgICAgICB2YXIgbW9zdFJlY2VudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSBldmVudFRpbWVzW2luZGV4Ml07CiAgICAgICAgICAgIGlmIChldmVudFRpbWUgPiBtb3N0UmVjZW50RXZlbnRUaW1lKSB7CiAgICAgICAgICAgICAgbW9zdFJlY2VudEV2ZW50VGltZSA9IGV2ZW50VGltZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtb3N0UmVjZW50RXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wdXRlRXhwaXJhdGlvblRpbWUobGFuZSwgY3VycmVudFRpbWUpIHsKICAgICAgICAgIHN3aXRjaCAobGFuZSkgewogICAgICAgICAgICBjYXNlIFN5bmNMYW5lOgogICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFRpbWUgKyAyNTA7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdEh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdExhbmU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTY6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU3OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lODoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTk6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTExOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNjoKICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFRpbWUgKyA1ZTM7CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMToKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUyOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTM6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNDoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU1OgogICAgICAgICAgICAgIHJldHVybiBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgY2FzZSBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICBjYXNlIElkbGVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVycm9yKCJTaG91bGQgaGF2ZSBmb3VuZCBtYXRjaGluZyBsYW5lcy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrU3RhcnZlZExhbmVzQXNFeHBpcmVkKHJvb3QzLCBjdXJyZW50VGltZSkgewogICAgICAgICAgdmFyIHBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgdmFyIHBpbmdlZExhbmVzID0gcm9vdDMucGluZ2VkTGFuZXM7CiAgICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWVzID0gcm9vdDMuZXhwaXJhdGlvblRpbWVzOwogICAgICAgICAgdmFyIGxhbmVzID0gcGVuZGluZ0xhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZSA9IGV4cGlyYXRpb25UaW1lc1tpbmRleDJdOwogICAgICAgICAgICBpZiAoZXhwaXJhdGlvblRpbWUgPT09IE5vVGltZXN0YW1wKSB7CiAgICAgICAgICAgICAgaWYgKChsYW5lICYgc3VzcGVuZGVkTGFuZXMpID09PSBOb0xhbmVzIHx8IChsYW5lICYgcGluZ2VkTGFuZXMpICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBleHBpcmF0aW9uVGltZXNbaW5kZXgyXSA9IGNvbXB1dGVFeHBpcmF0aW9uVGltZShsYW5lLCBjdXJyZW50VGltZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGlyYXRpb25UaW1lIDw9IGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgICAgcm9vdDMuZXhwaXJlZExhbmVzIHw9IGxhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhpZ2hlc3RQcmlvcml0eVBlbmRpbmdMYW5lcyhyb290MykgewogICAgICAgICAgcmV0dXJuIGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKSB7CiAgICAgICAgICB2YXIgZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiA9IHJvb3QzLnBlbmRpbmdMYW5lcyAmIH5PZmZzY3JlZW5MYW5lOwogICAgICAgICAgaWYgKGV2ZXJ5dGhpbmdCdXRPZmZzY3JlZW4gIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZXJ5dGhpbmdCdXRPZmZzY3JlZW47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiAmIE9mZnNjcmVlbkxhbmUpIHsKICAgICAgICAgICAgcmV0dXJuIE9mZnNjcmVlbkxhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNTeW5jTGFuZShsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFN5bmNMYW5lKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNOb25JZGxlV29yayhsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIE5vbklkbGVMYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seVJldHJpZXMobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBSZXRyeUxhbmVzKSA9PT0gbGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seU5vblVyZ2VudExhbmVzKGxhbmVzKSB7CiAgICAgICAgICB2YXIgVXJnZW50TGFuZXMgPSBTeW5jTGFuZSB8IElucHV0Q29udGludW91c0xhbmUgfCBEZWZhdWx0TGFuZTsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBVcmdlbnRMYW5lcykgPT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seVRyYW5zaXRpb25zKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgVHJhbnNpdGlvbkxhbmVzKSA9PT0gbGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIFN5bmNEZWZhdWx0TGFuZXMgPSBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lIHwgSW5wdXRDb250aW51b3VzTGFuZSB8IERlZmF1bHRIeWRyYXRpb25MYW5lIHwgRGVmYXVsdExhbmU7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgU3luY0RlZmF1bHRMYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzRXhwaXJlZExhbmUocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgcm9vdDMuZXhwaXJlZExhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNUcmFuc2l0aW9uTGFuZShsYW5lKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmUgJiBUcmFuc2l0aW9uTGFuZXMpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpIHsKICAgICAgICAgIHZhciBsYW5lID0gbmV4dFRyYW5zaXRpb25MYW5lOwogICAgICAgICAgbmV4dFRyYW5zaXRpb25MYW5lIDw8PSAxOwogICAgICAgICAgaWYgKChuZXh0VHJhbnNpdGlvbkxhbmUgJiBUcmFuc2l0aW9uTGFuZXMpID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIG5leHRUcmFuc2l0aW9uTGFuZSA9IFRyYW5zaXRpb25MYW5lMTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGFpbU5leHRSZXRyeUxhbmUoKSB7CiAgICAgICAgICB2YXIgbGFuZSA9IG5leHRSZXRyeUxhbmU7CiAgICAgICAgICBuZXh0UmV0cnlMYW5lIDw8PSAxOwogICAgICAgICAgaWYgKChuZXh0UmV0cnlMYW5lICYgUmV0cnlMYW5lcykgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgbmV4dFJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcykgewogICAgICAgICAgcmV0dXJuIGxhbmVzICYgLWxhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwaWNrQXJiaXRyYXJ5TGFuZShsYW5lcykgewogICAgICAgICAgcmV0dXJuIGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gMzEgLSBjbHozMihsYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhbmVUb0luZGV4KGxhbmUpIHsKICAgICAgICAgIHJldHVybiBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc1NvbWVMYW5lKGEsIGIpIHsKICAgICAgICAgIHJldHVybiAoYSAmIGIpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1N1YnNldE9mTGFuZXMoc2V0NCwgc3Vic2V0KSB7CiAgICAgICAgICByZXR1cm4gKHNldDQgJiBzdWJzZXQpID09PSBzdWJzZXQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1lcmdlTGFuZXMoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgfCBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVMYW5lcyhzZXQ0LCBzdWJzZXQpIHsKICAgICAgICAgIHJldHVybiBzZXQ0ICYgfnN1YnNldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW50ZXJzZWN0TGFuZXMoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgJiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsYW5lVG9MYW5lcyhsYW5lKSB7CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlnaGVyUHJpb3JpdHlMYW5lKGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhICE9PSBOb0xhbmUgJiYgYSA8IGIgPyBhIDogYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlTGFuZU1hcChpbml0aWFsKSB7CiAgICAgICAgICB2YXIgbGFuZU1hcCA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBUb3RhbExhbmVzOyBpKyspIHsKICAgICAgICAgICAgbGFuZU1hcC5wdXNoKGluaXRpYWwpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmVNYXA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290VXBkYXRlZChyb290MywgdXBkYXRlTGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICByb290My5wZW5kaW5nTGFuZXMgfD0gdXBkYXRlTGFuZTsKICAgICAgICAgIGlmICh1cGRhdGVMYW5lICE9PSBJZGxlTGFuZSkgewogICAgICAgICAgICByb290My5zdXNwZW5kZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBpbmRleDIgPSBsYW5lVG9JbmRleCh1cGRhdGVMYW5lKTsKICAgICAgICAgIGV2ZW50VGltZXNbaW5kZXgyXSA9IGV2ZW50VGltZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RTdXNwZW5kZWQocm9vdDMsIHN1c3BlbmRlZExhbmVzKSB7CiAgICAgICAgICByb290My5zdXNwZW5kZWRMYW5lcyB8PSBzdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzICY9IH5zdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBzdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBleHBpcmF0aW9uVGltZXNbaW5kZXgyXSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RQaW5nZWQocm9vdDMsIHBpbmdlZExhbmVzLCBldmVudFRpbWUpIHsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzIHw9IHJvb3QzLnN1c3BlbmRlZExhbmVzICYgcGluZ2VkTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290RmluaXNoZWQocm9vdDMsIHJlbWFpbmluZ0xhbmVzKSB7CiAgICAgICAgICB2YXIgbm9Mb25nZXJQZW5kaW5nTGFuZXMgPSByb290My5wZW5kaW5nTGFuZXMgJiB+cmVtYWluaW5nTGFuZXM7CiAgICAgICAgICByb290My5wZW5kaW5nTGFuZXMgPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHJvb3QzLmV4cGlyZWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLm11dGFibGVSZWFkTGFuZXMgJj0gcmVtYWluaW5nTGFuZXM7CiAgICAgICAgICByb290My5lbnRhbmdsZWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHZhciBlbnRhbmdsZW1lbnRzID0gcm9vdDMuZW50YW5nbGVtZW50czsKICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBub0xvbmdlclBlbmRpbmdMYW5lczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBlbnRhbmdsZW1lbnRzW2luZGV4Ml0gPSBOb0xhbmVzOwogICAgICAgICAgICBldmVudFRpbWVzW2luZGV4Ml0gPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWVzW2luZGV4Ml0gPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBlbnRhbmdsZWRMYW5lcykgewogICAgICAgICAgdmFyIHJvb3RFbnRhbmdsZWRMYW5lcyA9IHJvb3QzLmVudGFuZ2xlZExhbmVzIHw9IGVudGFuZ2xlZExhbmVzOwogICAgICAgICAgdmFyIGVudGFuZ2xlbWVudHMgPSByb290My5lbnRhbmdsZW1lbnRzOwogICAgICAgICAgdmFyIGxhbmVzID0gcm9vdEVudGFuZ2xlZExhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIC8vIElzIHRoaXMgb25lIG9mIHRoZSBuZXdseSBlbnRhbmdsZWQgbGFuZXM/CiAgICAgICAgICAgICAgbGFuZSAmIGVudGFuZ2xlZExhbmVzIHwgLy8gSXMgdGhpcyBsYW5lIHRyYW5zaXRpdmVseSBlbnRhbmdsZWQgd2l0aCB0aGUgbmV3bHkgZW50YW5nbGVkIGxhbmVzPwogICAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSAmIGVudGFuZ2xlZExhbmVzCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSB8PSBlbnRhbmdsZWRMYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0QnVtcGVkTGFuZUZvckh5ZHJhdGlvbihyb290MywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgcmVuZGVyTGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBsYW5lOwogICAgICAgICAgc3dpdGNoIChyZW5kZXJMYW5lKSB7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICBsYW5lID0gSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgICBsYW5lID0gRGVmYXVsdEh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTY6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU3OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lODoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTk6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTExOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgbGFuZSA9IFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICAgIGxhbmUgPSBJZGxlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBsYW5lID0gTm9MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChsYW5lICYgKHJvb3QzLnN1c3BlbmRlZExhbmVzIHwgcmVuZGVyTGFuZXMyKSkgIT09IE5vTGFuZSkgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEZpYmVyVG9MYW5lc01hcChyb290MywgZmliZXIsIGxhbmVzKSB7CiAgICAgICAgICBpZiAoIWlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gcm9vdDMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcDsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IGxhbmVUb0luZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIHVwZGF0ZXJzID0gcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcFtpbmRleDJdOwogICAgICAgICAgICB1cGRhdGVycy5hZGQoZmliZXIpOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW92ZVBlbmRpbmdGaWJlcnNUb01lbW9pemVkKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgaWYgKCFpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IHJvb3QzLnBlbmRpbmdVcGRhdGVyc0xhbmVNYXA7CiAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBsYW5lVG9JbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciB1cGRhdGVycyA9IHBlbmRpbmdVcGRhdGVyc0xhbmVNYXBbaW5kZXgyXTsKICAgICAgICAgICAgaWYgKHVwZGF0ZXJzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdXBkYXRlcnMuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgPT09IG51bGwgfHwgIW1lbW9pemVkVXBkYXRlcnMuaGFzKGFsdGVybmF0ZSkpIHsKICAgICAgICAgICAgICAgICAgbWVtb2l6ZWRVcGRhdGVycy5hZGQoZmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRyYW5zaXRpb25zRm9yTGFuZXMocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgRGlzY3JldGVFdmVudFByaW9yaXR5ID0gU3luY0xhbmU7CiAgICAgICAgdmFyIENvbnRpbnVvdXNFdmVudFByaW9yaXR5ID0gSW5wdXRDb250aW51b3VzTGFuZTsKICAgICAgICB2YXIgRGVmYXVsdEV2ZW50UHJpb3JpdHkgPSBEZWZhdWx0TGFuZTsKICAgICAgICB2YXIgSWRsZUV2ZW50UHJpb3JpdHkgPSBJZGxlTGFuZTsKICAgICAgICB2YXIgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50VXBkYXRlUHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShuZXdQcmlvcml0eSkgewogICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gbmV3UHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJ1bldpdGhQcmlvcml0eShwcmlvcml0eSwgZm4pIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gY3VycmVudFVwZGF0ZVByaW9yaXR5OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gcHJpb3JpdHk7CiAgICAgICAgICAgIHJldHVybiBmbigpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gcHJldmlvdXNQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlnaGVyRXZlbnRQcmlvcml0eShhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSAhPT0gMCAmJiBhIDwgYiA/IGEgOiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsb3dlckV2ZW50UHJpb3JpdHkoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgPT09IDAgfHwgYSA+IGIgPyBhIDogYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNIaWdoZXJFdmVudFByaW9yaXR5KGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhICE9PSAwICYmIGEgPCBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsYW5lc1RvRXZlbnRQcmlvcml0eShsYW5lcykgewogICAgICAgICAgdmFyIGxhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKGxhbmVzKTsKICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSwgbGFuZSkpIHsKICAgICAgICAgICAgcmV0dXJuIERpc2NyZXRlRXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KENvbnRpbnVvdXNFdmVudFByaW9yaXR5LCBsYW5lKSkgewogICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5jbHVkZXNOb25JZGxlV29yayhsYW5lKSkgewogICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gSWRsZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpIHsKICAgICAgICAgIHZhciBjdXJyZW50U3RhdGUgPSByb290My5jdXJyZW50Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gY3VycmVudFN0YXRlLmlzRGVoeWRyYXRlZDsKICAgICAgICB9CiAgICAgICAgdmFyIF9hdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb247CiAgICAgICAgZnVuY3Rpb24gc2V0QXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZuKSB7CiAgICAgICAgICBfYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uID0gZm47CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmaWJlcikgewogICAgICAgICAgX2F0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmaWJlcik7CiAgICAgICAgfQogICAgICAgIHZhciBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihmbikgewogICAgICAgICAgYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24gPSBmbjsKICAgICAgICB9CiAgICAgICAgdmFyIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eTsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkoZm4pIHsKICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eSA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5JDE7CiAgICAgICAgZnVuY3Rpb24gc2V0R2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGZuKSB7CiAgICAgICAgICBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkkMSA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHk7CiAgICAgICAgZnVuY3Rpb24gc2V0QXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkoZm4pIHsKICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdFByaW9yaXR5ID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0ID0gZmFsc2U7CiAgICAgICAgdmFyIHF1ZXVlZERpc2NyZXRlRXZlbnRzID0gW107CiAgICAgICAgdmFyIHF1ZXVlZEZvY3VzID0gbnVsbDsKICAgICAgICB2YXIgcXVldWVkRHJhZyA9IG51bGw7CiAgICAgICAgdmFyIHF1ZXVlZE1vdXNlID0gbnVsbDsKICAgICAgICB2YXIgcXVldWVkUG9pbnRlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHZhciBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHZhciBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMgPSBbXTsKICAgICAgICB2YXIgZGlzY3JldGVSZXBsYXlhYmxlRXZlbnRzID0gWwogICAgICAgICAgIm1vdXNlZG93biIsCiAgICAgICAgICAibW91c2V1cCIsCiAgICAgICAgICAidG91Y2hjYW5jZWwiLAogICAgICAgICAgInRvdWNoZW5kIiwKICAgICAgICAgICJ0b3VjaHN0YXJ0IiwKICAgICAgICAgICJhdXhjbGljayIsCiAgICAgICAgICAiZGJsY2xpY2siLAogICAgICAgICAgInBvaW50ZXJjYW5jZWwiLAogICAgICAgICAgInBvaW50ZXJkb3duIiwKICAgICAgICAgICJwb2ludGVydXAiLAogICAgICAgICAgImRyYWdlbmQiLAogICAgICAgICAgImRyYWdzdGFydCIsCiAgICAgICAgICAiZHJvcCIsCiAgICAgICAgICAiY29tcG9zaXRpb25lbmQiLAogICAgICAgICAgImNvbXBvc2l0aW9uc3RhcnQiLAogICAgICAgICAgImtleWRvd24iLAogICAgICAgICAgImtleXByZXNzIiwKICAgICAgICAgICJrZXl1cCIsCiAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgInRleHRJbnB1dCIsCiAgICAgICAgICAvLyBJbnRlbnRpb25hbGx5IGNhbWVsQ2FzZQogICAgICAgICAgImNvcHkiLAogICAgICAgICAgImN1dCIsCiAgICAgICAgICAicGFzdGUiLAogICAgICAgICAgImNsaWNrIiwKICAgICAgICAgICJjaGFuZ2UiLAogICAgICAgICAgImNvbnRleHRtZW51IiwKICAgICAgICAgICJyZXNldCIsCiAgICAgICAgICAic3VibWl0IgogICAgICAgIF07CiAgICAgICAgZnVuY3Rpb24gaXNEaXNjcmV0ZUV2ZW50VGhhdFJlcXVpcmVzSHlkcmF0aW9uKGV2ZW50VHlwZSkgewogICAgICAgICAgcmV0dXJuIGRpc2NyZXRlUmVwbGF5YWJsZUV2ZW50cy5pbmRleE9mKGV2ZW50VHlwZSkgPiAtMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUXVldWVkUmVwbGF5YWJsZUV2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBibG9ja2VkT24sCiAgICAgICAgICAgIGRvbUV2ZW50TmFtZSwKICAgICAgICAgICAgZXZlbnRTeXN0ZW1GbGFncywKICAgICAgICAgICAgbmF0aXZlRXZlbnQsCiAgICAgICAgICAgIHRhcmdldENvbnRhaW5lcnM6IFt0YXJnZXRDb250YWluZXJdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhcklmQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcXVldWVkRm9jdXMgPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOgogICAgICAgICAgICBjYXNlICJkcmFnbGVhdmUiOgogICAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOgogICAgICAgICAgICBjYXNlICJtb3VzZW91dCI6CiAgICAgICAgICAgICAgcXVldWVkTW91c2UgPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdXQiOiB7CiAgICAgICAgICAgICAgdmFyIHBvaW50ZXJJZCA9IG5hdGl2ZUV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVycy5kZWxldGUocG9pbnRlcklkKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJnb3Rwb2ludGVyY2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgImxvc3Rwb2ludGVyY2FwdHVyZSI6IHsKICAgICAgICAgICAgICB2YXIgX3BvaW50ZXJJZCA9IG5hdGl2ZUV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZGVsZXRlKF9wb2ludGVySWQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQoZXhpc3RpbmdRdWV1ZWRFdmVudCwgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChleGlzdGluZ1F1ZXVlZEV2ZW50ID09PSBudWxsIHx8IGV4aXN0aW5nUXVldWVkRXZlbnQubmF0aXZlRXZlbnQgIT09IG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIHZhciBxdWV1ZWRFdmVudCA9IGNyZWF0ZVF1ZXVlZFJlcGxheWFibGVFdmVudChibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGlmIChibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyMiA9IGdldEluc3RhbmNlRnJvbU5vZGUoYmxvY2tlZE9uKTsKICAgICAgICAgICAgICBpZiAoX2ZpYmVyMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24oX2ZpYmVyMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBxdWV1ZWRFdmVudDsKICAgICAgICAgIH0KICAgICAgICAgIGV4aXN0aW5nUXVldWVkRXZlbnQuZXZlbnRTeXN0ZW1GbGFncyB8PSBldmVudFN5c3RlbUZsYWdzOwogICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lcnMgPSBleGlzdGluZ1F1ZXVlZEV2ZW50LnRhcmdldENvbnRhaW5lcnM7CiAgICAgICAgICBpZiAodGFyZ2V0Q29udGFpbmVyICE9PSBudWxsICYmIHRhcmdldENvbnRhaW5lcnMuaW5kZXhPZih0YXJnZXRDb250YWluZXIpID09PSAtMSkgewogICAgICAgICAgICB0YXJnZXRDb250YWluZXJzLnB1c2godGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleGlzdGluZ1F1ZXVlZEV2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZUlmQ29udGludW91c0V2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJmb2N1c2luIjogewogICAgICAgICAgICAgIHZhciBmb2N1c0V2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgcXVldWVkRm9jdXMgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZEZvY3VzLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBmb2N1c0V2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOiB7CiAgICAgICAgICAgICAgdmFyIGRyYWdFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZERyYWcsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIGRyYWdFdmVudCk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjogewogICAgICAgICAgICAgIHZhciBtb3VzZUV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgcXVldWVkTW91c2UgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZE1vdXNlLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBtb3VzZUV2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6IHsKICAgICAgICAgICAgICB2YXIgcG9pbnRlckV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgdmFyIHBvaW50ZXJJZCA9IHBvaW50ZXJFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICAgICAgcXVldWVkUG9pbnRlcnMuc2V0KHBvaW50ZXJJZCwgYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChxdWV1ZWRQb2ludGVycy5nZXQocG9pbnRlcklkKSB8fCBudWxsLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBwb2ludGVyRXZlbnQpKTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJnb3Rwb2ludGVyY2FwdHVyZSI6IHsKICAgICAgICAgICAgICB2YXIgX3BvaW50ZXJFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIHZhciBfcG9pbnRlcklkMiA9IF9wb2ludGVyRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5zZXQoX3BvaW50ZXJJZDIsIGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkUG9pbnRlckNhcHR1cmVzLmdldChfcG9pbnRlcklkMikgfHwgbnVsbCwgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgX3BvaW50ZXJFdmVudCkpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldChxdWV1ZWRUYXJnZXQpIHsKICAgICAgICAgIHZhciB0YXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUocXVldWVkVGFyZ2V0LnRhcmdldCk7CiAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKHRhcmdldEluc3QpOwogICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgdGFnID0gbmVhcmVzdE1vdW50ZWQudGFnOwogICAgICAgICAgICAgIGlmICh0YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRTdXNwZW5zZUluc3RhbmNlRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gaW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdFByaW9yaXR5KHF1ZXVlZFRhcmdldC5wcmlvcml0eSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5KG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIHZhciByb290MyA9IG5lYXJlc3RNb3VudGVkLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChpc1Jvb3REZWh5ZHJhdGVkKHJvb3QzKSkgewogICAgICAgICAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gZ2V0Q29udGFpbmVyRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlRXhwbGljaXRIeWRyYXRpb25UYXJnZXQodGFyZ2V0KSB7CiAgICAgICAgICB2YXIgdXBkYXRlUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkkMSgpOwogICAgICAgICAgdmFyIHF1ZXVlZFRhcmdldCA9IHsKICAgICAgICAgICAgYmxvY2tlZE9uOiBudWxsLAogICAgICAgICAgICB0YXJnZXQsCiAgICAgICAgICAgIHByaW9yaXR5OiB1cGRhdGVQcmlvcml0eQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgIGZvciAoOyBpIDwgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KHVwZGF0ZVByaW9yaXR5LCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHNbaV0ucHJpb3JpdHkpKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5zcGxpY2UoaSwgMCwgcXVldWVkVGFyZ2V0KTsKICAgICAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgICAgIGF0dGVtcHRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldChxdWV1ZWRUYXJnZXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEV2ZW50KSB7CiAgICAgICAgICBpZiAocXVldWVkRXZlbnQuYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0YXJnZXRDb250YWluZXJzID0gcXVldWVkRXZlbnQudGFyZ2V0Q29udGFpbmVyczsKICAgICAgICAgIHdoaWxlICh0YXJnZXRDb250YWluZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lciA9IHRhcmdldENvbnRhaW5lcnNbMF07CiAgICAgICAgICAgIHZhciBuZXh0QmxvY2tlZE9uID0gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChxdWV1ZWRFdmVudC5kb21FdmVudE5hbWUsIHF1ZXVlZEV2ZW50LmV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgcXVldWVkRXZlbnQubmF0aXZlRXZlbnQpOwogICAgICAgICAgICBpZiAobmV4dEJsb2NrZWRPbiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBuYXRpdmVFdmVudCA9IHF1ZXVlZEV2ZW50Lm5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50Q2xvbmUgPSBuZXcgbmF0aXZlRXZlbnQuY29uc3RydWN0b3IobmF0aXZlRXZlbnQudHlwZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgICAgc2V0UmVwbGF5aW5nRXZlbnQobmF0aXZlRXZlbnRDbG9uZSk7CiAgICAgICAgICAgICAgICBuYXRpdmVFdmVudC50YXJnZXQuZGlzcGF0Y2hFdmVudChuYXRpdmVFdmVudENsb25lKTsKICAgICAgICAgICAgICAgIHJlc2V0UmVwbGF5aW5nRXZlbnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlcjMgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKG5leHRCbG9ja2VkT24pOwogICAgICAgICAgICAgIGlmIChfZmliZXIzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihfZmliZXIzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcXVldWVkRXZlbnQuYmxvY2tlZE9uID0gbmV4dEJsb2NrZWRPbjsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVycy5zaGlmdCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnRJbk1hcChxdWV1ZWRFdmVudCwga2V5LCBtYXAzKSB7CiAgICAgICAgICBpZiAoYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWRFdmVudCkpIHsKICAgICAgICAgICAgbWFwMy5kZWxldGUoa2V5KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVwbGF5VW5ibG9ja2VkRXZlbnRzKCkgewogICAgICAgICAgaGFzU2NoZWR1bGVkUmVwbGF5QXR0ZW1wdCA9IGZhbHNlOwogICAgICAgICAgaWYgKHF1ZXVlZEZvY3VzICE9PSBudWxsICYmIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkRm9jdXMpKSB7CiAgICAgICAgICAgIHF1ZXVlZEZvY3VzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWREcmFnICE9PSBudWxsICYmIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkRHJhZykpIHsKICAgICAgICAgICAgcXVldWVkRHJhZyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkTW91c2UgIT09IG51bGwgJiYgYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWRNb3VzZSkpIHsKICAgICAgICAgICAgcXVldWVkTW91c2UgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcXVldWVkUG9pbnRlcnMuZm9yRWFjaChhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50SW5NYXApOwogICAgICAgICAgcXVldWVkUG9pbnRlckNhcHR1cmVzLmZvckVhY2goYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudEluTWFwKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZEV2ZW50LCB1bmJsb2NrZWQpIHsKICAgICAgICAgIGlmIChxdWV1ZWRFdmVudC5ibG9ja2VkT24gPT09IHVuYmxvY2tlZCkgewogICAgICAgICAgICBxdWV1ZWRFdmVudC5ibG9ja2VkT24gPSBudWxsOwogICAgICAgICAgICBpZiAoIWhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQpIHsKICAgICAgICAgICAgICBoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0ID0gdHJ1ZTsKICAgICAgICAgICAgICBTY2hlZHVsZXIudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayhTY2hlZHVsZXIudW5zdGFibGVfTm9ybWFsUHJpb3JpdHksIHJlcGxheVVuYmxvY2tlZEV2ZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlJZkJsb2NrZWRPbih1bmJsb2NrZWQpIHsKICAgICAgICAgIGlmIChxdWV1ZWREaXNjcmV0ZUV2ZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWREaXNjcmV0ZUV2ZW50c1swXSwgdW5ibG9ja2VkKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBxdWV1ZWREaXNjcmV0ZUV2ZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBxdWV1ZWRFdmVudCA9IHF1ZXVlZERpc2NyZXRlRXZlbnRzW2ldOwogICAgICAgICAgICAgIGlmIChxdWV1ZWRFdmVudC5ibG9ja2VkT24gPT09IHVuYmxvY2tlZCkgewogICAgICAgICAgICAgICAgcXVldWVkRXZlbnQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWRGb2N1cyAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRm9jdXMsIHVuYmxvY2tlZCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkRHJhZyAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRHJhZywgdW5ibG9ja2VkKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWRNb3VzZSAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkTW91c2UsIHVuYmxvY2tlZCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdW5ibG9jayA9IGZ1bmN0aW9uKHF1ZXVlZEV2ZW50MikgewogICAgICAgICAgICByZXR1cm4gc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZEV2ZW50MiwgdW5ibG9ja2VkKTsKICAgICAgICAgIH07CiAgICAgICAgICBxdWV1ZWRQb2ludGVycy5mb3JFYWNoKHVuYmxvY2spOwogICAgICAgICAgcXVldWVkUG9pbnRlckNhcHR1cmVzLmZvckVhY2godW5ibG9jayk7CiAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICB2YXIgcXVldWVkVGFyZ2V0ID0gcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzW19pXTsKICAgICAgICAgICAgaWYgKHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPT09IHVuYmxvY2tlZCkgewogICAgICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAocXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIG5leHRFeHBsaWNpdFRhcmdldCA9IHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0c1swXTsKICAgICAgICAgICAgaWYgKG5leHRFeHBsaWNpdFRhcmdldC5ibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBhdHRlbXB0RXhwbGljaXRIeWRyYXRpb25UYXJnZXQobmV4dEV4cGxpY2l0VGFyZ2V0KTsKICAgICAgICAgICAgICBpZiAobmV4dEV4cGxpY2l0VGFyZ2V0LmJsb2NrZWRPbiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLnNoaWZ0KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEJhdGNoQ29uZmlnOwogICAgICAgIHZhciBfZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gc2V0RW5hYmxlZChlbmFibGVkKSB7CiAgICAgICAgICBfZW5hYmxlZCA9ICEhZW5hYmxlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNFbmFibGVkKCkgewogICAgICAgICAgcmV0dXJuIF9lbmFibGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVFdmVudExpc3RlbmVyV3JhcHBlcldpdGhQcmlvcml0eSh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncykgewogICAgICAgICAgdmFyIGV2ZW50UHJpb3JpdHkgPSBnZXRFdmVudFByaW9yaXR5KGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICB2YXIgbGlzdGVuZXJXcmFwcGVyOwogICAgICAgICAgc3dpdGNoIChldmVudFByaW9yaXR5KSB7CiAgICAgICAgICAgIGNhc2UgRGlzY3JldGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgIGxpc3RlbmVyV3JhcHBlciA9IGRpc3BhdGNoRGlzY3JldGVFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDb250aW51b3VzRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICBsaXN0ZW5lcldyYXBwZXIgPSBkaXNwYXRjaENvbnRpbnVvdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0RXZlbnRQcmlvcml0eToKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBsaXN0ZW5lcldyYXBwZXIgPSBkaXNwYXRjaEV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyV3JhcHBlci5iaW5kKG51bGwsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hEaXNjcmV0ZUV2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyMiwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgZGlzcGF0Y2hFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGNvbnRhaW5lcjIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaENvbnRpbnVvdXNFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGNvbnRhaW5lcjIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KENvbnRpbnVvdXNFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgZGlzcGF0Y2hFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGNvbnRhaW5lcjIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKCFfZW5hYmxlZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnRXaXRoRW5hYmxlQ2FwdHVyZVBoYXNlU2VsZWN0aXZlSHlkcmF0aW9uV2l0aG91dERpc2NyZXRlRXZlbnRSZXBsYXkoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hFdmVudFdpdGhFbmFibGVDYXB0dXJlUGhhc2VTZWxlY3RpdmVIeWRyYXRpb25XaXRob3V0RGlzY3JldGVFdmVudFJlcGxheShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBibG9ja2VkT24gPSBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICBpZiAoYmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCByZXR1cm5fdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICAgICAgY2xlYXJJZkNvbnRpbnVvdXNFdmVudChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlSWZDb250aW51b3VzRXZlbnQoYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIG5hdGl2ZUV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBjbGVhcklmQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgaWYgKGV2ZW50U3lzdGVtRmxhZ3MgJiBJU19DQVBUVVJFX1BIQVNFICYmIGlzRGlzY3JldGVFdmVudFRoYXRSZXF1aXJlc0h5ZHJhdGlvbihkb21FdmVudE5hbWUpKSB7CiAgICAgICAgICAgIHdoaWxlIChibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZmliZXIgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKGJsb2NrZWRPbik7CiAgICAgICAgICAgICAgaWYgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbmV4dEJsb2NrZWRPbiA9IGZpbmRJbnN0YW5jZUJsb2NraW5nRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgICBpZiAobmV4dEJsb2NrZWRPbiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgZGlzcGF0Y2hFdmVudEZvclBsdWdpbkV2ZW50U3lzdGVtKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIHJldHVybl90YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmV4dEJsb2NrZWRPbiA9PT0gYmxvY2tlZE9uKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYmxvY2tlZE9uID0gbmV4dEJsb2NrZWRPbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmF0aXZlRXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgZGlzcGF0Y2hFdmVudEZvclBsdWdpbkV2ZW50U3lzdGVtKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIG51bGwsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgfQogICAgICAgIHZhciByZXR1cm5fdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybl90YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgIHZhciBuYXRpdmVFdmVudFRhcmdldCA9IGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIHZhciB0YXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKHRhcmdldEluc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIG5lYXJlc3RNb3VudGVkID0gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcih0YXJnZXRJbnN0KTsKICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHRhZyA9IG5lYXJlc3RNb3VudGVkLnRhZzsKICAgICAgICAgICAgICBpZiAodGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0U3VzcGVuc2VJbnN0YW5jZUZyb21GaWJlcihuZWFyZXN0TW91bnRlZCk7CiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBuZWFyZXN0TW91bnRlZC5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRhaW5lckZyb21GaWJlcihuZWFyZXN0TW91bnRlZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5lYXJlc3RNb3VudGVkICE9PSB0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybl90YXJnZXRJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFByaW9yaXR5KGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAiY2xpY2siOgogICAgICAgICAgICBjYXNlICJjbG9zZSI6CiAgICAgICAgICAgIGNhc2UgImNvbnRleHRtZW51IjoKICAgICAgICAgICAgY2FzZSAiY29weSI6CiAgICAgICAgICAgIGNhc2UgImN1dCI6CiAgICAgICAgICAgIGNhc2UgImF1eGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAiZGJsY2xpY2siOgogICAgICAgICAgICBjYXNlICJkcmFnZW5kIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ3N0YXJ0IjoKICAgICAgICAgICAgY2FzZSAiZHJvcCI6CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgY2FzZSAiaW52YWxpZCI6CiAgICAgICAgICAgIGNhc2UgImtleWRvd24iOgogICAgICAgICAgICBjYXNlICJrZXlwcmVzcyI6CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgY2FzZSAibW91c2V1cCI6CiAgICAgICAgICAgIGNhc2UgInBhc3RlIjoKICAgICAgICAgICAgY2FzZSAicGF1c2UiOgogICAgICAgICAgICBjYXNlICJwbGF5IjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJkb3duIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcnVwIjoKICAgICAgICAgICAgY2FzZSAicmF0ZWNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgInJlc2V0IjoKICAgICAgICAgICAgY2FzZSAicmVzaXplIjoKICAgICAgICAgICAgY2FzZSAic2Vla2VkIjoKICAgICAgICAgICAgY2FzZSAic3VibWl0IjoKICAgICAgICAgICAgY2FzZSAidG91Y2hjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJ0b3VjaGVuZCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoc3RhcnQiOgogICAgICAgICAgICBjYXNlICJ2b2x1bWVjaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJjaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJzZWxlY3Rpb25jaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJ0ZXh0SW5wdXQiOgogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbnN0YXJ0IjoKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25lbmQiOgogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbnVwZGF0ZSI6CiAgICAgICAgICAgIGNhc2UgImJlZm9yZWJsdXIiOgogICAgICAgICAgICBjYXNlICJhZnRlcmJsdXIiOgogICAgICAgICAgICBjYXNlICJiZWZvcmVpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgImJsdXIiOgogICAgICAgICAgICBjYXNlICJmdWxsc2NyZWVuY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAiZm9jdXMiOgogICAgICAgICAgICBjYXNlICJoYXNoY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAicG9wc3RhdGUiOgogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICBjYXNlICJzZWxlY3RzdGFydCI6CiAgICAgICAgICAgICAgcmV0dXJuIERpc2NyZXRlRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgY2FzZSAiZHJhZyI6CiAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6CiAgICAgICAgICAgIGNhc2UgImRyYWdleGl0IjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2xlYXZlIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ292ZXIiOgogICAgICAgICAgICBjYXNlICJtb3VzZW1vdmUiOgogICAgICAgICAgICBjYXNlICJtb3VzZW91dCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJtb3ZlIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm91dCI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjoKICAgICAgICAgICAgY2FzZSAic2Nyb2xsIjoKICAgICAgICAgICAgY2FzZSAidG9nZ2xlIjoKICAgICAgICAgICAgY2FzZSAidG91Y2htb3ZlIjoKICAgICAgICAgICAgY2FzZSAid2hlZWwiOgogICAgICAgICAgICBjYXNlICJtb3VzZWVudGVyIjoKICAgICAgICAgICAgY2FzZSAibW91c2VsZWF2ZSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJlbnRlciI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJsZWF2ZSI6CiAgICAgICAgICAgICAgcmV0dXJuIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OwogICAgICAgICAgICBjYXNlICJtZXNzYWdlIjogewogICAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eSA9IGdldEN1cnJlbnRQcmlvcml0eUxldmVsKCk7CiAgICAgICAgICAgICAgc3dpdGNoIChzY2hlZHVsZXJQcmlvcml0eSkgewogICAgICAgICAgICAgICAgY2FzZSBJbW1lZGlhdGVQcmlvcml0eToKICAgICAgICAgICAgICAgICAgcmV0dXJuIERpc2NyZXRlRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHJldHVybiBDb250aW51b3VzRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgICAgICBjYXNlIExvd1ByaW9yaXR5OgogICAgICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICBjYXNlIElkbGVQcmlvcml0eToKICAgICAgICAgICAgICAgICAgcmV0dXJuIElkbGVFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcih0YXJnZXQsIGV2ZW50VHlwZSwgbGlzdGVuZXIyKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyMiwgZmFsc2UpOwogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXIodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyMikgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lcjIsIHRydWUpOwogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyMiwgcGFzc2l2ZSkgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lcjIsIHsKICAgICAgICAgICAgY2FwdHVyZTogdHJ1ZSwKICAgICAgICAgICAgcGFzc2l2ZQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRFdmVudEJ1YmJsZUxpc3RlbmVyV2l0aFBhc3NpdmVGbGFnKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lcjIsIHBhc3NpdmUpIHsKICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIyLCB7CiAgICAgICAgICAgIHBhc3NpdmUKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyMjsKICAgICAgICB9CiAgICAgICAgdmFyIHJvb3QyID0gbnVsbDsKICAgICAgICB2YXIgc3RhcnRUZXh0ID0gbnVsbDsKICAgICAgICB2YXIgZmFsbGJhY2tUZXh0ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBpbml0aWFsaXplKG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICByb290MiA9IG5hdGl2ZUV2ZW50VGFyZ2V0OwogICAgICAgICAgc3RhcnRUZXh0ID0gZ2V0VGV4dCgpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICAgICAgcm9vdDIgPSBudWxsOwogICAgICAgICAgc3RhcnRUZXh0ID0gbnVsbDsKICAgICAgICAgIGZhbGxiYWNrVGV4dCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERhdGEoKSB7CiAgICAgICAgICBpZiAoZmFsbGJhY2tUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBmYWxsYmFja1RleHQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhcnQ7CiAgICAgICAgICB2YXIgc3RhcnRWYWx1ZSA9IHN0YXJ0VGV4dDsKICAgICAgICAgIHZhciBzdGFydExlbmd0aCA9IHN0YXJ0VmFsdWUubGVuZ3RoOwogICAgICAgICAgdmFyIGVuZDsKICAgICAgICAgIHZhciBlbmRWYWx1ZSA9IGdldFRleHQoKTsKICAgICAgICAgIHZhciBlbmRMZW5ndGggPSBlbmRWYWx1ZS5sZW5ndGg7CiAgICAgICAgICBmb3IgKHN0YXJ0ID0gMDsgc3RhcnQgPCBzdGFydExlbmd0aDsgc3RhcnQrKykgewogICAgICAgICAgICBpZiAoc3RhcnRWYWx1ZVtzdGFydF0gIT09IGVuZFZhbHVlW3N0YXJ0XSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWluRW5kID0gc3RhcnRMZW5ndGggLSBzdGFydDsKICAgICAgICAgIGZvciAoZW5kID0gMTsgZW5kIDw9IG1pbkVuZDsgZW5kKyspIHsKICAgICAgICAgICAgaWYgKHN0YXJ0VmFsdWVbc3RhcnRMZW5ndGggLSBlbmRdICE9PSBlbmRWYWx1ZVtlbmRMZW5ndGggLSBlbmRdKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzbGljZVRhaWwgPSBlbmQgPiAxID8gMSAtIGVuZCA6IHZvaWQgMDsKICAgICAgICAgIGZhbGxiYWNrVGV4dCA9IGVuZFZhbHVlLnNsaWNlKHN0YXJ0LCBzbGljZVRhaWwpOwogICAgICAgICAgcmV0dXJuIGZhbGxiYWNrVGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGV4dCgpIHsKICAgICAgICAgIGlmICgidmFsdWUiIGluIHJvb3QyKSB7CiAgICAgICAgICAgIHJldHVybiByb290Mi52YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByb290Mi50ZXh0Q29udGVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRDaGFyQ29kZShuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGNoYXJDb2RlOwogICAgICAgICAgdmFyIGtleUNvZGUgPSBuYXRpdmVFdmVudC5rZXlDb2RlOwogICAgICAgICAgaWYgKCJjaGFyQ29kZSIgaW4gbmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgY2hhckNvZGUgPSBuYXRpdmVFdmVudC5jaGFyQ29kZTsKICAgICAgICAgICAgaWYgKGNoYXJDb2RlID09PSAwICYmIGtleUNvZGUgPT09IDEzKSB7CiAgICAgICAgICAgICAgY2hhckNvZGUgPSAxMzsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2hhckNvZGUgPSBrZXlDb2RlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNoYXJDb2RlID09PSAxMCkgewogICAgICAgICAgICBjaGFyQ29kZSA9IDEzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNoYXJDb2RlID49IDMyIHx8IGNoYXJDb2RlID09PSAxMykgewogICAgICAgICAgICByZXR1cm4gY2hhckNvZGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWUoKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZnVuY3Rpb25UaGF0UmV0dXJuc0ZhbHNlKCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVTeW50aGV0aWNFdmVudChJbnRlcmZhY2UpIHsKICAgICAgICAgIGZ1bmN0aW9uIFN5bnRoZXRpY0Jhc2VFdmVudChyZWFjdE5hbWUsIHJlYWN0RXZlbnRUeXBlLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgICAgdGhpcy5fcmVhY3ROYW1lID0gcmVhY3ROYW1lOwogICAgICAgICAgICB0aGlzLl90YXJnZXRJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgdGhpcy50eXBlID0gcmVhY3RFdmVudFR5cGU7CiAgICAgICAgICAgIHRoaXMubmF0aXZlRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBuYXRpdmVFdmVudFRhcmdldDsKICAgICAgICAgICAgdGhpcy5jdXJyZW50VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgZm9yICh2YXIgX3Byb3BOYW1lIGluIEludGVyZmFjZSkgewogICAgICAgICAgICAgIGlmICghSW50ZXJmYWNlLmhhc093blByb3BlcnR5KF9wcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbm9ybWFsaXplMiA9IEludGVyZmFjZVtfcHJvcE5hbWVdOwogICAgICAgICAgICAgIGlmIChub3JtYWxpemUyKSB7CiAgICAgICAgICAgICAgICB0aGlzW19wcm9wTmFtZV0gPSBub3JtYWxpemUyKG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpc1tfcHJvcE5hbWVdID0gbmF0aXZlRXZlbnRbX3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRlZmF1bHRQcmV2ZW50ZWQgPSBuYXRpdmVFdmVudC5kZWZhdWx0UHJldmVudGVkICE9IG51bGwgPyBuYXRpdmVFdmVudC5kZWZhdWx0UHJldmVudGVkIDogbmF0aXZlRXZlbnQucmV0dXJuVmFsdWUgPT09IGZhbHNlOwogICAgICAgICAgICBpZiAoZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBmdW5jdGlvblRoYXRSZXR1cm5zRmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNGYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NpZ24yKFN5bnRoZXRpY0Jhc2VFdmVudC5wcm90b3R5cGUsIHsKICAgICAgICAgICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRoaXMuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gdGhpcy5uYXRpdmVFdmVudDsKICAgICAgICAgICAgICBpZiAoIWV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBldmVudC5yZXR1cm5WYWx1ZSAhPT0gInVua25vd24iKSB7CiAgICAgICAgICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHZhciBldmVudCA9IHRoaXMubmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgaWYgKCFldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSB7CiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBldmVudC5jYW5jZWxCdWJibGUgIT09ICJ1bmtub3duIikgewogICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogV2UgcmVsZWFzZSBhbGwgZGlzcGF0Y2hlZCBgU3ludGhldGljRXZlbnRgcyBhZnRlciBlYWNoIGV2ZW50IGxvb3AsIGFkZGluZwogICAgICAgICAgICAgKiB0aGVtIGJhY2sgaW50byB0aGUgcG9vbC4gVGhpcyBhbGxvd3MgYSB3YXkgdG8gaG9sZCBvbnRvIGEgcmVmZXJlbmNlIHRoYXQKICAgICAgICAgICAgICogd29uJ3QgYmUgYWRkZWQgYmFjayBpbnRvIHRoZSBwb29sLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcGVyc2lzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDaGVja3MgaWYgdGhpcyBldmVudCBzaG91bGQgYmUgcmVsZWFzZWQgYmFjayBpbnRvIHRoZSBwb29sLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoaXMgc2hvdWxkIG5vdCBiZSByZWxlYXNlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaXNQZXJzaXN0ZW50OiBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gU3ludGhldGljQmFzZUV2ZW50OwogICAgICAgIH0KICAgICAgICB2YXIgRXZlbnRJbnRlcmZhY2UgPSB7CiAgICAgICAgICBldmVudFBoYXNlOiAwLAogICAgICAgICAgYnViYmxlczogMCwKICAgICAgICAgIGNhbmNlbGFibGU6IDAsCiAgICAgICAgICB0aW1lU3RhbXA6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBldmVudC50aW1lU3RhbXAgfHwgRGF0ZS5ub3coKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZWZhdWx0UHJldmVudGVkOiAwLAogICAgICAgICAgaXNUcnVzdGVkOiAwCiAgICAgICAgfTsKICAgICAgICB2YXIgU3ludGhldGljRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFVJRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBFdmVudEludGVyZmFjZSwgewogICAgICAgICAgdmlldzogMCwKICAgICAgICAgIGRldGFpbDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNVSUV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoVUlFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIGxhc3RNb3ZlbWVudFg7CiAgICAgICAgdmFyIGxhc3RNb3ZlbWVudFk7CiAgICAgICAgdmFyIGxhc3RNb3VzZUV2ZW50OwogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1vdXNlTW92ZW1lbnRQb2x5ZmlsbFN0YXRlKGV2ZW50KSB7CiAgICAgICAgICBpZiAoZXZlbnQgIT09IGxhc3RNb3VzZUV2ZW50KSB7CiAgICAgICAgICAgIGlmIChsYXN0TW91c2VFdmVudCAmJiBldmVudC50eXBlID09PSAibW91c2Vtb3ZlIikgewogICAgICAgICAgICAgIGxhc3RNb3ZlbWVudFggPSBldmVudC5zY3JlZW5YIC0gbGFzdE1vdXNlRXZlbnQuc2NyZWVuWDsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRZID0gZXZlbnQuc2NyZWVuWSAtIGxhc3RNb3VzZUV2ZW50LnNjcmVlblk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbGFzdE1vdmVtZW50WCA9IDA7CiAgICAgICAgICAgICAgbGFzdE1vdmVtZW50WSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdE1vdXNlRXZlbnQgPSBldmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIE1vdXNlRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBzY3JlZW5YOiAwLAogICAgICAgICAgc2NyZWVuWTogMCwKICAgICAgICAgIGNsaWVudFg6IDAsCiAgICAgICAgICBjbGllbnRZOiAwLAogICAgICAgICAgcGFnZVg6IDAsCiAgICAgICAgICBwYWdlWTogMCwKICAgICAgICAgIGN0cmxLZXk6IDAsCiAgICAgICAgICBzaGlmdEtleTogMCwKICAgICAgICAgIGFsdEtleTogMCwKICAgICAgICAgIG1ldGFLZXk6IDAsCiAgICAgICAgICBnZXRNb2RpZmllclN0YXRlOiBnZXRFdmVudE1vZGlmaWVyU3RhdGUsCiAgICAgICAgICBidXR0b246IDAsCiAgICAgICAgICBidXR0b25zOiAwLAogICAgICAgICAgcmVsYXRlZFRhcmdldDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnJlbGF0ZWRUYXJnZXQgPT09IHZvaWQgMCkgcmV0dXJuIGV2ZW50LmZyb21FbGVtZW50ID09PSBldmVudC5zcmNFbGVtZW50ID8gZXZlbnQudG9FbGVtZW50IDogZXZlbnQuZnJvbUVsZW1lbnQ7CiAgICAgICAgICAgIHJldHVybiBldmVudC5yZWxhdGVkVGFyZ2V0OwogICAgICAgICAgfSwKICAgICAgICAgIG1vdmVtZW50WDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKCJtb3ZlbWVudFgiIGluIGV2ZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50Lm1vdmVtZW50WDsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVNb3VzZU1vdmVtZW50UG9seWZpbGxTdGF0ZShldmVudCk7CiAgICAgICAgICAgIHJldHVybiBsYXN0TW92ZW1lbnRYOwogICAgICAgICAgfSwKICAgICAgICAgIG1vdmVtZW50WTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKCJtb3ZlbWVudFkiIGluIGV2ZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50Lm1vdmVtZW50WTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGFzdE1vdmVtZW50WTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljTW91c2VFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KE1vdXNlRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBEcmFnRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBNb3VzZUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBkYXRhVHJhbnNmZXI6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljRHJhZ0V2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoRHJhZ0V2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgRm9jdXNFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIFVJRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHJlbGF0ZWRUYXJnZXQ6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljRm9jdXNFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEZvY3VzRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBBbmltYXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBhbmltYXRpb25OYW1lOiAwLAogICAgICAgICAgZWxhcHNlZFRpbWU6IDAsCiAgICAgICAgICBwc2V1ZG9FbGVtZW50OiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0FuaW1hdGlvbkV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoQW5pbWF0aW9uRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBDbGlwYm9hcmRFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBjbGlwYm9hcmREYXRhOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gImNsaXBib2FyZERhdGEiIGluIGV2ZW50ID8gZXZlbnQuY2xpcGJvYXJkRGF0YSA6IHdpbmRvdy5jbGlwYm9hcmREYXRhOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNDbGlwYm9hcmRFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KENsaXBib2FyZEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgQ29tcG9zaXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBkYXRhOiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0NvbXBvc2l0aW9uRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChDb21wb3NpdGlvbkV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgU3ludGhldGljSW5wdXRFdmVudCA9IFN5bnRoZXRpY0NvbXBvc2l0aW9uRXZlbnQ7CiAgICAgICAgdmFyIG5vcm1hbGl6ZUtleSA9IHsKICAgICAgICAgIEVzYzogIkVzY2FwZSIsCiAgICAgICAgICBTcGFjZWJhcjogIiAiLAogICAgICAgICAgTGVmdDogIkFycm93TGVmdCIsCiAgICAgICAgICBVcDogIkFycm93VXAiLAogICAgICAgICAgUmlnaHQ6ICJBcnJvd1JpZ2h0IiwKICAgICAgICAgIERvd246ICJBcnJvd0Rvd24iLAogICAgICAgICAgRGVsOiAiRGVsZXRlIiwKICAgICAgICAgIFdpbjogIk9TIiwKICAgICAgICAgIE1lbnU6ICJDb250ZXh0TWVudSIsCiAgICAgICAgICBBcHBzOiAiQ29udGV4dE1lbnUiLAogICAgICAgICAgU2Nyb2xsOiAiU2Nyb2xsTG9jayIsCiAgICAgICAgICBNb3pQcmludGFibGVLZXk6ICJVbmlkZW50aWZpZWQiCiAgICAgICAgfTsKICAgICAgICB2YXIgdHJhbnNsYXRlVG9LZXkgPSB7CiAgICAgICAgICAiOCI6ICJCYWNrc3BhY2UiLAogICAgICAgICAgIjkiOiAiVGFiIiwKICAgICAgICAgICIxMiI6ICJDbGVhciIsCiAgICAgICAgICAiMTMiOiAiRW50ZXIiLAogICAgICAgICAgIjE2IjogIlNoaWZ0IiwKICAgICAgICAgICIxNyI6ICJDb250cm9sIiwKICAgICAgICAgICIxOCI6ICJBbHQiLAogICAgICAgICAgIjE5IjogIlBhdXNlIiwKICAgICAgICAgICIyMCI6ICJDYXBzTG9jayIsCiAgICAgICAgICAiMjciOiAiRXNjYXBlIiwKICAgICAgICAgICIzMiI6ICIgIiwKICAgICAgICAgICIzMyI6ICJQYWdlVXAiLAogICAgICAgICAgIjM0IjogIlBhZ2VEb3duIiwKICAgICAgICAgICIzNSI6ICJFbmQiLAogICAgICAgICAgIjM2IjogIkhvbWUiLAogICAgICAgICAgIjM3IjogIkFycm93TGVmdCIsCiAgICAgICAgICAiMzgiOiAiQXJyb3dVcCIsCiAgICAgICAgICAiMzkiOiAiQXJyb3dSaWdodCIsCiAgICAgICAgICAiNDAiOiAiQXJyb3dEb3duIiwKICAgICAgICAgICI0NSI6ICJJbnNlcnQiLAogICAgICAgICAgIjQ2IjogIkRlbGV0ZSIsCiAgICAgICAgICAiMTEyIjogIkYxIiwKICAgICAgICAgICIxMTMiOiAiRjIiLAogICAgICAgICAgIjExNCI6ICJGMyIsCiAgICAgICAgICAiMTE1IjogIkY0IiwKICAgICAgICAgICIxMTYiOiAiRjUiLAogICAgICAgICAgIjExNyI6ICJGNiIsCiAgICAgICAgICAiMTE4IjogIkY3IiwKICAgICAgICAgICIxMTkiOiAiRjgiLAogICAgICAgICAgIjEyMCI6ICJGOSIsCiAgICAgICAgICAiMTIxIjogIkYxMCIsCiAgICAgICAgICAiMTIyIjogIkYxMSIsCiAgICAgICAgICAiMTIzIjogIkYxMiIsCiAgICAgICAgICAiMTQ0IjogIk51bUxvY2siLAogICAgICAgICAgIjE0NSI6ICJTY3JvbGxMb2NrIiwKICAgICAgICAgICIyMjQiOiAiTWV0YSIKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50S2V5KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBpZiAobmF0aXZlRXZlbnQua2V5KSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBub3JtYWxpemVLZXlbbmF0aXZlRXZlbnQua2V5XSB8fCBuYXRpdmVFdmVudC5rZXk7CiAgICAgICAgICAgIGlmIChrZXkgIT09ICJVbmlkZW50aWZpZWQiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LnR5cGUgPT09ICJrZXlwcmVzcyIpIHsKICAgICAgICAgICAgdmFyIGNoYXJDb2RlID0gZ2V0RXZlbnRDaGFyQ29kZShuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIHJldHVybiBjaGFyQ29kZSA9PT0gMTMgPyAiRW50ZXIiIDogU3RyaW5nLmZyb21DaGFyQ29kZShjaGFyQ29kZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmF0aXZlRXZlbnQudHlwZSA9PT0gImtleWRvd24iIHx8IG5hdGl2ZUV2ZW50LnR5cGUgPT09ICJrZXl1cCIpIHsKICAgICAgICAgICAgcmV0dXJuIHRyYW5zbGF0ZVRvS2V5W25hdGl2ZUV2ZW50LmtleUNvZGVdIHx8ICJVbmlkZW50aWZpZWQiOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgbW9kaWZpZXJLZXlUb1Byb3AgPSB7CiAgICAgICAgICBBbHQ6ICJhbHRLZXkiLAogICAgICAgICAgQ29udHJvbDogImN0cmxLZXkiLAogICAgICAgICAgTWV0YTogIm1ldGFLZXkiLAogICAgICAgICAgU2hpZnQ6ICJzaGlmdEtleSIKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIG1vZGlmaWVyU3RhdGVHZXR0ZXIoa2V5QXJnKSB7CiAgICAgICAgICB2YXIgc3ludGhldGljRXZlbnQgPSB0aGlzOwogICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50ID0gc3ludGhldGljRXZlbnQubmF0aXZlRXZlbnQ7CiAgICAgICAgICBpZiAobmF0aXZlRXZlbnQuZ2V0TW9kaWZpZXJTdGF0ZSkgewogICAgICAgICAgICByZXR1cm4gbmF0aXZlRXZlbnQuZ2V0TW9kaWZpZXJTdGF0ZShrZXlBcmcpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGtleVByb3AgPSBtb2RpZmllcktleVRvUHJvcFtrZXlBcmddOwogICAgICAgICAgcmV0dXJuIGtleVByb3AgPyAhIW5hdGl2ZUV2ZW50W2tleVByb3BdIDogZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50TW9kaWZpZXJTdGF0ZShuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuIG1vZGlmaWVyU3RhdGVHZXR0ZXI7CiAgICAgICAgfQogICAgICAgIHZhciBLZXlib2FyZEV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAga2V5OiBnZXRFdmVudEtleSwKICAgICAgICAgIGNvZGU6IDAsCiAgICAgICAgICBsb2NhdGlvbjogMCwKICAgICAgICAgIGN0cmxLZXk6IDAsCiAgICAgICAgICBzaGlmdEtleTogMCwKICAgICAgICAgIGFsdEtleTogMCwKICAgICAgICAgIG1ldGFLZXk6IDAsCiAgICAgICAgICByZXBlYXQ6IDAsCiAgICAgICAgICBsb2NhbGU6IDAsCiAgICAgICAgICBnZXRNb2RpZmllclN0YXRlOiBnZXRFdmVudE1vZGlmaWVyU3RhdGUsCiAgICAgICAgICAvLyBMZWdhY3kgSW50ZXJmYWNlCiAgICAgICAgICBjaGFyQ29kZTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlwcmVzcyIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0RXZlbnRDaGFyQ29kZShldmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9LAogICAgICAgICAga2V5Q29kZTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlkb3duIiB8fCBldmVudC50eXBlID09PSAia2V5dXAiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmtleUNvZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9LAogICAgICAgICAgd2hpY2g6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAia2V5cHJlc3MiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldEV2ZW50Q2hhckNvZGUoZXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAia2V5ZG93biIgfHwgZXZlbnQudHlwZSA9PT0gImtleXVwIikgewogICAgICAgICAgICAgIHJldHVybiBldmVudC5rZXlDb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNLZXlib2FyZEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoS2V5Ym9hcmRFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFBvaW50ZXJFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHBvaW50ZXJJZDogMCwKICAgICAgICAgIHdpZHRoOiAwLAogICAgICAgICAgaGVpZ2h0OiAwLAogICAgICAgICAgcHJlc3N1cmU6IDAsCiAgICAgICAgICB0YW5nZW50aWFsUHJlc3N1cmU6IDAsCiAgICAgICAgICB0aWx0WDogMCwKICAgICAgICAgIHRpbHRZOiAwLAogICAgICAgICAgdHdpc3Q6IDAsCiAgICAgICAgICBwb2ludGVyVHlwZTogMCwKICAgICAgICAgIGlzUHJpbWFyeTogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNQb2ludGVyRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChQb2ludGVyRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBUb3VjaEV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAgdG91Y2hlczogMCwKICAgICAgICAgIHRhcmdldFRvdWNoZXM6IDAsCiAgICAgICAgICBjaGFuZ2VkVG91Y2hlczogMCwKICAgICAgICAgIGFsdEtleTogMCwKICAgICAgICAgIG1ldGFLZXk6IDAsCiAgICAgICAgICBjdHJsS2V5OiAwLAogICAgICAgICAgc2hpZnRLZXk6IDAsCiAgICAgICAgICBnZXRNb2RpZmllclN0YXRlOiBnZXRFdmVudE1vZGlmaWVyU3RhdGUKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljVG91Y2hFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFRvdWNoRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBUcmFuc2l0aW9uRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBFdmVudEludGVyZmFjZSwgewogICAgICAgICAgcHJvcGVydHlOYW1lOiAwLAogICAgICAgICAgZWxhcHNlZFRpbWU6IDAsCiAgICAgICAgICBwc2V1ZG9FbGVtZW50OiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1RyYW5zaXRpb25FdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFRyYW5zaXRpb25FdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFdoZWVsRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBNb3VzZUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBkZWx0YVg6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAiZGVsdGFYIiBpbiBldmVudCA/IGV2ZW50LmRlbHRhWCA6ICgKICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YVhgIGZvciBXZWJraXQgYW5kIG5vcm1hbGl6ZSAocmlnaHQgaXMgcG9zaXRpdmUpLgogICAgICAgICAgICAgICJ3aGVlbERlbHRhWCIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YVggOiAwCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVsdGFZOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gImRlbHRhWSIgaW4gZXZlbnQgPyBldmVudC5kZWx0YVkgOiAoCiAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gYHdoZWVsRGVsdGFZYCBmb3IgV2Via2l0IGFuZCBub3JtYWxpemUgKGRvd24gaXMgcG9zaXRpdmUpLgogICAgICAgICAgICAgICJ3aGVlbERlbHRhWSIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YVkgOiAoCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YWAgZm9yIElFPDkgYW5kIG5vcm1hbGl6ZSAoZG93biBpcyBwb3NpdGl2ZSkuCiAgICAgICAgICAgICAgICAid2hlZWxEZWx0YSIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YSA6IDAKICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVsdGFaOiAwLAogICAgICAgICAgLy8gQnJvd3NlcnMgd2l0aG91dCAiZGVsdGFNb2RlIiBpcyByZXBvcnRpbmcgaW4gcmF3IHdoZWVsIGRlbHRhIHdoZXJlIG9uZQogICAgICAgICAgLy8gbm90Y2ggb24gdGhlIHNjcm9sbCBpcyBhbHdheXMgKy8tIDEyMCwgcm91Z2hseSBlcXVpdmFsZW50IHRvIHBpeGVscy4KICAgICAgICAgIC8vIEEgZ29vZCBhcHByb3hpbWF0aW9uIG9mIERPTV9ERUxUQV9MSU5FICgxKSBpcyA1JSBvZiB2aWV3cG9ydCBzaXplIG9yCiAgICAgICAgICAvLyB+NDAgcGl4ZWxzLCBmb3IgRE9NX0RFTFRBX1NDUkVFTiAoMikgaXQgaXMgODcuNSUgb2Ygdmlld3BvcnQgc2l6ZS4KICAgICAgICAgIGRlbHRhTW9kZTogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNXaGVlbEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoV2hlZWxFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIEVORF9LRVlDT0RFUyA9IFs5LCAxMywgMjcsIDMyXTsKICAgICAgICB2YXIgU1RBUlRfS0VZQ09ERSA9IDIyOTsKICAgICAgICB2YXIgY2FuVXNlQ29tcG9zaXRpb25FdmVudCA9IGNhblVzZURPTTIgJiYgIkNvbXBvc2l0aW9uRXZlbnQiIGluIHdpbmRvdzsKICAgICAgICB2YXIgZG9jdW1lbnRNb2RlID0gbnVsbDsKICAgICAgICBpZiAoY2FuVXNlRE9NMiAmJiAiZG9jdW1lbnRNb2RlIiBpbiBkb2N1bWVudCkgewogICAgICAgICAgZG9jdW1lbnRNb2RlID0gZG9jdW1lbnQuZG9jdW1lbnRNb2RlOwogICAgICAgIH0KICAgICAgICB2YXIgY2FuVXNlVGV4dElucHV0RXZlbnQgPSBjYW5Vc2VET00yICYmICJUZXh0RXZlbnQiIGluIHdpbmRvdyAmJiAhZG9jdW1lbnRNb2RlOwogICAgICAgIHZhciB1c2VGYWxsYmFja0NvbXBvc2l0aW9uRGF0YSA9IGNhblVzZURPTTIgJiYgKCFjYW5Vc2VDb21wb3NpdGlvbkV2ZW50IHx8IGRvY3VtZW50TW9kZSAmJiBkb2N1bWVudE1vZGUgPiA4ICYmIGRvY3VtZW50TW9kZSA8PSAxMSk7CiAgICAgICAgdmFyIFNQQUNFQkFSX0NPREUgPSAzMjsKICAgICAgICB2YXIgU1BBQ0VCQVJfQ0hBUiA9IFN0cmluZy5mcm9tQ2hhckNvZGUoU1BBQ0VCQVJfQ09ERSk7CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMoKSB7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uQmVmb3JlSW5wdXQiLCBbImNvbXBvc2l0aW9uZW5kIiwgImtleXByZXNzIiwgInRleHRJbnB1dCIsICJwYXN0ZSJdKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25Db21wb3NpdGlvbkVuZCIsIFsiY29tcG9zaXRpb25lbmQiLCAiZm9jdXNvdXQiLCAia2V5ZG93biIsICJrZXlwcmVzcyIsICJrZXl1cCIsICJtb3VzZWRvd24iXSk7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uQ29tcG9zaXRpb25TdGFydCIsIFsiY29tcG9zaXRpb25zdGFydCIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25Db21wb3NpdGlvblVwZGF0ZSIsIFsiY29tcG9zaXRpb251cGRhdGUiLCAiZm9jdXNvdXQiLCAia2V5ZG93biIsICJrZXlwcmVzcyIsICJrZXl1cCIsICJtb3VzZWRvd24iXSk7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNTcGFjZUtleXByZXNzID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gaXNLZXlwcmVzc0NvbW1hbmQobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiAobmF0aXZlRXZlbnQuY3RybEtleSB8fCBuYXRpdmVFdmVudC5hbHRLZXkgfHwgbmF0aXZlRXZlbnQubWV0YUtleSkgJiYgLy8gY3RybEtleSAmJiBhbHRLZXkgaXMgZXF1aXZhbGVudCB0byBBbHRHciwgYW5kIGlzIG5vdCBhIGNvbW1hbmQuCiAgICAgICAgICAhKG5hdGl2ZUV2ZW50LmN0cmxLZXkgJiYgbmF0aXZlRXZlbnQuYWx0S2V5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcG9zaXRpb25FdmVudFR5cGUoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbnN0YXJ0IjoKICAgICAgICAgICAgICByZXR1cm4gIm9uQ29tcG9zaXRpb25TdGFydCI7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gIm9uQ29tcG9zaXRpb25FbmQiOwogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbnVwZGF0ZSI6CiAgICAgICAgICAgICAgcmV0dXJuICJvbkNvbXBvc2l0aW9uVXBkYXRlIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNGYWxsYmFja0NvbXBvc2l0aW9uU3RhcnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuIGRvbUV2ZW50TmFtZSA9PT0gImtleWRvd24iICYmIG5hdGl2ZUV2ZW50LmtleUNvZGUgPT09IFNUQVJUX0tFWUNPREU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRmFsbGJhY2tDb21wb3NpdGlvbkVuZChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJrZXl1cCI6CiAgICAgICAgICAgICAgcmV0dXJuIEVORF9LRVlDT0RFUy5pbmRleE9mKG5hdGl2ZUV2ZW50LmtleUNvZGUpICE9PSAtMTsKICAgICAgICAgICAgY2FzZSAia2V5ZG93biI6CiAgICAgICAgICAgICAgcmV0dXJuIG5hdGl2ZUV2ZW50LmtleUNvZGUgIT09IFNUQVJUX0tFWUNPREU7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGRldGFpbCA9IG5hdGl2ZUV2ZW50LmRldGFpbDsKICAgICAgICAgIGlmICh0eXBlb2YgZGV0YWlsID09PSAib2JqZWN0IiAmJiAiZGF0YSIgaW4gZGV0YWlsKSB7CiAgICAgICAgICAgIHJldHVybiBkZXRhaWwuZGF0YTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1VzaW5nS29yZWFuSU1FKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gbmF0aXZlRXZlbnQubG9jYWxlID09PSAia28iOwogICAgICAgIH0KICAgICAgICB2YXIgaXNDb21wb3NpbmcgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBleHRyYWN0Q29tcG9zaXRpb25FdmVudChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGV2ZW50VHlwZTsKICAgICAgICAgIHZhciBmYWxsYmFja0RhdGE7CiAgICAgICAgICBpZiAoY2FuVXNlQ29tcG9zaXRpb25FdmVudCkgewogICAgICAgICAgICBldmVudFR5cGUgPSBnZXRDb21wb3NpdGlvbkV2ZW50VHlwZShkb21FdmVudE5hbWUpOwogICAgICAgICAgfSBlbHNlIGlmICghaXNDb21wb3NpbmcpIHsKICAgICAgICAgICAgaWYgKGlzRmFsbGJhY2tDb21wb3NpdGlvblN0YXJ0KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgICAgZXZlbnRUeXBlID0gIm9uQ29tcG9zaXRpb25TdGFydCI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIGV2ZW50VHlwZSA9ICJvbkNvbXBvc2l0aW9uRW5kIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHVzZUZhbGxiYWNrQ29tcG9zaXRpb25EYXRhICYmICFpc1VzaW5nS29yZWFuSU1FKG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICBpZiAoIWlzQ29tcG9zaW5nICYmIGV2ZW50VHlwZSA9PT0gIm9uQ29tcG9zaXRpb25TdGFydCIpIHsKICAgICAgICAgICAgICBpc0NvbXBvc2luZyA9IGluaXRpYWxpemUobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV2ZW50VHlwZSA9PT0gIm9uQ29tcG9zaXRpb25FbmQiKSB7CiAgICAgICAgICAgICAgaWYgKGlzQ29tcG9zaW5nKSB7CiAgICAgICAgICAgICAgICBmYWxsYmFja0RhdGEgPSBnZXREYXRhKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gYWNjdW11bGF0ZVR3b1BoYXNlTGlzdGVuZXJzKHRhcmdldEluc3QsIGV2ZW50VHlwZSk7CiAgICAgICAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IFN5bnRoZXRpY0NvbXBvc2l0aW9uRXZlbnQoZXZlbnRUeXBlLCBkb21FdmVudE5hbWUsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoZmFsbGJhY2tEYXRhKSB7CiAgICAgICAgICAgICAgZXZlbnQuZGF0YSA9IGZhbGxiYWNrRGF0YTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgY3VzdG9tRGF0YSA9IGdldERhdGFGcm9tQ3VzdG9tRXZlbnQobmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgIGlmIChjdXN0b21EYXRhICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBldmVudC5kYXRhID0gY3VzdG9tRGF0YTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmF0aXZlQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIGdldERhdGFGcm9tQ3VzdG9tRXZlbnQobmF0aXZlRXZlbnQpOwogICAgICAgICAgICBjYXNlICJrZXlwcmVzcyI6CiAgICAgICAgICAgICAgdmFyIHdoaWNoID0gbmF0aXZlRXZlbnQud2hpY2g7CiAgICAgICAgICAgICAgaWYgKHdoaWNoICE9PSBTUEFDRUJBUl9DT0RFKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaGFzU3BhY2VLZXlwcmVzcyA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIFNQQUNFQkFSX0NIQVI7CiAgICAgICAgICAgIGNhc2UgInRleHRJbnB1dCI6CiAgICAgICAgICAgICAgdmFyIGNoYXJzID0gbmF0aXZlRXZlbnQuZGF0YTsKICAgICAgICAgICAgICBpZiAoY2hhcnMgPT09IFNQQUNFQkFSX0NIQVIgJiYgaGFzU3BhY2VLZXlwcmVzcykgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBjaGFyczsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RmFsbGJhY2tCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChpc0NvbXBvc2luZykgewogICAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiY29tcG9zaXRpb25lbmQiIHx8ICFjYW5Vc2VDb21wb3NpdGlvbkV2ZW50ICYmIGlzRmFsbGJhY2tDb21wb3NpdGlvbkVuZChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICAgIHZhciBjaGFycyA9IGdldERhdGEoKTsKICAgICAgICAgICAgICByZXNldCgpOwogICAgICAgICAgICAgIGlzQ29tcG9zaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAicGFzdGUiOgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlICJrZXlwcmVzcyI6CiAgICAgICAgICAgICAgaWYgKCFpc0tleXByZXNzQ29tbWFuZChuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5jaGFyICYmIG5hdGl2ZUV2ZW50LmNoYXIubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbmF0aXZlRXZlbnQuY2hhcjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobmF0aXZlRXZlbnQud2hpY2gpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUobmF0aXZlRXZlbnQud2hpY2gpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25lbmQiOgogICAgICAgICAgICAgIHJldHVybiB1c2VGYWxsYmFja0NvbXBvc2l0aW9uRGF0YSAmJiAhaXNVc2luZ0tvcmVhbklNRShuYXRpdmVFdmVudCkgPyBudWxsIDogbmF0aXZlRXZlbnQuZGF0YTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEJlZm9yZUlucHV0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgIHZhciBjaGFyczsKICAgICAgICAgIGlmIChjYW5Vc2VUZXh0SW5wdXRFdmVudCkgewogICAgICAgICAgICBjaGFycyA9IGdldE5hdGl2ZUJlZm9yZUlucHV0Q2hhcnMoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjaGFycyA9IGdldEZhbGxiYWNrQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghY2hhcnMpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gYWNjdW11bGF0ZVR3b1BoYXNlTGlzdGVuZXJzKHRhcmdldEluc3QsICJvbkJlZm9yZUlucHV0Iik7CiAgICAgICAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IFN5bnRoZXRpY0lucHV0RXZlbnQoIm9uQmVmb3JlSW5wdXQiLCAiYmVmb3JlaW5wdXQiLCBudWxsLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAgIGxpc3RlbmVycwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZXZlbnQuZGF0YSA9IGNoYXJzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIGV4dHJhY3RDb21wb3NpdGlvbkV2ZW50KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIGV4dHJhY3RCZWZvcmVJbnB1dEV2ZW50KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICB9CiAgICAgICAgdmFyIHN1cHBvcnRlZElucHV0VHlwZXMgPSB7CiAgICAgICAgICBjb2xvcjogdHJ1ZSwKICAgICAgICAgIGRhdGU6IHRydWUsCiAgICAgICAgICBkYXRldGltZTogdHJ1ZSwKICAgICAgICAgICJkYXRldGltZS1sb2NhbCI6IHRydWUsCiAgICAgICAgICBlbWFpbDogdHJ1ZSwKICAgICAgICAgIG1vbnRoOiB0cnVlLAogICAgICAgICAgbnVtYmVyOiB0cnVlLAogICAgICAgICAgcGFzc3dvcmQ6IHRydWUsCiAgICAgICAgICByYW5nZTogdHJ1ZSwKICAgICAgICAgIHNlYXJjaDogdHJ1ZSwKICAgICAgICAgIHRlbDogdHJ1ZSwKICAgICAgICAgIHRleHQ6IHRydWUsCiAgICAgICAgICB0aW1lOiB0cnVlLAogICAgICAgICAgdXJsOiB0cnVlLAogICAgICAgICAgd2VlazogdHJ1ZQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gaXNUZXh0SW5wdXRFbGVtZW50KGVsZW0pIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0gJiYgZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBpZiAobm9kZU5hbWUgPT09ICJpbnB1dCIpIHsKICAgICAgICAgICAgcmV0dXJuICEhc3VwcG9ydGVkSW5wdXRUeXBlc1tlbGVtLnR5cGVdOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGVOYW1lID09PSAidGV4dGFyZWEiKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0V2ZW50U3VwcG9ydGVkKGV2ZW50TmFtZVN1ZmZpeCkgewogICAgICAgICAgaWYgKCFjYW5Vc2VET00yKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudE5hbWUgPSAib24iICsgZXZlbnROYW1lU3VmZml4OwogICAgICAgICAgdmFyIGlzU3VwcG9ydGVkID0gZXZlbnROYW1lIGluIGRvY3VtZW50OwogICAgICAgICAgaWYgKCFpc1N1cHBvcnRlZCkgewogICAgICAgICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShldmVudE5hbWUsICJyZXR1cm47Iik7CiAgICAgICAgICAgIGlzU3VwcG9ydGVkID0gdHlwZW9mIGVsZW1lbnRbZXZlbnROYW1lXSA9PT0gImZ1bmN0aW9uIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpc1N1cHBvcnRlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMkMSgpIHsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25DaGFuZ2UiLCBbImNoYW5nZSIsICJjbGljayIsICJmb2N1c2luIiwgImZvY3Vzb3V0IiwgImlucHV0IiwgImtleWRvd24iLCAia2V5dXAiLCAic2VsZWN0aW9uY2hhbmdlIl0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVBbmRBY2N1bXVsYXRlQ2hhbmdlRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgaW5zdCwgbmF0aXZlRXZlbnQsIHRhcmdldCkgewogICAgICAgICAgZW5xdWV1ZVN0YXRlUmVzdG9yZSh0YXJnZXQpOwogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyhpbnN0LCAib25DaGFuZ2UiKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnQoIm9uQ2hhbmdlIiwgImNoYW5nZSIsIG51bGwsIG5hdGl2ZUV2ZW50LCB0YXJnZXQpOwogICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAgIGxpc3RlbmVycwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnQgPSBudWxsOwogICAgICAgIHZhciBhY3RpdmVFbGVtZW50SW5zdCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkVXNlQ2hhbmdlRXZlbnQoZWxlbSkgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgPT09ICJzZWxlY3QiIHx8IG5vZGVOYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gImZpbGUiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYW51YWxEaXNwYXRjaENoYW5nZUV2ZW50KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hRdWV1ZSA9IFtdOwogICAgICAgICAgY3JlYXRlQW5kQWNjdW11bGF0ZUNoYW5nZUV2ZW50KGRpc3BhdGNoUXVldWUsIGFjdGl2ZUVsZW1lbnRJbnN0LCBuYXRpdmVFdmVudCwgZ2V0RXZlbnRUYXJnZXQobmF0aXZlRXZlbnQpKTsKICAgICAgICAgIGJhdGNoZWRVcGRhdGVzKHJ1bkV2ZW50SW5CYXRjaCwgZGlzcGF0Y2hRdWV1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJ1bkV2ZW50SW5CYXRjaChkaXNwYXRjaFF1ZXVlKSB7CiAgICAgICAgICBwcm9jZXNzRGlzcGF0Y2hRdWV1ZShkaXNwYXRjaFF1ZXVlLCAwKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKHRhcmdldEluc3QpIHsKICAgICAgICAgIHZhciB0YXJnZXROb2RlID0gZ2V0Tm9kZUZyb21JbnN0YW5jZSh0YXJnZXRJbnN0KTsKICAgICAgICAgIGlmICh1cGRhdGVWYWx1ZUlmQ2hhbmdlZCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICByZXR1cm4gdGFyZ2V0SW5zdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGFyZ2V0SW5zdEZvckNoYW5nZUV2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImNoYW5nZSIpIHsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpc0lucHV0RXZlbnRTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICBpZiAoY2FuVXNlRE9NMikgewogICAgICAgICAgaXNJbnB1dEV2ZW50U3VwcG9ydGVkID0gaXNFdmVudFN1cHBvcnRlZCgiaW5wdXQiKSAmJiAoIWRvY3VtZW50LmRvY3VtZW50TW9kZSB8fCBkb2N1bWVudC5kb2N1bWVudE1vZGUgPiA5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKHRhcmdldCwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgYWN0aXZlRWxlbWVudCA9IHRhcmdldDsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnQuYXR0YWNoRXZlbnQoIm9ucHJvcGVydHljaGFuZ2UiLCBoYW5kbGVQcm9wZXJ0eUNoYW5nZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0b3BXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKCkgewogICAgICAgICAgaWYgKCFhY3RpdmVFbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGFjdGl2ZUVsZW1lbnQuZGV0YWNoRXZlbnQoIm9ucHJvcGVydHljaGFuZ2UiLCBoYW5kbGVQcm9wZXJ0eUNoYW5nZSk7CiAgICAgICAgICBhY3RpdmVFbGVtZW50ID0gbnVsbDsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlUHJvcGVydHlDaGFuZ2UobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5wcm9wZXJ0eU5hbWUgIT09ICJ2YWx1ZSIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldEluc3RJZlZhbHVlQ2hhbmdlZChhY3RpdmVFbGVtZW50SW5zdCkpIHsKICAgICAgICAgICAgbWFudWFsRGlzcGF0Y2hDaGFuZ2VFdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUV2ZW50c0ZvcklucHV0RXZlbnRQb2x5ZmlsbChkb21FdmVudE5hbWUsIHRhcmdldCwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImZvY3VzaW4iKSB7CiAgICAgICAgICAgIHN0b3BXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKCk7CiAgICAgICAgICAgIHN0YXJ0V2F0Y2hpbmdGb3JWYWx1ZUNoYW5nZSh0YXJnZXQsIHRhcmdldEluc3QpOwogICAgICAgICAgfSBlbHNlIGlmIChkb21FdmVudE5hbWUgPT09ICJmb2N1c291dCIpIHsKICAgICAgICAgICAgc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGFyZ2V0SW5zdEZvcklucHV0RXZlbnRQb2x5ZmlsbChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJzZWxlY3Rpb25jaGFuZ2UiIHx8IGRvbUV2ZW50TmFtZSA9PT0gImtleXVwIiB8fCBkb21FdmVudE5hbWUgPT09ICJrZXlkb3duIikgewogICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKGFjdGl2ZUVsZW1lbnRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkVXNlQ2xpY2tFdmVudChlbGVtKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lICYmIG5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYgKGVsZW0udHlwZSA9PT0gImNoZWNrYm94IiB8fCBlbGVtLnR5cGUgPT09ICJyYWRpbyIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9yQ2xpY2tFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjbGljayIpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEluc3RJZlZhbHVlQ2hhbmdlZCh0YXJnZXRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGFyZ2V0SW5zdEZvcklucHV0T3JDaGFuZ2VFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJpbnB1dCIgfHwgZG9tRXZlbnROYW1lID09PSAiY2hhbmdlIikgewogICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKHRhcmdldEluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVDb250cm9sbGVkSW5wdXRCbHVyKG5vZGUpIHsKICAgICAgICAgIHZhciBzdGF0ZSA9IG5vZGUuX3dyYXBwZXJTdGF0ZTsKICAgICAgICAgIGlmICghc3RhdGUgfHwgIXN0YXRlLmNvbnRyb2xsZWQgfHwgbm9kZS50eXBlICE9PSAibnVtYmVyIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldERlZmF1bHRWYWx1ZShub2RlLCAibnVtYmVyIiwgbm9kZS52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMkMShkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IHRhcmdldEluc3QgPyBnZXROb2RlRnJvbUluc3RhbmNlKHRhcmdldEluc3QpIDogd2luZG93OwogICAgICAgICAgdmFyIGdldFRhcmdldEluc3RGdW5jLCBoYW5kbGVFdmVudEZ1bmM7CiAgICAgICAgICBpZiAoc2hvdWxkVXNlQ2hhbmdlRXZlbnQodGFyZ2V0Tm9kZSkpIHsKICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9yQ2hhbmdlRXZlbnQ7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVGV4dElucHV0RWxlbWVudCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICBpZiAoaXNJbnB1dEV2ZW50U3VwcG9ydGVkKSB7CiAgICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRPckNoYW5nZUV2ZW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGdldFRhcmdldEluc3RGdW5jID0gZ2V0VGFyZ2V0SW5zdEZvcklucHV0RXZlbnRQb2x5ZmlsbDsKICAgICAgICAgICAgICBoYW5kbGVFdmVudEZ1bmMgPSBoYW5kbGVFdmVudHNGb3JJbnB1dEV2ZW50UG9seWZpbGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoc2hvdWxkVXNlQ2xpY2tFdmVudCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JDbGlja0V2ZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldFRhcmdldEluc3RGdW5jKSB7CiAgICAgICAgICAgIHZhciBpbnN0ID0gZ2V0VGFyZ2V0SW5zdEZ1bmMoZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0KTsKICAgICAgICAgICAgaWYgKGluc3QpIHsKICAgICAgICAgICAgICBjcmVhdGVBbmRBY2N1bXVsYXRlQ2hhbmdlRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgaW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChoYW5kbGVFdmVudEZ1bmMpIHsKICAgICAgICAgICAgaGFuZGxlRXZlbnRGdW5jKGRvbUV2ZW50TmFtZSwgdGFyZ2V0Tm9kZSwgdGFyZ2V0SW5zdCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiZm9jdXNvdXQiKSB7CiAgICAgICAgICAgIGhhbmRsZUNvbnRyb2xsZWRJbnB1dEJsdXIodGFyZ2V0Tm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDIoKSB7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvbk1vdXNlRW50ZXIiLCBbIm1vdXNlb3V0IiwgIm1vdXNlb3ZlciJdKTsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uTW91c2VMZWF2ZSIsIFsibW91c2VvdXQiLCAibW91c2VvdmVyIl0pOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudCgib25Qb2ludGVyRW50ZXIiLCBbInBvaW50ZXJvdXQiLCAicG9pbnRlcm92ZXIiXSk7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvblBvaW50ZXJMZWF2ZSIsIFsicG9pbnRlcm91dCIsICJwb2ludGVyb3ZlciJdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQyKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBpc092ZXJFdmVudCA9IGRvbUV2ZW50TmFtZSA9PT0gIm1vdXNlb3ZlciIgfHwgZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm92ZXIiOwogICAgICAgICAgdmFyIGlzT3V0RXZlbnQgPSBkb21FdmVudE5hbWUgPT09ICJtb3VzZW91dCIgfHwgZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm91dCI7CiAgICAgICAgICBpZiAoaXNPdmVyRXZlbnQgJiYgIWlzUmVwbGF5aW5nRXZlbnQobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIHZhciByZWxhdGVkID0gbmF0aXZlRXZlbnQucmVsYXRlZFRhcmdldCB8fCBuYXRpdmVFdmVudC5mcm9tRWxlbWVudDsKICAgICAgICAgICAgaWYgKHJlbGF0ZWQpIHsKICAgICAgICAgICAgICBpZiAoZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUocmVsYXRlZCkgfHwgaXNDb250YWluZXJNYXJrZWRBc1Jvb3QocmVsYXRlZCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNPdXRFdmVudCAmJiAhaXNPdmVyRXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdpbjsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudFRhcmdldC53aW5kb3cgPT09IG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICAgIHdpbiA9IG5hdGl2ZUV2ZW50VGFyZ2V0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGRvYyA9IG5hdGl2ZUV2ZW50VGFyZ2V0Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICAgIGlmIChkb2MpIHsKICAgICAgICAgICAgICB3aW4gPSBkb2MuZGVmYXVsdFZpZXcgfHwgZG9jLnBhcmVudFdpbmRvdzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3aW4gPSB3aW5kb3c7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmcm9tMjsKICAgICAgICAgIHZhciB0bzI7CiAgICAgICAgICBpZiAoaXNPdXRFdmVudCkgewogICAgICAgICAgICB2YXIgX3JlbGF0ZWQgPSBuYXRpdmVFdmVudC5yZWxhdGVkVGFyZ2V0IHx8IG5hdGl2ZUV2ZW50LnRvRWxlbWVudDsKICAgICAgICAgICAgZnJvbTIgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICB0bzIgPSBfcmVsYXRlZCA/IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKF9yZWxhdGVkKSA6IG51bGw7CiAgICAgICAgICAgIGlmICh0bzIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKHRvMik7CiAgICAgICAgICAgICAgaWYgKHRvMiAhPT0gbmVhcmVzdE1vdW50ZWQgfHwgdG8yLnRhZyAhPT0gSG9zdENvbXBvbmVudCAmJiB0bzIudGFnICE9PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgdG8yID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZyb20yID0gbnVsbDsKICAgICAgICAgICAgdG8yID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmcm9tMiA9PT0gdG8yKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNNb3VzZUV2ZW50OwogICAgICAgICAgdmFyIGxlYXZlRXZlbnRUeXBlID0gIm9uTW91c2VMZWF2ZSI7CiAgICAgICAgICB2YXIgZW50ZXJFdmVudFR5cGUgPSAib25Nb3VzZUVudGVyIjsKICAgICAgICAgIHZhciBldmVudFR5cGVQcmVmaXggPSAibW91c2UiOwogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gInBvaW50ZXJvdXQiIHx8IGRvbUV2ZW50TmFtZSA9PT0gInBvaW50ZXJvdmVyIikgewogICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNQb2ludGVyRXZlbnQ7CiAgICAgICAgICAgIGxlYXZlRXZlbnRUeXBlID0gIm9uUG9pbnRlckxlYXZlIjsKICAgICAgICAgICAgZW50ZXJFdmVudFR5cGUgPSAib25Qb2ludGVyRW50ZXIiOwogICAgICAgICAgICBldmVudFR5cGVQcmVmaXggPSAicG9pbnRlciI7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnJvbU5vZGUgPSBmcm9tMiA9PSBudWxsID8gd2luIDogZ2V0Tm9kZUZyb21JbnN0YW5jZShmcm9tMik7CiAgICAgICAgICB2YXIgdG9Ob2RlID0gdG8yID09IG51bGwgPyB3aW4gOiBnZXROb2RlRnJvbUluc3RhbmNlKHRvMik7CiAgICAgICAgICB2YXIgbGVhdmUgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKGxlYXZlRXZlbnRUeXBlLCBldmVudFR5cGVQcmVmaXggKyAibGVhdmUiLCBmcm9tMiwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIGxlYXZlLnRhcmdldCA9IGZyb21Ob2RlOwogICAgICAgICAgbGVhdmUucmVsYXRlZFRhcmdldCA9IHRvTm9kZTsKICAgICAgICAgIHZhciBlbnRlciA9IG51bGw7CiAgICAgICAgICB2YXIgbmF0aXZlVGFyZ2V0SW5zdCA9IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIGlmIChuYXRpdmVUYXJnZXRJbnN0ID09PSB0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgIHZhciBlbnRlckV2ZW50ID0gbmV3IFN5bnRoZXRpY0V2ZW50Q3RvcihlbnRlckV2ZW50VHlwZSwgZXZlbnRUeXBlUHJlZml4ICsgImVudGVyIiwgdG8yLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBlbnRlckV2ZW50LnRhcmdldCA9IHRvTm9kZTsKICAgICAgICAgICAgZW50ZXJFdmVudC5yZWxhdGVkVGFyZ2V0ID0gZnJvbU5vZGU7CiAgICAgICAgICAgIGVudGVyID0gZW50ZXJFdmVudDsKICAgICAgICAgIH0KICAgICAgICAgIGFjY3VtdWxhdGVFbnRlckxlYXZlVHdvUGhhc2VMaXN0ZW5lcnMoZGlzcGF0Y2hRdWV1ZSwgbGVhdmUsIGVudGVyLCBmcm9tMiwgdG8yKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXM0KHgyLCB5MikgewogICAgICAgICAgcmV0dXJuIHgyID09PSB5MiAmJiAoeDIgIT09IDAgfHwgMSAvIHgyID09PSAxIC8geTIpIHx8IHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgICAgICAgfQogICAgICAgIHZhciBvYmplY3RJcyA9IHR5cGVvZiBPYmplY3QuaXMgPT09ICJmdW5jdGlvbiIgPyBPYmplY3QuaXMgOiBpczQ7CiAgICAgICAgZnVuY3Rpb24gc2hhbGxvd0VxdWFsMihvYmpBLCBvYmpCKSB7CiAgICAgICAgICBpZiAob2JqZWN0SXMob2JqQSwgb2JqQikpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIG9iakEgIT09ICJvYmplY3QiIHx8IG9iakEgPT09IG51bGwgfHwgdHlwZW9mIG9iakIgIT09ICJvYmplY3QiIHx8IG9iakIgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGtleXNBID0gT2JqZWN0LmtleXMob2JqQSk7CiAgICAgICAgICB2YXIga2V5c0IgPSBPYmplY3Qua2V5cyhvYmpCKTsKICAgICAgICAgIGlmIChrZXlzQS5sZW5ndGggIT09IGtleXNCLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXNBLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50S2V5ID0ga2V5c0FbaV07CiAgICAgICAgICAgIGlmICghaGFzT3duUHJvcGVydHkuY2FsbChvYmpCLCBjdXJyZW50S2V5KSB8fCAhb2JqZWN0SXMob2JqQVtjdXJyZW50S2V5XSwgb2JqQltjdXJyZW50S2V5XSkpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRMZWFmTm9kZShub2RlKSB7CiAgICAgICAgICB3aGlsZSAobm9kZSAmJiBub2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuZmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTaWJsaW5nTm9kZShub2RlKSB7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICAgIHJldHVybiBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQocm9vdDMsIG9mZnNldCkgewogICAgICAgICAgdmFyIG5vZGUgPSBnZXRMZWFmTm9kZShyb290Myk7CiAgICAgICAgICB2YXIgbm9kZVN0YXJ0ID0gMDsKICAgICAgICAgIHZhciBub2RlRW5kID0gMDsKICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICAgICAgICBub2RlRW5kID0gbm9kZVN0YXJ0ICsgbm9kZS50ZXh0Q29udGVudC5sZW5ndGg7CiAgICAgICAgICAgICAgaWYgKG5vZGVTdGFydCA8PSBvZmZzZXQgJiYgbm9kZUVuZCA+PSBvZmZzZXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgIG5vZGUsCiAgICAgICAgICAgICAgICAgIG9mZnNldDogb2Zmc2V0IC0gbm9kZVN0YXJ0CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlU3RhcnQgPSBub2RlRW5kOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBnZXRMZWFmTm9kZShnZXRTaWJsaW5nTm9kZShub2RlKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE9mZnNldHMob3V0ZXJOb2RlKSB7CiAgICAgICAgICB2YXIgb3duZXJEb2N1bWVudCA9IG91dGVyTm9kZS5vd25lckRvY3VtZW50OwogICAgICAgICAgdmFyIHdpbiA9IG93bmVyRG9jdW1lbnQgJiYgb3duZXJEb2N1bWVudC5kZWZhdWx0VmlldyB8fCB3aW5kb3c7CiAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbiAmJiB3aW4uZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgICBpZiAoIXNlbGVjdGlvbiB8fCBzZWxlY3Rpb24ucmFuZ2VDb3VudCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhbmNob3JOb2RlID0gc2VsZWN0aW9uLmFuY2hvck5vZGUsIGFuY2hvck9mZnNldCA9IHNlbGVjdGlvbi5hbmNob3JPZmZzZXQsIGZvY3VzTm9kZSA9IHNlbGVjdGlvbi5mb2N1c05vZGUsIGZvY3VzT2Zmc2V0ID0gc2VsZWN0aW9uLmZvY3VzT2Zmc2V0OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYW5jaG9yTm9kZS5ub2RlVHlwZTsKICAgICAgICAgICAgZm9jdXNOb2RlLm5vZGVUeXBlOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXRNb2Rlcm5PZmZzZXRzRnJvbVBvaW50cyhvdXRlck5vZGUsIGFuY2hvck5vZGUsIGFuY2hvck9mZnNldCwgZm9jdXNOb2RlLCBmb2N1c09mZnNldCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE1vZGVybk9mZnNldHNGcm9tUG9pbnRzKG91dGVyTm9kZSwgYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0LCBmb2N1c05vZGUsIGZvY3VzT2Zmc2V0KSB7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gMDsKICAgICAgICAgIHZhciBzdGFydCA9IC0xOwogICAgICAgICAgdmFyIGVuZCA9IC0xOwogICAgICAgICAgdmFyIGluZGV4V2l0aGluQW5jaG9yID0gMDsKICAgICAgICAgIHZhciBpbmRleFdpdGhpbkZvY3VzID0gMDsKICAgICAgICAgIHZhciBub2RlID0gb3V0ZXJOb2RlOwogICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBudWxsOwogICAgICAgICAgb3V0ZXI6IHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHZhciBuZXh0ID0gbnVsbDsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gYW5jaG9yTm9kZSAmJiAoYW5jaG9yT2Zmc2V0ID09PSAwIHx8IG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkpIHsKICAgICAgICAgICAgICAgIHN0YXJ0ID0gbGVuZ3RoICsgYW5jaG9yT2Zmc2V0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZm9jdXNOb2RlICYmIChmb2N1c09mZnNldCA9PT0gMCB8fCBub2RlLm5vZGVUeXBlID09PSBURVhUX05PREUpKSB7CiAgICAgICAgICAgICAgICBlbmQgPSBsZW5ndGggKyBmb2N1c09mZnNldDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkgewogICAgICAgICAgICAgICAgbGVuZ3RoICs9IG5vZGUubm9kZVZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKChuZXh0ID0gbm9kZS5maXJzdENoaWxkKSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBhcmVudE5vZGUgPSBub2RlOwogICAgICAgICAgICAgIG5vZGUgPSBuZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IG91dGVyTm9kZSkgewogICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBhbmNob3JOb2RlICYmICsraW5kZXhXaXRoaW5BbmNob3IgPT09IGFuY2hvck9mZnNldCkgewogICAgICAgICAgICAgICAgc3RhcnQgPSBsZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBmb2N1c05vZGUgJiYgKytpbmRleFdpdGhpbkZvY3VzID09PSBmb2N1c09mZnNldCkgewogICAgICAgICAgICAgICAgZW5kID0gbGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKG5leHQgPSBub2RlLm5leHRTaWJsaW5nKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBwYXJlbnROb2RlOwogICAgICAgICAgICAgIHBhcmVudE5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc3RhcnQgPT09IC0xIHx8IGVuZCA9PT0gLTEpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBzdGFydCwKICAgICAgICAgICAgZW5kCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRPZmZzZXRzKG5vZGUsIG9mZnNldHMpIHsKICAgICAgICAgIHZhciBkb2MgPSBub2RlLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgICB2YXIgd2luID0gZG9jICYmIGRvYy5kZWZhdWx0VmlldyB8fCB3aW5kb3c7CiAgICAgICAgICBpZiAoIXdpbi5nZXRTZWxlY3Rpb24pIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNlbGVjdGlvbiA9IHdpbi5nZXRTZWxlY3Rpb24oKTsKICAgICAgICAgIHZhciBsZW5ndGggPSBub2RlLnRleHRDb250ZW50Lmxlbmd0aDsKICAgICAgICAgIHZhciBzdGFydCA9IE1hdGgubWluKG9mZnNldHMuc3RhcnQsIGxlbmd0aCk7CiAgICAgICAgICB2YXIgZW5kID0gb2Zmc2V0cy5lbmQgPT09IHZvaWQgMCA/IHN0YXJ0IDogTWF0aC5taW4ob2Zmc2V0cy5lbmQsIGxlbmd0aCk7CiAgICAgICAgICBpZiAoIXNlbGVjdGlvbi5leHRlbmQgJiYgc3RhcnQgPiBlbmQpIHsKICAgICAgICAgICAgdmFyIHRlbXAgPSBlbmQ7CiAgICAgICAgICAgIGVuZCA9IHN0YXJ0OwogICAgICAgICAgICBzdGFydCA9IHRlbXA7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhcnRNYXJrZXIgPSBnZXROb2RlRm9yQ2hhcmFjdGVyT2Zmc2V0KG5vZGUsIHN0YXJ0KTsKICAgICAgICAgIHZhciBlbmRNYXJrZXIgPSBnZXROb2RlRm9yQ2hhcmFjdGVyT2Zmc2V0KG5vZGUsIGVuZCk7CiAgICAgICAgICBpZiAoc3RhcnRNYXJrZXIgJiYgZW5kTWFya2VyKSB7CiAgICAgICAgICAgIGlmIChzZWxlY3Rpb24ucmFuZ2VDb3VudCA9PT0gMSAmJiBzZWxlY3Rpb24uYW5jaG9yTm9kZSA9PT0gc3RhcnRNYXJrZXIubm9kZSAmJiBzZWxlY3Rpb24uYW5jaG9yT2Zmc2V0ID09PSBzdGFydE1hcmtlci5vZmZzZXQgJiYgc2VsZWN0aW9uLmZvY3VzTm9kZSA9PT0gZW5kTWFya2VyLm5vZGUgJiYgc2VsZWN0aW9uLmZvY3VzT2Zmc2V0ID09PSBlbmRNYXJrZXIub2Zmc2V0KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByYW5nZTQgPSBkb2MuY3JlYXRlUmFuZ2UoKTsKICAgICAgICAgICAgcmFuZ2U0LnNldFN0YXJ0KHN0YXJ0TWFya2VyLm5vZGUsIHN0YXJ0TWFya2VyLm9mZnNldCk7CiAgICAgICAgICAgIHNlbGVjdGlvbi5yZW1vdmVBbGxSYW5nZXMoKTsKICAgICAgICAgICAgaWYgKHN0YXJ0ID4gZW5kKSB7CiAgICAgICAgICAgICAgc2VsZWN0aW9uLmFkZFJhbmdlKHJhbmdlNCk7CiAgICAgICAgICAgICAgc2VsZWN0aW9uLmV4dGVuZChlbmRNYXJrZXIubm9kZSwgZW5kTWFya2VyLm9mZnNldCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmFuZ2U0LnNldEVuZChlbmRNYXJrZXIubm9kZSwgZW5kTWFya2VyLm9mZnNldCk7CiAgICAgICAgICAgICAgc2VsZWN0aW9uLmFkZFJhbmdlKHJhbmdlNCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNUZXh0Tm9kZShub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZSAmJiBub2RlLm5vZGVUeXBlID09PSBURVhUX05PREU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnRhaW5zTm9kZShvdXRlck5vZGUsIGlubmVyTm9kZSkgewogICAgICAgICAgaWYgKCFvdXRlck5vZGUgfHwgIWlubmVyTm9kZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG91dGVyTm9kZSA9PT0gaW5uZXJOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIGlmIChpc1RleHROb2RlKG91dGVyTm9kZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChpc1RleHROb2RlKGlubmVyTm9kZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5zTm9kZShvdXRlck5vZGUsIGlubmVyTm9kZS5wYXJlbnROb2RlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoImNvbnRhaW5zIiBpbiBvdXRlck5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIG91dGVyTm9kZS5jb250YWlucyhpbm5lck5vZGUpOwogICAgICAgICAgfSBlbHNlIGlmIChvdXRlck5vZGUuY29tcGFyZURvY3VtZW50UG9zaXRpb24pIHsKICAgICAgICAgICAgcmV0dXJuICEhKG91dGVyTm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihpbm5lck5vZGUpICYgMTYpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0luRG9jdW1lbnQobm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUgJiYgbm9kZS5vd25lckRvY3VtZW50ICYmIGNvbnRhaW5zTm9kZShub2RlLm93bmVyRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBub2RlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTYW1lT3JpZ2luRnJhbWUoaWZyYW1lKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gdHlwZW9mIGlmcmFtZS5jb250ZW50V2luZG93LmxvY2F0aW9uLmhyZWYgPT09ICJzdHJpbmciOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0QWN0aXZlRWxlbWVudERlZXAoKSB7CiAgICAgICAgICB2YXIgd2luID0gd2luZG93OwogICAgICAgICAgdmFyIGVsZW1lbnQgPSBnZXRBY3RpdmVFbGVtZW50KCk7CiAgICAgICAgICB3aGlsZSAoZWxlbWVudCBpbnN0YW5jZW9mIHdpbi5IVE1MSUZyYW1lRWxlbWVudCkgewogICAgICAgICAgICBpZiAoaXNTYW1lT3JpZ2luRnJhbWUoZWxlbWVudCkpIHsKICAgICAgICAgICAgICB3aW4gPSBlbGVtZW50LmNvbnRlbnRXaW5kb3c7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudCA9IGdldEFjdGl2ZUVsZW1lbnQod2luLmRvY3VtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNTZWxlY3Rpb25DYXBhYmlsaXRpZXMoZWxlbSkgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbSAmJiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZSAmJiAobm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgKGVsZW0udHlwZSA9PT0gInRleHQiIHx8IGVsZW0udHlwZSA9PT0gInNlYXJjaCIgfHwgZWxlbS50eXBlID09PSAidGVsIiB8fCBlbGVtLnR5cGUgPT09ICJ1cmwiIHx8IGVsZW0udHlwZSA9PT0gInBhc3N3b3JkIikgfHwgbm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIgfHwgZWxlbS5jb250ZW50RWRpdGFibGUgPT09ICJ0cnVlIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdGlvbkluZm9ybWF0aW9uKCkgewogICAgICAgICAgdmFyIGZvY3VzZWRFbGVtID0gZ2V0QWN0aXZlRWxlbWVudERlZXAoKTsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGZvY3VzZWRFbGVtLAogICAgICAgICAgICBzZWxlY3Rpb25SYW5nZTogaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKGZvY3VzZWRFbGVtKSA/IGdldFNlbGVjdGlvbihmb2N1c2VkRWxlbSkgOiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlU2VsZWN0aW9uKHByaW9yU2VsZWN0aW9uSW5mb3JtYXRpb24pIHsKICAgICAgICAgIHZhciBjdXJGb2N1c2VkRWxlbSA9IGdldEFjdGl2ZUVsZW1lbnREZWVwKCk7CiAgICAgICAgICB2YXIgcHJpb3JGb2N1c2VkRWxlbSA9IHByaW9yU2VsZWN0aW9uSW5mb3JtYXRpb24uZm9jdXNlZEVsZW07CiAgICAgICAgICB2YXIgcHJpb3JTZWxlY3Rpb25SYW5nZSA9IHByaW9yU2VsZWN0aW9uSW5mb3JtYXRpb24uc2VsZWN0aW9uUmFuZ2U7CiAgICAgICAgICBpZiAoY3VyRm9jdXNlZEVsZW0gIT09IHByaW9yRm9jdXNlZEVsZW0gJiYgaXNJbkRvY3VtZW50KHByaW9yRm9jdXNlZEVsZW0pKSB7CiAgICAgICAgICAgIGlmIChwcmlvclNlbGVjdGlvblJhbmdlICE9PSBudWxsICYmIGhhc1NlbGVjdGlvbkNhcGFiaWxpdGllcyhwcmlvckZvY3VzZWRFbGVtKSkgewogICAgICAgICAgICAgIHNldFNlbGVjdGlvbihwcmlvckZvY3VzZWRFbGVtLCBwcmlvclNlbGVjdGlvblJhbmdlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYW5jZXN0b3JzID0gW107CiAgICAgICAgICAgIHZhciBhbmNlc3RvciA9IHByaW9yRm9jdXNlZEVsZW07CiAgICAgICAgICAgIHdoaWxlIChhbmNlc3RvciA9IGFuY2VzdG9yLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICBpZiAoYW5jZXN0b3Iubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgICAgYW5jZXN0b3JzLnB1c2goewogICAgICAgICAgICAgICAgICBlbGVtZW50OiBhbmNlc3RvciwKICAgICAgICAgICAgICAgICAgbGVmdDogYW5jZXN0b3Iuc2Nyb2xsTGVmdCwKICAgICAgICAgICAgICAgICAgdG9wOiBhbmNlc3Rvci5zY3JvbGxUb3AKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHByaW9yRm9jdXNlZEVsZW0uZm9jdXMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwcmlvckZvY3VzZWRFbGVtLmZvY3VzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhbmNlc3RvcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgaW5mbyA9IGFuY2VzdG9yc1tpXTsKICAgICAgICAgICAgICBpbmZvLmVsZW1lbnQuc2Nyb2xsTGVmdCA9IGluZm8ubGVmdDsKICAgICAgICAgICAgICBpbmZvLmVsZW1lbnQuc2Nyb2xsVG9wID0gaW5mby50b3A7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U2VsZWN0aW9uKGlucHV0KSB7CiAgICAgICAgICB2YXIgc2VsZWN0aW9uOwogICAgICAgICAgaWYgKCJzZWxlY3Rpb25TdGFydCIgaW4gaW5wdXQpIHsKICAgICAgICAgICAgc2VsZWN0aW9uID0gewogICAgICAgICAgICAgIHN0YXJ0OiBpbnB1dC5zZWxlY3Rpb25TdGFydCwKICAgICAgICAgICAgICBlbmQ6IGlucHV0LnNlbGVjdGlvbkVuZAogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZWN0aW9uID0gZ2V0T2Zmc2V0cyhpbnB1dCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc2VsZWN0aW9uIHx8IHsKICAgICAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgICAgIGVuZDogMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0U2VsZWN0aW9uKGlucHV0LCBvZmZzZXRzKSB7CiAgICAgICAgICB2YXIgc3RhcnQgPSBvZmZzZXRzLnN0YXJ0OwogICAgICAgICAgdmFyIGVuZCA9IG9mZnNldHMuZW5kOwogICAgICAgICAgaWYgKGVuZCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGVuZCA9IHN0YXJ0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKCJzZWxlY3Rpb25TdGFydCIgaW4gaW5wdXQpIHsKICAgICAgICAgICAgaW5wdXQuc2VsZWN0aW9uU3RhcnQgPSBzdGFydDsKICAgICAgICAgICAgaW5wdXQuc2VsZWN0aW9uRW5kID0gTWF0aC5taW4oZW5kLCBpbnB1dC52YWx1ZS5sZW5ndGgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2V0T2Zmc2V0cyhpbnB1dCwgb2Zmc2V0cyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBza2lwU2VsZWN0aW9uQ2hhbmdlRXZlbnQgPSBjYW5Vc2VET00yICYmICJkb2N1bWVudE1vZGUiIGluIGRvY3VtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50TW9kZSA8PSAxMTsKICAgICAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50cyQzKCkgewogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvblNlbGVjdCIsIFsiZm9jdXNvdXQiLCAiY29udGV4dG1lbnUiLCAiZHJhZ2VuZCIsICJmb2N1c2luIiwgImtleWRvd24iLCAia2V5dXAiLCAibW91c2Vkb3duIiwgIm1vdXNldXAiLCAic2VsZWN0aW9uY2hhbmdlIl0pOwogICAgICAgIH0KICAgICAgICB2YXIgYWN0aXZlRWxlbWVudCQxID0gbnVsbDsKICAgICAgICB2YXIgYWN0aXZlRWxlbWVudEluc3QkMSA9IG51bGw7CiAgICAgICAgdmFyIGxhc3RTZWxlY3Rpb24gPSBudWxsOwogICAgICAgIHZhciBtb3VzZURvd24gPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBnZXRTZWxlY3Rpb24kMShub2RlKSB7CiAgICAgICAgICBpZiAoInNlbGVjdGlvblN0YXJ0IiBpbiBub2RlICYmIGhhc1NlbGVjdGlvbkNhcGFiaWxpdGllcyhub2RlKSkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHN0YXJ0OiBub2RlLnNlbGVjdGlvblN0YXJ0LAogICAgICAgICAgICAgIGVuZDogbm9kZS5zZWxlY3Rpb25FbmQKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB3aW4gPSBub2RlLm93bmVyRG9jdW1lbnQgJiYgbm9kZS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3IHx8IHdpbmRvdzsKICAgICAgICAgICAgdmFyIHNlbGVjdGlvbiA9IHdpbi5nZXRTZWxlY3Rpb24oKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBhbmNob3JOb2RlOiBzZWxlY3Rpb24uYW5jaG9yTm9kZSwKICAgICAgICAgICAgICBhbmNob3JPZmZzZXQ6IHNlbGVjdGlvbi5hbmNob3JPZmZzZXQsCiAgICAgICAgICAgICAgZm9jdXNOb2RlOiBzZWxlY3Rpb24uZm9jdXNOb2RlLAogICAgICAgICAgICAgIGZvY3VzT2Zmc2V0OiBzZWxlY3Rpb24uZm9jdXNPZmZzZXQKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRUYXJnZXREb2N1bWVudChldmVudFRhcmdldCkgewogICAgICAgICAgcmV0dXJuIGV2ZW50VGFyZ2V0LndpbmRvdyA9PT0gZXZlbnRUYXJnZXQgPyBldmVudFRhcmdldC5kb2N1bWVudCA6IGV2ZW50VGFyZ2V0Lm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFID8gZXZlbnRUYXJnZXQgOiBldmVudFRhcmdldC5vd25lckRvY3VtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb25zdHJ1Y3RTZWxlY3RFdmVudChkaXNwYXRjaFF1ZXVlLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgIHZhciBkb2MgPSBnZXRFdmVudFRhcmdldERvY3VtZW50KG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIGlmIChtb3VzZURvd24gfHwgYWN0aXZlRWxlbWVudCQxID09IG51bGwgfHwgYWN0aXZlRWxlbWVudCQxICE9PSBnZXRBY3RpdmVFbGVtZW50KGRvYykpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRTZWxlY3Rpb24gPSBnZXRTZWxlY3Rpb24kMShhY3RpdmVFbGVtZW50JDEpOwogICAgICAgICAgaWYgKCFsYXN0U2VsZWN0aW9uIHx8ICFzaGFsbG93RXF1YWwyKGxhc3RTZWxlY3Rpb24sIGN1cnJlbnRTZWxlY3Rpb24pKSB7CiAgICAgICAgICAgIGxhc3RTZWxlY3Rpb24gPSBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gYWNjdW11bGF0ZVR3b1BoYXNlTGlzdGVuZXJzKGFjdGl2ZUVsZW1lbnRJbnN0JDEsICJvblNlbGVjdCIpOwogICAgICAgICAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnQoIm9uU2VsZWN0IiwgInNlbGVjdCIsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0ID0gYWN0aXZlRWxlbWVudCQxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMkMyhkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IHRhcmdldEluc3QgPyBnZXROb2RlRnJvbUluc3RhbmNlKHRhcmdldEluc3QpIDogd2luZG93OwogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiZm9jdXNpbiI6CiAgICAgICAgICAgICAgaWYgKGlzVGV4dElucHV0RWxlbWVudCh0YXJnZXROb2RlKSB8fCB0YXJnZXROb2RlLmNvbnRlbnRFZGl0YWJsZSA9PT0gInRydWUiKSB7CiAgICAgICAgICAgICAgICBhY3RpdmVFbGVtZW50JDEgPSB0YXJnZXROb2RlOwogICAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QkMSA9IHRhcmdldEluc3Q7CiAgICAgICAgICAgICAgICBsYXN0U2VsZWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgICBhY3RpdmVFbGVtZW50JDEgPSBudWxsOwogICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0JDEgPSBudWxsOwogICAgICAgICAgICAgIGxhc3RTZWxlY3Rpb24gPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICAgIG1vdXNlRG93biA9IHRydWU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImNvbnRleHRtZW51IjoKICAgICAgICAgICAgY2FzZSAibW91c2V1cCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdlbmQiOgogICAgICAgICAgICAgIG1vdXNlRG93biA9IGZhbHNlOwogICAgICAgICAgICAgIGNvbnN0cnVjdFNlbGVjdEV2ZW50KGRpc3BhdGNoUXVldWUsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdGlvbmNoYW5nZSI6CiAgICAgICAgICAgICAgaWYgKHNraXBTZWxlY3Rpb25DaGFuZ2VFdmVudCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgY2FzZSAia2V5dXAiOgogICAgICAgICAgICAgIGNvbnN0cnVjdFNlbGVjdEV2ZW50KGRpc3BhdGNoUXVldWUsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1ha2VQcmVmaXhNYXAoc3R5bGVQcm9wLCBldmVudE5hbWUpIHsKICAgICAgICAgIHZhciBwcmVmaXhlczMgPSB7fTsKICAgICAgICAgIHByZWZpeGVzM1tzdHlsZVByb3AudG9Mb3dlckNhc2UoKV0gPSBldmVudE5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHByZWZpeGVzM1siV2Via2l0IiArIHN0eWxlUHJvcF0gPSAid2Via2l0IiArIGV2ZW50TmFtZTsKICAgICAgICAgIHByZWZpeGVzM1siTW96IiArIHN0eWxlUHJvcF0gPSAibW96IiArIGV2ZW50TmFtZTsKICAgICAgICAgIHJldHVybiBwcmVmaXhlczM7CiAgICAgICAgfQogICAgICAgIHZhciB2ZW5kb3JQcmVmaXhlcyA9IHsKICAgICAgICAgIGFuaW1hdGlvbmVuZDogbWFrZVByZWZpeE1hcCgiQW5pbWF0aW9uIiwgIkFuaW1hdGlvbkVuZCIpLAogICAgICAgICAgYW5pbWF0aW9uaXRlcmF0aW9uOiBtYWtlUHJlZml4TWFwKCJBbmltYXRpb24iLCAiQW5pbWF0aW9uSXRlcmF0aW9uIiksCiAgICAgICAgICBhbmltYXRpb25zdGFydDogbWFrZVByZWZpeE1hcCgiQW5pbWF0aW9uIiwgIkFuaW1hdGlvblN0YXJ0IiksCiAgICAgICAgICB0cmFuc2l0aW9uZW5kOiBtYWtlUHJlZml4TWFwKCJUcmFuc2l0aW9uIiwgIlRyYW5zaXRpb25FbmQiKQogICAgICAgIH07CiAgICAgICAgdmFyIHByZWZpeGVkRXZlbnROYW1lcyA9IHt9OwogICAgICAgIHZhciBzdHlsZSA9IHt9OwogICAgICAgIGlmIChjYW5Vc2VET00yKSB7CiAgICAgICAgICBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLnN0eWxlOwogICAgICAgICAgaWYgKCEoIkFuaW1hdGlvbkV2ZW50IiBpbiB3aW5kb3cpKSB7CiAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy5hbmltYXRpb25lbmQuYW5pbWF0aW9uOwogICAgICAgICAgICBkZWxldGUgdmVuZG9yUHJlZml4ZXMuYW5pbWF0aW9uaXRlcmF0aW9uLmFuaW1hdGlvbjsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLmFuaW1hdGlvbnN0YXJ0LmFuaW1hdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghKCJUcmFuc2l0aW9uRXZlbnQiIGluIHdpbmRvdykpIHsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLnRyYW5zaXRpb25lbmQudHJhbnNpdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoZXZlbnROYW1lKSB7CiAgICAgICAgICBpZiAocHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV0pIHsKICAgICAgICAgICAgcmV0dXJuIHByZWZpeGVkRXZlbnROYW1lc1tldmVudE5hbWVdOwogICAgICAgICAgfSBlbHNlIGlmICghdmVuZG9yUHJlZml4ZXNbZXZlbnROYW1lXSkgewogICAgICAgICAgICByZXR1cm4gZXZlbnROYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZWZpeE1hcCA9IHZlbmRvclByZWZpeGVzW2V2ZW50TmFtZV07CiAgICAgICAgICBmb3IgKHZhciBzdHlsZVByb3AgaW4gcHJlZml4TWFwKSB7CiAgICAgICAgICAgIGlmIChwcmVmaXhNYXAuaGFzT3duUHJvcGVydHkoc3R5bGVQcm9wKSAmJiBzdHlsZVByb3AgaW4gc3R5bGUpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV0gPSBwcmVmaXhNYXBbc3R5bGVQcm9wXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV2ZW50TmFtZTsKICAgICAgICB9CiAgICAgICAgdmFyIEFOSU1BVElPTl9FTkQgPSBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZSgiYW5pbWF0aW9uZW5kIik7CiAgICAgICAgdmFyIEFOSU1BVElPTl9JVEVSQVRJT04gPSBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZSgiYW5pbWF0aW9uaXRlcmF0aW9uIik7CiAgICAgICAgdmFyIEFOSU1BVElPTl9TVEFSVCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJhbmltYXRpb25zdGFydCIpOwogICAgICAgIHZhciBUUkFOU0lUSU9OX0VORCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJ0cmFuc2l0aW9uZW5kIik7CiAgICAgICAgdmFyIHRvcExldmVsRXZlbnRzVG9SZWFjdE5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICB2YXIgc2ltcGxlRXZlbnRQbHVnaW5FdmVudHMgPSBbImFib3J0IiwgImF1eENsaWNrIiwgImNhbmNlbCIsICJjYW5QbGF5IiwgImNhblBsYXlUaHJvdWdoIiwgImNsaWNrIiwgImNsb3NlIiwgImNvbnRleHRNZW51IiwgImNvcHkiLCAiY3V0IiwgImRyYWciLCAiZHJhZ0VuZCIsICJkcmFnRW50ZXIiLCAiZHJhZ0V4aXQiLCAiZHJhZ0xlYXZlIiwgImRyYWdPdmVyIiwgImRyYWdTdGFydCIsICJkcm9wIiwgImR1cmF0aW9uQ2hhbmdlIiwgImVtcHRpZWQiLCAiZW5jcnlwdGVkIiwgImVuZGVkIiwgImVycm9yIiwgImdvdFBvaW50ZXJDYXB0dXJlIiwgImlucHV0IiwgImludmFsaWQiLCAia2V5RG93biIsICJrZXlQcmVzcyIsICJrZXlVcCIsICJsb2FkIiwgImxvYWRlZERhdGEiLCAibG9hZGVkTWV0YWRhdGEiLCAibG9hZFN0YXJ0IiwgImxvc3RQb2ludGVyQ2FwdHVyZSIsICJtb3VzZURvd24iLCAibW91c2VNb3ZlIiwgIm1vdXNlT3V0IiwgIm1vdXNlT3ZlciIsICJtb3VzZVVwIiwgInBhc3RlIiwgInBhdXNlIiwgInBsYXkiLCAicGxheWluZyIsICJwb2ludGVyQ2FuY2VsIiwgInBvaW50ZXJEb3duIiwgInBvaW50ZXJNb3ZlIiwgInBvaW50ZXJPdXQiLCAicG9pbnRlck92ZXIiLCAicG9pbnRlclVwIiwgInByb2dyZXNzIiwgInJhdGVDaGFuZ2UiLCAicmVzZXQiLCAicmVzaXplIiwgInNlZWtlZCIsICJzZWVraW5nIiwgInN0YWxsZWQiLCAic3VibWl0IiwgInN1c3BlbmQiLCAidGltZVVwZGF0ZSIsICJ0b3VjaENhbmNlbCIsICJ0b3VjaEVuZCIsICJ0b3VjaFN0YXJ0IiwgInZvbHVtZUNoYW5nZSIsICJzY3JvbGwiLCAidG9nZ2xlIiwgInRvdWNoTW92ZSIsICJ3YWl0aW5nIiwgIndoZWVsIl07CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTaW1wbGVFdmVudChkb21FdmVudE5hbWUsIHJlYWN0TmFtZSkgewogICAgICAgICAgdG9wTGV2ZWxFdmVudHNUb1JlYWN0TmFtZXMuc2V0KGRvbUV2ZW50TmFtZSwgcmVhY3ROYW1lKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudChyZWFjdE5hbWUsIFtkb21FdmVudE5hbWVdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTaW1wbGVFdmVudHMoKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNpbXBsZUV2ZW50UGx1Z2luRXZlbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSBzaW1wbGVFdmVudFBsdWdpbkV2ZW50c1tpXTsKICAgICAgICAgICAgdmFyIGRvbUV2ZW50TmFtZSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB2YXIgY2FwaXRhbGl6ZWRFdmVudCA9IGV2ZW50TmFtZVswXS50b1VwcGVyQ2FzZSgpICsgZXZlbnROYW1lLnNsaWNlKDEpOwogICAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KGRvbUV2ZW50TmFtZSwgIm9uIiArIGNhcGl0YWxpemVkRXZlbnQpOwogICAgICAgICAgfQogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChBTklNQVRJT05fRU5ELCAib25BbmltYXRpb25FbmQiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoQU5JTUFUSU9OX0lURVJBVElPTiwgIm9uQW5pbWF0aW9uSXRlcmF0aW9uIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KEFOSU1BVElPTl9TVEFSVCwgIm9uQW5pbWF0aW9uU3RhcnQiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoImRibGNsaWNrIiwgIm9uRG91YmxlQ2xpY2siKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoImZvY3VzaW4iLCAib25Gb2N1cyIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudCgiZm9jdXNvdXQiLCAib25CbHVyIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KFRSQU5TSVRJT05fRU5ELCAib25UcmFuc2l0aW9uRW5kIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMkNChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgcmVhY3ROYW1lID0gdG9wTGV2ZWxFdmVudHNUb1JlYWN0TmFtZXMuZ2V0KGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICBpZiAocmVhY3ROYW1lID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0V2ZW50OwogICAgICAgICAgdmFyIHJlYWN0RXZlbnRUeXBlID0gZG9tRXZlbnROYW1lOwogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICAgIGlmIChnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KSA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAia2V5ZG93biI6CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNLZXlib2FyZEV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgICByZWFjdEV2ZW50VHlwZSA9ICJmb2N1cyI7CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRm9jdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICAgIHJlYWN0RXZlbnRUeXBlID0gImJsdXIiOwogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0ZvY3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImJlZm9yZWJsdXIiOgogICAgICAgICAgICBjYXNlICJhZnRlcmJsdXIiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0ZvY3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImNsaWNrIjoKICAgICAgICAgICAgICBpZiAobmF0aXZlRXZlbnQuYnV0dG9uID09PSAyKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJhdXhjbGljayI6CiAgICAgICAgICAgIGNhc2UgImRibGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vtb3ZlIjoKICAgICAgICAgICAgY2FzZSAibW91c2V1cCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjoKICAgICAgICAgICAgY2FzZSAiY29udGV4dG1lbnUiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY01vdXNlRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRyYWciOgogICAgICAgICAgICBjYXNlICJkcmFnZW5kIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VudGVyIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2V4aXQiOgogICAgICAgICAgICBjYXNlICJkcmFnbGVhdmUiOgogICAgICAgICAgICBjYXNlICJkcmFnb3ZlciI6CiAgICAgICAgICAgIGNhc2UgImRyYWdzdGFydCI6CiAgICAgICAgICAgIGNhc2UgImRyb3AiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0RyYWdFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidG91Y2hjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJ0b3VjaGVuZCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNobW92ZSI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoc3RhcnQiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1RvdWNoRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQU5JTUFUSU9OX0VORDoKICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fSVRFUkFUSU9OOgogICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9TVEFSVDoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNBbmltYXRpb25FdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUUkFOU0lUSU9OX0VORDoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNUcmFuc2l0aW9uRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNjcm9sbCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljVUlFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAid2hlZWwiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1doZWVsRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImNvcHkiOgogICAgICAgICAgICBjYXNlICJjdXQiOgogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljQ2xpcGJvYXJkRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAibG9zdHBvaW50ZXJjYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJkb3duIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm1vdmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3V0IjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm92ZXIiOgogICAgICAgICAgICBjYXNlICJwb2ludGVydXAiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1BvaW50ZXJFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbkNhcHR1cmVQaGFzZSA9IChldmVudFN5c3RlbUZsYWdzICYgSVNfQ0FQVFVSRV9QSEFTRSkgIT09IDA7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBhY2N1bXVsYXRlVGFyZ2V0T25seSA9ICFpbkNhcHR1cmVQaGFzZSAmJiAvLyBUT0RPOiBpZGVhbGx5LCB3ZSdkIGV2ZW50dWFsbHkgYWRkIGFsbCBldmVudHMgZnJvbQogICAgICAgICAgICAvLyBub25EZWxlZ2F0ZWRFdmVudHMgbGlzdCBpbiBET01QbHVnaW5FdmVudFN5c3RlbS4KICAgICAgICAgICAgLy8gVGhlbiB3ZSBjYW4gcmVtb3ZlIHRoaXMgc3BlY2lhbCBsaXN0LgogICAgICAgICAgICAvLyBUaGlzIGlzIGEgYnJlYWtpbmcgY2hhbmdlIHRoYXQgY2FuIHdhaXQgdW50aWwgUmVhY3QgMTguCiAgICAgICAgICAgIGRvbUV2ZW50TmFtZSA9PT0gInNjcm9sbCI7CiAgICAgICAgICAgIHZhciBfbGlzdGVuZXJzID0gYWNjdW11bGF0ZVNpbmdsZVBoYXNlTGlzdGVuZXJzKHRhcmdldEluc3QsIHJlYWN0TmFtZSwgbmF0aXZlRXZlbnQudHlwZSwgaW5DYXB0dXJlUGhhc2UsIGFjY3VtdWxhdGVUYXJnZXRPbmx5KTsKICAgICAgICAgICAgaWYgKF9saXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHZhciBfZXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKHJlYWN0TmFtZSwgcmVhY3RFdmVudFR5cGUsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGV2ZW50OiBfZXZlbnQsCiAgICAgICAgICAgICAgICBsaXN0ZW5lcnM6IF9saXN0ZW5lcnMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50cygpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzJDIoKTsKICAgICAgICByZWdpc3RlckV2ZW50cyQxKCk7CiAgICAgICAgcmVnaXN0ZXJFdmVudHMkMygpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzKCk7CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQ1KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIGV4dHJhY3RFdmVudHMkNChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgICB2YXIgc2hvdWxkUHJvY2Vzc1BvbHlmaWxsUGx1Z2lucyA9IChldmVudFN5c3RlbUZsYWdzICYgU0hPVUxEX05PVF9QUk9DRVNTX1BPTFlGSUxMX0VWRU5UX1BMVUdJTlMpID09PSAwOwogICAgICAgICAgaWYgKHNob3VsZFByb2Nlc3NQb2x5ZmlsbFBsdWdpbnMpIHsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQyKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQxKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyhkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBtZWRpYUV2ZW50VHlwZXMgPSBbImFib3J0IiwgImNhbnBsYXkiLCAiY2FucGxheXRocm91Z2giLCAiZHVyYXRpb25jaGFuZ2UiLCAiZW1wdGllZCIsICJlbmNyeXB0ZWQiLCAiZW5kZWQiLCAiZXJyb3IiLCAibG9hZGVkZGF0YSIsICJsb2FkZWRtZXRhZGF0YSIsICJsb2Fkc3RhcnQiLCAicGF1c2UiLCAicGxheSIsICJwbGF5aW5nIiwgInByb2dyZXNzIiwgInJhdGVjaGFuZ2UiLCAicmVzaXplIiwgInNlZWtlZCIsICJzZWVraW5nIiwgInN0YWxsZWQiLCAic3VzcGVuZCIsICJ0aW1ldXBkYXRlIiwgInZvbHVtZWNoYW5nZSIsICJ3YWl0aW5nIl07CiAgICAgICAgdmFyIG5vbkRlbGVnYXRlZEV2ZW50cyA9IG5ldyBTZXQoWyJjYW5jZWwiLCAiY2xvc2UiLCAiaW52YWxpZCIsICJsb2FkIiwgInNjcm9sbCIsICJ0b2dnbGUiXS5jb25jYXQobWVkaWFFdmVudFR5cGVzKSk7CiAgICAgICAgZnVuY3Rpb24gZXhlY3V0ZURpc3BhdGNoKGV2ZW50LCBsaXN0ZW5lcjIsIGN1cnJlbnRUYXJnZXQpIHsKICAgICAgICAgIHZhciB0eXBlID0gZXZlbnQudHlwZSB8fCAidW5rbm93bi1ldmVudCI7CiAgICAgICAgICBldmVudC5jdXJyZW50VGFyZ2V0ID0gY3VycmVudFRhcmdldDsKICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0FuZENhdGNoRmlyc3RFcnJvcih0eXBlLCBsaXN0ZW5lcjIsIHZvaWQgMCwgZXZlbnQpOwogICAgICAgICAgZXZlbnQuY3VycmVudFRhcmdldCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NEaXNwYXRjaFF1ZXVlSXRlbXNJbk9yZGVyKGV2ZW50LCBkaXNwYXRjaExpc3RlbmVycywgaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgIHZhciBwcmV2aW91c0luc3RhbmNlOwogICAgICAgICAgaWYgKGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBkaXNwYXRjaExpc3RlbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgIHZhciBfZGlzcGF0Y2hMaXN0ZW5lcnMkaSA9IGRpc3BhdGNoTGlzdGVuZXJzW2ldLCBpbnN0YW5jZSA9IF9kaXNwYXRjaExpc3RlbmVycyRpLmluc3RhbmNlLCBjdXJyZW50VGFyZ2V0ID0gX2Rpc3BhdGNoTGlzdGVuZXJzJGkuY3VycmVudFRhcmdldCwgbGlzdGVuZXIyID0gX2Rpc3BhdGNoTGlzdGVuZXJzJGkubGlzdGVuZXI7CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBwcmV2aW91c0luc3RhbmNlICYmIGV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXhlY3V0ZURpc3BhdGNoKGV2ZW50LCBsaXN0ZW5lcjIsIGN1cnJlbnRUYXJnZXQpOwogICAgICAgICAgICAgIHByZXZpb3VzSW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGRpc3BhdGNoTGlzdGVuZXJzLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgIHZhciBfZGlzcGF0Y2hMaXN0ZW5lcnMkX2kgPSBkaXNwYXRjaExpc3RlbmVyc1tfaV0sIF9pbnN0YW5jZSA9IF9kaXNwYXRjaExpc3RlbmVycyRfaS5pbnN0YW5jZSwgX2N1cnJlbnRUYXJnZXQgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkX2kuY3VycmVudFRhcmdldCwgX2xpc3RlbmVyID0gX2Rpc3BhdGNoTGlzdGVuZXJzJF9pLmxpc3RlbmVyOwogICAgICAgICAgICAgIGlmIChfaW5zdGFuY2UgIT09IHByZXZpb3VzSW5zdGFuY2UgJiYgZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBleGVjdXRlRGlzcGF0Y2goZXZlbnQsIF9saXN0ZW5lciwgX2N1cnJlbnRUYXJnZXQpOwogICAgICAgICAgICAgIHByZXZpb3VzSW5zdGFuY2UgPSBfaW5zdGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgZXZlbnRTeXN0ZW1GbGFncykgewogICAgICAgICAgdmFyIGluQ2FwdHVyZVBoYXNlID0gKGV2ZW50U3lzdGVtRmxhZ3MgJiBJU19DQVBUVVJFX1BIQVNFKSAhPT0gMDsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGlzcGF0Y2hRdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgX2Rpc3BhdGNoUXVldWUkaSA9IGRpc3BhdGNoUXVldWVbaV0sIGV2ZW50ID0gX2Rpc3BhdGNoUXVldWUkaS5ldmVudCwgbGlzdGVuZXJzID0gX2Rpc3BhdGNoUXVldWUkaS5saXN0ZW5lcnM7CiAgICAgICAgICAgIHByb2Nlc3NEaXNwYXRjaFF1ZXVlSXRlbXNJbk9yZGVyKGV2ZW50LCBsaXN0ZW5lcnMsIGluQ2FwdHVyZVBoYXNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldGhyb3dDYXVnaHRFcnJvcigpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50c0ZvclBsdWdpbnMoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgbmF0aXZlRXZlbnRUYXJnZXQgPSBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCk7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hRdWV1ZSA9IFtdOwogICAgICAgICAgZXh0cmFjdEV2ZW50cyQ1KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzKTsKICAgICAgICAgIHByb2Nlc3NEaXNwYXRjaFF1ZXVlKGRpc3BhdGNoUXVldWUsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0RWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIW5vbkRlbGVnYXRlZEV2ZW50cy5oYXMoZG9tRXZlbnROYW1lKSkgewogICAgICAgICAgICAgIGVycm9yKCdEaWQgbm90IGV4cGVjdCBhIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoKSBjYWxsIGZvciAiJXMiLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4nLCBkb21FdmVudE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lciA9IGZhbHNlOwogICAgICAgICAgdmFyIGxpc3RlbmVyU2V0ID0gZ2V0RXZlbnRMaXN0ZW5lclNldCh0YXJnZXRFbGVtZW50KTsKICAgICAgICAgIHZhciBsaXN0ZW5lclNldEtleSA9IGdldExpc3RlbmVyU2V0S2V5KGRvbUV2ZW50TmFtZSwgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcik7CiAgICAgICAgICBpZiAoIWxpc3RlbmVyU2V0LmhhcyhsaXN0ZW5lclNldEtleSkpIHsKICAgICAgICAgICAgYWRkVHJhcHBlZEV2ZW50TGlzdGVuZXIodGFyZ2V0RWxlbWVudCwgZG9tRXZlbnROYW1lLCBJU19OT05fREVMRUdBVEVELCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKTsKICAgICAgICAgICAgbGlzdGVuZXJTZXQuYWRkKGxpc3RlbmVyU2V0S2V5KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGlzdGVuVG9OYXRpdmVFdmVudChkb21FdmVudE5hbWUsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIsIHRhcmdldCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAobm9uRGVsZWdhdGVkRXZlbnRzLmhhcyhkb21FdmVudE5hbWUpICYmICFpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ0RpZCBub3QgZXhwZWN0IGEgbGlzdGVuVG9OYXRpdmVFdmVudCgpIGNhbGwgZm9yICIlcyIgaW4gdGhlIGJ1YmJsZSBwaGFzZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuJywgZG9tRXZlbnROYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50U3lzdGVtRmxhZ3MgPSAwOwogICAgICAgICAgaWYgKGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgZXZlbnRTeXN0ZW1GbGFncyB8PSBJU19DQVBUVVJFX1BIQVNFOwogICAgICAgICAgfQogICAgICAgICAgYWRkVHJhcHBlZEV2ZW50TGlzdGVuZXIodGFyZ2V0LCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgbGlzdGVuaW5nTWFya2VyID0gIl9yZWFjdExpc3RlbmluZyIgKyBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKTsKICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhyb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgaWYgKCFyb290Q29udGFpbmVyRWxlbWVudFtsaXN0ZW5pbmdNYXJrZXJdKSB7CiAgICAgICAgICAgIHJvb3RDb250YWluZXJFbGVtZW50W2xpc3RlbmluZ01hcmtlcl0gPSB0cnVlOwogICAgICAgICAgICBhbGxOYXRpdmVFdmVudHMuZm9yRWFjaChmdW5jdGlvbihkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lICE9PSAic2VsZWN0aW9uY2hhbmdlIikgewogICAgICAgICAgICAgICAgaWYgKCFub25EZWxlZ2F0ZWRFdmVudHMuaGFzKGRvbUV2ZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9OYXRpdmVFdmVudChkb21FdmVudE5hbWUsIGZhbHNlLCByb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgdHJ1ZSwgcm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBvd25lckRvY3VtZW50ID0gcm9vdENvbnRhaW5lckVsZW1lbnQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyByb290Q29udGFpbmVyRWxlbWVudCA6IHJvb3RDb250YWluZXJFbGVtZW50Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICAgIGlmIChvd25lckRvY3VtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKCFvd25lckRvY3VtZW50W2xpc3RlbmluZ01hcmtlcl0pIHsKICAgICAgICAgICAgICAgIG93bmVyRG9jdW1lbnRbbGlzdGVuaW5nTWFya2VyXSA9IHRydWU7CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05hdGl2ZUV2ZW50KCJzZWxlY3Rpb25jaGFuZ2UiLCBmYWxzZSwgb3duZXJEb2N1bWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZFRyYXBwZWRFdmVudExpc3RlbmVyKHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyLCBpc0RlZmVycmVkTGlzdGVuZXJGb3JMZWdhY3lGQlN1cHBvcnQpIHsKICAgICAgICAgIHZhciBsaXN0ZW5lcjIgPSBjcmVhdGVFdmVudExpc3RlbmVyV3JhcHBlcldpdGhQcmlvcml0eSh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgICB2YXIgaXNQYXNzaXZlTGlzdGVuZXIgPSB2b2lkIDA7CiAgICAgICAgICBpZiAocGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQpIHsKICAgICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gInRvdWNoc3RhcnQiIHx8IGRvbUV2ZW50TmFtZSA9PT0gInRvdWNobW92ZSIgfHwgZG9tRXZlbnROYW1lID09PSAid2hlZWwiKSB7CiAgICAgICAgICAgICAgaXNQYXNzaXZlTGlzdGVuZXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0YXJnZXRDb250YWluZXIgPSB0YXJnZXRDb250YWluZXI7CiAgICAgICAgICB2YXIgdW5zdWJzY3JpYmVMaXN0ZW5lcjsKICAgICAgICAgIGlmIChpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKSB7CiAgICAgICAgICAgIGlmIChpc1Bhc3NpdmVMaXN0ZW5lciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdW5zdWJzY3JpYmVMaXN0ZW5lciA9IGFkZEV2ZW50Q2FwdHVyZUxpc3RlbmVyV2l0aFBhc3NpdmVGbGFnKHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBsaXN0ZW5lcjIsIGlzUGFzc2l2ZUxpc3RlbmVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChpc1Bhc3NpdmVMaXN0ZW5lciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdW5zdWJzY3JpYmVMaXN0ZW5lciA9IGFkZEV2ZW50QnViYmxlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyMiwgaXNQYXNzaXZlTGlzdGVuZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVuc3Vic2NyaWJlTGlzdGVuZXIgPSBhZGRFdmVudEJ1YmJsZUxpc3RlbmVyKHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBsaXN0ZW5lcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzTWF0Y2hpbmdSb290Q29udGFpbmVyKGdyYW5kQ29udGFpbmVyLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHJldHVybiBncmFuZENvbnRhaW5lciA9PT0gdGFyZ2V0Q29udGFpbmVyIHx8IGdyYW5kQ29udGFpbmVyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgJiYgZ3JhbmRDb250YWluZXIucGFyZW50Tm9kZSA9PT0gdGFyZ2V0Q29udGFpbmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgYW5jZXN0b3JJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIGlmICgoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0VWRU5UX0hBTkRMRV9OT05fTUFOQUdFRF9OT0RFKSA9PT0gMCAmJiAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX05PTl9ERUxFR0FURUQpID09PSAwKSB7CiAgICAgICAgICAgIHZhciB0YXJnZXRDb250YWluZXJOb2RlID0gdGFyZ2V0Q29udGFpbmVyOwogICAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBub2RlID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgICBtYWluTG9vcDogd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBub2RlVGFnID0gbm9kZS50YWc7CiAgICAgICAgICAgICAgICBpZiAobm9kZVRhZyA9PT0gSG9zdFJvb3QgfHwgbm9kZVRhZyA9PT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICAgIGlmIChpc01hdGNoaW5nUm9vdENvbnRhaW5lcihjb250YWluZXIyLCB0YXJnZXRDb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChub2RlVGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGdyYW5kTm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIHdoaWxlIChncmFuZE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBncmFuZFRhZyA9IGdyYW5kTm9kZS50YWc7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZ3JhbmRUYWcgPT09IEhvc3RSb290IHx8IGdyYW5kVGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBncmFuZENvbnRhaW5lciA9IGdyYW5kTm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdSb290Q29udGFpbmVyKGdyYW5kQ29udGFpbmVyLCB0YXJnZXRDb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZ3JhbmROb2RlID0gZ3JhbmROb2RlLnJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgd2hpbGUgKGNvbnRhaW5lcjIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUYWcgPSBwYXJlbnROb2RlLnRhZzsKICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50VGFnID09PSBIb3N0Q29tcG9uZW50IHx8IHBhcmVudFRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBhbmNlc3Rvckluc3QgPSBwYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgICAgY29udGludWUgbWFpbkxvb3A7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcjIgPSBjb250YWluZXIyLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJhdGNoZWRVcGRhdGVzKGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hFdmVudHNGb3JQbHVnaW5zKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIGFuY2VzdG9ySW5zdCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgbGlzdGVuZXIyLCBjdXJyZW50VGFyZ2V0KSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBpbnN0YW5jZSwKICAgICAgICAgICAgbGlzdGVuZXI6IGxpc3RlbmVyMiwKICAgICAgICAgICAgY3VycmVudFRhcmdldAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZVNpbmdsZVBoYXNlTGlzdGVuZXJzKHRhcmdldEZpYmVyLCByZWFjdE5hbWUsIG5hdGl2ZUV2ZW50VHlwZSwgaW5DYXB0dXJlUGhhc2UsIGFjY3VtdWxhdGVUYXJnZXRPbmx5LCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGNhcHR1cmVOYW1lID0gcmVhY3ROYW1lICE9PSBudWxsID8gcmVhY3ROYW1lICsgIkNhcHR1cmUiIDogbnVsbDsKICAgICAgICAgIHZhciByZWFjdEV2ZW50TmFtZSA9IGluQ2FwdHVyZVBoYXNlID8gY2FwdHVyZU5hbWUgOiByZWFjdE5hbWU7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXRGaWJlcjsKICAgICAgICAgIHZhciBsYXN0SG9zdENvbXBvbmVudCA9IG51bGw7CiAgICAgICAgICB3aGlsZSAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTIgPSBpbnN0YW5jZSwgc3RhdGVOb2RlID0gX2luc3RhbmNlMi5zdGF0ZU5vZGUsIHRhZyA9IF9pbnN0YW5jZTIudGFnOwogICAgICAgICAgICBpZiAodGFnID09PSBIb3N0Q29tcG9uZW50ICYmIHN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGxhc3RIb3N0Q29tcG9uZW50ID0gc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChyZWFjdEV2ZW50TmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGxpc3RlbmVyMiA9IGdldExpc3RlbmVyKGluc3RhbmNlLCByZWFjdEV2ZW50TmFtZSk7CiAgICAgICAgICAgICAgICBpZiAobGlzdGVuZXIyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnB1c2goY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgbGlzdGVuZXIyLCBsYXN0SG9zdENvbXBvbmVudCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYWNjdW11bGF0ZVRhcmdldE9ubHkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyh0YXJnZXRGaWJlciwgcmVhY3ROYW1lKSB7CiAgICAgICAgICB2YXIgY2FwdHVyZU5hbWUgPSByZWFjdE5hbWUgKyAiQ2FwdHVyZSI7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXRGaWJlcjsKICAgICAgICAgIHdoaWxlIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgX2luc3RhbmNlMyA9IGluc3RhbmNlLCBzdGF0ZU5vZGUgPSBfaW5zdGFuY2UzLnN0YXRlTm9kZSwgdGFnID0gX2luc3RhbmNlMy50YWc7CiAgICAgICAgICAgIGlmICh0YWcgPT09IEhvc3RDb21wb25lbnQgJiYgc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRUYXJnZXQgPSBzdGF0ZU5vZGU7CiAgICAgICAgICAgICAgdmFyIGNhcHR1cmVMaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3RhbmNlLCBjYXB0dXJlTmFtZSk7CiAgICAgICAgICAgICAgaWYgKGNhcHR1cmVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMudW5zaGlmdChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBjYXB0dXJlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGJ1YmJsZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlYWN0TmFtZSk7CiAgICAgICAgICAgICAgaWYgKGJ1YmJsZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGJ1YmJsZUxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2UucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UGFyZW50KGluc3QpIHsKICAgICAgICAgIGlmIChpbnN0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZG8gewogICAgICAgICAgICBpbnN0ID0gaW5zdC5yZXR1cm47CiAgICAgICAgICB9IHdoaWxlIChpbnN0ICYmIGluc3QudGFnICE9PSBIb3N0Q29tcG9uZW50KTsKICAgICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICAgIHJldHVybiBpbnN0OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExvd2VzdENvbW1vbkFuY2VzdG9yKGluc3RBLCBpbnN0QikgewogICAgICAgICAgdmFyIG5vZGVBID0gaW5zdEE7CiAgICAgICAgICB2YXIgbm9kZUIgPSBpbnN0QjsKICAgICAgICAgIHZhciBkZXB0aEEgPSAwOwogICAgICAgICAgZm9yICh2YXIgdGVtcEEgPSBub2RlQTsgdGVtcEE7IHRlbXBBID0gZ2V0UGFyZW50KHRlbXBBKSkgewogICAgICAgICAgICBkZXB0aEErKzsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkZXB0aEIgPSAwOwogICAgICAgICAgZm9yICh2YXIgdGVtcEIgPSBub2RlQjsgdGVtcEI7IHRlbXBCID0gZ2V0UGFyZW50KHRlbXBCKSkgewogICAgICAgICAgICBkZXB0aEIrKzsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChkZXB0aEEgLSBkZXB0aEIgPiAwKSB7CiAgICAgICAgICAgIG5vZGVBID0gZ2V0UGFyZW50KG5vZGVBKTsKICAgICAgICAgICAgZGVwdGhBLS07CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoZGVwdGhCIC0gZGVwdGhBID4gMCkgewogICAgICAgICAgICBub2RlQiA9IGdldFBhcmVudChub2RlQik7CiAgICAgICAgICAgIGRlcHRoQi0tOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRlcHRoID0gZGVwdGhBOwogICAgICAgICAgd2hpbGUgKGRlcHRoLS0pIHsKICAgICAgICAgICAgaWYgKG5vZGVBID09PSBub2RlQiB8fCBub2RlQiAhPT0gbnVsbCAmJiBub2RlQSA9PT0gbm9kZUIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGVBOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGVBID0gZ2V0UGFyZW50KG5vZGVBKTsKICAgICAgICAgICAgbm9kZUIgPSBnZXRQYXJlbnQobm9kZUIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVFbnRlckxlYXZlTGlzdGVuZXJzRm9yRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZXZlbnQsIHRhcmdldCwgY29tbW9uLCBpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWUgPSBldmVudC5fcmVhY3ROYW1lOwogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IFtdOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gdGFyZ2V0OwogICAgICAgICAgd2hpbGUgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZSA9PT0gY29tbW9uKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTQgPSBpbnN0YW5jZSwgYWx0ZXJuYXRlID0gX2luc3RhbmNlNC5hbHRlcm5hdGUsIHN0YXRlTm9kZSA9IF9pbnN0YW5jZTQuc3RhdGVOb2RlLCB0YWcgPSBfaW5zdGFuY2U0LnRhZzsKICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCAmJiBhbHRlcm5hdGUgPT09IGNvbW1vbikgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09IEhvc3RDb21wb25lbnQgJiYgc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRUYXJnZXQgPSBzdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FwdHVyZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICAgICAgaWYgKGNhcHR1cmVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy51bnNoaWZ0KGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGNhcHR1cmVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICAgICAgICB2YXIgYnViYmxlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoYnViYmxlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBidWJibGVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlRW50ZXJMZWF2ZVR3b1BoYXNlTGlzdGVuZXJzKGRpc3BhdGNoUXVldWUsIGxlYXZlRXZlbnQsIGVudGVyRXZlbnQsIGZyb20yLCB0bzIpIHsKICAgICAgICAgIHZhciBjb21tb24gPSBmcm9tMiAmJiB0bzIgPyBnZXRMb3dlc3RDb21tb25BbmNlc3Rvcihmcm9tMiwgdG8yKSA6IG51bGw7CiAgICAgICAgICBpZiAoZnJvbTIgIT09IG51bGwpIHsKICAgICAgICAgICAgYWNjdW11bGF0ZUVudGVyTGVhdmVMaXN0ZW5lcnNGb3JFdmVudChkaXNwYXRjaFF1ZXVlLCBsZWF2ZUV2ZW50LCBmcm9tMiwgY29tbW9uLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodG8yICE9PSBudWxsICYmIGVudGVyRXZlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgYWNjdW11bGF0ZUVudGVyTGVhdmVMaXN0ZW5lcnNGb3JFdmVudChkaXNwYXRjaFF1ZXVlLCBlbnRlckV2ZW50LCB0bzIsIGNvbW1vbiwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExpc3RlbmVyU2V0S2V5KGRvbUV2ZW50TmFtZSwgY2FwdHVyZSkgewogICAgICAgICAgcmV0dXJuIGRvbUV2ZW50TmFtZSArICJfXyIgKyAoY2FwdHVyZSA/ICJjYXB0dXJlIiA6ICJidWJibGUiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gZmFsc2U7CiAgICAgICAgdmFyIERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MID0gImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIjsKICAgICAgICB2YXIgU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HID0gInN1cHByZXNzQ29udGVudEVkaXRhYmxlV2FybmluZyI7CiAgICAgICAgdmFyIFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HID0gInN1cHByZXNzSHlkcmF0aW9uV2FybmluZyI7CiAgICAgICAgdmFyIEFVVE9GT0NVUyA9ICJhdXRvRm9jdXMiOwogICAgICAgIHZhciBDSElMRFJFTiA9ICJjaGlsZHJlbiI7CiAgICAgICAgdmFyIFNUWUxFID0gInN0eWxlIjsKICAgICAgICB2YXIgSFRNTCQxID0gIl9faHRtbCI7CiAgICAgICAgdmFyIHdhcm5lZFVua25vd25UYWdzOwogICAgICAgIHZhciB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50OwogICAgICAgIHZhciB3YXJuRm9yUHJvcERpZmZlcmVuY2U7CiAgICAgICAgdmFyIHdhcm5Gb3JFeHRyYUF0dHJpYnV0ZXM7CiAgICAgICAgdmFyIHdhcm5Gb3JJbnZhbGlkRXZlbnRMaXN0ZW5lcjsKICAgICAgICB2YXIgY2FuRGlmZlN0eWxlRm9ySHlkcmF0aW9uV2FybmluZzsKICAgICAgICB2YXIgbm9ybWFsaXplSFRNTDsKICAgICAgICB7CiAgICAgICAgICB3YXJuZWRVbmtub3duVGFncyA9IHsKICAgICAgICAgICAgLy8gVGhlcmUgYXJlIHdvcmtpbmcgcG9seWZpbGxzIGZvciA8ZGlhbG9nPi4gTGV0IHBlb3BsZSB1c2UgaXQuCiAgICAgICAgICAgIGRpYWxvZzogdHJ1ZSwKICAgICAgICAgICAgLy8gRWxlY3Ryb24gc2hpcHMgYSBjdXN0b20gPHdlYnZpZXc+IHRhZyB0byBkaXNwbGF5IGV4dGVybmFsIHdlYiBjb250ZW50IGluCiAgICAgICAgICAgIC8vIGFuIGlzb2xhdGVkIGZyYW1lIGFuZCBwcm9jZXNzLgogICAgICAgICAgICAvLyBUaGlzIHRhZyBpcyBub3QgcHJlc2VudCBpbiBub24gRWxlY3Ryb24gZW52aXJvbm1lbnRzIHN1Y2ggYXMgSlNEb20gd2hpY2gKICAgICAgICAgICAgLy8gaXMgb2Z0ZW4gdXNlZCBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KICAgICAgICAgICAgLy8gQHNlZSBodHRwczovL2VsZWN0cm9uanMub3JnL2RvY3MvYXBpL3dlYnZpZXctdGFnCiAgICAgICAgICAgIHdlYnZpZXc6IHRydWUKICAgICAgICAgIH07CiAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50ID0gZnVuY3Rpb24odHlwZSwgcHJvcHMpIHsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzKHR5cGUsIHByb3BzKTsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzJDEodHlwZSwgcHJvcHMpOwogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXMkMih0eXBlLCBwcm9wcywgewogICAgICAgICAgICAgIHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMsCiAgICAgICAgICAgICAgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lcwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICBjYW5EaWZmU3R5bGVGb3JIeWRyYXRpb25XYXJuaW5nID0gY2FuVXNlRE9NMiAmJiAhZG9jdW1lbnQuZG9jdW1lbnRNb2RlOwogICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlID0gZnVuY3Rpb24ocHJvcE5hbWUsIHNlcnZlclZhbHVlLCBjbGllbnRWYWx1ZSkgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWRDbGllbnRWYWx1ZSA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShjbGllbnRWYWx1ZSk7CiAgICAgICAgICAgIHZhciBub3JtYWxpemVkU2VydmVyVmFsdWUgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoc2VydmVyVmFsdWUpOwogICAgICAgICAgICBpZiAobm9ybWFsaXplZFNlcnZlclZhbHVlID09PSBub3JtYWxpemVkQ2xpZW50VmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiUHJvcCBgJXNgIGRpZCBub3QgbWF0Y2guIFNlcnZlcjogJXMgQ2xpZW50OiAlcyIsIHByb3BOYW1lLCBKU09OLnN0cmluZ2lmeShub3JtYWxpemVkU2VydmVyVmFsdWUpLCBKU09OLnN0cmluZ2lmeShub3JtYWxpemVkQ2xpZW50VmFsdWUpKTsKICAgICAgICAgIH07CiAgICAgICAgICB3YXJuRm9yRXh0cmFBdHRyaWJ1dGVzID0gZnVuY3Rpb24oYXR0cmlidXRlTmFtZXMpIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIG5hbWVzID0gW107CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWVzLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgIG5hbWVzLnB1c2gobmFtZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBlcnJvcigiRXh0cmEgYXR0cmlidXRlcyBmcm9tIHRoZSBzZXJ2ZXI6ICVzIiwgbmFtZXMpOwogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5Gb3JJbnZhbGlkRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKHJlZ2lzdHJhdGlvbk5hbWUsIGxpc3RlbmVyMikgewogICAgICAgICAgICBpZiAobGlzdGVuZXIyID09PSBmYWxzZSkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBgJXNgIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24sIGluc3RlYWQgZ290IGBmYWxzZWAuXG5cbklmIHlvdSB1c2VkIHRvIGNvbmRpdGlvbmFsbHkgb21pdCBpdCB3aXRoICVzPXtjb25kaXRpb24gJiYgdmFsdWV9LCBwYXNzICVzPXtjb25kaXRpb24gPyB2YWx1ZSA6IHVuZGVmaW5lZH0gaW5zdGVhZC4iLCByZWdpc3RyYXRpb25OYW1lLCByZWdpc3RyYXRpb25OYW1lLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgYCVzYCBsaXN0ZW5lciB0byBiZSBhIGZ1bmN0aW9uLCBpbnN0ZWFkIGdvdCBhIHZhbHVlIG9mIGAlc2AgdHlwZS4iLCByZWdpc3RyYXRpb25OYW1lLCB0eXBlb2YgbGlzdGVuZXIyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG5vcm1hbGl6ZUhUTUwgPSBmdW5jdGlvbihwYXJlbnQsIGh0bWwpIHsKICAgICAgICAgICAgdmFyIHRlc3RFbGVtZW50ID0gcGFyZW50Lm5hbWVzcGFjZVVSSSA9PT0gSFRNTF9OQU1FU1BBQ0UgPyBwYXJlbnQub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KHBhcmVudC50YWdOYW1lKSA6IHBhcmVudC5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhwYXJlbnQubmFtZXNwYWNlVVJJLCBwYXJlbnQudGFnTmFtZSk7CiAgICAgICAgICAgIHRlc3RFbGVtZW50LmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgICAgIHJldHVybiB0ZXN0RWxlbWVudC5pbm5lckhUTUw7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgTk9STUFMSVpFX05FV0xJTkVTX1JFR0VYID0gL1xyXG4/L2c7CiAgICAgICAgdmFyIE5PUk1BTElaRV9OVUxMX0FORF9SRVBMQUNFTUVOVF9SRUdFWCA9IC9cdTAwMDB8XHVGRkZEL2c7CiAgICAgICAgZnVuY3Rpb24gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKG1hcmt1cCkgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0h0bWxTdHJpbmdDb2VyY2lvbihtYXJrdXApOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1hcmt1cFN0cmluZyA9IHR5cGVvZiBtYXJrdXAgPT09ICJzdHJpbmciID8gbWFya3VwIDogIiIgKyBtYXJrdXA7CiAgICAgICAgICByZXR1cm4gbWFya3VwU3RyaW5nLnJlcGxhY2UoTk9STUFMSVpFX05FV0xJTkVTX1JFR0VYLCAiXG4iKS5yZXBsYWNlKE5PUk1BTElaRV9OVUxMX0FORF9SRVBMQUNFTUVOVF9SRUdFWCwgIiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0ZvclVubWF0Y2hlZFRleHQoc2VydmVyVGV4dCwgY2xpZW50VGV4dCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldikgewogICAgICAgICAgdmFyIG5vcm1hbGl6ZWRDbGllbnRUZXh0ID0gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKGNsaWVudFRleHQpOwogICAgICAgICAgdmFyIG5vcm1hbGl6ZWRTZXJ2ZXJUZXh0ID0gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKHNlcnZlclRleHQpOwogICAgICAgICAgaWYgKG5vcm1hbGl6ZWRTZXJ2ZXJUZXh0ID09PSBub3JtYWxpemVkQ2xpZW50VGV4dCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2hvdWxkV2FybkRldikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoJ1RleHQgY29udGVudCBkaWQgbm90IG1hdGNoLiBTZXJ2ZXI6ICIlcyIgQ2xpZW50OiAiJXMiJywgbm9ybWFsaXplZFNlcnZlclRleHQsIG5vcm1hbGl6ZWRDbGllbnRUZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0NvbmN1cnJlbnRNb2RlICYmIGVuYWJsZUNsaWVudFJlbmRlckZhbGxiYWNrT25UZXh0TWlzbWF0Y2gpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUZXh0IGNvbnRlbnQgZG9lcyBub3QgbWF0Y2ggc2VydmVyLXJlbmRlcmVkIEhUTUwuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE93bmVyRG9jdW1lbnRGcm9tUm9vdENvbnRhaW5lcihyb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgcmV0dXJuIHJvb3RDb250YWluZXJFbGVtZW50Lm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFID8gcm9vdENvbnRhaW5lckVsZW1lbnQgOiByb290Q29udGFpbmVyRWxlbWVudC5vd25lckRvY3VtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBub29wNigpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQobm9kZSkgewogICAgICAgICAgbm9kZS5vbmNsaWNrID0gbm9vcDY7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEluaXRpYWxET01Qcm9wZXJ0aWVzKHRhZywgZG9tRWxlbWVudCwgcm9vdENvbnRhaW5lckVsZW1lbnQsIG5leHRQcm9wcywgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIGZvciAodmFyIHByb3BLZXkgaW4gbmV4dFByb3BzKSB7CiAgICAgICAgICAgIGlmICghbmV4dFByb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRQcm9wID0gbmV4dFByb3BzW3Byb3BLZXldOwogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAobmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNldFZhbHVlRm9yU3R5bGVzKGRvbUVsZW1lbnQsIG5leHRQcm9wKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCkgewogICAgICAgICAgICAgIHZhciBuZXh0SHRtbCA9IG5leHRQcm9wID8gbmV4dFByb3BbSFRNTCQxXSA6IHZvaWQgMDsKICAgICAgICAgICAgICBpZiAobmV4dEh0bWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2V0SW5uZXJIVE1MKGRvbUVsZW1lbnQsIG5leHRIdG1sKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gQ0hJTERSRU4pIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdmFyIGNhblNldFRleHRDb250ZW50ID0gdGFnICE9PSAidGV4dGFyZWEiIHx8IG5leHRQcm9wICE9PSAiIjsKICAgICAgICAgICAgICAgIGlmIChjYW5TZXRUZXh0Q29udGVudCkgewogICAgICAgICAgICAgICAgICBzZXRUZXh0Q29udGVudChkb21FbGVtZW50LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICBzZXRUZXh0Q29udGVudChkb21FbGVtZW50LCAiIiArIG5leHRQcm9wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IEFVVE9GT0NVUykgOwogICAgICAgICAgICBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSAib25TY3JvbGwiKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInNjcm9sbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0UHJvcCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JQcm9wZXJ0eShkb21FbGVtZW50LCBwcm9wS2V5LCBuZXh0UHJvcCwgaXNDdXN0b21Db21wb25lbnRUYWcpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURPTVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgd2FzQ3VzdG9tQ29tcG9uZW50VGFnLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1cGRhdGVQYXlsb2FkLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICAgIHZhciBwcm9wS2V5ID0gdXBkYXRlUGF5bG9hZFtpXTsKICAgICAgICAgICAgdmFyIHByb3BWYWx1ZSA9IHVwZGF0ZVBheWxvYWRbaSArIDFdOwogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICBzZXRWYWx1ZUZvclN0eWxlcyhkb21FbGVtZW50LCBwcm9wVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgc2V0SW5uZXJIVE1MKGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gQ0hJTERSRU4pIHsKICAgICAgICAgICAgICBzZXRUZXh0Q29udGVudChkb21FbGVtZW50LCBwcm9wVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNldFZhbHVlRm9yUHJvcGVydHkoZG9tRWxlbWVudCwgcHJvcEtleSwgcHJvcFZhbHVlLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRWxlbWVudDM5KHR5cGUsIHByb3BzLCByb290Q29udGFpbmVyRWxlbWVudCwgcGFyZW50TmFtZXNwYWNlKSB7CiAgICAgICAgICB2YXIgaXNDdXN0b21Db21wb25lbnRUYWc7CiAgICAgICAgICB2YXIgb3duZXJEb2N1bWVudCA9IGdldE93bmVyRG9jdW1lbnRGcm9tUm9vdENvbnRhaW5lcihyb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICB2YXIgZG9tRWxlbWVudDsKICAgICAgICAgIHZhciBuYW1lc3BhY2VVUkkgPSBwYXJlbnROYW1lc3BhY2U7CiAgICAgICAgICBpZiAobmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICBuYW1lc3BhY2VVUkkgPSBnZXRJbnRyaW5zaWNOYW1lc3BhY2UodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0eXBlLCBwcm9wcyk7CiAgICAgICAgICAgICAgaWYgKCFpc0N1c3RvbUNvbXBvbmVudFRhZyAmJiB0eXBlICE9PSB0eXBlLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCI8JXMgLz4gaXMgdXNpbmcgaW5jb3JyZWN0IGNhc2luZy4gVXNlIFBhc2NhbENhc2UgZm9yIFJlYWN0IGNvbXBvbmVudHMsIG9yIGxvd2VyY2FzZSBmb3IgSFRNTCBlbGVtZW50cy4iLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJzY3JpcHQiKSB7CiAgICAgICAgICAgICAgdmFyIGRpdiA9IG93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICI8c2NyaXB0PjxcL3NjcmlwdD4iOwogICAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZGl2LmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgZG9tRWxlbWVudCA9IGRpdi5yZW1vdmVDaGlsZChmaXJzdENoaWxkKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvcHMuaXMgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZG9tRWxlbWVudCA9IG93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0eXBlLCB7CiAgICAgICAgICAgICAgICBpczogcHJvcHMuaXMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkb21FbGVtZW50ID0gb3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KHR5cGUpOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSAic2VsZWN0IikgewogICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBkb21FbGVtZW50OwogICAgICAgICAgICAgICAgaWYgKHByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUubXVsdGlwbGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5zaXplKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUuc2l6ZSA9IHByb3BzLnNpemU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkb21FbGVtZW50ID0gb3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50TlMobmFtZXNwYWNlVVJJLCB0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5hbWVzcGFjZVVSSSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tQ29tcG9uZW50VGFnICYmIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChkb21FbGVtZW50KSA9PT0gIltvYmplY3QgSFRNTFVua25vd25FbGVtZW50XSIgJiYgIWhhc093blByb3BlcnR5LmNhbGwod2FybmVkVW5rbm93blRhZ3MsIHR5cGUpKSB7CiAgICAgICAgICAgICAgICB3YXJuZWRVbmtub3duVGFnc1t0eXBlXSA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIHRhZyA8JXM+IGlzIHVucmVjb2duaXplZCBpbiB0aGlzIGJyb3dzZXIuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBSZWFjdCBjb21wb25lbnQsIHN0YXJ0IGl0cyBuYW1lIHdpdGggYW4gdXBwZXJjYXNlIGxldHRlci4iLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkb21FbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVUZXh0Tm9kZSh0ZXh0LCByb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgcmV0dXJuIGdldE93bmVyRG9jdW1lbnRGcm9tUm9vdENvbnRhaW5lcihyb290Q29udGFpbmVyRWxlbWVudCkuY3JlYXRlVGV4dE5vZGUodGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEluaXRpYWxQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHRhZywgcmF3UHJvcHMsIHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICB2YXIgaXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzSW5EZXZlbG9wbWVudCh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wczsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImRpYWxvZyI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiY2FuY2VsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiY2xvc2UiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpZnJhbWUiOgogICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICBjYXNlICJlbWJlZCI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgibG9hZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInZpZGVvIjoKICAgICAgICAgICAgY2FzZSAiYXVkaW8iOgogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWVkaWFFdmVudFR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KG1lZGlhRXZlbnRUeXBlc1tpXSwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNvdXJjZSI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpbWciOgogICAgICAgICAgICBjYXNlICJpbWFnZSI6CiAgICAgICAgICAgIGNhc2UgImxpbmsiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImVycm9yIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgibG9hZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRldGFpbHMiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInRvZ2dsZSIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBwcm9wcyA9IGdldEhvc3RQcm9wcyhkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgIHZhbGlkYXRlUHJvcHMoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQxKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBwcm9wcyA9IGdldEhvc3RQcm9wcyQxKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlJDIoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIHByb3BzID0gZ2V0SG9zdFByb3BzJDIoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgfQogICAgICAgICAgYXNzZXJ0VmFsaWRQcm9wcyh0YWcsIHByb3BzKTsKICAgICAgICAgIHNldEluaXRpYWxET01Qcm9wZXJ0aWVzKHRhZywgZG9tRWxlbWVudCwgcm9vdENvbnRhaW5lckVsZW1lbnQsIHByb3BzLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgdHJhY2soZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlcihkb21FbGVtZW50LCByYXdQcm9wcywgZmFsc2UpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgdHJhY2soZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQzKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLm9uQ2xpY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRyYXBDbGlja09uTm9uSW50ZXJhY3RpdmVFbGVtZW50KGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlmZlByb3BlcnRpZXMoZG9tRWxlbWVudCwgdGFnLCBsYXN0UmF3UHJvcHMsIG5leHRSYXdQcm9wcywgcm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzSW5EZXZlbG9wbWVudCh0YWcsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IG51bGw7CiAgICAgICAgICB2YXIgbGFzdFByb3BzOwogICAgICAgICAgdmFyIG5leHRQcm9wczsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBnZXRIb3N0UHJvcHMoZG9tRWxlbWVudCwgbGFzdFJhd1Byb3BzKTsKICAgICAgICAgICAgICBuZXh0UHJvcHMgPSBnZXRIb3N0UHJvcHMoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgbGFzdFByb3BzID0gZ2V0SG9zdFByb3BzJDEoZG9tRWxlbWVudCwgbGFzdFJhd1Byb3BzKTsKICAgICAgICAgICAgICBuZXh0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMShkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGdldEhvc3RQcm9wcyQyKGRvbUVsZW1lbnQsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICAgICAgbmV4dFByb3BzID0gZ2V0SG9zdFByb3BzJDIoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgbGFzdFByb3BzID0gbGFzdFJhd1Byb3BzOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IG5leHRSYXdQcm9wczsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGxhc3RQcm9wcy5vbkNsaWNrICE9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBuZXh0UHJvcHMub25DbGljayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgYXNzZXJ0VmFsaWRQcm9wcyh0YWcsIG5leHRQcm9wcyk7CiAgICAgICAgICB2YXIgcHJvcEtleTsKICAgICAgICAgIHZhciBzdHlsZU5hbWU7CiAgICAgICAgICB2YXIgc3R5bGVVcGRhdGVzID0gbnVsbDsKICAgICAgICAgIGZvciAocHJvcEtleSBpbiBsYXN0UHJvcHMpIHsKICAgICAgICAgICAgaWYgKG5leHRQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSB8fCAhbGFzdFByb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpIHx8IGxhc3RQcm9wc1twcm9wS2V5XSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgdmFyIGxhc3RTdHlsZSA9IGxhc3RQcm9wc1twcm9wS2V5XTsKICAgICAgICAgICAgICBmb3IgKHN0eWxlTmFtZSBpbiBsYXN0U3R5bGUpIHsKICAgICAgICAgICAgICAgIGlmIChsYXN0U3R5bGUuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgICAgICBpZiAoIXN0eWxlVXBkYXRlcykgewogICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IHt9OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlc1tzdHlsZU5hbWVdID0gIiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MIHx8IHByb3BLZXkgPT09IENISUxEUkVOKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IFNVUFBSRVNTX0NPTlRFTlRfRURJVEFCTEVfV0FSTklORyB8fCBwcm9wS2V5ID09PSBTVVBQUkVTU19IWURSQVRJT05fV0FSTklORykgOwogICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBBVVRPRk9DVVMpIDsKICAgICAgICAgICAgZWxzZSBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgIGlmICghdXBkYXRlUGF5bG9hZCkgewogICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgbnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAocHJvcEtleSBpbiBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgdmFyIG5leHRQcm9wID0gbmV4dFByb3BzW3Byb3BLZXldOwogICAgICAgICAgICB2YXIgbGFzdFByb3AgPSBsYXN0UHJvcHMgIT0gbnVsbCA/IGxhc3RQcm9wc1twcm9wS2V5XSA6IHZvaWQgMDsKICAgICAgICAgICAgaWYgKCFuZXh0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkgfHwgbmV4dFByb3AgPT09IGxhc3RQcm9wIHx8IG5leHRQcm9wID09IG51bGwgJiYgbGFzdFByb3AgPT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGxhc3RQcm9wKSB7CiAgICAgICAgICAgICAgICBmb3IgKHN0eWxlTmFtZSBpbiBsYXN0UHJvcCkgewogICAgICAgICAgICAgICAgICBpZiAobGFzdFByb3AuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSAmJiAoIW5leHRQcm9wIHx8ICFuZXh0UHJvcC5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpKSkgewogICAgICAgICAgICAgICAgICAgIGlmICghc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzW3N0eWxlTmFtZV0gPSAiIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yIChzdHlsZU5hbWUgaW4gbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgaWYgKG5leHRQcm9wLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkgJiYgbGFzdFByb3Bbc3R5bGVOYW1lXSAhPT0gbmV4dFByb3Bbc3R5bGVOYW1lXSkgewogICAgICAgICAgICAgICAgICAgIGlmICghc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzW3N0eWxlTmFtZV0gPSBuZXh0UHJvcFtzdHlsZU5hbWVdOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICAgIGlmICghdXBkYXRlUGF5bG9hZCkgewogICAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkLnB1c2gocHJvcEtleSwgc3R5bGVVcGRhdGVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IG5leHRQcm9wOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCkgewogICAgICAgICAgICAgIHZhciBuZXh0SHRtbCA9IG5leHRQcm9wID8gbmV4dFByb3BbSFRNTCQxXSA6IHZvaWQgMDsKICAgICAgICAgICAgICB2YXIgbGFzdEh0bWwgPSBsYXN0UHJvcCA/IGxhc3RQcm9wW0hUTUwkMV0gOiB2b2lkIDA7CiAgICAgICAgICAgICAgaWYgKG5leHRIdG1sICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChsYXN0SHRtbCAhPT0gbmV4dEh0bWwpIHsKICAgICAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKHByb3BLZXksIG5leHRIdG1sKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gQ0hJTERSRU4pIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wID09PSAic3RyaW5nIiB8fCB0eXBlb2YgbmV4dFByb3AgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgIiIgKyBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IFNVUFBSRVNTX0NPTlRFTlRfRURJVEFCTEVfV0FSTklORyB8fCBwcm9wS2V5ID09PSBTVVBQUkVTU19IWURSQVRJT05fV0FSTklORykgOwogICAgICAgICAgICBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSAib25TY3JvbGwiKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInNjcm9sbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIXVwZGF0ZVBheWxvYWQgJiYgbGFzdFByb3AgIT09IG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhbGlkYXRlU2hvcnRoYW5kUHJvcGVydHlDb2xsaXNpb25JbkRldihzdHlsZVVwZGF0ZXMsIG5leHRQcm9wc1tTVFlMRV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChTVFlMRSwgc3R5bGVVcGRhdGVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cGRhdGVQYXlsb2FkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHRhZywgbGFzdFJhd1Byb3BzLCBuZXh0UmF3UHJvcHMpIHsKICAgICAgICAgIGlmICh0YWcgPT09ICJpbnB1dCIgJiYgbmV4dFJhd1Byb3BzLnR5cGUgPT09ICJyYWRpbyIgJiYgbmV4dFJhd1Byb3BzLm5hbWUgIT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGVDaGVja2VkKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2FzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgdXBkYXRlRE9NUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB3YXNDdXN0b21Db21wb25lbnRUYWcsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICB1cGRhdGVXcmFwcGVyKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICB1cGRhdGVXcmFwcGVyJDEoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBwb3N0VXBkYXRlV3JhcHBlcihkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQb3NzaWJsZVN0YW5kYXJkTmFtZShwcm9wTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgbG93ZXJDYXNlZE5hbWUgPSBwcm9wTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBpZiAoIXBvc3NpYmxlU3RhbmRhcmROYW1lcy5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcG9zc2libGVTdGFuZGFyZE5hbWVzW2xvd2VyQ2FzZWROYW1lXSB8fCBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWZmSHlkcmF0ZWRQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHRhZywgcmF3UHJvcHMsIHBhcmVudE5hbWVzcGFjZSwgcm9vdENvbnRhaW5lckVsZW1lbnQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZzsKICAgICAgICAgIHZhciBleHRyYUF0dHJpYnV0ZU5hbWVzOwogICAgICAgICAgewogICAgICAgICAgICBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50KHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiZGlhbG9nIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjYW5jZWwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjbG9zZSIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpZnJhbWUiOgogICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICBjYXNlICJlbWJlZCI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgibG9hZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ2aWRlbyI6CiAgICAgICAgICAgIGNhc2UgImF1ZGlvIjoKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1lZGlhRXZlbnRUeXBlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudChtZWRpYUV2ZW50VHlwZXNbaV0sIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic291cmNlIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpbWciOgogICAgICAgICAgICBjYXNlICJpbWFnZSI6CiAgICAgICAgICAgIGNhc2UgImxpbmsiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImVycm9yIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgibG9hZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJkZXRhaWxzIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJ0b2dnbGUiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BzKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgYXNzZXJ0VmFsaWRQcm9wcyh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgIHsKICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVzID0gZG9tRWxlbWVudC5hdHRyaWJ1dGVzOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXR0cmlidXRlcy5sZW5ndGg7IF9pKyspIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZXNbX2ldLm5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICBzd2l0Y2ggKG5hbWUpIHsKICAgICAgICAgICAgICAgIGNhc2UgInZhbHVlIjoKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJjaGVja2VkIjoKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJzZWxlY3RlZCI6CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5hZGQoYXR0cmlidXRlc1tfaV0ubmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IG51bGw7CiAgICAgICAgICBmb3IgKHZhciBwcm9wS2V5IGluIHJhd1Byb3BzKSB7CiAgICAgICAgICAgIGlmICghcmF3UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV4dFByb3AgPSByYXdQcm9wc1twcm9wS2V5XTsKICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09IENISUxEUkVOKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGlmIChkb21FbGVtZW50LnRleHRDb250ZW50ICE9PSBuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBpZiAocmF3UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkddICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tGb3JVbm1hdGNoZWRUZXh0KGRvbUVsZW1lbnQudGV4dENvbnRlbnQsIG5leHRQcm9wLCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW0NISUxEUkVOLCBuZXh0UHJvcF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICBpZiAoZG9tRWxlbWVudC50ZXh0Q29udGVudCAhPT0gIiIgKyBuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBpZiAocmF3UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkddICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tGb3JVbm1hdGNoZWRUZXh0KGRvbUVsZW1lbnQudGV4dENvbnRlbnQsIG5leHRQcm9wLCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW0NISUxEUkVOLCAiIiArIG5leHRQcm9wXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgIGlmIChuZXh0UHJvcCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JJbnZhbGlkRXZlbnRMaXN0ZW5lcihwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gIm9uU2Nyb2xsIikgewogICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJzY3JvbGwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2hvdWxkV2FybkRldiAmJiB0cnVlICYmIC8vIENvbnZpbmNlIEZsb3cgd2UndmUgY2FsY3VsYXRlZCBpdCAoaXQncyBERVYtb25seSBpbiB0aGlzIG1ldGhvZC4pCiAgICAgICAgICAgIHR5cGVvZiBpc0N1c3RvbUNvbXBvbmVudFRhZyA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgICAgdmFyIHNlcnZlclZhbHVlID0gdm9pZCAwOwogICAgICAgICAgICAgIHZhciBwcm9wZXJ0eUluZm8gPSBpc0N1c3RvbUNvbXBvbmVudFRhZyAmJiBlbmFibGVDdXN0b21FbGVtZW50UHJvcGVydHlTdXBwb3J0ID8gbnVsbCA6IGdldFByb3BlcnR5SW5mbyhwcm9wS2V5KTsKICAgICAgICAgICAgICBpZiAocmF3UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkddID09PSB0cnVlKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HIHx8IC8vIENvbnRyb2xsZWQgYXR0cmlidXRlcyBhcmUgbm90IHZhbGlkYXRlZAogICAgICAgICAgICAgIC8vIFRPRE86IE9ubHkgaWdub3JlIHRoZW0gb24gY29udHJvbGxlZCB0YWdzLgogICAgICAgICAgICAgIHByb3BLZXkgPT09ICJ2YWx1ZSIgfHwgcHJvcEtleSA9PT0gImNoZWNrZWQiIHx8IHByb3BLZXkgPT09ICJzZWxlY3RlZCIpIDsKICAgICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCkgewogICAgICAgICAgICAgICAgdmFyIHNlcnZlckhUTUwgPSBkb21FbGVtZW50LmlubmVySFRNTDsKICAgICAgICAgICAgICAgIHZhciBuZXh0SHRtbCA9IG5leHRQcm9wID8gbmV4dFByb3BbSFRNTCQxXSA6IHZvaWQgMDsKICAgICAgICAgICAgICAgIGlmIChuZXh0SHRtbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBleHBlY3RlZEhUTUwgPSBub3JtYWxpemVIVE1MKGRvbUVsZW1lbnQsIG5leHRIdG1sKTsKICAgICAgICAgICAgICAgICAgaWYgKGV4cGVjdGVkSFRNTCAhPT0gc2VydmVySFRNTCkgewogICAgICAgICAgICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZShwcm9wS2V5LCBzZXJ2ZXJIVE1MLCBleHBlY3RlZEhUTUwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleSk7CiAgICAgICAgICAgICAgICBpZiAoY2FuRGlmZlN0eWxlRm9ySHlkcmF0aW9uV2FybmluZykgewogICAgICAgICAgICAgICAgICB2YXIgZXhwZWN0ZWRTdHlsZSA9IGNyZWF0ZURhbmdlcm91c1N0cmluZ0ZvclN0eWxlcyhuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICAgIHNlcnZlclZhbHVlID0gZG9tRWxlbWVudC5nZXRBdHRyaWJ1dGUoInN0eWxlIik7CiAgICAgICAgICAgICAgICAgIGlmIChleHBlY3RlZFN0eWxlICE9PSBzZXJ2ZXJWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZShwcm9wS2V5LCBzZXJ2ZXJWYWx1ZSwgZXhwZWN0ZWRTdHlsZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnICYmICFlbmFibGVDdXN0b21FbGVtZW50UHJvcGVydHlTdXBwb3J0KSB7CiAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wS2V5LnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBnZXRWYWx1ZUZvckF0dHJpYnV0ZShkb21FbGVtZW50LCBwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT09IHNlcnZlclZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZShwcm9wS2V5LCBzZXJ2ZXJWYWx1ZSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXNob3VsZElnbm9yZUF0dHJpYnV0ZShwcm9wS2V5LCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSAmJiAhc2hvdWxkUmVtb3ZlQXR0cmlidXRlKHByb3BLZXksIG5leHRQcm9wLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSkgewogICAgICAgICAgICAgICAgdmFyIGlzTWlzbWF0Y2hEdWVUb0JhZENhc2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgICAgIHNlcnZlclZhbHVlID0gZ2V0VmFsdWVGb3JQcm9wZXJ0eShkb21FbGVtZW50LCBwcm9wS2V5LCBuZXh0UHJvcCwgcHJvcGVydHlJbmZvKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBvd25OYW1lc3BhY2UgPSBwYXJlbnROYW1lc3BhY2U7CiAgICAgICAgICAgICAgICAgIGlmIChvd25OYW1lc3BhY2UgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgICAgICAgICAgb3duTmFtZXNwYWNlID0gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHRhZyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKG93bk5hbWVzcGFjZSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wS2V5LnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBzdGFuZGFyZE5hbWUgPSBnZXRQb3NzaWJsZVN0YW5kYXJkTmFtZShwcm9wS2V5KTsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RhbmRhcmROYW1lICE9PSBudWxsICYmIHN0YW5kYXJkTmFtZSAhPT0gcHJvcEtleSkgewogICAgICAgICAgICAgICAgICAgICAgaXNNaXNtYXRjaER1ZVRvQmFkQ2FzaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHN0YW5kYXJkTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNlcnZlclZhbHVlID0gZ2V0VmFsdWVGb3JBdHRyaWJ1dGUoZG9tRWxlbWVudCwgcHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGRvbnRXYXJuQ3VzdG9tRWxlbWVudCA9IGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQ7CiAgICAgICAgICAgICAgICBpZiAoIWRvbnRXYXJuQ3VzdG9tRWxlbWVudCAmJiBuZXh0UHJvcCAhPT0gc2VydmVyVmFsdWUgJiYgIWlzTWlzbWF0Y2hEdWVUb0JhZENhc2luZykgewogICAgICAgICAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UocHJvcEtleSwgc2VydmVyVmFsdWUsIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAvLyAkRmxvd0ZpeE1lIC0gU2hvdWxkIGJlIGluZmVycmVkIGFzIG5vdCB1bmRlZmluZWQuCiAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLnNpemUgPiAwICYmIHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSAhPT0gdHJ1ZQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgd2FybkZvckV4dHJhQXR0cmlidXRlcyhleHRyYUF0dHJpYnV0ZU5hbWVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyKGRvbUVsZW1lbnQsIHJhd1Byb3BzLCB0cnVlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIkMyhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBpZiAodHlwZW9mIHJhd1Byb3BzLm9uQ2xpY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRyYXBDbGlja09uTm9uSW50ZXJhY3RpdmVFbGVtZW50KGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cGRhdGVQYXlsb2FkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWZmSHlkcmF0ZWRUZXh0KHRleHROb2RlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICB2YXIgaXNEaWZmZXJlbnQgPSB0ZXh0Tm9kZS5ub2RlVmFsdWUgIT09IHRleHQ7CiAgICAgICAgICByZXR1cm4gaXNEaWZmZXJlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZUVsZW1lbnQocGFyZW50Tm9kZSwgY2hpbGQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIkRpZCBub3QgZXhwZWN0IHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gYSA8JXM+IGluIDwlcz4uIiwgY2hpbGQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwgcGFyZW50Tm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlVGV4dChwYXJlbnROb2RlLCBjaGlsZCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcignRGlkIG5vdCBleHBlY3Qgc2VydmVyIEhUTUwgdG8gY29udGFpbiB0aGUgdGV4dCBub2RlICIlcyIgaW4gPCVzPi4nLCBjaGlsZC5ub2RlVmFsdWUsIHBhcmVudE5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkRWxlbWVudChwYXJlbnROb2RlLCB0YWcsIHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBzZXJ2ZXIgSFRNTCB0byBjb250YWluIGEgbWF0Y2hpbmcgPCVzPiBpbiA8JXM+LiIsIHRhZywgcGFyZW50Tm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkZvckluc2VydGVkSHlkcmF0ZWRUZXh0KHBhcmVudE5vZGUsIHRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHRleHQgPT09ICIiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCdFeHBlY3RlZCBzZXJ2ZXIgSFRNTCB0byBjb250YWluIGEgbWF0Y2hpbmcgdGV4dCBub2RlIGZvciAiJXMiIGluIDwlcz4uJywgdGV4dCwgcGFyZW50Tm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQzKGRvbUVsZW1lbnQsIHRhZywgcHJvcHMpIHsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICByZXN0b3JlQ29udHJvbGxlZFN0YXRlKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDIoZG9tRWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDEoZG9tRWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHZhbGlkYXRlRE9NTmVzdGluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgdmFyIHVwZGF0ZWRBbmNlc3RvckluZm8gPSBmdW5jdGlvbigpIHsKICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHZhciBzcGVjaWFsVGFncyA9IFsiYWRkcmVzcyIsICJhcHBsZXQiLCAiYXJlYSIsICJhcnRpY2xlIiwgImFzaWRlIiwgImJhc2UiLCAiYmFzZWZvbnQiLCAiYmdzb3VuZCIsICJibG9ja3F1b3RlIiwgImJvZHkiLCAiYnIiLCAiYnV0dG9uIiwgImNhcHRpb24iLCAiY2VudGVyIiwgImNvbCIsICJjb2xncm91cCIsICJkZCIsICJkZXRhaWxzIiwgImRpciIsICJkaXYiLCAiZGwiLCAiZHQiLCAiZW1iZWQiLCAiZmllbGRzZXQiLCAiZmlnY2FwdGlvbiIsICJmaWd1cmUiLCAiZm9vdGVyIiwgImZvcm0iLCAiZnJhbWUiLCAiZnJhbWVzZXQiLCAiaDEiLCAiaDIiLCAiaDMiLCAiaDQiLCAiaDUiLCAiaDYiLCAiaGVhZCIsICJoZWFkZXIiLCAiaGdyb3VwIiwgImhyIiwgImh0bWwiLCAiaWZyYW1lIiwgImltZyIsICJpbnB1dCIsICJpc2luZGV4IiwgImxpIiwgImxpbmsiLCAibGlzdGluZyIsICJtYWluIiwgIm1hcnF1ZWUiLCAibWVudSIsICJtZW51aXRlbSIsICJtZXRhIiwgIm5hdiIsICJub2VtYmVkIiwgIm5vZnJhbWVzIiwgIm5vc2NyaXB0IiwgIm9iamVjdCIsICJvbCIsICJwIiwgInBhcmFtIiwgInBsYWludGV4dCIsICJwcmUiLCAic2NyaXB0IiwgInNlY3Rpb24iLCAic2VsZWN0IiwgInNvdXJjZSIsICJzdHlsZSIsICJzdW1tYXJ5IiwgInRhYmxlIiwgInRib2R5IiwgInRkIiwgInRlbXBsYXRlIiwgInRleHRhcmVhIiwgInRmb290IiwgInRoIiwgInRoZWFkIiwgInRpdGxlIiwgInRyIiwgInRyYWNrIiwgInVsIiwgIndiciIsICJ4bXAiXTsKICAgICAgICAgIHZhciBpblNjb3BlVGFncyA9IFsKICAgICAgICAgICAgImFwcGxldCIsCiAgICAgICAgICAgICJjYXB0aW9uIiwKICAgICAgICAgICAgImh0bWwiLAogICAgICAgICAgICAidGFibGUiLAogICAgICAgICAgICAidGQiLAogICAgICAgICAgICAidGgiLAogICAgICAgICAgICAibWFycXVlZSIsCiAgICAgICAgICAgICJvYmplY3QiLAogICAgICAgICAgICAidGVtcGxhdGUiLAogICAgICAgICAgICAvLyBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9zeW50YXguaHRtbCNodG1sLWludGVncmF0aW9uLXBvaW50CiAgICAgICAgICAgIC8vIFRPRE86IERpc3Rpbmd1aXNoIGJ5IG5hbWVzcGFjZSBoZXJlIC0tIGZvciA8dGl0bGU+LCBpbmNsdWRpbmcgaXQgaGVyZQogICAgICAgICAgICAvLyBlcnJzIG9uIHRoZSBzaWRlIG9mIGZld2VyIHdhcm5pbmdzCiAgICAgICAgICAgICJmb3JlaWduT2JqZWN0IiwKICAgICAgICAgICAgImRlc2MiLAogICAgICAgICAgICAidGl0bGUiCiAgICAgICAgICBdOwogICAgICAgICAgdmFyIGJ1dHRvblNjb3BlVGFncyA9IGluU2NvcGVUYWdzLmNvbmNhdChbImJ1dHRvbiJdKTsKICAgICAgICAgIHZhciBpbXBsaWVkRW5kVGFncyA9IFsiZGQiLCAiZHQiLCAibGkiLCAib3B0aW9uIiwgIm9wdGdyb3VwIiwgInAiLCAicnAiLCAicnQiXTsKICAgICAgICAgIHZhciBlbXB0eUFuY2VzdG9ySW5mbyA9IHsKICAgICAgICAgICAgY3VycmVudDogbnVsbCwKICAgICAgICAgICAgZm9ybVRhZzogbnVsbCwKICAgICAgICAgICAgYVRhZ0luU2NvcGU6IG51bGwsCiAgICAgICAgICAgIGJ1dHRvblRhZ0luU2NvcGU6IG51bGwsCiAgICAgICAgICAgIG5vYnJUYWdJblNjb3BlOiBudWxsLAogICAgICAgICAgICBwVGFnSW5CdXR0b25TY29wZTogbnVsbCwKICAgICAgICAgICAgbGlzdEl0ZW1UYWdBdXRvY2xvc2luZzogbnVsbCwKICAgICAgICAgICAgZGxJdGVtVGFnQXV0b2Nsb3Npbmc6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVkQW5jZXN0b3JJbmZvID0gZnVuY3Rpb24ob2xkSW5mbywgdGFnKSB7CiAgICAgICAgICAgIHZhciBhbmNlc3RvckluZm8gPSBhc3NpZ24yKHt9LCBvbGRJbmZvIHx8IGVtcHR5QW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgdmFyIGluZm8gPSB7CiAgICAgICAgICAgICAgdGFnCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChpblNjb3BlVGFncy5pbmRleE9mKHRhZykgIT09IC0xKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmFUYWdJblNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYnV0dG9uVGFnSW5TY29wZSA9IG51bGw7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLm5vYnJUYWdJblNjb3BlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYnV0dG9uU2NvcGVUYWdzLmluZGV4T2YodGFnKSAhPT0gLTEpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzcGVjaWFsVGFncy5pbmRleE9mKHRhZykgIT09IC0xICYmIHRhZyAhPT0gImFkZHJlc3MiICYmIHRhZyAhPT0gImRpdiIgJiYgdGFnICE9PSAicCIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ubGlzdEl0ZW1UYWdBdXRvY2xvc2luZyA9IG51bGw7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmRsSXRlbVRhZ0F1dG9jbG9zaW5nID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBhbmNlc3RvckluZm8uY3VycmVudCA9IGluZm87CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJmb3JtIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5mb3JtVGFnID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAiYSIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYVRhZ0luU2NvcGUgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJidXR0b24iKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmJ1dHRvblRhZ0luU2NvcGUgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJub2JyIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5ub2JyVGFnSW5TY29wZSA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gInAiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAibGkiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmxpc3RJdGVtVGFnQXV0b2Nsb3NpbmcgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJkZCIgfHwgdGFnID09PSAiZHQiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmRsSXRlbVRhZ0F1dG9jbG9zaW5nID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBpc1RhZ1ZhbGlkV2l0aFBhcmVudCA9IGZ1bmN0aW9uKHRhZywgcGFyZW50VGFnKSB7CiAgICAgICAgICAgIHN3aXRjaCAocGFyZW50VGFnKSB7CiAgICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJvcHRpb24iIHx8IHRhZyA9PT0gIm9wdGdyb3VwIiB8fCB0YWcgPT09ICIjdGV4dCI7CiAgICAgICAgICAgICAgY2FzZSAib3B0Z3JvdXAiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gIm9wdGlvbiIgfHwgdGFnID09PSAiI3RleHQiOwogICAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiI3RleHQiOwogICAgICAgICAgICAgIGNhc2UgInRyIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJ0aCIgfHwgdGFnID09PSAidGQiIHx8IHRhZyA9PT0gInN0eWxlIiB8fCB0YWcgPT09ICJzY3JpcHQiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJ0Ym9keSI6CiAgICAgICAgICAgICAgY2FzZSAidGhlYWQiOgogICAgICAgICAgICAgIGNhc2UgInRmb290IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJ0ciIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgImNvbGdyb3VwIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJjb2wiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJ0YWJsZSI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiY2FwdGlvbiIgfHwgdGFnID09PSAiY29sZ3JvdXAiIHx8IHRhZyA9PT0gInRib2R5IiB8fCB0YWcgPT09ICJ0Zm9vdCIgfHwgdGFnID09PSAidGhlYWQiIHx8IHRhZyA9PT0gInN0eWxlIiB8fCB0YWcgPT09ICJzY3JpcHQiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJoZWFkIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJiYXNlIiB8fCB0YWcgPT09ICJiYXNlZm9udCIgfHwgdGFnID09PSAiYmdzb3VuZCIgfHwgdGFnID09PSAibGluayIgfHwgdGFnID09PSAibWV0YSIgfHwgdGFnID09PSAidGl0bGUiIHx8IHRhZyA9PT0gIm5vc2NyaXB0IiB8fCB0YWcgPT09ICJub2ZyYW1lcyIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgImh0bWwiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImhlYWQiIHx8IHRhZyA9PT0gImJvZHkiIHx8IHRhZyA9PT0gImZyYW1lc2V0IjsKICAgICAgICAgICAgICBjYXNlICJmcmFtZXNldCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiZnJhbWUiOwogICAgICAgICAgICAgIGNhc2UgIiNkb2N1bWVudCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiaHRtbCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlICJoMSI6CiAgICAgICAgICAgICAgY2FzZSAiaDIiOgogICAgICAgICAgICAgIGNhc2UgImgzIjoKICAgICAgICAgICAgICBjYXNlICJoNCI6CiAgICAgICAgICAgICAgY2FzZSAiaDUiOgogICAgICAgICAgICAgIGNhc2UgImg2IjoKICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRUYWcgIT09ICJoMSIgJiYgcGFyZW50VGFnICE9PSAiaDIiICYmIHBhcmVudFRhZyAhPT0gImgzIiAmJiBwYXJlbnRUYWcgIT09ICJoNCIgJiYgcGFyZW50VGFnICE9PSAiaDUiICYmIHBhcmVudFRhZyAhPT0gImg2IjsKICAgICAgICAgICAgICBjYXNlICJycCI6CiAgICAgICAgICAgICAgY2FzZSAicnQiOgogICAgICAgICAgICAgICAgcmV0dXJuIGltcGxpZWRFbmRUYWdzLmluZGV4T2YocGFyZW50VGFnKSA9PT0gLTE7CiAgICAgICAgICAgICAgY2FzZSAiYm9keSI6CiAgICAgICAgICAgICAgY2FzZSAiY2FwdGlvbiI6CiAgICAgICAgICAgICAgY2FzZSAiY29sIjoKICAgICAgICAgICAgICBjYXNlICJjb2xncm91cCI6CiAgICAgICAgICAgICAgY2FzZSAiZnJhbWVzZXQiOgogICAgICAgICAgICAgIGNhc2UgImZyYW1lIjoKICAgICAgICAgICAgICBjYXNlICJoZWFkIjoKICAgICAgICAgICAgICBjYXNlICJodG1sIjoKICAgICAgICAgICAgICBjYXNlICJ0Ym9keSI6CiAgICAgICAgICAgICAgY2FzZSAidGQiOgogICAgICAgICAgICAgIGNhc2UgInRmb290IjoKICAgICAgICAgICAgICBjYXNlICJ0aCI6CiAgICAgICAgICAgICAgY2FzZSAidGhlYWQiOgogICAgICAgICAgICAgIGNhc2UgInRyIjoKICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRUYWcgPT0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZmluZEludmFsaWRBbmNlc3RvckZvclRhZyA9IGZ1bmN0aW9uKHRhZywgYW5jZXN0b3JJbmZvKSB7CiAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgY2FzZSAiYWRkcmVzcyI6CiAgICAgICAgICAgICAgY2FzZSAiYXJ0aWNsZSI6CiAgICAgICAgICAgICAgY2FzZSAiYXNpZGUiOgogICAgICAgICAgICAgIGNhc2UgImJsb2NrcXVvdGUiOgogICAgICAgICAgICAgIGNhc2UgImNlbnRlciI6CiAgICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgY2FzZSAiZGlhbG9nIjoKICAgICAgICAgICAgICBjYXNlICJkaXIiOgogICAgICAgICAgICAgIGNhc2UgImRpdiI6CiAgICAgICAgICAgICAgY2FzZSAiZGwiOgogICAgICAgICAgICAgIGNhc2UgImZpZWxkc2V0IjoKICAgICAgICAgICAgICBjYXNlICJmaWdjYXB0aW9uIjoKICAgICAgICAgICAgICBjYXNlICJmaWd1cmUiOgogICAgICAgICAgICAgIGNhc2UgImZvb3RlciI6CiAgICAgICAgICAgICAgY2FzZSAiaGVhZGVyIjoKICAgICAgICAgICAgICBjYXNlICJoZ3JvdXAiOgogICAgICAgICAgICAgIGNhc2UgIm1haW4iOgogICAgICAgICAgICAgIGNhc2UgIm1lbnUiOgogICAgICAgICAgICAgIGNhc2UgIm5hdiI6CiAgICAgICAgICAgICAgY2FzZSAib2wiOgogICAgICAgICAgICAgIGNhc2UgInAiOgogICAgICAgICAgICAgIGNhc2UgInNlY3Rpb24iOgogICAgICAgICAgICAgIGNhc2UgInN1bW1hcnkiOgogICAgICAgICAgICAgIGNhc2UgInVsIjoKICAgICAgICAgICAgICBjYXNlICJwcmUiOgogICAgICAgICAgICAgIGNhc2UgImxpc3RpbmciOgogICAgICAgICAgICAgIGNhc2UgInRhYmxlIjoKICAgICAgICAgICAgICBjYXNlICJociI6CiAgICAgICAgICAgICAgY2FzZSAieG1wIjoKICAgICAgICAgICAgICBjYXNlICJoMSI6CiAgICAgICAgICAgICAgY2FzZSAiaDIiOgogICAgICAgICAgICAgIGNhc2UgImgzIjoKICAgICAgICAgICAgICBjYXNlICJoNCI6CiAgICAgICAgICAgICAgY2FzZSAiaDUiOgogICAgICAgICAgICAgIGNhc2UgImg2IjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGU7CiAgICAgICAgICAgICAgY2FzZSAiZm9ybSI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmZvcm1UYWcgfHwgYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgImxpIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ubGlzdEl0ZW1UYWdBdXRvY2xvc2luZzsKICAgICAgICAgICAgICBjYXNlICJkZCI6CiAgICAgICAgICAgICAgY2FzZSAiZHQiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5kbEl0ZW1UYWdBdXRvY2xvc2luZzsKICAgICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5idXR0b25UYWdJblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgImEiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5hVGFnSW5TY29wZTsKICAgICAgICAgICAgICBjYXNlICJub2JyIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ubm9iclRhZ0luU2NvcGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGRpZFdhcm4kMSA9IHt9OwogICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nID0gZnVuY3Rpb24oY2hpbGRUYWcsIGNoaWxkVGV4dCwgYW5jZXN0b3JJbmZvKSB7CiAgICAgICAgICAgIGFuY2VzdG9ySW5mbyA9IGFuY2VzdG9ySW5mbyB8fCBlbXB0eUFuY2VzdG9ySW5mbzsKICAgICAgICAgICAgdmFyIHBhcmVudEluZm8gPSBhbmNlc3RvckluZm8uY3VycmVudDsKICAgICAgICAgICAgdmFyIHBhcmVudFRhZyA9IHBhcmVudEluZm8gJiYgcGFyZW50SW5mby50YWc7CiAgICAgICAgICAgIGlmIChjaGlsZFRleHQgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjaGlsZFRhZyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigidmFsaWRhdGVET01OZXN0aW5nOiB3aGVuIGNoaWxkVGV4dCBpcyBwYXNzZWQsIGNoaWxkVGFnIHNob3VsZCBiZSBudWxsIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkVGFnID0gIiN0ZXh0IjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW52YWxpZFBhcmVudCA9IGlzVGFnVmFsaWRXaXRoUGFyZW50KGNoaWxkVGFnLCBwYXJlbnRUYWcpID8gbnVsbCA6IHBhcmVudEluZm87CiAgICAgICAgICAgIHZhciBpbnZhbGlkQW5jZXN0b3IgPSBpbnZhbGlkUGFyZW50ID8gbnVsbCA6IGZpbmRJbnZhbGlkQW5jZXN0b3JGb3JUYWcoY2hpbGRUYWcsIGFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIHZhciBpbnZhbGlkUGFyZW50T3JBbmNlc3RvciA9IGludmFsaWRQYXJlbnQgfHwgaW52YWxpZEFuY2VzdG9yOwogICAgICAgICAgICBpZiAoIWludmFsaWRQYXJlbnRPckFuY2VzdG9yKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhbmNlc3RvclRhZyA9IGludmFsaWRQYXJlbnRPckFuY2VzdG9yLnRhZzsKICAgICAgICAgICAgdmFyIHdhcm5LZXkgPSAhIWludmFsaWRQYXJlbnQgKyAifCIgKyBjaGlsZFRhZyArICJ8IiArIGFuY2VzdG9yVGFnOwogICAgICAgICAgICBpZiAoZGlkV2FybiQxW3dhcm5LZXldKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm4kMVt3YXJuS2V5XSA9IHRydWU7CiAgICAgICAgICAgIHZhciB0YWdEaXNwbGF5TmFtZSA9IGNoaWxkVGFnOwogICAgICAgICAgICB2YXIgd2hpdGVzcGFjZUluZm8gPSAiIjsKICAgICAgICAgICAgaWYgKGNoaWxkVGFnID09PSAiI3RleHQiKSB7CiAgICAgICAgICAgICAgaWYgKC9cUy8udGVzdChjaGlsZFRleHQpKSB7CiAgICAgICAgICAgICAgICB0YWdEaXNwbGF5TmFtZSA9ICJUZXh0IG5vZGVzIjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFnRGlzcGxheU5hbWUgPSAiV2hpdGVzcGFjZSB0ZXh0IG5vZGVzIjsKICAgICAgICAgICAgICAgIHdoaXRlc3BhY2VJbmZvID0gIiBNYWtlIHN1cmUgeW91IGRvbid0IGhhdmUgYW55IGV4dHJhIHdoaXRlc3BhY2UgYmV0d2VlbiB0YWdzIG9uIGVhY2ggbGluZSBvZiB5b3VyIHNvdXJjZSBjb2RlLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRhZ0Rpc3BsYXlOYW1lID0gIjwiICsgY2hpbGRUYWcgKyAiPiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGludmFsaWRQYXJlbnQpIHsKICAgICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICAgIGlmIChhbmNlc3RvclRhZyA9PT0gInRhYmxlIiAmJiBjaGlsZFRhZyA9PT0gInRyIikgewogICAgICAgICAgICAgICAgaW5mbyArPSAiIEFkZCBhIDx0Ym9keT4sIDx0aGVhZD4gb3IgPHRmb290PiB0byB5b3VyIGNvZGUgdG8gbWF0Y2ggdGhlIERPTSB0cmVlIGdlbmVyYXRlZCBieSB0aGUgYnJvd3Nlci4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlcnJvcigidmFsaWRhdGVET01OZXN0aW5nKC4uLik6ICVzIGNhbm5vdCBhcHBlYXIgYXMgYSBjaGlsZCBvZiA8JXM+LiVzJXMiLCB0YWdEaXNwbGF5TmFtZSwgYW5jZXN0b3JUYWcsIHdoaXRlc3BhY2VJbmZvLCBpbmZvKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlcnJvcigidmFsaWRhdGVET01OZXN0aW5nKC4uLik6ICVzIGNhbm5vdCBhcHBlYXIgYXMgYSBkZXNjZW5kYW50IG9mIDwlcz4uIiwgdGFnRGlzcGxheU5hbWUsIGFuY2VzdG9yVGFnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDEgPSAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIjsKICAgICAgICB2YXIgU1VTUEVOU0VfU1RBUlRfREFUQSA9ICIkIjsKICAgICAgICB2YXIgU1VTUEVOU0VfRU5EX0RBVEEgPSAiLyQiOwogICAgICAgIHZhciBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEgPSAiJD8iOwogICAgICAgIHZhciBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBID0gIiQhIjsKICAgICAgICB2YXIgU1RZTEUkMSA9ICJzdHlsZSI7CiAgICAgICAgdmFyIGV2ZW50c0VuYWJsZWQgPSBudWxsOwogICAgICAgIHZhciBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gZ2V0Um9vdEhvc3RDb250ZXh0KHJvb3RDb250YWluZXJJbnN0YW5jZSkgewogICAgICAgICAgdmFyIHR5cGU7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlOwogICAgICAgICAgdmFyIG5vZGVUeXBlID0gcm9vdENvbnRhaW5lckluc3RhbmNlLm5vZGVUeXBlOwogICAgICAgICAgc3dpdGNoIChub2RlVHlwZSkgewogICAgICAgICAgICBjYXNlIERPQ1VNRU5UX05PREU6CiAgICAgICAgICAgIGNhc2UgRE9DVU1FTlRfRlJBR01FTlRfTk9ERTogewogICAgICAgICAgICAgIHR5cGUgPSBub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/ICIjZG9jdW1lbnQiIDogIiNmcmFnbWVudCI7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcm9vdENvbnRhaW5lckluc3RhbmNlLmRvY3VtZW50RWxlbWVudDsKICAgICAgICAgICAgICBuYW1lc3BhY2UgPSByb290MyA/IHJvb3QzLm5hbWVzcGFjZVVSSSA6IGdldENoaWxkTmFtZXNwYWNlKG51bGwsICIiKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lcjIgPSBub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gcm9vdENvbnRhaW5lckluc3RhbmNlLnBhcmVudE5vZGUgOiByb290Q29udGFpbmVySW5zdGFuY2U7CiAgICAgICAgICAgICAgdmFyIG93bk5hbWVzcGFjZSA9IGNvbnRhaW5lcjIubmFtZXNwYWNlVVJJIHx8IG51bGw7CiAgICAgICAgICAgICAgdHlwZSA9IGNvbnRhaW5lcjIudGFnTmFtZTsKICAgICAgICAgICAgICBuYW1lc3BhY2UgPSBnZXRDaGlsZE5hbWVzcGFjZShvd25OYW1lc3BhY2UsIHR5cGUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB2YWxpZGF0ZWRUYWcgPSB0eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHZhciBhbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKG51bGwsIHZhbGlkYXRlZFRhZyk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICAgIGFuY2VzdG9ySW5mbwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDaGlsZEhvc3RDb250ZXh0KHBhcmVudEhvc3RDb250ZXh0LCB0eXBlLCByb290Q29udGFpbmVySW5zdGFuY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudEhvc3RDb250ZXh0RGV2ID0gcGFyZW50SG9zdENvbnRleHQ7CiAgICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSBnZXRDaGlsZE5hbWVzcGFjZShwYXJlbnRIb3N0Q29udGV4dERldi5uYW1lc3BhY2UsIHR5cGUpOwogICAgICAgICAgICB2YXIgYW5jZXN0b3JJbmZvID0gdXBkYXRlZEFuY2VzdG9ySW5mbyhwYXJlbnRIb3N0Q29udGV4dERldi5hbmNlc3RvckluZm8sIHR5cGUpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgICBhbmNlc3RvckluZm8KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UHVibGljSW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZUZvckNvbW1pdChjb250YWluZXJJbmZvKSB7CiAgICAgICAgICBldmVudHNFbmFibGVkID0gaXNFbmFibGVkKCk7CiAgICAgICAgICBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IGdldFNlbGVjdGlvbkluZm9ybWF0aW9uKCk7CiAgICAgICAgICB2YXIgYWN0aXZlSW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgc2V0RW5hYmxlZChmYWxzZSk7CiAgICAgICAgICByZXR1cm4gYWN0aXZlSW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0QWZ0ZXJDb21taXQoY29udGFpbmVySW5mbykgewogICAgICAgICAgcmVzdG9yZVNlbGVjdGlvbihzZWxlY3Rpb25JbmZvcm1hdGlvbik7CiAgICAgICAgICBzZXRFbmFibGVkKGV2ZW50c0VuYWJsZWQpOwogICAgICAgICAgZXZlbnRzRW5hYmxlZCA9IG51bGw7CiAgICAgICAgICBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUluc3RhbmNlKHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICB2YXIgcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKHR5cGUsIG51bGwsIGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJzdHJpbmciIHx8IHR5cGVvZiBwcm9wcy5jaGlsZHJlbiA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICB2YXIgc3RyaW5nID0gIiIgKyBwcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgb3duQW5jZXN0b3JJbmZvID0gdXBkYXRlZEFuY2VzdG9ySW5mbyhob3N0Q29udGV4dERldi5hbmNlc3RvckluZm8sIHR5cGUpOwogICAgICAgICAgICAgIHZhbGlkYXRlRE9NTmVzdGluZyhudWxsLCBzdHJpbmcsIG93bkFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyZW50TmFtZXNwYWNlID0gaG9zdENvbnRleHREZXYubmFtZXNwYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRvbUVsZW1lbnQgPSBjcmVhdGVFbGVtZW50MzkodHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgcGFyZW50TmFtZXNwYWNlKTsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIGRvbUVsZW1lbnQpOwogICAgICAgICAgdXBkYXRlRmliZXJQcm9wcyhkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICByZXR1cm4gZG9tRWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXBwZW5kSW5pdGlhbENoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5hbGl6ZUluaXRpYWxDaGlsZHJlbihkb21FbGVtZW50LCB0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCkgewogICAgICAgICAgc2V0SW5pdGlhbFByb3BlcnRpZXMoZG9tRWxlbWVudCwgdHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSk7CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSAiYnV0dG9uIjoKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgcmV0dXJuICEhcHJvcHMuYXV0b0ZvY3VzOwogICAgICAgICAgICBjYXNlICJpbWciOgogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVVwZGF0ZShkb21FbGVtZW50LCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvc3RDb250ZXh0RGV2ID0gaG9zdENvbnRleHQ7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3UHJvcHMuY2hpbGRyZW4gIT09IHR5cGVvZiBvbGRQcm9wcy5jaGlsZHJlbiAmJiAodHlwZW9mIG5ld1Byb3BzLmNoaWxkcmVuID09PSAic3RyaW5nIiB8fCB0eXBlb2YgbmV3UHJvcHMuY2hpbGRyZW4gPT09ICJudW1iZXIiKSkgewogICAgICAgICAgICAgIHZhciBzdHJpbmcgPSAiIiArIG5ld1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBvd25BbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbywgdHlwZSk7CiAgICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKG51bGwsIHN0cmluZywgb3duQW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRpZmZQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIHByb3BzKSB7CiAgICAgICAgICByZXR1cm4gdHlwZSA9PT0gInRleHRhcmVhIiB8fCB0eXBlID09PSAibm9zY3JpcHQiIHx8IHR5cGVvZiBwcm9wcy5jaGlsZHJlbiA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAibnVtYmVyIiB8fCB0eXBlb2YgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgPT09ICJvYmplY3QiICYmIHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9PSBudWxsICYmIHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MLl9faHRtbCAhPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVUZXh0SW5zdGFuY2UodGV4dCwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKG51bGwsIHRleHQsIGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdGV4dE5vZGUgPSBjcmVhdGVUZXh0Tm9kZSh0ZXh0LCByb290Q29udGFpbmVySW5zdGFuY2UpOwogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgdGV4dE5vZGUpOwogICAgICAgICAgcmV0dXJuIHRleHROb2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RXZlbnRQcmlvcml0eSgpIHsKICAgICAgICAgIHZhciBjdXJyZW50RXZlbnQgPSB3aW5kb3cuZXZlbnQ7CiAgICAgICAgICBpZiAoY3VycmVudEV2ZW50ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldEV2ZW50UHJpb3JpdHkoY3VycmVudEV2ZW50LnR5cGUpOwogICAgICAgIH0KICAgICAgICB2YXIgc2NoZWR1bGVUaW1lb3V0ID0gdHlwZW9mIHNldFRpbWVvdXQgPT09ICJmdW5jdGlvbiIgPyBzZXRUaW1lb3V0IDogdm9pZCAwOwogICAgICAgIHZhciBjYW5jZWxUaW1lb3V0ID0gdHlwZW9mIGNsZWFyVGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IGNsZWFyVGltZW91dCA6IHZvaWQgMDsKICAgICAgICB2YXIgbm9UaW1lb3V0ID0gLTE7CiAgICAgICAgdmFyIGxvY2FsUHJvbWlzZSA9IHR5cGVvZiBQcm9taXNlID09PSAiZnVuY3Rpb24iID8gUHJvbWlzZSA6IHZvaWQgMDsKICAgICAgICB2YXIgc2NoZWR1bGVNaWNyb3Rhc2sgPSB0eXBlb2YgcXVldWVNaWNyb3Rhc2sgPT09ICJmdW5jdGlvbiIgPyBxdWV1ZU1pY3JvdGFzayA6IHR5cGVvZiBsb2NhbFByb21pc2UgIT09ICJ1bmRlZmluZWQiID8gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiBsb2NhbFByb21pc2UucmVzb2x2ZShudWxsKS50aGVuKGNhbGxiYWNrKS5jYXRjaChoYW5kbGVFcnJvckluTmV4dFRpY2spOwogICAgICAgIH0gOiBzY2hlZHVsZVRpbWVvdXQ7CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlRXJyb3JJbk5leHRUaWNrKGVycm9yMikgewogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdE1vdW50KGRvbUVsZW1lbnQsIHR5cGUsIG5ld1Byb3BzLCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSAiYnV0dG9uIjoKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgaWYgKG5ld1Byb3BzLmF1dG9Gb2N1cykgewogICAgICAgICAgICAgICAgZG9tRWxlbWVudC5mb2N1cygpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGNhc2UgImltZyI6IHsKICAgICAgICAgICAgICBpZiAobmV3UHJvcHMuc3JjKSB7CiAgICAgICAgICAgICAgICBkb21FbGVtZW50LnNyYyA9IG5ld1Byb3BzLnNyYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFVwZGF0ZShkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHVwZGF0ZVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICAgIHVwZGF0ZUZpYmVyUHJvcHMoZG9tRWxlbWVudCwgbmV3UHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFRleHRDb250ZW50KGRvbUVsZW1lbnQpIHsKICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsICIiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0VGV4dFVwZGF0ZSh0ZXh0SW5zdGFuY2UsIG9sZFRleHQsIG5ld1RleHQpIHsKICAgICAgICAgIHRleHRJbnN0YW5jZS5ub2RlVmFsdWUgPSBuZXdUZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRDaGlsZChwYXJlbnRJbnN0YW5jZSwgY2hpbGQpIHsKICAgICAgICAgIHBhcmVudEluc3RhbmNlLmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXBwZW5kQ2hpbGRUb0NvbnRhaW5lcihjb250YWluZXIyLCBjaGlsZCkgewogICAgICAgICAgdmFyIHBhcmVudE5vZGU7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIHBhcmVudE5vZGUgPSBjb250YWluZXIyLnBhcmVudE5vZGU7CiAgICAgICAgICAgIHBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkLCBjb250YWluZXIyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhcmVudE5vZGUgPSBjb250YWluZXIyOwogICAgICAgICAgICBwYXJlbnROb2RlLmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByZWFjdFJvb3RDb250YWluZXIgPSBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICBpZiAoKHJlYWN0Um9vdENvbnRhaW5lciA9PT0gbnVsbCB8fCByZWFjdFJvb3RDb250YWluZXIgPT09IHZvaWQgMCkgJiYgcGFyZW50Tm9kZS5vbmNsaWNrID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyYXBDbGlja09uTm9uSW50ZXJhY3RpdmVFbGVtZW50KHBhcmVudE5vZGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnNlcnRCZWZvcmUocGFyZW50SW5zdGFuY2UsIGNoaWxkLCBiZWZvcmVDaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UuaW5zZXJ0QmVmb3JlKGNoaWxkLCBiZWZvcmVDaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydEluQ29udGFpbmVyQmVmb3JlKGNvbnRhaW5lcjIsIGNoaWxkLCBiZWZvcmVDaGlsZCkgewogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICBjb250YWluZXIyLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkLCBiZWZvcmVDaGlsZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250YWluZXIyLmluc2VydEJlZm9yZShjaGlsZCwgYmVmb3JlQ2hpbGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVDaGlsZChwYXJlbnRJbnN0YW5jZSwgY2hpbGQpIHsKICAgICAgICAgIHBhcmVudEluc3RhbmNlLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVtb3ZlQ2hpbGRGcm9tQ29udGFpbmVyKGNvbnRhaW5lcjIsIGNoaWxkKSB7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250YWluZXIyLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xlYXJTdXNwZW5zZUJvdW5kYXJ5KHBhcmVudEluc3RhbmNlLCBzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHN1c3BlbnNlSW5zdGFuY2U7CiAgICAgICAgICB2YXIgZGVwdGggPSAwOwogICAgICAgICAgZG8gewogICAgICAgICAgICB2YXIgbmV4dE5vZGUgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5yZW1vdmVDaGlsZChub2RlKTsKICAgICAgICAgICAgaWYgKG5leHROb2RlICYmIG5leHROb2RlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgZGF0YSA9IG5leHROb2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UucmVtb3ZlQ2hpbGQobmV4dE5vZGUpOwogICAgICAgICAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZXB0aC0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSkgewogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5leHROb2RlOwogICAgICAgICAgfSB3aGlsZSAobm9kZSk7CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhclN1c3BlbnNlQm91bmRhcnlGcm9tQ29udGFpbmVyKGNvbnRhaW5lcjIsIHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgY2xlYXJTdXNwZW5zZUJvdW5kYXJ5KGNvbnRhaW5lcjIucGFyZW50Tm9kZSwgc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoY29udGFpbmVyMiwgc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKGNvbnRhaW5lcjIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWRlSW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2U7CiAgICAgICAgICB2YXIgc3R5bGUyID0gaW5zdGFuY2Uuc3R5bGU7CiAgICAgICAgICBpZiAodHlwZW9mIHN0eWxlMi5zZXRQcm9wZXJ0eSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBzdHlsZTIuc2V0UHJvcGVydHkoImRpc3BsYXkiLCAibm9uZSIsICJpbXBvcnRhbnQiKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0eWxlMi5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9ICIiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bmhpZGVJbnN0YW5jZShpbnN0YW5jZSwgcHJvcHMpIHsKICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2U7CiAgICAgICAgICB2YXIgc3R5bGVQcm9wID0gcHJvcHNbU1RZTEUkMV07CiAgICAgICAgICB2YXIgZGlzcGxheSA9IHN0eWxlUHJvcCAhPT0gdm9pZCAwICYmIHN0eWxlUHJvcCAhPT0gbnVsbCAmJiBzdHlsZVByb3AuaGFzT3duUHJvcGVydHkoImRpc3BsYXkiKSA/IHN0eWxlUHJvcC5kaXNwbGF5IDogbnVsbDsKICAgICAgICAgIGluc3RhbmNlLnN0eWxlLmRpc3BsYXkgPSBkYW5nZXJvdXNTdHlsZVZhbHVlKCJkaXNwbGF5IiwgZGlzcGxheSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuaGlkZVRleHRJbnN0YW5jZSh0ZXh0SW5zdGFuY2UsIHRleHQpIHsKICAgICAgICAgIHRleHRJbnN0YW5jZS5ub2RlVmFsdWUgPSB0ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhckNvbnRhaW5lcihjb250YWluZXIyKSB7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIudGV4dENvbnRlbnQgPSAiIjsKICAgICAgICAgIH0gZWxzZSBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSkgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5kb2N1bWVudEVsZW1lbnQpIHsKICAgICAgICAgICAgICBjb250YWluZXIyLnJlbW92ZUNoaWxkKGNvbnRhaW5lcjIuZG9jdW1lbnRFbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5IeWRyYXRlSW5zdGFuY2UoaW5zdGFuY2UsIHR5cGUsIHByb3BzKSB7CiAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgIT09IEVMRU1FTlRfTk9ERSB8fCB0eXBlLnRvTG93ZXJDYXNlKCkgIT09IGluc3RhbmNlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVUZXh0SW5zdGFuY2UoaW5zdGFuY2UsIHRleHQpIHsKICAgICAgICAgIGlmICh0ZXh0ID09PSAiIiB8fCBpbnN0YW5jZS5ub2RlVHlwZSAhPT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5IeWRyYXRlU3VzcGVuc2VJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgaWYgKGluc3RhbmNlLm5vZGVUeXBlICE9PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU3VzcGVuc2VJbnN0YW5jZVBlbmRpbmcoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZS5kYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2UuZGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrRXJyb3JEZXRhaWxzKGluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgZGF0YXNldCA9IGluc3RhbmNlLm5leHRTaWJsaW5nICYmIGluc3RhbmNlLm5leHRTaWJsaW5nLmRhdGFzZXQ7CiAgICAgICAgICB2YXIgZGlnZXN0LCBtZXNzYWdlLCBzdGFjazsKICAgICAgICAgIGlmIChkYXRhc2V0KSB7CiAgICAgICAgICAgIGRpZ2VzdCA9IGRhdGFzZXQuZGdzdDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1lc3NhZ2UgPSBkYXRhc2V0Lm1zZzsKICAgICAgICAgICAgICBzdGFjayA9IGRhdGFzZXQuc3RjazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIG1lc3NhZ2UsCiAgICAgICAgICAgICAgZGlnZXN0LAogICAgICAgICAgICAgIHN0YWNrCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyU3VzcGVuc2VJbnN0YW5jZVJldHJ5KGluc3RhbmNlLCBjYWxsYmFjaykgewogICAgICAgICAgaW5zdGFuY2UuX3JlYWN0UmV0cnkgPSBjYWxsYmFjazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dEh5ZHJhdGFibGUobm9kZSkgewogICAgICAgICAgZm9yICg7IG5vZGUgIT0gbnVsbDsgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgdmFyIG5vZGVUeXBlID0gbm9kZS5ub2RlVHlwZTsKICAgICAgICAgICAgaWYgKG5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgfHwgbm9kZVR5cGUgPT09IFRFWFRfTk9ERSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIG5vZGVEYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgIGlmIChub2RlRGF0YSA9PT0gU1VTUEVOU0VfU1RBUlRfREFUQSB8fCBub2RlRGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSB8fCBub2RlRGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGVEYXRhID09PSBTVVNQRU5TRV9FTkRfREFUQSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUoaW5zdGFuY2UubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZChwYXJlbnRJbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKHBhcmVudEluc3RhbmNlLmZpcnN0Q2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZFdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIpIHsKICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZShwYXJlbnRDb250YWluZXIuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKHBhcmVudEluc3RhbmNlLm5leHRTaWJsaW5nKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZUluc3RhbmNlKGluc3RhbmNlLCB0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgc2hvdWxkV2FybkRldikgewogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgaW5zdGFuY2UpOwogICAgICAgICAgdXBkYXRlRmliZXJQcm9wcyhpbnN0YW5jZSwgcHJvcHMpOwogICAgICAgICAgdmFyIHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvc3RDb250ZXh0RGV2ID0gaG9zdENvbnRleHQ7CiAgICAgICAgICAgIHBhcmVudE5hbWVzcGFjZSA9IGhvc3RDb250ZXh0RGV2Lm5hbWVzcGFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKGludGVybmFsSW5zdGFuY2VIYW5kbGUubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgcmV0dXJuIGRpZmZIeWRyYXRlZFByb3BlcnRpZXMoaW5zdGFuY2UsIHR5cGUsIHByb3BzLCBwYXJlbnROYW1lc3BhY2UsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVUZXh0SW5zdGFuY2UodGV4dEluc3RhbmNlLCB0ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCB0ZXh0SW5zdGFuY2UpOwogICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZS5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICByZXR1cm4gZGlmZkh5ZHJhdGVkVGV4dCh0ZXh0SW5zdGFuY2UsIHRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlLCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dEh5ZHJhdGFibGVJbnN0YW5jZUFmdGVyU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHN1c3BlbnNlSW5zdGFuY2UubmV4dFNpYmxpbmc7CiAgICAgICAgICB2YXIgZGVwdGggPSAwOwogICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgIGlmIChkYXRhID09PSBTVVNQRU5TRV9FTkRfREFUQSkgewogICAgICAgICAgICAgICAgaWYgKGRlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcobm9kZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZXB0aC0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSkgewogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZSh0YXJnZXRJbnN0YW5jZSkgewogICAgICAgICAgdmFyIG5vZGUgPSB0YXJnZXRJbnN0YW5jZS5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICB2YXIgZGVwdGggPSAwOwogICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZXB0aC0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfRU5EX0RBVEEpIHsKICAgICAgICAgICAgICAgIGRlcHRoKys7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRIeWRyYXRlZENvbnRhaW5lcihjb250YWluZXIyKSB7CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKGNvbnRhaW5lcjIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRIeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgcmV0cnlJZkJsb2NrZWRPbihzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkRGVsZXRlVW5oeWRyYXRlZFRhaWxJbnN0YW5jZXMocGFyZW50VHlwZSkgewogICAgICAgICAgcmV0dXJuIHBhcmVudFR5cGUgIT09ICJoZWFkIiAmJiBwYXJlbnRUeXBlICE9PSAiYm9keSI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdE1hdGNoSHlkcmF0ZWRDb250YWluZXJUZXh0SW5zdGFuY2UocGFyZW50Q29udGFpbmVyLCB0ZXh0SW5zdGFuY2UsIHRleHQsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHZhciBzaG91bGRXYXJuRGV2ID0gdHJ1ZTsKICAgICAgICAgIGNoZWNrRm9yVW5tYXRjaGVkVGV4dCh0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90TWF0Y2hIeWRyYXRlZFRleHRJbnN0YW5jZShwYXJlbnRUeXBlLCBwYXJlbnRQcm9wcywgcGFyZW50SW5zdGFuY2UsIHRleHRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgaWYgKHBhcmVudFByb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDFdICE9PSB0cnVlKSB7CiAgICAgICAgICAgIHZhciBzaG91bGRXYXJuRGV2ID0gdHJ1ZTsKICAgICAgICAgICAgY2hlY2tGb3JVbm1hdGNoZWRUZXh0KHRleHRJbnN0YW5jZS5ub2RlVmFsdWUsIHRleHQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RIeWRyYXRlSW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZUVsZW1lbnQocGFyZW50Q29udGFpbmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudENvbnRhaW5lciwgaW5zdGFuY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UocGFyZW50SW5zdGFuY2UsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gcGFyZW50SW5zdGFuY2UucGFyZW50Tm9kZTsKICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnROb2RlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudE5vZGUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90SHlkcmF0ZUluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgfHwgcGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgOwogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlVGV4dChwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudENvbnRhaW5lciwgdHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZFRleHQocGFyZW50Q29udGFpbmVyLCB0ZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UocGFyZW50SW5zdGFuY2UsIHR5cGUsIHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gcGFyZW50SW5zdGFuY2UucGFyZW50Tm9kZTsKICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgIT09IG51bGwpIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkRWxlbWVudChwYXJlbnROb2RlLCB0eXBlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHBhcmVudEluc3RhbmNlLCB0ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gcGFyZW50SW5zdGFuY2UucGFyZW50Tm9kZTsKICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgIT09IG51bGwpIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnROb2RlLCB0ZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZShwYXJlbnRUeXBlLCBwYXJlbnRQcm9wcywgcGFyZW50SW5zdGFuY2UsIHR5cGUsIHByb3BzLCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0NvbmN1cnJlbnRNb2RlIHx8IHBhcmVudFByb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDFdICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudEluc3RhbmNlLCB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZShwYXJlbnRUeXBlLCBwYXJlbnRQcm9wcywgcGFyZW50SW5zdGFuY2UsIHRleHQsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgfHwgcGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZFRleHQocGFyZW50SW5zdGFuY2UsIHRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9ySHlkcmF0aW5nQ29udGFpbmVyKHBhcmVudENvbnRhaW5lcikgewogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiQW4gZXJyb3Igb2NjdXJyZWQgZHVyaW5nIGh5ZHJhdGlvbi4gVGhlIHNlcnZlciBIVE1MIHdhcyByZXBsYWNlZCB3aXRoIGNsaWVudCBjb250ZW50IGluIDwlcz4uIiwgcGFyZW50Q29udGFpbmVyLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlUG9ydGFsTW91bnQocG9ydGFsSW5zdGFuY2UpIHsKICAgICAgICAgIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKHBvcnRhbEluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgdmFyIHJhbmRvbUtleSA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpOwogICAgICAgIHZhciBpbnRlcm5hbEluc3RhbmNlS2V5ID0gIl9fcmVhY3RGaWJlciQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbFByb3BzS2V5ID0gIl9fcmVhY3RQcm9wcyQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5ID0gIl9fcmVhY3RDb250YWluZXIkIiArIHJhbmRvbUtleTsKICAgICAgICB2YXIgaW50ZXJuYWxFdmVudEhhbmRsZXJzS2V5ID0gIl9fcmVhY3RFdmVudHMkIiArIHJhbmRvbUtleTsKICAgICAgICB2YXIgaW50ZXJuYWxFdmVudEhhbmRsZXJMaXN0ZW5lcnNLZXkgPSAiX19yZWFjdExpc3RlbmVycyQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlc1NldEtleSA9ICJfX3JlYWN0SGFuZGxlcyQiICsgcmFuZG9tS2V5OwogICAgICAgIGZ1bmN0aW9uIGRldGFjaERlbGV0ZWRJbnN0YW5jZShub2RlKSB7CiAgICAgICAgICBkZWxldGUgbm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XTsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsUHJvcHNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJzS2V5XTsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVyTGlzdGVuZXJzS2V5XTsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVzU2V0S2V5XTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlY2FjaGVGaWJlck5vZGUoaG9zdEluc3QsIG5vZGUpIHsKICAgICAgICAgIG5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV0gPSBob3N0SW5zdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbnRhaW5lckFzUm9vdChob3N0Um9vdCwgbm9kZSkgewogICAgICAgICAgbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XSA9IGhvc3RSb290OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bm1hcmtDb250YWluZXJBc1Jvb3Qobm9kZSkgewogICAgICAgICAgbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29udGFpbmVyTWFya2VkQXNSb290KG5vZGUpIHsKICAgICAgICAgIHJldHVybiAhIW5vZGVbaW50ZXJuYWxDb250YWluZXJJbnN0YW5jZUtleV07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKHRhcmdldE5vZGUpIHsKICAgICAgICAgIHZhciB0YXJnZXRJbnN0ID0gdGFyZ2V0Tm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XTsKICAgICAgICAgIGlmICh0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgIHJldHVybiB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSB0YXJnZXROb2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB3aGlsZSAocGFyZW50Tm9kZSkgewogICAgICAgICAgICB0YXJnZXRJbnN0ID0gcGFyZW50Tm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XSB8fCBwYXJlbnROb2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgICBpZiAodGFyZ2V0SW5zdCkgewogICAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSB0YXJnZXRJbnN0LmFsdGVybmF0ZTsKICAgICAgICAgICAgICBpZiAodGFyZ2V0SW5zdC5jaGlsZCAhPT0gbnVsbCB8fCBhbHRlcm5hdGUgIT09IG51bGwgJiYgYWx0ZXJuYXRlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VJbnN0YW5jZSA9IGdldFBhcmVudFN1c3BlbnNlSW5zdGFuY2UodGFyZ2V0Tm9kZSk7CiAgICAgICAgICAgICAgICB3aGlsZSAoc3VzcGVuc2VJbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0U3VzcGVuc2VJbnN0ID0gc3VzcGVuc2VJbnN0YW5jZVtpbnRlcm5hbEluc3RhbmNlS2V5XTsKICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldFN1c3BlbnNlSW5zdCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXRTdXNwZW5zZUluc3Q7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3VzcGVuc2VJbnN0YW5jZSA9IGdldFBhcmVudFN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0YXJnZXRJbnN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRhcmdldE5vZGUgPSBwYXJlbnROb2RlOwogICAgICAgICAgICBwYXJlbnROb2RlID0gdGFyZ2V0Tm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEluc3RhbmNlRnJvbU5vZGUobm9kZSkgewogICAgICAgICAgdmFyIGluc3QgPSBub2RlW2ludGVybmFsSW5zdGFuY2VLZXldIHx8IG5vZGVbaW50ZXJuYWxDb250YWluZXJJbnN0YW5jZUtleV07CiAgICAgICAgICBpZiAoaW5zdCkgewogICAgICAgICAgICBpZiAoaW5zdC50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgaW5zdC50YWcgPT09IEhvc3RUZXh0IHx8IGluc3QudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCB8fCBpbnN0LnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICByZXR1cm4gaW5zdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5vZGVGcm9tSW5zdGFuY2UoaW5zdCkgewogICAgICAgICAgaWYgKGluc3QudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IGluc3QudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICByZXR1cm4gaW5zdC5zdGF0ZU5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImdldE5vZGVGcm9tSW5zdGFuY2U6IEludmFsaWQgYXJndW1lbnQuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUobm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGVbaW50ZXJuYWxQcm9wc0tleV0gfHwgbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRmliZXJQcm9wcyhub2RlLCBwcm9wcykgewogICAgICAgICAgbm9kZVtpbnRlcm5hbFByb3BzS2V5XSA9IHByb3BzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudExpc3RlbmVyU2V0KG5vZGUpIHsKICAgICAgICAgIHZhciBlbGVtZW50TGlzdGVuZXJTZXQgPSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVyc0tleV07CiAgICAgICAgICBpZiAoZWxlbWVudExpc3RlbmVyU2V0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgZWxlbWVudExpc3RlbmVyU2V0ID0gbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXldID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50TGlzdGVuZXJTZXQ7CiAgICAgICAgfQogICAgICAgIHZhciBsb2dnZWRUeXBlRmFpbHVyZXMgPSB7fTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGVsZW1lbnQudHlwZSwgZWxlbWVudC5fc291cmNlLCBvd25lciA/IG93bmVyLnR5cGUgOiBudWxsKTsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFR5cGVzKHR5cGVTcGVjcywgdmFsdWVzLCBsb2NhdGlvbiwgY29tcG9uZW50TmFtZSwgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzNCA9IEZ1bmN0aW9uLmNhbGwuYmluZChoYXNPd25Qcm9wZXJ0eSk7CiAgICAgICAgICAgIGZvciAodmFyIHR5cGVTcGVjTmFtZSBpbiB0eXBlU3BlY3MpIHsKICAgICAgICAgICAgICBpZiAoaGFzNCh0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBFcnJvcigoY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiKSArICI6ICIgKyBsb2NhdGlvbiArICIgdHlwZSBgIiArIHR5cGVTcGVjTmFtZSArICJgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tIHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZSwgYnV0IHJlY2VpdmVkIGAiICsgdHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICsgImAuVGhpcyBvZnRlbiBoYXBwZW5zIGJlY2F1c2Ugb2YgdHlwb3Mgc3VjaCBhcyBgUHJvcFR5cGVzLmZ1bmN0aW9uYCBpbnN0ZWFkIG9mIGBQcm9wVHlwZXMuZnVuY2AuIik7CiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsdWVTdGFjayA9IFtdOwogICAgICAgIHZhciBmaWJlclN0YWNrOwogICAgICAgIHsKICAgICAgICAgIGZpYmVyU3RhY2sgPSBbXTsKICAgICAgICB9CiAgICAgICAgdmFyIGluZGV4ID0gLTE7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ3Vyc29yKGRlZmF1bHRWYWx1ZSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgY3VycmVudDogZGVmYXVsdFZhbHVlCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3AoY3Vyc29yLCBmaWJlcikgewogICAgICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgcG9wLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGZpYmVyICE9PSBmaWJlclN0YWNrW2luZGV4XSkgewogICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIEZpYmVyIHBvcHBlZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3Vyc29yLmN1cnJlbnQgPSB2YWx1ZVN0YWNrW2luZGV4XTsKICAgICAgICAgIHZhbHVlU3RhY2tbaW5kZXhdID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJTdGFja1tpbmRleF0gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaW5kZXgtLTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaChjdXJzb3IsIHZhbHVlLCBmaWJlcikgewogICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgIHZhbHVlU3RhY2tbaW5kZXhdID0gY3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyU3RhY2tbaW5kZXhdID0gZmliZXI7CiAgICAgICAgICB9CiAgICAgICAgICBjdXJzb3IuY3VycmVudCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICB2YXIgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0OwogICAgICAgIHsKICAgICAgICAgIHdhcm5lZEFib3V0TWlzc2luZ0dldENoaWxkQ29udGV4dCA9IHt9OwogICAgICAgIH0KICAgICAgICB2YXIgZW1wdHlDb250ZXh0T2JqZWN0ID0ge307CiAgICAgICAgewogICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbXB0eUNvbnRleHRPYmplY3QpOwogICAgICAgIH0KICAgICAgICB2YXIgY29udGV4dFN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKGVtcHR5Q29udGV4dE9iamVjdCk7CiAgICAgICAgdmFyIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoZmFsc2UpOwogICAgICAgIHZhciBwcmV2aW91c0NvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgZnVuY3Rpb24gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBkaWRQdXNoT3duQ29udGV4dElmUHJvdmlkZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFB1c2hPd25Db250ZXh0SWZQcm92aWRlciAmJiBpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHByZXZpb3VzQ29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhY2hlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCwgbWFza2VkQ29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZFVubWFza2VkQ2hpbGRDb250ZXh0ID0gdW5tYXNrZWRDb250ZXh0OwogICAgICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1hc2tlZENoaWxkQ29udGV4dCA9IG1hc2tlZENvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgdmFyIGNvbnRleHRUeXBlcyA9IHR5cGUuY29udGV4dFR5cGVzOwogICAgICAgICAgICBpZiAoIWNvbnRleHRUeXBlcykgewogICAgICAgICAgICAgIHJldHVybiBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgaWYgKGluc3RhbmNlICYmIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkVW5tYXNrZWRDaGlsZENvbnRleHQgPT09IHVubWFza2VkQ29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1hc2tlZENoaWxkQ29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29udGV4dCA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gY29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgY29udGV4dFtrZXldID0gdW5tYXNrZWRDb250ZXh0W2tleV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhjb250ZXh0VHlwZXMsIGNvbnRleHQsICJjb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlKSB7CiAgICAgICAgICAgICAgY2FjaGVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0LCBjb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzQ29udGV4dENoYW5nZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29udGV4dFByb3ZpZGVyKHR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dFR5cGVzID0gdHlwZS5jaGlsZENvbnRleHRUeXBlczsKICAgICAgICAgICAgcmV0dXJuIGNoaWxkQ29udGV4dFR5cGVzICE9PSBudWxsICYmIGNoaWxkQ29udGV4dFR5cGVzICE9PSB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcENvbnRleHQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BUb3BMZXZlbENvbnRleHRPYmplY3QoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoVG9wTGV2ZWxDb250ZXh0T2JqZWN0KGZpYmVyLCBjb250ZXh0LCBkaWRDaGFuZ2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGNvbnRleHRTdGFja0N1cnNvci5jdXJyZW50ICE9PSBlbXB0eUNvbnRleHRPYmplY3QpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgY29udGV4dCBmb3VuZCBvbiBzdGFjay4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciwgY29udGV4dCwgZmliZXIpOwogICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzQ2hpbGRDb250ZXh0KGZpYmVyLCB0eXBlLCBwYXJlbnRDb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dFR5cGVzID0gdHlwZS5jaGlsZENvbnRleHRUeXBlczsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRDaGlsZENvbnRleHQgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICAgIGlmICghd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0W2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5lZEFib3V0TWlzc2luZ0dldENoaWxkQ29udGV4dFtjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlcy5jaGlsZENvbnRleHRUeXBlcyBpcyBzcGVjaWZpZWQgYnV0IHRoZXJlIGlzIG5vIGdldENoaWxkQ29udGV4dCgpIG1ldGhvZCBvbiB0aGUgaW5zdGFuY2UuIFlvdSBjYW4gZWl0aGVyIGRlZmluZSBnZXRDaGlsZENvbnRleHQoKSBvbiAlcyBvciByZW1vdmUgY2hpbGRDb250ZXh0VHlwZXMgZnJvbSBpdC4iLCBjb21wb25lbnROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dCA9IGluc3RhbmNlLmdldENoaWxkQ29udGV4dCgpOwogICAgICAgICAgICBmb3IgKHZhciBjb250ZXh0S2V5IGluIGNoaWxkQ29udGV4dCkgewogICAgICAgICAgICAgIGlmICghKGNvbnRleHRLZXkgaW4gY2hpbGRDb250ZXh0VHlwZXMpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJVbmtub3duIikgKyAnLmdldENoaWxkQ29udGV4dCgpOiBrZXkgIicgKyBjb250ZXh0S2V5ICsgJyIgaXMgbm90IGRlZmluZWQgaW4gY2hpbGRDb250ZXh0VHlwZXMuJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhjaGlsZENvbnRleHRUeXBlcywgY2hpbGRDb250ZXh0LCAiY2hpbGQgY29udGV4dCIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhc3NpZ24yKHt9LCBwYXJlbnRDb250ZXh0LCBjaGlsZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgbWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQgPSBpbnN0YW5jZSAmJiBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCB8fCBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICAgIHByZXZpb3VzQ29udGV4dCA9IGNvbnRleHRTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciwgbWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvci5jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52YWxpZGF0ZUNvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIGRpZENoYW5nZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoIWluc3RhbmNlKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBoYXZlIGFuIGluc3RhbmNlIGJ5IHRoaXMgcG9pbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpZENoYW5nZSkgewogICAgICAgICAgICAgIHZhciBtZXJnZWRDb250ZXh0ID0gcHJvY2Vzc0NoaWxkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIHByZXZpb3VzQ29udGV4dCk7CiAgICAgICAgICAgICAgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQgPSBtZXJnZWRDb250ZXh0OwogICAgICAgICAgICAgIHBvcChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IsIG1lcmdlZENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcHVzaChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBkaWRDaGFuZ2UsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcHVzaChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBkaWRDaGFuZ2UsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRVbm1hc2tlZENvbnRleHQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFpc0ZpYmVyTW91bnRlZChmaWJlcikgfHwgZmliZXIudGFnICE9PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgc3VidHJlZSBwYXJlbnQgdG8gYmUgYSBtb3VudGVkIGNsYXNzIGNvbXBvbmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgc3dpdGNoIChub2RlLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuc3RhdGVOb2RlLmNvbnRleHQ7CiAgICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSBub2RlLnR5cGU7CiAgICAgICAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuc3RhdGVOb2RlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0gd2hpbGUgKG5vZGUgIT09IG51bGwpOwogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkZvdW5kIHVuZXhwZWN0ZWQgZGV0YWNoZWQgc3VidHJlZSBwYXJlbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBMZWdhY3lSb290ID0gMDsKICAgICAgICB2YXIgQ29uY3VycmVudFJvb3QgPSAxOwogICAgICAgIHZhciBzeW5jUXVldWUgPSBudWxsOwogICAgICAgIHZhciBpbmNsdWRlc0xlZ2FjeVN5bmNDYWxsYmFja3MgPSBmYWxzZTsKICAgICAgICB2YXIgaXNGbHVzaGluZ1N5bmNRdWV1ZSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlU3luY0NhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICAgICAgICBpZiAoc3luY1F1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHN5bmNRdWV1ZSA9IFtjYWxsYmFja107CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzeW5jUXVldWUucHVzaChjYWxsYmFjayk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlTGVnYWN5U3luY0NhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICAgICAgICBpbmNsdWRlc0xlZ2FjeVN5bmNDYWxsYmFja3MgPSB0cnVlOwogICAgICAgICAgc2NoZWR1bGVTeW5jQ2FsbGJhY2soY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmNDYWxsYmFja3NPbmx5SW5MZWdhY3lNb2RlKCkgewogICAgICAgICAgaWYgKGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcykgewogICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jQ2FsbGJhY2tzKCkgewogICAgICAgICAgaWYgKCFpc0ZsdXNoaW5nU3luY1F1ZXVlICYmIHN5bmNRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpc0ZsdXNoaW5nU3luY1F1ZXVlID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgICB2YXIgcHJldmlvdXNVcGRhdGVQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciBpc1N5bmMgPSB0cnVlOwogICAgICAgICAgICAgIHZhciBxdWV1ZSA9IHN5bmNRdWV1ZTsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgICBmb3IgKDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBxdWV1ZVtpXTsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBjYWxsYmFjayhpc1N5bmMpOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoY2FsbGJhY2sgIT09IG51bGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzeW5jUXVldWUgPSBudWxsOwogICAgICAgICAgICAgIGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcyA9IGZhbHNlOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBpZiAoc3luY1F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzeW5jUXVldWUgPSBzeW5jUXVldWUuc2xpY2UoaSArIDEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrKEltbWVkaWF0ZVByaW9yaXR5LCBmbHVzaFN5bmNDYWxsYmFja3MpOwogICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNVcGRhdGVQcmlvcml0eSk7CiAgICAgICAgICAgICAgaXNGbHVzaGluZ1N5bmNRdWV1ZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIGZvcmtTdGFjayA9IFtdOwogICAgICAgIHZhciBmb3JrU3RhY2tJbmRleCA9IDA7CiAgICAgICAgdmFyIHRyZWVGb3JrUHJvdmlkZXIgPSBudWxsOwogICAgICAgIHZhciB0cmVlRm9ya0NvdW50ID0gMDsKICAgICAgICB2YXIgaWRTdGFjayA9IFtdOwogICAgICAgIHZhciBpZFN0YWNrSW5kZXggPSAwOwogICAgICAgIHZhciB0cmVlQ29udGV4dFByb3ZpZGVyID0gbnVsbDsKICAgICAgICB2YXIgdHJlZUNvbnRleHRJZCA9IDE7CiAgICAgICAgdmFyIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSAiIjsKICAgICAgICBmdW5jdGlvbiBpc0ZvcmtlZENoaWxkKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICByZXR1cm4gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmtlZCkgIT09IE5vRmxhZ3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZvcmtzQXRMZXZlbCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgcmV0dXJuIHRyZWVGb3JrQ291bnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRyZWVJZCgpIHsKICAgICAgICAgIHZhciBvdmVyZmxvdyA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICB2YXIgaWRXaXRoTGVhZGluZ0JpdCA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICB2YXIgaWQgPSBpZFdpdGhMZWFkaW5nQml0ICYgfmdldExlYWRpbmdCaXQoaWRXaXRoTGVhZGluZ0JpdCk7CiAgICAgICAgICByZXR1cm4gaWQudG9TdHJpbmcoMzIpICsgb3ZlcmZsb3c7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hUcmVlRm9yayh3b3JrSW5Qcm9ncmVzczIsIHRvdGFsQ2hpbGRyZW4pIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4KytdID0gdHJlZUZvcmtDb3VudDsKICAgICAgICAgIGZvcmtTdGFja1tmb3JrU3RhY2tJbmRleCsrXSA9IHRyZWVGb3JrUHJvdmlkZXI7CiAgICAgICAgICB0cmVlRm9ya1Byb3ZpZGVyID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgdHJlZUZvcmtDb3VudCA9IHRvdGFsQ2hpbGRyZW47CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hUcmVlSWQod29ya0luUHJvZ3Jlc3MyLCB0b3RhbENoaWxkcmVuLCBpbmRleDIpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dElkOwogICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dE92ZXJmbG93OwogICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dFByb3ZpZGVyOwogICAgICAgICAgdHJlZUNvbnRleHRQcm92aWRlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHZhciBiYXNlSWRXaXRoTGVhZGluZ0JpdCA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICB2YXIgYmFzZU92ZXJmbG93ID0gdHJlZUNvbnRleHRPdmVyZmxvdzsKICAgICAgICAgIHZhciBiYXNlTGVuZ3RoID0gZ2V0Qml0TGVuZ3RoKGJhc2VJZFdpdGhMZWFkaW5nQml0KSAtIDE7CiAgICAgICAgICB2YXIgYmFzZUlkID0gYmFzZUlkV2l0aExlYWRpbmdCaXQgJiB+KDEgPDwgYmFzZUxlbmd0aCk7CiAgICAgICAgICB2YXIgc2xvdCA9IGluZGV4MiArIDE7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gZ2V0Qml0TGVuZ3RoKHRvdGFsQ2hpbGRyZW4pICsgYmFzZUxlbmd0aDsKICAgICAgICAgIGlmIChsZW5ndGggPiAzMCkgewogICAgICAgICAgICB2YXIgbnVtYmVyT2ZPdmVyZmxvd0JpdHMgPSBiYXNlTGVuZ3RoIC0gYmFzZUxlbmd0aCAlIDU7CiAgICAgICAgICAgIHZhciBuZXdPdmVyZmxvd0JpdHMgPSAoMSA8PCBudW1iZXJPZk92ZXJmbG93Qml0cykgLSAxOwogICAgICAgICAgICB2YXIgbmV3T3ZlcmZsb3cgPSAoYmFzZUlkICYgbmV3T3ZlcmZsb3dCaXRzKS50b1N0cmluZygzMik7CiAgICAgICAgICAgIHZhciByZXN0T2ZCYXNlSWQgPSBiYXNlSWQgPj4gbnVtYmVyT2ZPdmVyZmxvd0JpdHM7CiAgICAgICAgICAgIHZhciByZXN0T2ZCYXNlTGVuZ3RoID0gYmFzZUxlbmd0aCAtIG51bWJlck9mT3ZlcmZsb3dCaXRzOwogICAgICAgICAgICB2YXIgcmVzdE9mTGVuZ3RoID0gZ2V0Qml0TGVuZ3RoKHRvdGFsQ2hpbGRyZW4pICsgcmVzdE9mQmFzZUxlbmd0aDsKICAgICAgICAgICAgdmFyIHJlc3RPZk5ld0JpdHMgPSBzbG90IDw8IHJlc3RPZkJhc2VMZW5ndGg7CiAgICAgICAgICAgIHZhciBpZCA9IHJlc3RPZk5ld0JpdHMgfCByZXN0T2ZCYXNlSWQ7CiAgICAgICAgICAgIHZhciBvdmVyZmxvdyA9IG5ld092ZXJmbG93ICsgYmFzZU92ZXJmbG93OwogICAgICAgICAgICB0cmVlQ29udGV4dElkID0gMSA8PCByZXN0T2ZMZW5ndGggfCBpZDsKICAgICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IG92ZXJmbG93OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG5ld0JpdHMgPSBzbG90IDw8IGJhc2VMZW5ndGg7CiAgICAgICAgICAgIHZhciBfaWQgPSBuZXdCaXRzIHwgYmFzZUlkOwogICAgICAgICAgICB2YXIgX292ZXJmbG93ID0gYmFzZU92ZXJmbG93OwogICAgICAgICAgICB0cmVlQ29udGV4dElkID0gMSA8PCBsZW5ndGggfCBfaWQ7CiAgICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBfb3ZlcmZsb3c7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hNYXRlcmlhbGl6ZWRUcmVlSWQod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IHdvcmtJblByb2dyZXNzMi5yZXR1cm47CiAgICAgICAgICBpZiAocmV0dXJuRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSAxOwogICAgICAgICAgICB2YXIgc2xvdEluZGV4ID0gMDsKICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHdvcmtJblByb2dyZXNzMiwgbnVtYmVyT2ZGb3Jrcyk7CiAgICAgICAgICAgIHB1c2hUcmVlSWQod29ya0luUHJvZ3Jlc3MyLCBudW1iZXJPZkZvcmtzLCBzbG90SW5kZXgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRCaXRMZW5ndGgobnVtYmVyNCkgewogICAgICAgICAgcmV0dXJuIDMyIC0gY2x6MzIobnVtYmVyNCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExlYWRpbmdCaXQoaWQpIHsKICAgICAgICAgIHJldHVybiAxIDw8IGdldEJpdExlbmd0aChpZCkgLSAxOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzczIgPT09IHRyZWVGb3JrUHJvdmlkZXIpIHsKICAgICAgICAgICAgdHJlZUZvcmtQcm92aWRlciA9IGZvcmtTdGFja1stLWZvcmtTdGFja0luZGV4XTsKICAgICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICAgIHRyZWVGb3JrQ291bnQgPSBmb3JrU3RhY2tbLS1mb3JrU3RhY2tJbmRleF07CiAgICAgICAgICAgIGZvcmtTdGFja1tmb3JrU3RhY2tJbmRleF0gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzMiA9PT0gdHJlZUNvbnRleHRQcm92aWRlcikgewogICAgICAgICAgICB0cmVlQ29udGV4dFByb3ZpZGVyID0gaWRTdGFja1stLWlkU3RhY2tJbmRleF07CiAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBpZFN0YWNrWy0taWRTdGFja0luZGV4XTsKICAgICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUNvbnRleHRJZCA9IGlkU3RhY2tbLS1pZFN0YWNrSW5kZXhdOwogICAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleF0gPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5kZWRUcmVlQ29udGV4dCgpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgaWYgKHRyZWVDb250ZXh0UHJvdmlkZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBpZDogdHJlZUNvbnRleHRJZCwKICAgICAgICAgICAgICBvdmVyZmxvdzogdHJlZUNvbnRleHRPdmVyZmxvdwogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTdXNwZW5kZWRUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbmRlZENvbnRleHQpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dElkOwogICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dE92ZXJmbG93OwogICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dFByb3ZpZGVyOwogICAgICAgICAgdHJlZUNvbnRleHRJZCA9IHN1c3BlbmRlZENvbnRleHQuaWQ7CiAgICAgICAgICB0cmVlQ29udGV4dE92ZXJmbG93ID0gc3VzcGVuZGVkQ29udGV4dC5vdmVyZmxvdzsKICAgICAgICAgIHRyZWVDb250ZXh0UHJvdmlkZXIgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZk5vdEh5ZHJhdGluZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHRvIGJlIGh5ZHJhdGluZy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gbnVsbDsKICAgICAgICB2YXIgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgdmFyIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFN1c3BlbmRPckVycm9yREVWID0gZmFsc2U7CiAgICAgICAgdmFyIGh5ZHJhdGlvbkVycm9ycyA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gd2FybklmSHlkcmF0aW5nKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNIeWRyYXRpbmcpIHsKICAgICAgICAgICAgICBlcnJvcigiV2Ugc2hvdWxkIG5vdCBiZSBoeWRyYXRpbmcgaGVyZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYSBidWcuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0RpZFRocm93V2hpbGVIeWRyYXRpbmdERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpZFN1c3BlbmRPckVycm9yREVWID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkU3VzcGVuZE9yRXJyb3JXaGlsZUh5ZHJhdGluZ0RFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRpZFN1c3BlbmRPckVycm9yREVWOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnRlckh5ZHJhdGlvblN0YXRlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50SW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZFdpdGhpbkNvbnRhaW5lcihwYXJlbnRJbnN0YW5jZSk7CiAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgaXNIeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICAgIGRpZFN1c3BlbmRPckVycm9yREVWID0gZmFsc2U7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVlbnRlckh5ZHJhdGlvblN0YXRlRnJvbURlaHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKGZpYmVyLCBzdXNwZW5zZUluc3RhbmNlLCB0cmVlQ29udGV4dCkgewogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBudWxsOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICAgIGlmICh0cmVlQ29udGV4dCAhPT0gbnVsbCkgewogICAgICAgICAgICByZXN0b3JlU3VzcGVuZGVkVHJlZUNvbnRleHQoZmliZXIsIHRyZWVDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuVW5oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKHJldHVybkZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihyZXR1cm5GaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbywgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgZGlkTm90SHlkcmF0ZUluc3RhbmNlKAogICAgICAgICAgICAgICAgICByZXR1cm5GaWJlci50eXBlLAogICAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5tZW1vaXplZFByb3BzLAogICAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5zdGF0ZU5vZGUsCiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gcmV0dXJuRmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKHJldHVybkZpYmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgd2FyblVuaHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgaW5zdGFuY2UpOwogICAgICAgICAgdmFyIGNoaWxkVG9EZWxldGUgPSBjcmVhdGVGaWJlckZyb21Ib3N0SW5zdGFuY2VGb3JEZWxldGlvbigpOwogICAgICAgICAgY2hpbGRUb0RlbGV0ZS5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgIGNoaWxkVG9EZWxldGUucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcmV0dXJuRmliZXIuZGVsZXRpb25zOwogICAgICAgICAgaWYgKGRlbGV0aW9ucyA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm5GaWJlci5kZWxldGlvbnMgPSBbY2hpbGRUb0RlbGV0ZV07CiAgICAgICAgICAgIHJldHVybkZpYmVyLmZsYWdzIHw9IENoaWxkRGVsZXRpb247CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkZWxldGlvbnMucHVzaChjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk5vbmh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kT3JFcnJvckRFVikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzd2l0Y2ggKHJldHVybkZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHZhciBwYXJlbnRDb250YWluZXIgPSByZXR1cm5GaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICAgICAgICB2YXIgdGV4dCA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIHRleHQpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIHBhcmVudFR5cGUgPSByZXR1cm5GaWJlci50eXBlOwogICAgICAgICAgICAgICAgdmFyIHBhcmVudFByb3BzID0gcmV0dXJuRmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgIHZhciBwYXJlbnRJbnN0YW5jZSA9IHJldHVybkZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgICAgIHZhciBfdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9wcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFR5cGUsCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRQcm9wcywKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgICAgX3R5cGUsCiAgICAgICAgICAgICAgICAgICAgICBfcHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICAgICAgaXNDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgICAgICAgIHZhciBfdGV4dCA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgX2lzQ29uY3VycmVudE1vZGUgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50VHlwZSwKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICBfdGV4dCwKICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgICBfaXNDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHJldHVybkZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgX3BhcmVudEluc3RhbmNlID0gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgICAgaWYgKF9wYXJlbnRJbnN0YW5jZSAhPT0gbnVsbCkgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgIHZhciBfdHlwZTIgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgICAgICAgIHZhciBfcHJvcHMyID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKF9wYXJlbnRJbnN0YW5jZSwgX3R5cGUyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICAgICAgICB2YXIgX3RleHQyID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShfcGFyZW50SW5zdGFuY2UsIF90ZXh0Mik7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnNlcnROb25IeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBmaWJlcikgewogICAgICAgICAgZmliZXIuZmxhZ3MgPSBmaWJlci5mbGFncyAmIH5IeWRyYXRpbmcgfCBQbGFjZW1lbnQ7CiAgICAgICAgICB3YXJuTm9uaHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gY2FuSHlkcmF0ZUluc3RhbmNlKG5leHRJbnN0YW5jZSwgdHlwZSk7CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGQoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgdmFyIHRleHQgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIHRleHRJbnN0YW5jZSA9IGNhbkh5ZHJhdGVUZXh0SW5zdGFuY2UobmV4dEluc3RhbmNlLCB0ZXh0KTsKICAgICAgICAgICAgICBpZiAodGV4dEluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSB0ZXh0SW5zdGFuY2U7CiAgICAgICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VJbnN0YW5jZSA9IGNhbkh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlSW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gewogICAgICAgICAgICAgICAgICBkZWh5ZHJhdGVkOiBzdXNwZW5zZUluc3RhbmNlLAogICAgICAgICAgICAgICAgICB0cmVlQ29udGV4dDogZ2V0U3VzcGVuZGVkVHJlZUNvbnRleHQoKSwKICAgICAgICAgICAgICAgICAgcmV0cnlMYW5lOiBPZmZzY3JlZW5MYW5lCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRTdGF0ZSA9IHN1c3BlbnNlU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgZGVoeWRyYXRlZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRGVoeWRyYXRlZEZyYWdtZW50KHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgZGVoeWRyYXRlZEZyYWdtZW50LnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgICAgZmliZXIuY2hpbGQgPSBkZWh5ZHJhdGVkRnJhZ21lbnQ7CiAgICAgICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDbGllbnRSZW5kZXJPbk1pc21hdGNoKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gKGZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSAmJiAoZmliZXIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFnczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKGZpYmVyKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkh5ZHJhdGlvbiBmYWlsZWQgYmVjYXVzZSB0aGUgaW5pdGlhbCBVSSBkb2VzIG5vdCBtYXRjaCB3aGF0IHdhcyByZW5kZXJlZCBvbiB0aGUgc2VydmVyLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dEluc3RhbmNlID0gbmV4dEh5ZHJhdGFibGVJbnN0YW5jZTsKICAgICAgICAgIGlmICghbmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDbGllbnRSZW5kZXJPbk1pc21hdGNoKGZpYmVyKSkgewogICAgICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zZXJ0Tm9uSHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmlyc3RBdHRlbXB0ZWRJbnN0YW5jZSA9IG5leHRJbnN0YW5jZTsKICAgICAgICAgIGlmICghdHJ5SHlkcmF0ZShmaWJlciwgbmV4dEluc3RhbmNlKSkgewogICAgICAgICAgICBpZiAoc2hvdWxkQ2xpZW50UmVuZGVyT25NaXNtYXRjaChmaWJlcikpIHsKICAgICAgICAgICAgICB3YXJuTm9uaHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICAgIHRocm93T25IeWRyYXRpb25NaXNtYXRjaCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhmaXJzdEF0dGVtcHRlZEluc3RhbmNlKTsKICAgICAgICAgICAgdmFyIHByZXZIeWRyYXRpb25QYXJlbnRGaWJlciA9IGh5ZHJhdGlvblBhcmVudEZpYmVyOwogICAgICAgICAgICBpZiAoIW5leHRJbnN0YW5jZSB8fCAhdHJ5SHlkcmF0ZShmaWJlciwgbmV4dEluc3RhbmNlKSkgewogICAgICAgICAgICAgIGluc2VydE5vbkh5ZHJhdGVkSW5zdGFuY2UoaHlkcmF0aW9uUGFyZW50RmliZXIsIGZpYmVyKTsKICAgICAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlbGV0ZUh5ZHJhdGFibGVJbnN0YW5jZShwcmV2SHlkcmF0aW9uUGFyZW50RmliZXIsIGZpcnN0QXR0ZW1wdGVkSW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlKGZpYmVyLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0KSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICB2YXIgc2hvdWxkV2FybklmTWlzbWF0Y2hEZXYgPSAhZGlkU3VzcGVuZE9yRXJyb3JERVY7CiAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IGh5ZHJhdGVJbnN0YW5jZShpbnN0YW5jZSwgZmliZXIudHlwZSwgZmliZXIubWVtb2l6ZWRQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgZmliZXIsIHNob3VsZFdhcm5JZk1pc21hdGNoRGV2KTsKICAgICAgICAgIGZpYmVyLnVwZGF0ZVF1ZXVlID0gdXBkYXRlUGF5bG9hZDsKICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9IeWRyYXRlSG9zdFRleHRJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHRleHRJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciB0ZXh0Q29udGVudCA9IGZpYmVyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gaHlkcmF0ZVRleHRJbnN0YW5jZSh0ZXh0SW5zdGFuY2UsIHRleHRDb250ZW50LCBmaWJlcik7CiAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGh5ZHJhdGlvblBhcmVudEZpYmVyOwogICAgICAgICAgICBpZiAocmV0dXJuRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHJldHVybkZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50Q29udGFpbmVyID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgZGlkTm90TWF0Y2hIeWRyYXRlZENvbnRhaW5lclRleHRJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgICBwYXJlbnRDb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgdGV4dEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgIHRleHRDb250ZW50LAogICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgaXNDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50VHlwZSA9IHJldHVybkZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRQcm9wcyA9IHJldHVybkZpYmVyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRJbnN0YW5jZSA9IHJldHVybkZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgdmFyIF9pc0NvbmN1cnJlbnRNb2RlMiA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgIGRpZE5vdE1hdGNoSHlkcmF0ZWRUZXh0SW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgICAgcGFyZW50VHlwZSwKICAgICAgICAgICAgICAgICAgICBwYXJlbnRQcm9wcywKICAgICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICB0ZXh0SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgdGV4dENvbnRlbnQsCiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICBfaXNDb25jdXJyZW50TW9kZTIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9IeWRyYXRlSG9zdFN1c3BlbnNlSW5zdGFuY2UoZmliZXIpIHsKICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gZmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCA/IHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCA6IG51bGw7CiAgICAgICAgICBpZiAoIXN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBoYXZlIGEgaHlkcmF0ZWQgc3VzcGVuc2UgaW5zdGFuY2UuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICBoeWRyYXRlU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNraXBQYXN0RGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIpIHsKICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gZmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCA/IHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCA6IG51bGw7CiAgICAgICAgICBpZiAoIXN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBoYXZlIGEgaHlkcmF0ZWQgc3VzcGVuc2UgaW5zdGFuY2UuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGVJbnN0YW5jZUFmdGVyU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wVG9OZXh0SG9zdFBhcmVudChmaWJlcikgewogICAgICAgICAgdmFyIHBhcmVudCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIHdoaWxlIChwYXJlbnQgIT09IG51bGwgJiYgcGFyZW50LnRhZyAhPT0gSG9zdENvbXBvbmVudCAmJiBwYXJlbnQudGFnICE9PSBIb3N0Um9vdCAmJiBwYXJlbnQudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBwYXJlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcEh5ZHJhdGlvblN0YXRlKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIgIT09IGh5ZHJhdGlvblBhcmVudEZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNIeWRyYXRpbmcpIHsKICAgICAgICAgICAgcG9wVG9OZXh0SG9zdFBhcmVudChmaWJlcik7CiAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gSG9zdFJvb3QgJiYgKGZpYmVyLnRhZyAhPT0gSG9zdENvbXBvbmVudCB8fCBzaG91bGREZWxldGVVbmh5ZHJhdGVkVGFpbEluc3RhbmNlcyhmaWJlci50eXBlKSAmJiAhc2hvdWxkU2V0VGV4dENvbnRlbnQoZmliZXIudHlwZSwgZmliZXIubWVtb2l6ZWRQcm9wcykpKSB7CiAgICAgICAgICAgIHZhciBuZXh0SW5zdGFuY2UgPSBuZXh0SHlkcmF0YWJsZUluc3RhbmNlOwogICAgICAgICAgICBpZiAobmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgaWYgKHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpKSB7CiAgICAgICAgICAgICAgICB3YXJuSWZVbmh5ZHJhdGVkVGFpbE5vZGVzKGZpYmVyKTsKICAgICAgICAgICAgICAgIHRocm93T25IeWRyYXRpb25NaXNtYXRjaCgpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB3aGlsZSAobmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZUh5ZHJhdGFibGVJbnN0YW5jZShmaWJlciwgbmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgbmV4dEluc3RhbmNlID0gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKTsKICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBza2lwUGFzdERlaHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKGZpYmVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBoeWRyYXRpb25QYXJlbnRGaWJlciA/IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhmaWJlci5zdGF0ZU5vZGUpIDogbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNVbmh5ZHJhdGVkVGFpbE5vZGVzKCkgewogICAgICAgICAgcmV0dXJuIGlzSHlkcmF0aW5nICYmIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgIT09IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlVuaHlkcmF0ZWRUYWlsTm9kZXMoZmliZXIpIHsKICAgICAgICAgIHZhciBuZXh0SW5zdGFuY2UgPSBuZXh0SHlkcmF0YWJsZUluc3RhbmNlOwogICAgICAgICAgd2hpbGUgKG5leHRJbnN0YW5jZSkgewogICAgICAgICAgICB3YXJuVW5oeWRyYXRlZEluc3RhbmNlKGZpYmVyLCBuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICBuZXh0SW5zdGFuY2UgPSBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcobmV4dEluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRIeWRyYXRpb25TdGF0ZSgpIHsKICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gbnVsbDsKICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICAgIGRpZFN1c3BlbmRPckVycm9yREVWID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZ3JhZGVIeWRyYXRpb25FcnJvcnNUb1JlY292ZXJhYmxlKCkgewogICAgICAgICAgaWYgKGh5ZHJhdGlvbkVycm9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZVJlY292ZXJhYmxlRXJyb3JzKGh5ZHJhdGlvbkVycm9ycyk7CiAgICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldElzSHlkcmF0aW5nKCkgewogICAgICAgICAgcmV0dXJuIGlzSHlkcmF0aW5nOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZUh5ZHJhdGlvbkVycm9yKGVycm9yMikgewogICAgICAgICAgaWYgKGh5ZHJhdGlvbkVycm9ycyA9PT0gbnVsbCkgewogICAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBbZXJyb3IyXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycy5wdXNoKGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QmF0Y2hDb25maWc7CiAgICAgICAgdmFyIE5vVHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEN1cnJlbnRUcmFuc2l0aW9uKCkgewogICAgICAgICAgcmV0dXJuIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDEudHJhbnNpdGlvbjsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzID0gewogICAgICAgICAgcmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3M6IGZ1bmN0aW9uKGZpYmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgfSwKICAgICAgICAgIGZsdXNoUGVuZGluZ1Vuc2FmZUxpZmVjeWNsZVdhcm5pbmdzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0sCiAgICAgICAgICByZWNvcmRMZWdhY3lDb250ZXh0V2FybmluZzogZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB9LAogICAgICAgICAgZmx1c2hMZWdhY3lDb250ZXh0V2FybmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICB9LAogICAgICAgICAgZGlzY2FyZFBlbmRpbmdXYXJuaW5nczogZnVuY3Rpb24oKSB7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICB2YXIgZmluZFN0cmljdFJvb3QgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICB2YXIgbWF5YmVTdHJpY3RSb290ID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgbWF5YmVTdHJpY3RSb290ID0gbm9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXliZVN0cmljdFJvb3Q7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHNldFRvU29ydGVkU3RyaW5nID0gZnVuY3Rpb24oc2V0NCkgewogICAgICAgICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgICAgICAgc2V0NC5mb3JFYWNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgYXJyYXkucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gYXJyYXkuc29ydCgpLmpvaW4oIiwgIik7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZFVuc2FmZUxpZmVjeWNsZVdhcm5pbmdzID0gZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmhhcyhmaWJlci50eXBlKSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiAmJiAvLyBEb24ndCB3YXJuIGFib3V0IHJlYWN0LWxpZmVjeWNsZXMtY29tcGF0IHBvbHlmaWxsZWQgY29tcG9uZW50cy4KICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50Ll9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlICYmIHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcy5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlICYmIHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIHNvcnRlZE5hbWVzID0gc2V0VG9Tb3J0ZWRTdHJpbmcoVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCBpbiBzdHJpY3QgbW9kZSBpcyBub3QgcmVjb21tZW5kZWQgYW5kIG1heSBpbmRpY2F0ZSBidWdzIGluIHlvdXIgY29kZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBjb2RlIHdpdGggc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZE1vdW50LCBhbmQgc2V0IGluaXRpYWwgc3RhdGUgaW4gdGhlIGNvbnN0cnVjdG9yLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBzb3J0ZWROYW1lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzID0gc2V0VG9Tb3J0ZWRTdHJpbmcoVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgZXJyb3IoIlVzaW5nIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIGluIHN0cmljdCBtb2RlIGlzIG5vdCByZWNvbW1lbmRlZCBhbmQgbWF5IGluZGljYXRlIGJ1Z3MgaW4geW91ciBjb2RlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGRhdGEgZmV0Y2hpbmcgY29kZSBvciBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkVXBkYXRlLlxuKiBJZiB5b3UncmUgdXBkYXRpbmcgc3RhdGUgd2hlbmV2ZXIgcHJvcHMgY2hhbmdlLCByZWZhY3RvciB5b3VyIGNvZGUgdG8gdXNlIG1lbW9pemF0aW9uIHRlY2huaXF1ZXMgb3IgbW92ZSBpdCB0byBzdGF0aWMgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBMZWFybiBtb3JlIGF0OiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZGVyaXZlZC1zdGF0ZVxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBfc29ydGVkTmFtZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczIgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgaW4gc3RyaWN0IG1vZGUgaXMgbm90IHJlY29tbWVuZGVkIGFuZCBtYXkgaW5kaWNhdGUgYnVncyBpbiB5b3VyIGNvZGUuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXMzID0gc2V0VG9Tb3J0ZWRTdHJpbmcoY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIHdhcm4zKCJjb21wb25lbnRXaWxsTW91bnQgaGFzIGJlZW4gcmVuYW1lZCwgYW5kIGlzIG5vdCByZWNvbW1lbmRlZCBmb3IgdXNlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGNvZGUgd2l0aCBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkTW91bnQsIGFuZCBzZXQgaW5pdGlhbCBzdGF0ZSBpbiB0aGUgY29uc3RydWN0b3IuXG4qIFJlbmFtZSBjb21wb25lbnRXaWxsTW91bnQgdG8gVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCB0byBzdXBwcmVzcyB0aGlzIHdhcm5pbmcgaW4gbm9uLXN0cmljdCBtb2RlLiBJbiBSZWFjdCAxOC54LCBvbmx5IHRoZSBVTlNBRkVfIG5hbWUgd2lsbCB3b3JrLiBUbyByZW5hbWUgYWxsIGRlcHJlY2F0ZWQgbGlmZWN5Y2xlcyB0byB0aGVpciBuZXcgbmFtZXMsIHlvdSBjYW4gcnVuIGBucHggcmVhY3QtY29kZW1vZCByZW5hbWUtdW5zYWZlLWxpZmVjeWNsZXNgIGluIHlvdXIgcHJvamVjdCBzb3VyY2UgZm9sZGVyLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBfc29ydGVkTmFtZXMzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczQgPSBzZXRUb1NvcnRlZFN0cmluZyhjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIHdhcm4zKCJjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIGhhcyBiZWVuIHJlbmFtZWQsIGFuZCBpcyBub3QgcmVjb21tZW5kZWQgZm9yIHVzZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cbiogSWYgeW91J3JlIHVwZGF0aW5nIHN0YXRlIHdoZW5ldmVyIHByb3BzIGNoYW5nZSwgcmVmYWN0b3IgeW91ciBjb2RlIHRvIHVzZSBtZW1vaXphdGlvbiB0ZWNobmlxdWVzIG9yIG1vdmUgaXQgdG8gc3RhdGljIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gTGVhcm4gbW9yZSBhdDogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Rlcml2ZWQtc3RhdGVcbiogUmVuYW1lIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgdG8gVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgdG8gc3VwcHJlc3MgdGhpcyB3YXJuaW5nIGluIG5vbi1zdHJpY3QgbW9kZS4gSW4gUmVhY3QgMTgueCwgb25seSB0aGUgVU5TQUZFXyBuYW1lIHdpbGwgd29yay4gVG8gcmVuYW1lIGFsbCBkZXByZWNhdGVkIGxpZmVjeWNsZXMgdG8gdGhlaXIgbmV3IG5hbWVzLCB5b3UgY2FuIHJ1biBgbnB4IHJlYWN0LWNvZGVtb2QgcmVuYW1lLXVuc2FmZS1saWZlY3ljbGVzYCBpbiB5b3VyIHByb2plY3Qgc291cmNlIGZvbGRlci5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzNCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXM1ID0gc2V0VG9Tb3J0ZWRTdHJpbmcoY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICB3YXJuMygiY29tcG9uZW50V2lsbFVwZGF0ZSBoYXMgYmVlbiByZW5hbWVkLCBhbmQgaXMgbm90IHJlY29tbWVuZGVkIGZvciB1c2UuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG4qIFJlbmFtZSBjb21wb25lbnRXaWxsVXBkYXRlIHRvIFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlIHRvIHN1cHByZXNzIHRoaXMgd2FybmluZyBpbiBub24tc3RyaWN0IG1vZGUuIEluIFJlYWN0IDE4LngsIG9ubHkgdGhlIFVOU0FGRV8gbmFtZSB3aWxsIHdvcmsuIFRvIHJlbmFtZSBhbGwgZGVwcmVjYXRlZCBsaWZlY3ljbGVzIHRvIHRoZWlyIG5ldyBuYW1lcywgeW91IGNhbiBydW4gYG5weCByZWFjdC1jb2RlbW9kIHJlbmFtZS11bnNhZmUtbGlmZWN5Y2xlc2AgaW4geW91ciBwcm9qZWN0IHNvdXJjZSBmb2xkZXIuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgICB2YXIgZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRMZWdhY3lDb250ZXh0V2FybmluZyA9IGZ1bmN0aW9uKGZpYmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgICB2YXIgc3RyaWN0Um9vdCA9IGZpbmRTdHJpY3RSb290KGZpYmVyKTsKICAgICAgICAgICAgaWYgKHN0cmljdFJvb3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdG8gZmluZCBhIFN0cmljdE1vZGUgY29tcG9uZW50IGluIGEgc3RyaWN0IG1vZGUgdHJlZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQuaGFzKGZpYmVyLnR5cGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB3YXJuaW5nc0ZvclJvb3QgPSBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcuZ2V0KHN0cmljdFJvb3QpOwogICAgICAgICAgICBpZiAoZmliZXIudHlwZS5jb250ZXh0VHlwZXMgIT0gbnVsbCB8fCBmaWJlci50eXBlLmNoaWxkQ29udGV4dFR5cGVzICE9IG51bGwgfHwgaW5zdGFuY2UgIT09IG51bGwgJiYgdHlwZW9mIGluc3RhbmNlLmdldENoaWxkQ29udGV4dCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh3YXJuaW5nc0ZvclJvb3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgd2FybmluZ3NGb3JSb290ID0gW107CiAgICAgICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcuc2V0KHN0cmljdFJvb3QsIHdhcm5pbmdzRm9yUm9vdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5pbmdzRm9yUm9vdC5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmZsdXNoTGVnYWN5Q29udGV4dFdhcm5pbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nLmZvckVhY2goZnVuY3Rpb24oZmliZXJBcnJheSwgc3RyaWN0Um9vdCkgewogICAgICAgICAgICAgIGlmIChmaWJlckFycmF5Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZmlyc3RGaWJlciA9IGZpYmVyQXJyYXlbMF07CiAgICAgICAgICAgICAgdmFyIHVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICBmaWJlckFycmF5LmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIHVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0LmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB2YXIgc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyh1bmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaXJzdEZpYmVyKTsKICAgICAgICAgICAgICAgIGVycm9yKCJMZWdhY3kgY29udGV4dCBBUEkgaGFzIGJlZW4gZGV0ZWN0ZWQgd2l0aGluIGEgc3RyaWN0LW1vZGUgdHJlZS5cblxuVGhlIG9sZCBBUEkgd2lsbCBiZSBzdXBwb3J0ZWQgaW4gYWxsIDE2LnggcmVsZWFzZXMsIGJ1dCBhcHBsaWNhdGlvbnMgdXNpbmcgaXQgc2hvdWxkIG1pZ3JhdGUgdG8gdGhlIG5ldyB2ZXJzaW9uLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXNcblxuTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2xlZ2FjeS1jb250ZXh0Iiwgc29ydGVkTmFtZXMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZGlzY2FyZFBlbmRpbmdXYXJuaW5ncyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNYXBzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRHZW5lcmF0b3JzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzOwogICAgICAgIHZhciBvd25lckhhc0tleVVzZVdhcm5pbmc7CiAgICAgICAgdmFyIG93bmVySGFzRnVuY3Rpb25UeXBlV2FybmluZzsKICAgICAgICB2YXIgd2FybkZvck1pc3NpbmdLZXkgPSBmdW5jdGlvbihjaGlsZCwgcmV0dXJuRmliZXIpIHsKICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dE1hcHMgPSBmYWxzZTsKICAgICAgICAgIGRpZFdhcm5BYm91dEdlbmVyYXRvcnMgPSBmYWxzZTsKICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnMgPSB7fTsKICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZyA9IHt9OwogICAgICAgICAgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nID0ge307CiAgICAgICAgICB3YXJuRm9yTWlzc2luZ0tleSA9IGZ1bmN0aW9uKGNoaWxkLCByZXR1cm5GaWJlcikgewogICAgICAgICAgICBpZiAoY2hpbGQgPT09IG51bGwgfHwgdHlwZW9mIGNoaWxkICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWNoaWxkLl9zdG9yZSB8fCBjaGlsZC5fc3RvcmUudmFsaWRhdGVkIHx8IGNoaWxkLmtleSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2hpbGQuX3N0b3JlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVhY3QgQ29tcG9uZW50IGluIHdhcm5Gb3JNaXNzaW5nS2V5IHNob3VsZCBoYXZlIGEgX3N0b3JlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNoaWxkLl9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIocmV0dXJuRmliZXIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICBpZiAob3duZXJIYXNLZXlVc2VXYXJuaW5nW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZ1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dhcm5pbmcta2V5cyBmb3IgbW9yZSBpbmZvcm1hdGlvbi4nKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVhY3RDbGFzcyh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5wcm90b3R5cGUgJiYgdHlwZS5wcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50NCwgZWxlbWVudCkgewogICAgICAgICAgdmFyIG1peGVkUmVmID0gZWxlbWVudC5yZWY7CiAgICAgICAgICBpZiAobWl4ZWRSZWYgIT09IG51bGwgJiYgdHlwZW9mIG1peGVkUmVmICE9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBtaXhlZFJlZiAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICgocmV0dXJuRmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgfHwgd2FybkFib3V0U3RyaW5nUmVmcykgJiYgLy8gV2Ugd2FybiBpbiBSZWFjdEVsZW1lbnQuanMgaWYgb3duZXIgYW5kIHNlbGYgYXJlIGVxdWFsIGZvciBzdHJpbmcgcmVmcwogICAgICAgICAgICAgIC8vIGJlY2F1c2UgdGhlc2UgY2Fubm90IGJlIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIGFuIGFycm93IGZ1bmN0aW9uCiAgICAgICAgICAgICAgLy8gdXNpbmcgYSBjb2RlbW9kLiBUaGVyZWZvcmUsIHdlIGRvbid0IGhhdmUgdG8gd2FybiBhYm91dCBzdHJpbmcgcmVmcyBhZ2Fpbi4KICAgICAgICAgICAgICAhKGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX3NlbGYgJiYgZWxlbWVudC5fb3duZXIuc3RhdGVOb2RlICE9PSBlbGVtZW50Ll9zZWxmKSAmJiAvLyBXaWxsIGFscmVhZHkgdGhyb3cgd2l0aCAiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgaGF2ZSBzdHJpbmcgcmVmcyIKICAgICAgICAgICAgICAhKGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyLnRhZyAhPT0gQ2xhc3NDb21wb25lbnQpICYmIC8vIFdpbGwgYWxyZWFkeSB3YXJuIHdpdGggIkZ1bmN0aW9uIGNvbXBvbmVudHMgY2Fubm90IGJlIGdpdmVuIHJlZnMiCiAgICAgICAgICAgICAgISh0eXBlb2YgZWxlbWVudC50eXBlID09PSAiZnVuY3Rpb24iICYmICFpc1JlYWN0Q2xhc3MoZWxlbWVudC50eXBlKSkgJiYgLy8gV2lsbCBhbHJlYWR5IHRocm93IHdpdGggIkVsZW1lbnQgcmVmIHdhcyBzcGVjaWZpZWQgYXMgYSBzdHJpbmcgKHNvbWVTdHJpbmdSZWYpIGJ1dCBubyBvd25lciB3YXMgc2V0IgogICAgICAgICAgICAgIGVsZW1lbnQuX293bmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIocmV0dXJuRmliZXIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcignQ29tcG9uZW50ICIlcyIgY29udGFpbnMgdGhlIHN0cmluZyByZWYgIiVzIi4gU3VwcG9ydCBmb3Igc3RyaW5nIHJlZnMgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFdlIHJlY29tbWVuZCB1c2luZyB1c2VSZWYoKSBvciBjcmVhdGVSZWYoKSBpbnN0ZWFkLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1zdHJpbmctcmVmJywgY29tcG9uZW50TmFtZSwgbWl4ZWRSZWYpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgaW5zdDsKICAgICAgICAgICAgICBpZiAob3duZXIpIHsKICAgICAgICAgICAgICAgIHZhciBvd25lckZpYmVyID0gb3duZXI7CiAgICAgICAgICAgICAgICBpZiAob3duZXJGaWJlci50YWcgIT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgaGF2ZSBzdHJpbmcgcmVmcy4gV2UgcmVjb21tZW5kIHVzaW5nIHVzZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluc3QgPSBvd25lckZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFpbnN0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1pc3Npbmcgb3duZXIgZm9yIHN0cmluZyByZWYgIiArIG1peGVkUmVmICsgIi4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlc29sdmVkSW5zdCA9IGluc3Q7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wU3RyaW5nQ29lcmNpb24obWl4ZWRSZWYsICJyZWYiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHN0cmluZ1JlZiA9ICIiICsgbWl4ZWRSZWY7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0LnJlZiAhPT0gbnVsbCAmJiB0eXBlb2YgY3VycmVudDQucmVmID09PSAiZnVuY3Rpb24iICYmIGN1cnJlbnQ0LnJlZi5fc3RyaW5nUmVmID09PSBzdHJpbmdSZWYpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50NC5yZWY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciByZWYgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIHJlZnMgPSByZXNvbHZlZEluc3QucmVmczsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZWxldGUgcmVmc1tzdHJpbmdSZWZdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmVmc1tzdHJpbmdSZWZdID0gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICByZWYuX3N0cmluZ1JlZiA9IHN0cmluZ1JlZjsKICAgICAgICAgICAgICByZXR1cm4gcmVmOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbWl4ZWRSZWYgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHJlZiB0byBiZSBhIGZ1bmN0aW9uLCBhIHN0cmluZywgYW4gb2JqZWN0IHJldHVybmVkIGJ5IFJlYWN0LmNyZWF0ZVJlZigpLCBvciBudWxsLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWVsZW1lbnQuX293bmVyKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkVsZW1lbnQgcmVmIHdhcyBzcGVjaWZpZWQgYXMgYSBzdHJpbmcgKCIgKyBtaXhlZFJlZiArICIpIGJ1dCBubyBvd25lciB3YXMgc2V0LiBUaGlzIGNvdWxkIGhhcHBlbiBmb3Igb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVhc29uczpcbjEuIFlvdSBtYXkgYmUgYWRkaW5nIGEgcmVmIHRvIGEgZnVuY3Rpb24gY29tcG9uZW50XG4yLiBZb3UgbWF5IGJlIGFkZGluZyBhIHJlZiB0byBhIGNvbXBvbmVudCB0aGF0IHdhcyBub3QgY3JlYXRlZCBpbnNpZGUgYSBjb21wb25lbnQncyByZW5kZXIgbWV0aG9kXG4zLiBZb3UgaGF2ZSBtdWx0aXBsZSBjb3BpZXMgb2YgUmVhY3QgbG9hZGVkXG5TZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlZnMtbXVzdC1oYXZlLW93bmVyIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1peGVkUmVmOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKSB7CiAgICAgICAgICB2YXIgY2hpbGRTdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobmV3Q2hpbGQpOwogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPYmplY3RzIGFyZSBub3QgdmFsaWQgYXMgYSBSZWFjdCBjaGlsZCAoZm91bmQ6ICIgKyAoY2hpbGRTdHJpbmcgPT09ICJbb2JqZWN0IE9iamVjdF0iID8gIm9iamVjdCB3aXRoIGtleXMgeyIgKyBPYmplY3Qua2V5cyhuZXdDaGlsZCkuam9pbigiLCAiKSArICJ9IiA6IGNoaWxkU3RyaW5nKSArICIpLiBJZiB5b3UgbWVhbnQgdG8gcmVuZGVyIGEgY29sbGVjdGlvbiBvZiBjaGlsZHJlbiwgdXNlIGFuIGFycmF5IGluc3RlYWQuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5PbkZ1bmN0aW9uVHlwZShyZXR1cm5GaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIocmV0dXJuRmliZXIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICBpZiAob3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG93bmVySGFzRnVuY3Rpb25UeXBlV2FybmluZ1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJGdW5jdGlvbnMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkLiBUaGlzIG1heSBoYXBwZW4gaWYgeW91IHJldHVybiBhIENvbXBvbmVudCBpbnN0ZWFkIG9mIDxDb21wb25lbnQgLz4gZnJvbSByZW5kZXIuIE9yIG1heWJlIHlvdSBtZWFudCB0byBjYWxsIHRoaXMgZnVuY3Rpb24gcmF0aGVyIHRoYW4gcmV0dXJuIGl0LiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlTGF6eShsYXp5VHlwZSkgewogICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5VHlwZS5fcGF5bG9hZDsKICAgICAgICAgIHZhciBpbml0ID0gbGF6eVR5cGUuX2luaXQ7CiAgICAgICAgICByZXR1cm4gaW5pdChwYXlsb2FkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gQ2hpbGRSZWNvbmNpbGVyKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgIGZ1bmN0aW9uIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZFRvRGVsZXRlKSB7CiAgICAgICAgICAgIGlmICghc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcmV0dXJuRmliZXIuZGVsZXRpb25zOwogICAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gW2NoaWxkVG9EZWxldGVdOwogICAgICAgICAgICAgIHJldHVybkZpYmVyLmZsYWdzIHw9IENoaWxkRGVsZXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGVsZXRpb25zLnB1c2goY2hpbGRUb0RlbGV0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCkgewogICAgICAgICAgICBpZiAoIXNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoY2hpbGRUb0RlbGV0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgICBjaGlsZFRvRGVsZXRlID0gY2hpbGRUb0RlbGV0ZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKSB7CiAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGQgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgd2hpbGUgKGV4aXN0aW5nQ2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdDaGlsZC5rZXkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uc2V0KGV4aXN0aW5nQ2hpbGQua2V5LCBleGlzdGluZ0NoaWxkKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5zZXQoZXhpc3RpbmdDaGlsZC5pbmRleCwgZXhpc3RpbmdDaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGQgPSBleGlzdGluZ0NoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nQ2hpbGRyZW47CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1c2VGaWJlcihmaWJlciwgcGVuZGluZ1Byb3BzKSB7CiAgICAgICAgICAgIHZhciBjbG9uZSA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGZpYmVyLCBwZW5kaW5nUHJvcHMpOwogICAgICAgICAgICBjbG9uZS5pbmRleCA9IDA7CiAgICAgICAgICAgIGNsb25lLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICByZXR1cm4gY2xvbmU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0luZGV4KSB7CiAgICAgICAgICAgIG5ld0ZpYmVyLmluZGV4ID0gbmV3SW5kZXg7CiAgICAgICAgICAgIGlmICghc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IEZvcmtlZDsKICAgICAgICAgICAgICByZXR1cm4gbGFzdFBsYWNlZEluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IG5ld0ZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG9sZEluZGV4ID0gY3VycmVudDQuaW5kZXg7CiAgICAgICAgICAgICAgaWYgKG9sZEluZGV4IDwgbGFzdFBsYWNlZEluZGV4KSB7CiAgICAgICAgICAgICAgICBuZXdGaWJlci5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgICAgICByZXR1cm4gbGFzdFBsYWNlZEluZGV4OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb2xkSW5kZXg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgICByZXR1cm4gbGFzdFBsYWNlZEluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwbGFjZVNpbmdsZUNoaWxkKG5ld0ZpYmVyKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzICYmIG5ld0ZpYmVyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3RmliZXI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgY3VycmVudDQsIHRleHRDb250ZW50LCBsYW5lcykgewogICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwgfHwgY3VycmVudDQudGFnICE9PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tVGV4dCh0ZXh0Q29udGVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDQsIHRleHRDb250ZW50KTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUVsZW1lbnQocmV0dXJuRmliZXIsIGN1cnJlbnQ0LCBlbGVtZW50LCBsYW5lcykgewogICAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgIGlmIChlbGVtZW50VHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudDIocmV0dXJuRmliZXIsIGN1cnJlbnQ0LCBlbGVtZW50LnByb3BzLmNoaWxkcmVuLCBsYW5lcywgZWxlbWVudC5rZXkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjdXJyZW50NC5lbGVtZW50VHlwZSA9PT0gZWxlbWVudFR5cGUgfHwgLy8gS2VlcCB0aGlzIGNoZWNrIGlubGluZSBzbyBpdCBvbmx5IHJ1bnMgb24gdGhlIGZhbHNlIHBhdGg6CiAgICAgICAgICAgICAgaXNDb21wYXRpYmxlRmFtaWx5Rm9ySG90UmVsb2FkaW5nKGN1cnJlbnQ0LCBlbGVtZW50KSB8fCAvLyBMYXp5IHR5cGVzIHNob3VsZCByZWNvbmNpbGUgdGhlaXIgcmVzb2x2ZWQgdHlwZS4KICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIGRvIHRoaXMgYWZ0ZXIgdGhlIEhvdCBSZWxvYWRpbmcgY2hlY2sgYWJvdmUsCiAgICAgICAgICAgICAgLy8gYmVjYXVzZSBob3QgcmVsb2FkaW5nIGhhcyBkaWZmZXJlbnQgc2VtYW50aWNzIHRoYW4gcHJvZCBiZWNhdXNlCiAgICAgICAgICAgICAgLy8gaXQgZG9lc24ndCByZXN1c3BlbmQuIFNvIHdlIGNhbid0IGxldCB0aGUgY2FsbCBiZWxvdyBzdXNwZW5kLgogICAgICAgICAgICAgIHR5cGVvZiBlbGVtZW50VHlwZSA9PT0gIm9iamVjdCIgJiYgZWxlbWVudFR5cGUgIT09IG51bGwgJiYgZWxlbWVudFR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSAmJiByZXNvbHZlTGF6eShlbGVtZW50VHlwZSkgPT09IGN1cnJlbnQ0LnR5cGUpIHsKICAgICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQ0LCBlbGVtZW50LnByb3BzKTsKICAgICAgICAgICAgICAgIGV4aXN0aW5nLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgY3VycmVudDQsIGVsZW1lbnQpOwogICAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KGVsZW1lbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgY3JlYXRlZC5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnQ0LCBlbGVtZW50KTsKICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVQb3J0YWwocmV0dXJuRmliZXIsIGN1cnJlbnQ0LCBwb3J0YWwsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC50YWcgIT09IEhvc3RQb3J0YWwgfHwgY3VycmVudDQuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8gIT09IHBvcnRhbC5jb250YWluZXJJbmZvIHx8IGN1cnJlbnQ0LnN0YXRlTm9kZS5pbXBsZW1lbnRhdGlvbiAhPT0gcG9ydGFsLmltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwocG9ydGFsLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50NCwgcG9ydGFsLmNoaWxkcmVuIHx8IFtdKTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgY3VycmVudDQsIGZyYWdtZW50LCBsYW5lcywga2V5KSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC50YWcgIT09IEZyYWdtZW50OSkgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZnJhZ21lbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDQsIGZyYWdtZW50KTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVRleHQoIiIgKyBuZXdDaGlsZCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5ld0NoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgbnVsbCwgbmV3Q2hpbGQpOwogICAgICAgICAgICAgICAgICBfY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQyID0gY3JlYXRlRmliZXJGcm9tUG9ydGFsKG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkMi5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVDaGlsZChyZXR1cm5GaWJlciwgaW5pdChwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNBcnJheTIobmV3Q2hpbGQpIHx8IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQzID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQobmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzLCBudWxsKTsKICAgICAgICAgICAgICAgIF9jcmVhdGVkMy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGtleSA9IG9sZEZpYmVyICE9PSBudWxsID8gb2xkRmliZXIua2V5IDogbnVsbDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAoa2V5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBvbGRGaWJlciwgIiIgKyBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0NoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVsZW1lbnQocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXdDaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWwocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIGluaXQocGF5bG9hZCksIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgaWYgKGtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudDIocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHZhciBtYXRjaGVkRmliZXIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdJZHgpIHx8IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBtYXRjaGVkRmliZXIsICIiICsgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3Q2hpbGQua2V5ID09PSBudWxsID8gbmV3SWR4IDogbmV3Q2hpbGQua2V5KSB8fCBudWxsOwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIyID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3Q2hpbGQua2V5ID09PSBudWxsID8gbmV3SWR4IDogbmV3Q2hpbGQua2V5KSB8fCBudWxsOwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUG9ydGFsKHJldHVybkZpYmVyLCBfbWF0Y2hlZEZpYmVyMiwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5MihuZXdDaGlsZCkgfHwgZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyMyA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG5ld0lkeCkgfHwgbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudDIocmV0dXJuRmliZXIsIF9tYXRjaGVkRmliZXIzLCBuZXdDaGlsZCwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkICE9PSAib2JqZWN0IiB8fCBjaGlsZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGtub3duS2V5czsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3dpdGNoIChjaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICB3YXJuRm9yTWlzc2luZ0tleShjaGlsZCwgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgICAgICB2YXIga2V5ID0gY2hpbGQua2V5OwogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGtleSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoa25vd25LZXlzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAga25vd25LZXlzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICBrbm93bktleXMuYWRkKGtleSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFrbm93bktleXMuaGFzKGtleSkpIHsKICAgICAgICAgICAgICAgICAgICBrbm93bktleXMuYWRkKGtleSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IoIkVuY291bnRlcmVkIHR3byBjaGlsZHJlbiB3aXRoIHRoZSBzYW1lIGtleSwgYCVzYC4gS2V5cyBzaG91bGQgYmUgdW5pcXVlIHNvIHRoYXQgY29tcG9uZW50cyBtYWludGFpbiB0aGVpciBpZGVudGl0eSBhY3Jvc3MgdXBkYXRlcy4gTm9uLXVuaXF1ZSBrZXlzIG1heSBjYXVzZSBjaGlsZHJlbiB0byBiZSBkdXBsaWNhdGVkIGFuZC9vciBvbWl0dGVkIFx1MjAxNCB0aGUgYmVoYXZpb3IgaXMgdW5zdXBwb3J0ZWQgYW5kIGNvdWxkIGNoYW5nZSBpbiBhIGZ1dHVyZSB2ZXJzaW9uLiIsIGtleSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gY2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gY2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRLZXkoaW5pdChwYXlsb2FkKSwga25vd25LZXlzLCByZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4ga25vd25LZXlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5BcnJheShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkcmVuLCBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGtub3duS2V5cyA9IG51bGw7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdDaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbmV3Q2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICBrbm93bktleXMgPSB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBudWxsOwogICAgICAgICAgICB2YXIgcHJldmlvdXNOZXdGaWJlciA9IG51bGw7CiAgICAgICAgICAgIHZhciBvbGRGaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB2YXIgbGFzdFBsYWNlZEluZGV4ID0gMDsKICAgICAgICAgICAgdmFyIG5ld0lkeCA9IDA7CiAgICAgICAgICAgIHZhciBuZXh0T2xkRmliZXIgPSBudWxsOwogICAgICAgICAgICBmb3IgKDsgb2xkRmliZXIgIT09IG51bGwgJiYgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgIGlmIChvbGRGaWJlci5pbmRleCA+IG5ld0lkeCkgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXI7CiAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRPbGRGaWJlciA9IG9sZEZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBuZXdGaWJlciA9IHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKG5ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciAmJiBuZXdGaWJlci5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChuZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IG5ld0ZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5ld0lkeCA9PT0gbmV3Q2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmb3IgKDsgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgICAgdmFyIF9uZXdGaWJlciA9IGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3Jrcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgZm9yICg7IG5ld0lkeCA8IG5ld0NoaWxkcmVuLmxlbmd0aDsgbmV3SWR4KyspIHsKICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyMiA9IHVwZGF0ZUZyb21NYXAoZXhpc3RpbmdDaGlsZHJlbiwgcmV0dXJuRmliZXIsIG5ld0lkeCwgbmV3Q2hpbGRyZW5bbmV3SWR4XSwgbGFuZXMpOwogICAgICAgICAgICAgIGlmIChfbmV3RmliZXIyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyMi5hbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLmRlbGV0ZShfbmV3RmliZXIyLmtleSA9PT0gbnVsbCA/IG5ld0lkeCA6IF9uZXdGaWJlcjIua2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gX25ld0ZpYmVyMjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24oY2hpbGQyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkMik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3MyID0gbmV3SWR4OwogICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgX251bWJlck9mRm9ya3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkcmVuSXRlcmF0b3IocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZHJlbkl0ZXJhYmxlLCBsYW5lcykgewogICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQW4gb2JqZWN0IGlzIG5vdCBhbiBpdGVyYWJsZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgLy8gJEZsb3dGaXhNZSBGbG93IGRvZXNuJ3Qga25vdyBhYm91dCB0b1N0cmluZ1RhZwogICAgICAgICAgICAgIG5ld0NoaWxkcmVuSXRlcmFibGVbU3ltYm9sLnRvU3RyaW5nVGFnXSA9PT0gIkdlbmVyYXRvciIpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0R2VuZXJhdG9ycykgewogICAgICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgR2VuZXJhdG9ycyBhcyBjaGlsZHJlbiBpcyB1bnN1cHBvcnRlZCBhbmQgd2lsbCBsaWtlbHkgeWllbGQgdW5leHBlY3RlZCByZXN1bHRzIGJlY2F1c2UgZW51bWVyYXRpbmcgYSBnZW5lcmF0b3IgbXV0YXRlcyBpdC4gWW91IG1heSBjb252ZXJ0IGl0IHRvIGFuIGFycmF5IHdpdGggYEFycmF5LmZyb20oKWAgb3IgdGhlIGBbLi4uc3ByZWFkXWAgb3BlcmF0b3IgYmVmb3JlIHJlbmRlcmluZy4gS2VlcCBpbiBtaW5kIHlvdSBtaWdodCBuZWVkIHRvIHBvbHlmaWxsIHRoZXNlIGZlYXR1cmVzIGZvciBvbGRlciBicm93c2Vycy4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEdlbmVyYXRvcnMgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmV3Q2hpbGRyZW5JdGVyYWJsZS5lbnRyaWVzID09PSBpdGVyYXRvckZuKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1hcHMpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVzaW5nIE1hcHMgYXMgY2hpbGRyZW4gaXMgbm90IHN1cHBvcnRlZC4gVXNlIGFuIGFycmF5IG9mIGtleWVkIFJlYWN0RWxlbWVudHMgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1hcHMgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgX25ld0NoaWxkcmVuID0gaXRlcmF0b3JGbi5jYWxsKG5ld0NoaWxkcmVuSXRlcmFibGUpOwogICAgICAgICAgICAgIGlmIChfbmV3Q2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgIHZhciBrbm93bktleXMgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIF9zdGVwID0gX25ld0NoaWxkcmVuLm5leHQoKTsKICAgICAgICAgICAgICAgIGZvciAoOyAhX3N0ZXAuZG9uZTsgX3N0ZXAgPSBfbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IF9zdGVwLnZhbHVlOwogICAgICAgICAgICAgICAgICBrbm93bktleXMgPSB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gaXRlcmF0b3JGbi5jYWxsKG5ld0NoaWxkcmVuSXRlcmFibGUpOwogICAgICAgICAgICBpZiAobmV3Q2hpbGRyZW4gPT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQW4gaXRlcmFibGUgb2JqZWN0IHByb3ZpZGVkIG5vIGl0ZXJhdG9yLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXN1bHRpbmdGaXJzdENoaWxkID0gbnVsbDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzTmV3RmliZXIgPSBudWxsOwogICAgICAgICAgICB2YXIgb2xkRmliZXIgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgdmFyIGxhc3RQbGFjZWRJbmRleCA9IDA7CiAgICAgICAgICAgIHZhciBuZXdJZHggPSAwOwogICAgICAgICAgICB2YXIgbmV4dE9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgdmFyIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCk7CiAgICAgICAgICAgIGZvciAoOyBvbGRGaWJlciAhPT0gbnVsbCAmJiAhc3RlcC5kb25lOyBuZXdJZHgrKywgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKSkgewogICAgICAgICAgICAgIGlmIChvbGRGaWJlci5pbmRleCA+IG5ld0lkeCkgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXI7CiAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRPbGRGaWJlciA9IG9sZEZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBuZXdGaWJlciA9IHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKG5ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciAmJiBuZXdGaWJlci5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChuZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IG5ld0ZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHN0ZXAuZG9uZSkgewogICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICAgIHZhciBudW1iZXJPZkZvcmtzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBudW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9sZEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyMyA9IGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyMyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQoX25ld0ZpYmVyMywgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXIzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3MzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZHJlbiA9IG1hcFJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgIGZvciAoOyAhc3RlcC5kb25lOyBuZXdJZHgrKywgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKSkgewogICAgICAgICAgICAgIHZhciBfbmV3RmliZXI0ID0gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXI0LmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZGVsZXRlKF9uZXdGaWJlcjQua2V5ID09PSBudWxsID8gbmV3SWR4IDogX25ld0ZpYmVyNC5rZXkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlcjQsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gX25ld0ZpYmVyNDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihjaGlsZDIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrczQgPSBuZXdJZHg7CiAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlVGV4dE5vZGUocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCB0ZXh0Q29udGVudCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRGaXJzdENoaWxkICE9PSBudWxsICYmIGN1cnJlbnRGaXJzdENoaWxkLnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudEZpcnN0Q2hpbGQsIHRleHRDb250ZW50KTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKTsKICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KHRleHRDb250ZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIGVsZW1lbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBlbGVtZW50LmtleTsKICAgICAgICAgICAgdmFyIGNoaWxkID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnRUeXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC50YWcgPT09IEZyYWdtZW50OSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjaGlsZCwgZWxlbWVudC5wcm9wcy5jaGlsZHJlbik7CiAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQuZWxlbWVudFR5cGUgPT09IGVsZW1lbnRUeXBlIHx8IC8vIEtlZXAgdGhpcyBjaGVjayBpbmxpbmUgc28gaXQgb25seSBydW5zIG9uIHRoZSBmYWxzZSBwYXRoOgogICAgICAgICAgICAgICAgICBpc0NvbXBhdGlibGVGYW1pbHlGb3JIb3RSZWxvYWRpbmcoY2hpbGQsIGVsZW1lbnQpIHx8IC8vIExhenkgdHlwZXMgc2hvdWxkIHJlY29uY2lsZSB0aGVpciByZXNvbHZlZCB0eXBlLgogICAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIGRvIHRoaXMgYWZ0ZXIgdGhlIEhvdCBSZWxvYWRpbmcgY2hlY2sgYWJvdmUsCiAgICAgICAgICAgICAgICAgIC8vIGJlY2F1c2UgaG90IHJlbG9hZGluZyBoYXMgZGlmZmVyZW50IHNlbWFudGljcyB0aGFuIHByb2QgYmVjYXVzZQogICAgICAgICAgICAgICAgICAvLyBpdCBkb2Vzbid0IHJlc3VzcGVuZC4gU28gd2UgY2FuJ3QgbGV0IHRoZSBjYWxsIGJlbG93IHN1c3BlbmQuCiAgICAgICAgICAgICAgICAgIHR5cGVvZiBlbGVtZW50VHlwZSA9PT0gIm9iamVjdCIgJiYgZWxlbWVudFR5cGUgIT09IG51bGwgJiYgZWxlbWVudFR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSAmJiByZXNvbHZlTGF6eShlbGVtZW50VHlwZSkgPT09IGNoaWxkLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9leGlzdGluZyA9IHVzZUZpYmVyKGNoaWxkLCBlbGVtZW50LnByb3BzKTsKICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjaGlsZCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgX2V4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9leGlzdGluZzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVsZW1lbnQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZWxlbWVudC5wcm9wcy5jaGlsZHJlbiwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMsIGVsZW1lbnQua2V5KTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfY3JlYXRlZDQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KGVsZW1lbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICBfY3JlYXRlZDQucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgX2NyZWF0ZWQ0LnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZVNpbmdsZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIHBvcnRhbCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGtleSA9IHBvcnRhbC5rZXk7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoY2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgIGlmIChjaGlsZC50YWcgPT09IEhvc3RQb3J0YWwgJiYgY2hpbGQuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8gPT09IHBvcnRhbC5jb250YWluZXJJbmZvICYmIGNoaWxkLnN0YXRlTm9kZS5pbXBsZW1lbnRhdGlvbiA9PT0gcG9ydGFsLmltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY2hpbGQsIHBvcnRhbC5jaGlsZHJlbiB8fCBbXSk7CiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tUG9ydGFsKHBvcnRhbCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkRmliZXJzMihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICB2YXIgaXNVbmtleWVkVG9wTGV2ZWxGcmFnbWVudCA9IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwgJiYgbmV3Q2hpbGQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSAmJiBuZXdDaGlsZC5rZXkgPT09IG51bGw7CiAgICAgICAgICAgIGlmIChpc1Vua2V5ZWRUb3BMZXZlbEZyYWdtZW50KSB7CiAgICAgICAgICAgICAgbmV3Q2hpbGQgPSBuZXdDaGlsZC5wcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVFbGVtZW50KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKSk7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVQb3J0YWwocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpKTsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRGaWJlcnMyKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgaW5pdChwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNBcnJheTIobmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRyZW5BcnJheShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkcmVuSXRlcmF0b3IocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJlY29uY2lsZVNpbmdsZVRleHROb2RlKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgIiIgKyBuZXdDaGlsZCwgbGFuZXMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRGaWJlcnMyOwogICAgICAgIH0KICAgICAgICB2YXIgcmVjb25jaWxlQ2hpbGRGaWJlcnMgPSBDaGlsZFJlY29uY2lsZXIodHJ1ZSk7CiAgICAgICAgdmFyIG1vdW50Q2hpbGRGaWJlcnMgPSBDaGlsZFJlY29uY2lsZXIoZmFsc2UpOwogICAgICAgIGZ1bmN0aW9uIGNsb25lQ2hpbGRGaWJlcnMoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmIHdvcmtJblByb2dyZXNzMi5jaGlsZCAhPT0gY3VycmVudDQuY2hpbGQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZXN1bWluZyB3b3JrIG5vdCB5ZXQgaW1wbGVtZW50ZWQuIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50Q2hpbGQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB2YXIgbmV3Q2hpbGQgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50Q2hpbGQsIGN1cnJlbnRDaGlsZC5wZW5kaW5nUHJvcHMpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbmV3Q2hpbGQ7CiAgICAgICAgICBuZXdDaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB3aGlsZSAoY3VycmVudENoaWxkLnNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgY3VycmVudENoaWxkID0gY3VycmVudENoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIG5ld0NoaWxkID0gbmV3Q2hpbGQuc2libGluZyA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRDaGlsZCwgY3VycmVudENoaWxkLnBlbmRpbmdQcm9wcyk7CiAgICAgICAgICAgIG5ld0NoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIH0KICAgICAgICAgIG5ld0NoaWxkLnNpYmxpbmcgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbGFuZXMpIHsKICAgICAgICAgIHZhciBjaGlsZCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzKGNoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHZhbHVlQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKG51bGwpOwogICAgICAgIHZhciByZW5kZXJlclNpZ2lsOwogICAgICAgIHsKICAgICAgICAgIHJlbmRlcmVyU2lnaWwgPSB7fTsKICAgICAgICB9CiAgICAgICAgdmFyIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID0gbnVsbDsKICAgICAgICB2YXIgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gbnVsbDsKICAgICAgICB2YXIgbGFzdEZ1bGx5T2JzZXJ2ZWRDb250ZXh0ID0gbnVsbDsKICAgICAgICB2YXIgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpIHsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID0gbnVsbDsKICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IG51bGw7CiAgICAgICAgICBsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVudGVyRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleGl0RGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFByb3ZpZGVyKHByb3ZpZGVyRmliZXIsIGNvbnRleHQsIG5leHRWYWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBwdXNoKHZhbHVlQ3Vyc29yLCBjb250ZXh0Ll9jdXJyZW50VmFsdWUsIHByb3ZpZGVyRmliZXIpOwogICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50VmFsdWUgPSBuZXh0VmFsdWU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoY29udGV4dC5fY3VycmVudFJlbmRlcmVyICE9PSB2b2lkIDAgJiYgY29udGV4dC5fY3VycmVudFJlbmRlcmVyICE9PSBudWxsICYmIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciAhPT0gcmVuZGVyZXJTaWdpbCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkRldGVjdGVkIG11bHRpcGxlIHJlbmRlcmVycyBjb25jdXJyZW50bHkgcmVuZGVyaW5nIHRoZSBzYW1lIGNvbnRleHQgcHJvdmlkZXIuIFRoaXMgaXMgY3VycmVudGx5IHVuc3VwcG9ydGVkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgPSByZW5kZXJlclNpZ2lsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFByb3ZpZGVyKGNvbnRleHQsIHByb3ZpZGVyRmliZXIpIHsKICAgICAgICAgIHZhciBjdXJyZW50VmFsdWUgPSB2YWx1ZUN1cnNvci5jdXJyZW50OwogICAgICAgICAgcG9wKHZhbHVlQ3Vyc29yLCBwcm92aWRlckZpYmVyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZSA9IGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUNvbnRleHRXb3JrT25QYXJlbnRQYXRoKHBhcmVudCwgcmVuZGVyTGFuZXMyLCBwcm9wYWdhdGlvblJvb3QpIHsKICAgICAgICAgIHZhciBub2RlID0gcGFyZW50OwogICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IG5vZGUuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhub2RlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICBub2RlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5vZGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhbHRlcm5hdGUuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCAmJiAhaXNTdWJzZXRPZkxhbmVzKGFsdGVybmF0ZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgICAgYWx0ZXJuYXRlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlID09PSBwcm9wYWdhdGlvblJvb3QpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChub2RlICE9PSBwcm9wYWdhdGlvblJvb3QpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdG8gZmluZCB0aGUgcHJvcGFnYXRpb24gcm9vdCB3aGVuIHNjaGVkdWxpbmcgY29udGV4dCB3b3JrLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2Uod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcHJvcGFnYXRlQ29udGV4dENoYW5nZV9lYWdlcih3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2VfZWFnZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBmaWJlciA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIGlmIChmaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICBmaWJlci5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIG5leHRGaWJlciA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIGxpc3QgPSBmaWJlci5kZXBlbmRlbmNpZXM7CiAgICAgICAgICAgIGlmIChsaXN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIGRlcGVuZGVuY3kgPSBsaXN0LmZpcnN0Q29udGV4dDsKICAgICAgICAgICAgICB3aGlsZSAoZGVwZW5kZW5jeSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGRlcGVuZGVuY3kuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKE5vVGltZXN0YW1wLCBsYW5lKTsKICAgICAgICAgICAgICAgICAgICB1cGRhdGUudGFnID0gRm9yY2VVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlID09PSBudWxsKSA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgc2hhcmVkUXVldWUgPSB1cGRhdGVRdWV1ZS5zaGFyZWQ7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcGVuZGluZyA9IHNoYXJlZFF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICAgICAgICAgICAgICBpZiAocGVuZGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gcGVuZGluZy5uZXh0OwogICAgICAgICAgICAgICAgICAgICAgICBwZW5kaW5nLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBzaGFyZWRRdWV1ZS5wZW5kaW5nID0gdXBkYXRlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBmaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoZmliZXIubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBhbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzY2hlZHVsZUNvbnRleHRXb3JrT25QYXJlbnRQYXRoKGZpYmVyLnJldHVybiwgcmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICBsaXN0LmxhbmVzID0gbWVyZ2VMYW5lcyhsaXN0LmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlcGVuZGVuY3kgPSBkZXBlbmRlbmN5Lm5leHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGZpYmVyLnRhZyA9PT0gQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXIudHlwZSA9PT0gd29ya0luUHJvZ3Jlc3MyLnR5cGUgPyBudWxsIDogZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmliZXIudGFnID09PSBEZWh5ZHJhdGVkRnJhZ21lbnQpIHsKICAgICAgICAgICAgICB2YXIgcGFyZW50U3VzcGVuc2UgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgaWYgKHBhcmVudFN1c3BlbnNlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlIGp1c3QgY2FtZSBmcm9tIGEgcGFyZW50IHNvIHdlIG11c3QgaGF2ZSBoYWQgYSBwYXJlbnQuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLmxhbmVzID0gbWVyZ2VMYW5lcyhwYXJlbnRTdXNwZW5zZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgX2FsdGVybmF0ZSA9IHBhcmVudFN1c3BlbnNlLmFsdGVybmF0ZTsKICAgICAgICAgICAgICBpZiAoX2FsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgX2FsdGVybmF0ZS5sYW5lcyA9IG1lcmdlTGFuZXMoX2FsdGVybmF0ZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChwYXJlbnRTdXNwZW5zZSwgcmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5leHRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5leHRGaWJlci5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICB3aGlsZSAobmV4dEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dEZpYmVyID09PSB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgICAgICAgbmV4dEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgc2libGluZyA9IG5leHRGaWJlci5zaWJsaW5nOwogICAgICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBuZXh0RmliZXIucmV0dXJuOwogICAgICAgICAgICAgICAgICBuZXh0RmliZXIgPSBzaWJsaW5nOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IG5leHRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpYmVyID0gbmV4dEZpYmVyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBudWxsOwogICAgICAgICAgbGFzdEZ1bGx5T2JzZXJ2ZWRDb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHZhciBkZXBlbmRlbmNpZXMgPSB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzOwogICAgICAgICAgaWYgKGRlcGVuZGVuY2llcyAhPT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0Q29udGV4dCA9IGRlcGVuZGVuY2llcy5maXJzdENvbnRleHQ7CiAgICAgICAgICAgICAgaWYgKGZpcnN0Q29udGV4dCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUoZGVwZW5kZW5jaWVzLmxhbmVzLCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZXBlbmRlbmNpZXMuZmlyc3RDb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVhZENvbnRleHQoY29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVikgewogICAgICAgICAgICAgIGVycm9yKCJDb250ZXh0IGNhbiBvbmx5IGJlIHJlYWQgd2hpbGUgUmVhY3QgaXMgcmVuZGVyaW5nLiBJbiBjbGFzc2VzLCB5b3UgY2FuIHJlYWQgaXQgaW4gdGhlIHJlbmRlciBtZXRob2Qgb3IgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBJbiBmdW5jdGlvbiBjb21wb25lbnRzLCB5b3UgY2FuIHJlYWQgaXQgZGlyZWN0bHkgaW4gdGhlIGZ1bmN0aW9uIGJvZHksIGJ1dCBub3QgaW5zaWRlIEhvb2tzIGxpa2UgdXNlUmVkdWNlcigpIG9yIHVzZU1lbW8oKS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHZhbHVlID0gY29udGV4dC5fY3VycmVudFZhbHVlOwogICAgICAgICAgaWYgKGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9PT0gY29udGV4dCkgOwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHZhciBjb250ZXh0SXRlbSA9IHsKICAgICAgICAgICAgICBjb250ZXh0LAogICAgICAgICAgICAgIG1lbW9pemVkVmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDb250ZXh0IGNhbiBvbmx5IGJlIHJlYWQgd2hpbGUgUmVhY3QgaXMgcmVuZGVyaW5nLiBJbiBjbGFzc2VzLCB5b3UgY2FuIHJlYWQgaXQgaW4gdGhlIHJlbmRlciBtZXRob2Qgb3IgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBJbiBmdW5jdGlvbiBjb21wb25lbnRzLCB5b3UgY2FuIHJlYWQgaXQgZGlyZWN0bHkgaW4gdGhlIGZ1bmN0aW9uIGJvZHksIGJ1dCBub3QgaW5zaWRlIEhvb2tzIGxpa2UgdXNlUmVkdWNlcigpIG9yIHVzZU1lbW8oKS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gY29udGV4dEl0ZW07CiAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIuZGVwZW5kZW5jaWVzID0gewogICAgICAgICAgICAgICAgbGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgICAgICBmaXJzdENvbnRleHQ6IGNvbnRleHRJdGVtCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBsYXN0Q29udGV4dERlcGVuZGVuY3kubmV4dCA9IGNvbnRleHRJdGVtOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciBjb25jdXJyZW50UXVldWVzID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKSB7CiAgICAgICAgICBpZiAoY29uY3VycmVudFF1ZXVlcyA9PT0gbnVsbCkgewogICAgICAgICAgICBjb25jdXJyZW50UXVldWVzID0gW3F1ZXVlXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmN1cnJlbnRRdWV1ZXMucHVzaChxdWV1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmlzaFF1ZXVlaW5nQ29uY3VycmVudFVwZGF0ZXMoKSB7CiAgICAgICAgICBpZiAoY29uY3VycmVudFF1ZXVlcyAhPT0gbnVsbCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbmN1cnJlbnRRdWV1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcXVldWUgPSBjb25jdXJyZW50UXVldWVzW2ldOwogICAgICAgICAgICAgIHZhciBsYXN0SW50ZXJsZWF2ZWRVcGRhdGUgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgICAgICBpZiAobGFzdEludGVybGVhdmVkVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgZmlyc3RJbnRlcmxlYXZlZFVwZGF0ZSA9IGxhc3RJbnRlcmxlYXZlZFVwZGF0ZS5uZXh0OwogICAgICAgICAgICAgICAgdmFyIGxhc3RQZW5kaW5nVXBkYXRlID0gcXVldWUucGVuZGluZzsKICAgICAgICAgICAgICAgIGlmIChsYXN0UGVuZGluZ1VwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgZmlyc3RQZW5kaW5nVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGUubmV4dDsKICAgICAgICAgICAgICAgICAgbGFzdFBlbmRpbmdVcGRhdGUubmV4dCA9IGZpcnN0SW50ZXJsZWF2ZWRVcGRhdGU7CiAgICAgICAgICAgICAgICAgIGxhc3RJbnRlcmxlYXZlZFVwZGF0ZS5uZXh0ID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcXVldWUucGVuZGluZyA9IGxhc3RJbnRlcmxlYXZlZFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uY3VycmVudFF1ZXVlcyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZShmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSkgewogICAgICAgICAgdmFyIGludGVybGVhdmVkID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICBpZiAoaW50ZXJsZWF2ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICBpbnRlcmxlYXZlZC5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUuaW50ZXJsZWF2ZWQgPSB1cGRhdGU7CiAgICAgICAgICByZXR1cm4gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGVBbmRFYWdlcmx5QmFpbG91dChmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSkgewogICAgICAgICAgdmFyIGludGVybGVhdmVkID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICBpZiAoaW50ZXJsZWF2ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICBpbnRlcmxlYXZlZC5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUuaW50ZXJsZWF2ZWQgPSB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50Q2xhc3NVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgaWYgKGludGVybGVhdmVkID09PSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgaW50ZXJsZWF2ZWQubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gdXBkYXRlOwogICAgICAgICAgcmV0dXJuIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBsYW5lKSB7CiAgICAgICAgICByZXR1cm4gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICB2YXIgdW5zYWZlX21hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290ID0gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3Q7CiAgICAgICAgZnVuY3Rpb24gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3Qoc291cmNlRmliZXIsIGxhbmUpIHsKICAgICAgICAgIHNvdXJjZUZpYmVyLmxhbmVzID0gbWVyZ2VMYW5lcyhzb3VyY2VGaWJlci5sYW5lcywgbGFuZSk7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gc291cmNlRmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBhbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5sYW5lcywgbGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgPT09IG51bGwgJiYgKHNvdXJjZUZpYmVyLmZsYWdzICYgKFBsYWNlbWVudCB8IEh5ZHJhdGluZykpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgd2FybkFib3V0VXBkYXRlT25Ob3RZZXRNb3VudGVkRmliZXJJbkRFVihzb3VyY2VGaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBub2RlID0gc291cmNlRmliZXI7CiAgICAgICAgICB2YXIgcGFyZW50ID0gc291cmNlRmliZXIucmV0dXJuOwogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBwYXJlbnQuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMocGFyZW50LmNoaWxkTGFuZXMsIGxhbmUpOwogICAgICAgICAgICBhbHRlcm5hdGUgPSBwYXJlbnQuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgYWx0ZXJuYXRlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5jaGlsZExhbmVzLCBsYW5lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoKHBhcmVudC5mbGFncyAmIChQbGFjZW1lbnQgfCBIeWRyYXRpbmcpKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICB3YXJuQWJvdXRVcGRhdGVPbk5vdFlldE1vdW50ZWRGaWJlckluREVWKHNvdXJjZUZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IHBhcmVudDsKICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgdmFyIHJvb3QzID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIHJldHVybiByb290MzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgVXBkYXRlU3RhdGUgPSAwOwogICAgICAgIHZhciBSZXBsYWNlU3RhdGUgPSAxOwogICAgICAgIHZhciBGb3JjZVVwZGF0ZSA9IDI7CiAgICAgICAgdmFyIENhcHR1cmVVcGRhdGUgPSAzOwogICAgICAgIHZhciBoYXNGb3JjZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuVXBkYXRlSW5zaWRlVXBkYXRlOwogICAgICAgIHZhciBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWU7CiAgICAgICAgewogICAgICAgICAgZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdGlhbGl6ZVVwZGF0ZVF1ZXVlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgcXVldWUgPSB7CiAgICAgICAgICAgIGJhc2VTdGF0ZTogZmliZXIubWVtb2l6ZWRTdGF0ZSwKICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlOiBudWxsLAogICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZTogbnVsbCwKICAgICAgICAgICAgc2hhcmVkOiB7CiAgICAgICAgICAgICAgcGVuZGluZzogbnVsbCwKICAgICAgICAgICAgICBpbnRlcmxlYXZlZDogbnVsbCwKICAgICAgICAgICAgICBsYW5lczogTm9MYW5lcwogICAgICAgICAgICB9LAogICAgICAgICAgICBlZmZlY3RzOiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgZmliZXIudXBkYXRlUXVldWUgPSBxdWV1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xvbmVVcGRhdGVRdWV1ZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB2YXIgcXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgY3VycmVudFF1ZXVlID0gY3VycmVudDQudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAocXVldWUgPT09IGN1cnJlbnRRdWV1ZSkgewogICAgICAgICAgICB2YXIgY2xvbmUgPSB7CiAgICAgICAgICAgICAgYmFzZVN0YXRlOiBjdXJyZW50UXVldWUuYmFzZVN0YXRlLAogICAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZTogY3VycmVudFF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSwKICAgICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZTogY3VycmVudFF1ZXVlLmxhc3RCYXNlVXBkYXRlLAogICAgICAgICAgICAgIHNoYXJlZDogY3VycmVudFF1ZXVlLnNoYXJlZCwKICAgICAgICAgICAgICBlZmZlY3RzOiBjdXJyZW50UXVldWUuZWZmZWN0cwogICAgICAgICAgICB9OwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjbG9uZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgZXZlbnRUaW1lLAogICAgICAgICAgICBsYW5lLAogICAgICAgICAgICB0YWc6IFVwZGF0ZVN0YXRlLAogICAgICAgICAgICBwYXlsb2FkOiBudWxsLAogICAgICAgICAgICBjYWxsYmFjazogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAodXBkYXRlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hhcmVkUXVldWUgPSB1cGRhdGVRdWV1ZS5zaGFyZWQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPT09IHNoYXJlZFF1ZXVlICYmICFkaWRXYXJuVXBkYXRlSW5zaWRlVXBkYXRlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkFuIHVwZGF0ZSAoc2V0U3RhdGUsIHJlcGxhY2VTdGF0ZSwgb3IgZm9yY2VVcGRhdGUpIHdhcyBzY2hlZHVsZWQgZnJvbSBpbnNpZGUgYW4gdXBkYXRlIGZ1bmN0aW9uLiBVcGRhdGUgZnVuY3Rpb25zIHNob3VsZCBiZSBwdXJlLCB3aXRoIHplcm8gc2lkZS1lZmZlY3RzLiBDb25zaWRlciB1c2luZyBjb21wb25lbnREaWRVcGRhdGUgb3IgYSBjYWxsYmFjay4iKTsKICAgICAgICAgICAgICBkaWRXYXJuVXBkYXRlSW5zaWRlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzVW5zYWZlQ2xhc3NSZW5kZXJQaGFzZVVwZGF0ZSgpKSB7CiAgICAgICAgICAgIHZhciBwZW5kaW5nID0gc2hhcmVkUXVldWUucGVuZGluZzsKICAgICAgICAgICAgaWYgKHBlbmRpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHBlbmRpbmcubmV4dDsKICAgICAgICAgICAgICBwZW5kaW5nLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2hhcmVkUXVldWUucGVuZGluZyA9IHVwZGF0ZTsKICAgICAgICAgICAgcmV0dXJuIHVuc2FmZV9tYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZW5xdWV1ZUNvbmN1cnJlbnRDbGFzc1VwZGF0ZShmaWJlciwgc2hhcmVkUXVldWUsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGZpYmVyLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaWJlci51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hhcmVkUXVldWUgPSB1cGRhdGVRdWV1ZS5zaGFyZWQ7CiAgICAgICAgICBpZiAoaXNUcmFuc2l0aW9uTGFuZShsYW5lKSkgewogICAgICAgICAgICB2YXIgcXVldWVMYW5lcyA9IHNoYXJlZFF1ZXVlLmxhbmVzOwogICAgICAgICAgICBxdWV1ZUxhbmVzID0gaW50ZXJzZWN0TGFuZXMocXVldWVMYW5lcywgcm9vdDMucGVuZGluZ0xhbmVzKTsKICAgICAgICAgICAgdmFyIG5ld1F1ZXVlTGFuZXMgPSBtZXJnZUxhbmVzKHF1ZXVlTGFuZXMsIGxhbmUpOwogICAgICAgICAgICBzaGFyZWRRdWV1ZS5sYW5lcyA9IG5ld1F1ZXVlTGFuZXM7CiAgICAgICAgICAgIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBuZXdRdWV1ZUxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNhcHR1cmVkVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY2FwdHVyZWRVcGRhdGUpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICBpZiAocXVldWUgPT09IGN1cnJlbnRRdWV1ZSkgewogICAgICAgICAgICAgIHZhciBuZXdGaXJzdCA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIG5ld0xhc3QgPSBudWxsOwogICAgICAgICAgICAgIHZhciBmaXJzdEJhc2VVcGRhdGUgPSBxdWV1ZS5maXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgICAgaWYgKGZpcnN0QmFzZVVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgICAgICAgIGV2ZW50VGltZTogdXBkYXRlLmV2ZW50VGltZSwKICAgICAgICAgICAgICAgICAgICBsYW5lOiB1cGRhdGUubGFuZSwKICAgICAgICAgICAgICAgICAgICB0YWc6IHVwZGF0ZS50YWcsCiAgICAgICAgICAgICAgICAgICAgcGF5bG9hZDogdXBkYXRlLnBheWxvYWQsCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHVwZGF0ZS5jYWxsYmFjaywKICAgICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIGlmIChuZXdMYXN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbmV3Rmlyc3QgPSBuZXdMYXN0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmV3TGFzdC5uZXh0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgICAgbmV3TGFzdCA9IGNsb25lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICAgICAgfSB3aGlsZSAodXBkYXRlICE9PSBudWxsKTsKICAgICAgICAgICAgICAgIGlmIChuZXdMYXN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5ld0ZpcnN0ID0gbmV3TGFzdCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbmV3TGFzdC5uZXh0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICAgICAgICAgIG5ld0xhc3QgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV3Rmlyc3QgPSBuZXdMYXN0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHF1ZXVlID0gewogICAgICAgICAgICAgICAgYmFzZVN0YXRlOiBjdXJyZW50UXVldWUuYmFzZVN0YXRlLAogICAgICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlOiBuZXdGaXJzdCwKICAgICAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlOiBuZXdMYXN0LAogICAgICAgICAgICAgICAgc2hhcmVkOiBjdXJyZW50UXVldWUuc2hhcmVkLAogICAgICAgICAgICAgICAgZWZmZWN0czogY3VycmVudFF1ZXVlLmVmZmVjdHMKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IHF1ZXVlOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhc3RCYXNlVXBkYXRlID0gcXVldWUubGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICBpZiAobGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUuZmlyc3RCYXNlVXBkYXRlID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZS5uZXh0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdGF0ZUZyb21VcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBxdWV1ZSwgdXBkYXRlLCBwcmV2U3RhdGUsIG5leHRQcm9wcywgaW5zdGFuY2UpIHsKICAgICAgICAgIHN3aXRjaCAodXBkYXRlLnRhZykgewogICAgICAgICAgICBjYXNlIFJlcGxhY2VTdGF0ZTogewogICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gdXBkYXRlLnBheWxvYWQ7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXlsb2FkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGVudGVyRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSBwYXlsb2FkLmNhbGwoaW5zdGFuY2UsIHByZXZTdGF0ZSwgbmV4dFByb3BzKTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBwYXlsb2FkLmNhbGwoaW5zdGFuY2UsIHByZXZTdGF0ZSwgbmV4dFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBleGl0RGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBuZXh0U3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBwYXlsb2FkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2FwdHVyZVVwZGF0ZTogewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IHdvcmtJblByb2dyZXNzMi5mbGFncyAmIH5TaG91bGRDYXB0dXJlIHwgRGlkQ2FwdHVyZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFVwZGF0ZVN0YXRlOiB7CiAgICAgICAgICAgICAgdmFyIF9wYXlsb2FkID0gdXBkYXRlLnBheWxvYWQ7CiAgICAgICAgICAgICAgdmFyIHBhcnRpYWxTdGF0ZTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIF9wYXlsb2FkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGVudGVyRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBhcnRpYWxTdGF0ZSA9IF9wYXlsb2FkLmNhbGwoaW5zdGFuY2UsIHByZXZTdGF0ZSwgbmV4dFByb3BzKTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBfcGF5bG9hZC5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIG5leHRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXhpdERpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhcnRpYWxTdGF0ZSA9IF9wYXlsb2FkOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocGFydGlhbFN0YXRlID09PSBudWxsIHx8IHBhcnRpYWxTdGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJldlN0YXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gYXNzaWduMih7fSwgcHJldlN0YXRlLCBwYXJ0aWFsU3RhdGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRm9yY2VVcGRhdGU6IHsKICAgICAgICAgICAgICBoYXNGb3JjZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgcHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgIGhhc0ZvcmNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9IHF1ZXVlLnNoYXJlZDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdEJhc2VVcGRhdGUgPSBxdWV1ZS5maXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICB2YXIgbGFzdEJhc2VVcGRhdGUgPSBxdWV1ZS5sYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgIHZhciBwZW5kaW5nUXVldWUgPSBxdWV1ZS5zaGFyZWQucGVuZGluZzsKICAgICAgICAgIGlmIChwZW5kaW5nUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUuc2hhcmVkLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICB2YXIgbGFzdFBlbmRpbmdVcGRhdGUgPSBwZW5kaW5nUXVldWU7CiAgICAgICAgICAgIHZhciBmaXJzdFBlbmRpbmdVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0OwogICAgICAgICAgICBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0ID0gbnVsbDsKICAgICAgICAgICAgaWYgKGxhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlLm5leHQgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgIHZhciBjdXJyZW50TGFzdEJhc2VVcGRhdGUgPSBjdXJyZW50UXVldWUubGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRMYXN0QmFzZVVwZGF0ZSAhPT0gbGFzdEJhc2VVcGRhdGUpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50TGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudFF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRMYXN0QmFzZVVwZGF0ZS5uZXh0ID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudFF1ZXVlLmxhc3RCYXNlVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmlyc3RCYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IHF1ZXVlLmJhc2VTdGF0ZTsKICAgICAgICAgICAgdmFyIG5ld0xhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBuZXdGaXJzdEJhc2VVcGRhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgbmV3TGFzdEJhc2VVcGRhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZUxhbmUgPSB1cGRhdGUubGFuZTsKICAgICAgICAgICAgICB2YXIgdXBkYXRlRXZlbnRUaW1lID0gdXBkYXRlLmV2ZW50VGltZTsKICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhyZW5kZXJMYW5lczIsIHVwZGF0ZUxhbmUpKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgIGV2ZW50VGltZTogdXBkYXRlRXZlbnRUaW1lLAogICAgICAgICAgICAgICAgICBsYW5lOiB1cGRhdGVMYW5lLAogICAgICAgICAgICAgICAgICB0YWc6IHVwZGF0ZS50YWcsCiAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IHVwZGF0ZS5wYXlsb2FkLAogICAgICAgICAgICAgICAgICBjYWxsYmFjazogdXBkYXRlLmNhbGxiYWNrLAogICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaWYgKG5ld0xhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5ld0ZpcnN0QmFzZVVwZGF0ZSA9IG5ld0xhc3RCYXNlVXBkYXRlID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbmV3TGFzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZS5uZXh0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXdMYW5lcyA9IG1lcmdlTGFuZXMobmV3TGFuZXMsIHVwZGF0ZUxhbmUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAobmV3TGFzdEJhc2VVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9jbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICBldmVudFRpbWU6IHVwZGF0ZUV2ZW50VGltZSwKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHVwZGF0ZSBpcyBnb2luZyB0byBiZSBjb21taXR0ZWQgc28gd2UgbmV2ZXIgd2FudCB1bmNvbW1pdAogICAgICAgICAgICAgICAgICAgIC8vIGl0LiBVc2luZyBOb0xhbmUgd29ya3MgYmVjYXVzZSAwIGlzIGEgc3Vic2V0IG9mIGFsbCBiaXRtYXNrcywgc28KICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHdpbGwgbmV2ZXIgYmUgc2tpcHBlZCBieSB0aGUgY2hlY2sgYWJvdmUuCiAgICAgICAgICAgICAgICAgICAgbGFuZTogTm9MYW5lLAogICAgICAgICAgICAgICAgICAgIHRhZzogdXBkYXRlLnRhZywKICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiB1cGRhdGUucGF5bG9hZCwKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogdXBkYXRlLmNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgbmV3TGFzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZS5uZXh0ID0gX2Nsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV3U3RhdGUgPSBnZXRTdGF0ZUZyb21VcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBxdWV1ZSwgdXBkYXRlLCBuZXdTdGF0ZSwgcHJvcHMsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHVwZGF0ZS5jYWxsYmFjazsKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCAmJiAvLyBJZiB0aGUgdXBkYXRlIHdhcyBhbHJlYWR5IGNvbW1pdHRlZCwgd2Ugc2hvdWxkIG5vdCBxdWV1ZSBpdHMKICAgICAgICAgICAgICAgIC8vIGNhbGxiYWNrIGFnYWluLgogICAgICAgICAgICAgICAgdXBkYXRlLmxhbmUgIT09IE5vTGFuZSkgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgIHZhciBlZmZlY3RzID0gcXVldWUuZWZmZWN0czsKICAgICAgICAgICAgICAgICAgaWYgKGVmZmVjdHMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBxdWV1ZS5lZmZlY3RzID0gW3VwZGF0ZV07CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0cy5wdXNoKHVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgaWYgKHVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcGVuZGluZ1F1ZXVlID0gcXVldWUuc2hhcmVkLnBlbmRpbmc7CiAgICAgICAgICAgICAgICBpZiAocGVuZGluZ1F1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIF9sYXN0UGVuZGluZ1VwZGF0ZSA9IHBlbmRpbmdRdWV1ZTsKICAgICAgICAgICAgICAgICAgdmFyIF9maXJzdFBlbmRpbmdVcGRhdGUgPSBfbGFzdFBlbmRpbmdVcGRhdGUubmV4dDsKICAgICAgICAgICAgICAgICAgX2xhc3RQZW5kaW5nVXBkYXRlLm5leHQgPSBudWxsOwogICAgICAgICAgICAgICAgICB1cGRhdGUgPSBfZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgICBxdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IF9sYXN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgICAgcXVldWUuc2hhcmVkLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICAgIGlmIChuZXdMYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHF1ZXVlLmJhc2VTdGF0ZSA9IG5ld0Jhc2VTdGF0ZTsKICAgICAgICAgICAgcXVldWUuZmlyc3RCYXNlVXBkYXRlID0gbmV3Rmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICBxdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IG5ld0xhc3RCYXNlVXBkYXRlOwogICAgICAgICAgICB2YXIgbGFzdEludGVybGVhdmVkID0gcXVldWUuc2hhcmVkLmludGVybGVhdmVkOwogICAgICAgICAgICBpZiAobGFzdEludGVybGVhdmVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGludGVybGVhdmVkID0gbGFzdEludGVybGVhdmVkOwogICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIG5ld0xhbmVzID0gbWVyZ2VMYW5lcyhuZXdMYW5lcywgaW50ZXJsZWF2ZWQubGFuZSk7CiAgICAgICAgICAgICAgICBpbnRlcmxlYXZlZCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgICAgfSB3aGlsZSAoaW50ZXJsZWF2ZWQgIT09IGxhc3RJbnRlcmxlYXZlZCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlyc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcXVldWUuc2hhcmVkLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKG5ld0xhbmVzKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbmV3TGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbGxDYWxsYmFjayhjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgYXJndW1lbnQgcGFzc2VkIGFzIGNhbGxiYWNrLiBFeHBlY3RlZCBhIGZ1bmN0aW9uLiBJbnN0ZWFkICIgKyAoInJlY2VpdmVkOiAiICsgY2FsbGJhY2spKTsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrLmNhbGwoY29udGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0SGFzRm9yY2VVcGRhdGVCZWZvcmVQcm9jZXNzaW5nKCkgewogICAgICAgICAgaGFzRm9yY2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHsKICAgICAgICAgIHJldHVybiBoYXNGb3JjZVVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0VXBkYXRlUXVldWUoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFF1ZXVlLCBpbnN0YW5jZSkgewogICAgICAgICAgdmFyIGVmZmVjdHMgPSBmaW5pc2hlZFF1ZXVlLmVmZmVjdHM7CiAgICAgICAgICBmaW5pc2hlZFF1ZXVlLmVmZmVjdHMgPSBudWxsOwogICAgICAgICAgaWYgKGVmZmVjdHMgIT09IG51bGwpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlZmZlY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGVmZmVjdHNbaV07CiAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gZWZmZWN0LmNhbGxiYWNrOwogICAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZWZmZWN0LmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgICAgIGNhbGxDYWxsYmFjayhjYWxsYmFjaywgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTk9fQ09OVEVYVCA9IHt9OwogICAgICAgIHZhciBjb250ZXh0U3RhY2tDdXJzb3IkMSA9IGNyZWF0ZUN1cnNvcihOT19DT05URVhUKTsKICAgICAgICB2YXIgY29udGV4dEZpYmVyU3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoTk9fQ09OVEVYVCk7CiAgICAgICAgdmFyIHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5PX0NPTlRFWFQpOwogICAgICAgIGZ1bmN0aW9uIHJlcXVpcmVkQ29udGV4dChjKSB7CiAgICAgICAgICBpZiAoYyA9PT0gTk9fQ09OVEVYVCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGhvc3QgY29udGV4dCB0byBleGlzdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSb290SG9zdENvbnRhaW5lcigpIHsKICAgICAgICAgIHZhciByb290SW5zdGFuY2UgPSByZXF1aXJlZENvbnRleHQocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IuY3VycmVudCk7CiAgICAgICAgICByZXR1cm4gcm9vdEluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoSG9zdENvbnRhaW5lcihmaWJlciwgbmV4dFJvb3RJbnN0YW5jZSkgewogICAgICAgICAgcHVzaChyb290SW5zdGFuY2VTdGFja0N1cnNvciwgbmV4dFJvb3RJbnN0YW5jZSwgZmliZXIpOwogICAgICAgICAgcHVzaChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yJDEsIE5PX0NPTlRFWFQsIGZpYmVyKTsKICAgICAgICAgIHZhciBuZXh0Um9vdENvbnRleHQgPSBnZXRSb290SG9zdENvbnRleHQobmV4dFJvb3RJbnN0YW5jZSk7CiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yJDEsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yJDEsIG5leHRSb290Q29udGV4dCwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BIb3N0Q29udGFpbmVyKGZpYmVyKSB7CiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yJDEsIGZpYmVyKTsKICAgICAgICAgIHBvcChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgcG9wKHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RDb250ZXh0KCkgewogICAgICAgICAgdmFyIGNvbnRleHQgPSByZXF1aXJlZENvbnRleHQoY29udGV4dFN0YWNrQ3Vyc29yJDEuY3VycmVudCk7CiAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICB2YXIgcm9vdEluc3RhbmNlID0gcmVxdWlyZWRDb250ZXh0KHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgdmFyIGNvbnRleHQgPSByZXF1aXJlZENvbnRleHQoY29udGV4dFN0YWNrQ3Vyc29yJDEuY3VycmVudCk7CiAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBnZXRDaGlsZEhvc3RDb250ZXh0KGNvbnRleHQsIGZpYmVyLnR5cGUpOwogICAgICAgICAgaWYgKGNvbnRleHQgPT09IG5leHRDb250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHB1c2goY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyLCBmaWJlcik7CiAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBuZXh0Q29udGV4dCwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BIb3N0Q29udGV4dChmaWJlcikgewogICAgICAgICAgaWYgKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLmN1cnJlbnQgIT09IGZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IkMSwgZmliZXIpOwogICAgICAgICAgcG9wKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIHZhciBEZWZhdWx0U3VzcGVuc2VDb250ZXh0ID0gMDsKICAgICAgICB2YXIgU3VidHJlZVN1c3BlbnNlQ29udGV4dE1hc2sgPSAxOwogICAgICAgIHZhciBJbnZpc2libGVQYXJlbnRTdXNwZW5zZUNvbnRleHQgPSAxOwogICAgICAgIHZhciBGb3JjZVN1c3BlbnNlRmFsbGJhY2sgPSAyOwogICAgICAgIHZhciBzdXNwZW5zZVN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKERlZmF1bHRTdXNwZW5zZUNvbnRleHQpOwogICAgICAgIGZ1bmN0aW9uIGhhc1N1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0LCBmbGFnKSB7CiAgICAgICAgICByZXR1cm4gKHBhcmVudENvbnRleHQgJiBmbGFnKSAhPT0gMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCkgewogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgJiBTdWJ0cmVlU3VzcGVuc2VDb250ZXh0TWFzazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0LCBzaGFsbG93Q29udGV4dCkgewogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgJiBTdWJ0cmVlU3VzcGVuc2VDb250ZXh0TWFzayB8IHNoYWxsb3dDb250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRTdWJ0cmVlU3VzcGVuc2VDb250ZXh0KHBhcmVudENvbnRleHQsIHN1YnRyZWVDb250ZXh0KSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dCB8IHN1YnRyZWVDb250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoU3VzcGVuc2VDb250ZXh0KGZpYmVyLCBuZXdDb250ZXh0KSB7CiAgICAgICAgICBwdXNoKHN1c3BlbnNlU3RhY2tDdXJzb3IsIG5ld0NvbnRleHQsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wU3VzcGVuc2VDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICBwb3Aoc3VzcGVuc2VTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDYXB0dXJlU3VzcGVuc2Uod29ya0luUHJvZ3Jlc3MyLCBoYXNJbnZpc2libGVQYXJlbnQpIHsKICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChuZXh0U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5leHRTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kRmlyc3RTdXNwZW5kZWQocm93KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHJvdzsKICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgc3RhdGUgPSBub2RlLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVoeWRyYXRlZCA9IHN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoZGVoeWRyYXRlZCA9PT0gbnVsbCB8fCBpc1N1c3BlbnNlSW5zdGFuY2VQZW5kaW5nKGRlaHlkcmF0ZWQpIHx8IGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKGRlaHlkcmF0ZWQpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VMaXN0Q29tcG9uZW50ICYmIC8vIHJldmVhbE9yZGVyIHVuZGVmaW5lZCBjYW4ndCBiZSB0cnVzdGVkIGJlY2F1c2UgaXQgZG9uJ3QKICAgICAgICAgICAgLy8ga2VlcCB0cmFjayBvZiB3aGV0aGVyIGl0IHN1c3BlbmRlZCBvciBub3QuCiAgICAgICAgICAgIG5vZGUubWVtb2l6ZWRQcm9wcy5yZXZlYWxPcmRlciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmQgPSAobm9kZS5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZSA9PT0gcm93KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gcm93KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgTm9GbGFncyQxID0gKAogICAgICAgICAgLyogICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIEhhc0VmZmVjdCA9ICgKICAgICAgICAgIC8qICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgSW5zZXJ0aW9uID0gKAogICAgICAgICAgLyogICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgTGF5b3V0ID0gKAogICAgICAgICAgLyogICAgKi8KICAgICAgICAgIDQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlJDEgPSAoCiAgICAgICAgICAvKiAgICovCiAgICAgICAgICA4CiAgICAgICAgKTsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NTb3VyY2VzID0gW107CiAgICAgICAgZnVuY3Rpb24gcmVzZXRXb3JrSW5Qcm9ncmVzc1ZlcnNpb25zKCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB3b3JrSW5Qcm9ncmVzc1NvdXJjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIG11dGFibGVTb3VyY2UgPSB3b3JrSW5Qcm9ncmVzc1NvdXJjZXNbaV07CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtdXRhYmxlU291cmNlLl93b3JrSW5Qcm9ncmVzc1ZlcnNpb25QcmltYXJ5ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3NTb3VyY2VzLmxlbmd0aCA9IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyTXV0YWJsZVNvdXJjZUZvckh5ZHJhdGlvbihyb290MywgbXV0YWJsZVNvdXJjZSkgewogICAgICAgICAgdmFyIGdldFZlcnNpb24gPSBtdXRhYmxlU291cmNlLl9nZXRWZXJzaW9uOwogICAgICAgICAgdmFyIHZlcnNpb242ID0gZ2V0VmVyc2lvbihtdXRhYmxlU291cmNlLl9zb3VyY2UpOwogICAgICAgICAgaWYgKHJvb3QzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEgPT0gbnVsbCkgewogICAgICAgICAgICByb290My5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhID0gW211dGFibGVTb3VyY2UsIHZlcnNpb242XTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJvb3QzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEucHVzaChtdXRhYmxlU291cmNlLCB2ZXJzaW9uNik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyLCBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QmF0Y2hDb25maWc7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3Q7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgdmFyIHJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSA9IG51bGw7CiAgICAgICAgdmFyIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NIb29rID0gbnVsbDsKICAgICAgICB2YXIgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MgPSBmYWxzZTsKICAgICAgICB2YXIgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgIHZhciBnbG9iYWxDbGllbnRJZENvdW50ZXIgPSAwOwogICAgICAgIHZhciBSRV9SRU5ERVJfTElNSVQgPSAyNTsKICAgICAgICB2YXIgY3VycmVudEhvb2tOYW1lSW5EZXYgPSBudWxsOwogICAgICAgIHZhciBob29rVHlwZXNEZXYgPSBudWxsOwogICAgICAgIHZhciBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgIHZhciBpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIG1vdW50SG9va1R5cGVzRGV2KCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9va05hbWUgPSBjdXJyZW50SG9va05hbWVJbkRldjsKICAgICAgICAgICAgaWYgKGhvb2tUeXBlc0RldiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IFtob29rTmFtZV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaG9va1R5cGVzRGV2LnB1c2goaG9va05hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvb2tUeXBlc0RldigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvb2tOYW1lID0gY3VycmVudEhvb2tOYW1lSW5EZXY7CiAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldisrOwogICAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXZbaG9va1R5cGVzVXBkYXRlSW5kZXhEZXZdICE9PSBob29rTmFtZSkgewogICAgICAgICAgICAgICAgd2Fybk9uSG9va01pc21hdGNoSW5EZXYoaG9va05hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkZXBzICE9PSB2b2lkIDAgJiYgZGVwcyAhPT0gbnVsbCAmJiAhaXNBcnJheTIoZGVwcykpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgcmVjZWl2ZWQgYSBmaW5hbCBhcmd1bWVudCB0aGF0IGlzIG5vdCBhbiBhcnJheSAoaW5zdGVhZCwgcmVjZWl2ZWQgYCVzYCkuIFdoZW4gc3BlY2lmaWVkLCB0aGUgZmluYWwgYXJndW1lbnQgbXVzdCBiZSBhbiBhcnJheS4iLCBjdXJyZW50SG9va05hbWVJbkRldiwgdHlwZW9mIGRlcHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Pbkhvb2tNaXNtYXRjaEluRGV2KGN1cnJlbnRIb29rTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSk7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50Lmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgaWYgKGhvb2tUeXBlc0RldiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHRhYmxlID0gIiI7CiAgICAgICAgICAgICAgICB2YXIgc2Vjb25kQ29sdW1uU3RhcnQgPSAzMDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIG9sZEhvb2tOYW1lID0gaG9va1R5cGVzRGV2W2ldOwogICAgICAgICAgICAgICAgICB2YXIgbmV3SG9va05hbWUgPSBpID09PSBob29rVHlwZXNVcGRhdGVJbmRleERldiA/IGN1cnJlbnRIb29rTmFtZSA6IG9sZEhvb2tOYW1lOwogICAgICAgICAgICAgICAgICB2YXIgcm93ID0gaSArIDEgKyAiLiAiICsgb2xkSG9va05hbWU7CiAgICAgICAgICAgICAgICAgIHdoaWxlIChyb3cubGVuZ3RoIDwgc2Vjb25kQ29sdW1uU3RhcnQpIHsKICAgICAgICAgICAgICAgICAgICByb3cgKz0gIiAiOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJvdyArPSBuZXdIb29rTmFtZSArICJcbiI7CiAgICAgICAgICAgICAgICAgIHRhYmxlICs9IHJvdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBoYXMgZGV0ZWN0ZWQgYSBjaGFuZ2UgaW4gdGhlIG9yZGVyIG9mIEhvb2tzIGNhbGxlZCBieSAlcy4gVGhpcyB3aWxsIGxlYWQgdG8gYnVncyBhbmQgZXJyb3JzIGlmIG5vdCBmaXhlZC4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHJlYWQgdGhlIFJ1bGVzIG9mIEhvb2tzOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcnVsZXMtb2YtaG9va3NcblxuICAgUHJldmlvdXMgcmVuZGVyICAgICAgICAgICAgTmV4dCByZW5kZXJcbiAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuJXMgICBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5cbiIsIGNvbXBvbmVudE5hbWUsIHRhYmxlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGhyb3dJbnZhbGlkSG9va0Vycm9yKCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGhvb2sgY2FsbC4gSG9va3MgY2FuIG9ubHkgYmUgY2FsbGVkIGluc2lkZSBvZiB0aGUgYm9keSBvZiBhIGZ1bmN0aW9uIGNvbXBvbmVudC4gVGhpcyBjb3VsZCBoYXBwZW4gZm9yIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlYXNvbnM6XG4xLiBZb3UgbWlnaHQgaGF2ZSBtaXNtYXRjaGluZyB2ZXJzaW9ucyBvZiBSZWFjdCBhbmQgdGhlIHJlbmRlcmVyIChzdWNoIGFzIFJlYWN0IERPTSlcbjIuIFlvdSBtaWdodCBiZSBicmVha2luZyB0aGUgUnVsZXMgb2YgSG9va3NcbjMuIFlvdSBtaWdodCBoYXZlIG1vcmUgdGhhbiBvbmUgY29weSBvZiBSZWFjdCBpbiB0aGUgc2FtZSBhcHBcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1ob29rLWNhbGwgZm9yIHRpcHMgYWJvdXQgaG93IHRvIGRlYnVnIGFuZCBmaXggdGhpcyBwcm9ibGVtLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcykgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByZXZEZXBzID09PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgcmVjZWl2ZWQgYSBmaW5hbCBhcmd1bWVudCBkdXJpbmcgdGhpcyByZW5kZXIsIGJ1dCBub3QgZHVyaW5nIHRoZSBwcmV2aW91cyByZW5kZXIuIEV2ZW4gdGhvdWdoIHRoZSBmaW5hbCBhcmd1bWVudCBpcyBvcHRpb25hbCwgaXRzIHR5cGUgY2Fubm90IGNoYW5nZSBiZXR3ZWVuIHJlbmRlcnMuIiwgY3VycmVudEhvb2tOYW1lSW5EZXYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5leHREZXBzLmxlbmd0aCAhPT0gcHJldkRlcHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBmaW5hbCBhcmd1bWVudCBwYXNzZWQgdG8gJXMgY2hhbmdlZCBzaXplIGJldHdlZW4gcmVuZGVycy4gVGhlIG9yZGVyIGFuZCBzaXplIG9mIHRoaXMgYXJyYXkgbXVzdCByZW1haW4gY29uc3RhbnQuXG5cblByZXZpb3VzOiAlc1xuSW5jb21pbmc6ICVzIiwgY3VycmVudEhvb2tOYW1lSW5EZXYsICJbIiArIHByZXZEZXBzLmpvaW4oIiwgIikgKyAiXSIsICJbIiArIG5leHREZXBzLmpvaW4oIiwgIikgKyAiXSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByZXZEZXBzLmxlbmd0aCAmJiBpIDwgbmV4dERlcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKG9iamVjdElzKG5leHREZXBzW2ldLCBwcmV2RGVwc1tpXSkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyV2l0aEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIHNlY29uZEFyZywgbmV4dFJlbmRlckxhbmVzKSB7CiAgICAgICAgICByZW5kZXJMYW5lcyA9IG5leHRSZW5kZXJMYW5lczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQuX2RlYnVnSG9va1R5cGVzIDogbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMgPSBjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgY3VycmVudDQubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgfSBlbHNlIGlmIChob29rVHlwZXNEZXYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uTW91bnRXaXRoSG9va1R5cGVzSW5ERVY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZHJlbiA9IENvbXBvbmVudChwcm9wcywgc2Vjb25kQXJnKTsKICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MpIHsKICAgICAgICAgICAgdmFyIG51bWJlck9mUmVSZW5kZXJzID0gMDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGZhbHNlOwogICAgICAgICAgICAgIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICAgICAgICBpZiAobnVtYmVyT2ZSZVJlbmRlcnMgPj0gUkVfUkVOREVSX0xJTUlUKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRvbyBtYW55IHJlLXJlbmRlcnMuIFJlYWN0IGxpbWl0cyB0aGUgbnVtYmVyIG9mIHJlbmRlcnMgdG8gcHJldmVudCBhbiBpbmZpbml0ZSBsb29wLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBudW1iZXJPZlJlUmVuZGVycyArPSAxOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlnbm9yZVByZXZpb3VzRGVwZW5kZW5jaWVzID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgY2hpbGRyZW4gPSBDb21wb25lbnQocHJvcHMsIHNlY29uZEFyZyk7CiAgICAgICAgICAgIH0gd2hpbGUgKGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyk7CiAgICAgICAgICB9CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z0hvb2tUeXBlcyA9IGhvb2tUeXBlc0RldjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkaWRSZW5kZXJUb29GZXdIb29rcyA9IGN1cnJlbnRIb29rICE9PSBudWxsICYmIGN1cnJlbnRIb29rLm5leHQgIT09IG51bGw7CiAgICAgICAgICByZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxID0gbnVsbDsKICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzRGV2ID0gbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmIChjdXJyZW50NC5mbGFncyAmIFN0YXRpY01hc2spICE9PSAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgU3RhdGljTWFzaykgJiYgLy8gRGlzYWJsZSB0aGlzIHdhcm5pbmcgaW4gbGVnYWN5IG1vZGUsIGJlY2F1c2UgbGVnYWN5IFN1c3BlbnNlIGlzIHdlaXJkCiAgICAgICAgICAgIC8vIGFuZCBjcmVhdGVzIGZhbHNlIHBvc2l0aXZlcy4gVG8gbWFrZSB0aGlzIHdvcmsgaW4gbGVnYWN5IG1vZGUsIHdlJ2QKICAgICAgICAgICAgLy8gbmVlZCB0byBtYXJrIGZpYmVycyB0aGF0IGNvbW1pdCBpbiBhbiBpbmNvbXBsZXRlIHN0YXRlLCBzb21laG93LiBGb3IKICAgICAgICAgICAgLy8gbm93IEknbGwgZGlzYWJsZSB0aGUgd2FybmluZyB0aGF0IG1vc3Qgb2YgdGhlIGJ1Z3MgdGhhdCB3b3VsZCB0cmlnZ2VyCiAgICAgICAgICAgIC8vIGl0IGFyZSBlaXRoZXIgZXhjbHVzaXZlIHRvIGNvbmN1cnJlbnQgbW9kZSBvciBleGlzdCBpbiBib3RoLgogICAgICAgICAgICAoY3VycmVudDQubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludGVybmFsIFJlYWN0IGVycm9yOiBFeHBlY3RlZCBzdGF0aWMgZmxhZyB3YXMgbWlzc2luZy4gUGxlYXNlIG5vdGlmeSB0aGUgUmVhY3QgdGVhbS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgaWYgKGRpZFJlbmRlclRvb0Zld0hvb2tzKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVuZGVyZWQgZmV3ZXIgaG9va3MgdGhhbiBleHBlY3RlZC4gVGhpcyBtYXkgYmUgY2F1c2VkIGJ5IGFuIGFjY2lkZW50YWwgZWFybHkgcmV0dXJuIHN0YXRlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tEaWRSZW5kZXJJZEhvb2soKSB7CiAgICAgICAgICB2YXIgZGlkUmVuZGVySWRIb29rID0gbG9jYWxJZENvdW50ZXIgIT09IDA7CiAgICAgICAgICBsb2NhbElkQ291bnRlciA9IDA7CiAgICAgICAgICByZXR1cm4gZGlkUmVuZGVySWRIb29rOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYWlsb3V0SG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbGFuZXMpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+KE1vdW50UGFzc2l2ZURldiB8IE1vdW50TGF5b3V0RGV2IHwgUGFzc2l2ZSB8IFVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfihQYXNzaXZlIHwgVXBkYXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnQ0LmxhbmVzID0gcmVtb3ZlTGFuZXMoY3VycmVudDQubGFuZXMsIGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRIb29rc0FmdGVyVGhyb3coKSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlKSB7CiAgICAgICAgICAgIHZhciBob29rID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB3aGlsZSAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBxdWV1ZSA9IGhvb2sucXVldWU7CiAgICAgICAgICAgICAgaWYgKHF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaG9vayA9IGhvb2submV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICByZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxID0gbnVsbDsKICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IG51bGw7CiAgICAgICAgICAgIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID0gLTE7CiAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gbnVsbDsKICAgICAgICAgICAgaXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZSA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZmFsc2U7CiAgICAgICAgICBsb2NhbElkQ291bnRlciA9IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCkgewogICAgICAgICAgdmFyIGhvb2sgPSB7CiAgICAgICAgICAgIG1lbW9pemVkU3RhdGU6IG51bGwsCiAgICAgICAgICAgIGJhc2VTdGF0ZTogbnVsbCwKICAgICAgICAgICAgYmFzZVF1ZXVlOiBudWxsLAogICAgICAgICAgICBxdWV1ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc0hvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlID0gd29ya0luUHJvZ3Jlc3NIb29rID0gaG9vazsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0ID0gaG9vazsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpIHsKICAgICAgICAgIHZhciBuZXh0Q3VycmVudEhvb2s7CiAgICAgICAgICBpZiAoY3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5leHRDdXJyZW50SG9vayA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dEN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dEN1cnJlbnRIb29rID0gY3VycmVudEhvb2submV4dDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0V29ya0luUHJvZ3Jlc3NIb29rOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzSG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICBuZXh0V29ya0luUHJvZ3Jlc3NIb29rID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dFdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5leHRXb3JrSW5Qcm9ncmVzc0hvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gbmV4dFdvcmtJblByb2dyZXNzSG9vazsKICAgICAgICAgICAgbmV4dFdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0OwogICAgICAgICAgICBjdXJyZW50SG9vayA9IG5leHRDdXJyZW50SG9vazsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChuZXh0Q3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlbmRlcmVkIG1vcmUgaG9va3MgdGhhbiBkdXJpbmcgdGhlIHByZXZpb3VzIHJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50SG9vayA9IG5leHRDdXJyZW50SG9vazsKICAgICAgICAgICAgdmFyIG5ld0hvb2sgPSB7CiAgICAgICAgICAgICAgbWVtb2l6ZWRTdGF0ZTogY3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZSwKICAgICAgICAgICAgICBiYXNlU3RhdGU6IGN1cnJlbnRIb29rLmJhc2VTdGF0ZSwKICAgICAgICAgICAgICBiYXNlUXVldWU6IGN1cnJlbnRIb29rLmJhc2VRdWV1ZSwKICAgICAgICAgICAgICBxdWV1ZTogY3VycmVudEhvb2sucXVldWUsCiAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlID0gd29ya0luUHJvZ3Jlc3NIb29rID0gbmV3SG9vazsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSB3b3JrSW5Qcm9ncmVzc0hvb2submV4dCA9IG5ld0hvb2s7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZ1bmN0aW9uQ29tcG9uZW50VXBkYXRlUXVldWUoKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBsYXN0RWZmZWN0OiBudWxsLAogICAgICAgICAgICBzdG9yZXM6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhc2ljU3RhdGVSZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICAgIHJldHVybiB0eXBlb2YgYWN0aW9uID09PSAiZnVuY3Rpb24iID8gYWN0aW9uKHN0YXRlKSA6IGFjdGlvbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBpbml0aWFsU3RhdGUxMzsKICAgICAgICAgIGlmIChpbml0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaW5pdGlhbFN0YXRlMTMgPSBpbml0KGluaXRpYWxBcmcpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5pdGlhbFN0YXRlMTMgPSBpbml0aWFsQXJnOwogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gaG9vay5iYXNlU3RhdGUgPSBpbml0aWFsU3RhdGUxMzsKICAgICAgICAgIHZhciBxdWV1ZSA9IHsKICAgICAgICAgICAgcGVuZGluZzogbnVsbCwKICAgICAgICAgICAgaW50ZXJsZWF2ZWQ6IG51bGwsCiAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICBkaXNwYXRjaDogbnVsbCwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkUmVkdWNlcjogcmVkdWNlciwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkU3RhdGU6IGluaXRpYWxTdGF0ZTEzCiAgICAgICAgICB9OwogICAgICAgICAgaG9vay5xdWV1ZSA9IHF1ZXVlOwogICAgICAgICAgdmFyIGRpc3BhdGNoID0gcXVldWUuZGlzcGF0Y2ggPSBkaXNwYXRjaFJlZHVjZXJBY3Rpb24uYmluZChudWxsLCBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLCBxdWV1ZSk7CiAgICAgICAgICByZXR1cm4gW2hvb2subWVtb2l6ZWRTdGF0ZSwgZGlzcGF0Y2hdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgcXVldWUgPSBob29rLnF1ZXVlOwogICAgICAgICAgaWYgKHF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIGhhdmUgYSBxdWV1ZS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUubGFzdFJlbmRlcmVkUmVkdWNlciA9IHJlZHVjZXI7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSBjdXJyZW50SG9vazsKICAgICAgICAgIHZhciBiYXNlUXVldWUgPSBjdXJyZW50NC5iYXNlUXVldWU7CiAgICAgICAgICB2YXIgcGVuZGluZ1F1ZXVlID0gcXVldWUucGVuZGluZzsKICAgICAgICAgIGlmIChwZW5kaW5nUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGJhc2VRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBiYXNlRmlyc3QgPSBiYXNlUXVldWUubmV4dDsKICAgICAgICAgICAgICB2YXIgcGVuZGluZ0ZpcnN0ID0gcGVuZGluZ1F1ZXVlLm5leHQ7CiAgICAgICAgICAgICAgYmFzZVF1ZXVlLm5leHQgPSBwZW5kaW5nRmlyc3Q7CiAgICAgICAgICAgICAgcGVuZGluZ1F1ZXVlLm5leHQgPSBiYXNlRmlyc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjdXJyZW50NC5iYXNlUXVldWUgIT09IGJhc2VRdWV1ZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludGVybmFsIGVycm9yOiBFeHBlY3RlZCB3b3JrLWluLXByb2dyZXNzIHF1ZXVlIHRvIGJlIGEgY2xvbmUuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnQ0LmJhc2VRdWV1ZSA9IGJhc2VRdWV1ZSA9IHBlbmRpbmdRdWV1ZTsKICAgICAgICAgICAgcXVldWUucGVuZGluZyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYmFzZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaXJzdCA9IGJhc2VRdWV1ZS5uZXh0OwogICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBjdXJyZW50NC5iYXNlU3RhdGU7CiAgICAgICAgICAgIHZhciBuZXdCYXNlU3RhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgbmV3QmFzZVF1ZXVlRmlyc3QgPSBudWxsOwogICAgICAgICAgICB2YXIgbmV3QmFzZVF1ZXVlTGFzdCA9IG51bGw7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBmaXJzdDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciB1cGRhdGVMYW5lID0gdXBkYXRlLmxhbmU7CiAgICAgICAgICAgICAgaWYgKCFpc1N1YnNldE9mTGFuZXMocmVuZGVyTGFuZXMsIHVwZGF0ZUxhbmUpKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgIGxhbmU6IHVwZGF0ZUxhbmUsCiAgICAgICAgICAgICAgICAgIGFjdGlvbjogdXBkYXRlLmFjdGlvbiwKICAgICAgICAgICAgICAgICAgaGFzRWFnZXJTdGF0ZTogdXBkYXRlLmhhc0VhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgIGVhZ2VyU3RhdGU6IHVwZGF0ZS5lYWdlclN0YXRlLAogICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaWYgKG5ld0Jhc2VRdWV1ZUxhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbmV3QmFzZVF1ZXVlRmlyc3QgPSBuZXdCYXNlUXVldWVMYXN0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbmV3QmFzZVF1ZXVlTGFzdCA9IG5ld0Jhc2VRdWV1ZUxhc3QubmV4dCA9IGNsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcyA9IG1lcmdlTGFuZXMoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcywgdXBkYXRlTGFuZSk7CiAgICAgICAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKHVwZGF0ZUxhbmUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAobmV3QmFzZVF1ZXVlTGFzdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgX2Nsb25lID0gewogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgdXBkYXRlIGlzIGdvaW5nIHRvIGJlIGNvbW1pdHRlZCBzbyB3ZSBuZXZlciB3YW50IHVuY29tbWl0CiAgICAgICAgICAgICAgICAgICAgLy8gaXQuIFVzaW5nIE5vTGFuZSB3b3JrcyBiZWNhdXNlIDAgaXMgYSBzdWJzZXQgb2YgYWxsIGJpdG1hc2tzLCBzbwogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgd2lsbCBuZXZlciBiZSBza2lwcGVkIGJ5IHRoZSBjaGVjayBhYm92ZS4KICAgICAgICAgICAgICAgICAgICBsYW5lOiBOb0xhbmUsCiAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiB1cGRhdGUuYWN0aW9uLAogICAgICAgICAgICAgICAgICAgIGhhc0VhZ2VyU3RhdGU6IHVwZGF0ZS5oYXNFYWdlclN0YXRlLAogICAgICAgICAgICAgICAgICAgIGVhZ2VyU3RhdGU6IHVwZGF0ZS5lYWdlclN0YXRlLAogICAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgbmV3QmFzZVF1ZXVlTGFzdCA9IG5ld0Jhc2VRdWV1ZUxhc3QubmV4dCA9IF9jbG9uZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1cGRhdGUuaGFzRWFnZXJTdGF0ZSkgewogICAgICAgICAgICAgICAgICBuZXdTdGF0ZSA9IHVwZGF0ZS5lYWdlclN0YXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IHVwZGF0ZS5hY3Rpb247CiAgICAgICAgICAgICAgICAgIG5ld1N0YXRlID0gcmVkdWNlcihuZXdTdGF0ZSwgYWN0aW9uKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKHVwZGF0ZSAhPT0gbnVsbCAmJiB1cGRhdGUgIT09IGZpcnN0KTsKICAgICAgICAgICAgaWYgKG5ld0Jhc2VRdWV1ZUxhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXdCYXNlUXVldWVMYXN0Lm5leHQgPSBuZXdCYXNlUXVldWVGaXJzdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIW9iamVjdElzKG5ld1N0YXRlLCBob29rLm1lbW9pemVkU3RhdGUpKSB7CiAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdCYXNlU3RhdGU7CiAgICAgICAgICAgIGhvb2suYmFzZVF1ZXVlID0gbmV3QmFzZVF1ZXVlTGFzdDsKICAgICAgICAgICAgcXVldWUubGFzdFJlbmRlcmVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYXN0SW50ZXJsZWF2ZWQgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgIGlmIChsYXN0SW50ZXJsZWF2ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGludGVybGVhdmVkID0gbGFzdEludGVybGVhdmVkOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIGludGVybGVhdmVkTGFuZSA9IGludGVybGVhdmVkLmxhbmU7CiAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcyA9IG1lcmdlTGFuZXMoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcywgaW50ZXJsZWF2ZWRMYW5lKTsKICAgICAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKGludGVybGVhdmVkTGFuZSk7CiAgICAgICAgICAgICAgaW50ZXJsZWF2ZWQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICB9IHdoaWxlIChpbnRlcmxlYXZlZCAhPT0gbGFzdEludGVybGVhdmVkKTsKICAgICAgICAgIH0gZWxzZSBpZiAoYmFzZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHF1ZXVlLmRpc3BhdGNoOwogICAgICAgICAgcmV0dXJuIFtob29rLm1lbW9pemVkU3RhdGUsIGRpc3BhdGNoXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVyZW5kZXJSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgcXVldWUgPSBob29rLnF1ZXVlOwogICAgICAgICAgaWYgKHF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIGhhdmUgYSBxdWV1ZS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUubGFzdFJlbmRlcmVkUmVkdWNlciA9IHJlZHVjZXI7CiAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSBxdWV1ZS5kaXNwYXRjaDsKICAgICAgICAgIHZhciBsYXN0UmVuZGVyUGhhc2VVcGRhdGUgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgdmFyIG5ld1N0YXRlID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKGxhc3RSZW5kZXJQaGFzZVVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgdmFyIGZpcnN0UmVuZGVyUGhhc2VVcGRhdGUgPSBsYXN0UmVuZGVyUGhhc2VVcGRhdGUubmV4dDsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGZpcnN0UmVuZGVyUGhhc2VVcGRhdGU7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gdXBkYXRlLmFjdGlvbjsKICAgICAgICAgICAgICBuZXdTdGF0ZSA9IHJlZHVjZXIobmV3U3RhdGUsIGFjdGlvbik7CiAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKHVwZGF0ZSAhPT0gZmlyc3RSZW5kZXJQaGFzZVVwZGF0ZSk7CiAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV3U3RhdGUsIGhvb2subWVtb2l6ZWRTdGF0ZSkpIHsKICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICBpZiAoaG9vay5iYXNlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gW25ld1N0YXRlLCBkaXNwYXRjaF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50TXV0YWJsZVNvdXJjZShzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTXV0YWJsZVNvdXJjZShzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMTsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0U25hcHNob3Q7CiAgICAgICAgICB2YXIgaXNIeWRyYXRpbmcyID0gZ2V0SXNIeWRyYXRpbmcoKTsKICAgICAgICAgIGlmIChpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgICAgaWYgKGdldFNlcnZlclNuYXBzaG90ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1pc3NpbmcgZ2V0U2VydmVyU25hcHNob3QsIHdoaWNoIGlzIHJlcXVpcmVkIGZvciBzZXJ2ZXItcmVuZGVyZWQgY29udGVudC4gV2lsbCByZXZlcnQgdG8gY2xpZW50IHJlbmRlcmluZy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0U25hcHNob3QgPSBnZXRTZXJ2ZXJTbmFwc2hvdCgpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCkgewogICAgICAgICAgICAgICAgaWYgKG5leHRTbmFwc2hvdCAhPT0gZ2V0U2VydmVyU25hcHNob3QoKSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiVGhlIHJlc3VsdCBvZiBnZXRTZXJ2ZXJTbmFwc2hvdCBzaG91bGQgYmUgY2FjaGVkIHRvIGF2b2lkIGFuIGluZmluaXRlIGxvb3AiKTsKICAgICAgICAgICAgICAgICAgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgICAgICAgIHZhciBjYWNoZWRTbmFwc2hvdCA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICAgICAgICBpZiAoIW9iamVjdElzKG5leHRTbmFwc2hvdCwgY2FjaGVkU25hcHNob3QpKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgcmVzdWx0IG9mIGdldFNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgICBpZiAocm9vdDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGEgd29yay1pbi1wcm9ncmVzcyByb290LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCByZW5kZXJMYW5lcykpIHsKICAgICAgICAgICAgICBwdXNoU3RvcmVDb25zaXN0ZW5jeUNoZWNrKGZpYmVyLCBnZXRTbmFwc2hvdCwgbmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgdmFyIGluc3QgPSB7CiAgICAgICAgICAgIHZhbHVlOiBuZXh0U25hcHNob3QsCiAgICAgICAgICAgIGdldFNuYXBzaG90CiAgICAgICAgICB9OwogICAgICAgICAgaG9vay5xdWV1ZSA9IGluc3Q7CiAgICAgICAgICBtb3VudEVmZmVjdChzdWJzY3JpYmVUb1N0b3JlLmJpbmQobnVsbCwgZmliZXIsIGluc3QsIHN1YnNjcmliZSksIFtzdWJzY3JpYmVdKTsKICAgICAgICAgIGZpYmVyLmZsYWdzIHw9IFBhc3NpdmU7CiAgICAgICAgICBwdXNoRWZmZWN0KEhhc0VmZmVjdCB8IFBhc3NpdmUkMSwgdXBkYXRlU3RvcmVJbnN0YW5jZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBuZXh0U25hcHNob3QsIGdldFNuYXBzaG90KSwgdm9pZCAwLCBudWxsKTsKICAgICAgICAgIHJldHVybiBuZXh0U25hcHNob3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxOwogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0U25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90KSB7CiAgICAgICAgICAgICAgdmFyIGNhY2hlZFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgICAgICBpZiAoIW9iamVjdElzKG5leHRTbmFwc2hvdCwgY2FjaGVkU25hcHNob3QpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIHJlc3VsdCBvZiBnZXRTbmFwc2hvdCBzaG91bGQgYmUgY2FjaGVkIHRvIGF2b2lkIGFuIGluZmluaXRlIGxvb3AiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2U25hcHNob3QgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgc25hcHNob3RDaGFuZ2VkID0gIW9iamVjdElzKHByZXZTbmFwc2hvdCwgbmV4dFNuYXBzaG90KTsKICAgICAgICAgIGlmIChzbmFwc2hvdENoYW5nZWQpIHsKICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluc3QgPSBob29rLnF1ZXVlOwogICAgICAgICAgdXBkYXRlRWZmZWN0KHN1YnNjcmliZVRvU3RvcmUuYmluZChudWxsLCBmaWJlciwgaW5zdCwgc3Vic2NyaWJlKSwgW3N1YnNjcmliZV0pOwogICAgICAgICAgaWYgKGluc3QuZ2V0U25hcHNob3QgIT09IGdldFNuYXBzaG90IHx8IHNuYXBzaG90Q2hhbmdlZCB8fCAvLyBDaGVjayBpZiB0aGUgc3VzYmNyaWJlIGZ1bmN0aW9uIGNoYW5nZWQuIFdlIGNhbiBzYXZlIHNvbWUgbWVtb3J5IGJ5CiAgICAgICAgICAvLyBjaGVja2luZyB3aGV0aGVyIHdlIHNjaGVkdWxlZCBhIHN1YnNjcmlwdGlvbiBlZmZlY3QgYWJvdmUuCiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgIT09IG51bGwgJiYgd29ya0luUHJvZ3Jlc3NIb29rLm1lbW9pemVkU3RhdGUudGFnICYgSGFzRWZmZWN0KSB7CiAgICAgICAgICAgIGZpYmVyLmZsYWdzIHw9IFBhc3NpdmU7CiAgICAgICAgICAgIHB1c2hFZmZlY3QoSGFzRWZmZWN0IHwgUGFzc2l2ZSQxLCB1cGRhdGVTdG9yZUluc3RhbmNlLmJpbmQobnVsbCwgZmliZXIsIGluc3QsIG5leHRTbmFwc2hvdCwgZ2V0U25hcHNob3QpLCB2b2lkIDAsIG51bGwpOwogICAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgICAgaWYgKHJvb3QzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBhIHdvcmstaW4tcHJvZ3Jlc3Mgcm9vdC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgcmVuZGVyTGFuZXMpKSB7CiAgICAgICAgICAgICAgcHVzaFN0b3JlQ29uc2lzdGVuY3lDaGVjayhmaWJlciwgZ2V0U25hcHNob3QsIG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXh0U25hcHNob3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hTdG9yZUNvbnNpc3RlbmN5Q2hlY2soZmliZXIsIGdldFNuYXBzaG90LCByZW5kZXJlZFNuYXBzaG90KSB7CiAgICAgICAgICBmaWJlci5mbGFncyB8PSBTdG9yZUNvbnNpc3RlbmN5OwogICAgICAgICAgdmFyIGNoZWNrID0gewogICAgICAgICAgICBnZXRTbmFwc2hvdCwKICAgICAgICAgICAgdmFsdWU6IHJlbmRlcmVkU25hcHNob3QKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29tcG9uZW50VXBkYXRlUXVldWUgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKGNvbXBvbmVudFVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3JlYXRlRnVuY3Rpb25Db21wb25lbnRVcGRhdGVRdWV1ZSgpOwogICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlID0gY29tcG9uZW50VXBkYXRlUXVldWU7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLnN0b3JlcyA9IFtjaGVja107CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgc3RvcmVzID0gY29tcG9uZW50VXBkYXRlUXVldWUuc3RvcmVzOwogICAgICAgICAgICBpZiAoc3RvcmVzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUuc3RvcmVzID0gW2NoZWNrXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdG9yZXMucHVzaChjaGVjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3RvcmVJbnN0YW5jZShmaWJlciwgaW5zdCwgbmV4dFNuYXBzaG90LCBnZXRTbmFwc2hvdCkgewogICAgICAgICAgaW5zdC52YWx1ZSA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgIGluc3QuZ2V0U25hcHNob3QgPSBnZXRTbmFwc2hvdDsKICAgICAgICAgIGlmIChjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpKSB7CiAgICAgICAgICAgIGZvcmNlU3RvcmVSZXJlbmRlcihmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN1YnNjcmliZVRvU3RvcmUoZmliZXIsIGluc3QsIHN1YnNjcmliZSkgewogICAgICAgICAgdmFyIGhhbmRsZVN0b3JlQ2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpKSB7CiAgICAgICAgICAgICAgZm9yY2VTdG9yZVJlcmVuZGVyKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiBzdWJzY3JpYmUoaGFuZGxlU3RvcmVDaGFuZ2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpIHsKICAgICAgICAgIHZhciBsYXRlc3RHZXRTbmFwc2hvdCA9IGluc3QuZ2V0U25hcHNob3Q7CiAgICAgICAgICB2YXIgcHJldlZhbHVlID0gaW5zdC52YWx1ZTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBsYXRlc3RHZXRTbmFwc2hvdCgpOwogICAgICAgICAgICByZXR1cm4gIW9iamVjdElzKHByZXZWYWx1ZSwgbmV4dFZhbHVlKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yY2VTdG9yZVJlcmVuZGVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN0YXRlKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICBpZiAodHlwZW9mIGluaXRpYWxTdGF0ZTEzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluaXRpYWxTdGF0ZTEzID0gaW5pdGlhbFN0YXRlMTMoKTsKICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IGhvb2suYmFzZVN0YXRlID0gaW5pdGlhbFN0YXRlMTM7CiAgICAgICAgICB2YXIgcXVldWUgPSB7CiAgICAgICAgICAgIHBlbmRpbmc6IG51bGwsCiAgICAgICAgICAgIGludGVybGVhdmVkOiBudWxsLAogICAgICAgICAgICBsYW5lczogTm9MYW5lcywKICAgICAgICAgICAgZGlzcGF0Y2g6IG51bGwsCiAgICAgICAgICAgIGxhc3RSZW5kZXJlZFJlZHVjZXI6IGJhc2ljU3RhdGVSZWR1Y2VyLAogICAgICAgICAgICBsYXN0UmVuZGVyZWRTdGF0ZTogaW5pdGlhbFN0YXRlMTMKICAgICAgICAgIH07CiAgICAgICAgICBob29rLnF1ZXVlID0gcXVldWU7CiAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSBxdWV1ZS5kaXNwYXRjaCA9IGRpc3BhdGNoU2V0U3RhdGUuYmluZChudWxsLCBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLCBxdWV1ZSk7CiAgICAgICAgICByZXR1cm4gW2hvb2subWVtb2l6ZWRTdGF0ZSwgZGlzcGF0Y2hdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdGF0ZShpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIoYmFzaWNTdGF0ZVJlZHVjZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclN0YXRlKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICByZXR1cm4gcmVyZW5kZXJSZWR1Y2VyKGJhc2ljU3RhdGVSZWR1Y2VyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEVmZmVjdCh0YWcsIGNyZWF0ZSwgZGVzdHJveSwgZGVwcykgewogICAgICAgICAgdmFyIGVmZmVjdCA9IHsKICAgICAgICAgICAgdGFnLAogICAgICAgICAgICBjcmVhdGUsCiAgICAgICAgICAgIGRlc3Ryb3ksCiAgICAgICAgICAgIGRlcHMsCiAgICAgICAgICAgIC8vIENpcmN1bGFyCiAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29tcG9uZW50VXBkYXRlUXVldWUgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKGNvbXBvbmVudFVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3JlYXRlRnVuY3Rpb25Db21wb25lbnRVcGRhdGVRdWV1ZSgpOwogICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlID0gY29tcG9uZW50VXBkYXRlUXVldWU7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgPSBlZmZlY3QubmV4dCA9IGVmZmVjdDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gY29tcG9uZW50VXBkYXRlUXVldWUubGFzdEVmZmVjdDsKICAgICAgICAgICAgaWYgKGxhc3RFZmZlY3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0Lm5leHQgPSBlZmZlY3Q7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0RWZmZWN0ID0gbGFzdEVmZmVjdC5uZXh0OwogICAgICAgICAgICAgIGxhc3RFZmZlY3QubmV4dCA9IGVmZmVjdDsKICAgICAgICAgICAgICBlZmZlY3QubmV4dCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgPSBlZmZlY3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlZmZlY3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50UmVmKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgX3JlZjIgPSB7CiAgICAgICAgICAgICAgY3VycmVudDogaW5pdGlhbFZhbHVlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IF9yZWYyOwogICAgICAgICAgICByZXR1cm4gX3JlZjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVJlZihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICByZXR1cm4gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEVmZmVjdEltcGwoZmliZXJGbGFncywgaG9va0ZsYWdzLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBob29rRmxhZ3MsIGNyZWF0ZSwgdm9pZCAwLCBuZXh0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUVmZmVjdEltcGwoZmliZXJGbGFncywgaG9va0ZsYWdzLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBkZXN0cm95ID0gdm9pZCAwOwogICAgICAgICAgaWYgKGN1cnJlbnRIb29rICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBwcmV2RWZmZWN0ID0gY3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgZGVzdHJveSA9IHByZXZFZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgaWYgKG5leHREZXBzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZEZXBzID0gcHJldkVmZmVjdC5kZXBzOwogICAgICAgICAgICAgIGlmIChhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSkgewogICAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChob29rRmxhZ3MsIGNyZWF0ZSwgZGVzdHJveSwgbmV4dERlcHMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBob29rRmxhZ3MsIGNyZWF0ZSwgZGVzdHJveSwgbmV4dERlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIGlmICgoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChNb3VudFBhc3NpdmVEZXYgfCBQYXNzaXZlIHwgUGFzc2l2ZVN0YXRpYywgUGFzc2l2ZSQxLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChQYXNzaXZlIHwgUGFzc2l2ZVN0YXRpYywgUGFzc2l2ZSQxLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChQYXNzaXZlLCBQYXNzaXZlJDEsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChVcGRhdGUsIEluc2VydGlvbiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoVXBkYXRlLCBJbnNlcnRpb24sIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChmaWJlckZsYWdzLCBMYXlvdXQsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3RJbXBsKFVwZGF0ZSwgTGF5b3V0LCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbXBlcmF0aXZlSGFuZGxlRWZmZWN0KGNyZWF0ZSwgcmVmKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgcmVmQ2FsbGJhY2sgPSByZWY7CiAgICAgICAgICAgIHZhciBfaW5zdCA9IGNyZWF0ZSgpOwogICAgICAgICAgICByZWZDYWxsYmFjayhfaW5zdCk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZWZDYWxsYmFjayhudWxsKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVmICE9PSBudWxsICYmIHJlZiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhciByZWZPYmplY3QgPSByZWY7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIXJlZk9iamVjdC5oYXNPd25Qcm9wZXJ0eSgiY3VycmVudCIpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdXNlSW1wZXJhdGl2ZUhhbmRsZSgpIGZpcnN0IGFyZ3VtZW50IHRvIGVpdGhlciBiZSBhIHJlZiBjYWxsYmFjayBvciBSZWFjdC5jcmVhdGVSZWYoKSBvYmplY3QuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsICJhbiBvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMocmVmT2JqZWN0KS5qb2luKCIsICIpICsgIn0iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9pbnN0MiA9IGNyZWF0ZSgpOwogICAgICAgICAgICByZWZPYmplY3QuY3VycmVudCA9IF9pbnN0MjsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJlZk9iamVjdC5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3JlYXRlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHVzZUltcGVyYXRpdmVIYW5kbGUoKSBzZWNvbmQgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbiB0aGF0IGNyZWF0ZXMgYSBoYW5kbGUuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNyZWF0ZSAhPT0gbnVsbCA/IHR5cGVvZiBjcmVhdGUgOiAibnVsbCIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWZmZWN0RGVwcyA9IGRlcHMgIT09IG51bGwgJiYgZGVwcyAhPT0gdm9pZCAwID8gZGVwcy5jb25jYXQoW3JlZl0pIDogbnVsbDsKICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoZmliZXJGbGFncywgTGF5b3V0LCBpbXBlcmF0aXZlSGFuZGxlRWZmZWN0LmJpbmQobnVsbCwgY3JlYXRlLCByZWYpLCBlZmZlY3REZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNyZWF0ZSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB1c2VJbXBlcmF0aXZlSGFuZGxlKCkgc2Vjb25kIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24gdGhhdCBjcmVhdGVzIGEgaGFuZGxlLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjcmVhdGUgIT09IG51bGwgPyB0eXBlb2YgY3JlYXRlIDogIm51bGwiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVmZmVjdERlcHMgPSBkZXBzICE9PSBudWxsICYmIGRlcHMgIT09IHZvaWQgMCA/IGRlcHMuY29uY2F0KFtyZWZdKSA6IG51bGw7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChVcGRhdGUsIExheW91dCwgaW1wZXJhdGl2ZUhhbmRsZUVmZmVjdC5iaW5kKG51bGwsIGNyZWF0ZSwgcmVmKSwgZWZmZWN0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RGVidWdWYWx1ZSh2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICB9CiAgICAgICAgdmFyIHVwZGF0ZURlYnVnVmFsdWUgPSBtb3VudERlYnVnVmFsdWU7CiAgICAgICAgZnVuY3Rpb24gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbY2FsbGJhY2ssIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBjYWxsYmFjazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChuZXh0RGVwcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2RGVwcyA9IHByZXZTdGF0ZVsxXTsKICAgICAgICAgICAgICBpZiAoYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGVbMF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbY2FsbGJhY2ssIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBjYWxsYmFjazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRNZW1vKG5leHRDcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IG5leHRDcmVhdGUoKTsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IFtuZXh0VmFsdWUsIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBuZXh0VmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1lbW8obmV4dENyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5leHREZXBzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZEZXBzID0gcHJldlN0YXRlWzFdOwogICAgICAgICAgICAgIGlmIChhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZVswXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBuZXh0Q3JlYXRlKCk7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbbmV4dFZhbHVlLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gbmV4dFZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHZhbHVlOwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVEZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHJlc29sdmVkQ3VycmVudEhvb2sgPSBjdXJyZW50SG9vazsKICAgICAgICAgIHZhciBwcmV2VmFsdWUgPSByZXNvbHZlZEN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZUltcGwoaG9vaywgcHJldlZhbHVlLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGlmIChjdXJyZW50SG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHByZXZWYWx1ZSA9IGN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWZlcnJlZFZhbHVlSW1wbChob29rLCBwcmV2VmFsdWUsIHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRGVmZXJyZWRWYWx1ZUltcGwoaG9vaywgcHJldlZhbHVlLCB2YWx1ZSkgewogICAgICAgICAgdmFyIHNob3VsZERlZmVyVmFsdWUgPSAhaW5jbHVkZXNPbmx5Tm9uVXJnZW50TGFuZXMocmVuZGVyTGFuZXMpOwogICAgICAgICAgaWYgKHNob3VsZERlZmVyVmFsdWUpIHsKICAgICAgICAgICAgaWYgKCFvYmplY3RJcyh2YWx1ZSwgcHJldlZhbHVlKSkgewogICAgICAgICAgICAgIHZhciBkZWZlcnJlZExhbmUgPSBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpOwogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMgPSBtZXJnZUxhbmVzKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMsIGRlZmVycmVkTGFuZSk7CiAgICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyhkZWZlcnJlZExhbmUpOwogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHJldlZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGhvb2suYmFzZVN0YXRlKSB7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHZhbHVlOwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0VHJhbnNpdGlvbihzZXRQZW5kaW5nLCBjYWxsYmFjaywgb3B0aW9uczIpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoaGlnaGVyRXZlbnRQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5LCBDb250aW51b3VzRXZlbnRQcmlvcml0eSkpOwogICAgICAgICAgc2V0UGVuZGluZyh0cnVlKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbjsKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbiA9IHt9OwogICAgICAgICAgdmFyIGN1cnJlbnRUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uOwogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2V0UGVuZGluZyhmYWxzZSk7CiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHByZXZUcmFuc2l0aW9uID09PSBudWxsICYmIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlZEZpYmVyc0NvdW50ID0gY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuc2l6ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVkRmliZXJzQ291bnQgPiAxMCkgewogICAgICAgICAgICAgICAgICB3YXJuMygiRGV0ZWN0ZWQgYSBsYXJnZSBudW1iZXIgb2YgdXBkYXRlcyBpbnNpZGUgc3RhcnRUcmFuc2l0aW9uLiBJZiB0aGlzIGlzIGR1ZSB0byBhIHN1YnNjcmlwdGlvbiBwbGVhc2UgcmUtd3JpdGUgaXQgdG8gdXNlIFJlYWN0IHByb3ZpZGVkIGhvb2tzLiBPdGhlcndpc2UgY29uY3VycmVudCBtb2RlIGd1YXJhbnRlZXMgYXJlIG9mZiB0aGUgdGFibGUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5jbGVhcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX21vdW50U3RhdGUgPSBtb3VudFN0YXRlKGZhbHNlKSwgaXNQZW5kaW5nID0gX21vdW50U3RhdGVbMF0sIHNldFBlbmRpbmcgPSBfbW91bnRTdGF0ZVsxXTsKICAgICAgICAgIHZhciBzdGFydCA9IHN0YXJ0VHJhbnNpdGlvbi5iaW5kKG51bGwsIHNldFBlbmRpbmcpOwogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gc3RhcnQ7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVUcmFuc2l0aW9uKCkgewogICAgICAgICAgdmFyIF91cGRhdGVTdGF0ZSA9IHVwZGF0ZVN0YXRlKCksIGlzUGVuZGluZyA9IF91cGRhdGVTdGF0ZVswXTsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgc3RhcnQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX3JlcmVuZGVyU3RhdGUgPSByZXJlbmRlclN0YXRlKCksIGlzUGVuZGluZyA9IF9yZXJlbmRlclN0YXRlWzBdOwogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBzdGFydCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBbaXNQZW5kaW5nLCBzdGFydF07CiAgICAgICAgfQogICAgICAgIHZhciBpc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZUluREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gaXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJZCgpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSByb290My5pZGVudGlmaWVyUHJlZml4OwogICAgICAgICAgdmFyIGlkOwogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgdmFyIHRyZWVJZCA9IGdldFRyZWVJZCgpOwogICAgICAgICAgICBpZCA9ICI6IiArIGlkZW50aWZpZXJQcmVmaXggKyAiUiIgKyB0cmVlSWQ7CiAgICAgICAgICAgIHZhciBsb2NhbElkID0gbG9jYWxJZENvdW50ZXIrKzsKICAgICAgICAgICAgaWYgKGxvY2FsSWQgPiAwKSB7CiAgICAgICAgICAgICAgaWQgKz0gIkgiICsgbG9jYWxJZC50b1N0cmluZygzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWQgKz0gIjoiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGdsb2JhbENsaWVudElkID0gZ2xvYmFsQ2xpZW50SWRDb3VudGVyKys7CiAgICAgICAgICAgIGlkID0gIjoiICsgaWRlbnRpZmllclByZWZpeCArICJyIiArIGdsb2JhbENsaWVudElkLnRvU3RyaW5nKDMyKSArICI6IjsKICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IGlkOwogICAgICAgICAgcmV0dXJuIGlkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVJZCgpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgaWQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gaWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoUmVkdWNlckFjdGlvbihmaWJlciwgcXVldWUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJTdGF0ZSB1cGRhdGVzIGZyb20gdGhlIHVzZVN0YXRlKCkgYW5kIHVzZVJlZHVjZXIoKSBIb29rcyBkb24ndCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gdGhlIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgYWN0aW9uLAogICAgICAgICAgICBoYXNFYWdlclN0YXRlOiBmYWxzZSwKICAgICAgICAgICAgZWFnZXJTdGF0ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSkgewogICAgICAgICAgICBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hTZXRTdGF0ZShmaWJlciwgcXVldWUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJTdGF0ZSB1cGRhdGVzIGZyb20gdGhlIHVzZVN0YXRlKCkgYW5kIHVzZVJlZHVjZXIoKSBIb29rcyBkb24ndCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gdGhlIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgYWN0aW9uLAogICAgICAgICAgICBoYXNFYWdlclN0YXRlOiBmYWxzZSwKICAgICAgICAgICAgZWFnZXJTdGF0ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSkgewogICAgICAgICAgICBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoZmliZXIubGFuZXMgPT09IE5vTGFuZXMgJiYgKGFsdGVybmF0ZSA9PT0gbnVsbCB8fCBhbHRlcm5hdGUubGFuZXMgPT09IE5vTGFuZXMpKSB7CiAgICAgICAgICAgICAgdmFyIGxhc3RSZW5kZXJlZFJlZHVjZXIgPSBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyOwogICAgICAgICAgICAgIGlmIChsYXN0UmVuZGVyZWRSZWR1Y2VyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFN0YXRlID0gcXVldWUubGFzdFJlbmRlcmVkU3RhdGU7CiAgICAgICAgICAgICAgICAgIHZhciBlYWdlclN0YXRlID0gbGFzdFJlbmRlcmVkUmVkdWNlcihjdXJyZW50U3RhdGUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZS5oYXNFYWdlclN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdXBkYXRlLmVhZ2VyU3RhdGUgPSBlYWdlclN0YXRlOwogICAgICAgICAgICAgICAgICBpZiAob2JqZWN0SXMoZWFnZXJTdGF0ZSwgY3VycmVudFN0YXRlKSkgewogICAgICAgICAgICAgICAgICAgIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZUFuZEVhZ2VybHlCYWlsb3V0KGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvblVwZGF0ZShyb290MywgcXVldWUsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrVXBkYXRlSW5EZXZUb29scyhmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICByZXR1cm4gZmliZXIgPT09IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgfHwgYWx0ZXJuYXRlICE9PSBudWxsICYmIGFsdGVybmF0ZSA9PT0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVJlbmRlclBoYXNlVXBkYXRlKHF1ZXVlLCB1cGRhdGUpIHsKICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSB0cnVlOwogICAgICAgICAgdmFyIHBlbmRpbmcgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgaWYgKHBlbmRpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHBlbmRpbmcubmV4dDsKICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUucGVuZGluZyA9IHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSkgewogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbkxhbmUobGFuZSkpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlTGFuZXMgPSBxdWV1ZS5sYW5lczsKICAgICAgICAgICAgcXVldWVMYW5lcyA9IGludGVyc2VjdExhbmVzKHF1ZXVlTGFuZXMsIHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgICAgIHZhciBuZXdRdWV1ZUxhbmVzID0gbWVyZ2VMYW5lcyhxdWV1ZUxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgcXVldWUubGFuZXMgPSBuZXdRdWV1ZUxhbmVzOwogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbmV3UXVldWVMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lLCBhY3Rpb24pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIENvbnRleHRPbmx5RGlzcGF0Y2hlciA9IHsKICAgICAgICAgIHJlYWRDb250ZXh0LAogICAgICAgICAgdXNlQ2FsbGJhY2s6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUNvbnRleHQ6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUVmZmVjdDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZU1lbW86IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVJlZHVjZXI6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVJlZjogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlU3RhdGU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZURlYnVnVmFsdWU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVRyYW5zaXRpb246IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VJZDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgfTsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gbnVsbDsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25Nb3VudFdpdGhIb29rVHlwZXNJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gbnVsbDsKICAgICAgICB2YXIgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWID0gbnVsbDsKICAgICAgICB7CiAgICAgICAgICB2YXIgd2FybkludmFsaWRDb250ZXh0QWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVycm9yKCJDb250ZXh0IGNhbiBvbmx5IGJlIHJlYWQgd2hpbGUgUmVhY3QgaXMgcmVuZGVyaW5nLiBJbiBjbGFzc2VzLCB5b3UgY2FuIHJlYWQgaXQgaW4gdGhlIHJlbmRlciBtZXRob2Qgb3IgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBJbiBmdW5jdGlvbiBjb21wb25lbnRzLCB5b3UgY2FuIHJlYWQgaXQgZGlyZWN0bHkgaW4gdGhlIGZ1bmN0aW9uIGJvZHksIGJ1dCBub3QgaW5zaWRlIEhvb2tzIGxpa2UgdXNlUmVkdWNlcigpIG9yIHVzZU1lbW8oKS4iKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkludmFsaWRIb29rQWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVycm9yKCJEbyBub3QgY2FsbCBIb29rcyBpbnNpZGUgdXNlRWZmZWN0KC4uLiksIHVzZU1lbW8oLi4uKSwgb3Igb3RoZXIgYnVpbHQtaW4gSG9va3MuIFlvdSBjYW4gb25seSBjYWxsIEhvb2tzIGF0IHRoZSB0b3AgbGV2ZWwgb2YgeW91ciBSZWFjdCBmdW5jdGlvbi4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcnVsZXMtb2YtaG9va3MiKTsKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPbk1vdW50V2l0aEhvb2tUeXBlc0luREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudENhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZihpbml0aWFsVmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudElkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlckRlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICB3YXJuSW52YWxpZENvbnRleHRBY2Nlc3MoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlckRlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIG5vdyQxID0gU2NoZWR1bGVyLnVuc3RhYmxlX25vdzsKICAgICAgICB2YXIgY29tbWl0VGltZSA9IDA7CiAgICAgICAgdmFyIGxheW91dEVmZmVjdFN0YXJ0VGltZSA9IC0xOwogICAgICAgIHZhciBwcm9maWxlclN0YXJ0VGltZSA9IC0xOwogICAgICAgIHZhciBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgdmFyIGN1cnJlbnRVcGRhdGVJc05lc3RlZCA9IGZhbHNlOwogICAgICAgIHZhciBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBpc0N1cnJlbnRVcGRhdGVOZXN0ZWQoKSB7CiAgICAgICAgICByZXR1cm4gY3VycmVudFVwZGF0ZUlzTmVzdGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrTmVzdGVkVXBkYXRlU2NoZWR1bGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldE5lc3RlZFVwZGF0ZUZsYWcoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRVcGRhdGVJc05lc3RlZCA9IGZhbHNlOwogICAgICAgICAgICBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3luY05lc3RlZFVwZGF0ZUZsYWcoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRVcGRhdGVJc05lc3RlZCA9IG5lc3RlZFVwZGF0ZVNjaGVkdWxlZDsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbW1pdFRpbWUoKSB7CiAgICAgICAgICByZXR1cm4gY29tbWl0VGltZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb3JkQ29tbWl0VGltZSgpIHsKICAgICAgICAgIGNvbW1pdFRpbWUgPSBub3ckMSgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFByb2ZpbGVyVGltZXIoZmliZXIpIHsKICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICAgIGlmIChmaWJlci5hY3R1YWxTdGFydFRpbWUgPCAwKSB7CiAgICAgICAgICAgIGZpYmVyLmFjdHVhbFN0YXJ0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nKGZpYmVyKSB7CiAgICAgICAgICBwcm9maWxlclN0YXJ0VGltZSA9IC0xOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKGZpYmVyLCBvdmVycmlkZUJhc2VUaW1lKSB7CiAgICAgICAgICBpZiAocHJvZmlsZXJTdGFydFRpbWUgPj0gMCkgewogICAgICAgICAgICB2YXIgZWxhcHNlZFRpbWUgPSBub3ckMSgpIC0gcHJvZmlsZXJTdGFydFRpbWU7CiAgICAgICAgICAgIGZpYmVyLmFjdHVhbER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICBpZiAob3ZlcnJpZGVCYXNlVGltZSkgewogICAgICAgICAgICAgIGZpYmVyLnNlbGZCYXNlRHVyYXRpb24gPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwcm9maWxlclN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaWJlcikgewogICAgICAgICAgaWYgKGxheW91dEVmZmVjdFN0YXJ0VGltZSA+PSAwKSB7CiAgICAgICAgICAgIHZhciBlbGFwc2VkVGltZSA9IG5vdyQxKCkgLSBsYXlvdXRFZmZlY3RTdGFydFRpbWU7CiAgICAgICAgICAgIGxheW91dEVmZmVjdFN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgICB2YXIgcGFyZW50RmliZXIgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgIHdoaWxlIChwYXJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50RmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHJvb3QzLmVmZmVjdER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50U3RhdGVOb2RlID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBwYXJlbnRTdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb3JkUGFzc2l2ZUVmZmVjdER1cmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICBpZiAocGFzc2l2ZUVmZmVjdFN0YXJ0VGltZSA+PSAwKSB7CiAgICAgICAgICAgIHZhciBlbGFwc2VkVGltZSA9IG5vdyQxKCkgLSBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lOwogICAgICAgICAgICBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgd2hpbGUgKHBhcmVudEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcm9vdDMucGFzc2l2ZUVmZmVjdER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRTdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnRTdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpIHsKICAgICAgICAgIGxheW91dEVmZmVjdFN0YXJ0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCkgewogICAgICAgICAgcGFzc2l2ZUVmZmVjdFN0YXJ0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24oZmliZXIpIHsKICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgd2hpbGUgKGNoaWxkKSB7CiAgICAgICAgICAgIGZpYmVyLmFjdHVhbER1cmF0aW9uICs9IGNoaWxkLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVEZWZhdWx0UHJvcHMyKENvbXBvbmVudCwgYmFzZVByb3BzKSB7CiAgICAgICAgICBpZiAoQ29tcG9uZW50ICYmIENvbXBvbmVudC5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgdmFyIHByb3BzID0gYXNzaWduMih7fSwgYmFzZVByb3BzKTsKICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IENvbXBvbmVudC5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGZvciAodmFyIHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByb3BzOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJhc2VQcm9wczsKICAgICAgICB9CiAgICAgICAgdmFyIGZha2VJbnRlcm5hbEluc3RhbmNlID0ge307CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuZGVmaW5lZERlcml2ZWRTdGF0ZTsKICAgICAgICB2YXIgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlOwogICAgICAgIHZhciB3YXJuT25JbnZhbGlkQ2FsbGJhY2s7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDE7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dFVuaW5pdGlhbGl6ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5TGlmZWN5Y2xlc0FuZERlcml2ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXREaXJlY3RseUFzc2lnbmluZ1Byb3BzVG9TdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRVbmRlZmluZWREZXJpdmVkU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVBbmRDb250ZXh0VHlwZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB2YXIgZGlkV2Fybk9uSW52YWxpZENhbGxiYWNrID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayA9PT0gbnVsbCB8fCB0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGtleSA9IGNhbGxlck5hbWUgKyAiXyIgKyBjYWxsYmFjazsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2suaGFzKGtleSkpIHsKICAgICAgICAgICAgICBkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2suYWRkKGtleSk7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGVyTmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlID0gZnVuY3Rpb24odHlwZSwgcGFydGlhbFN0YXRlKSB7CiAgICAgICAgICAgIGlmIChwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKTogQSB2YWxpZCBzdGF0ZSBvYmplY3QgKG9yIG51bGwpIG11c3QgYmUgcmV0dXJuZWQuIFlvdSBoYXZlIHJldHVybmVkIHVuZGVmaW5lZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZmFrZUludGVybmFsSW5zdGFuY2UsICJfcHJvY2Vzc0NoaWxkQ29udGV4dCIsIHsKICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIl9wcm9jZXNzQ2hpbGRDb250ZXh0IGlzIG5vdCBhdmFpbGFibGUgaW4gUmVhY3QgMTYrLiBUaGlzIGxpa2VseSBtZWFucyB5b3UgaGF2ZSBtdWx0aXBsZSBjb3BpZXMgb2YgUmVhY3QgYW5kIGFyZSBhdHRlbXB0aW5nIHRvIG5lc3QgYSBSZWFjdCAxNSB0cmVlIGluc2lkZSBhIFJlYWN0IDE2IHRyZWUgdXNpbmcgdW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIsIHdoaWNoIGlzbid0IHN1cHBvcnRlZC4gVHJ5IHRvIG1ha2Ugc3VyZSB5b3UgaGF2ZSBvbmx5IG9uZSBjb3B5IG9mIFJlYWN0IChhbmQgaWRlYWxseSwgc3dpdGNoIHRvIFJlYWN0RE9NLmNyZWF0ZVBvcnRhbCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgT2JqZWN0LmZyZWV6ZShmYWtlSW50ZXJuYWxJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXh0UHJvcHMpIHsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBwYXJ0aWFsU3RhdGUgPSBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMobmV4dFByb3BzLCBwcmV2U3RhdGUpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHBhcnRpYWxTdGF0ZSA9IGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyhuZXh0UHJvcHMsIHByZXZTdGF0ZSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlKGN0b3IsIHBhcnRpYWxTdGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWVtb2l6ZWRTdGF0ZSA9IHBhcnRpYWxTdGF0ZSA9PT0gbnVsbCB8fCBwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCA/IHByZXZTdGF0ZSA6IGFzc2lnbjIoe30sIHByZXZTdGF0ZSwgcGFydGlhbFN0YXRlKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICB1cGRhdGVRdWV1ZS5iYXNlU3RhdGUgPSBtZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgY2xhc3NDb21wb25lbnRVcGRhdGVyID0gewogICAgICAgICAgaXNNb3VudGVkLAogICAgICAgICAgZW5xdWV1ZVNldFN0YXRlOiBmdW5jdGlvbihpbnN0LCBwYXlsb2FkLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ2KGluc3QpOwogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHBheWxvYWQ7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrKGNhbGxiYWNrLCAic2V0U3RhdGUiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBlbnF1ZXVlUmVwbGFjZVN0YXRlOiBmdW5jdGlvbihpbnN0LCBwYXlsb2FkLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ2KGluc3QpOwogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgICB1cGRhdGUudGFnID0gUmVwbGFjZVN0YXRlOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHBheWxvYWQ7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrKGNhbGxiYWNrLCAicmVwbGFjZVN0YXRlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZW5xdWV1ZUZvcmNlVXBkYXRlOiBmdW5jdGlvbihpbnN0LCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ2KGluc3QpOwogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgICB1cGRhdGUudGFnID0gRm9yY2VVcGRhdGU7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrKGNhbGxiYWNrLCAiZm9yY2VVcGRhdGUiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtGb3JjZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZSA9IGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZShuZXdQcm9wcywgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gaW5zdGFuY2Uuc2hvdWxkQ29tcG9uZW50VXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcy5zaG91bGRDb21wb25lbnRVcGRhdGUoKTogUmV0dXJuZWQgdW5kZWZpbmVkIGluc3RlYWQgb2YgYSBib29sZWFuIHZhbHVlLiBNYWtlIHN1cmUgdG8gcmV0dXJuIHRydWUgb3IgZmFsc2UuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNob3VsZFVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdG9yLnByb3RvdHlwZSAmJiBjdG9yLnByb3RvdHlwZS5pc1B1cmVSZWFjdENvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm4gIXNoYWxsb3dFcXVhbDIob2xkUHJvcHMsIG5ld1Byb3BzKSB8fCAhc2hhbGxvd0VxdWFsMihvbGRTdGF0ZSwgbmV3U3RhdGUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgdmFyIHJlbmRlclByZXNlbnQgPSBpbnN0YW5jZS5yZW5kZXI7CiAgICAgICAgICAgIGlmICghcmVuZGVyUHJlc2VudCkgewogICAgICAgICAgICAgIGlmIChjdG9yLnByb3RvdHlwZSAmJiB0eXBlb2YgY3Rvci5wcm90b3R5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogTm8gYHJlbmRlcmAgbWV0aG9kIGZvdW5kIG9uIHRoZSByZXR1cm5lZCBjb21wb25lbnQgaW5zdGFuY2U6IGRpZCB5b3UgYWNjaWRlbnRhbGx5IHJldHVybiBhbiBvYmplY3QgZnJvbSB0aGUgY29uc3RydWN0b3I/IiwgbmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBObyBgcmVuZGVyYCBtZXRob2QgZm91bmQgb24gdGhlIHJldHVybmVkIGNvbXBvbmVudCBpbnN0YW5jZTogeW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBkZWZpbmUgYHJlbmRlcmAuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5nZXRJbml0aWFsU3RhdGUgJiYgIWluc3RhbmNlLmdldEluaXRpYWxTdGF0ZS5pc1JlYWN0Q2xhc3NBcHByb3ZlZCAmJiAhaW5zdGFuY2Uuc3RhdGUpIHsKICAgICAgICAgICAgICBlcnJvcigiZ2V0SW5pdGlhbFN0YXRlIHdhcyBkZWZpbmVkIG9uICVzLCBhIHBsYWluIEphdmFTY3JpcHQgY2xhc3MuIFRoaXMgaXMgb25seSBzdXBwb3J0ZWQgZm9yIGNsYXNzZXMgY3JlYXRlZCB1c2luZyBSZWFjdC5jcmVhdGVDbGFzcy4gRGlkIHlvdSBtZWFuIHRvIGRlZmluZSBhIHN0YXRlIHByb3BlcnR5IGluc3RlYWQ/IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmdldERlZmF1bHRQcm9wcyAmJiAhaW5zdGFuY2UuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyB3YXMgZGVmaW5lZCBvbiAlcywgYSBwbGFpbiBKYXZhU2NyaXB0IGNsYXNzLiBUaGlzIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBjbGFzc2VzIGNyZWF0ZWQgdXNpbmcgUmVhY3QuY3JlYXRlQ2xhc3MuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgZGVmYXVsdFByb3BzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BUeXBlcykgewogICAgICAgICAgICAgIGVycm9yKCJwcm9wVHlwZXMgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgcHJvcFR5cGVzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmNvbnRleHRUeXBlKSB7CiAgICAgICAgICAgICAgZXJyb3IoImNvbnRleHRUeXBlIHdhcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIHByb3BlcnR5IG9uICVzLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIGNvbnRleHRUeXBlIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjdG9yLmNoaWxkQ29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuaGFzKGN0b3IpICYmIC8vIFN0cmljdCBNb2RlIGhhcyBpdHMgb3duIHdhcm5pbmcgZm9yIGxlZ2FjeSBjb250ZXh0LCBzbyB3ZSBjYW4gc2tpcAogICAgICAgICAgICAgIC8vIHRoaXMgb25lLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgdXNlcyB0aGUgbGVnYWN5IGNoaWxkQ29udGV4dFR5cGVzIEFQSSB3aGljaCBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gVXNlIFJlYWN0LmNyZWF0ZUNvbnRleHQoKSBpbnN0ZWFkXG5cbi5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGN0b3IuY29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuaGFzKGN0b3IpICYmIC8vIFN0cmljdCBNb2RlIGhhcyBpdHMgb3duIHdhcm5pbmcgZm9yIGxlZ2FjeSBjb250ZXh0LCBzbyB3ZSBjYW4gc2tpcAogICAgICAgICAgICAgIC8vIHRoaXMgb25lLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgdXNlcyB0aGUgbGVnYWN5IGNvbnRleHRUeXBlcyBBUEkgd2hpY2ggaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IG1ham9yIHJlbGVhc2UuIFVzZSBSZWFjdC5jcmVhdGVDb250ZXh0KCkgd2l0aCBzdGF0aWMgY29udGV4dFR5cGUgaW5zdGVhZC5cblxuTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2xlZ2FjeS1jb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5jb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJjb250ZXh0VHlwZXMgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgY29udGV4dFR5cGVzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdG9yLmNvbnRleHRUeXBlICYmIGN0b3IuY29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlcy5oYXMoY3RvcikpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dENvbnRleHRUeXBlQW5kQ29udGV4dFR5cGVzLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBkZWNsYXJlcyBib3RoIGNvbnRleHRUeXBlcyBhbmQgY29udGV4dFR5cGUgc3RhdGljIHByb3BlcnRpZXMuIFRoZSBsZWdhY3kgY29udGV4dFR5cGVzIHByb3BlcnR5IHdpbGwgYmUgaWdub3JlZC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRTaG91bGRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBjb21wb25lbnRTaG91bGRVcGRhdGUoKS4gRGlkIHlvdSBtZWFuIHNob3VsZENvbXBvbmVudFVwZGF0ZSgpPyBUaGUgbmFtZSBpcyBwaHJhc2VkIGFzIGEgcXVlc3Rpb24gYmVjYXVzZSB0aGUgZnVuY3Rpb24gaXMgZXhwZWN0ZWQgdG8gcmV0dXJuIGEgdmFsdWUuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIGN0b3IucHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50ICYmIHR5cGVvZiBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgc2hvdWxkQ29tcG9uZW50VXBkYXRlKCkuIHNob3VsZENvbXBvbmVudFVwZGF0ZSBzaG91bGQgbm90IGJlIHVzZWQgd2hlbiBleHRlbmRpbmcgUmVhY3QuUHVyZUNvbXBvbmVudC4gUGxlYXNlIGV4dGVuZCBSZWFjdC5Db21wb25lbnQgaWYgc2hvdWxkQ29tcG9uZW50VXBkYXRlIGlzIHVzZWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJBIHB1cmUgY29tcG9uZW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50RGlkVW5tb3VudCgpLiBCdXQgdGhlcmUgaXMgbm8gc3VjaCBsaWZlY3ljbGUgbWV0aG9kLiBEaWQgeW91IG1lYW4gY29tcG9uZW50V2lsbFVubW91bnQoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIGNvbXBvbmVudERpZFJlY2VpdmVQcm9wcygpLiBCdXQgdGhlcmUgaXMgbm8gc3VjaCBsaWZlY3ljbGUgbWV0aG9kLiBJZiB5b3UgbWVhbnQgdG8gdXBkYXRlIHRoZSBzdGF0ZSBpbiByZXNwb25zZSB0byBjaGFuZ2luZyBwcm9wcywgdXNlIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKS4gSWYgeW91IG1lYW50IHRvIGZldGNoIGRhdGEgb3IgcnVuIHNpZGUtZWZmZWN0cyBvciBtdXRhdGlvbnMgYWZ0ZXIgUmVhY3QgaGFzIHVwZGF0ZWQgdGhlIFVJLCB1c2UgY29tcG9uZW50RGlkVXBkYXRlKCkuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcygpLiBEaWQgeW91IG1lYW4gY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpPyIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcygpLiBEaWQgeW91IG1lYW4gVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzTXV0YXRlZFByb3BzID0gaW5zdGFuY2UucHJvcHMgIT09IG5ld1Byb3BzOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IHZvaWQgMCAmJiBoYXNNdXRhdGVkUHJvcHMpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogV2hlbiBjYWxsaW5nIHN1cGVyKCkgaW4gYCVzYCwgbWFrZSBzdXJlIHRvIHBhc3MgdXAgdGhlIHNhbWUgcHJvcHMgdGhhdCB5b3VyIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yIHdhcyBwYXNzZWQuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGVycm9yKCJTZXR0aW5nIGRlZmF1bHRQcm9wcyBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlZmluZSBkZWZhdWx0UHJvcHMgYXMgYSBzdGF0aWMgcHJvcGVydHkgb24gJXMuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlICE9PSAiZnVuY3Rpb24iICYmICFkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUuaGFzKGN0b3IpKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlLmFkZChjdG9yKTsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCkgc2hvdWxkIGJlIHVzZWQgd2l0aCBjb21wb25lbnREaWRVcGRhdGUoKS4gVGhpcyBjb21wb25lbnQgZGVmaW5lcyBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIG9ubHkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKCkgaXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBtZXRob2QgYW5kIHdpbGwgYmUgaWdub3JlZC4gSW5zdGVhZCwgZGVjbGFyZSBpdCBhcyBhIHN0YXRpYyBtZXRob2QuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcigpIGlzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgbWV0aG9kIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlY2xhcmUgaXQgYXMgYSBzdGF0aWMgbWV0aG9kLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSBpcyBkZWZpbmVkIGFzIGEgc3RhdGljIG1ldGhvZCBhbmQgd2lsbCBiZSBpZ25vcmVkLiBJbnN0ZWFkLCBkZWNsYXJlIGl0IGFzIGFuIGluc3RhbmNlIG1ldGhvZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX3N0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICAgIGlmIChfc3RhdGUgJiYgKHR5cGVvZiBfc3RhdGUgIT09ICJvYmplY3QiIHx8IGlzQXJyYXkyKF9zdGF0ZSkpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzLnN0YXRlOiBtdXN0IGJlIHNldCB0byBhbiBvYmplY3Qgb3IgbnVsbCIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0ID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBjdG9yLmNoaWxkQ29udGV4dFR5cGVzICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIGVycm9yKCIlcy5nZXRDaGlsZENvbnRleHQoKTogY2hpbGRDb250ZXh0VHlwZXMgbXVzdCBiZSBkZWZpbmVkIGluIG9yZGVyIHRvIHVzZSBnZXRDaGlsZENvbnRleHQoKS4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZG9wdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UudXBkYXRlciA9IGNsYXNzQ29tcG9uZW50VXBkYXRlcjsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgIHNldDMoaW5zdGFuY2UsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIGluc3RhbmNlLl9yZWFjdEludGVybmFsSW5zdGFuY2UgPSBmYWtlSW50ZXJuYWxJbnN0YW5jZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHByb3BzKSB7CiAgICAgICAgICB2YXIgaXNMZWdhY3lDb250ZXh0Q29uc3VtZXIgPSBmYWxzZTsKICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB2YXIgY29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICgiY29udGV4dFR5cGUiIGluIGN0b3IpIHsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9ICgKICAgICAgICAgICAgICAgIC8vIEFsbG93IG51bGwgZm9yIGNvbmRpdGlvbmFsIGRlY2xhcmF0aW9uCiAgICAgICAgICAgICAgICBjb250ZXh0VHlwZSA9PT0gbnVsbCB8fCBjb250ZXh0VHlwZSAhPT0gdm9pZCAwICYmIGNvbnRleHRUeXBlLiQkdHlwZW9mID09PSBSRUFDVF9DT05URVhUX1RZUEUgJiYgY29udGV4dFR5cGUuX2NvbnRleHQgPT09IHZvaWQgMAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKCFpc1ZhbGlkICYmICFkaWRXYXJuQWJvdXRJbnZhbGlkYXRlQ29udGV4dFR5cGUuaGFzKGN0b3IpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRJbnZhbGlkYXRlQ29udGV4dFR5cGUuYWRkKGN0b3IpOwogICAgICAgICAgICAgICAgdmFyIGFkZGVuZHVtID0gIiI7CiAgICAgICAgICAgICAgICBpZiAoY29udGV4dFR5cGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgSG93ZXZlciwgaXQgaXMgc2V0IHRvIHVuZGVmaW5lZC4gVGhpcyBjYW4gYmUgY2F1c2VkIGJ5IGEgdHlwbyBvciBieSBtaXhpbmcgdXAgbmFtZWQgYW5kIGRlZmF1bHQgaW1wb3J0cy4gVGhpcyBjYW4gYWxzbyBoYXBwZW4gZHVlIHRvIGEgY2lyY3VsYXIgZGVwZW5kZW5jeSwgc28gdHJ5IG1vdmluZyB0aGUgY3JlYXRlQ29udGV4dCgpIGNhbGwgdG8gYSBzZXBhcmF0ZSBmaWxlLiI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBjb250ZXh0VHlwZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byBhICIgKyB0eXBlb2YgY29udGV4dFR5cGUgKyAiLiI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHRUeXBlLiQkdHlwZW9mID09PSBSRUFDVF9QUk9WSURFUl9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBEaWQgeW91IGFjY2lkZW50YWxseSBwYXNzIHRoZSBDb250ZXh0LlByb3ZpZGVyIGluc3RlYWQ/IjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29udGV4dFR5cGUuX2NvbnRleHQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgcGFzcyB0aGUgQ29udGV4dC5Db25zdW1lciBpbnN0ZWFkPyI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgSG93ZXZlciwgaXQgaXMgc2V0IHRvIGFuIG9iamVjdCB3aXRoIGtleXMgeyIgKyBPYmplY3Qua2V5cyhjb250ZXh0VHlwZSkuam9pbigiLCAiKSArICJ9LiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgZGVmaW5lcyBhbiBpbnZhbGlkIGNvbnRleHRUeXBlLiBjb250ZXh0VHlwZSBzaG91bGQgcG9pbnQgdG8gdGhlIENvbnRleHQgb2JqZWN0IHJldHVybmVkIGJ5IFJlYWN0LmNyZWF0ZUNvbnRleHQoKS4lcyIsIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IiwgYWRkZW5kdW0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgY29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHRydWUpOwogICAgICAgICAgICB2YXIgY29udGV4dFR5cGVzID0gY3Rvci5jb250ZXh0VHlwZXM7CiAgICAgICAgICAgIGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID0gY29udGV4dFR5cGVzICE9PSBudWxsICYmIGNvbnRleHRUeXBlcyAhPT0gdm9pZCAwOwogICAgICAgICAgICBjb250ZXh0ID0gaXNMZWdhY3lDb250ZXh0Q29uc3VtZXIgPyBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KSA6IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG5ldyBjdG9yKHByb3BzLCBjb250ZXh0KTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZSA9IG5ldyBjdG9yKHByb3BzLCBjb250ZXh0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSAhPT0gbnVsbCAmJiBpbnN0YW5jZS5zdGF0ZSAhPT0gdm9pZCAwID8gaW5zdGFuY2Uuc3RhdGUgOiBudWxsOwogICAgICAgICAgYWRvcHRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iICYmIHN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVbmluaXRpYWxpemVkU3RhdGUuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbmluaXRpYWxpemVkU3RhdGUuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZXJyb3IoImAlc2AgdXNlcyBgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzYCBidXQgaXRzIGluaXRpYWwgc3RhdGUgaXMgJXMuIFRoaXMgaXMgbm90IHJlY29tbWVuZGVkLiBJbnN0ZWFkLCBkZWZpbmUgdGhlIGluaXRpYWwgc3RhdGUgYnkgYXNzaWduaW5nIGFuIG9iamVjdCB0byBgdGhpcy5zdGF0ZWAgaW4gdGhlIGNvbnN0cnVjdG9yIG9mIGAlc2AuIFRoaXMgZW5zdXJlcyB0aGF0IGBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHNgIGFyZ3VtZW50cyBoYXZlIGEgY29uc2lzdGVudCBzaGFwZS4iLCBjb21wb25lbnROYW1lLCBpbnN0YW5jZS5zdGF0ZSA9PT0gbnVsbCA/ICJudWxsIiA6ICJ1bmRlZmluZWQiLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgZm91bmRXaWxsTW91bnROYW1lID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbFVwZGF0ZU5hbWUgPSBudWxsOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudC5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxNb3VudE5hbWUgPSAiY29tcG9uZW50V2lsbE1vdW50IjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxNb3VudE5hbWUgPSAiVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzLl9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgPSAiY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgPSAiVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZS5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxVcGRhdGVOYW1lID0gImNvbXBvbmVudFdpbGxVcGRhdGUiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxVcGRhdGVOYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZvdW5kV2lsbE1vdW50TmFtZSAhPT0gbnVsbCB8fCBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lICE9PSBudWxsIHx8IGZvdW5kV2lsbFVwZGF0ZU5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICAgIHZhciBuZXdBcGlOYW1lID0gdHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iID8gImdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcygpIiA6ICJnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIjsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TGVnYWN5TGlmZWN5Y2xlc0FuZERlcml2ZWRTdGF0ZS5oYXMoX2NvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGUuYWRkKF9jb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVuc2FmZSBsZWdhY3kgbGlmZWN5Y2xlcyB3aWxsIG5vdCBiZSBjYWxsZWQgZm9yIGNvbXBvbmVudHMgdXNpbmcgbmV3IGNvbXBvbmVudCBBUElzLlxuXG4lcyB1c2VzICVzIGJ1dCBhbHNvIGNvbnRhaW5zIHRoZSBmb2xsb3dpbmcgbGVnYWN5IGxpZmVjeWNsZXM6JXMlcyVzXG5cblRoZSBhYm92ZSBsaWZlY3ljbGVzIHNob3VsZCBiZSByZW1vdmVkLiBMZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOlxuaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyIsIF9jb21wb25lbnROYW1lLCBuZXdBcGlOYW1lLCBmb3VuZFdpbGxNb3VudE5hbWUgIT09IG51bGwgPyAiXG4gICIgKyBmb3VuZFdpbGxNb3VudE5hbWUgOiAiIiwgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSAhPT0gbnVsbCA/ICJcbiAgIiArIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgOiAiIiwgZm91bmRXaWxsVXBkYXRlTmFtZSAhPT0gbnVsbCA/ICJcbiAgIiArIGZvdW5kV2lsbFVwZGF0ZU5hbWUgOiAiIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNMZWdhY3lDb250ZXh0Q29uc3VtZXIpIHsKICAgICAgICAgICAgY2FjaGVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0LCBjb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FsbENvbXBvbmVudFdpbGxNb3VudCh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChvbGRTdGF0ZSAhPT0gaW5zdGFuY2Uuc3RhdGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCIlcy5jb21wb25lbnRXaWxsTW91bnQoKTogQXNzaWduaW5nIGRpcmVjdGx5IHRvIHRoaXMuc3RhdGUgaXMgZGVwcmVjYXRlZCAoZXhjZXB0IGluc2lkZSBhIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yKS4gVXNlIHNldFN0YXRlIGluc3RlYWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjbGFzc0NvbXBvbmVudFVwZGF0ZXIuZW5xdWV1ZVJlcGxhY2VTdGF0ZShpbnN0YW5jZSwgaW5zdGFuY2Uuc3RhdGUsIG51bGwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpIHsKICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IGluc3RhbmNlLnN0YXRlOwogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV3UHJvcHMsIG5leHRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV3UHJvcHMsIG5leHRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSAhPT0gb2xkU3RhdGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50Lmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50LmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcy5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKCk6IEFzc2lnbmluZyBkaXJlY3RseSB0byB0aGlzLnN0YXRlIGlzIGRlcHJlY2F0ZWQgKGV4Y2VwdCBpbnNpZGUgYSBjb21wb25lbnQncyBjb25zdHJ1Y3RvcikuIFVzZSBzZXRTdGF0ZSBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjbGFzc0NvbXBvbmVudFVwZGF0ZXIuZW5xdWV1ZVJlcGxhY2VTdGF0ZShpbnN0YW5jZSwgaW5zdGFuY2Uuc3RhdGUsIG51bGwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGluc3RhbmNlLnJlZnMgPSB7fTsKICAgICAgICAgIGluaXRpYWxpemVVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIGNvbnRleHRUeXBlID0gY3Rvci5jb250ZXh0VHlwZTsKICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbnRleHQgPSByZWFkQ29udGV4dChjb250ZXh0VHlwZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlID09PSBuZXdQcm9wcykgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGUuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXREaXJlY3RseUFzc2lnbmluZ1Byb3BzVG9TdGF0ZS5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IEl0IGlzIG5vdCByZWNvbW1lbmRlZCB0byBhc3NpZ24gcHJvcHMgZGlyZWN0bHkgdG8gc3RhdGUgYmVjYXVzZSB1cGRhdGVzIHRvIHByb3BzIHdvbid0IGJlIHJlZmxlY3RlZCBpbiBzdGF0ZS4gSW4gbW9zdCBjYXNlcywgaXQgaXMgYmV0dGVyIHRvIHVzZSBwcm9wcyBkaXJlY3RseS4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRVbnNhZmVMaWZlY3ljbGVXYXJuaW5ncyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPSBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wczsKICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzICE9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSAhPT0gImZ1bmN0aW9uIiAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikpIHsKICAgICAgICAgICAgY2FsbENvbXBvbmVudFdpbGxNb3VudCh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IGZpYmVyRmxhZ3M7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3VtZU1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICB2YXIgb2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gb2xkUHJvcHM7CiAgICAgICAgICB2YXIgb2xkQ29udGV4dCA9IGluc3RhbmNlLmNvbnRleHQ7CiAgICAgICAgICB2YXIgY29udGV4dFR5cGUgPSBjdG9yLmNvbnRleHRUeXBlOwogICAgICAgICAgdmFyIG5leHRDb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgbmV4dENvbnRleHQgPSByZWFkQ29udGV4dChjb250ZXh0VHlwZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbmV4dExlZ2FjeVVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHRydWUpOwogICAgICAgICAgICBuZXh0Q29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBuZXh0TGVnYWN5VW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPSBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wczsKICAgICAgICAgIHZhciBoYXNOZXdMaWZlY3ljbGVzID0gdHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICBpZiAoIWhhc05ld0xpZmVjeWNsZXMgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikpIHsKICAgICAgICAgICAgaWYgKG9sZFByb3BzICE9PSBuZXdQcm9wcyB8fCBvbGRDb250ZXh0ICE9PSBuZXh0Q29udGV4dCkgewogICAgICAgICAgICAgIGNhbGxDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UsIG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlc2V0SGFzRm9yY2VVcGRhdGVCZWZvcmVQcm9jZXNzaW5nKCk7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGluc3RhbmNlLnN0YXRlID0gb2xkU3RhdGU7CiAgICAgICAgICBwcm9jZXNzVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyLCBuZXdQcm9wcywgaW5zdGFuY2UsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICBuZXdTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKG9sZFByb3BzID09PSBuZXdQcm9wcyAmJiBvbGRTdGF0ZSA9PT0gbmV3U3RhdGUgJiYgIWhhc0NvbnRleHRDaGFuZ2VkKCkgJiYgIWNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSkgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IGZpYmVyRmxhZ3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgYXBwbHlEZXJpdmVkU3RhdGVGcm9tUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkgfHwgY2hlY2tTaG91bGRDb21wb25lbnRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBvbGRQcm9wcywgbmV3UHJvcHMsIG9sZFN0YXRlLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICBpZiAoIWhhc05ld0xpZmVjeWNsZXMgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBfZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBfZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBfZmliZXJGbGFnczsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBfZmliZXJGbGFnczIgPSBVcGRhdGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MyIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBfZmliZXJGbGFnczIgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBfZmliZXJGbGFnczI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IG5leHRDb250ZXh0OwogICAgICAgICAgcmV0dXJuIHNob3VsZFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2xhc3NJbnN0YW5jZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgY2xvbmVVcGRhdGVRdWV1ZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciB1bnJlc29sdmVkT2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHZhciBvbGRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi50eXBlID09PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPyB1bnJlc29sdmVkT2xkUHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzMih3b3JrSW5Qcm9ncmVzczIudHlwZSwgdW5yZXNvbHZlZE9sZFByb3BzKTsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gb2xkUHJvcHM7CiAgICAgICAgICB2YXIgdW5yZXNvbHZlZE5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBvbGRDb250ZXh0ID0gaW5zdGFuY2UuY29udGV4dDsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBuZXh0Q29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBuZXh0VW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIG5leHRVbm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9IGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzOwogICAgICAgICAgdmFyIGhhc05ld0xpZmVjeWNsZXMgPSB0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIjsKICAgICAgICAgIGlmICghaGFzTmV3TGlmZWN5Y2xlcyAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSB1bnJlc29sdmVkTmV3UHJvcHMgfHwgb2xkQ29udGV4dCAhPT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpOwogICAgICAgICAgdmFyIG9sZFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgPT09IHVucmVzb2x2ZWROZXdQcm9wcyAmJiBvbGRTdGF0ZSA9PT0gbmV3U3RhdGUgJiYgIWhhc0NvbnRleHRDaGFuZ2VkKCkgJiYgIWNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSAmJiAhZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbikgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSBjdXJyZW50NC5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50NC5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHx8IGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KSB8fCAvLyBUT0RPOiBJbiBzb21lIGNhc2VzLCB3ZSdsbCBlbmQgdXAgY2hlY2tpbmcgaWYgY29udGV4dCBoYXMgY2hhbmdlZCB0d2ljZSwKICAgICAgICAgIC8vIGJvdGggYmVmb3JlIGFuZCBhZnRlciBgc2hvdWxkQ29tcG9uZW50VXBkYXRlYCBoYXMgYmVlbiBjYWxsZWQuIE5vdCBpZGVhbCwKICAgICAgICAgIC8vIGJ1dCBJJ20gbG9hdGggdG8gcmVmYWN0b3IgdGhpcyBmdW5jdGlvbi4gVGhpcyBvbmx5IGhhcHBlbnMgZm9yIG1lbW9pemVkCiAgICAgICAgICAvLyBjb21wb25lbnRzIHNvIGl0J3Mgbm90IHRoYXQgY29tbW9uLgogICAgICAgICAgZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbjsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZShuZXdQcm9wcywgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gY3VycmVudDQubWVtb2l6ZWRQcm9wcyB8fCBvbGRTdGF0ZSAhPT0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTbmFwc2hvdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IG5leHRDb250ZXh0OwogICAgICAgICAgcmV0dXJuIHNob3VsZFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHNvdXJjZSwKICAgICAgICAgICAgc3RhY2s6IGdldFN0YWNrQnlGaWJlckluRGV2QW5kUHJvZChzb3VyY2UpLAogICAgICAgICAgICBkaWdlc3Q6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNhcHR1cmVkVmFsdWUodmFsdWUsIGRpZ2VzdCwgc3RhY2spIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICBzb3VyY2U6IG51bGwsCiAgICAgICAgICAgIHN0YWNrOiBzdGFjayAhPSBudWxsID8gc3RhY2sgOiBudWxsLAogICAgICAgICAgICBkaWdlc3Q6IGRpZ2VzdCAhPSBudWxsID8gZGlnZXN0IDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvd0Vycm9yRGlhbG9nKGJvdW5kYXJ5LCBlcnJvckluZm8pIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsb2dDYXB0dXJlZEVycm9yKGJvdW5kYXJ5LCBlcnJvckluZm8pIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBsb2dFcnJvciA9IHNob3dFcnJvckRpYWxvZyhib3VuZGFyeSwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgaWYgKGxvZ0Vycm9yID09PSBmYWxzZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXJyb3IyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgIHZhciBzb3VyY2UgPSBlcnJvckluZm8uc291cmNlOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGVycm9ySW5mby5zdGFjazsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSBzdGFjayAhPT0gbnVsbCA/IHN0YWNrIDogIiI7CiAgICAgICAgICAgICAgaWYgKGVycm9yMiAhPSBudWxsICYmIGVycm9yMi5fc3VwcHJlc3NMb2dnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAoYm91bmRhcnkudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gc291cmNlID8gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihzb3VyY2UpIDogbnVsbDsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZU1lc3NhZ2UgPSBjb21wb25lbnROYW1lID8gIlRoZSBhYm92ZSBlcnJvciBvY2N1cnJlZCBpbiB0aGUgPCIgKyBjb21wb25lbnROYW1lICsgIj4gY29tcG9uZW50OiIgOiAiVGhlIGFib3ZlIGVycm9yIG9jY3VycmVkIGluIG9uZSBvZiB5b3VyIFJlYWN0IGNvbXBvbmVudHM6IjsKICAgICAgICAgICAgICB2YXIgZXJyb3JCb3VuZGFyeU1lc3NhZ2U7CiAgICAgICAgICAgICAgaWYgKGJvdW5kYXJ5LnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIGVycm9yQm91bmRhcnlNZXNzYWdlID0gIkNvbnNpZGVyIGFkZGluZyBhbiBlcnJvciBib3VuZGFyeSB0byB5b3VyIHRyZWUgdG8gY3VzdG9taXplIGVycm9yIGhhbmRsaW5nIGJlaGF2aW9yLlxuVmlzaXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Vycm9yLWJvdW5kYXJpZXMgdG8gbGVhcm4gbW9yZSBhYm91dCBlcnJvciBib3VuZGFyaWVzLiI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvckJvdW5kYXJ5TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoYm91bmRhcnkpIHx8ICJBbm9ueW1vdXMiOwogICAgICAgICAgICAgICAgZXJyb3JCb3VuZGFyeU1lc3NhZ2UgPSAiUmVhY3Qgd2lsbCB0cnkgdG8gcmVjcmVhdGUgdGhpcyBjb21wb25lbnQgdHJlZSBmcm9tIHNjcmF0Y2ggIiArICgidXNpbmcgdGhlIGVycm9yIGJvdW5kYXJ5IHlvdSBwcm92aWRlZCwgIiArIGVycm9yQm91bmRhcnlOYW1lICsgIi4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkTWVzc2FnZSA9IGNvbXBvbmVudE5hbWVNZXNzYWdlICsgIlxuIiArIGNvbXBvbmVudFN0YWNrICsgIlxuXG4iICsgKCIiICsgZXJyb3JCb3VuZGFyeU1lc3NhZ2UpOwogICAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oY29tYmluZWRNZXNzYWdlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCQxID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3RFcnJvclVwZGF0ZShmaWJlciwgZXJyb3JJbmZvLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKE5vVGltZXN0YW1wLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS50YWcgPSBDYXB0dXJlVXBkYXRlOwogICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSB7CiAgICAgICAgICAgIGVsZW1lbnQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZXJyb3IyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG9uVW5jYXVnaHRFcnJvcihlcnJvcjIpOwogICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUudGFnID0gQ2FwdHVyZVVwZGF0ZTsKICAgICAgICAgIHZhciBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPSBmaWJlci50eXBlLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvcjsKICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBlcnJvciQxID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoZXJyb3IkMSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hcmtGYWlsZWRFcnJvckJvdW5kYXJ5Rm9ySG90UmVsb2FkaW5nKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbG9nQ2FwdHVyZWRFcnJvcihmaWJlciwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0ID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKGluc3QgIT09IG51bGwgJiYgdHlwZW9mIGluc3QuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24gY2FsbGJhY2soKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFya0ZhaWxlZEVycm9yQm91bmRhcnlGb3JIb3RSZWxvYWRpbmcoZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBtYXJrTGVnYWN5RXJyb3JCb3VuZGFyeUFzRmFpbGVkKHRoaXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXJyb3IkMTIgPSBlcnJvckluZm8udmFsdWU7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZXJyb3JJbmZvLnN0YWNrOwogICAgICAgICAgICAgIHRoaXMuY29tcG9uZW50RGlkQ2F0Y2goZXJyb3IkMTIsIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFN0YWNrOiBzdGFjayAhPT0gbnVsbCA/IHN0YWNrIDogIiIKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUoZmliZXIubGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogRXJyb3IgYm91bmRhcmllcyBzaG91bGQgaW1wbGVtZW50IGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcigpLiBJbiB0aGF0IG1ldGhvZCwgcmV0dXJuIGEgc3RhdGUgdXBkYXRlIHRvIGRpc3BsYXkgYW4gZXJyb3IgbWVzc2FnZSBvciBmYWxsYmFjayBVSS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBwaW5nQ2FjaGUgPSByb290My5waW5nQ2FjaGU7CiAgICAgICAgICB2YXIgdGhyZWFkSURzOwogICAgICAgICAgaWYgKHBpbmdDYWNoZSA9PT0gbnVsbCkgewogICAgICAgICAgICBwaW5nQ2FjaGUgPSByb290My5waW5nQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwJDEoKTsKICAgICAgICAgICAgdGhyZWFkSURzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgcGluZ0NhY2hlLnNldCh3YWtlYWJsZSwgdGhyZWFkSURzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocmVhZElEcyA9IHBpbmdDYWNoZS5nZXQod2FrZWFibGUpOwogICAgICAgICAgICBpZiAodGhyZWFkSURzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0aHJlYWRJRHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIHBpbmdDYWNoZS5zZXQod2FrZWFibGUsIHRocmVhZElEcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghdGhyZWFkSURzLmhhcyhsYW5lcykpIHsKICAgICAgICAgICAgdGhyZWFkSURzLmFkZChsYW5lcyk7CiAgICAgICAgICAgIHZhciBwaW5nID0gcGluZ1N1c3BlbmRlZFJvb3QuYmluZChudWxsLCByb290Mywgd2FrZWFibGUsIGxhbmVzKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YWtlYWJsZS50aGVuKHBpbmcsIHBpbmcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRhY2hSZXRyeUxpc3RlbmVyKHN1c3BlbnNlQm91bmRhcnksIHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSBzdXNwZW5zZUJvdW5kYXJ5LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHdha2VhYmxlcyA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB1cGRhdGVRdWV1ZS5hZGQod2FrZWFibGUpOwogICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LnVwZGF0ZVF1ZXVlID0gdXBkYXRlUXVldWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3YWtlYWJsZXMuYWRkKHdha2VhYmxlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRTdXNwZW5kZWRDb21wb25lbnQoc291cmNlRmliZXIsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgdmFyIHRhZyA9IHNvdXJjZUZpYmVyLnRhZzsKICAgICAgICAgIGlmICgoc291cmNlRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmICh0YWcgPT09IEZ1bmN0aW9uQ29tcG9uZW50IHx8IHRhZyA9PT0gRm9yd2FyZFJlZjIgfHwgdGFnID09PSBTaW1wbGVNZW1vQ29tcG9uZW50KSkgewogICAgICAgICAgICB2YXIgY3VycmVudFNvdXJjZSA9IHNvdXJjZUZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnRTb3VyY2UpIHsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci51cGRhdGVRdWV1ZSA9IGN1cnJlbnRTb3VyY2UudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgc291cmNlRmliZXIubWVtb2l6ZWRTdGF0ZSA9IGN1cnJlbnRTb3VyY2UubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5sYW5lcyA9IGN1cnJlbnRTb3VyY2UubGFuZXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc291cmNlRmliZXIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5lYXJlc3RTdXNwZW5zZUJvdW5kYXJ5VG9DYXB0dXJlKHJldHVybkZpYmVyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHJldHVybkZpYmVyOwogICAgICAgICAgZG8gewogICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50ICYmIHNob3VsZENhcHR1cmVTdXNwZW5zZShub2RlKSkgewogICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgIH0gd2hpbGUgKG5vZGUgIT09IG51bGwpOwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTdXNwZW5zZUJvdW5kYXJ5U2hvdWxkQ2FwdHVyZShzdXNwZW5zZUJvdW5kYXJ5LCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHJvb3QzLCByb290UmVuZGVyTGFuZXMpIHsKICAgICAgICAgIGlmICgoc3VzcGVuc2VCb3VuZGFyeS5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgaWYgKHN1c3BlbnNlQm91bmRhcnkgPT09IHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBTaG91bGRDYXB0dXJlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5mbGFncyB8PSBGb3JjZVVwZGF0ZUZvckxlZ2FjeVN1c3BlbnNlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzICY9IH4oTGlmZWN5Y2xlRWZmZWN0TWFzayB8IEluY29tcGxldGUpOwogICAgICAgICAgICAgIGlmIChzb3VyY2VGaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFNvdXJjZUZpYmVyID0gc291cmNlRmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRTb3VyY2VGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzb3VyY2VGaWJlci50YWcgPSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKE5vVGltZXN0YW1wLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBGb3JjZVVwZGF0ZTsKICAgICAgICAgICAgICAgICAgZW5xdWV1ZVVwZGF0ZShzb3VyY2VGaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmxhbmVzID0gbWVyZ2VMYW5lcyhzb3VyY2VGaWJlci5sYW5lcywgU3luY0xhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzdXNwZW5zZUJvdW5kYXJ5OwogICAgICAgICAgfQogICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBTaG91bGRDYXB0dXJlOwogICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5sYW5lcyA9IHJvb3RSZW5kZXJMYW5lczsKICAgICAgICAgIHJldHVybiBzdXNwZW5zZUJvdW5kYXJ5OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd0V4Y2VwdGlvbihyb290MywgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCB2YWx1ZSwgcm9vdFJlbmRlckxhbmVzKSB7CiAgICAgICAgICBzb3VyY2VGaWJlci5mbGFncyB8PSBJbmNvbXBsZXRlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB0eXBlb2YgdmFsdWUudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgd2FrZWFibGUgPSB2YWx1ZTsKICAgICAgICAgICAgcmVzZXRTdXNwZW5kZWRDb21wb25lbnQoc291cmNlRmliZXIpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgc291cmNlRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICAgICAgICBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc3VzcGVuc2VCb3VuZGFyeSA9IGdldE5lYXJlc3RTdXNwZW5zZUJvdW5kYXJ5VG9DYXB0dXJlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgaWYgKHN1c3BlbnNlQm91bmRhcnkgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzICY9IH5Gb3JjZUNsaWVudFJlbmRlcjsKICAgICAgICAgICAgICBtYXJrU3VzcGVuc2VCb3VuZGFyeVNob3VsZENhcHR1cmUoc3VzcGVuc2VCb3VuZGFyeSwgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCByb290Mywgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeS5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICAgIGF0dGFjaFBpbmdMaXN0ZW5lcihyb290Mywgd2FrZWFibGUsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGF0dGFjaFJldHJ5TGlzdGVuZXIoc3VzcGVuc2VCb3VuZGFyeSwgcm9vdDMsIHdha2VhYmxlKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKCFpbmNsdWRlc1N5bmNMYW5lKHJvb3RSZW5kZXJMYW5lcykpIHsKICAgICAgICAgICAgICAgIGF0dGFjaFBpbmdMaXN0ZW5lcihyb290Mywgd2FrZWFibGUsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB1bmNhdWdodFN1c3BlbnNlRXJyb3IgPSBuZXcgRXJyb3IoIkEgY29tcG9uZW50IHN1c3BlbmRlZCB3aGlsZSByZXNwb25kaW5nIHRvIHN5bmNocm9ub3VzIGlucHV0LiBUaGlzIHdpbGwgY2F1c2UgdGhlIFVJIHRvIGJlIHJlcGxhY2VkIHdpdGggYSBsb2FkaW5nIGluZGljYXRvci4gVG8gZml4LCB1cGRhdGVzIHRoYXQgc3VzcGVuZCBzaG91bGQgYmUgd3JhcHBlZCB3aXRoIHN0YXJ0VHJhbnNpdGlvbi4iKTsKICAgICAgICAgICAgICB2YWx1ZSA9IHVuY2F1Z2h0U3VzcGVuc2VFcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgc291cmNlRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICAgICAgbWFya0RpZFRocm93V2hpbGVIeWRyYXRpbmdERVYoKTsKICAgICAgICAgICAgICB2YXIgX3N1c3BlbnNlQm91bmRhcnkgPSBnZXROZWFyZXN0U3VzcGVuc2VCb3VuZGFyeVRvQ2FwdHVyZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgaWYgKF9zdXNwZW5zZUJvdW5kYXJ5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoKF9zdXNwZW5zZUJvdW5kYXJ5LmZsYWdzICYgU2hvdWxkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgX3N1c3BlbnNlQm91bmRhcnkuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtYXJrU3VzcGVuc2VCb3VuZGFyeVNob3VsZENhcHR1cmUoX3N1c3BlbnNlQm91bmRhcnksIHJldHVybkZpYmVyLCBzb3VyY2VGaWJlciwgcm9vdDMsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICBxdWV1ZUh5ZHJhdGlvbkVycm9yKGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKHZhbHVlLCBzb3VyY2VGaWJlcikpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFsdWUgPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcih2YWx1ZSwgc291cmNlRmliZXIpOwogICAgICAgICAgcmVuZGVyRGlkRXJyb3IodmFsdWUpOwogICAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzMiA9IHJldHVybkZpYmVyOwogICAgICAgICAgZG8gewogICAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB2YXIgX2Vycm9ySW5mbyA9IHZhbHVlOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgICAgICB2YXIgbGFuZSA9IHBpY2tBcmJpdHJhcnlMYW5lKHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzMi5sYW5lcywgbGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlUm9vdEVycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgX2Vycm9ySW5mbywgbGFuZSk7CiAgICAgICAgICAgICAgICBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCB1cGRhdGUpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgdmFyIGVycm9ySW5mbyA9IHZhbHVlOwogICAgICAgICAgICAgICAgdmFyIGN0b3IgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzICYmICh0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPT09ICJmdW5jdGlvbiIgfHwgaW5zdGFuY2UgIT09IG51bGwgJiYgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZENhdGNoID09PSAiZnVuY3Rpb24iICYmICFpc0FscmVhZHlGYWlsZWRMZWdhY3lFcnJvckJvdW5kYXJ5KGluc3RhbmNlKSkpIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgIHZhciBfbGFuZSA9IHBpY2tBcmJpdHJhcnlMYW5lKHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBfbGFuZSk7CiAgICAgICAgICAgICAgICAgIHZhciBfdXBkYXRlID0gY3JlYXRlQ2xhc3NFcnJvclVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGVycm9ySW5mbywgX2xhbmUpOwogICAgICAgICAgICAgICAgICBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBfdXBkYXRlKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyID0gd29ya0luUHJvZ3Jlc3MyLnJldHVybjsKICAgICAgICAgIH0gd2hpbGUgKHdvcmtJblByb2dyZXNzMiAhPT0gbnVsbCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbmRlZENhY2hlKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRCYWRDbGFzczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0TW9kdWxlUGF0dGVybkNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRGdW5jdGlvblJlZnM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFJldmVhbE9yZGVyOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRUYWlsT3B0aW9uczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudDsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRCYWRDbGFzcyA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0TW9kdWxlUGF0dGVybkNvbXBvbmVudCA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50ID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50ID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRGdW5jdGlvblJlZnMgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMgPSBmYWxzZTsKICAgICAgICAgIGRpZFdhcm5BYm91dFJldmVhbE9yZGVyID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRUYWlsT3B0aW9ucyA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudCA9IHt9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG1vdW50Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBudWxsLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGN1cnJlbnQ0LmNoaWxkLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcmNlVW5tb3VudEN1cnJlbnRBbmRSZWNvbmNpbGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgY3VycmVudDQuY2hpbGQsIG51bGwsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIG51bGwsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRm9yd2FyZFJlZihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlbmRlcjIgPSBDb21wb25lbnQucmVuZGVyOwogICAgICAgICAgdmFyIHJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuOwogICAgICAgICAgdmFyIGhhc0lkOwogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyMiwgbmV4dFByb3BzLCByZWYsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyMiwgbmV4dFByb3BzLCByZWYsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmICFkaWRSZWNlaXZlVXBkYXRlKSB7CiAgICAgICAgICAgIGJhaWxvdXRIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaGFzSWQpIHsKICAgICAgICAgICAgcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgdHlwZSA9IENvbXBvbmVudC50eXBlOwogICAgICAgICAgICBpZiAoaXNTaW1wbGVGdW5jdGlvbkNvbXBvbmVudCh0eXBlKSAmJiBDb21wb25lbnQuY29tcGFyZSA9PT0gbnVsbCAmJiAvLyBTaW1wbGVNZW1vQ29tcG9uZW50IGNvZGVwYXRoIGRvZXNuJ3QgcmVzb2x2ZSBvdXRlciBwcm9wcyBlaXRoZXIuCiAgICAgICAgICAgIENvbXBvbmVudC5kZWZhdWx0UHJvcHMgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciByZXNvbHZlZFR5cGUgPSB0eXBlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRhZyA9IFNpbXBsZU1lbW9Db21wb25lbnQ7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlZFR5cGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTaW1wbGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlc29sdmVkVHlwZSwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKENvbXBvbmVudC5kZWZhdWx0UHJvcHMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogU3VwcG9ydCBmb3IgZGVmYXVsdFByb3BzIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIG1lbW8gY29tcG9uZW50cyBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBVc2UgSmF2YVNjcmlwdCBkZWZhdWx0IHBhcmFtZXRlcnMgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudFtjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGNyZWF0ZUZpYmVyRnJvbVR5cGVBbmRQcm9wcyhDb21wb25lbnQudHlwZSwgbnVsbCwgbmV4dFByb3BzLCB3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi5tb2RlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjaGlsZC5yZWYgPSB3b3JrSW5Qcm9ncmVzczIucmVmOwogICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGNoaWxkOwogICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBfdHlwZSA9IENvbXBvbmVudC50eXBlOwogICAgICAgICAgICB2YXIgX2lubmVyUHJvcFR5cGVzID0gX3R5cGUucHJvcFR5cGVzOwogICAgICAgICAgICBpZiAoX2lubmVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICBfaW5uZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKF90eXBlKQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50Q2hpbGQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgIHZhciBoYXNTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQgPSBjaGVja1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dChjdXJyZW50NCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIGlmICghaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50Q2hpbGQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgdmFyIGNvbXBhcmUgPSBDb21wb25lbnQuY29tcGFyZTsKICAgICAgICAgICAgY29tcGFyZSA9IGNvbXBhcmUgIT09IG51bGwgPyBjb21wYXJlIDogc2hhbGxvd0VxdWFsMjsKICAgICAgICAgICAgaWYgKGNvbXBhcmUocHJldlByb3BzLCBuZXh0UHJvcHMpICYmIGN1cnJlbnQ0LnJlZiA9PT0gd29ya0luUHJvZ3Jlc3MyLnJlZikgewogICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgdmFyIG5ld0NoaWxkID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudENoaWxkLCBuZXh0UHJvcHMpOwogICAgICAgICAgbmV3Q2hpbGQucmVmID0gd29ya0luUHJvZ3Jlc3MyLnJlZjsKICAgICAgICAgIG5ld0NoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG5ld0NoaWxkOwogICAgICAgICAgcmV0dXJuIG5ld0NoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTaW1wbGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgb3V0ZXJNZW1vVHlwZSA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZTsKICAgICAgICAgICAgICBpZiAob3V0ZXJNZW1vVHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IG91dGVyTWVtb1R5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBvdXRlck1lbW9UeXBlID0gaW5pdChwYXlsb2FkKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIG91dGVyTWVtb1R5cGUgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG91dGVyUHJvcFR5cGVzID0gb3V0ZXJNZW1vVHlwZSAmJiBvdXRlck1lbW9UeXBlLnByb3BUeXBlczsKICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICBvdXRlclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgKFNpbXBsZU1lbW9Db21wb25lbnQgaGFzIG5vIGRlZmF1bHRQcm9wcykKICAgICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKG91dGVyTWVtb1R5cGUpCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIGlmIChzaGFsbG93RXF1YWwyKHByZXZQcm9wcywgbmV4dFByb3BzKSAmJiBjdXJyZW50NC5yZWYgPT09IHdvcmtJblByb2dyZXNzMi5yZWYgJiYgLy8gUHJldmVudCBiYWlsb3V0IGlmIHRoZSBpbXBsZW1lbnRhdGlvbiBjaGFuZ2VkIGR1ZSB0byBob3QgcmVsb2FkLgogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9PT0gY3VycmVudDQudHlwZSkgewogICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzID0gbmV4dFByb3BzID0gcHJldlByb3BzOwogICAgICAgICAgICAgIGlmICghY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDQsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGN1cnJlbnQ0LmxhbmVzOwogICAgICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKChjdXJyZW50NC5mbGFncyAmIEZvcmNlVXBkYXRlRm9yTGVnYWN5U3VzcGVuc2UpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cGRhdGVGdW5jdGlvbkNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlT2Zmc2NyZWVuQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQubWVtb2l6ZWRTdGF0ZSA6IG51bGw7CiAgICAgICAgICBpZiAobmV4dFByb3BzLm1vZGUgPT09ICJoaWRkZW4iIHx8IGVuYWJsZUxlZ2FjeUhpZGRlbikgewogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICB2YXIgbmV4dFN0YXRlID0gewogICAgICAgICAgICAgICAgYmFzZUxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgICAgY2FjaGVQb29sOiBudWxsLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV4dFN0YXRlOwogICAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCBPZmZzY3JlZW5MYW5lKSkgewogICAgICAgICAgICAgIHZhciBzcGF3bmVkQ2FjaGVQb29sID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgbmV4dEJhc2VMYW5lczsKICAgICAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkJhc2VMYW5lcyA9IHByZXZTdGF0ZS5iYXNlTGFuZXM7CiAgICAgICAgICAgICAgICBuZXh0QmFzZUxhbmVzID0gbWVyZ2VMYW5lcyhwcmV2QmFzZUxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXh0QmFzZUxhbmVzID0gcmVuZGVyTGFuZXMyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyA9IGxhbmVUb0xhbmVzKE9mZnNjcmVlbkxhbmUpOwogICAgICAgICAgICAgIHZhciBfbmV4dFN0YXRlID0gewogICAgICAgICAgICAgICAgYmFzZUxhbmVzOiBuZXh0QmFzZUxhbmVzLAogICAgICAgICAgICAgICAgY2FjaGVQb29sOiBzcGF3bmVkQ2FjaGVQb29sLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gX25leHRTdGF0ZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIG5leHRCYXNlTGFuZXMpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfbmV4dFN0YXRlMiA9IHsKICAgICAgICAgICAgICAgIGJhc2VMYW5lczogTm9MYW5lcywKICAgICAgICAgICAgICAgIGNhY2hlUG9vbDogbnVsbCwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25zOiBudWxsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IF9uZXh0U3RhdGUyOwogICAgICAgICAgICAgIHZhciBzdWJ0cmVlUmVuZGVyTGFuZXMyID0gcHJldlN0YXRlICE9PSBudWxsID8gcHJldlN0YXRlLmJhc2VMYW5lcyA6IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgICBwdXNoUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyLCBzdWJ0cmVlUmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIF9zdWJ0cmVlUmVuZGVyTGFuZXM7CiAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBfc3VidHJlZVJlbmRlckxhbmVzID0gbWVyZ2VMYW5lcyhwcmV2U3RhdGUuYmFzZUxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBfc3VidHJlZVJlbmRlckxhbmVzID0gcmVuZGVyTGFuZXMyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIF9zdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRnJhZ21lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1vZGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVByb2ZpbGVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBzdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlZihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB2YXIgcmVmID0gd29ya0luUHJvZ3Jlc3MyLnJlZjsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCAmJiByZWYgIT09IG51bGwgfHwgY3VycmVudDQgIT09IG51bGwgJiYgY3VycmVudDQucmVmICE9PSByZWYpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFJlZjI7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmU3RhdGljOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udGV4dDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSk7CiAgICAgICAgICAgIGNvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW47CiAgICAgICAgICB2YXIgaGFzSWQ7CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgIWRpZFJlY2VpdmVVcGRhdGUpIHsKICAgICAgICAgICAgYmFpbG91dEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBoYXNJZCkgewogICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNsYXNzQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChzaG91bGRFcnJvcih3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgY2FzZSBmYWxzZTogewogICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB2YXIgY3RvciA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgICAgdmFyIHRlbXBJbnN0YW5jZSA9IG5ldyBjdG9yKHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzLCBfaW5zdGFuY2UuY29udGV4dCk7CiAgICAgICAgICAgICAgICB2YXIgc3RhdGUgPSB0ZW1wSW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICAgICAgICBfaW5zdGFuY2UudXBkYXRlci5lbnF1ZXVlU2V0U3RhdGUoX2luc3RhbmNlLCBzdGF0ZSwgbnVsbCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSB0cnVlOiB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTaG91bGRDYXB0dXJlOwogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSBuZXcgRXJyb3IoIlNpbXVsYXRlZCBlcnJvciBjb21pbmcgZnJvbSBEZXZUb29scyIpOwogICAgICAgICAgICAgICAgdmFyIGxhbmUgPSBwaWNrQXJiaXRyYXJ5TGFuZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMsIGxhbmUpOwogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihlcnJvciQxLCB3b3JrSW5Qcm9ncmVzczIpLCBsYW5lKTsKICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHVwZGF0ZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaGFzQ29udGV4dDsKICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgIGhhc0NvbnRleHQgPSB0cnVlOwogICAgICAgICAgICBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBoYXNDb250ZXh0ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZTsKICAgICAgICAgIGlmIChpbnN0YW5jZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICBjb25zdHJ1Y3RDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMpOwogICAgICAgICAgICBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gcmVzdW1lTW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzaG91bGRVcGRhdGUgPSB1cGRhdGVDbGFzc0luc3RhbmNlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRVbml0T2ZXb3JrID0gZmluaXNoQ2xhc3NDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBzaG91bGRVcGRhdGUsIGhhc0NvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0ID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSAmJiBpbnN0LnByb3BzICE9PSBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJdCBsb29rcyBsaWtlICVzIGlzIHJlYXNzaWduaW5nIGl0cyBvd24gYHRoaXMucHJvcHNgIHdoaWxlIHJlbmRlcmluZy4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCBjYW4gbGVhZCB0byBjb25mdXNpbmcgYnVncy4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzMikgfHwgImEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV4dFVuaXRPZldvcms7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmlzaENsYXNzQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgc2hvdWxkVXBkYXRlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIG1hcmtSZWYoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgZGlkQ2FwdHVyZUVycm9yID0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgaWYgKCFzaG91bGRVcGRhdGUgJiYgIWRpZENhcHR1cmVFcnJvcikgewogICAgICAgICAgICBpZiAoaGFzQ29udGV4dCkgewogICAgICAgICAgICAgIGludmFsaWRhdGVDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW47CiAgICAgICAgICBpZiAoZGlkQ2FwdHVyZUVycm9yICYmIHR5cGVvZiBDb21wb25lbnQuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZygpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gaW5zdGFuY2UucmVuZGVyKCk7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5yZW5kZXIoKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiBkaWRDYXB0dXJlRXJyb3IpIHsKICAgICAgICAgICAgZm9yY2VVbm1vdW50Q3VycmVudEFuZFJlY29uY2lsZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IGluc3RhbmNlLnN0YXRlOwogICAgICAgICAgaWYgKGhhc0NvbnRleHQpIHsKICAgICAgICAgICAgaW52YWxpZGF0ZUNvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoSG9zdFJvb3RDb250ZXh0KHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgdmFyIHJvb3QzID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIGlmIChyb290My5wZW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICBwdXNoVG9wTGV2ZWxDb250ZXh0T2JqZWN0KHdvcmtJblByb2dyZXNzMiwgcm9vdDMucGVuZGluZ0NvbnRleHQsIHJvb3QzLnBlbmRpbmdDb250ZXh0ICE9PSByb290My5jb250ZXh0KTsKICAgICAgICAgIH0gZWxzZSBpZiAocm9vdDMuY29udGV4dCkgewogICAgICAgICAgICBwdXNoVG9wTGV2ZWxDb250ZXh0T2JqZWN0KHdvcmtJblByb2dyZXNzMiwgcm9vdDMuY29udGV4dCwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgcHVzaEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyLCByb290My5jb250YWluZXJJbmZvKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSG9zdFJvb3QoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBwdXNoSG9zdFJvb3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgaGF2ZSBhIGN1cnJlbnQgZmliZXIuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBwcmV2Q2hpbGRyZW4gPSBwcmV2U3RhdGUuZWxlbWVudDsKICAgICAgICAgIGNsb25lVXBkYXRlUXVldWUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBwcm9jZXNzVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJvcHMsIG51bGwsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgbmV4dFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgcm9vdDMgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IG5leHRTdGF0ZS5lbGVtZW50OwogICAgICAgICAgaWYgKHByZXZTdGF0ZS5pc0RlaHlkcmF0ZWQpIHsKICAgICAgICAgICAgdmFyIG92ZXJyaWRlU3RhdGUgPSB7CiAgICAgICAgICAgICAgZWxlbWVudDogbmV4dENoaWxkcmVuLAogICAgICAgICAgICAgIGlzRGVoeWRyYXRlZDogZmFsc2UsCiAgICAgICAgICAgICAgY2FjaGU6IG5leHRTdGF0ZS5jYWNoZSwKICAgICAgICAgICAgICBwZW5kaW5nU3VzcGVuc2VCb3VuZGFyaWVzOiBuZXh0U3RhdGUucGVuZGluZ1N1c3BlbnNlQm91bmRhcmllcywKICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbmV4dFN0YXRlLnRyYW5zaXRpb25zCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgdXBkYXRlUXVldWUuYmFzZVN0YXRlID0gb3ZlcnJpZGVTdGF0ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBvdmVycmlkZVN0YXRlOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpIHsKICAgICAgICAgICAgICB2YXIgcmVjb3ZlcmFibGVFcnJvciA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKG5ldyBFcnJvcigiVGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGh5ZHJhdGluZy4gQmVjYXVzZSB0aGUgZXJyb3IgaGFwcGVuZWQgb3V0c2lkZSBvZiBhIFN1c3BlbnNlIGJvdW5kYXJ5LCB0aGUgZW50aXJlIHJvb3Qgd2lsbCBzd2l0Y2ggdG8gY2xpZW50IHJlbmRlcmluZy4iKSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRIb3N0Um9vdFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIsIHJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRDaGlsZHJlbiAhPT0gcHJldkNoaWxkcmVuKSB7CiAgICAgICAgICAgICAgdmFyIF9yZWNvdmVyYWJsZUVycm9yID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIobmV3IEVycm9yKCJUaGlzIHJvb3QgcmVjZWl2ZWQgYW4gZWFybHkgdXBkYXRlLCBiZWZvcmUgYW55dGhpbmcgd2FzIGFibGUgaHlkcmF0ZS4gU3dpdGNoZWQgdGhlIGVudGlyZSByb290IHRvIGNsaWVudCByZW5kZXJpbmcuIiksIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SG9zdFJvb3RXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyLCBfcmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZW50ZXJIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBjaGlsZCA9IG1vdW50Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBudWxsLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSBjaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICAgICAgbm9kZS5mbGFncyA9IG5vZGUuZmxhZ3MgJiB+UGxhY2VtZW50IHwgSHlkcmF0aW5nOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgaWYgKG5leHRDaGlsZHJlbiA9PT0gcHJldkNoaWxkcmVuKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEhvc3RSb290V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMiwgcmVjb3ZlcmFibGVFcnJvcikgewogICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZSgpOwogICAgICAgICAgcXVldWVIeWRyYXRpb25FcnJvcihyZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBGb3JjZUNsaWVudFJlbmRlcjsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvc3RDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBwdXNoSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHR5cGUgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQubWVtb2l6ZWRQcm9wcyA6IG51bGw7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgdmFyIGlzRGlyZWN0VGV4dENoaWxkID0gc2hvdWxkU2V0VGV4dENvbnRlbnQodHlwZSwgbmV4dFByb3BzKTsKICAgICAgICAgIGlmIChpc0RpcmVjdFRleHRDaGlsZCkgewogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgfSBlbHNlIGlmIChwcmV2UHJvcHMgIT09IG51bGwgJiYgc2hvdWxkU2V0VGV4dENvbnRlbnQodHlwZSwgcHJldlByb3BzKSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ29udGVudFJlc2V0OwogICAgICAgICAgfQogICAgICAgICAgbWFya1JlZihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvc3RUZXh0KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50TGF6eUNvbXBvbmVudChfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyLCBlbGVtZW50VHlwZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gZWxlbWVudFR5cGU7CiAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gaW5pdChwYXlsb2FkKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50OwogICAgICAgICAgdmFyIHJlc29sdmVkVGFnID0gd29ya0luUHJvZ3Jlc3MyLnRhZyA9IHJlc29sdmVMYXp5Q29tcG9uZW50VGFnKENvbXBvbmVudCk7CiAgICAgICAgICB2YXIgcmVzb2x2ZWRQcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMyKENvbXBvbmVudCwgcHJvcHMpOwogICAgICAgICAgdmFyIGNoaWxkOwogICAgICAgICAgc3dpdGNoIChyZXNvbHZlZFRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50ID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlRnVuY3Rpb25Db21wb25lbnQobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudCA9IHJlc29sdmVDbGFzc0ZvckhvdFJlbG9hZGluZyhDb21wb25lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZUNsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBDb21wb25lbnQgPSByZXNvbHZlRm9yd2FyZFJlZkZvckhvdFJlbG9hZGluZyhDb21wb25lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZUZvcndhcmRSZWYobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBvdXRlclByb3BUeXBlcyA9IENvbXBvbmVudC5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICAgICAgb3V0ZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZFByb3BzLAogICAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgZm9yIG91dGVyIG9ubHkKICAgICAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZU1lbW9Db21wb25lbnQoCiAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLAogICAgICAgICAgICAgICAgQ29tcG9uZW50LAogICAgICAgICAgICAgICAgcmVzb2x2ZURlZmF1bHRQcm9wczIoQ29tcG9uZW50LnR5cGUsIHJlc29sdmVkUHJvcHMpLAogICAgICAgICAgICAgICAgLy8gVGhlIGlubmVyIHR5cGUgY2FuIGhhdmUgZGVmYXVsdHMgdG9vCiAgICAgICAgICAgICAgICByZW5kZXJMYW5lczIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGhpbnQgPSAiIjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKENvbXBvbmVudCAhPT0gbnVsbCAmJiB0eXBlb2YgQ29tcG9uZW50ID09PSAib2JqZWN0IiAmJiBDb21wb25lbnQuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgIGhpbnQgPSAiIERpZCB5b3Ugd3JhcCBhIGNvbXBvbmVudCBpbiBSZWFjdC5sYXp5KCkgbW9yZSB0aGFuIG9uY2U/IjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFbGVtZW50IHR5cGUgaXMgaW52YWxpZC4gUmVjZWl2ZWQgYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG86ICIgKyBDb21wb25lbnQgKyAiLiAiICsgKCJMYXp5IGVsZW1lbnQgdHlwZSBtdXN0IHJlc29sdmUgdG8gYSBjbGFzcyBvciBmdW5jdGlvbi4iICsgaGludCkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEluY29tcGxldGVDbGFzc0NvbXBvbmVudChfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRhZyA9IENsYXNzQ29tcG9uZW50OwogICAgICAgICAgdmFyIGhhc0NvbnRleHQ7CiAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzKTsKICAgICAgICAgIG1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIGZpbmlzaENsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCB0cnVlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEluZGV0ZXJtaW5hdGVDb21wb25lbnQoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJlc2V0U3VzcGVuZGVkQ3VycmVudE9uTW91bnRJbkxlZ2FjeU1vZGUoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgcHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIGNvbnRleHQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIGZhbHNlKTsKICAgICAgICAgICAgY29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIHZhbHVlOwogICAgICAgICAgdmFyIGhhc0lkOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoQ29tcG9uZW50LnByb3RvdHlwZSAmJiB0eXBlb2YgQ29tcG9uZW50LnByb3RvdHlwZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEJhZENsYXNzW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIDwlcyAvPiBjb21wb25lbnQgYXBwZWFycyB0byBoYXZlIGEgcmVuZGVyIG1ldGhvZCwgYnV0IGRvZXNuJ3QgZXh0ZW5kIFJlYWN0LkNvbXBvbmVudC4gVGhpcyBpcyBsaWtlbHkgdG8gY2F1c2UgZXJyb3JzLiBDaGFuZ2UgJXMgdG8gZXh0ZW5kIFJlYWN0LkNvbXBvbmVudCBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0QmFkQ2xhc3NbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkTGVnYWN5Q29udGV4dFdhcm5pbmcod29ya0luUHJvZ3Jlc3MyLCBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyh0cnVlKTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICB2YWx1ZSA9IHJlbmRlcldpdGhIb29rcyhudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIgJiYgdmFsdWUuJCR0eXBlb2YgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIDwlcyAvPiBjb21wb25lbnQgYXBwZWFycyB0byBiZSBhIGZ1bmN0aW9uIGNvbXBvbmVudCB0aGF0IHJldHVybnMgYSBjbGFzcyBpbnN0YW5jZS4gQ2hhbmdlICVzIHRvIGEgY2xhc3MgdGhhdCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCBpbnN0ZWFkLiBJZiB5b3UgY2FuJ3QgdXNlIGEgY2xhc3MgdHJ5IGFzc2lnbmluZyB0aGUgcHJvdG90eXBlIG9uIHRoZSBmdW5jdGlvbiBhcyBhIHdvcmthcm91bmQuIGAlcy5wcm90b3R5cGUgPSBSZWFjdC5Db21wb25lbnQucHJvdG90eXBlYC4gRG9uJ3QgdXNlIGFuIGFycm93IGZ1bmN0aW9uIHNpbmNlIGl0IGNhbm5vdCBiZSBjYWxsZWQgd2l0aCBgbmV3YCBieSBSZWFjdC4iLCBfY29tcG9uZW50TmFtZSwgX2NvbXBvbmVudE5hbWUsIF9jb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICgKICAgICAgICAgICAgLy8gUnVuIHRoZXNlIGNoZWNrcyBpbiBwcm9kdWN0aW9uIG9ubHkgaWYgdGhlIGZsYWcgaXMgb2ZmLgogICAgICAgICAgICAvLyBFdmVudHVhbGx5IHdlJ2xsIGRlbGV0ZSB0aGlzIGJyYW5jaCBhbHRvZ2V0aGVyLgogICAgICAgICAgICB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIgJiYgdmFsdWUuJCR0eXBlb2YgPT09IHZvaWQgMAogICAgICAgICAgKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUyID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TW9kdWxlUGF0dGVybkNvbXBvbmVudFtfY29tcG9uZW50TmFtZTJdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIDwlcyAvPiBjb21wb25lbnQgYXBwZWFycyB0byBiZSBhIGZ1bmN0aW9uIGNvbXBvbmVudCB0aGF0IHJldHVybnMgYSBjbGFzcyBpbnN0YW5jZS4gQ2hhbmdlICVzIHRvIGEgY2xhc3MgdGhhdCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCBpbnN0ZWFkLiBJZiB5b3UgY2FuJ3QgdXNlIGEgY2xhc3MgdHJ5IGFzc2lnbmluZyB0aGUgcHJvdG90eXBlIG9uIHRoZSBmdW5jdGlvbiBhcyBhIHdvcmthcm91bmQuIGAlcy5wcm90b3R5cGUgPSBSZWFjdC5Db21wb25lbnQucHJvdG90eXBlYC4gRG9uJ3QgdXNlIGFuIGFycm93IGZ1bmN0aW9uIHNpbmNlIGl0IGNhbm5vdCBiZSBjYWxsZWQgd2l0aCBgbmV3YCBieSBSZWFjdC4iLCBfY29tcG9uZW50TmFtZTIsIF9jb21wb25lbnROYW1lMiwgX2NvbXBvbmVudE5hbWUyKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWUyXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50YWcgPSBDbGFzc0NvbXBvbmVudDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICB2YXIgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgIGhhc0NvbnRleHQgPSB0cnVlOwogICAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBoYXNDb250ZXh0ID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSB2YWx1ZS5zdGF0ZSAhPT0gbnVsbCAmJiB2YWx1ZS5zdGF0ZSAhPT0gdm9pZCAwID8gdmFsdWUuc3RhdGUgOiBudWxsOwogICAgICAgICAgICBpbml0aWFsaXplVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgYWRvcHRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgdmFsdWUpOwogICAgICAgICAgICBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gZmluaXNoQ2xhc3NDb21wb25lbnQobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUsIGhhc0NvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHZhbHVlID0gcmVuZGVyV2l0aEhvb2tzKG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBoYXNJZCkgewogICAgICAgICAgICAgIHB1c2hNYXRlcmlhbGl6ZWRUcmVlSWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihudWxsLCB3b3JrSW5Qcm9ncmVzczIsIHZhbHVlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUZ1bmN0aW9uQ29tcG9uZW50SW5EZXYod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKENvbXBvbmVudCkgewogICAgICAgICAgICAgIGlmIChDb21wb25lbnQuY2hpbGRDb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBjaGlsZENvbnRleHRUeXBlcyBjYW5ub3QgYmUgZGVmaW5lZCBvbiBhIGZ1bmN0aW9uIGNvbXBvbmVudC4iLCBDb21wb25lbnQuZGlzcGxheU5hbWUgfHwgQ29tcG9uZW50Lm5hbWUgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgdmFyIG93bmVyTmFtZSA9IGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCk7CiAgICAgICAgICAgICAgaWYgKG93bmVyTmFtZSkgewogICAgICAgICAgICAgICAgaW5mbyArPSAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgb3duZXJOYW1lICsgImAuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdhcm5pbmdLZXkgPSBvd25lck5hbWUgfHwgIiI7CiAgICAgICAgICAgICAgdmFyIGRlYnVnU291cmNlID0gd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgICAgICBpZiAoZGVidWdTb3VyY2UpIHsKICAgICAgICAgICAgICAgIHdhcm5pbmdLZXkgPSBkZWJ1Z1NvdXJjZS5maWxlTmFtZSArICI6IiArIGRlYnVnU291cmNlLmxpbmVOdW1iZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RnVuY3Rpb25SZWZzW3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRGdW5jdGlvblJlZnNbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIkZ1bmN0aW9uIGNvbXBvbmVudHMgY2Fubm90IGJlIGdpdmVuIHJlZnMuIEF0dGVtcHRzIHRvIGFjY2VzcyB0aGlzIHJlZiB3aWxsIGZhaWwuIERpZCB5b3UgbWVhbiB0byB1c2UgUmVhY3QuZm9yd2FyZFJlZigpPyVzIiwgaW5mbyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChDb21wb25lbnQuZGVmYXVsdFByb3BzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogU3VwcG9ydCBmb3IgZGVmYXVsdFByb3BzIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIGZ1bmN0aW9uIGNvbXBvbmVudHMgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gVXNlIEphdmFTY3JpcHQgZGVmYXVsdCBwYXJhbWV0ZXJzIGluc3RlYWQuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBDb21wb25lbnQuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIF9jb21wb25lbnROYW1lMyA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWUzXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBGdW5jdGlvbiBjb21wb25lbnRzIGRvIG5vdCBzdXBwb3J0IGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4iLCBfY29tcG9uZW50TmFtZTMpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2V0RGVyaXZlZFN0YXRlT25GdW5jdGlvbkNvbXBvbmVudFtfY29tcG9uZW50TmFtZTNdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBDb21wb25lbnQuY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIENvbXBvbmVudC5jb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZTQgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWU0XSkgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBGdW5jdGlvbiBjb21wb25lbnRzIGRvIG5vdCBzdXBwb3J0IGNvbnRleHRUeXBlLiIsIF9jb21wb25lbnROYW1lNCk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWU0XSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBTVVNQRU5ERURfTUFSS0VSID0gewogICAgICAgICAgZGVoeWRyYXRlZDogbnVsbCwKICAgICAgICAgIHRyZWVDb250ZXh0OiBudWxsLAogICAgICAgICAgcmV0cnlMYW5lOiBOb0xhbmUKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGJhc2VMYW5lczogcmVuZGVyTGFuZXMyLAogICAgICAgICAgICBjYWNoZVBvb2w6IGdldFN1c3BlbmRlZENhY2hlKCksCiAgICAgICAgICAgIHRyYW5zaXRpb25zOiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHByZXZPZmZzY3JlZW5TdGF0ZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgY2FjaGVQb29sID0gbnVsbDsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGJhc2VMYW5lczogbWVyZ2VMYW5lcyhwcmV2T2Zmc2NyZWVuU3RhdGUuYmFzZUxhbmVzLCByZW5kZXJMYW5lczIpLAogICAgICAgICAgICBjYWNoZVBvb2wsCiAgICAgICAgICAgIHRyYW5zaXRpb25zOiBwcmV2T2Zmc2NyZWVuU3RhdGUudHJhbnNpdGlvbnMKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFJlbWFpbk9uRmFsbGJhY2soc3VzcGVuc2VDb250ZXh0LCBjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaGFzU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgRm9yY2VTdXNwZW5zZUZhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UmVtYWluaW5nV29ya0luUHJpbWFyeVRyZWUoY3VycmVudDQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmV0dXJuIHJlbW92ZUxhbmVzKGN1cnJlbnQ0LmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChzaG91bGRTdXNwZW5kKHdvcmtJblByb2dyZXNzMikpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHN1c3BlbnNlQ29udGV4dCA9IHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIHZhciBzaG93RmFsbGJhY2sgPSBmYWxzZTsKICAgICAgICAgIHZhciBkaWRTdXNwZW5kID0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgaWYgKGRpZFN1c3BlbmQgfHwgc2hvdWxkUmVtYWluT25GYWxsYmFjayhzdXNwZW5zZUNvbnRleHQsIGN1cnJlbnQ0KSkgewogICAgICAgICAgICBzaG93RmFsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfkRpZENhcHR1cmU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwgfHwgY3VycmVudDQubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IGFkZFN1YnRyZWVTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBJbnZpc2libGVQYXJlbnRTdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGRlaHlkcmF0ZWQgPSBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgaWYgKGRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudERlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudCh3b3JrSW5Qcm9ncmVzczIsIGRlaHlkcmF0ZWQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV4dFByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgdmFyIG5leHRGYWxsYmFja0NoaWxkcmVuID0gbmV4dFByb3BzLmZhbGxiYWNrOwogICAgICAgICAgICBpZiAoc2hvd0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgdmFyIGZhbGxiYWNrRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlRmFsbGJhY2tDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIG5leHRQcmltYXJ5Q2hpbGRyZW4sIG5leHRGYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5tZW1vaXplZFN0YXRlID0gbW91bnRTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBTVVNQRU5ERURfTUFSS0VSOwogICAgICAgICAgICAgIHJldHVybiBmYWxsYmFja0ZyYWdtZW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgbmV4dFByaW1hcnlDaGlsZHJlbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIF9kZWh5ZHJhdGVkID0gcHJldlN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgaWYgKF9kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVoeWRyYXRlZFN1c3BlbnNlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIGRpZFN1c3BlbmQsIG5leHRQcm9wcywgX2RlaHlkcmF0ZWQsIHByZXZTdGF0ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNob3dGYWxsYmFjaykgewogICAgICAgICAgICAgIHZhciBfbmV4dEZhbGxiYWNrQ2hpbGRyZW4gPSBuZXh0UHJvcHMuZmFsbGJhY2s7CiAgICAgICAgICAgICAgdmFyIF9uZXh0UHJpbWFyeUNoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSB1cGRhdGVTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgX25leHRQcmltYXJ5Q2hpbGRyZW4sIF9uZXh0RmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50MiA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN0YXRlID0gY3VycmVudDQuY2hpbGQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBfcHJpbWFyeUNoaWxkRnJhZ21lbnQyLm1lbW9pemVkU3RhdGUgPSBwcmV2T2Zmc2NyZWVuU3RhdGUgPT09IG51bGwgPyBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKSA6IHVwZGF0ZVN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocHJldk9mZnNjcmVlblN0YXRlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDIuY2hpbGRMYW5lcyA9IGdldFJlbWFpbmluZ1dvcmtJblByaW1hcnlUcmVlKGN1cnJlbnQ0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gU1VTUEVOREVEX01BUktFUjsKICAgICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfbmV4dFByaW1hcnlDaGlsZHJlbjIgPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDMgPSB1cGRhdGVTdXNwZW5zZVByaW1hcnlDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBfbmV4dFByaW1hcnlDaGlsZHJlbjIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybiBfcHJpbWFyeUNoaWxkRnJhZ21lbnQzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRQcm9wcyA9IHsKICAgICAgICAgICAgbW9kZTogInZpc2libGUiLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gbW91bnRXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKHByaW1hcnlDaGlsZFByb3BzLCBtb2RlKTsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlRmFsbGJhY2tDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbiwgZmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IHdvcmtJblByb2dyZXNzMi5tb2RlOwogICAgICAgICAgdmFyIHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJoaWRkZW4iLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgdmFyIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIGlmICgobW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmIHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50OwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucGVuZGluZ1Byb3BzID0gcHJpbWFyeUNoaWxkUHJvcHM7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuYWN0dWFsRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbFN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNlbGZCYXNlRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb24gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGZhbGxiYWNrQ2hpbGRyZW4sIG1vZGUsIHJlbmRlckxhbmVzMiwgbnVsbCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihwcmltYXJ5Q2hpbGRQcm9wcywgbW9kZSk7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGZhbGxiYWNrQ2hpbGRyZW4sIG1vZGUsIHJlbmRlckxhbmVzMiwgbnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZyA9IGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKG9mZnNjcmVlblByb3BzLCBtb2RlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21PZmZzY3JlZW4ob2Zmc2NyZWVuUHJvcHMsIG1vZGUsIE5vTGFuZXMsIG51bGwpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKGN1cnJlbnQ0LCBvZmZzY3JlZW5Qcm9wcykgewogICAgICAgICAgcmV0dXJuIGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnQ0LCBvZmZzY3JlZW5Qcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50ID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICB2YXIgY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQsIHsKICAgICAgICAgICAgbW9kZTogInZpc2libGUiLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9KTsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5sYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgIH0KICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgaWYgKGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGRlbGV0aW9ucyA9IHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnM7CiAgICAgICAgICAgIGlmIChkZWxldGlvbnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zID0gW2N1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnRdOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBDaGlsZERlbGV0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbiwgZmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IHdvcmtJblByb2dyZXNzMi5tb2RlOwogICAgICAgICAgdmFyIGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgdmFyIGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZzsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRQcm9wcyA9IHsKICAgICAgICAgICAgbW9kZTogImhpZGRlbiIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIEluIGxlZ2FjeSBtb2RlLCB3ZSBjb21taXQgdGhlIHByaW1hcnkgdHJlZSBhcyBpZiBpdCBzdWNjZXNzZnVsbHkKICAgICAgICAgICAgLy8gY29tcGxldGVkLCBldmVuIHRob3VnaCBpdCdzIGluIGFuIGluY29uc2lzdGVudCBzdGF0ZS4KICAgICAgICAgICAgKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSAmJiAvLyBNYWtlIHN1cmUgd2UncmUgb24gdGhlIHNlY29uZCBwYXNzLCBpLmUuIHRoZSBwcmltYXJ5IGNoaWxkIGZyYWdtZW50IHdhcwogICAgICAgICAgICAvLyBhbHJlYWR5IGNsb25lZC4gSW4gbGVnYWN5IG1vZGUsIHRoZSBvbmx5IGNhc2Ugd2hlcmUgdGhpcyBpc24ndCB0cnVlIGlzCiAgICAgICAgICAgIC8vIHdoZW4gRGV2VG9vbHMgZm9yY2VzIHVzIHRvIGRpc3BsYXkgYSBmYWxsYmFjazsgd2Ugc2tpcCB0aGUgZmlyc3QgcmVuZGVyCiAgICAgICAgICAgIC8vIHBhc3MgZW50aXJlbHkgYW5kIGdvIHN0cmFpZ2h0IHRvIHJlbmRlcmluZyB0aGUgZmFsbGJhY2suIChJbiBDb25jdXJyZW50CiAgICAgICAgICAgIC8vIE1vZGUsIFN1c3BlbnNlTGlzdCBjYW4gYWxzbyB0cmlnZ2VyIHRoaXMgc2NlbmFyaW8sIGJ1dCB0aGlzIGlzIGEgbGVnYWN5LQogICAgICAgICAgICAvLyBvbmx5IGNvZGVwYXRoLikKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkICE9PSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQKICAgICAgICAgICkgewogICAgICAgICAgICB2YXIgcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50OwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucGVuZGluZ1Byb3BzID0gcHJpbWFyeUNoaWxkUHJvcHM7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuYWN0dWFsRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbFN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNlbGZCYXNlRHVyYXRpb24gPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHVwZGF0ZVdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIoY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LCBwcmltYXJ5Q2hpbGRQcm9wcyk7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnN1YnRyZWVGbGFncyA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC5zdWJ0cmVlRmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIGlmIChjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQsIGZhbGxiYWNrQ2hpbGRyZW4pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZmFsbGJhY2tDaGlsZHJlbiwgbW9kZSwgcmVuZGVyTGFuZXMyLCBudWxsKTsKICAgICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICByZXR1cm4gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIHJlY292ZXJhYmxlRXJyb3IpIHsKICAgICAgICAgIGlmIChyZWNvdmVyYWJsZUVycm9yICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IocmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgICByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGN1cnJlbnQ0LmNoaWxkLCBudWxsLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gbW91bnRTdXNwZW5zZVByaW1hcnlDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbik7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3VzcGVuc2VGYWxsYmFja0FmdGVyUmV0cnlXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbiwgZmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgZmliZXJNb2RlID0gd29ya0luUHJvZ3Jlc3MyLm1vZGU7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihwcmltYXJ5Q2hpbGRQcm9wcywgZmliZXJNb2RlKTsKICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBmaWJlck1vZGUsIHJlbmRlckxhbmVzMiwgbnVsbCk7CiAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGN1cnJlbnQ0LmNoaWxkLCBudWxsLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnREZWh5ZHJhdGVkU3VzcGVuc2VDb21wb25lbnQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUluc3RhbmNlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCBoeWRyYXRlIFN1c3BlbnNlIGluIGxlZ2FjeSBtb2RlLiBTd2l0Y2ggZnJvbSBSZWFjdERPTS5oeWRyYXRlKGVsZW1lbnQsIGNvbnRhaW5lcikgdG8gUmVhY3RET01DbGllbnQuaHlkcmF0ZVJvb3QoY29udGFpbmVyLCA8QXBwIC8+KS5yZW5kZXIoZWxlbWVudCkgb3IgcmVtb3ZlIHRoZSBTdXNwZW5zZSBjb21wb25lbnRzIGZyb20gdGhlIHNlcnZlciByZW5kZXJlZCBjb21wb25lbnRzLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKFN5bmNMYW5lKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soc3VzcGVuc2VJbnN0YW5jZSkpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbGFuZVRvTGFuZXMoRGVmYXVsdEh5ZHJhdGlvbkxhbmUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbGFuZVRvTGFuZXMoT2Zmc2NyZWVuTGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRGVoeWRyYXRlZFN1c3BlbnNlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIGRpZFN1c3BlbmQsIG5leHRQcm9wcywgc3VzcGVuc2VJbnN0YW5jZSwgc3VzcGVuc2VTdGF0ZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoIWRpZFN1c3BlbmQpIHsKICAgICAgICAgICAgd2FybklmSHlkcmF0aW5nKCk7CiAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZygKICAgICAgICAgICAgICAgIGN1cnJlbnQ0LAogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLAogICAgICAgICAgICAgICAgcmVuZGVyTGFuZXMyLAogICAgICAgICAgICAgICAgLy8gVE9ETzogV2hlbiB3ZSBkZWxldGUgbGVnYWN5IG1vZGUsIHdlIHNob3VsZCBtYWtlIHRoaXMgZXJyb3IgYXJndW1lbnQKICAgICAgICAgICAgICAgIC8vIHJlcXVpcmVkIOKAlCBldmVyeSBjb25jdXJyZW50IG1vZGUgcGF0aCB0aGF0IGNhdXNlcyBoeWRyYXRpb24gdG8KICAgICAgICAgICAgICAgIC8vIGRlLW9wdCB0byBjbGllbnQgcmVuZGVyaW5nIHNob3VsZCBoYXZlIGFuIGVycm9yIG1lc3NhZ2UuCiAgICAgICAgICAgICAgICBudWxsCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soc3VzcGVuc2VJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICB2YXIgZGlnZXN0LCBtZXNzYWdlLCBzdGFjazsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgX2dldFN1c3BlbnNlSW5zdGFuY2VGID0gZ2V0U3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrRXJyb3JEZXRhaWxzKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgZGlnZXN0ID0gX2dldFN1c3BlbnNlSW5zdGFuY2VGLmRpZ2VzdDsKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBfZ2V0U3VzcGVuc2VJbnN0YW5jZUYubWVzc2FnZTsKICAgICAgICAgICAgICAgIHN0YWNrID0gX2dldFN1c3BlbnNlSW5zdGFuY2VGLnN0YWNrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXJyb3IyOwogICAgICAgICAgICAgIGlmIChtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IobWVzc2FnZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yMiA9IG5ldyBFcnJvcigiVGhlIHNlcnZlciBjb3VsZCBub3QgZmluaXNoIHRoaXMgU3VzcGVuc2UgYm91bmRhcnksIGxpa2VseSBkdWUgdG8gYW4gZXJyb3IgZHVyaW5nIHNlcnZlciByZW5kZXJpbmcuIFN3aXRjaGVkIHRvIGNsaWVudCByZW5kZXJpbmcuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjYXB0dXJlZFZhbHVlID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZShlcnJvcjIsIGRpZ2VzdCwgc3RhY2spOwogICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIGNhcHR1cmVkVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYXNDb250ZXh0Q2hhbmdlZDIgPSBpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgY3VycmVudDQuY2hpbGRMYW5lcyk7CiAgICAgICAgICAgIGlmIChkaWRSZWNlaXZlVXBkYXRlIHx8IGhhc0NvbnRleHRDaGFuZ2VkMikgewogICAgICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGF0dGVtcHRIeWRyYXRpb25BdExhbmUgPSBnZXRCdW1wZWRMYW5lRm9ySHlkcmF0aW9uKHJvb3QzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgaWYgKGF0dGVtcHRIeWRyYXRpb25BdExhbmUgIT09IE5vTGFuZSAmJiBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lICE9PSBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZSkgewogICAgICAgICAgICAgICAgICBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZSA9IGF0dGVtcHRIeWRyYXRpb25BdExhbmU7CiAgICAgICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgICAgICAgZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGN1cnJlbnQ0LCBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lKTsKICAgICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBjdXJyZW50NCwgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVuZGVyRGlkU3VzcGVuZERlbGF5SWZQb3NzaWJsZSgpOwogICAgICAgICAgICAgIHZhciBfY2FwdHVyZWRWYWx1ZSA9IGNyZWF0ZUNhcHR1cmVkVmFsdWUobmV3IEVycm9yKCJUaGlzIFN1c3BlbnNlIGJvdW5kYXJ5IHJlY2VpdmVkIGFuIHVwZGF0ZSBiZWZvcmUgaXQgZmluaXNoZWQgaHlkcmF0aW5nLiBUaGlzIGNhdXNlZCB0aGUgYm91bmRhcnkgdG8gc3dpdGNoIHRvIGNsaWVudCByZW5kZXJpbmcuIFRoZSB1c3VhbCB3YXkgdG8gZml4IHRoaXMgaXMgdG8gd3JhcCB0aGUgb3JpZ2luYWwgdXBkYXRlIGluIHN0YXJ0VHJhbnNpdGlvbi4iKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJldHJ5U3VzcGVuc2VDb21wb25lbnRXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMiwgX2NhcHR1cmVkVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZVBlbmRpbmcoc3VzcGVuc2VJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgICAgICB2YXIgcmV0cnkgPSByZXRyeURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5LmJpbmQobnVsbCwgY3VycmVudDQpOwogICAgICAgICAgICAgIHJlZ2lzdGVyU3VzcGVuc2VJbnN0YW5jZVJldHJ5KHN1c3BlbnNlSW5zdGFuY2UsIHJldHJ5KTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZWVudGVySHlkcmF0aW9uU3RhdGVGcm9tRGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUluc3RhbmNlLCBzdXNwZW5zZVN0YXRlLnRyZWVDb250ZXh0KTsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmZsYWdzIHw9IEh5ZHJhdGluZzsKICAgICAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBGb3JjZUNsaWVudFJlbmRlcikgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+Rm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgICAgdmFyIF9jYXB0dXJlZFZhbHVlMiA9IGNyZWF0ZUNhcHR1cmVkVmFsdWUobmV3IEVycm9yKCJUaGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgaHlkcmF0aW5nIHRoaXMgU3VzcGVuc2UgYm91bmRhcnkuIFN3aXRjaGVkIHRvIGNsaWVudCByZW5kZXJpbmcuIikpOwogICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIF9jYXB0dXJlZFZhbHVlMik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAod29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgbmV4dFByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgbmV4dEZhbGxiYWNrQ2hpbGRyZW4gPSBuZXh0UHJvcHMuZmFsbGJhY2s7CiAgICAgICAgICAgICAgdmFyIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VGYWxsYmFja0FmdGVyUmV0cnlXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRQcmltYXJ5Q2hpbGRyZW4sIG5leHRGYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQ0ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDQubWVtb2l6ZWRTdGF0ZSA9IG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gU1VTUEVOREVEX01BUktFUjsKICAgICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlU3VzcGVuc2VXb3JrT25GaWJlcihmaWJlciwgcmVuZGVyTGFuZXMyLCBwcm9wYWdhdGlvblJvb3QpIHsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbWVyZ2VMYW5lcyhmaWJlci5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFsdGVybmF0ZS5sYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChmaWJlci5yZXR1cm4sIHJlbmRlckxhbmVzMiwgcHJvcGFnYXRpb25Sb290KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvcGFnYXRlU3VzcGVuc2VDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgZmlyc3RDaGlsZCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIHN0YXRlID0gbm9kZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVTdXNwZW5zZVdvcmtPbkZpYmVyKG5vZGUsIHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlTGlzdENvbXBvbmVudCkgewogICAgICAgICAgICAgIHNjaGVkdWxlU3VzcGVuc2VXb3JrT25GaWJlcihub2RlLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZSA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kTGFzdENvbnRlbnRSb3coZmlyc3RDaGlsZCkgewogICAgICAgICAgdmFyIHJvdyA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICB2YXIgbGFzdENvbnRlbnRSb3cgPSBudWxsOwogICAgICAgICAgd2hpbGUgKHJvdyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudFJvdyA9IHJvdy5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50Um93ICE9PSBudWxsICYmIGZpbmRGaXJzdFN1c3BlbmRlZChjdXJyZW50Um93KSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGxhc3RDb250ZW50Um93ID0gcm93OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJvdyA9IHJvdy5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhc3RDb250ZW50Um93OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVJldmVhbE9yZGVyKHJldmVhbE9yZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXZlYWxPcmRlciAhPT0gdm9pZCAwICYmIHJldmVhbE9yZGVyICE9PSAiZm9yd2FyZHMiICYmIHJldmVhbE9yZGVyICE9PSAiYmFja3dhcmRzIiAmJiByZXZlYWxPcmRlciAhPT0gInRvZ2V0aGVyIiAmJiAhZGlkV2FybkFib3V0UmV2ZWFsT3JkZXJbcmV2ZWFsT3JkZXJdKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXJbcmV2ZWFsT3JkZXJdID0gdHJ1ZTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHJldmVhbE9yZGVyID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgc3dpdGNoIChyZXZlYWxPcmRlci50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgInRvZ2V0aGVyIjoKICAgICAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZHMiOgogICAgICAgICAgICAgICAgICBjYXNlICJiYWNrd2FyZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoJyIlcyIgaXMgbm90IGEgdmFsaWQgdmFsdWUgZm9yIHJldmVhbE9yZGVyIG9uIDxTdXNwZW5zZUxpc3QgLz4uIFVzZSBsb3dlcmNhc2UgIiVzIiBpbnN0ZWFkLicsIHJldmVhbE9yZGVyLCByZXZlYWxPcmRlci50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjYXNlICJmb3J3YXJkIjoKICAgICAgICAgICAgICAgICAgY2FzZSAiYmFja3dhcmQiOiB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoJyIlcyIgaXMgbm90IGEgdmFsaWQgdmFsdWUgZm9yIHJldmVhbE9yZGVyIG9uIDxTdXNwZW5zZUxpc3QgLz4uIFJlYWN0IHVzZXMgdGhlIC1zIHN1ZmZpeCBpbiB0aGUgc3BlbGxpbmcuIFVzZSAiJXNzIiBpbnN0ZWFkLicsIHJldmVhbE9yZGVyLCByZXZlYWxPcmRlci50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHN1cHBvcnRlZCByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gInRvZ2V0aGVyIiwgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIj8nLCByZXZlYWxPcmRlcik7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCclcyBpcyBub3QgYSBzdXBwb3J0ZWQgdmFsdWUgZm9yIHJldmVhbE9yZGVyIG9uIDxTdXNwZW5zZUxpc3QgLz4uIERpZCB5b3UgbWVhbiAidG9nZXRoZXIiLCAiZm9yd2FyZHMiIG9yICJiYWNrd2FyZHMiPycsIHJldmVhbE9yZGVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVUYWlsT3B0aW9ucyh0YWlsTW9kZSwgcmV2ZWFsT3JkZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHRhaWxNb2RlICE9PSB2b2lkIDAgJiYgIWRpZFdhcm5BYm91dFRhaWxPcHRpb25zW3RhaWxNb2RlXSkgewogICAgICAgICAgICAgIGlmICh0YWlsTW9kZSAhPT0gImNvbGxhcHNlZCIgJiYgdGFpbE1vZGUgIT09ICJoaWRkZW4iKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoJyIlcyIgaXMgbm90IGEgc3VwcG9ydGVkIHZhbHVlIGZvciB0YWlsIG9uIDxTdXNwZW5zZUxpc3QgLz4uIERpZCB5b3UgbWVhbiAiY29sbGFwc2VkIiBvciAiaGlkZGVuIj8nLCB0YWlsTW9kZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXZlYWxPcmRlciAhPT0gImZvcndhcmRzIiAmJiByZXZlYWxPcmRlciAhPT0gImJhY2t3YXJkcyIpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zW3RhaWxNb2RlXSA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcignPFN1c3BlbnNlTGlzdCB0YWlsPSIlcyIgLz4gaXMgb25seSB2YWxpZCBpZiByZXZlYWxPcmRlciBpcyAiZm9yd2FyZHMiIG9yICJiYWNrd2FyZHMiLiBEaWQgeW91IG1lYW4gdG8gc3BlY2lmeSByZXZlYWxPcmRlcj0iZm9yd2FyZHMiPycsIHRhaWxNb2RlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVTdXNwZW5zZUxpc3ROZXN0ZWRDaGlsZChjaGlsZFNsb3QsIGluZGV4MikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNBbkFycmF5ID0gaXNBcnJheTIoY2hpbGRTbG90KTsKICAgICAgICAgICAgdmFyIGlzSXRlcmFibGUgPSAhaXNBbkFycmF5ICYmIHR5cGVvZiBnZXRJdGVyYXRvckZuKGNoaWxkU2xvdCkgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICAgIGlmIChpc0FuQXJyYXkgfHwgaXNJdGVyYWJsZSkgewogICAgICAgICAgICAgIHZhciB0eXBlID0gaXNBbkFycmF5ID8gImFycmF5IiA6ICJpdGVyYWJsZSI7CiAgICAgICAgICAgICAgZXJyb3IoIkEgbmVzdGVkICVzIHdhcyBwYXNzZWQgdG8gcm93ICMlcyBpbiA8U3VzcGVuc2VMaXN0IC8+LiBXcmFwIGl0IGluIGFuIGFkZGl0aW9uYWwgU3VzcGVuc2VMaXN0IHRvIGNvbmZpZ3VyZSBpdHMgcmV2ZWFsT3JkZXI6IDxTdXNwZW5zZUxpc3QgcmV2ZWFsT3JkZXI9Li4uPiAuLi4gPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0uLi4+eyVzfTwvU3VzcGVuc2VMaXN0PiAuLi4gPC9TdXNwZW5zZUxpc3Q+IiwgdHlwZSwgaW5kZXgyLCB0eXBlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVN1c3BlbnNlTGlzdENoaWxkcmVuKGNoaWxkcmVuLCByZXZlYWxPcmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKHJldmVhbE9yZGVyID09PSAiZm9yd2FyZHMiIHx8IHJldmVhbE9yZGVyID09PSAiYmFja3dhcmRzIikgJiYgY2hpbGRyZW4gIT09IHZvaWQgMCAmJiBjaGlsZHJlbiAhPT0gbnVsbCAmJiBjaGlsZHJlbiAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICBpZiAoaXNBcnJheTIoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGlmICghdmFsaWRhdGVTdXNwZW5zZUxpc3ROZXN0ZWRDaGlsZChjaGlsZHJlbltpXSwgaSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKGNoaWxkcmVuKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB2YXIgY2hpbGRyZW5JdGVyYXRvciA9IGl0ZXJhdG9yRm4uY2FsbChjaGlsZHJlbik7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbkl0ZXJhdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0ZXAgPSBjaGlsZHJlbkl0ZXJhdG9yLm5leHQoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgX2kgPSAwOwogICAgICAgICAgICAgICAgICAgIGZvciAoOyAhc3RlcC5kb25lOyBzdGVwID0gY2hpbGRyZW5JdGVyYXRvci5uZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghdmFsaWRhdGVTdXNwZW5zZUxpc3ROZXN0ZWRDaGlsZChzdGVwLnZhbHVlLCBfaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgX2krKzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCdBIHNpbmdsZSByb3cgd2FzIHBhc3NlZCB0byBhIDxTdXNwZW5zZUxpc3QgcmV2ZWFsT3JkZXI9IiVzIiAvPi4gVGhpcyBpcyBub3QgdXNlZnVsIHNpbmNlIGl0IG5lZWRzIG11bHRpcGxlIHJvd3MuIERpZCB5b3UgbWVhbiB0byBwYXNzIG11bHRpcGxlIGNoaWxkcmVuIG9yIGFuIGFycmF5PycsIHJldmVhbE9yZGVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKHdvcmtJblByb2dyZXNzMiwgaXNCYWNrd2FyZHMsIHRhaWwsIGxhc3RDb250ZW50Um93LCB0YWlsTW9kZSkgewogICAgICAgICAgdmFyIHJlbmRlclN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAocmVuZGVyU3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSB7CiAgICAgICAgICAgICAgaXNCYWNrd2FyZHMsCiAgICAgICAgICAgICAgcmVuZGVyaW5nOiBudWxsLAogICAgICAgICAgICAgIHJlbmRlcmluZ1N0YXJ0VGltZTogMCwKICAgICAgICAgICAgICBsYXN0OiBsYXN0Q29udGVudFJvdywKICAgICAgICAgICAgICB0YWlsLAogICAgICAgICAgICAgIHRhaWxNb2RlCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZW5kZXJTdGF0ZS5pc0JhY2t3YXJkcyA9IGlzQmFja3dhcmRzOwogICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmcgPSBudWxsOwogICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmdTdGFydFRpbWUgPSAwOwogICAgICAgICAgICByZW5kZXJTdGF0ZS5sYXN0ID0gbGFzdENvbnRlbnRSb3c7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSB0YWlsOwogICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsTW9kZSA9IHRhaWxNb2RlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZUxpc3RDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciByZXZlYWxPcmRlciA9IG5leHRQcm9wcy5yZXZlYWxPcmRlcjsKICAgICAgICAgIHZhciB0YWlsTW9kZSA9IG5leHRQcm9wcy50YWlsOwogICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgdmFsaWRhdGVSZXZlYWxPcmRlcihyZXZlYWxPcmRlcik7CiAgICAgICAgICB2YWxpZGF0ZVRhaWxPcHRpb25zKHRhaWxNb2RlLCByZXZlYWxPcmRlcik7CiAgICAgICAgICB2YWxpZGF0ZVN1c3BlbnNlTGlzdENoaWxkcmVuKG5ld0NoaWxkcmVuLCByZXZlYWxPcmRlcik7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXdDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBzdXNwZW5zZUNvbnRleHQgPSBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgc2hvdWxkRm9yY2VGYWxsYmFjayA9IGhhc1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgICBpZiAoc2hvdWxkRm9yY2VGYWxsYmFjaykgewogICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBzZXRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgRm9yY2VTdXNwZW5zZUZhbGxiYWNrKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZGlkU3VzcGVuZEJlZm9yZSA9IGN1cnJlbnQ0ICE9PSBudWxsICYmIChjdXJyZW50NC5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEJlZm9yZSkgewogICAgICAgICAgICAgIHByb3BhZ2F0ZVN1c3BlbnNlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi5jaGlsZCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3dpdGNoIChyZXZlYWxPcmRlcikgewogICAgICAgICAgICAgIGNhc2UgImZvcndhcmRzIjogewogICAgICAgICAgICAgICAgdmFyIGxhc3RDb250ZW50Um93ID0gZmluZExhc3RDb250ZW50Um93KHdvcmtJblByb2dyZXNzMi5jaGlsZCk7CiAgICAgICAgICAgICAgICB2YXIgdGFpbDsKICAgICAgICAgICAgICAgIGlmIChsYXN0Q29udGVudFJvdyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0YWlsID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGFpbCA9IGxhc3RDb250ZW50Um93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIGxhc3RDb250ZW50Um93LnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgICAgICAvLyBpc0JhY2t3YXJkcwogICAgICAgICAgICAgICAgICB0YWlsLAogICAgICAgICAgICAgICAgICBsYXN0Q29udGVudFJvdywKICAgICAgICAgICAgICAgICAgdGFpbE1vZGUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSAiYmFja3dhcmRzIjogewogICAgICAgICAgICAgICAgdmFyIF90YWlsID0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciByb3cgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICAgICAgd2hpbGUgKHJvdyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFJvdyA9IHJvdy5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Um93ICE9PSBudWxsICYmIGZpbmRGaXJzdFN1c3BlbmRlZChjdXJyZW50Um93KSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJvdzsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgbmV4dFJvdyA9IHJvdy5zaWJsaW5nOwogICAgICAgICAgICAgICAgICByb3cuc2libGluZyA9IF90YWlsOwogICAgICAgICAgICAgICAgICBfdGFpbCA9IHJvdzsKICAgICAgICAgICAgICAgICAgcm93ID0gbmV4dFJvdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluaXRTdXNwZW5zZUxpc3RSZW5kZXJTdGF0ZSgKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLAogICAgICAgICAgICAgICAgICB0cnVlLAogICAgICAgICAgICAgICAgICAvLyBpc0JhY2t3YXJkcwogICAgICAgICAgICAgICAgICBfdGFpbCwKICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgICAgLy8gbGFzdAogICAgICAgICAgICAgICAgICB0YWlsTW9kZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlICJ0b2dldGhlciI6IHsKICAgICAgICAgICAgICAgIGluaXRTdXNwZW5zZUxpc3RSZW5kZXJTdGF0ZSgKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLAogICAgICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAgICAgLy8gaXNCYWNrd2FyZHMKICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgICAgLy8gdGFpbAogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAvLyBsYXN0CiAgICAgICAgICAgICAgICAgIHZvaWQgMAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVQb3J0YWxDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBwdXNoSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyk7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIG51bGwsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nTm9WYWx1ZVByb3BPbkNvbnRleHRQcm92aWRlciA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNvbnRleHRQcm92aWRlcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBwcm92aWRlclR5cGUgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgIHZhciBjb250ZXh0ID0gcHJvdmlkZXJUeXBlLl9jb250ZXh0OwogICAgICAgICAgdmFyIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBvbGRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzOwogICAgICAgICAgdmFyIG5ld1ZhbHVlID0gbmV3UHJvcHMudmFsdWU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghKCJ2YWx1ZSIgaW4gbmV3UHJvcHMpKSB7CiAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nTm9WYWx1ZVByb3BPbkNvbnRleHRQcm92aWRlcikgewogICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXRVc2luZ05vVmFsdWVQcm9wT25Db250ZXh0UHJvdmlkZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSBgdmFsdWVgIHByb3AgaXMgcmVxdWlyZWQgZm9yIHRoZSBgPENvbnRleHQuUHJvdmlkZXI+YC4gRGlkIHlvdSBtaXNzcGVsbCBpdCBvciBmb3JnZXQgdG8gcGFzcyBpdD8iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb3ZpZGVyUHJvcFR5cGVzID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICBpZiAocHJvdmlkZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhwcm92aWRlclByb3BUeXBlcywgbmV3UHJvcHMsICJwcm9wIiwgIkNvbnRleHQuUHJvdmlkZXIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcHVzaFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgbmV3VmFsdWUpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAob2xkUHJvcHMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgb2xkVmFsdWUgPSBvbGRQcm9wcy52YWx1ZTsKICAgICAgICAgICAgICBpZiAob2JqZWN0SXMob2xkVmFsdWUsIG5ld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgaWYgKG9sZFByb3BzLmNoaWxkcmVuID09PSBuZXdQcm9wcy5jaGlsZHJlbiAmJiAhaGFzQ29udGV4dENoYW5nZWQoKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdDaGlsZHJlbiA9IG5ld1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV3Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnRleHRBc0NvbnN1bWVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ29udGV4dENvbnN1bWVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGNvbnRleHQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGNvbnRleHQuX2NvbnRleHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGlmIChjb250ZXh0ICE9PSBjb250ZXh0LkNvbnN1bWVyKSB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdDb250ZXh0QXNDb25zdW1lcikgewogICAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nQ29udGV4dEFzQ29uc3VtZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyaW5nIDxDb250ZXh0PiBkaXJlY3RseSBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIHJlbmRlciA8Q29udGV4dC5Db25zdW1lcj4gaW5zdGVhZD8iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQuX2NvbnRleHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcmVuZGVyMiA9IG5ld1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHJlbmRlcjIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb250ZXh0IGNvbnN1bWVyIHdhcyByZW5kZXJlZCB3aXRoIG11bHRpcGxlIGNoaWxkcmVuLCBvciBhIGNoaWxkIHRoYXQgaXNuJ3QgYSBmdW5jdGlvbi4gQSBjb250ZXh0IGNvbnN1bWVyIGV4cGVjdHMgYSBzaW5nbGUgY2hpbGQgdGhhdCBpcyBhIGZ1bmN0aW9uLiBJZiB5b3UgZGlkIHBhc3MgYSBmdW5jdGlvbiwgbWFrZSBzdXJlIHRoZXJlIGlzIG5vIHRyYWlsaW5nIG9yIGxlYWRpbmcgd2hpdGVzcGFjZSBhcm91bmQgaXQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld0NoaWxkcmVuOwogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICBuZXdDaGlsZHJlbiA9IHJlbmRlcjIobmV3VmFsdWUpOwogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5ld0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKSB7CiAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgY3VycmVudDQuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IGN1cnJlbnQ0LmRlcGVuZGVuY2llczsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoKTsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzKTsKICAgICAgICAgIGlmICghaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNsb25lQ2hpbGRGaWJlcnMoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdW50RmliZXIoY3VycmVudDQsIG9sZFdvcmtJblByb2dyZXNzLCBuZXdXb3JrSW5Qcm9ncmVzcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcmV0dXJuRmliZXIgPSBvbGRXb3JrSW5Qcm9ncmVzcy5yZXR1cm47CiAgICAgICAgICAgIGlmIChyZXR1cm5GaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHN3YXAgdGhlIHJvb3QgZmliZXIuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudDQuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgICAgb2xkV29ya0luUHJvZ3Jlc3MuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MuaW5kZXggPSBvbGRXb3JrSW5Qcm9ncmVzcy5pbmRleDsKICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3Muc2libGluZyA9IG9sZFdvcmtJblByb2dyZXNzLnNpYmxpbmc7CiAgICAgICAgICAgIG5ld1dvcmtJblByb2dyZXNzLnJldHVybiA9IG9sZFdvcmtJblByb2dyZXNzLnJldHVybjsKICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MucmVmID0gb2xkV29ya0luUHJvZ3Jlc3MucmVmOwogICAgICAgICAgICBpZiAob2xkV29ya0luUHJvZ3Jlc3MgPT09IHJldHVybkZpYmVyLmNoaWxkKSB7CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuY2hpbGQgPSBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgcHJldlNpYmxpbmcgPSByZXR1cm5GaWJlci5jaGlsZDsKICAgICAgICAgICAgICBpZiAocHJldlNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgcGFyZW50IHRvIGhhdmUgYSBjaGlsZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKHByZXZTaWJsaW5nLnNpYmxpbmcgIT09IG9sZFdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICAgICAgICBwcmV2U2libGluZyA9IHByZXZTaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgICBpZiAocHJldlNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBmaW5kIHRoZSBwcmV2aW91cyBzaWJsaW5nLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2U2libGluZy5zaWJsaW5nID0gbmV3V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRlbGV0aW9ucyA9IHJldHVybkZpYmVyLmRlbGV0aW9uczsKICAgICAgICAgICAgaWYgKGRlbGV0aW9ucyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IFtjdXJyZW50NF07CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjdXJyZW50NCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICByZXR1cm4gbmV3V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQ0LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciB1cGRhdGVMYW5lcyA9IGN1cnJlbnQ0LmxhbmVzOwogICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUodXBkYXRlTGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRFYXJseUJhaWxvdXRJZk5vU2NoZWR1bGVkVXBkYXRlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZSgpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcHVzaEhvc3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDb250ZXh0UHJvdmlkZXI6IHsKICAgICAgICAgICAgICB2YXIgbmV3VmFsdWUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcy52YWx1ZTsKICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlLl9jb250ZXh0OwogICAgICAgICAgICAgIHB1c2hQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIG5ld1ZhbHVlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBoYXNDaGlsZFdvcmsgPSBpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMpOwogICAgICAgICAgICAgICAgaWYgKGhhc0NoaWxkV29yaykgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICAgICAgc3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50KSk7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRMYW5lcyA9IHByaW1hcnlDaGlsZEZyYWdtZW50LmNoaWxkTGFuZXM7CiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHByaW1hcnlDaGlsZExhbmVzKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmRCZWZvcmUgPSAoY3VycmVudDQuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgICB2YXIgX2hhc0NoaWxkV29yayA9IGluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRCZWZvcmUpIHsKICAgICAgICAgICAgICAgIGlmIChfaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUxpc3RDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVuZGVyU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZyA9IG51bGw7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsID0gbnVsbDsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLmxhc3RFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50KTsKICAgICAgICAgICAgICBpZiAoX2hhc0NoaWxkV29yaykgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVPZmZzY3JlZW5Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmVnaW5Xb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z05lZWRzUmVtb3VudCAmJiBjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiByZW1vdW50RmliZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKHdvcmtJblByb2dyZXNzMi50eXBlLCB3b3JrSW5Qcm9ncmVzczIua2V5LCB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLCB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnT3duZXIgfHwgbnVsbCwgd29ya0luUHJvZ3Jlc3MyLm1vZGUsIHdvcmtJblByb2dyZXNzMi5sYW5lcykpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgdmFyIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgaWYgKG9sZFByb3BzICE9PSBuZXdQcm9wcyB8fCBoYXNDb250ZXh0Q2hhbmdlZCgpIHx8IC8vIEZvcmNlIGEgcmUtcmVuZGVyIGlmIHRoZSBpbXBsZW1lbnRhdGlvbiBjaGFuZ2VkIGR1ZSB0byBob3QgcmVsb2FkOgogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gY3VycmVudDQudHlwZSkgewogICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBoYXNTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQgPSBjaGVja1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dChjdXJyZW50NCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBpZiAoIWhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCAmJiAvLyBJZiB0aGlzIGlzIHRoZSBzZWNvbmQgcGFzcyBvZiBhbiBlcnJvciBvciBzdXNwZW5zZSBib3VuZGFyeSwgdGhlcmUKICAgICAgICAgICAgICAvLyBtYXkgbm90IGJlIHdvcmsgc2NoZWR1bGVkIG9uIGBjdXJyZW50YCwgc28gd2UgY2hlY2sgZm9yIHRoaXMgZmxhZy4KICAgICAgICAgICAgICAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybiBhdHRlbXB0RWFybHlCYWlsb3V0SWZOb1NjaGVkdWxlZFVwZGF0ZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKGN1cnJlbnQ0LmZsYWdzICYgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpICYmIGlzRm9ya2VkQ2hpbGQod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgIHZhciBzbG90SW5kZXggPSB3b3JrSW5Qcm9ncmVzczIuaW5kZXg7CiAgICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSBnZXRGb3Jrc0F0TGV2ZWwoKTsKICAgICAgICAgICAgICBwdXNoVHJlZUlkKHdvcmtJblByb2dyZXNzMiwgbnVtYmVyT2ZGb3Jrcywgc2xvdEluZGV4KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbmRldGVybWluYXRlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi50eXBlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRMYXp5Q29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIGVsZW1lbnRUeXBlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIHVucmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIHJlc29sdmVkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPT09IENvbXBvbmVudCA/IHVucmVzb2x2ZWRQcm9wcyA6IHJlc29sdmVEZWZhdWx0UHJvcHMyKENvbXBvbmVudCwgdW5yZXNvbHZlZFByb3BzKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnVuY3Rpb25Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgX0NvbXBvbmVudCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIHZhciBfdW5yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPT09IF9Db21wb25lbnQgPyBfdW5yZXNvbHZlZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wczIoX0NvbXBvbmVudCwgX3VucmVzb2x2ZWRQcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNsYXNzQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIF9Db21wb25lbnQsIF9yZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUhvc3RSb290KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSG9zdENvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVIb3N0VGV4dChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWxDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjogewogICAgICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHMyID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHMyID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSB0eXBlID8gX3VucmVzb2x2ZWRQcm9wczIgOiByZXNvbHZlRGVmYXVsdFByb3BzMih0eXBlLCBfdW5yZXNvbHZlZFByb3BzMik7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZvcndhcmRSZWYoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgdHlwZSwgX3Jlc29sdmVkUHJvcHMyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRnJhZ21lbnQ5OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1vZGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUHJvZmlsZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBDb250ZXh0UHJvdmlkZXI6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNvbnRleHRQcm92aWRlcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIENvbnRleHRDb25zdW1lcjoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ29udGV4dENvbnN1bWVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBfdHlwZTIgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wczMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciBfcmVzb2x2ZWRQcm9wczMgPSByZXNvbHZlRGVmYXVsdFByb3BzMihfdHlwZTIsIF91bnJlc29sdmVkUHJvcHMzKTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgICAgICB2YXIgb3V0ZXJQcm9wVHlwZXMgPSBfdHlwZTIucHJvcFR5cGVzOwogICAgICAgICAgICAgICAgICBpZiAob3V0ZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICAgIG91dGVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICAgICAgX3Jlc29sdmVkUHJvcHMzLAogICAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgZm9yIG91dGVyIG9ubHkKICAgICAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShfdHlwZTIpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBfcmVzb2x2ZWRQcm9wczMgPSByZXNvbHZlRGVmYXVsdFByb3BzMihfdHlwZTIudHlwZSwgX3Jlc29sdmVkUHJvcHMzKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTWVtb0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBfdHlwZTIsIF9yZXNvbHZlZFByb3BzMywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU2ltcGxlTWVtb0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIudHlwZSwgd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBfQ29tcG9uZW50MiA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIHZhciBfdW5yZXNvbHZlZFByb3BzNCA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIF9yZXNvbHZlZFByb3BzNCA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA9PT0gX0NvbXBvbmVudDIgPyBfdW5yZXNvbHZlZFByb3BzNCA6IHJlc29sdmVEZWZhdWx0UHJvcHMyKF9Db21wb25lbnQyLCBfdW5yZXNvbHZlZFByb3BzNCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIF9Db21wb25lbnQyLCBfcmVzb2x2ZWRQcm9wczQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VMaXN0Q29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDogewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU9mZnNjcmVlbkNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gdW5pdCBvZiB3b3JrIHRhZyAoIiArIHdvcmtJblByb2dyZXNzMi50YWcgKyAiKS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZWYkMSh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBSZWYyOwogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmU3RhdGljOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYXBwZW5kQWxsQ2hpbGRyZW47CiAgICAgICAgdmFyIHVwZGF0ZUhvc3RDb250YWluZXI7CiAgICAgICAgdmFyIHVwZGF0ZUhvc3RDb21wb25lbnQkMTsKICAgICAgICB2YXIgdXBkYXRlSG9zdFRleHQkMTsKICAgICAgICB7CiAgICAgICAgICBhcHBlbmRBbGxDaGlsZHJlbiA9IGZ1bmN0aW9uKHBhcmVudCwgd29ya0luUHJvZ3Jlc3MyLCBuZWVkc1Zpc2liaWxpdHlUb2dnbGUsIGlzSGlkZGVuKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICAgIGFwcGVuZEluaXRpYWxDaGlsZChwYXJlbnQsIG5vZGUuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBIb3N0UG9ydGFsKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lciA9IGZ1bmN0aW9uKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVIb3N0Q29tcG9uZW50JDEgPSBmdW5jdGlvbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciBvbGRQcm9wcyA9IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyA9PT0gbmV3UHJvcHMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gcHJlcGFyZVVwZGF0ZShpbnN0YW5jZSwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlSG9zdFRleHQkMSA9IGZ1bmN0aW9uKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG9sZFRleHQsIG5ld1RleHQpIHsKICAgICAgICAgICAgaWYgKG9sZFRleHQgIT09IG5ld1RleHQpIHsKICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgaGFzUmVuZGVyZWRBVGFpbEZhbGxiYWNrKSB7CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHJlbmRlclN0YXRlLnRhaWxNb2RlKSB7CiAgICAgICAgICAgIGNhc2UgImhpZGRlbiI6IHsKICAgICAgICAgICAgICB2YXIgdGFpbE5vZGUgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgIHZhciBsYXN0VGFpbE5vZGUgPSBudWxsOwogICAgICAgICAgICAgIHdoaWxlICh0YWlsTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHRhaWxOb2RlLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsYXN0VGFpbE5vZGUgPSB0YWlsTm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhaWxOb2RlID0gdGFpbE5vZGUuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGxhc3RUYWlsTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxhc3RUYWlsTm9kZS5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAiY29sbGFwc2VkIjogewogICAgICAgICAgICAgIHZhciBfdGFpbE5vZGUgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgIHZhciBfbGFzdFRhaWxOb2RlID0gbnVsbDsKICAgICAgICAgICAgICB3aGlsZSAoX3RhaWxOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoX3RhaWxOb2RlLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBfbGFzdFRhaWxOb2RlID0gX3RhaWxOb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgX3RhaWxOb2RlID0gX3RhaWxOb2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChfbGFzdFRhaWxOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc1JlbmRlcmVkQVRhaWxGYWxsYmFjayAmJiByZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2xhc3RUYWlsTm9kZS5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYnViYmxlUHJvcGVydGllcyhjb21wbGV0ZWRXb3JrKSB7CiAgICAgICAgICB2YXIgZGlkQmFpbG91dCA9IGNvbXBsZXRlZFdvcmsuYWx0ZXJuYXRlICE9PSBudWxsICYmIGNvbXBsZXRlZFdvcmsuYWx0ZXJuYXRlLmNoaWxkID09PSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgdmFyIG5ld0NoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoIWRpZEJhaWxvdXQpIHsKICAgICAgICAgICAgaWYgKChjb21wbGV0ZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHZhciBhY3R1YWxEdXJhdGlvbiA9IGNvbXBsZXRlZFdvcmsuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgdmFyIHRyZWVCYXNlRHVyYXRpb24gPSBjb21wbGV0ZWRXb3JrLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgdmFyIGNoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5ld0NoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5ld0NoaWxkTGFuZXMsIG1lcmdlTGFuZXMoY2hpbGQubGFuZXMsIGNoaWxkLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBjaGlsZC5zdWJ0cmVlRmxhZ3M7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gY2hpbGQuZmxhZ3M7CiAgICAgICAgICAgICAgICBhY3R1YWxEdXJhdGlvbiArPSBjaGlsZC5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgIHRyZWVCYXNlRHVyYXRpb24gKz0gY2hpbGQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbiA9IGFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsudHJlZUJhc2VEdXJhdGlvbiA9IHRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9jaGlsZCA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKF9jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQubGFuZXMsIF9jaGlsZC5jaGlsZExhbmVzKSk7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkLnN1YnRyZWVGbGFnczsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQuZmxhZ3M7CiAgICAgICAgICAgICAgICBfY2hpbGQucmV0dXJuID0gY29tcGxldGVkV29yazsKICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnN1YnRyZWVGbGFncyB8PSBzdWJ0cmVlRmxhZ3M7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgdmFyIF90cmVlQmFzZUR1cmF0aW9uID0gY29tcGxldGVkV29yay5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgIHZhciBfY2hpbGQyID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQyLmxhbmVzLCBfY2hpbGQyLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQyLnN1YnRyZWVGbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMi5mbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBfdHJlZUJhc2VEdXJhdGlvbiArPSBfY2hpbGQyLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICBfY2hpbGQyID0gX2NoaWxkMi5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnRyZWVCYXNlRHVyYXRpb24gPSBfdHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2NoaWxkMyA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKF9jaGlsZDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5ld0NoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5ld0NoaWxkTGFuZXMsIG1lcmdlTGFuZXMoX2NoaWxkMy5sYW5lcywgX2NoaWxkMy5jaGlsZExhbmVzKSk7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMy5zdWJ0cmVlRmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDMuZmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgICAgICAgX2NoaWxkMy5yZXR1cm4gPSBjb21wbGV0ZWRXb3JrOwogICAgICAgICAgICAgICAgX2NoaWxkMyA9IF9jaGlsZDMuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGxldGVkV29yay5zdWJ0cmVlRmxhZ3MgfD0gc3VidHJlZUZsYWdzOwogICAgICAgICAgfQogICAgICAgICAgY29tcGxldGVkV29yay5jaGlsZExhbmVzID0gbmV3Q2hpbGRMYW5lczsKICAgICAgICAgIHJldHVybiBkaWRCYWlsb3V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRTdGF0ZSkgewogICAgICAgICAgaWYgKGhhc1VuaHlkcmF0ZWRUYWlsTm9kZXMoKSAmJiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSAmJiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgd2FybklmVW5oeWRyYXRlZFRhaWxOb2Rlcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBGb3JjZUNsaWVudFJlbmRlciB8IEluY29tcGxldGUgfCBTaG91bGRDYXB0dXJlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2FzSHlkcmF0ZWQgPSBwb3BIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgaWYgKG5leHRTdGF0ZSAhPT0gbnVsbCAmJiBuZXh0U3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoIXdhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkEgZGVoeWRyYXRlZCBzdXNwZW5zZSBjb21wb25lbnQgd2FzIGNvbXBsZXRlZCB3aXRob3V0IGEgaHlkcmF0ZWQgbm9kZS4gVGhpcyBpcyBwcm9iYWJseSBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJlcGFyZVRvSHlkcmF0ZUhvc3RTdXNwZW5zZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB2YXIgaXNUaW1lZE91dFN1c3BlbnNlID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoaXNUaW1lZE91dFN1c3BlbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChwcmltYXJ5Q2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gLT0gcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB2YXIgX2lzVGltZWRPdXRTdXNwZW5zZSA9IG5leHRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKF9pc1RpbWVkT3V0U3VzcGVuc2UpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChfcHJpbWFyeUNoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uIC09IF9wcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZ3JhZGVIeWRyYXRpb25FcnJvcnNUb1JlY292ZXJhYmxlKCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZVdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgcG9wVHJlZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIEZyYWdtZW50OToKICAgICAgICAgICAgY2FzZSBNb2RlOgogICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICBjYXNlIENvbnRleHRDb25zdW1lcjoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcG9wQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciBmaWJlclJvb3QgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwb3BUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICBpZiAoZmliZXJSb290LnBlbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgICAgICBmaWJlclJvb3QuY29udGV4dCA9IGZpYmVyUm9vdC5wZW5kaW5nQ29udGV4dDsKICAgICAgICAgICAgICAgIGZpYmVyUm9vdC5wZW5kaW5nQ29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC5jaGlsZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHdhc0h5ZHJhdGVkID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmICh3YXNIeWRyYXRlZCkgewogICAgICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGlzIGlzIGEgY2xpZW50IHJvb3QKICAgICAgICAgICAgICAgICAgICAgICFwcmV2U3RhdGUuaXNEZWh5ZHJhdGVkIHx8IC8vIENoZWNrIGlmIHdlIHJldmVydGVkIHRvIGNsaWVudCByZW5kZXJpbmcgKGUuZy4gZHVlIHRvIGFuIGVycm9yKQogICAgICAgICAgICAgICAgICAgICAgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmNlQ2xpZW50UmVuZGVyKSAhPT0gTm9GbGFncwogICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNuYXBzaG90OwogICAgICAgICAgICAgICAgICAgICAgdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgcm9vdENvbnRhaW5lckluc3RhbmNlID0gZ2V0Um9vdEhvc3RDb250YWluZXIoKTsKICAgICAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvc3RDb21wb25lbnQkMShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NC5yZWYgIT09IHdvcmtJblByb2dyZXNzMi5yZWYpIHsKICAgICAgICAgICAgICAgICAgbWFya1JlZiQxKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghbmV3UHJvcHMpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlIG11c3QgaGF2ZSBuZXcgcHJvcHMgZm9yIG5ldyBtb3VudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50SG9zdENvbnRleHQgPSBnZXRIb3N0Q29udGV4dCgpOwogICAgICAgICAgICAgICAgdmFyIF93YXNIeWRyYXRlZCA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICBpZiAoX3dhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBjdXJyZW50SG9zdENvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBjcmVhdGVJbnN0YW5jZSh0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBjdXJyZW50SG9zdENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIGFwcGVuZEFsbENoaWxkcmVuKGluc3RhbmNlLCB3b3JrSW5Qcm9ncmVzczIsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmFsaXplSW5pdGlhbENoaWxkcmVuKGluc3RhbmNlLCB0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbWFya1JlZiQxKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgdmFyIG5ld1RleHQgPSBuZXdQcm9wczsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQgJiYgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgb2xkVGV4dCA9IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICB1cGRhdGVIb3N0VGV4dCQxKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG9sZFRleHQsIG5ld1RleHQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld1RleHQgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXZSBtdXN0IGhhdmUgbmV3IHByb3BzIGZvciBuZXcgbW91bnRzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgX3Jvb3RDb250YWluZXJJbnN0YW5jZSA9IGdldFJvb3RIb3N0Q29udGFpbmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgX2N1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgICAgICB2YXIgX3dhc0h5ZHJhdGVkMiA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICBpZiAoX3dhc0h5ZHJhdGVkMikgewogICAgICAgICAgICAgICAgICBpZiAocHJlcGFyZVRvSHlkcmF0ZUhvc3RUZXh0SW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGNyZWF0ZVRleHRJbnN0YW5jZShuZXdUZXh0LCBfcm9vdENvbnRhaW5lckluc3RhbmNlLCBfY3VycmVudEhvc3RDb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwgfHwgY3VycmVudDQubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbCAmJiBjdXJyZW50NC5tZW1vaXplZFN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBmYWxsdGhyb3VnaFRvTm9ybWFsU3VzcGVuc2VQYXRoID0gY29tcGxldGVEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0U3RhdGUpOwogICAgICAgICAgICAgICAgaWYgKCFmYWxsdGhyb3VnaFRvTm9ybWFsU3VzcGVuc2VQYXRoKSB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJhbnNmZXJBY3R1YWxEdXJhdGlvbih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5leHREaWRUaW1lb3V0ID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIHZhciBwcmV2RGlkVGltZW91dCA9IGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKG5leHREaWRUaW1lb3V0ICE9PSBwcmV2RGlkVGltZW91dCkgewogICAgICAgICAgICAgICAgaWYgKG5leHREaWRUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgIHZhciBfb2Zmc2NyZWVuRmliZXIyID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICBfb2Zmc2NyZWVuRmliZXIyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBoYXNJbnZpc2libGVDaGlsZENvbnRleHQgPSBjdXJyZW50NCA9PT0gbnVsbCAmJiAod29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMudW5zdGFibGVfYXZvaWRUaGlzRmFsbGJhY2sgIT09IHRydWUgfHwgIWVuYWJsZVN1c3BlbnNlQXZvaWRUaGlzRmFsbGJhY2spOwogICAgICAgICAgICAgICAgICAgIGlmIChoYXNJbnZpc2libGVDaGlsZENvbnRleHQgfHwgaGFzU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCwgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgcmVuZGVyRGlkU3VzcGVuZCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgaWYgKHdha2VhYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByaW1hcnlDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiAtPSBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHVwZGF0ZUhvc3RDb250YWluZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBwcmVwYXJlUG9ydGFsTW91bnQod29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlLl9jb250ZXh0OwogICAgICAgICAgICAgIHBvcFByb3ZpZGVyKGNvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBfQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKF9Db21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciByZW5kZXJTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kQWxyZWFkeSA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRUYWlsID0gcmVuZGVyU3RhdGUucmVuZGVyaW5nOwogICAgICAgICAgICAgIGlmIChyZW5kZXJlZFRhaWwgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkU3VzcGVuZEFscmVhZHkpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNhbm5vdEJlU3VzcGVuZGVkID0gcmVuZGVySGFzTm90U3VzcGVuZGVkWWV0KCkgJiYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IChjdXJyZW50NC5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKTsKICAgICAgICAgICAgICAgICAgaWYgKCFjYW5ub3RCZVN1c3BlbmRlZCkgewogICAgICAgICAgICAgICAgICAgIHZhciByb3cgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHJvdyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHN1c3BlbmRlZCA9IGZpbmRGaXJzdFN1c3BlbmRlZChyb3cpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHN1c3BlbmRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkaWRTdXNwZW5kQWxyZWFkeSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1RoZW5hYmxlcyA9IHN1c3BlbmRlZC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1RoZW5hYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG5ld1RoZW5hYmxlczsKICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICAgICAgICAgICAgICByZXNldENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHJvdyA9IHJvdy5zaWJsaW5nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUudGFpbCAhPT0gbnVsbCAmJiBub3coKSA+IGdldFJlbmRlclRhcmdldFRpbWUoKSkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBTb21lUmV0cnlMYW5lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTdXNwZW5kQWxyZWFkeSkgewogICAgICAgICAgICAgICAgICB2YXIgX3N1c3BlbmRlZCA9IGZpbmRGaXJzdFN1c3BlbmRlZChyZW5kZXJlZFRhaWwpOwogICAgICAgICAgICAgICAgICBpZiAoX3N1c3BlbmRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB2YXIgX25ld1RoZW5hYmxlcyA9IF9zdXNwZW5kZWQudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9uZXdUaGVuYWJsZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IF9uZXdUaGVuYWJsZXM7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsID09PSBudWxsICYmIHJlbmRlclN0YXRlLnRhaWxNb2RlID09PSAiaGlkZGVuIiAmJiAhcmVuZGVyZWRUYWlsLmFsdGVybmF0ZSAmJiAhZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgICAgICAgIC8vIFRoZSB0aW1lIGl0IHRvb2sgdG8gcmVuZGVyIGxhc3Qgcm93IGlzIGdyZWF0ZXIgdGhhbiB0aGUgcmVtYWluaW5nCiAgICAgICAgICAgICAgICAgICAgLy8gdGltZSB3ZSBoYXZlIHRvIHJlbmRlci4gU28gcmVuZGVyaW5nIG9uZSBtb3JlIHJvdyB3b3VsZCBsaWtlbHkKICAgICAgICAgICAgICAgICAgICAvLyBleGNlZWQgaXQuCiAgICAgICAgICAgICAgICAgICAgbm93KCkgKiAyIC0gcmVuZGVyU3RhdGUucmVuZGVyaW5nU3RhcnRUaW1lID4gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpICYmIHJlbmRlckxhbmVzMiAhPT0gT2Zmc2NyZWVuTGFuZQogICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgICAgICBkaWRTdXNwZW5kQWxyZWFkeSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY3V0T2ZmVGFpbElmTmVlZGVkKHJlbmRlclN0YXRlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gU29tZVJldHJ5TGFuZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlLmlzQmFja3dhcmRzKSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlcmVkVGFpbC5zaWJsaW5nID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNTaWJsaW5nID0gcmVuZGVyU3RhdGUubGFzdDsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzU2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHByZXZpb3VzU2libGluZy5zaWJsaW5nID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlbmRlcmVkVGFpbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5sYXN0ID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUudGFpbCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIG5leHQgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nID0gbmV4dDsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBuZXh0LnNpYmxpbmc7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmdTdGFydFRpbWUgPSBub3coKTsKICAgICAgICAgICAgICAgIG5leHQuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VDb250ZXh0ID0gc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRBbHJlYWR5KSB7CiAgICAgICAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICAgICAgcmV0dXJuIG5leHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgX25leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIHZhciBuZXh0SXNIaWRkZW4gPSBfbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIF9wcmV2U3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgdmFyIHByZXZJc0hpZGRlbiA9IF9wcmV2U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBpZiAocHJldklzSGlkZGVuICE9PSBuZXh0SXNIaWRkZW4gJiYgLy8gTGVnYWN5SGlkZGVuIGRvZXNuJ3QgZG8gYW55IGhpZGluZyDigJQgaXQgb25seSBwcmUtcmVuZGVycy4KICAgICAgICAgICAgICAgICFlbmFibGVMZWdhY3lIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghbmV4dElzSGlkZGVuIHx8ICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHN1YnRyZWVSZW5kZXJMYW5lcywgT2Zmc2NyZWVuTGFuZSkpIHsKICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgJiAoUGxhY2VtZW50IHwgVXBkYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2FjaGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHVuaXQgb2Ygd29yayB0YWcgKCIgKyB3b3JrSW5Qcm9ncmVzczIudGFnICsgIikuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVud2luZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGZsYWdzID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFNob3VsZENhcHR1cmUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IGZsYWdzICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24od29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwb3BUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICB2YXIgX2ZsYWdzID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgIGlmICgoX2ZsYWdzICYgU2hvdWxkQ2FwdHVyZSkgIT09IE5vRmxhZ3MgJiYgKF9mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBfZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsICYmIHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaHJldyBpbiBuZXdseSBtb3VudGVkIGRlaHlkcmF0ZWQgY29tcG9uZW50LiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBfZmxhZ3MyID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgIGlmIChfZmxhZ3MyICYgU2hvdWxkQ2FwdHVyZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gX2ZsYWdzMiAmIH5TaG91bGRDYXB0dXJlIHwgRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB0cmFuc2ZlckFjdHVhbER1cmF0aW9uKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ2FjaGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVud2luZEludGVycnVwdGVkV29yayhjdXJyZW50NCwgaW50ZXJydXB0ZWRXb3JrLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHBvcFRyZWVDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICBzd2l0Y2ggKGludGVycnVwdGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBjaGlsZENvbnRleHRUeXBlcyA9IGludGVycnVwdGVkV29yay50eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICAgIGlmIChjaGlsZENvbnRleHRUeXBlcyAhPT0gbnVsbCAmJiBjaGlsZENvbnRleHRUeXBlcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBpbnRlcnJ1cHRlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBwb3BUb3BMZXZlbENvbnRleHRPYmplY3QoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IGludGVycnVwdGVkV29yay50eXBlLl9jb250ZXh0OwogICAgICAgICAgICAgIHBvcFByb3ZpZGVyKGNvbnRleHQsIGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDoKICAgICAgICAgICAgICBwb3BSZW5kZXJMYW5lcyhpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5kZWZpbmVkU25hcHNob3RCZWZvcmVVcGRhdGUgPSBudWxsOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFVuZGVmaW5lZFNuYXBzaG90QmVmb3JlVXBkYXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgdmFyIG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIFBvc3NpYmx5V2Vha1NldCA9IHR5cGVvZiBXZWFrU2V0ID09PSAiZnVuY3Rpb24iID8gV2Vha1NldCA6IFNldDsKICAgICAgICB2YXIgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgdmFyIGluUHJvZ3Jlc3NMYW5lcyA9IG51bGw7CiAgICAgICAgdmFyIGluUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiByZXBvcnRVbmNhdWdodEVycm9ySW5ERVYoZXJyb3IyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjayhudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjbGVhckNhdWdodEVycm9yKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjYWxsQ29tcG9uZW50V2lsbFVubW91bnRXaXRoVGltZXIgPSBmdW5jdGlvbihjdXJyZW50NCwgaW5zdGFuY2UpIHsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChjdXJyZW50NC5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQoKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihjdXJyZW50NCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50KCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsQ29tbWl0SG9va0xheW91dEVmZmVjdExpc3RNb3VudChjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQsIGN1cnJlbnQ0KTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBpbnN0YW5jZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY2FsbENvbXBvbmVudFdpbGxVbm1vdW50V2l0aFRpbWVyKGN1cnJlbnQ0LCBpbnN0YW5jZSk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxDb21wb25lbnREaWRNb3VudChjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgaW5zdGFuY2UpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUF0dGFjaFJlZihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29tbWl0QXR0YWNoUmVmKGN1cnJlbnQ0KTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB2YXIgcmVmID0gY3VycmVudDQucmVmOwogICAgICAgICAgaWYgKHJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciByZXRWYWw7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxlclRpbWVyICYmIGVuYWJsZVByb2ZpbGVyQ29tbWl0SG9va3MgJiYgY3VycmVudDQubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihudWxsKTsKICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihjdXJyZW50NCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJldFZhbCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCByZXR1cm4gdmFsdWUgZnJvbSBhIGNhbGxiYWNrIHJlZiBpbiAlcy4gQSBjYWxsYmFjayByZWYgc2hvdWxkIG5vdCByZXR1cm4gYSBmdW5jdGlvbi4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGN1cnJlbnQ0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlZi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsRGVzdHJveShjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZGVzdHJveSgpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZm9jdXNlZEluc3RhbmNlSGFuZGxlID0gbnVsbDsKICAgICAgICB2YXIgc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaXJzdENoaWxkKSB7CiAgICAgICAgICBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBwcmVwYXJlRm9yQ29tbWl0KHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfYmVnaW4oKTsKICAgICAgICAgIHZhciBzaG91bGRGaXJlID0gc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyOwogICAgICAgICAgc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyID0gZmFsc2U7CiAgICAgICAgICBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHNob3VsZEZpcmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c19iZWdpbigpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIEJlZm9yZU11dGF0aW9uTWFzaykgIT09IE5vRmxhZ3MgJiYgY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2NvbXBsZXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2NvbXBsZXRlKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSBmaW5pc2hlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgdmFyIGZsYWdzID0gZmluaXNoZWRXb3JrLmZsYWdzOwogICAgICAgICAgaWYgKChmbGFncyAmIFNuYXBzaG90KSAhPT0gTm9GbGFncykgewogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgcHJldlByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLnR5cGUgPT09IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSAmJiAhZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIGdldFNuYXBzaG90QmVmb3JlVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIGdldFNuYXBzaG90QmVmb3JlVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgc25hcHNob3QgPSBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZShmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgPT09IGZpbmlzaGVkV29yay50eXBlID8gcHJldlByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wczIoZmluaXNoZWRXb3JrLnR5cGUsIHByZXZQcm9wcyksIHByZXZTdGF0ZSk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGlkV2FyblNldCA9IGRpZFdhcm5BYm91dFVuZGVmaW5lZFNuYXBzaG90QmVmb3JlVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIGlmIChzbmFwc2hvdCA9PT0gdm9pZCAwICYmICFkaWRXYXJuU2V0LmhhcyhmaW5pc2hlZFdvcmsudHlwZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGRpZFdhcm5TZXQuYWRkKGZpbmlzaGVkV29yay50eXBlKTsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpOiBBIHNuYXBzaG90IHZhbHVlIChvciBudWxsKSBtdXN0IGJlIHJldHVybmVkLiBZb3UgaGF2ZSByZXR1cm5lZCB1bmRlZmluZWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuX19yZWFjdEludGVybmFsU25hcHNob3RCZWZvcmVVcGRhdGUgPSBzbmFwc2hvdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGNsZWFyQ29udGFpbmVyKHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyB1bml0IG9mIHdvcmsgdGFnIHNob3VsZCBub3QgaGF2ZSBzaWRlLWVmZmVjdHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChmbGFncywgZmluaXNoZWRXb3JrLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IHVwZGF0ZVF1ZXVlICE9PSBudWxsID8gdXBkYXRlUXVldWUubGFzdEVmZmVjdCA6IG51bGw7CiAgICAgICAgICBpZiAobGFzdEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmlyc3RFZmZlY3QgPSBsYXN0RWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIHZhciBlZmZlY3QgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGlmICgoZWZmZWN0LnRhZyAmIGZsYWdzKSA9PT0gZmxhZ3MpIHsKICAgICAgICAgICAgICAgIHZhciBkZXN0cm95ID0gZWZmZWN0LmRlc3Ryb3k7CiAgICAgICAgICAgICAgICBlZmZlY3QuZGVzdHJveSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIGlmIChkZXN0cm95ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBQYXNzaXZlJDEpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmbGFncyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGZpbmlzaGVkV29yaywgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIFBhc3NpdmUkMSkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGZsYWdzICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKGVmZmVjdCAhPT0gZmlyc3RFZmZlY3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KGZsYWdzLCBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUgIT09IG51bGwgPyB1cGRhdGVRdWV1ZS5sYXN0RWZmZWN0IDogbnVsbDsKICAgICAgICAgIGlmIChsYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYgKChlZmZlY3QudGFnICYgZmxhZ3MpID09PSBmbGFncykgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjcmVhdGUgPSBlZmZlY3QuY3JlYXRlOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KHRydWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlZmZlY3QuZGVzdHJveSA9IGNyZWF0ZSgpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KGZhbHNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIGRlc3Ryb3kgPSBlZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgIT09IHZvaWQgMCAmJiB0eXBlb2YgZGVzdHJveSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBob29rTmFtZSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgICBpZiAoKGVmZmVjdC50YWcgJiBMYXlvdXQpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGVmZmVjdC50YWcgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgYWRkZW5kdW0gPSB2b2lkIDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBZb3UgcmV0dXJuZWQgbnVsbC4gSWYgeW91ciBlZmZlY3QgZG9lcyBub3QgcmVxdWlyZSBjbGVhbiB1cCwgcmV0dXJuIHVuZGVmaW5lZCAob3Igbm90aGluZykuIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZXN0cm95LnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIlxuXG5JdCBsb29rcyBsaWtlIHlvdSB3cm90ZSAiICsgaG9va05hbWUgKyAiKGFzeW5jICgpID0+IC4uLikgb3IgcmV0dXJuZWQgYSBQcm9taXNlLiBJbnN0ZWFkLCB3cml0ZSB0aGUgYXN5bmMgZnVuY3Rpb24gaW5zaWRlIHlvdXIgZWZmZWN0IGFuZCBjYWxsIGl0IGltbWVkaWF0ZWx5OlxuXG4iICsgaG9va05hbWUgKyAiKCgpID0+IHtcbiAgYXN5bmMgZnVuY3Rpb24gZmV0Y2hEYXRhKCkge1xuICAgIC8vIFlvdSBjYW4gYXdhaXQgaGVyZVxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgTXlBUEkuZ2V0RGF0YShzb21lSWQpO1xuICAgIC8vIC4uLlxuICB9XG4gIGZldGNoRGF0YSgpO1xufSwgW3NvbWVJZF0pOyAvLyBPciBbXSBpZiBlZmZlY3QgZG9lc24ndCBuZWVkIHByb3BzIG9yIHN0YXRlXG5cbkxlYXJuIG1vcmUgYWJvdXQgZGF0YSBmZXRjaGluZyB3aXRoIEhvb2tzOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaG9va3MtZGF0YS1mZXRjaGluZyI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBZb3UgcmV0dXJuZWQ6ICIgKyBkZXN0cm95OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXMgbXVzdCBub3QgcmV0dXJuIGFueXRoaW5nIGJlc2lkZXMgYSBmdW5jdGlvbiwgd2hpY2ggaXMgdXNlZCBmb3IgY2xlYW4tdXAuJXMiLCBob29rTmFtZSwgYWRkZW5kdW0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVmZmVjdCA9IGVmZmVjdC5uZXh0OwogICAgICAgICAgICB9IHdoaWxlIChlZmZlY3QgIT09IGZpcnN0RWZmZWN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZUVmZmVjdER1cmF0aW9ucyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICB2YXIgX2ZpbmlzaGVkV29yayRtZW1vaXplID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMsIGlkID0gX2ZpbmlzaGVkV29yayRtZW1vaXplLmlkLCBvblBvc3RDb21taXQgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUub25Qb3N0Q29tbWl0OwogICAgICAgICAgICAgICAgICB2YXIgY29tbWl0VGltZTIgPSBnZXRDb21taXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHZhciBwaGFzZSA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGUgPT09IG51bGwgPyAibW91bnQiIDogInVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNDdXJyZW50VXBkYXRlTmVzdGVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHBoYXNlID0gIm5lc3RlZC11cGRhdGUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uUG9zdENvbW1pdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIG9uUG9zdENvbW1pdChpZCwgcGhhc2UsIHBhc3NpdmVFZmZlY3REdXJhdGlvbiwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpbmlzaGVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICAgIG91dGVyOiB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICByb290My5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gcGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gcGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dEVmZmVjdE9uRmliZXIoZmluaXNoZWRSb290LCBjdXJyZW50NCwgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgaWYgKChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBMYXlvdXRNYXNrKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBjb21wb25lbnREaWRNb3VudC4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBjb21wb25lbnREaWRNb3VudC4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSA9PT0gZmluaXNoZWRXb3JrLnR5cGUgPyBjdXJyZW50NC5tZW1vaXplZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wczIoZmluaXNoZWRXb3JrLnR5cGUsIGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBjb21wb25lbnREaWRVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMucHJvcHNgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBzdGF0ZSB0byBtYXRjaCBtZW1vaXplZCBzdGF0ZSBiZWZvcmUgY29tcG9uZW50RGlkVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlKHByZXZQcm9wcywgcHJldlN0YXRlLCBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxTbmFwc2hvdEJlZm9yZVVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlKHByZXZQcm9wcywgcHJldlN0YXRlLCBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxTbmFwc2hvdEJlZm9yZVVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBwcm9wcyB0byBtYXRjaCBtZW1vaXplZCBwcm9wcyBiZWZvcmUgcHJvY2Vzc2luZyB0aGUgdXBkYXRlIHF1ZXVlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIHByb2Nlc3NpbmcgdGhlIHVwZGF0ZSBxdWV1ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29tbWl0VXBkYXRlUXVldWUoZmluaXNoZWRXb3JrLCB1cGRhdGVRdWV1ZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHZhciBfdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICBpZiAoX3VwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsuY2hpbGQudGFnKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIF9pbnN0YW5jZSA9IGdldFB1YmxpY0luc3RhbmNlKGZpbmlzaGVkV29yay5jaGlsZC5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIF9pbnN0YW5jZSA9IGZpbmlzaGVkV29yay5jaGlsZC5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb21taXRVcGRhdGVRdWV1ZShmaW5pc2hlZFdvcmssIF91cGRhdGVRdWV1ZSwgX2luc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UyID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCAmJiBmaW5pc2hlZFdvcmsuZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaW5pc2hlZFdvcmsudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIHByb3BzID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIGNvbW1pdE1vdW50KF9pbnN0YW5jZTIsIHR5cGUsIHByb3BzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOiB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjogewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YXIgX2ZpbmlzaGVkV29yayRtZW1vaXplMiA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLCBvbkNvbW1pdCA9IF9maW5pc2hlZFdvcmskbWVtb2l6ZTIub25Db21taXQsIG9uUmVuZGVyID0gX2ZpbmlzaGVkV29yayRtZW1vaXplMi5vblJlbmRlcjsKICAgICAgICAgICAgICAgICAgdmFyIGVmZmVjdER1cmF0aW9uID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgdmFyIGNvbW1pdFRpbWUyID0gZ2V0Q29tbWl0VGltZSgpOwogICAgICAgICAgICAgICAgICB2YXIgcGhhc2UgPSBjdXJyZW50NCA9PT0gbnVsbCA/ICJtb3VudCIgOiAidXBkYXRlIjsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0N1cnJlbnRVcGRhdGVOZXN0ZWQoKSkgewogICAgICAgICAgICAgICAgICAgICAgcGhhc2UgPSAibmVzdGVkLXVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25SZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICBvblJlbmRlcihmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcy5pZCwgcGhhc2UsIGZpbmlzaGVkV29yay5hY3R1YWxEdXJhdGlvbiwgZmluaXNoZWRXb3JrLnRyZWVCYXNlRHVyYXRpb24sIGZpbmlzaGVkV29yay5hY3R1YWxTdGFydFRpbWUsIGNvbW1pdFRpbWUyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvbkNvbW1pdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgb25Db21taXQoZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMuaWQsIHBoYXNlLCBlZmZlY3REdXJhdGlvbiwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbnF1ZXVlUGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdChmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpbmlzaGVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICAgICAgb3V0ZXI6IHdoaWxlIChwYXJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcm9vdDMuZWZmZWN0RHVyYXRpb24gKz0gZWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFN0YXRlTm9kZSA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRTdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gKz0gZWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBjb21taXRTdXNwZW5zZUh5ZHJhdGlvbkNhbGxiYWNrcyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHVuaXQgb2Ygd29yayB0YWcgc2hvdWxkIG5vdCBoYXZlIHNpZGUtZWZmZWN0cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLmZsYWdzICYgUmVmMikgewogICAgICAgICAgICAgICAgY29tbWl0QXR0YWNoUmVmKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYXBwZWFyTGF5b3V0RWZmZWN0c09uRmliZXIobm9kZSkgewogICAgICAgICAgc3dpdGNoIChub2RlLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAobm9kZS5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbW1pdEhvb2tMYXlvdXRFZmZlY3RMaXN0TW91bnQobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24obm9kZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21taXRIb29rTGF5b3V0RWZmZWN0TGlzdE1vdW50KG5vZGUsIG5vZGUucmV0dXJuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnREaWRNb3VudChub2RlLCBub2RlLnJldHVybiwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzYWZlbHlBdHRhY2hSZWYobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHNhZmVseUF0dGFjaFJlZihub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlkZU9yVW5oaWRlQWxsQ2hpbGRyZW4oZmluaXNoZWRXb3JrLCBpc0hpZGRlbikgewogICAgICAgICAgdmFyIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBub2RlID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RTdWJ0cmVlUm9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBub2RlOwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgICAgaGlkZUluc3RhbmNlKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdW5oaWRlSW5zdGFuY2Uobm9kZS5zdGF0ZU5vZGUsIG5vZGUubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RTdWJ0cmVlUm9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UzID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBoaWRlVGV4dEluc3RhbmNlKF9pbnN0YW5jZTMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB1bmhpZGVUZXh0SW5zdGFuY2UoX2luc3RhbmNlMywgbm9kZS5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoKG5vZGUudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQgfHwgbm9kZS50YWcgPT09IExlZ2FjeUhpZGRlbkNvbXBvbmVudCkgJiYgbm9kZS5tZW1vaXplZFN0YXRlICE9PSBudWxsICYmIG5vZGUgIT09IGZpbmlzaGVkV29yaykgOwogICAgICAgICAgICAgIGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLmNoaWxkOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGhvc3RTdWJ0cmVlUm9vdCA9PT0gbm9kZSkgewogICAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBub2RlKSB7CiAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRBdHRhY2hSZWYoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgcmVmID0gZmluaXNoZWRXb3JrLnJlZjsKICAgICAgICAgIGlmIChyZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIGluc3RhbmNlVG9Vc2U7CiAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgIGluc3RhbmNlVG9Vc2UgPSBnZXRQdWJsaWNJbnN0YW5jZShpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgaW5zdGFuY2VUb1VzZSA9IGluc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHJldFZhbDsKICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICByZXRWYWwgPSByZWYoaW5zdGFuY2VUb1VzZSk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXRWYWwgPSByZWYoaW5zdGFuY2VUb1VzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV0VmFsID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIHJldHVybiB2YWx1ZSBmcm9tIGEgY2FsbGJhY2sgcmVmIGluICVzLiBBIGNhbGxiYWNrIHJlZiBzaG91bGQgbm90IHJldHVybiBhIGZ1bmN0aW9uLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghcmVmLmhhc093blByb3BlcnR5KCJjdXJyZW50IikpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgcmVmIG9iamVjdCBwcm92aWRlZCBmb3IgJXMuIFVzZSBlaXRoZXIgYSByZWYtc2V0dGVyIGZ1bmN0aW9uIG9yIFJlYWN0LmNyZWF0ZVJlZigpLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlZi5jdXJyZW50ID0gaW5zdGFuY2VUb1VzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXRhY2hGaWJlck11dGF0aW9uKGZpYmVyKSB7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBhbHRlcm5hdGUucmV0dXJuID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZpYmVyLnJldHVybiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaEZpYmVyQWZ0ZXJFZmZlY3RzKGZpYmVyKSB7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBkZXRhY2hGaWJlckFmdGVyRWZmZWN0cyhhbHRlcm5hdGUpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBmaWJlci5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgIGZpYmVyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIGZpYmVyLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIGhvc3RJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkZXRhY2hEZWxldGVkSW5zdGFuY2UoaG9zdEluc3RhbmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXIucmV0dXJuID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci5kZXBlbmRlbmNpZXMgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFBhcmVudEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaXNIb3N0UGFyZW50KHBhcmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgYSBob3N0IHBhcmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNIb3N0UGFyZW50KGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZmliZXIudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QgfHwgZmliZXIudGFnID09PSBIb3N0UG9ydGFsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0U2libGluZyhmaWJlcikgewogICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgIHNpYmxpbmdzOiB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IGlzSG9zdFBhcmVudChub2RlLnJldHVybikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB3aGlsZSAobm9kZS50YWcgIT09IEhvc3RDb21wb25lbnQgJiYgbm9kZS50YWcgIT09IEhvc3RUZXh0ICYmIG5vZGUudGFnICE9PSBEZWh5ZHJhdGVkRnJhZ21lbnQpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5mbGFncyAmIFBsYWNlbWVudCkgewogICAgICAgICAgICAgICAgY29udGludWUgc2libGluZ3M7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlLmNoaWxkID09PSBudWxsIHx8IG5vZGUudGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZSBzaWJsaW5nczsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghKG5vZGUuZmxhZ3MgJiBQbGFjZW1lbnQpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBsYWNlbWVudChmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGdldEhvc3RQYXJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAocGFyZW50RmliZXIuZmxhZ3MgJiBDb250ZW50UmVzZXQpIHsKICAgICAgICAgICAgICAgIHJlc2V0VGV4dENvbnRlbnQocGFyZW50KTsKICAgICAgICAgICAgICAgIHBhcmVudEZpYmVyLmZsYWdzICY9IH5Db250ZW50UmVzZXQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBiZWZvcmUgPSBnZXRIb3N0U2libGluZyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShmaW5pc2hlZFdvcmssIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICB2YXIgX3BhcmVudCA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgIHZhciBfYmVmb3JlID0gZ2V0SG9zdFNpYmxpbmcoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKGZpbmlzaGVkV29yaywgX2JlZm9yZSwgX3BhcmVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgaG9zdCBwYXJlbnQgZmliZXIuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZUludG9Db250YWluZXIobm9kZSwgYmVmb3JlLCBwYXJlbnQpIHsKICAgICAgICAgIHZhciB0YWcgPSBub2RlLnRhZzsKICAgICAgICAgIHZhciBpc0hvc3QgPSB0YWcgPT09IEhvc3RDb21wb25lbnQgfHwgdGFnID09PSBIb3N0VGV4dDsKICAgICAgICAgIGlmIChpc0hvc3QpIHsKICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoYmVmb3JlKSB7CiAgICAgICAgICAgICAgaW5zZXJ0SW5Db250YWluZXJCZWZvcmUocGFyZW50LCBzdGF0ZU5vZGUsIGJlZm9yZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXBwZW5kQ2hpbGRUb0NvbnRhaW5lcihwYXJlbnQsIHN0YXRlTm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBIb3N0UG9ydGFsKSA7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihjaGlsZCwgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB3aGlsZSAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihzaWJsaW5nLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgICBzaWJsaW5nID0gc2libGluZy5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGUobm9kZSwgYmVmb3JlLCBwYXJlbnQpIHsKICAgICAgICAgIHZhciB0YWcgPSBub2RlLnRhZzsKICAgICAgICAgIHZhciBpc0hvc3QgPSB0YWcgPT09IEhvc3RDb21wb25lbnQgfHwgdGFnID09PSBIb3N0VGV4dDsKICAgICAgICAgIGlmIChpc0hvc3QpIHsKICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoYmVmb3JlKSB7CiAgICAgICAgICAgICAgaW5zZXJ0QmVmb3JlKHBhcmVudCwgc3RhdGVOb2RlLCBiZWZvcmUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGFwcGVuZENoaWxkKHBhcmVudCwgc3RhdGVOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGUoY2hpbGQsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICB2YXIgc2libGluZyA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgd2hpbGUgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShzaWJsaW5nLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgICBzaWJsaW5nID0gc2libGluZy5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaG9zdFBhcmVudCA9IG51bGw7CiAgICAgICAgdmFyIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGNvbW1pdERlbGV0aW9uRWZmZWN0cyhyb290MywgcmV0dXJuRmliZXIsIGRlbGV0ZWRGaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIGZpbmRQYXJlbnQ6IHdoaWxlIChwYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudC50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcGFyZW50LnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGZpbmRQYXJlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBwYXJlbnQuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGZpbmRQYXJlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHBhcmVudC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaG9zdFBhcmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gZmluZCBhIGhvc3QgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIocm9vdDMsIHJldHVybkZpYmVyLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBkZXRhY2hGaWJlck11dGF0aW9uKGRlbGV0ZWRGaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBwYXJlbnQpIHsKICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudC5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICBjb21taXREZWxldGlvbkVmZmVjdHNPbkZpYmVyKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgY2hpbGQpOwogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpIHsKICAgICAgICAgIG9uQ29tbWl0VW5tb3VudChkZWxldGVkRmliZXIpOwogICAgICAgICAgc3dpdGNoIChkZWxldGVkRmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkhvc3RQYXJlbnQgPSBob3N0UGFyZW50OwogICAgICAgICAgICAgICAgdmFyIHByZXZIb3N0UGFyZW50SXNDb250YWluZXIgPSBob3N0UGFyZW50SXNDb250YWluZXI7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHByZXZIb3N0UGFyZW50OwogICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGlmIChob3N0UGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGlmIChob3N0UGFyZW50SXNDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVDaGlsZEZyb21Db250YWluZXIoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2hpbGQoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRGVoeWRyYXRlZEZyYWdtZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnRJc0NvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIGNsZWFyU3VzcGVuc2VCb3VuZGFyeUZyb21Db250YWluZXIoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJTdXNwZW5zZUJvdW5kYXJ5KGhvc3RQYXJlbnQsIGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgX3ByZXZIb3N0UGFyZW50ID0gaG9zdFBhcmVudDsKICAgICAgICAgICAgICAgIHZhciBfcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBkZWxldGVkRmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gX3ByZXZIb3N0UGFyZW50OwogICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gX3ByZXZIb3N0UGFyZW50SXNDb250YWluZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZGVsZXRlZEZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUubGFzdEVmZmVjdDsKICAgICAgICAgICAgICAgICAgaWYgKGxhc3RFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZmlyc3RFZmZlY3QgPSBsYXN0RWZmZWN0Lm5leHQ7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBfZWZmZWN0ID0gZWZmZWN0LCBkZXN0cm95ID0gX2VmZmVjdC5kZXN0cm95LCB0YWcgPSBfZWZmZWN0LnRhZzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChkZXN0cm95ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCh0YWcgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsRGVzdHJveShkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlc3Ryb3kpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCh0YWcgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRlbGV0ZWRGaWJlci5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsRGVzdHJveShkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlc3Ryb3kpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGVmZmVjdCA9IGVmZmVjdC5uZXh0OwogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGVmZmVjdCAhPT0gZmlyc3RFZmZlY3QpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBSZW1vdmUgdGhpcyBkZWFkIGZsYWcKICAgICAgICAgICAgICAgIGRlbGV0ZWRGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gfHwgZGVsZXRlZEZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0U3VzcGVuc2VDYWxsYmFjayhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRTdXNwZW5zZUh5ZHJhdGlvbkNhbGxiYWNrcyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIG5ld1N0YXRlID0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAobmV3U3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmluaXNoZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBwcmV2U3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgICAgIGlmIChzdXNwZW5zZUluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0YWNoU3VzcGVuc2VSZXRyeUxpc3RlbmVycyhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAod2FrZWFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciByZXRyeUNhY2hlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgaWYgKHJldHJ5Q2FjaGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXRyeUNhY2hlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZSA9IG5ldyBQb3NzaWJseVdlYWtTZXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YWtlYWJsZXMuZm9yRWFjaChmdW5jdGlvbih3YWtlYWJsZSkgewogICAgICAgICAgICAgIHZhciByZXRyeSA9IHJlc29sdmVSZXRyeVdha2VhYmxlLmJpbmQobnVsbCwgZmluaXNoZWRXb3JrLCB3YWtlYWJsZSk7CiAgICAgICAgICAgICAgaWYgKCFyZXRyeUNhY2hlLmhhcyh3YWtlYWJsZSkpIHsKICAgICAgICAgICAgICAgIHJldHJ5Q2FjaGUuYWRkKHdha2VhYmxlKTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluUHJvZ3Jlc3NMYW5lcyAhPT0gbnVsbCAmJiBpblByb2dyZXNzUm9vdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhpblByb2dyZXNzUm9vdCwgaW5Qcm9ncmVzc0xhbmVzKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIkV4cGVjdGVkIGZpbmlzaGVkIHJvb3QgYW5kIGxhbmVzIHRvIGJlIHNldC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdha2VhYmxlLnRoZW4ocmV0cnksIHJldHJ5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yaywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIGluUHJvZ3Jlc3NMYW5lcyA9IGNvbW1pdHRlZExhbmVzOwogICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSByb290MzsKICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgY29tbWl0TXV0YXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFdvcmssIHJvb3QzKTsKICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICAgIGluUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgcGFyZW50RmliZXIsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcGFyZW50RmliZXIuZGVsZXRpb25zOwogICAgICAgICAgaWYgKGRlbGV0aW9ucyAhPT0gbnVsbCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlbGV0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBjaGlsZFRvRGVsZXRlID0gZGVsZXRpb25zW2ldOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXREZWxldGlvbkVmZmVjdHMocm9vdDMsIHBhcmVudEZpYmVyLCBjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGNoaWxkVG9EZWxldGUsIHBhcmVudEZpYmVyLCBlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZEZWJ1Z0ZpYmVyID0gZ2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICBpZiAocGFyZW50RmliZXIuc3VidHJlZUZsYWdzICYgTXV0YXRpb25NYXNrKSB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudEZpYmVyLmNoaWxkOwogICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoY2hpbGQpOwogICAgICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0c09uRmliZXIoY2hpbGQsIHJvb3QzKTsKICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihwcmV2RGVidWdGaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdE11dGF0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRXb3JrLCByb290MywgbGFuZXMpIHsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICB2YXIgZmxhZ3MgPSBmaW5pc2hlZFdvcmsuZmxhZ3M7CiAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KEluc2VydGlvbiB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChJbnNlcnRpb24gfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgUmVmMikgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihjdXJyZW50NCwgY3VycmVudDQucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgUmVmMikgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihjdXJyZW50NCwgY3VycmVudDQucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5mbGFncyAmIENvbnRlbnRSZXNldCkgewogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJlc2V0VGV4dENvbnRlbnQoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICB2YXIgX2luc3RhbmNlNCA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGlmIChfaW5zdGFuY2U0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmV3UHJvcHMgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgb2xkUHJvcHMgPSBjdXJyZW50NCAhPT0gbnVsbCA/IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgOiBuZXdQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGZpbmlzaGVkV29yay50eXBlOwogICAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICAgIGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdFVwZGF0ZShfaW5zdGFuY2U0LCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuc3RhdGVOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHNob3VsZCBoYXZlIGEgdGV4dCBub2RlIGluaXRpYWxpemVkLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciB0ZXh0SW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB2YXIgbmV3VGV4dCA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICB2YXIgb2xkVGV4dCA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQubWVtb2l6ZWRQcm9wcyA6IG5ld1RleHQ7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0VGV4dFVwZGF0ZSh0ZXh0SW5zdGFuY2UsIG9sZFRleHQsIG5ld1RleHQpOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlJvb3RTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZSb290U3RhdGUuaXNEZWh5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBjb21taXRIeWRyYXRlZENvbnRhaW5lcihyb290My5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB2YXIgb2Zmc2NyZWVuRmliZXIgPSBmaW5pc2hlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgaWYgKG9mZnNjcmVlbkZpYmVyLmZsYWdzICYgVmlzaWJpbGl0eSkgewogICAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkluc3RhbmNlID0gb2Zmc2NyZWVuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gb2Zmc2NyZWVuRmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IG5ld1N0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuSW5zdGFuY2UuaXNIaWRkZW4gPSBpc0hpZGRlbjsKICAgICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgICB2YXIgd2FzSGlkZGVuID0gb2Zmc2NyZWVuRmliZXIuYWx0ZXJuYXRlICE9PSBudWxsICYmIG9mZnNjcmVlbkZpYmVyLmFsdGVybmF0ZS5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoIXdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgIG1hcmtDb21taXRUaW1lT2ZGYWxsYmFjaygpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0U3VzcGVuc2VDYWxsYmFjayhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGF0dGFjaFN1c3BlbnNlUmV0cnlMaXN0ZW5lcnMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF93YXNIaWRkZW4gPSBjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSB0aGlzIGRlYWQgZmxhZwogICAgICAgICAgICAgICAgZmluaXNoZWRXb3JrLm1vZGUgJiBDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiB8fCBfd2FzSGlkZGVuOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVmlzaWJpbGl0eSkgewogICAgICAgICAgICAgICAgdmFyIF9vZmZzY3JlZW5JbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB2YXIgX25ld1N0YXRlID0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgX2lzSGlkZGVuID0gX25ld1N0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkJvdW5kYXJ5ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICAgICAgX29mZnNjcmVlbkluc3RhbmNlLmlzSGlkZGVuID0gX2lzSGlkZGVuOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoX2lzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFfd2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoKG9mZnNjcmVlbkJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gb2Zmc2NyZWVuQm91bmRhcnk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvZmZzY3JlZW5DaGlsZCA9IG9mZnNjcmVlbkJvdW5kYXJ5LmNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAob2Zmc2NyZWVuQ2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gb2Zmc2NyZWVuQ2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19iZWdpbihvZmZzY3JlZW5DaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2NyZWVuQ2hpbGQgPSBvZmZzY3JlZW5DaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGhpZGVPclVuaGlkZUFsbENoaWxkcmVuKG9mZnNjcmVlbkJvdW5kYXJ5LCBfaXNIaWRkZW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgYXR0YWNoU3VzcGVuc2VSZXRyeUxpc3RlbmVycyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIGZsYWdzID0gZmluaXNoZWRXb3JrLmZsYWdzOwogICAgICAgICAgaWYgKGZsYWdzICYgUGxhY2VtZW50KSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgY29tbWl0UGxhY2VtZW50KGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5pc2hlZFdvcmsuZmxhZ3MgJj0gflBsYWNlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmbGFncyAmIEh5ZHJhdGluZykgewogICAgICAgICAgICBmaW5pc2hlZFdvcmsuZmxhZ3MgJj0gfkh5ZHJhdGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0RWZmZWN0cyhmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gY29tbWl0dGVkTGFuZXM7CiAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IHJvb3QzOwogICAgICAgICAgbmV4dEVmZmVjdCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdHNfYmVnaW4oZmluaXNoZWRXb3JrLCByb290MywgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICAgIGluUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0RWZmZWN0c19iZWdpbihzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gKHN1YnRyZWVSb290Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IE9mZnNjcmVlbkNvbXBvbmVudCAmJiBpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBmaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXdPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBpc0hpZGRlbiB8fCBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgaWYgKG5ld09mZnNjcmVlblN1YnRyZWVJc0hpZGRlbikgewogICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0TW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIHZhciB3YXNIaWRkZW4gPSBjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgdmFyIG5ld09mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSB3YXNIaWRkZW4gfHwgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IG5ld09mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBuZXdPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgaWYgKG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gJiYgIXByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlcjsKICAgICAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKGZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGNoaWxkOwogICAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRFZmZlY3RzX2JlZ2luKAogICAgICAgICAgICAgICAgICAgIGNoaWxkLAogICAgICAgICAgICAgICAgICAgIC8vIE5ldyByb290OyBidWJibGUgYmFjayB1cCB0byBoZXJlIGFuZCBzdG9wLgogICAgICAgICAgICAgICAgICAgIHJvb3QzLAogICAgICAgICAgICAgICAgICAgIGNvbW1pdHRlZExhbmVzCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlcjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChmaWJlci5zdWJ0cmVlRmxhZ3MgJiBMYXlvdXRNYXNrKSAhPT0gTm9GbGFncyAmJiBmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0TW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIGlmICgoZmliZXIuZmxhZ3MgJiBMYXlvdXRNYXNrKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRFZmZlY3RPbkZpYmVyKHJvb3QzLCBjdXJyZW50NCwgZmliZXIsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc2FwcGVhckxheW91dEVmZmVjdHNfYmVnaW4oc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmliZXIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0LCBmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChmaWJlciwgZmliZXIucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IGZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBmaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmlyc3RDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0Q2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzT25GaWJlcihmaWJlcik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yaywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0c19iZWdpbihmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyAmJiBmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgUGFzc2l2ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRPbkZpYmVyKHJvb3QzLCBmaWJlciwgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudE9uRmliZXIoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucykgewogICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFBhc3NpdmVFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0cyhmaXJzdENoaWxkKSB7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c19iZWdpbigpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfYmVnaW4oKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgaWYgKChuZXh0RWZmZWN0LmZsYWdzICYgQ2hpbGREZWxldGlvbikgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gZmliZXIuZGVsZXRpb25zOwogICAgICAgICAgICAgIGlmIChkZWxldGlvbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVsZXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBmaWJlclRvRGVsZXRlID0gZGVsZXRpb25zW2ldOwogICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXJUb0RlbGV0ZTsKICAgICAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9iZWdpbihmaWJlclRvRGVsZXRlLCBmaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBkZXRhY2hlZENoaWxkID0gcHJldmlvdXNGaWJlci5jaGlsZDsKICAgICAgICAgICAgICAgICAgICBpZiAoZGV0YWNoZWRDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNGaWJlci5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkZXRhY2hlZFNpYmxpbmcgPSBkZXRhY2hlZENoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIGRldGFjaGVkQ2hpbGQuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGRldGFjaGVkQ2hpbGQgPSBkZXRhY2hlZFNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChkZXRhY2hlZENoaWxkICE9PSBudWxsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChmaWJlci5zdWJ0cmVlRmxhZ3MgJiBQYXNzaXZlTWFzaykgIT09IE5vRmxhZ3MgJiYgY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2NvbXBsZXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2NvbXBsZXRlKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgaWYgKChmaWJlci5mbGFncyAmIFBhc3NpdmUpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudE9uRmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudE9uRmliZXIoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoUGFzc2l2ZSQxIHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgICAgcmVjb3JkUGFzc2l2ZUVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c0luc2lkZU9mRGVsZXRlZFRyZWVfYmVnaW4oZGVsZXRlZFN1YnRyZWVSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEluc2lkZURlbGV0ZWRUcmVlT25GaWJlcihmaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9jb21wbGV0ZShkZWxldGVkU3VidHJlZVJvb3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c0luc2lkZU9mRGVsZXRlZFRyZWVfY29tcGxldGUoZGVsZXRlZFN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGRldGFjaEZpYmVyQWZ0ZXJFZmZlY3RzKGZpYmVyKTsKICAgICAgICAgICAgICBpZiAoZmliZXIgPT09IGRlbGV0ZWRTdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHJldHVybkZpYmVyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEluc2lkZURlbGV0ZWRUcmVlT25GaWJlcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgc3dpdGNoIChjdXJyZW50NC50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0Lm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihjdXJyZW50NCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF5b3V0RWZmZWN0TW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaWJlcik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlUGFzc2l2ZUVmZmVjdE1vdW50SW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmliZXIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF5b3V0RWZmZWN0VW5tb3VudEluREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChmaWJlciwgZmliZXIucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlUGFzc2l2ZUVmZmVjdFVubW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpYmVyLCBmaWJlci5yZXR1cm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBDT01QT05FTlRfVFlQRSA9IDA7CiAgICAgICAgdmFyIEhBU19QU0VVRE9fQ0xBU1NfVFlQRSA9IDE7CiAgICAgICAgdmFyIFJPTEVfVFlQRSA9IDI7CiAgICAgICAgdmFyIFRFU1RfTkFNRV9UWVBFID0gMzsKICAgICAgICB2YXIgVEVYVF9UWVBFID0gNDsKICAgICAgICBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wuZm9yKSB7CiAgICAgICAgICB2YXIgc3ltYm9sRm9yID0gU3ltYm9sLmZvcjsKICAgICAgICAgIENPTVBPTkVOVF9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5jb21wb25lbnQiKTsKICAgICAgICAgIEhBU19QU0VVRE9fQ0xBU1NfVFlQRSA9IHN5bWJvbEZvcigic2VsZWN0b3IuaGFzX3BzZXVkb19jbGFzcyIpOwogICAgICAgICAgUk9MRV9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5yb2xlIik7CiAgICAgICAgICBURVNUX05BTUVfVFlQRSA9IHN5bWJvbEZvcigic2VsZWN0b3IudGVzdF9pZCIpOwogICAgICAgICAgVEVYVF9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci50ZXh0Iik7CiAgICAgICAgfQogICAgICAgIHZhciBjb21taXRIb29rcyA9IFtdOwogICAgICAgIGZ1bmN0aW9uIG9uQ29tbWl0Um9vdCQxKCkgewogICAgICAgICAgewogICAgICAgICAgICBjb21taXRIb29rcy5mb3JFYWNoKGZ1bmN0aW9uKGNvbW1pdEhvb2spIHsKICAgICAgICAgICAgICByZXR1cm4gY29tbWl0SG9vaygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEFjdFF1ZXVlID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QWN0UXVldWU7CiAgICAgICAgZnVuY3Rpb24gaXNMZWdhY3lBY3RFbnZpcm9ubWVudChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsID0gKAogICAgICAgICAgICAgIC8vICRGbG93RXhwZWN0ZWRFcnJvciDigJMgRmxvdyBkb2Vzbid0IGtub3cgYWJvdXQgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIGdsb2JhbAogICAgICAgICAgICAgIHR5cGVvZiBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgIT09ICJ1bmRlZmluZWQiID8gSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIDogdm9pZCAwCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHZhciBqZXN0SXNEZWZpbmVkID0gdHlwZW9mIGplc3QgIT09ICJ1bmRlZmluZWQiOwogICAgICAgICAgICByZXR1cm4gamVzdElzRGVmaW5lZCAmJiBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWwgIT09IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0NvbmN1cnJlbnRBY3RFbnZpcm9ubWVudCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCA9ICgKICAgICAgICAgICAgICAvLyAkRmxvd0V4cGVjdGVkRXJyb3Ig4oCTIEZsb3cgZG9lc24ndCBrbm93IGFib3V0IElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCBnbG9iYWwKICAgICAgICAgICAgICB0eXBlb2YgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UICE9PSAidW5kZWZpbmVkIiA/IElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCA6IHZvaWQgMAogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoIWlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCAmJiBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBjdXJyZW50IHRlc3RpbmcgZW52aXJvbm1lbnQgaXMgbm90IGNvbmZpZ3VyZWQgdG8gc3VwcG9ydCBhY3QoLi4uKSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjZWlsID0gTWF0aC5jZWlsOwogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyLCBSZWFjdEN1cnJlbnRPd25lciQyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXIsIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZywgUmVhY3RDdXJyZW50QWN0UXVldWUkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEFjdFF1ZXVlOwogICAgICAgIHZhciBOb0NvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIEJhdGNoZWRDb250ZXh0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIFJlbmRlckNvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIENvbW1pdENvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNAogICAgICAgICk7CiAgICAgICAgdmFyIFJvb3RJblByb2dyZXNzID0gMDsKICAgICAgICB2YXIgUm9vdEZhdGFsRXJyb3JlZCA9IDE7CiAgICAgICAgdmFyIFJvb3RFcnJvcmVkID0gMjsKICAgICAgICB2YXIgUm9vdFN1c3BlbmRlZCA9IDM7CiAgICAgICAgdmFyIFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkgPSA0OwogICAgICAgIHZhciBSb290Q29tcGxldGVkID0gNTsKICAgICAgICB2YXIgUm9vdERpZE5vdENvbXBsZXRlID0gNjsKICAgICAgICB2YXIgZXhlY3V0aW9uQ29udGV4dCA9IE5vQ29udGV4dDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciA9IGNyZWF0ZUN1cnNvcihOb0xhbmVzKTsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RJblByb2dyZXNzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMgPSBudWxsOwogICAgICAgIHZhciBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lID0gMDsKICAgICAgICB2YXIgRkFMTEJBQ0tfVEhST1RUTEVfTVMgPSA1MDA7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWUgPSBJbmZpbml0eTsKICAgICAgICB2YXIgUkVOREVSX1RJTUVPVVRfTVMgPSA1MDA7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlc2V0UmVuZGVyVGltZXIoKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJUYXJnZXRUaW1lID0gbm93KCkgKyBSRU5ERVJfVElNRU9VVF9NUzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJUYXJnZXRUaW1lOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzVW5jYXVnaHRFcnJvciA9IGZhbHNlOwogICAgICAgIHZhciBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgIHZhciBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IG51bGw7CiAgICAgICAgdmFyIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID0gbnVsbDsKICAgICAgICB2YXIgcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0cyA9IFtdOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICB2YXIgTkVTVEVEX1VQREFURV9MSU1JVCA9IDUwOwogICAgICAgIHZhciBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgdmFyIHJvb3RXaXRoTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgdmFyIGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgIHZhciBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIE5FU1RFRF9QQVNTSVZFX1VQREFURV9MSU1JVCA9IDUwOwogICAgICAgIHZhciBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgIHZhciByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICB2YXIgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgIHZhciBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IE5vTGFuZXM7CiAgICAgICAgdmFyIGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldFdvcmtJblByb2dyZXNzUm9vdCgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RFdmVudFRpbWUoKSB7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub3coKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50RXZlbnRUaW1lICE9PSBOb1RpbWVzdGFtcCkgewogICAgICAgICAgICByZXR1cm4gY3VycmVudEV2ZW50VGltZTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRFdmVudFRpbWUgPSBub3coKTsKICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcikgewogICAgICAgICAgdmFyIG1vZGUgPSBmaWJlci5tb2RlOwogICAgICAgICAgaWYgKChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIFN5bmNMYW5lOwogICAgICAgICAgfSBlbHNlIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQgJiYgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIHBpY2tBcmJpdHJhcnlMYW5lKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc1RyYW5zaXRpb24gPSByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSAhPT0gTm9UcmFuc2l0aW9uOwogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbikgewogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgICAgaWYgKCF0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5hZGQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9PT0gTm9MYW5lKSB7CiAgICAgICAgICAgICAgY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPSBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVMYW5lID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICBpZiAodXBkYXRlTGFuZSAhPT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50TGFuZSA9IGdldEN1cnJlbnRFdmVudFByaW9yaXR5KCk7CiAgICAgICAgICByZXR1cm4gZXZlbnRMYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0UmV0cnlMYW5lKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IGZpYmVyLm1vZGU7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2xhaW1OZXh0UmV0cnlMYW5lKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSkgewogICAgICAgICAgY2hlY2tGb3JOZXN0ZWRVcGRhdGVzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QpIHsKICAgICAgICAgICAgICBlcnJvcigidXNlSW5zZXJ0aW9uRWZmZWN0IG11c3Qgbm90IHNjaGVkdWxlIHVwZGF0ZXMuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiBSZW5kZXJDb250ZXh0KSAhPT0gTm9MYW5lcyAmJiByb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgIHdhcm5BYm91dFJlbmRlclBoYXNlVXBkYXRlc0luREVWKGZpYmVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgIGFkZEZpYmVyVG9MYW5lc01hcChyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuSWZVcGRhdGVzTm90V3JhcHBlZFdpdGhBY3RERVYoZmliZXIpOwogICAgICAgICAgICBpZiAocm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCkgewogICAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkV2l0aERlbGF5KSB7CiAgICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgICAgaWYgKGxhbmUgPT09IFN5bmNMYW5lICYmIGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCAmJiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmIC8vIFRyZWF0IGBhY3RgIGFzIGlmIGl0J3MgaW5zaWRlIGBiYXRjaGVkVXBkYXRlc2AsIGV2ZW4gaW4gbGVnYWN5IG1vZGUuCiAgICAgICAgICAgICFSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmlzQmF0Y2hpbmdMZWdhY3kpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzT25seUluTGVnYWN5TW9kZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlSW5pdGlhbEh5ZHJhdGlvbk9uUm9vdChyb290MywgbGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSByb290My5jdXJyZW50OwogICAgICAgICAgY3VycmVudDQubGFuZXMgPSBsYW5lOwogICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1Vuc2FmZUNsYXNzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpIHsKICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSBvdXRkYXRlZCBkZWZlclJlbmRlclBoYXNlVXBkYXRlVG9OZXh0QmF0Y2ggZXhwZXJpbWVudC4gV2UKICAgICAgICAgICAgLy8gZGVjaWRlZCBub3QgdG8gZW5hYmxlIGl0LgogICAgICAgICAgICAoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgY3VycmVudFRpbWUpIHsKICAgICAgICAgIHZhciBleGlzdGluZ0NhbGxiYWNrTm9kZSA9IHJvb3QzLmNhbGxiYWNrTm9kZTsKICAgICAgICAgIG1hcmtTdGFydmVkTGFuZXNBc0V4cGlyZWQocm9vdDMsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgaWYgKG5leHRMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjYW5jZWxDYWxsYmFjayQxKGV4aXN0aW5nQ2FsbGJhY2tOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByb290My5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2FsbGJhY2tQcmlvcml0eSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobmV4dExhbmVzKTsKICAgICAgICAgIHZhciBleGlzdGluZ0NhbGxiYWNrUHJpb3JpdHkgPSByb290My5jYWxsYmFja1ByaW9yaXR5OwogICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tQcmlvcml0eSA9PT0gbmV3Q2FsbGJhY2tQcmlvcml0eSAmJiAvLyBTcGVjaWFsIGNhc2UgcmVsYXRlZCB0byBgYWN0YC4gSWYgdGhlIGN1cnJlbnRseSBzY2hlZHVsZWQgdGFzayBpcyBhCiAgICAgICAgICAvLyBTY2hlZHVsZXIgdGFzaywgcmF0aGVyIHRoYW4gYW4gYGFjdGAgdGFzaywgY2FuY2VsIGl0IGFuZCByZS1zY2hlZHVsZWQKICAgICAgICAgIC8vIG9uIHRoZSBgYWN0YCBxdWV1ZS4KICAgICAgICAgICEoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsICYmIGV4aXN0aW5nQ2FsbGJhY2tOb2RlICE9PSBmYWtlQWN0Q2FsbGJhY2tOb2RlKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tOb2RlID09IG51bGwgJiYgZXhpc3RpbmdDYWxsYmFja1ByaW9yaXR5ICE9PSBTeW5jTGFuZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHNjaGVkdWxlZCBjYWxsYmFjayB0byBleGlzdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgY2FuY2VsQ2FsbGJhY2skMShleGlzdGluZ0NhbGxiYWNrTm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2FsbGJhY2tOb2RlOwogICAgICAgICAgaWYgKG5ld0NhbGxiYWNrUHJpb3JpdHkgPT09IFN5bmNMYW5lKSB7CiAgICAgICAgICAgIGlmIChyb290My50YWcgPT09IExlZ2FjeVJvb3QpIHsKICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5pc0JhdGNoaW5nTGVnYWN5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NoZWR1bGVMZWdhY3lTeW5jQ2FsbGJhY2socGVyZm9ybVN5bmNXb3JrT25Sb290LmJpbmQobnVsbCwgcm9vdDMpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzY2hlZHVsZVN5bmNDYWxsYmFjayhwZXJmb3JtU3luY1dvcmtPblJvb3QuYmluZChudWxsLCByb290MykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQucHVzaChmbHVzaFN5bmNDYWxsYmFja3MpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZU1pY3JvdGFzayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q2FsbGJhY2tOb2RlID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eUxldmVsOwogICAgICAgICAgICBzd2l0Y2ggKGxhbmVzVG9FdmVudFByaW9yaXR5KG5leHRMYW5lcykpIHsKICAgICAgICAgICAgICBjYXNlIERpc2NyZXRlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgQ29udGludW91c0V2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gVXNlckJsb2NraW5nUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBJZGxlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q2FsbGJhY2tOb2RlID0gc2NoZWR1bGVDYWxsYmFjayQxKHNjaGVkdWxlclByaW9yaXR5TGV2ZWwsIHBlcmZvcm1Db25jdXJyZW50V29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKSk7CiAgICAgICAgICB9CiAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gbmV3Q2FsbGJhY2tQcmlvcml0eTsKICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG5ld0NhbGxiYWNrTm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGVyZm9ybUNvbmN1cnJlbnRXb3JrT25Sb290KHJvb3QzLCBkaWRUaW1lb3V0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJlc2V0TmVzdGVkVXBkYXRlRmxhZygpOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPSBOb0xhbmVzOwogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG9yaWdpbmFsQ2FsbGJhY2tOb2RlID0gcm9vdDMuY2FsbGJhY2tOb2RlOwogICAgICAgICAgdmFyIGRpZEZsdXNoUGFzc2l2ZUVmZmVjdHMgPSBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICBpZiAoZGlkRmx1c2hQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICBpZiAocm9vdDMuY2FsbGJhY2tOb2RlICE9PSBvcmlnaW5hbENhbGxiYWNrTm9kZSkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgaWYgKGxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNob3VsZFRpbWVTbGljZSA9ICFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgbGFuZXMpICYmICFpbmNsdWRlc0V4cGlyZWRMYW5lKHJvb3QzLCBsYW5lcykgJiYgIWRpZFRpbWVvdXQ7CiAgICAgICAgICB2YXIgZXhpdFN0YXR1cyA9IHNob3VsZFRpbWVTbGljZSA/IHJlbmRlclJvb3RDb25jdXJyZW50KHJvb3QzLCBsYW5lcykgOiByZW5kZXJSb290U3luYyhyb290MywgbGFuZXMpOwogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgIT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICAgIHZhciBlcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgICAgaWYgKGVycm9yUmV0cnlMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbGFuZXMgPSBlcnJvclJldHJ5TGFuZXM7CiAgICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgICAgdmFyIGZhdGFsRXJyb3IgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yOwogICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgICAgdGhyb3cgZmF0YWxFcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdERpZE5vdENvbXBsZXRlKSB7CiAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByZW5kZXJXYXNDb25jdXJyZW50ID0gIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmN1cnJlbnQuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJXYXNDb25jdXJyZW50ICYmICFpc1JlbmRlckNvbnNpc3RlbnRXaXRoRXh0ZXJuYWxTdG9yZXMoZmluaXNoZWRXb3JrKSkgewogICAgICAgICAgICAgICAgZXhpdFN0YXR1cyA9IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9lcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgICAgICAgIGlmIChfZXJyb3JSZXRyeUxhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICAgICAgbGFuZXMgPSBfZXJyb3JSZXRyeUxhbmVzOwogICAgICAgICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgX2Vycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfZmF0YWxFcnJvciA9IHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgICAgICAgdGhyb3cgX2ZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgICByb290My5maW5pc2hlZExhbmVzID0gbGFuZXM7CiAgICAgICAgICAgICAgZmluaXNoQ29uY3VycmVudFJlbmRlcihyb290MywgZXhpdFN0YXR1cywgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgIGlmIChyb290My5jYWxsYmFja05vZGUgPT09IG9yaWdpbmFsQ2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBwZXJmb3JtQ29uY3VycmVudFdvcmtPblJvb3QuYmluZChudWxsLCByb290Myk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcykgewogICAgICAgICAgdmFyIGVycm9yc0Zyb21GaXJzdEF0dGVtcHQgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzOwogICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgIHZhciByb290V29ya0luUHJvZ3Jlc3MgPSBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgcm9vdFdvcmtJblByb2dyZXNzLmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3JIeWRyYXRpbmdDb250YWluZXIocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICBpZiAoZXhpdFN0YXR1cyAhPT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgdmFyIGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0ID0gd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gZXJyb3JzRnJvbUZpcnN0QXR0ZW1wdDsKICAgICAgICAgICAgaWYgKGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcXVldWVSZWNvdmVyYWJsZUVycm9ycyhlcnJvcnNGcm9tU2Vjb25kQXR0ZW1wdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleGl0U3RhdHVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZVJlY292ZXJhYmxlRXJyb3JzKGVycm9yczMpIHsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9IGVycm9yczM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycy5wdXNoLmFwcGx5KHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCBlcnJvcnMzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluaXNoQ29uY3VycmVudFJlbmRlcihyb290MywgZXhpdFN0YXR1cywgbGFuZXMpIHsKICAgICAgICAgIHN3aXRjaCAoZXhpdFN0YXR1cykgewogICAgICAgICAgICBjYXNlIFJvb3RJblByb2dyZXNzOgogICAgICAgICAgICBjYXNlIFJvb3RGYXRhbEVycm9yZWQ6IHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RFcnJvcmVkOiB7CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUm9vdFN1c3BlbmRlZDogewogICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNPbmx5UmV0cmllcyhsYW5lcykgJiYgLy8gZG8gbm90IGRlbGF5IGlmIHdlJ3JlIGluc2lkZSBhbiBhY3QoKSBzY29wZQogICAgICAgICAgICAgICFzaG91bGRGb3JjZUZsdXNoRmFsbGJhY2tzSW5ERVYoKSkgewogICAgICAgICAgICAgICAgdmFyIG1zVW50aWxUaW1lb3V0ID0gZ2xvYmFsTW9zdFJlY2VudEZhbGxiYWNrVGltZSArIEZBTExCQUNLX1RIUk9UVExFX01TIC0gbm93KCk7CiAgICAgICAgICAgICAgICBpZiAobXNVbnRpbFRpbWVvdXQgPiAxMCkgewogICAgICAgICAgICAgICAgICB2YXIgbmV4dExhbmVzID0gZ2V0TmV4dExhbmVzKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICAgICAgaWYgKG5leHRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhzdXNwZW5kZWRMYW5lcywgbGFuZXMpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICAgICAgICBtYXJrUm9vdFBpbmdlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJvb3QzLnRpbWVvdXRIYW5kbGUgPSBzY2hlZHVsZVRpbWVvdXQoY29tbWl0Um9vdC5iaW5kKG51bGwsIHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyksIG1zVW50aWxUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RTdXNwZW5kZWRXaXRoRGVsYXk6IHsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzT25seVRyYW5zaXRpb25zKGxhbmVzKSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghc2hvdWxkRm9yY2VGbHVzaEZhbGxiYWNrc0luREVWKCkpIHsKICAgICAgICAgICAgICAgIHZhciBtb3N0UmVjZW50RXZlbnRUaW1lID0gZ2V0TW9zdFJlY2VudEV2ZW50VGltZShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZU1zID0gbW9zdFJlY2VudEV2ZW50VGltZTsKICAgICAgICAgICAgICAgIHZhciB0aW1lRWxhcHNlZE1zID0gbm93KCkgLSBldmVudFRpbWVNczsKICAgICAgICAgICAgICAgIHZhciBfbXNVbnRpbFRpbWVvdXQgPSBqbmQodGltZUVsYXBzZWRNcykgLSB0aW1lRWxhcHNlZE1zOwogICAgICAgICAgICAgICAgaWYgKF9tc1VudGlsVGltZW91dCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgIHJvb3QzLnRpbWVvdXRIYW5kbGUgPSBzY2hlZHVsZVRpbWVvdXQoY29tbWl0Um9vdC5iaW5kKG51bGwsIHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyksIF9tc1VudGlsVGltZW91dCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSb290Q29tcGxldGVkOiB7CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gcm9vdCBleGl0IHN0YXR1cy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1JlbmRlckNvbnNpc3RlbnRXaXRoRXh0ZXJuYWxTdG9yZXMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIGlmIChub2RlLmZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSkgewogICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IG5vZGUudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hlY2tzID0gdXBkYXRlUXVldWUuc3RvcmVzOwogICAgICAgICAgICAgICAgaWYgKGNoZWNrcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoZWNrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGVjayA9IGNoZWNrc1tpXTsKICAgICAgICAgICAgICAgICAgICB2YXIgZ2V0U25hcHNob3QgPSBjaGVjay5nZXRTbmFwc2hvdDsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRWYWx1ZSA9IGNoZWNrLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9iamVjdElzKGdldFNuYXBzaG90KCksIHJlbmRlcmVkVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgaWYgKG5vZGUuc3VidHJlZUZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IGNoaWxkOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIHN1c3BlbmRlZExhbmVzKSB7CiAgICAgICAgICBzdXNwZW5kZWRMYW5lcyA9IHJlbW92ZUxhbmVzKHN1c3BlbmRlZExhbmVzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyk7CiAgICAgICAgICBzdXNwZW5kZWRMYW5lcyA9IHJlbW92ZUxhbmVzKHN1c3BlbmRlZExhbmVzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcyk7CiAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwZXJmb3JtU3luY1dvcmtPblJvb3Qocm9vdDMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3luY05lc3RlZFVwZGF0ZUZsYWcoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgbm90IGFscmVhZHkgYmUgd29ya2luZy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIHZhciBsYW5lcyA9IGdldE5leHRMYW5lcyhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUobGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXhpdFN0YXR1cyA9IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICBpZiAocm9vdDMudGFnICE9PSBMZWdhY3lSb290ICYmIGV4aXRTdGF0dXMgPT09IFJvb3RFcnJvcmVkKSB7CiAgICAgICAgICAgIHZhciBlcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgIGlmIChlcnJvclJldHJ5TGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBsYW5lcyA9IGVycm9yUmV0cnlMYW5lczsKICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgIHZhciBmYXRhbEVycm9yID0gd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvcjsKICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgICB0aHJvdyBmYXRhbEVycm9yOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3REaWROb3RDb21wbGV0ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaW5pc2hlZFdvcmsgPSByb290My5jdXJyZW50LmFsdGVybmF0ZTsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBsYW5lczsKICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUm9vdChyb290MywgbGFuZXMpIHsKICAgICAgICAgIGlmIChsYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbWVyZ2VMYW5lcyhsYW5lcywgU3luY0xhbmUpKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmF0Y2hlZFVwZGF0ZXMkMShmbiwgYSkgewogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQmF0Y2hlZENvbnRleHQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZm4oYSk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ID09PSBOb0NvbnRleHQgJiYgLy8gVHJlYXQgYGFjdGAgYXMgaWYgaXQncyBpbnNpZGUgYGJhdGNoZWRVcGRhdGVzYCwgZXZlbiBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgICAgIVJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuaXNCYXRjaGluZ0xlZ2FjeSkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3NPbmx5SW5MZWdhY3lNb2RlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzY3JldGVVcGRhdGVzKGZuLCBhLCBiLCBjLCBkKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIHJldHVybiBmbihhLCBiLCBjLCBkKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jKGZuKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwgJiYgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMudGFnID09PSBMZWdhY3lSb290ICYmIChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBCYXRjaGVkQ29udGV4dDsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBbHJlYWR5UmVuZGVyaW5nKCkgewogICAgICAgICAgcmV0dXJuIChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFJlbmRlckxhbmVzKGZpYmVyLCBsYW5lcykgewogICAgICAgICAgcHVzaChzdWJ0cmVlUmVuZGVyTGFuZXNDdXJzb3IsIHN1YnRyZWVSZW5kZXJMYW5lcywgZmliZXIpOwogICAgICAgICAgc3VidHJlZVJlbmRlckxhbmVzID0gbWVyZ2VMYW5lcyhzdWJ0cmVlUmVuZGVyTGFuZXMsIGxhbmVzKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEluY2x1ZGVkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdEluY2x1ZGVkTGFuZXMsIGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wUmVuZGVyTGFuZXMoZmliZXIpIHsKICAgICAgICAgIHN1YnRyZWVSZW5kZXJMYW5lcyA9IHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvci5jdXJyZW50OwogICAgICAgICAgcG9wKHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IG51bGw7CiAgICAgICAgICByb290My5maW5pc2hlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHZhciB0aW1lb3V0SGFuZGxlID0gcm9vdDMudGltZW91dEhhbmRsZTsKICAgICAgICAgIGlmICh0aW1lb3V0SGFuZGxlICE9PSBub1RpbWVvdXQpIHsKICAgICAgICAgICAgcm9vdDMudGltZW91dEhhbmRsZSA9IG5vVGltZW91dDsKICAgICAgICAgICAgY2FuY2VsVGltZW91dCh0aW1lb3V0SGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW50ZXJydXB0ZWRXb3JrID0gd29ya0luUHJvZ3Jlc3MucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAoaW50ZXJydXB0ZWRXb3JrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gaW50ZXJydXB0ZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgICB1bndpbmRJbnRlcnJ1cHRlZFdvcmsoY3VycmVudDQsIGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgaW50ZXJydXB0ZWRXb3JrID0gaW50ZXJydXB0ZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290ID0gcm9vdDM7CiAgICAgICAgICB2YXIgcm9vdFdvcmtJblByb2dyZXNzID0gY3JlYXRlV29ya0luUHJvZ3Jlc3Mocm9vdDMuY3VycmVudCwgbnVsbCk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IHJvb3RXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gc3VidHJlZVJlbmRlckxhbmVzID0gd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IGxhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RJblByb2dyZXNzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvciA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9IG51bGw7CiAgICAgICAgICBmaW5pc2hRdWV1ZWluZ0NvbmN1cnJlbnRVcGRhdGVzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmRpc2NhcmRQZW5kaW5nV2FybmluZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByb290V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUVycm9yMyhyb290MywgdGhyb3duVmFsdWUpIHsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdmFyIGVycm9yZWRXb3JrID0gd29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmVzZXRDb250ZXh0RGVwZW5kZW5jaWVzKCk7CiAgICAgICAgICAgICAgcmVzZXRIb29rc0FmdGVyVGhyb3coKTsKICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgaWYgKGVycm9yZWRXb3JrID09PSBudWxsIHx8IGVycm9yZWRXb3JrLnJldHVybiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RGYXRhbEVycm9yZWQ7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yID0gdGhyb3duVmFsdWU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxlclRpbWVyICYmIGVycm9yZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShlcnJvcmVkV29yaywgdHJ1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChlbmFibGVTY2hlZHVsaW5nUHJvZmlsZXIpIHsKICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICBpZiAodGhyb3duVmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHRocm93blZhbHVlID09PSAib2JqZWN0IiAmJiB0eXBlb2YgdGhyb3duVmFsdWUudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB2YXIgd2FrZWFibGUgPSB0aHJvd25WYWx1ZTsKICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFN1c3BlbmRlZChlcnJvcmVkV29yaywgd2FrZWFibGUsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRFcnJvcmVkKGVycm9yZWRXb3JrLCB0aHJvd25WYWx1ZSwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd0V4Y2VwdGlvbihyb290MywgZXJyb3JlZFdvcmsucmV0dXJuLCBlcnJvcmVkV29yaywgdGhyb3duVmFsdWUsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICBjb21wbGV0ZVVuaXRPZldvcmsoZXJyb3JlZFdvcmspOwogICAgICAgICAgICB9IGNhdGNoICh5ZXRBbm90aGVyVGhyb3duVmFsdWUpIHsKICAgICAgICAgICAgICB0aHJvd25WYWx1ZSA9IHlldEFub3RoZXJUaHJvd25WYWx1ZTsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgPT09IGVycm9yZWRXb3JrICYmIGVycm9yZWRXb3JrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcmVkV29yayA9IGVycm9yZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gZXJyb3JlZFdvcms7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yZWRXb3JrID0gd29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0gd2hpbGUgKHRydWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoRGlzcGF0Y2hlcigpIHsKICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMi5jdXJyZW50OwogICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQyLmN1cnJlbnQgPSBDb250ZXh0T25seURpc3BhdGNoZXI7CiAgICAgICAgICBpZiAocHJldkRpc3BhdGNoZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wRGlzcGF0Y2hlcihwcmV2RGlzcGF0Y2hlcikgewogICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQyLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbW1pdFRpbWVPZkZhbGxiYWNrKCkgewogICAgICAgICAgZ2xvYmFsTW9zdFJlY2VudEZhbGxiYWNrVGltZSA9IG5vdygpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKGxhbmUpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyA9IG1lcmdlTGFuZXMobGFuZSwgd29ya0luUHJvZ3Jlc3NSb290U2tpcHBlZExhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyRGlkU3VzcGVuZCgpIHsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzcykgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdFN1c3BlbmRlZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyRGlkU3VzcGVuZERlbGF5SWZQb3NzaWJsZSgpIHsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzcyB8fCB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkIHx8IHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RFcnJvcmVkKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290U3VzcGVuZGVkV2l0aERlbGF5OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdCAhPT0gbnVsbCAmJiAoaW5jbHVkZXNOb25JZGxlV29yayh3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMpIHx8IGluY2x1ZGVzTm9uSWRsZVdvcmsod29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMpKSkgewogICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHdvcmtJblByb2dyZXNzUm9vdCwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJEaWRFcnJvcihlcnJvcjIpIHsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzICE9PSBSb290U3VzcGVuZGVkV2l0aERlbGF5KSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290RXJyb3JlZDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnMgPSBbZXJyb3IyXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnMucHVzaChlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJIYXNOb3RTdXNwZW5kZWRZZXQoKSB7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEluUHJvZ3Jlc3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gUmVuZGVyQ29udGV4dDsKICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IHB1c2hEaXNwYXRjaGVyKCk7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290ICE9PSByb290MyB8fCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyAhPT0gbGFuZXMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgdmFyIG1lbW9pemVkVXBkYXRlcnMgPSByb290My5tZW1vaXplZFVwZGF0ZXJzOwogICAgICAgICAgICAgICAgaWYgKG1lbW9pemVkVXBkYXRlcnMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgICBtZW1vaXplZFVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtb3ZlUGVuZGluZ0ZpYmVyc1RvTWVtb2l6ZWQocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyA9IGdldFRyYW5zaXRpb25zRm9yTGFuZXMoKTsKICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1JlbmRlclN0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgZG8gewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHdvcmtMb29wU3luYygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGNhdGNoICh0aHJvd25WYWx1ZSkgewogICAgICAgICAgICAgIGhhbmRsZUVycm9yMyhyb290MywgdGhyb3duVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgcG9wRGlzcGF0Y2hlcihwcmV2RGlzcGF0Y2hlcik7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgIT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgY29tbWl0IGFuIGluY29tcGxldGUgcm9vdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1JlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1czsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd29ya0xvb3BTeW5jKCkgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHBlcmZvcm1Vbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyUm9vdENvbmN1cnJlbnQocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBSZW5kZXJDb250ZXh0OwogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gcHVzaERpc3BhdGNoZXIoKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IHJvb3QzIHx8IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzICE9PSBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgICBpZiAobWVtb2l6ZWRVcGRhdGVycy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1vdmVQZW5kaW5nRmliZXJzVG9NZW1vaXplZChyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zID0gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcygpOwogICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB3b3JrTG9vcENvbmN1cnJlbnQoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBjYXRjaCAodGhyb3duVmFsdWUpIHsKICAgICAgICAgICAgICBoYW5kbGVFcnJvcjMocm9vdDMsIHRocm93blZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpOwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyWWllbGRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSb290SW5Qcm9ncmVzczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wQ29uY3VycmVudCgpIHsKICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCAmJiAhc2hvdWxkWWllbGQoKSkgewogICAgICAgICAgICBwZXJmb3JtVW5pdE9mV29yayh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1Vbml0T2ZXb3JrKHVuaXRPZldvcmspIHsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IHVuaXRPZldvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKHVuaXRPZldvcmspOwogICAgICAgICAgdmFyIG5leHQ7CiAgICAgICAgICBpZiAoKHVuaXRPZldvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcih1bml0T2ZXb3JrKTsKICAgICAgICAgICAgbmV4dCA9IGJlZ2luV29yayQxKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKHVuaXRPZldvcmssIHRydWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dCA9IGJlZ2luV29yayQxKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIHVuaXRPZldvcmsubWVtb2l6ZWRQcm9wcyA9IHVuaXRPZldvcmsucGVuZGluZ1Byb3BzOwogICAgICAgICAgaWYgKG5leHQgPT09IG51bGwpIHsKICAgICAgICAgICAgY29tcGxldGVVbml0T2ZXb3JrKHVuaXRPZldvcmspOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBuZXh0OwogICAgICAgICAgfQogICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVVbml0T2ZXb3JrKHVuaXRPZldvcmspIHsKICAgICAgICAgIHZhciBjb21wbGV0ZWRXb3JrID0gdW5pdE9mV29yazsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gY29tcGxldGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGNvbXBsZXRlZFdvcmsucmV0dXJuOwogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsuZmxhZ3MgJiBJbmNvbXBsZXRlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICB2YXIgbmV4dCA9IHZvaWQgMDsKICAgICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBuZXh0ID0gY29tcGxldGVXb3JrKGN1cnJlbnQ0LCBjb21wbGV0ZWRXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdGFydFByb2ZpbGVyVGltZXIoY29tcGxldGVkV29yayk7CiAgICAgICAgICAgICAgICBuZXh0ID0gY29tcGxldGVXb3JrKGN1cnJlbnQ0LCBjb21wbGV0ZWRXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShjb21wbGV0ZWRXb3JrLCBmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgaWYgKG5leHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbmV4dDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0ID0gdW53aW5kV29yayhjdXJyZW50NCwgY29tcGxldGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKF9uZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBfbmV4dC5mbGFncyAmPSBIb3N0RWZmZWN0TWFzazsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gX25leHQ7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoY29tcGxldGVkV29yaywgZmFsc2UpOwogICAgICAgICAgICAgICAgdmFyIGFjdHVhbER1cmF0aW9uID0gY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuYWN0dWFsRHVyYXRpb24gPSBhY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBJbmNvbXBsZXRlOwogICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290RGlkTm90Q29tcGxldGU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nRmliZXIgPSBjb21wbGV0ZWRXb3JrLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IHNpYmxpbmdGaWJlcjsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGxldGVkV29yayA9IHJldHVybkZpYmVyOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICB9IHdoaWxlIChjb21wbGV0ZWRXb3JrICE9PSBudWxsKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzcykgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdENvbXBsZXRlZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0Um9vdChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNVcGRhdGVMYW5lUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBjb21taXRSb290SW1wbChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zLCBwcmV2aW91c1VwZGF0ZUxhbmVQcmlvcml0eSk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzVXBkYXRlTGFuZVByaW9yaXR5KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRSb290SW1wbChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zLCByZW5kZXJQcmlvcml0eUxldmVsKSB7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0gd2hpbGUgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzICE9PSBudWxsKTsKICAgICAgICAgIGZsdXNoUmVuZGVyUGhhc2VTdHJpY3RNb2RlV2FybmluZ3NJbkRFVigpOwogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmZpbmlzaGVkV29yazsKICAgICAgICAgIHZhciBsYW5lcyA9IHJvb3QzLmZpbmlzaGVkTGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21taXRTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsgPT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21taXRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigicm9vdC5maW5pc2hlZExhbmVzIHNob3VsZCBub3QgYmUgZW1wdHkgZHVyaW5nIGEgY29tbWl0LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgaWYgKGZpbmlzaGVkV29yayA9PT0gcm9vdDMuY3VycmVudCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBjb21taXQgdGhlIHNhbWUgdHJlZSBhcyBiZWZvcmUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByb290My5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgcm9vdDMuY2FsbGJhY2tQcmlvcml0eSA9IE5vTGFuZTsKICAgICAgICAgIHZhciByZW1haW5pbmdMYW5lcyA9IG1lcmdlTGFuZXMoZmluaXNoZWRXb3JrLmxhbmVzLCBmaW5pc2hlZFdvcmsuY2hpbGRMYW5lcyk7CiAgICAgICAgICBtYXJrUm9vdEZpbmlzaGVkKHJvb3QzLCByZW1haW5pbmdMYW5lcyk7CiAgICAgICAgICBpZiAocm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoZmluaXNoZWRXb3JrLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyB8fCAoZmluaXNoZWRXb3JrLmZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIGlmICghcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVUcmFuc2l0aW9ucyA9IHRyYW5zaXRpb25zOwogICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2skMShOb3JtYWxQcmlvcml0eSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHN1YnRyZWVIYXNFZmZlY3RzID0gKGZpbmlzaGVkV29yay5zdWJ0cmVlRmxhZ3MgJiAoQmVmb3JlTXV0YXRpb25NYXNrIHwgTXV0YXRpb25NYXNrIHwgTGF5b3V0TWFzayB8IFBhc3NpdmVNYXNrKSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICB2YXIgcm9vdEhhc0VmZmVjdCA9IChmaW5pc2hlZFdvcmsuZmxhZ3MgJiAoQmVmb3JlTXV0YXRpb25NYXNrIHwgTXV0YXRpb25NYXNrIHwgTGF5b3V0TWFzayB8IFBhc3NpdmVNYXNrKSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoc3VidHJlZUhhc0VmZmVjdHMgfHwgcm9vdEhhc0VmZmVjdCkgewogICAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IENvbW1pdENvbnRleHQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIHZhciBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIyID0gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmVjb3JkQ29tbWl0VGltZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgIHJlc2V0QWZ0ZXJDb21taXQocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdHMoZmluaXNoZWRXb3JrLCByb290MywgbGFuZXMpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVxdWVzdFBhaW50KCk7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZWNvcmRDb21taXRUaW1lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290RGlkSGF2ZVBhc3NpdmVFZmZlY3RzID0gcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHM7CiAgICAgICAgICBpZiAocm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICAgICAgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPSByb290MzsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMgPSBsYW5lczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZW1haW5pbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIGlmIChyZW1haW5pbmdMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghcm9vdERpZEhhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGNvbW1pdERvdWJsZUludm9rZUVmZmVjdHNJbkRFVihyb290My5jdXJyZW50LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG9uQ29tbWl0Um9vdChmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLCByZW5kZXJQcmlvcml0eUxldmVsKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgcm9vdDMubWVtb2l6ZWRVcGRhdGVycy5jbGVhcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG9uQ29tbWl0Um9vdCQxKCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgIGlmIChyZWNvdmVyYWJsZUVycm9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgb25SZWNvdmVyYWJsZUVycm9yID0gcm9vdDMub25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlY292ZXJhYmxlRXJyb3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHJlY292ZXJhYmxlRXJyb3IgPSByZWNvdmVyYWJsZUVycm9yc1tpXTsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSByZWNvdmVyYWJsZUVycm9yLnN0YWNrOwogICAgICAgICAgICAgIHZhciBkaWdlc3QgPSByZWNvdmVyYWJsZUVycm9yLmRpZ2VzdDsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IocmVjb3ZlcmFibGVFcnJvci52YWx1ZSwgewogICAgICAgICAgICAgICAgY29tcG9uZW50U3RhY2ssCiAgICAgICAgICAgICAgICBkaWdlc3QKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhc1VuY2F1Z2h0RXJyb3IpIHsKICAgICAgICAgICAgaGFzVW5jYXVnaHRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgZXJyb3IkMSA9IGZpcnN0VW5jYXVnaHRFcnJvcjsKICAgICAgICAgICAgZmlyc3RVbmNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgICAgdGhyb3cgZXJyb3IkMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHBlbmRpbmdQYXNzaXZlRWZmZWN0c0xhbmVzLCBTeW5jTGFuZSkgJiYgcm9vdDMudGFnICE9PSBMZWdhY3lSb290KSB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlbWFpbmluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUocmVtYWluaW5nTGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya05lc3RlZFVwZGF0ZVNjaGVkdWxlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gcm9vdFdpdGhOZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQrKzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhOZXN0ZWRVcGRhdGVzID0gcm9vdDM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tbWl0U3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHJlbmRlclByaW9yaXR5ID0gbGFuZXNUb0V2ZW50UHJpb3JpdHkocGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMpOwogICAgICAgICAgICB2YXIgcHJpb3JpdHkgPSBsb3dlckV2ZW50UHJpb3JpdHkoRGVmYXVsdEV2ZW50UHJpb3JpdHksIHJlbmRlclByaW9yaXR5KTsKICAgICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByaW9yaXR5KTsKICAgICAgICAgICAgICByZXR1cm4gZmx1c2hQYXNzaXZlRWZmZWN0c0ltcGwoKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3QoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHMucHVzaChmaWJlcik7CiAgICAgICAgICAgIGlmICghcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFjayQxKE5vcm1hbFByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUGFzc2l2ZUVmZmVjdHNJbXBsKCkgewogICAgICAgICAgaWYgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0cmFuc2l0aW9ucyA9IHBlbmRpbmdQYXNzaXZlVHJhbnNpdGlvbnM7CiAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICAgIHZhciByb290MyA9IHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzOwogICAgICAgICAgdmFyIGxhbmVzID0gcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXM7CiAgICAgICAgICByb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyA9IG51bGw7CiAgICAgICAgICBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZsdXNoIHBhc3NpdmUgZWZmZWN0cyB3aGlsZSBhbHJlYWR5IHJlbmRlcmluZy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IENvbW1pdENvbnRleHQ7CiAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHMocm9vdDMuY3VycmVudCk7CiAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzKHJvb3QzLCByb290My5jdXJyZW50LCBsYW5lcywgdHJhbnNpdGlvbnMpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgcHJvZmlsZXJFZmZlY3RzID0gcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHM7CiAgICAgICAgICAgIHBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3RzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvZmlsZXJFZmZlY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlciA9IHByb2ZpbGVyRWZmZWN0c1tpXTsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlRWZmZWN0RHVyYXRpb25zKHJvb3QzLCBfZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKHJvb3QzLmN1cnJlbnQsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgaWYgKHJvb3QzID09PSByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQrKzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSByb290MzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpc0ZsdXNoaW5nUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgb25Qb3N0Q29tbWl0Um9vdChyb290Myk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSByb290My5jdXJyZW50LnN0YXRlTm9kZTsKICAgICAgICAgICAgc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgc3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBbHJlYWR5RmFpbGVkTGVnYWN5RXJyb3JCb3VuZGFyeShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkICE9PSBudWxsICYmIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkLmhhcyhpbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtMZWdhY3lFcnJvckJvdW5kYXJ5QXNGYWlsZWQoaW5zdGFuY2UpIHsKICAgICAgICAgIGlmIChsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9PT0gbnVsbCkgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtpbnN0YW5jZV0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQuYWRkKGluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRvVGhyb3dVbmNhdWdodEVycm9yKGVycm9yMikgewogICAgICAgICAgaWYgKCFoYXNVbmNhdWdodEVycm9yKSB7CiAgICAgICAgICAgIGhhc1VuY2F1Z2h0RXJyb3IgPSB0cnVlOwogICAgICAgICAgICBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBvblVuY2F1Z2h0RXJyb3IgPSBwcmVwYXJlVG9UaHJvd1VuY2F1Z2h0RXJyb3I7CiAgICAgICAgZnVuY3Rpb24gY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3Qocm9vdEZpYmVyLCBzb3VyY2VGaWJlciwgZXJyb3IyKSB7CiAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IyLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlUm9vdEVycm9yVXBkYXRlKHJvb3RGaWJlciwgZXJyb3JJbmZvLCBTeW5jTGFuZSk7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKHJvb3RGaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3Ioc291cmNlRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yJDEpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmVwb3J0VW5jYXVnaHRFcnJvckluREVWKGVycm9yJDEpOwogICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZUZpYmVyLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3Qoc291cmNlRmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvciQxKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpYmVyID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXIgPSBuZWFyZXN0TW91bnRlZEFuY2VzdG9yOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3QoZmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvciQxKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBjdG9yID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIgJiYgIWlzQWxyZWFkeUZhaWxlZExlZ2FjeUVycm9yQm91bmRhcnkoaW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IkMSwgc291cmNlRmliZXIpOwogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJJbnRlcm5hbCBSZWFjdCBlcnJvcjogQXR0ZW1wdGVkIHRvIGNhcHR1cmUgYSBjb21taXQgcGhhc2UgZXJyb3IgaW5zaWRlIGEgZGV0YWNoZWQgdHJlZS4gVGhpcyBpbmRpY2F0ZXMgYSBidWcgaW4gUmVhY3QuIExpa2VseSBjYXVzZXMgaW5jbHVkZSBkZWxldGluZyB0aGUgc2FtZSBmaWJlciBtb3JlIHRoYW4gb25jZSwgY29tbWl0dGluZyBhbiBhbHJlYWR5LWZpbmlzaGVkIHRyZWUsIG9yIGFuIGluY29uc2lzdGVudCByZXR1cm4gcG9pbnRlci5cblxuRXJyb3IgbWVzc2FnZTpcblxuJXMiLCBlcnJvciQxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGluZ1N1c3BlbmRlZFJvb3Qocm9vdDMsIHdha2VhYmxlLCBwaW5nZWRMYW5lcykgewogICAgICAgICAgdmFyIHBpbmdDYWNoZSA9IHJvb3QzLnBpbmdDYWNoZTsKICAgICAgICAgIGlmIChwaW5nQ2FjaGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcGluZ0NhY2hlLmRlbGV0ZSh3YWtlYWJsZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgbWFya1Jvb3RQaW5nZWQocm9vdDMsIHBpbmdlZExhbmVzKTsKICAgICAgICAgIHdhcm5JZlN1c3BlbnNlUmVzb2x1dGlvbk5vdFdyYXBwZWRXaXRoQWN0REVWKHJvb3QzKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgPT09IHJvb3QzICYmIGlzU3Vic2V0T2ZMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcywgcGluZ2VkTGFuZXMpKSB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkV2l0aERlbGF5IHx8IHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWQgJiYgaW5jbHVkZXNPbmx5UmV0cmllcyh3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcykgJiYgbm93KCkgLSBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lIDwgRkFMTEJBQ0tfVEhST1RUTEVfTVMpIHsKICAgICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdFBpbmdlZExhbmVzLCBwaW5nZWRMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSkgewogICAgICAgICAgaWYgKHJldHJ5TGFuZSA9PT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHJ5TGFuZSA9IHJlcXVlc3RSZXRyeUxhbmUoYm91bmRhcnlGaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCByZXRyeUxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeShib3VuZGFyeUZpYmVyKSB7CiAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGJvdW5kYXJ5RmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciByZXRyeUxhbmUgPSBOb0xhbmU7CiAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICByZXRyeUxhbmUgPSBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHJ5VGltZWRPdXRCb3VuZGFyeShib3VuZGFyeUZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlUmV0cnlXYWtlYWJsZShib3VuZGFyeUZpYmVyLCB3YWtlYWJsZSkgewogICAgICAgICAgdmFyIHJldHJ5TGFuZSA9IE5vTGFuZTsKICAgICAgICAgIHZhciByZXRyeUNhY2hlOwogICAgICAgICAgc3dpdGNoIChib3VuZGFyeUZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHJ5Q2FjaGUgPSBib3VuZGFyeUZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGJvdW5kYXJ5RmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0cnlMYW5lID0gc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXRyeUNhY2hlID0gYm91bmRhcnlGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQaW5nZWQgdW5rbm93biBzdXNwZW5zZSBib3VuZGFyeSB0eXBlLiBUaGlzIGlzIHByb2JhYmx5IGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJldHJ5Q2FjaGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0cnlDYWNoZS5kZWxldGUod2FrZWFibGUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpuZCh0aW1lRWxhcHNlZCkgewogICAgICAgICAgcmV0dXJuIHRpbWVFbGFwc2VkIDwgMTIwID8gMTIwIDogdGltZUVsYXBzZWQgPCA0ODAgPyA0ODAgOiB0aW1lRWxhcHNlZCA8IDEwODAgPyAxMDgwIDogdGltZUVsYXBzZWQgPCAxOTIwID8gMTkyMCA6IHRpbWVFbGFwc2VkIDwgM2UzID8gM2UzIDogdGltZUVsYXBzZWQgPCA0MzIwID8gNDMyMCA6IGNlaWwodGltZUVsYXBzZWQgLyAxOTYwKSAqIDE5NjA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRm9yTmVzdGVkVXBkYXRlcygpIHsKICAgICAgICAgIGlmIChuZXN0ZWRVcGRhdGVDb3VudCA+IE5FU1RFRF9VUERBVEVfTElNSVQpIHsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICByb290V2l0aE5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1heGltdW0gdXBkYXRlIGRlcHRoIGV4Y2VlZGVkLiBUaGlzIGNhbiBoYXBwZW4gd2hlbiBhIGNvbXBvbmVudCByZXBlYXRlZGx5IGNhbGxzIHNldFN0YXRlIGluc2lkZSBjb21wb25lbnRXaWxsVXBkYXRlIG9yIGNvbXBvbmVudERpZFVwZGF0ZS4gUmVhY3QgbGltaXRzIHRoZSBudW1iZXIgb2YgbmVzdGVkIHVwZGF0ZXMgdG8gcHJldmVudCBpbmZpbml0ZSBsb29wcy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA+IE5FU1RFRF9QQVNTSVZFX1VQREFURV9MSU1JVCkgewogICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhQYXNzaXZlTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICAgICAgZXJyb3IoIk1heGltdW0gdXBkYXRlIGRlcHRoIGV4Y2VlZGVkLiBUaGlzIGNhbiBoYXBwZW4gd2hlbiBhIGNvbXBvbmVudCBjYWxscyBzZXRTdGF0ZSBpbnNpZGUgdXNlRWZmZWN0LCBidXQgdXNlRWZmZWN0IGVpdGhlciBkb2Vzbid0IGhhdmUgYSBkZXBlbmRlbmN5IGFycmF5LCBvciBvbmUgb2YgdGhlIGRlcGVuZGVuY2llcyBjaGFuZ2VzIG9uIGV2ZXJ5IHJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFJlbmRlclBoYXNlU3RyaWN0TW9kZVdhcm5pbmdzSW5ERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmZsdXNoTGVnYWN5Q29udGV4dFdhcm5pbmcoKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmZsdXNoUGVuZGluZ1Vuc2FmZUxpZmVjeWNsZVdhcm5pbmdzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKGZpYmVyLCBoYXNQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgewogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50TGF5b3V0RGV2LCBpbnZva2VMYXlvdXRFZmZlY3RVbm1vdW50SW5ERVYpOwogICAgICAgICAgICBpZiAoaGFzUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50UGFzc2l2ZURldiwgaW52b2tlUGFzc2l2ZUVmZmVjdFVubW91bnRJbkRFVik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW52b2tlRWZmZWN0c0luRGV2KGZpYmVyLCBNb3VudExheW91dERldiwgaW52b2tlTGF5b3V0RWZmZWN0TW91bnRJbkRFVik7CiAgICAgICAgICAgIGlmIChoYXNQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRQYXNzaXZlRGV2LCBpbnZva2VQYXNzaXZlRWZmZWN0TW91bnRJbkRFVik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlRWZmZWN0c0luRGV2KGZpcnN0Q2hpbGQsIGZpYmVyRmxhZ3MsIGludm9rZUVmZmVjdEZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHZhciBzdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmltYXJ5U3VidHJlZUZsYWcgPSBjdXJyZW50NC5zdWJ0cmVlRmxhZ3MgJiBmaWJlckZsYWdzOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gc3VidHJlZVJvb3QgJiYgY3VycmVudDQuY2hpbGQgIT09IG51bGwgJiYgcHJpbWFyeVN1YnRyZWVGbGFnICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50NCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoKGN1cnJlbnQ0LmZsYWdzICYgZmliZXJGbGFncykgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgaW52b2tlRWZmZWN0Rm4oY3VycmVudDQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0LnNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudDQgPSBjdXJyZW50NC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY3VycmVudDQgPSBzdWJ0cmVlUm9vdCA9IGN1cnJlbnQ0LnJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHdhcm5BYm91dFVwZGF0ZU9uTm90WWV0TW91bnRlZEZpYmVySW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIShmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0YWcgPSBmaWJlci50YWc7CiAgICAgICAgICAgIGlmICh0YWcgIT09IEluZGV0ZXJtaW5hdGVDb21wb25lbnQgJiYgdGFnICE9PSBIb3N0Um9vdCAmJiB0YWcgIT09IENsYXNzQ29tcG9uZW50ICYmIHRhZyAhPT0gRnVuY3Rpb25Db21wb25lbnQgJiYgdGFnICE9PSBGb3J3YXJkUmVmMiAmJiB0YWcgIT09IE1lbW9Db21wb25lbnQgJiYgdGFnICE9PSBTaW1wbGVNZW1vQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlJlYWN0Q29tcG9uZW50IjsKICAgICAgICAgICAgaWYgKGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudC5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtjb21wb25lbnROYW1lXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50MzsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIGVycm9yKCJDYW4ndCBwZXJmb3JtIGEgUmVhY3Qgc3RhdGUgdXBkYXRlIG9uIGEgY29tcG9uZW50IHRoYXQgaGFzbid0IG1vdW50ZWQgeWV0LiBUaGlzIGluZGljYXRlcyB0aGF0IHlvdSBoYXZlIGEgc2lkZS1lZmZlY3QgaW4geW91ciByZW5kZXIgZnVuY3Rpb24gdGhhdCBhc3luY2hyb25vdXNseSBsYXRlciBjYWxscyB0cmllcyB0byB1cGRhdGUgdGhlIGNvbXBvbmVudC4gTW92ZSB0aGlzIHdvcmsgdG8gdXNlRWZmZWN0IGluc3RlYWQuIik7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRmliZXIpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBiZWdpbldvcmskMTsKICAgICAgICB7CiAgICAgICAgICB2YXIgZHVtbXlGaWJlciA9IG51bGw7CiAgICAgICAgICBiZWdpbldvcmskMSA9IGZ1bmN0aW9uKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBsYW5lcykgewogICAgICAgICAgICB2YXIgb3JpZ2luYWxXb3JrSW5Qcm9ncmVzc0NvcHkgPSBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVihkdW1teUZpYmVyLCB1bml0T2ZXb3JrKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gYmVnaW5Xb3JrKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgIH0gY2F0Y2ggKG9yaWdpbmFsRXJyb3IpIHsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZE9yRXJyb3JXaGlsZUh5ZHJhdGluZ0RFVigpIHx8IG9yaWdpbmFsRXJyb3IgIT09IG51bGwgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IgPT09ICJvYmplY3QiICYmIHR5cGVvZiBvcmlnaW5hbEVycm9yLnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRocm93IG9yaWdpbmFsRXJyb3I7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgICAgIHJlc2V0SG9va3NBZnRlclRocm93KCk7CiAgICAgICAgICAgICAgdW53aW5kSW50ZXJydXB0ZWRXb3JrKGN1cnJlbnQ0LCB1bml0T2ZXb3JrKTsKICAgICAgICAgICAgICBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVih1bml0T2ZXb3JrLCBvcmlnaW5hbFdvcmtJblByb2dyZXNzQ29weSk7CiAgICAgICAgICAgICAgaWYgKHVuaXRPZldvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFByb2ZpbGVyVGltZXIodW5pdE9mV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjayhudWxsLCBiZWdpbldvcmssIG51bGwsIGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGhhc0NhdWdodEVycm9yKCkpIHsKICAgICAgICAgICAgICAgIHZhciByZXBsYXlFcnJvciA9IGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVwbGF5RXJyb3IgPT09ICJvYmplY3QiICYmIHJlcGxheUVycm9yICE9PSBudWxsICYmIHJlcGxheUVycm9yLl9zdXBwcmVzc0xvZ2dpbmcgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IgPT09ICJvYmplY3QiICYmIG9yaWdpbmFsRXJyb3IgIT09IG51bGwgJiYgIW9yaWdpbmFsRXJyb3IuX3N1cHByZXNzTG9nZ2luZykgewogICAgICAgICAgICAgICAgICBvcmlnaW5hbEVycm9yLl9zdXBwcmVzc0xvZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvdyBvcmlnaW5hbEVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXIgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5BYm91dFJlbmRlclBoYXNlVXBkYXRlc0luREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1JlbmRlcmluZyAmJiAhZ2V0SXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZUluREVWKCkpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgdmFyIHJlbmRlcmluZ0NvbXBvbmVudE5hbWUgPSB3b3JrSW5Qcm9ncmVzcyAmJiBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICAgIHZhciBkZWR1cGVLZXkgPSByZW5kZXJpbmdDb21wb25lbnROYW1lOwogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudC5oYXMoZGVkdXBlS2V5KSkgewogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudC5hZGQoZGVkdXBlS2V5KTsKICAgICAgICAgICAgICAgICAgICB2YXIgc2V0U3RhdGVDb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgdXBkYXRlIGEgY29tcG9uZW50IChgJXNgKSB3aGlsZSByZW5kZXJpbmcgYSBkaWZmZXJlbnQgY29tcG9uZW50IChgJXNgKS4gVG8gbG9jYXRlIHRoZSBiYWQgc2V0U3RhdGUoKSBjYWxsIGluc2lkZSBgJXNgLCBmb2xsb3cgdGhlIHN0YWNrIHRyYWNlIGFzIGRlc2NyaWJlZCBpbiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc2V0c3RhdGUtaW4tcmVuZGVyIiwgc2V0U3RhdGVDb21wb25lbnROYW1lLCByZW5kZXJpbmdDb21wb25lbnROYW1lLCByZW5kZXJpbmdDb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlcikgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgdXBkYXRlIGR1cmluZyBhbiBleGlzdGluZyBzdGF0ZSB0cmFuc2l0aW9uIChzdWNoIGFzIHdpdGhpbiBgcmVuZGVyYCkuIFJlbmRlciBtZXRob2RzIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlLiIpOwogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgdmFyIG1lbW9pemVkVXBkYXRlcnMgPSByb290My5tZW1vaXplZFVwZGF0ZXJzOwogICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuZm9yRWFjaChmdW5jdGlvbihzY2hlZHVsaW5nRmliZXIpIHsKICAgICAgICAgICAgICAgIGFkZEZpYmVyVG9MYW5lc01hcChyb290Mywgc2NoZWR1bGluZ0ZpYmVyLCBsYW5lcyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGZha2VBY3RDYWxsYmFja05vZGUgPSB7fTsKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrJDEocHJpb3JpdHlMZXZlbCwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGFjdFF1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50OwogICAgICAgICAgICBpZiAoYWN0UXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBhY3RRdWV1ZS5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgICByZXR1cm4gZmFrZUFjdENhbGxiYWNrTm9kZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gc2NoZWR1bGVDYWxsYmFjayhwcmlvcml0eUxldmVsLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FuY2VsQ2FsbGJhY2skMShjYWxsYmFja05vZGUpIHsKICAgICAgICAgIGlmIChjYWxsYmFja05vZGUgPT09IGZha2VBY3RDYWxsYmFja05vZGUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNhbmNlbENhbGxiYWNrKGNhbGxiYWNrTm9kZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZEZvcmNlRmx1c2hGYWxsYmFja3NJbkRFVigpIHsKICAgICAgICAgIHJldHVybiBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgIT09IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlVwZGF0ZXNOb3RXcmFwcGVkV2l0aEFjdERFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICAgICAgaWYgKCFpc0NvbmN1cnJlbnRBY3RFbnZpcm9ubWVudCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICghaXNMZWdhY3lBY3RFbnZpcm9ubWVudCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gRnVuY3Rpb25Db21wb25lbnQgJiYgZmliZXIudGFnICE9PSBGb3J3YXJkUmVmMiAmJiBmaWJlci50YWcgIT09IFNpbXBsZU1lbW9Db21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gY3VycmVudDM7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgICBlcnJvcigiQW4gdXBkYXRlIHRvICVzIGluc2lkZSBhIHRlc3Qgd2FzIG5vdCB3cmFwcGVkIGluIGFjdCguLi4pLlxuXG5XaGVuIHRlc3RpbmcsIGNvZGUgdGhhdCBjYXVzZXMgUmVhY3Qgc3RhdGUgdXBkYXRlcyBzaG91bGQgYmUgd3JhcHBlZCBpbnRvIGFjdCguLi4pOlxuXG5hY3QoKCkgPT4ge1xuICAvKiBmaXJlIGV2ZW50cyB0aGF0IHVwZGF0ZSBzdGF0ZSAqL1xufSk7XG4vKiBhc3NlcnQgb24gdGhlIG91dHB1dCAqL1xuXG5UaGlzIGVuc3VyZXMgdGhhdCB5b3UncmUgdGVzdGluZyB0aGUgYmVoYXZpb3IgdGhlIHVzZXIgd291bGQgc2VlIGluIHRoZSBicm93c2VyLiBMZWFybiBtb3JlIGF0IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93cmFwLXRlc3RzLXdpdGgtYWN0IiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlcikgewogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmU3VzcGVuc2VSZXNvbHV0aW9uTm90V3JhcHBlZFdpdGhBY3RERVYocm9vdDMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJvb3QzLnRhZyAhPT0gTGVnYWN5Um9vdCAmJiBpc0NvbmN1cnJlbnRBY3RFbnZpcm9ubWVudCgpICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJBIHN1c3BlbmRlZCByZXNvdXJjZSBmaW5pc2hlZCBsb2FkaW5nIGluc2lkZSBhIHRlc3QsIGJ1dCB0aGUgZXZlbnQgd2FzIG5vdCB3cmFwcGVkIGluIGFjdCguLi4pLlxuXG5XaGVuIHRlc3RpbmcsIGNvZGUgdGhhdCByZXNvbHZlcyBzdXNwZW5kZWQgZGF0YSBzaG91bGQgYmUgd3JhcHBlZCBpbnRvIGFjdCguLi4pOlxuXG5hY3QoKCkgPT4ge1xuICAvKiBmaW5pc2ggbG9hZGluZyBzdXNwZW5kZWQgZGF0YSAqL1xufSk7XG4vKiBhc3NlcnQgb24gdGhlIG91dHB1dCAqL1xuXG5UaGlzIGVuc3VyZXMgdGhhdCB5b3UncmUgdGVzdGluZyB0aGUgYmVoYXZpb3IgdGhlIHVzZXIgd291bGQgc2VlIGluIHRoZSBicm93c2VyLiBMZWFybiBtb3JlIGF0IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93cmFwLXRlc3RzLXdpdGgtYWN0Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KGlzUnVubmluZykgewogICAgICAgICAgewogICAgICAgICAgICBpc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QgPSBpc1J1bm5pbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZXNvbHZlRmFtaWx5ID0gbnVsbDsKICAgICAgICB2YXIgZmFpbGVkQm91bmRhcmllcyA9IG51bGw7CiAgICAgICAgdmFyIHNldFJlZnJlc2hIYW5kbGVyID0gZnVuY3Rpb24oaGFuZGxlcikgewogICAgICAgICAgewogICAgICAgICAgICByZXNvbHZlRmFtaWx5ID0gaGFuZGxlcjsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZhbWlseSA9IHJlc29sdmVGYW1pbHkodHlwZSk7CiAgICAgICAgICAgIGlmIChmYW1pbHkgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYW1pbHkuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKHR5cGUpIHsKICAgICAgICAgIHJldHVybiByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcodHlwZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKHR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseSh0eXBlKTsKICAgICAgICAgICAgaWYgKGZhbWlseSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGUgIT09IG51bGwgJiYgdHlwZSAhPT0gdm9pZCAwICYmIHR5cGVvZiB0eXBlLnJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRSZW5kZXIgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcodHlwZS5yZW5kZXIpOwogICAgICAgICAgICAgICAgaWYgKHR5cGUucmVuZGVyICE9PSBjdXJyZW50UmVuZGVyKSB7CiAgICAgICAgICAgICAgICAgIHZhciBzeW50aGV0aWNUeXBlID0gewogICAgICAgICAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiwKICAgICAgICAgICAgICAgICAgICByZW5kZXI6IGN1cnJlbnRSZW5kZXIKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGUuZGlzcGxheU5hbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgIHN5bnRoZXRpY1R5cGUuZGlzcGxheU5hbWUgPSB0eXBlLmRpc3BsYXlOYW1lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBzeW50aGV0aWNUeXBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFtaWx5LmN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29tcGF0aWJsZUZhbWlseUZvckhvdFJlbG9hZGluZyhmaWJlciwgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldlR5cGUgPSBmaWJlci5lbGVtZW50VHlwZTsKICAgICAgICAgICAgdmFyIG5leHRUeXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICB2YXIgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSBmYWxzZTsKICAgICAgICAgICAgdmFyICQkdHlwZW9mTmV4dFR5cGUgPSB0eXBlb2YgbmV4dFR5cGUgPT09ICJvYmplY3QiICYmIG5leHRUeXBlICE9PSBudWxsID8gbmV4dFR5cGUuJCR0eXBlb2YgOiBudWxsOwogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6IHsKICAgICAgICAgICAgICAgIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMikgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX01FTU9fVFlQRTIpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lZWRzQ29tcGFyZUZhbWlsaWVzKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZGYW1pbHkgPSByZXNvbHZlRmFtaWx5KHByZXZUeXBlKTsKICAgICAgICAgICAgICBpZiAocHJldkZhbWlseSAhPT0gdm9pZCAwICYmIHByZXZGYW1pbHkgPT09IHJlc29sdmVGYW1pbHkobmV4dFR5cGUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRmFpbGVkRXJyb3JCb3VuZGFyeUZvckhvdFJlbG9hZGluZyhmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIFdlYWtTZXQgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZhaWxlZEJvdW5kYXJpZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmYWlsZWRCb3VuZGFyaWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFpbGVkQm91bmRhcmllcy5hZGQoZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgc2NoZWR1bGVSZWZyZXNoID0gZnVuY3Rpb24ocm9vdDMsIHVwZGF0ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc3RhbGVGYW1pbGllcyA9IHVwZGF0ZS5zdGFsZUZhbWlsaWVzLCB1cGRhdGVkRmFtaWxpZXMgPSB1cGRhdGUudXBkYXRlZEZhbWlsaWVzOwogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KHJvb3QzLmN1cnJlbnQsIHVwZGF0ZWRGYW1pbGllcywgc3RhbGVGYW1pbGllcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIHNjaGVkdWxlUm9vdCA9IGZ1bmN0aW9uKHJvb3QzLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyb290My5jb250ZXh0ICE9PSBlbXB0eUNvbnRleHRPYmplY3QpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGVsZW1lbnQsIHJvb3QzLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KGZpYmVyLCB1cGRhdGVkRmFtaWxpZXMsIHN0YWxlRmFtaWxpZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZSwgY2hpbGQgPSBmaWJlci5jaGlsZCwgc2libGluZyA9IGZpYmVyLnNpYmxpbmcsIHRhZyA9IGZpYmVyLnRhZywgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgIHZhciBjYW5kaWRhdGVUeXBlID0gbnVsbDsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGUucmVuZGVyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHJlc29sdmVGYW1pbHkgdG8gYmUgc2V0IGR1cmluZyBob3QgcmVsb2FkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZWVkc1JlbmRlciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgbmVlZHNSZW1vdW50ID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChjYW5kaWRhdGVUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZhbWlseSA9IHJlc29sdmVGYW1pbHkoY2FuZGlkYXRlVHlwZSk7CiAgICAgICAgICAgICAgaWYgKGZhbWlseSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RhbGVGYW1pbGllcy5oYXMoZmFtaWx5KSkgewogICAgICAgICAgICAgICAgICBuZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh1cGRhdGVkRmFtaWxpZXMuaGFzKGZhbWlseSkpIHsKICAgICAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgICBuZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5lZWRzUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmFpbGVkQm91bmRhcmllcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChmYWlsZWRCb3VuZGFyaWVzLmhhcyhmaWJlcikgfHwgYWx0ZXJuYXRlICE9PSBudWxsICYmIGZhaWxlZEJvdW5kYXJpZXMuaGFzKGFsdGVybmF0ZSkpIHsKICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZWVkc1JlbW91bnQpIHsKICAgICAgICAgICAgICBmaWJlci5fZGVidWdOZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZWVkc1JlbW91bnQgfHwgbmVlZHNSZW5kZXIpIHsKICAgICAgICAgICAgICB2YXIgX3Jvb3QgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAoX3Jvb3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihfcm9vdCwgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCAmJiAhbmVlZHNSZW1vdW50KSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVGaWJlcnNXaXRoRmFtaWxpZXNSZWN1cnNpdmVseShjaGlsZCwgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkoc2libGluZywgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZmluZEhvc3RJbnN0YW5jZXNGb3JSZWZyZXNoID0gZnVuY3Rpb24ocm9vdDMsIGZhbWlsaWVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2VzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdmFyIHR5cGVzID0gbmV3IFNldChmYW1pbGllcy5tYXAoZnVuY3Rpb24oZmFtaWx5KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbWlseS5jdXJyZW50OwogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShyb290My5jdXJyZW50LCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgIHJldHVybiBob3N0SW5zdGFuY2VzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KGZpYmVyLCB0eXBlcywgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZCwgc2libGluZyA9IGZpYmVyLnNpYmxpbmcsIHRhZyA9IGZpYmVyLnRhZywgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgIHZhciBjYW5kaWRhdGVUeXBlID0gbnVsbDsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGUucmVuZGVyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRpZE1hdGNoID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChjYW5kaWRhdGVUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVzLmhhcyhjYW5kaWRhdGVUeXBlKSkgewogICAgICAgICAgICAgICAgZGlkTWF0Y2ggPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkTWF0Y2gpIHsKICAgICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShjaGlsZCwgdHlwZXMsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShzaWJsaW5nLCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZXNGb3JGaWJlclNoYWxsb3dseShmaWJlciwgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgZm91bmRIb3N0SW5zdGFuY2VzID0gZmluZENoaWxkSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgaWYgKGZvdW5kSG9zdEluc3RhbmNlcykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIHN3aXRjaCAobm9kZS50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgICAgIGhvc3RJbnN0YW5jZXMuYWRkKG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gcmVhY2ggcm9vdCBmaXJzdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDaGlsZEhvc3RJbnN0YW5jZXNGb3JGaWJlclNoYWxsb3dseShmaWJlciwgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB2YXIgZm91bmRIb3N0SW5zdGFuY2VzID0gZmFsc2U7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICBmb3VuZEhvc3RJbnN0YW5jZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpYmVyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZm91bmRIb3N0SW5zdGFuY2VzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IGZpYmVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmb3VuZEhvc3RJbnN0YW5jZXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNCYWRNYXBQb2x5ZmlsbDsKICAgICAgICB7CiAgICAgICAgICBoYXNCYWRNYXBQb2x5ZmlsbCA9IGZhbHNlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG5vbkV4dGVuc2libGVPYmplY3QgPSBPYmplY3QucHJldmVudEV4dGVuc2lvbnMoe30pOwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gbmV3IE1hcChbW25vbkV4dGVuc2libGVPYmplY3QsIG51bGxdXSk7CiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtub25FeHRlbnNpYmxlT2JqZWN0XSk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGhhc0JhZE1hcFBvbHlmaWxsID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gRmliZXJOb2RlKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpIHsKICAgICAgICAgIHRoaXMudGFnID0gdGFnOwogICAgICAgICAgdGhpcy5rZXkgPSBrZXk7CiAgICAgICAgICB0aGlzLmVsZW1lbnRUeXBlID0gbnVsbDsKICAgICAgICAgIHRoaXMudHlwZSA9IG51bGw7CiAgICAgICAgICB0aGlzLnN0YXRlTm9kZSA9IG51bGw7CiAgICAgICAgICB0aGlzLnJldHVybiA9IG51bGw7CiAgICAgICAgICB0aGlzLmNoaWxkID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2libGluZyA9IG51bGw7CiAgICAgICAgICB0aGlzLmluZGV4ID0gMDsKICAgICAgICAgIHRoaXMucmVmID0gbnVsbDsKICAgICAgICAgIHRoaXMucGVuZGluZ1Byb3BzID0gcGVuZGluZ1Byb3BzOwogICAgICAgICAgdGhpcy5tZW1vaXplZFByb3BzID0gbnVsbDsKICAgICAgICAgIHRoaXMudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgdGhpcy5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgIHRoaXMuZGVwZW5kZW5jaWVzID0gbnVsbDsKICAgICAgICAgIHRoaXMubW9kZSA9IG1vZGU7CiAgICAgICAgICB0aGlzLmZsYWdzID0gTm9GbGFnczsKICAgICAgICAgIHRoaXMuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgIHRoaXMuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgIHRoaXMubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hY3R1YWxEdXJhdGlvbiA9IE51bWJlci5OYU47CiAgICAgICAgICAgIHRoaXMuYWN0dWFsU3RhcnRUaW1lID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy5zZWxmQmFzZUR1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy50cmVlQmFzZUR1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy5hY3R1YWxEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuYWN0dWFsU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIHRoaXMuc2VsZkJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMudHJlZUJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnU291cmNlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5fZGVidWdPd25lciA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnTmVlZHNSZW1vdW50ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnSG9va1R5cGVzID0gbnVsbDsKICAgICAgICAgICAgaWYgKCFoYXNCYWRNYXBQb2x5ZmlsbCAmJiB0eXBlb2YgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjcmVhdGVGaWJlciA9IGZ1bmN0aW9uKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpIHsKICAgICAgICAgIHJldHVybiBuZXcgRmliZXJOb2RlKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0JDEoQ29tcG9uZW50KSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1NpbXBsZUZ1bmN0aW9uQ29tcG9uZW50KHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIiAmJiAhc2hvdWxkQ29uc3RydWN0JDEodHlwZSkgJiYgdHlwZS5kZWZhdWx0UHJvcHMgPT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUxhenlDb21wb25lbnRUYWcoQ29tcG9uZW50KSB7CiAgICAgICAgICBpZiAodHlwZW9mIENvbXBvbmVudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gc2hvdWxkQ29uc3RydWN0JDEoQ29tcG9uZW50KSA/IENsYXNzQ29tcG9uZW50IDogRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgICB9IGVsc2UgaWYgKENvbXBvbmVudCAhPT0gdm9pZCAwICYmIENvbXBvbmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgJCR0eXBlb2YgPSBDb21wb25lbnQuJCR0eXBlb2Y7CiAgICAgICAgICAgIGlmICgkJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIpIHsKICAgICAgICAgICAgICByZXR1cm4gRm9yd2FyZFJlZjI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIE1lbW9Db21wb25lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBJbmRldGVybWluYXRlQ29tcG9uZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50NCwgcGVuZGluZ1Byb3BzKSB7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MyID0gY3VycmVudDQuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMiA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIgPSBjcmVhdGVGaWJlcihjdXJyZW50NC50YWcsIHBlbmRpbmdQcm9wcywgY3VycmVudDQua2V5LCBjdXJyZW50NC5tb2RlKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID0gY3VycmVudDQuZWxlbWVudFR5cGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gY3VycmVudDQudHlwZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGN1cnJlbnQ0LnN0YXRlTm9kZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdTb3VyY2UgPSBjdXJyZW50NC5fZGVidWdTb3VyY2U7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z093bmVyID0gY3VycmVudDQuX2RlYnVnT3duZXI7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z0hvb2tUeXBlcyA9IGN1cnJlbnQ0Ll9kZWJ1Z0hvb2tUeXBlczsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlID0gY3VycmVudDQ7CiAgICAgICAgICAgIGN1cnJlbnQ0LmFsdGVybmF0ZSA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMgPSBwZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gY3VycmVudDQudHlwZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWN0dWFsU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IGN1cnJlbnQ0LmZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gY3VycmVudDQuY2hpbGRMYW5lczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGN1cnJlbnQ0LmxhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBjdXJyZW50RGVwZW5kZW5jaWVzID0gY3VycmVudDQuZGVwZW5kZW5jaWVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IGN1cnJlbnREZXBlbmRlbmNpZXMgPT09IG51bGwgPyBudWxsIDogewogICAgICAgICAgICBsYW5lczogY3VycmVudERlcGVuZGVuY2llcy5sYW5lcywKICAgICAgICAgICAgZmlyc3RDb250ZXh0OiBjdXJyZW50RGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dAogICAgICAgICAgfTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zaWJsaW5nID0gY3VycmVudDQuc2libGluZzsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5pbmRleCA9IGN1cnJlbnQ0LmluZGV4OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnJlZiA9IGN1cnJlbnQ0LnJlZjsKICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNlbGZCYXNlRHVyYXRpb24gPSBjdXJyZW50NC5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnQ0LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdOZWVkc1JlbW91bnQgPSBjdXJyZW50NC5fZGVidWdOZWVkc1JlbW91bnQ7CiAgICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKGN1cnJlbnQ0LnR5cGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKGN1cnJlbnQ0LnR5cGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUZvcndhcmRSZWZGb3JIb3RSZWxvYWRpbmcoY3VycmVudDQudHlwZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRXb3JrSW5Qcm9ncmVzcyh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IFN0YXRpY01hc2sgfCBQbGFjZW1lbnQ7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gcmVuZGVyTGFuZXMyOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZXBlbmRlbmNpZXMgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gY3VycmVudDQuY2hpbGRMYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDQubGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50NC50eXBlOwogICAgICAgICAgICB2YXIgY3VycmVudERlcGVuZGVuY2llcyA9IGN1cnJlbnQ0LmRlcGVuZGVuY2llczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IGN1cnJlbnREZXBlbmRlbmNpZXMgPT09IG51bGwgPyBudWxsIDogewogICAgICAgICAgICAgIGxhbmVzOiBjdXJyZW50RGVwZW5kZW5jaWVzLmxhbmVzLAogICAgICAgICAgICAgIGZpcnN0Q29udGV4dDogY3VycmVudERlcGVuZGVuY2llcy5maXJzdENvbnRleHQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zZWxmQmFzZUR1cmF0aW9uID0gY3VycmVudDQuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnQ0LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUhvc3RSb290RmliZXIodGFnLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUpIHsKICAgICAgICAgIHZhciBtb2RlOwogICAgICAgICAgaWYgKHRhZyA9PT0gQ29uY3VycmVudFJvb3QpIHsKICAgICAgICAgICAgbW9kZSA9IENvbmN1cnJlbnRNb2RlOwogICAgICAgICAgICBpZiAoaXNTdHJpY3RNb2RlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgbW9kZSB8PSBTdHJpY3RMZWdhY3lNb2RlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0RWZmZWN0c01vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtb2RlID0gTm9Nb2RlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgIG1vZGUgfD0gUHJvZmlsZU1vZGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXIoSG9zdFJvb3QsIG51bGwsIG51bGwsIG1vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHModHlwZSwga2V5LCBwZW5kaW5nUHJvcHMsIG93bmVyLCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIGZpYmVyVGFnID0gSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDsKICAgICAgICAgIHZhciByZXNvbHZlZFR5cGUgPSB0eXBlOwogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDb25zdHJ1Y3QkMSh0eXBlKSkgewogICAgICAgICAgICAgIGZpYmVyVGFnID0gQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyhyZXNvbHZlZFR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgZmliZXJUYWcgPSBIb3N0Q29tcG9uZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2V0VGFnOiBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQocGVuZGluZ1Byb3BzLmNoaWxkcmVuLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NUUklDVF9NT0RFX1RZUEU6CiAgICAgICAgICAgICAgICBmaWJlclRhZyA9IE1vZGU7CiAgICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdExlZ2FjeU1vZGU7CiAgICAgICAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdEVmZmVjdHNNb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbVByb2ZpbGVyKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbVN1c3BlbnNlKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2VMaXN0KHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9PRkZTQ1JFRU5fVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21PZmZzY3JlZW4ocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xFR0FDWV9ISURERU5fVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NDT1BFX1RZUEU6CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DQUNIRV9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfVFJBQ0lOR19NQVJLRVJfVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0RFQlVHX1RSQUNJTkdfTU9ERV9UWVBFOgogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IENvbnRleHRQcm92aWRlcjsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gQ29udGV4dENvbnN1bWVyOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IEZvcndhcmRSZWYyOwogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZFR5cGUgPSByZXNvbHZlRm9yd2FyZFJlZkZvckhvdFJlbG9hZGluZyhyZXNvbHZlZFR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFMjoKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gTGF6eUNvbXBvbmVudDsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwgJiYgT2JqZWN0LmtleXModHlwZSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaW5mbyArPSAiIFlvdSBsaWtlbHkgZm9yZ290IHRvIGV4cG9ydCB5b3VyIGNvbXBvbmVudCBmcm9tIHRoZSBmaWxlIGl0J3MgZGVmaW5lZCBpbiwgb3IgeW91IG1pZ2h0IGhhdmUgbWl4ZWQgdXAgZGVmYXVsdCBhbmQgbmFtZWQgaW1wb3J0cy4iOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBvd25lck5hbWUgPSBvd25lciA/IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIob3duZXIpIDogbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKG93bmVyTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGluZm8gKz0gIlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiBgIiArIG93bmVyTmFtZSArICJgLiI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCB0eXBlIGlzIGludmFsaWQ6IGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgYnVpbHQtaW4gY29tcG9uZW50cykgb3IgYSBjbGFzcy9mdW5jdGlvbiAoZm9yIGNvbXBvc2l0ZSBjb21wb25lbnRzKSAiICsgKCJidXQgZ290OiAiICsgKHR5cGUgPT0gbnVsbCA/IHR5cGUgOiB0eXBlb2YgdHlwZSkgKyAiLiIgKyBpbmZvKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihmaWJlclRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSB0eXBlOwogICAgICAgICAgZmliZXIudHlwZSA9IHJlc29sdmVkVHlwZTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gb3duZXI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBvd25lciA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgIHZhciBrZXkgPSBlbGVtZW50LmtleTsKICAgICAgICAgIHZhciBwZW5kaW5nUHJvcHMgPSBlbGVtZW50LnByb3BzOwogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKHR5cGUsIGtleSwgcGVuZGluZ1Byb3BzLCBvd25lciwgbW9kZSwgbGFuZXMpOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlci5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGVsZW1lbnRzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihGcmFnbWVudDksIGVsZW1lbnRzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tUHJvZmlsZXIocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcGVuZGluZ1Byb3BzLmlkICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgIGVycm9yKCdQcm9maWxlciBtdXN0IHNwZWNpZnkgYW4gImlkIiBvZiB0eXBlIGBzdHJpbmdgIGFzIGEgcHJvcC4gUmVjZWl2ZWQgdGhlIHR5cGUgYCVzYCBpbnN0ZWFkLicsIHR5cGVvZiBwZW5kaW5nUHJvcHMuaWQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihQcm9maWxlciwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUgfCBQcm9maWxlTW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IFJFQUNUX1BST0ZJTEVSX1RZUEU7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSB7CiAgICAgICAgICAgICAgZWZmZWN0RHVyYXRpb246IDAsCiAgICAgICAgICAgICAgcGFzc2l2ZUVmZmVjdER1cmF0aW9uOiAwCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVN1c3BlbnNlKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoU3VzcGVuc2VDb21wb25lbnQsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gUkVBQ1RfU1VTUEVOU0VfVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVN1c3BlbnNlTGlzdChwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKFN1c3BlbnNlTGlzdENvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21PZmZzY3JlZW4ocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihPZmZzY3JlZW5Db21wb25lbnQsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gUkVBQ1RfT0ZGU0NSRUVOX1RZUEU7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEluc3RhbmNlID0gewogICAgICAgICAgICBpc0hpZGRlbjogZmFsc2UKICAgICAgICAgIH07CiAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBwcmltYXJ5Q2hpbGRJbnN0YW5jZTsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tVGV4dChjb250ZW50LCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoSG9zdFRleHQsIGNvbnRlbnQsIG51bGwsIG1vZGUpOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tSG9zdEluc3RhbmNlRm9yRGVsZXRpb24oKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0Q29tcG9uZW50LCBudWxsLCBudWxsLCBOb01vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSAiREVMRVRFRCI7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbURlaHlkcmF0ZWRGcmFnbWVudChkZWh5ZHJhdGVkTm9kZSkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoRGVoeWRyYXRlZEZyYWdtZW50LCBudWxsLCBudWxsLCBOb01vZGUpOwogICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gZGVoeWRyYXRlZE5vZGU7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChwb3J0YWwsIG1vZGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcGVuZGluZ1Byb3BzID0gcG9ydGFsLmNoaWxkcmVuICE9PSBudWxsID8gcG9ydGFsLmNoaWxkcmVuIDogW107CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0UG9ydGFsLCBwZW5kaW5nUHJvcHMsIHBvcnRhbC5rZXksIG1vZGUpOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHsKICAgICAgICAgICAgY29udGFpbmVySW5mbzogcG9ydGFsLmNvbnRhaW5lckluZm8sCiAgICAgICAgICAgIHBlbmRpbmdDaGlsZHJlbjogbnVsbCwKICAgICAgICAgICAgLy8gVXNlZCBieSBwZXJzaXN0ZW50IHVwZGF0ZXMKICAgICAgICAgICAgaW1wbGVtZW50YXRpb246IHBvcnRhbC5pbXBsZW1lbnRhdGlvbgogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXNzaWduRmliZXJQcm9wZXJ0aWVzSW5ERVYodGFyZ2V0LCBzb3VyY2UpIHsKICAgICAgICAgIGlmICh0YXJnZXQgPT09IG51bGwpIHsKICAgICAgICAgICAgdGFyZ2V0ID0gY3JlYXRlRmliZXIoSW5kZXRlcm1pbmF0ZUNvbXBvbmVudCwgbnVsbCwgbnVsbCwgTm9Nb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIHRhcmdldC50YWcgPSBzb3VyY2UudGFnOwogICAgICAgICAgdGFyZ2V0LmtleSA9IHNvdXJjZS5rZXk7CiAgICAgICAgICB0YXJnZXQuZWxlbWVudFR5cGUgPSBzb3VyY2UuZWxlbWVudFR5cGU7CiAgICAgICAgICB0YXJnZXQudHlwZSA9IHNvdXJjZS50eXBlOwogICAgICAgICAgdGFyZ2V0LnN0YXRlTm9kZSA9IHNvdXJjZS5zdGF0ZU5vZGU7CiAgICAgICAgICB0YXJnZXQucmV0dXJuID0gc291cmNlLnJldHVybjsKICAgICAgICAgIHRhcmdldC5jaGlsZCA9IHNvdXJjZS5jaGlsZDsKICAgICAgICAgIHRhcmdldC5zaWJsaW5nID0gc291cmNlLnNpYmxpbmc7CiAgICAgICAgICB0YXJnZXQuaW5kZXggPSBzb3VyY2UuaW5kZXg7CiAgICAgICAgICB0YXJnZXQucmVmID0gc291cmNlLnJlZjsKICAgICAgICAgIHRhcmdldC5wZW5kaW5nUHJvcHMgPSBzb3VyY2UucGVuZGluZ1Byb3BzOwogICAgICAgICAgdGFyZ2V0Lm1lbW9pemVkUHJvcHMgPSBzb3VyY2UubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHRhcmdldC51cGRhdGVRdWV1ZSA9IHNvdXJjZS51cGRhdGVRdWV1ZTsKICAgICAgICAgIHRhcmdldC5tZW1vaXplZFN0YXRlID0gc291cmNlLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB0YXJnZXQuZGVwZW5kZW5jaWVzID0gc291cmNlLmRlcGVuZGVuY2llczsKICAgICAgICAgIHRhcmdldC5tb2RlID0gc291cmNlLm1vZGU7CiAgICAgICAgICB0YXJnZXQuZmxhZ3MgPSBzb3VyY2UuZmxhZ3M7CiAgICAgICAgICB0YXJnZXQuc3VidHJlZUZsYWdzID0gc291cmNlLnN1YnRyZWVGbGFnczsKICAgICAgICAgIHRhcmdldC5kZWxldGlvbnMgPSBzb3VyY2UuZGVsZXRpb25zOwogICAgICAgICAgdGFyZ2V0LmxhbmVzID0gc291cmNlLmxhbmVzOwogICAgICAgICAgdGFyZ2V0LmNoaWxkTGFuZXMgPSBzb3VyY2UuY2hpbGRMYW5lczsKICAgICAgICAgIHRhcmdldC5hbHRlcm5hdGUgPSBzb3VyY2UuYWx0ZXJuYXRlOwogICAgICAgICAgewogICAgICAgICAgICB0YXJnZXQuYWN0dWFsRHVyYXRpb24gPSBzb3VyY2UuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgIHRhcmdldC5hY3R1YWxTdGFydFRpbWUgPSBzb3VyY2UuYWN0dWFsU3RhcnRUaW1lOwogICAgICAgICAgICB0YXJnZXQuc2VsZkJhc2VEdXJhdGlvbiA9IHNvdXJjZS5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB0YXJnZXQudHJlZUJhc2VEdXJhdGlvbiA9IHNvdXJjZS50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0Ll9kZWJ1Z1NvdXJjZSA9IHNvdXJjZS5fZGVidWdTb3VyY2U7CiAgICAgICAgICB0YXJnZXQuX2RlYnVnT3duZXIgPSBzb3VyY2UuX2RlYnVnT3duZXI7CiAgICAgICAgICB0YXJnZXQuX2RlYnVnTmVlZHNSZW1vdW50ID0gc291cmNlLl9kZWJ1Z05lZWRzUmVtb3VudDsKICAgICAgICAgIHRhcmdldC5fZGVidWdIb29rVHlwZXMgPSBzb3VyY2UuX2RlYnVnSG9va1R5cGVzOwogICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gRmliZXJSb290Tm9kZShjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpIHsKICAgICAgICAgIHRoaXMudGFnID0gdGFnOwogICAgICAgICAgdGhpcy5jb250YWluZXJJbmZvID0gY29udGFpbmVySW5mbzsKICAgICAgICAgIHRoaXMucGVuZGluZ0NoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIHRoaXMuY3VycmVudCA9IG51bGw7CiAgICAgICAgICB0aGlzLnBpbmdDYWNoZSA9IG51bGw7CiAgICAgICAgICB0aGlzLmZpbmlzaGVkV29yayA9IG51bGw7CiAgICAgICAgICB0aGlzLnRpbWVvdXRIYW5kbGUgPSBub1RpbWVvdXQ7CiAgICAgICAgICB0aGlzLmNvbnRleHQgPSBudWxsOwogICAgICAgICAgdGhpcy5wZW5kaW5nQ29udGV4dCA9IG51bGw7CiAgICAgICAgICB0aGlzLmNhbGxiYWNrTm9kZSA9IG51bGw7CiAgICAgICAgICB0aGlzLmNhbGxiYWNrUHJpb3JpdHkgPSBOb0xhbmU7CiAgICAgICAgICB0aGlzLmV2ZW50VGltZXMgPSBjcmVhdGVMYW5lTWFwKE5vTGFuZXMpOwogICAgICAgICAgdGhpcy5leHBpcmF0aW9uVGltZXMgPSBjcmVhdGVMYW5lTWFwKE5vVGltZXN0YW1wKTsKICAgICAgICAgIHRoaXMucGVuZGluZ0xhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuc3VzcGVuZGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5waW5nZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmV4cGlyZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLm11dGFibGVSZWFkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5maW5pc2hlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuZW50YW5nbGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5lbnRhbmdsZW1lbnRzID0gY3JlYXRlTGFuZU1hcChOb0xhbmVzKTsKICAgICAgICAgIHRoaXMuaWRlbnRpZmllclByZWZpeCA9IGlkZW50aWZpZXJQcmVmaXg7CiAgICAgICAgICB0aGlzLm9uUmVjb3ZlcmFibGVFcnJvciA9IG9uUmVjb3ZlcmFibGVFcnJvcjsKICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5lZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tZW1vaXplZFVwZGF0ZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdmFyIHBlbmRpbmdVcGRhdGVyc0xhbmVNYXAgPSB0aGlzLnBlbmRpbmdVcGRhdGVyc0xhbmVNYXAgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IFRvdGFsTGFuZXM7IF9pKyspIHsKICAgICAgICAgICAgICBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwLnB1c2goLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlIENvbmN1cnJlbnRSb290OgogICAgICAgICAgICAgICAgdGhpcy5fZGVidWdSb290VHlwZSA9IGh5ZHJhdGUyID8gImh5ZHJhdGVSb290KCkiIDogImNyZWF0ZVJvb3QoKSI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIExlZ2FjeVJvb3Q6CiAgICAgICAgICAgICAgICB0aGlzLl9kZWJ1Z1Jvb3RUeXBlID0gaHlkcmF0ZTIgPyAiaHlkcmF0ZSgpIiA6ICJyZW5kZXIoKSI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlclJvb3QoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaW5pdGlhbENoaWxkcmVuLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yLCB0cmFuc2l0aW9uQ2FsbGJhY2tzKSB7CiAgICAgICAgICB2YXIgcm9vdDMgPSBuZXcgRmliZXJSb290Tm9kZShjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgdmFyIHVuaW5pdGlhbGl6ZWRGaWJlciA9IGNyZWF0ZUhvc3RSb290RmliZXIodGFnLCBpc1N0cmljdE1vZGUpOwogICAgICAgICAgcm9vdDMuY3VycmVudCA9IHVuaW5pdGlhbGl6ZWRGaWJlcjsKICAgICAgICAgIHVuaW5pdGlhbGl6ZWRGaWJlci5zdGF0ZU5vZGUgPSByb290MzsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIF9pbml0aWFsU3RhdGUgPSB7CiAgICAgICAgICAgICAgZWxlbWVudDogaW5pdGlhbENoaWxkcmVuLAogICAgICAgICAgICAgIGlzRGVoeWRyYXRlZDogaHlkcmF0ZTIsCiAgICAgICAgICAgICAgY2FjaGU6IG51bGwsCiAgICAgICAgICAgICAgLy8gbm90IGVuYWJsZWQgeWV0CiAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwsCiAgICAgICAgICAgICAgcGVuZGluZ1N1c3BlbnNlQm91bmRhcmllczogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICB1bmluaXRpYWxpemVkRmliZXIubWVtb2l6ZWRTdGF0ZSA9IF9pbml0aWFsU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpbml0aWFsaXplVXBkYXRlUXVldWUodW5pbml0aWFsaXplZEZpYmVyKTsKICAgICAgICAgIHJldHVybiByb290MzsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0VmVyc2lvbiA9ICIxOC4zLjEiOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVBvcnRhbDMoY2hpbGRyZW4sIGNvbnRhaW5lckluZm8sIGltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgICB2YXIga2V5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbM10gOiBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGtleSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAvLyBUaGlzIHRhZyBhbGxvdyB1cyB0byB1bmlxdWVseSBpZGVudGlmeSB0aGlzIGFzIGEgUmVhY3QgUG9ydGFsCiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9QT1JUQUxfVFlQRSwKICAgICAgICAgICAga2V5OiBrZXkgPT0gbnVsbCA/IG51bGwgOiAiIiArIGtleSwKICAgICAgICAgICAgY2hpbGRyZW4sCiAgICAgICAgICAgIGNvbnRhaW5lckluZm8sCiAgICAgICAgICAgIGltcGxlbWVudGF0aW9uCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGU7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGUgPSB7fTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dEZvclN1YnRyZWUocGFyZW50Q29tcG9uZW50KSB7CiAgICAgICAgICBpZiAoIXBhcmVudENvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm4gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpYmVyID0gZ2V0NihwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgdmFyIHBhcmVudENvbnRleHQgPSBmaW5kQ3VycmVudFVubWFza2VkQ29udGV4dChmaWJlcik7CiAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gZmliZXIudHlwZTsKICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJvY2Vzc0NoaWxkQ29udGV4dChmaWJlciwgQ29tcG9uZW50LCBwYXJlbnRDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VXaXRoV2FybmluZyhjb21wb25lbnQsIG1ldGhvZE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0Nihjb21wb25lbnQpOwogICAgICAgICAgICBpZiAoZmliZXIgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgY29tcG9uZW50LnJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoY29tcG9uZW50KS5qb2luKCIsIik7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFyZ3VtZW50IGFwcGVhcnMgdG8gbm90IGJlIGEgUmVhY3RDb21wb25lbnQuIEtleXM6ICIgKyBrZXlzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhvc3RGaWJlciA9IGZpbmRDdXJyZW50SG9zdEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgaWYgKGhvc3RGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChob3N0RmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGVbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gY3VycmVudDM7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoaG9zdEZpYmVyKTsKICAgICAgICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzIGlzIGRlcHJlY2F0ZWQgaW4gU3RyaWN0TW9kZS4gJXMgd2FzIHBhc3NlZCBhbiBpbnN0YW5jZSBvZiAlcyB3aGljaCBpcyBpbnNpZGUgU3RyaWN0TW9kZS4gSW5zdGVhZCwgYWRkIGEgcmVmIGRpcmVjdGx5IHRvIHRoZSBlbGVtZW50IHlvdSB3YW50IHRvIHJlZmVyZW5jZS4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtZmluZC1ub2RlIiwgbWV0aG9kTmFtZSwgbWV0aG9kTmFtZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzIGlzIGRlcHJlY2F0ZWQgaW4gU3RyaWN0TW9kZS4gJXMgd2FzIHBhc3NlZCBhbiBpbnN0YW5jZSBvZiAlcyB3aGljaCByZW5kZXJzIFN0cmljdE1vZGUgY2hpbGRyZW4uIEluc3RlYWQsIGFkZCBhIHJlZiBkaXJlY3RseSB0byB0aGUgZWxlbWVudCB5b3Ugd2FudCB0byByZWZlcmVuY2UuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLWZpbmQtbm9kZSIsIG1ldGhvZE5hbWUsIG1ldGhvZE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlcikgewogICAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihwcmV2aW91c0ZpYmVyKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBob3N0RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVDb250YWluZXIoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yLCB0cmFuc2l0aW9uQ2FsbGJhY2tzKSB7CiAgICAgICAgICB2YXIgaHlkcmF0ZTIgPSBmYWxzZTsKICAgICAgICAgIHZhciBpbml0aWFsQ2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyUm9vdChjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpbml0aWFsQ2hpbGRyZW4sIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVIeWRyYXRpb25Db250YWluZXIoaW5pdGlhbENoaWxkcmVuLCBjYWxsYmFjaywgY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yLCB0cmFuc2l0aW9uQ2FsbGJhY2tzKSB7CiAgICAgICAgICB2YXIgaHlkcmF0ZTIgPSB0cnVlOwogICAgICAgICAgdmFyIHJvb3QzID0gY3JlYXRlRmliZXJSb290KGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGluaXRpYWxDaGlsZHJlbiwgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICByb290My5jb250ZXh0ID0gZ2V0Q29udGV4dEZvclN1YnRyZWUobnVsbCk7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSByb290My5jdXJyZW50OwogICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoY3VycmVudDQpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2sgIT09IHZvaWQgMCAmJiBjYWxsYmFjayAhPT0gbnVsbCA/IGNhbGxiYWNrIDogbnVsbDsKICAgICAgICAgIGVucXVldWVVcGRhdGUoY3VycmVudDQsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICBzY2hlZHVsZUluaXRpYWxIeWRyYXRpb25PblJvb3Qocm9vdDMsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICByZXR1cm4gcm9vdDM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNvbnRhaW5lcihlbGVtZW50LCBjb250YWluZXIyLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIG9uU2NoZWR1bGVSb290KGNvbnRhaW5lcjIsIGVsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnQkMSA9IGNvbnRhaW5lcjIuY3VycmVudDsKICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGN1cnJlbnQkMSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTY2hlZHVsZWQobGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udGV4dCA9IGdldENvbnRleHRGb3JTdWJ0cmVlKHBhcmVudENvbXBvbmVudCk7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5jb250ZXh0ID09PSBudWxsKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250YWluZXIyLnBlbmRpbmdDb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzUmVuZGVyaW5nICYmIGN1cnJlbnQzICE9PSBudWxsICYmICFkaWRXYXJuQWJvdXROZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcyA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoIlJlbmRlciBtZXRob2RzIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlOyB0cmlnZ2VyaW5nIG5lc3RlZCBjb21wb25lbnQgdXBkYXRlcyBmcm9tIHJlbmRlciBpcyBub3QgYWxsb3dlZC4gSWYgbmVjZXNzYXJ5LCB0cmlnZ2VyIG5lc3RlZCB1cGRhdGVzIGluIGNvbXBvbmVudERpZFVwZGF0ZS5cblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgJXMuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihjdXJyZW50MykgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSB7CiAgICAgICAgICAgIGVsZW1lbnQKICAgICAgICAgIH07CiAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrID09PSB2b2lkIDAgPyBudWxsIDogY2FsbGJhY2s7CiAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogRXhwZWN0ZWQgdGhlIGxhc3Qgb3B0aW9uYWwgYGNhbGxiYWNrYCBhcmd1bWVudCB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShjdXJyZW50JDEsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBjdXJyZW50JDEsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGN1cnJlbnQkMSwgbGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UHVibGljUm9vdEluc3RhbmNlKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHZhciBjb250YWluZXJGaWJlciA9IGNvbnRhaW5lcjIuY3VycmVudDsKICAgICAgICAgIGlmICghY29udGFpbmVyRmliZXIuY2hpbGQpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKGNvbnRhaW5lckZpYmVyLmNoaWxkLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGdldFB1YmxpY0luc3RhbmNlKGNvbnRhaW5lckZpYmVyLmNoaWxkLnN0YXRlTm9kZSk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lckZpYmVyLmNoaWxkLnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uJDEoZmliZXIpIHsKICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgICAgICB2YXIgbGFuZXMgPSBnZXRIaWdoZXN0UHJpb3JpdHlQZW5kaW5nTGFuZXMocm9vdDMpOwogICAgICAgICAgICAgICAgZmx1c2hSb290KHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDQgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgIGlmIChyb290NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDQsIGZpYmVyLCBTeW5jTGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB2YXIgcmV0cnlMYW5lID0gU3luY0xhbmU7CiAgICAgICAgICAgICAgbWFya1JldHJ5TGFuZUlmTm90SHlkcmF0ZWQoZmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JldHJ5TGFuZUltcGwoZmliZXIsIHJldHJ5TGFuZSkgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgIT09IG51bGwgJiYgc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lID0gaGlnaGVyUHJpb3JpdHlMYW5lKHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lLCByZXRyeUxhbmUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgcmV0cnlMYW5lKSB7CiAgICAgICAgICBtYXJrUmV0cnlMYW5lSW1wbChmaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgIG1hcmtSZXRyeUxhbmVJbXBsKGFsdGVybmF0ZSwgcmV0cnlMYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24kMShmaWJlcikgewogICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhbmUgPSBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOwogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBsYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgfQogICAgICAgICAgbWFya1JldHJ5TGFuZUlmTm90SHlkcmF0ZWQoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkkMShmaWJlcikgewogICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIGxhbmUpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VXaXRoTm9Qb3J0YWxzKGZpYmVyKSB7CiAgICAgICAgICB2YXIgaG9zdEZpYmVyID0gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzKGZpYmVyKTsKICAgICAgICAgIGlmIChob3N0RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICB9CiAgICAgICAgdmFyIHNob3VsZEVycm9ySW1wbCA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNob3VsZEVycm9yKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gc2hvdWxkRXJyb3JJbXBsKGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIHNob3VsZFN1c3BlbmRJbXBsID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNob3VsZFN1c3BlbmQoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBzaG91bGRTdXNwZW5kSW1wbChmaWJlcik7CiAgICAgICAgfQogICAgICAgIHZhciBvdmVycmlkZUhvb2tTdGF0ZSA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlSG9va1N0YXRlRGVsZXRlUGF0aCA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlSG9va1N0YXRlUmVuYW1lUGF0aCA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlUHJvcHMgPSBudWxsOwogICAgICAgIHZhciBvdmVycmlkZVByb3BzRGVsZXRlUGF0aCA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlUHJvcHNSZW5hbWVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgc2NoZWR1bGVVcGRhdGUgPSBudWxsOwogICAgICAgIHZhciBzZXRFcnJvckhhbmRsZXIgPSBudWxsOwogICAgICAgIHZhciBzZXRTdXNwZW5zZUhhbmRsZXIgPSBudWxsOwogICAgICAgIHsKICAgICAgICAgIHZhciBjb3B5V2l0aERlbGV0ZUltcGwgPSBmdW5jdGlvbihvYmosIHBhdGgyLCBpbmRleDIpIHsKICAgICAgICAgICAgdmFyIGtleSA9IHBhdGgyW2luZGV4Ml07CiAgICAgICAgICAgIHZhciB1cGRhdGVkID0gaXNBcnJheTIob2JqKSA/IG9iai5zbGljZSgpIDogYXNzaWduMih7fSwgb2JqKTsKICAgICAgICAgICAgaWYgKGluZGV4MiArIDEgPT09IHBhdGgyLmxlbmd0aCkgewogICAgICAgICAgICAgIGlmIChpc0FycmF5Mih1cGRhdGVkKSkgewogICAgICAgICAgICAgICAgdXBkYXRlZC5zcGxpY2Uoa2V5LCAxKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlIHVwZGF0ZWRba2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlZFtrZXldID0gY29weVdpdGhEZWxldGVJbXBsKG9ialtrZXldLCBwYXRoMiwgaW5kZXgyICsgMSk7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aERlbGV0ZSA9IGZ1bmN0aW9uKG9iaiwgcGF0aDIpIHsKICAgICAgICAgICAgcmV0dXJuIGNvcHlXaXRoRGVsZXRlSW1wbChvYmosIHBhdGgyLCAwKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhSZW5hbWVJbXBsID0gZnVuY3Rpb24ob2JqLCBvbGRQYXRoLCBuZXdQYXRoLCBpbmRleDIpIHsKICAgICAgICAgICAgdmFyIG9sZEtleSA9IG9sZFBhdGhbaW5kZXgyXTsKICAgICAgICAgICAgdmFyIHVwZGF0ZWQgPSBpc0FycmF5MihvYmopID8gb2JqLnNsaWNlKCkgOiBhc3NpZ24yKHt9LCBvYmopOwogICAgICAgICAgICBpZiAoaW5kZXgyICsgMSA9PT0gb2xkUGF0aC5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgbmV3S2V5ID0gbmV3UGF0aFtpbmRleDJdOwogICAgICAgICAgICAgIHVwZGF0ZWRbbmV3S2V5XSA9IHVwZGF0ZWRbb2xkS2V5XTsKICAgICAgICAgICAgICBpZiAoaXNBcnJheTIodXBkYXRlZCkpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZWQuc3BsaWNlKG9sZEtleSwgMSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSB1cGRhdGVkW29sZEtleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVwZGF0ZWRbb2xkS2V5XSA9IGNvcHlXaXRoUmVuYW1lSW1wbCgKICAgICAgICAgICAgICAgIC8vICRGbG93Rml4TWUgbnVtYmVyIG9yIHN0cmluZyBpcyBmaW5lIGhlcmUKICAgICAgICAgICAgICAgIG9ialtvbGRLZXldLAogICAgICAgICAgICAgICAgb2xkUGF0aCwKICAgICAgICAgICAgICAgIG5ld1BhdGgsCiAgICAgICAgICAgICAgICBpbmRleDIgKyAxCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhSZW5hbWUgPSBmdW5jdGlvbihvYmosIG9sZFBhdGgsIG5ld1BhdGgpIHsKICAgICAgICAgICAgaWYgKG9sZFBhdGgubGVuZ3RoICE9PSBuZXdQYXRoLmxlbmd0aCkgewogICAgICAgICAgICAgIHdhcm4zKCJjb3B5V2l0aFJlbmFtZSgpIGV4cGVjdHMgcGF0aHMgb2YgdGhlIHNhbWUgbGVuZ3RoIik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3UGF0aC5sZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChvbGRQYXRoW2ldICE9PSBuZXdQYXRoW2ldKSB7CiAgICAgICAgICAgICAgICAgIHdhcm4zKCJjb3B5V2l0aFJlbmFtZSgpIGV4cGVjdHMgcGF0aHMgdG8gYmUgdGhlIHNhbWUgZXhjZXB0IGZvciB0aGUgZGVlcGVzdCBrZXkiKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29weVdpdGhSZW5hbWVJbXBsKG9iaiwgb2xkUGF0aCwgbmV3UGF0aCwgMCk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvcHlXaXRoU2V0SW1wbCA9IGZ1bmN0aW9uKG9iaiwgcGF0aDIsIGluZGV4MiwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGluZGV4MiA+PSBwYXRoMi5sZW5ndGgpIHsKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGtleSA9IHBhdGgyW2luZGV4Ml07CiAgICAgICAgICAgIHZhciB1cGRhdGVkID0gaXNBcnJheTIob2JqKSA/IG9iai5zbGljZSgpIDogYXNzaWduMih7fSwgb2JqKTsKICAgICAgICAgICAgdXBkYXRlZFtrZXldID0gY29weVdpdGhTZXRJbXBsKG9ialtrZXldLCBwYXRoMiwgaW5kZXgyICsgMSwgdmFsdWUpOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhTZXQgPSBmdW5jdGlvbihvYmosIHBhdGgyLCB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gY29weVdpdGhTZXRJbXBsKG9iaiwgcGF0aDIsIDAsIHZhbHVlKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZmluZEhvb2sgPSBmdW5jdGlvbihmaWJlciwgaWQpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRIb29rMiA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50SG9vazIgIT09IG51bGwgJiYgaWQgPiAwKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2syID0gY3VycmVudEhvb2syLm5leHQ7CiAgICAgICAgICAgICAgaWQtLTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY3VycmVudEhvb2syOwogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlID0gZnVuY3Rpb24oZmliZXIsIGlkLCBwYXRoMiwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBmaW5kSG9vayhmaWJlciwgaWQpOwogICAgICAgICAgICBpZiAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGNvcHlXaXRoU2V0KGhvb2subWVtb2l6ZWRTdGF0ZSwgcGF0aDIsIHZhbHVlKTsKICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBhc3NpZ24yKHt9LCBmaWJlci5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoID0gZnVuY3Rpb24oZmliZXIsIGlkLCBwYXRoMikgewogICAgICAgICAgICB2YXIgaG9vayA9IGZpbmRIb29rKGZpYmVyLCBpZCk7CiAgICAgICAgICAgIGlmIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhEZWxldGUoaG9vay5tZW1vaXplZFN0YXRlLCBwYXRoMik7CiAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFByb3BzID0gYXNzaWduMih7fSwgZmliZXIubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlUmVuYW1lUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBpZCwgb2xkUGF0aCwgbmV3UGF0aCkgewogICAgICAgICAgICB2YXIgaG9vayA9IGZpbmRIb29rKGZpYmVyLCBpZCk7CiAgICAgICAgICAgIGlmIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhSZW5hbWUoaG9vay5tZW1vaXplZFN0YXRlLCBvbGRQYXRoLCBuZXdQYXRoKTsKICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBhc3NpZ24yKHt9LCBmaWJlci5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVQcm9wcyA9IGZ1bmN0aW9uKGZpYmVyLCBwYXRoMiwgdmFsdWUpIHsKICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gY29weVdpdGhTZXQoZmliZXIubWVtb2l6ZWRQcm9wcywgcGF0aDIsIHZhbHVlKTsKICAgICAgICAgICAgaWYgKGZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZS5wZW5kaW5nUHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZVByb3BzRGVsZXRlUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBwYXRoMikgewogICAgICAgICAgICBmaWJlci5wZW5kaW5nUHJvcHMgPSBjb3B5V2l0aERlbGV0ZShmaWJlci5tZW1vaXplZFByb3BzLCBwYXRoMik7CiAgICAgICAgICAgIGlmIChmaWJlci5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUucGVuZGluZ1Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGggPSBmdW5jdGlvbihmaWJlciwgb2xkUGF0aCwgbmV3UGF0aCkgewogICAgICAgICAgICBmaWJlci5wZW5kaW5nUHJvcHMgPSBjb3B5V2l0aFJlbmFtZShmaWJlci5tZW1vaXplZFByb3BzLCBvbGRQYXRoLCBuZXdQYXRoKTsKICAgICAgICAgICAgaWYgKGZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZS5wZW5kaW5nUHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBzY2hlZHVsZVVwZGF0ZSA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgc2V0RXJyb3JIYW5kbGVyID0gZnVuY3Rpb24obmV3U2hvdWxkRXJyb3JJbXBsKSB7CiAgICAgICAgICAgIHNob3VsZEVycm9ySW1wbCA9IG5ld1Nob3VsZEVycm9ySW1wbDsKICAgICAgICAgIH07CiAgICAgICAgICBzZXRTdXNwZW5zZUhhbmRsZXIgPSBmdW5jdGlvbihuZXdTaG91bGRTdXNwZW5kSW1wbCkgewogICAgICAgICAgICBzaG91bGRTdXNwZW5kSW1wbCA9IG5ld1Nob3VsZFN1c3BlbmRJbXBsOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZUJ5RmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciBob3N0RmliZXIgPSBmaW5kQ3VycmVudEhvc3RGaWJlcihmaWJlcik7CiAgICAgICAgICBpZiAoaG9zdEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGhvc3RGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVtcHR5RmluZEZpYmVyQnlIb3N0SW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXJGb3JEZXZUb29scygpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50MzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5qZWN0SW50b0RldlRvb2xzKGRldlRvb2xzQ29uZmlnKSB7CiAgICAgICAgICB2YXIgZmluZEZpYmVyQnlIb3N0SW5zdGFuY2UgPSBkZXZUb29sc0NvbmZpZy5maW5kRmliZXJCeUhvc3RJbnN0YW5jZTsKICAgICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgICByZXR1cm4gaW5qZWN0SW50ZXJuYWxzKHsKICAgICAgICAgICAgYnVuZGxlVHlwZTogZGV2VG9vbHNDb25maWcuYnVuZGxlVHlwZSwKICAgICAgICAgICAgdmVyc2lvbjogZGV2VG9vbHNDb25maWcudmVyc2lvbiwKICAgICAgICAgICAgcmVuZGVyZXJQYWNrYWdlTmFtZTogZGV2VG9vbHNDb25maWcucmVuZGVyZXJQYWNrYWdlTmFtZSwKICAgICAgICAgICAgcmVuZGVyZXJDb25maWc6IGRldlRvb2xzQ29uZmlnLnJlbmRlcmVyQ29uZmlnLAogICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZSwKICAgICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoLAogICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZVJlbmFtZVBhdGgsCiAgICAgICAgICAgIG92ZXJyaWRlUHJvcHMsCiAgICAgICAgICAgIG92ZXJyaWRlUHJvcHNEZWxldGVQYXRoLAogICAgICAgICAgICBvdmVycmlkZVByb3BzUmVuYW1lUGF0aCwKICAgICAgICAgICAgc2V0RXJyb3JIYW5kbGVyLAogICAgICAgICAgICBzZXRTdXNwZW5zZUhhbmRsZXIsCiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlLAogICAgICAgICAgICBjdXJyZW50RGlzcGF0Y2hlclJlZjogUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjIsCiAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VCeUZpYmVyLAogICAgICAgICAgICBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZTogZmluZEZpYmVyQnlIb3N0SW5zdGFuY2UgfHwgZW1wdHlGaW5kRmliZXJCeUhvc3RJbnN0YW5jZSwKICAgICAgICAgICAgLy8gUmVhY3QgUmVmcmVzaAogICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlc0ZvclJlZnJlc2gsCiAgICAgICAgICAgIHNjaGVkdWxlUmVmcmVzaCwKICAgICAgICAgICAgc2NoZWR1bGVSb290LAogICAgICAgICAgICBzZXRSZWZyZXNoSGFuZGxlciwKICAgICAgICAgICAgLy8gRW5hYmxlcyBEZXZUb29scyB0byBhcHBlbmQgb3duZXIgc3RhY2tzIHRvIGVycm9yIG1lc3NhZ2VzIGluIERFViBtb2RlLgogICAgICAgICAgICBnZXRDdXJyZW50RmliZXI6IGdldEN1cnJlbnRGaWJlckZvckRldlRvb2xzLAogICAgICAgICAgICAvLyBFbmFibGVzIERldlRvb2xzIHRvIGRldGVjdCByZWNvbmNpbGVyIHZlcnNpb24gcmF0aGVyIHRoYW4gcmVuZGVyZXIgdmVyc2lvbgogICAgICAgICAgICAvLyB3aGljaCBtYXkgbm90IG1hdGNoIGZvciB0aGlyZCBwYXJ0eSByZW5kZXJlcnMuCiAgICAgICAgICAgIHJlY29uY2lsZXJWZXJzaW9uOiBSZWFjdFZlcnNpb24KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB2YXIgZGVmYXVsdE9uUmVjb3ZlcmFibGVFcnJvciA9IHR5cGVvZiByZXBvcnRFcnJvciA9PT0gImZ1bmN0aW9uIiA/ICgKICAgICAgICAgIC8vIEluIG1vZGVybiBicm93c2VycywgcmVwb3J0RXJyb3Igd2lsbCBkaXNwYXRjaCBhbiBlcnJvciBldmVudCwKICAgICAgICAgIC8vIGVtdWxhdGluZyBhbiB1bmNhdWdodCBKYXZhU2NyaXB0IGVycm9yLgogICAgICAgICAgcmVwb3J0RXJyb3IKICAgICAgICApIDogZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBSZWFjdERPTVJvb3QoaW50ZXJuYWxSb290KSB7CiAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBpbnRlcm5hbFJvb3Q7CiAgICAgICAgfQogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUucmVuZGVyID0gUmVhY3RET01Sb290LnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihjaGlsZHJlbikgewogICAgICAgICAgdmFyIHJvb3QzID0gdGhpcy5faW50ZXJuYWxSb290OwogICAgICAgICAgaWYgKHJvb3QzID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHVwZGF0ZSBhbiB1bm1vdW50ZWQgcm9vdC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbMV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IGRvZXMgbm90IHN1cHBvcnQgdGhlIHNlY29uZCBjYWxsYmFjayBhcmd1bWVudC4gVG8gZXhlY3V0ZSBhIHNpZGUgZWZmZWN0IGFmdGVyIHJlbmRlcmluZywgZGVjbGFyZSBpdCBpbiBhIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNWYWxpZENvbnRhaW5lcihhcmd1bWVudHNbMV0pKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBjb250YWluZXIgdG8gdGhlIHNlY29uZCBhcmd1bWVudCBvZiByb290LnJlbmRlciguLi4pLiBZb3UgZG9uJ3QgbmVlZCB0byBwYXNzIGl0IGFnYWluIHNpbmNlIHlvdSBhbHJlYWR5IHBhc3NlZCBpdCB0byBjcmVhdGUgdGhlIHJvb3QuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3VtZW50c1sxXSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHBhc3NlZCBhIHNlY29uZCBhcmd1bWVudCB0byByb290LnJlbmRlciguLi4pIGJ1dCBpdCBvbmx5IGFjY2VwdHMgb25lIGFyZ3VtZW50LiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gcm9vdDMuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2UgPSBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhyb290My5jdXJyZW50KTsKICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlLnBhcmVudE5vZGUgIT09IGNvbnRhaW5lcjIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBJdCBsb29rcyBsaWtlIHRoZSBSZWFjdC1yZW5kZXJlZCBjb250ZW50IG9mIHRoZSByb290IGNvbnRhaW5lciB3YXMgcmVtb3ZlZCB3aXRob3V0IHVzaW5nIFJlYWN0LiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgY2F1c2UgZXJyb3JzLiBJbnN0ZWFkLCBjYWxsIHJvb3QudW5tb3VudCgpIHRvIGVtcHR5IGEgcm9vdCdzIGNvbnRhaW5lci4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihjaGlsZHJlbiwgcm9vdDMsIG51bGwsIG51bGwpOwogICAgICAgIH07CiAgICAgICAgUmVhY3RET01IeWRyYXRpb25Sb290LnByb3RvdHlwZS51bm1vdW50ID0gUmVhY3RET01Sb290LnByb3RvdHlwZS51bm1vdW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzBdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoInVubW91bnQoLi4uKTogZG9lcyBub3Qgc3VwcG9ydCBhIGNhbGxiYWNrIGFyZ3VtZW50LiBUbyBleGVjdXRlIGEgc2lkZSBlZmZlY3QgYWZ0ZXIgcmVuZGVyaW5nLCBkZWNsYXJlIGl0IGluIGEgY29tcG9uZW50IGJvZHkgd2l0aCB1c2VFZmZlY3QoKS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3QzID0gdGhpcy5faW50ZXJuYWxSb290OwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuX2ludGVybmFsUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gcm9vdDMuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0FscmVhZHlSZW5kZXJpbmcoKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkF0dGVtcHRlZCB0byBzeW5jaHJvbm91c2x5IHVubW91bnQgYSByb290IHdoaWxlIFJlYWN0IHdhcyBhbHJlYWR5IHJlbmRlcmluZy4gUmVhY3QgY2Fubm90IGZpbmlzaCB1bm1vdW50aW5nIHRoZSByb290IHVudGlsIHRoZSBjdXJyZW50IHJlbmRlciBoYXMgY29tcGxldGVkLCB3aGljaCBtYXkgbGVhZCB0byBhIHJhY2UgY29uZGl0aW9uLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKG51bGwsIHJvb3QzLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHVubWFya0NvbnRhaW5lckFzUm9vdChjb250YWluZXIyKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3QyKGNvbnRhaW5lcjIsIG9wdGlvbnMyKSB7CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXIoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjcmVhdGVSb290KC4uLik6IFRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuSWZSZWFjdERPTUNvbnRhaW5lckluREVWKGNvbnRhaW5lcjIpOwogICAgICAgICAgdmFyIGlzU3RyaWN0TW9kZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBpZGVudGlmaWVyUHJlZml4ID0gIiI7CiAgICAgICAgICB2YXIgb25SZWNvdmVyYWJsZUVycm9yID0gZGVmYXVsdE9uUmVjb3ZlcmFibGVFcnJvcjsKICAgICAgICAgIHZhciB0cmFuc2l0aW9uQ2FsbGJhY2tzID0gbnVsbDsKICAgICAgICAgIGlmIChvcHRpb25zMiAhPT0gbnVsbCAmJiBvcHRpb25zMiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAob3B0aW9uczIuaHlkcmF0ZSkgewogICAgICAgICAgICAgICAgd2FybjMoImh5ZHJhdGUgdGhyb3VnaCBjcmVhdGVSb290IGlzIGRlcHJlY2F0ZWQuIFVzZSBSZWFjdERPTUNsaWVudC5oeWRyYXRlUm9vdChjb250YWluZXIsIDxBcHAgLz4pIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9uczIgPT09ICJvYmplY3QiICYmIG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBKU1ggZWxlbWVudCB0byBjcmVhdGVSb290LiBZb3UgcHJvYmFibHkgbWVhbnQgdG8gY2FsbCByb290LnJlbmRlciBpbnN0ZWFkLiBFeGFtcGxlIHVzYWdlOlxuXG4gIGxldCByb290ID0gY3JlYXRlUm9vdChkb21Db250YWluZXIpO1xuICByb290LnJlbmRlcig8QXBwIC8+KTsiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnVuc3RhYmxlX3N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBpc1N0cmljdE1vZGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4ID0gb3B0aW9uczIuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IgPSBvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnRyYW5zaXRpb25DYWxsYmFja3MgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyYW5zaXRpb25DYWxsYmFja3MgPSBvcHRpb25zMi50cmFuc2l0aW9uQ2FsbGJhY2tzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSBjcmVhdGVDb250YWluZXIoY29udGFpbmVyMiwgQ29uY3VycmVudFJvb3QsIG51bGwsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICB2YXIgcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgcmV0dXJuIG5ldyBSZWFjdERPTVJvb3Qocm9vdDMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBSZWFjdERPTUh5ZHJhdGlvblJvb3QoaW50ZXJuYWxSb290KSB7CiAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBpbnRlcm5hbFJvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlSHlkcmF0aW9uKHRhcmdldCkgewogICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICBxdWV1ZUV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUudW5zdGFibGVfc2NoZWR1bGVIeWRyYXRpb24gPSBzY2hlZHVsZUh5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBoeWRyYXRlUm9vdChjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKSB7CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXIoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJoeWRyYXRlUm9vdCguLi4pOiBUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgd2FybklmUmVhY3RET01Db250YWluZXJJbkRFVihjb250YWluZXIyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluaXRpYWxDaGlsZHJlbiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoIk11c3QgcHJvdmlkZSBpbml0aWFsIGNoaWxkcmVuIGFzIHNlY29uZCBhcmd1bWVudCB0byBoeWRyYXRlUm9vdC4gRXhhbXBsZSB1c2FnZTogaHlkcmF0ZVJvb3QoZG9tQ29udGFpbmVyLCA8QXBwIC8+KSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaHlkcmF0aW9uQ2FsbGJhY2tzID0gb3B0aW9uczIgIT0gbnVsbCA/IG9wdGlvbnMyIDogbnVsbDsKICAgICAgICAgIHZhciBtdXRhYmxlU291cmNlcyA9IG9wdGlvbnMyICE9IG51bGwgJiYgb3B0aW9uczIuaHlkcmF0ZWRTb3VyY2VzIHx8IG51bGw7CiAgICAgICAgICB2YXIgaXNTdHJpY3RNb2RlID0gZmFsc2U7CiAgICAgICAgICB2YXIgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSAiIjsKICAgICAgICAgIHZhciBvblJlY292ZXJhYmxlRXJyb3IgPSBkZWZhdWx0T25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgaWYgKG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnVuc3RhYmxlX3N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBpc1N0cmljdE1vZGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4ID0gb3B0aW9uczIuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IgPSBvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcihpbml0aWFsQ2hpbGRyZW4sIG51bGwsIGNvbnRhaW5lcjIsIENvbmN1cnJlbnRSb290LCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhjb250YWluZXIyKTsKICAgICAgICAgIGlmIChtdXRhYmxlU291cmNlcykgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG11dGFibGVTb3VyY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIG11dGFibGVTb3VyY2UgPSBtdXRhYmxlU291cmNlc1tpXTsKICAgICAgICAgICAgICByZWdpc3Rlck11dGFibGVTb3VyY2VGb3JIeWRyYXRpb24ocm9vdDMsIG11dGFibGVTb3VyY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV3IFJlYWN0RE9NSHlkcmF0aW9uUm9vdChyb290Myk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRDb250YWluZXIobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhKG5vZGUgJiYgKG5vZGUubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgfHwgIWRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycykpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KG5vZGUpIHsKICAgICAgICAgIHJldHVybiAhIShub2RlICYmIChub2RlLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9GUkFHTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSAmJiBub2RlLm5vZGVWYWx1ZSA9PT0gIiByZWFjdC1tb3VudC1wb2ludC11bnN0YWJsZSAiKSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlJlYWN0RE9NQ29udGFpbmVySW5ERVYoY29udGFpbmVyMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lcjIudGFnTmFtZSAmJiBjb250YWluZXIyLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PT0gIkJPRFkiKSB7CiAgICAgICAgICAgICAgZXJyb3IoImNyZWF0ZVJvb3QoKTogQ3JlYXRpbmcgcm9vdHMgZGlyZWN0bHkgd2l0aCBkb2N1bWVudC5ib2R5IGlzIGRpc2NvdXJhZ2VkLCBzaW5jZSBpdHMgY2hpbGRyZW4gYXJlIG9mdGVuIG1hbmlwdWxhdGVkIGJ5IHRoaXJkLXBhcnR5IHNjcmlwdHMgYW5kIGJyb3dzZXIgZXh0ZW5zaW9ucy4gVGhpcyBtYXkgbGVhZCB0byBzdWJ0bGUgcmVjb25jaWxpYXRpb24gaXNzdWVzLiBUcnkgdXNpbmcgYSBjb250YWluZXIgZWxlbWVudCBjcmVhdGVkIGZvciB5b3VyIGFwcC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKSBvbiBhIGNvbnRhaW5lciB0aGF0IHdhcyBwcmV2aW91c2x5IHBhc3NlZCB0byBSZWFjdERPTS5yZW5kZXIoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKSBvbiBhIGNvbnRhaW5lciB0aGF0IGhhcyBhbHJlYWR5IGJlZW4gcGFzc2VkIHRvIGNyZWF0ZVJvb3QoKSBiZWZvcmUuIEluc3RlYWQsIGNhbGwgcm9vdC5yZW5kZXIoKSBvbiB0aGUgZXhpc3Rpbmcgcm9vdCBpbnN0ZWFkIGlmIHlvdSB3YW50IHRvIHVwZGF0ZSBpdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyJDMgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgdG9wTGV2ZWxVcGRhdGVXYXJuaW5nczsKICAgICAgICB7CiAgICAgICAgICB0b3BMZXZlbFVwZGF0ZVdhcm5pbmdzID0gZnVuY3Rpb24oY29udGFpbmVyMikgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyICYmIGNvbnRhaW5lcjIubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2UgPSBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIuY3VycmVudCk7CiAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZSkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZS5wYXJlbnROb2RlICE9PSBjb250YWluZXIyKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogSXQgbG9va3MgbGlrZSB0aGUgUmVhY3QtcmVuZGVyZWQgY29udGVudCBvZiB0aGlzIGNvbnRhaW5lciB3YXMgcmVtb3ZlZCB3aXRob3V0IHVzaW5nIFJlYWN0LiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgY2F1c2UgZXJyb3JzLiBJbnN0ZWFkLCBjYWxsIFJlYWN0RE9NLnVubW91bnRDb21wb25lbnRBdE5vZGUgdG8gZW1wdHkgYSBjb250YWluZXIuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc1Jvb3RSZW5kZXJlZEJ5U29tZVJlYWN0ID0gISFjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICAgIHZhciByb290RWwgPSBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciBoYXNOb25Sb290UmVhY3RDaGlsZCA9ICEhKHJvb3RFbCAmJiBnZXRJbnN0YW5jZUZyb21Ob2RlKHJvb3RFbCkpOwogICAgICAgICAgICBpZiAoaGFzTm9uUm9vdFJlYWN0Q2hpbGQgJiYgIWlzUm9vdFJlbmRlcmVkQnlTb21lUmVhY3QpIHsKICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IFJlcGxhY2luZyBSZWFjdC1yZW5kZXJlZCBjaGlsZHJlbiB3aXRoIGEgbmV3IHJvb3QgY29tcG9uZW50LiBJZiB5b3UgaW50ZW5kZWQgdG8gdXBkYXRlIHRoZSBjaGlsZHJlbiBvZiB0aGlzIG5vZGUsIHlvdSBzaG91bGQgaW5zdGVhZCBoYXZlIHRoZSBleGlzdGluZyBjaGlsZHJlbiB1cGRhdGUgdGhlaXIgc3RhdGUgYW5kIHJlbmRlciB0aGUgbmV3IGNvbXBvbmVudHMgaW5zdGVhZCBvZiBjYWxsaW5nIFJlYWN0RE9NLnJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lcjIudGFnTmFtZSAmJiBjb250YWluZXIyLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PT0gIkJPRFkiKSB7CiAgICAgICAgICAgICAgZXJyb3IoInJlbmRlcigpOiBSZW5kZXJpbmcgY29tcG9uZW50cyBkaXJlY3RseSBpbnRvIGRvY3VtZW50LmJvZHkgaXMgZGlzY291cmFnZWQsIHNpbmNlIGl0cyBjaGlsZHJlbiBhcmUgb2Z0ZW4gbWFuaXB1bGF0ZWQgYnkgdGhpcmQtcGFydHkgc2NyaXB0cyBhbmQgYnJvd3NlciBleHRlbnNpb25zLiBUaGlzIG1heSBsZWFkIHRvIHN1YnRsZSByZWNvbmNpbGlhdGlvbiBpc3N1ZXMuIFRyeSByZW5kZXJpbmcgaW50byBhIGNvbnRhaW5lciBlbGVtZW50IGNyZWF0ZWQgZm9yIHlvdXIgYXBwLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMikgewogICAgICAgICAgaWYgKCFjb250YWluZXIyKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjIuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjIuZmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbm9vcE9uUmVjb3ZlcmFibGVFcnJvcigpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGVnYWN5Q3JlYXRlUm9vdEZyb21ET01Db250YWluZXIoY29udGFpbmVyMiwgaW5pdGlhbENoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrLCBpc0h5ZHJhdGlvbkNvbnRhaW5lcikgewogICAgICAgICAgaWYgKGlzSHlkcmF0aW9uQ29udGFpbmVyKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRQdWJsaWNSb290SW5zdGFuY2Uocm9vdDMpOwogICAgICAgICAgICAgICAgb3JpZ2luYWxDYWxsYmFjay5jYWxsKGluc3RhbmNlKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcigKICAgICAgICAgICAgICBpbml0aWFsQ2hpbGRyZW4sCiAgICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgICAgY29udGFpbmVyMiwKICAgICAgICAgICAgICBMZWdhY3lSb290LAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgLy8gaHlkcmF0aW9uQ2FsbGJhY2tzCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gaXNTdHJpY3RNb2RlCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwKICAgICAgICAgICAgICAiIiwKICAgICAgICAgICAgICAvLyBpZGVudGlmaWVyUHJlZml4CiAgICAgICAgICAgICAgbm9vcE9uUmVjb3ZlcmFibGVFcnJvcgogICAgICAgICAgICApOwogICAgICAgICAgICBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPSByb290MzsKICAgICAgICAgICAgbWFya0NvbnRhaW5lckFzUm9vdChyb290My5jdXJyZW50LCBjb250YWluZXIyKTsKICAgICAgICAgICAgdmFyIHJvb3RDb250YWluZXJFbGVtZW50ID0gY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gY29udGFpbmVyMi5wYXJlbnROb2RlIDogY29udGFpbmVyMjsKICAgICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICBmbHVzaFN5bmMoKTsKICAgICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJvb3RTaWJsaW5nOwogICAgICAgICAgICB3aGlsZSAocm9vdFNpYmxpbmcgPSBjb250YWluZXIyLmxhc3RDaGlsZCkgewogICAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQocm9vdFNpYmxpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX29yaWdpbmFsQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0UHVibGljUm9vdEluc3RhbmNlKF9yb290KTsKICAgICAgICAgICAgICAgIF9vcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9yb290ID0gY3JlYXRlQ29udGFpbmVyKAogICAgICAgICAgICAgIGNvbnRhaW5lcjIsCiAgICAgICAgICAgICAgTGVnYWN5Um9vdCwKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIC8vIGh5ZHJhdGlvbkNhbGxiYWNrcwogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGlzU3RyaWN0TW9kZQogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsCiAgICAgICAgICAgICAgIiIsCiAgICAgICAgICAgICAgLy8gaWRlbnRpZmllclByZWZpeAogICAgICAgICAgICAgIG5vb3BPblJlY292ZXJhYmxlRXJyb3IKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID0gX3Jvb3Q7CiAgICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3QoX3Jvb3QuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciBfcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhfcm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgX3Jvb3QsIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2spOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIF9yb290OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuT25JbnZhbGlkQ2FsbGJhY2skMShjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwgJiYgdHlwZW9mIGNhbGxiYWNrICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGVyTmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgY2hpbGRyZW4sIGNvbnRhaW5lcjIsIGZvcmNlSHlkcmF0ZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdG9wTGV2ZWxVcGRhdGVXYXJuaW5ncyhjb250YWluZXIyKTsKICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrJDEoY2FsbGJhY2sgPT09IHZvaWQgMCA/IG51bGwgOiBjYWxsYmFjaywgInJlbmRlciIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1heWJlUm9vdCA9IGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgIHZhciByb290MzsKICAgICAgICAgIGlmICghbWF5YmVSb290KSB7CiAgICAgICAgICAgIHJvb3QzID0gbGVnYWN5Q3JlYXRlUm9vdEZyb21ET01Db250YWluZXIoY29udGFpbmVyMiwgY2hpbGRyZW4sIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2ssIGZvcmNlSHlkcmF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByb290MyA9IG1heWJlUm9vdDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBvcmlnaW5hbENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFB1YmxpY1Jvb3RJbnN0YW5jZShyb290Myk7CiAgICAgICAgICAgICAgICBvcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGNoaWxkcmVuLCByb290MywgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjayk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0UHVibGljUm9vdEluc3RhbmNlKHJvb3QzKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZpbmRET01Ob2RlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmluZERPTU5vZGUoY29tcG9uZW50T3JFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RmluZERPTU5vZGUpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRGaW5kRE9NTm9kZSA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoImZpbmRET01Ob2RlIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciByZWxlYXNlLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lciQzLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci5zdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSBvd25lci5zdGF0ZU5vZGUuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyOwogICAgICAgICAgICAgIGlmICghd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBhY2Nlc3NpbmcgZmluZERPTU5vZGUgaW5zaWRlIGl0cyByZW5kZXIoKS4gcmVuZGVyKCkgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIEl0IHNob3VsZCBuZXZlciBhY2Nlc3Mgc29tZXRoaW5nIHRoYXQgcmVxdWlyZXMgc3RhbGUgZGF0YSBmcm9tIHRoZSBwcmV2aW91cyByZW5kZXIsIHN1Y2ggYXMgcmVmcy4gTW92ZSB0aGlzIGxvZ2ljIHRvIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnREaWRVcGRhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUob3duZXIudHlwZSkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG93bmVyLnN0YXRlTm9kZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29tcG9uZW50T3JFbGVtZW50ID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29tcG9uZW50T3JFbGVtZW50Lm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBvbmVudE9yRWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZpbmRIb3N0SW5zdGFuY2VXaXRoV2FybmluZyhjb21wb25lbnRPckVsZW1lbnQsICJmaW5kRE9NTm9kZSIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlKGVsZW1lbnQsIGNvbnRhaW5lcjIsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdERPTS5oeWRyYXRlIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIFVzZSBoeWRyYXRlUm9vdCBpbnN0ZWFkLiBVbnRpbCB5b3Ugc3dpdGNoIHRvIHRoZSBuZXcgQVBJLCB5b3VyIGFwcCB3aWxsIGJlaGF2ZSBhcyBpZiBpdCdzIHJ1bm5pbmcgUmVhY3QgMTcuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpICYmIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICBpZiAoaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS5oeWRyYXRlKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIGh5ZHJhdGVSb290KGNvbnRhaW5lciwgZWxlbWVudCk/Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihudWxsLCBlbGVtZW50LCBjb250YWluZXIyLCB0cnVlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlcihlbGVtZW50LCBjb250YWluZXIyLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiUmVhY3RET00ucmVuZGVyIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIFVzZSBjcmVhdGVSb290IGluc3RlYWQuIFVudGlsIHlvdSBzd2l0Y2ggdG8gdGhlIG5ldyBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikgJiYgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID09PSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NLnJlbmRlcigpIG9uIGEgY29udGFpbmVyIHRoYXQgd2FzIHByZXZpb3VzbHkgcGFzc2VkIHRvIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCByb290LnJlbmRlcihlbGVtZW50KT8iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKG51bGwsIGVsZW1lbnQsIGNvbnRhaW5lcjIsIGZhbHNlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIlJlYWN0RE9NLnVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKCkgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBpbiBSZWFjdCAxOC4gQ29uc2lkZXIgdXNpbmcgYSBwb3J0YWwgaW5zdGVhZC4gVW50aWwgeW91IHN3aXRjaCB0byB0aGUgY3JlYXRlUm9vdCBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyTm9kZSkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcmVudENvbXBvbmVudCA9PSBudWxsIHx8ICFoYXMzKHBhcmVudENvbXBvbmVudCkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJwYXJlbnRDb21wb25lbnQgbXVzdCBiZSBhIHZhbGlkIFJlYWN0IENvbXBvbmVudCIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgZmFsc2UsIGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVubW91bnRDb21wb25lbnRBdE5vZGUgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB1bm1vdW50Q29tcG9uZW50QXROb2RlKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVbm1vdW50Q29tcG9uZW50QXROb2RlKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoInVubW91bnRDb21wb25lbnRBdE5vZGUgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IG1ham9yIHJlbGVhc2UuIFN3aXRjaCB0byB0aGUgY3JlYXRlUm9vdCBBUEkuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ1bm1vdW50Q29tcG9uZW50QXROb2RlKC4uLik6IFRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpc01vZGVyblJvb3QgPSBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChjb250YWluZXIyKSAmJiBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPT09IHZvaWQgMDsKICAgICAgICAgICAgaWYgKGlzTW9kZXJuUm9vdCkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgYXJlIGNhbGxpbmcgUmVhY3RET00udW5tb3VudENvbXBvbmVudEF0Tm9kZSgpIG9uIGEgY29udGFpbmVyIHRoYXQgd2FzIHByZXZpb3VzbHkgcGFzc2VkIHRvIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCByb290LnVubW91bnQoKT8iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIHJvb3RFbCA9IGdldFJlYWN0Um9vdEVsZW1lbnRJbkNvbnRhaW5lcihjb250YWluZXIyKTsKICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRCeURpZmZlcmVudFJlYWN0ID0gcm9vdEVsICYmICFnZXRJbnN0YW5jZUZyb21Ob2RlKHJvb3RFbCk7CiAgICAgICAgICAgICAgaWYgKHJlbmRlcmVkQnlEaWZmZXJlbnRSZWFjdCkgewogICAgICAgICAgICAgICAgZXJyb3IoInVubW91bnRDb21wb25lbnRBdE5vZGUoKTogVGhlIG5vZGUgeW91J3JlIGF0dGVtcHRpbmcgdG8gdW5tb3VudCB3YXMgcmVuZGVyZWQgYnkgYW5vdGhlciBjb3B5IG9mIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIobnVsbCwgbnVsbCwgY29udGFpbmVyMiwgZmFsc2UsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID0gbnVsbDsKICAgICAgICAgICAgICAgIHVubWFya0NvbnRhaW5lckFzUm9vdChjb250YWluZXIyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBfcm9vdEVsID0gZ2V0UmVhY3RSb290RWxlbWVudEluQ29udGFpbmVyKGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgIHZhciBoYXNOb25Sb290UmVhY3RDaGlsZCA9ICEhKF9yb290RWwgJiYgZ2V0SW5zdGFuY2VGcm9tTm9kZShfcm9vdEVsKSk7CiAgICAgICAgICAgICAgdmFyIGlzQ29udGFpbmVyUmVhY3RSb290ID0gY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyMi5wYXJlbnROb2RlKSAmJiAhIWNvbnRhaW5lcjIucGFyZW50Tm9kZS5fcmVhY3RSb290Q29udGFpbmVyOwogICAgICAgICAgICAgIGlmIChoYXNOb25Sb290UmVhY3RDaGlsZCkgewogICAgICAgICAgICAgICAgZXJyb3IoInVubW91bnRDb21wb25lbnRBdE5vZGUoKTogVGhlIG5vZGUgeW91J3JlIGF0dGVtcHRpbmcgdG8gdW5tb3VudCB3YXMgcmVuZGVyZWQgYnkgUmVhY3QgYW5kIGlzIG5vdCBhIHRvcC1sZXZlbCBjb250YWluZXIuICVzIiwgaXNDb250YWluZXJSZWFjdFJvb3QgPyAiWW91IG1heSBoYXZlIGFjY2lkZW50YWxseSBwYXNzZWQgaW4gYSBSZWFjdCByb290IG5vZGUgaW5zdGVhZCBvZiBpdHMgY29udGFpbmVyLiIgOiAiSW5zdGVhZCwgaGF2ZSB0aGUgcGFyZW50IGNvbXBvbmVudCB1cGRhdGUgaXRzIHN0YXRlIGFuZCByZXJlbmRlciBpbiBvcmRlciB0byByZW1vdmUgdGhpcyBjb21wb25lbnQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc2V0QXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbiQxKTsKICAgICAgICBzZXRBdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbiQxKTsKICAgICAgICBzZXRBdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkoYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5JDEpOwogICAgICAgIHNldEdldEN1cnJlbnRVcGRhdGVQcmlvcml0eShnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkpOwogICAgICAgIHNldEF0dGVtcHRIeWRyYXRpb25BdFByaW9yaXR5KHJ1bldpdGhQcmlvcml0eSk7CiAgICAgICAgewogICAgICAgICAgaWYgKHR5cGVvZiBNYXAgIT09ICJmdW5jdGlvbiIgfHwgLy8gJEZsb3dJc3N1ZSBGbG93IGluY29ycmVjdGx5IHRoaW5rcyBNYXAgaGFzIG5vIHByb3RvdHlwZQogICAgICAgICAgTWFwLnByb3RvdHlwZSA9PSBudWxsIHx8IHR5cGVvZiBNYXAucHJvdG90eXBlLmZvckVhY2ggIT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIFNldCAhPT0gImZ1bmN0aW9uIiB8fCAvLyAkRmxvd0lzc3VlIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIFNldCBoYXMgbm8gcHJvdG90eXBlCiAgICAgICAgICBTZXQucHJvdG90eXBlID09IG51bGwgfHwgdHlwZW9mIFNldC5wcm90b3R5cGUuY2xlYXIgIT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIFNldC5wcm90b3R5cGUuZm9yRWFjaCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBlcnJvcigiUmVhY3QgZGVwZW5kcyBvbiBNYXAgYW5kIFNldCBidWlsdC1pbiB0eXBlcy4gTWFrZSBzdXJlIHRoYXQgeW91IGxvYWQgYSBwb2x5ZmlsbCBpbiBvbGRlciBicm93c2Vycy4gaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlYWN0LXBvbHlmaWxscyIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZXRSZXN0b3JlSW1wbGVtZW50YXRpb24ocmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQzKTsKICAgICAgICBzZXRCYXRjaGluZ0ltcGxlbWVudGF0aW9uKGJhdGNoZWRVcGRhdGVzJDEsIGRpc2NyZXRlVXBkYXRlcywgZmx1c2hTeW5jKTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVQb3J0YWwkMShjaGlsZHJlbiwgY29udGFpbmVyMikgewogICAgICAgICAgdmFyIGtleSA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzJdIDogbnVsbDsKICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lcihjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3JlYXRlUG9ydGFsMyhjaGlsZHJlbiwgY29udGFpbmVyMiwgbnVsbCwga2V5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIHVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICB2YXIgSW50ZXJuYWxzID0gewogICAgICAgICAgdXNpbmdDbGllbnRFbnRyeVBvaW50OiBmYWxzZSwKICAgICAgICAgIC8vIEtlZXAgaW4gc3luYyB3aXRoIFJlYWN0VGVzdFV0aWxzLmpzLgogICAgICAgICAgLy8gVGhpcyBpcyBhbiBhcnJheSBmb3IgYmV0dGVyIG1pbmlmaWNhdGlvbi4KICAgICAgICAgIEV2ZW50czogW2dldEluc3RhbmNlRnJvbU5vZGUsIGdldE5vZGVGcm9tSW5zdGFuY2UsIGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUsIGVucXVldWVTdGF0ZVJlc3RvcmUsIHJlc3RvcmVTdGF0ZUlmTmVlZGVkLCBiYXRjaGVkVXBkYXRlcyQxXQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUm9vdCQxKGNvbnRhaW5lcjIsIG9wdGlvbnMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghSW50ZXJuYWxzLnVzaW5nQ2xpZW50RW50cnlQb2ludCAmJiB0cnVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ1lvdSBhcmUgaW1wb3J0aW5nIGNyZWF0ZVJvb3QgZnJvbSAicmVhY3QtZG9tIiB3aGljaCBpcyBub3Qgc3VwcG9ydGVkLiBZb3Ugc2hvdWxkIGluc3RlYWQgaW1wb3J0IGl0IGZyb20gInJlYWN0LWRvbS9jbGllbnQiLicpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3JlYXRlUm9vdDIoY29udGFpbmVyMiwgb3B0aW9uczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlUm9vdCQxKGNvbnRhaW5lcjIsIGluaXRpYWxDaGlsZHJlbiwgb3B0aW9uczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFJbnRlcm5hbHMudXNpbmdDbGllbnRFbnRyeVBvaW50ICYmIHRydWUpIHsKICAgICAgICAgICAgICBlcnJvcignWW91IGFyZSBpbXBvcnRpbmcgaHlkcmF0ZVJvb3QgZnJvbSAicmVhY3QtZG9tIiB3aGljaCBpcyBub3Qgc3VwcG9ydGVkLiBZb3Ugc2hvdWxkIGluc3RlYWQgaW1wb3J0IGl0IGZyb20gInJlYWN0LWRvbS9jbGllbnQiLicpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaHlkcmF0ZVJvb3QoY29udGFpbmVyMiwgaW5pdGlhbENoaWxkcmVuLCBvcHRpb25zMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoU3luYyQxKGZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0FscmVhZHlSZW5kZXJpbmcoKSkgewogICAgICAgICAgICAgIGVycm9yKCJmbHVzaFN5bmMgd2FzIGNhbGxlZCBmcm9tIGluc2lkZSBhIGxpZmVjeWNsZSBtZXRob2QuIFJlYWN0IGNhbm5vdCBmbHVzaCB3aGVuIFJlYWN0IGlzIGFscmVhZHkgcmVuZGVyaW5nLiBDb25zaWRlciBtb3ZpbmcgdGhpcyBjYWxsIHRvIGEgc2NoZWR1bGVyIHRhc2sgb3IgbWljcm8gdGFzay4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZsdXNoU3luYyhmbik7CiAgICAgICAgfQogICAgICAgIHZhciBmb3VuZERldlRvb2xzID0gaW5qZWN0SW50b0RldlRvb2xzKHsKICAgICAgICAgIGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlOiBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZSwKICAgICAgICAgIGJ1bmRsZVR5cGU6IDEsCiAgICAgICAgICB2ZXJzaW9uOiBSZWFjdFZlcnNpb24sCiAgICAgICAgICByZW5kZXJlclBhY2thZ2VOYW1lOiAicmVhY3QtZG9tIgogICAgICAgIH0pOwogICAgICAgIHsKICAgICAgICAgIGlmICghZm91bmREZXZUb29scyAmJiBjYW5Vc2VET00yICYmIHdpbmRvdy50b3AgPT09IHdpbmRvdy5zZWxmKSB7CiAgICAgICAgICAgIGlmIChuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIkNocm9tZSIpID4gLTEgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJFZGdlIikgPT09IC0xIHx8IG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiRmlyZWZveCIpID4gLTEpIHsKICAgICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2w7CiAgICAgICAgICAgICAgaWYgKC9eKGh0dHBzP3xmaWxlKTokLy50ZXN0KHByb3RvY29sKSkgewogICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKCIlY0Rvd25sb2FkIHRoZSBSZWFjdCBEZXZUb29scyBmb3IgYSBiZXR0ZXIgZGV2ZWxvcG1lbnQgZXhwZXJpZW5jZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlYWN0LWRldnRvb2xzIiArIChwcm90b2NvbCA9PT0gImZpbGU6IiA/ICJcbllvdSBtaWdodCBuZWVkIHRvIHVzZSBhIGxvY2FsIEhUVFAgc2VydmVyIChpbnN0ZWFkIG9mIGZpbGU6Ly8pOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtZGV2dG9vbHMtZmFxIiA6ICIiKSwgImZvbnQtd2VpZ2h0OmJvbGQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXhwb3J0cy5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IEludGVybmFsczsKICAgICAgICBleHBvcnRzLmNyZWF0ZVBvcnRhbCA9IGNyZWF0ZVBvcnRhbCQxOwogICAgICAgIGV4cG9ydHMuY3JlYXRlUm9vdCA9IGNyZWF0ZVJvb3QkMTsKICAgICAgICBleHBvcnRzLmZpbmRET01Ob2RlID0gZmluZERPTU5vZGU7CiAgICAgICAgZXhwb3J0cy5mbHVzaFN5bmMgPSBmbHVzaFN5bmMkMTsKICAgICAgICBleHBvcnRzLmh5ZHJhdGUgPSBoeWRyYXRlOwogICAgICAgIGV4cG9ydHMuaHlkcmF0ZVJvb3QgPSBoeWRyYXRlUm9vdCQxOwogICAgICAgIGV4cG9ydHMucmVuZGVyID0gcmVuZGVyOwogICAgICAgIGV4cG9ydHMudW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IHVubW91bnRDb21wb25lbnRBdE5vZGU7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9iYXRjaGVkVXBkYXRlcyA9IGJhdGNoZWRVcGRhdGVzJDE7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lciA9IHJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyOwogICAgICAgIGV4cG9ydHMudmVyc2lvbiA9IFJlYWN0VmVyc2lvbjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvcmVhY3QtZG9tL2luZGV4LmpzCnZhciByZXF1aXJlX3JlYWN0X2RvbSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgY2hlY2tEQ0UoKTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JlYWN0X2RvbV9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9jbGllbnQuanMKdmFyIHJlcXVpcmVfY2xpZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvcmVhY3QtZG9tL2NsaWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIG0gPSByZXF1aXJlX3JlYWN0X2RvbSgpOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIGV4cG9ydHMuY3JlYXRlUm9vdCA9IG0uY3JlYXRlUm9vdDsKICAgICAgZXhwb3J0cy5oeWRyYXRlUm9vdCA9IG0uaHlkcmF0ZVJvb3Q7CiAgICB9IGVsc2UgewogICAgICBpID0gbS5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRDsKICAgICAgZXhwb3J0cy5jcmVhdGVSb290ID0gZnVuY3Rpb24oYywgbykgewogICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gdHJ1ZTsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIG0uY3JlYXRlUm9vdChjLCBvKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaS51c2luZ0NsaWVudEVudHJ5UG9pbnQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGV4cG9ydHMuaHlkcmF0ZVJvb3QgPSBmdW5jdGlvbihjLCBoLCBvKSB7CiAgICAgICAgaS51c2luZ0NsaWVudEVudHJ5UG9pbnQgPSB0cnVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gbS5oeWRyYXRlUm9vdChjLCBoLCBvKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaS51c2luZ0NsaWVudEVudHJ5UG9pbnQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICB2YXIgaTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvX2ludGVybmFsL2lzVW5zYWZlUHJvcGVydHkuanMKdmFyIHJlcXVpcmVfaXNVbnNhZmVQcm9wZXJ0eSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9faW50ZXJuYWwvaXNVbnNhZmVQcm9wZXJ0eS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc1Vuc2FmZVByb3BlcnR5KGtleSkgewogICAgICByZXR1cm4ga2V5ID09PSAiX19wcm90b19fIjsKICAgIH0KICAgIGV4cG9ydHMuaXNVbnNhZmVQcm9wZXJ0eSA9IGlzVW5zYWZlUHJvcGVydHk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNEZWVwS2V5LmpzCnZhciByZXF1aXJlX2lzRGVlcEtleSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzRGVlcEtleS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc0RlZXBLZXkoa2V5KSB7CiAgICAgIHN3aXRjaCAodHlwZW9mIGtleSkgewogICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgY2FzZSAic3ltYm9sIjogewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBjYXNlICJzdHJpbmciOiB7CiAgICAgICAgICByZXR1cm4ga2V5LmluY2x1ZGVzKCIuIikgfHwga2V5LmluY2x1ZGVzKCJbIikgfHwga2V5LmluY2x1ZGVzKCJdIik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBleHBvcnRzLmlzRGVlcEtleSA9IGlzRGVlcEtleTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC90b0tleS5qcwp2YXIgcmVxdWlyZV90b0tleSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL3RvS2V5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIHRvS2V5KHZhbHVlKSB7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciIHx8IHR5cGVvZiB2YWx1ZSA9PT0gInN5bWJvbCIpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgaWYgKE9iamVjdC5pcyh2YWx1ZT8udmFsdWVPZj8uKCksIC0wKSkgewogICAgICAgIHJldHVybiAiLTAiOwogICAgICB9CiAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpOwogICAgfQogICAgZXhwb3J0cy50b0tleSA9IHRvS2V5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b1N0cmluZy5qcwp2YXIgcmVxdWlyZV90b1N0cmluZyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b1N0cmluZy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiB0b1N0cmluZyh2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgICAgIHJldHVybiAiIjsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdmFsdWUubWFwKHRvU3RyaW5nKS5qb2luKCIsIik7CiAgICAgIH0KICAgICAgY29uc3QgcmVzdWx0ID0gU3RyaW5nKHZhbHVlKTsKICAgICAgaWYgKHJlc3VsdCA9PT0gIjAiICYmIE9iamVjdC5pcyhOdW1iZXIodmFsdWUpLCAtMCkpIHsKICAgICAgICByZXR1cm4gIi0wIjsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZXhwb3J0cy50b1N0cmluZyA9IHRvU3RyaW5nOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b1BhdGguanMKdmFyIHJlcXVpcmVfdG9QYXRoID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvUGF0aC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgdG9TdHJpbmcgPSByZXF1aXJlX3RvU3RyaW5nKCk7CiAgICB2YXIgdG9LZXkgPSByZXF1aXJlX3RvS2V5KCk7CiAgICBmdW5jdGlvbiB0b1BhdGgoZGVlcEtleSkgewogICAgICBpZiAoQXJyYXkuaXNBcnJheShkZWVwS2V5KSkgewogICAgICAgIHJldHVybiBkZWVwS2V5Lm1hcCh0b0tleS50b0tleSk7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBkZWVwS2V5ID09PSAic3ltYm9sIikgewogICAgICAgIHJldHVybiBbZGVlcEtleV07CiAgICAgIH0KICAgICAgZGVlcEtleSA9IHRvU3RyaW5nLnRvU3RyaW5nKGRlZXBLZXkpOwogICAgICBjb25zdCByZXN1bHQgPSBbXTsKICAgICAgY29uc3QgbGVuZ3RoID0gZGVlcEtleS5sZW5ndGg7CiAgICAgIGlmIChsZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgIGxldCBrZXkgPSAiIjsKICAgICAgbGV0IHF1b3RlQ2hhciA9ICIiOwogICAgICBsZXQgYnJhY2tldCA9IGZhbHNlOwogICAgICBpZiAoZGVlcEtleS5jaGFyQ29kZUF0KDApID09PSA0NikgewogICAgICAgIHJlc3VsdC5wdXNoKCIiKTsKICAgICAgICBpbmRleCsrOwogICAgICB9CiAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgIGNvbnN0IGNoYXIgPSBkZWVwS2V5W2luZGV4XTsKICAgICAgICBpZiAocXVvdGVDaGFyKSB7CiAgICAgICAgICBpZiAoY2hhciA9PT0gIlxcIiAmJiBpbmRleCArIDEgPCBsZW5ndGgpIHsKICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAga2V5ICs9IGRlZXBLZXlbaW5kZXhdOwogICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSBxdW90ZUNoYXIpIHsKICAgICAgICAgICAgcXVvdGVDaGFyID0gIiI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrZXkgKz0gY2hhcjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGJyYWNrZXQpIHsKICAgICAgICAgIGlmIChjaGFyID09PSAnIicgfHwgY2hhciA9PT0gIiciKSB7CiAgICAgICAgICAgIHF1b3RlQ2hhciA9IGNoYXI7CiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICJdIikgewogICAgICAgICAgICBicmFja2V0ID0gZmFsc2U7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICAgICAgICAgIGtleSA9ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga2V5ICs9IGNoYXI7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChjaGFyID09PSAiWyIpIHsKICAgICAgICAgICAgYnJhY2tldCA9IHRydWU7CiAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaChrZXkpOwogICAgICAgICAgICAgIGtleSA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICIuIikgewogICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgICAgICAgICBrZXkgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga2V5ICs9IGNoYXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGluZGV4Kys7CiAgICAgIH0KICAgICAgaWYgKGtleSkgewogICAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGV4cG9ydHMudG9QYXRoID0gdG9QYXRoOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L2dldC5qcwp2YXIgcmVxdWlyZV9nZXQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9nZXQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzVW5zYWZlUHJvcGVydHkgPSByZXF1aXJlX2lzVW5zYWZlUHJvcGVydHkoKTsKICAgIHZhciBpc0RlZXBLZXkgPSByZXF1aXJlX2lzRGVlcEtleSgpOwogICAgdmFyIHRvS2V5ID0gcmVxdWlyZV90b0tleSgpOwogICAgdmFyIHRvUGF0aCA9IHJlcXVpcmVfdG9QYXRoKCk7CiAgICBmdW5jdGlvbiBnZXQ2KG9iamVjdCwgcGF0aDIsIGRlZmF1bHRWYWx1ZSkgewogICAgICBpZiAob2JqZWN0ID09IG51bGwpIHsKICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICB9CiAgICAgIHN3aXRjaCAodHlwZW9mIHBhdGgyKSB7CiAgICAgICAgY2FzZSAic3RyaW5nIjogewogICAgICAgICAgaWYgKGlzVW5zYWZlUHJvcGVydHkuaXNVbnNhZmVQcm9wZXJ0eShwYXRoMikpIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IG9iamVjdFtwYXRoMl07CiAgICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKGlzRGVlcEtleS5pc0RlZXBLZXkocGF0aDIpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldDYob2JqZWN0LCB0b1BhdGgudG9QYXRoKHBhdGgyKSwgZGVmYXVsdFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgIGNhc2UgInN5bWJvbCI6IHsKICAgICAgICAgIGlmICh0eXBlb2YgcGF0aDIgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIHBhdGgyID0gdG9LZXkudG9LZXkocGF0aDIpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcmVzdWx0ID0gb2JqZWN0W3BhdGgyXTsKICAgICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocGF0aDIpKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRXaXRoUGF0aChvYmplY3QsIHBhdGgyLCBkZWZhdWx0VmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKE9iamVjdC5pcyhwYXRoMj8udmFsdWVPZigpLCAtMCkpIHsKICAgICAgICAgICAgcGF0aDIgPSAiLTAiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGF0aDIgPSBTdHJpbmcocGF0aDIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzVW5zYWZlUHJvcGVydHkuaXNVbnNhZmVQcm9wZXJ0eShwYXRoMikpIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IG9iamVjdFtwYXRoMl07CiAgICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBnZXRXaXRoUGF0aChvYmplY3QsIHBhdGgyLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgaWYgKHBhdGgyLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgIH0KICAgICAgbGV0IGN1cnJlbnQzID0gb2JqZWN0OwogICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcGF0aDIubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgaWYgKGN1cnJlbnQzID09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgfQogICAgICAgIGlmIChpc1Vuc2FmZVByb3BlcnR5LmlzVW5zYWZlUHJvcGVydHkocGF0aDJbaW5kZXhdKSkgewogICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICB9CiAgICAgICAgY3VycmVudDMgPSBjdXJyZW50M1twYXRoMltpbmRleF1dOwogICAgICB9CiAgICAgIGlmIChjdXJyZW50MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gY3VycmVudDM7CiAgICB9CiAgICBleHBvcnRzLmdldCA9IGdldDY7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvZ2V0LmpzCnZhciByZXF1aXJlX2dldDIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9nZXQuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX2dldCgpLmdldDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvYXJyYXkvdW5pcUJ5LmpzCnZhciByZXF1aXJlX3VuaXFCeSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9hcnJheS91bmlxQnkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gdW5pcUJ5MihhcnIsIG1hcHBlcikgewogICAgICBjb25zdCBtYXAzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBpdGVtID0gYXJyW2ldOwogICAgICAgIGNvbnN0IGtleSA9IG1hcHBlcihpdGVtKTsKICAgICAgICBpZiAoIW1hcDMuaGFzKGtleSkpIHsKICAgICAgICAgIG1hcDMuc2V0KGtleSwgaXRlbSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBBcnJheS5mcm9tKG1hcDMudmFsdWVzKCkpOwogICAgfQogICAgZXhwb3J0cy51bmlxQnkgPSB1bmlxQnkyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9mdW5jdGlvbi9pZGVudGl0eS5qcwp2YXIgcmVxdWlyZV9pZGVudGl0eSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9mdW5jdGlvbi9pZGVudGl0eS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpZGVudGl0eTQoeDIpIHsKICAgICAgcmV0dXJuIHgyOwogICAgfQogICAgZXhwb3J0cy5pZGVudGl0eSA9IGlkZW50aXR5NDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzTGVuZ3RoLmpzCnZhciByZXF1aXJlX2lzTGVuZ3RoID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L3ByZWRpY2F0ZS9pc0xlbmd0aC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc0xlbmd0aCh2YWx1ZSkgewogICAgICByZXR1cm4gTnVtYmVyLmlzU2FmZUludGVnZXIodmFsdWUpICYmIHZhbHVlID49IDA7CiAgICB9CiAgICBleHBvcnRzLmlzTGVuZ3RoID0gaXNMZW5ndGg7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNBcnJheUxpa2UuanMKdmFyIHJlcXVpcmVfaXNBcnJheUxpa2UgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FycmF5TGlrZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNMZW5ndGggPSByZXF1aXJlX2lzTGVuZ3RoKCk7CiAgICBmdW5jdGlvbiBpc0FycmF5TGlrZSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgIT09ICJmdW5jdGlvbiIgJiYgaXNMZW5ndGguaXNMZW5ndGgodmFsdWUubGVuZ3RoKTsKICAgIH0KICAgIGV4cG9ydHMuaXNBcnJheUxpa2UgPSBpc0FycmF5TGlrZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc09iamVjdExpa2UuanMKdmFyIHJlcXVpcmVfaXNPYmplY3RMaWtlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNPYmplY3RMaWtlLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzT2JqZWN0TGlrZSh2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbDsKICAgIH0KICAgIGV4cG9ydHMuaXNPYmplY3RMaWtlID0gaXNPYmplY3RMaWtlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzQXJyYXlMaWtlT2JqZWN0LmpzCnZhciByZXF1aXJlX2lzQXJyYXlMaWtlT2JqZWN0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNBcnJheUxpa2VPYmplY3QuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzQXJyYXlMaWtlID0gcmVxdWlyZV9pc0FycmF5TGlrZSgpOwogICAgdmFyIGlzT2JqZWN0TGlrZSA9IHJlcXVpcmVfaXNPYmplY3RMaWtlKCk7CiAgICBmdW5jdGlvbiBpc0FycmF5TGlrZU9iamVjdCh2YWx1ZSkgewogICAgICByZXR1cm4gaXNPYmplY3RMaWtlLmlzT2JqZWN0TGlrZSh2YWx1ZSkgJiYgaXNBcnJheUxpa2UuaXNBcnJheUxpa2UodmFsdWUpOwogICAgfQogICAgZXhwb3J0cy5pc0FycmF5TGlrZU9iamVjdCA9IGlzQXJyYXlMaWtlT2JqZWN0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L3Byb3BlcnR5LmpzCnZhciByZXF1aXJlX3Byb3BlcnR5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvcHJvcGVydHkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGdldDYgPSByZXF1aXJlX2dldCgpOwogICAgZnVuY3Rpb24gcHJvcGVydHkocGF0aDIpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHJldHVybiBnZXQ2LmdldChvYmplY3QsIHBhdGgyKTsKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMucHJvcGVydHkgPSBwcm9wZXJ0eTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc09iamVjdC5qcwp2YXIgcmVxdWlyZV9pc09iamVjdCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzT2JqZWN0LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSAhPT0gbnVsbCAmJiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiB8fCB0eXBlb2YgdmFsdWUgPT09ICJmdW5jdGlvbiIpOwogICAgfQogICAgZXhwb3J0cy5pc09iamVjdCA9IGlzT2JqZWN0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNQcmltaXRpdmUuanMKdmFyIHJlcXVpcmVfaXNQcmltaXRpdmUgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzUHJpbWl0aXZlLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzUHJpbWl0aXZlKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSAhPT0gIm9iamVjdCIgJiYgdHlwZW9mIHZhbHVlICE9PSAiZnVuY3Rpb24iOwogICAgfQogICAgZXhwb3J0cy5pc1ByaW1pdGl2ZSA9IGlzUHJpbWl0aXZlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC9lcS5qcwp2YXIgcmVxdWlyZV9lcSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC9lcS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBlcSh2YWx1ZSwgb3RoZXIpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSBvdGhlciB8fCBOdW1iZXIuaXNOYU4odmFsdWUpICYmIE51bWJlci5pc05hTihvdGhlcik7CiAgICB9CiAgICBleHBvcnRzLmVxID0gZXE7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNNYXRjaFdpdGguanMKdmFyIHJlcXVpcmVfaXNNYXRjaFdpdGggPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc01hdGNoV2l0aC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNPYmplY3QgPSByZXF1aXJlX2lzT2JqZWN0KCk7CiAgICB2YXIgaXNQcmltaXRpdmUgPSByZXF1aXJlX2lzUHJpbWl0aXZlKCk7CiAgICB2YXIgZXEgPSByZXF1aXJlX2VxKCk7CiAgICBmdW5jdGlvbiBpc01hdGNoV2l0aCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSkgewogICAgICBpZiAodHlwZW9mIGNvbXBhcmUgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICByZXR1cm4gaXNNYXRjaFdpdGgodGFyZ2V0LCBzb3VyY2UsICgpID0+IHZvaWQgMCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGlzTWF0Y2hXaXRoSW50ZXJuYWwodGFyZ2V0LCBzb3VyY2UsIGZ1bmN0aW9uIGRvZXNNYXRjaChvYmpWYWx1ZSwgc3JjVmFsdWUsIGtleSwgb2JqZWN0LCBzb3VyY2UyLCBzdGFjaykgewogICAgICAgIGNvbnN0IGlzRXF1YWwgPSBjb21wYXJlKG9ialZhbHVlLCBzcmNWYWx1ZSwga2V5LCBvYmplY3QsIHNvdXJjZTIsIHN0YWNrKTsKICAgICAgICBpZiAoaXNFcXVhbCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICByZXR1cm4gQm9vbGVhbihpc0VxdWFsKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGlzTWF0Y2hXaXRoSW50ZXJuYWwob2JqVmFsdWUsIHNyY1ZhbHVlLCBkb2VzTWF0Y2gsIHN0YWNrKTsKICAgICAgfSwgLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSk7CiAgICB9CiAgICBmdW5jdGlvbiBpc01hdGNoV2l0aEludGVybmFsKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjaykgewogICAgICBpZiAoc291cmNlID09PSB0YXJnZXQpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBzd2l0Y2ggKHR5cGVvZiBzb3VyY2UpIHsKICAgICAgICBjYXNlICJvYmplY3QiOiB7CiAgICAgICAgICByZXR1cm4gaXNPYmplY3RNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spOwogICAgICAgIH0KICAgICAgICBjYXNlICJmdW5jdGlvbiI6IHsKICAgICAgICAgIGNvbnN0IHNvdXJjZUtleXMgPSBPYmplY3Qua2V5cyhzb3VyY2UpOwogICAgICAgICAgaWYgKHNvdXJjZUtleXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICByZXR1cm4gaXNNYXRjaFdpdGhJbnRlcm5hbCh0YXJnZXQsIHsgLi4uc291cmNlIH0sIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlcS5lcSh0YXJnZXQsIHNvdXJjZSk7CiAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgIGlmICghaXNPYmplY3QuaXNPYmplY3QodGFyZ2V0KSkgewogICAgICAgICAgICByZXR1cm4gZXEuZXEodGFyZ2V0LCBzb3VyY2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2UgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiBzb3VyY2UgPT09ICIiOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpc09iamVjdE1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjaykgewogICAgICBpZiAoc291cmNlID09IG51bGwpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoQXJyYXkuaXNBcnJheShzb3VyY2UpKSB7CiAgICAgICAgcmV0dXJuIGlzQXJyYXlNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spOwogICAgICB9CiAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBNYXApIHsKICAgICAgICByZXR1cm4gaXNNYXBNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spOwogICAgICB9CiAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBTZXQpIHsKICAgICAgICByZXR1cm4gaXNTZXRNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spOwogICAgICB9CiAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhzb3VyY2UpOwogICAgICBpZiAodGFyZ2V0ID09IG51bGwpIHsKICAgICAgICByZXR1cm4ga2V5cy5sZW5ndGggPT09IDA7CiAgICAgIH0KICAgICAgaWYgKGtleXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKHN0YWNrPy5oYXMoc291cmNlKSkgewogICAgICAgIHJldHVybiBzdGFjay5nZXQoc291cmNlKSA9PT0gdGFyZ2V0OwogICAgICB9CiAgICAgIHN0YWNrPy5zZXQoc291cmNlLCB0YXJnZXQpOwogICAgICB0cnkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3Qga2V5ID0ga2V5c1tpXTsKICAgICAgICAgIGlmICghaXNQcmltaXRpdmUuaXNQcmltaXRpdmUodGFyZ2V0KSAmJiAhKGtleSBpbiB0YXJnZXQpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzb3VyY2Vba2V5XSA9PT0gdm9pZCAwICYmIHRhcmdldFtrZXldICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZVtrZXldID09PSBudWxsICYmIHRhcmdldFtrZXldICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGlzRXF1YWwgPSBjb21wYXJlKHRhcmdldFtrZXldLCBzb3VyY2Vba2V5XSwga2V5LCB0YXJnZXQsIHNvdXJjZSwgc3RhY2spOwogICAgICAgICAgaWYgKCFpc0VxdWFsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgc3RhY2s/LmRlbGV0ZShzb3VyY2UpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpc01hcE1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjaykgewogICAgICBpZiAoc291cmNlLnNpemUgPT09IDApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoISh0YXJnZXQgaW5zdGFuY2VvZiBNYXApKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGZvciAoY29uc3QgW2tleSwgc291cmNlVmFsdWVdIG9mIHNvdXJjZS5lbnRyaWVzKCkpIHsKICAgICAgICBjb25zdCB0YXJnZXRWYWx1ZSA9IHRhcmdldC5nZXQoa2V5KTsKICAgICAgICBjb25zdCBpc0VxdWFsID0gY29tcGFyZSh0YXJnZXRWYWx1ZSwgc291cmNlVmFsdWUsIGtleSwgdGFyZ2V0LCBzb3VyY2UsIHN0YWNrKTsKICAgICAgICBpZiAoaXNFcXVhbCA9PT0gZmFsc2UpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBmdW5jdGlvbiBpc0FycmF5TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKSB7CiAgICAgIGlmIChzb3VyY2UubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRhcmdldCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgY29uc3QgY291bnRlZEluZGV4ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzb3VyY2UubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBzb3VyY2VJdGVtID0gc291cmNlW2ldOwogICAgICAgIGxldCBmb3VuZCA9IGZhbHNlOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGFyZ2V0Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBpZiAoY291bnRlZEluZGV4LmhhcyhqKSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHRhcmdldEl0ZW0gPSB0YXJnZXRbal07CiAgICAgICAgICBsZXQgbWF0Y2hlczIgPSBmYWxzZTsKICAgICAgICAgIGNvbnN0IGlzRXF1YWwgPSBjb21wYXJlKHRhcmdldEl0ZW0sIHNvdXJjZUl0ZW0sIGksIHRhcmdldCwgc291cmNlLCBzdGFjayk7CiAgICAgICAgICBpZiAoaXNFcXVhbCkgewogICAgICAgICAgICBtYXRjaGVzMiA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWF0Y2hlczIpIHsKICAgICAgICAgICAgY291bnRlZEluZGV4LmFkZChqKTsKICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFmb3VuZCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGZ1bmN0aW9uIGlzU2V0TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKSB7CiAgICAgIGlmIChzb3VyY2Uuc2l6ZSA9PT0gMCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmICghKHRhcmdldCBpbnN0YW5jZW9mIFNldCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIGlzQXJyYXlNYXRjaChbLi4udGFyZ2V0XSwgWy4uLnNvdXJjZV0sIGNvbXBhcmUsIHN0YWNrKTsKICAgIH0KICAgIGV4cG9ydHMuaXNNYXRjaFdpdGggPSBpc01hdGNoV2l0aDsKICAgIGV4cG9ydHMuaXNTZXRNYXRjaCA9IGlzU2V0TWF0Y2g7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNNYXRjaC5qcwp2YXIgcmVxdWlyZV9pc01hdGNoID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNNYXRjaC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNNYXRjaFdpdGggPSByZXF1aXJlX2lzTWF0Y2hXaXRoKCk7CiAgICBmdW5jdGlvbiBpc01hdGNoKHRhcmdldCwgc291cmNlKSB7CiAgICAgIHJldHVybiBpc01hdGNoV2l0aC5pc01hdGNoV2l0aCh0YXJnZXQsIHNvdXJjZSwgKCkgPT4gdm9pZCAwKTsKICAgIH0KICAgIGV4cG9ydHMuaXNNYXRjaCA9IGlzTWF0Y2g7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvZ2V0U3ltYm9scy5qcwp2YXIgcmVxdWlyZV9nZXRTeW1ib2xzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvZ2V0U3ltYm9scy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBnZXRTeW1ib2xzKG9iamVjdCkgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhvYmplY3QpLmZpbHRlcigoc3ltYm9sKSA9PiBPYmplY3QucHJvdG90eXBlLnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwob2JqZWN0LCBzeW1ib2wpKTsKICAgIH0KICAgIGV4cG9ydHMuZ2V0U3ltYm9scyA9IGdldFN5bWJvbHM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvZ2V0VGFnLmpzCnZhciByZXF1aXJlX2dldFRhZyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2dldFRhZy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBnZXRUYWcodmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICByZXR1cm4gdmFsdWUgPT09IHZvaWQgMCA/ICJbb2JqZWN0IFVuZGVmaW5lZF0iIDogIltvYmplY3QgTnVsbF0iOwogICAgICB9CiAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpOwogICAgfQogICAgZXhwb3J0cy5nZXRUYWcgPSBnZXRUYWc7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdGFncy5qcwp2YXIgcmVxdWlyZV90YWdzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdGFncy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgcmVnZXhwVGFnID0gIltvYmplY3QgUmVnRXhwXSI7CiAgICB2YXIgc3RyaW5nVGFnID0gIltvYmplY3QgU3RyaW5nXSI7CiAgICB2YXIgbnVtYmVyVGFnID0gIltvYmplY3QgTnVtYmVyXSI7CiAgICB2YXIgYm9vbGVhblRhZyA9ICJbb2JqZWN0IEJvb2xlYW5dIjsKICAgIHZhciBhcmd1bWVudHNUYWcgPSAiW29iamVjdCBBcmd1bWVudHNdIjsKICAgIHZhciBzeW1ib2xUYWcgPSAiW29iamVjdCBTeW1ib2xdIjsKICAgIHZhciBkYXRlVGFnID0gIltvYmplY3QgRGF0ZV0iOwogICAgdmFyIG1hcFRhZyA9ICJbb2JqZWN0IE1hcF0iOwogICAgdmFyIHNldFRhZyA9ICJbb2JqZWN0IFNldF0iOwogICAgdmFyIGFycmF5VGFnID0gIltvYmplY3QgQXJyYXldIjsKICAgIHZhciBmdW5jdGlvblRhZyA9ICJbb2JqZWN0IEZ1bmN0aW9uXSI7CiAgICB2YXIgYXJyYXlCdWZmZXJUYWcgPSAiW29iamVjdCBBcnJheUJ1ZmZlcl0iOwogICAgdmFyIG9iamVjdFRhZyA9ICJbb2JqZWN0IE9iamVjdF0iOwogICAgdmFyIGVycm9yVGFnID0gIltvYmplY3QgRXJyb3JdIjsKICAgIHZhciBkYXRhVmlld1RhZyA9ICJbb2JqZWN0IERhdGFWaWV3XSI7CiAgICB2YXIgdWludDhBcnJheVRhZyA9ICJbb2JqZWN0IFVpbnQ4QXJyYXldIjsKICAgIHZhciB1aW50OENsYW1wZWRBcnJheVRhZyA9ICJbb2JqZWN0IFVpbnQ4Q2xhbXBlZEFycmF5XSI7CiAgICB2YXIgdWludDE2QXJyYXlUYWcgPSAiW29iamVjdCBVaW50MTZBcnJheV0iOwogICAgdmFyIHVpbnQzMkFycmF5VGFnID0gIltvYmplY3QgVWludDMyQXJyYXldIjsKICAgIHZhciBiaWdVaW50NjRBcnJheVRhZyA9ICJbb2JqZWN0IEJpZ1VpbnQ2NEFycmF5XSI7CiAgICB2YXIgaW50OEFycmF5VGFnID0gIltvYmplY3QgSW50OEFycmF5XSI7CiAgICB2YXIgaW50MTZBcnJheVRhZyA9ICJbb2JqZWN0IEludDE2QXJyYXldIjsKICAgIHZhciBpbnQzMkFycmF5VGFnID0gIltvYmplY3QgSW50MzJBcnJheV0iOwogICAgdmFyIGJpZ0ludDY0QXJyYXlUYWcgPSAiW29iamVjdCBCaWdJbnQ2NEFycmF5XSI7CiAgICB2YXIgZmxvYXQzMkFycmF5VGFnID0gIltvYmplY3QgRmxvYXQzMkFycmF5XSI7CiAgICB2YXIgZmxvYXQ2NEFycmF5VGFnID0gIltvYmplY3QgRmxvYXQ2NEFycmF5XSI7CiAgICBleHBvcnRzLmFyZ3VtZW50c1RhZyA9IGFyZ3VtZW50c1RhZzsKICAgIGV4cG9ydHMuYXJyYXlCdWZmZXJUYWcgPSBhcnJheUJ1ZmZlclRhZzsKICAgIGV4cG9ydHMuYXJyYXlUYWcgPSBhcnJheVRhZzsKICAgIGV4cG9ydHMuYmlnSW50NjRBcnJheVRhZyA9IGJpZ0ludDY0QXJyYXlUYWc7CiAgICBleHBvcnRzLmJpZ1VpbnQ2NEFycmF5VGFnID0gYmlnVWludDY0QXJyYXlUYWc7CiAgICBleHBvcnRzLmJvb2xlYW5UYWcgPSBib29sZWFuVGFnOwogICAgZXhwb3J0cy5kYXRhVmlld1RhZyA9IGRhdGFWaWV3VGFnOwogICAgZXhwb3J0cy5kYXRlVGFnID0gZGF0ZVRhZzsKICAgIGV4cG9ydHMuZXJyb3JUYWcgPSBlcnJvclRhZzsKICAgIGV4cG9ydHMuZmxvYXQzMkFycmF5VGFnID0gZmxvYXQzMkFycmF5VGFnOwogICAgZXhwb3J0cy5mbG9hdDY0QXJyYXlUYWcgPSBmbG9hdDY0QXJyYXlUYWc7CiAgICBleHBvcnRzLmZ1bmN0aW9uVGFnID0gZnVuY3Rpb25UYWc7CiAgICBleHBvcnRzLmludDE2QXJyYXlUYWcgPSBpbnQxNkFycmF5VGFnOwogICAgZXhwb3J0cy5pbnQzMkFycmF5VGFnID0gaW50MzJBcnJheVRhZzsKICAgIGV4cG9ydHMuaW50OEFycmF5VGFnID0gaW50OEFycmF5VGFnOwogICAgZXhwb3J0cy5tYXBUYWcgPSBtYXBUYWc7CiAgICBleHBvcnRzLm51bWJlclRhZyA9IG51bWJlclRhZzsKICAgIGV4cG9ydHMub2JqZWN0VGFnID0gb2JqZWN0VGFnOwogICAgZXhwb3J0cy5yZWdleHBUYWcgPSByZWdleHBUYWc7CiAgICBleHBvcnRzLnNldFRhZyA9IHNldFRhZzsKICAgIGV4cG9ydHMuc3RyaW5nVGFnID0gc3RyaW5nVGFnOwogICAgZXhwb3J0cy5zeW1ib2xUYWcgPSBzeW1ib2xUYWc7CiAgICBleHBvcnRzLnVpbnQxNkFycmF5VGFnID0gdWludDE2QXJyYXlUYWc7CiAgICBleHBvcnRzLnVpbnQzMkFycmF5VGFnID0gdWludDMyQXJyYXlUYWc7CiAgICBleHBvcnRzLnVpbnQ4QXJyYXlUYWcgPSB1aW50OEFycmF5VGFnOwogICAgZXhwb3J0cy51aW50OENsYW1wZWRBcnJheVRhZyA9IHVpbnQ4Q2xhbXBlZEFycmF5VGFnOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNUeXBlZEFycmF5LmpzCnZhciByZXF1aXJlX2lzVHlwZWRBcnJheSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNUeXBlZEFycmF5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzVHlwZWRBcnJheSh4MikgewogICAgICByZXR1cm4gQXJyYXlCdWZmZXIuaXNWaWV3KHgyKSAmJiAhKHgyIGluc3RhbmNlb2YgRGF0YVZpZXcpOwogICAgfQogICAgZXhwb3J0cy5pc1R5cGVkQXJyYXkgPSBpc1R5cGVkQXJyYXk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L29iamVjdC9jbG9uZURlZXBXaXRoLmpzCnZhciByZXF1aXJlX2Nsb25lRGVlcFdpdGggPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3Qvb2JqZWN0L2Nsb25lRGVlcFdpdGguanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGdldFN5bWJvbHMgPSByZXF1aXJlX2dldFN5bWJvbHMoKTsKICAgIHZhciBnZXRUYWcgPSByZXF1aXJlX2dldFRhZygpOwogICAgdmFyIHRhZ3MgPSByZXF1aXJlX3RhZ3MoKTsKICAgIHZhciBpc1ByaW1pdGl2ZSA9IHJlcXVpcmVfaXNQcmltaXRpdmUoKTsKICAgIHZhciBpc1R5cGVkQXJyYXkgPSByZXF1aXJlX2lzVHlwZWRBcnJheSgpOwogICAgZnVuY3Rpb24gY2xvbmVEZWVwV2l0aChvYmosIGNsb25lVmFsdWUpIHsKICAgICAgcmV0dXJuIGNsb25lRGVlcFdpdGhJbXBsKG9iaiwgdm9pZCAwLCBvYmosIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCksIGNsb25lVmFsdWUpOwogICAgfQogICAgZnVuY3Rpb24gY2xvbmVEZWVwV2l0aEltcGwodmFsdWVUb0Nsb25lLCBrZXlUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjayA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCksIGNsb25lVmFsdWUgPSB2b2lkIDApIHsKICAgICAgY29uc3QgY2xvbmVkID0gY2xvbmVWYWx1ZT8uKHZhbHVlVG9DbG9uZSwga2V5VG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2spOwogICAgICBpZiAoY2xvbmVkICE9PSB2b2lkIDApIHsKICAgICAgICByZXR1cm4gY2xvbmVkOwogICAgICB9CiAgICAgIGlmIChpc1ByaW1pdGl2ZS5pc1ByaW1pdGl2ZSh2YWx1ZVRvQ2xvbmUpKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlVG9DbG9uZTsKICAgICAgfQogICAgICBpZiAoc3RhY2suaGFzKHZhbHVlVG9DbG9uZSkpIHsKICAgICAgICByZXR1cm4gc3RhY2suZ2V0KHZhbHVlVG9DbG9uZSk7CiAgICAgIH0KICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWVUb0Nsb25lKSkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBBcnJheSh2YWx1ZVRvQ2xvbmUubGVuZ3RoKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWVUb0Nsb25lLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICByZXN1bHRbaV0gPSBjbG9uZURlZXBXaXRoSW1wbCh2YWx1ZVRvQ2xvbmVbaV0sIGksIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICB9CiAgICAgICAgaWYgKE9iamVjdC5oYXNPd24odmFsdWVUb0Nsb25lLCAiaW5kZXgiKSkgewogICAgICAgICAgcmVzdWx0LmluZGV4ID0gdmFsdWVUb0Nsb25lLmluZGV4OwogICAgICAgIH0KICAgICAgICBpZiAoT2JqZWN0Lmhhc093bih2YWx1ZVRvQ2xvbmUsICJpbnB1dCIpKSB7CiAgICAgICAgICByZXN1bHQuaW5wdXQgPSB2YWx1ZVRvQ2xvbmUuaW5wdXQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWVUb0Nsb25lLmdldFRpbWUoKSk7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBSZWdFeHAodmFsdWVUb0Nsb25lLnNvdXJjZSwgdmFsdWVUb0Nsb25lLmZsYWdzKTsKICAgICAgICByZXN1bHQubGFzdEluZGV4ID0gdmFsdWVUb0Nsb25lLmxhc3RJbmRleDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBNYXApIHsKICAgICAgICBjb25zdCByZXN1bHQgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgdmFsdWVUb0Nsb25lKSB7CiAgICAgICAgICByZXN1bHQuc2V0KGtleSwgY2xvbmVEZWVwV2l0aEltcGwodmFsdWUsIGtleSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgU2V0KSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVUb0Nsb25lKSB7CiAgICAgICAgICByZXN1bHQuYWRkKGNsb25lRGVlcFdpdGhJbXBsKHZhbHVlLCB2b2lkIDAsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBCdWZmZXIgIT09ICJ1bmRlZmluZWQiICYmIEJ1ZmZlci5pc0J1ZmZlcih2YWx1ZVRvQ2xvbmUpKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlVG9DbG9uZS5zdWJhcnJheSgpOwogICAgICB9CiAgICAgIGlmIChpc1R5cGVkQXJyYXkuaXNUeXBlZEFycmF5KHZhbHVlVG9DbG9uZSkpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgKE9iamVjdC5nZXRQcm90b3R5cGVPZih2YWx1ZVRvQ2xvbmUpKS5jb25zdHJ1Y3Rvcih2YWx1ZVRvQ2xvbmUubGVuZ3RoKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWVUb0Nsb25lLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICByZXN1bHRbaV0gPSBjbG9uZURlZXBXaXRoSW1wbCh2YWx1ZVRvQ2xvbmVbaV0sIGksIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIgfHwgdHlwZW9mIFNoYXJlZEFycmF5QnVmZmVyICE9PSAidW5kZWZpbmVkIiAmJiB2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBTaGFyZWRBcnJheUJ1ZmZlcikgewogICAgICAgIHJldHVybiB2YWx1ZVRvQ2xvbmUuc2xpY2UoMCk7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIERhdGFWaWV3KSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IERhdGFWaWV3KHZhbHVlVG9DbG9uZS5idWZmZXIuc2xpY2UoMCksIHZhbHVlVG9DbG9uZS5ieXRlT2Zmc2V0LCB2YWx1ZVRvQ2xvbmUuYnl0ZUxlbmd0aCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBjb3B5UHJvcGVydGllcyhyZXN1bHQsIHZhbHVlVG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBGaWxlICE9PSAidW5kZWZpbmVkIiAmJiB2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBGaWxlKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IEZpbGUoW3ZhbHVlVG9DbG9uZV0sIHZhbHVlVG9DbG9uZS5uYW1lLCB7CiAgICAgICAgICB0eXBlOiB2YWx1ZVRvQ2xvbmUudHlwZQogICAgICAgIH0pOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgQmxvYiAhPT0gInVuZGVmaW5lZCIgJiYgdmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgQmxvYikgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBCbG9iKFt2YWx1ZVRvQ2xvbmVdLCB7IHR5cGU6IHZhbHVlVG9DbG9uZS50eXBlIH0pOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyB2YWx1ZVRvQ2xvbmUuY29uc3RydWN0b3IoKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC5tZXNzYWdlID0gdmFsdWVUb0Nsb25lLm1lc3NhZ2U7CiAgICAgICAgcmVzdWx0Lm5hbWUgPSB2YWx1ZVRvQ2xvbmUubmFtZTsKICAgICAgICByZXN1bHQuc3RhY2sgPSB2YWx1ZVRvQ2xvbmUuc3RhY2s7CiAgICAgICAgcmVzdWx0LmNhdXNlID0gdmFsdWVUb0Nsb25lLmNhdXNlOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgQm9vbGVhbikgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBCb29sZWFuKHZhbHVlVG9DbG9uZS52YWx1ZU9mKCkpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBOdW1iZXIpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgTnVtYmVyKHZhbHVlVG9DbG9uZS52YWx1ZU9mKCkpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBTdHJpbmcpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgU3RyaW5nKHZhbHVlVG9DbG9uZS52YWx1ZU9mKCkpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgdmFsdWVUb0Nsb25lID09PSAib2JqZWN0IiAmJiBpc0Nsb25lYWJsZU9iamVjdCh2YWx1ZVRvQ2xvbmUpKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gT2JqZWN0LmNyZWF0ZShPYmplY3QuZ2V0UHJvdG90eXBlT2YodmFsdWVUb0Nsb25lKSk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBjb3B5UHJvcGVydGllcyhyZXN1bHQsIHZhbHVlVG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlVG9DbG9uZTsKICAgIH0KICAgIGZ1bmN0aW9uIGNvcHlQcm9wZXJ0aWVzKHRhcmdldCwgc291cmNlLCBvYmplY3RUb0Nsb25lID0gdGFyZ2V0LCBzdGFjaywgY2xvbmVWYWx1ZSkgewogICAgICBjb25zdCBrZXlzID0gWy4uLk9iamVjdC5rZXlzKHNvdXJjZSksIC4uLmdldFN5bWJvbHMuZ2V0U3ltYm9scyhzb3VyY2UpXTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3Qga2V5ID0ga2V5c1tpXTsKICAgICAgICBjb25zdCBkZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSk7CiAgICAgICAgaWYgKGRlc2NyaXB0b3IgPT0gbnVsbCB8fCBkZXNjcmlwdG9yLndyaXRhYmxlKSB7CiAgICAgICAgICB0YXJnZXRba2V5XSA9IGNsb25lRGVlcFdpdGhJbXBsKHNvdXJjZVtrZXldLCBrZXksIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGlzQ2xvbmVhYmxlT2JqZWN0KG9iamVjdCkgewogICAgICBzd2l0Y2ggKGdldFRhZy5nZXRUYWcob2JqZWN0KSkgewogICAgICAgIGNhc2UgdGFncy5hcmd1bWVudHNUYWc6CiAgICAgICAgY2FzZSB0YWdzLmFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5hcnJheUJ1ZmZlclRhZzoKICAgICAgICBjYXNlIHRhZ3MuZGF0YVZpZXdUYWc6CiAgICAgICAgY2FzZSB0YWdzLmJvb2xlYW5UYWc6CiAgICAgICAgY2FzZSB0YWdzLmRhdGVUYWc6CiAgICAgICAgY2FzZSB0YWdzLmZsb2F0MzJBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MuZmxvYXQ2NEFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5pbnQ4QXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLmludDE2QXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLmludDMyQXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLm1hcFRhZzoKICAgICAgICBjYXNlIHRhZ3MubnVtYmVyVGFnOgogICAgICAgIGNhc2UgdGFncy5vYmplY3RUYWc6CiAgICAgICAgY2FzZSB0YWdzLnJlZ2V4cFRhZzoKICAgICAgICBjYXNlIHRhZ3Muc2V0VGFnOgogICAgICAgIGNhc2UgdGFncy5zdHJpbmdUYWc6CiAgICAgICAgY2FzZSB0YWdzLnN5bWJvbFRhZzoKICAgICAgICBjYXNlIHRhZ3MudWludDhBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MudWludDhDbGFtcGVkQXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLnVpbnQxNkFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy51aW50MzJBcnJheVRhZzogewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuY2xvbmVEZWVwV2l0aCA9IGNsb25lRGVlcFdpdGg7CiAgICBleHBvcnRzLmNsb25lRGVlcFdpdGhJbXBsID0gY2xvbmVEZWVwV2l0aEltcGw7CiAgICBleHBvcnRzLmNvcHlQcm9wZXJ0aWVzID0gY29weVByb3BlcnRpZXM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L29iamVjdC9jbG9uZURlZXAuanMKdmFyIHJlcXVpcmVfY2xvbmVEZWVwID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L29iamVjdC9jbG9uZURlZXAuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGNsb25lRGVlcFdpdGggPSByZXF1aXJlX2Nsb25lRGVlcFdpdGgoKTsKICAgIGZ1bmN0aW9uIGNsb25lRGVlcChvYmopIHsKICAgICAgcmV0dXJuIGNsb25lRGVlcFdpdGguY2xvbmVEZWVwV2l0aEltcGwob2JqLCB2b2lkIDAsIG9iaiwgLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSwgdm9pZCAwKTsKICAgIH0KICAgIGV4cG9ydHMuY2xvbmVEZWVwID0gY2xvbmVEZWVwOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXMuanMKdmFyIHJlcXVpcmVfbWF0Y2hlcyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXMuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzTWF0Y2ggPSByZXF1aXJlX2lzTWF0Y2goKTsKICAgIHZhciBjbG9uZURlZXAgPSByZXF1aXJlX2Nsb25lRGVlcCgpOwogICAgZnVuY3Rpb24gbWF0Y2hlczIoc291cmNlKSB7CiAgICAgIHNvdXJjZSA9IGNsb25lRGVlcC5jbG9uZURlZXAoc291cmNlKTsKICAgICAgcmV0dXJuICh0YXJnZXQpID0+IHsKICAgICAgICByZXR1cm4gaXNNYXRjaC5pc01hdGNoKHRhcmdldCwgc291cmNlKTsKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMubWF0Y2hlcyA9IG1hdGNoZXMyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L2Nsb25lRGVlcFdpdGguanMKdmFyIHJlcXVpcmVfY2xvbmVEZWVwV2l0aDIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9jbG9uZURlZXBXaXRoLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBjbG9uZURlZXBXaXRoJDEgPSByZXF1aXJlX2Nsb25lRGVlcFdpdGgoKTsKICAgIHZhciB0YWdzID0gcmVxdWlyZV90YWdzKCk7CiAgICBmdW5jdGlvbiBjbG9uZURlZXBXaXRoKG9iaiwgY3VzdG9taXplcikgewogICAgICByZXR1cm4gY2xvbmVEZWVwV2l0aCQxLmNsb25lRGVlcFdpdGgob2JqLCAodmFsdWUsIGtleSwgb2JqZWN0LCBzdGFjaykgPT4gewogICAgICAgIGNvbnN0IGNsb25lZCA9IGN1c3RvbWl6ZXI/Lih2YWx1ZSwga2V5LCBvYmplY3QsIHN0YWNrKTsKICAgICAgICBpZiAoY2xvbmVkICE9PSB2b2lkIDApIHsKICAgICAgICAgIHJldHVybiBjbG9uZWQ7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2Ygb2JqICE9PSAib2JqZWN0IikgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgc3dpdGNoIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSkgewogICAgICAgICAgY2FzZSB0YWdzLm51bWJlclRhZzoKICAgICAgICAgIGNhc2UgdGFncy5zdHJpbmdUYWc6CiAgICAgICAgICBjYXNlIHRhZ3MuYm9vbGVhblRhZzogewogICAgICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgb2JqLmNvbnN0cnVjdG9yKG9iaj8udmFsdWVPZigpKTsKICAgICAgICAgICAgY2xvbmVEZWVwV2l0aCQxLmNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgb2JqKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgdGFncy5hcmd1bWVudHNUYWc6IHsKICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0ge307CiAgICAgICAgICAgIGNsb25lRGVlcFdpdGgkMS5jb3B5UHJvcGVydGllcyhyZXN1bHQsIG9iaik7CiAgICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBvYmoubGVuZ3RoOwogICAgICAgICAgICByZXN1bHRbU3ltYm9sLml0ZXJhdG9yXSA9IG9ialtTeW1ib2wuaXRlcmF0b3JdOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgfQogICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLmNsb25lRGVlcFdpdGggPSBjbG9uZURlZXBXaXRoOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L2Nsb25lRGVlcC5qcwp2YXIgcmVxdWlyZV9jbG9uZURlZXAyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvY2xvbmVEZWVwLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBjbG9uZURlZXBXaXRoID0gcmVxdWlyZV9jbG9uZURlZXBXaXRoMigpOwogICAgZnVuY3Rpb24gY2xvbmVEZWVwKG9iaikgewogICAgICByZXR1cm4gY2xvbmVEZWVwV2l0aC5jbG9uZURlZXBXaXRoKG9iaik7CiAgICB9CiAgICBleHBvcnRzLmNsb25lRGVlcCA9IGNsb25lRGVlcDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0luZGV4LmpzCnZhciByZXF1aXJlX2lzSW5kZXggPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0luZGV4LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBJU19VTlNJR05FRF9JTlRFR0VSID0gL14oPzowfFsxLTldXGQqKSQvOwogICAgZnVuY3Rpb24gaXNJbmRleCh2YWx1ZSwgbGVuZ3RoID0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIpIHsKICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICBjYXNlICJudW1iZXIiOiB7CiAgICAgICAgICByZXR1cm4gTnVtYmVyLmlzSW50ZWdlcih2YWx1ZSkgJiYgdmFsdWUgPj0gMCAmJiB2YWx1ZSA8IGxlbmd0aDsKICAgICAgICB9CiAgICAgICAgY2FzZSAic3ltYm9sIjogewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBjYXNlICJzdHJpbmciOiB7CiAgICAgICAgICByZXR1cm4gSVNfVU5TSUdORURfSU5URUdFUi50ZXN0KHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaXNJbmRleCA9IGlzSW5kZXg7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNBcmd1bWVudHMuanMKdmFyIHJlcXVpcmVfaXNBcmd1bWVudHMgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FyZ3VtZW50cy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgZ2V0VGFnID0gcmVxdWlyZV9nZXRUYWcoKTsKICAgIGZ1bmN0aW9uIGlzQXJndW1lbnRzKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIGdldFRhZy5nZXRUYWcodmFsdWUpID09PSAiW29iamVjdCBBcmd1bWVudHNdIjsKICAgIH0KICAgIGV4cG9ydHMuaXNBcmd1bWVudHMgPSBpc0FyZ3VtZW50czsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9oYXMuanMKdmFyIHJlcXVpcmVfaGFzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvaGFzLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc0RlZXBLZXkgPSByZXF1aXJlX2lzRGVlcEtleSgpOwogICAgdmFyIGlzSW5kZXggPSByZXF1aXJlX2lzSW5kZXgoKTsKICAgIHZhciBpc0FyZ3VtZW50cyA9IHJlcXVpcmVfaXNBcmd1bWVudHMoKTsKICAgIHZhciB0b1BhdGggPSByZXF1aXJlX3RvUGF0aCgpOwogICAgZnVuY3Rpb24gaGFzMyhvYmplY3QsIHBhdGgyKSB7CiAgICAgIGxldCByZXNvbHZlZFBhdGg7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHBhdGgyKSkgewogICAgICAgIHJlc29sdmVkUGF0aCA9IHBhdGgyOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBwYXRoMiA9PT0gInN0cmluZyIgJiYgaXNEZWVwS2V5LmlzRGVlcEtleShwYXRoMikgJiYgb2JqZWN0Py5bcGF0aDJdID09IG51bGwpIHsKICAgICAgICByZXNvbHZlZFBhdGggPSB0b1BhdGgudG9QYXRoKHBhdGgyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXNvbHZlZFBhdGggPSBbcGF0aDJdOwogICAgICB9CiAgICAgIGlmIChyZXNvbHZlZFBhdGgubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGxldCBjdXJyZW50MyA9IG9iamVjdDsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXNvbHZlZFBhdGgubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBrZXkgPSByZXNvbHZlZFBhdGhbaV07CiAgICAgICAgaWYgKGN1cnJlbnQzID09IG51bGwgfHwgIU9iamVjdC5oYXNPd24oY3VycmVudDMsIGtleSkpIHsKICAgICAgICAgIGNvbnN0IGlzU3BhcnNlSW5kZXggPSAoQXJyYXkuaXNBcnJheShjdXJyZW50MykgfHwgaXNBcmd1bWVudHMuaXNBcmd1bWVudHMoY3VycmVudDMpKSAmJiBpc0luZGV4LmlzSW5kZXgoa2V5KSAmJiBrZXkgPCBjdXJyZW50My5sZW5ndGg7CiAgICAgICAgICBpZiAoIWlzU3BhcnNlSW5kZXgpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjdXJyZW50MyA9IGN1cnJlbnQzW2tleV07CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBleHBvcnRzLmhhcyA9IGhhczM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvbWF0Y2hlc1Byb3BlcnR5LmpzCnZhciByZXF1aXJlX21hdGNoZXNQcm9wZXJ0eSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXNQcm9wZXJ0eS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNNYXRjaCA9IHJlcXVpcmVfaXNNYXRjaCgpOwogICAgdmFyIHRvS2V5ID0gcmVxdWlyZV90b0tleSgpOwogICAgdmFyIGNsb25lRGVlcCA9IHJlcXVpcmVfY2xvbmVEZWVwMigpOwogICAgdmFyIGdldDYgPSByZXF1aXJlX2dldCgpOwogICAgdmFyIGhhczMgPSByZXF1aXJlX2hhcygpOwogICAgZnVuY3Rpb24gbWF0Y2hlc1Byb3BlcnR5KHByb3BlcnR5LCBzb3VyY2UpIHsKICAgICAgc3dpdGNoICh0eXBlb2YgcHJvcGVydHkpIHsKICAgICAgICBjYXNlICJvYmplY3QiOiB7CiAgICAgICAgICBpZiAoT2JqZWN0LmlzKHByb3BlcnR5Py52YWx1ZU9mKCksIC0wKSkgewogICAgICAgICAgICBwcm9wZXJ0eSA9ICItMCI7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgY2FzZSAibnVtYmVyIjogewogICAgICAgICAgcHJvcGVydHkgPSB0b0tleS50b0tleShwcm9wZXJ0eSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgc291cmNlID0gY2xvbmVEZWVwLmNsb25lRGVlcChzb3VyY2UpOwogICAgICByZXR1cm4gZnVuY3Rpb24odGFyZ2V0KSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gZ2V0Ni5nZXQodGFyZ2V0LCBwcm9wZXJ0eSk7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICByZXR1cm4gaGFzMy5oYXModGFyZ2V0LCBwcm9wZXJ0eSk7CiAgICAgICAgfQogICAgICAgIGlmIChzb3VyY2UgPT09IHZvaWQgMCkgewogICAgICAgICAgcmV0dXJuIHJlc3VsdCA9PT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaXNNYXRjaC5pc01hdGNoKHJlc3VsdCwgc291cmNlKTsKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMubWF0Y2hlc1Byb3BlcnR5ID0gbWF0Y2hlc1Byb3BlcnR5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC9pdGVyYXRlZS5qcwp2YXIgcmVxdWlyZV9pdGVyYXRlZSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC9pdGVyYXRlZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaWRlbnRpdHk0ID0gcmVxdWlyZV9pZGVudGl0eSgpOwogICAgdmFyIHByb3BlcnR5ID0gcmVxdWlyZV9wcm9wZXJ0eSgpOwogICAgdmFyIG1hdGNoZXMyID0gcmVxdWlyZV9tYXRjaGVzKCk7CiAgICB2YXIgbWF0Y2hlc1Byb3BlcnR5ID0gcmVxdWlyZV9tYXRjaGVzUHJvcGVydHkoKTsKICAgIGZ1bmN0aW9uIGl0ZXJhdGVlKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGlkZW50aXR5NC5pZGVudGl0eTsKICAgICAgfQogICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgIGNhc2UgImZ1bmN0aW9uIjogewogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBjYXNlICJvYmplY3QiOiB7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICAgIHJldHVybiBtYXRjaGVzUHJvcGVydHkubWF0Y2hlc1Byb3BlcnR5KHZhbHVlWzBdLCB2YWx1ZVsxXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2hlczIubWF0Y2hlcyh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgY2FzZSAic3ltYm9sIjoKICAgICAgICBjYXNlICJudW1iZXIiOiB7CiAgICAgICAgICByZXR1cm4gcHJvcGVydHkucHJvcGVydHkodmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZXhwb3J0cy5pdGVyYXRlZSA9IGl0ZXJhdGVlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvdW5pcUJ5LmpzCnZhciByZXF1aXJlX3VuaXFCeTIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L3VuaXFCeS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgdW5pcUJ5JDEgPSByZXF1aXJlX3VuaXFCeSgpOwogICAgdmFyIGlkZW50aXR5NCA9IHJlcXVpcmVfaWRlbnRpdHkoKTsKICAgIHZhciBpc0FycmF5TGlrZU9iamVjdCA9IHJlcXVpcmVfaXNBcnJheUxpa2VPYmplY3QoKTsKICAgIHZhciBpdGVyYXRlZSA9IHJlcXVpcmVfaXRlcmF0ZWUoKTsKICAgIGZ1bmN0aW9uIHVuaXFCeTIoYXJyYXksIGl0ZXJhdGVlJDEgPSBpZGVudGl0eTQuaWRlbnRpdHkpIHsKICAgICAgaWYgKCFpc0FycmF5TGlrZU9iamVjdC5pc0FycmF5TGlrZU9iamVjdChhcnJheSkpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgcmV0dXJuIHVuaXFCeSQxLnVuaXFCeShBcnJheS5mcm9tKGFycmF5KSwgaXRlcmF0ZWUuaXRlcmF0ZWUoaXRlcmF0ZWUkMSkpOwogICAgfQogICAgZXhwb3J0cy51bmlxQnkgPSB1bmlxQnkyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3VuaXFCeS5qcwp2YXIgcmVxdWlyZV91bmlxQnkzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvdW5pcUJ5LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV91bmlxQnkyKCkudW5pcUJ5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmVAMS42LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV91c2Vfc3luY19leHRlcm5hbF9zdG9yZV9zaGltX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS91c2Utc3luYy1leHRlcm5hbC1zdG9yZUAxLjYuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICAoZnVuY3Rpb24oKSB7CiAgICAgIGZ1bmN0aW9uIGlzNCh4MiwgeTIpIHsKICAgICAgICByZXR1cm4geDIgPT09IHkyICYmICgwICE9PSB4MiB8fCAxIC8geDIgPT09IDEgLyB5MikgfHwgeDIgIT09IHgyICYmIHkyICE9PSB5MjsKICAgICAgfQogICAgICBmdW5jdGlvbiB1c2VTeW5jRXh0ZXJuYWxTdG9yZSQyKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpIHsKICAgICAgICBkaWRXYXJuT2xkMThBbHBoYSB8fCB2b2lkIDAgPT09IFJlYWN0Mzkuc3RhcnRUcmFuc2l0aW9uIHx8IChkaWRXYXJuT2xkMThBbHBoYSA9IHRydWUsIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAiWW91IGFyZSB1c2luZyBhbiBvdXRkYXRlZCwgcHJlLXJlbGVhc2UgYWxwaGEgb2YgUmVhY3QgMTggdGhhdCBkb2VzIG5vdCBzdXBwb3J0IHVzZVN5bmNFeHRlcm5hbFN0b3JlLiBUaGUgdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUgc2hpbSB3aWxsIG5vdCB3b3JrIGNvcnJlY3RseS4gVXBncmFkZSB0byBhIG5ld2VyIHByZS1yZWxlYXNlLiIKICAgICAgICApKTsKICAgICAgICB2YXIgdmFsdWUgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgIHZhciBjYWNoZWRWYWx1ZSA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICBvYmplY3RJcyh2YWx1ZSwgY2FjaGVkVmFsdWUpIHx8IChjb25zb2xlLmVycm9yKAogICAgICAgICAgICAiVGhlIHJlc3VsdCBvZiBnZXRTbmFwc2hvdCBzaG91bGQgYmUgY2FjaGVkIHRvIGF2b2lkIGFuIGluZmluaXRlIGxvb3AiCiAgICAgICAgICApLCBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IHRydWUpOwogICAgICAgIH0KICAgICAgICBjYWNoZWRWYWx1ZSA9IHVzZVN0YXRlMTMoewogICAgICAgICAgaW5zdDogeyB2YWx1ZSwgZ2V0U25hcHNob3QgfQogICAgICAgIH0pOwogICAgICAgIHZhciBpbnN0ID0gY2FjaGVkVmFsdWVbMF0uaW5zdCwgZm9yY2VVcGRhdGUgPSBjYWNoZWRWYWx1ZVsxXTsKICAgICAgICB1c2VMYXlvdXRFZmZlY3Q5KAogICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGluc3QudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgaW5zdC5nZXRTbmFwc2hvdCA9IGdldFNuYXBzaG90OwogICAgICAgICAgICBjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpICYmIGZvcmNlVXBkYXRlKHsgaW5zdCB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBbc3Vic2NyaWJlLCB2YWx1ZSwgZ2V0U25hcHNob3RdCiAgICAgICAgKTsKICAgICAgICB1c2VFZmZlY3QxNCgKICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpICYmIGZvcmNlVXBkYXRlKHsgaW5zdCB9KTsKICAgICAgICAgICAgcmV0dXJuIHN1YnNjcmliZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpICYmIGZvcmNlVXBkYXRlKHsgaW5zdCB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgW3N1YnNjcmliZV0KICAgICAgICApOwogICAgICAgIHVzZURlYnVnVmFsdWUyKHZhbHVlKTsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSB7CiAgICAgICAgdmFyIGxhdGVzdEdldFNuYXBzaG90ID0gaW5zdC5nZXRTbmFwc2hvdDsKICAgICAgICBpbnN0ID0gaW5zdC52YWx1ZTsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IGxhdGVzdEdldFNuYXBzaG90KCk7CiAgICAgICAgICByZXR1cm4gIW9iamVjdElzKGluc3QsIG5leHRWYWx1ZSk7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiB1c2VTeW5jRXh0ZXJuYWxTdG9yZSQxKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpIHsKICAgICAgICByZXR1cm4gZ2V0U25hcHNob3QoKTsKICAgICAgfQogICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCAmJiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0KEVycm9yKCkpOwogICAgICB2YXIgUmVhY3QzOSA9IHJlcXVpcmVfcmVhY3QoKSwgb2JqZWN0SXMgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgT2JqZWN0LmlzID8gT2JqZWN0LmlzIDogaXM0LCB1c2VTdGF0ZTEzID0gUmVhY3QzOS51c2VTdGF0ZSwgdXNlRWZmZWN0MTQgPSBSZWFjdDM5LnVzZUVmZmVjdCwgdXNlTGF5b3V0RWZmZWN0OSA9IFJlYWN0MzkudXNlTGF5b3V0RWZmZWN0LCB1c2VEZWJ1Z1ZhbHVlMiA9IFJlYWN0MzkudXNlRGVidWdWYWx1ZSwgZGlkV2Fybk9sZDE4QWxwaGEgPSBmYWxzZSwgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QgPSBmYWxzZSwgc2hpbSA9ICJ1bmRlZmluZWQiID09PSB0eXBlb2Ygd2luZG93IHx8ICJ1bmRlZmluZWQiID09PSB0eXBlb2Ygd2luZG93LmRvY3VtZW50IHx8ICJ1bmRlZmluZWQiID09PSB0eXBlb2Ygd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgPyB1c2VTeW5jRXh0ZXJuYWxTdG9yZSQxIDogdXNlU3luY0V4dGVybmFsU3RvcmUkMjsKICAgICAgZXhwb3J0cy51c2VTeW5jRXh0ZXJuYWxTdG9yZSA9IHZvaWQgMCAhPT0gUmVhY3QzOS51c2VTeW5jRXh0ZXJuYWxTdG9yZSA/IFJlYWN0MzkudXNlU3luY0V4dGVybmFsU3RvcmUgOiBzaGltOwogICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChFcnJvcigpKTsKICAgIH0pKCk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS91c2Utc3luYy1leHRlcm5hbC1zdG9yZUAxLjYuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3NoaW0vaW5kZXguanMKdmFyIHJlcXVpcmVfc2hpbSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmVAMS42LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9zaGltL2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfdXNlX3N5bmNfZXh0ZXJuYWxfc3RvcmVfc2hpbV9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmVAMS42LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS93aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3dpdGhfc2VsZWN0b3JfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlQDEuNi4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0vd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgKGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiBpczQoeDIsIHkyKSB7CiAgICAgICAgcmV0dXJuIHgyID09PSB5MiAmJiAoMCAhPT0geDIgfHwgMSAvIHgyID09PSAxIC8geTIpIHx8IHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgICAgIH0KICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgJiYgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChFcnJvcigpKTsKICAgICAgdmFyIFJlYWN0MzkgPSByZXF1aXJlX3JlYWN0KCksIHNoaW0gPSByZXF1aXJlX3NoaW0oKSwgb2JqZWN0SXMgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgT2JqZWN0LmlzID8gT2JqZWN0LmlzIDogaXM0LCB1c2VTeW5jRXh0ZXJuYWxTdG9yZTIgPSBzaGltLnVzZVN5bmNFeHRlcm5hbFN0b3JlLCB1c2VSZWYxNiA9IFJlYWN0MzkudXNlUmVmLCB1c2VFZmZlY3QxNCA9IFJlYWN0MzkudXNlRWZmZWN0LCB1c2VNZW1vOSA9IFJlYWN0MzkudXNlTWVtbywgdXNlRGVidWdWYWx1ZTIgPSBSZWFjdDM5LnVzZURlYnVnVmFsdWU7CiAgICAgIGV4cG9ydHMudXNlU3luY0V4dGVybmFsU3RvcmVXaXRoU2VsZWN0b3IgPSBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCwgc2VsZWN0b3IsIGlzRXF1YWwpIHsKICAgICAgICB2YXIgaW5zdFJlZiA9IHVzZVJlZjE2KG51bGwpOwogICAgICAgIGlmIChudWxsID09PSBpbnN0UmVmLmN1cnJlbnQpIHsKICAgICAgICAgIHZhciBpbnN0ID0geyBoYXNWYWx1ZTogZmFsc2UsIHZhbHVlOiBudWxsIH07CiAgICAgICAgICBpbnN0UmVmLmN1cnJlbnQgPSBpbnN0OwogICAgICAgIH0gZWxzZSBpbnN0ID0gaW5zdFJlZi5jdXJyZW50OwogICAgICAgIGluc3RSZWYgPSB1c2VNZW1vOSgKICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmdW5jdGlvbiBtZW1vaXplZFNlbGVjdG9yKG5leHRTbmFwc2hvdCkgewogICAgICAgICAgICAgIGlmICghaGFzTWVtbykgewogICAgICAgICAgICAgICAgaGFzTWVtbyA9IHRydWU7CiAgICAgICAgICAgICAgICBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICAgICAgbmV4dFNuYXBzaG90ID0gc2VsZWN0b3IobmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IGlzRXF1YWwgJiYgaW5zdC5oYXNWYWx1ZSkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFNlbGVjdGlvbiA9IGluc3QudmFsdWU7CiAgICAgICAgICAgICAgICAgIGlmIChpc0VxdWFsKGN1cnJlbnRTZWxlY3Rpb24sIG5leHRTbmFwc2hvdCkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0aW9uID0gY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudFNlbGVjdGlvbiA9IG1lbW9pemVkU2VsZWN0aW9uOwogICAgICAgICAgICAgIGlmIChvYmplY3RJcyhtZW1vaXplZFNuYXBzaG90LCBuZXh0U25hcHNob3QpKQogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgICAgdmFyIG5leHRTZWxlY3Rpb24gPSBzZWxlY3RvcihuZXh0U25hcHNob3QpOwogICAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IGlzRXF1YWwgJiYgaXNFcXVhbChjdXJyZW50U2VsZWN0aW9uLCBuZXh0U2VsZWN0aW9uKSkKICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90LCBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICAgIG1lbW9pemVkU25hcHNob3QgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0aW9uID0gbmV4dFNlbGVjdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzTWVtbyA9IGZhbHNlLCBtZW1vaXplZFNuYXBzaG90LCBtZW1vaXplZFNlbGVjdGlvbiwgbWF5YmVHZXRTZXJ2ZXJTbmFwc2hvdCA9IHZvaWQgMCA9PT0gZ2V0U2VydmVyU25hcHNob3QgPyBudWxsIDogZ2V0U2VydmVyU25hcHNob3Q7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3RvcihnZXRTbmFwc2hvdCgpKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG51bGwgPT09IG1heWJlR2V0U2VydmVyU25hcHNob3QgPyB2b2lkIDAgOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdG9yKG1heWJlR2V0U2VydmVyU25hcHNob3QoKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBdOwogICAgICAgICAgfSwKICAgICAgICAgIFtnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QsIHNlbGVjdG9yLCBpc0VxdWFsXQogICAgICAgICk7CiAgICAgICAgdmFyIHZhbHVlID0gdXNlU3luY0V4dGVybmFsU3RvcmUyKHN1YnNjcmliZSwgaW5zdFJlZlswXSwgaW5zdFJlZlsxXSk7CiAgICAgICAgdXNlRWZmZWN0MTQoCiAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5zdC5oYXNWYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGluc3QudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgIH0sCiAgICAgICAgICBbdmFsdWVdCiAgICAgICAgKTsKICAgICAgICB1c2VEZWJ1Z1ZhbHVlMih2YWx1ZSk7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9OwogICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChFcnJvcigpKTsKICAgIH0pKCk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS91c2Utc3luYy1leHRlcm5hbC1zdG9yZUAxLjYuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3NoaW0vd2l0aC1zZWxlY3Rvci5qcwp2YXIgcmVxdWlyZV93aXRoX3NlbGVjdG9yID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS91c2Utc3luYy1leHRlcm5hbC1zdG9yZUAxLjYuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3NoaW0vd2l0aC1zZWxlY3Rvci5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3dpdGhfc2VsZWN0b3JfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9jb21wYXJlVmFsdWVzLmpzCnZhciByZXF1aXJlX2NvbXBhcmVWYWx1ZXMgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9jb21wYXJlVmFsdWVzLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGdldFByaW9yaXR5KGEpIHsKICAgICAgaWYgKHR5cGVvZiBhID09PSAic3ltYm9sIikgewogICAgICAgIHJldHVybiAxOwogICAgICB9CiAgICAgIGlmIChhID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIDI7CiAgICAgIH0KICAgICAgaWYgKGEgPT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiAzOwogICAgICB9CiAgICAgIGlmIChhICE9PSBhKSB7CiAgICAgICAgcmV0dXJuIDQ7CiAgICAgIH0KICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICB2YXIgY29tcGFyZVZhbHVlcyA9IChhLCBiLCBvcmRlcikgPT4gewogICAgICBpZiAoYSAhPT0gYikgewogICAgICAgIGNvbnN0IGFQcmlvcml0eSA9IGdldFByaW9yaXR5KGEpOwogICAgICAgIGNvbnN0IGJQcmlvcml0eSA9IGdldFByaW9yaXR5KGIpOwogICAgICAgIGlmIChhUHJpb3JpdHkgPT09IGJQcmlvcml0eSAmJiBhUHJpb3JpdHkgPT09IDApIHsKICAgICAgICAgIGlmIChhIDwgYikgewogICAgICAgICAgICByZXR1cm4gb3JkZXIgPT09ICJkZXNjIiA/IDEgOiAtMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhID4gYikgewogICAgICAgICAgICByZXR1cm4gb3JkZXIgPT09ICJkZXNjIiA/IC0xIDogMTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9yZGVyID09PSAiZGVzYyIgPyBiUHJpb3JpdHkgLSBhUHJpb3JpdHkgOiBhUHJpb3JpdHkgLSBiUHJpb3JpdHk7CiAgICAgIH0KICAgICAgcmV0dXJuIDA7CiAgICB9OwogICAgZXhwb3J0cy5jb21wYXJlVmFsdWVzID0gY29tcGFyZVZhbHVlczsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc1N5bWJvbC5qcwp2YXIgcmVxdWlyZV9pc1N5bWJvbCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzU3ltYm9sLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzU3ltYm9sKHZhbHVlKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICJzeW1ib2wiIHx8IHZhbHVlIGluc3RhbmNlb2YgU3ltYm9sOwogICAgfQogICAgZXhwb3J0cy5pc1N5bWJvbCA9IGlzU3ltYm9sOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzS2V5LmpzCnZhciByZXF1aXJlX2lzS2V5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNLZXkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzU3ltYm9sID0gcmVxdWlyZV9pc1N5bWJvbCgpOwogICAgdmFyIHJlZ2V4SXNEZWVwUHJvcCA9IC9cLnxcWyg/OlteW1xdXSp8KFsiJ10pKD86KD8hXDEpW15cXF18XFwuKSo/XDEpXF0vOwogICAgdmFyIHJlZ2V4SXNQbGFpblByb3AgPSAvXlx3KiQvOwogICAgZnVuY3Rpb24gaXNLZXkodmFsdWUsIG9iamVjdCkgewogICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgfHwgdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgfHwgdmFsdWUgPT0gbnVsbCB8fCBpc1N5bWJvbC5pc1N5bWJvbCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiAocmVnZXhJc1BsYWluUHJvcC50ZXN0KHZhbHVlKSB8fCAhcmVnZXhJc0RlZXBQcm9wLnRlc3QodmFsdWUpKSB8fCBvYmplY3QgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duKG9iamVjdCwgdmFsdWUpOwogICAgfQogICAgZXhwb3J0cy5pc0tleSA9IGlzS2V5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvb3JkZXJCeS5qcwp2YXIgcmVxdWlyZV9vcmRlckJ5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9vcmRlckJ5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBjb21wYXJlVmFsdWVzID0gcmVxdWlyZV9jb21wYXJlVmFsdWVzKCk7CiAgICB2YXIgaXNLZXkgPSByZXF1aXJlX2lzS2V5KCk7CiAgICB2YXIgdG9QYXRoID0gcmVxdWlyZV90b1BhdGgoKTsKICAgIGZ1bmN0aW9uIG9yZGVyQnkoY29sbGVjdGlvbiwgY3JpdGVyaWEsIG9yZGVycywgZ3VhcmQpIHsKICAgICAgaWYgKGNvbGxlY3Rpb24gPT0gbnVsbCkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgICBvcmRlcnMgPSBndWFyZCA/IHZvaWQgMCA6IG9yZGVyczsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgICAgY29sbGVjdGlvbiA9IE9iamVjdC52YWx1ZXMoY29sbGVjdGlvbik7CiAgICAgIH0KICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGNyaXRlcmlhKSkgewogICAgICAgIGNyaXRlcmlhID0gY3JpdGVyaWEgPT0gbnVsbCA/IFtudWxsXSA6IFtjcml0ZXJpYV07CiAgICAgIH0KICAgICAgaWYgKGNyaXRlcmlhLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGNyaXRlcmlhID0gW251bGxdOwogICAgICB9CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShvcmRlcnMpKSB7CiAgICAgICAgb3JkZXJzID0gb3JkZXJzID09IG51bGwgPyBbXSA6IFtvcmRlcnNdOwogICAgICB9CiAgICAgIG9yZGVycyA9IG9yZGVycy5tYXAoKG9yZGVyKSA9PiBTdHJpbmcob3JkZXIpKTsKICAgICAgY29uc3QgZ2V0VmFsdWVCeU5lc3RlZFBhdGggPSAob2JqZWN0LCBwYXRoMikgPT4gewogICAgICAgIGxldCB0YXJnZXQgPSBvYmplY3Q7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXRoMi5sZW5ndGggJiYgdGFyZ2V0ICE9IG51bGw7ICsraSkgewogICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0W3BhdGgyW2ldXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgfTsKICAgICAgY29uc3QgZ2V0VmFsdWVCeUNyaXRlcmlvbiA9IChjcml0ZXJpb24sIG9iamVjdCkgPT4gewogICAgICAgIGlmIChvYmplY3QgPT0gbnVsbCB8fCBjcml0ZXJpb24gPT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBjcml0ZXJpb24gPT09ICJvYmplY3QiICYmICJrZXkiIGluIGNyaXRlcmlvbikgewogICAgICAgICAgaWYgKE9iamVjdC5oYXNPd24ob2JqZWN0LCBjcml0ZXJpb24ua2V5KSkgewogICAgICAgICAgICByZXR1cm4gb2JqZWN0W2NyaXRlcmlvbi5rZXldOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldFZhbHVlQnlOZXN0ZWRQYXRoKG9iamVjdCwgY3JpdGVyaW9uLnBhdGgpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGNyaXRlcmlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgcmV0dXJuIGNyaXRlcmlvbihvYmplY3QpOwogICAgICAgIH0KICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjcml0ZXJpb24pKSB7CiAgICAgICAgICByZXR1cm4gZ2V0VmFsdWVCeU5lc3RlZFBhdGgob2JqZWN0LCBjcml0ZXJpb24pOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIG9iamVjdCA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgIHJldHVybiBvYmplY3RbY3JpdGVyaW9uXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgfTsKICAgICAgY29uc3QgcHJlcGFyZWRDcml0ZXJpYSA9IGNyaXRlcmlhLm1hcCgoY3JpdGVyaW9uKSA9PiB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY3JpdGVyaW9uKSAmJiBjcml0ZXJpb24ubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICBjcml0ZXJpb24gPSBjcml0ZXJpb25bMF07CiAgICAgICAgfQogICAgICAgIGlmIChjcml0ZXJpb24gPT0gbnVsbCB8fCB0eXBlb2YgY3JpdGVyaW9uID09PSAiZnVuY3Rpb24iIHx8IEFycmF5LmlzQXJyYXkoY3JpdGVyaW9uKSB8fCBpc0tleS5pc0tleShjcml0ZXJpb24pKSB7CiAgICAgICAgICByZXR1cm4gY3JpdGVyaW9uOwogICAgICAgIH0KICAgICAgICByZXR1cm4geyBrZXk6IGNyaXRlcmlvbiwgcGF0aDogdG9QYXRoLnRvUGF0aChjcml0ZXJpb24pIH07CiAgICAgIH0pOwogICAgICBjb25zdCBwcmVwYXJlZENvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLm1hcCgoaXRlbSkgPT4gKHsKICAgICAgICBvcmlnaW5hbDogaXRlbSwKICAgICAgICBjcml0ZXJpYTogcHJlcGFyZWRDcml0ZXJpYS5tYXAoKGNyaXRlcmlvbikgPT4gZ2V0VmFsdWVCeUNyaXRlcmlvbihjcml0ZXJpb24sIGl0ZW0pKQogICAgICB9KSk7CiAgICAgIHJldHVybiBwcmVwYXJlZENvbGxlY3Rpb24uc2xpY2UoKS5zb3J0KChhLCBiKSA9PiB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcmVwYXJlZENyaXRlcmlhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBjb21wYXJlZFJlc3VsdCA9IGNvbXBhcmVWYWx1ZXMuY29tcGFyZVZhbHVlcyhhLmNyaXRlcmlhW2ldLCBiLmNyaXRlcmlhW2ldLCBvcmRlcnNbaV0pOwogICAgICAgICAgaWYgKGNvbXBhcmVkUmVzdWx0ICE9PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBjb21wYXJlZFJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0pLm1hcCgoaXRlbSkgPT4gaXRlbS5vcmlnaW5hbCk7CiAgICB9CiAgICBleHBvcnRzLm9yZGVyQnkgPSBvcmRlckJ5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9hcnJheS9mbGF0dGVuLmpzCnZhciByZXF1aXJlX2ZsYXR0ZW4gPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvYXJyYXkvZmxhdHRlbi5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBmbGF0dGVuKGFyciwgZGVwdGggPSAxKSB7CiAgICAgIGNvbnN0IHJlc3VsdCA9IFtdOwogICAgICBjb25zdCBmbG9vcmVkRGVwdGggPSBNYXRoLmZsb29yKGRlcHRoKTsKICAgICAgY29uc3QgcmVjdXJzaXZlID0gKGFycjIsIGN1cnJlbnREZXB0aCkgPT4gewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyMi5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgaXRlbSA9IGFycjJbaV07CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShpdGVtKSAmJiBjdXJyZW50RGVwdGggPCBmbG9vcmVkRGVwdGgpIHsKICAgICAgICAgICAgcmVjdXJzaXZlKGl0ZW0sIGN1cnJlbnREZXB0aCArIDEpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdWx0LnB1c2goaXRlbSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgICByZWN1cnNpdmUoYXJyLCAwKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGV4cG9ydHMuZmxhdHRlbiA9IGZsYXR0ZW47CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNJdGVyYXRlZUNhbGwuanMKdmFyIHJlcXVpcmVfaXNJdGVyYXRlZUNhbGwgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0l0ZXJhdGVlQ2FsbC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNJbmRleCA9IHJlcXVpcmVfaXNJbmRleCgpOwogICAgdmFyIGlzQXJyYXlMaWtlID0gcmVxdWlyZV9pc0FycmF5TGlrZSgpOwogICAgdmFyIGlzT2JqZWN0ID0gcmVxdWlyZV9pc09iamVjdCgpOwogICAgdmFyIGVxID0gcmVxdWlyZV9lcSgpOwogICAgZnVuY3Rpb24gaXNJdGVyYXRlZUNhbGwodmFsdWUsIGluZGV4LCBvYmplY3QpIHsKICAgICAgaWYgKCFpc09iamVjdC5pc09iamVjdChvYmplY3QpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgaW5kZXggPT09ICJudW1iZXIiICYmIGlzQXJyYXlMaWtlLmlzQXJyYXlMaWtlKG9iamVjdCkgJiYgaXNJbmRleC5pc0luZGV4KGluZGV4KSAmJiBpbmRleCA8IG9iamVjdC5sZW5ndGggfHwgdHlwZW9mIGluZGV4ID09PSAic3RyaW5nIiAmJiBpbmRleCBpbiBvYmplY3QpIHsKICAgICAgICByZXR1cm4gZXEuZXEob2JqZWN0W2luZGV4XSwgdmFsdWUpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGV4cG9ydHMuaXNJdGVyYXRlZUNhbGwgPSBpc0l0ZXJhdGVlQ2FsbDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L3NvcnRCeS5qcwp2YXIgcmVxdWlyZV9zb3J0QnkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L3NvcnRCeS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgb3JkZXJCeSA9IHJlcXVpcmVfb3JkZXJCeSgpOwogICAgdmFyIGZsYXR0ZW4gPSByZXF1aXJlX2ZsYXR0ZW4oKTsKICAgIHZhciBpc0l0ZXJhdGVlQ2FsbCA9IHJlcXVpcmVfaXNJdGVyYXRlZUNhbGwoKTsKICAgIGZ1bmN0aW9uIHNvcnRCeTUoY29sbGVjdGlvbiwgLi4uY3JpdGVyaWEpIHsKICAgICAgY29uc3QgbGVuZ3RoID0gY3JpdGVyaWEubGVuZ3RoOwogICAgICBpZiAobGVuZ3RoID4gMSAmJiBpc0l0ZXJhdGVlQ2FsbC5pc0l0ZXJhdGVlQ2FsbChjb2xsZWN0aW9uLCBjcml0ZXJpYVswXSwgY3JpdGVyaWFbMV0pKSB7CiAgICAgICAgY3JpdGVyaWEgPSBbXTsKICAgICAgfSBlbHNlIGlmIChsZW5ndGggPiAyICYmIGlzSXRlcmF0ZWVDYWxsLmlzSXRlcmF0ZWVDYWxsKGNyaXRlcmlhWzBdLCBjcml0ZXJpYVsxXSwgY3JpdGVyaWFbMl0pKSB7CiAgICAgICAgY3JpdGVyaWEgPSBbY3JpdGVyaWFbMF1dOwogICAgICB9CiAgICAgIHJldHVybiBvcmRlckJ5Lm9yZGVyQnkoY29sbGVjdGlvbiwgZmxhdHRlbi5mbGF0dGVuKGNyaXRlcmlhKSwgWyJhc2MiXSk7CiAgICB9CiAgICBleHBvcnRzLnNvcnRCeSA9IHNvcnRCeTU7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvc29ydEJ5LmpzCnZhciByZXF1aXJlX3NvcnRCeTIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9zb3J0QnkuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3NvcnRCeSgpLnNvcnRCeTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvZnVuY3Rpb24vZGVib3VuY2UuanMKdmFyIHJlcXVpcmVfZGVib3VuY2UgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvZnVuY3Rpb24vZGVib3VuY2UuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZGVib3VuY2UoZnVuYywgZGVib3VuY2VNcywgeyBzaWduYWwsIGVkZ2VzIH0gPSB7fSkgewogICAgICBsZXQgcGVuZGluZ1RoaXMgPSB2b2lkIDA7CiAgICAgIGxldCBwZW5kaW5nQXJncyA9IG51bGw7CiAgICAgIGNvbnN0IGxlYWRpbmcgPSBlZGdlcyAhPSBudWxsICYmIGVkZ2VzLmluY2x1ZGVzKCJsZWFkaW5nIik7CiAgICAgIGNvbnN0IHRyYWlsaW5nID0gZWRnZXMgPT0gbnVsbCB8fCBlZGdlcy5pbmNsdWRlcygidHJhaWxpbmciKTsKICAgICAgY29uc3QgaW52b2tlID0gKCkgPT4gewogICAgICAgIGlmIChwZW5kaW5nQXJncyAhPT0gbnVsbCkgewogICAgICAgICAgZnVuYy5hcHBseShwZW5kaW5nVGhpcywgcGVuZGluZ0FyZ3MpOwogICAgICAgICAgcGVuZGluZ1RoaXMgPSB2b2lkIDA7CiAgICAgICAgICBwZW5kaW5nQXJncyA9IG51bGw7CiAgICAgICAgfQogICAgICB9OwogICAgICBjb25zdCBvblRpbWVyRW5kID0gKCkgPT4gewogICAgICAgIGlmICh0cmFpbGluZykgewogICAgICAgICAgaW52b2tlKCk7CiAgICAgICAgfQogICAgICAgIGNhbmNlbCgpOwogICAgICB9OwogICAgICBsZXQgdGltZW91dElkID0gbnVsbDsKICAgICAgY29uc3Qgc2NoZWR1bGUgPSAoKSA9PiB7CiAgICAgICAgaWYgKHRpbWVvdXRJZCAhPSBudWxsKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTsKICAgICAgICB9CiAgICAgICAgdGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICB0aW1lb3V0SWQgPSBudWxsOwogICAgICAgICAgb25UaW1lckVuZCgpOwogICAgICAgIH0sIGRlYm91bmNlTXMpOwogICAgICB9OwogICAgICBjb25zdCBjYW5jZWxUaW1lciA9ICgpID0+IHsKICAgICAgICBpZiAodGltZW91dElkICE9PSBudWxsKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTsKICAgICAgICAgIHRpbWVvdXRJZCA9IG51bGw7CiAgICAgICAgfQogICAgICB9OwogICAgICBjb25zdCBjYW5jZWwgPSAoKSA9PiB7CiAgICAgICAgY2FuY2VsVGltZXIoKTsKICAgICAgICBwZW5kaW5nVGhpcyA9IHZvaWQgMDsKICAgICAgICBwZW5kaW5nQXJncyA9IG51bGw7CiAgICAgIH07CiAgICAgIGNvbnN0IGZsdXNoID0gKCkgPT4gewogICAgICAgIGludm9rZSgpOwogICAgICB9OwogICAgICBjb25zdCBkZWJvdW5jZWQgPSBmdW5jdGlvbiguLi5hcmdzKSB7CiAgICAgICAgaWYgKHNpZ25hbD8uYWJvcnRlZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBwZW5kaW5nVGhpcyA9IHRoaXM7CiAgICAgICAgcGVuZGluZ0FyZ3MgPSBhcmdzOwogICAgICAgIGNvbnN0IGlzRmlyc3RDYWxsID0gdGltZW91dElkID09IG51bGw7CiAgICAgICAgc2NoZWR1bGUoKTsKICAgICAgICBpZiAobGVhZGluZyAmJiBpc0ZpcnN0Q2FsbCkgewogICAgICAgICAgaW52b2tlKCk7CiAgICAgICAgfQogICAgICB9OwogICAgICBkZWJvdW5jZWQuc2NoZWR1bGUgPSBzY2hlZHVsZTsKICAgICAgZGVib3VuY2VkLmNhbmNlbCA9IGNhbmNlbDsKICAgICAgZGVib3VuY2VkLmZsdXNoID0gZmx1c2g7CiAgICAgIHNpZ25hbD8uYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBjYW5jZWwsIHsgb25jZTogdHJ1ZSB9KTsKICAgICAgcmV0dXJuIGRlYm91bmNlZDsKICAgIH0KICAgIGV4cG9ydHMuZGVib3VuY2UgPSBkZWJvdW5jZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2Z1bmN0aW9uL2RlYm91bmNlLmpzCnZhciByZXF1aXJlX2RlYm91bmNlMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvZnVuY3Rpb24vZGVib3VuY2UuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGRlYm91bmNlJDEgPSByZXF1aXJlX2RlYm91bmNlKCk7CiAgICBmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCBkZWJvdW5jZU1zID0gMCwgb3B0aW9ucyA9IHt9KSB7CiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gIm9iamVjdCIpIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KICAgICAgY29uc3QgeyBsZWFkaW5nID0gZmFsc2UsIHRyYWlsaW5nID0gdHJ1ZSwgbWF4V2FpdCB9ID0gb3B0aW9uczsKICAgICAgY29uc3QgZWRnZXMgPSBBcnJheSgyKTsKICAgICAgaWYgKGxlYWRpbmcpIHsKICAgICAgICBlZGdlc1swXSA9ICJsZWFkaW5nIjsKICAgICAgfQogICAgICBpZiAodHJhaWxpbmcpIHsKICAgICAgICBlZGdlc1sxXSA9ICJ0cmFpbGluZyI7CiAgICAgIH0KICAgICAgbGV0IHJlc3VsdCA9IHZvaWQgMDsKICAgICAgbGV0IHBlbmRpbmdBdCA9IG51bGw7CiAgICAgIGNvbnN0IF9kZWJvdW5jZWQgPSBkZWJvdW5jZSQxLmRlYm91bmNlKGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIHBlbmRpbmdBdCA9IG51bGw7CiAgICAgIH0sIGRlYm91bmNlTXMsIHsgZWRnZXMgfSk7CiAgICAgIGNvbnN0IGRlYm91bmNlZCA9IGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgICBpZiAobWF4V2FpdCAhPSBudWxsKSB7CiAgICAgICAgICBpZiAocGVuZGluZ0F0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHBlbmRpbmdBdCA9IERhdGUubm93KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIHBlbmRpbmdBdCA+PSBtYXhXYWl0KSB7CiAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIHBlbmRpbmdBdCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIF9kZWJvdW5jZWQuY2FuY2VsKCk7CiAgICAgICAgICAgIF9kZWJvdW5jZWQuc2NoZWR1bGUoKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgX2RlYm91bmNlZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBjb25zdCBmbHVzaCA9ICgpID0+IHsKICAgICAgICBfZGVib3VuY2VkLmZsdXNoKCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgZGVib3VuY2VkLmNhbmNlbCA9IF9kZWJvdW5jZWQuY2FuY2VsOwogICAgICBkZWJvdW5jZWQuZmx1c2ggPSBmbHVzaDsKICAgICAgcmV0dXJuIGRlYm91bmNlZDsKICAgIH0KICAgIGV4cG9ydHMuZGVib3VuY2UgPSBkZWJvdW5jZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2Z1bmN0aW9uL3Rocm90dGxlLmpzCnZhciByZXF1aXJlX3Rocm90dGxlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9mdW5jdGlvbi90aHJvdHRsZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgZGVib3VuY2UgPSByZXF1aXJlX2RlYm91bmNlMigpOwogICAgZnVuY3Rpb24gdGhyb3R0bGUyKGZ1bmMsIHRocm90dGxlTXMgPSAwLCBvcHRpb25zID0ge30pIHsKICAgICAgY29uc3QgeyBsZWFkaW5nID0gdHJ1ZSwgdHJhaWxpbmcgPSB0cnVlIH0gPSBvcHRpb25zOwogICAgICByZXR1cm4gZGVib3VuY2UuZGVib3VuY2UoZnVuYywgdGhyb3R0bGVNcywgewogICAgICAgIGxlYWRpbmcsCiAgICAgICAgbWF4V2FpdDogdGhyb3R0bGVNcywKICAgICAgICB0cmFpbGluZwogICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMudGhyb3R0bGUgPSB0aHJvdHRsZTI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvdGhyb3R0bGUuanMKdmFyIHJlcXVpcmVfdGhyb3R0bGUyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvdGhyb3R0bGUuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3Rocm90dGxlKCkudGhyb3R0bGU7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvTnVtYmVyLmpzCnZhciByZXF1aXJlX3RvTnVtYmVyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvTnVtYmVyLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc1N5bWJvbCA9IHJlcXVpcmVfaXNTeW1ib2woKTsKICAgIGZ1bmN0aW9uIHRvTnVtYmVyMih2YWx1ZSkgewogICAgICBpZiAoaXNTeW1ib2wuaXNTeW1ib2wodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIE5hTjsKICAgICAgfQogICAgICByZXR1cm4gTnVtYmVyKHZhbHVlKTsKICAgIH0KICAgIGV4cG9ydHMudG9OdW1iZXIgPSB0b051bWJlcjI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvRmluaXRlLmpzCnZhciByZXF1aXJlX3RvRmluaXRlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvRmluaXRlLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciB0b051bWJlcjIgPSByZXF1aXJlX3RvTnVtYmVyKCk7CiAgICBmdW5jdGlvbiB0b0Zpbml0ZSh2YWx1ZSkgewogICAgICBpZiAoIXZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlID09PSAwID8gdmFsdWUgOiAwOwogICAgICB9CiAgICAgIHZhbHVlID0gdG9OdW1iZXIyLnRvTnVtYmVyKHZhbHVlKTsKICAgICAgaWYgKHZhbHVlID09PSBJbmZpbml0eSB8fCB2YWx1ZSA9PT0gLUluZmluaXR5KSB7CiAgICAgICAgY29uc3Qgc2lnbjIgPSB2YWx1ZSA8IDAgPyAtMSA6IDE7CiAgICAgICAgcmV0dXJuIHNpZ24yICogTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWUgPT09IHZhbHVlID8gdmFsdWUgOiAwOwogICAgfQogICAgZXhwb3J0cy50b0Zpbml0ZSA9IHRvRmluaXRlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvbWF0aC9yYW5nZS5qcwp2YXIgcmVxdWlyZV9yYW5nZSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvbWF0aC9yYW5nZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNJdGVyYXRlZUNhbGwgPSByZXF1aXJlX2lzSXRlcmF0ZWVDYWxsKCk7CiAgICB2YXIgdG9GaW5pdGUgPSByZXF1aXJlX3RvRmluaXRlKCk7CiAgICBmdW5jdGlvbiByYW5nZTQoc3RhcnQsIGVuZCwgc3RlcCkgewogICAgICBpZiAoc3RlcCAmJiB0eXBlb2Ygc3RlcCAhPT0gIm51bWJlciIgJiYgaXNJdGVyYXRlZUNhbGwuaXNJdGVyYXRlZUNhbGwoc3RhcnQsIGVuZCwgc3RlcCkpIHsKICAgICAgICBlbmQgPSBzdGVwID0gdm9pZCAwOwogICAgICB9CiAgICAgIHN0YXJ0ID0gdG9GaW5pdGUudG9GaW5pdGUoc3RhcnQpOwogICAgICBpZiAoZW5kID09PSB2b2lkIDApIHsKICAgICAgICBlbmQgPSBzdGFydDsKICAgICAgICBzdGFydCA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZW5kID0gdG9GaW5pdGUudG9GaW5pdGUoZW5kKTsKICAgICAgfQogICAgICBzdGVwID0gc3RlcCA9PT0gdm9pZCAwID8gc3RhcnQgPCBlbmQgPyAxIDogLTEgOiB0b0Zpbml0ZS50b0Zpbml0ZShzdGVwKTsKICAgICAgY29uc3QgbGVuZ3RoID0gTWF0aC5tYXgoTWF0aC5jZWlsKChlbmQgLSBzdGFydCkgLyAoc3RlcCB8fCAxKSksIDApOwogICAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgIHJlc3VsdFtpbmRleF0gPSBzdGFydDsKICAgICAgICBzdGFydCArPSBzdGVwOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLnJhbmdlID0gcmFuZ2U0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3JhbmdlLmpzCnZhciByZXF1aXJlX3JhbmdlMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3JhbmdlLmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yYW5nZSgpLnJhbmdlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZGVjaW1hbC5qcy1saWdodEAyLjUuMS9ub2RlX21vZHVsZXMvZGVjaW1hbC5qcy1saWdodC9kZWNpbWFsLmpzCnZhciByZXF1aXJlX2RlY2ltYWwgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2RlY2ltYWwuanMtbGlnaHRAMi41LjEvbm9kZV9tb2R1bGVzL2RlY2ltYWwuanMtbGlnaHQvZGVjaW1hbC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAoZnVuY3Rpb24oZ2xvYmFsU2NvcGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgTUFYX0RJR0lUUyA9IDFlOSwgRGVjaW1hbDMgPSB7CiAgICAgICAgLy8gVGhlc2UgdmFsdWVzIG11c3QgYmUgaW50ZWdlcnMgd2l0aGluIHRoZSBzdGF0ZWQgcmFuZ2VzIChpbmNsdXNpdmUpLgogICAgICAgIC8vIE1vc3Qgb2YgdGhlc2UgdmFsdWVzIGNhbiBiZSBjaGFuZ2VkIGR1cmluZyBydW4tdGltZSB1c2luZyBgRGVjaW1hbC5jb25maWdgLgogICAgICAgIC8vIFRoZSBtYXhpbXVtIG51bWJlciBvZiBzaWduaWZpY2FudCBkaWdpdHMgb2YgdGhlIHJlc3VsdCBvZiBhIGNhbGN1bGF0aW9uIG9yIGJhc2UgY29udmVyc2lvbi4KICAgICAgICAvLyBFLmcuIGBEZWNpbWFsLmNvbmZpZyh7IHByZWNpc2lvbjogMjAgfSk7YAogICAgICAgIHByZWNpc2lvbjogMjAsCiAgICAgICAgLy8gMSB0byBNQVhfRElHSVRTCiAgICAgICAgLy8gVGhlIHJvdW5kaW5nIG1vZGUgdXNlZCBieSBkZWZhdWx0IGJ5IGB0b0ludGVnZXJgLCBgdG9EZWNpbWFsUGxhY2VzYCwgYHRvRXhwb25lbnRpYWxgLAogICAgICAgIC8vIGB0b0ZpeGVkYCwgYHRvUHJlY2lzaW9uYCBhbmQgYHRvU2lnbmlmaWNhbnREaWdpdHNgLgogICAgICAgIC8vCiAgICAgICAgLy8gUk9VTkRfVVAgICAgICAgICAwIEF3YXkgZnJvbSB6ZXJvLgogICAgICAgIC8vIFJPVU5EX0RPV04gICAgICAgMSBUb3dhcmRzIHplcm8uCiAgICAgICAgLy8gUk9VTkRfQ0VJTCAgICAgICAyIFRvd2FyZHMgK0luZmluaXR5LgogICAgICAgIC8vIFJPVU5EX0ZMT09SICAgICAgMyBUb3dhcmRzIC1JbmZpbml0eS4KICAgICAgICAvLyBST1VORF9IQUxGX1VQICAgIDQgVG93YXJkcyBuZWFyZXN0IG5laWdoYm91ci4gSWYgZXF1aWRpc3RhbnQsIHVwLgogICAgICAgIC8vIFJPVU5EX0hBTEZfRE9XTiAgNSBUb3dhcmRzIG5lYXJlc3QgbmVpZ2hib3VyLiBJZiBlcXVpZGlzdGFudCwgZG93bi4KICAgICAgICAvLyBST1VORF9IQUxGX0VWRU4gIDYgVG93YXJkcyBuZWFyZXN0IG5laWdoYm91ci4gSWYgZXF1aWRpc3RhbnQsIHRvd2FyZHMgZXZlbiBuZWlnaGJvdXIuCiAgICAgICAgLy8gUk9VTkRfSEFMRl9DRUlMICA3IFRvd2FyZHMgbmVhcmVzdCBuZWlnaGJvdXIuIElmIGVxdWlkaXN0YW50LCB0b3dhcmRzICtJbmZpbml0eS4KICAgICAgICAvLyBST1VORF9IQUxGX0ZMT09SIDggVG93YXJkcyBuZWFyZXN0IG5laWdoYm91ci4gSWYgZXF1aWRpc3RhbnQsIHRvd2FyZHMgLUluZmluaXR5LgogICAgICAgIC8vCiAgICAgICAgLy8gRS5nLgogICAgICAgIC8vIGBEZWNpbWFsLnJvdW5kaW5nID0gNDtgCiAgICAgICAgLy8gYERlY2ltYWwucm91bmRpbmcgPSBEZWNpbWFsLlJPVU5EX0hBTEZfVVA7YAogICAgICAgIHJvdW5kaW5nOiA0LAogICAgICAgIC8vIDAgdG8gOAogICAgICAgIC8vIFRoZSBleHBvbmVudCB2YWx1ZSBhdCBhbmQgYmVuZWF0aCB3aGljaCBgdG9TdHJpbmdgIHJldHVybnMgZXhwb25lbnRpYWwgbm90YXRpb24uCiAgICAgICAgLy8gSmF2YVNjcmlwdCBudW1iZXJzOiAtNwogICAgICAgIHRvRXhwTmVnOiAtNywKICAgICAgICAvLyAwIHRvIC1NQVhfRQogICAgICAgIC8vIFRoZSBleHBvbmVudCB2YWx1ZSBhdCBhbmQgYWJvdmUgd2hpY2ggYHRvU3RyaW5nYCByZXR1cm5zIGV4cG9uZW50aWFsIG5vdGF0aW9uLgogICAgICAgIC8vIEphdmFTY3JpcHQgbnVtYmVyczogMjEKICAgICAgICB0b0V4cFBvczogMjEsCiAgICAgICAgLy8gMCB0byBNQVhfRQogICAgICAgIC8vIFRoZSBuYXR1cmFsIGxvZ2FyaXRobSBvZiAxMC4KICAgICAgICAvLyAxMTUgZGlnaXRzCiAgICAgICAgTE4xMDogIjIuMzAyNTg1MDkyOTk0MDQ1Njg0MDE3OTkxNDU0Njg0MzY0MjA3NjAxMTAxNDg4NjI4NzcyOTc2MDMzMzI3OTAwOTY3NTcyNjA5Njc3MzUyNDgwMjM1OTk3MjA1MDg5NTk4Mjk4MzQxOTY3Nzg0MDQyMjg2IgogICAgICB9LCBleHRlcm5hbCA9IHRydWUsIGRlY2ltYWxFcnJvciA9ICJbRGVjaW1hbEVycm9yXSAiLCBpbnZhbGlkQXJndW1lbnQgPSBkZWNpbWFsRXJyb3IgKyAiSW52YWxpZCBhcmd1bWVudDogIiwgZXhwb25lbnRPdXRPZlJhbmdlID0gZGVjaW1hbEVycm9yICsgIkV4cG9uZW50IG91dCBvZiByYW5nZTogIiwgbWF0aGZsb29yID0gTWF0aC5mbG9vciwgbWF0aHBvdyA9IE1hdGgucG93LCBpc0RlY2ltYWwgPSAvXihcZCsoXC5cZCopP3xcLlxkKykoZVsrLV0/XGQrKT8kL2ksIE9ORSwgQkFTRSA9IDFlNywgTE9HX0JBU0UgPSA3LCBNQVhfU0FGRV9JTlRFR0VSID0gOTAwNzE5OTI1NDc0MDk5MSwgTUFYX0UgPSBtYXRoZmxvb3IoTUFYX1NBRkVfSU5URUdFUiAvIExPR19CQVNFKSwgUCA9IHt9OwogICAgICBQLmFic29sdXRlVmFsdWUgPSBQLmFicyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB4MiA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMpOwogICAgICAgIGlmICh4Mi5zKSB4Mi5zID0gMTsKICAgICAgICByZXR1cm4geDI7CiAgICAgIH07CiAgICAgIFAuY29tcGFyZWRUbyA9IFAuY21wID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICB2YXIgaSwgaiwgeGRMLCB5ZEwsIHgyID0gdGhpczsKICAgICAgICB5MiA9IG5ldyB4Mi5jb25zdHJ1Y3Rvcih5Mik7CiAgICAgICAgaWYgKHgyLnMgIT09IHkyLnMpIHJldHVybiB4Mi5zIHx8IC15Mi5zOwogICAgICAgIGlmICh4Mi5lICE9PSB5Mi5lKSByZXR1cm4geDIuZSA+IHkyLmUgXiB4Mi5zIDwgMCA/IDEgOiAtMTsKICAgICAgICB4ZEwgPSB4Mi5kLmxlbmd0aDsKICAgICAgICB5ZEwgPSB5Mi5kLmxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwLCBqID0geGRMIDwgeWRMID8geGRMIDogeWRMOyBpIDwgajsgKytpKSB7CiAgICAgICAgICBpZiAoeDIuZFtpXSAhPT0geTIuZFtpXSkgcmV0dXJuIHgyLmRbaV0gPiB5Mi5kW2ldIF4geDIucyA8IDAgPyAxIDogLTE7CiAgICAgICAgfQogICAgICAgIHJldHVybiB4ZEwgPT09IHlkTCA/IDAgOiB4ZEwgPiB5ZEwgXiB4Mi5zIDwgMCA/IDEgOiAtMTsKICAgICAgfTsKICAgICAgUC5kZWNpbWFsUGxhY2VzID0gUC5kcCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB4MiA9IHRoaXMsIHcgPSB4Mi5kLmxlbmd0aCAtIDEsIGRwID0gKHcgLSB4Mi5lKSAqIExPR19CQVNFOwogICAgICAgIHcgPSB4Mi5kW3ddOwogICAgICAgIGlmICh3KSBmb3IgKDsgdyAlIDEwID09IDA7IHcgLz0gMTApIGRwLS07CiAgICAgICAgcmV0dXJuIGRwIDwgMCA/IDAgOiBkcDsKICAgICAgfTsKICAgICAgUC5kaXZpZGVkQnkgPSBQLmRpdiA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIGRpdmlkZSh0aGlzLCBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih5MikpOwogICAgICB9OwogICAgICBQLmRpdmlkZWRUb0ludGVnZXJCeSA9IFAuaWRpdiA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIHJldHVybiByb3VuZChkaXZpZGUoeDIsIG5ldyBDdG9yKHkyKSwgMCwgMSksIEN0b3IucHJlY2lzaW9uKTsKICAgICAgfTsKICAgICAgUC5lcXVhbHMgPSBQLmVxID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICByZXR1cm4gIXRoaXMuY21wKHkyKTsKICAgICAgfTsKICAgICAgUC5leHBvbmVudCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRCYXNlMTBFeHBvbmVudCh0aGlzKTsKICAgICAgfTsKICAgICAgUC5ncmVhdGVyVGhhbiA9IFAuZ3QgPSBmdW5jdGlvbih5MikgewogICAgICAgIHJldHVybiB0aGlzLmNtcCh5MikgPiAwOwogICAgICB9OwogICAgICBQLmdyZWF0ZXJUaGFuT3JFcXVhbFRvID0gUC5ndGUgPSBmdW5jdGlvbih5MikgewogICAgICAgIHJldHVybiB0aGlzLmNtcCh5MikgPj0gMDsKICAgICAgfTsKICAgICAgUC5pc0ludGVnZXIgPSBQLmlzaW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZSA+IHRoaXMuZC5sZW5ndGggLSAyOwogICAgICB9OwogICAgICBQLmlzTmVnYXRpdmUgPSBQLmlzbmVnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucyA8IDA7CiAgICAgIH07CiAgICAgIFAuaXNQb3NpdGl2ZSA9IFAuaXNwb3MgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zID4gMDsKICAgICAgfTsKICAgICAgUC5pc1plcm8gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zID09PSAwOwogICAgICB9OwogICAgICBQLmxlc3NUaGFuID0gUC5sdCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY21wKHkyKSA8IDA7CiAgICAgIH07CiAgICAgIFAubGVzc1RoYW5PckVxdWFsVG8gPSBQLmx0ZSA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY21wKHkyKSA8IDE7CiAgICAgIH07CiAgICAgIFAubG9nYXJpdGhtID0gUC5sb2cgPSBmdW5jdGlvbihiYXNlKSB7CiAgICAgICAgdmFyIHIyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbiwgd3ByID0gcHIgKyA1OwogICAgICAgIGlmIChiYXNlID09PSB2b2lkIDApIHsKICAgICAgICAgIGJhc2UgPSBuZXcgQ3RvcigxMCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2UgPSBuZXcgQ3RvcihiYXNlKTsKICAgICAgICAgIGlmIChiYXNlLnMgPCAxIHx8IGJhc2UuZXEoT05FKSkgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk5hTiIpOwogICAgICAgIH0KICAgICAgICBpZiAoeDIucyA8IDEpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICh4Mi5zID8gIk5hTiIgOiAiLUluZmluaXR5IikpOwogICAgICAgIGlmICh4Mi5lcShPTkUpKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgZXh0ZXJuYWwgPSBmYWxzZTsKICAgICAgICByMiA9IGRpdmlkZShsbih4Miwgd3ByKSwgbG4oYmFzZSwgd3ByKSwgd3ByKTsKICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgcmV0dXJuIHJvdW5kKHIyLCBwcik7CiAgICAgIH07CiAgICAgIFAubWludXMgPSBQLnN1YiA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIHgyID0gdGhpczsKICAgICAgICB5MiA9IG5ldyB4Mi5jb25zdHJ1Y3Rvcih5Mik7CiAgICAgICAgcmV0dXJuIHgyLnMgPT0geTIucyA/IHN1YnRyYWN0KHgyLCB5MikgOiBhZGQoeDIsICh5Mi5zID0gLXkyLnMsIHkyKSk7CiAgICAgIH07CiAgICAgIFAubW9kdWxvID0gUC5tb2QgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBxLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICB5MiA9IG5ldyBDdG9yKHkyKTsKICAgICAgICBpZiAoIXkyLnMpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJOYU4iKTsKICAgICAgICBpZiAoIXgyLnMpIHJldHVybiByb3VuZChuZXcgQ3Rvcih4MiksIHByKTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHEgPSBkaXZpZGUoeDIsIHkyLCAwLCAxKS50aW1lcyh5Mik7CiAgICAgICAgZXh0ZXJuYWwgPSB0cnVlOwogICAgICAgIHJldHVybiB4Mi5taW51cyhxKTsKICAgICAgfTsKICAgICAgUC5uYXR1cmFsRXhwb25lbnRpYWwgPSBQLmV4cCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBleHAodGhpcyk7CiAgICAgIH07CiAgICAgIFAubmF0dXJhbExvZ2FyaXRobSA9IFAubG4gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbG4odGhpcyk7CiAgICAgIH07CiAgICAgIFAubmVnYXRlZCA9IFAubmVnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcyk7CiAgICAgICAgeDIucyA9IC14Mi5zIHx8IDA7CiAgICAgICAgcmV0dXJuIHgyOwogICAgICB9OwogICAgICBQLnBsdXMgPSBQLmFkZCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIHgyID0gdGhpczsKICAgICAgICB5MiA9IG5ldyB4Mi5jb25zdHJ1Y3Rvcih5Mik7CiAgICAgICAgcmV0dXJuIHgyLnMgPT0geTIucyA/IGFkZCh4MiwgeTIpIDogc3VidHJhY3QoeDIsICh5Mi5zID0gLXkyLnMsIHkyKSk7CiAgICAgIH07CiAgICAgIFAucHJlY2lzaW9uID0gUC5zZCA9IGZ1bmN0aW9uKHopIHsKICAgICAgICB2YXIgZSwgc2QsIHcsIHgyID0gdGhpczsKICAgICAgICBpZiAoeiAhPT0gdm9pZCAwICYmIHogIT09ICEheiAmJiB6ICE9PSAxICYmIHogIT09IDApIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHopOwogICAgICAgIGUgPSBnZXRCYXNlMTBFeHBvbmVudCh4MikgKyAxOwogICAgICAgIHcgPSB4Mi5kLmxlbmd0aCAtIDE7CiAgICAgICAgc2QgPSB3ICogTE9HX0JBU0UgKyAxOwogICAgICAgIHcgPSB4Mi5kW3ddOwogICAgICAgIGlmICh3KSB7CiAgICAgICAgICBmb3IgKDsgdyAlIDEwID09IDA7IHcgLz0gMTApIHNkLS07CiAgICAgICAgICBmb3IgKHcgPSB4Mi5kWzBdOyB3ID49IDEwOyB3IC89IDEwKSBzZCsrOwogICAgICAgIH0KICAgICAgICByZXR1cm4geiAmJiBlID4gc2QgPyBlIDogc2Q7CiAgICAgIH07CiAgICAgIFAuc3F1YXJlUm9vdCA9IFAuc3FydCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBlLCBuLCBwciwgcjIsIHMsIHQsIHdwciwgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3I7CiAgICAgICAgaWYgKHgyLnMgPCAxKSB7CiAgICAgICAgICBpZiAoIXgyLnMpIHJldHVybiBuZXcgQ3RvcigwKTsKICAgICAgICAgIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJOYU4iKTsKICAgICAgICB9CiAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHMgPSBNYXRoLnNxcnQoK3gyKTsKICAgICAgICBpZiAocyA9PSAwIHx8IHMgPT0gMSAvIDApIHsKICAgICAgICAgIG4gPSBkaWdpdHNUb1N0cmluZyh4Mi5kKTsKICAgICAgICAgIGlmICgobi5sZW5ndGggKyBlKSAlIDIgPT0gMCkgbiArPSAiMCI7CiAgICAgICAgICBzID0gTWF0aC5zcXJ0KG4pOwogICAgICAgICAgZSA9IG1hdGhmbG9vcigoZSArIDEpIC8gMikgLSAoZSA8IDAgfHwgZSAlIDIpOwogICAgICAgICAgaWYgKHMgPT0gMSAvIDApIHsKICAgICAgICAgICAgbiA9ICI1ZSIgKyBlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbiA9IHMudG9FeHBvbmVudGlhbCgpOwogICAgICAgICAgICBuID0gbi5zbGljZSgwLCBuLmluZGV4T2YoImUiKSArIDEpICsgZTsKICAgICAgICAgIH0KICAgICAgICAgIHIyID0gbmV3IEN0b3Iobik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHIyID0gbmV3IEN0b3Iocy50b1N0cmluZygpKTsKICAgICAgICB9CiAgICAgICAgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBzID0gd3ByID0gcHIgKyAzOwogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgdCA9IHIyOwogICAgICAgICAgcjIgPSB0LnBsdXMoZGl2aWRlKHgyLCB0LCB3cHIgKyAyKSkudGltZXMoMC41KTsKICAgICAgICAgIGlmIChkaWdpdHNUb1N0cmluZyh0LmQpLnNsaWNlKDAsIHdwcikgPT09IChuID0gZGlnaXRzVG9TdHJpbmcocjIuZCkpLnNsaWNlKDAsIHdwcikpIHsKICAgICAgICAgICAgbiA9IG4uc2xpY2Uod3ByIC0gMywgd3ByICsgMSk7CiAgICAgICAgICAgIGlmIChzID09IHdwciAmJiBuID09ICI0OTk5IikgewogICAgICAgICAgICAgIHJvdW5kKHQsIHByICsgMSwgMCk7CiAgICAgICAgICAgICAgaWYgKHQudGltZXModCkuZXEoeDIpKSB7CiAgICAgICAgICAgICAgICByMiA9IHQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobiAhPSAiOTk5OSIpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB3cHIgKz0gNDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXh0ZXJuYWwgPSB0cnVlOwogICAgICAgIHJldHVybiByb3VuZChyMiwgcHIpOwogICAgICB9OwogICAgICBQLnRpbWVzID0gUC5tdWwgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBjYXJyeSwgZSwgaSwgaywgcjIsIHJMLCB0LCB4ZEwsIHlkTCwgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3IsIHhkID0geDIuZCwgeWQgPSAoeTIgPSBuZXcgQ3Rvcih5MikpLmQ7CiAgICAgICAgaWYgKCF4Mi5zIHx8ICF5Mi5zKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgeTIucyAqPSB4Mi5zOwogICAgICAgIGUgPSB4Mi5lICsgeTIuZTsKICAgICAgICB4ZEwgPSB4ZC5sZW5ndGg7CiAgICAgICAgeWRMID0geWQubGVuZ3RoOwogICAgICAgIGlmICh4ZEwgPCB5ZEwpIHsKICAgICAgICAgIHIyID0geGQ7CiAgICAgICAgICB4ZCA9IHlkOwogICAgICAgICAgeWQgPSByMjsKICAgICAgICAgIHJMID0geGRMOwogICAgICAgICAgeGRMID0geWRMOwogICAgICAgICAgeWRMID0gckw7CiAgICAgICAgfQogICAgICAgIHIyID0gW107CiAgICAgICAgckwgPSB4ZEwgKyB5ZEw7CiAgICAgICAgZm9yIChpID0gckw7IGktLTsgKSByMi5wdXNoKDApOwogICAgICAgIGZvciAoaSA9IHlkTDsgLS1pID49IDA7ICkgewogICAgICAgICAgY2FycnkgPSAwOwogICAgICAgICAgZm9yIChrID0geGRMICsgaTsgayA+IGk7ICkgewogICAgICAgICAgICB0ID0gcjJba10gKyB5ZFtpXSAqIHhkW2sgLSBpIC0gMV0gKyBjYXJyeTsKICAgICAgICAgICAgcjJbay0tXSA9IHQgJSBCQVNFIHwgMDsKICAgICAgICAgICAgY2FycnkgPSB0IC8gQkFTRSB8IDA7CiAgICAgICAgICB9CiAgICAgICAgICByMltrXSA9IChyMltrXSArIGNhcnJ5KSAlIEJBU0UgfCAwOwogICAgICAgIH0KICAgICAgICBmb3IgKDsgIXIyWy0tckxdOyApIHIyLnBvcCgpOwogICAgICAgIGlmIChjYXJyeSkgKytlOwogICAgICAgIGVsc2UgcjIuc2hpZnQoKTsKICAgICAgICB5Mi5kID0gcjI7CiAgICAgICAgeTIuZSA9IGU7CiAgICAgICAgcmV0dXJuIGV4dGVybmFsID8gcm91bmQoeTIsIEN0b3IucHJlY2lzaW9uKSA6IHkyOwogICAgICB9OwogICAgICBQLnRvRGVjaW1hbFBsYWNlcyA9IFAudG9kcCA9IGZ1bmN0aW9uKGRwLCBybSkgewogICAgICAgIHZhciB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICB4MiA9IG5ldyBDdG9yKHgyKTsKICAgICAgICBpZiAoZHAgPT09IHZvaWQgMCkgcmV0dXJuIHgyOwogICAgICAgIGNoZWNrSW50MzIoZHAsIDAsIE1BWF9ESUdJVFMpOwogICAgICAgIGlmIChybSA9PT0gdm9pZCAwKSBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgZWxzZSBjaGVja0ludDMyKHJtLCAwLCA4KTsKICAgICAgICByZXR1cm4gcm91bmQoeDIsIGRwICsgZ2V0QmFzZTEwRXhwb25lbnQoeDIpICsgMSwgcm0pOwogICAgICB9OwogICAgICBQLnRvRXhwb25lbnRpYWwgPSBmdW5jdGlvbihkcCwgcm0pIHsKICAgICAgICB2YXIgc3RyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoZHAgPT09IHZvaWQgMCkgewogICAgICAgICAgc3RyID0gdG9TdHJpbmcoeDIsIHRydWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjaGVja0ludDMyKGRwLCAwLCBNQVhfRElHSVRTKTsKICAgICAgICAgIGlmIChybSA9PT0gdm9pZCAwKSBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgICBlbHNlIGNoZWNrSW50MzIocm0sIDAsIDgpOwogICAgICAgICAgeDIgPSByb3VuZChuZXcgQ3Rvcih4MiksIGRwICsgMSwgcm0pOwogICAgICAgICAgc3RyID0gdG9TdHJpbmcoeDIsIHRydWUsIGRwICsgMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHI7CiAgICAgIH07CiAgICAgIFAudG9GaXhlZCA9IGZ1bmN0aW9uKGRwLCBybSkgewogICAgICAgIHZhciBzdHIsIHkyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoZHAgPT09IHZvaWQgMCkgcmV0dXJuIHRvU3RyaW5nKHgyKTsKICAgICAgICBjaGVja0ludDMyKGRwLCAwLCBNQVhfRElHSVRTKTsKICAgICAgICBpZiAocm0gPT09IHZvaWQgMCkgcm0gPSBDdG9yLnJvdW5kaW5nOwogICAgICAgIGVsc2UgY2hlY2tJbnQzMihybSwgMCwgOCk7CiAgICAgICAgeTIgPSByb3VuZChuZXcgQ3Rvcih4MiksIGRwICsgZ2V0QmFzZTEwRXhwb25lbnQoeDIpICsgMSwgcm0pOwogICAgICAgIHN0ciA9IHRvU3RyaW5nKHkyLmFicygpLCBmYWxzZSwgZHAgKyBnZXRCYXNlMTBFeHBvbmVudCh5MikgKyAxKTsKICAgICAgICByZXR1cm4geDIuaXNuZWcoKSAmJiAheDIuaXNaZXJvKCkgPyAiLSIgKyBzdHIgOiBzdHI7CiAgICAgIH07CiAgICAgIFAudG9JbnRlZ2VyID0gUC50b2ludCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICByZXR1cm4gcm91bmQobmV3IEN0b3IoeDIpLCBnZXRCYXNlMTBFeHBvbmVudCh4MikgKyAxLCBDdG9yLnJvdW5kaW5nKTsKICAgICAgfTsKICAgICAgUC50b051bWJlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiArdGhpczsKICAgICAgfTsKICAgICAgUC50b1Bvd2VyID0gUC5wb3cgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBlLCBrLCBwciwgcjIsIHNpZ24yLCB5SXNJbnQsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBndWFyZCA9IDEyLCB5biA9ICsoeTIgPSBuZXcgQ3Rvcih5MikpOwogICAgICAgIGlmICgheTIucykgcmV0dXJuIG5ldyBDdG9yKE9ORSk7CiAgICAgICAgeDIgPSBuZXcgQ3Rvcih4Mik7CiAgICAgICAgaWYgKCF4Mi5zKSB7CiAgICAgICAgICBpZiAoeTIucyA8IDEpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJJbmZpbml0eSIpOwogICAgICAgICAgcmV0dXJuIHgyOwogICAgICAgIH0KICAgICAgICBpZiAoeDIuZXEoT05FKSkgcmV0dXJuIHgyOwogICAgICAgIHByID0gQ3Rvci5wcmVjaXNpb247CiAgICAgICAgaWYgKHkyLmVxKE9ORSkpIHJldHVybiByb3VuZCh4MiwgcHIpOwogICAgICAgIGUgPSB5Mi5lOwogICAgICAgIGsgPSB5Mi5kLmxlbmd0aCAtIDE7CiAgICAgICAgeUlzSW50ID0gZSA+PSBrOwogICAgICAgIHNpZ24yID0geDIuczsKICAgICAgICBpZiAoIXlJc0ludCkgewogICAgICAgICAgaWYgKHNpZ24yIDwgMCkgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk5hTiIpOwogICAgICAgIH0gZWxzZSBpZiAoKGsgPSB5biA8IDAgPyAteW4gOiB5bikgPD0gTUFYX1NBRkVfSU5URUdFUikgewogICAgICAgICAgcjIgPSBuZXcgQ3RvcihPTkUpOwogICAgICAgICAgZSA9IE1hdGguY2VpbChwciAvIExPR19CQVNFICsgNCk7CiAgICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICAgIGlmIChrICUgMikgewogICAgICAgICAgICAgIHIyID0gcjIudGltZXMoeDIpOwogICAgICAgICAgICAgIHRydW5jYXRlKHIyLmQsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGsgPSBtYXRoZmxvb3IoayAvIDIpOwogICAgICAgICAgICBpZiAoayA9PT0gMCkgYnJlYWs7CiAgICAgICAgICAgIHgyID0geDIudGltZXMoeDIpOwogICAgICAgICAgICB0cnVuY2F0ZSh4Mi5kLCBlKTsKICAgICAgICAgIH0KICAgICAgICAgIGV4dGVybmFsID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiB5Mi5zIDwgMCA/IG5ldyBDdG9yKE9ORSkuZGl2KHIyKSA6IHJvdW5kKHIyLCBwcik7CiAgICAgICAgfQogICAgICAgIHNpZ24yID0gc2lnbjIgPCAwICYmIHkyLmRbTWF0aC5tYXgoZSwgayldICYgMSA/IC0xIDogMTsKICAgICAgICB4Mi5zID0gMTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHIyID0geTIudGltZXMobG4oeDIsIHByICsgZ3VhcmQpKTsKICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgcjIgPSBleHAocjIpOwogICAgICAgIHIyLnMgPSBzaWduMjsKICAgICAgICByZXR1cm4gcjI7CiAgICAgIH07CiAgICAgIFAudG9QcmVjaXNpb24gPSBmdW5jdGlvbihzZCwgcm0pIHsKICAgICAgICB2YXIgZSwgc3RyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoc2QgPT09IHZvaWQgMCkgewogICAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKTsKICAgICAgICAgIHN0ciA9IHRvU3RyaW5nKHgyLCBlIDw9IEN0b3IudG9FeHBOZWcgfHwgZSA+PSBDdG9yLnRvRXhwUG9zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2hlY2tJbnQzMihzZCwgMSwgTUFYX0RJR0lUUyk7CiAgICAgICAgICBpZiAocm0gPT09IHZvaWQgMCkgcm0gPSBDdG9yLnJvdW5kaW5nOwogICAgICAgICAgZWxzZSBjaGVja0ludDMyKHJtLCAwLCA4KTsKICAgICAgICAgIHgyID0gcm91bmQobmV3IEN0b3IoeDIpLCBzZCwgcm0pOwogICAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKTsKICAgICAgICAgIHN0ciA9IHRvU3RyaW5nKHgyLCBzZCA8PSBlIHx8IGUgPD0gQ3Rvci50b0V4cE5lZywgc2QpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyOwogICAgICB9OwogICAgICBQLnRvU2lnbmlmaWNhbnREaWdpdHMgPSBQLnRvc2QgPSBmdW5jdGlvbihzZCwgcm0pIHsKICAgICAgICB2YXIgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3I7CiAgICAgICAgaWYgKHNkID09PSB2b2lkIDApIHsKICAgICAgICAgIHNkID0gQ3Rvci5wcmVjaXNpb247CiAgICAgICAgICBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNoZWNrSW50MzIoc2QsIDEsIE1BWF9ESUdJVFMpOwogICAgICAgICAgaWYgKHJtID09PSB2b2lkIDApIHJtID0gQ3Rvci5yb3VuZGluZzsKICAgICAgICAgIGVsc2UgY2hlY2tJbnQzMihybSwgMCwgOCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByb3VuZChuZXcgQ3Rvcih4MiksIHNkLCBybSk7CiAgICAgIH07CiAgICAgIFAudG9TdHJpbmcgPSBQLnZhbHVlT2YgPSBQLnZhbCA9IFAudG9KU09OID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKSwgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIHJldHVybiB0b1N0cmluZyh4MiwgZSA8PSBDdG9yLnRvRXhwTmVnIHx8IGUgPj0gQ3Rvci50b0V4cFBvcyk7CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIGFkZCh4MiwgeTIpIHsKICAgICAgICB2YXIgY2FycnksIGQsIGUsIGksIGssIGxlbiwgeGQsIHlkLCBDdG9yID0geDIuY29uc3RydWN0b3IsIHByID0gQ3Rvci5wcmVjaXNpb247CiAgICAgICAgaWYgKCF4Mi5zIHx8ICF5Mi5zKSB7CiAgICAgICAgICBpZiAoIXkyLnMpIHkyID0gbmV3IEN0b3IoeDIpOwogICAgICAgICAgcmV0dXJuIGV4dGVybmFsID8gcm91bmQoeTIsIHByKSA6IHkyOwogICAgICAgIH0KICAgICAgICB4ZCA9IHgyLmQ7CiAgICAgICAgeWQgPSB5Mi5kOwogICAgICAgIGsgPSB4Mi5lOwogICAgICAgIGUgPSB5Mi5lOwogICAgICAgIHhkID0geGQuc2xpY2UoKTsKICAgICAgICBpID0gayAtIGU7CiAgICAgICAgaWYgKGkpIHsKICAgICAgICAgIGlmIChpIDwgMCkgewogICAgICAgICAgICBkID0geGQ7CiAgICAgICAgICAgIGkgPSAtaTsKICAgICAgICAgICAgbGVuID0geWQubGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZCA9IHlkOwogICAgICAgICAgICBlID0gazsKICAgICAgICAgICAgbGVuID0geGQubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgayA9IE1hdGguY2VpbChwciAvIExPR19CQVNFKTsKICAgICAgICAgIGxlbiA9IGsgPiBsZW4gPyBrICsgMSA6IGxlbiArIDE7CiAgICAgICAgICBpZiAoaSA+IGxlbikgewogICAgICAgICAgICBpID0gbGVuOwogICAgICAgICAgICBkLmxlbmd0aCA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBkLnJldmVyc2UoKTsKICAgICAgICAgIGZvciAoOyBpLS07ICkgZC5wdXNoKDApOwogICAgICAgICAgZC5yZXZlcnNlKCk7CiAgICAgICAgfQogICAgICAgIGxlbiA9IHhkLmxlbmd0aDsKICAgICAgICBpID0geWQubGVuZ3RoOwogICAgICAgIGlmIChsZW4gLSBpIDwgMCkgewogICAgICAgICAgaSA9IGxlbjsKICAgICAgICAgIGQgPSB5ZDsKICAgICAgICAgIHlkID0geGQ7CiAgICAgICAgICB4ZCA9IGQ7CiAgICAgICAgfQogICAgICAgIGZvciAoY2FycnkgPSAwOyBpOyApIHsKICAgICAgICAgIGNhcnJ5ID0gKHhkWy0taV0gPSB4ZFtpXSArIHlkW2ldICsgY2FycnkpIC8gQkFTRSB8IDA7CiAgICAgICAgICB4ZFtpXSAlPSBCQVNFOwogICAgICAgIH0KICAgICAgICBpZiAoY2FycnkpIHsKICAgICAgICAgIHhkLnVuc2hpZnQoY2FycnkpOwogICAgICAgICAgKytlOwogICAgICAgIH0KICAgICAgICBmb3IgKGxlbiA9IHhkLmxlbmd0aDsgeGRbLS1sZW5dID09IDA7ICkgeGQucG9wKCk7CiAgICAgICAgeTIuZCA9IHhkOwogICAgICAgIHkyLmUgPSBlOwogICAgICAgIHJldHVybiBleHRlcm5hbCA/IHJvdW5kKHkyLCBwcikgOiB5MjsKICAgICAgfQogICAgICBmdW5jdGlvbiBjaGVja0ludDMyKGksIG1pbjIsIG1heDIpIHsKICAgICAgICBpZiAoaSAhPT0gfn5pIHx8IGkgPCBtaW4yIHx8IGkgPiBtYXgyKSB7CiAgICAgICAgICB0aHJvdyBFcnJvcihpbnZhbGlkQXJndW1lbnQgKyBpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZGlnaXRzVG9TdHJpbmcoZCkgewogICAgICAgIHZhciBpLCBrLCB3cywgaW5kZXhPZkxhc3RXb3JkID0gZC5sZW5ndGggLSAxLCBzdHIgPSAiIiwgdyA9IGRbMF07CiAgICAgICAgaWYgKGluZGV4T2ZMYXN0V29yZCA+IDApIHsKICAgICAgICAgIHN0ciArPSB3OwogICAgICAgICAgZm9yIChpID0gMTsgaSA8IGluZGV4T2ZMYXN0V29yZDsgaSsrKSB7CiAgICAgICAgICAgIHdzID0gZFtpXSArICIiOwogICAgICAgICAgICBrID0gTE9HX0JBU0UgLSB3cy5sZW5ndGg7CiAgICAgICAgICAgIGlmIChrKSBzdHIgKz0gZ2V0WmVyb1N0cmluZyhrKTsKICAgICAgICAgICAgc3RyICs9IHdzOwogICAgICAgICAgfQogICAgICAgICAgdyA9IGRbaV07CiAgICAgICAgICB3cyA9IHcgKyAiIjsKICAgICAgICAgIGsgPSBMT0dfQkFTRSAtIHdzLmxlbmd0aDsKICAgICAgICAgIGlmIChrKSBzdHIgKz0gZ2V0WmVyb1N0cmluZyhrKTsKICAgICAgICB9IGVsc2UgaWYgKHcgPT09IDApIHsKICAgICAgICAgIHJldHVybiAiMCI7CiAgICAgICAgfQogICAgICAgIGZvciAoOyB3ICUgMTAgPT09IDA7ICkgdyAvPSAxMDsKICAgICAgICByZXR1cm4gc3RyICsgdzsKICAgICAgfQogICAgICB2YXIgZGl2aWRlID0gLyogQF9fUFVSRV9fICovIGZ1bmN0aW9uKCkgewogICAgICAgIGZ1bmN0aW9uIG11bHRpcGx5SW50ZWdlcih4MiwgaykgewogICAgICAgICAgdmFyIHRlbXAsIGNhcnJ5ID0gMCwgaSA9IHgyLmxlbmd0aDsKICAgICAgICAgIGZvciAoeDIgPSB4Mi5zbGljZSgpOyBpLS07ICkgewogICAgICAgICAgICB0ZW1wID0geDJbaV0gKiBrICsgY2Fycnk7CiAgICAgICAgICAgIHgyW2ldID0gdGVtcCAlIEJBU0UgfCAwOwogICAgICAgICAgICBjYXJyeSA9IHRlbXAgLyBCQVNFIHwgMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjYXJyeSkgeDIudW5zaGlmdChjYXJyeSk7CiAgICAgICAgICByZXR1cm4geDI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBhcmUoYSwgYiwgYUwsIGJMKSB7CiAgICAgICAgICB2YXIgaSwgcjI7CiAgICAgICAgICBpZiAoYUwgIT0gYkwpIHsKICAgICAgICAgICAgcjIgPSBhTCA+IGJMID8gMSA6IC0xOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yIChpID0gcjIgPSAwOyBpIDwgYUw7IGkrKykgewogICAgICAgICAgICAgIGlmIChhW2ldICE9IGJbaV0pIHsKICAgICAgICAgICAgICAgIHIyID0gYVtpXSA+IGJbaV0gPyAxIDogLTE7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3VidHJhY3QyKGEsIGIsIGFMKSB7CiAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICBmb3IgKDsgYUwtLTsgKSB7CiAgICAgICAgICAgIGFbYUxdIC09IGk7CiAgICAgICAgICAgIGkgPSBhW2FMXSA8IGJbYUxdID8gMSA6IDA7CiAgICAgICAgICAgIGFbYUxdID0gaSAqIEJBU0UgKyBhW2FMXSAtIGJbYUxdOwogICAgICAgICAgfQogICAgICAgICAgZm9yICg7ICFhWzBdICYmIGEubGVuZ3RoID4gMTsgKSBhLnNoaWZ0KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmdW5jdGlvbih4MiwgeTIsIHByLCBkcCkgewogICAgICAgICAgdmFyIGNtcCwgZSwgaSwgaywgcHJvZCwgcHJvZEwsIHEsIHFkLCByZW0sIHJlbUwsIHJlbTAsIHNkLCB0LCB4aSwgeEwsIHlkMCwgeUwsIHl6LCBDdG9yID0geDIuY29uc3RydWN0b3IsIHNpZ24yID0geDIucyA9PSB5Mi5zID8gMSA6IC0xLCB4ZCA9IHgyLmQsIHlkID0geTIuZDsKICAgICAgICAgIGlmICgheDIucykgcmV0dXJuIG5ldyBDdG9yKHgyKTsKICAgICAgICAgIGlmICgheTIucykgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIkRpdmlzaW9uIGJ5IHplcm8iKTsKICAgICAgICAgIGUgPSB4Mi5lIC0geTIuZTsKICAgICAgICAgIHlMID0geWQubGVuZ3RoOwogICAgICAgICAgeEwgPSB4ZC5sZW5ndGg7CiAgICAgICAgICBxID0gbmV3IEN0b3Ioc2lnbjIpOwogICAgICAgICAgcWQgPSBxLmQgPSBbXTsKICAgICAgICAgIGZvciAoaSA9IDA7IHlkW2ldID09ICh4ZFtpXSB8fCAwKTsgKSArK2k7CiAgICAgICAgICBpZiAoeWRbaV0gPiAoeGRbaV0gfHwgMCkpIC0tZTsKICAgICAgICAgIGlmIChwciA9PSBudWxsKSB7CiAgICAgICAgICAgIHNkID0gcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICAgIH0gZWxzZSBpZiAoZHApIHsKICAgICAgICAgICAgc2QgPSBwciArIChnZXRCYXNlMTBFeHBvbmVudCh4MikgLSBnZXRCYXNlMTBFeHBvbmVudCh5MikpICsgMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNkID0gcHI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2QgPCAwKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgICBzZCA9IHNkIC8gTE9HX0JBU0UgKyAyIHwgMDsKICAgICAgICAgIGkgPSAwOwogICAgICAgICAgaWYgKHlMID09IDEpIHsKICAgICAgICAgICAgayA9IDA7CiAgICAgICAgICAgIHlkID0geWRbMF07CiAgICAgICAgICAgIHNkKys7CiAgICAgICAgICAgIGZvciAoOyAoaSA8IHhMIHx8IGspICYmIHNkLS07IGkrKykgewogICAgICAgICAgICAgIHQgPSBrICogQkFTRSArICh4ZFtpXSB8fCAwKTsKICAgICAgICAgICAgICBxZFtpXSA9IHQgLyB5ZCB8IDA7CiAgICAgICAgICAgICAgayA9IHQgJSB5ZCB8IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGsgPSBCQVNFIC8gKHlkWzBdICsgMSkgfCAwOwogICAgICAgICAgICBpZiAoayA+IDEpIHsKICAgICAgICAgICAgICB5ZCA9IG11bHRpcGx5SW50ZWdlcih5ZCwgayk7CiAgICAgICAgICAgICAgeGQgPSBtdWx0aXBseUludGVnZXIoeGQsIGspOwogICAgICAgICAgICAgIHlMID0geWQubGVuZ3RoOwogICAgICAgICAgICAgIHhMID0geGQubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHhpID0geUw7CiAgICAgICAgICAgIHJlbSA9IHhkLnNsaWNlKDAsIHlMKTsKICAgICAgICAgICAgcmVtTCA9IHJlbS5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyByZW1MIDwgeUw7ICkgcmVtW3JlbUwrK10gPSAwOwogICAgICAgICAgICB5eiA9IHlkLnNsaWNlKCk7CiAgICAgICAgICAgIHl6LnVuc2hpZnQoMCk7CiAgICAgICAgICAgIHlkMCA9IHlkWzBdOwogICAgICAgICAgICBpZiAoeWRbMV0gPj0gQkFTRSAvIDIpICsreWQwOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgayA9IDA7CiAgICAgICAgICAgICAgY21wID0gY29tcGFyZSh5ZCwgcmVtLCB5TCwgcmVtTCk7CiAgICAgICAgICAgICAgaWYgKGNtcCA8IDApIHsKICAgICAgICAgICAgICAgIHJlbTAgPSByZW1bMF07CiAgICAgICAgICAgICAgICBpZiAoeUwgIT0gcmVtTCkgcmVtMCA9IHJlbTAgKiBCQVNFICsgKHJlbVsxXSB8fCAwKTsKICAgICAgICAgICAgICAgIGsgPSByZW0wIC8geWQwIHwgMDsKICAgICAgICAgICAgICAgIGlmIChrID4gMSkgewogICAgICAgICAgICAgICAgICBpZiAoayA+PSBCQVNFKSBrID0gQkFTRSAtIDE7CiAgICAgICAgICAgICAgICAgIHByb2QgPSBtdWx0aXBseUludGVnZXIoeWQsIGspOwogICAgICAgICAgICAgICAgICBwcm9kTCA9IHByb2QubGVuZ3RoOwogICAgICAgICAgICAgICAgICByZW1MID0gcmVtLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgY21wID0gY29tcGFyZShwcm9kLCByZW0sIHByb2RMLCByZW1MKTsKICAgICAgICAgICAgICAgICAgaWYgKGNtcCA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgay0tOwogICAgICAgICAgICAgICAgICAgIHN1YnRyYWN0Mihwcm9kLCB5TCA8IHByb2RMID8geXogOiB5ZCwgcHJvZEwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoayA9PSAwKSBjbXAgPSBrID0gMTsKICAgICAgICAgICAgICAgICAgcHJvZCA9IHlkLnNsaWNlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcm9kTCA9IHByb2QubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKHByb2RMIDwgcmVtTCkgcHJvZC51bnNoaWZ0KDApOwogICAgICAgICAgICAgICAgc3VidHJhY3QyKHJlbSwgcHJvZCwgcmVtTCk7CiAgICAgICAgICAgICAgICBpZiAoY21wID09IC0xKSB7CiAgICAgICAgICAgICAgICAgIHJlbUwgPSByZW0ubGVuZ3RoOwogICAgICAgICAgICAgICAgICBjbXAgPSBjb21wYXJlKHlkLCByZW0sIHlMLCByZW1MKTsKICAgICAgICAgICAgICAgICAgaWYgKGNtcCA8IDEpIHsKICAgICAgICAgICAgICAgICAgICBrKys7CiAgICAgICAgICAgICAgICAgICAgc3VidHJhY3QyKHJlbSwgeUwgPCByZW1MID8geXogOiB5ZCwgcmVtTCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlbUwgPSByZW0ubGVuZ3RoOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoY21wID09PSAwKSB7CiAgICAgICAgICAgICAgICBrKys7CiAgICAgICAgICAgICAgICByZW0gPSBbMF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHFkW2krK10gPSBrOwogICAgICAgICAgICAgIGlmIChjbXAgJiYgcmVtWzBdKSB7CiAgICAgICAgICAgICAgICByZW1bcmVtTCsrXSA9IHhkW3hpXSB8fCAwOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZW0gPSBbeGRbeGldXTsKICAgICAgICAgICAgICAgIHJlbUwgPSAxOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoKHhpKysgPCB4TCB8fCByZW1bMF0gIT09IHZvaWQgMCkgJiYgc2QtLSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXFkWzBdKSBxZC5zaGlmdCgpOwogICAgICAgICAgcS5lID0gZTsKICAgICAgICAgIHJldHVybiByb3VuZChxLCBkcCA/IHByICsgZ2V0QmFzZTEwRXhwb25lbnQocSkgKyAxIDogcHIpOwogICAgICAgIH07CiAgICAgIH0oKTsKICAgICAgZnVuY3Rpb24gZXhwKHgyLCBzZCkgewogICAgICAgIHZhciBkZW5vbWluYXRvciwgZ3VhcmQsIHBvdzIsIHN1bSwgdCwgd3ByLCBpID0gMCwgayA9IDAsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoZ2V0QmFzZTEwRXhwb25lbnQoeDIpID4gMTYpIHRocm93IEVycm9yKGV4cG9uZW50T3V0T2ZSYW5nZSArIGdldEJhc2UxMEV4cG9uZW50KHgyKSk7CiAgICAgICAgaWYgKCF4Mi5zKSByZXR1cm4gbmV3IEN0b3IoT05FKTsKICAgICAgICBpZiAoc2QgPT0gbnVsbCkgewogICAgICAgICAgZXh0ZXJuYWwgPSBmYWxzZTsKICAgICAgICAgIHdwciA9IHByOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3cHIgPSBzZDsKICAgICAgICB9CiAgICAgICAgdCA9IG5ldyBDdG9yKDAuMDMxMjUpOwogICAgICAgIHdoaWxlICh4Mi5hYnMoKS5ndGUoMC4xKSkgewogICAgICAgICAgeDIgPSB4Mi50aW1lcyh0KTsKICAgICAgICAgIGsgKz0gNTsKICAgICAgICB9CiAgICAgICAgZ3VhcmQgPSBNYXRoLmxvZyhtYXRocG93KDIsIGspKSAvIE1hdGguTE4xMCAqIDIgKyA1IHwgMDsKICAgICAgICB3cHIgKz0gZ3VhcmQ7CiAgICAgICAgZGVub21pbmF0b3IgPSBwb3cyID0gc3VtID0gbmV3IEN0b3IoT05FKTsKICAgICAgICBDdG9yLnByZWNpc2lvbiA9IHdwcjsKICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgIHBvdzIgPSByb3VuZChwb3cyLnRpbWVzKHgyKSwgd3ByKTsKICAgICAgICAgIGRlbm9taW5hdG9yID0gZGVub21pbmF0b3IudGltZXMoKytpKTsKICAgICAgICAgIHQgPSBzdW0ucGx1cyhkaXZpZGUocG93MiwgZGVub21pbmF0b3IsIHdwcikpOwogICAgICAgICAgaWYgKGRpZ2l0c1RvU3RyaW5nKHQuZCkuc2xpY2UoMCwgd3ByKSA9PT0gZGlnaXRzVG9TdHJpbmcoc3VtLmQpLnNsaWNlKDAsIHdwcikpIHsKICAgICAgICAgICAgd2hpbGUgKGstLSkgc3VtID0gcm91bmQoc3VtLnRpbWVzKHN1bSksIHdwcik7CiAgICAgICAgICAgIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICAgIHJldHVybiBzZCA9PSBudWxsID8gKGV4dGVybmFsID0gdHJ1ZSwgcm91bmQoc3VtLCBwcikpIDogc3VtOwogICAgICAgICAgfQogICAgICAgICAgc3VtID0gdDsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZ2V0QmFzZTEwRXhwb25lbnQoeDIpIHsKICAgICAgICB2YXIgZSA9IHgyLmUgKiBMT0dfQkFTRSwgdyA9IHgyLmRbMF07CiAgICAgICAgZm9yICg7IHcgPj0gMTA7IHcgLz0gMTApIGUrKzsKICAgICAgICByZXR1cm4gZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRMbjEwKEN0b3IsIHNkLCBwcikgewogICAgICAgIGlmIChzZCA+IEN0b3IuTE4xMC5zZCgpKSB7CiAgICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgICBpZiAocHIpIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICB0aHJvdyBFcnJvcihkZWNpbWFsRXJyb3IgKyAiTE4xMCBwcmVjaXNpb24gbGltaXQgZXhjZWVkZWQiKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJvdW5kKG5ldyBDdG9yKEN0b3IuTE4xMCksIHNkKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRaZXJvU3RyaW5nKGspIHsKICAgICAgICB2YXIgenMgPSAiIjsKICAgICAgICBmb3IgKDsgay0tOyApIHpzICs9ICIwIjsKICAgICAgICByZXR1cm4genM7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gbG4oeTIsIHNkKSB7CiAgICAgICAgdmFyIGMsIGMwLCBkZW5vbWluYXRvciwgZSwgbnVtZXJhdG9yLCBzdW0sIHQsIHdwciwgeDIsIG4gPSAxLCBndWFyZCA9IDEwLCB4MyA9IHkyLCB4ZCA9IHgzLmQsIEN0b3IgPSB4My5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoeDMucyA8IDEpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICh4My5zID8gIk5hTiIgOiAiLUluZmluaXR5IikpOwogICAgICAgIGlmICh4My5lcShPTkUpKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgaWYgKHNkID09IG51bGwpIHsKICAgICAgICAgIGV4dGVybmFsID0gZmFsc2U7CiAgICAgICAgICB3cHIgPSBwcjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd3ByID0gc2Q7CiAgICAgICAgfQogICAgICAgIGlmICh4My5lcSgxMCkpIHsKICAgICAgICAgIGlmIChzZCA9PSBudWxsKSBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgICByZXR1cm4gZ2V0TG4xMChDdG9yLCB3cHIpOwogICAgICAgIH0KICAgICAgICB3cHIgKz0gZ3VhcmQ7CiAgICAgICAgQ3Rvci5wcmVjaXNpb24gPSB3cHI7CiAgICAgICAgYyA9IGRpZ2l0c1RvU3RyaW5nKHhkKTsKICAgICAgICBjMCA9IGMuY2hhckF0KDApOwogICAgICAgIGUgPSBnZXRCYXNlMTBFeHBvbmVudCh4Myk7CiAgICAgICAgaWYgKE1hdGguYWJzKGUpIDwgMTVlMTQpIHsKICAgICAgICAgIHdoaWxlIChjMCA8IDcgJiYgYzAgIT0gMSB8fCBjMCA9PSAxICYmIGMuY2hhckF0KDEpID4gMykgewogICAgICAgICAgICB4MyA9IHgzLnRpbWVzKHkyKTsKICAgICAgICAgICAgYyA9IGRpZ2l0c1RvU3RyaW5nKHgzLmQpOwogICAgICAgICAgICBjMCA9IGMuY2hhckF0KDApOwogICAgICAgICAgICBuKys7CiAgICAgICAgICB9CiAgICAgICAgICBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDMpOwogICAgICAgICAgaWYgKGMwID4gMSkgewogICAgICAgICAgICB4MyA9IG5ldyBDdG9yKCIwLiIgKyBjKTsKICAgICAgICAgICAgZSsrOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgeDMgPSBuZXcgQ3RvcihjMCArICIuIiArIGMuc2xpY2UoMSkpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0ID0gZ2V0TG4xMChDdG9yLCB3cHIgKyAyLCBwcikudGltZXMoZSArICIiKTsKICAgICAgICAgIHgzID0gbG4obmV3IEN0b3IoYzAgKyAiLiIgKyBjLnNsaWNlKDEpKSwgd3ByIC0gZ3VhcmQpLnBsdXModCk7CiAgICAgICAgICBDdG9yLnByZWNpc2lvbiA9IHByOwogICAgICAgICAgcmV0dXJuIHNkID09IG51bGwgPyAoZXh0ZXJuYWwgPSB0cnVlLCByb3VuZCh4MywgcHIpKSA6IHgzOwogICAgICAgIH0KICAgICAgICBzdW0gPSBudW1lcmF0b3IgPSB4MyA9IGRpdmlkZSh4My5taW51cyhPTkUpLCB4My5wbHVzKE9ORSksIHdwcik7CiAgICAgICAgeDIgPSByb3VuZCh4My50aW1lcyh4MyksIHdwcik7CiAgICAgICAgZGVub21pbmF0b3IgPSAzOwogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgbnVtZXJhdG9yID0gcm91bmQobnVtZXJhdG9yLnRpbWVzKHgyKSwgd3ByKTsKICAgICAgICAgIHQgPSBzdW0ucGx1cyhkaXZpZGUobnVtZXJhdG9yLCBuZXcgQ3RvcihkZW5vbWluYXRvciksIHdwcikpOwogICAgICAgICAgaWYgKGRpZ2l0c1RvU3RyaW5nKHQuZCkuc2xpY2UoMCwgd3ByKSA9PT0gZGlnaXRzVG9TdHJpbmcoc3VtLmQpLnNsaWNlKDAsIHdwcikpIHsKICAgICAgICAgICAgc3VtID0gc3VtLnRpbWVzKDIpOwogICAgICAgICAgICBpZiAoZSAhPT0gMCkgc3VtID0gc3VtLnBsdXMoZ2V0TG4xMChDdG9yLCB3cHIgKyAyLCBwcikudGltZXMoZSArICIiKSk7CiAgICAgICAgICAgIHN1bSA9IGRpdmlkZShzdW0sIG5ldyBDdG9yKG4pLCB3cHIpOwogICAgICAgICAgICBDdG9yLnByZWNpc2lvbiA9IHByOwogICAgICAgICAgICByZXR1cm4gc2QgPT0gbnVsbCA/IChleHRlcm5hbCA9IHRydWUsIHJvdW5kKHN1bSwgcHIpKSA6IHN1bTsKICAgICAgICAgIH0KICAgICAgICAgIHN1bSA9IHQ7CiAgICAgICAgICBkZW5vbWluYXRvciArPSAyOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZURlY2ltYWwoeDIsIHN0cikgewogICAgICAgIHZhciBlLCBpLCBsZW47CiAgICAgICAgaWYgKChlID0gc3RyLmluZGV4T2YoIi4iKSkgPiAtMSkgc3RyID0gc3RyLnJlcGxhY2UoIi4iLCAiIik7CiAgICAgICAgaWYgKChpID0gc3RyLnNlYXJjaCgvZS9pKSkgPiAwKSB7CiAgICAgICAgICBpZiAoZSA8IDApIGUgPSBpOwogICAgICAgICAgZSArPSArc3RyLnNsaWNlKGkgKyAxKTsKICAgICAgICAgIHN0ciA9IHN0ci5zdWJzdHJpbmcoMCwgaSk7CiAgICAgICAgfSBlbHNlIGlmIChlIDwgMCkgewogICAgICAgICAgZSA9IHN0ci5sZW5ndGg7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDA7IHN0ci5jaGFyQ29kZUF0KGkpID09PSA0ODsgKSArK2k7CiAgICAgICAgZm9yIChsZW4gPSBzdHIubGVuZ3RoOyBzdHIuY2hhckNvZGVBdChsZW4gLSAxKSA9PT0gNDg7ICkgLS1sZW47CiAgICAgICAgc3RyID0gc3RyLnNsaWNlKGksIGxlbik7CiAgICAgICAgaWYgKHN0cikgewogICAgICAgICAgbGVuIC09IGk7CiAgICAgICAgICBlID0gZSAtIGkgLSAxOwogICAgICAgICAgeDIuZSA9IG1hdGhmbG9vcihlIC8gTE9HX0JBU0UpOwogICAgICAgICAgeDIuZCA9IFtdOwogICAgICAgICAgaSA9IChlICsgMSkgJSBMT0dfQkFTRTsKICAgICAgICAgIGlmIChlIDwgMCkgaSArPSBMT0dfQkFTRTsKICAgICAgICAgIGlmIChpIDwgbGVuKSB7CiAgICAgICAgICAgIGlmIChpKSB4Mi5kLnB1c2goK3N0ci5zbGljZSgwLCBpKSk7CiAgICAgICAgICAgIGZvciAobGVuIC09IExPR19CQVNFOyBpIDwgbGVuOyApIHgyLmQucHVzaCgrc3RyLnNsaWNlKGksIGkgKz0gTE9HX0JBU0UpKTsKICAgICAgICAgICAgc3RyID0gc3RyLnNsaWNlKGkpOwogICAgICAgICAgICBpID0gTE9HX0JBU0UgLSBzdHIubGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaSAtPSBsZW47CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKDsgaS0tOyApIHN0ciArPSAiMCI7CiAgICAgICAgICB4Mi5kLnB1c2goK3N0cik7CiAgICAgICAgICBpZiAoZXh0ZXJuYWwgJiYgKHgyLmUgPiBNQVhfRSB8fCB4Mi5lIDwgLU1BWF9FKSkgdGhyb3cgRXJyb3IoZXhwb25lbnRPdXRPZlJhbmdlICsgZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHgyLnMgPSAwOwogICAgICAgICAgeDIuZSA9IDA7CiAgICAgICAgICB4Mi5kID0gWzBdOwogICAgICAgIH0KICAgICAgICByZXR1cm4geDI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcm91bmQoeDIsIHNkLCBybSkgewogICAgICAgIHZhciBpLCBqLCBrLCBuLCByZCwgZG9Sb3VuZCwgdywgeGRpLCB4ZCA9IHgyLmQ7CiAgICAgICAgZm9yIChuID0gMSwgayA9IHhkWzBdOyBrID49IDEwOyBrIC89IDEwKSBuKys7CiAgICAgICAgaSA9IHNkIC0gbjsKICAgICAgICBpZiAoaSA8IDApIHsKICAgICAgICAgIGkgKz0gTE9HX0JBU0U7CiAgICAgICAgICBqID0gc2Q7CiAgICAgICAgICB3ID0geGRbeGRpID0gMF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHhkaSA9IE1hdGguY2VpbCgoaSArIDEpIC8gTE9HX0JBU0UpOwogICAgICAgICAgayA9IHhkLmxlbmd0aDsKICAgICAgICAgIGlmICh4ZGkgPj0gaykgcmV0dXJuIHgyOwogICAgICAgICAgdyA9IGsgPSB4ZFt4ZGldOwogICAgICAgICAgZm9yIChuID0gMTsgayA+PSAxMDsgayAvPSAxMCkgbisrOwogICAgICAgICAgaSAlPSBMT0dfQkFTRTsKICAgICAgICAgIGogPSBpIC0gTE9HX0JBU0UgKyBuOwogICAgICAgIH0KICAgICAgICBpZiAocm0gIT09IHZvaWQgMCkgewogICAgICAgICAgayA9IG1hdGhwb3coMTAsIG4gLSBqIC0gMSk7CiAgICAgICAgICByZCA9IHcgLyBrICUgMTAgfCAwOwogICAgICAgICAgZG9Sb3VuZCA9IHNkIDwgMCB8fCB4ZFt4ZGkgKyAxXSAhPT0gdm9pZCAwIHx8IHcgJSBrOwogICAgICAgICAgZG9Sb3VuZCA9IHJtIDwgNCA/IChyZCB8fCBkb1JvdW5kKSAmJiAocm0gPT0gMCB8fCBybSA9PSAoeDIucyA8IDAgPyAzIDogMikpIDogcmQgPiA1IHx8IHJkID09IDUgJiYgKHJtID09IDQgfHwgZG9Sb3VuZCB8fCBybSA9PSA2ICYmIC8vIENoZWNrIHdoZXRoZXIgdGhlIGRpZ2l0IHRvIHRoZSBsZWZ0IG9mIHRoZSByb3VuZGluZyBkaWdpdCBpcyBvZGQuCiAgICAgICAgICAoaSA+IDAgPyBqID4gMCA/IHcgLyBtYXRocG93KDEwLCBuIC0gaikgOiAwIDogeGRbeGRpIC0gMV0pICUgMTAgJiAxIHx8IHJtID09ICh4Mi5zIDwgMCA/IDggOiA3KSk7CiAgICAgICAgfQogICAgICAgIGlmIChzZCA8IDEgfHwgIXhkWzBdKSB7CiAgICAgICAgICBpZiAoZG9Sb3VuZCkgewogICAgICAgICAgICBrID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpOwogICAgICAgICAgICB4ZC5sZW5ndGggPSAxOwogICAgICAgICAgICBzZCA9IHNkIC0gayAtIDE7CiAgICAgICAgICAgIHhkWzBdID0gbWF0aHBvdygxMCwgKExPR19CQVNFIC0gc2QgJSBMT0dfQkFTRSkgJSBMT0dfQkFTRSk7CiAgICAgICAgICAgIHgyLmUgPSBtYXRoZmxvb3IoLXNkIC8gTE9HX0JBU0UpIHx8IDA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB4ZC5sZW5ndGggPSAxOwogICAgICAgICAgICB4ZFswXSA9IHgyLmUgPSB4Mi5zID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB4MjsKICAgICAgICB9CiAgICAgICAgaWYgKGkgPT0gMCkgewogICAgICAgICAgeGQubGVuZ3RoID0geGRpOwogICAgICAgICAgayA9IDE7CiAgICAgICAgICB4ZGktLTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeGQubGVuZ3RoID0geGRpICsgMTsKICAgICAgICAgIGsgPSBtYXRocG93KDEwLCBMT0dfQkFTRSAtIGkpOwogICAgICAgICAgeGRbeGRpXSA9IGogPiAwID8gKHcgLyBtYXRocG93KDEwLCBuIC0gaikgJSBtYXRocG93KDEwLCBqKSB8IDApICogayA6IDA7CiAgICAgICAgfQogICAgICAgIGlmIChkb1JvdW5kKSB7CiAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgaWYgKHhkaSA9PSAwKSB7CiAgICAgICAgICAgICAgaWYgKCh4ZFswXSArPSBrKSA9PSBCQVNFKSB7CiAgICAgICAgICAgICAgICB4ZFswXSA9IDE7CiAgICAgICAgICAgICAgICArK3gyLmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHhkW3hkaV0gKz0gazsKICAgICAgICAgICAgICBpZiAoeGRbeGRpXSAhPSBCQVNFKSBicmVhazsKICAgICAgICAgICAgICB4ZFt4ZGktLV0gPSAwOwogICAgICAgICAgICAgIGsgPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IHhkLmxlbmd0aDsgeGRbLS1pXSA9PT0gMDsgKSB4ZC5wb3AoKTsKICAgICAgICBpZiAoZXh0ZXJuYWwgJiYgKHgyLmUgPiBNQVhfRSB8fCB4Mi5lIDwgLU1BWF9FKSkgewogICAgICAgICAgdGhyb3cgRXJyb3IoZXhwb25lbnRPdXRPZlJhbmdlICsgZ2V0QmFzZTEwRXhwb25lbnQoeDIpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHgyOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHN1YnRyYWN0KHgyLCB5MikgewogICAgICAgIHZhciBkLCBlLCBpLCBqLCBrLCBsZW4sIHhkLCB4ZSwgeExUeSwgeWQsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoIXgyLnMgfHwgIXkyLnMpIHsKICAgICAgICAgIGlmICh5Mi5zKSB5Mi5zID0gLXkyLnM7CiAgICAgICAgICBlbHNlIHkyID0gbmV3IEN0b3IoeDIpOwogICAgICAgICAgcmV0dXJuIGV4dGVybmFsID8gcm91bmQoeTIsIHByKSA6IHkyOwogICAgICAgIH0KICAgICAgICB4ZCA9IHgyLmQ7CiAgICAgICAgeWQgPSB5Mi5kOwogICAgICAgIGUgPSB5Mi5lOwogICAgICAgIHhlID0geDIuZTsKICAgICAgICB4ZCA9IHhkLnNsaWNlKCk7CiAgICAgICAgayA9IHhlIC0gZTsKICAgICAgICBpZiAoaykgewogICAgICAgICAgeExUeSA9IGsgPCAwOwogICAgICAgICAgaWYgKHhMVHkpIHsKICAgICAgICAgICAgZCA9IHhkOwogICAgICAgICAgICBrID0gLWs7CiAgICAgICAgICAgIGxlbiA9IHlkLmxlbmd0aDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGQgPSB5ZDsKICAgICAgICAgICAgZSA9IHhlOwogICAgICAgICAgICBsZW4gPSB4ZC5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgICBpID0gTWF0aC5tYXgoTWF0aC5jZWlsKHByIC8gTE9HX0JBU0UpLCBsZW4pICsgMjsKICAgICAgICAgIGlmIChrID4gaSkgewogICAgICAgICAgICBrID0gaTsKICAgICAgICAgICAgZC5sZW5ndGggPSAxOwogICAgICAgICAgfQogICAgICAgICAgZC5yZXZlcnNlKCk7CiAgICAgICAgICBmb3IgKGkgPSBrOyBpLS07ICkgZC5wdXNoKDApOwogICAgICAgICAgZC5yZXZlcnNlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGkgPSB4ZC5sZW5ndGg7CiAgICAgICAgICBsZW4gPSB5ZC5sZW5ndGg7CiAgICAgICAgICB4TFR5ID0gaSA8IGxlbjsKICAgICAgICAgIGlmICh4TFR5KSBsZW4gPSBpOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmICh4ZFtpXSAhPSB5ZFtpXSkgewogICAgICAgICAgICAgIHhMVHkgPSB4ZFtpXSA8IHlkW2ldOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBrID0gMDsKICAgICAgICB9CiAgICAgICAgaWYgKHhMVHkpIHsKICAgICAgICAgIGQgPSB4ZDsKICAgICAgICAgIHhkID0geWQ7CiAgICAgICAgICB5ZCA9IGQ7CiAgICAgICAgICB5Mi5zID0gLXkyLnM7CiAgICAgICAgfQogICAgICAgIGxlbiA9IHhkLmxlbmd0aDsKICAgICAgICBmb3IgKGkgPSB5ZC5sZW5ndGggLSBsZW47IGkgPiAwOyAtLWkpIHhkW2xlbisrXSA9IDA7CiAgICAgICAgZm9yIChpID0geWQubGVuZ3RoOyBpID4gazsgKSB7CiAgICAgICAgICBpZiAoeGRbLS1pXSA8IHlkW2ldKSB7CiAgICAgICAgICAgIGZvciAoaiA9IGk7IGogJiYgeGRbLS1qXSA9PT0gMDsgKSB4ZFtqXSA9IEJBU0UgLSAxOwogICAgICAgICAgICAtLXhkW2pdOwogICAgICAgICAgICB4ZFtpXSArPSBCQVNFOwogICAgICAgICAgfQogICAgICAgICAgeGRbaV0gLT0geWRbaV07CiAgICAgICAgfQogICAgICAgIGZvciAoOyB4ZFstLWxlbl0gPT09IDA7ICkgeGQucG9wKCk7CiAgICAgICAgZm9yICg7IHhkWzBdID09PSAwOyB4ZC5zaGlmdCgpKSAtLWU7CiAgICAgICAgaWYgKCF4ZFswXSkgcmV0dXJuIG5ldyBDdG9yKDApOwogICAgICAgIHkyLmQgPSB4ZDsKICAgICAgICB5Mi5lID0gZTsKICAgICAgICByZXR1cm4gZXh0ZXJuYWwgPyByb3VuZCh5MiwgcHIpIDogeTI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdG9TdHJpbmcoeDIsIGlzRXhwLCBzZCkgewogICAgICAgIHZhciBrLCBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpLCBzdHIgPSBkaWdpdHNUb1N0cmluZyh4Mi5kKSwgbGVuID0gc3RyLmxlbmd0aDsKICAgICAgICBpZiAoaXNFeHApIHsKICAgICAgICAgIGlmIChzZCAmJiAoayA9IHNkIC0gbGVuKSA+IDApIHsKICAgICAgICAgICAgc3RyID0gc3RyLmNoYXJBdCgwKSArICIuIiArIHN0ci5zbGljZSgxKSArIGdldFplcm9TdHJpbmcoayk7CiAgICAgICAgICB9IGVsc2UgaWYgKGxlbiA+IDEpIHsKICAgICAgICAgICAgc3RyID0gc3RyLmNoYXJBdCgwKSArICIuIiArIHN0ci5zbGljZSgxKTsKICAgICAgICAgIH0KICAgICAgICAgIHN0ciA9IHN0ciArIChlIDwgMCA/ICJlIiA6ICJlKyIpICsgZTsKICAgICAgICB9IGVsc2UgaWYgKGUgPCAwKSB7CiAgICAgICAgICBzdHIgPSAiMC4iICsgZ2V0WmVyb1N0cmluZygtZSAtIDEpICsgc3RyOwogICAgICAgICAgaWYgKHNkICYmIChrID0gc2QgLSBsZW4pID4gMCkgc3RyICs9IGdldFplcm9TdHJpbmcoayk7CiAgICAgICAgfSBlbHNlIGlmIChlID49IGxlbikgewogICAgICAgICAgc3RyICs9IGdldFplcm9TdHJpbmcoZSArIDEgLSBsZW4pOwogICAgICAgICAgaWYgKHNkICYmIChrID0gc2QgLSBlIC0gMSkgPiAwKSBzdHIgPSBzdHIgKyAiLiIgKyBnZXRaZXJvU3RyaW5nKGspOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoKGsgPSBlICsgMSkgPCBsZW4pIHN0ciA9IHN0ci5zbGljZSgwLCBrKSArICIuIiArIHN0ci5zbGljZShrKTsKICAgICAgICAgIGlmIChzZCAmJiAoayA9IHNkIC0gbGVuKSA+IDApIHsKICAgICAgICAgICAgaWYgKGUgKyAxID09PSBsZW4pIHN0ciArPSAiLiI7CiAgICAgICAgICAgIHN0ciArPSBnZXRaZXJvU3RyaW5nKGspOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4geDIucyA8IDAgPyAiLSIgKyBzdHIgOiBzdHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdHJ1bmNhdGUoYXJyLCBsZW4pIHsKICAgICAgICBpZiAoYXJyLmxlbmd0aCA+IGxlbikgewogICAgICAgICAgYXJyLmxlbmd0aCA9IGxlbjsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBjbG9uZShvYmopIHsKICAgICAgICB2YXIgaSwgcCwgcHM7CiAgICAgICAgZnVuY3Rpb24gRGVjaW1hbDQodmFsdWUpIHsKICAgICAgICAgIHZhciB4MiA9IHRoaXM7CiAgICAgICAgICBpZiAoISh4MiBpbnN0YW5jZW9mIERlY2ltYWw0KSkgcmV0dXJuIG5ldyBEZWNpbWFsNCh2YWx1ZSk7CiAgICAgICAgICB4Mi5jb25zdHJ1Y3RvciA9IERlY2ltYWw0OwogICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGVjaW1hbDQpIHsKICAgICAgICAgICAgeDIucyA9IHZhbHVlLnM7CiAgICAgICAgICAgIHgyLmUgPSB2YWx1ZS5lOwogICAgICAgICAgICB4Mi5kID0gKHZhbHVlID0gdmFsdWUuZCkgPyB2YWx1ZS5zbGljZSgpIDogdmFsdWU7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAqIDAgIT09IDApIHsKICAgICAgICAgICAgICB0aHJvdyBFcnJvcihpbnZhbGlkQXJndW1lbnQgKyB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZhbHVlID4gMCkgewogICAgICAgICAgICAgIHgyLnMgPSAxOwogICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlIDwgMCkgewogICAgICAgICAgICAgIHZhbHVlID0gLXZhbHVlOwogICAgICAgICAgICAgIHgyLnMgPSAtMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB4Mi5zID0gMDsKICAgICAgICAgICAgICB4Mi5lID0gMDsKICAgICAgICAgICAgICB4Mi5kID0gWzBdOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmFsdWUgPT09IH5+dmFsdWUgJiYgdmFsdWUgPCAxZTcpIHsKICAgICAgICAgICAgICB4Mi5lID0gMDsKICAgICAgICAgICAgICB4Mi5kID0gW3ZhbHVlXTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhcnNlRGVjaW1hbCh4MiwgdmFsdWUudG9TdHJpbmcoKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdGhyb3cgRXJyb3IoaW52YWxpZEFyZ3VtZW50ICsgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbHVlLmNoYXJDb2RlQXQoMCkgPT09IDQ1KSB7CiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc2xpY2UoMSk7CiAgICAgICAgICAgIHgyLnMgPSAtMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHgyLnMgPSAxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzRGVjaW1hbC50ZXN0KHZhbHVlKSkgcGFyc2VEZWNpbWFsKHgyLCB2YWx1ZSk7CiAgICAgICAgICBlbHNlIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgRGVjaW1hbDQucHJvdG90eXBlID0gUDsKICAgICAgICBEZWNpbWFsNC5ST1VORF9VUCA9IDA7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfRE9XTiA9IDE7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfQ0VJTCA9IDI7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfRkxPT1IgPSAzOwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfVVAgPSA0OwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfRE9XTiA9IDU7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfSEFMRl9FVkVOID0gNjsKICAgICAgICBEZWNpbWFsNC5ST1VORF9IQUxGX0NFSUwgPSA3OwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfRkxPT1IgPSA4OwogICAgICAgIERlY2ltYWw0LmNsb25lID0gY2xvbmU7CiAgICAgICAgRGVjaW1hbDQuY29uZmlnID0gRGVjaW1hbDQuc2V0ID0gY29uZmlnOwogICAgICAgIGlmIChvYmogPT09IHZvaWQgMCkgb2JqID0ge307CiAgICAgICAgaWYgKG9iaikgewogICAgICAgICAgcHMgPSBbInByZWNpc2lvbiIsICJyb3VuZGluZyIsICJ0b0V4cE5lZyIsICJ0b0V4cFBvcyIsICJMTjEwIl07CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHMubGVuZ3RoOyApIGlmICghb2JqLmhhc093blByb3BlcnR5KHAgPSBwc1tpKytdKSkgb2JqW3BdID0gdGhpc1twXTsKICAgICAgICB9CiAgICAgICAgRGVjaW1hbDQuY29uZmlnKG9iaik7CiAgICAgICAgcmV0dXJuIERlY2ltYWw0OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNvbmZpZyhvYmopIHsKICAgICAgICBpZiAoIW9iaiB8fCB0eXBlb2Ygb2JqICE9PSAib2JqZWN0IikgewogICAgICAgICAgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk9iamVjdCBleHBlY3RlZCIpOwogICAgICAgIH0KICAgICAgICB2YXIgaSwgcCwgdiwgcHMgPSBbCiAgICAgICAgICAicHJlY2lzaW9uIiwKICAgICAgICAgIDEsCiAgICAgICAgICBNQVhfRElHSVRTLAogICAgICAgICAgInJvdW5kaW5nIiwKICAgICAgICAgIDAsCiAgICAgICAgICA4LAogICAgICAgICAgInRvRXhwTmVnIiwKICAgICAgICAgIC0xIC8gMCwKICAgICAgICAgIDAsCiAgICAgICAgICAidG9FeHBQb3MiLAogICAgICAgICAgMCwKICAgICAgICAgIDEgLyAwCiAgICAgICAgXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGlmICgodiA9IG9ialtwID0gcHNbaV1dKSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChtYXRoZmxvb3IodikgPT09IHYgJiYgdiA+PSBwc1tpICsgMV0gJiYgdiA8PSBwc1tpICsgMl0pIHRoaXNbcF0gPSB2OwogICAgICAgICAgICBlbHNlIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHAgKyAiOiAiICsgdik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICgodiA9IG9ialtwID0gIkxOMTAiXSkgIT09IHZvaWQgMCkgewogICAgICAgICAgaWYgKHYgPT0gTWF0aC5MTjEwKSB0aGlzW3BdID0gbmV3IHRoaXModik7CiAgICAgICAgICBlbHNlIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHAgKyAiOiAiICsgdik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIERlY2ltYWwzID0gY2xvbmUoRGVjaW1hbDMpOwogICAgICBEZWNpbWFsM1siZGVmYXVsdCJdID0gRGVjaW1hbDMuRGVjaW1hbCA9IERlY2ltYWwzOwogICAgICBPTkUgPSBuZXcgRGVjaW1hbDMoMSk7CiAgICAgIGlmICh0eXBlb2YgZGVmaW5lID09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgICAgIGRlZmluZShmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBEZWNpbWFsMzsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlICE9ICJ1bmRlZmluZWQiICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBEZWNpbWFsMzsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoIWdsb2JhbFNjb3BlKSB7CiAgICAgICAgICBnbG9iYWxTY29wZSA9IHR5cGVvZiBzZWxmICE9ICJ1bmRlZmluZWQiICYmIHNlbGYgJiYgc2VsZi5zZWxmID09IHNlbGYgPyBzZWxmIDogRnVuY3Rpb24oInJldHVybiB0aGlzIikoKTsKICAgICAgICB9CiAgICAgICAgZ2xvYmFsU2NvcGUuRGVjaW1hbCA9IERlY2ltYWwzOwogICAgICB9CiAgICB9KShleHBvcnRzKTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2V2ZW50ZW1pdHRlcjNANS4wLjEvbm9kZV9tb2R1bGVzL2V2ZW50ZW1pdHRlcjMvaW5kZXguanMKdmFyIHJlcXVpcmVfZXZlbnRlbWl0dGVyMyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXZlbnRlbWl0dGVyM0A1LjAuMS9ub2RlX21vZHVsZXMvZXZlbnRlbWl0dGVyMy9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgaGFzMyA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICB2YXIgcHJlZml4ID0gIn4iOwogICAgZnVuY3Rpb24gRXZlbnRzKCkgewogICAgfQogICAgaWYgKE9iamVjdC5jcmVhdGUpIHsKICAgICAgRXZlbnRzLnByb3RvdHlwZSA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBpZiAoIW5ldyBFdmVudHMoKS5fX3Byb3RvX18pIHByZWZpeCA9IGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24gRUUoZm4sIGNvbnRleHQsIG9uY2UpIHsKICAgICAgdGhpcy5mbiA9IGZuOwogICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogICAgICB0aGlzLm9uY2UgPSBvbmNlIHx8IGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24gYWRkTGlzdGVuZXIyKGVtaXR0ZXIsIGV2ZW50LCBmbiwgY29udGV4dCwgb25jZSkgewogICAgICBpZiAodHlwZW9mIGZuICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVGhlIGxpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgICB9CiAgICAgIHZhciBsaXN0ZW5lcjIgPSBuZXcgRUUoZm4sIGNvbnRleHQgfHwgZW1pdHRlciwgb25jZSksIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7CiAgICAgIGlmICghZW1pdHRlci5fZXZlbnRzW2V2dF0pIGVtaXR0ZXIuX2V2ZW50c1tldnRdID0gbGlzdGVuZXIyLCBlbWl0dGVyLl9ldmVudHNDb3VudCsrOwogICAgICBlbHNlIGlmICghZW1pdHRlci5fZXZlbnRzW2V2dF0uZm4pIGVtaXR0ZXIuX2V2ZW50c1tldnRdLnB1c2gobGlzdGVuZXIyKTsKICAgICAgZWxzZSBlbWl0dGVyLl9ldmVudHNbZXZ0XSA9IFtlbWl0dGVyLl9ldmVudHNbZXZ0XSwgbGlzdGVuZXIyXTsKICAgICAgcmV0dXJuIGVtaXR0ZXI7CiAgICB9CiAgICBmdW5jdGlvbiBjbGVhckV2ZW50KGVtaXR0ZXIsIGV2dCkgewogICAgICBpZiAoLS1lbWl0dGVyLl9ldmVudHNDb3VudCA9PT0gMCkgZW1pdHRlci5fZXZlbnRzID0gbmV3IEV2ZW50cygpOwogICAgICBlbHNlIGRlbGV0ZSBlbWl0dGVyLl9ldmVudHNbZXZ0XTsKICAgIH0KICAgIGZ1bmN0aW9uIEV2ZW50RW1pdHRlcjIoKSB7CiAgICAgIHRoaXMuX2V2ZW50cyA9IG5ldyBFdmVudHMoKTsKICAgICAgdGhpcy5fZXZlbnRzQ291bnQgPSAwOwogICAgfQogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUuZXZlbnROYW1lcyA9IGZ1bmN0aW9uIGV2ZW50TmFtZXMoKSB7CiAgICAgIHZhciBuYW1lcyA9IFtdLCBldmVudHMsIG5hbWU7CiAgICAgIGlmICh0aGlzLl9ldmVudHNDb3VudCA9PT0gMCkgcmV0dXJuIG5hbWVzOwogICAgICBmb3IgKG5hbWUgaW4gZXZlbnRzID0gdGhpcy5fZXZlbnRzKSB7CiAgICAgICAgaWYgKGhhczMuY2FsbChldmVudHMsIG5hbWUpKSBuYW1lcy5wdXNoKHByZWZpeCA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lKTsKICAgICAgfQogICAgICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgICAgIHJldHVybiBuYW1lcy5jb25jYXQoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhldmVudHMpKTsKICAgICAgfQogICAgICByZXR1cm4gbmFtZXM7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUubGlzdGVuZXJzID0gZnVuY3Rpb24gbGlzdGVuZXJzKGV2ZW50KSB7CiAgICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50LCBoYW5kbGVycyA9IHRoaXMuX2V2ZW50c1tldnRdOwogICAgICBpZiAoIWhhbmRsZXJzKSByZXR1cm4gW107CiAgICAgIGlmIChoYW5kbGVycy5mbikgcmV0dXJuIFtoYW5kbGVycy5mbl07CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gaGFuZGxlcnMubGVuZ3RoLCBlZSA9IG5ldyBBcnJheShsKTsgaSA8IGw7IGkrKykgewogICAgICAgIGVlW2ldID0gaGFuZGxlcnNbaV0uZm47CiAgICAgIH0KICAgICAgcmV0dXJuIGVlOwogICAgfTsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbiBsaXN0ZW5lckNvdW50KGV2ZW50KSB7CiAgICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50LCBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbZXZ0XTsKICAgICAgaWYgKCFsaXN0ZW5lcnMpIHJldHVybiAwOwogICAgICBpZiAobGlzdGVuZXJzLmZuKSByZXR1cm4gMTsKICAgICAgcmV0dXJuIGxpc3RlbmVycy5sZW5ndGg7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uIGVtaXQoZXZlbnQsIGExLCBhMiwgYTMsIGE0LCBhNSkgewogICAgICB2YXIgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDsKICAgICAgaWYgKCF0aGlzLl9ldmVudHNbZXZ0XSkgcmV0dXJuIGZhbHNlOwogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2dF0sIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MsIGk7CiAgICAgIGlmIChsaXN0ZW5lcnMuZm4pIHsKICAgICAgICBpZiAobGlzdGVuZXJzLm9uY2UpIHRoaXMucmVtb3ZlTGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVycy5mbiwgdm9pZCAwLCB0cnVlKTsKICAgICAgICBzd2l0Y2ggKGxlbikgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQpLCB0cnVlOwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExKSwgdHJ1ZTsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIpLCB0cnVlOwogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMpLCB0cnVlOwogICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMsIGE0KSwgdHJ1ZTsKICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIsIGEzLCBhNCwgYTUpLCB0cnVlOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAxLCBhcmdzID0gbmV3IEFycmF5KGxlbiAtIDEpOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwogICAgICAgIH0KICAgICAgICBsaXN0ZW5lcnMuZm4uYXBwbHkobGlzdGVuZXJzLmNvbnRleHQsIGFyZ3MpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoLCBqOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGxpc3RlbmVyc1tpXS5vbmNlKSB0aGlzLnJlbW92ZUxpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lcnNbaV0uZm4sIHZvaWQgMCwgdHJ1ZSk7CiAgICAgICAgICBzd2l0Y2ggKGxlbikgewogICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgIGxpc3RlbmVyc1tpXS5mbi5jYWxsKGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhMSwgYTIpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExLCBhMiwgYTMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmICghYXJncykgZm9yIChqID0gMSwgYXJncyA9IG5ldyBBcnJheShsZW4gLSAxKTsgaiA8IGxlbjsgaisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW2ogLSAxXSA9IGFyZ3VtZW50c1tqXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmFwcGx5KGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhcmdzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUub24gPSBmdW5jdGlvbiBvbihldmVudCwgZm4sIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIGFkZExpc3RlbmVyMih0aGlzLCBldmVudCwgZm4sIGNvbnRleHQsIGZhbHNlKTsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gb25jZShldmVudCwgZm4sIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIGFkZExpc3RlbmVyMih0aGlzLCBldmVudCwgZm4sIGNvbnRleHQsIHRydWUpOwogICAgfTsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyID0gZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIyKGV2ZW50LCBmbiwgY29udGV4dCwgb25jZSkgewogICAgICB2YXIgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDsKICAgICAgaWYgKCF0aGlzLl9ldmVudHNbZXZ0XSkgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghZm4pIHsKICAgICAgICBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1tldnRdOwogICAgICBpZiAobGlzdGVuZXJzLmZuKSB7CiAgICAgICAgaWYgKGxpc3RlbmVycy5mbiA9PT0gZm4gJiYgKCFvbmNlIHx8IGxpc3RlbmVycy5vbmNlKSAmJiAoIWNvbnRleHQgfHwgbGlzdGVuZXJzLmNvbnRleHQgPT09IGNvbnRleHQpKSB7CiAgICAgICAgICBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBldmVudHMgPSBbXSwgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAobGlzdGVuZXJzW2ldLmZuICE9PSBmbiB8fCBvbmNlICYmICFsaXN0ZW5lcnNbaV0ub25jZSB8fCBjb250ZXh0ICYmIGxpc3RlbmVyc1tpXS5jb250ZXh0ICE9PSBjb250ZXh0KSB7CiAgICAgICAgICAgIGV2ZW50cy5wdXNoKGxpc3RlbmVyc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChldmVudHMubGVuZ3RoKSB0aGlzLl9ldmVudHNbZXZ0XSA9IGV2ZW50cy5sZW5ndGggPT09IDEgPyBldmVudHNbMF0gOiBldmVudHM7CiAgICAgICAgZWxzZSBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUucmVtb3ZlQWxsTGlzdGVuZXJzID0gZnVuY3Rpb24gcmVtb3ZlQWxsTGlzdGVuZXJzKGV2ZW50KSB7CiAgICAgIHZhciBldnQ7CiAgICAgIGlmIChldmVudCkgewogICAgICAgIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7CiAgICAgICAgaWYgKHRoaXMuX2V2ZW50c1tldnRdKSBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzID0gbmV3IEV2ZW50cygpOwogICAgICAgIHRoaXMuX2V2ZW50c0NvdW50ID0gMDsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5vZmYgPSBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lcjsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLmFkZExpc3RlbmVyID0gRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUub247CiAgICBFdmVudEVtaXR0ZXIyLnByZWZpeGVkID0gcHJlZml4OwogICAgRXZlbnRFbWl0dGVyMi5FdmVudEVtaXR0ZXIgPSBFdmVudEVtaXR0ZXIyOwogICAgaWYgKCJ1bmRlZmluZWQiICE9PSB0eXBlb2YgbW9kdWxlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gRXZlbnRFbWl0dGVyMjsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvYXJyYXkvbGFzdC5qcwp2YXIgcmVxdWlyZV9sYXN0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L2xhc3QuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gbGFzdDIoYXJyKSB7CiAgICAgIHJldHVybiBhcnJbYXJyLmxlbmd0aCAtIDFdOwogICAgfQogICAgZXhwb3J0cy5sYXN0ID0gbGFzdDI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdG9BcnJheS5qcwp2YXIgcmVxdWlyZV90b0FycmF5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdG9BcnJheS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiB0b0FycmF5Mih2YWx1ZSkgewogICAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZSkgPyB2YWx1ZSA6IEFycmF5LmZyb20odmFsdWUpOwogICAgfQogICAgZXhwb3J0cy50b0FycmF5ID0gdG9BcnJheTI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9sYXN0LmpzCnZhciByZXF1aXJlX2xhc3QyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9sYXN0LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBsYXN0JDEgPSByZXF1aXJlX2xhc3QoKTsKICAgIHZhciB0b0FycmF5MiA9IHJlcXVpcmVfdG9BcnJheSgpOwogICAgdmFyIGlzQXJyYXlMaWtlID0gcmVxdWlyZV9pc0FycmF5TGlrZSgpOwogICAgZnVuY3Rpb24gbGFzdDIoYXJyYXkpIHsKICAgICAgaWYgKCFpc0FycmF5TGlrZS5pc0FycmF5TGlrZShhcnJheSkpIHsKICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9CiAgICAgIHJldHVybiBsYXN0JDEubGFzdCh0b0FycmF5Mi50b0FycmF5KGFycmF5KSk7CiAgICB9CiAgICBleHBvcnRzLmxhc3QgPSBsYXN0MjsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9sYXN0LmpzCnZhciByZXF1aXJlX2xhc3QzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvbGFzdC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfbGFzdDIoKS5sYXN0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmVAMS42LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV91c2Vfc3luY19leHRlcm5hbF9zdG9yZV93aXRoX3NlbGVjdG9yX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS91c2Utc3luYy1leHRlcm5hbC1zdG9yZUAxLjYuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS13aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICAoZnVuY3Rpb24oKSB7CiAgICAgIGZ1bmN0aW9uIGlzNCh4MiwgeTIpIHsKICAgICAgICByZXR1cm4geDIgPT09IHkyICYmICgwICE9PSB4MiB8fCAxIC8geDIgPT09IDEgLyB5MikgfHwgeDIgIT09IHgyICYmIHkyICE9PSB5MjsKICAgICAgfQogICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCAmJiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0KEVycm9yKCkpOwogICAgICB2YXIgUmVhY3QzOSA9IHJlcXVpcmVfcmVhY3QoKSwgb2JqZWN0SXMgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgT2JqZWN0LmlzID8gT2JqZWN0LmlzIDogaXM0LCB1c2VTeW5jRXh0ZXJuYWxTdG9yZTIgPSBSZWFjdDM5LnVzZVN5bmNFeHRlcm5hbFN0b3JlLCB1c2VSZWYxNiA9IFJlYWN0MzkudXNlUmVmLCB1c2VFZmZlY3QxNCA9IFJlYWN0MzkudXNlRWZmZWN0LCB1c2VNZW1vOSA9IFJlYWN0MzkudXNlTWVtbywgdXNlRGVidWdWYWx1ZTIgPSBSZWFjdDM5LnVzZURlYnVnVmFsdWU7CiAgICAgIGV4cG9ydHMudXNlU3luY0V4dGVybmFsU3RvcmVXaXRoU2VsZWN0b3IgPSBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCwgc2VsZWN0b3IsIGlzRXF1YWwpIHsKICAgICAgICB2YXIgaW5zdFJlZiA9IHVzZVJlZjE2KG51bGwpOwogICAgICAgIGlmIChudWxsID09PSBpbnN0UmVmLmN1cnJlbnQpIHsKICAgICAgICAgIHZhciBpbnN0ID0geyBoYXNWYWx1ZTogZmFsc2UsIHZhbHVlOiBudWxsIH07CiAgICAgICAgICBpbnN0UmVmLmN1cnJlbnQgPSBpbnN0OwogICAgICAgIH0gZWxzZSBpbnN0ID0gaW5zdFJlZi5jdXJyZW50OwogICAgICAgIGluc3RSZWYgPSB1c2VNZW1vOSgKICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmdW5jdGlvbiBtZW1vaXplZFNlbGVjdG9yKG5leHRTbmFwc2hvdCkgewogICAgICAgICAgICAgIGlmICghaGFzTWVtbykgewogICAgICAgICAgICAgICAgaGFzTWVtbyA9IHRydWU7CiAgICAgICAgICAgICAgICBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICAgICAgbmV4dFNuYXBzaG90ID0gc2VsZWN0b3IobmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IGlzRXF1YWwgJiYgaW5zdC5oYXNWYWx1ZSkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFNlbGVjdGlvbiA9IGluc3QudmFsdWU7CiAgICAgICAgICAgICAgICAgIGlmIChpc0VxdWFsKGN1cnJlbnRTZWxlY3Rpb24sIG5leHRTbmFwc2hvdCkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0aW9uID0gY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudFNlbGVjdGlvbiA9IG1lbW9pemVkU2VsZWN0aW9uOwogICAgICAgICAgICAgIGlmIChvYmplY3RJcyhtZW1vaXplZFNuYXBzaG90LCBuZXh0U25hcHNob3QpKQogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgICAgdmFyIG5leHRTZWxlY3Rpb24gPSBzZWxlY3RvcihuZXh0U25hcHNob3QpOwogICAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IGlzRXF1YWwgJiYgaXNFcXVhbChjdXJyZW50U2VsZWN0aW9uLCBuZXh0U2VsZWN0aW9uKSkKICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90LCBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICAgIG1lbW9pemVkU25hcHNob3QgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0aW9uID0gbmV4dFNlbGVjdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzTWVtbyA9IGZhbHNlLCBtZW1vaXplZFNuYXBzaG90LCBtZW1vaXplZFNlbGVjdGlvbiwgbWF5YmVHZXRTZXJ2ZXJTbmFwc2hvdCA9IHZvaWQgMCA9PT0gZ2V0U2VydmVyU25hcHNob3QgPyBudWxsIDogZ2V0U2VydmVyU25hcHNob3Q7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3RvcihnZXRTbmFwc2hvdCgpKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG51bGwgPT09IG1heWJlR2V0U2VydmVyU25hcHNob3QgPyB2b2lkIDAgOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdG9yKG1heWJlR2V0U2VydmVyU25hcHNob3QoKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBdOwogICAgICAgICAgfSwKICAgICAgICAgIFtnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QsIHNlbGVjdG9yLCBpc0VxdWFsXQogICAgICAgICk7CiAgICAgICAgdmFyIHZhbHVlID0gdXNlU3luY0V4dGVybmFsU3RvcmUyKHN1YnNjcmliZSwgaW5zdFJlZlswXSwgaW5zdFJlZlsxXSk7CiAgICAgICAgdXNlRWZmZWN0MTQoCiAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5zdC5oYXNWYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGluc3QudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgIH0sCiAgICAgICAgICBbdmFsdWVdCiAgICAgICAgKTsKICAgICAgICB1c2VEZWJ1Z1ZhbHVlMih2YWx1ZSk7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9OwogICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChFcnJvcigpKTsKICAgIH0pKCk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS91c2Utc3luYy1leHRlcm5hbC1zdG9yZUAxLjYuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3dpdGgtc2VsZWN0b3IuanMKdmFyIHJlcXVpcmVfd2l0aF9zZWxlY3RvcjIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlQDEuNi4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvd2l0aC1zZWxlY3Rvci5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3VzZV9zeW5jX2V4dGVybmFsX3N0b3JlX3dpdGhfc2VsZWN0b3JfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3JlYWN0X2pzeF9ydW50aW1lX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0L2Nqcy9yZWFjdC1qc3gtcnVudGltZS5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKHRydWUpIHsKICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgUmVhY3QzOSA9IHJlcXVpcmVfcmVhY3QoKTsKICAgICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZWxlbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9QT1JUQUxfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnBvcnRhbCIpOwogICAgICAgIHZhciBSRUFDVF9GUkFHTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZnJhZ21lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfU1RSSUNUX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN0cmljdF9tb2RlIik7CiAgICAgICAgdmFyIFJFQUNUX1BST0ZJTEVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm9maWxlciIpOwogICAgICAgIHZhciBSRUFDVF9QUk9WSURFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvdmlkZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfQ09OVEVYVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY29udGV4dCIpOwogICAgICAgIHZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0LmZvcndhcmRfcmVmIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZSIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZV9saXN0Iik7CiAgICAgICAgdmFyIFJFQUNUX01FTU9fVFlQRTIgPSBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CiAgICAgICAgdmFyIFJFQUNUX0xBWllfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmxhenkiKTsKICAgICAgICB2YXIgUkVBQ1RfT0ZGU0NSRUVOX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5vZmZzY3JlZW4iKTsKICAgICAgICB2YXIgTUFZQkVfSVRFUkFUT1JfU1lNQk9MID0gU3ltYm9sLml0ZXJhdG9yOwogICAgICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICJAQGl0ZXJhdG9yIjsKICAgICAgICBmdW5jdGlvbiBnZXRJdGVyYXRvckZuKG1heWJlSXRlcmFibGUpIHsKICAgICAgICAgIGlmIChtYXliZUl0ZXJhYmxlID09PSBudWxsIHx8IHR5cGVvZiBtYXliZUl0ZXJhYmxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXliZUl0ZXJhdG9yID0gTUFZQkVfSVRFUkFUT1JfU1lNQk9MICYmIG1heWJlSXRlcmFibGVbTUFZQkVfSVRFUkFUT1JfU1lNQk9MXSB8fCBtYXliZUl0ZXJhYmxlW0ZBVVhfSVRFUkFUT1JfU1lNQk9MXTsKICAgICAgICAgIGlmICh0eXBlb2YgbWF5YmVJdGVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gbWF5YmVJdGVyYXRvcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RTaGFyZWRJbnRlcm5hbHMgPSBSZWFjdDM5Ll9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiA+IDEgPyBfbGVuMiAtIDEgOiAwKSwgX2tleTIgPSAxOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoImVycm9yIiwgZm9ybWF0MiwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJpbnRXYXJuaW5nKGxldmVsLCBmb3JtYXQyLCBhcmdzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICAgIHZhciBzdGFjayA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUyLmdldFN0YWNrQWRkZW5kdW0oKTsKICAgICAgICAgICAgaWYgKHN0YWNrICE9PSAiIikgewogICAgICAgICAgICAgIGZvcm1hdDIgKz0gIiVzIjsKICAgICAgICAgICAgICBhcmdzID0gYXJncy5jb25jYXQoW3N0YWNrXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3NXaXRoRm9ybWF0ID0gYXJncy5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgIHJldHVybiBTdHJpbmcoaXRlbSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhcmdzV2l0aEZvcm1hdC51bnNoaWZ0KCJXYXJuaW5nOiAiICsgZm9ybWF0Mik7CiAgICAgICAgICAgIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKGNvbnNvbGVbbGV2ZWxdLCBjb25zb2xlLCBhcmdzV2l0aEZvcm1hdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBlbmFibGVTY29wZUFQSSA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVDYWNoZUVsZW1lbnQgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlVHJhbnNpdGlvblRyYWNpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlTGVnYWN5SGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZURlYnVnVHJhY2luZyA9IGZhbHNlOwogICAgICAgIHZhciBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFOwogICAgICAgIHsKICAgICAgICAgIFJFQUNUX01PRFVMRV9SRUZFUkVOQ0UgPSBTeW1ib2wuZm9yKCJyZWFjdC5tb2R1bGUucmVmZXJlbmNlIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciIHx8IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfUFJPRklMRVJfVFlQRSB8fCBlbmFibGVEZWJ1Z1RyYWNpbmcgfHwgdHlwZSA9PT0gUkVBQ1RfU1RSSUNUX01PREVfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSB8fCBlbmFibGVMZWdhY3lIaWRkZW4gfHwgdHlwZSA9PT0gUkVBQ1RfT0ZGU0NSRUVOX1RZUEUgfHwgZW5hYmxlU2NvcGVBUEkgfHwgZW5hYmxlQ2FjaGVFbGVtZW50IHx8IGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFMiB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9QUk9WSURFUl9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0NPTlRFWFRfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiB8fCAvLyBUaGlzIG5lZWRzIHRvIGluY2x1ZGUgYWxsIHBvc3NpYmxlIG1vZHVsZSByZWZlcmVuY2Ugb2JqZWN0CiAgICAgICAgICAgIC8vIHR5cGVzIHN1cHBvcnRlZCBieSBhbnkgRmxpZ2h0IGNvbmZpZ3VyYXRpb24gYW55d2hlcmUgc2luY2UKICAgICAgICAgICAgLy8gd2UgZG9uJ3Qga25vdyB3aGljaCBGbGlnaHQgYnVpbGQgdGhpcyB3aWxsIGVuZCB1cCBiZWluZyB1c2VkCiAgICAgICAgICAgIC8vIHdpdGguCiAgICAgICAgICAgIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01PRFVMRV9SRUZFUkVOQ0UgfHwgdHlwZS5nZXRNb2R1bGVJZCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUob3V0ZXJUeXBlLCBpbm5lclR5cGUsIHdyYXBwZXJOYW1lKSB7CiAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSBvdXRlclR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICBpZiAoZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlLnRhZyA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgYW4gdW5leHBlY3RlZCBvYmplY3QgaW4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKCkuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQb3J0YWwiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQcm9maWxlciI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN0cmljdE1vZGUiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2VMaXN0IjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05URVhUX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUoY29udGV4dCkgKyAiLkNvbnN1bWVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgYXNzaWduMiA9IE9iamVjdC5hc3NpZ247CiAgICAgICAgdmFyIGRpc2FibGVkRGVwdGggPSAwOwogICAgICAgIHZhciBwcmV2TG9nOwogICAgICAgIHZhciBwcmV2SW5mbzsKICAgICAgICB2YXIgcHJldldhcm47CiAgICAgICAgdmFyIHByZXZFcnJvcjsKICAgICAgICB2YXIgcHJldkdyb3VwOwogICAgICAgIHZhciBwcmV2R3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgdmFyIHByZXZHcm91cEVuZDsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlZExvZygpIHsKICAgICAgICB9CiAgICAgICAgZGlzYWJsZWRMb2cuX19yZWFjdERpc2FibGVkTG9nID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICBwcmV2TG9nID0gY29uc29sZS5sb2c7CiAgICAgICAgICAgICAgcHJldkluZm8gPSBjb25zb2xlLmluZm87CiAgICAgICAgICAgICAgcHJldldhcm4gPSBjb25zb2xlLndhcm47CiAgICAgICAgICAgICAgcHJldkVycm9yID0gY29uc29sZS5lcnJvcjsKICAgICAgICAgICAgICBwcmV2R3JvdXAgPSBjb25zb2xlLmdyb3VwOwogICAgICAgICAgICAgIHByZXZHcm91cENvbGxhcHNlZCA9IGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgICAgICAgcHJldkdyb3VwRW5kID0gY29uc29sZS5ncm91cEVuZDsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IGRpc2FibGVkTG9nLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGluZm86IHByb3BzLAogICAgICAgICAgICAgICAgbG9nOiBwcm9wcywKICAgICAgICAgICAgICAgIHdhcm46IHByb3BzLAogICAgICAgICAgICAgICAgZXJyb3I6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXA6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IHByb3BzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlzYWJsZWREZXB0aCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVuYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgtLTsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGxvZzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHdhcm46IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2V2FybgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBlcnJvcjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cENvbGxhcHNlZAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cEVuZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICB2YXIgcHJlZml4OwogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0geDIuc3RhY2sudHJpbSgpLm1hdGNoKC9cbiggKihhdCApPykvKTsKICAgICAgICAgICAgICAgIHByZWZpeCA9IG1hdGNoICYmIG1hdGNoWzFdIHx8ICIiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIlxuIiArIHByZWZpeCArIG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbXBvbmVudEZyYW1lQ2FjaGU7CiAgICAgICAgewogICAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCA9IHR5cGVvZiBXZWFrTWFwID09PSAiZnVuY3Rpb24iID8gV2Vha01hcCA6IE1hcDsKICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGNvbnN0cnVjdCkgewogICAgICAgICAgaWYgKCFmbiB8fCByZWVudHJ5KSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZyYW1lID0gY29tcG9uZW50RnJhbWVDYWNoZS5nZXQoZm4pOwogICAgICAgICAgICBpZiAoZnJhbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiBmcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRyb2w7CiAgICAgICAgICByZWVudHJ5ID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlID0gRXJyb3IucHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHZvaWQgMDsKICAgICAgICAgIHZhciBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByZXZpb3VzRGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudDsKICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgZGlzYWJsZUxvZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChjb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICB2YXIgRmFrZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShGYWtlLnByb3RvdHlwZSwgInByb3BzIiwgewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09ICJvYmplY3QiICYmIFJlZmxlY3QuY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChGYWtlLCBbXSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChmbiwgW10sIEZha2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBGYWtlLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChzYW1wbGUpIHsKICAgICAgICAgICAgaWYgKHNhbXBsZSAmJiBjb250cm9sICYmIHR5cGVvZiBzYW1wbGUuc3RhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgdmFyIHNhbXBsZUxpbmVzID0gc2FtcGxlLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBjb250cm9sTGluZXMgPSBjb250cm9sLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBzID0gc2FtcGxlTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB2YXIgYyA9IGNvbnRyb2xMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHdoaWxlIChzID49IDEgJiYgYyA+PSAwICYmIHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICg7IHMgPj0gMSAmJiBjID49IDA7IHMtLSwgYy0tKSB7CiAgICAgICAgICAgICAgICBpZiAoc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICBpZiAocyAhPT0gMSB8fCBjICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgcy0tOwogICAgICAgICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGMgPCAwIHx8IHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9mcmFtZSA9ICJcbiIgKyBzYW1wbGVMaW5lc1tzXS5yZXBsYWNlKCIgYXQgbmV3ICIsICIgYXQgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbi5kaXNwbGF5TmFtZSAmJiBfZnJhbWUuaW5jbHVkZXMoIjxhbm9ueW1vdXM+IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBfZnJhbWUgPSBfZnJhbWUucmVwbGFjZSgiPGFub255bW91cz4iLCBmbi5kaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBfZnJhbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2ZyYW1lOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKHMgPj0gMSAmJiBjID49IDApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50ID0gcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgICAgIHJlZW5hYmxlTG9ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lID0gZm4gPyBmbi5kaXNwbGF5TmFtZSB8fCBmbi5uYW1lIDogIiI7CiAgICAgICAgICB2YXIgc3ludGhldGljRnJhbWUgPSBuYW1lID8gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSkgOiAiIjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBzeW50aGV0aWNGcmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzeW50aGV0aWNGcmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZuLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0KENvbXBvbmVudCkgewogICAgICAgICAgdmFyIHByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgICByZXR1cm4gISEocHJvdG90eXBlICYmIHByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKHR5cGUsIHNob3VsZENvbnN0cnVjdCh0eXBlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKHR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgICAgICB2YXIgbG9nZ2VkVHlwZUZhaWx1cmVzID0ge307CiAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1Byb3BUeXBlcyh0eXBlU3BlY3MsIHZhbHVlcywgbG9jYXRpb24sIGNvbXBvbmVudE5hbWUsIGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhczMgPSBGdW5jdGlvbi5jYWxsLmJpbmQoaGFzT3duUHJvcGVydHkpOwogICAgICAgICAgICBmb3IgKHZhciB0eXBlU3BlY05hbWUgaW4gdHlwZVNwZWNzKSB7CiAgICAgICAgICAgICAgaWYgKGhhczModHlwZVNwZWNzLCB0eXBlU3BlY05hbWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IkMSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyID0gRXJyb3IoKGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIikgKyAiOiAiICsgbG9jYXRpb24gKyAiIHR5cGUgYCIgKyB0eXBlU3BlY05hbWUgKyAiYCBpcyBpbnZhbGlkOyBpdCBtdXN0IGJlIGEgZnVuY3Rpb24sIHVzdWFsbHkgZnJvbSB0aGUgYHByb3AtdHlwZXNgIHBhY2thZ2UsIGJ1dCByZWNlaXZlZCBgIiArIHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSArICJgLlRoaXMgb2Z0ZW4gaGFwcGVucyBiZWNhdXNlIG9mIHR5cG9zIHN1Y2ggYXMgYFByb3BUeXBlcy5mdW5jdGlvbmAgaW5zdGVhZCBvZiBgUHJvcFR5cGVzLmZ1bmNgLiIpOwogICAgICAgICAgICAgICAgICAgIGVyci5uYW1lID0gIkludmFyaWFudCBWaW9sYXRpb24iOwogICAgICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlcnJvciQxID0gdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0odmFsdWVzLCB0eXBlU3BlY05hbWUsIGNvbXBvbmVudE5hbWUsIGxvY2F0aW9uLCBudWxsLCAiU0VDUkVUX0RPX05PVF9QQVNTX1RISVNfT1JfWU9VX1dJTExfQkVfRklSRUQiKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSBleDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxICYmICEoZXJyb3IkMSBpbnN0YW5jZW9mIEVycm9yKSkgewogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiB0eXBlIHNwZWNpZmljYXRpb24gb2YgJXMgYCVzYCBpcyBpbnZhbGlkOyB0aGUgdHlwZSBjaGVja2VyIGZ1bmN0aW9uIG11c3QgcmV0dXJuIGBudWxsYCBvciBhbiBgRXJyb3JgIGJ1dCByZXR1cm5lZCBhICVzLiBZb3UgbWF5IGhhdmUgZm9yZ290dGVuIHRvIHBhc3MgYW4gYXJndW1lbnQgdG8gdGhlIHR5cGUgY2hlY2tlciBjcmVhdG9yIChhcnJheU9mLCBpbnN0YW5jZU9mLCBvYmplY3RPZiwgb25lT2YsIG9uZU9mVHlwZSwgYW5kIHNoYXBlIGFsbCByZXF1aXJlIGFuIGFyZ3VtZW50KS4iLCBjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIsIGxvY2F0aW9uLCB0eXBlU3BlY05hbWUsIHR5cGVvZiBlcnJvciQxKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSBpbnN0YW5jZW9mIEVycm9yICYmICEoZXJyb3IkMS5tZXNzYWdlIGluIGxvZ2dlZFR5cGVGYWlsdXJlcykpIHsKICAgICAgICAgICAgICAgICAgbG9nZ2VkVHlwZUZhaWx1cmVzW2Vycm9yJDEubWVzc2FnZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIkZhaWxlZCAlcyB0eXBlOiAlcyIsIGxvY2F0aW9uLCBlcnJvciQxLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzQXJyYXlJbXBsID0gQXJyYXkuaXNBcnJheTsKICAgICAgICBmdW5jdGlvbiBpc0FycmF5MihhKSB7CiAgICAgICAgICByZXR1cm4gaXNBcnJheUltcGwoYSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHR5cGVOYW1lKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXNUb1N0cmluZ1RhZyA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgU3ltYm9sLnRvU3RyaW5nVGFnOwogICAgICAgICAgICB2YXIgdHlwZSA9IGhhc1RvU3RyaW5nVGFnICYmIHZhbHVlW1N5bWJvbC50b1N0cmluZ1RhZ10gfHwgdmFsdWUuY29uc3RydWN0b3IubmFtZSB8fCAiT2JqZWN0IjsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0tleVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGtleSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgUkVTRVJWRURfUFJPUFMgPSB7CiAgICAgICAgICBrZXk6IHRydWUsCiAgICAgICAgICByZWY6IHRydWUsCiAgICAgICAgICBfX3NlbGY6IHRydWUsCiAgICAgICAgICBfX3NvdXJjZTogdHJ1ZQogICAgICAgIH07CiAgICAgICAgdmFyIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duOwogICAgICAgIHZhciBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93bjsKICAgICAgICB2YXIgZGlkV2FybkFib3V0U3RyaW5nUmVmczsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkUmVmKGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJyZWYiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgInJlZiIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5yZWYgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRLZXkoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgImtleSIpKSB7CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAia2V5IikuZ2V0OwogICAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29uZmlnLmtleSAhPT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnLCBzZWxmMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5yZWYgPT09ICJzdHJpbmciICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQgJiYgc2VsZjIgJiYgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC5zdGF0ZU5vZGUgIT09IHNlbGYyKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCdDb21wb25lbnQgIiVzIiBjb250YWlucyB0aGUgc3RyaW5nIHJlZiAiJXMiLiBTdXBwb3J0IGZvciBzdHJpbmcgcmVmcyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gVGhpcyBjYXNlIGNhbm5vdCBiZSBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBhbiBhcnJvdyBmdW5jdGlvbi4gV2UgYXNrIHlvdSB0byBtYW51YWxseSBmaXggdGhpcyBjYXNlIGJ5IHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC50eXBlKSwgY29uZmlnLnJlZik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGBrZXlgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICJrZXkiLCB7CiAgICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdLZXksCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWZpbmVSZWZQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHdhcm5BYm91dEFjY2Vzc2luZ1JlZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmICghc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICAgIHNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogYHJlZmAgaXMgbm90IGEgcHJvcC4gVHJ5aW5nIHRvIGFjY2VzcyBpdCB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBiZWluZyByZXR1cm5lZC4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzYW1lIHZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgcHJvcC4gKGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zcGVjaWFsLXByb3BzKSIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdhcm5BYm91dEFjY2Vzc2luZ1JlZi5pc1JlYWN0V2FybmluZyA9IHRydWU7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgInJlZiIsIHsKICAgICAgICAgICAgICBnZXQ6IHdhcm5BYm91dEFjY2Vzc2luZ1JlZiwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEVsZW1lbnQgPSBmdW5jdGlvbih0eXBlLCBrZXksIHJlZiwgc2VsZjIsIHNvdXJjZSwgb3duZXIsIHByb3BzKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3dzIHVzIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IHRoaXMgYXMgYSBSZWFjdCBFbGVtZW50CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9FTEVNRU5UX1RZUEUsCiAgICAgICAgICAgIC8vIEJ1aWx0LWluIHByb3BlcnRpZXMgdGhhdCBiZWxvbmcgb24gdGhlIGVsZW1lbnQKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAga2V5LAogICAgICAgICAgICByZWYsCiAgICAgICAgICAgIHByb3BzLAogICAgICAgICAgICAvLyBSZWNvcmQgdGhlIGNvbXBvbmVudCByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgdGhpcyBlbGVtZW50LgogICAgICAgICAgICBfb3duZXI6IG93bmVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBlbGVtZW50Ll9zdG9yZSA9IHt9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudC5fc3RvcmUsICJ2YWxpZGF0ZWQiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NlbGYiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgdmFsdWU6IHNlbGYyCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudCwgIl9zb3VyY2UiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgdmFsdWU6IHNvdXJjZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKE9iamVjdC5mcmVlemUpIHsKICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24ganN4REVWKHR5cGUsIGNvbmZpZywgbWF5YmVLZXksIHNvdXJjZSwgc2VsZjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHByb3BOYW1lOwogICAgICAgICAgICB2YXIgcHJvcHMgPSB7fTsKICAgICAgICAgICAgdmFyIGtleSA9IG51bGw7CiAgICAgICAgICAgIHZhciByZWYgPSBudWxsOwogICAgICAgICAgICBpZiAobWF5YmVLZXkgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24obWF5YmVLZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIG1heWJlS2V5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNWYWxpZEtleShjb25maWcpKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihjb25maWcua2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAga2V5ID0gIiIgKyBjb25maWcua2V5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgICB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnLCBzZWxmMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChwcm9wTmFtZSBpbiBjb25maWcpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsIHByb3BOYW1lKSAmJiAhUkVTRVJWRURfUFJPUFMuaGFzT3duUHJvcGVydHkocHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBjb25maWdbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSAmJiB0eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHMgPSB0eXBlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGRlZmF1bHRQcm9wc1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChrZXkgfHwgcmVmKSB7CiAgICAgICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIgPyB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCAiVW5rbm93biIgOiB0eXBlOwogICAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICAgIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZWYpIHsKICAgICAgICAgICAgICAgIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQodHlwZSwga2V5LCByZWYsIHNlbGYyLCBzb3VyY2UsIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQsIHByb3BzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duOwogICAgICAgIHsKICAgICAgICAgIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50MTUob2JqZWN0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAib2JqZWN0IiAmJiBvYmplY3QgIT09IG51bGwgJiYgb2JqZWN0LiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCkgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBuYW1lICsgImAuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHNvdXJjZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGZpbGVOYW1lID0gc291cmNlLmZpbGVOYW1lLnJlcGxhY2UoL14uKltcXFwvXS8sICIiKTsKICAgICAgICAgICAgICB2YXIgbGluZU51bWJlciA9IHNvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHlvdXIgY29kZSBhdCAiICsgZmlsZU5hbWUgKyAiOiIgKyBsaW5lTnVtYmVyICsgIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZyA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5mbyA9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoIWluZm8pIHsKICAgICAgICAgICAgICB2YXIgcGFyZW50TmFtZSA9IHR5cGVvZiBwYXJlbnRUeXBlID09PSAic3RyaW5nIiA/IHBhcmVudFR5cGUgOiBwYXJlbnRUeXBlLmRpc3BsYXlOYW1lIHx8IHBhcmVudFR5cGUubmFtZTsKICAgICAgICAgICAgICBpZiAocGFyZW50TmFtZSkgewogICAgICAgICAgICAgICAgaW5mbyA9ICJcblxuQ2hlY2sgdGhlIHRvcC1sZXZlbCByZW5kZXIgY2FsbCB1c2luZyA8IiArIHBhcmVudE5hbWUgKyAiPi4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVFeHBsaWNpdEtleShlbGVtZW50LCBwYXJlbnRUeXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZWxlbWVudC5fc3RvcmUgfHwgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkIHx8IGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8gPSBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpOwogICAgICAgICAgICBpZiAob3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSA9IHRydWU7CiAgICAgICAgICAgIHZhciBjaGlsZE93bmVyID0gIiI7CiAgICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyICE9PSBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQpIHsKICAgICAgICAgICAgICBjaGlsZE93bmVyID0gIiBJdCB3YXMgcGFzc2VkIGEgY2hpbGQgZnJvbSAiICsgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGVsZW1lbnQuX293bmVyLnR5cGUpICsgIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCk7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiVzJXMgU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93YXJuaW5nLWtleXMgZm9yIG1vcmUgaW5mb3JtYXRpb24uJywgY3VycmVudENvbXBvbmVudEVycm9ySW5mbywgY2hpbGRPd25lcik7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlQ2hpbGRLZXlzKG5vZGUsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBub2RlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNBcnJheTIobm9kZSkpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGVbaV07CiAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQxNShjaGlsZCkpIHsKICAgICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShjaGlsZCwgcGFyZW50VHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzVmFsaWRFbGVtZW50MTUobm9kZSkpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5fc3RvcmUpIHsKICAgICAgICAgICAgICAgIG5vZGUuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUpIHsKICAgICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4obm9kZSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpZiAoaXRlcmF0b3JGbiAhPT0gbm9kZS5lbnRyaWVzKSB7CiAgICAgICAgICAgICAgICAgIHZhciBpdGVyYXRvciA9IGl0ZXJhdG9yRm4uY2FsbChub2RlKTsKICAgICAgICAgICAgICAgICAgdmFyIHN0ZXA7CiAgICAgICAgICAgICAgICAgIHdoaWxlICghKHN0ZXAgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQxNShzdGVwLnZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShzdGVwLnZhbHVlLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwgfHwgdHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyIHx8IC8vIE5vdGU6IE1lbW8gb25seSBjaGVja3Mgb3V0ZXIgcHJvcHMgaGVyZS4KICAgICAgICAgICAgLy8gSW5uZXIgcHJvcHMgYXJlIGNoZWNrZWQgaW4gdGhlIHJlY29uY2lsZXIuCiAgICAgICAgICAgIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRTIpKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzID0gdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wVHlwZXMpIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhwcm9wVHlwZXMsIGVsZW1lbnQucHJvcHMsICJwcm9wIiwgbmFtZSwgZWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZS5Qcm9wVHlwZXMgIT09IHZvaWQgMCAmJiAhcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIF9uYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgIGVycm9yKCJDb21wb25lbnQgJXMgZGVjbGFyZWQgYFByb3BUeXBlc2AgaW5zdGVhZCBvZiBgcHJvcFR5cGVzYC4gRGlkIHlvdSBtaXNzcGVsbCB0aGUgcHJvcGVydHkgYXNzaWdubWVudD8iLCBfbmFtZSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS5nZXREZWZhdWx0UHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgIXR5cGUuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyBpcyBvbmx5IHVzZWQgb24gY2xhc3NpYyBSZWFjdC5jcmVhdGVDbGFzcyBkZWZpbml0aW9ucy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IG5hbWVkIGBkZWZhdWx0UHJvcHNgIGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGcmFnbWVudFByb3BzKGZyYWdtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZnJhZ21lbnQucHJvcHMpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICBpZiAoa2V5ICE9PSAiY2hpbGRyZW4iICYmIGtleSAhPT0gImtleSIpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgcHJvcCBgJXNgIHN1cHBsaWVkIHRvIGBSZWFjdC5GcmFnbWVudGAuIFJlYWN0LkZyYWdtZW50IGNhbiBvbmx5IGhhdmUgYGtleWAgYW5kIGBjaGlsZHJlbmAgcHJvcHMuIiwga2V5KTsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZyYWdtZW50LnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBgcmVmYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiIpOwogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEtleVNwcmVhZCA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uKHR5cGUsIHByb3BzLCBrZXksIGlzU3RhdGljQ2hpbGRyZW4sIHNvdXJjZSwgc2VsZjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHZhbGlkVHlwZSA9IGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKTsKICAgICAgICAgICAgaWYgKCF2YWxpZFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwgJiYgT2JqZWN0LmtleXModHlwZSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9ICIgWW91IGxpa2VseSBmb3Jnb3QgdG8gZXhwb3J0IHlvdXIgY29tcG9uZW50IGZyb20gdGhlIGZpbGUgaXQncyBkZWZpbmVkIGluLCBvciB5b3UgbWlnaHQgaGF2ZSBtaXhlZCB1cCBkZWZhdWx0IGFuZCBuYW1lZCBpbXBvcnRzLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzb3VyY2VJbmZvID0gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW0oc291cmNlKTsKICAgICAgICAgICAgICBpZiAoc291cmNlSW5mbykgewogICAgICAgICAgICAgICAgaW5mbyArPSBzb3VyY2VJbmZvOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbmZvICs9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgdHlwZVN0cmluZzsKICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICJudWxsIjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkyKHR5cGUpKSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gImFycmF5IjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgIT09IHZvaWQgMCAmJiB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAiPCIgKyAoZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUudHlwZSkgfHwgIlVua25vd24iKSArICIgLz4iOwogICAgICAgICAgICAgICAgaW5mbyA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgZXhwb3J0IGEgSlNYIGxpdGVyYWwgaW5zdGVhZCBvZiBhIGNvbXBvbmVudD8iOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gdHlwZW9mIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5qc3g6IHR5cGUgaXMgaW52YWxpZCAtLSBleHBlY3RlZCBhIHN0cmluZyAoZm9yIGJ1aWx0LWluIGNvbXBvbmVudHMpIG9yIGEgY2xhc3MvZnVuY3Rpb24gKGZvciBjb21wb3NpdGUgY29tcG9uZW50cykgYnV0IGdvdDogJXMuJXMiLCB0eXBlU3RyaW5nLCBpbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZWxlbWVudCA9IGpzeERFVih0eXBlLCBwcm9wcywga2V5LCBzb3VyY2UsIHNlbGYyKTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQgPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWxpZFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBwcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICBpZiAoY2hpbGRyZW4gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaWYgKGlzU3RhdGljQ2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKGNoaWxkcmVuKSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGNoaWxkcmVuW2ldLCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5mcmVlemUpIHsKICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QuanN4OiBTdGF0aWMgY2hpbGRyZW4gc2hvdWxkIGFsd2F5cyBiZSBhbiBhcnJheS4gWW91IGFyZSBsaWtlbHkgZXhwbGljaXRseSBjYWxsaW5nIFJlYWN0LmpzeHMgb3IgUmVhY3QuanN4REVWLiBVc2UgdGhlIEJhYmVsIHRyYW5zZm9ybSBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YWxpZGF0ZUNoaWxkS2V5cyhjaGlsZHJlbiwgdHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChwcm9wcywgImtleSIpKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMocHJvcHMpLmZpbHRlcihmdW5jdGlvbihrKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBrICE9PSAia2V5IjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdmFyIGJlZm9yZUV4YW1wbGUgPSBrZXlzLmxlbmd0aCA+IDAgPyAie2tleTogc29tZUtleSwgIiArIGtleXMuam9pbigiOiAuLi4sICIpICsgIjogLi4ufSIgOiAie2tleTogc29tZUtleX0iOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRLZXlTcHJlYWRbY29tcG9uZW50TmFtZSArIGJlZm9yZUV4YW1wbGVdKSB7CiAgICAgICAgICAgICAgICAgIHZhciBhZnRlckV4YW1wbGUgPSBrZXlzLmxlbmd0aCA+IDAgPyAieyIgKyBrZXlzLmpvaW4oIjogLi4uLCAiKSArICI6IC4uLn0iIDogInt9IjsKICAgICAgICAgICAgICAgICAgZXJyb3IoJ0EgcHJvcHMgb2JqZWN0IGNvbnRhaW5pbmcgYSAia2V5IiBwcm9wIGlzIGJlaW5nIHNwcmVhZCBpbnRvIEpTWDpcbiAgbGV0IHByb3BzID0gJXM7XG4gIDwlcyB7Li4ucHJvcHN9IC8+XG5SZWFjdCBrZXlzIG11c3QgYmUgcGFzc2VkIGRpcmVjdGx5IHRvIEpTWCB3aXRob3V0IHVzaW5nIHNwcmVhZDpcbiAgbGV0IHByb3BzID0gJXM7XG4gIDwlcyBrZXk9e3NvbWVLZXl9IHsuLi5wcm9wc30gLz4nLCBiZWZvcmVFeGFtcGxlLCBjb21wb25lbnROYW1lLCBhZnRlckV4YW1wbGUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRLZXlTcHJlYWRbY29tcG9uZW50TmFtZSArIGJlZm9yZUV4YW1wbGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICB2YWxpZGF0ZUZyYWdtZW50UHJvcHMoZWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uU3RhdGljKHR5cGUsIHByb3BzLCBrZXkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGpzeFdpdGhWYWxpZGF0aW9uKHR5cGUsIHByb3BzLCBrZXksIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBqc3hXaXRoVmFsaWRhdGlvbkR5bmFtaWModHlwZSwgcHJvcHMsIGtleSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4ganN4V2l0aFZhbGlkYXRpb24odHlwZSwgcHJvcHMsIGtleSwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIganN4NCA9IGpzeFdpdGhWYWxpZGF0aW9uRHluYW1pYzsKICAgICAgICB2YXIganN4czQgPSBqc3hXaXRoVmFsaWRhdGlvblN0YXRpYzsKICAgICAgICBleHBvcnRzLkZyYWdtZW50ID0gUkVBQ1RfRlJBR01FTlRfVFlQRTsKICAgICAgICBleHBvcnRzLmpzeCA9IGpzeDQ7CiAgICAgICAgZXhwb3J0cy5qc3hzID0ganN4czQ7CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0L2pzeC1ydW50aW1lLmpzCnZhciByZXF1aXJlX2pzeF9ydW50aW1lID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0L2pzeC1ydW50aW1lLmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfcmVhY3RfanN4X3J1bnRpbWVfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gc3JjL21haW4udHN4CnZhciBpbXBvcnRfcmVhY3Q1MyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpLCAxKTsKdmFyIGltcG9ydF9jbGllbnQgPSBfX3RvRVNNKHJlcXVpcmVfY2xpZW50KCksIDEpOwoKLy8gc3JjL015QnVkZ2V0LnRzeAp2YXIgaW1wb3J0X3JlYWN0NTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSwgMSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qcwp2YXIgaW1wb3J0X3JlYWN0MiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9zaGFyZWQvc3JjL3V0aWxzLmpzCnZhciB0b0tlYmFiQ2FzZSA9IChzdHJpbmcpID0+IHN0cmluZy5yZXBsYWNlKC8oW2EtejAtOV0pKFtBLVpdKS9nLCAiJDEtJDIiKS50b0xvd2VyQ2FzZSgpOwp2YXIgdG9DYW1lbENhc2UgPSAoc3RyaW5nKSA9PiBzdHJpbmcucmVwbGFjZSgKICAvXihbQS1aXSl8W1xzLV9dKyhcdykvZywKICAobWF0Y2gsIHAxLCBwMikgPT4gcDIgPyBwMi50b1VwcGVyQ2FzZSgpIDogcDEudG9Mb3dlckNhc2UoKQopOwp2YXIgdG9QYXNjYWxDYXNlID0gKHN0cmluZykgPT4gewogIGNvbnN0IGNhbWVsQ2FzZSA9IHRvQ2FtZWxDYXNlKHN0cmluZyk7CiAgcmV0dXJuIGNhbWVsQ2FzZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIGNhbWVsQ2FzZS5zbGljZSgxKTsKfTsKdmFyIG1lcmdlQ2xhc3NlcyA9ICguLi5jbGFzc2VzKSA9PiBjbGFzc2VzLmZpbHRlcigoY2xhc3NOYW1lLCBpbmRleCwgYXJyYXkpID0+IHsKICByZXR1cm4gQm9vbGVhbihjbGFzc05hbWUpICYmIGNsYXNzTmFtZS50cmltKCkgIT09ICIiICYmIGFycmF5LmluZGV4T2YoY2xhc3NOYW1lKSA9PT0gaW5kZXg7Cn0pLmpvaW4oIiAiKS50cmltKCk7CnZhciBoYXNBMTF5UHJvcCA9IChwcm9wcykgPT4gewogIGZvciAoY29uc3QgcHJvcCBpbiBwcm9wcykgewogICAgaWYgKHByb3Auc3RhcnRzV2l0aCgiYXJpYS0iKSB8fCBwcm9wID09PSAicm9sZSIgfHwgcHJvcCA9PT0gInRpdGxlIikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vSWNvbi5qcwp2YXIgaW1wb3J0X3JlYWN0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2RlZmF1bHRBdHRyaWJ1dGVzLmpzCnZhciBkZWZhdWx0QXR0cmlidXRlcyA9IHsKICB4bWxuczogImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiwKICB3aWR0aDogMjQsCiAgaGVpZ2h0OiAyNCwKICB2aWV3Qm94OiAiMCAwIDI0IDI0IiwKICBmaWxsOiAibm9uZSIsCiAgc3Ryb2tlOiAiY3VycmVudENvbG9yIiwKICBzdHJva2VXaWR0aDogMiwKICBzdHJva2VMaW5lY2FwOiAicm91bmQiLAogIHN0cm9rZUxpbmVqb2luOiAicm91bmQiCn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vSWNvbi5qcwp2YXIgSWNvbiA9ICgwLCBpbXBvcnRfcmVhY3QuZm9yd2FyZFJlZikoCiAgKHsKICAgIGNvbG9yOiBjb2xvcjIgPSAiY3VycmVudENvbG9yIiwKICAgIHNpemUgPSAyNCwKICAgIHN0cm9rZVdpZHRoID0gMiwKICAgIGFic29sdXRlU3Ryb2tlV2lkdGgsCiAgICBjbGFzc05hbWUgPSAiIiwKICAgIGNoaWxkcmVuLAogICAgaWNvbk5vZGUsCiAgICAuLi5yZXN0CiAgfSwgcmVmKSA9PiAoMCwgaW1wb3J0X3JlYWN0LmNyZWF0ZUVsZW1lbnQpKAogICAgInN2ZyIsCiAgICB7CiAgICAgIHJlZiwKICAgICAgLi4uZGVmYXVsdEF0dHJpYnV0ZXMsCiAgICAgIHdpZHRoOiBzaXplLAogICAgICBoZWlnaHQ6IHNpemUsCiAgICAgIHN0cm9rZTogY29sb3IyLAogICAgICBzdHJva2VXaWR0aDogYWJzb2x1dGVTdHJva2VXaWR0aCA/IE51bWJlcihzdHJva2VXaWR0aCkgKiAyNCAvIE51bWJlcihzaXplKSA6IHN0cm9rZVdpZHRoLAogICAgICBjbGFzc05hbWU6IG1lcmdlQ2xhc3NlcygibHVjaWRlIiwgY2xhc3NOYW1lKSwKICAgICAgLi4uIWNoaWxkcmVuICYmICFoYXNBMTF5UHJvcChyZXN0KSAmJiB7ICJhcmlhLWhpZGRlbiI6ICJ0cnVlIiB9LAogICAgICAuLi5yZXN0CiAgICB9LAogICAgWwogICAgICAuLi5pY29uTm9kZS5tYXAoKFt0YWcsIGF0dHJzXSkgPT4gKDAsIGltcG9ydF9yZWFjdC5jcmVhdGVFbGVtZW50KSh0YWcsIGF0dHJzKSksCiAgICAgIC4uLkFycmF5LmlzQXJyYXkoY2hpbGRyZW4pID8gY2hpbGRyZW4gOiBbY2hpbGRyZW5dCiAgICBdCiAgKQopOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2NyZWF0ZUx1Y2lkZUljb24uanMKdmFyIGNyZWF0ZUx1Y2lkZUljb24gPSAoaWNvbk5hbWUsIGljb25Ob2RlKSA9PiB7CiAgY29uc3QgQ29tcG9uZW50ID0gKDAsIGltcG9ydF9yZWFjdDIuZm9yd2FyZFJlZikoCiAgICAoeyBjbGFzc05hbWUsIC4uLnByb3BzIH0sIHJlZikgPT4gKDAsIGltcG9ydF9yZWFjdDIuY3JlYXRlRWxlbWVudCkoSWNvbiwgewogICAgICByZWYsCiAgICAgIGljb25Ob2RlLAogICAgICBjbGFzc05hbWU6IG1lcmdlQ2xhc3NlcygKICAgICAgICBgbHVjaWRlLSR7dG9LZWJhYkNhc2UodG9QYXNjYWxDYXNlKGljb25OYW1lKSl9YCwKICAgICAgICBgbHVjaWRlLSR7aWNvbk5hbWV9YCwKICAgICAgICBjbGFzc05hbWUKICAgICAgKSwKICAgICAgLi4ucHJvcHMKICAgIH0pCiAgKTsKICBDb21wb25lbnQuZGlzcGxheU5hbWUgPSB0b1Bhc2NhbENhc2UoaWNvbk5hbWUpOwogIHJldHVybiBDb21wb25lbnQ7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYXJyb3ctdXAtcmlnaHQuanMKdmFyIF9faWNvbk5vZGUgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTcgN2gxMHYxMCIsIGtleTogIjF0aXZuOSIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTcgMTcgMTcgNyIsIGtleTogIjF2a2l6YSIgfV0KXTsKdmFyIEFycm93VXBSaWdodCA9IGNyZWF0ZUx1Y2lkZUljb24oImFycm93LXVwLXJpZ2h0IiwgX19pY29uTm9kZSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYnVpbGRpbmctMi5qcwp2YXIgX19pY29uTm9kZTIgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTEwIDEyaDQiLCBrZXk6ICJhNTZiMHAiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMCA4aDQiLCBrZXk6ICIxc3IyYWYiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xNCAyMXYtM2EyIDIgMCAwIDAtNCAwdjMiLCBrZXk6ICIxcmdpZWkiIH1dLAogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk02IDEwSDRhMiAyIDAgMCAwLTIgMnY3YTIgMiAwIDAgMCAyIDJoMTZhMiAyIDAgMCAwIDItMlY5YTIgMiAwIDAgMC0yLTJoLTIiLAogICAgICBrZXk6ICJzZWNtaTIiCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNNiAyMVY1YTIgMiAwIDAgMSAyLTJoOGEyIDIgMCAwIDEgMiAydjE2Iiwga2V5OiAiMTZyYTB0IiB9XQpdOwp2YXIgQnVpbGRpbmcyID0gY3JlYXRlTHVjaWRlSWNvbigiYnVpbGRpbmctMiIsIF9faWNvbk5vZGUyKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGVjay5qcwp2YXIgX19pY29uTm9kZTMgPSBbWyJwYXRoIiwgeyBkOiAiTTIwIDYgOSAxN2wtNS01Iiwga2V5OiAiMWdtZjJjIiB9XV07CnZhciBDaGVjayA9IGNyZWF0ZUx1Y2lkZUljb24oImNoZWNrIiwgX19pY29uTm9kZTMpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2NoZXZyb24tZG93bi5qcwp2YXIgX19pY29uTm9kZTQgPSBbWyJwYXRoIiwgeyBkOiAibTYgOSA2IDYgNi02Iiwga2V5OiAicXJ1bnNsIiB9XV07CnZhciBDaGV2cm9uRG93biA9IGNyZWF0ZUx1Y2lkZUljb24oImNoZXZyb24tZG93biIsIF9faWNvbk5vZGU0KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGV2cm9uLXVwLmpzCnZhciBfX2ljb25Ob2RlNSA9IFtbInBhdGgiLCB7IGQ6ICJtMTggMTUtNi02LTYgNiIsIGtleTogIjE1M3VkeiIgfV1dOwp2YXIgQ2hldnJvblVwID0gY3JlYXRlTHVjaWRlSWNvbigiY2hldnJvbi11cCIsIF9faWNvbk5vZGU1KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaXJjbGUtYWxlcnQuanMKdmFyIF9faWNvbk5vZGU2ID0gWwogIFsiY2lyY2xlIiwgeyBjeDogIjEyIiwgY3k6ICIxMiIsIHI6ICIxMCIsIGtleTogIjFtZ2xheSIgfV0sCiAgWyJsaW5lIiwgeyB4MTogIjEyIiwgeDI6ICIxMiIsIHkxOiAiOCIsIHkyOiAiMTIiLCBrZXk6ICIxcGtldWgiIH1dLAogIFsibGluZSIsIHsgeDE6ICIxMiIsIHgyOiAiMTIuMDEiLCB5MTogIjE2IiwgeTI6ICIxNiIsIGtleTogIjRkZnE5MCIgfV0KXTsKdmFyIENpcmNsZUFsZXJ0ID0gY3JlYXRlTHVjaWRlSWNvbigiY2lyY2xlLWFsZXJ0IiwgX19pY29uTm9kZTYpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2NpcmNsZS1jaGVjay1iaWcuanMKdmFyIF9faWNvbk5vZGU3ID0gWwogIFsicGF0aCIsIHsgZDogIk0yMS44MDEgMTBBMTAgMTAgMCAxIDEgMTcgMy4zMzUiLCBrZXk6ICJ5cHMzY3QiIH1dLAogIFsicGF0aCIsIHsgZDogIm05IDExIDMgM0wyMiA0Iiwga2V5OiAiMXBmbHpsIiB9XQpdOwp2YXIgQ2lyY2xlQ2hlY2tCaWcgPSBjcmVhdGVMdWNpZGVJY29uKCJjaXJjbGUtY2hlY2stYmlnIiwgX19pY29uTm9kZTcpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2Nsb2NrLmpzCnZhciBfX2ljb25Ob2RlOCA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTIgNnY2bDQgMiIsIGtleTogIm1tazd5ZyIgfV0sCiAgWyJjaXJjbGUiLCB7IGN4OiAiMTIiLCBjeTogIjEyIiwgcjogIjEwIiwga2V5OiAiMW1nbGF5IiB9XQpdOwp2YXIgQ2xvY2sgPSBjcmVhdGVMdWNpZGVJY29uKCJjbG9jayIsIF9faWNvbk5vZGU4KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9kb2xsYXItc2lnbi5qcwp2YXIgX19pY29uTm9kZTkgPSBbCiAgWyJsaW5lIiwgeyB4MTogIjEyIiwgeDI6ICIxMiIsIHkxOiAiMiIsIHkyOiAiMjIiLCBrZXk6ICI3ZXF5cWgiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xNyA1SDkuNWEzLjUgMy41IDAgMCAwIDAgN2g1YTMuNSAzLjUgMCAwIDEgMCA3SDYiLCBrZXk6ICIxYjBwNHMiIH1dCl07CnZhciBEb2xsYXJTaWduID0gY3JlYXRlTHVjaWRlSWNvbigiZG9sbGFyLXNpZ24iLCBfX2ljb25Ob2RlOSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvZ3JpcC12ZXJ0aWNhbC5qcwp2YXIgX19pY29uTm9kZTEwID0gWwogIFsiY2lyY2xlIiwgeyBjeDogIjkiLCBjeTogIjEyIiwgcjogIjEiLCBrZXk6ICIxdmN0Z2YiIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjkiLCBjeTogIjUiLCByOiAiMSIsIGtleTogImhwMHRjZiIgfV0sCiAgWyJjaXJjbGUiLCB7IGN4OiAiOSIsIGN5OiAiMTkiLCByOiAiMSIsIGtleTogImZrampmNiIgfV0sCiAgWyJjaXJjbGUiLCB7IGN4OiAiMTUiLCBjeTogIjEyIiwgcjogIjEiLCBrZXk6ICIxdG1haWoiIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjE1IiwgY3k6ICI1IiwgcjogIjEiLCBrZXk6ICIxOWwyOGUiIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjE1IiwgY3k6ICIxOSIsIHI6ICIxIiwga2V5OiAiZjR6b2ozIiB9XQpdOwp2YXIgR3JpcFZlcnRpY2FsID0gY3JlYXRlTHVjaWRlSWNvbigiZ3JpcC12ZXJ0aWNhbCIsIF9faWNvbk5vZGUxMCk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvaGVhcnQuanMKdmFyIF9faWNvbk5vZGUxMSA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMiA5LjVhNS41IDUuNSAwIDAgMSA5LjU5MS0zLjY3Ni41Ni41NiAwIDAgMCAuODE4IDBBNS40OSA1LjQ5IDAgMCAxIDIyIDkuNWMwIDIuMjktMS41IDQtMyA1LjVsLTUuNDkyIDUuMzEzYTIgMiAwIDAgMS0zIC4wMTlMNSAxNWMtMS41LTEuNS0zLTMuMi0zLTUuNSIsCiAgICAgIGtleTogIm12cjFhMCIKICAgIH0KICBdCl07CnZhciBIZWFydCA9IGNyZWF0ZUx1Y2lkZUljb24oImhlYXJ0IiwgX19pY29uTm9kZTExKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9ob3VzZS5qcwp2YXIgX19pY29uTm9kZTEyID0gWwogIFsicGF0aCIsIHsgZDogIk0xNSAyMXYtOGExIDEgMCAwIDAtMS0xaC00YTEgMSAwIDAgMC0xIDF2OCIsIGtleTogIjV3d2xyNSIgfV0sCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTMgMTBhMiAyIDAgMCAxIC43MDktMS41MjhsNy02YTIgMiAwIDAgMSAyLjU4MiAwbDcgNkEyIDIgMCAwIDEgMjEgMTB2OWEyIDIgMCAwIDEtMiAySDVhMiAyIDAgMCAxLTItMnoiLAogICAgICBrZXk6ICJyNm5zczEiCiAgICB9CiAgXQpdOwp2YXIgSG91c2UgPSBjcmVhdGVMdWNpZGVJY29uKCJob3VzZSIsIF9faWNvbk5vZGUxMik7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbGFuZG1hcmsuanMKdmFyIF9faWNvbk5vZGUxMyA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTAgMTh2LTciLCBrZXk6ICJ3dDExNmIiIH1dLAogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0xMS4xMiAyLjE5OGEyIDIgMCAwIDEgMS43Ni4wMDZsNy44NjYgMy44NDdjLjQ3Ni4yMzMuMzEuOTQ5LS4yMi45NDlIMy40NzRjLS41MyAwLS42OTUtLjcxNi0uMjItLjk0OXoiLAogICAgICBrZXk6ICIxbTMyOW0iCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNMTQgMTh2LTciLCBrZXk6ICJ2YXY2dDMiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xOCAxOHYtNyIsIGtleTogImFleGRtaiIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTMgMjJoMTgiLCBrZXk6ICI4cHJyNDUiIH1dLAogIFsicGF0aCIsIHsgZDogIk02IDE4di03Iiwga2V5OiAiMWl2ZmxrIiB9XQpdOwp2YXIgTGFuZG1hcmsgPSBjcmVhdGVMdWNpZGVJY29uKCJsYW5kbWFyayIsIF9faWNvbk5vZGUxMyk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbG9hZGVyLWNpcmNsZS5qcwp2YXIgX19pY29uTm9kZTE0ID0gW1sicGF0aCIsIHsgZDogIk0yMSAxMmE5IDkgMCAxIDEtNi4yMTktOC41NiIsIGtleTogIjEzemFsZCIgfV1dOwp2YXIgTG9hZGVyQ2lyY2xlID0gY3JlYXRlTHVjaWRlSWNvbigibG9hZGVyLWNpcmNsZSIsIF9faWNvbk5vZGUxNCk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbG9jay5qcwp2YXIgX19pY29uTm9kZTE1ID0gWwogIFsicmVjdCIsIHsgd2lkdGg6ICIxOCIsIGhlaWdodDogIjExIiwgeDogIjMiLCB5OiAiMTEiLCByeDogIjIiLCByeTogIjIiLCBrZXk6ICIxdzRldzEiIH1dLAogIFsicGF0aCIsIHsgZDogIk03IDExVjdhNSA1IDAgMCAxIDEwIDB2NCIsIGtleTogImZ3dm16bSIgfV0KXTsKdmFyIExvY2sgPSBjcmVhdGVMdWNpZGVJY29uKCJsb2NrIiwgX19pY29uTm9kZTE1KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9tYWlsLmpzCnZhciBfX2ljb25Ob2RlMTYgPSBbCiAgWyJwYXRoIiwgeyBkOiAibTIyIDctOC45OTEgNS43MjdhMiAyIDAgMCAxLTIuMDA5IDBMMiA3Iiwga2V5OiAiMTMycTdxIiB9XSwKICBbInJlY3QiLCB7IHg6ICIyIiwgeTogIjQiLCB3aWR0aDogIjIwIiwgaGVpZ2h0OiAiMTYiLCByeDogIjIiLCBrZXk6ICJpenhsYW8iIH1dCl07CnZhciBNYWlsID0gY3JlYXRlTHVjaWRlSWNvbigibWFpbCIsIF9faWNvbk5vZGUxNik7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbWVzc2FnZS1zcXVhcmUuanMKdmFyIF9faWNvbk5vZGUxNyA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMjIgMTdhMiAyIDAgMCAxLTIgMkg2LjgyOGEyIDIgMCAwIDAtMS40MTQuNTg2bC0yLjIwMiAyLjIwMkEuNzEuNzEgMCAwIDEgMiAyMS4yODZWNWEyIDIgMCAwIDEgMi0yaDE2YTIgMiAwIDAgMSAyIDJ6IiwKICAgICAga2V5OiAiMTg4ODdwIgogICAgfQogIF0KXTsKdmFyIE1lc3NhZ2VTcXVhcmUgPSBjcmVhdGVMdWNpZGVJY29uKCJtZXNzYWdlLXNxdWFyZSIsIF9faWNvbk5vZGUxNyk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcGVuLmpzCnZhciBfX2ljb25Ob2RlMTggPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTIxLjE3NCA2LjgxMmExIDEgMCAwIDAtMy45ODYtMy45ODdMMy44NDIgMTYuMTc0YTIgMiAwIDAgMC0uNS44M2wtMS4zMjEgNC4zNTJhLjUuNSAwIDAgMCAuNjIzLjYyMmw0LjM1My0xLjMyYTIgMiAwIDAgMCAuODMtLjQ5N3oiLAogICAgICBrZXk6ICIxYTh1c3UiCiAgICB9CiAgXQpdOwp2YXIgUGVuID0gY3JlYXRlTHVjaWRlSWNvbigicGVuIiwgX19pY29uTm9kZTE4KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9waWdneS1iYW5rLmpzCnZhciBfX2ljb25Ob2RlMTkgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTExIDE3aDN2MmExIDEgMCAwIDAgMSAxaDJhMSAxIDAgMCAwIDEtMXYtM2EzLjE2IDMuMTYgMCAwIDAgMi0yaDFhMSAxIDAgMCAwIDEtMXYtMmExIDEgMCAwIDAtMS0xaC0xYTUgNSAwIDAgMC0yLTRWM2E0IDQgMCAwIDAtMy4yIDEuNmwtLjMuNEgxMWE2IDYgMCAwIDAtNiA2djFhNSA1IDAgMCAwIDIgNHYzYTEgMSAwIDAgMCAxIDFoMmExIDEgMCAwIDAgMS0xeiIsCiAgICAgIGtleTogIjFwaWdsYyIKICAgIH0KICBdLAogIFsicGF0aCIsIHsgZDogIk0xNiAxMGguMDEiLCBrZXk6ICIxbTk0d3oiIH1dLAogIFsicGF0aCIsIHsgZDogIk0yIDh2MWEyIDIgMCAwIDAgMiAyaDEiLCBrZXk6ICIxZW52NDMiIH1dCl07CnZhciBQaWdneUJhbmsgPSBjcmVhdGVMdWNpZGVJY29uKCJwaWdneS1iYW5rIiwgX19pY29uTm9kZTE5KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wbHVzLmpzCnZhciBfX2ljb25Ob2RlMjAgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTUgMTJoMTQiLCBrZXk6ICIxYXlzMGgiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMiA1djE0Iiwga2V5OiAiczY5OWxlIiB9XQpdOwp2YXIgUGx1cyA9IGNyZWF0ZUx1Y2lkZUljb24oInBsdXMiLCBfX2ljb25Ob2RlMjApOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3ByaW50ZXIuanMKdmFyIF9faWNvbk5vZGUyMSA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNNiAxOEg0YTIgMiAwIDAgMS0yLTJ2LTVhMiAyIDAgMCAxIDItMmgxNmEyIDIgMCAwIDEgMiAydjVhMiAyIDAgMCAxLTIgMmgtMiIsCiAgICAgIGtleTogIjE0M3d5ZCIKICAgIH0KICBdLAogIFsicGF0aCIsIHsgZDogIk02IDlWM2ExIDEgMCAwIDEgMS0xaDEwYTEgMSAwIDAgMSAxIDF2NiIsIGtleTogIjFpdG5lNyIgfV0sCiAgWyJyZWN0IiwgeyB4OiAiNiIsIHk6ICIxNCIsIHdpZHRoOiAiMTIiLCBoZWlnaHQ6ICI4Iiwgcng6ICIxIiwga2V5OiAiMXVlMHRnIiB9XQpdOwp2YXIgUHJpbnRlciA9IGNyZWF0ZUx1Y2lkZUljb24oInByaW50ZXIiLCBfX2ljb25Ob2RlMjEpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3JlZnJlc2gtY3cuanMKdmFyIF9faWNvbk5vZGUyMiA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMyAxMmE5IDkgMCAwIDEgOS05IDkuNzUgOS43NSAwIDAgMSA2Ljc0IDIuNzRMMjEgOCIsIGtleTogInY5aDV2YyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTIxIDN2NWgtNSIsIGtleTogIjFxN3RvMCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTIxIDEyYTkgOSAwIDAgMS05IDkgOS43NSA5Ljc1IDAgMCAxLTYuNzQtMi43NEwzIDE2Iiwga2V5OiAiM3VpZmwzIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNOCAxNkgzdjUiLCBrZXk6ICIxY3Y2NzgiIH1dCl07CnZhciBSZWZyZXNoQ3cgPSBjcmVhdGVMdWNpZGVJY29uKCJyZWZyZXNoLWN3IiwgX19pY29uTm9kZTIyKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9yb3RhdGUtY2N3LmpzCnZhciBfX2ljb25Ob2RlMjMgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTMgMTJhOSA5IDAgMSAwIDktOSA5Ljc1IDkuNzUgMCAwIDAtNi43NCAyLjc0TDMgOCIsIGtleTogIjEzNTdlMyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTMgM3Y1aDUiLCBrZXk6ICIxeGhxOGEiIH1dCl07CnZhciBSb3RhdGVDY3cgPSBjcmVhdGVMdWNpZGVJY29uKCJyb3RhdGUtY2N3IiwgX19pY29uTm9kZTIzKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9zYXZlLmpzCnZhciBfX2ljb25Ob2RlMjQgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTE1LjIgM2EyIDIgMCAwIDEgMS40LjZsMy44IDMuOGEyIDIgMCAwIDEgLjYgMS40VjE5YTIgMiAwIDAgMS0yIDJINWEyIDIgMCAwIDEtMi0yVjVhMiAyIDAgMCAxIDItMnoiLAogICAgICBrZXk6ICIxYzg0NzYiCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNMTcgMjF2LTdhMSAxIDAgMCAwLTEtMUg4YTEgMSAwIDAgMC0xIDF2NyIsIGtleTogIjF5ZHRvcyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTcgM3Y0YTEgMSAwIDAgMCAxIDFoNyIsIGtleTogInQ1MXU3MyIgfV0KXTsKdmFyIFNhdmUgPSBjcmVhdGVMdWNpZGVJY29uKCJzYXZlIiwgX19pY29uTm9kZTI0KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9zZWFyY2guanMKdmFyIF9faWNvbk5vZGUyNSA9IFsKICBbInBhdGgiLCB7IGQ6ICJtMjEgMjEtNC4zNC00LjM0Iiwga2V5OiAiMTRqN3JqIiB9XSwKICBbImNpcmNsZSIsIHsgY3g6ICIxMSIsIGN5OiAiMTEiLCByOiAiOCIsIGtleTogIjRlajk3dSIgfV0KXTsKdmFyIFNlYXJjaCA9IGNyZWF0ZUx1Y2lkZUljb24oInNlYXJjaCIsIF9faWNvbk5vZGUyNSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdGh1bWJzLWRvd24uanMKdmFyIF9faWNvbk5vZGUyNiA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTcgMTRWMiIsIGtleTogIjh5bXFuayIgfV0sCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTkgMTguMTIgMTAgMTRINC4xN2EyIDIgMCAwIDEtMS45Mi0yLjU2bDIuMzMtOEEyIDIgMCAwIDEgNi41IDJIMjBhMiAyIDAgMCAxIDIgMnY4YTIgMiAwIDAgMS0yIDJoLTIuNzZhMiAyIDAgMCAwLTEuNzkgMS4xMUwxMiAyMmEzLjEzIDMuMTMgMCAwIDEtMy0zLjg4WiIsCiAgICAgIGtleTogIm02MW03NyIKICAgIH0KICBdCl07CnZhciBUaHVtYnNEb3duID0gY3JlYXRlTHVjaWRlSWNvbigidGh1bWJzLWRvd24iLCBfX2ljb25Ob2RlMjYpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RodW1icy11cC5qcwp2YXIgX19pY29uTm9kZTI3ID0gWwogIFsicGF0aCIsIHsgZDogIk03IDEwdjEyIiwga2V5OiAiMXFjOTNuIiB9XSwKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMTUgNS44OCAxNCAxMGg1LjgzYTIgMiAwIDAgMSAxLjkyIDIuNTZsLTIuMzMgOEEyIDIgMCAwIDEgMTcuNSAyMkg0YTIgMiAwIDAgMS0yLTJ2LThhMiAyIDAgMCAxIDItMmgyLjc2YTIgMiAwIDAgMCAxLjc5LTEuMTFMMTIgMmEzLjEzIDMuMTMgMCAwIDEgMyAzLjg4WiIsCiAgICAgIGtleTogImVtbW1jciIKICAgIH0KICBdCl07CnZhciBUaHVtYnNVcCA9IGNyZWF0ZUx1Y2lkZUljb24oInRodW1icy11cCIsIF9faWNvbk5vZGUyNyk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdHJhc2gtMi5qcwp2YXIgX19pY29uTm9kZTI4ID0gWwogIFsicGF0aCIsIHsgZDogIk0xMCAxMXY2Iiwga2V5OiAibmNvMG9tIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTQgMTF2NiIsIGtleTogIm91dHYxdSIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTE5IDZ2MTRhMiAyIDAgMCAxLTIgMkg3YTIgMiAwIDAgMS0yLTJWNiIsIGtleTogIm1peXRyYyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTMgNmgxOCIsIGtleTogImQwd20waiIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTggNlY0YTIgMiAwIDAgMSAyLTJoNGEyIDIgMCAwIDEgMiAydjIiLCBrZXk6ICJlNzkxamkiIH1dCl07CnZhciBUcmFzaDIgPSBjcmVhdGVMdWNpZGVJY29uKCJ0cmFzaC0yIiwgX19pY29uTm9kZTI4KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90cmVuZGluZy1kb3duLmpzCnZhciBfX2ljb25Ob2RlMjkgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTE2IDE3aDZ2LTYiLCBrZXk6ICJ0Nm4yaXQiIH1dLAogIFsicGF0aCIsIHsgZDogIm0yMiAxNy04LjUtOC41LTUgNUwyIDciLCBrZXk6ICJ4NDczcCIgfV0KXTsKdmFyIFRyZW5kaW5nRG93biA9IGNyZWF0ZUx1Y2lkZUljb24oInRyZW5kaW5nLWRvd24iLCBfX2ljb25Ob2RlMjkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RyZW5kaW5nLXVwLmpzCnZhciBfX2ljb25Ob2RlMzAgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTE2IDdoNnY2Iiwga2V5OiAiYm94NTVsIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJtMjIgNy04LjUgOC41LTUtNUwyIDE3Iiwga2V5OiAiMXQxbTc5IiB9XQpdOwp2YXIgVHJlbmRpbmdVcCA9IGNyZWF0ZUx1Y2lkZUljb24oInRyZW5kaW5nLXVwIiwgX19pY29uTm9kZTMwKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90cmlhbmdsZS1hbGVydC5qcwp2YXIgX19pY29uTm9kZTMxID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIm0yMS43MyAxOC04LTE0YTIgMiAwIDAgMC0zLjQ4IDBsLTggMTRBMiAyIDAgMCAwIDQgMjFoMTZhMiAyIDAgMCAwIDEuNzMtMyIsCiAgICAgIGtleTogIndtb2VucSIKICAgIH0KICBdLAogIFsicGF0aCIsIHsgZDogIk0xMiA5djQiLCBrZXk6ICJqdXpwdTciIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMiAxN2guMDEiLCBrZXk6ICJwMzJwMDUiIH1dCl07CnZhciBUcmlhbmdsZUFsZXJ0ID0gY3JlYXRlTHVjaWRlSWNvbigidHJpYW5nbGUtYWxlcnQiLCBfX2ljb25Ob2RlMzEpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3dhbGxldC5qcwp2YXIgX19pY29uTm9kZTMyID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0xOSA3VjRhMSAxIDAgMCAwLTEtMUg1YTIgMiAwIDAgMCAwIDRoMTVhMSAxIDAgMCAxIDEgMXY0aC0zYTIgMiAwIDAgMCAwIDRoM2ExIDEgMCAwIDAgMS0xdi0yYTEgMSAwIDAgMC0xLTEiLAogICAgICBrZXk6ICIxOGV0YjYiCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNMyA1djE0YTIgMiAwIDAgMCAyIDJoMTVhMSAxIDAgMCAwIDEtMXYtNCIsIGtleTogInhvYzBxNCIgfV0KXTsKdmFyIFdhbGxldCA9IGNyZWF0ZUx1Y2lkZUljb24oIndhbGxldCIsIF9faWNvbk5vZGUzMik7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMveC5qcwp2YXIgX19pY29uTm9kZTMzID0gWwogIFsicGF0aCIsIHsgZDogIk0xOCA2IDYgMTgiLCBrZXk6ICIxYmw1ZjgiIH1dLAogIFsicGF0aCIsIHsgZDogIm02IDYgMTIgMTIiLCBrZXk6ICJkOGJrNnYiIH1dCl07CnZhciBYID0gY3JlYXRlTHVjaWRlSWNvbigieCIsIF9faWNvbk5vZGUzMyk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250YWluZXIvU3VyZmFjZS5qcwp2YXIgUmVhY3QgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2Nsc3hAMi4xLjEvbm9kZV9tb2R1bGVzL2Nsc3gvZGlzdC9jbHN4Lm1qcwpmdW5jdGlvbiByKGUpIHsKICB2YXIgdCwgZiwgbiA9ICIiOwogIGlmICgic3RyaW5nIiA9PSB0eXBlb2YgZSB8fCAibnVtYmVyIiA9PSB0eXBlb2YgZSkgbiArPSBlOwogIGVsc2UgaWYgKCJvYmplY3QiID09IHR5cGVvZiBlKSBpZiAoQXJyYXkuaXNBcnJheShlKSkgewogICAgdmFyIG8gPSBlLmxlbmd0aDsKICAgIGZvciAodCA9IDA7IHQgPCBvOyB0KyspIGVbdF0gJiYgKGYgPSByKGVbdF0pKSAmJiAobiAmJiAobiArPSAiICIpLCBuICs9IGYpOwogIH0gZWxzZSBmb3IgKGYgaW4gZSkgZVtmXSAmJiAobiAmJiAobiArPSAiICIpLCBuICs9IGYpOwogIHJldHVybiBuOwp9CmZ1bmN0aW9uIGNsc3goKSB7CiAgZm9yICh2YXIgZSwgdCwgZiA9IDAsIG4gPSAiIiwgbyA9IGFyZ3VtZW50cy5sZW5ndGg7IGYgPCBvOyBmKyspIChlID0gYXJndW1lbnRzW2ZdKSAmJiAodCA9IHIoZSkpICYmIChuICYmIChuICs9ICIgIiksIG4gKz0gdCk7CiAgcmV0dXJuIG47Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc3ZnUHJvcGVydGllc0FuZEV2ZW50cy5qcwp2YXIgaW1wb3J0X3JlYWN0NCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZXhjbHVkZUV2ZW50UHJvcHMuanMKdmFyIEV2ZW50S2V5cyA9IFsiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLCAib25Db3B5IiwgIm9uQ29weUNhcHR1cmUiLCAib25DdXQiLCAib25DdXRDYXB0dXJlIiwgIm9uUGFzdGUiLCAib25QYXN0ZUNhcHR1cmUiLCAib25Db21wb3NpdGlvbkVuZCIsICJvbkNvbXBvc2l0aW9uRW5kQ2FwdHVyZSIsICJvbkNvbXBvc2l0aW9uU3RhcnQiLCAib25Db21wb3NpdGlvblN0YXJ0Q2FwdHVyZSIsICJvbkNvbXBvc2l0aW9uVXBkYXRlIiwgIm9uQ29tcG9zaXRpb25VcGRhdGVDYXB0dXJlIiwgIm9uRm9jdXMiLCAib25Gb2N1c0NhcHR1cmUiLCAib25CbHVyIiwgIm9uQmx1ckNhcHR1cmUiLCAib25DaGFuZ2UiLCAib25DaGFuZ2VDYXB0dXJlIiwgIm9uQmVmb3JlSW5wdXQiLCAib25CZWZvcmVJbnB1dENhcHR1cmUiLCAib25JbnB1dCIsICJvbklucHV0Q2FwdHVyZSIsICJvblJlc2V0IiwgIm9uUmVzZXRDYXB0dXJlIiwgIm9uU3VibWl0IiwgIm9uU3VibWl0Q2FwdHVyZSIsICJvbkludmFsaWQiLCAib25JbnZhbGlkQ2FwdHVyZSIsICJvbkxvYWQiLCAib25Mb2FkQ2FwdHVyZSIsICJvbkVycm9yIiwgIm9uRXJyb3JDYXB0dXJlIiwgIm9uS2V5RG93biIsICJvbktleURvd25DYXB0dXJlIiwgIm9uS2V5UHJlc3MiLCAib25LZXlQcmVzc0NhcHR1cmUiLCAib25LZXlVcCIsICJvbktleVVwQ2FwdHVyZSIsICJvbkFib3J0IiwgIm9uQWJvcnRDYXB0dXJlIiwgIm9uQ2FuUGxheSIsICJvbkNhblBsYXlDYXB0dXJlIiwgIm9uQ2FuUGxheVRocm91Z2giLCAib25DYW5QbGF5VGhyb3VnaENhcHR1cmUiLCAib25EdXJhdGlvbkNoYW5nZSIsICJvbkR1cmF0aW9uQ2hhbmdlQ2FwdHVyZSIsICJvbkVtcHRpZWQiLCAib25FbXB0aWVkQ2FwdHVyZSIsICJvbkVuY3J5cHRlZCIsICJvbkVuY3J5cHRlZENhcHR1cmUiLCAib25FbmRlZCIsICJvbkVuZGVkQ2FwdHVyZSIsICJvbkxvYWRlZERhdGEiLCAib25Mb2FkZWREYXRhQ2FwdHVyZSIsICJvbkxvYWRlZE1ldGFkYXRhIiwgIm9uTG9hZGVkTWV0YWRhdGFDYXB0dXJlIiwgIm9uTG9hZFN0YXJ0IiwgIm9uTG9hZFN0YXJ0Q2FwdHVyZSIsICJvblBhdXNlIiwgIm9uUGF1c2VDYXB0dXJlIiwgIm9uUGxheSIsICJvblBsYXlDYXB0dXJlIiwgIm9uUGxheWluZyIsICJvblBsYXlpbmdDYXB0dXJlIiwgIm9uUHJvZ3Jlc3MiLCAib25Qcm9ncmVzc0NhcHR1cmUiLCAib25SYXRlQ2hhbmdlIiwgIm9uUmF0ZUNoYW5nZUNhcHR1cmUiLCAib25TZWVrZWQiLCAib25TZWVrZWRDYXB0dXJlIiwgIm9uU2Vla2luZyIsICJvblNlZWtpbmdDYXB0dXJlIiwgIm9uU3RhbGxlZCIsICJvblN0YWxsZWRDYXB0dXJlIiwgIm9uU3VzcGVuZCIsICJvblN1c3BlbmRDYXB0dXJlIiwgIm9uVGltZVVwZGF0ZSIsICJvblRpbWVVcGRhdGVDYXB0dXJlIiwgIm9uVm9sdW1lQ2hhbmdlIiwgIm9uVm9sdW1lQ2hhbmdlQ2FwdHVyZSIsICJvbldhaXRpbmciLCAib25XYWl0aW5nQ2FwdHVyZSIsICJvbkF1eENsaWNrIiwgIm9uQXV4Q2xpY2tDYXB0dXJlIiwgIm9uQ2xpY2siLCAib25DbGlja0NhcHR1cmUiLCAib25Db250ZXh0TWVudSIsICJvbkNvbnRleHRNZW51Q2FwdHVyZSIsICJvbkRvdWJsZUNsaWNrIiwgIm9uRG91YmxlQ2xpY2tDYXB0dXJlIiwgIm9uRHJhZyIsICJvbkRyYWdDYXB0dXJlIiwgIm9uRHJhZ0VuZCIsICJvbkRyYWdFbmRDYXB0dXJlIiwgIm9uRHJhZ0VudGVyIiwgIm9uRHJhZ0VudGVyQ2FwdHVyZSIsICJvbkRyYWdFeGl0IiwgIm9uRHJhZ0V4aXRDYXB0dXJlIiwgIm9uRHJhZ0xlYXZlIiwgIm9uRHJhZ0xlYXZlQ2FwdHVyZSIsICJvbkRyYWdPdmVyIiwgIm9uRHJhZ092ZXJDYXB0dXJlIiwgIm9uRHJhZ1N0YXJ0IiwgIm9uRHJhZ1N0YXJ0Q2FwdHVyZSIsICJvbkRyb3AiLCAib25Ecm9wQ2FwdHVyZSIsICJvbk1vdXNlRG93biIsICJvbk1vdXNlRG93bkNhcHR1cmUiLCAib25Nb3VzZUVudGVyIiwgIm9uTW91c2VMZWF2ZSIsICJvbk1vdXNlTW92ZSIsICJvbk1vdXNlTW92ZUNhcHR1cmUiLCAib25Nb3VzZU91dCIsICJvbk1vdXNlT3V0Q2FwdHVyZSIsICJvbk1vdXNlT3ZlciIsICJvbk1vdXNlT3ZlckNhcHR1cmUiLCAib25Nb3VzZVVwIiwgIm9uTW91c2VVcENhcHR1cmUiLCAib25TZWxlY3QiLCAib25TZWxlY3RDYXB0dXJlIiwgIm9uVG91Y2hDYW5jZWwiLCAib25Ub3VjaENhbmNlbENhcHR1cmUiLCAib25Ub3VjaEVuZCIsICJvblRvdWNoRW5kQ2FwdHVyZSIsICJvblRvdWNoTW92ZSIsICJvblRvdWNoTW92ZUNhcHR1cmUiLCAib25Ub3VjaFN0YXJ0IiwgIm9uVG91Y2hTdGFydENhcHR1cmUiLCAib25Qb2ludGVyRG93biIsICJvblBvaW50ZXJEb3duQ2FwdHVyZSIsICJvblBvaW50ZXJNb3ZlIiwgIm9uUG9pbnRlck1vdmVDYXB0dXJlIiwgIm9uUG9pbnRlclVwIiwgIm9uUG9pbnRlclVwQ2FwdHVyZSIsICJvblBvaW50ZXJDYW5jZWwiLCAib25Qb2ludGVyQ2FuY2VsQ2FwdHVyZSIsICJvblBvaW50ZXJFbnRlciIsICJvblBvaW50ZXJFbnRlckNhcHR1cmUiLCAib25Qb2ludGVyTGVhdmUiLCAib25Qb2ludGVyTGVhdmVDYXB0dXJlIiwgIm9uUG9pbnRlck92ZXIiLCAib25Qb2ludGVyT3ZlckNhcHR1cmUiLCAib25Qb2ludGVyT3V0IiwgIm9uUG9pbnRlck91dENhcHR1cmUiLCAib25Hb3RQb2ludGVyQ2FwdHVyZSIsICJvbkdvdFBvaW50ZXJDYXB0dXJlQ2FwdHVyZSIsICJvbkxvc3RQb2ludGVyQ2FwdHVyZSIsICJvbkxvc3RQb2ludGVyQ2FwdHVyZUNhcHR1cmUiLCAib25TY3JvbGwiLCAib25TY3JvbGxDYXB0dXJlIiwgIm9uV2hlZWwiLCAib25XaGVlbENhcHR1cmUiLCAib25BbmltYXRpb25TdGFydCIsICJvbkFuaW1hdGlvblN0YXJ0Q2FwdHVyZSIsICJvbkFuaW1hdGlvbkVuZCIsICJvbkFuaW1hdGlvbkVuZENhcHR1cmUiLCAib25BbmltYXRpb25JdGVyYXRpb24iLCAib25BbmltYXRpb25JdGVyYXRpb25DYXB0dXJlIiwgIm9uVHJhbnNpdGlvbkVuZCIsICJvblRyYW5zaXRpb25FbmRDYXB0dXJlIl07CmZ1bmN0aW9uIGlzRXZlbnRLZXkoa2V5KSB7CiAgaWYgKHR5cGVvZiBrZXkgIT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHZhciBhbGxvd2VkRXZlbnRLZXlzID0gRXZlbnRLZXlzOwogIHJldHVybiBhbGxvd2VkRXZlbnRLZXlzLmluY2x1ZGVzKGtleSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc3ZnUHJvcGVydGllc05vRXZlbnRzLmpzCnZhciBpbXBvcnRfcmVhY3QzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgU1ZHRWxlbWVudFByb3BLZXlzID0gWwogICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiLAogICJhcmlhLWF0b21pYyIsCiAgImFyaWEtYXV0b2NvbXBsZXRlIiwKICAiYXJpYS1idXN5IiwKICAiYXJpYS1jaGVja2VkIiwKICAiYXJpYS1jb2xjb3VudCIsCiAgImFyaWEtY29saW5kZXgiLAogICJhcmlhLWNvbHNwYW4iLAogICJhcmlhLWNvbnRyb2xzIiwKICAiYXJpYS1jdXJyZW50IiwKICAiYXJpYS1kZXNjcmliZWRieSIsCiAgImFyaWEtZGV0YWlscyIsCiAgImFyaWEtZGlzYWJsZWQiLAogICJhcmlhLWVycm9ybWVzc2FnZSIsCiAgImFyaWEtZXhwYW5kZWQiLAogICJhcmlhLWZsb3d0byIsCiAgImFyaWEtaGFzcG9wdXAiLAogICJhcmlhLWhpZGRlbiIsCiAgImFyaWEtaW52YWxpZCIsCiAgImFyaWEta2V5c2hvcnRjdXRzIiwKICAiYXJpYS1sYWJlbCIsCiAgImFyaWEtbGFiZWxsZWRieSIsCiAgImFyaWEtbGV2ZWwiLAogICJhcmlhLWxpdmUiLAogICJhcmlhLW1vZGFsIiwKICAiYXJpYS1tdWx0aWxpbmUiLAogICJhcmlhLW11bHRpc2VsZWN0YWJsZSIsCiAgImFyaWEtb3JpZW50YXRpb24iLAogICJhcmlhLW93bnMiLAogICJhcmlhLXBsYWNlaG9sZGVyIiwKICAiYXJpYS1wb3NpbnNldCIsCiAgImFyaWEtcHJlc3NlZCIsCiAgImFyaWEtcmVhZG9ubHkiLAogICJhcmlhLXJlbGV2YW50IiwKICAiYXJpYS1yZXF1aXJlZCIsCiAgImFyaWEtcm9sZWRlc2NyaXB0aW9uIiwKICAiYXJpYS1yb3djb3VudCIsCiAgImFyaWEtcm93aW5kZXgiLAogICJhcmlhLXJvd3NwYW4iLAogICJhcmlhLXNlbGVjdGVkIiwKICAiYXJpYS1zZXRzaXplIiwKICAiYXJpYS1zb3J0IiwKICAiYXJpYS12YWx1ZW1heCIsCiAgImFyaWEtdmFsdWVtaW4iLAogICJhcmlhLXZhbHVlbm93IiwKICAiYXJpYS12YWx1ZXRleHQiLAogICJjbGFzc05hbWUiLAogICJjb2xvciIsCiAgImhlaWdodCIsCiAgImlkIiwKICAibGFuZyIsCiAgIm1heCIsCiAgIm1lZGlhIiwKICAibWV0aG9kIiwKICAibWluIiwKICAibmFtZSIsCiAgInN0eWxlIiwKICAvKgogICAqIHJlbW92ZWQgJ3R5cGUnIFNWR0VsZW1lbnRQcm9wS2V5IGJlY2F1c2Ugd2UgZG8gbm90IGN1cnJlbnRseSB1c2UgYW55IFNWRyBlbGVtZW50cwogICAqIHRoYXQgY2FuIHVzZSBpdCwgYW5kIGl0IGNvbmZsaWN0cyB3aXRoIHRoZSByZWNoYXJ0cyBwcm9wICd0eXBlJwogICAqIGh0dHBzOi8vZ2l0aHViLmNvbS9yZWNoYXJ0cy9yZWNoYXJ0cy9wdWxsLzMzMjcKICAgKiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9TVkcvQXR0cmlidXRlL3R5cGUKICAgKi8KICAvLyAndHlwZScsCiAgInRhcmdldCIsCiAgIndpZHRoIiwKICAicm9sZSIsCiAgInRhYkluZGV4IiwKICAiYWNjZW50SGVpZ2h0IiwKICAiYWNjdW11bGF0ZSIsCiAgImFkZGl0aXZlIiwKICAiYWxpZ25tZW50QmFzZWxpbmUiLAogICJhbGxvd1Jlb3JkZXIiLAogICJhbHBoYWJldGljIiwKICAiYW1wbGl0dWRlIiwKICAiYXJhYmljRm9ybSIsCiAgImFzY2VudCIsCiAgImF0dHJpYnV0ZU5hbWUiLAogICJhdHRyaWJ1dGVUeXBlIiwKICAiYXV0b1JldmVyc2UiLAogICJhemltdXRoIiwKICAiYmFzZUZyZXF1ZW5jeSIsCiAgImJhc2VsaW5lU2hpZnQiLAogICJiYXNlUHJvZmlsZSIsCiAgImJib3giLAogICJiZWdpbiIsCiAgImJpYXMiLAogICJieSIsCiAgImNhbGNNb2RlIiwKICAiY2FwSGVpZ2h0IiwKICAiY2xpcCIsCiAgImNsaXBQYXRoIiwKICAiY2xpcFBhdGhVbml0cyIsCiAgImNsaXBSdWxlIiwKICAiY29sb3JJbnRlcnBvbGF0aW9uIiwKICAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgImNvbG9yUHJvZmlsZSIsCiAgImNvbG9yUmVuZGVyaW5nIiwKICAiY29udGVudFNjcmlwdFR5cGUiLAogICJjb250ZW50U3R5bGVUeXBlIiwKICAiY3Vyc29yIiwKICAiY3giLAogICJjeSIsCiAgImQiLAogICJkZWNlbGVyYXRlIiwKICAiZGVzY2VudCIsCiAgImRpZmZ1c2VDb25zdGFudCIsCiAgImRpcmVjdGlvbiIsCiAgImRpc3BsYXkiLAogICJkaXZpc29yIiwKICAiZG9taW5hbnRCYXNlbGluZSIsCiAgImR1ciIsCiAgImR4IiwKICAiZHkiLAogICJlZGdlTW9kZSIsCiAgImVsZXZhdGlvbiIsCiAgImVuYWJsZUJhY2tncm91bmQiLAogICJlbmQiLAogICJleHBvbmVudCIsCiAgImV4dGVybmFsUmVzb3VyY2VzUmVxdWlyZWQiLAogICJmaWxsIiwKICAiZmlsbE9wYWNpdHkiLAogICJmaWxsUnVsZSIsCiAgImZpbHRlciIsCiAgImZpbHRlclJlcyIsCiAgImZpbHRlclVuaXRzIiwKICAiZmxvb2RDb2xvciIsCiAgImZsb29kT3BhY2l0eSIsCiAgImZvY3VzYWJsZSIsCiAgImZvbnRGYW1pbHkiLAogICJmb250U2l6ZSIsCiAgImZvbnRTaXplQWRqdXN0IiwKICAiZm9udFN0cmV0Y2giLAogICJmb250U3R5bGUiLAogICJmb250VmFyaWFudCIsCiAgImZvbnRXZWlnaHQiLAogICJmb3JtYXQiLAogICJmcm9tIiwKICAiZngiLAogICJmeSIsCiAgImcxIiwKICAiZzIiLAogICJnbHlwaE5hbWUiLAogICJnbHlwaE9yaWVudGF0aW9uSG9yaXpvbnRhbCIsCiAgImdseXBoT3JpZW50YXRpb25WZXJ0aWNhbCIsCiAgImdseXBoUmVmIiwKICAiZ3JhZGllbnRUcmFuc2Zvcm0iLAogICJncmFkaWVudFVuaXRzIiwKICAiaGFuZ2luZyIsCiAgImhvcml6QWR2WCIsCiAgImhvcml6T3JpZ2luWCIsCiAgImhyZWYiLAogICJpZGVvZ3JhcGhpYyIsCiAgImltYWdlUmVuZGVyaW5nIiwKICAiaW4yIiwKICAiaW4iLAogICJpbnRlcmNlcHQiLAogICJrMSIsCiAgImsyIiwKICAiazMiLAogICJrNCIsCiAgImsiLAogICJrZXJuZWxNYXRyaXgiLAogICJrZXJuZWxVbml0TGVuZ3RoIiwKICAia2VybmluZyIsCiAgImtleVBvaW50cyIsCiAgImtleVNwbGluZXMiLAogICJrZXlUaW1lcyIsCiAgImxlbmd0aEFkanVzdCIsCiAgImxldHRlclNwYWNpbmciLAogICJsaWdodGluZ0NvbG9yIiwKICAibGltaXRpbmdDb25lQW5nbGUiLAogICJsb2NhbCIsCiAgIm1hcmtlckVuZCIsCiAgIm1hcmtlckhlaWdodCIsCiAgIm1hcmtlck1pZCIsCiAgIm1hcmtlclN0YXJ0IiwKICAibWFya2VyVW5pdHMiLAogICJtYXJrZXJXaWR0aCIsCiAgIm1hc2siLAogICJtYXNrQ29udGVudFVuaXRzIiwKICAibWFza1VuaXRzIiwKICAibWF0aGVtYXRpY2FsIiwKICAibW9kZSIsCiAgIm51bU9jdGF2ZXMiLAogICJvZmZzZXQiLAogICJvcGFjaXR5IiwKICAib3BlcmF0b3IiLAogICJvcmRlciIsCiAgIm9yaWVudCIsCiAgIm9yaWVudGF0aW9uIiwKICAib3JpZ2luIiwKICAib3ZlcmZsb3ciLAogICJvdmVybGluZVBvc2l0aW9uIiwKICAib3ZlcmxpbmVUaGlja25lc3MiLAogICJwYWludE9yZGVyIiwKICAicGFub3NlMSIsCiAgInBhdGhMZW5ndGgiLAogICJwYXR0ZXJuQ29udGVudFVuaXRzIiwKICAicGF0dGVyblRyYW5zZm9ybSIsCiAgInBhdHRlcm5Vbml0cyIsCiAgInBvaW50ZXJFdmVudHMiLAogICJwb2ludHNBdFgiLAogICJwb2ludHNBdFkiLAogICJwb2ludHNBdFoiLAogICJwcmVzZXJ2ZUFscGhhIiwKICAicHJlc2VydmVBc3BlY3RSYXRpbyIsCiAgInByaW1pdGl2ZVVuaXRzIiwKICAiciIsCiAgInJhZGl1cyIsCiAgInJlZlgiLAogICJyZWZZIiwKICAicmVuZGVyaW5nSW50ZW50IiwKICAicmVwZWF0Q291bnQiLAogICJyZXBlYXREdXIiLAogICJyZXF1aXJlZEV4dGVuc2lvbnMiLAogICJyZXF1aXJlZEZlYXR1cmVzIiwKICAicmVzdGFydCIsCiAgInJlc3VsdCIsCiAgInJvdGF0ZSIsCiAgInJ4IiwKICAicnkiLAogICJzZWVkIiwKICAic2hhcGVSZW5kZXJpbmciLAogICJzbG9wZSIsCiAgInNwYWNpbmciLAogICJzcGVjdWxhckNvbnN0YW50IiwKICAic3BlY3VsYXJFeHBvbmVudCIsCiAgInNwZWVkIiwKICAic3ByZWFkTWV0aG9kIiwKICAic3RhcnRPZmZzZXQiLAogICJzdGREZXZpYXRpb24iLAogICJzdGVtaCIsCiAgInN0ZW12IiwKICAic3RpdGNoVGlsZXMiLAogICJzdG9wQ29sb3IiLAogICJzdG9wT3BhY2l0eSIsCiAgInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICJzdHJpbmciLAogICJzdHJva2UiLAogICJzdHJva2VEYXNoYXJyYXkiLAogICJzdHJva2VEYXNob2Zmc2V0IiwKICAic3Ryb2tlTGluZWNhcCIsCiAgInN0cm9rZUxpbmVqb2luIiwKICAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgInN0cm9rZU9wYWNpdHkiLAogICJzdHJva2VXaWR0aCIsCiAgInN1cmZhY2VTY2FsZSIsCiAgInN5c3RlbUxhbmd1YWdlIiwKICAidGFibGVWYWx1ZXMiLAogICJ0YXJnZXRYIiwKICAidGFyZ2V0WSIsCiAgInRleHRBbmNob3IiLAogICJ0ZXh0RGVjb3JhdGlvbiIsCiAgInRleHRMZW5ndGgiLAogICJ0ZXh0UmVuZGVyaW5nIiwKICAidG8iLAogICJ0cmFuc2Zvcm0iLAogICJ1MSIsCiAgInUyIiwKICAidW5kZXJsaW5lUG9zaXRpb24iLAogICJ1bmRlcmxpbmVUaGlja25lc3MiLAogICJ1bmljb2RlIiwKICAidW5pY29kZUJpZGkiLAogICJ1bmljb2RlUmFuZ2UiLAogICJ1bml0c1BlckVtIiwKICAidkFscGhhYmV0aWMiLAogICJ2YWx1ZXMiLAogICJ2ZWN0b3JFZmZlY3QiLAogICJ2ZXJzaW9uIiwKICAidmVydEFkdlkiLAogICJ2ZXJ0T3JpZ2luWCIsCiAgInZlcnRPcmlnaW5ZIiwKICAidkhhbmdpbmciLAogICJ2SWRlb2dyYXBoaWMiLAogICJ2aWV3VGFyZ2V0IiwKICAidmlzaWJpbGl0eSIsCiAgInZNYXRoZW1hdGljYWwiLAogICJ3aWR0aHMiLAogICJ3b3JkU3BhY2luZyIsCiAgIndyaXRpbmdNb2RlIiwKICAieDEiLAogICJ4MiIsCiAgIngiLAogICJ4Q2hhbm5lbFNlbGVjdG9yIiwKICAieEhlaWdodCIsCiAgInhsaW5rQWN0dWF0ZSIsCiAgInhsaW5rQXJjcm9sZSIsCiAgInhsaW5rSHJlZiIsCiAgInhsaW5rUm9sZSIsCiAgInhsaW5rU2hvdyIsCiAgInhsaW5rVGl0bGUiLAogICJ4bGlua1R5cGUiLAogICJ4bWxCYXNlIiwKICAieG1sTGFuZyIsCiAgInhtbG5zIiwKICAieG1sbnNYbGluayIsCiAgInhtbFNwYWNlIiwKICAieTEiLAogICJ5MiIsCiAgInkiLAogICJ5Q2hhbm5lbFNlbGVjdG9yIiwKICAieiIsCiAgInpvb21BbmRQYW4iLAogICJyZWYiLAogICJrZXkiLAogICJhbmdsZSIKXTsKdmFyIFNWR0VsZW1lbnRQcm9wS2V5U2V0ID0gbmV3IFNldChTVkdFbGVtZW50UHJvcEtleXMpOwpmdW5jdGlvbiBpc1N2Z0VsZW1lbnRQcm9wS2V5KGtleSkgewogIGlmICh0eXBlb2Yga2V5ICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gU1ZHRWxlbWVudFByb3BLZXlTZXQuaGFzKGtleSk7Cn0KZnVuY3Rpb24gaXNEYXRhQXR0cmlidXRlKGtleSkgewogIHJldHVybiB0eXBlb2Yga2V5ID09PSAic3RyaW5nIiAmJiBrZXkuc3RhcnRzV2l0aCgiZGF0YS0iKTsKfQpmdW5jdGlvbiBzdmdQcm9wZXJ0aWVzTm9FdmVudHMob2JqKSB7CiAgaWYgKHR5cGVvZiBvYmogIT09ICJvYmplY3QiIHx8IG9iaiA9PT0gbnVsbCkgewogICAgcmV0dXJuIHt9OwogIH0KICB2YXIgcmVzdWx0ID0ge307CiAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHsKICAgICAgaWYgKGlzU3ZnRWxlbWVudFByb3BLZXkoa2V5KSB8fCBpc0RhdGFBdHRyaWJ1dGUoa2V5KSkgewogICAgICAgIHJlc3VsdFtrZXldID0gb2JqW2tleV07CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiBzdmdQcm9wZXJ0aWVzTm9FdmVudHNGcm9tVW5rbm93bihpbnB1dCkgewogIGlmIChpbnB1dCA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0My5pc1ZhbGlkRWxlbWVudCkoaW5wdXQpICYmIHR5cGVvZiBpbnB1dC5wcm9wcyA9PT0gIm9iamVjdCIgJiYgaW5wdXQucHJvcHMgIT09IG51bGwpIHsKICAgIHZhciBwID0gaW5wdXQucHJvcHM7CiAgICByZXR1cm4gc3ZnUHJvcGVydGllc05vRXZlbnRzKHApOwogIH0KICBpZiAodHlwZW9mIGlucHV0ID09PSAib2JqZWN0IiAmJiAhQXJyYXkuaXNBcnJheShpbnB1dCkpIHsKICAgIHJldHVybiBzdmdQcm9wZXJ0aWVzTm9FdmVudHMoaW5wdXQpOwogIH0KICByZXR1cm4gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zdmdQcm9wZXJ0aWVzQW5kRXZlbnRzLmpzCmZ1bmN0aW9uIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMob2JqKSB7CiAgdmFyIHJlc3VsdCA9IHt9OwogIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSB7CiAgICAgIGlmIChpc1N2Z0VsZW1lbnRQcm9wS2V5KGtleSkgfHwgaXNEYXRhQXR0cmlidXRlKGtleSkgfHwgaXNFdmVudEtleShrZXkpKSB7CiAgICAgICAgcmVzdWx0W2tleV0gPSBvYmpba2V5XTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHNGcm9tVW5rbm93bihpbnB1dCkgewogIGlmIChpbnB1dCA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NC5pc1ZhbGlkRWxlbWVudCkoaW5wdXQpKSB7CiAgICByZXR1cm4gc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhpbnB1dC5wcm9wcyk7CiAgfQogIGlmICh0eXBlb2YgaW5wdXQgPT09ICJvYmplY3QiICYmICFBcnJheS5pc0FycmF5KGlucHV0KSkgewogICAgcmV0dXJuIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMoaW5wdXQpOwogIH0KICByZXR1cm4gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL1N1cmZhY2UuanMKdmFyIF9leGNsdWRlZCA9IFsiY2hpbGRyZW4iLCAid2lkdGgiLCAiaGVpZ2h0IiwgInZpZXdCb3giLCAiY2xhc3NOYW1lIiwgInN0eWxlIiwgInRpdGxlIiwgImRlc2MiXTsKZnVuY3Rpb24gX2V4dGVuZHMoKSB7CiAgcmV0dXJuIF9leHRlbmRzID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZShlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgU3VyZmFjZSA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NS5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICBjaGlsZHJlbiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgdmlld0JveCwKICAgIGNsYXNzTmFtZSwKICAgIHN0eWxlLAogICAgdGl0bGUsCiAgICBkZXNjCiAgfSA9IHByb3BzLCBvdGhlcnMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMocHJvcHMsIF9leGNsdWRlZCk7CiAgdmFyIHN2Z1ZpZXcgPSB2aWV3Qm94IHx8IHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgeDogMCwKICAgIHk6IDAKICB9OwogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtc3VyZmFjZSIsIGNsYXNzTmFtZSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdC5jcmVhdGVFbGVtZW50KCJzdmciLCBfZXh0ZW5kcyh7fSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhvdGhlcnMpLCB7CiAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHN0eWxlLAogICAgdmlld0JveDogIiIuY29uY2F0KHN2Z1ZpZXcueCwgIiAiKS5jb25jYXQoc3ZnVmlldy55LCAiICIpLmNvbmNhdChzdmdWaWV3LndpZHRoLCAiICIpLmNvbmNhdChzdmdWaWV3LmhlaWdodCksCiAgICByZWYKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0LmNyZWF0ZUVsZW1lbnQoInRpdGxlIiwgbnVsbCwgdGl0bGUpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QuY3JlYXRlRWxlbWVudCgiZGVzYyIsIG51bGwsIGRlc2MpLCBjaGlsZHJlbik7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL0xheWVyLmpzCnZhciBSZWFjdDIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQyID0gWyJjaGlsZHJlbiIsICJjbGFzc05hbWUiXTsKZnVuY3Rpb24gX2V4dGVuZHMyKCkgewogIHJldHVybiBfZXh0ZW5kczIgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczIuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMyKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UyKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UyKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgTGF5ZXIgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyLmZvcndhcmRSZWYoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICBjbGFzc05hbWUKICB9ID0gcHJvcHMsIG90aGVycyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczIocHJvcHMsIF9leGNsdWRlZDIpOwogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtbGF5ZXIiLCBjbGFzc05hbWUpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyLmNyZWF0ZUVsZW1lbnQoImciLCBfZXh0ZW5kczIoewogICAgY2xhc3NOYW1lOiBsYXllckNsYXNzCiAgfSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhvdGhlcnMpLCB7CiAgICByZWYKICB9KSwgY2hpbGRyZW4pOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvbGVnZW5kUG9ydGFsQ29udGV4dC5qcwp2YXIgaW1wb3J0X3JlYWN0NiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIExlZ2VuZFBvcnRhbENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDYuY3JlYXRlQ29udGV4dCkobnVsbCk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jb25zdGFudC5qcwpmdW5jdGlvbiBjb25zdGFudF9kZWZhdWx0KHgyKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIGNvbnN0YW50KCkgewogICAgcmV0dXJuIHgyOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1wYXRoQDMuMS4wL25vZGVfbW9kdWxlcy9kMy1wYXRoL3NyYy9wYXRoLmpzCnZhciBwaSA9IE1hdGguUEk7CnZhciB0YXUgPSAyICogcGk7CnZhciBlcHNpbG9uID0gMWUtNjsKdmFyIHRhdUVwc2lsb24gPSB0YXUgLSBlcHNpbG9uOwpmdW5jdGlvbiBhcHBlbmQoc3RyaW5ncykgewogIHRoaXMuXyArPSBzdHJpbmdzWzBdOwogIGZvciAobGV0IGkgPSAxLCBuID0gc3RyaW5ncy5sZW5ndGg7IGkgPCBuOyArK2kpIHsKICAgIHRoaXMuXyArPSBhcmd1bWVudHNbaV0gKyBzdHJpbmdzW2ldOwogIH0KfQpmdW5jdGlvbiBhcHBlbmRSb3VuZChkaWdpdHMpIHsKICBsZXQgZCA9IE1hdGguZmxvb3IoZGlnaXRzKTsKICBpZiAoIShkID49IDApKSB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgZGlnaXRzOiAke2RpZ2l0c31gKTsKICBpZiAoZCA+IDE1KSByZXR1cm4gYXBwZW5kOwogIGNvbnN0IGsgPSAxMCAqKiBkOwogIHJldHVybiBmdW5jdGlvbihzdHJpbmdzKSB7CiAgICB0aGlzLl8gKz0gc3RyaW5nc1swXTsKICAgIGZvciAobGV0IGkgPSAxLCBuID0gc3RyaW5ncy5sZW5ndGg7IGkgPCBuOyArK2kpIHsKICAgICAgdGhpcy5fICs9IE1hdGgucm91bmQoYXJndW1lbnRzW2ldICogaykgLyBrICsgc3RyaW5nc1tpXTsKICAgIH0KICB9Owp9CnZhciBQYXRoID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGRpZ2l0cykgewogICAgdGhpcy5feDAgPSB0aGlzLl95MCA9IC8vIHN0YXJ0IG9mIGN1cnJlbnQgc3VicGF0aAogICAgdGhpcy5feDEgPSB0aGlzLl95MSA9IG51bGw7CiAgICB0aGlzLl8gPSAiIjsKICAgIHRoaXMuX2FwcGVuZCA9IGRpZ2l0cyA9PSBudWxsID8gYXBwZW5kIDogYXBwZW5kUm91bmQoZGlnaXRzKTsKICB9CiAgbW92ZVRvKHgyLCB5MikgewogICAgdGhpcy5fYXBwZW5kYE0ke3RoaXMuX3gwID0gdGhpcy5feDEgPSAreDJ9LCR7dGhpcy5feTAgPSB0aGlzLl95MSA9ICt5Mn1gOwogIH0KICBjbG9zZVBhdGgoKSB7CiAgICBpZiAodGhpcy5feDEgIT09IG51bGwpIHsKICAgICAgdGhpcy5feDEgPSB0aGlzLl94MCwgdGhpcy5feTEgPSB0aGlzLl95MDsKICAgICAgdGhpcy5fYXBwZW5kYFpgOwogICAgfQogIH0KICBsaW5lVG8oeDIsIHkyKSB7CiAgICB0aGlzLl9hcHBlbmRgTCR7dGhpcy5feDEgPSAreDJ9LCR7dGhpcy5feTEgPSAreTJ9YDsKICB9CiAgcXVhZHJhdGljQ3VydmVUbyh4MSwgeTEsIHgyLCB5MikgewogICAgdGhpcy5fYXBwZW5kYFEkeyt4MX0sJHsreTF9LCR7dGhpcy5feDEgPSAreDJ9LCR7dGhpcy5feTEgPSAreTJ9YDsKICB9CiAgYmV6aWVyQ3VydmVUbyh4MSwgeTEsIHgyLCB5MiwgeDMsIHkzKSB7CiAgICB0aGlzLl9hcHBlbmRgQyR7K3gxfSwkeyt5MX0sJHsreDJ9LCR7K3kyfSwke3RoaXMuX3gxID0gK3gzfSwke3RoaXMuX3kxID0gK3kzfWA7CiAgfQogIGFyY1RvKHgxLCB5MSwgeDIsIHkyLCByMikgewogICAgeDEgPSAreDEsIHkxID0gK3kxLCB4MiA9ICt4MiwgeTIgPSAreTIsIHIyID0gK3IyOwogICAgaWYgKHIyIDwgMCkgdGhyb3cgbmV3IEVycm9yKGBuZWdhdGl2ZSByYWRpdXM6ICR7cjJ9YCk7CiAgICBsZXQgeDAgPSB0aGlzLl94MSwgeTAgPSB0aGlzLl95MSwgeDIxID0geDIgLSB4MSwgeTIxID0geTIgLSB5MSwgeDAxID0geDAgLSB4MSwgeTAxID0geTAgLSB5MSwgbDAxXzIgPSB4MDEgKiB4MDEgKyB5MDEgKiB5MDE7CiAgICBpZiAodGhpcy5feDEgPT09IG51bGwpIHsKICAgICAgdGhpcy5fYXBwZW5kYE0ke3RoaXMuX3gxID0geDF9LCR7dGhpcy5feTEgPSB5MX1gOwogICAgfSBlbHNlIGlmICghKGwwMV8yID4gZXBzaWxvbikpIDsKICAgIGVsc2UgaWYgKCEoTWF0aC5hYnMoeTAxICogeDIxIC0geTIxICogeDAxKSA+IGVwc2lsb24pIHx8ICFyMikgewogICAgICB0aGlzLl9hcHBlbmRgTCR7dGhpcy5feDEgPSB4MX0sJHt0aGlzLl95MSA9IHkxfWA7CiAgICB9IGVsc2UgewogICAgICBsZXQgeDIwID0geDIgLSB4MCwgeTIwID0geTIgLSB5MCwgbDIxXzIgPSB4MjEgKiB4MjEgKyB5MjEgKiB5MjEsIGwyMF8yID0geDIwICogeDIwICsgeTIwICogeTIwLCBsMjEgPSBNYXRoLnNxcnQobDIxXzIpLCBsMDEgPSBNYXRoLnNxcnQobDAxXzIpLCBsID0gcjIgKiBNYXRoLnRhbigocGkgLSBNYXRoLmFjb3MoKGwyMV8yICsgbDAxXzIgLSBsMjBfMikgLyAoMiAqIGwyMSAqIGwwMSkpKSAvIDIpLCB0MDEgPSBsIC8gbDAxLCB0MjEgPSBsIC8gbDIxOwogICAgICBpZiAoTWF0aC5hYnModDAxIC0gMSkgPiBlcHNpbG9uKSB7CiAgICAgICAgdGhpcy5fYXBwZW5kYEwke3gxICsgdDAxICogeDAxfSwke3kxICsgdDAxICogeTAxfWA7CiAgICAgIH0KICAgICAgdGhpcy5fYXBwZW5kYEEke3IyfSwke3IyfSwwLDAsJHsrKHkwMSAqIHgyMCA+IHgwMSAqIHkyMCl9LCR7dGhpcy5feDEgPSB4MSArIHQyMSAqIHgyMX0sJHt0aGlzLl95MSA9IHkxICsgdDIxICogeTIxfWA7CiAgICB9CiAgfQogIGFyYyh4MiwgeTIsIHIyLCBhMCwgYTEsIGNjdykgewogICAgeDIgPSAreDIsIHkyID0gK3kyLCByMiA9ICtyMiwgY2N3ID0gISFjY3c7CiAgICBpZiAocjIgPCAwKSB0aHJvdyBuZXcgRXJyb3IoYG5lZ2F0aXZlIHJhZGl1czogJHtyMn1gKTsKICAgIGxldCBkeCA9IHIyICogTWF0aC5jb3MoYTApLCBkeSA9IHIyICogTWF0aC5zaW4oYTApLCB4MCA9IHgyICsgZHgsIHkwID0geTIgKyBkeSwgY3cgPSAxIF4gY2N3LCBkYSA9IGNjdyA/IGEwIC0gYTEgOiBhMSAtIGEwOwogICAgaWYgKHRoaXMuX3gxID09PSBudWxsKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBNJHt4MH0sJHt5MH1gOwogICAgfSBlbHNlIGlmIChNYXRoLmFicyh0aGlzLl94MSAtIHgwKSA+IGVwc2lsb24gfHwgTWF0aC5hYnModGhpcy5feTEgLSB5MCkgPiBlcHNpbG9uKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBMJHt4MH0sJHt5MH1gOwogICAgfQogICAgaWYgKCFyMikgcmV0dXJuOwogICAgaWYgKGRhIDwgMCkgZGEgPSBkYSAlIHRhdSArIHRhdTsKICAgIGlmIChkYSA+IHRhdUVwc2lsb24pIHsKICAgICAgdGhpcy5fYXBwZW5kYEEke3IyfSwke3IyfSwwLDEsJHtjd30sJHt4MiAtIGR4fSwke3kyIC0gZHl9QSR7cjJ9LCR7cjJ9LDAsMSwke2N3fSwke3RoaXMuX3gxID0geDB9LCR7dGhpcy5feTEgPSB5MH1gOwogICAgfSBlbHNlIGlmIChkYSA+IGVwc2lsb24pIHsKICAgICAgdGhpcy5fYXBwZW5kYEEke3IyfSwke3IyfSwwLCR7KyhkYSA+PSBwaSl9LCR7Y3d9LCR7dGhpcy5feDEgPSB4MiArIHIyICogTWF0aC5jb3MoYTEpfSwke3RoaXMuX3kxID0geTIgKyByMiAqIE1hdGguc2luKGExKX1gOwogICAgfQogIH0KICByZWN0KHgyLCB5MiwgdywgaCkgewogICAgdGhpcy5fYXBwZW5kYE0ke3RoaXMuX3gwID0gdGhpcy5feDEgPSAreDJ9LCR7dGhpcy5feTAgPSB0aGlzLl95MSA9ICt5Mn1oJHt3ID0gK3d9diR7K2h9aCR7LXd9WmA7CiAgfQogIHRvU3RyaW5nKCkgewogICAgcmV0dXJuIHRoaXMuXzsKICB9Cn07CmZ1bmN0aW9uIHBhdGgoKSB7CiAgcmV0dXJuIG5ldyBQYXRoKCk7Cn0KcGF0aC5wcm90b3R5cGUgPSBQYXRoLnByb3RvdHlwZTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL3BhdGguanMKZnVuY3Rpb24gd2l0aFBhdGgoc2hhcGUpIHsKICBsZXQgZGlnaXRzID0gMzsKICBzaGFwZS5kaWdpdHMgPSBmdW5jdGlvbihfKSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBkaWdpdHM7CiAgICBpZiAoXyA9PSBudWxsKSB7CiAgICAgIGRpZ2l0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBkID0gTWF0aC5mbG9vcihfKTsKICAgICAgaWYgKCEoZCA+PSAwKSkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoYGludmFsaWQgZGlnaXRzOiAke199YCk7CiAgICAgIGRpZ2l0cyA9IGQ7CiAgICB9CiAgICByZXR1cm4gc2hhcGU7CiAgfTsKICByZXR1cm4gKCkgPT4gbmV3IFBhdGgoZGlnaXRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvYXJyYXkuanMKdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwpmdW5jdGlvbiBhcnJheV9kZWZhdWx0KHgyKSB7CiAgcmV0dXJuIHR5cGVvZiB4MiA9PT0gIm9iamVjdCIgJiYgImxlbmd0aCIgaW4geDIgPyB4MiA6IEFycmF5LmZyb20oeDIpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9saW5lYXIuanMKZnVuY3Rpb24gTGluZWFyKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpMaW5lYXIucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9LAogIGFyZWFFbmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgdGhpcy5fcG9pbnQgPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLl9wb2ludCA9IDE7CiAgICAgICAgdGhpcy5fbGluZSA/IHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5MikgOiB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICBkZWZhdWx0OgogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgfQp9OwpmdW5jdGlvbiBsaW5lYXJfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBMaW5lYXIoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL3BvaW50LmpzCmZ1bmN0aW9uIHgocCkgewogIHJldHVybiBwWzBdOwp9CmZ1bmN0aW9uIHkocCkgewogIHJldHVybiBwWzFdOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9saW5lLmpzCmZ1bmN0aW9uIGxpbmVfZGVmYXVsdCh4MiwgeTIpIHsKICB2YXIgZGVmaW5lZDIgPSBjb25zdGFudF9kZWZhdWx0KHRydWUpLCBjb250ZXh0ID0gbnVsbCwgY3VydmUgPSBsaW5lYXJfZGVmYXVsdCwgb3V0cHV0ID0gbnVsbCwgcGF0aDIgPSB3aXRoUGF0aChsaW5lKTsKICB4MiA9IHR5cGVvZiB4MiA9PT0gImZ1bmN0aW9uIiA/IHgyIDogeDIgPT09IHZvaWQgMCA/IHggOiBjb25zdGFudF9kZWZhdWx0KHgyKTsKICB5MiA9IHR5cGVvZiB5MiA9PT0gImZ1bmN0aW9uIiA/IHkyIDogeTIgPT09IHZvaWQgMCA/IHkgOiBjb25zdGFudF9kZWZhdWx0KHkyKTsKICBmdW5jdGlvbiBsaW5lKGRhdGEpIHsKICAgIHZhciBpLCBuID0gKGRhdGEgPSBhcnJheV9kZWZhdWx0KGRhdGEpKS5sZW5ndGgsIGQsIGRlZmluZWQwID0gZmFsc2UsIGJ1ZmZlcjsKICAgIGlmIChjb250ZXh0ID09IG51bGwpIG91dHB1dCA9IGN1cnZlKGJ1ZmZlciA9IHBhdGgyKCkpOwogICAgZm9yIChpID0gMDsgaSA8PSBuOyArK2kpIHsKICAgICAgaWYgKCEoaSA8IG4gJiYgZGVmaW5lZDIoZCA9IGRhdGFbaV0sIGksIGRhdGEpKSA9PT0gZGVmaW5lZDApIHsKICAgICAgICBpZiAoZGVmaW5lZDAgPSAhZGVmaW5lZDApIG91dHB1dC5saW5lU3RhcnQoKTsKICAgICAgICBlbHNlIG91dHB1dC5saW5lRW5kKCk7CiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQwKSBvdXRwdXQucG9pbnQoK3gyKGQsIGksIGRhdGEpLCAreTIoZCwgaSwgZGF0YSkpOwogICAgfQogICAgaWYgKGJ1ZmZlcikgcmV0dXJuIG91dHB1dCA9IG51bGwsIGJ1ZmZlciArICIiIHx8IG51bGw7CiAgfQogIGxpbmUueCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHgyID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIGxpbmUpIDogeDI7CiAgfTsKICBsaW5lLnkgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh5MiA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBsaW5lKSA6IHkyOwogIH07CiAgbGluZS5kZWZpbmVkID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZGVmaW5lZDIgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCEhXyksIGxpbmUpIDogZGVmaW5lZDI7CiAgfTsKICBsaW5lLmN1cnZlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoY3VydmUgPSBfLCBjb250ZXh0ICE9IG51bGwgJiYgKG91dHB1dCA9IGN1cnZlKGNvbnRleHQpKSwgbGluZSkgOiBjdXJ2ZTsKICB9OwogIGxpbmUuY29udGV4dCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKF8gPT0gbnVsbCA/IGNvbnRleHQgPSBvdXRwdXQgPSBudWxsIDogb3V0cHV0ID0gY3VydmUoY29udGV4dCA9IF8pLCBsaW5lKSA6IGNvbnRleHQ7CiAgfTsKICByZXR1cm4gbGluZTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvYXJlYS5qcwpmdW5jdGlvbiBhcmVhX2RlZmF1bHQoeDAsIHkwLCB5MSkgewogIHZhciB4MSA9IG51bGwsIGRlZmluZWQyID0gY29uc3RhbnRfZGVmYXVsdCh0cnVlKSwgY29udGV4dCA9IG51bGwsIGN1cnZlID0gbGluZWFyX2RlZmF1bHQsIG91dHB1dCA9IG51bGwsIHBhdGgyID0gd2l0aFBhdGgoYXJlYSk7CiAgeDAgPSB0eXBlb2YgeDAgPT09ICJmdW5jdGlvbiIgPyB4MCA6IHgwID09PSB2b2lkIDAgPyB4IDogY29uc3RhbnRfZGVmYXVsdCgreDApOwogIHkwID0gdHlwZW9mIHkwID09PSAiZnVuY3Rpb24iID8geTAgOiB5MCA9PT0gdm9pZCAwID8gY29uc3RhbnRfZGVmYXVsdCgwKSA6IGNvbnN0YW50X2RlZmF1bHQoK3kwKTsKICB5MSA9IHR5cGVvZiB5MSA9PT0gImZ1bmN0aW9uIiA/IHkxIDogeTEgPT09IHZvaWQgMCA/IHkgOiBjb25zdGFudF9kZWZhdWx0KCt5MSk7CiAgZnVuY3Rpb24gYXJlYShkYXRhKSB7CiAgICB2YXIgaSwgaiwgaywgbiA9IChkYXRhID0gYXJyYXlfZGVmYXVsdChkYXRhKSkubGVuZ3RoLCBkLCBkZWZpbmVkMCA9IGZhbHNlLCBidWZmZXIsIHgweiA9IG5ldyBBcnJheShuKSwgeTB6ID0gbmV3IEFycmF5KG4pOwogICAgaWYgKGNvbnRleHQgPT0gbnVsbCkgb3V0cHV0ID0gY3VydmUoYnVmZmVyID0gcGF0aDIoKSk7CiAgICBmb3IgKGkgPSAwOyBpIDw9IG47ICsraSkgewogICAgICBpZiAoIShpIDwgbiAmJiBkZWZpbmVkMihkID0gZGF0YVtpXSwgaSwgZGF0YSkpID09PSBkZWZpbmVkMCkgewogICAgICAgIGlmIChkZWZpbmVkMCA9ICFkZWZpbmVkMCkgewogICAgICAgICAgaiA9IGk7CiAgICAgICAgICBvdXRwdXQuYXJlYVN0YXJ0KCk7CiAgICAgICAgICBvdXRwdXQubGluZVN0YXJ0KCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG91dHB1dC5saW5lRW5kKCk7CiAgICAgICAgICBvdXRwdXQubGluZVN0YXJ0KCk7CiAgICAgICAgICBmb3IgKGsgPSBpIC0gMTsgayA+PSBqOyAtLWspIHsKICAgICAgICAgICAgb3V0cHV0LnBvaW50KHgweltrXSwgeTB6W2tdKTsKICAgICAgICAgIH0KICAgICAgICAgIG91dHB1dC5saW5lRW5kKCk7CiAgICAgICAgICBvdXRwdXQuYXJlYUVuZCgpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoZGVmaW5lZDApIHsKICAgICAgICB4MHpbaV0gPSAreDAoZCwgaSwgZGF0YSksIHkweltpXSA9ICt5MChkLCBpLCBkYXRhKTsKICAgICAgICBvdXRwdXQucG9pbnQoeDEgPyAreDEoZCwgaSwgZGF0YSkgOiB4MHpbaV0sIHkxID8gK3kxKGQsIGksIGRhdGEpIDogeTB6W2ldKTsKICAgICAgfQogICAgfQogICAgaWYgKGJ1ZmZlcikgcmV0dXJuIG91dHB1dCA9IG51bGwsIGJ1ZmZlciArICIiIHx8IG51bGw7CiAgfQogIGZ1bmN0aW9uIGFyZWFsaW5lKCkgewogICAgcmV0dXJuIGxpbmVfZGVmYXVsdCgpLmRlZmluZWQoZGVmaW5lZDIpLmN1cnZlKGN1cnZlKS5jb250ZXh0KGNvbnRleHQpOwogIH0KICBhcmVhLnggPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh4MCA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCB4MSA9IG51bGwsIGFyZWEpIDogeDA7CiAgfTsKICBhcmVhLngwID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeDAgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgYXJlYSkgOiB4MDsKICB9OwogIGFyZWEueDEgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh4MSA9IF8gPT0gbnVsbCA/IG51bGwgOiB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgYXJlYSkgOiB4MTsKICB9OwogIGFyZWEueSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHkwID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIHkxID0gbnVsbCwgYXJlYSkgOiB5MDsKICB9OwogIGFyZWEueTAgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh5MCA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBhcmVhKSA6IHkwOwogIH07CiAgYXJlYS55MSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHkxID0gXyA9PSBudWxsID8gbnVsbCA6IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBhcmVhKSA6IHkxOwogIH07CiAgYXJlYS5saW5lWDAgPSBhcmVhLmxpbmVZMCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGFyZWFsaW5lKCkueCh4MCkueSh5MCk7CiAgfTsKICBhcmVhLmxpbmVZMSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGFyZWFsaW5lKCkueCh4MCkueSh5MSk7CiAgfTsKICBhcmVhLmxpbmVYMSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGFyZWFsaW5lKCkueCh4MSkueSh5MCk7CiAgfTsKICBhcmVhLmRlZmluZWQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkZWZpbmVkMiA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoISFfKSwgYXJlYSkgOiBkZWZpbmVkMjsKICB9OwogIGFyZWEuY3VydmUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChjdXJ2ZSA9IF8sIGNvbnRleHQgIT0gbnVsbCAmJiAob3V0cHV0ID0gY3VydmUoY29udGV4dCkpLCBhcmVhKSA6IGN1cnZlOwogIH07CiAgYXJlYS5jb250ZXh0ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoXyA9PSBudWxsID8gY29udGV4dCA9IG91dHB1dCA9IG51bGwgOiBvdXRwdXQgPSBjdXJ2ZShjb250ZXh0ID0gXyksIGFyZWEpIDogY29udGV4dDsKICB9OwogIHJldHVybiBhcmVhOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9idW1wLmpzCnZhciBCdW1wID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGNvbnRleHQsIHgyKSB7CiAgICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKICAgIHRoaXMuX3ggPSB4MjsKICB9CiAgYXJlYVN0YXJ0KCkgewogICAgdGhpcy5fbGluZSA9IDA7CiAgfQogIGFyZWFFbmQoKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0KICBsaW5lU3RhcnQoKSB7CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfQogIGxpbmVFbmQoKSB7CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIHRoaXMuX3BvaW50ID09PSAxKSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0KICBwb2ludCh4MiwgeTIpIHsKICAgIHgyID0gK3gyLCB5MiA9ICt5MjsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAwOiB7CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIGlmICh0aGlzLl9saW5lKSB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpOwogICAgICAgIGVsc2UgdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICBkZWZhdWx0OiB7CiAgICAgICAgaWYgKHRoaXMuX3gpIHRoaXMuX2NvbnRleHQuYmV6aWVyQ3VydmVUbyh0aGlzLl94MCA9ICh0aGlzLl94MCArIHgyKSAvIDIsIHRoaXMuX3kwLCB0aGlzLl94MCwgeTIsIHgyLCB5Mik7CiAgICAgICAgZWxzZSB0aGlzLl9jb250ZXh0LmJlemllckN1cnZlVG8odGhpcy5feDAsIHRoaXMuX3kwID0gKHRoaXMuX3kwICsgeTIpIC8gMiwgeDIsIHRoaXMuX3kwLCB4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICB0aGlzLl94MCA9IHgyLCB0aGlzLl95MCA9IHkyOwogIH0KfTsKZnVuY3Rpb24gYnVtcFgoY29udGV4dCkgewogIHJldHVybiBuZXcgQnVtcChjb250ZXh0LCB0cnVlKTsKfQpmdW5jdGlvbiBidW1wWShjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBCdW1wKGNvbnRleHQsIGZhbHNlKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvbm9vcC5qcwpmdW5jdGlvbiBub29wX2RlZmF1bHQoKSB7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL2Jhc2lzLmpzCmZ1bmN0aW9uIHBvaW50KHRoYXQsIHgyLCB5MikgewogIHRoYXQuX2NvbnRleHQuYmV6aWVyQ3VydmVUbygKICAgICgyICogdGhhdC5feDAgKyB0aGF0Ll94MSkgLyAzLAogICAgKDIgKiB0aGF0Ll95MCArIHRoYXQuX3kxKSAvIDMsCiAgICAodGhhdC5feDAgKyAyICogdGhhdC5feDEpIC8gMywKICAgICh0aGF0Ll95MCArIDIgKiB0aGF0Ll95MSkgLyAzLAogICAgKHRoYXQuX3gwICsgNCAqIHRoYXQuX3gxICsgeDIpIC8gNiwKICAgICh0aGF0Ll95MCArIDQgKiB0aGF0Ll95MSArIHkyKSAvIDYKICApOwp9CmZ1bmN0aW9uIEJhc2lzKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpCYXNpcy5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feDEgPSB0aGlzLl95MCA9IHRoaXMuX3kxID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMzoKICAgICAgICBwb2ludCh0aGlzLCB0aGlzLl94MSwgdGhpcy5feTEpOwogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8odGhpcy5feDEsIHRoaXMuX3kxKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgdGhpcy5fcG9pbnQgPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLl9wb2ludCA9IDE7CiAgICAgICAgdGhpcy5fbGluZSA/IHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5MikgOiB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAzOwogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKCg1ICogdGhpcy5feDAgKyB0aGlzLl94MSkgLyA2LCAoNSAqIHRoaXMuX3kwICsgdGhpcy5feTEpIC8gNik7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcG9pbnQodGhpcywgeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIHRoaXMuX3gwID0gdGhpcy5feDEsIHRoaXMuX3gxID0geDI7CiAgICB0aGlzLl95MCA9IHRoaXMuX3kxLCB0aGlzLl95MSA9IHkyOwogIH0KfTsKZnVuY3Rpb24gYmFzaXNfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBCYXNpcyhjb250ZXh0KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvYmFzaXNDbG9zZWQuanMKZnVuY3Rpb24gQmFzaXNDbG9zZWQoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9CkJhc2lzQ2xvc2VkLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IG5vb3BfZGVmYXVsdCwKICBhcmVhRW5kOiBub29wX2RlZmF1bHQsCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feDEgPSB0aGlzLl94MiA9IHRoaXMuX3gzID0gdGhpcy5feDQgPSB0aGlzLl95MCA9IHRoaXMuX3kxID0gdGhpcy5feTIgPSB0aGlzLl95MyA9IHRoaXMuX3k0ID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMTogewogICAgICAgIHRoaXMuX2NvbnRleHQubW92ZVRvKHRoaXMuX3gyLCB0aGlzLl95Mik7CiAgICAgICAgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlIDI6IHsKICAgICAgICB0aGlzLl9jb250ZXh0Lm1vdmVUbygodGhpcy5feDIgKyAyICogdGhpcy5feDMpIC8gMywgKHRoaXMuX3kyICsgMiAqIHRoaXMuX3kzKSAvIDMpOwogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKCh0aGlzLl94MyArIDIgKiB0aGlzLl94MikgLyAzLCAodGhpcy5feTMgKyAyICogdGhpcy5feTIpIC8gMyk7CiAgICAgICAgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlIDM6IHsKICAgICAgICB0aGlzLnBvaW50KHRoaXMuX3gyLCB0aGlzLl95Mik7CiAgICAgICAgdGhpcy5wb2ludCh0aGlzLl94MywgdGhpcy5feTMpOwogICAgICAgIHRoaXMucG9pbnQodGhpcy5feDQsIHRoaXMuX3k0KTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX3gyID0geDIsIHRoaXMuX3kyID0geTI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLl9wb2ludCA9IDI7CiAgICAgICAgdGhpcy5feDMgPSB4MiwgdGhpcy5feTMgPSB5MjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX3BvaW50ID0gMzsKICAgICAgICB0aGlzLl94NCA9IHgyLCB0aGlzLl95NCA9IHkyOwogICAgICAgIHRoaXMuX2NvbnRleHQubW92ZVRvKCh0aGlzLl94MCArIDQgKiB0aGlzLl94MSArIHgyKSAvIDYsICh0aGlzLl95MCArIDQgKiB0aGlzLl95MSArIHkyKSAvIDYpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHBvaW50KHRoaXMsIHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxLCB0aGlzLl94MSA9IHgyOwogICAgdGhpcy5feTAgPSB0aGlzLl95MSwgdGhpcy5feTEgPSB5MjsKICB9Cn07CmZ1bmN0aW9uIGJhc2lzQ2xvc2VkX2RlZmF1bHQoY29udGV4dCkgewogIHJldHVybiBuZXcgQmFzaXNDbG9zZWQoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL2Jhc2lzT3Blbi5qcwpmdW5jdGlvbiBCYXNpc09wZW4oY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9CkJhc2lzT3Blbi5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feDEgPSB0aGlzLl95MCA9IHRoaXMuX3kxID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIHRoaXMuX3BvaW50ID09PSAzKSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDI6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAzOwogICAgICAgIHZhciB4MCA9ICh0aGlzLl94MCArIDQgKiB0aGlzLl94MSArIHgyKSAvIDYsIHkwID0gKHRoaXMuX3kwICsgNCAqIHRoaXMuX3kxICsgeTIpIC8gNjsKICAgICAgICB0aGlzLl9saW5lID8gdGhpcy5fY29udGV4dC5saW5lVG8oeDAsIHkwKSA6IHRoaXMuX2NvbnRleHQubW92ZVRvKHgwLCB5MCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMzoKICAgICAgICB0aGlzLl9wb2ludCA9IDQ7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcG9pbnQodGhpcywgeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIHRoaXMuX3gwID0gdGhpcy5feDEsIHRoaXMuX3gxID0geDI7CiAgICB0aGlzLl95MCA9IHRoaXMuX3kxLCB0aGlzLl95MSA9IHkyOwogIH0KfTsKZnVuY3Rpb24gYmFzaXNPcGVuX2RlZmF1bHQoY29udGV4dCkgewogIHJldHVybiBuZXcgQmFzaXNPcGVuKGNvbnRleHQpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9saW5lYXJDbG9zZWQuanMKZnVuY3Rpb24gTGluZWFyQ2xvc2VkKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpMaW5lYXJDbG9zZWQucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogbm9vcF9kZWZhdWx0LAogIGFyZWFFbmQ6IG5vb3BfZGVmYXVsdCwKICBsaW5lU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5fcG9pbnQpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBpZiAodGhpcy5fcG9pbnQpIHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICBlbHNlIHRoaXMuX3BvaW50ID0gMSwgdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICB9Cn07CmZ1bmN0aW9uIGxpbmVhckNsb3NlZF9kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IExpbmVhckNsb3NlZChjb250ZXh0KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvbW9ub3RvbmUuanMKZnVuY3Rpb24gc2lnbih4MikgewogIHJldHVybiB4MiA8IDAgPyAtMSA6IDE7Cn0KZnVuY3Rpb24gc2xvcGUzKHRoYXQsIHgyLCB5MikgewogIHZhciBoMCA9IHRoYXQuX3gxIC0gdGhhdC5feDAsIGgxID0geDIgLSB0aGF0Ll94MSwgczAgPSAodGhhdC5feTEgLSB0aGF0Ll95MCkgLyAoaDAgfHwgaDEgPCAwICYmIC0wKSwgczEgPSAoeTIgLSB0aGF0Ll95MSkgLyAoaDEgfHwgaDAgPCAwICYmIC0wKSwgcCA9IChzMCAqIGgxICsgczEgKiBoMCkgLyAoaDAgKyBoMSk7CiAgcmV0dXJuIChzaWduKHMwKSArIHNpZ24oczEpKSAqIE1hdGgubWluKE1hdGguYWJzKHMwKSwgTWF0aC5hYnMoczEpLCAwLjUgKiBNYXRoLmFicyhwKSkgfHwgMDsKfQpmdW5jdGlvbiBzbG9wZTIodGhhdCwgdCkgewogIHZhciBoID0gdGhhdC5feDEgLSB0aGF0Ll94MDsKICByZXR1cm4gaCA/ICgzICogKHRoYXQuX3kxIC0gdGhhdC5feTApIC8gaCAtIHQpIC8gMiA6IHQ7Cn0KZnVuY3Rpb24gcG9pbnQyKHRoYXQsIHQwMiwgdDEyKSB7CiAgdmFyIHgwID0gdGhhdC5feDAsIHkwID0gdGhhdC5feTAsIHgxID0gdGhhdC5feDEsIHkxID0gdGhhdC5feTEsIGR4ID0gKHgxIC0geDApIC8gMzsKICB0aGF0Ll9jb250ZXh0LmJlemllckN1cnZlVG8oeDAgKyBkeCwgeTAgKyBkeCAqIHQwMiwgeDEgLSBkeCwgeTEgLSBkeCAqIHQxMiwgeDEsIHkxKTsKfQpmdW5jdGlvbiBNb25vdG9uZVgoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9Ck1vbm90b25lWC5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feDEgPSB0aGlzLl95MCA9IHRoaXMuX3kxID0gdGhpcy5fdDAgPSBOYU47CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHRoaXMuX3gxLCB0aGlzLl95MSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMzoKICAgICAgICBwb2ludDIodGhpcywgdGhpcy5fdDAsIHNsb3BlMih0aGlzLCB0aGlzLl90MCkpOwogICAgICAgIGJyZWFrOwogICAgfQogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiB0aGlzLl9wb2ludCA9PT0gMSkgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIHRoaXMuX2xpbmUgPSAxIC0gdGhpcy5fbGluZTsKICB9LAogIHBvaW50OiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHZhciB0MTIgPSBOYU47CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBpZiAoeDIgPT09IHRoaXMuX3gxICYmIHkyID09PSB0aGlzLl95MSkgcmV0dXJuOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX3BvaW50ID0gMzsKICAgICAgICBwb2ludDIodGhpcywgc2xvcGUyKHRoaXMsIHQxMiA9IHNsb3BlMyh0aGlzLCB4MiwgeTIpKSwgdDEyKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBwb2ludDIodGhpcywgdGhpcy5fdDAsIHQxMiA9IHNsb3BlMyh0aGlzLCB4MiwgeTIpKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIHRoaXMuX3gwID0gdGhpcy5feDEsIHRoaXMuX3gxID0geDI7CiAgICB0aGlzLl95MCA9IHRoaXMuX3kxLCB0aGlzLl95MSA9IHkyOwogICAgdGhpcy5fdDAgPSB0MTI7CiAgfQp9OwpmdW5jdGlvbiBNb25vdG9uZVkoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBuZXcgUmVmbGVjdENvbnRleHQoY29udGV4dCk7Cn0KKE1vbm90b25lWS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKE1vbm90b25lWC5wcm90b3R5cGUpKS5wb2ludCA9IGZ1bmN0aW9uKHgyLCB5MikgewogIE1vbm90b25lWC5wcm90b3R5cGUucG9pbnQuY2FsbCh0aGlzLCB5MiwgeDIpOwp9OwpmdW5jdGlvbiBSZWZsZWN0Q29udGV4dChjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KUmVmbGVjdENvbnRleHQucHJvdG90eXBlID0gewogIG1vdmVUbzogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB0aGlzLl9jb250ZXh0Lm1vdmVUbyh5MiwgeDIpOwogIH0sCiAgY2xvc2VQYXRoOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgfSwKICBsaW5lVG86IGZ1bmN0aW9uKHgyLCB5MikgewogICAgdGhpcy5fY29udGV4dC5saW5lVG8oeTIsIHgyKTsKICB9LAogIGJlemllckN1cnZlVG86IGZ1bmN0aW9uKHgxLCB5MSwgeDIsIHkyLCB4MywgeTMpIHsKICAgIHRoaXMuX2NvbnRleHQuYmV6aWVyQ3VydmVUbyh5MSwgeDEsIHkyLCB4MiwgeTMsIHgzKTsKICB9Cn07CmZ1bmN0aW9uIG1vbm90b25lWChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBNb25vdG9uZVgoY29udGV4dCk7Cn0KZnVuY3Rpb24gbW9ub3RvbmVZKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IE1vbm90b25lWShjb250ZXh0KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvbmF0dXJhbC5qcwpmdW5jdGlvbiBOYXR1cmFsKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpOYXR1cmFsLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IDA7CiAgfSwKICBhcmVhRW5kOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSBOYU47CiAgfSwKICBsaW5lU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5feCA9IFtdOwogICAgdGhpcy5feSA9IFtdOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICB2YXIgeDIgPSB0aGlzLl94LCB5MiA9IHRoaXMuX3ksIG4gPSB4Mi5sZW5ndGg7CiAgICBpZiAobikgewogICAgICB0aGlzLl9saW5lID8gdGhpcy5fY29udGV4dC5saW5lVG8oeDJbMF0sIHkyWzBdKSA6IHRoaXMuX2NvbnRleHQubW92ZVRvKHgyWzBdLCB5MlswXSk7CiAgICAgIGlmIChuID09PSAyKSB7CiAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8oeDJbMV0sIHkyWzFdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgcHggPSBjb250cm9sUG9pbnRzKHgyKSwgcHkgPSBjb250cm9sUG9pbnRzKHkyKTsKICAgICAgICBmb3IgKHZhciBpMCA9IDAsIGkxID0gMTsgaTEgPCBuOyArK2kwLCArK2kxKSB7CiAgICAgICAgICB0aGlzLl9jb250ZXh0LmJlemllckN1cnZlVG8ocHhbMF1baTBdLCBweVswXVtpMF0sIHB4WzFdW2kwXSwgcHlbMV1baTBdLCB4MltpMV0sIHkyW2kxXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIG4gPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgICB0aGlzLl94ID0gdGhpcy5feSA9IG51bGw7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB0aGlzLl94LnB1c2goK3gyKTsKICAgIHRoaXMuX3kucHVzaCgreTIpOwogIH0KfTsKZnVuY3Rpb24gY29udHJvbFBvaW50cyh4MikgewogIHZhciBpLCBuID0geDIubGVuZ3RoIC0gMSwgbSwgYSA9IG5ldyBBcnJheShuKSwgYiA9IG5ldyBBcnJheShuKSwgcjIgPSBuZXcgQXJyYXkobik7CiAgYVswXSA9IDAsIGJbMF0gPSAyLCByMlswXSA9IHgyWzBdICsgMiAqIHgyWzFdOwogIGZvciAoaSA9IDE7IGkgPCBuIC0gMTsgKytpKSBhW2ldID0gMSwgYltpXSA9IDQsIHIyW2ldID0gNCAqIHgyW2ldICsgMiAqIHgyW2kgKyAxXTsKICBhW24gLSAxXSA9IDIsIGJbbiAtIDFdID0gNywgcjJbbiAtIDFdID0gOCAqIHgyW24gLSAxXSArIHgyW25dOwogIGZvciAoaSA9IDE7IGkgPCBuOyArK2kpIG0gPSBhW2ldIC8gYltpIC0gMV0sIGJbaV0gLT0gbSwgcjJbaV0gLT0gbSAqIHIyW2kgLSAxXTsKICBhW24gLSAxXSA9IHIyW24gLSAxXSAvIGJbbiAtIDFdOwogIGZvciAoaSA9IG4gLSAyOyBpID49IDA7IC0taSkgYVtpXSA9IChyMltpXSAtIGFbaSArIDFdKSAvIGJbaV07CiAgYltuIC0gMV0gPSAoeDJbbl0gKyBhW24gLSAxXSkgLyAyOwogIGZvciAoaSA9IDA7IGkgPCBuIC0gMTsgKytpKSBiW2ldID0gMiAqIHgyW2kgKyAxXSAtIGFbaSArIDFdOwogIHJldHVybiBbYSwgYl07Cn0KZnVuY3Rpb24gbmF0dXJhbF9kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IE5hdHVyYWwoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL3N0ZXAuanMKZnVuY3Rpb24gU3RlcChjb250ZXh0LCB0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7CiAgdGhpcy5fdCA9IHQ7Cn0KU3RlcC5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3ggPSB0aGlzLl95ID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBpZiAoMCA8IHRoaXMuX3QgJiYgdGhpcy5fdCA8IDEgJiYgdGhpcy5fcG9pbnQgPT09IDIpIHRoaXMuX2NvbnRleHQubGluZVRvKHRoaXMuX3gsIHRoaXMuX3kpOwogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiB0aGlzLl9wb2ludCA9PT0gMSkgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIGlmICh0aGlzLl9saW5lID49IDApIHRoaXMuX3QgPSAxIC0gdGhpcy5fdCwgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgZGVmYXVsdDogewogICAgICAgIGlmICh0aGlzLl90IDw9IDApIHsKICAgICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHRoaXMuX3gsIHkyKTsKICAgICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHgyLCB5Mik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciB4MSA9IHRoaXMuX3ggKiAoMSAtIHRoaXMuX3QpICsgeDIgKiB0aGlzLl90OwogICAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8oeDEsIHRoaXMuX3kpOwogICAgICAgICAgdGhpcy5fY29udGV4dC5saW5lVG8oeDEsIHkyKTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuX3ggPSB4MiwgdGhpcy5feSA9IHkyOwogIH0KfTsKZnVuY3Rpb24gc3RlcF9kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IFN0ZXAoY29udGV4dCwgMC41KTsKfQpmdW5jdGlvbiBzdGVwQmVmb3JlKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IFN0ZXAoY29udGV4dCwgMCk7Cn0KZnVuY3Rpb24gc3RlcEFmdGVyKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IFN0ZXAoY29udGV4dCwgMSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL29mZnNldC9ub25lLmpzCmZ1bmN0aW9uIG5vbmVfZGVmYXVsdChzZXJpZXMsIG9yZGVyKSB7CiAgaWYgKCEoKG4gPSBzZXJpZXMubGVuZ3RoKSA+IDEpKSByZXR1cm47CiAgZm9yICh2YXIgaSA9IDEsIGosIHMwLCBzMSA9IHNlcmllc1tvcmRlclswXV0sIG4sIG0gPSBzMS5sZW5ndGg7IGkgPCBuOyArK2kpIHsKICAgIHMwID0gczEsIHMxID0gc2VyaWVzW29yZGVyW2ldXTsKICAgIGZvciAoaiA9IDA7IGogPCBtOyArK2opIHsKICAgICAgczFbal1bMV0gKz0gczFbal1bMF0gPSBpc05hTihzMFtqXVsxXSkgPyBzMFtqXVswXSA6IHMwW2pdWzFdOwogICAgfQogIH0KfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvb3JkZXIvbm9uZS5qcwpmdW5jdGlvbiBub25lX2RlZmF1bHQyKHNlcmllcykgewogIHZhciBuID0gc2VyaWVzLmxlbmd0aCwgbyA9IG5ldyBBcnJheShuKTsKICB3aGlsZSAoLS1uID49IDApIG9bbl0gPSBuOwogIHJldHVybiBvOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9zdGFjay5qcwpmdW5jdGlvbiBzdGFja1ZhbHVlKGQsIGtleSkgewogIHJldHVybiBkW2tleV07Cn0KZnVuY3Rpb24gc3RhY2tTZXJpZXMoa2V5KSB7CiAgY29uc3Qgc2VyaWVzID0gW107CiAgc2VyaWVzLmtleSA9IGtleTsKICByZXR1cm4gc2VyaWVzOwp9CmZ1bmN0aW9uIHN0YWNrX2RlZmF1bHQoKSB7CiAgdmFyIGtleXMgPSBjb25zdGFudF9kZWZhdWx0KFtdKSwgb3JkZXIgPSBub25lX2RlZmF1bHQyLCBvZmZzZXQgPSBub25lX2RlZmF1bHQsIHZhbHVlID0gc3RhY2tWYWx1ZTsKICBmdW5jdGlvbiBzdGFjayhkYXRhKSB7CiAgICB2YXIgc3ogPSBBcnJheS5mcm9tKGtleXMuYXBwbHkodGhpcywgYXJndW1lbnRzKSwgc3RhY2tTZXJpZXMpLCBpLCBuID0gc3oubGVuZ3RoLCBqID0gLTEsIG96OwogICAgZm9yIChjb25zdCBkIG9mIGRhdGEpIHsKICAgICAgZm9yIChpID0gMCwgKytqOyBpIDwgbjsgKytpKSB7CiAgICAgICAgKHN6W2ldW2pdID0gWzAsICt2YWx1ZShkLCBzeltpXS5rZXksIGosIGRhdGEpXSkuZGF0YSA9IGQ7CiAgICAgIH0KICAgIH0KICAgIGZvciAoaSA9IDAsIG96ID0gYXJyYXlfZGVmYXVsdChvcmRlcihzeikpOyBpIDwgbjsgKytpKSB7CiAgICAgIHN6W296W2ldXS5pbmRleCA9IGk7CiAgICB9CiAgICBvZmZzZXQoc3osIG96KTsKICAgIHJldHVybiBzejsKICB9CiAgc3RhY2sua2V5cyA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGtleXMgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KEFycmF5LmZyb20oXykpLCBzdGFjaykgOiBrZXlzOwogIH07CiAgc3RhY2sudmFsdWUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh2YWx1ZSA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBzdGFjaykgOiB2YWx1ZTsKICB9OwogIHN0YWNrLm9yZGVyID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAob3JkZXIgPSBfID09IG51bGwgPyBub25lX2RlZmF1bHQyIDogdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdChBcnJheS5mcm9tKF8pKSwgc3RhY2spIDogb3JkZXI7CiAgfTsKICBzdGFjay5vZmZzZXQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChvZmZzZXQgPSBfID09IG51bGwgPyBub25lX2RlZmF1bHQgOiBfLCBzdGFjaykgOiBvZmZzZXQ7CiAgfTsKICByZXR1cm4gc3RhY2s7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL29mZnNldC9leHBhbmQuanMKZnVuY3Rpb24gZXhwYW5kX2RlZmF1bHQoc2VyaWVzLCBvcmRlcikgewogIGlmICghKChuID0gc2VyaWVzLmxlbmd0aCkgPiAwKSkgcmV0dXJuOwogIGZvciAodmFyIGksIG4sIGogPSAwLCBtID0gc2VyaWVzWzBdLmxlbmd0aCwgeTI7IGogPCBtOyArK2opIHsKICAgIGZvciAoeTIgPSBpID0gMDsgaSA8IG47ICsraSkgeTIgKz0gc2VyaWVzW2ldW2pdWzFdIHx8IDA7CiAgICBpZiAoeTIpIGZvciAoaSA9IDA7IGkgPCBuOyArK2kpIHNlcmllc1tpXVtqXVsxXSAvPSB5MjsKICB9CiAgbm9uZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9vZmZzZXQvc2lsaG91ZXR0ZS5qcwpmdW5jdGlvbiBzaWxob3VldHRlX2RlZmF1bHQoc2VyaWVzLCBvcmRlcikgewogIGlmICghKChuID0gc2VyaWVzLmxlbmd0aCkgPiAwKSkgcmV0dXJuOwogIGZvciAodmFyIGogPSAwLCBzMCA9IHNlcmllc1tvcmRlclswXV0sIG4sIG0gPSBzMC5sZW5ndGg7IGogPCBtOyArK2opIHsKICAgIGZvciAodmFyIGkgPSAwLCB5MiA9IDA7IGkgPCBuOyArK2kpIHkyICs9IHNlcmllc1tpXVtqXVsxXSB8fCAwOwogICAgczBbal1bMV0gKz0gczBbal1bMF0gPSAteTIgLyAyOwogIH0KICBub25lX2RlZmF1bHQoc2VyaWVzLCBvcmRlcik7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL29mZnNldC93aWdnbGUuanMKZnVuY3Rpb24gd2lnZ2xlX2RlZmF1bHQoc2VyaWVzLCBvcmRlcikgewogIGlmICghKChuID0gc2VyaWVzLmxlbmd0aCkgPiAwKSB8fCAhKChtID0gKHMwID0gc2VyaWVzW29yZGVyWzBdXSkubGVuZ3RoKSA+IDApKSByZXR1cm47CiAgZm9yICh2YXIgeTIgPSAwLCBqID0gMSwgczAsIG0sIG47IGogPCBtOyArK2opIHsKICAgIGZvciAodmFyIGkgPSAwLCBzMSA9IDAsIHMyID0gMDsgaSA8IG47ICsraSkgewogICAgICB2YXIgc2kgPSBzZXJpZXNbb3JkZXJbaV1dLCBzaWowID0gc2lbal1bMV0gfHwgMCwgc2lqMSA9IHNpW2ogLSAxXVsxXSB8fCAwLCBzMyA9IChzaWowIC0gc2lqMSkgLyAyOwogICAgICBmb3IgKHZhciBrID0gMDsgayA8IGk7ICsraykgewogICAgICAgIHZhciBzayA9IHNlcmllc1tvcmRlcltrXV0sIHNrajAgPSBza1tqXVsxXSB8fCAwLCBza2oxID0gc2tbaiAtIDFdWzFdIHx8IDA7CiAgICAgICAgczMgKz0gc2tqMCAtIHNrajE7CiAgICAgIH0KICAgICAgczEgKz0gc2lqMCwgczIgKz0gczMgKiBzaWowOwogICAgfQogICAgczBbaiAtIDFdWzFdICs9IHMwW2ogLSAxXVswXSA9IHkyOwogICAgaWYgKHMxKSB5MiAtPSBzMiAvIHMxOwogIH0KICBzMFtqIC0gMV1bMV0gKz0gczBbaiAtIDFdWzBdID0geTI7CiAgbm9uZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0RhdGFVdGlscy5qcwp2YXIgaW1wb3J0X2dldCA9IF9fdG9FU00ocmVxdWlyZV9nZXQyKCkpOwp2YXIgbWF0aFNpZ24gPSAodmFsdWUpID0+IHsKICBpZiAodmFsdWUgPT09IDApIHsKICAgIHJldHVybiAwOwogIH0KICBpZiAodmFsdWUgPiAwKSB7CiAgICByZXR1cm4gMTsKICB9CiAgcmV0dXJuIC0xOwp9Owp2YXIgaXNOYW4gPSAodmFsdWUpID0+IHsKICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICJudW1iZXIiICYmIHZhbHVlICE9ICt2YWx1ZTsKfTsKdmFyIGlzUGVyY2VudCA9ICh2YWx1ZSkgPT4gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCIlIikgPT09IHZhbHVlLmxlbmd0aCAtIDE7CnZhciBpc051bWJlciA9ICh2YWx1ZSkgPT4gKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgfHwgdmFsdWUgaW5zdGFuY2VvZiBOdW1iZXIpICYmICFpc05hbih2YWx1ZSk7CnZhciBpc051bU9yU3RyID0gKHZhbHVlKSA9PiBpc051bWJlcih2YWx1ZSkgfHwgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIjsKdmFyIGlkQ291bnRlciA9IDA7CnZhciB1bmlxdWVJZCA9IChwcmVmaXgpID0+IHsKICB2YXIgaWQgPSArK2lkQ291bnRlcjsKICByZXR1cm4gIiIuY29uY2F0KHByZWZpeCB8fCAiIikuY29uY2F0KGlkKTsKfTsKdmFyIGdldFBlcmNlbnRWYWx1ZSA9IGZ1bmN0aW9uIGdldFBlcmNlbnRWYWx1ZTIocGVyY2VudCwgdG90YWxWYWx1ZSkgewogIHZhciBkZWZhdWx0VmFsdWUgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1syXSA6IDA7CiAgdmFyIHZhbGlkYXRlID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbM10gOiBmYWxzZTsKICBpZiAoIWlzTnVtYmVyKHBlcmNlbnQpICYmIHR5cGVvZiBwZXJjZW50ICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICB9CiAgdmFyIHZhbHVlOwogIGlmIChpc1BlcmNlbnQocGVyY2VudCkpIHsKICAgIGlmICh0b3RhbFZhbHVlID09IG51bGwpIHsKICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgIH0KICAgIHZhciBpbmRleCA9IHBlcmNlbnQuaW5kZXhPZigiJSIpOwogICAgdmFsdWUgPSB0b3RhbFZhbHVlICogcGFyc2VGbG9hdChwZXJjZW50LnNsaWNlKDAsIGluZGV4KSkgLyAxMDA7CiAgfSBlbHNlIHsKICAgIHZhbHVlID0gK3BlcmNlbnQ7CiAgfQogIGlmIChpc05hbih2YWx1ZSkpIHsKICAgIHZhbHVlID0gZGVmYXVsdFZhbHVlOwogIH0KICBpZiAodmFsaWRhdGUgJiYgdG90YWxWYWx1ZSAhPSBudWxsICYmIHZhbHVlID4gdG90YWxWYWx1ZSkgewogICAgdmFsdWUgPSB0b3RhbFZhbHVlOwogIH0KICByZXR1cm4gdmFsdWU7Cn07CnZhciBoYXNEdXBsaWNhdGUgPSAoYXJ5KSA9PiB7CiAgaWYgKCFBcnJheS5pc0FycmF5KGFyeSkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgdmFyIGxlbiA9IGFyeS5sZW5ndGg7CiAgdmFyIGNhY2hlID0ge307CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgaWYgKCFjYWNoZVthcnlbaV1dKSB7CiAgICAgIGNhY2hlW2FyeVtpXV0gPSB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfTsKZnVuY3Rpb24gaW50ZXJwb2xhdGUoc3RhcnQsIGVuZCwgdCkgewogIGlmIChpc051bWJlcihzdGFydCkgJiYgaXNOdW1iZXIoZW5kKSkgewogICAgcmV0dXJuIHN0YXJ0ICsgdCAqIChlbmQgLSBzdGFydCk7CiAgfQogIHJldHVybiBlbmQ7Cn0KZnVuY3Rpb24gZmluZEVudHJ5SW5BcnJheShhcnksIHNwZWNpZmllZEtleSwgc3BlY2lmaWVkVmFsdWUpIHsKICBpZiAoIWFyeSB8fCAhYXJ5Lmxlbmd0aCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGFyeS5maW5kKChlbnRyeSkgPT4gZW50cnkgJiYgKHR5cGVvZiBzcGVjaWZpZWRLZXkgPT09ICJmdW5jdGlvbiIgPyBzcGVjaWZpZWRLZXkoZW50cnkpIDogKDAsIGltcG9ydF9nZXQuZGVmYXVsdCkoZW50cnksIHNwZWNpZmllZEtleSkpID09PSBzcGVjaWZpZWRWYWx1ZSk7Cn0KdmFyIGlzTnVsbGlzaCA9ICh2YWx1ZSkgPT4gewogIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJ1bmRlZmluZWQiOwp9Owp2YXIgdXBwZXJGaXJzdCA9ICh2YWx1ZSkgPT4gewogIGlmIChpc051bGxpc2godmFsdWUpKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIHJldHVybiAiIi5jb25jYXQodmFsdWUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkpLmNvbmNhdCh2YWx1ZS5zbGljZSgxKSk7Cn07CmZ1bmN0aW9uIGlzTm90TmlsKHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlICE9IG51bGw7Cn0KZnVuY3Rpb24gbm9vcCgpIHsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC90eXBlcy5qcwp2YXIgaW1wb3J0X3JlYWN0NyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGlzUG9sYXJDb29yZGluYXRlID0gKGMpID0+IHsKICByZXR1cm4gInJhZGl1cyIgaW4gYyAmJiAic3RhcnRBbmdsZSIgaW4gYyAmJiAiZW5kQW5nbGUiIGluIGM7Cn07CnZhciBhZGFwdEV2ZW50SGFuZGxlcnMgPSAocHJvcHMsIG5ld0hhbmRsZXIpID0+IHsKICBpZiAoIXByb3BzIHx8IHR5cGVvZiBwcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgcHJvcHMgPT09ICJib29sZWFuIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBpbnB1dFByb3BzID0gcHJvcHM7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0Ny5pc1ZhbGlkRWxlbWVudCkocHJvcHMpKSB7CiAgICBpbnB1dFByb3BzID0gcHJvcHMucHJvcHM7CiAgfQogIGlmICh0eXBlb2YgaW5wdXRQcm9wcyAhPT0gIm9iamVjdCIgJiYgdHlwZW9mIGlucHV0UHJvcHMgIT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgb3V0ID0ge307CiAgT2JqZWN0LmtleXMoaW5wdXRQcm9wcykuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICBpZiAoaXNFdmVudEtleShrZXkpKSB7CiAgICAgIG91dFtrZXldID0gbmV3SGFuZGxlciB8fCAoKGUpID0+IGlucHV0UHJvcHNba2V5XShpbnB1dFByb3BzLCBlKSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIG91dDsKfTsKdmFyIGdldEV2ZW50SGFuZGxlck9mQ2hpbGQgPSAob3JpZ2luYWxIYW5kbGVyLCBkYXRhLCBpbmRleCkgPT4gKGUpID0+IHsKICBvcmlnaW5hbEhhbmRsZXIoZGF0YSwgaW5kZXgsIGUpOwogIHJldHVybiBudWxsOwp9Owp2YXIgYWRhcHRFdmVudHNPZkNoaWxkID0gKHByb3BzLCBkYXRhLCBpbmRleCkgPT4gewogIGlmIChwcm9wcyA9PT0gbnVsbCB8fCB0eXBlb2YgcHJvcHMgIT09ICJvYmplY3QiICYmIHR5cGVvZiBwcm9wcyAhPT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBvdXQgPSBudWxsOwogIE9iamVjdC5rZXlzKHByb3BzKS5mb3JFYWNoKChrZXkpID0+IHsKICAgIHZhciBpdGVtID0gcHJvcHNba2V5XTsKICAgIGlmIChpc0V2ZW50S2V5KGtleSkgJiYgdHlwZW9mIGl0ZW0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgaWYgKCFvdXQpIG91dCA9IHt9OwogICAgICBvdXRba2V5XSA9IGdldEV2ZW50SGFuZGxlck9mQ2hpbGQoaXRlbSwgZGF0YSwgaW5kZXgpOwogICAgfQogIH0pOwogIHJldHVybiBvdXQ7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3Jlc29sdmVEZWZhdWx0UHJvcHMuanMKZnVuY3Rpb24gb3duS2V5cyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5cyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5cyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiByZXNvbHZlRGVmYXVsdFByb3BzKHJlYWxQcm9wcywgZGVmYXVsdFByb3BzKSB7CiAgdmFyIHJlc29sdmVkUHJvcHMgPSBfb2JqZWN0U3ByZWFkKHt9LCByZWFsUHJvcHMpOwogIHZhciBkcCA9IGRlZmF1bHRQcm9wczsKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGRlZmF1bHRQcm9wcyk7CiAgdmFyIHdpdGhEZWZhdWx0cyA9IGtleXMucmVkdWNlKChhY2MsIGtleSkgPT4gewogICAgaWYgKGFjY1trZXldID09PSB2b2lkIDAgJiYgZHBba2V5XSAhPT0gdm9pZCAwKSB7CiAgICAgIGFjY1trZXldID0gZHBba2V5XTsKICAgIH0KICAgIHJldHVybiBhY2M7CiAgfSwgcmVzb2x2ZWRQcm9wcyk7CiAgcmV0dXJuIHdpdGhEZWZhdWx0czsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9wYXlsb2FkL2dldFVuaXFQYXlsb2FkLmpzCnZhciBpbXBvcnRfdW5pcUJ5ID0gX190b0VTTShyZXF1aXJlX3VuaXFCeTMoKSk7CmZ1bmN0aW9uIGdldFVuaXFQYXlsb2FkKHBheWxvYWQsIG9wdGlvbiwgZGVmYXVsdFVuaXFCeTIpIHsKICBpZiAob3B0aW9uID09PSB0cnVlKSB7CiAgICByZXR1cm4gKDAsIGltcG9ydF91bmlxQnkuZGVmYXVsdCkocGF5bG9hZCwgZGVmYXVsdFVuaXFCeTIpOwogIH0KICBpZiAodHlwZW9mIG9wdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuICgwLCBpbXBvcnRfdW5pcUJ5LmRlZmF1bHQpKHBheWxvYWQsIG9wdGlvbik7CiAgfQogIHJldHVybiBwYXlsb2FkOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9ob29rcy5qcwp2YXIgaW1wb3J0X3dpdGhfc2VsZWN0b3IgPSBfX3RvRVNNKHJlcXVpcmVfd2l0aF9zZWxlY3RvcigpKTsKdmFyIGltcG9ydF9yZWFjdDkgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9SZWNoYXJ0c1JlZHV4Q29udGV4dC5qcwp2YXIgaW1wb3J0X3JlYWN0OCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIFJlY2hhcnRzUmVkdXhDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q4LmNyZWF0ZUNvbnRleHQpKG51bGwpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvaG9va3MuanMKdmFyIG5vb3BEaXNwYXRjaCA9IChhKSA9PiBhOwp2YXIgdXNlQXBwRGlzcGF0Y2ggPSAoKSA9PiB7CiAgdmFyIGNvbnRleHQgPSAoMCwgaW1wb3J0X3JlYWN0OS51c2VDb250ZXh0KShSZWNoYXJ0c1JlZHV4Q29udGV4dCk7CiAgaWYgKGNvbnRleHQpIHsKICAgIHJldHVybiBjb250ZXh0LnN0b3JlLmRpc3BhdGNoOwogIH0KICByZXR1cm4gbm9vcERpc3BhdGNoOwp9Owp2YXIgbm9vcDIgPSAoKSA9PiB7Cn07CnZhciBhZGROZXN0ZWRTdWJOb29wID0gKCkgPT4gbm9vcDI7CnZhciByZWZFcXVhbGl0eSA9IChhLCBiKSA9PiBhID09PSBiOwpmdW5jdGlvbiB1c2VBcHBTZWxlY3RvcihzZWxlY3RvcikgewogIHZhciBjb250ZXh0ID0gKDAsIGltcG9ydF9yZWFjdDkudXNlQ29udGV4dCkoUmVjaGFydHNSZWR1eENvbnRleHQpOwogIHJldHVybiAoMCwgaW1wb3J0X3dpdGhfc2VsZWN0b3IudXNlU3luY0V4dGVybmFsU3RvcmVXaXRoU2VsZWN0b3IpKGNvbnRleHQgPyBjb250ZXh0LnN1YnNjcmlwdGlvbi5hZGROZXN0ZWRTdWIgOiBhZGROZXN0ZWRTdWJOb29wLCBjb250ZXh0ID8gY29udGV4dC5zdG9yZS5nZXRTdGF0ZSA6IG5vb3AyLCBjb250ZXh0ID8gY29udGV4dC5zdG9yZS5nZXRTdGF0ZSA6IG5vb3AyLCBjb250ZXh0ID8gc2VsZWN0b3IgOiBub29wMiwgcmVmRXF1YWxpdHkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVzZWxlY3RANS4xLjEvbm9kZV9tb2R1bGVzL3Jlc2VsZWN0L2Rpc3QvcmVzZWxlY3QubWpzCnZhciBydW5JZGVudGl0eUZ1bmN0aW9uQ2hlY2sgPSAocmVzdWx0RnVuYywgaW5wdXRTZWxlY3RvcnNSZXN1bHRzLCBvdXRwdXRTZWxlY3RvclJlc3VsdCkgPT4gewogIGlmIChpbnB1dFNlbGVjdG9yc1Jlc3VsdHMubGVuZ3RoID09PSAxICYmIGlucHV0U2VsZWN0b3JzUmVzdWx0c1swXSA9PT0gb3V0cHV0U2VsZWN0b3JSZXN1bHQpIHsKICAgIGxldCBpc0lucHV0U2FtZUFzT3V0cHV0ID0gZmFsc2U7CiAgICB0cnkgewogICAgICBjb25zdCBlbXB0eU9iamVjdCA9IHt9OwogICAgICBpZiAocmVzdWx0RnVuYyhlbXB0eU9iamVjdCkgPT09IGVtcHR5T2JqZWN0KQogICAgICAgIGlzSW5wdXRTYW1lQXNPdXRwdXQgPSB0cnVlOwogICAgfSBjYXRjaCB7CiAgICB9CiAgICBpZiAoaXNJbnB1dFNhbWVBc091dHB1dCkgewogICAgICBsZXQgc3RhY2sgPSB2b2lkIDA7CiAgICAgIHRyeSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICA7CiAgICAgICAgKHsgc3RhY2sgfSA9IGUpOwogICAgICB9CiAgICAgIGNvbnNvbGUud2FybigKICAgICAgICAiVGhlIHJlc3VsdCBmdW5jdGlvbiByZXR1cm5lZCBpdHMgb3duIGlucHV0cyB3aXRob3V0IG1vZGlmaWNhdGlvbi4gZS5nXG5gY3JlYXRlU2VsZWN0b3IoW3N0YXRlID0+IHN0YXRlLnRvZG9zXSwgdG9kb3MgPT4gdG9kb3MpYFxuVGhpcyBjb3VsZCBsZWFkIHRvIGluZWZmaWNpZW50IG1lbW9pemF0aW9uIGFuZCB1bm5lY2Vzc2FyeSByZS1yZW5kZXJzLlxuRW5zdXJlIHRyYW5zZm9ybWF0aW9uIGxvZ2ljIGlzIGluIHRoZSByZXN1bHQgZnVuY3Rpb24sIGFuZCBleHRyYWN0aW9uIGxvZ2ljIGlzIGluIHRoZSBpbnB1dCBzZWxlY3RvcnMuIiwKICAgICAgICB7IHN0YWNrIH0KICAgICAgKTsKICAgIH0KICB9Cn07CnZhciBydW5JbnB1dFN0YWJpbGl0eUNoZWNrID0gKGlucHV0U2VsZWN0b3JSZXN1bHRzT2JqZWN0LCBvcHRpb25zLCBpbnB1dFNlbGVjdG9yQXJncykgPT4gewogIGNvbnN0IHsgbWVtb2l6ZSwgbWVtb2l6ZU9wdGlvbnMgfSA9IG9wdGlvbnM7CiAgY29uc3QgeyBpbnB1dFNlbGVjdG9yUmVzdWx0cywgaW5wdXRTZWxlY3RvclJlc3VsdHNDb3B5IH0gPSBpbnB1dFNlbGVjdG9yUmVzdWx0c09iamVjdDsKICBjb25zdCBjcmVhdGVBbkVtcHR5T2JqZWN0ID0gbWVtb2l6ZSgoKSA9PiAoe30pLCAuLi5tZW1vaXplT3B0aW9ucyk7CiAgY29uc3QgYXJlSW5wdXRTZWxlY3RvclJlc3VsdHNFcXVhbCA9IGNyZWF0ZUFuRW1wdHlPYmplY3QuYXBwbHkobnVsbCwgaW5wdXRTZWxlY3RvclJlc3VsdHMpID09PSBjcmVhdGVBbkVtcHR5T2JqZWN0LmFwcGx5KG51bGwsIGlucHV0U2VsZWN0b3JSZXN1bHRzQ29weSk7CiAgaWYgKCFhcmVJbnB1dFNlbGVjdG9yUmVzdWx0c0VxdWFsKSB7CiAgICBsZXQgc3RhY2sgPSB2b2lkIDA7CiAgICB0cnkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgOwogICAgICAoeyBzdGFjayB9ID0gZSk7CiAgICB9CiAgICBjb25zb2xlLndhcm4oCiAgICAgICJBbiBpbnB1dCBzZWxlY3RvciByZXR1cm5lZCBhIGRpZmZlcmVudCByZXN1bHQgd2hlbiBwYXNzZWQgc2FtZSBhcmd1bWVudHMuXG5UaGlzIG1lYW5zIHlvdXIgb3V0cHV0IHNlbGVjdG9yIHdpbGwgbGlrZWx5IHJ1biBtb3JlIGZyZXF1ZW50bHkgdGhhbiBpbnRlbmRlZC5cbkF2b2lkIHJldHVybmluZyBhIG5ldyByZWZlcmVuY2UgaW5zaWRlIHlvdXIgaW5wdXQgc2VsZWN0b3IsIGUuZy5cbmBjcmVhdGVTZWxlY3Rvcihbc3RhdGUgPT4gc3RhdGUudG9kb3MubWFwKHRvZG8gPT4gdG9kby5pZCldLCB0b2RvSWRzID0+IHRvZG9JZHMubGVuZ3RoKWAiLAogICAgICB7CiAgICAgICAgYXJndW1lbnRzOiBpbnB1dFNlbGVjdG9yQXJncywKICAgICAgICBmaXJzdElucHV0czogaW5wdXRTZWxlY3RvclJlc3VsdHMsCiAgICAgICAgc2Vjb25kSW5wdXRzOiBpbnB1dFNlbGVjdG9yUmVzdWx0c0NvcHksCiAgICAgICAgc3RhY2sKICAgICAgfQogICAgKTsKICB9Cn07CnZhciBnbG9iYWxEZXZNb2RlQ2hlY2tzID0gewogIGlucHV0U3RhYmlsaXR5Q2hlY2s6ICJvbmNlIiwKICBpZGVudGl0eUZ1bmN0aW9uQ2hlY2s6ICJvbmNlIgp9OwpmdW5jdGlvbiBhc3NlcnRJc0Z1bmN0aW9uKGZ1bmMsIGVycm9yTWVzc2FnZSA9IGBleHBlY3RlZCBhIGZ1bmN0aW9uLCBpbnN0ZWFkIHJlY2VpdmVkICR7dHlwZW9mIGZ1bmN9YCkgewogIGlmICh0eXBlb2YgZnVuYyAhPT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcihlcnJvck1lc3NhZ2UpOwogIH0KfQpmdW5jdGlvbiBhc3NlcnRJc09iamVjdChvYmplY3QsIGVycm9yTWVzc2FnZSA9IGBleHBlY3RlZCBhbiBvYmplY3QsIGluc3RlYWQgcmVjZWl2ZWQgJHt0eXBlb2Ygb2JqZWN0fWApIHsKICBpZiAodHlwZW9mIG9iamVjdCAhPT0gIm9iamVjdCIpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoZXJyb3JNZXNzYWdlKTsKICB9Cn0KZnVuY3Rpb24gYXNzZXJ0SXNBcnJheU9mRnVuY3Rpb25zKGFycmF5LCBlcnJvck1lc3NhZ2UgPSBgZXhwZWN0ZWQgYWxsIGl0ZW1zIHRvIGJlIGZ1bmN0aW9ucywgaW5zdGVhZCByZWNlaXZlZCB0aGUgZm9sbG93aW5nIHR5cGVzOiBgKSB7CiAgaWYgKCFhcnJheS5ldmVyeSgoaXRlbSkgPT4gdHlwZW9mIGl0ZW0gPT09ICJmdW5jdGlvbiIpKSB7CiAgICBjb25zdCBpdGVtVHlwZXMgPSBhcnJheS5tYXAoCiAgICAgIChpdGVtKSA9PiB0eXBlb2YgaXRlbSA9PT0gImZ1bmN0aW9uIiA/IGBmdW5jdGlvbiAke2l0ZW0ubmFtZSB8fCAidW5uYW1lZCJ9KClgIDogdHlwZW9mIGl0ZW0KICAgICkuam9pbigiLCAiKTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoYCR7ZXJyb3JNZXNzYWdlfVske2l0ZW1UeXBlc31dYCk7CiAgfQp9CnZhciBlbnN1cmVJc0FycmF5ID0gKGl0ZW0pID0+IHsKICByZXR1cm4gQXJyYXkuaXNBcnJheShpdGVtKSA/IGl0ZW0gOiBbaXRlbV07Cn07CmZ1bmN0aW9uIGdldERlcGVuZGVuY2llcyhjcmVhdGVTZWxlY3RvckFyZ3MpIHsKICBjb25zdCBkZXBlbmRlbmNpZXMgPSBBcnJheS5pc0FycmF5KGNyZWF0ZVNlbGVjdG9yQXJnc1swXSkgPyBjcmVhdGVTZWxlY3RvckFyZ3NbMF0gOiBjcmVhdGVTZWxlY3RvckFyZ3M7CiAgYXNzZXJ0SXNBcnJheU9mRnVuY3Rpb25zKAogICAgZGVwZW5kZW5jaWVzLAogICAgYGNyZWF0ZVNlbGVjdG9yIGV4cGVjdHMgYWxsIGlucHV0LXNlbGVjdG9ycyB0byBiZSBmdW5jdGlvbnMsIGJ1dCByZWNlaXZlZCB0aGUgZm9sbG93aW5nIHR5cGVzOiBgCiAgKTsKICByZXR1cm4gZGVwZW5kZW5jaWVzOwp9CmZ1bmN0aW9uIGNvbGxlY3RJbnB1dFNlbGVjdG9yUmVzdWx0cyhkZXBlbmRlbmNpZXMsIGlucHV0U2VsZWN0b3JBcmdzKSB7CiAgY29uc3QgaW5wdXRTZWxlY3RvclJlc3VsdHMgPSBbXTsKICBjb25zdCB7IGxlbmd0aCB9ID0gZGVwZW5kZW5jaWVzOwogIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgIGlucHV0U2VsZWN0b3JSZXN1bHRzLnB1c2goZGVwZW5kZW5jaWVzW2ldLmFwcGx5KG51bGwsIGlucHV0U2VsZWN0b3JBcmdzKSk7CiAgfQogIHJldHVybiBpbnB1dFNlbGVjdG9yUmVzdWx0czsKfQp2YXIgZ2V0RGV2TW9kZUNoZWNrc0V4ZWN1dGlvbkluZm8gPSAoZmlyc3RSdW4sIGRldk1vZGVDaGVja3MpID0+IHsKICBjb25zdCB7IGlkZW50aXR5RnVuY3Rpb25DaGVjaywgaW5wdXRTdGFiaWxpdHlDaGVjayB9ID0gewogICAgLi4uZ2xvYmFsRGV2TW9kZUNoZWNrcywKICAgIC4uLmRldk1vZGVDaGVja3MKICB9OwogIHJldHVybiB7CiAgICBpZGVudGl0eUZ1bmN0aW9uQ2hlY2s6IHsKICAgICAgc2hvdWxkUnVuOiBpZGVudGl0eUZ1bmN0aW9uQ2hlY2sgPT09ICJhbHdheXMiIHx8IGlkZW50aXR5RnVuY3Rpb25DaGVjayA9PT0gIm9uY2UiICYmIGZpcnN0UnVuLAogICAgICBydW46IHJ1bklkZW50aXR5RnVuY3Rpb25DaGVjawogICAgfSwKICAgIGlucHV0U3RhYmlsaXR5Q2hlY2s6IHsKICAgICAgc2hvdWxkUnVuOiBpbnB1dFN0YWJpbGl0eUNoZWNrID09PSAiYWx3YXlzIiB8fCBpbnB1dFN0YWJpbGl0eUNoZWNrID09PSAib25jZSIgJiYgZmlyc3RSdW4sCiAgICAgIHJ1bjogcnVuSW5wdXRTdGFiaWxpdHlDaGVjawogICAgfQogIH07Cn07CnZhciBSRURVWF9QUk9YWV9MQUJFTCA9IFN5bWJvbCgpOwp2YXIgcHJvdG8gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Yoe30pOwp2YXIgU3Ryb25nUmVmID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHZhbHVlKSB7CiAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgfQogIGRlcmVmKCkgewogICAgcmV0dXJuIHRoaXMudmFsdWU7CiAgfQp9Owp2YXIgUmVmID0gdHlwZW9mIFdlYWtSZWYgIT09ICJ1bmRlZmluZWQiID8gV2Vha1JlZiA6IFN0cm9uZ1JlZjsKdmFyIFVOVEVSTUlOQVRFRCA9IDA7CnZhciBURVJNSU5BVEVEID0gMTsKZnVuY3Rpb24gY3JlYXRlQ2FjaGVOb2RlKCkgewogIHJldHVybiB7CiAgICBzOiBVTlRFUk1JTkFURUQsCiAgICB2OiB2b2lkIDAsCiAgICBvOiBudWxsLAogICAgcDogbnVsbAogIH07Cn0KZnVuY3Rpb24gd2Vha01hcE1lbW9pemUoZnVuYywgb3B0aW9ucyA9IHt9KSB7CiAgbGV0IGZuTm9kZSA9IGNyZWF0ZUNhY2hlTm9kZSgpOwogIGNvbnN0IHsgcmVzdWx0RXF1YWxpdHlDaGVjayB9ID0gb3B0aW9uczsKICBsZXQgbGFzdFJlc3VsdDsKICBsZXQgcmVzdWx0c0NvdW50ID0gMDsKICBmdW5jdGlvbiBtZW1vaXplZCgpIHsKICAgIGxldCBjYWNoZU5vZGUgPSBmbk5vZGU7CiAgICBjb25zdCB7IGxlbmd0aCB9ID0gYXJndW1lbnRzOwogICAgZm9yIChsZXQgaSA9IDAsIGwgPSBsZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgY29uc3QgYXJnID0gYXJndW1lbnRzW2ldOwogICAgICBpZiAodHlwZW9mIGFyZyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgYXJnID09PSAib2JqZWN0IiAmJiBhcmcgIT09IG51bGwpIHsKICAgICAgICBsZXQgb2JqZWN0Q2FjaGUgPSBjYWNoZU5vZGUubzsKICAgICAgICBpZiAob2JqZWN0Q2FjaGUgPT09IG51bGwpIHsKICAgICAgICAgIGNhY2hlTm9kZS5vID0gb2JqZWN0Q2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgb2JqZWN0Tm9kZSA9IG9iamVjdENhY2hlLmdldChhcmcpOwogICAgICAgIGlmIChvYmplY3ROb2RlID09PSB2b2lkIDApIHsKICAgICAgICAgIGNhY2hlTm9kZSA9IGNyZWF0ZUNhY2hlTm9kZSgpOwogICAgICAgICAgb2JqZWN0Q2FjaGUuc2V0KGFyZywgY2FjaGVOb2RlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FjaGVOb2RlID0gb2JqZWN0Tm9kZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbGV0IHByaW1pdGl2ZUNhY2hlID0gY2FjaGVOb2RlLnA7CiAgICAgICAgaWYgKHByaW1pdGl2ZUNhY2hlID09PSBudWxsKSB7CiAgICAgICAgICBjYWNoZU5vZGUucCA9IHByaW1pdGl2ZUNhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcHJpbWl0aXZlTm9kZSA9IHByaW1pdGl2ZUNhY2hlLmdldChhcmcpOwogICAgICAgIGlmIChwcmltaXRpdmVOb2RlID09PSB2b2lkIDApIHsKICAgICAgICAgIGNhY2hlTm9kZSA9IGNyZWF0ZUNhY2hlTm9kZSgpOwogICAgICAgICAgcHJpbWl0aXZlQ2FjaGUuc2V0KGFyZywgY2FjaGVOb2RlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FjaGVOb2RlID0gcHJpbWl0aXZlTm9kZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHRlcm1pbmF0ZWROb2RlID0gY2FjaGVOb2RlOwogICAgbGV0IHJlc3VsdDsKICAgIGlmIChjYWNoZU5vZGUucyA9PT0gVEVSTUlOQVRFRCkgewogICAgICByZXN1bHQgPSBjYWNoZU5vZGUudjsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKICAgICAgcmVzdWx0c0NvdW50Kys7CiAgICAgIGlmIChyZXN1bHRFcXVhbGl0eUNoZWNrKSB7CiAgICAgICAgY29uc3QgbGFzdFJlc3VsdFZhbHVlID0gbGFzdFJlc3VsdD8uZGVyZWY/LigpID8/IGxhc3RSZXN1bHQ7CiAgICAgICAgaWYgKGxhc3RSZXN1bHRWYWx1ZSAhPSBudWxsICYmIHJlc3VsdEVxdWFsaXR5Q2hlY2sobGFzdFJlc3VsdFZhbHVlLCByZXN1bHQpKSB7CiAgICAgICAgICByZXN1bHQgPSBsYXN0UmVzdWx0VmFsdWU7CiAgICAgICAgICByZXN1bHRzQ291bnQgIT09IDAgJiYgcmVzdWx0c0NvdW50LS07CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5lZWRzV2Vha1JlZiA9IHR5cGVvZiByZXN1bHQgPT09ICJvYmplY3QiICYmIHJlc3VsdCAhPT0gbnVsbCB8fCB0eXBlb2YgcmVzdWx0ID09PSAiZnVuY3Rpb24iOwogICAgICAgIGxhc3RSZXN1bHQgPSBuZWVkc1dlYWtSZWYgPyBuZXcgUmVmKHJlc3VsdCkgOiByZXN1bHQ7CiAgICAgIH0KICAgIH0KICAgIHRlcm1pbmF0ZWROb2RlLnMgPSBURVJNSU5BVEVEOwogICAgdGVybWluYXRlZE5vZGUudiA9IHJlc3VsdDsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIG1lbW9pemVkLmNsZWFyQ2FjaGUgPSAoKSA9PiB7CiAgICBmbk5vZGUgPSBjcmVhdGVDYWNoZU5vZGUoKTsKICAgIG1lbW9pemVkLnJlc2V0UmVzdWx0c0NvdW50KCk7CiAgfTsKICBtZW1vaXplZC5yZXN1bHRzQ291bnQgPSAoKSA9PiByZXN1bHRzQ291bnQ7CiAgbWVtb2l6ZWQucmVzZXRSZXN1bHRzQ291bnQgPSAoKSA9PiB7CiAgICByZXN1bHRzQ291bnQgPSAwOwogIH07CiAgcmV0dXJuIG1lbW9pemVkOwp9CmZ1bmN0aW9uIGNyZWF0ZVNlbGVjdG9yQ3JlYXRvcihtZW1vaXplT3JPcHRpb25zLCAuLi5tZW1vaXplT3B0aW9uc0Zyb21BcmdzKSB7CiAgY29uc3QgY3JlYXRlU2VsZWN0b3JDcmVhdG9yT3B0aW9ucyA9IHR5cGVvZiBtZW1vaXplT3JPcHRpb25zID09PSAiZnVuY3Rpb24iID8gewogICAgbWVtb2l6ZTogbWVtb2l6ZU9yT3B0aW9ucywKICAgIG1lbW9pemVPcHRpb25zOiBtZW1vaXplT3B0aW9uc0Zyb21BcmdzCiAgfSA6IG1lbW9pemVPck9wdGlvbnM7CiAgY29uc3QgY3JlYXRlU2VsZWN0b3IyID0gKC4uLmNyZWF0ZVNlbGVjdG9yQXJncykgPT4gewogICAgbGV0IHJlY29tcHV0YXRpb25zID0gMDsKICAgIGxldCBkZXBlbmRlbmN5UmVjb21wdXRhdGlvbnMgPSAwOwogICAgbGV0IGxhc3RSZXN1bHQ7CiAgICBsZXQgZGlyZWN0bHlQYXNzZWRPcHRpb25zID0ge307CiAgICBsZXQgcmVzdWx0RnVuYyA9IGNyZWF0ZVNlbGVjdG9yQXJncy5wb3AoKTsKICAgIGlmICh0eXBlb2YgcmVzdWx0RnVuYyA9PT0gIm9iamVjdCIpIHsKICAgICAgZGlyZWN0bHlQYXNzZWRPcHRpb25zID0gcmVzdWx0RnVuYzsKICAgICAgcmVzdWx0RnVuYyA9IGNyZWF0ZVNlbGVjdG9yQXJncy5wb3AoKTsKICAgIH0KICAgIGFzc2VydElzRnVuY3Rpb24oCiAgICAgIHJlc3VsdEZ1bmMsCiAgICAgIGBjcmVhdGVTZWxlY3RvciBleHBlY3RzIGFuIG91dHB1dCBmdW5jdGlvbiBhZnRlciB0aGUgaW5wdXRzLCBidXQgcmVjZWl2ZWQ6IFske3R5cGVvZiByZXN1bHRGdW5jfV1gCiAgICApOwogICAgY29uc3QgY29tYmluZWRPcHRpb25zID0gewogICAgICAuLi5jcmVhdGVTZWxlY3RvckNyZWF0b3JPcHRpb25zLAogICAgICAuLi5kaXJlY3RseVBhc3NlZE9wdGlvbnMKICAgIH07CiAgICBjb25zdCB7CiAgICAgIG1lbW9pemUsCiAgICAgIG1lbW9pemVPcHRpb25zID0gW10sCiAgICAgIGFyZ3NNZW1vaXplID0gd2Vha01hcE1lbW9pemUsCiAgICAgIGFyZ3NNZW1vaXplT3B0aW9ucyA9IFtdLAogICAgICBkZXZNb2RlQ2hlY2tzID0ge30KICAgIH0gPSBjb21iaW5lZE9wdGlvbnM7CiAgICBjb25zdCBmaW5hbE1lbW9pemVPcHRpb25zID0gZW5zdXJlSXNBcnJheShtZW1vaXplT3B0aW9ucyk7CiAgICBjb25zdCBmaW5hbEFyZ3NNZW1vaXplT3B0aW9ucyA9IGVuc3VyZUlzQXJyYXkoYXJnc01lbW9pemVPcHRpb25zKTsKICAgIGNvbnN0IGRlcGVuZGVuY2llcyA9IGdldERlcGVuZGVuY2llcyhjcmVhdGVTZWxlY3RvckFyZ3MpOwogICAgY29uc3QgbWVtb2l6ZWRSZXN1bHRGdW5jID0gbWVtb2l6ZShmdW5jdGlvbiByZWNvbXB1dGF0aW9uV3JhcHBlcigpIHsKICAgICAgcmVjb21wdXRhdGlvbnMrKzsKICAgICAgcmV0dXJuIHJlc3VsdEZ1bmMuYXBwbHkoCiAgICAgICAgbnVsbCwKICAgICAgICBhcmd1bWVudHMKICAgICAgKTsKICAgIH0sIC4uLmZpbmFsTWVtb2l6ZU9wdGlvbnMpOwogICAgbGV0IGZpcnN0UnVuID0gdHJ1ZTsKICAgIGNvbnN0IHNlbGVjdG9yID0gYXJnc01lbW9pemUoZnVuY3Rpb24gZGVwZW5kZW5jaWVzQ2hlY2tlcigpIHsKICAgICAgZGVwZW5kZW5jeVJlY29tcHV0YXRpb25zKys7CiAgICAgIGNvbnN0IGlucHV0U2VsZWN0b3JSZXN1bHRzID0gY29sbGVjdElucHV0U2VsZWN0b3JSZXN1bHRzKAogICAgICAgIGRlcGVuZGVuY2llcywKICAgICAgICBhcmd1bWVudHMKICAgICAgKTsKICAgICAgbGFzdFJlc3VsdCA9IG1lbW9pemVkUmVzdWx0RnVuYy5hcHBseShudWxsLCBpbnB1dFNlbGVjdG9yUmVzdWx0cyk7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgY29uc3QgeyBpZGVudGl0eUZ1bmN0aW9uQ2hlY2ssIGlucHV0U3RhYmlsaXR5Q2hlY2sgfSA9IGdldERldk1vZGVDaGVja3NFeGVjdXRpb25JbmZvKGZpcnN0UnVuLCBkZXZNb2RlQ2hlY2tzKTsKICAgICAgICBpZiAoaWRlbnRpdHlGdW5jdGlvbkNoZWNrLnNob3VsZFJ1bikgewogICAgICAgICAgaWRlbnRpdHlGdW5jdGlvbkNoZWNrLnJ1bigKICAgICAgICAgICAgcmVzdWx0RnVuYywKICAgICAgICAgICAgaW5wdXRTZWxlY3RvclJlc3VsdHMsCiAgICAgICAgICAgIGxhc3RSZXN1bHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChpbnB1dFN0YWJpbGl0eUNoZWNrLnNob3VsZFJ1bikgewogICAgICAgICAgY29uc3QgaW5wdXRTZWxlY3RvclJlc3VsdHNDb3B5ID0gY29sbGVjdElucHV0U2VsZWN0b3JSZXN1bHRzKAogICAgICAgICAgICBkZXBlbmRlbmNpZXMsCiAgICAgICAgICAgIGFyZ3VtZW50cwogICAgICAgICAgKTsKICAgICAgICAgIGlucHV0U3RhYmlsaXR5Q2hlY2sucnVuKAogICAgICAgICAgICB7IGlucHV0U2VsZWN0b3JSZXN1bHRzLCBpbnB1dFNlbGVjdG9yUmVzdWx0c0NvcHkgfSwKICAgICAgICAgICAgeyBtZW1vaXplLCBtZW1vaXplT3B0aW9uczogZmluYWxNZW1vaXplT3B0aW9ucyB9LAogICAgICAgICAgICBhcmd1bWVudHMKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGlmIChmaXJzdFJ1bikKICAgICAgICAgIGZpcnN0UnVuID0gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIGxhc3RSZXN1bHQ7CiAgICB9LCAuLi5maW5hbEFyZ3NNZW1vaXplT3B0aW9ucyk7CiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihzZWxlY3RvciwgewogICAgICByZXN1bHRGdW5jLAogICAgICBtZW1vaXplZFJlc3VsdEZ1bmMsCiAgICAgIGRlcGVuZGVuY2llcywKICAgICAgZGVwZW5kZW5jeVJlY29tcHV0YXRpb25zOiAoKSA9PiBkZXBlbmRlbmN5UmVjb21wdXRhdGlvbnMsCiAgICAgIHJlc2V0RGVwZW5kZW5jeVJlY29tcHV0YXRpb25zOiAoKSA9PiB7CiAgICAgICAgZGVwZW5kZW5jeVJlY29tcHV0YXRpb25zID0gMDsKICAgICAgfSwKICAgICAgbGFzdFJlc3VsdDogKCkgPT4gbGFzdFJlc3VsdCwKICAgICAgcmVjb21wdXRhdGlvbnM6ICgpID0+IHJlY29tcHV0YXRpb25zLAogICAgICByZXNldFJlY29tcHV0YXRpb25zOiAoKSA9PiB7CiAgICAgICAgcmVjb21wdXRhdGlvbnMgPSAwOwogICAgICB9LAogICAgICBtZW1vaXplLAogICAgICBhcmdzTWVtb2l6ZQogICAgfSk7CiAgfTsKICBPYmplY3QuYXNzaWduKGNyZWF0ZVNlbGVjdG9yMiwgewogICAgd2l0aFR5cGVzOiAoKSA9PiBjcmVhdGVTZWxlY3RvcjIKICB9KTsKICByZXR1cm4gY3JlYXRlU2VsZWN0b3IyOwp9CnZhciBjcmVhdGVTZWxlY3RvciA9IC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVTZWxlY3RvckNyZWF0b3Iod2Vha01hcE1lbW9pemUpOwp2YXIgY3JlYXRlU3RydWN0dXJlZFNlbGVjdG9yID0gT2JqZWN0LmFzc2lnbigKICAoaW5wdXRTZWxlY3RvcnNPYmplY3QsIHNlbGVjdG9yQ3JlYXRvciA9IGNyZWF0ZVNlbGVjdG9yKSA9PiB7CiAgICBhc3NlcnRJc09iamVjdCgKICAgICAgaW5wdXRTZWxlY3RvcnNPYmplY3QsCiAgICAgIGBjcmVhdGVTdHJ1Y3R1cmVkU2VsZWN0b3IgZXhwZWN0cyBmaXJzdCBhcmd1bWVudCB0byBiZSBhbiBvYmplY3Qgd2hlcmUgZWFjaCBwcm9wZXJ0eSBpcyBhIHNlbGVjdG9yLCBpbnN0ZWFkIHJlY2VpdmVkIGEgJHt0eXBlb2YgaW5wdXRTZWxlY3RvcnNPYmplY3R9YAogICAgKTsKICAgIGNvbnN0IGlucHV0U2VsZWN0b3JLZXlzID0gT2JqZWN0LmtleXMoaW5wdXRTZWxlY3RvcnNPYmplY3QpOwogICAgY29uc3QgZGVwZW5kZW5jaWVzID0gaW5wdXRTZWxlY3RvcktleXMubWFwKAogICAgICAoa2V5KSA9PiBpbnB1dFNlbGVjdG9yc09iamVjdFtrZXldCiAgICApOwogICAgY29uc3Qgc3RydWN0dXJlZFNlbGVjdG9yID0gc2VsZWN0b3JDcmVhdG9yKAogICAgICBkZXBlbmRlbmNpZXMsCiAgICAgICguLi5pbnB1dFNlbGVjdG9yUmVzdWx0cykgPT4gewogICAgICAgIHJldHVybiBpbnB1dFNlbGVjdG9yUmVzdWx0cy5yZWR1Y2UoKGNvbXBvc2l0aW9uLCB2YWx1ZSwgaW5kZXgpID0+IHsKICAgICAgICAgIGNvbXBvc2l0aW9uW2lucHV0U2VsZWN0b3JLZXlzW2luZGV4XV0gPSB2YWx1ZTsKICAgICAgICAgIHJldHVybiBjb21wb3NpdGlvbjsKICAgICAgICB9LCB7fSk7CiAgICAgIH0KICAgICk7CiAgICByZXR1cm4gc3RydWN0dXJlZFNlbGVjdG9yOwogIH0sCiAgeyB3aXRoVHlwZXM6ICgpID0+IGNyZWF0ZVN0cnVjdHVyZWRTZWxlY3RvciB9Cik7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvbGVnZW5kU2VsZWN0b3JzLmpzCnZhciBpbXBvcnRfc29ydEJ5ID0gX190b0VTTShyZXF1aXJlX3NvcnRCeTIoKSk7CnZhciBzZWxlY3RMZWdlbmRTZXR0aW5ncyA9IChzdGF0ZSkgPT4gc3RhdGUubGVnZW5kLnNldHRpbmdzOwp2YXIgc2VsZWN0TGVnZW5kU2l6ZSA9IChzdGF0ZSkgPT4gc3RhdGUubGVnZW5kLnNpemU7CnZhciBzZWxlY3RBbGxMZWdlbmRQYXlsb2FkMkRBcnJheSA9IChzdGF0ZSkgPT4gc3RhdGUubGVnZW5kLnBheWxvYWQ7CnZhciBzZWxlY3RMZWdlbmRQYXlsb2FkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbExlZ2VuZFBheWxvYWQyREFycmF5LCBzZWxlY3RMZWdlbmRTZXR0aW5nc10sIChwYXlsb2FkcywgX3JlZjIpID0+IHsKICB2YXIgewogICAgaXRlbVNvcnRlcgogIH0gPSBfcmVmMjsKICB2YXIgZmxhdCA9IHBheWxvYWRzLmZsYXQoMSk7CiAgcmV0dXJuIGl0ZW1Tb3J0ZXIgPyAoMCwgaW1wb3J0X3NvcnRCeS5kZWZhdWx0KShmbGF0LCBpdGVtU29ydGVyKSA6IGZsYXQ7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VFbGVtZW50T2Zmc2V0LmpzCnZhciBpbXBvcnRfcmVhY3QxMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIEVQUyA9IDE7CmZ1bmN0aW9uIHVzZUVsZW1lbnRPZmZzZXQoKSB7CiAgdmFyIGV4dHJhRGVwZW5kZW5jaWVzID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMF0gOiBbXTsKICB2YXIgW2xhc3RCb3VuZGluZ0JveCwgc2V0TGFzdEJvdW5kaW5nQm94XSA9ICgwLCBpbXBvcnRfcmVhY3QxMC51c2VTdGF0ZSkoewogICAgaGVpZ2h0OiAwLAogICAgbGVmdDogMCwKICAgIHRvcDogMCwKICAgIHdpZHRoOiAwCiAgfSk7CiAgdmFyIHVwZGF0ZUJvdW5kaW5nQm94ID0gKDAsIGltcG9ydF9yZWFjdDEwLnVzZUNhbGxiYWNrKSgKICAgIChub2RlKSA9PiB7CiAgICAgIGlmIChub2RlICE9IG51bGwpIHsKICAgICAgICB2YXIgcmVjdCA9IG5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgdmFyIGJveCA9IHsKICAgICAgICAgIGhlaWdodDogcmVjdC5oZWlnaHQsCiAgICAgICAgICBsZWZ0OiByZWN0LmxlZnQsCiAgICAgICAgICB0b3A6IHJlY3QudG9wLAogICAgICAgICAgd2lkdGg6IHJlY3Qud2lkdGgKICAgICAgICB9OwogICAgICAgIGlmIChNYXRoLmFicyhib3guaGVpZ2h0IC0gbGFzdEJvdW5kaW5nQm94LmhlaWdodCkgPiBFUFMgfHwgTWF0aC5hYnMoYm94LmxlZnQgLSBsYXN0Qm91bmRpbmdCb3gubGVmdCkgPiBFUFMgfHwgTWF0aC5hYnMoYm94LnRvcCAtIGxhc3RCb3VuZGluZ0JveC50b3ApID4gRVBTIHx8IE1hdGguYWJzKGJveC53aWR0aCAtIGxhc3RCb3VuZGluZ0JveC53aWR0aCkgPiBFUFMpIHsKICAgICAgICAgIHNldExhc3RCb3VuZGluZ0JveCh7CiAgICAgICAgICAgIGhlaWdodDogYm94LmhlaWdodCwKICAgICAgICAgICAgbGVmdDogYm94LmxlZnQsCiAgICAgICAgICAgIHRvcDogYm94LnRvcCwKICAgICAgICAgICAgd2lkdGg6IGJveC53aWR0aAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0LWhvb2tzL2V4aGF1c3RpdmUtZGVwcwogICAgW2xhc3RCb3VuZGluZ0JveC53aWR0aCwgbGFzdEJvdW5kaW5nQm94LmhlaWdodCwgbGFzdEJvdW5kaW5nQm94LnRvcCwgbGFzdEJvdW5kaW5nQm94LmxlZnQsIC4uLmV4dHJhRGVwZW5kZW5jaWVzXQogICk7CiAgcmV0dXJuIFtsYXN0Qm91bmRpbmdCb3gsIHVwZGF0ZUJvdW5kaW5nQm94XTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9jaGFydExheW91dENvbnRleHQuanMKdmFyIGltcG9ydF9yZWFjdDEzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWR1eC9kaXN0L3JlZHV4Lm1qcwp2YXIgJCRvYnNlcnZhYmxlID0gLyogQF9fUFVSRV9fICovICgoKSA9PiB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC5vYnNlcnZhYmxlIHx8ICJAQG9ic2VydmFibGUiKSgpOwp2YXIgc3ltYm9sX29ic2VydmFibGVfZGVmYXVsdCA9ICQkb2JzZXJ2YWJsZTsKdmFyIHJhbmRvbVN0cmluZyA9ICgpID0+IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZyg3KS5zcGxpdCgiIikuam9pbigiLiIpOwp2YXIgQWN0aW9uVHlwZXMgPSB7CiAgSU5JVDogYEBAcmVkdXgvSU5JVCR7LyogQF9fUFVSRV9fICovIHJhbmRvbVN0cmluZygpfWAsCiAgUkVQTEFDRTogYEBAcmVkdXgvUkVQTEFDRSR7LyogQF9fUFVSRV9fICovIHJhbmRvbVN0cmluZygpfWAsCiAgUFJPQkVfVU5LTk9XTl9BQ1RJT046ICgpID0+IGBAQHJlZHV4L1BST0JFX1VOS05PV05fQUNUSU9OJHtyYW5kb21TdHJpbmcoKX1gCn07CnZhciBhY3Rpb25UeXBlc19kZWZhdWx0ID0gQWN0aW9uVHlwZXM7CmZ1bmN0aW9uIGlzUGxhaW5PYmplY3Qob2JqKSB7CiAgaWYgKHR5cGVvZiBvYmogIT09ICJvYmplY3QiIHx8IG9iaiA9PT0gbnVsbCkKICAgIHJldHVybiBmYWxzZTsKICBsZXQgcHJvdG8yID0gb2JqOwogIHdoaWxlIChPYmplY3QuZ2V0UHJvdG90eXBlT2YocHJvdG8yKSAhPT0gbnVsbCkgewogICAgcHJvdG8yID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHByb3RvMik7CiAgfQogIHJldHVybiBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqKSA9PT0gcHJvdG8yIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihvYmopID09PSBudWxsOwp9CmZ1bmN0aW9uIG1pbmlLaW5kT2YodmFsKSB7CiAgaWYgKHZhbCA9PT0gdm9pZCAwKQogICAgcmV0dXJuICJ1bmRlZmluZWQiOwogIGlmICh2YWwgPT09IG51bGwpCiAgICByZXR1cm4gIm51bGwiOwogIGNvbnN0IHR5cGUgPSB0eXBlb2YgdmFsOwogIHN3aXRjaCAodHlwZSkgewogICAgY2FzZSAiYm9vbGVhbiI6CiAgICBjYXNlICJzdHJpbmciOgogICAgY2FzZSAibnVtYmVyIjoKICAgIGNhc2UgInN5bWJvbCI6CiAgICBjYXNlICJmdW5jdGlvbiI6IHsKICAgICAgcmV0dXJuIHR5cGU7CiAgICB9CiAgfQogIGlmIChBcnJheS5pc0FycmF5KHZhbCkpCiAgICByZXR1cm4gImFycmF5IjsKICBpZiAoaXNEYXRlKHZhbCkpCiAgICByZXR1cm4gImRhdGUiOwogIGlmIChpc0Vycm9yKHZhbCkpCiAgICByZXR1cm4gImVycm9yIjsKICBjb25zdCBjb25zdHJ1Y3Rvck5hbWUgPSBjdG9yTmFtZSh2YWwpOwogIHN3aXRjaCAoY29uc3RydWN0b3JOYW1lKSB7CiAgICBjYXNlICJTeW1ib2wiOgogICAgY2FzZSAiUHJvbWlzZSI6CiAgICBjYXNlICJXZWFrTWFwIjoKICAgIGNhc2UgIldlYWtTZXQiOgogICAgY2FzZSAiTWFwIjoKICAgIGNhc2UgIlNldCI6CiAgICAgIHJldHVybiBjb25zdHJ1Y3Rvck5hbWU7CiAgfQogIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsKS5zbGljZSg4LCAtMSkudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9ccy9nLCAiIik7Cn0KZnVuY3Rpb24gY3Rvck5hbWUodmFsKSB7CiAgcmV0dXJuIHR5cGVvZiB2YWwuY29uc3RydWN0b3IgPT09ICJmdW5jdGlvbiIgPyB2YWwuY29uc3RydWN0b3IubmFtZSA6IG51bGw7Cn0KZnVuY3Rpb24gaXNFcnJvcih2YWwpIHsKICByZXR1cm4gdmFsIGluc3RhbmNlb2YgRXJyb3IgfHwgdHlwZW9mIHZhbC5tZXNzYWdlID09PSAic3RyaW5nIiAmJiB2YWwuY29uc3RydWN0b3IgJiYgdHlwZW9mIHZhbC5jb25zdHJ1Y3Rvci5zdGFja1RyYWNlTGltaXQgPT09ICJudW1iZXIiOwp9CmZ1bmN0aW9uIGlzRGF0ZSh2YWwpIHsKICBpZiAodmFsIGluc3RhbmNlb2YgRGF0ZSkKICAgIHJldHVybiB0cnVlOwogIHJldHVybiB0eXBlb2YgdmFsLnRvRGF0ZVN0cmluZyA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgdmFsLmdldERhdGUgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIHZhbC5zZXREYXRlID09PSAiZnVuY3Rpb24iOwp9CmZ1bmN0aW9uIGtpbmRPZih2YWwpIHsKICBsZXQgdHlwZU9mVmFsID0gdHlwZW9mIHZhbDsKICBpZiAodHJ1ZSkgewogICAgdHlwZU9mVmFsID0gbWluaUtpbmRPZih2YWwpOwogIH0KICByZXR1cm4gdHlwZU9mVmFsOwp9CmZ1bmN0aW9uIGNyZWF0ZVN0b3JlKHJlZHVjZXIsIHByZWxvYWRlZFN0YXRlLCBlbmhhbmNlcikgewogIGlmICh0eXBlb2YgcmVkdWNlciAhPT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyKSA6IGBFeHBlY3RlZCB0aGUgcm9vdCByZWR1Y2VyIHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQsIHJlY2VpdmVkOiAnJHtraW5kT2YocmVkdWNlcil9J2ApOwogIH0KICBpZiAodHlwZW9mIHByZWxvYWRlZFN0YXRlID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBlbmhhbmNlciA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgZW5oYW5jZXIgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgwKSA6ICJJdCBsb29rcyBsaWtlIHlvdSBhcmUgcGFzc2luZyBzZXZlcmFsIHN0b3JlIGVuaGFuY2VycyB0byBjcmVhdGVTdG9yZSgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIEluc3RlYWQsIGNvbXBvc2UgdGhlbSB0b2dldGhlciB0byBhIHNpbmdsZSBmdW5jdGlvbi4gU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL3R1dG9yaWFscy9mdW5kYW1lbnRhbHMvcGFydC00LXN0b3JlI2NyZWF0aW5nLWEtc3RvcmUtd2l0aC1lbmhhbmNlcnMgZm9yIGFuIGV4YW1wbGUuIik7CiAgfQogIGlmICh0eXBlb2YgcHJlbG9hZGVkU3RhdGUgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGVuaGFuY2VyID09PSAidW5kZWZpbmVkIikgewogICAgZW5oYW5jZXIgPSBwcmVsb2FkZWRTdGF0ZTsKICAgIHByZWxvYWRlZFN0YXRlID0gdm9pZCAwOwogIH0KICBpZiAodHlwZW9mIGVuaGFuY2VyICE9PSAidW5kZWZpbmVkIikgewogICAgaWYgKHR5cGVvZiBlbmhhbmNlciAhPT0gImZ1bmN0aW9uIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEpIDogYEV4cGVjdGVkIHRoZSBlbmhhbmNlciB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkLCByZWNlaXZlZDogJyR7a2luZE9mKGVuaGFuY2VyKX0nYCk7CiAgICB9CiAgICByZXR1cm4gZW5oYW5jZXIoY3JlYXRlU3RvcmUpKHJlZHVjZXIsIHByZWxvYWRlZFN0YXRlKTsKICB9CiAgbGV0IGN1cnJlbnRSZWR1Y2VyID0gcmVkdWNlcjsKICBsZXQgY3VycmVudFN0YXRlID0gcHJlbG9hZGVkU3RhdGU7CiAgbGV0IGN1cnJlbnRMaXN0ZW5lcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGxldCBuZXh0TGlzdGVuZXJzID0gY3VycmVudExpc3RlbmVyczsKICBsZXQgbGlzdGVuZXJJZENvdW50ZXIgPSAwOwogIGxldCBpc0Rpc3BhdGNoaW5nID0gZmFsc2U7CiAgZnVuY3Rpb24gZW5zdXJlQ2FuTXV0YXRlTmV4dExpc3RlbmVycygpIHsKICAgIGlmIChuZXh0TGlzdGVuZXJzID09PSBjdXJyZW50TGlzdGVuZXJzKSB7CiAgICAgIG5leHRMaXN0ZW5lcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICBjdXJyZW50TGlzdGVuZXJzLmZvckVhY2goKGxpc3RlbmVyMiwga2V5KSA9PiB7CiAgICAgICAgbmV4dExpc3RlbmVycy5zZXQoa2V5LCBsaXN0ZW5lcjIpOwogICAgICB9KTsKICAgIH0KICB9CiAgZnVuY3Rpb24gZ2V0U3RhdGUoKSB7CiAgICBpZiAoaXNEaXNwYXRjaGluZykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDMpIDogIllvdSBtYXkgbm90IGNhbGwgc3RvcmUuZ2V0U3RhdGUoKSB3aGlsZSB0aGUgcmVkdWNlciBpcyBleGVjdXRpbmcuIFRoZSByZWR1Y2VyIGhhcyBhbHJlYWR5IHJlY2VpdmVkIHRoZSBzdGF0ZSBhcyBhbiBhcmd1bWVudC4gUGFzcyBpdCBkb3duIGZyb20gdGhlIHRvcCByZWR1Y2VyIGluc3RlYWQgb2YgcmVhZGluZyBpdCBmcm9tIHRoZSBzdG9yZS4iKTsKICAgIH0KICAgIHJldHVybiBjdXJyZW50U3RhdGU7CiAgfQogIGZ1bmN0aW9uIHN1YnNjcmliZShsaXN0ZW5lcjIpIHsKICAgIGlmICh0eXBlb2YgbGlzdGVuZXIyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNCkgOiBgRXhwZWN0ZWQgdGhlIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQsIHJlY2VpdmVkOiAnJHtraW5kT2YobGlzdGVuZXIyKX0nYCk7CiAgICB9CiAgICBpZiAoaXNEaXNwYXRjaGluZykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDUpIDogIllvdSBtYXkgbm90IGNhbGwgc3RvcmUuc3Vic2NyaWJlKCkgd2hpbGUgdGhlIHJlZHVjZXIgaXMgZXhlY3V0aW5nLiBJZiB5b3Ugd291bGQgbGlrZSB0byBiZSBub3RpZmllZCBhZnRlciB0aGUgc3RvcmUgaGFzIGJlZW4gdXBkYXRlZCwgc3Vic2NyaWJlIGZyb20gYSBjb21wb25lbnQgYW5kIGludm9rZSBzdG9yZS5nZXRTdGF0ZSgpIGluIHRoZSBjYWxsYmFjayB0byBhY2Nlc3MgdGhlIGxhdGVzdCBzdGF0ZS4gU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL2FwaS9zdG9yZSNzdWJzY3JpYmVsaXN0ZW5lciBmb3IgbW9yZSBkZXRhaWxzLiIpOwogICAgfQogICAgbGV0IGlzU3Vic2NyaWJlZCA9IHRydWU7CiAgICBlbnN1cmVDYW5NdXRhdGVOZXh0TGlzdGVuZXJzKCk7CiAgICBjb25zdCBsaXN0ZW5lcklkID0gbGlzdGVuZXJJZENvdW50ZXIrKzsKICAgIG5leHRMaXN0ZW5lcnMuc2V0KGxpc3RlbmVySWQsIGxpc3RlbmVyMik7CiAgICByZXR1cm4gZnVuY3Rpb24gdW5zdWJzY3JpYmUoKSB7CiAgICAgIGlmICghaXNTdWJzY3JpYmVkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChpc0Rpc3BhdGNoaW5nKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg2KSA6ICJZb3UgbWF5IG5vdCB1bnN1YnNjcmliZSBmcm9tIGEgc3RvcmUgbGlzdGVuZXIgd2hpbGUgdGhlIHJlZHVjZXIgaXMgZXhlY3V0aW5nLiBTZWUgaHR0cHM6Ly9yZWR1eC5qcy5vcmcvYXBpL3N0b3JlI3N1YnNjcmliZWxpc3RlbmVyIGZvciBtb3JlIGRldGFpbHMuIik7CiAgICAgIH0KICAgICAgaXNTdWJzY3JpYmVkID0gZmFsc2U7CiAgICAgIGVuc3VyZUNhbk11dGF0ZU5leHRMaXN0ZW5lcnMoKTsKICAgICAgbmV4dExpc3RlbmVycy5kZWxldGUobGlzdGVuZXJJZCk7CiAgICAgIGN1cnJlbnRMaXN0ZW5lcnMgPSBudWxsOwogICAgfTsKICB9CiAgZnVuY3Rpb24gZGlzcGF0Y2goYWN0aW9uKSB7CiAgICBpZiAoIWlzUGxhaW5PYmplY3QoYWN0aW9uKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDcpIDogYEFjdGlvbnMgbXVzdCBiZSBwbGFpbiBvYmplY3RzLiBJbnN0ZWFkLCB0aGUgYWN0dWFsIHR5cGUgd2FzOiAnJHtraW5kT2YoYWN0aW9uKX0nLiBZb3UgbWF5IG5lZWQgdG8gYWRkIG1pZGRsZXdhcmUgdG8geW91ciBzdG9yZSBzZXR1cCB0byBoYW5kbGUgZGlzcGF0Y2hpbmcgb3RoZXIgdmFsdWVzLCBzdWNoIGFzICdyZWR1eC10aHVuaycgdG8gaGFuZGxlIGRpc3BhdGNoaW5nIGZ1bmN0aW9ucy4gU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL3R1dG9yaWFscy9mdW5kYW1lbnRhbHMvcGFydC00LXN0b3JlI21pZGRsZXdhcmUgYW5kIGh0dHBzOi8vcmVkdXguanMub3JnL3R1dG9yaWFscy9mdW5kYW1lbnRhbHMvcGFydC02LWFzeW5jLWxvZ2ljI3VzaW5nLXRoZS1yZWR1eC10aHVuay1taWRkbGV3YXJlIGZvciBleGFtcGxlcy5gKTsKICAgIH0KICAgIGlmICh0eXBlb2YgYWN0aW9uLnR5cGUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoOCkgOiAnQWN0aW9ucyBtYXkgbm90IGhhdmUgYW4gdW5kZWZpbmVkICJ0eXBlIiBwcm9wZXJ0eS4gWW91IG1heSBoYXZlIG1pc3NwZWxsZWQgYW4gYWN0aW9uIHR5cGUgc3RyaW5nIGNvbnN0YW50LicpOwogICAgfQogICAgaWYgKHR5cGVvZiBhY3Rpb24udHlwZSAhPT0gInN0cmluZyIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNykgOiBgQWN0aW9uICJ0eXBlIiBwcm9wZXJ0eSBtdXN0IGJlIGEgc3RyaW5nLiBJbnN0ZWFkLCB0aGUgYWN0dWFsIHR5cGUgd2FzOiAnJHtraW5kT2YoYWN0aW9uLnR5cGUpfScuIFZhbHVlIHdhczogJyR7YWN0aW9uLnR5cGV9JyAoc3RyaW5naWZpZWQpYCk7CiAgICB9CiAgICBpZiAoaXNEaXNwYXRjaGluZykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDkpIDogIlJlZHVjZXJzIG1heSBub3QgZGlzcGF0Y2ggYWN0aW9ucy4iKTsKICAgIH0KICAgIHRyeSB7CiAgICAgIGlzRGlzcGF0Y2hpbmcgPSB0cnVlOwogICAgICBjdXJyZW50U3RhdGUgPSBjdXJyZW50UmVkdWNlcihjdXJyZW50U3RhdGUsIGFjdGlvbik7CiAgICB9IGZpbmFsbHkgewogICAgICBpc0Rpc3BhdGNoaW5nID0gZmFsc2U7CiAgICB9CiAgICBjb25zdCBsaXN0ZW5lcnMgPSBjdXJyZW50TGlzdGVuZXJzID0gbmV4dExpc3RlbmVyczsKICAgIGxpc3RlbmVycy5mb3JFYWNoKChsaXN0ZW5lcjIpID0+IHsKICAgICAgbGlzdGVuZXIyKCk7CiAgICB9KTsKICAgIHJldHVybiBhY3Rpb247CiAgfQogIGZ1bmN0aW9uIHJlcGxhY2VSZWR1Y2VyKG5leHRSZWR1Y2VyKSB7CiAgICBpZiAodHlwZW9mIG5leHRSZWR1Y2VyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTApIDogYEV4cGVjdGVkIHRoZSBuZXh0UmVkdWNlciB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkLCByZWNlaXZlZDogJyR7a2luZE9mKG5leHRSZWR1Y2VyKX1gKTsKICAgIH0KICAgIGN1cnJlbnRSZWR1Y2VyID0gbmV4dFJlZHVjZXI7CiAgICBkaXNwYXRjaCh7CiAgICAgIHR5cGU6IGFjdGlvblR5cGVzX2RlZmF1bHQuUkVQTEFDRQogICAgfSk7CiAgfQogIGZ1bmN0aW9uIG9ic2VydmFibGUoKSB7CiAgICBjb25zdCBvdXRlclN1YnNjcmliZSA9IHN1YnNjcmliZTsKICAgIHJldHVybiB7CiAgICAgIC8qKgogICAgICAgKiBUaGUgbWluaW1hbCBvYnNlcnZhYmxlIHN1YnNjcmlwdGlvbiBtZXRob2QuCiAgICAgICAqIEBwYXJhbSBvYnNlcnZlciBBbnkgb2JqZWN0IHRoYXQgY2FuIGJlIHVzZWQgYXMgYW4gb2JzZXJ2ZXIuCiAgICAgICAqIFRoZSBvYnNlcnZlciBvYmplY3Qgc2hvdWxkIGhhdmUgYSBgbmV4dGAgbWV0aG9kLgogICAgICAgKiBAcmV0dXJucyBBbiBvYmplY3Qgd2l0aCBhbiBgdW5zdWJzY3JpYmVgIG1ldGhvZCB0aGF0IGNhbgogICAgICAgKiBiZSB1c2VkIHRvIHVuc3Vic2NyaWJlIHRoZSBvYnNlcnZhYmxlIGZyb20gdGhlIHN0b3JlLCBhbmQgcHJldmVudCBmdXJ0aGVyCiAgICAgICAqIGVtaXNzaW9uIG9mIHZhbHVlcyBmcm9tIHRoZSBvYnNlcnZhYmxlLgogICAgICAgKi8KICAgICAgc3Vic2NyaWJlKG9ic2VydmVyKSB7CiAgICAgICAgaWYgKHR5cGVvZiBvYnNlcnZlciAhPT0gIm9iamVjdCIgfHwgb2JzZXJ2ZXIgPT09IG51bGwpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTEpIDogYEV4cGVjdGVkIHRoZSBvYnNlcnZlciB0byBiZSBhbiBvYmplY3QuIEluc3RlYWQsIHJlY2VpdmVkOiAnJHtraW5kT2Yob2JzZXJ2ZXIpfSdgKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb2JzZXJ2ZVN0YXRlKCkgewogICAgICAgICAgY29uc3Qgb2JzZXJ2ZXJBc09ic2VydmVyID0gb2JzZXJ2ZXI7CiAgICAgICAgICBpZiAob2JzZXJ2ZXJBc09ic2VydmVyLm5leHQpIHsKICAgICAgICAgICAgb2JzZXJ2ZXJBc09ic2VydmVyLm5leHQoZ2V0U3RhdGUoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIG9ic2VydmVTdGF0ZSgpOwogICAgICAgIGNvbnN0IHVuc3Vic2NyaWJlID0gb3V0ZXJTdWJzY3JpYmUob2JzZXJ2ZVN0YXRlKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdW5zdWJzY3JpYmUKICAgICAgICB9OwogICAgICB9LAogICAgICBbc3ltYm9sX29ic2VydmFibGVfZGVmYXVsdF0oKSB7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgIH07CiAgfQogIGRpc3BhdGNoKHsKICAgIHR5cGU6IGFjdGlvblR5cGVzX2RlZmF1bHQuSU5JVAogIH0pOwogIGNvbnN0IHN0b3JlID0gewogICAgZGlzcGF0Y2gsCiAgICBzdWJzY3JpYmUsCiAgICBnZXRTdGF0ZSwKICAgIHJlcGxhY2VSZWR1Y2VyLAogICAgW3N5bWJvbF9vYnNlcnZhYmxlX2RlZmF1bHRdOiBvYnNlcnZhYmxlCiAgfTsKICByZXR1cm4gc3RvcmU7Cn0KZnVuY3Rpb24gd2FybmluZyhtZXNzYWdlKSB7CiAgaWYgKHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgY29uc29sZS5lcnJvciA9PT0gImZ1bmN0aW9uIikgewogICAgY29uc29sZS5lcnJvcihtZXNzYWdlKTsKICB9CiAgdHJ5IHsKICAgIHRocm93IG5ldyBFcnJvcihtZXNzYWdlKTsKICB9IGNhdGNoIChlKSB7CiAgfQp9CmZ1bmN0aW9uIGdldFVuZXhwZWN0ZWRTdGF0ZVNoYXBlV2FybmluZ01lc3NhZ2UoaW5wdXRTdGF0ZSwgcmVkdWNlcnMsIGFjdGlvbiwgdW5leHBlY3RlZEtleUNhY2hlKSB7CiAgY29uc3QgcmVkdWNlcktleXMgPSBPYmplY3Qua2V5cyhyZWR1Y2Vycyk7CiAgY29uc3QgYXJndW1lbnROYW1lID0gYWN0aW9uICYmIGFjdGlvbi50eXBlID09PSBhY3Rpb25UeXBlc19kZWZhdWx0LklOSVQgPyAicHJlbG9hZGVkU3RhdGUgYXJndW1lbnQgcGFzc2VkIHRvIGNyZWF0ZVN0b3JlIiA6ICJwcmV2aW91cyBzdGF0ZSByZWNlaXZlZCBieSB0aGUgcmVkdWNlciI7CiAgaWYgKHJlZHVjZXJLZXlzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuICJTdG9yZSBkb2VzIG5vdCBoYXZlIGEgdmFsaWQgcmVkdWNlci4gTWFrZSBzdXJlIHRoZSBhcmd1bWVudCBwYXNzZWQgdG8gY29tYmluZVJlZHVjZXJzIGlzIGFuIG9iamVjdCB3aG9zZSB2YWx1ZXMgYXJlIHJlZHVjZXJzLiI7CiAgfQogIGlmICghaXNQbGFpbk9iamVjdChpbnB1dFN0YXRlKSkgewogICAgcmV0dXJuIGBUaGUgJHthcmd1bWVudE5hbWV9IGhhcyB1bmV4cGVjdGVkIHR5cGUgb2YgIiR7a2luZE9mKGlucHV0U3RhdGUpfSIuIEV4cGVjdGVkIGFyZ3VtZW50IHRvIGJlIGFuIG9iamVjdCB3aXRoIHRoZSBmb2xsb3dpbmcga2V5czogIiR7cmVkdWNlcktleXMuam9pbignIiwgIicpfSJgOwogIH0KICBjb25zdCB1bmV4cGVjdGVkS2V5cyA9IE9iamVjdC5rZXlzKGlucHV0U3RhdGUpLmZpbHRlcigoa2V5KSA9PiAhcmVkdWNlcnMuaGFzT3duUHJvcGVydHkoa2V5KSAmJiAhdW5leHBlY3RlZEtleUNhY2hlW2tleV0pOwogIHVuZXhwZWN0ZWRLZXlzLmZvckVhY2goKGtleSkgPT4gewogICAgdW5leHBlY3RlZEtleUNhY2hlW2tleV0gPSB0cnVlOwogIH0pOwogIGlmIChhY3Rpb24gJiYgYWN0aW9uLnR5cGUgPT09IGFjdGlvblR5cGVzX2RlZmF1bHQuUkVQTEFDRSkKICAgIHJldHVybjsKICBpZiAodW5leHBlY3RlZEtleXMubGVuZ3RoID4gMCkgewogICAgcmV0dXJuIGBVbmV4cGVjdGVkICR7dW5leHBlY3RlZEtleXMubGVuZ3RoID4gMSA/ICJrZXlzIiA6ICJrZXkifSAiJHt1bmV4cGVjdGVkS2V5cy5qb2luKCciLCAiJyl9IiBmb3VuZCBpbiAke2FyZ3VtZW50TmFtZX0uIEV4cGVjdGVkIHRvIGZpbmQgb25lIG9mIHRoZSBrbm93biByZWR1Y2VyIGtleXMgaW5zdGVhZDogIiR7cmVkdWNlcktleXMuam9pbignIiwgIicpfSIuIFVuZXhwZWN0ZWQga2V5cyB3aWxsIGJlIGlnbm9yZWQuYDsKICB9Cn0KZnVuY3Rpb24gYXNzZXJ0UmVkdWNlclNoYXBlKHJlZHVjZXJzKSB7CiAgT2JqZWN0LmtleXMocmVkdWNlcnMpLmZvckVhY2goKGtleSkgPT4gewogICAgY29uc3QgcmVkdWNlciA9IHJlZHVjZXJzW2tleV07CiAgICBjb25zdCBpbml0aWFsU3RhdGUxMyA9IHJlZHVjZXIodm9pZCAwLCB7CiAgICAgIHR5cGU6IGFjdGlvblR5cGVzX2RlZmF1bHQuSU5JVAogICAgfSk7CiAgICBpZiAodHlwZW9mIGluaXRpYWxTdGF0ZTEzID09PSAidW5kZWZpbmVkIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEyKSA6IGBUaGUgc2xpY2UgcmVkdWNlciBmb3Iga2V5ICIke2tleX0iIHJldHVybmVkIHVuZGVmaW5lZCBkdXJpbmcgaW5pdGlhbGl6YXRpb24uIElmIHRoZSBzdGF0ZSBwYXNzZWQgdG8gdGhlIHJlZHVjZXIgaXMgdW5kZWZpbmVkLCB5b3UgbXVzdCBleHBsaWNpdGx5IHJldHVybiB0aGUgaW5pdGlhbCBzdGF0ZS4gVGhlIGluaXRpYWwgc3RhdGUgbWF5IG5vdCBiZSB1bmRlZmluZWQuIElmIHlvdSBkb24ndCB3YW50IHRvIHNldCBhIHZhbHVlIGZvciB0aGlzIHJlZHVjZXIsIHlvdSBjYW4gdXNlIG51bGwgaW5zdGVhZCBvZiB1bmRlZmluZWQuYCk7CiAgICB9CiAgICBpZiAodHlwZW9mIHJlZHVjZXIodm9pZCAwLCB7CiAgICAgIHR5cGU6IGFjdGlvblR5cGVzX2RlZmF1bHQuUFJPQkVfVU5LTk9XTl9BQ1RJT04oKQogICAgfSkgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTMpIDogYFRoZSBzbGljZSByZWR1Y2VyIGZvciBrZXkgIiR7a2V5fSIgcmV0dXJuZWQgdW5kZWZpbmVkIHdoZW4gcHJvYmVkIHdpdGggYSByYW5kb20gdHlwZS4gRG9uJ3QgdHJ5IHRvIGhhbmRsZSAnJHthY3Rpb25UeXBlc19kZWZhdWx0LklOSVR9JyBvciBvdGhlciBhY3Rpb25zIGluICJyZWR1eC8qIiBuYW1lc3BhY2UuIFRoZXkgYXJlIGNvbnNpZGVyZWQgcHJpdmF0ZS4gSW5zdGVhZCwgeW91IG11c3QgcmV0dXJuIHRoZSBjdXJyZW50IHN0YXRlIGZvciBhbnkgdW5rbm93biBhY3Rpb25zLCB1bmxlc3MgaXQgaXMgdW5kZWZpbmVkLCBpbiB3aGljaCBjYXNlIHlvdSBtdXN0IHJldHVybiB0aGUgaW5pdGlhbCBzdGF0ZSwgcmVnYXJkbGVzcyBvZiB0aGUgYWN0aW9uIHR5cGUuIFRoZSBpbml0aWFsIHN0YXRlIG1heSBub3QgYmUgdW5kZWZpbmVkLCBidXQgY2FuIGJlIG51bGwuYCk7CiAgICB9CiAgfSk7Cn0KZnVuY3Rpb24gY29tYmluZVJlZHVjZXJzKHJlZHVjZXJzKSB7CiAgY29uc3QgcmVkdWNlcktleXMgPSBPYmplY3Qua2V5cyhyZWR1Y2Vycyk7CiAgY29uc3QgZmluYWxSZWR1Y2VycyA9IHt9OwogIGZvciAobGV0IGkgPSAwOyBpIDwgcmVkdWNlcktleXMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IGtleSA9IHJlZHVjZXJLZXlzW2ldOwogICAgaWYgKHRydWUpIHsKICAgICAgaWYgKHR5cGVvZiByZWR1Y2Vyc1trZXldID09PSAidW5kZWZpbmVkIikgewogICAgICAgIHdhcm5pbmcoYE5vIHJlZHVjZXIgcHJvdmlkZWQgZm9yIGtleSAiJHtrZXl9ImApOwogICAgICB9CiAgICB9CiAgICBpZiAodHlwZW9mIHJlZHVjZXJzW2tleV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgZmluYWxSZWR1Y2Vyc1trZXldID0gcmVkdWNlcnNba2V5XTsKICAgIH0KICB9CiAgY29uc3QgZmluYWxSZWR1Y2VyS2V5cyA9IE9iamVjdC5rZXlzKGZpbmFsUmVkdWNlcnMpOwogIGxldCB1bmV4cGVjdGVkS2V5Q2FjaGU7CiAgaWYgKHRydWUpIHsKICAgIHVuZXhwZWN0ZWRLZXlDYWNoZSA9IHt9OwogIH0KICBsZXQgc2hhcGVBc3NlcnRpb25FcnJvcjsKICB0cnkgewogICAgYXNzZXJ0UmVkdWNlclNoYXBlKGZpbmFsUmVkdWNlcnMpOwogIH0gY2F0Y2ggKGUpIHsKICAgIHNoYXBlQXNzZXJ0aW9uRXJyb3IgPSBlOwogIH0KICByZXR1cm4gZnVuY3Rpb24gY29tYmluYXRpb24oc3RhdGUgPSB7fSwgYWN0aW9uKSB7CiAgICBpZiAoc2hhcGVBc3NlcnRpb25FcnJvcikgewogICAgICB0aHJvdyBzaGFwZUFzc2VydGlvbkVycm9yOwogICAgfQogICAgaWYgKHRydWUpIHsKICAgICAgY29uc3Qgd2FybmluZ01lc3NhZ2UgPSBnZXRVbmV4cGVjdGVkU3RhdGVTaGFwZVdhcm5pbmdNZXNzYWdlKHN0YXRlLCBmaW5hbFJlZHVjZXJzLCBhY3Rpb24sIHVuZXhwZWN0ZWRLZXlDYWNoZSk7CiAgICAgIGlmICh3YXJuaW5nTWVzc2FnZSkgewogICAgICAgIHdhcm5pbmcod2FybmluZ01lc3NhZ2UpOwogICAgICB9CiAgICB9CiAgICBsZXQgaGFzQ2hhbmdlZCA9IGZhbHNlOwogICAgY29uc3QgbmV4dFN0YXRlID0ge307CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpbmFsUmVkdWNlcktleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qga2V5ID0gZmluYWxSZWR1Y2VyS2V5c1tpXTsKICAgICAgY29uc3QgcmVkdWNlciA9IGZpbmFsUmVkdWNlcnNba2V5XTsKICAgICAgY29uc3QgcHJldmlvdXNTdGF0ZUZvcktleSA9IHN0YXRlW2tleV07CiAgICAgIGNvbnN0IG5leHRTdGF0ZUZvcktleSA9IHJlZHVjZXIocHJldmlvdXNTdGF0ZUZvcktleSwgYWN0aW9uKTsKICAgICAgaWYgKHR5cGVvZiBuZXh0U3RhdGVGb3JLZXkgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgY29uc3QgYWN0aW9uVHlwZSA9IGFjdGlvbiAmJiBhY3Rpb24udHlwZTsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE0KSA6IGBXaGVuIGNhbGxlZCB3aXRoIGFuIGFjdGlvbiBvZiB0eXBlICR7YWN0aW9uVHlwZSA/IGAiJHtTdHJpbmcoYWN0aW9uVHlwZSl9ImAgOiAiKHVua25vd24gdHlwZSkifSwgdGhlIHNsaWNlIHJlZHVjZXIgZm9yIGtleSAiJHtrZXl9IiByZXR1cm5lZCB1bmRlZmluZWQuIFRvIGlnbm9yZSBhbiBhY3Rpb24sIHlvdSBtdXN0IGV4cGxpY2l0bHkgcmV0dXJuIHRoZSBwcmV2aW91cyBzdGF0ZS4gSWYgeW91IHdhbnQgdGhpcyByZWR1Y2VyIHRvIGhvbGQgbm8gdmFsdWUsIHlvdSBjYW4gcmV0dXJuIG51bGwgaW5zdGVhZCBvZiB1bmRlZmluZWQuYCk7CiAgICAgIH0KICAgICAgbmV4dFN0YXRlW2tleV0gPSBuZXh0U3RhdGVGb3JLZXk7CiAgICAgIGhhc0NoYW5nZWQgPSBoYXNDaGFuZ2VkIHx8IG5leHRTdGF0ZUZvcktleSAhPT0gcHJldmlvdXNTdGF0ZUZvcktleTsKICAgIH0KICAgIGhhc0NoYW5nZWQgPSBoYXNDaGFuZ2VkIHx8IGZpbmFsUmVkdWNlcktleXMubGVuZ3RoICE9PSBPYmplY3Qua2V5cyhzdGF0ZSkubGVuZ3RoOwogICAgcmV0dXJuIGhhc0NoYW5nZWQgPyBuZXh0U3RhdGUgOiBzdGF0ZTsKICB9Owp9CmZ1bmN0aW9uIGNvbXBvc2UoLi4uZnVuY3MpIHsKICBpZiAoZnVuY3MubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gKGFyZykgPT4gYXJnOwogIH0KICBpZiAoZnVuY3MubGVuZ3RoID09PSAxKSB7CiAgICByZXR1cm4gZnVuY3NbMF07CiAgfQogIHJldHVybiBmdW5jcy5yZWR1Y2UoKGEsIGIpID0+ICguLi5hcmdzKSA9PiBhKGIoLi4uYXJncykpKTsKfQpmdW5jdGlvbiBhcHBseU1pZGRsZXdhcmUoLi4ubWlkZGxld2FyZXMpIHsKICByZXR1cm4gKGNyZWF0ZVN0b3JlMikgPT4gKHJlZHVjZXIsIHByZWxvYWRlZFN0YXRlKSA9PiB7CiAgICBjb25zdCBzdG9yZSA9IGNyZWF0ZVN0b3JlMihyZWR1Y2VyLCBwcmVsb2FkZWRTdGF0ZSk7CiAgICBsZXQgZGlzcGF0Y2ggPSAoKSA9PiB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTUpIDogIkRpc3BhdGNoaW5nIHdoaWxlIGNvbnN0cnVjdGluZyB5b3VyIG1pZGRsZXdhcmUgaXMgbm90IGFsbG93ZWQuIE90aGVyIG1pZGRsZXdhcmUgd291bGQgbm90IGJlIGFwcGxpZWQgdG8gdGhpcyBkaXNwYXRjaC4iKTsKICAgIH07CiAgICBjb25zdCBtaWRkbGV3YXJlQVBJID0gewogICAgICBnZXRTdGF0ZTogc3RvcmUuZ2V0U3RhdGUsCiAgICAgIGRpc3BhdGNoOiAoYWN0aW9uLCAuLi5hcmdzKSA9PiBkaXNwYXRjaChhY3Rpb24sIC4uLmFyZ3MpCiAgICB9OwogICAgY29uc3QgY2hhaW4gPSBtaWRkbGV3YXJlcy5tYXAoKG1pZGRsZXdhcmUpID0+IG1pZGRsZXdhcmUobWlkZGxld2FyZUFQSSkpOwogICAgZGlzcGF0Y2ggPSBjb21wb3NlKC4uLmNoYWluKShzdG9yZS5kaXNwYXRjaCk7CiAgICByZXR1cm4gewogICAgICAuLi5zdG9yZSwKICAgICAgZGlzcGF0Y2gKICAgIH07CiAgfTsKfQpmdW5jdGlvbiBpc0FjdGlvbihhY3Rpb24pIHsKICByZXR1cm4gaXNQbGFpbk9iamVjdChhY3Rpb24pICYmICJ0eXBlIiBpbiBhY3Rpb24gJiYgdHlwZW9mIGFjdGlvbi50eXBlID09PSAic3RyaW5nIjsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2ltbWVyQDExLjAuMS9ub2RlX21vZHVsZXMvaW1tZXIvZGlzdC9pbW1lci5tanMKdmFyIE5PVEhJTkcgPSBTeW1ib2wuZm9yKCJpbW1lci1ub3RoaW5nIik7CnZhciBEUkFGVEFCTEUgPSBTeW1ib2wuZm9yKCJpbW1lci1kcmFmdGFibGUiKTsKdmFyIERSQUZUX1NUQVRFID0gU3ltYm9sLmZvcigiaW1tZXItc3RhdGUiKTsKdmFyIGVycm9ycyA9IHRydWUgPyBbCiAgLy8gQWxsIGVycm9yIGNvZGVzLCBzdGFydGluZyBieSAwOgogIGZ1bmN0aW9uKHBsdWdpbikgewogICAgcmV0dXJuIGBUaGUgcGx1Z2luIGZvciAnJHtwbHVnaW59JyBoYXMgbm90IGJlZW4gbG9hZGVkIGludG8gSW1tZXIuIFRvIGVuYWJsZSB0aGUgcGx1Z2luLCBpbXBvcnQgYW5kIGNhbGwgXGBlbmFibGUke3BsdWdpbn0oKVxgIHdoZW4gaW5pdGlhbGl6aW5nIHlvdXIgYXBwbGljYXRpb24uYDsKICB9LAogIGZ1bmN0aW9uKHRoaW5nKSB7CiAgICByZXR1cm4gYHByb2R1Y2UgY2FuIG9ubHkgYmUgY2FsbGVkIG9uIHRoaW5ncyB0aGF0IGFyZSBkcmFmdGFibGU6IHBsYWluIG9iamVjdHMsIGFycmF5cywgTWFwLCBTZXQgb3IgY2xhc3NlcyB0aGF0IGFyZSBtYXJrZWQgd2l0aCAnW2ltbWVyYWJsZV06IHRydWUnLiBHb3QgJyR7dGhpbmd9J2A7CiAgfSwKICAiVGhpcyBvYmplY3QgaGFzIGJlZW4gZnJvemVuIGFuZCBzaG91bGQgbm90IGJlIG11dGF0ZWQiLAogIGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiAiQ2Fubm90IHVzZSBhIHByb3h5IHRoYXQgaGFzIGJlZW4gcmV2b2tlZC4gRGlkIHlvdSBwYXNzIGFuIG9iamVjdCBmcm9tIGluc2lkZSBhbiBpbW1lciBmdW5jdGlvbiB0byBhbiBhc3luYyBwcm9jZXNzPyAiICsgZGF0YTsKICB9LAogICJBbiBpbW1lciBwcm9kdWNlciByZXR1cm5lZCBhIG5ldyB2YWx1ZSAqYW5kKiBtb2RpZmllZCBpdHMgZHJhZnQuIEVpdGhlciByZXR1cm4gYSBuZXcgdmFsdWUgKm9yKiBtb2RpZnkgdGhlIGRyYWZ0LiIsCiAgIkltbWVyIGZvcmJpZHMgY2lyY3VsYXIgcmVmZXJlbmNlcyIsCiAgIlRoZSBmaXJzdCBvciBzZWNvbmQgYXJndW1lbnQgdG8gYHByb2R1Y2VgIG11c3QgYmUgYSBmdW5jdGlvbiIsCiAgIlRoZSB0aGlyZCBhcmd1bWVudCB0byBgcHJvZHVjZWAgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIHVuZGVmaW5lZCIsCiAgIkZpcnN0IGFyZ3VtZW50IHRvIGBjcmVhdGVEcmFmdGAgbXVzdCBiZSBhIHBsYWluIG9iamVjdCwgYW4gYXJyYXksIG9yIGFuIGltbWVyYWJsZSBvYmplY3QiLAogICJGaXJzdCBhcmd1bWVudCB0byBgZmluaXNoRHJhZnRgIG11c3QgYmUgYSBkcmFmdCByZXR1cm5lZCBieSBgY3JlYXRlRHJhZnRgIiwKICBmdW5jdGlvbih0aGluZykgewogICAgcmV0dXJuIGAnY3VycmVudCcgZXhwZWN0cyBhIGRyYWZ0LCBnb3Q6ICR7dGhpbmd9YDsKICB9LAogICJPYmplY3QuZGVmaW5lUHJvcGVydHkoKSBjYW5ub3QgYmUgdXNlZCBvbiBhbiBJbW1lciBkcmFmdCIsCiAgIk9iamVjdC5zZXRQcm90b3R5cGVPZigpIGNhbm5vdCBiZSB1c2VkIG9uIGFuIEltbWVyIGRyYWZ0IiwKICAiSW1tZXIgb25seSBzdXBwb3J0cyBkZWxldGluZyBhcnJheSBpbmRpY2VzIiwKICAiSW1tZXIgb25seSBzdXBwb3J0cyBzZXR0aW5nIGFycmF5IGluZGljZXMgYW5kIHRoZSAnbGVuZ3RoJyBwcm9wZXJ0eSIsCiAgZnVuY3Rpb24odGhpbmcpIHsKICAgIHJldHVybiBgJ29yaWdpbmFsJyBleHBlY3RzIGEgZHJhZnQsIGdvdDogJHt0aGluZ31gOwogIH0KICAvLyBOb3RlOiBpZiBtb3JlIGVycm9ycyBhcmUgYWRkZWQsIHRoZSBlcnJvck9mZnNldCBpbiBQYXRjaGVzLnRzIHNob3VsZCBiZSBpbmNyZWFzZWQKICAvLyBTZWUgUGF0Y2hlcy50cyBmb3IgYWRkaXRpb25hbCBlcnJvcnMKXSA6IFtdOwpmdW5jdGlvbiBkaWUoZXJyb3IsIC4uLmFyZ3MpIHsKICBpZiAodHJ1ZSkgewogICAgY29uc3QgZSA9IGVycm9yc1tlcnJvcl07CiAgICBjb25zdCBtc2cgPSBpc0Z1bmN0aW9uKGUpID8gZS5hcHBseShudWxsLCBhcmdzKSA6IGU7CiAgICB0aHJvdyBuZXcgRXJyb3IoYFtJbW1lcl0gJHttc2d9YCk7CiAgfQogIHRocm93IG5ldyBFcnJvcigKICAgIGBbSW1tZXJdIG1pbmlmaWVkIGVycm9yIG5yOiAke2Vycm9yfS4gRnVsbCBlcnJvciBhdDogaHR0cHM6Ly9iaXQubHkvM2NYRUtXZmAKICApOwp9CnZhciBPID0gT2JqZWN0Owp2YXIgZ2V0UHJvdG90eXBlT2YgPSBPLmdldFByb3RvdHlwZU9mOwp2YXIgQ09OU1RSVUNUT1IgPSAiY29uc3RydWN0b3IiOwp2YXIgUFJPVE9UWVBFID0gInByb3RvdHlwZSI7CnZhciBDT05GSUdVUkFCTEUgPSAiY29uZmlndXJhYmxlIjsKdmFyIEVOVU1FUkFCTEUgPSAiZW51bWVyYWJsZSI7CnZhciBXUklUQUJMRSA9ICJ3cml0YWJsZSI7CnZhciBWQUxVRSA9ICJ2YWx1ZSI7CnZhciBpc0RyYWZ0ID0gKHZhbHVlKSA9PiAhIXZhbHVlICYmICEhdmFsdWVbRFJBRlRfU1RBVEVdOwpmdW5jdGlvbiBpc0RyYWZ0YWJsZSh2YWx1ZSkgewogIGlmICghdmFsdWUpCiAgICByZXR1cm4gZmFsc2U7CiAgcmV0dXJuIGlzUGxhaW5PYmplY3QyKHZhbHVlKSB8fCBpc0FycmF5KHZhbHVlKSB8fCAhIXZhbHVlW0RSQUZUQUJMRV0gfHwgISF2YWx1ZVtDT05TVFJVQ1RPUl0/LltEUkFGVEFCTEVdIHx8IGlzTWFwKHZhbHVlKSB8fCBpc1NldCh2YWx1ZSk7Cn0KdmFyIG9iamVjdEN0b3JTdHJpbmcgPSBPW1BST1RPVFlQRV1bQ09OU1RSVUNUT1JdLnRvU3RyaW5nKCk7CnZhciBjYWNoZWRDdG9yU3RyaW5ncyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwpmdW5jdGlvbiBpc1BsYWluT2JqZWN0Mih2YWx1ZSkgewogIGlmICghdmFsdWUgfHwgIWlzT2JqZWN0aXNoKHZhbHVlKSkKICAgIHJldHVybiBmYWxzZTsKICBjb25zdCBwcm90bzIgPSBnZXRQcm90b3R5cGVPZih2YWx1ZSk7CiAgaWYgKHByb3RvMiA9PT0gbnVsbCB8fCBwcm90bzIgPT09IE9bUFJPVE9UWVBFXSkKICAgIHJldHVybiB0cnVlOwogIGNvbnN0IEN0b3IgPSBPLmhhc093blByb3BlcnR5LmNhbGwocHJvdG8yLCBDT05TVFJVQ1RPUikgJiYgcHJvdG8yW0NPTlNUUlVDVE9SXTsKICBpZiAoQ3RvciA9PT0gT2JqZWN0KQogICAgcmV0dXJuIHRydWU7CiAgaWYgKCFpc0Z1bmN0aW9uKEN0b3IpKQogICAgcmV0dXJuIGZhbHNlOwogIGxldCBjdG9yU3RyaW5nID0gY2FjaGVkQ3RvclN0cmluZ3MuZ2V0KEN0b3IpOwogIGlmIChjdG9yU3RyaW5nID09PSB2b2lkIDApIHsKICAgIGN0b3JTdHJpbmcgPSBGdW5jdGlvbi50b1N0cmluZy5jYWxsKEN0b3IpOwogICAgY2FjaGVkQ3RvclN0cmluZ3Muc2V0KEN0b3IsIGN0b3JTdHJpbmcpOwogIH0KICByZXR1cm4gY3RvclN0cmluZyA9PT0gb2JqZWN0Q3RvclN0cmluZzsKfQpmdW5jdGlvbiBlYWNoKG9iaiwgaXRlciwgc3RyaWN0ID0gdHJ1ZSkgewogIGlmIChnZXRBcmNodHlwZShvYmopID09PSAwKSB7CiAgICBjb25zdCBrZXlzID0gc3RyaWN0ID8gUmVmbGVjdC5vd25LZXlzKG9iaikgOiBPLmtleXMob2JqKTsKICAgIGtleXMuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICAgIGl0ZXIoa2V5LCBvYmpba2V5XSwgb2JqKTsKICAgIH0pOwogIH0gZWxzZSB7CiAgICBvYmouZm9yRWFjaCgoZW50cnksIGluZGV4KSA9PiBpdGVyKGluZGV4LCBlbnRyeSwgb2JqKSk7CiAgfQp9CmZ1bmN0aW9uIGdldEFyY2h0eXBlKHRoaW5nKSB7CiAgY29uc3Qgc3RhdGUgPSB0aGluZ1tEUkFGVF9TVEFURV07CiAgcmV0dXJuIHN0YXRlID8gc3RhdGUudHlwZV8gOiBpc0FycmF5KHRoaW5nKSA/IDEgOiBpc01hcCh0aGluZykgPyAyIDogaXNTZXQodGhpbmcpID8gMyA6IDA7Cn0KdmFyIGhhcyA9ICh0aGluZywgcHJvcCwgdHlwZSA9IGdldEFyY2h0eXBlKHRoaW5nKSkgPT4gdHlwZSA9PT0gMiA/IHRoaW5nLmhhcyhwcm9wKSA6IE9bUFJPVE9UWVBFXS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaW5nLCBwcm9wKTsKdmFyIGdldDIgPSAodGhpbmcsIHByb3AsIHR5cGUgPSBnZXRBcmNodHlwZSh0aGluZykpID0+ICgKICAvLyBAdHMtaWdub3JlCiAgdHlwZSA9PT0gMiA/IHRoaW5nLmdldChwcm9wKSA6IHRoaW5nW3Byb3BdCik7CnZhciBzZXQgPSAodGhpbmcsIHByb3BPck9sZFZhbHVlLCB2YWx1ZSwgdHlwZSA9IGdldEFyY2h0eXBlKHRoaW5nKSkgPT4gewogIGlmICh0eXBlID09PSAyKQogICAgdGhpbmcuc2V0KHByb3BPck9sZFZhbHVlLCB2YWx1ZSk7CiAgZWxzZSBpZiAodHlwZSA9PT0gMykgewogICAgdGhpbmcuYWRkKHZhbHVlKTsKICB9IGVsc2UKICAgIHRoaW5nW3Byb3BPck9sZFZhbHVlXSA9IHZhbHVlOwp9OwpmdW5jdGlvbiBpcyh4MiwgeTIpIHsKICBpZiAoeDIgPT09IHkyKSB7CiAgICByZXR1cm4geDIgIT09IDAgfHwgMSAvIHgyID09PSAxIC8geTI7CiAgfSBlbHNlIHsKICAgIHJldHVybiB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogIH0KfQp2YXIgaXNBcnJheSA9IEFycmF5LmlzQXJyYXk7CnZhciBpc01hcCA9ICh0YXJnZXQpID0+IHRhcmdldCBpbnN0YW5jZW9mIE1hcDsKdmFyIGlzU2V0ID0gKHRhcmdldCkgPT4gdGFyZ2V0IGluc3RhbmNlb2YgU2V0Owp2YXIgaXNPYmplY3Rpc2ggPSAodGFyZ2V0KSA9PiB0eXBlb2YgdGFyZ2V0ID09PSAib2JqZWN0IjsKdmFyIGlzRnVuY3Rpb24gPSAodGFyZ2V0KSA9PiB0eXBlb2YgdGFyZ2V0ID09PSAiZnVuY3Rpb24iOwp2YXIgaXNCb29sZWFuID0gKHRhcmdldCkgPT4gdHlwZW9mIHRhcmdldCA9PT0gImJvb2xlYW4iOwp2YXIgbGF0ZXN0ID0gKHN0YXRlKSA9PiBzdGF0ZS5jb3B5XyB8fCBzdGF0ZS5iYXNlXzsKdmFyIGdldEZpbmFsVmFsdWUgPSAoc3RhdGUpID0+IHN0YXRlLm1vZGlmaWVkXyA/IHN0YXRlLmNvcHlfIDogc3RhdGUuYmFzZV87CmZ1bmN0aW9uIHNoYWxsb3dDb3B5KGJhc2UsIHN0cmljdCkgewogIGlmIChpc01hcChiYXNlKSkgewogICAgcmV0dXJuIG5ldyBNYXAoYmFzZSk7CiAgfQogIGlmIChpc1NldChiYXNlKSkgewogICAgcmV0dXJuIG5ldyBTZXQoYmFzZSk7CiAgfQogIGlmIChpc0FycmF5KGJhc2UpKQogICAgcmV0dXJuIEFycmF5W1BST1RPVFlQRV0uc2xpY2UuY2FsbChiYXNlKTsKICBjb25zdCBpc1BsYWluMiA9IGlzUGxhaW5PYmplY3QyKGJhc2UpOwogIGlmIChzdHJpY3QgPT09IHRydWUgfHwgc3RyaWN0ID09PSAiY2xhc3Nfb25seSIgJiYgIWlzUGxhaW4yKSB7CiAgICBjb25zdCBkZXNjcmlwdG9ycyA9IE8uZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhiYXNlKTsKICAgIGRlbGV0ZSBkZXNjcmlwdG9yc1tEUkFGVF9TVEFURV07CiAgICBsZXQga2V5cyA9IFJlZmxlY3Qub3duS2V5cyhkZXNjcmlwdG9ycyk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qga2V5ID0ga2V5c1tpXTsKICAgICAgY29uc3QgZGVzYyA9IGRlc2NyaXB0b3JzW2tleV07CiAgICAgIGlmIChkZXNjW1dSSVRBQkxFXSA9PT0gZmFsc2UpIHsKICAgICAgICBkZXNjW1dSSVRBQkxFXSA9IHRydWU7CiAgICAgICAgZGVzY1tDT05GSUdVUkFCTEVdID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoZGVzYy5nZXQgfHwgZGVzYy5zZXQpCiAgICAgICAgZGVzY3JpcHRvcnNba2V5XSA9IHsKICAgICAgICAgIFtDT05GSUdVUkFCTEVdOiB0cnVlLAogICAgICAgICAgW1dSSVRBQkxFXTogdHJ1ZSwKICAgICAgICAgIC8vIGNvdWxkIGxpdmUgd2l0aCAhIWRlc2Muc2V0IGFzIHdlbGwgaGVyZS4uLgogICAgICAgICAgW0VOVU1FUkFCTEVdOiBkZXNjW0VOVU1FUkFCTEVdLAogICAgICAgICAgW1ZBTFVFXTogYmFzZVtrZXldCiAgICAgICAgfTsKICAgIH0KICAgIHJldHVybiBPLmNyZWF0ZShnZXRQcm90b3R5cGVPZihiYXNlKSwgZGVzY3JpcHRvcnMpOwogIH0gZWxzZSB7CiAgICBjb25zdCBwcm90bzIgPSBnZXRQcm90b3R5cGVPZihiYXNlKTsKICAgIGlmIChwcm90bzIgIT09IG51bGwgJiYgaXNQbGFpbjIpIHsKICAgICAgcmV0dXJuIHsgLi4uYmFzZSB9OwogICAgfQogICAgY29uc3Qgb2JqID0gTy5jcmVhdGUocHJvdG8yKTsKICAgIHJldHVybiBPLmFzc2lnbihvYmosIGJhc2UpOwogIH0KfQpmdW5jdGlvbiBmcmVlemUob2JqLCBkZWVwID0gZmFsc2UpIHsKICBpZiAoaXNGcm96ZW4ob2JqKSB8fCBpc0RyYWZ0KG9iaikgfHwgIWlzRHJhZnRhYmxlKG9iaikpCiAgICByZXR1cm4gb2JqOwogIGlmIChnZXRBcmNodHlwZShvYmopID4gMSkgewogICAgTy5kZWZpbmVQcm9wZXJ0aWVzKG9iaiwgewogICAgICBzZXQ6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZSwKICAgICAgYWRkOiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUsCiAgICAgIGNsZWFyOiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUsCiAgICAgIGRlbGV0ZTogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlCiAgICB9KTsKICB9CiAgTy5mcmVlemUob2JqKTsKICBpZiAoZGVlcCkKICAgIGVhY2goCiAgICAgIG9iaiwKICAgICAgKF9rZXksIHZhbHVlKSA9PiB7CiAgICAgICAgZnJlZXplKHZhbHVlLCB0cnVlKTsKICAgICAgfSwKICAgICAgZmFsc2UKICAgICk7CiAgcmV0dXJuIG9iajsKfQpmdW5jdGlvbiBkb250TXV0YXRlRnJvemVuQ29sbGVjdGlvbnMoKSB7CiAgZGllKDIpOwp9CnZhciBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUgPSB7CiAgW1ZBTFVFXTogZG9udE11dGF0ZUZyb3plbkNvbGxlY3Rpb25zCn07CmZ1bmN0aW9uIGlzRnJvemVuKG9iaikgewogIGlmIChvYmogPT09IG51bGwgfHwgIWlzT2JqZWN0aXNoKG9iaikpCiAgICByZXR1cm4gdHJ1ZTsKICByZXR1cm4gTy5pc0Zyb3plbihvYmopOwp9CnZhciBQbHVnaW5NYXBTZXQgPSAiTWFwU2V0IjsKdmFyIFBsdWdpblBhdGNoZXMgPSAiUGF0Y2hlcyI7CnZhciBwbHVnaW5zID0ge307CmZ1bmN0aW9uIGdldFBsdWdpbihwbHVnaW5LZXkpIHsKICBjb25zdCBwbHVnaW4gPSBwbHVnaW5zW3BsdWdpbktleV07CiAgaWYgKCFwbHVnaW4pIHsKICAgIGRpZSgwLCBwbHVnaW5LZXkpOwogIH0KICByZXR1cm4gcGx1Z2luOwp9CnZhciBpc1BsdWdpbkxvYWRlZCA9IChwbHVnaW5LZXkpID0+ICEhcGx1Z2luc1twbHVnaW5LZXldOwp2YXIgY3VycmVudFNjb3BlOwp2YXIgZ2V0Q3VycmVudFNjb3BlID0gKCkgPT4gY3VycmVudFNjb3BlOwp2YXIgY3JlYXRlU2NvcGUgPSAocGFyZW50XywgaW1tZXJfKSA9PiAoewogIGRyYWZ0c186IFtdLAogIHBhcmVudF8sCiAgaW1tZXJfLAogIC8vIFdoZW5ldmVyIHRoZSBtb2RpZmllZCBkcmFmdCBjb250YWlucyBhIGRyYWZ0IGZyb20gYW5vdGhlciBzY29wZSwgd2UKICAvLyBuZWVkIHRvIHByZXZlbnQgYXV0by1mcmVlemluZyBzbyB0aGUgdW5vd25lZCBkcmFmdCBjYW4gYmUgZmluYWxpemVkLgogIGNhbkF1dG9GcmVlemVfOiB0cnVlLAogIHVuZmluYWxpemVkRHJhZnRzXzogMCwKICBoYW5kbGVkU2V0XzogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSwKICBwcm9jZXNzZWRGb3JQYXRjaGVzXzogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSwKICBtYXBTZXRQbHVnaW5fOiBpc1BsdWdpbkxvYWRlZChQbHVnaW5NYXBTZXQpID8gZ2V0UGx1Z2luKFBsdWdpbk1hcFNldCkgOiB2b2lkIDAKfSk7CmZ1bmN0aW9uIHVzZVBhdGNoZXNJblNjb3BlKHNjb3BlLCBwYXRjaExpc3RlbmVyKSB7CiAgaWYgKHBhdGNoTGlzdGVuZXIpIHsKICAgIHNjb3BlLnBhdGNoUGx1Z2luXyA9IGdldFBsdWdpbihQbHVnaW5QYXRjaGVzKTsKICAgIHNjb3BlLnBhdGNoZXNfID0gW107CiAgICBzY29wZS5pbnZlcnNlUGF0Y2hlc18gPSBbXTsKICAgIHNjb3BlLnBhdGNoTGlzdGVuZXJfID0gcGF0Y2hMaXN0ZW5lcjsKICB9Cn0KZnVuY3Rpb24gcmV2b2tlU2NvcGUoc2NvcGUpIHsKICBsZWF2ZVNjb3BlKHNjb3BlKTsKICBzY29wZS5kcmFmdHNfLmZvckVhY2gocmV2b2tlRHJhZnQpOwogIHNjb3BlLmRyYWZ0c18gPSBudWxsOwp9CmZ1bmN0aW9uIGxlYXZlU2NvcGUoc2NvcGUpIHsKICBpZiAoc2NvcGUgPT09IGN1cnJlbnRTY29wZSkgewogICAgY3VycmVudFNjb3BlID0gc2NvcGUucGFyZW50XzsKICB9Cn0KdmFyIGVudGVyU2NvcGUgPSAoaW1tZXIyMikgPT4gY3VycmVudFNjb3BlID0gY3JlYXRlU2NvcGUoY3VycmVudFNjb3BlLCBpbW1lcjIyKTsKZnVuY3Rpb24gcmV2b2tlRHJhZnQoZHJhZnQpIHsKICBjb25zdCBzdGF0ZSA9IGRyYWZ0W0RSQUZUX1NUQVRFXTsKICBpZiAoc3RhdGUudHlwZV8gPT09IDAgfHwgc3RhdGUudHlwZV8gPT09IDEpCiAgICBzdGF0ZS5yZXZva2VfKCk7CiAgZWxzZQogICAgc3RhdGUucmV2b2tlZF8gPSB0cnVlOwp9CmZ1bmN0aW9uIHByb2Nlc3NSZXN1bHQocmVzdWx0LCBzY29wZSkgewogIHNjb3BlLnVuZmluYWxpemVkRHJhZnRzXyA9IHNjb3BlLmRyYWZ0c18ubGVuZ3RoOwogIGNvbnN0IGJhc2VEcmFmdCA9IHNjb3BlLmRyYWZ0c19bMF07CiAgY29uc3QgaXNSZXBsYWNlZCA9IHJlc3VsdCAhPT0gdm9pZCAwICYmIHJlc3VsdCAhPT0gYmFzZURyYWZ0OwogIGlmIChpc1JlcGxhY2VkKSB7CiAgICBpZiAoYmFzZURyYWZ0W0RSQUZUX1NUQVRFXS5tb2RpZmllZF8pIHsKICAgICAgcmV2b2tlU2NvcGUoc2NvcGUpOwogICAgICBkaWUoNCk7CiAgICB9CiAgICBpZiAoaXNEcmFmdGFibGUocmVzdWx0KSkgewogICAgICByZXN1bHQgPSBmaW5hbGl6ZShzY29wZSwgcmVzdWx0KTsKICAgIH0KICAgIGNvbnN0IHsgcGF0Y2hQbHVnaW5fIH0gPSBzY29wZTsKICAgIGlmIChwYXRjaFBsdWdpbl8pIHsKICAgICAgcGF0Y2hQbHVnaW5fLmdlbmVyYXRlUmVwbGFjZW1lbnRQYXRjaGVzXygKICAgICAgICBiYXNlRHJhZnRbRFJBRlRfU1RBVEVdLmJhc2VfLAogICAgICAgIHJlc3VsdCwKICAgICAgICBzY29wZQogICAgICApOwogICAgfQogIH0gZWxzZSB7CiAgICByZXN1bHQgPSBmaW5hbGl6ZShzY29wZSwgYmFzZURyYWZ0KTsKICB9CiAgbWF5YmVGcmVlemUoc2NvcGUsIHJlc3VsdCwgdHJ1ZSk7CiAgcmV2b2tlU2NvcGUoc2NvcGUpOwogIGlmIChzY29wZS5wYXRjaGVzXykgewogICAgc2NvcGUucGF0Y2hMaXN0ZW5lcl8oc2NvcGUucGF0Y2hlc18sIHNjb3BlLmludmVyc2VQYXRjaGVzXyk7CiAgfQogIHJldHVybiByZXN1bHQgIT09IE5PVEhJTkcgPyByZXN1bHQgOiB2b2lkIDA7Cn0KZnVuY3Rpb24gZmluYWxpemUocm9vdFNjb3BlLCB2YWx1ZSkgewogIGlmIChpc0Zyb3plbih2YWx1ZSkpCiAgICByZXR1cm4gdmFsdWU7CiAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURV07CiAgaWYgKCFzdGF0ZSkgewogICAgY29uc3QgZmluYWxWYWx1ZSA9IGhhbmRsZVZhbHVlKHZhbHVlLCByb290U2NvcGUuaGFuZGxlZFNldF8sIHJvb3RTY29wZSk7CiAgICByZXR1cm4gZmluYWxWYWx1ZTsKICB9CiAgaWYgKCFpc1NhbWVTY29wZShzdGF0ZSwgcm9vdFNjb3BlKSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgcmV0dXJuIHN0YXRlLmJhc2VfOwogIH0KICBpZiAoIXN0YXRlLmZpbmFsaXplZF8pIHsKICAgIGNvbnN0IHsgY2FsbGJhY2tzXyB9ID0gc3RhdGU7CiAgICBpZiAoY2FsbGJhY2tzXykgewogICAgICB3aGlsZSAoY2FsbGJhY2tzXy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3QgY2FsbGJhY2sgPSBjYWxsYmFja3NfLnBvcCgpOwogICAgICAgIGNhbGxiYWNrKHJvb3RTY29wZSk7CiAgICAgIH0KICAgIH0KICAgIGdlbmVyYXRlUGF0Y2hlc0FuZEZpbmFsaXplKHN0YXRlLCByb290U2NvcGUpOwogIH0KICByZXR1cm4gc3RhdGUuY29weV87Cn0KZnVuY3Rpb24gbWF5YmVGcmVlemUoc2NvcGUsIHZhbHVlLCBkZWVwID0gZmFsc2UpIHsKICBpZiAoIXNjb3BlLnBhcmVudF8gJiYgc2NvcGUuaW1tZXJfLmF1dG9GcmVlemVfICYmIHNjb3BlLmNhbkF1dG9GcmVlemVfKSB7CiAgICBmcmVlemUodmFsdWUsIGRlZXApOwogIH0KfQpmdW5jdGlvbiBtYXJrU3RhdGVGaW5hbGl6ZWQoc3RhdGUpIHsKICBzdGF0ZS5maW5hbGl6ZWRfID0gdHJ1ZTsKICBzdGF0ZS5zY29wZV8udW5maW5hbGl6ZWREcmFmdHNfLS07Cn0KdmFyIGlzU2FtZVNjb3BlID0gKHN0YXRlLCByb290U2NvcGUpID0+IHN0YXRlLnNjb3BlXyA9PT0gcm9vdFNjb3BlOwp2YXIgRU1QVFlfTE9DQVRJT05TX1JFU1VMVCA9IFtdOwpmdW5jdGlvbiB1cGRhdGVEcmFmdEluUGFyZW50KHBhcmVudCwgZHJhZnRWYWx1ZSwgZmluYWxpemVkVmFsdWUsIG9yaWdpbmFsS2V5KSB7CiAgY29uc3QgcGFyZW50Q29weSA9IGxhdGVzdChwYXJlbnQpOwogIGNvbnN0IHBhcmVudFR5cGUgPSBwYXJlbnQudHlwZV87CiAgaWYgKG9yaWdpbmFsS2V5ICE9PSB2b2lkIDApIHsKICAgIGNvbnN0IGN1cnJlbnRWYWx1ZSA9IGdldDIocGFyZW50Q29weSwgb3JpZ2luYWxLZXksIHBhcmVudFR5cGUpOwogICAgaWYgKGN1cnJlbnRWYWx1ZSA9PT0gZHJhZnRWYWx1ZSkgewogICAgICBzZXQocGFyZW50Q29weSwgb3JpZ2luYWxLZXksIGZpbmFsaXplZFZhbHVlLCBwYXJlbnRUeXBlKTsKICAgICAgcmV0dXJuOwogICAgfQogIH0KICBpZiAoIXBhcmVudC5kcmFmdExvY2F0aW9uc18pIHsKICAgIGNvbnN0IGRyYWZ0TG9jYXRpb25zID0gcGFyZW50LmRyYWZ0TG9jYXRpb25zXyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBlYWNoKHBhcmVudENvcHksIChrZXksIHZhbHVlKSA9PiB7CiAgICAgIGlmIChpc0RyYWZ0KHZhbHVlKSkgewogICAgICAgIGNvbnN0IGtleXMgPSBkcmFmdExvY2F0aW9ucy5nZXQodmFsdWUpIHx8IFtdOwogICAgICAgIGtleXMucHVzaChrZXkpOwogICAgICAgIGRyYWZ0TG9jYXRpb25zLnNldCh2YWx1ZSwga2V5cyk7CiAgICAgIH0KICAgIH0pOwogIH0KICBjb25zdCBsb2NhdGlvbnMgPSBwYXJlbnQuZHJhZnRMb2NhdGlvbnNfLmdldChkcmFmdFZhbHVlKSA/PyBFTVBUWV9MT0NBVElPTlNfUkVTVUxUOwogIGZvciAoY29uc3QgbG9jYXRpb24gb2YgbG9jYXRpb25zKSB7CiAgICBzZXQocGFyZW50Q29weSwgbG9jYXRpb24sIGZpbmFsaXplZFZhbHVlLCBwYXJlbnRUeXBlKTsKICB9Cn0KZnVuY3Rpb24gcmVnaXN0ZXJDaGlsZEZpbmFsaXphdGlvbkNhbGxiYWNrKHBhcmVudCwgY2hpbGQsIGtleSkgewogIHBhcmVudC5jYWxsYmFja3NfLnB1c2goZnVuY3Rpb24gY2hpbGRDbGVhbnVwKHJvb3RTY29wZSkgewogICAgY29uc3Qgc3RhdGUgPSBjaGlsZDsKICAgIGlmICghc3RhdGUgfHwgIWlzU2FtZVNjb3BlKHN0YXRlLCByb290U2NvcGUpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHJvb3RTY29wZS5tYXBTZXRQbHVnaW5fPy5maXhTZXRDb250ZW50cyhzdGF0ZSk7CiAgICBjb25zdCBmaW5hbGl6ZWRWYWx1ZSA9IGdldEZpbmFsVmFsdWUoc3RhdGUpOwogICAgdXBkYXRlRHJhZnRJblBhcmVudChwYXJlbnQsIHN0YXRlLmRyYWZ0XyA/PyBzdGF0ZSwgZmluYWxpemVkVmFsdWUsIGtleSk7CiAgICBnZW5lcmF0ZVBhdGNoZXNBbmRGaW5hbGl6ZShzdGF0ZSwgcm9vdFNjb3BlKTsKICB9KTsKfQpmdW5jdGlvbiBnZW5lcmF0ZVBhdGNoZXNBbmRGaW5hbGl6ZShzdGF0ZSwgcm9vdFNjb3BlKSB7CiAgY29uc3Qgc2hvdWxkRmluYWxpemUgPSBzdGF0ZS5tb2RpZmllZF8gJiYgIXN0YXRlLmZpbmFsaXplZF8gJiYgKHN0YXRlLnR5cGVfID09PSAzIHx8IChzdGF0ZS5hc3NpZ25lZF8/LnNpemUgPz8gMCkgPiAwKTsKICBpZiAoc2hvdWxkRmluYWxpemUpIHsKICAgIGNvbnN0IHsgcGF0Y2hQbHVnaW5fIH0gPSByb290U2NvcGU7CiAgICBpZiAocGF0Y2hQbHVnaW5fKSB7CiAgICAgIGNvbnN0IGJhc2VQYXRoID0gcGF0Y2hQbHVnaW5fLmdldFBhdGgoc3RhdGUpOwogICAgICBpZiAoYmFzZVBhdGgpIHsKICAgICAgICBwYXRjaFBsdWdpbl8uZ2VuZXJhdGVQYXRjaGVzXyhzdGF0ZSwgYmFzZVBhdGgsIHJvb3RTY29wZSk7CiAgICAgIH0KICAgIH0KICAgIG1hcmtTdGF0ZUZpbmFsaXplZChzdGF0ZSk7CiAgfQp9CmZ1bmN0aW9uIGhhbmRsZUNyb3NzUmVmZXJlbmNlKHRhcmdldCwga2V5LCB2YWx1ZSkgewogIGNvbnN0IHsgc2NvcGVfIH0gPSB0YXJnZXQ7CiAgaWYgKGlzRHJhZnQodmFsdWUpKSB7CiAgICBjb25zdCBzdGF0ZSA9IHZhbHVlW0RSQUZUX1NUQVRFXTsKICAgIGlmIChpc1NhbWVTY29wZShzdGF0ZSwgc2NvcGVfKSkgewogICAgICBzdGF0ZS5jYWxsYmFja3NfLnB1c2goZnVuY3Rpb24gY3Jvc3NSZWZlcmVuY2VDbGVhbnVwKCkgewogICAgICAgIHByZXBhcmVDb3B5KHRhcmdldCk7CiAgICAgICAgY29uc3QgZmluYWxpemVkVmFsdWUgPSBnZXRGaW5hbFZhbHVlKHN0YXRlKTsKICAgICAgICB1cGRhdGVEcmFmdEluUGFyZW50KHRhcmdldCwgdmFsdWUsIGZpbmFsaXplZFZhbHVlLCBrZXkpOwogICAgICB9KTsKICAgIH0KICB9IGVsc2UgaWYgKGlzRHJhZnRhYmxlKHZhbHVlKSkgewogICAgdGFyZ2V0LmNhbGxiYWNrc18ucHVzaChmdW5jdGlvbiBuZXN0ZWREcmFmdENsZWFudXAoKSB7CiAgICAgIGNvbnN0IHRhcmdldENvcHkgPSBsYXRlc3QodGFyZ2V0KTsKICAgICAgaWYgKGdldDIodGFyZ2V0Q29weSwga2V5LCB0YXJnZXQudHlwZV8pID09PSB2YWx1ZSkgewogICAgICAgIGlmIChzY29wZV8uZHJhZnRzXy5sZW5ndGggPiAxICYmICh0YXJnZXQuYXNzaWduZWRfLmdldChrZXkpID8/IGZhbHNlKSA9PT0gdHJ1ZSAmJiB0YXJnZXQuY29weV8pIHsKICAgICAgICAgIGhhbmRsZVZhbHVlKAogICAgICAgICAgICBnZXQyKHRhcmdldC5jb3B5Xywga2V5LCB0YXJnZXQudHlwZV8pLAogICAgICAgICAgICBzY29wZV8uaGFuZGxlZFNldF8sCiAgICAgICAgICAgIHNjb3BlXwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KfQpmdW5jdGlvbiBoYW5kbGVWYWx1ZSh0YXJnZXQsIGhhbmRsZWRTZXQsIHJvb3RTY29wZSkgewogIGlmICghcm9vdFNjb3BlLmltbWVyXy5hdXRvRnJlZXplXyAmJiByb290U2NvcGUudW5maW5hbGl6ZWREcmFmdHNfIDwgMSkgewogICAgcmV0dXJuIHRhcmdldDsKICB9CiAgaWYgKGlzRHJhZnQodGFyZ2V0KSB8fCBoYW5kbGVkU2V0Lmhhcyh0YXJnZXQpIHx8ICFpc0RyYWZ0YWJsZSh0YXJnZXQpIHx8IGlzRnJvemVuKHRhcmdldCkpIHsKICAgIHJldHVybiB0YXJnZXQ7CiAgfQogIGhhbmRsZWRTZXQuYWRkKHRhcmdldCk7CiAgZWFjaCh0YXJnZXQsIChrZXksIHZhbHVlKSA9PiB7CiAgICBpZiAoaXNEcmFmdCh2YWx1ZSkpIHsKICAgICAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURV07CiAgICAgIGlmIChpc1NhbWVTY29wZShzdGF0ZSwgcm9vdFNjb3BlKSkgewogICAgICAgIGNvbnN0IHVwZGF0ZWRWYWx1ZSA9IGdldEZpbmFsVmFsdWUoc3RhdGUpOwogICAgICAgIHNldCh0YXJnZXQsIGtleSwgdXBkYXRlZFZhbHVlLCB0YXJnZXQudHlwZV8pOwogICAgICAgIG1hcmtTdGF0ZUZpbmFsaXplZChzdGF0ZSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNEcmFmdGFibGUodmFsdWUpKSB7CiAgICAgIGhhbmRsZVZhbHVlKHZhbHVlLCBoYW5kbGVkU2V0LCByb290U2NvcGUpOwogICAgfQogIH0pOwogIHJldHVybiB0YXJnZXQ7Cn0KZnVuY3Rpb24gY3JlYXRlUHJveHlQcm94eShiYXNlLCBwYXJlbnQpIHsKICBjb25zdCBiYXNlSXNBcnJheSA9IGlzQXJyYXkoYmFzZSk7CiAgY29uc3Qgc3RhdGUgPSB7CiAgICB0eXBlXzogYmFzZUlzQXJyYXkgPyAxIDogMCwKICAgIC8vIFRyYWNrIHdoaWNoIHByb2R1Y2UgY2FsbCB0aGlzIGlzIGFzc29jaWF0ZWQgd2l0aC4KICAgIHNjb3BlXzogcGFyZW50ID8gcGFyZW50LnNjb3BlXyA6IGdldEN1cnJlbnRTY29wZSgpLAogICAgLy8gVHJ1ZSBmb3IgYm90aCBzaGFsbG93IGFuZCBkZWVwIGNoYW5nZXMuCiAgICBtb2RpZmllZF86IGZhbHNlLAogICAgLy8gVXNlZCBkdXJpbmcgZmluYWxpemF0aW9uLgogICAgZmluYWxpemVkXzogZmFsc2UsCiAgICAvLyBUcmFjayB3aGljaCBwcm9wZXJ0aWVzIGhhdmUgYmVlbiBhc3NpZ25lZCAodHJ1ZSkgb3IgZGVsZXRlZCAoZmFsc2UpLgogICAgLy8gYWN0dWFsbHkgaW5zdGFudGlhdGVkIGluIGBwcmVwYXJlQ29weSgpYAogICAgYXNzaWduZWRfOiB2b2lkIDAsCiAgICAvLyBUaGUgcGFyZW50IGRyYWZ0IHN0YXRlLgogICAgcGFyZW50XzogcGFyZW50LAogICAgLy8gVGhlIGJhc2Ugc3RhdGUuCiAgICBiYXNlXzogYmFzZSwKICAgIC8vIFRoZSBiYXNlIHByb3h5LgogICAgZHJhZnRfOiBudWxsLAogICAgLy8gc2V0IGJlbG93CiAgICAvLyBUaGUgYmFzZSBjb3B5IHdpdGggYW55IHVwZGF0ZWQgdmFsdWVzLgogICAgY29weV86IG51bGwsCiAgICAvLyBDYWxsZWQgYnkgdGhlIGBwcm9kdWNlYCBmdW5jdGlvbi4KICAgIHJldm9rZV86IG51bGwsCiAgICBpc01hbnVhbF86IGZhbHNlLAogICAgLy8gYGNhbGxiYWNrc2AgYWN0dWFsbHkgZ2V0cyBhc3NpZ25lZCBpbiBgY3JlYXRlUHJveHlgCiAgICBjYWxsYmFja3NfOiB2b2lkIDAKICB9OwogIGxldCB0YXJnZXQgPSBzdGF0ZTsKICBsZXQgdHJhcHMgPSBvYmplY3RUcmFwczsKICBpZiAoYmFzZUlzQXJyYXkpIHsKICAgIHRhcmdldCA9IFtzdGF0ZV07CiAgICB0cmFwcyA9IGFycmF5VHJhcHM7CiAgfQogIGNvbnN0IHsgcmV2b2tlLCBwcm94eSB9ID0gUHJveHkucmV2b2NhYmxlKHRhcmdldCwgdHJhcHMpOwogIHN0YXRlLmRyYWZ0XyA9IHByb3h5OwogIHN0YXRlLnJldm9rZV8gPSByZXZva2U7CiAgcmV0dXJuIFtwcm94eSwgc3RhdGVdOwp9CnZhciBvYmplY3RUcmFwcyA9IHsKICBnZXQoc3RhdGUsIHByb3ApIHsKICAgIGlmIChwcm9wID09PSBEUkFGVF9TVEFURSkKICAgICAgcmV0dXJuIHN0YXRlOwogICAgY29uc3Qgc291cmNlID0gbGF0ZXN0KHN0YXRlKTsKICAgIGlmICghaGFzKHNvdXJjZSwgcHJvcCwgc3RhdGUudHlwZV8pKSB7CiAgICAgIHJldHVybiByZWFkUHJvcEZyb21Qcm90byhzdGF0ZSwgc291cmNlLCBwcm9wKTsKICAgIH0KICAgIGNvbnN0IHZhbHVlID0gc291cmNlW3Byb3BdOwogICAgaWYgKHN0YXRlLmZpbmFsaXplZF8gfHwgIWlzRHJhZnRhYmxlKHZhbHVlKSkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBpZiAodmFsdWUgPT09IHBlZWsoc3RhdGUuYmFzZV8sIHByb3ApKSB7CiAgICAgIHByZXBhcmVDb3B5KHN0YXRlKTsKICAgICAgY29uc3QgY2hpbGRLZXkgPSBzdGF0ZS50eXBlXyA9PT0gMSA/ICtwcm9wIDogcHJvcDsKICAgICAgY29uc3QgY2hpbGREcmFmdCA9IGNyZWF0ZVByb3h5KHN0YXRlLnNjb3BlXywgdmFsdWUsIHN0YXRlLCBjaGlsZEtleSk7CiAgICAgIHJldHVybiBzdGF0ZS5jb3B5X1tjaGlsZEtleV0gPSBjaGlsZERyYWZ0OwogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0sCiAgaGFzKHN0YXRlLCBwcm9wKSB7CiAgICByZXR1cm4gcHJvcCBpbiBsYXRlc3Qoc3RhdGUpOwogIH0sCiAgb3duS2V5cyhzdGF0ZSkgewogICAgcmV0dXJuIFJlZmxlY3Qub3duS2V5cyhsYXRlc3Qoc3RhdGUpKTsKICB9LAogIHNldChzdGF0ZSwgcHJvcCwgdmFsdWUpIHsKICAgIGNvbnN0IGRlc2MgPSBnZXREZXNjcmlwdG9yRnJvbVByb3RvKGxhdGVzdChzdGF0ZSksIHByb3ApOwogICAgaWYgKGRlc2M/LnNldCkgewogICAgICBkZXNjLnNldC5jYWxsKHN0YXRlLmRyYWZ0XywgdmFsdWUpOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmICghc3RhdGUubW9kaWZpZWRfKSB7CiAgICAgIGNvbnN0IGN1cnJlbnQyMiA9IHBlZWsobGF0ZXN0KHN0YXRlKSwgcHJvcCk7CiAgICAgIGNvbnN0IGN1cnJlbnRTdGF0ZSA9IGN1cnJlbnQyMj8uW0RSQUZUX1NUQVRFXTsKICAgICAgaWYgKGN1cnJlbnRTdGF0ZSAmJiBjdXJyZW50U3RhdGUuYmFzZV8gPT09IHZhbHVlKSB7CiAgICAgICAgc3RhdGUuY29weV9bcHJvcF0gPSB2YWx1ZTsKICAgICAgICBzdGF0ZS5hc3NpZ25lZF8uc2V0KHByb3AsIGZhbHNlKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoaXModmFsdWUsIGN1cnJlbnQyMikgJiYgKHZhbHVlICE9PSB2b2lkIDAgfHwgaGFzKHN0YXRlLmJhc2VfLCBwcm9wLCBzdGF0ZS50eXBlXykpKQogICAgICAgIHJldHVybiB0cnVlOwogICAgICBwcmVwYXJlQ29weShzdGF0ZSk7CiAgICAgIG1hcmtDaGFuZ2VkKHN0YXRlKTsKICAgIH0KICAgIGlmIChzdGF0ZS5jb3B5X1twcm9wXSA9PT0gdmFsdWUgJiYgLy8gc3BlY2lhbCBjYXNlOiBoYW5kbGUgbmV3IHByb3BzIHdpdGggdmFsdWUgJ3VuZGVmaW5lZCcKICAgICh2YWx1ZSAhPT0gdm9pZCAwIHx8IHByb3AgaW4gc3RhdGUuY29weV8pIHx8IC8vIHNwZWNpYWwgY2FzZTogTmFOCiAgICBOdW1iZXIuaXNOYU4odmFsdWUpICYmIE51bWJlci5pc05hTihzdGF0ZS5jb3B5X1twcm9wXSkpCiAgICAgIHJldHVybiB0cnVlOwogICAgc3RhdGUuY29weV9bcHJvcF0gPSB2YWx1ZTsKICAgIHN0YXRlLmFzc2lnbmVkXy5zZXQocHJvcCwgdHJ1ZSk7CiAgICBoYW5kbGVDcm9zc1JlZmVyZW5jZShzdGF0ZSwgcHJvcCwgdmFsdWUpOwogICAgcmV0dXJuIHRydWU7CiAgfSwKICBkZWxldGVQcm9wZXJ0eShzdGF0ZSwgcHJvcCkgewogICAgcHJlcGFyZUNvcHkoc3RhdGUpOwogICAgaWYgKHBlZWsoc3RhdGUuYmFzZV8sIHByb3ApICE9PSB2b2lkIDAgfHwgcHJvcCBpbiBzdGF0ZS5iYXNlXykgewogICAgICBzdGF0ZS5hc3NpZ25lZF8uc2V0KHByb3AsIGZhbHNlKTsKICAgICAgbWFya0NoYW5nZWQoc3RhdGUpOwogICAgfSBlbHNlIHsKICAgICAgc3RhdGUuYXNzaWduZWRfLmRlbGV0ZShwcm9wKTsKICAgIH0KICAgIGlmIChzdGF0ZS5jb3B5XykgewogICAgICBkZWxldGUgc3RhdGUuY29weV9bcHJvcF07CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9LAogIC8vIE5vdGU6IFdlIG5ldmVyIGNvZXJjZSBgZGVzYy52YWx1ZWAgaW50byBhbiBJbW1lciBkcmFmdCwgYmVjYXVzZSB3ZSBjYW4ndCBtYWtlCiAgLy8gdGhlIHNhbWUgZ3VhcmFudGVlIGluIEVTNSBtb2RlLgogIGdldE93blByb3BlcnR5RGVzY3JpcHRvcihzdGF0ZSwgcHJvcCkgewogICAgY29uc3Qgb3duZXIgPSBsYXRlc3Qoc3RhdGUpOwogICAgY29uc3QgZGVzYyA9IFJlZmxlY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG93bmVyLCBwcm9wKTsKICAgIGlmICghZGVzYykKICAgICAgcmV0dXJuIGRlc2M7CiAgICByZXR1cm4gewogICAgICBbV1JJVEFCTEVdOiB0cnVlLAogICAgICBbQ09ORklHVVJBQkxFXTogc3RhdGUudHlwZV8gIT09IDEgfHwgcHJvcCAhPT0gImxlbmd0aCIsCiAgICAgIFtFTlVNRVJBQkxFXTogZGVzY1tFTlVNRVJBQkxFXSwKICAgICAgW1ZBTFVFXTogb3duZXJbcHJvcF0KICAgIH07CiAgfSwKICBkZWZpbmVQcm9wZXJ0eSgpIHsKICAgIGRpZSgxMSk7CiAgfSwKICBnZXRQcm90b3R5cGVPZihzdGF0ZSkgewogICAgcmV0dXJuIGdldFByb3RvdHlwZU9mKHN0YXRlLmJhc2VfKTsKICB9LAogIHNldFByb3RvdHlwZU9mKCkgewogICAgZGllKDEyKTsKICB9Cn07CnZhciBhcnJheVRyYXBzID0ge307CmVhY2gob2JqZWN0VHJhcHMsIChrZXksIGZuKSA9PiB7CiAgYXJyYXlUcmFwc1trZXldID0gZnVuY3Rpb24oKSB7CiAgICBjb25zdCBhcmdzID0gYXJndW1lbnRzOwogICAgYXJnc1swXSA9IGFyZ3NbMF1bMF07CiAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJncyk7CiAgfTsKfSk7CmFycmF5VHJhcHMuZGVsZXRlUHJvcGVydHkgPSBmdW5jdGlvbihzdGF0ZSwgcHJvcCkgewogIGlmIChpc05hTihwYXJzZUludChwcm9wKSkpCiAgICBkaWUoMTMpOwogIHJldHVybiBhcnJheVRyYXBzLnNldC5jYWxsKHRoaXMsIHN0YXRlLCBwcm9wLCB2b2lkIDApOwp9OwphcnJheVRyYXBzLnNldCA9IGZ1bmN0aW9uKHN0YXRlLCBwcm9wLCB2YWx1ZSkgewogIGlmIChwcm9wICE9PSAibGVuZ3RoIiAmJiBpc05hTihwYXJzZUludChwcm9wKSkpCiAgICBkaWUoMTQpOwogIHJldHVybiBvYmplY3RUcmFwcy5zZXQuY2FsbCh0aGlzLCBzdGF0ZVswXSwgcHJvcCwgdmFsdWUsIHN0YXRlWzBdKTsKfTsKZnVuY3Rpb24gcGVlayhkcmFmdCwgcHJvcCkgewogIGNvbnN0IHN0YXRlID0gZHJhZnRbRFJBRlRfU1RBVEVdOwogIGNvbnN0IHNvdXJjZSA9IHN0YXRlID8gbGF0ZXN0KHN0YXRlKSA6IGRyYWZ0OwogIHJldHVybiBzb3VyY2VbcHJvcF07Cn0KZnVuY3Rpb24gcmVhZFByb3BGcm9tUHJvdG8oc3RhdGUsIHNvdXJjZSwgcHJvcCkgewogIGNvbnN0IGRlc2MgPSBnZXREZXNjcmlwdG9yRnJvbVByb3RvKHNvdXJjZSwgcHJvcCk7CiAgcmV0dXJuIGRlc2MgPyBWQUxVRSBpbiBkZXNjID8gZGVzY1tWQUxVRV0gOiAoCiAgICAvLyBUaGlzIGlzIGEgdmVyeSBzcGVjaWFsIGNhc2UsIGlmIHRoZSBwcm9wIGlzIGEgZ2V0dGVyIGRlZmluZWQgYnkgdGhlCiAgICAvLyBwcm90b3R5cGUsIHdlIHNob3VsZCBpbnZva2UgaXQgd2l0aCB0aGUgZHJhZnQgYXMgY29udGV4dCEKICAgIGRlc2MuZ2V0Py5jYWxsKHN0YXRlLmRyYWZ0XykKICApIDogdm9pZCAwOwp9CmZ1bmN0aW9uIGdldERlc2NyaXB0b3JGcm9tUHJvdG8oc291cmNlLCBwcm9wKSB7CiAgaWYgKCEocHJvcCBpbiBzb3VyY2UpKQogICAgcmV0dXJuIHZvaWQgMDsKICBsZXQgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2Yoc291cmNlKTsKICB3aGlsZSAocHJvdG8yKSB7CiAgICBjb25zdCBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwcm90bzIsIHByb3ApOwogICAgaWYgKGRlc2MpCiAgICAgIHJldHVybiBkZXNjOwogICAgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2YocHJvdG8yKTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQpmdW5jdGlvbiBtYXJrQ2hhbmdlZChzdGF0ZSkgewogIGlmICghc3RhdGUubW9kaWZpZWRfKSB7CiAgICBzdGF0ZS5tb2RpZmllZF8gPSB0cnVlOwogICAgaWYgKHN0YXRlLnBhcmVudF8pIHsKICAgICAgbWFya0NoYW5nZWQoc3RhdGUucGFyZW50Xyk7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIHByZXBhcmVDb3B5KHN0YXRlKSB7CiAgaWYgKCFzdGF0ZS5jb3B5XykgewogICAgc3RhdGUuYXNzaWduZWRfID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIHN0YXRlLmNvcHlfID0gc2hhbGxvd0NvcHkoCiAgICAgIHN0YXRlLmJhc2VfLAogICAgICBzdGF0ZS5zY29wZV8uaW1tZXJfLnVzZVN0cmljdFNoYWxsb3dDb3B5XwogICAgKTsKICB9Cn0KdmFyIEltbWVyMiA9IGNsYXNzIHsKICBjb25zdHJ1Y3Rvcihjb25maWcpIHsKICAgIHRoaXMuYXV0b0ZyZWV6ZV8gPSB0cnVlOwogICAgdGhpcy51c2VTdHJpY3RTaGFsbG93Q29weV8gPSBmYWxzZTsKICAgIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXyA9IGZhbHNlOwogICAgdGhpcy5wcm9kdWNlID0gKGJhc2UsIHJlY2lwZSwgcGF0Y2hMaXN0ZW5lcikgPT4gewogICAgICBpZiAoaXNGdW5jdGlvbihiYXNlKSAmJiAhaXNGdW5jdGlvbihyZWNpcGUpKSB7CiAgICAgICAgY29uc3QgZGVmYXVsdEJhc2UgPSByZWNpcGU7CiAgICAgICAgcmVjaXBlID0gYmFzZTsKICAgICAgICBjb25zdCBzZWxmMiA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIGN1cnJpZWRQcm9kdWNlKGJhc2UyID0gZGVmYXVsdEJhc2UsIC4uLmFyZ3MpIHsKICAgICAgICAgIHJldHVybiBzZWxmMi5wcm9kdWNlKGJhc2UyLCAoZHJhZnQpID0+IHJlY2lwZS5jYWxsKHRoaXMsIGRyYWZ0LCAuLi5hcmdzKSk7CiAgICAgICAgfTsKICAgICAgfQogICAgICBpZiAoIWlzRnVuY3Rpb24ocmVjaXBlKSkKICAgICAgICBkaWUoNik7CiAgICAgIGlmIChwYXRjaExpc3RlbmVyICE9PSB2b2lkIDAgJiYgIWlzRnVuY3Rpb24ocGF0Y2hMaXN0ZW5lcikpCiAgICAgICAgZGllKDcpOwogICAgICBsZXQgcmVzdWx0OwogICAgICBpZiAoaXNEcmFmdGFibGUoYmFzZSkpIHsKICAgICAgICBjb25zdCBzY29wZSA9IGVudGVyU2NvcGUodGhpcyk7CiAgICAgICAgY29uc3QgcHJveHkgPSBjcmVhdGVQcm94eShzY29wZSwgYmFzZSwgdm9pZCAwKTsKICAgICAgICBsZXQgaGFzRXJyb3IgPSB0cnVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXN1bHQgPSByZWNpcGUocHJveHkpOwogICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaWYgKGhhc0Vycm9yKQogICAgICAgICAgICByZXZva2VTY29wZShzY29wZSk7CiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIGxlYXZlU2NvcGUoc2NvcGUpOwogICAgICAgIH0KICAgICAgICB1c2VQYXRjaGVzSW5TY29wZShzY29wZSwgcGF0Y2hMaXN0ZW5lcik7CiAgICAgICAgcmV0dXJuIHByb2Nlc3NSZXN1bHQocmVzdWx0LCBzY29wZSk7CiAgICAgIH0gZWxzZSBpZiAoIWJhc2UgfHwgIWlzT2JqZWN0aXNoKGJhc2UpKSB7CiAgICAgICAgcmVzdWx0ID0gcmVjaXBlKGJhc2UpOwogICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkKICAgICAgICAgIHJlc3VsdCA9IGJhc2U7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gTk9USElORykKICAgICAgICAgIHJlc3VsdCA9IHZvaWQgMDsKICAgICAgICBpZiAodGhpcy5hdXRvRnJlZXplXykKICAgICAgICAgIGZyZWV6ZShyZXN1bHQsIHRydWUpOwogICAgICAgIGlmIChwYXRjaExpc3RlbmVyKSB7CiAgICAgICAgICBjb25zdCBwID0gW107CiAgICAgICAgICBjb25zdCBpcCA9IFtdOwogICAgICAgICAgZ2V0UGx1Z2luKFBsdWdpblBhdGNoZXMpLmdlbmVyYXRlUmVwbGFjZW1lbnRQYXRjaGVzXyhiYXNlLCByZXN1bHQsIHsKICAgICAgICAgICAgcGF0Y2hlc186IHAsCiAgICAgICAgICAgIGludmVyc2VQYXRjaGVzXzogaXAKICAgICAgICAgIH0pOwogICAgICAgICAgcGF0Y2hMaXN0ZW5lcihwLCBpcCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0gZWxzZQogICAgICAgIGRpZSgxLCBiYXNlKTsKICAgIH07CiAgICB0aGlzLnByb2R1Y2VXaXRoUGF0Y2hlcyA9IChiYXNlLCByZWNpcGUpID0+IHsKICAgICAgaWYgKGlzRnVuY3Rpb24oYmFzZSkpIHsKICAgICAgICByZXR1cm4gKHN0YXRlLCAuLi5hcmdzKSA9PiB0aGlzLnByb2R1Y2VXaXRoUGF0Y2hlcyhzdGF0ZSwgKGRyYWZ0KSA9PiBiYXNlKGRyYWZ0LCAuLi5hcmdzKSk7CiAgICAgIH0KICAgICAgbGV0IHBhdGNoZXMsIGludmVyc2VQYXRjaGVzOwogICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnByb2R1Y2UoYmFzZSwgcmVjaXBlLCAocCwgaXApID0+IHsKICAgICAgICBwYXRjaGVzID0gcDsKICAgICAgICBpbnZlcnNlUGF0Y2hlcyA9IGlwOwogICAgICB9KTsKICAgICAgcmV0dXJuIFtyZXN1bHQsIHBhdGNoZXMsIGludmVyc2VQYXRjaGVzXTsKICAgIH07CiAgICBpZiAoaXNCb29sZWFuKGNvbmZpZz8uYXV0b0ZyZWV6ZSkpCiAgICAgIHRoaXMuc2V0QXV0b0ZyZWV6ZShjb25maWcuYXV0b0ZyZWV6ZSk7CiAgICBpZiAoaXNCb29sZWFuKGNvbmZpZz8udXNlU3RyaWN0U2hhbGxvd0NvcHkpKQogICAgICB0aGlzLnNldFVzZVN0cmljdFNoYWxsb3dDb3B5KGNvbmZpZy51c2VTdHJpY3RTaGFsbG93Q29weSk7CiAgICBpZiAoaXNCb29sZWFuKGNvbmZpZz8udXNlU3RyaWN0SXRlcmF0aW9uKSkKICAgICAgdGhpcy5zZXRVc2VTdHJpY3RJdGVyYXRpb24oY29uZmlnLnVzZVN0cmljdEl0ZXJhdGlvbik7CiAgfQogIGNyZWF0ZURyYWZ0KGJhc2UpIHsKICAgIGlmICghaXNEcmFmdGFibGUoYmFzZSkpCiAgICAgIGRpZSg4KTsKICAgIGlmIChpc0RyYWZ0KGJhc2UpKQogICAgICBiYXNlID0gY3VycmVudChiYXNlKTsKICAgIGNvbnN0IHNjb3BlID0gZW50ZXJTY29wZSh0aGlzKTsKICAgIGNvbnN0IHByb3h5ID0gY3JlYXRlUHJveHkoc2NvcGUsIGJhc2UsIHZvaWQgMCk7CiAgICBwcm94eVtEUkFGVF9TVEFURV0uaXNNYW51YWxfID0gdHJ1ZTsKICAgIGxlYXZlU2NvcGUoc2NvcGUpOwogICAgcmV0dXJuIHByb3h5OwogIH0KICBmaW5pc2hEcmFmdChkcmFmdCwgcGF0Y2hMaXN0ZW5lcikgewogICAgY29uc3Qgc3RhdGUgPSBkcmFmdCAmJiBkcmFmdFtEUkFGVF9TVEFURV07CiAgICBpZiAoIXN0YXRlIHx8ICFzdGF0ZS5pc01hbnVhbF8pCiAgICAgIGRpZSg5KTsKICAgIGNvbnN0IHsgc2NvcGVfOiBzY29wZSB9ID0gc3RhdGU7CiAgICB1c2VQYXRjaGVzSW5TY29wZShzY29wZSwgcGF0Y2hMaXN0ZW5lcik7CiAgICByZXR1cm4gcHJvY2Vzc1Jlc3VsdCh2b2lkIDAsIHNjb3BlKTsKICB9CiAgLyoqCiAgICogUGFzcyB0cnVlIHRvIGF1dG9tYXRpY2FsbHkgZnJlZXplIGFsbCBjb3BpZXMgY3JlYXRlZCBieSBJbW1lci4KICAgKgogICAqIEJ5IGRlZmF1bHQsIGF1dG8tZnJlZXppbmcgaXMgZW5hYmxlZC4KICAgKi8KICBzZXRBdXRvRnJlZXplKHZhbHVlKSB7CiAgICB0aGlzLmF1dG9GcmVlemVfID0gdmFsdWU7CiAgfQogIC8qKgogICAqIFBhc3MgdHJ1ZSB0byBlbmFibGUgc3RyaWN0IHNoYWxsb3cgY29weS4KICAgKgogICAqIEJ5IGRlZmF1bHQsIGltbWVyIGRvZXMgbm90IGNvcHkgdGhlIG9iamVjdCBkZXNjcmlwdG9ycyBzdWNoIGFzIGdldHRlciwgc2V0dGVyIGFuZCBub24tZW51bXJhYmxlIHByb3BlcnRpZXMuCiAgICovCiAgc2V0VXNlU3RyaWN0U2hhbGxvd0NvcHkodmFsdWUpIHsKICAgIHRoaXMudXNlU3RyaWN0U2hhbGxvd0NvcHlfID0gdmFsdWU7CiAgfQogIC8qKgogICAqIFBhc3MgZmFsc2UgdG8gdXNlIGZhc3RlciBpdGVyYXRpb24gdGhhdCBza2lwcyBub24tZW51bWVyYWJsZSBwcm9wZXJ0aWVzCiAgICogYnV0IHN0aWxsIGhhbmRsZXMgc3ltYm9scyBmb3IgY29tcGF0aWJpbGl0eS4KICAgKgogICAqIEJ5IGRlZmF1bHQsIHN0cmljdCBpdGVyYXRpb24gaXMgZW5hYmxlZCAoaW5jbHVkZXMgYWxsIG93biBwcm9wZXJ0aWVzKS4KICAgKi8KICBzZXRVc2VTdHJpY3RJdGVyYXRpb24odmFsdWUpIHsKICAgIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXyA9IHZhbHVlOwogIH0KICBzaG91bGRVc2VTdHJpY3RJdGVyYXRpb24oKSB7CiAgICByZXR1cm4gdGhpcy51c2VTdHJpY3RJdGVyYXRpb25fOwogIH0KICBhcHBseVBhdGNoZXMoYmFzZSwgcGF0Y2hlcykgewogICAgbGV0IGk7CiAgICBmb3IgKGkgPSBwYXRjaGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIGNvbnN0IHBhdGNoID0gcGF0Y2hlc1tpXTsKICAgICAgaWYgKHBhdGNoLnBhdGgubGVuZ3RoID09PSAwICYmIHBhdGNoLm9wID09PSAicmVwbGFjZSIpIHsKICAgICAgICBiYXNlID0gcGF0Y2gudmFsdWU7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIGlmIChpID4gLTEpIHsKICAgICAgcGF0Y2hlcyA9IHBhdGNoZXMuc2xpY2UoaSArIDEpOwogICAgfQogICAgY29uc3QgYXBwbHlQYXRjaGVzSW1wbCA9IGdldFBsdWdpbihQbHVnaW5QYXRjaGVzKS5hcHBseVBhdGNoZXNfOwogICAgaWYgKGlzRHJhZnQoYmFzZSkpIHsKICAgICAgcmV0dXJuIGFwcGx5UGF0Y2hlc0ltcGwoYmFzZSwgcGF0Y2hlcyk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5wcm9kdWNlKAogICAgICBiYXNlLAogICAgICAoZHJhZnQpID0+IGFwcGx5UGF0Y2hlc0ltcGwoZHJhZnQsIHBhdGNoZXMpCiAgICApOwogIH0KfTsKZnVuY3Rpb24gY3JlYXRlUHJveHkocm9vdFNjb3BlLCB2YWx1ZSwgcGFyZW50LCBrZXkpIHsKICBjb25zdCBbZHJhZnQsIHN0YXRlXSA9IGlzTWFwKHZhbHVlKSA/IGdldFBsdWdpbihQbHVnaW5NYXBTZXQpLnByb3h5TWFwXyh2YWx1ZSwgcGFyZW50KSA6IGlzU2V0KHZhbHVlKSA/IGdldFBsdWdpbihQbHVnaW5NYXBTZXQpLnByb3h5U2V0Xyh2YWx1ZSwgcGFyZW50KSA6IGNyZWF0ZVByb3h5UHJveHkodmFsdWUsIHBhcmVudCk7CiAgY29uc3Qgc2NvcGUgPSBwYXJlbnQ/LnNjb3BlXyA/PyBnZXRDdXJyZW50U2NvcGUoKTsKICBzY29wZS5kcmFmdHNfLnB1c2goZHJhZnQpOwogIHN0YXRlLmNhbGxiYWNrc18gPSBwYXJlbnQ/LmNhbGxiYWNrc18gPz8gW107CiAgc3RhdGUua2V5XyA9IGtleTsKICBpZiAocGFyZW50ICYmIGtleSAhPT0gdm9pZCAwKSB7CiAgICByZWdpc3RlckNoaWxkRmluYWxpemF0aW9uQ2FsbGJhY2socGFyZW50LCBzdGF0ZSwga2V5KTsKICB9IGVsc2UgewogICAgc3RhdGUuY2FsbGJhY2tzXy5wdXNoKGZ1bmN0aW9uIHJvb3REcmFmdENsZWFudXAocm9vdFNjb3BlMikgewogICAgICByb290U2NvcGUyLm1hcFNldFBsdWdpbl8/LmZpeFNldENvbnRlbnRzKHN0YXRlKTsKICAgICAgY29uc3QgeyBwYXRjaFBsdWdpbl8gfSA9IHJvb3RTY29wZTI7CiAgICAgIGlmIChzdGF0ZS5tb2RpZmllZF8gJiYgcGF0Y2hQbHVnaW5fKSB7CiAgICAgICAgcGF0Y2hQbHVnaW5fLmdlbmVyYXRlUGF0Y2hlc18oc3RhdGUsIFtdLCByb290U2NvcGUyKTsKICAgICAgfQogICAgfSk7CiAgfQogIHJldHVybiBkcmFmdDsKfQpmdW5jdGlvbiBjdXJyZW50KHZhbHVlKSB7CiAgaWYgKCFpc0RyYWZ0KHZhbHVlKSkKICAgIGRpZSgxMCwgdmFsdWUpOwogIHJldHVybiBjdXJyZW50SW1wbCh2YWx1ZSk7Cn0KZnVuY3Rpb24gY3VycmVudEltcGwodmFsdWUpIHsKICBpZiAoIWlzRHJhZnRhYmxlKHZhbHVlKSB8fCBpc0Zyb3plbih2YWx1ZSkpCiAgICByZXR1cm4gdmFsdWU7CiAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURV07CiAgbGV0IGNvcHkzOwogIGxldCBzdHJpY3QgPSB0cnVlOwogIGlmIChzdGF0ZSkgewogICAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pCiAgICAgIHJldHVybiBzdGF0ZS5iYXNlXzsKICAgIHN0YXRlLmZpbmFsaXplZF8gPSB0cnVlOwogICAgY29weTMgPSBzaGFsbG93Q29weSh2YWx1ZSwgc3RhdGUuc2NvcGVfLmltbWVyXy51c2VTdHJpY3RTaGFsbG93Q29weV8pOwogICAgc3RyaWN0ID0gc3RhdGUuc2NvcGVfLmltbWVyXy5zaG91bGRVc2VTdHJpY3RJdGVyYXRpb24oKTsKICB9IGVsc2UgewogICAgY29weTMgPSBzaGFsbG93Q29weSh2YWx1ZSwgdHJ1ZSk7CiAgfQogIGVhY2goCiAgICBjb3B5MywKICAgIChrZXksIGNoaWxkVmFsdWUpID0+IHsKICAgICAgc2V0KGNvcHkzLCBrZXksIGN1cnJlbnRJbXBsKGNoaWxkVmFsdWUpKTsKICAgIH0sCiAgICBzdHJpY3QKICApOwogIGlmIChzdGF0ZSkgewogICAgc3RhdGUuZmluYWxpemVkXyA9IGZhbHNlOwogIH0KICByZXR1cm4gY29weTM7Cn0KdmFyIGltbWVyID0gbmV3IEltbWVyMigpOwp2YXIgcHJvZHVjZSA9IGltbWVyLnByb2R1Y2U7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVkdXgtdGh1bmtAMy4xLjBfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlZHV4LXRodW5rL2Rpc3QvcmVkdXgtdGh1bmsubWpzCmZ1bmN0aW9uIGNyZWF0ZVRodW5rTWlkZGxld2FyZShleHRyYUFyZ3VtZW50KSB7CiAgY29uc3QgbWlkZGxld2FyZSA9ICh7IGRpc3BhdGNoLCBnZXRTdGF0ZSB9KSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gewogICAgaWYgKHR5cGVvZiBhY3Rpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmV0dXJuIGFjdGlvbihkaXNwYXRjaCwgZ2V0U3RhdGUsIGV4dHJhQXJndW1lbnQpOwogICAgfQogICAgcmV0dXJuIG5leHQoYWN0aW9uKTsKICB9OwogIHJldHVybiBtaWRkbGV3YXJlOwp9CnZhciB0aHVuayA9IGNyZWF0ZVRodW5rTWlkZGxld2FyZSgpOwp2YXIgd2l0aEV4dHJhQXJndW1lbnQgPSBjcmVhdGVUaHVua01pZGRsZXdhcmU7CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHJlZHV4anMrdG9vbGtpdEAyLjExLjBfcmVhY3QtcmVkdXhAOS4yLjBfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xX19yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL0ByZWR1eGpzL3Rvb2xraXQvZGlzdC9yZWR1eC10b29sa2l0Lm1vZGVybi5tanMKdmFyIGNvbXBvc2VXaXRoRGV2VG9vbHMgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuX19SRURVWF9ERVZUT09MU19FWFRFTlNJT05fQ09NUE9TRV9fID8gd2luZG93Ll9fUkVEVVhfREVWVE9PTFNfRVhURU5TSU9OX0NPTVBPU0VfXyA6IGZ1bmN0aW9uKCkgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSByZXR1cm4gdm9pZCAwOwogIGlmICh0eXBlb2YgYXJndW1lbnRzWzBdID09PSAib2JqZWN0IikgcmV0dXJuIGNvbXBvc2U7CiAgcmV0dXJuIGNvbXBvc2UuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfTsKdmFyIGRldlRvb2xzRW5oYW5jZXIgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuX19SRURVWF9ERVZUT09MU19FWFRFTlNJT05fXyA/IHdpbmRvdy5fX1JFRFVYX0RFVlRPT0xTX0VYVEVOU0lPTl9fIDogZnVuY3Rpb24oKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKG5vb3AzMikgewogICAgcmV0dXJuIG5vb3AzMjsKICB9Owp9Owp2YXIgaGFzTWF0Y2hGdW5jdGlvbiA9ICh2KSA9PiB7CiAgcmV0dXJuIHYgJiYgdHlwZW9mIHYubWF0Y2ggPT09ICJmdW5jdGlvbiI7Cn07CmZ1bmN0aW9uIGNyZWF0ZUFjdGlvbih0eXBlLCBwcmVwYXJlQWN0aW9uKSB7CiAgZnVuY3Rpb24gYWN0aW9uQ3JlYXRvciguLi5hcmdzKSB7CiAgICBpZiAocHJlcGFyZUFjdGlvbikgewogICAgICBsZXQgcHJlcGFyZWQgPSBwcmVwYXJlQWN0aW9uKC4uLmFyZ3MpOwogICAgICBpZiAoIXByZXBhcmVkKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgwKSA6ICJwcmVwYXJlQWN0aW9uIGRpZCBub3QgcmV0dXJuIGFuIG9iamVjdCIpOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgdHlwZSwKICAgICAgICBwYXlsb2FkOiBwcmVwYXJlZC5wYXlsb2FkLAogICAgICAgIC4uLiJtZXRhIiBpbiBwcmVwYXJlZCAmJiB7CiAgICAgICAgICBtZXRhOiBwcmVwYXJlZC5tZXRhCiAgICAgICAgfSwKICAgICAgICAuLi4iZXJyb3IiIGluIHByZXBhcmVkICYmIHsKICAgICAgICAgIGVycm9yOiBwcmVwYXJlZC5lcnJvcgogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHR5cGUsCiAgICAgIHBheWxvYWQ6IGFyZ3NbMF0KICAgIH07CiAgfQogIGFjdGlvbkNyZWF0b3IudG9TdHJpbmcgPSAoKSA9PiBgJHt0eXBlfWA7CiAgYWN0aW9uQ3JlYXRvci50eXBlID0gdHlwZTsKICBhY3Rpb25DcmVhdG9yLm1hdGNoID0gKGFjdGlvbikgPT4gaXNBY3Rpb24oYWN0aW9uKSAmJiBhY3Rpb24udHlwZSA9PT0gdHlwZTsKICByZXR1cm4gYWN0aW9uQ3JlYXRvcjsKfQpmdW5jdGlvbiBpc0FjdGlvbkNyZWF0b3IoYWN0aW9uKSB7CiAgcmV0dXJuIHR5cGVvZiBhY3Rpb24gPT09ICJmdW5jdGlvbiIgJiYgInR5cGUiIGluIGFjdGlvbiAmJiAvLyBoYXNNYXRjaEZ1bmN0aW9uIG9ubHkgd2FudHMgTWF0Y2hlcnMgYnV0IEkgZG9uJ3Qgc2VlIHRoZSBwb2ludCBpbiByZXdyaXRpbmcgaXQKICBoYXNNYXRjaEZ1bmN0aW9uKGFjdGlvbik7Cn0KZnVuY3Rpb24gZ2V0TWVzc2FnZSh0eXBlKSB7CiAgY29uc3Qgc3BsaXRUeXBlID0gdHlwZSA/IGAke3R5cGV9YC5zcGxpdCgiLyIpIDogW107CiAgY29uc3QgYWN0aW9uTmFtZSA9IHNwbGl0VHlwZVtzcGxpdFR5cGUubGVuZ3RoIC0gMV0gfHwgImFjdGlvbkNyZWF0b3IiOwogIHJldHVybiBgRGV0ZWN0ZWQgYW4gYWN0aW9uIGNyZWF0b3Igd2l0aCB0eXBlICIke3R5cGUgfHwgInVua25vd24ifSIgYmVpbmcgZGlzcGF0Y2hlZC4gCk1ha2Ugc3VyZSB5b3UncmUgY2FsbGluZyB0aGUgYWN0aW9uIGNyZWF0b3IgYmVmb3JlIGRpc3BhdGNoaW5nLCBpLmUuIFxgZGlzcGF0Y2goJHthY3Rpb25OYW1lfSgpKVxgIGluc3RlYWQgb2YgXGBkaXNwYXRjaCgke2FjdGlvbk5hbWV9KVxgLiBUaGlzIGlzIG5lY2Vzc2FyeSBldmVuIGlmIHRoZSBhY3Rpb24gaGFzIG5vIHBheWxvYWQuYDsKfQpmdW5jdGlvbiBjcmVhdGVBY3Rpb25DcmVhdG9ySW52YXJpYW50TWlkZGxld2FyZShvcHRpb25zID0ge30pIHsKICBpZiAoZmFsc2UpIHsKICAgIHJldHVybiAoKSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gbmV4dChhY3Rpb24pOwogIH0KICBjb25zdCB7CiAgICBpc0FjdGlvbkNyZWF0b3I6IGlzQWN0aW9uQ3JlYXRvcjIgPSBpc0FjdGlvbkNyZWF0b3IKICB9ID0gb3B0aW9uczsKICByZXR1cm4gKCkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IHsKICAgIGlmIChpc0FjdGlvbkNyZWF0b3IyKGFjdGlvbikpIHsKICAgICAgY29uc29sZS53YXJuKGdldE1lc3NhZ2UoYWN0aW9uLnR5cGUpKTsKICAgIH0KICAgIHJldHVybiBuZXh0KGFjdGlvbik7CiAgfTsKfQpmdW5jdGlvbiBnZXRUaW1lTWVhc3VyZVV0aWxzKG1heERlbGF5LCBmbk5hbWUpIHsKICBsZXQgZWxhcHNlZCA9IDA7CiAgcmV0dXJuIHsKICAgIG1lYXN1cmVUaW1lKGZuKSB7CiAgICAgIGNvbnN0IHN0YXJ0ZWQgPSBEYXRlLm5vdygpOwogICAgICB0cnkgewogICAgICAgIHJldHVybiBmbigpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIGNvbnN0IGZpbmlzaGVkID0gRGF0ZS5ub3coKTsKICAgICAgICBlbGFwc2VkICs9IGZpbmlzaGVkIC0gc3RhcnRlZDsKICAgICAgfQogICAgfSwKICAgIHdhcm5JZkV4Y2VlZGVkKCkgewogICAgICBpZiAoZWxhcHNlZCA+IG1heERlbGF5KSB7CiAgICAgICAgY29uc29sZS53YXJuKGAke2ZuTmFtZX0gdG9vayAke2VsYXBzZWR9bXMsIHdoaWNoIGlzIG1vcmUgdGhhbiB0aGUgd2FybmluZyB0aHJlc2hvbGQgb2YgJHttYXhEZWxheX1tcy4gCklmIHlvdXIgc3RhdGUgb3IgYWN0aW9ucyBhcmUgdmVyeSBsYXJnZSwgeW91IG1heSB3YW50IHRvIGRpc2FibGUgdGhlIG1pZGRsZXdhcmUgYXMgaXQgbWlnaHQgY2F1c2UgdG9vIG11Y2ggb2YgYSBzbG93ZG93biBpbiBkZXZlbG9wbWVudCBtb2RlLiBTZWUgaHR0cHM6Ly9yZWR1eC10b29sa2l0LmpzLm9yZy9hcGkvZ2V0RGVmYXVsdE1pZGRsZXdhcmUgZm9yIGluc3RydWN0aW9ucy4KSXQgaXMgZGlzYWJsZWQgaW4gcHJvZHVjdGlvbiBidWlsZHMsIHNvIHlvdSBkb24ndCBuZWVkIHRvIHdvcnJ5IGFib3V0IHRoYXQuYCk7CiAgICAgIH0KICAgIH0KICB9Owp9CnZhciBUdXBsZSA9IGNsYXNzIF9UdXBsZSBleHRlbmRzIEFycmF5IHsKICBjb25zdHJ1Y3RvciguLi5pdGVtcykgewogICAgc3VwZXIoLi4uaXRlbXMpOwogICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKHRoaXMsIF9UdXBsZS5wcm90b3R5cGUpOwogIH0KICBzdGF0aWMgZ2V0IFtTeW1ib2wuc3BlY2llc10oKSB7CiAgICByZXR1cm4gX1R1cGxlOwogIH0KICBjb25jYXQoLi4uYXJyKSB7CiAgICByZXR1cm4gc3VwZXIuY29uY2F0LmFwcGx5KHRoaXMsIGFycik7CiAgfQogIHByZXBlbmQoLi4uYXJyKSB7CiAgICBpZiAoYXJyLmxlbmd0aCA9PT0gMSAmJiBBcnJheS5pc0FycmF5KGFyclswXSkpIHsKICAgICAgcmV0dXJuIG5ldyBfVHVwbGUoLi4uYXJyWzBdLmNvbmNhdCh0aGlzKSk7CiAgICB9CiAgICByZXR1cm4gbmV3IF9UdXBsZSguLi5hcnIuY29uY2F0KHRoaXMpKTsKICB9Cn07CmZ1bmN0aW9uIGZyZWV6ZURyYWZ0YWJsZSh2YWwpIHsKICByZXR1cm4gaXNEcmFmdGFibGUodmFsKSA/IHByb2R1Y2UodmFsLCAoKSA9PiB7CiAgfSkgOiB2YWw7Cn0KZnVuY3Rpb24gZ2V0T3JJbnNlcnRDb21wdXRlZChtYXAzLCBrZXksIGNvbXB1dGUpIHsKICBpZiAobWFwMy5oYXMoa2V5KSkgcmV0dXJuIG1hcDMuZ2V0KGtleSk7CiAgcmV0dXJuIG1hcDMuc2V0KGtleSwgY29tcHV0ZShrZXkpKS5nZXQoa2V5KTsKfQpmdW5jdGlvbiBpc0ltbXV0YWJsZURlZmF1bHQodmFsdWUpIHsKICByZXR1cm4gdHlwZW9mIHZhbHVlICE9PSAib2JqZWN0IiB8fCB2YWx1ZSA9PSBudWxsIHx8IE9iamVjdC5pc0Zyb3plbih2YWx1ZSk7Cn0KZnVuY3Rpb24gdHJhY2tGb3JNdXRhdGlvbnMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocywgb2JqKSB7CiAgY29uc3QgdHJhY2tlZFByb3BlcnRpZXMgPSB0cmFja1Byb3BlcnRpZXMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocywgb2JqKTsKICByZXR1cm4gewogICAgZGV0ZWN0TXV0YXRpb25zKCkgewogICAgICByZXR1cm4gZGV0ZWN0TXV0YXRpb25zKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMsIHRyYWNrZWRQcm9wZXJ0aWVzLCBvYmopOwogICAgfQogIH07Cn0KZnVuY3Rpb24gdHJhY2tQcm9wZXJ0aWVzKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMgPSBbXSwgb2JqLCBwYXRoMiA9ICIiLCBjaGVja2VkT2JqZWN0cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCkpIHsKICBjb25zdCB0cmFja2VkID0gewogICAgdmFsdWU6IG9iagogIH07CiAgaWYgKCFpc0ltbXV0YWJsZShvYmopICYmICFjaGVja2VkT2JqZWN0cy5oYXMob2JqKSkgewogICAgY2hlY2tlZE9iamVjdHMuYWRkKG9iaik7CiAgICB0cmFja2VkLmNoaWxkcmVuID0ge307CiAgICBjb25zdCBoYXNJZ25vcmVkUGF0aHMgPSBpZ25vcmVkUGF0aHMubGVuZ3RoID4gMDsKICAgIGZvciAoY29uc3Qga2V5IGluIG9iaikgewogICAgICBjb25zdCBuZXN0ZWRQYXRoID0gcGF0aDIgPyBwYXRoMiArICIuIiArIGtleSA6IGtleTsKICAgICAgaWYgKGhhc0lnbm9yZWRQYXRocykgewogICAgICAgIGNvbnN0IGhhc01hdGNoZXMgPSBpZ25vcmVkUGF0aHMuc29tZSgoaWdub3JlZCkgPT4gewogICAgICAgICAgaWYgKGlnbm9yZWQgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgICAgcmV0dXJuIGlnbm9yZWQudGVzdChuZXN0ZWRQYXRoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXN0ZWRQYXRoID09PSBpZ25vcmVkOwogICAgICAgIH0pOwogICAgICAgIGlmIChoYXNNYXRjaGVzKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdHJhY2tlZC5jaGlsZHJlbltrZXldID0gdHJhY2tQcm9wZXJ0aWVzKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMsIG9ialtrZXldLCBuZXN0ZWRQYXRoKTsKICAgIH0KICB9CiAgcmV0dXJuIHRyYWNrZWQ7Cn0KZnVuY3Rpb24gZGV0ZWN0TXV0YXRpb25zKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMgPSBbXSwgdHJhY2tlZFByb3BlcnR5LCBvYmosIHNhbWVQYXJlbnRSZWYgPSBmYWxzZSwgcGF0aDIgPSAiIikgewogIGNvbnN0IHByZXZPYmogPSB0cmFja2VkUHJvcGVydHkgPyB0cmFja2VkUHJvcGVydHkudmFsdWUgOiB2b2lkIDA7CiAgY29uc3Qgc2FtZVJlZiA9IHByZXZPYmogPT09IG9iajsKICBpZiAoc2FtZVBhcmVudFJlZiAmJiAhc2FtZVJlZiAmJiAhTnVtYmVyLmlzTmFOKG9iaikpIHsKICAgIHJldHVybiB7CiAgICAgIHdhc011dGF0ZWQ6IHRydWUsCiAgICAgIHBhdGg6IHBhdGgyCiAgICB9OwogIH0KICBpZiAoaXNJbW11dGFibGUocHJldk9iaikgfHwgaXNJbW11dGFibGUob2JqKSkgewogICAgcmV0dXJuIHsKICAgICAgd2FzTXV0YXRlZDogZmFsc2UKICAgIH07CiAgfQogIGNvbnN0IGtleXNUb0RldGVjdCA9IHt9OwogIGZvciAobGV0IGtleSBpbiB0cmFja2VkUHJvcGVydHkuY2hpbGRyZW4pIHsKICAgIGtleXNUb0RldGVjdFtrZXldID0gdHJ1ZTsKICB9CiAgZm9yIChsZXQga2V5IGluIG9iaikgewogICAga2V5c1RvRGV0ZWN0W2tleV0gPSB0cnVlOwogIH0KICBjb25zdCBoYXNJZ25vcmVkUGF0aHMgPSBpZ25vcmVkUGF0aHMubGVuZ3RoID4gMDsKICBmb3IgKGxldCBrZXkgaW4ga2V5c1RvRGV0ZWN0KSB7CiAgICBjb25zdCBuZXN0ZWRQYXRoID0gcGF0aDIgPyBwYXRoMiArICIuIiArIGtleSA6IGtleTsKICAgIGlmIChoYXNJZ25vcmVkUGF0aHMpIHsKICAgICAgY29uc3QgaGFzTWF0Y2hlcyA9IGlnbm9yZWRQYXRocy5zb21lKChpZ25vcmVkKSA9PiB7CiAgICAgICAgaWYgKGlnbm9yZWQgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgIHJldHVybiBpZ25vcmVkLnRlc3QobmVzdGVkUGF0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXN0ZWRQYXRoID09PSBpZ25vcmVkOwogICAgICB9KTsKICAgICAgaWYgKGhhc01hdGNoZXMpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgfQogICAgY29uc3QgcmVzdWx0ID0gZGV0ZWN0TXV0YXRpb25zKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMsIHRyYWNrZWRQcm9wZXJ0eS5jaGlsZHJlbltrZXldLCBvYmpba2V5XSwgc2FtZVJlZiwgbmVzdGVkUGF0aCk7CiAgICBpZiAocmVzdWx0Lndhc011dGF0ZWQpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9CiAgcmV0dXJuIHsKICAgIHdhc011dGF0ZWQ6IGZhbHNlCiAgfTsKfQpmdW5jdGlvbiBjcmVhdGVJbW11dGFibGVTdGF0ZUludmFyaWFudE1pZGRsZXdhcmUob3B0aW9ucyA9IHt9KSB7CiAgaWYgKGZhbHNlKSB7CiAgICByZXR1cm4gKCkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IG5leHQoYWN0aW9uKTsKICB9IGVsc2UgewogICAgbGV0IHN0cmluZ2lmeTIgPSBmdW5jdGlvbihvYmosIHNlcmlhbGl6ZXIsIGluZGVudCwgZGVjeWNsZXIpIHsKICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaiwgZ2V0U2VyaWFsaXplMihzZXJpYWxpemVyLCBkZWN5Y2xlciksIGluZGVudCk7CiAgICB9LCBnZXRTZXJpYWxpemUyID0gZnVuY3Rpb24oc2VyaWFsaXplciwgZGVjeWNsZXIpIHsKICAgICAgbGV0IHN0YWNrID0gW10sIGtleXMgPSBbXTsKICAgICAgaWYgKCFkZWN5Y2xlcikgZGVjeWNsZXIgPSBmdW5jdGlvbihfLCB2YWx1ZSkgewogICAgICAgIGlmIChzdGFja1swXSA9PT0gdmFsdWUpIHJldHVybiAiW0NpcmN1bGFyIH5dIjsKICAgICAgICByZXR1cm4gIltDaXJjdWxhciB+LiIgKyBrZXlzLnNsaWNlKDAsIHN0YWNrLmluZGV4T2YodmFsdWUpKS5qb2luKCIuIikgKyAiXSI7CiAgICAgIH07CiAgICAgIHJldHVybiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHZhciB0aGlzUG9zID0gc3RhY2suaW5kZXhPZih0aGlzKTsKICAgICAgICAgIH50aGlzUG9zID8gc3RhY2suc3BsaWNlKHRoaXNQb3MgKyAxKSA6IHN0YWNrLnB1c2godGhpcyk7CiAgICAgICAgICB+dGhpc1BvcyA/IGtleXMuc3BsaWNlKHRoaXNQb3MsIEluZmluaXR5LCBrZXkpIDoga2V5cy5wdXNoKGtleSk7CiAgICAgICAgICBpZiAofnN0YWNrLmluZGV4T2YodmFsdWUpKSB2YWx1ZSA9IGRlY3ljbGVyLmNhbGwodGhpcywga2V5LCB2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHN0YWNrLnB1c2godmFsdWUpOwogICAgICAgIHJldHVybiBzZXJpYWxpemVyID09IG51bGwgPyB2YWx1ZSA6IHNlcmlhbGl6ZXIuY2FsbCh0aGlzLCBrZXksIHZhbHVlKTsKICAgICAgfTsKICAgIH07CiAgICB2YXIgc3RyaW5naWZ5ID0gc3RyaW5naWZ5MiwgZ2V0U2VyaWFsaXplID0gZ2V0U2VyaWFsaXplMjsKICAgIGxldCB7CiAgICAgIGlzSW1tdXRhYmxlID0gaXNJbW11dGFibGVEZWZhdWx0LAogICAgICBpZ25vcmVkUGF0aHMsCiAgICAgIHdhcm5BZnRlciA9IDMyCiAgICB9ID0gb3B0aW9uczsKICAgIGNvbnN0IHRyYWNrID0gdHJhY2tGb3JNdXRhdGlvbnMuYmluZChudWxsLCBpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzKTsKICAgIHJldHVybiAoewogICAgICBnZXRTdGF0ZQogICAgfSkgPT4gewogICAgICBsZXQgc3RhdGUgPSBnZXRTdGF0ZSgpOwogICAgICBsZXQgdHJhY2tlciA9IHRyYWNrKHN0YXRlKTsKICAgICAgbGV0IHJlc3VsdDsKICAgICAgcmV0dXJuIChuZXh0KSA9PiAoYWN0aW9uKSA9PiB7CiAgICAgICAgY29uc3QgbWVhc3VyZVV0aWxzID0gZ2V0VGltZU1lYXN1cmVVdGlscyh3YXJuQWZ0ZXIsICJJbW11dGFibGVTdGF0ZUludmFyaWFudE1pZGRsZXdhcmUiKTsKICAgICAgICBtZWFzdXJlVXRpbHMubWVhc3VyZVRpbWUoKCkgPT4gewogICAgICAgICAgc3RhdGUgPSBnZXRTdGF0ZSgpOwogICAgICAgICAgcmVzdWx0ID0gdHJhY2tlci5kZXRlY3RNdXRhdGlvbnMoKTsKICAgICAgICAgIHRyYWNrZXIgPSB0cmFjayhzdGF0ZSk7CiAgICAgICAgICBpZiAocmVzdWx0Lndhc011dGF0ZWQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxOSkgOiBgQSBzdGF0ZSBtdXRhdGlvbiB3YXMgZGV0ZWN0ZWQgYmV0d2VlbiBkaXNwYXRjaGVzLCBpbiB0aGUgcGF0aCAnJHtyZXN1bHQucGF0aCB8fCAiIn0nLiAgVGhpcyBtYXkgY2F1c2UgaW5jb3JyZWN0IGJlaGF2aW9yLiAoaHR0cHM6Ly9yZWR1eC5qcy5vcmcvc3R5bGUtZ3VpZGUvc3R5bGUtZ3VpZGUjZG8tbm90LW11dGF0ZS1zdGF0ZSlgKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBjb25zdCBkaXNwYXRjaGVkQWN0aW9uID0gbmV4dChhY3Rpb24pOwogICAgICAgIG1lYXN1cmVVdGlscy5tZWFzdXJlVGltZSgoKSA9PiB7CiAgICAgICAgICBzdGF0ZSA9IGdldFN0YXRlKCk7CiAgICAgICAgICByZXN1bHQgPSB0cmFja2VyLmRldGVjdE11dGF0aW9ucygpOwogICAgICAgICAgdHJhY2tlciA9IHRyYWNrKHN0YXRlKTsKICAgICAgICAgIGlmIChyZXN1bHQud2FzTXV0YXRlZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDIwKSA6IGBBIHN0YXRlIG11dGF0aW9uIHdhcyBkZXRlY3RlZCBpbnNpZGUgYSBkaXNwYXRjaCwgaW4gdGhlIHBhdGg6ICR7cmVzdWx0LnBhdGggfHwgIiJ9LiBUYWtlIGEgbG9vayBhdCB0aGUgcmVkdWNlcihzKSBoYW5kbGluZyB0aGUgYWN0aW9uICR7c3RyaW5naWZ5MihhY3Rpb24pfS4gKGh0dHBzOi8vcmVkdXguanMub3JnL3N0eWxlLWd1aWRlL3N0eWxlLWd1aWRlI2RvLW5vdC1tdXRhdGUtc3RhdGUpYCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgbWVhc3VyZVV0aWxzLndhcm5JZkV4Y2VlZGVkKCk7CiAgICAgICAgcmV0dXJuIGRpc3BhdGNoZWRBY3Rpb247CiAgICAgIH07CiAgICB9OwogIH0KfQpmdW5jdGlvbiBpc1BsYWluKHZhbCkgewogIGNvbnN0IHR5cGUgPSB0eXBlb2YgdmFsOwogIHJldHVybiB2YWwgPT0gbnVsbCB8fCB0eXBlID09PSAic3RyaW5nIiB8fCB0eXBlID09PSAiYm9vbGVhbiIgfHwgdHlwZSA9PT0gIm51bWJlciIgfHwgQXJyYXkuaXNBcnJheSh2YWwpIHx8IGlzUGxhaW5PYmplY3QodmFsKTsKfQpmdW5jdGlvbiBmaW5kTm9uU2VyaWFsaXphYmxlVmFsdWUodmFsdWUsIHBhdGgyID0gIiIsIGlzU2VyaWFsaXphYmxlID0gaXNQbGFpbiwgZ2V0RW50cmllcywgaWdub3JlZFBhdGhzID0gW10sIGNhY2hlKSB7CiAgbGV0IGZvdW5kTmVzdGVkU2VyaWFsaXphYmxlOwogIGlmICghaXNTZXJpYWxpemFibGUodmFsdWUpKSB7CiAgICByZXR1cm4gewogICAgICBrZXlQYXRoOiBwYXRoMiB8fCAiPHJvb3Q+IiwKICAgICAgdmFsdWUKICAgIH07CiAgfQogIGlmICh0eXBlb2YgdmFsdWUgIT09ICJvYmplY3QiIHx8IHZhbHVlID09PSBudWxsKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGlmIChjYWNoZT8uaGFzKHZhbHVlKSkgcmV0dXJuIGZhbHNlOwogIGNvbnN0IGVudHJpZXMgPSBnZXRFbnRyaWVzICE9IG51bGwgPyBnZXRFbnRyaWVzKHZhbHVlKSA6IE9iamVjdC5lbnRyaWVzKHZhbHVlKTsKICBjb25zdCBoYXNJZ25vcmVkUGF0aHMgPSBpZ25vcmVkUGF0aHMubGVuZ3RoID4gMDsKICBmb3IgKGNvbnN0IFtrZXksIG5lc3RlZFZhbHVlXSBvZiBlbnRyaWVzKSB7CiAgICBjb25zdCBuZXN0ZWRQYXRoID0gcGF0aDIgPyBwYXRoMiArICIuIiArIGtleSA6IGtleTsKICAgIGlmIChoYXNJZ25vcmVkUGF0aHMpIHsKICAgICAgY29uc3QgaGFzTWF0Y2hlcyA9IGlnbm9yZWRQYXRocy5zb21lKChpZ25vcmVkKSA9PiB7CiAgICAgICAgaWYgKGlnbm9yZWQgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgIHJldHVybiBpZ25vcmVkLnRlc3QobmVzdGVkUGF0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXN0ZWRQYXRoID09PSBpZ25vcmVkOwogICAgICB9KTsKICAgICAgaWYgKGhhc01hdGNoZXMpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgfQogICAgaWYgKCFpc1NlcmlhbGl6YWJsZShuZXN0ZWRWYWx1ZSkpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBrZXlQYXRoOiBuZXN0ZWRQYXRoLAogICAgICAgIHZhbHVlOiBuZXN0ZWRWYWx1ZQogICAgICB9OwogICAgfQogICAgaWYgKHR5cGVvZiBuZXN0ZWRWYWx1ZSA9PT0gIm9iamVjdCIpIHsKICAgICAgZm91bmROZXN0ZWRTZXJpYWxpemFibGUgPSBmaW5kTm9uU2VyaWFsaXphYmxlVmFsdWUobmVzdGVkVmFsdWUsIG5lc3RlZFBhdGgsIGlzU2VyaWFsaXphYmxlLCBnZXRFbnRyaWVzLCBpZ25vcmVkUGF0aHMsIGNhY2hlKTsKICAgICAgaWYgKGZvdW5kTmVzdGVkU2VyaWFsaXphYmxlKSB7CiAgICAgICAgcmV0dXJuIGZvdW5kTmVzdGVkU2VyaWFsaXphYmxlOwogICAgICB9CiAgICB9CiAgfQogIGlmIChjYWNoZSAmJiBpc05lc3RlZEZyb3plbih2YWx1ZSkpIGNhY2hlLmFkZCh2YWx1ZSk7CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIGlzTmVzdGVkRnJvemVuKHZhbHVlKSB7CiAgaWYgKCFPYmplY3QuaXNGcm96ZW4odmFsdWUpKSByZXR1cm4gZmFsc2U7CiAgZm9yIChjb25zdCBuZXN0ZWRWYWx1ZSBvZiBPYmplY3QudmFsdWVzKHZhbHVlKSkgewogICAgaWYgKHR5cGVvZiBuZXN0ZWRWYWx1ZSAhPT0gIm9iamVjdCIgfHwgbmVzdGVkVmFsdWUgPT09IG51bGwpIGNvbnRpbnVlOwogICAgaWYgKCFpc05lc3RlZEZyb3plbihuZXN0ZWRWYWx1ZSkpIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gY3JlYXRlU2VyaWFsaXphYmxlU3RhdGVJbnZhcmlhbnRNaWRkbGV3YXJlKG9wdGlvbnMgPSB7fSkgewogIGlmIChmYWxzZSkgewogICAgcmV0dXJuICgpID0+IChuZXh0KSA9PiAoYWN0aW9uKSA9PiBuZXh0KGFjdGlvbik7CiAgfSBlbHNlIHsKICAgIGNvbnN0IHsKICAgICAgaXNTZXJpYWxpemFibGUgPSBpc1BsYWluLAogICAgICBnZXRFbnRyaWVzLAogICAgICBpZ25vcmVkQWN0aW9ucyA9IFtdLAogICAgICBpZ25vcmVkQWN0aW9uUGF0aHMgPSBbIm1ldGEuYXJnIiwgIm1ldGEuYmFzZVF1ZXJ5TWV0YSJdLAogICAgICBpZ25vcmVkUGF0aHMgPSBbXSwKICAgICAgd2FybkFmdGVyID0gMzIsCiAgICAgIGlnbm9yZVN0YXRlID0gZmFsc2UsCiAgICAgIGlnbm9yZUFjdGlvbnMgPSBmYWxzZSwKICAgICAgZGlzYWJsZUNhY2hlID0gZmFsc2UKICAgIH0gPSBvcHRpb25zOwogICAgY29uc3QgY2FjaGUgPSAhZGlzYWJsZUNhY2hlICYmIFdlYWtTZXQgPyAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKSA6IHZvaWQgMDsKICAgIHJldHVybiAoc3RvcmVBUEkpID0+IChuZXh0KSA9PiAoYWN0aW9uKSA9PiB7CiAgICAgIGlmICghaXNBY3Rpb24oYWN0aW9uKSkgewogICAgICAgIHJldHVybiBuZXh0KGFjdGlvbik7CiAgICAgIH0KICAgICAgY29uc3QgcmVzdWx0ID0gbmV4dChhY3Rpb24pOwogICAgICBjb25zdCBtZWFzdXJlVXRpbHMgPSBnZXRUaW1lTWVhc3VyZVV0aWxzKHdhcm5BZnRlciwgIlNlcmlhbGl6YWJsZVN0YXRlSW52YXJpYW50TWlkZGxld2FyZSIpOwogICAgICBpZiAoIWlnbm9yZUFjdGlvbnMgJiYgIShpZ25vcmVkQWN0aW9ucy5sZW5ndGggJiYgaWdub3JlZEFjdGlvbnMuaW5kZXhPZihhY3Rpb24udHlwZSkgIT09IC0xKSkgewogICAgICAgIG1lYXN1cmVVdGlscy5tZWFzdXJlVGltZSgoKSA9PiB7CiAgICAgICAgICBjb25zdCBmb3VuZEFjdGlvbk5vblNlcmlhbGl6YWJsZVZhbHVlID0gZmluZE5vblNlcmlhbGl6YWJsZVZhbHVlKGFjdGlvbiwgIiIsIGlzU2VyaWFsaXphYmxlLCBnZXRFbnRyaWVzLCBpZ25vcmVkQWN0aW9uUGF0aHMsIGNhY2hlKTsKICAgICAgICAgIGlmIChmb3VuZEFjdGlvbk5vblNlcmlhbGl6YWJsZVZhbHVlKSB7CiAgICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgICBrZXlQYXRoLAogICAgICAgICAgICAgIHZhbHVlCiAgICAgICAgICAgIH0gPSBmb3VuZEFjdGlvbk5vblNlcmlhbGl6YWJsZVZhbHVlOwogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBBIG5vbi1zZXJpYWxpemFibGUgdmFsdWUgd2FzIGRldGVjdGVkIGluIGFuIGFjdGlvbiwgaW4gdGhlIHBhdGg6IFxgJHtrZXlQYXRofVxgLiBWYWx1ZTpgLCB2YWx1ZSwgIlxuVGFrZSBhIGxvb2sgYXQgdGhlIGxvZ2ljIHRoYXQgZGlzcGF0Y2hlZCB0aGlzIGFjdGlvbjogIiwgYWN0aW9uLCAiXG4oU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL2ZhcS9hY3Rpb25zI3doeS1zaG91bGQtdHlwZS1iZS1hLXN0cmluZy1vci1hdC1sZWFzdC1zZXJpYWxpemFibGUtd2h5LXNob3VsZC1teS1hY3Rpb24tdHlwZXMtYmUtY29uc3RhbnRzKSIsICJcbihUbyBhbGxvdyBub24tc2VyaWFsaXphYmxlIHZhbHVlcyBzZWU6IGh0dHBzOi8vcmVkdXgtdG9vbGtpdC5qcy5vcmcvdXNhZ2UvdXNhZ2UtZ3VpZGUjd29ya2luZy13aXRoLW5vbi1zZXJpYWxpemFibGUtZGF0YSkiKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoIWlnbm9yZVN0YXRlKSB7CiAgICAgICAgbWVhc3VyZVV0aWxzLm1lYXN1cmVUaW1lKCgpID0+IHsKICAgICAgICAgIGNvbnN0IHN0YXRlID0gc3RvcmVBUEkuZ2V0U3RhdGUoKTsKICAgICAgICAgIGNvbnN0IGZvdW5kU3RhdGVOb25TZXJpYWxpemFibGVWYWx1ZSA9IGZpbmROb25TZXJpYWxpemFibGVWYWx1ZShzdGF0ZSwgIiIsIGlzU2VyaWFsaXphYmxlLCBnZXRFbnRyaWVzLCBpZ25vcmVkUGF0aHMsIGNhY2hlKTsKICAgICAgICAgIGlmIChmb3VuZFN0YXRlTm9uU2VyaWFsaXphYmxlVmFsdWUpIHsKICAgICAgICAgICAgY29uc3QgewogICAgICAgICAgICAgIGtleVBhdGgsCiAgICAgICAgICAgICAgdmFsdWUKICAgICAgICAgICAgfSA9IGZvdW5kU3RhdGVOb25TZXJpYWxpemFibGVWYWx1ZTsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgQSBub24tc2VyaWFsaXphYmxlIHZhbHVlIHdhcyBkZXRlY3RlZCBpbiB0aGUgc3RhdGUsIGluIHRoZSBwYXRoOiBcYCR7a2V5UGF0aH1cYC4gVmFsdWU6YCwgdmFsdWUsIGAKVGFrZSBhIGxvb2sgYXQgdGhlIHJlZHVjZXIocykgaGFuZGxpbmcgdGhpcyBhY3Rpb24gdHlwZTogJHthY3Rpb24udHlwZX0uCihTZWUgaHR0cHM6Ly9yZWR1eC5qcy5vcmcvZmFxL29yZ2FuaXppbmctc3RhdGUjY2FuLWktcHV0LWZ1bmN0aW9ucy1wcm9taXNlcy1vci1vdGhlci1ub24tc2VyaWFsaXphYmxlLWl0ZW1zLWluLW15LXN0b3JlLXN0YXRlKWApOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIG1lYXN1cmVVdGlscy53YXJuSWZFeGNlZWRlZCgpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KfQpmdW5jdGlvbiBpc0Jvb2xlYW4yKHgyKSB7CiAgcmV0dXJuIHR5cGVvZiB4MiA9PT0gImJvb2xlYW4iOwp9CnZhciBidWlsZEdldERlZmF1bHRNaWRkbGV3YXJlID0gKCkgPT4gZnVuY3Rpb24gZ2V0RGVmYXVsdE1pZGRsZXdhcmUob3B0aW9ucykgewogIGNvbnN0IHsKICAgIHRodW5rOiB0aHVuazIgPSB0cnVlLAogICAgaW1tdXRhYmxlQ2hlY2sgPSB0cnVlLAogICAgc2VyaWFsaXphYmxlQ2hlY2sgPSB0cnVlLAogICAgYWN0aW9uQ3JlYXRvckNoZWNrID0gdHJ1ZQogIH0gPSBvcHRpb25zID8/IHt9OwogIGxldCBtaWRkbGV3YXJlQXJyYXkgPSBuZXcgVHVwbGUoKTsKICBpZiAodGh1bmsyKSB7CiAgICBpZiAoaXNCb29sZWFuMih0aHVuazIpKSB7CiAgICAgIG1pZGRsZXdhcmVBcnJheS5wdXNoKHRodW5rKTsKICAgIH0gZWxzZSB7CiAgICAgIG1pZGRsZXdhcmVBcnJheS5wdXNoKHdpdGhFeHRyYUFyZ3VtZW50KHRodW5rMi5leHRyYUFyZ3VtZW50KSk7CiAgICB9CiAgfQogIGlmICh0cnVlKSB7CiAgICBpZiAoaW1tdXRhYmxlQ2hlY2spIHsKICAgICAgbGV0IGltbXV0YWJsZU9wdGlvbnMgPSB7fTsKICAgICAgaWYgKCFpc0Jvb2xlYW4yKGltbXV0YWJsZUNoZWNrKSkgewogICAgICAgIGltbXV0YWJsZU9wdGlvbnMgPSBpbW11dGFibGVDaGVjazsKICAgICAgfQogICAgICBtaWRkbGV3YXJlQXJyYXkudW5zaGlmdChjcmVhdGVJbW11dGFibGVTdGF0ZUludmFyaWFudE1pZGRsZXdhcmUoaW1tdXRhYmxlT3B0aW9ucykpOwogICAgfQogICAgaWYgKHNlcmlhbGl6YWJsZUNoZWNrKSB7CiAgICAgIGxldCBzZXJpYWxpemFibGVPcHRpb25zID0ge307CiAgICAgIGlmICghaXNCb29sZWFuMihzZXJpYWxpemFibGVDaGVjaykpIHsKICAgICAgICBzZXJpYWxpemFibGVPcHRpb25zID0gc2VyaWFsaXphYmxlQ2hlY2s7CiAgICAgIH0KICAgICAgbWlkZGxld2FyZUFycmF5LnB1c2goY3JlYXRlU2VyaWFsaXphYmxlU3RhdGVJbnZhcmlhbnRNaWRkbGV3YXJlKHNlcmlhbGl6YWJsZU9wdGlvbnMpKTsKICAgIH0KICAgIGlmIChhY3Rpb25DcmVhdG9yQ2hlY2spIHsKICAgICAgbGV0IGFjdGlvbkNyZWF0b3JPcHRpb25zID0ge307CiAgICAgIGlmICghaXNCb29sZWFuMihhY3Rpb25DcmVhdG9yQ2hlY2spKSB7CiAgICAgICAgYWN0aW9uQ3JlYXRvck9wdGlvbnMgPSBhY3Rpb25DcmVhdG9yQ2hlY2s7CiAgICAgIH0KICAgICAgbWlkZGxld2FyZUFycmF5LnVuc2hpZnQoY3JlYXRlQWN0aW9uQ3JlYXRvckludmFyaWFudE1pZGRsZXdhcmUoYWN0aW9uQ3JlYXRvck9wdGlvbnMpKTsKICAgIH0KICB9CiAgcmV0dXJuIG1pZGRsZXdhcmVBcnJheTsKfTsKdmFyIFNIT1VMRF9BVVRPQkFUQ0ggPSAiUlRLX2F1dG9CYXRjaCI7CnZhciBwcmVwYXJlQXV0b0JhdGNoZWQgPSAoKSA9PiAocGF5bG9hZCkgPT4gKHsKICBwYXlsb2FkLAogIG1ldGE6IHsKICAgIFtTSE9VTERfQVVUT0JBVENIXTogdHJ1ZQogIH0KfSk7CnZhciBjcmVhdGVRdWV1ZVdpdGhUaW1lciA9ICh0aW1lb3V0KSA9PiB7CiAgcmV0dXJuIChub3RpZnkpID0+IHsKICAgIHNldFRpbWVvdXQobm90aWZ5LCB0aW1lb3V0KTsKICB9Owp9Owp2YXIgYXV0b0JhdGNoRW5oYW5jZXIgPSAob3B0aW9ucyA9IHsKICB0eXBlOiAicmFmIgp9KSA9PiAobmV4dCkgPT4gKC4uLmFyZ3MpID0+IHsKICBjb25zdCBzdG9yZSA9IG5leHQoLi4uYXJncyk7CiAgbGV0IG5vdGlmeWluZyA9IHRydWU7CiAgbGV0IHNob3VsZE5vdGlmeUF0RW5kT2ZUaWNrID0gZmFsc2U7CiAgbGV0IG5vdGlmaWNhdGlvblF1ZXVlZCA9IGZhbHNlOwogIGNvbnN0IGxpc3RlbmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgY29uc3QgcXVldWVDYWxsYmFjayA9IG9wdGlvbnMudHlwZSA9PT0gInRpY2siID8gcXVldWVNaWNyb3Rhc2sgOiBvcHRpb25zLnR5cGUgPT09ICJyYWYiID8gKAogICAgLy8gcmVxdWVzdEFuaW1hdGlvbkZyYW1lIHdvbid0IGV4aXN0IGluIFNTUiBlbnZpcm9ubWVudHMuIEZhbGwgYmFjayB0byBhIHZhZ3VlIGFwcHJveGltYXRpb24ganVzdCB0byBrZWVwIGZyb20gZXJyb3JpbmcuCiAgICB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID8gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA6IGNyZWF0ZVF1ZXVlV2l0aFRpbWVyKDEwKQogICkgOiBvcHRpb25zLnR5cGUgPT09ICJjYWxsYmFjayIgPyBvcHRpb25zLnF1ZXVlTm90aWZpY2F0aW9uIDogY3JlYXRlUXVldWVXaXRoVGltZXIob3B0aW9ucy50aW1lb3V0KTsKICBjb25zdCBub3RpZnlMaXN0ZW5lcnMgPSAoKSA9PiB7CiAgICBub3RpZmljYXRpb25RdWV1ZWQgPSBmYWxzZTsKICAgIGlmIChzaG91bGROb3RpZnlBdEVuZE9mVGljaykgewogICAgICBzaG91bGROb3RpZnlBdEVuZE9mVGljayA9IGZhbHNlOwogICAgICBsaXN0ZW5lcnMuZm9yRWFjaCgobCkgPT4gbCgpKTsKICAgIH0KICB9OwogIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBzdG9yZSwgewogICAgLy8gT3ZlcnJpZGUgdGhlIGJhc2UgYHN0b3JlLnN1YnNjcmliZWAgbWV0aG9kIHRvIGtlZXAgb3JpZ2luYWwgbGlzdGVuZXJzCiAgICAvLyBmcm9tIHJ1bm5pbmcgaWYgd2UncmUgZGVsYXlpbmcgbm90aWZpY2F0aW9ucwogICAgc3Vic2NyaWJlKGxpc3RlbmVyMikgewogICAgICBjb25zdCB3cmFwcGVkTGlzdGVuZXIgPSAoKSA9PiBub3RpZnlpbmcgJiYgbGlzdGVuZXIyKCk7CiAgICAgIGNvbnN0IHVuc3Vic2NyaWJlID0gc3RvcmUuc3Vic2NyaWJlKHdyYXBwZWRMaXN0ZW5lcik7CiAgICAgIGxpc3RlbmVycy5hZGQobGlzdGVuZXIyKTsKICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICB1bnN1YnNjcmliZSgpOwogICAgICAgIGxpc3RlbmVycy5kZWxldGUobGlzdGVuZXIyKTsKICAgICAgfTsKICAgIH0sCiAgICAvLyBPdmVycmlkZSB0aGUgYmFzZSBgc3RvcmUuZGlzcGF0Y2hgIG1ldGhvZCBzbyB0aGF0IHdlIGNhbiBjaGVjayBhY3Rpb25zCiAgICAvLyBmb3IgdGhlIGBzaG91bGRBdXRvQmF0Y2hgIGZsYWcgYW5kIGRldGVybWluZSBpZiBiYXRjaGluZyBpcyBhY3RpdmUKICAgIGRpc3BhdGNoKGFjdGlvbikgewogICAgICB0cnkgewogICAgICAgIG5vdGlmeWluZyA9ICFhY3Rpb24/Lm1ldGE/LltTSE9VTERfQVVUT0JBVENIXTsKICAgICAgICBzaG91bGROb3RpZnlBdEVuZE9mVGljayA9ICFub3RpZnlpbmc7CiAgICAgICAgaWYgKHNob3VsZE5vdGlmeUF0RW5kT2ZUaWNrKSB7CiAgICAgICAgICBpZiAoIW5vdGlmaWNhdGlvblF1ZXVlZCkgewogICAgICAgICAgICBub3RpZmljYXRpb25RdWV1ZWQgPSB0cnVlOwogICAgICAgICAgICBxdWV1ZUNhbGxiYWNrKG5vdGlmeUxpc3RlbmVycyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdG9yZS5kaXNwYXRjaChhY3Rpb24pOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIG5vdGlmeWluZyA9IHRydWU7CiAgICAgIH0KICAgIH0KICB9KTsKfTsKdmFyIGJ1aWxkR2V0RGVmYXVsdEVuaGFuY2VycyA9IChtaWRkbGV3YXJlRW5oYW5jZXIpID0+IGZ1bmN0aW9uIGdldERlZmF1bHRFbmhhbmNlcnMob3B0aW9ucykgewogIGNvbnN0IHsKICAgIGF1dG9CYXRjaCA9IHRydWUKICB9ID0gb3B0aW9ucyA/PyB7fTsKICBsZXQgZW5oYW5jZXJBcnJheSA9IG5ldyBUdXBsZShtaWRkbGV3YXJlRW5oYW5jZXIpOwogIGlmIChhdXRvQmF0Y2gpIHsKICAgIGVuaGFuY2VyQXJyYXkucHVzaChhdXRvQmF0Y2hFbmhhbmNlcih0eXBlb2YgYXV0b0JhdGNoID09PSAib2JqZWN0IiA/IGF1dG9CYXRjaCA6IHZvaWQgMCkpOwogIH0KICByZXR1cm4gZW5oYW5jZXJBcnJheTsKfTsKZnVuY3Rpb24gY29uZmlndXJlU3RvcmUob3B0aW9ucykgewogIGNvbnN0IGdldERlZmF1bHRNaWRkbGV3YXJlID0gYnVpbGRHZXREZWZhdWx0TWlkZGxld2FyZSgpOwogIGNvbnN0IHsKICAgIHJlZHVjZXIgPSB2b2lkIDAsCiAgICBtaWRkbGV3YXJlLAogICAgZGV2VG9vbHMgPSB0cnVlLAogICAgZHVwbGljYXRlTWlkZGxld2FyZUNoZWNrID0gdHJ1ZSwKICAgIHByZWxvYWRlZFN0YXRlID0gdm9pZCAwLAogICAgZW5oYW5jZXJzID0gdm9pZCAwCiAgfSA9IG9wdGlvbnMgfHwge307CiAgbGV0IHJvb3RSZWR1Y2VyMjsKICBpZiAodHlwZW9mIHJlZHVjZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJvb3RSZWR1Y2VyMiA9IHJlZHVjZXI7CiAgfSBlbHNlIGlmIChpc1BsYWluT2JqZWN0KHJlZHVjZXIpKSB7CiAgICByb290UmVkdWNlcjIgPSBjb21iaW5lUmVkdWNlcnMocmVkdWNlcik7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMSkgOiAiYHJlZHVjZXJgIGlzIGEgcmVxdWlyZWQgYXJndW1lbnQsIGFuZCBtdXN0IGJlIGEgZnVuY3Rpb24gb3IgYW4gb2JqZWN0IG9mIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSBwYXNzZWQgdG8gY29tYmluZVJlZHVjZXJzIik7CiAgfQogIGlmIChtaWRkbGV3YXJlICYmIHR5cGVvZiBtaWRkbGV3YXJlICE9PSAiZnVuY3Rpb24iKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDIpIDogImBtaWRkbGV3YXJlYCBmaWVsZCBtdXN0IGJlIGEgY2FsbGJhY2siKTsKICB9CiAgbGV0IGZpbmFsTWlkZGxld2FyZTsKICBpZiAodHlwZW9mIG1pZGRsZXdhcmUgPT09ICJmdW5jdGlvbiIpIHsKICAgIGZpbmFsTWlkZGxld2FyZSA9IG1pZGRsZXdhcmUoZ2V0RGVmYXVsdE1pZGRsZXdhcmUpOwogICAgaWYgKCFBcnJheS5pc0FycmF5KGZpbmFsTWlkZGxld2FyZSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgzKSA6ICJ3aGVuIHVzaW5nIGEgbWlkZGxld2FyZSBidWlsZGVyIGZ1bmN0aW9uLCBhbiBhcnJheSBvZiBtaWRkbGV3YXJlIG11c3QgYmUgcmV0dXJuZWQiKTsKICAgIH0KICB9IGVsc2UgewogICAgZmluYWxNaWRkbGV3YXJlID0gZ2V0RGVmYXVsdE1pZGRsZXdhcmUoKTsKICB9CiAgaWYgKGZpbmFsTWlkZGxld2FyZS5zb21lKChpdGVtKSA9PiB0eXBlb2YgaXRlbSAhPT0gImZ1bmN0aW9uIikpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNCkgOiAiZWFjaCBtaWRkbGV3YXJlIHByb3ZpZGVkIHRvIGNvbmZpZ3VyZVN0b3JlIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogIH0KICBpZiAoZHVwbGljYXRlTWlkZGxld2FyZUNoZWNrKSB7CiAgICBsZXQgbWlkZGxld2FyZVJlZmVyZW5jZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgZmluYWxNaWRkbGV3YXJlLmZvckVhY2goKG1pZGRsZXdhcmUyKSA9PiB7CiAgICAgIGlmIChtaWRkbGV3YXJlUmVmZXJlbmNlcy5oYXMobWlkZGxld2FyZTIpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg0MikgOiAiRHVwbGljYXRlIG1pZGRsZXdhcmUgcmVmZXJlbmNlcyBmb3VuZCB3aGVuIGNyZWF0aW5nIHRoZSBzdG9yZS4gRW5zdXJlIHRoYXQgZWFjaCBtaWRkbGV3YXJlIGlzIG9ubHkgaW5jbHVkZWQgb25jZS4iKTsKICAgICAgfQogICAgICBtaWRkbGV3YXJlUmVmZXJlbmNlcy5hZGQobWlkZGxld2FyZTIpOwogICAgfSk7CiAgfQogIGxldCBmaW5hbENvbXBvc2UgPSBjb21wb3NlOwogIGlmIChkZXZUb29scykgewogICAgZmluYWxDb21wb3NlID0gY29tcG9zZVdpdGhEZXZUb29scyh7CiAgICAgIC8vIEVuYWJsZSBjYXB0dXJlIG9mIHN0YWNrIHRyYWNlcyBmb3IgZGlzcGF0Y2hlZCBSZWR1eCBhY3Rpb25zCiAgICAgIHRyYWNlOiB0cnVlLAogICAgICAuLi50eXBlb2YgZGV2VG9vbHMgPT09ICJvYmplY3QiICYmIGRldlRvb2xzCiAgICB9KTsKICB9CiAgY29uc3QgbWlkZGxld2FyZUVuaGFuY2VyID0gYXBwbHlNaWRkbGV3YXJlKC4uLmZpbmFsTWlkZGxld2FyZSk7CiAgY29uc3QgZ2V0RGVmYXVsdEVuaGFuY2VycyA9IGJ1aWxkR2V0RGVmYXVsdEVuaGFuY2VycyhtaWRkbGV3YXJlRW5oYW5jZXIpOwogIGlmIChlbmhhbmNlcnMgJiYgdHlwZW9mIGVuaGFuY2VycyAhPT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg1KSA6ICJgZW5oYW5jZXJzYCBmaWVsZCBtdXN0IGJlIGEgY2FsbGJhY2siKTsKICB9CiAgbGV0IHN0b3JlRW5oYW5jZXJzID0gdHlwZW9mIGVuaGFuY2VycyA9PT0gImZ1bmN0aW9uIiA/IGVuaGFuY2VycyhnZXREZWZhdWx0RW5oYW5jZXJzKSA6IGdldERlZmF1bHRFbmhhbmNlcnMoKTsKICBpZiAoIUFycmF5LmlzQXJyYXkoc3RvcmVFbmhhbmNlcnMpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDYpIDogImBlbmhhbmNlcnNgIGNhbGxiYWNrIG11c3QgcmV0dXJuIGFuIGFycmF5Iik7CiAgfQogIGlmIChzdG9yZUVuaGFuY2Vycy5zb21lKChpdGVtKSA9PiB0eXBlb2YgaXRlbSAhPT0gImZ1bmN0aW9uIikpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNykgOiAiZWFjaCBlbmhhbmNlciBwcm92aWRlZCB0byBjb25maWd1cmVTdG9yZSBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICB9CiAgaWYgKGZpbmFsTWlkZGxld2FyZS5sZW5ndGggJiYgIXN0b3JlRW5oYW5jZXJzLmluY2x1ZGVzKG1pZGRsZXdhcmVFbmhhbmNlcikpIHsKICAgIGNvbnNvbGUuZXJyb3IoIm1pZGRsZXdhcmVzIHdlcmUgcHJvdmlkZWQsIGJ1dCBtaWRkbGV3YXJlIGVuaGFuY2VyIHdhcyBub3QgaW5jbHVkZWQgaW4gZmluYWwgZW5oYW5jZXJzIC0gbWFrZSBzdXJlIHRvIGNhbGwgYGdldERlZmF1bHRFbmhhbmNlcnNgIik7CiAgfQogIGNvbnN0IGNvbXBvc2VkRW5oYW5jZXIgPSBmaW5hbENvbXBvc2UoLi4uc3RvcmVFbmhhbmNlcnMpOwogIHJldHVybiBjcmVhdGVTdG9yZShyb290UmVkdWNlcjIsIHByZWxvYWRlZFN0YXRlLCBjb21wb3NlZEVuaGFuY2VyKTsKfQpmdW5jdGlvbiBleGVjdXRlUmVkdWNlckJ1aWxkZXJDYWxsYmFjayhidWlsZGVyQ2FsbGJhY2spIHsKICBjb25zdCBhY3Rpb25zTWFwID0ge307CiAgY29uc3QgYWN0aW9uTWF0Y2hlcnMgPSBbXTsKICBsZXQgZGVmYXVsdENhc2VSZWR1Y2VyOwogIGNvbnN0IGJ1aWxkZXIgPSB7CiAgICBhZGRDYXNlKHR5cGVPckFjdGlvbkNyZWF0b3IsIHJlZHVjZXIpIHsKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBpZiAoYWN0aW9uTWF0Y2hlcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyNikgOiAiYGJ1aWxkZXIuYWRkQ2FzZWAgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGJlZm9yZSBjYWxsaW5nIGBidWlsZGVyLmFkZE1hdGNoZXJgIik7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZhdWx0Q2FzZVJlZHVjZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjcpIDogImBidWlsZGVyLmFkZENhc2VgIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBiZWZvcmUgY2FsbGluZyBgYnVpbGRlci5hZGREZWZhdWx0Q2FzZWAiKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgdHlwZSA9IHR5cGVvZiB0eXBlT3JBY3Rpb25DcmVhdG9yID09PSAic3RyaW5nIiA/IHR5cGVPckFjdGlvbkNyZWF0b3IgOiB0eXBlT3JBY3Rpb25DcmVhdG9yLnR5cGU7CiAgICAgIGlmICghdHlwZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjgpIDogImBidWlsZGVyLmFkZENhc2VgIGNhbm5vdCBiZSBjYWxsZWQgd2l0aCBhbiBlbXB0eSBhY3Rpb24gdHlwZSIpOwogICAgICB9CiAgICAgIGlmICh0eXBlIGluIGFjdGlvbnNNYXApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDI5KSA6IGBcYGJ1aWxkZXIuYWRkQ2FzZVxgIGNhbm5vdCBiZSBjYWxsZWQgd2l0aCB0d28gcmVkdWNlcnMgZm9yIHRoZSBzYW1lIGFjdGlvbiB0eXBlICcke3R5cGV9J2ApOwogICAgICB9CiAgICAgIGFjdGlvbnNNYXBbdHlwZV0gPSByZWR1Y2VyOwogICAgICByZXR1cm4gYnVpbGRlcjsKICAgIH0sCiAgICBhZGRBc3luY1RodW5rKGFzeW5jVGh1bmssIHJlZHVjZXJzKSB7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgaWYgKGRlZmF1bHRDYXNlUmVkdWNlcikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg0MykgOiAiYGJ1aWxkZXIuYWRkQXN5bmNUaHVua2Agc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGJlZm9yZSBjYWxsaW5nIGBidWlsZGVyLmFkZERlZmF1bHRDYXNlYCIpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAocmVkdWNlcnMucGVuZGluZykgYWN0aW9uc01hcFthc3luY1RodW5rLnBlbmRpbmcudHlwZV0gPSByZWR1Y2Vycy5wZW5kaW5nOwogICAgICBpZiAocmVkdWNlcnMucmVqZWN0ZWQpIGFjdGlvbnNNYXBbYXN5bmNUaHVuay5yZWplY3RlZC50eXBlXSA9IHJlZHVjZXJzLnJlamVjdGVkOwogICAgICBpZiAocmVkdWNlcnMuZnVsZmlsbGVkKSBhY3Rpb25zTWFwW2FzeW5jVGh1bmsuZnVsZmlsbGVkLnR5cGVdID0gcmVkdWNlcnMuZnVsZmlsbGVkOwogICAgICBpZiAocmVkdWNlcnMuc2V0dGxlZCkgYWN0aW9uTWF0Y2hlcnMucHVzaCh7CiAgICAgICAgbWF0Y2hlcjogYXN5bmNUaHVuay5zZXR0bGVkLAogICAgICAgIHJlZHVjZXI6IHJlZHVjZXJzLnNldHRsZWQKICAgICAgfSk7CiAgICAgIHJldHVybiBidWlsZGVyOwogICAgfSwKICAgIGFkZE1hdGNoZXIobWF0Y2hlciwgcmVkdWNlcikgewogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGlmIChkZWZhdWx0Q2FzZVJlZHVjZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMzApIDogImBidWlsZGVyLmFkZE1hdGNoZXJgIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBiZWZvcmUgY2FsbGluZyBgYnVpbGRlci5hZGREZWZhdWx0Q2FzZWAiKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYWN0aW9uTWF0Y2hlcnMucHVzaCh7CiAgICAgICAgbWF0Y2hlciwKICAgICAgICByZWR1Y2VyCiAgICAgIH0pOwogICAgICByZXR1cm4gYnVpbGRlcjsKICAgIH0sCiAgICBhZGREZWZhdWx0Q2FzZShyZWR1Y2VyKSB7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgaWYgKGRlZmF1bHRDYXNlUmVkdWNlcikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgzMSkgOiAiYGJ1aWxkZXIuYWRkRGVmYXVsdENhc2VgIGNhbiBvbmx5IGJlIGNhbGxlZCBvbmNlIik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGRlZmF1bHRDYXNlUmVkdWNlciA9IHJlZHVjZXI7CiAgICAgIHJldHVybiBidWlsZGVyOwogICAgfQogIH07CiAgYnVpbGRlckNhbGxiYWNrKGJ1aWxkZXIpOwogIHJldHVybiBbYWN0aW9uc01hcCwgYWN0aW9uTWF0Y2hlcnMsIGRlZmF1bHRDYXNlUmVkdWNlcl07Cn0KZnVuY3Rpb24gaXNTdGF0ZUZ1bmN0aW9uKHgyKSB7CiAgcmV0dXJuIHR5cGVvZiB4MiA9PT0gImZ1bmN0aW9uIjsKfQpmdW5jdGlvbiBjcmVhdGVSZWR1Y2VyKGluaXRpYWxTdGF0ZTEzLCBtYXBPckJ1aWxkZXJDYWxsYmFjaykgewogIGlmICh0cnVlKSB7CiAgICBpZiAodHlwZW9mIG1hcE9yQnVpbGRlckNhbGxiYWNrID09PSAib2JqZWN0IikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDgpIDogIlRoZSBvYmplY3Qgbm90YXRpb24gZm9yIGBjcmVhdGVSZWR1Y2VyYCBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgdXNlIHRoZSAnYnVpbGRlciBjYWxsYmFjaycgbm90YXRpb24gaW5zdGVhZDogaHR0cHM6Ly9yZWR1eC10b29sa2l0LmpzLm9yZy9hcGkvY3JlYXRlUmVkdWNlciIpOwogICAgfQogIH0KICBsZXQgW2FjdGlvbnNNYXAsIGZpbmFsQWN0aW9uTWF0Y2hlcnMsIGZpbmFsRGVmYXVsdENhc2VSZWR1Y2VyXSA9IGV4ZWN1dGVSZWR1Y2VyQnVpbGRlckNhbGxiYWNrKG1hcE9yQnVpbGRlckNhbGxiYWNrKTsKICBsZXQgZ2V0SW5pdGlhbFN0YXRlOwogIGlmIChpc1N0YXRlRnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpKSB7CiAgICBnZXRJbml0aWFsU3RhdGUgPSAoKSA9PiBmcmVlemVEcmFmdGFibGUoaW5pdGlhbFN0YXRlMTMoKSk7CiAgfSBlbHNlIHsKICAgIGNvbnN0IGZyb3plbkluaXRpYWxTdGF0ZSA9IGZyZWV6ZURyYWZ0YWJsZShpbml0aWFsU3RhdGUxMyk7CiAgICBnZXRJbml0aWFsU3RhdGUgPSAoKSA9PiBmcm96ZW5Jbml0aWFsU3RhdGU7CiAgfQogIGZ1bmN0aW9uIHJlZHVjZXIoc3RhdGUgPSBnZXRJbml0aWFsU3RhdGUoKSwgYWN0aW9uKSB7CiAgICBsZXQgY2FzZVJlZHVjZXJzID0gW2FjdGlvbnNNYXBbYWN0aW9uLnR5cGVdLCAuLi5maW5hbEFjdGlvbk1hdGNoZXJzLmZpbHRlcigoewogICAgICBtYXRjaGVyCiAgICB9KSA9PiBtYXRjaGVyKGFjdGlvbikpLm1hcCgoewogICAgICByZWR1Y2VyOiByZWR1Y2VyMgogICAgfSkgPT4gcmVkdWNlcjIpXTsKICAgIGlmIChjYXNlUmVkdWNlcnMuZmlsdGVyKChjcikgPT4gISFjcikubGVuZ3RoID09PSAwKSB7CiAgICAgIGNhc2VSZWR1Y2VycyA9IFtmaW5hbERlZmF1bHRDYXNlUmVkdWNlcl07CiAgICB9CiAgICByZXR1cm4gY2FzZVJlZHVjZXJzLnJlZHVjZSgocHJldmlvdXNTdGF0ZSwgY2FzZVJlZHVjZXIpID0+IHsKICAgICAgaWYgKGNhc2VSZWR1Y2VyKSB7CiAgICAgICAgaWYgKGlzRHJhZnQocHJldmlvdXNTdGF0ZSkpIHsKICAgICAgICAgIGNvbnN0IGRyYWZ0ID0gcHJldmlvdXNTdGF0ZTsKICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNhc2VSZWR1Y2VyKGRyYWZ0LCBhY3Rpb24pOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBwcmV2aW91c1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9IGVsc2UgaWYgKCFpc0RyYWZ0YWJsZShwcmV2aW91c1N0YXRlKSkgewogICAgICAgICAgY29uc3QgcmVzdWx0ID0gY2FzZVJlZHVjZXIocHJldmlvdXNTdGF0ZSwgYWN0aW9uKTsKICAgICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAocHJldmlvdXNTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBwcmV2aW91c1N0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93IEVycm9yKCJBIGNhc2UgcmVkdWNlciBvbiBhIG5vbi1kcmFmdGFibGUgdmFsdWUgbXVzdCBub3QgcmV0dXJuIHVuZGVmaW5lZCIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHByb2R1Y2UocHJldmlvdXNTdGF0ZSwgKGRyYWZ0KSA9PiB7CiAgICAgICAgICAgIHJldHVybiBjYXNlUmVkdWNlcihkcmFmdCwgYWN0aW9uKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcHJldmlvdXNTdGF0ZTsKICAgIH0sIHN0YXRlKTsKICB9CiAgcmVkdWNlci5nZXRJbml0aWFsU3RhdGUgPSBnZXRJbml0aWFsU3RhdGU7CiAgcmV0dXJuIHJlZHVjZXI7Cn0KdmFyIG1hdGNoZXMgPSAobWF0Y2hlciwgYWN0aW9uKSA9PiB7CiAgaWYgKGhhc01hdGNoRnVuY3Rpb24obWF0Y2hlcikpIHsKICAgIHJldHVybiBtYXRjaGVyLm1hdGNoKGFjdGlvbik7CiAgfSBlbHNlIHsKICAgIHJldHVybiBtYXRjaGVyKGFjdGlvbik7CiAgfQp9OwpmdW5jdGlvbiBpc0FueU9mKC4uLm1hdGNoZXJzKSB7CiAgcmV0dXJuIChhY3Rpb24pID0+IHsKICAgIHJldHVybiBtYXRjaGVycy5zb21lKChtYXRjaGVyKSA9PiBtYXRjaGVzKG1hdGNoZXIsIGFjdGlvbikpOwogIH07Cn0KdmFyIHVybEFscGhhYmV0ID0gIk1vZHVsZVN5bWJoYXNPd25Qci0wMTIzNDU2Nzg5QUJDREVGR0hOUlZmZ2N0aVV2el9LcVlUSmtMeHBaWElqUVciOwp2YXIgbmFub2lkID0gKHNpemUgPSAyMSkgPT4gewogIGxldCBpZCA9ICIiOwogIGxldCBpID0gc2l6ZTsKICB3aGlsZSAoaS0tKSB7CiAgICBpZCArPSB1cmxBbHBoYWJldFtNYXRoLnJhbmRvbSgpICogNjQgfCAwXTsKICB9CiAgcmV0dXJuIGlkOwp9Owp2YXIgY29tbW9uUHJvcGVydGllcyA9IFsibmFtZSIsICJtZXNzYWdlIiwgInN0YWNrIiwgImNvZGUiXTsKdmFyIFJlamVjdFdpdGhWYWx1ZSA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihwYXlsb2FkLCBtZXRhKSB7CiAgICB0aGlzLnBheWxvYWQgPSBwYXlsb2FkOwogICAgdGhpcy5tZXRhID0gbWV0YTsKICB9CiAgLyoKICB0eXBlLW9ubHkgcHJvcGVydHkgdG8gZGlzdGluZ3Vpc2ggYmV0d2VlbiBSZWplY3RXaXRoVmFsdWUgYW5kIEZ1bGZpbGxXaXRoTWV0YQogIGRvZXMgbm90IGV4aXN0IGF0IHJ1bnRpbWUKICAqLwogIF90eXBlOwp9Owp2YXIgRnVsZmlsbFdpdGhNZXRhID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHBheWxvYWQsIG1ldGEpIHsKICAgIHRoaXMucGF5bG9hZCA9IHBheWxvYWQ7CiAgICB0aGlzLm1ldGEgPSBtZXRhOwogIH0KICAvKgogIHR5cGUtb25seSBwcm9wZXJ0eSB0byBkaXN0aW5ndWlzaCBiZXR3ZWVuIFJlamVjdFdpdGhWYWx1ZSBhbmQgRnVsZmlsbFdpdGhNZXRhCiAgZG9lcyBub3QgZXhpc3QgYXQgcnVudGltZQogICovCiAgX3R5cGU7Cn07CnZhciBtaW5pU2VyaWFsaXplRXJyb3IgPSAodmFsdWUpID0+IHsKICBpZiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgY29uc3Qgc2ltcGxlRXJyb3IgPSB7fTsKICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgY29tbW9uUHJvcGVydGllcykgewogICAgICBpZiAodHlwZW9mIHZhbHVlW3Byb3BlcnR5XSA9PT0gInN0cmluZyIpIHsKICAgICAgICBzaW1wbGVFcnJvcltwcm9wZXJ0eV0gPSB2YWx1ZVtwcm9wZXJ0eV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBzaW1wbGVFcnJvcjsKICB9CiAgcmV0dXJuIHsKICAgIG1lc3NhZ2U6IFN0cmluZyh2YWx1ZSkKICB9Owp9Owp2YXIgZXh0ZXJuYWxBYm9ydE1lc3NhZ2UgPSAiRXh0ZXJuYWwgc2lnbmFsIHdhcyBhYm9ydGVkIjsKdmFyIGNyZWF0ZUFzeW5jVGh1bmsgPSAvKiBAX19QVVJFX18gKi8gKCgpID0+IHsKICBmdW5jdGlvbiBjcmVhdGVBc3luY1RodW5rMih0eXBlUHJlZml4LCBwYXlsb2FkQ3JlYXRvciwgb3B0aW9ucykgewogICAgY29uc3QgZnVsZmlsbGVkID0gY3JlYXRlQWN0aW9uKHR5cGVQcmVmaXggKyAiL2Z1bGZpbGxlZCIsIChwYXlsb2FkLCByZXF1ZXN0SWQsIGFyZywgbWV0YSkgPT4gKHsKICAgICAgcGF5bG9hZCwKICAgICAgbWV0YTogewogICAgICAgIC4uLm1ldGEgfHwge30sCiAgICAgICAgYXJnLAogICAgICAgIHJlcXVlc3RJZCwKICAgICAgICByZXF1ZXN0U3RhdHVzOiAiZnVsZmlsbGVkIgogICAgICB9CiAgICB9KSk7CiAgICBjb25zdCBwZW5kaW5nID0gY3JlYXRlQWN0aW9uKHR5cGVQcmVmaXggKyAiL3BlbmRpbmciLCAocmVxdWVzdElkLCBhcmcsIG1ldGEpID0+ICh7CiAgICAgIHBheWxvYWQ6IHZvaWQgMCwKICAgICAgbWV0YTogewogICAgICAgIC4uLm1ldGEgfHwge30sCiAgICAgICAgYXJnLAogICAgICAgIHJlcXVlc3RJZCwKICAgICAgICByZXF1ZXN0U3RhdHVzOiAicGVuZGluZyIKICAgICAgfQogICAgfSkpOwogICAgY29uc3QgcmVqZWN0ZWQgPSBjcmVhdGVBY3Rpb24odHlwZVByZWZpeCArICIvcmVqZWN0ZWQiLCAoZXJyb3IsIHJlcXVlc3RJZCwgYXJnLCBwYXlsb2FkLCBtZXRhKSA9PiAoewogICAgICBwYXlsb2FkLAogICAgICBlcnJvcjogKG9wdGlvbnMgJiYgb3B0aW9ucy5zZXJpYWxpemVFcnJvciB8fCBtaW5pU2VyaWFsaXplRXJyb3IpKGVycm9yIHx8ICJSZWplY3RlZCIpLAogICAgICBtZXRhOiB7CiAgICAgICAgLi4ubWV0YSB8fCB7fSwKICAgICAgICBhcmcsCiAgICAgICAgcmVxdWVzdElkLAogICAgICAgIHJlamVjdGVkV2l0aFZhbHVlOiAhIXBheWxvYWQsCiAgICAgICAgcmVxdWVzdFN0YXR1czogInJlamVjdGVkIiwKICAgICAgICBhYm9ydGVkOiBlcnJvcj8ubmFtZSA9PT0gIkFib3J0RXJyb3IiLAogICAgICAgIGNvbmRpdGlvbjogZXJyb3I/Lm5hbWUgPT09ICJDb25kaXRpb25FcnJvciIKICAgICAgfQogICAgfSkpOwogICAgZnVuY3Rpb24gYWN0aW9uQ3JlYXRvcihhcmcsIHsKICAgICAgc2lnbmFsCiAgICB9ID0ge30pIHsKICAgICAgcmV0dXJuIChkaXNwYXRjaCwgZ2V0U3RhdGUsIGV4dHJhKSA9PiB7CiAgICAgICAgY29uc3QgcmVxdWVzdElkID0gb3B0aW9ucz8uaWRHZW5lcmF0b3IgPyBvcHRpb25zLmlkR2VuZXJhdG9yKGFyZykgOiBuYW5vaWQoKTsKICAgICAgICBjb25zdCBhYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICAgICAgbGV0IGFib3J0SGFuZGxlcjsKICAgICAgICBsZXQgYWJvcnRSZWFzb247CiAgICAgICAgZnVuY3Rpb24gYWJvcnQocmVhc29uKSB7CiAgICAgICAgICBhYm9ydFJlYXNvbiA9IHJlYXNvbjsKICAgICAgICAgIGFib3J0Q29udHJvbGxlci5hYm9ydCgpOwogICAgICAgIH0KICAgICAgICBpZiAoc2lnbmFsKSB7CiAgICAgICAgICBpZiAoc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgICAgICAgYWJvcnQoZXh0ZXJuYWxBYm9ydE1lc3NhZ2UpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoImFib3J0IiwgKCkgPT4gYWJvcnQoZXh0ZXJuYWxBYm9ydE1lc3NhZ2UpLCB7CiAgICAgICAgICAgICAgb25jZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgcHJvbWlzZSA9IGFzeW5jIGZ1bmN0aW9uKCkgewogICAgICAgICAgbGV0IGZpbmFsQWN0aW9uOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbGV0IGNvbmRpdGlvblJlc3VsdCA9IG9wdGlvbnM/LmNvbmRpdGlvbj8uKGFyZywgewogICAgICAgICAgICAgIGdldFN0YXRlLAogICAgICAgICAgICAgIGV4dHJhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoaXNUaGVuYWJsZShjb25kaXRpb25SZXN1bHQpKSB7CiAgICAgICAgICAgICAgY29uZGl0aW9uUmVzdWx0ID0gYXdhaXQgY29uZGl0aW9uUmVzdWx0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb25kaXRpb25SZXN1bHQgPT09IGZhbHNlIHx8IGFib3J0Q29udHJvbGxlci5zaWduYWwuYWJvcnRlZCkgewogICAgICAgICAgICAgIHRocm93IHsKICAgICAgICAgICAgICAgIG5hbWU6ICJDb25kaXRpb25FcnJvciIsCiAgICAgICAgICAgICAgICBtZXNzYWdlOiAiQWJvcnRlZCBkdWUgdG8gY29uZGl0aW9uIGNhbGxiYWNrIHJldHVybmluZyBmYWxzZS4iCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBhYm9ydGVkUHJvbWlzZSA9IG5ldyBQcm9taXNlKChfLCByZWplY3QpID0+IHsKICAgICAgICAgICAgICBhYm9ydEhhbmRsZXIgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICByZWplY3QoewogICAgICAgICAgICAgICAgICBuYW1lOiAiQWJvcnRFcnJvciIsCiAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGFib3J0UmVhc29uIHx8ICJBYm9ydGVkIgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBhYm9ydENvbnRyb2xsZXIuc2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoImFib3J0IiwgYWJvcnRIYW5kbGVyKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRpc3BhdGNoKHBlbmRpbmcocmVxdWVzdElkLCBhcmcsIG9wdGlvbnM/LmdldFBlbmRpbmdNZXRhPy4oewogICAgICAgICAgICAgIHJlcXVlc3RJZCwKICAgICAgICAgICAgICBhcmcKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgIGdldFN0YXRlLAogICAgICAgICAgICAgIGV4dHJhCiAgICAgICAgICAgIH0pKSk7CiAgICAgICAgICAgIGZpbmFsQWN0aW9uID0gYXdhaXQgUHJvbWlzZS5yYWNlKFthYm9ydGVkUHJvbWlzZSwgUHJvbWlzZS5yZXNvbHZlKHBheWxvYWRDcmVhdG9yKGFyZywgewogICAgICAgICAgICAgIGRpc3BhdGNoLAogICAgICAgICAgICAgIGdldFN0YXRlLAogICAgICAgICAgICAgIGV4dHJhLAogICAgICAgICAgICAgIHJlcXVlc3RJZCwKICAgICAgICAgICAgICBzaWduYWw6IGFib3J0Q29udHJvbGxlci5zaWduYWwsCiAgICAgICAgICAgICAgYWJvcnQsCiAgICAgICAgICAgICAgcmVqZWN0V2l0aFZhbHVlOiAodmFsdWUsIG1ldGEpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUmVqZWN0V2l0aFZhbHVlKHZhbHVlLCBtZXRhKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZ1bGZpbGxXaXRoVmFsdWU6ICh2YWx1ZSwgbWV0YSkgPT4gewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBGdWxmaWxsV2l0aE1ldGEodmFsdWUsIG1ldGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpLnRoZW4oKHJlc3VsdCkgPT4gewogICAgICAgICAgICAgIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBSZWplY3RXaXRoVmFsdWUpIHsKICAgICAgICAgICAgICAgIHRocm93IHJlc3VsdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIEZ1bGZpbGxXaXRoTWV0YSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bGZpbGxlZChyZXN1bHQucGF5bG9hZCwgcmVxdWVzdElkLCBhcmcsIHJlc3VsdC5tZXRhKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZ1bGZpbGxlZChyZXN1bHQsIHJlcXVlc3RJZCwgYXJnKTsKICAgICAgICAgICAgfSldKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICBmaW5hbEFjdGlvbiA9IGVyciBpbnN0YW5jZW9mIFJlamVjdFdpdGhWYWx1ZSA/IHJlamVjdGVkKG51bGwsIHJlcXVlc3RJZCwgYXJnLCBlcnIucGF5bG9hZCwgZXJyLm1ldGEpIDogcmVqZWN0ZWQoZXJyLCByZXF1ZXN0SWQsIGFyZyk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBpZiAoYWJvcnRIYW5kbGVyKSB7CiAgICAgICAgICAgICAgYWJvcnRDb250cm9sbGVyLnNpZ25hbC5yZW1vdmVFdmVudExpc3RlbmVyKCJhYm9ydCIsIGFib3J0SGFuZGxlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHNraXBEaXNwYXRjaCA9IG9wdGlvbnMgJiYgIW9wdGlvbnMuZGlzcGF0Y2hDb25kaXRpb25SZWplY3Rpb24gJiYgcmVqZWN0ZWQubWF0Y2goZmluYWxBY3Rpb24pICYmIGZpbmFsQWN0aW9uLm1ldGEuY29uZGl0aW9uOwogICAgICAgICAgaWYgKCFza2lwRGlzcGF0Y2gpIHsKICAgICAgICAgICAgZGlzcGF0Y2goZmluYWxBY3Rpb24pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZpbmFsQWN0aW9uOwogICAgICAgIH0oKTsKICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihwcm9taXNlLCB7CiAgICAgICAgICBhYm9ydCwKICAgICAgICAgIHJlcXVlc3RJZCwKICAgICAgICAgIGFyZywKICAgICAgICAgIHVud3JhcCgpIHsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2UudGhlbih1bndyYXBSZXN1bHQpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9OwogICAgfQogICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oYWN0aW9uQ3JlYXRvciwgewogICAgICBwZW5kaW5nLAogICAgICByZWplY3RlZCwKICAgICAgZnVsZmlsbGVkLAogICAgICBzZXR0bGVkOiBpc0FueU9mKHJlamVjdGVkLCBmdWxmaWxsZWQpLAogICAgICB0eXBlUHJlZml4CiAgICB9KTsKICB9CiAgY3JlYXRlQXN5bmNUaHVuazIud2l0aFR5cGVzID0gKCkgPT4gY3JlYXRlQXN5bmNUaHVuazI7CiAgcmV0dXJuIGNyZWF0ZUFzeW5jVGh1bmsyOwp9KSgpOwpmdW5jdGlvbiB1bndyYXBSZXN1bHQoYWN0aW9uKSB7CiAgaWYgKGFjdGlvbi5tZXRhICYmIGFjdGlvbi5tZXRhLnJlamVjdGVkV2l0aFZhbHVlKSB7CiAgICB0aHJvdyBhY3Rpb24ucGF5bG9hZDsKICB9CiAgaWYgKGFjdGlvbi5lcnJvcikgewogICAgdGhyb3cgYWN0aW9uLmVycm9yOwogIH0KICByZXR1cm4gYWN0aW9uLnBheWxvYWQ7Cn0KZnVuY3Rpb24gaXNUaGVuYWJsZSh2YWx1ZSkgewogIHJldHVybiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB2YWx1ZS50aGVuID09PSAiZnVuY3Rpb24iOwp9CnZhciBhc3luY1RodW5rU3ltYm9sID0gLyogQF9fUFVSRV9fICovIFN5bWJvbC5mb3IoInJ0ay1zbGljZS1jcmVhdGVhc3luY3RodW5rIik7CnZhciBhc3luY1RodW5rQ3JlYXRvciA9IHsKICBbYXN5bmNUaHVua1N5bWJvbF06IGNyZWF0ZUFzeW5jVGh1bmsKfTsKZnVuY3Rpb24gZ2V0VHlwZShzbGljZTIsIGFjdGlvbktleSkgewogIHJldHVybiBgJHtzbGljZTJ9LyR7YWN0aW9uS2V5fWA7Cn0KZnVuY3Rpb24gYnVpbGRDcmVhdGVTbGljZSh7CiAgY3JlYXRvcnMKfSA9IHt9KSB7CiAgY29uc3QgY0FUID0gY3JlYXRvcnM/LmFzeW5jVGh1bms/Llthc3luY1RodW5rU3ltYm9sXTsKICByZXR1cm4gZnVuY3Rpb24gY3JlYXRlU2xpY2UyKG9wdGlvbnMpIHsKICAgIGNvbnN0IHsKICAgICAgbmFtZSwKICAgICAgcmVkdWNlclBhdGggPSBuYW1lCiAgICB9ID0gb3B0aW9uczsKICAgIGlmICghbmFtZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDExKSA6ICJgbmFtZWAgaXMgYSByZXF1aXJlZCBvcHRpb24gZm9yIGNyZWF0ZVNsaWNlIik7CiAgICB9CiAgICBpZiAodHlwZW9mIHByb2Nlc3MgIT09ICJ1bmRlZmluZWQiICYmIHRydWUpIHsKICAgICAgaWYgKG9wdGlvbnMuaW5pdGlhbFN0YXRlID09PSB2b2lkIDApIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJZb3UgbXVzdCBwcm92aWRlIGFuIGBpbml0aWFsU3RhdGVgIHZhbHVlIHRoYXQgaXMgbm90IGB1bmRlZmluZWRgLiBZb3UgbWF5IGhhdmUgbWlzc3BlbGxlZCBgaW5pdGlhbFN0YXRlYCIpOwogICAgICB9CiAgICB9CiAgICBjb25zdCByZWR1Y2VycyA9ICh0eXBlb2Ygb3B0aW9ucy5yZWR1Y2VycyA9PT0gImZ1bmN0aW9uIiA/IG9wdGlvbnMucmVkdWNlcnMoYnVpbGRSZWR1Y2VyQ3JlYXRvcnMoKSkgOiBvcHRpb25zLnJlZHVjZXJzKSB8fCB7fTsKICAgIGNvbnN0IHJlZHVjZXJOYW1lcyA9IE9iamVjdC5rZXlzKHJlZHVjZXJzKTsKICAgIGNvbnN0IGNvbnRleHQgPSB7CiAgICAgIHNsaWNlQ2FzZVJlZHVjZXJzQnlOYW1lOiB7fSwKICAgICAgc2xpY2VDYXNlUmVkdWNlcnNCeVR5cGU6IHt9LAogICAgICBhY3Rpb25DcmVhdG9yczoge30sCiAgICAgIHNsaWNlTWF0Y2hlcnM6IFtdCiAgICB9OwogICAgY29uc3QgY29udGV4dE1ldGhvZHMgPSB7CiAgICAgIGFkZENhc2UodHlwZU9yQWN0aW9uQ3JlYXRvciwgcmVkdWNlcjIpIHsKICAgICAgICBjb25zdCB0eXBlID0gdHlwZW9mIHR5cGVPckFjdGlvbkNyZWF0b3IgPT09ICJzdHJpbmciID8gdHlwZU9yQWN0aW9uQ3JlYXRvciA6IHR5cGVPckFjdGlvbkNyZWF0b3IudHlwZTsKICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTIpIDogImBjb250ZXh0LmFkZENhc2VgIGNhbm5vdCBiZSBjYWxsZWQgd2l0aCBhbiBlbXB0eSBhY3Rpb24gdHlwZSIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZSBpbiBjb250ZXh0LnNsaWNlQ2FzZVJlZHVjZXJzQnlUeXBlKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEzKSA6ICJgY29udGV4dC5hZGRDYXNlYCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggdHdvIHJlZHVjZXJzIGZvciB0aGUgc2FtZSBhY3Rpb24gdHlwZTogIiArIHR5cGUpOwogICAgICAgIH0KICAgICAgICBjb250ZXh0LnNsaWNlQ2FzZVJlZHVjZXJzQnlUeXBlW3R5cGVdID0gcmVkdWNlcjI7CiAgICAgICAgcmV0dXJuIGNvbnRleHRNZXRob2RzOwogICAgICB9LAogICAgICBhZGRNYXRjaGVyKG1hdGNoZXIsIHJlZHVjZXIyKSB7CiAgICAgICAgY29udGV4dC5zbGljZU1hdGNoZXJzLnB1c2goewogICAgICAgICAgbWF0Y2hlciwKICAgICAgICAgIHJlZHVjZXI6IHJlZHVjZXIyCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGNvbnRleHRNZXRob2RzOwogICAgICB9LAogICAgICBleHBvc2VBY3Rpb24obmFtZTIsIGFjdGlvbkNyZWF0b3IpIHsKICAgICAgICBjb250ZXh0LmFjdGlvbkNyZWF0b3JzW25hbWUyXSA9IGFjdGlvbkNyZWF0b3I7CiAgICAgICAgcmV0dXJuIGNvbnRleHRNZXRob2RzOwogICAgICB9LAogICAgICBleHBvc2VDYXNlUmVkdWNlcihuYW1lMiwgcmVkdWNlcjIpIHsKICAgICAgICBjb250ZXh0LnNsaWNlQ2FzZVJlZHVjZXJzQnlOYW1lW25hbWUyXSA9IHJlZHVjZXIyOwogICAgICAgIHJldHVybiBjb250ZXh0TWV0aG9kczsKICAgICAgfQogICAgfTsKICAgIHJlZHVjZXJOYW1lcy5mb3JFYWNoKChyZWR1Y2VyTmFtZSkgPT4gewogICAgICBjb25zdCByZWR1Y2VyRGVmaW5pdGlvbiA9IHJlZHVjZXJzW3JlZHVjZXJOYW1lXTsKICAgICAgY29uc3QgcmVkdWNlckRldGFpbHMgPSB7CiAgICAgICAgcmVkdWNlck5hbWUsCiAgICAgICAgdHlwZTogZ2V0VHlwZShuYW1lLCByZWR1Y2VyTmFtZSksCiAgICAgICAgY3JlYXRlTm90YXRpb246IHR5cGVvZiBvcHRpb25zLnJlZHVjZXJzID09PSAiZnVuY3Rpb24iCiAgICAgIH07CiAgICAgIGlmIChpc0FzeW5jVGh1bmtTbGljZVJlZHVjZXJEZWZpbml0aW9uKHJlZHVjZXJEZWZpbml0aW9uKSkgewogICAgICAgIGhhbmRsZVRodW5rQ2FzZVJlZHVjZXJEZWZpbml0aW9uKHJlZHVjZXJEZXRhaWxzLCByZWR1Y2VyRGVmaW5pdGlvbiwgY29udGV4dE1ldGhvZHMsIGNBVCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaGFuZGxlTm9ybWFsUmVkdWNlckRlZmluaXRpb24ocmVkdWNlckRldGFpbHMsIHJlZHVjZXJEZWZpbml0aW9uLCBjb250ZXh0TWV0aG9kcyk7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gYnVpbGRSZWR1Y2VyKCkgewogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5leHRyYVJlZHVjZXJzID09PSAib2JqZWN0IikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNCkgOiAiVGhlIG9iamVjdCBub3RhdGlvbiBmb3IgYGNyZWF0ZVNsaWNlLmV4dHJhUmVkdWNlcnNgIGhhcyBiZWVuIHJlbW92ZWQuIFBsZWFzZSB1c2UgdGhlICdidWlsZGVyIGNhbGxiYWNrJyBub3RhdGlvbiBpbnN0ZWFkOiBodHRwczovL3JlZHV4LXRvb2xraXQuanMub3JnL2FwaS9jcmVhdGVTbGljZSIpOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCBbZXh0cmFSZWR1Y2VycyA9IHt9LCBhY3Rpb25NYXRjaGVycyA9IFtdLCBkZWZhdWx0Q2FzZVJlZHVjZXIgPSB2b2lkIDBdID0gdHlwZW9mIG9wdGlvbnMuZXh0cmFSZWR1Y2VycyA9PT0gImZ1bmN0aW9uIiA/IGV4ZWN1dGVSZWR1Y2VyQnVpbGRlckNhbGxiYWNrKG9wdGlvbnMuZXh0cmFSZWR1Y2VycykgOiBbb3B0aW9ucy5leHRyYVJlZHVjZXJzXTsKICAgICAgY29uc3QgZmluYWxDYXNlUmVkdWNlcnMgPSB7CiAgICAgICAgLi4uZXh0cmFSZWR1Y2VycywKICAgICAgICAuLi5jb250ZXh0LnNsaWNlQ2FzZVJlZHVjZXJzQnlUeXBlCiAgICAgIH07CiAgICAgIHJldHVybiBjcmVhdGVSZWR1Y2VyKG9wdGlvbnMuaW5pdGlhbFN0YXRlLCAoYnVpbGRlcikgPT4gewogICAgICAgIGZvciAobGV0IGtleSBpbiBmaW5hbENhc2VSZWR1Y2VycykgewogICAgICAgICAgYnVpbGRlci5hZGRDYXNlKGtleSwgZmluYWxDYXNlUmVkdWNlcnNba2V5XSk7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IHNNIG9mIGNvbnRleHQuc2xpY2VNYXRjaGVycykgewogICAgICAgICAgYnVpbGRlci5hZGRNYXRjaGVyKHNNLm1hdGNoZXIsIHNNLnJlZHVjZXIpOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBtIG9mIGFjdGlvbk1hdGNoZXJzKSB7CiAgICAgICAgICBidWlsZGVyLmFkZE1hdGNoZXIobS5tYXRjaGVyLCBtLnJlZHVjZXIpOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmYXVsdENhc2VSZWR1Y2VyKSB7CiAgICAgICAgICBidWlsZGVyLmFkZERlZmF1bHRDYXNlKGRlZmF1bHRDYXNlUmVkdWNlcik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IHNlbGVjdFNlbGYgPSAoc3RhdGUpID0+IHN0YXRlOwogICAgY29uc3QgaW5qZWN0ZWRTZWxlY3RvckNhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGNvbnN0IGluamVjdGVkU3RhdGVDYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwogICAgbGV0IF9yZWR1Y2VyOwogICAgZnVuY3Rpb24gcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIGlmICghX3JlZHVjZXIpIF9yZWR1Y2VyID0gYnVpbGRSZWR1Y2VyKCk7CiAgICAgIHJldHVybiBfcmVkdWNlcihzdGF0ZSwgYWN0aW9uKTsKICAgIH0KICAgIGZ1bmN0aW9uIGdldEluaXRpYWxTdGF0ZSgpIHsKICAgICAgaWYgKCFfcmVkdWNlcikgX3JlZHVjZXIgPSBidWlsZFJlZHVjZXIoKTsKICAgICAgcmV0dXJuIF9yZWR1Y2VyLmdldEluaXRpYWxTdGF0ZSgpOwogICAgfQogICAgZnVuY3Rpb24gbWFrZVNlbGVjdG9yUHJvcHMocmVkdWNlclBhdGgyLCBpbmplY3RlZCA9IGZhbHNlKSB7CiAgICAgIGZ1bmN0aW9uIHNlbGVjdFNsaWNlKHN0YXRlKSB7CiAgICAgICAgbGV0IHNsaWNlU3RhdGUgPSBzdGF0ZVtyZWR1Y2VyUGF0aDJdOwogICAgICAgIGlmICh0eXBlb2Ygc2xpY2VTdGF0ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIGlmIChpbmplY3RlZCkgewogICAgICAgICAgICBzbGljZVN0YXRlID0gZ2V0T3JJbnNlcnRDb21wdXRlZChpbmplY3RlZFN0YXRlQ2FjaGUsIHNlbGVjdFNsaWNlLCBnZXRJbml0aWFsU3RhdGUpOwogICAgICAgICAgfSBlbHNlIGlmICh0cnVlKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTUpIDogInNlbGVjdFNsaWNlIHJldHVybmVkIHVuZGVmaW5lZCBmb3IgYW4gdW5pbmplY3RlZCBzbGljZSByZWR1Y2VyIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzbGljZVN0YXRlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdG9ycyhzZWxlY3RTdGF0ZSA9IHNlbGVjdFNlbGYpIHsKICAgICAgICBjb25zdCBzZWxlY3RvckNhY2hlID0gZ2V0T3JJbnNlcnRDb21wdXRlZChpbmplY3RlZFNlbGVjdG9yQ2FjaGUsIGluamVjdGVkLCAoKSA9PiAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKSk7CiAgICAgICAgcmV0dXJuIGdldE9ySW5zZXJ0Q29tcHV0ZWQoc2VsZWN0b3JDYWNoZSwgc2VsZWN0U3RhdGUsICgpID0+IHsKICAgICAgICAgIGNvbnN0IG1hcDMgPSB7fTsKICAgICAgICAgIGZvciAoY29uc3QgW25hbWUyLCBzZWxlY3Rvcl0gb2YgT2JqZWN0LmVudHJpZXMob3B0aW9ucy5zZWxlY3RvcnMgPz8ge30pKSB7CiAgICAgICAgICAgIG1hcDNbbmFtZTJdID0gd3JhcFNlbGVjdG9yKHNlbGVjdG9yLCBzZWxlY3RTdGF0ZSwgKCkgPT4gZ2V0T3JJbnNlcnRDb21wdXRlZChpbmplY3RlZFN0YXRlQ2FjaGUsIHNlbGVjdFN0YXRlLCBnZXRJbml0aWFsU3RhdGUpLCBpbmplY3RlZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWFwMzsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHJlZHVjZXJQYXRoOiByZWR1Y2VyUGF0aDIsCiAgICAgICAgZ2V0U2VsZWN0b3JzLAogICAgICAgIGdldCBzZWxlY3RvcnMoKSB7CiAgICAgICAgICByZXR1cm4gZ2V0U2VsZWN0b3JzKHNlbGVjdFNsaWNlKTsKICAgICAgICB9LAogICAgICAgIHNlbGVjdFNsaWNlCiAgICAgIH07CiAgICB9CiAgICBjb25zdCBzbGljZTIgPSB7CiAgICAgIG5hbWUsCiAgICAgIHJlZHVjZXIsCiAgICAgIGFjdGlvbnM6IGNvbnRleHQuYWN0aW9uQ3JlYXRvcnMsCiAgICAgIGNhc2VSZWR1Y2VyczogY29udGV4dC5zbGljZUNhc2VSZWR1Y2Vyc0J5TmFtZSwKICAgICAgZ2V0SW5pdGlhbFN0YXRlLAogICAgICAuLi5tYWtlU2VsZWN0b3JQcm9wcyhyZWR1Y2VyUGF0aCksCiAgICAgIGluamVjdEludG8oaW5qZWN0YWJsZSwgewogICAgICAgIHJlZHVjZXJQYXRoOiBwYXRoT3B0LAogICAgICAgIC4uLmNvbmZpZwogICAgICB9ID0ge30pIHsKICAgICAgICBjb25zdCBuZXdSZWR1Y2VyUGF0aCA9IHBhdGhPcHQgPz8gcmVkdWNlclBhdGg7CiAgICAgICAgaW5qZWN0YWJsZS5pbmplY3QoewogICAgICAgICAgcmVkdWNlclBhdGg6IG5ld1JlZHVjZXJQYXRoLAogICAgICAgICAgcmVkdWNlcgogICAgICAgIH0sIGNvbmZpZyk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIC4uLnNsaWNlMiwKICAgICAgICAgIC4uLm1ha2VTZWxlY3RvclByb3BzKG5ld1JlZHVjZXJQYXRoLCB0cnVlKQogICAgICAgIH07CiAgICAgIH0KICAgIH07CiAgICByZXR1cm4gc2xpY2UyOwogIH07Cn0KZnVuY3Rpb24gd3JhcFNlbGVjdG9yKHNlbGVjdG9yLCBzZWxlY3RTdGF0ZSwgZ2V0SW5pdGlhbFN0YXRlLCBpbmplY3RlZCkgewogIGZ1bmN0aW9uIHdyYXBwZXIocm9vdFN0YXRlLCAuLi5hcmdzKSB7CiAgICBsZXQgc2xpY2VTdGF0ZSA9IHNlbGVjdFN0YXRlKHJvb3RTdGF0ZSk7CiAgICBpZiAodHlwZW9mIHNsaWNlU3RhdGUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIGlmIChpbmplY3RlZCkgewogICAgICAgIHNsaWNlU3RhdGUgPSBnZXRJbml0aWFsU3RhdGUoKTsKICAgICAgfSBlbHNlIGlmICh0cnVlKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNikgOiAic2VsZWN0U3RhdGUgcmV0dXJuZWQgdW5kZWZpbmVkIGZvciBhbiB1bmluamVjdGVkIHNsaWNlIHJlZHVjZXIiKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHNlbGVjdG9yKHNsaWNlU3RhdGUsIC4uLmFyZ3MpOwogIH0KICB3cmFwcGVyLnVud3JhcHBlZCA9IHNlbGVjdG9yOwogIHJldHVybiB3cmFwcGVyOwp9CnZhciBjcmVhdGVTbGljZSA9IC8qIEBfX1BVUkVfXyAqLyBidWlsZENyZWF0ZVNsaWNlKCk7CmZ1bmN0aW9uIGJ1aWxkUmVkdWNlckNyZWF0b3JzKCkgewogIGZ1bmN0aW9uIGFzeW5jVGh1bmsocGF5bG9hZENyZWF0b3IsIGNvbmZpZykgewogICAgcmV0dXJuIHsKICAgICAgX3JlZHVjZXJEZWZpbml0aW9uVHlwZTogImFzeW5jVGh1bmsiLAogICAgICBwYXlsb2FkQ3JlYXRvciwKICAgICAgLi4uY29uZmlnCiAgICB9OwogIH0KICBhc3luY1RodW5rLndpdGhUeXBlcyA9ICgpID0+IGFzeW5jVGh1bms7CiAgcmV0dXJuIHsKICAgIHJlZHVjZXIoY2FzZVJlZHVjZXIpIHsKICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oewogICAgICAgIC8vIGhhY2sgc28gdGhlIHdyYXBwaW5nIGZ1bmN0aW9uIGhhcyB0aGUgc2FtZSBuYW1lIGFzIHRoZSBvcmlnaW5hbAogICAgICAgIC8vIHdlIG5lZWQgdG8gY3JlYXRlIGEgd3JhcHBlciBzbyB0aGUgYHJlZHVjZXJEZWZpbml0aW9uVHlwZWAgaXMgbm90IGFzc2lnbmVkIHRvIHRoZSBvcmlnaW5hbAogICAgICAgIFtjYXNlUmVkdWNlci5uYW1lXSguLi5hcmdzKSB7CiAgICAgICAgICByZXR1cm4gY2FzZVJlZHVjZXIoLi4uYXJncyk7CiAgICAgICAgfQogICAgICB9W2Nhc2VSZWR1Y2VyLm5hbWVdLCB7CiAgICAgICAgX3JlZHVjZXJEZWZpbml0aW9uVHlwZTogInJlZHVjZXIiCiAgICAgICAgLyogcmVkdWNlciAqLwogICAgICB9KTsKICAgIH0sCiAgICBwcmVwYXJlZFJlZHVjZXIocHJlcGFyZSwgcmVkdWNlcikgewogICAgICByZXR1cm4gewogICAgICAgIF9yZWR1Y2VyRGVmaW5pdGlvblR5cGU6ICJyZWR1Y2VyV2l0aFByZXBhcmUiLAogICAgICAgIHByZXBhcmUsCiAgICAgICAgcmVkdWNlcgogICAgICB9OwogICAgfSwKICAgIGFzeW5jVGh1bmsKICB9Owp9CmZ1bmN0aW9uIGhhbmRsZU5vcm1hbFJlZHVjZXJEZWZpbml0aW9uKHsKICB0eXBlLAogIHJlZHVjZXJOYW1lLAogIGNyZWF0ZU5vdGF0aW9uCn0sIG1heWJlUmVkdWNlcldpdGhQcmVwYXJlLCBjb250ZXh0KSB7CiAgbGV0IGNhc2VSZWR1Y2VyOwogIGxldCBwcmVwYXJlQ2FsbGJhY2s7CiAgaWYgKCJyZWR1Y2VyIiBpbiBtYXliZVJlZHVjZXJXaXRoUHJlcGFyZSkgewogICAgaWYgKGNyZWF0ZU5vdGF0aW9uICYmICFpc0Nhc2VSZWR1Y2VyV2l0aFByZXBhcmVEZWZpbml0aW9uKG1heWJlUmVkdWNlcldpdGhQcmVwYXJlKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE3KSA6ICJQbGVhc2UgdXNlIHRoZSBgY3JlYXRlLnByZXBhcmVkUmVkdWNlcmAgbm90YXRpb24gZm9yIHByZXBhcmVkIGFjdGlvbiBjcmVhdG9ycyB3aXRoIHRoZSBgY3JlYXRlYCBub3RhdGlvbi4iKTsKICAgIH0KICAgIGNhc2VSZWR1Y2VyID0gbWF5YmVSZWR1Y2VyV2l0aFByZXBhcmUucmVkdWNlcjsKICAgIHByZXBhcmVDYWxsYmFjayA9IG1heWJlUmVkdWNlcldpdGhQcmVwYXJlLnByZXBhcmU7CiAgfSBlbHNlIHsKICAgIGNhc2VSZWR1Y2VyID0gbWF5YmVSZWR1Y2VyV2l0aFByZXBhcmU7CiAgfQogIGNvbnRleHQuYWRkQ2FzZSh0eXBlLCBjYXNlUmVkdWNlcikuZXhwb3NlQ2FzZVJlZHVjZXIocmVkdWNlck5hbWUsIGNhc2VSZWR1Y2VyKS5leHBvc2VBY3Rpb24ocmVkdWNlck5hbWUsIHByZXBhcmVDYWxsYmFjayA/IGNyZWF0ZUFjdGlvbih0eXBlLCBwcmVwYXJlQ2FsbGJhY2spIDogY3JlYXRlQWN0aW9uKHR5cGUpKTsKfQpmdW5jdGlvbiBpc0FzeW5jVGh1bmtTbGljZVJlZHVjZXJEZWZpbml0aW9uKHJlZHVjZXJEZWZpbml0aW9uKSB7CiAgcmV0dXJuIHJlZHVjZXJEZWZpbml0aW9uLl9yZWR1Y2VyRGVmaW5pdGlvblR5cGUgPT09ICJhc3luY1RodW5rIjsKfQpmdW5jdGlvbiBpc0Nhc2VSZWR1Y2VyV2l0aFByZXBhcmVEZWZpbml0aW9uKHJlZHVjZXJEZWZpbml0aW9uKSB7CiAgcmV0dXJuIHJlZHVjZXJEZWZpbml0aW9uLl9yZWR1Y2VyRGVmaW5pdGlvblR5cGUgPT09ICJyZWR1Y2VyV2l0aFByZXBhcmUiOwp9CmZ1bmN0aW9uIGhhbmRsZVRodW5rQ2FzZVJlZHVjZXJEZWZpbml0aW9uKHsKICB0eXBlLAogIHJlZHVjZXJOYW1lCn0sIHJlZHVjZXJEZWZpbml0aW9uLCBjb250ZXh0LCBjQVQpIHsKICBpZiAoIWNBVCkgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxOCkgOiAiQ2Fubm90IHVzZSBgY3JlYXRlLmFzeW5jVGh1bmtgIGluIHRoZSBidWlsdC1pbiBgY3JlYXRlU2xpY2VgLiBVc2UgYGJ1aWxkQ3JlYXRlU2xpY2UoeyBjcmVhdG9yczogeyBhc3luY1RodW5rOiBhc3luY1RodW5rQ3JlYXRvciB9IH0pYCB0byBjcmVhdGUgYSBjdXN0b21pc2VkIHZlcnNpb24gb2YgYGNyZWF0ZVNsaWNlYC4iKTsKICB9CiAgY29uc3QgewogICAgcGF5bG9hZENyZWF0b3IsCiAgICBmdWxmaWxsZWQsCiAgICBwZW5kaW5nLAogICAgcmVqZWN0ZWQsCiAgICBzZXR0bGVkLAogICAgb3B0aW9ucwogIH0gPSByZWR1Y2VyRGVmaW5pdGlvbjsKICBjb25zdCB0aHVuazIgPSBjQVQodHlwZSwgcGF5bG9hZENyZWF0b3IsIG9wdGlvbnMpOwogIGNvbnRleHQuZXhwb3NlQWN0aW9uKHJlZHVjZXJOYW1lLCB0aHVuazIpOwogIGlmIChmdWxmaWxsZWQpIHsKICAgIGNvbnRleHQuYWRkQ2FzZSh0aHVuazIuZnVsZmlsbGVkLCBmdWxmaWxsZWQpOwogIH0KICBpZiAocGVuZGluZykgewogICAgY29udGV4dC5hZGRDYXNlKHRodW5rMi5wZW5kaW5nLCBwZW5kaW5nKTsKICB9CiAgaWYgKHJlamVjdGVkKSB7CiAgICBjb250ZXh0LmFkZENhc2UodGh1bmsyLnJlamVjdGVkLCByZWplY3RlZCk7CiAgfQogIGlmIChzZXR0bGVkKSB7CiAgICBjb250ZXh0LmFkZE1hdGNoZXIodGh1bmsyLnNldHRsZWQsIHNldHRsZWQpOwogIH0KICBjb250ZXh0LmV4cG9zZUNhc2VSZWR1Y2VyKHJlZHVjZXJOYW1lLCB7CiAgICBmdWxmaWxsZWQ6IGZ1bGZpbGxlZCB8fCBub29wMywKICAgIHBlbmRpbmc6IHBlbmRpbmcgfHwgbm9vcDMsCiAgICByZWplY3RlZDogcmVqZWN0ZWQgfHwgbm9vcDMsCiAgICBzZXR0bGVkOiBzZXR0bGVkIHx8IG5vb3AzCiAgfSk7Cn0KZnVuY3Rpb24gbm9vcDMoKSB7Cn0KdmFyIHRhc2sgPSAidGFzayI7CnZhciBsaXN0ZW5lciA9ICJsaXN0ZW5lciI7CnZhciBjb21wbGV0ZWQgPSAiY29tcGxldGVkIjsKdmFyIGNhbmNlbGxlZCA9ICJjYW5jZWxsZWQiOwp2YXIgdGFza0NhbmNlbGxlZCA9IGB0YXNrLSR7Y2FuY2VsbGVkfWA7CnZhciB0YXNrQ29tcGxldGVkID0gYHRhc2stJHtjb21wbGV0ZWR9YDsKdmFyIGxpc3RlbmVyQ2FuY2VsbGVkID0gYCR7bGlzdGVuZXJ9LSR7Y2FuY2VsbGVkfWA7CnZhciBsaXN0ZW5lckNvbXBsZXRlZCA9IGAke2xpc3RlbmVyfS0ke2NvbXBsZXRlZH1gOwp2YXIgVGFza0Fib3J0RXJyb3IgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY29kZSkgewogICAgdGhpcy5jb2RlID0gY29kZTsKICAgIHRoaXMubWVzc2FnZSA9IGAke3Rhc2t9ICR7Y2FuY2VsbGVkfSAocmVhc29uOiAke2NvZGV9KWA7CiAgfQogIG5hbWUgPSAiVGFza0Fib3J0RXJyb3IiOwogIG1lc3NhZ2U7Cn07CnZhciBhc3NlcnRGdW5jdGlvbiA9IChmdW5jLCBleHBlY3RlZCkgPT4gewogIGlmICh0eXBlb2YgZnVuYyAhPT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMzIpIDogYCR7ZXhwZWN0ZWR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CiAgfQp9Owp2YXIgbm9vcDIyID0gKCkgPT4gewp9Owp2YXIgY2F0Y2hSZWplY3Rpb24gPSAocHJvbWlzZSwgb25FcnJvciA9IG5vb3AyMikgPT4gewogIHByb21pc2UuY2F0Y2gob25FcnJvcik7CiAgcmV0dXJuIHByb21pc2U7Cn07CnZhciBhZGRBYm9ydFNpZ25hbExpc3RlbmVyID0gKGFib3J0U2lnbmFsLCBjYWxsYmFjaykgPT4gewogIGFib3J0U2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoImFib3J0IiwgY2FsbGJhY2ssIHsKICAgIG9uY2U6IHRydWUKICB9KTsKICByZXR1cm4gKCkgPT4gYWJvcnRTaWduYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBjYWxsYmFjayk7Cn07CnZhciBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uID0gKGFib3J0Q29udHJvbGxlciwgcmVhc29uKSA9PiB7CiAgY29uc3Qgc2lnbmFsID0gYWJvcnRDb250cm9sbGVyLnNpZ25hbDsKICBpZiAoc2lnbmFsLmFib3J0ZWQpIHsKICAgIHJldHVybjsKICB9CiAgaWYgKCEoInJlYXNvbiIgaW4gc2lnbmFsKSkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHNpZ25hbCwgInJlYXNvbiIsIHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgdmFsdWU6IHJlYXNvbiwKICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICB3cml0YWJsZTogdHJ1ZQogICAgfSk7CiAgfQogIDsKICBhYm9ydENvbnRyb2xsZXIuYWJvcnQocmVhc29uKTsKfTsKdmFyIHZhbGlkYXRlQWN0aXZlID0gKHNpZ25hbCkgPT4gewogIGlmIChzaWduYWwuYWJvcnRlZCkgewogICAgY29uc3QgewogICAgICByZWFzb24KICAgIH0gPSBzaWduYWw7CiAgICB0aHJvdyBuZXcgVGFza0Fib3J0RXJyb3IocmVhc29uKTsKICB9Cn07CmZ1bmN0aW9uIHJhY2VXaXRoU2lnbmFsKHNpZ25hbCwgcHJvbWlzZSkgewogIGxldCBjbGVhbnVwID0gbm9vcDIyOwogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBjb25zdCBub3RpZnlSZWplY3Rpb24gPSAoKSA9PiByZWplY3QobmV3IFRhc2tBYm9ydEVycm9yKHNpZ25hbC5yZWFzb24pKTsKICAgIGlmIChzaWduYWwuYWJvcnRlZCkgewogICAgICBub3RpZnlSZWplY3Rpb24oKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY2xlYW51cCA9IGFkZEFib3J0U2lnbmFsTGlzdGVuZXIoc2lnbmFsLCBub3RpZnlSZWplY3Rpb24pOwogICAgcHJvbWlzZS5maW5hbGx5KCgpID0+IGNsZWFudXAoKSkudGhlbihyZXNvbHZlLCByZWplY3QpOwogIH0pLmZpbmFsbHkoKCkgPT4gewogICAgY2xlYW51cCA9IG5vb3AyMjsKICB9KTsKfQp2YXIgcnVuVGFzayA9IGFzeW5jICh0YXNrMiwgY2xlYW5VcCkgPT4gewogIHRyeSB7CiAgICBhd2FpdCBQcm9taXNlLnJlc29sdmUoKTsKICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgdGFzazIoKTsKICAgIHJldHVybiB7CiAgICAgIHN0YXR1czogIm9rIiwKICAgICAgdmFsdWUKICAgIH07CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXR1czogZXJyb3IgaW5zdGFuY2VvZiBUYXNrQWJvcnRFcnJvciA/ICJjYW5jZWxsZWQiIDogInJlamVjdGVkIiwKICAgICAgZXJyb3IKICAgIH07CiAgfSBmaW5hbGx5IHsKICAgIGNsZWFuVXA/LigpOwogIH0KfTsKdmFyIGNyZWF0ZVBhdXNlID0gKHNpZ25hbCkgPT4gewogIHJldHVybiAocHJvbWlzZSkgPT4gewogICAgcmV0dXJuIGNhdGNoUmVqZWN0aW9uKHJhY2VXaXRoU2lnbmFsKHNpZ25hbCwgcHJvbWlzZSkudGhlbigob3V0cHV0KSA9PiB7CiAgICAgIHZhbGlkYXRlQWN0aXZlKHNpZ25hbCk7CiAgICAgIHJldHVybiBvdXRwdXQ7CiAgICB9KSk7CiAgfTsKfTsKdmFyIGNyZWF0ZURlbGF5ID0gKHNpZ25hbCkgPT4gewogIGNvbnN0IHBhdXNlID0gY3JlYXRlUGF1c2Uoc2lnbmFsKTsKICByZXR1cm4gKHRpbWVvdXRNcykgPT4gewogICAgcmV0dXJuIHBhdXNlKG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIHRpbWVvdXRNcykpKTsKICB9Owp9Owp2YXIgewogIGFzc2lnbgp9ID0gT2JqZWN0Owp2YXIgSU5URVJOQUxfTklMX1RPS0VOID0ge307CnZhciBhbG0gPSAibGlzdGVuZXJNaWRkbGV3YXJlIjsKdmFyIGNyZWF0ZUZvcmsgPSAocGFyZW50QWJvcnRTaWduYWwsIHBhcmVudEJsb2NraW5nUHJvbWlzZXMpID0+IHsKICBjb25zdCBsaW5rQ29udHJvbGxlcnMgPSAoY29udHJvbGxlcikgPT4gYWRkQWJvcnRTaWduYWxMaXN0ZW5lcihwYXJlbnRBYm9ydFNpZ25hbCwgKCkgPT4gYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihjb250cm9sbGVyLCBwYXJlbnRBYm9ydFNpZ25hbC5yZWFzb24pKTsKICByZXR1cm4gKHRhc2tFeGVjdXRvciwgb3B0cykgPT4gewogICAgYXNzZXJ0RnVuY3Rpb24odGFza0V4ZWN1dG9yLCAidGFza0V4ZWN1dG9yIik7CiAgICBjb25zdCBjaGlsZEFib3J0Q29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGxpbmtDb250cm9sbGVycyhjaGlsZEFib3J0Q29udHJvbGxlcik7CiAgICBjb25zdCByZXN1bHQgPSBydW5UYXNrKGFzeW5jICgpID0+IHsKICAgICAgdmFsaWRhdGVBY3RpdmUocGFyZW50QWJvcnRTaWduYWwpOwogICAgICB2YWxpZGF0ZUFjdGl2ZShjaGlsZEFib3J0Q29udHJvbGxlci5zaWduYWwpOwogICAgICBjb25zdCByZXN1bHQyID0gYXdhaXQgdGFza0V4ZWN1dG9yKHsKICAgICAgICBwYXVzZTogY3JlYXRlUGF1c2UoY2hpbGRBYm9ydENvbnRyb2xsZXIuc2lnbmFsKSwKICAgICAgICBkZWxheTogY3JlYXRlRGVsYXkoY2hpbGRBYm9ydENvbnRyb2xsZXIuc2lnbmFsKSwKICAgICAgICBzaWduYWw6IGNoaWxkQWJvcnRDb250cm9sbGVyLnNpZ25hbAogICAgICB9KTsKICAgICAgdmFsaWRhdGVBY3RpdmUoY2hpbGRBYm9ydENvbnRyb2xsZXIuc2lnbmFsKTsKICAgICAgcmV0dXJuIHJlc3VsdDI7CiAgICB9LCAoKSA9PiBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGNoaWxkQWJvcnRDb250cm9sbGVyLCB0YXNrQ29tcGxldGVkKSk7CiAgICBpZiAob3B0cz8uYXV0b0pvaW4pIHsKICAgICAgcGFyZW50QmxvY2tpbmdQcm9taXNlcy5wdXNoKHJlc3VsdC5jYXRjaChub29wMjIpKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHJlc3VsdDogY3JlYXRlUGF1c2UocGFyZW50QWJvcnRTaWduYWwpKHJlc3VsdCksCiAgICAgIGNhbmNlbCgpIHsKICAgICAgICBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGNoaWxkQWJvcnRDb250cm9sbGVyLCB0YXNrQ2FuY2VsbGVkKTsKICAgICAgfQogICAgfTsKICB9Owp9Owp2YXIgY3JlYXRlVGFrZVBhdHRlcm4gPSAoc3RhcnRMaXN0ZW5pbmcsIHNpZ25hbCkgPT4gewogIGNvbnN0IHRha2UgPSBhc3luYyAocHJlZGljYXRlLCB0aW1lb3V0KSA9PiB7CiAgICB2YWxpZGF0ZUFjdGl2ZShzaWduYWwpOwogICAgbGV0IHVuc3Vic2NyaWJlID0gKCkgPT4gewogICAgfTsKICAgIGNvbnN0IHR1cGxlUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgbGV0IHN0b3BMaXN0ZW5pbmcgPSBzdGFydExpc3RlbmluZyh7CiAgICAgICAgcHJlZGljYXRlLAogICAgICAgIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgICAgICAgIGxpc3RlbmVyQXBpLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICByZXNvbHZlKFthY3Rpb24sIGxpc3RlbmVyQXBpLmdldFN0YXRlKCksIGxpc3RlbmVyQXBpLmdldE9yaWdpbmFsU3RhdGUoKV0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHVuc3Vic2NyaWJlID0gKCkgPT4gewogICAgICAgIHN0b3BMaXN0ZW5pbmcoKTsKICAgICAgICByZWplY3QoKTsKICAgICAgfTsKICAgIH0pOwogICAgY29uc3QgcHJvbWlzZXMgPSBbdHVwbGVQcm9taXNlXTsKICAgIGlmICh0aW1lb3V0ICE9IG51bGwpIHsKICAgICAgcHJvbWlzZXMucHVzaChuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCB0aW1lb3V0LCBudWxsKSkpOwogICAgfQogICAgdHJ5IHsKICAgICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgcmFjZVdpdGhTaWduYWwoc2lnbmFsLCBQcm9taXNlLnJhY2UocHJvbWlzZXMpKTsKICAgICAgdmFsaWRhdGVBY3RpdmUoc2lnbmFsKTsKICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0gZmluYWxseSB7CiAgICAgIHVuc3Vic2NyaWJlKCk7CiAgICB9CiAgfTsKICByZXR1cm4gKHByZWRpY2F0ZSwgdGltZW91dCkgPT4gY2F0Y2hSZWplY3Rpb24odGFrZShwcmVkaWNhdGUsIHRpbWVvdXQpKTsKfTsKdmFyIGdldExpc3RlbmVyRW50cnlQcm9wc0Zyb20gPSAob3B0aW9ucykgPT4gewogIGxldCB7CiAgICB0eXBlLAogICAgYWN0aW9uQ3JlYXRvciwKICAgIG1hdGNoZXIsCiAgICBwcmVkaWNhdGUsCiAgICBlZmZlY3QKICB9ID0gb3B0aW9uczsKICBpZiAodHlwZSkgewogICAgcHJlZGljYXRlID0gY3JlYXRlQWN0aW9uKHR5cGUpLm1hdGNoOwogIH0gZWxzZSBpZiAoYWN0aW9uQ3JlYXRvcikgewogICAgdHlwZSA9IGFjdGlvbkNyZWF0b3IudHlwZTsKICAgIHByZWRpY2F0ZSA9IGFjdGlvbkNyZWF0b3IubWF0Y2g7CiAgfSBlbHNlIGlmIChtYXRjaGVyKSB7CiAgICBwcmVkaWNhdGUgPSBtYXRjaGVyOwogIH0gZWxzZSBpZiAocHJlZGljYXRlKSB7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjEpIDogIkNyZWF0aW5nIG9yIHJlbW92aW5nIGEgbGlzdGVuZXIgcmVxdWlyZXMgb25lIG9mIHRoZSBrbm93biBmaWVsZHMgZm9yIG1hdGNoaW5nIGFuIGFjdGlvbiIpOwogIH0KICBhc3NlcnRGdW5jdGlvbihlZmZlY3QsICJvcHRpb25zLmxpc3RlbmVyIik7CiAgcmV0dXJuIHsKICAgIHByZWRpY2F0ZSwKICAgIHR5cGUsCiAgICBlZmZlY3QKICB9Owp9Owp2YXIgY3JlYXRlTGlzdGVuZXJFbnRyeSA9IC8qIEBfX1BVUkVfXyAqLyBhc3NpZ24oKG9wdGlvbnMpID0+IHsKICBjb25zdCB7CiAgICB0eXBlLAogICAgcHJlZGljYXRlLAogICAgZWZmZWN0CiAgfSA9IGdldExpc3RlbmVyRW50cnlQcm9wc0Zyb20ob3B0aW9ucyk7CiAgY29uc3QgZW50cnkgPSB7CiAgICBpZDogbmFub2lkKCksCiAgICBlZmZlY3QsCiAgICB0eXBlLAogICAgcHJlZGljYXRlLAogICAgcGVuZGluZzogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSwKICAgIHVuc3Vic2NyaWJlOiAoKSA9PiB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjIpIDogIlVuc3Vic2NyaWJlIG5vdCBpbml0aWFsaXplZCIpOwogICAgfQogIH07CiAgcmV0dXJuIGVudHJ5Owp9LCB7CiAgd2l0aFR5cGVzOiAoKSA9PiBjcmVhdGVMaXN0ZW5lckVudHJ5Cn0pOwp2YXIgZmluZExpc3RlbmVyRW50cnkgPSAobGlzdGVuZXJNYXAsIG9wdGlvbnMpID0+IHsKICBjb25zdCB7CiAgICB0eXBlLAogICAgZWZmZWN0LAogICAgcHJlZGljYXRlCiAgfSA9IGdldExpc3RlbmVyRW50cnlQcm9wc0Zyb20ob3B0aW9ucyk7CiAgcmV0dXJuIEFycmF5LmZyb20obGlzdGVuZXJNYXAudmFsdWVzKCkpLmZpbmQoKGVudHJ5KSA9PiB7CiAgICBjb25zdCBtYXRjaFByZWRpY2F0ZU9yVHlwZSA9IHR5cGVvZiB0eXBlID09PSAic3RyaW5nIiA/IGVudHJ5LnR5cGUgPT09IHR5cGUgOiBlbnRyeS5wcmVkaWNhdGUgPT09IHByZWRpY2F0ZTsKICAgIHJldHVybiBtYXRjaFByZWRpY2F0ZU9yVHlwZSAmJiBlbnRyeS5lZmZlY3QgPT09IGVmZmVjdDsKICB9KTsKfTsKdmFyIGNhbmNlbEFjdGl2ZUxpc3RlbmVycyA9IChlbnRyeSkgPT4gewogIGVudHJ5LnBlbmRpbmcuZm9yRWFjaCgoY29udHJvbGxlcikgPT4gewogICAgYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihjb250cm9sbGVyLCBsaXN0ZW5lckNhbmNlbGxlZCk7CiAgfSk7Cn07CnZhciBjcmVhdGVDbGVhckxpc3RlbmVyTWlkZGxld2FyZSA9IChsaXN0ZW5lck1hcCwgZXhlY3V0aW5nTGlzdGVuZXJzKSA9PiB7CiAgcmV0dXJuICgpID0+IHsKICAgIGZvciAoY29uc3QgbGlzdGVuZXIyIG9mIGV4ZWN1dGluZ0xpc3RlbmVycy5rZXlzKCkpIHsKICAgICAgY2FuY2VsQWN0aXZlTGlzdGVuZXJzKGxpc3RlbmVyMik7CiAgICB9CiAgICBsaXN0ZW5lck1hcC5jbGVhcigpOwogIH07Cn07CnZhciBzYWZlbHlOb3RpZnlFcnJvciA9IChlcnJvckhhbmRsZXIsIGVycm9yVG9Ob3RpZnksIGVycm9ySW5mbykgPT4gewogIHRyeSB7CiAgICBlcnJvckhhbmRsZXIoZXJyb3JUb05vdGlmeSwgZXJyb3JJbmZvKTsKICB9IGNhdGNoIChlcnJvckhhbmRsZXJFcnJvcikgewogICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgIHRocm93IGVycm9ySGFuZGxlckVycm9yOwogICAgfSwgMCk7CiAgfQp9Owp2YXIgYWRkTGlzdGVuZXIgPSAvKiBAX19QVVJFX18gKi8gYXNzaWduKC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVBY3Rpb24oYCR7YWxtfS9hZGRgKSwgewogIHdpdGhUeXBlczogKCkgPT4gYWRkTGlzdGVuZXIKfSk7CnZhciBjbGVhckFsbExpc3RlbmVycyA9IC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVBY3Rpb24oYCR7YWxtfS9yZW1vdmVBbGxgKTsKdmFyIHJlbW92ZUxpc3RlbmVyID0gLyogQF9fUFVSRV9fICovIGFzc2lnbigvKiBAX19QVVJFX18gKi8gY3JlYXRlQWN0aW9uKGAke2FsbX0vcmVtb3ZlYCksIHsKICB3aXRoVHlwZXM6ICgpID0+IHJlbW92ZUxpc3RlbmVyCn0pOwp2YXIgZGVmYXVsdEVycm9ySGFuZGxlciA9ICguLi5hcmdzKSA9PiB7CiAgY29uc29sZS5lcnJvcihgJHthbG19L2Vycm9yYCwgLi4uYXJncyk7Cn07CnZhciBjcmVhdGVMaXN0ZW5lck1pZGRsZXdhcmUgPSAobWlkZGxld2FyZU9wdGlvbnMgPSB7fSkgPT4gewogIGNvbnN0IGxpc3RlbmVyTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBjb25zdCBleGVjdXRpbmdMaXN0ZW5lcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGNvbnN0IHRyYWNrRXhlY3V0aW5nTGlzdGVuZXIgPSAoZW50cnkpID0+IHsKICAgIGNvbnN0IGNvdW50ID0gZXhlY3V0aW5nTGlzdGVuZXJzLmdldChlbnRyeSkgPz8gMDsKICAgIGV4ZWN1dGluZ0xpc3RlbmVycy5zZXQoZW50cnksIGNvdW50ICsgMSk7CiAgfTsKICBjb25zdCB1bnRyYWNrRXhlY3V0aW5nTGlzdGVuZXIgPSAoZW50cnkpID0+IHsKICAgIGNvbnN0IGNvdW50ID0gZXhlY3V0aW5nTGlzdGVuZXJzLmdldChlbnRyeSkgPz8gMTsKICAgIGlmIChjb3VudCA9PT0gMSkgewogICAgICBleGVjdXRpbmdMaXN0ZW5lcnMuZGVsZXRlKGVudHJ5KTsKICAgIH0gZWxzZSB7CiAgICAgIGV4ZWN1dGluZ0xpc3RlbmVycy5zZXQoZW50cnksIGNvdW50IC0gMSk7CiAgICB9CiAgfTsKICBjb25zdCB7CiAgICBleHRyYSwKICAgIG9uRXJyb3IgPSBkZWZhdWx0RXJyb3JIYW5kbGVyCiAgfSA9IG1pZGRsZXdhcmVPcHRpb25zOwogIGFzc2VydEZ1bmN0aW9uKG9uRXJyb3IsICJvbkVycm9yIik7CiAgY29uc3QgaW5zZXJ0RW50cnkgPSAoZW50cnkpID0+IHsKICAgIGVudHJ5LnVuc3Vic2NyaWJlID0gKCkgPT4gbGlzdGVuZXJNYXAuZGVsZXRlKGVudHJ5LmlkKTsKICAgIGxpc3RlbmVyTWFwLnNldChlbnRyeS5pZCwgZW50cnkpOwogICAgcmV0dXJuIChjYW5jZWxPcHRpb25zKSA9PiB7CiAgICAgIGVudHJ5LnVuc3Vic2NyaWJlKCk7CiAgICAgIGlmIChjYW5jZWxPcHRpb25zPy5jYW5jZWxBY3RpdmUpIHsKICAgICAgICBjYW5jZWxBY3RpdmVMaXN0ZW5lcnMoZW50cnkpOwogICAgICB9CiAgICB9OwogIH07CiAgY29uc3Qgc3RhcnRMaXN0ZW5pbmcgPSAob3B0aW9ucykgPT4gewogICAgY29uc3QgZW50cnkgPSBmaW5kTGlzdGVuZXJFbnRyeShsaXN0ZW5lck1hcCwgb3B0aW9ucykgPz8gY3JlYXRlTGlzdGVuZXJFbnRyeShvcHRpb25zKTsKICAgIHJldHVybiBpbnNlcnRFbnRyeShlbnRyeSk7CiAgfTsKICBhc3NpZ24oc3RhcnRMaXN0ZW5pbmcsIHsKICAgIHdpdGhUeXBlczogKCkgPT4gc3RhcnRMaXN0ZW5pbmcKICB9KTsKICBjb25zdCBzdG9wTGlzdGVuaW5nID0gKG9wdGlvbnMpID0+IHsKICAgIGNvbnN0IGVudHJ5ID0gZmluZExpc3RlbmVyRW50cnkobGlzdGVuZXJNYXAsIG9wdGlvbnMpOwogICAgaWYgKGVudHJ5KSB7CiAgICAgIGVudHJ5LnVuc3Vic2NyaWJlKCk7CiAgICAgIGlmIChvcHRpb25zLmNhbmNlbEFjdGl2ZSkgewogICAgICAgIGNhbmNlbEFjdGl2ZUxpc3RlbmVycyhlbnRyeSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAhIWVudHJ5OwogIH07CiAgYXNzaWduKHN0b3BMaXN0ZW5pbmcsIHsKICAgIHdpdGhUeXBlczogKCkgPT4gc3RvcExpc3RlbmluZwogIH0pOwogIGNvbnN0IG5vdGlmeUxpc3RlbmVyID0gYXN5bmMgKGVudHJ5LCBhY3Rpb24sIGFwaSwgZ2V0T3JpZ2luYWxTdGF0ZSkgPT4gewogICAgY29uc3QgaW50ZXJuYWxUYXNrQ29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IHRha2UgPSBjcmVhdGVUYWtlUGF0dGVybihzdGFydExpc3RlbmluZywgaW50ZXJuYWxUYXNrQ29udHJvbGxlci5zaWduYWwpOwogICAgY29uc3QgYXV0b0pvaW5Qcm9taXNlcyA9IFtdOwogICAgdHJ5IHsKICAgICAgZW50cnkucGVuZGluZy5hZGQoaW50ZXJuYWxUYXNrQ29udHJvbGxlcik7CiAgICAgIHRyYWNrRXhlY3V0aW5nTGlzdGVuZXIoZW50cnkpOwogICAgICBhd2FpdCBQcm9taXNlLnJlc29sdmUoZW50cnkuZWZmZWN0KAogICAgICAgIGFjdGlvbiwKICAgICAgICAvLyBVc2UgYXNzaWduKCkgcmF0aGVyIHRoYW4gLi4uIHRvIGF2b2lkIGV4dHJhIGhlbHBlciBmdW5jdGlvbnMgYWRkZWQgdG8gYnVuZGxlCiAgICAgICAgYXNzaWduKHt9LCBhcGksIHsKICAgICAgICAgIGdldE9yaWdpbmFsU3RhdGUsCiAgICAgICAgICBjb25kaXRpb246IChwcmVkaWNhdGUsIHRpbWVvdXQpID0+IHRha2UocHJlZGljYXRlLCB0aW1lb3V0KS50aGVuKEJvb2xlYW4pLAogICAgICAgICAgdGFrZSwKICAgICAgICAgIGRlbGF5OiBjcmVhdGVEZWxheShpbnRlcm5hbFRhc2tDb250cm9sbGVyLnNpZ25hbCksCiAgICAgICAgICBwYXVzZTogY3JlYXRlUGF1c2UoaW50ZXJuYWxUYXNrQ29udHJvbGxlci5zaWduYWwpLAogICAgICAgICAgZXh0cmEsCiAgICAgICAgICBzaWduYWw6IGludGVybmFsVGFza0NvbnRyb2xsZXIuc2lnbmFsLAogICAgICAgICAgZm9yazogY3JlYXRlRm9yayhpbnRlcm5hbFRhc2tDb250cm9sbGVyLnNpZ25hbCwgYXV0b0pvaW5Qcm9taXNlcyksCiAgICAgICAgICB1bnN1YnNjcmliZTogZW50cnkudW5zdWJzY3JpYmUsCiAgICAgICAgICBzdWJzY3JpYmU6ICgpID0+IHsKICAgICAgICAgICAgbGlzdGVuZXJNYXAuc2V0KGVudHJ5LmlkLCBlbnRyeSk7CiAgICAgICAgICB9LAogICAgICAgICAgY2FuY2VsQWN0aXZlTGlzdGVuZXJzOiAoKSA9PiB7CiAgICAgICAgICAgIGVudHJ5LnBlbmRpbmcuZm9yRWFjaCgoY29udHJvbGxlciwgXywgc2V0MykgPT4gewogICAgICAgICAgICAgIGlmIChjb250cm9sbGVyICE9PSBpbnRlcm5hbFRhc2tDb250cm9sbGVyKSB7CiAgICAgICAgICAgICAgICBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGNvbnRyb2xsZXIsIGxpc3RlbmVyQ2FuY2VsbGVkKTsKICAgICAgICAgICAgICAgIHNldDMuZGVsZXRlKGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgY2FuY2VsOiAoKSA9PiB7CiAgICAgICAgICAgIGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24oaW50ZXJuYWxUYXNrQ29udHJvbGxlciwgbGlzdGVuZXJDYW5jZWxsZWQpOwogICAgICAgICAgICBlbnRyeS5wZW5kaW5nLmRlbGV0ZShpbnRlcm5hbFRhc2tDb250cm9sbGVyKTsKICAgICAgICAgIH0sCiAgICAgICAgICB0aHJvd0lmQ2FuY2VsbGVkOiAoKSA9PiB7CiAgICAgICAgICAgIHZhbGlkYXRlQWN0aXZlKGludGVybmFsVGFza0NvbnRyb2xsZXIuc2lnbmFsKTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICApKTsKICAgIH0gY2F0Y2ggKGxpc3RlbmVyRXJyb3IpIHsKICAgICAgaWYgKCEobGlzdGVuZXJFcnJvciBpbnN0YW5jZW9mIFRhc2tBYm9ydEVycm9yKSkgewogICAgICAgIHNhZmVseU5vdGlmeUVycm9yKG9uRXJyb3IsIGxpc3RlbmVyRXJyb3IsIHsKICAgICAgICAgIHJhaXNlZEJ5OiAiZWZmZWN0IgogICAgICAgIH0pOwogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCBQcm9taXNlLmFsbChhdXRvSm9pblByb21pc2VzKTsKICAgICAgYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihpbnRlcm5hbFRhc2tDb250cm9sbGVyLCBsaXN0ZW5lckNvbXBsZXRlZCk7CiAgICAgIHVudHJhY2tFeGVjdXRpbmdMaXN0ZW5lcihlbnRyeSk7CiAgICAgIGVudHJ5LnBlbmRpbmcuZGVsZXRlKGludGVybmFsVGFza0NvbnRyb2xsZXIpOwogICAgfQogIH07CiAgY29uc3QgY2xlYXJMaXN0ZW5lck1pZGRsZXdhcmUgPSBjcmVhdGVDbGVhckxpc3RlbmVyTWlkZGxld2FyZShsaXN0ZW5lck1hcCwgZXhlY3V0aW5nTGlzdGVuZXJzKTsKICBjb25zdCBtaWRkbGV3YXJlID0gKGFwaSkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IHsKICAgIGlmICghaXNBY3Rpb24oYWN0aW9uKSkgewogICAgICByZXR1cm4gbmV4dChhY3Rpb24pOwogICAgfQogICAgaWYgKGFkZExpc3RlbmVyLm1hdGNoKGFjdGlvbikpIHsKICAgICAgcmV0dXJuIHN0YXJ0TGlzdGVuaW5nKGFjdGlvbi5wYXlsb2FkKTsKICAgIH0KICAgIGlmIChjbGVhckFsbExpc3RlbmVycy5tYXRjaChhY3Rpb24pKSB7CiAgICAgIGNsZWFyTGlzdGVuZXJNaWRkbGV3YXJlKCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChyZW1vdmVMaXN0ZW5lci5tYXRjaChhY3Rpb24pKSB7CiAgICAgIHJldHVybiBzdG9wTGlzdGVuaW5nKGFjdGlvbi5wYXlsb2FkKTsKICAgIH0KICAgIGxldCBvcmlnaW5hbFN0YXRlID0gYXBpLmdldFN0YXRlKCk7CiAgICBjb25zdCBnZXRPcmlnaW5hbFN0YXRlID0gKCkgPT4gewogICAgICBpZiAob3JpZ2luYWxTdGF0ZSA9PT0gSU5URVJOQUxfTklMX1RPS0VOKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyMykgOiBgJHthbG19OiBnZXRPcmlnaW5hbFN0YXRlIGNhbiBvbmx5IGJlIGNhbGxlZCBzeW5jaHJvbm91c2x5YCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG9yaWdpbmFsU3RhdGU7CiAgICB9OwogICAgbGV0IHJlc3VsdDsKICAgIHRyeSB7CiAgICAgIHJlc3VsdCA9IG5leHQoYWN0aW9uKTsKICAgICAgaWYgKGxpc3RlbmVyTWFwLnNpemUgPiAwKSB7CiAgICAgICAgY29uc3QgY3VycmVudFN0YXRlID0gYXBpLmdldFN0YXRlKCk7CiAgICAgICAgY29uc3QgbGlzdGVuZXJFbnRyaWVzID0gQXJyYXkuZnJvbShsaXN0ZW5lck1hcC52YWx1ZXMoKSk7CiAgICAgICAgZm9yIChjb25zdCBlbnRyeSBvZiBsaXN0ZW5lckVudHJpZXMpIHsKICAgICAgICAgIGxldCBydW5MaXN0ZW5lciA9IGZhbHNlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcnVuTGlzdGVuZXIgPSBlbnRyeS5wcmVkaWNhdGUoYWN0aW9uLCBjdXJyZW50U3RhdGUsIG9yaWdpbmFsU3RhdGUpOwogICAgICAgICAgfSBjYXRjaCAocHJlZGljYXRlRXJyb3IpIHsKICAgICAgICAgICAgcnVuTGlzdGVuZXIgPSBmYWxzZTsKICAgICAgICAgICAgc2FmZWx5Tm90aWZ5RXJyb3Iob25FcnJvciwgcHJlZGljYXRlRXJyb3IsIHsKICAgICAgICAgICAgICByYWlzZWRCeTogInByZWRpY2F0ZSIKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXJ1bkxpc3RlbmVyKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgbm90aWZ5TGlzdGVuZXIoZW50cnksIGFjdGlvbiwgYXBpLCBnZXRPcmlnaW5hbFN0YXRlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIG9yaWdpbmFsU3RhdGUgPSBJTlRFUk5BTF9OSUxfVE9LRU47CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CiAgcmV0dXJuIHsKICAgIG1pZGRsZXdhcmUsCiAgICBzdGFydExpc3RlbmluZywKICAgIHN0b3BMaXN0ZW5pbmcsCiAgICBjbGVhckxpc3RlbmVyczogY2xlYXJMaXN0ZW5lck1pZGRsZXdhcmUKICB9Owp9Owp2YXIgT1JJR0lOQUxfU1RBVEUgPSBTeW1ib2wuZm9yKCJydGstc3RhdGUtcHJveHktb3JpZ2luYWwiKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2xheW91dFNsaWNlLmpzCnZhciBpbml0aWFsU3RhdGUgPSB7CiAgbGF5b3V0VHlwZTogImhvcml6b250YWwiLAogIHdpZHRoOiAwLAogIGhlaWdodDogMCwKICBtYXJnaW46IHsKICAgIHRvcDogNSwKICAgIHJpZ2h0OiA1LAogICAgYm90dG9tOiA1LAogICAgbGVmdDogNQogIH0sCiAgc2NhbGU6IDEKfTsKdmFyIGNoYXJ0TGF5b3V0U2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImNoYXJ0TGF5b3V0IiwKICBpbml0aWFsU3RhdGUsCiAgcmVkdWNlcnM6IHsKICAgIHNldExheW91dChzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLmxheW91dFR5cGUgPSBhY3Rpb24ucGF5bG9hZDsKICAgIH0sCiAgICBzZXRDaGFydFNpemUoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS53aWR0aCA9IGFjdGlvbi5wYXlsb2FkLndpZHRoOwogICAgICBzdGF0ZS5oZWlnaHQgPSBhY3Rpb24ucGF5bG9hZC5oZWlnaHQ7CiAgICB9LAogICAgc2V0TWFyZ2luKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgdmFyIF9hY3Rpb24kcGF5bG9hZCR0b3AsIF9hY3Rpb24kcGF5bG9hZCRyaWdodCwgX2FjdGlvbiRwYXlsb2FkJGJvdHRvLCBfYWN0aW9uJHBheWxvYWQkbGVmdDsKICAgICAgc3RhdGUubWFyZ2luLnRvcCA9IChfYWN0aW9uJHBheWxvYWQkdG9wID0gYWN0aW9uLnBheWxvYWQudG9wKSAhPT0gbnVsbCAmJiBfYWN0aW9uJHBheWxvYWQkdG9wICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkdG9wIDogMDsKICAgICAgc3RhdGUubWFyZ2luLnJpZ2h0ID0gKF9hY3Rpb24kcGF5bG9hZCRyaWdodCA9IGFjdGlvbi5wYXlsb2FkLnJpZ2h0KSAhPT0gbnVsbCAmJiBfYWN0aW9uJHBheWxvYWQkcmlnaHQgIT09IHZvaWQgMCA/IF9hY3Rpb24kcGF5bG9hZCRyaWdodCA6IDA7CiAgICAgIHN0YXRlLm1hcmdpbi5ib3R0b20gPSAoX2FjdGlvbiRwYXlsb2FkJGJvdHRvID0gYWN0aW9uLnBheWxvYWQuYm90dG9tKSAhPT0gbnVsbCAmJiBfYWN0aW9uJHBheWxvYWQkYm90dG8gIT09IHZvaWQgMCA/IF9hY3Rpb24kcGF5bG9hZCRib3R0byA6IDA7CiAgICAgIHN0YXRlLm1hcmdpbi5sZWZ0ID0gKF9hY3Rpb24kcGF5bG9hZCRsZWZ0ID0gYWN0aW9uLnBheWxvYWQubGVmdCkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJGxlZnQgIT09IHZvaWQgMCA/IF9hY3Rpb24kcGF5bG9hZCRsZWZ0IDogMDsKICAgIH0sCiAgICBzZXRTY2FsZShzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnNjYWxlID0gYWN0aW9uLnBheWxvYWQ7CiAgICB9CiAgfQp9KTsKdmFyIHsKICBzZXRNYXJnaW4sCiAgc2V0TGF5b3V0LAogIHNldENoYXJ0U2l6ZSwKICBzZXRTY2FsZQp9ID0gY2hhcnRMYXlvdXRTbGljZS5hY3Rpb25zOwp2YXIgY2hhcnRMYXlvdXRSZWR1Y2VyID0gY2hhcnRMYXlvdXRTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9DaGFydFV0aWxzLmpzCnZhciBpbXBvcnRfc29ydEJ5MiA9IF9fdG9FU00ocmVxdWlyZV9zb3J0QnkyKCkpOwp2YXIgaW1wb3J0X2dldDIgPSBfX3RvRVNNKHJlcXVpcmVfZ2V0MigpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZ2V0U2xpY2VkLmpzCmZ1bmN0aW9uIGdldFNsaWNlZChhcnIsIHN0YXJ0SW5kZXgsIGVuZEluZGV4KSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KGFycikpIHsKICAgIHJldHVybiBhcnI7CiAgfQogIGlmIChhcnIgJiYgc3RhcnRJbmRleCArIGVuZEluZGV4ICE9PSAwKSB7CiAgICByZXR1cm4gYXJyLnNsaWNlKHN0YXJ0SW5kZXgsIGVuZEluZGV4ICsgMSk7CiAgfQogIHJldHVybiBhcnI7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvQ2hhcnRVdGlscy5qcwpmdW5jdGlvbiBvd25LZXlzMihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDIoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czIoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTIoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTIodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBnZXRWYWx1ZUJ5RGF0YUtleShvYmosIGRhdGFLZXksIGRlZmF1bHRWYWx1ZSkgewogIGlmIChpc051bGxpc2gob2JqKSB8fCBpc051bGxpc2goZGF0YUtleSkpIHsKICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgfQogIGlmIChpc051bU9yU3RyKGRhdGFLZXkpKSB7CiAgICByZXR1cm4gKDAsIGltcG9ydF9nZXQyLmRlZmF1bHQpKG9iaiwgZGF0YUtleSwgZGVmYXVsdFZhbHVlKTsKICB9CiAgaWYgKHR5cGVvZiBkYXRhS2V5ID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gZGF0YUtleShvYmopOwogIH0KICByZXR1cm4gZGVmYXVsdFZhbHVlOwp9CnZhciBhcHBlbmRPZmZzZXRPZkxlZ2VuZCA9IChvZmZzZXQsIGxlZ2VuZFNldHRpbmdzLCBsZWdlbmRTaXplKSA9PiB7CiAgaWYgKGxlZ2VuZFNldHRpbmdzICYmIGxlZ2VuZFNpemUpIHsKICAgIHZhciB7CiAgICAgIHdpZHRoOiBib3hXaWR0aCwKICAgICAgaGVpZ2h0OiBib3hIZWlnaHQKICAgIH0gPSBsZWdlbmRTaXplOwogICAgdmFyIHsKICAgICAgYWxpZ24sCiAgICAgIHZlcnRpY2FsQWxpZ24sCiAgICAgIGxheW91dAogICAgfSA9IGxlZ2VuZFNldHRpbmdzOwogICAgaWYgKChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIgfHwgbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgJiYgdmVydGljYWxBbGlnbiA9PT0gIm1pZGRsZSIpICYmIGFsaWduICE9PSAiY2VudGVyIiAmJiBpc051bWJlcihvZmZzZXRbYWxpZ25dKSkgewogICAgICByZXR1cm4gX29iamVjdFNwcmVhZDIoX29iamVjdFNwcmVhZDIoe30sIG9mZnNldCksIHt9LCB7CiAgICAgICAgW2FsaWduXTogb2Zmc2V0W2FsaWduXSArIChib3hXaWR0aCB8fCAwKQogICAgICB9KTsKICAgIH0KICAgIGlmICgobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgfHwgbGF5b3V0ID09PSAidmVydGljYWwiICYmIGFsaWduID09PSAiY2VudGVyIikgJiYgdmVydGljYWxBbGlnbiAhPT0gIm1pZGRsZSIgJiYgaXNOdW1iZXIob2Zmc2V0W3ZlcnRpY2FsQWxpZ25dKSkgewogICAgICByZXR1cm4gX29iamVjdFNwcmVhZDIoX29iamVjdFNwcmVhZDIoe30sIG9mZnNldCksIHt9LCB7CiAgICAgICAgW3ZlcnRpY2FsQWxpZ25dOiBvZmZzZXRbdmVydGljYWxBbGlnbl0gKyAoYm94SGVpZ2h0IHx8IDApCiAgICAgIH0pOwogICAgfQogIH0KICByZXR1cm4gb2Zmc2V0Owp9Owp2YXIgaXNDYXRlZ29yaWNhbEF4aXMgPSAobGF5b3V0LCBheGlzVHlwZSkgPT4gbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgJiYgYXhpc1R5cGUgPT09ICJ4QXhpcyIgfHwgbGF5b3V0ID09PSAidmVydGljYWwiICYmIGF4aXNUeXBlID09PSAieUF4aXMiIHx8IGxheW91dCA9PT0gImNlbnRyaWMiICYmIGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIiB8fCBsYXlvdXQgPT09ICJyYWRpYWwiICYmIGF4aXNUeXBlID09PSAicmFkaXVzQXhpcyI7CnZhciBnZXRDb29yZGluYXRlc09mR3JpZCA9ICh0aWNrczIsIG1pblZhbHVlLCBtYXhWYWx1ZSwgc3luY1dpdGhUaWNrcykgPT4gewogIGlmIChzeW5jV2l0aFRpY2tzKSB7CiAgICByZXR1cm4gdGlja3MyLm1hcCgoZW50cnkpID0+IGVudHJ5LmNvb3JkaW5hdGUpOwogIH0KICB2YXIgaGFzTWluLCBoYXNNYXg7CiAgdmFyIHZhbHVlcyA9IHRpY2tzMi5tYXAoKGVudHJ5KSA9PiB7CiAgICBpZiAoZW50cnkuY29vcmRpbmF0ZSA9PT0gbWluVmFsdWUpIHsKICAgICAgaGFzTWluID0gdHJ1ZTsKICAgIH0KICAgIGlmIChlbnRyeS5jb29yZGluYXRlID09PSBtYXhWYWx1ZSkgewogICAgICBoYXNNYXggPSB0cnVlOwogICAgfQogICAgcmV0dXJuIGVudHJ5LmNvb3JkaW5hdGU7CiAgfSk7CiAgaWYgKCFoYXNNaW4pIHsKICAgIHZhbHVlcy5wdXNoKG1pblZhbHVlKTsKICB9CiAgaWYgKCFoYXNNYXgpIHsKICAgIHZhbHVlcy5wdXNoKG1heFZhbHVlKTsKICB9CiAgcmV0dXJuIHZhbHVlczsKfTsKdmFyIGdldFRpY2tzT2ZBeGlzID0gKGF4aXMsIGlzR3JpZCwgaXNBbGwpID0+IHsKICBpZiAoIWF4aXMpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgZHVwbGljYXRlRG9tYWluLAogICAgdHlwZSwKICAgIHJhbmdlOiByYW5nZTQsCiAgICBzY2FsZSwKICAgIHJlYWxTY2FsZVR5cGUsCiAgICBpc0NhdGVnb3JpY2FsLAogICAgY2F0ZWdvcmljYWxEb21haW4sCiAgICB0aWNrQ291bnQsCiAgICB0aWNrczogdGlja3MyLAogICAgbmljZVRpY2tzLAogICAgYXhpc1R5cGUKICB9ID0gYXhpczsKICBpZiAoIXNjYWxlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIG9mZnNldEZvckJhbmQgPSByZWFsU2NhbGVUeXBlID09PSAic2NhbGVCYW5kIiAmJiBzY2FsZS5iYW5kd2lkdGggPyBzY2FsZS5iYW5kd2lkdGgoKSAvIDIgOiAyOwogIHZhciBvZmZzZXQgPSAoaXNHcmlkIHx8IGlzQWxsKSAmJiB0eXBlID09PSAiY2F0ZWdvcnkiICYmIHNjYWxlLmJhbmR3aWR0aCA/IHNjYWxlLmJhbmR3aWR0aCgpIC8gb2Zmc2V0Rm9yQmFuZCA6IDA7CiAgb2Zmc2V0ID0gYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiICYmIHJhbmdlNCAmJiByYW5nZTQubGVuZ3RoID49IDIgPyBtYXRoU2lnbihyYW5nZTRbMF0gLSByYW5nZTRbMV0pICogMiAqIG9mZnNldCA6IG9mZnNldDsKICBpZiAoaXNHcmlkICYmICh0aWNrczIgfHwgbmljZVRpY2tzKSkgewogICAgdmFyIHJlc3VsdCA9ICh0aWNrczIgfHwgbmljZVRpY2tzIHx8IFtdKS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgICB2YXIgc2NhbGVDb250ZW50ID0gZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluLmluZGV4T2YoZW50cnkpIDogZW50cnk7CiAgICAgIHJldHVybiB7CiAgICAgICAgLy8gSWYgdGhlIHNjYWxlQ29udGVudCBpcyBub3QgYSBudW1iZXIsIHRoZSBjb29yZGluYXRlIHdpbGwgYmUgTmFOLgogICAgICAgIC8vIFRoYXQgY291bGQgYmUgdGhlIGNhc2UgZm9yIGV4YW1wbGUgd2l0aCBhIFBvaW50U2NhbGUgYW5kIGEgc3RyaW5nIGFzIGRvbWFpbi4KICAgICAgICBjb29yZGluYXRlOiBzY2FsZShzY2FsZUNvbnRlbnQpICsgb2Zmc2V0LAogICAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgICBvZmZzZXQsCiAgICAgICAgaW5kZXgKICAgICAgfTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdC5maWx0ZXIoKHJvdykgPT4gIWlzTmFuKHJvdy5jb29yZGluYXRlKSk7CiAgfQogIGlmIChpc0NhdGVnb3JpY2FsICYmIGNhdGVnb3JpY2FsRG9tYWluKSB7CiAgICByZXR1cm4gY2F0ZWdvcmljYWxEb21haW4ubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgICAgdmFsdWU6IGVudHJ5LAogICAgICBpbmRleCwKICAgICAgb2Zmc2V0CiAgICB9KSk7CiAgfQogIGlmIChzY2FsZS50aWNrcyAmJiAhaXNBbGwgJiYgdGlja0NvdW50ICE9IG51bGwpIHsKICAgIHJldHVybiBzY2FsZS50aWNrcyh0aWNrQ291bnQpLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgb2Zmc2V0LAogICAgICBpbmRleAogICAgfSkpOwogIH0KICByZXR1cm4gc2NhbGUuZG9tYWluKCkubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICB2YWx1ZTogZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluW2VudHJ5XSA6IGVudHJ5LAogICAgaW5kZXgsCiAgICBvZmZzZXQKICB9KSk7Cn07CnZhciBFUFMyID0gMWUtNDsKdmFyIGNoZWNrRG9tYWluT2ZTY2FsZSA9IChzY2FsZSkgPT4gewogIHZhciBkb21haW4gPSBzY2FsZS5kb21haW4oKTsKICBpZiAoIWRvbWFpbiB8fCBkb21haW4ubGVuZ3RoIDw9IDIpIHsKICAgIHJldHVybjsKICB9CiAgdmFyIGxlbiA9IGRvbWFpbi5sZW5ndGg7CiAgdmFyIHJhbmdlNCA9IHNjYWxlLnJhbmdlKCk7CiAgdmFyIG1pblZhbHVlID0gTWF0aC5taW4ocmFuZ2U0WzBdLCByYW5nZTRbMV0pIC0gRVBTMjsKICB2YXIgbWF4VmFsdWUgPSBNYXRoLm1heChyYW5nZTRbMF0sIHJhbmdlNFsxXSkgKyBFUFMyOwogIHZhciBmaXJzdCA9IHNjYWxlKGRvbWFpblswXSk7CiAgdmFyIGxhc3QyID0gc2NhbGUoZG9tYWluW2xlbiAtIDFdKTsKICBpZiAoZmlyc3QgPCBtaW5WYWx1ZSB8fCBmaXJzdCA+IG1heFZhbHVlIHx8IGxhc3QyIDwgbWluVmFsdWUgfHwgbGFzdDIgPiBtYXhWYWx1ZSkgewogICAgc2NhbGUuZG9tYWluKFtkb21haW5bMF0sIGRvbWFpbltsZW4gLSAxXV0pOwogIH0KfTsKdmFyIG9mZnNldFNpZ24gPSAoc2VyaWVzKSA9PiB7CiAgdmFyIG4gPSBzZXJpZXMubGVuZ3RoOwogIGlmIChuIDw9IDApIHsKICAgIHJldHVybjsKICB9CiAgZm9yICh2YXIgaiA9IDAsIG0gPSBzZXJpZXNbMF0ubGVuZ3RoOyBqIDwgbTsgKytqKSB7CiAgICB2YXIgcG9zaXRpdmUgPSAwOwogICAgdmFyIG5lZ2F0aXZlID0gMDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgIHZhciB2YWx1ZSA9IGlzTmFuKHNlcmllc1tpXVtqXVsxXSkgPyBzZXJpZXNbaV1bal1bMF0gOiBzZXJpZXNbaV1bal1bMV07CiAgICAgIGlmICh2YWx1ZSA+PSAwKSB7CiAgICAgICAgc2VyaWVzW2ldW2pdWzBdID0gcG9zaXRpdmU7CiAgICAgICAgc2VyaWVzW2ldW2pdWzFdID0gcG9zaXRpdmUgKyB2YWx1ZTsKICAgICAgICBwb3NpdGl2ZSA9IHNlcmllc1tpXVtqXVsxXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXJpZXNbaV1bal1bMF0gPSBuZWdhdGl2ZTsKICAgICAgICBzZXJpZXNbaV1bal1bMV0gPSBuZWdhdGl2ZSArIHZhbHVlOwogICAgICAgIG5lZ2F0aXZlID0gc2VyaWVzW2ldW2pdWzFdOwogICAgICB9CiAgICB9CiAgfQp9Owp2YXIgb2Zmc2V0UG9zaXRpdmUgPSAoc2VyaWVzKSA9PiB7CiAgdmFyIG4gPSBzZXJpZXMubGVuZ3RoOwogIGlmIChuIDw9IDApIHsKICAgIHJldHVybjsKICB9CiAgZm9yICh2YXIgaiA9IDAsIG0gPSBzZXJpZXNbMF0ubGVuZ3RoOyBqIDwgbTsgKytqKSB7CiAgICB2YXIgcG9zaXRpdmUgPSAwOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgdmFyIHZhbHVlID0gaXNOYW4oc2VyaWVzW2ldW2pdWzFdKSA/IHNlcmllc1tpXVtqXVswXSA6IHNlcmllc1tpXVtqXVsxXTsKICAgICAgaWYgKHZhbHVlID49IDApIHsKICAgICAgICBzZXJpZXNbaV1bal1bMF0gPSBwb3NpdGl2ZTsKICAgICAgICBzZXJpZXNbaV1bal1bMV0gPSBwb3NpdGl2ZSArIHZhbHVlOwogICAgICAgIHBvc2l0aXZlID0gc2VyaWVzW2ldW2pdWzFdOwogICAgICB9IGVsc2UgewogICAgICAgIHNlcmllc1tpXVtqXVswXSA9IDA7CiAgICAgICAgc2VyaWVzW2ldW2pdWzFdID0gMDsKICAgICAgfQogICAgfQogIH0KfTsKdmFyIFNUQUNLX09GRlNFVF9NQVAgPSB7CiAgc2lnbjogb2Zmc2V0U2lnbiwKICAvLyBAdHMtZXhwZWN0LWVycm9yIGRlZmluaXRlbHl0eXBlZCB0eXBlcyBhcmUgaW5jb3JyZWN0CiAgZXhwYW5kOiBleHBhbmRfZGVmYXVsdCwKICAvLyBAdHMtZXhwZWN0LWVycm9yIGRlZmluaXRlbHl0eXBlZCB0eXBlcyBhcmUgaW5jb3JyZWN0CiAgbm9uZTogbm9uZV9kZWZhdWx0LAogIC8vIEB0cy1leHBlY3QtZXJyb3IgZGVmaW5pdGVseXR5cGVkIHR5cGVzIGFyZSBpbmNvcnJlY3QKICBzaWxob3VldHRlOiBzaWxob3VldHRlX2RlZmF1bHQsCiAgLy8gQHRzLWV4cGVjdC1lcnJvciBkZWZpbml0ZWx5dHlwZWQgdHlwZXMgYXJlIGluY29ycmVjdAogIHdpZ2dsZTogd2lnZ2xlX2RlZmF1bHQsCiAgcG9zaXRpdmU6IG9mZnNldFBvc2l0aXZlCn07CnZhciBnZXRTdGFja2VkRGF0YSA9IChkYXRhLCBkYXRhS2V5cywgb2Zmc2V0VHlwZSkgPT4gewogIHZhciBvZmZzZXRBY2Nlc3NvciA9IFNUQUNLX09GRlNFVF9NQVBbb2Zmc2V0VHlwZV07CiAgdmFyIHN0YWNrID0gc3RhY2tfZGVmYXVsdCgpLmtleXMoZGF0YUtleXMpLnZhbHVlKChkLCBrZXkpID0+IE51bWJlcihnZXRWYWx1ZUJ5RGF0YUtleShkLCBrZXksIDApKSkub3JkZXIobm9uZV9kZWZhdWx0Mikub2Zmc2V0KG9mZnNldEFjY2Vzc29yKTsKICByZXR1cm4gc3RhY2soZGF0YSk7Cn07CmZ1bmN0aW9uIGdldE5vcm1hbGl6ZWRTdGFja0lkKHB1YmxpY1N0YWNrSWQpIHsKICByZXR1cm4gcHVibGljU3RhY2tJZCA9PSBudWxsID8gdm9pZCAwIDogU3RyaW5nKHB1YmxpY1N0YWNrSWQpOwp9CmZ1bmN0aW9uIGdldENhdGVDb29yZGluYXRlT2ZMaW5lKF9yZWYyKSB7CiAgdmFyIHsKICAgIGF4aXMsCiAgICB0aWNrczogdGlja3MyLAogICAgYmFuZFNpemUsCiAgICBlbnRyeSwKICAgIGluZGV4LAogICAgZGF0YUtleQogIH0gPSBfcmVmMjsKICBpZiAoYXhpcy50eXBlID09PSAiY2F0ZWdvcnkiKSB7CiAgICBpZiAoIWF4aXMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkgJiYgYXhpcy5kYXRhS2V5ICYmICFpc051bGxpc2goZW50cnlbYXhpcy5kYXRhS2V5XSkpIHsKICAgICAgdmFyIG1hdGNoZWRUaWNrID0gZmluZEVudHJ5SW5BcnJheSh0aWNrczIsICJ2YWx1ZSIsIGVudHJ5W2F4aXMuZGF0YUtleV0pOwogICAgICBpZiAobWF0Y2hlZFRpY2spIHsKICAgICAgICByZXR1cm4gbWF0Y2hlZFRpY2suY29vcmRpbmF0ZSArIGJhbmRTaXplIC8gMjsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHRpY2tzMltpbmRleF0gPyB0aWNrczJbaW5kZXhdLmNvb3JkaW5hdGUgKyBiYW5kU2l6ZSAvIDIgOiBudWxsOwogIH0KICB2YXIgdmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgIWlzTnVsbGlzaChkYXRhS2V5KSA/IGRhdGFLZXkgOiBheGlzLmRhdGFLZXkpOwogIHJldHVybiAhaXNOdWxsaXNoKHZhbHVlKSA/IGF4aXMuc2NhbGUodmFsdWUpIDogbnVsbDsKfQp2YXIgZ2V0RG9tYWluT2ZTaW5nbGUgPSAoZGF0YSkgPT4gewogIHZhciBmbGF0ID0gZGF0YS5mbGF0KDIpLmZpbHRlcihpc051bWJlcik7CiAgcmV0dXJuIFtNYXRoLm1pbiguLi5mbGF0KSwgTWF0aC5tYXgoLi4uZmxhdCldOwp9Owp2YXIgbWFrZURvbWFpbkZpbml0ZSA9IChkb21haW4pID0+IHsKICByZXR1cm4gW2RvbWFpblswXSA9PT0gSW5maW5pdHkgPyAwIDogZG9tYWluWzBdLCBkb21haW5bMV0gPT09IC1JbmZpbml0eSA/IDAgOiBkb21haW5bMV1dOwp9Owp2YXIgZ2V0RG9tYWluT2ZTdGFja0dyb3VwcyA9IChzdGFja0dyb3Vwcywgc3RhcnRJbmRleCwgZW5kSW5kZXgpID0+IHsKICBpZiAoc3RhY2tHcm91cHMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIG1ha2VEb21haW5GaW5pdGUoT2JqZWN0LmtleXMoc3RhY2tHcm91cHMpLnJlZHVjZSgocmVzdWx0LCBzdGFja0lkKSA9PiB7CiAgICB2YXIgZ3JvdXAgPSBzdGFja0dyb3Vwc1tzdGFja0lkXTsKICAgIHZhciB7CiAgICAgIHN0YWNrZWREYXRhCiAgICB9ID0gZ3JvdXA7CiAgICB2YXIgZG9tYWluID0gc3RhY2tlZERhdGEucmVkdWNlKChyZXMsIGVudHJ5KSA9PiB7CiAgICAgIHZhciBzbGljZWQgPSBnZXRTbGljZWQoZW50cnksIHN0YXJ0SW5kZXgsIGVuZEluZGV4KTsKICAgICAgdmFyIHMgPSBnZXREb21haW5PZlNpbmdsZShzbGljZWQpOwogICAgICByZXR1cm4gW01hdGgubWluKHJlc1swXSwgc1swXSksIE1hdGgubWF4KHJlc1sxXSwgc1sxXSldOwogICAgfSwgW0luZmluaXR5LCAtSW5maW5pdHldKTsKICAgIHJldHVybiBbTWF0aC5taW4oZG9tYWluWzBdLCByZXN1bHRbMF0pLCBNYXRoLm1heChkb21haW5bMV0sIHJlc3VsdFsxXSldOwogIH0sIFtJbmZpbml0eSwgLUluZmluaXR5XSkpOwp9Owp2YXIgTUlOX1ZBTFVFX1JFRyA9IC9eZGF0YU1pbltcc10qLVtcc10qKFswLTldKyhbLl17MX1bMC05XSspezAsMX0pJC87CnZhciBNQVhfVkFMVUVfUkVHID0gL15kYXRhTWF4W1xzXSpcK1tcc10qKFswLTldKyhbLl17MX1bMC05XSspezAsMX0pJC87CnZhciBnZXRCYW5kU2l6ZU9mQXhpcyA9IChheGlzLCB0aWNrczIsIGlzQmFyKSA9PiB7CiAgaWYgKGF4aXMgJiYgYXhpcy5zY2FsZSAmJiBheGlzLnNjYWxlLmJhbmR3aWR0aCkgewogICAgdmFyIGJhbmRXaWR0aCA9IGF4aXMuc2NhbGUuYmFuZHdpZHRoKCk7CiAgICBpZiAoIWlzQmFyIHx8IGJhbmRXaWR0aCA+IDApIHsKICAgICAgcmV0dXJuIGJhbmRXaWR0aDsKICAgIH0KICB9CiAgaWYgKGF4aXMgJiYgdGlja3MyICYmIHRpY2tzMi5sZW5ndGggPj0gMikgewogICAgdmFyIG9yZGVyZWRUaWNrcyA9ICgwLCBpbXBvcnRfc29ydEJ5Mi5kZWZhdWx0KSh0aWNrczIsIChvKSA9PiBvLmNvb3JkaW5hdGUpOwogICAgdmFyIGJhbmRTaXplID0gSW5maW5pdHk7CiAgICBmb3IgKHZhciBpID0gMSwgbGVuID0gb3JkZXJlZFRpY2tzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHZhciBjdXIgPSBvcmRlcmVkVGlja3NbaV07CiAgICAgIHZhciBwcmV2ID0gb3JkZXJlZFRpY2tzW2kgLSAxXTsKICAgICAgYmFuZFNpemUgPSBNYXRoLm1pbigoY3VyLmNvb3JkaW5hdGUgfHwgMCkgLSAocHJldi5jb29yZGluYXRlIHx8IDApLCBiYW5kU2l6ZSk7CiAgICB9CiAgICByZXR1cm4gYmFuZFNpemUgPT09IEluZmluaXR5ID8gMCA6IGJhbmRTaXplOwogIH0KICByZXR1cm4gaXNCYXIgPyB2b2lkIDAgOiAwOwp9OwpmdW5jdGlvbiBnZXRUb29sdGlwRW50cnkoX3JlZjQpIHsKICB2YXIgewogICAgdG9vbHRpcEVudHJ5U2V0dGluZ3MsCiAgICBkYXRhS2V5LAogICAgcGF5bG9hZCwKICAgIHZhbHVlLAogICAgbmFtZQogIH0gPSBfcmVmNDsKICByZXR1cm4gX29iamVjdFNwcmVhZDIoX29iamVjdFNwcmVhZDIoe30sIHRvb2x0aXBFbnRyeVNldHRpbmdzKSwge30sIHsKICAgIGRhdGFLZXksCiAgICBwYXlsb2FkLAogICAgdmFsdWUsCiAgICBuYW1lCiAgfSk7Cn0KZnVuY3Rpb24gZ2V0VG9vbHRpcE5hbWVQcm9wKG5hbWVGcm9tSXRlbSwgZGF0YUtleSkgewogIGlmIChuYW1lRnJvbUl0ZW0pIHsKICAgIHJldHVybiBTdHJpbmcobmFtZUZyb21JdGVtKTsKICB9CiAgaWYgKHR5cGVvZiBkYXRhS2V5ID09PSAic3RyaW5nIikgewogICAgcmV0dXJuIGRhdGFLZXk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KdmFyIGNhbGN1bGF0ZUNhcnRlc2lhblRvb2x0aXBQb3MgPSAoY29vcmRpbmF0ZSwgbGF5b3V0KSA9PiB7CiAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiKSB7CiAgICByZXR1cm4gY29vcmRpbmF0ZS5jaGFydFg7CiAgfQogIGlmIChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgIHJldHVybiBjb29yZGluYXRlLmNoYXJ0WTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIGNhbGN1bGF0ZVBvbGFyVG9vbHRpcFBvcyA9IChyYW5nZU9iaiwgbGF5b3V0KSA9PiB7CiAgaWYgKGxheW91dCA9PT0gImNlbnRyaWMiKSB7CiAgICByZXR1cm4gcmFuZ2VPYmouYW5nbGU7CiAgfQogIHJldHVybiByYW5nZU9iai5yYWRpdXM7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29udGFpbmVyU2VsZWN0b3JzLmpzCnZhciBzZWxlY3RDaGFydFdpZHRoID0gKHN0YXRlKSA9PiBzdGF0ZS5sYXlvdXQud2lkdGg7CnZhciBzZWxlY3RDaGFydEhlaWdodCA9IChzdGF0ZSkgPT4gc3RhdGUubGF5b3V0LmhlaWdodDsKdmFyIHNlbGVjdENvbnRhaW5lclNjYWxlID0gKHN0YXRlKSA9PiBzdGF0ZS5sYXlvdXQuc2NhbGU7CnZhciBzZWxlY3RNYXJnaW4gPSAoc3RhdGUpID0+IHN0YXRlLmxheW91dC5tYXJnaW47CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0QWxsQXhlcy5qcwp2YXIgc2VsZWN0QWxsWEF4ZXMgPSBjcmVhdGVTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLmNhcnRlc2lhbkF4aXMueEF4aXMsICh4QXhpc01hcCkgPT4gewogIHJldHVybiBPYmplY3QudmFsdWVzKHhBeGlzTWFwKTsKfSk7CnZhciBzZWxlY3RBbGxZQXhlcyA9IGNyZWF0ZVNlbGVjdG9yKChzdGF0ZSkgPT4gc3RhdGUuY2FydGVzaWFuQXhpcy55QXhpcywgKHlBeGlzTWFwKSA9PiB7CiAgcmV0dXJuIE9iamVjdC52YWx1ZXMoeUF4aXNNYXApOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvQ29uc3RhbnRzLmpzCnZhciBEQVRBX0lURU1fSU5ERVhfQVRUUklCVVRFX05BTUUgPSAiZGF0YS1yZWNoYXJ0cy1pdGVtLWluZGV4IjsKdmFyIERBVEFfSVRFTV9EQVRBS0VZX0FUVFJJQlVURV9OQU1FID0gImRhdGEtcmVjaGFydHMtaXRlbS1kYXRhLWtleSI7CnZhciBERUZBVUxUX1lfQVhJU19XSURUSCA9IDYwOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwuanMKZnVuY3Rpb24gb3duS2V5czMoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQzKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MyhlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTModCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIHNlbGVjdEJydXNoSGVpZ2h0ID0gKHN0YXRlKSA9PiBzdGF0ZS5icnVzaC5oZWlnaHQ7CmZ1bmN0aW9uIHNlbGVjdExlZnRBeGVzT2Zmc2V0KHN0YXRlKSB7CiAgdmFyIHlBeGVzID0gc2VsZWN0QWxsWUF4ZXMoc3RhdGUpOwogIHJldHVybiB5QXhlcy5yZWR1Y2UoKHJlc3VsdCwgZW50cnkpID0+IHsKICAgIGlmIChlbnRyeS5vcmllbnRhdGlvbiA9PT0gImxlZnQiICYmICFlbnRyeS5taXJyb3IgJiYgIWVudHJ5LmhpZGUpIHsKICAgICAgdmFyIHdpZHRoID0gdHlwZW9mIGVudHJ5LndpZHRoID09PSAibnVtYmVyIiA/IGVudHJ5LndpZHRoIDogREVGQVVMVF9ZX0FYSVNfV0lEVEg7CiAgICAgIHJldHVybiByZXN1bHQgKyB3aWR0aDsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfSwgMCk7Cn0KZnVuY3Rpb24gc2VsZWN0UmlnaHRBeGVzT2Zmc2V0KHN0YXRlKSB7CiAgdmFyIHlBeGVzID0gc2VsZWN0QWxsWUF4ZXMoc3RhdGUpOwogIHJldHVybiB5QXhlcy5yZWR1Y2UoKHJlc3VsdCwgZW50cnkpID0+IHsKICAgIGlmIChlbnRyeS5vcmllbnRhdGlvbiA9PT0gInJpZ2h0IiAmJiAhZW50cnkubWlycm9yICYmICFlbnRyeS5oaWRlKSB7CiAgICAgIHZhciB3aWR0aCA9IHR5cGVvZiBlbnRyeS53aWR0aCA9PT0gIm51bWJlciIgPyBlbnRyeS53aWR0aCA6IERFRkFVTFRfWV9BWElTX1dJRFRIOwogICAgICByZXR1cm4gcmVzdWx0ICsgd2lkdGg7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0sIDApOwp9CmZ1bmN0aW9uIHNlbGVjdFRvcEF4ZXNPZmZzZXQoc3RhdGUpIHsKICB2YXIgeEF4ZXMgPSBzZWxlY3RBbGxYQXhlcyhzdGF0ZSk7CiAgcmV0dXJuIHhBeGVzLnJlZHVjZSgocmVzdWx0LCBlbnRyeSkgPT4gewogICAgaWYgKGVudHJ5Lm9yaWVudGF0aW9uID09PSAidG9wIiAmJiAhZW50cnkubWlycm9yICYmICFlbnRyeS5oaWRlKSB7CiAgICAgIHJldHVybiByZXN1bHQgKyBlbnRyeS5oZWlnaHQ7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0sIDApOwp9CmZ1bmN0aW9uIHNlbGVjdEJvdHRvbUF4ZXNPZmZzZXQoc3RhdGUpIHsKICB2YXIgeEF4ZXMgPSBzZWxlY3RBbGxYQXhlcyhzdGF0ZSk7CiAgcmV0dXJuIHhBeGVzLnJlZHVjZSgocmVzdWx0LCBlbnRyeSkgPT4gewogICAgaWYgKGVudHJ5Lm9yaWVudGF0aW9uID09PSAiYm90dG9tIiAmJiAhZW50cnkubWlycm9yICYmICFlbnRyeS5oaWRlKSB7CiAgICAgIHJldHVybiByZXN1bHQgKyBlbnRyeS5oZWlnaHQ7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0sIDApOwp9CnZhciBzZWxlY3RDaGFydE9mZnNldEludGVybmFsID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RNYXJnaW4sIHNlbGVjdEJydXNoSGVpZ2h0LCBzZWxlY3RMZWZ0QXhlc09mZnNldCwgc2VsZWN0UmlnaHRBeGVzT2Zmc2V0LCBzZWxlY3RUb3BBeGVzT2Zmc2V0LCBzZWxlY3RCb3R0b21BeGVzT2Zmc2V0LCBzZWxlY3RMZWdlbmRTZXR0aW5ncywgc2VsZWN0TGVnZW5kU2l6ZV0sIChjaGFydFdpZHRoLCBjaGFydEhlaWdodCwgbWFyZ2luLCBicnVzaEhlaWdodCwgbGVmdEF4ZXNPZmZzZXQsIHJpZ2h0QXhlc09mZnNldCwgdG9wQXhlc09mZnNldCwgYm90dG9tQXhlc09mZnNldCwgbGVnZW5kU2V0dGluZ3MsIGxlZ2VuZFNpemUpID0+IHsKICB2YXIgb2Zmc2V0SCA9IHsKICAgIGxlZnQ6IChtYXJnaW4ubGVmdCB8fCAwKSArIGxlZnRBeGVzT2Zmc2V0LAogICAgcmlnaHQ6IChtYXJnaW4ucmlnaHQgfHwgMCkgKyByaWdodEF4ZXNPZmZzZXQKICB9OwogIHZhciBvZmZzZXRWID0gewogICAgdG9wOiAobWFyZ2luLnRvcCB8fCAwKSArIHRvcEF4ZXNPZmZzZXQsCiAgICBib3R0b206IChtYXJnaW4uYm90dG9tIHx8IDApICsgYm90dG9tQXhlc09mZnNldAogIH07CiAgdmFyIG9mZnNldCA9IF9vYmplY3RTcHJlYWQzKF9vYmplY3RTcHJlYWQzKHt9LCBvZmZzZXRWKSwgb2Zmc2V0SCk7CiAgdmFyIGJydXNoQm90dG9tID0gb2Zmc2V0LmJvdHRvbTsKICBvZmZzZXQuYm90dG9tICs9IGJydXNoSGVpZ2h0OwogIG9mZnNldCA9IGFwcGVuZE9mZnNldE9mTGVnZW5kKG9mZnNldCwgbGVnZW5kU2V0dGluZ3MsIGxlZ2VuZFNpemUpOwogIHZhciBvZmZzZXRXaWR0aCA9IGNoYXJ0V2lkdGggLSBvZmZzZXQubGVmdCAtIG9mZnNldC5yaWdodDsKICB2YXIgb2Zmc2V0SGVpZ2h0ID0gY2hhcnRIZWlnaHQgLSBvZmZzZXQudG9wIC0gb2Zmc2V0LmJvdHRvbTsKICByZXR1cm4gX29iamVjdFNwcmVhZDMoX29iamVjdFNwcmVhZDMoewogICAgYnJ1c2hCb3R0b20KICB9LCBvZmZzZXQpLCB7fSwgewogICAgLy8gbmV2ZXIgcmV0dXJuIG5lZ2F0aXZlIHZhbHVlcyBmb3IgaGVpZ2h0IGFuZCB3aWR0aAogICAgd2lkdGg6IE1hdGgubWF4KG9mZnNldFdpZHRoLCAwKSwKICAgIGhlaWdodDogTWF0aC5tYXgob2Zmc2V0SGVpZ2h0LCAwKQogIH0pOwp9KTsKdmFyIHNlbGVjdENoYXJ0Vmlld0JveCA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIChvZmZzZXQpID0+ICh7CiAgeDogb2Zmc2V0LmxlZnQsCiAgeTogb2Zmc2V0LnRvcCwKICB3aWR0aDogb2Zmc2V0LndpZHRoLAogIGhlaWdodDogb2Zmc2V0LmhlaWdodAp9KSk7CnZhciBzZWxlY3RBeGlzVmlld0JveCA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCAod2lkdGgsIGhlaWdodCkgPT4gKHsKICB4OiAwLAogIHk6IDAsCiAgd2lkdGgsCiAgaGVpZ2h0Cn0pKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvUGFub3JhbWFDb250ZXh0LmpzCnZhciBSZWFjdDMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QxMSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIFBhbm9yYW1hQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MTEuY3JlYXRlQ29udGV4dCkobnVsbCk7CnZhciB1c2VJc1Bhbm9yYW1hID0gKCkgPT4gKDAsIGltcG9ydF9yZWFjdDExLnVzZUNvbnRleHQpKFBhbm9yYW1hQ29udGV4dCkgIT0gbnVsbDsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9icnVzaFNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0QnJ1c2hTZXR0aW5ncyA9IChzdGF0ZSkgPT4gc3RhdGUuYnJ1c2g7CnZhciBzZWxlY3RCcnVzaERpbWVuc2lvbnMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QnJ1c2hTZXR0aW5ncywgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0TWFyZ2luXSwgKGJydXNoU2V0dGluZ3MsIG9mZnNldCwgbWFyZ2luKSA9PiAoewogIGhlaWdodDogYnJ1c2hTZXR0aW5ncy5oZWlnaHQsCiAgeDogaXNOdW1iZXIoYnJ1c2hTZXR0aW5ncy54KSA/IGJydXNoU2V0dGluZ3MueCA6IG9mZnNldC5sZWZ0LAogIHk6IGlzTnVtYmVyKGJydXNoU2V0dGluZ3MueSkgPyBicnVzaFNldHRpbmdzLnkgOiBvZmZzZXQudG9wICsgb2Zmc2V0LmhlaWdodCArIG9mZnNldC5icnVzaEJvdHRvbSAtICgobWFyZ2luID09PSBudWxsIHx8IG1hcmdpbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogbWFyZ2luLmJvdHRvbSkgfHwgMCksCiAgd2lkdGg6IGlzTnVtYmVyKGJydXNoU2V0dGluZ3Mud2lkdGgpID8gYnJ1c2hTZXR0aW5ncy53aWR0aCA6IG9mZnNldC53aWR0aAp9KSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvUmVzcG9uc2l2ZUNvbnRhaW5lci5qcwp2YXIgUmVhY3Q0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfdGhyb3R0bGUgPSBfX3RvRVNNKHJlcXVpcmVfdGhyb3R0bGUyKCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9Mb2dVdGlscy5qcwp2YXIgaXNEZXYgPSB0cnVlOwp2YXIgd2FybiA9IGZ1bmN0aW9uIHdhcm4yKGNvbmRpdGlvbiwgZm9ybWF0MikgewogIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4gPiAyID8gX2xlbiAtIDIgOiAwKSwgX2tleSA9IDI7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgIGFyZ3NbX2tleSAtIDJdID0gYXJndW1lbnRzW19rZXldOwogIH0KICBpZiAoaXNEZXYgJiYgdHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUud2FybikgewogICAgaWYgKGZvcm1hdDIgPT09IHZvaWQgMCkgewogICAgICBjb25zb2xlLndhcm4oIkxvZ1V0aWxzIHJlcXVpcmVzIGFuIGVycm9yIG1lc3NhZ2UgYXJndW1lbnQiKTsKICAgIH0KICAgIGlmICghY29uZGl0aW9uKSB7CiAgICAgIGlmIChmb3JtYXQyID09PSB2b2lkIDApIHsKICAgICAgICBjb25zb2xlLndhcm4oIk1pbmlmaWVkIGV4Y2VwdGlvbiBvY2N1cnJlZDsgdXNlIHRoZSBub24tbWluaWZpZWQgZGV2IGVudmlyb25tZW50IGZvciB0aGUgZnVsbCBlcnJvciBtZXNzYWdlIGFuZCBhZGRpdGlvbmFsIGhlbHBmdWwgd2FybmluZ3MuIik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGFyZ0luZGV4ID0gMDsKICAgICAgICBjb25zb2xlLndhcm4oZm9ybWF0Mi5yZXBsYWNlKC8lcy9nLCAoKSA9PiBhcmdzW2FyZ0luZGV4KytdKSk7CiAgICAgIH0KICAgIH0KICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvcmVzcG9uc2l2ZUNvbnRhaW5lclV0aWxzLmpzCnZhciBjYWxjdWxhdGVDaGFydERpbWVuc2lvbnMgPSAoY29udGFpbmVyV2lkdGgsIGNvbnRhaW5lckhlaWdodCwgcHJvcHMpID0+IHsKICB2YXIgewogICAgd2lkdGggPSAiMTAwJSIsCiAgICBoZWlnaHQgPSAiMTAwJSIsCiAgICBhc3BlY3QsCiAgICBtYXhIZWlnaHQKICB9ID0gcHJvcHM7CiAgdmFyIGNhbGN1bGF0ZWRXaWR0aCA9IGlzUGVyY2VudCh3aWR0aCkgPyBjb250YWluZXJXaWR0aCA6IE51bWJlcih3aWR0aCk7CiAgdmFyIGNhbGN1bGF0ZWRIZWlnaHQgPSBpc1BlcmNlbnQoaGVpZ2h0KSA/IGNvbnRhaW5lckhlaWdodCA6IE51bWJlcihoZWlnaHQpOwogIGlmIChhc3BlY3QgJiYgYXNwZWN0ID4gMCkgewogICAgaWYgKGNhbGN1bGF0ZWRXaWR0aCkgewogICAgICBjYWxjdWxhdGVkSGVpZ2h0ID0gY2FsY3VsYXRlZFdpZHRoIC8gYXNwZWN0OwogICAgfSBlbHNlIGlmIChjYWxjdWxhdGVkSGVpZ2h0KSB7CiAgICAgIGNhbGN1bGF0ZWRXaWR0aCA9IGNhbGN1bGF0ZWRIZWlnaHQgKiBhc3BlY3Q7CiAgICB9CiAgICBpZiAobWF4SGVpZ2h0ICYmIGNhbGN1bGF0ZWRIZWlnaHQgIT0gbnVsbCAmJiBjYWxjdWxhdGVkSGVpZ2h0ID4gbWF4SGVpZ2h0KSB7CiAgICAgIGNhbGN1bGF0ZWRIZWlnaHQgPSBtYXhIZWlnaHQ7CiAgICB9CiAgfQogIHJldHVybiB7CiAgICBjYWxjdWxhdGVkV2lkdGgsCiAgICBjYWxjdWxhdGVkSGVpZ2h0CiAgfTsKfTsKdmFyIGJvdGhPdmVyZmxvdyA9IHsKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgb3ZlcmZsb3c6ICJ2aXNpYmxlIgp9Owp2YXIgb3ZlcmZsb3dYID0gewogIHdpZHRoOiAwLAogIG92ZXJmbG93WDogInZpc2libGUiCn07CnZhciBvdmVyZmxvd1kgPSB7CiAgaGVpZ2h0OiAwLAogIG92ZXJmbG93WTogInZpc2libGUiCn07CnZhciBub1N0eWxlID0ge307CnZhciBnZXRJbm5lckRpdlN0eWxlID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHByb3BzOwogIHZhciBpc1dpZHRoUGVyY2VudCA9IGlzUGVyY2VudCh3aWR0aCk7CiAgdmFyIGlzSGVpZ2h0UGVyY2VudCA9IGlzUGVyY2VudChoZWlnaHQpOwogIGlmIChpc1dpZHRoUGVyY2VudCAmJiBpc0hlaWdodFBlcmNlbnQpIHsKICAgIHJldHVybiBib3RoT3ZlcmZsb3c7CiAgfQogIGlmIChpc1dpZHRoUGVyY2VudCkgewogICAgcmV0dXJuIG92ZXJmbG93WDsKICB9CiAgaWYgKGlzSGVpZ2h0UGVyY2VudCkgewogICAgcmV0dXJuIG92ZXJmbG93WTsKICB9CiAgcmV0dXJuIG5vU3R5bGU7Cn07CmZ1bmN0aW9uIGdldERlZmF1bHRXaWR0aEFuZEhlaWdodChfcmVmMikgewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGFzcGVjdAogIH0gPSBfcmVmMjsKICB2YXIgY2FsY3VsYXRlZFdpZHRoID0gd2lkdGg7CiAgdmFyIGNhbGN1bGF0ZWRIZWlnaHQgPSBoZWlnaHQ7CiAgaWYgKGNhbGN1bGF0ZWRXaWR0aCA9PT0gdm9pZCAwICYmIGNhbGN1bGF0ZWRIZWlnaHQgPT09IHZvaWQgMCkgewogICAgY2FsY3VsYXRlZFdpZHRoID0gIjEwMCUiOwogICAgY2FsY3VsYXRlZEhlaWdodCA9ICIxMDAlIjsKICB9IGVsc2UgaWYgKGNhbGN1bGF0ZWRXaWR0aCA9PT0gdm9pZCAwKSB7CiAgICBjYWxjdWxhdGVkV2lkdGggPSBhc3BlY3QgJiYgYXNwZWN0ID4gMCA/IHZvaWQgMCA6ICIxMDAlIjsKICB9IGVsc2UgaWYgKGNhbGN1bGF0ZWRIZWlnaHQgPT09IHZvaWQgMCkgewogICAgY2FsY3VsYXRlZEhlaWdodCA9IGFzcGVjdCAmJiBhc3BlY3QgPiAwID8gdm9pZCAwIDogIjEwMCUiOwogIH0KICByZXR1cm4gewogICAgd2lkdGg6IGNhbGN1bGF0ZWRXaWR0aCwKICAgIGhlaWdodDogY2FsY3VsYXRlZEhlaWdodAogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvaXNXZWxsQmVoYXZlZE51bWJlci5qcwpmdW5jdGlvbiBpc1dlbGxCZWhhdmVkTnVtYmVyKG4pIHsKICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKG4pOwp9CmZ1bmN0aW9uIGlzUG9zaXRpdmVOdW1iZXIobikgewogIHJldHVybiB0eXBlb2YgbiA9PT0gIm51bWJlciIgJiYgbiA+IDAgJiYgTnVtYmVyLmlzRmluaXRlKG4pOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvUmVzcG9uc2l2ZUNvbnRhaW5lci5qcwpmdW5jdGlvbiBfZXh0ZW5kczMoKSB7CiAgcmV0dXJuIF9leHRlbmRzMyA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMy5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIG93bktleXM0KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkNChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czQoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTQoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzNChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5NChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTQocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5NCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU0KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTQodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MTIuY3JlYXRlQ29udGV4dCkoewogIHdpZHRoOiAtMSwKICBoZWlnaHQ6IC0xCn0pOwpmdW5jdGlvbiBpc0FjY2VwdGFibGVTaXplKHNpemUpIHsKICByZXR1cm4gaXNQb3NpdGl2ZU51bWJlcihzaXplLndpZHRoKSAmJiBpc1Bvc2l0aXZlTnVtYmVyKHNpemUuaGVpZ2h0KTsKfQpmdW5jdGlvbiBSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dFByb3ZpZGVyKF9yZWYyKSB7CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gX3JlZjI7CiAgdmFyIHNpemUgPSAoMCwgaW1wb3J0X3JlYWN0MTIudXNlTWVtbykoKCkgPT4gKHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSksIFt3aWR0aCwgaGVpZ2h0XSk7CiAgaWYgKCFpc0FjY2VwdGFibGVTaXplKHNpemUpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudChSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dC5Qcm92aWRlciwgewogICAgdmFsdWU6IHNpemUKICB9LCBjaGlsZHJlbik7Cn0KdmFyIHVzZVJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0ID0gKCkgPT4gKDAsIGltcG9ydF9yZWFjdDEyLnVzZUNvbnRleHQpKFJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0KTsKdmFyIFNpemVEZXRlY3RvckNvbnRhaW5lciA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MTIuZm9yd2FyZFJlZikoKF9yZWYyLCByZWYpID0+IHsKICB2YXIgewogICAgYXNwZWN0LAogICAgaW5pdGlhbERpbWVuc2lvbiA9IHsKICAgICAgd2lkdGg6IC0xLAogICAgICBoZWlnaHQ6IC0xCiAgICB9LAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICAvKgogICAgICogZGVmYXVsdCBtaW4td2lkdGggdG8gMCBpZiBub3Qgc3BlY2lmaWVkIC0gJ2F1dG8nIGNhdXNlcyBpc3N1ZXMgd2l0aCBmbGV4Ym94CiAgICAgKiBodHRwczovL2dpdGh1Yi5jb20vcmVjaGFydHMvcmVjaGFydHMvaXNzdWVzLzE3MgogICAgICovCiAgICBtaW5XaWR0aCA9IDAsCiAgICBtaW5IZWlnaHQsCiAgICBtYXhIZWlnaHQsCiAgICBjaGlsZHJlbiwKICAgIGRlYm91bmNlID0gMCwKICAgIGlkLAogICAgY2xhc3NOYW1lLAogICAgb25SZXNpemUsCiAgICBzdHlsZSA9IHt9CiAgfSA9IF9yZWYyOwogIHZhciBjb250YWluZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTIudXNlUmVmKShudWxsKTsKICB2YXIgb25SZXNpemVSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTIudXNlUmVmKSgpOwogIG9uUmVzaXplUmVmLmN1cnJlbnQgPSBvblJlc2l6ZTsKICAoMCwgaW1wb3J0X3JlYWN0MTIudXNlSW1wZXJhdGl2ZUhhbmRsZSkocmVmLCAoKSA9PiBjb250YWluZXJSZWYuY3VycmVudCk7CiAgdmFyIFtzaXplcywgc2V0U2l6ZXNdID0gKDAsIGltcG9ydF9yZWFjdDEyLnVzZVN0YXRlKSh7CiAgICBjb250YWluZXJXaWR0aDogaW5pdGlhbERpbWVuc2lvbi53aWR0aCwKICAgIGNvbnRhaW5lckhlaWdodDogaW5pdGlhbERpbWVuc2lvbi5oZWlnaHQKICB9KTsKICB2YXIgc2V0Q29udGFpbmVyU2l6ZSA9ICgwLCBpbXBvcnRfcmVhY3QxMi51c2VDYWxsYmFjaykoKG5ld1dpZHRoLCBuZXdIZWlnaHQpID0+IHsKICAgIHNldFNpemVzKChwcmV2U3RhdGUpID0+IHsKICAgICAgdmFyIHJvdW5kZWRXaWR0aCA9IE1hdGgucm91bmQobmV3V2lkdGgpOwogICAgICB2YXIgcm91bmRlZEhlaWdodCA9IE1hdGgucm91bmQobmV3SGVpZ2h0KTsKICAgICAgaWYgKHByZXZTdGF0ZS5jb250YWluZXJXaWR0aCA9PT0gcm91bmRlZFdpZHRoICYmIHByZXZTdGF0ZS5jb250YWluZXJIZWlnaHQgPT09IHJvdW5kZWRIZWlnaHQpIHsKICAgICAgICByZXR1cm4gcHJldlN0YXRlOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgY29udGFpbmVyV2lkdGg6IHJvdW5kZWRXaWR0aCwKICAgICAgICBjb250YWluZXJIZWlnaHQ6IHJvdW5kZWRIZWlnaHQKICAgICAgfTsKICAgIH0pOwogIH0sIFtdKTsKICAoMCwgaW1wb3J0X3JlYWN0MTIudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoY29udGFpbmVyUmVmLmN1cnJlbnQgPT0gbnVsbCB8fCB0eXBlb2YgUmVzaXplT2JzZXJ2ZXIgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHJldHVybiBub29wOwogICAgfQogICAgdmFyIGNhbGxiYWNrID0gKGVudHJpZXMpID0+IHsKICAgICAgdmFyIF9vblJlc2l6ZVJlZiRjdXJyZW50OwogICAgICB2YXIgewogICAgICAgIHdpZHRoOiBjb250YWluZXJXaWR0aDMsCiAgICAgICAgaGVpZ2h0OiBjb250YWluZXJIZWlnaHQzCiAgICAgIH0gPSBlbnRyaWVzWzBdLmNvbnRlbnRSZWN0OwogICAgICBzZXRDb250YWluZXJTaXplKGNvbnRhaW5lcldpZHRoMywgY29udGFpbmVySGVpZ2h0Myk7CiAgICAgIChfb25SZXNpemVSZWYkY3VycmVudCA9IG9uUmVzaXplUmVmLmN1cnJlbnQpID09PSBudWxsIHx8IF9vblJlc2l6ZVJlZiRjdXJyZW50ID09PSB2b2lkIDAgfHwgX29uUmVzaXplUmVmJGN1cnJlbnQuY2FsbChvblJlc2l6ZVJlZiwgY29udGFpbmVyV2lkdGgzLCBjb250YWluZXJIZWlnaHQzKTsKICAgIH07CiAgICBpZiAoZGVib3VuY2UgPiAwKSB7CiAgICAgIGNhbGxiYWNrID0gKDAsIGltcG9ydF90aHJvdHRsZS5kZWZhdWx0KShjYWxsYmFjaywgZGVib3VuY2UsIHsKICAgICAgICB0cmFpbGluZzogdHJ1ZSwKICAgICAgICBsZWFkaW5nOiBmYWxzZQogICAgICB9KTsKICAgIH0KICAgIHZhciBvYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcihjYWxsYmFjayk7CiAgICB2YXIgewogICAgICB3aWR0aDogY29udGFpbmVyV2lkdGgyLAogICAgICBoZWlnaHQ6IGNvbnRhaW5lckhlaWdodDIKICAgIH0gPSBjb250YWluZXJSZWYuY3VycmVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIHNldENvbnRhaW5lclNpemUoY29udGFpbmVyV2lkdGgyLCBjb250YWluZXJIZWlnaHQyKTsKICAgIG9ic2VydmVyLm9ic2VydmUoY29udGFpbmVyUmVmLmN1cnJlbnQpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgb2JzZXJ2ZXIuZGlzY29ubmVjdCgpOwogICAgfTsKICB9LCBbc2V0Q29udGFpbmVyU2l6ZSwgZGVib3VuY2VdKTsKICB2YXIgewogICAgY29udGFpbmVyV2lkdGgsCiAgICBjb250YWluZXJIZWlnaHQKICB9ID0gc2l6ZXM7CiAgd2FybighYXNwZWN0IHx8IGFzcGVjdCA+IDAsICJUaGUgYXNwZWN0KCVzKSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIsIGFzcGVjdCk7CiAgdmFyIHsKICAgIGNhbGN1bGF0ZWRXaWR0aCwKICAgIGNhbGN1bGF0ZWRIZWlnaHQKICB9ID0gY2FsY3VsYXRlQ2hhcnREaW1lbnNpb25zKGNvbnRhaW5lcldpZHRoLCBjb250YWluZXJIZWlnaHQsIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgYXNwZWN0LAogICAgbWF4SGVpZ2h0CiAgfSk7CiAgd2FybihjYWxjdWxhdGVkV2lkdGggIT0gbnVsbCAmJiBjYWxjdWxhdGVkV2lkdGggPiAwIHx8IGNhbGN1bGF0ZWRIZWlnaHQgIT0gbnVsbCAmJiBjYWxjdWxhdGVkSGVpZ2h0ID4gMCwgIlRoZSB3aWR0aCglcykgYW5kIGhlaWdodCglcykgb2YgY2hhcnQgc2hvdWxkIGJlIGdyZWF0ZXIgdGhhbiAwLFxuICAgICAgIHBsZWFzZSBjaGVjayB0aGUgc3R5bGUgb2YgY29udGFpbmVyLCBvciB0aGUgcHJvcHMgd2lkdGgoJXMpIGFuZCBoZWlnaHQoJXMpLFxuICAgICAgIG9yIGFkZCBhIG1pbldpZHRoKCVzKSBvciBtaW5IZWlnaHQoJXMpIG9yIHVzZSBhc3BlY3QoJXMpIHRvIGNvbnRyb2wgdGhlXG4gICAgICAgaGVpZ2h0IGFuZCB3aWR0aC4iLCBjYWxjdWxhdGVkV2lkdGgsIGNhbGN1bGF0ZWRIZWlnaHQsIHdpZHRoLCBoZWlnaHQsIG1pbldpZHRoLCBtaW5IZWlnaHQsIGFzcGVjdCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudCgiZGl2IiwgewogICAgaWQ6IGlkID8gIiIuY29uY2F0KGlkKSA6IHZvaWQgMCwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtcmVzcG9uc2l2ZS1jb250YWluZXIiLCBjbGFzc05hbWUpLAogICAgc3R5bGU6IF9vYmplY3RTcHJlYWQ0KF9vYmplY3RTcHJlYWQ0KHt9LCBzdHlsZSksIHt9LCB7CiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQsCiAgICAgIG1pbldpZHRoLAogICAgICBtaW5IZWlnaHQsCiAgICAgIG1heEhlaWdodAogICAgfSksCiAgICByZWY6IGNvbnRhaW5lclJlZgogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudCgiZGl2IiwgewogICAgc3R5bGU6IGdldElubmVyRGl2U3R5bGUoewogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9KQogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudChSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dFByb3ZpZGVyLCB7CiAgICB3aWR0aDogY2FsY3VsYXRlZFdpZHRoLAogICAgaGVpZ2h0OiBjYWxjdWxhdGVkSGVpZ2h0CiAgfSwgY2hpbGRyZW4pKSk7Cn0pOwp2YXIgUmVzcG9uc2l2ZUNvbnRhaW5lciA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MTIuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgcmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQgPSB1c2VSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCgpOwogIGlmIChpc1Bvc2l0aXZlTnVtYmVyKHJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0LndpZHRoKSAmJiBpc1Bvc2l0aXZlTnVtYmVyKHJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0LmhlaWdodCkpIHsKICAgIHJldHVybiBwcm9wcy5jaGlsZHJlbjsKICB9CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IGdldERlZmF1bHRXaWR0aEFuZEhlaWdodCh7CiAgICB3aWR0aDogcHJvcHMud2lkdGgsCiAgICBoZWlnaHQ6IHByb3BzLmhlaWdodCwKICAgIGFzcGVjdDogcHJvcHMuYXNwZWN0CiAgfSk7CiAgdmFyIHsKICAgIGNhbGN1bGF0ZWRXaWR0aCwKICAgIGNhbGN1bGF0ZWRIZWlnaHQKICB9ID0gY2FsY3VsYXRlQ2hhcnREaW1lbnNpb25zKHZvaWQgMCwgdm9pZCAwLCB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGFzcGVjdDogcHJvcHMuYXNwZWN0LAogICAgbWF4SGVpZ2h0OiBwcm9wcy5tYXhIZWlnaHQKICB9KTsKICBpZiAoaXNOdW1iZXIoY2FsY3VsYXRlZFdpZHRoKSAmJiBpc051bWJlcihjYWxjdWxhdGVkSGVpZ2h0KSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudChSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dFByb3ZpZGVyLCB7CiAgICAgIHdpZHRoOiBjYWxjdWxhdGVkV2lkdGgsCiAgICAgIGhlaWdodDogY2FsY3VsYXRlZEhlaWdodAogICAgfSwgcHJvcHMuY2hpbGRyZW4pOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0NC5jcmVhdGVFbGVtZW50KFNpemVEZXRlY3RvckNvbnRhaW5lciwgX2V4dGVuZHMzKHt9LCBwcm9wcywgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByZWYKICB9KSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9jaGFydExheW91dENvbnRleHQuanMKZnVuY3Rpb24gY2FydGVzaWFuVmlld0JveFRvVHJhcGV6b2lkKGJveCkgewogIGlmICghYm94KSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gewogICAgeDogYm94LngsCiAgICB5OiBib3gueSwKICAgIHVwcGVyV2lkdGg6ICJ1cHBlcldpZHRoIiBpbiBib3ggPyBib3gudXBwZXJXaWR0aCA6IGJveC53aWR0aCwKICAgIGxvd2VyV2lkdGg6ICJsb3dlcldpZHRoIiBpbiBib3ggPyBib3gubG93ZXJXaWR0aCA6IGJveC53aWR0aCwKICAgIHdpZHRoOiBib3gud2lkdGgsCiAgICBoZWlnaHQ6IGJveC5oZWlnaHQKICB9Owp9CnZhciB1c2VWaWV3Qm94ID0gKCkgPT4gewogIHZhciBfdXNlQXBwU2VsZWN0b3I7CiAgdmFyIHBhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciByb290Vmlld0JveCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0Vmlld0JveCk7CiAgdmFyIGJydXNoRGltZW5zaW9ucyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEJydXNoRGltZW5zaW9ucyk7CiAgdmFyIGJydXNoUGFkZGluZyA9IChfdXNlQXBwU2VsZWN0b3IgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RCcnVzaFNldHRpbmdzKSkgPT09IG51bGwgfHwgX3VzZUFwcFNlbGVjdG9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdXNlQXBwU2VsZWN0b3IucGFkZGluZzsKICBpZiAoIXBhbm9yYW1hIHx8ICFicnVzaERpbWVuc2lvbnMgfHwgIWJydXNoUGFkZGluZykgewogICAgcmV0dXJuIHJvb3RWaWV3Qm94OwogIH0KICByZXR1cm4gewogICAgd2lkdGg6IGJydXNoRGltZW5zaW9ucy53aWR0aCAtIGJydXNoUGFkZGluZy5sZWZ0IC0gYnJ1c2hQYWRkaW5nLnJpZ2h0LAogICAgaGVpZ2h0OiBicnVzaERpbWVuc2lvbnMuaGVpZ2h0IC0gYnJ1c2hQYWRkaW5nLnRvcCAtIGJydXNoUGFkZGluZy5ib3R0b20sCiAgICB4OiBicnVzaFBhZGRpbmcubGVmdCwKICAgIHk6IGJydXNoUGFkZGluZy50b3AKICB9Owp9Owp2YXIgbWFueUNvbXBvbmVudHNUaHJvd0Vycm9yc0lmT2Zmc2V0SXNVbmRlZmluZWQgPSB7CiAgdG9wOiAwLAogIGJvdHRvbTogMCwKICBsZWZ0OiAwLAogIHJpZ2h0OiAwLAogIHdpZHRoOiAwLAogIGhlaWdodDogMCwKICBicnVzaEJvdHRvbTogMAp9Owp2YXIgdXNlT2Zmc2V0SW50ZXJuYWwgPSAoKSA9PiB7CiAgdmFyIF91c2VBcHBTZWxlY3RvcjI7CiAgcmV0dXJuIChfdXNlQXBwU2VsZWN0b3IyID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCkpICE9PSBudWxsICYmIF91c2VBcHBTZWxlY3RvcjIgIT09IHZvaWQgMCA/IF91c2VBcHBTZWxlY3RvcjIgOiBtYW55Q29tcG9uZW50c1Rocm93RXJyb3JzSWZPZmZzZXRJc1VuZGVmaW5lZDsKfTsKdmFyIHVzZUNoYXJ0V2lkdGggPSAoKSA9PiB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0V2lkdGgpOwp9Owp2YXIgdXNlQ2hhcnRIZWlnaHQgPSAoKSA9PiB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0SGVpZ2h0KTsKfTsKdmFyIHNlbGVjdENoYXJ0TGF5b3V0ID0gKHN0YXRlKSA9PiBzdGF0ZS5sYXlvdXQubGF5b3V0VHlwZTsKdmFyIHVzZUNoYXJ0TGF5b3V0ID0gKCkgPT4gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0Q2hhcnRMYXlvdXQpOwp2YXIgdXNlQ2FydGVzaWFuQ2hhcnRMYXlvdXQgPSAoKSA9PiB7CiAgdmFyIGxheW91dCA9IHVzZUNoYXJ0TGF5b3V0KCk7CiAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiIHx8IGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgcmV0dXJuIGxheW91dDsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIHVzZUlzSW5DaGFydENvbnRleHQgPSAoKSA9PiB7CiAgdmFyIGxheW91dCA9IHVzZUNoYXJ0TGF5b3V0KCk7CiAgcmV0dXJuIGxheW91dCAhPT0gdm9pZCAwOwp9Owp2YXIgUmVwb3J0Q2hhcnRTaXplID0gKHByb3BzKSA9PiB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgewogICAgd2lkdGg6IHdpZHRoRnJvbVByb3BzLAogICAgaGVpZ2h0OiBoZWlnaHRGcm9tUHJvcHMKICB9ID0gcHJvcHM7CiAgdmFyIHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPSB1c2VSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCgpOwogIHZhciB3aWR0aCA9IHdpZHRoRnJvbVByb3BzOwogIHZhciBoZWlnaHQgPSBoZWlnaHRGcm9tUHJvcHM7CiAgaWYgKHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMpIHsKICAgIHdpZHRoID0gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy53aWR0aCA+IDAgPyByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLndpZHRoIDogd2lkdGhGcm9tUHJvcHM7CiAgICBoZWlnaHQgPSByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLmhlaWdodCA+IDAgPyByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLmhlaWdodCA6IGhlaWdodEZyb21Qcm9wczsKICB9CiAgKDAsIGltcG9ydF9yZWFjdDEzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFpc1Bhbm9yYW1hICYmIGlzUG9zaXRpdmVOdW1iZXIod2lkdGgpICYmIGlzUG9zaXRpdmVOdW1iZXIoaGVpZ2h0KSkgewogICAgICBkaXNwYXRjaChzZXRDaGFydFNpemUoewogICAgICAgIHdpZHRoLAogICAgICAgIGhlaWdodAogICAgICB9KSk7CiAgICB9CiAgfSwgW2Rpc3BhdGNoLCBpc1Bhbm9yYW1hLCB3aWR0aCwgaGVpZ2h0XSk7CiAgcmV0dXJuIG51bGw7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vaW1tZXJAMTAuMi4wL25vZGVfbW9kdWxlcy9pbW1lci9kaXN0L2ltbWVyLm1qcwp2YXIgTk9USElORzIgPSBTeW1ib2wuZm9yKCJpbW1lci1ub3RoaW5nIik7CnZhciBEUkFGVEFCTEUyID0gU3ltYm9sLmZvcigiaW1tZXItZHJhZnRhYmxlIik7CnZhciBEUkFGVF9TVEFURTIgPSBTeW1ib2wuZm9yKCJpbW1lci1zdGF0ZSIpOwp2YXIgZXJyb3JzMiA9IHRydWUgPyBbCiAgLy8gQWxsIGVycm9yIGNvZGVzLCBzdGFydGluZyBieSAwOgogIGZ1bmN0aW9uKHBsdWdpbikgewogICAgcmV0dXJuIGBUaGUgcGx1Z2luIGZvciAnJHtwbHVnaW59JyBoYXMgbm90IGJlZW4gbG9hZGVkIGludG8gSW1tZXIuIFRvIGVuYWJsZSB0aGUgcGx1Z2luLCBpbXBvcnQgYW5kIGNhbGwgXGBlbmFibGUke3BsdWdpbn0oKVxgIHdoZW4gaW5pdGlhbGl6aW5nIHlvdXIgYXBwbGljYXRpb24uYDsKICB9LAogIGZ1bmN0aW9uKHRoaW5nKSB7CiAgICByZXR1cm4gYHByb2R1Y2UgY2FuIG9ubHkgYmUgY2FsbGVkIG9uIHRoaW5ncyB0aGF0IGFyZSBkcmFmdGFibGU6IHBsYWluIG9iamVjdHMsIGFycmF5cywgTWFwLCBTZXQgb3IgY2xhc3NlcyB0aGF0IGFyZSBtYXJrZWQgd2l0aCAnW2ltbWVyYWJsZV06IHRydWUnLiBHb3QgJyR7dGhpbmd9J2A7CiAgfSwKICAiVGhpcyBvYmplY3QgaGFzIGJlZW4gZnJvemVuIGFuZCBzaG91bGQgbm90IGJlIG11dGF0ZWQiLAogIGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiAiQ2Fubm90IHVzZSBhIHByb3h5IHRoYXQgaGFzIGJlZW4gcmV2b2tlZC4gRGlkIHlvdSBwYXNzIGFuIG9iamVjdCBmcm9tIGluc2lkZSBhbiBpbW1lciBmdW5jdGlvbiB0byBhbiBhc3luYyBwcm9jZXNzPyAiICsgZGF0YTsKICB9LAogICJBbiBpbW1lciBwcm9kdWNlciByZXR1cm5lZCBhIG5ldyB2YWx1ZSAqYW5kKiBtb2RpZmllZCBpdHMgZHJhZnQuIEVpdGhlciByZXR1cm4gYSBuZXcgdmFsdWUgKm9yKiBtb2RpZnkgdGhlIGRyYWZ0LiIsCiAgIkltbWVyIGZvcmJpZHMgY2lyY3VsYXIgcmVmZXJlbmNlcyIsCiAgIlRoZSBmaXJzdCBvciBzZWNvbmQgYXJndW1lbnQgdG8gYHByb2R1Y2VgIG11c3QgYmUgYSBmdW5jdGlvbiIsCiAgIlRoZSB0aGlyZCBhcmd1bWVudCB0byBgcHJvZHVjZWAgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIHVuZGVmaW5lZCIsCiAgIkZpcnN0IGFyZ3VtZW50IHRvIGBjcmVhdGVEcmFmdGAgbXVzdCBiZSBhIHBsYWluIG9iamVjdCwgYW4gYXJyYXksIG9yIGFuIGltbWVyYWJsZSBvYmplY3QiLAogICJGaXJzdCBhcmd1bWVudCB0byBgZmluaXNoRHJhZnRgIG11c3QgYmUgYSBkcmFmdCByZXR1cm5lZCBieSBgY3JlYXRlRHJhZnRgIiwKICBmdW5jdGlvbih0aGluZykgewogICAgcmV0dXJuIGAnY3VycmVudCcgZXhwZWN0cyBhIGRyYWZ0LCBnb3Q6ICR7dGhpbmd9YDsKICB9LAogICJPYmplY3QuZGVmaW5lUHJvcGVydHkoKSBjYW5ub3QgYmUgdXNlZCBvbiBhbiBJbW1lciBkcmFmdCIsCiAgIk9iamVjdC5zZXRQcm90b3R5cGVPZigpIGNhbm5vdCBiZSB1c2VkIG9uIGFuIEltbWVyIGRyYWZ0IiwKICAiSW1tZXIgb25seSBzdXBwb3J0cyBkZWxldGluZyBhcnJheSBpbmRpY2VzIiwKICAiSW1tZXIgb25seSBzdXBwb3J0cyBzZXR0aW5nIGFycmF5IGluZGljZXMgYW5kIHRoZSAnbGVuZ3RoJyBwcm9wZXJ0eSIsCiAgZnVuY3Rpb24odGhpbmcpIHsKICAgIHJldHVybiBgJ29yaWdpbmFsJyBleHBlY3RzIGEgZHJhZnQsIGdvdDogJHt0aGluZ31gOwogIH0KICAvLyBOb3RlOiBpZiBtb3JlIGVycm9ycyBhcmUgYWRkZWQsIHRoZSBlcnJvck9mZnNldCBpbiBQYXRjaGVzLnRzIHNob3VsZCBiZSBpbmNyZWFzZWQKICAvLyBTZWUgUGF0Y2hlcy50cyBmb3IgYWRkaXRpb25hbCBlcnJvcnMKXSA6IFtdOwpmdW5jdGlvbiBkaWUyKGVycm9yLCAuLi5hcmdzKSB7CiAgaWYgKHRydWUpIHsKICAgIGNvbnN0IGUgPSBlcnJvcnMyW2Vycm9yXTsKICAgIGNvbnN0IG1zZyA9IHR5cGVvZiBlID09PSAiZnVuY3Rpb24iID8gZS5hcHBseShudWxsLCBhcmdzKSA6IGU7CiAgICB0aHJvdyBuZXcgRXJyb3IoYFtJbW1lcl0gJHttc2d9YCk7CiAgfQogIHRocm93IG5ldyBFcnJvcigKICAgIGBbSW1tZXJdIG1pbmlmaWVkIGVycm9yIG5yOiAke2Vycm9yfS4gRnVsbCBlcnJvciBhdDogaHR0cHM6Ly9iaXQubHkvM2NYRUtXZmAKICApOwp9CnZhciBnZXRQcm90b3R5cGVPZjIgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Y7CmZ1bmN0aW9uIGlzRHJhZnQyKHZhbHVlKSB7CiAgcmV0dXJuICEhdmFsdWUgJiYgISF2YWx1ZVtEUkFGVF9TVEFURTJdOwp9CmZ1bmN0aW9uIGlzRHJhZnRhYmxlMih2YWx1ZSkgewogIGlmICghdmFsdWUpCiAgICByZXR1cm4gZmFsc2U7CiAgcmV0dXJuIGlzUGxhaW5PYmplY3QzKHZhbHVlKSB8fCBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCAhIXZhbHVlW0RSQUZUQUJMRTJdIHx8ICEhdmFsdWUuY29uc3RydWN0b3I/LltEUkFGVEFCTEUyXSB8fCBpc01hcDIodmFsdWUpIHx8IGlzU2V0Mih2YWx1ZSk7Cn0KdmFyIG9iamVjdEN0b3JTdHJpbmcyID0gT2JqZWN0LnByb3RvdHlwZS5jb25zdHJ1Y3Rvci50b1N0cmluZygpOwp2YXIgY2FjaGVkQ3RvclN0cmluZ3MyID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CmZ1bmN0aW9uIGlzUGxhaW5PYmplY3QzKHZhbHVlKSB7CiAgaWYgKCF2YWx1ZSB8fCB0eXBlb2YgdmFsdWUgIT09ICJvYmplY3QiKQogICAgcmV0dXJuIGZhbHNlOwogIGNvbnN0IHByb3RvMiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih2YWx1ZSk7CiAgaWYgKHByb3RvMiA9PT0gbnVsbCB8fCBwcm90bzIgPT09IE9iamVjdC5wcm90b3R5cGUpCiAgICByZXR1cm4gdHJ1ZTsKICBjb25zdCBDdG9yID0gT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwocHJvdG8yLCAiY29uc3RydWN0b3IiKSAmJiBwcm90bzIuY29uc3RydWN0b3I7CiAgaWYgKEN0b3IgPT09IE9iamVjdCkKICAgIHJldHVybiB0cnVlOwogIGlmICh0eXBlb2YgQ3RvciAhPT0gImZ1bmN0aW9uIikKICAgIHJldHVybiBmYWxzZTsKICBsZXQgY3RvclN0cmluZyA9IGNhY2hlZEN0b3JTdHJpbmdzMi5nZXQoQ3Rvcik7CiAgaWYgKGN0b3JTdHJpbmcgPT09IHZvaWQgMCkgewogICAgY3RvclN0cmluZyA9IEZ1bmN0aW9uLnRvU3RyaW5nLmNhbGwoQ3Rvcik7CiAgICBjYWNoZWRDdG9yU3RyaW5nczIuc2V0KEN0b3IsIGN0b3JTdHJpbmcpOwogIH0KICByZXR1cm4gY3RvclN0cmluZyA9PT0gb2JqZWN0Q3RvclN0cmluZzI7Cn0KZnVuY3Rpb24gZWFjaDIob2JqLCBpdGVyLCBzdHJpY3QgPSB0cnVlKSB7CiAgaWYgKGdldEFyY2h0eXBlMihvYmopID09PSAwKSB7CiAgICBjb25zdCBrZXlzID0gc3RyaWN0ID8gUmVmbGVjdC5vd25LZXlzKG9iaikgOiBPYmplY3Qua2V5cyhvYmopOwogICAga2V5cy5mb3JFYWNoKChrZXkpID0+IHsKICAgICAgaXRlcihrZXksIG9ialtrZXldLCBvYmopOwogICAgfSk7CiAgfSBlbHNlIHsKICAgIG9iai5mb3JFYWNoKChlbnRyeSwgaW5kZXgpID0+IGl0ZXIoaW5kZXgsIGVudHJ5LCBvYmopKTsKICB9Cn0KZnVuY3Rpb24gZ2V0QXJjaHR5cGUyKHRoaW5nKSB7CiAgY29uc3Qgc3RhdGUgPSB0aGluZ1tEUkFGVF9TVEFURTJdOwogIHJldHVybiBzdGF0ZSA/IHN0YXRlLnR5cGVfIDogQXJyYXkuaXNBcnJheSh0aGluZykgPyAxIDogaXNNYXAyKHRoaW5nKSA/IDIgOiBpc1NldDIodGhpbmcpID8gMyA6IDA7Cn0KZnVuY3Rpb24gaGFzMih0aGluZywgcHJvcCkgewogIHJldHVybiBnZXRBcmNodHlwZTIodGhpbmcpID09PSAyID8gdGhpbmcuaGFzKHByb3ApIDogT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaW5nLCBwcm9wKTsKfQpmdW5jdGlvbiBzZXQyKHRoaW5nLCBwcm9wT3JPbGRWYWx1ZSwgdmFsdWUpIHsKICBjb25zdCB0ID0gZ2V0QXJjaHR5cGUyKHRoaW5nKTsKICBpZiAodCA9PT0gMikKICAgIHRoaW5nLnNldChwcm9wT3JPbGRWYWx1ZSwgdmFsdWUpOwogIGVsc2UgaWYgKHQgPT09IDMpIHsKICAgIHRoaW5nLmFkZCh2YWx1ZSk7CiAgfSBlbHNlCiAgICB0aGluZ1twcm9wT3JPbGRWYWx1ZV0gPSB2YWx1ZTsKfQpmdW5jdGlvbiBpczIoeDIsIHkyKSB7CiAgaWYgKHgyID09PSB5MikgewogICAgcmV0dXJuIHgyICE9PSAwIHx8IDEgLyB4MiA9PT0gMSAvIHkyOwogIH0gZWxzZSB7CiAgICByZXR1cm4geDIgIT09IHgyICYmIHkyICE9PSB5MjsKICB9Cn0KZnVuY3Rpb24gaXNNYXAyKHRhcmdldCkgewogIHJldHVybiB0YXJnZXQgaW5zdGFuY2VvZiBNYXA7Cn0KZnVuY3Rpb24gaXNTZXQyKHRhcmdldCkgewogIHJldHVybiB0YXJnZXQgaW5zdGFuY2VvZiBTZXQ7Cn0KZnVuY3Rpb24gbGF0ZXN0MihzdGF0ZSkgewogIHJldHVybiBzdGF0ZS5jb3B5XyB8fCBzdGF0ZS5iYXNlXzsKfQpmdW5jdGlvbiBzaGFsbG93Q29weTIoYmFzZSwgc3RyaWN0KSB7CiAgaWYgKGlzTWFwMihiYXNlKSkgewogICAgcmV0dXJuIG5ldyBNYXAoYmFzZSk7CiAgfQogIGlmIChpc1NldDIoYmFzZSkpIHsKICAgIHJldHVybiBuZXcgU2V0KGJhc2UpOwogIH0KICBpZiAoQXJyYXkuaXNBcnJheShiYXNlKSkKICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChiYXNlKTsKICBjb25zdCBpc1BsYWluMiA9IGlzUGxhaW5PYmplY3QzKGJhc2UpOwogIGlmIChzdHJpY3QgPT09IHRydWUgfHwgc3RyaWN0ID09PSAiY2xhc3Nfb25seSIgJiYgIWlzUGxhaW4yKSB7CiAgICBjb25zdCBkZXNjcmlwdG9ycyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKGJhc2UpOwogICAgZGVsZXRlIGRlc2NyaXB0b3JzW0RSQUZUX1NUQVRFMl07CiAgICBsZXQga2V5cyA9IFJlZmxlY3Qub3duS2V5cyhkZXNjcmlwdG9ycyk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qga2V5ID0ga2V5c1tpXTsKICAgICAgY29uc3QgZGVzYyA9IGRlc2NyaXB0b3JzW2tleV07CiAgICAgIGlmIChkZXNjLndyaXRhYmxlID09PSBmYWxzZSkgewogICAgICAgIGRlc2Mud3JpdGFibGUgPSB0cnVlOwogICAgICAgIGRlc2MuY29uZmlndXJhYmxlID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoZGVzYy5nZXQgfHwgZGVzYy5zZXQpCiAgICAgICAgZGVzY3JpcHRvcnNba2V5XSA9IHsKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgLy8gY291bGQgbGl2ZSB3aXRoICEhZGVzYy5zZXQgYXMgd2VsbCBoZXJlLi4uCiAgICAgICAgICBlbnVtZXJhYmxlOiBkZXNjLmVudW1lcmFibGUsCiAgICAgICAgICB2YWx1ZTogYmFzZVtrZXldCiAgICAgICAgfTsKICAgIH0KICAgIHJldHVybiBPYmplY3QuY3JlYXRlKGdldFByb3RvdHlwZU9mMihiYXNlKSwgZGVzY3JpcHRvcnMpOwogIH0gZWxzZSB7CiAgICBjb25zdCBwcm90bzIgPSBnZXRQcm90b3R5cGVPZjIoYmFzZSk7CiAgICBpZiAocHJvdG8yICE9PSBudWxsICYmIGlzUGxhaW4yKSB7CiAgICAgIHJldHVybiB7IC4uLmJhc2UgfTsKICAgIH0KICAgIGNvbnN0IG9iaiA9IE9iamVjdC5jcmVhdGUocHJvdG8yKTsKICAgIHJldHVybiBPYmplY3QuYXNzaWduKG9iaiwgYmFzZSk7CiAgfQp9CmZ1bmN0aW9uIGZyZWV6ZTIob2JqLCBkZWVwID0gZmFsc2UpIHsKICBpZiAoaXNGcm96ZW4yKG9iaikgfHwgaXNEcmFmdDIob2JqKSB8fCAhaXNEcmFmdGFibGUyKG9iaikpCiAgICByZXR1cm4gb2JqOwogIGlmIChnZXRBcmNodHlwZTIob2JqKSA+IDEpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKG9iaiwgewogICAgICBzZXQ6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZTIsCiAgICAgIGFkZDogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlMiwKICAgICAgY2xlYXI6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZTIsCiAgICAgIGRlbGV0ZTogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlMgogICAgfSk7CiAgfQogIE9iamVjdC5mcmVlemUob2JqKTsKICBpZiAoZGVlcCkKICAgIE9iamVjdC52YWx1ZXMob2JqKS5mb3JFYWNoKCh2YWx1ZSkgPT4gZnJlZXplMih2YWx1ZSwgdHJ1ZSkpOwogIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gZG9udE11dGF0ZUZyb3plbkNvbGxlY3Rpb25zMigpIHsKICBkaWUyKDIpOwp9CnZhciBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUyID0gewogIHZhbHVlOiBkb250TXV0YXRlRnJvemVuQ29sbGVjdGlvbnMyCn07CmZ1bmN0aW9uIGlzRnJvemVuMihvYmopIHsKICBpZiAob2JqID09PSBudWxsIHx8IHR5cGVvZiBvYmogIT09ICJvYmplY3QiKQogICAgcmV0dXJuIHRydWU7CiAgcmV0dXJuIE9iamVjdC5pc0Zyb3plbihvYmopOwp9CnZhciBwbHVnaW5zMiA9IHt9OwpmdW5jdGlvbiBnZXRQbHVnaW4yKHBsdWdpbktleSkgewogIGNvbnN0IHBsdWdpbiA9IHBsdWdpbnMyW3BsdWdpbktleV07CiAgaWYgKCFwbHVnaW4pIHsKICAgIGRpZTIoMCwgcGx1Z2luS2V5KTsKICB9CiAgcmV0dXJuIHBsdWdpbjsKfQp2YXIgY3VycmVudFNjb3BlMjsKZnVuY3Rpb24gZ2V0Q3VycmVudFNjb3BlMigpIHsKICByZXR1cm4gY3VycmVudFNjb3BlMjsKfQpmdW5jdGlvbiBjcmVhdGVTY29wZTIocGFyZW50XywgaW1tZXJfKSB7CiAgcmV0dXJuIHsKICAgIGRyYWZ0c186IFtdLAogICAgcGFyZW50XywKICAgIGltbWVyXywKICAgIC8vIFdoZW5ldmVyIHRoZSBtb2RpZmllZCBkcmFmdCBjb250YWlucyBhIGRyYWZ0IGZyb20gYW5vdGhlciBzY29wZSwgd2UKICAgIC8vIG5lZWQgdG8gcHJldmVudCBhdXRvLWZyZWV6aW5nIHNvIHRoZSB1bm93bmVkIGRyYWZ0IGNhbiBiZSBmaW5hbGl6ZWQuCiAgICBjYW5BdXRvRnJlZXplXzogdHJ1ZSwKICAgIHVuZmluYWxpemVkRHJhZnRzXzogMAogIH07Cn0KZnVuY3Rpb24gdXNlUGF0Y2hlc0luU2NvcGUyKHNjb3BlLCBwYXRjaExpc3RlbmVyKSB7CiAgaWYgKHBhdGNoTGlzdGVuZXIpIHsKICAgIGdldFBsdWdpbjIoIlBhdGNoZXMiKTsKICAgIHNjb3BlLnBhdGNoZXNfID0gW107CiAgICBzY29wZS5pbnZlcnNlUGF0Y2hlc18gPSBbXTsKICAgIHNjb3BlLnBhdGNoTGlzdGVuZXJfID0gcGF0Y2hMaXN0ZW5lcjsKICB9Cn0KZnVuY3Rpb24gcmV2b2tlU2NvcGUyKHNjb3BlKSB7CiAgbGVhdmVTY29wZTIoc2NvcGUpOwogIHNjb3BlLmRyYWZ0c18uZm9yRWFjaChyZXZva2VEcmFmdDIpOwogIHNjb3BlLmRyYWZ0c18gPSBudWxsOwp9CmZ1bmN0aW9uIGxlYXZlU2NvcGUyKHNjb3BlKSB7CiAgaWYgKHNjb3BlID09PSBjdXJyZW50U2NvcGUyKSB7CiAgICBjdXJyZW50U2NvcGUyID0gc2NvcGUucGFyZW50XzsKICB9Cn0KZnVuY3Rpb24gZW50ZXJTY29wZTIoaW1tZXIyMikgewogIHJldHVybiBjdXJyZW50U2NvcGUyID0gY3JlYXRlU2NvcGUyKGN1cnJlbnRTY29wZTIsIGltbWVyMjIpOwp9CmZ1bmN0aW9uIHJldm9rZURyYWZ0MihkcmFmdCkgewogIGNvbnN0IHN0YXRlID0gZHJhZnRbRFJBRlRfU1RBVEUyXTsKICBpZiAoc3RhdGUudHlwZV8gPT09IDAgfHwgc3RhdGUudHlwZV8gPT09IDEpCiAgICBzdGF0ZS5yZXZva2VfKCk7CiAgZWxzZQogICAgc3RhdGUucmV2b2tlZF8gPSB0cnVlOwp9CmZ1bmN0aW9uIHByb2Nlc3NSZXN1bHQyKHJlc3VsdCwgc2NvcGUpIHsKICBzY29wZS51bmZpbmFsaXplZERyYWZ0c18gPSBzY29wZS5kcmFmdHNfLmxlbmd0aDsKICBjb25zdCBiYXNlRHJhZnQgPSBzY29wZS5kcmFmdHNfWzBdOwogIGNvbnN0IGlzUmVwbGFjZWQgPSByZXN1bHQgIT09IHZvaWQgMCAmJiByZXN1bHQgIT09IGJhc2VEcmFmdDsKICBpZiAoaXNSZXBsYWNlZCkgewogICAgaWYgKGJhc2VEcmFmdFtEUkFGVF9TVEFURTJdLm1vZGlmaWVkXykgewogICAgICByZXZva2VTY29wZTIoc2NvcGUpOwogICAgICBkaWUyKDQpOwogICAgfQogICAgaWYgKGlzRHJhZnRhYmxlMihyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IGZpbmFsaXplMihzY29wZSwgcmVzdWx0KTsKICAgICAgaWYgKCFzY29wZS5wYXJlbnRfKQogICAgICAgIG1heWJlRnJlZXplMihzY29wZSwgcmVzdWx0KTsKICAgIH0KICAgIGlmIChzY29wZS5wYXRjaGVzXykgewogICAgICBnZXRQbHVnaW4yKCJQYXRjaGVzIikuZ2VuZXJhdGVSZXBsYWNlbWVudFBhdGNoZXNfKAogICAgICAgIGJhc2VEcmFmdFtEUkFGVF9TVEFURTJdLmJhc2VfLAogICAgICAgIHJlc3VsdCwKICAgICAgICBzY29wZS5wYXRjaGVzXywKICAgICAgICBzY29wZS5pbnZlcnNlUGF0Y2hlc18KICAgICAgKTsKICAgIH0KICB9IGVsc2UgewogICAgcmVzdWx0ID0gZmluYWxpemUyKHNjb3BlLCBiYXNlRHJhZnQsIFtdKTsKICB9CiAgcmV2b2tlU2NvcGUyKHNjb3BlKTsKICBpZiAoc2NvcGUucGF0Y2hlc18pIHsKICAgIHNjb3BlLnBhdGNoTGlzdGVuZXJfKHNjb3BlLnBhdGNoZXNfLCBzY29wZS5pbnZlcnNlUGF0Y2hlc18pOwogIH0KICByZXR1cm4gcmVzdWx0ICE9PSBOT1RISU5HMiA/IHJlc3VsdCA6IHZvaWQgMDsKfQpmdW5jdGlvbiBmaW5hbGl6ZTIocm9vdFNjb3BlLCB2YWx1ZSwgcGF0aDIpIHsKICBpZiAoaXNGcm96ZW4yKHZhbHVlKSkKICAgIHJldHVybiB2YWx1ZTsKICBjb25zdCB1c2VTdHJpY3RJdGVyYXRpb24gPSByb290U2NvcGUuaW1tZXJfLnNob3VsZFVzZVN0cmljdEl0ZXJhdGlvbigpOwogIGNvbnN0IHN0YXRlID0gdmFsdWVbRFJBRlRfU1RBVEUyXTsKICBpZiAoIXN0YXRlKSB7CiAgICBlYWNoMigKICAgICAgdmFsdWUsCiAgICAgIChrZXksIGNoaWxkVmFsdWUpID0+IGZpbmFsaXplUHJvcGVydHkocm9vdFNjb3BlLCBzdGF0ZSwgdmFsdWUsIGtleSwgY2hpbGRWYWx1ZSwgcGF0aDIpLAogICAgICB1c2VTdHJpY3RJdGVyYXRpb24KICAgICk7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGlmIChzdGF0ZS5zY29wZV8gIT09IHJvb3RTY29wZSkKICAgIHJldHVybiB2YWx1ZTsKICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgbWF5YmVGcmVlemUyKHJvb3RTY29wZSwgc3RhdGUuYmFzZV8sIHRydWUpOwogICAgcmV0dXJuIHN0YXRlLmJhc2VfOwogIH0KICBpZiAoIXN0YXRlLmZpbmFsaXplZF8pIHsKICAgIHN0YXRlLmZpbmFsaXplZF8gPSB0cnVlOwogICAgc3RhdGUuc2NvcGVfLnVuZmluYWxpemVkRHJhZnRzXy0tOwogICAgY29uc3QgcmVzdWx0ID0gc3RhdGUuY29weV87CiAgICBsZXQgcmVzdWx0RWFjaCA9IHJlc3VsdDsKICAgIGxldCBpc1NldDIyID0gZmFsc2U7CiAgICBpZiAoc3RhdGUudHlwZV8gPT09IDMpIHsKICAgICAgcmVzdWx0RWFjaCA9IG5ldyBTZXQocmVzdWx0KTsKICAgICAgcmVzdWx0LmNsZWFyKCk7CiAgICAgIGlzU2V0MjIgPSB0cnVlOwogICAgfQogICAgZWFjaDIoCiAgICAgIHJlc3VsdEVhY2gsCiAgICAgIChrZXksIGNoaWxkVmFsdWUpID0+IGZpbmFsaXplUHJvcGVydHkoCiAgICAgICAgcm9vdFNjb3BlLAogICAgICAgIHN0YXRlLAogICAgICAgIHJlc3VsdCwKICAgICAgICBrZXksCiAgICAgICAgY2hpbGRWYWx1ZSwKICAgICAgICBwYXRoMiwKICAgICAgICBpc1NldDIyCiAgICAgICksCiAgICAgIHVzZVN0cmljdEl0ZXJhdGlvbgogICAgKTsKICAgIG1heWJlRnJlZXplMihyb290U2NvcGUsIHJlc3VsdCwgZmFsc2UpOwogICAgaWYgKHBhdGgyICYmIHJvb3RTY29wZS5wYXRjaGVzXykgewogICAgICBnZXRQbHVnaW4yKCJQYXRjaGVzIikuZ2VuZXJhdGVQYXRjaGVzXygKICAgICAgICBzdGF0ZSwKICAgICAgICBwYXRoMiwKICAgICAgICByb290U2NvcGUucGF0Y2hlc18sCiAgICAgICAgcm9vdFNjb3BlLmludmVyc2VQYXRjaGVzXwogICAgICApOwogICAgfQogIH0KICByZXR1cm4gc3RhdGUuY29weV87Cn0KZnVuY3Rpb24gZmluYWxpemVQcm9wZXJ0eShyb290U2NvcGUsIHBhcmVudFN0YXRlLCB0YXJnZXRPYmplY3QsIHByb3AsIGNoaWxkVmFsdWUsIHJvb3RQYXRoLCB0YXJnZXRJc1NldCkgewogIGlmIChjaGlsZFZhbHVlID09IG51bGwpIHsKICAgIHJldHVybjsKICB9CiAgaWYgKHR5cGVvZiBjaGlsZFZhbHVlICE9PSAib2JqZWN0IiAmJiAhdGFyZ2V0SXNTZXQpIHsKICAgIHJldHVybjsKICB9CiAgY29uc3QgY2hpbGRJc0Zyb3plbiA9IGlzRnJvemVuMihjaGlsZFZhbHVlKTsKICBpZiAoY2hpbGRJc0Zyb3plbiAmJiAhdGFyZ2V0SXNTZXQpIHsKICAgIHJldHVybjsKICB9CiAgaWYgKGNoaWxkVmFsdWUgPT09IHRhcmdldE9iamVjdCkKICAgIGRpZTIoNSk7CiAgaWYgKGlzRHJhZnQyKGNoaWxkVmFsdWUpKSB7CiAgICBjb25zdCBwYXRoMiA9IHJvb3RQYXRoICYmIHBhcmVudFN0YXRlICYmIHBhcmVudFN0YXRlLnR5cGVfICE9PSAzICYmIC8vIFNldCBvYmplY3RzIGFyZSBhdG9taWMgc2luY2UgdGhleSBoYXZlIG5vIGtleXMuCiAgICAhaGFzMihwYXJlbnRTdGF0ZS5hc3NpZ25lZF8sIHByb3ApID8gcm9vdFBhdGguY29uY2F0KHByb3ApIDogdm9pZCAwOwogICAgY29uc3QgcmVzID0gZmluYWxpemUyKHJvb3RTY29wZSwgY2hpbGRWYWx1ZSwgcGF0aDIpOwogICAgc2V0Mih0YXJnZXRPYmplY3QsIHByb3AsIHJlcyk7CiAgICBpZiAoaXNEcmFmdDIocmVzKSkgewogICAgICByb290U2NvcGUuY2FuQXV0b0ZyZWV6ZV8gPSBmYWxzZTsKICAgIH0gZWxzZQogICAgICByZXR1cm47CiAgfSBlbHNlIGlmICh0YXJnZXRJc1NldCkgewogICAgdGFyZ2V0T2JqZWN0LmFkZChjaGlsZFZhbHVlKTsKICB9CiAgaWYgKGlzRHJhZnRhYmxlMihjaGlsZFZhbHVlKSAmJiAhY2hpbGRJc0Zyb3plbikgewogICAgaWYgKCFyb290U2NvcGUuaW1tZXJfLmF1dG9GcmVlemVfICYmIHJvb3RTY29wZS51bmZpbmFsaXplZERyYWZ0c18gPCAxKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChwYXJlbnRTdGF0ZSAmJiBwYXJlbnRTdGF0ZS5iYXNlXyAmJiBwYXJlbnRTdGF0ZS5iYXNlX1twcm9wXSA9PT0gY2hpbGRWYWx1ZSAmJiBjaGlsZElzRnJvemVuKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGZpbmFsaXplMihyb290U2NvcGUsIGNoaWxkVmFsdWUpOwogICAgaWYgKCghcGFyZW50U3RhdGUgfHwgIXBhcmVudFN0YXRlLnNjb3BlXy5wYXJlbnRfKSAmJiB0eXBlb2YgcHJvcCAhPT0gInN5bWJvbCIgJiYgKGlzTWFwMih0YXJnZXRPYmplY3QpID8gdGFyZ2V0T2JqZWN0Lmhhcyhwcm9wKSA6IE9iamVjdC5wcm90b3R5cGUucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbCh0YXJnZXRPYmplY3QsIHByb3ApKSkKICAgICAgbWF5YmVGcmVlemUyKHJvb3RTY29wZSwgY2hpbGRWYWx1ZSk7CiAgfQp9CmZ1bmN0aW9uIG1heWJlRnJlZXplMihzY29wZSwgdmFsdWUsIGRlZXAgPSBmYWxzZSkgewogIGlmICghc2NvcGUucGFyZW50XyAmJiBzY29wZS5pbW1lcl8uYXV0b0ZyZWV6ZV8gJiYgc2NvcGUuY2FuQXV0b0ZyZWV6ZV8pIHsKICAgIGZyZWV6ZTIodmFsdWUsIGRlZXApOwogIH0KfQpmdW5jdGlvbiBjcmVhdGVQcm94eVByb3h5MihiYXNlLCBwYXJlbnQpIHsKICBjb25zdCBpc0FycmF5MiA9IEFycmF5LmlzQXJyYXkoYmFzZSk7CiAgY29uc3Qgc3RhdGUgPSB7CiAgICB0eXBlXzogaXNBcnJheTIgPyAxIDogMCwKICAgIC8vIFRyYWNrIHdoaWNoIHByb2R1Y2UgY2FsbCB0aGlzIGlzIGFzc29jaWF0ZWQgd2l0aC4KICAgIHNjb3BlXzogcGFyZW50ID8gcGFyZW50LnNjb3BlXyA6IGdldEN1cnJlbnRTY29wZTIoKSwKICAgIC8vIFRydWUgZm9yIGJvdGggc2hhbGxvdyBhbmQgZGVlcCBjaGFuZ2VzLgogICAgbW9kaWZpZWRfOiBmYWxzZSwKICAgIC8vIFVzZWQgZHVyaW5nIGZpbmFsaXphdGlvbi4KICAgIGZpbmFsaXplZF86IGZhbHNlLAogICAgLy8gVHJhY2sgd2hpY2ggcHJvcGVydGllcyBoYXZlIGJlZW4gYXNzaWduZWQgKHRydWUpIG9yIGRlbGV0ZWQgKGZhbHNlKS4KICAgIGFzc2lnbmVkXzoge30sCiAgICAvLyBUaGUgcGFyZW50IGRyYWZ0IHN0YXRlLgogICAgcGFyZW50XzogcGFyZW50LAogICAgLy8gVGhlIGJhc2Ugc3RhdGUuCiAgICBiYXNlXzogYmFzZSwKICAgIC8vIFRoZSBiYXNlIHByb3h5LgogICAgZHJhZnRfOiBudWxsLAogICAgLy8gc2V0IGJlbG93CiAgICAvLyBUaGUgYmFzZSBjb3B5IHdpdGggYW55IHVwZGF0ZWQgdmFsdWVzLgogICAgY29weV86IG51bGwsCiAgICAvLyBDYWxsZWQgYnkgdGhlIGBwcm9kdWNlYCBmdW5jdGlvbi4KICAgIHJldm9rZV86IG51bGwsCiAgICBpc01hbnVhbF86IGZhbHNlCiAgfTsKICBsZXQgdGFyZ2V0ID0gc3RhdGU7CiAgbGV0IHRyYXBzID0gb2JqZWN0VHJhcHMyOwogIGlmIChpc0FycmF5MikgewogICAgdGFyZ2V0ID0gW3N0YXRlXTsKICAgIHRyYXBzID0gYXJyYXlUcmFwczI7CiAgfQogIGNvbnN0IHsgcmV2b2tlLCBwcm94eSB9ID0gUHJveHkucmV2b2NhYmxlKHRhcmdldCwgdHJhcHMpOwogIHN0YXRlLmRyYWZ0XyA9IHByb3h5OwogIHN0YXRlLnJldm9rZV8gPSByZXZva2U7CiAgcmV0dXJuIHByb3h5Owp9CnZhciBvYmplY3RUcmFwczIgPSB7CiAgZ2V0KHN0YXRlLCBwcm9wKSB7CiAgICBpZiAocHJvcCA9PT0gRFJBRlRfU1RBVEUyKQogICAgICByZXR1cm4gc3RhdGU7CiAgICBjb25zdCBzb3VyY2UgPSBsYXRlc3QyKHN0YXRlKTsKICAgIGlmICghaGFzMihzb3VyY2UsIHByb3ApKSB7CiAgICAgIHJldHVybiByZWFkUHJvcEZyb21Qcm90bzIoc3RhdGUsIHNvdXJjZSwgcHJvcCk7CiAgICB9CiAgICBjb25zdCB2YWx1ZSA9IHNvdXJjZVtwcm9wXTsKICAgIGlmIChzdGF0ZS5maW5hbGl6ZWRfIHx8ICFpc0RyYWZ0YWJsZTIodmFsdWUpKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIGlmICh2YWx1ZSA9PT0gcGVlazIoc3RhdGUuYmFzZV8sIHByb3ApKSB7CiAgICAgIHByZXBhcmVDb3B5MihzdGF0ZSk7CiAgICAgIHJldHVybiBzdGF0ZS5jb3B5X1twcm9wXSA9IGNyZWF0ZVByb3h5Mih2YWx1ZSwgc3RhdGUpOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0sCiAgaGFzKHN0YXRlLCBwcm9wKSB7CiAgICByZXR1cm4gcHJvcCBpbiBsYXRlc3QyKHN0YXRlKTsKICB9LAogIG93bktleXMoc3RhdGUpIHsKICAgIHJldHVybiBSZWZsZWN0Lm93bktleXMobGF0ZXN0MihzdGF0ZSkpOwogIH0sCiAgc2V0KHN0YXRlLCBwcm9wLCB2YWx1ZSkgewogICAgY29uc3QgZGVzYyA9IGdldERlc2NyaXB0b3JGcm9tUHJvdG8yKGxhdGVzdDIoc3RhdGUpLCBwcm9wKTsKICAgIGlmIChkZXNjPy5zZXQpIHsKICAgICAgZGVzYy5zZXQuY2FsbChzdGF0ZS5kcmFmdF8sIHZhbHVlKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgICBjb25zdCBjdXJyZW50MjIgPSBwZWVrMihsYXRlc3QyKHN0YXRlKSwgcHJvcCk7CiAgICAgIGNvbnN0IGN1cnJlbnRTdGF0ZSA9IGN1cnJlbnQyMj8uW0RSQUZUX1NUQVRFMl07CiAgICAgIGlmIChjdXJyZW50U3RhdGUgJiYgY3VycmVudFN0YXRlLmJhc2VfID09PSB2YWx1ZSkgewogICAgICAgIHN0YXRlLmNvcHlfW3Byb3BdID0gdmFsdWU7CiAgICAgICAgc3RhdGUuYXNzaWduZWRfW3Byb3BdID0gZmFsc2U7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKGlzMih2YWx1ZSwgY3VycmVudDIyKSAmJiAodmFsdWUgIT09IHZvaWQgMCB8fCBoYXMyKHN0YXRlLmJhc2VfLCBwcm9wKSkpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIHByZXBhcmVDb3B5MihzdGF0ZSk7CiAgICAgIG1hcmtDaGFuZ2VkMihzdGF0ZSk7CiAgICB9CiAgICBpZiAoc3RhdGUuY29weV9bcHJvcF0gPT09IHZhbHVlICYmIC8vIHNwZWNpYWwgY2FzZTogaGFuZGxlIG5ldyBwcm9wcyB3aXRoIHZhbHVlICd1bmRlZmluZWQnCiAgICAodmFsdWUgIT09IHZvaWQgMCB8fCBwcm9wIGluIHN0YXRlLmNvcHlfKSB8fCAvLyBzcGVjaWFsIGNhc2U6IE5hTgogICAgTnVtYmVyLmlzTmFOKHZhbHVlKSAmJiBOdW1iZXIuaXNOYU4oc3RhdGUuY29weV9bcHJvcF0pKQogICAgICByZXR1cm4gdHJ1ZTsKICAgIHN0YXRlLmNvcHlfW3Byb3BdID0gdmFsdWU7CiAgICBzdGF0ZS5hc3NpZ25lZF9bcHJvcF0gPSB0cnVlOwogICAgcmV0dXJuIHRydWU7CiAgfSwKICBkZWxldGVQcm9wZXJ0eShzdGF0ZSwgcHJvcCkgewogICAgaWYgKHBlZWsyKHN0YXRlLmJhc2VfLCBwcm9wKSAhPT0gdm9pZCAwIHx8IHByb3AgaW4gc3RhdGUuYmFzZV8pIHsKICAgICAgc3RhdGUuYXNzaWduZWRfW3Byb3BdID0gZmFsc2U7CiAgICAgIHByZXBhcmVDb3B5MihzdGF0ZSk7CiAgICAgIG1hcmtDaGFuZ2VkMihzdGF0ZSk7CiAgICB9IGVsc2UgewogICAgICBkZWxldGUgc3RhdGUuYXNzaWduZWRfW3Byb3BdOwogICAgfQogICAgaWYgKHN0YXRlLmNvcHlfKSB7CiAgICAgIGRlbGV0ZSBzdGF0ZS5jb3B5X1twcm9wXTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0sCiAgLy8gTm90ZTogV2UgbmV2ZXIgY29lcmNlIGBkZXNjLnZhbHVlYCBpbnRvIGFuIEltbWVyIGRyYWZ0LCBiZWNhdXNlIHdlIGNhbid0IG1ha2UKICAvLyB0aGUgc2FtZSBndWFyYW50ZWUgaW4gRVM1IG1vZGUuCiAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHN0YXRlLCBwcm9wKSB7CiAgICBjb25zdCBvd25lciA9IGxhdGVzdDIoc3RhdGUpOwogICAgY29uc3QgZGVzYyA9IFJlZmxlY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG93bmVyLCBwcm9wKTsKICAgIGlmICghZGVzYykKICAgICAgcmV0dXJuIGRlc2M7CiAgICByZXR1cm4gewogICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgY29uZmlndXJhYmxlOiBzdGF0ZS50eXBlXyAhPT0gMSB8fCBwcm9wICE9PSAibGVuZ3RoIiwKICAgICAgZW51bWVyYWJsZTogZGVzYy5lbnVtZXJhYmxlLAogICAgICB2YWx1ZTogb3duZXJbcHJvcF0KICAgIH07CiAgfSwKICBkZWZpbmVQcm9wZXJ0eSgpIHsKICAgIGRpZTIoMTEpOwogIH0sCiAgZ2V0UHJvdG90eXBlT2Yoc3RhdGUpIHsKICAgIHJldHVybiBnZXRQcm90b3R5cGVPZjIoc3RhdGUuYmFzZV8pOwogIH0sCiAgc2V0UHJvdG90eXBlT2YoKSB7CiAgICBkaWUyKDEyKTsKICB9Cn07CnZhciBhcnJheVRyYXBzMiA9IHt9OwplYWNoMihvYmplY3RUcmFwczIsIChrZXksIGZuKSA9PiB7CiAgYXJyYXlUcmFwczJba2V5XSA9IGZ1bmN0aW9uKCkgewogICAgYXJndW1lbnRzWzBdID0gYXJndW1lbnRzWzBdWzBdOwogICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKfSk7CmFycmF5VHJhcHMyLmRlbGV0ZVByb3BlcnR5ID0gZnVuY3Rpb24oc3RhdGUsIHByb3ApIHsKICBpZiAoaXNOYU4ocGFyc2VJbnQocHJvcCkpKQogICAgZGllMigxMyk7CiAgcmV0dXJuIGFycmF5VHJhcHMyLnNldC5jYWxsKHRoaXMsIHN0YXRlLCBwcm9wLCB2b2lkIDApOwp9OwphcnJheVRyYXBzMi5zZXQgPSBmdW5jdGlvbihzdGF0ZSwgcHJvcCwgdmFsdWUpIHsKICBpZiAocHJvcCAhPT0gImxlbmd0aCIgJiYgaXNOYU4ocGFyc2VJbnQocHJvcCkpKQogICAgZGllMigxNCk7CiAgcmV0dXJuIG9iamVjdFRyYXBzMi5zZXQuY2FsbCh0aGlzLCBzdGF0ZVswXSwgcHJvcCwgdmFsdWUsIHN0YXRlWzBdKTsKfTsKZnVuY3Rpb24gcGVlazIoZHJhZnQsIHByb3ApIHsKICBjb25zdCBzdGF0ZSA9IGRyYWZ0W0RSQUZUX1NUQVRFMl07CiAgY29uc3Qgc291cmNlID0gc3RhdGUgPyBsYXRlc3QyKHN0YXRlKSA6IGRyYWZ0OwogIHJldHVybiBzb3VyY2VbcHJvcF07Cn0KZnVuY3Rpb24gcmVhZFByb3BGcm9tUHJvdG8yKHN0YXRlLCBzb3VyY2UsIHByb3ApIHsKICBjb25zdCBkZXNjID0gZ2V0RGVzY3JpcHRvckZyb21Qcm90bzIoc291cmNlLCBwcm9wKTsKICByZXR1cm4gZGVzYyA/IGB2YWx1ZWAgaW4gZGVzYyA/IGRlc2MudmFsdWUgOiAoCiAgICAvLyBUaGlzIGlzIGEgdmVyeSBzcGVjaWFsIGNhc2UsIGlmIHRoZSBwcm9wIGlzIGEgZ2V0dGVyIGRlZmluZWQgYnkgdGhlCiAgICAvLyBwcm90b3R5cGUsIHdlIHNob3VsZCBpbnZva2UgaXQgd2l0aCB0aGUgZHJhZnQgYXMgY29udGV4dCEKICAgIGRlc2MuZ2V0Py5jYWxsKHN0YXRlLmRyYWZ0XykKICApIDogdm9pZCAwOwp9CmZ1bmN0aW9uIGdldERlc2NyaXB0b3JGcm9tUHJvdG8yKHNvdXJjZSwgcHJvcCkgewogIGlmICghKHByb3AgaW4gc291cmNlKSkKICAgIHJldHVybiB2b2lkIDA7CiAgbGV0IHByb3RvMiA9IGdldFByb3RvdHlwZU9mMihzb3VyY2UpOwogIHdoaWxlIChwcm90bzIpIHsKICAgIGNvbnN0IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHByb3RvMiwgcHJvcCk7CiAgICBpZiAoZGVzYykKICAgICAgcmV0dXJuIGRlc2M7CiAgICBwcm90bzIgPSBnZXRQcm90b3R5cGVPZjIocHJvdG8yKTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQpmdW5jdGlvbiBtYXJrQ2hhbmdlZDIoc3RhdGUpIHsKICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgc3RhdGUubW9kaWZpZWRfID0gdHJ1ZTsKICAgIGlmIChzdGF0ZS5wYXJlbnRfKSB7CiAgICAgIG1hcmtDaGFuZ2VkMihzdGF0ZS5wYXJlbnRfKTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gcHJlcGFyZUNvcHkyKHN0YXRlKSB7CiAgaWYgKCFzdGF0ZS5jb3B5XykgewogICAgc3RhdGUuY29weV8gPSBzaGFsbG93Q29weTIoCiAgICAgIHN0YXRlLmJhc2VfLAogICAgICBzdGF0ZS5zY29wZV8uaW1tZXJfLnVzZVN0cmljdFNoYWxsb3dDb3B5XwogICAgKTsKICB9Cn0KdmFyIEltbWVyMjIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY29uZmlnKSB7CiAgICB0aGlzLmF1dG9GcmVlemVfID0gdHJ1ZTsKICAgIHRoaXMudXNlU3RyaWN0U2hhbGxvd0NvcHlfID0gZmFsc2U7CiAgICB0aGlzLnVzZVN0cmljdEl0ZXJhdGlvbl8gPSB0cnVlOwogICAgdGhpcy5wcm9kdWNlID0gKGJhc2UsIHJlY2lwZSwgcGF0Y2hMaXN0ZW5lcikgPT4gewogICAgICBpZiAodHlwZW9mIGJhc2UgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIHJlY2lwZSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIGNvbnN0IGRlZmF1bHRCYXNlID0gcmVjaXBlOwogICAgICAgIHJlY2lwZSA9IGJhc2U7CiAgICAgICAgY29uc3Qgc2VsZjIgPSB0aGlzOwogICAgICAgIHJldHVybiBmdW5jdGlvbiBjdXJyaWVkUHJvZHVjZShiYXNlMiA9IGRlZmF1bHRCYXNlLCAuLi5hcmdzKSB7CiAgICAgICAgICByZXR1cm4gc2VsZjIucHJvZHVjZShiYXNlMiwgKGRyYWZ0KSA9PiByZWNpcGUuY2FsbCh0aGlzLCBkcmFmdCwgLi4uYXJncykpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiByZWNpcGUgIT09ICJmdW5jdGlvbiIpCiAgICAgICAgZGllMig2KTsKICAgICAgaWYgKHBhdGNoTGlzdGVuZXIgIT09IHZvaWQgMCAmJiB0eXBlb2YgcGF0Y2hMaXN0ZW5lciAhPT0gImZ1bmN0aW9uIikKICAgICAgICBkaWUyKDcpOwogICAgICBsZXQgcmVzdWx0OwogICAgICBpZiAoaXNEcmFmdGFibGUyKGJhc2UpKSB7CiAgICAgICAgY29uc3Qgc2NvcGUgPSBlbnRlclNjb3BlMih0aGlzKTsKICAgICAgICBjb25zdCBwcm94eSA9IGNyZWF0ZVByb3h5MihiYXNlLCB2b2lkIDApOwogICAgICAgIGxldCBoYXNFcnJvciA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJlc3VsdCA9IHJlY2lwZShwcm94eSk7CiAgICAgICAgICBoYXNFcnJvciA9IGZhbHNlOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAoaGFzRXJyb3IpCiAgICAgICAgICAgIHJldm9rZVNjb3BlMihzY29wZSk7CiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIGxlYXZlU2NvcGUyKHNjb3BlKTsKICAgICAgICB9CiAgICAgICAgdXNlUGF0Y2hlc0luU2NvcGUyKHNjb3BlLCBwYXRjaExpc3RlbmVyKTsKICAgICAgICByZXR1cm4gcHJvY2Vzc1Jlc3VsdDIocmVzdWx0LCBzY29wZSk7CiAgICAgIH0gZWxzZSBpZiAoIWJhc2UgfHwgdHlwZW9mIGJhc2UgIT09ICJvYmplY3QiKSB7CiAgICAgICAgcmVzdWx0ID0gcmVjaXBlKGJhc2UpOwogICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkKICAgICAgICAgIHJlc3VsdCA9IGJhc2U7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gTk9USElORzIpCiAgICAgICAgICByZXN1bHQgPSB2b2lkIDA7CiAgICAgICAgaWYgKHRoaXMuYXV0b0ZyZWV6ZV8pCiAgICAgICAgICBmcmVlemUyKHJlc3VsdCwgdHJ1ZSk7CiAgICAgICAgaWYgKHBhdGNoTGlzdGVuZXIpIHsKICAgICAgICAgIGNvbnN0IHAgPSBbXTsKICAgICAgICAgIGNvbnN0IGlwID0gW107CiAgICAgICAgICBnZXRQbHVnaW4yKCJQYXRjaGVzIikuZ2VuZXJhdGVSZXBsYWNlbWVudFBhdGNoZXNfKGJhc2UsIHJlc3VsdCwgcCwgaXApOwogICAgICAgICAgcGF0Y2hMaXN0ZW5lcihwLCBpcCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0gZWxzZQogICAgICAgIGRpZTIoMSwgYmFzZSk7CiAgICB9OwogICAgdGhpcy5wcm9kdWNlV2l0aFBhdGNoZXMgPSAoYmFzZSwgcmVjaXBlKSA9PiB7CiAgICAgIGlmICh0eXBlb2YgYmFzZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHJldHVybiAoc3RhdGUsIC4uLmFyZ3MpID0+IHRoaXMucHJvZHVjZVdpdGhQYXRjaGVzKHN0YXRlLCAoZHJhZnQpID0+IGJhc2UoZHJhZnQsIC4uLmFyZ3MpKTsKICAgICAgfQogICAgICBsZXQgcGF0Y2hlcywgaW52ZXJzZVBhdGNoZXM7CiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMucHJvZHVjZShiYXNlLCByZWNpcGUsIChwLCBpcCkgPT4gewogICAgICAgIHBhdGNoZXMgPSBwOwogICAgICAgIGludmVyc2VQYXRjaGVzID0gaXA7CiAgICAgIH0pOwogICAgICByZXR1cm4gW3Jlc3VsdCwgcGF0Y2hlcywgaW52ZXJzZVBhdGNoZXNdOwogICAgfTsKICAgIGlmICh0eXBlb2YgY29uZmlnPy5hdXRvRnJlZXplID09PSAiYm9vbGVhbiIpCiAgICAgIHRoaXMuc2V0QXV0b0ZyZWV6ZShjb25maWcuYXV0b0ZyZWV6ZSk7CiAgICBpZiAodHlwZW9mIGNvbmZpZz8udXNlU3RyaWN0U2hhbGxvd0NvcHkgPT09ICJib29sZWFuIikKICAgICAgdGhpcy5zZXRVc2VTdHJpY3RTaGFsbG93Q29weShjb25maWcudXNlU3RyaWN0U2hhbGxvd0NvcHkpOwogICAgaWYgKHR5cGVvZiBjb25maWc/LnVzZVN0cmljdEl0ZXJhdGlvbiA9PT0gImJvb2xlYW4iKQogICAgICB0aGlzLnNldFVzZVN0cmljdEl0ZXJhdGlvbihjb25maWcudXNlU3RyaWN0SXRlcmF0aW9uKTsKICB9CiAgY3JlYXRlRHJhZnQoYmFzZSkgewogICAgaWYgKCFpc0RyYWZ0YWJsZTIoYmFzZSkpCiAgICAgIGRpZTIoOCk7CiAgICBpZiAoaXNEcmFmdDIoYmFzZSkpCiAgICAgIGJhc2UgPSBjdXJyZW50MihiYXNlKTsKICAgIGNvbnN0IHNjb3BlID0gZW50ZXJTY29wZTIodGhpcyk7CiAgICBjb25zdCBwcm94eSA9IGNyZWF0ZVByb3h5MihiYXNlLCB2b2lkIDApOwogICAgcHJveHlbRFJBRlRfU1RBVEUyXS5pc01hbnVhbF8gPSB0cnVlOwogICAgbGVhdmVTY29wZTIoc2NvcGUpOwogICAgcmV0dXJuIHByb3h5OwogIH0KICBmaW5pc2hEcmFmdChkcmFmdCwgcGF0Y2hMaXN0ZW5lcikgewogICAgY29uc3Qgc3RhdGUgPSBkcmFmdCAmJiBkcmFmdFtEUkFGVF9TVEFURTJdOwogICAgaWYgKCFzdGF0ZSB8fCAhc3RhdGUuaXNNYW51YWxfKQogICAgICBkaWUyKDkpOwogICAgY29uc3QgeyBzY29wZV86IHNjb3BlIH0gPSBzdGF0ZTsKICAgIHVzZVBhdGNoZXNJblNjb3BlMihzY29wZSwgcGF0Y2hMaXN0ZW5lcik7CiAgICByZXR1cm4gcHJvY2Vzc1Jlc3VsdDIodm9pZCAwLCBzY29wZSk7CiAgfQogIC8qKgogICAqIFBhc3MgdHJ1ZSB0byBhdXRvbWF0aWNhbGx5IGZyZWV6ZSBhbGwgY29waWVzIGNyZWF0ZWQgYnkgSW1tZXIuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBhdXRvLWZyZWV6aW5nIGlzIGVuYWJsZWQuCiAgICovCiAgc2V0QXV0b0ZyZWV6ZSh2YWx1ZSkgewogICAgdGhpcy5hdXRvRnJlZXplXyA9IHZhbHVlOwogIH0KICAvKioKICAgKiBQYXNzIHRydWUgdG8gZW5hYmxlIHN0cmljdCBzaGFsbG93IGNvcHkuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBpbW1lciBkb2VzIG5vdCBjb3B5IHRoZSBvYmplY3QgZGVzY3JpcHRvcnMgc3VjaCBhcyBnZXR0ZXIsIHNldHRlciBhbmQgbm9uLWVudW1yYWJsZSBwcm9wZXJ0aWVzLgogICAqLwogIHNldFVzZVN0cmljdFNoYWxsb3dDb3B5KHZhbHVlKSB7CiAgICB0aGlzLnVzZVN0cmljdFNoYWxsb3dDb3B5XyA9IHZhbHVlOwogIH0KICAvKioKICAgKiBQYXNzIGZhbHNlIHRvIHVzZSBmYXN0ZXIgaXRlcmF0aW9uIHRoYXQgc2tpcHMgbm9uLWVudW1lcmFibGUgcHJvcGVydGllcwogICAqIGJ1dCBzdGlsbCBoYW5kbGVzIHN5bWJvbHMgZm9yIGNvbXBhdGliaWxpdHkuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBzdHJpY3QgaXRlcmF0aW9uIGlzIGVuYWJsZWQgKGluY2x1ZGVzIGFsbCBvd24gcHJvcGVydGllcykuCiAgICovCiAgc2V0VXNlU3RyaWN0SXRlcmF0aW9uKHZhbHVlKSB7CiAgICB0aGlzLnVzZVN0cmljdEl0ZXJhdGlvbl8gPSB2YWx1ZTsKICB9CiAgc2hvdWxkVXNlU3RyaWN0SXRlcmF0aW9uKCkgewogICAgcmV0dXJuIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXzsKICB9CiAgYXBwbHlQYXRjaGVzKGJhc2UsIHBhdGNoZXMpIHsKICAgIGxldCBpOwogICAgZm9yIChpID0gcGF0Y2hlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBwYXRjaCA9IHBhdGNoZXNbaV07CiAgICAgIGlmIChwYXRjaC5wYXRoLmxlbmd0aCA9PT0gMCAmJiBwYXRjaC5vcCA9PT0gInJlcGxhY2UiKSB7CiAgICAgICAgYmFzZSA9IHBhdGNoLnZhbHVlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBpZiAoaSA+IC0xKSB7CiAgICAgIHBhdGNoZXMgPSBwYXRjaGVzLnNsaWNlKGkgKyAxKTsKICAgIH0KICAgIGNvbnN0IGFwcGx5UGF0Y2hlc0ltcGwgPSBnZXRQbHVnaW4yKCJQYXRjaGVzIikuYXBwbHlQYXRjaGVzXzsKICAgIGlmIChpc0RyYWZ0MihiYXNlKSkgewogICAgICByZXR1cm4gYXBwbHlQYXRjaGVzSW1wbChiYXNlLCBwYXRjaGVzKTsKICAgIH0KICAgIHJldHVybiB0aGlzLnByb2R1Y2UoCiAgICAgIGJhc2UsCiAgICAgIChkcmFmdCkgPT4gYXBwbHlQYXRjaGVzSW1wbChkcmFmdCwgcGF0Y2hlcykKICAgICk7CiAgfQp9OwpmdW5jdGlvbiBjcmVhdGVQcm94eTIodmFsdWUsIHBhcmVudCkgewogIGNvbnN0IGRyYWZ0ID0gaXNNYXAyKHZhbHVlKSA/IGdldFBsdWdpbjIoIk1hcFNldCIpLnByb3h5TWFwXyh2YWx1ZSwgcGFyZW50KSA6IGlzU2V0Mih2YWx1ZSkgPyBnZXRQbHVnaW4yKCJNYXBTZXQiKS5wcm94eVNldF8odmFsdWUsIHBhcmVudCkgOiBjcmVhdGVQcm94eVByb3h5Mih2YWx1ZSwgcGFyZW50KTsKICBjb25zdCBzY29wZSA9IHBhcmVudCA/IHBhcmVudC5zY29wZV8gOiBnZXRDdXJyZW50U2NvcGUyKCk7CiAgc2NvcGUuZHJhZnRzXy5wdXNoKGRyYWZ0KTsKICByZXR1cm4gZHJhZnQ7Cn0KZnVuY3Rpb24gY3VycmVudDIodmFsdWUpIHsKICBpZiAoIWlzRHJhZnQyKHZhbHVlKSkKICAgIGRpZTIoMTAsIHZhbHVlKTsKICByZXR1cm4gY3VycmVudEltcGwyKHZhbHVlKTsKfQpmdW5jdGlvbiBjdXJyZW50SW1wbDIodmFsdWUpIHsKICBpZiAoIWlzRHJhZnRhYmxlMih2YWx1ZSkgfHwgaXNGcm96ZW4yKHZhbHVlKSkKICAgIHJldHVybiB2YWx1ZTsKICBjb25zdCBzdGF0ZSA9IHZhbHVlW0RSQUZUX1NUQVRFMl07CiAgbGV0IGNvcHkzOwogIGxldCBzdHJpY3QgPSB0cnVlOwogIGlmIChzdGF0ZSkgewogICAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pCiAgICAgIHJldHVybiBzdGF0ZS5iYXNlXzsKICAgIHN0YXRlLmZpbmFsaXplZF8gPSB0cnVlOwogICAgY29weTMgPSBzaGFsbG93Q29weTIodmFsdWUsIHN0YXRlLnNjb3BlXy5pbW1lcl8udXNlU3RyaWN0U2hhbGxvd0NvcHlfKTsKICAgIHN0cmljdCA9IHN0YXRlLnNjb3BlXy5pbW1lcl8uc2hvdWxkVXNlU3RyaWN0SXRlcmF0aW9uKCk7CiAgfSBlbHNlIHsKICAgIGNvcHkzID0gc2hhbGxvd0NvcHkyKHZhbHVlLCB0cnVlKTsKICB9CiAgZWFjaDIoCiAgICBjb3B5MywKICAgIChrZXksIGNoaWxkVmFsdWUpID0+IHsKICAgICAgc2V0Mihjb3B5Mywga2V5LCBjdXJyZW50SW1wbDIoY2hpbGRWYWx1ZSkpOwogICAgfSwKICAgIHN0cmljdAogICk7CiAgaWYgKHN0YXRlKSB7CiAgICBzdGF0ZS5maW5hbGl6ZWRfID0gZmFsc2U7CiAgfQogIHJldHVybiBjb3B5MzsKfQp2YXIgaW1tZXIyID0gbmV3IEltbWVyMjIoKTsKdmFyIHByb2R1Y2UyID0gaW1tZXIyLnByb2R1Y2U7CmZ1bmN0aW9uIGNhc3REcmFmdCh2YWx1ZSkgewogIHJldHVybiB2YWx1ZTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvbGVnZW5kU2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZTIgPSB7CiAgc2V0dGluZ3M6IHsKICAgIGxheW91dDogImhvcml6b250YWwiLAogICAgYWxpZ246ICJjZW50ZXIiLAogICAgdmVydGljYWxBbGlnbjogIm1pZGRsZSIsCiAgICBpdGVtU29ydGVyOiAidmFsdWUiCiAgfSwKICBzaXplOiB7CiAgICB3aWR0aDogMCwKICAgIGhlaWdodDogMAogIH0sCiAgcGF5bG9hZDogW10KfTsKdmFyIGxlZ2VuZFNsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJsZWdlbmQiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMiwKICByZWR1Y2VyczogewogICAgc2V0TGVnZW5kU2l6ZShzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnNpemUud2lkdGggPSBhY3Rpb24ucGF5bG9hZC53aWR0aDsKICAgICAgc3RhdGUuc2l6ZS5oZWlnaHQgPSBhY3Rpb24ucGF5bG9hZC5oZWlnaHQ7CiAgICB9LAogICAgc2V0TGVnZW5kU2V0dGluZ3Moc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zZXR0aW5ncy5hbGlnbiA9IGFjdGlvbi5wYXlsb2FkLmFsaWduOwogICAgICBzdGF0ZS5zZXR0aW5ncy5sYXlvdXQgPSBhY3Rpb24ucGF5bG9hZC5sYXlvdXQ7CiAgICAgIHN0YXRlLnNldHRpbmdzLnZlcnRpY2FsQWxpZ24gPSBhY3Rpb24ucGF5bG9hZC52ZXJ0aWNhbEFsaWduOwogICAgICBzdGF0ZS5zZXR0aW5ncy5pdGVtU29ydGVyID0gYWN0aW9uLnBheWxvYWQuaXRlbVNvcnRlcjsKICAgIH0sCiAgICBhZGRMZWdlbmRQYXlsb2FkOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLnBheWxvYWQucHVzaChjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZXBsYWNlTGVnZW5kUGF5bG9hZDogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgewogICAgICAgICAgcHJldiwKICAgICAgICAgIG5leHQKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkucGF5bG9hZC5pbmRleE9mKGNhc3REcmFmdChwcmV2KSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLnBheWxvYWRbaW5kZXhdID0gY2FzdERyYWZ0KG5leHQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVMZWdlbmRQYXlsb2FkOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLnBheWxvYWQuaW5kZXhPZihjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgc3RhdGUucGF5bG9hZC5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0KICB9Cn0pOwp2YXIgewogIHNldExlZ2VuZFNpemUsCiAgc2V0TGVnZW5kU2V0dGluZ3MsCiAgYWRkTGVnZW5kUGF5bG9hZCwKICByZXBsYWNlTGVnZW5kUGF5bG9hZCwKICByZW1vdmVMZWdlbmRQYXlsb2FkCn0gPSBsZWdlbmRTbGljZS5hY3Rpb25zOwp2YXIgbGVnZW5kUmVkdWNlciA9IGxlZ2VuZFNsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVG9vbHRpcC5qcwp2YXIgUmVhY3QxMiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDI0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0X2RvbTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3RfZG9tKCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0RlZmF1bHRUb29sdGlwQ29udGVudC5qcwp2YXIgUmVhY3Q1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3NvcnRCeTMgPSBfX3RvRVNNKHJlcXVpcmVfc29ydEJ5MigpKTsKZnVuY3Rpb24gX2V4dGVuZHM0KCkgewogIHJldHVybiBfZXh0ZW5kczQgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczQuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzNShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDUoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXM1KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHk1KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czUoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTUoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXk1KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTUodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlNSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmU1KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBkZWZhdWx0Rm9ybWF0dGVyKHZhbHVlKSB7CiAgcmV0dXJuIEFycmF5LmlzQXJyYXkodmFsdWUpICYmIGlzTnVtT3JTdHIodmFsdWVbMF0pICYmIGlzTnVtT3JTdHIodmFsdWVbMV0pID8gdmFsdWUuam9pbigiIH4gIikgOiB2YWx1ZTsKfQp2YXIgRGVmYXVsdFRvb2x0aXBDb250ZW50ID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIHNlcGFyYXRvciA9ICIgOiAiLAogICAgY29udGVudFN0eWxlID0ge30sCiAgICBpdGVtU3R5bGUgPSB7fSwKICAgIGxhYmVsU3R5bGUgPSB7fSwKICAgIHBheWxvYWQsCiAgICBmb3JtYXR0ZXIsCiAgICBpdGVtU29ydGVyLAogICAgd3JhcHBlckNsYXNzTmFtZSwKICAgIGxhYmVsQ2xhc3NOYW1lLAogICAgbGFiZWwsCiAgICBsYWJlbEZvcm1hdHRlciwKICAgIGFjY2Vzc2liaWxpdHlMYXllciA9IGZhbHNlCiAgfSA9IHByb3BzOwogIHZhciByZW5kZXJDb250ZW50MiA9ICgpID0+IHsKICAgIGlmIChwYXlsb2FkICYmIHBheWxvYWQubGVuZ3RoKSB7CiAgICAgIHZhciBsaXN0U3R5bGUgPSB7CiAgICAgICAgcGFkZGluZzogMCwKICAgICAgICBtYXJnaW46IDAKICAgICAgfTsKICAgICAgdmFyIGl0ZW1zID0gKGl0ZW1Tb3J0ZXIgPyAoMCwgaW1wb3J0X3NvcnRCeTMuZGVmYXVsdCkocGF5bG9hZCwgaXRlbVNvcnRlcikgOiBwYXlsb2FkKS5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICAgICAgaWYgKGVudHJ5LnR5cGUgPT09ICJub25lIikgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBmaW5hbEZvcm1hdHRlciA9IGVudHJ5LmZvcm1hdHRlciB8fCBmb3JtYXR0ZXIgfHwgZGVmYXVsdEZvcm1hdHRlcjsKICAgICAgICB2YXIgewogICAgICAgICAgdmFsdWUsCiAgICAgICAgICBuYW1lCiAgICAgICAgfSA9IGVudHJ5OwogICAgICAgIHZhciBmaW5hbFZhbHVlID0gdmFsdWU7CiAgICAgICAgdmFyIGZpbmFsTmFtZSA9IG5hbWU7CiAgICAgICAgaWYgKGZpbmFsRm9ybWF0dGVyKSB7CiAgICAgICAgICB2YXIgZm9ybWF0dGVkID0gZmluYWxGb3JtYXR0ZXIodmFsdWUsIG5hbWUsIGVudHJ5LCBpLCBwYXlsb2FkKTsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGZvcm1hdHRlZCkpIHsKICAgICAgICAgICAgW2ZpbmFsVmFsdWUsIGZpbmFsTmFtZV0gPSBmb3JtYXR0ZWQ7CiAgICAgICAgICB9IGVsc2UgaWYgKGZvcm1hdHRlZCAhPSBudWxsKSB7CiAgICAgICAgICAgIGZpbmFsVmFsdWUgPSBmb3JtYXR0ZWQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGZpbmFsSXRlbVN0eWxlID0gX29iamVjdFNwcmVhZDUoewogICAgICAgICAgZGlzcGxheTogImJsb2NrIiwKICAgICAgICAgIHBhZGRpbmdUb3A6IDQsCiAgICAgICAgICBwYWRkaW5nQm90dG9tOiA0LAogICAgICAgICAgY29sb3I6IGVudHJ5LmNvbG9yIHx8ICIjMDAwIgogICAgICAgIH0sIGl0ZW1TdHlsZSk7CiAgICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgibGkiLCB7CiAgICAgICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy10b29sdGlwLWl0ZW0iLAogICAgICAgICAga2V5OiAidG9vbHRpcC1pdGVtLSIuY29uY2F0KGkpLAogICAgICAgICAgc3R5bGU6IGZpbmFsSXRlbVN0eWxlCiAgICAgICAgfSwgaXNOdW1PclN0cihmaW5hbE5hbWUpID8gLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJzcGFuIiwgewogICAgICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtdG9vbHRpcC1pdGVtLW5hbWUiCiAgICAgICAgfSwgZmluYWxOYW1lKSA6IG51bGwsIGlzTnVtT3JTdHIoZmluYWxOYW1lKSA/IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgic3BhbiIsIHsKICAgICAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXRvb2x0aXAtaXRlbS1zZXBhcmF0b3IiCiAgICAgICAgfSwgc2VwYXJhdG9yKSA6IG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgic3BhbiIsIHsKICAgICAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXRvb2x0aXAtaXRlbS12YWx1ZSIKICAgICAgICB9LCBmaW5hbFZhbHVlKSwgLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJzcGFuIiwgewogICAgICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtdG9vbHRpcC1pdGVtLXVuaXQiCiAgICAgICAgfSwgZW50cnkudW5pdCB8fCAiIikpOwogICAgICB9KTsKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgidWwiLCB7CiAgICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtdG9vbHRpcC1pdGVtLWxpc3QiLAogICAgICAgIHN0eWxlOiBsaXN0U3R5bGUKICAgICAgfSwgaXRlbXMpOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfTsKICB2YXIgZmluYWxTdHlsZSA9IF9vYmplY3RTcHJlYWQ1KHsKICAgIG1hcmdpbjogMCwKICAgIHBhZGRpbmc6IDEwLAogICAgYmFja2dyb3VuZENvbG9yOiAiI2ZmZiIsCiAgICBib3JkZXI6ICIxcHggc29saWQgI2NjYyIsCiAgICB3aGl0ZVNwYWNlOiAibm93cmFwIgogIH0sIGNvbnRlbnRTdHlsZSk7CiAgdmFyIGZpbmFsTGFiZWxTdHlsZSA9IF9vYmplY3RTcHJlYWQ1KHsKICAgIG1hcmdpbjogMAogIH0sIGxhYmVsU3R5bGUpOwogIHZhciBoYXNMYWJlbCA9ICFpc051bGxpc2gobGFiZWwpOwogIHZhciBmaW5hbExhYmVsID0gaGFzTGFiZWwgPyBsYWJlbCA6ICIiOwogIHZhciB3cmFwcGVyQ04gPSBjbHN4KCJyZWNoYXJ0cy1kZWZhdWx0LXRvb2x0aXAiLCB3cmFwcGVyQ2xhc3NOYW1lKTsKICB2YXIgbGFiZWxDTiA9IGNsc3goInJlY2hhcnRzLXRvb2x0aXAtbGFiZWwiLCBsYWJlbENsYXNzTmFtZSk7CiAgaWYgKGhhc0xhYmVsICYmIGxhYmVsRm9ybWF0dGVyICYmIHBheWxvYWQgIT09IHZvaWQgMCAmJiBwYXlsb2FkICE9PSBudWxsKSB7CiAgICBmaW5hbExhYmVsID0gbGFiZWxGb3JtYXR0ZXIobGFiZWwsIHBheWxvYWQpOwogIH0KICB2YXIgYWNjZXNzaWJpbGl0eUF0dHJpYnV0ZXMgPSBhY2Nlc3NpYmlsaXR5TGF5ZXIgPyB7CiAgICByb2xlOiAic3RhdHVzIiwKICAgICJhcmlhLWxpdmUiOiAiYXNzZXJ0aXZlIgogIH0gOiB7fTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJkaXYiLCBfZXh0ZW5kczQoewogICAgY2xhc3NOYW1lOiB3cmFwcGVyQ04sCiAgICBzdHlsZTogZmluYWxTdHlsZQogIH0sIGFjY2Vzc2liaWxpdHlBdHRyaWJ1dGVzKSwgLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJwIiwgewogICAgY2xhc3NOYW1lOiBsYWJlbENOLAogICAgc3R5bGU6IGZpbmFsTGFiZWxTdHlsZQogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuaXNWYWxpZEVsZW1lbnQoZmluYWxMYWJlbCkgPyBmaW5hbExhYmVsIDogIiIuY29uY2F0KGZpbmFsTGFiZWwpKSwgcmVuZGVyQ29udGVudDIoKSk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVG9vbHRpcEJvdW5kaW5nQm94LmpzCnZhciBSZWFjdDYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QxNCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdG9vbHRpcC90cmFuc2xhdGUuanMKdmFyIENTU19DTEFTU19QUkVGSVggPSAicmVjaGFydHMtdG9vbHRpcC13cmFwcGVyIjsKdmFyIFRPT0xUSVBfSElEREVOID0gewogIHZpc2liaWxpdHk6ICJoaWRkZW4iCn07CmZ1bmN0aW9uIGdldFRvb2x0aXBDU1NDbGFzc05hbWUoX3JlZjIpIHsKICB2YXIgewogICAgY29vcmRpbmF0ZSwKICAgIHRyYW5zbGF0ZVgsCiAgICB0cmFuc2xhdGVZCiAgfSA9IF9yZWYyOwogIHJldHVybiBjbHN4KENTU19DTEFTU19QUkVGSVgsIHsKICAgIFsiIi5jb25jYXQoQ1NTX0NMQVNTX1BSRUZJWCwgIi1yaWdodCIpXTogaXNOdW1iZXIodHJhbnNsYXRlWCkgJiYgY29vcmRpbmF0ZSAmJiBpc051bWJlcihjb29yZGluYXRlLngpICYmIHRyYW5zbGF0ZVggPj0gY29vcmRpbmF0ZS54LAogICAgWyIiLmNvbmNhdChDU1NfQ0xBU1NfUFJFRklYLCAiLWxlZnQiKV06IGlzTnVtYmVyKHRyYW5zbGF0ZVgpICYmIGNvb3JkaW5hdGUgJiYgaXNOdW1iZXIoY29vcmRpbmF0ZS54KSAmJiB0cmFuc2xhdGVYIDwgY29vcmRpbmF0ZS54LAogICAgWyIiLmNvbmNhdChDU1NfQ0xBU1NfUFJFRklYLCAiLWJvdHRvbSIpXTogaXNOdW1iZXIodHJhbnNsYXRlWSkgJiYgY29vcmRpbmF0ZSAmJiBpc051bWJlcihjb29yZGluYXRlLnkpICYmIHRyYW5zbGF0ZVkgPj0gY29vcmRpbmF0ZS55LAogICAgWyIiLmNvbmNhdChDU1NfQ0xBU1NfUFJFRklYLCAiLXRvcCIpXTogaXNOdW1iZXIodHJhbnNsYXRlWSkgJiYgY29vcmRpbmF0ZSAmJiBpc051bWJlcihjb29yZGluYXRlLnkpICYmIHRyYW5zbGF0ZVkgPCBjb29yZGluYXRlLnkKICB9KTsKfQpmdW5jdGlvbiBnZXRUb29sdGlwVHJhbnNsYXRlWFkoX3JlZjIpIHsKICB2YXIgewogICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgY29vcmRpbmF0ZSwKICAgIGtleSwKICAgIG9mZnNldFRvcExlZnQsCiAgICBwb3NpdGlvbiwKICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICB0b29sdGlwRGltZW5zaW9uLAogICAgdmlld0JveCwKICAgIHZpZXdCb3hEaW1lbnNpb24KICB9ID0gX3JlZjI7CiAgaWYgKHBvc2l0aW9uICYmIGlzTnVtYmVyKHBvc2l0aW9uW2tleV0pKSB7CiAgICByZXR1cm4gcG9zaXRpb25ba2V5XTsKICB9CiAgdmFyIG5lZ2F0aXZlID0gY29vcmRpbmF0ZVtrZXldIC0gdG9vbHRpcERpbWVuc2lvbiAtIChvZmZzZXRUb3BMZWZ0ID4gMCA/IG9mZnNldFRvcExlZnQgOiAwKTsKICB2YXIgcG9zaXRpdmUgPSBjb29yZGluYXRlW2tleV0gKyBvZmZzZXRUb3BMZWZ0OwogIGlmIChhbGxvd0VzY2FwZVZpZXdCb3hba2V5XSkgewogICAgcmV0dXJuIHJldmVyc2VEaXJlY3Rpb25ba2V5XSA/IG5lZ2F0aXZlIDogcG9zaXRpdmU7CiAgfQogIHZhciB2aWV3Qm94S2V5ID0gdmlld0JveFtrZXldOwogIGlmICh2aWV3Qm94S2V5ID09IG51bGwpIHsKICAgIHJldHVybiAwOwogIH0KICBpZiAocmV2ZXJzZURpcmVjdGlvbltrZXldKSB7CiAgICB2YXIgX3Rvb2x0aXBCb3VuZGFyeSA9IG5lZ2F0aXZlOwogICAgdmFyIF92aWV3Qm94Qm91bmRhcnkgPSB2aWV3Qm94S2V5OwogICAgaWYgKF90b29sdGlwQm91bmRhcnkgPCBfdmlld0JveEJvdW5kYXJ5KSB7CiAgICAgIHJldHVybiBNYXRoLm1heChwb3NpdGl2ZSwgdmlld0JveEtleSk7CiAgICB9CiAgICByZXR1cm4gTWF0aC5tYXgobmVnYXRpdmUsIHZpZXdCb3hLZXkpOwogIH0KICBpZiAodmlld0JveERpbWVuc2lvbiA9PSBudWxsKSB7CiAgICByZXR1cm4gMDsKICB9CiAgdmFyIHRvb2x0aXBCb3VuZGFyeSA9IHBvc2l0aXZlICsgdG9vbHRpcERpbWVuc2lvbjsKICB2YXIgdmlld0JveEJvdW5kYXJ5ID0gdmlld0JveEtleSArIHZpZXdCb3hEaW1lbnNpb247CiAgaWYgKHRvb2x0aXBCb3VuZGFyeSA+IHZpZXdCb3hCb3VuZGFyeSkgewogICAgcmV0dXJuIE1hdGgubWF4KG5lZ2F0aXZlLCB2aWV3Qm94S2V5KTsKICB9CiAgcmV0dXJuIE1hdGgubWF4KHBvc2l0aXZlLCB2aWV3Qm94S2V5KTsKfQpmdW5jdGlvbiBnZXRUcmFuc2Zvcm1TdHlsZShfcmVmMykgewogIHZhciB7CiAgICB0cmFuc2xhdGVYLAogICAgdHJhbnNsYXRlWSwKICAgIHVzZVRyYW5zbGF0ZTNkCiAgfSA9IF9yZWYzOwogIHJldHVybiB7CiAgICB0cmFuc2Zvcm06IHVzZVRyYW5zbGF0ZTNkID8gInRyYW5zbGF0ZTNkKCIuY29uY2F0KHRyYW5zbGF0ZVgsICJweCwgIikuY29uY2F0KHRyYW5zbGF0ZVksICJweCwgMCkiKSA6ICJ0cmFuc2xhdGUoIi5jb25jYXQodHJhbnNsYXRlWCwgInB4LCAiKS5jb25jYXQodHJhbnNsYXRlWSwgInB4KSIpCiAgfTsKfQpmdW5jdGlvbiBnZXRUb29sdGlwVHJhbnNsYXRlKF9yZWY0KSB7CiAgdmFyIHsKICAgIGFsbG93RXNjYXBlVmlld0JveCwKICAgIGNvb3JkaW5hdGUsCiAgICBvZmZzZXRUb3BMZWZ0LAogICAgcG9zaXRpb24sCiAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgdG9vbHRpcEJveCwKICAgIHVzZVRyYW5zbGF0ZTNkLAogICAgdmlld0JveAogIH0gPSBfcmVmNDsKICB2YXIgY3NzUHJvcGVydGllcywgdHJhbnNsYXRlWCwgdHJhbnNsYXRlWTsKICBpZiAodG9vbHRpcEJveC5oZWlnaHQgPiAwICYmIHRvb2x0aXBCb3gud2lkdGggPiAwICYmIGNvb3JkaW5hdGUpIHsKICAgIHRyYW5zbGF0ZVggPSBnZXRUb29sdGlwVHJhbnNsYXRlWFkoewogICAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICAgIGNvb3JkaW5hdGUsCiAgICAgIGtleTogIngiLAogICAgICBvZmZzZXRUb3BMZWZ0LAogICAgICBwb3NpdGlvbiwKICAgICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgICAgdG9vbHRpcERpbWVuc2lvbjogdG9vbHRpcEJveC53aWR0aCwKICAgICAgdmlld0JveCwKICAgICAgdmlld0JveERpbWVuc2lvbjogdmlld0JveC53aWR0aAogICAgfSk7CiAgICB0cmFuc2xhdGVZID0gZ2V0VG9vbHRpcFRyYW5zbGF0ZVhZKHsKICAgICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgICBjb29yZGluYXRlLAogICAgICBrZXk6ICJ5IiwKICAgICAgb2Zmc2V0VG9wTGVmdCwKICAgICAgcG9zaXRpb24sCiAgICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICAgIHRvb2x0aXBEaW1lbnNpb246IHRvb2x0aXBCb3guaGVpZ2h0LAogICAgICB2aWV3Qm94LAogICAgICB2aWV3Qm94RGltZW5zaW9uOiB2aWV3Qm94LmhlaWdodAogICAgfSk7CiAgICBjc3NQcm9wZXJ0aWVzID0gZ2V0VHJhbnNmb3JtU3R5bGUoewogICAgICB0cmFuc2xhdGVYLAogICAgICB0cmFuc2xhdGVZLAogICAgICB1c2VUcmFuc2xhdGUzZAogICAgfSk7CiAgfSBlbHNlIHsKICAgIGNzc1Byb3BlcnRpZXMgPSBUT09MVElQX0hJRERFTjsKICB9CiAgcmV0dXJuIHsKICAgIGNzc1Byb3BlcnRpZXMsCiAgICBjc3NDbGFzc2VzOiBnZXRUb29sdGlwQ1NTQ2xhc3NOYW1lKHsKICAgICAgdHJhbnNsYXRlWCwKICAgICAgdHJhbnNsYXRlWSwKICAgICAgY29vcmRpbmF0ZQogICAgfSkKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVG9vbHRpcEJvdW5kaW5nQm94LmpzCmZ1bmN0aW9uIG93bktleXM2KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkNihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czYoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTYoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzNihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5NihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTYocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5Nih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU2KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTYodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBUb29sdGlwQm91bmRpbmdCb3ggPSBjbGFzcyBleHRlbmRzIGltcG9ydF9yZWFjdDE0LlB1cmVDb21wb25lbnQgewogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgIF9kZWZpbmVQcm9wZXJ0eTYodGhpcywgInN0YXRlIiwgewogICAgICBkaXNtaXNzZWQ6IGZhbHNlLAogICAgICBkaXNtaXNzZWRBdENvb3JkaW5hdGU6IHsKICAgICAgICB4OiAwLAogICAgICAgIHk6IDAKICAgICAgfQogICAgfSk7CiAgICBfZGVmaW5lUHJvcGVydHk2KHRoaXMsICJoYW5kbGVLZXlEb3duIiwgKGV2ZW50KSA9PiB7CiAgICAgIGlmIChldmVudC5rZXkgPT09ICJFc2NhcGUiKSB7CiAgICAgICAgdmFyIF90aGlzJHByb3BzJGNvb3JkaW5hdCwgX3RoaXMkcHJvcHMkY29vcmRpbmF0MiwgX3RoaXMkcHJvcHMkY29vcmRpbmF0MywgX3RoaXMkcHJvcHMkY29vcmRpbmF0NDsKICAgICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICAgIGRpc21pc3NlZDogdHJ1ZSwKICAgICAgICAgIGRpc21pc3NlZEF0Q29vcmRpbmF0ZTogewogICAgICAgICAgICB4OiAoX3RoaXMkcHJvcHMkY29vcmRpbmF0ID0gKF90aGlzJHByb3BzJGNvb3JkaW5hdDIgPSB0aGlzLnByb3BzLmNvb3JkaW5hdGUpID09PSBudWxsIHx8IF90aGlzJHByb3BzJGNvb3JkaW5hdDIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJHByb3BzJGNvb3JkaW5hdDIueCkgIT09IG51bGwgJiYgX3RoaXMkcHJvcHMkY29vcmRpbmF0ICE9PSB2b2lkIDAgPyBfdGhpcyRwcm9wcyRjb29yZGluYXQgOiAwLAogICAgICAgICAgICB5OiAoX3RoaXMkcHJvcHMkY29vcmRpbmF0MyA9IChfdGhpcyRwcm9wcyRjb29yZGluYXQ0ID0gdGhpcy5wcm9wcy5jb29yZGluYXRlKSA9PT0gbnVsbCB8fCBfdGhpcyRwcm9wcyRjb29yZGluYXQ0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdGhpcyRwcm9wcyRjb29yZGluYXQ0LnkpICE9PSBudWxsICYmIF90aGlzJHByb3BzJGNvb3JkaW5hdDMgIT09IHZvaWQgMCA/IF90aGlzJHByb3BzJGNvb3JkaW5hdDMgOiAwCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIH0KICBjb21wb25lbnREaWRNb3VudCgpIHsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLmhhbmRsZUtleURvd24pOwogIH0KICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLmhhbmRsZUtleURvd24pOwogIH0KICBjb21wb25lbnREaWRVcGRhdGUoKSB7CiAgICB2YXIgX3RoaXMkcHJvcHMkY29vcmRpbmF0NSwgX3RoaXMkcHJvcHMkY29vcmRpbmF0NjsKICAgIGlmICghdGhpcy5zdGF0ZS5kaXNtaXNzZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCgoX3RoaXMkcHJvcHMkY29vcmRpbmF0NSA9IHRoaXMucHJvcHMuY29vcmRpbmF0ZSkgPT09IG51bGwgfHwgX3RoaXMkcHJvcHMkY29vcmRpbmF0NSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RoaXMkcHJvcHMkY29vcmRpbmF0NS54KSAhPT0gdGhpcy5zdGF0ZS5kaXNtaXNzZWRBdENvb3JkaW5hdGUueCB8fCAoKF90aGlzJHByb3BzJGNvb3JkaW5hdDYgPSB0aGlzLnByb3BzLmNvb3JkaW5hdGUpID09PSBudWxsIHx8IF90aGlzJHByb3BzJGNvb3JkaW5hdDYgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJHByb3BzJGNvb3JkaW5hdDYueSkgIT09IHRoaXMuc3RhdGUuZGlzbWlzc2VkQXRDb29yZGluYXRlLnkpIHsKICAgICAgdGhpcy5zdGF0ZS5kaXNtaXNzZWQgPSBmYWxzZTsKICAgIH0KICB9CiAgcmVuZGVyKCkgewogICAgdmFyIHsKICAgICAgYWN0aXZlLAogICAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICAgIGFuaW1hdGlvbkR1cmF0aW9uLAogICAgICBhbmltYXRpb25FYXNpbmcsCiAgICAgIGNoaWxkcmVuLAogICAgICBjb29yZGluYXRlLAogICAgICBoYXNQYXlsb2FkLAogICAgICBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgICAgb2Zmc2V0LAogICAgICBwb3NpdGlvbiwKICAgICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgICAgdXNlVHJhbnNsYXRlM2QsCiAgICAgIHZpZXdCb3gsCiAgICAgIHdyYXBwZXJTdHlsZSwKICAgICAgbGFzdEJvdW5kaW5nQm94LAogICAgICBpbm5lclJlZiwKICAgICAgaGFzUG9ydGFsRnJvbVByb3BzCiAgICB9ID0gdGhpcy5wcm9wczsKICAgIHZhciB7CiAgICAgIGNzc0NsYXNzZXMsCiAgICAgIGNzc1Byb3BlcnRpZXMKICAgIH0gPSBnZXRUb29sdGlwVHJhbnNsYXRlKHsKICAgICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgICBjb29yZGluYXRlLAogICAgICBvZmZzZXRUb3BMZWZ0OiBvZmZzZXQsCiAgICAgIHBvc2l0aW9uLAogICAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgICB0b29sdGlwQm94OiB7CiAgICAgICAgaGVpZ2h0OiBsYXN0Qm91bmRpbmdCb3guaGVpZ2h0LAogICAgICAgIHdpZHRoOiBsYXN0Qm91bmRpbmdCb3gud2lkdGgKICAgICAgfSwKICAgICAgdXNlVHJhbnNsYXRlM2QsCiAgICAgIHZpZXdCb3gKICAgIH0pOwogICAgdmFyIHBvc2l0aW9uU3R5bGVzID0gaGFzUG9ydGFsRnJvbVByb3BzID8ge30gOiBfb2JqZWN0U3ByZWFkNihfb2JqZWN0U3ByZWFkNih7CiAgICAgIHRyYW5zaXRpb246IGlzQW5pbWF0aW9uQWN0aXZlICYmIGFjdGl2ZSA/ICJ0cmFuc2Zvcm0gIi5jb25jYXQoYW5pbWF0aW9uRHVyYXRpb24sICJtcyAiKS5jb25jYXQoYW5pbWF0aW9uRWFzaW5nKSA6IHZvaWQgMAogICAgfSwgY3NzUHJvcGVydGllcyksIHt9LCB7CiAgICAgIHBvaW50ZXJFdmVudHM6ICJub25lIiwKICAgICAgdmlzaWJpbGl0eTogIXRoaXMuc3RhdGUuZGlzbWlzc2VkICYmIGFjdGl2ZSAmJiBoYXNQYXlsb2FkID8gInZpc2libGUiIDogImhpZGRlbiIsCiAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICB0b3A6IDAsCiAgICAgIGxlZnQ6IDAKICAgIH0pOwogICAgdmFyIG91dGVyU3R5bGUgPSBfb2JqZWN0U3ByZWFkNihfb2JqZWN0U3ByZWFkNih7fSwgcG9zaXRpb25TdHlsZXMpLCB7fSwgewogICAgICB2aXNpYmlsaXR5OiAhdGhpcy5zdGF0ZS5kaXNtaXNzZWQgJiYgYWN0aXZlICYmIGhhc1BheWxvYWQgPyAidmlzaWJsZSIgOiAiaGlkZGVuIgogICAgfSwgd3JhcHBlclN0eWxlKTsKICAgIHJldHVybiAoCiAgICAgIC8vIFRoaXMgZWxlbWVudCBhbGxvdyBsaXN0ZW5pbmcgdG8gdGhlIGBFc2NhcGVgIGtleS4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9yZWNoYXJ0cy9yZWNoYXJ0cy9wdWxsLzI5MjUKICAgICAgLyogQF9fUFVSRV9fICovIFJlYWN0Ni5jcmVhdGVFbGVtZW50KCJkaXYiLCB7CiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciB0eXBlc2NyaXB0IGxpYnJhcnkgZG9lcyBub3QgcmVjb2duaXplIHhtbG5zIGF0dHJpYnV0ZSwgYnV0IGl0J3MgcmVxdWlyZWQgZm9yIGFuIEhUTUwgY2h1bmsgaW5zaWRlIFNWRy4KICAgICAgICB4bWxuczogImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiLAogICAgICAgIHRhYkluZGV4OiAtMSwKICAgICAgICBjbGFzc05hbWU6IGNzc0NsYXNzZXMsCiAgICAgICAgc3R5bGU6IG91dGVyU3R5bGUsCiAgICAgICAgcmVmOiBpbm5lclJlZgogICAgICB9LCBjaGlsZHJlbikKICAgICk7CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9hY2Nlc3NpYmlsaXR5Q29udGV4dC5qcwp2YXIgdXNlQWNjZXNzaWJpbGl0eUxheWVyID0gKCkgPT4gewogIHZhciBfdXNlQXBwU2VsZWN0b3I7CiAgcmV0dXJuIChfdXNlQXBwU2VsZWN0b3IgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5hY2Nlc3NpYmlsaXR5TGF5ZXIpKSAhPT0gbnVsbCAmJiBfdXNlQXBwU2VsZWN0b3IgIT09IHZvaWQgMCA/IF91c2VBcHBTZWxlY3RvciA6IHRydWU7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvQ3Vyc29yLmpzCnZhciBSZWFjdDExID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MjEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zaGFwZS9DdXJ2ZS5qcwp2YXIgUmVhY3Q3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBfZXh0ZW5kczUoKSB7CiAgcmV0dXJuIF9leHRlbmRzNSA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzNS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIG93bktleXM3KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkNyhlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czcoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTcoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzNyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5NyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTcocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5Nyh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU3KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTcodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBDVVJWRV9GQUNUT1JJRVMgPSB7CiAgY3VydmVCYXNpc0Nsb3NlZDogYmFzaXNDbG9zZWRfZGVmYXVsdCwKICBjdXJ2ZUJhc2lzT3BlbjogYmFzaXNPcGVuX2RlZmF1bHQsCiAgY3VydmVCYXNpczogYmFzaXNfZGVmYXVsdCwKICBjdXJ2ZUJ1bXBYOiBidW1wWCwKICBjdXJ2ZUJ1bXBZOiBidW1wWSwKICBjdXJ2ZUxpbmVhckNsb3NlZDogbGluZWFyQ2xvc2VkX2RlZmF1bHQsCiAgY3VydmVMaW5lYXI6IGxpbmVhcl9kZWZhdWx0LAogIGN1cnZlTW9ub3RvbmVYOiBtb25vdG9uZVgsCiAgY3VydmVNb25vdG9uZVk6IG1vbm90b25lWSwKICBjdXJ2ZU5hdHVyYWw6IG5hdHVyYWxfZGVmYXVsdCwKICBjdXJ2ZVN0ZXA6IHN0ZXBfZGVmYXVsdCwKICBjdXJ2ZVN0ZXBBZnRlcjogc3RlcEFmdGVyLAogIGN1cnZlU3RlcEJlZm9yZTogc3RlcEJlZm9yZQp9Owp2YXIgZGVmaW5lZCA9IChwKSA9PiBpc1dlbGxCZWhhdmVkTnVtYmVyKHAueCkgJiYgaXNXZWxsQmVoYXZlZE51bWJlcihwLnkpOwp2YXIgYXJlYURlZmluZWQgPSAoZCkgPT4gZC5iYXNlICE9IG51bGwgJiYgZGVmaW5lZChkLmJhc2UpICYmIGRlZmluZWQoZCk7CnZhciBnZXRYID0gKHApID0+IHAueDsKdmFyIGdldFkgPSAocCkgPT4gcC55Owp2YXIgZ2V0Q3VydmVGYWN0b3J5ID0gKHR5cGUsIGxheW91dCkgPT4gewogIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIHR5cGU7CiAgfQogIHZhciBuYW1lID0gImN1cnZlIi5jb25jYXQodXBwZXJGaXJzdCh0eXBlKSk7CiAgaWYgKChuYW1lID09PSAiY3VydmVNb25vdG9uZSIgfHwgbmFtZSA9PT0gImN1cnZlQnVtcCIpICYmIGxheW91dCkgewogICAgcmV0dXJuIENVUlZFX0ZBQ1RPUklFU1siIi5jb25jYXQobmFtZSkuY29uY2F0KGxheW91dCA9PT0gInZlcnRpY2FsIiA/ICJZIiA6ICJYIildOwogIH0KICByZXR1cm4gQ1VSVkVfRkFDVE9SSUVTW25hbWVdIHx8IGxpbmVhcl9kZWZhdWx0Owp9Owp2YXIgZ2V0UGF0aCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICB0eXBlID0gImxpbmVhciIsCiAgICBwb2ludHMgPSBbXSwKICAgIGJhc2VMaW5lLAogICAgbGF5b3V0LAogICAgY29ubmVjdE51bGxzID0gZmFsc2UKICB9ID0gX3JlZjI7CiAgdmFyIGN1cnZlRmFjdG9yeSA9IGdldEN1cnZlRmFjdG9yeSh0eXBlLCBsYXlvdXQpOwogIHZhciBmb3JtYXRQb2ludHMgPSBjb25uZWN0TnVsbHMgPyBwb2ludHMuZmlsdGVyKGRlZmluZWQpIDogcG9pbnRzOwogIHZhciBsaW5lRnVuY3Rpb247CiAgaWYgKEFycmF5LmlzQXJyYXkoYmFzZUxpbmUpKSB7CiAgICB2YXIgYXJlYVBvaW50cyA9IHBvaW50cy5tYXAoKGVudHJ5LCBpbmRleCkgPT4gX29iamVjdFNwcmVhZDcoX29iamVjdFNwcmVhZDcoe30sIGVudHJ5KSwge30sIHsKICAgICAgYmFzZTogYmFzZUxpbmVbaW5kZXhdCiAgICB9KSk7CiAgICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICAgIGxpbmVGdW5jdGlvbiA9IGFyZWFfZGVmYXVsdCgpLnkoZ2V0WSkueDEoZ2V0WCkueDAoKGQpID0+IGQuYmFzZS54KTsKICAgIH0gZWxzZSB7CiAgICAgIGxpbmVGdW5jdGlvbiA9IGFyZWFfZGVmYXVsdCgpLngoZ2V0WCkueTEoZ2V0WSkueTAoKGQpID0+IGQuYmFzZS55KTsKICAgIH0KICAgIHZhciBfbnVsbGFibGVMaW5lRnVuY3Rpb24gPSBsaW5lRnVuY3Rpb24uZGVmaW5lZChhcmVhRGVmaW5lZCkuY3VydmUoY3VydmVGYWN0b3J5KTsKICAgIHZhciBmaW5hbFBvaW50cyA9IGNvbm5lY3ROdWxscyA/IGFyZWFQb2ludHMuZmlsdGVyKGFyZWFEZWZpbmVkKSA6IGFyZWFQb2ludHM7CiAgICByZXR1cm4gX251bGxhYmxlTGluZUZ1bmN0aW9uKGZpbmFsUG9pbnRzKTsKICB9CiAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIiAmJiBpc051bWJlcihiYXNlTGluZSkpIHsKICAgIGxpbmVGdW5jdGlvbiA9IGFyZWFfZGVmYXVsdCgpLnkoZ2V0WSkueDEoZ2V0WCkueDAoYmFzZUxpbmUpOwogIH0gZWxzZSBpZiAoaXNOdW1iZXIoYmFzZUxpbmUpKSB7CiAgICBsaW5lRnVuY3Rpb24gPSBhcmVhX2RlZmF1bHQoKS54KGdldFgpLnkxKGdldFkpLnkwKGJhc2VMaW5lKTsKICB9IGVsc2UgewogICAgbGluZUZ1bmN0aW9uID0gbGluZV9kZWZhdWx0KCkueChnZXRYKS55KGdldFkpOwogIH0KICB2YXIgbnVsbGFibGVMaW5lRnVuY3Rpb24gPSBsaW5lRnVuY3Rpb24uZGVmaW5lZChkZWZpbmVkKS5jdXJ2ZShjdXJ2ZUZhY3RvcnkpOwogIHJldHVybiBudWxsYWJsZUxpbmVGdW5jdGlvbihmb3JtYXRQb2ludHMpOwp9Owp2YXIgQ3VydmUgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgY2xhc3NOYW1lLAogICAgcG9pbnRzLAogICAgcGF0aDogcGF0aDIsCiAgICBwYXRoUmVmCiAgfSA9IHByb3BzOwogIGlmICgoIXBvaW50cyB8fCAhcG9pbnRzLmxlbmd0aCkgJiYgIXBhdGgyKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHJlYWxQYXRoID0gcG9pbnRzICYmIHBvaW50cy5sZW5ndGggPyBnZXRQYXRoKHByb3BzKSA6IHBhdGgyOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q3LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCBfZXh0ZW5kczUoe30sIHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhwcm9wcyksIGFkYXB0RXZlbnRIYW5kbGVycyhwcm9wcyksIHsKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtY3VydmUiLCBjbGFzc05hbWUpLAogICAgZDogcmVhbFBhdGggPT09IG51bGwgPyB2b2lkIDAgOiByZWFsUGF0aCwKICAgIHJlZjogcGF0aFJlZgogIH0pKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL0Nyb3NzLmpzCnZhciBSZWFjdDggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQzID0gWyJ4IiwgInkiLCAidG9wIiwgImxlZnQiLCAid2lkdGgiLCAiaGVpZ2h0IiwgImNsYXNzTmFtZSJdOwpmdW5jdGlvbiBfZXh0ZW5kczYoKSB7CiAgcmV0dXJuIF9leHRlbmRzNiA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzNi5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIG93bktleXM4KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkOChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czgoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTgoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzOChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5OChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTgocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5OCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU4KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTgodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczMoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTMoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTMocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBnZXRQYXRoMiA9ICh4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIHRvcCwgbGVmdCkgPT4gewogIHJldHVybiAiTSIuY29uY2F0KHgyLCAiLCIpLmNvbmNhdCh0b3AsICJ2IikuY29uY2F0KGhlaWdodCwgIk0iKS5jb25jYXQobGVmdCwgIiwiKS5jb25jYXQoeTIsICJoIikuY29uY2F0KHdpZHRoKTsKfTsKdmFyIENyb3NzID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIHg6IHgyID0gMCwKICAgIHk6IHkyID0gMCwKICAgIHRvcCA9IDAsCiAgICBsZWZ0ID0gMCwKICAgIHdpZHRoID0gMCwKICAgIGhlaWdodCA9IDAsCiAgICBjbGFzc05hbWUKICB9ID0gX3JlZjIsIHJlc3QgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMzKF9yZWYyLCBfZXhjbHVkZWQzKTsKICB2YXIgcHJvcHMgPSBfb2JqZWN0U3ByZWFkOCh7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgdG9wLAogICAgbGVmdCwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSwgcmVzdCk7CiAgaWYgKCFpc051bWJlcih4MikgfHwgIWlzTnVtYmVyKHkyKSB8fCAhaXNOdW1iZXIod2lkdGgpIHx8ICFpc051bWJlcihoZWlnaHQpIHx8ICFpc051bWJlcih0b3ApIHx8ICFpc051bWJlcihsZWZ0KSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q4LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCBfZXh0ZW5kczYoe30sIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMocHJvcHMpLCB7CiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLWNyb3NzIiwgY2xhc3NOYW1lKSwKICAgIGQ6IGdldFBhdGgyKHgyLCB5Miwgd2lkdGgsIGhlaWdodCwgdG9wLCBsZWZ0KQogIH0pKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvY3Vyc29yL2dldEN1cnNvclJlY3RhbmdsZS5qcwpmdW5jdGlvbiBnZXRDdXJzb3JSZWN0YW5nbGUobGF5b3V0LCBhY3RpdmVDb29yZGluYXRlLCBvZmZzZXQsIHRvb2x0aXBBeGlzQmFuZFNpemUpIHsKICB2YXIgaGFsZlNpemUgPSB0b29sdGlwQXhpc0JhbmRTaXplIC8gMjsKICByZXR1cm4gewogICAgc3Ryb2tlOiAibm9uZSIsCiAgICBmaWxsOiAiI2NjYyIsCiAgICB4OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IGFjdGl2ZUNvb3JkaW5hdGUueCAtIGhhbGZTaXplIDogb2Zmc2V0LmxlZnQgKyAwLjUsCiAgICB5OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IG9mZnNldC50b3AgKyAwLjUgOiBhY3RpdmVDb29yZGluYXRlLnkgLSBoYWxmU2l6ZSwKICAgIHdpZHRoOiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IHRvb2x0aXBBeGlzQmFuZFNpemUgOiBvZmZzZXQud2lkdGggLSAxLAogICAgaGVpZ2h0OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IG9mZnNldC5oZWlnaHQgLSAxIDogdG9vbHRpcEF4aXNCYW5kU2l6ZQogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL1JlY3RhbmdsZS5qcwp2YXIgUmVhY3Q5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MTggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vSmF2YXNjcmlwdEFuaW1hdGUuanMKdmFyIGltcG9ydF9yZWFjdDE2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL3V0aWwuanMKZnVuY3Rpb24gb3duS2V5czkoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQ5KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzOShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5OShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXM5KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHk5KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5OShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXk5KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTkodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlOSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGdldERhc2hDYXNlID0gKG5hbWUpID0+IG5hbWUucmVwbGFjZSgvKFtBLVpdKS9nLCAodikgPT4gIi0iLmNvbmNhdCh2LnRvTG93ZXJDYXNlKCkpKTsKdmFyIGdldFRyYW5zaXRpb25WYWwgPSAocHJvcHMsIGR1cmF0aW9uLCBlYXNpbmcpID0+IHByb3BzLm1hcCgocHJvcCkgPT4gIiIuY29uY2F0KGdldERhc2hDYXNlKHByb3ApLCAiICIpLmNvbmNhdChkdXJhdGlvbiwgIm1zICIpLmNvbmNhdChlYXNpbmcpKS5qb2luKCIsIik7CnZhciBnZXRJbnRlcnNlY3Rpb25LZXlzID0gKHByZU9iaiwgbmV4dE9iaikgPT4gW09iamVjdC5rZXlzKHByZU9iaiksIE9iamVjdC5rZXlzKG5leHRPYmopXS5yZWR1Y2UoKGEsIGIpID0+IGEuZmlsdGVyKChjKSA9PiBiLmluY2x1ZGVzKGMpKSk7CnZhciBtYXBPYmplY3QgPSAoZm4sIG9iaikgPT4gT2JqZWN0LmtleXMob2JqKS5yZWR1Y2UoKHJlcywga2V5KSA9PiBfb2JqZWN0U3ByZWFkOShfb2JqZWN0U3ByZWFkOSh7fSwgcmVzKSwge30sIHsKICBba2V5XTogZm4oa2V5LCBvYmpba2V5XSkKfSksIHt9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi9jb25maWdVcGRhdGUuanMKZnVuY3Rpb24gb3duS2V5czEwKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTAoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxMChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTAoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTAoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTEwKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTAocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTAodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTAodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTAodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBhbHBoYSA9IChiZWdpbiwgZW5kLCBrKSA9PiBiZWdpbiArIChlbmQgLSBiZWdpbikgKiBrOwp2YXIgbmVlZENvbnRpbnVlID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGZyb206IGZyb20yLAogICAgdG86IHRvMgogIH0gPSBfcmVmMjsKICByZXR1cm4gZnJvbTIgIT09IHRvMjsKfTsKdmFyIGNhbFN0ZXBwZXJWYWxzID0gKGVhc2luZywgcHJlVmFscywgc3RlcHMpID0+IHsKICB2YXIgbmV4dFN0ZXBWYWxzID0gbWFwT2JqZWN0KChrZXksIHZhbCkgPT4gewogICAgaWYgKG5lZWRDb250aW51ZSh2YWwpKSB7CiAgICAgIHZhciBbbmV3WCwgbmV3Vl0gPSBlYXNpbmcodmFsLmZyb20sIHZhbC50bywgdmFsLnZlbG9jaXR5KTsKICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIHZhbCksIHt9LCB7CiAgICAgICAgZnJvbTogbmV3WCwKICAgICAgICB2ZWxvY2l0eTogbmV3VgogICAgICB9KTsKICAgIH0KICAgIHJldHVybiB2YWw7CiAgfSwgcHJlVmFscyk7CiAgaWYgKHN0ZXBzIDwgMSkgewogICAgcmV0dXJuIG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IHsKICAgICAgaWYgKG5lZWRDb250aW51ZSh2YWwpKSB7CiAgICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIHZhbCksIHt9LCB7CiAgICAgICAgICB2ZWxvY2l0eTogYWxwaGEodmFsLnZlbG9jaXR5LCBuZXh0U3RlcFZhbHNba2V5XS52ZWxvY2l0eSwgc3RlcHMpLAogICAgICAgICAgZnJvbTogYWxwaGEodmFsLmZyb20sIG5leHRTdGVwVmFsc1trZXldLmZyb20sIHN0ZXBzKQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB2YWw7CiAgICB9LCBwcmVWYWxzKTsKICB9CiAgcmV0dXJuIGNhbFN0ZXBwZXJWYWxzKGVhc2luZywgbmV4dFN0ZXBWYWxzLCBzdGVwcyAtIDEpOwp9OwpmdW5jdGlvbiBjcmVhdGVTdGVwcGVyVXBkYXRlKGZyb20yLCB0bzIsIGVhc2luZywgaW50ZXJLZXlzLCByZW5kZXIsIHRpbWVvdXRDb250cm9sbGVyKSB7CiAgdmFyIHByZVRpbWU7CiAgdmFyIHN0ZXBwZXJTdHlsZSA9IGludGVyS2V5cy5yZWR1Y2UoKHJlcywga2V5KSA9PiBfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCByZXMpLCB7fSwgewogICAgW2tleV06IHsKICAgICAgZnJvbTogZnJvbTJba2V5XSwKICAgICAgdmVsb2NpdHk6IDAsCiAgICAgIHRvOiB0bzJba2V5XQogICAgfQogIH0pLCB7fSk7CiAgdmFyIGdldEN1cnJTdHlsZSA9ICgpID0+IG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IHZhbC5mcm9tLCBzdGVwcGVyU3R5bGUpOwogIHZhciBzaG91bGRTdG9wQW5pbWF0aW9uID0gKCkgPT4gIU9iamVjdC52YWx1ZXMoc3RlcHBlclN0eWxlKS5maWx0ZXIobmVlZENvbnRpbnVlKS5sZW5ndGg7CiAgdmFyIHN0b3BBbmltYXRpb24gPSBudWxsOwogIHZhciBzdGVwcGVyVXBkYXRlID0gKG5vdykgPT4gewogICAgaWYgKCFwcmVUaW1lKSB7CiAgICAgIHByZVRpbWUgPSBub3c7CiAgICB9CiAgICB2YXIgZGVsdGFUaW1lID0gbm93IC0gcHJlVGltZTsKICAgIHZhciBzdGVwcyA9IGRlbHRhVGltZSAvIGVhc2luZy5kdDsKICAgIHN0ZXBwZXJTdHlsZSA9IGNhbFN0ZXBwZXJWYWxzKGVhc2luZywgc3RlcHBlclN0eWxlLCBzdGVwcyk7CiAgICByZW5kZXIoX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIGZyb20yKSwgdG8yKSwgZ2V0Q3VyclN0eWxlKCkpKTsKICAgIHByZVRpbWUgPSBub3c7CiAgICBpZiAoIXNob3VsZFN0b3BBbmltYXRpb24oKSkgewogICAgICBzdG9wQW5pbWF0aW9uID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dChzdGVwcGVyVXBkYXRlKTsKICAgIH0KICB9OwogIHJldHVybiAoKSA9PiB7CiAgICBzdG9wQW5pbWF0aW9uID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dChzdGVwcGVyVXBkYXRlKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHZhciBfc3RvcEFuaW1hdGlvbjsKICAgICAgKF9zdG9wQW5pbWF0aW9uID0gc3RvcEFuaW1hdGlvbikgPT09IG51bGwgfHwgX3N0b3BBbmltYXRpb24gPT09IHZvaWQgMCB8fCBfc3RvcEFuaW1hdGlvbigpOwogICAgfTsKICB9Owp9CmZ1bmN0aW9uIGNyZWF0ZVRpbWluZ1VwZGF0ZShmcm9tMiwgdG8yLCBlYXNpbmcsIGR1cmF0aW9uLCBpbnRlcktleXMsIHJlbmRlciwgdGltZW91dENvbnRyb2xsZXIpIHsKICB2YXIgc3RvcEFuaW1hdGlvbiA9IG51bGw7CiAgdmFyIHRpbWluZ1N0eWxlID0gaW50ZXJLZXlzLnJlZHVjZSgocmVzLCBrZXkpID0+IF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIHJlcyksIHt9LCB7CiAgICBba2V5XTogW2Zyb20yW2tleV0sIHRvMltrZXldXQogIH0pLCB7fSk7CiAgdmFyIGJlZ2luVGltZTsKICB2YXIgdGltaW5nVXBkYXRlID0gKG5vdykgPT4gewogICAgaWYgKCFiZWdpblRpbWUpIHsKICAgICAgYmVnaW5UaW1lID0gbm93OwogICAgfQogICAgdmFyIHQgPSAobm93IC0gYmVnaW5UaW1lKSAvIGR1cmF0aW9uOwogICAgdmFyIGN1cnJTdHlsZSA9IG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IGFscGhhKC4uLnZhbCwgZWFzaW5nKHQpKSwgdGltaW5nU3R5bGUpOwogICAgcmVuZGVyKF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCBmcm9tMiksIHRvMiksIGN1cnJTdHlsZSkpOwogICAgaWYgKHQgPCAxKSB7CiAgICAgIHN0b3BBbmltYXRpb24gPSB0aW1lb3V0Q29udHJvbGxlci5zZXRUaW1lb3V0KHRpbWluZ1VwZGF0ZSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgZmluYWxTdHlsZSA9IG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IGFscGhhKC4uLnZhbCwgZWFzaW5nKDEpKSwgdGltaW5nU3R5bGUpOwogICAgICByZW5kZXIoX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIGZyb20yKSwgdG8yKSwgZmluYWxTdHlsZSkpOwogICAgfQogIH07CiAgcmV0dXJuICgpID0+IHsKICAgIHN0b3BBbmltYXRpb24gPSB0aW1lb3V0Q29udHJvbGxlci5zZXRUaW1lb3V0KHRpbWluZ1VwZGF0ZSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICB2YXIgX3N0b3BBbmltYXRpb24yOwogICAgICAoX3N0b3BBbmltYXRpb24yID0gc3RvcEFuaW1hdGlvbikgPT09IG51bGwgfHwgX3N0b3BBbmltYXRpb24yID09PSB2b2lkIDAgfHwgX3N0b3BBbmltYXRpb24yKCk7CiAgICB9OwogIH07Cn0KdmFyIGNvbmZpZ1VwZGF0ZV9kZWZhdWx0ID0gKGZyb20yLCB0bzIsIGVhc2luZywgZHVyYXRpb24sIHJlbmRlciwgdGltZW91dENvbnRyb2xsZXIpID0+IHsKICB2YXIgaW50ZXJLZXlzID0gZ2V0SW50ZXJzZWN0aW9uS2V5cyhmcm9tMiwgdG8yKTsKICBpZiAoZWFzaW5nID09IG51bGwpIHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHJlbmRlcihfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCBmcm9tMiksIHRvMikpOwogICAgICByZXR1cm4gKCkgPT4gewogICAgICB9OwogICAgfTsKICB9CiAgcmV0dXJuIGVhc2luZy5pc1N0ZXBwZXIgPT09IHRydWUgPyBjcmVhdGVTdGVwcGVyVXBkYXRlKGZyb20yLCB0bzIsIGVhc2luZywgaW50ZXJLZXlzLCByZW5kZXIsIHRpbWVvdXRDb250cm9sbGVyKSA6IGNyZWF0ZVRpbWluZ1VwZGF0ZShmcm9tMiwgdG8yLCBlYXNpbmcsIGR1cmF0aW9uLCBpbnRlcktleXMsIHJlbmRlciwgdGltZW91dENvbnRyb2xsZXIpOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL2Vhc2luZy5qcwp2YXIgQUNDVVJBQ1kgPSAxZS00Owp2YXIgY3ViaWNCZXppZXJGYWN0b3IgPSAoYzEsIGMyKSA9PiBbMCwgMyAqIGMxLCAzICogYzIgLSA2ICogYzEsIDMgKiBjMSAtIDMgKiBjMiArIDFdOwp2YXIgZXZhbHVhdGVQb2x5bm9taWFsID0gKHBhcmFtcywgdCkgPT4gcGFyYW1zLm1hcCgocGFyYW0sIGkpID0+IHBhcmFtICogdCAqKiBpKS5yZWR1Y2UoKHByZSwgY3VycikgPT4gcHJlICsgY3Vycik7CnZhciBjdWJpY0JlemllciA9IChjMSwgYzIpID0+ICh0KSA9PiB7CiAgdmFyIHBhcmFtcyA9IGN1YmljQmV6aWVyRmFjdG9yKGMxLCBjMik7CiAgcmV0dXJuIGV2YWx1YXRlUG9seW5vbWlhbChwYXJhbXMsIHQpOwp9Owp2YXIgZGVyaXZhdGl2ZUN1YmljQmV6aWVyID0gKGMxLCBjMikgPT4gKHQpID0+IHsKICB2YXIgcGFyYW1zID0gY3ViaWNCZXppZXJGYWN0b3IoYzEsIGMyKTsKICB2YXIgbmV3UGFyYW1zID0gWy4uLnBhcmFtcy5tYXAoKHBhcmFtLCBpKSA9PiBwYXJhbSAqIGkpLnNsaWNlKDEpLCAwXTsKICByZXR1cm4gZXZhbHVhdGVQb2x5bm9taWFsKG5ld1BhcmFtcywgdCk7Cn07CnZhciBnZXRCZXppZXJDb29yZGluYXRlcyA9IGZ1bmN0aW9uIGdldEJlemllckNvb3JkaW5hdGVzMigpIHsKICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgfQogIGlmIChhcmdzLmxlbmd0aCA9PT0gMSkgewogICAgc3dpdGNoIChhcmdzWzBdKSB7CiAgICAgIGNhc2UgImxpbmVhciI6CiAgICAgICAgcmV0dXJuIFswLCAwLCAxLCAxXTsKICAgICAgY2FzZSAiZWFzZSI6CiAgICAgICAgcmV0dXJuIFswLjI1LCAwLjEsIDAuMjUsIDFdOwogICAgICBjYXNlICJlYXNlLWluIjoKICAgICAgICByZXR1cm4gWzAuNDIsIDAsIDEsIDFdOwogICAgICBjYXNlICJlYXNlLW91dCI6CiAgICAgICAgcmV0dXJuIFswLjQyLCAwLCAwLjU4LCAxXTsKICAgICAgY2FzZSAiZWFzZS1pbi1vdXQiOgogICAgICAgIHJldHVybiBbMCwgMCwgMC41OCwgMV07CiAgICAgIGRlZmF1bHQ6IHsKICAgICAgICB2YXIgX2Vhc2luZyQ7CiAgICAgICAgdmFyIGVhc2luZyA9IGFyZ3NbMF0uc3BsaXQoIigiKTsKICAgICAgICBpZiAoZWFzaW5nWzBdID09PSAiY3ViaWMtYmV6aWVyIiAmJiAoKF9lYXNpbmckID0gZWFzaW5nWzFdKSA9PT0gbnVsbCB8fCBfZWFzaW5nJCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Vhc2luZyQuc3BsaXQoIikiKVswXS5zcGxpdCgiLCIpLmxlbmd0aCkgPT09IDQpIHsKICAgICAgICAgIHZhciBjb29yZHMgPSBlYXNpbmdbMV0uc3BsaXQoIikiKVswXS5zcGxpdCgiLCIpLm1hcCgoeDIpID0+IHBhcnNlRmxvYXQoeDIpKTsKICAgICAgICAgIHJldHVybiBbY29vcmRzWzBdLCBjb29yZHNbMV0sIGNvb3Jkc1syXSwgY29vcmRzWzNdXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CiAgaWYgKGFyZ3MubGVuZ3RoID09PSA0KSB7CiAgICByZXR1cm4gYXJnczsKICB9CiAgcmV0dXJuIFswLCAwLCAxLCAxXTsKfTsKdmFyIGNyZWF0ZUJlemllckVhc2luZyA9ICh4MSwgeTEsIHgyLCB5MikgPT4gewogIHZhciBjdXJ2ZVggPSBjdWJpY0Jlemllcih4MSwgeDIpOwogIHZhciBjdXJ2ZVkgPSBjdWJpY0Jlemllcih5MSwgeTIpOwogIHZhciBkZXJDdXJ2ZVggPSBkZXJpdmF0aXZlQ3ViaWNCZXppZXIoeDEsIHgyKTsKICB2YXIgcmFuZ2VWYWx1ZSA9ICh2YWx1ZSkgPT4gewogICAgaWYgKHZhbHVlID4gMSkgewogICAgICByZXR1cm4gMTsKICAgIH0KICAgIGlmICh2YWx1ZSA8IDApIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKICB2YXIgYmV6aWVyID0gKF90KSA9PiB7CiAgICB2YXIgdCA9IF90ID4gMSA/IDEgOiBfdDsKICAgIHZhciB4MyA9IHQ7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IDg7ICsraSkgewogICAgICB2YXIgZXZhbFQgPSBjdXJ2ZVgoeDMpIC0gdDsKICAgICAgdmFyIGRlclZhbCA9IGRlckN1cnZlWCh4Myk7CiAgICAgIGlmIChNYXRoLmFicyhldmFsVCAtIHQpIDwgQUNDVVJBQ1kgfHwgZGVyVmFsIDwgQUNDVVJBQ1kpIHsKICAgICAgICByZXR1cm4gY3VydmVZKHgzKTsKICAgICAgfQogICAgICB4MyA9IHJhbmdlVmFsdWUoeDMgLSBldmFsVCAvIGRlclZhbCk7CiAgICB9CiAgICByZXR1cm4gY3VydmVZKHgzKTsKICB9OwogIGJlemllci5pc1N0ZXBwZXIgPSBmYWxzZTsKICByZXR1cm4gYmV6aWVyOwp9Owp2YXIgY29uZmlnQmV6aWVyID0gZnVuY3Rpb24gY29uZmlnQmV6aWVyMigpIHsKICByZXR1cm4gY3JlYXRlQmV6aWVyRWFzaW5nKC4uLmdldEJlemllckNvb3JkaW5hdGVzKC4uLmFyZ3VtZW50cykpOwp9Owp2YXIgY29uZmlnU3ByaW5nID0gZnVuY3Rpb24gY29uZmlnU3ByaW5nMigpIHsKICB2YXIgY29uZmlnID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMF0gOiB7fTsKICB2YXIgewogICAgc3RpZmYgPSAxMDAsCiAgICBkYW1waW5nID0gOCwKICAgIGR0ID0gMTcKICB9ID0gY29uZmlnOwogIHZhciBzdGVwcGVyID0gKGN1cnJYLCBkZXN0WCwgY3VyclYpID0+IHsKICAgIHZhciBGU3ByaW5nID0gLShjdXJyWCAtIGRlc3RYKSAqIHN0aWZmOwogICAgdmFyIEZEYW1waW5nID0gY3VyclYgKiBkYW1waW5nOwogICAgdmFyIG5ld1YgPSBjdXJyViArIChGU3ByaW5nIC0gRkRhbXBpbmcpICogZHQgLyAxZTM7CiAgICB2YXIgbmV3WCA9IGN1cnJWICogZHQgLyAxZTMgKyBjdXJyWDsKICAgIGlmIChNYXRoLmFicyhuZXdYIC0gZGVzdFgpIDwgQUNDVVJBQ1kgJiYgTWF0aC5hYnMobmV3VikgPCBBQ0NVUkFDWSkgewogICAgICByZXR1cm4gW2Rlc3RYLCAwXTsKICAgIH0KICAgIHJldHVybiBbbmV3WCwgbmV3Vl07CiAgfTsKICBzdGVwcGVyLmlzU3RlcHBlciA9IHRydWU7CiAgc3RlcHBlci5kdCA9IGR0OwogIHJldHVybiBzdGVwcGVyOwp9Owp2YXIgY29uZmlnRWFzaW5nID0gKGVhc2luZykgPT4gewogIGlmICh0eXBlb2YgZWFzaW5nID09PSAic3RyaW5nIikgewogICAgc3dpdGNoIChlYXNpbmcpIHsKICAgICAgY2FzZSAiZWFzZSI6CiAgICAgIGNhc2UgImVhc2UtaW4tb3V0IjoKICAgICAgY2FzZSAiZWFzZS1vdXQiOgogICAgICBjYXNlICJlYXNlLWluIjoKICAgICAgY2FzZSAibGluZWFyIjoKICAgICAgICByZXR1cm4gY29uZmlnQmV6aWVyKGVhc2luZyk7CiAgICAgIGNhc2UgInNwcmluZyI6CiAgICAgICAgcmV0dXJuIGNvbmZpZ1NwcmluZygpOwogICAgICBkZWZhdWx0OgogICAgICAgIGlmIChlYXNpbmcuc3BsaXQoIigiKVswXSA9PT0gImN1YmljLWJlemllciIpIHsKICAgICAgICAgIHJldHVybiBjb25maWdCZXppZXIoZWFzaW5nKTsKICAgICAgICB9CiAgICB9CiAgfQogIGlmICh0eXBlb2YgZWFzaW5nID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gZWFzaW5nOwogIH0KICByZXR1cm4gbnVsbDsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi91c2VBbmltYXRpb25NYW5hZ2VyLmpzCnZhciBpbXBvcnRfcmVhY3QxNSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi9BbmltYXRpb25NYW5hZ2VyLmpzCmZ1bmN0aW9uIGNyZWF0ZUFuaW1hdGVNYW5hZ2VyKHRpbWVvdXRDb250cm9sbGVyKSB7CiAgdmFyIGN1cnJTdHlsZTsKICB2YXIgaGFuZGxlQ2hhbmdlID0gKCkgPT4gbnVsbDsKICB2YXIgc2hvdWxkU3RvcCA9IGZhbHNlOwogIHZhciBjYW5jZWxUaW1lb3V0ID0gbnVsbDsKICB2YXIgc2V0U3R5bGUgPSAoX3N0eWxlKSA9PiB7CiAgICBpZiAoc2hvdWxkU3RvcCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoQXJyYXkuaXNBcnJheShfc3R5bGUpKSB7CiAgICAgIGlmICghX3N0eWxlLmxlbmd0aCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgc3R5bGVzID0gX3N0eWxlOwogICAgICB2YXIgW2N1cnIsIC4uLnJlc3RTdHlsZXNdID0gc3R5bGVzOwogICAgICBpZiAodHlwZW9mIGN1cnIgPT09ICJudW1iZXIiKSB7CiAgICAgICAgY2FuY2VsVGltZW91dCA9IHRpbWVvdXRDb250cm9sbGVyLnNldFRpbWVvdXQoc2V0U3R5bGUuYmluZChudWxsLCByZXN0U3R5bGVzKSwgY3Vycik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHNldFN0eWxlKGN1cnIpOwogICAgICBjYW5jZWxUaW1lb3V0ID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dChzZXRTdHlsZS5iaW5kKG51bGwsIHJlc3RTdHlsZXMpKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHR5cGVvZiBfc3R5bGUgPT09ICJzdHJpbmciKSB7CiAgICAgIGN1cnJTdHlsZSA9IF9zdHlsZTsKICAgICAgaGFuZGxlQ2hhbmdlKGN1cnJTdHlsZSk7CiAgICB9CiAgICBpZiAodHlwZW9mIF9zdHlsZSA9PT0gIm9iamVjdCIpIHsKICAgICAgY3VyclN0eWxlID0gX3N0eWxlOwogICAgICBoYW5kbGVDaGFuZ2UoY3VyclN0eWxlKTsKICAgIH0KICAgIGlmICh0eXBlb2YgX3N0eWxlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIF9zdHlsZSgpOwogICAgfQogIH07CiAgcmV0dXJuIHsKICAgIHN0b3A6ICgpID0+IHsKICAgICAgc2hvdWxkU3RvcCA9IHRydWU7CiAgICB9LAogICAgc3RhcnQ6IChzdHlsZSkgPT4gewogICAgICBzaG91bGRTdG9wID0gZmFsc2U7CiAgICAgIGlmIChjYW5jZWxUaW1lb3V0KSB7CiAgICAgICAgY2FuY2VsVGltZW91dCgpOwogICAgICAgIGNhbmNlbFRpbWVvdXQgPSBudWxsOwogICAgICB9CiAgICAgIHNldFN0eWxlKHN0eWxlKTsKICAgIH0sCiAgICBzdWJzY3JpYmU6IChfaGFuZGxlQ2hhbmdlKSA9PiB7CiAgICAgIGhhbmRsZUNoYW5nZSA9IF9oYW5kbGVDaGFuZ2U7CiAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgaGFuZGxlQ2hhbmdlID0gKCkgPT4gbnVsbDsKICAgICAgfTsKICAgIH0sCiAgICBnZXRUaW1lb3V0Q29udHJvbGxlcjogKCkgPT4gdGltZW91dENvbnRyb2xsZXIKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vdGltZW91dENvbnRyb2xsZXIuanMKdmFyIFJlcXVlc3RBbmltYXRpb25GcmFtZVRpbWVvdXRDb250cm9sbGVyID0gY2xhc3MgewogIHNldFRpbWVvdXQoY2FsbGJhY2spIHsKICAgIHZhciBkZWxheSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDogMDsKICAgIHZhciBzdGFydFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTsKICAgIHZhciByZXF1ZXN0SWQgPSBudWxsOwogICAgdmFyIGV4ZWN1dGVDYWxsYmFjayA9IChub3cpID0+IHsKICAgICAgaWYgKG5vdyAtIHN0YXJ0VGltZSA+PSBkZWxheSkgewogICAgICAgIGNhbGxiYWNrKG5vdyk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlcXVlc3RBbmltYXRpb25GcmFtZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHJlcXVlc3RJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShleGVjdXRlQ2FsbGJhY2spOwogICAgICB9CiAgICB9OwogICAgcmVxdWVzdElkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGV4ZWN1dGVDYWxsYmFjayk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAocmVxdWVzdElkICE9IG51bGwpIHsKICAgICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShyZXF1ZXN0SWQpOwogICAgICB9CiAgICB9OwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi9jcmVhdGVEZWZhdWx0QW5pbWF0aW9uTWFuYWdlci5qcwpmdW5jdGlvbiBjcmVhdGVEZWZhdWx0QW5pbWF0aW9uTWFuYWdlcigpIHsKICByZXR1cm4gY3JlYXRlQW5pbWF0ZU1hbmFnZXIobmV3IFJlcXVlc3RBbmltYXRpb25GcmFtZVRpbWVvdXRDb250cm9sbGVyKCkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vdXNlQW5pbWF0aW9uTWFuYWdlci5qcwp2YXIgQW5pbWF0aW9uTWFuYWdlckNvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDE1LmNyZWF0ZUNvbnRleHQpKGNyZWF0ZURlZmF1bHRBbmltYXRpb25NYW5hZ2VyKTsKZnVuY3Rpb24gdXNlQW5pbWF0aW9uTWFuYWdlcihhbmltYXRpb25JZCwgYW5pbWF0aW9uTWFuYWdlckZyb21Qcm9wcykgewogIHZhciBjb250ZXh0QW5pbWF0aW9uTWFuYWdlciA9ICgwLCBpbXBvcnRfcmVhY3QxNS51c2VDb250ZXh0KShBbmltYXRpb25NYW5hZ2VyQ29udGV4dCk7CiAgcmV0dXJuICgwLCBpbXBvcnRfcmVhY3QxNS51c2VNZW1vKSgoKSA9PiBhbmltYXRpb25NYW5hZ2VyRnJvbVByb3BzICE9PSBudWxsICYmIGFuaW1hdGlvbk1hbmFnZXJGcm9tUHJvcHMgIT09IHZvaWQgMCA/IGFuaW1hdGlvbk1hbmFnZXJGcm9tUHJvcHMgOiBjb250ZXh0QW5pbWF0aW9uTWFuYWdlcihhbmltYXRpb25JZCksIFthbmltYXRpb25JZCwgYW5pbWF0aW9uTWFuYWdlckZyb21Qcm9wcywgY29udGV4dEFuaW1hdGlvbk1hbmFnZXJdKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9HbG9iYWwuanMKdmFyIHBhcnNlSXNTc3JCeURlZmF1bHQgPSAoKSA9PiAhKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5kb2N1bWVudCAmJiBCb29sZWFuKHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KSAmJiB3aW5kb3cuc2V0VGltZW91dCk7CnZhciBHbG9iYWwgPSB7CiAgZGV2VG9vbHNFbmFibGVkOiBmYWxzZSwKICBpc1NzcjogcGFyc2VJc1NzckJ5RGVmYXVsdCgpCn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vSmF2YXNjcmlwdEFuaW1hdGUuanMKdmFyIGRlZmF1bHRKYXZhc2NyaXB0QW5pbWF0ZVByb3BzID0gewogIGJlZ2luOiAwLAogIGR1cmF0aW9uOiAxZTMsCiAgZWFzaW5nOiAiZWFzZSIsCiAgaXNBY3RpdmU6IHRydWUsCiAgY2FuQmVnaW46IHRydWUsCiAgb25BbmltYXRpb25FbmQ6ICgpID0+IHsKICB9LAogIG9uQW5pbWF0aW9uU3RhcnQ6ICgpID0+IHsKICB9Cn07CnZhciBmcm9tID0gewogIHQ6IDAKfTsKdmFyIHRvID0gewogIHQ6IDEKfTsKZnVuY3Rpb24gSmF2YXNjcmlwdEFuaW1hdGUob3V0c2lkZVByb3BzKSB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIGRlZmF1bHRKYXZhc2NyaXB0QW5pbWF0ZVByb3BzKTsKICB2YXIgewogICAgaXNBY3RpdmU6IGlzQWN0aXZlUHJvcCwKICAgIGNhbkJlZ2luLAogICAgZHVyYXRpb24sCiAgICBlYXNpbmcsCiAgICBiZWdpbiwKICAgIG9uQW5pbWF0aW9uRW5kLAogICAgb25BbmltYXRpb25TdGFydCwKICAgIGNoaWxkcmVuCiAgfSA9IHByb3BzOwogIHZhciBpc0FjdGl2ZSA9IGlzQWN0aXZlUHJvcCA9PT0gImF1dG8iID8gIUdsb2JhbC5pc1NzciA6IGlzQWN0aXZlUHJvcDsKICB2YXIgYW5pbWF0aW9uTWFuYWdlciA9IHVzZUFuaW1hdGlvbk1hbmFnZXIocHJvcHMuYW5pbWF0aW9uSWQsIHByb3BzLmFuaW1hdGlvbk1hbmFnZXIpOwogIHZhciBbc3R5bGUsIHNldFN0eWxlXSA9ICgwLCBpbXBvcnRfcmVhY3QxNi51c2VTdGF0ZSkoaXNBY3RpdmUgPyBmcm9tIDogdG8pOwogIHZhciBzdG9wSlNBbmltYXRpb24gPSAoMCwgaW1wb3J0X3JlYWN0MTYudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0MTYudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoIWlzQWN0aXZlKSB7CiAgICAgIHNldFN0eWxlKHRvKTsKICAgIH0KICB9LCBbaXNBY3RpdmVdKTsKICAoMCwgaW1wb3J0X3JlYWN0MTYudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoIWlzQWN0aXZlIHx8ICFjYW5CZWdpbikgewogICAgICByZXR1cm4gbm9vcDsKICAgIH0KICAgIHZhciBzdGFydEFuaW1hdGlvbiA9IGNvbmZpZ1VwZGF0ZV9kZWZhdWx0KGZyb20sIHRvLCBjb25maWdFYXNpbmcoZWFzaW5nKSwgZHVyYXRpb24sIHNldFN0eWxlLCBhbmltYXRpb25NYW5hZ2VyLmdldFRpbWVvdXRDb250cm9sbGVyKCkpOwogICAgdmFyIG9uQW5pbWF0aW9uQWN0aXZlID0gKCkgPT4gewogICAgICBzdG9wSlNBbmltYXRpb24uY3VycmVudCA9IHN0YXJ0QW5pbWF0aW9uKCk7CiAgICB9OwogICAgYW5pbWF0aW9uTWFuYWdlci5zdGFydChbb25BbmltYXRpb25TdGFydCwgYmVnaW4sIG9uQW5pbWF0aW9uQWN0aXZlLCBkdXJhdGlvbiwgb25BbmltYXRpb25FbmRdKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGFuaW1hdGlvbk1hbmFnZXIuc3RvcCgpOwogICAgICBpZiAoc3RvcEpTQW5pbWF0aW9uLmN1cnJlbnQpIHsKICAgICAgICBzdG9wSlNBbmltYXRpb24uY3VycmVudCgpOwogICAgICB9CiAgICAgIG9uQW5pbWF0aW9uRW5kKCk7CiAgICB9OwogIH0sIFtpc0FjdGl2ZSwgY2FuQmVnaW4sIGR1cmF0aW9uLCBlYXNpbmcsIGJlZ2luLCBvbkFuaW1hdGlvblN0YXJ0LCBvbkFuaW1hdGlvbkVuZCwgYW5pbWF0aW9uTWFuYWdlcl0pOwogIHJldHVybiBjaGlsZHJlbihzdHlsZS50KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VBbmltYXRpb25JZC5qcwp2YXIgaW1wb3J0X3JlYWN0MTcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIHVzZUFuaW1hdGlvbklkKGlucHV0KSB7CiAgdmFyIHByZWZpeCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDogImFuaW1hdGlvbi0iOwogIHZhciBhbmltYXRpb25JZCA9ICgwLCBpbXBvcnRfcmVhY3QxNy51c2VSZWYpKHVuaXF1ZUlkKHByZWZpeCkpOwogIHZhciBwcmV2UHJvcHMgPSAoMCwgaW1wb3J0X3JlYWN0MTcudXNlUmVmKShpbnB1dCk7CiAgaWYgKHByZXZQcm9wcy5jdXJyZW50ICE9PSBpbnB1dCkgewogICAgYW5pbWF0aW9uSWQuY3VycmVudCA9IHVuaXF1ZUlkKHByZWZpeCk7CiAgICBwcmV2UHJvcHMuY3VycmVudCA9IGlucHV0OwogIH0KICByZXR1cm4gYW5pbWF0aW9uSWQuY3VycmVudDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvUmVjdGFuZ2xlLmpzCnZhciBfZXhjbHVkZWQ0ID0gWyJyYWRpdXMiXTsKdmFyIF9leGNsdWRlZDIyID0gWyJyYWRpdXMiXTsKZnVuY3Rpb24gb3duS2V5czExKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTEoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxMShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTEoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTEoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTExKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTEocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTEodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTEodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTEodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9leHRlbmRzNygpIHsKICByZXR1cm4gX2V4dGVuZHM3ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHM3LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNChlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNChlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNChyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIGdldFJlY3RhbmdsZVBhdGggPSAoeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCByYWRpdXMpID0+IHsKICB2YXIgbWF4UmFkaXVzID0gTWF0aC5taW4oTWF0aC5hYnMod2lkdGgpIC8gMiwgTWF0aC5hYnMoaGVpZ2h0KSAvIDIpOwogIHZhciB5U2lnbiA9IGhlaWdodCA+PSAwID8gMSA6IC0xOwogIHZhciB4U2lnbiA9IHdpZHRoID49IDAgPyAxIDogLTE7CiAgdmFyIGNsb2NrV2lzZSA9IGhlaWdodCA+PSAwICYmIHdpZHRoID49IDAgfHwgaGVpZ2h0IDwgMCAmJiB3aWR0aCA8IDAgPyAxIDogMDsKICB2YXIgcGF0aDI7CiAgaWYgKG1heFJhZGl1cyA+IDAgJiYgcmFkaXVzIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgIHZhciBuZXdSYWRpdXMgPSBbMCwgMCwgMCwgMF07CiAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gNDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIG5ld1JhZGl1c1tpXSA9IHJhZGl1c1tpXSA+IG1heFJhZGl1cyA/IG1heFJhZGl1cyA6IHJhZGl1c1tpXTsKICAgIH0KICAgIHBhdGgyID0gIk0iLmNvbmNhdCh4MiwgIiwiKS5jb25jYXQoeTIgKyB5U2lnbiAqIG5ld1JhZGl1c1swXSk7CiAgICBpZiAobmV3UmFkaXVzWzBdID4gMCkgewogICAgICBwYXRoMiArPSAiQSAiLmNvbmNhdChuZXdSYWRpdXNbMF0sICIsIikuY29uY2F0KG5ld1JhZGl1c1swXSwgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIiwiKS5jb25jYXQoeDIgKyB4U2lnbiAqIG5ld1JhZGl1c1swXSwgIiwiKS5jb25jYXQoeTIpOwogICAgfQogICAgcGF0aDIgKz0gIkwgIi5jb25jYXQoeDIgKyB3aWR0aCAtIHhTaWduICogbmV3UmFkaXVzWzFdLCAiLCIpLmNvbmNhdCh5Mik7CiAgICBpZiAobmV3UmFkaXVzWzFdID4gMCkgewogICAgICBwYXRoMiArPSAiQSAiLmNvbmNhdChuZXdSYWRpdXNbMV0sICIsIikuY29uY2F0KG5ld1JhZGl1c1sxXSwgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIixcbiAgICAgICAgIikuY29uY2F0KHgyICsgd2lkdGgsICIsIikuY29uY2F0KHkyICsgeVNpZ24gKiBuZXdSYWRpdXNbMV0pOwogICAgfQogICAgcGF0aDIgKz0gIkwgIi5jb25jYXQoeDIgKyB3aWR0aCwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQgLSB5U2lnbiAqIG5ld1JhZGl1c1syXSk7CiAgICBpZiAobmV3UmFkaXVzWzJdID4gMCkgewogICAgICBwYXRoMiArPSAiQSAiLmNvbmNhdChuZXdSYWRpdXNbMl0sICIsIikuY29uY2F0KG5ld1JhZGl1c1syXSwgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIixcbiAgICAgICAgIikuY29uY2F0KHgyICsgd2lkdGggLSB4U2lnbiAqIG5ld1JhZGl1c1syXSwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQpOwogICAgfQogICAgcGF0aDIgKz0gIkwgIi5jb25jYXQoeDIgKyB4U2lnbiAqIG5ld1JhZGl1c1szXSwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQpOwogICAgaWYgKG5ld1JhZGl1c1szXSA+IDApIHsKICAgICAgcGF0aDIgKz0gIkEgIi5jb25jYXQobmV3UmFkaXVzWzNdLCAiLCIpLmNvbmNhdChuZXdSYWRpdXNbM10sICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsXG4gICAgICAgICIpLmNvbmNhdCh4MiwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQgLSB5U2lnbiAqIG5ld1JhZGl1c1szXSk7CiAgICB9CiAgICBwYXRoMiArPSAiWiI7CiAgfSBlbHNlIGlmIChtYXhSYWRpdXMgPiAwICYmIHJhZGl1cyA9PT0gK3JhZGl1cyAmJiByYWRpdXMgPiAwKSB7CiAgICB2YXIgX25ld1JhZGl1cyA9IE1hdGgubWluKG1heFJhZGl1cywgcmFkaXVzKTsKICAgIHBhdGgyID0gIk0gIi5jb25jYXQoeDIsICIsIikuY29uY2F0KHkyICsgeVNpZ24gKiBfbmV3UmFkaXVzLCAiXG4gICAgICAgICAgICBBICIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLCIpLmNvbmNhdCh4MiArIHhTaWduICogX25ld1JhZGl1cywgIiwiKS5jb25jYXQoeTIsICJcbiAgICAgICAgICAgIEwgIikuY29uY2F0KHgyICsgd2lkdGggLSB4U2lnbiAqIF9uZXdSYWRpdXMsICIsIikuY29uY2F0KHkyLCAiXG4gICAgICAgICAgICBBICIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLCIpLmNvbmNhdCh4MiArIHdpZHRoLCAiLCIpLmNvbmNhdCh5MiArIHlTaWduICogX25ld1JhZGl1cywgIlxuICAgICAgICAgICAgTCAiKS5jb25jYXQoeDIgKyB3aWR0aCwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQgLSB5U2lnbiAqIF9uZXdSYWRpdXMsICJcbiAgICAgICAgICAgIEEgIikuY29uY2F0KF9uZXdSYWRpdXMsICIsIikuY29uY2F0KF9uZXdSYWRpdXMsICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsIikuY29uY2F0KHgyICsgd2lkdGggLSB4U2lnbiAqIF9uZXdSYWRpdXMsICIsIikuY29uY2F0KHkyICsgaGVpZ2h0LCAiXG4gICAgICAgICAgICBMICIpLmNvbmNhdCh4MiArIHhTaWduICogX25ld1JhZGl1cywgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQsICJcbiAgICAgICAgICAgIEEgIikuY29uY2F0KF9uZXdSYWRpdXMsICIsIikuY29uY2F0KF9uZXdSYWRpdXMsICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsIikuY29uY2F0KHgyLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCAtIHlTaWduICogX25ld1JhZGl1cywgIiBaIik7CiAgfSBlbHNlIHsKICAgIHBhdGgyID0gIk0gIi5jb25jYXQoeDIsICIsIikuY29uY2F0KHkyLCAiIGggIikuY29uY2F0KHdpZHRoLCAiIHYgIikuY29uY2F0KGhlaWdodCwgIiBoICIpLmNvbmNhdCgtd2lkdGgsICIgWiIpOwogIH0KICByZXR1cm4gcGF0aDI7Cn07CnZhciBkZWZhdWx0UmVjdGFuZ2xlUHJvcHMgPSB7CiAgeDogMCwKICB5OiAwLAogIHdpZHRoOiAwLAogIGhlaWdodDogMCwKICAvLyBUaGUgcmFkaXVzIG9mIGJvcmRlcgogIC8vIFRoZSByYWRpdXMgb2YgZm91ciBjb3JuZXJzIHdoZW4gcmFkaXVzIGlzIGEgbnVtYmVyCiAgLy8gVGhlIHJhZGl1cyBvZiBsZWZ0LXRvcCwgcmlnaHQtdG9wLCByaWdodC1ib3R0b20sIGxlZnQtYm90dG9tIHdoZW4gcmFkaXVzIGlzIGFuIGFycmF5CiAgcmFkaXVzOiAwLAogIGlzQW5pbWF0aW9uQWN0aXZlOiBmYWxzZSwKICBpc1VwZGF0ZUFuaW1hdGlvbkFjdGl2ZTogZmFsc2UsCiAgYW5pbWF0aW9uQmVnaW46IDAsCiAgYW5pbWF0aW9uRHVyYXRpb246IDE1MDAsCiAgYW5pbWF0aW9uRWFzaW5nOiAiZWFzZSIKfTsKdmFyIFJlY3RhbmdsZSA9IChyZWN0YW5nbGVQcm9wcykgPT4gewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMocmVjdGFuZ2xlUHJvcHMsIGRlZmF1bHRSZWN0YW5nbGVQcm9wcyk7CiAgdmFyIHBhdGhSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlUmVmKShudWxsKTsKICB2YXIgW3RvdGFsTGVuZ3RoLCBzZXRUb3RhbExlbmd0aF0gPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlU3RhdGUpKC0xKTsKICAoMCwgaW1wb3J0X3JlYWN0MTgudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocGF0aFJlZi5jdXJyZW50ICYmIHBhdGhSZWYuY3VycmVudC5nZXRUb3RhbExlbmd0aCkgewogICAgICB0cnkgewogICAgICAgIHZhciBwYXRoVG90YWxMZW5ndGggPSBwYXRoUmVmLmN1cnJlbnQuZ2V0VG90YWxMZW5ndGgoKTsKICAgICAgICBpZiAocGF0aFRvdGFsTGVuZ3RoKSB7CiAgICAgICAgICBzZXRUb3RhbExlbmd0aChwYXRoVG90YWxMZW5ndGgpOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoX3VudXNlZCkgewogICAgICB9CiAgICB9CiAgfSwgW10pOwogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByYWRpdXMsCiAgICBjbGFzc05hbWUKICB9ID0gcHJvcHM7CiAgdmFyIHsKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIGFuaW1hdGlvbkR1cmF0aW9uLAogICAgYW5pbWF0aW9uQmVnaW4sCiAgICBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgIGlzVXBkYXRlQW5pbWF0aW9uQWN0aXZlCiAgfSA9IHByb3BzOwogIHZhciBwcmV2V2lkdGhSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlUmVmKSh3aWR0aCk7CiAgdmFyIHByZXZIZWlnaHRSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlUmVmKShoZWlnaHQpOwogIHZhciBwcmV2WFJlZiA9ICgwLCBpbXBvcnRfcmVhY3QxOC51c2VSZWYpKHgyKTsKICB2YXIgcHJldllSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlUmVmKSh5Mik7CiAgdmFyIGFuaW1hdGlvbklkSW5wdXQgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlTWVtbykoKCkgPT4gKHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHJhZGl1cwogIH0pLCBbeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCByYWRpdXNdKTsKICB2YXIgYW5pbWF0aW9uSWQgPSB1c2VBbmltYXRpb25JZChhbmltYXRpb25JZElucHV0LCAicmVjdGFuZ2xlLSIpOwogIGlmICh4MiAhPT0gK3gyIHx8IHkyICE9PSAreTIgfHwgd2lkdGggIT09ICt3aWR0aCB8fCBoZWlnaHQgIT09ICtoZWlnaHQgfHwgd2lkdGggPT09IDAgfHwgaGVpZ2h0ID09PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGxheWVyQ2xhc3MgPSBjbHN4KCJyZWNoYXJ0cy1yZWN0YW5nbGUiLCBjbGFzc05hbWUpOwogIGlmICghaXNVcGRhdGVBbmltYXRpb25BY3RpdmUpIHsKICAgIHZhciBfc3ZnUHJvcGVydGllc0FuZEV2ZW4gPSBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzKSwgewogICAgICByYWRpdXM6IF8KICAgIH0gPSBfc3ZnUHJvcGVydGllc0FuZEV2ZW4sIG90aGVyUGF0aFByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNChfc3ZnUHJvcGVydGllc0FuZEV2ZW4sIF9leGNsdWRlZDQpOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDkuY3JlYXRlRWxlbWVudCgicGF0aCIsIF9leHRlbmRzNyh7fSwgb3RoZXJQYXRoUHJvcHMsIHsKICAgICAgcmFkaXVzOiB0eXBlb2YgcmFkaXVzID09PSAibnVtYmVyIiA/IHJhZGl1cyA6IHZvaWQgMCwKICAgICAgY2xhc3NOYW1lOiBsYXllckNsYXNzLAogICAgICBkOiBnZXRSZWN0YW5nbGVQYXRoKHgyLCB5Miwgd2lkdGgsIGhlaWdodCwgcmFkaXVzKQogICAgfSkpOwogIH0KICB2YXIgcHJldldpZHRoID0gcHJldldpZHRoUmVmLmN1cnJlbnQ7CiAgdmFyIHByZXZIZWlnaHQgPSBwcmV2SGVpZ2h0UmVmLmN1cnJlbnQ7CiAgdmFyIHByZXZYID0gcHJldlhSZWYuY3VycmVudDsKICB2YXIgcHJldlkgPSBwcmV2WVJlZi5jdXJyZW50OwogIHZhciBmcm9tMiA9ICIwcHggIi5jb25jYXQodG90YWxMZW5ndGggPT09IC0xID8gMSA6IHRvdGFsTGVuZ3RoLCAicHgiKTsKICB2YXIgdG8yID0gIiIuY29uY2F0KHRvdGFsTGVuZ3RoLCAicHggMHB4Iik7CiAgdmFyIHRyYW5zaXRpb24gPSBnZXRUcmFuc2l0aW9uVmFsKFsic3Ryb2tlRGFzaGFycmF5Il0sIGFuaW1hdGlvbkR1cmF0aW9uLCB0eXBlb2YgYW5pbWF0aW9uRWFzaW5nID09PSAic3RyaW5nIiA/IGFuaW1hdGlvbkVhc2luZyA6IGRlZmF1bHRSZWN0YW5nbGVQcm9wcy5hbmltYXRpb25FYXNpbmcpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q5LmNyZWF0ZUVsZW1lbnQoSmF2YXNjcmlwdEFuaW1hdGUsIHsKICAgIGFuaW1hdGlvbklkLAogICAga2V5OiBhbmltYXRpb25JZCwKICAgIGNhbkJlZ2luOiB0b3RhbExlbmd0aCA+IDAsCiAgICBkdXJhdGlvbjogYW5pbWF0aW9uRHVyYXRpb24sCiAgICBlYXNpbmc6IGFuaW1hdGlvbkVhc2luZywKICAgIGlzQWN0aXZlOiBpc1VwZGF0ZUFuaW1hdGlvbkFjdGl2ZSwKICAgIGJlZ2luOiBhbmltYXRpb25CZWdpbgogIH0sICh0KSA9PiB7CiAgICB2YXIgY3VycldpZHRoID0gaW50ZXJwb2xhdGUocHJldldpZHRoLCB3aWR0aCwgdCk7CiAgICB2YXIgY3VyckhlaWdodCA9IGludGVycG9sYXRlKHByZXZIZWlnaHQsIGhlaWdodCwgdCk7CiAgICB2YXIgY3VyclggPSBpbnRlcnBvbGF0ZShwcmV2WCwgeDIsIHQpOwogICAgdmFyIGN1cnJZID0gaW50ZXJwb2xhdGUocHJldlksIHkyLCB0KTsKICAgIGlmIChwYXRoUmVmLmN1cnJlbnQpIHsKICAgICAgcHJldldpZHRoUmVmLmN1cnJlbnQgPSBjdXJyV2lkdGg7CiAgICAgIHByZXZIZWlnaHRSZWYuY3VycmVudCA9IGN1cnJIZWlnaHQ7CiAgICAgIHByZXZYUmVmLmN1cnJlbnQgPSBjdXJyWDsKICAgICAgcHJldllSZWYuY3VycmVudCA9IGN1cnJZOwogICAgfQogICAgdmFyIGFuaW1hdGlvblN0eWxlOwogICAgaWYgKCFpc0FuaW1hdGlvbkFjdGl2ZSkgewogICAgICBhbmltYXRpb25TdHlsZSA9IHsKICAgICAgICBzdHJva2VEYXNoYXJyYXk6IHRvMgogICAgICB9OwogICAgfSBlbHNlIGlmICh0ID4gMCkgewogICAgICBhbmltYXRpb25TdHlsZSA9IHsKICAgICAgICB0cmFuc2l0aW9uLAogICAgICAgIHN0cm9rZURhc2hhcnJheTogdG8yCiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBhbmltYXRpb25TdHlsZSA9IHsKICAgICAgICBzdHJva2VEYXNoYXJyYXk6IGZyb20yCiAgICAgIH07CiAgICB9CiAgICB2YXIgX3N2Z1Byb3BlcnRpZXNBbmRFdmVuMiA9IHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMocHJvcHMpLCB7CiAgICAgIHJhZGl1czogXzIKICAgIH0gPSBfc3ZnUHJvcGVydGllc0FuZEV2ZW4yLCBvdGhlclBhdGhQcm9wczIgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM0KF9zdmdQcm9wZXJ0aWVzQW5kRXZlbjIsIF9leGNsdWRlZDIyKTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q5LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCBfZXh0ZW5kczcoe30sIG90aGVyUGF0aFByb3BzMiwgewogICAgICByYWRpdXM6IHR5cGVvZiByYWRpdXMgPT09ICJudW1iZXIiID8gcmFkaXVzIDogdm9pZCAwLAogICAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MsCiAgICAgIGQ6IGdldFJlY3RhbmdsZVBhdGgoY3VyclgsIGN1cnJZLCBjdXJyV2lkdGgsIGN1cnJIZWlnaHQsIHJhZGl1cyksCiAgICAgIHJlZjogcGF0aFJlZiwKICAgICAgc3R5bGU6IF9vYmplY3RTcHJlYWQxMShfb2JqZWN0U3ByZWFkMTEoe30sIGFuaW1hdGlvblN0eWxlKSwgcHJvcHMuc3R5bGUpCiAgICB9KSk7CiAgfSk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL1BvbGFyVXRpbHMuanMKdmFyIGltcG9ydF9yZWFjdDE5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBvd25LZXlzMTIoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxMihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czEyKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxMihlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxMihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTIoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxMihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxMih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxMih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxMih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIFJBRElBTiA9IE1hdGguUEkgLyAxODA7CnZhciByYWRpYW5Ub0RlZ3JlZSA9IChhbmdsZUluUmFkaWFuKSA9PiBhbmdsZUluUmFkaWFuICogMTgwIC8gTWF0aC5QSTsKdmFyIHBvbGFyVG9DYXJ0ZXNpYW4gPSAoY3gsIGN5LCByYWRpdXMsIGFuZ2xlKSA9PiAoewogIHg6IGN4ICsgTWF0aC5jb3MoLVJBRElBTiAqIGFuZ2xlKSAqIHJhZGl1cywKICB5OiBjeSArIE1hdGguc2luKC1SQURJQU4gKiBhbmdsZSkgKiByYWRpdXMKfSk7CnZhciBnZXRNYXhSYWRpdXMgPSBmdW5jdGlvbiBnZXRNYXhSYWRpdXMyKHdpZHRoLCBoZWlnaHQpIHsKICB2YXIgb2Zmc2V0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiB7CiAgICB0b3A6IDAsCiAgICByaWdodDogMCwKICAgIGJvdHRvbTogMCwKICAgIGxlZnQ6IDAsCiAgICB3aWR0aDogMCwKICAgIGhlaWdodDogMCwKICAgIGJydXNoQm90dG9tOiAwCiAgfTsKICByZXR1cm4gTWF0aC5taW4oTWF0aC5hYnMod2lkdGggLSAob2Zmc2V0LmxlZnQgfHwgMCkgLSAob2Zmc2V0LnJpZ2h0IHx8IDApKSwgTWF0aC5hYnMoaGVpZ2h0IC0gKG9mZnNldC50b3AgfHwgMCkgLSAob2Zmc2V0LmJvdHRvbSB8fCAwKSkpIC8gMjsKfTsKdmFyIGRpc3RhbmNlQmV0d2VlblBvaW50cyA9IChwb2ludDQsIGFub3RoZXJQb2ludCkgPT4gewogIHZhciB7CiAgICB4OiB4MSwKICAgIHk6IHkxCiAgfSA9IHBvaW50NDsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MgogIH0gPSBhbm90aGVyUG9pbnQ7CiAgcmV0dXJuIE1hdGguc3FydCgoeDEgLSB4MikgKiogMiArICh5MSAtIHkyKSAqKiAyKTsKfTsKdmFyIGdldEFuZ2xlT2ZQb2ludCA9IChfcmVmMiwgX3JlZjIyKSA9PiB7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIKICB9ID0gX3JlZjI7CiAgdmFyIHsKICAgIGN4LAogICAgY3kKICB9ID0gX3JlZjIyOwogIHZhciByYWRpdXMgPSBkaXN0YW5jZUJldHdlZW5Qb2ludHMoewogICAgeDogeDIsCiAgICB5OiB5MgogIH0sIHsKICAgIHg6IGN4LAogICAgeTogY3kKICB9KTsKICBpZiAocmFkaXVzIDw9IDApIHsKICAgIHJldHVybiB7CiAgICAgIHJhZGl1cywKICAgICAgYW5nbGU6IDAKICAgIH07CiAgfQogIHZhciBjb3MgPSAoeDIgLSBjeCkgLyByYWRpdXM7CiAgdmFyIGFuZ2xlSW5SYWRpYW4gPSBNYXRoLmFjb3MoY29zKTsKICBpZiAoeTIgPiBjeSkgewogICAgYW5nbGVJblJhZGlhbiA9IDIgKiBNYXRoLlBJIC0gYW5nbGVJblJhZGlhbjsKICB9CiAgcmV0dXJuIHsKICAgIHJhZGl1cywKICAgIGFuZ2xlOiByYWRpYW5Ub0RlZ3JlZShhbmdsZUluUmFkaWFuKSwKICAgIGFuZ2xlSW5SYWRpYW4KICB9Owp9Owp2YXIgZm9ybWF0QW5nbGVPZlNlY3RvciA9IChfcmVmMykgPT4gewogIHZhciB7CiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gX3JlZjM7CiAgdmFyIHN0YXJ0Q250ID0gTWF0aC5mbG9vcihzdGFydEFuZ2xlIC8gMzYwKTsKICB2YXIgZW5kQ250ID0gTWF0aC5mbG9vcihlbmRBbmdsZSAvIDM2MCk7CiAgdmFyIG1pbjIgPSBNYXRoLm1pbihzdGFydENudCwgZW5kQ250KTsKICByZXR1cm4gewogICAgc3RhcnRBbmdsZTogc3RhcnRBbmdsZSAtIG1pbjIgKiAzNjAsCiAgICBlbmRBbmdsZTogZW5kQW5nbGUgLSBtaW4yICogMzYwCiAgfTsKfTsKdmFyIHJldmVyc2VGb3JtYXRBbmdsZU9mU2VjdG9yID0gKGFuZ2xlLCBfcmVmNCkgPT4gewogIHZhciB7CiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gX3JlZjQ7CiAgdmFyIHN0YXJ0Q250ID0gTWF0aC5mbG9vcihzdGFydEFuZ2xlIC8gMzYwKTsKICB2YXIgZW5kQ250ID0gTWF0aC5mbG9vcihlbmRBbmdsZSAvIDM2MCk7CiAgdmFyIG1pbjIgPSBNYXRoLm1pbihzdGFydENudCwgZW5kQ250KTsKICByZXR1cm4gYW5nbGUgKyBtaW4yICogMzYwOwp9Owp2YXIgaW5SYW5nZU9mU2VjdG9yID0gKF9yZWY1LCB2aWV3Qm94KSA9PiB7CiAgdmFyIHsKICAgIGNoYXJ0WDogeDIsCiAgICBjaGFydFk6IHkyCiAgfSA9IF9yZWY1OwogIHZhciB7CiAgICByYWRpdXMsCiAgICBhbmdsZQogIH0gPSBnZXRBbmdsZU9mUG9pbnQoewogICAgeDogeDIsCiAgICB5OiB5MgogIH0sIHZpZXdCb3gpOwogIHZhciB7CiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzCiAgfSA9IHZpZXdCb3g7CiAgaWYgKHJhZGl1cyA8IGlubmVyUmFkaXVzIHx8IHJhZGl1cyA+IG91dGVyUmFkaXVzKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKHJhZGl1cyA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gZm9ybWF0QW5nbGVPZlNlY3Rvcih2aWV3Qm94KTsKICB2YXIgZm9ybWF0QW5nbGUgPSBhbmdsZTsKICB2YXIgaW5SYW5nZTsKICBpZiAoc3RhcnRBbmdsZSA8PSBlbmRBbmdsZSkgewogICAgd2hpbGUgKGZvcm1hdEFuZ2xlID4gZW5kQW5nbGUpIHsKICAgICAgZm9ybWF0QW5nbGUgLT0gMzYwOwogICAgfQogICAgd2hpbGUgKGZvcm1hdEFuZ2xlIDwgc3RhcnRBbmdsZSkgewogICAgICBmb3JtYXRBbmdsZSArPSAzNjA7CiAgICB9CiAgICBpblJhbmdlID0gZm9ybWF0QW5nbGUgPj0gc3RhcnRBbmdsZSAmJiBmb3JtYXRBbmdsZSA8PSBlbmRBbmdsZTsKICB9IGVsc2UgewogICAgd2hpbGUgKGZvcm1hdEFuZ2xlID4gc3RhcnRBbmdsZSkgewogICAgICBmb3JtYXRBbmdsZSAtPSAzNjA7CiAgICB9CiAgICB3aGlsZSAoZm9ybWF0QW5nbGUgPCBlbmRBbmdsZSkgewogICAgICBmb3JtYXRBbmdsZSArPSAzNjA7CiAgICB9CiAgICBpblJhbmdlID0gZm9ybWF0QW5nbGUgPj0gZW5kQW5nbGUgJiYgZm9ybWF0QW5nbGUgPD0gc3RhcnRBbmdsZTsKICB9CiAgaWYgKGluUmFuZ2UpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTIoX29iamVjdFNwcmVhZDEyKHt9LCB2aWV3Qm94KSwge30sIHsKICAgICAgcmFkaXVzLAogICAgICBhbmdsZTogcmV2ZXJzZUZvcm1hdEFuZ2xlT2ZTZWN0b3IoZm9ybWF0QW5nbGUsIHZpZXdCb3gpCiAgICB9KTsKICB9CiAgcmV0dXJuIG51bGw7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2N1cnNvci9nZXRSYWRpYWxDdXJzb3JQb2ludHMuanMKZnVuY3Rpb24gZ2V0UmFkaWFsQ3Vyc29yUG9pbnRzKGFjdGl2ZUNvb3JkaW5hdGUpIHsKICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIHJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBhY3RpdmVDb29yZGluYXRlOwogIHZhciBzdGFydFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgc3RhcnRBbmdsZSk7CiAgdmFyIGVuZFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgZW5kQW5nbGUpOwogIHJldHVybiB7CiAgICBwb2ludHM6IFtzdGFydFBvaW50LCBlbmRQb2ludF0sCiAgICBjeCwKICAgIGN5LAogICAgcmFkaXVzLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvU2VjdG9yLmpzCnZhciBSZWFjdDEwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBfZXh0ZW5kczgoKSB7CiAgcmV0dXJuIF9leHRlbmRzOCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzOC5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciBnZXREZWx0YUFuZ2xlID0gKHN0YXJ0QW5nbGUsIGVuZEFuZ2xlKSA9PiB7CiAgdmFyIHNpZ24yID0gbWF0aFNpZ24oZW5kQW5nbGUgLSBzdGFydEFuZ2xlKTsKICB2YXIgZGVsdGFBbmdsZSA9IE1hdGgubWluKE1hdGguYWJzKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSksIDM1OS45OTkpOwogIHJldHVybiBzaWduMiAqIGRlbHRhQW5nbGU7Cn07CnZhciBnZXRUYW5nZW50Q2lyY2xlID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICByYWRpdXMsCiAgICBhbmdsZSwKICAgIHNpZ246IHNpZ24yLAogICAgaXNFeHRlcm5hbCwKICAgIGNvcm5lclJhZGl1cywKICAgIGNvcm5lcklzRXh0ZXJuYWwKICB9ID0gX3JlZjI7CiAgdmFyIGNlbnRlclJhZGl1cyA9IGNvcm5lclJhZGl1cyAqIChpc0V4dGVybmFsID8gMSA6IC0xKSArIHJhZGl1czsKICB2YXIgdGhldGEgPSBNYXRoLmFzaW4oY29ybmVyUmFkaXVzIC8gY2VudGVyUmFkaXVzKSAvIFJBRElBTjsKICB2YXIgY2VudGVyQW5nbGUgPSBjb3JuZXJJc0V4dGVybmFsID8gYW5nbGUgOiBhbmdsZSArIHNpZ24yICogdGhldGE7CiAgdmFyIGNlbnRlciA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBjZW50ZXJSYWRpdXMsIGNlbnRlckFuZ2xlKTsKICB2YXIgY2lyY2xlVGFuZ2VuY3kgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgcmFkaXVzLCBjZW50ZXJBbmdsZSk7CiAgdmFyIGxpbmVUYW5nZW5jeUFuZ2xlID0gY29ybmVySXNFeHRlcm5hbCA/IGFuZ2xlIC0gc2lnbjIgKiB0aGV0YSA6IGFuZ2xlOwogIHZhciBsaW5lVGFuZ2VuY3kgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgY2VudGVyUmFkaXVzICogTWF0aC5jb3ModGhldGEgKiBSQURJQU4pLCBsaW5lVGFuZ2VuY3lBbmdsZSk7CiAgcmV0dXJuIHsKICAgIGNlbnRlciwKICAgIGNpcmNsZVRhbmdlbmN5LAogICAgbGluZVRhbmdlbmN5LAogICAgdGhldGEKICB9Owp9Owp2YXIgZ2V0U2VjdG9yUGF0aCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBfcmVmMjsKICB2YXIgYW5nbGUgPSBnZXREZWx0YUFuZ2xlKHN0YXJ0QW5nbGUsIGVuZEFuZ2xlKTsKICB2YXIgdGVtcEVuZEFuZ2xlID0gc3RhcnRBbmdsZSArIGFuZ2xlOwogIHZhciBvdXRlclN0YXJ0UG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgb3V0ZXJSYWRpdXMsIHN0YXJ0QW5nbGUpOwogIHZhciBvdXRlckVuZFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIG91dGVyUmFkaXVzLCB0ZW1wRW5kQW5nbGUpOwogIHZhciBwYXRoMiA9ICJNICIuY29uY2F0KG91dGVyU3RhcnRQb2ludC54LCAiLCIpLmNvbmNhdChvdXRlclN0YXJ0UG9pbnQueSwgIlxuICAgIEEgIikuY29uY2F0KG91dGVyUmFkaXVzLCAiLCIpLmNvbmNhdChvdXRlclJhZGl1cywgIiwwLFxuICAgICIpLmNvbmNhdCgrKE1hdGguYWJzKGFuZ2xlKSA+IDE4MCksICIsIikuY29uY2F0KCsoc3RhcnRBbmdsZSA+IHRlbXBFbmRBbmdsZSksICIsXG4gICAgIikuY29uY2F0KG91dGVyRW5kUG9pbnQueCwgIiwiKS5jb25jYXQob3V0ZXJFbmRQb2ludC55LCAiXG4gICIpOwogIGlmIChpbm5lclJhZGl1cyA+IDApIHsKICAgIHZhciBpbm5lclN0YXJ0UG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgaW5uZXJSYWRpdXMsIHN0YXJ0QW5nbGUpOwogICAgdmFyIGlubmVyRW5kUG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgaW5uZXJSYWRpdXMsIHRlbXBFbmRBbmdsZSk7CiAgICBwYXRoMiArPSAiTCAiLmNvbmNhdChpbm5lckVuZFBvaW50LngsICIsIikuY29uY2F0KGlubmVyRW5kUG9pbnQueSwgIlxuICAgICAgICAgICAgQSAiKS5jb25jYXQoaW5uZXJSYWRpdXMsICIsIikuY29uY2F0KGlubmVyUmFkaXVzLCAiLDAsXG4gICAgICAgICAgICAiKS5jb25jYXQoKyhNYXRoLmFicyhhbmdsZSkgPiAxODApLCAiLCIpLmNvbmNhdCgrKHN0YXJ0QW5nbGUgPD0gdGVtcEVuZEFuZ2xlKSwgIixcbiAgICAgICAgICAgICIpLmNvbmNhdChpbm5lclN0YXJ0UG9pbnQueCwgIiwiKS5jb25jYXQoaW5uZXJTdGFydFBvaW50LnksICIgWiIpOwogIH0gZWxzZSB7CiAgICBwYXRoMiArPSAiTCAiLmNvbmNhdChjeCwgIiwiKS5jb25jYXQoY3ksICIgWiIpOwogIH0KICByZXR1cm4gcGF0aDI7Cn07CnZhciBnZXRTZWN0b3JXaXRoQ29ybmVyID0gKF9yZWYzKSA9PiB7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzLAogICAgY29ybmVyUmFkaXVzLAogICAgZm9yY2VDb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IF9yZWYzOwogIHZhciBzaWduMiA9IG1hdGhTaWduKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSk7CiAgdmFyIHsKICAgIGNpcmNsZVRhbmdlbmN5OiBzb2N0LAogICAgbGluZVRhbmdlbmN5OiBzb2x0LAogICAgdGhldGE6IHNvdAogIH0gPSBnZXRUYW5nZW50Q2lyY2xlKHsKICAgIGN4LAogICAgY3ksCiAgICByYWRpdXM6IG91dGVyUmFkaXVzLAogICAgYW5nbGU6IHN0YXJ0QW5nbGUsCiAgICBzaWduOiBzaWduMiwKICAgIGNvcm5lclJhZGl1cywKICAgIGNvcm5lcklzRXh0ZXJuYWwKICB9KTsKICB2YXIgewogICAgY2lyY2xlVGFuZ2VuY3k6IGVvY3QsCiAgICBsaW5lVGFuZ2VuY3k6IGVvbHQsCiAgICB0aGV0YTogZW90CiAgfSA9IGdldFRhbmdlbnRDaXJjbGUoewogICAgY3gsCiAgICBjeSwKICAgIHJhZGl1czogb3V0ZXJSYWRpdXMsCiAgICBhbmdsZTogZW5kQW5nbGUsCiAgICBzaWduOiAtc2lnbjIsCiAgICBjb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsCiAgfSk7CiAgdmFyIG91dGVyQXJjQW5nbGUgPSBjb3JuZXJJc0V4dGVybmFsID8gTWF0aC5hYnMoc3RhcnRBbmdsZSAtIGVuZEFuZ2xlKSA6IE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgLSBzb3QgLSBlb3Q7CiAgaWYgKG91dGVyQXJjQW5nbGUgPCAwKSB7CiAgICBpZiAoZm9yY2VDb3JuZXJSYWRpdXMpIHsKICAgICAgcmV0dXJuICJNICIuY29uY2F0KHNvbHQueCwgIiwiKS5jb25jYXQoc29sdC55LCAiXG4gICAgICAgIGEiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLCIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsMCwwLDEsIikuY29uY2F0KGNvcm5lclJhZGl1cyAqIDIsICIsMFxuICAgICAgICBhIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwxLCIpLmNvbmNhdCgtY29ybmVyUmFkaXVzICogMiwgIiwwXG4gICAgICAiKTsKICAgIH0KICAgIHJldHVybiBnZXRTZWN0b3JQYXRoKHsKICAgICAgY3gsCiAgICAgIGN5LAogICAgICBpbm5lclJhZGl1cywKICAgICAgb3V0ZXJSYWRpdXMsCiAgICAgIHN0YXJ0QW5nbGUsCiAgICAgIGVuZEFuZ2xlCiAgICB9KTsKICB9CiAgdmFyIHBhdGgyID0gIk0gIi5jb25jYXQoc29sdC54LCAiLCIpLmNvbmNhdChzb2x0LnksICJcbiAgICBBIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoKyhzaWduMiA8IDApLCAiLCIpLmNvbmNhdChzb2N0LngsICIsIikuY29uY2F0KHNvY3QueSwgIlxuICAgIEEiKS5jb25jYXQob3V0ZXJSYWRpdXMsICIsIikuY29uY2F0KG91dGVyUmFkaXVzLCAiLDAsIikuY29uY2F0KCsob3V0ZXJBcmNBbmdsZSA+IDE4MCksICIsIikuY29uY2F0KCsoc2lnbjIgPCAwKSwgIiwiKS5jb25jYXQoZW9jdC54LCAiLCIpLmNvbmNhdChlb2N0LnksICJcbiAgICBBIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoKyhzaWduMiA8IDApLCAiLCIpLmNvbmNhdChlb2x0LngsICIsIikuY29uY2F0KGVvbHQueSwgIlxuICAiKTsKICBpZiAoaW5uZXJSYWRpdXMgPiAwKSB7CiAgICB2YXIgewogICAgICBjaXJjbGVUYW5nZW5jeTogc2ljdCwKICAgICAgbGluZVRhbmdlbmN5OiBzaWx0LAogICAgICB0aGV0YTogc2l0CiAgICB9ID0gZ2V0VGFuZ2VudENpcmNsZSh7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgcmFkaXVzOiBpbm5lclJhZGl1cywKICAgICAgYW5nbGU6IHN0YXJ0QW5nbGUsCiAgICAgIHNpZ246IHNpZ24yLAogICAgICBpc0V4dGVybmFsOiB0cnVlLAogICAgICBjb3JuZXJSYWRpdXMsCiAgICAgIGNvcm5lcklzRXh0ZXJuYWwKICAgIH0pOwogICAgdmFyIHsKICAgICAgY2lyY2xlVGFuZ2VuY3k6IGVpY3QsCiAgICAgIGxpbmVUYW5nZW5jeTogZWlsdCwKICAgICAgdGhldGE6IGVpdAogICAgfSA9IGdldFRhbmdlbnRDaXJjbGUoewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIHJhZGl1czogaW5uZXJSYWRpdXMsCiAgICAgIGFuZ2xlOiBlbmRBbmdsZSwKICAgICAgc2lnbjogLXNpZ24yLAogICAgICBpc0V4dGVybmFsOiB0cnVlLAogICAgICBjb3JuZXJSYWRpdXMsCiAgICAgIGNvcm5lcklzRXh0ZXJuYWwKICAgIH0pOwogICAgdmFyIGlubmVyQXJjQW5nbGUgPSBjb3JuZXJJc0V4dGVybmFsID8gTWF0aC5hYnMoc3RhcnRBbmdsZSAtIGVuZEFuZ2xlKSA6IE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgLSBzaXQgLSBlaXQ7CiAgICBpZiAoaW5uZXJBcmNBbmdsZSA8IDAgJiYgY29ybmVyUmFkaXVzID09PSAwKSB7CiAgICAgIHJldHVybiAiIi5jb25jYXQocGF0aDIsICJMIikuY29uY2F0KGN4LCAiLCIpLmNvbmNhdChjeSwgIloiKTsKICAgIH0KICAgIHBhdGgyICs9ICJMIi5jb25jYXQoZWlsdC54LCAiLCIpLmNvbmNhdChlaWx0LnksICJcbiAgICAgIEEiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLCIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsMCwwLCIpLmNvbmNhdCgrKHNpZ24yIDwgMCksICIsIikuY29uY2F0KGVpY3QueCwgIiwiKS5jb25jYXQoZWljdC55LCAiXG4gICAgICBBIikuY29uY2F0KGlubmVyUmFkaXVzLCAiLCIpLmNvbmNhdChpbm5lclJhZGl1cywgIiwwLCIpLmNvbmNhdCgrKGlubmVyQXJjQW5nbGUgPiAxODApLCAiLCIpLmNvbmNhdCgrKHNpZ24yID4gMCksICIsIikuY29uY2F0KHNpY3QueCwgIiwiKS5jb25jYXQoc2ljdC55LCAiXG4gICAgICBBIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoKyhzaWduMiA8IDApLCAiLCIpLmNvbmNhdChzaWx0LngsICIsIikuY29uY2F0KHNpbHQueSwgIloiKTsKICB9IGVsc2UgewogICAgcGF0aDIgKz0gIkwiLmNvbmNhdChjeCwgIiwiKS5jb25jYXQoY3ksICJaIik7CiAgfQogIHJldHVybiBwYXRoMjsKfTsKdmFyIGRlZmF1bHRTZWN0b3JQcm9wcyA9IHsKICBjeDogMCwKICBjeTogMCwKICBpbm5lclJhZGl1czogMCwKICBvdXRlclJhZGl1czogMCwKICBzdGFydEFuZ2xlOiAwLAogIGVuZEFuZ2xlOiAwLAogIGNvcm5lclJhZGl1czogMCwKICBmb3JjZUNvcm5lclJhZGl1czogZmFsc2UsCiAgY29ybmVySXNFeHRlcm5hbDogZmFsc2UKfTsKdmFyIFNlY3RvciA9IChzZWN0b3JQcm9wcykgPT4gewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMoc2VjdG9yUHJvcHMsIGRlZmF1bHRTZWN0b3JQcm9wcyk7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzLAogICAgY29ybmVyUmFkaXVzLAogICAgZm9yY2VDb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlLAogICAgY2xhc3NOYW1lCiAgfSA9IHByb3BzOwogIGlmIChvdXRlclJhZGl1cyA8IGlubmVyUmFkaXVzIHx8IHN0YXJ0QW5nbGUgPT09IGVuZEFuZ2xlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGxheWVyQ2xhc3MgPSBjbHN4KCJyZWNoYXJ0cy1zZWN0b3IiLCBjbGFzc05hbWUpOwogIHZhciBkZWx0YVJhZGl1cyA9IG91dGVyUmFkaXVzIC0gaW5uZXJSYWRpdXM7CiAgdmFyIGNyID0gZ2V0UGVyY2VudFZhbHVlKGNvcm5lclJhZGl1cywgZGVsdGFSYWRpdXMsIDAsIHRydWUpOwogIHZhciBwYXRoMjsKICBpZiAoY3IgPiAwICYmIE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgPCAzNjApIHsKICAgIHBhdGgyID0gZ2V0U2VjdG9yV2l0aENvcm5lcih7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgaW5uZXJSYWRpdXMsCiAgICAgIG91dGVyUmFkaXVzLAogICAgICBjb3JuZXJSYWRpdXM6IE1hdGgubWluKGNyLCBkZWx0YVJhZGl1cyAvIDIpLAogICAgICBmb3JjZUNvcm5lclJhZGl1cywKICAgICAgY29ybmVySXNFeHRlcm5hbCwKICAgICAgc3RhcnRBbmdsZSwKICAgICAgZW5kQW5nbGUKICAgIH0pOwogIH0gZWxzZSB7CiAgICBwYXRoMiA9IGdldFNlY3RvclBhdGgoewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIGlubmVyUmFkaXVzLAogICAgICBvdXRlclJhZGl1cywKICAgICAgc3RhcnRBbmdsZSwKICAgICAgZW5kQW5nbGUKICAgIH0pOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTAuY3JlYXRlRWxlbWVudCgicGF0aCIsIF9leHRlbmRzOCh7fSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhwcm9wcyksIHsKICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcywKICAgIGQ6IHBhdGgyCiAgfSkpOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9jdXJzb3IvZ2V0Q3Vyc29yUG9pbnRzLmpzCmZ1bmN0aW9uIGdldEN1cnNvclBvaW50cyhsYXlvdXQsIGFjdGl2ZUNvb3JkaW5hdGUsIG9mZnNldCkgewogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIikgewogICAgcmV0dXJuIFt7CiAgICAgIHg6IGFjdGl2ZUNvb3JkaW5hdGUueCwKICAgICAgeTogb2Zmc2V0LnRvcAogICAgfSwgewogICAgICB4OiBhY3RpdmVDb29yZGluYXRlLngsCiAgICAgIHk6IG9mZnNldC50b3AgKyBvZmZzZXQuaGVpZ2h0CiAgICB9XTsKICB9CiAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgcmV0dXJuIFt7CiAgICAgIHg6IG9mZnNldC5sZWZ0LAogICAgICB5OiBhY3RpdmVDb29yZGluYXRlLnkKICAgIH0sIHsKICAgICAgeDogb2Zmc2V0LmxlZnQgKyBvZmZzZXQud2lkdGgsCiAgICAgIHk6IGFjdGl2ZUNvb3JkaW5hdGUueQogICAgfV07CiAgfQogIGlmIChpc1BvbGFyQ29vcmRpbmF0ZShhY3RpdmVDb29yZGluYXRlKSkgewogICAgaWYgKGxheW91dCA9PT0gImNlbnRyaWMiKSB7CiAgICAgIHZhciB7CiAgICAgICAgY3gsCiAgICAgICAgY3ksCiAgICAgICAgaW5uZXJSYWRpdXMsCiAgICAgICAgb3V0ZXJSYWRpdXMsCiAgICAgICAgYW5nbGUKICAgICAgfSA9IGFjdGl2ZUNvb3JkaW5hdGU7CiAgICAgIHZhciBpbm5lclBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIGlubmVyUmFkaXVzLCBhbmdsZSk7CiAgICAgIHZhciBvdXRlclBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIG91dGVyUmFkaXVzLCBhbmdsZSk7CiAgICAgIHJldHVybiBbewogICAgICAgIHg6IGlubmVyUG9pbnQueCwKICAgICAgICB5OiBpbm5lclBvaW50LnkKICAgICAgfSwgewogICAgICAgIHg6IG91dGVyUG9pbnQueCwKICAgICAgICB5OiBvdXRlclBvaW50LnkKICAgICAgfV07CiAgICB9CiAgICByZXR1cm4gZ2V0UmFkaWFsQ3Vyc29yUG9pbnRzKGFjdGl2ZUNvb3JkaW5hdGUpOwogIH0KICByZXR1cm4gdm9pZCAwOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvYXhpc1NlbGVjdG9ycy5qcwp2YXIgaW1wb3J0X3JhbmdlMiA9IF9fdG9FU00ocmVxdWlyZV9yYW5nZTIoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vdmljdG9yeS12ZW5kb3JAMzcuMy42L25vZGVfbW9kdWxlcy92aWN0b3J5LXZlbmRvci9lcy9kMy1zY2FsZS5qcwp2YXIgZDNfc2NhbGVfZXhwb3J0cyA9IHt9OwpfX2V4cG9ydChkM19zY2FsZV9leHBvcnRzLCB7CiAgc2NhbGVCYW5kOiAoKSA9PiBiYW5kLAogIHNjYWxlRGl2ZXJnaW5nOiAoKSA9PiBkaXZlcmdpbmcsCiAgc2NhbGVEaXZlcmdpbmdMb2c6ICgpID0+IGRpdmVyZ2luZ0xvZywKICBzY2FsZURpdmVyZ2luZ1BvdzogKCkgPT4gZGl2ZXJnaW5nUG93LAogIHNjYWxlRGl2ZXJnaW5nU3FydDogKCkgPT4gZGl2ZXJnaW5nU3FydCwKICBzY2FsZURpdmVyZ2luZ1N5bWxvZzogKCkgPT4gZGl2ZXJnaW5nU3ltbG9nLAogIHNjYWxlSWRlbnRpdHk6ICgpID0+IGlkZW50aXR5MiwKICBzY2FsZUltcGxpY2l0OiAoKSA9PiBpbXBsaWNpdCwKICBzY2FsZUxpbmVhcjogKCkgPT4gbGluZWFyMiwKICBzY2FsZUxvZzogKCkgPT4gbG9nLAogIHNjYWxlT3JkaW5hbDogKCkgPT4gb3JkaW5hbCwKICBzY2FsZVBvaW50OiAoKSA9PiBwb2ludDMsCiAgc2NhbGVQb3c6ICgpID0+IHBvdywKICBzY2FsZVF1YW50aWxlOiAoKSA9PiBxdWFudGlsZTIsCiAgc2NhbGVRdWFudGl6ZTogKCkgPT4gcXVhbnRpemUsCiAgc2NhbGVSYWRpYWw6ICgpID0+IHJhZGlhbCwKICBzY2FsZVNlcXVlbnRpYWw6ICgpID0+IHNlcXVlbnRpYWwsCiAgc2NhbGVTZXF1ZW50aWFsTG9nOiAoKSA9PiBzZXF1ZW50aWFsTG9nLAogIHNjYWxlU2VxdWVudGlhbFBvdzogKCkgPT4gc2VxdWVudGlhbFBvdywKICBzY2FsZVNlcXVlbnRpYWxRdWFudGlsZTogKCkgPT4gc2VxdWVudGlhbFF1YW50aWxlLAogIHNjYWxlU2VxdWVudGlhbFNxcnQ6ICgpID0+IHNlcXVlbnRpYWxTcXJ0LAogIHNjYWxlU2VxdWVudGlhbFN5bWxvZzogKCkgPT4gc2VxdWVudGlhbFN5bWxvZywKICBzY2FsZVNxcnQ6ICgpID0+IHNxcnQsCiAgc2NhbGVTeW1sb2c6ICgpID0+IHN5bWxvZywKICBzY2FsZVRocmVzaG9sZDogKCkgPT4gdGhyZXNob2xkLAogIHNjYWxlVGltZTogKCkgPT4gdGltZSwKICBzY2FsZVV0YzogKCkgPT4gdXRjVGltZSwKICB0aWNrRm9ybWF0OiAoKSA9PiB0aWNrRm9ybWF0Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWFycmF5QDMuMi40L25vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvYXNjZW5kaW5nLmpzCmZ1bmN0aW9uIGFzY2VuZGluZyhhLCBiKSB7CiAgcmV0dXJuIGEgPT0gbnVsbCB8fCBiID09IG51bGwgPyBOYU4gOiBhIDwgYiA/IC0xIDogYSA+IGIgPyAxIDogYSA+PSBiID8gMCA6IE5hTjsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWFycmF5QDMuMi40L25vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvZGVzY2VuZGluZy5qcwpmdW5jdGlvbiBkZXNjZW5kaW5nKGEsIGIpIHsKICByZXR1cm4gYSA9PSBudWxsIHx8IGIgPT0gbnVsbCA/IE5hTiA6IGIgPCBhID8gLTEgOiBiID4gYSA/IDEgOiBiID49IGEgPyAwIDogTmFOOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtYXJyYXlAMy4yLjQvbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9iaXNlY3Rvci5qcwpmdW5jdGlvbiBiaXNlY3RvcihmKSB7CiAgbGV0IGNvbXBhcmUxLCBjb21wYXJlMiwgZGVsdGE7CiAgaWYgKGYubGVuZ3RoICE9PSAyKSB7CiAgICBjb21wYXJlMSA9IGFzY2VuZGluZzsKICAgIGNvbXBhcmUyID0gKGQsIHgyKSA9PiBhc2NlbmRpbmcoZihkKSwgeDIpOwogICAgZGVsdGEgPSAoZCwgeDIpID0+IGYoZCkgLSB4MjsKICB9IGVsc2UgewogICAgY29tcGFyZTEgPSBmID09PSBhc2NlbmRpbmcgfHwgZiA9PT0gZGVzY2VuZGluZyA/IGYgOiB6ZXJvOwogICAgY29tcGFyZTIgPSBmOwogICAgZGVsdGEgPSBmOwogIH0KICBmdW5jdGlvbiBsZWZ0KGEsIHgyLCBsbyA9IDAsIGhpID0gYS5sZW5ndGgpIHsKICAgIGlmIChsbyA8IGhpKSB7CiAgICAgIGlmIChjb21wYXJlMSh4MiwgeDIpICE9PSAwKSByZXR1cm4gaGk7CiAgICAgIGRvIHsKICAgICAgICBjb25zdCBtaWQgPSBsbyArIGhpID4+PiAxOwogICAgICAgIGlmIChjb21wYXJlMihhW21pZF0sIHgyKSA8IDApIGxvID0gbWlkICsgMTsKICAgICAgICBlbHNlIGhpID0gbWlkOwogICAgICB9IHdoaWxlIChsbyA8IGhpKTsKICAgIH0KICAgIHJldHVybiBsbzsKICB9CiAgZnVuY3Rpb24gcmlnaHQoYSwgeDIsIGxvID0gMCwgaGkgPSBhLmxlbmd0aCkgewogICAgaWYgKGxvIDwgaGkpIHsKICAgICAgaWYgKGNvbXBhcmUxKHgyLCB4MikgIT09IDApIHJldHVybiBoaTsKICAgICAgZG8gewogICAgICAgIGNvbnN0IG1pZCA9IGxvICsgaGkgPj4+IDE7CiAgICAgICAgaWYgKGNvbXBhcmUyKGFbbWlkXSwgeDIpIDw9IDApIGxvID0gbWlkICsgMTsKICAgICAgICBlbHNlIGhpID0gbWlkOwogICAgICB9IHdoaWxlIChsbyA8IGhpKTsKICAgIH0KICAgIHJldHVybiBsbzsKICB9CiAgZnVuY3Rpb24gY2VudGVyKGEsIHgyLCBsbyA9IDAsIGhpID0gYS5sZW5ndGgpIHsKICAgIGNvbnN0IGkgPSBsZWZ0KGEsIHgyLCBsbywgaGkgLSAxKTsKICAgIHJldHVybiBpID4gbG8gJiYgZGVsdGEoYVtpIC0gMV0sIHgyKSA+IC1kZWx0YShhW2ldLCB4MikgPyBpIC0gMSA6IGk7CiAgfQogIHJldHVybiB7IGxlZnQsIGNlbnRlciwgcmlnaHQgfTsKfQpmdW5jdGlvbiB6ZXJvKCkgewogIHJldHVybiAwOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtYXJyYXlAMy4yLjQvbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9udW1iZXIuanMKZnVuY3Rpb24gbnVtYmVyKHgyKSB7CiAgcmV0dXJuIHgyID09PSBudWxsID8gTmFOIDogK3gyOwp9CmZ1bmN0aW9uKiBudW1iZXJzKHZhbHVlcywgdmFsdWVvZikgewogIGlmICh2YWx1ZW9mID09PSB2b2lkIDApIHsKICAgIGZvciAobGV0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAodmFsdWUgIT0gbnVsbCAmJiAodmFsdWUgPSArdmFsdWUpID49IHZhbHVlKSB7CiAgICAgICAgeWllbGQgdmFsdWU7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgbGV0IGluZGV4ID0gLTE7CiAgICBmb3IgKGxldCB2YWx1ZSBvZiB2YWx1ZXMpIHsKICAgICAgaWYgKCh2YWx1ZSA9IHZhbHVlb2YodmFsdWUsICsraW5kZXgsIHZhbHVlcykpICE9IG51bGwgJiYgKHZhbHVlID0gK3ZhbHVlKSA+PSB2YWx1ZSkgewogICAgICAgIHlpZWxkIHZhbHVlOwogICAgICB9CiAgICB9CiAgfQp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtYXJyYXlAMy4yLjQvbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9iaXNlY3QuanMKdmFyIGFzY2VuZGluZ0Jpc2VjdCA9IGJpc2VjdG9yKGFzY2VuZGluZyk7CnZhciBiaXNlY3RSaWdodCA9IGFzY2VuZGluZ0Jpc2VjdC5yaWdodDsKdmFyIGJpc2VjdExlZnQgPSBhc2NlbmRpbmdCaXNlY3QubGVmdDsKdmFyIGJpc2VjdENlbnRlciA9IGJpc2VjdG9yKG51bWJlcikuY2VudGVyOwp2YXIgYmlzZWN0X2RlZmF1bHQgPSBiaXNlY3RSaWdodDsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9pbnRlcm5tYXBAMi4wLjMvbm9kZV9tb2R1bGVzL2ludGVybm1hcC9zcmMvaW5kZXguanMKdmFyIEludGVybk1hcCA9IGNsYXNzIGV4dGVuZHMgTWFwIHsKICBjb25zdHJ1Y3RvcihlbnRyaWVzLCBrZXkgPSBrZXlvZikgewogICAgc3VwZXIoKTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKHRoaXMsIHsgX2ludGVybjogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSB9LCBfa2V5OiB7IHZhbHVlOiBrZXkgfSB9KTsKICAgIGlmIChlbnRyaWVzICE9IG51bGwpIGZvciAoY29uc3QgW2tleTIsIHZhbHVlXSBvZiBlbnRyaWVzKSB0aGlzLnNldChrZXkyLCB2YWx1ZSk7CiAgfQogIGdldChrZXkpIHsKICAgIHJldHVybiBzdXBlci5nZXQoaW50ZXJuX2dldCh0aGlzLCBrZXkpKTsKICB9CiAgaGFzKGtleSkgewogICAgcmV0dXJuIHN1cGVyLmhhcyhpbnRlcm5fZ2V0KHRoaXMsIGtleSkpOwogIH0KICBzZXQoa2V5LCB2YWx1ZSkgewogICAgcmV0dXJuIHN1cGVyLnNldChpbnRlcm5fc2V0KHRoaXMsIGtleSksIHZhbHVlKTsKICB9CiAgZGVsZXRlKGtleSkgewogICAgcmV0dXJuIHN1cGVyLmRlbGV0ZShpbnRlcm5fZGVsZXRlKHRoaXMsIGtleSkpOwogIH0KfTsKZnVuY3Rpb24gaW50ZXJuX2dldCh7IF9pbnRlcm4sIF9rZXkgfSwgdmFsdWUpIHsKICBjb25zdCBrZXkgPSBfa2V5KHZhbHVlKTsKICByZXR1cm4gX2ludGVybi5oYXMoa2V5KSA/IF9pbnRlcm4uZ2V0KGtleSkgOiB2YWx1ZTsKfQpmdW5jdGlvbiBpbnRlcm5fc2V0KHsgX2ludGVybiwgX2tleSB9LCB2YWx1ZSkgewogIGNvbnN0IGtleSA9IF9rZXkodmFsdWUpOwogIGlmIChfaW50ZXJuLmhhcyhrZXkpKSByZXR1cm4gX2ludGVybi5nZXQoa2V5KTsKICBfaW50ZXJuLnNldChrZXksIHZhbHVlKTsKICByZXR1cm4gdmFsdWU7Cn0KZnVuY3Rpb24gaW50ZXJuX2RlbGV0ZSh7IF9pbnRlcm4sIF9rZXkgfSwgdmFsdWUpIHsKICBjb25zdCBrZXkgPSBfa2V5KHZhbHVlKTsKICBpZiAoX2ludGVybi5oYXMoa2V5KSkgewogICAgdmFsdWUgPSBfaW50ZXJuLmdldChrZXkpOwogICAgX2ludGVybi5kZWxldGUoa2V5KTsKICB9CiAgcmV0dXJuIHZhbHVlOwp9CmZ1bmN0aW9uIGtleW9mKHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgPyB2YWx1ZS52YWx1ZU9mKCkgOiB2YWx1ZTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWFycmF5QDMuMi40L25vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvc29ydC5qcwpmdW5jdGlvbiBjb21wYXJlRGVmaW5lZChjb21wYXJlID0gYXNjZW5kaW5nKSB7CiAgaWYgKGNvbXBhcmUgPT09IGFzY2VuZGluZykgcmV0dXJuIGFzY2VuZGluZ0RlZmluZWQ7CiAgaWYgKHR5cGVvZiBjb21wYXJlICE9PSAiZnVuY3Rpb24iKSB0aHJvdyBuZXcgVHlwZUVycm9yKCJjb21wYXJlIGlzIG5vdCBhIGZ1bmN0aW9uIik7CiAgcmV0dXJuIChhLCBiKSA9PiB7CiAgICBjb25zdCB4MiA9IGNvbXBhcmUoYSwgYik7CiAgICBpZiAoeDIgfHwgeDIgPT09IDApIHJldHVybiB4MjsKICAgIHJldHVybiAoY29tcGFyZShiLCBiKSA9PT0gMCkgLSAoY29tcGFyZShhLCBhKSA9PT0gMCk7CiAgfTsKfQpmdW5jdGlvbiBhc2NlbmRpbmdEZWZpbmVkKGEsIGIpIHsKICByZXR1cm4gKGEgPT0gbnVsbCB8fCAhKGEgPj0gYSkpIC0gKGIgPT0gbnVsbCB8fCAhKGIgPj0gYikpIHx8IChhIDwgYiA/IC0xIDogYSA+IGIgPyAxIDogMCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1hcnJheUAzLjIuNC9ub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL3RpY2tzLmpzCnZhciBlMTAgPSBNYXRoLnNxcnQoNTApOwp2YXIgZTUgPSBNYXRoLnNxcnQoMTApOwp2YXIgZTIgPSBNYXRoLnNxcnQoMik7CmZ1bmN0aW9uIHRpY2tTcGVjKHN0YXJ0LCBzdG9wLCBjb3VudCkgewogIGNvbnN0IHN0ZXAgPSAoc3RvcCAtIHN0YXJ0KSAvIE1hdGgubWF4KDAsIGNvdW50KSwgcG93ZXIgPSBNYXRoLmZsb29yKE1hdGgubG9nMTAoc3RlcCkpLCBlcnJvciA9IHN0ZXAgLyBNYXRoLnBvdygxMCwgcG93ZXIpLCBmYWN0b3IgPSBlcnJvciA+PSBlMTAgPyAxMCA6IGVycm9yID49IGU1ID8gNSA6IGVycm9yID49IGUyID8gMiA6IDE7CiAgbGV0IGkxLCBpMiwgaW5jOwogIGlmIChwb3dlciA8IDApIHsKICAgIGluYyA9IE1hdGgucG93KDEwLCAtcG93ZXIpIC8gZmFjdG9yOwogICAgaTEgPSBNYXRoLnJvdW5kKHN0YXJ0ICogaW5jKTsKICAgIGkyID0gTWF0aC5yb3VuZChzdG9wICogaW5jKTsKICAgIGlmIChpMSAvIGluYyA8IHN0YXJ0KSArK2kxOwogICAgaWYgKGkyIC8gaW5jID4gc3RvcCkgLS1pMjsKICAgIGluYyA9IC1pbmM7CiAgfSBlbHNlIHsKICAgIGluYyA9IE1hdGgucG93KDEwLCBwb3dlcikgKiBmYWN0b3I7CiAgICBpMSA9IE1hdGgucm91bmQoc3RhcnQgLyBpbmMpOwogICAgaTIgPSBNYXRoLnJvdW5kKHN0b3AgLyBpbmMpOwogICAgaWYgKGkxICogaW5jIDwgc3RhcnQpICsraTE7CiAgICBpZiAoaTIgKiBpbmMgPiBzdG9wKSAtLWkyOwogIH0KICBpZiAoaTIgPCBpMSAmJiAwLjUgPD0gY291bnQgJiYgY291bnQgPCAyKSByZXR1cm4gdGlja1NwZWMoc3RhcnQsIHN0b3AsIGNvdW50ICogMik7CiAgcmV0dXJuIFtpMSwgaTIsIGluY107Cn0KZnVuY3Rpb24gdGlja3Moc3RhcnQsIHN0b3AsIGNvdW50KSB7CiAgc3RvcCA9ICtzdG9wLCBzdGFydCA9ICtzdGFydCwgY291bnQgPSArY291bnQ7CiAgaWYgKCEoY291bnQgPiAwKSkgcmV0dXJuIFtdOwogIGlmIChzdGFydCA9PT0gc3RvcCkgcmV0dXJuIFtzdGFydF07CiAgY29uc3QgcmV2ZXJzZTIgPSBzdG9wIDwgc3RhcnQsIFtpMSwgaTIsIGluY10gPSByZXZlcnNlMiA/IHRpY2tTcGVjKHN0b3AsIHN0YXJ0LCBjb3VudCkgOiB0aWNrU3BlYyhzdGFydCwgc3RvcCwgY291bnQpOwogIGlmICghKGkyID49IGkxKSkgcmV0dXJuIFtdOwogIGNvbnN0IG4gPSBpMiAtIGkxICsgMSwgdGlja3MyID0gbmV3IEFycmF5KG4pOwogIGlmIChyZXZlcnNlMikgewogICAgaWYgKGluYyA8IDApIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgKytpKSB0aWNrczJbaV0gPSAoaTIgLSBpKSAvIC1pbmM7CiAgICBlbHNlIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgKytpKSB0aWNrczJbaV0gPSAoaTIgLSBpKSAqIGluYzsKICB9IGVsc2UgewogICAgaWYgKGluYyA8IDApIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgKytpKSB0aWNrczJbaV0gPSAoaTEgKyBpKSAvIC1pbmM7CiAgICBlbHNlIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgKytpKSB0aWNrczJbaV0gPSAoaTEgKyBpKSAqIGluYzsKICB9CiAgcmV0dXJuIHRpY2tzMjsKfQpmdW5jdGlvbiB0aWNrSW5jcmVtZW50KHN0YXJ0LCBzdG9wLCBjb3VudCkgewogIHN0b3AgPSArc3RvcCwgc3RhcnQgPSArc3RhcnQsIGNvdW50ID0gK2NvdW50OwogIHJldHVybiB0aWNrU3BlYyhzdGFydCwgc3RvcCwgY291bnQpWzJdOwp9CmZ1bmN0aW9uIHRpY2tTdGVwKHN0YXJ0LCBzdG9wLCBjb3VudCkgewogIHN0b3AgPSArc3RvcCwgc3RhcnQgPSArc3RhcnQsIGNvdW50ID0gK2NvdW50OwogIGNvbnN0IHJldmVyc2UyID0gc3RvcCA8IHN0YXJ0LCBpbmMgPSByZXZlcnNlMiA/IHRpY2tJbmNyZW1lbnQoc3RvcCwgc3RhcnQsIGNvdW50KSA6IHRpY2tJbmNyZW1lbnQoc3RhcnQsIHN0b3AsIGNvdW50KTsKICByZXR1cm4gKHJldmVyc2UyID8gLTEgOiAxKSAqIChpbmMgPCAwID8gMSAvIC1pbmMgOiBpbmMpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtYXJyYXlAMy4yLjQvbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9tYXguanMKZnVuY3Rpb24gbWF4KHZhbHVlcywgdmFsdWVvZikgewogIGxldCBtYXgyOwogIGlmICh2YWx1ZW9mID09PSB2b2lkIDApIHsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIGlmICh2YWx1ZSAhPSBudWxsICYmIChtYXgyIDwgdmFsdWUgfHwgbWF4MiA9PT0gdm9pZCAwICYmIHZhbHVlID49IHZhbHVlKSkgewogICAgICAgIG1heDIgPSB2YWx1ZTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBsZXQgaW5kZXggPSAtMTsKICAgIGZvciAobGV0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAoKHZhbHVlID0gdmFsdWVvZih2YWx1ZSwgKytpbmRleCwgdmFsdWVzKSkgIT0gbnVsbCAmJiAobWF4MiA8IHZhbHVlIHx8IG1heDIgPT09IHZvaWQgMCAmJiB2YWx1ZSA+PSB2YWx1ZSkpIHsKICAgICAgICBtYXgyID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIG1heDI7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1hcnJheUAzLjIuNC9ub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL21pbi5qcwpmdW5jdGlvbiBtaW4odmFsdWVzLCB2YWx1ZW9mKSB7CiAgbGV0IG1pbjI7CiAgaWYgKHZhbHVlb2YgPT09IHZvaWQgMCkgewogICAgZm9yIChjb25zdCB2YWx1ZSBvZiB2YWx1ZXMpIHsKICAgICAgaWYgKHZhbHVlICE9IG51bGwgJiYgKG1pbjIgPiB2YWx1ZSB8fCBtaW4yID09PSB2b2lkIDAgJiYgdmFsdWUgPj0gdmFsdWUpKSB7CiAgICAgICAgbWluMiA9IHZhbHVlOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGxldCBpbmRleCA9IC0xOwogICAgZm9yIChsZXQgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIGlmICgodmFsdWUgPSB2YWx1ZW9mKHZhbHVlLCArK2luZGV4LCB2YWx1ZXMpKSAhPSBudWxsICYmIChtaW4yID4gdmFsdWUgfHwgbWluMiA9PT0gdm9pZCAwICYmIHZhbHVlID49IHZhbHVlKSkgewogICAgICAgIG1pbjIgPSB2YWx1ZTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gbWluMjsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWFycmF5QDMuMi40L25vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvcXVpY2tzZWxlY3QuanMKZnVuY3Rpb24gcXVpY2tzZWxlY3QoYXJyYXksIGssIGxlZnQgPSAwLCByaWdodCA9IEluZmluaXR5LCBjb21wYXJlKSB7CiAgayA9IE1hdGguZmxvb3Ioayk7CiAgbGVmdCA9IE1hdGguZmxvb3IoTWF0aC5tYXgoMCwgbGVmdCkpOwogIHJpZ2h0ID0gTWF0aC5mbG9vcihNYXRoLm1pbihhcnJheS5sZW5ndGggLSAxLCByaWdodCkpOwogIGlmICghKGxlZnQgPD0gayAmJiBrIDw9IHJpZ2h0KSkgcmV0dXJuIGFycmF5OwogIGNvbXBhcmUgPSBjb21wYXJlID09PSB2b2lkIDAgPyBhc2NlbmRpbmdEZWZpbmVkIDogY29tcGFyZURlZmluZWQoY29tcGFyZSk7CiAgd2hpbGUgKHJpZ2h0ID4gbGVmdCkgewogICAgaWYgKHJpZ2h0IC0gbGVmdCA+IDYwMCkgewogICAgICBjb25zdCBuID0gcmlnaHQgLSBsZWZ0ICsgMTsKICAgICAgY29uc3QgbSA9IGsgLSBsZWZ0ICsgMTsKICAgICAgY29uc3QgeiA9IE1hdGgubG9nKG4pOwogICAgICBjb25zdCBzID0gMC41ICogTWF0aC5leHAoMiAqIHogLyAzKTsKICAgICAgY29uc3Qgc2QgPSAwLjUgKiBNYXRoLnNxcnQoeiAqIHMgKiAobiAtIHMpIC8gbikgKiAobSAtIG4gLyAyIDwgMCA/IC0xIDogMSk7CiAgICAgIGNvbnN0IG5ld0xlZnQgPSBNYXRoLm1heChsZWZ0LCBNYXRoLmZsb29yKGsgLSBtICogcyAvIG4gKyBzZCkpOwogICAgICBjb25zdCBuZXdSaWdodCA9IE1hdGgubWluKHJpZ2h0LCBNYXRoLmZsb29yKGsgKyAobiAtIG0pICogcyAvIG4gKyBzZCkpOwogICAgICBxdWlja3NlbGVjdChhcnJheSwgaywgbmV3TGVmdCwgbmV3UmlnaHQsIGNvbXBhcmUpOwogICAgfQogICAgY29uc3QgdCA9IGFycmF5W2tdOwogICAgbGV0IGkgPSBsZWZ0OwogICAgbGV0IGogPSByaWdodDsKICAgIHN3YXAoYXJyYXksIGxlZnQsIGspOwogICAgaWYgKGNvbXBhcmUoYXJyYXlbcmlnaHRdLCB0KSA+IDApIHN3YXAoYXJyYXksIGxlZnQsIHJpZ2h0KTsKICAgIHdoaWxlIChpIDwgaikgewogICAgICBzd2FwKGFycmF5LCBpLCBqKSwgKytpLCAtLWo7CiAgICAgIHdoaWxlIChjb21wYXJlKGFycmF5W2ldLCB0KSA8IDApICsraTsKICAgICAgd2hpbGUgKGNvbXBhcmUoYXJyYXlbal0sIHQpID4gMCkgLS1qOwogICAgfQogICAgaWYgKGNvbXBhcmUoYXJyYXlbbGVmdF0sIHQpID09PSAwKSBzd2FwKGFycmF5LCBsZWZ0LCBqKTsKICAgIGVsc2UgKytqLCBzd2FwKGFycmF5LCBqLCByaWdodCk7CiAgICBpZiAoaiA8PSBrKSBsZWZ0ID0gaiArIDE7CiAgICBpZiAoayA8PSBqKSByaWdodCA9IGogLSAxOwogIH0KICByZXR1cm4gYXJyYXk7Cn0KZnVuY3Rpb24gc3dhcChhcnJheSwgaSwgaikgewogIGNvbnN0IHQgPSBhcnJheVtpXTsKICBhcnJheVtpXSA9IGFycmF5W2pdOwogIGFycmF5W2pdID0gdDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWFycmF5QDMuMi40L25vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvcXVhbnRpbGUuanMKZnVuY3Rpb24gcXVhbnRpbGUodmFsdWVzLCBwLCB2YWx1ZW9mKSB7CiAgdmFsdWVzID0gRmxvYXQ2NEFycmF5LmZyb20obnVtYmVycyh2YWx1ZXMsIHZhbHVlb2YpKTsKICBpZiAoIShuID0gdmFsdWVzLmxlbmd0aCkgfHwgaXNOYU4ocCA9ICtwKSkgcmV0dXJuOwogIGlmIChwIDw9IDAgfHwgbiA8IDIpIHJldHVybiBtaW4odmFsdWVzKTsKICBpZiAocCA+PSAxKSByZXR1cm4gbWF4KHZhbHVlcyk7CiAgdmFyIG4sIGkgPSAobiAtIDEpICogcCwgaTAgPSBNYXRoLmZsb29yKGkpLCB2YWx1ZTAgPSBtYXgocXVpY2tzZWxlY3QodmFsdWVzLCBpMCkuc3ViYXJyYXkoMCwgaTAgKyAxKSksIHZhbHVlMSA9IG1pbih2YWx1ZXMuc3ViYXJyYXkoaTAgKyAxKSk7CiAgcmV0dXJuIHZhbHVlMCArICh2YWx1ZTEgLSB2YWx1ZTApICogKGkgLSBpMCk7Cn0KZnVuY3Rpb24gcXVhbnRpbGVTb3J0ZWQodmFsdWVzLCBwLCB2YWx1ZW9mID0gbnVtYmVyKSB7CiAgaWYgKCEobiA9IHZhbHVlcy5sZW5ndGgpIHx8IGlzTmFOKHAgPSArcCkpIHJldHVybjsKICBpZiAocCA8PSAwIHx8IG4gPCAyKSByZXR1cm4gK3ZhbHVlb2YodmFsdWVzWzBdLCAwLCB2YWx1ZXMpOwogIGlmIChwID49IDEpIHJldHVybiArdmFsdWVvZih2YWx1ZXNbbiAtIDFdLCBuIC0gMSwgdmFsdWVzKTsKICB2YXIgbiwgaSA9IChuIC0gMSkgKiBwLCBpMCA9IE1hdGguZmxvb3IoaSksIHZhbHVlMCA9ICt2YWx1ZW9mKHZhbHVlc1tpMF0sIGkwLCB2YWx1ZXMpLCB2YWx1ZTEgPSArdmFsdWVvZih2YWx1ZXNbaTAgKyAxXSwgaTAgKyAxLCB2YWx1ZXMpOwogIHJldHVybiB2YWx1ZTAgKyAodmFsdWUxIC0gdmFsdWUwKSAqIChpIC0gaTApOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtYXJyYXlAMy4yLjQvbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9yYW5nZS5qcwpmdW5jdGlvbiByYW5nZShzdGFydCwgc3RvcCwgc3RlcCkgewogIHN0YXJ0ID0gK3N0YXJ0LCBzdG9wID0gK3N0b3AsIHN0ZXAgPSAobiA9IGFyZ3VtZW50cy5sZW5ndGgpIDwgMiA/IChzdG9wID0gc3RhcnQsIHN0YXJ0ID0gMCwgMSkgOiBuIDwgMyA/IDEgOiArc3RlcDsKICB2YXIgaSA9IC0xLCBuID0gTWF0aC5tYXgoMCwgTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCkpIHwgMCwgcmFuZ2U0ID0gbmV3IEFycmF5KG4pOwogIHdoaWxlICgrK2kgPCBuKSB7CiAgICByYW5nZTRbaV0gPSBzdGFydCArIGkgKiBzdGVwOwogIH0KICByZXR1cm4gcmFuZ2U0Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9pbml0LmpzCmZ1bmN0aW9uIGluaXRSYW5nZShkb21haW4sIHJhbmdlNCkgewogIHN3aXRjaCAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgY2FzZSAwOgogICAgICBicmVhazsKICAgIGNhc2UgMToKICAgICAgdGhpcy5yYW5nZShkb21haW4pOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIHRoaXMucmFuZ2UocmFuZ2U0KS5kb21haW4oZG9tYWluKTsKICAgICAgYnJlYWs7CiAgfQogIHJldHVybiB0aGlzOwp9CmZ1bmN0aW9uIGluaXRJbnRlcnBvbGF0b3IoZG9tYWluLCBpbnRlcnBvbGF0b3IpIHsKICBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgIGNhc2UgMDoKICAgICAgYnJlYWs7CiAgICBjYXNlIDE6IHsKICAgICAgaWYgKHR5cGVvZiBkb21haW4gPT09ICJmdW5jdGlvbiIpIHRoaXMuaW50ZXJwb2xhdG9yKGRvbWFpbik7CiAgICAgIGVsc2UgdGhpcy5yYW5nZShkb21haW4pOwogICAgICBicmVhazsKICAgIH0KICAgIGRlZmF1bHQ6IHsKICAgICAgdGhpcy5kb21haW4oZG9tYWluKTsKICAgICAgaWYgKHR5cGVvZiBpbnRlcnBvbGF0b3IgPT09ICJmdW5jdGlvbiIpIHRoaXMuaW50ZXJwb2xhdG9yKGludGVycG9sYXRvcik7CiAgICAgIGVsc2UgdGhpcy5yYW5nZShpbnRlcnBvbGF0b3IpOwogICAgICBicmVhazsKICAgIH0KICB9CiAgcmV0dXJuIHRoaXM7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL29yZGluYWwuanMKdmFyIGltcGxpY2l0ID0gU3ltYm9sKCJpbXBsaWNpdCIpOwpmdW5jdGlvbiBvcmRpbmFsKCkgewogIHZhciBpbmRleCA9IG5ldyBJbnRlcm5NYXAoKSwgZG9tYWluID0gW10sIHJhbmdlNCA9IFtdLCB1bmtub3duID0gaW1wbGljaXQ7CiAgZnVuY3Rpb24gc2NhbGUoZCkgewogICAgbGV0IGkgPSBpbmRleC5nZXQoZCk7CiAgICBpZiAoaSA9PT0gdm9pZCAwKSB7CiAgICAgIGlmICh1bmtub3duICE9PSBpbXBsaWNpdCkgcmV0dXJuIHVua25vd247CiAgICAgIGluZGV4LnNldChkLCBpID0gZG9tYWluLnB1c2goZCkgLSAxKTsKICAgIH0KICAgIHJldHVybiByYW5nZTRbaSAlIHJhbmdlNC5sZW5ndGhdOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBkb21haW4uc2xpY2UoKTsKICAgIGRvbWFpbiA9IFtdLCBpbmRleCA9IG5ldyBJbnRlcm5NYXAoKTsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgXykgewogICAgICBpZiAoaW5kZXguaGFzKHZhbHVlKSkgY29udGludWU7CiAgICAgIGluZGV4LnNldCh2YWx1ZSwgZG9tYWluLnB1c2godmFsdWUpIC0gMSk7CiAgICB9CiAgICByZXR1cm4gc2NhbGU7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJhbmdlNCA9IEFycmF5LmZyb20oXyksIHNjYWxlKSA6IHJhbmdlNC5zbGljZSgpOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG9yZGluYWwoZG9tYWluLCByYW5nZTQpLnVua25vd24odW5rbm93bik7CiAgfTsKICBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7CiAgcmV0dXJuIHNjYWxlOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9iYW5kLmpzCmZ1bmN0aW9uIGJhbmQoKSB7CiAgdmFyIHNjYWxlID0gb3JkaW5hbCgpLnVua25vd24odm9pZCAwKSwgZG9tYWluID0gc2NhbGUuZG9tYWluLCBvcmRpbmFsUmFuZ2UgPSBzY2FsZS5yYW5nZSwgcjAgPSAwLCByMSA9IDEsIHN0ZXAsIGJhbmR3aWR0aCwgcm91bmQgPSBmYWxzZSwgcGFkZGluZ0lubmVyID0gMCwgcGFkZGluZ091dGVyID0gMCwgYWxpZ24gPSAwLjU7CiAgZGVsZXRlIHNjYWxlLnVua25vd247CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIHZhciBuID0gZG9tYWluKCkubGVuZ3RoLCByZXZlcnNlMiA9IHIxIDwgcjAsIHN0YXJ0ID0gcmV2ZXJzZTIgPyByMSA6IHIwLCBzdG9wID0gcmV2ZXJzZTIgPyByMCA6IHIxOwogICAgc3RlcCA9IChzdG9wIC0gc3RhcnQpIC8gTWF0aC5tYXgoMSwgbiAtIHBhZGRpbmdJbm5lciArIHBhZGRpbmdPdXRlciAqIDIpOwogICAgaWYgKHJvdW5kKSBzdGVwID0gTWF0aC5mbG9vcihzdGVwKTsKICAgIHN0YXJ0ICs9IChzdG9wIC0gc3RhcnQgLSBzdGVwICogKG4gLSBwYWRkaW5nSW5uZXIpKSAqIGFsaWduOwogICAgYmFuZHdpZHRoID0gc3RlcCAqICgxIC0gcGFkZGluZ0lubmVyKTsKICAgIGlmIChyb3VuZCkgc3RhcnQgPSBNYXRoLnJvdW5kKHN0YXJ0KSwgYmFuZHdpZHRoID0gTWF0aC5yb3VuZChiYW5kd2lkdGgpOwogICAgdmFyIHZhbHVlcyA9IHJhbmdlKG4pLm1hcChmdW5jdGlvbihpKSB7CiAgICAgIHJldHVybiBzdGFydCArIHN0ZXAgKiBpOwogICAgfSk7CiAgICByZXR1cm4gb3JkaW5hbFJhbmdlKHJldmVyc2UyID8gdmFsdWVzLnJldmVyc2UoKSA6IHZhbHVlcyk7CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRvbWFpbihfKSwgcmVzY2FsZSgpKSA6IGRvbWFpbigpOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbcjAsIHIxXSA9IF8sIHIwID0gK3IwLCByMSA9ICtyMSwgcmVzY2FsZSgpKSA6IFtyMCwgcjFdOwogIH07CiAgc2NhbGUucmFuZ2VSb3VuZCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBbcjAsIHIxXSA9IF8sIHIwID0gK3IwLCByMSA9ICtyMSwgcm91bmQgPSB0cnVlLCByZXNjYWxlKCk7CiAgfTsKICBzY2FsZS5iYW5kd2lkdGggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBiYW5kd2lkdGg7CiAgfTsKICBzY2FsZS5zdGVwID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gc3RlcDsKICB9OwogIHNjYWxlLnJvdW5kID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocm91bmQgPSAhIV8sIHJlc2NhbGUoKSkgOiByb3VuZDsKICB9OwogIHNjYWxlLnBhZGRpbmcgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChwYWRkaW5nSW5uZXIgPSBNYXRoLm1pbigxLCBwYWRkaW5nT3V0ZXIgPSArXyksIHJlc2NhbGUoKSkgOiBwYWRkaW5nSW5uZXI7CiAgfTsKICBzY2FsZS5wYWRkaW5nSW5uZXIgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChwYWRkaW5nSW5uZXIgPSBNYXRoLm1pbigxLCBfKSwgcmVzY2FsZSgpKSA6IHBhZGRpbmdJbm5lcjsKICB9OwogIHNjYWxlLnBhZGRpbmdPdXRlciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHBhZGRpbmdPdXRlciA9ICtfLCByZXNjYWxlKCkpIDogcGFkZGluZ091dGVyOwogIH07CiAgc2NhbGUuYWxpZ24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChhbGlnbiA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIF8pKSwgcmVzY2FsZSgpKSA6IGFsaWduOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGJhbmQoZG9tYWluKCksIFtyMCwgcjFdKS5yb3VuZChyb3VuZCkucGFkZGluZ0lubmVyKHBhZGRpbmdJbm5lcikucGFkZGluZ091dGVyKHBhZGRpbmdPdXRlcikuYWxpZ24oYWxpZ24pOwogIH07CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShyZXNjYWxlKCksIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gcG9pbnRpc2goc2NhbGUpIHsKICB2YXIgY29weTMgPSBzY2FsZS5jb3B5OwogIHNjYWxlLnBhZGRpbmcgPSBzY2FsZS5wYWRkaW5nT3V0ZXI7CiAgZGVsZXRlIHNjYWxlLnBhZGRpbmdJbm5lcjsKICBkZWxldGUgc2NhbGUucGFkZGluZ091dGVyOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBwb2ludGlzaChjb3B5MygpKTsKICB9OwogIHJldHVybiBzY2FsZTsKfQpmdW5jdGlvbiBwb2ludDMoKSB7CiAgcmV0dXJuIHBvaW50aXNoKGJhbmQuYXBwbHkobnVsbCwgYXJndW1lbnRzKS5wYWRkaW5nSW5uZXIoMSkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtY29sb3JAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWNvbG9yL3NyYy9kZWZpbmUuanMKZnVuY3Rpb24gZGVmaW5lX2RlZmF1bHQoY29uc3RydWN0b3IsIGZhY3RvcnksIHByb3RvdHlwZSkgewogIGNvbnN0cnVjdG9yLnByb3RvdHlwZSA9IGZhY3RvcnkucHJvdG90eXBlID0gcHJvdG90eXBlOwogIHByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yOwp9CmZ1bmN0aW9uIGV4dGVuZChwYXJlbnQsIGRlZmluaXRpb24pIHsKICB2YXIgcHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShwYXJlbnQucHJvdG90eXBlKTsKICBmb3IgKHZhciBrZXkgaW4gZGVmaW5pdGlvbikgcHJvdG90eXBlW2tleV0gPSBkZWZpbml0aW9uW2tleV07CiAgcmV0dXJuIHByb3RvdHlwZTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWNvbG9yQDMuMS4wL25vZGVfbW9kdWxlcy9kMy1jb2xvci9zcmMvY29sb3IuanMKZnVuY3Rpb24gQ29sb3IoKSB7Cn0KdmFyIGRhcmtlciA9IDAuNzsKdmFyIGJyaWdodGVyID0gMSAvIGRhcmtlcjsKdmFyIHJlSSA9ICJcXHMqKFsrLV0/XFxkKylcXHMqIjsKdmFyIHJlTiA9ICJcXHMqKFsrLV0/KD86XFxkKlxcLik/XFxkKyg/OltlRV1bKy1dP1xcZCspPylcXHMqIjsKdmFyIHJlUCA9ICJcXHMqKFsrLV0/KD86XFxkKlxcLik/XFxkKyg/OltlRV1bKy1dP1xcZCspPyklXFxzKiI7CnZhciByZUhleCA9IC9eIyhbMC05YS1mXXszLDh9KSQvOwp2YXIgcmVSZ2JJbnRlZ2VyID0gbmV3IFJlZ0V4cChgXnJnYlxcKCR7cmVJfSwke3JlSX0sJHtyZUl9XFwpJGApOwp2YXIgcmVSZ2JQZXJjZW50ID0gbmV3IFJlZ0V4cChgXnJnYlxcKCR7cmVQfSwke3JlUH0sJHtyZVB9XFwpJGApOwp2YXIgcmVSZ2JhSW50ZWdlciA9IG5ldyBSZWdFeHAoYF5yZ2JhXFwoJHtyZUl9LCR7cmVJfSwke3JlSX0sJHtyZU59XFwpJGApOwp2YXIgcmVSZ2JhUGVyY2VudCA9IG5ldyBSZWdFeHAoYF5yZ2JhXFwoJHtyZVB9LCR7cmVQfSwke3JlUH0sJHtyZU59XFwpJGApOwp2YXIgcmVIc2xQZXJjZW50ID0gbmV3IFJlZ0V4cChgXmhzbFxcKCR7cmVOfSwke3JlUH0sJHtyZVB9XFwpJGApOwp2YXIgcmVIc2xhUGVyY2VudCA9IG5ldyBSZWdFeHAoYF5oc2xhXFwoJHtyZU59LCR7cmVQfSwke3JlUH0sJHtyZU59XFwpJGApOwp2YXIgbmFtZWQgPSB7CiAgYWxpY2VibHVlOiAxNTc5MjM4MywKICBhbnRpcXVld2hpdGU6IDE2NDQ0Mzc1LAogIGFxdWE6IDY1NTM1LAogIGFxdWFtYXJpbmU6IDgzODg1NjQsCiAgYXp1cmU6IDE1Nzk0MTc1LAogIGJlaWdlOiAxNjExOTI2MCwKICBiaXNxdWU6IDE2NzcwMjQ0LAogIGJsYWNrOiAwLAogIGJsYW5jaGVkYWxtb25kOiAxNjc3MjA0NSwKICBibHVlOiAyNTUsCiAgYmx1ZXZpb2xldDogOTA1NTIwMiwKICBicm93bjogMTA4MjQyMzQsCiAgYnVybHl3b29kOiAxNDU5NjIzMSwKICBjYWRldGJsdWU6IDYyNjY1MjgsCiAgY2hhcnRyZXVzZTogODM4ODM1MiwKICBjaG9jb2xhdGU6IDEzNzg5NDcwLAogIGNvcmFsOiAxNjc0NDI3MiwKICBjb3JuZmxvd2VyYmx1ZTogNjU5MTk4MSwKICBjb3Juc2lsazogMTY3NzUzODgsCiAgY3JpbXNvbjogMTQ0MjMxMDAsCiAgY3lhbjogNjU1MzUsCiAgZGFya2JsdWU6IDEzOSwKICBkYXJrY3lhbjogMzU3MjMsCiAgZGFya2dvbGRlbnJvZDogMTIwOTI5MzksCiAgZGFya2dyYXk6IDExMTE5MDE3LAogIGRhcmtncmVlbjogMjU2MDAsCiAgZGFya2dyZXk6IDExMTE5MDE3LAogIGRhcmtraGFraTogMTI0MzMyNTksCiAgZGFya21hZ2VudGE6IDkxMDk2NDMsCiAgZGFya29saXZlZ3JlZW46IDU1OTc5OTksCiAgZGFya29yYW5nZTogMTY3NDc1MjAsCiAgZGFya29yY2hpZDogMTAwNDAwMTIsCiAgZGFya3JlZDogOTEwOTUwNCwKICBkYXJrc2FsbW9uOiAxNTMwODQxMCwKICBkYXJrc2VhZ3JlZW46IDk0MTk5MTksCiAgZGFya3NsYXRlYmx1ZTogNDczNDM0NywKICBkYXJrc2xhdGVncmF5OiAzMTAwNDk1LAogIGRhcmtzbGF0ZWdyZXk6IDMxMDA0OTUsCiAgZGFya3R1cnF1b2lzZTogNTI5NDUsCiAgZGFya3Zpb2xldDogOTY5OTUzOSwKICBkZWVwcGluazogMTY3MTY5NDcsCiAgZGVlcHNreWJsdWU6IDQ5MTUxLAogIGRpbWdyYXk6IDY5MDgyNjUsCiAgZGltZ3JleTogNjkwODI2NSwKICBkb2RnZXJibHVlOiAyMDAzMTk5LAogIGZpcmVicmljazogMTE2NzQxNDYsCiAgZmxvcmFsd2hpdGU6IDE2Nzc1OTIwLAogIGZvcmVzdGdyZWVuOiAyMjYzODQyLAogIGZ1Y2hzaWE6IDE2NzExOTM1LAogIGdhaW5zYm9ybzogMTQ0NzQ0NjAsCiAgZ2hvc3R3aGl0ZTogMTYzMTY2NzEsCiAgZ29sZDogMTY3NjY3MjAsCiAgZ29sZGVucm9kOiAxNDMyOTEyMCwKICBncmF5OiA4NDIxNTA0LAogIGdyZWVuOiAzMjc2OCwKICBncmVlbnllbGxvdzogMTE0MDMwNTUsCiAgZ3JleTogODQyMTUwNCwKICBob25leWRldzogMTU3OTQxNjAsCiAgaG90cGluazogMTY3Mzg3NDAsCiAgaW5kaWFucmVkOiAxMzQ1ODUyNCwKICBpbmRpZ286IDQ5MTUzMzAsCiAgaXZvcnk6IDE2Nzc3MjAwLAogIGtoYWtpOiAxNTc4NzY2MCwKICBsYXZlbmRlcjogMTUxMzI0MTAsCiAgbGF2ZW5kZXJibHVzaDogMTY3NzMzNjUsCiAgbGF3bmdyZWVuOiA4MTkwOTc2LAogIGxlbW9uY2hpZmZvbjogMTY3NzU4ODUsCiAgbGlnaHRibHVlOiAxMTM5MzI1NCwKICBsaWdodGNvcmFsOiAxNTc2MTUzNiwKICBsaWdodGN5YW46IDE0NzQ1NTk5LAogIGxpZ2h0Z29sZGVucm9keWVsbG93OiAxNjQ0ODIxMCwKICBsaWdodGdyYXk6IDEzODgyMzIzLAogIGxpZ2h0Z3JlZW46IDk0OTgyNTYsCiAgbGlnaHRncmV5OiAxMzg4MjMyMywKICBsaWdodHBpbms6IDE2NzU4NDY1LAogIGxpZ2h0c2FsbW9uOiAxNjc1Mjc2MiwKICBsaWdodHNlYWdyZWVuOiAyMTQyODkwLAogIGxpZ2h0c2t5Ymx1ZTogODkwMDM0NiwKICBsaWdodHNsYXRlZ3JheTogNzgzMzc1MywKICBsaWdodHNsYXRlZ3JleTogNzgzMzc1MywKICBsaWdodHN0ZWVsYmx1ZTogMTE1ODQ3MzQsCiAgbGlnaHR5ZWxsb3c6IDE2Nzc3MTg0LAogIGxpbWU6IDY1MjgwLAogIGxpbWVncmVlbjogMzMyOTMzMCwKICBsaW5lbjogMTY0NDU2NzAsCiAgbWFnZW50YTogMTY3MTE5MzUsCiAgbWFyb29uOiA4Mzg4NjA4LAogIG1lZGl1bWFxdWFtYXJpbmU6IDY3MzczMjIsCiAgbWVkaXVtYmx1ZTogMjA1LAogIG1lZGl1bW9yY2hpZDogMTIyMTE2NjcsCiAgbWVkaXVtcHVycGxlOiA5NjYyNjgzLAogIG1lZGl1bXNlYWdyZWVuOiAzOTc4MDk3LAogIG1lZGl1bXNsYXRlYmx1ZTogODA4Nzc5MCwKICBtZWRpdW1zcHJpbmdncmVlbjogNjQxNTQsCiAgbWVkaXVtdHVycXVvaXNlOiA0NzcyMzAwLAogIG1lZGl1bXZpb2xldHJlZDogMTMwNDcxNzMsCiAgbWlkbmlnaHRibHVlOiAxNjQ0OTEyLAogIG1pbnRjcmVhbTogMTYxMjE4NTAsCiAgbWlzdHlyb3NlOiAxNjc3MDI3MywKICBtb2NjYXNpbjogMTY3NzAyMjksCiAgbmF2YWpvd2hpdGU6IDE2NzY4Njg1LAogIG5hdnk6IDEyOCwKICBvbGRsYWNlOiAxNjY0MzU1OCwKICBvbGl2ZTogODQyMTM3NiwKICBvbGl2ZWRyYWI6IDcwNDg3MzksCiAgb3JhbmdlOiAxNjc1MzkyMCwKICBvcmFuZ2VyZWQ6IDE2NzI5MzQ0LAogIG9yY2hpZDogMTQzMTU3MzQsCiAgcGFsZWdvbGRlbnJvZDogMTU2NTcxMzAsCiAgcGFsZWdyZWVuOiAxMDAyNTg4MCwKICBwYWxldHVycXVvaXNlOiAxMTUyOTk2NiwKICBwYWxldmlvbGV0cmVkOiAxNDM4MTIwMywKICBwYXBheWF3aGlwOiAxNjc3MzA3NywKICBwZWFjaHB1ZmY6IDE2NzY3NjczLAogIHBlcnU6IDEzNDY4OTkxLAogIHBpbms6IDE2NzYxMDM1LAogIHBsdW06IDE0NTI0NjM3LAogIHBvd2RlcmJsdWU6IDExNTkxOTEwLAogIHB1cnBsZTogODM4ODczNiwKICByZWJlY2NhcHVycGxlOiA2Njk3ODgxLAogIHJlZDogMTY3MTE2ODAsCiAgcm9zeWJyb3duOiAxMjM1NzUxOSwKICByb3lhbGJsdWU6IDQyODY5NDUsCiAgc2FkZGxlYnJvd246IDkxMjcxODcsCiAgc2FsbW9uOiAxNjQxNjg4MiwKICBzYW5keWJyb3duOiAxNjAzMjg2NCwKICBzZWFncmVlbjogMzA1MDMyNywKICBzZWFzaGVsbDogMTY3NzQ2MzgsCiAgc2llbm5hOiAxMDUwNjc5NywKICBzaWx2ZXI6IDEyNjMyMjU2LAogIHNreWJsdWU6IDg5MDAzMzEsCiAgc2xhdGVibHVlOiA2OTcwMDYxLAogIHNsYXRlZ3JheTogNzM3Mjk0NCwKICBzbGF0ZWdyZXk6IDczNzI5NDQsCiAgc25vdzogMTY3NzU5MzAsCiAgc3ByaW5nZ3JlZW46IDY1NDA3LAogIHN0ZWVsYmx1ZTogNDYyMDk4MCwKICB0YW46IDEzODA4NzgwLAogIHRlYWw6IDMyODk2LAogIHRoaXN0bGU6IDE0MjA0ODg4LAogIHRvbWF0bzogMTY3MzcwOTUsCiAgdHVycXVvaXNlOiA0MjUxODU2LAogIHZpb2xldDogMTU2MzEwODYsCiAgd2hlYXQ6IDE2MTEzMzMxLAogIHdoaXRlOiAxNjc3NzIxNSwKICB3aGl0ZXNtb2tlOiAxNjExOTI4NSwKICB5ZWxsb3c6IDE2Nzc2OTYwLAogIHllbGxvd2dyZWVuOiAxMDE0NTA3NAp9OwpkZWZpbmVfZGVmYXVsdChDb2xvciwgY29sb3IsIHsKICBjb3B5KGNoYW5uZWxzKSB7CiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLCB0aGlzLCBjaGFubmVscyk7CiAgfSwKICBkaXNwbGF5YWJsZSgpIHsKICAgIHJldHVybiB0aGlzLnJnYigpLmRpc3BsYXlhYmxlKCk7CiAgfSwKICBoZXg6IGNvbG9yX2Zvcm1hdEhleCwKICAvLyBEZXByZWNhdGVkISBVc2UgY29sb3IuZm9ybWF0SGV4LgogIGZvcm1hdEhleDogY29sb3JfZm9ybWF0SGV4LAogIGZvcm1hdEhleDg6IGNvbG9yX2Zvcm1hdEhleDgsCiAgZm9ybWF0SHNsOiBjb2xvcl9mb3JtYXRIc2wsCiAgZm9ybWF0UmdiOiBjb2xvcl9mb3JtYXRSZ2IsCiAgdG9TdHJpbmc6IGNvbG9yX2Zvcm1hdFJnYgp9KTsKZnVuY3Rpb24gY29sb3JfZm9ybWF0SGV4KCkgewogIHJldHVybiB0aGlzLnJnYigpLmZvcm1hdEhleCgpOwp9CmZ1bmN0aW9uIGNvbG9yX2Zvcm1hdEhleDgoKSB7CiAgcmV0dXJuIHRoaXMucmdiKCkuZm9ybWF0SGV4OCgpOwp9CmZ1bmN0aW9uIGNvbG9yX2Zvcm1hdEhzbCgpIHsKICByZXR1cm4gaHNsQ29udmVydCh0aGlzKS5mb3JtYXRIc2woKTsKfQpmdW5jdGlvbiBjb2xvcl9mb3JtYXRSZ2IoKSB7CiAgcmV0dXJuIHRoaXMucmdiKCkuZm9ybWF0UmdiKCk7Cn0KZnVuY3Rpb24gY29sb3IoZm9ybWF0MikgewogIHZhciBtLCBsOwogIGZvcm1hdDIgPSAoZm9ybWF0MiArICIiKS50cmltKCkudG9Mb3dlckNhc2UoKTsKICByZXR1cm4gKG0gPSByZUhleC5leGVjKGZvcm1hdDIpKSA/IChsID0gbVsxXS5sZW5ndGgsIG0gPSBwYXJzZUludChtWzFdLCAxNiksIGwgPT09IDYgPyByZ2JuKG0pIDogbCA9PT0gMyA/IG5ldyBSZ2IobSA+PiA4ICYgMTUgfCBtID4+IDQgJiAyNDAsIG0gPj4gNCAmIDE1IHwgbSAmIDI0MCwgKG0gJiAxNSkgPDwgNCB8IG0gJiAxNSwgMSkgOiBsID09PSA4ID8gcmdiYShtID4+IDI0ICYgMjU1LCBtID4+IDE2ICYgMjU1LCBtID4+IDggJiAyNTUsIChtICYgMjU1KSAvIDI1NSkgOiBsID09PSA0ID8gcmdiYShtID4+IDEyICYgMTUgfCBtID4+IDggJiAyNDAsIG0gPj4gOCAmIDE1IHwgbSA+PiA0ICYgMjQwLCBtID4+IDQgJiAxNSB8IG0gJiAyNDAsICgobSAmIDE1KSA8PCA0IHwgbSAmIDE1KSAvIDI1NSkgOiBudWxsKSA6IChtID0gcmVSZ2JJbnRlZ2VyLmV4ZWMoZm9ybWF0MikpID8gbmV3IFJnYihtWzFdLCBtWzJdLCBtWzNdLCAxKSA6IChtID0gcmVSZ2JQZXJjZW50LmV4ZWMoZm9ybWF0MikpID8gbmV3IFJnYihtWzFdICogMjU1IC8gMTAwLCBtWzJdICogMjU1IC8gMTAwLCBtWzNdICogMjU1IC8gMTAwLCAxKSA6IChtID0gcmVSZ2JhSW50ZWdlci5leGVjKGZvcm1hdDIpKSA/IHJnYmEobVsxXSwgbVsyXSwgbVszXSwgbVs0XSkgOiAobSA9IHJlUmdiYVBlcmNlbnQuZXhlYyhmb3JtYXQyKSkgPyByZ2JhKG1bMV0gKiAyNTUgLyAxMDAsIG1bMl0gKiAyNTUgLyAxMDAsIG1bM10gKiAyNTUgLyAxMDAsIG1bNF0pIDogKG0gPSByZUhzbFBlcmNlbnQuZXhlYyhmb3JtYXQyKSkgPyBoc2xhKG1bMV0sIG1bMl0gLyAxMDAsIG1bM10gLyAxMDAsIDEpIDogKG0gPSByZUhzbGFQZXJjZW50LmV4ZWMoZm9ybWF0MikpID8gaHNsYShtWzFdLCBtWzJdIC8gMTAwLCBtWzNdIC8gMTAwLCBtWzRdKSA6IG5hbWVkLmhhc093blByb3BlcnR5KGZvcm1hdDIpID8gcmdibihuYW1lZFtmb3JtYXQyXSkgOiBmb3JtYXQyID09PSAidHJhbnNwYXJlbnQiID8gbmV3IFJnYihOYU4sIE5hTiwgTmFOLCAwKSA6IG51bGw7Cn0KZnVuY3Rpb24gcmdibihuKSB7CiAgcmV0dXJuIG5ldyBSZ2IobiA+PiAxNiAmIDI1NSwgbiA+PiA4ICYgMjU1LCBuICYgMjU1LCAxKTsKfQpmdW5jdGlvbiByZ2JhKHIyLCBnLCBiLCBhKSB7CiAgaWYgKGEgPD0gMCkgcjIgPSBnID0gYiA9IE5hTjsKICByZXR1cm4gbmV3IFJnYihyMiwgZywgYiwgYSk7Cn0KZnVuY3Rpb24gcmdiQ29udmVydChvKSB7CiAgaWYgKCEobyBpbnN0YW5jZW9mIENvbG9yKSkgbyA9IGNvbG9yKG8pOwogIGlmICghbykgcmV0dXJuIG5ldyBSZ2IoKTsKICBvID0gby5yZ2IoKTsKICByZXR1cm4gbmV3IFJnYihvLnIsIG8uZywgby5iLCBvLm9wYWNpdHkpOwp9CmZ1bmN0aW9uIHJnYihyMiwgZywgYiwgb3BhY2l0eSkgewogIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID09PSAxID8gcmdiQ29udmVydChyMikgOiBuZXcgUmdiKHIyLCBnLCBiLCBvcGFjaXR5ID09IG51bGwgPyAxIDogb3BhY2l0eSk7Cn0KZnVuY3Rpb24gUmdiKHIyLCBnLCBiLCBvcGFjaXR5KSB7CiAgdGhpcy5yID0gK3IyOwogIHRoaXMuZyA9ICtnOwogIHRoaXMuYiA9ICtiOwogIHRoaXMub3BhY2l0eSA9ICtvcGFjaXR5Owp9CmRlZmluZV9kZWZhdWx0KFJnYiwgcmdiLCBleHRlbmQoQ29sb3IsIHsKICBicmlnaHRlcihrKSB7CiAgICBrID0gayA9PSBudWxsID8gYnJpZ2h0ZXIgOiBNYXRoLnBvdyhicmlnaHRlciwgayk7CiAgICByZXR1cm4gbmV3IFJnYih0aGlzLnIgKiBrLCB0aGlzLmcgKiBrLCB0aGlzLmIgKiBrLCB0aGlzLm9wYWNpdHkpOwogIH0sCiAgZGFya2VyKGspIHsKICAgIGsgPSBrID09IG51bGwgPyBkYXJrZXIgOiBNYXRoLnBvdyhkYXJrZXIsIGspOwogICAgcmV0dXJuIG5ldyBSZ2IodGhpcy5yICogaywgdGhpcy5nICogaywgdGhpcy5iICogaywgdGhpcy5vcGFjaXR5KTsKICB9LAogIHJnYigpIHsKICAgIHJldHVybiB0aGlzOwogIH0sCiAgY2xhbXAoKSB7CiAgICByZXR1cm4gbmV3IFJnYihjbGFtcGkodGhpcy5yKSwgY2xhbXBpKHRoaXMuZyksIGNsYW1waSh0aGlzLmIpLCBjbGFtcGEodGhpcy5vcGFjaXR5KSk7CiAgfSwKICBkaXNwbGF5YWJsZSgpIHsKICAgIHJldHVybiAtMC41IDw9IHRoaXMuciAmJiB0aGlzLnIgPCAyNTUuNSAmJiAoLTAuNSA8PSB0aGlzLmcgJiYgdGhpcy5nIDwgMjU1LjUpICYmICgtMC41IDw9IHRoaXMuYiAmJiB0aGlzLmIgPCAyNTUuNSkgJiYgKDAgPD0gdGhpcy5vcGFjaXR5ICYmIHRoaXMub3BhY2l0eSA8PSAxKTsKICB9LAogIGhleDogcmdiX2Zvcm1hdEhleCwKICAvLyBEZXByZWNhdGVkISBVc2UgY29sb3IuZm9ybWF0SGV4LgogIGZvcm1hdEhleDogcmdiX2Zvcm1hdEhleCwKICBmb3JtYXRIZXg4OiByZ2JfZm9ybWF0SGV4OCwKICBmb3JtYXRSZ2I6IHJnYl9mb3JtYXRSZ2IsCiAgdG9TdHJpbmc6IHJnYl9mb3JtYXRSZ2IKfSkpOwpmdW5jdGlvbiByZ2JfZm9ybWF0SGV4KCkgewogIHJldHVybiBgIyR7aGV4KHRoaXMucil9JHtoZXgodGhpcy5nKX0ke2hleCh0aGlzLmIpfWA7Cn0KZnVuY3Rpb24gcmdiX2Zvcm1hdEhleDgoKSB7CiAgcmV0dXJuIGAjJHtoZXgodGhpcy5yKX0ke2hleCh0aGlzLmcpfSR7aGV4KHRoaXMuYil9JHtoZXgoKGlzTmFOKHRoaXMub3BhY2l0eSkgPyAxIDogdGhpcy5vcGFjaXR5KSAqIDI1NSl9YDsKfQpmdW5jdGlvbiByZ2JfZm9ybWF0UmdiKCkgewogIGNvbnN0IGEgPSBjbGFtcGEodGhpcy5vcGFjaXR5KTsKICByZXR1cm4gYCR7YSA9PT0gMSA/ICJyZ2IoIiA6ICJyZ2JhKCJ9JHtjbGFtcGkodGhpcy5yKX0sICR7Y2xhbXBpKHRoaXMuZyl9LCAke2NsYW1waSh0aGlzLmIpfSR7YSA9PT0gMSA/ICIpIiA6IGAsICR7YX0pYH1gOwp9CmZ1bmN0aW9uIGNsYW1wYShvcGFjaXR5KSB7CiAgcmV0dXJuIGlzTmFOKG9wYWNpdHkpID8gMSA6IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIG9wYWNpdHkpKTsKfQpmdW5jdGlvbiBjbGFtcGkodmFsdWUpIHsKICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oMjU1LCBNYXRoLnJvdW5kKHZhbHVlKSB8fCAwKSk7Cn0KZnVuY3Rpb24gaGV4KHZhbHVlKSB7CiAgdmFsdWUgPSBjbGFtcGkodmFsdWUpOwogIHJldHVybiAodmFsdWUgPCAxNiA/ICIwIiA6ICIiKSArIHZhbHVlLnRvU3RyaW5nKDE2KTsKfQpmdW5jdGlvbiBoc2xhKGgsIHMsIGwsIGEpIHsKICBpZiAoYSA8PSAwKSBoID0gcyA9IGwgPSBOYU47CiAgZWxzZSBpZiAobCA8PSAwIHx8IGwgPj0gMSkgaCA9IHMgPSBOYU47CiAgZWxzZSBpZiAocyA8PSAwKSBoID0gTmFOOwogIHJldHVybiBuZXcgSHNsKGgsIHMsIGwsIGEpOwp9CmZ1bmN0aW9uIGhzbENvbnZlcnQobykgewogIGlmIChvIGluc3RhbmNlb2YgSHNsKSByZXR1cm4gbmV3IEhzbChvLmgsIG8ucywgby5sLCBvLm9wYWNpdHkpOwogIGlmICghKG8gaW5zdGFuY2VvZiBDb2xvcikpIG8gPSBjb2xvcihvKTsKICBpZiAoIW8pIHJldHVybiBuZXcgSHNsKCk7CiAgaWYgKG8gaW5zdGFuY2VvZiBIc2wpIHJldHVybiBvOwogIG8gPSBvLnJnYigpOwogIHZhciByMiA9IG8uciAvIDI1NSwgZyA9IG8uZyAvIDI1NSwgYiA9IG8uYiAvIDI1NSwgbWluMiA9IE1hdGgubWluKHIyLCBnLCBiKSwgbWF4MiA9IE1hdGgubWF4KHIyLCBnLCBiKSwgaCA9IE5hTiwgcyA9IG1heDIgLSBtaW4yLCBsID0gKG1heDIgKyBtaW4yKSAvIDI7CiAgaWYgKHMpIHsKICAgIGlmIChyMiA9PT0gbWF4MikgaCA9IChnIC0gYikgLyBzICsgKGcgPCBiKSAqIDY7CiAgICBlbHNlIGlmIChnID09PSBtYXgyKSBoID0gKGIgLSByMikgLyBzICsgMjsKICAgIGVsc2UgaCA9IChyMiAtIGcpIC8gcyArIDQ7CiAgICBzIC89IGwgPCAwLjUgPyBtYXgyICsgbWluMiA6IDIgLSBtYXgyIC0gbWluMjsKICAgIGggKj0gNjA7CiAgfSBlbHNlIHsKICAgIHMgPSBsID4gMCAmJiBsIDwgMSA/IDAgOiBoOwogIH0KICByZXR1cm4gbmV3IEhzbChoLCBzLCBsLCBvLm9wYWNpdHkpOwp9CmZ1bmN0aW9uIGhzbChoLCBzLCBsLCBvcGFjaXR5KSB7CiAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyBoc2xDb252ZXJ0KGgpIDogbmV3IEhzbChoLCBzLCBsLCBvcGFjaXR5ID09IG51bGwgPyAxIDogb3BhY2l0eSk7Cn0KZnVuY3Rpb24gSHNsKGgsIHMsIGwsIG9wYWNpdHkpIHsKICB0aGlzLmggPSAraDsKICB0aGlzLnMgPSArczsKICB0aGlzLmwgPSArbDsKICB0aGlzLm9wYWNpdHkgPSArb3BhY2l0eTsKfQpkZWZpbmVfZGVmYXVsdChIc2wsIGhzbCwgZXh0ZW5kKENvbG9yLCB7CiAgYnJpZ2h0ZXIoaykgewogICAgayA9IGsgPT0gbnVsbCA/IGJyaWdodGVyIDogTWF0aC5wb3coYnJpZ2h0ZXIsIGspOwogICAgcmV0dXJuIG5ldyBIc2wodGhpcy5oLCB0aGlzLnMsIHRoaXMubCAqIGssIHRoaXMub3BhY2l0eSk7CiAgfSwKICBkYXJrZXIoaykgewogICAgayA9IGsgPT0gbnVsbCA/IGRhcmtlciA6IE1hdGgucG93KGRhcmtlciwgayk7CiAgICByZXR1cm4gbmV3IEhzbCh0aGlzLmgsIHRoaXMucywgdGhpcy5sICogaywgdGhpcy5vcGFjaXR5KTsKICB9LAogIHJnYigpIHsKICAgIHZhciBoID0gdGhpcy5oICUgMzYwICsgKHRoaXMuaCA8IDApICogMzYwLCBzID0gaXNOYU4oaCkgfHwgaXNOYU4odGhpcy5zKSA/IDAgOiB0aGlzLnMsIGwgPSB0aGlzLmwsIG0yID0gbCArIChsIDwgMC41ID8gbCA6IDEgLSBsKSAqIHMsIG0xID0gMiAqIGwgLSBtMjsKICAgIHJldHVybiBuZXcgUmdiKAogICAgICBoc2wycmdiKGggPj0gMjQwID8gaCAtIDI0MCA6IGggKyAxMjAsIG0xLCBtMiksCiAgICAgIGhzbDJyZ2IoaCwgbTEsIG0yKSwKICAgICAgaHNsMnJnYihoIDwgMTIwID8gaCArIDI0MCA6IGggLSAxMjAsIG0xLCBtMiksCiAgICAgIHRoaXMub3BhY2l0eQogICAgKTsKICB9LAogIGNsYW1wKCkgewogICAgcmV0dXJuIG5ldyBIc2woY2xhbXBoKHRoaXMuaCksIGNsYW1wdCh0aGlzLnMpLCBjbGFtcHQodGhpcy5sKSwgY2xhbXBhKHRoaXMub3BhY2l0eSkpOwogIH0sCiAgZGlzcGxheWFibGUoKSB7CiAgICByZXR1cm4gKDAgPD0gdGhpcy5zICYmIHRoaXMucyA8PSAxIHx8IGlzTmFOKHRoaXMucykpICYmICgwIDw9IHRoaXMubCAmJiB0aGlzLmwgPD0gMSkgJiYgKDAgPD0gdGhpcy5vcGFjaXR5ICYmIHRoaXMub3BhY2l0eSA8PSAxKTsKICB9LAogIGZvcm1hdEhzbCgpIHsKICAgIGNvbnN0IGEgPSBjbGFtcGEodGhpcy5vcGFjaXR5KTsKICAgIHJldHVybiBgJHthID09PSAxID8gImhzbCgiIDogImhzbGEoIn0ke2NsYW1waCh0aGlzLmgpfSwgJHtjbGFtcHQodGhpcy5zKSAqIDEwMH0lLCAke2NsYW1wdCh0aGlzLmwpICogMTAwfSUke2EgPT09IDEgPyAiKSIgOiBgLCAke2F9KWB9YDsKICB9Cn0pKTsKZnVuY3Rpb24gY2xhbXBoKHZhbHVlKSB7CiAgdmFsdWUgPSAodmFsdWUgfHwgMCkgJSAzNjA7CiAgcmV0dXJuIHZhbHVlIDwgMCA/IHZhbHVlICsgMzYwIDogdmFsdWU7Cn0KZnVuY3Rpb24gY2xhbXB0KHZhbHVlKSB7CiAgcmV0dXJuIE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHZhbHVlIHx8IDApKTsKfQpmdW5jdGlvbiBoc2wycmdiKGgsIG0xLCBtMikgewogIHJldHVybiAoaCA8IDYwID8gbTEgKyAobTIgLSBtMSkgKiBoIC8gNjAgOiBoIDwgMTgwID8gbTIgOiBoIDwgMjQwID8gbTEgKyAobTIgLSBtMSkgKiAoMjQwIC0gaCkgLyA2MCA6IG0xKSAqIDI1NTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWludGVycG9sYXRlQDMuMC4xL25vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvYmFzaXMuanMKZnVuY3Rpb24gYmFzaXModDEyLCB2MCwgdjEsIHYyLCB2MykgewogIHZhciB0MiA9IHQxMiAqIHQxMiwgdDMgPSB0MiAqIHQxMjsKICByZXR1cm4gKCgxIC0gMyAqIHQxMiArIDMgKiB0MiAtIHQzKSAqIHYwICsgKDQgLSA2ICogdDIgKyAzICogdDMpICogdjEgKyAoMSArIDMgKiB0MTIgKyAzICogdDIgLSAzICogdDMpICogdjIgKyB0MyAqIHYzKSAvIDY7Cn0KZnVuY3Rpb24gYmFzaXNfZGVmYXVsdDIodmFsdWVzKSB7CiAgdmFyIG4gPSB2YWx1ZXMubGVuZ3RoIC0gMTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgdmFyIGkgPSB0IDw9IDAgPyB0ID0gMCA6IHQgPj0gMSA/ICh0ID0gMSwgbiAtIDEpIDogTWF0aC5mbG9vcih0ICogbiksIHYxID0gdmFsdWVzW2ldLCB2MiA9IHZhbHVlc1tpICsgMV0sIHYwID0gaSA+IDAgPyB2YWx1ZXNbaSAtIDFdIDogMiAqIHYxIC0gdjIsIHYzID0gaSA8IG4gLSAxID8gdmFsdWVzW2kgKyAyXSA6IDIgKiB2MiAtIHYxOwogICAgcmV0dXJuIGJhc2lzKCh0IC0gaSAvIG4pICogbiwgdjAsIHYxLCB2MiwgdjMpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1pbnRlcnBvbGF0ZUAzLjAuMS9ub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2Jhc2lzQ2xvc2VkLmpzCmZ1bmN0aW9uIGJhc2lzQ2xvc2VkX2RlZmF1bHQyKHZhbHVlcykgewogIHZhciBuID0gdmFsdWVzLmxlbmd0aDsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgdmFyIGkgPSBNYXRoLmZsb29yKCgodCAlPSAxKSA8IDAgPyArK3QgOiB0KSAqIG4pLCB2MCA9IHZhbHVlc1soaSArIG4gLSAxKSAlIG5dLCB2MSA9IHZhbHVlc1tpICUgbl0sIHYyID0gdmFsdWVzWyhpICsgMSkgJSBuXSwgdjMgPSB2YWx1ZXNbKGkgKyAyKSAlIG5dOwogICAgcmV0dXJuIGJhc2lzKCh0IC0gaSAvIG4pICogbiwgdjAsIHYxLCB2MiwgdjMpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1pbnRlcnBvbGF0ZUAzLjAuMS9ub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2NvbnN0YW50LmpzCnZhciBjb25zdGFudF9kZWZhdWx0MiA9ICh4MikgPT4gKCkgPT4geDI7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9jb2xvci5qcwpmdW5jdGlvbiBsaW5lYXIoYSwgZCkgewogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gYSArIHQgKiBkOwogIH07Cn0KZnVuY3Rpb24gZXhwb25lbnRpYWwoYSwgYiwgeTIpIHsKICByZXR1cm4gYSA9IE1hdGgucG93KGEsIHkyKSwgYiA9IE1hdGgucG93KGIsIHkyKSAtIGEsIHkyID0gMSAvIHkyLCBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gTWF0aC5wb3coYSArIHQgKiBiLCB5Mik7CiAgfTsKfQpmdW5jdGlvbiBnYW1tYSh5MikgewogIHJldHVybiAoeTIgPSAreTIpID09PSAxID8gbm9nYW1tYSA6IGZ1bmN0aW9uKGEsIGIpIHsKICAgIHJldHVybiBiIC0gYSA/IGV4cG9uZW50aWFsKGEsIGIsIHkyKSA6IGNvbnN0YW50X2RlZmF1bHQyKGlzTmFOKGEpID8gYiA6IGEpOwogIH07Cn0KZnVuY3Rpb24gbm9nYW1tYShhLCBiKSB7CiAgdmFyIGQgPSBiIC0gYTsKICByZXR1cm4gZCA/IGxpbmVhcihhLCBkKSA6IGNvbnN0YW50X2RlZmF1bHQyKGlzTmFOKGEpID8gYiA6IGEpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9yZ2IuanMKdmFyIHJnYl9kZWZhdWx0ID0gZnVuY3Rpb24gcmdiR2FtbWEoeTIpIHsKICB2YXIgY29sb3IyID0gZ2FtbWEoeTIpOwogIGZ1bmN0aW9uIHJnYjIoc3RhcnQsIGVuZCkgewogICAgdmFyIHIyID0gY29sb3IyKChzdGFydCA9IHJnYihzdGFydCkpLnIsIChlbmQgPSByZ2IoZW5kKSkuciksIGcgPSBjb2xvcjIoc3RhcnQuZywgZW5kLmcpLCBiID0gY29sb3IyKHN0YXJ0LmIsIGVuZC5iKSwgb3BhY2l0eSA9IG5vZ2FtbWEoc3RhcnQub3BhY2l0eSwgZW5kLm9wYWNpdHkpOwogICAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgc3RhcnQuciA9IHIyKHQpOwogICAgICBzdGFydC5nID0gZyh0KTsKICAgICAgc3RhcnQuYiA9IGIodCk7CiAgICAgIHN0YXJ0Lm9wYWNpdHkgPSBvcGFjaXR5KHQpOwogICAgICByZXR1cm4gc3RhcnQgKyAiIjsKICAgIH07CiAgfQogIHJnYjIuZ2FtbWEgPSByZ2JHYW1tYTsKICByZXR1cm4gcmdiMjsKfSgxKTsKZnVuY3Rpb24gcmdiU3BsaW5lKHNwbGluZSkgewogIHJldHVybiBmdW5jdGlvbihjb2xvcnMpIHsKICAgIHZhciBuID0gY29sb3JzLmxlbmd0aCwgcjIgPSBuZXcgQXJyYXkobiksIGcgPSBuZXcgQXJyYXkobiksIGIgPSBuZXcgQXJyYXkobiksIGksIGNvbG9yMjsKICAgIGZvciAoaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgY29sb3IyID0gcmdiKGNvbG9yc1tpXSk7CiAgICAgIHIyW2ldID0gY29sb3IyLnIgfHwgMDsKICAgICAgZ1tpXSA9IGNvbG9yMi5nIHx8IDA7CiAgICAgIGJbaV0gPSBjb2xvcjIuYiB8fCAwOwogICAgfQogICAgcjIgPSBzcGxpbmUocjIpOwogICAgZyA9IHNwbGluZShnKTsKICAgIGIgPSBzcGxpbmUoYik7CiAgICBjb2xvcjIub3BhY2l0eSA9IDE7CiAgICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgICBjb2xvcjIuciA9IHIyKHQpOwogICAgICBjb2xvcjIuZyA9IGcodCk7CiAgICAgIGNvbG9yMi5iID0gYih0KTsKICAgICAgcmV0dXJuIGNvbG9yMiArICIiOwogICAgfTsKICB9Owp9CnZhciByZ2JCYXNpcyA9IHJnYlNwbGluZShiYXNpc19kZWZhdWx0Mik7CnZhciByZ2JCYXNpc0Nsb3NlZCA9IHJnYlNwbGluZShiYXNpc0Nsb3NlZF9kZWZhdWx0Mik7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9udW1iZXJBcnJheS5qcwpmdW5jdGlvbiBudW1iZXJBcnJheV9kZWZhdWx0KGEsIGIpIHsKICBpZiAoIWIpIGIgPSBbXTsKICB2YXIgbiA9IGEgPyBNYXRoLm1pbihiLmxlbmd0aCwgYS5sZW5ndGgpIDogMCwgYyA9IGIuc2xpY2UoKSwgaTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgZm9yIChpID0gMDsgaSA8IG47ICsraSkgY1tpXSA9IGFbaV0gKiAoMSAtIHQpICsgYltpXSAqIHQ7CiAgICByZXR1cm4gYzsKICB9Owp9CmZ1bmN0aW9uIGlzTnVtYmVyQXJyYXkoeDIpIHsKICByZXR1cm4gQXJyYXlCdWZmZXIuaXNWaWV3KHgyKSAmJiAhKHgyIGluc3RhbmNlb2YgRGF0YVZpZXcpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9hcnJheS5qcwpmdW5jdGlvbiBnZW5lcmljQXJyYXkoYSwgYikgewogIHZhciBuYiA9IGIgPyBiLmxlbmd0aCA6IDAsIG5hID0gYSA/IE1hdGgubWluKG5iLCBhLmxlbmd0aCkgOiAwLCB4MiA9IG5ldyBBcnJheShuYSksIGMgPSBuZXcgQXJyYXkobmIpLCBpOwogIGZvciAoaSA9IDA7IGkgPCBuYTsgKytpKSB4MltpXSA9IHZhbHVlX2RlZmF1bHQoYVtpXSwgYltpXSk7CiAgZm9yICg7IGkgPCBuYjsgKytpKSBjW2ldID0gYltpXTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgZm9yIChpID0gMDsgaSA8IG5hOyArK2kpIGNbaV0gPSB4MltpXSh0KTsKICAgIHJldHVybiBjOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1pbnRlcnBvbGF0ZUAzLjAuMS9ub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2RhdGUuanMKZnVuY3Rpb24gZGF0ZV9kZWZhdWx0KGEsIGIpIHsKICB2YXIgZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwogIHJldHVybiBhID0gK2EsIGIgPSArYiwgZnVuY3Rpb24odCkgewogICAgcmV0dXJuIGQuc2V0VGltZShhICogKDEgLSB0KSArIGIgKiB0KSwgZDsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9udW1iZXIuanMKZnVuY3Rpb24gbnVtYmVyX2RlZmF1bHQoYSwgYikgewogIHJldHVybiBhID0gK2EsIGIgPSArYiwgZnVuY3Rpb24odCkgewogICAgcmV0dXJuIGEgKiAoMSAtIHQpICsgYiAqIHQ7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWludGVycG9sYXRlQDMuMC4xL25vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvb2JqZWN0LmpzCmZ1bmN0aW9uIG9iamVjdF9kZWZhdWx0KGEsIGIpIHsKICB2YXIgaSA9IHt9LCBjID0ge30sIGs7CiAgaWYgKGEgPT09IG51bGwgfHwgdHlwZW9mIGEgIT09ICJvYmplY3QiKSBhID0ge307CiAgaWYgKGIgPT09IG51bGwgfHwgdHlwZW9mIGIgIT09ICJvYmplY3QiKSBiID0ge307CiAgZm9yIChrIGluIGIpIHsKICAgIGlmIChrIGluIGEpIHsKICAgICAgaVtrXSA9IHZhbHVlX2RlZmF1bHQoYVtrXSwgYltrXSk7CiAgICB9IGVsc2UgewogICAgICBjW2tdID0gYltrXTsKICAgIH0KICB9CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIGZvciAoayBpbiBpKSBjW2tdID0gaVtrXSh0KTsKICAgIHJldHVybiBjOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1pbnRlcnBvbGF0ZUAzLjAuMS9ub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL3N0cmluZy5qcwp2YXIgcmVBID0gL1stK10/KD86XGQrXC4/XGQqfFwuP1xkKykoPzpbZUVdWy0rXT9cZCspPy9nOwp2YXIgcmVCID0gbmV3IFJlZ0V4cChyZUEuc291cmNlLCAiZyIpOwpmdW5jdGlvbiB6ZXJvMihiKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGI7CiAgfTsKfQpmdW5jdGlvbiBvbmUoYikgewogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gYih0KSArICIiOwogIH07Cn0KZnVuY3Rpb24gc3RyaW5nX2RlZmF1bHQoYSwgYikgewogIHZhciBiaSA9IHJlQS5sYXN0SW5kZXggPSByZUIubGFzdEluZGV4ID0gMCwgYW0sIGJtLCBicywgaSA9IC0xLCBzID0gW10sIHEgPSBbXTsKICBhID0gYSArICIiLCBiID0gYiArICIiOwogIHdoaWxlICgoYW0gPSByZUEuZXhlYyhhKSkgJiYgKGJtID0gcmVCLmV4ZWMoYikpKSB7CiAgICBpZiAoKGJzID0gYm0uaW5kZXgpID4gYmkpIHsKICAgICAgYnMgPSBiLnNsaWNlKGJpLCBicyk7CiAgICAgIGlmIChzW2ldKSBzW2ldICs9IGJzOwogICAgICBlbHNlIHNbKytpXSA9IGJzOwogICAgfQogICAgaWYgKChhbSA9IGFtWzBdKSA9PT0gKGJtID0gYm1bMF0pKSB7CiAgICAgIGlmIChzW2ldKSBzW2ldICs9IGJtOwogICAgICBlbHNlIHNbKytpXSA9IGJtOwogICAgfSBlbHNlIHsKICAgICAgc1srK2ldID0gbnVsbDsKICAgICAgcS5wdXNoKHsgaSwgeDogbnVtYmVyX2RlZmF1bHQoYW0sIGJtKSB9KTsKICAgIH0KICAgIGJpID0gcmVCLmxhc3RJbmRleDsKICB9CiAgaWYgKGJpIDwgYi5sZW5ndGgpIHsKICAgIGJzID0gYi5zbGljZShiaSk7CiAgICBpZiAoc1tpXSkgc1tpXSArPSBiczsKICAgIGVsc2Ugc1srK2ldID0gYnM7CiAgfQogIHJldHVybiBzLmxlbmd0aCA8IDIgPyBxWzBdID8gb25lKHFbMF0ueCkgOiB6ZXJvMihiKSA6IChiID0gcS5sZW5ndGgsIGZ1bmN0aW9uKHQpIHsKICAgIGZvciAodmFyIGkyID0gMCwgbzsgaTIgPCBiOyArK2kyKSBzWyhvID0gcVtpMl0pLmldID0gby54KHQpOwogICAgcmV0dXJuIHMuam9pbigiIik7CiAgfSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1pbnRlcnBvbGF0ZUAzLjAuMS9ub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL3ZhbHVlLmpzCmZ1bmN0aW9uIHZhbHVlX2RlZmF1bHQoYSwgYikgewogIHZhciB0ID0gdHlwZW9mIGIsIGM7CiAgcmV0dXJuIGIgPT0gbnVsbCB8fCB0ID09PSAiYm9vbGVhbiIgPyBjb25zdGFudF9kZWZhdWx0MihiKSA6ICh0ID09PSAibnVtYmVyIiA/IG51bWJlcl9kZWZhdWx0IDogdCA9PT0gInN0cmluZyIgPyAoYyA9IGNvbG9yKGIpKSA/IChiID0gYywgcmdiX2RlZmF1bHQpIDogc3RyaW5nX2RlZmF1bHQgOiBiIGluc3RhbmNlb2YgY29sb3IgPyByZ2JfZGVmYXVsdCA6IGIgaW5zdGFuY2VvZiBEYXRlID8gZGF0ZV9kZWZhdWx0IDogaXNOdW1iZXJBcnJheShiKSA/IG51bWJlckFycmF5X2RlZmF1bHQgOiBBcnJheS5pc0FycmF5KGIpID8gZ2VuZXJpY0FycmF5IDogdHlwZW9mIGIudmFsdWVPZiAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgYi50b1N0cmluZyAhPT0gImZ1bmN0aW9uIiB8fCBpc05hTihiKSA/IG9iamVjdF9kZWZhdWx0IDogbnVtYmVyX2RlZmF1bHQpKGEsIGIpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9yb3VuZC5qcwpmdW5jdGlvbiByb3VuZF9kZWZhdWx0KGEsIGIpIHsKICByZXR1cm4gYSA9ICthLCBiID0gK2IsIGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiBNYXRoLnJvdW5kKGEgKiAoMSAtIHQpICsgYiAqIHQpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1pbnRlcnBvbGF0ZUAzLjAuMS9ub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL3BpZWNld2lzZS5qcwpmdW5jdGlvbiBwaWVjZXdpc2UoaW50ZXJwb2xhdGUyLCB2YWx1ZXMpIHsKICBpZiAodmFsdWVzID09PSB2b2lkIDApIHZhbHVlcyA9IGludGVycG9sYXRlMiwgaW50ZXJwb2xhdGUyID0gdmFsdWVfZGVmYXVsdDsKICB2YXIgaSA9IDAsIG4gPSB2YWx1ZXMubGVuZ3RoIC0gMSwgdiA9IHZhbHVlc1swXSwgSSA9IG5ldyBBcnJheShuIDwgMCA/IDAgOiBuKTsKICB3aGlsZSAoaSA8IG4pIElbaV0gPSBpbnRlcnBvbGF0ZTIodiwgdiA9IHZhbHVlc1srK2ldKTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgdmFyIGkyID0gTWF0aC5tYXgoMCwgTWF0aC5taW4obiAtIDEsIE1hdGguZmxvb3IodCAqPSBuKSkpOwogICAgcmV0dXJuIElbaTJdKHQgLSBpMik7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvY29uc3RhbnQuanMKZnVuY3Rpb24gY29uc3RhbnRzKHgyKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHgyOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL251bWJlci5qcwpmdW5jdGlvbiBudW1iZXIyKHgyKSB7CiAgcmV0dXJuICt4MjsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvY29udGludW91cy5qcwp2YXIgdW5pdCA9IFswLCAxXTsKZnVuY3Rpb24gaWRlbnRpdHkoeDIpIHsKICByZXR1cm4geDI7Cn0KZnVuY3Rpb24gbm9ybWFsaXplKGEsIGIpIHsKICByZXR1cm4gKGIgLT0gYSA9ICthKSA/IGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4gKHgyIC0gYSkgLyBiOwogIH0gOiBjb25zdGFudHMoaXNOYU4oYikgPyBOYU4gOiAwLjUpOwp9CmZ1bmN0aW9uIGNsYW1wZXIoYSwgYikgewogIHZhciB0OwogIGlmIChhID4gYikgdCA9IGEsIGEgPSBiLCBiID0gdDsKICByZXR1cm4gZnVuY3Rpb24oeDIpIHsKICAgIHJldHVybiBNYXRoLm1heChhLCBNYXRoLm1pbihiLCB4MikpOwogIH07Cn0KZnVuY3Rpb24gYmltYXAoZG9tYWluLCByYW5nZTQsIGludGVycG9sYXRlMikgewogIHZhciBkMCA9IGRvbWFpblswXSwgZDEgPSBkb21haW5bMV0sIHIwID0gcmFuZ2U0WzBdLCByMSA9IHJhbmdlNFsxXTsKICBpZiAoZDEgPCBkMCkgZDAgPSBub3JtYWxpemUoZDEsIGQwKSwgcjAgPSBpbnRlcnBvbGF0ZTIocjEsIHIwKTsKICBlbHNlIGQwID0gbm9ybWFsaXplKGQwLCBkMSksIHIwID0gaW50ZXJwb2xhdGUyKHIwLCByMSk7CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4gcjAoZDAoeDIpKTsKICB9Owp9CmZ1bmN0aW9uIHBvbHltYXAoZG9tYWluLCByYW5nZTQsIGludGVycG9sYXRlMikgewogIHZhciBqID0gTWF0aC5taW4oZG9tYWluLmxlbmd0aCwgcmFuZ2U0Lmxlbmd0aCkgLSAxLCBkID0gbmV3IEFycmF5KGopLCByMiA9IG5ldyBBcnJheShqKSwgaSA9IC0xOwogIGlmIChkb21haW5bal0gPCBkb21haW5bMF0pIHsKICAgIGRvbWFpbiA9IGRvbWFpbi5zbGljZSgpLnJldmVyc2UoKTsKICAgIHJhbmdlNCA9IHJhbmdlNC5zbGljZSgpLnJldmVyc2UoKTsKICB9CiAgd2hpbGUgKCsraSA8IGopIHsKICAgIGRbaV0gPSBub3JtYWxpemUoZG9tYWluW2ldLCBkb21haW5baSArIDFdKTsKICAgIHIyW2ldID0gaW50ZXJwb2xhdGUyKHJhbmdlNFtpXSwgcmFuZ2U0W2kgKyAxXSk7CiAgfQogIHJldHVybiBmdW5jdGlvbih4MikgewogICAgdmFyIGkyID0gYmlzZWN0X2RlZmF1bHQoZG9tYWluLCB4MiwgMSwgaikgLSAxOwogICAgcmV0dXJuIHIyW2kyXShkW2kyXSh4MikpOwogIH07Cn0KZnVuY3Rpb24gY29weShzb3VyY2UsIHRhcmdldCkgewogIHJldHVybiB0YXJnZXQuZG9tYWluKHNvdXJjZS5kb21haW4oKSkucmFuZ2Uoc291cmNlLnJhbmdlKCkpLmludGVycG9sYXRlKHNvdXJjZS5pbnRlcnBvbGF0ZSgpKS5jbGFtcChzb3VyY2UuY2xhbXAoKSkudW5rbm93bihzb3VyY2UudW5rbm93bigpKTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1lcigpIHsKICB2YXIgZG9tYWluID0gdW5pdCwgcmFuZ2U0ID0gdW5pdCwgaW50ZXJwb2xhdGUyID0gdmFsdWVfZGVmYXVsdCwgdHJhbnNmb3JtLCB1bnRyYW5zZm9ybSwgdW5rbm93biwgY2xhbXAgPSBpZGVudGl0eSwgcGllY2V3aXNlMiwgb3V0cHV0LCBpbnB1dDsKICBmdW5jdGlvbiByZXNjYWxlKCkgewogICAgdmFyIG4gPSBNYXRoLm1pbihkb21haW4ubGVuZ3RoLCByYW5nZTQubGVuZ3RoKTsKICAgIGlmIChjbGFtcCAhPT0gaWRlbnRpdHkpIGNsYW1wID0gY2xhbXBlcihkb21haW5bMF0sIGRvbWFpbltuIC0gMV0pOwogICAgcGllY2V3aXNlMiA9IG4gPiAyID8gcG9seW1hcCA6IGJpbWFwOwogICAgb3V0cHV0ID0gaW5wdXQgPSBudWxsOwogICAgcmV0dXJuIHNjYWxlOwogIH0KICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgcmV0dXJuIHgyID09IG51bGwgfHwgaXNOYU4oeDIgPSAreDIpID8gdW5rbm93biA6IChvdXRwdXQgfHwgKG91dHB1dCA9IHBpZWNld2lzZTIoZG9tYWluLm1hcCh0cmFuc2Zvcm0pLCByYW5nZTQsIGludGVycG9sYXRlMikpKSh0cmFuc2Zvcm0oY2xhbXAoeDIpKSk7CiAgfQogIHNjYWxlLmludmVydCA9IGZ1bmN0aW9uKHkyKSB7CiAgICByZXR1cm4gY2xhbXAodW50cmFuc2Zvcm0oKGlucHV0IHx8IChpbnB1dCA9IHBpZWNld2lzZTIocmFuZ2U0LCBkb21haW4ubWFwKHRyYW5zZm9ybSksIG51bWJlcl9kZWZhdWx0KSkpKHkyKSkpOwogIH07CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZG9tYWluID0gQXJyYXkuZnJvbShfLCBudW1iZXIyKSwgcmVzY2FsZSgpKSA6IGRvbWFpbi5zbGljZSgpOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyYW5nZTQgPSBBcnJheS5mcm9tKF8pLCByZXNjYWxlKCkpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS5yYW5nZVJvdW5kID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIHJhbmdlNCA9IEFycmF5LmZyb20oXyksIGludGVycG9sYXRlMiA9IHJvdW5kX2RlZmF1bHQsIHJlc2NhbGUoKTsKICB9OwogIHNjYWxlLmNsYW1wID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoY2xhbXAgPSBfID8gdHJ1ZSA6IGlkZW50aXR5LCByZXNjYWxlKCkpIDogY2xhbXAgIT09IGlkZW50aXR5OwogIH07CiAgc2NhbGUuaW50ZXJwb2xhdGUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChpbnRlcnBvbGF0ZTIgPSBfLCByZXNjYWxlKCkpIDogaW50ZXJwb2xhdGUyOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgcmV0dXJuIGZ1bmN0aW9uKHQsIHUpIHsKICAgIHRyYW5zZm9ybSA9IHQsIHVudHJhbnNmb3JtID0gdTsKICAgIHJldHVybiByZXNjYWxlKCk7CiAgfTsKfQpmdW5jdGlvbiBjb250aW51b3VzKCkgewogIHJldHVybiB0cmFuc2Zvcm1lcigpKGlkZW50aXR5LCBpZGVudGl0eSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1mb3JtYXRAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0RGVjaW1hbC5qcwpmdW5jdGlvbiBmb3JtYXREZWNpbWFsX2RlZmF1bHQoeDIpIHsKICByZXR1cm4gTWF0aC5hYnMoeDIgPSBNYXRoLnJvdW5kKHgyKSkgPj0gMWUyMSA/IHgyLnRvTG9jYWxlU3RyaW5nKCJlbiIpLnJlcGxhY2UoLywvZywgIiIpIDogeDIudG9TdHJpbmcoMTApOwp9CmZ1bmN0aW9uIGZvcm1hdERlY2ltYWxQYXJ0cyh4MiwgcCkgewogIGlmICgoaSA9ICh4MiA9IHAgPyB4Mi50b0V4cG9uZW50aWFsKHAgLSAxKSA6IHgyLnRvRXhwb25lbnRpYWwoKSkuaW5kZXhPZigiZSIpKSA8IDApIHJldHVybiBudWxsOwogIHZhciBpLCBjb2VmZmljaWVudCA9IHgyLnNsaWNlKDAsIGkpOwogIHJldHVybiBbCiAgICBjb2VmZmljaWVudC5sZW5ndGggPiAxID8gY29lZmZpY2llbnRbMF0gKyBjb2VmZmljaWVudC5zbGljZSgyKSA6IGNvZWZmaWNpZW50LAogICAgK3gyLnNsaWNlKGkgKyAxKQogIF07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1mb3JtYXRAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZXhwb25lbnQuanMKZnVuY3Rpb24gZXhwb25lbnRfZGVmYXVsdCh4MikgewogIHJldHVybiB4MiA9IGZvcm1hdERlY2ltYWxQYXJ0cyhNYXRoLmFicyh4MikpLCB4MiA/IHgyWzFdIDogTmFOOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdEdyb3VwLmpzCmZ1bmN0aW9uIGZvcm1hdEdyb3VwX2RlZmF1bHQoZ3JvdXBpbmcsIHRob3VzYW5kcykgewogIHJldHVybiBmdW5jdGlvbih2YWx1ZSwgd2lkdGgpIHsKICAgIHZhciBpID0gdmFsdWUubGVuZ3RoLCB0ID0gW10sIGogPSAwLCBnID0gZ3JvdXBpbmdbMF0sIGxlbmd0aCA9IDA7CiAgICB3aGlsZSAoaSA+IDAgJiYgZyA+IDApIHsKICAgICAgaWYgKGxlbmd0aCArIGcgKyAxID4gd2lkdGgpIGcgPSBNYXRoLm1heCgxLCB3aWR0aCAtIGxlbmd0aCk7CiAgICAgIHQucHVzaCh2YWx1ZS5zdWJzdHJpbmcoaSAtPSBnLCBpICsgZykpOwogICAgICBpZiAoKGxlbmd0aCArPSBnICsgMSkgPiB3aWR0aCkgYnJlYWs7CiAgICAgIGcgPSBncm91cGluZ1tqID0gKGogKyAxKSAlIGdyb3VwaW5nLmxlbmd0aF07CiAgICB9CiAgICByZXR1cm4gdC5yZXZlcnNlKCkuam9pbih0aG91c2FuZHMpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1mb3JtYXRAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0TnVtZXJhbHMuanMKZnVuY3Rpb24gZm9ybWF0TnVtZXJhbHNfZGVmYXVsdChudW1lcmFscykgewogIHJldHVybiBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoL1swLTldL2csIGZ1bmN0aW9uKGkpIHsKICAgICAgcmV0dXJuIG51bWVyYWxzWytpXTsKICAgIH0pOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1mb3JtYXRAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0U3BlY2lmaWVyLmpzCnZhciByZSA9IC9eKD86KC4pPyhbPD49Xl0pKT8oWytcLSggXSk/KFskI10pPygwKT8oXGQrKT8oLCk/KFwuXGQrKT8ofik/KFthLXolXSk/JC9pOwpmdW5jdGlvbiBmb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKSB7CiAgaWYgKCEobWF0Y2ggPSByZS5leGVjKHNwZWNpZmllcikpKSB0aHJvdyBuZXcgRXJyb3IoImludmFsaWQgZm9ybWF0OiAiICsgc3BlY2lmaWVyKTsKICB2YXIgbWF0Y2g7CiAgcmV0dXJuIG5ldyBGb3JtYXRTcGVjaWZpZXIoewogICAgZmlsbDogbWF0Y2hbMV0sCiAgICBhbGlnbjogbWF0Y2hbMl0sCiAgICBzaWduOiBtYXRjaFszXSwKICAgIHN5bWJvbDogbWF0Y2hbNF0sCiAgICB6ZXJvOiBtYXRjaFs1XSwKICAgIHdpZHRoOiBtYXRjaFs2XSwKICAgIGNvbW1hOiBtYXRjaFs3XSwKICAgIHByZWNpc2lvbjogbWF0Y2hbOF0gJiYgbWF0Y2hbOF0uc2xpY2UoMSksCiAgICB0cmltOiBtYXRjaFs5XSwKICAgIHR5cGU6IG1hdGNoWzEwXQogIH0pOwp9CmZvcm1hdFNwZWNpZmllci5wcm90b3R5cGUgPSBGb3JtYXRTcGVjaWZpZXIucHJvdG90eXBlOwpmdW5jdGlvbiBGb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKSB7CiAgdGhpcy5maWxsID0gc3BlY2lmaWVyLmZpbGwgPT09IHZvaWQgMCA/ICIgIiA6IHNwZWNpZmllci5maWxsICsgIiI7CiAgdGhpcy5hbGlnbiA9IHNwZWNpZmllci5hbGlnbiA9PT0gdm9pZCAwID8gIj4iIDogc3BlY2lmaWVyLmFsaWduICsgIiI7CiAgdGhpcy5zaWduID0gc3BlY2lmaWVyLnNpZ24gPT09IHZvaWQgMCA/ICItIiA6IHNwZWNpZmllci5zaWduICsgIiI7CiAgdGhpcy5zeW1ib2wgPSBzcGVjaWZpZXIuc3ltYm9sID09PSB2b2lkIDAgPyAiIiA6IHNwZWNpZmllci5zeW1ib2wgKyAiIjsKICB0aGlzLnplcm8gPSAhIXNwZWNpZmllci56ZXJvOwogIHRoaXMud2lkdGggPSBzcGVjaWZpZXIud2lkdGggPT09IHZvaWQgMCA/IHZvaWQgMCA6ICtzcGVjaWZpZXIud2lkdGg7CiAgdGhpcy5jb21tYSA9ICEhc3BlY2lmaWVyLmNvbW1hOwogIHRoaXMucHJlY2lzaW9uID0gc3BlY2lmaWVyLnByZWNpc2lvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogK3NwZWNpZmllci5wcmVjaXNpb247CiAgdGhpcy50cmltID0gISFzcGVjaWZpZXIudHJpbTsKICB0aGlzLnR5cGUgPSBzcGVjaWZpZXIudHlwZSA9PT0gdm9pZCAwID8gIiIgOiBzcGVjaWZpZXIudHlwZSArICIiOwp9CkZvcm1hdFNwZWNpZmllci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5maWxsICsgdGhpcy5hbGlnbiArIHRoaXMuc2lnbiArIHRoaXMuc3ltYm9sICsgKHRoaXMuemVybyA/ICIwIiA6ICIiKSArICh0aGlzLndpZHRoID09PSB2b2lkIDAgPyAiIiA6IE1hdGgubWF4KDEsIHRoaXMud2lkdGggfCAwKSkgKyAodGhpcy5jb21tYSA/ICIsIiA6ICIiKSArICh0aGlzLnByZWNpc2lvbiA9PT0gdm9pZCAwID8gIiIgOiAiLiIgKyBNYXRoLm1heCgwLCB0aGlzLnByZWNpc2lvbiB8IDApKSArICh0aGlzLnRyaW0gPyAifiIgOiAiIikgKyB0aGlzLnR5cGU7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdFRyaW0uanMKZnVuY3Rpb24gZm9ybWF0VHJpbV9kZWZhdWx0KHMpIHsKICBvdXQ6IGZvciAodmFyIG4gPSBzLmxlbmd0aCwgaSA9IDEsIGkwID0gLTEsIGkxOyBpIDwgbjsgKytpKSB7CiAgICBzd2l0Y2ggKHNbaV0pIHsKICAgICAgY2FzZSAiLiI6CiAgICAgICAgaTAgPSBpMSA9IGk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgIjAiOgogICAgICAgIGlmIChpMCA9PT0gMCkgaTAgPSBpOwogICAgICAgIGkxID0gaTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBpZiAoIStzW2ldKSBicmVhayBvdXQ7CiAgICAgICAgaWYgKGkwID4gMCkgaTAgPSAwOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KICByZXR1cm4gaTAgPiAwID8gcy5zbGljZSgwLCBpMCkgKyBzLnNsaWNlKGkxICsgMSkgOiBzOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdFByZWZpeEF1dG8uanMKdmFyIHByZWZpeEV4cG9uZW50OwpmdW5jdGlvbiBmb3JtYXRQcmVmaXhBdXRvX2RlZmF1bHQoeDIsIHApIHsKICB2YXIgZCA9IGZvcm1hdERlY2ltYWxQYXJ0cyh4MiwgcCk7CiAgaWYgKCFkKSByZXR1cm4geDIgKyAiIjsKICB2YXIgY29lZmZpY2llbnQgPSBkWzBdLCBleHBvbmVudCA9IGRbMV0sIGkgPSBleHBvbmVudCAtIChwcmVmaXhFeHBvbmVudCA9IE1hdGgubWF4KC04LCBNYXRoLm1pbig4LCBNYXRoLmZsb29yKGV4cG9uZW50IC8gMykpKSAqIDMpICsgMSwgbiA9IGNvZWZmaWNpZW50Lmxlbmd0aDsKICByZXR1cm4gaSA9PT0gbiA/IGNvZWZmaWNpZW50IDogaSA+IG4gPyBjb2VmZmljaWVudCArIG5ldyBBcnJheShpIC0gbiArIDEpLmpvaW4oIjAiKSA6IGkgPiAwID8gY29lZmZpY2llbnQuc2xpY2UoMCwgaSkgKyAiLiIgKyBjb2VmZmljaWVudC5zbGljZShpKSA6ICIwLiIgKyBuZXcgQXJyYXkoMSAtIGkpLmpvaW4oIjAiKSArIGZvcm1hdERlY2ltYWxQYXJ0cyh4MiwgTWF0aC5tYXgoMCwgcCArIGkgLSAxKSlbMF07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1mb3JtYXRAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0Um91bmRlZC5qcwpmdW5jdGlvbiBmb3JtYXRSb3VuZGVkX2RlZmF1bHQoeDIsIHApIHsKICB2YXIgZCA9IGZvcm1hdERlY2ltYWxQYXJ0cyh4MiwgcCk7CiAgaWYgKCFkKSByZXR1cm4geDIgKyAiIjsKICB2YXIgY29lZmZpY2llbnQgPSBkWzBdLCBleHBvbmVudCA9IGRbMV07CiAgcmV0dXJuIGV4cG9uZW50IDwgMCA/ICIwLiIgKyBuZXcgQXJyYXkoLWV4cG9uZW50KS5qb2luKCIwIikgKyBjb2VmZmljaWVudCA6IGNvZWZmaWNpZW50Lmxlbmd0aCA+IGV4cG9uZW50ICsgMSA/IGNvZWZmaWNpZW50LnNsaWNlKDAsIGV4cG9uZW50ICsgMSkgKyAiLiIgKyBjb2VmZmljaWVudC5zbGljZShleHBvbmVudCArIDEpIDogY29lZmZpY2llbnQgKyBuZXcgQXJyYXkoZXhwb25lbnQgLSBjb2VmZmljaWVudC5sZW5ndGggKyAyKS5qb2luKCIwIik7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1mb3JtYXRAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0VHlwZXMuanMKdmFyIGZvcm1hdFR5cGVzX2RlZmF1bHQgPSB7CiAgIiUiOiAoeDIsIHApID0+ICh4MiAqIDEwMCkudG9GaXhlZChwKSwKICAiYiI6ICh4MikgPT4gTWF0aC5yb3VuZCh4MikudG9TdHJpbmcoMiksCiAgImMiOiAoeDIpID0+IHgyICsgIiIsCiAgImQiOiBmb3JtYXREZWNpbWFsX2RlZmF1bHQsCiAgImUiOiAoeDIsIHApID0+IHgyLnRvRXhwb25lbnRpYWwocCksCiAgImYiOiAoeDIsIHApID0+IHgyLnRvRml4ZWQocCksCiAgImciOiAoeDIsIHApID0+IHgyLnRvUHJlY2lzaW9uKHApLAogICJvIjogKHgyKSA9PiBNYXRoLnJvdW5kKHgyKS50b1N0cmluZyg4KSwKICAicCI6ICh4MiwgcCkgPT4gZm9ybWF0Um91bmRlZF9kZWZhdWx0KHgyICogMTAwLCBwKSwKICAiciI6IGZvcm1hdFJvdW5kZWRfZGVmYXVsdCwKICAicyI6IGZvcm1hdFByZWZpeEF1dG9fZGVmYXVsdCwKICAiWCI6ICh4MikgPT4gTWF0aC5yb3VuZCh4MikudG9TdHJpbmcoMTYpLnRvVXBwZXJDYXNlKCksCiAgIngiOiAoeDIpID0+IE1hdGgucm91bmQoeDIpLnRvU3RyaW5nKDE2KQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWZvcm1hdEAzLjEuMC9ub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9pZGVudGl0eS5qcwpmdW5jdGlvbiBpZGVudGl0eV9kZWZhdWx0KHgyKSB7CiAgcmV0dXJuIHgyOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2xvY2FsZS5qcwp2YXIgbWFwID0gQXJyYXkucHJvdG90eXBlLm1hcDsKdmFyIHByZWZpeGVzID0gWyJ5IiwgInoiLCAiYSIsICJmIiwgInAiLCAibiIsICJceEI1IiwgIm0iLCAiIiwgImsiLCAiTSIsICJHIiwgIlQiLCAiUCIsICJFIiwgIloiLCAiWSJdOwpmdW5jdGlvbiBsb2NhbGVfZGVmYXVsdChsb2NhbGUzKSB7CiAgdmFyIGdyb3VwID0gbG9jYWxlMy5ncm91cGluZyA9PT0gdm9pZCAwIHx8IGxvY2FsZTMudGhvdXNhbmRzID09PSB2b2lkIDAgPyBpZGVudGl0eV9kZWZhdWx0IDogZm9ybWF0R3JvdXBfZGVmYXVsdChtYXAuY2FsbChsb2NhbGUzLmdyb3VwaW5nLCBOdW1iZXIpLCBsb2NhbGUzLnRob3VzYW5kcyArICIiKSwgY3VycmVuY3lQcmVmaXggPSBsb2NhbGUzLmN1cnJlbmN5ID09PSB2b2lkIDAgPyAiIiA6IGxvY2FsZTMuY3VycmVuY3lbMF0gKyAiIiwgY3VycmVuY3lTdWZmaXggPSBsb2NhbGUzLmN1cnJlbmN5ID09PSB2b2lkIDAgPyAiIiA6IGxvY2FsZTMuY3VycmVuY3lbMV0gKyAiIiwgZGVjaW1hbCA9IGxvY2FsZTMuZGVjaW1hbCA9PT0gdm9pZCAwID8gIi4iIDogbG9jYWxlMy5kZWNpbWFsICsgIiIsIG51bWVyYWxzID0gbG9jYWxlMy5udW1lcmFscyA9PT0gdm9pZCAwID8gaWRlbnRpdHlfZGVmYXVsdCA6IGZvcm1hdE51bWVyYWxzX2RlZmF1bHQobWFwLmNhbGwobG9jYWxlMy5udW1lcmFscywgU3RyaW5nKSksIHBlcmNlbnQgPSBsb2NhbGUzLnBlcmNlbnQgPT09IHZvaWQgMCA/ICIlIiA6IGxvY2FsZTMucGVyY2VudCArICIiLCBtaW51cyA9IGxvY2FsZTMubWludXMgPT09IHZvaWQgMCA/ICJcdTIyMTIiIDogbG9jYWxlMy5taW51cyArICIiLCBuYW4gPSBsb2NhbGUzLm5hbiA9PT0gdm9pZCAwID8gIk5hTiIgOiBsb2NhbGUzLm5hbiArICIiOwogIGZ1bmN0aW9uIG5ld0Zvcm1hdChzcGVjaWZpZXIpIHsKICAgIHNwZWNpZmllciA9IGZvcm1hdFNwZWNpZmllcihzcGVjaWZpZXIpOwogICAgdmFyIGZpbGwgPSBzcGVjaWZpZXIuZmlsbCwgYWxpZ24gPSBzcGVjaWZpZXIuYWxpZ24sIHNpZ24yID0gc3BlY2lmaWVyLnNpZ24sIHN5bWJvbCA9IHNwZWNpZmllci5zeW1ib2wsIHplcm8zID0gc3BlY2lmaWVyLnplcm8sIHdpZHRoID0gc3BlY2lmaWVyLndpZHRoLCBjb21tYSA9IHNwZWNpZmllci5jb21tYSwgcHJlY2lzaW9uID0gc3BlY2lmaWVyLnByZWNpc2lvbiwgdHJpbSA9IHNwZWNpZmllci50cmltLCB0eXBlID0gc3BlY2lmaWVyLnR5cGU7CiAgICBpZiAodHlwZSA9PT0gIm4iKSBjb21tYSA9IHRydWUsIHR5cGUgPSAiZyI7CiAgICBlbHNlIGlmICghZm9ybWF0VHlwZXNfZGVmYXVsdFt0eXBlXSkgcHJlY2lzaW9uID09PSB2b2lkIDAgJiYgKHByZWNpc2lvbiA9IDEyKSwgdHJpbSA9IHRydWUsIHR5cGUgPSAiZyI7CiAgICBpZiAoemVybzMgfHwgZmlsbCA9PT0gIjAiICYmIGFsaWduID09PSAiPSIpIHplcm8zID0gdHJ1ZSwgZmlsbCA9ICIwIiwgYWxpZ24gPSAiPSI7CiAgICB2YXIgcHJlZml4ID0gc3ltYm9sID09PSAiJCIgPyBjdXJyZW5jeVByZWZpeCA6IHN5bWJvbCA9PT0gIiMiICYmIC9bYm94WF0vLnRlc3QodHlwZSkgPyAiMCIgKyB0eXBlLnRvTG93ZXJDYXNlKCkgOiAiIiwgc3VmZml4MiA9IHN5bWJvbCA9PT0gIiQiID8gY3VycmVuY3lTdWZmaXggOiAvWyVwXS8udGVzdCh0eXBlKSA/IHBlcmNlbnQgOiAiIjsKICAgIHZhciBmb3JtYXRUeXBlID0gZm9ybWF0VHlwZXNfZGVmYXVsdFt0eXBlXSwgbWF5YmVTdWZmaXggPSAvW2RlZmdwcnMlXS8udGVzdCh0eXBlKTsKICAgIHByZWNpc2lvbiA9IHByZWNpc2lvbiA9PT0gdm9pZCAwID8gNiA6IC9bZ3Byc10vLnRlc3QodHlwZSkgPyBNYXRoLm1heCgxLCBNYXRoLm1pbigyMSwgcHJlY2lzaW9uKSkgOiBNYXRoLm1heCgwLCBNYXRoLm1pbigyMCwgcHJlY2lzaW9uKSk7CiAgICBmdW5jdGlvbiBmb3JtYXQyKHZhbHVlKSB7CiAgICAgIHZhciB2YWx1ZVByZWZpeCA9IHByZWZpeCwgdmFsdWVTdWZmaXggPSBzdWZmaXgyLCBpLCBuLCBjOwogICAgICBpZiAodHlwZSA9PT0gImMiKSB7CiAgICAgICAgdmFsdWVTdWZmaXggPSBmb3JtYXRUeXBlKHZhbHVlKSArIHZhbHVlU3VmZml4OwogICAgICAgIHZhbHVlID0gIiI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWUgPSArdmFsdWU7CiAgICAgICAgdmFyIHZhbHVlTmVnYXRpdmUgPSB2YWx1ZSA8IDAgfHwgMSAvIHZhbHVlIDwgMDsKICAgICAgICB2YWx1ZSA9IGlzTmFOKHZhbHVlKSA/IG5hbiA6IGZvcm1hdFR5cGUoTWF0aC5hYnModmFsdWUpLCBwcmVjaXNpb24pOwogICAgICAgIGlmICh0cmltKSB2YWx1ZSA9IGZvcm1hdFRyaW1fZGVmYXVsdCh2YWx1ZSk7CiAgICAgICAgaWYgKHZhbHVlTmVnYXRpdmUgJiYgK3ZhbHVlID09PSAwICYmIHNpZ24yICE9PSAiKyIpIHZhbHVlTmVnYXRpdmUgPSBmYWxzZTsKICAgICAgICB2YWx1ZVByZWZpeCA9ICh2YWx1ZU5lZ2F0aXZlID8gc2lnbjIgPT09ICIoIiA/IHNpZ24yIDogbWludXMgOiBzaWduMiA9PT0gIi0iIHx8IHNpZ24yID09PSAiKCIgPyAiIiA6IHNpZ24yKSArIHZhbHVlUHJlZml4OwogICAgICAgIHZhbHVlU3VmZml4ID0gKHR5cGUgPT09ICJzIiA/IHByZWZpeGVzWzggKyBwcmVmaXhFeHBvbmVudCAvIDNdIDogIiIpICsgdmFsdWVTdWZmaXggKyAodmFsdWVOZWdhdGl2ZSAmJiBzaWduMiA9PT0gIigiID8gIikiIDogIiIpOwogICAgICAgIGlmIChtYXliZVN1ZmZpeCkgewogICAgICAgICAgaSA9IC0xLCBuID0gdmFsdWUubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKCsraSA8IG4pIHsKICAgICAgICAgICAgaWYgKGMgPSB2YWx1ZS5jaGFyQ29kZUF0KGkpLCA0OCA+IGMgfHwgYyA+IDU3KSB7CiAgICAgICAgICAgICAgdmFsdWVTdWZmaXggPSAoYyA9PT0gNDYgPyBkZWNpbWFsICsgdmFsdWUuc2xpY2UoaSArIDEpIDogdmFsdWUuc2xpY2UoaSkpICsgdmFsdWVTdWZmaXg7CiAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5zbGljZSgwLCBpKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoY29tbWEgJiYgIXplcm8zKSB2YWx1ZSA9IGdyb3VwKHZhbHVlLCBJbmZpbml0eSk7CiAgICAgIHZhciBsZW5ndGggPSB2YWx1ZVByZWZpeC5sZW5ndGggKyB2YWx1ZS5sZW5ndGggKyB2YWx1ZVN1ZmZpeC5sZW5ndGgsIHBhZGRpbmcgPSBsZW5ndGggPCB3aWR0aCA/IG5ldyBBcnJheSh3aWR0aCAtIGxlbmd0aCArIDEpLmpvaW4oZmlsbCkgOiAiIjsKICAgICAgaWYgKGNvbW1hICYmIHplcm8zKSB2YWx1ZSA9IGdyb3VwKHBhZGRpbmcgKyB2YWx1ZSwgcGFkZGluZy5sZW5ndGggPyB3aWR0aCAtIHZhbHVlU3VmZml4Lmxlbmd0aCA6IEluZmluaXR5KSwgcGFkZGluZyA9ICIiOwogICAgICBzd2l0Y2ggKGFsaWduKSB7CiAgICAgICAgY2FzZSAiPCI6CiAgICAgICAgICB2YWx1ZSA9IHZhbHVlUHJlZml4ICsgdmFsdWUgKyB2YWx1ZVN1ZmZpeCArIHBhZGRpbmc7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICI9IjoKICAgICAgICAgIHZhbHVlID0gdmFsdWVQcmVmaXggKyBwYWRkaW5nICsgdmFsdWUgKyB2YWx1ZVN1ZmZpeDsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIl4iOgogICAgICAgICAgdmFsdWUgPSBwYWRkaW5nLnNsaWNlKDAsIGxlbmd0aCA9IHBhZGRpbmcubGVuZ3RoID4+IDEpICsgdmFsdWVQcmVmaXggKyB2YWx1ZSArIHZhbHVlU3VmZml4ICsgcGFkZGluZy5zbGljZShsZW5ndGgpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHZhbHVlID0gcGFkZGluZyArIHZhbHVlUHJlZml4ICsgdmFsdWUgKyB2YWx1ZVN1ZmZpeDsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHJldHVybiBudW1lcmFscyh2YWx1ZSk7CiAgICB9CiAgICBmb3JtYXQyLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBzcGVjaWZpZXIgKyAiIjsKICAgIH07CiAgICByZXR1cm4gZm9ybWF0MjsKICB9CiAgZnVuY3Rpb24gZm9ybWF0UHJlZml4MihzcGVjaWZpZXIsIHZhbHVlKSB7CiAgICB2YXIgZiA9IG5ld0Zvcm1hdCgoc3BlY2lmaWVyID0gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllciksIHNwZWNpZmllci50eXBlID0gImYiLCBzcGVjaWZpZXIpKSwgZSA9IE1hdGgubWF4KC04LCBNYXRoLm1pbig4LCBNYXRoLmZsb29yKGV4cG9uZW50X2RlZmF1bHQodmFsdWUpIC8gMykpKSAqIDMsIGsgPSBNYXRoLnBvdygxMCwgLWUpLCBwcmVmaXggPSBwcmVmaXhlc1s4ICsgZSAvIDNdOwogICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlMikgewogICAgICByZXR1cm4gZihrICogdmFsdWUyKSArIHByZWZpeDsKICAgIH07CiAgfQogIHJldHVybiB7CiAgICBmb3JtYXQ6IG5ld0Zvcm1hdCwKICAgIGZvcm1hdFByZWZpeDogZm9ybWF0UHJlZml4MgogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1mb3JtYXRAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZGVmYXVsdExvY2FsZS5qcwp2YXIgbG9jYWxlOwp2YXIgZm9ybWF0Owp2YXIgZm9ybWF0UHJlZml4OwpkZWZhdWx0TG9jYWxlKHsKICB0aG91c2FuZHM6ICIsIiwKICBncm91cGluZzogWzNdLAogIGN1cnJlbmN5OiBbIiQiLCAiIl0KfSk7CmZ1bmN0aW9uIGRlZmF1bHRMb2NhbGUoZGVmaW5pdGlvbikgewogIGxvY2FsZSA9IGxvY2FsZV9kZWZhdWx0KGRlZmluaXRpb24pOwogIGZvcm1hdCA9IGxvY2FsZS5mb3JtYXQ7CiAgZm9ybWF0UHJlZml4ID0gbG9jYWxlLmZvcm1hdFByZWZpeDsKICByZXR1cm4gbG9jYWxlOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL3ByZWNpc2lvbkZpeGVkLmpzCmZ1bmN0aW9uIHByZWNpc2lvbkZpeGVkX2RlZmF1bHQoc3RlcCkgewogIHJldHVybiBNYXRoLm1heCgwLCAtZXhwb25lbnRfZGVmYXVsdChNYXRoLmFicyhzdGVwKSkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL3ByZWNpc2lvblByZWZpeC5qcwpmdW5jdGlvbiBwcmVjaXNpb25QcmVmaXhfZGVmYXVsdChzdGVwLCB2YWx1ZSkgewogIHJldHVybiBNYXRoLm1heCgwLCBNYXRoLm1heCgtOCwgTWF0aC5taW4oOCwgTWF0aC5mbG9vcihleHBvbmVudF9kZWZhdWx0KHZhbHVlKSAvIDMpKSkgKiAzIC0gZXhwb25lbnRfZGVmYXVsdChNYXRoLmFicyhzdGVwKSkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL3ByZWNpc2lvblJvdW5kLmpzCmZ1bmN0aW9uIHByZWNpc2lvblJvdW5kX2RlZmF1bHQoc3RlcCwgbWF4MikgewogIHN0ZXAgPSBNYXRoLmFicyhzdGVwKSwgbWF4MiA9IE1hdGguYWJzKG1heDIpIC0gc3RlcDsKICByZXR1cm4gTWF0aC5tYXgoMCwgZXhwb25lbnRfZGVmYXVsdChtYXgyKSAtIGV4cG9uZW50X2RlZmF1bHQoc3RlcCkpICsgMTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvdGlja0Zvcm1hdC5qcwpmdW5jdGlvbiB0aWNrRm9ybWF0KHN0YXJ0LCBzdG9wLCBjb3VudCwgc3BlY2lmaWVyKSB7CiAgdmFyIHN0ZXAgPSB0aWNrU3RlcChzdGFydCwgc3RvcCwgY291bnQpLCBwcmVjaXNpb247CiAgc3BlY2lmaWVyID0gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllciA9PSBudWxsID8gIixmIiA6IHNwZWNpZmllcik7CiAgc3dpdGNoIChzcGVjaWZpZXIudHlwZSkgewogICAgY2FzZSAicyI6IHsKICAgICAgdmFyIHZhbHVlID0gTWF0aC5tYXgoTWF0aC5hYnMoc3RhcnQpLCBNYXRoLmFicyhzdG9wKSk7CiAgICAgIGlmIChzcGVjaWZpZXIucHJlY2lzaW9uID09IG51bGwgJiYgIWlzTmFOKHByZWNpc2lvbiA9IHByZWNpc2lvblByZWZpeF9kZWZhdWx0KHN0ZXAsIHZhbHVlKSkpIHNwZWNpZmllci5wcmVjaXNpb24gPSBwcmVjaXNpb247CiAgICAgIHJldHVybiBmb3JtYXRQcmVmaXgoc3BlY2lmaWVyLCB2YWx1ZSk7CiAgICB9CiAgICBjYXNlICIiOgogICAgY2FzZSAiZSI6CiAgICBjYXNlICJnIjoKICAgIGNhc2UgInAiOgogICAgY2FzZSAiciI6IHsKICAgICAgaWYgKHNwZWNpZmllci5wcmVjaXNpb24gPT0gbnVsbCAmJiAhaXNOYU4ocHJlY2lzaW9uID0gcHJlY2lzaW9uUm91bmRfZGVmYXVsdChzdGVwLCBNYXRoLm1heChNYXRoLmFicyhzdGFydCksIE1hdGguYWJzKHN0b3ApKSkpKSBzcGVjaWZpZXIucHJlY2lzaW9uID0gcHJlY2lzaW9uIC0gKHNwZWNpZmllci50eXBlID09PSAiZSIpOwogICAgICBicmVhazsKICAgIH0KICAgIGNhc2UgImYiOgogICAgY2FzZSAiJSI6IHsKICAgICAgaWYgKHNwZWNpZmllci5wcmVjaXNpb24gPT0gbnVsbCAmJiAhaXNOYU4ocHJlY2lzaW9uID0gcHJlY2lzaW9uRml4ZWRfZGVmYXVsdChzdGVwKSkpIHNwZWNpZmllci5wcmVjaXNpb24gPSBwcmVjaXNpb24gLSAoc3BlY2lmaWVyLnR5cGUgPT09ICIlIikgKiAyOwogICAgICBicmVhazsKICAgIH0KICB9CiAgcmV0dXJuIGZvcm1hdChzcGVjaWZpZXIpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9saW5lYXIuanMKZnVuY3Rpb24gbGluZWFyaXNoKHNjYWxlKSB7CiAgdmFyIGRvbWFpbiA9IHNjYWxlLmRvbWFpbjsKICBzY2FsZS50aWNrcyA9IGZ1bmN0aW9uKGNvdW50KSB7CiAgICB2YXIgZCA9IGRvbWFpbigpOwogICAgcmV0dXJuIHRpY2tzKGRbMF0sIGRbZC5sZW5ndGggLSAxXSwgY291bnQgPT0gbnVsbCA/IDEwIDogY291bnQpOwogIH07CiAgc2NhbGUudGlja0Zvcm1hdCA9IGZ1bmN0aW9uKGNvdW50LCBzcGVjaWZpZXIpIHsKICAgIHZhciBkID0gZG9tYWluKCk7CiAgICByZXR1cm4gdGlja0Zvcm1hdChkWzBdLCBkW2QubGVuZ3RoIC0gMV0sIGNvdW50ID09IG51bGwgPyAxMCA6IGNvdW50LCBzcGVjaWZpZXIpOwogIH07CiAgc2NhbGUubmljZSA9IGZ1bmN0aW9uKGNvdW50KSB7CiAgICBpZiAoY291bnQgPT0gbnVsbCkgY291bnQgPSAxMDsKICAgIHZhciBkID0gZG9tYWluKCk7CiAgICB2YXIgaTAgPSAwOwogICAgdmFyIGkxID0gZC5sZW5ndGggLSAxOwogICAgdmFyIHN0YXJ0ID0gZFtpMF07CiAgICB2YXIgc3RvcCA9IGRbaTFdOwogICAgdmFyIHByZXN0ZXA7CiAgICB2YXIgc3RlcDsKICAgIHZhciBtYXhJdGVyID0gMTA7CiAgICBpZiAoc3RvcCA8IHN0YXJ0KSB7CiAgICAgIHN0ZXAgPSBzdGFydCwgc3RhcnQgPSBzdG9wLCBzdG9wID0gc3RlcDsKICAgICAgc3RlcCA9IGkwLCBpMCA9IGkxLCBpMSA9IHN0ZXA7CiAgICB9CiAgICB3aGlsZSAobWF4SXRlci0tID4gMCkgewogICAgICBzdGVwID0gdGlja0luY3JlbWVudChzdGFydCwgc3RvcCwgY291bnQpOwogICAgICBpZiAoc3RlcCA9PT0gcHJlc3RlcCkgewogICAgICAgIGRbaTBdID0gc3RhcnQ7CiAgICAgICAgZFtpMV0gPSBzdG9wOwogICAgICAgIHJldHVybiBkb21haW4oZCk7CiAgICAgIH0gZWxzZSBpZiAoc3RlcCA+IDApIHsKICAgICAgICBzdGFydCA9IE1hdGguZmxvb3Ioc3RhcnQgLyBzdGVwKSAqIHN0ZXA7CiAgICAgICAgc3RvcCA9IE1hdGguY2VpbChzdG9wIC8gc3RlcCkgKiBzdGVwOwogICAgICB9IGVsc2UgaWYgKHN0ZXAgPCAwKSB7CiAgICAgICAgc3RhcnQgPSBNYXRoLmNlaWwoc3RhcnQgKiBzdGVwKSAvIHN0ZXA7CiAgICAgICAgc3RvcCA9IE1hdGguZmxvb3Ioc3RvcCAqIHN0ZXApIC8gc3RlcDsKICAgICAgfSBlbHNlIHsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBwcmVzdGVwID0gc3RlcDsKICAgIH0KICAgIHJldHVybiBzY2FsZTsKICB9OwogIHJldHVybiBzY2FsZTsKfQpmdW5jdGlvbiBsaW5lYXIyKCkgewogIHZhciBzY2FsZSA9IGNvbnRpbnVvdXMoKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weShzY2FsZSwgbGluZWFyMigpKTsKICB9OwogIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKICByZXR1cm4gbGluZWFyaXNoKHNjYWxlKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvaWRlbnRpdHkuanMKZnVuY3Rpb24gaWRlbnRpdHkyKGRvbWFpbikgewogIHZhciB1bmtub3duOwogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICByZXR1cm4geDIgPT0gbnVsbCB8fCBpc05hTih4MiA9ICt4MikgPyB1bmtub3duIDogeDI7CiAgfQogIHNjYWxlLmludmVydCA9IHNjYWxlOwogIHNjYWxlLmRvbWFpbiA9IHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZG9tYWluID0gQXJyYXkuZnJvbShfLCBudW1iZXIyKSwgc2NhbGUpIDogZG9tYWluLnNsaWNlKCk7CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gaWRlbnRpdHkyKGRvbWFpbikudW5rbm93bih1bmtub3duKTsKICB9OwogIGRvbWFpbiA9IGFyZ3VtZW50cy5sZW5ndGggPyBBcnJheS5mcm9tKGRvbWFpbiwgbnVtYmVyMikgOiBbMCwgMV07CiAgcmV0dXJuIGxpbmVhcmlzaChzY2FsZSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL25pY2UuanMKZnVuY3Rpb24gbmljZShkb21haW4sIGludGVydmFsKSB7CiAgZG9tYWluID0gZG9tYWluLnNsaWNlKCk7CiAgdmFyIGkwID0gMCwgaTEgPSBkb21haW4ubGVuZ3RoIC0gMSwgeDAgPSBkb21haW5baTBdLCB4MSA9IGRvbWFpbltpMV0sIHQ7CiAgaWYgKHgxIDwgeDApIHsKICAgIHQgPSBpMCwgaTAgPSBpMSwgaTEgPSB0OwogICAgdCA9IHgwLCB4MCA9IHgxLCB4MSA9IHQ7CiAgfQogIGRvbWFpbltpMF0gPSBpbnRlcnZhbC5mbG9vcih4MCk7CiAgZG9tYWluW2kxXSA9IGludGVydmFsLmNlaWwoeDEpOwogIHJldHVybiBkb21haW47Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2xvZy5qcwpmdW5jdGlvbiB0cmFuc2Zvcm1Mb2coeDIpIHsKICByZXR1cm4gTWF0aC5sb2coeDIpOwp9CmZ1bmN0aW9uIHRyYW5zZm9ybUV4cCh4MikgewogIHJldHVybiBNYXRoLmV4cCh4Mik7Cn0KZnVuY3Rpb24gdHJhbnNmb3JtTG9nbih4MikgewogIHJldHVybiAtTWF0aC5sb2coLXgyKTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1FeHBuKHgyKSB7CiAgcmV0dXJuIC1NYXRoLmV4cCgteDIpOwp9CmZ1bmN0aW9uIHBvdzEwKHgyKSB7CiAgcmV0dXJuIGlzRmluaXRlKHgyKSA/ICsoIjFlIiArIHgyKSA6IHgyIDwgMCA/IDAgOiB4MjsKfQpmdW5jdGlvbiBwb3dwKGJhc2UpIHsKICByZXR1cm4gYmFzZSA9PT0gMTAgPyBwb3cxMCA6IGJhc2UgPT09IE1hdGguRSA/IE1hdGguZXhwIDogKHgyKSA9PiBNYXRoLnBvdyhiYXNlLCB4Mik7Cn0KZnVuY3Rpb24gbG9ncChiYXNlKSB7CiAgcmV0dXJuIGJhc2UgPT09IE1hdGguRSA/IE1hdGgubG9nIDogYmFzZSA9PT0gMTAgJiYgTWF0aC5sb2cxMCB8fCBiYXNlID09PSAyICYmIE1hdGgubG9nMiB8fCAoYmFzZSA9IE1hdGgubG9nKGJhc2UpLCAoeDIpID0+IE1hdGgubG9nKHgyKSAvIGJhc2UpOwp9CmZ1bmN0aW9uIHJlZmxlY3QoZikgewogIHJldHVybiAoeDIsIGspID0+IC1mKC14Miwgayk7Cn0KZnVuY3Rpb24gbG9nZ2lzaCh0cmFuc2Zvcm0pIHsKICBjb25zdCBzY2FsZSA9IHRyYW5zZm9ybSh0cmFuc2Zvcm1Mb2csIHRyYW5zZm9ybUV4cCk7CiAgY29uc3QgZG9tYWluID0gc2NhbGUuZG9tYWluOwogIGxldCBiYXNlID0gMTA7CiAgbGV0IGxvZ3M7CiAgbGV0IHBvd3M7CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIGxvZ3MgPSBsb2dwKGJhc2UpLCBwb3dzID0gcG93cChiYXNlKTsKICAgIGlmIChkb21haW4oKVswXSA8IDApIHsKICAgICAgbG9ncyA9IHJlZmxlY3QobG9ncyksIHBvd3MgPSByZWZsZWN0KHBvd3MpOwogICAgICB0cmFuc2Zvcm0odHJhbnNmb3JtTG9nbiwgdHJhbnNmb3JtRXhwbik7CiAgICB9IGVsc2UgewogICAgICB0cmFuc2Zvcm0odHJhbnNmb3JtTG9nLCB0cmFuc2Zvcm1FeHApOwogICAgfQogICAgcmV0dXJuIHNjYWxlOwogIH0KICBzY2FsZS5iYXNlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoYmFzZSA9ICtfLCByZXNjYWxlKCkpIDogYmFzZTsKICB9OwogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRvbWFpbihfKSwgcmVzY2FsZSgpKSA6IGRvbWFpbigpOwogIH07CiAgc2NhbGUudGlja3MgPSAoY291bnQpID0+IHsKICAgIGNvbnN0IGQgPSBkb21haW4oKTsKICAgIGxldCB1ID0gZFswXTsKICAgIGxldCB2ID0gZFtkLmxlbmd0aCAtIDFdOwogICAgY29uc3QgcjIgPSB2IDwgdTsKICAgIGlmIChyMikgW3UsIHZdID0gW3YsIHVdOwogICAgbGV0IGkgPSBsb2dzKHUpOwogICAgbGV0IGogPSBsb2dzKHYpOwogICAgbGV0IGs7CiAgICBsZXQgdDsKICAgIGNvbnN0IG4gPSBjb3VudCA9PSBudWxsID8gMTAgOiArY291bnQ7CiAgICBsZXQgeiA9IFtdOwogICAgaWYgKCEoYmFzZSAlIDEpICYmIGogLSBpIDwgbikgewogICAgICBpID0gTWF0aC5mbG9vcihpKSwgaiA9IE1hdGguY2VpbChqKTsKICAgICAgaWYgKHUgPiAwKSBmb3IgKDsgaSA8PSBqOyArK2kpIHsKICAgICAgICBmb3IgKGsgPSAxOyBrIDwgYmFzZTsgKytrKSB7CiAgICAgICAgICB0ID0gaSA8IDAgPyBrIC8gcG93cygtaSkgOiBrICogcG93cyhpKTsKICAgICAgICAgIGlmICh0IDwgdSkgY29udGludWU7CiAgICAgICAgICBpZiAodCA+IHYpIGJyZWFrOwogICAgICAgICAgei5wdXNoKHQpOwogICAgICAgIH0KICAgICAgfQogICAgICBlbHNlIGZvciAoOyBpIDw9IGo7ICsraSkgewogICAgICAgIGZvciAoayA9IGJhc2UgLSAxOyBrID49IDE7IC0taykgewogICAgICAgICAgdCA9IGkgPiAwID8gayAvIHBvd3MoLWkpIDogayAqIHBvd3MoaSk7CiAgICAgICAgICBpZiAodCA8IHUpIGNvbnRpbnVlOwogICAgICAgICAgaWYgKHQgPiB2KSBicmVhazsKICAgICAgICAgIHoucHVzaCh0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHoubGVuZ3RoICogMiA8IG4pIHogPSB0aWNrcyh1LCB2LCBuKTsKICAgIH0gZWxzZSB7CiAgICAgIHogPSB0aWNrcyhpLCBqLCBNYXRoLm1pbihqIC0gaSwgbikpLm1hcChwb3dzKTsKICAgIH0KICAgIHJldHVybiByMiA/IHoucmV2ZXJzZSgpIDogejsKICB9OwogIHNjYWxlLnRpY2tGb3JtYXQgPSAoY291bnQsIHNwZWNpZmllcikgPT4gewogICAgaWYgKGNvdW50ID09IG51bGwpIGNvdW50ID0gMTA7CiAgICBpZiAoc3BlY2lmaWVyID09IG51bGwpIHNwZWNpZmllciA9IGJhc2UgPT09IDEwID8gInMiIDogIiwiOwogICAgaWYgKHR5cGVvZiBzcGVjaWZpZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgaWYgKCEoYmFzZSAlIDEpICYmIChzcGVjaWZpZXIgPSBmb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKSkucHJlY2lzaW9uID09IG51bGwpIHNwZWNpZmllci50cmltID0gdHJ1ZTsKICAgICAgc3BlY2lmaWVyID0gZm9ybWF0KHNwZWNpZmllcik7CiAgICB9CiAgICBpZiAoY291bnQgPT09IEluZmluaXR5KSByZXR1cm4gc3BlY2lmaWVyOwogICAgY29uc3QgayA9IE1hdGgubWF4KDEsIGJhc2UgKiBjb3VudCAvIHNjYWxlLnRpY2tzKCkubGVuZ3RoKTsKICAgIHJldHVybiAoZCkgPT4gewogICAgICBsZXQgaSA9IGQgLyBwb3dzKE1hdGgucm91bmQobG9ncyhkKSkpOwogICAgICBpZiAoaSAqIGJhc2UgPCBiYXNlIC0gMC41KSBpICo9IGJhc2U7CiAgICAgIHJldHVybiBpIDw9IGsgPyBzcGVjaWZpZXIoZCkgOiAiIjsKICAgIH07CiAgfTsKICBzY2FsZS5uaWNlID0gKCkgPT4gewogICAgcmV0dXJuIGRvbWFpbihuaWNlKGRvbWFpbigpLCB7CiAgICAgIGZsb29yOiAoeDIpID0+IHBvd3MoTWF0aC5mbG9vcihsb2dzKHgyKSkpLAogICAgICBjZWlsOiAoeDIpID0+IHBvd3MoTWF0aC5jZWlsKGxvZ3MoeDIpKSkKICAgIH0pKTsKICB9OwogIHJldHVybiBzY2FsZTsKfQpmdW5jdGlvbiBsb2coKSB7CiAgY29uc3Qgc2NhbGUgPSBsb2dnaXNoKHRyYW5zZm9ybWVyKCkpLmRvbWFpbihbMSwgMTBdKTsKICBzY2FsZS5jb3B5ID0gKCkgPT4gY29weShzY2FsZSwgbG9nKCkpLmJhc2Uoc2NhbGUuYmFzZSgpKTsKICBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7CiAgcmV0dXJuIHNjYWxlOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9zeW1sb2cuanMKZnVuY3Rpb24gdHJhbnNmb3JtU3ltbG9nKGMpIHsKICByZXR1cm4gZnVuY3Rpb24oeDIpIHsKICAgIHJldHVybiBNYXRoLnNpZ24oeDIpICogTWF0aC5sb2cxcChNYXRoLmFicyh4MiAvIGMpKTsKICB9Owp9CmZ1bmN0aW9uIHRyYW5zZm9ybVN5bWV4cChjKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4gTWF0aC5zaWduKHgyKSAqIE1hdGguZXhwbTEoTWF0aC5hYnMoeDIpKSAqIGM7CiAgfTsKfQpmdW5jdGlvbiBzeW1sb2dpc2godHJhbnNmb3JtKSB7CiAgdmFyIGMgPSAxLCBzY2FsZSA9IHRyYW5zZm9ybSh0cmFuc2Zvcm1TeW1sb2coYyksIHRyYW5zZm9ybVN5bWV4cChjKSk7CiAgc2NhbGUuY29uc3RhbnQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IHRyYW5zZm9ybSh0cmFuc2Zvcm1TeW1sb2coYyA9ICtfKSwgdHJhbnNmb3JtU3ltZXhwKGMpKSA6IGM7CiAgfTsKICByZXR1cm4gbGluZWFyaXNoKHNjYWxlKTsKfQpmdW5jdGlvbiBzeW1sb2coKSB7CiAgdmFyIHNjYWxlID0gc3ltbG9naXNoKHRyYW5zZm9ybWVyKCkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5KHNjYWxlLCBzeW1sb2coKSkuY29uc3RhbnQoc2NhbGUuY29uc3RhbnQoKSk7CiAgfTsKICByZXR1cm4gaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9wb3cuanMKZnVuY3Rpb24gdHJhbnNmb3JtUG93KGV4cG9uZW50KSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4geDIgPCAwID8gLU1hdGgucG93KC14MiwgZXhwb25lbnQpIDogTWF0aC5wb3coeDIsIGV4cG9uZW50KTsKICB9Owp9CmZ1bmN0aW9uIHRyYW5zZm9ybVNxcnQoeDIpIHsKICByZXR1cm4geDIgPCAwID8gLU1hdGguc3FydCgteDIpIDogTWF0aC5zcXJ0KHgyKTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1TcXVhcmUoeDIpIHsKICByZXR1cm4geDIgPCAwID8gLXgyICogeDIgOiB4MiAqIHgyOwp9CmZ1bmN0aW9uIHBvd2lzaCh0cmFuc2Zvcm0pIHsKICB2YXIgc2NhbGUgPSB0cmFuc2Zvcm0oaWRlbnRpdHksIGlkZW50aXR5KSwgZXhwb25lbnQgPSAxOwogIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICByZXR1cm4gZXhwb25lbnQgPT09IDEgPyB0cmFuc2Zvcm0oaWRlbnRpdHksIGlkZW50aXR5KSA6IGV4cG9uZW50ID09PSAwLjUgPyB0cmFuc2Zvcm0odHJhbnNmb3JtU3FydCwgdHJhbnNmb3JtU3F1YXJlKSA6IHRyYW5zZm9ybSh0cmFuc2Zvcm1Qb3coZXhwb25lbnQpLCB0cmFuc2Zvcm1Qb3coMSAvIGV4cG9uZW50KSk7CiAgfQogIHNjYWxlLmV4cG9uZW50ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZXhwb25lbnQgPSArXywgcmVzY2FsZSgpKSA6IGV4cG9uZW50OwogIH07CiAgcmV0dXJuIGxpbmVhcmlzaChzY2FsZSk7Cn0KZnVuY3Rpb24gcG93KCkgewogIHZhciBzY2FsZSA9IHBvd2lzaCh0cmFuc2Zvcm1lcigpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weShzY2FsZSwgcG93KCkpLmV4cG9uZW50KHNjYWxlLmV4cG9uZW50KCkpOwogIH07CiAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwogIHJldHVybiBzY2FsZTsKfQpmdW5jdGlvbiBzcXJ0KCkgewogIHJldHVybiBwb3cuYXBwbHkobnVsbCwgYXJndW1lbnRzKS5leHBvbmVudCgwLjUpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9yYWRpYWwuanMKZnVuY3Rpb24gc3F1YXJlKHgyKSB7CiAgcmV0dXJuIE1hdGguc2lnbih4MikgKiB4MiAqIHgyOwp9CmZ1bmN0aW9uIHVuc3F1YXJlKHgyKSB7CiAgcmV0dXJuIE1hdGguc2lnbih4MikgKiBNYXRoLnNxcnQoTWF0aC5hYnMoeDIpKTsKfQpmdW5jdGlvbiByYWRpYWwoKSB7CiAgdmFyIHNxdWFyZWQgPSBjb250aW51b3VzKCksIHJhbmdlNCA9IFswLCAxXSwgcm91bmQgPSBmYWxzZSwgdW5rbm93bjsKICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgdmFyIHkyID0gdW5zcXVhcmUoc3F1YXJlZCh4MikpOwogICAgcmV0dXJuIGlzTmFOKHkyKSA/IHVua25vd24gOiByb3VuZCA/IE1hdGgucm91bmQoeTIpIDogeTI7CiAgfQogIHNjYWxlLmludmVydCA9IGZ1bmN0aW9uKHkyKSB7CiAgICByZXR1cm4gc3F1YXJlZC5pbnZlcnQoc3F1YXJlKHkyKSk7CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChzcXVhcmVkLmRvbWFpbihfKSwgc2NhbGUpIDogc3F1YXJlZC5kb21haW4oKTsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoc3F1YXJlZC5yYW5nZSgocmFuZ2U0ID0gQXJyYXkuZnJvbShfLCBudW1iZXIyKSkubWFwKHNxdWFyZSkpLCBzY2FsZSkgOiByYW5nZTQuc2xpY2UoKTsKICB9OwogIHNjYWxlLnJhbmdlUm91bmQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gc2NhbGUucmFuZ2UoXykucm91bmQodHJ1ZSk7CiAgfTsKICBzY2FsZS5yb3VuZCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJvdW5kID0gISFfLCBzY2FsZSkgOiByb3VuZDsKICB9OwogIHNjYWxlLmNsYW1wID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoc3F1YXJlZC5jbGFtcChfKSwgc2NhbGUpIDogc3F1YXJlZC5jbGFtcCgpOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHJhZGlhbChzcXVhcmVkLmRvbWFpbigpLCByYW5nZTQpLnJvdW5kKHJvdW5kKS5jbGFtcChzcXVhcmVkLmNsYW1wKCkpLnVua25vd24odW5rbm93bik7CiAgfTsKICBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7CiAgcmV0dXJuIGxpbmVhcmlzaChzY2FsZSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3F1YW50aWxlLmpzCmZ1bmN0aW9uIHF1YW50aWxlMigpIHsKICB2YXIgZG9tYWluID0gW10sIHJhbmdlNCA9IFtdLCB0aHJlc2hvbGRzID0gW10sIHVua25vd247CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIHZhciBpID0gMCwgbiA9IE1hdGgubWF4KDEsIHJhbmdlNC5sZW5ndGgpOwogICAgdGhyZXNob2xkcyA9IG5ldyBBcnJheShuIC0gMSk7CiAgICB3aGlsZSAoKytpIDwgbikgdGhyZXNob2xkc1tpIC0gMV0gPSBxdWFudGlsZVNvcnRlZChkb21haW4sIGkgLyBuKTsKICAgIHJldHVybiBzY2FsZTsKICB9CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiA9PSBudWxsIHx8IGlzTmFOKHgyID0gK3gyKSA/IHVua25vd24gOiByYW5nZTRbYmlzZWN0X2RlZmF1bHQodGhyZXNob2xkcywgeDIpXTsKICB9CiAgc2NhbGUuaW52ZXJ0RXh0ZW50ID0gZnVuY3Rpb24oeTIpIHsKICAgIHZhciBpID0gcmFuZ2U0LmluZGV4T2YoeTIpOwogICAgcmV0dXJuIGkgPCAwID8gW05hTiwgTmFOXSA6IFsKICAgICAgaSA+IDAgPyB0aHJlc2hvbGRzW2kgLSAxXSA6IGRvbWFpblswXSwKICAgICAgaSA8IHRocmVzaG9sZHMubGVuZ3RoID8gdGhyZXNob2xkc1tpXSA6IGRvbWFpbltkb21haW4ubGVuZ3RoIC0gMV0KICAgIF07CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBkb21haW4uc2xpY2UoKTsKICAgIGRvbWFpbiA9IFtdOwogICAgZm9yIChsZXQgZCBvZiBfKSBpZiAoZCAhPSBudWxsICYmICFpc05hTihkID0gK2QpKSBkb21haW4ucHVzaChkKTsKICAgIGRvbWFpbi5zb3J0KGFzY2VuZGluZyk7CiAgICByZXR1cm4gcmVzY2FsZSgpOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyYW5nZTQgPSBBcnJheS5mcm9tKF8pLCByZXNjYWxlKCkpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICBzY2FsZS5xdWFudGlsZXMgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aHJlc2hvbGRzLnNsaWNlKCk7CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gcXVhbnRpbGUyKCkuZG9tYWluKGRvbWFpbikucmFuZ2UocmFuZ2U0KS51bmtub3duKHVua25vd24pOwogIH07CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvcXVhbnRpemUuanMKZnVuY3Rpb24gcXVhbnRpemUoKSB7CiAgdmFyIHgwID0gMCwgeDEgPSAxLCBuID0gMSwgZG9tYWluID0gWzAuNV0sIHJhbmdlNCA9IFswLCAxXSwgdW5rbm93bjsKICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgcmV0dXJuIHgyICE9IG51bGwgJiYgeDIgPD0geDIgPyByYW5nZTRbYmlzZWN0X2RlZmF1bHQoZG9tYWluLCB4MiwgMCwgbildIDogdW5rbm93bjsKICB9CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIHZhciBpID0gLTE7CiAgICBkb21haW4gPSBuZXcgQXJyYXkobik7CiAgICB3aGlsZSAoKytpIDwgbikgZG9tYWluW2ldID0gKChpICsgMSkgKiB4MSAtIChpIC0gbikgKiB4MCkgLyAobiArIDEpOwogICAgcmV0dXJuIHNjYWxlOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbeDAsIHgxXSA9IF8sIHgwID0gK3gwLCB4MSA9ICt4MSwgcmVzY2FsZSgpKSA6IFt4MCwgeDFdOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChuID0gKHJhbmdlNCA9IEFycmF5LmZyb20oXykpLmxlbmd0aCAtIDEsIHJlc2NhbGUoKSkgOiByYW5nZTQuc2xpY2UoKTsKICB9OwogIHNjYWxlLmludmVydEV4dGVudCA9IGZ1bmN0aW9uKHkyKSB7CiAgICB2YXIgaSA9IHJhbmdlNC5pbmRleE9mKHkyKTsKICAgIHJldHVybiBpIDwgMCA/IFtOYU4sIE5hTl0gOiBpIDwgMSA/IFt4MCwgZG9tYWluWzBdXSA6IGkgPj0gbiA/IFtkb21haW5bbiAtIDFdLCB4MV0gOiBbZG9tYWluW2kgLSAxXSwgZG9tYWluW2ldXTsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogc2NhbGU7CiAgfTsKICBzY2FsZS50aHJlc2hvbGRzID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZG9tYWluLnNsaWNlKCk7CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gcXVhbnRpemUoKS5kb21haW4oW3gwLCB4MV0pLnJhbmdlKHJhbmdlNCkudW5rbm93bih1bmtub3duKTsKICB9OwogIHJldHVybiBpbml0UmFuZ2UuYXBwbHkobGluZWFyaXNoKHNjYWxlKSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvdGhyZXNob2xkLmpzCmZ1bmN0aW9uIHRocmVzaG9sZCgpIHsKICB2YXIgZG9tYWluID0gWzAuNV0sIHJhbmdlNCA9IFswLCAxXSwgdW5rbm93biwgbiA9IDE7CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiAhPSBudWxsICYmIHgyIDw9IHgyID8gcmFuZ2U0W2Jpc2VjdF9kZWZhdWx0KGRvbWFpbiwgeDIsIDAsIG4pXSA6IHVua25vd247CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRvbWFpbiA9IEFycmF5LmZyb20oXyksIG4gPSBNYXRoLm1pbihkb21haW4ubGVuZ3RoLCByYW5nZTQubGVuZ3RoIC0gMSksIHNjYWxlKSA6IGRvbWFpbi5zbGljZSgpOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyYW5nZTQgPSBBcnJheS5mcm9tKF8pLCBuID0gTWF0aC5taW4oZG9tYWluLmxlbmd0aCwgcmFuZ2U0Lmxlbmd0aCAtIDEpLCBzY2FsZSkgOiByYW5nZTQuc2xpY2UoKTsKICB9OwogIHNjYWxlLmludmVydEV4dGVudCA9IGZ1bmN0aW9uKHkyKSB7CiAgICB2YXIgaSA9IHJhbmdlNC5pbmRleE9mKHkyKTsKICAgIHJldHVybiBbZG9tYWluW2kgLSAxXSwgZG9tYWluW2ldXTsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aHJlc2hvbGQoKS5kb21haW4oZG9tYWluKS5yYW5nZShyYW5nZTQpLnVua25vd24odW5rbm93bik7CiAgfTsKICByZXR1cm4gaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvaW50ZXJ2YWwuanMKdmFyIHQwID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCk7CnZhciB0MSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwpmdW5jdGlvbiB0aW1lSW50ZXJ2YWwoZmxvb3JpLCBvZmZzZXRpLCBjb3VudCwgZmllbGQpIHsKICBmdW5jdGlvbiBpbnRlcnZhbChkYXRlMikgewogICAgcmV0dXJuIGZsb29yaShkYXRlMiA9IGFyZ3VtZW50cy5sZW5ndGggPT09IDAgPyAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSA6IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgrZGF0ZTIpKSwgZGF0ZTI7CiAgfQogIGludGVydmFsLmZsb29yID0gKGRhdGUyKSA9PiB7CiAgICByZXR1cm4gZmxvb3JpKGRhdGUyID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCtkYXRlMikpLCBkYXRlMjsKICB9OwogIGludGVydmFsLmNlaWwgPSAoZGF0ZTIpID0+IHsKICAgIHJldHVybiBmbG9vcmkoZGF0ZTIgPSBuZXcgRGF0ZShkYXRlMiAtIDEpKSwgb2Zmc2V0aShkYXRlMiwgMSksIGZsb29yaShkYXRlMiksIGRhdGUyOwogIH07CiAgaW50ZXJ2YWwucm91bmQgPSAoZGF0ZTIpID0+IHsKICAgIGNvbnN0IGQwID0gaW50ZXJ2YWwoZGF0ZTIpLCBkMSA9IGludGVydmFsLmNlaWwoZGF0ZTIpOwogICAgcmV0dXJuIGRhdGUyIC0gZDAgPCBkMSAtIGRhdGUyID8gZDAgOiBkMTsKICB9OwogIGludGVydmFsLm9mZnNldCA9IChkYXRlMiwgc3RlcCkgPT4gewogICAgcmV0dXJuIG9mZnNldGkoZGF0ZTIgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK2RhdGUyKSwgc3RlcCA9PSBudWxsID8gMSA6IE1hdGguZmxvb3Ioc3RlcCkpLCBkYXRlMjsKICB9OwogIGludGVydmFsLnJhbmdlID0gKHN0YXJ0LCBzdG9wLCBzdGVwKSA9PiB7CiAgICBjb25zdCByYW5nZTQgPSBbXTsKICAgIHN0YXJ0ID0gaW50ZXJ2YWwuY2VpbChzdGFydCk7CiAgICBzdGVwID0gc3RlcCA9PSBudWxsID8gMSA6IE1hdGguZmxvb3Ioc3RlcCk7CiAgICBpZiAoIShzdGFydCA8IHN0b3ApIHx8ICEoc3RlcCA+IDApKSByZXR1cm4gcmFuZ2U0OwogICAgbGV0IHByZXZpb3VzOwogICAgZG8KICAgICAgcmFuZ2U0LnB1c2gocHJldmlvdXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK3N0YXJ0KSksIG9mZnNldGkoc3RhcnQsIHN0ZXApLCBmbG9vcmkoc3RhcnQpOwogICAgd2hpbGUgKHByZXZpb3VzIDwgc3RhcnQgJiYgc3RhcnQgPCBzdG9wKTsKICAgIHJldHVybiByYW5nZTQ7CiAgfTsKICBpbnRlcnZhbC5maWx0ZXIgPSAodGVzdCkgPT4gewogICAgcmV0dXJuIHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICAgICAgaWYgKGRhdGUyID49IGRhdGUyKSB3aGlsZSAoZmxvb3JpKGRhdGUyKSwgIXRlc3QoZGF0ZTIpKSBkYXRlMi5zZXRUaW1lKGRhdGUyIC0gMSk7CiAgICB9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICAgICAgaWYgKGRhdGUyID49IGRhdGUyKSB7CiAgICAgICAgaWYgKHN0ZXAgPCAwKSB3aGlsZSAoKytzdGVwIDw9IDApIHsKICAgICAgICAgIHdoaWxlIChvZmZzZXRpKGRhdGUyLCAtMSksICF0ZXN0KGRhdGUyKSkgewogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHdoaWxlICgtLXN0ZXAgPj0gMCkgewogICAgICAgICAgd2hpbGUgKG9mZnNldGkoZGF0ZTIsIDEpLCAhdGVzdChkYXRlMikpIHsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH07CiAgaWYgKGNvdW50KSB7CiAgICBpbnRlcnZhbC5jb3VudCA9IChzdGFydCwgZW5kKSA9PiB7CiAgICAgIHQwLnNldFRpbWUoK3N0YXJ0KSwgdDEuc2V0VGltZSgrZW5kKTsKICAgICAgZmxvb3JpKHQwKSwgZmxvb3JpKHQxKTsKICAgICAgcmV0dXJuIE1hdGguZmxvb3IoY291bnQodDAsIHQxKSk7CiAgICB9OwogICAgaW50ZXJ2YWwuZXZlcnkgPSAoc3RlcCkgPT4gewogICAgICBzdGVwID0gTWF0aC5mbG9vcihzdGVwKTsKICAgICAgcmV0dXJuICFpc0Zpbml0ZShzdGVwKSB8fCAhKHN0ZXAgPiAwKSA/IG51bGwgOiAhKHN0ZXAgPiAxKSA/IGludGVydmFsIDogaW50ZXJ2YWwuZmlsdGVyKGZpZWxkID8gKGQpID0+IGZpZWxkKGQpICUgc3RlcCA9PT0gMCA6IChkKSA9PiBpbnRlcnZhbC5jb3VudCgwLCBkKSAlIHN0ZXAgPT09IDApOwogICAgfTsKICB9CiAgcmV0dXJuIGludGVydmFsOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvbWlsbGlzZWNvbmQuanMKdmFyIG1pbGxpc2Vjb25kID0gdGltZUludGVydmFsKCgpID0+IHsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kIC0gc3RhcnQ7Cn0pOwptaWxsaXNlY29uZC5ldmVyeSA9IChrKSA9PiB7CiAgayA9IE1hdGguZmxvb3Ioayk7CiAgaWYgKCFpc0Zpbml0ZShrKSB8fCAhKGsgPiAwKSkgcmV0dXJuIG51bGw7CiAgaWYgKCEoayA+IDEpKSByZXR1cm4gbWlsbGlzZWNvbmQ7CiAgcmV0dXJuIHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICAgIGRhdGUyLnNldFRpbWUoTWF0aC5mbG9vcihkYXRlMiAvIGspICogayk7CiAgfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXAgKiBrKTsKICB9LCAoc3RhcnQsIGVuZCkgPT4gewogICAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBrOwogIH0pOwp9Owp2YXIgbWlsbGlzZWNvbmRzID0gbWlsbGlzZWNvbmQucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvZHVyYXRpb24uanMKdmFyIGR1cmF0aW9uU2Vjb25kID0gMWUzOwp2YXIgZHVyYXRpb25NaW51dGUgPSBkdXJhdGlvblNlY29uZCAqIDYwOwp2YXIgZHVyYXRpb25Ib3VyID0gZHVyYXRpb25NaW51dGUgKiA2MDsKdmFyIGR1cmF0aW9uRGF5ID0gZHVyYXRpb25Ib3VyICogMjQ7CnZhciBkdXJhdGlvbldlZWsgPSBkdXJhdGlvbkRheSAqIDc7CnZhciBkdXJhdGlvbk1vbnRoID0gZHVyYXRpb25EYXkgKiAzMDsKdmFyIGR1cmF0aW9uWWVhciA9IGR1cmF0aW9uRGF5ICogMzY1OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXRpbWVAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL3NlY29uZC5qcwp2YXIgc2Vjb25kID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFRpbWUoZGF0ZTIgLSBkYXRlMi5nZXRNaWxsaXNlY29uZHMoKSk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCAqIGR1cmF0aW9uU2Vjb25kKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uU2Vjb25kOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDU2Vjb25kcygpOwp9KTsKdmFyIHNlY29uZHMgPSBzZWNvbmQucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvbWludXRlLmpzCnZhciB0aW1lTWludXRlID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFRpbWUoZGF0ZTIgLSBkYXRlMi5nZXRNaWxsaXNlY29uZHMoKSAtIGRhdGUyLmdldFNlY29uZHMoKSAqIGR1cmF0aW9uU2Vjb25kKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwICogZHVyYXRpb25NaW51dGUpOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25NaW51dGU7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRNaW51dGVzKCk7Cn0pOwp2YXIgdGltZU1pbnV0ZXMgPSB0aW1lTWludXRlLnJhbmdlOwp2YXIgdXRjTWludXRlID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ1NlY29uZHMoMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCAqIGR1cmF0aW9uTWludXRlKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uTWludXRlOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDTWludXRlcygpOwp9KTsKdmFyIHV0Y01pbnV0ZXMgPSB1dGNNaW51dGUucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvaG91ci5qcwp2YXIgdGltZUhvdXIgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VGltZShkYXRlMiAtIGRhdGUyLmdldE1pbGxpc2Vjb25kcygpIC0gZGF0ZTIuZ2V0U2Vjb25kcygpICogZHVyYXRpb25TZWNvbmQgLSBkYXRlMi5nZXRNaW51dGVzKCkgKiBkdXJhdGlvbk1pbnV0ZSk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCAqIGR1cmF0aW9uSG91cik7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbkhvdXI7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRIb3VycygpOwp9KTsKdmFyIHRpbWVIb3VycyA9IHRpbWVIb3VyLnJhbmdlOwp2YXIgdXRjSG91ciA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRVVENNaW51dGVzKDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXAgKiBkdXJhdGlvbkhvdXIpOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25Ib3VyOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDSG91cnMoKTsKfSk7CnZhciB1dGNIb3VycyA9IHV0Y0hvdXIucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvZGF5LmpzCnZhciB0aW1lRGF5ID0gdGltZUludGVydmFsKAogIChkYXRlMikgPT4gZGF0ZTIuc2V0SG91cnMoMCwgMCwgMCwgMCksCiAgKGRhdGUyLCBzdGVwKSA9PiBkYXRlMi5zZXREYXRlKGRhdGUyLmdldERhdGUoKSArIHN0ZXApLAogIChzdGFydCwgZW5kKSA9PiAoZW5kIC0gc3RhcnQgLSAoZW5kLmdldFRpbWV6b25lT2Zmc2V0KCkgLSBzdGFydC5nZXRUaW1lem9uZU9mZnNldCgpKSAqIGR1cmF0aW9uTWludXRlKSAvIGR1cmF0aW9uRGF5LAogIChkYXRlMikgPT4gZGF0ZTIuZ2V0RGF0ZSgpIC0gMQopOwp2YXIgdGltZURheXMgPSB0aW1lRGF5LnJhbmdlOwp2YXIgdXRjRGF5ID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRVVENEYXRlKGRhdGUyLmdldFVUQ0RhdGUoKSArIHN0ZXApOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25EYXk7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRVVENEYXRlKCkgLSAxOwp9KTsKdmFyIHV0Y0RheXMgPSB1dGNEYXkucmFuZ2U7CnZhciB1bml4RGF5ID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRVVENEYXRlKGRhdGUyLmdldFVUQ0RhdGUoKSArIHN0ZXApOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25EYXk7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBNYXRoLmZsb29yKGRhdGUyIC8gZHVyYXRpb25EYXkpOwp9KTsKdmFyIHVuaXhEYXlzID0gdW5peERheS5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy10aW1lQDMuMS4wL25vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy93ZWVrLmpzCmZ1bmN0aW9uIHRpbWVXZWVrZGF5KGkpIHsKICByZXR1cm4gdGltZUludGVydmFsKChkYXRlMikgPT4gewogICAgZGF0ZTIuc2V0RGF0ZShkYXRlMi5nZXREYXRlKCkgLSAoZGF0ZTIuZ2V0RGF5KCkgKyA3IC0gaSkgJSA3KTsKICAgIGRhdGUyLnNldEhvdXJzKDAsIDAsIDAsIDApOwogIH0sIChkYXRlMiwgc3RlcCkgPT4gewogICAgZGF0ZTIuc2V0RGF0ZShkYXRlMi5nZXREYXRlKCkgKyBzdGVwICogNyk7CiAgfSwgKHN0YXJ0LCBlbmQpID0+IHsKICAgIHJldHVybiAoZW5kIC0gc3RhcnQgLSAoZW5kLmdldFRpbWV6b25lT2Zmc2V0KCkgLSBzdGFydC5nZXRUaW1lem9uZU9mZnNldCgpKSAqIGR1cmF0aW9uTWludXRlKSAvIGR1cmF0aW9uV2VlazsKICB9KTsKfQp2YXIgdGltZVN1bmRheSA9IHRpbWVXZWVrZGF5KDApOwp2YXIgdGltZU1vbmRheSA9IHRpbWVXZWVrZGF5KDEpOwp2YXIgdGltZVR1ZXNkYXkgPSB0aW1lV2Vla2RheSgyKTsKdmFyIHRpbWVXZWRuZXNkYXkgPSB0aW1lV2Vla2RheSgzKTsKdmFyIHRpbWVUaHVyc2RheSA9IHRpbWVXZWVrZGF5KDQpOwp2YXIgdGltZUZyaWRheSA9IHRpbWVXZWVrZGF5KDUpOwp2YXIgdGltZVNhdHVyZGF5ID0gdGltZVdlZWtkYXkoNik7CnZhciB0aW1lU3VuZGF5cyA9IHRpbWVTdW5kYXkucmFuZ2U7CnZhciB0aW1lTW9uZGF5cyA9IHRpbWVNb25kYXkucmFuZ2U7CnZhciB0aW1lVHVlc2RheXMgPSB0aW1lVHVlc2RheS5yYW5nZTsKdmFyIHRpbWVXZWRuZXNkYXlzID0gdGltZVdlZG5lc2RheS5yYW5nZTsKdmFyIHRpbWVUaHVyc2RheXMgPSB0aW1lVGh1cnNkYXkucmFuZ2U7CnZhciB0aW1lRnJpZGF5cyA9IHRpbWVGcmlkYXkucmFuZ2U7CnZhciB0aW1lU2F0dXJkYXlzID0gdGltZVNhdHVyZGF5LnJhbmdlOwpmdW5jdGlvbiB1dGNXZWVrZGF5KGkpIHsKICByZXR1cm4gdGltZUludGVydmFsKChkYXRlMikgPT4gewogICAgZGF0ZTIuc2V0VVRDRGF0ZShkYXRlMi5nZXRVVENEYXRlKCkgLSAoZGF0ZTIuZ2V0VVRDRGF5KCkgKyA3IC0gaSkgJSA3KTsKICAgIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwogIH0sIChkYXRlMiwgc3RlcCkgPT4gewogICAgZGF0ZTIuc2V0VVRDRGF0ZShkYXRlMi5nZXRVVENEYXRlKCkgKyBzdGVwICogNyk7CiAgfSwgKHN0YXJ0LCBlbmQpID0+IHsKICAgIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25XZWVrOwogIH0pOwp9CnZhciB1dGNTdW5kYXkgPSB1dGNXZWVrZGF5KDApOwp2YXIgdXRjTW9uZGF5ID0gdXRjV2Vla2RheSgxKTsKdmFyIHV0Y1R1ZXNkYXkgPSB1dGNXZWVrZGF5KDIpOwp2YXIgdXRjV2VkbmVzZGF5ID0gdXRjV2Vla2RheSgzKTsKdmFyIHV0Y1RodXJzZGF5ID0gdXRjV2Vla2RheSg0KTsKdmFyIHV0Y0ZyaWRheSA9IHV0Y1dlZWtkYXkoNSk7CnZhciB1dGNTYXR1cmRheSA9IHV0Y1dlZWtkYXkoNik7CnZhciB1dGNTdW5kYXlzID0gdXRjU3VuZGF5LnJhbmdlOwp2YXIgdXRjTW9uZGF5cyA9IHV0Y01vbmRheS5yYW5nZTsKdmFyIHV0Y1R1ZXNkYXlzID0gdXRjVHVlc2RheS5yYW5nZTsKdmFyIHV0Y1dlZG5lc2RheXMgPSB1dGNXZWRuZXNkYXkucmFuZ2U7CnZhciB1dGNUaHVyc2RheXMgPSB1dGNUaHVyc2RheS5yYW5nZTsKdmFyIHV0Y0ZyaWRheXMgPSB1dGNGcmlkYXkucmFuZ2U7CnZhciB1dGNTYXR1cmRheXMgPSB1dGNTYXR1cmRheS5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy10aW1lQDMuMS4wL25vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9tb250aC5qcwp2YXIgdGltZU1vbnRoID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldERhdGUoMSk7CiAgZGF0ZTIuc2V0SG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldE1vbnRoKGRhdGUyLmdldE1vbnRoKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kLmdldE1vbnRoKCkgLSBzdGFydC5nZXRNb250aCgpICsgKGVuZC5nZXRGdWxsWWVhcigpIC0gc3RhcnQuZ2V0RnVsbFllYXIoKSkgKiAxMjsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldE1vbnRoKCk7Cn0pOwp2YXIgdGltZU1vbnRocyA9IHRpbWVNb250aC5yYW5nZTsKdmFyIHV0Y01vbnRoID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ0RhdGUoMSk7CiAgZGF0ZTIuc2V0VVRDSG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFVUQ01vbnRoKGRhdGUyLmdldFVUQ01vbnRoKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kLmdldFVUQ01vbnRoKCkgLSBzdGFydC5nZXRVVENNb250aCgpICsgKGVuZC5nZXRVVENGdWxsWWVhcigpIC0gc3RhcnQuZ2V0VVRDRnVsbFllYXIoKSkgKiAxMjsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldFVUQ01vbnRoKCk7Cn0pOwp2YXIgdXRjTW9udGhzID0gdXRjTW9udGgucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMveWVhci5qcwp2YXIgdGltZVllYXIgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0TW9udGgoMCwgMSk7CiAgZGF0ZTIuc2V0SG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldEZ1bGxZZWFyKGRhdGUyLmdldEZ1bGxZZWFyKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kLmdldEZ1bGxZZWFyKCkgLSBzdGFydC5nZXRGdWxsWWVhcigpOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0RnVsbFllYXIoKTsKfSk7CnRpbWVZZWFyLmV2ZXJ5ID0gKGspID0+IHsKICByZXR1cm4gIWlzRmluaXRlKGsgPSBNYXRoLmZsb29yKGspKSB8fCAhKGsgPiAwKSA/IG51bGwgOiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICBkYXRlMi5zZXRGdWxsWWVhcihNYXRoLmZsb29yKGRhdGUyLmdldEZ1bGxZZWFyKCkgLyBrKSAqIGspOwogICAgZGF0ZTIuc2V0TW9udGgoMCwgMSk7CiAgICBkYXRlMi5zZXRIb3VycygwLCAwLCAwLCAwKTsKICB9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICAgIGRhdGUyLnNldEZ1bGxZZWFyKGRhdGUyLmdldEZ1bGxZZWFyKCkgKyBzdGVwICogayk7CiAgfSk7Cn07CnZhciB0aW1lWWVhcnMgPSB0aW1lWWVhci5yYW5nZTsKdmFyIHV0Y1llYXIgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VVRDTW9udGgoMCwgMSk7CiAgZGF0ZTIuc2V0VVRDSG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFVUQ0Z1bGxZZWFyKGRhdGUyLmdldFVUQ0Z1bGxZZWFyKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gZW5kLmdldFVUQ0Z1bGxZZWFyKCkgLSBzdGFydC5nZXRVVENGdWxsWWVhcigpOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDRnVsbFllYXIoKTsKfSk7CnV0Y1llYXIuZXZlcnkgPSAoaykgPT4gewogIHJldHVybiAhaXNGaW5pdGUoayA9IE1hdGguZmxvb3IoaykpIHx8ICEoayA+IDApID8gbnVsbCA6IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICAgIGRhdGUyLnNldFVUQ0Z1bGxZZWFyKE1hdGguZmxvb3IoZGF0ZTIuZ2V0VVRDRnVsbFllYXIoKSAvIGspICogayk7CiAgICBkYXRlMi5zZXRVVENNb250aCgwLCAxKTsKICAgIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwogIH0sIChkYXRlMiwgc3RlcCkgPT4gewogICAgZGF0ZTIuc2V0VVRDRnVsbFllYXIoZGF0ZTIuZ2V0VVRDRnVsbFllYXIoKSArIHN0ZXAgKiBrKTsKICB9KTsKfTsKdmFyIHV0Y1llYXJzID0gdXRjWWVhci5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy10aW1lQDMuMS4wL25vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy90aWNrcy5qcwpmdW5jdGlvbiB0aWNrZXIoeWVhciwgbW9udGgsIHdlZWssIGRheSwgaG91ciwgbWludXRlKSB7CiAgY29uc3QgdGlja0ludGVydmFscyA9IFsKICAgIFtzZWNvbmQsIDEsIGR1cmF0aW9uU2Vjb25kXSwKICAgIFtzZWNvbmQsIDUsIDUgKiBkdXJhdGlvblNlY29uZF0sCiAgICBbc2Vjb25kLCAxNSwgMTUgKiBkdXJhdGlvblNlY29uZF0sCiAgICBbc2Vjb25kLCAzMCwgMzAgKiBkdXJhdGlvblNlY29uZF0sCiAgICBbbWludXRlLCAxLCBkdXJhdGlvbk1pbnV0ZV0sCiAgICBbbWludXRlLCA1LCA1ICogZHVyYXRpb25NaW51dGVdLAogICAgW21pbnV0ZSwgMTUsIDE1ICogZHVyYXRpb25NaW51dGVdLAogICAgW21pbnV0ZSwgMzAsIDMwICogZHVyYXRpb25NaW51dGVdLAogICAgW2hvdXIsIDEsIGR1cmF0aW9uSG91cl0sCiAgICBbaG91ciwgMywgMyAqIGR1cmF0aW9uSG91cl0sCiAgICBbaG91ciwgNiwgNiAqIGR1cmF0aW9uSG91cl0sCiAgICBbaG91ciwgMTIsIDEyICogZHVyYXRpb25Ib3VyXSwKICAgIFtkYXksIDEsIGR1cmF0aW9uRGF5XSwKICAgIFtkYXksIDIsIDIgKiBkdXJhdGlvbkRheV0sCiAgICBbd2VlaywgMSwgZHVyYXRpb25XZWVrXSwKICAgIFttb250aCwgMSwgZHVyYXRpb25Nb250aF0sCiAgICBbbW9udGgsIDMsIDMgKiBkdXJhdGlvbk1vbnRoXSwKICAgIFt5ZWFyLCAxLCBkdXJhdGlvblllYXJdCiAgXTsKICBmdW5jdGlvbiB0aWNrczIoc3RhcnQsIHN0b3AsIGNvdW50KSB7CiAgICBjb25zdCByZXZlcnNlMiA9IHN0b3AgPCBzdGFydDsKICAgIGlmIChyZXZlcnNlMikgW3N0YXJ0LCBzdG9wXSA9IFtzdG9wLCBzdGFydF07CiAgICBjb25zdCBpbnRlcnZhbCA9IGNvdW50ICYmIHR5cGVvZiBjb3VudC5yYW5nZSA9PT0gImZ1bmN0aW9uIiA/IGNvdW50IDogdGlja0ludGVydmFsKHN0YXJ0LCBzdG9wLCBjb3VudCk7CiAgICBjb25zdCB0aWNrczMgPSBpbnRlcnZhbCA/IGludGVydmFsLnJhbmdlKHN0YXJ0LCArc3RvcCArIDEpIDogW107CiAgICByZXR1cm4gcmV2ZXJzZTIgPyB0aWNrczMucmV2ZXJzZSgpIDogdGlja3MzOwogIH0KICBmdW5jdGlvbiB0aWNrSW50ZXJ2YWwoc3RhcnQsIHN0b3AsIGNvdW50KSB7CiAgICBjb25zdCB0YXJnZXQgPSBNYXRoLmFicyhzdG9wIC0gc3RhcnQpIC8gY291bnQ7CiAgICBjb25zdCBpID0gYmlzZWN0b3IoKFssICwgc3RlcDJdKSA9PiBzdGVwMikucmlnaHQodGlja0ludGVydmFscywgdGFyZ2V0KTsKICAgIGlmIChpID09PSB0aWNrSW50ZXJ2YWxzLmxlbmd0aCkgcmV0dXJuIHllYXIuZXZlcnkodGlja1N0ZXAoc3RhcnQgLyBkdXJhdGlvblllYXIsIHN0b3AgLyBkdXJhdGlvblllYXIsIGNvdW50KSk7CiAgICBpZiAoaSA9PT0gMCkgcmV0dXJuIG1pbGxpc2Vjb25kLmV2ZXJ5KE1hdGgubWF4KHRpY2tTdGVwKHN0YXJ0LCBzdG9wLCBjb3VudCksIDEpKTsKICAgIGNvbnN0IFt0LCBzdGVwXSA9IHRpY2tJbnRlcnZhbHNbdGFyZ2V0IC8gdGlja0ludGVydmFsc1tpIC0gMV1bMl0gPCB0aWNrSW50ZXJ2YWxzW2ldWzJdIC8gdGFyZ2V0ID8gaSAtIDEgOiBpXTsKICAgIHJldHVybiB0LmV2ZXJ5KHN0ZXApOwogIH0KICByZXR1cm4gW3RpY2tzMiwgdGlja0ludGVydmFsXTsKfQp2YXIgW3V0Y1RpY2tzLCB1dGNUaWNrSW50ZXJ2YWxdID0gdGlja2VyKHV0Y1llYXIsIHV0Y01vbnRoLCB1dGNTdW5kYXksIHVuaXhEYXksIHV0Y0hvdXIsIHV0Y01pbnV0ZSk7CnZhciBbdGltZVRpY2tzLCB0aW1lVGlja0ludGVydmFsXSA9IHRpY2tlcih0aW1lWWVhciwgdGltZU1vbnRoLCB0aW1lU3VuZGF5LCB0aW1lRGF5LCB0aW1lSG91ciwgdGltZU1pbnV0ZSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZS1mb3JtYXRANC4xLjAvbm9kZV9tb2R1bGVzL2QzLXRpbWUtZm9ybWF0L3NyYy9sb2NhbGUuanMKZnVuY3Rpb24gbG9jYWxEYXRlKGQpIHsKICBpZiAoMCA8PSBkLnkgJiYgZC55IDwgMTAwKSB7CiAgICB2YXIgZGF0ZTIgPSBuZXcgRGF0ZSgtMSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCk7CiAgICBkYXRlMi5zZXRGdWxsWWVhcihkLnkpOwogICAgcmV0dXJuIGRhdGUyOwogIH0KICByZXR1cm4gbmV3IERhdGUoZC55LCBkLm0sIGQuZCwgZC5ILCBkLk0sIGQuUywgZC5MKTsKfQpmdW5jdGlvbiB1dGNEYXRlKGQpIHsKICBpZiAoMCA8PSBkLnkgJiYgZC55IDwgMTAwKSB7CiAgICB2YXIgZGF0ZTIgPSBuZXcgRGF0ZShEYXRlLlVUQygtMSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCkpOwogICAgZGF0ZTIuc2V0VVRDRnVsbFllYXIoZC55KTsKICAgIHJldHVybiBkYXRlMjsKICB9CiAgcmV0dXJuIG5ldyBEYXRlKERhdGUuVVRDKGQueSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCkpOwp9CmZ1bmN0aW9uIG5ld0RhdGUoeTIsIG0sIGQpIHsKICByZXR1cm4geyB5OiB5MiwgbSwgZCwgSDogMCwgTTogMCwgUzogMCwgTDogMCB9Owp9CmZ1bmN0aW9uIGZvcm1hdExvY2FsZShsb2NhbGUzKSB7CiAgdmFyIGxvY2FsZV9kYXRlVGltZSA9IGxvY2FsZTMuZGF0ZVRpbWUsIGxvY2FsZV9kYXRlID0gbG9jYWxlMy5kYXRlLCBsb2NhbGVfdGltZSA9IGxvY2FsZTMudGltZSwgbG9jYWxlX3BlcmlvZHMgPSBsb2NhbGUzLnBlcmlvZHMsIGxvY2FsZV93ZWVrZGF5cyA9IGxvY2FsZTMuZGF5cywgbG9jYWxlX3Nob3J0V2Vla2RheXMgPSBsb2NhbGUzLnNob3J0RGF5cywgbG9jYWxlX21vbnRocyA9IGxvY2FsZTMubW9udGhzLCBsb2NhbGVfc2hvcnRNb250aHMgPSBsb2NhbGUzLnNob3J0TW9udGhzOwogIHZhciBwZXJpb2RSZSA9IGZvcm1hdFJlKGxvY2FsZV9wZXJpb2RzKSwgcGVyaW9kTG9va3VwID0gZm9ybWF0TG9va3VwKGxvY2FsZV9wZXJpb2RzKSwgd2Vla2RheVJlID0gZm9ybWF0UmUobG9jYWxlX3dlZWtkYXlzKSwgd2Vla2RheUxvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfd2Vla2RheXMpLCBzaG9ydFdlZWtkYXlSZSA9IGZvcm1hdFJlKGxvY2FsZV9zaG9ydFdlZWtkYXlzKSwgc2hvcnRXZWVrZGF5TG9va3VwID0gZm9ybWF0TG9va3VwKGxvY2FsZV9zaG9ydFdlZWtkYXlzKSwgbW9udGhSZSA9IGZvcm1hdFJlKGxvY2FsZV9tb250aHMpLCBtb250aExvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfbW9udGhzKSwgc2hvcnRNb250aFJlID0gZm9ybWF0UmUobG9jYWxlX3Nob3J0TW9udGhzKSwgc2hvcnRNb250aExvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfc2hvcnRNb250aHMpOwogIHZhciBmb3JtYXRzID0gewogICAgImEiOiBmb3JtYXRTaG9ydFdlZWtkYXksCiAgICAiQSI6IGZvcm1hdFdlZWtkYXksCiAgICAiYiI6IGZvcm1hdFNob3J0TW9udGgsCiAgICAiQiI6IGZvcm1hdE1vbnRoLAogICAgImMiOiBudWxsLAogICAgImQiOiBmb3JtYXREYXlPZk1vbnRoLAogICAgImUiOiBmb3JtYXREYXlPZk1vbnRoLAogICAgImYiOiBmb3JtYXRNaWNyb3NlY29uZHMsCiAgICAiZyI6IGZvcm1hdFllYXJJU08sCiAgICAiRyI6IGZvcm1hdEZ1bGxZZWFySVNPLAogICAgIkgiOiBmb3JtYXRIb3VyMjQsCiAgICAiSSI6IGZvcm1hdEhvdXIxMiwKICAgICJqIjogZm9ybWF0RGF5T2ZZZWFyLAogICAgIkwiOiBmb3JtYXRNaWxsaXNlY29uZHMsCiAgICAibSI6IGZvcm1hdE1vbnRoTnVtYmVyLAogICAgIk0iOiBmb3JtYXRNaW51dGVzLAogICAgInAiOiBmb3JtYXRQZXJpb2QsCiAgICAicSI6IGZvcm1hdFF1YXJ0ZXIsCiAgICAiUSI6IGZvcm1hdFVuaXhUaW1lc3RhbXAsCiAgICAicyI6IGZvcm1hdFVuaXhUaW1lc3RhbXBTZWNvbmRzLAogICAgIlMiOiBmb3JtYXRTZWNvbmRzLAogICAgInUiOiBmb3JtYXRXZWVrZGF5TnVtYmVyTW9uZGF5LAogICAgIlUiOiBmb3JtYXRXZWVrTnVtYmVyU3VuZGF5LAogICAgIlYiOiBmb3JtYXRXZWVrTnVtYmVySVNPLAogICAgInciOiBmb3JtYXRXZWVrZGF5TnVtYmVyU3VuZGF5LAogICAgIlciOiBmb3JtYXRXZWVrTnVtYmVyTW9uZGF5LAogICAgIngiOiBudWxsLAogICAgIlgiOiBudWxsLAogICAgInkiOiBmb3JtYXRZZWFyLAogICAgIlkiOiBmb3JtYXRGdWxsWWVhciwKICAgICJaIjogZm9ybWF0Wm9uZSwKICAgICIlIjogZm9ybWF0TGl0ZXJhbFBlcmNlbnQKICB9OwogIHZhciB1dGNGb3JtYXRzID0gewogICAgImEiOiBmb3JtYXRVVENTaG9ydFdlZWtkYXksCiAgICAiQSI6IGZvcm1hdFVUQ1dlZWtkYXksCiAgICAiYiI6IGZvcm1hdFVUQ1Nob3J0TW9udGgsCiAgICAiQiI6IGZvcm1hdFVUQ01vbnRoLAogICAgImMiOiBudWxsLAogICAgImQiOiBmb3JtYXRVVENEYXlPZk1vbnRoLAogICAgImUiOiBmb3JtYXRVVENEYXlPZk1vbnRoLAogICAgImYiOiBmb3JtYXRVVENNaWNyb3NlY29uZHMsCiAgICAiZyI6IGZvcm1hdFVUQ1llYXJJU08sCiAgICAiRyI6IGZvcm1hdFVUQ0Z1bGxZZWFySVNPLAogICAgIkgiOiBmb3JtYXRVVENIb3VyMjQsCiAgICAiSSI6IGZvcm1hdFVUQ0hvdXIxMiwKICAgICJqIjogZm9ybWF0VVRDRGF5T2ZZZWFyLAogICAgIkwiOiBmb3JtYXRVVENNaWxsaXNlY29uZHMsCiAgICAibSI6IGZvcm1hdFVUQ01vbnRoTnVtYmVyLAogICAgIk0iOiBmb3JtYXRVVENNaW51dGVzLAogICAgInAiOiBmb3JtYXRVVENQZXJpb2QsCiAgICAicSI6IGZvcm1hdFVUQ1F1YXJ0ZXIsCiAgICAiUSI6IGZvcm1hdFVuaXhUaW1lc3RhbXAsCiAgICAicyI6IGZvcm1hdFVuaXhUaW1lc3RhbXBTZWNvbmRzLAogICAgIlMiOiBmb3JtYXRVVENTZWNvbmRzLAogICAgInUiOiBmb3JtYXRVVENXZWVrZGF5TnVtYmVyTW9uZGF5LAogICAgIlUiOiBmb3JtYXRVVENXZWVrTnVtYmVyU3VuZGF5LAogICAgIlYiOiBmb3JtYXRVVENXZWVrTnVtYmVySVNPLAogICAgInciOiBmb3JtYXRVVENXZWVrZGF5TnVtYmVyU3VuZGF5LAogICAgIlciOiBmb3JtYXRVVENXZWVrTnVtYmVyTW9uZGF5LAogICAgIngiOiBudWxsLAogICAgIlgiOiBudWxsLAogICAgInkiOiBmb3JtYXRVVENZZWFyLAogICAgIlkiOiBmb3JtYXRVVENGdWxsWWVhciwKICAgICJaIjogZm9ybWF0VVRDWm9uZSwKICAgICIlIjogZm9ybWF0TGl0ZXJhbFBlcmNlbnQKICB9OwogIHZhciBwYXJzZXMgPSB7CiAgICAiYSI6IHBhcnNlU2hvcnRXZWVrZGF5LAogICAgIkEiOiBwYXJzZVdlZWtkYXksCiAgICAiYiI6IHBhcnNlU2hvcnRNb250aCwKICAgICJCIjogcGFyc2VNb250aCwKICAgICJjIjogcGFyc2VMb2NhbGVEYXRlVGltZSwKICAgICJkIjogcGFyc2VEYXlPZk1vbnRoLAogICAgImUiOiBwYXJzZURheU9mTW9udGgsCiAgICAiZiI6IHBhcnNlTWljcm9zZWNvbmRzLAogICAgImciOiBwYXJzZVllYXIsCiAgICAiRyI6IHBhcnNlRnVsbFllYXIsCiAgICAiSCI6IHBhcnNlSG91cjI0LAogICAgIkkiOiBwYXJzZUhvdXIyNCwKICAgICJqIjogcGFyc2VEYXlPZlllYXIsCiAgICAiTCI6IHBhcnNlTWlsbGlzZWNvbmRzLAogICAgIm0iOiBwYXJzZU1vbnRoTnVtYmVyLAogICAgIk0iOiBwYXJzZU1pbnV0ZXMsCiAgICAicCI6IHBhcnNlUGVyaW9kLAogICAgInEiOiBwYXJzZVF1YXJ0ZXIsCiAgICAiUSI6IHBhcnNlVW5peFRpbWVzdGFtcCwKICAgICJzIjogcGFyc2VVbml4VGltZXN0YW1wU2Vjb25kcywKICAgICJTIjogcGFyc2VTZWNvbmRzLAogICAgInUiOiBwYXJzZVdlZWtkYXlOdW1iZXJNb25kYXksCiAgICAiVSI6IHBhcnNlV2Vla051bWJlclN1bmRheSwKICAgICJWIjogcGFyc2VXZWVrTnVtYmVySVNPLAogICAgInciOiBwYXJzZVdlZWtkYXlOdW1iZXJTdW5kYXksCiAgICAiVyI6IHBhcnNlV2Vla051bWJlck1vbmRheSwKICAgICJ4IjogcGFyc2VMb2NhbGVEYXRlLAogICAgIlgiOiBwYXJzZUxvY2FsZVRpbWUsCiAgICAieSI6IHBhcnNlWWVhciwKICAgICJZIjogcGFyc2VGdWxsWWVhciwKICAgICJaIjogcGFyc2Vab25lLAogICAgIiUiOiBwYXJzZUxpdGVyYWxQZXJjZW50CiAgfTsKICBmb3JtYXRzLnggPSBuZXdGb3JtYXQobG9jYWxlX2RhdGUsIGZvcm1hdHMpOwogIGZvcm1hdHMuWCA9IG5ld0Zvcm1hdChsb2NhbGVfdGltZSwgZm9ybWF0cyk7CiAgZm9ybWF0cy5jID0gbmV3Rm9ybWF0KGxvY2FsZV9kYXRlVGltZSwgZm9ybWF0cyk7CiAgdXRjRm9ybWF0cy54ID0gbmV3Rm9ybWF0KGxvY2FsZV9kYXRlLCB1dGNGb3JtYXRzKTsKICB1dGNGb3JtYXRzLlggPSBuZXdGb3JtYXQobG9jYWxlX3RpbWUsIHV0Y0Zvcm1hdHMpOwogIHV0Y0Zvcm1hdHMuYyA9IG5ld0Zvcm1hdChsb2NhbGVfZGF0ZVRpbWUsIHV0Y0Zvcm1hdHMpOwogIGZ1bmN0aW9uIG5ld0Zvcm1hdChzcGVjaWZpZXIsIGZvcm1hdHMyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oZGF0ZTIpIHsKICAgICAgdmFyIHN0cmluZyA9IFtdLCBpID0gLTEsIGogPSAwLCBuID0gc3BlY2lmaWVyLmxlbmd0aCwgYywgcGFkMiwgZm9ybWF0MjsKICAgICAgaWYgKCEoZGF0ZTIgaW5zdGFuY2VvZiBEYXRlKSkgZGF0ZTIgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK2RhdGUyKTsKICAgICAgd2hpbGUgKCsraSA8IG4pIHsKICAgICAgICBpZiAoc3BlY2lmaWVyLmNoYXJDb2RlQXQoaSkgPT09IDM3KSB7CiAgICAgICAgICBzdHJpbmcucHVzaChzcGVjaWZpZXIuc2xpY2UoaiwgaSkpOwogICAgICAgICAgaWYgKChwYWQyID0gcGFkc1tjID0gc3BlY2lmaWVyLmNoYXJBdCgrK2kpXSkgIT0gbnVsbCkgYyA9IHNwZWNpZmllci5jaGFyQXQoKytpKTsKICAgICAgICAgIGVsc2UgcGFkMiA9IGMgPT09ICJlIiA/ICIgIiA6ICIwIjsKICAgICAgICAgIGlmIChmb3JtYXQyID0gZm9ybWF0czJbY10pIGMgPSBmb3JtYXQyKGRhdGUyLCBwYWQyKTsKICAgICAgICAgIHN0cmluZy5wdXNoKGMpOwogICAgICAgICAgaiA9IGkgKyAxOwogICAgICAgIH0KICAgICAgfQogICAgICBzdHJpbmcucHVzaChzcGVjaWZpZXIuc2xpY2UoaiwgaSkpOwogICAgICByZXR1cm4gc3RyaW5nLmpvaW4oIiIpOwogICAgfTsKICB9CiAgZnVuY3Rpb24gbmV3UGFyc2Uoc3BlY2lmaWVyLCBaKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIHZhciBkID0gbmV3RGF0ZSgxOTAwLCB2b2lkIDAsIDEpLCBpID0gcGFyc2VTcGVjaWZpZXIoZCwgc3BlY2lmaWVyLCBzdHJpbmcgKz0gIiIsIDApLCB3ZWVrLCBkYXk7CiAgICAgIGlmIChpICE9IHN0cmluZy5sZW5ndGgpIHJldHVybiBudWxsOwogICAgICBpZiAoIlEiIGluIGQpIHJldHVybiBuZXcgRGF0ZShkLlEpOwogICAgICBpZiAoInMiIGluIGQpIHJldHVybiBuZXcgRGF0ZShkLnMgKiAxZTMgKyAoIkwiIGluIGQgPyBkLkwgOiAwKSk7CiAgICAgIGlmIChaICYmICEoIloiIGluIGQpKSBkLlogPSAwOwogICAgICBpZiAoInAiIGluIGQpIGQuSCA9IGQuSCAlIDEyICsgZC5wICogMTI7CiAgICAgIGlmIChkLm0gPT09IHZvaWQgMCkgZC5tID0gInEiIGluIGQgPyBkLnEgOiAwOwogICAgICBpZiAoIlYiIGluIGQpIHsKICAgICAgICBpZiAoZC5WIDwgMSB8fCBkLlYgPiA1MykgcmV0dXJuIG51bGw7CiAgICAgICAgaWYgKCEoInciIGluIGQpKSBkLncgPSAxOwogICAgICAgIGlmICgiWiIgaW4gZCkgewogICAgICAgICAgd2VlayA9IHV0Y0RhdGUobmV3RGF0ZShkLnksIDAsIDEpKSwgZGF5ID0gd2Vlay5nZXRVVENEYXkoKTsKICAgICAgICAgIHdlZWsgPSBkYXkgPiA0IHx8IGRheSA9PT0gMCA/IHV0Y01vbmRheS5jZWlsKHdlZWspIDogdXRjTW9uZGF5KHdlZWspOwogICAgICAgICAgd2VlayA9IHV0Y0RheS5vZmZzZXQod2VlaywgKGQuViAtIDEpICogNyk7CiAgICAgICAgICBkLnkgPSB3ZWVrLmdldFVUQ0Z1bGxZZWFyKCk7CiAgICAgICAgICBkLm0gPSB3ZWVrLmdldFVUQ01vbnRoKCk7CiAgICAgICAgICBkLmQgPSB3ZWVrLmdldFVUQ0RhdGUoKSArIChkLncgKyA2KSAlIDc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdlZWsgPSBsb2NhbERhdGUobmV3RGF0ZShkLnksIDAsIDEpKSwgZGF5ID0gd2Vlay5nZXREYXkoKTsKICAgICAgICAgIHdlZWsgPSBkYXkgPiA0IHx8IGRheSA9PT0gMCA/IHRpbWVNb25kYXkuY2VpbCh3ZWVrKSA6IHRpbWVNb25kYXkod2Vlayk7CiAgICAgICAgICB3ZWVrID0gdGltZURheS5vZmZzZXQod2VlaywgKGQuViAtIDEpICogNyk7CiAgICAgICAgICBkLnkgPSB3ZWVrLmdldEZ1bGxZZWFyKCk7CiAgICAgICAgICBkLm0gPSB3ZWVrLmdldE1vbnRoKCk7CiAgICAgICAgICBkLmQgPSB3ZWVrLmdldERhdGUoKSArIChkLncgKyA2KSAlIDc7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKCJXIiBpbiBkIHx8ICJVIiBpbiBkKSB7CiAgICAgICAgaWYgKCEoInciIGluIGQpKSBkLncgPSAidSIgaW4gZCA/IGQudSAlIDcgOiAiVyIgaW4gZCA/IDEgOiAwOwogICAgICAgIGRheSA9ICJaIiBpbiBkID8gdXRjRGF0ZShuZXdEYXRlKGQueSwgMCwgMSkpLmdldFVUQ0RheSgpIDogbG9jYWxEYXRlKG5ld0RhdGUoZC55LCAwLCAxKSkuZ2V0RGF5KCk7CiAgICAgICAgZC5tID0gMDsKICAgICAgICBkLmQgPSAiVyIgaW4gZCA/IChkLncgKyA2KSAlIDcgKyBkLlcgKiA3IC0gKGRheSArIDUpICUgNyA6IGQudyArIGQuVSAqIDcgLSAoZGF5ICsgNikgJSA3OwogICAgICB9CiAgICAgIGlmICgiWiIgaW4gZCkgewogICAgICAgIGQuSCArPSBkLlogLyAxMDAgfCAwOwogICAgICAgIGQuTSArPSBkLlogJSAxMDA7CiAgICAgICAgcmV0dXJuIHV0Y0RhdGUoZCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxvY2FsRGF0ZShkKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIHBhcnNlU3BlY2lmaWVyKGQsIHNwZWNpZmllciwgc3RyaW5nLCBqKSB7CiAgICB2YXIgaSA9IDAsIG4gPSBzcGVjaWZpZXIubGVuZ3RoLCBtID0gc3RyaW5nLmxlbmd0aCwgYywgcGFyc2U7CiAgICB3aGlsZSAoaSA8IG4pIHsKICAgICAgaWYgKGogPj0gbSkgcmV0dXJuIC0xOwogICAgICBjID0gc3BlY2lmaWVyLmNoYXJDb2RlQXQoaSsrKTsKICAgICAgaWYgKGMgPT09IDM3KSB7CiAgICAgICAgYyA9IHNwZWNpZmllci5jaGFyQXQoaSsrKTsKICAgICAgICBwYXJzZSA9IHBhcnNlc1tjIGluIHBhZHMgPyBzcGVjaWZpZXIuY2hhckF0KGkrKykgOiBjXTsKICAgICAgICBpZiAoIXBhcnNlIHx8IChqID0gcGFyc2UoZCwgc3RyaW5nLCBqKSkgPCAwKSByZXR1cm4gLTE7CiAgICAgIH0gZWxzZSBpZiAoYyAhPSBzdHJpbmcuY2hhckNvZGVBdChqKyspKSB7CiAgICAgICAgcmV0dXJuIC0xOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gajsKICB9CiAgZnVuY3Rpb24gcGFyc2VQZXJpb2QoZCwgc3RyaW5nLCBpKSB7CiAgICB2YXIgbiA9IHBlcmlvZFJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICAgIHJldHVybiBuID8gKGQucCA9IHBlcmlvZExvb2t1cC5nZXQoblswXS50b0xvd2VyQ2FzZSgpKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwogIH0KICBmdW5jdGlvbiBwYXJzZVNob3J0V2Vla2RheShkLCBzdHJpbmcsIGkpIHsKICAgIHZhciBuID0gc2hvcnRXZWVrZGF5UmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogICAgcmV0dXJuIG4gPyAoZC53ID0gc2hvcnRXZWVrZGF5TG9va3VwLmdldChuWzBdLnRvTG93ZXJDYXNlKCkpLCBpICsgblswXS5sZW5ndGgpIDogLTE7CiAgfQogIGZ1bmN0aW9uIHBhcnNlV2Vla2RheShkLCBzdHJpbmcsIGkpIHsKICAgIHZhciBuID0gd2Vla2RheVJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICAgIHJldHVybiBuID8gKGQudyA9IHdlZWtkYXlMb29rdXAuZ2V0KG5bMF0udG9Mb3dlckNhc2UoKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKICB9CiAgZnVuY3Rpb24gcGFyc2VTaG9ydE1vbnRoKGQsIHN0cmluZywgaSkgewogICAgdmFyIG4gPSBzaG9ydE1vbnRoUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogICAgcmV0dXJuIG4gPyAoZC5tID0gc2hvcnRNb250aExvb2t1cC5nZXQoblswXS50b0xvd2VyQ2FzZSgpKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwogIH0KICBmdW5jdGlvbiBwYXJzZU1vbnRoKGQsIHN0cmluZywgaSkgewogICAgdmFyIG4gPSBtb250aFJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICAgIHJldHVybiBuID8gKGQubSA9IG1vbnRoTG9va3VwLmdldChuWzBdLnRvTG93ZXJDYXNlKCkpLCBpICsgblswXS5sZW5ndGgpIDogLTE7CiAgfQogIGZ1bmN0aW9uIHBhcnNlTG9jYWxlRGF0ZVRpbWUoZCwgc3RyaW5nLCBpKSB7CiAgICByZXR1cm4gcGFyc2VTcGVjaWZpZXIoZCwgbG9jYWxlX2RhdGVUaW1lLCBzdHJpbmcsIGkpOwogIH0KICBmdW5jdGlvbiBwYXJzZUxvY2FsZURhdGUoZCwgc3RyaW5nLCBpKSB7CiAgICByZXR1cm4gcGFyc2VTcGVjaWZpZXIoZCwgbG9jYWxlX2RhdGUsIHN0cmluZywgaSk7CiAgfQogIGZ1bmN0aW9uIHBhcnNlTG9jYWxlVGltZShkLCBzdHJpbmcsIGkpIHsKICAgIHJldHVybiBwYXJzZVNwZWNpZmllcihkLCBsb2NhbGVfdGltZSwgc3RyaW5nLCBpKTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0U2hvcnRXZWVrZGF5KGQpIHsKICAgIHJldHVybiBsb2NhbGVfc2hvcnRXZWVrZGF5c1tkLmdldERheSgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0V2Vla2RheShkKSB7CiAgICByZXR1cm4gbG9jYWxlX3dlZWtkYXlzW2QuZ2V0RGF5KCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRTaG9ydE1vbnRoKGQpIHsKICAgIHJldHVybiBsb2NhbGVfc2hvcnRNb250aHNbZC5nZXRNb250aCgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0TW9udGgoZCkgewogICAgcmV0dXJuIGxvY2FsZV9tb250aHNbZC5nZXRNb250aCgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0UGVyaW9kKGQpIHsKICAgIHJldHVybiBsb2NhbGVfcGVyaW9kc1srKGQuZ2V0SG91cnMoKSA+PSAxMildOwogIH0KICBmdW5jdGlvbiBmb3JtYXRRdWFydGVyKGQpIHsKICAgIHJldHVybiAxICsgfn4oZC5nZXRNb250aCgpIC8gMyk7CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1Nob3J0V2Vla2RheShkKSB7CiAgICByZXR1cm4gbG9jYWxlX3Nob3J0V2Vla2RheXNbZC5nZXRVVENEYXkoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1dlZWtkYXkoZCkgewogICAgcmV0dXJuIGxvY2FsZV93ZWVrZGF5c1tkLmdldFVUQ0RheSgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDU2hvcnRNb250aChkKSB7CiAgICByZXR1cm4gbG9jYWxlX3Nob3J0TW9udGhzW2QuZ2V0VVRDTW9udGgoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ01vbnRoKGQpIHsKICAgIHJldHVybiBsb2NhbGVfbW9udGhzW2QuZ2V0VVRDTW9udGgoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1BlcmlvZChkKSB7CiAgICByZXR1cm4gbG9jYWxlX3BlcmlvZHNbKyhkLmdldFVUQ0hvdXJzKCkgPj0gMTIpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0VVRDUXVhcnRlcihkKSB7CiAgICByZXR1cm4gMSArIH5+KGQuZ2V0VVRDTW9udGgoKSAvIDMpOwogIH0KICByZXR1cm4gewogICAgZm9ybWF0OiBmdW5jdGlvbihzcGVjaWZpZXIpIHsKICAgICAgdmFyIGYgPSBuZXdGb3JtYXQoc3BlY2lmaWVyICs9ICIiLCBmb3JtYXRzKTsKICAgICAgZi50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzcGVjaWZpZXI7CiAgICAgIH07CiAgICAgIHJldHVybiBmOwogICAgfSwKICAgIHBhcnNlOiBmdW5jdGlvbihzcGVjaWZpZXIpIHsKICAgICAgdmFyIHAgPSBuZXdQYXJzZShzcGVjaWZpZXIgKz0gIiIsIGZhbHNlKTsKICAgICAgcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzcGVjaWZpZXI7CiAgICAgIH07CiAgICAgIHJldHVybiBwOwogICAgfSwKICAgIHV0Y0Zvcm1hdDogZnVuY3Rpb24oc3BlY2lmaWVyKSB7CiAgICAgIHZhciBmID0gbmV3Rm9ybWF0KHNwZWNpZmllciArPSAiIiwgdXRjRm9ybWF0cyk7CiAgICAgIGYudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc3BlY2lmaWVyOwogICAgICB9OwogICAgICByZXR1cm4gZjsKICAgIH0sCiAgICB1dGNQYXJzZTogZnVuY3Rpb24oc3BlY2lmaWVyKSB7CiAgICAgIHZhciBwID0gbmV3UGFyc2Uoc3BlY2lmaWVyICs9ICIiLCB0cnVlKTsKICAgICAgcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBzcGVjaWZpZXI7CiAgICAgIH07CiAgICAgIHJldHVybiBwOwogICAgfQogIH07Cn0KdmFyIHBhZHMgPSB7ICItIjogIiIsICJfIjogIiAiLCAiMCI6ICIwIiB9Owp2YXIgbnVtYmVyUmUgPSAvXlxzKlxkKy87CnZhciBwZXJjZW50UmUgPSAvXiUvOwp2YXIgcmVxdW90ZVJlID0gL1tcXF4kKis/fFtcXSgpLnt9XS9nOwpmdW5jdGlvbiBwYWQodmFsdWUsIGZpbGwsIHdpZHRoKSB7CiAgdmFyIHNpZ24yID0gdmFsdWUgPCAwID8gIi0iIDogIiIsIHN0cmluZyA9IChzaWduMiA/IC12YWx1ZSA6IHZhbHVlKSArICIiLCBsZW5ndGggPSBzdHJpbmcubGVuZ3RoOwogIHJldHVybiBzaWduMiArIChsZW5ndGggPCB3aWR0aCA/IG5ldyBBcnJheSh3aWR0aCAtIGxlbmd0aCArIDEpLmpvaW4oZmlsbCkgKyBzdHJpbmcgOiBzdHJpbmcpOwp9CmZ1bmN0aW9uIHJlcXVvdGUocykgewogIHJldHVybiBzLnJlcGxhY2UocmVxdW90ZVJlLCAiXFwkJiIpOwp9CmZ1bmN0aW9uIGZvcm1hdFJlKG5hbWVzKSB7CiAgcmV0dXJuIG5ldyBSZWdFeHAoIl4oPzoiICsgbmFtZXMubWFwKHJlcXVvdGUpLmpvaW4oInwiKSArICIpIiwgImkiKTsKfQpmdW5jdGlvbiBmb3JtYXRMb29rdXAobmFtZXMpIHsKICByZXR1cm4gbmV3IE1hcChuYW1lcy5tYXAoKG5hbWUsIGkpID0+IFtuYW1lLnRvTG93ZXJDYXNlKCksIGldKSk7Cn0KZnVuY3Rpb24gcGFyc2VXZWVrZGF5TnVtYmVyU3VuZGF5KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDEpKTsKICByZXR1cm4gbiA/IChkLncgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlV2Vla2RheU51bWJlck1vbmRheShkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAxKSk7CiAgcmV0dXJuIG4gPyAoZC51ID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVdlZWtOdW1iZXJTdW5kYXkoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuVSA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VXZWVrTnVtYmVySVNPKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLlYgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlV2Vla051bWJlck1vbmRheShkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5XID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZUZ1bGxZZWFyKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDQpKTsKICByZXR1cm4gbiA/IChkLnkgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlWWVhcihkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC55ID0gK25bMF0gKyAoK25bMF0gPiA2OCA/IDE5MDAgOiAyZTMpLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2Vab25lKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gL14oWil8KFsrLV1cZFxkKSg/Ojo/KFxkXGQpKT8vLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyA2KSk7CiAgcmV0dXJuIG4gPyAoZC5aID0gblsxXSA/IDAgOiAtKG5bMl0gKyAoblszXSB8fCAiMDAiKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVF1YXJ0ZXIoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMSkpOwogIHJldHVybiBuID8gKGQucSA9IG5bMF0gKiAzIC0gMywgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlTW9udGhOdW1iZXIoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQubSA9IG5bMF0gLSAxLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VEYXlPZk1vbnRoKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLmQgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlRGF5T2ZZZWFyKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDMpKTsKICByZXR1cm4gbiA/IChkLm0gPSAwLCBkLmQgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlSG91cjI0KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLkggPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlTWludXRlcyhkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5NID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVNlY29uZHMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuUyA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VNaWxsaXNlY29uZHMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMykpOwogIHJldHVybiBuID8gKGQuTCA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VNaWNyb3NlY29uZHMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgNikpOwogIHJldHVybiBuID8gKGQuTCA9IE1hdGguZmxvb3IoblswXSAvIDFlMyksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZUxpdGVyYWxQZXJjZW50KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gcGVyY2VudFJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAxKSk7CiAgcmV0dXJuIG4gPyBpICsgblswXS5sZW5ndGggOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVVuaXhUaW1lc3RhbXAoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgcmV0dXJuIG4gPyAoZC5RID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVVuaXhUaW1lc3RhbXBTZWNvbmRzKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogIHJldHVybiBuID8gKGQucyA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gZm9ybWF0RGF5T2ZNb250aChkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldERhdGUoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0SG91cjI0KGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0SG91cnMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0SG91cjEyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0SG91cnMoKSAlIDEyIHx8IDEyLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXREYXlPZlllYXIoZCwgcCkgewogIHJldHVybiBwYWQoMSArIHRpbWVEYXkuY291bnQodGltZVllYXIoZCksIGQpLCBwLCAzKTsKfQpmdW5jdGlvbiBmb3JtYXRNaWxsaXNlY29uZHMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRNaWxsaXNlY29uZHMoKSwgcCwgMyk7Cn0KZnVuY3Rpb24gZm9ybWF0TWljcm9zZWNvbmRzKGQsIHApIHsKICByZXR1cm4gZm9ybWF0TWlsbGlzZWNvbmRzKGQsIHApICsgIjAwMCI7Cn0KZnVuY3Rpb24gZm9ybWF0TW9udGhOdW1iZXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRNb250aCgpICsgMSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0TWludXRlcyhkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldE1pbnV0ZXMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0U2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFNlY29uZHMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla2RheU51bWJlck1vbmRheShkKSB7CiAgdmFyIGRheSA9IGQuZ2V0RGF5KCk7CiAgcmV0dXJuIGRheSA9PT0gMCA/IDcgOiBkYXk7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla051bWJlclN1bmRheShkLCBwKSB7CiAgcmV0dXJuIHBhZCh0aW1lU3VuZGF5LmNvdW50KHRpbWVZZWFyKGQpIC0gMSwgZCksIHAsIDIpOwp9CmZ1bmN0aW9uIGRJU08oZCkgewogIHZhciBkYXkgPSBkLmdldERheSgpOwogIHJldHVybiBkYXkgPj0gNCB8fCBkYXkgPT09IDAgPyB0aW1lVGh1cnNkYXkoZCkgOiB0aW1lVGh1cnNkYXkuY2VpbChkKTsKfQpmdW5jdGlvbiBmb3JtYXRXZWVrTnVtYmVySVNPKGQsIHApIHsKICBkID0gZElTTyhkKTsKICByZXR1cm4gcGFkKHRpbWVUaHVyc2RheS5jb3VudCh0aW1lWWVhcihkKSwgZCkgKyAodGltZVllYXIoZCkuZ2V0RGF5KCkgPT09IDQpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRXZWVrZGF5TnVtYmVyU3VuZGF5KGQpIHsKICByZXR1cm4gZC5nZXREYXkoKTsKfQpmdW5jdGlvbiBmb3JtYXRXZWVrTnVtYmVyTW9uZGF5KGQsIHApIHsKICByZXR1cm4gcGFkKHRpbWVNb25kYXkuY291bnQodGltZVllYXIoZCkgLSAxLCBkKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0WWVhcihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldEZ1bGxZZWFyKCkgJSAxMDAsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFllYXJJU08oZCwgcCkgewogIGQgPSBkSVNPKGQpOwogIHJldHVybiBwYWQoZC5nZXRGdWxsWWVhcigpICUgMTAwLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRGdWxsWWVhcihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldEZ1bGxZZWFyKCkgJSAxZTQsIHAsIDQpOwp9CmZ1bmN0aW9uIGZvcm1hdEZ1bGxZZWFySVNPKGQsIHApIHsKICB2YXIgZGF5ID0gZC5nZXREYXkoKTsKICBkID0gZGF5ID49IDQgfHwgZGF5ID09PSAwID8gdGltZVRodXJzZGF5KGQpIDogdGltZVRodXJzZGF5LmNlaWwoZCk7CiAgcmV0dXJuIHBhZChkLmdldEZ1bGxZZWFyKCkgJSAxZTQsIHAsIDQpOwp9CmZ1bmN0aW9uIGZvcm1hdFpvbmUoZCkgewogIHZhciB6ID0gZC5nZXRUaW1lem9uZU9mZnNldCgpOwogIHJldHVybiAoeiA+IDAgPyAiLSIgOiAoeiAqPSAtMSwgIisiKSkgKyBwYWQoeiAvIDYwIHwgMCwgIjAiLCAyKSArIHBhZCh6ICUgNjAsICIwIiwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDRGF5T2ZNb250aChkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0RhdGUoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDSG91cjI0KGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDSG91cnMoKSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDSG91cjEyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDSG91cnMoKSAlIDEyIHx8IDEyLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENEYXlPZlllYXIoZCwgcCkgewogIHJldHVybiBwYWQoMSArIHV0Y0RheS5jb3VudCh1dGNZZWFyKGQpLCBkKSwgcCwgMyk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDTWlsbGlzZWNvbmRzKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDTWlsbGlzZWNvbmRzKCksIHAsIDMpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ01pY3Jvc2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIGZvcm1hdFVUQ01pbGxpc2Vjb25kcyhkLCBwKSArICIwMDAiOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ01vbnRoTnVtYmVyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDTW9udGgoKSArIDEsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ01pbnV0ZXMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENNaW51dGVzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1NlY29uZHMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENTZWNvbmRzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1dlZWtkYXlOdW1iZXJNb25kYXkoZCkgewogIHZhciBkb3cgPSBkLmdldFVUQ0RheSgpOwogIHJldHVybiBkb3cgPT09IDAgPyA3IDogZG93Owp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1dlZWtOdW1iZXJTdW5kYXkoZCwgcCkgewogIHJldHVybiBwYWQodXRjU3VuZGF5LmNvdW50KHV0Y1llYXIoZCkgLSAxLCBkKSwgcCwgMik7Cn0KZnVuY3Rpb24gVVRDZElTTyhkKSB7CiAgdmFyIGRheSA9IGQuZ2V0VVRDRGF5KCk7CiAgcmV0dXJuIGRheSA+PSA0IHx8IGRheSA9PT0gMCA/IHV0Y1RodXJzZGF5KGQpIDogdXRjVGh1cnNkYXkuY2VpbChkKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrTnVtYmVySVNPKGQsIHApIHsKICBkID0gVVRDZElTTyhkKTsKICByZXR1cm4gcGFkKHV0Y1RodXJzZGF5LmNvdW50KHV0Y1llYXIoZCksIGQpICsgKHV0Y1llYXIoZCkuZ2V0VVRDRGF5KCkgPT09IDQpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrZGF5TnVtYmVyU3VuZGF5KGQpIHsKICByZXR1cm4gZC5nZXRVVENEYXkoKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrTnVtYmVyTW9uZGF5KGQsIHApIHsKICByZXR1cm4gcGFkKHV0Y01vbmRheS5jb3VudCh1dGNZZWFyKGQpIC0gMSwgZCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1llYXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENGdWxsWWVhcigpICUgMTAwLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENZZWFySVNPKGQsIHApIHsKICBkID0gVVRDZElTTyhkKTsKICByZXR1cm4gcGFkKGQuZ2V0VVRDRnVsbFllYXIoKSAlIDEwMCwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDRnVsbFllYXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENGdWxsWWVhcigpICUgMWU0LCBwLCA0KTsKfQpmdW5jdGlvbiBmb3JtYXRVVENGdWxsWWVhcklTTyhkLCBwKSB7CiAgdmFyIGRheSA9IGQuZ2V0VVRDRGF5KCk7CiAgZCA9IGRheSA+PSA0IHx8IGRheSA9PT0gMCA/IHV0Y1RodXJzZGF5KGQpIDogdXRjVGh1cnNkYXkuY2VpbChkKTsKICByZXR1cm4gcGFkKGQuZ2V0VVRDRnVsbFllYXIoKSAlIDFlNCwgcCwgNCk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDWm9uZSgpIHsKICByZXR1cm4gIiswMDAwIjsKfQpmdW5jdGlvbiBmb3JtYXRMaXRlcmFsUGVyY2VudCgpIHsKICByZXR1cm4gIiUiOwp9CmZ1bmN0aW9uIGZvcm1hdFVuaXhUaW1lc3RhbXAoZCkgewogIHJldHVybiArZDsKfQpmdW5jdGlvbiBmb3JtYXRVbml4VGltZXN0YW1wU2Vjb25kcyhkKSB7CiAgcmV0dXJuIE1hdGguZmxvb3IoK2QgLyAxZTMpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZS1mb3JtYXRANC4xLjAvbm9kZV9tb2R1bGVzL2QzLXRpbWUtZm9ybWF0L3NyYy9kZWZhdWx0TG9jYWxlLmpzCnZhciBsb2NhbGUyOwp2YXIgdGltZUZvcm1hdDsKdmFyIHRpbWVQYXJzZTsKdmFyIHV0Y0Zvcm1hdDsKdmFyIHV0Y1BhcnNlOwpkZWZhdWx0TG9jYWxlMih7CiAgZGF0ZVRpbWU6ICIleCwgJVgiLAogIGRhdGU6ICIlLW0vJS1kLyVZIiwKICB0aW1lOiAiJS1JOiVNOiVTICVwIiwKICBwZXJpb2RzOiBbIkFNIiwgIlBNIl0sCiAgZGF5czogWyJTdW5kYXkiLCAiTW9uZGF5IiwgIlR1ZXNkYXkiLCAiV2VkbmVzZGF5IiwgIlRodXJzZGF5IiwgIkZyaWRheSIsICJTYXR1cmRheSJdLAogIHNob3J0RGF5czogWyJTdW4iLCAiTW9uIiwgIlR1ZSIsICJXZWQiLCAiVGh1IiwgIkZyaSIsICJTYXQiXSwKICBtb250aHM6IFsiSmFudWFyeSIsICJGZWJydWFyeSIsICJNYXJjaCIsICJBcHJpbCIsICJNYXkiLCAiSnVuZSIsICJKdWx5IiwgIkF1Z3VzdCIsICJTZXB0ZW1iZXIiLCAiT2N0b2JlciIsICJOb3ZlbWJlciIsICJEZWNlbWJlciJdLAogIHNob3J0TW9udGhzOiBbIkphbiIsICJGZWIiLCAiTWFyIiwgIkFwciIsICJNYXkiLCAiSnVuIiwgIkp1bCIsICJBdWciLCAiU2VwIiwgIk9jdCIsICJOb3YiLCAiRGVjIl0KfSk7CmZ1bmN0aW9uIGRlZmF1bHRMb2NhbGUyKGRlZmluaXRpb24pIHsKICBsb2NhbGUyID0gZm9ybWF0TG9jYWxlKGRlZmluaXRpb24pOwogIHRpbWVGb3JtYXQgPSBsb2NhbGUyLmZvcm1hdDsKICB0aW1lUGFyc2UgPSBsb2NhbGUyLnBhcnNlOwogIHV0Y0Zvcm1hdCA9IGxvY2FsZTIudXRjRm9ybWF0OwogIHV0Y1BhcnNlID0gbG9jYWxlMi51dGNQYXJzZTsKICByZXR1cm4gbG9jYWxlMjsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvdGltZS5qcwpmdW5jdGlvbiBkYXRlKHQpIHsKICByZXR1cm4gbmV3IERhdGUodCk7Cn0KZnVuY3Rpb24gbnVtYmVyMyh0KSB7CiAgcmV0dXJuIHQgaW5zdGFuY2VvZiBEYXRlID8gK3QgOiArLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCt0KTsKfQpmdW5jdGlvbiBjYWxlbmRhcih0aWNrczIsIHRpY2tJbnRlcnZhbCwgeWVhciwgbW9udGgsIHdlZWssIGRheSwgaG91ciwgbWludXRlLCBzZWNvbmQyLCBmb3JtYXQyKSB7CiAgdmFyIHNjYWxlID0gY29udGludW91cygpLCBpbnZlcnQgPSBzY2FsZS5pbnZlcnQsIGRvbWFpbiA9IHNjYWxlLmRvbWFpbjsKICB2YXIgZm9ybWF0TWlsbGlzZWNvbmQgPSBmb3JtYXQyKCIuJUwiKSwgZm9ybWF0U2Vjb25kID0gZm9ybWF0MigiOiVTIiksIGZvcm1hdE1pbnV0ZSA9IGZvcm1hdDIoIiVJOiVNIiksIGZvcm1hdEhvdXIgPSBmb3JtYXQyKCIlSSAlcCIpLCBmb3JtYXREYXkgPSBmb3JtYXQyKCIlYSAlZCIpLCBmb3JtYXRXZWVrID0gZm9ybWF0MigiJWIgJWQiKSwgZm9ybWF0TW9udGggPSBmb3JtYXQyKCIlQiIpLCBmb3JtYXRZZWFyMiA9IGZvcm1hdDIoIiVZIik7CiAgZnVuY3Rpb24gdGlja0Zvcm1hdDIoZGF0ZTIpIHsKICAgIHJldHVybiAoc2Vjb25kMihkYXRlMikgPCBkYXRlMiA/IGZvcm1hdE1pbGxpc2Vjb25kIDogbWludXRlKGRhdGUyKSA8IGRhdGUyID8gZm9ybWF0U2Vjb25kIDogaG91cihkYXRlMikgPCBkYXRlMiA/IGZvcm1hdE1pbnV0ZSA6IGRheShkYXRlMikgPCBkYXRlMiA/IGZvcm1hdEhvdXIgOiBtb250aChkYXRlMikgPCBkYXRlMiA/IHdlZWsoZGF0ZTIpIDwgZGF0ZTIgPyBmb3JtYXREYXkgOiBmb3JtYXRXZWVrIDogeWVhcihkYXRlMikgPCBkYXRlMiA/IGZvcm1hdE1vbnRoIDogZm9ybWF0WWVhcjIpKGRhdGUyKTsKICB9CiAgc2NhbGUuaW52ZXJ0ID0gZnVuY3Rpb24oeTIpIHsKICAgIHJldHVybiBuZXcgRGF0ZShpbnZlcnQoeTIpKTsKICB9OwogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gZG9tYWluKEFycmF5LmZyb20oXywgbnVtYmVyMykpIDogZG9tYWluKCkubWFwKGRhdGUpOwogIH07CiAgc2NhbGUudGlja3MgPSBmdW5jdGlvbihpbnRlcnZhbCkgewogICAgdmFyIGQgPSBkb21haW4oKTsKICAgIHJldHVybiB0aWNrczIoZFswXSwgZFtkLmxlbmd0aCAtIDFdLCBpbnRlcnZhbCA9PSBudWxsID8gMTAgOiBpbnRlcnZhbCk7CiAgfTsKICBzY2FsZS50aWNrRm9ybWF0ID0gZnVuY3Rpb24oY291bnQsIHNwZWNpZmllcikgewogICAgcmV0dXJuIHNwZWNpZmllciA9PSBudWxsID8gdGlja0Zvcm1hdDIgOiBmb3JtYXQyKHNwZWNpZmllcik7CiAgfTsKICBzY2FsZS5uaWNlID0gZnVuY3Rpb24oaW50ZXJ2YWwpIHsKICAgIHZhciBkID0gZG9tYWluKCk7CiAgICBpZiAoIWludGVydmFsIHx8IHR5cGVvZiBpbnRlcnZhbC5yYW5nZSAhPT0gImZ1bmN0aW9uIikgaW50ZXJ2YWwgPSB0aWNrSW50ZXJ2YWwoZFswXSwgZFtkLmxlbmd0aCAtIDFdLCBpbnRlcnZhbCA9PSBudWxsID8gMTAgOiBpbnRlcnZhbCk7CiAgICByZXR1cm4gaW50ZXJ2YWwgPyBkb21haW4obmljZShkLCBpbnRlcnZhbCkpIDogc2NhbGU7CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weShzY2FsZSwgY2FsZW5kYXIodGlja3MyLCB0aWNrSW50ZXJ2YWwsIHllYXIsIG1vbnRoLCB3ZWVrLCBkYXksIGhvdXIsIG1pbnV0ZSwgc2Vjb25kMiwgZm9ybWF0MikpOwogIH07CiAgcmV0dXJuIHNjYWxlOwp9CmZ1bmN0aW9uIHRpbWUoKSB7CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShjYWxlbmRhcih0aW1lVGlja3MsIHRpbWVUaWNrSW50ZXJ2YWwsIHRpbWVZZWFyLCB0aW1lTW9udGgsIHRpbWVTdW5kYXksIHRpbWVEYXksIHRpbWVIb3VyLCB0aW1lTWludXRlLCBzZWNvbmQsIHRpbWVGb3JtYXQpLmRvbWFpbihbbmV3IERhdGUoMmUzLCAwLCAxKSwgbmV3IERhdGUoMmUzLCAwLCAyKV0pLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy91dGNUaW1lLmpzCmZ1bmN0aW9uIHV0Y1RpbWUoKSB7CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShjYWxlbmRhcih1dGNUaWNrcywgdXRjVGlja0ludGVydmFsLCB1dGNZZWFyLCB1dGNNb250aCwgdXRjU3VuZGF5LCB1dGNEYXksIHV0Y0hvdXIsIHV0Y01pbnV0ZSwgc2Vjb25kLCB1dGNGb3JtYXQpLmRvbWFpbihbRGF0ZS5VVEMoMmUzLCAwLCAxKSwgRGF0ZS5VVEMoMmUzLCAwLCAyKV0pLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9zZXF1ZW50aWFsLmpzCmZ1bmN0aW9uIHRyYW5zZm9ybWVyMigpIHsKICB2YXIgeDAgPSAwLCB4MSA9IDEsIHQwMiwgdDEyLCBrMTAsIHRyYW5zZm9ybSwgaW50ZXJwb2xhdG9yID0gaWRlbnRpdHksIGNsYW1wID0gZmFsc2UsIHVua25vd247CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiA9PSBudWxsIHx8IGlzTmFOKHgyID0gK3gyKSA/IHVua25vd24gOiBpbnRlcnBvbGF0b3IoazEwID09PSAwID8gMC41IDogKHgyID0gKHRyYW5zZm9ybSh4MikgLSB0MDIpICogazEwLCBjbGFtcCA/IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHgyKSkgOiB4MikpOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbeDAsIHgxXSA9IF8sIHQwMiA9IHRyYW5zZm9ybSh4MCA9ICt4MCksIHQxMiA9IHRyYW5zZm9ybSh4MSA9ICt4MSksIGsxMCA9IHQwMiA9PT0gdDEyID8gMCA6IDEgLyAodDEyIC0gdDAyKSwgc2NhbGUpIDogW3gwLCB4MV07CiAgfTsKICBzY2FsZS5jbGFtcCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGNsYW1wID0gISFfLCBzY2FsZSkgOiBjbGFtcDsKICB9OwogIHNjYWxlLmludGVycG9sYXRvciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGludGVycG9sYXRvciA9IF8sIHNjYWxlKSA6IGludGVycG9sYXRvcjsKICB9OwogIGZ1bmN0aW9uIHJhbmdlNChpbnRlcnBvbGF0ZTIpIHsKICAgIHJldHVybiBmdW5jdGlvbihfKSB7CiAgICAgIHZhciByMCwgcjE7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKFtyMCwgcjFdID0gXywgaW50ZXJwb2xhdG9yID0gaW50ZXJwb2xhdGUyKHIwLCByMSksIHNjYWxlKSA6IFtpbnRlcnBvbGF0b3IoMCksIGludGVycG9sYXRvcigxKV07CiAgICB9OwogIH0KICBzY2FsZS5yYW5nZSA9IHJhbmdlNCh2YWx1ZV9kZWZhdWx0KTsKICBzY2FsZS5yYW5nZVJvdW5kID0gcmFuZ2U0KHJvdW5kX2RlZmF1bHQpOwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICB0cmFuc2Zvcm0gPSB0LCB0MDIgPSB0KHgwKSwgdDEyID0gdCh4MSksIGsxMCA9IHQwMiA9PT0gdDEyID8gMCA6IDEgLyAodDEyIC0gdDAyKTsKICAgIHJldHVybiBzY2FsZTsKICB9Owp9CmZ1bmN0aW9uIGNvcHkyKHNvdXJjZSwgdGFyZ2V0KSB7CiAgcmV0dXJuIHRhcmdldC5kb21haW4oc291cmNlLmRvbWFpbigpKS5pbnRlcnBvbGF0b3Ioc291cmNlLmludGVycG9sYXRvcigpKS5jbGFtcChzb3VyY2UuY2xhbXAoKSkudW5rbm93bihzb3VyY2UudW5rbm93bigpKTsKfQpmdW5jdGlvbiBzZXF1ZW50aWFsKCkgewogIHZhciBzY2FsZSA9IGxpbmVhcmlzaCh0cmFuc2Zvcm1lcjIoKShpZGVudGl0eSkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgc2VxdWVudGlhbCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIHNlcXVlbnRpYWxMb2coKSB7CiAgdmFyIHNjYWxlID0gbG9nZ2lzaCh0cmFuc2Zvcm1lcjIoKSkuZG9tYWluKFsxLCAxMF0pOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgc2VxdWVudGlhbExvZygpKS5iYXNlKHNjYWxlLmJhc2UoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBzZXF1ZW50aWFsU3ltbG9nKCkgewogIHZhciBzY2FsZSA9IHN5bWxvZ2lzaCh0cmFuc2Zvcm1lcjIoKSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkyKHNjYWxlLCBzZXF1ZW50aWFsU3ltbG9nKCkpLmNvbnN0YW50KHNjYWxlLmNvbnN0YW50KCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gc2VxdWVudGlhbFBvdygpIHsKICB2YXIgc2NhbGUgPSBwb3dpc2godHJhbnNmb3JtZXIyKCkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgc2VxdWVudGlhbFBvdygpKS5leHBvbmVudChzY2FsZS5leHBvbmVudCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIHNlcXVlbnRpYWxTcXJ0KCkgewogIHJldHVybiBzZXF1ZW50aWFsUG93LmFwcGx5KG51bGwsIGFyZ3VtZW50cykuZXhwb25lbnQoMC41KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvc2VxdWVudGlhbFF1YW50aWxlLmpzCmZ1bmN0aW9uIHNlcXVlbnRpYWxRdWFudGlsZSgpIHsKICB2YXIgZG9tYWluID0gW10sIGludGVycG9sYXRvciA9IGlkZW50aXR5OwogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICBpZiAoeDIgIT0gbnVsbCAmJiAhaXNOYU4oeDIgPSAreDIpKSByZXR1cm4gaW50ZXJwb2xhdG9yKChiaXNlY3RfZGVmYXVsdChkb21haW4sIHgyLCAxKSAtIDEpIC8gKGRvbWFpbi5sZW5ndGggLSAxKSk7CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIGRvbWFpbi5zbGljZSgpOwogICAgZG9tYWluID0gW107CiAgICBmb3IgKGxldCBkIG9mIF8pIGlmIChkICE9IG51bGwgJiYgIWlzTmFOKGQgPSArZCkpIGRvbWFpbi5wdXNoKGQpOwogICAgZG9tYWluLnNvcnQoYXNjZW5kaW5nKTsKICAgIHJldHVybiBzY2FsZTsKICB9OwogIHNjYWxlLmludGVycG9sYXRvciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGludGVycG9sYXRvciA9IF8sIHNjYWxlKSA6IGludGVycG9sYXRvcjsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZG9tYWluLm1hcCgoZCwgaSkgPT4gaW50ZXJwb2xhdG9yKGkgLyAoZG9tYWluLmxlbmd0aCAtIDEpKSk7CiAgfTsKICBzY2FsZS5xdWFudGlsZXMgPSBmdW5jdGlvbihuKSB7CiAgICByZXR1cm4gQXJyYXkuZnJvbSh7IGxlbmd0aDogbiArIDEgfSwgKF8sIGkpID0+IHF1YW50aWxlKGRvbWFpbiwgaSAvIG4pKTsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBzZXF1ZW50aWFsUXVhbnRpbGUoaW50ZXJwb2xhdG9yKS5kb21haW4oZG9tYWluKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9kaXZlcmdpbmcuanMKZnVuY3Rpb24gdHJhbnNmb3JtZXIzKCkgewogIHZhciB4MCA9IDAsIHgxID0gMC41LCB4MiA9IDEsIHMgPSAxLCB0MDIsIHQxMiwgdDIsIGsxMCwgazIxLCBpbnRlcnBvbGF0b3IgPSBpZGVudGl0eSwgdHJhbnNmb3JtLCBjbGFtcCA9IGZhbHNlLCB1bmtub3duOwogIGZ1bmN0aW9uIHNjYWxlKHgzKSB7CiAgICByZXR1cm4gaXNOYU4oeDMgPSAreDMpID8gdW5rbm93biA6ICh4MyA9IDAuNSArICgoeDMgPSArdHJhbnNmb3JtKHgzKSkgLSB0MTIpICogKHMgKiB4MyA8IHMgKiB0MTIgPyBrMTAgOiBrMjEpLCBpbnRlcnBvbGF0b3IoY2xhbXAgPyBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCB4MykpIDogeDMpKTsKICB9CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoW3gwLCB4MSwgeDJdID0gXywgdDAyID0gdHJhbnNmb3JtKHgwID0gK3gwKSwgdDEyID0gdHJhbnNmb3JtKHgxID0gK3gxKSwgdDIgPSB0cmFuc2Zvcm0oeDIgPSAreDIpLCBrMTAgPSB0MDIgPT09IHQxMiA/IDAgOiAwLjUgLyAodDEyIC0gdDAyKSwgazIxID0gdDEyID09PSB0MiA/IDAgOiAwLjUgLyAodDIgLSB0MTIpLCBzID0gdDEyIDwgdDAyID8gLTEgOiAxLCBzY2FsZSkgOiBbeDAsIHgxLCB4Ml07CiAgfTsKICBzY2FsZS5jbGFtcCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGNsYW1wID0gISFfLCBzY2FsZSkgOiBjbGFtcDsKICB9OwogIHNjYWxlLmludGVycG9sYXRvciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGludGVycG9sYXRvciA9IF8sIHNjYWxlKSA6IGludGVycG9sYXRvcjsKICB9OwogIGZ1bmN0aW9uIHJhbmdlNChpbnRlcnBvbGF0ZTIpIHsKICAgIHJldHVybiBmdW5jdGlvbihfKSB7CiAgICAgIHZhciByMCwgcjEsIHIyOwogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbcjAsIHIxLCByMl0gPSBfLCBpbnRlcnBvbGF0b3IgPSBwaWVjZXdpc2UoaW50ZXJwb2xhdGUyLCBbcjAsIHIxLCByMl0pLCBzY2FsZSkgOiBbaW50ZXJwb2xhdG9yKDApLCBpbnRlcnBvbGF0b3IoMC41KSwgaW50ZXJwb2xhdG9yKDEpXTsKICAgIH07CiAgfQogIHNjYWxlLnJhbmdlID0gcmFuZ2U0KHZhbHVlX2RlZmF1bHQpOwogIHNjYWxlLnJhbmdlUm91bmQgPSByYW5nZTQocm91bmRfZGVmYXVsdCk7CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHRyYW5zZm9ybSA9IHQsIHQwMiA9IHQoeDApLCB0MTIgPSB0KHgxKSwgdDIgPSB0KHgyKSwgazEwID0gdDAyID09PSB0MTIgPyAwIDogMC41IC8gKHQxMiAtIHQwMiksIGsyMSA9IHQxMiA9PT0gdDIgPyAwIDogMC41IC8gKHQyIC0gdDEyKSwgcyA9IHQxMiA8IHQwMiA/IC0xIDogMTsKICAgIHJldHVybiBzY2FsZTsKICB9Owp9CmZ1bmN0aW9uIGRpdmVyZ2luZygpIHsKICB2YXIgc2NhbGUgPSBsaW5lYXJpc2godHJhbnNmb3JtZXIzKCkoaWRlbnRpdHkpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIGRpdmVyZ2luZygpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIGRpdmVyZ2luZ0xvZygpIHsKICB2YXIgc2NhbGUgPSBsb2dnaXNoKHRyYW5zZm9ybWVyMygpKS5kb21haW4oWzAuMSwgMSwgMTBdKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIGRpdmVyZ2luZ0xvZygpKS5iYXNlKHNjYWxlLmJhc2UoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBkaXZlcmdpbmdTeW1sb2coKSB7CiAgdmFyIHNjYWxlID0gc3ltbG9naXNoKHRyYW5zZm9ybWVyMygpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIGRpdmVyZ2luZ1N5bWxvZygpKS5jb25zdGFudChzY2FsZS5jb25zdGFudCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIGRpdmVyZ2luZ1BvdygpIHsKICB2YXIgc2NhbGUgPSBwb3dpc2godHJhbnNmb3JtZXIzKCkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgZGl2ZXJnaW5nUG93KCkpLmV4cG9uZW50KHNjYWxlLmV4cG9uZW50KCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gZGl2ZXJnaW5nU3FydCgpIHsKICByZXR1cm4gZGl2ZXJnaW5nUG93LmFwcGx5KG51bGwsIGFyZ3VtZW50cykuZXhwb25lbnQoMC41KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2RhdGFTZWxlY3RvcnMuanMKdmFyIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzID0gKHN0YXRlKSA9PiBzdGF0ZS5jaGFydERhdGE7CnZhciBzZWxlY3RDaGFydERhdGFBbmRBbHdheXNJZ25vcmVJbmRleGVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzXSwgKGRhdGFTdGF0ZSkgPT4gewogIHZhciBkYXRhRW5kSW5kZXggPSBkYXRhU3RhdGUuY2hhcnREYXRhICE9IG51bGwgPyBkYXRhU3RhdGUuY2hhcnREYXRhLmxlbmd0aCAtIDEgOiAwOwogIHJldHVybiB7CiAgICBjaGFydERhdGE6IGRhdGFTdGF0ZS5jaGFydERhdGEsCiAgICBjb21wdXRlZERhdGE6IGRhdGFTdGF0ZS5jb21wdXRlZERhdGEsCiAgICBkYXRhRW5kSW5kZXgsCiAgICBkYXRhU3RhcnRJbmRleDogMAogIH07Cn0pOwp2YXIgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXNJZk5vdEluUGFub3JhbWEgPSAoc3RhdGUsIF91bnVzZWQxLCBfdW51c2VkMiwgaXNQYW5vcmFtYSkgPT4gewogIGlmIChpc1Bhbm9yYW1hKSB7CiAgICByZXR1cm4gc2VsZWN0Q2hhcnREYXRhQW5kQWx3YXlzSWdub3JlSW5kZXhlcyhzdGF0ZSk7CiAgfQogIHJldHVybiBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlcyhzdGF0ZSk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2lzRG9tYWluU3BlY2lmaWVkQnlVc2VyLmpzCmZ1bmN0aW9uIGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbih2KSB7CiAgaWYgKEFycmF5LmlzQXJyYXkodikgJiYgdi5sZW5ndGggPT09IDIpIHsKICAgIHZhciBbbWluMiwgbWF4Ml0gPSB2OwogICAgaWYgKGlzV2VsbEJlaGF2ZWROdW1iZXIobWluMikgJiYgaXNXZWxsQmVoYXZlZE51bWJlcihtYXgyKSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIGV4dGVuZERvbWFpbihwcm92aWRlZERvbWFpbiwgYm91bmRhcnlEb21haW4sIGFsbG93RGF0YU92ZXJmbG93KSB7CiAgaWYgKGFsbG93RGF0YU92ZXJmbG93KSB7CiAgICByZXR1cm4gcHJvdmlkZWREb21haW47CiAgfQogIHJldHVybiBbTWF0aC5taW4ocHJvdmlkZWREb21haW5bMF0sIGJvdW5kYXJ5RG9tYWluWzBdKSwgTWF0aC5tYXgocHJvdmlkZWREb21haW5bMV0sIGJvdW5kYXJ5RG9tYWluWzFdKV07Cn0KZnVuY3Rpb24gbnVtZXJpY2FsRG9tYWluU3BlY2lmaWVkV2l0aG91dFJlcXVpcmluZ0RhdGEodXNlckRvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpIHsKICBpZiAoIWFsbG93RGF0YU92ZXJmbG93KSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAodHlwZW9mIHVzZXJEb21haW4gPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KHVzZXJEb21haW4pICYmIHVzZXJEb21haW4ubGVuZ3RoID09PSAyKSB7CiAgICB2YXIgW3Byb3ZpZGVkTWluLCBwcm92aWRlZE1heF0gPSB1c2VyRG9tYWluOwogICAgdmFyIGZpbmFsTWluLCBmaW5hbE1heDsKICAgIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKHByb3ZpZGVkTWluKSkgewogICAgICBmaW5hbE1pbiA9IHByb3ZpZGVkTWluOwogICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvdmlkZWRNaW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKHByb3ZpZGVkTWF4KSkgewogICAgICBmaW5hbE1heCA9IHByb3ZpZGVkTWF4OwogICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvdmlkZWRNYXggPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHZhciBjYW5kaWRhdGUgPSBbZmluYWxNaW4sIGZpbmFsTWF4XTsKICAgIGlmIChpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oY2FuZGlkYXRlKSkgewogICAgICByZXR1cm4gY2FuZGlkYXRlOwogICAgfQogIH0KICByZXR1cm4gdm9pZCAwOwp9CmZ1bmN0aW9uIHBhcnNlTnVtZXJpY2FsVXNlckRvbWFpbih1c2VyRG9tYWluLCBkYXRhRG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdykgewogIGlmICghYWxsb3dEYXRhT3ZlcmZsb3cgJiYgZGF0YURvbWFpbiA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAodHlwZW9mIHVzZXJEb21haW4gPT09ICJmdW5jdGlvbiIgJiYgZGF0YURvbWFpbiAhPSBudWxsKSB7CiAgICB0cnkgewogICAgICB2YXIgcmVzdWx0ID0gdXNlckRvbWFpbihkYXRhRG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdyk7CiAgICAgIGlmIChpc1dlbGxGb3JtZWROdW1iZXJEb21haW4ocmVzdWx0KSkgewogICAgICAgIHJldHVybiBleHRlbmREb21haW4ocmVzdWx0LCBkYXRhRG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdyk7CiAgICAgIH0KICAgIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgIH0KICB9CiAgaWYgKEFycmF5LmlzQXJyYXkodXNlckRvbWFpbikgJiYgdXNlckRvbWFpbi5sZW5ndGggPT09IDIpIHsKICAgIHZhciBbcHJvdmlkZWRNaW4sIHByb3ZpZGVkTWF4XSA9IHVzZXJEb21haW47CiAgICB2YXIgZmluYWxNaW4sIGZpbmFsTWF4OwogICAgaWYgKHByb3ZpZGVkTWluID09PSAiYXV0byIpIHsKICAgICAgaWYgKGRhdGFEb21haW4gIT0gbnVsbCkgewogICAgICAgIGZpbmFsTWluID0gTWF0aC5taW4oLi4uZGF0YURvbWFpbik7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNOdW1iZXIocHJvdmlkZWRNaW4pKSB7CiAgICAgIGZpbmFsTWluID0gcHJvdmlkZWRNaW47CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm92aWRlZE1pbiA9PT0gImZ1bmN0aW9uIikgewogICAgICB0cnkgewogICAgICAgIGlmIChkYXRhRG9tYWluICE9IG51bGwpIHsKICAgICAgICAgIGZpbmFsTWluID0gcHJvdmlkZWRNaW4oZGF0YURvbWFpbiA9PT0gbnVsbCB8fCBkYXRhRG9tYWluID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhRG9tYWluWzBdKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKF91bnVzZWQyKSB7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWluID09PSAic3RyaW5nIiAmJiBNSU5fVkFMVUVfUkVHLnRlc3QocHJvdmlkZWRNaW4pKSB7CiAgICAgIHZhciBtYXRjaCA9IE1JTl9WQUxVRV9SRUcuZXhlYyhwcm92aWRlZE1pbik7CiAgICAgIGlmIChtYXRjaCA9PSBudWxsIHx8IGRhdGFEb21haW4gPT0gbnVsbCkgewogICAgICAgIGZpbmFsTWluID0gdm9pZCAwOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciB2YWx1ZSA9ICttYXRjaFsxXTsKICAgICAgICBmaW5hbE1pbiA9IGRhdGFEb21haW5bMF0gLSB2YWx1ZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZmluYWxNaW4gPSBkYXRhRG9tYWluID09PSBudWxsIHx8IGRhdGFEb21haW4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGFEb21haW5bMF07CiAgICB9CiAgICBpZiAocHJvdmlkZWRNYXggPT09ICJhdXRvIikgewogICAgICBpZiAoZGF0YURvbWFpbiAhPSBudWxsKSB7CiAgICAgICAgZmluYWxNYXggPSBNYXRoLm1heCguLi5kYXRhRG9tYWluKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc051bWJlcihwcm92aWRlZE1heCkpIHsKICAgICAgZmluYWxNYXggPSBwcm92aWRlZE1heDsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWF4ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRyeSB7CiAgICAgICAgaWYgKGRhdGFEb21haW4gIT0gbnVsbCkgewogICAgICAgICAgZmluYWxNYXggPSBwcm92aWRlZE1heChkYXRhRG9tYWluID09PSBudWxsIHx8IGRhdGFEb21haW4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGFEb21haW5bMV0pOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoX3VudXNlZDMpIHsKICAgICAgfQogICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvdmlkZWRNYXggPT09ICJzdHJpbmciICYmIE1BWF9WQUxVRV9SRUcudGVzdChwcm92aWRlZE1heCkpIHsKICAgICAgdmFyIF9tYXRjaCA9IE1BWF9WQUxVRV9SRUcuZXhlYyhwcm92aWRlZE1heCk7CiAgICAgIGlmIChfbWF0Y2ggPT0gbnVsbCB8fCBkYXRhRG9tYWluID09IG51bGwpIHsKICAgICAgICBmaW5hbE1heCA9IHZvaWQgMDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgX3ZhbHVlID0gK19tYXRjaFsxXTsKICAgICAgICBmaW5hbE1heCA9IGRhdGFEb21haW5bMV0gKyBfdmFsdWU7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZpbmFsTWF4ID0gZGF0YURvbWFpbiA9PT0gbnVsbCB8fCBkYXRhRG9tYWluID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhRG9tYWluWzFdOwogICAgfQogICAgdmFyIGNhbmRpZGF0ZSA9IFtmaW5hbE1pbiwgZmluYWxNYXhdOwogICAgaWYgKGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbihjYW5kaWRhdGUpKSB7CiAgICAgIGlmIChkYXRhRG9tYWluID09IG51bGwpIHsKICAgICAgICByZXR1cm4gY2FuZGlkYXRlOwogICAgICB9CiAgICAgIHJldHVybiBleHRlbmREb21haW4oY2FuZGlkYXRlLCBkYXRhRG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdyk7CiAgICB9CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc2NhbGUvZ2V0TmljZVRpY2tWYWx1ZXMuanMKdmFyIGltcG9ydF9kZWNpbWFsMiA9IF9fdG9FU00ocmVxdWlyZV9kZWNpbWFsKCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zY2FsZS91dGlsL3V0aWxzLmpzCnZhciBpZGVudGl0eTMgPSAoaSkgPT4gaTsKdmFyIFBMQUNFX0hPTERFUiA9IHsKICAiQEBmdW5jdGlvbmFsL3BsYWNlaG9sZGVyIjogdHJ1ZQp9Owp2YXIgaXNQbGFjZUhvbGRlciA9ICh2YWwpID0+IHZhbCA9PT0gUExBQ0VfSE9MREVSOwp2YXIgY3VycnkwID0gKGZuKSA9PiBmdW5jdGlvbiBfY3VycmllZCgpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCB8fCBhcmd1bWVudHMubGVuZ3RoID09PSAxICYmIGlzUGxhY2VIb2xkZXIoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdm9pZCAwIDogYXJndW1lbnRzWzBdKSkgewogICAgcmV0dXJuIF9jdXJyaWVkOwogIH0KICByZXR1cm4gZm4oLi4uYXJndW1lbnRzKTsKfTsKdmFyIGN1cnJ5TiA9IChuLCBmbikgPT4gewogIGlmIChuID09PSAxKSB7CiAgICByZXR1cm4gZm47CiAgfQogIHJldHVybiBjdXJyeTAoZnVuY3Rpb24oKSB7CiAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgYXJnc1tfa2V5XSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgIH0KICAgIHZhciBhcmdzTGVuZ3RoID0gYXJncy5maWx0ZXIoKGFyZykgPT4gYXJnICE9PSBQTEFDRV9IT0xERVIpLmxlbmd0aDsKICAgIGlmIChhcmdzTGVuZ3RoID49IG4pIHsKICAgICAgcmV0dXJuIGZuKC4uLmFyZ3MpOwogICAgfQogICAgcmV0dXJuIGN1cnJ5TihuIC0gYXJnc0xlbmd0aCwgY3VycnkwKGZ1bmN0aW9uKCkgewogICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIHJlc3RBcmdzID0gbmV3IEFycmF5KF9sZW4yKSwgX2tleTIgPSAwOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgcmVzdEFyZ3NbX2tleTJdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgfQogICAgICB2YXIgbmV3QXJncyA9IGFyZ3MubWFwKChhcmcpID0+IGlzUGxhY2VIb2xkZXIoYXJnKSA/IHJlc3RBcmdzLnNoaWZ0KCkgOiBhcmcpOwogICAgICByZXR1cm4gZm4oLi4ubmV3QXJncywgLi4ucmVzdEFyZ3MpOwogICAgfSkpOwogIH0pOwp9Owp2YXIgY3VycnkgPSAoZm4pID0+IGN1cnJ5Tihmbi5sZW5ndGgsIGZuKTsKdmFyIHJhbmdlMiA9IChiZWdpbiwgZW5kKSA9PiB7CiAgdmFyIGFyciA9IFtdOwogIGZvciAodmFyIGkgPSBiZWdpbjsgaSA8IGVuZDsgKytpKSB7CiAgICBhcnJbaSAtIGJlZ2luXSA9IGk7CiAgfQogIHJldHVybiBhcnI7Cn07CnZhciBtYXAyID0gY3VycnkoKGZuLCBhcnIpID0+IHsKICBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSB7CiAgICByZXR1cm4gYXJyLm1hcChmbik7CiAgfQogIHJldHVybiBPYmplY3Qua2V5cyhhcnIpLm1hcCgoa2V5KSA9PiBhcnJba2V5XSkubWFwKGZuKTsKfSk7CnZhciBjb21wb3NlMiA9IGZ1bmN0aW9uIGNvbXBvc2UzKCkgewogIGZvciAodmFyIF9sZW4zID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMyksIF9rZXkzID0gMDsgX2tleTMgPCBfbGVuMzsgX2tleTMrKykgewogICAgYXJnc1tfa2V5M10gPSBhcmd1bWVudHNbX2tleTNdOwogIH0KICBpZiAoIWFyZ3MubGVuZ3RoKSB7CiAgICByZXR1cm4gaWRlbnRpdHkzOwogIH0KICB2YXIgZm5zID0gYXJncy5yZXZlcnNlKCk7CiAgdmFyIGZpcnN0Rm4gPSBmbnNbMF07CiAgdmFyIHRhaWxzRm4gPSBmbnMuc2xpY2UoMSk7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRhaWxzRm4ucmVkdWNlKChyZXMsIGZuKSA9PiBmbihyZXMpLCBmaXJzdEZuKC4uLmFyZ3VtZW50cykpOwogIH07Cn07CnZhciByZXZlcnNlID0gKGFycikgPT4gewogIGlmIChBcnJheS5pc0FycmF5KGFycikpIHsKICAgIHJldHVybiBhcnIucmV2ZXJzZSgpOwogIH0KICByZXR1cm4gYXJyLnNwbGl0KCIiKS5yZXZlcnNlKCkuam9pbigiIik7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3NjYWxlL3V0aWwvYXJpdGhtZXRpYy5qcwp2YXIgaW1wb3J0X2RlY2ltYWwgPSBfX3RvRVNNKHJlcXVpcmVfZGVjaW1hbCgpKTsKZnVuY3Rpb24gZ2V0RGlnaXRDb3VudCh2YWx1ZSkgewogIHZhciByZXN1bHQ7CiAgaWYgKHZhbHVlID09PSAwKSB7CiAgICByZXN1bHQgPSAxOwogIH0gZWxzZSB7CiAgICByZXN1bHQgPSBNYXRoLmZsb29yKG5ldyBpbXBvcnRfZGVjaW1hbC5kZWZhdWx0KHZhbHVlKS5hYnMoKS5sb2coMTApLnRvTnVtYmVyKCkpICsgMTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiByYW5nZVN0ZXAoc3RhcnQsIGVuZCwgc3RlcCkgewogIHZhciBudW0gPSBuZXcgaW1wb3J0X2RlY2ltYWwuZGVmYXVsdChzdGFydCk7CiAgdmFyIGkgPSAwOwogIHZhciByZXN1bHQgPSBbXTsKICB3aGlsZSAobnVtLmx0KGVuZCkgJiYgaSA8IDFlNSkgewogICAgcmVzdWx0LnB1c2gobnVtLnRvTnVtYmVyKCkpOwogICAgbnVtID0gbnVtLmFkZChzdGVwKTsKICAgIGkrKzsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zY2FsZS9nZXROaWNlVGlja1ZhbHVlcy5qcwp2YXIgZ2V0VmFsaWRJbnRlcnZhbCA9IChfcmVmMikgPT4gewogIHZhciBbbWluMiwgbWF4Ml0gPSBfcmVmMjsKICB2YXIgW3ZhbGlkTWluLCB2YWxpZE1heF0gPSBbbWluMiwgbWF4Ml07CiAgaWYgKG1pbjIgPiBtYXgyKSB7CiAgICBbdmFsaWRNaW4sIHZhbGlkTWF4XSA9IFttYXgyLCBtaW4yXTsKICB9CiAgcmV0dXJuIFt2YWxpZE1pbiwgdmFsaWRNYXhdOwp9Owp2YXIgZ2V0Rm9ybWF0U3RlcCA9IChyb3VnaFN0ZXAsIGFsbG93RGVjaW1hbHMsIGNvcnJlY3Rpb25GYWN0b3IpID0+IHsKICBpZiAocm91Z2hTdGVwLmx0ZSgwKSkgewogICAgcmV0dXJuIG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgwKTsKICB9CiAgdmFyIGRpZ2l0Q291bnQgPSBnZXREaWdpdENvdW50KHJvdWdoU3RlcC50b051bWJlcigpKTsKICB2YXIgZGlnaXRDb3VudFZhbHVlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDEwKS5wb3coZGlnaXRDb3VudCk7CiAgdmFyIHN0ZXBSYXRpbyA9IHJvdWdoU3RlcC5kaXYoZGlnaXRDb3VudFZhbHVlKTsKICB2YXIgc3RlcFJhdGlvU2NhbGUgPSBkaWdpdENvdW50ICE9PSAxID8gMC4wNSA6IDAuMTsKICB2YXIgYW1lbmRTdGVwUmF0aW8gPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5jZWlsKHN0ZXBSYXRpby5kaXYoc3RlcFJhdGlvU2NhbGUpLnRvTnVtYmVyKCkpKS5hZGQoY29ycmVjdGlvbkZhY3RvcikubXVsKHN0ZXBSYXRpb1NjYWxlKTsKICB2YXIgZm9ybWF0U3RlcCA9IGFtZW5kU3RlcFJhdGlvLm11bChkaWdpdENvdW50VmFsdWUpOwogIHJldHVybiBhbGxvd0RlY2ltYWxzID8gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KGZvcm1hdFN0ZXAudG9OdW1iZXIoKSkgOiBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5jZWlsKGZvcm1hdFN0ZXAudG9OdW1iZXIoKSkpOwp9Owp2YXIgZ2V0VGlja09mU2luZ2xlVmFsdWUgPSAodmFsdWUsIHRpY2tDb3VudCwgYWxsb3dEZWNpbWFscykgPT4gewogIHZhciBzdGVwID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDEpOwogIHZhciBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQodmFsdWUpOwogIGlmICghbWlkZGxlLmlzaW50KCkgJiYgYWxsb3dEZWNpbWFscykgewogICAgdmFyIGFic1ZhbCA9IE1hdGguYWJzKHZhbHVlKTsKICAgIGlmIChhYnNWYWwgPCAxKSB7CiAgICAgIHN0ZXAgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMTApLnBvdyhnZXREaWdpdENvdW50KHZhbHVlKSAtIDEpOwogICAgICBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5mbG9vcihtaWRkbGUuZGl2KHN0ZXApLnRvTnVtYmVyKCkpKS5tdWwoc3RlcCk7CiAgICB9IGVsc2UgaWYgKGFic1ZhbCA+IDEpIHsKICAgICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguZmxvb3IodmFsdWUpKTsKICAgIH0KICB9IGVsc2UgaWYgKHZhbHVlID09PSAwKSB7CiAgICBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoTWF0aC5mbG9vcigodGlja0NvdW50IC0gMSkgLyAyKSk7CiAgfSBlbHNlIGlmICghYWxsb3dEZWNpbWFscykgewogICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguZmxvb3IodmFsdWUpKTsKICB9CiAgdmFyIG1pZGRsZUluZGV4ID0gTWF0aC5mbG9vcigodGlja0NvdW50IC0gMSkgLyAyKTsKICB2YXIgZm4gPSBjb21wb3NlMihtYXAyKChuKSA9PiBtaWRkbGUuYWRkKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChuIC0gbWlkZGxlSW5kZXgpLm11bChzdGVwKSkudG9OdW1iZXIoKSksIHJhbmdlMik7CiAgcmV0dXJuIGZuKDAsIHRpY2tDb3VudCk7Cn07CnZhciBfY2FsY3VsYXRlU3RlcCA9IGZ1bmN0aW9uIGNhbGN1bGF0ZVN0ZXAobWluMiwgbWF4MiwgdGlja0NvdW50LCBhbGxvd0RlY2ltYWxzKSB7CiAgdmFyIGNvcnJlY3Rpb25GYWN0b3IgPSBhcmd1bWVudHMubGVuZ3RoID4gNCAmJiBhcmd1bWVudHNbNF0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1s0XSA6IDA7CiAgaWYgKCFOdW1iZXIuaXNGaW5pdGUoKG1heDIgLSBtaW4yKSAvICh0aWNrQ291bnQgLSAxKSkpIHsKICAgIHJldHVybiB7CiAgICAgIHN0ZXA6IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgwKSwKICAgICAgdGlja01pbjogbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDApLAogICAgICB0aWNrTWF4OiBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMCkKICAgIH07CiAgfQogIHZhciBzdGVwID0gZ2V0Rm9ybWF0U3RlcChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQobWF4Mikuc3ViKG1pbjIpLmRpdih0aWNrQ291bnQgLSAxKSwgYWxsb3dEZWNpbWFscywgY29ycmVjdGlvbkZhY3Rvcik7CiAgdmFyIG1pZGRsZTsKICBpZiAobWluMiA8PSAwICYmIG1heDIgPj0gMCkgewogICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDApOwogIH0gZWxzZSB7CiAgICBtaWRkbGUgPSBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQobWluMikuYWRkKG1heDIpLmRpdigyKTsKICAgIG1pZGRsZSA9IG1pZGRsZS5zdWIobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KG1pZGRsZSkubW9kKHN0ZXApKTsKICB9CiAgdmFyIGJlbG93Q291bnQgPSBNYXRoLmNlaWwobWlkZGxlLnN1YihtaW4yKS5kaXYoc3RlcCkudG9OdW1iZXIoKSk7CiAgdmFyIHVwQ291bnQgPSBNYXRoLmNlaWwobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KG1heDIpLnN1YihtaWRkbGUpLmRpdihzdGVwKS50b051bWJlcigpKTsKICB2YXIgc2NhbGVDb3VudCA9IGJlbG93Q291bnQgKyB1cENvdW50ICsgMTsKICBpZiAoc2NhbGVDb3VudCA+IHRpY2tDb3VudCkgewogICAgcmV0dXJuIF9jYWxjdWxhdGVTdGVwKG1pbjIsIG1heDIsIHRpY2tDb3VudCwgYWxsb3dEZWNpbWFscywgY29ycmVjdGlvbkZhY3RvciArIDEpOwogIH0KICBpZiAoc2NhbGVDb3VudCA8IHRpY2tDb3VudCkgewogICAgdXBDb3VudCA9IG1heDIgPiAwID8gdXBDb3VudCArICh0aWNrQ291bnQgLSBzY2FsZUNvdW50KSA6IHVwQ291bnQ7CiAgICBiZWxvd0NvdW50ID0gbWF4MiA+IDAgPyBiZWxvd0NvdW50IDogYmVsb3dDb3VudCArICh0aWNrQ291bnQgLSBzY2FsZUNvdW50KTsKICB9CiAgcmV0dXJuIHsKICAgIHN0ZXAsCiAgICB0aWNrTWluOiBtaWRkbGUuc3ViKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChiZWxvd0NvdW50KS5tdWwoc3RlcCkpLAogICAgdGlja01heDogbWlkZGxlLmFkZChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQodXBDb3VudCkubXVsKHN0ZXApKQogIH07Cn07CnZhciBnZXROaWNlVGlja1ZhbHVlcyA9IGZ1bmN0aW9uIGdldE5pY2VUaWNrVmFsdWVzMihfcmVmMikgewogIHZhciBbbWluMiwgbWF4Ml0gPSBfcmVmMjsKICB2YXIgdGlja0NvdW50ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiA2OwogIHZhciBhbGxvd0RlY2ltYWxzID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiB0cnVlOwogIHZhciBjb3VudCA9IE1hdGgubWF4KHRpY2tDb3VudCwgMik7CiAgdmFyIFtjb3JtaW4sIGNvcm1heF0gPSBnZXRWYWxpZEludGVydmFsKFttaW4yLCBtYXgyXSk7CiAgaWYgKGNvcm1pbiA9PT0gLUluZmluaXR5IHx8IGNvcm1heCA9PT0gSW5maW5pdHkpIHsKICAgIHZhciBfdmFsdWVzID0gY29ybWF4ID09PSBJbmZpbml0eSA/IFtjb3JtaW4sIC4uLnJhbmdlMigwLCB0aWNrQ291bnQgLSAxKS5tYXAoKCkgPT4gSW5maW5pdHkpXSA6IFsuLi5yYW5nZTIoMCwgdGlja0NvdW50IC0gMSkubWFwKCgpID0+IC1JbmZpbml0eSksIGNvcm1heF07CiAgICByZXR1cm4gbWluMiA+IG1heDIgPyByZXZlcnNlKF92YWx1ZXMpIDogX3ZhbHVlczsKICB9CiAgaWYgKGNvcm1pbiA9PT0gY29ybWF4KSB7CiAgICByZXR1cm4gZ2V0VGlja09mU2luZ2xlVmFsdWUoY29ybWluLCB0aWNrQ291bnQsIGFsbG93RGVjaW1hbHMpOwogIH0KICB2YXIgewogICAgc3RlcCwKICAgIHRpY2tNaW4sCiAgICB0aWNrTWF4CiAgfSA9IF9jYWxjdWxhdGVTdGVwKGNvcm1pbiwgY29ybWF4LCBjb3VudCwgYWxsb3dEZWNpbWFscywgMCk7CiAgdmFyIHZhbHVlcyA9IHJhbmdlU3RlcCh0aWNrTWluLCB0aWNrTWF4LmFkZChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMC4xKS5tdWwoc3RlcCkpLCBzdGVwKTsKICByZXR1cm4gbWluMiA+IG1heDIgPyByZXZlcnNlKHZhbHVlcykgOiB2YWx1ZXM7Cn07CnZhciBnZXRUaWNrVmFsdWVzRml4ZWREb21haW4gPSBmdW5jdGlvbiBnZXRUaWNrVmFsdWVzRml4ZWREb21haW4yKF9yZWYzLCB0aWNrQ291bnQpIHsKICB2YXIgW21pbjIsIG1heDJdID0gX3JlZjM7CiAgdmFyIGFsbG93RGVjaW1hbHMgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1syXSA6IHRydWU7CiAgdmFyIFtjb3JtaW4sIGNvcm1heF0gPSBnZXRWYWxpZEludGVydmFsKFttaW4yLCBtYXgyXSk7CiAgaWYgKGNvcm1pbiA9PT0gLUluZmluaXR5IHx8IGNvcm1heCA9PT0gSW5maW5pdHkpIHsKICAgIHJldHVybiBbbWluMiwgbWF4Ml07CiAgfQogIGlmIChjb3JtaW4gPT09IGNvcm1heCkgewogICAgcmV0dXJuIFtjb3JtaW5dOwogIH0KICB2YXIgY291bnQgPSBNYXRoLm1heCh0aWNrQ291bnQsIDIpOwogIHZhciBzdGVwID0gZ2V0Rm9ybWF0U3RlcChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoY29ybWF4KS5zdWIoY29ybWluKS5kaXYoY291bnQgLSAxKSwgYWxsb3dEZWNpbWFscywgMCk7CiAgdmFyIHZhbHVlcyA9IFsuLi5yYW5nZVN0ZXAobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KGNvcm1pbiksIG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChjb3JtYXgpLCBzdGVwKSwgY29ybWF4XTsKICBpZiAoYWxsb3dEZWNpbWFscyA9PT0gZmFsc2UpIHsKICAgIHZhbHVlcyA9IHZhbHVlcy5tYXAoKHZhbHVlKSA9PiBNYXRoLnJvdW5kKHZhbHVlKSk7CiAgfQogIHJldHVybiBtaW4yID4gbWF4MiA/IHJldmVyc2UodmFsdWVzKSA6IHZhbHVlczsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9yb290UHJvcHNTZWxlY3RvcnMuanMKdmFyIHNlbGVjdEJhckNhdGVnb3J5R2FwID0gKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuYmFyQ2F0ZWdvcnlHYXA7CnZhciBzZWxlY3RTdGFja09mZnNldFR5cGUgPSAoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5zdGFja09mZnNldDsKdmFyIHNlbGVjdFJldmVyc2VTdGFja09yZGVyID0gKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMucmV2ZXJzZVN0YWNrT3JkZXI7CnZhciBzZWxlY3RDaGFydE5hbWUgPSAoc3RhdGUpID0+IHN0YXRlLm9wdGlvbnMuY2hhcnROYW1lOwp2YXIgc2VsZWN0U3luY0lkID0gKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuc3luY0lkOwp2YXIgc2VsZWN0U3luY01ldGhvZCA9IChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLnN5bmNNZXRob2Q7CnZhciBzZWxlY3RFdmVudEVtaXR0ZXIgPSAoc3RhdGUpID0+IHN0YXRlLm9wdGlvbnMuZXZlbnRFbWl0dGVyOwp2YXIgc2VsZWN0Q2hhcnRCYXNlVmFsdWUgPSAoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5iYXNlVmFsdWU7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi96SW5kZXgvRGVmYXVsdFpJbmRleGVzLmpzCnZhciBEZWZhdWx0WkluZGV4ZXMgPSB7CiAgLyoqCiAgICogQ2FydGVzaWFuR3JpZCBhbmQgUG9sYXJHcmlkCiAgICovCiAgZ3JpZDogLTEwMCwKICAvKioKICAgKiBCYWNrZ3JvdW5kIG9mIEJhciBhbmQgUmFkaWFsQmFyLgogICAqIFRoaXMgaXMgbm90IHZpc2libGUgYnkgZGVmYXVsdCBidXQgY2FuIGJlIGVuYWJsZWQgYnkgc2V0dGluZyBiYWNrZ3JvdW5kPXt0cnVlfSBvbiBCYXIgb3IgUmFkaWFsQmFyLgogICAqLwogIGJhckJhY2tncm91bmQ6IC01MCwKICAvKgogICAqIG90aGVyIGNoYXJ0IGVsZW1lbnRzIG9yIGN1c3RvbSBlbGVtZW50cyB3aXRob3V0IHNwZWNpZmljIHpJbmRleAogICAqIHJlbmRlciBpbiBoZXJlLCBhdCB6SW5kZXggMAogICAqLwogIC8qKgogICAqIEFyZWEsIFBpZSwgUmFkYXIsIGFuZCBSZWZlcmVuY2VBcmVhCiAgICovCiAgYXJlYTogMTAwLAogIC8qKgogICAqIEN1cnNvciBpcyBlbWJlZGRlZCBpbnNpZGUgVG9vbHRpcCBhbmQgY29udHJvbGxlZCBieSBpdC4KICAgKiBUaGUgVG9vbHRpcCBpdHNlbGYgaGFzIGEgc2VwYXJhdGUgcG9ydGFsIGFuZCBpcyBub3QgaW5jbHVkZWQgaW4gdGhlIHpJbmRleCBzeXN0ZW07CiAgICogQ3Vyc29yIGlzIHRoZSBkZWNvcmF0aW9uIGluc2lkZSB0aGUgY2hhcnQgYXJlYS4gQ3Vyc29yUmVjdGFuZ2xlIGlzIGEgcmVjdGFuZ2xlIGJveC4KICAgKiBJdCByZW5kZXJzIGJlbG93IGJhciBzbyB0aGF0IGluIGEgc3RhY2tlZCBiYXIgY2hhcnQgdGhlIGN1cnNvciByZWN0YW5nbGUgZG9lcyBub3QgaGlkZSB0aGUgb3RoZXIgYmFycy4KICAgKi8KICBjdXJzb3JSZWN0YW5nbGU6IDIwMCwKICAvKioKICAgKiBCYXIgYW5kIFJhZGlhbEJhcgogICAqLwogIGJhcjogMzAwLAogIC8qKgogICAqIExpbmUgYW5kIFJlZmVyZW5jZUxpbmUsIGFuZCBFcnJvckJvcgogICAqLwogIGxpbmU6IDQwMCwKICAvKioKICAgKiBYQXhpcyBhbmQgWUF4aXMgYW5kIFBvbGFyQW5nbGVBeGlzIGFuZCBQb2xhclJhZGl1c0F4aXMgdGlja3MgYW5kIGxpbmVzIGFuZCBjaGlsZHJlbgogICAqLwogIGF4aXM6IDUwMCwKICAvKioKICAgKiBTY2F0dGVyIGFuZCBSZWZlcmVuY2VEb3QsCiAgICogYW5kIERvdHMgb2YgTGluZSBhbmQgQXJlYSBhbmQgUmFkYXIgaWYgdGhleSBoYXZlIGRvdD10cnVlCiAgICovCiAgc2NhdHRlcjogNjAwLAogIC8qKgogICAqIEhvdmVyaW5nIG92ZXIgYSBCYXIgb3IgUmFkaWFsQmFyIHJlbmRlcnMgYSBoaWdobGlnaHQgcmVjdGFuZ2xlCiAgICovCiAgYWN0aXZlQmFyOiAxZTMsCiAgLyoqCiAgICogQ3Vyc29yIGlzIGVtYmVkZGVkIGluc2lkZSBUb29sdGlwIGFuZCBjb250cm9sbGVkIGJ5IGl0LgogICAqIFRoZSBUb29sdGlwIGl0c2VsZiBoYXMgYSBzZXBhcmF0ZSBwb3J0YWwgYW5kIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgekluZGV4IHN5c3RlbTsKICAgKiBDdXJzb3IgaXMgdGhlIGRlY29yYXRpb24gaW5zaWRlIHRoZSBjaGFydCBhcmVhLCB1c3VhbGx5IGEgY3Jvc3Mgb3IgYSBib3guCiAgICogQ3Vyc29yTGluZSBpcyBhIGxpbmUgY3Vyc29yIHJlbmRlcmVkIGluIExpbmUsIEFyZWEsIFNjYXR0ZXIsIFJhZGFyIGNoYXJ0cy4KICAgKiBJdCByZW5kZXJzIGFib3ZlIHRoZSBMaW5lIGFuZCBTY2F0dGVyIHNvIHRoYXQgaXQgaXMgYWx3YXlzIHZpc2libGUuCiAgICogSXQgcmVuZGVycyBiZWxvdyBhY3RpdmUgZG90IHNvIHRoYXQgdGhlIGRvdCBpcyBhbHdheXMgdmlzaWJsZSBhbmQgc2hvd3MgdGhlIGN1cnJlbnQgcG9pbnQuCiAgICogV2UncmUgYWxzbyBhc3N1bWluZyB0aGF0IHRoZSBhY3RpdmUgZG90IGlzIHNtYWxsIGVub3VnaCB0aGF0IGl0IGRvZXMgbm90IGZ1bGx5IGNvdmVyIHRoZSBjdXJzb3IgbGluZS4KICAgKgogICAqIFRoaXMgYWxzbyBhcHBsaWVzIHRvIHRoZSByYWRpYWwgY3Vyc29yIGluIFJhZGlhbEJhckNoYXJ0LgogICAqLwogIGN1cnNvckxpbmU6IDExMDAsCiAgLyoqCiAgICogSG92ZXJpbmcgb3ZlciBhIFBvaW50IGluIExpbmUsIEFyZWEsIFNjYXR0ZXIsIFJhZGFyIHJlbmRlcnMgYSBoaWdobGlnaHQgZG90CiAgICovCiAgYWN0aXZlRG90OiAxMjAwLAogIC8qKgogICAqIExhYmVsTGlzdCBhbmQgTGFiZWwsIGluY2x1ZGluZyBBeGlzIGxhYmVscwogICAqLwogIGxhYmVsOiAyZTMKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3BvbGFyL2RlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmpzCnZhciBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcyA9IHsKICBhbGxvd0RlY2ltYWxzOiBmYWxzZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogdHJ1ZSwKICAvLyBpZiBJIHNldCB0aGlzIHRvIGZhbHNlIHRoZW4gVG9vbHRpcCBzeW5jaHJvbmlzYXRpb24gc3RvcHMgd29ya2luZyBpbiBSYWRhciwgd3RmCiAgYW5nbGVBeGlzSWQ6IDAsCiAgYXhpc0xpbmU6IHRydWUsCiAgYXhpc0xpbmVUeXBlOiAicG9seWdvbiIsCiAgY3g6IDAsCiAgY3k6IDAsCiAgb3JpZW50YXRpb246ICJvdXRlciIsCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiAiYXV0byIsCiAgdGljazogdHJ1ZSwKICB0aWNrTGluZTogdHJ1ZSwKICB0aWNrU2l6ZTogOCwKICB0eXBlOiAiY2F0ZWdvcnkiLAogIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmF4aXMKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3BvbGFyL2RlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5qcwp2YXIgZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBmYWxzZSwKICBhbGxvd0RlY2ltYWxzOiBmYWxzZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogdHJ1ZSwKICBhbmdsZTogMCwKICBheGlzTGluZTogdHJ1ZSwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICBsYWJlbDogZmFsc2UsCiAgb3JpZW50YXRpb246ICJyaWdodCIsCiAgcmFkaXVzQXhpc0lkOiAwLAogIHJldmVyc2VkOiBmYWxzZSwKICBzY2FsZTogImF1dG8iLAogIHN0cm9rZTogIiNjY2MiLAogIHRpY2s6IHRydWUsCiAgdGlja0NvdW50OiA1LAogIHR5cGU6ICJudW1iZXIiLAogIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmF4aXMKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZUF4aXNSYW5nZVdpdGhSZXZlcnNlLmpzCnZhciBjb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UgPSAoYXhpc1NldHRpbmdzLCBheGlzUmFuZ2UpID0+IHsKICBpZiAoIWF4aXNTZXR0aW5ncyB8fCAhYXhpc1JhbmdlKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoYXhpc1NldHRpbmdzICE9PSBudWxsICYmIGF4aXNTZXR0aW5ncyAhPT0gdm9pZCAwICYmIGF4aXNTZXR0aW5ncy5yZXZlcnNlZCkgewogICAgcmV0dXJuIFtheGlzUmFuZ2VbMV0sIGF4aXNSYW5nZVswXV07CiAgfQogIHJldHVybiBheGlzUmFuZ2U7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvcG9sYXJBeGlzU2VsZWN0b3JzLmpzCnZhciBpbXBsaWNpdEFuZ2xlQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZmFsc2UsCiAgYWxsb3dEZWNpbWFsczogZmFsc2UsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGZhbHNlLAogIC8vIGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5IGhhcyBpdCBzZXQgdG8gdHJ1ZSBidXQgdGhlIGFjdHVhbCBheGlzIHJlbmRlcmluZyBpZ25vcmVzIHRoZSBwcm9wIGJlY2F1c2UgcmVhc29ucywKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaWQ6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmFuZ2xlQXhpc0lkLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICByZXZlcnNlZDogZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMucmV2ZXJzZWQsCiAgc2NhbGU6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnNjYWxlLAogIHRpY2s6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnRpY2ssCiAgdGlja0NvdW50OiB2b2lkIDAsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy50eXBlLAogIHVuaXQ6IHZvaWQgMAp9Owp2YXIgaW1wbGljaXRSYWRpdXNBeGlzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuYWxsb3dEYXRhT3ZlcmZsb3csCiAgYWxsb3dEZWNpbWFsczogZmFsc2UsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaWQ6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5yYWRpdXNBeGlzSWQsCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgbmFtZTogdm9pZCAwLAogIHJldmVyc2VkOiBmYWxzZSwKICBzY2FsZTogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnNjYWxlLAogIHRpY2s6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy50aWNrLAogIHRpY2tDb3VudDogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnRpY2tDb3VudCwKICB0aWNrczogdm9pZCAwLAogIHR5cGU6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy50eXBlLAogIHVuaXQ6IHZvaWQgMAp9Owp2YXIgaW1wbGljaXRSYWRpYWxCYXJBbmdsZUF4aXMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGZhbHNlLAogIGFsbG93RGVjaW1hbHM6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaWQ6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLmFuZ2xlQXhpc0lkLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICByZXZlcnNlZDogZmFsc2UsCiAgc2NhbGU6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnNjYWxlLAogIHRpY2s6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnRpY2ssCiAgdGlja0NvdW50OiB2b2lkIDAsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiAibnVtYmVyIiwKICB1bml0OiB2b2lkIDAKfTsKdmFyIGltcGxpY2l0UmFkaWFsQmFyUmFkaXVzQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLmFsbG93RGF0YU92ZXJmbG93LAogIGFsbG93RGVjaW1hbHM6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgZGF0YUtleTogdm9pZCAwLAogIGRvbWFpbjogdm9pZCAwLAogIGlkOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMucmFkaXVzQXhpc0lkLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICByZXZlcnNlZDogZmFsc2UsCiAgc2NhbGU6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5zY2FsZSwKICB0aWNrOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMudGljaywKICB0aWNrQ291bnQ6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy50aWNrQ291bnQsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiAiY2F0ZWdvcnkiLAogIHVuaXQ6IHZvaWQgMAp9Owp2YXIgc2VsZWN0QW5nbGVBeGlzID0gKHN0YXRlLCBhbmdsZUF4aXNJZCkgPT4gewogIGlmIChzdGF0ZS5wb2xhckF4aXMuYW5nbGVBeGlzW2FuZ2xlQXhpc0lkXSAhPSBudWxsKSB7CiAgICByZXR1cm4gc3RhdGUucG9sYXJBeGlzLmFuZ2xlQXhpc1thbmdsZUF4aXNJZF07CiAgfQogIGlmIChzdGF0ZS5sYXlvdXQubGF5b3V0VHlwZSA9PT0gInJhZGlhbCIpIHsKICAgIHJldHVybiBpbXBsaWNpdFJhZGlhbEJhckFuZ2xlQXhpczsKICB9CiAgcmV0dXJuIGltcGxpY2l0QW5nbGVBeGlzOwp9Owp2YXIgc2VsZWN0UmFkaXVzQXhpcyA9IChzdGF0ZSwgcmFkaXVzQXhpc0lkKSA9PiB7CiAgaWYgKHN0YXRlLnBvbGFyQXhpcy5yYWRpdXNBeGlzW3JhZGl1c0F4aXNJZF0gIT0gbnVsbCkgewogICAgcmV0dXJuIHN0YXRlLnBvbGFyQXhpcy5yYWRpdXNBeGlzW3JhZGl1c0F4aXNJZF07CiAgfQogIGlmIChzdGF0ZS5sYXlvdXQubGF5b3V0VHlwZSA9PT0gInJhZGlhbCIpIHsKICAgIHJldHVybiBpbXBsaWNpdFJhZGlhbEJhclJhZGl1c0F4aXM7CiAgfQogIHJldHVybiBpbXBsaWNpdFJhZGl1c0F4aXM7Cn07CnZhciBzZWxlY3RQb2xhck9wdGlvbnMgPSAoc3RhdGUpID0+IHN0YXRlLnBvbGFyT3B0aW9uczsKdmFyIHNlbGVjdE1heFJhZGl1cyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbF0sIGdldE1heFJhZGl1cyk7CnZhciBzZWxlY3RJbm5lclJhZGl1cyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RQb2xhck9wdGlvbnMsIHNlbGVjdE1heFJhZGl1c10sIChwb2xhckNoYXJ0T3B0aW9ucywgbWF4UmFkaXVzKSA9PiB7CiAgaWYgKHBvbGFyQ2hhcnRPcHRpb25zID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBnZXRQZXJjZW50VmFsdWUocG9sYXJDaGFydE9wdGlvbnMuaW5uZXJSYWRpdXMsIG1heFJhZGl1cywgMCk7Cn0pOwp2YXIgc2VsZWN0T3V0ZXJSYWRpdXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UG9sYXJPcHRpb25zLCBzZWxlY3RNYXhSYWRpdXNdLCAocG9sYXJDaGFydE9wdGlvbnMsIG1heFJhZGl1cykgPT4gewogIGlmIChwb2xhckNoYXJ0T3B0aW9ucyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZ2V0UGVyY2VudFZhbHVlKHBvbGFyQ2hhcnRPcHRpb25zLm91dGVyUmFkaXVzLCBtYXhSYWRpdXMsIG1heFJhZGl1cyAqIDAuOCk7Cn0pOwp2YXIgY29tYmluZUFuZ2xlQXhpc1JhbmdlID0gKHBvbGFyT3B0aW9ucykgPT4gewogIGlmIChwb2xhck9wdGlvbnMgPT0gbnVsbCkgewogICAgcmV0dXJuIFswLCAwXTsKICB9CiAgdmFyIHsKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBwb2xhck9wdGlvbnM7CiAgcmV0dXJuIFtzdGFydEFuZ2xlLCBlbmRBbmdsZV07Cn07CnZhciBzZWxlY3RBbmdsZUF4aXNSYW5nZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RQb2xhck9wdGlvbnNdLCBjb21iaW5lQW5nbGVBeGlzUmFuZ2UpOwp2YXIgc2VsZWN0QW5nbGVBeGlzUmFuZ2VXaXRoUmV2ZXJzZWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QW5nbGVBeGlzLCBzZWxlY3RBbmdsZUF4aXNSYW5nZV0sIGNvbWJpbmVBeGlzUmFuZ2VXaXRoUmV2ZXJzZSk7CnZhciBzZWxlY3RSYWRpdXNBeGlzUmFuZ2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0TWF4UmFkaXVzLCBzZWxlY3RJbm5lclJhZGl1cywgc2VsZWN0T3V0ZXJSYWRpdXNdLCAobWF4UmFkaXVzLCBpbm5lclJhZGl1cywgb3V0ZXJSYWRpdXMpID0+IHsKICBpZiAobWF4UmFkaXVzID09IG51bGwgfHwgaW5uZXJSYWRpdXMgPT0gbnVsbCB8fCBvdXRlclJhZGl1cyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gW2lubmVyUmFkaXVzLCBvdXRlclJhZGl1c107Cn0pOwp2YXIgc2VsZWN0UmFkaXVzQXhpc1JhbmdlV2l0aFJldmVyc2VkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJhZGl1c0F4aXMsIHNlbGVjdFJhZGl1c0F4aXNSYW5nZV0sIGNvbWJpbmVBeGlzUmFuZ2VXaXRoUmV2ZXJzZSk7CnZhciBzZWxlY3RQb2xhclZpZXdCb3ggPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFBvbGFyT3B0aW9ucywgc2VsZWN0SW5uZXJSYWRpdXMsIHNlbGVjdE91dGVyUmFkaXVzLCBzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodF0sIChsYXlvdXQsIHBvbGFyT3B0aW9ucywgaW5uZXJSYWRpdXMsIG91dGVyUmFkaXVzLCB3aWR0aCwgaGVpZ2h0KSA9PiB7CiAgaWYgKGxheW91dCAhPT0gImNlbnRyaWMiICYmIGxheW91dCAhPT0gInJhZGlhbCIgfHwgcG9sYXJPcHRpb25zID09IG51bGwgfHwgaW5uZXJSYWRpdXMgPT0gbnVsbCB8fCBvdXRlclJhZGl1cyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBwb2xhck9wdGlvbnM7CiAgcmV0dXJuIHsKICAgIGN4OiBnZXRQZXJjZW50VmFsdWUoY3gsIHdpZHRoLCB3aWR0aCAvIDIpLAogICAgY3k6IGdldFBlcmNlbnRWYWx1ZShjeSwgaGVpZ2h0LCBoZWlnaHQgLyAyKSwKICAgIGlubmVyUmFkaXVzLAogICAgb3V0ZXJSYWRpdXMsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUsCiAgICBjbG9ja1dpc2U6IGZhbHNlCiAgICAvLyB0aGlzIHByb3BlcnR5IGxvb2sgdXNlZnVsLCB3aHkgbm90IHVzZSBpdD8KICB9Owp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9waWNrQXhpc1R5cGUuanMKdmFyIHBpY2tBeGlzVHlwZSA9IChfc3RhdGUsIGF4aXNUeXBlKSA9PiBheGlzVHlwZTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9waWNrQXhpc0lkLmpzCnZhciBwaWNrQXhpc0lkID0gKF9zdGF0ZSwgX2F4aXNUeXBlLCBheGlzSWQpID0+IGF4aXNJZDsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc3RhY2tzL2dldFN0YWNrU2VyaWVzSWRlbnRpZmllci5qcwpmdW5jdGlvbiBnZXRTdGFja1Nlcmllc0lkZW50aWZpZXIoZ3JhcGhpY2FsSXRlbSkgewogIHJldHVybiBncmFwaGljYWxJdGVtID09PSBudWxsIHx8IGdyYXBoaWNhbEl0ZW0gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGdyYXBoaWNhbEl0ZW0uaWQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZURpc3BsYXllZFN0YWNrZWREYXRhLmpzCmZ1bmN0aW9uIGNvbWJpbmVEaXNwbGF5ZWRTdGFja2VkRGF0YShzdGFja2VkR3JhcGhpY2FsSXRlbXMsIF9yZWYyLCB0b29sdGlwQXhpc1NldHRpbmdzKSB7CiAgdmFyIHsKICAgIGNoYXJ0RGF0YSA9IFtdCiAgfSA9IF9yZWYyOwogIHZhciB7CiAgICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICAgIGRhdGFLZXk6IHRvb2x0aXBEYXRhS2V5CiAgfSA9IHRvb2x0aXBBeGlzU2V0dGluZ3M7CiAgdmFyIGtub3duSXRlbXNCeURhdGFLZXkgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIHN0YWNrZWRHcmFwaGljYWxJdGVtcy5mb3JFYWNoKChpdGVtKSA9PiB7CiAgICB2YXIgX2l0ZW0kZGF0YTsKICAgIHZhciByZXNvbHZlZERhdGEgPSAoX2l0ZW0kZGF0YSA9IGl0ZW0uZGF0YSkgIT09IG51bGwgJiYgX2l0ZW0kZGF0YSAhPT0gdm9pZCAwID8gX2l0ZW0kZGF0YSA6IGNoYXJ0RGF0YTsKICAgIGlmIChyZXNvbHZlZERhdGEgPT0gbnVsbCB8fCByZXNvbHZlZERhdGEubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBzdGFja0lkZW50aWZpZXIgPSBnZXRTdGFja1Nlcmllc0lkZW50aWZpZXIoaXRlbSk7CiAgICByZXNvbHZlZERhdGEuZm9yRWFjaCgoZW50cnksIGluZGV4KSA9PiB7CiAgICAgIHZhciB0b29sdGlwVmFsdWUgPSB0b29sdGlwRGF0YUtleSA9PSBudWxsIHx8IGFsbG93RHVwbGljYXRlZENhdGVnb3J5ID8gaW5kZXggOiBTdHJpbmcoZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIHRvb2x0aXBEYXRhS2V5LCBudWxsKSk7CiAgICAgIHZhciBudW1lcmljVmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgaXRlbS5kYXRhS2V5LCAwKTsKICAgICAgdmFyIGN1cnI7CiAgICAgIGlmIChrbm93bkl0ZW1zQnlEYXRhS2V5Lmhhcyh0b29sdGlwVmFsdWUpKSB7CiAgICAgICAgY3VyciA9IGtub3duSXRlbXNCeURhdGFLZXkuZ2V0KHRvb2x0aXBWYWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY3VyciA9IHt9OwogICAgICB9CiAgICAgIE9iamVjdC5hc3NpZ24oY3VyciwgewogICAgICAgIFtzdGFja0lkZW50aWZpZXJdOiBudW1lcmljVmFsdWUKICAgICAgfSk7CiAgICAgIGtub3duSXRlbXNCeURhdGFLZXkuc2V0KHRvb2x0aXBWYWx1ZSwgY3Vycik7CiAgICB9KTsKICB9KTsKICByZXR1cm4gQXJyYXkuZnJvbShrbm93bkl0ZW1zQnlEYXRhS2V5LnZhbHVlcygpKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvdHlwZXMvU3RhY2tlZEdyYXBoaWNhbEl0ZW0uanMKZnVuY3Rpb24gaXNTdGFja2VkKGdyYXBoaWNhbEl0ZW0pIHsKICByZXR1cm4gZ3JhcGhpY2FsSXRlbS5zdGFja0lkICE9IG51bGwgJiYgZ3JhcGhpY2FsSXRlbS5kYXRhS2V5ICE9IG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9udW1iZXJEb21haW5FcXVhbGl0eUNoZWNrLmpzCnZhciBudW1iZXJEb21haW5FcXVhbGl0eUNoZWNrID0gKGEsIGIpID0+IHsKICBpZiAoYSA9PT0gYikgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGlmIChhID09IG51bGwgfHwgYiA9PSBudWxsKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHJldHVybiBhWzBdID09PSBiWzBdICYmIGFbMV0gPT09IGJbMV07Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvYXJyYXlFcXVhbGl0eUNoZWNrLmpzCmZ1bmN0aW9uIGVtcHR5QXJyYXlzQXJlRXF1YWxDaGVjayhhLCBiKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkoYSkgJiYgQXJyYXkuaXNBcnJheShiKSAmJiBhLmxlbmd0aCA9PT0gMCAmJiBiLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBhID09PSBiOwp9CmZ1bmN0aW9uIGFycmF5Q29udGVudHNBcmVFcXVhbENoZWNrKGEsIGIpIHsKICBpZiAoYS5sZW5ndGggPT09IGIubGVuZ3RoKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGFbaV0gIT09IGJbaV0pIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gZmFsc2U7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RUb29sdGlwQXhpc1R5cGUuanMKdmFyIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSA9IChzdGF0ZSkgPT4gewogIHZhciBsYXlvdXQgPSBzZWxlY3RDaGFydExheW91dChzdGF0ZSk7CiAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiKSB7CiAgICByZXR1cm4gInhBeGlzIjsKICB9CiAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgcmV0dXJuICJ5QXhpcyI7CiAgfQogIGlmIChsYXlvdXQgPT09ICJjZW50cmljIikgewogICAgcmV0dXJuICJhbmdsZUF4aXMiOwogIH0KICByZXR1cm4gInJhZGl1c0F4aXMiOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBBeGlzSWQuanMKdmFyIHNlbGVjdFRvb2x0aXBBeGlzSWQgPSAoc3RhdGUpID0+IHN0YXRlLnRvb2x0aXAuc2V0dGluZ3MuYXhpc0lkOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2F4aXNTZWxlY3RvcnMuanMKZnVuY3Rpb24gb3duS2V5czEzKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTMoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxMyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTMoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTMoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTEzKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTMocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTModCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTModCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTModCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBkZWZhdWx0TnVtZXJpY0RvbWFpbiA9IFswLCAiYXV0byJdOwp2YXIgaW1wbGljaXRYQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZmFsc2UsCiAgYWxsb3dEZWNpbWFsczogdHJ1ZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogdHJ1ZSwKICBhbmdsZTogMCwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaGVpZ2h0OiAzMCwKICBoaWRlOiB0cnVlLAogIGlkOiAwLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIGludGVydmFsOiAicHJlc2VydmVFbmQiLAogIG1pblRpY2tHYXA6IDUsCiAgbWlycm9yOiBmYWxzZSwKICBuYW1lOiB2b2lkIDAsCiAgb3JpZW50YXRpb246ICJib3R0b20iLAogIHBhZGRpbmc6IHsKICAgIGxlZnQ6IDAsCiAgICByaWdodDogMAogIH0sCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiAiYXV0byIsCiAgdGljazogdHJ1ZSwKICB0aWNrQ291bnQ6IDUsCiAgdGlja0Zvcm1hdHRlcjogdm9pZCAwLAogIHRpY2tzOiB2b2lkIDAsCiAgdHlwZTogImNhdGVnb3J5IiwKICB1bml0OiB2b2lkIDAKfTsKdmFyIHNlbGVjdFhBeGlzU2V0dGluZ3NOb0RlZmF1bHRzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICByZXR1cm4gc3RhdGUuY2FydGVzaWFuQXhpcy54QXhpc1theGlzSWRdOwp9Owp2YXIgc2VsZWN0WEF4aXNTZXR0aW5ncyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIGF4aXMgPSBzZWxlY3RYQXhpc1NldHRpbmdzTm9EZWZhdWx0cyhzdGF0ZSwgYXhpc0lkKTsKICBpZiAoYXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gaW1wbGljaXRYQXhpczsKICB9CiAgcmV0dXJuIGF4aXM7Cn07CnZhciBpbXBsaWNpdFlBeGlzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBmYWxzZSwKICBhbGxvd0RlY2ltYWxzOiB0cnVlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiB0cnVlLAogIGFuZ2xlOiAwLAogIGRhdGFLZXk6IHZvaWQgMCwKICBkb21haW46IGRlZmF1bHROdW1lcmljRG9tYWluLAogIGhpZGU6IHRydWUsCiAgaWQ6IDAsCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgaW50ZXJ2YWw6ICJwcmVzZXJ2ZUVuZCIsCiAgbWluVGlja0dhcDogNSwKICBtaXJyb3I6IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICBvcmllbnRhdGlvbjogImxlZnQiLAogIHBhZGRpbmc6IHsKICAgIHRvcDogMCwKICAgIGJvdHRvbTogMAogIH0sCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiAiYXV0byIsCiAgdGljazogdHJ1ZSwKICB0aWNrQ291bnQ6IDUsCiAgdGlja0Zvcm1hdHRlcjogdm9pZCAwLAogIHRpY2tzOiB2b2lkIDAsCiAgdHlwZTogIm51bWJlciIsCiAgdW5pdDogdm9pZCAwLAogIHdpZHRoOiBERUZBVUxUX1lfQVhJU19XSURUSAp9Owp2YXIgc2VsZWN0WUF4aXNTZXR0aW5nc05vRGVmYXVsdHMgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHJldHVybiBzdGF0ZS5jYXJ0ZXNpYW5BeGlzLnlBeGlzW2F4aXNJZF07Cn07CnZhciBzZWxlY3RZQXhpc1NldHRpbmdzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICB2YXIgYXhpcyA9IHNlbGVjdFlBeGlzU2V0dGluZ3NOb0RlZmF1bHRzKHN0YXRlLCBheGlzSWQpOwogIGlmIChheGlzID09IG51bGwpIHsKICAgIHJldHVybiBpbXBsaWNpdFlBeGlzOwogIH0KICByZXR1cm4gYXhpczsKfTsKdmFyIGltcGxpY2l0WkF4aXMgPSB7CiAgZG9tYWluOiBbMCwgImF1dG8iXSwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICByZXZlcnNlZDogZmFsc2UsCiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBmYWxzZSwKICBkYXRhS2V5OiB2b2lkIDAsCiAgaWQ6IDAsCiAgbmFtZTogIiIsCiAgcmFuZ2U6IFs2NCwgNjRdLAogIHNjYWxlOiAiYXV0byIsCiAgdHlwZTogIm51bWJlciIsCiAgdW5pdDogIiIKfTsKdmFyIHNlbGVjdFpBeGlzU2V0dGluZ3MgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciBheGlzID0gc3RhdGUuY2FydGVzaWFuQXhpcy56QXhpc1theGlzSWRdOwogIGlmIChheGlzID09IG51bGwpIHsKICAgIHJldHVybiBpbXBsaWNpdFpBeGlzOwogIH0KICByZXR1cm4gYXhpczsKfTsKdmFyIHNlbGVjdEJhc2VBeGlzID0gKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkKSA9PiB7CiAgc3dpdGNoIChheGlzVHlwZSkgewogICAgY2FzZSAieEF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAieUF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAiekF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RaQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAiYW5nbGVBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0QW5nbGVBeGlzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAicmFkaXVzQXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFJhZGl1c0F4aXMoc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgYXhpcyB0eXBlOiAiLmNvbmNhdChheGlzVHlwZSkpOwogIH0KfTsKdmFyIHNlbGVjdENhcnRlc2lhbkF4aXNTZXR0aW5ncyA9IChzdGF0ZSwgYXhpc1R5cGUsIGF4aXNJZCkgPT4gewogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WEF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgInlBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WUF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBheGlzIHR5cGU6ICIuY29uY2F0KGF4aXNUeXBlKSk7CiAgfQp9Owp2YXIgc2VsZWN0QXhpc1NldHRpbmdzID0gKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkKSA9PiB7CiAgc3dpdGNoIChheGlzVHlwZSkgewogICAgY2FzZSAieEF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAieUF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAiYW5nbGVBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0QW5nbGVBeGlzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAicmFkaXVzQXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFJhZGl1c0F4aXMoc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgYXhpcyB0eXBlOiAiLmNvbmNhdChheGlzVHlwZSkpOwogIH0KfTsKdmFyIHNlbGVjdEhhc0JhciA9IChzdGF0ZSkgPT4gc3RhdGUuZ3JhcGhpY2FsSXRlbXMuY2FydGVzaWFuSXRlbXMuc29tZSgoaXRlbSkgPT4gaXRlbS50eXBlID09PSAiYmFyIikgfHwgc3RhdGUuZ3JhcGhpY2FsSXRlbXMucG9sYXJJdGVtcy5zb21lKChpdGVtKSA9PiBpdGVtLnR5cGUgPT09ICJyYWRpYWxCYXIiKTsKZnVuY3Rpb24gaXRlbUF4aXNQcmVkaWNhdGUoYXhpc1R5cGUsIGF4aXNJZCkgewogIHJldHVybiAoaXRlbSkgPT4gewogICAgc3dpdGNoIChheGlzVHlwZSkgewogICAgICBjYXNlICJ4QXhpcyI6CiAgICAgICAgcmV0dXJuICJ4QXhpc0lkIiBpbiBpdGVtICYmIGl0ZW0ueEF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJ5QXhpcyI6CiAgICAgICAgcmV0dXJuICJ5QXhpc0lkIiBpbiBpdGVtICYmIGl0ZW0ueUF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJ6QXhpcyI6CiAgICAgICAgcmV0dXJuICJ6QXhpc0lkIiBpbiBpdGVtICYmIGl0ZW0uekF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJhbmdsZUF4aXMiOgogICAgICAgIHJldHVybiAiYW5nbGVBeGlzSWQiIGluIGl0ZW0gJiYgaXRlbS5hbmdsZUF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJyYWRpdXNBeGlzIjoKICAgICAgICByZXR1cm4gInJhZGl1c0F4aXNJZCIgaW4gaXRlbSAmJiBpdGVtLnJhZGl1c0F4aXNJZCA9PT0gYXhpc0lkOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9Owp9CnZhciBzZWxlY3RVbmZpbHRlcmVkQ2FydGVzaWFuSXRlbXMgPSAoc3RhdGUpID0+IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLmNhcnRlc2lhbkl0ZW1zOwp2YXIgc2VsZWN0QXhpc1ByZWRpY2F0ZSA9IGNyZWF0ZVNlbGVjdG9yKFtwaWNrQXhpc1R5cGUsIHBpY2tBeGlzSWRdLCBpdGVtQXhpc1ByZWRpY2F0ZSk7CnZhciBjb21iaW5lR3JhcGhpY2FsSXRlbXNTZXR0aW5ncyA9IChncmFwaGljYWxJdGVtcywgYXhpc1NldHRpbmdzLCBheGlzUHJlZGljYXRlKSA9PiBncmFwaGljYWxJdGVtcy5maWx0ZXIoYXhpc1ByZWRpY2F0ZSkuZmlsdGVyKChpdGVtKSA9PiB7CiAgaWYgKChheGlzU2V0dGluZ3MgPT09IG51bGwgfHwgYXhpc1NldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzU2V0dGluZ3MuaW5jbHVkZUhpZGRlbikgPT09IHRydWUpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gIWl0ZW0uaGlkZTsKfSk7CnZhciBzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFVuZmlsdGVyZWRDYXJ0ZXNpYW5JdGVtcywgc2VsZWN0QmFzZUF4aXMsIHNlbGVjdEF4aXNQcmVkaWNhdGVdLCBjb21iaW5lR3JhcGhpY2FsSXRlbXNTZXR0aW5ncywgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBlbXB0eUFycmF5c0FyZUVxdWFsQ2hlY2sKICB9Cn0pOwp2YXIgc2VsZWN0U3RhY2tlZENhcnRlc2lhbkl0ZW1zU2V0dGluZ3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2FydGVzaWFuSXRlbXNTZXR0aW5nc10sIChjYXJ0ZXNpYW5JdGVtcykgPT4gewogIHJldHVybiBjYXJ0ZXNpYW5JdGVtcy5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0udHlwZSA9PT0gImFyZWEiIHx8IGl0ZW0udHlwZSA9PT0gImJhciIpLmZpbHRlcihpc1N0YWNrZWQpOwp9KTsKdmFyIGZpbHRlckdyYXBoaWNhbE5vdFN0YWNrZWRJdGVtcyA9IChjYXJ0ZXNpYW5JdGVtcykgPT4gY2FydGVzaWFuSXRlbXMuZmlsdGVyKChpdGVtKSA9PiAhKCJzdGFja0lkIiBpbiBpdGVtKSB8fCBpdGVtLnN0YWNrSWQgPT09IHZvaWQgMCk7CnZhciBzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzRXhjZXB0U3RhY2tlZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzXSwgZmlsdGVyR3JhcGhpY2FsTm90U3RhY2tlZEl0ZW1zKTsKdmFyIGNvbWJpbmVHcmFwaGljYWxJdGVtc0RhdGEgPSAoY2FydGVzaWFuSXRlbXMpID0+IGNhcnRlc2lhbkl0ZW1zLm1hcCgoaXRlbSkgPT4gaXRlbS5kYXRhKS5maWx0ZXIoQm9vbGVhbikuZmxhdCgxKTsKdmFyIHNlbGVjdENhcnRlc2lhbkdyYXBoaWNhbEl0ZW1zRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzXSwgY29tYmluZUdyYXBoaWNhbEl0ZW1zRGF0YSwgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBlbXB0eUFycmF5c0FyZUVxdWFsQ2hlY2sKICB9Cn0pOwp2YXIgY29tYmluZURpc3BsYXllZERhdGEgPSAoZ3JhcGhpY2FsSXRlbXNEYXRhLCBfcmVmMikgPT4gewogIHZhciB7CiAgICBjaGFydERhdGEgPSBbXSwKICAgIGRhdGFTdGFydEluZGV4LAogICAgZGF0YUVuZEluZGV4CiAgfSA9IF9yZWYyOwogIGlmIChncmFwaGljYWxJdGVtc0RhdGEubGVuZ3RoID4gMCkgewogICAgcmV0dXJuIGdyYXBoaWNhbEl0ZW1zRGF0YTsKICB9CiAgcmV0dXJuIGNoYXJ0RGF0YS5zbGljZShkYXRhU3RhcnRJbmRleCwgZGF0YUVuZEluZGV4ICsgMSk7Cn07CnZhciBzZWxlY3REaXNwbGF5ZWREYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENhcnRlc2lhbkdyYXBoaWNhbEl0ZW1zRGF0YSwgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXNJZk5vdEluUGFub3JhbWFdLCBjb21iaW5lRGlzcGxheWVkRGF0YSk7CnZhciBjb21iaW5lQXBwbGllZFZhbHVlcyA9IChkYXRhLCBheGlzU2V0dGluZ3MsIGl0ZW1zKSA9PiB7CiAgaWYgKChheGlzU2V0dGluZ3MgPT09IG51bGwgfHwgYXhpc1NldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzU2V0dGluZ3MuZGF0YUtleSkgIT0gbnVsbCkgewogICAgcmV0dXJuIGRhdGEubWFwKChpdGVtKSA9PiAoewogICAgICB2YWx1ZTogZ2V0VmFsdWVCeURhdGFLZXkoaXRlbSwgYXhpc1NldHRpbmdzLmRhdGFLZXkpCiAgICB9KSk7CiAgfQogIGlmIChpdGVtcy5sZW5ndGggPiAwKSB7CiAgICByZXR1cm4gaXRlbXMubWFwKChpdGVtKSA9PiBpdGVtLmRhdGFLZXkpLmZsYXRNYXAoKGRhdGFLZXkpID0+IGRhdGEubWFwKChlbnRyeSkgPT4gKHsKICAgICAgdmFsdWU6IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCBkYXRhS2V5KQogICAgfSkpKTsKICB9CiAgcmV0dXJuIGRhdGEubWFwKChlbnRyeSkgPT4gKHsKICAgIHZhbHVlOiBlbnRyeQogIH0pKTsKfTsKdmFyIHNlbGVjdEFsbEFwcGxpZWRWYWx1ZXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RGlzcGxheWVkRGF0YSwgc2VsZWN0QmFzZUF4aXMsIHNlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3NdLCBjb21iaW5lQXBwbGllZFZhbHVlcyk7CmZ1bmN0aW9uIGlzRXJyb3JCYXJSZWxldmFudEZvckF4aXNUeXBlKGF4aXNUeXBlLCBlcnJvckJhcikgewogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjoKICAgICAgcmV0dXJuIGVycm9yQmFyLmRpcmVjdGlvbiA9PT0gIngiOwogICAgY2FzZSAieUF4aXMiOgogICAgICByZXR1cm4gZXJyb3JCYXIuZGlyZWN0aW9uID09PSAieSI7CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gZmFsc2U7CiAgfQp9CmZ1bmN0aW9uIG1ha2VOdW1iZXIodmFsKSB7CiAgaWYgKGlzTnVtT3JTdHIodmFsKSB8fCB2YWwgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICB2YXIgbiA9IE51bWJlcih2YWwpOwogICAgaWYgKGlzV2VsbEJlaGF2ZWROdW1iZXIobikpIHsKICAgICAgcmV0dXJuIG47CiAgICB9CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KZnVuY3Rpb24gbWFrZURvbWFpbih2YWwpIHsKICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7CiAgICB2YXIgYXR0ZW1wdCA9IFttYWtlTnVtYmVyKHZhbFswXSksIG1ha2VOdW1iZXIodmFsWzFdKV07CiAgICBpZiAoaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKGF0dGVtcHQpKSB7CiAgICAgIHJldHVybiBhdHRlbXB0OwogICAgfQogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIG4gPSBtYWtlTnVtYmVyKHZhbCk7CiAgaWYgKG4gPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtuLCBuXTsKfQpmdW5jdGlvbiBvbmx5QWxsb3dOdW1iZXJzKGRhdGEpIHsKICByZXR1cm4gZGF0YS5tYXAobWFrZU51bWJlcikuZmlsdGVyKGlzTm90TmlsKTsKfQpmdW5jdGlvbiBnZXRFcnJvckRvbWFpbkJ5RGF0YUtleShlbnRyeSwgYXBwbGllZFZhbHVlLCByZWxldmFudEVycm9yQmFycykgewogIGlmICghcmVsZXZhbnRFcnJvckJhcnMgfHwgdHlwZW9mIGFwcGxpZWRWYWx1ZSAhPT0gIm51bWJlciIgfHwgaXNOYW4oYXBwbGllZFZhbHVlKSkgewogICAgcmV0dXJuIFtdOwogIH0KICBpZiAoIXJlbGV2YW50RXJyb3JCYXJzLmxlbmd0aCkgewogICAgcmV0dXJuIFtdOwogIH0KICByZXR1cm4gb25seUFsbG93TnVtYmVycyhyZWxldmFudEVycm9yQmFycy5mbGF0TWFwKChlYikgPT4gewogICAgdmFyIGVycm9yVmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZWIuZGF0YUtleSk7CiAgICB2YXIgbG93Qm91bmQsIGhpZ2hCb3VuZDsKICAgIGlmIChBcnJheS5pc0FycmF5KGVycm9yVmFsdWUpKSB7CiAgICAgIFtsb3dCb3VuZCwgaGlnaEJvdW5kXSA9IGVycm9yVmFsdWU7CiAgICB9IGVsc2UgewogICAgICBsb3dCb3VuZCA9IGhpZ2hCb3VuZCA9IGVycm9yVmFsdWU7CiAgICB9CiAgICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIobG93Qm91bmQpIHx8ICFpc1dlbGxCZWhhdmVkTnVtYmVyKGhpZ2hCb3VuZCkpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHJldHVybiBbYXBwbGllZFZhbHVlIC0gbG93Qm91bmQsIGFwcGxpZWRWYWx1ZSArIGhpZ2hCb3VuZF07CiAgfSkpOwp9CnZhciBzZWxlY3RUb29sdGlwQXhpcyA9IChzdGF0ZSkgPT4gewogIHZhciBheGlzVHlwZSA9IHNlbGVjdFRvb2x0aXBBeGlzVHlwZShzdGF0ZSk7CiAgdmFyIGF4aXNJZCA9IHNlbGVjdFRvb2x0aXBBeGlzSWQoc3RhdGUpOwogIHJldHVybiBzZWxlY3RBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNUeXBlLCBheGlzSWQpOwp9Owp2YXIgc2VsZWN0VG9vbHRpcEF4aXNEYXRhS2V5ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzXSwgKGF4aXMpID0+IGF4aXMgPT09IG51bGwgfHwgYXhpcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpcy5kYXRhS2V5KTsKdmFyIHNlbGVjdERpc3BsYXllZFN0YWNrZWREYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFN0YWNrZWRDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzLCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlc0lmTm90SW5QYW5vcmFtYSwgc2VsZWN0VG9vbHRpcEF4aXNdLCBjb21iaW5lRGlzcGxheWVkU3RhY2tlZERhdGEpOwp2YXIgY29tYmluZVN0YWNrR3JvdXBzID0gKGRpc3BsYXllZERhdGEsIGl0ZW1zLCBzdGFja09mZnNldFR5cGUsIHJldmVyc2VTdGFja09yZGVyKSA9PiB7CiAgdmFyIGluaXRpYWxJdGVtc0dyb3VwcyA9IHt9OwogIHZhciBpdGVtc0dyb3VwID0gaXRlbXMucmVkdWNlKChhY2MsIGl0ZW0pID0+IHsKICAgIGlmIChpdGVtLnN0YWNrSWQgPT0gbnVsbCkgewogICAgICByZXR1cm4gYWNjOwogICAgfQogICAgaWYgKGFjY1tpdGVtLnN0YWNrSWRdID09IG51bGwpIHsKICAgICAgYWNjW2l0ZW0uc3RhY2tJZF0gPSBbXTsKICAgIH0KICAgIGFjY1tpdGVtLnN0YWNrSWRdLnB1c2goaXRlbSk7CiAgICByZXR1cm4gYWNjOwogIH0sIGluaXRpYWxJdGVtc0dyb3Vwcyk7CiAgcmV0dXJuIE9iamVjdC5mcm9tRW50cmllcyhPYmplY3QuZW50cmllcyhpdGVtc0dyb3VwKS5tYXAoKF9yZWYyKSA9PiB7CiAgICB2YXIgW3N0YWNrSWQsIGdyYXBoaWNhbEl0ZW1zXSA9IF9yZWYyOwogICAgdmFyIG9yZGVyZWRHcmFwaGljYWxJdGVtcyA9IHJldmVyc2VTdGFja09yZGVyID8gWy4uLmdyYXBoaWNhbEl0ZW1zXS5yZXZlcnNlKCkgOiBncmFwaGljYWxJdGVtczsKICAgIHZhciBkYXRhS2V5cyA9IG9yZGVyZWRHcmFwaGljYWxJdGVtcy5tYXAoZ2V0U3RhY2tTZXJpZXNJZGVudGlmaWVyKTsKICAgIHJldHVybiBbc3RhY2tJZCwgewogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGdldFN0YWNrZWREYXRhIHJlcXVpcmVzIHRoYXQgdGhlIGlucHV0IGlzIGFycmF5IG9mIG9iamVjdHMsIFJlY2hhcnRzIGRvZXMgbm90IHRlc3QgZm9yIHRoYXQKICAgICAgc3RhY2tlZERhdGE6IGdldFN0YWNrZWREYXRhKGRpc3BsYXllZERhdGEsIGRhdGFLZXlzLCBzdGFja09mZnNldFR5cGUpLAogICAgICBncmFwaGljYWxJdGVtczogb3JkZXJlZEdyYXBoaWNhbEl0ZW1zCiAgICB9XTsKICB9KSk7Cn07CnZhciBzZWxlY3RTdGFja0dyb3VwcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3REaXNwbGF5ZWRTdGFja2VkRGF0YSwgc2VsZWN0U3RhY2tlZENhcnRlc2lhbkl0ZW1zU2V0dGluZ3MsIHNlbGVjdFN0YWNrT2Zmc2V0VHlwZSwgc2VsZWN0UmV2ZXJzZVN0YWNrT3JkZXJdLCBjb21iaW5lU3RhY2tHcm91cHMpOwp2YXIgY29tYmluZURvbWFpbk9mU3RhY2tHcm91cHMgPSAoc3RhY2tHcm91cHMsIF9yZWYzLCBheGlzVHlwZSwgZG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlKSA9PiB7CiAgdmFyIHsKICAgIGRhdGFTdGFydEluZGV4LAogICAgZGF0YUVuZEluZGV4CiAgfSA9IF9yZWYzOwogIGlmIChkb21haW5Gcm9tVXNlclByZWZlcmVuY2UgIT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKGF4aXNUeXBlID09PSAiekF4aXMiKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgZG9tYWluT2ZTdGFja0dyb3VwcyA9IGdldERvbWFpbk9mU3RhY2tHcm91cHMoc3RhY2tHcm91cHMsIGRhdGFTdGFydEluZGV4LCBkYXRhRW5kSW5kZXgpOwogIGlmIChkb21haW5PZlN0YWNrR3JvdXBzICE9IG51bGwgJiYgZG9tYWluT2ZTdGFja0dyb3Vwc1swXSA9PT0gMCAmJiBkb21haW5PZlN0YWNrR3JvdXBzWzFdID09PSAwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZG9tYWluT2ZTdGFja0dyb3VwczsKfTsKdmFyIHNlbGVjdEFsbG93c0RhdGFPdmVyZmxvdyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpc10sIChheGlzU2V0dGluZ3MpID0+IGF4aXNTZXR0aW5ncy5hbGxvd0RhdGFPdmVyZmxvdyk7CnZhciBnZXREb21haW5EZWZpbml0aW9uID0gKGF4aXNTZXR0aW5ncykgPT4gewogIHZhciBfYXhpc1NldHRpbmdzJGRvbWFpbjsKICBpZiAoYXhpc1NldHRpbmdzID09IG51bGwgfHwgISgiZG9tYWluIiBpbiBheGlzU2V0dGluZ3MpKSB7CiAgICByZXR1cm4gZGVmYXVsdE51bWVyaWNEb21haW47CiAgfQogIGlmIChheGlzU2V0dGluZ3MuZG9tYWluICE9IG51bGwpIHsKICAgIHJldHVybiBheGlzU2V0dGluZ3MuZG9tYWluOwogIH0KICBpZiAoYXhpc1NldHRpbmdzLnRpY2tzICE9IG51bGwpIHsKICAgIGlmIChheGlzU2V0dGluZ3MudHlwZSA9PT0gIm51bWJlciIpIHsKICAgICAgdmFyIGFsbFZhbHVlcyA9IG9ubHlBbGxvd051bWJlcnMoYXhpc1NldHRpbmdzLnRpY2tzKTsKICAgICAgcmV0dXJuIFtNYXRoLm1pbiguLi5hbGxWYWx1ZXMpLCBNYXRoLm1heCguLi5hbGxWYWx1ZXMpXTsKICAgIH0KICAgIGlmIChheGlzU2V0dGluZ3MudHlwZSA9PT0gImNhdGVnb3J5IikgewogICAgICByZXR1cm4gYXhpc1NldHRpbmdzLnRpY2tzLm1hcChTdHJpbmcpOwogICAgfQogIH0KICByZXR1cm4gKF9heGlzU2V0dGluZ3MkZG9tYWluID0gYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLmRvbWFpbikgIT09IG51bGwgJiYgX2F4aXNTZXR0aW5ncyRkb21haW4gIT09IHZvaWQgMCA/IF9heGlzU2V0dGluZ3MkZG9tYWluIDogZGVmYXVsdE51bWVyaWNEb21haW47Cn07CnZhciBzZWxlY3REb21haW5EZWZpbml0aW9uID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzXSwgZ2V0RG9tYWluRGVmaW5pdGlvbik7CnZhciBzZWxlY3REb21haW5Gcm9tVXNlclByZWZlcmVuY2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RG9tYWluRGVmaW5pdGlvbiwgc2VsZWN0QWxsb3dzRGF0YU92ZXJmbG93XSwgbnVtZXJpY2FsRG9tYWluU3BlY2lmaWVkV2l0aG91dFJlcXVpcmluZ0RhdGEpOwp2YXIgc2VsZWN0RG9tYWluT2ZTdGFja0dyb3VwcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RTdGFja0dyb3Vwcywgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHBpY2tBeGlzVHlwZSwgc2VsZWN0RG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlXSwgY29tYmluZURvbWFpbk9mU3RhY2tHcm91cHMsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjawogIH0KfSk7CnZhciBzZWxlY3RBbGxFcnJvckJhclNldHRpbmdzID0gKHN0YXRlKSA9PiBzdGF0ZS5lcnJvckJhcnM7CnZhciBjb21iaW5lUmVsZXZhbnRFcnJvckJhclNldHRpbmdzID0gKGNhcnRlc2lhbkl0ZW1zU2V0dGluZ3MsIGFsbEVycm9yQmFyU2V0dGluZ3MsIGF4aXNUeXBlKSA9PiB7CiAgcmV0dXJuIGNhcnRlc2lhbkl0ZW1zU2V0dGluZ3MuZmxhdE1hcCgoaXRlbSkgPT4gewogICAgcmV0dXJuIGFsbEVycm9yQmFyU2V0dGluZ3NbaXRlbS5pZF07CiAgfSkuZmlsdGVyKEJvb2xlYW4pLmZpbHRlcigoZSkgPT4gewogICAgcmV0dXJuIGlzRXJyb3JCYXJSZWxldmFudEZvckF4aXNUeXBlKGF4aXNUeXBlLCBlKTsKICB9KTsKfTsKdmFyIG1lcmdlRG9tYWlucyA9IGZ1bmN0aW9uIG1lcmdlRG9tYWluczIoKSB7CiAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGRvbWFpbnMgPSBuZXcgQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICBkb21haW5zW19rZXldID0gYXJndW1lbnRzW19rZXldOwogIH0KICB2YXIgYWxsRG9tYWlucyA9IGRvbWFpbnMuZmlsdGVyKEJvb2xlYW4pOwogIGlmIChhbGxEb21haW5zLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGFsbFZhbHVlcyA9IGFsbERvbWFpbnMuZmxhdCgpOwogIHZhciBtaW4yID0gTWF0aC5taW4oLi4uYWxsVmFsdWVzKTsKICB2YXIgbWF4MiA9IE1hdGgubWF4KC4uLmFsbFZhbHVlcyk7CiAgcmV0dXJuIFttaW4yLCBtYXgyXTsKfTsKdmFyIGNvbWJpbmVEb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlcyA9IChkYXRhLCBheGlzU2V0dGluZ3MsIGl0ZW1zLCBlcnJvckJhcnMsIGF4aXNUeXBlKSA9PiB7CiAgdmFyIGxvd2VyRW5kLCB1cHBlckVuZDsKICBpZiAoaXRlbXMubGVuZ3RoID4gMCkgewogICAgZGF0YS5mb3JFYWNoKChlbnRyeSkgPT4gewogICAgICBpdGVtcy5mb3JFYWNoKChpdGVtKSA9PiB7CiAgICAgICAgdmFyIF9lcnJvckJhcnMkaXRlbSRpZCwgX2F4aXNTZXR0aW5ncyRkYXRhS2V5OwogICAgICAgIHZhciByZWxldmFudEVycm9yQmFycyA9IChfZXJyb3JCYXJzJGl0ZW0kaWQgPSBlcnJvckJhcnNbaXRlbS5pZF0pID09PSBudWxsIHx8IF9lcnJvckJhcnMkaXRlbSRpZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Vycm9yQmFycyRpdGVtJGlkLmZpbHRlcigoZXJyb3JCYXIpID0+IGlzRXJyb3JCYXJSZWxldmFudEZvckF4aXNUeXBlKGF4aXNUeXBlLCBlcnJvckJhcikpOwogICAgICAgIHZhciB2YWx1ZUJ5RGF0YUtleSA9IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCAoX2F4aXNTZXR0aW5ncyRkYXRhS2V5ID0gYXhpc1NldHRpbmdzLmRhdGFLZXkpICE9PSBudWxsICYmIF9heGlzU2V0dGluZ3MkZGF0YUtleSAhPT0gdm9pZCAwID8gX2F4aXNTZXR0aW5ncyRkYXRhS2V5IDogaXRlbS5kYXRhS2V5KTsKICAgICAgICB2YXIgZXJyb3JEb21haW4gPSBnZXRFcnJvckRvbWFpbkJ5RGF0YUtleShlbnRyeSwgdmFsdWVCeURhdGFLZXksIHJlbGV2YW50RXJyb3JCYXJzKTsKICAgICAgICBpZiAoZXJyb3JEb21haW4ubGVuZ3RoID49IDIpIHsKICAgICAgICAgIHZhciBsb2NhbExvd2VyID0gTWF0aC5taW4oLi4uZXJyb3JEb21haW4pOwogICAgICAgICAgdmFyIGxvY2FsVXBwZXIgPSBNYXRoLm1heCguLi5lcnJvckRvbWFpbik7CiAgICAgICAgICBpZiAobG93ZXJFbmQgPT0gbnVsbCB8fCBsb2NhbExvd2VyIDwgbG93ZXJFbmQpIHsKICAgICAgICAgICAgbG93ZXJFbmQgPSBsb2NhbExvd2VyOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHVwcGVyRW5kID09IG51bGwgfHwgbG9jYWxVcHBlciA+IHVwcGVyRW5kKSB7CiAgICAgICAgICAgIHVwcGVyRW5kID0gbG9jYWxVcHBlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRhdGFWYWx1ZURvbWFpbiA9IG1ha2VEb21haW4odmFsdWVCeURhdGFLZXkpOwogICAgICAgIGlmIChkYXRhVmFsdWVEb21haW4gIT0gbnVsbCkgewogICAgICAgICAgbG93ZXJFbmQgPSBsb3dlckVuZCA9PSBudWxsID8gZGF0YVZhbHVlRG9tYWluWzBdIDogTWF0aC5taW4obG93ZXJFbmQsIGRhdGFWYWx1ZURvbWFpblswXSk7CiAgICAgICAgICB1cHBlckVuZCA9IHVwcGVyRW5kID09IG51bGwgPyBkYXRhVmFsdWVEb21haW5bMV0gOiBNYXRoLm1heCh1cHBlckVuZCwgZGF0YVZhbHVlRG9tYWluWzFdKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfQogIGlmICgoYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLmRhdGFLZXkpICE9IG51bGwpIHsKICAgIGRhdGEuZm9yRWFjaCgoaXRlbSkgPT4gewogICAgICB2YXIgZGF0YVZhbHVlRG9tYWluID0gbWFrZURvbWFpbihnZXRWYWx1ZUJ5RGF0YUtleShpdGVtLCBheGlzU2V0dGluZ3MuZGF0YUtleSkpOwogICAgICBpZiAoZGF0YVZhbHVlRG9tYWluICE9IG51bGwpIHsKICAgICAgICBsb3dlckVuZCA9IGxvd2VyRW5kID09IG51bGwgPyBkYXRhVmFsdWVEb21haW5bMF0gOiBNYXRoLm1pbihsb3dlckVuZCwgZGF0YVZhbHVlRG9tYWluWzBdKTsKICAgICAgICB1cHBlckVuZCA9IHVwcGVyRW5kID09IG51bGwgPyBkYXRhVmFsdWVEb21haW5bMV0gOiBNYXRoLm1heCh1cHBlckVuZCwgZGF0YVZhbHVlRG9tYWluWzFdKTsKICAgICAgfQogICAgfSk7CiAgfQogIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKGxvd2VyRW5kKSAmJiBpc1dlbGxCZWhhdmVkTnVtYmVyKHVwcGVyRW5kKSkgewogICAgcmV0dXJuIFtsb3dlckVuZCwgdXBwZXJFbmRdOwogIH0KICByZXR1cm4gdm9pZCAwOwp9Owp2YXIgc2VsZWN0RG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RGlzcGxheWVkRGF0YSwgc2VsZWN0QmFzZUF4aXMsIHNlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3NFeGNlcHRTdGFja2VkLCBzZWxlY3RBbGxFcnJvckJhclNldHRpbmdzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lRG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjawogIH0KfSk7CmZ1bmN0aW9uIG9ubHlBbGxvd051bWJlcnNBbmRTdHJpbmdzQW5kRGF0ZXMoaXRlbSkgewogIHZhciB7CiAgICB2YWx1ZQogIH0gPSBpdGVtOwogIGlmIChpc051bU9yU3RyKHZhbHVlKSB8fCB2YWx1ZSBpbnN0YW5jZW9mIERhdGUpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQp2YXIgY29tcHV0ZURvbWFpbk9mVHlwZUNhdGVnb3J5ID0gKGFsbERhdGFTcXVpc2hlZCwgYXhpc1NldHRpbmdzLCBpc0NhdGVnb3JpY2FsKSA9PiB7CiAgdmFyIGNhdGVnb3JpY2FsRG9tYWluID0gYWxsRGF0YVNxdWlzaGVkLm1hcChvbmx5QWxsb3dOdW1iZXJzQW5kU3RyaW5nc0FuZERhdGVzKS5maWx0ZXIoKHYpID0+IHYgIT0gbnVsbCk7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgKGF4aXNTZXR0aW5ncy5kYXRhS2V5ID09IG51bGwgfHwgYXhpc1NldHRpbmdzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5ICYmIGhhc0R1cGxpY2F0ZShjYXRlZ29yaWNhbERvbWFpbikpKSB7CiAgICByZXR1cm4gKDAsIGltcG9ydF9yYW5nZTIuZGVmYXVsdCkoMCwgYWxsRGF0YVNxdWlzaGVkLmxlbmd0aCk7CiAgfQogIGlmIChheGlzU2V0dGluZ3MuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkpIHsKICAgIHJldHVybiBjYXRlZ29yaWNhbERvbWFpbjsKICB9CiAgcmV0dXJuIEFycmF5LmZyb20obmV3IFNldChjYXRlZ29yaWNhbERvbWFpbikpOwp9Owp2YXIgc2VsZWN0UmVmZXJlbmNlRG90cyA9IChzdGF0ZSkgPT4gc3RhdGUucmVmZXJlbmNlRWxlbWVudHMuZG90czsKdmFyIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzID0gKGVsZW1lbnRzLCBheGlzVHlwZSwgYXhpc0lkKSA9PiB7CiAgcmV0dXJuIGVsZW1lbnRzLmZpbHRlcigoZWwpID0+IGVsLmlmT3ZlcmZsb3cgPT09ICJleHRlbmREb21haW4iKS5maWx0ZXIoKGVsKSA9PiB7CiAgICBpZiAoYXhpc1R5cGUgPT09ICJ4QXhpcyIpIHsKICAgICAgcmV0dXJuIGVsLnhBeGlzSWQgPT09IGF4aXNJZDsKICAgIH0KICAgIHJldHVybiBlbC55QXhpc0lkID09PSBheGlzSWQ7CiAgfSk7Cn07CnZhciBzZWxlY3RSZWZlcmVuY2VEb3RzQnlBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZURvdHMsIHBpY2tBeGlzVHlwZSwgcGlja0F4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFJlZmVyZW5jZUFyZWFzID0gKHN0YXRlKSA9PiBzdGF0ZS5yZWZlcmVuY2VFbGVtZW50cy5hcmVhczsKdmFyIHNlbGVjdFJlZmVyZW5jZUFyZWFzQnlBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUFyZWFzLCBwaWNrQXhpc1R5cGUsIHBpY2tBeGlzSWRdLCBmaWx0ZXJSZWZlcmVuY2VFbGVtZW50cyk7CnZhciBzZWxlY3RSZWZlcmVuY2VMaW5lcyA9IChzdGF0ZSkgPT4gc3RhdGUucmVmZXJlbmNlRWxlbWVudHMubGluZXM7CnZhciBzZWxlY3RSZWZlcmVuY2VMaW5lc0J5QXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VMaW5lcywgcGlja0F4aXNUeXBlLCBwaWNrQXhpc0lkXSwgZmlsdGVyUmVmZXJlbmNlRWxlbWVudHMpOwp2YXIgY29tYmluZURvdHNEb21haW4gPSAoZG90cywgYXhpc1R5cGUpID0+IHsKICB2YXIgYWxsQ29vcmRzID0gb25seUFsbG93TnVtYmVycyhkb3RzLm1hcCgoZG90KSA9PiBheGlzVHlwZSA9PT0gInhBeGlzIiA/IGRvdC54IDogZG90LnkpKTsKICBpZiAoYWxsQ29vcmRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtNYXRoLm1pbiguLi5hbGxDb29yZHMpLCBNYXRoLm1heCguLi5hbGxDb29yZHMpXTsKfTsKdmFyIHNlbGVjdFJlZmVyZW5jZURvdHNEb21haW4gPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RSZWZlcmVuY2VEb3RzQnlBeGlzLCBwaWNrQXhpc1R5cGUsIGNvbWJpbmVEb3RzRG9tYWluKTsKdmFyIGNvbWJpbmVBcmVhc0RvbWFpbiA9IChhcmVhcywgYXhpc1R5cGUpID0+IHsKICB2YXIgYWxsQ29vcmRzID0gb25seUFsbG93TnVtYmVycyhhcmVhcy5mbGF0TWFwKChhcmVhKSA9PiBbYXhpc1R5cGUgPT09ICJ4QXhpcyIgPyBhcmVhLngxIDogYXJlYS55MSwgYXhpc1R5cGUgPT09ICJ4QXhpcyIgPyBhcmVhLngyIDogYXJlYS55Ml0pKTsKICBpZiAoYWxsQ29vcmRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtNYXRoLm1pbiguLi5hbGxDb29yZHMpLCBNYXRoLm1heCguLi5hbGxDb29yZHMpXTsKfTsKdmFyIHNlbGVjdFJlZmVyZW5jZUFyZWFzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUFyZWFzQnlBeGlzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQXJlYXNEb21haW4pOwpmdW5jdGlvbiBleHRyYWN0WENvb3JkaW5hdGVzKGxpbmUpIHsKICB2YXIgX2xpbmUkc2VnbWVudDsKICBpZiAobGluZS54ICE9IG51bGwpIHsKICAgIHJldHVybiBvbmx5QWxsb3dOdW1iZXJzKFtsaW5lLnhdKTsKICB9CiAgdmFyIHNlZ21lbnRDb29yZGluYXRlcyA9IChfbGluZSRzZWdtZW50ID0gbGluZS5zZWdtZW50KSA9PT0gbnVsbCB8fCBfbGluZSRzZWdtZW50ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfbGluZSRzZWdtZW50Lm1hcCgocykgPT4gcy54KTsKICBpZiAoc2VnbWVudENvb3JkaW5hdGVzID09IG51bGwgfHwgc2VnbWVudENvb3JkaW5hdGVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIFtdOwogIH0KICByZXR1cm4gb25seUFsbG93TnVtYmVycyhzZWdtZW50Q29vcmRpbmF0ZXMpOwp9CmZ1bmN0aW9uIGV4dHJhY3RZQ29vcmRpbmF0ZXMobGluZSkgewogIHZhciBfbGluZSRzZWdtZW50MjsKICBpZiAobGluZS55ICE9IG51bGwpIHsKICAgIHJldHVybiBvbmx5QWxsb3dOdW1iZXJzKFtsaW5lLnldKTsKICB9CiAgdmFyIHNlZ21lbnRDb29yZGluYXRlcyA9IChfbGluZSRzZWdtZW50MiA9IGxpbmUuc2VnbWVudCkgPT09IG51bGwgfHwgX2xpbmUkc2VnbWVudDIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9saW5lJHNlZ21lbnQyLm1hcCgocykgPT4gcy55KTsKICBpZiAoc2VnbWVudENvb3JkaW5hdGVzID09IG51bGwgfHwgc2VnbWVudENvb3JkaW5hdGVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIFtdOwogIH0KICByZXR1cm4gb25seUFsbG93TnVtYmVycyhzZWdtZW50Q29vcmRpbmF0ZXMpOwp9CnZhciBjb21iaW5lTGluZXNEb21haW4gPSAobGluZXMsIGF4aXNUeXBlKSA9PiB7CiAgdmFyIGFsbENvb3JkcyA9IGxpbmVzLmZsYXRNYXAoKGxpbmUpID0+IGF4aXNUeXBlID09PSAieEF4aXMiID8gZXh0cmFjdFhDb29yZGluYXRlcyhsaW5lKSA6IGV4dHJhY3RZQ29vcmRpbmF0ZXMobGluZSkpOwogIGlmIChhbGxDb29yZHMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gW01hdGgubWluKC4uLmFsbENvb3JkcyksIE1hdGgubWF4KC4uLmFsbENvb3JkcyldOwp9Owp2YXIgc2VsZWN0UmVmZXJlbmNlTGluZXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlTGluZXNCeUF4aXMsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVMaW5lc0RvbWFpbik7CnZhciBzZWxlY3RSZWZlcmVuY2VFbGVtZW50c0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFJlZmVyZW5jZURvdHNEb21haW4sIHNlbGVjdFJlZmVyZW5jZUxpbmVzRG9tYWluLCBzZWxlY3RSZWZlcmVuY2VBcmVhc0RvbWFpbiwgKGRvdHNEb21haW4sIGxpbmVzRG9tYWluLCBhcmVhc0RvbWFpbikgPT4gewogIHJldHVybiBtZXJnZURvbWFpbnMoZG90c0RvbWFpbiwgYXJlYXNEb21haW4sIGxpbmVzRG9tYWluKTsKfSk7CnZhciBjb21iaW5lTnVtZXJpY2FsRG9tYWluID0gKGF4aXNTZXR0aW5ncywgZG9tYWluRGVmaW5pdGlvbiwgZG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlLCBkb21haW5PZlN0YWNrR3JvdXBzLCBkYXRhQW5kRXJyb3JCYXJzRG9tYWluLCByZWZlcmVuY2VFbGVtZW50c0RvbWFpbiwgbGF5b3V0LCBheGlzVHlwZSkgPT4gewogIGlmIChkb21haW5Gcm9tVXNlclByZWZlcmVuY2UgIT0gbnVsbCkgewogICAgcmV0dXJuIGRvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZTsKICB9CiAgdmFyIHNob3VsZEluY2x1ZGVEb21haW5PZlN0YWNrR3JvdXBzID0gbGF5b3V0ID09PSAidmVydGljYWwiICYmIGF4aXNUeXBlID09PSAieEF4aXMiIHx8IGxheW91dCA9PT0gImhvcml6b250YWwiICYmIGF4aXNUeXBlID09PSAieUF4aXMiOwogIHZhciBtZXJnZWREb21haW5zID0gc2hvdWxkSW5jbHVkZURvbWFpbk9mU3RhY2tHcm91cHMgPyBtZXJnZURvbWFpbnMoZG9tYWluT2ZTdGFja0dyb3VwcywgcmVmZXJlbmNlRWxlbWVudHNEb21haW4sIGRhdGFBbmRFcnJvckJhcnNEb21haW4pIDogbWVyZ2VEb21haW5zKHJlZmVyZW5jZUVsZW1lbnRzRG9tYWluLCBkYXRhQW5kRXJyb3JCYXJzRG9tYWluKTsKICByZXR1cm4gcGFyc2VOdW1lcmljYWxVc2VyRG9tYWluKGRvbWFpbkRlZmluaXRpb24sIG1lcmdlZERvbWFpbnMsIGF4aXNTZXR0aW5ncy5hbGxvd0RhdGFPdmVyZmxvdyk7Cn07CnZhciBzZWxlY3ROdW1lcmljYWxEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdERvbWFpbkRlZmluaXRpb24sIHNlbGVjdERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZSwgc2VsZWN0RG9tYWluT2ZTdGFja0dyb3Vwcywgc2VsZWN0RG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMsIHNlbGVjdFJlZmVyZW5jZUVsZW1lbnRzRG9tYWluLCBzZWxlY3RDaGFydExheW91dCwgcGlja0F4aXNUeXBlXSwgY29tYmluZU51bWVyaWNhbERvbWFpbiwgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBudW1iZXJEb21haW5FcXVhbGl0eUNoZWNrCiAgfQp9KTsKdmFyIGV4cGFuZERvbWFpbiA9IFswLCAxXTsKdmFyIGNvbWJpbmVBeGlzRG9tYWluID0gKGF4aXNTZXR0aW5ncywgbGF5b3V0LCBkaXNwbGF5ZWREYXRhLCBhbGxBcHBsaWVkVmFsdWVzLCBzdGFja09mZnNldFR5cGUsIGF4aXNUeXBlLCBudW1lcmljYWxEb21haW4pID0+IHsKICBpZiAoKGF4aXNTZXR0aW5ncyA9PSBudWxsIHx8IGRpc3BsYXllZERhdGEgPT0gbnVsbCB8fCBkaXNwbGF5ZWREYXRhLmxlbmd0aCA9PT0gMCkgJiYgbnVtZXJpY2FsRG9tYWluID09PSB2b2lkIDApIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBkYXRhS2V5LAogICAgdHlwZQogIH0gPSBheGlzU2V0dGluZ3M7CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICBpZiAoaXNDYXRlZ29yaWNhbCAmJiBkYXRhS2V5ID09IG51bGwpIHsKICAgIHZhciBfZGlzcGxheWVkRGF0YSRsZW5ndGg7CiAgICByZXR1cm4gKDAsIGltcG9ydF9yYW5nZTIuZGVmYXVsdCkoMCwgKF9kaXNwbGF5ZWREYXRhJGxlbmd0aCA9IGRpc3BsYXllZERhdGEgPT09IG51bGwgfHwgZGlzcGxheWVkRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGlzcGxheWVkRGF0YS5sZW5ndGgpICE9PSBudWxsICYmIF9kaXNwbGF5ZWREYXRhJGxlbmd0aCAhPT0gdm9pZCAwID8gX2Rpc3BsYXllZERhdGEkbGVuZ3RoIDogMCk7CiAgfQogIGlmICh0eXBlID09PSAiY2F0ZWdvcnkiKSB7CiAgICByZXR1cm4gY29tcHV0ZURvbWFpbk9mVHlwZUNhdGVnb3J5KGFsbEFwcGxpZWRWYWx1ZXMsIGF4aXNTZXR0aW5ncywgaXNDYXRlZ29yaWNhbCk7CiAgfQogIGlmIChzdGFja09mZnNldFR5cGUgPT09ICJleHBhbmQiKSB7CiAgICByZXR1cm4gZXhwYW5kRG9tYWluOwogIH0KICByZXR1cm4gbnVtZXJpY2FsRG9tYWluOwp9Owp2YXIgc2VsZWN0QXhpc0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdERpc3BsYXllZERhdGEsIHNlbGVjdEFsbEFwcGxpZWRWYWx1ZXMsIHNlbGVjdFN0YWNrT2Zmc2V0VHlwZSwgcGlja0F4aXNUeXBlLCBzZWxlY3ROdW1lcmljYWxEb21haW5dLCBjb21iaW5lQXhpc0RvbWFpbik7CnZhciBjb21iaW5lUmVhbFNjYWxlVHlwZSA9IChheGlzQ29uZmlnLCBsYXlvdXQsIGhhc0JhciwgY2hhcnRUeXBlLCBheGlzVHlwZSkgPT4gewogIGlmIChheGlzQ29uZmlnID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBzY2FsZSwKICAgIHR5cGUKICB9ID0gYXhpc0NvbmZpZzsKICBpZiAoc2NhbGUgPT09ICJhdXRvIikgewogICAgaWYgKGxheW91dCA9PT0gInJhZGlhbCIgJiYgYXhpc1R5cGUgPT09ICJyYWRpdXNBeGlzIikgewogICAgICByZXR1cm4gImJhbmQiOwogICAgfQogICAgaWYgKGxheW91dCA9PT0gInJhZGlhbCIgJiYgYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiKSB7CiAgICAgIHJldHVybiAibGluZWFyIjsKICAgIH0KICAgIGlmICh0eXBlID09PSAiY2F0ZWdvcnkiICYmIGNoYXJ0VHlwZSAmJiAoY2hhcnRUeXBlLmluZGV4T2YoIkxpbmVDaGFydCIpID49IDAgfHwgY2hhcnRUeXBlLmluZGV4T2YoIkFyZWFDaGFydCIpID49IDAgfHwgY2hhcnRUeXBlLmluZGV4T2YoIkNvbXBvc2VkQ2hhcnQiKSA+PSAwICYmICFoYXNCYXIpKSB7CiAgICAgIHJldHVybiAicG9pbnQiOwogICAgfQogICAgaWYgKHR5cGUgPT09ICJjYXRlZ29yeSIpIHsKICAgICAgcmV0dXJuICJiYW5kIjsKICAgIH0KICAgIHJldHVybiAibGluZWFyIjsKICB9CiAgaWYgKHR5cGVvZiBzY2FsZSA9PT0gInN0cmluZyIpIHsKICAgIHZhciBuYW1lID0gInNjYWxlIi5jb25jYXQodXBwZXJGaXJzdChzY2FsZSkpOwogICAgcmV0dXJuIG5hbWUgaW4gZDNfc2NhbGVfZXhwb3J0cyA/IG5hbWUgOiAicG9pbnQiOwogIH0KICByZXR1cm4gdm9pZCAwOwp9Owp2YXIgc2VsZWN0UmVhbFNjYWxlVHlwZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEhhc0Jhciwgc2VsZWN0Q2hhcnROYW1lLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lUmVhbFNjYWxlVHlwZSk7CmZ1bmN0aW9uIGdldEQzU2NhbGVGcm9tVHlwZShyZWFsU2NhbGVUeXBlKSB7CiAgaWYgKHJlYWxTY2FsZVR5cGUgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKHJlYWxTY2FsZVR5cGUgaW4gZDNfc2NhbGVfZXhwb3J0cykgewogICAgcmV0dXJuIGQzX3NjYWxlX2V4cG9ydHNbcmVhbFNjYWxlVHlwZV0oKTsKICB9CiAgdmFyIG5hbWUgPSAic2NhbGUiLmNvbmNhdCh1cHBlckZpcnN0KHJlYWxTY2FsZVR5cGUpKTsKICBpZiAobmFtZSBpbiBkM19zY2FsZV9leHBvcnRzKSB7CiAgICByZXR1cm4gZDNfc2NhbGVfZXhwb3J0c1tuYW1lXSgpOwogIH0KICByZXR1cm4gdm9pZCAwOwp9CmZ1bmN0aW9uIGNvbWJpbmVTY2FsZUZ1bmN0aW9uKGF4aXMsIHJlYWxTY2FsZVR5cGUsIGF4aXNEb21haW4sIGF4aXNSYW5nZSkgewogIGlmIChheGlzRG9tYWluID09IG51bGwgfHwgYXhpc1JhbmdlID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmICh0eXBlb2YgYXhpcy5zY2FsZSA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIGF4aXMuc2NhbGUuY29weSgpLmRvbWFpbihheGlzRG9tYWluKS5yYW5nZShheGlzUmFuZ2UpOwogIH0KICB2YXIgZDNTY2FsZUZ1bmN0aW9uID0gZ2V0RDNTY2FsZUZyb21UeXBlKHJlYWxTY2FsZVR5cGUpOwogIGlmIChkM1NjYWxlRnVuY3Rpb24gPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHNjYWxlID0gZDNTY2FsZUZ1bmN0aW9uLmRvbWFpbihheGlzRG9tYWluKS5yYW5nZShheGlzUmFuZ2UpOwogIGNoZWNrRG9tYWluT2ZTY2FsZShzY2FsZSk7CiAgcmV0dXJuIHNjYWxlOwp9CnZhciBjb21iaW5lTmljZVRpY2tzID0gKGF4aXNEb21haW4sIGF4aXNTZXR0aW5ncywgcmVhbFNjYWxlVHlwZSkgPT4gewogIHZhciBkb21haW5EZWZpbml0aW9uID0gZ2V0RG9tYWluRGVmaW5pdGlvbihheGlzU2V0dGluZ3MpOwogIGlmIChyZWFsU2NhbGVUeXBlICE9PSAiYXV0byIgJiYgcmVhbFNjYWxlVHlwZSAhPT0gImxpbmVhciIpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChheGlzU2V0dGluZ3MgIT0gbnVsbCAmJiBheGlzU2V0dGluZ3MudGlja0NvdW50ICYmIEFycmF5LmlzQXJyYXkoZG9tYWluRGVmaW5pdGlvbikgJiYgKGRvbWFpbkRlZmluaXRpb25bMF0gPT09ICJhdXRvIiB8fCBkb21haW5EZWZpbml0aW9uWzFdID09PSAiYXV0byIpICYmIGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbihheGlzRG9tYWluKSkgewogICAgcmV0dXJuIGdldE5pY2VUaWNrVmFsdWVzKGF4aXNEb21haW4sIGF4aXNTZXR0aW5ncy50aWNrQ291bnQsIGF4aXNTZXR0aW5ncy5hbGxvd0RlY2ltYWxzKTsKICB9CiAgaWYgKGF4aXNTZXR0aW5ncyAhPSBudWxsICYmIGF4aXNTZXR0aW5ncy50aWNrQ291bnQgJiYgYXhpc1NldHRpbmdzLnR5cGUgPT09ICJudW1iZXIiICYmIGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbihheGlzRG9tYWluKSkgewogICAgcmV0dXJuIGdldFRpY2tWYWx1ZXNGaXhlZERvbWFpbihheGlzRG9tYWluLCBheGlzU2V0dGluZ3MudGlja0NvdW50LCBheGlzU2V0dGluZ3MuYWxsb3dEZWNpbWFscyk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciBzZWxlY3ROaWNlVGlja3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QXhpc0RvbWFpbiwgc2VsZWN0QXhpc1NldHRpbmdzLCBzZWxlY3RSZWFsU2NhbGVUeXBlXSwgY29tYmluZU5pY2VUaWNrcyk7CnZhciBjb21iaW5lQXhpc0RvbWFpbldpdGhOaWNlVGlja3MgPSAoYXhpc1NldHRpbmdzLCBkb21haW4sIG5pY2VUaWNrcywgYXhpc1R5cGUpID0+IHsKICBpZiAoCiAgICAvKgogICAgICogQW5nbGUgYXhpcyBmb3Igc29tZSByZWFzb24gdXNlcyBuaWNlIHRpY2tzIHdoZW4gcmVuZGVyaW5nIGF4aXMgdGljayBsYWJlbHMsCiAgICAgKiBidXQgZG9lc24ndCB1c2UgbmljZSB0aWNrcyBmb3IgZXh0ZW5kaW5nIGRvbWFpbiBsaWtlIGFsbCB0aGUgb3RoZXIgYXhlcyBkby4KICAgICAqIE5vdCByZWFsbHkgc3VyZSB3aHk/IElzIHRoZXJlIGEgZ29vZCByZWFzb24sCiAgICAgKiBvciBpcyBpdCBqdXN0IGJlY2F1c2Ugc29tZW9uZSBhZGRlZCBzdXBwb3J0IGZvciBuaWNlIHRpY2tzIHRvIHRoZSBvdGhlciBheGVzIGFuZCBmb3Jnb3QgdGhpcyBvbmU/CiAgICAgKi8KICAgIGF4aXNUeXBlICE9PSAiYW5nbGVBeGlzIiAmJiAoYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLnR5cGUpID09PSAibnVtYmVyIiAmJiBpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oZG9tYWluKSAmJiBBcnJheS5pc0FycmF5KG5pY2VUaWNrcykgJiYgbmljZVRpY2tzLmxlbmd0aCA+IDAKICApIHsKICAgIHZhciBtaW5Gcm9tRG9tYWluID0gZG9tYWluWzBdOwogICAgdmFyIG1pbkZyb21UaWNrcyA9IG5pY2VUaWNrc1swXTsKICAgIHZhciBtYXhGcm9tRG9tYWluID0gZG9tYWluWzFdOwogICAgdmFyIG1heEZyb21UaWNrcyA9IG5pY2VUaWNrc1tuaWNlVGlja3MubGVuZ3RoIC0gMV07CiAgICByZXR1cm4gW01hdGgubWluKG1pbkZyb21Eb21haW4sIG1pbkZyb21UaWNrcyksIE1hdGgubWF4KG1heEZyb21Eb21haW4sIG1heEZyb21UaWNrcyldOwogIH0KICByZXR1cm4gZG9tYWluOwp9Owp2YXIgc2VsZWN0QXhpc0RvbWFpbkluY2x1ZGluZ05pY2VUaWNrcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0QXhpc0RvbWFpbiwgc2VsZWN0TmljZVRpY2tzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQXhpc0RvbWFpbldpdGhOaWNlVGlja3MpOwp2YXIgc2VsZWN0U21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RBbGxBcHBsaWVkVmFsdWVzLCBzZWxlY3RCYXNlQXhpcywgKGFsbERhdGFTcXVpc2hlZCwgYXhpc1NldHRpbmdzKSA9PiB7CiAgaWYgKCFheGlzU2V0dGluZ3MgfHwgYXhpc1NldHRpbmdzLnR5cGUgIT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgc21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMgPSBJbmZpbml0eTsKICB2YXIgc29ydGVkVmFsdWVzID0gQXJyYXkuZnJvbShvbmx5QWxsb3dOdW1iZXJzKGFsbERhdGFTcXVpc2hlZC5tYXAoKGQpID0+IGQudmFsdWUpKSkuc29ydCgoYSwgYikgPT4gYSAtIGIpOwogIGlmIChzb3J0ZWRWYWx1ZXMubGVuZ3RoIDwgMikgewogICAgcmV0dXJuIEluZmluaXR5OwogIH0KICB2YXIgZGlmZiA9IHNvcnRlZFZhbHVlc1tzb3J0ZWRWYWx1ZXMubGVuZ3RoIC0gMV0gLSBzb3J0ZWRWYWx1ZXNbMF07CiAgaWYgKGRpZmYgPT09IDApIHsKICAgIHJldHVybiBJbmZpbml0eTsKICB9CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0ZWRWYWx1ZXMubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICB2YXIgZGlzdGFuY2UgPSBzb3J0ZWRWYWx1ZXNbaSArIDFdIC0gc29ydGVkVmFsdWVzW2ldOwogICAgc21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMgPSBNYXRoLm1pbihzbWFsbGVzdERpc3RhbmNlQmV0d2VlblZhbHVlcywgZGlzdGFuY2UpOwogIH0KICByZXR1cm4gc21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMgLyBkaWZmOwp9KTsKdmFyIHNlbGVjdENhbGN1bGF0ZWRQYWRkaW5nID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0U21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RCYXJDYXRlZ29yeUdhcCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgKF8xLCBfMiwgXzMsIHBhZGRpbmcpID0+IHBhZGRpbmcsIChzbWFsbGVzdERpc3RhbmNlSW5QZXJjZW50LCBsYXlvdXQsIGJhckNhdGVnb3J5R2FwLCBvZmZzZXQsIHBhZGRpbmcpID0+IHsKICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIoc21hbGxlc3REaXN0YW5jZUluUGVyY2VudCkpIHsKICAgIHJldHVybiAwOwogIH0KICB2YXIgcmFuZ2VXaWR0aCA9IGxheW91dCA9PT0gInZlcnRpY2FsIiA/IG9mZnNldC5oZWlnaHQgOiBvZmZzZXQud2lkdGg7CiAgaWYgKHBhZGRpbmcgPT09ICJnYXAiKSB7CiAgICByZXR1cm4gc21hbGxlc3REaXN0YW5jZUluUGVyY2VudCAqIHJhbmdlV2lkdGggLyAyOwogIH0KICBpZiAocGFkZGluZyA9PT0gIm5vLWdhcCIpIHsKICAgIHZhciBnYXAgPSBnZXRQZXJjZW50VmFsdWUoYmFyQ2F0ZWdvcnlHYXAsIHNtYWxsZXN0RGlzdGFuY2VJblBlcmNlbnQgKiByYW5nZVdpZHRoKTsKICAgIHZhciBoYWxmQmFuZCA9IHNtYWxsZXN0RGlzdGFuY2VJblBlcmNlbnQgKiByYW5nZVdpZHRoIC8gMjsKICAgIHJldHVybiBoYWxmQmFuZCAtIGdhcCAtIChoYWxmQmFuZCAtIGdhcCkgLyByYW5nZVdpZHRoICogZ2FwOwogIH0KICByZXR1cm4gMDsKfSk7CnZhciBzZWxlY3RDYWxjdWxhdGVkWEF4aXNQYWRkaW5nID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICB2YXIgeEF4aXNTZXR0aW5ncyA9IHNlbGVjdFhBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgaWYgKHhBeGlzU2V0dGluZ3MgPT0gbnVsbCB8fCB0eXBlb2YgeEF4aXNTZXR0aW5ncy5wYWRkaW5nICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIDA7CiAgfQogIHJldHVybiBzZWxlY3RDYWxjdWxhdGVkUGFkZGluZyhzdGF0ZSwgInhBeGlzIiwgYXhpc0lkLCB4QXhpc1NldHRpbmdzLnBhZGRpbmcpOwp9Owp2YXIgc2VsZWN0Q2FsY3VsYXRlZFlBeGlzUGFkZGluZyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIHlBeGlzU2V0dGluZ3MgPSBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogIGlmICh5QXhpc1NldHRpbmdzID09IG51bGwgfHwgdHlwZW9mIHlBeGlzU2V0dGluZ3MucGFkZGluZyAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiAwOwogIH0KICByZXR1cm4gc2VsZWN0Q2FsY3VsYXRlZFBhZGRpbmcoc3RhdGUsICJ5QXhpcyIsIGF4aXNJZCwgeUF4aXNTZXR0aW5ncy5wYWRkaW5nKTsKfTsKdmFyIHNlbGVjdFhBeGlzUGFkZGluZyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFhBeGlzU2V0dGluZ3MsIHNlbGVjdENhbGN1bGF0ZWRYQXhpc1BhZGRpbmcsICh4QXhpc1NldHRpbmdzLCBjYWxjdWxhdGVkKSA9PiB7CiAgdmFyIF9wYWRkaW5nJGxlZnQsIF9wYWRkaW5nJHJpZ2h0OwogIGlmICh4QXhpc1NldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB7CiAgICAgIGxlZnQ6IDAsCiAgICAgIHJpZ2h0OiAwCiAgICB9OwogIH0KICB2YXIgewogICAgcGFkZGluZwogIH0gPSB4QXhpc1NldHRpbmdzOwogIGlmICh0eXBlb2YgcGFkZGluZyA9PT0gInN0cmluZyIpIHsKICAgIHJldHVybiB7CiAgICAgIGxlZnQ6IGNhbGN1bGF0ZWQsCiAgICAgIHJpZ2h0OiBjYWxjdWxhdGVkCiAgICB9OwogIH0KICByZXR1cm4gewogICAgbGVmdDogKChfcGFkZGluZyRsZWZ0ID0gcGFkZGluZy5sZWZ0KSAhPT0gbnVsbCAmJiBfcGFkZGluZyRsZWZ0ICE9PSB2b2lkIDAgPyBfcGFkZGluZyRsZWZ0IDogMCkgKyBjYWxjdWxhdGVkLAogICAgcmlnaHQ6ICgoX3BhZGRpbmckcmlnaHQgPSBwYWRkaW5nLnJpZ2h0KSAhPT0gbnVsbCAmJiBfcGFkZGluZyRyaWdodCAhPT0gdm9pZCAwID8gX3BhZGRpbmckcmlnaHQgOiAwKSArIGNhbGN1bGF0ZWQKICB9Owp9KTsKdmFyIHNlbGVjdFlBeGlzUGFkZGluZyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFlBeGlzU2V0dGluZ3MsIHNlbGVjdENhbGN1bGF0ZWRZQXhpc1BhZGRpbmcsICh5QXhpc1NldHRpbmdzLCBjYWxjdWxhdGVkKSA9PiB7CiAgdmFyIF9wYWRkaW5nJHRvcCwgX3BhZGRpbmckYm90dG9tOwogIGlmICh5QXhpc1NldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB7CiAgICAgIHRvcDogMCwKICAgICAgYm90dG9tOiAwCiAgICB9OwogIH0KICB2YXIgewogICAgcGFkZGluZwogIH0gPSB5QXhpc1NldHRpbmdzOwogIGlmICh0eXBlb2YgcGFkZGluZyA9PT0gInN0cmluZyIpIHsKICAgIHJldHVybiB7CiAgICAgIHRvcDogY2FsY3VsYXRlZCwKICAgICAgYm90dG9tOiBjYWxjdWxhdGVkCiAgICB9OwogIH0KICByZXR1cm4gewogICAgdG9wOiAoKF9wYWRkaW5nJHRvcCA9IHBhZGRpbmcudG9wKSAhPT0gbnVsbCAmJiBfcGFkZGluZyR0b3AgIT09IHZvaWQgMCA/IF9wYWRkaW5nJHRvcCA6IDApICsgY2FsY3VsYXRlZCwKICAgIGJvdHRvbTogKChfcGFkZGluZyRib3R0b20gPSBwYWRkaW5nLmJvdHRvbSkgIT09IG51bGwgJiYgX3BhZGRpbmckYm90dG9tICE9PSB2b2lkIDAgPyBfcGFkZGluZyRib3R0b20gOiAwKSArIGNhbGN1bGF0ZWQKICB9Owp9KTsKdmFyIGNvbWJpbmVYQXhpc1JhbmdlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFhBeGlzUGFkZGluZywgc2VsZWN0QnJ1c2hEaW1lbnNpb25zLCBzZWxlY3RCcnVzaFNldHRpbmdzLCAoX3N0YXRlLCBfYXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBpc1Bhbm9yYW1hXSwgKG9mZnNldCwgcGFkZGluZywgYnJ1c2hEaW1lbnNpb25zLCBfcmVmNCwgaXNQYW5vcmFtYSkgPT4gewogIHZhciB7CiAgICBwYWRkaW5nOiBicnVzaFBhZGRpbmcKICB9ID0gX3JlZjQ7CiAgaWYgKGlzUGFub3JhbWEpIHsKICAgIHJldHVybiBbYnJ1c2hQYWRkaW5nLmxlZnQsIGJydXNoRGltZW5zaW9ucy53aWR0aCAtIGJydXNoUGFkZGluZy5yaWdodF07CiAgfQogIHJldHVybiBbb2Zmc2V0LmxlZnQgKyBwYWRkaW5nLmxlZnQsIG9mZnNldC5sZWZ0ICsgb2Zmc2V0LndpZHRoIC0gcGFkZGluZy5yaWdodF07Cn0pOwp2YXIgY29tYmluZVlBeGlzUmFuZ2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFlBeGlzUGFkZGluZywgc2VsZWN0QnJ1c2hEaW1lbnNpb25zLCBzZWxlY3RCcnVzaFNldHRpbmdzLCAoX3N0YXRlLCBfYXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBpc1Bhbm9yYW1hXSwgKG9mZnNldCwgbGF5b3V0LCBwYWRkaW5nLCBicnVzaERpbWVuc2lvbnMsIF9yZWY1LCBpc1Bhbm9yYW1hKSA9PiB7CiAgdmFyIHsKICAgIHBhZGRpbmc6IGJydXNoUGFkZGluZwogIH0gPSBfcmVmNTsKICBpZiAoaXNQYW5vcmFtYSkgewogICAgcmV0dXJuIFticnVzaERpbWVuc2lvbnMuaGVpZ2h0IC0gYnJ1c2hQYWRkaW5nLmJvdHRvbSwgYnJ1c2hQYWRkaW5nLnRvcF07CiAgfQogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIikgewogICAgcmV0dXJuIFtvZmZzZXQudG9wICsgb2Zmc2V0LmhlaWdodCAtIHBhZGRpbmcuYm90dG9tLCBvZmZzZXQudG9wICsgcGFkZGluZy50b3BdOwogIH0KICByZXR1cm4gW29mZnNldC50b3AgKyBwYWRkaW5nLnRvcCwgb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQgLSBwYWRkaW5nLmJvdHRvbV07Cn0pOwp2YXIgc2VsZWN0QXhpc1JhbmdlID0gKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiB7CiAgdmFyIF9zZWxlY3RaQXhpc1NldHRpbmdzOwogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjoKICAgICAgcmV0dXJuIGNvbWJpbmVYQXhpc1JhbmdlKHN0YXRlLCBheGlzSWQsIGlzUGFub3JhbWEpOwogICAgY2FzZSAieUF4aXMiOgogICAgICByZXR1cm4gY29tYmluZVlBeGlzUmFuZ2Uoc3RhdGUsIGF4aXNJZCwgaXNQYW5vcmFtYSk7CiAgICBjYXNlICJ6QXhpcyI6CiAgICAgIHJldHVybiAoX3NlbGVjdFpBeGlzU2V0dGluZ3MgPSBzZWxlY3RaQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpKSA9PT0gbnVsbCB8fCBfc2VsZWN0WkF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3NlbGVjdFpBeGlzU2V0dGluZ3MucmFuZ2U7CiAgICBjYXNlICJhbmdsZUF4aXMiOgogICAgICByZXR1cm4gc2VsZWN0QW5nbGVBeGlzUmFuZ2Uoc3RhdGUpOwogICAgY2FzZSAicmFkaXVzQXhpcyI6CiAgICAgIHJldHVybiBzZWxlY3RSYWRpdXNBeGlzUmFuZ2Uoc3RhdGUsIGF4aXNJZCk7CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gdm9pZCAwOwogIH0KfTsKdmFyIHNlbGVjdEF4aXNSYW5nZVdpdGhSZXZlcnNlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3RBeGlzUmFuZ2VdLCBjb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UpOwp2YXIgc2VsZWN0QXhpc1NjYWxlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3RSZWFsU2NhbGVUeXBlLCBzZWxlY3RBeGlzRG9tYWluSW5jbHVkaW5nTmljZVRpY2tzLCBzZWxlY3RBeGlzUmFuZ2VXaXRoUmV2ZXJzZV0sIGNvbWJpbmVTY2FsZUZ1bmN0aW9uKTsKdmFyIHNlbGVjdEVycm9yQmFyc1NldHRpbmdzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3MsIHNlbGVjdEFsbEVycm9yQmFyU2V0dGluZ3MsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVSZWxldmFudEVycm9yQmFyU2V0dGluZ3MpOwpmdW5jdGlvbiBjb21wYXJlSWRzKGEsIGIpIHsKICBpZiAoYS5pZCA8IGIuaWQpIHsKICAgIHJldHVybiAtMTsKICB9CiAgaWYgKGEuaWQgPiBiLmlkKSB7CiAgICByZXR1cm4gMTsKICB9CiAgcmV0dXJuIDA7Cn0KdmFyIHBpY2tBeGlzT3JpZW50YXRpb24gPSAoX3N0YXRlLCBvcmllbnRhdGlvbikgPT4gb3JpZW50YXRpb247CnZhciBwaWNrTWlycm9yID0gKF9zdGF0ZSwgX29yaWVudGF0aW9uLCBtaXJyb3IpID0+IG1pcnJvcjsKdmFyIHNlbGVjdEFsbFhBeGVzV2l0aE9mZnNldFR5cGUgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RBbGxYQXhlcywgcGlja0F4aXNPcmllbnRhdGlvbiwgcGlja01pcnJvciwgKGFsbEF4ZXMsIG9yaWVudGF0aW9uLCBtaXJyb3IpID0+IGFsbEF4ZXMuZmlsdGVyKChheGlzKSA9PiBheGlzLm9yaWVudGF0aW9uID09PSBvcmllbnRhdGlvbikuZmlsdGVyKChheGlzKSA9PiBheGlzLm1pcnJvciA9PT0gbWlycm9yKS5zb3J0KGNvbXBhcmVJZHMpKTsKdmFyIHNlbGVjdEFsbFlBeGVzV2l0aE9mZnNldFR5cGUgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RBbGxZQXhlcywgcGlja0F4aXNPcmllbnRhdGlvbiwgcGlja01pcnJvciwgKGFsbEF4ZXMsIG9yaWVudGF0aW9uLCBtaXJyb3IpID0+IGFsbEF4ZXMuZmlsdGVyKChheGlzKSA9PiBheGlzLm9yaWVudGF0aW9uID09PSBvcmllbnRhdGlvbikuZmlsdGVyKChheGlzKSA9PiBheGlzLm1pcnJvciA9PT0gbWlycm9yKS5zb3J0KGNvbXBhcmVJZHMpKTsKdmFyIGdldFhBeGlzU2l6ZSA9IChvZmZzZXQsIGF4aXNTZXR0aW5ncykgPT4gewogIHJldHVybiB7CiAgICB3aWR0aDogb2Zmc2V0LndpZHRoLAogICAgaGVpZ2h0OiBheGlzU2V0dGluZ3MuaGVpZ2h0CiAgfTsKfTsKdmFyIGdldFlBeGlzU2l6ZSA9IChvZmZzZXQsIGF4aXNTZXR0aW5ncykgPT4gewogIHZhciB3aWR0aCA9IHR5cGVvZiBheGlzU2V0dGluZ3Mud2lkdGggPT09ICJudW1iZXIiID8gYXhpc1NldHRpbmdzLndpZHRoIDogREVGQVVMVF9ZX0FYSVNfV0lEVEg7CiAgcmV0dXJuIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0OiBvZmZzZXQuaGVpZ2h0CiAgfTsKfTsKdmFyIHNlbGVjdFhBeGlzU2l6ZSA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFhBeGlzU2V0dGluZ3MsIGdldFhBeGlzU2l6ZSk7CnZhciBjb21iaW5lWEF4aXNQb3NpdGlvblN0YXJ0aW5nUG9pbnQgPSAob2Zmc2V0LCBvcmllbnRhdGlvbiwgY2hhcnRIZWlnaHQpID0+IHsKICBzd2l0Y2ggKG9yaWVudGF0aW9uKSB7CiAgICBjYXNlICJ0b3AiOgogICAgICByZXR1cm4gb2Zmc2V0LnRvcDsKICAgIGNhc2UgImJvdHRvbSI6CiAgICAgIHJldHVybiBjaGFydEhlaWdodCAtIG9mZnNldC5ib3R0b207CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gMDsKICB9Cn07CnZhciBjb21iaW5lWUF4aXNQb3NpdGlvblN0YXJ0aW5nUG9pbnQgPSAob2Zmc2V0LCBvcmllbnRhdGlvbiwgY2hhcnRXaWR0aCkgPT4gewogIHN3aXRjaCAob3JpZW50YXRpb24pIHsKICAgIGNhc2UgImxlZnQiOgogICAgICByZXR1cm4gb2Zmc2V0LmxlZnQ7CiAgICBjYXNlICJyaWdodCI6CiAgICAgIHJldHVybiBjaGFydFdpZHRoIC0gb2Zmc2V0LnJpZ2h0OwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIDA7CiAgfQp9Owp2YXIgc2VsZWN0QWxsWEF4ZXNPZmZzZXRTdGVwcyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RBbGxYQXhlc1dpdGhPZmZzZXRUeXBlLCBwaWNrQXhpc09yaWVudGF0aW9uLCBwaWNrTWlycm9yLCAoY2hhcnRIZWlnaHQsIG9mZnNldCwgYWxsQXhlc1dpdGhTYW1lT2Zmc2V0VHlwZSwgb3JpZW50YXRpb24sIG1pcnJvcikgPT4gewogIHZhciBzdGVwcyA9IHt9OwogIHZhciBwb3NpdGlvbjsKICBhbGxBeGVzV2l0aFNhbWVPZmZzZXRUeXBlLmZvckVhY2goKGF4aXMpID0+IHsKICAgIHZhciBheGlzU2l6ZSA9IGdldFhBeGlzU2l6ZShvZmZzZXQsIGF4aXMpOwogICAgaWYgKHBvc2l0aW9uID09IG51bGwpIHsKICAgICAgcG9zaXRpb24gPSBjb21iaW5lWEF4aXNQb3NpdGlvblN0YXJ0aW5nUG9pbnQob2Zmc2V0LCBvcmllbnRhdGlvbiwgY2hhcnRIZWlnaHQpOwogICAgfQogICAgdmFyIG5lZWRTcGFjZSA9IG9yaWVudGF0aW9uID09PSAidG9wIiAmJiAhbWlycm9yIHx8IG9yaWVudGF0aW9uID09PSAiYm90dG9tIiAmJiBtaXJyb3I7CiAgICBzdGVwc1theGlzLmlkXSA9IHBvc2l0aW9uIC0gTnVtYmVyKG5lZWRTcGFjZSkgKiBheGlzU2l6ZS5oZWlnaHQ7CiAgICBwb3NpdGlvbiArPSAobmVlZFNwYWNlID8gLTEgOiAxKSAqIGF4aXNTaXplLmhlaWdodDsKICB9KTsKICByZXR1cm4gc3RlcHM7Cn0pOwp2YXIgc2VsZWN0QWxsWUF4ZXNPZmZzZXRTdGVwcyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdEFsbFlBeGVzV2l0aE9mZnNldFR5cGUsIHBpY2tBeGlzT3JpZW50YXRpb24sIHBpY2tNaXJyb3IsIChjaGFydFdpZHRoLCBvZmZzZXQsIGFsbEF4ZXNXaXRoU2FtZU9mZnNldFR5cGUsIG9yaWVudGF0aW9uLCBtaXJyb3IpID0+IHsKICB2YXIgc3RlcHMgPSB7fTsKICB2YXIgcG9zaXRpb247CiAgYWxsQXhlc1dpdGhTYW1lT2Zmc2V0VHlwZS5mb3JFYWNoKChheGlzKSA9PiB7CiAgICB2YXIgYXhpc1NpemUgPSBnZXRZQXhpc1NpemUob2Zmc2V0LCBheGlzKTsKICAgIGlmIChwb3NpdGlvbiA9PSBudWxsKSB7CiAgICAgIHBvc2l0aW9uID0gY29tYmluZVlBeGlzUG9zaXRpb25TdGFydGluZ1BvaW50KG9mZnNldCwgb3JpZW50YXRpb24sIGNoYXJ0V2lkdGgpOwogICAgfQogICAgdmFyIG5lZWRTcGFjZSA9IG9yaWVudGF0aW9uID09PSAibGVmdCIgJiYgIW1pcnJvciB8fCBvcmllbnRhdGlvbiA9PT0gInJpZ2h0IiAmJiBtaXJyb3I7CiAgICBzdGVwc1theGlzLmlkXSA9IHBvc2l0aW9uIC0gTnVtYmVyKG5lZWRTcGFjZSkgKiBheGlzU2l6ZS53aWR0aDsKICAgIHBvc2l0aW9uICs9IChuZWVkU3BhY2UgPyAtMSA6IDEpICogYXhpc1NpemUud2lkdGg7CiAgfSk7CiAgcmV0dXJuIHN0ZXBzOwp9KTsKdmFyIHNlbGVjdFhBeGlzT2Zmc2V0U3RlcHMgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciBheGlzU2V0dGluZ3MgPSBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogIGlmIChheGlzU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIHNlbGVjdEFsbFhBeGVzT2Zmc2V0U3RlcHMoc3RhdGUsIGF4aXNTZXR0aW5ncy5vcmllbnRhdGlvbiwgYXhpc1NldHRpbmdzLm1pcnJvcik7Cn07CnZhciBzZWxlY3RYQXhpc1Bvc2l0aW9uID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFhBeGlzU2V0dGluZ3MsIHNlbGVjdFhBeGlzT2Zmc2V0U3RlcHMsIChfLCBheGlzSWQpID0+IGF4aXNJZF0sIChvZmZzZXQsIGF4aXNTZXR0aW5ncywgYWxsU3RlcHMsIGF4aXNJZCkgPT4gewogIGlmIChheGlzU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHN0ZXBPZlRoaXNBeGlzID0gYWxsU3RlcHMgPT09IG51bGwgfHwgYWxsU3RlcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFsbFN0ZXBzW2F4aXNJZF07CiAgaWYgKHN0ZXBPZlRoaXNBeGlzID09IG51bGwpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IG9mZnNldC5sZWZ0LAogICAgICB5OiAwCiAgICB9OwogIH0KICByZXR1cm4gewogICAgeDogb2Zmc2V0LmxlZnQsCiAgICB5OiBzdGVwT2ZUaGlzQXhpcwogIH07Cn0pOwp2YXIgc2VsZWN0WUF4aXNPZmZzZXRTdGVwcyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIGF4aXNTZXR0aW5ncyA9IHNlbGVjdFlBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgaWYgKGF4aXNTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gc2VsZWN0QWxsWUF4ZXNPZmZzZXRTdGVwcyhzdGF0ZSwgYXhpc1NldHRpbmdzLm9yaWVudGF0aW9uLCBheGlzU2V0dGluZ3MubWlycm9yKTsKfTsKdmFyIHNlbGVjdFlBeGlzUG9zaXRpb24gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0WUF4aXNTZXR0aW5ncywgc2VsZWN0WUF4aXNPZmZzZXRTdGVwcywgKF8sIGF4aXNJZCkgPT4gYXhpc0lkXSwgKG9mZnNldCwgYXhpc1NldHRpbmdzLCBhbGxTdGVwcywgYXhpc0lkKSA9PiB7CiAgaWYgKGF4aXNTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgc3RlcE9mVGhpc0F4aXMgPSBhbGxTdGVwcyA9PT0gbnVsbCB8fCBhbGxTdGVwcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWxsU3RlcHNbYXhpc0lkXTsKICBpZiAoc3RlcE9mVGhpc0F4aXMgPT0gbnVsbCkgewogICAgcmV0dXJuIHsKICAgICAgeDogMCwKICAgICAgeTogb2Zmc2V0LnRvcAogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIHg6IHN0ZXBPZlRoaXNBeGlzLAogICAgeTogb2Zmc2V0LnRvcAogIH07Cn0pOwp2YXIgc2VsZWN0WUF4aXNTaXplID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0WUF4aXNTZXR0aW5ncywgKG9mZnNldCwgYXhpc1NldHRpbmdzKSA9PiB7CiAgdmFyIHdpZHRoID0gdHlwZW9mIGF4aXNTZXR0aW5ncy53aWR0aCA9PT0gIm51bWJlciIgPyBheGlzU2V0dGluZ3Mud2lkdGggOiBERUZBVUxUX1lfQVhJU19XSURUSDsKICByZXR1cm4gewogICAgd2lkdGgsCiAgICBoZWlnaHQ6IG9mZnNldC5oZWlnaHQKICB9Owp9KTsKdmFyIGNvbWJpbmVEdXBsaWNhdGVEb21haW4gPSAoY2hhcnRMYXlvdXQsIGFwcGxpZWRWYWx1ZXMsIGF4aXMsIGF4aXNUeXBlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIGFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogICAgdHlwZSwKICAgIGRhdGFLZXkKICB9ID0gYXhpczsKICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGNoYXJ0TGF5b3V0LCBheGlzVHlwZSk7CiAgdmFyIGFsbERhdGEgPSBhcHBsaWVkVmFsdWVzLm1hcCgoYXYpID0+IGF2LnZhbHVlKTsKICBpZiAoZGF0YUtleSAmJiBpc0NhdGVnb3JpY2FsICYmIHR5cGUgPT09ICJjYXRlZ29yeSIgJiYgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkgJiYgaGFzRHVwbGljYXRlKGFsbERhdGEpKSB7CiAgICByZXR1cm4gYWxsRGF0YTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIHNlbGVjdER1cGxpY2F0ZURvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsQXBwbGllZFZhbHVlcywgc2VsZWN0QmFzZUF4aXMsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVEdXBsaWNhdGVEb21haW4pOwp2YXIgY29tYmluZUNhdGVnb3JpY2FsRG9tYWluID0gKGxheW91dCwgYXBwbGllZFZhbHVlcywgYXhpcywgYXhpc1R5cGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsIHx8IGF4aXMuZGF0YUtleSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgdHlwZSwKICAgIHNjYWxlCiAgfSA9IGF4aXM7CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICBpZiAoaXNDYXRlZ29yaWNhbCAmJiAodHlwZSA9PT0gIm51bWJlciIgfHwgc2NhbGUgIT09ICJhdXRvIikpIHsKICAgIHJldHVybiBhcHBsaWVkVmFsdWVzLm1hcCgoZCkgPT4gZC52YWx1ZSk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciBzZWxlY3RDYXRlZ29yaWNhbERvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsQXBwbGllZFZhbHVlcywgc2VsZWN0QXhpc1NldHRpbmdzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQ2F0ZWdvcmljYWxEb21haW4pOwp2YXIgc2VsZWN0QXhpc1Byb3BzTmVlZGVkRm9yQ2FydGVzaWFuR3JpZFRpY2tzR2VuZXJhdG9yID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RDYXJ0ZXNpYW5BeGlzU2V0dGluZ3MsIHNlbGVjdFJlYWxTY2FsZVR5cGUsIHNlbGVjdEF4aXNTY2FsZSwgc2VsZWN0RHVwbGljYXRlRG9tYWluLCBzZWxlY3RDYXRlZ29yaWNhbERvbWFpbiwgc2VsZWN0QXhpc1JhbmdlLCBzZWxlY3ROaWNlVGlja3MsIHBpY2tBeGlzVHlwZV0sIChsYXlvdXQsIGF4aXMsIHJlYWxTY2FsZVR5cGUsIHNjYWxlLCBkdXBsaWNhdGVEb21haW4sIGNhdGVnb3JpY2FsRG9tYWluLCBheGlzUmFuZ2UsIG5pY2VUaWNrcywgYXhpc1R5cGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGxheW91dCwgYXhpc1R5cGUpOwogIHJldHVybiB7CiAgICBhbmdsZTogYXhpcy5hbmdsZSwKICAgIGludGVydmFsOiBheGlzLmludGVydmFsLAogICAgbWluVGlja0dhcDogYXhpcy5taW5UaWNrR2FwLAogICAgb3JpZW50YXRpb246IGF4aXMub3JpZW50YXRpb24sCiAgICB0aWNrOiBheGlzLnRpY2ssCiAgICB0aWNrQ291bnQ6IGF4aXMudGlja0NvdW50LAogICAgdGlja0Zvcm1hdHRlcjogYXhpcy50aWNrRm9ybWF0dGVyLAogICAgdGlja3M6IGF4aXMudGlja3MsCiAgICB0eXBlOiBheGlzLnR5cGUsCiAgICB1bml0OiBheGlzLnVuaXQsCiAgICBheGlzVHlwZSwKICAgIGNhdGVnb3JpY2FsRG9tYWluLAogICAgZHVwbGljYXRlRG9tYWluLAogICAgaXNDYXRlZ29yaWNhbCwKICAgIG5pY2VUaWNrcywKICAgIHJhbmdlOiBheGlzUmFuZ2UsCiAgICByZWFsU2NhbGVUeXBlLAogICAgc2NhbGUKICB9Owp9KTsKdmFyIGNvbWJpbmVBeGlzVGlja3MgPSAobGF5b3V0LCBheGlzLCByZWFsU2NhbGVUeXBlLCBzY2FsZSwgbmljZVRpY2tzLCBheGlzUmFuZ2UsIGR1cGxpY2F0ZURvbWFpbiwgY2F0ZWdvcmljYWxEb21haW4sIGF4aXNUeXBlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCB8fCBzY2FsZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGxheW91dCwgYXhpc1R5cGUpOwogIHZhciB7CiAgICB0eXBlLAogICAgdGlja3M6IHRpY2tzMiwKICAgIHRpY2tDb3VudAogIH0gPSBheGlzOwogIHZhciBvZmZzZXRGb3JCYW5kID0gcmVhbFNjYWxlVHlwZSA9PT0gInNjYWxlQmFuZCIgJiYgdHlwZW9mIHNjYWxlLmJhbmR3aWR0aCA9PT0gImZ1bmN0aW9uIiA/IHNjYWxlLmJhbmR3aWR0aCgpIC8gMiA6IDI7CiAgdmFyIG9mZnNldCA9IHR5cGUgPT09ICJjYXRlZ29yeSIgJiYgc2NhbGUuYmFuZHdpZHRoID8gc2NhbGUuYmFuZHdpZHRoKCkgLyBvZmZzZXRGb3JCYW5kIDogMDsKICBvZmZzZXQgPSBheGlzVHlwZSA9PT0gImFuZ2xlQXhpcyIgJiYgYXhpc1JhbmdlICE9IG51bGwgJiYgYXhpc1JhbmdlLmxlbmd0aCA+PSAyID8gbWF0aFNpZ24oYXhpc1JhbmdlWzBdIC0gYXhpc1JhbmdlWzFdKSAqIDIgKiBvZmZzZXQgOiBvZmZzZXQ7CiAgdmFyIHRpY2tzT3JOaWNlVGlja3MgPSB0aWNrczIgfHwgbmljZVRpY2tzOwogIGlmICh0aWNrc09yTmljZVRpY2tzKSB7CiAgICB2YXIgcmVzdWx0ID0gdGlja3NPck5pY2VUaWNrcy5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgICB2YXIgc2NhbGVDb250ZW50ID0gZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluLmluZGV4T2YoZW50cnkpIDogZW50cnk7CiAgICAgIHJldHVybiB7CiAgICAgICAgaW5kZXgsCiAgICAgICAgLy8gSWYgdGhlIHNjYWxlQ29udGVudCBpcyBub3QgYSBudW1iZXIsIHRoZSBjb29yZGluYXRlIHdpbGwgYmUgTmFOLgogICAgICAgIC8vIFRoYXQgY291bGQgYmUgdGhlIGNhc2UgZm9yIGV4YW1wbGUgd2l0aCBhIFBvaW50U2NhbGUgYW5kIGEgc3RyaW5nIGFzIGRvbWFpbi4KICAgICAgICBjb29yZGluYXRlOiBzY2FsZShzY2FsZUNvbnRlbnQpICsgb2Zmc2V0LAogICAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgICBvZmZzZXQKICAgICAgfTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdC5maWx0ZXIoKHJvdykgPT4gaXNXZWxsQmVoYXZlZE51bWJlcihyb3cuY29vcmRpbmF0ZSkpOwogIH0KICBpZiAoaXNDYXRlZ29yaWNhbCAmJiBjYXRlZ29yaWNhbERvbWFpbikgewogICAgcmV0dXJuIGNhdGVnb3JpY2FsRG9tYWluLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgaW5kZXgsCiAgICAgIG9mZnNldAogICAgfSkpLmZpbHRlcigocm93KSA9PiBpc1dlbGxCZWhhdmVkTnVtYmVyKHJvdy5jb29yZGluYXRlKSk7CiAgfQogIGlmIChzY2FsZS50aWNrcykgewogICAgcmV0dXJuIHNjYWxlLnRpY2tzKHRpY2tDb3VudCkubWFwKChlbnRyeSkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIG9mZnNldAogICAgfSkpOwogIH0KICByZXR1cm4gc2NhbGUuZG9tYWluKCkubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICB2YWx1ZTogZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluW2VudHJ5XSA6IGVudHJ5LAogICAgaW5kZXgsCiAgICBvZmZzZXQKICB9KSk7Cn07CnZhciBzZWxlY3RUaWNrc09mQXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QXhpc1NldHRpbmdzLCBzZWxlY3RSZWFsU2NhbGVUeXBlLCBzZWxlY3RBeGlzU2NhbGUsIHNlbGVjdE5pY2VUaWNrcywgc2VsZWN0QXhpc1JhbmdlLCBzZWxlY3REdXBsaWNhdGVEb21haW4sIHNlbGVjdENhdGVnb3JpY2FsRG9tYWluLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQXhpc1RpY2tzKTsKdmFyIGNvbWJpbmVHcmFwaGljYWxJdGVtVGlja3MgPSAobGF5b3V0LCBheGlzLCBzY2FsZSwgYXhpc1JhbmdlLCBkdXBsaWNhdGVEb21haW4sIGNhdGVnb3JpY2FsRG9tYWluLCBheGlzVHlwZSkgPT4gewogIGlmIChheGlzID09IG51bGwgfHwgc2NhbGUgPT0gbnVsbCB8fCBheGlzUmFuZ2UgPT0gbnVsbCB8fCBheGlzUmFuZ2VbMF0gPT09IGF4aXNSYW5nZVsxXSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICB2YXIgewogICAgdGlja0NvdW50CiAgfSA9IGF4aXM7CiAgdmFyIG9mZnNldCA9IDA7CiAgb2Zmc2V0ID0gYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiICYmIChheGlzUmFuZ2UgPT09IG51bGwgfHwgYXhpc1JhbmdlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzUmFuZ2UubGVuZ3RoKSA+PSAyID8gbWF0aFNpZ24oYXhpc1JhbmdlWzBdIC0gYXhpc1JhbmdlWzFdKSAqIDIgKiBvZmZzZXQgOiBvZmZzZXQ7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgY2F0ZWdvcmljYWxEb21haW4pIHsKICAgIHJldHVybiBjYXRlZ29yaWNhbERvbWFpbi5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIGluZGV4LAogICAgICBvZmZzZXQKICAgIH0pKTsKICB9CiAgaWYgKHNjYWxlLnRpY2tzKSB7CiAgICByZXR1cm4gc2NhbGUudGlja3ModGlja0NvdW50KS5tYXAoKGVudHJ5KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgb2Zmc2V0CiAgICB9KSk7CiAgfQogIHJldHVybiBzY2FsZS5kb21haW4oKS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgIHZhbHVlOiBkdXBsaWNhdGVEb21haW4gPyBkdXBsaWNhdGVEb21haW5bZW50cnldIDogZW50cnksCiAgICBpbmRleCwKICAgIG9mZnNldAogIH0pKTsKfTsKdmFyIHNlbGVjdFRpY2tzT2ZHcmFwaGljYWxJdGVtID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RBeGlzU2V0dGluZ3MsIHNlbGVjdEF4aXNTY2FsZSwgc2VsZWN0QXhpc1JhbmdlLCBzZWxlY3REdXBsaWNhdGVEb21haW4sIHNlbGVjdENhdGVnb3JpY2FsRG9tYWluLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lR3JhcGhpY2FsSXRlbVRpY2tzKTsKdmFyIHNlbGVjdEF4aXNXaXRoU2NhbGUgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RCYXNlQXhpcywgc2VsZWN0QXhpc1NjYWxlLCAoYXhpcywgc2NhbGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsIHx8IHNjYWxlID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBfb2JqZWN0U3ByZWFkMTMoX29iamVjdFNwcmVhZDEzKHt9LCBheGlzKSwge30sIHsKICAgIHNjYWxlCiAgfSk7Cn0pOwp2YXIgc2VsZWN0WkF4aXNTY2FsZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0UmVhbFNjYWxlVHlwZSwgc2VsZWN0QXhpc0RvbWFpbiwgc2VsZWN0QXhpc1JhbmdlV2l0aFJldmVyc2VdLCBjb21iaW5lU2NhbGVGdW5jdGlvbik7CnZhciBzZWxlY3RaQXhpc1dpdGhTY2FsZSA9IGNyZWF0ZVNlbGVjdG9yKChzdGF0ZSwgX2F4aXNUeXBlLCBheGlzSWQpID0+IHNlbGVjdFpBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCksIHNlbGVjdFpBeGlzU2NhbGUsIChheGlzLCBzY2FsZSkgPT4gewogIGlmIChheGlzID09IG51bGwgfHwgc2NhbGUgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQxMyhfb2JqZWN0U3ByZWFkMTMoe30sIGF4aXMpLCB7fSwgewogICAgc2NhbGUKICB9KTsKfSk7CnZhciBzZWxlY3RDaGFydERpcmVjdGlvbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsWEF4ZXMsIHNlbGVjdEFsbFlBeGVzXSwgKGxheW91dCwgYWxsWEF4ZXMsIGFsbFlBeGVzKSA9PiB7CiAgc3dpdGNoIChsYXlvdXQpIHsKICAgIGNhc2UgImhvcml6b250YWwiOiB7CiAgICAgIHJldHVybiBhbGxYQXhlcy5zb21lKChheGlzKSA9PiBheGlzLnJldmVyc2VkKSA/ICJyaWdodC10by1sZWZ0IiA6ICJsZWZ0LXRvLXJpZ2h0IjsKICAgIH0KICAgIGNhc2UgInZlcnRpY2FsIjogewogICAgICByZXR1cm4gYWxsWUF4ZXMuc29tZSgoYXhpcykgPT4gYXhpcy5yZXZlcnNlZCkgPyAiYm90dG9tLXRvLXRvcCIgOiAidG9wLXRvLWJvdHRvbSI7CiAgICB9CiAgICBjYXNlICJjZW50cmljIjoKICAgIGNhc2UgInJhZGlhbCI6IHsKICAgICAgcmV0dXJuICJsZWZ0LXRvLXJpZ2h0IjsKICAgIH0KICAgIGRlZmF1bHQ6IHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBFdmVudFR5cGUuanMKdmFyIHNlbGVjdERlZmF1bHRUb29sdGlwRXZlbnRUeXBlID0gKHN0YXRlKSA9PiBzdGF0ZS5vcHRpb25zLmRlZmF1bHRUb29sdGlwRXZlbnRUeXBlOwp2YXIgc2VsZWN0VmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcyA9IChzdGF0ZSkgPT4gc3RhdGUub3B0aW9ucy52YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzOwpmdW5jdGlvbiBjb21iaW5lVG9vbHRpcEV2ZW50VHlwZShzaGFyZWQsIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlLCB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzKSB7CiAgaWYgKHNoYXJlZCA9PSBudWxsKSB7CiAgICByZXR1cm4gZGVmYXVsdFRvb2x0aXBFdmVudFR5cGU7CiAgfQogIHZhciBldmVudFR5cGUgPSBzaGFyZWQgPyAiYXhpcyIgOiAiaXRlbSI7CiAgaWYgKHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMgPT0gbnVsbCkgewogICAgcmV0dXJuIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlOwogIH0KICByZXR1cm4gdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcy5pbmNsdWRlcyhldmVudFR5cGUpID8gZXZlbnRUeXBlIDogZGVmYXVsdFRvb2x0aXBFdmVudFR5cGU7Cn0KZnVuY3Rpb24gc2VsZWN0VG9vbHRpcEV2ZW50VHlwZShzdGF0ZSwgc2hhcmVkKSB7CiAgdmFyIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlID0gc2VsZWN0RGVmYXVsdFRvb2x0aXBFdmVudFR5cGUoc3RhdGUpOwogIHZhciB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzID0gc2VsZWN0VmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcyhzdGF0ZSk7CiAgcmV0dXJuIGNvbWJpbmVUb29sdGlwRXZlbnRUeXBlKHNoYXJlZCwgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMpOwp9CmZ1bmN0aW9uIHVzZVRvb2x0aXBFdmVudFR5cGUoc2hhcmVkKSB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0VG9vbHRpcEV2ZW50VHlwZShzdGF0ZSwgc2hhcmVkKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZUFjdGl2ZUxhYmVsLmpzCnZhciBjb21iaW5lQWN0aXZlTGFiZWwgPSAodG9vbHRpcFRpY2tzLCBhY3RpdmVJbmRleCkgPT4gewogIHZhciBfdG9vbHRpcFRpY2tzJG47CiAgdmFyIG4gPSBOdW1iZXIoYWN0aXZlSW5kZXgpOwogIGlmIChpc05hbihuKSB8fCBhY3RpdmVJbmRleCA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gbiA+PSAwID8gdG9vbHRpcFRpY2tzID09PSBudWxsIHx8IHRvb2x0aXBUaWNrcyA9PT0gdm9pZCAwIHx8IChfdG9vbHRpcFRpY2tzJG4gPSB0b29sdGlwVGlja3Nbbl0pID09PSBudWxsIHx8IF90b29sdGlwVGlja3MkbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3Rvb2x0aXBUaWNrcyRuLnZhbHVlIDogdm9pZCAwOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBTZXR0aW5ncy5qcwp2YXIgc2VsZWN0VG9vbHRpcFNldHRpbmdzID0gKHN0YXRlKSA9PiBzdGF0ZS50b29sdGlwLnNldHRpbmdzOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvdG9vbHRpcFNsaWNlLmpzCnZhciBub0ludGVyYWN0aW9uID0gewogIGFjdGl2ZTogZmFsc2UsCiAgaW5kZXg6IG51bGwsCiAgZGF0YUtleTogdm9pZCAwLAogIGdyYXBoaWNhbEl0ZW1JZDogdm9pZCAwLAogIGNvb3JkaW5hdGU6IHZvaWQgMAp9Owp2YXIgaW5pdGlhbFN0YXRlMyA9IHsKICBpdGVtSW50ZXJhY3Rpb246IHsKICAgIGNsaWNrOiBub0ludGVyYWN0aW9uLAogICAgaG92ZXI6IG5vSW50ZXJhY3Rpb24KICB9LAogIGF4aXNJbnRlcmFjdGlvbjogewogICAgY2xpY2s6IG5vSW50ZXJhY3Rpb24sCiAgICBob3Zlcjogbm9JbnRlcmFjdGlvbgogIH0sCiAga2V5Ym9hcmRJbnRlcmFjdGlvbjogbm9JbnRlcmFjdGlvbiwKICBzeW5jSW50ZXJhY3Rpb246IHsKICAgIGFjdGl2ZTogZmFsc2UsCiAgICBpbmRleDogbnVsbCwKICAgIGRhdGFLZXk6IHZvaWQgMCwKICAgIGxhYmVsOiB2b2lkIDAsCiAgICBjb29yZGluYXRlOiB2b2lkIDAsCiAgICBzb3VyY2VWaWV3Qm94OiB2b2lkIDAsCiAgICBncmFwaGljYWxJdGVtSWQ6IHZvaWQgMAogIH0sCiAgdG9vbHRpcEl0ZW1QYXlsb2FkczogW10sCiAgc2V0dGluZ3M6IHsKICAgIHNoYXJlZDogdm9pZCAwLAogICAgdHJpZ2dlcjogImhvdmVyIiwKICAgIGF4aXNJZDogMCwKICAgIGFjdGl2ZTogZmFsc2UsCiAgICBkZWZhdWx0SW5kZXg6IHZvaWQgMAogIH0KfTsKdmFyIHRvb2x0aXBTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAidG9vbHRpcCIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGUzLAogIHJlZHVjZXJzOiB7CiAgICBhZGRUb29sdGlwRW50cnlTZXR0aW5nczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzLnB1c2goY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVwbGFjZVRvb2x0aXBFbnRyeVNldHRpbmdzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciB7CiAgICAgICAgICBwcmV2LAogICAgICAgICAgbmV4dAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS50b29sdGlwSXRlbVBheWxvYWRzLmluZGV4T2YoY2FzdERyYWZ0KHByZXYpKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgc3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkc1tpbmRleF0gPSBjYXN0RHJhZnQobmV4dCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZVRvb2x0aXBFbnRyeVNldHRpbmdzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLnRvb2x0aXBJdGVtUGF5bG9hZHMuaW5kZXhPZihjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgc3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICBzZXRUb29sdGlwU2V0dGluZ3NTdGF0ZShzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnNldHRpbmdzID0gYWN0aW9uLnBheWxvYWQ7CiAgICB9LAogICAgc2V0QWN0aXZlTW91c2VPdmVySXRlbUluZGV4KHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc3luY0ludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuYWN0aXZlID0gdHJ1ZTsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmluZGV4ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlSW5kZXg7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5kYXRhS2V5ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlRGF0YUtleTsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmdyYXBoaWNhbEl0ZW1JZCA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUdyYXBoaWNhbEl0ZW1JZDsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmNvb3JkaW5hdGUgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVDb29yZGluYXRlOwogICAgfSwKICAgIG1vdXNlTGVhdmVDaGFydChzdGF0ZSkgewogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3Zlci5hY3RpdmUgPSBmYWxzZTsKICAgIH0sCiAgICBtb3VzZUxlYXZlSXRlbShzdGF0ZSkgewogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuYWN0aXZlID0gZmFsc2U7CiAgICB9LAogICAgc2V0QWN0aXZlQ2xpY2tJdGVtSW5kZXgoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zeW5jSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5hY3RpdmUgPSB0cnVlOwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suaW5kZXggPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVJbmRleDsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmRhdGFLZXkgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVEYXRhS2V5OwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suZ3JhcGhpY2FsSXRlbUlkID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlR3JhcGhpY2FsSXRlbUlkOwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suY29vcmRpbmF0ZSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUNvb3JkaW5hdGU7CiAgICB9LAogICAgc2V0TW91c2VPdmVyQXhpc0luZGV4KHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc3luY0ludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uaG92ZXIuYWN0aXZlID0gdHJ1ZTsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyLmluZGV4ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlSW5kZXg7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3Zlci5kYXRhS2V5ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlRGF0YUtleTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyLmNvb3JkaW5hdGUgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVDb29yZGluYXRlOwogICAgfSwKICAgIHNldE1vdXNlQ2xpY2tBeGlzSW5kZXgoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zeW5jSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5jbGljay5hY3RpdmUgPSB0cnVlOwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uY2xpY2suaW5kZXggPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVJbmRleDsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmNsaWNrLmRhdGFLZXkgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVEYXRhS2V5OwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uY2xpY2suY29vcmRpbmF0ZSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUNvb3JkaW5hdGU7CiAgICB9LAogICAgc2V0U3luY0ludGVyYWN0aW9uKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc3luY0ludGVyYWN0aW9uID0gYWN0aW9uLnBheWxvYWQ7CiAgICB9LAogICAgc2V0S2V5Ym9hcmRJbnRlcmFjdGlvbihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlOwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmluZGV4ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlSW5kZXg7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uY29vcmRpbmF0ZSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUNvb3JkaW5hdGU7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uZGF0YUtleSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZURhdGFLZXk7CiAgICB9CiAgfQp9KTsKdmFyIHsKICBhZGRUb29sdGlwRW50cnlTZXR0aW5ncywKICByZXBsYWNlVG9vbHRpcEVudHJ5U2V0dGluZ3MsCiAgcmVtb3ZlVG9vbHRpcEVudHJ5U2V0dGluZ3MsCiAgc2V0VG9vbHRpcFNldHRpbmdzU3RhdGUsCiAgc2V0QWN0aXZlTW91c2VPdmVySXRlbUluZGV4LAogIG1vdXNlTGVhdmVJdGVtLAogIG1vdXNlTGVhdmVDaGFydCwKICBzZXRBY3RpdmVDbGlja0l0ZW1JbmRleCwKICBzZXRNb3VzZU92ZXJBeGlzSW5kZXgsCiAgc2V0TW91c2VDbGlja0F4aXNJbmRleCwKICBzZXRTeW5jSW50ZXJhY3Rpb24sCiAgc2V0S2V5Ym9hcmRJbnRlcmFjdGlvbgp9ID0gdG9vbHRpcFNsaWNlLmFjdGlvbnM7CnZhciB0b29sdGlwUmVkdWNlciA9IHRvb2x0aXBTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lVG9vbHRpcEludGVyYWN0aW9uU3RhdGUuanMKZnVuY3Rpb24gb3duS2V5czE0KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTQoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxNChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTQoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTQoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTE0KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTQocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTQodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTQodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTQodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIGNob29zZUFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbih0b29sdGlwU3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIpIHsKICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICBpZiAodHJpZ2dlciA9PT0gImNsaWNrIikgewogICAgICByZXR1cm4gdG9vbHRpcFN0YXRlLmF4aXNJbnRlcmFjdGlvbi5jbGljazsKICAgIH0KICAgIHJldHVybiB0b29sdGlwU3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyOwogIH0KICBpZiAodHJpZ2dlciA9PT0gImNsaWNrIikgewogICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2s7CiAgfQogIHJldHVybiB0b29sdGlwU3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyOwp9CmZ1bmN0aW9uIGhhc0JlZW5BY3RpdmVQcmV2aW91c2x5KHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlKSB7CiAgcmV0dXJuIHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmluZGV4ICE9IG51bGw7Cn0KdmFyIGNvbWJpbmVUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSA9ICh0b29sdGlwU3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGRlZmF1bHRJbmRleCkgPT4gewogIGlmICh0b29sdGlwRXZlbnRUeXBlID09IG51bGwpIHsKICAgIHJldHVybiBub0ludGVyYWN0aW9uOwogIH0KICB2YXIgYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uID0gY2hvb3NlQXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uKHRvb2x0aXBTdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlcik7CiAgaWYgKGFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbiA9PSBudWxsKSB7CiAgICByZXR1cm4gbm9JbnRlcmFjdGlvbjsKICB9CiAgaWYgKGFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbi5hY3RpdmUpIHsKICAgIHJldHVybiBhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb247CiAgfQogIGlmICh0b29sdGlwU3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUpIHsKICAgIHJldHVybiB0b29sdGlwU3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbjsKICB9CiAgaWYgKHRvb2x0aXBTdGF0ZS5zeW5jSW50ZXJhY3Rpb24uYWN0aXZlICYmIHRvb2x0aXBTdGF0ZS5zeW5jSW50ZXJhY3Rpb24uaW5kZXggIT0gbnVsbCkgewogICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5zeW5jSW50ZXJhY3Rpb247CiAgfQogIHZhciBhY3RpdmVGcm9tUHJvcHMgPSB0b29sdGlwU3RhdGUuc2V0dGluZ3MuYWN0aXZlID09PSB0cnVlOwogIGlmIChoYXNCZWVuQWN0aXZlUHJldmlvdXNseShhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24pKSB7CiAgICBpZiAoYWN0aXZlRnJvbVByb3BzKSB7CiAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTQoX29iamVjdFNwcmVhZDE0KHt9LCBhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24pLCB7fSwgewogICAgICAgIGFjdGl2ZTogdHJ1ZQogICAgICB9KTsKICAgIH0KICB9IGVsc2UgaWYgKGRlZmF1bHRJbmRleCAhPSBudWxsKSB7CiAgICByZXR1cm4gewogICAgICBhY3RpdmU6IHRydWUsCiAgICAgIGNvb3JkaW5hdGU6IHZvaWQgMCwKICAgICAgZGF0YUtleTogdm9pZCAwLAogICAgICBpbmRleDogZGVmYXVsdEluZGV4LAogICAgICBncmFwaGljYWxJdGVtSWQ6IHZvaWQgMAogICAgfTsKICB9CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQxNChfb2JqZWN0U3ByZWFkMTQoe30sIG5vSW50ZXJhY3Rpb24pLCB7fSwgewogICAgY29vcmRpbmF0ZTogYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uLmNvb3JkaW5hdGUKICB9KTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZUFjdGl2ZVRvb2x0aXBJbmRleC5qcwpmdW5jdGlvbiB0b0Zpbml0ZU51bWJlcih2YWx1ZSkgewogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKHZhbHVlKSA/IHZhbHVlIDogdm9pZCAwOwogIH0KICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICB2YXIgbnVtZXJpY1ZhbHVlID0gdmFsdWUudmFsdWVPZigpOwogICAgcmV0dXJuIE51bWJlci5pc0Zpbml0ZShudW1lcmljVmFsdWUpID8gbnVtZXJpY1ZhbHVlIDogdm9pZCAwOwogIH0KICB2YXIgcGFyc2VkID0gTnVtYmVyKHZhbHVlKTsKICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKHBhcnNlZCkgPyBwYXJzZWQgOiB2b2lkIDA7Cn0KZnVuY3Rpb24gaXNWYWx1ZVdpdGhpbk51bWJlckRvbWFpbih2YWx1ZSwgZG9tYWluKSB7CiAgdmFyIG51bWVyaWNWYWx1ZSA9IHRvRmluaXRlTnVtYmVyKHZhbHVlKTsKICB2YXIgbG93ZXJCb3VuZCA9IGRvbWFpblswXTsKICB2YXIgdXBwZXJCb3VuZCA9IGRvbWFpblsxXTsKICBpZiAobnVtZXJpY1ZhbHVlID09PSB2b2lkIDApIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgdmFyIG1pbjIgPSBNYXRoLm1pbihsb3dlckJvdW5kLCB1cHBlckJvdW5kKTsKICB2YXIgbWF4MiA9IE1hdGgubWF4KGxvd2VyQm91bmQsIHVwcGVyQm91bmQpOwogIHJldHVybiBudW1lcmljVmFsdWUgPj0gbWluMiAmJiBudW1lcmljVmFsdWUgPD0gbWF4MjsKfQpmdW5jdGlvbiBpc1ZhbHVlV2l0aGluRG9tYWluKGVudHJ5LCBheGlzRGF0YUtleSwgZG9tYWluKSB7CiAgaWYgKGRvbWFpbiA9PSBudWxsIHx8IGF4aXNEYXRhS2V5ID09IG51bGwpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICB2YXIgdmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgYXhpc0RhdGFLZXkpOwogIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgaWYgKCFpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oZG9tYWluKSkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBpc1ZhbHVlV2l0aGluTnVtYmVyRG9tYWluKHZhbHVlLCBkb21haW4pOwp9CnZhciBjb21iaW5lQWN0aXZlVG9vbHRpcEluZGV4ID0gKHRvb2x0aXBJbnRlcmFjdGlvbiwgY2hhcnREYXRhLCBheGlzRGF0YUtleSwgZG9tYWluKSA9PiB7CiAgdmFyIGRlc2lyZWRJbmRleCA9IHRvb2x0aXBJbnRlcmFjdGlvbiA9PT0gbnVsbCB8fCB0b29sdGlwSW50ZXJhY3Rpb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRvb2x0aXBJbnRlcmFjdGlvbi5pbmRleDsKICBpZiAoZGVzaXJlZEluZGV4ID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgaW5kZXhBc051bWJlciA9IE51bWJlcihkZXNpcmVkSW5kZXgpOwogIGlmICghaXNXZWxsQmVoYXZlZE51bWJlcihpbmRleEFzTnVtYmVyKSkgewogICAgcmV0dXJuIGRlc2lyZWRJbmRleDsKICB9CiAgdmFyIGxvd2VyTGltaXQgPSAwOwogIHZhciB1cHBlckxpbWl0ID0gSW5maW5pdHk7CiAgaWYgKGNoYXJ0RGF0YS5sZW5ndGggPiAwKSB7CiAgICB1cHBlckxpbWl0ID0gY2hhcnREYXRhLmxlbmd0aCAtIDE7CiAgfQogIHZhciBjbGFtcGVkSW5kZXggPSBNYXRoLm1heChsb3dlckxpbWl0LCBNYXRoLm1pbihpbmRleEFzTnVtYmVyLCB1cHBlckxpbWl0KSk7CiAgdmFyIGVudHJ5ID0gY2hhcnREYXRhW2NsYW1wZWRJbmRleF07CiAgaWYgKGVudHJ5ID09IG51bGwpIHsKICAgIHJldHVybiBTdHJpbmcoY2xhbXBlZEluZGV4KTsKICB9CiAgaWYgKCFpc1ZhbHVlV2l0aGluRG9tYWluKGVudHJ5LCBheGlzRGF0YUtleSwgZG9tYWluKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiBTdHJpbmcoY2xhbXBlZEluZGV4KTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZUNvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXguanMKdmFyIGNvbWJpbmVDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4ID0gKHdpZHRoLCBoZWlnaHQsIGxheW91dCwgb2Zmc2V0LCB0b29sdGlwVGlja3MsIGRlZmF1bHRJbmRleCwgdG9vbHRpcENvbmZpZ3VyYXRpb25zLCB0b29sdGlwUGF5bG9hZFNlYXJjaGVyKSA9PiB7CiAgaWYgKGRlZmF1bHRJbmRleCA9PSBudWxsIHx8IHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGZpcnN0Q29uZmlndXJhdGlvbiA9IHRvb2x0aXBDb25maWd1cmF0aW9uc1swXTsKICB2YXIgbWF5YmVQb3NpdGlvbiA9IGZpcnN0Q29uZmlndXJhdGlvbiA9PSBudWxsID8gdm9pZCAwIDogdG9vbHRpcFBheWxvYWRTZWFyY2hlcihmaXJzdENvbmZpZ3VyYXRpb24ucG9zaXRpb25zLCBkZWZhdWx0SW5kZXgpOwogIGlmIChtYXliZVBvc2l0aW9uICE9IG51bGwpIHsKICAgIHJldHVybiBtYXliZVBvc2l0aW9uOwogIH0KICB2YXIgdGljayA9IHRvb2x0aXBUaWNrcyA9PT0gbnVsbCB8fCB0b29sdGlwVGlja3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRvb2x0aXBUaWNrc1tOdW1iZXIoZGVmYXVsdEluZGV4KV07CiAgaWYgKCF0aWNrKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBzd2l0Y2ggKGxheW91dCkgewogICAgY2FzZSAiaG9yaXpvbnRhbCI6IHsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiB0aWNrLmNvb3JkaW5hdGUsCiAgICAgICAgeTogKG9mZnNldC50b3AgKyBoZWlnaHQpIC8gMgogICAgICB9OwogICAgfQogICAgZGVmYXVsdDogewogICAgICByZXR1cm4gewogICAgICAgIHg6IChvZmZzZXQubGVmdCArIHdpZHRoKSAvIDIsCiAgICAgICAgeTogdGljay5jb29yZGluYXRlCiAgICAgIH07CiAgICB9CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lVG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9ucy5qcwp2YXIgY29tYmluZVRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMgPSAodG9vbHRpcFN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBkZWZhdWx0SW5kZXgpID0+IHsKICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHM7CiAgfQogIGlmICh0b29sdGlwU3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBbXTsKICB9CiAgdmFyIGZpbHRlckJ5RGF0YUtleTsKICBpZiAodHJpZ2dlciA9PT0gImhvdmVyIikgewogICAgZmlsdGVyQnlEYXRhS2V5ID0gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5kYXRhS2V5OwogIH0gZWxzZSB7CiAgICBmaWx0ZXJCeURhdGFLZXkgPSB0b29sdGlwU3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmRhdGFLZXk7CiAgfQogIGlmIChmaWx0ZXJCeURhdGFLZXkgPT0gbnVsbCAmJiBkZWZhdWx0SW5kZXggIT0gbnVsbCkgewogICAgcmV0dXJuIFt0b29sdGlwU3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkc1swXV07CiAgfQogIHJldHVybiB0b29sdGlwU3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkcy5maWx0ZXIoKHRwYykgPT4gewogICAgdmFyIF90cGMkc2V0dGluZ3M7CiAgICByZXR1cm4gKChfdHBjJHNldHRpbmdzID0gdHBjLnNldHRpbmdzKSA9PT0gbnVsbCB8fCBfdHBjJHNldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdHBjJHNldHRpbmdzLmRhdGFLZXkpID09PSBmaWx0ZXJCeURhdGFLZXk7CiAgfSk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlci5qcwp2YXIgc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlciA9IChzdGF0ZSkgPT4gc3RhdGUub3B0aW9ucy50b29sdGlwUGF5bG9hZFNlYXJjaGVyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBTdGF0ZS5qcwp2YXIgc2VsZWN0VG9vbHRpcFN0YXRlID0gKHN0YXRlKSA9PiBzdGF0ZS50b29sdGlwOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lVG9vbHRpcFBheWxvYWQuanMKZnVuY3Rpb24gb3duS2V5czE1KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTUoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxNShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTUoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTUoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTE1KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTUocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTUodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTUodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTUodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIHNlbGVjdEZpbmFsRGF0YShkYXRhRGVmaW5lZE9uSXRlbSwgZGF0YURlZmluZWRPbkNoYXJ0KSB7CiAgaWYgKGRhdGFEZWZpbmVkT25JdGVtICE9IG51bGwpIHsKICAgIHJldHVybiBkYXRhRGVmaW5lZE9uSXRlbTsKICB9CiAgcmV0dXJuIGRhdGFEZWZpbmVkT25DaGFydDsKfQp2YXIgY29tYmluZVRvb2x0aXBQYXlsb2FkID0gKHRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMsIGFjdGl2ZUluZGV4LCBjaGFydERhdGFTdGF0ZSwgdG9vbHRpcEF4aXNEYXRhS2V5LCBhY3RpdmVMYWJlbCwgdG9vbHRpcFBheWxvYWRTZWFyY2hlciwgdG9vbHRpcEV2ZW50VHlwZSkgPT4gewogIGlmIChhY3RpdmVJbmRleCA9PSBudWxsIHx8IHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIGNoYXJ0RGF0YSwKICAgIGNvbXB1dGVkRGF0YSwKICAgIGRhdGFTdGFydEluZGV4LAogICAgZGF0YUVuZEluZGV4CiAgfSA9IGNoYXJ0RGF0YVN0YXRlOwogIHZhciBpbml0ID0gW107CiAgcmV0dXJuIHRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMucmVkdWNlKChhZ2csIF9yZWYyKSA9PiB7CiAgICB2YXIgX3NldHRpbmdzJGRhdGFLZXk7CiAgICB2YXIgewogICAgICBkYXRhRGVmaW5lZE9uSXRlbSwKICAgICAgc2V0dGluZ3MKICAgIH0gPSBfcmVmMjsKICAgIHZhciBmaW5hbERhdGEgPSBzZWxlY3RGaW5hbERhdGEoZGF0YURlZmluZWRPbkl0ZW0sIGNoYXJ0RGF0YSk7CiAgICB2YXIgc2xpY2VkID0gQXJyYXkuaXNBcnJheShmaW5hbERhdGEpID8gZ2V0U2xpY2VkKGZpbmFsRGF0YSwgZGF0YVN0YXJ0SW5kZXgsIGRhdGFFbmRJbmRleCkgOiBmaW5hbERhdGE7CiAgICB2YXIgZmluYWxEYXRhS2V5ID0gKF9zZXR0aW5ncyRkYXRhS2V5ID0gc2V0dGluZ3MgPT09IG51bGwgfHwgc2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNldHRpbmdzLmRhdGFLZXkpICE9PSBudWxsICYmIF9zZXR0aW5ncyRkYXRhS2V5ICE9PSB2b2lkIDAgPyBfc2V0dGluZ3MkZGF0YUtleSA6IHRvb2x0aXBBeGlzRGF0YUtleTsKICAgIHZhciBmaW5hbE5hbWVLZXkgPSBzZXR0aW5ncyA9PT0gbnVsbCB8fCBzZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2V0dGluZ3MubmFtZUtleTsKICAgIHZhciB0b29sdGlwUGF5bG9hZDsKICAgIGlmICh0b29sdGlwQXhpc0RhdGFLZXkgJiYgQXJyYXkuaXNBcnJheShzbGljZWQpICYmIC8qCiAgICAgKiBmaW5kRW50cnlJbkFycmF5IHdvbid0IHdvcmsgZm9yIFNjYXR0ZXIgYmVjYXVzZSBTY2F0dGVyIHByb3ZpZGVzIGFuIGFycmF5IG9mIGFycmF5cwogICAgICogYXMgdG9vbHRpcCBwYXlsb2FkcyBhbmQgZmluZEVudHJ5SW5BcnJheSBpcyBub3QgcHJlcGFyZWQgdG8gaGFuZGxlIHRoYXQuCiAgICAgKiBTYWQgYnV0IGFsc28gU2NhdHRlckNoYXJ0IG9ubHkgYWxsb3dzICdpdGVtJyB0b29sdGlwRXZlbnRUeXBlCiAgICAgKiBhbmQgYWxzbyB0aGlzIGlzIG9ubHkgYSBwcm9ibGVtIGlmIHRoZXJlIGFyZSBtdWx0aXBsZSBTY2F0dGVycyBhbmQgZWFjaCBoYXMgaXRzIG93biBkYXRhIGFycmF5CiAgICAgKiBzbyBsZXQncyBmaXggdGhhdCBzb21lIG90aGVyIHRpbWUuCiAgICAgKi8KICAgICFBcnJheS5pc0FycmF5KHNsaWNlZFswXSkgJiYgLyoKICAgICAqIElmIHRoZSB0b29sdGlwRXZlbnRUeXBlIGlzICdheGlzJywgd2Ugc2hvdWxkIHNlYXJjaCBmb3IgdGhlIGRhdGFLZXkgaW4gdGhlIHNsaWNlZCBkYXRhCiAgICAgKiBiZWNhdXNlIHRoYW5rcyB0byBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeT1mYWxzZSwgdGhlIG9yZGVyIG9mIGVsZW1lbnRzIGluIHRoZSBhcnJheQogICAgICogbm8gbG9uZ2VyIG1hdGNoZXMgdGhlIG9yZGVyIG9mIGVsZW1lbnRzIGluIHRoZSBvcmlnaW5hbCBkYXRhCiAgICAgKiBhbmQgc28gd2UgbmVlZCB0byBzZWFyY2ggYnkgdGhlIGFjdGl2ZSBkYXRhS2V5ICsgbGFiZWwgcmF0aGVyIHRoYW4gYnkgaW5kZXguCiAgICAgKgogICAgICogVGhlIHNhbWUgaGFwcGVucyBpZiBtdWx0aXBsZSBncmFwaGljYWwgaXRlbXMgYXJlIHByZXNlbnQgaW4gdGhlIGNoYXJ0CiAgICAgKiBhbmQgZWFjaCBvZiB0aGVtIGhhcyBpdHMgb3duIGRhdGEgYXJyYXkuIFRob3NlIGFycmF5cyBnZXQgY29uY2F0ZW5hdGVkCiAgICAgKiBhbmQgYWdhaW4gdGhlIHRvb2x0aXAgaW5kZXggbm8gbG9uZ2VyIG1hdGNoZXMgdGhlIG9yaWdpbmFsIGRhdGEuCiAgICAgKgogICAgICogT24gdGhlIG90aGVyIGhhbmQgdGhlIHRvb2x0aXBFdmVudFR5cGUgJ2l0ZW0nIHNob3VsZCBhbHdheXMgc2VhcmNoIGJ5IGluZGV4CiAgICAgKiBiZWNhdXNlIHdlIGdldCB0aGUgaW5kZXggZnJvbSBpbnRlcmFjdGluZyBvdmVyIHRoZSBpbmRpdmlkdWFsIGVsZW1lbnRzCiAgICAgKiB3aGljaCBpcyBhbHdheXMgYWNjdXJhdGUsIGlycmVzcGVjdGl2ZSBvZiB0aGUgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkgc2V0dGluZy4KICAgICAqLwogICAgdG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICAgIHRvb2x0aXBQYXlsb2FkID0gZmluZEVudHJ5SW5BcnJheShzbGljZWQsIHRvb2x0aXBBeGlzRGF0YUtleSwgYWN0aXZlTGFiZWwpOwogICAgfSBlbHNlIHsKICAgICAgdG9vbHRpcFBheWxvYWQgPSB0b29sdGlwUGF5bG9hZFNlYXJjaGVyKHNsaWNlZCwgYWN0aXZlSW5kZXgsIGNvbXB1dGVkRGF0YSwgZmluYWxOYW1lS2V5KTsKICAgIH0KICAgIGlmIChBcnJheS5pc0FycmF5KHRvb2x0aXBQYXlsb2FkKSkgewogICAgICB0b29sdGlwUGF5bG9hZC5mb3JFYWNoKChpdGVtKSA9PiB7CiAgICAgICAgdmFyIG5ld1NldHRpbmdzID0gX29iamVjdFNwcmVhZDE1KF9vYmplY3RTcHJlYWQxNSh7fSwgc2V0dGluZ3MpLCB7fSwgewogICAgICAgICAgbmFtZTogaXRlbS5uYW1lLAogICAgICAgICAgdW5pdDogaXRlbS51bml0LAogICAgICAgICAgLy8gY29sb3IgYW5kIGZpbGwgYXJlIGVyYXNlZCB0byBrZWVwIDEwMCUgdGhlIGlkZW50aWNhbCBiZWhhdmlvdXIgdG8gcmVjaGFydHMgMi54IC0gYnV0IHRoZXJlJ3Mgbm90aGluZyBzdG9wcGluZyB1cyBmcm9tIHJldHVybmluZyB0aGVtIGhlcmUuIEl0J3MgdGVjaG5pY2FsbHkgYSBicmVha2luZyBjaGFuZ2UuCiAgICAgICAgICBjb2xvcjogdm9pZCAwLAogICAgICAgICAgLy8gY29sb3IgYW5kIGZpbGwgYXJlIGVyYXNlZCB0byBrZWVwIDEwMCUgdGhlIGlkZW50aWNhbCBiZWhhdmlvdXIgdG8gcmVjaGFydHMgMi54IC0gYnV0IHRoZXJlJ3Mgbm90aGluZyBzdG9wcGluZyB1cyBmcm9tIHJldHVybmluZyB0aGVtIGhlcmUuIEl0J3MgdGVjaG5pY2FsbHkgYSBicmVha2luZyBjaGFuZ2UuCiAgICAgICAgICBmaWxsOiB2b2lkIDAKICAgICAgICB9KTsKICAgICAgICBhZ2cucHVzaChnZXRUb29sdGlwRW50cnkoewogICAgICAgICAgdG9vbHRpcEVudHJ5U2V0dGluZ3M6IG5ld1NldHRpbmdzLAogICAgICAgICAgZGF0YUtleTogaXRlbS5kYXRhS2V5LAogICAgICAgICAgcGF5bG9hZDogaXRlbS5wYXlsb2FkLAogICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBnZXRWYWx1ZUJ5RGF0YUtleSBkb2VzIG5vdCB2YWxpZGF0ZSB0aGUgb3V0cHV0IHR5cGUKICAgICAgICAgIHZhbHVlOiBnZXRWYWx1ZUJ5RGF0YUtleShpdGVtLnBheWxvYWQsIGl0ZW0uZGF0YUtleSksCiAgICAgICAgICBuYW1lOiBpdGVtLm5hbWUKICAgICAgICB9KSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgdmFyIF9nZXRWYWx1ZUJ5RGF0YUtleTsKICAgICAgYWdnLnB1c2goZ2V0VG9vbHRpcEVudHJ5KHsKICAgICAgICB0b29sdGlwRW50cnlTZXR0aW5nczogc2V0dGluZ3MsCiAgICAgICAgZGF0YUtleTogZmluYWxEYXRhS2V5LAogICAgICAgIHBheWxvYWQ6IHRvb2x0aXBQYXlsb2FkLAogICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgZ2V0VmFsdWVCeURhdGFLZXkgZG9lcyBub3QgdmFsaWRhdGUgdGhlIG91dHB1dCB0eXBlCiAgICAgICAgdmFsdWU6IGdldFZhbHVlQnlEYXRhS2V5KHRvb2x0aXBQYXlsb2FkLCBmaW5hbERhdGFLZXkpLAogICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgZ2V0VmFsdWVCeURhdGFLZXkgZG9lcyBub3QgdmFsaWRhdGUgdGhlIG91dHB1dCB0eXBlCiAgICAgICAgbmFtZTogKF9nZXRWYWx1ZUJ5RGF0YUtleSA9IGdldFZhbHVlQnlEYXRhS2V5KHRvb2x0aXBQYXlsb2FkLCBmaW5hbE5hbWVLZXkpKSAhPT0gbnVsbCAmJiBfZ2V0VmFsdWVCeURhdGFLZXkgIT09IHZvaWQgMCA/IF9nZXRWYWx1ZUJ5RGF0YUtleSA6IHNldHRpbmdzID09PSBudWxsIHx8IHNldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXR0aW5ncy5uYW1lCiAgICAgIH0pKTsKICAgIH0KICAgIHJldHVybiBhZ2c7CiAgfSwgaW5pdCk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvdG9vbHRpcFNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNSZWFsU2NhbGVUeXBlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0SGFzQmFyLCBzZWxlY3RDaGFydE5hbWUsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVSZWFsU2NhbGVUeXBlKTsKdmFyIHNlbGVjdEFsbFVuZmlsdGVyZWRHcmFwaGljYWxJdGVtcyA9IGNyZWF0ZVNlbGVjdG9yKFsoc3RhdGUpID0+IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLmNhcnRlc2lhbkl0ZW1zLCAoc3RhdGUpID0+IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLnBvbGFySXRlbXNdLCAoY2FydGVzaWFuSXRlbXMsIHBvbGFySXRlbXMpID0+IFsuLi5jYXJ0ZXNpYW5JdGVtcywgLi4ucG9sYXJJdGVtc10pOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNQcmVkaWNhdGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNUeXBlLCBzZWxlY3RUb29sdGlwQXhpc0lkXSwgaXRlbUF4aXNQcmVkaWNhdGUpOwp2YXIgc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5ncyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxVbmZpbHRlcmVkR3JhcGhpY2FsSXRlbXMsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1ByZWRpY2F0ZV0sIGNvbWJpbmVHcmFwaGljYWxJdGVtc1NldHRpbmdzLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IGVtcHR5QXJyYXlzQXJlRXF1YWxDaGVjawogIH0KfSk7CnZhciBzZWxlY3RBbGxTdGFja2VkR3JhcGhpY2FsSXRlbXNTZXR0aW5ncyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxHcmFwaGljYWxJdGVtc1NldHRpbmdzXSwgKGdyYXBoaWNhbEl0ZW1zKSA9PiBncmFwaGljYWxJdGVtcy5maWx0ZXIoaXNTdGFja2VkKSk7CnZhciBzZWxlY3RUb29sdGlwR3JhcGhpY2FsSXRlbXNEYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3NdLCBjb21iaW5lR3JhcGhpY2FsSXRlbXNEYXRhLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IGVtcHR5QXJyYXlzQXJlRXF1YWxDaGVjawogIH0KfSk7CnZhciBzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwR3JhcGhpY2FsSXRlbXNEYXRhLCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlc10sIGNvbWJpbmVEaXNwbGF5ZWREYXRhKTsKdmFyIHNlbGVjdFRvb2x0aXBTdGFja2VkRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxTdGFja2VkR3JhcGhpY2FsSXRlbXNTZXR0aW5ncywgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHNlbGVjdFRvb2x0aXBBeGlzXSwgY29tYmluZURpc3BsYXllZFN0YWNrZWREYXRhKTsKdmFyIHNlbGVjdEFsbFRvb2x0aXBBcHBsaWVkVmFsdWVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBEaXNwbGF5ZWREYXRhLCBzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5nc10sIGNvbWJpbmVBcHBsaWVkVmFsdWVzKTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluRGVmaW5pdGlvbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc10sIGdldERvbWFpbkRlZmluaXRpb24pOwp2YXIgc2VsZWN0VG9vbHRpcERhdGFPdmVyZmxvdyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc10sIChheGlzU2V0dGluZ3MpID0+IGF4aXNTZXR0aW5ncy5hbGxvd0RhdGFPdmVyZmxvdyk7CnZhciBzZWxlY3RUb29sdGlwRG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc0RvbWFpbkRlZmluaXRpb24sIHNlbGVjdFRvb2x0aXBEYXRhT3ZlcmZsb3ddLCBudW1lcmljYWxEb21haW5TcGVjaWZpZWRXaXRob3V0UmVxdWlyaW5nRGF0YSk7CnZhciBzZWxlY3RBbGxTdGFja2VkR3JhcGhpY2FsSXRlbXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5nc10sIChncmFwaGljYWxJdGVtcykgPT4gZ3JhcGhpY2FsSXRlbXMuZmlsdGVyKGlzU3RhY2tlZCkpOwp2YXIgc2VsZWN0VG9vbHRpcFN0YWNrR3JvdXBzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGFja2VkRGF0YSwgc2VsZWN0QWxsU3RhY2tlZEdyYXBoaWNhbEl0ZW1zLCBzZWxlY3RTdGFja09mZnNldFR5cGUsIHNlbGVjdFJldmVyc2VTdGFja09yZGVyXSwgY29tYmluZVN0YWNrR3JvdXBzKTsKdmFyIHNlbGVjdFRvb2x0aXBEb21haW5PZlN0YWNrR3JvdXBzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGFja0dyb3Vwcywgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZXNdLCBjb21iaW5lRG9tYWluT2ZTdGFja0dyb3Vwcyk7CnZhciBzZWxlY3RUb29sdGlwSXRlbXNTZXR0aW5nc0V4Y2VwdFN0YWNrZWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5nc10sIGZpbHRlckdyYXBoaWNhbE5vdFN0YWNrZWRJdGVtcyk7CnZhciBzZWxlY3REb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlczIgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwSXRlbXNTZXR0aW5nc0V4Y2VwdFN0YWNrZWQsIHNlbGVjdEFsbEVycm9yQmFyU2V0dGluZ3MsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVEb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlcywgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBudW1iZXJEb21haW5FcXVhbGl0eUNoZWNrCiAgfQp9KTsKdmFyIHNlbGVjdFJlZmVyZW5jZURvdHNCeVRvb2x0aXBBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZURvdHMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VEb3RzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZURvdHNCeVRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lRG90c0RvbWFpbik7CnZhciBzZWxlY3RSZWZlcmVuY2VBcmVhc0J5VG9vbHRpcEF4aXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlQXJlYXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VBcmVhc0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VBcmVhc0J5VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVBcmVhc0RvbWFpbik7CnZhciBzZWxlY3RSZWZlcmVuY2VMaW5lc0J5VG9vbHRpcEF4aXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlTGluZXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VMaW5lc0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VMaW5lc0J5VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVMaW5lc0RvbWFpbik7CnZhciBzZWxlY3RUb29sdGlwUmVmZXJlbmNlRWxlbWVudHNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFJlZmVyZW5jZURvdHNEb21haW4sIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VMaW5lc0RvbWFpbiwgc2VsZWN0VG9vbHRpcFJlZmVyZW5jZUFyZWFzRG9tYWluXSwgbWVyZ2VEb21haW5zKTsKdmFyIHNlbGVjdFRvb2x0aXBOdW1lcmljYWxEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluRGVmaW5pdGlvbiwgc2VsZWN0VG9vbHRpcERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZXMsIHNlbGVjdFRvb2x0aXBEb21haW5PZlN0YWNrR3JvdXBzLCBzZWxlY3REb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlczIsIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VFbGVtZW50c0RvbWFpbiwgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVOdW1lcmljYWxEb21haW4pOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YSwgc2VsZWN0QWxsVG9vbHRpcEFwcGxpZWRWYWx1ZXMsIHNlbGVjdFN0YWNrT2Zmc2V0VHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNUeXBlLCBzZWxlY3RUb29sdGlwTnVtZXJpY2FsRG9tYWluXSwgY29tYmluZUF4aXNEb21haW4pOwp2YXIgc2VsZWN0VG9vbHRpcE5pY2VUaWNrcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc0RvbWFpbiwgc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzUmVhbFNjYWxlVHlwZV0sIGNvbWJpbmVOaWNlVGlja3MpOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNEb21haW5JbmNsdWRpbmdOaWNlVGlja3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluLCBzZWxlY3RUb29sdGlwTmljZVRpY2tzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lQXhpc0RvbWFpbldpdGhOaWNlVGlja3MpOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZSA9IChzdGF0ZSkgPT4gewogIHZhciBheGlzVHlwZSA9IHNlbGVjdFRvb2x0aXBBeGlzVHlwZShzdGF0ZSk7CiAgdmFyIGF4aXNJZCA9IHNlbGVjdFRvb2x0aXBBeGlzSWQoc3RhdGUpOwogIHZhciBpc1Bhbm9yYW1hID0gZmFsc2U7CiAgcmV0dXJuIHNlbGVjdEF4aXNSYW5nZShzdGF0ZSwgYXhpc1R5cGUsIGF4aXNJZCwgaXNQYW5vcmFtYSk7Cn07CnZhciBzZWxlY3RUb29sdGlwQXhpc1JhbmdlV2l0aFJldmVyc2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzUmFuZ2VdLCBjb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UpOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNTY2FsZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNSZWFsU2NhbGVUeXBlLCBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbkluY2x1ZGluZ05pY2VUaWNrcywgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZVdpdGhSZXZlcnNlXSwgY29tYmluZVNjYWxlRnVuY3Rpb24pOwp2YXIgc2VsZWN0VG9vbHRpcER1cGxpY2F0ZURvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsVG9vbHRpcEFwcGxpZWRWYWx1ZXMsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lRHVwbGljYXRlRG9tYWluKTsKdmFyIHNlbGVjdFRvb2x0aXBDYXRlZ29yaWNhbERvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsVG9vbHRpcEFwcGxpZWRWYWx1ZXMsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lQ2F0ZWdvcmljYWxEb21haW4pOwp2YXIgY29tYmluZVRpY2tzT2ZUb29sdGlwQXhpcyA9IChsYXlvdXQsIGF4aXMsIHJlYWxTY2FsZVR5cGUsIHNjYWxlLCByYW5nZTQsIGR1cGxpY2F0ZURvbWFpbiwgY2F0ZWdvcmljYWxEb21haW4sIGF4aXNUeXBlKSA9PiB7CiAgaWYgKCFheGlzKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgdHlwZQogIH0gPSBheGlzOwogIHZhciBpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCBheGlzVHlwZSk7CiAgaWYgKCFzY2FsZSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIG9mZnNldEZvckJhbmQgPSByZWFsU2NhbGVUeXBlID09PSAic2NhbGVCYW5kIiAmJiBzY2FsZS5iYW5kd2lkdGggPyBzY2FsZS5iYW5kd2lkdGgoKSAvIDIgOiAyOwogIHZhciBvZmZzZXQgPSB0eXBlID09PSAiY2F0ZWdvcnkiICYmIHNjYWxlLmJhbmR3aWR0aCA/IHNjYWxlLmJhbmR3aWR0aCgpIC8gb2Zmc2V0Rm9yQmFuZCA6IDA7CiAgb2Zmc2V0ID0gYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiICYmIHJhbmdlNCAhPSBudWxsICYmIChyYW5nZTQgPT09IG51bGwgfHwgcmFuZ2U0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiByYW5nZTQubGVuZ3RoKSA+PSAyID8gbWF0aFNpZ24ocmFuZ2U0WzBdIC0gcmFuZ2U0WzFdKSAqIDIgKiBvZmZzZXQgOiBvZmZzZXQ7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgY2F0ZWdvcmljYWxEb21haW4pIHsKICAgIHJldHVybiBjYXRlZ29yaWNhbERvbWFpbi5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIGluZGV4LAogICAgICBvZmZzZXQKICAgIH0pKTsKICB9CiAgcmV0dXJuIHNjYWxlLmRvbWFpbigpLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgdmFsdWU6IGR1cGxpY2F0ZURvbWFpbiA/IGR1cGxpY2F0ZURvbWFpbltlbnRyeV0gOiBlbnRyeSwKICAgIGluZGV4LAogICAgb2Zmc2V0CiAgfSkpOwp9Owp2YXIgc2VsZWN0VG9vbHRpcEF4aXNUaWNrcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzUmVhbFNjYWxlVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNTY2FsZSwgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZSwgc2VsZWN0VG9vbHRpcER1cGxpY2F0ZURvbWFpbiwgc2VsZWN0VG9vbHRpcENhdGVnb3JpY2FsRG9tYWluLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lVGlja3NPZlRvb2x0aXBBeGlzKTsKdmFyIHNlbGVjdFRvb2x0aXBFdmVudFR5cGUyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdERlZmF1bHRUb29sdGlwRXZlbnRUeXBlLCBzZWxlY3RWYWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzLCBzZWxlY3RUb29sdGlwU2V0dGluZ3NdLCAoZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZSwgc2V0dGluZ3MpID0+IGNvbWJpbmVUb29sdGlwRXZlbnRUeXBlKHNldHRpbmdzLnNoYXJlZCwgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZSkpOwp2YXIgc2VsZWN0VG9vbHRpcFRyaWdnZXIgPSAoc3RhdGUpID0+IHN0YXRlLnRvb2x0aXAuc2V0dGluZ3MudHJpZ2dlcjsKdmFyIHNlbGVjdERlZmF1bHRJbmRleCA9IChzdGF0ZSkgPT4gc3RhdGUudG9vbHRpcC5zZXR0aW5ncy5kZWZhdWx0SW5kZXg7CnZhciBzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwU3RhdGUsIHNlbGVjdFRvb2x0aXBFdmVudFR5cGUyLCBzZWxlY3RUb29sdGlwVHJpZ2dlciwgc2VsZWN0RGVmYXVsdEluZGV4XSwgY29tYmluZVRvb2x0aXBJbnRlcmFjdGlvblN0YXRlKTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSwgc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEsIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSwgc2VsZWN0VG9vbHRpcEF4aXNEb21haW5dLCBjb21iaW5lQWN0aXZlVG9vbHRpcEluZGV4KTsKdmFyIHNlbGVjdEFjdGl2ZUxhYmVsID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzVGlja3MsIHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleF0sIGNvbWJpbmVBY3RpdmVMYWJlbCk7CnZhciBzZWxlY3RBY3RpdmVUb29sdGlwRGF0YUtleSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZV0sICh0b29sdGlwSW50ZXJhY3Rpb24pID0+IHsKICBpZiAoIXRvb2x0aXBJbnRlcmFjdGlvbikgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIHRvb2x0aXBJbnRlcmFjdGlvbi5kYXRhS2V5Owp9KTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBHcmFwaGljYWxJdGVtSWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGVdLCAodG9vbHRpcEludGVyYWN0aW9uKSA9PiB7CiAgaWYgKCF0b29sdGlwSW50ZXJhY3Rpb24pIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiB0b29sdGlwSW50ZXJhY3Rpb24uZ3JhcGhpY2FsSXRlbUlkOwp9KTsKdmFyIHNlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFN0YXRlLCBzZWxlY3RUb29sdGlwRXZlbnRUeXBlMiwgc2VsZWN0VG9vbHRpcFRyaWdnZXIsIHNlbGVjdERlZmF1bHRJbmRleF0sIGNvbWJpbmVUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zKTsKdmFyIHNlbGVjdFRvb2x0aXBDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgc2VsZWN0RGVmYXVsdEluZGV4LCBzZWxlY3RUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zLCBzZWxlY3RUb29sdGlwUGF5bG9hZFNlYXJjaGVyXSwgY29tYmluZUNvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXgpOwp2YXIgc2VsZWN0QWN0aXZlVG9vbHRpcENvb3JkaW5hdGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUsIHNlbGVjdFRvb2x0aXBDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4XSwgKHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLCBkZWZhdWx0SW5kZXhDb29yZGluYXRlKSA9PiB7CiAgaWYgKHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlICE9PSBudWxsICYmIHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlICE9PSB2b2lkIDAgJiYgdG9vbHRpcEludGVyYWN0aW9uU3RhdGUuY29vcmRpbmF0ZSkgewogICAgcmV0dXJuIHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmNvb3JkaW5hdGU7CiAgfQogIHJldHVybiBkZWZhdWx0SW5kZXhDb29yZGluYXRlOwp9KTsKdmFyIHNlbGVjdElzVG9vbHRpcEFjdGl2ZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZV0sICh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSkgPT4gdG9vbHRpcEludGVyYWN0aW9uU3RhdGUuYWN0aXZlKTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBQYXlsb2FkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMsIHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleCwgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSwgc2VsZWN0QWN0aXZlTGFiZWwsIHNlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsIHNlbGVjdFRvb2x0aXBFdmVudFR5cGUyXSwgY29tYmluZVRvb2x0aXBQYXlsb2FkKTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBEYXRhUG9pbnRzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFjdGl2ZVRvb2x0aXBQYXlsb2FkXSwgKHBheWxvYWQpID0+IHsKICBpZiAocGF5bG9hZCA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgZGF0YVBvaW50cyA9IHBheWxvYWQubWFwKChwKSA9PiBwLnBheWxvYWQpLmZpbHRlcigocCkgPT4gcCAhPSBudWxsKTsKICByZXR1cm4gQXJyYXkuZnJvbShuZXcgU2V0KGRhdGFQb2ludHMpKTsKfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L3VzZVRvb2x0aXBBeGlzLmpzCmZ1bmN0aW9uIG93bktleXMxNihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDE2KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTYoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTE2KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czE2KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxNihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTE2KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTE2KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTE2KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTE2KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgdXNlVG9vbHRpcEF4aXMgPSAoKSA9PiB1c2VBcHBTZWxlY3RvcihzZWxlY3RUb29sdGlwQXhpcyk7CnZhciB1c2VUb29sdGlwQXhpc0JhbmRTaXplID0gKCkgPT4gewogIHZhciB0b29sdGlwQXhpcyA9IHVzZVRvb2x0aXBBeGlzKCk7CiAgdmFyIHRvb2x0aXBUaWNrcyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFRvb2x0aXBBeGlzVGlja3MpOwogIHZhciB0b29sdGlwQXhpc1NjYWxlID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0VG9vbHRpcEF4aXNTY2FsZSk7CiAgaWYgKCF0b29sdGlwQXhpcyB8fCAhdG9vbHRpcEF4aXNTY2FsZSkgewogICAgcmV0dXJuIGdldEJhbmRTaXplT2ZBeGlzKHZvaWQgMCwgdG9vbHRpcFRpY2tzKTsKICB9CiAgcmV0dXJuIGdldEJhbmRTaXplT2ZBeGlzKF9vYmplY3RTcHJlYWQxNihfb2JqZWN0U3ByZWFkMTYoe30sIHRvb2x0aXBBeGlzKSwge30sIHsKICAgIHNjYWxlOiB0b29sdGlwQXhpc1NjYWxlCiAgfSksIHRvb2x0aXBUaWNrcyk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0b3JzLmpzCnZhciBpbXBvcnRfc29ydEJ5NCA9IF9fdG9FU00ocmVxdWlyZV9zb3J0QnkyKCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9nZXRBY3RpdmVDb29yZGluYXRlLmpzCmZ1bmN0aW9uIG93bktleXMxNyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDE3KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTcoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTE3KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czE3KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxNyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTE3KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTE3KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTE3KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTE3KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgZ2V0QWN0aXZlQ2FydGVzaWFuQ29vcmRpbmF0ZSA9IChsYXlvdXQsIHRvb2x0aXBUaWNrcywgYWN0aXZlSW5kZXgsIHBvaW50ZXIpID0+IHsKICB2YXIgZW50cnkgPSB0b29sdGlwVGlja3MuZmluZCgodGljaykgPT4gdGljayAmJiB0aWNrLmluZGV4ID09PSBhY3RpdmVJbmRleCk7CiAgaWYgKGVudHJ5KSB7CiAgICBpZiAobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiBlbnRyeS5jb29yZGluYXRlLAogICAgICAgIHk6IHBvaW50ZXIuY2hhcnRZCiAgICAgIH07CiAgICB9CiAgICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogcG9pbnRlci5jaGFydFgsCiAgICAgICAgeTogZW50cnkuY29vcmRpbmF0ZQogICAgICB9OwogICAgfQogIH0KICByZXR1cm4gewogICAgeDogMCwKICAgIHk6IDAKICB9Owp9Owp2YXIgZ2V0QWN0aXZlUG9sYXJDb29yZGluYXRlID0gKGxheW91dCwgdG9vbHRpcFRpY2tzLCBhY3RpdmVJbmRleCwgcmFuZ2VPYmopID0+IHsKICB2YXIgZW50cnkgPSB0b29sdGlwVGlja3MuZmluZCgodGljaykgPT4gdGljayAmJiB0aWNrLmluZGV4ID09PSBhY3RpdmVJbmRleCk7CiAgaWYgKGVudHJ5KSB7CiAgICBpZiAobGF5b3V0ID09PSAiY2VudHJpYyIpIHsKICAgICAgdmFyIF9hbmdsZSA9IGVudHJ5LmNvb3JkaW5hdGU7CiAgICAgIHZhciB7CiAgICAgICAgcmFkaXVzOiBfcmFkaXVzCiAgICAgIH0gPSByYW5nZU9iajsKICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQxNyhfb2JqZWN0U3ByZWFkMTcoX29iamVjdFNwcmVhZDE3KHt9LCByYW5nZU9iaiksIHBvbGFyVG9DYXJ0ZXNpYW4ocmFuZ2VPYmouY3gsIHJhbmdlT2JqLmN5LCBfcmFkaXVzLCBfYW5nbGUpKSwge30sIHsKICAgICAgICBhbmdsZTogX2FuZ2xlLAogICAgICAgIHJhZGl1czogX3JhZGl1cwogICAgICB9KTsKICAgIH0KICAgIHZhciByYWRpdXMgPSBlbnRyeS5jb29yZGluYXRlOwogICAgdmFyIHsKICAgICAgYW5nbGUKICAgIH0gPSByYW5nZU9iajsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTcoX29iamVjdFNwcmVhZDE3KF9vYmplY3RTcHJlYWQxNyh7fSwgcmFuZ2VPYmopLCBwb2xhclRvQ2FydGVzaWFuKHJhbmdlT2JqLmN4LCByYW5nZU9iai5jeSwgcmFkaXVzLCBhbmdsZSkpLCB7fSwgewogICAgICBhbmdsZSwKICAgICAgcmFkaXVzCiAgICB9KTsKICB9CiAgcmV0dXJuIHsKICAgIGFuZ2xlOiAwLAogICAgY2xvY2tXaXNlOiBmYWxzZSwKICAgIGN4OiAwLAogICAgY3k6IDAsCiAgICBlbmRBbmdsZTogMCwKICAgIGlubmVyUmFkaXVzOiAwLAogICAgb3V0ZXJSYWRpdXM6IDAsCiAgICByYWRpdXM6IDAsCiAgICBzdGFydEFuZ2xlOiAwLAogICAgeDogMCwKICAgIHk6IDAKICB9Owp9OwpmdW5jdGlvbiBpc0luQ2FydGVzaWFuUmFuZ2UocG9pbnRlciwgb2Zmc2V0KSB7CiAgdmFyIHsKICAgIGNoYXJ0WDogeDIsCiAgICBjaGFydFk6IHkyCiAgfSA9IHBvaW50ZXI7CiAgcmV0dXJuIHgyID49IG9mZnNldC5sZWZ0ICYmIHgyIDw9IG9mZnNldC5sZWZ0ICsgb2Zmc2V0LndpZHRoICYmIHkyID49IG9mZnNldC50b3AgJiYgeTIgPD0gb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQ7Cn0KdmFyIGNhbGN1bGF0ZUFjdGl2ZVRpY2tJbmRleCA9IChjb29yZGluYXRlLCB0aWNrczIsIHVuc29ydGVkVGlja3MsIGF4aXNUeXBlLCByYW5nZTQpID0+IHsKICB2YXIgX3RpY2tzJGxlbmd0aDsKICB2YXIgaW5kZXggPSAtMTsKICB2YXIgbGVuID0gKF90aWNrcyRsZW5ndGggPSB0aWNrczIgPT09IG51bGwgfHwgdGlja3MyID09PSB2b2lkIDAgPyB2b2lkIDAgOiB0aWNrczIubGVuZ3RoKSAhPT0gbnVsbCAmJiBfdGlja3MkbGVuZ3RoICE9PSB2b2lkIDAgPyBfdGlja3MkbGVuZ3RoIDogMDsKICBpZiAobGVuIDw9IDEgfHwgY29vcmRpbmF0ZSA9PSBudWxsKSB7CiAgICByZXR1cm4gMDsKICB9CiAgaWYgKGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIiAmJiByYW5nZTQgIT0gbnVsbCAmJiBNYXRoLmFicyhNYXRoLmFicyhyYW5nZTRbMV0gLSByYW5nZTRbMF0pIC0gMzYwKSA8PSAxZS02KSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHZhciBiZWZvcmUgPSBpID4gMCA/IHVuc29ydGVkVGlja3NbaSAtIDFdLmNvb3JkaW5hdGUgOiB1bnNvcnRlZFRpY2tzW2xlbiAtIDFdLmNvb3JkaW5hdGU7CiAgICAgIHZhciBjdXIgPSB1bnNvcnRlZFRpY2tzW2ldLmNvb3JkaW5hdGU7CiAgICAgIHZhciBhZnRlciA9IGkgPj0gbGVuIC0gMSA/IHVuc29ydGVkVGlja3NbMF0uY29vcmRpbmF0ZSA6IHVuc29ydGVkVGlja3NbaSArIDFdLmNvb3JkaW5hdGU7CiAgICAgIHZhciBzYW1lRGlyZWN0aW9uQ29vcmQgPSB2b2lkIDA7CiAgICAgIGlmIChtYXRoU2lnbihjdXIgLSBiZWZvcmUpICE9PSBtYXRoU2lnbihhZnRlciAtIGN1cikpIHsKICAgICAgICB2YXIgZGlmZkludGVydmFsID0gW107CiAgICAgICAgaWYgKG1hdGhTaWduKGFmdGVyIC0gY3VyKSA9PT0gbWF0aFNpZ24ocmFuZ2U0WzFdIC0gcmFuZ2U0WzBdKSkgewogICAgICAgICAgc2FtZURpcmVjdGlvbkNvb3JkID0gYWZ0ZXI7CiAgICAgICAgICB2YXIgY3VySW5SYW5nZSA9IGN1ciArIHJhbmdlNFsxXSAtIHJhbmdlNFswXTsKICAgICAgICAgIGRpZmZJbnRlcnZhbFswXSA9IE1hdGgubWluKGN1ckluUmFuZ2UsIChjdXJJblJhbmdlICsgYmVmb3JlKSAvIDIpOwogICAgICAgICAgZGlmZkludGVydmFsWzFdID0gTWF0aC5tYXgoY3VySW5SYW5nZSwgKGN1ckluUmFuZ2UgKyBiZWZvcmUpIC8gMik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNhbWVEaXJlY3Rpb25Db29yZCA9IGJlZm9yZTsKICAgICAgICAgIHZhciBhZnRlckluUmFuZ2UgPSBhZnRlciArIHJhbmdlNFsxXSAtIHJhbmdlNFswXTsKICAgICAgICAgIGRpZmZJbnRlcnZhbFswXSA9IE1hdGgubWluKGN1ciwgKGFmdGVySW5SYW5nZSArIGN1cikgLyAyKTsKICAgICAgICAgIGRpZmZJbnRlcnZhbFsxXSA9IE1hdGgubWF4KGN1ciwgKGFmdGVySW5SYW5nZSArIGN1cikgLyAyKTsKICAgICAgICB9CiAgICAgICAgdmFyIHNhbWVJbnRlcnZhbCA9IFtNYXRoLm1pbihjdXIsIChzYW1lRGlyZWN0aW9uQ29vcmQgKyBjdXIpIC8gMiksIE1hdGgubWF4KGN1ciwgKHNhbWVEaXJlY3Rpb25Db29yZCArIGN1cikgLyAyKV07CiAgICAgICAgaWYgKGNvb3JkaW5hdGUgPiBzYW1lSW50ZXJ2YWxbMF0gJiYgY29vcmRpbmF0ZSA8PSBzYW1lSW50ZXJ2YWxbMV0gfHwgY29vcmRpbmF0ZSA+PSBkaWZmSW50ZXJ2YWxbMF0gJiYgY29vcmRpbmF0ZSA8PSBkaWZmSW50ZXJ2YWxbMV0pIHsKICAgICAgICAgICh7CiAgICAgICAgICAgIGluZGV4CiAgICAgICAgICB9ID0gdW5zb3J0ZWRUaWNrc1tpXSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIG1pblZhbHVlID0gTWF0aC5taW4oYmVmb3JlLCBhZnRlcik7CiAgICAgICAgdmFyIG1heFZhbHVlID0gTWF0aC5tYXgoYmVmb3JlLCBhZnRlcik7CiAgICAgICAgaWYgKGNvb3JkaW5hdGUgPiAobWluVmFsdWUgKyBjdXIpIC8gMiAmJiBjb29yZGluYXRlIDw9IChtYXhWYWx1ZSArIGN1cikgLyAyKSB7CiAgICAgICAgICAoewogICAgICAgICAgICBpbmRleAogICAgICAgICAgfSA9IHVuc29ydGVkVGlja3NbaV0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSBlbHNlIGlmICh0aWNrczIpIHsKICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBsZW47IF9pKyspIHsKICAgICAgaWYgKF9pID09PSAwICYmIGNvb3JkaW5hdGUgPD0gKHRpY2tzMltfaV0uY29vcmRpbmF0ZSArIHRpY2tzMltfaSArIDFdLmNvb3JkaW5hdGUpIC8gMiB8fCBfaSA+IDAgJiYgX2kgPCBsZW4gLSAxICYmIGNvb3JkaW5hdGUgPiAodGlja3MyW19pXS5jb29yZGluYXRlICsgdGlja3MyW19pIC0gMV0uY29vcmRpbmF0ZSkgLyAyICYmIGNvb3JkaW5hdGUgPD0gKHRpY2tzMltfaV0uY29vcmRpbmF0ZSArIHRpY2tzMltfaSArIDFdLmNvb3JkaW5hdGUpIC8gMiB8fCBfaSA9PT0gbGVuIC0gMSAmJiBjb29yZGluYXRlID4gKHRpY2tzMltfaV0uY29vcmRpbmF0ZSArIHRpY2tzMltfaSAtIDFdLmNvb3JkaW5hdGUpIC8gMikgewogICAgICAgICh7CiAgICAgICAgICBpbmRleAogICAgICAgIH0gPSB0aWNrczJbX2ldKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gaW5kZXg7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0b3JzLmpzCnZhciB1c2VDaGFydE5hbWUgPSAoKSA9PiB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0TmFtZSk7Cn07CnZhciBwaWNrVG9vbHRpcEV2ZW50VHlwZSA9IChfc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUpID0+IHRvb2x0aXBFdmVudFR5cGU7CnZhciBwaWNrVHJpZ2dlciA9IChfc3RhdGUsIF90b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyKSA9PiB0cmlnZ2VyOwp2YXIgcGlja0RlZmF1bHRJbmRleCA9IChfc3RhdGUsIF90b29sdGlwRXZlbnRUeXBlLCBfdHJpZ2dlciwgZGVmYXVsdEluZGV4KSA9PiBkZWZhdWx0SW5kZXg7CnZhciBzZWxlY3RPcmRlcmVkVG9vbHRpcFRpY2tzID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgKHRpY2tzMikgPT4gKDAsIGltcG9ydF9zb3J0Qnk0LmRlZmF1bHQpKHRpY2tzMiwgKG8pID0+IG8uY29vcmRpbmF0ZSkpOwp2YXIgc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGF0ZSwgcGlja1Rvb2x0aXBFdmVudFR5cGUsIHBpY2tUcmlnZ2VyLCBwaWNrRGVmYXVsdEluZGV4XSwgY29tYmluZVRvb2x0aXBJbnRlcmFjdGlvblN0YXRlKTsKdmFyIHNlbGVjdEFjdGl2ZUluZGV4ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlMiwgc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEsIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSwgc2VsZWN0VG9vbHRpcEF4aXNEb21haW5dLCBjb21iaW5lQWN0aXZlVG9vbHRpcEluZGV4KTsKdmFyIHNlbGVjdFRvb2x0aXBEYXRhS2V5ID0gKHN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyKSA9PiB7CiAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHRvb2x0aXBTdGF0ZSA9IHNlbGVjdFRvb2x0aXBTdGF0ZShzdGF0ZSk7CiAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgaWYgKHRyaWdnZXIgPT09ICJob3ZlciIpIHsKICAgICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5heGlzSW50ZXJhY3Rpb24uaG92ZXIuZGF0YUtleTsKICAgIH0KICAgIHJldHVybiB0b29sdGlwU3RhdGUuYXhpc0ludGVyYWN0aW9uLmNsaWNrLmRhdGFLZXk7CiAgfQogIGlmICh0cmlnZ2VyID09PSAiaG92ZXIiKSB7CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5kYXRhS2V5OwogIH0KICByZXR1cm4gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5kYXRhS2V5Owp9Owp2YXIgc2VsZWN0VG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9uczIgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFN0YXRlLCBwaWNrVG9vbHRpcEV2ZW50VHlwZSwgcGlja1RyaWdnZXIsIHBpY2tEZWZhdWx0SW5kZXhdLCBjb21iaW5lVG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9ucyk7CnZhciBzZWxlY3RDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgcGlja0RlZmF1bHRJbmRleCwgc2VsZWN0VG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9uczIsIHNlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXJdLCBjb21iaW5lQ29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleCk7CnZhciBzZWxlY3RBY3RpdmVDb29yZGluYXRlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlMiwgc2VsZWN0Q29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleF0sICh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSwgZGVmYXVsdEluZGV4Q29vcmRpbmF0ZSkgPT4gewogIHZhciBfdG9vbHRpcEludGVyYWN0aW9uU3Q7CiAgcmV0dXJuIChfdG9vbHRpcEludGVyYWN0aW9uU3QgPSB0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZS5jb29yZGluYXRlKSAhPT0gbnVsbCAmJiBfdG9vbHRpcEludGVyYWN0aW9uU3QgIT09IHZvaWQgMCA/IF90b29sdGlwSW50ZXJhY3Rpb25TdCA6IGRlZmF1bHRJbmRleENvb3JkaW5hdGU7Cn0pOwp2YXIgc2VsZWN0QWN0aXZlTGFiZWwyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzVGlja3MsIHNlbGVjdEFjdGl2ZUluZGV4XSwgY29tYmluZUFjdGl2ZUxhYmVsKTsKdmFyIHNlbGVjdFRvb2x0aXBQYXlsb2FkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMyLCBzZWxlY3RBY3RpdmVJbmRleCwgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSwgc2VsZWN0QWN0aXZlTGFiZWwyLCBzZWxlY3RUb29sdGlwUGF5bG9hZFNlYXJjaGVyLCBwaWNrVG9vbHRpcEV2ZW50VHlwZV0sIGNvbWJpbmVUb29sdGlwUGF5bG9hZCk7CnZhciBzZWxlY3RJc1Rvb2x0aXBBY3RpdmUyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlMiwgc2VsZWN0QWN0aXZlSW5kZXhdLCAodG9vbHRpcEludGVyYWN0aW9uU3RhdGUsIGFjdGl2ZUluZGV4KSA9PiB7CiAgcmV0dXJuIHsKICAgIGlzQWN0aXZlOiB0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZS5hY3RpdmUgJiYgYWN0aXZlSW5kZXggIT0gbnVsbCwKICAgIGFjdGl2ZUluZGV4CiAgfTsKfSk7CnZhciBjb21iaW5lQWN0aXZlQ2FydGVzaWFuUHJvcHMgPSAoY2hhcnRFdmVudCwgbGF5b3V0LCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UsIHRvb2x0aXBUaWNrcywgb3JkZXJlZFRvb2x0aXBUaWNrcywgb2Zmc2V0KSA9PiB7CiAgaWYgKCFjaGFydEV2ZW50IHx8ICF0b29sdGlwQXhpc1R5cGUgfHwgIXRvb2x0aXBBeGlzUmFuZ2UgfHwgIXRvb2x0aXBUaWNrcykgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKCFpc0luQ2FydGVzaWFuUmFuZ2UoY2hhcnRFdmVudCwgb2Zmc2V0KSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHBvcyA9IGNhbGN1bGF0ZUNhcnRlc2lhblRvb2x0aXBQb3MoY2hhcnRFdmVudCwgbGF5b3V0KTsKICB2YXIgYWN0aXZlSW5kZXggPSBjYWxjdWxhdGVBY3RpdmVUaWNrSW5kZXgocG9zLCBvcmRlcmVkVG9vbHRpcFRpY2tzLCB0b29sdGlwVGlja3MsIHRvb2x0aXBBeGlzVHlwZSwgdG9vbHRpcEF4aXNSYW5nZSk7CiAgdmFyIGFjdGl2ZUNvb3JkaW5hdGUgPSBnZXRBY3RpdmVDYXJ0ZXNpYW5Db29yZGluYXRlKGxheW91dCwgdG9vbHRpcFRpY2tzLCBhY3RpdmVJbmRleCwgY2hhcnRFdmVudCk7CiAgcmV0dXJuIHsKICAgIGFjdGl2ZUluZGV4OiBTdHJpbmcoYWN0aXZlSW5kZXgpLAogICAgYWN0aXZlQ29vcmRpbmF0ZQogIH07Cn07CnZhciBjb21iaW5lQWN0aXZlUG9sYXJQcm9wcyA9IChjaGFydEV2ZW50LCBsYXlvdXQsIHBvbGFyVmlld0JveCwgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlLCB0b29sdGlwVGlja3MsIG9yZGVyZWRUb29sdGlwVGlja3MpID0+IHsKICBpZiAoIWNoYXJ0RXZlbnQgfHwgIXRvb2x0aXBBeGlzVHlwZSB8fCAhdG9vbHRpcEF4aXNSYW5nZSB8fCAhdG9vbHRpcFRpY2tzIHx8ICFwb2xhclZpZXdCb3gpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciByYW5nZU9iaiA9IGluUmFuZ2VPZlNlY3RvcihjaGFydEV2ZW50LCBwb2xhclZpZXdCb3gpOwogIGlmICghcmFuZ2VPYmopIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBwb3MgPSBjYWxjdWxhdGVQb2xhclRvb2x0aXBQb3MocmFuZ2VPYmosIGxheW91dCk7CiAgdmFyIGFjdGl2ZUluZGV4ID0gY2FsY3VsYXRlQWN0aXZlVGlja0luZGV4KHBvcywgb3JkZXJlZFRvb2x0aXBUaWNrcywgdG9vbHRpcFRpY2tzLCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UpOwogIHZhciBhY3RpdmVDb29yZGluYXRlID0gZ2V0QWN0aXZlUG9sYXJDb29yZGluYXRlKGxheW91dCwgdG9vbHRpcFRpY2tzLCBhY3RpdmVJbmRleCwgcmFuZ2VPYmopOwogIHJldHVybiB7CiAgICBhY3RpdmVJbmRleDogU3RyaW5nKGFjdGl2ZUluZGV4KSwKICAgIGFjdGl2ZUNvb3JkaW5hdGUKICB9Owp9Owp2YXIgY29tYmluZUFjdGl2ZVByb3BzID0gKGNoYXJ0RXZlbnQsIGxheW91dCwgcG9sYXJWaWV3Qm94LCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UsIHRvb2x0aXBUaWNrcywgb3JkZXJlZFRvb2x0aXBUaWNrcywgb2Zmc2V0KSA9PiB7CiAgaWYgKCFjaGFydEV2ZW50IHx8ICFsYXlvdXQgfHwgIXRvb2x0aXBBeGlzVHlwZSB8fCAhdG9vbHRpcEF4aXNSYW5nZSB8fCAhdG9vbHRpcFRpY2tzKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgfHwgbGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICByZXR1cm4gY29tYmluZUFjdGl2ZUNhcnRlc2lhblByb3BzKGNoYXJ0RXZlbnQsIGxheW91dCwgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlLCB0b29sdGlwVGlja3MsIG9yZGVyZWRUb29sdGlwVGlja3MsIG9mZnNldCk7CiAgfQogIHJldHVybiBjb21iaW5lQWN0aXZlUG9sYXJQcm9wcyhjaGFydEV2ZW50LCBsYXlvdXQsIHBvbGFyVmlld0JveCwgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlLCB0b29sdGlwVGlja3MsIG9yZGVyZWRUb29sdGlwVGlja3MpOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvekluZGV4L1pJbmRleExheWVyLmpzCnZhciBpbXBvcnRfcmVhY3QyMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdF9kb20gPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3RfZG9tKCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvekluZGV4L3pJbmRleFNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0WkluZGV4UG9ydGFsSWQgPSBjcmVhdGVTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLnpJbmRleC56SW5kZXhNYXAsIChfLCB6SW5kZXgpID0+IHpJbmRleCwgKF8sIF96SW5kZXgsIGlzUGFub3JhbWEpID0+IGlzUGFub3JhbWEsICh6SW5kZXhNYXAsIHpJbmRleCwgaXNQYW5vcmFtYSkgPT4gewogIGlmICh6SW5kZXggPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGVudHJ5ID0gekluZGV4TWFwW3pJbmRleF07CiAgaWYgKGVudHJ5ID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChpc1Bhbm9yYW1hKSB7CiAgICByZXR1cm4gZW50cnkucGFub3JhbWFFbGVtZW50SWQ7CiAgfQogIHJldHVybiBlbnRyeS5lbGVtZW50SWQ7Cn0pOwp2YXIgc2VsZWN0QWxsUmVnaXN0ZXJlZFpJbmRleGVzID0gY3JlYXRlU2VsZWN0b3IoKHN0YXRlKSA9PiBzdGF0ZS56SW5kZXguekluZGV4TWFwLCAoekluZGV4TWFwKSA9PiB7CiAgdmFyIGFsbE51bWJlcnMgPSBPYmplY3Qua2V5cyh6SW5kZXhNYXApLm1hcCgoekluZGV4U3RyKSA9PiBwYXJzZUludCh6SW5kZXhTdHIsIDEwKSkuY29uY2F0KE9iamVjdC52YWx1ZXMoRGVmYXVsdFpJbmRleGVzKSk7CiAgdmFyIHVuaXF1ZU51bWJlcnMgPSBBcnJheS5mcm9tKG5ldyBTZXQoYWxsTnVtYmVycykpOwogIHJldHVybiB1bmlxdWVOdW1iZXJzLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKfSwgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBhcnJheUNvbnRlbnRzQXJlRXF1YWxDaGVjawogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS96SW5kZXhTbGljZS5qcwpmdW5jdGlvbiBvd25LZXlzMTgoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxOChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czE4KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxOChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxOChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTgoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxOChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxOCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxOCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxOCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIHNlZWQgPSB7fTsKdmFyIGluaXRpYWxTdGF0ZTQgPSB7CiAgekluZGV4TWFwOiBPYmplY3QudmFsdWVzKERlZmF1bHRaSW5kZXhlcykucmVkdWNlKChhY2MsIGN1cnJlbnQzKSA9PiBfb2JqZWN0U3ByZWFkMTgoX29iamVjdFNwcmVhZDE4KHt9LCBhY2MpLCB7fSwgewogICAgW2N1cnJlbnQzXTogewogICAgICBlbGVtZW50SWQ6IHZvaWQgMCwKICAgICAgcGFub3JhbWFFbGVtZW50SWQ6IHZvaWQgMCwKICAgICAgY29uc3VtZXJzOiAwCiAgICB9CiAgfSksIHNlZWQpCn07CnZhciBkZWZhdWx0WkluZGV4U2V0ID0gbmV3IFNldChPYmplY3QudmFsdWVzKERlZmF1bHRaSW5kZXhlcykpOwpmdW5jdGlvbiBpc0RlZmF1bHRaSW5kZXgoekluZGV4KSB7CiAgcmV0dXJuIGRlZmF1bHRaSW5kZXhTZXQuaGFzKHpJbmRleCk7Cn0KdmFyIHpJbmRleFNsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJ6SW5kZXgiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlNCwKICByZWR1Y2VyczogewogICAgcmVnaXN0ZXJaSW5kZXhQb3J0YWw6IHsKICAgICAgcmVkdWNlcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgICB2YXIgewogICAgICAgICAgekluZGV4CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIGlmIChzdGF0ZS56SW5kZXhNYXBbekluZGV4XSkgewogICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0uY29uc3VtZXJzICs9IDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdID0gewogICAgICAgICAgICBjb25zdW1lcnM6IDEsCiAgICAgICAgICAgIGVsZW1lbnRJZDogdm9pZCAwLAogICAgICAgICAgICBwYW5vcmFtYUVsZW1lbnRJZDogdm9pZCAwCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICB1bnJlZ2lzdGVyWkluZGV4UG9ydGFsOiB7CiAgICAgIHJlZHVjZXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHpJbmRleAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUuekluZGV4TWFwW3pJbmRleF0pIHsKICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLmNvbnN1bWVycyAtPSAxOwogICAgICAgICAgaWYgKHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLmNvbnN1bWVycyA8PSAwICYmICFpc0RlZmF1bHRaSW5kZXgoekluZGV4KSkgewogICAgICAgICAgICBkZWxldGUgc3RhdGUuekluZGV4TWFwW3pJbmRleF07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlZ2lzdGVyWkluZGV4UG9ydGFsSWQ6IHsKICAgICAgcmVkdWNlcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgICB2YXIgewogICAgICAgICAgekluZGV4LAogICAgICAgICAgZWxlbWVudElkLAogICAgICAgICAgaXNQYW5vcmFtYQogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUuekluZGV4TWFwW3pJbmRleF0pIHsKICAgICAgICAgIGlmIChpc1Bhbm9yYW1hKSB7CiAgICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLnBhbm9yYW1hRWxlbWVudElkID0gZWxlbWVudElkOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0uZWxlbWVudElkID0gZWxlbWVudElkOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XSA9IHsKICAgICAgICAgICAgY29uc3VtZXJzOiAwLAogICAgICAgICAgICBlbGVtZW50SWQ6IGlzUGFub3JhbWEgPyB2b2lkIDAgOiBlbGVtZW50SWQsCiAgICAgICAgICAgIHBhbm9yYW1hRWxlbWVudElkOiBpc1Bhbm9yYW1hID8gZWxlbWVudElkIDogdm9pZCAwCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICB1bnJlZ2lzdGVyWkluZGV4UG9ydGFsSWQ6IHsKICAgICAgcmVkdWNlcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgICB2YXIgewogICAgICAgICAgekluZGV4CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIGlmIChzdGF0ZS56SW5kZXhNYXBbekluZGV4XSkgewogICAgICAgICAgaWYgKGFjdGlvbi5wYXlsb2FkLmlzUGFub3JhbWEpIHsKICAgICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0ucGFub3JhbWFFbGVtZW50SWQgPSB2b2lkIDA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XS5lbGVtZW50SWQgPSB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfQogIH0KfSk7CnZhciB7CiAgcmVnaXN0ZXJaSW5kZXhQb3J0YWwsCiAgdW5yZWdpc3RlclpJbmRleFBvcnRhbCwKICByZWdpc3RlclpJbmRleFBvcnRhbElkLAogIHVucmVnaXN0ZXJaSW5kZXhQb3J0YWxJZAp9ID0gekluZGV4U2xpY2UuYWN0aW9uczsKdmFyIHpJbmRleFJlZHVjZXIgPSB6SW5kZXhTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvekluZGV4L1pJbmRleExheWVyLmpzCmZ1bmN0aW9uIFpJbmRleExheWVyKF9yZWYyKSB7CiAgdmFyIHsKICAgIHpJbmRleCwKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyOwogIHZhciBpc0luQ2hhcnRDb250ZXh0ID0gdXNlSXNJbkNoYXJ0Q29udGV4dCgpOwogIHZhciBzaG91bGRSZW5kZXJJblBvcnRhbCA9IGlzSW5DaGFydENvbnRleHQgJiYgekluZGV4ICE9PSB2b2lkIDAgJiYgekluZGV4ICE9PSAwOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDIwLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFzaG91bGRSZW5kZXJJblBvcnRhbCkgewogICAgICByZXR1cm4gbm9vcDsKICAgIH0KICAgIGRpc3BhdGNoKHJlZ2lzdGVyWkluZGV4UG9ydGFsKHsKICAgICAgekluZGV4CiAgICB9KSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBkaXNwYXRjaCh1bnJlZ2lzdGVyWkluZGV4UG9ydGFsKHsKICAgICAgICB6SW5kZXgKICAgICAgfSkpOwogICAgfTsKICB9LCBbZGlzcGF0Y2gsIHpJbmRleCwgc2hvdWxkUmVuZGVySW5Qb3J0YWxdKTsKICB2YXIgcG9ydGFsSWQgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFpJbmRleFBvcnRhbElkKHN0YXRlLCB6SW5kZXgsIGlzUGFub3JhbWEpKTsKICBpZiAoIXNob3VsZFJlbmRlckluUG9ydGFsKSB7CiAgICByZXR1cm4gY2hpbGRyZW47CiAgfQogIGlmICghcG9ydGFsSWQpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgekluZGV4UG9ydGFsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocG9ydGFsSWQpOwogIGlmICh6SW5kZXhQb3J0YWwpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdF9kb20uY3JlYXRlUG9ydGFsKShjaGlsZHJlbiwgekluZGV4UG9ydGFsKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9DdXJzb3IuanMKZnVuY3Rpb24gX2V4dGVuZHM5KCkgewogIHJldHVybiBfZXh0ZW5kczkgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzMTkoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxOShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czE5KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxOShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxOShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTkoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxOShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxOSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxOSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxOSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gUmVuZGVyQ3Vyc29yKF9yZWYyKSB7CiAgdmFyIHsKICAgIGN1cnNvciwKICAgIGN1cnNvckNvbXAsCiAgICBjdXJzb3JQcm9wcwogIH0gPSBfcmVmMjsKICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyMS5pc1ZhbGlkRWxlbWVudCkoY3Vyc29yKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjEuY2xvbmVFbGVtZW50KShjdXJzb3IsIGN1cnNvclByb3BzKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjEuY3JlYXRlRWxlbWVudCkoY3Vyc29yQ29tcCwgY3Vyc29yUHJvcHMpOwp9CmZ1bmN0aW9uIEN1cnNvckludGVybmFsKHByb3BzKSB7CiAgdmFyIF9wcm9wcyR6SW5kZXg7CiAgdmFyIHsKICAgIGNvb3JkaW5hdGUsCiAgICBwYXlsb2FkLAogICAgaW5kZXgsCiAgICBvZmZzZXQsCiAgICB0b29sdGlwQXhpc0JhbmRTaXplLAogICAgbGF5b3V0LAogICAgY3Vyc29yLAogICAgdG9vbHRpcEV2ZW50VHlwZSwKICAgIGNoYXJ0TmFtZQogIH0gPSBwcm9wczsKICB2YXIgYWN0aXZlQ29vcmRpbmF0ZSA9IGNvb3JkaW5hdGU7CiAgdmFyIGFjdGl2ZVBheWxvYWQgPSBwYXlsb2FkOwogIHZhciBhY3RpdmVUb29sdGlwSW5kZXggPSBpbmRleDsKICBpZiAoIWN1cnNvciB8fCAhYWN0aXZlQ29vcmRpbmF0ZSB8fCBjaGFydE5hbWUgIT09ICJTY2F0dGVyQ2hhcnQiICYmIHRvb2x0aXBFdmVudFR5cGUgIT09ICJheGlzIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciByZXN0UHJvcHMsIGN1cnNvckNvbXAsIHByZWZlcnJlZFpJbmRleDsKICBpZiAoY2hhcnROYW1lID09PSAiU2NhdHRlckNoYXJ0IikgewogICAgcmVzdFByb3BzID0gYWN0aXZlQ29vcmRpbmF0ZTsKICAgIGN1cnNvckNvbXAgPSBDcm9zczsKICAgIHByZWZlcnJlZFpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5jdXJzb3JMaW5lOwogIH0gZWxzZSBpZiAoY2hhcnROYW1lID09PSAiQmFyQ2hhcnQiKSB7CiAgICByZXN0UHJvcHMgPSBnZXRDdXJzb3JSZWN0YW5nbGUobGF5b3V0LCBhY3RpdmVDb29yZGluYXRlLCBvZmZzZXQsIHRvb2x0aXBBeGlzQmFuZFNpemUpOwogICAgY3Vyc29yQ29tcCA9IFJlY3RhbmdsZTsKICAgIHByZWZlcnJlZFpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5jdXJzb3JSZWN0YW5nbGU7CiAgfSBlbHNlIGlmIChsYXlvdXQgPT09ICJyYWRpYWwiICYmIGlzUG9sYXJDb29yZGluYXRlKGFjdGl2ZUNvb3JkaW5hdGUpKSB7CiAgICB2YXIgewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIHJhZGl1cywKICAgICAgc3RhcnRBbmdsZSwKICAgICAgZW5kQW5nbGUKICAgIH0gPSBnZXRSYWRpYWxDdXJzb3JQb2ludHMoYWN0aXZlQ29vcmRpbmF0ZSk7CiAgICByZXN0UHJvcHMgPSB7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgc3RhcnRBbmdsZSwKICAgICAgZW5kQW5nbGUsCiAgICAgIGlubmVyUmFkaXVzOiByYWRpdXMsCiAgICAgIG91dGVyUmFkaXVzOiByYWRpdXMKICAgIH07CiAgICBjdXJzb3JDb21wID0gU2VjdG9yOwogICAgcHJlZmVycmVkWkluZGV4ID0gRGVmYXVsdFpJbmRleGVzLmN1cnNvckxpbmU7CiAgfSBlbHNlIHsKICAgIHJlc3RQcm9wcyA9IHsKICAgICAgcG9pbnRzOiBnZXRDdXJzb3JQb2ludHMobGF5b3V0LCBhY3RpdmVDb29yZGluYXRlLCBvZmZzZXQpCiAgICB9OwogICAgY3Vyc29yQ29tcCA9IEN1cnZlOwogICAgcHJlZmVycmVkWkluZGV4ID0gRGVmYXVsdFpJbmRleGVzLmN1cnNvckxpbmU7CiAgfQogIHZhciBleHRyYUNsYXNzTmFtZSA9IHR5cGVvZiBjdXJzb3IgPT09ICJvYmplY3QiICYmICJjbGFzc05hbWUiIGluIGN1cnNvciA/IGN1cnNvci5jbGFzc05hbWUgOiB2b2lkIDA7CiAgdmFyIGN1cnNvclByb3BzID0gX29iamVjdFNwcmVhZDE5KF9vYmplY3RTcHJlYWQxOShfb2JqZWN0U3ByZWFkMTkoX29iamVjdFNwcmVhZDE5KHsKICAgIHN0cm9rZTogIiNjY2MiLAogICAgcG9pbnRlckV2ZW50czogIm5vbmUiCiAgfSwgb2Zmc2V0KSwgcmVzdFByb3BzKSwgc3ZnUHJvcGVydGllc05vRXZlbnRzRnJvbVVua25vd24oY3Vyc29yKSksIHt9LCB7CiAgICBwYXlsb2FkOiBhY3RpdmVQYXlsb2FkLAogICAgcGF5bG9hZEluZGV4OiBhY3RpdmVUb29sdGlwSW5kZXgsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLXRvb2x0aXAtY3Vyc29yIiwgZXh0cmFDbGFzc05hbWUpCiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDExLmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleDogKF9wcm9wcyR6SW5kZXggPSBwcm9wcy56SW5kZXgpICE9PSBudWxsICYmIF9wcm9wcyR6SW5kZXggIT09IHZvaWQgMCA/IF9wcm9wcyR6SW5kZXggOiBwcmVmZXJyZWRaSW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QxMS5jcmVhdGVFbGVtZW50KFJlbmRlckN1cnNvciwgewogICAgY3Vyc29yLAogICAgY3Vyc29yQ29tcCwKICAgIGN1cnNvclByb3BzCiAgfSkpOwp9CmZ1bmN0aW9uIEN1cnNvcihwcm9wcykgewogIHZhciB0b29sdGlwQXhpc0JhbmRTaXplID0gdXNlVG9vbHRpcEF4aXNCYW5kU2l6ZSgpOwogIHZhciBvZmZzZXQgPSB1c2VPZmZzZXRJbnRlcm5hbCgpOwogIHZhciBsYXlvdXQgPSB1c2VDaGFydExheW91dCgpOwogIHZhciBjaGFydE5hbWUgPSB1c2VDaGFydE5hbWUoKTsKICBpZiAodG9vbHRpcEF4aXNCYW5kU2l6ZSA9PSBudWxsIHx8IG9mZnNldCA9PSBudWxsIHx8IGxheW91dCA9PSBudWxsIHx8IGNoYXJ0TmFtZSA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDExLmNyZWF0ZUVsZW1lbnQoQ3Vyc29ySW50ZXJuYWwsIF9leHRlbmRzOSh7fSwgcHJvcHMsIHsKICAgIG9mZnNldCwKICAgIGxheW91dCwKICAgIHRvb2x0aXBBeGlzQmFuZFNpemUsCiAgICBjaGFydE5hbWUKICB9KSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvdG9vbHRpcFBvcnRhbENvbnRleHQuanMKdmFyIGltcG9ydF9yZWFjdDIyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgVG9vbHRpcFBvcnRhbENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDIyLmNyZWF0ZUNvbnRleHQpKG51bGwpOwp2YXIgdXNlVG9vbHRpcFBvcnRhbCA9ICgpID0+ICgwLCBpbXBvcnRfcmVhY3QyMi51c2VDb250ZXh0KShUb29sdGlwUG9ydGFsQ29udGV4dCk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zeW5jaHJvbmlzYXRpb24vdXNlQ2hhcnRTeW5jaHJvbmlzYXRpb24uanMKdmFyIGltcG9ydF9yZWFjdDIzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2V2ZW50ZW1pdHRlcjNANS4wLjEvbm9kZV9tb2R1bGVzL2V2ZW50ZW1pdHRlcjMvaW5kZXgubWpzCnZhciBpbXBvcnRfaW5kZXggPSBfX3RvRVNNKHJlcXVpcmVfZXZlbnRlbWl0dGVyMygpLCAxKTsKdmFyIGV2ZW50ZW1pdHRlcjNfZGVmYXVsdCA9IGltcG9ydF9pbmRleC5kZWZhdWx0OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9FdmVudHMuanMKdmFyIGV2ZW50Q2VudGVyID0gbmV3IGV2ZW50ZW1pdHRlcjNfZGVmYXVsdCgpOwp2YXIgVE9PTFRJUF9TWU5DX0VWRU5UID0gInJlY2hhcnRzLnN5bmNFdmVudC50b29sdGlwIjsKdmFyIEJSVVNIX1NZTkNfRVZFTlQgPSAicmVjaGFydHMuc3luY0V2ZW50LmJydXNoIjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL29wdGlvbnNTbGljZS5qcwpmdW5jdGlvbiBhcnJheVRvb2x0aXBTZWFyY2hlcihkYXRhLCBzdHJJbmRleCkgewogIGlmICghc3RySW5kZXgpIHJldHVybiB2b2lkIDA7CiAgdmFyIG51bUluZGV4ID0gTnVtYmVyLnBhcnNlSW50KHN0ckluZGV4LCAxMCk7CiAgaWYgKGlzTmFuKG51bUluZGV4KSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGRhdGEgPT09IG51bGwgfHwgZGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YVtudW1JbmRleF07Cn0KdmFyIGluaXRpYWxTdGF0ZTUgPSB7CiAgY2hhcnROYW1lOiAiIiwKICB0b29sdGlwUGF5bG9hZFNlYXJjaGVyOiB2b2lkIDAsCiAgZXZlbnRFbWl0dGVyOiB2b2lkIDAsCiAgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGU6ICJheGlzIgp9Owp2YXIgb3B0aW9uc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJvcHRpb25zIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTUsCiAgcmVkdWNlcnM6IHsKICAgIGNyZWF0ZUV2ZW50RW1pdHRlcjogKHN0YXRlKSA9PiB7CiAgICAgIGlmIChzdGF0ZS5ldmVudEVtaXR0ZXIgPT0gbnVsbCkgewogICAgICAgIHN0YXRlLmV2ZW50RW1pdHRlciA9IFN5bWJvbCgicmVjaGFydHNFdmVudEVtaXR0ZXIiKTsKICAgICAgfQogICAgfQogIH0KfSk7CnZhciBvcHRpb25zUmVkdWNlciA9IG9wdGlvbnNTbGljZS5yZWR1Y2VyOwp2YXIgewogIGNyZWF0ZUV2ZW50RW1pdHRlcgp9ID0gb3B0aW9uc1NsaWNlLmFjdGlvbnM7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zeW5jaHJvbmlzYXRpb24vc3luY1NlbGVjdG9ycy5qcwpmdW5jdGlvbiBzZWxlY3RTeW5jaHJvbmlzZWRUb29sdGlwU3RhdGUoc3RhdGUpIHsKICByZXR1cm4gc3RhdGUudG9vbHRpcC5zeW5jSW50ZXJhY3Rpb247Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2NoYXJ0RGF0YVNsaWNlLmpzCnZhciBpbml0aWFsQ2hhcnREYXRhU3RhdGUgPSB7CiAgY2hhcnREYXRhOiB2b2lkIDAsCiAgY29tcHV0ZWREYXRhOiB2b2lkIDAsCiAgZGF0YVN0YXJ0SW5kZXg6IDAsCiAgZGF0YUVuZEluZGV4OiAwCn07CnZhciBjaGFydERhdGFTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiY2hhcnREYXRhIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxDaGFydERhdGFTdGF0ZSwKICByZWR1Y2VyczogewogICAgc2V0Q2hhcnREYXRhKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuY2hhcnREYXRhID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIGlmIChhY3Rpb24ucGF5bG9hZCA9PSBudWxsKSB7CiAgICAgICAgc3RhdGUuZGF0YVN0YXJ0SW5kZXggPSAwOwogICAgICAgIHN0YXRlLmRhdGFFbmRJbmRleCA9IDA7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChhY3Rpb24ucGF5bG9hZC5sZW5ndGggPiAwICYmIHN0YXRlLmRhdGFFbmRJbmRleCAhPT0gYWN0aW9uLnBheWxvYWQubGVuZ3RoIC0gMSkgewogICAgICAgIHN0YXRlLmRhdGFFbmRJbmRleCA9IGFjdGlvbi5wYXlsb2FkLmxlbmd0aCAtIDE7CiAgICAgIH0KICAgIH0sCiAgICBzZXRDb21wdXRlZERhdGEoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5jb21wdXRlZERhdGEgPSBhY3Rpb24ucGF5bG9hZDsKICAgIH0sCiAgICBzZXREYXRhU3RhcnRFbmRJbmRleGVzKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgdmFyIHsKICAgICAgICBzdGFydEluZGV4LAogICAgICAgIGVuZEluZGV4CiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgaWYgKHN0YXJ0SW5kZXggIT0gbnVsbCkgewogICAgICAgIHN0YXRlLmRhdGFTdGFydEluZGV4ID0gc3RhcnRJbmRleDsKICAgICAgfQogICAgICBpZiAoZW5kSW5kZXggIT0gbnVsbCkgewogICAgICAgIHN0YXRlLmRhdGFFbmRJbmRleCA9IGVuZEluZGV4OwogICAgICB9CiAgICB9CiAgfQp9KTsKdmFyIHsKICBzZXRDaGFydERhdGEsCiAgc2V0RGF0YVN0YXJ0RW5kSW5kZXhlcywKICBzZXRDb21wdXRlZERhdGEKfSA9IGNoYXJ0RGF0YVNsaWNlLmFjdGlvbnM7CnZhciBjaGFydERhdGFSZWR1Y2VyID0gY2hhcnREYXRhU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N5bmNocm9uaXNhdGlvbi91c2VDaGFydFN5bmNocm9uaXNhdGlvbi5qcwp2YXIgX2V4Y2x1ZGVkNSA9IFsieCIsICJ5Il07CmZ1bmN0aW9uIG93bktleXMyMChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDIwKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjAoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTIwKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czIwKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyMChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTIwKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTIwKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTIwKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTIwKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM1KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U1KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U1KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiB1c2VUb29sdGlwU3luY0V2ZW50c0xpc3RlbmVyKCkgewogIHZhciBteVN5bmNJZCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFN5bmNJZCk7CiAgdmFyIG15RXZlbnRFbWl0dGVyID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0RXZlbnRFbWl0dGVyKTsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBzeW5jTWV0aG9kID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0U3luY01ldGhvZCk7CiAgdmFyIHRvb2x0aXBUaWNrcyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFRvb2x0aXBBeGlzVGlja3MpOwogIHZhciBsYXlvdXQgPSB1c2VDaGFydExheW91dCgpOwogIHZhciB2aWV3Qm94ID0gdXNlVmlld0JveCgpOwogIHZhciBjbGFzc05hbWUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5jbGFzc05hbWUpOwogICgwLCBpbXBvcnRfcmVhY3QyMy51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChteVN5bmNJZCA9PSBudWxsKSB7CiAgICAgIHJldHVybiBub29wOwogICAgfQogICAgdmFyIGxpc3RlbmVyMiA9IChpbmNvbWluZ1N5bmNJZCwgYWN0aW9uLCBlbWl0dGVyKSA9PiB7CiAgICAgIGlmIChteUV2ZW50RW1pdHRlciA9PT0gZW1pdHRlcikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAobXlTeW5jSWQgIT09IGluY29taW5nU3luY0lkKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChzeW5jTWV0aG9kID09PSAiaW5kZXgiKSB7CiAgICAgICAgdmFyIF9hY3Rpb24kcGF5bG9hZDsKICAgICAgICBpZiAodmlld0JveCAmJiBhY3Rpb24gIT09IG51bGwgJiYgYWN0aW9uICE9PSB2b2lkIDAgJiYgKF9hY3Rpb24kcGF5bG9hZCA9IGFjdGlvbi5wYXlsb2FkKSAhPT0gbnVsbCAmJiBfYWN0aW9uJHBheWxvYWQgIT09IHZvaWQgMCAmJiBfYWN0aW9uJHBheWxvYWQuY29vcmRpbmF0ZSAmJiBhY3Rpb24ucGF5bG9hZC5zb3VyY2VWaWV3Qm94KSB7CiAgICAgICAgICB2YXIgX2FjdGlvbiRwYXlsb2FkJGNvb3JkID0gYWN0aW9uLnBheWxvYWQuY29vcmRpbmF0ZSwgewogICAgICAgICAgICB4OiBfeCwKICAgICAgICAgICAgeTogX3kKICAgICAgICAgIH0gPSBfYWN0aW9uJHBheWxvYWQkY29vcmQsIG90aGVyQ29vcmRpbmF0ZVByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNShfYWN0aW9uJHBheWxvYWQkY29vcmQsIF9leGNsdWRlZDUpOwogICAgICAgICAgdmFyIHsKICAgICAgICAgICAgeDogc291cmNlWCwKICAgICAgICAgICAgeTogc291cmNlWSwKICAgICAgICAgICAgd2lkdGg6IHNvdXJjZVdpZHRoLAogICAgICAgICAgICBoZWlnaHQ6IHNvdXJjZUhlaWdodAogICAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkLnNvdXJjZVZpZXdCb3g7CiAgICAgICAgICB2YXIgc2NhbGVkQ29vcmRpbmF0ZSA9IF9vYmplY3RTcHJlYWQyMChfb2JqZWN0U3ByZWFkMjAoe30sIG90aGVyQ29vcmRpbmF0ZVByb3BzKSwge30sIHsKICAgICAgICAgICAgeDogdmlld0JveC54ICsgKHNvdXJjZVdpZHRoID8gKF94IC0gc291cmNlWCkgLyBzb3VyY2VXaWR0aCA6IDApICogdmlld0JveC53aWR0aCwKICAgICAgICAgICAgeTogdmlld0JveC55ICsgKHNvdXJjZUhlaWdodCA/IChfeSAtIHNvdXJjZVkpIC8gc291cmNlSGVpZ2h0IDogMCkgKiB2aWV3Qm94LmhlaWdodAogICAgICAgICAgfSk7CiAgICAgICAgICBkaXNwYXRjaChfb2JqZWN0U3ByZWFkMjAoX29iamVjdFNwcmVhZDIwKHt9LCBhY3Rpb24pLCB7fSwgewogICAgICAgICAgICBwYXlsb2FkOiBfb2JqZWN0U3ByZWFkMjAoX29iamVjdFNwcmVhZDIwKHt9LCBhY3Rpb24ucGF5bG9hZCksIHt9LCB7CiAgICAgICAgICAgICAgY29vcmRpbmF0ZTogc2NhbGVkQ29vcmRpbmF0ZQogICAgICAgICAgICB9KQogICAgICAgICAgfSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkaXNwYXRjaChhY3Rpb24pOwogICAgICAgIH0KICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHRvb2x0aXBUaWNrcyA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBhY3RpdmVUaWNrOwogICAgICBpZiAodHlwZW9mIHN5bmNNZXRob2QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICB2YXIgc3luY01ldGhvZFBhcmFtID0gewogICAgICAgICAgYWN0aXZlVG9vbHRpcEluZGV4OiBhY3Rpb24ucGF5bG9hZC5pbmRleCA9PSBudWxsID8gdm9pZCAwIDogTnVtYmVyKGFjdGlvbi5wYXlsb2FkLmluZGV4KSwKICAgICAgICAgIGlzVG9vbHRpcEFjdGl2ZTogYWN0aW9uLnBheWxvYWQuYWN0aXZlLAogICAgICAgICAgYWN0aXZlSW5kZXg6IGFjdGlvbi5wYXlsb2FkLmluZGV4ID09IG51bGwgPyB2b2lkIDAgOiBOdW1iZXIoYWN0aW9uLnBheWxvYWQuaW5kZXgpLAogICAgICAgICAgYWN0aXZlTGFiZWw6IGFjdGlvbi5wYXlsb2FkLmxhYmVsLAogICAgICAgICAgYWN0aXZlRGF0YUtleTogYWN0aW9uLnBheWxvYWQuZGF0YUtleSwKICAgICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGFjdGlvbi5wYXlsb2FkLmNvb3JkaW5hdGUKICAgICAgICB9OwogICAgICAgIHZhciBhY3RpdmVUb29sdGlwSW5kZXggPSBzeW5jTWV0aG9kKHRvb2x0aXBUaWNrcywgc3luY01ldGhvZFBhcmFtKTsKICAgICAgICBhY3RpdmVUaWNrID0gdG9vbHRpcFRpY2tzW2FjdGl2ZVRvb2x0aXBJbmRleF07CiAgICAgIH0gZWxzZSBpZiAoc3luY01ldGhvZCA9PT0gInZhbHVlIikgewogICAgICAgIGFjdGl2ZVRpY2sgPSB0b29sdGlwVGlja3MuZmluZCgodGljaykgPT4gU3RyaW5nKHRpY2sudmFsdWUpID09PSBhY3Rpb24ucGF5bG9hZC5sYWJlbCk7CiAgICAgIH0KICAgICAgdmFyIHsKICAgICAgICBjb29yZGluYXRlCiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgaWYgKGFjdGl2ZVRpY2sgPT0gbnVsbCB8fCBhY3Rpb24ucGF5bG9hZC5hY3RpdmUgPT09IGZhbHNlIHx8IGNvb3JkaW5hdGUgPT0gbnVsbCB8fCB2aWV3Qm94ID09IG51bGwpIHsKICAgICAgICBkaXNwYXRjaChzZXRTeW5jSW50ZXJhY3Rpb24oewogICAgICAgICAgYWN0aXZlOiBmYWxzZSwKICAgICAgICAgIGNvb3JkaW5hdGU6IHZvaWQgMCwKICAgICAgICAgIGRhdGFLZXk6IHZvaWQgMCwKICAgICAgICAgIGluZGV4OiBudWxsLAogICAgICAgICAgbGFiZWw6IHZvaWQgMCwKICAgICAgICAgIHNvdXJjZVZpZXdCb3g6IHZvaWQgMCwKICAgICAgICAgIGdyYXBoaWNhbEl0ZW1JZDogdm9pZCAwCiAgICAgICAgfSkpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgewogICAgICAgIHg6IHgyLAogICAgICAgIHk6IHkyCiAgICAgIH0gPSBjb29yZGluYXRlOwogICAgICB2YXIgdmFsaWRhdGVDaGFydFggPSBNYXRoLm1pbih4Miwgdmlld0JveC54ICsgdmlld0JveC53aWR0aCk7CiAgICAgIHZhciB2YWxpZGF0ZUNoYXJ0WSA9IE1hdGgubWluKHkyLCB2aWV3Qm94LnkgKyB2aWV3Qm94LmhlaWdodCk7CiAgICAgIHZhciBhY3RpdmVDb29yZGluYXRlID0gewogICAgICAgIHg6IGxheW91dCA9PT0gImhvcml6b250YWwiID8gYWN0aXZlVGljay5jb29yZGluYXRlIDogdmFsaWRhdGVDaGFydFgsCiAgICAgICAgeTogbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgPyB2YWxpZGF0ZUNoYXJ0WSA6IGFjdGl2ZVRpY2suY29vcmRpbmF0ZQogICAgICB9OwogICAgICB2YXIgc3luY0FjdGlvbiA9IHNldFN5bmNJbnRlcmFjdGlvbih7CiAgICAgICAgYWN0aXZlOiBhY3Rpb24ucGF5bG9hZC5hY3RpdmUsCiAgICAgICAgY29vcmRpbmF0ZTogYWN0aXZlQ29vcmRpbmF0ZSwKICAgICAgICBkYXRhS2V5OiBhY3Rpb24ucGF5bG9hZC5kYXRhS2V5LAogICAgICAgIGluZGV4OiBTdHJpbmcoYWN0aXZlVGljay5pbmRleCksCiAgICAgICAgbGFiZWw6IGFjdGlvbi5wYXlsb2FkLmxhYmVsLAogICAgICAgIHNvdXJjZVZpZXdCb3g6IGFjdGlvbi5wYXlsb2FkLnNvdXJjZVZpZXdCb3gsCiAgICAgICAgZ3JhcGhpY2FsSXRlbUlkOiBhY3Rpb24ucGF5bG9hZC5ncmFwaGljYWxJdGVtSWQKICAgICAgfSk7CiAgICAgIGRpc3BhdGNoKHN5bmNBY3Rpb24pOwogICAgfTsKICAgIGV2ZW50Q2VudGVyLm9uKFRPT0xUSVBfU1lOQ19FVkVOVCwgbGlzdGVuZXIyKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGV2ZW50Q2VudGVyLm9mZihUT09MVElQX1NZTkNfRVZFTlQsIGxpc3RlbmVyMik7CiAgICB9OwogIH0sIFtjbGFzc05hbWUsIGRpc3BhdGNoLCBteUV2ZW50RW1pdHRlciwgbXlTeW5jSWQsIHN5bmNNZXRob2QsIHRvb2x0aXBUaWNrcywgbGF5b3V0LCB2aWV3Qm94XSk7Cn0KZnVuY3Rpb24gdXNlQnJ1c2hTeW5jRXZlbnRzTGlzdGVuZXIoKSB7CiAgdmFyIG15U3luY0lkID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0U3luY0lkKTsKICB2YXIgbXlFdmVudEVtaXR0ZXIgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RFdmVudEVtaXR0ZXIpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDIzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKG15U3luY0lkID09IG51bGwpIHsKICAgICAgcmV0dXJuIG5vb3A7CiAgICB9CiAgICB2YXIgbGlzdGVuZXIyID0gKGluY29taW5nU3luY0lkLCBhY3Rpb24sIGVtaXR0ZXIpID0+IHsKICAgICAgaWYgKG15RXZlbnRFbWl0dGVyID09PSBlbWl0dGVyKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChteVN5bmNJZCA9PT0gaW5jb21pbmdTeW5jSWQpIHsKICAgICAgICBkaXNwYXRjaChzZXREYXRhU3RhcnRFbmRJbmRleGVzKGFjdGlvbikpOwogICAgICB9CiAgICB9OwogICAgZXZlbnRDZW50ZXIub24oQlJVU0hfU1lOQ19FVkVOVCwgbGlzdGVuZXIyKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGV2ZW50Q2VudGVyLm9mZihCUlVTSF9TWU5DX0VWRU5ULCBsaXN0ZW5lcjIpOwogICAgfTsKICB9LCBbZGlzcGF0Y2gsIG15RXZlbnRFbWl0dGVyLCBteVN5bmNJZF0pOwp9CmZ1bmN0aW9uIHVzZVN5bmNocm9uaXNlZEV2ZW50c0Zyb21PdGhlckNoYXJ0cygpIHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogICgwLCBpbXBvcnRfcmVhY3QyMy51c2VFZmZlY3QpKCgpID0+IHsKICAgIGRpc3BhdGNoKGNyZWF0ZUV2ZW50RW1pdHRlcigpKTsKICB9LCBbZGlzcGF0Y2hdKTsKICB1c2VUb29sdGlwU3luY0V2ZW50c0xpc3RlbmVyKCk7CiAgdXNlQnJ1c2hTeW5jRXZlbnRzTGlzdGVuZXIoKTsKfQpmdW5jdGlvbiB1c2VUb29sdGlwQ2hhcnRTeW5jaHJvbmlzYXRpb24odG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgYWN0aXZlQ29vcmRpbmF0ZSwgYWN0aXZlTGFiZWwsIGFjdGl2ZUluZGV4LCBpc1Rvb2x0aXBBY3RpdmUpIHsKICB2YXIgYWN0aXZlRGF0YUtleSA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0VG9vbHRpcERhdGFLZXkoc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIpKTsKICB2YXIgZXZlbnRFbWl0dGVyU3ltYm9sID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0RXZlbnRFbWl0dGVyKTsKICB2YXIgc3luY0lkID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0U3luY0lkKTsKICB2YXIgc3luY01ldGhvZCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFN5bmNNZXRob2QpOwogIHZhciB0b29sdGlwU3RhdGUgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RTeW5jaHJvbmlzZWRUb29sdGlwU3RhdGUpOwogIHZhciBpc1JlY2VpdmluZ1N5bmNocm9uaXNhdGlvbiA9IHRvb2x0aXBTdGF0ZSA9PT0gbnVsbCB8fCB0b29sdGlwU3RhdGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRvb2x0aXBTdGF0ZS5hY3RpdmU7CiAgdmFyIHZpZXdCb3ggPSB1c2VWaWV3Qm94KCk7CiAgKDAsIGltcG9ydF9yZWFjdDIzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKGlzUmVjZWl2aW5nU3luY2hyb25pc2F0aW9uKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChzeW5jSWQgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoZXZlbnRFbWl0dGVyU3ltYm9sID09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHN5bmNBY3Rpb24gPSBzZXRTeW5jSW50ZXJhY3Rpb24oewogICAgICBhY3RpdmU6IGlzVG9vbHRpcEFjdGl2ZSwKICAgICAgY29vcmRpbmF0ZTogYWN0aXZlQ29vcmRpbmF0ZSwKICAgICAgZGF0YUtleTogYWN0aXZlRGF0YUtleSwKICAgICAgaW5kZXg6IGFjdGl2ZUluZGV4LAogICAgICBsYWJlbDogdHlwZW9mIGFjdGl2ZUxhYmVsID09PSAibnVtYmVyIiA/IFN0cmluZyhhY3RpdmVMYWJlbCkgOiBhY3RpdmVMYWJlbCwKICAgICAgc291cmNlVmlld0JveDogdmlld0JveCwKICAgICAgZ3JhcGhpY2FsSXRlbUlkOiB2b2lkIDAKICAgIH0pOwogICAgZXZlbnRDZW50ZXIuZW1pdChUT09MVElQX1NZTkNfRVZFTlQsIHN5bmNJZCwgc3luY0FjdGlvbiwgZXZlbnRFbWl0dGVyU3ltYm9sKTsKICB9LCBbaXNSZWNlaXZpbmdTeW5jaHJvbmlzYXRpb24sIGFjdGl2ZUNvb3JkaW5hdGUsIGFjdGl2ZURhdGFLZXksIGFjdGl2ZUluZGV4LCBhY3RpdmVMYWJlbCwgZXZlbnRFbWl0dGVyU3ltYm9sLCBzeW5jSWQsIHN5bmNNZXRob2QsIGlzVG9vbHRpcEFjdGl2ZSwgdmlld0JveF0pOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVG9vbHRpcC5qcwpmdW5jdGlvbiBvd25LZXlzMjEoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyMShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czIxKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyMShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyMShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjEoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyMShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyMSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyMSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyMSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gZGVmYXVsdFVuaXFCeShlbnRyeSkgewogIHJldHVybiBlbnRyeS5kYXRhS2V5Owp9CmZ1bmN0aW9uIHJlbmRlckNvbnRlbnQoY29udGVudCwgcHJvcHMpIHsKICBpZiAoLyogQF9fUFVSRV9fICovIFJlYWN0MTIuaXNWYWxpZEVsZW1lbnQoY29udGVudCkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMi5jbG9uZUVsZW1lbnQoY29udGVudCwgcHJvcHMpOwogIH0KICBpZiAodHlwZW9mIGNvbnRlbnQgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMi5jcmVhdGVFbGVtZW50KGNvbnRlbnQsIHByb3BzKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEyLmNyZWF0ZUVsZW1lbnQoRGVmYXVsdFRvb2x0aXBDb250ZW50LCBwcm9wcyk7Cn0KdmFyIGVtcHR5UGF5bG9hZCA9IFtdOwp2YXIgZGVmYXVsdFRvb2x0aXBQcm9wcyA9IHsKICBhbGxvd0VzY2FwZVZpZXdCb3g6IHsKICAgIHg6IGZhbHNlLAogICAgeTogZmFsc2UKICB9LAogIGFuaW1hdGlvbkR1cmF0aW9uOiA0MDAsCiAgYW5pbWF0aW9uRWFzaW5nOiAiZWFzZSIsCiAgYXhpc0lkOiAwLAogIGNvbnRlbnRTdHlsZToge30sCiAgY3Vyc29yOiB0cnVlLAogIGZpbHRlck51bGw6IHRydWUsCiAgaXNBbmltYXRpb25BY3RpdmU6ICJhdXRvIiwKICBpdGVtU29ydGVyOiAibmFtZSIsCiAgaXRlbVN0eWxlOiB7fSwKICBsYWJlbFN0eWxlOiB7fSwKICBvZmZzZXQ6IDEwLAogIHJldmVyc2VEaXJlY3Rpb246IHsKICAgIHg6IGZhbHNlLAogICAgeTogZmFsc2UKICB9LAogIHNlcGFyYXRvcjogIiA6ICIsCiAgdHJpZ2dlcjogImhvdmVyIiwKICB1c2VUcmFuc2xhdGUzZDogZmFsc2UsCiAgd3JhcHBlclN0eWxlOiB7fQp9OwpmdW5jdGlvbiBUb29sdGlwKG91dHNpZGVQcm9wcykgewogIHZhciBfdXNlQXBwU2VsZWN0b3IsIF9yZWYyOwogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCBkZWZhdWx0VG9vbHRpcFByb3BzKTsKICB2YXIgewogICAgYWN0aXZlOiBhY3RpdmVGcm9tUHJvcHMsCiAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIGNvbnRlbnQsCiAgICBmaWx0ZXJOdWxsLAogICAgaXNBbmltYXRpb25BY3RpdmUsCiAgICBvZmZzZXQsCiAgICBwYXlsb2FkVW5pcUJ5LAogICAgcG9zaXRpb24sCiAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgdXNlVHJhbnNsYXRlM2QsCiAgICB3cmFwcGVyU3R5bGUsCiAgICBjdXJzb3IsCiAgICBzaGFyZWQsCiAgICB0cmlnZ2VyLAogICAgZGVmYXVsdEluZGV4LAogICAgcG9ydGFsOiBwb3J0YWxGcm9tUHJvcHMsCiAgICBheGlzSWQKICB9ID0gcHJvcHM7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgZGVmYXVsdEluZGV4QXNTdHJpbmcgPSB0eXBlb2YgZGVmYXVsdEluZGV4ID09PSAibnVtYmVyIiA/IFN0cmluZyhkZWZhdWx0SW5kZXgpIDogZGVmYXVsdEluZGV4OwogICgwLCBpbXBvcnRfcmVhY3QyNC51c2VFZmZlY3QpKCgpID0+IHsKICAgIGRpc3BhdGNoKHNldFRvb2x0aXBTZXR0aW5nc1N0YXRlKHsKICAgICAgc2hhcmVkLAogICAgICB0cmlnZ2VyLAogICAgICBheGlzSWQsCiAgICAgIGFjdGl2ZTogYWN0aXZlRnJvbVByb3BzLAogICAgICBkZWZhdWx0SW5kZXg6IGRlZmF1bHRJbmRleEFzU3RyaW5nCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBzaGFyZWQsIHRyaWdnZXIsIGF4aXNJZCwgYWN0aXZlRnJvbVByb3BzLCBkZWZhdWx0SW5kZXhBc1N0cmluZ10pOwogIHZhciB2aWV3Qm94ID0gdXNlVmlld0JveCgpOwogIHZhciBhY2Nlc3NpYmlsaXR5TGF5ZXIgPSB1c2VBY2Nlc3NpYmlsaXR5TGF5ZXIoKTsKICB2YXIgdG9vbHRpcEV2ZW50VHlwZSA9IHVzZVRvb2x0aXBFdmVudFR5cGUoc2hhcmVkKTsKICB2YXIgewogICAgYWN0aXZlSW5kZXgsCiAgICBpc0FjdGl2ZQogIH0gPSAoX3VzZUFwcFNlbGVjdG9yID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RJc1Rvb2x0aXBBY3RpdmUyKHN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBkZWZhdWx0SW5kZXhBc1N0cmluZykpKSAhPT0gbnVsbCAmJiBfdXNlQXBwU2VsZWN0b3IgIT09IHZvaWQgMCA/IF91c2VBcHBTZWxlY3RvciA6IHt9OwogIHZhciBwYXlsb2FkRnJvbVJlZHV4ID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RUb29sdGlwUGF5bG9hZChzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4QXNTdHJpbmcpKTsKICB2YXIgbGFiZWxGcm9tUmVkdXggPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEFjdGl2ZUxhYmVsMihzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4QXNTdHJpbmcpKTsKICB2YXIgY29vcmRpbmF0ZSA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0QWN0aXZlQ29vcmRpbmF0ZShzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4QXNTdHJpbmcpKTsKICB2YXIgcGF5bG9hZCA9IHBheWxvYWRGcm9tUmVkdXg7CiAgdmFyIHRvb2x0aXBQb3J0YWxGcm9tQ29udGV4dCA9IHVzZVRvb2x0aXBQb3J0YWwoKTsKICB2YXIgZmluYWxJc0FjdGl2ZSA9IChfcmVmMiA9IGFjdGl2ZUZyb21Qcm9wcyAhPT0gbnVsbCAmJiBhY3RpdmVGcm9tUHJvcHMgIT09IHZvaWQgMCA/IGFjdGl2ZUZyb21Qcm9wcyA6IGlzQWN0aXZlKSAhPT0gbnVsbCAmJiBfcmVmMiAhPT0gdm9pZCAwID8gX3JlZjIgOiBmYWxzZTsKICB2YXIgW2xhc3RCb3VuZGluZ0JveCwgdXBkYXRlQm91bmRpbmdCb3hdID0gdXNlRWxlbWVudE9mZnNldChbcGF5bG9hZCwgZmluYWxJc0FjdGl2ZV0pOwogIHZhciBmaW5hbExhYmVsID0gdG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiID8gbGFiZWxGcm9tUmVkdXggOiB2b2lkIDA7CiAgdXNlVG9vbHRpcENoYXJ0U3luY2hyb25pc2F0aW9uKHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGNvb3JkaW5hdGUsIGZpbmFsTGFiZWwsIGFjdGl2ZUluZGV4LCBmaW5hbElzQWN0aXZlKTsKICB2YXIgdG9vbHRpcFBvcnRhbCA9IHBvcnRhbEZyb21Qcm9wcyAhPT0gbnVsbCAmJiBwb3J0YWxGcm9tUHJvcHMgIT09IHZvaWQgMCA/IHBvcnRhbEZyb21Qcm9wcyA6IHRvb2x0aXBQb3J0YWxGcm9tQ29udGV4dDsKICBpZiAodG9vbHRpcFBvcnRhbCA9PSBudWxsIHx8IHZpZXdCb3ggPT0gbnVsbCB8fCB0b29sdGlwRXZlbnRUeXBlID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgZmluYWxQYXlsb2FkID0gcGF5bG9hZCAhPT0gbnVsbCAmJiBwYXlsb2FkICE9PSB2b2lkIDAgPyBwYXlsb2FkIDogZW1wdHlQYXlsb2FkOwogIGlmICghZmluYWxJc0FjdGl2ZSkgewogICAgZmluYWxQYXlsb2FkID0gZW1wdHlQYXlsb2FkOwogIH0KICBpZiAoZmlsdGVyTnVsbCAmJiBmaW5hbFBheWxvYWQubGVuZ3RoKSB7CiAgICBmaW5hbFBheWxvYWQgPSBnZXRVbmlxUGF5bG9hZChmaW5hbFBheWxvYWQuZmlsdGVyKChlbnRyeSkgPT4gZW50cnkudmFsdWUgIT0gbnVsbCAmJiAoZW50cnkuaGlkZSAhPT0gdHJ1ZSB8fCBwcm9wcy5pbmNsdWRlSGlkZGVuKSksIHBheWxvYWRVbmlxQnksIGRlZmF1bHRVbmlxQnkpOwogIH0KICB2YXIgaGFzUGF5bG9hZCA9IGZpbmFsUGF5bG9hZC5sZW5ndGggPiAwOwogIHZhciB0b29sdGlwRWxlbWVudCA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEyLmNyZWF0ZUVsZW1lbnQoVG9vbHRpcEJvdW5kaW5nQm94LCB7CiAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIGlzQW5pbWF0aW9uQWN0aXZlLAogICAgYWN0aXZlOiBmaW5hbElzQWN0aXZlLAogICAgY29vcmRpbmF0ZSwKICAgIGhhc1BheWxvYWQsCiAgICBvZmZzZXQsCiAgICBwb3NpdGlvbiwKICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICB1c2VUcmFuc2xhdGUzZCwKICAgIHZpZXdCb3gsCiAgICB3cmFwcGVyU3R5bGUsCiAgICBsYXN0Qm91bmRpbmdCb3gsCiAgICBpbm5lclJlZjogdXBkYXRlQm91bmRpbmdCb3gsCiAgICBoYXNQb3J0YWxGcm9tUHJvcHM6IEJvb2xlYW4ocG9ydGFsRnJvbVByb3BzKQogIH0sIHJlbmRlckNvbnRlbnQoY29udGVudCwgX29iamVjdFNwcmVhZDIxKF9vYmplY3RTcHJlYWQyMSh7fSwgcHJvcHMpLCB7fSwgewogICAgcGF5bG9hZDogZmluYWxQYXlsb2FkLAogICAgbGFiZWw6IGZpbmFsTGFiZWwsCiAgICBhY3RpdmU6IGZpbmFsSXNBY3RpdmUsCiAgICBhY3RpdmVJbmRleCwKICAgIGNvb3JkaW5hdGUsCiAgICBhY2Nlc3NpYmlsaXR5TGF5ZXIKICB9KSkpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMi5jcmVhdGVFbGVtZW50KFJlYWN0MTIuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0X2RvbTIuY3JlYXRlUG9ydGFsKSh0b29sdGlwRWxlbWVudCwgdG9vbHRpcFBvcnRhbCksIGZpbmFsSXNBY3RpdmUgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MTIuY3JlYXRlRWxlbWVudChDdXJzb3IsIHsKICAgIGN1cnNvciwKICAgIHRvb2x0aXBFdmVudFR5cGUsCiAgICBjb29yZGluYXRlLAogICAgcGF5bG9hZDogZmluYWxQYXlsb2FkLAogICAgaW5kZXg6IGFjdGl2ZUluZGV4CiAgfSkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVGV4dC5qcwp2YXIgUmVhY3QxMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDI1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9MUlVDYWNoZS5qcwpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyMihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTIyKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTIyKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTIyKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTIyKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgTFJVQ2FjaGUgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IobWF4U2l6ZSkgewogICAgX2RlZmluZVByb3BlcnR5MjIodGhpcywgImNhY2hlIiwgLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSk7CiAgICB0aGlzLm1heFNpemUgPSBtYXhTaXplOwogIH0KICBnZXQoa2V5KSB7CiAgICB2YXIgdmFsdWUgPSB0aGlzLmNhY2hlLmdldChrZXkpOwogICAgaWYgKHZhbHVlICE9PSB2b2lkIDApIHsKICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTsKICAgICAgdGhpcy5jYWNoZS5zZXQoa2V5LCB2YWx1ZSk7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIHNldChrZXksIHZhbHVlKSB7CiAgICBpZiAodGhpcy5jYWNoZS5oYXMoa2V5KSkgewogICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpOwogICAgfSBlbHNlIGlmICh0aGlzLmNhY2hlLnNpemUgPj0gdGhpcy5tYXhTaXplKSB7CiAgICAgIHZhciBmaXJzdEtleSA9IHRoaXMuY2FjaGUua2V5cygpLm5leHQoKS52YWx1ZTsKICAgICAgaWYgKGZpcnN0S2V5ICE9IG51bGwpIHsKICAgICAgICB0aGlzLmNhY2hlLmRlbGV0ZShmaXJzdEtleSk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuY2FjaGUuc2V0KGtleSwgdmFsdWUpOwogIH0KICBjbGVhcigpIHsKICAgIHRoaXMuY2FjaGUuY2xlYXIoKTsKICB9CiAgc2l6ZSgpIHsKICAgIHJldHVybiB0aGlzLmNhY2hlLnNpemU7CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9ET01VdGlscy5qcwpmdW5jdGlvbiBvd25LZXlzMjIoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyMihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czIyKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyMyhlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyMihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjMoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyMyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyMyh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyMyh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyMyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGRlZmF1bHRDb25maWcgPSB7CiAgY2FjaGVTaXplOiAyZTMsCiAgZW5hYmxlQ2FjaGU6IHRydWUKfTsKdmFyIGN1cnJlbnRDb25maWcgPSBfb2JqZWN0U3ByZWFkMjIoe30sIGRlZmF1bHRDb25maWcpOwp2YXIgc3RyaW5nQ2FjaGUgPSBuZXcgTFJVQ2FjaGUoY3VycmVudENvbmZpZy5jYWNoZVNpemUpOwp2YXIgU1BBTl9TVFlMRSA9IHsKICBwb3NpdGlvbjogImFic29sdXRlIiwKICB0b3A6ICItMjAwMDBweCIsCiAgbGVmdDogMCwKICBwYWRkaW5nOiAwLAogIG1hcmdpbjogMCwKICBib3JkZXI6ICJub25lIiwKICB3aGl0ZVNwYWNlOiAicHJlIgp9Owp2YXIgTUVBU1VSRU1FTlRfU1BBTl9JRCA9ICJyZWNoYXJ0c19tZWFzdXJlbWVudF9zcGFuIjsKZnVuY3Rpb24gY3JlYXRlQ2FjaGVLZXkodGV4dCwgc3R5bGUpIHsKICB2YXIgZm9udFNpemUgPSBzdHlsZS5mb250U2l6ZSB8fCAiIjsKICB2YXIgZm9udEZhbWlseSA9IHN0eWxlLmZvbnRGYW1pbHkgfHwgIiI7CiAgdmFyIGZvbnRXZWlnaHQgPSBzdHlsZS5mb250V2VpZ2h0IHx8ICIiOwogIHZhciBmb250U3R5bGUgPSBzdHlsZS5mb250U3R5bGUgfHwgIiI7CiAgdmFyIGxldHRlclNwYWNpbmcgPSBzdHlsZS5sZXR0ZXJTcGFjaW5nIHx8ICIiOwogIHZhciB0ZXh0VHJhbnNmb3JtID0gc3R5bGUudGV4dFRyYW5zZm9ybSB8fCAiIjsKICByZXR1cm4gIiIuY29uY2F0KHRleHQsICJ8IikuY29uY2F0KGZvbnRTaXplLCAifCIpLmNvbmNhdChmb250RmFtaWx5LCAifCIpLmNvbmNhdChmb250V2VpZ2h0LCAifCIpLmNvbmNhdChmb250U3R5bGUsICJ8IikuY29uY2F0KGxldHRlclNwYWNpbmcsICJ8IikuY29uY2F0KHRleHRUcmFuc2Zvcm0pOwp9CnZhciBtZWFzdXJlVGV4dFdpdGhET00gPSAodGV4dCwgc3R5bGUpID0+IHsKICB0cnkgewogICAgdmFyIG1lYXN1cmVtZW50U3BhbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKE1FQVNVUkVNRU5UX1NQQU5fSUQpOwogICAgaWYgKCFtZWFzdXJlbWVudFNwYW4pIHsKICAgICAgbWVhc3VyZW1lbnRTcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgICBtZWFzdXJlbWVudFNwYW4uc2V0QXR0cmlidXRlKCJpZCIsIE1FQVNVUkVNRU5UX1NQQU5fSUQpOwogICAgICBtZWFzdXJlbWVudFNwYW4uc2V0QXR0cmlidXRlKCJhcmlhLWhpZGRlbiIsICJ0cnVlIik7CiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobWVhc3VyZW1lbnRTcGFuKTsKICAgIH0KICAgIE9iamVjdC5hc3NpZ24obWVhc3VyZW1lbnRTcGFuLnN0eWxlLCBTUEFOX1NUWUxFLCBzdHlsZSk7CiAgICBtZWFzdXJlbWVudFNwYW4udGV4dENvbnRlbnQgPSAiIi5jb25jYXQodGV4dCk7CiAgICB2YXIgcmVjdCA9IG1lYXN1cmVtZW50U3Bhbi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIHJldHVybiB7CiAgICAgIHdpZHRoOiByZWN0LndpZHRoLAogICAgICBoZWlnaHQ6IHJlY3QuaGVpZ2h0CiAgICB9OwogIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgIHJldHVybiB7CiAgICAgIHdpZHRoOiAwLAogICAgICBoZWlnaHQ6IDAKICAgIH07CiAgfQp9Owp2YXIgZ2V0U3RyaW5nU2l6ZSA9IGZ1bmN0aW9uIGdldFN0cmluZ1NpemUyKHRleHQpIHsKICB2YXIgc3R5bGUgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6IHt9OwogIGlmICh0ZXh0ID09PSB2b2lkIDAgfHwgdGV4dCA9PT0gbnVsbCB8fCBHbG9iYWwuaXNTc3IpIHsKICAgIHJldHVybiB7CiAgICAgIHdpZHRoOiAwLAogICAgICBoZWlnaHQ6IDAKICAgIH07CiAgfQogIGlmICghY3VycmVudENvbmZpZy5lbmFibGVDYWNoZSkgewogICAgcmV0dXJuIG1lYXN1cmVUZXh0V2l0aERPTSh0ZXh0LCBzdHlsZSk7CiAgfQogIHZhciBjYWNoZUtleSA9IGNyZWF0ZUNhY2hlS2V5KHRleHQsIHN0eWxlKTsKICB2YXIgY2FjaGVkUmVzdWx0ID0gc3RyaW5nQ2FjaGUuZ2V0KGNhY2hlS2V5KTsKICBpZiAoY2FjaGVkUmVzdWx0KSB7CiAgICByZXR1cm4gY2FjaGVkUmVzdWx0OwogIH0KICB2YXIgcmVzdWx0ID0gbWVhc3VyZVRleHRXaXRoRE9NKHRleHQsIHN0eWxlKTsKICBzdHJpbmdDYWNoZS5zZXQoY2FjaGVLZXksIHJlc3VsdCk7CiAgcmV0dXJuIHJlc3VsdDsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvUmVkdWNlQ1NTQ2FsYy5qcwp2YXIgTVVMVElQTFlfT1JfRElWSURFX1JFR0VYID0gLygtP1xkKyg/OlwuXGQrKT9bYS16QS1aJV0qKShbKi9dKSgtP1xkKyg/OlwuXGQrKT9bYS16QS1aJV0qKS87CnZhciBBRERfT1JfU1VCVFJBQ1RfUkVHRVggPSAvKC0/XGQrKD86XC5cZCspP1thLXpBLVolXSopKFsrLV0pKC0/XGQrKD86XC5cZCspP1thLXpBLVolXSopLzsKdmFyIENTU19MRU5HVEhfVU5JVF9SRUdFWCA9IC9ecHh8Y218dmh8dnd8ZW18cmVtfCV8bW18aW58cHR8cGN8ZXh8Y2h8dm1pbnx2bWF4fFEkLzsKdmFyIE5VTV9TUExJVF9SRUdFWCA9IC8oLT9cZCsoPzpcLlxkKyk/KShbYS16QS1aJV0rKT8vOwp2YXIgQ09OVkVSU0lPTl9SQVRFUyA9IHsKICBjbTogOTYgLyAyLjU0LAogIG1tOiA5NiAvIDI1LjQsCiAgcHQ6IDk2IC8gNzIsCiAgcGM6IDk2IC8gNiwKICBpbjogOTYsCiAgUTogOTYgLyAoMi41NCAqIDQwKSwKICBweDogMQp9Owp2YXIgRklYRURfQ1NTX0xFTkdUSF9VTklUUyA9IE9iamVjdC5rZXlzKENPTlZFUlNJT05fUkFURVMpOwp2YXIgU1RSX05BTiA9ICJOYU4iOwpmdW5jdGlvbiBjb252ZXJ0VG9QeCh2YWx1ZSwgdW5pdDIpIHsKICByZXR1cm4gdmFsdWUgKiBDT05WRVJTSU9OX1JBVEVTW3VuaXQyXTsKfQp2YXIgRGVjaW1hbENTUyA9IGNsYXNzIF9EZWNpbWFsQ1NTIHsKICBzdGF0aWMgcGFyc2Uoc3RyKSB7CiAgICB2YXIgX05VTV9TUExJVF9SRUdFWCRleGVjOwogICAgdmFyIFssIG51bVN0ciwgdW5pdDJdID0gKF9OVU1fU1BMSVRfUkVHRVgkZXhlYyA9IE5VTV9TUExJVF9SRUdFWC5leGVjKHN0cikpICE9PSBudWxsICYmIF9OVU1fU1BMSVRfUkVHRVgkZXhlYyAhPT0gdm9pZCAwID8gX05VTV9TUExJVF9SRUdFWCRleGVjIDogW107CiAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKHBhcnNlRmxvYXQobnVtU3RyKSwgdW5pdDIgIT09IG51bGwgJiYgdW5pdDIgIT09IHZvaWQgMCA/IHVuaXQyIDogIiIpOwogIH0KICBjb25zdHJ1Y3RvcihudW0sIHVuaXQyKSB7CiAgICB0aGlzLm51bSA9IG51bTsKICAgIHRoaXMudW5pdCA9IHVuaXQyOwogICAgdGhpcy5udW0gPSBudW07CiAgICB0aGlzLnVuaXQgPSB1bml0MjsKICAgIGlmIChpc05hbihudW0pKSB7CiAgICAgIHRoaXMudW5pdCA9ICIiOwogICAgfQogICAgaWYgKHVuaXQyICE9PSAiIiAmJiAhQ1NTX0xFTkdUSF9VTklUX1JFR0VYLnRlc3QodW5pdDIpKSB7CiAgICAgIHRoaXMubnVtID0gTmFOOwogICAgICB0aGlzLnVuaXQgPSAiIjsKICAgIH0KICAgIGlmIChGSVhFRF9DU1NfTEVOR1RIX1VOSVRTLmluY2x1ZGVzKHVuaXQyKSkgewogICAgICB0aGlzLm51bSA9IGNvbnZlcnRUb1B4KG51bSwgdW5pdDIpOwogICAgICB0aGlzLnVuaXQgPSAicHgiOwogICAgfQogIH0KICBhZGQob3RoZXIpIHsKICAgIGlmICh0aGlzLnVuaXQgIT09IG90aGVyLnVuaXQpIHsKICAgICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyhOYU4sICIiKTsKICAgIH0KICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1ModGhpcy5udW0gKyBvdGhlci5udW0sIHRoaXMudW5pdCk7CiAgfQogIHN1YnRyYWN0KG90aGVyKSB7CiAgICBpZiAodGhpcy51bml0ICE9PSBvdGhlci51bml0KSB7CiAgICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1MoTmFOLCAiIik7CiAgICB9CiAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKHRoaXMubnVtIC0gb3RoZXIubnVtLCB0aGlzLnVuaXQpOwogIH0KICBtdWx0aXBseShvdGhlcikgewogICAgaWYgKHRoaXMudW5pdCAhPT0gIiIgJiYgb3RoZXIudW5pdCAhPT0gIiIgJiYgdGhpcy51bml0ICE9PSBvdGhlci51bml0KSB7CiAgICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1MoTmFOLCAiIik7CiAgICB9CiAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKHRoaXMubnVtICogb3RoZXIubnVtLCB0aGlzLnVuaXQgfHwgb3RoZXIudW5pdCk7CiAgfQogIGRpdmlkZShvdGhlcikgewogICAgaWYgKHRoaXMudW5pdCAhPT0gIiIgJiYgb3RoZXIudW5pdCAhPT0gIiIgJiYgdGhpcy51bml0ICE9PSBvdGhlci51bml0KSB7CiAgICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1MoTmFOLCAiIik7CiAgICB9CiAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKHRoaXMubnVtIC8gb3RoZXIubnVtLCB0aGlzLnVuaXQgfHwgb3RoZXIudW5pdCk7CiAgfQogIHRvU3RyaW5nKCkgewogICAgcmV0dXJuICIiLmNvbmNhdCh0aGlzLm51bSkuY29uY2F0KHRoaXMudW5pdCk7CiAgfQogIGlzTmFOKCkgewogICAgcmV0dXJuIGlzTmFuKHRoaXMubnVtKTsKICB9Cn07CmZ1bmN0aW9uIGNhbGN1bGF0ZUFyaXRobWV0aWMoZXhwcikgewogIGlmIChleHByLmluY2x1ZGVzKFNUUl9OQU4pKSB7CiAgICByZXR1cm4gU1RSX05BTjsKICB9CiAgdmFyIG5ld0V4cHIgPSBleHByOwogIHdoaWxlIChuZXdFeHByLmluY2x1ZGVzKCIqIikgfHwgbmV3RXhwci5pbmNsdWRlcygiLyIpKSB7CiAgICB2YXIgX01VTFRJUExZX09SX0RJVklERV9SOwogICAgdmFyIFssIGxlZnRPcGVyYW5kLCBvcGVyYXRvciwgcmlnaHRPcGVyYW5kXSA9IChfTVVMVElQTFlfT1JfRElWSURFX1IgPSBNVUxUSVBMWV9PUl9ESVZJREVfUkVHRVguZXhlYyhuZXdFeHByKSkgIT09IG51bGwgJiYgX01VTFRJUExZX09SX0RJVklERV9SICE9PSB2b2lkIDAgPyBfTVVMVElQTFlfT1JfRElWSURFX1IgOiBbXTsKICAgIHZhciBsVHMgPSBEZWNpbWFsQ1NTLnBhcnNlKGxlZnRPcGVyYW5kICE9PSBudWxsICYmIGxlZnRPcGVyYW5kICE9PSB2b2lkIDAgPyBsZWZ0T3BlcmFuZCA6ICIiKTsKICAgIHZhciByVHMgPSBEZWNpbWFsQ1NTLnBhcnNlKHJpZ2h0T3BlcmFuZCAhPT0gbnVsbCAmJiByaWdodE9wZXJhbmQgIT09IHZvaWQgMCA/IHJpZ2h0T3BlcmFuZCA6ICIiKTsKICAgIHZhciByZXN1bHQgPSBvcGVyYXRvciA9PT0gIioiID8gbFRzLm11bHRpcGx5KHJUcykgOiBsVHMuZGl2aWRlKHJUcyk7CiAgICBpZiAocmVzdWx0LmlzTmFOKCkpIHsKICAgICAgcmV0dXJuIFNUUl9OQU47CiAgICB9CiAgICBuZXdFeHByID0gbmV3RXhwci5yZXBsYWNlKE1VTFRJUExZX09SX0RJVklERV9SRUdFWCwgcmVzdWx0LnRvU3RyaW5nKCkpOwogIH0KICB3aGlsZSAobmV3RXhwci5pbmNsdWRlcygiKyIpIHx8IC8uLVxkKyg/OlwuXGQrKT8vLnRlc3QobmV3RXhwcikpIHsKICAgIHZhciBfQUREX09SX1NVQlRSQUNUX1JFR0U7CiAgICB2YXIgWywgX2xlZnRPcGVyYW5kLCBfb3BlcmF0b3IsIF9yaWdodE9wZXJhbmRdID0gKF9BRERfT1JfU1VCVFJBQ1RfUkVHRSA9IEFERF9PUl9TVUJUUkFDVF9SRUdFWC5leGVjKG5ld0V4cHIpKSAhPT0gbnVsbCAmJiBfQUREX09SX1NVQlRSQUNUX1JFR0UgIT09IHZvaWQgMCA/IF9BRERfT1JfU1VCVFJBQ1RfUkVHRSA6IFtdOwogICAgdmFyIF9sVHMgPSBEZWNpbWFsQ1NTLnBhcnNlKF9sZWZ0T3BlcmFuZCAhPT0gbnVsbCAmJiBfbGVmdE9wZXJhbmQgIT09IHZvaWQgMCA/IF9sZWZ0T3BlcmFuZCA6ICIiKTsKICAgIHZhciBfclRzID0gRGVjaW1hbENTUy5wYXJzZShfcmlnaHRPcGVyYW5kICE9PSBudWxsICYmIF9yaWdodE9wZXJhbmQgIT09IHZvaWQgMCA/IF9yaWdodE9wZXJhbmQgOiAiIik7CiAgICB2YXIgX3Jlc3VsdCA9IF9vcGVyYXRvciA9PT0gIisiID8gX2xUcy5hZGQoX3JUcykgOiBfbFRzLnN1YnRyYWN0KF9yVHMpOwogICAgaWYgKF9yZXN1bHQuaXNOYU4oKSkgewogICAgICByZXR1cm4gU1RSX05BTjsKICAgIH0KICAgIG5ld0V4cHIgPSBuZXdFeHByLnJlcGxhY2UoQUREX09SX1NVQlRSQUNUX1JFR0VYLCBfcmVzdWx0LnRvU3RyaW5nKCkpOwogIH0KICByZXR1cm4gbmV3RXhwcjsKfQp2YXIgUEFSRU5USEVTRVNfUkVHRVggPSAvXCgoW14oKV0qKVwpLzsKZnVuY3Rpb24gY2FsY3VsYXRlUGFyZW50aGVzZXMoZXhwcikgewogIHZhciBuZXdFeHByID0gZXhwcjsKICB2YXIgbWF0Y2g7CiAgd2hpbGUgKChtYXRjaCA9IFBBUkVOVEhFU0VTX1JFR0VYLmV4ZWMobmV3RXhwcikpICE9IG51bGwpIHsKICAgIHZhciBbLCBwYXJlbnRoZXRpY2FsRXhwcmVzc2lvbl0gPSBtYXRjaDsKICAgIG5ld0V4cHIgPSBuZXdFeHByLnJlcGxhY2UoUEFSRU5USEVTRVNfUkVHRVgsIGNhbGN1bGF0ZUFyaXRobWV0aWMocGFyZW50aGV0aWNhbEV4cHJlc3Npb24pKTsKICB9CiAgcmV0dXJuIG5ld0V4cHI7Cn0KZnVuY3Rpb24gZXZhbHVhdGVFeHByZXNzaW9uKGV4cHJlc3Npb24pIHsKICB2YXIgbmV3RXhwciA9IGV4cHJlc3Npb24ucmVwbGFjZSgvXHMrL2csICIiKTsKICBuZXdFeHByID0gY2FsY3VsYXRlUGFyZW50aGVzZXMobmV3RXhwcik7CiAgbmV3RXhwciA9IGNhbGN1bGF0ZUFyaXRobWV0aWMobmV3RXhwcik7CiAgcmV0dXJuIG5ld0V4cHI7Cn0KZnVuY3Rpb24gc2FmZUV2YWx1YXRlRXhwcmVzc2lvbihleHByZXNzaW9uKSB7CiAgdHJ5IHsKICAgIHJldHVybiBldmFsdWF0ZUV4cHJlc3Npb24oZXhwcmVzc2lvbik7CiAgfSBjYXRjaCAoX3VudXNlZCkgewogICAgcmV0dXJuIFNUUl9OQU47CiAgfQp9CmZ1bmN0aW9uIHJlZHVjZUNTU0NhbGMoZXhwcmVzc2lvbikgewogIHZhciByZXN1bHQgPSBzYWZlRXZhbHVhdGVFeHByZXNzaW9uKGV4cHJlc3Npb24uc2xpY2UoNSwgLTEpKTsKICBpZiAocmVzdWx0ID09PSBTVFJfTkFOKSB7CiAgICByZXR1cm4gIiI7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9UZXh0LmpzCnZhciBfZXhjbHVkZWQ2ID0gWyJ4IiwgInkiLCAibGluZUhlaWdodCIsICJjYXBIZWlnaHQiLCAiZmlsbCIsICJzY2FsZVRvRml0IiwgInRleHRBbmNob3IiLCAidmVydGljYWxBbmNob3IiXTsKdmFyIF9leGNsdWRlZDIzID0gWyJkeCIsICJkeSIsICJhbmdsZSIsICJjbGFzc05hbWUiLCAiYnJlYWtBbGwiXTsKZnVuY3Rpb24gX2V4dGVuZHMxMCgpIHsKICByZXR1cm4gX2V4dGVuZHMxMCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTAuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM2KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U2KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U2KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgQlJFQUtJTkdfU1BBQ0VTID0gL1sgXGZcblxyXHRcdlx1MjAyOFx1MjAyOV0rLzsKdmFyIGNhbGN1bGF0ZVdvcmRXaWR0aHMgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICBicmVha0FsbCwKICAgIHN0eWxlCiAgfSA9IF9yZWYyOwogIHRyeSB7CiAgICB2YXIgd29yZHMgPSBbXTsKICAgIGlmICghaXNOdWxsaXNoKGNoaWxkcmVuKSkgewogICAgICBpZiAoYnJlYWtBbGwpIHsKICAgICAgICB3b3JkcyA9IGNoaWxkcmVuLnRvU3RyaW5nKCkuc3BsaXQoIiIpOwogICAgICB9IGVsc2UgewogICAgICAgIHdvcmRzID0gY2hpbGRyZW4udG9TdHJpbmcoKS5zcGxpdChCUkVBS0lOR19TUEFDRVMpOwogICAgICB9CiAgICB9CiAgICB2YXIgd29yZHNXaXRoQ29tcHV0ZWRXaWR0aCA9IHdvcmRzLm1hcCgod29yZCkgPT4gKHsKICAgICAgd29yZCwKICAgICAgd2lkdGg6IGdldFN0cmluZ1NpemUod29yZCwgc3R5bGUpLndpZHRoCiAgICB9KSk7CiAgICB2YXIgc3BhY2VXaWR0aCA9IGJyZWFrQWxsID8gMCA6IGdldFN0cmluZ1NpemUoIlx4QTAiLCBzdHlsZSkud2lkdGg7CiAgICByZXR1cm4gewogICAgICB3b3Jkc1dpdGhDb21wdXRlZFdpZHRoLAogICAgICBzcGFjZVdpZHRoCiAgICB9OwogIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgIHJldHVybiBudWxsOwogIH0KfTsKZnVuY3Rpb24gaXNWYWxpZFRleHRBbmNob3IodmFsdWUpIHsKICByZXR1cm4gdmFsdWUgPT09ICJzdGFydCIgfHwgdmFsdWUgPT09ICJtaWRkbGUiIHx8IHZhbHVlID09PSAiZW5kIiB8fCB2YWx1ZSA9PT0gImluaGVyaXQiOwp9CnZhciBjYWxjdWxhdGUgPSAod29yZHMsIGxpbmVXaWR0aCwgc3BhY2VXaWR0aCwgc2NhbGVUb0ZpdCkgPT4gd29yZHMucmVkdWNlKChyZXN1bHQsIF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIHdvcmQsCiAgICB3aWR0aAogIH0gPSBfcmVmMjsKICB2YXIgY3VycmVudExpbmUgPSByZXN1bHRbcmVzdWx0Lmxlbmd0aCAtIDFdOwogIGlmIChjdXJyZW50TGluZSAmJiB3aWR0aCAhPSBudWxsICYmIChsaW5lV2lkdGggPT0gbnVsbCB8fCBzY2FsZVRvRml0IHx8IGN1cnJlbnRMaW5lLndpZHRoICsgd2lkdGggKyBzcGFjZVdpZHRoIDwgTnVtYmVyKGxpbmVXaWR0aCkpKSB7CiAgICBjdXJyZW50TGluZS53b3Jkcy5wdXNoKHdvcmQpOwogICAgY3VycmVudExpbmUud2lkdGggKz0gd2lkdGggKyBzcGFjZVdpZHRoOwogIH0gZWxzZSB7CiAgICB2YXIgbmV3TGluZSA9IHsKICAgICAgd29yZHM6IFt3b3JkXSwKICAgICAgd2lkdGgKICAgIH07CiAgICByZXN1bHQucHVzaChuZXdMaW5lKTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfSwgW10pOwp2YXIgZmluZExvbmdlc3RMaW5lID0gKHdvcmRzKSA9PiB3b3Jkcy5yZWR1Y2UoKGEsIGIpID0+IGEud2lkdGggPiBiLndpZHRoID8gYSA6IGIpOwp2YXIgc3VmZml4ID0gIlx1MjAyNiI7CnZhciBjaGVja092ZXJmbG93ID0gKHRleHQsIGluZGV4LCBicmVha0FsbCwgc3R5bGUsIG1heExpbmVzLCBsaW5lV2lkdGgsIHNwYWNlV2lkdGgsIHNjYWxlVG9GaXQpID0+IHsKICB2YXIgdGVtcFRleHQgPSB0ZXh0LnNsaWNlKDAsIGluZGV4KTsKICB2YXIgd29yZHMgPSBjYWxjdWxhdGVXb3JkV2lkdGhzKHsKICAgIGJyZWFrQWxsLAogICAgc3R5bGUsCiAgICBjaGlsZHJlbjogdGVtcFRleHQgKyBzdWZmaXgKICB9KTsKICBpZiAoIXdvcmRzKSB7CiAgICByZXR1cm4gW2ZhbHNlLCBbXV07CiAgfQogIHZhciByZXN1bHQgPSBjYWxjdWxhdGUod29yZHMud29yZHNXaXRoQ29tcHV0ZWRXaWR0aCwgbGluZVdpZHRoLCBzcGFjZVdpZHRoLCBzY2FsZVRvRml0KTsKICB2YXIgZG9lc092ZXJmbG93ID0gcmVzdWx0Lmxlbmd0aCA+IG1heExpbmVzIHx8IGZpbmRMb25nZXN0TGluZShyZXN1bHQpLndpZHRoID4gTnVtYmVyKGxpbmVXaWR0aCk7CiAgcmV0dXJuIFtkb2VzT3ZlcmZsb3csIHJlc3VsdF07Cn07CnZhciBjYWxjdWxhdGVXb3Jkc0J5TGluZXMgPSAoX3JlZjMsIGluaXRpYWxXb3Jkc1dpdGhDb21wdXRlZFdpdGgsIHNwYWNlV2lkdGgsIGxpbmVXaWR0aCwgc2NhbGVUb0ZpdCkgPT4gewogIHZhciB7CiAgICBtYXhMaW5lcywKICAgIGNoaWxkcmVuLAogICAgc3R5bGUsCiAgICBicmVha0FsbAogIH0gPSBfcmVmMzsKICB2YXIgc2hvdWxkTGltaXRMaW5lcyA9IGlzTnVtYmVyKG1heExpbmVzKTsKICB2YXIgdGV4dCA9IFN0cmluZyhjaGlsZHJlbik7CiAgdmFyIG9yaWdpbmFsUmVzdWx0ID0gY2FsY3VsYXRlKGluaXRpYWxXb3Jkc1dpdGhDb21wdXRlZFdpdGgsIGxpbmVXaWR0aCwgc3BhY2VXaWR0aCwgc2NhbGVUb0ZpdCk7CiAgaWYgKCFzaG91bGRMaW1pdExpbmVzIHx8IHNjYWxlVG9GaXQpIHsKICAgIHJldHVybiBvcmlnaW5hbFJlc3VsdDsKICB9CiAgdmFyIG92ZXJmbG93cyA9IG9yaWdpbmFsUmVzdWx0Lmxlbmd0aCA+IG1heExpbmVzIHx8IGZpbmRMb25nZXN0TGluZShvcmlnaW5hbFJlc3VsdCkud2lkdGggPiBOdW1iZXIobGluZVdpZHRoKTsKICBpZiAoIW92ZXJmbG93cykgewogICAgcmV0dXJuIG9yaWdpbmFsUmVzdWx0OwogIH0KICB2YXIgc3RhcnQgPSAwOwogIHZhciBlbmQgPSB0ZXh0Lmxlbmd0aCAtIDE7CiAgdmFyIGl0ZXJhdGlvbnMgPSAwOwogIHZhciB0cmltbWVkUmVzdWx0OwogIHdoaWxlIChzdGFydCA8PSBlbmQgJiYgaXRlcmF0aW9ucyA8PSB0ZXh0Lmxlbmd0aCAtIDEpIHsKICAgIHZhciBtaWRkbGUgPSBNYXRoLmZsb29yKChzdGFydCArIGVuZCkgLyAyKTsKICAgIHZhciBwcmV2ID0gbWlkZGxlIC0gMTsKICAgIHZhciBbZG9lc1ByZXZPdmVyZmxvdywgcmVzdWx0XSA9IGNoZWNrT3ZlcmZsb3codGV4dCwgcHJldiwgYnJlYWtBbGwsIHN0eWxlLCBtYXhMaW5lcywgbGluZVdpZHRoLCBzcGFjZVdpZHRoLCBzY2FsZVRvRml0KTsKICAgIHZhciBbZG9lc01pZGRsZU92ZXJmbG93XSA9IGNoZWNrT3ZlcmZsb3codGV4dCwgbWlkZGxlLCBicmVha0FsbCwgc3R5bGUsIG1heExpbmVzLCBsaW5lV2lkdGgsIHNwYWNlV2lkdGgsIHNjYWxlVG9GaXQpOwogICAgaWYgKCFkb2VzUHJldk92ZXJmbG93ICYmICFkb2VzTWlkZGxlT3ZlcmZsb3cpIHsKICAgICAgc3RhcnQgPSBtaWRkbGUgKyAxOwogICAgfQogICAgaWYgKGRvZXNQcmV2T3ZlcmZsb3cgJiYgZG9lc01pZGRsZU92ZXJmbG93KSB7CiAgICAgIGVuZCA9IG1pZGRsZSAtIDE7CiAgICB9CiAgICBpZiAoIWRvZXNQcmV2T3ZlcmZsb3cgJiYgZG9lc01pZGRsZU92ZXJmbG93KSB7CiAgICAgIHRyaW1tZWRSZXN1bHQgPSByZXN1bHQ7CiAgICAgIGJyZWFrOwogICAgfQogICAgaXRlcmF0aW9ucysrOwogIH0KICByZXR1cm4gdHJpbW1lZFJlc3VsdCB8fCBvcmlnaW5hbFJlc3VsdDsKfTsKdmFyIGdldFdvcmRzV2l0aG91dENhbGN1bGF0ZSA9IChjaGlsZHJlbikgPT4gewogIHZhciB3b3JkcyA9ICFpc051bGxpc2goY2hpbGRyZW4pID8gY2hpbGRyZW4udG9TdHJpbmcoKS5zcGxpdChCUkVBS0lOR19TUEFDRVMpIDogW107CiAgcmV0dXJuIFt7CiAgICB3b3JkcywKICAgIHdpZHRoOiB2b2lkIDAKICB9XTsKfTsKdmFyIGdldFdvcmRzQnlMaW5lcyA9IChfcmVmNCkgPT4gewogIHZhciB7CiAgICB3aWR0aCwKICAgIHNjYWxlVG9GaXQsCiAgICBjaGlsZHJlbiwKICAgIHN0eWxlLAogICAgYnJlYWtBbGwsCiAgICBtYXhMaW5lcwogIH0gPSBfcmVmNDsKICBpZiAoKHdpZHRoIHx8IHNjYWxlVG9GaXQpICYmICFHbG9iYWwuaXNTc3IpIHsKICAgIHZhciB3b3Jkc1dpdGhDb21wdXRlZFdpZHRoLCBzcGFjZVdpZHRoOwogICAgdmFyIHdvcmRXaWR0aHMgPSBjYWxjdWxhdGVXb3JkV2lkdGhzKHsKICAgICAgYnJlYWtBbGwsCiAgICAgIGNoaWxkcmVuLAogICAgICBzdHlsZQogICAgfSk7CiAgICBpZiAod29yZFdpZHRocykgewogICAgICB2YXIgewogICAgICAgIHdvcmRzV2l0aENvbXB1dGVkV2lkdGg6IHdjdywKICAgICAgICBzcGFjZVdpZHRoOiBzdwogICAgICB9ID0gd29yZFdpZHRoczsKICAgICAgd29yZHNXaXRoQ29tcHV0ZWRXaWR0aCA9IHdjdzsKICAgICAgc3BhY2VXaWR0aCA9IHN3OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGdldFdvcmRzV2l0aG91dENhbGN1bGF0ZShjaGlsZHJlbik7CiAgICB9CiAgICByZXR1cm4gY2FsY3VsYXRlV29yZHNCeUxpbmVzKHsKICAgICAgYnJlYWtBbGwsCiAgICAgIGNoaWxkcmVuLAogICAgICBtYXhMaW5lcywKICAgICAgc3R5bGUKICAgIH0sIHdvcmRzV2l0aENvbXB1dGVkV2lkdGgsIHNwYWNlV2lkdGgsIHdpZHRoLCBCb29sZWFuKHNjYWxlVG9GaXQpKTsKICB9CiAgcmV0dXJuIGdldFdvcmRzV2l0aG91dENhbGN1bGF0ZShjaGlsZHJlbik7Cn07CnZhciBERUZBVUxUX0ZJTEwgPSAiIzgwODA4MCI7CnZhciB0ZXh0RGVmYXVsdFByb3BzID0gewogIGFuZ2xlOiAwLAogIGJyZWFrQWxsOiBmYWxzZSwKICAvLyBNYWdpYyBudW1iZXIgZnJvbSBkMwogIGNhcEhlaWdodDogIjAuNzFlbSIsCiAgZmlsbDogREVGQVVMVF9GSUxMLAogIGxpbmVIZWlnaHQ6ICIxZW0iLAogIHNjYWxlVG9GaXQ6IGZhbHNlLAogIHRleHRBbmNob3I6ICJzdGFydCIsCiAgLy8gTWFpbnRhaW4gY29tcGF0IHdpdGggZXhpc3RpbmcgY2hhcnRzIC8gZGVmYXVsdCBTVkcgYmVoYXZpb3IKICB2ZXJ0aWNhbEFuY2hvcjogImVuZCIsCiAgeDogMCwKICB5OiAwCn07CnZhciBUZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNS5mb3J3YXJkUmVmKSgob3V0c2lkZVByb3BzLCByZWYpID0+IHsKICB2YXIgX3Jlc29sdmVEZWZhdWx0UHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgdGV4dERlZmF1bHRQcm9wcyksIHsKICAgIHg6IHByb3BzWCwKICAgIHk6IHByb3BzWSwKICAgIGxpbmVIZWlnaHQsCiAgICBjYXBIZWlnaHQsCiAgICBmaWxsLAogICAgc2NhbGVUb0ZpdCwKICAgIHRleHRBbmNob3IsCiAgICB2ZXJ0aWNhbEFuY2hvcgogIH0gPSBfcmVzb2x2ZURlZmF1bHRQcm9wcywgcHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM2KF9yZXNvbHZlRGVmYXVsdFByb3BzLCBfZXhjbHVkZWQ2KTsKICB2YXIgd29yZHNCeUxpbmVzID0gKDAsIGltcG9ydF9yZWFjdDI1LnVzZU1lbW8pKCgpID0+IHsKICAgIHJldHVybiBnZXRXb3Jkc0J5TGluZXMoewogICAgICBicmVha0FsbDogcHJvcHMuYnJlYWtBbGwsCiAgICAgIGNoaWxkcmVuOiBwcm9wcy5jaGlsZHJlbiwKICAgICAgbWF4TGluZXM6IHByb3BzLm1heExpbmVzLAogICAgICBzY2FsZVRvRml0LAogICAgICBzdHlsZTogcHJvcHMuc3R5bGUsCiAgICAgIHdpZHRoOiBwcm9wcy53aWR0aAogICAgfSk7CiAgfSwgW3Byb3BzLmJyZWFrQWxsLCBwcm9wcy5jaGlsZHJlbiwgcHJvcHMubWF4TGluZXMsIHNjYWxlVG9GaXQsIHByb3BzLnN0eWxlLCBwcm9wcy53aWR0aF0pOwogIHZhciB7CiAgICBkeCwKICAgIGR5LAogICAgYW5nbGUsCiAgICBjbGFzc05hbWUsCiAgICBicmVha0FsbAogIH0gPSBwcm9wcywgdGV4dFByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNihwcm9wcywgX2V4Y2x1ZGVkMjMpOwogIGlmICghaXNOdW1PclN0cihwcm9wc1gpIHx8ICFpc051bU9yU3RyKHByb3BzWSkgfHwgd29yZHNCeUxpbmVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB4MiA9IE51bWJlcihwcm9wc1gpICsgKGlzTnVtYmVyKGR4KSA/IGR4IDogMCk7CiAgdmFyIHkyID0gTnVtYmVyKHByb3BzWSkgKyAoaXNOdW1iZXIoZHkpID8gZHkgOiAwKTsKICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIoeDIpIHx8ICFpc1dlbGxCZWhhdmVkTnVtYmVyKHkyKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBzdGFydER5OwogIHN3aXRjaCAodmVydGljYWxBbmNob3IpIHsKICAgIGNhc2UgInN0YXJ0IjoKICAgICAgc3RhcnREeSA9IHJlZHVjZUNTU0NhbGMoImNhbGMoIi5jb25jYXQoY2FwSGVpZ2h0LCAiKSIpKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICJtaWRkbGUiOgogICAgICBzdGFydER5ID0gcmVkdWNlQ1NTQ2FsYygiY2FsYygiLmNvbmNhdCgod29yZHNCeUxpbmVzLmxlbmd0aCAtIDEpIC8gMiwgIiAqIC0iKS5jb25jYXQobGluZUhlaWdodCwgIiArICgiKS5jb25jYXQoY2FwSGVpZ2h0LCAiIC8gMikpIikpOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIHN0YXJ0RHkgPSByZWR1Y2VDU1NDYWxjKCJjYWxjKCIuY29uY2F0KHdvcmRzQnlMaW5lcy5sZW5ndGggLSAxLCAiICogLSIpLmNvbmNhdChsaW5lSGVpZ2h0LCAiKSIpKTsKICAgICAgYnJlYWs7CiAgfQogIHZhciB0cmFuc2Zvcm1zID0gW107CiAgaWYgKHNjYWxlVG9GaXQpIHsKICAgIHZhciBsaW5lV2lkdGggPSB3b3Jkc0J5TGluZXNbMF0ud2lkdGg7CiAgICB2YXIgewogICAgICB3aWR0aAogICAgfSA9IHByb3BzOwogICAgdHJhbnNmb3Jtcy5wdXNoKCJzY2FsZSgiLmNvbmNhdChpc051bWJlcih3aWR0aCkgJiYgaXNOdW1iZXIobGluZVdpZHRoKSA/IHdpZHRoIC8gbGluZVdpZHRoIDogMSwgIikiKSk7CiAgfQogIGlmIChhbmdsZSkgewogICAgdHJhbnNmb3Jtcy5wdXNoKCJyb3RhdGUoIi5jb25jYXQoYW5nbGUsICIsICIpLmNvbmNhdCh4MiwgIiwgIikuY29uY2F0KHkyLCAiKSIpKTsKICB9CiAgaWYgKHRyYW5zZm9ybXMubGVuZ3RoKSB7CiAgICB0ZXh0UHJvcHMudHJhbnNmb3JtID0gdHJhbnNmb3Jtcy5qb2luKCIgIik7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMy5jcmVhdGVFbGVtZW50KCJ0ZXh0IiwgX2V4dGVuZHMxMCh7fSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyh0ZXh0UHJvcHMpLCB7CiAgICByZWYsCiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy10ZXh0IiwgY2xhc3NOYW1lKSwKICAgIHRleHRBbmNob3IsCiAgICBmaWxsOiBmaWxsLmluY2x1ZGVzKCJ1cmwiKSA/IERFRkFVTFRfRklMTCA6IGZpbGwKICB9KSwgd29yZHNCeUxpbmVzLm1hcCgobGluZSwgaW5kZXgpID0+IHsKICAgIHZhciB3b3JkcyA9IGxpbmUud29yZHMuam9pbihicmVha0FsbCA/ICIiIDogIiAiKTsKICAgIHJldHVybiAoCiAgICAgIC8vIGR1cGxpY2F0ZSB3b3JkcyB3aWxsIGNhdXNlIGR1cGxpY2F0ZSBrZXlzIHdoaWNoIGlzIHdoeSB3ZSBhZGQgdGhlIGFycmF5IGluZGV4IGhlcmUKICAgICAgLyogQF9fUFVSRV9fICovIFJlYWN0MTMuY3JlYXRlRWxlbWVudCgidHNwYW4iLCB7CiAgICAgICAgeDogeDIsCiAgICAgICAgZHk6IGluZGV4ID09PSAwID8gc3RhcnREeSA6IGxpbmVIZWlnaHQsCiAgICAgICAga2V5OiAiIi5jb25jYXQod29yZHMsICItIikuY29uY2F0KGluZGV4KQogICAgICB9LCB3b3JkcykKICAgICk7CiAgfSkpOwp9KTsKVGV4dC5kaXNwbGF5TmFtZSA9ICJUZXh0IjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9MYWJlbC5qcwp2YXIgUmVhY3QxNCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDI2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkNyA9IFsibGFiZWxSZWYiXTsKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNyhlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNyhlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNyhyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gb3duS2V5czIzKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjMoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyMyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjQoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjMoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTI0KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjQocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjQodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjQodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjQodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9leHRlbmRzMTEoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTEgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczExLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KdmFyIENhcnRlc2lhbkxhYmVsQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuY3JlYXRlQ29udGV4dCkobnVsbCk7CnZhciBDYXJ0ZXNpYW5MYWJlbENvbnRleHRQcm92aWRlciA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgdXBwZXJXaWR0aCwKICAgIGxvd2VyV2lkdGgsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyOwogIHZhciB2aWV3Qm94ID0gKDAsIGltcG9ydF9yZWFjdDI2LnVzZU1lbW8pKCgpID0+ICh7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgdXBwZXJXaWR0aCwKICAgIGxvd2VyV2lkdGgsCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0pLCBbeDIsIHkyLCB1cHBlcldpZHRoLCBsb3dlcldpZHRoLCB3aWR0aCwgaGVpZ2h0XSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuTGFiZWxDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogdmlld0JveAogIH0sIGNoaWxkcmVuKTsKfTsKdmFyIHVzZUNhcnRlc2lhbkxhYmVsQ29udGV4dCA9ICgpID0+IHsKICB2YXIgbGFiZWxDaGlsZENvbnRleHQgPSAoMCwgaW1wb3J0X3JlYWN0MjYudXNlQ29udGV4dCkoQ2FydGVzaWFuTGFiZWxDb250ZXh0KTsKICB2YXIgY2hhcnRDb250ZXh0ID0gdXNlVmlld0JveCgpOwogIHJldHVybiBsYWJlbENoaWxkQ29udGV4dCB8fCBjYXJ0ZXNpYW5WaWV3Qm94VG9UcmFwZXpvaWQoY2hhcnRDb250ZXh0KTsKfTsKdmFyIFBvbGFyTGFiZWxDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5jcmVhdGVDb250ZXh0KShudWxsKTsKdmFyIHVzZVBvbGFyTGFiZWxDb250ZXh0ID0gKCkgPT4gewogIHZhciBsYWJlbENoaWxkQ29udGV4dCA9ICgwLCBpbXBvcnRfcmVhY3QyNi51c2VDb250ZXh0KShQb2xhckxhYmVsQ29udGV4dCk7CiAgdmFyIGNoYXJ0Q29udGV4dCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFBvbGFyVmlld0JveCk7CiAgcmV0dXJuIGxhYmVsQ2hpbGRDb250ZXh0IHx8IGNoYXJ0Q29udGV4dDsKfTsKdmFyIGdldExhYmVsID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIHZhbHVlLAogICAgZm9ybWF0dGVyCiAgfSA9IHByb3BzOwogIHZhciBsYWJlbCA9IGlzTnVsbGlzaChwcm9wcy5jaGlsZHJlbikgPyB2YWx1ZSA6IHByb3BzLmNoaWxkcmVuOwogIGlmICh0eXBlb2YgZm9ybWF0dGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gZm9ybWF0dGVyKGxhYmVsKTsKICB9CiAgcmV0dXJuIGxhYmVsOwp9Owp2YXIgaXNMYWJlbENvbnRlbnRBRnVuY3Rpb24gPSAoY29udGVudCkgPT4gewogIHJldHVybiBjb250ZW50ICE9IG51bGwgJiYgdHlwZW9mIGNvbnRlbnQgPT09ICJmdW5jdGlvbiI7Cn07CnZhciBnZXREZWx0YUFuZ2xlMiA9IChzdGFydEFuZ2xlLCBlbmRBbmdsZSkgPT4gewogIHZhciBzaWduMiA9IG1hdGhTaWduKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSk7CiAgdmFyIGRlbHRhQW5nbGUgPSBNYXRoLm1pbihNYXRoLmFicyhlbmRBbmdsZSAtIHN0YXJ0QW5nbGUpLCAzNjApOwogIHJldHVybiBzaWduMiAqIGRlbHRhQW5nbGU7Cn07CnZhciByZW5kZXJSYWRpYWxMYWJlbCA9IChsYWJlbFByb3BzLCBwb3NpdGlvbiwgbGFiZWwsIGF0dHJzLCB2aWV3Qm94KSA9PiB7CiAgdmFyIHsKICAgIG9mZnNldCwKICAgIGNsYXNzTmFtZQogIH0gPSBsYWJlbFByb3BzOwogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZSwKICAgIGNsb2NrV2lzZQogIH0gPSB2aWV3Qm94OwogIHZhciByYWRpdXMgPSAoaW5uZXJSYWRpdXMgKyBvdXRlclJhZGl1cykgLyAyOwogIHZhciBkZWx0YUFuZ2xlID0gZ2V0RGVsdGFBbmdsZTIoc3RhcnRBbmdsZSwgZW5kQW5nbGUpOwogIHZhciBzaWduMiA9IGRlbHRhQW5nbGUgPj0gMCA/IDEgOiAtMTsKICB2YXIgbGFiZWxBbmdsZSwgZGlyZWN0aW9uOwogIHN3aXRjaCAocG9zaXRpb24pIHsKICAgIGNhc2UgImluc2lkZVN0YXJ0IjoKICAgICAgbGFiZWxBbmdsZSA9IHN0YXJ0QW5nbGUgKyBzaWduMiAqIG9mZnNldDsKICAgICAgZGlyZWN0aW9uID0gY2xvY2tXaXNlOwogICAgICBicmVhazsKICAgIGNhc2UgImluc2lkZUVuZCI6CiAgICAgIGxhYmVsQW5nbGUgPSBlbmRBbmdsZSAtIHNpZ24yICogb2Zmc2V0OwogICAgICBkaXJlY3Rpb24gPSAhY2xvY2tXaXNlOwogICAgICBicmVhazsKICAgIGNhc2UgImVuZCI6CiAgICAgIGxhYmVsQW5nbGUgPSBlbmRBbmdsZSArIHNpZ24yICogb2Zmc2V0OwogICAgICBkaXJlY3Rpb24gPSBjbG9ja1dpc2U7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbnN1cHBvcnRlZCBwb3NpdGlvbiAiLmNvbmNhdChwb3NpdGlvbikpOwogIH0KICBkaXJlY3Rpb24gPSBkZWx0YUFuZ2xlIDw9IDAgPyBkaXJlY3Rpb24gOiAhZGlyZWN0aW9uOwogIHZhciBzdGFydFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgbGFiZWxBbmdsZSk7CiAgdmFyIGVuZFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgbGFiZWxBbmdsZSArIChkaXJlY3Rpb24gPyAxIDogLTEpICogMzU5KTsKICB2YXIgcGF0aDIgPSAiTSIuY29uY2F0KHN0YXJ0UG9pbnQueCwgIiwiKS5jb25jYXQoc3RhcnRQb2ludC55LCAiXG4gICAgQSIpLmNvbmNhdChyYWRpdXMsICIsIikuY29uY2F0KHJhZGl1cywgIiwwLDEsIikuY29uY2F0KGRpcmVjdGlvbiA/IDAgOiAxLCAiLFxuICAgICIpLmNvbmNhdChlbmRQb2ludC54LCAiLCIpLmNvbmNhdChlbmRQb2ludC55KTsKICB2YXIgaWQgPSBpc051bGxpc2gobGFiZWxQcm9wcy5pZCkgPyB1bmlxdWVJZCgicmVjaGFydHMtcmFkaWFsLWxpbmUtIikgOiBsYWJlbFByb3BzLmlkOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KCJ0ZXh0IiwgX2V4dGVuZHMxMSh7fSwgYXR0cnMsIHsKICAgIGRvbWluYW50QmFzZWxpbmU6ICJjZW50cmFsIiwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtcmFkaWFsLWJhci1sYWJlbCIsIGNsYXNzTmFtZSkKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudCgiZGVmcyIsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCB7CiAgICBpZCwKICAgIGQ6IHBhdGgyCiAgfSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KCJ0ZXh0UGF0aCIsIHsKICAgIHhsaW5rSHJlZjogIiMiLmNvbmNhdChpZCkKICB9LCBsYWJlbCkpOwp9Owp2YXIgZ2V0QXR0cnNPZlBvbGFyTGFiZWwgPSAodmlld0JveCwgb2Zmc2V0LCBwb3NpdGlvbikgPT4gewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSB2aWV3Qm94OwogIHZhciBtaWRBbmdsZSA9IChzdGFydEFuZ2xlICsgZW5kQW5nbGUpIC8gMjsKICBpZiAocG9zaXRpb24gPT09ICJvdXRzaWRlIikgewogICAgdmFyIHsKICAgICAgeDogX3gsCiAgICAgIHk6IF95CiAgICB9ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIG91dGVyUmFkaXVzICsgb2Zmc2V0LCBtaWRBbmdsZSk7CiAgICByZXR1cm4gewogICAgICB4OiBfeCwKICAgICAgeTogX3ksCiAgICAgIHRleHRBbmNob3I6IF94ID49IGN4ID8gInN0YXJ0IiA6ICJlbmQiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICAgIH07CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImNlbnRlciIpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IGN4LAogICAgICB5OiBjeSwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogICAgfTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiY2VudGVyVG9wIikgewogICAgcmV0dXJuIHsKICAgICAgeDogY3gsCiAgICAgIHk6IGN5LAogICAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgICAgdmVydGljYWxBbmNob3I6ICJzdGFydCIKICAgIH07CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImNlbnRlckJvdHRvbSIpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IGN4LAogICAgICB5OiBjeSwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAiZW5kIgogICAgfTsKICB9CiAgdmFyIHIyID0gKGlubmVyUmFkaXVzICsgb3V0ZXJSYWRpdXMpIC8gMjsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MgogIH0gPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgcjIsIG1pZEFuZ2xlKTsKICByZXR1cm4gewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgfTsKfTsKdmFyIGlzUG9sYXIgPSAodmlld0JveCkgPT4gImN4IiBpbiB2aWV3Qm94ICYmIGlzTnVtYmVyKHZpZXdCb3guY3gpOwp2YXIgZ2V0QXR0cnNPZkNhcnRlc2lhbkxhYmVsID0gKHByb3BzLCB2aWV3Qm94KSA9PiB7CiAgdmFyIHsKICAgIHBhcmVudFZpZXdCb3g6IHBhcmVudFZpZXdCb3hGcm9tUHJvcHMsCiAgICBvZmZzZXQsCiAgICBwb3NpdGlvbgogIH0gPSBwcm9wczsKICB2YXIgcGFyZW50Vmlld0JveDsKICBpZiAocGFyZW50Vmlld0JveEZyb21Qcm9wcyAhPSBudWxsICYmICFpc1BvbGFyKHBhcmVudFZpZXdCb3hGcm9tUHJvcHMpKSB7CiAgICBwYXJlbnRWaWV3Qm94ID0gcGFyZW50Vmlld0JveEZyb21Qcm9wczsKICB9CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB1cHBlcldpZHRoLAogICAgbG93ZXJXaWR0aCwKICAgIGhlaWdodAogIH0gPSB2aWV3Qm94OwogIHZhciB1cHBlclggPSB4MjsKICB2YXIgbG93ZXJYID0geDIgKyAodXBwZXJXaWR0aCAtIGxvd2VyV2lkdGgpIC8gMjsKICB2YXIgbWlkZGxlWCA9ICh1cHBlclggKyBsb3dlclgpIC8gMjsKICB2YXIgbWlkSGVpZ2h0V2lkdGggPSAodXBwZXJXaWR0aCArIGxvd2VyV2lkdGgpIC8gMjsKICB2YXIgY2VudGVyWCA9IHVwcGVyWCArIHVwcGVyV2lkdGggLyAyOwogIHZhciB2ZXJ0aWNhbFNpZ24gPSBoZWlnaHQgPj0gMCA/IDEgOiAtMTsKICB2YXIgdmVydGljYWxPZmZzZXQgPSB2ZXJ0aWNhbFNpZ24gKiBvZmZzZXQ7CiAgdmFyIHZlcnRpY2FsRW5kID0gdmVydGljYWxTaWduID4gMCA/ICJlbmQiIDogInN0YXJ0IjsKICB2YXIgdmVydGljYWxTdGFydCA9IHZlcnRpY2FsU2lnbiA+IDAgPyAic3RhcnQiIDogImVuZCI7CiAgdmFyIGhvcml6b250YWxTaWduID0gdXBwZXJXaWR0aCA+PSAwID8gMSA6IC0xOwogIHZhciBob3Jpem9udGFsT2Zmc2V0ID0gaG9yaXpvbnRhbFNpZ24gKiBvZmZzZXQ7CiAgdmFyIGhvcml6b250YWxFbmQgPSBob3Jpem9udGFsU2lnbiA+IDAgPyAiZW5kIiA6ICJzdGFydCI7CiAgdmFyIGhvcml6b250YWxTdGFydCA9IGhvcml6b250YWxTaWduID4gMCA/ICJzdGFydCIgOiAiZW5kIjsKICBpZiAocG9zaXRpb24gPT09ICJ0b3AiKSB7CiAgICB2YXIgYXR0cnMgPSB7CiAgICAgIHg6IHVwcGVyWCArIHVwcGVyV2lkdGggLyAyLAogICAgICB5OiB5MiAtIHZlcnRpY2FsT2Zmc2V0LAogICAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsRW5kCiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyhfb2JqZWN0U3ByZWFkMjMoe30sIGF0dHJzKSwgcGFyZW50Vmlld0JveCA/IHsKICAgICAgaGVpZ2h0OiBNYXRoLm1heCh5MiAtIHBhcmVudFZpZXdCb3gueSwgMCksCiAgICAgIHdpZHRoOiB1cHBlcldpZHRoCiAgICB9IDoge30pOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJib3R0b20iKSB7CiAgICB2YXIgX2F0dHJzID0gewogICAgICB4OiBsb3dlclggKyBsb3dlcldpZHRoIC8gMiwKICAgICAgeTogeTIgKyBoZWlnaHQgKyB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbFN0YXJ0CiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyhfb2JqZWN0U3ByZWFkMjMoe30sIF9hdHRycyksIHBhcmVudFZpZXdCb3ggPyB7CiAgICAgIGhlaWdodDogTWF0aC5tYXgocGFyZW50Vmlld0JveC55ICsgcGFyZW50Vmlld0JveC5oZWlnaHQgLSAoeTIgKyBoZWlnaHQpLCAwKSwKICAgICAgd2lkdGg6IGxvd2VyV2lkdGgKICAgIH0gOiB7fSk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImxlZnQiKSB7CiAgICB2YXIgX2F0dHJzMiA9IHsKICAgICAgeDogbWlkZGxlWCAtIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC8gMiwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbEVuZCwKICAgICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyhfb2JqZWN0U3ByZWFkMjMoe30sIF9hdHRyczIpLCBwYXJlbnRWaWV3Qm94ID8gewogICAgICB3aWR0aDogTWF0aC5tYXgoX2F0dHJzMi54IC0gcGFyZW50Vmlld0JveC54LCAwKSwKICAgICAgaGVpZ2h0CiAgICB9IDoge30pOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJyaWdodCIpIHsKICAgIHZhciBfYXR0cnMzID0gewogICAgICB4OiBtaWRkbGVYICsgbWlkSGVpZ2h0V2lkdGggKyBob3Jpem9udGFsT2Zmc2V0LAogICAgICB5OiB5MiArIGhlaWdodCAvIDIsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxTdGFydCwKICAgICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyhfb2JqZWN0U3ByZWFkMjMoe30sIF9hdHRyczMpLCBwYXJlbnRWaWV3Qm94ID8gewogICAgICB3aWR0aDogTWF0aC5tYXgocGFyZW50Vmlld0JveC54ICsgcGFyZW50Vmlld0JveC53aWR0aCAtIF9hdHRyczMueCwgMCksCiAgICAgIGhlaWdodAogICAgfSA6IHt9KTsKICB9CiAgdmFyIHNpemVBdHRycyA9IHBhcmVudFZpZXdCb3ggPyB7CiAgICB3aWR0aDogbWlkSGVpZ2h0V2lkdGgsCiAgICBoZWlnaHQKICB9IDoge307CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlTGVmdCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiBtaWRkbGVYICsgaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLyAyLAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsU3RhcnQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlUmlnaHQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogbWlkZGxlWCArIG1pZEhlaWdodFdpZHRoIC0gaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLyAyLAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsRW5kLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZVRvcCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiB1cHBlclggKyB1cHBlcldpZHRoIC8gMiwKICAgICAgeTogeTIgKyB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbFN0YXJ0CiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVCb3R0b20iKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogbG93ZXJYICsgbG93ZXJXaWR0aCAvIDIsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC0gdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxFbmQKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZVRvcExlZnQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogdXBwZXJYICsgaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbFN0YXJ0LAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxTdGFydAogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlVG9wUmlnaHQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogdXBwZXJYICsgdXBwZXJXaWR0aCAtIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxFbmQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbFN0YXJ0CiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVCb3R0b21MZWZ0IikgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IGxvd2VyWCArIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC0gdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxTdGFydCwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsRW5kCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVCb3R0b21SaWdodCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiBsb3dlclggKyBsb3dlcldpZHRoIC0gaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLSB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbEVuZCwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsRW5kCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAoISFwb3NpdGlvbiAmJiB0eXBlb2YgcG9zaXRpb24gPT09ICJvYmplY3QiICYmIChpc051bWJlcihwb3NpdGlvbi54KSB8fCBpc1BlcmNlbnQocG9zaXRpb24ueCkpICYmIChpc051bWJlcihwb3NpdGlvbi55KSB8fCBpc1BlcmNlbnQocG9zaXRpb24ueSkpKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogeDIgKyBnZXRQZXJjZW50VmFsdWUocG9zaXRpb24ueCwgbWlkSGVpZ2h0V2lkdGgpLAogICAgICB5OiB5MiArIGdldFBlcmNlbnRWYWx1ZShwb3NpdGlvbi55LCBoZWlnaHQpLAogICAgICB0ZXh0QW5jaG9yOiAiZW5kIiwKICAgICAgdmVydGljYWxBbmNob3I6ICJlbmQiCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgIHg6IGNlbnRlclgsCiAgICB5OiB5MiArIGhlaWdodCAvIDIsCiAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogIH0sIHNpemVBdHRycyk7Cn07CnZhciBkZWZhdWx0TGFiZWxQcm9wcyA9IHsKICBhbmdsZTogMCwKICBvZmZzZXQ6IDUsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMubGFiZWwsCiAgcG9zaXRpb246ICJtaWRkbGUiLAogIHRleHRCcmVha0FsbDogZmFsc2UKfTsKZnVuY3Rpb24gTGFiZWwob3V0ZXJQcm9wcykgewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0ZXJQcm9wcywgZGVmYXVsdExhYmVsUHJvcHMpOwogIHZhciB7CiAgICB2aWV3Qm94OiB2aWV3Qm94RnJvbVByb3BzLAogICAgcG9zaXRpb24sCiAgICB2YWx1ZSwKICAgIGNoaWxkcmVuLAogICAgY29udGVudCwKICAgIGNsYXNzTmFtZSA9ICIiLAogICAgdGV4dEJyZWFrQWxsLAogICAgbGFiZWxSZWYKICB9ID0gcHJvcHM7CiAgdmFyIHBvbGFyVmlld0JveCA9IHVzZVBvbGFyTGFiZWxDb250ZXh0KCk7CiAgdmFyIGNhcnRlc2lhblZpZXdCb3ggPSB1c2VDYXJ0ZXNpYW5MYWJlbENvbnRleHQoKTsKICB2YXIgcmVzb2x2ZWRWaWV3Qm94ID0gcG9zaXRpb24gPT09ICJjZW50ZXIiID8gY2FydGVzaWFuVmlld0JveCA6IHBvbGFyVmlld0JveCAhPT0gbnVsbCAmJiBwb2xhclZpZXdCb3ggIT09IHZvaWQgMCA/IHBvbGFyVmlld0JveCA6IGNhcnRlc2lhblZpZXdCb3g7CiAgdmFyIHZpZXdCb3gsIGxhYmVsLCBwb3NpdGlvbkF0dHJzOwogIGlmICh2aWV3Qm94RnJvbVByb3BzID09IG51bGwpIHsKICAgIHZpZXdCb3ggPSByZXNvbHZlZFZpZXdCb3g7CiAgfSBlbHNlIGlmIChpc1BvbGFyKHZpZXdCb3hGcm9tUHJvcHMpKSB7CiAgICB2aWV3Qm94ID0gdmlld0JveEZyb21Qcm9wczsKICB9IGVsc2UgewogICAgdmlld0JveCA9IGNhcnRlc2lhblZpZXdCb3hUb1RyYXBlem9pZCh2aWV3Qm94RnJvbVByb3BzKTsKICB9CiAgaWYgKCF2aWV3Qm94IHx8IGlzTnVsbGlzaCh2YWx1ZSkgJiYgaXNOdWxsaXNoKGNoaWxkcmVuKSAmJiAhLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5pc1ZhbGlkRWxlbWVudCkoY29udGVudCkgJiYgdHlwZW9mIGNvbnRlbnQgIT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgcHJvcHNXaXRoVmlld0JveCA9IF9vYmplY3RTcHJlYWQyMyhfb2JqZWN0U3ByZWFkMjMoe30sIHByb3BzKSwge30sIHsKICAgIHZpZXdCb3gKICB9KTsKICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5pc1ZhbGlkRWxlbWVudCkoY29udGVudCkpIHsKICAgIHZhciB7CiAgICAgIGxhYmVsUmVmOiBfCiAgICB9ID0gcHJvcHNXaXRoVmlld0JveCwgcHJvcHNXaXRob3V0TGFiZWxSZWYgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM3KHByb3BzV2l0aFZpZXdCb3gsIF9leGNsdWRlZDcpOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuY2xvbmVFbGVtZW50KShjb250ZW50LCBwcm9wc1dpdGhvdXRMYWJlbFJlZik7CiAgfQogIGlmICh0eXBlb2YgY29udGVudCA9PT0gImZ1bmN0aW9uIikgewogICAgbGFiZWwgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmNyZWF0ZUVsZW1lbnQpKGNvbnRlbnQsIHByb3BzV2l0aFZpZXdCb3gpOwogICAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuaXNWYWxpZEVsZW1lbnQpKGxhYmVsKSkgewogICAgICByZXR1cm4gbGFiZWw7CiAgICB9CiAgfSBlbHNlIHsKICAgIGxhYmVsID0gZ2V0TGFiZWwocHJvcHMpOwogIH0KICB2YXIgYXR0cnMgPSBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzKTsKICBpZiAoaXNQb2xhcih2aWV3Qm94KSkgewogICAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlU3RhcnQiIHx8IHBvc2l0aW9uID09PSAiaW5zaWRlRW5kIiB8fCBwb3NpdGlvbiA9PT0gImVuZCIpIHsKICAgICAgcmV0dXJuIHJlbmRlclJhZGlhbExhYmVsKHByb3BzLCBwb3NpdGlvbiwgbGFiZWwsIGF0dHJzLCB2aWV3Qm94KTsKICAgIH0KICAgIHBvc2l0aW9uQXR0cnMgPSBnZXRBdHRyc09mUG9sYXJMYWJlbCh2aWV3Qm94LCBwcm9wcy5vZmZzZXQsIHByb3BzLnBvc2l0aW9uKTsKICB9IGVsc2UgewogICAgcG9zaXRpb25BdHRycyA9IGdldEF0dHJzT2ZDYXJ0ZXNpYW5MYWJlbChwcm9wcywgdmlld0JveCk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IHByb3BzLnpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoVGV4dCwgX2V4dGVuZHMxMSh7CiAgICByZWY6IGxhYmVsUmVmLAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1sYWJlbCIsIGNsYXNzTmFtZSkKICB9LCBhdHRycywgcG9zaXRpb25BdHRycywgewogICAgLyoKICAgICAqIHRleHRBbmNob3IgaXMgZGVjaWRlZCBieSBkZWZhdWx0IGJhc2VkIG9uIHRoZSBgcG9zaXRpb25gCiAgICAgKiBidXQgd2UgYWxsb3cgb3ZlcnJpZGluZyB2aWEgcHJvcHMgZm9yIHByZWNpc2UgY29udHJvbC4KICAgICAqLwogICAgdGV4dEFuY2hvcjogaXNWYWxpZFRleHRBbmNob3IoYXR0cnMudGV4dEFuY2hvcikgPyBhdHRycy50ZXh0QW5jaG9yIDogcG9zaXRpb25BdHRycy50ZXh0QW5jaG9yLAogICAgYnJlYWtBbGw6IHRleHRCcmVha0FsbAogIH0pLCBsYWJlbCkpOwp9CkxhYmVsLmRpc3BsYXlOYW1lID0gIkxhYmVsIjsKdmFyIHBhcnNlTGFiZWwgPSAobGFiZWwsIHZpZXdCb3gsIGxhYmVsUmVmKSA9PiB7CiAgaWYgKCFsYWJlbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBjb21tb25Qcm9wcyA9IHsKICAgIHZpZXdCb3gsCiAgICBsYWJlbFJlZgogIH07CiAgaWYgKGxhYmVsID09PSB0cnVlKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudChMYWJlbCwgX2V4dGVuZHMxMSh7CiAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IgogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgaWYgKGlzTnVtT3JTdHIobGFiZWwpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudChMYWJlbCwgX2V4dGVuZHMxMSh7CiAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IiwKICAgICAgdmFsdWU6IGxhYmVsCiAgICB9LCBjb21tb25Qcm9wcykpOwogIH0KICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5pc1ZhbGlkRWxlbWVudCkobGFiZWwpKSB7CiAgICBpZiAobGFiZWwudHlwZSA9PT0gTGFiZWwpIHsKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuY2xvbmVFbGVtZW50KShsYWJlbCwgX29iamVjdFNwcmVhZDIzKHsKICAgICAgICBrZXk6ICJsYWJlbC1pbXBsaWNpdCIKICAgICAgfSwgY29tbW9uUHJvcHMpKTsKICAgIH0KICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KExhYmVsLCBfZXh0ZW5kczExKHsKICAgICAga2V5OiAibGFiZWwtaW1wbGljaXQiLAogICAgICBjb250ZW50OiBsYWJlbAogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgaWYgKGlzTGFiZWxDb250ZW50QUZ1bmN0aW9uKGxhYmVsKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoTGFiZWwsIF9leHRlbmRzMTEoewogICAgICBrZXk6ICJsYWJlbC1pbXBsaWNpdCIsCiAgICAgIGNvbnRlbnQ6IGxhYmVsCiAgICB9LCBjb21tb25Qcm9wcykpOwogIH0KICBpZiAobGFiZWwgJiYgdHlwZW9mIGxhYmVsID09PSAib2JqZWN0IikgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoTGFiZWwsIF9leHRlbmRzMTEoe30sIGxhYmVsLCB7CiAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IgogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgcmV0dXJuIG51bGw7Cn07CmZ1bmN0aW9uIENhcnRlc2lhbkxhYmVsRnJvbUxhYmVsUHJvcChfcmVmMykgewogIHZhciB7CiAgICBsYWJlbCwKICAgIGxhYmVsUmVmCiAgfSA9IF9yZWYzOwogIHZhciB2aWV3Qm94ID0gdXNlQ2FydGVzaWFuTGFiZWxDb250ZXh0KCk7CiAgcmV0dXJuIHBhcnNlTGFiZWwobGFiZWwsIHZpZXdCb3gsIGxhYmVsUmVmKSB8fCBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvTGFiZWxMaXN0LmpzCnZhciBSZWFjdDE1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MjcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfbGFzdCA9IF9fdG9FU00ocmVxdWlyZV9sYXN0MygpKTsKdmFyIF9leGNsdWRlZDggPSBbInZhbHVlQWNjZXNzb3IiXTsKdmFyIF9leGNsdWRlZDI0ID0gWyJkYXRhS2V5IiwgImNsb2NrV2lzZSIsICJpZCIsICJ0ZXh0QnJlYWtBbGwiLCAiekluZGV4Il07CmZ1bmN0aW9uIF9leHRlbmRzMTIoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTIgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczEyLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzOChlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlOChlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlOChyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIGRlZmF1bHRBY2Nlc3NvciA9IChlbnRyeSkgPT4gQXJyYXkuaXNBcnJheShlbnRyeS52YWx1ZSkgPyAoMCwgaW1wb3J0X2xhc3QuZGVmYXVsdCkoZW50cnkudmFsdWUpIDogZW50cnkudmFsdWU7CnZhciBDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNy5jcmVhdGVDb250ZXh0KSh2b2lkIDApOwp2YXIgQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dFByb3ZpZGVyID0gQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dC5Qcm92aWRlcjsKdmFyIFBvbGFyTGFiZWxMaXN0Q29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjcuY3JlYXRlQ29udGV4dCkodm9pZCAwKTsKdmFyIFBvbGFyTGFiZWxMaXN0Q29udGV4dFByb3ZpZGVyID0gUG9sYXJMYWJlbExpc3RDb250ZXh0LlByb3ZpZGVyOwpmdW5jdGlvbiB1c2VDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0KCkgewogIHJldHVybiAoMCwgaW1wb3J0X3JlYWN0MjcudXNlQ29udGV4dCkoQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dCk7Cn0KZnVuY3Rpb24gdXNlUG9sYXJMYWJlbExpc3RDb250ZXh0KCkgewogIHJldHVybiAoMCwgaW1wb3J0X3JlYWN0MjcudXNlQ29udGV4dCkoUG9sYXJMYWJlbExpc3RDb250ZXh0KTsKfQpmdW5jdGlvbiBMYWJlbExpc3QoX3JlZjIpIHsKICB2YXIgewogICAgdmFsdWVBY2Nlc3NvciA9IGRlZmF1bHRBY2Nlc3NvcgogIH0gPSBfcmVmMiwgcmVzdFByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzOChfcmVmMiwgX2V4Y2x1ZGVkOCk7CiAgdmFyIHsKICAgIGRhdGFLZXksCiAgICBjbG9ja1dpc2UsCiAgICBpZCwKICAgIHRleHRCcmVha0FsbCwKICAgIHpJbmRleAogIH0gPSByZXN0UHJvcHMsIG90aGVycyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczgocmVzdFByb3BzLCBfZXhjbHVkZWQyNCk7CiAgdmFyIGNhcnRlc2lhbkRhdGEgPSB1c2VDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0KCk7CiAgdmFyIHBvbGFyRGF0YSA9IHVzZVBvbGFyTGFiZWxMaXN0Q29udGV4dCgpOwogIHZhciBkYXRhID0gY2FydGVzaWFuRGF0YSB8fCBwb2xhckRhdGE7CiAgaWYgKCFkYXRhIHx8ICFkYXRhLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IHpJbmRleCAhPT0gbnVsbCAmJiB6SW5kZXggIT09IHZvaWQgMCA/IHpJbmRleCA6IERlZmF1bHRaSW5kZXhlcy5sYWJlbAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWxhYmVsLWxpc3QiCiAgfSwgZGF0YS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgdmFyIF9yZXN0UHJvcHMkZmlsbDsKICAgIHZhciB2YWx1ZSA9IGlzTnVsbGlzaChkYXRhS2V5KSA/IHZhbHVlQWNjZXNzb3IoZW50cnksIGluZGV4KSA6IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5ICYmIGVudHJ5LnBheWxvYWQsIGRhdGFLZXkpOwogICAgdmFyIGlkUHJvcHMgPSBpc051bGxpc2goaWQpID8ge30gOiB7CiAgICAgIGlkOiAiIi5jb25jYXQoaWQsICItIikuY29uY2F0KGluZGV4KQogICAgfTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KExhYmVsLCBfZXh0ZW5kczEyKHsKICAgICAga2V5OiAibGFiZWwtIi5jb25jYXQoaW5kZXgpCiAgICB9LCBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKGVudHJ5KSwgb3RoZXJzLCBpZFByb3BzLCB7CiAgICAgIC8qCiAgICAgICAqIFByZWZlciB0byB1c2UgdGhlIGV4cGxpY2l0IGZpbGwgZnJvbSBMYWJlbExpc3QgcHJvcHMuCiAgICAgICAqIE9ubHkgaW4gYW4gYWJzZW5jZSBvZiB0aGF0LCBmYWxsIGJhY2sgdG8gdGhlIGZpbGwgb2YgdGhlIGVudHJ5LgogICAgICAgKiBUaGUgZW50cnkgZmlsbCBjYW4gYmUgcXVpdGUgZGlmZmljdWx0IHRvIHNlZSBlc3BlY2lhbGx5IGluIEJhciwgUGllLCBSYWRpYWxCYXIgaW4gaW5zaWRlIHBvc2l0aW9ucy4KICAgICAgICogT24gdGhlIG90aGVyIGhhbmQgaXQncyBxdWl0ZSBjb252ZW5pZW50IGluIFNjYXR0ZXIsIExpbmUsIG9yIHdoZW4gdGhlIHBvc2l0aW9uIGlzIG91dHNpZGUgdGhlIEJhciwgUGllIGZpbGxlZCBzaGFwZXMuCiAgICAgICAqLwogICAgICBmaWxsOiAoX3Jlc3RQcm9wcyRmaWxsID0gcmVzdFByb3BzLmZpbGwpICE9PSBudWxsICYmIF9yZXN0UHJvcHMkZmlsbCAhPT0gdm9pZCAwID8gX3Jlc3RQcm9wcyRmaWxsIDogZW50cnkuZmlsbCwKICAgICAgcGFyZW50Vmlld0JveDogZW50cnkucGFyZW50Vmlld0JveCwKICAgICAgdmFsdWUsCiAgICAgIHRleHRCcmVha0FsbCwKICAgICAgdmlld0JveDogZW50cnkudmlld0JveCwKICAgICAgaW5kZXgsCiAgICAgIHpJbmRleDogMAogICAgfSkpOwogIH0pKSk7Cn0KTGFiZWxMaXN0LmRpc3BsYXlOYW1lID0gIkxhYmVsTGlzdCI7CmZ1bmN0aW9uIExhYmVsTGlzdEZyb21MYWJlbFByb3AoX3JlZjIpIHsKICB2YXIgewogICAgbGFiZWwKICB9ID0gX3JlZjI7CiAgaWYgKCFsYWJlbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmIChsYWJlbCA9PT0gdHJ1ZSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoTGFiZWxMaXN0LCB7CiAgICAgIGtleTogImxhYmVsTGlzdC1pbXBsaWNpdCIKICAgIH0pOwogIH0KICBpZiAoLyogQF9fUFVSRV9fICovIFJlYWN0MTUuaXNWYWxpZEVsZW1lbnQobGFiZWwpIHx8IGlzTGFiZWxDb250ZW50QUZ1bmN0aW9uKGxhYmVsKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoTGFiZWxMaXN0LCB7CiAgICAgIGtleTogImxhYmVsTGlzdC1pbXBsaWNpdCIsCiAgICAgIGNvbnRlbnQ6IGxhYmVsCiAgICB9KTsKICB9CiAgaWYgKHR5cGVvZiBsYWJlbCA9PT0gIm9iamVjdCIpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KExhYmVsTGlzdCwgX2V4dGVuZHMxMih7CiAgICAgIGtleTogImxhYmVsTGlzdC1pbXBsaWNpdCIKICAgIH0sIGxhYmVsLCB7CiAgICAgIHR5cGU6IFN0cmluZyhsYWJlbC50eXBlKQogICAgfSkpOwogIH0KICByZXR1cm4gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvRG90LmpzCnZhciBSZWFjdDE2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBfZXh0ZW5kczEzKCkgewogIHJldHVybiBfZXh0ZW5kczEzID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxMy5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciBEb3QgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIHI6IHIyLAogICAgY2xhc3NOYW1lCiAgfSA9IHByb3BzOwogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtZG90IiwgY2xhc3NOYW1lKTsKICBpZiAoaXNOdW1iZXIoY3gpICYmIGlzTnVtYmVyKGN5KSAmJiBpc051bWJlcihyMikpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNi5jcmVhdGVFbGVtZW50KCJjaXJjbGUiLCBfZXh0ZW5kczEzKHt9LCBzdmdQcm9wZXJ0aWVzTm9FdmVudHMocHJvcHMpLCBhZGFwdEV2ZW50SGFuZGxlcnMocHJvcHMpLCB7CiAgICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcywKICAgICAgY3gsCiAgICAgIGN5LAogICAgICByOiByMgogICAgfSkpOwogIH0KICByZXR1cm4gbnVsbDsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3BvbGFyQXhpc1NsaWNlLmpzCnZhciBpbml0aWFsU3RhdGU2ID0gewogIHJhZGl1c0F4aXM6IHt9LAogIGFuZ2xlQXhpczoge30KfTsKdmFyIHBvbGFyQXhpc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJwb2xhckF4aXMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlNiwKICByZWR1Y2VyczogewogICAgYWRkUmFkaXVzQXhpcyhzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnJhZGl1c0F4aXNbYWN0aW9uLnBheWxvYWQuaWRdID0gY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKTsKICAgIH0sCiAgICByZW1vdmVSYWRpdXNBeGlzKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgZGVsZXRlIHN0YXRlLnJhZGl1c0F4aXNbYWN0aW9uLnBheWxvYWQuaWRdOwogICAgfSwKICAgIGFkZEFuZ2xlQXhpcyhzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLmFuZ2xlQXhpc1thY3Rpb24ucGF5bG9hZC5pZF0gPSBjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpOwogICAgfSwKICAgIHJlbW92ZUFuZ2xlQXhpcyhzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIGRlbGV0ZSBzdGF0ZS5hbmdsZUF4aXNbYWN0aW9uLnBheWxvYWQuaWRdOwogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkUmFkaXVzQXhpcywKICByZW1vdmVSYWRpdXNBeGlzLAogIGFkZEFuZ2xlQXhpcywKICByZW1vdmVBbmdsZUF4aXMKfSA9IHBvbGFyQXhpc1NsaWNlLmFjdGlvbnM7CnZhciBwb2xhckF4aXNSZWR1Y2VyID0gcG9sYXJBeGlzU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvUmVhY3RVdGlscy5qcwp2YXIgaW1wb3J0X3JlYWN0MjggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpc0NsaXBEb3QgPSAoZG90KSA9PiB7CiAgaWYgKGRvdCAmJiB0eXBlb2YgZG90ID09PSAib2JqZWN0IiAmJiAiY2xpcERvdCIgaW4gZG90KSB7CiAgICByZXR1cm4gQm9vbGVhbihkb3QuY2xpcERvdCk7CiAgfQogIHJldHVybiB0cnVlOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvU2V0VG9vbHRpcEVudHJ5U2V0dGluZ3MuanMKdmFyIGltcG9ydF9yZWFjdDI5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBTZXRUb29sdGlwRW50cnlTZXR0aW5ncyhfcmVmMikgewogIHZhciB7CiAgICB0b29sdGlwRW50cnlTZXR0aW5ncwogIH0gPSBfcmVmMjsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciBwcmV2U2V0dGluZ3NSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MjkudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0MjkudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoaXNQYW5vcmFtYSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgZGlzcGF0Y2goYWRkVG9vbHRpcEVudHJ5U2V0dGluZ3ModG9vbHRpcEVudHJ5U2V0dGluZ3MpKTsKICAgIH0gZWxzZSBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgIT09IHRvb2x0aXBFbnRyeVNldHRpbmdzKSB7CiAgICAgIGRpc3BhdGNoKHJlcGxhY2VUb29sdGlwRW50cnlTZXR0aW5ncyh7CiAgICAgICAgcHJldjogcHJldlNldHRpbmdzUmVmLmN1cnJlbnQsCiAgICAgICAgbmV4dDogdG9vbHRpcEVudHJ5U2V0dGluZ3MKICAgICAgfSkpOwogICAgfQogICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSB0b29sdGlwRW50cnlTZXR0aW5nczsKICB9LCBbdG9vbHRpcEVudHJ5U2V0dGluZ3MsIGRpc3BhdGNoLCBpc1Bhbm9yYW1hXSk7CiAgKDAsIGltcG9ydF9yZWFjdDI5LnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSB7CiAgICAgICAgZGlzcGF0Y2gocmVtb3ZlVG9vbHRpcEVudHJ5U2V0dGluZ3MocHJldlNldHRpbmdzUmVmLmN1cnJlbnQpKTsKICAgICAgICBwcmV2U2V0dGluZ3NSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1NldExlZ2VuZFBheWxvYWQuanMKdmFyIGltcG9ydF9yZWFjdDMwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBTZXRMZWdlbmRQYXlsb2FkKF9yZWYyKSB7CiAgdmFyIHsKICAgIGxlZ2VuZFBheWxvYWQKICB9ID0gX3JlZjI7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgcHJldlBheWxvYWRSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MzAudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0MzAudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoaXNQYW5vcmFtYSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocHJldlBheWxvYWRSZWYuY3VycmVudCA9PT0gbnVsbCkgewogICAgICBkaXNwYXRjaChhZGRMZWdlbmRQYXlsb2FkKGxlZ2VuZFBheWxvYWQpKTsKICAgIH0gZWxzZSBpZiAocHJldlBheWxvYWRSZWYuY3VycmVudCAhPT0gbGVnZW5kUGF5bG9hZCkgewogICAgICBkaXNwYXRjaChyZXBsYWNlTGVnZW5kUGF5bG9hZCh7CiAgICAgICAgcHJldjogcHJldlBheWxvYWRSZWYuY3VycmVudCwKICAgICAgICBuZXh0OiBsZWdlbmRQYXlsb2FkCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZQYXlsb2FkUmVmLmN1cnJlbnQgPSBsZWdlbmRQYXlsb2FkOwogIH0sIFtkaXNwYXRjaCwgaXNQYW5vcmFtYSwgbGVnZW5kUGF5bG9hZF0pOwogICgwLCBpbXBvcnRfcmVhY3QzMC51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2UGF5bG9hZFJlZi5jdXJyZW50KSB7CiAgICAgICAgZGlzcGF0Y2gocmVtb3ZlTGVnZW5kUGF5bG9hZChwcmV2UGF5bG9hZFJlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlBheWxvYWRSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvUmVnaXN0ZXJHcmFwaGljYWxJdGVtSWQuanMKdmFyIFJlYWN0MTggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QzMSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdXNlSWQuanMKdmFyIFJlYWN0MTcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfcmVmOwp2YXIgdXNlSWRGYWxsYmFjayA9ICgpID0+IHsKICB2YXIgW2lkXSA9IFJlYWN0MTcudXNlU3RhdGUoKCkgPT4gdW5pcXVlSWQoInVpZC0iKSk7CiAgcmV0dXJuIGlkOwp9Owp2YXIgdXNlSWQgPSAoX3JlZiA9IFJlYWN0MTdbInVzZUlkIi50b1N0cmluZygpXSkgIT09IG51bGwgJiYgX3JlZiAhPT0gdm9pZCAwID8gX3JlZiA6IHVzZUlkRmFsbGJhY2s7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3VzZVVuaXF1ZUlkLmpzCmZ1bmN0aW9uIHVzZVVuaXF1ZUlkKHByZWZpeCwgY3VzdG9tSWQpIHsKICB2YXIgZ2VuZXJhdGVkSWQgPSB1c2VJZCgpOwogIGlmIChjdXN0b21JZCkgewogICAgcmV0dXJuIGN1c3RvbUlkOwogIH0KICByZXR1cm4gcHJlZml4ID8gIiIuY29uY2F0KHByZWZpeCwgIi0iKS5jb25jYXQoZ2VuZXJhdGVkSWQpIDogZ2VuZXJhdGVkSWQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvUmVnaXN0ZXJHcmFwaGljYWxJdGVtSWQuanMKdmFyIEdyYXBoaWNhbEl0ZW1JZENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDMxLmNyZWF0ZUNvbnRleHQpKHZvaWQgMCk7CnZhciBSZWdpc3RlckdyYXBoaWNhbEl0ZW1JZCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBpZCwKICAgIHR5cGUsCiAgICBjaGlsZHJlbgogIH0gPSBfcmVmMjsKICB2YXIgcmVzb2x2ZWRJZCA9IHVzZVVuaXF1ZUlkKCJyZWNoYXJ0cy0iLmNvbmNhdCh0eXBlKSwgaWQpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxOC5jcmVhdGVFbGVtZW50KEdyYXBoaWNhbEl0ZW1JZENvbnRleHQuUHJvdmlkZXIsIHsKICAgIHZhbHVlOiByZXNvbHZlZElkCiAgfSwgY2hpbGRyZW4ocmVzb2x2ZWRJZCkpOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvU2V0R3JhcGhpY2FsSXRlbS5qcwp2YXIgaW1wb3J0X3JlYWN0MzIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9ncmFwaGljYWxJdGVtc1NsaWNlLmpzCnZhciBpbml0aWFsU3RhdGU3ID0gewogIGNhcnRlc2lhbkl0ZW1zOiBbXSwKICBwb2xhckl0ZW1zOiBbXQp9Owp2YXIgZ3JhcGhpY2FsSXRlbXNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiZ3JhcGhpY2FsSXRlbXMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlNywKICByZWR1Y2VyczogewogICAgYWRkQ2FydGVzaWFuR3JhcGhpY2FsSXRlbTogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS5jYXJ0ZXNpYW5JdGVtcy5wdXNoKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlcGxhY2VDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciB7CiAgICAgICAgICBwcmV2LAogICAgICAgICAgbmV4dAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5jYXJ0ZXNpYW5JdGVtcy5pbmRleE9mKGNhc3REcmFmdChwcmV2KSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLmNhcnRlc2lhbkl0ZW1zW2luZGV4XSA9IGNhc3REcmFmdChuZXh0KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlQ2FydGVzaWFuR3JhcGhpY2FsSXRlbTogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5jYXJ0ZXNpYW5JdGVtcy5pbmRleE9mKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS5jYXJ0ZXNpYW5JdGVtcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICBhZGRQb2xhckdyYXBoaWNhbEl0ZW06IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUucG9sYXJJdGVtcy5wdXNoKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZVBvbGFyR3JhcGhpY2FsSXRlbTogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5wb2xhckl0ZW1zLmluZGV4T2YoY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLnBvbGFySXRlbXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9CiAgfQp9KTsKdmFyIHsKICBhZGRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtLAogIHJlcGxhY2VDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtLAogIHJlbW92ZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW0sCiAgYWRkUG9sYXJHcmFwaGljYWxJdGVtLAogIHJlbW92ZVBvbGFyR3JhcGhpY2FsSXRlbQp9ID0gZ3JhcGhpY2FsSXRlbXNTbGljZS5hY3Rpb25zOwp2YXIgZ3JhcGhpY2FsSXRlbXNSZWR1Y2VyID0gZ3JhcGhpY2FsSXRlbXNTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvU2V0R3JhcGhpY2FsSXRlbS5qcwp2YXIgU2V0Q2FydGVzaWFuR3JhcGhpY2FsSXRlbUltcGwgPSAocHJvcHMpID0+IHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBwcmV2UHJvcHNSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MzIudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0MzIudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocHJldlByb3BzUmVmLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgZGlzcGF0Y2goYWRkQ2FydGVzaWFuR3JhcGhpY2FsSXRlbShwcm9wcykpOwogICAgfSBlbHNlIGlmIChwcmV2UHJvcHNSZWYuY3VycmVudCAhPT0gcHJvcHMpIHsKICAgICAgZGlzcGF0Y2gocmVwbGFjZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW0oewogICAgICAgIHByZXY6IHByZXZQcm9wc1JlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IHByb3BzCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZQcm9wc1JlZi5jdXJyZW50ID0gcHJvcHM7CiAgfSwgW2Rpc3BhdGNoLCBwcm9wc10pOwogICgwLCBpbXBvcnRfcmVhY3QzMi51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2UHJvcHNSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW0ocHJldlByb3BzUmVmLmN1cnJlbnQpKTsKICAgICAgICBwcmV2UHJvcHNSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn07CnZhciBTZXRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzMi5tZW1vKShTZXRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtSW1wbCk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvRG90cy5qcwp2YXIgUmVhY3QxOSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDMzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkOSA9IFsicG9pbnRzIl07CmZ1bmN0aW9uIG93bktleXMyNChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI0KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjQoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI1KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI0KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyNShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI1KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI1KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI1KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI1KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfZXh0ZW5kczE0KCkgewogIHJldHVybiBfZXh0ZW5kczE0ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxNC5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczkoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTkoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTkocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIERvdEl0ZW0oX3JlZjIpIHsKICB2YXIgewogICAgb3B0aW9uLAogICAgZG90UHJvcHMsCiAgICBjbGFzc05hbWUKICB9ID0gX3JlZjI7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzMuaXNWYWxpZEVsZW1lbnQpKG9wdGlvbikpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDMzLmNsb25lRWxlbWVudCkob3B0aW9uLCBkb3RQcm9wcyk7CiAgfQogIGlmICh0eXBlb2Ygb3B0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gb3B0aW9uKGRvdFByb3BzKTsKICB9CiAgdmFyIGZpbmFsQ2xhc3NOYW1lID0gY2xzeChjbGFzc05hbWUsIHR5cGVvZiBvcHRpb24gIT09ICJib29sZWFuIiA/IG9wdGlvbi5jbGFzc05hbWUgOiAiIik7CiAgdmFyIF9yZWYyMiA9IGRvdFByb3BzICE9PSBudWxsICYmIGRvdFByb3BzICE9PSB2b2lkIDAgPyBkb3RQcm9wcyA6IHt9LCB7CiAgICBwb2ludHMKICB9ID0gX3JlZjIyLCBwcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczkoX3JlZjIyLCBfZXhjbHVkZWQ5KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTkuY3JlYXRlRWxlbWVudChEb3QsIF9leHRlbmRzMTQoe30sIHByb3BzLCB7CiAgICBjbGFzc05hbWU6IGZpbmFsQ2xhc3NOYW1lCiAgfSkpOwp9CmZ1bmN0aW9uIHNob3VsZFJlbmRlckRvdHMocG9pbnRzLCBkb3QpIHsKICBpZiAocG9pbnRzID09IG51bGwpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKGRvdCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBwb2ludHMubGVuZ3RoID09PSAxOwp9CmZ1bmN0aW9uIERvdHMoX3JlZjMpIHsKICB2YXIgewogICAgcG9pbnRzLAogICAgZG90LAogICAgY2xhc3NOYW1lLAogICAgZG90Q2xhc3NOYW1lLAogICAgZGF0YUtleSwKICAgIGJhc2VQcm9wcywKICAgIG5lZWRDbGlwLAogICAgY2xpcFBhdGhJZCwKICAgIHpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5zY2F0dGVyCiAgfSA9IF9yZWYzOwogIGlmICghc2hvdWxkUmVuZGVyRG90cyhwb2ludHMsIGRvdCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgY2xpcERvdCA9IGlzQ2xpcERvdChkb3QpOwogIHZhciBjdXN0b21Eb3RQcm9wcyA9IHN2Z1Byb3BlcnRpZXNBbmRFdmVudHNGcm9tVW5rbm93bihkb3QpOwogIHZhciBkb3RzID0gcG9pbnRzLm1hcCgoZW50cnksIGkpID0+IHsKICAgIHZhciBfZW50cnkkeCwgX2VudHJ5JHk7CiAgICB2YXIgZG90UHJvcHMgPSBfb2JqZWN0U3ByZWFkMjQoX29iamVjdFNwcmVhZDI0KF9vYmplY3RTcHJlYWQyNCh7CiAgICAgIHI6IDMKICAgIH0sIGJhc2VQcm9wcyksIGN1c3RvbURvdFByb3BzKSwge30sIHsKICAgICAgaW5kZXg6IGksCiAgICAgIGN4OiAoX2VudHJ5JHggPSBlbnRyeS54KSAhPT0gbnVsbCAmJiBfZW50cnkkeCAhPT0gdm9pZCAwID8gX2VudHJ5JHggOiB2b2lkIDAsCiAgICAgIGN5OiAoX2VudHJ5JHkgPSBlbnRyeS55KSAhPT0gbnVsbCAmJiBfZW50cnkkeSAhPT0gdm9pZCAwID8gX2VudHJ5JHkgOiB2b2lkIDAsCiAgICAgIGRhdGFLZXksCiAgICAgIHZhbHVlOiBlbnRyeS52YWx1ZSwKICAgICAgcGF5bG9hZDogZW50cnkucGF5bG9hZCwKICAgICAgcG9pbnRzCiAgICB9KTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxOS5jcmVhdGVFbGVtZW50KERvdEl0ZW0sIHsKICAgICAga2V5OiAiZG90LSIuY29uY2F0KGkpLAogICAgICBvcHRpb246IGRvdCwKICAgICAgZG90UHJvcHMsCiAgICAgIGNsYXNzTmFtZTogZG90Q2xhc3NOYW1lCiAgICB9KTsKICB9KTsKICB2YXIgbGF5ZXJQcm9wcyA9IHt9OwogIGlmIChuZWVkQ2xpcCAmJiBjbGlwUGF0aElkICE9IG51bGwpIHsKICAgIGxheWVyUHJvcHMuY2xpcFBhdGggPSAidXJsKCNjbGlwUGF0aC0iLmNvbmNhdChjbGlwRG90ID8gIiIgOiAiZG90cy0iKS5jb25jYXQoY2xpcFBhdGhJZCwgIikiKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE5LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE5LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIF9leHRlbmRzMTQoewogICAgY2xhc3NOYW1lCiAgfSwgbGF5ZXJQcm9wcyksIGRvdHMpKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0FjdGl2ZVBvaW50cy5qcwp2YXIgUmVhY3QyMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvY2FydGVzaWFuQXhpc1NsaWNlLmpzCmZ1bmN0aW9uIG93bktleXMyNShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI1KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjUoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI2KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI1KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyNihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI2KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI2KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI2KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI2KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgaW5pdGlhbFN0YXRlOCA9IHsKICB4QXhpczoge30sCiAgeUF4aXM6IHt9LAogIHpBeGlzOiB7fQp9Owp2YXIgY2FydGVzaWFuQXhpc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJjYXJ0ZXNpYW5BeGlzIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTgsCiAgcmVkdWNlcnM6IHsKICAgIGFkZFhBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLnhBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXSA9IGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCk7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVwbGFjZVhBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciB7CiAgICAgICAgICBwcmV2LAogICAgICAgICAgbmV4dAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUueEF4aXNbcHJldi5pZF0gIT09IHZvaWQgMCkgewogICAgICAgICAgaWYgKHByZXYuaWQgIT09IG5leHQuaWQpIHsKICAgICAgICAgICAgZGVsZXRlIHN0YXRlLnhBeGlzW3ByZXYuaWRdOwogICAgICAgICAgfQogICAgICAgICAgc3RhdGUueEF4aXNbbmV4dC5pZF0gPSBjYXN0RHJhZnQobmV4dCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZVhBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIGRlbGV0ZSBzdGF0ZS54QXhpc1thY3Rpb24ucGF5bG9hZC5pZF07CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgYWRkWUF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUueUF4aXNbYWN0aW9uLnBheWxvYWQuaWRdID0gY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZXBsYWNlWUF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHByZXYsCiAgICAgICAgICBuZXh0CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIGlmIChzdGF0ZS55QXhpc1twcmV2LmlkXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBpZiAocHJldi5pZCAhPT0gbmV4dC5pZCkgewogICAgICAgICAgICBkZWxldGUgc3RhdGUueUF4aXNbcHJldi5pZF07CiAgICAgICAgICB9CiAgICAgICAgICBzdGF0ZS55QXhpc1tuZXh0LmlkXSA9IGNhc3REcmFmdChuZXh0KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlWUF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgZGVsZXRlIHN0YXRlLnlBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICBhZGRaQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS56QXhpc1thY3Rpb24ucGF5bG9hZC5pZF0gPSBjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlcGxhY2VaQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgewogICAgICAgICAgcHJldiwKICAgICAgICAgIG5leHQKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgaWYgKHN0YXRlLnpBeGlzW3ByZXYuaWRdICE9PSB2b2lkIDApIHsKICAgICAgICAgIGlmIChwcmV2LmlkICE9PSBuZXh0LmlkKSB7CiAgICAgICAgICAgIGRlbGV0ZSBzdGF0ZS56QXhpc1twcmV2LmlkXTsKICAgICAgICAgIH0KICAgICAgICAgIHN0YXRlLnpBeGlzW25leHQuaWRdID0gY2FzdERyYWZ0KG5leHQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVaQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBkZWxldGUgc3RhdGUuekF4aXNbYWN0aW9uLnBheWxvYWQuaWRdOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHVwZGF0ZVlBeGlzV2lkdGgoc3RhdGUsIGFjdGlvbikgewogICAgICB2YXIgewogICAgICAgIGlkLAogICAgICAgIHdpZHRoCiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgdmFyIGF4aXMgPSBzdGF0ZS55QXhpc1tpZF07CiAgICAgIGlmIChheGlzKSB7CiAgICAgICAgdmFyIGhpc3RvcnkgPSBheGlzLndpZHRoSGlzdG9yeSB8fCBbXTsKICAgICAgICBpZiAoaGlzdG9yeS5sZW5ndGggPT09IDMgJiYgaGlzdG9yeVswXSA9PT0gaGlzdG9yeVsyXSAmJiB3aWR0aCA9PT0gaGlzdG9yeVsxXSAmJiB3aWR0aCAhPT0gYXhpcy53aWR0aCAmJiBNYXRoLmFicyh3aWR0aCAtIGhpc3RvcnlbMF0pIDw9IDEpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIG5ld0hpc3RvcnkgPSBbLi4uaGlzdG9yeSwgd2lkdGhdLnNsaWNlKC0zKTsKICAgICAgICBzdGF0ZS55QXhpc1tpZF0gPSBfb2JqZWN0U3ByZWFkMjUoX29iamVjdFNwcmVhZDI1KHt9LCBzdGF0ZS55QXhpc1tpZF0pLCB7fSwgewogICAgICAgICAgd2lkdGgsCiAgICAgICAgICB3aWR0aEhpc3Rvcnk6IG5ld0hpc3RvcnkKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkWEF4aXMsCiAgcmVwbGFjZVhBeGlzLAogIHJlbW92ZVhBeGlzLAogIGFkZFlBeGlzLAogIHJlcGxhY2VZQXhpcywKICByZW1vdmVZQXhpcywKICBhZGRaQXhpcywKICByZXBsYWNlWkF4aXMsCiAgcmVtb3ZlWkF4aXMsCiAgdXBkYXRlWUF4aXNXaWR0aAp9ID0gY2FydGVzaWFuQXhpc1NsaWNlLmFjdGlvbnM7CnZhciBjYXJ0ZXNpYW5BeGlzUmVkdWNlciA9IGNhcnRlc2lhbkF4aXNTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdENoYXJ0T2Zmc2V0LmpzCnZhciBzZWxlY3RDaGFydE9mZnNldCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydE9mZnNldEludGVybmFsXSwgKG9mZnNldEludGVybmFsKSA9PiB7CiAgcmV0dXJuIHsKICAgIHRvcDogb2Zmc2V0SW50ZXJuYWwudG9wLAogICAgYm90dG9tOiBvZmZzZXRJbnRlcm5hbC5ib3R0b20sCiAgICBsZWZ0OiBvZmZzZXRJbnRlcm5hbC5sZWZ0LAogICAgcmlnaHQ6IG9mZnNldEludGVybmFsLnJpZ2h0CiAgfTsKfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0UGxvdEFyZWEuanMKdmFyIHNlbGVjdFBsb3RBcmVhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0LCBzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodF0sIChvZmZzZXQsIGNoYXJ0V2lkdGgsIGNoYXJ0SGVpZ2h0KSA9PiB7CiAgaWYgKCFvZmZzZXQgfHwgY2hhcnRXaWR0aCA9PSBudWxsIHx8IGNoYXJ0SGVpZ2h0ID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiB7CiAgICB4OiBvZmZzZXQubGVmdCwKICAgIHk6IG9mZnNldC50b3AsCiAgICB3aWR0aDogTWF0aC5tYXgoMCwgY2hhcnRXaWR0aCAtIG9mZnNldC5sZWZ0IC0gb2Zmc2V0LnJpZ2h0KSwKICAgIGhlaWdodDogTWF0aC5tYXgoMCwgY2hhcnRIZWlnaHQgLSBvZmZzZXQudG9wIC0gb2Zmc2V0LmJvdHRvbSkKICB9Owp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2hvb2tzLmpzCnZhciB1c2VQbG90QXJlYSA9ICgpID0+IHsKICByZXR1cm4gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0UGxvdEFyZWEpOwp9Owp2YXIgdXNlQWN0aXZlVG9vbHRpcERhdGFQb2ludHMgPSAoKSA9PiB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKHNlbGVjdEFjdGl2ZVRvb2x0aXBEYXRhUG9pbnRzKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9BY3RpdmVQb2ludHMuanMKZnVuY3Rpb24gb3duS2V5czI2KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjYoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyNihPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjcoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjYoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTI3KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjcocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjcodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjcodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjcodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBBY3RpdmVQb2ludCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBwb2ludDogcG9pbnQ0LAogICAgY2hpbGRJbmRleCwKICAgIG1haW5Db2xvciwKICAgIGFjdGl2ZURvdCwKICAgIGRhdGFLZXksCiAgICBjbGlwUGF0aAogIH0gPSBfcmVmMjsKICBpZiAoYWN0aXZlRG90ID09PSBmYWxzZSB8fCBwb2ludDQueCA9PSBudWxsIHx8IHBvaW50NC55ID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgZG90UHJvcHNUeXBlZCA9IHsKICAgIGluZGV4OiBjaGlsZEluZGV4LAogICAgZGF0YUtleSwKICAgIGN4OiBwb2ludDQueCwKICAgIGN5OiBwb2ludDQueSwKICAgIHI6IDQsCiAgICBmaWxsOiBtYWluQ29sb3IgIT09IG51bGwgJiYgbWFpbkNvbG9yICE9PSB2b2lkIDAgPyBtYWluQ29sb3IgOiAibm9uZSIsCiAgICBzdHJva2VXaWR0aDogMiwKICAgIHN0cm9rZTogIiNmZmYiLAogICAgcGF5bG9hZDogcG9pbnQ0LnBheWxvYWQsCiAgICB2YWx1ZTogcG9pbnQ0LnZhbHVlCiAgfTsKICB2YXIgZG90UHJvcHMgPSBfb2JqZWN0U3ByZWFkMjYoX29iamVjdFNwcmVhZDI2KF9vYmplY3RTcHJlYWQyNih7fSwgZG90UHJvcHNUeXBlZCksIHN2Z1Byb3BlcnRpZXNOb0V2ZW50c0Zyb21Vbmtub3duKGFjdGl2ZURvdCkpLCBhZGFwdEV2ZW50SGFuZGxlcnMoYWN0aXZlRG90KSk7CiAgdmFyIGRvdDsKICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzNC5pc1ZhbGlkRWxlbWVudCkoYWN0aXZlRG90KSkgewogICAgZG90ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzNC5jbG9uZUVsZW1lbnQpKGFjdGl2ZURvdCwgZG90UHJvcHMpOwogIH0gZWxzZSBpZiAodHlwZW9mIGFjdGl2ZURvdCA9PT0gImZ1bmN0aW9uIikgewogICAgZG90ID0gYWN0aXZlRG90KGRvdFByb3BzKTsKICB9IGVsc2UgewogICAgZG90ID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjAuY3JlYXRlRWxlbWVudChEb3QsIGRvdFByb3BzKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIwLmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWFjdGl2ZS1kb3QiLAogICAgY2xpcFBhdGgKICB9LCBkb3QpOwp9OwpmdW5jdGlvbiBBY3RpdmVQb2ludHMoX3JlZjIpIHsKICB2YXIgewogICAgcG9pbnRzLAogICAgbWFpbkNvbG9yLAogICAgYWN0aXZlRG90LAogICAgaXRlbURhdGFLZXksCiAgICBjbGlwUGF0aCwKICAgIHpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5hY3RpdmVEb3QKICB9ID0gX3JlZjI7CiAgdmFyIGFjdGl2ZVRvb2x0aXBJbmRleCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleCk7CiAgdmFyIGFjdGl2ZURhdGFQb2ludHMgPSB1c2VBY3RpdmVUb29sdGlwRGF0YVBvaW50cygpOwogIGlmIChwb2ludHMgPT0gbnVsbCB8fCBhY3RpdmVEYXRhUG9pbnRzID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgYWN0aXZlUG9pbnQgPSBwb2ludHMuZmluZCgocCkgPT4gYWN0aXZlRGF0YVBvaW50cy5pbmNsdWRlcyhwLnBheWxvYWQpKTsKICBpZiAoaXNOdWxsaXNoKGFjdGl2ZVBvaW50KSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMC5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMC5jcmVhdGVFbGVtZW50KEFjdGl2ZVBvaW50LCB7CiAgICBwb2ludDogYWN0aXZlUG9pbnQsCiAgICBjaGlsZEluZGV4OiBOdW1iZXIoYWN0aXZlVG9vbHRpcEluZGV4KSwKICAgIG1haW5Db2xvciwKICAgIGRhdGFLZXk6IGl0ZW1EYXRhS2V5LAogICAgYWN0aXZlRG90LAogICAgY2xpcFBhdGgKICB9KSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2Vycm9yQmFyU2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZTkgPSB7fTsKdmFyIGVycm9yQmFyU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImVycm9yQmFycyIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGU5LAogIHJlZHVjZXJzOiB7CiAgICBhZGRFcnJvckJhcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIHsKICAgICAgICBpdGVtSWQsCiAgICAgICAgZXJyb3JCYXIKICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICBpZiAoIXN0YXRlW2l0ZW1JZF0pIHsKICAgICAgICBzdGF0ZVtpdGVtSWRdID0gW107CiAgICAgIH0KICAgICAgc3RhdGVbaXRlbUlkXS5wdXNoKGVycm9yQmFyKTsKICAgIH0sCiAgICByZXBsYWNlRXJyb3JCYXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciB7CiAgICAgICAgaXRlbUlkLAogICAgICAgIHByZXYsCiAgICAgICAgbmV4dAogICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIGlmIChzdGF0ZVtpdGVtSWRdKSB7CiAgICAgICAgc3RhdGVbaXRlbUlkXSA9IHN0YXRlW2l0ZW1JZF0ubWFwKChlKSA9PiBlLmRhdGFLZXkgPT09IHByZXYuZGF0YUtleSAmJiBlLmRpcmVjdGlvbiA9PT0gcHJldi5kaXJlY3Rpb24gPyBuZXh0IDogZSk7CiAgICAgIH0KICAgIH0sCiAgICByZW1vdmVFcnJvckJhcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIHsKICAgICAgICBpdGVtSWQsCiAgICAgICAgZXJyb3JCYXIKICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICBpZiAoc3RhdGVbaXRlbUlkXSkgewogICAgICAgIHN0YXRlW2l0ZW1JZF0gPSBzdGF0ZVtpdGVtSWRdLmZpbHRlcigoZSkgPT4gZS5kYXRhS2V5ICE9PSBlcnJvckJhci5kYXRhS2V5IHx8IGUuZGlyZWN0aW9uICE9PSBlcnJvckJhci5kaXJlY3Rpb24pOwogICAgICB9CiAgICB9CiAgfQp9KTsKdmFyIHsKICBhZGRFcnJvckJhciwKICByZXBsYWNlRXJyb3JCYXIsCiAgcmVtb3ZlRXJyb3JCYXIKfSA9IGVycm9yQmFyU2xpY2UuYWN0aW9uczsKdmFyIGVycm9yQmFyUmVkdWNlciA9IGVycm9yQmFyU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9HcmFwaGljYWxJdGVtQ2xpcFBhdGguanMKdmFyIFJlYWN0MjEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIHVzZU5lZWRzQ2xpcCh4QXhpc0lkLCB5QXhpc0lkKSB7CiAgdmFyIF94QXhpcyRhbGxvd0RhdGFPdmVyZiwgX3lBeGlzJGFsbG93RGF0YU92ZXJmOwogIHZhciB4QXhpcyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WEF4aXNTZXR0aW5ncyhzdGF0ZSwgeEF4aXNJZCkpOwogIHZhciB5QXhpcyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WUF4aXNTZXR0aW5ncyhzdGF0ZSwgeUF4aXNJZCkpOwogIHZhciBuZWVkQ2xpcFggPSAoX3hBeGlzJGFsbG93RGF0YU92ZXJmID0geEF4aXMgPT09IG51bGwgfHwgeEF4aXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHhBeGlzLmFsbG93RGF0YU92ZXJmbG93KSAhPT0gbnVsbCAmJiBfeEF4aXMkYWxsb3dEYXRhT3ZlcmYgIT09IHZvaWQgMCA/IF94QXhpcyRhbGxvd0RhdGFPdmVyZiA6IGltcGxpY2l0WEF4aXMuYWxsb3dEYXRhT3ZlcmZsb3c7CiAgdmFyIG5lZWRDbGlwWSA9IChfeUF4aXMkYWxsb3dEYXRhT3ZlcmYgPSB5QXhpcyA9PT0gbnVsbCB8fCB5QXhpcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogeUF4aXMuYWxsb3dEYXRhT3ZlcmZsb3cpICE9PSBudWxsICYmIF95QXhpcyRhbGxvd0RhdGFPdmVyZiAhPT0gdm9pZCAwID8gX3lBeGlzJGFsbG93RGF0YU92ZXJmIDogaW1wbGljaXRZQXhpcy5hbGxvd0RhdGFPdmVyZmxvdzsKICB2YXIgbmVlZENsaXAgPSBuZWVkQ2xpcFggfHwgbmVlZENsaXBZOwogIHJldHVybiB7CiAgICBuZWVkQ2xpcCwKICAgIG5lZWRDbGlwWCwKICAgIG5lZWRDbGlwWQogIH07Cn0KZnVuY3Rpb24gR3JhcGhpY2FsSXRlbUNsaXBQYXRoKF9yZWYyKSB7CiAgdmFyIHsKICAgIHhBeGlzSWQsCiAgICB5QXhpc0lkLAogICAgY2xpcFBhdGhJZAogIH0gPSBfcmVmMjsKICB2YXIgcGxvdEFyZWEgPSB1c2VQbG90QXJlYSgpOwogIHZhciB7CiAgICBuZWVkQ2xpcFgsCiAgICBuZWVkQ2xpcFksCiAgICBuZWVkQ2xpcAogIH0gPSB1c2VOZWVkc0NsaXAoeEF4aXNJZCwgeUF4aXNJZCk7CiAgaWYgKCFuZWVkQ2xpcCB8fCAhcGxvdEFyZWEpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHBsb3RBcmVhOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMS5jcmVhdGVFbGVtZW50KCJjbGlwUGF0aCIsIHsKICAgIGlkOiAiY2xpcFBhdGgtIi5jb25jYXQoY2xpcFBhdGhJZCkKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMS5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgeDogbmVlZENsaXBYID8geDIgOiB4MiAtIHdpZHRoIC8gMiwKICAgIHk6IG5lZWRDbGlwWSA/IHkyIDogeTIgLSBoZWlnaHQgLyAyLAogICAgd2lkdGg6IG5lZWRDbGlwWCA/IHdpZHRoIDogd2lkdGggKiAyLAogICAgaGVpZ2h0OiBuZWVkQ2xpcFkgPyBoZWlnaHQgOiBoZWlnaHQgKiAyCiAgfSkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVhY3QtcmVkdXhAOS4yLjBfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWFjdC1yZWR1eC9kaXN0L3JlYWN0LXJlZHV4Lm1qcwp2YXIgUmVhY3QyMiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpLCAxKTsKdmFyIGltcG9ydF93aXRoX3NlbGVjdG9yMiA9IF9fdG9FU00ocmVxdWlyZV93aXRoX3NlbGVjdG9yMigpLCAxKTsKdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUgPSAvKiBAX19QVVJFX18gKi8gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKdmFyIFJFQUNUX01FTU9fVFlQRSA9IC8qIEBfX1BVUkVfXyAqLyBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CnZhciBGb3J3YXJkUmVmID0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTsKdmFyIE1lbW8gPSBSRUFDVF9NRU1PX1RZUEU7CmZ1bmN0aW9uIGRlZmF1bHROb29wQmF0Y2goY2FsbGJhY2spIHsKICBjYWxsYmFjaygpOwp9CmZ1bmN0aW9uIGNyZWF0ZUxpc3RlbmVyQ29sbGVjdGlvbigpIHsKICBsZXQgZmlyc3QgPSBudWxsOwogIGxldCBsYXN0MiA9IG51bGw7CiAgcmV0dXJuIHsKICAgIGNsZWFyKCkgewogICAgICBmaXJzdCA9IG51bGw7CiAgICAgIGxhc3QyID0gbnVsbDsKICAgIH0sCiAgICBub3RpZnkoKSB7CiAgICAgIGRlZmF1bHROb29wQmF0Y2goKCkgPT4gewogICAgICAgIGxldCBsaXN0ZW5lcjIgPSBmaXJzdDsKICAgICAgICB3aGlsZSAobGlzdGVuZXIyKSB7CiAgICAgICAgICBsaXN0ZW5lcjIuY2FsbGJhY2soKTsKICAgICAgICAgIGxpc3RlbmVyMiA9IGxpc3RlbmVyMi5uZXh0OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgZ2V0KCkgewogICAgICBjb25zdCBsaXN0ZW5lcnMgPSBbXTsKICAgICAgbGV0IGxpc3RlbmVyMiA9IGZpcnN0OwogICAgICB3aGlsZSAobGlzdGVuZXIyKSB7CiAgICAgICAgbGlzdGVuZXJzLnB1c2gobGlzdGVuZXIyKTsKICAgICAgICBsaXN0ZW5lcjIgPSBsaXN0ZW5lcjIubmV4dDsKICAgICAgfQogICAgICByZXR1cm4gbGlzdGVuZXJzOwogICAgfSwKICAgIHN1YnNjcmliZShjYWxsYmFjaykgewogICAgICBsZXQgaXNTdWJzY3JpYmVkID0gdHJ1ZTsKICAgICAgY29uc3QgbGlzdGVuZXIyID0gbGFzdDIgPSB7CiAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgbmV4dDogbnVsbCwKICAgICAgICBwcmV2OiBsYXN0MgogICAgICB9OwogICAgICBpZiAobGlzdGVuZXIyLnByZXYpIHsKICAgICAgICBsaXN0ZW5lcjIucHJldi5uZXh0ID0gbGlzdGVuZXIyOwogICAgICB9IGVsc2UgewogICAgICAgIGZpcnN0ID0gbGlzdGVuZXIyOwogICAgICB9CiAgICAgIHJldHVybiBmdW5jdGlvbiB1bnN1YnNjcmliZSgpIHsKICAgICAgICBpZiAoIWlzU3Vic2NyaWJlZCB8fCBmaXJzdCA9PT0gbnVsbCkgcmV0dXJuOwogICAgICAgIGlzU3Vic2NyaWJlZCA9IGZhbHNlOwogICAgICAgIGlmIChsaXN0ZW5lcjIubmV4dCkgewogICAgICAgICAgbGlzdGVuZXIyLm5leHQucHJldiA9IGxpc3RlbmVyMi5wcmV2OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsYXN0MiA9IGxpc3RlbmVyMi5wcmV2OwogICAgICAgIH0KICAgICAgICBpZiAobGlzdGVuZXIyLnByZXYpIHsKICAgICAgICAgIGxpc3RlbmVyMi5wcmV2Lm5leHQgPSBsaXN0ZW5lcjIubmV4dDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZmlyc3QgPSBsaXN0ZW5lcjIubmV4dDsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfTsKfQp2YXIgbnVsbExpc3RlbmVycyA9IHsKICBub3RpZnkoKSB7CiAgfSwKICBnZXQ6ICgpID0+IFtdCn07CmZ1bmN0aW9uIGNyZWF0ZVN1YnNjcmlwdGlvbihzdG9yZSwgcGFyZW50U3ViKSB7CiAgbGV0IHVuc3Vic2NyaWJlOwogIGxldCBsaXN0ZW5lcnMgPSBudWxsTGlzdGVuZXJzOwogIGxldCBzdWJzY3JpcHRpb25zQW1vdW50ID0gMDsKICBsZXQgc2VsZlN1YnNjcmliZWQgPSBmYWxzZTsKICBmdW5jdGlvbiBhZGROZXN0ZWRTdWIobGlzdGVuZXIyKSB7CiAgICB0cnlTdWJzY3JpYmUoKTsKICAgIGNvbnN0IGNsZWFudXBMaXN0ZW5lciA9IGxpc3RlbmVycy5zdWJzY3JpYmUobGlzdGVuZXIyKTsKICAgIGxldCByZW1vdmVkID0gZmFsc2U7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAoIXJlbW92ZWQpIHsKICAgICAgICByZW1vdmVkID0gdHJ1ZTsKICAgICAgICBjbGVhbnVwTGlzdGVuZXIoKTsKICAgICAgICB0cnlVbnN1YnNjcmliZSgpOwogICAgICB9CiAgICB9OwogIH0KICBmdW5jdGlvbiBub3RpZnlOZXN0ZWRTdWJzKCkgewogICAgbGlzdGVuZXJzLm5vdGlmeSgpOwogIH0KICBmdW5jdGlvbiBoYW5kbGVDaGFuZ2VXcmFwcGVyKCkgewogICAgaWYgKHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlKSB7CiAgICAgIHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlKCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGlzU3Vic2NyaWJlZCgpIHsKICAgIHJldHVybiBzZWxmU3Vic2NyaWJlZDsKICB9CiAgZnVuY3Rpb24gdHJ5U3Vic2NyaWJlKCkgewogICAgc3Vic2NyaXB0aW9uc0Ftb3VudCsrOwogICAgaWYgKCF1bnN1YnNjcmliZSkgewogICAgICB1bnN1YnNjcmliZSA9IHBhcmVudFN1YiA/IHBhcmVudFN1Yi5hZGROZXN0ZWRTdWIoaGFuZGxlQ2hhbmdlV3JhcHBlcikgOiBzdG9yZS5zdWJzY3JpYmUoaGFuZGxlQ2hhbmdlV3JhcHBlcik7CiAgICAgIGxpc3RlbmVycyA9IGNyZWF0ZUxpc3RlbmVyQ29sbGVjdGlvbigpOwogICAgfQogIH0KICBmdW5jdGlvbiB0cnlVbnN1YnNjcmliZSgpIHsKICAgIHN1YnNjcmlwdGlvbnNBbW91bnQtLTsKICAgIGlmICh1bnN1YnNjcmliZSAmJiBzdWJzY3JpcHRpb25zQW1vdW50ID09PSAwKSB7CiAgICAgIHVuc3Vic2NyaWJlKCk7CiAgICAgIHVuc3Vic2NyaWJlID0gdm9pZCAwOwogICAgICBsaXN0ZW5lcnMuY2xlYXIoKTsKICAgICAgbGlzdGVuZXJzID0gbnVsbExpc3RlbmVyczsKICAgIH0KICB9CiAgZnVuY3Rpb24gdHJ5U3Vic2NyaWJlU2VsZigpIHsKICAgIGlmICghc2VsZlN1YnNjcmliZWQpIHsKICAgICAgc2VsZlN1YnNjcmliZWQgPSB0cnVlOwogICAgICB0cnlTdWJzY3JpYmUoKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gdHJ5VW5zdWJzY3JpYmVTZWxmKCkgewogICAgaWYgKHNlbGZTdWJzY3JpYmVkKSB7CiAgICAgIHNlbGZTdWJzY3JpYmVkID0gZmFsc2U7CiAgICAgIHRyeVVuc3Vic2NyaWJlKCk7CiAgICB9CiAgfQogIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHsKICAgIGFkZE5lc3RlZFN1YiwKICAgIG5vdGlmeU5lc3RlZFN1YnMsCiAgICBoYW5kbGVDaGFuZ2VXcmFwcGVyLAogICAgaXNTdWJzY3JpYmVkLAogICAgdHJ5U3Vic2NyaWJlOiB0cnlTdWJzY3JpYmVTZWxmLAogICAgdHJ5VW5zdWJzY3JpYmU6IHRyeVVuc3Vic2NyaWJlU2VsZiwKICAgIGdldExpc3RlbmVyczogKCkgPT4gbGlzdGVuZXJzCiAgfTsKICByZXR1cm4gc3Vic2NyaXB0aW9uOwp9CnZhciBjYW5Vc2VET00gPSAoKSA9PiAhISh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgIT09ICJ1bmRlZmluZWQiKTsKdmFyIGlzRE9NID0gLyogQF9fUFVSRV9fICovIGNhblVzZURPTSgpOwp2YXIgaXNSdW5uaW5nSW5SZWFjdE5hdGl2ZSA9ICgpID0+IHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiICYmIG5hdmlnYXRvci5wcm9kdWN0ID09PSAiUmVhY3ROYXRpdmUiOwp2YXIgaXNSZWFjdE5hdGl2ZSA9IC8qIEBfX1BVUkVfXyAqLyBpc1J1bm5pbmdJblJlYWN0TmF0aXZlKCk7CnZhciBnZXRVc2VJc29tb3JwaGljTGF5b3V0RWZmZWN0ID0gKCkgPT4gaXNET00gfHwgaXNSZWFjdE5hdGl2ZSA/IFJlYWN0MjIudXNlTGF5b3V0RWZmZWN0IDogUmVhY3QyMi51c2VFZmZlY3Q7CnZhciB1c2VJc29tb3JwaGljTGF5b3V0RWZmZWN0ID0gLyogQF9fUFVSRV9fICovIGdldFVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QoKTsKZnVuY3Rpb24gaXMzKHgyLCB5MikgewogIGlmICh4MiA9PT0geTIpIHsKICAgIHJldHVybiB4MiAhPT0gMCB8fCB5MiAhPT0gMCB8fCAxIC8geDIgPT09IDEgLyB5MjsKICB9IGVsc2UgewogICAgcmV0dXJuIHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgfQp9CmZ1bmN0aW9uIHNoYWxsb3dFcXVhbChvYmpBLCBvYmpCKSB7CiAgaWYgKGlzMyhvYmpBLCBvYmpCKSkgcmV0dXJuIHRydWU7CiAgaWYgKHR5cGVvZiBvYmpBICE9PSAib2JqZWN0IiB8fCBvYmpBID09PSBudWxsIHx8IHR5cGVvZiBvYmpCICE9PSAib2JqZWN0IiB8fCBvYmpCID09PSBudWxsKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGNvbnN0IGtleXNBID0gT2JqZWN0LmtleXMob2JqQSk7CiAgY29uc3Qga2V5c0IgPSBPYmplY3Qua2V5cyhvYmpCKTsKICBpZiAoa2V5c0EubGVuZ3RoICE9PSBrZXlzQi5sZW5ndGgpIHJldHVybiBmYWxzZTsKICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXNBLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmpCLCBrZXlzQVtpXSkgfHwgIWlzMyhvYmpBW2tleXNBW2ldXSwgb2JqQltrZXlzQVtpXV0pKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KdmFyIEZPUldBUkRfUkVGX1NUQVRJQ1MgPSB7CiAgJCR0eXBlb2Y6IHRydWUsCiAgcmVuZGVyOiB0cnVlLAogIGRlZmF1bHRQcm9wczogdHJ1ZSwKICBkaXNwbGF5TmFtZTogdHJ1ZSwKICBwcm9wVHlwZXM6IHRydWUKfTsKdmFyIE1FTU9fU1RBVElDUyA9IHsKICAkJHR5cGVvZjogdHJ1ZSwKICBjb21wYXJlOiB0cnVlLAogIGRlZmF1bHRQcm9wczogdHJ1ZSwKICBkaXNwbGF5TmFtZTogdHJ1ZSwKICBwcm9wVHlwZXM6IHRydWUsCiAgdHlwZTogdHJ1ZQp9Owp2YXIgVFlQRV9TVEFUSUNTID0gewogIFtGb3J3YXJkUmVmXTogRk9SV0FSRF9SRUZfU1RBVElDUywKICBbTWVtb106IE1FTU9fU1RBVElDUwp9Owp2YXIgb2JqZWN0UHJvdG90eXBlID0gT2JqZWN0LnByb3RvdHlwZTsKdmFyIENvbnRleHRLZXkgPSAvKiBAX19QVVJFX18gKi8gU3ltYm9sLmZvcihgcmVhY3QtcmVkdXgtY29udGV4dGApOwp2YXIgZ1QgPSB0eXBlb2YgZ2xvYmFsVGhpcyAhPT0gInVuZGVmaW5lZCIgPyBnbG9iYWxUaGlzIDogKAogIC8qIGZhbGwgYmFjayB0byBhIHBlci1tb2R1bGUgc2NvcGUgKHByZS04LjEgYmVoYXZpb3VyKSBpZiBgZ2xvYmFsVGhpc2AgaXMgbm90IGF2YWlsYWJsZSAqLwogIHt9Cik7CmZ1bmN0aW9uIGdldENvbnRleHQoKSB7CiAgaWYgKCFSZWFjdDIyLmNyZWF0ZUNvbnRleHQpIHJldHVybiB7fTsKICBjb25zdCBjb250ZXh0TWFwID0gZ1RbQ29udGV4dEtleV0gPz89IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgbGV0IHJlYWxDb250ZXh0ID0gY29udGV4dE1hcC5nZXQoUmVhY3QyMi5jcmVhdGVDb250ZXh0KTsKICBpZiAoIXJlYWxDb250ZXh0KSB7CiAgICByZWFsQ29udGV4dCA9IFJlYWN0MjIuY3JlYXRlQ29udGV4dCgKICAgICAgbnVsbAogICAgKTsKICAgIGlmICh0cnVlKSB7CiAgICAgIHJlYWxDb250ZXh0LmRpc3BsYXlOYW1lID0gIlJlYWN0UmVkdXgiOwogICAgfQogICAgY29udGV4dE1hcC5zZXQoUmVhY3QyMi5jcmVhdGVDb250ZXh0LCByZWFsQ29udGV4dCk7CiAgfQogIHJldHVybiByZWFsQ29udGV4dDsKfQp2YXIgUmVhY3RSZWR1eENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gZ2V0Q29udGV4dCgpOwpmdW5jdGlvbiBQcm92aWRlcihwcm92aWRlclByb3BzKSB7CiAgY29uc3QgeyBjaGlsZHJlbiwgY29udGV4dCwgc2VydmVyU3RhdGUsIHN0b3JlIH0gPSBwcm92aWRlclByb3BzOwogIGNvbnN0IGNvbnRleHRWYWx1ZSA9IFJlYWN0MjIudXNlTWVtbygoKSA9PiB7CiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBjcmVhdGVTdWJzY3JpcHRpb24oc3RvcmUpOwogICAgY29uc3QgYmFzZUNvbnRleHRWYWx1ZSA9IHsKICAgICAgc3RvcmUsCiAgICAgIHN1YnNjcmlwdGlvbiwKICAgICAgZ2V0U2VydmVyU3RhdGU6IHNlcnZlclN0YXRlID8gKCkgPT4gc2VydmVyU3RhdGUgOiB2b2lkIDAKICAgIH07CiAgICBpZiAoZmFsc2UpIHsKICAgICAgcmV0dXJuIGJhc2VDb250ZXh0VmFsdWU7CiAgICB9IGVsc2UgewogICAgICBjb25zdCB7IGlkZW50aXR5RnVuY3Rpb25DaGVjayA9ICJvbmNlIiwgc3RhYmlsaXR5Q2hlY2sgPSAib25jZSIgfSA9IHByb3ZpZGVyUHJvcHM7CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gT2JqZWN0LmFzc2lnbihiYXNlQ29udGV4dFZhbHVlLCB7CiAgICAgICAgc3RhYmlsaXR5Q2hlY2ssCiAgICAgICAgaWRlbnRpdHlGdW5jdGlvbkNoZWNrCiAgICAgIH0pOwogICAgfQogIH0sIFtzdG9yZSwgc2VydmVyU3RhdGVdKTsKICBjb25zdCBwcmV2aW91c1N0YXRlID0gUmVhY3QyMi51c2VNZW1vKCgpID0+IHN0b3JlLmdldFN0YXRlKCksIFtzdG9yZV0pOwogIHVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QoKCkgPT4gewogICAgY29uc3QgeyBzdWJzY3JpcHRpb24gfSA9IGNvbnRleHRWYWx1ZTsKICAgIHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlID0gc3Vic2NyaXB0aW9uLm5vdGlmeU5lc3RlZFN1YnM7CiAgICBzdWJzY3JpcHRpb24udHJ5U3Vic2NyaWJlKCk7CiAgICBpZiAocHJldmlvdXNTdGF0ZSAhPT0gc3RvcmUuZ2V0U3RhdGUoKSkgewogICAgICBzdWJzY3JpcHRpb24ubm90aWZ5TmVzdGVkU3VicygpOwogICAgfQogICAgcmV0dXJuICgpID0+IHsKICAgICAgc3Vic2NyaXB0aW9uLnRyeVVuc3Vic2NyaWJlKCk7CiAgICAgIHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlID0gdm9pZCAwOwogICAgfTsKICB9LCBbY29udGV4dFZhbHVlLCBwcmV2aW91c1N0YXRlXSk7CiAgY29uc3QgQ29udGV4dCA9IGNvbnRleHQgfHwgUmVhY3RSZWR1eENvbnRleHQ7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIyLmNyZWF0ZUVsZW1lbnQoQ29udGV4dC5Qcm92aWRlciwgeyB2YWx1ZTogY29udGV4dFZhbHVlIH0sIGNoaWxkcmVuKTsKfQp2YXIgUHJvdmlkZXJfZGVmYXVsdCA9IFByb3ZpZGVyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9wcm9wc0FyZUVxdWFsLmpzCnZhciBwcm9wc1RvU2hhbGxvd0NvbXBhcmUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbImF4aXNMaW5lIiwgInRpY2tMaW5lIiwgImFjdGl2ZUJhciIsICJhY3RpdmVEb3QiLCAiYWN0aXZlTGFiZWwiLCAiYWN0aXZlU2hhcGUiLCAiYWxsb3dFc2NhcGVWaWV3Qm94IiwgImJhY2tncm91bmQiLCAiY3Vyc29yIiwgImRvdCIsICJsYWJlbCIsICJsaW5lIiwgIm1hcmdpbiIsICJwYWRkaW5nIiwgInBvc2l0aW9uIiwgInNoYXBlIiwgInN0eWxlIiwgInRpY2siLCAid3JhcHBlclN0eWxlIl0pOwpmdW5jdGlvbiBzYW1lVmFsdWVaZXJvKHgyLCB5MikgewogIGlmICh4MiA9PSBudWxsICYmIHkyID09IG51bGwpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBpZiAodHlwZW9mIHgyID09PSAibnVtYmVyIiAmJiB0eXBlb2YgeTIgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4geDIgPT09IHkyIHx8IHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgfQogIHJldHVybiB4MiA9PT0geTI7Cn0KZnVuY3Rpb24gcHJvcHNBcmVFcXVhbChwcmV2UHJvcHMsIG5leHRQcm9wcykgewogIHZhciBhbGxLZXlzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWy4uLk9iamVjdC5rZXlzKHByZXZQcm9wcyksIC4uLk9iamVjdC5rZXlzKG5leHRQcm9wcyldKTsKICBmb3IgKHZhciBrZXkgb2YgYWxsS2V5cykgewogICAgaWYgKHByb3BzVG9TaGFsbG93Q29tcGFyZS5oYXMoa2V5KSkgewogICAgICBpZiAocHJldlByb3BzW2tleV0gPT0gbnVsbCAmJiBuZXh0UHJvcHNba2V5XSA9PSBudWxsKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKCFzaGFsbG93RXF1YWwocHJldlByb3BzW2tleV0sIG5leHRQcm9wc1trZXldKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSBlbHNlIGlmICghc2FtZVZhbHVlWmVybyhwcmV2UHJvcHNba2V5XSwgbmV4dFByb3BzW2tleV0pKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvY2hhcnREYXRhQ29udGV4dC5qcwp2YXIgaW1wb3J0X3JlYWN0MzUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBDaGFydERhdGFDb250ZXh0UHJvdmlkZXIgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgY2hhcnREYXRhCiAgfSA9IHByb3BzOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgKDAsIGltcG9ydF9yZWFjdDM1LnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKGlzUGFub3JhbWEpIHsKICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgfTsKICAgIH0KICAgIGRpc3BhdGNoKHNldENoYXJ0RGF0YShjaGFydERhdGEpKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGRpc3BhdGNoKHNldENoYXJ0RGF0YSh2b2lkIDApKTsKICAgIH07CiAgfSwgW2NoYXJ0RGF0YSwgZGlzcGF0Y2gsIGlzUGFub3JhbWFdKTsKICByZXR1cm4gbnVsbDsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2JydXNoU2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZTEwID0gewogIHg6IDAsCiAgeTogMCwKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgcGFkZGluZzogewogICAgdG9wOiAwLAogICAgcmlnaHQ6IDAsCiAgICBib3R0b206IDAsCiAgICBsZWZ0OiAwCiAgfQp9Owp2YXIgYnJ1c2hTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiYnJ1c2giLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMTAsCiAgcmVkdWNlcnM6IHsKICAgIHNldEJydXNoU2V0dGluZ3MoX3N0YXRlLCBhY3Rpb24pIHsKICAgICAgaWYgKGFjdGlvbi5wYXlsb2FkID09IG51bGwpIHsKICAgICAgICByZXR1cm4gaW5pdGlhbFN0YXRlMTA7CiAgICAgIH0KICAgICAgcmV0dXJuIGFjdGlvbi5wYXlsb2FkOwogICAgfQogIH0KfSk7CnZhciB7CiAgc2V0QnJ1c2hTZXR0aW5ncwp9ID0gYnJ1c2hTbGljZS5hY3Rpb25zOwp2YXIgYnJ1c2hSZWR1Y2VyID0gYnJ1c2hTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9DYXJ0ZXNpYW5VdGlscy5qcwpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyOChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI4KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI4KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI4KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI4KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgU2NhbGVIZWxwZXIgPSBjbGFzcyBfU2NhbGVIZWxwZXIgewogIHN0YXRpYyBjcmVhdGUob2JqKSB7CiAgICByZXR1cm4gbmV3IF9TY2FsZUhlbHBlcihvYmopOwogIH0KICBjb25zdHJ1Y3RvcihzY2FsZSkgewogICAgdGhpcy5zY2FsZSA9IHNjYWxlOwogIH0KICBnZXQgZG9tYWluKCkgewogICAgcmV0dXJuIHRoaXMuc2NhbGUuZG9tYWluOwogIH0KICBnZXQgcmFuZ2UoKSB7CiAgICByZXR1cm4gdGhpcy5zY2FsZS5yYW5nZTsKICB9CiAgZ2V0IHJhbmdlTWluKCkgewogICAgcmV0dXJuIHRoaXMucmFuZ2UoKVswXTsKICB9CiAgZ2V0IHJhbmdlTWF4KCkgewogICAgcmV0dXJuIHRoaXMucmFuZ2UoKVsxXTsKICB9CiAgZ2V0IGJhbmR3aWR0aCgpIHsKICAgIHJldHVybiB0aGlzLnNjYWxlLmJhbmR3aWR0aDsKICB9CiAgYXBwbHkodmFsdWUpIHsKICAgIHZhciB7CiAgICAgIGJhbmRBd2FyZSwKICAgICAgcG9zaXRpb24KICAgIH0gPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6IHt9OwogICAgaWYgKHZhbHVlID09PSB2b2lkIDApIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIGlmIChwb3NpdGlvbikgewogICAgICBzd2l0Y2ggKHBvc2l0aW9uKSB7CiAgICAgICAgY2FzZSAic3RhcnQiOiB7CiAgICAgICAgICByZXR1cm4gdGhpcy5zY2FsZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGNhc2UgIm1pZGRsZSI6IHsKICAgICAgICAgIHZhciBvZmZzZXQgPSB0aGlzLmJhbmR3aWR0aCA/IHRoaXMuYmFuZHdpZHRoKCkgLyAyIDogMDsKICAgICAgICAgIHJldHVybiB0aGlzLnNjYWxlKHZhbHVlKSArIG9mZnNldDsKICAgICAgICB9CiAgICAgICAgY2FzZSAiZW5kIjogewogICAgICAgICAgdmFyIF9vZmZzZXQgPSB0aGlzLmJhbmR3aWR0aCA/IHRoaXMuYmFuZHdpZHRoKCkgOiAwOwogICAgICAgICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpICsgX29mZnNldDsKICAgICAgICB9CiAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKGJhbmRBd2FyZSkgewogICAgICB2YXIgX29mZnNldDIgPSB0aGlzLmJhbmR3aWR0aCA/IHRoaXMuYmFuZHdpZHRoKCkgLyAyIDogMDsKICAgICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpICsgX29mZnNldDI7CiAgICB9CiAgICByZXR1cm4gdGhpcy5zY2FsZSh2YWx1ZSk7CiAgfQogIGlzSW5SYW5nZSh2YWx1ZSkgewogICAgdmFyIHJhbmdlNCA9IHRoaXMucmFuZ2UoKTsKICAgIHZhciBmaXJzdCA9IHJhbmdlNFswXTsKICAgIHZhciBsYXN0MiA9IHJhbmdlNFtyYW5nZTQubGVuZ3RoIC0gMV07CiAgICByZXR1cm4gZmlyc3QgPD0gbGFzdDIgPyB2YWx1ZSA+PSBmaXJzdCAmJiB2YWx1ZSA8PSBsYXN0MiA6IHZhbHVlID49IGxhc3QyICYmIHZhbHVlIDw9IGZpcnN0OwogIH0KfTsKX2RlZmluZVByb3BlcnR5MjgoU2NhbGVIZWxwZXIsICJFUFMiLCAxZS00KTsKZnVuY3Rpb24gbm9ybWFsaXplQW5nbGUoYW5nbGUpIHsKICByZXR1cm4gKGFuZ2xlICUgMTgwICsgMTgwKSAlIDE4MDsKfQp2YXIgZ2V0QW5nbGVkUmVjdGFuZ2xlV2lkdGggPSBmdW5jdGlvbiBnZXRBbmdsZWRSZWN0YW5nbGVXaWR0aDIoX3JlZjUpIHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gX3JlZjU7CiAgdmFyIGFuZ2xlID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiAwOwogIHZhciBub3JtYWxpemVkQW5nbGUgPSBub3JtYWxpemVBbmdsZShhbmdsZSk7CiAgdmFyIGFuZ2xlUmFkaWFucyA9IG5vcm1hbGl6ZWRBbmdsZSAqIE1hdGguUEkgLyAxODA7CiAgdmFyIGFuZ2xlVGhyZXNob2xkID0gTWF0aC5hdGFuKGhlaWdodCAvIHdpZHRoKTsKICB2YXIgYW5nbGVkV2lkdGggPSBhbmdsZVJhZGlhbnMgPiBhbmdsZVRocmVzaG9sZCAmJiBhbmdsZVJhZGlhbnMgPCBNYXRoLlBJIC0gYW5nbGVUaHJlc2hvbGQgPyBoZWlnaHQgLyBNYXRoLnNpbihhbmdsZVJhZGlhbnMpIDogd2lkdGggLyBNYXRoLmNvcyhhbmdsZVJhZGlhbnMpOwogIHJldHVybiBNYXRoLmFicyhhbmdsZWRXaWR0aCk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9yZWZlcmVuY2VFbGVtZW50c1NsaWNlLmpzCnZhciBpbml0aWFsU3RhdGUxMSA9IHsKICBkb3RzOiBbXSwKICBhcmVhczogW10sCiAgbGluZXM6IFtdCn07CnZhciByZWZlcmVuY2VFbGVtZW50c1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJyZWZlcmVuY2VFbGVtZW50cyIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGUxMSwKICByZWR1Y2VyczogewogICAgYWRkRG90OiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICBzdGF0ZS5kb3RzLnB1c2goYWN0aW9uLnBheWxvYWQpOwogICAgfSwKICAgIHJlbW92ZURvdDogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkuZG90cy5maW5kSW5kZXgoKGRvdCkgPT4gZG90ID09PSBhY3Rpb24ucGF5bG9hZCk7CiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICBzdGF0ZS5kb3RzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIH0KICAgIH0sCiAgICBhZGRBcmVhOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICBzdGF0ZS5hcmVhcy5wdXNoKGFjdGlvbi5wYXlsb2FkKTsKICAgIH0sCiAgICByZW1vdmVBcmVhOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5hcmVhcy5maW5kSW5kZXgoKGFyZWEpID0+IGFyZWEgPT09IGFjdGlvbi5wYXlsb2FkKTsKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgIHN0YXRlLmFyZWFzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIH0KICAgIH0sCiAgICBhZGRMaW5lOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICBzdGF0ZS5saW5lcy5wdXNoKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgfSwKICAgIHJlbW92ZUxpbmU6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLmxpbmVzLmZpbmRJbmRleCgobGluZSkgPT4gbGluZSA9PT0gYWN0aW9uLnBheWxvYWQpOwogICAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgICAgc3RhdGUubGluZXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgfQogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkRG90LAogIHJlbW92ZURvdCwKICBhZGRBcmVhLAogIHJlbW92ZUFyZWEsCiAgYWRkTGluZSwKICByZW1vdmVMaW5lCn0gPSByZWZlcmVuY2VFbGVtZW50c1NsaWNlLmFjdGlvbnM7CnZhciByZWZlcmVuY2VFbGVtZW50c1JlZHVjZXIgPSByZWZlcmVuY2VFbGVtZW50c1NsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250YWluZXIvQ2xpcFBhdGhQcm92aWRlci5qcwp2YXIgUmVhY3QyMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgQ2xpcFBhdGhJZENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDM2LmNyZWF0ZUNvbnRleHQpKHZvaWQgMCk7CnZhciBDbGlwUGF0aFByb3ZpZGVyID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyOwogIHZhciBbY2xpcFBhdGhJZF0gPSAoMCwgaW1wb3J0X3JlYWN0MzYudXNlU3RhdGUpKCIiLmNvbmNhdCh1bmlxdWVJZCgicmVjaGFydHMiKSwgIi1jbGlwIikpOwogIHZhciBwbG90QXJlYSA9IHVzZVBsb3RBcmVhKCk7CiAgaWYgKHBsb3RBcmVhID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHBsb3RBcmVhOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMy5jcmVhdGVFbGVtZW50KENsaXBQYXRoSWRDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogY2xpcFBhdGhJZAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIzLmNyZWF0ZUVsZW1lbnQoImRlZnMiLCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMy5jcmVhdGVFbGVtZW50KCJjbGlwUGF0aCIsIHsKICAgIGlkOiBjbGlwUGF0aElkCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjMuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICBoZWlnaHQsCiAgICB3aWR0aAogIH0pKSksIGNoaWxkcmVuKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9DYXJ0ZXNpYW5BeGlzLmpzCnZhciBSZWFjdDI0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MzcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfZ2V0MyA9IF9fdG9FU00ocmVxdWlyZV9nZXQyKCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9nZXRFdmVyeU50aFdpdGhDb25kaXRpb24uanMKZnVuY3Rpb24gZ2V0RXZlcnlOdGhXaXRoQ29uZGl0aW9uKGFycmF5LCBuKSB7CiAgaWYgKG4gPCAxKSB7CiAgICByZXR1cm4gW107CiAgfQogIGlmIChuID09PSAxKSB7CiAgICByZXR1cm4gYXJyYXk7CiAgfQogIHZhciByZXN1bHQgPSBbXTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSArPSBuKSB7CiAgICByZXN1bHQucHVzaChhcnJheVtpXSk7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvVGlja1V0aWxzLmpzCmZ1bmN0aW9uIGdldEFuZ2xlZFRpY2tXaWR0aChjb250ZW50U2l6ZSwgdW5pdFNpemUsIGFuZ2xlKSB7CiAgdmFyIHNpemUgPSB7CiAgICB3aWR0aDogY29udGVudFNpemUud2lkdGggKyB1bml0U2l6ZS53aWR0aCwKICAgIGhlaWdodDogY29udGVudFNpemUuaGVpZ2h0ICsgdW5pdFNpemUuaGVpZ2h0CiAgfTsKICByZXR1cm4gZ2V0QW5nbGVkUmVjdGFuZ2xlV2lkdGgoc2l6ZSwgYW5nbGUpOwp9CmZ1bmN0aW9uIGdldFRpY2tCb3VuZGFyaWVzKHZpZXdCb3gsIHNpZ24yLCBzaXplS2V5KSB7CiAgdmFyIGlzV2lkdGggPSBzaXplS2V5ID09PSAid2lkdGgiOwogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gdmlld0JveDsKICBpZiAoc2lnbjIgPT09IDEpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBpc1dpZHRoID8geDIgOiB5MiwKICAgICAgZW5kOiBpc1dpZHRoID8geDIgKyB3aWR0aCA6IHkyICsgaGVpZ2h0CiAgICB9OwogIH0KICByZXR1cm4gewogICAgc3RhcnQ6IGlzV2lkdGggPyB4MiArIHdpZHRoIDogeTIgKyBoZWlnaHQsCiAgICBlbmQ6IGlzV2lkdGggPyB4MiA6IHkyCiAgfTsKfQpmdW5jdGlvbiBpc1Zpc2libGUoc2lnbjIsIHRpY2tQb3NpdGlvbiwgZ2V0U2l6ZSwgc3RhcnQsIGVuZCkgewogIGlmIChzaWduMiAqIHRpY2tQb3NpdGlvbiA8IHNpZ24yICogc3RhcnQgfHwgc2lnbjIgKiB0aWNrUG9zaXRpb24gPiBzaWduMiAqIGVuZCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICB2YXIgc2l6ZSA9IGdldFNpemUoKTsKICByZXR1cm4gc2lnbjIgKiAodGlja1Bvc2l0aW9uIC0gc2lnbjIgKiBzaXplIC8gMiAtIHN0YXJ0KSA+PSAwICYmIHNpZ24yICogKHRpY2tQb3NpdGlvbiArIHNpZ24yICogc2l6ZSAvIDIgLSBlbmQpIDw9IDA7Cn0KZnVuY3Rpb24gZ2V0TnVtYmVySW50ZXJ2YWxUaWNrcyh0aWNrczIsIGludGVydmFsKSB7CiAgcmV0dXJuIGdldEV2ZXJ5TnRoV2l0aENvbmRpdGlvbih0aWNrczIsIGludGVydmFsICsgMSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9nZXRFcXVpZGlzdGFudFRpY2tzLmpzCmZ1bmN0aW9uIGdldEVxdWlkaXN0YW50VGlja3Moc2lnbjIsIGJvdW5kYXJpZXMsIGdldFRpY2tTaXplLCB0aWNrczIsIG1pblRpY2tHYXApIHsKICB2YXIgcmVzdWx0ID0gKHRpY2tzMiB8fCBbXSkuc2xpY2UoKTsKICB2YXIgewogICAgc3RhcnQ6IGluaXRpYWxTdGFydCwKICAgIGVuZAogIH0gPSBib3VuZGFyaWVzOwogIHZhciBpbmRleCA9IDA7CiAgdmFyIHN0ZXBzaXplID0gMTsKICB2YXIgc3RhcnQgPSBpbml0aWFsU3RhcnQ7CiAgdmFyIF9sb29wID0gZnVuY3Rpb24gX2xvb3AyKCkgewogICAgdmFyIGVudHJ5ID0gdGlja3MyID09PSBudWxsIHx8IHRpY2tzMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogdGlja3MyW2luZGV4XTsKICAgIGlmIChlbnRyeSA9PT0gdm9pZCAwKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdjogZ2V0RXZlcnlOdGhXaXRoQ29uZGl0aW9uKHRpY2tzMiwgc3RlcHNpemUpCiAgICAgIH07CiAgICB9CiAgICB2YXIgaSA9IGluZGV4OwogICAgdmFyIHNpemU7CiAgICB2YXIgZ2V0U2l6ZSA9ICgpID0+IHsKICAgICAgaWYgKHNpemUgPT09IHZvaWQgMCkgewogICAgICAgIHNpemUgPSBnZXRUaWNrU2l6ZShlbnRyeSwgaSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpemU7CiAgICB9OwogICAgdmFyIHRpY2tDb29yZCA9IGVudHJ5LmNvb3JkaW5hdGU7CiAgICB2YXIgaXNTaG93ID0gaW5kZXggPT09IDAgfHwgaXNWaXNpYmxlKHNpZ24yLCB0aWNrQ29vcmQsIGdldFNpemUsIHN0YXJ0LCBlbmQpOwogICAgaWYgKCFpc1Nob3cpIHsKICAgICAgaW5kZXggPSAwOwogICAgICBzdGFydCA9IGluaXRpYWxTdGFydDsKICAgICAgc3RlcHNpemUgKz0gMTsKICAgIH0KICAgIGlmIChpc1Nob3cpIHsKICAgICAgc3RhcnQgPSB0aWNrQ29vcmQgKyBzaWduMiAqIChnZXRTaXplKCkgLyAyICsgbWluVGlja0dhcCk7CiAgICAgIGluZGV4ICs9IHN0ZXBzaXplOwogICAgfQogIH0sIF9yZXQ7CiAgd2hpbGUgKHN0ZXBzaXplIDw9IHJlc3VsdC5sZW5ndGgpIHsKICAgIF9yZXQgPSBfbG9vcCgpOwogICAgaWYgKF9yZXQpIHJldHVybiBfcmV0LnY7CiAgfQogIHJldHVybiBbXTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL2dldFRpY2tzLmpzCmZ1bmN0aW9uIG93bktleXMyNyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI3KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjcoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI5KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI3KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyOShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI5KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI5KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI5KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI5KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBnZXRUaWNrc0VuZChzaWduMiwgYm91bmRhcmllcywgZ2V0VGlja1NpemUsIHRpY2tzMiwgbWluVGlja0dhcCkgewogIHZhciByZXN1bHQgPSAodGlja3MyIHx8IFtdKS5zbGljZSgpOwogIHZhciBsZW4gPSByZXN1bHQubGVuZ3RoOwogIHZhciB7CiAgICBzdGFydAogIH0gPSBib3VuZGFyaWVzOwogIHZhciB7CiAgICBlbmQKICB9ID0gYm91bmRhcmllczsKICB2YXIgX2xvb3AgPSBmdW5jdGlvbiBfbG9vcDIoaTIpIHsKICAgIHZhciBlbnRyeSA9IHJlc3VsdFtpMl07CiAgICB2YXIgc2l6ZTsKICAgIHZhciBnZXRTaXplID0gKCkgPT4gewogICAgICBpZiAoc2l6ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgc2l6ZSA9IGdldFRpY2tTaXplKGVudHJ5LCBpMik7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpemU7CiAgICB9OwogICAgaWYgKGkyID09PSBsZW4gLSAxKSB7CiAgICAgIHZhciBnYXAgPSBzaWduMiAqIChlbnRyeS5jb29yZGluYXRlICsgc2lnbjIgKiBnZXRTaXplKCkgLyAyIC0gZW5kKTsKICAgICAgcmVzdWx0W2kyXSA9IGVudHJ5ID0gX29iamVjdFNwcmVhZDI3KF9vYmplY3RTcHJlYWQyNyh7fSwgZW50cnkpLCB7fSwgewogICAgICAgIHRpY2tDb29yZDogZ2FwID4gMCA/IGVudHJ5LmNvb3JkaW5hdGUgLSBnYXAgKiBzaWduMiA6IGVudHJ5LmNvb3JkaW5hdGUKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICByZXN1bHRbaTJdID0gZW50cnkgPSBfb2JqZWN0U3ByZWFkMjcoX29iamVjdFNwcmVhZDI3KHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgdGlja0Nvb3JkOiBlbnRyeS5jb29yZGluYXRlCiAgICAgIH0pOwogICAgfQogICAgaWYgKGVudHJ5LnRpY2tDb29yZCAhPSBudWxsKSB7CiAgICAgIHZhciBpc1Nob3cgPSBpc1Zpc2libGUoc2lnbjIsIGVudHJ5LnRpY2tDb29yZCwgZ2V0U2l6ZSwgc3RhcnQsIGVuZCk7CiAgICAgIGlmIChpc1Nob3cpIHsKICAgICAgICBlbmQgPSBlbnRyeS50aWNrQ29vcmQgLSBzaWduMiAqIChnZXRTaXplKCkgLyAyICsgbWluVGlja0dhcCk7CiAgICAgICAgcmVzdWx0W2kyXSA9IF9vYmplY3RTcHJlYWQyNyhfb2JqZWN0U3ByZWFkMjcoe30sIGVudHJ5KSwge30sIHsKICAgICAgICAgIGlzU2hvdzogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfTsKICBmb3IgKHZhciBpID0gbGVuIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgIF9sb29wKGkpOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIGdldFRpY2tzU3RhcnQoc2lnbjIsIGJvdW5kYXJpZXMsIGdldFRpY2tTaXplLCB0aWNrczIsIG1pblRpY2tHYXAsIHByZXNlcnZlRW5kKSB7CiAgdmFyIHJlc3VsdCA9ICh0aWNrczIgfHwgW10pLnNsaWNlKCk7CiAgdmFyIGxlbiA9IHJlc3VsdC5sZW5ndGg7CiAgdmFyIHsKICAgIHN0YXJ0LAogICAgZW5kCiAgfSA9IGJvdW5kYXJpZXM7CiAgaWYgKHByZXNlcnZlRW5kKSB7CiAgICB2YXIgdGFpbCA9IHRpY2tzMltsZW4gLSAxXTsKICAgIHZhciB0YWlsU2l6ZSA9IGdldFRpY2tTaXplKHRhaWwsIGxlbiAtIDEpOwogICAgdmFyIHRhaWxHYXAgPSBzaWduMiAqICh0YWlsLmNvb3JkaW5hdGUgKyBzaWduMiAqIHRhaWxTaXplIC8gMiAtIGVuZCk7CiAgICByZXN1bHRbbGVuIC0gMV0gPSB0YWlsID0gX29iamVjdFNwcmVhZDI3KF9vYmplY3RTcHJlYWQyNyh7fSwgdGFpbCksIHt9LCB7CiAgICAgIHRpY2tDb29yZDogdGFpbEdhcCA+IDAgPyB0YWlsLmNvb3JkaW5hdGUgLSB0YWlsR2FwICogc2lnbjIgOiB0YWlsLmNvb3JkaW5hdGUKICAgIH0pOwogICAgaWYgKHRhaWwudGlja0Nvb3JkICE9IG51bGwpIHsKICAgICAgdmFyIGlzVGFpbFNob3cgPSBpc1Zpc2libGUoc2lnbjIsIHRhaWwudGlja0Nvb3JkLCAoKSA9PiB0YWlsU2l6ZSwgc3RhcnQsIGVuZCk7CiAgICAgIGlmIChpc1RhaWxTaG93KSB7CiAgICAgICAgZW5kID0gdGFpbC50aWNrQ29vcmQgLSBzaWduMiAqICh0YWlsU2l6ZSAvIDIgKyBtaW5UaWNrR2FwKTsKICAgICAgICByZXN1bHRbbGVuIC0gMV0gPSBfb2JqZWN0U3ByZWFkMjcoX29iamVjdFNwcmVhZDI3KHt9LCB0YWlsKSwge30sIHsKICAgICAgICAgIGlzU2hvdzogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfQogIHZhciBjb3VudCA9IHByZXNlcnZlRW5kID8gbGVuIC0gMSA6IGxlbjsKICB2YXIgX2xvb3AyID0gZnVuY3Rpb24gX2xvb3AyMihpMikgewogICAgdmFyIGVudHJ5ID0gcmVzdWx0W2kyXTsKICAgIHZhciBzaXplOwogICAgdmFyIGdldFNpemUgPSAoKSA9PiB7CiAgICAgIGlmIChzaXplID09PSB2b2lkIDApIHsKICAgICAgICBzaXplID0gZ2V0VGlja1NpemUoZW50cnksIGkyKTsKICAgICAgfQogICAgICByZXR1cm4gc2l6ZTsKICAgIH07CiAgICBpZiAoaTIgPT09IDApIHsKICAgICAgdmFyIGdhcCA9IHNpZ24yICogKGVudHJ5LmNvb3JkaW5hdGUgLSBzaWduMiAqIGdldFNpemUoKSAvIDIgLSBzdGFydCk7CiAgICAgIHJlc3VsdFtpMl0gPSBlbnRyeSA9IF9vYmplY3RTcHJlYWQyNyhfb2JqZWN0U3ByZWFkMjcoe30sIGVudHJ5KSwge30sIHsKICAgICAgICB0aWNrQ29vcmQ6IGdhcCA8IDAgPyBlbnRyeS5jb29yZGluYXRlIC0gZ2FwICogc2lnbjIgOiBlbnRyeS5jb29yZGluYXRlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgcmVzdWx0W2kyXSA9IGVudHJ5ID0gX29iamVjdFNwcmVhZDI3KF9vYmplY3RTcHJlYWQyNyh7fSwgZW50cnkpLCB7fSwgewogICAgICAgIHRpY2tDb29yZDogZW50cnkuY29vcmRpbmF0ZQogICAgICB9KTsKICAgIH0KICAgIGlmIChlbnRyeS50aWNrQ29vcmQgIT0gbnVsbCkgewogICAgICB2YXIgaXNTaG93ID0gaXNWaXNpYmxlKHNpZ24yLCBlbnRyeS50aWNrQ29vcmQsIGdldFNpemUsIHN0YXJ0LCBlbmQpOwogICAgICBpZiAoaXNTaG93KSB7CiAgICAgICAgc3RhcnQgPSBlbnRyeS50aWNrQ29vcmQgKyBzaWduMiAqIChnZXRTaXplKCkgLyAyICsgbWluVGlja0dhcCk7CiAgICAgICAgcmVzdWx0W2kyXSA9IF9vYmplY3RTcHJlYWQyNyhfb2JqZWN0U3ByZWFkMjcoe30sIGVudHJ5KSwge30sIHsKICAgICAgICAgIGlzU2hvdzogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CiAgICB9CiAgfTsKICBmb3IgKHZhciBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgIF9sb29wMihpKTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiBnZXRUaWNrcyhwcm9wcywgZm9udFNpemUsIGxldHRlclNwYWNpbmcpIHsKICB2YXIgewogICAgdGljaywKICAgIHRpY2tzOiB0aWNrczIsCiAgICB2aWV3Qm94LAogICAgbWluVGlja0dhcCwKICAgIG9yaWVudGF0aW9uLAogICAgaW50ZXJ2YWwsCiAgICB0aWNrRm9ybWF0dGVyLAogICAgdW5pdDogdW5pdDIsCiAgICBhbmdsZQogIH0gPSBwcm9wczsKICBpZiAoIXRpY2tzMiB8fCAhdGlja3MyLmxlbmd0aCB8fCAhdGljaykgewogICAgcmV0dXJuIFtdOwogIH0KICBpZiAoaXNOdW1iZXIoaW50ZXJ2YWwpIHx8IEdsb2JhbC5pc1NzcikgewogICAgdmFyIF9nZXROdW1iZXJJbnRlcnZhbFRpYzsKICAgIHJldHVybiAoX2dldE51bWJlckludGVydmFsVGljID0gZ2V0TnVtYmVySW50ZXJ2YWxUaWNrcyh0aWNrczIsIGlzTnVtYmVyKGludGVydmFsKSA/IGludGVydmFsIDogMCkpICE9PSBudWxsICYmIF9nZXROdW1iZXJJbnRlcnZhbFRpYyAhPT0gdm9pZCAwID8gX2dldE51bWJlckludGVydmFsVGljIDogW107CiAgfQogIHZhciBjYW5kaWRhdGVzID0gW107CiAgdmFyIHNpemVLZXkgPSBvcmllbnRhdGlvbiA9PT0gInRvcCIgfHwgb3JpZW50YXRpb24gPT09ICJib3R0b20iID8gIndpZHRoIiA6ICJoZWlnaHQiOwogIHZhciB1bml0U2l6ZSA9IHVuaXQyICYmIHNpemVLZXkgPT09ICJ3aWR0aCIgPyBnZXRTdHJpbmdTaXplKHVuaXQyLCB7CiAgICBmb250U2l6ZSwKICAgIGxldHRlclNwYWNpbmcKICB9KSA6IHsKICAgIHdpZHRoOiAwLAogICAgaGVpZ2h0OiAwCiAgfTsKICB2YXIgZ2V0VGlja1NpemUgPSAoY29udGVudCwgaW5kZXgpID0+IHsKICAgIHZhciB2YWx1ZSA9IHR5cGVvZiB0aWNrRm9ybWF0dGVyID09PSAiZnVuY3Rpb24iID8gdGlja0Zvcm1hdHRlcihjb250ZW50LnZhbHVlLCBpbmRleCkgOiBjb250ZW50LnZhbHVlOwogICAgcmV0dXJuIHNpemVLZXkgPT09ICJ3aWR0aCIgPyBnZXRBbmdsZWRUaWNrV2lkdGgoZ2V0U3RyaW5nU2l6ZSh2YWx1ZSwgewogICAgICBmb250U2l6ZSwKICAgICAgbGV0dGVyU3BhY2luZwogICAgfSksIHVuaXRTaXplLCBhbmdsZSkgOiBnZXRTdHJpbmdTaXplKHZhbHVlLCB7CiAgICAgIGZvbnRTaXplLAogICAgICBsZXR0ZXJTcGFjaW5nCiAgICB9KVtzaXplS2V5XTsKICB9OwogIHZhciBzaWduMiA9IHRpY2tzMi5sZW5ndGggPj0gMiA/IG1hdGhTaWduKHRpY2tzMlsxXS5jb29yZGluYXRlIC0gdGlja3MyWzBdLmNvb3JkaW5hdGUpIDogMTsKICB2YXIgYm91bmRhcmllcyA9IGdldFRpY2tCb3VuZGFyaWVzKHZpZXdCb3gsIHNpZ24yLCBzaXplS2V5KTsKICBpZiAoaW50ZXJ2YWwgPT09ICJlcXVpZGlzdGFudFByZXNlcnZlU3RhcnQiKSB7CiAgICByZXR1cm4gZ2V0RXF1aWRpc3RhbnRUaWNrcyhzaWduMiwgYm91bmRhcmllcywgZ2V0VGlja1NpemUsIHRpY2tzMiwgbWluVGlja0dhcCk7CiAgfQogIGlmIChpbnRlcnZhbCA9PT0gInByZXNlcnZlU3RhcnQiIHx8IGludGVydmFsID09PSAicHJlc2VydmVTdGFydEVuZCIpIHsKICAgIGNhbmRpZGF0ZXMgPSBnZXRUaWNrc1N0YXJ0KHNpZ24yLCBib3VuZGFyaWVzLCBnZXRUaWNrU2l6ZSwgdGlja3MyLCBtaW5UaWNrR2FwLCBpbnRlcnZhbCA9PT0gInByZXNlcnZlU3RhcnRFbmQiKTsKICB9IGVsc2UgewogICAgY2FuZGlkYXRlcyA9IGdldFRpY2tzRW5kKHNpZ24yLCBib3VuZGFyaWVzLCBnZXRUaWNrU2l6ZSwgdGlja3MyLCBtaW5UaWNrR2FwKTsKICB9CiAgcmV0dXJuIGNhbmRpZGF0ZXMuZmlsdGVyKChlbnRyeSkgPT4gZW50cnkuaXNTaG93KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9ZQXhpc1V0aWxzLmpzCnZhciBnZXRDYWxjdWxhdGVkWUF4aXNXaWR0aCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICB0aWNrczogdGlja3MyLAogICAgbGFiZWwsCiAgICBsYWJlbEdhcFdpdGhUaWNrID0gNSwKICAgIC8vIERlZmF1bHQgZ2FwIGJldHdlZW4gbGFiZWwgYW5kIHRpY2sKICAgIHRpY2tTaXplID0gMCwKICAgIHRpY2tNYXJnaW4gPSAwCiAgfSA9IF9yZWYyOwogIHZhciBtYXhUaWNrV2lkdGggPSAwOwogIGlmICh0aWNrczIpIHsKICAgIEFycmF5LmZyb20odGlja3MyKS5mb3JFYWNoKCh0aWNrTm9kZSkgPT4gewogICAgICBpZiAodGlja05vZGUpIHsKICAgICAgICB2YXIgYmJveCA9IHRpY2tOb2RlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgIGlmIChiYm94LndpZHRoID4gbWF4VGlja1dpZHRoKSB7CiAgICAgICAgICBtYXhUaWNrV2lkdGggPSBiYm94LndpZHRoOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICB2YXIgbGFiZWxXaWR0aCA9IGxhYmVsID8gbGFiZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkud2lkdGggOiAwOwogICAgdmFyIHRpY2tXaWR0aCA9IHRpY2tTaXplICsgdGlja01hcmdpbjsKICAgIHZhciB1cGRhdGVkWUF4aXNXaWR0aCA9IG1heFRpY2tXaWR0aCArIHRpY2tXaWR0aCArIGxhYmVsV2lkdGggKyAobGFiZWwgPyBsYWJlbEdhcFdpdGhUaWNrIDogMCk7CiAgICByZXR1cm4gTWF0aC5yb3VuZCh1cGRhdGVkWUF4aXNXaWR0aCk7CiAgfQogIHJldHVybiAwOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL0NhcnRlc2lhbkF4aXMuanMKdmFyIF9leGNsdWRlZDEwID0gWyJheGlzTGluZSIsICJ3aWR0aCIsICJoZWlnaHQiLCAiY2xhc3NOYW1lIiwgImhpZGUiLCAidGlja3MiLCAiYXhpc1R5cGUiXTsKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTAoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTEwKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMChyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX2V4dGVuZHMxNSgpIHsKICByZXR1cm4gX2V4dGVuZHMxNSA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTUuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzMjgoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyOChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czI4KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkzMChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyOChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MzAoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkzMChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzMCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUzMCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUzMCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMgPSB7CiAgeDogMCwKICB5OiAwLAogIHdpZHRoOiAwLAogIGhlaWdodDogMCwKICB2aWV3Qm94OiB7CiAgICB4OiAwLAogICAgeTogMCwKICAgIHdpZHRoOiAwLAogICAgaGVpZ2h0OiAwCiAgfSwKICAvLyBUaGUgb3JpZW50YXRpb24gb2YgYXhpcwogIG9yaWVudGF0aW9uOiAiYm90dG9tIiwKICAvLyBUaGUgdGlja3MKICB0aWNrczogW10sCiAgc3Ryb2tlOiAiIzY2NiIsCiAgdGlja0xpbmU6IHRydWUsCiAgYXhpc0xpbmU6IHRydWUsCiAgdGljazogdHJ1ZSwKICBtaXJyb3I6IGZhbHNlLAogIG1pblRpY2tHYXA6IDUsCiAgLy8gVGhlIHdpZHRoIG9yIGhlaWdodCBvZiB0aWNrCiAgdGlja1NpemU6IDYsCiAgdGlja01hcmdpbjogMiwKICBpbnRlcnZhbDogInByZXNlcnZlRW5kIiwKICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5heGlzCn07CmZ1bmN0aW9uIEF4aXNMaW5lKGF4aXNMaW5lUHJvcHMpIHsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgb3JpZW50YXRpb24sCiAgICBtaXJyb3IsCiAgICBheGlzTGluZSwKICAgIG90aGVyU3ZnUHJvcHMKICB9ID0gYXhpc0xpbmVQcm9wczsKICBpZiAoIWF4aXNMaW5lKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHByb3BzID0gX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoe30sIG90aGVyU3ZnUHJvcHMpLCBzdmdQcm9wZXJ0aWVzTm9FdmVudHMoYXhpc0xpbmUpKSwge30sIHsKICAgIGZpbGw6ICJub25lIgogIH0pOwogIGlmIChvcmllbnRhdGlvbiA9PT0gInRvcCIgfHwgb3JpZW50YXRpb24gPT09ICJib3R0b20iKSB7CiAgICB2YXIgbmVlZEhlaWdodCA9ICsob3JpZW50YXRpb24gPT09ICJ0b3AiICYmICFtaXJyb3IgfHwgb3JpZW50YXRpb24gPT09ICJib3R0b20iICYmIG1pcnJvcik7CiAgICBwcm9wcyA9IF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoe30sIHByb3BzKSwge30sIHsKICAgICAgeDE6IHgyLAogICAgICB5MTogeTIgKyBuZWVkSGVpZ2h0ICogaGVpZ2h0LAogICAgICB4MjogeDIgKyB3aWR0aCwKICAgICAgeTI6IHkyICsgbmVlZEhlaWdodCAqIGhlaWdodAogICAgfSk7CiAgfSBlbHNlIHsKICAgIHZhciBuZWVkV2lkdGggPSArKG9yaWVudGF0aW9uID09PSAibGVmdCIgJiYgIW1pcnJvciB8fCBvcmllbnRhdGlvbiA9PT0gInJpZ2h0IiAmJiBtaXJyb3IpOwogICAgcHJvcHMgPSBfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KHt9LCBwcm9wcyksIHt9LCB7CiAgICAgIHgxOiB4MiArIG5lZWRXaWR0aCAqIHdpZHRoLAogICAgICB5MTogeTIsCiAgICAgIHgyOiB4MiArIG5lZWRXaWR0aCAqIHdpZHRoLAogICAgICB5MjogeTIgKyBoZWlnaHQKICAgIH0pOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudCgibGluZSIsIF9leHRlbmRzMTUoe30sIHByb3BzLCB7CiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLWxpbmUiLCAoMCwgaW1wb3J0X2dldDMuZGVmYXVsdCkoYXhpc0xpbmUsICJjbGFzc05hbWUiKSkKICB9KSk7Cn0KZnVuY3Rpb24gZ2V0VGlja0xpbmVDb29yZChkYXRhLCB4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIG9yaWVudGF0aW9uLCB0aWNrU2l6ZSwgbWlycm9yLCB0aWNrTWFyZ2luKSB7CiAgdmFyIHgxLCB4MjIsIHkxLCB5MjIsIHR4LCB0eTsKICB2YXIgc2lnbjIgPSBtaXJyb3IgPyAtMSA6IDE7CiAgdmFyIGZpbmFsVGlja1NpemUgPSBkYXRhLnRpY2tTaXplIHx8IHRpY2tTaXplOwogIHZhciB0aWNrQ29vcmQgPSBpc051bWJlcihkYXRhLnRpY2tDb29yZCkgPyBkYXRhLnRpY2tDb29yZCA6IGRhdGEuY29vcmRpbmF0ZTsKICBzd2l0Y2ggKG9yaWVudGF0aW9uKSB7CiAgICBjYXNlICJ0b3AiOgogICAgICB4MSA9IHgyMiA9IGRhdGEuY29vcmRpbmF0ZTsKICAgICAgeTIyID0geTIgKyArIW1pcnJvciAqIGhlaWdodDsKICAgICAgeTEgPSB5MjIgLSBzaWduMiAqIGZpbmFsVGlja1NpemU7CiAgICAgIHR5ID0geTEgLSBzaWduMiAqIHRpY2tNYXJnaW47CiAgICAgIHR4ID0gdGlja0Nvb3JkOwogICAgICBicmVhazsKICAgIGNhc2UgImxlZnQiOgogICAgICB5MSA9IHkyMiA9IGRhdGEuY29vcmRpbmF0ZTsKICAgICAgeDIyID0geDIgKyArIW1pcnJvciAqIHdpZHRoOwogICAgICB4MSA9IHgyMiAtIHNpZ24yICogZmluYWxUaWNrU2l6ZTsKICAgICAgdHggPSB4MSAtIHNpZ24yICogdGlja01hcmdpbjsKICAgICAgdHkgPSB0aWNrQ29vcmQ7CiAgICAgIGJyZWFrOwogICAgY2FzZSAicmlnaHQiOgogICAgICB5MSA9IHkyMiA9IGRhdGEuY29vcmRpbmF0ZTsKICAgICAgeDIyID0geDIgKyArbWlycm9yICogd2lkdGg7CiAgICAgIHgxID0geDIyICsgc2lnbjIgKiBmaW5hbFRpY2tTaXplOwogICAgICB0eCA9IHgxICsgc2lnbjIgKiB0aWNrTWFyZ2luOwogICAgICB0eSA9IHRpY2tDb29yZDsKICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICB4MSA9IHgyMiA9IGRhdGEuY29vcmRpbmF0ZTsKICAgICAgeTIyID0geTIgKyArbWlycm9yICogaGVpZ2h0OwogICAgICB5MSA9IHkyMiArIHNpZ24yICogZmluYWxUaWNrU2l6ZTsKICAgICAgdHkgPSB5MSArIHNpZ24yICogdGlja01hcmdpbjsKICAgICAgdHggPSB0aWNrQ29vcmQ7CiAgICAgIGJyZWFrOwogIH0KICByZXR1cm4gewogICAgbGluZTogewogICAgICB4MSwKICAgICAgeTEsCiAgICAgIHgyOiB4MjIsCiAgICAgIHkyOiB5MjIKICAgIH0sCiAgICB0aWNrOiB7CiAgICAgIHg6IHR4LAogICAgICB5OiB0eQogICAgfQogIH07Cn0KZnVuY3Rpb24gZ2V0VGlja1RleHRBbmNob3Iob3JpZW50YXRpb24sIG1pcnJvcikgewogIHN3aXRjaCAob3JpZW50YXRpb24pIHsKICAgIGNhc2UgImxlZnQiOgogICAgICByZXR1cm4gbWlycm9yID8gInN0YXJ0IiA6ICJlbmQiOwogICAgY2FzZSAicmlnaHQiOgogICAgICByZXR1cm4gbWlycm9yID8gImVuZCIgOiAic3RhcnQiOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuICJtaWRkbGUiOwogIH0KfQpmdW5jdGlvbiBnZXRUaWNrVmVydGljYWxBbmNob3Iob3JpZW50YXRpb24sIG1pcnJvcikgewogIHN3aXRjaCAob3JpZW50YXRpb24pIHsKICAgIGNhc2UgImxlZnQiOgogICAgY2FzZSAicmlnaHQiOgogICAgICByZXR1cm4gIm1pZGRsZSI7CiAgICBjYXNlICJ0b3AiOgogICAgICByZXR1cm4gbWlycm9yID8gInN0YXJ0IiA6ICJlbmQiOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIG1pcnJvciA/ICJlbmQiIDogInN0YXJ0IjsKICB9Cn0KZnVuY3Rpb24gVGlja0l0ZW0ocHJvcHMpIHsKICB2YXIgewogICAgb3B0aW9uLAogICAgdGlja1Byb3BzLAogICAgdmFsdWUKICB9ID0gcHJvcHM7CiAgdmFyIHRpY2tJdGVtOwogIHZhciBjb21iaW5lZENsYXNzTmFtZSA9IGNsc3godGlja1Byb3BzLmNsYXNzTmFtZSwgInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stdmFsdWUiKTsKICBpZiAoLyogQF9fUFVSRV9fICovIFJlYWN0MjQuaXNWYWxpZEVsZW1lbnQob3B0aW9uKSkgewogICAgdGlja0l0ZW0gPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jbG9uZUVsZW1lbnQob3B0aW9uLCBfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KHt9LCB0aWNrUHJvcHMpLCB7fSwgewogICAgICBjbGFzc05hbWU6IGNvbWJpbmVkQ2xhc3NOYW1lCiAgICB9KSk7CiAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICB0aWNrSXRlbSA9IG9wdGlvbihfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KHt9LCB0aWNrUHJvcHMpLCB7fSwgewogICAgICBjbGFzc05hbWU6IGNvbWJpbmVkQ2xhc3NOYW1lCiAgICB9KSk7CiAgfSBlbHNlIHsKICAgIHZhciBjbGFzc05hbWUgPSAicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljay12YWx1ZSI7CiAgICBpZiAodHlwZW9mIG9wdGlvbiAhPT0gImJvb2xlYW4iKSB7CiAgICAgIGNsYXNzTmFtZSA9IGNsc3goY2xhc3NOYW1lLCBvcHRpb24gPT09IG51bGwgfHwgb3B0aW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb24uY2xhc3NOYW1lKTsKICAgIH0KICAgIHRpY2tJdGVtID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChUZXh0LCBfZXh0ZW5kczE1KHt9LCB0aWNrUHJvcHMsIHsKICAgICAgY2xhc3NOYW1lCiAgICB9KSwgdmFsdWUpOwogIH0KICByZXR1cm4gdGlja0l0ZW07Cn0KdmFyIFRpY2tzID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzNy5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICB0aWNrczogdGlja3MyID0gW10sCiAgICB0aWNrLAogICAgdGlja0xpbmUsCiAgICBzdHJva2UsCiAgICB0aWNrRm9ybWF0dGVyLAogICAgdW5pdDogdW5pdDIsCiAgICBwYWRkaW5nLAogICAgdGlja1RleHRQcm9wcywKICAgIG9yaWVudGF0aW9uLAogICAgbWlycm9yLAogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgdGlja1NpemUsCiAgICB0aWNrTWFyZ2luLAogICAgZm9udFNpemUsCiAgICBsZXR0ZXJTcGFjaW5nLAogICAgZ2V0VGlja3NDb25maWcsCiAgICBldmVudHMsCiAgICBheGlzVHlwZQogIH0gPSBwcm9wczsKICB2YXIgZmluYWxUaWNrcyA9IGdldFRpY2tzKF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoe30sIGdldFRpY2tzQ29uZmlnKSwge30sIHsKICAgIHRpY2tzOiB0aWNrczIKICB9KSwgZm9udFNpemUsIGxldHRlclNwYWNpbmcpOwogIHZhciB0ZXh0QW5jaG9yID0gZ2V0VGlja1RleHRBbmNob3Iob3JpZW50YXRpb24sIG1pcnJvcik7CiAgdmFyIHZlcnRpY2FsQW5jaG9yID0gZ2V0VGlja1ZlcnRpY2FsQW5jaG9yKG9yaWVudGF0aW9uLCBtaXJyb3IpOwogIHZhciBheGlzUHJvcHMgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHMoZ2V0VGlja3NDb25maWcpOwogIHZhciBjdXN0b21UaWNrUHJvcHMgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHNGcm9tVW5rbm93bih0aWNrKTsKICB2YXIgdGlja0xpbmVQcm9wc09iamVjdCA9IHt9OwogIGlmICh0eXBlb2YgdGlja0xpbmUgPT09ICJvYmplY3QiKSB7CiAgICB0aWNrTGluZVByb3BzT2JqZWN0ID0gdGlja0xpbmU7CiAgfQogIHZhciB0aWNrTGluZVByb3BzID0gX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7fSwgYXhpc1Byb3BzKSwge30sIHsKICAgIGZpbGw6ICJub25lIgogIH0sIHRpY2tMaW5lUHJvcHNPYmplY3QpOwogIHZhciB0aWNrTGluZUNvb3JkcyA9IGZpbmFsVGlja3MubWFwKChlbnRyeSkgPT4gX29iamVjdFNwcmVhZDI4KHsKICAgIGVudHJ5CiAgfSwgZ2V0VGlja0xpbmVDb29yZChlbnRyeSwgeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCBvcmllbnRhdGlvbiwgdGlja1NpemUsIG1pcnJvciwgdGlja01hcmdpbikpKTsKICB2YXIgdGlja0xpbmVzID0gdGlja0xpbmVDb29yZHMubWFwKChfcmVmMikgPT4gewogICAgdmFyIHsKICAgICAgZW50cnksCiAgICAgIGxpbmU6IGxpbmVDb29yZAogICAgfSA9IF9yZWYyOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljayIsCiAgICAgIGtleTogInRpY2stIi5jb25jYXQoZW50cnkudmFsdWUsICItIikuY29uY2F0KGVudHJ5LmNvb3JkaW5hdGUsICItIikuY29uY2F0KGVudHJ5LnRpY2tDb29yZCkKICAgIH0sIHRpY2tMaW5lICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoImxpbmUiLCBfZXh0ZW5kczE1KHt9LCB0aWNrTGluZVByb3BzLCBsaW5lQ29vcmQsIHsKICAgICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLWxpbmUiLCAoMCwgaW1wb3J0X2dldDMuZGVmYXVsdCkodGlja0xpbmUsICJjbGFzc05hbWUiKSkKICAgIH0pKSk7CiAgfSk7CiAgdmFyIHRpY2tMYWJlbHMgPSB0aWNrTGluZUNvb3Jkcy5tYXAoKF9yZWYyLCBpKSA9PiB7CiAgICB2YXIgewogICAgICBlbnRyeSwKICAgICAgdGljazogdGlja0Nvb3JkCiAgICB9ID0gX3JlZjI7CiAgICB2YXIgdGlja1Byb3BzID0gX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KHsKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciB0ZXh0QW5jaG9yIGZyb20gYXhpc1Byb3BzIGlzIHR5cGVkIGFzIGBzdHJpbmdgIGJ1dCBUZXh0IHdhbnRzIHR5cGUgYFRleHRBbmNob3JgCiAgICAgIHRleHRBbmNob3IsCiAgICAgIHZlcnRpY2FsQW5jaG9yCiAgICB9LCBheGlzUHJvcHMpLCB7fSwgewogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGN1c3RvbVRpY2tQcm9wcyBpcyBjb250cmlidXRpbmcgdW5rbm93biBwcm9wcwogICAgICBzdHJva2U6ICJub25lIiwKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBjdXN0b21UaWNrUHJvcHMgaXMgY29udHJpYnV0aW5nIHVua25vd24gcHJvcHMKICAgICAgZmlsbDogc3Ryb2tlCiAgICB9LCBjdXN0b21UaWNrUHJvcHMpLCB0aWNrQ29vcmQpLCB7fSwgewogICAgICBpbmRleDogaSwKICAgICAgcGF5bG9hZDogZW50cnksCiAgICAgIHZpc2libGVUaWNrc0NvdW50OiBmaW5hbFRpY2tzLmxlbmd0aCwKICAgICAgdGlja0Zvcm1hdHRlciwKICAgICAgcGFkZGluZwogICAgfSwgdGlja1RleHRQcm9wcyk7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChMYXllciwgX2V4dGVuZHMxNSh7CiAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stbGFiZWwiLAogICAgICBrZXk6ICJ0aWNrLWxhYmVsLSIuY29uY2F0KGVudHJ5LnZhbHVlLCAiLSIpLmNvbmNhdChlbnRyeS5jb29yZGluYXRlLCAiLSIpLmNvbmNhdChlbnRyeS50aWNrQ29vcmQpCiAgICB9LCBhZGFwdEV2ZW50c09mQ2hpbGQoZXZlbnRzLCBlbnRyeSwgaSkpLCB0aWNrICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoVGlja0l0ZW0sIHsKICAgICAgb3B0aW9uOiB0aWNrLAogICAgICB0aWNrUHJvcHMsCiAgICAgIHZhbHVlOiAiIi5jb25jYXQodHlwZW9mIHRpY2tGb3JtYXR0ZXIgPT09ICJmdW5jdGlvbiIgPyB0aWNrRm9ybWF0dGVyKGVudHJ5LnZhbHVlLCBpKSA6IGVudHJ5LnZhbHVlKS5jb25jYXQodW5pdDIgfHwgIiIpCiAgICB9KSk7CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrcyByZWNoYXJ0cy0iLmNvbmNhdChheGlzVHlwZSwgIi10aWNrcyIpCiAgfSwgdGlja0xhYmVscy5sZW5ndGggPiAwICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmxhYmVsCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudCgiZyIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stbGFiZWxzIHJlY2hhcnRzLSIuY29uY2F0KGF4aXNUeXBlLCAiLXRpY2stbGFiZWxzIiksCiAgICByZWYKICB9LCB0aWNrTGFiZWxzKSksIHRpY2tMaW5lcy5sZW5ndGggPiAwICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLWxpbmVzIHJlY2hhcnRzLSIuY29uY2F0KGF4aXNUeXBlLCAiLXRpY2stbGluZXMiKQogIH0sIHRpY2tMaW5lcykpOwp9KTsKdmFyIENhcnRlc2lhbkF4aXNDb21wb25lbnQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDM3LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIGF4aXNMaW5lLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBjbGFzc05hbWUsCiAgICBoaWRlLAogICAgdGlja3M6IHRpY2tzMiwKICAgIGF4aXNUeXBlCiAgfSA9IHByb3BzLCByZXN0ID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTAocHJvcHMsIF9leGNsdWRlZDEwKTsKICB2YXIgW2ZvbnRTaXplLCBzZXRGb250U2l6ZV0gPSAoMCwgaW1wb3J0X3JlYWN0MzcudXNlU3RhdGUpKCIiKTsKICB2YXIgW2xldHRlclNwYWNpbmcsIHNldExldHRlclNwYWNpbmddID0gKDAsIGltcG9ydF9yZWFjdDM3LnVzZVN0YXRlKSgiIik7CiAgdmFyIHRpY2tSZWZzID0gKDAsIGltcG9ydF9yZWFjdDM3LnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDM3LnVzZUltcGVyYXRpdmVIYW5kbGUpKHJlZiwgKCkgPT4gKHsKICAgIGdldENhbGN1bGF0ZWRXaWR0aDogKCkgPT4gewogICAgICB2YXIgX3Byb3BzJGxhYmVsUmVmOwogICAgICByZXR1cm4gZ2V0Q2FsY3VsYXRlZFlBeGlzV2lkdGgoewogICAgICAgIHRpY2tzOiB0aWNrUmVmcy5jdXJyZW50LAogICAgICAgIGxhYmVsOiAoX3Byb3BzJGxhYmVsUmVmID0gcHJvcHMubGFiZWxSZWYpID09PSBudWxsIHx8IF9wcm9wcyRsYWJlbFJlZiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3Byb3BzJGxhYmVsUmVmLmN1cnJlbnQsCiAgICAgICAgbGFiZWxHYXBXaXRoVGljazogNSwKICAgICAgICB0aWNrU2l6ZTogcHJvcHMudGlja1NpemUsCiAgICAgICAgdGlja01hcmdpbjogcHJvcHMudGlja01hcmdpbgogICAgICB9KTsKICAgIH0KICB9KSk7CiAgdmFyIGxheWVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDM3LnVzZUNhbGxiYWNrKSgoZWwpID0+IHsKICAgIGlmIChlbCkgewogICAgICB2YXIgdGlja05vZGVzID0gZWwuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljay12YWx1ZSIpOwogICAgICB0aWNrUmVmcy5jdXJyZW50ID0gdGlja05vZGVzOwogICAgICB2YXIgdGljayA9IHRpY2tOb2Rlc1swXTsKICAgICAgaWYgKHRpY2spIHsKICAgICAgICB2YXIgY29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKHRpY2spOwogICAgICAgIHZhciBjYWxjdWxhdGVkRm9udFNpemUgPSBjb21wdXRlZFN0eWxlLmZvbnRTaXplOwogICAgICAgIHZhciBjYWxjdWxhdGVkTGV0dGVyU3BhY2luZyA9IGNvbXB1dGVkU3R5bGUubGV0dGVyU3BhY2luZzsKICAgICAgICBpZiAoY2FsY3VsYXRlZEZvbnRTaXplICE9PSBmb250U2l6ZSB8fCBjYWxjdWxhdGVkTGV0dGVyU3BhY2luZyAhPT0gbGV0dGVyU3BhY2luZykgewogICAgICAgICAgc2V0Rm9udFNpemUoY2FsY3VsYXRlZEZvbnRTaXplKTsKICAgICAgICAgIHNldExldHRlclNwYWNpbmcoY2FsY3VsYXRlZExldHRlclNwYWNpbmcpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0sIFtmb250U2l6ZSwgbGV0dGVyU3BhY2luZ10pOwogIGlmIChoaWRlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKHdpZHRoICE9IG51bGwgJiYgd2lkdGggPD0gMCB8fCBoZWlnaHQgIT0gbnVsbCAmJiBoZWlnaHQgPD0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IHByb3BzLnpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtY2FydGVzaWFuLWF4aXMiLCBjbGFzc05hbWUpCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChBeGlzTGluZSwgewogICAgeDogcHJvcHMueCwKICAgIHk6IHByb3BzLnksCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIG9yaWVudGF0aW9uOiBwcm9wcy5vcmllbnRhdGlvbiwKICAgIG1pcnJvcjogcHJvcHMubWlycm9yLAogICAgYXhpc0xpbmUsCiAgICBvdGhlclN2Z1Byb3BzOiBzdmdQcm9wZXJ0aWVzTm9FdmVudHMocHJvcHMpCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoVGlja3MsIHsKICAgIHJlZjogbGF5ZXJSZWYsCiAgICBheGlzVHlwZSwKICAgIGV2ZW50czogcmVzdCwKICAgIGZvbnRTaXplLAogICAgZ2V0VGlja3NDb25maWc6IHByb3BzLAogICAgaGVpZ2h0OiBwcm9wcy5oZWlnaHQsCiAgICBsZXR0ZXJTcGFjaW5nLAogICAgbWlycm9yOiBwcm9wcy5taXJyb3IsCiAgICBvcmllbnRhdGlvbjogcHJvcHMub3JpZW50YXRpb24sCiAgICBwYWRkaW5nOiBwcm9wcy5wYWRkaW5nLAogICAgc3Ryb2tlOiBwcm9wcy5zdHJva2UsCiAgICB0aWNrOiBwcm9wcy50aWNrLAogICAgdGlja0Zvcm1hdHRlcjogcHJvcHMudGlja0Zvcm1hdHRlciwKICAgIHRpY2tMaW5lOiBwcm9wcy50aWNrTGluZSwKICAgIHRpY2tNYXJnaW46IHByb3BzLnRpY2tNYXJnaW4sCiAgICB0aWNrU2l6ZTogcHJvcHMudGlja1NpemUsCiAgICB0aWNrVGV4dFByb3BzOiBwcm9wcy50aWNrVGV4dFByb3BzLAogICAgdGlja3M6IHRpY2tzMiwKICAgIHVuaXQ6IHByb3BzLnVuaXQsCiAgICB3aWR0aDogcHJvcHMud2lkdGgsCiAgICB4OiBwcm9wcy54LAogICAgeTogcHJvcHMueQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkxhYmVsQ29udGV4dFByb3ZpZGVyLCB7CiAgICB4OiBwcm9wcy54LAogICAgeTogcHJvcHMueSwKICAgIHdpZHRoOiBwcm9wcy53aWR0aCwKICAgIGhlaWdodDogcHJvcHMuaGVpZ2h0LAogICAgbG93ZXJXaWR0aDogcHJvcHMud2lkdGgsCiAgICB1cHBlcldpZHRoOiBwcm9wcy53aWR0aAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuTGFiZWxGcm9tTGFiZWxQcm9wLCB7CiAgICBsYWJlbDogcHJvcHMubGFiZWwsCiAgICBsYWJlbFJlZjogcHJvcHMubGFiZWxSZWYKICB9KSwgcHJvcHMuY2hpbGRyZW4pKSk7Cn0pOwp2YXIgQ2FydGVzaWFuQXhpcyA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmZvcndhcmRSZWYoKG91dHNpZGVQcm9wcywgcmVmKSA9PiB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkF4aXNDb21wb25lbnQsIF9leHRlbmRzMTUoe30sIHByb3BzLCB7CiAgICByZWYKICB9KSk7Cn0pOwpDYXJ0ZXNpYW5BeGlzLmRpc3BsYXlOYW1lID0gIkNhcnRlc2lhbkF4aXMiOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL0NhcnRlc2lhbkdyaWQuanMKdmFyIFJlYWN0MjUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQxMSA9IFsieDEiLCAieTEiLCAieDIiLCAieTIiLCAia2V5Il07CnZhciBfZXhjbHVkZWQyNSA9IFsib2Zmc2V0Il07CnZhciBfZXhjbHVkZWQzMiA9IFsieEF4aXNJZCIsICJ5QXhpc0lkIl07CnZhciBfZXhjbHVkZWQ0MiA9IFsieEF4aXNJZCIsICJ5QXhpc0lkIl07CmZ1bmN0aW9uIG93bktleXMyOShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI5KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjkoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTMxKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI5KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzMShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTMxKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTMxKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTMxKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTMxKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfZXh0ZW5kczE2KCkgewogIHJldHVybiBfZXh0ZW5kczE2ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxNi5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMShlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTEocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBCYWNrZ3JvdW5kID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIGZpbGwKICB9ID0gcHJvcHM7CiAgaWYgKCFmaWxsIHx8IGZpbGwgPT09ICJub25lIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBmaWxsT3BhY2l0eSwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHJ5CiAgfSA9IHByb3BzOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHJ5LAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBzdHJva2U6ICJub25lIiwKICAgIGZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1ncmlkLWJnIgogIH0pOwp9OwpmdW5jdGlvbiBMaW5lSXRlbShfcmVmMikgewogIHZhciB7CiAgICBvcHRpb24sCiAgICBsaW5lSXRlbVByb3BzCiAgfSA9IF9yZWYyOwogIHZhciBsaW5lSXRlbTsKICBpZiAoLyogQF9fUFVSRV9fICovIFJlYWN0MjUuaXNWYWxpZEVsZW1lbnQob3B0aW9uKSkgewogICAgbGluZUl0ZW0gPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jbG9uZUVsZW1lbnQob3B0aW9uLCBsaW5lSXRlbVByb3BzKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgIGxpbmVJdGVtID0gb3B0aW9uKGxpbmVJdGVtUHJvcHMpOwogIH0gZWxzZSB7CiAgICB2YXIgX3N2Z1Byb3BlcnRpZXNOb0V2ZW50OwogICAgdmFyIHsKICAgICAgeDEsCiAgICAgIHkxLAogICAgICB4MiwKICAgICAgeTIsCiAgICAgIGtleQogICAgfSA9IGxpbmVJdGVtUHJvcHMsIG90aGVycyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKGxpbmVJdGVtUHJvcHMsIF9leGNsdWRlZDExKTsKICAgIHZhciBfcmVmMjIgPSAoX3N2Z1Byb3BlcnRpZXNOb0V2ZW50ID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKG90aGVycykpICE9PSBudWxsICYmIF9zdmdQcm9wZXJ0aWVzTm9FdmVudCAhPT0gdm9pZCAwID8gX3N2Z1Byb3BlcnRpZXNOb0V2ZW50IDoge30sIHsKICAgICAgb2Zmc2V0OiBfXwogICAgfSA9IF9yZWYyMiwgcmVzdE9mRmlsdGVyZWRQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKF9yZWYyMiwgX2V4Y2x1ZGVkMjUpOwogICAgbGluZUl0ZW0gPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJsaW5lIiwgX2V4dGVuZHMxNih7fSwgcmVzdE9mRmlsdGVyZWRQcm9wcywgewogICAgICB4MSwKICAgICAgeTEsCiAgICAgIHgyLAogICAgICB5MiwKICAgICAgZmlsbDogIm5vbmUiLAogICAgICBrZXkKICAgIH0pKTsKICB9CiAgcmV0dXJuIGxpbmVJdGVtOwp9CmZ1bmN0aW9uIEhvcml6b250YWxHcmlkTGluZXMocHJvcHMpIHsKICB2YXIgewogICAgeDogeDIsCiAgICB3aWR0aCwKICAgIGhvcml6b250YWwgPSB0cnVlLAogICAgaG9yaXpvbnRhbFBvaW50cwogIH0gPSBwcm9wczsKICBpZiAoIWhvcml6b250YWwgfHwgIWhvcml6b250YWxQb2ludHMgfHwgIWhvcml6b250YWxQb2ludHMubGVuZ3RoKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIHhBeGlzSWQsCiAgICB5QXhpc0lkCiAgfSA9IHByb3BzLCBvdGhlckxpbmVJdGVtUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMShwcm9wcywgX2V4Y2x1ZGVkMzIpOwogIHZhciBpdGVtcyA9IGhvcml6b250YWxQb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIGxpbmVJdGVtUHJvcHMgPSBfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KHt9LCBvdGhlckxpbmVJdGVtUHJvcHMpLCB7fSwgewogICAgICB4MTogeDIsCiAgICAgIHkxOiBlbnRyeSwKICAgICAgeDI6IHgyICsgd2lkdGgsCiAgICAgIHkyOiBlbnRyeSwKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKSwKICAgICAgaW5kZXg6IGkKICAgIH0pOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoTGluZUl0ZW0sIHsKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKSwKICAgICAgb3B0aW9uOiBob3Jpem9udGFsLAogICAgICBsaW5lSXRlbVByb3BzCiAgICB9KTsKICB9KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudCgiZyIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1ncmlkLWhvcml6b250YWwiCiAgfSwgaXRlbXMpOwp9CmZ1bmN0aW9uIFZlcnRpY2FsR3JpZExpbmVzKHByb3BzKSB7CiAgdmFyIHsKICAgIHk6IHkyLAogICAgaGVpZ2h0LAogICAgdmVydGljYWwgPSB0cnVlLAogICAgdmVydGljYWxQb2ludHMKICB9ID0gcHJvcHM7CiAgaWYgKCF2ZXJ0aWNhbCB8fCAhdmVydGljYWxQb2ludHMgfHwgIXZlcnRpY2FsUG9pbnRzLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICB4QXhpc0lkLAogICAgeUF4aXNJZAogIH0gPSBwcm9wcywgb3RoZXJMaW5lSXRlbVByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTEocHJvcHMsIF9leGNsdWRlZDQyKTsKICB2YXIgaXRlbXMgPSB2ZXJ0aWNhbFBvaW50cy5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICB2YXIgbGluZUl0ZW1Qcm9wcyA9IF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIG90aGVyTGluZUl0ZW1Qcm9wcyksIHt9LCB7CiAgICAgIHgxOiBlbnRyeSwKICAgICAgeTE6IHkyLAogICAgICB4MjogZW50cnksCiAgICAgIHkyOiB5MiArIGhlaWdodCwKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKSwKICAgICAgaW5kZXg6IGkKICAgIH0pOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoTGluZUl0ZW0sIHsKICAgICAgb3B0aW9uOiB2ZXJ0aWNhbCwKICAgICAgbGluZUl0ZW1Qcm9wcywKICAgICAga2V5OiAibGluZS0iLmNvbmNhdChpKQogICAgfSk7CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC12ZXJ0aWNhbCIKICB9LCBpdGVtcyk7Cn0KZnVuY3Rpb24gSG9yaXpvbnRhbFN0cmlwZXMocHJvcHMpIHsKICB2YXIgewogICAgaG9yaXpvbnRhbEZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGhvcml6b250YWxQb2ludHMsCiAgICBob3Jpem9udGFsID0gdHJ1ZQogIH0gPSBwcm9wczsKICBpZiAoIWhvcml6b250YWwgfHwgIWhvcml6b250YWxGaWxsIHx8ICFob3Jpem9udGFsRmlsbC5sZW5ndGggfHwgaG9yaXpvbnRhbFBvaW50cyA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHJvdW5kZWRTb3J0ZWRIb3Jpem9udGFsUG9pbnRzID0gaG9yaXpvbnRhbFBvaW50cy5tYXAoKGUpID0+IE1hdGgucm91bmQoZSArIHkyIC0geTIpKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7CiAgaWYgKHkyICE9PSByb3VuZGVkU29ydGVkSG9yaXpvbnRhbFBvaW50c1swXSkgewogICAgcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHMudW5zaGlmdCgwKTsKICB9CiAgdmFyIGl0ZW1zID0gcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIGxhc3RTdHJpcGUgPSAhcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHNbaSArIDFdOwogICAgdmFyIGxpbmVIZWlnaHQgPSBsYXN0U3RyaXBlID8geTIgKyBoZWlnaHQgLSBlbnRyeSA6IHJvdW5kZWRTb3J0ZWRIb3Jpem9udGFsUG9pbnRzW2kgKyAxXSAtIGVudHJ5OwogICAgaWYgKGxpbmVIZWlnaHQgPD0gMCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHZhciBjb2xvckluZGV4ID0gaSAlIGhvcml6b250YWxGaWxsLmxlbmd0aDsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgICBrZXk6ICJyZWFjdC0iLmNvbmNhdChpKSwKICAgICAgeTogZW50cnksCiAgICAgIHg6IHgyLAogICAgICBoZWlnaHQ6IGxpbmVIZWlnaHQsCiAgICAgIHdpZHRoLAogICAgICBzdHJva2U6ICJub25lIiwKICAgICAgZmlsbDogaG9yaXpvbnRhbEZpbGxbY29sb3JJbmRleF0sCiAgICAgIGZpbGxPcGFjaXR5LAogICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC1iZyIKICAgIH0pOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWRzdHJpcGVzLWhvcml6b250YWwiCiAgfSwgaXRlbXMpOwp9CmZ1bmN0aW9uIFZlcnRpY2FsU3RyaXBlcyhwcm9wcykgewogIHZhciB7CiAgICB2ZXJ0aWNhbCA9IHRydWUsCiAgICB2ZXJ0aWNhbEZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHZlcnRpY2FsUG9pbnRzCiAgfSA9IHByb3BzOwogIGlmICghdmVydGljYWwgfHwgIXZlcnRpY2FsRmlsbCB8fCAhdmVydGljYWxGaWxsLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHMgPSB2ZXJ0aWNhbFBvaW50cy5tYXAoKGUpID0+IE1hdGgucm91bmQoZSArIHgyIC0geDIpKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7CiAgaWYgKHgyICE9PSByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHNbMF0pIHsKICAgIHJvdW5kZWRTb3J0ZWRWZXJ0aWNhbFBvaW50cy51bnNoaWZ0KDApOwogIH0KICB2YXIgaXRlbXMgPSByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIGxhc3RTdHJpcGUgPSAhcm91bmRlZFNvcnRlZFZlcnRpY2FsUG9pbnRzW2kgKyAxXTsKICAgIHZhciBsaW5lV2lkdGggPSBsYXN0U3RyaXBlID8geDIgKyB3aWR0aCAtIGVudHJ5IDogcm91bmRlZFNvcnRlZFZlcnRpY2FsUG9pbnRzW2kgKyAxXSAtIGVudHJ5OwogICAgaWYgKGxpbmVXaWR0aCA8PSAwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdmFyIGNvbG9ySW5kZXggPSBpICUgdmVydGljYWxGaWxsLmxlbmd0aDsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgICBrZXk6ICJyZWFjdC0iLmNvbmNhdChpKSwKICAgICAgeDogZW50cnksCiAgICAgIHk6IHkyLAogICAgICB3aWR0aDogbGluZVdpZHRoLAogICAgICBoZWlnaHQsCiAgICAgIHN0cm9rZTogIm5vbmUiLAogICAgICBmaWxsOiB2ZXJ0aWNhbEZpbGxbY29sb3JJbmRleF0sCiAgICAgIGZpbGxPcGFjaXR5LAogICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC1iZyIKICAgIH0pOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWRzdHJpcGVzLXZlcnRpY2FsIgogIH0sIGl0ZW1zKTsKfQp2YXIgZGVmYXVsdFZlcnRpY2FsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgPSAoX3JlZjMsIHN5bmNXaXRoVGlja3MpID0+IHsKICB2YXIgewogICAgeEF4aXMsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIG9mZnNldAogIH0gPSBfcmVmMzsKICByZXR1cm4gZ2V0Q29vcmRpbmF0ZXNPZkdyaWQoZ2V0VGlja3MoX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMpLCB4QXhpcyksIHt9LCB7CiAgICB0aWNrczogZ2V0VGlja3NPZkF4aXMoeEF4aXMsIHRydWUpLAogICAgdmlld0JveDogewogICAgICB4OiAwLAogICAgICB5OiAwLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9CiAgfSkpLCBvZmZzZXQubGVmdCwgb2Zmc2V0LmxlZnQgKyBvZmZzZXQud2lkdGgsIHN5bmNXaXRoVGlja3MpOwp9Owp2YXIgZGVmYXVsdEhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvciA9IChfcmVmNCwgc3luY1dpdGhUaWNrcykgPT4gewogIHZhciB7CiAgICB5QXhpcywKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgb2Zmc2V0CiAgfSA9IF9yZWY0OwogIHJldHVybiBnZXRDb29yZGluYXRlc09mR3JpZChnZXRUaWNrcyhfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOSh7fSwgZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcyksIHlBeGlzKSwge30sIHsKICAgIHRpY2tzOiBnZXRUaWNrc09mQXhpcyh5QXhpcywgdHJ1ZSksCiAgICB2aWV3Qm94OiB7CiAgICAgIHg6IDAsCiAgICAgIHk6IDAsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0KICB9KSksIG9mZnNldC50b3AsIG9mZnNldC50b3AgKyBvZmZzZXQuaGVpZ2h0LCBzeW5jV2l0aFRpY2tzKTsKfTsKdmFyIGRlZmF1bHRDYXJ0ZXNpYW5HcmlkUHJvcHMgPSB7CiAgaG9yaXpvbnRhbDogdHJ1ZSwKICB2ZXJ0aWNhbDogdHJ1ZSwKICAvLyBUaGUgb3JkaW5hdGVzIG9mIGhvcml6b250YWwgZ3JpZCBsaW5lcwogIGhvcml6b250YWxQb2ludHM6IFtdLAogIC8vIFRoZSBhYnNjaXNzYXMgb2YgdmVydGljYWwgZ3JpZCBsaW5lcwogIHZlcnRpY2FsUG9pbnRzOiBbXSwKICBzdHJva2U6ICIjY2NjIiwKICBmaWxsOiAibm9uZSIsCiAgLy8gVGhlIGZpbGwgb2YgY29sb3JzIG9mIGdyaWQgbGluZXMKICB2ZXJ0aWNhbEZpbGw6IFtdLAogIGhvcml6b250YWxGaWxsOiBbXSwKICB4QXhpc0lkOiAwLAogIHlBeGlzSWQ6IDAsCiAgc3luY1dpdGhUaWNrczogZmFsc2UsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMuZ3JpZAp9OwpmdW5jdGlvbiBDYXJ0ZXNpYW5HcmlkKHByb3BzKSB7CiAgdmFyIGNoYXJ0V2lkdGggPSB1c2VDaGFydFdpZHRoKCk7CiAgdmFyIGNoYXJ0SGVpZ2h0ID0gdXNlQ2hhcnRIZWlnaHQoKTsKICB2YXIgb2Zmc2V0ID0gdXNlT2Zmc2V0SW50ZXJuYWwoKTsKICB2YXIgcHJvcHNJbmNsdWRpbmdEZWZhdWx0cyA9IF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIHJlc29sdmVEZWZhdWx0UHJvcHMocHJvcHMsIGRlZmF1bHRDYXJ0ZXNpYW5HcmlkUHJvcHMpKSwge30sIHsKICAgIHg6IGlzTnVtYmVyKHByb3BzLngpID8gcHJvcHMueCA6IG9mZnNldC5sZWZ0LAogICAgeTogaXNOdW1iZXIocHJvcHMueSkgPyBwcm9wcy55IDogb2Zmc2V0LnRvcCwKICAgIHdpZHRoOiBpc051bWJlcihwcm9wcy53aWR0aCkgPyBwcm9wcy53aWR0aCA6IG9mZnNldC53aWR0aCwKICAgIGhlaWdodDogaXNOdW1iZXIocHJvcHMuaGVpZ2h0KSA/IHByb3BzLmhlaWdodCA6IG9mZnNldC5oZWlnaHQKICB9KTsKICB2YXIgewogICAgeEF4aXNJZCwKICAgIHlBeGlzSWQsCiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBzeW5jV2l0aFRpY2tzLAogICAgaG9yaXpvbnRhbFZhbHVlcywKICAgIHZlcnRpY2FsVmFsdWVzCiAgfSA9IHByb3BzSW5jbHVkaW5nRGVmYXVsdHM7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHhBeGlzID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBeGlzUHJvcHNOZWVkZWRGb3JDYXJ0ZXNpYW5HcmlkVGlja3NHZW5lcmF0b3Ioc3RhdGUsICJ4QXhpcyIsIHhBeGlzSWQsIGlzUGFub3JhbWEpKTsKICB2YXIgeUF4aXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEF4aXNQcm9wc05lZWRlZEZvckNhcnRlc2lhbkdyaWRUaWNrc0dlbmVyYXRvcihzdGF0ZSwgInlBeGlzIiwgeUF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIGlmICghaXNQb3NpdGl2ZU51bWJlcih3aWR0aCkgfHwgIWlzUG9zaXRpdmVOdW1iZXIoaGVpZ2h0KSB8fCAhaXNOdW1iZXIoeDIpIHx8ICFpc051bWJlcih5MikpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgdmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvciA9IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMudmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvciB8fCBkZWZhdWx0VmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvcjsKICB2YXIgaG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yID0gcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy5ob3Jpem9udGFsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgfHwgZGVmYXVsdEhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvcjsKICB2YXIgewogICAgaG9yaXpvbnRhbFBvaW50cywKICAgIHZlcnRpY2FsUG9pbnRzCiAgfSA9IHByb3BzSW5jbHVkaW5nRGVmYXVsdHM7CiAgaWYgKCghaG9yaXpvbnRhbFBvaW50cyB8fCAhaG9yaXpvbnRhbFBvaW50cy5sZW5ndGgpICYmIHR5cGVvZiBob3Jpem9udGFsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgIHZhciBpc0hvcml6b250YWxWYWx1ZXMgPSBob3Jpem9udGFsVmFsdWVzICYmIGhvcml6b250YWxWYWx1ZXMubGVuZ3RoOwogICAgdmFyIGdlbmVyYXRvclJlc3VsdCA9IGhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvcih7CiAgICAgIHlBeGlzOiB5QXhpcyA/IF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIHlBeGlzKSwge30sIHsKICAgICAgICB0aWNrczogaXNIb3Jpem9udGFsVmFsdWVzID8gaG9yaXpvbnRhbFZhbHVlcyA6IHlBeGlzLnRpY2tzCiAgICAgIH0pIDogdm9pZCAwLAogICAgICB3aWR0aDogY2hhcnRXaWR0aCAhPT0gbnVsbCAmJiBjaGFydFdpZHRoICE9PSB2b2lkIDAgPyBjaGFydFdpZHRoIDogd2lkdGgsCiAgICAgIGhlaWdodDogY2hhcnRIZWlnaHQgIT09IG51bGwgJiYgY2hhcnRIZWlnaHQgIT09IHZvaWQgMCA/IGNoYXJ0SGVpZ2h0IDogaGVpZ2h0LAogICAgICBvZmZzZXQKICAgIH0sIGlzSG9yaXpvbnRhbFZhbHVlcyA/IHRydWUgOiBzeW5jV2l0aFRpY2tzKTsKICAgIHdhcm4oQXJyYXkuaXNBcnJheShnZW5lcmF0b3JSZXN1bHQpLCAiaG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yIHNob3VsZCByZXR1cm4gQXJyYXkgYnV0IGluc3RlYWQgaXQgcmV0dXJuZWQgWyIuY29uY2F0KHR5cGVvZiBnZW5lcmF0b3JSZXN1bHQsICJdIikpOwogICAgaWYgKEFycmF5LmlzQXJyYXkoZ2VuZXJhdG9yUmVzdWx0KSkgewogICAgICBob3Jpem9udGFsUG9pbnRzID0gZ2VuZXJhdG9yUmVzdWx0OwogICAgfQogIH0KICBpZiAoKCF2ZXJ0aWNhbFBvaW50cyB8fCAhdmVydGljYWxQb2ludHMubGVuZ3RoKSAmJiB0eXBlb2YgdmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgdmFyIGlzVmVydGljYWxWYWx1ZXMgPSB2ZXJ0aWNhbFZhbHVlcyAmJiB2ZXJ0aWNhbFZhbHVlcy5sZW5ndGg7CiAgICB2YXIgX2dlbmVyYXRvclJlc3VsdCA9IHZlcnRpY2FsQ29vcmRpbmF0ZXNHZW5lcmF0b3IoewogICAgICB4QXhpczogeEF4aXMgPyBfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KHt9LCB4QXhpcyksIHt9LCB7CiAgICAgICAgdGlja3M6IGlzVmVydGljYWxWYWx1ZXMgPyB2ZXJ0aWNhbFZhbHVlcyA6IHhBeGlzLnRpY2tzCiAgICAgIH0pIDogdm9pZCAwLAogICAgICB3aWR0aDogY2hhcnRXaWR0aCAhPT0gbnVsbCAmJiBjaGFydFdpZHRoICE9PSB2b2lkIDAgPyBjaGFydFdpZHRoIDogd2lkdGgsCiAgICAgIGhlaWdodDogY2hhcnRIZWlnaHQgIT09IG51bGwgJiYgY2hhcnRIZWlnaHQgIT09IHZvaWQgMCA/IGNoYXJ0SGVpZ2h0IDogaGVpZ2h0LAogICAgICBvZmZzZXQKICAgIH0sIGlzVmVydGljYWxWYWx1ZXMgPyB0cnVlIDogc3luY1dpdGhUaWNrcyk7CiAgICB3YXJuKEFycmF5LmlzQXJyYXkoX2dlbmVyYXRvclJlc3VsdCksICJ2ZXJ0aWNhbENvb3JkaW5hdGVzR2VuZXJhdG9yIHNob3VsZCByZXR1cm4gQXJyYXkgYnV0IGluc3RlYWQgaXQgcmV0dXJuZWQgWyIuY29uY2F0KHR5cGVvZiBfZ2VuZXJhdG9yUmVzdWx0LCAiXSIpKTsKICAgIGlmIChBcnJheS5pc0FycmF5KF9nZW5lcmF0b3JSZXN1bHQpKSB7CiAgICAgIHZlcnRpY2FsUG9pbnRzID0gX2dlbmVyYXRvclJlc3VsdDsKICAgIH0KICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleDogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy56SW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWQiCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChCYWNrZ3JvdW5kLCB7CiAgICBmaWxsOiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLmZpbGwsCiAgICBmaWxsT3BhY2l0eTogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy5maWxsT3BhY2l0eSwKICAgIHg6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMueCwKICAgIHk6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMueSwKICAgIHdpZHRoOiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLndpZHRoLAogICAgaGVpZ2h0OiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLmhlaWdodCwKICAgIHJ5OiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLnJ5CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoSG9yaXpvbnRhbFN0cmlwZXMsIF9leHRlbmRzMTYoe30sIHByb3BzSW5jbHVkaW5nRGVmYXVsdHMsIHsKICAgIGhvcml6b250YWxQb2ludHMKICB9KSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoVmVydGljYWxTdHJpcGVzLCBfZXh0ZW5kczE2KHt9LCBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLCB7CiAgICB2ZXJ0aWNhbFBvaW50cwogIH0pKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChIb3Jpem9udGFsR3JpZExpbmVzLCBfZXh0ZW5kczE2KHt9LCBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLCB7CiAgICBvZmZzZXQsCiAgICBob3Jpem9udGFsUG9pbnRzLAogICAgeEF4aXMsCiAgICB5QXhpcwogIH0pKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChWZXJ0aWNhbEdyaWRMaW5lcywgX2V4dGVuZHMxNih7fSwgcHJvcHNJbmNsdWRpbmdEZWZhdWx0cywgewogICAgb2Zmc2V0LAogICAgdmVydGljYWxQb2ludHMsCiAgICB4QXhpcywKICAgIHlBeGlzCiAgfSkpKSk7Cn0KQ2FydGVzaWFuR3JpZC5kaXNwbGF5TmFtZSA9ICJDYXJ0ZXNpYW5HcmlkIjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZ2V0UmFkaXVzQW5kU3Ryb2tlV2lkdGhGcm9tRG90LmpzCmZ1bmN0aW9uIGdldFJhZGl1c0FuZFN0cm9rZVdpZHRoRnJvbURvdChkb3QpIHsKICB2YXIgcHJvcHMgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHNGcm9tVW5rbm93bihkb3QpOwogIHZhciBkZWZhdWx0UiA9IDM7CiAgdmFyIGRlZmF1bHRTdHJva2VXaWR0aCA9IDI7CiAgaWYgKHByb3BzICE9IG51bGwpIHsKICAgIHZhciB7CiAgICAgIHI6IHIyLAogICAgICBzdHJva2VXaWR0aAogICAgfSA9IHByb3BzOwogICAgdmFyIHJlYWxSID0gTnVtYmVyKHIyKTsKICAgIHZhciByZWFsU3Ryb2tlV2lkdGggPSBOdW1iZXIoc3Ryb2tlV2lkdGgpOwogICAgaWYgKE51bWJlci5pc05hTihyZWFsUikgfHwgcmVhbFIgPCAwKSB7CiAgICAgIHJlYWxSID0gZGVmYXVsdFI7CiAgICB9CiAgICBpZiAoTnVtYmVyLmlzTmFOKHJlYWxTdHJva2VXaWR0aCkgfHwgcmVhbFN0cm9rZVdpZHRoIDwgMCkgewogICAgICByZWFsU3Ryb2tlV2lkdGggPSBkZWZhdWx0U3Ryb2tlV2lkdGg7CiAgICB9CiAgICByZXR1cm4gewogICAgICByOiByZWFsUiwKICAgICAgc3Ryb2tlV2lkdGg6IHJlYWxTdHJva2VXaWR0aAogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIHI6IGRlZmF1bHRSLAogICAgc3Ryb2tlV2lkdGg6IGRlZmF1bHRTdHJva2VXaWR0aAogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9BcmVhLmpzCnZhciBSZWFjdDI2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MzggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvYXJlYVNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0WEF4aXNXaXRoU2NhbGUgPSAoc3RhdGUsIHhBeGlzSWQsIF95QXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBzZWxlY3RBeGlzV2l0aFNjYWxlKHN0YXRlLCAieEF4aXMiLCB4QXhpc0lkLCBpc1Bhbm9yYW1hKTsKdmFyIHNlbGVjdFhBeGlzVGlja3MgPSAoc3RhdGUsIHhBeGlzSWQsIF95QXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBzZWxlY3RUaWNrc09mR3JhcGhpY2FsSXRlbShzdGF0ZSwgInhBeGlzIiwgeEF4aXNJZCwgaXNQYW5vcmFtYSk7CnZhciBzZWxlY3RZQXhpc1dpdGhTY2FsZSA9IChzdGF0ZSwgX3hBeGlzSWQsIHlBeGlzSWQsIGlzUGFub3JhbWEpID0+IHNlbGVjdEF4aXNXaXRoU2NhbGUoc3RhdGUsICJ5QXhpcyIsIHlBeGlzSWQsIGlzUGFub3JhbWEpOwp2YXIgc2VsZWN0WUF4aXNUaWNrcyA9IChzdGF0ZSwgX3hBeGlzSWQsIHlBeGlzSWQsIGlzUGFub3JhbWEpID0+IHNlbGVjdFRpY2tzT2ZHcmFwaGljYWxJdGVtKHN0YXRlLCAieUF4aXMiLCB5QXhpc0lkLCBpc1Bhbm9yYW1hKTsKdmFyIHNlbGVjdEJhbmRTaXplID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RYQXhpc1dpdGhTY2FsZSwgc2VsZWN0WUF4aXNXaXRoU2NhbGUsIHNlbGVjdFhBeGlzVGlja3MsIHNlbGVjdFlBeGlzVGlja3NdLCAobGF5b3V0LCB4QXhpcywgeUF4aXMsIHhBeGlzVGlja3MsIHlBeGlzVGlja3MpID0+IHsKICBpZiAoaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCAieEF4aXMiKSkgewogICAgcmV0dXJuIGdldEJhbmRTaXplT2ZBeGlzKHhBeGlzLCB4QXhpc1RpY2tzLCBmYWxzZSk7CiAgfQogIHJldHVybiBnZXRCYW5kU2l6ZU9mQXhpcyh5QXhpcywgeUF4aXNUaWNrcywgZmFsc2UpOwp9KTsKdmFyIHBpY2tBcmVhSWQgPSAoX3N0YXRlLCBfeEF4aXNJZCwgX3lBeGlzSWQsIF9pc1Bhbm9yYW1hLCBpZCkgPT4gaWQ7CnZhciBzZWxlY3RTeW5jaHJvbmlzZWRBcmVhU2V0dGluZ3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VW5maWx0ZXJlZENhcnRlc2lhbkl0ZW1zLCBwaWNrQXJlYUlkXSwgKGdyYXBoaWNhbEl0ZW1zLCBpZCkgPT4gZ3JhcGhpY2FsSXRlbXMuZmlsdGVyKChpdGVtKSA9PiBpdGVtLnR5cGUgPT09ICJhcmVhIikuZmluZCgoaXRlbSkgPT4gaXRlbS5pZCA9PT0gaWQpKTsKdmFyIHNlbGVjdEdyYXBoaWNhbEl0ZW1TdGFja2VkRGF0YSA9IChzdGF0ZSwgeEF4aXNJZCwgeUF4aXNJZCwgaXNQYW5vcmFtYSwgaWQpID0+IHsKICB2YXIgX3N0YWNrR3JvdXBzJHN0YWNrSWQ7CiAgdmFyIGFyZWFTZXR0aW5ncyA9IHNlbGVjdFN5bmNocm9uaXNlZEFyZWFTZXR0aW5ncyhzdGF0ZSwgeEF4aXNJZCwgeUF4aXNJZCwgaXNQYW5vcmFtYSwgaWQpOwogIGlmIChhcmVhU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGxheW91dCA9IHNlbGVjdENoYXJ0TGF5b3V0KHN0YXRlKTsKICB2YXIgaXNYQXhpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCAieEF4aXMiKTsKICB2YXIgc3RhY2tHcm91cHM7CiAgaWYgKGlzWEF4aXNDYXRlZ29yaWNhbCkgewogICAgc3RhY2tHcm91cHMgPSBzZWxlY3RTdGFja0dyb3VwcyhzdGF0ZSwgInlBeGlzIiwgeUF4aXNJZCwgaXNQYW5vcmFtYSk7CiAgfSBlbHNlIHsKICAgIHN0YWNrR3JvdXBzID0gc2VsZWN0U3RhY2tHcm91cHMoc3RhdGUsICJ4QXhpcyIsIHhBeGlzSWQsIGlzUGFub3JhbWEpOwogIH0KICBpZiAoc3RhY2tHcm91cHMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIHN0YWNrSWQKICB9ID0gYXJlYVNldHRpbmdzOwogIHZhciBzdGFja1Nlcmllc0lkZW50aWZpZXIgPSBnZXRTdGFja1Nlcmllc0lkZW50aWZpZXIoYXJlYVNldHRpbmdzKTsKICBpZiAoc3RhY2tJZCA9PSBudWxsIHx8IHN0YWNrU2VyaWVzSWRlbnRpZmllciA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgZ3JvdXBzID0gKF9zdGFja0dyb3VwcyRzdGFja0lkID0gc3RhY2tHcm91cHNbc3RhY2tJZF0pID09PSBudWxsIHx8IF9zdGFja0dyb3VwcyRzdGFja0lkID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfc3RhY2tHcm91cHMkc3RhY2tJZC5zdGFja2VkRGF0YTsKICByZXR1cm4gZ3JvdXBzID09PSBudWxsIHx8IGdyb3VwcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogZ3JvdXBzLmZpbmQoKHYpID0+IHYua2V5ID09PSBzdGFja1Nlcmllc0lkZW50aWZpZXIpOwp9Owp2YXIgc2VsZWN0QXJlYSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0WEF4aXNXaXRoU2NhbGUsIHNlbGVjdFlBeGlzV2l0aFNjYWxlLCBzZWxlY3RYQXhpc1RpY2tzLCBzZWxlY3RZQXhpc1RpY2tzLCBzZWxlY3RHcmFwaGljYWxJdGVtU3RhY2tlZERhdGEsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzSWZOb3RJblBhbm9yYW1hLCBzZWxlY3RCYW5kU2l6ZSwgc2VsZWN0U3luY2hyb25pc2VkQXJlYVNldHRpbmdzLCBzZWxlY3RDaGFydEJhc2VWYWx1ZV0sIChsYXlvdXQsIHhBeGlzLCB5QXhpcywgeEF4aXNUaWNrcywgeUF4aXNUaWNrcywgc3RhY2tlZERhdGEsIF9yZWYyLCBiYW5kU2l6ZSwgYXJlYVNldHRpbmdzLCBjaGFydEJhc2VWYWx1ZSkgPT4gewogIHZhciB7CiAgICBjaGFydERhdGEsCiAgICBkYXRhU3RhcnRJbmRleCwKICAgIGRhdGFFbmRJbmRleAogIH0gPSBfcmVmMjsKICBpZiAoYXJlYVNldHRpbmdzID09IG51bGwgfHwgbGF5b3V0ICE9PSAiaG9yaXpvbnRhbCIgJiYgbGF5b3V0ICE9PSAidmVydGljYWwiIHx8IHhBeGlzID09IG51bGwgfHwgeUF4aXMgPT0gbnVsbCB8fCB4QXhpc1RpY2tzID09IG51bGwgfHwgeUF4aXNUaWNrcyA9PSBudWxsIHx8IHhBeGlzVGlja3MubGVuZ3RoID09PSAwIHx8IHlBeGlzVGlja3MubGVuZ3RoID09PSAwIHx8IGJhbmRTaXplID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBkYXRhCiAgfSA9IGFyZWFTZXR0aW5nczsKICB2YXIgZGlzcGxheWVkRGF0YTsKICBpZiAoZGF0YSAmJiBkYXRhLmxlbmd0aCA+IDApIHsKICAgIGRpc3BsYXllZERhdGEgPSBkYXRhOwogIH0gZWxzZSB7CiAgICBkaXNwbGF5ZWREYXRhID0gY2hhcnREYXRhID09PSBudWxsIHx8IGNoYXJ0RGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2hhcnREYXRhLnNsaWNlKGRhdGFTdGFydEluZGV4LCBkYXRhRW5kSW5kZXggKyAxKTsKICB9CiAgaWYgKGRpc3BsYXllZERhdGEgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGNvbXB1dGVBcmVhKHsKICAgIGxheW91dCwKICAgIHhBeGlzLAogICAgeUF4aXMsCiAgICB4QXhpc1RpY2tzLAogICAgeUF4aXNUaWNrcywKICAgIGRhdGFTdGFydEluZGV4LAogICAgYXJlYVNldHRpbmdzLAogICAgc3RhY2tlZERhdGEsCiAgICBkaXNwbGF5ZWREYXRhLAogICAgY2hhcnRCYXNlVmFsdWUsCiAgICBiYW5kU2l6ZQogIH0pOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9BcmVhLmpzCnZhciBfZXhjbHVkZWQxMiA9IFsiaWQiXTsKdmFyIF9leGNsdWRlZDI2ID0gWyJhY3RpdmVEb3QiLCAiYW5pbWF0aW9uQmVnaW4iLCAiYW5pbWF0aW9uRHVyYXRpb24iLCAiYW5pbWF0aW9uRWFzaW5nIiwgImNvbm5lY3ROdWxscyIsICJkb3QiLCAiZmlsbCIsICJmaWxsT3BhY2l0eSIsICJoaWRlIiwgImlzQW5pbWF0aW9uQWN0aXZlIiwgImxlZ2VuZFR5cGUiLCAic3Ryb2tlIiwgInhBeGlzSWQiLCAieUF4aXNJZCJdOwpmdW5jdGlvbiBfZXh0ZW5kczE3KCkgewogIHJldHVybiBfZXh0ZW5kczE3ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxNy5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczEyKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMihlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTIocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIG93bktleXMzMChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDMwKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMzAoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTMyKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czMwKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzMihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTMyKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTMyKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTMyKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTMyKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBnZXRMZWdlbmRJdGVtQ29sb3Ioc3Ryb2tlLCBmaWxsKSB7CiAgcmV0dXJuIHN0cm9rZSAmJiBzdHJva2UgIT09ICJub25lIiA/IHN0cm9rZSA6IGZpbGw7Cn0KdmFyIGNvbXB1dGVMZWdlbmRQYXlsb2FkRnJvbUFyZWFEYXRhID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIGRhdGFLZXksCiAgICBuYW1lLAogICAgc3Ryb2tlLAogICAgZmlsbCwKICAgIGxlZ2VuZFR5cGUsCiAgICBoaWRlCiAgfSA9IHByb3BzOwogIHJldHVybiBbewogICAgaW5hY3RpdmU6IGhpZGUsCiAgICBkYXRhS2V5LAogICAgdHlwZTogbGVnZW5kVHlwZSwKICAgIGNvbG9yOiBnZXRMZWdlbmRJdGVtQ29sb3Ioc3Ryb2tlLCBmaWxsKSwKICAgIHZhbHVlOiBnZXRUb29sdGlwTmFtZVByb3AobmFtZSwgZGF0YUtleSksCiAgICBwYXlsb2FkOiBwcm9wcwogIH1dOwp9Owp2YXIgU2V0QXJlYVRvb2x0aXBFbnRyeVNldHRpbmdzID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjYubWVtbygoX3JlZjIpID0+IHsKICB2YXIgewogICAgZGF0YUtleSwKICAgIGRhdGEsCiAgICBzdHJva2UsCiAgICBzdHJva2VXaWR0aCwKICAgIGZpbGwsCiAgICBuYW1lLAogICAgaGlkZSwKICAgIHVuaXQ6IHVuaXQyLAogICAgdG9vbHRpcFR5cGUKICB9ID0gX3JlZjI7CiAgdmFyIHRvb2x0aXBFbnRyeVNldHRpbmdzID0gewogICAgZGF0YURlZmluZWRPbkl0ZW06IGRhdGEsCiAgICBwb3NpdGlvbnM6IHZvaWQgMCwKICAgIHNldHRpbmdzOiB7CiAgICAgIHN0cm9rZSwKICAgICAgc3Ryb2tlV2lkdGgsCiAgICAgIGZpbGwsCiAgICAgIGRhdGFLZXksCiAgICAgIG5hbWVLZXk6IHZvaWQgMCwKICAgICAgbmFtZTogZ2V0VG9vbHRpcE5hbWVQcm9wKG5hbWUsIGRhdGFLZXkpLAogICAgICBoaWRlLAogICAgICB0eXBlOiB0b29sdGlwVHlwZSwKICAgICAgY29sb3I6IGdldExlZ2VuZEl0ZW1Db2xvcihzdHJva2UsIGZpbGwpLAogICAgICB1bml0OiB1bml0MgogICAgfQogIH07CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoU2V0VG9vbHRpcEVudHJ5U2V0dGluZ3MsIHsKICAgIHRvb2x0aXBFbnRyeVNldHRpbmdzCiAgfSk7Cn0pOwpmdW5jdGlvbiBBcmVhRG90c1dyYXBwZXIoX3JlZjIpIHsKICB2YXIgewogICAgY2xpcFBhdGhJZCwKICAgIHBvaW50cywKICAgIHByb3BzCiAgfSA9IF9yZWYyOwogIHZhciB7CiAgICBuZWVkQ2xpcCwKICAgIGRvdCwKICAgIGRhdGFLZXkKICB9ID0gcHJvcHM7CiAgdmFyIGFyZWFQcm9wcyA9IHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhwcm9wcyk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoRG90cywgewogICAgcG9pbnRzLAogICAgZG90LAogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtYXJlYS1kb3RzIiwKICAgIGRvdENsYXNzTmFtZTogInJlY2hhcnRzLWFyZWEtZG90IiwKICAgIGRhdGFLZXksCiAgICBiYXNlUHJvcHM6IGFyZWFQcm9wcywKICAgIG5lZWRDbGlwLAogICAgY2xpcFBhdGhJZAogIH0pOwp9CmZ1bmN0aW9uIEFyZWFMYWJlbExpc3RQcm92aWRlcihfcmVmMykgewogIHZhciB7CiAgICBzaG93TGFiZWxzLAogICAgY2hpbGRyZW4sCiAgICBwb2ludHMKICB9ID0gX3JlZjM7CiAgdmFyIGxhYmVsTGlzdEVudHJpZXMgPSBwb2ludHMubWFwKChwb2ludDQpID0+IHsKICAgIHZhciBfcG9pbnQkeCwgX3BvaW50JHk7CiAgICB2YXIgdmlld0JveCA9IHsKICAgICAgeDogKF9wb2ludCR4ID0gcG9pbnQ0LngpICE9PSBudWxsICYmIF9wb2ludCR4ICE9PSB2b2lkIDAgPyBfcG9pbnQkeCA6IDAsCiAgICAgIHk6IChfcG9pbnQkeSA9IHBvaW50NC55KSAhPT0gbnVsbCAmJiBfcG9pbnQkeSAhPT0gdm9pZCAwID8gX3BvaW50JHkgOiAwLAogICAgICB3aWR0aDogMCwKICAgICAgbG93ZXJXaWR0aDogMCwKICAgICAgdXBwZXJXaWR0aDogMCwKICAgICAgaGVpZ2h0OiAwCiAgICB9OwogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQzMChfb2JqZWN0U3ByZWFkMzAoe30sIHZpZXdCb3gpLCB7fSwgewogICAgICB2YWx1ZTogcG9pbnQ0LnZhbHVlLAogICAgICBwYXlsb2FkOiBwb2ludDQucGF5bG9hZCwKICAgICAgcGFyZW50Vmlld0JveDogdm9pZCAwLAogICAgICB2aWV3Qm94LAogICAgICBmaWxsOiB2b2lkIDAKICAgIH0pOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkxhYmVsTGlzdENvbnRleHRQcm92aWRlciwgewogICAgdmFsdWU6IHNob3dMYWJlbHMgPyBsYWJlbExpc3RFbnRyaWVzIDogdm9pZCAwCiAgfSwgY2hpbGRyZW4pOwp9CmZ1bmN0aW9uIFN0YXRpY0FyZWEoX3JlZjQpIHsKICB2YXIgewogICAgcG9pbnRzLAogICAgYmFzZUxpbmUsCiAgICBuZWVkQ2xpcCwKICAgIGNsaXBQYXRoSWQsCiAgICBwcm9wcwogIH0gPSBfcmVmNDsKICB2YXIgewogICAgbGF5b3V0LAogICAgdHlwZSwKICAgIHN0cm9rZSwKICAgIGNvbm5lY3ROdWxscywKICAgIGlzUmFuZ2UKICB9ID0gcHJvcHM7CiAgdmFyIHsKICAgIGlkCiAgfSA9IHByb3BzLCBwcm9wc1dpdGhvdXRJZCA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczEyKHByb3BzLCBfZXhjbHVkZWQxMik7CiAgdmFyIGFsbE90aGVyUHJvcHMgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHMocHJvcHNXaXRob3V0SWQpOwogIHZhciBwcm9wc1dpdGhFdmVudHMgPSBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzV2l0aG91dElkKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChSZWFjdDI2LkZyYWdtZW50LCBudWxsLCAocG9pbnRzID09PSBudWxsIHx8IHBvaW50cyA9PT0gdm9pZCAwID8gdm9pZCAwIDogcG9pbnRzLmxlbmd0aCkgPiAxICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgIGNsaXBQYXRoOiBuZWVkQ2xpcCA/ICJ1cmwoI2NsaXBQYXRoLSIuY29uY2F0KGNsaXBQYXRoSWQsICIpIikgOiB2b2lkIDAKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEN1cnZlLCBfZXh0ZW5kczE3KHt9LCBwcm9wc1dpdGhFdmVudHMsIHsKICAgIGlkLAogICAgcG9pbnRzLAogICAgY29ubmVjdE51bGxzLAogICAgdHlwZSwKICAgIGJhc2VMaW5lLAogICAgbGF5b3V0LAogICAgc3Ryb2tlOiAibm9uZSIsCiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1hcmVhLWFyZWEiCiAgfSkpLCBzdHJva2UgIT09ICJub25lIiAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEN1cnZlLCBfZXh0ZW5kczE3KHt9LCBhbGxPdGhlclByb3BzLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1hcmVhLWN1cnZlIiwKICAgIGxheW91dCwKICAgIHR5cGUsCiAgICBjb25uZWN0TnVsbHMsCiAgICBmaWxsOiAibm9uZSIsCiAgICBwb2ludHMKICB9KSksIHN0cm9rZSAhPT0gIm5vbmUiICYmIGlzUmFuZ2UgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChDdXJ2ZSwgX2V4dGVuZHMxNyh7fSwgYWxsT3RoZXJQcm9wcywgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtYXJlYS1jdXJ2ZSIsCiAgICBsYXlvdXQsCiAgICB0eXBlLAogICAgY29ubmVjdE51bGxzLAogICAgZmlsbDogIm5vbmUiLAogICAgcG9pbnRzOiBiYXNlTGluZQogIH0pKSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQXJlYURvdHNXcmFwcGVyLCB7CiAgICBwb2ludHMsCiAgICBwcm9wczogcHJvcHNXaXRob3V0SWQsCiAgICBjbGlwUGF0aElkCiAgfSkpOwp9CmZ1bmN0aW9uIFZlcnRpY2FsUmVjdChfcmVmNSkgewogIHZhciB7CiAgICBhbHBoYTogYWxwaGEyLAogICAgYmFzZUxpbmUsCiAgICBwb2ludHMsCiAgICBzdHJva2VXaWR0aAogIH0gPSBfcmVmNTsKICB2YXIgc3RhcnRZID0gcG9pbnRzWzBdLnk7CiAgdmFyIGVuZFkgPSBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdLnk7CiAgaWYgKCFpc1dlbGxCZWhhdmVkTnVtYmVyKHN0YXJ0WSkgfHwgIWlzV2VsbEJlaGF2ZWROdW1iZXIoZW5kWSkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgaGVpZ2h0ID0gYWxwaGEyICogTWF0aC5hYnMoc3RhcnRZIC0gZW5kWSk7CiAgdmFyIG1heFggPSBNYXRoLm1heCguLi5wb2ludHMubWFwKChlbnRyeSkgPT4gZW50cnkueCB8fCAwKSk7CiAgaWYgKGlzTnVtYmVyKGJhc2VMaW5lKSkgewogICAgbWF4WCA9IE1hdGgubWF4KGJhc2VMaW5lLCBtYXhYKTsKICB9IGVsc2UgaWYgKGJhc2VMaW5lICYmIEFycmF5LmlzQXJyYXkoYmFzZUxpbmUpICYmIGJhc2VMaW5lLmxlbmd0aCkgewogICAgbWF4WCA9IE1hdGgubWF4KC4uLmJhc2VMaW5lLm1hcCgoZW50cnkpID0+IGVudHJ5LnggfHwgMCksIG1heFgpOwogIH0KICBpZiAoaXNOdW1iZXIobWF4WCkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgICB4OiAwLAogICAgICB5OiBzdGFydFkgPCBlbmRZID8gc3RhcnRZIDogc3RhcnRZIC0gaGVpZ2h0LAogICAgICB3aWR0aDogbWF4WCArIChzdHJva2VXaWR0aCA/IHBhcnNlSW50KCIiLmNvbmNhdChzdHJva2VXaWR0aCksIDEwKSA6IDEpLAogICAgICBoZWlnaHQ6IE1hdGguZmxvb3IoaGVpZ2h0KQogICAgfSk7CiAgfQogIHJldHVybiBudWxsOwp9CmZ1bmN0aW9uIEhvcml6b250YWxSZWN0KF9yZWY2KSB7CiAgdmFyIHsKICAgIGFscGhhOiBhbHBoYTIsCiAgICBiYXNlTGluZSwKICAgIHBvaW50cywKICAgIHN0cm9rZVdpZHRoCiAgfSA9IF9yZWY2OwogIHZhciBzdGFydFggPSBwb2ludHNbMF0ueDsKICB2YXIgZW5kWCA9IHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV0ueDsKICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIoc3RhcnRYKSB8fCAhaXNXZWxsQmVoYXZlZE51bWJlcihlbmRYKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB3aWR0aCA9IGFscGhhMiAqIE1hdGguYWJzKHN0YXJ0WCAtIGVuZFgpOwogIHZhciBtYXhZID0gTWF0aC5tYXgoLi4ucG9pbnRzLm1hcCgoZW50cnkpID0+IGVudHJ5LnkgfHwgMCkpOwogIGlmIChpc051bWJlcihiYXNlTGluZSkpIHsKICAgIG1heFkgPSBNYXRoLm1heChiYXNlTGluZSwgbWF4WSk7CiAgfSBlbHNlIGlmIChiYXNlTGluZSAmJiBBcnJheS5pc0FycmF5KGJhc2VMaW5lKSAmJiBiYXNlTGluZS5sZW5ndGgpIHsKICAgIG1heFkgPSBNYXRoLm1heCguLi5iYXNlTGluZS5tYXAoKGVudHJ5KSA9PiBlbnRyeS55IHx8IDApLCBtYXhZKTsKICB9CiAgaWYgKGlzTnVtYmVyKG1heFkpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgICAgeDogc3RhcnRYIDwgZW5kWCA/IHN0YXJ0WCA6IHN0YXJ0WCAtIHdpZHRoLAogICAgICB5OiAwLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0OiBNYXRoLmZsb29yKG1heFkgKyAoc3Ryb2tlV2lkdGggPyBwYXJzZUludCgiIi5jb25jYXQoc3Ryb2tlV2lkdGgpLCAxMCkgOiAxKSkKICAgIH0pOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBDbGlwUmVjdChfcmVmNykgewogIHZhciB7CiAgICBhbHBoYTogYWxwaGEyLAogICAgbGF5b3V0LAogICAgcG9pbnRzLAogICAgYmFzZUxpbmUsCiAgICBzdHJva2VXaWR0aAogIH0gPSBfcmVmNzsKICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChWZXJ0aWNhbFJlY3QsIHsKICAgICAgYWxwaGE6IGFscGhhMiwKICAgICAgcG9pbnRzLAogICAgICBiYXNlTGluZSwKICAgICAgc3Ryb2tlV2lkdGgKICAgIH0pOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChIb3Jpem9udGFsUmVjdCwgewogICAgYWxwaGE6IGFscGhhMiwKICAgIHBvaW50cywKICAgIGJhc2VMaW5lLAogICAgc3Ryb2tlV2lkdGgKICB9KTsKfQpmdW5jdGlvbiBBcmVhV2l0aEFuaW1hdGlvbihfcmVmOCkgewogIHZhciB7CiAgICBuZWVkQ2xpcCwKICAgIGNsaXBQYXRoSWQsCiAgICBwcm9wcywKICAgIHByZXZpb3VzUG9pbnRzUmVmLAogICAgcHJldmlvdXNCYXNlbGluZVJlZgogIH0gPSBfcmVmODsKICB2YXIgewogICAgcG9pbnRzLAogICAgYmFzZUxpbmUsCiAgICBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgIGFuaW1hdGlvbkJlZ2luLAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25FYXNpbmcsCiAgICBvbkFuaW1hdGlvblN0YXJ0LAogICAgb25BbmltYXRpb25FbmQKICB9ID0gcHJvcHM7CiAgdmFyIGFuaW1hdGlvbklucHV0ID0gKDAsIGltcG9ydF9yZWFjdDM4LnVzZU1lbW8pKCgpID0+ICh7CiAgICBwb2ludHMsCiAgICBiYXNlTGluZQogIH0pLCBbcG9pbnRzLCBiYXNlTGluZV0pOwogIHZhciBhbmltYXRpb25JZCA9IHVzZUFuaW1hdGlvbklkKGFuaW1hdGlvbklucHV0LCAicmVjaGFydHMtYXJlYS0iKTsKICB2YXIgbGF5b3V0ID0gdXNlQ2FydGVzaWFuQ2hhcnRMYXlvdXQoKTsKICB2YXIgW2lzQW5pbWF0aW5nLCBzZXRJc0FuaW1hdGluZ10gPSAoMCwgaW1wb3J0X3JlYWN0MzgudXNlU3RhdGUpKGZhbHNlKTsKICB2YXIgc2hvd0xhYmVscyA9ICFpc0FuaW1hdGluZzsKICB2YXIgaGFuZGxlQW5pbWF0aW9uRW5kID0gKDAsIGltcG9ydF9yZWFjdDM4LnVzZUNhbGxiYWNrKSgoKSA9PiB7CiAgICBpZiAodHlwZW9mIG9uQW5pbWF0aW9uRW5kID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIG9uQW5pbWF0aW9uRW5kKCk7CiAgICB9CiAgICBzZXRJc0FuaW1hdGluZyhmYWxzZSk7CiAgfSwgW29uQW5pbWF0aW9uRW5kXSk7CiAgdmFyIGhhbmRsZUFuaW1hdGlvblN0YXJ0ID0gKDAsIGltcG9ydF9yZWFjdDM4LnVzZUNhbGxiYWNrKSgoKSA9PiB7CiAgICBpZiAodHlwZW9mIG9uQW5pbWF0aW9uU3RhcnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgb25BbmltYXRpb25TdGFydCgpOwogICAgfQogICAgc2V0SXNBbmltYXRpbmcodHJ1ZSk7CiAgfSwgW29uQW5pbWF0aW9uU3RhcnRdKTsKICBpZiAobGF5b3V0ID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgcHJldlBvaW50cyA9IHByZXZpb3VzUG9pbnRzUmVmLmN1cnJlbnQ7CiAgdmFyIHByZXZCYXNlTGluZSA9IHByZXZpb3VzQmFzZWxpbmVSZWYuY3VycmVudDsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChBcmVhTGFiZWxMaXN0UHJvdmlkZXIsIHsKICAgIHNob3dMYWJlbHMsCiAgICBwb2ludHMKICB9LCBwcm9wcy5jaGlsZHJlbiwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChKYXZhc2NyaXB0QW5pbWF0ZSwgewogICAgYW5pbWF0aW9uSWQsCiAgICBiZWdpbjogYW5pbWF0aW9uQmVnaW4sCiAgICBkdXJhdGlvbjogYW5pbWF0aW9uRHVyYXRpb24sCiAgICBpc0FjdGl2ZTogaXNBbmltYXRpb25BY3RpdmUsCiAgICBlYXNpbmc6IGFuaW1hdGlvbkVhc2luZywKICAgIG9uQW5pbWF0aW9uRW5kOiBoYW5kbGVBbmltYXRpb25FbmQsCiAgICBvbkFuaW1hdGlvblN0YXJ0OiBoYW5kbGVBbmltYXRpb25TdGFydCwKICAgIGtleTogYW5pbWF0aW9uSWQKICB9LCAodCkgPT4gewogICAgaWYgKHByZXZQb2ludHMpIHsKICAgICAgdmFyIHByZXZQb2ludHNEaWZmRmFjdG9yID0gcHJldlBvaW50cy5sZW5ndGggLyBwb2ludHMubGVuZ3RoOwogICAgICB2YXIgc3RlcFBvaW50cyA9ICgKICAgICAgICAvKgogICAgICAgICAqIEhlcmUgaXQgaXMgaW1wb3J0YW50IHRoYXQgYXQgdGhlIHZlcnkgZW5kIG9mIHRoZSBhbmltYXRpb24sIG9uIHRoZSBsYXN0IGZyYW1lLAogICAgICAgICAqIHdlIHJlbmRlciB0aGUgb3JpZ2luYWwgcG9pbnRzIHdpdGhvdXQgYW55IGludGVycG9sYXRpb24uCiAgICAgICAgICogVGhpcyBpcyBuZWVkZWQgYmVjYXVzZSB0aGUgY29kZSBhYm92ZSBpcyBjaGVja2luZyBmb3IgcmVmZXJlbmNlIGVxdWFsaXR5IHRvIGRlY2lkZSBpZiB0aGUgYW5pbWF0aW9uIHNob3VsZCBydW4KICAgICAgICAgKiBhbmQgaWYgd2UgY3JlYXRlIGEgbmV3IGFycmF5IGluc3RhbmNlIChldmVuIGlmIHRoZSBudW1iZXJzIHdlcmUgdGhlIHNhbWUpCiAgICAgICAgICogdGhlbiB3ZSB3b3VsZCBicmVhayBhbmltYXRpb25zLgogICAgICAgICAqLwogICAgICAgIHQgPT09IDEgPyBwb2ludHMgOiBwb2ludHMubWFwKChlbnRyeSwgaW5kZXgpID0+IHsKICAgICAgICAgIHZhciBwcmV2UG9pbnRJbmRleCA9IE1hdGguZmxvb3IoaW5kZXggKiBwcmV2UG9pbnRzRGlmZkZhY3Rvcik7CiAgICAgICAgICBpZiAocHJldlBvaW50c1twcmV2UG9pbnRJbmRleF0pIHsKICAgICAgICAgICAgdmFyIHByZXYgPSBwcmV2UG9pbnRzW3ByZXZQb2ludEluZGV4XTsKICAgICAgICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQzMChfb2JqZWN0U3ByZWFkMzAoe30sIGVudHJ5KSwge30sIHsKICAgICAgICAgICAgICB4OiBpbnRlcnBvbGF0ZShwcmV2LngsIGVudHJ5LngsIHQpLAogICAgICAgICAgICAgIHk6IGludGVycG9sYXRlKHByZXYueSwgZW50cnkueSwgdCkKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZW50cnk7CiAgICAgICAgfSkKICAgICAgKTsKICAgICAgdmFyIHN0ZXBCYXNlTGluZTsKICAgICAgaWYgKGlzTnVtYmVyKGJhc2VMaW5lKSkgewogICAgICAgIHN0ZXBCYXNlTGluZSA9IGludGVycG9sYXRlKHByZXZCYXNlTGluZSwgYmFzZUxpbmUsIHQpOwogICAgICB9IGVsc2UgaWYgKGlzTnVsbGlzaChiYXNlTGluZSkgfHwgaXNOYW4oYmFzZUxpbmUpKSB7CiAgICAgICAgc3RlcEJhc2VMaW5lID0gaW50ZXJwb2xhdGUocHJldkJhc2VMaW5lLCAwLCB0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdGVwQmFzZUxpbmUgPSBiYXNlTGluZS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgICAgICAgdmFyIHByZXZQb2ludEluZGV4ID0gTWF0aC5mbG9vcihpbmRleCAqIHByZXZQb2ludHNEaWZmRmFjdG9yKTsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHByZXZCYXNlTGluZSkgJiYgcHJldkJhc2VMaW5lW3ByZXZQb2ludEluZGV4XSkgewogICAgICAgICAgICB2YXIgcHJldiA9IHByZXZCYXNlTGluZVtwcmV2UG9pbnRJbmRleF07CiAgICAgICAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMzAoX29iamVjdFNwcmVhZDMwKHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgICAgICAgeDogaW50ZXJwb2xhdGUocHJldi54LCBlbnRyeS54LCB0KSwKICAgICAgICAgICAgICB5OiBpbnRlcnBvbGF0ZShwcmV2LnksIGVudHJ5LnksIHQpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVudHJ5OwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICh0ID4gMCkgewogICAgICAgIHByZXZpb3VzUG9pbnRzUmVmLmN1cnJlbnQgPSBzdGVwUG9pbnRzOwogICAgICAgIHByZXZpb3VzQmFzZWxpbmVSZWYuY3VycmVudCA9IHN0ZXBCYXNlTGluZTsKICAgICAgfQogICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChTdGF0aWNBcmVhLCB7CiAgICAgICAgcG9pbnRzOiBzdGVwUG9pbnRzLAogICAgICAgIGJhc2VMaW5lOiBzdGVwQmFzZUxpbmUsCiAgICAgICAgbmVlZENsaXAsCiAgICAgICAgY2xpcFBhdGhJZCwKICAgICAgICBwcm9wcwogICAgICB9KTsKICAgIH0KICAgIGlmICh0ID4gMCkgewogICAgICBwcmV2aW91c1BvaW50c1JlZi5jdXJyZW50ID0gcG9pbnRzOwogICAgICBwcmV2aW91c0Jhc2VsaW5lUmVmLmN1cnJlbnQgPSBiYXNlTGluZTsKICAgIH0KICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KExheWVyLCBudWxsLCBpc0FuaW1hdGlvbkFjdGl2ZSAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJkZWZzIiwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudCgiY2xpcFBhdGgiLCB7CiAgICAgIGlkOiAiYW5pbWF0aW9uQ2xpcFBhdGgtIi5jb25jYXQoY2xpcFBhdGhJZCkKICAgIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQ2xpcFJlY3QsIHsKICAgICAgYWxwaGE6IHQsCiAgICAgIHBvaW50cywKICAgICAgYmFzZUxpbmUsCiAgICAgIGxheW91dCwKICAgICAgc3Ryb2tlV2lkdGg6IHByb3BzLnN0cm9rZVdpZHRoCiAgICB9KSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICAgIGNsaXBQYXRoOiAidXJsKCNhbmltYXRpb25DbGlwUGF0aC0iLmNvbmNhdChjbGlwUGF0aElkLCAiKSIpCiAgICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFN0YXRpY0FyZWEsIHsKICAgICAgcG9pbnRzLAogICAgICBiYXNlTGluZSwKICAgICAgbmVlZENsaXAsCiAgICAgIGNsaXBQYXRoSWQsCiAgICAgIHByb3BzCiAgICB9KSkpOwogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KExhYmVsTGlzdEZyb21MYWJlbFByb3AsIHsKICAgIGxhYmVsOiBwcm9wcy5sYWJlbAogIH0pKTsKfQpmdW5jdGlvbiBSZW5kZXJBcmVhKF9yZWY5KSB7CiAgdmFyIHsKICAgIG5lZWRDbGlwLAogICAgY2xpcFBhdGhJZCwKICAgIHByb3BzCiAgfSA9IF9yZWY5OwogIHZhciBwcmV2aW91c1BvaW50c1JlZiA9ICgwLCBpbXBvcnRfcmVhY3QzOC51c2VSZWYpKG51bGwpOwogIHZhciBwcmV2aW91c0Jhc2VsaW5lUmVmID0gKDAsIGltcG9ydF9yZWFjdDM4LnVzZVJlZikoKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChBcmVhV2l0aEFuaW1hdGlvbiwgewogICAgbmVlZENsaXAsCiAgICBjbGlwUGF0aElkLAogICAgcHJvcHMsCiAgICBwcmV2aW91c1BvaW50c1JlZiwKICAgIHByZXZpb3VzQmFzZWxpbmVSZWYKICB9KTsKfQp2YXIgQXJlYVdpdGhTdGF0ZSA9IGNsYXNzIGV4dGVuZHMgaW1wb3J0X3JlYWN0MzguUHVyZUNvbXBvbmVudCB7CiAgcmVuZGVyKCkgewogICAgdmFyIHsKICAgICAgaGlkZSwKICAgICAgZG90LAogICAgICBwb2ludHMsCiAgICAgIGNsYXNzTmFtZSwKICAgICAgdG9wLAogICAgICBsZWZ0LAogICAgICBuZWVkQ2xpcCwKICAgICAgeEF4aXNJZCwKICAgICAgeUF4aXNJZCwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodCwKICAgICAgaWQsCiAgICAgIGJhc2VMaW5lLAogICAgICB6SW5kZXgKICAgIH0gPSB0aGlzLnByb3BzOwogICAgaWYgKGhpZGUpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICB2YXIgbGF5ZXJDbGFzcyA9IGNsc3goInJlY2hhcnRzLWFyZWEiLCBjbGFzc05hbWUpOwogICAgdmFyIGNsaXBQYXRoSWQgPSBpZDsKICAgIHZhciB7CiAgICAgIHI6IHIyLAogICAgICBzdHJva2VXaWR0aAogICAgfSA9IGdldFJhZGl1c0FuZFN0cm9rZVdpZHRoRnJvbURvdChkb3QpOwogICAgdmFyIGNsaXBEb3QgPSBpc0NsaXBEb3QoZG90KTsKICAgIHZhciBkb3RTaXplID0gcjIgKiAyICsgc3Ryb2tlV2lkdGg7CiAgICB2YXIgYWN0aXZlUG9pbnRzQ2xpcFBhdGggPSBuZWVkQ2xpcCA/ICJ1cmwoI2NsaXBQYXRoLSIuY29uY2F0KGNsaXBEb3QgPyAiIiA6ICJkb3RzLSIpLmNvbmNhdChjbGlwUGF0aElkLCAiKSIpIDogdm9pZCAwOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgICAgekluZGV4CiAgICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcwogICAgfSwgbmVlZENsaXAgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudCgiZGVmcyIsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoR3JhcGhpY2FsSXRlbUNsaXBQYXRoLCB7CiAgICAgIGNsaXBQYXRoSWQsCiAgICAgIHhBeGlzSWQsCiAgICAgIHlBeGlzSWQKICAgIH0pLCAhY2xpcERvdCAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJjbGlwUGF0aCIsIHsKICAgICAgaWQ6ICJjbGlwUGF0aC1kb3RzLSIuY29uY2F0KGNsaXBQYXRoSWQpCiAgICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgICB4OiBsZWZ0IC0gZG90U2l6ZSAvIDIsCiAgICAgIHk6IHRvcCAtIGRvdFNpemUgLyAyLAogICAgICB3aWR0aDogd2lkdGggKyBkb3RTaXplLAogICAgICBoZWlnaHQ6IGhlaWdodCArIGRvdFNpemUKICAgIH0pKSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoUmVuZGVyQXJlYSwgewogICAgICBuZWVkQ2xpcCwKICAgICAgY2xpcFBhdGhJZCwKICAgICAgcHJvcHM6IHRoaXMucHJvcHMKICAgIH0pKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChBY3RpdmVQb2ludHMsIHsKICAgICAgcG9pbnRzLAogICAgICBtYWluQ29sb3I6IGdldExlZ2VuZEl0ZW1Db2xvcih0aGlzLnByb3BzLnN0cm9rZSwgdGhpcy5wcm9wcy5maWxsKSwKICAgICAgaXRlbURhdGFLZXk6IHRoaXMucHJvcHMuZGF0YUtleSwKICAgICAgYWN0aXZlRG90OiB0aGlzLnByb3BzLmFjdGl2ZURvdCwKICAgICAgY2xpcFBhdGg6IGFjdGl2ZVBvaW50c0NsaXBQYXRoCiAgICB9KSwgdGhpcy5wcm9wcy5pc1JhbmdlICYmIEFycmF5LmlzQXJyYXkoYmFzZUxpbmUpICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQWN0aXZlUG9pbnRzLCB7CiAgICAgIHBvaW50czogYmFzZUxpbmUsCiAgICAgIG1haW5Db2xvcjogZ2V0TGVnZW5kSXRlbUNvbG9yKHRoaXMucHJvcHMuc3Ryb2tlLCB0aGlzLnByb3BzLmZpbGwpLAogICAgICBpdGVtRGF0YUtleTogdGhpcy5wcm9wcy5kYXRhS2V5LAogICAgICBhY3RpdmVEb3Q6IHRoaXMucHJvcHMuYWN0aXZlRG90LAogICAgICBjbGlwUGF0aDogYWN0aXZlUG9pbnRzQ2xpcFBhdGgKICAgIH0pKTsKICB9Cn07CnZhciBkZWZhdWx0QXJlYVByb3BzID0gewogIGFjdGl2ZURvdDogdHJ1ZSwKICBhbmltYXRpb25CZWdpbjogMCwKICBhbmltYXRpb25EdXJhdGlvbjogMTUwMCwKICBhbmltYXRpb25FYXNpbmc6ICJlYXNlIiwKICBjb25uZWN0TnVsbHM6IGZhbHNlLAogIGRvdDogZmFsc2UsCiAgZmlsbDogIiMzMTgyYmQiLAogIGZpbGxPcGFjaXR5OiAwLjYsCiAgaGlkZTogZmFsc2UsCiAgaXNBbmltYXRpb25BY3RpdmU6ICJhdXRvIiwKICBsZWdlbmRUeXBlOiAibGluZSIsCiAgc3Ryb2tlOiAiIzMxODJiZCIsCiAgc3Ryb2tlV2lkdGg6IDEsCiAgdHlwZTogImxpbmVhciIsCiAgbGFiZWw6IGZhbHNlLAogIHhBeGlzSWQ6IDAsCiAgeUF4aXNJZDogMCwKICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5hcmVhCn07CmZ1bmN0aW9uIEFyZWFJbXBsKHByb3BzKSB7CiAgdmFyIF91c2VBcHBTZWxlY3RvcjsKICB2YXIgX3Jlc29sdmVEZWZhdWx0UHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKHByb3BzLCBkZWZhdWx0QXJlYVByb3BzKSwgewogICAgYWN0aXZlRG90LAogICAgYW5pbWF0aW9uQmVnaW4sCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIGNvbm5lY3ROdWxscywKICAgIGRvdCwKICAgIGZpbGwsCiAgICBmaWxsT3BhY2l0eSwKICAgIGhpZGUsCiAgICBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgIGxlZ2VuZFR5cGUsCiAgICBzdHJva2UsCiAgICB4QXhpc0lkLAogICAgeUF4aXNJZAogIH0gPSBfcmVzb2x2ZURlZmF1bHRQcm9wcywgZXZlcnl0aGluZ0Vsc2UgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMihfcmVzb2x2ZURlZmF1bHRQcm9wcywgX2V4Y2x1ZGVkMjYpOwogIHZhciBsYXlvdXQgPSB1c2VDaGFydExheW91dCgpOwogIHZhciBjaGFydE5hbWUgPSB1c2VDaGFydE5hbWUoKTsKICB2YXIgewogICAgbmVlZENsaXAKICB9ID0gdXNlTmVlZHNDbGlwKHhBeGlzSWQsIHlBeGlzSWQpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciB7CiAgICBwb2ludHMsCiAgICBpc1JhbmdlLAogICAgYmFzZUxpbmUKICB9ID0gKF91c2VBcHBTZWxlY3RvciA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0QXJlYShzdGF0ZSwgeEF4aXNJZCwgeUF4aXNJZCwgaXNQYW5vcmFtYSwgcHJvcHMuaWQpKSkgIT09IG51bGwgJiYgX3VzZUFwcFNlbGVjdG9yICE9PSB2b2lkIDAgPyBfdXNlQXBwU2VsZWN0b3IgOiB7fTsKICB2YXIgcGxvdEFyZWEgPSB1c2VQbG90QXJlYSgpOwogIGlmIChsYXlvdXQgIT09ICJob3Jpem9udGFsIiAmJiBsYXlvdXQgIT09ICJ2ZXJ0aWNhbCIgfHwgcGxvdEFyZWEgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmIChjaGFydE5hbWUgIT09ICJBcmVhQ2hhcnQiICYmIGNoYXJ0TmFtZSAhPT0gIkNvbXBvc2VkQ2hhcnQiKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIGhlaWdodCwKICAgIHdpZHRoLAogICAgeDogbGVmdCwKICAgIHk6IHRvcAogIH0gPSBwbG90QXJlYTsKICBpZiAoIXBvaW50cyB8fCAhcG9pbnRzLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEFyZWFXaXRoU3RhdGUsIF9leHRlbmRzMTcoe30sIGV2ZXJ5dGhpbmdFbHNlLCB7CiAgICBhY3RpdmVEb3QsCiAgICBhbmltYXRpb25CZWdpbiwKICAgIGFuaW1hdGlvbkR1cmF0aW9uLAogICAgYW5pbWF0aW9uRWFzaW5nLAogICAgYmFzZUxpbmUsCiAgICBjb25uZWN0TnVsbHMsCiAgICBkb3QsCiAgICBmaWxsLAogICAgZmlsbE9wYWNpdHksCiAgICBoZWlnaHQsCiAgICBoaWRlLAogICAgbGF5b3V0LAogICAgaXNBbmltYXRpb25BY3RpdmU6IGlzQW5pbWF0aW9uQWN0aXZlID09PSAiYXV0byIgPyAhR2xvYmFsLmlzU3NyIDogaXNBbmltYXRpb25BY3RpdmUsCiAgICBpc1JhbmdlLAogICAgbGVnZW5kVHlwZSwKICAgIG5lZWRDbGlwLAogICAgcG9pbnRzLAogICAgc3Ryb2tlLAogICAgd2lkdGgsCiAgICBsZWZ0LAogICAgdG9wLAogICAgeEF4aXNJZCwKICAgIHlBeGlzSWQKICB9KSk7Cn0KdmFyIGdldEJhc2VWYWx1ZSA9IChsYXlvdXQsIGNoYXJ0QmFzZVZhbHVlLCBpdGVtQmFzZVZhbHVlLCB4QXhpcywgeUF4aXMpID0+IHsKICB2YXIgYmFzZVZhbHVlID0gaXRlbUJhc2VWYWx1ZSAhPT0gbnVsbCAmJiBpdGVtQmFzZVZhbHVlICE9PSB2b2lkIDAgPyBpdGVtQmFzZVZhbHVlIDogY2hhcnRCYXNlVmFsdWU7CiAgaWYgKGlzTnVtYmVyKGJhc2VWYWx1ZSkpIHsKICAgIHJldHVybiBiYXNlVmFsdWU7CiAgfQogIHZhciBudW1lcmljQXhpcyA9IGxheW91dCA9PT0gImhvcml6b250YWwiID8geUF4aXMgOiB4QXhpczsKICB2YXIgZG9tYWluID0gbnVtZXJpY0F4aXMuc2NhbGUuZG9tYWluKCk7CiAgaWYgKG51bWVyaWNBeGlzLnR5cGUgPT09ICJudW1iZXIiKSB7CiAgICB2YXIgZG9tYWluTWF4ID0gTWF0aC5tYXgoZG9tYWluWzBdLCBkb21haW5bMV0pOwogICAgdmFyIGRvbWFpbk1pbiA9IE1hdGgubWluKGRvbWFpblswXSwgZG9tYWluWzFdKTsKICAgIGlmIChiYXNlVmFsdWUgPT09ICJkYXRhTWluIikgewogICAgICByZXR1cm4gZG9tYWluTWluOwogICAgfQogICAgaWYgKGJhc2VWYWx1ZSA9PT0gImRhdGFNYXgiKSB7CiAgICAgIHJldHVybiBkb21haW5NYXg7CiAgICB9CiAgICByZXR1cm4gZG9tYWluTWF4IDwgMCA/IGRvbWFpbk1heCA6IE1hdGgubWF4KE1hdGgubWluKGRvbWFpblswXSwgZG9tYWluWzFdKSwgMCk7CiAgfQogIGlmIChiYXNlVmFsdWUgPT09ICJkYXRhTWluIikgewogICAgcmV0dXJuIGRvbWFpblswXTsKICB9CiAgaWYgKGJhc2VWYWx1ZSA9PT0gImRhdGFNYXgiKSB7CiAgICByZXR1cm4gZG9tYWluWzFdOwogIH0KICByZXR1cm4gZG9tYWluWzBdOwp9OwpmdW5jdGlvbiBjb21wdXRlQXJlYShfcmVmMCkgewogIHZhciB7CiAgICBhcmVhU2V0dGluZ3M6IHsKICAgICAgY29ubmVjdE51bGxzLAogICAgICBiYXNlVmFsdWU6IGl0ZW1CYXNlVmFsdWUsCiAgICAgIGRhdGFLZXkKICAgIH0sCiAgICBzdGFja2VkRGF0YSwKICAgIGxheW91dCwKICAgIGNoYXJ0QmFzZVZhbHVlLAogICAgeEF4aXMsCiAgICB5QXhpcywKICAgIGRpc3BsYXllZERhdGEsCiAgICBkYXRhU3RhcnRJbmRleCwKICAgIHhBeGlzVGlja3MsCiAgICB5QXhpc1RpY2tzLAogICAgYmFuZFNpemUKICB9ID0gX3JlZjA7CiAgdmFyIGhhc1N0YWNrID0gc3RhY2tlZERhdGEgJiYgc3RhY2tlZERhdGEubGVuZ3RoOwogIHZhciBiYXNlVmFsdWUgPSBnZXRCYXNlVmFsdWUobGF5b3V0LCBjaGFydEJhc2VWYWx1ZSwgaXRlbUJhc2VWYWx1ZSwgeEF4aXMsIHlBeGlzKTsKICB2YXIgaXNIb3Jpem9udGFsTGF5b3V0ID0gbGF5b3V0ID09PSAiaG9yaXpvbnRhbCI7CiAgdmFyIGlzUmFuZ2UgPSBmYWxzZTsKICB2YXIgcG9pbnRzID0gZGlzcGxheWVkRGF0YS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgdmFyIHZhbHVlOwogICAgaWYgKGhhc1N0YWNrKSB7CiAgICAgIHZhbHVlID0gc3RhY2tlZERhdGFbZGF0YVN0YXJ0SW5kZXggKyBpbmRleF07CiAgICB9IGVsc2UgewogICAgICB2YWx1ZSA9IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCBkYXRhS2V5KTsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHZhbHVlID0gW2Jhc2VWYWx1ZSwgdmFsdWVdOwogICAgICB9IGVsc2UgewogICAgICAgIGlzUmFuZ2UgPSB0cnVlOwogICAgICB9CiAgICB9CiAgICB2YXIgaXNCcmVha1BvaW50ID0gdmFsdWVbMV0gPT0gbnVsbCB8fCBoYXNTdGFjayAmJiAhY29ubmVjdE51bGxzICYmIGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCBkYXRhS2V5KSA9PSBudWxsOwogICAgaWYgKGlzSG9yaXpvbnRhbExheW91dCkgewogICAgICByZXR1cm4gewogICAgICAgIHg6IGdldENhdGVDb29yZGluYXRlT2ZMaW5lKHsKICAgICAgICAgIGF4aXM6IHhBeGlzLAogICAgICAgICAgdGlja3M6IHhBeGlzVGlja3MsCiAgICAgICAgICBiYW5kU2l6ZSwKICAgICAgICAgIGVudHJ5LAogICAgICAgICAgaW5kZXgKICAgICAgICB9KSwKICAgICAgICB5OiBpc0JyZWFrUG9pbnQgPyBudWxsIDogeUF4aXMuc2NhbGUodmFsdWVbMV0pLAogICAgICAgIHZhbHVlLAogICAgICAgIHBheWxvYWQ6IGVudHJ5CiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gewogICAgICB4OiBpc0JyZWFrUG9pbnQgPyBudWxsIDogeEF4aXMuc2NhbGUodmFsdWVbMV0pLAogICAgICB5OiBnZXRDYXRlQ29vcmRpbmF0ZU9mTGluZSh7CiAgICAgICAgYXhpczogeUF4aXMsCiAgICAgICAgdGlja3M6IHlBeGlzVGlja3MsCiAgICAgICAgYmFuZFNpemUsCiAgICAgICAgZW50cnksCiAgICAgICAgaW5kZXgKICAgICAgfSksCiAgICAgIHZhbHVlLAogICAgICBwYXlsb2FkOiBlbnRyeQogICAgfTsKICB9KTsKICB2YXIgYmFzZUxpbmU7CiAgaWYgKGhhc1N0YWNrIHx8IGlzUmFuZ2UpIHsKICAgIGJhc2VMaW5lID0gcG9pbnRzLm1hcCgoZW50cnkpID0+IHsKICAgICAgdmFyIHgyID0gQXJyYXkuaXNBcnJheShlbnRyeS52YWx1ZSkgPyBlbnRyeS52YWx1ZVswXSA6IG51bGw7CiAgICAgIGlmIChpc0hvcml6b250YWxMYXlvdXQpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgeDogZW50cnkueCwKICAgICAgICAgIHk6IHgyICE9IG51bGwgJiYgZW50cnkueSAhPSBudWxsID8geUF4aXMuc2NhbGUoeDIpIDogbnVsbCwKICAgICAgICAgIHBheWxvYWQ6IGVudHJ5LnBheWxvYWQKICAgICAgICB9OwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogeDIgIT0gbnVsbCA/IHhBeGlzLnNjYWxlKHgyKSA6IG51bGwsCiAgICAgICAgeTogZW50cnkueSwKICAgICAgICBwYXlsb2FkOiBlbnRyeS5wYXlsb2FkCiAgICAgIH07CiAgICB9KTsKICB9IGVsc2UgewogICAgYmFzZUxpbmUgPSBpc0hvcml6b250YWxMYXlvdXQgPyB5QXhpcy5zY2FsZShiYXNlVmFsdWUpIDogeEF4aXMuc2NhbGUoYmFzZVZhbHVlKTsKICB9CiAgcmV0dXJuIHsKICAgIHBvaW50cywKICAgIGJhc2VMaW5lLAogICAgaXNSYW5nZQogIH07Cn0KZnVuY3Rpb24gQXJlYUZuKG91dHNpZGVQcm9wcykgewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCBkZWZhdWx0QXJlYVByb3BzKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChSZWdpc3RlckdyYXBoaWNhbEl0ZW1JZCwgewogICAgaWQ6IHByb3BzLmlkLAogICAgdHlwZTogImFyZWEiCiAgfSwgKGlkKSA9PiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFJlYWN0MjYuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoU2V0TGVnZW5kUGF5bG9hZCwgewogICAgbGVnZW5kUGF5bG9hZDogY29tcHV0ZUxlZ2VuZFBheWxvYWRGcm9tQXJlYURhdGEocHJvcHMpCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoU2V0QXJlYVRvb2x0aXBFbnRyeVNldHRpbmdzLCB7CiAgICBkYXRhS2V5OiBwcm9wcy5kYXRhS2V5LAogICAgZGF0YTogcHJvcHMuZGF0YSwKICAgIHN0cm9rZTogcHJvcHMuc3Ryb2tlLAogICAgc3Ryb2tlV2lkdGg6IHByb3BzLnN0cm9rZVdpZHRoLAogICAgZmlsbDogcHJvcHMuZmlsbCwKICAgIG5hbWU6IHByb3BzLm5hbWUsCiAgICBoaWRlOiBwcm9wcy5oaWRlLAogICAgdW5pdDogcHJvcHMudW5pdCwKICAgIHRvb2x0aXBUeXBlOiBwcm9wcy50b29sdGlwVHlwZQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFNldENhcnRlc2lhbkdyYXBoaWNhbEl0ZW0sIHsKICAgIHR5cGU6ICJhcmVhIiwKICAgIGlkLAogICAgZGF0YTogcHJvcHMuZGF0YSwKICAgIGRhdGFLZXk6IHByb3BzLmRhdGFLZXksCiAgICB4QXhpc0lkOiBwcm9wcy54QXhpc0lkLAogICAgeUF4aXNJZDogcHJvcHMueUF4aXNJZCwKICAgIHpBeGlzSWQ6IDAsCiAgICBzdGFja0lkOiBnZXROb3JtYWxpemVkU3RhY2tJZChwcm9wcy5zdGFja0lkKSwKICAgIGhpZGU6IHByb3BzLmhpZGUsCiAgICBiYXJTaXplOiB2b2lkIDAsCiAgICBiYXNlVmFsdWU6IHByb3BzLmJhc2VWYWx1ZSwKICAgIGlzUGFub3JhbWEsCiAgICBjb25uZWN0TnVsbHM6IHByb3BzLmNvbm5lY3ROdWxscwogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEFyZWFJbXBsLCBfZXh0ZW5kczE3KHt9LCBwcm9wcywgewogICAgaWQKICB9KSkpKTsKfQp2YXIgQXJlYSA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2Lm1lbW8oQXJlYUZuLCBwcm9wc0FyZUVxdWFsKTsKQXJlYS5kaXNwbGF5TmFtZSA9ICJBcmVhIjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9YQXhpcy5qcwp2YXIgUmVhY3QyNyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9heGlzUHJvcHNBcmVFcXVhbC5qcwp2YXIgX2V4Y2x1ZGVkMTMgPSBbImRvbWFpbiIsICJyYW5nZSJdOwp2YXIgX2V4Y2x1ZGVkMjcgPSBbImRvbWFpbiIsICJyYW5nZSJdOwpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMyhlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTMoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTEzKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBzaG9ydEFycmF5c0FyZUVxdWFsKGFycjEsIGFycjIpIHsKICBpZiAoYXJyMSA9PT0gYXJyMikgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGlmIChBcnJheS5pc0FycmF5KGFycjEpICYmIGFycjEubGVuZ3RoID09PSAyICYmIEFycmF5LmlzQXJyYXkoYXJyMikgJiYgYXJyMi5sZW5ndGggPT09IDIpIHsKICAgIHJldHVybiBhcnIxWzBdID09PSBhcnIyWzBdICYmIGFycjFbMV0gPT09IGFycjJbMV07CiAgfQogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBheGlzUHJvcHNBcmVFcXVhbChwcmV2UHJvcHMsIG5leHRQcm9wcykgewogIGlmIChwcmV2UHJvcHMgPT09IG5leHRQcm9wcykgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHZhciB7CiAgICBkb21haW46IHByZXZEb21haW4sCiAgICByYW5nZTogcHJldlJhbmdlCiAgfSA9IHByZXZQcm9wcywgcHJldlJlc3QgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMyhwcmV2UHJvcHMsIF9leGNsdWRlZDEzKTsKICB2YXIgewogICAgZG9tYWluOiBuZXh0RG9tYWluLAogICAgcmFuZ2U6IG5leHRSYW5nZQogIH0gPSBuZXh0UHJvcHMsIG5leHRSZXN0ID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTMobmV4dFByb3BzLCBfZXhjbHVkZWQyNyk7CiAgaWYgKCFzaG9ydEFycmF5c0FyZUVxdWFsKHByZXZEb21haW4sIG5leHREb21haW4pKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGlmICghc2hvcnRBcnJheXNBcmVFcXVhbChwcmV2UmFuZ2UsIG5leHRSYW5nZSkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIHByb3BzQXJlRXF1YWwocHJldlJlc3QsIG5leHRSZXN0KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL1hBeGlzLmpzCnZhciBfZXhjbHVkZWQxNCA9IFsiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLCAidGlja3MiXTsKdmFyIF9leGNsdWRlZDI4ID0gWyJpZCJdOwpmdW5jdGlvbiBfZXh0ZW5kczE4KCkgewogIHJldHVybiBfZXh0ZW5kczE4ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxOC5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczE0KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxNChlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTQocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIFNldFhBeGlzU2V0dGluZ3Moc2V0dGluZ3MpIHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBwcmV2U2V0dGluZ3NSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MzkudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0MzkudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgZGlzcGF0Y2goYWRkWEF4aXMoc2V0dGluZ3MpKTsKICAgIH0gZWxzZSBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgIT09IHNldHRpbmdzKSB7CiAgICAgIGRpc3BhdGNoKHJlcGxhY2VYQXhpcyh7CiAgICAgICAgcHJldjogcHJldlNldHRpbmdzUmVmLmN1cnJlbnQsCiAgICAgICAgbmV4dDogc2V0dGluZ3MKICAgICAgfSkpOwogICAgfQogICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSBzZXR0aW5nczsKICB9LCBbc2V0dGluZ3MsIGRpc3BhdGNoXSk7CiAgKDAsIGltcG9ydF9yZWFjdDM5LnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSB7CiAgICAgICAgZGlzcGF0Y2gocmVtb3ZlWEF4aXMocHJldlNldHRpbmdzUmVmLmN1cnJlbnQpKTsKICAgICAgICBwcmV2U2V0dGluZ3NSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn0KdmFyIFhBeGlzSW1wbCA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICB4QXhpc0lkLAogICAgY2xhc3NOYW1lCiAgfSA9IHByb3BzOwogIHZhciB2aWV3Qm94ID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0QXhpc1ZpZXdCb3gpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciBheGlzVHlwZSA9ICJ4QXhpcyI7CiAgdmFyIHNjYWxlID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBeGlzU2NhbGUoc3RhdGUsIGF4aXNUeXBlLCB4QXhpc0lkLCBpc1Bhbm9yYW1hKSk7CiAgdmFyIGNhcnRlc2lhblRpY2tJdGVtcyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0VGlja3NPZkF4aXMoc3RhdGUsIGF4aXNUeXBlLCB4QXhpc0lkLCBpc1Bhbm9yYW1hKSk7CiAgdmFyIGF4aXNTaXplID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RYQXhpc1NpemUoc3RhdGUsIHhBeGlzSWQpKTsKICB2YXIgcG9zaXRpb24gPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFhBeGlzUG9zaXRpb24oc3RhdGUsIHhBeGlzSWQpKTsKICB2YXIgc3luY2hyb25pemVkU2V0dGluZ3MgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFhBeGlzU2V0dGluZ3NOb0RlZmF1bHRzKHN0YXRlLCB4QXhpc0lkKSk7CiAgaWYgKGF4aXNTaXplID09IG51bGwgfHwgcG9zaXRpb24gPT0gbnVsbCB8fCBzeW5jaHJvbml6ZWRTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MLAogICAgdGlja3M6IHRpY2tzMgogIH0gPSBwcm9wcywgYWxsT3RoZXJQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczE0KHByb3BzLCBfZXhjbHVkZWQxNCk7CiAgdmFyIHsKICAgIGlkCiAgfSA9IHN5bmNocm9uaXplZFNldHRpbmdzLCByZXN0U3luY2hyb25pemVkU2V0dGluZ3MgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNChzeW5jaHJvbml6ZWRTZXR0aW5ncywgX2V4Y2x1ZGVkMjgpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkF4aXMsIF9leHRlbmRzMTgoe30sIGFsbE90aGVyUHJvcHMsIHJlc3RTeW5jaHJvbml6ZWRTZXR0aW5ncywgewogICAgc2NhbGUsCiAgICB4OiBwb3NpdGlvbi54LAogICAgeTogcG9zaXRpb24ueSwKICAgIHdpZHRoOiBheGlzU2l6ZS53aWR0aCwKICAgIGhlaWdodDogYXhpc1NpemUuaGVpZ2h0LAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy0iLmNvbmNhdChheGlzVHlwZSwgIiAiKS5jb25jYXQoYXhpc1R5cGUpLCBjbGFzc05hbWUpLAogICAgdmlld0JveCwKICAgIHRpY2tzOiBjYXJ0ZXNpYW5UaWNrSXRlbXMsCiAgICBheGlzVHlwZQogIH0pKTsKfTsKdmFyIHhBeGlzRGVmYXVsdFByb3BzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBpbXBsaWNpdFhBeGlzLmFsbG93RGF0YU92ZXJmbG93LAogIGFsbG93RGVjaW1hbHM6IGltcGxpY2l0WEF4aXMuYWxsb3dEZWNpbWFscywKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogaW1wbGljaXRYQXhpcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICBhbmdsZTogaW1wbGljaXRYQXhpcy5hbmdsZSwKICBheGlzTGluZTogZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcy5heGlzTGluZSwKICBoZWlnaHQ6IGltcGxpY2l0WEF4aXMuaGVpZ2h0LAogIGhpZGU6IGZhbHNlLAogIGluY2x1ZGVIaWRkZW46IGltcGxpY2l0WEF4aXMuaW5jbHVkZUhpZGRlbiwKICBpbnRlcnZhbDogaW1wbGljaXRYQXhpcy5pbnRlcnZhbCwKICBtaW5UaWNrR2FwOiBpbXBsaWNpdFhBeGlzLm1pblRpY2tHYXAsCiAgbWlycm9yOiBpbXBsaWNpdFhBeGlzLm1pcnJvciwKICBvcmllbnRhdGlvbjogaW1wbGljaXRYQXhpcy5vcmllbnRhdGlvbiwKICBwYWRkaW5nOiBpbXBsaWNpdFhBeGlzLnBhZGRpbmcsCiAgcmV2ZXJzZWQ6IGltcGxpY2l0WEF4aXMucmV2ZXJzZWQsCiAgc2NhbGU6IGltcGxpY2l0WEF4aXMuc2NhbGUsCiAgdGljazogaW1wbGljaXRYQXhpcy50aWNrLAogIHRpY2tDb3VudDogaW1wbGljaXRYQXhpcy50aWNrQ291bnQsCiAgdGlja0xpbmU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMudGlja0xpbmUsCiAgdGlja1NpemU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMudGlja1NpemUsCiAgdHlwZTogaW1wbGljaXRYQXhpcy50eXBlLAogIHhBeGlzSWQ6IDAKfTsKdmFyIFhBeGlzU2V0dGluZ3NEaXNwYXRjaGVyID0gKG91dHNpZGVQcm9wcykgPT4gewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCB4QXhpc0RlZmF1bHRQcm9wcyk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoUmVhY3QyNy5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChTZXRYQXhpc1NldHRpbmdzLCB7CiAgICBhbGxvd0RhdGFPdmVyZmxvdzogcHJvcHMuYWxsb3dEYXRhT3ZlcmZsb3csCiAgICBhbGxvd0RlY2ltYWxzOiBwcm9wcy5hbGxvd0RlY2ltYWxzLAogICAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IHByb3BzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogICAgYW5nbGU6IHByb3BzLmFuZ2xlLAogICAgZGF0YUtleTogcHJvcHMuZGF0YUtleSwKICAgIGRvbWFpbjogcHJvcHMuZG9tYWluLAogICAgaGVpZ2h0OiBwcm9wcy5oZWlnaHQsCiAgICBoaWRlOiBwcm9wcy5oaWRlLAogICAgaWQ6IHByb3BzLnhBeGlzSWQsCiAgICBpbmNsdWRlSGlkZGVuOiBwcm9wcy5pbmNsdWRlSGlkZGVuLAogICAgaW50ZXJ2YWw6IHByb3BzLmludGVydmFsLAogICAgbWluVGlja0dhcDogcHJvcHMubWluVGlja0dhcCwKICAgIG1pcnJvcjogcHJvcHMubWlycm9yLAogICAgbmFtZTogcHJvcHMubmFtZSwKICAgIG9yaWVudGF0aW9uOiBwcm9wcy5vcmllbnRhdGlvbiwKICAgIHBhZGRpbmc6IHByb3BzLnBhZGRpbmcsCiAgICByZXZlcnNlZDogcHJvcHMucmV2ZXJzZWQsCiAgICBzY2FsZTogcHJvcHMuc2NhbGUsCiAgICB0aWNrOiBwcm9wcy50aWNrLAogICAgdGlja0NvdW50OiBwcm9wcy50aWNrQ291bnQsCiAgICB0aWNrRm9ybWF0dGVyOiBwcm9wcy50aWNrRm9ybWF0dGVyLAogICAgdGlja3M6IHByb3BzLnRpY2tzLAogICAgdHlwZTogcHJvcHMudHlwZSwKICAgIHVuaXQ6IHByb3BzLnVuaXQKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChYQXhpc0ltcGwsIHByb3BzKSk7Cn07CnZhciBYQXhpcyA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3Lm1lbW8oWEF4aXNTZXR0aW5nc0Rpc3BhdGNoZXIsIGF4aXNQcm9wc0FyZUVxdWFsKTsKWEF4aXMuZGlzcGxheU5hbWUgPSAiWEF4aXMiOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL1lBeGlzLmpzCnZhciBSZWFjdDI4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NDAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQxNSA9IFsiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLCAidGlja3MiXTsKdmFyIF9leGNsdWRlZDI5ID0gWyJpZCJdOwpmdW5jdGlvbiBfZXh0ZW5kczE5KCkgewogIHJldHVybiBfZXh0ZW5kczE5ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxOS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczE1KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxNShlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTUocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIFNldFlBeGlzU2V0dGluZ3Moc2V0dGluZ3MpIHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBwcmV2U2V0dGluZ3NSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDAudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0NDAudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgZGlzcGF0Y2goYWRkWUF4aXMoc2V0dGluZ3MpKTsKICAgIH0gZWxzZSBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgIT09IHNldHRpbmdzKSB7CiAgICAgIGRpc3BhdGNoKHJlcGxhY2VZQXhpcyh7CiAgICAgICAgcHJldjogcHJldlNldHRpbmdzUmVmLmN1cnJlbnQsCiAgICAgICAgbmV4dDogc2V0dGluZ3MKICAgICAgfSkpOwogICAgfQogICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSBzZXR0aW5nczsKICB9LCBbc2V0dGluZ3MsIGRpc3BhdGNoXSk7CiAgKDAsIGltcG9ydF9yZWFjdDQwLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSB7CiAgICAgICAgZGlzcGF0Y2gocmVtb3ZlWUF4aXMocHJldlNldHRpbmdzUmVmLmN1cnJlbnQpKTsKICAgICAgICBwcmV2U2V0dGluZ3NSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn0KdmFyIFlBeGlzSW1wbCA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICB5QXhpc0lkLAogICAgY2xhc3NOYW1lLAogICAgd2lkdGgsCiAgICBsYWJlbAogIH0gPSBwcm9wczsKICB2YXIgY2FydGVzaWFuQXhpc1JlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0MC51c2VSZWYpKG51bGwpOwogIHZhciBsYWJlbFJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0MC51c2VSZWYpKG51bGwpOwogIHZhciB2aWV3Qm94ID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0QXhpc1ZpZXdCb3gpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGF4aXNUeXBlID0gInlBeGlzIjsKICB2YXIgc2NhbGUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEF4aXNTY2FsZShzdGF0ZSwgYXhpc1R5cGUsIHlBeGlzSWQsIGlzUGFub3JhbWEpKTsKICB2YXIgYXhpc1NpemUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFlBeGlzU2l6ZShzdGF0ZSwgeUF4aXNJZCkpOwogIHZhciBwb3NpdGlvbiA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WUF4aXNQb3NpdGlvbihzdGF0ZSwgeUF4aXNJZCkpOwogIHZhciBjYXJ0ZXNpYW5UaWNrSXRlbXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFRpY2tzT2ZBeGlzKHN0YXRlLCBheGlzVHlwZSwgeUF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIHZhciBzeW5jaHJvbml6ZWRTZXR0aW5ncyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WUF4aXNTZXR0aW5nc05vRGVmYXVsdHMoc3RhdGUsIHlBeGlzSWQpKTsKICAoMCwgaW1wb3J0X3JlYWN0NDAudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAod2lkdGggIT09ICJhdXRvIiB8fCAhYXhpc1NpemUgfHwgaXNMYWJlbENvbnRlbnRBRnVuY3Rpb24obGFiZWwpIHx8IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDAuaXNWYWxpZEVsZW1lbnQpKGxhYmVsKSB8fCBzeW5jaHJvbml6ZWRTZXR0aW5ncyA9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBheGlzQ29tcG9uZW50ID0gY2FydGVzaWFuQXhpc1JlZi5jdXJyZW50OwogICAgaWYgKCFheGlzQ29tcG9uZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciB1cGRhdGVkWUF4aXNXaWR0aCA9IGF4aXNDb21wb25lbnQuZ2V0Q2FsY3VsYXRlZFdpZHRoKCk7CiAgICBpZiAoTWF0aC5yb3VuZChheGlzU2l6ZS53aWR0aCkgIT09IE1hdGgucm91bmQodXBkYXRlZFlBeGlzV2lkdGgpKSB7CiAgICAgIGRpc3BhdGNoKHVwZGF0ZVlBeGlzV2lkdGgoewogICAgICAgIGlkOiB5QXhpc0lkLAogICAgICAgIHdpZHRoOiB1cGRhdGVkWUF4aXNXaWR0aAogICAgICB9KSk7CiAgICB9CiAgfSwgWwogICAgLy8gVGhlIGRlcGVuZGVuY3kgb24gY2FydGVzaWFuQXhpc1JlZi5jdXJyZW50IGlzIG5vdCBuZWVkZWQgYmVjYXVzZSB1c2VMYXlvdXRFZmZlY3Qgd2lsbCBydW4gYWZ0ZXIgZXZlcnkgcmVuZGVyLgogICAgLy8gVGhlIHJlZiB3aWxsIGJlIHBvcHVsYXRlZCBieSB0aGVuLgogICAgLy8gVG8gcmUtcnVuIHRoaXMgZWZmZWN0IHdoZW4gdGlja3MgY2hhbmdlLCB3ZSBjYW4gZGVwZW5kIG9uIHRoZSB0aWNrcyBhcnJheSBmcm9tIHRoZSBzdG9yZS4KICAgIGNhcnRlc2lhblRpY2tJdGVtcywKICAgIGF4aXNTaXplLAogICAgZGlzcGF0Y2gsCiAgICBsYWJlbCwKICAgIHlBeGlzSWQsCiAgICB3aWR0aCwKICAgIHN5bmNocm9uaXplZFNldHRpbmdzCiAgXSk7CiAgaWYgKGF4aXNTaXplID09IG51bGwgfHwgcG9zaXRpb24gPT0gbnVsbCB8fCBzeW5jaHJvbml6ZWRTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MLAogICAgdGlja3M6IHRpY2tzMgogIH0gPSBwcm9wcywgYWxsT3RoZXJQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczE1KHByb3BzLCBfZXhjbHVkZWQxNSk7CiAgdmFyIHsKICAgIGlkCiAgfSA9IHN5bmNocm9uaXplZFNldHRpbmdzLCByZXN0U3luY2hyb25pemVkU2V0dGluZ3MgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNShzeW5jaHJvbml6ZWRTZXR0aW5ncywgX2V4Y2x1ZGVkMjkpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyOC5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkF4aXMsIF9leHRlbmRzMTkoe30sIGFsbE90aGVyUHJvcHMsIHJlc3RTeW5jaHJvbml6ZWRTZXR0aW5ncywgewogICAgcmVmOiBjYXJ0ZXNpYW5BeGlzUmVmLAogICAgbGFiZWxSZWYsCiAgICBzY2FsZSwKICAgIHg6IHBvc2l0aW9uLngsCiAgICB5OiBwb3NpdGlvbi55LAogICAgdGlja1RleHRQcm9wczogd2lkdGggPT09ICJhdXRvIiA/IHsKICAgICAgd2lkdGg6IHZvaWQgMAogICAgfSA6IHsKICAgICAgd2lkdGgKICAgIH0sCiAgICB3aWR0aDogYXhpc1NpemUud2lkdGgsCiAgICBoZWlnaHQ6IGF4aXNTaXplLmhlaWdodCwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtIi5jb25jYXQoYXhpc1R5cGUsICIgIikuY29uY2F0KGF4aXNUeXBlKSwgY2xhc3NOYW1lKSwKICAgIHZpZXdCb3gsCiAgICB0aWNrczogY2FydGVzaWFuVGlja0l0ZW1zLAogICAgYXhpc1R5cGUKICB9KSk7Cn07CnZhciB5QXhpc0RlZmF1bHRQcm9wcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogaW1wbGljaXRZQXhpcy5hbGxvd0RhdGFPdmVyZmxvdywKICBhbGxvd0RlY2ltYWxzOiBpbXBsaWNpdFlBeGlzLmFsbG93RGVjaW1hbHMsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGltcGxpY2l0WUF4aXMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgYW5nbGU6IGltcGxpY2l0WUF4aXMuYW5nbGUsCiAgYXhpc0xpbmU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMuYXhpc0xpbmUsCiAgaGlkZTogZmFsc2UsCiAgaW5jbHVkZUhpZGRlbjogaW1wbGljaXRZQXhpcy5pbmNsdWRlSGlkZGVuLAogIGludGVydmFsOiBpbXBsaWNpdFlBeGlzLmludGVydmFsLAogIG1pblRpY2tHYXA6IGltcGxpY2l0WUF4aXMubWluVGlja0dhcCwKICBtaXJyb3I6IGltcGxpY2l0WUF4aXMubWlycm9yLAogIG9yaWVudGF0aW9uOiBpbXBsaWNpdFlBeGlzLm9yaWVudGF0aW9uLAogIHBhZGRpbmc6IGltcGxpY2l0WUF4aXMucGFkZGluZywKICByZXZlcnNlZDogaW1wbGljaXRZQXhpcy5yZXZlcnNlZCwKICBzY2FsZTogaW1wbGljaXRZQXhpcy5zY2FsZSwKICB0aWNrOiBpbXBsaWNpdFlBeGlzLnRpY2ssCiAgdGlja0NvdW50OiBpbXBsaWNpdFlBeGlzLnRpY2tDb3VudCwKICB0aWNrTGluZTogZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcy50aWNrTGluZSwKICB0aWNrU2l6ZTogZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcy50aWNrU2l6ZSwKICB0eXBlOiBpbXBsaWNpdFlBeGlzLnR5cGUsCiAgd2lkdGg6IGltcGxpY2l0WUF4aXMud2lkdGgsCiAgeUF4aXNJZDogMAp9Owp2YXIgWUF4aXNTZXR0aW5nc0Rpc3BhdGNoZXIgPSAob3V0c2lkZVByb3BzKSA9PiB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIHlBeGlzRGVmYXVsdFByb3BzKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChSZWFjdDI4LkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyOC5jcmVhdGVFbGVtZW50KFNldFlBeGlzU2V0dGluZ3MsIHsKICAgIGludGVydmFsOiBwcm9wcy5pbnRlcnZhbCwKICAgIGlkOiBwcm9wcy55QXhpc0lkLAogICAgc2NhbGU6IHByb3BzLnNjYWxlLAogICAgdHlwZTogcHJvcHMudHlwZSwKICAgIGRvbWFpbjogcHJvcHMuZG9tYWluLAogICAgYWxsb3dEYXRhT3ZlcmZsb3c6IHByb3BzLmFsbG93RGF0YU92ZXJmbG93LAogICAgZGF0YUtleTogcHJvcHMuZGF0YUtleSwKICAgIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBwcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICAgIGFsbG93RGVjaW1hbHM6IHByb3BzLmFsbG93RGVjaW1hbHMsCiAgICB0aWNrQ291bnQ6IHByb3BzLnRpY2tDb3VudCwKICAgIHBhZGRpbmc6IHByb3BzLnBhZGRpbmcsCiAgICBpbmNsdWRlSGlkZGVuOiBwcm9wcy5pbmNsdWRlSGlkZGVuLAogICAgcmV2ZXJzZWQ6IHByb3BzLnJldmVyc2VkLAogICAgdGlja3M6IHByb3BzLnRpY2tzLAogICAgd2lkdGg6IHByb3BzLndpZHRoLAogICAgb3JpZW50YXRpb246IHByb3BzLm9yaWVudGF0aW9uLAogICAgbWlycm9yOiBwcm9wcy5taXJyb3IsCiAgICBoaWRlOiBwcm9wcy5oaWRlLAogICAgdW5pdDogcHJvcHMudW5pdCwKICAgIG5hbWU6IHByb3BzLm5hbWUsCiAgICBhbmdsZTogcHJvcHMuYW5nbGUsCiAgICBtaW5UaWNrR2FwOiBwcm9wcy5taW5UaWNrR2FwLAogICAgdGljazogcHJvcHMudGljaywKICAgIHRpY2tGb3JtYXR0ZXI6IHByb3BzLnRpY2tGb3JtYXR0ZXIKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChZQXhpc0ltcGwsIHByb3BzKSk7Cn07CnZhciBZQXhpcyA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI4Lm1lbW8oWUF4aXNTZXR0aW5nc0Rpc3BhdGNoZXIsIGF4aXNQcm9wc0FyZUVxdWFsKTsKWUF4aXMuZGlzcGxheU5hbWUgPSAiWUF4aXMiOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvQ2FydGVzaWFuQ2hhcnQuanMKdmFyIFJlYWN0MzQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0OSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1JlY2hhcnRzU3RvcmVQcm92aWRlci5qcwp2YXIgUmVhY3QyOSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQxID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdEFjdGl2ZVByb3BzRnJvbUNoYXJ0UG9pbnRlci5qcwp2YXIgcGlja0NoYXJ0UG9pbnRlciA9IChfc3RhdGUsIGNoYXJ0UG9pbnRlcikgPT4gY2hhcnRQb2ludGVyOwp2YXIgc2VsZWN0QWN0aXZlUHJvcHNGcm9tQ2hhcnRQb2ludGVyID0gY3JlYXRlU2VsZWN0b3IoW3BpY2tDaGFydFBvaW50ZXIsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RQb2xhclZpZXdCb3gsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZVdpdGhSZXZlcnNlLCBzZWxlY3RUb29sdGlwQXhpc1RpY2tzLCBzZWxlY3RPcmRlcmVkVG9vbHRpcFRpY2tzLCBzZWxlY3RDaGFydE9mZnNldEludGVybmFsXSwgY29tYmluZUFjdGl2ZVByb3BzKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZ2V0Q2hhcnRQb2ludGVyLmpzCnZhciBnZXRDaGFydFBvaW50ZXIgPSAoZXZlbnQpID0+IHsKICB2YXIgcmVjdCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgdmFyIHNjYWxlWCA9IHJlY3Qud2lkdGggLyBldmVudC5jdXJyZW50VGFyZ2V0Lm9mZnNldFdpZHRoOwogIHZhciBzY2FsZVkgPSByZWN0LmhlaWdodCAvIGV2ZW50LmN1cnJlbnRUYXJnZXQub2Zmc2V0SGVpZ2h0OwogIHJldHVybiB7CiAgICAvKgogICAgICogSGVyZSBpdCdzIGltcG9ydGFudCB0byB1c2U6CiAgICAgKiAtIGV2ZW50LmNsaWVudFggYW5kIGV2ZW50LmNsaWVudFkgdG8gZ2V0IHRoZSBtb3VzZSBwb3NpdGlvbiByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnQsIGluY2x1ZGluZyBzY3JvbGwuCiAgICAgKiAtIHBhZ2VYIGFuZCBwYWdlWSBhcmUgbm90IHVzZWQgYmVjYXVzZSB0aGV5IGFyZSByZWxhdGl2ZSB0byB0aGUgd2hvbGUgZG9jdW1lbnQsIGFuZCBpZ25vcmUgc2Nyb2xsLgogICAgICogLSByZWN0LmxlZnQgYW5kIHJlY3QudG9wIGFyZSB1c2VkIHRvIGdldCB0aGUgcG9zaXRpb24gb2YgdGhlIGNoYXJ0IHJlbGF0aXZlIHRvIHRoZSB2aWV3cG9ydC4KICAgICAqIC0gb2Zmc2V0WCBhbmQgb2Zmc2V0WSBhcmUgbm90IHVzZWQgYmVjYXVzZSB0aGV5IGFyZSByZWxhdGl2ZSB0byB0aGUgb2Zmc2V0IHBhcmVudAogICAgICogIHdoaWNoIG1heSBvciBtYXkgbm90IGJlIHRoZSBzYW1lIGFzIHRoZSBjbGllbnRYIGFuZCBjbGllbnRZLCBkZXBlbmRpbmcgb24gdGhlIHBvc2l0aW9uIG9mIHRoZSBjaGFydCBpbiB0aGUgRE9NCiAgICAgKiAgYW5kIHN1cnJvdW5kaW5nIGVsZW1lbnQgc3R5bGVzLiBDU1MgcG9zaXRpb246IHJlbGF0aXZlLCBhYnNvbHV0ZSwgZml4ZWQsIHdpbGwgY2hhbmdlIHRoZSBvZmZzZXQgcGFyZW50LgogICAgICogLSBzY2FsZVggYW5kIHNjYWxlWSBhcmUgbmVjZXNzYXJ5IGZvciB3aGVuIHRoZSBjaGFydCBlbGVtZW50IGlzIHNjYWxlZCB1c2luZyBDU1MgYHRyYW5zZm9ybTogc2NhbGUoTilgLgogICAgICovCiAgICBjaGFydFg6IE1hdGgucm91bmQoKGV2ZW50LmNsaWVudFggLSByZWN0LmxlZnQpIC8gc2NhbGVYKSwKICAgIGNoYXJ0WTogTWF0aC5yb3VuZCgoZXZlbnQuY2xpZW50WSAtIHJlY3QudG9wKSAvIHNjYWxlWSkKICB9Owp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvbW91c2VFdmVudHNNaWRkbGV3YXJlLmpzCnZhciBtb3VzZUNsaWNrQWN0aW9uID0gY3JlYXRlQWN0aW9uKCJtb3VzZUNsaWNrIik7CnZhciBtb3VzZUNsaWNrTWlkZGxld2FyZSA9IGNyZWF0ZUxpc3RlbmVyTWlkZGxld2FyZSgpOwptb3VzZUNsaWNrTWlkZGxld2FyZS5zdGFydExpc3RlbmluZyh7CiAgYWN0aW9uQ3JlYXRvcjogbW91c2VDbGlja0FjdGlvbiwKICBlZmZlY3Q6IChhY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICB2YXIgbW91c2VQb2ludGVyID0gYWN0aW9uLnBheWxvYWQ7CiAgICB2YXIgYWN0aXZlUHJvcHMgPSBzZWxlY3RBY3RpdmVQcm9wc0Zyb21DaGFydFBvaW50ZXIobGlzdGVuZXJBcGkuZ2V0U3RhdGUoKSwgZ2V0Q2hhcnRQb2ludGVyKG1vdXNlUG9pbnRlcikpOwogICAgaWYgKChhY3RpdmVQcm9wcyA9PT0gbnVsbCB8fCBhY3RpdmVQcm9wcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgpICE9IG51bGwpIHsKICAgICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0TW91c2VDbGlja0F4aXNJbmRleCh7CiAgICAgICAgYWN0aXZlSW5kZXg6IGFjdGl2ZVByb3BzLmFjdGl2ZUluZGV4LAogICAgICAgIGFjdGl2ZURhdGFLZXk6IHZvaWQgMCwKICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBhY3RpdmVQcm9wcy5hY3RpdmVDb29yZGluYXRlCiAgICAgIH0pKTsKICAgIH0KICB9Cn0pOwp2YXIgbW91c2VNb3ZlQWN0aW9uID0gY3JlYXRlQWN0aW9uKCJtb3VzZU1vdmUiKTsKdmFyIG1vdXNlTW92ZU1pZGRsZXdhcmUgPSBjcmVhdGVMaXN0ZW5lck1pZGRsZXdhcmUoKTsKdmFyIHJhZklkID0gbnVsbDsKbW91c2VNb3ZlTWlkZGxld2FyZS5zdGFydExpc3RlbmluZyh7CiAgYWN0aW9uQ3JlYXRvcjogbW91c2VNb3ZlQWN0aW9uLAogIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgIHZhciBtb3VzZVBvaW50ZXIgPSBhY3Rpb24ucGF5bG9hZDsKICAgIGlmIChyYWZJZCAhPT0gbnVsbCkgewogICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShyYWZJZCk7CiAgICB9CiAgICB2YXIgY2hhcnRQb2ludGVyID0gZ2V0Q2hhcnRQb2ludGVyKG1vdXNlUG9pbnRlcik7CiAgICByYWZJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7CiAgICAgIHZhciBzdGF0ZSA9IGxpc3RlbmVyQXBpLmdldFN0YXRlKCk7CiAgICAgIHZhciB0b29sdGlwRXZlbnRUeXBlID0gc2VsZWN0VG9vbHRpcEV2ZW50VHlwZShzdGF0ZSwgc3RhdGUudG9vbHRpcC5zZXR0aW5ncy5zaGFyZWQpOwogICAgICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICAgICAgdmFyIGFjdGl2ZVByb3BzID0gc2VsZWN0QWN0aXZlUHJvcHNGcm9tQ2hhcnRQb2ludGVyKHN0YXRlLCBjaGFydFBvaW50ZXIpOwogICAgICAgIGlmICgoYWN0aXZlUHJvcHMgPT09IG51bGwgfHwgYWN0aXZlUHJvcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFjdGl2ZVByb3BzLmFjdGl2ZUluZGV4KSAhPSBudWxsKSB7CiAgICAgICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChzZXRNb3VzZU92ZXJBeGlzSW5kZXgoewogICAgICAgICAgICBhY3RpdmVJbmRleDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgsCiAgICAgICAgICAgIGFjdGl2ZURhdGFLZXk6IHZvaWQgMCwKICAgICAgICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogYWN0aXZlUHJvcHMuYWN0aXZlQ29vcmRpbmF0ZQogICAgICAgICAgfSkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChtb3VzZUxlYXZlQ2hhcnQoKSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJhZklkID0gbnVsbDsKICAgIH0pOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9yZWR1eERldnRvb2xzSnNvblN0cmluZ2lmeVJlcGxhY2VyLmpzCmZ1bmN0aW9uIHJlZHV4RGV2dG9vbHNKc29uU3RyaW5naWZ5UmVwbGFjZXIoa2V5LCB2YWx1ZSkgewogIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7CiAgICByZXR1cm4gIkhUTUxFbGVtZW50IDwiLmNvbmNhdCh2YWx1ZS50YWdOYW1lLCAnIGNsYXNzPSInKS5jb25jYXQodmFsdWUuY2xhc3NOYW1lLCAnIj4nKTsKICB9CiAgaWYgKHZhbHVlID09PSB3aW5kb3cpIHsKICAgIHJldHVybiAiZ2xvYmFsLndpbmRvdyI7CiAgfQogIGlmIChrZXkgPT09ICJjaGlsZHJlbiIgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgcmV0dXJuICI8PENISUxEUkVOPj4iOwogIH0KICByZXR1cm4gdmFsdWU7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3Jvb3RQcm9wc1NsaWNlLmpzCnZhciBpbml0aWFsU3RhdGUxMiA9IHsKICBhY2Nlc3NpYmlsaXR5TGF5ZXI6IHRydWUsCiAgYmFyQ2F0ZWdvcnlHYXA6ICIxMCUiLAogIGJhckdhcDogNCwKICBiYXJTaXplOiB2b2lkIDAsCiAgY2xhc3NOYW1lOiB2b2lkIDAsCiAgbWF4QmFyU2l6ZTogdm9pZCAwLAogIHN0YWNrT2Zmc2V0OiAibm9uZSIsCiAgc3luY0lkOiB2b2lkIDAsCiAgc3luY01ldGhvZDogImluZGV4IiwKICBiYXNlVmFsdWU6IHZvaWQgMCwKICByZXZlcnNlU3RhY2tPcmRlcjogZmFsc2UKfTsKdmFyIHJvb3RQcm9wc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJyb290UHJvcHMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMTIsCiAgcmVkdWNlcnM6IHsKICAgIHVwZGF0ZU9wdGlvbnM6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciBfYWN0aW9uJHBheWxvYWQkYmFyR2E7CiAgICAgIHN0YXRlLmFjY2Vzc2liaWxpdHlMYXllciA9IGFjdGlvbi5wYXlsb2FkLmFjY2Vzc2liaWxpdHlMYXllcjsKICAgICAgc3RhdGUuYmFyQ2F0ZWdvcnlHYXAgPSBhY3Rpb24ucGF5bG9hZC5iYXJDYXRlZ29yeUdhcDsKICAgICAgc3RhdGUuYmFyR2FwID0gKF9hY3Rpb24kcGF5bG9hZCRiYXJHYSA9IGFjdGlvbi5wYXlsb2FkLmJhckdhcCkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJGJhckdhICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkYmFyR2EgOiBpbml0aWFsU3RhdGUxMi5iYXJHYXA7CiAgICAgIHN0YXRlLmJhclNpemUgPSBhY3Rpb24ucGF5bG9hZC5iYXJTaXplOwogICAgICBzdGF0ZS5tYXhCYXJTaXplID0gYWN0aW9uLnBheWxvYWQubWF4QmFyU2l6ZTsKICAgICAgc3RhdGUuc3RhY2tPZmZzZXQgPSBhY3Rpb24ucGF5bG9hZC5zdGFja09mZnNldDsKICAgICAgc3RhdGUuc3luY0lkID0gYWN0aW9uLnBheWxvYWQuc3luY0lkOwogICAgICBzdGF0ZS5zeW5jTWV0aG9kID0gYWN0aW9uLnBheWxvYWQuc3luY01ldGhvZDsKICAgICAgc3RhdGUuY2xhc3NOYW1lID0gYWN0aW9uLnBheWxvYWQuY2xhc3NOYW1lOwogICAgICBzdGF0ZS5iYXNlVmFsdWUgPSBhY3Rpb24ucGF5bG9hZC5iYXNlVmFsdWU7CiAgICAgIHN0YXRlLnJldmVyc2VTdGFja09yZGVyID0gYWN0aW9uLnBheWxvYWQucmV2ZXJzZVN0YWNrT3JkZXI7CiAgICB9CiAgfQp9KTsKdmFyIHJvb3RQcm9wc1JlZHVjZXIgPSByb290UHJvcHNTbGljZS5yZWR1Y2VyOwp2YXIgewogIHVwZGF0ZU9wdGlvbnMKfSA9IHJvb3RQcm9wc1NsaWNlLmFjdGlvbnM7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9wb2xhck9wdGlvbnNTbGljZS5qcwp2YXIgcG9sYXJPcHRpb25zU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogInBvbGFyT3B0aW9ucyIsCiAgaW5pdGlhbFN0YXRlOiBudWxsLAogIHJlZHVjZXJzOiB7CiAgICB1cGRhdGVQb2xhck9wdGlvbnM6IChfc3RhdGUsIGFjdGlvbikgPT4gewogICAgICByZXR1cm4gYWN0aW9uLnBheWxvYWQ7CiAgICB9CiAgfQp9KTsKdmFyIHsKICB1cGRhdGVQb2xhck9wdGlvbnMKfSA9IHBvbGFyT3B0aW9uc1NsaWNlLmFjdGlvbnM7CnZhciBwb2xhck9wdGlvbnNSZWR1Y2VyID0gcG9sYXJPcHRpb25zU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2tleWJvYXJkRXZlbnRzTWlkZGxld2FyZS5qcwp2YXIga2V5RG93bkFjdGlvbiA9IGNyZWF0ZUFjdGlvbigia2V5RG93biIpOwp2YXIgZm9jdXNBY3Rpb24gPSBjcmVhdGVBY3Rpb24oImZvY3VzIik7CnZhciBrZXlib2FyZEV2ZW50c01pZGRsZXdhcmUgPSBjcmVhdGVMaXN0ZW5lck1pZGRsZXdhcmUoKTsKa2V5Ym9hcmRFdmVudHNNaWRkbGV3YXJlLnN0YXJ0TGlzdGVuaW5nKHsKICBhY3Rpb25DcmVhdG9yOiBrZXlEb3duQWN0aW9uLAogIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgIHZhciBzdGF0ZSA9IGxpc3RlbmVyQXBpLmdldFN0YXRlKCk7CiAgICB2YXIgYWNjZXNzaWJpbGl0eUxheWVySXNBY3RpdmUgPSBzdGF0ZS5yb290UHJvcHMuYWNjZXNzaWJpbGl0eUxheWVyICE9PSBmYWxzZTsKICAgIGlmICghYWNjZXNzaWJpbGl0eUxheWVySXNBY3RpdmUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHsKICAgICAga2V5Ym9hcmRJbnRlcmFjdGlvbgogICAgfSA9IHN0YXRlLnRvb2x0aXA7CiAgICB2YXIga2V5ID0gYWN0aW9uLnBheWxvYWQ7CiAgICBpZiAoa2V5ICE9PSAiQXJyb3dSaWdodCIgJiYga2V5ICE9PSAiQXJyb3dMZWZ0IiAmJiBrZXkgIT09ICJFbnRlciIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHJlc29sdmVkSW5kZXggPSBjb21iaW5lQWN0aXZlVG9vbHRpcEluZGV4KGtleWJvYXJkSW50ZXJhY3Rpb24sIHNlbGVjdFRvb2x0aXBEaXNwbGF5ZWREYXRhKHN0YXRlKSwgc2VsZWN0VG9vbHRpcEF4aXNEYXRhS2V5KHN0YXRlKSwgc2VsZWN0VG9vbHRpcEF4aXNEb21haW4oc3RhdGUpKTsKICAgIHZhciBjdXJyZW50SW5kZXggPSByZXNvbHZlZEluZGV4ID09IG51bGwgPyAtMSA6IE51bWJlcihyZXNvbHZlZEluZGV4KTsKICAgIGlmICghTnVtYmVyLmlzRmluaXRlKGN1cnJlbnRJbmRleCkgfHwgY3VycmVudEluZGV4IDwgMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgdG9vbHRpcFRpY2tzID0gc2VsZWN0VG9vbHRpcEF4aXNUaWNrcyhzdGF0ZSk7CiAgICBpZiAoa2V5ID09PSAiRW50ZXIiKSB7CiAgICAgIHZhciBfY29vcmRpbmF0ZSA9IHNlbGVjdENvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXgoc3RhdGUsICJheGlzIiwgImhvdmVyIiwgU3RyaW5nKGtleWJvYXJkSW50ZXJhY3Rpb24uaW5kZXgpKTsKICAgICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0S2V5Ym9hcmRJbnRlcmFjdGlvbih7CiAgICAgICAgYWN0aXZlOiAha2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUsCiAgICAgICAgYWN0aXZlSW5kZXg6IGtleWJvYXJkSW50ZXJhY3Rpb24uaW5kZXgsCiAgICAgICAgYWN0aXZlRGF0YUtleToga2V5Ym9hcmRJbnRlcmFjdGlvbi5kYXRhS2V5LAogICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IF9jb29yZGluYXRlCiAgICAgIH0pKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGRpcmVjdGlvbiA9IHNlbGVjdENoYXJ0RGlyZWN0aW9uKHN0YXRlKTsKICAgIHZhciBkaXJlY3Rpb25NdWx0aXBsaWVyID0gZGlyZWN0aW9uID09PSAibGVmdC10by1yaWdodCIgPyAxIDogLTE7CiAgICB2YXIgbW92ZW1lbnQgPSBrZXkgPT09ICJBcnJvd1JpZ2h0IiA/IDEgOiAtMTsKICAgIHZhciBuZXh0SW5kZXggPSBjdXJyZW50SW5kZXggKyBtb3ZlbWVudCAqIGRpcmVjdGlvbk11bHRpcGxpZXI7CiAgICBpZiAodG9vbHRpcFRpY2tzID09IG51bGwgfHwgbmV4dEluZGV4ID49IHRvb2x0aXBUaWNrcy5sZW5ndGggfHwgbmV4dEluZGV4IDwgMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgY29vcmRpbmF0ZSA9IHNlbGVjdENvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXgoc3RhdGUsICJheGlzIiwgImhvdmVyIiwgU3RyaW5nKG5leHRJbmRleCkpOwogICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0S2V5Ym9hcmRJbnRlcmFjdGlvbih7CiAgICAgIGFjdGl2ZTogdHJ1ZSwKICAgICAgYWN0aXZlSW5kZXg6IG5leHRJbmRleC50b1N0cmluZygpLAogICAgICBhY3RpdmVEYXRhS2V5OiB2b2lkIDAsCiAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGNvb3JkaW5hdGUKICAgIH0pKTsKICB9Cn0pOwprZXlib2FyZEV2ZW50c01pZGRsZXdhcmUuc3RhcnRMaXN0ZW5pbmcoewogIGFjdGlvbkNyZWF0b3I6IGZvY3VzQWN0aW9uLAogIGVmZmVjdDogKF9hY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICB2YXIgc3RhdGUgPSBsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpOwogICAgdmFyIGFjY2Vzc2liaWxpdHlMYXllcklzQWN0aXZlID0gc3RhdGUucm9vdFByb3BzLmFjY2Vzc2liaWxpdHlMYXllciAhPT0gZmFsc2U7CiAgICBpZiAoIWFjY2Vzc2liaWxpdHlMYXllcklzQWN0aXZlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciB7CiAgICAgIGtleWJvYXJkSW50ZXJhY3Rpb24KICAgIH0gPSBzdGF0ZS50b29sdGlwOwogICAgaWYgKGtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChrZXlib2FyZEludGVyYWN0aW9uLmluZGV4ID09IG51bGwpIHsKICAgICAgdmFyIG5leHRJbmRleCA9ICIwIjsKICAgICAgdmFyIGNvb3JkaW5hdGUgPSBzZWxlY3RDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4KHN0YXRlLCAiYXhpcyIsICJob3ZlciIsIFN0cmluZyhuZXh0SW5kZXgpKTsKICAgICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0S2V5Ym9hcmRJbnRlcmFjdGlvbih7CiAgICAgICAgYWN0aXZlRGF0YUtleTogdm9pZCAwLAogICAgICAgIGFjdGl2ZTogdHJ1ZSwKICAgICAgICBhY3RpdmVJbmRleDogbmV4dEluZGV4LAogICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGNvb3JkaW5hdGUKICAgICAgfSkpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9leHRlcm5hbEV2ZW50c01pZGRsZXdhcmUuanMKdmFyIGV4dGVybmFsRXZlbnRBY3Rpb24gPSBjcmVhdGVBY3Rpb24oImV4dGVybmFsRXZlbnQiKTsKdmFyIGV4dGVybmFsRXZlbnRzTWlkZGxld2FyZSA9IGNyZWF0ZUxpc3RlbmVyTWlkZGxld2FyZSgpOwp2YXIgcmFmSWRNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwpleHRlcm5hbEV2ZW50c01pZGRsZXdhcmUuc3RhcnRMaXN0ZW5pbmcoewogIGFjdGlvbkNyZWF0b3I6IGV4dGVybmFsRXZlbnRBY3Rpb24sCiAgZWZmZWN0OiAoYWN0aW9uLCBsaXN0ZW5lckFwaSkgPT4gewogICAgdmFyIHsKICAgICAgaGFuZGxlciwKICAgICAgcmVhY3RFdmVudAogICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgaWYgKGhhbmRsZXIgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICByZWFjdEV2ZW50LnBlcnNpc3QoKTsKICAgIHZhciBldmVudFR5cGUgPSByZWFjdEV2ZW50LnR5cGU7CiAgICB2YXIgZXhpc3RpbmdSYWZJZCA9IHJhZklkTWFwLmdldChldmVudFR5cGUpOwogICAgaWYgKGV4aXN0aW5nUmFmSWQgIT09IHZvaWQgMCkgewogICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShleGlzdGluZ1JhZklkKTsKICAgIH0KICAgIHZhciByYWZJZDIgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gewogICAgICB0cnkgewogICAgICAgIHZhciBzdGF0ZSA9IGxpc3RlbmVyQXBpLmdldFN0YXRlKCk7CiAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHsKICAgICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IHNlbGVjdEFjdGl2ZVRvb2x0aXBDb29yZGluYXRlKHN0YXRlKSwKICAgICAgICAgIGFjdGl2ZURhdGFLZXk6IHNlbGVjdEFjdGl2ZVRvb2x0aXBEYXRhS2V5KHN0YXRlKSwKICAgICAgICAgIGFjdGl2ZUluZGV4OiBzZWxlY3RBY3RpdmVUb29sdGlwSW5kZXgoc3RhdGUpLAogICAgICAgICAgYWN0aXZlTGFiZWw6IHNlbGVjdEFjdGl2ZUxhYmVsKHN0YXRlKSwKICAgICAgICAgIGFjdGl2ZVRvb2x0aXBJbmRleDogc2VsZWN0QWN0aXZlVG9vbHRpcEluZGV4KHN0YXRlKSwKICAgICAgICAgIGlzVG9vbHRpcEFjdGl2ZTogc2VsZWN0SXNUb29sdGlwQWN0aXZlKHN0YXRlKQogICAgICAgIH07CiAgICAgICAgaGFuZGxlcihuZXh0U3RhdGUsIHJlYWN0RXZlbnQpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHJhZklkTWFwLmRlbGV0ZShldmVudFR5cGUpOwogICAgICB9CiAgICB9KTsKICAgIHJhZklkTWFwLnNldChldmVudFR5cGUsIHJhZklkMik7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy90b3VjaFNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0QWxsVG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9uID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGF0ZV0sICh0b29sdGlwU3RhdGUpID0+IHRvb2x0aXBTdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzKTsKdmFyIHNlbGVjdFRvb2x0aXBDb29yZGluYXRlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbiwgc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlciwgKF9zdGF0ZSwgdG9vbHRpcEluZGV4LCBfZGF0YUtleSkgPT4gdG9vbHRpcEluZGV4LCAoX3N0YXRlLCBfdG9vbHRpcEluZGV4LCBkYXRhS2V5KSA9PiBkYXRhS2V5XSwgKGFsbFRvb2x0aXBDb25maWd1cmF0aW9ucywgdG9vbHRpcFBheWxvYWRTZWFyY2hlciwgdG9vbHRpcEluZGV4LCBkYXRhS2V5KSA9PiB7CiAgdmFyIG1vc3RSZWxldmFudFRvb2x0aXBDb25maWd1cmF0aW9uID0gYWxsVG9vbHRpcENvbmZpZ3VyYXRpb25zLmZpbmQoKHRvb2x0aXBDb25maWd1cmF0aW9uKSA9PiB7CiAgICByZXR1cm4gdG9vbHRpcENvbmZpZ3VyYXRpb24uc2V0dGluZ3MuZGF0YUtleSA9PT0gZGF0YUtleTsKICB9KTsKICBpZiAobW9zdFJlbGV2YW50VG9vbHRpcENvbmZpZ3VyYXRpb24gPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIHBvc2l0aW9ucwogIH0gPSBtb3N0UmVsZXZhbnRUb29sdGlwQ29uZmlndXJhdGlvbjsKICBpZiAocG9zaXRpb25zID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBtYXliZVBvc2l0aW9uID0gdG9vbHRpcFBheWxvYWRTZWFyY2hlcihwb3NpdGlvbnMsIHRvb2x0aXBJbmRleCk7CiAgcmV0dXJuIG1heWJlUG9zaXRpb247Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvdG91Y2hFdmVudHNNaWRkbGV3YXJlLmpzCnZhciB0b3VjaEV2ZW50QWN0aW9uID0gY3JlYXRlQWN0aW9uKCJ0b3VjaE1vdmUiKTsKdmFyIHRvdWNoRXZlbnRNaWRkbGV3YXJlID0gY3JlYXRlTGlzdGVuZXJNaWRkbGV3YXJlKCk7CnRvdWNoRXZlbnRNaWRkbGV3YXJlLnN0YXJ0TGlzdGVuaW5nKHsKICBhY3Rpb25DcmVhdG9yOiB0b3VjaEV2ZW50QWN0aW9uLAogIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgIHZhciB0b3VjaEV2ZW50ID0gYWN0aW9uLnBheWxvYWQ7CiAgICBpZiAodG91Y2hFdmVudC50b3VjaGVzID09IG51bGwgfHwgdG91Y2hFdmVudC50b3VjaGVzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgc3RhdGUgPSBsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpOwogICAgdmFyIHRvb2x0aXBFdmVudFR5cGUgPSBzZWxlY3RUb29sdGlwRXZlbnRUeXBlKHN0YXRlLCBzdGF0ZS50b29sdGlwLnNldHRpbmdzLnNoYXJlZCk7CiAgICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICAgIHZhciBhY3RpdmVQcm9wcyA9IHNlbGVjdEFjdGl2ZVByb3BzRnJvbUNoYXJ0UG9pbnRlcihzdGF0ZSwgZ2V0Q2hhcnRQb2ludGVyKHsKICAgICAgICBjbGllbnRYOiB0b3VjaEV2ZW50LnRvdWNoZXNbMF0uY2xpZW50WCwKICAgICAgICBjbGllbnRZOiB0b3VjaEV2ZW50LnRvdWNoZXNbMF0uY2xpZW50WSwKICAgICAgICBjdXJyZW50VGFyZ2V0OiB0b3VjaEV2ZW50LmN1cnJlbnRUYXJnZXQKICAgICAgfSkpOwogICAgICBpZiAoKGFjdGl2ZVByb3BzID09PSBudWxsIHx8IGFjdGl2ZVByb3BzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhY3RpdmVQcm9wcy5hY3RpdmVJbmRleCkgIT0gbnVsbCkgewogICAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldE1vdXNlT3ZlckF4aXNJbmRleCh7CiAgICAgICAgICBhY3RpdmVJbmRleDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgsCiAgICAgICAgICBhY3RpdmVEYXRhS2V5OiB2b2lkIDAsCiAgICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBhY3RpdmVQcm9wcy5hY3RpdmVDb29yZGluYXRlCiAgICAgICAgfSkpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJpdGVtIikgewogICAgICB2YXIgX3RhcmdldCRnZXRBdHRyaWJ1dGU7CiAgICAgIHZhciB0b3VjaCA9IHRvdWNoRXZlbnQudG91Y2hlc1swXTsKICAgICAgaWYgKGRvY3VtZW50LmVsZW1lbnRGcm9tUG9pbnQgPT0gbnVsbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgdGFyZ2V0ID0gZG9jdW1lbnQuZWxlbWVudEZyb21Qb2ludCh0b3VjaC5jbGllbnRYLCB0b3VjaC5jbGllbnRZKTsKICAgICAgaWYgKCF0YXJnZXQgfHwgIXRhcmdldC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIGl0ZW1JbmRleCA9IHRhcmdldC5nZXRBdHRyaWJ1dGUoREFUQV9JVEVNX0lOREVYX0FUVFJJQlVURV9OQU1FKTsKICAgICAgdmFyIGRhdGFLZXkgPSAoX3RhcmdldCRnZXRBdHRyaWJ1dGUgPSB0YXJnZXQuZ2V0QXR0cmlidXRlKERBVEFfSVRFTV9EQVRBS0VZX0FUVFJJQlVURV9OQU1FKSkgIT09IG51bGwgJiYgX3RhcmdldCRnZXRBdHRyaWJ1dGUgIT09IHZvaWQgMCA/IF90YXJnZXQkZ2V0QXR0cmlidXRlIDogdm9pZCAwOwogICAgICB2YXIgY29vcmRpbmF0ZSA9IHNlbGVjdFRvb2x0aXBDb29yZGluYXRlKGxpc3RlbmVyQXBpLmdldFN0YXRlKCksIGl0ZW1JbmRleCwgZGF0YUtleSk7CiAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldEFjdGl2ZU1vdXNlT3Zlckl0ZW1JbmRleCh7CiAgICAgICAgYWN0aXZlRGF0YUtleTogZGF0YUtleSwKICAgICAgICBhY3RpdmVJbmRleDogaXRlbUluZGV4LAogICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGNvb3JkaW5hdGUKICAgICAgfSkpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zdG9yZS5qcwp2YXIgcm9vdFJlZHVjZXIgPSBjb21iaW5lUmVkdWNlcnMoewogIGJydXNoOiBicnVzaFJlZHVjZXIsCiAgY2FydGVzaWFuQXhpczogY2FydGVzaWFuQXhpc1JlZHVjZXIsCiAgY2hhcnREYXRhOiBjaGFydERhdGFSZWR1Y2VyLAogIGVycm9yQmFyczogZXJyb3JCYXJSZWR1Y2VyLAogIGdyYXBoaWNhbEl0ZW1zOiBncmFwaGljYWxJdGVtc1JlZHVjZXIsCiAgbGF5b3V0OiBjaGFydExheW91dFJlZHVjZXIsCiAgbGVnZW5kOiBsZWdlbmRSZWR1Y2VyLAogIG9wdGlvbnM6IG9wdGlvbnNSZWR1Y2VyLAogIHBvbGFyQXhpczogcG9sYXJBeGlzUmVkdWNlciwKICBwb2xhck9wdGlvbnM6IHBvbGFyT3B0aW9uc1JlZHVjZXIsCiAgcmVmZXJlbmNlRWxlbWVudHM6IHJlZmVyZW5jZUVsZW1lbnRzUmVkdWNlciwKICByb290UHJvcHM6IHJvb3RQcm9wc1JlZHVjZXIsCiAgdG9vbHRpcDogdG9vbHRpcFJlZHVjZXIsCiAgekluZGV4OiB6SW5kZXhSZWR1Y2VyCn0pOwp2YXIgY3JlYXRlUmVjaGFydHNTdG9yZSA9IGZ1bmN0aW9uIGNyZWF0ZVJlY2hhcnRzU3RvcmUyKHByZWxvYWRlZFN0YXRlKSB7CiAgdmFyIGNoYXJ0TmFtZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDogIkNoYXJ0IjsKICByZXR1cm4gY29uZmlndXJlU3RvcmUoewogICAgcmVkdWNlcjogcm9vdFJlZHVjZXIsCiAgICAvLyByZWR1eC10b29sa2l0IHYxIHR5cGVzIGFyZSB1bmhhcHB5IHdpdGggdGhlIHByZWxvYWRlZFN0YXRlIHR5cGUuIFJlbW92ZSB0aGUgYGFzIGFueWAgd2hlbiBidW1waW5nIHRvIHYyCiAgICBwcmVsb2FkZWRTdGF0ZSwKICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgcmVkdXgtdG9vbGtpdCB2MSB0eXBlcyBhcmUgdW5oYXBweSB3aXRoIHRoZSBtaWRkbGV3YXJlIGFycmF5LiBSZW1vdmUgdGhpcyBjb21tZW50IHdoZW4gYnVtcGluZyB0byB2MgogICAgbWlkZGxld2FyZTogKGdldERlZmF1bHRNaWRkbGV3YXJlKSA9PiB7CiAgICAgIHZhciBfcHJvY2VzcyRlbnYkTk9ERV9FTlY7CiAgICAgIHJldHVybiBnZXREZWZhdWx0TWlkZGxld2FyZSh7CiAgICAgICAgc2VyaWFsaXphYmxlQ2hlY2s6IGZhbHNlLAogICAgICAgIGltbXV0YWJsZUNoZWNrOiAhWyJjb21tb25qcyIsICJlczYiLCAicHJvZHVjdGlvbiJdLmluY2x1ZGVzKChfcHJvY2VzcyRlbnYkTk9ERV9FTlYgPSAiZXM2IikgIT09IG51bGwgJiYgX3Byb2Nlc3MkZW52JE5PREVfRU5WICE9PSB2b2lkIDAgPyBfcHJvY2VzcyRlbnYkTk9ERV9FTlYgOiAiIikKICAgICAgfSkuY29uY2F0KFttb3VzZUNsaWNrTWlkZGxld2FyZS5taWRkbGV3YXJlLCBtb3VzZU1vdmVNaWRkbGV3YXJlLm1pZGRsZXdhcmUsIGtleWJvYXJkRXZlbnRzTWlkZGxld2FyZS5taWRkbGV3YXJlLCBleHRlcm5hbEV2ZW50c01pZGRsZXdhcmUubWlkZGxld2FyZSwgdG91Y2hFdmVudE1pZGRsZXdhcmUubWlkZGxld2FyZV0pOwogICAgfSwKICAgIC8qCiAgICAgKiBJIGNhbid0IGZpbmQgb3V0IGhvdyB0byBzYXRpc2Z5IHR5cGVzY3JpcHQgaGVyZS4KICAgICAqIFdlIHJldHVybiBgRW5oYW5jZXJBcnJheTxbU3RvcmVFbmhhbmNlcjx7fSwge30+LCBTdG9yZUVuaGFuY2VyXT5gIGZyb20gdGhpcyBmdW5jdGlvbiwKICAgICAqIGJ1dCB0aGUgdHlwZXMgc2F5IHdlIHNob3VsZCByZXR1cm4gYEVuaGFuY2VyQXJyYXk8U3RvcmVFbmhhbmNlcjx7fSwge30+YC4KICAgICAqIExvb2tzIGxpa2UgaXQncyBiYWRseSBpbmZlcnJlZCBnZW5lcmljcywgYnV0IGl0IHdvbid0IGFsbG93IG1lIHRvIHByb3ZpZGUgdGhlIGNvcnJlY3QgdHlwZSBtYW51YWxseSBlaXRoZXIuCiAgICAgKiBTbyBsZXQncyBqdXN0IGlnbm9yZSB0aGUgZXJyb3IgZm9yIG5vdy4KICAgICAqLwogICAgLy8gQHRzLWV4cGVjdC1lcnJvciBtaXNtYXRjaGVkIGdlbmVyaWNzCiAgICBlbmhhbmNlcnM6IChnZXREZWZhdWx0RW5oYW5jZXJzKSA9PiB7CiAgICAgIHZhciBlbmhhbmNlcnMgPSBnZXREZWZhdWx0RW5oYW5jZXJzOwogICAgICBpZiAodHlwZW9mIGdldERlZmF1bHRFbmhhbmNlcnMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBlbmhhbmNlcnMgPSBnZXREZWZhdWx0RW5oYW5jZXJzKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGVuaGFuY2Vycy5jb25jYXQoYXV0b0JhdGNoRW5oYW5jZXIoewogICAgICAgIHR5cGU6ICJyYWYiCiAgICAgIH0pKTsKICAgIH0sCiAgICBkZXZUb29sczogR2xvYmFsLmRldlRvb2xzRW5hYmxlZCAmJiB7CiAgICAgIHNlcmlhbGl6ZTogewogICAgICAgIHJlcGxhY2VyOiByZWR1eERldnRvb2xzSnNvblN0cmluZ2lmeVJlcGxhY2VyCiAgICAgIH0sCiAgICAgIG5hbWU6ICJyZWNoYXJ0cy0iLmNvbmNhdChjaGFydE5hbWUpCiAgICB9CiAgfSk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9SZWNoYXJ0c1N0b3JlUHJvdmlkZXIuanMKZnVuY3Rpb24gUmVjaGFydHNTdG9yZVByb3ZpZGVyKF9yZWYyKSB7CiAgdmFyIHsKICAgIHByZWxvYWRlZFN0YXRlLAogICAgY2hpbGRyZW4sCiAgICByZWR1eFN0b3JlTmFtZQogIH0gPSBfcmVmMjsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgc3RvcmVSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDEudXNlUmVmKShudWxsKTsKICBpZiAoaXNQYW5vcmFtYSkgewogICAgcmV0dXJuIGNoaWxkcmVuOwogIH0KICBpZiAoc3RvcmVSZWYuY3VycmVudCA9PSBudWxsKSB7CiAgICBzdG9yZVJlZi5jdXJyZW50ID0gY3JlYXRlUmVjaGFydHNTdG9yZShwcmVsb2FkZWRTdGF0ZSwgcmVkdXhTdG9yZU5hbWUpOwogIH0KICB2YXIgbm9uTnVsbENvbnRleHQgPSBSZWNoYXJ0c1JlZHV4Q29udGV4dDsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjkuY3JlYXRlRWxlbWVudChQcm92aWRlcl9kZWZhdWx0LCB7CiAgICBjb250ZXh0OiBub25OdWxsQ29udGV4dCwKICAgIHN0b3JlOiBzdG9yZVJlZi5jdXJyZW50CiAgfSwgY2hpbGRyZW4pOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9SZXBvcnRNYWluQ2hhcnRQcm9wcy5qcwp2YXIgaW1wb3J0X3JlYWN0NDIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIFJlcG9ydE1haW5DaGFydFByb3BzSW1wbChfcmVmMikgewogIHZhciB7CiAgICBsYXlvdXQsCiAgICBtYXJnaW4KICB9ID0gX3JlZjI7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICAoMCwgaW1wb3J0X3JlYWN0NDIudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoIWlzUGFub3JhbWEpIHsKICAgICAgZGlzcGF0Y2goc2V0TGF5b3V0KGxheW91dCkpOwogICAgICBkaXNwYXRjaChzZXRNYXJnaW4obWFyZ2luKSk7CiAgICB9CiAgfSwgW2Rpc3BhdGNoLCBpc1Bhbm9yYW1hLCBsYXlvdXQsIG1hcmdpbl0pOwogIHJldHVybiBudWxsOwp9CnZhciBSZXBvcnRNYWluQ2hhcnRQcm9wcyA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDIubWVtbykoUmVwb3J0TWFpbkNoYXJ0UHJvcHNJbXBsLCBwcm9wc0FyZUVxdWFsKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1JlcG9ydENoYXJ0UHJvcHMuanMKdmFyIGltcG9ydF9yZWFjdDQzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBSZXBvcnRDaGFydFByb3BzKHByb3BzKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICAoMCwgaW1wb3J0X3JlYWN0NDMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBkaXNwYXRjaCh1cGRhdGVPcHRpb25zKHByb3BzKSk7CiAgfSwgW2Rpc3BhdGNoLCBwcm9wc10pOwogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9DYXRlZ29yaWNhbENoYXJ0LmpzCnZhciBSZWFjdDMzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NDggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250YWluZXIvUm9vdFN1cmZhY2UuanMKdmFyIFJlYWN0MzEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0NSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3pJbmRleC9aSW5kZXhQb3J0YWwuanMKdmFyIFJlYWN0MzAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0NCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gWkluZGV4U3ZnUG9ydGFsKF9yZWYyKSB7CiAgdmFyIHsKICAgIHpJbmRleCwKICAgIGlzUGFub3JhbWEKICB9ID0gX3JlZjI7CiAgdmFyIHByZWZpeCA9IGlzUGFub3JhbWEgPyAicmVjaGFydHMtemluZGV4LXBhbm9yYW1hLSIgOiAicmVjaGFydHMtemluZGV4LSI7CiAgdmFyIHBvcnRhbElkID0gdXNlVW5pcXVlSWQoIiIuY29uY2F0KHByZWZpeCkuY29uY2F0KHpJbmRleCkpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDQ0LnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgZGlzcGF0Y2gocmVnaXN0ZXJaSW5kZXhQb3J0YWxJZCh7CiAgICAgIHpJbmRleCwKICAgICAgZWxlbWVudElkOiBwb3J0YWxJZCwKICAgICAgaXNQYW5vcmFtYQogICAgfSkpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgZGlzcGF0Y2godW5yZWdpc3RlclpJbmRleFBvcnRhbElkKHsKICAgICAgICB6SW5kZXgsCiAgICAgICAgaXNQYW5vcmFtYQogICAgICB9KSk7CiAgICB9OwogIH0sIFtkaXNwYXRjaCwgekluZGV4LCBwb3J0YWxJZCwgaXNQYW5vcmFtYV0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgdGFiSW5kZXg6IC0xLAogICAgaWQ6IHBvcnRhbElkCiAgfSk7Cn0KZnVuY3Rpb24gQWxsWkluZGV4UG9ydGFscyhfcmVmMikgewogIHZhciB7CiAgICBjaGlsZHJlbiwKICAgIGlzUGFub3JhbWEKICB9ID0gX3JlZjI7CiAgdmFyIGFsbFJlZ2lzdGVyZWRaSW5kZXhlcyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEFsbFJlZ2lzdGVyZWRaSW5kZXhlcyk7CiAgaWYgKCFhbGxSZWdpc3RlcmVkWkluZGV4ZXMgfHwgYWxsUmVnaXN0ZXJlZFpJbmRleGVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIGNoaWxkcmVuOwogIH0KICB2YXIgYWxsTmVnYXRpdmVaSW5kZXhlcyA9IGFsbFJlZ2lzdGVyZWRaSW5kZXhlcy5maWx0ZXIoKHpJbmRleCkgPT4gekluZGV4IDwgMCk7CiAgdmFyIGFsbFBvc2l0aXZlWkluZGV4ZXMgPSBhbGxSZWdpc3RlcmVkWkluZGV4ZXMuZmlsdGVyKCh6SW5kZXgpID0+IHpJbmRleCA+IDApOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KFJlYWN0MzAuRnJhZ21lbnQsIG51bGwsIGFsbE5lZ2F0aXZlWkluZGV4ZXMubWFwKCh6SW5kZXgpID0+IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoWkluZGV4U3ZnUG9ydGFsLCB7CiAgICBrZXk6IHpJbmRleCwKICAgIHpJbmRleCwKICAgIGlzUGFub3JhbWEKICB9KSksIGNoaWxkcmVuLCBhbGxQb3NpdGl2ZVpJbmRleGVzLm1hcCgoekluZGV4KSA9PiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KFpJbmRleFN2Z1BvcnRhbCwgewogICAga2V5OiB6SW5kZXgsCiAgICB6SW5kZXgsCiAgICBpc1Bhbm9yYW1hCiAgfSkpKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL1Jvb3RTdXJmYWNlLmpzCnZhciBfZXhjbHVkZWQxNiA9IFsiY2hpbGRyZW4iXTsKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTYoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE2KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxNihyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX2V4dGVuZHMyMCgpIHsKICByZXR1cm4gX2V4dGVuZHMyMCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMjAuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQp2YXIgRlVMTF9XSURUSF9BTkRfSEVJR0hUID0gewogIHdpZHRoOiAiMTAwJSIsCiAgaGVpZ2h0OiAiMTAwJSIsCiAgLyoKICAgKiBkaXNwbGF5OiBibG9jayBpcyBuZWNlc3NhcnkgaGVyZSBiZWNhdXNlIHRoZSBkZWZhdWx0IGZvciBhbiBTVkcgaXMgZGlzcGxheTogaW5saW5lLAogICAqIHdoaWNoIGluIHNvbWUgYnJvd3NlcnMgKENocm9tZSkgYWRkcyBhIGxpdHRsZSBiaXQgb2YgZXh0cmEgc3BhY2UgYWJvdmUgYW5kIGJlbG93IHRoZSBTVkcKICAgKiB0byBtYWtlIHNwYWNlIGZvciB0aGUgZGVzY2VuZGVyIG9mIGxldHRlcnMgbGlrZSAiZyIgYW5kICJ5Ii4gVGhpcyB0aHJvd3Mgb2ZmIHRoZSBoZWlnaHQgY2FsY3VsYXRpb24KICAgKiBhbmQgY2F1c2VzIHRoZSBjb250YWluZXIgdG8gZ3JvdyBpbmRlZmluaXRlbHkgb24gZWFjaCByZW5kZXIgd2l0aCByZXNwb25zaXZlPXRydWUuCiAgICogRGlzcGxheTogYmxvY2sgcmVtb3ZlcyB0aGF0IGV4dHJhIHNwYWNlLgogICAqCiAgICogSW50ZXJlc3RpbmdseSwgRmlyZWZveCBkb2VzIG5vdCBoYXZlIHRoaXMgcHJvYmxlbSwgYnV0IGl0IGRvZXNuJ3QgaHVydCB0byBhZGQgdGhlIHN0eWxlIGFueXdheS4KICAgKi8KICBkaXNwbGF5OiAiYmxvY2siCn07CnZhciBNYWluQ2hhcnRTdXJmYWNlID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0NS5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB3aWR0aCA9IHVzZUNoYXJ0V2lkdGgoKTsKICB2YXIgaGVpZ2h0ID0gdXNlQ2hhcnRIZWlnaHQoKTsKICB2YXIgaGFzQWNjZXNzaWJpbGl0eUxheWVyID0gdXNlQWNjZXNzaWJpbGl0eUxheWVyKCk7CiAgaWYgKCFpc1Bvc2l0aXZlTnVtYmVyKHdpZHRoKSB8fCAhaXNQb3NpdGl2ZU51bWJlcihoZWlnaHQpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgb3RoZXJBdHRyaWJ1dGVzLAogICAgdGl0bGUsCiAgICBkZXNjCiAgfSA9IHByb3BzOwogIHZhciB0YWJJbmRleCwgcm9sZTsKICBpZiAob3RoZXJBdHRyaWJ1dGVzICE9IG51bGwpIHsKICAgIGlmICh0eXBlb2Ygb3RoZXJBdHRyaWJ1dGVzLnRhYkluZGV4ID09PSAibnVtYmVyIikgewogICAgICB0YWJJbmRleCA9IG90aGVyQXR0cmlidXRlcy50YWJJbmRleDsKICAgIH0gZWxzZSB7CiAgICAgIHRhYkluZGV4ID0gaGFzQWNjZXNzaWJpbGl0eUxheWVyID8gMCA6IHZvaWQgMDsKICAgIH0KICAgIGlmICh0eXBlb2Ygb3RoZXJBdHRyaWJ1dGVzLnJvbGUgPT09ICJzdHJpbmciKSB7CiAgICAgIHJvbGUgPSBvdGhlckF0dHJpYnV0ZXMucm9sZTsKICAgIH0gZWxzZSB7CiAgICAgIHJvbGUgPSBoYXNBY2Nlc3NpYmlsaXR5TGF5ZXIgPyAiYXBwbGljYXRpb24iIDogdm9pZCAwOwogICAgfQogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzEuY3JlYXRlRWxlbWVudChTdXJmYWNlLCBfZXh0ZW5kczIwKHt9LCBvdGhlckF0dHJpYnV0ZXMsIHsKICAgIHRpdGxlLAogICAgZGVzYywKICAgIHJvbGUsCiAgICB0YWJJbmRleCwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgc3R5bGU6IEZVTExfV0lEVEhfQU5EX0hFSUdIVCwKICAgIHJlZgogIH0pLCBjaGlsZHJlbik7Cn0pOwp2YXIgQnJ1c2hQYW5vcmFtYVN1cmZhY2UgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4KICB9ID0gX3JlZjI7CiAgdmFyIGJydXNoRGltZW5zaW9ucyA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEJydXNoRGltZW5zaW9ucyk7CiAgaWYgKCFicnVzaERpbWVuc2lvbnMpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICB5OiB5MiwKICAgIHg6IHgyCiAgfSA9IGJydXNoRGltZW5zaW9uczsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzEuY3JlYXRlRWxlbWVudChTdXJmYWNlLCB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHg6IHgyLAogICAgeTogeTIKICB9LCBjaGlsZHJlbik7Cn07CnZhciBSb290U3VyZmFjZSA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDUuZm9yd2FyZFJlZikoKF9yZWYyLCByZWYpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4KICB9ID0gX3JlZjIsIHJlc3QgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNihfcmVmMiwgX2V4Y2x1ZGVkMTYpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIGlmIChpc1Bhbm9yYW1hKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzEuY3JlYXRlRWxlbWVudChCcnVzaFBhbm9yYW1hU3VyZmFjZSwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MzEuY3JlYXRlRWxlbWVudChBbGxaSW5kZXhQb3J0YWxzLCB7CiAgICAgIGlzUGFub3JhbWE6IHRydWUKICAgIH0sIGNoaWxkcmVuKSk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMS5jcmVhdGVFbGVtZW50KE1haW5DaGFydFN1cmZhY2UsIF9leHRlbmRzMjAoewogICAgcmVmCiAgfSwgcmVzdCksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMxLmNyZWF0ZUVsZW1lbnQoQWxsWkluZGV4UG9ydGFscywgewogICAgaXNQYW5vcmFtYTogZmFsc2UKICB9LCBjaGlsZHJlbikpOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L1JlY2hhcnRzV3JhcHBlci5qcwp2YXIgUmVhY3QzMiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQ3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VSZXBvcnRTY2FsZS5qcwp2YXIgaW1wb3J0X3JlYWN0NDYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIHVzZVJlcG9ydFNjYWxlKCkgewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIFtyZWYsIHNldFJlZl0gPSAoMCwgaW1wb3J0X3JlYWN0NDYudXNlU3RhdGUpKG51bGwpOwogIHZhciBzY2FsZSA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdENvbnRhaW5lclNjYWxlKTsKICAoMCwgaW1wb3J0X3JlYWN0NDYudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocmVmID09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHJlY3QgPSByZWYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICB2YXIgbmV3U2NhbGUgPSByZWN0LndpZHRoIC8gcmVmLm9mZnNldFdpZHRoOwogICAgaWYgKGlzV2VsbEJlaGF2ZWROdW1iZXIobmV3U2NhbGUpICYmIG5ld1NjYWxlICE9PSBzY2FsZSkgewogICAgICBkaXNwYXRjaChzZXRTY2FsZShuZXdTY2FsZSkpOwogICAgfQogIH0sIFtyZWYsIGRpc3BhdGNoLCBzY2FsZV0pOwogIHJldHVybiBzZXRSZWY7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L1JlY2hhcnRzV3JhcHBlci5qcwpmdW5jdGlvbiBvd25LZXlzMzEoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQzMShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czMxKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkzMyhlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzMShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MzMoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkzMyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzMyh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUzMyh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUzMyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gX2V4dGVuZHMyMSgpIHsKICByZXR1cm4gX2V4dGVuZHMyMSA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMjEuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQp2YXIgRXZlbnRTeW5jaHJvbml6ZXIgPSAoKSA9PiB7CiAgdXNlU3luY2hyb25pc2VkRXZlbnRzRnJvbU90aGVyQ2hhcnRzKCk7CiAgcmV0dXJuIG51bGw7Cn07CmZ1bmN0aW9uIGdldE51bWJlck9yWmVybyh2YWx1ZSkgewogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICB2YXIgcGFyc2VkID0gcGFyc2VGbG9hdCh2YWx1ZSk7CiAgICBpZiAoIU51bWJlci5pc05hTihwYXJzZWQpKSB7CiAgICAgIHJldHVybiBwYXJzZWQ7CiAgICB9CiAgfQogIHJldHVybiAwOwp9CnZhciBSZXNwb25zaXZlRGl2ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0Ny5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciBfcHJvcHMkc3R5bGUsIF9wcm9wcyRzdHlsZTI7CiAgdmFyIG9ic2VydmVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZVJlZikobnVsbCk7CiAgdmFyIFtzaXplcywgc2V0U2l6ZXNdID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZVN0YXRlKSh7CiAgICBjb250YWluZXJXaWR0aDogZ2V0TnVtYmVyT3JaZXJvKChfcHJvcHMkc3R5bGUgPSBwcm9wcy5zdHlsZSkgPT09IG51bGwgfHwgX3Byb3BzJHN0eWxlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfcHJvcHMkc3R5bGUud2lkdGgpLAogICAgY29udGFpbmVySGVpZ2h0OiBnZXROdW1iZXJPclplcm8oKF9wcm9wcyRzdHlsZTIgPSBwcm9wcy5zdHlsZSkgPT09IG51bGwgfHwgX3Byb3BzJHN0eWxlMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3Byb3BzJHN0eWxlMi5oZWlnaHQpCiAgfSk7CiAgdmFyIHNldENvbnRhaW5lclNpemUgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChuZXdXaWR0aCwgbmV3SGVpZ2h0KSA9PiB7CiAgICBzZXRTaXplcygocHJldlN0YXRlKSA9PiB7CiAgICAgIHZhciByb3VuZGVkV2lkdGggPSBNYXRoLnJvdW5kKG5ld1dpZHRoKTsKICAgICAgdmFyIHJvdW5kZWRIZWlnaHQgPSBNYXRoLnJvdW5kKG5ld0hlaWdodCk7CiAgICAgIGlmIChwcmV2U3RhdGUuY29udGFpbmVyV2lkdGggPT09IHJvdW5kZWRXaWR0aCAmJiBwcmV2U3RhdGUuY29udGFpbmVySGVpZ2h0ID09PSByb3VuZGVkSGVpZ2h0KSB7CiAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGNvbnRhaW5lcldpZHRoOiByb3VuZGVkV2lkdGgsCiAgICAgICAgY29udGFpbmVySGVpZ2h0OiByb3VuZGVkSGVpZ2h0CiAgICAgIH07CiAgICB9KTsKICB9LCBbXSk7CiAgdmFyIGlubmVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgobm9kZSkgPT4gewogICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmVmKG5vZGUpOwogICAgfQogICAgaWYgKG5vZGUgIT0gbnVsbCAmJiB0eXBlb2YgUmVzaXplT2JzZXJ2ZXIgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHZhciB7CiAgICAgICAgd2lkdGg6IGNvbnRhaW5lcldpZHRoLAogICAgICAgIGhlaWdodDogY29udGFpbmVySGVpZ2h0CiAgICAgIH0gPSBub2RlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICBzZXRDb250YWluZXJTaXplKGNvbnRhaW5lcldpZHRoLCBjb250YWluZXJIZWlnaHQpOwogICAgICB2YXIgY2FsbGJhY2sgPSAoZW50cmllcykgPT4gewogICAgICAgIHZhciB7CiAgICAgICAgICB3aWR0aCwKICAgICAgICAgIGhlaWdodAogICAgICAgIH0gPSBlbnRyaWVzWzBdLmNvbnRlbnRSZWN0OwogICAgICAgIHNldENvbnRhaW5lclNpemUod2lkdGgsIGhlaWdodCk7CiAgICAgIH07CiAgICAgIHZhciBvYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcihjYWxsYmFjayk7CiAgICAgIG9ic2VydmVyLm9ic2VydmUobm9kZSk7CiAgICAgIG9ic2VydmVyUmVmLmN1cnJlbnQgPSBvYnNlcnZlcjsKICAgIH0KICB9LCBbcmVmLCBzZXRDb250YWluZXJTaXplXSk7CiAgKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUVmZmVjdCkoKCkgPT4gewogICAgcmV0dXJuICgpID0+IHsKICAgICAgdmFyIG9ic2VydmVyID0gb2JzZXJ2ZXJSZWYuY3VycmVudDsKICAgICAgaWYgKG9ic2VydmVyICE9IG51bGwpIHsKICAgICAgICBvYnNlcnZlci5kaXNjb25uZWN0KCk7CiAgICAgIH0KICAgIH07CiAgfSwgW3NldENvbnRhaW5lclNpemVdKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChSZWFjdDMyLkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFJlcG9ydENoYXJ0U2l6ZSwgewogICAgd2lkdGg6IHNpemVzLmNvbnRhaW5lcldpZHRoLAogICAgaGVpZ2h0OiBzaXplcy5jb250YWluZXJIZWlnaHQKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudCgiZGl2IiwgX2V4dGVuZHMyMSh7CiAgICByZWY6IGlubmVyUmVmCiAgfSwgcHJvcHMpKSk7Cn0pOwp2YXIgUmVhZFNpemVPbmNlRGl2ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0Ny5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBwcm9wczsKICB2YXIgW3NpemVzLCBzZXRTaXplc10gPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlU3RhdGUpKHsKICAgIGNvbnRhaW5lcldpZHRoOiBnZXROdW1iZXJPclplcm8od2lkdGgpLAogICAgY29udGFpbmVySGVpZ2h0OiBnZXROdW1iZXJPclplcm8oaGVpZ2h0KQogIH0pOwogIHZhciBzZXRDb250YWluZXJTaXplID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgobmV3V2lkdGgsIG5ld0hlaWdodCkgPT4gewogICAgc2V0U2l6ZXMoKHByZXZTdGF0ZSkgPT4gewogICAgICB2YXIgcm91bmRlZFdpZHRoID0gTWF0aC5yb3VuZChuZXdXaWR0aCk7CiAgICAgIHZhciByb3VuZGVkSGVpZ2h0ID0gTWF0aC5yb3VuZChuZXdIZWlnaHQpOwogICAgICBpZiAocHJldlN0YXRlLmNvbnRhaW5lcldpZHRoID09PSByb3VuZGVkV2lkdGggJiYgcHJldlN0YXRlLmNvbnRhaW5lckhlaWdodCA9PT0gcm91bmRlZEhlaWdodCkgewogICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBjb250YWluZXJXaWR0aDogcm91bmRlZFdpZHRoLAogICAgICAgIGNvbnRhaW5lckhlaWdodDogcm91bmRlZEhlaWdodAogICAgICB9OwogICAgfSk7CiAgfSwgW10pOwogIHZhciBpbm5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKG5vZGUpID0+IHsKICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJlZihub2RlKTsKICAgIH0KICAgIGlmIChub2RlICE9IG51bGwpIHsKICAgICAgdmFyIHsKICAgICAgICB3aWR0aDogY29udGFpbmVyV2lkdGgsCiAgICAgICAgaGVpZ2h0OiBjb250YWluZXJIZWlnaHQKICAgICAgfSA9IG5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHNldENvbnRhaW5lclNpemUoY29udGFpbmVyV2lkdGgsIGNvbnRhaW5lckhlaWdodCk7CiAgICB9CiAgfSwgW3JlZiwgc2V0Q29udGFpbmVyU2l6ZV0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFJlYWN0MzIuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRTaXplLCB7CiAgICB3aWR0aDogc2l6ZXMuY29udGFpbmVyV2lkdGgsCiAgICBoZWlnaHQ6IHNpemVzLmNvbnRhaW5lckhlaWdodAogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KCJkaXYiLCBfZXh0ZW5kczIxKHsKICAgIHJlZjogaW5uZXJSZWYKICB9LCBwcm9wcykpKTsKfSk7CnZhciBTdGF0aWNEaXYgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ3LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHByb3BzOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFJlYWN0MzIuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRTaXplLCB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KCJkaXYiLCBfZXh0ZW5kczIxKHsKICAgIHJlZgogIH0sIHByb3BzKSkpOwp9KTsKdmFyIE5vblJlc3BvbnNpdmVEaXYgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ3LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHByb3BzOwogIGlmIChpc1BlcmNlbnQod2lkdGgpIHx8IGlzUGVyY2VudChoZWlnaHQpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChSZWFkU2l6ZU9uY2VEaXYsIF9leHRlbmRzMjEoe30sIHByb3BzLCB7CiAgICAgIHJlZgogICAgfSkpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChTdGF0aWNEaXYsIF9leHRlbmRzMjEoe30sIHByb3BzLCB7CiAgICByZWYKICB9KSk7Cn0pOwpmdW5jdGlvbiBnZXRXcmFwcGVyRGl2Q29tcG9uZW50KHJlc3BvbnNpdmUpIHsKICByZXR1cm4gcmVzcG9uc2l2ZSA9PT0gdHJ1ZSA/IFJlc3BvbnNpdmVEaXYgOiBOb25SZXNwb25zaXZlRGl2Owp9CnZhciBSZWNoYXJ0c1dyYXBwZXIgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ3LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgY2xhc3NOYW1lLAogICAgaGVpZ2h0OiBoZWlnaHRGcm9tUHJvcHMsCiAgICBvbkNsaWNrLAogICAgb25Db250ZXh0TWVudSwKICAgIG9uRG91YmxlQ2xpY2ssCiAgICBvbk1vdXNlRG93biwKICAgIG9uTW91c2VFbnRlciwKICAgIG9uTW91c2VMZWF2ZSwKICAgIG9uTW91c2VNb3ZlLAogICAgb25Nb3VzZVVwLAogICAgb25Ub3VjaEVuZCwKICAgIG9uVG91Y2hNb3ZlLAogICAgb25Ub3VjaFN0YXJ0LAogICAgc3R5bGUsCiAgICB3aWR0aDogd2lkdGhGcm9tUHJvcHMsCiAgICByZXNwb25zaXZlLAogICAgZGlzcGF0Y2hUb3VjaEV2ZW50cyA9IHRydWUKICB9ID0gcHJvcHM7CiAgdmFyIGNvbnRhaW5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VSZWYpKG51bGwpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIFt0b29sdGlwUG9ydGFsLCBzZXRUb29sdGlwUG9ydGFsXSA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VTdGF0ZSkobnVsbCk7CiAgdmFyIFtsZWdlbmRQb3J0YWwsIHNldExlZ2VuZFBvcnRhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlU3RhdGUpKG51bGwpOwogIHZhciBzZXRTY2FsZVJlZiA9IHVzZVJlcG9ydFNjYWxlKCk7CiAgdmFyIHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPSB1c2VSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCgpOwogIHZhciB3aWR0aCA9IChyZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zID09PSBudWxsIHx8IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMud2lkdGgpID4gMCA/IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMud2lkdGggOiB3aWR0aEZyb21Qcm9wczsKICB2YXIgaGVpZ2h0ID0gKHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPT09IG51bGwgfHwgcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy5oZWlnaHQpID4gMCA/IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMuaGVpZ2h0IDogaGVpZ2h0RnJvbVByb3BzOwogIHZhciBpbm5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKG5vZGUpID0+IHsKICAgIHNldFNjYWxlUmVmKG5vZGUpOwogICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmVmKG5vZGUpOwogICAgfQogICAgc2V0VG9vbHRpcFBvcnRhbChub2RlKTsKICAgIHNldExlZ2VuZFBvcnRhbChub2RlKTsKICAgIGlmIChub2RlICE9IG51bGwpIHsKICAgICAgY29udGFpbmVyUmVmLmN1cnJlbnQgPSBub2RlOwogICAgfQogIH0sIFtzZXRTY2FsZVJlZiwgcmVmLCBzZXRUb29sdGlwUG9ydGFsLCBzZXRMZWdlbmRQb3J0YWxdKTsKICB2YXIgbXlPbkNsaWNrID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2gobW91c2VDbGlja0FjdGlvbihlKSk7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25DbGljaywKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25DbGlja10pOwogIHZhciBteU9uTW91c2VFbnRlciA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKG1vdXNlTW92ZUFjdGlvbihlKSk7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Nb3VzZUVudGVyLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbk1vdXNlRW50ZXJdKTsKICB2YXIgbXlPbk1vdXNlTGVhdmUgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChtb3VzZUxlYXZlQ2hhcnQoKSk7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Nb3VzZUxlYXZlLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbk1vdXNlTGVhdmVdKTsKICB2YXIgbXlPbk1vdXNlTW92ZSA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKG1vdXNlTW92ZUFjdGlvbihlKSk7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Nb3VzZU1vdmUsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uTW91c2VNb3ZlXSk7CiAgdmFyIG9uRm9jdXMgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKCgpID0+IHsKICAgIGRpc3BhdGNoKGZvY3VzQWN0aW9uKCkpOwogIH0sIFtkaXNwYXRjaF0pOwogIHZhciBvbktleURvd24gPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChrZXlEb3duQWN0aW9uKGUua2V5KSk7CiAgfSwgW2Rpc3BhdGNoXSk7CiAgdmFyIG15T25Db250ZXh0TWVudSA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbkNvbnRleHRNZW51LAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbkNvbnRleHRNZW51XSk7CiAgdmFyIG15T25Eb3VibGVDbGljayA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbkRvdWJsZUNsaWNrLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbkRvdWJsZUNsaWNrXSk7CiAgdmFyIG15T25Nb3VzZURvd24gPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Nb3VzZURvd24sCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uTW91c2VEb3duXSk7CiAgdmFyIG15T25Nb3VzZVVwID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uTW91c2VVcCwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Nb3VzZVVwXSk7CiAgdmFyIG15T25Ub3VjaFN0YXJ0ID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uVG91Y2hTdGFydCwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Ub3VjaFN0YXJ0XSk7CiAgdmFyIG15T25Ub3VjaE1vdmUgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBpZiAoZGlzcGF0Y2hUb3VjaEV2ZW50cykgewogICAgICBkaXNwYXRjaCh0b3VjaEV2ZW50QWN0aW9uKGUpKTsKICAgIH0KICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvblRvdWNoTW92ZSwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgZGlzcGF0Y2hUb3VjaEV2ZW50cywgb25Ub3VjaE1vdmVdKTsKICB2YXIgbXlPblRvdWNoRW5kID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uVG91Y2hFbmQsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uVG91Y2hFbmRdKTsKICB2YXIgV3JhcHBlckRpdiA9IGdldFdyYXBwZXJEaXZDb21wb25lbnQocmVzcG9uc2l2ZSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoVG9vbHRpcFBvcnRhbENvbnRleHQuUHJvdmlkZXIsIHsKICAgIHZhbHVlOiB0b29sdGlwUG9ydGFsCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChMZWdlbmRQb3J0YWxDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogbGVnZW5kUG9ydGFsCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChXcmFwcGVyRGl2LCB7CiAgICB3aWR0aDogd2lkdGggIT09IG51bGwgJiYgd2lkdGggIT09IHZvaWQgMCA/IHdpZHRoIDogc3R5bGUgPT09IG51bGwgfHwgc3R5bGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHN0eWxlLndpZHRoLAogICAgaGVpZ2h0OiBoZWlnaHQgIT09IG51bGwgJiYgaGVpZ2h0ICE9PSB2b2lkIDAgPyBoZWlnaHQgOiBzdHlsZSA9PT0gbnVsbCB8fCBzdHlsZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogc3R5bGUuaGVpZ2h0LAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy13cmFwcGVyIiwgY2xhc3NOYW1lKSwKICAgIHN0eWxlOiBfb2JqZWN0U3ByZWFkMzEoewogICAgICBwb3NpdGlvbjogInJlbGF0aXZlIiwKICAgICAgY3Vyc29yOiAiZGVmYXVsdCIsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0sIHN0eWxlKSwKICAgIG9uQ2xpY2s6IG15T25DbGljaywKICAgIG9uQ29udGV4dE1lbnU6IG15T25Db250ZXh0TWVudSwKICAgIG9uRG91YmxlQ2xpY2s6IG15T25Eb3VibGVDbGljaywKICAgIG9uRm9jdXMsCiAgICBvbktleURvd24sCiAgICBvbk1vdXNlRG93bjogbXlPbk1vdXNlRG93biwKICAgIG9uTW91c2VFbnRlcjogbXlPbk1vdXNlRW50ZXIsCiAgICBvbk1vdXNlTGVhdmU6IG15T25Nb3VzZUxlYXZlLAogICAgb25Nb3VzZU1vdmU6IG15T25Nb3VzZU1vdmUsCiAgICBvbk1vdXNlVXA6IG15T25Nb3VzZVVwLAogICAgb25Ub3VjaEVuZDogbXlPblRvdWNoRW5kLAogICAgb25Ub3VjaE1vdmU6IG15T25Ub3VjaE1vdmUsCiAgICBvblRvdWNoU3RhcnQ6IG15T25Ub3VjaFN0YXJ0LAogICAgcmVmOiBpbm5lclJlZgogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoRXZlbnRTeW5jaHJvbml6ZXIsIG51bGwpLCBjaGlsZHJlbikpKTsKfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9DYXRlZ29yaWNhbENoYXJ0LmpzCnZhciBfZXhjbHVkZWQxNyA9IFsid2lkdGgiLCAiaGVpZ2h0IiwgInJlc3BvbnNpdmUiLCAiY2hpbGRyZW4iLCAiY2xhc3NOYW1lIiwgInN0eWxlIiwgImNvbXBhY3QiLCAidGl0bGUiLCAiZGVzYyJdOwpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNyhlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTcoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE3KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgQ2F0ZWdvcmljYWxDaGFydCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDguZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByZXNwb25zaXZlLAogICAgY2hpbGRyZW4sCiAgICBjbGFzc05hbWUsCiAgICBzdHlsZSwKICAgIGNvbXBhY3QsCiAgICB0aXRsZSwKICAgIGRlc2MKICB9ID0gcHJvcHMsIG90aGVycyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczE3KHByb3BzLCBfZXhjbHVkZWQxNyk7CiAgdmFyIGF0dHJzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKG90aGVycyk7CiAgaWYgKGNvbXBhY3QpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KFJlYWN0MzMuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMzLmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRTaXplLCB7CiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KFJvb3RTdXJmYWNlLCB7CiAgICAgIG90aGVyQXR0cmlidXRlczogYXR0cnMsCiAgICAgIHRpdGxlLAogICAgICBkZXNjCiAgICB9LCBjaGlsZHJlbikpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChSZWNoYXJ0c1dyYXBwZXIsIHsKICAgIGNsYXNzTmFtZSwKICAgIHN0eWxlLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByZXNwb25zaXZlOiByZXNwb25zaXZlICE9PSBudWxsICYmIHJlc3BvbnNpdmUgIT09IHZvaWQgMCA/IHJlc3BvbnNpdmUgOiBmYWxzZSwKICAgIG9uQ2xpY2s6IHByb3BzLm9uQ2xpY2ssCiAgICBvbk1vdXNlTGVhdmU6IHByb3BzLm9uTW91c2VMZWF2ZSwKICAgIG9uTW91c2VFbnRlcjogcHJvcHMub25Nb3VzZUVudGVyLAogICAgb25Nb3VzZU1vdmU6IHByb3BzLm9uTW91c2VNb3ZlLAogICAgb25Nb3VzZURvd246IHByb3BzLm9uTW91c2VEb3duLAogICAgb25Nb3VzZVVwOiBwcm9wcy5vbk1vdXNlVXAsCiAgICBvbkNvbnRleHRNZW51OiBwcm9wcy5vbkNvbnRleHRNZW51LAogICAgb25Eb3VibGVDbGljazogcHJvcHMub25Eb3VibGVDbGljaywKICAgIG9uVG91Y2hTdGFydDogcHJvcHMub25Ub3VjaFN0YXJ0LAogICAgb25Ub3VjaE1vdmU6IHByb3BzLm9uVG91Y2hNb3ZlLAogICAgb25Ub3VjaEVuZDogcHJvcHMub25Ub3VjaEVuZAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMzLmNyZWF0ZUVsZW1lbnQoUm9vdFN1cmZhY2UsIHsKICAgIG90aGVyQXR0cmlidXRlczogYXR0cnMsCiAgICB0aXRsZSwKICAgIGRlc2MsCiAgICByZWYKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KENsaXBQYXRoUHJvdmlkZXIsIG51bGwsIGNoaWxkcmVuKSkpOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L0NhcnRlc2lhbkNoYXJ0LmpzCmZ1bmN0aW9uIF9leHRlbmRzMjIoKSB7CiAgcmV0dXJuIF9leHRlbmRzMjIgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczIyLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KdmFyIGRlZmF1bHRNYXJnaW4gPSB7CiAgdG9wOiA1LAogIHJpZ2h0OiA1LAogIGJvdHRvbTogNSwKICBsZWZ0OiA1Cn07CnZhciBkZWZhdWx0Q2FydGVzaWFuQ2hhcnRQcm9wcyA9IHsKICBhY2Nlc3NpYmlsaXR5TGF5ZXI6IHRydWUsCiAgYmFyQ2F0ZWdvcnlHYXA6ICIxMCUiLAogIGJhckdhcDogNCwKICBsYXlvdXQ6ICJob3Jpem9udGFsIiwKICBtYXJnaW46IGRlZmF1bHRNYXJnaW4sCiAgcmVzcG9uc2l2ZTogZmFsc2UsCiAgcmV2ZXJzZVN0YWNrT3JkZXI6IGZhbHNlLAogIHN0YWNrT2Zmc2V0OiAibm9uZSIsCiAgc3luY01ldGhvZDogImluZGV4Igp9Owp2YXIgQ2FydGVzaWFuQ2hhcnQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ5LmZvcndhcmRSZWYpKGZ1bmN0aW9uIENhcnRlc2lhbkNoYXJ0Mihwcm9wcywgcmVmKSB7CiAgdmFyIF9jYXRlZ29yaWNhbENoYXJ0UHJvcDsKICB2YXIgcm9vdENoYXJ0UHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKHByb3BzLmNhdGVnb3JpY2FsQ2hhcnRQcm9wcywgZGVmYXVsdENhcnRlc2lhbkNoYXJ0UHJvcHMpOwogIHZhciB7CiAgICBjaGFydE5hbWUsCiAgICBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSwKICAgIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMsCiAgICB0b29sdGlwUGF5bG9hZFNlYXJjaGVyLAogICAgY2F0ZWdvcmljYWxDaGFydFByb3BzCiAgfSA9IHByb3BzOwogIHZhciBvcHRpb25zID0gewogICAgY2hhcnROYW1lLAogICAgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsCiAgICB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzLAogICAgdG9vbHRpcFBheWxvYWRTZWFyY2hlciwKICAgIGV2ZW50RW1pdHRlcjogdm9pZCAwCiAgfTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzQuY3JlYXRlRWxlbWVudChSZWNoYXJ0c1N0b3JlUHJvdmlkZXIsIHsKICAgIHByZWxvYWRlZFN0YXRlOiB7CiAgICAgIG9wdGlvbnMKICAgIH0sCiAgICByZWR1eFN0b3JlTmFtZTogKF9jYXRlZ29yaWNhbENoYXJ0UHJvcCA9IGNhdGVnb3JpY2FsQ2hhcnRQcm9wcy5pZCkgIT09IG51bGwgJiYgX2NhdGVnb3JpY2FsQ2hhcnRQcm9wICE9PSB2b2lkIDAgPyBfY2F0ZWdvcmljYWxDaGFydFByb3AgOiBjaGFydE5hbWUKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNC5jcmVhdGVFbGVtZW50KENoYXJ0RGF0YUNvbnRleHRQcm92aWRlciwgewogICAgY2hhcnREYXRhOiBjYXRlZ29yaWNhbENoYXJ0UHJvcHMuZGF0YQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNC5jcmVhdGVFbGVtZW50KFJlcG9ydE1haW5DaGFydFByb3BzLCB7CiAgICBsYXlvdXQ6IHJvb3RDaGFydFByb3BzLmxheW91dCwKICAgIG1hcmdpbjogcm9vdENoYXJ0UHJvcHMubWFyZ2luCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM0LmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRQcm9wcywgewogICAgYmFzZVZhbHVlOiByb290Q2hhcnRQcm9wcy5iYXNlVmFsdWUsCiAgICBhY2Nlc3NpYmlsaXR5TGF5ZXI6IHJvb3RDaGFydFByb3BzLmFjY2Vzc2liaWxpdHlMYXllciwKICAgIGJhckNhdGVnb3J5R2FwOiByb290Q2hhcnRQcm9wcy5iYXJDYXRlZ29yeUdhcCwKICAgIG1heEJhclNpemU6IHJvb3RDaGFydFByb3BzLm1heEJhclNpemUsCiAgICBzdGFja09mZnNldDogcm9vdENoYXJ0UHJvcHMuc3RhY2tPZmZzZXQsCiAgICBiYXJHYXA6IHJvb3RDaGFydFByb3BzLmJhckdhcCwKICAgIGJhclNpemU6IHJvb3RDaGFydFByb3BzLmJhclNpemUsCiAgICBzeW5jSWQ6IHJvb3RDaGFydFByb3BzLnN5bmNJZCwKICAgIHN5bmNNZXRob2Q6IHJvb3RDaGFydFByb3BzLnN5bmNNZXRob2QsCiAgICBjbGFzc05hbWU6IHJvb3RDaGFydFByb3BzLmNsYXNzTmFtZSwKICAgIHJldmVyc2VTdGFja09yZGVyOiByb290Q2hhcnRQcm9wcy5yZXZlcnNlU3RhY2tPcmRlcgogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNC5jcmVhdGVFbGVtZW50KENhdGVnb3JpY2FsQ2hhcnQsIF9leHRlbmRzMjIoe30sIHJvb3RDaGFydFByb3BzLCB7CiAgICByZWYKICB9KSkpOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L0FyZWFDaGFydC5qcwp2YXIgUmVhY3QzNSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDUwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgYWxsb3dlZFRvb2x0aXBUeXBlcyA9IFsiYXhpcyJdOwp2YXIgQXJlYUNoYXJ0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q1MC5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzNS5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkNoYXJ0LCB7CiAgICBjaGFydE5hbWU6ICJBcmVhQ2hhcnQiLAogICAgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGU6ICJheGlzIiwKICAgIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXM6IGFsbG93ZWRUb29sdGlwVHlwZXMsCiAgICB0b29sdGlwUGF5bG9hZFNlYXJjaGVyOiBhcnJheVRvb2x0aXBTZWFyY2hlciwKICAgIGNhdGVnb3JpY2FsQ2hhcnRQcm9wczogcHJvcHMsCiAgICByZWYKICB9KTsKfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vdHNsaWJAMi44LjEvbm9kZV9tb2R1bGVzL3RzbGliL3RzbGliLmVzNi5tanMKZnVuY3Rpb24gX19yZXN0KHMsIGUpIHsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIHAgaW4gcykgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChzLCBwKSAmJiBlLmluZGV4T2YocCkgPCAwKQogICAgdFtwXSA9IHNbcF07CiAgaWYgKHMgIT0gbnVsbCAmJiB0eXBlb2YgT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyA9PT0gImZ1bmN0aW9uIikKICAgIGZvciAodmFyIGkgPSAwLCBwID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhzKTsgaSA8IHAubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGUuaW5kZXhPZihwW2ldKSA8IDAgJiYgT2JqZWN0LnByb3RvdHlwZS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKHMsIHBbaV0pKQogICAgICAgIHRbcFtpXV0gPSBzW3BbaV1dOwogICAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9fYXdhaXRlcih0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHsKICBmdW5jdGlvbiBhZG9wdCh2YWx1ZSkgewogICAgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgUCA/IHZhbHVlIDogbmV3IFAoZnVuY3Rpb24ocmVzb2x2ZSkgewogICAgICByZXNvbHZlKHZhbHVlKTsKICAgIH0pOwogIH0KICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7CiAgICAgIHRyeSB7CiAgICAgICAgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmVqZWN0KGUpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgewogICAgICB0cnkgewogICAgICAgIHN0ZXAoZ2VuZXJhdG9yWyJ0aHJvdyJdKHZhbHVlKSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZWplY3QoZSk7CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7CiAgICAgIHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogYWRvcHQocmVzdWx0LnZhbHVlKS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOwogICAgfQogICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpOwogIH0pOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK2Z1bmN0aW9ucy1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9mdW5jdGlvbnMtanMvZGlzdC9tb2R1bGUvaGVscGVyLmpzCnZhciByZXNvbHZlRmV0Y2ggPSAoY3VzdG9tRmV0Y2gpID0+IHsKICBpZiAoY3VzdG9tRmV0Y2gpIHsKICAgIHJldHVybiAoLi4uYXJncykgPT4gY3VzdG9tRmV0Y2goLi4uYXJncyk7CiAgfQogIHJldHVybiAoLi4uYXJncykgPT4gZmV0Y2goLi4uYXJncyk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK2Z1bmN0aW9ucy1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9mdW5jdGlvbnMtanMvZGlzdC9tb2R1bGUvdHlwZXMuanMKdmFyIEZ1bmN0aW9uc0Vycm9yID0gY2xhc3MgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSwgbmFtZSA9ICJGdW5jdGlvbnNFcnJvciIsIGNvbnRleHQpIHsKICAgIHN1cGVyKG1lc3NhZ2UpOwogICAgdGhpcy5uYW1lID0gbmFtZTsKICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgfQp9Owp2YXIgRnVuY3Rpb25zRmV0Y2hFcnJvciA9IGNsYXNzIGV4dGVuZHMgRnVuY3Rpb25zRXJyb3IgewogIGNvbnN0cnVjdG9yKGNvbnRleHQpIHsKICAgIHN1cGVyKCJGYWlsZWQgdG8gc2VuZCBhIHJlcXVlc3QgdG8gdGhlIEVkZ2UgRnVuY3Rpb24iLCAiRnVuY3Rpb25zRmV0Y2hFcnJvciIsIGNvbnRleHQpOwogIH0KfTsKdmFyIEZ1bmN0aW9uc1JlbGF5RXJyb3IgPSBjbGFzcyBleHRlbmRzIEZ1bmN0aW9uc0Vycm9yIHsKICBjb25zdHJ1Y3Rvcihjb250ZXh0KSB7CiAgICBzdXBlcigiUmVsYXkgRXJyb3IgaW52b2tpbmcgdGhlIEVkZ2UgRnVuY3Rpb24iLCAiRnVuY3Rpb25zUmVsYXlFcnJvciIsIGNvbnRleHQpOwogIH0KfTsKdmFyIEZ1bmN0aW9uc0h0dHBFcnJvciA9IGNsYXNzIGV4dGVuZHMgRnVuY3Rpb25zRXJyb3IgewogIGNvbnN0cnVjdG9yKGNvbnRleHQpIHsKICAgIHN1cGVyKCJFZGdlIEZ1bmN0aW9uIHJldHVybmVkIGEgbm9uLTJ4eCBzdGF0dXMgY29kZSIsICJGdW5jdGlvbnNIdHRwRXJyb3IiLCBjb250ZXh0KTsKICB9Cn07CnZhciBGdW5jdGlvblJlZ2lvbjsKKGZ1bmN0aW9uKEZ1bmN0aW9uUmVnaW9uMikgewogIEZ1bmN0aW9uUmVnaW9uMlsiQW55Il0gPSAiYW55IjsKICBGdW5jdGlvblJlZ2lvbjJbIkFwTm9ydGhlYXN0MSJdID0gImFwLW5vcnRoZWFzdC0xIjsKICBGdW5jdGlvblJlZ2lvbjJbIkFwTm9ydGhlYXN0MiJdID0gImFwLW5vcnRoZWFzdC0yIjsKICBGdW5jdGlvblJlZ2lvbjJbIkFwU291dGgxIl0gPSAiYXAtc291dGgtMSI7CiAgRnVuY3Rpb25SZWdpb24yWyJBcFNvdXRoZWFzdDEiXSA9ICJhcC1zb3V0aGVhc3QtMSI7CiAgRnVuY3Rpb25SZWdpb24yWyJBcFNvdXRoZWFzdDIiXSA9ICJhcC1zb3V0aGVhc3QtMiI7CiAgRnVuY3Rpb25SZWdpb24yWyJDYUNlbnRyYWwxIl0gPSAiY2EtY2VudHJhbC0xIjsKICBGdW5jdGlvblJlZ2lvbjJbIkV1Q2VudHJhbDEiXSA9ICJldS1jZW50cmFsLTEiOwogIEZ1bmN0aW9uUmVnaW9uMlsiRXVXZXN0MSJdID0gImV1LXdlc3QtMSI7CiAgRnVuY3Rpb25SZWdpb24yWyJFdVdlc3QyIl0gPSAiZXUtd2VzdC0yIjsKICBGdW5jdGlvblJlZ2lvbjJbIkV1V2VzdDMiXSA9ICJldS13ZXN0LTMiOwogIEZ1bmN0aW9uUmVnaW9uMlsiU2FFYXN0MSJdID0gInNhLWVhc3QtMSI7CiAgRnVuY3Rpb25SZWdpb24yWyJVc0Vhc3QxIl0gPSAidXMtZWFzdC0xIjsKICBGdW5jdGlvblJlZ2lvbjJbIlVzV2VzdDEiXSA9ICJ1cy13ZXN0LTEiOwogIEZ1bmN0aW9uUmVnaW9uMlsiVXNXZXN0MiJdID0gInVzLXdlc3QtMiI7Cn0pKEZ1bmN0aW9uUmVnaW9uIHx8IChGdW5jdGlvblJlZ2lvbiA9IHt9KSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK2Z1bmN0aW9ucy1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9mdW5jdGlvbnMtanMvZGlzdC9tb2R1bGUvRnVuY3Rpb25zQ2xpZW50LmpzCnZhciBGdW5jdGlvbnNDbGllbnQgPSBjbGFzcyB7CiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBGdW5jdGlvbnMgY2xpZW50IGJvdW5kIHRvIGFuIEVkZ2UgRnVuY3Rpb25zIFVSTC4KICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHMKICAgKiBpbXBvcnQgeyBGdW5jdGlvbnNDbGllbnQsIEZ1bmN0aW9uUmVnaW9uIH0gZnJvbSAnQHN1cGFiYXNlL2Z1bmN0aW9ucy1qcycKICAgKgogICAqIGNvbnN0IGZ1bmN0aW9ucyA9IG5ldyBGdW5jdGlvbnNDbGllbnQoJ2h0dHBzOi8veHl6Y29tcGFueS5zdXBhYmFzZS5jby9mdW5jdGlvbnMvdjEnLCB7CiAgICogICBoZWFkZXJzOiB7IGFwaWtleTogJ3B1YmxpYy1hbm9uLWtleScgfSwKICAgKiAgIHJlZ2lvbjogRnVuY3Rpb25SZWdpb24uVXNFYXN0MSwKICAgKiB9KQogICAqIGBgYAogICAqLwogIGNvbnN0cnVjdG9yKHVybCwgeyBoZWFkZXJzID0ge30sIGN1c3RvbUZldGNoLCByZWdpb24gPSBGdW5jdGlvblJlZ2lvbi5BbnkgfSA9IHt9KSB7CiAgICB0aGlzLnVybCA9IHVybDsKICAgIHRoaXMuaGVhZGVycyA9IGhlYWRlcnM7CiAgICB0aGlzLnJlZ2lvbiA9IHJlZ2lvbjsKICAgIHRoaXMuZmV0Y2ggPSByZXNvbHZlRmV0Y2goY3VzdG9tRmV0Y2gpOwogIH0KICAvKioKICAgKiBVcGRhdGVzIHRoZSBhdXRob3JpemF0aW9uIGhlYWRlcgogICAqIEBwYXJhbSB0b2tlbiAtIHRoZSBuZXcgand0IHRva2VuIHNlbnQgaW4gdGhlIGF1dGhvcmlzYXRpb24gaGVhZGVyCiAgICogQGV4YW1wbGUKICAgKiBgYGB0cwogICAqIGZ1bmN0aW9ucy5zZXRBdXRoKHNlc3Npb24uYWNjZXNzX3Rva2VuKQogICAqIGBgYAogICAqLwogIHNldEF1dGgodG9rZW4pIHsKICAgIHRoaXMuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYEJlYXJlciAke3Rva2VufWA7CiAgfQogIC8qKgogICAqIEludm9rZXMgYSBmdW5jdGlvbgogICAqIEBwYXJhbSBmdW5jdGlvbk5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgRnVuY3Rpb24gdG8gaW52b2tlLgogICAqIEBwYXJhbSBvcHRpb25zIC0gT3B0aW9ucyBmb3IgaW52b2tpbmcgdGhlIEZ1bmN0aW9uLgogICAqIEBleGFtcGxlCiAgICogYGBgdHMKICAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBmdW5jdGlvbnMuaW52b2tlKCdoZWxsby13b3JsZCcsIHsKICAgKiAgIGJvZHk6IHsgbmFtZTogJ0FkYScgfSwKICAgKiB9KQogICAqIGBgYAogICAqLwogIGludm9rZShmdW5jdGlvbk5hbWVfMSkgewogICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCBhcmd1bWVudHMsIHZvaWQgMCwgZnVuY3Rpb24qIChmdW5jdGlvbk5hbWUsIG9wdGlvbnMgPSB7fSkgewogICAgICB2YXIgX2E7CiAgICAgIGxldCB0aW1lb3V0SWQ7CiAgICAgIGxldCB0aW1lb3V0Q29udHJvbGxlcjsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCB7IGhlYWRlcnMsIG1ldGhvZCwgYm9keTogZnVuY3Rpb25BcmdzLCBzaWduYWwsIHRpbWVvdXQgfSA9IG9wdGlvbnM7CiAgICAgICAgbGV0IF9oZWFkZXJzID0ge307CiAgICAgICAgbGV0IHsgcmVnaW9uIH0gPSBvcHRpb25zOwogICAgICAgIGlmICghcmVnaW9uKSB7CiAgICAgICAgICByZWdpb24gPSB0aGlzLnJlZ2lvbjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdXJsID0gbmV3IFVSTChgJHt0aGlzLnVybH0vJHtmdW5jdGlvbk5hbWV9YCk7CiAgICAgICAgaWYgKHJlZ2lvbiAmJiByZWdpb24gIT09ICJhbnkiKSB7CiAgICAgICAgICBfaGVhZGVyc1sieC1yZWdpb24iXSA9IHJlZ2lvbjsKICAgICAgICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCJmb3JjZUZ1bmN0aW9uUmVnaW9uIiwgcmVnaW9uKTsKICAgICAgICB9CiAgICAgICAgbGV0IGJvZHk7CiAgICAgICAgaWYgKGZ1bmN0aW9uQXJncyAmJiAoaGVhZGVycyAmJiAhT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKGhlYWRlcnMsICJDb250ZW50LVR5cGUiKSB8fCAhaGVhZGVycykpIHsKICAgICAgICAgIGlmICh0eXBlb2YgQmxvYiAhPT0gInVuZGVmaW5lZCIgJiYgZnVuY3Rpb25BcmdzIGluc3RhbmNlb2YgQmxvYiB8fCBmdW5jdGlvbkFyZ3MgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcikgewogICAgICAgICAgICBfaGVhZGVyc1siQ29udGVudC1UeXBlIl0gPSAiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtIjsKICAgICAgICAgICAgYm9keSA9IGZ1bmN0aW9uQXJnczsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGZ1bmN0aW9uQXJncyA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgX2hlYWRlcnNbIkNvbnRlbnQtVHlwZSJdID0gInRleHQvcGxhaW4iOwogICAgICAgICAgICBib2R5ID0gZnVuY3Rpb25BcmdzOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgRm9ybURhdGEgIT09ICJ1bmRlZmluZWQiICYmIGZ1bmN0aW9uQXJncyBpbnN0YW5jZW9mIEZvcm1EYXRhKSB7CiAgICAgICAgICAgIGJvZHkgPSBmdW5jdGlvbkFyZ3M7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBfaGVhZGVyc1siQ29udGVudC1UeXBlIl0gPSAiYXBwbGljYXRpb24vanNvbiI7CiAgICAgICAgICAgIGJvZHkgPSBKU09OLnN0cmluZ2lmeShmdW5jdGlvbkFyZ3MpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoZnVuY3Rpb25BcmdzICYmIHR5cGVvZiBmdW5jdGlvbkFyZ3MgIT09ICJzdHJpbmciICYmICEodHlwZW9mIEJsb2IgIT09ICJ1bmRlZmluZWQiICYmIGZ1bmN0aW9uQXJncyBpbnN0YW5jZW9mIEJsb2IpICYmICEoZnVuY3Rpb25BcmdzIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpICYmICEodHlwZW9mIEZvcm1EYXRhICE9PSAidW5kZWZpbmVkIiAmJiBmdW5jdGlvbkFyZ3MgaW5zdGFuY2VvZiBGb3JtRGF0YSkpIHsKICAgICAgICAgICAgYm9keSA9IEpTT04uc3RyaW5naWZ5KGZ1bmN0aW9uQXJncyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBib2R5ID0gZnVuY3Rpb25BcmdzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZXQgZWZmZWN0aXZlU2lnbmFsID0gc2lnbmFsOwogICAgICAgIGlmICh0aW1lb3V0KSB7CiAgICAgICAgICB0aW1lb3V0Q29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgICAgICAgIHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4gdGltZW91dENvbnRyb2xsZXIuYWJvcnQoKSwgdGltZW91dCk7CiAgICAgICAgICBpZiAoc2lnbmFsKSB7CiAgICAgICAgICAgIGVmZmVjdGl2ZVNpZ25hbCA9IHRpbWVvdXRDb250cm9sbGVyLnNpZ25hbDsKICAgICAgICAgICAgc2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoImFib3J0IiwgKCkgPT4gdGltZW91dENvbnRyb2xsZXIuYWJvcnQoKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlZmZlY3RpdmVTaWduYWwgPSB0aW1lb3V0Q29udHJvbGxlci5zaWduYWw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlc3BvbnNlID0geWllbGQgdGhpcy5mZXRjaCh1cmwudG9TdHJpbmcoKSwgewogICAgICAgICAgbWV0aG9kOiBtZXRob2QgfHwgIlBPU1QiLAogICAgICAgICAgLy8gaGVhZGVycyBwcmlvcml0eSBpcyAoaGlnaCB0byBsb3cpOgogICAgICAgICAgLy8gMS4gaW52b2tlLWxldmVsIGhlYWRlcnMKICAgICAgICAgIC8vIDIuIGNsaWVudC1sZXZlbCBoZWFkZXJzCiAgICAgICAgICAvLyAzLiBkZWZhdWx0IENvbnRlbnQtVHlwZSBoZWFkZXIKICAgICAgICAgIGhlYWRlcnM6IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBfaGVhZGVycyksIHRoaXMuaGVhZGVycyksIGhlYWRlcnMpLAogICAgICAgICAgYm9keSwKICAgICAgICAgIHNpZ25hbDogZWZmZWN0aXZlU2lnbmFsCiAgICAgICAgfSkuY2F0Y2goKGZldGNoRXJyb3IpID0+IHsKICAgICAgICAgIHRocm93IG5ldyBGdW5jdGlvbnNGZXRjaEVycm9yKGZldGNoRXJyb3IpOwogICAgICAgIH0pOwogICAgICAgIGNvbnN0IGlzUmVsYXlFcnJvciA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCJ4LXJlbGF5LWVycm9yIik7CiAgICAgICAgaWYgKGlzUmVsYXlFcnJvciAmJiBpc1JlbGF5RXJyb3IgPT09ICJ0cnVlIikgewogICAgICAgICAgdGhyb3cgbmV3IEZ1bmN0aW9uc1JlbGF5RXJyb3IocmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRnVuY3Rpb25zSHR0cEVycm9yKHJlc3BvbnNlKTsKICAgICAgICB9CiAgICAgICAgbGV0IHJlc3BvbnNlVHlwZSA9ICgoX2EgPSByZXNwb25zZS5oZWFkZXJzLmdldCgiQ29udGVudC1UeXBlIikpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6ICJ0ZXh0L3BsYWluIikuc3BsaXQoIjsiKVswXS50cmltKCk7CiAgICAgICAgbGV0IGRhdGE7CiAgICAgICAgaWYgKHJlc3BvbnNlVHlwZSA9PT0gImFwcGxpY2F0aW9uL2pzb24iKSB7CiAgICAgICAgICBkYXRhID0geWllbGQgcmVzcG9uc2UuanNvbigpOwogICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2VUeXBlID09PSAiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtIiB8fCByZXNwb25zZVR5cGUgPT09ICJhcHBsaWNhdGlvbi9wZGYiKSB7CiAgICAgICAgICBkYXRhID0geWllbGQgcmVzcG9uc2UuYmxvYigpOwogICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2VUeXBlID09PSAidGV4dC9ldmVudC1zdHJlYW0iKSB7CiAgICAgICAgICBkYXRhID0gcmVzcG9uc2U7CiAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZVR5cGUgPT09ICJtdWx0aXBhcnQvZm9ybS1kYXRhIikgewogICAgICAgICAgZGF0YSA9IHlpZWxkIHJlc3BvbnNlLmZvcm1EYXRhKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRhdGEgPSB5aWVsZCByZXNwb25zZS50ZXh0KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7IGRhdGEsIGVycm9yOiBudWxsLCByZXNwb25zZSB9OwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBkYXRhOiBudWxsLAogICAgICAgICAgZXJyb3IsCiAgICAgICAgICByZXNwb25zZTogZXJyb3IgaW5zdGFuY2VvZiBGdW5jdGlvbnNIdHRwRXJyb3IgfHwgZXJyb3IgaW5zdGFuY2VvZiBGdW5jdGlvbnNSZWxheUVycm9yID8gZXJyb3IuY29udGV4dCA6IHZvaWQgMAogICAgICAgIH07CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgaWYgKHRpbWVvdXRJZCkgewogICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK3Bvc3RncmVzdC1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9wb3N0Z3Jlc3QtanMvZGlzdC9pbmRleC5tanMKdmFyIFBvc3RncmVzdEVycm9yID0gY2xhc3MgZXh0ZW5kcyBFcnJvciB7CiAgLyoqCiAgKiBAZXhhbXBsZQogICogYGBgdHMKICAqIGltcG9ydCBQb3N0Z3Jlc3RFcnJvciBmcm9tICdAc3VwYWJhc2UvcG9zdGdyZXN0LWpzJwogICoKICAqIHRocm93IG5ldyBQb3N0Z3Jlc3RFcnJvcih7CiAgKiAgIG1lc3NhZ2U6ICdSb3cgbGV2ZWwgc2VjdXJpdHkgcHJldmVudGVkIHRoZSByZXF1ZXN0JywKICAqICAgZGV0YWlsczogJ1JMUyBkZW5pZWQgdGhlIGluc2VydCcsCiAgKiAgIGhpbnQ6ICdDaGVjayB5b3VyIHBvbGljaWVzJywKICAqICAgY29kZTogJ1BHUlNUMzAxJywKICAqIH0pCiAgKiBgYGAKICAqLwogIGNvbnN0cnVjdG9yKGNvbnRleHQpIHsKICAgIHN1cGVyKGNvbnRleHQubWVzc2FnZSk7CiAgICB0aGlzLm5hbWUgPSAiUG9zdGdyZXN0RXJyb3IiOwogICAgdGhpcy5kZXRhaWxzID0gY29udGV4dC5kZXRhaWxzOwogICAgdGhpcy5oaW50ID0gY29udGV4dC5oaW50OwogICAgdGhpcy5jb2RlID0gY29udGV4dC5jb2RlOwogIH0KfTsKdmFyIFBvc3RncmVzdEJ1aWxkZXIgPSBjbGFzcyB7CiAgLyoqCiAgKiBDcmVhdGVzIGEgYnVpbGRlciBjb25maWd1cmVkIGZvciBhIHNwZWNpZmljIFBvc3RnUkVTVCByZXF1ZXN0LgogICoKICAqIEBleGFtcGxlCiAgKiBgYGB0cwogICogaW1wb3J0IFBvc3RncmVzdFF1ZXJ5QnVpbGRlciBmcm9tICdAc3VwYWJhc2UvcG9zdGdyZXN0LWpzJwogICoKICAqIGNvbnN0IGJ1aWxkZXIgPSBuZXcgUG9zdGdyZXN0UXVlcnlCdWlsZGVyKAogICogICBuZXcgVVJMKCdodHRwczovL3h5emNvbXBhbnkuc3VwYWJhc2UuY28vcmVzdC92MS91c2VycycpLAogICogICB7IGhlYWRlcnM6IG5ldyBIZWFkZXJzKHsgYXBpa2V5OiAncHVibGljLWFub24ta2V5JyB9KSB9CiAgKiApCiAgKiBgYGAKICAqLwogIGNvbnN0cnVjdG9yKGJ1aWxkZXIpIHsKICAgIHZhciBfYnVpbGRlciRzaG91bGRUaHJvd08sIF9idWlsZGVyJGlzTWF5YmVTaW5nbCwgX2J1aWxkZXIkdXJsTGVuZ3RoTGltOwogICAgdGhpcy5zaG91bGRUaHJvd09uRXJyb3IgPSBmYWxzZTsKICAgIHRoaXMubWV0aG9kID0gYnVpbGRlci5tZXRob2Q7CiAgICB0aGlzLnVybCA9IGJ1aWxkZXIudXJsOwogICAgdGhpcy5oZWFkZXJzID0gbmV3IEhlYWRlcnMoYnVpbGRlci5oZWFkZXJzKTsKICAgIHRoaXMuc2NoZW1hID0gYnVpbGRlci5zY2hlbWE7CiAgICB0aGlzLmJvZHkgPSBidWlsZGVyLmJvZHk7CiAgICB0aGlzLnNob3VsZFRocm93T25FcnJvciA9IChfYnVpbGRlciRzaG91bGRUaHJvd08gPSBidWlsZGVyLnNob3VsZFRocm93T25FcnJvcikgIT09IG51bGwgJiYgX2J1aWxkZXIkc2hvdWxkVGhyb3dPICE9PSB2b2lkIDAgPyBfYnVpbGRlciRzaG91bGRUaHJvd08gOiBmYWxzZTsKICAgIHRoaXMuc2lnbmFsID0gYnVpbGRlci5zaWduYWw7CiAgICB0aGlzLmlzTWF5YmVTaW5nbGUgPSAoX2J1aWxkZXIkaXNNYXliZVNpbmdsID0gYnVpbGRlci5pc01heWJlU2luZ2xlKSAhPT0gbnVsbCAmJiBfYnVpbGRlciRpc01heWJlU2luZ2wgIT09IHZvaWQgMCA/IF9idWlsZGVyJGlzTWF5YmVTaW5nbCA6IGZhbHNlOwogICAgdGhpcy51cmxMZW5ndGhMaW1pdCA9IChfYnVpbGRlciR1cmxMZW5ndGhMaW0gPSBidWlsZGVyLnVybExlbmd0aExpbWl0KSAhPT0gbnVsbCAmJiBfYnVpbGRlciR1cmxMZW5ndGhMaW0gIT09IHZvaWQgMCA/IF9idWlsZGVyJHVybExlbmd0aExpbSA6IDhlMzsKICAgIGlmIChidWlsZGVyLmZldGNoKSB0aGlzLmZldGNoID0gYnVpbGRlci5mZXRjaDsKICAgIGVsc2UgdGhpcy5mZXRjaCA9IGZldGNoOwogIH0KICAvKioKICAqIElmIHRoZXJlJ3MgYW4gZXJyb3Igd2l0aCB0aGUgcXVlcnksIHRocm93T25FcnJvciB3aWxsIHJlamVjdCB0aGUgcHJvbWlzZSBieQogICogdGhyb3dpbmcgdGhlIGVycm9yIGluc3RlYWQgb2YgcmV0dXJuaW5nIGl0IGFzIHBhcnQgb2YgYSBzdWNjZXNzZnVsIHJlc3BvbnNlLgogICoKICAqIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vc3VwYWJhc2Uvc3VwYWJhc2UtanMvaXNzdWVzLzkyfQogICovCiAgdGhyb3dPbkVycm9yKCkgewogICAgdGhpcy5zaG91bGRUaHJvd09uRXJyb3IgPSB0cnVlOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogU2V0IGFuIEhUVFAgaGVhZGVyIGZvciB0aGUgcmVxdWVzdC4KICAqLwogIHNldEhlYWRlcihuYW1lLCB2YWx1ZSkgewogICAgdGhpcy5oZWFkZXJzID0gbmV3IEhlYWRlcnModGhpcy5oZWFkZXJzKTsKICAgIHRoaXMuaGVhZGVycy5zZXQobmFtZSwgdmFsdWUpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIHRoZW4ob25mdWxmaWxsZWQsIG9ucmVqZWN0ZWQpIHsKICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICBpZiAodGhpcy5zY2hlbWEgPT09IHZvaWQgMCkgewogICAgfSBlbHNlIGlmIChbIkdFVCIsICJIRUFEIl0uaW5jbHVkZXModGhpcy5tZXRob2QpKSB0aGlzLmhlYWRlcnMuc2V0KCJBY2NlcHQtUHJvZmlsZSIsIHRoaXMuc2NoZW1hKTsKICAgIGVsc2UgdGhpcy5oZWFkZXJzLnNldCgiQ29udGVudC1Qcm9maWxlIiwgdGhpcy5zY2hlbWEpOwogICAgaWYgKHRoaXMubWV0aG9kICE9PSAiR0VUIiAmJiB0aGlzLm1ldGhvZCAhPT0gIkhFQUQiKSB0aGlzLmhlYWRlcnMuc2V0KCJDb250ZW50LVR5cGUiLCAiYXBwbGljYXRpb24vanNvbiIpOwogICAgY29uc3QgX2ZldGNoID0gdGhpcy5mZXRjaDsKICAgIGxldCByZXMgPSBfZmV0Y2godGhpcy51cmwudG9TdHJpbmcoKSwgewogICAgICBtZXRob2Q6IHRoaXMubWV0aG9kLAogICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHRoaXMuYm9keSksCiAgICAgIHNpZ25hbDogdGhpcy5zaWduYWwKICAgIH0pLnRoZW4oYXN5bmMgKHJlcyQxKSA9PiB7CiAgICAgIGxldCBlcnJvciA9IG51bGw7CiAgICAgIGxldCBkYXRhID0gbnVsbDsKICAgICAgbGV0IGNvdW50ID0gbnVsbDsKICAgICAgbGV0IHN0YXR1cyA9IHJlcyQxLnN0YXR1czsKICAgICAgbGV0IHN0YXR1c1RleHQgPSByZXMkMS5zdGF0dXNUZXh0OwogICAgICBpZiAocmVzJDEub2spIHsKICAgICAgICB2YXIgX3RoaXMkaGVhZGVycyRnZXQyLCBfcmVzJGhlYWRlcnMkZ2V0OwogICAgICAgIGlmIChfdGhpcy5tZXRob2QgIT09ICJIRUFEIikgewogICAgICAgICAgdmFyIF90aGlzJGhlYWRlcnMkZ2V0OwogICAgICAgICAgY29uc3QgYm9keSA9IGF3YWl0IHJlcyQxLnRleHQoKTsKICAgICAgICAgIGlmIChib2R5ID09PSAiIikgewogICAgICAgICAgfSBlbHNlIGlmIChfdGhpcy5oZWFkZXJzLmdldCgiQWNjZXB0IikgPT09ICJ0ZXh0L2NzdiIpIGRhdGEgPSBib2R5OwogICAgICAgICAgZWxzZSBpZiAoX3RoaXMuaGVhZGVycy5nZXQoIkFjY2VwdCIpICYmICgoX3RoaXMkaGVhZGVycyRnZXQgPSBfdGhpcy5oZWFkZXJzLmdldCgiQWNjZXB0IikpID09PSBudWxsIHx8IF90aGlzJGhlYWRlcnMkZ2V0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdGhpcyRoZWFkZXJzJGdldC5pbmNsdWRlcygiYXBwbGljYXRpb24vdm5kLnBncnN0LnBsYW4rdGV4dCIpKSkgZGF0YSA9IGJvZHk7CiAgICAgICAgICBlbHNlIGRhdGEgPSBKU09OLnBhcnNlKGJvZHkpOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb3VudEhlYWRlciA9IChfdGhpcyRoZWFkZXJzJGdldDIgPSBfdGhpcy5oZWFkZXJzLmdldCgiUHJlZmVyIikpID09PSBudWxsIHx8IF90aGlzJGhlYWRlcnMkZ2V0MiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RoaXMkaGVhZGVycyRnZXQyLm1hdGNoKC9jb3VudD0oZXhhY3R8cGxhbm5lZHxlc3RpbWF0ZWQpLyk7CiAgICAgICAgY29uc3QgY29udGVudFJhbmdlID0gKF9yZXMkaGVhZGVycyRnZXQgPSByZXMkMS5oZWFkZXJzLmdldCgiY29udGVudC1yYW5nZSIpKSA9PT0gbnVsbCB8fCBfcmVzJGhlYWRlcnMkZ2V0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfcmVzJGhlYWRlcnMkZ2V0LnNwbGl0KCIvIik7CiAgICAgICAgaWYgKGNvdW50SGVhZGVyICYmIGNvbnRlbnRSYW5nZSAmJiBjb250ZW50UmFuZ2UubGVuZ3RoID4gMSkgY291bnQgPSBwYXJzZUludChjb250ZW50UmFuZ2VbMV0pOwogICAgICAgIGlmIChfdGhpcy5pc01heWJlU2luZ2xlICYmIF90aGlzLm1ldGhvZCA9PT0gIkdFVCIgJiYgQXJyYXkuaXNBcnJheShkYXRhKSkgaWYgKGRhdGEubGVuZ3RoID4gMSkgewogICAgICAgICAgZXJyb3IgPSB7CiAgICAgICAgICAgIGNvZGU6ICJQR1JTVDExNiIsCiAgICAgICAgICAgIGRldGFpbHM6IGBSZXN1bHRzIGNvbnRhaW4gJHtkYXRhLmxlbmd0aH0gcm93cywgYXBwbGljYXRpb24vdm5kLnBncnN0Lm9iamVjdCtqc29uIHJlcXVpcmVzIDEgcm93YCwKICAgICAgICAgICAgaGludDogbnVsbCwKICAgICAgICAgICAgbWVzc2FnZTogIkpTT04gb2JqZWN0IHJlcXVlc3RlZCwgbXVsdGlwbGUgKG9yIG5vKSByb3dzIHJldHVybmVkIgogICAgICAgICAgfTsKICAgICAgICAgIGRhdGEgPSBudWxsOwogICAgICAgICAgY291bnQgPSBudWxsOwogICAgICAgICAgc3RhdHVzID0gNDA2OwogICAgICAgICAgc3RhdHVzVGV4dCA9ICJOb3QgQWNjZXB0YWJsZSI7CiAgICAgICAgfSBlbHNlIGlmIChkYXRhLmxlbmd0aCA9PT0gMSkgZGF0YSA9IGRhdGFbMF07CiAgICAgICAgZWxzZSBkYXRhID0gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgX2Vycm9yJGRldGFpbHM7CiAgICAgICAgY29uc3QgYm9keSA9IGF3YWl0IHJlcyQxLnRleHQoKTsKICAgICAgICB0cnkgewogICAgICAgICAgZXJyb3IgPSBKU09OLnBhcnNlKGJvZHkpOwogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZXJyb3IpICYmIHJlcyQxLnN0YXR1cyA9PT0gNDA0KSB7CiAgICAgICAgICAgIGRhdGEgPSBbXTsKICAgICAgICAgICAgZXJyb3IgPSBudWxsOwogICAgICAgICAgICBzdGF0dXMgPSAyMDA7CiAgICAgICAgICAgIHN0YXR1c1RleHQgPSAiT0siOwogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgICAgICAgIGlmIChyZXMkMS5zdGF0dXMgPT09IDQwNCAmJiBib2R5ID09PSAiIikgewogICAgICAgICAgICBzdGF0dXMgPSAyMDQ7CiAgICAgICAgICAgIHN0YXR1c1RleHQgPSAiTm8gQ29udGVudCI7CiAgICAgICAgICB9IGVsc2UgZXJyb3IgPSB7IG1lc3NhZ2U6IGJvZHkgfTsKICAgICAgICB9CiAgICAgICAgaWYgKGVycm9yICYmIF90aGlzLmlzTWF5YmVTaW5nbGUgJiYgKGVycm9yID09PSBudWxsIHx8IGVycm9yID09PSB2b2lkIDAgfHwgKF9lcnJvciRkZXRhaWxzID0gZXJyb3IuZGV0YWlscykgPT09IG51bGwgfHwgX2Vycm9yJGRldGFpbHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lcnJvciRkZXRhaWxzLmluY2x1ZGVzKCIwIHJvd3MiKSkpIHsKICAgICAgICAgIGVycm9yID0gbnVsbDsKICAgICAgICAgIHN0YXR1cyA9IDIwMDsKICAgICAgICAgIHN0YXR1c1RleHQgPSAiT0siOwogICAgICAgIH0KICAgICAgICBpZiAoZXJyb3IgJiYgX3RoaXMuc2hvdWxkVGhyb3dPbkVycm9yKSB0aHJvdyBuZXcgUG9zdGdyZXN0RXJyb3IoZXJyb3IpOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgZXJyb3IsCiAgICAgICAgZGF0YSwKICAgICAgICBjb3VudCwKICAgICAgICBzdGF0dXMsCiAgICAgICAgc3RhdHVzVGV4dAogICAgICB9OwogICAgfSk7CiAgICBpZiAoIXRoaXMuc2hvdWxkVGhyb3dPbkVycm9yKSByZXMgPSByZXMuY2F0Y2goKGZldGNoRXJyb3IpID0+IHsKICAgICAgdmFyIF9mZXRjaEVycm9yJG5hbWUyOwogICAgICBsZXQgZXJyb3JEZXRhaWxzID0gIiI7CiAgICAgIGxldCBoaW50ID0gIiI7CiAgICAgIGxldCBjb2RlID0gIiI7CiAgICAgIGNvbnN0IGNhdXNlID0gZmV0Y2hFcnJvciA9PT0gbnVsbCB8fCBmZXRjaEVycm9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmZXRjaEVycm9yLmNhdXNlOwogICAgICBpZiAoY2F1c2UpIHsKICAgICAgICB2YXIgX2NhdXNlJG1lc3NhZ2UsIF9jYXVzZSRjb2RlLCBfZmV0Y2hFcnJvciRuYW1lLCBfY2F1c2UkbmFtZTsKICAgICAgICBjb25zdCBjYXVzZU1lc3NhZ2UgPSAoX2NhdXNlJG1lc3NhZ2UgPSBjYXVzZSA9PT0gbnVsbCB8fCBjYXVzZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2F1c2UubWVzc2FnZSkgIT09IG51bGwgJiYgX2NhdXNlJG1lc3NhZ2UgIT09IHZvaWQgMCA/IF9jYXVzZSRtZXNzYWdlIDogIiI7CiAgICAgICAgY29uc3QgY2F1c2VDb2RlID0gKF9jYXVzZSRjb2RlID0gY2F1c2UgPT09IG51bGwgfHwgY2F1c2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNhdXNlLmNvZGUpICE9PSBudWxsICYmIF9jYXVzZSRjb2RlICE9PSB2b2lkIDAgPyBfY2F1c2UkY29kZSA6ICIiOwogICAgICAgIGVycm9yRGV0YWlscyA9IGAkeyhfZmV0Y2hFcnJvciRuYW1lID0gZmV0Y2hFcnJvciA9PT0gbnVsbCB8fCBmZXRjaEVycm9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmZXRjaEVycm9yLm5hbWUpICE9PSBudWxsICYmIF9mZXRjaEVycm9yJG5hbWUgIT09IHZvaWQgMCA/IF9mZXRjaEVycm9yJG5hbWUgOiAiRmV0Y2hFcnJvciJ9OiAke2ZldGNoRXJyb3IgPT09IG51bGwgfHwgZmV0Y2hFcnJvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmV0Y2hFcnJvci5tZXNzYWdlfWA7CiAgICAgICAgZXJyb3JEZXRhaWxzICs9IGAKCkNhdXNlZCBieTogJHsoX2NhdXNlJG5hbWUgPSBjYXVzZSA9PT0gbnVsbCB8fCBjYXVzZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2F1c2UubmFtZSkgIT09IG51bGwgJiYgX2NhdXNlJG5hbWUgIT09IHZvaWQgMCA/IF9jYXVzZSRuYW1lIDogIkVycm9yIn06ICR7Y2F1c2VNZXNzYWdlfWA7CiAgICAgICAgaWYgKGNhdXNlQ29kZSkgZXJyb3JEZXRhaWxzICs9IGAgKCR7Y2F1c2VDb2RlfSlgOwogICAgICAgIGlmIChjYXVzZSA9PT0gbnVsbCB8fCBjYXVzZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2F1c2Uuc3RhY2spIGVycm9yRGV0YWlscyArPSBgCiR7Y2F1c2Uuc3RhY2t9YDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgX2ZldGNoRXJyb3Ikc3RhY2s7CiAgICAgICAgZXJyb3JEZXRhaWxzID0gKF9mZXRjaEVycm9yJHN0YWNrID0gZmV0Y2hFcnJvciA9PT0gbnVsbCB8fCBmZXRjaEVycm9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmZXRjaEVycm9yLnN0YWNrKSAhPT0gbnVsbCAmJiBfZmV0Y2hFcnJvciRzdGFjayAhPT0gdm9pZCAwID8gX2ZldGNoRXJyb3Ikc3RhY2sgOiAiIjsKICAgICAgfQogICAgICBjb25zdCB1cmxMZW5ndGggPSB0aGlzLnVybC50b1N0cmluZygpLmxlbmd0aDsKICAgICAgaWYgKChmZXRjaEVycm9yID09PSBudWxsIHx8IGZldGNoRXJyb3IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGZldGNoRXJyb3IubmFtZSkgPT09ICJBYm9ydEVycm9yIiB8fCAoZmV0Y2hFcnJvciA9PT0gbnVsbCB8fCBmZXRjaEVycm9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmZXRjaEVycm9yLmNvZGUpID09PSAiQUJPUlRfRVJSIikgewogICAgICAgIGNvZGUgPSAiIjsKICAgICAgICBoaW50ID0gIlJlcXVlc3Qgd2FzIGFib3J0ZWQgKHRpbWVvdXQgb3IgbWFudWFsIGNhbmNlbGxhdGlvbikiOwogICAgICAgIGlmICh1cmxMZW5ndGggPiB0aGlzLnVybExlbmd0aExpbWl0KSBoaW50ICs9IGAuIE5vdGU6IFlvdXIgcmVxdWVzdCBVUkwgaXMgJHt1cmxMZW5ndGh9IGNoYXJhY3RlcnMsIHdoaWNoIG1heSBleGNlZWQgc2VydmVyIGxpbWl0cy4gSWYgc2VsZWN0aW5nIG1hbnkgZmllbGRzLCBjb25zaWRlciB1c2luZyB2aWV3cy4gSWYgZmlsdGVyaW5nIHdpdGggbGFyZ2UgYXJyYXlzIChlLmcuLCAuaW4oJ2lkJywgW21hbnkgSURzXSkpLCBjb25zaWRlciB1c2luZyBhbiBSUEMgZnVuY3Rpb24gdG8gcGFzcyB2YWx1ZXMgc2VydmVyLXNpZGUuYDsKICAgICAgfSBlbHNlIGlmICgoY2F1c2UgPT09IG51bGwgfHwgY2F1c2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNhdXNlLm5hbWUpID09PSAiSGVhZGVyc092ZXJmbG93RXJyb3IiIHx8IChjYXVzZSA9PT0gbnVsbCB8fCBjYXVzZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2F1c2UuY29kZSkgPT09ICJVTkRfRVJSX0hFQURFUlNfT1ZFUkZMT1ciKSB7CiAgICAgICAgY29kZSA9ICIiOwogICAgICAgIGhpbnQgPSAiSFRUUCBoZWFkZXJzIGV4Y2VlZGVkIHNlcnZlciBsaW1pdHMgKHR5cGljYWxseSAxNktCKSI7CiAgICAgICAgaWYgKHVybExlbmd0aCA+IHRoaXMudXJsTGVuZ3RoTGltaXQpIGhpbnQgKz0gYC4gWW91ciByZXF1ZXN0IFVSTCBpcyAke3VybExlbmd0aH0gY2hhcmFjdGVycy4gSWYgc2VsZWN0aW5nIG1hbnkgZmllbGRzLCBjb25zaWRlciB1c2luZyB2aWV3cy4gSWYgZmlsdGVyaW5nIHdpdGggbGFyZ2UgYXJyYXlzIChlLmcuLCAuaW4oJ2lkJywgWzIwMCsgSURzXSkpLCBjb25zaWRlciB1c2luZyBhbiBSUEMgZnVuY3Rpb24gaW5zdGVhZC5gOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgZXJyb3I6IHsKICAgICAgICAgIG1lc3NhZ2U6IGAkeyhfZmV0Y2hFcnJvciRuYW1lMiA9IGZldGNoRXJyb3IgPT09IG51bGwgfHwgZmV0Y2hFcnJvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmV0Y2hFcnJvci5uYW1lKSAhPT0gbnVsbCAmJiBfZmV0Y2hFcnJvciRuYW1lMiAhPT0gdm9pZCAwID8gX2ZldGNoRXJyb3IkbmFtZTIgOiAiRmV0Y2hFcnJvciJ9OiAke2ZldGNoRXJyb3IgPT09IG51bGwgfHwgZmV0Y2hFcnJvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmV0Y2hFcnJvci5tZXNzYWdlfWAsCiAgICAgICAgICBkZXRhaWxzOiBlcnJvckRldGFpbHMsCiAgICAgICAgICBoaW50LAogICAgICAgICAgY29kZQogICAgICAgIH0sCiAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICBjb3VudDogbnVsbCwKICAgICAgICBzdGF0dXM6IDAsCiAgICAgICAgc3RhdHVzVGV4dDogIiIKICAgICAgfTsKICAgIH0pOwogICAgcmV0dXJuIHJlcy50aGVuKG9uZnVsZmlsbGVkLCBvbnJlamVjdGVkKTsKICB9CiAgLyoqCiAgKiBPdmVycmlkZSB0aGUgdHlwZSBvZiB0aGUgcmV0dXJuZWQgYGRhdGFgLgogICoKICAqIEB0eXBlUGFyYW0gTmV3UmVzdWx0IC0gVGhlIG5ldyByZXN1bHQgdHlwZSB0byBvdmVycmlkZSB3aXRoCiAgKiBAZGVwcmVjYXRlZCBVc2Ugb3ZlcnJpZGVUeXBlczx5b3VyVHlwZSwgeyBtZXJnZTogZmFsc2UgfT4oKSBtZXRob2QgYXQgdGhlIGVuZCBvZiB5b3VyIGNhbGwgY2hhaW4gaW5zdGVhZAogICovCiAgcmV0dXJucygpIHsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE92ZXJyaWRlIHRoZSB0eXBlIG9mIHRoZSByZXR1cm5lZCBgZGF0YWAgZmllbGQgaW4gdGhlIHJlc3BvbnNlLgogICoKICAqIEB0eXBlUGFyYW0gTmV3UmVzdWx0IC0gVGhlIG5ldyB0eXBlIHRvIGNhc3QgdGhlIHJlc3BvbnNlIGRhdGEgdG8KICAqIEB0eXBlUGFyYW0gT3B0aW9ucyAtIE9wdGlvbmFsIHR5cGUgY29uZmlndXJhdGlvbiAoZGVmYXVsdHMgdG8geyBtZXJnZTogdHJ1ZSB9KQogICogQHR5cGVQYXJhbSBPcHRpb25zLm1lcmdlIC0gV2hlbiB0cnVlLCBtZXJnZXMgdGhlIG5ldyB0eXBlIHdpdGggZXhpc3RpbmcgcmV0dXJuIHR5cGUuIFdoZW4gZmFsc2UsIHJlcGxhY2VzIHRoZSBleGlzdGluZyB0eXBlcyBlbnRpcmVseSAoZGVmYXVsdHMgdG8gdHJ1ZSkKICAqIEBleGFtcGxlCiAgKiBgYGB0eXBlc2NyaXB0CiAgKiAvLyBNZXJnZSB3aXRoIGV4aXN0aW5nIHR5cGVzIChkZWZhdWx0IGJlaGF2aW9yKQogICogY29uc3QgcXVlcnkgPSBzdXBhYmFzZQogICogICAuZnJvbSgndXNlcnMnKQogICogICAuc2VsZWN0KCkKICAqICAgLm92ZXJyaWRlVHlwZXM8eyBjdXN0b21fZmllbGQ6IHN0cmluZyB9PigpCiAgKgogICogLy8gUmVwbGFjZSBleGlzdGluZyB0eXBlcyBjb21wbGV0ZWx5CiAgKiBjb25zdCByZXBsYWNlUXVlcnkgPSBzdXBhYmFzZQogICogICAuZnJvbSgndXNlcnMnKQogICogICAuc2VsZWN0KCkKICAqICAgLm92ZXJyaWRlVHlwZXM8eyBpZDogbnVtYmVyOyBuYW1lOiBzdHJpbmcgfSwgeyBtZXJnZTogZmFsc2UgfT4oKQogICogYGBgCiAgKiBAcmV0dXJucyBBIFBvc3RncmVzdEJ1aWxkZXIgaW5zdGFuY2Ugd2l0aCB0aGUgbmV3IHR5cGUKICAqLwogIG92ZXJyaWRlVHlwZXMoKSB7CiAgICByZXR1cm4gdGhpczsKICB9Cn07CnZhciBQb3N0Z3Jlc3RUcmFuc2Zvcm1CdWlsZGVyID0gY2xhc3MgZXh0ZW5kcyBQb3N0Z3Jlc3RCdWlsZGVyIHsKICAvKioKICAqIFBlcmZvcm0gYSBTRUxFQ1Qgb24gdGhlIHF1ZXJ5IHJlc3VsdC4KICAqCiAgKiBCeSBkZWZhdWx0LCBgLmluc2VydCgpYCwgYC51cGRhdGUoKWAsIGAudXBzZXJ0KClgLCBhbmQgYC5kZWxldGUoKWAgZG8gbm90CiAgKiByZXR1cm4gbW9kaWZpZWQgcm93cy4gQnkgY2FsbGluZyB0aGlzIG1ldGhvZCwgbW9kaWZpZWQgcm93cyBhcmUgcmV0dXJuZWQgaW4KICAqIGBkYXRhYC4KICAqCiAgKiBAcGFyYW0gY29sdW1ucyAtIFRoZSBjb2x1bW5zIHRvIHJldHJpZXZlLCBzZXBhcmF0ZWQgYnkgY29tbWFzCiAgKi8KICBzZWxlY3QoY29sdW1ucykgewogICAgbGV0IHF1b3RlZCA9IGZhbHNlOwogICAgY29uc3QgY2xlYW5lZENvbHVtbnMgPSAoY29sdW1ucyAhPT0gbnVsbCAmJiBjb2x1bW5zICE9PSB2b2lkIDAgPyBjb2x1bW5zIDogIioiKS5zcGxpdCgiIikubWFwKChjKSA9PiB7CiAgICAgIGlmICgvXHMvLnRlc3QoYykgJiYgIXF1b3RlZCkgcmV0dXJuICIiOwogICAgICBpZiAoYyA9PT0gJyInKSBxdW90ZWQgPSAhcXVvdGVkOwogICAgICByZXR1cm4gYzsKICAgIH0pLmpvaW4oIiIpOwogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLnNldCgic2VsZWN0IiwgY2xlYW5lZENvbHVtbnMpOwogICAgdGhpcy5oZWFkZXJzLmFwcGVuZCgiUHJlZmVyIiwgInJldHVybj1yZXByZXNlbnRhdGlvbiIpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogT3JkZXIgdGhlIHF1ZXJ5IHJlc3VsdCBieSBgY29sdW1uYC4KICAqCiAgKiBZb3UgY2FuIGNhbGwgdGhpcyBtZXRob2QgbXVsdGlwbGUgdGltZXMgdG8gb3JkZXIgYnkgbXVsdGlwbGUgY29sdW1ucy4KICAqCiAgKiBZb3UgY2FuIG9yZGVyIHJlZmVyZW5jZWQgdGFibGVzLCBidXQgaXQgb25seSBhZmZlY3RzIHRoZSBvcmRlcmluZyBvZiB0aGUKICAqIHBhcmVudCB0YWJsZSBpZiB5b3UgdXNlIGAhaW5uZXJgIGluIHRoZSBxdWVyeS4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBvcmRlciBieQogICogQHBhcmFtIG9wdGlvbnMgLSBOYW1lZCBwYXJhbWV0ZXJzCiAgKiBAcGFyYW0gb3B0aW9ucy5hc2NlbmRpbmcgLSBJZiBgdHJ1ZWAsIHRoZSByZXN1bHQgd2lsbCBiZSBpbiBhc2NlbmRpbmcgb3JkZXIKICAqIEBwYXJhbSBvcHRpb25zLm51bGxzRmlyc3QgLSBJZiBgdHJ1ZWAsIGBudWxsYHMgYXBwZWFyIGZpcnN0LiBJZiBgZmFsc2VgLAogICogYG51bGxgcyBhcHBlYXIgbGFzdC4KICAqIEBwYXJhbSBvcHRpb25zLnJlZmVyZW5jZWRUYWJsZSAtIFNldCB0aGlzIHRvIG9yZGVyIGEgcmVmZXJlbmNlZCB0YWJsZSBieQogICogaXRzIGNvbHVtbnMKICAqIEBwYXJhbSBvcHRpb25zLmZvcmVpZ25UYWJsZSAtIERlcHJlY2F0ZWQsIHVzZSBgb3B0aW9ucy5yZWZlcmVuY2VkVGFibGVgCiAgKiBpbnN0ZWFkCiAgKi8KICBvcmRlcihjb2x1bW4sIHsgYXNjZW5kaW5nOiBhc2NlbmRpbmcyID0gdHJ1ZSwgbnVsbHNGaXJzdCwgZm9yZWlnblRhYmxlLCByZWZlcmVuY2VkVGFibGUgPSBmb3JlaWduVGFibGUgfSA9IHt9KSB7CiAgICBjb25zdCBrZXkgPSByZWZlcmVuY2VkVGFibGUgPyBgJHtyZWZlcmVuY2VkVGFibGV9Lm9yZGVyYCA6ICJvcmRlciI7CiAgICBjb25zdCBleGlzdGluZ09yZGVyID0gdGhpcy51cmwuc2VhcmNoUGFyYW1zLmdldChrZXkpOwogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLnNldChrZXksIGAke2V4aXN0aW5nT3JkZXIgPyBgJHtleGlzdGluZ09yZGVyfSxgIDogIiJ9JHtjb2x1bW59LiR7YXNjZW5kaW5nMiA/ICJhc2MiIDogImRlc2MifSR7bnVsbHNGaXJzdCA9PT0gdm9pZCAwID8gIiIgOiBudWxsc0ZpcnN0ID8gIi5udWxsc2ZpcnN0IiA6ICIubnVsbHNsYXN0In1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIExpbWl0IHRoZSBxdWVyeSByZXN1bHQgYnkgYGNvdW50YC4KICAqCiAgKiBAcGFyYW0gY291bnQgLSBUaGUgbWF4aW11bSBudW1iZXIgb2Ygcm93cyB0byByZXR1cm4KICAqIEBwYXJhbSBvcHRpb25zIC0gTmFtZWQgcGFyYW1ldGVycwogICogQHBhcmFtIG9wdGlvbnMucmVmZXJlbmNlZFRhYmxlIC0gU2V0IHRoaXMgdG8gbGltaXQgcm93cyBvZiByZWZlcmVuY2VkCiAgKiB0YWJsZXMgaW5zdGVhZCBvZiB0aGUgcGFyZW50IHRhYmxlCiAgKiBAcGFyYW0gb3B0aW9ucy5mb3JlaWduVGFibGUgLSBEZXByZWNhdGVkLCB1c2UgYG9wdGlvbnMucmVmZXJlbmNlZFRhYmxlYAogICogaW5zdGVhZAogICovCiAgbGltaXQoY291bnQsIHsgZm9yZWlnblRhYmxlLCByZWZlcmVuY2VkVGFibGUgPSBmb3JlaWduVGFibGUgfSA9IHt9KSB7CiAgICBjb25zdCBrZXkgPSB0eXBlb2YgcmVmZXJlbmNlZFRhYmxlID09PSAidW5kZWZpbmVkIiA/ICJsaW1pdCIgOiBgJHtyZWZlcmVuY2VkVGFibGV9LmxpbWl0YDsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5zZXQoa2V5LCBgJHtjb3VudH1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIExpbWl0IHRoZSBxdWVyeSByZXN1bHQgYnkgc3RhcnRpbmcgYXQgYW4gb2Zmc2V0IGBmcm9tYCBhbmQgZW5kaW5nIGF0IHRoZSBvZmZzZXQgYHRvYC4KICAqIE9ubHkgcmVjb3JkcyB3aXRoaW4gdGhpcyByYW5nZSBhcmUgcmV0dXJuZWQuCiAgKiBUaGlzIHJlc3BlY3RzIHRoZSBxdWVyeSBvcmRlciBhbmQgaWYgdGhlcmUgaXMgbm8gb3JkZXIgY2xhdXNlIHRoZSByYW5nZSBjb3VsZCBiZWhhdmUgdW5leHBlY3RlZGx5LgogICogVGhlIGBmcm9tYCBhbmQgYHRvYCB2YWx1ZXMgYXJlIDAtYmFzZWQgYW5kIGluY2x1c2l2ZTogYHJhbmdlKDEsIDMpYCB3aWxsIGluY2x1ZGUgdGhlIHNlY29uZCwgdGhpcmQKICAqIGFuZCBmb3VydGggcm93cyBvZiB0aGUgcXVlcnkuCiAgKgogICogQHBhcmFtIGZyb20gLSBUaGUgc3RhcnRpbmcgaW5kZXggZnJvbSB3aGljaCB0byBsaW1pdCB0aGUgcmVzdWx0CiAgKiBAcGFyYW0gdG8gLSBUaGUgbGFzdCBpbmRleCB0byB3aGljaCB0byBsaW1pdCB0aGUgcmVzdWx0CiAgKiBAcGFyYW0gb3B0aW9ucyAtIE5hbWVkIHBhcmFtZXRlcnMKICAqIEBwYXJhbSBvcHRpb25zLnJlZmVyZW5jZWRUYWJsZSAtIFNldCB0aGlzIHRvIGxpbWl0IHJvd3Mgb2YgcmVmZXJlbmNlZAogICogdGFibGVzIGluc3RlYWQgb2YgdGhlIHBhcmVudCB0YWJsZQogICogQHBhcmFtIG9wdGlvbnMuZm9yZWlnblRhYmxlIC0gRGVwcmVjYXRlZCwgdXNlIGBvcHRpb25zLnJlZmVyZW5jZWRUYWJsZWAKICAqIGluc3RlYWQKICAqLwogIHJhbmdlKGZyb20yLCB0bzIsIHsgZm9yZWlnblRhYmxlLCByZWZlcmVuY2VkVGFibGUgPSBmb3JlaWduVGFibGUgfSA9IHt9KSB7CiAgICBjb25zdCBrZXlPZmZzZXQgPSB0eXBlb2YgcmVmZXJlbmNlZFRhYmxlID09PSAidW5kZWZpbmVkIiA/ICJvZmZzZXQiIDogYCR7cmVmZXJlbmNlZFRhYmxlfS5vZmZzZXRgOwogICAgY29uc3Qga2V5TGltaXQgPSB0eXBlb2YgcmVmZXJlbmNlZFRhYmxlID09PSAidW5kZWZpbmVkIiA/ICJsaW1pdCIgOiBgJHtyZWZlcmVuY2VkVGFibGV9LmxpbWl0YDsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5zZXQoa2V5T2Zmc2V0LCBgJHtmcm9tMn1gKTsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5zZXQoa2V5TGltaXQsIGAke3RvMiAtIGZyb20yICsgMX1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIFNldCB0aGUgQWJvcnRTaWduYWwgZm9yIHRoZSBmZXRjaCByZXF1ZXN0LgogICoKICAqIEBwYXJhbSBzaWduYWwgLSBUaGUgQWJvcnRTaWduYWwgdG8gdXNlIGZvciB0aGUgZmV0Y2ggcmVxdWVzdAogICovCiAgYWJvcnRTaWduYWwoc2lnbmFsKSB7CiAgICB0aGlzLnNpZ25hbCA9IHNpZ25hbDsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIFJldHVybiBgZGF0YWAgYXMgYSBzaW5nbGUgb2JqZWN0IGluc3RlYWQgb2YgYW4gYXJyYXkgb2Ygb2JqZWN0cy4KICAqCiAgKiBRdWVyeSByZXN1bHQgbXVzdCBiZSBvbmUgcm93IChlLmcuIHVzaW5nIGAubGltaXQoMSlgKSwgb3RoZXJ3aXNlIHRoaXMKICAqIHJldHVybnMgYW4gZXJyb3IuCiAgKi8KICBzaW5nbGUoKSB7CiAgICB0aGlzLmhlYWRlcnMuc2V0KCJBY2NlcHQiLCAiYXBwbGljYXRpb24vdm5kLnBncnN0Lm9iamVjdCtqc29uIik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBSZXR1cm4gYGRhdGFgIGFzIGEgc2luZ2xlIG9iamVjdCBpbnN0ZWFkIG9mIGFuIGFycmF5IG9mIG9iamVjdHMuCiAgKgogICogUXVlcnkgcmVzdWx0IG11c3QgYmUgemVybyBvciBvbmUgcm93IChlLmcuIHVzaW5nIGAubGltaXQoMSlgKSwgb3RoZXJ3aXNlCiAgKiB0aGlzIHJldHVybnMgYW4gZXJyb3IuCiAgKi8KICBtYXliZVNpbmdsZSgpIHsKICAgIGlmICh0aGlzLm1ldGhvZCA9PT0gIkdFVCIpIHRoaXMuaGVhZGVycy5zZXQoIkFjY2VwdCIsICJhcHBsaWNhdGlvbi9qc29uIik7CiAgICBlbHNlIHRoaXMuaGVhZGVycy5zZXQoIkFjY2VwdCIsICJhcHBsaWNhdGlvbi92bmQucGdyc3Qub2JqZWN0K2pzb24iKTsKICAgIHRoaXMuaXNNYXliZVNpbmdsZSA9IHRydWU7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBSZXR1cm4gYGRhdGFgIGFzIGEgc3RyaW5nIGluIENTViBmb3JtYXQuCiAgKi8KICBjc3YoKSB7CiAgICB0aGlzLmhlYWRlcnMuc2V0KCJBY2NlcHQiLCAidGV4dC9jc3YiKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIFJldHVybiBgZGF0YWAgYXMgYW4gb2JqZWN0IGluIFtHZW9KU09OXShodHRwczovL2dlb2pzb24ub3JnKSBmb3JtYXQuCiAgKi8KICBnZW9qc29uKCkgewogICAgdGhpcy5oZWFkZXJzLnNldCgiQWNjZXB0IiwgImFwcGxpY2F0aW9uL2dlbytqc29uIik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBSZXR1cm4gYGRhdGFgIGFzIHRoZSBFWFBMQUlOIHBsYW4gZm9yIHRoZSBxdWVyeS4KICAqCiAgKiBZb3UgbmVlZCB0byBlbmFibGUgdGhlCiAgKiBbZGJfcGxhbl9lbmFibGVkXShodHRwczovL3N1cGFiYXNlLmNvbS9kb2NzL2d1aWRlcy9kYXRhYmFzZS9kZWJ1Z2dpbmctcGVyZm9ybWFuY2UjZW5hYmxpbmctZXhwbGFpbikKICAqIHNldHRpbmcgYmVmb3JlIHVzaW5nIHRoaXMgbWV0aG9kLgogICoKICAqIEBwYXJhbSBvcHRpb25zIC0gTmFtZWQgcGFyYW1ldGVycwogICoKICAqIEBwYXJhbSBvcHRpb25zLmFuYWx5emUgLSBJZiBgdHJ1ZWAsIHRoZSBxdWVyeSB3aWxsIGJlIGV4ZWN1dGVkIGFuZCB0aGUKICAqIGFjdHVhbCBydW4gdGltZSB3aWxsIGJlIHJldHVybmVkCiAgKgogICogQHBhcmFtIG9wdGlvbnMudmVyYm9zZSAtIElmIGB0cnVlYCwgdGhlIHF1ZXJ5IGlkZW50aWZpZXIgd2lsbCBiZSByZXR1cm5lZAogICogYW5kIGBkYXRhYCB3aWxsIGluY2x1ZGUgdGhlIG91dHB1dCBjb2x1bW5zIG9mIHRoZSBxdWVyeQogICoKICAqIEBwYXJhbSBvcHRpb25zLnNldHRpbmdzIC0gSWYgYHRydWVgLCBpbmNsdWRlIGluZm9ybWF0aW9uIG9uIGNvbmZpZ3VyYXRpb24KICAqIHBhcmFtZXRlcnMgdGhhdCBhZmZlY3QgcXVlcnkgcGxhbm5pbmcKICAqCiAgKiBAcGFyYW0gb3B0aW9ucy5idWZmZXJzIC0gSWYgYHRydWVgLCBpbmNsdWRlIGluZm9ybWF0aW9uIG9uIGJ1ZmZlciB1c2FnZQogICoKICAqIEBwYXJhbSBvcHRpb25zLndhbCAtIElmIGB0cnVlYCwgaW5jbHVkZSBpbmZvcm1hdGlvbiBvbiBXQUwgcmVjb3JkIGdlbmVyYXRpb24KICAqCiAgKiBAcGFyYW0gb3B0aW9ucy5mb3JtYXQgLSBUaGUgZm9ybWF0IG9mIHRoZSBvdXRwdXQsIGNhbiBiZSBgInRleHQiYCAoZGVmYXVsdCkKICAqIG9yIGAianNvbiJgCiAgKi8KICBleHBsYWluKHsgYW5hbHl6ZSA9IGZhbHNlLCB2ZXJib3NlID0gZmFsc2UsIHNldHRpbmdzID0gZmFsc2UsIGJ1ZmZlcnMgPSBmYWxzZSwgd2FsID0gZmFsc2UsIGZvcm1hdDogZm9ybWF0MiA9ICJ0ZXh0IiB9ID0ge30pIHsKICAgIHZhciBfdGhpcyRoZWFkZXJzJGdldDsKICAgIGNvbnN0IG9wdGlvbnMgPSBbCiAgICAgIGFuYWx5emUgPyAiYW5hbHl6ZSIgOiBudWxsLAogICAgICB2ZXJib3NlID8gInZlcmJvc2UiIDogbnVsbCwKICAgICAgc2V0dGluZ3MgPyAic2V0dGluZ3MiIDogbnVsbCwKICAgICAgYnVmZmVycyA/ICJidWZmZXJzIiA6IG51bGwsCiAgICAgIHdhbCA/ICJ3YWwiIDogbnVsbAogICAgXS5maWx0ZXIoQm9vbGVhbikuam9pbigifCIpOwogICAgY29uc3QgZm9yTWVkaWF0eXBlID0gKF90aGlzJGhlYWRlcnMkZ2V0ID0gdGhpcy5oZWFkZXJzLmdldCgiQWNjZXB0IikpICE9PSBudWxsICYmIF90aGlzJGhlYWRlcnMkZ2V0ICE9PSB2b2lkIDAgPyBfdGhpcyRoZWFkZXJzJGdldCA6ICJhcHBsaWNhdGlvbi9qc29uIjsKICAgIHRoaXMuaGVhZGVycy5zZXQoIkFjY2VwdCIsIGBhcHBsaWNhdGlvbi92bmQucGdyc3QucGxhbiske2Zvcm1hdDJ9OyBmb3I9IiR7Zm9yTWVkaWF0eXBlfSI7IG9wdGlvbnM9JHtvcHRpb25zfTtgKTsKICAgIGlmIChmb3JtYXQyID09PSAianNvbiIpIHJldHVybiB0aGlzOwogICAgZWxzZSByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBSb2xsYmFjayB0aGUgcXVlcnkuCiAgKgogICogYGRhdGFgIHdpbGwgc3RpbGwgYmUgcmV0dXJuZWQsIGJ1dCB0aGUgcXVlcnkgaXMgbm90IGNvbW1pdHRlZC4KICAqLwogIHJvbGxiYWNrKCkgewogICAgdGhpcy5oZWFkZXJzLmFwcGVuZCgiUHJlZmVyIiwgInR4PXJvbGxiYWNrIik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBPdmVycmlkZSB0aGUgdHlwZSBvZiB0aGUgcmV0dXJuZWQgYGRhdGFgLgogICoKICAqIEB0eXBlUGFyYW0gTmV3UmVzdWx0IC0gVGhlIG5ldyByZXN1bHQgdHlwZSB0byBvdmVycmlkZSB3aXRoCiAgKiBAZGVwcmVjYXRlZCBVc2Ugb3ZlcnJpZGVUeXBlczx5b3VyVHlwZSwgeyBtZXJnZTogZmFsc2UgfT4oKSBtZXRob2QgYXQgdGhlIGVuZCBvZiB5b3VyIGNhbGwgY2hhaW4gaW5zdGVhZAogICovCiAgcmV0dXJucygpIHsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIFNldCB0aGUgbWF4aW11bSBudW1iZXIgb2Ygcm93cyB0aGF0IGNhbiBiZSBhZmZlY3RlZCBieSB0aGUgcXVlcnkuCiAgKiBPbmx5IGF2YWlsYWJsZSBpbiBQb3N0Z1JFU1QgdjEzKyBhbmQgb25seSB3b3JrcyB3aXRoIFBBVENIIGFuZCBERUxFVEUgbWV0aG9kcy4KICAqCiAgKiBAcGFyYW0gdmFsdWUgLSBUaGUgbWF4aW11bSBudW1iZXIgb2Ygcm93cyB0aGF0IGNhbiBiZSBhZmZlY3RlZAogICovCiAgbWF4QWZmZWN0ZWQodmFsdWUpIHsKICAgIHRoaXMuaGVhZGVycy5hcHBlbmQoIlByZWZlciIsICJoYW5kbGluZz1zdHJpY3QiKTsKICAgIHRoaXMuaGVhZGVycy5hcHBlbmQoIlByZWZlciIsIGBtYXgtYWZmZWN0ZWQ9JHt2YWx1ZX1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KfTsKdmFyIFBvc3RncmVzdFJlc2VydmVkQ2hhcnNSZWdleHAgPSAvKiBAX19QVVJFX18gKi8gbmV3IFJlZ0V4cCgiWywoKV0iKTsKdmFyIFBvc3RncmVzdEZpbHRlckJ1aWxkZXIgPSBjbGFzcyBleHRlbmRzIFBvc3RncmVzdFRyYW5zZm9ybUJ1aWxkZXIgewogIC8qKgogICogTWF0Y2ggb25seSByb3dzIHdoZXJlIGBjb2x1bW5gIGlzIGVxdWFsIHRvIGB2YWx1ZWAuCiAgKgogICogVG8gY2hlY2sgaWYgdGhlIHZhbHVlIG9mIGBjb2x1bW5gIGlzIE5VTEwsIHlvdSBzaG91bGQgdXNlIGAuaXMoKWAgaW5zdGVhZC4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBmaWx0ZXIgd2l0aAogICovCiAgZXEoY29sdW1uLCB2YWx1ZSkgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBlcS4ke3ZhbHVlfWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogTWF0Y2ggb25seSByb3dzIHdoZXJlIGBjb2x1bW5gIGlzIG5vdCBlcXVhbCB0byBgdmFsdWVgLgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHZhbHVlIC0gVGhlIHZhbHVlIHRvIGZpbHRlciB3aXRoCiAgKi8KICBuZXEoY29sdW1uLCB2YWx1ZSkgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBuZXEuJHt2YWx1ZX1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBgY29sdW1uYCBpcyBncmVhdGVyIHRoYW4gYHZhbHVlYC4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBmaWx0ZXIgd2l0aAogICovCiAgZ3QoY29sdW1uLCB2YWx1ZSkgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBndC4ke3ZhbHVlfWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogTWF0Y2ggb25seSByb3dzIHdoZXJlIGBjb2x1bW5gIGlzIGdyZWF0ZXIgdGhhbiBvciBlcXVhbCB0byBgdmFsdWVgLgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHZhbHVlIC0gVGhlIHZhbHVlIHRvIGZpbHRlciB3aXRoCiAgKi8KICBndGUoY29sdW1uLCB2YWx1ZSkgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBndGUuJHt2YWx1ZX1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBgY29sdW1uYCBpcyBsZXNzIHRoYW4gYHZhbHVlYC4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBmaWx0ZXIgd2l0aAogICovCiAgbHQoY29sdW1uLCB2YWx1ZSkgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBsdC4ke3ZhbHVlfWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogTWF0Y2ggb25seSByb3dzIHdoZXJlIGBjb2x1bW5gIGlzIGxlc3MgdGhhbiBvciBlcXVhbCB0byBgdmFsdWVgLgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHZhbHVlIC0gVGhlIHZhbHVlIHRvIGZpbHRlciB3aXRoCiAgKi8KICBsdGUoY29sdW1uLCB2YWx1ZSkgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBsdGUuJHt2YWx1ZX1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBgY29sdW1uYCBtYXRjaGVzIGBwYXR0ZXJuYCBjYXNlLXNlbnNpdGl2ZWx5LgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHBhdHRlcm4gLSBUaGUgcGF0dGVybiB0byBtYXRjaCB3aXRoCiAgKi8KICBsaWtlKGNvbHVtbiwgcGF0dGVybikgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBsaWtlLiR7cGF0dGVybn1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBgY29sdW1uYCBtYXRjaGVzIGFsbCBvZiBgcGF0dGVybnNgIGNhc2Utc2Vuc2l0aXZlbHkuCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gcGF0dGVybnMgLSBUaGUgcGF0dGVybnMgdG8gbWF0Y2ggd2l0aAogICovCiAgbGlrZUFsbE9mKGNvbHVtbiwgcGF0dGVybnMpIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgbGlrZShhbGwpLnske3BhdHRlcm5zLmpvaW4oIiwiKX19YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUgYGNvbHVtbmAgbWF0Y2hlcyBhbnkgb2YgYHBhdHRlcm5zYCBjYXNlLXNlbnNpdGl2ZWx5LgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHBhdHRlcm5zIC0gVGhlIHBhdHRlcm5zIHRvIG1hdGNoIHdpdGgKICAqLwogIGxpa2VBbnlPZihjb2x1bW4sIHBhdHRlcm5zKSB7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYGxpa2UoYW55KS57JHtwYXR0ZXJucy5qb2luKCIsIil9fWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogTWF0Y2ggb25seSByb3dzIHdoZXJlIGBjb2x1bW5gIG1hdGNoZXMgYHBhdHRlcm5gIGNhc2UtaW5zZW5zaXRpdmVseS4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSBwYXR0ZXJuIC0gVGhlIHBhdHRlcm4gdG8gbWF0Y2ggd2l0aAogICovCiAgaWxpa2UoY29sdW1uLCBwYXR0ZXJuKSB7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYGlsaWtlLiR7cGF0dGVybn1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBgY29sdW1uYCBtYXRjaGVzIGFsbCBvZiBgcGF0dGVybnNgIGNhc2UtaW5zZW5zaXRpdmVseS4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSBwYXR0ZXJucyAtIFRoZSBwYXR0ZXJucyB0byBtYXRjaCB3aXRoCiAgKi8KICBpbGlrZUFsbE9mKGNvbHVtbiwgcGF0dGVybnMpIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgaWxpa2UoYWxsKS57JHtwYXR0ZXJucy5qb2luKCIsIil9fWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogTWF0Y2ggb25seSByb3dzIHdoZXJlIGBjb2x1bW5gIG1hdGNoZXMgYW55IG9mIGBwYXR0ZXJuc2AgY2FzZS1pbnNlbnNpdGl2ZWx5LgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHBhdHRlcm5zIC0gVGhlIHBhdHRlcm5zIHRvIG1hdGNoIHdpdGgKICAqLwogIGlsaWtlQW55T2YoY29sdW1uLCBwYXR0ZXJucykgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBpbGlrZShhbnkpLnske3BhdHRlcm5zLmpvaW4oIiwiKX19YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUgYGNvbHVtbmAgbWF0Y2hlcyB0aGUgUG9zdGdyZVNRTCByZWdleCBgcGF0dGVybmAKICAqIGNhc2Utc2Vuc2l0aXZlbHkgKHVzaW5nIHRoZSBgfmAgb3BlcmF0b3IpLgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHBhdHRlcm4gLSBUaGUgUG9zdGdyZVNRTCByZWd1bGFyIGV4cHJlc3Npb24gcGF0dGVybiB0byBtYXRjaCB3aXRoCiAgKi8KICByZWdleE1hdGNoKGNvbHVtbiwgcGF0dGVybikgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBtYXRjaC4ke3BhdHRlcm59YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUgYGNvbHVtbmAgbWF0Y2hlcyB0aGUgUG9zdGdyZVNRTCByZWdleCBgcGF0dGVybmAKICAqIGNhc2UtaW5zZW5zaXRpdmVseSAodXNpbmcgdGhlIGB+KmAgb3BlcmF0b3IpLgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHBhdHRlcm4gLSBUaGUgUG9zdGdyZVNRTCByZWd1bGFyIGV4cHJlc3Npb24gcGF0dGVybiB0byBtYXRjaCB3aXRoCiAgKi8KICByZWdleElNYXRjaChjb2x1bW4sIHBhdHRlcm4pIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgaW1hdGNoLiR7cGF0dGVybn1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBgY29sdW1uYCBJUyBgdmFsdWVgLgogICoKICAqIEZvciBub24tYm9vbGVhbiBjb2x1bW5zLCB0aGlzIGlzIG9ubHkgcmVsZXZhbnQgZm9yIGNoZWNraW5nIGlmIHRoZSB2YWx1ZSBvZgogICogYGNvbHVtbmAgaXMgTlVMTCBieSBzZXR0aW5nIGB2YWx1ZWAgdG8gYG51bGxgLgogICoKICAqIEZvciBib29sZWFuIGNvbHVtbnMsIHlvdSBjYW4gYWxzbyBzZXQgYHZhbHVlYCB0byBgdHJ1ZWAgb3IgYGZhbHNlYCBhbmQgaXQKICAqIHdpbGwgYmVoYXZlIHRoZSBzYW1lIHdheSBhcyBgLmVxKClgLgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHZhbHVlIC0gVGhlIHZhbHVlIHRvIGZpbHRlciB3aXRoCiAgKi8KICBpcyhjb2x1bW4sIHZhbHVlKSB7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYGlzLiR7dmFsdWV9YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUgYGNvbHVtbmAgSVMgRElTVElOQ1QgRlJPTSBgdmFsdWVgLgogICoKICAqIFVubGlrZSBgLm5lcSgpYCwgdGhpcyB0cmVhdHMgYE5VTExgIGFzIGEgY29tcGFyYWJsZSB2YWx1ZS4gVHdvIGBOVUxMYCB2YWx1ZXMKICAqIGFyZSBjb25zaWRlcmVkIGVxdWFsIChub3QgZGlzdGluY3QpLCBhbmQgY29tcGFyaW5nIGBOVUxMYCB3aXRoIGFueSBub24tTlVMTAogICogdmFsdWUgcmV0dXJucyB0cnVlIChkaXN0aW5jdCkuCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gZmlsdGVyIHdpdGgKICAqLwogIGlzRGlzdGluY3QoY29sdW1uLCB2YWx1ZSkgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBpc2Rpc3RpbmN0LiR7dmFsdWV9YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUgYGNvbHVtbmAgaXMgaW5jbHVkZWQgaW4gdGhlIGB2YWx1ZXNgIGFycmF5LgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHZhbHVlcyAtIFRoZSB2YWx1ZXMgYXJyYXkgdG8gZmlsdGVyIHdpdGgKICAqLwogIGluKGNvbHVtbiwgdmFsdWVzKSB7CiAgICBjb25zdCBjbGVhbmVkVmFsdWVzID0gQXJyYXkuZnJvbShuZXcgU2V0KHZhbHVlcykpLm1hcCgocykgPT4gewogICAgICBpZiAodHlwZW9mIHMgPT09ICJzdHJpbmciICYmIFBvc3RncmVzdFJlc2VydmVkQ2hhcnNSZWdleHAudGVzdChzKSkgcmV0dXJuIGAiJHtzfSJgOwogICAgICBlbHNlIHJldHVybiBgJHtzfWA7CiAgICB9KS5qb2luKCIsIik7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYGluLigke2NsZWFuZWRWYWx1ZXN9KWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogTWF0Y2ggb25seSByb3dzIHdoZXJlIGBjb2x1bW5gIGlzIE5PVCBpbmNsdWRlZCBpbiB0aGUgYHZhbHVlc2AgYXJyYXkuCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gdmFsdWVzIC0gVGhlIHZhbHVlcyBhcnJheSB0byBmaWx0ZXIgd2l0aAogICovCiAgbm90SW4oY29sdW1uLCB2YWx1ZXMpIHsKICAgIGNvbnN0IGNsZWFuZWRWYWx1ZXMgPSBBcnJheS5mcm9tKG5ldyBTZXQodmFsdWVzKSkubWFwKChzKSA9PiB7CiAgICAgIGlmICh0eXBlb2YgcyA9PT0gInN0cmluZyIgJiYgUG9zdGdyZXN0UmVzZXJ2ZWRDaGFyc1JlZ2V4cC50ZXN0KHMpKSByZXR1cm4gYCIke3N9ImA7CiAgICAgIGVsc2UgcmV0dXJuIGAke3N9YDsKICAgIH0pLmpvaW4oIiwiKTsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgbm90LmluLigke2NsZWFuZWRWYWx1ZXN9KWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogT25seSByZWxldmFudCBmb3IganNvbmIsIGFycmF5LCBhbmQgcmFuZ2UgY29sdW1ucy4gTWF0Y2ggb25seSByb3dzIHdoZXJlCiAgKiBgY29sdW1uYCBjb250YWlucyBldmVyeSBlbGVtZW50IGFwcGVhcmluZyBpbiBgdmFsdWVgLgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUganNvbmIsIGFycmF5LCBvciByYW5nZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gdmFsdWUgLSBUaGUganNvbmIsIGFycmF5LCBvciByYW5nZSB2YWx1ZSB0byBmaWx0ZXIgd2l0aAogICovCiAgY29udGFpbnMoY29sdW1uLCB2YWx1ZSkgewogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgY3MuJHt2YWx1ZX1gKTsKICAgIGVsc2UgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYGNzLnske3ZhbHVlLmpvaW4oIiwiKX19YCk7CiAgICBlbHNlIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgY3MuJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSl9YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBPbmx5IHJlbGV2YW50IGZvciBqc29uYiwgYXJyYXksIGFuZCByYW5nZSBjb2x1bW5zLiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUKICAqIGV2ZXJ5IGVsZW1lbnQgYXBwZWFyaW5nIGluIGBjb2x1bW5gIGlzIGNvbnRhaW5lZCBieSBgdmFsdWVgLgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUganNvbmIsIGFycmF5LCBvciByYW5nZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gdmFsdWUgLSBUaGUganNvbmIsIGFycmF5LCBvciByYW5nZSB2YWx1ZSB0byBmaWx0ZXIgd2l0aAogICovCiAgY29udGFpbmVkQnkoY29sdW1uLCB2YWx1ZSkgewogICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgY2QuJHt2YWx1ZX1gKTsKICAgIGVsc2UgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYGNkLnske3ZhbHVlLmpvaW4oIiwiKX19YCk7CiAgICBlbHNlIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgY2QuJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSl9YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBPbmx5IHJlbGV2YW50IGZvciByYW5nZSBjb2x1bW5zLiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUgZXZlcnkgZWxlbWVudCBpbgogICogYGNvbHVtbmAgaXMgZ3JlYXRlciB0aGFuIGFueSBlbGVtZW50IGluIGByYW5nZWAuCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSByYW5nZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gcmFuZ2UgLSBUaGUgcmFuZ2UgdG8gZmlsdGVyIHdpdGgKICAqLwogIHJhbmdlR3QoY29sdW1uLCByYW5nZTQpIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgc3IuJHtyYW5nZTR9YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBPbmx5IHJlbGV2YW50IGZvciByYW5nZSBjb2x1bW5zLiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUgZXZlcnkgZWxlbWVudCBpbgogICogYGNvbHVtbmAgaXMgZWl0aGVyIGNvbnRhaW5lZCBpbiBgcmFuZ2VgIG9yIGdyZWF0ZXIgdGhhbiBhbnkgZWxlbWVudCBpbgogICogYHJhbmdlYC4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIHJhbmdlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSByYW5nZSAtIFRoZSByYW5nZSB0byBmaWx0ZXIgd2l0aAogICovCiAgcmFuZ2VHdGUoY29sdW1uLCByYW5nZTQpIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgbnhsLiR7cmFuZ2U0fWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogT25seSByZWxldmFudCBmb3IgcmFuZ2UgY29sdW1ucy4gTWF0Y2ggb25seSByb3dzIHdoZXJlIGV2ZXJ5IGVsZW1lbnQgaW4KICAqIGBjb2x1bW5gIGlzIGxlc3MgdGhhbiBhbnkgZWxlbWVudCBpbiBgcmFuZ2VgLgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgcmFuZ2UgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHJhbmdlIC0gVGhlIHJhbmdlIHRvIGZpbHRlciB3aXRoCiAgKi8KICByYW5nZUx0KGNvbHVtbiwgcmFuZ2U0KSB7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYHNsLiR7cmFuZ2U0fWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogT25seSByZWxldmFudCBmb3IgcmFuZ2UgY29sdW1ucy4gTWF0Y2ggb25seSByb3dzIHdoZXJlIGV2ZXJ5IGVsZW1lbnQgaW4KICAqIGBjb2x1bW5gIGlzIGVpdGhlciBjb250YWluZWQgaW4gYHJhbmdlYCBvciBsZXNzIHRoYW4gYW55IGVsZW1lbnQgaW4KICAqIGByYW5nZWAuCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSByYW5nZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gcmFuZ2UgLSBUaGUgcmFuZ2UgdG8gZmlsdGVyIHdpdGgKICAqLwogIHJhbmdlTHRlKGNvbHVtbiwgcmFuZ2U0KSB7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYG54ci4ke3JhbmdlNH1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE9ubHkgcmVsZXZhbnQgZm9yIHJhbmdlIGNvbHVtbnMuIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBgY29sdW1uYCBpcwogICogbXV0dWFsbHkgZXhjbHVzaXZlIHRvIGByYW5nZWAgYW5kIHRoZXJlIGNhbiBiZSBubyBlbGVtZW50IGJldHdlZW4gdGhlIHR3bwogICogcmFuZ2VzLgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgcmFuZ2UgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHJhbmdlIC0gVGhlIHJhbmdlIHRvIGZpbHRlciB3aXRoCiAgKi8KICByYW5nZUFkamFjZW50KGNvbHVtbiwgcmFuZ2U0KSB7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYGFkai4ke3JhbmdlNH1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE9ubHkgcmVsZXZhbnQgZm9yIGFycmF5IGFuZCByYW5nZSBjb2x1bW5zLiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUKICAqIGBjb2x1bW5gIGFuZCBgdmFsdWVgIGhhdmUgYW4gZWxlbWVudCBpbiBjb21tb24uCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSBhcnJheSBvciByYW5nZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gdmFsdWUgLSBUaGUgYXJyYXkgb3IgcmFuZ2UgdmFsdWUgdG8gZmlsdGVyIHdpdGgKICAqLwogIG92ZXJsYXBzKGNvbHVtbiwgdmFsdWUpIHsKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYG92LiR7dmFsdWV9YCk7CiAgICBlbHNlIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgb3YueyR7dmFsdWUuam9pbigiLCIpfX1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE9ubHkgcmVsZXZhbnQgZm9yIHRleHQgYW5kIHRzdmVjdG9yIGNvbHVtbnMuIE1hdGNoIG9ubHkgcm93cyB3aGVyZQogICogYGNvbHVtbmAgbWF0Y2hlcyB0aGUgcXVlcnkgc3RyaW5nIGluIGBxdWVyeWAuCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSB0ZXh0IG9yIHRzdmVjdG9yIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSBxdWVyeSAtIFRoZSBxdWVyeSB0ZXh0IHRvIG1hdGNoIHdpdGgKICAqIEBwYXJhbSBvcHRpb25zIC0gTmFtZWQgcGFyYW1ldGVycwogICogQHBhcmFtIG9wdGlvbnMuY29uZmlnIC0gVGhlIHRleHQgc2VhcmNoIGNvbmZpZ3VyYXRpb24gdG8gdXNlCiAgKiBAcGFyYW0gb3B0aW9ucy50eXBlIC0gQ2hhbmdlIGhvdyB0aGUgYHF1ZXJ5YCB0ZXh0IGlzIGludGVycHJldGVkCiAgKi8KICB0ZXh0U2VhcmNoKGNvbHVtbiwgcXVlcnksIHsgY29uZmlnLCB0eXBlIH0gPSB7fSkgewogICAgbGV0IHR5cGVQYXJ0ID0gIiI7CiAgICBpZiAodHlwZSA9PT0gInBsYWluIikgdHlwZVBhcnQgPSAicGwiOwogICAgZWxzZSBpZiAodHlwZSA9PT0gInBocmFzZSIpIHR5cGVQYXJ0ID0gInBoIjsKICAgIGVsc2UgaWYgKHR5cGUgPT09ICJ3ZWJzZWFyY2giKSB0eXBlUGFydCA9ICJ3IjsKICAgIGNvbnN0IGNvbmZpZ1BhcnQgPSBjb25maWcgPT09IHZvaWQgMCA/ICIiIDogYCgke2NvbmZpZ30pYDsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgJHt0eXBlUGFydH1mdHMke2NvbmZpZ1BhcnR9LiR7cXVlcnl9YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUgZWFjaCBjb2x1bW4gaW4gYHF1ZXJ5YCBrZXlzIGlzIGVxdWFsIHRvIGl0cwogICogYXNzb2NpYXRlZCB2YWx1ZS4gU2hvcnRoYW5kIGZvciBtdWx0aXBsZSBgLmVxKClgcy4KICAqCiAgKiBAcGFyYW0gcXVlcnkgLSBUaGUgb2JqZWN0IHRvIGZpbHRlciB3aXRoLCB3aXRoIGNvbHVtbiBuYW1lcyBhcyBrZXlzIG1hcHBlZAogICogdG8gdGhlaXIgZmlsdGVyIHZhbHVlcwogICovCiAgbWF0Y2gocXVlcnkpIHsKICAgIE9iamVjdC5lbnRyaWVzKHF1ZXJ5KS5mb3JFYWNoKChbY29sdW1uLCB2YWx1ZV0pID0+IHsKICAgICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBlcS4ke3ZhbHVlfWApOwogICAgfSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBNYXRjaCBvbmx5IHJvd3Mgd2hpY2ggZG9lc24ndCBzYXRpc2Z5IHRoZSBmaWx0ZXIuCiAgKgogICogVW5saWtlIG1vc3QgZmlsdGVycywgYG9wZWFyYXRvcmAgYW5kIGB2YWx1ZWAgYXJlIHVzZWQgYXMtaXMgYW5kIG5lZWQgdG8KICAqIGZvbGxvdyBbUG9zdGdSRVNUCiAgKiBzeW50YXhdKGh0dHBzOi8vcG9zdGdyZXN0Lm9yZy9lbi9zdGFibGUvYXBpLmh0bWwjb3BlcmF0b3JzKS4gWW91IGFsc28gbmVlZAogICogdG8gbWFrZSBzdXJlIHRoZXkgYXJlIHByb3Blcmx5IHNhbml0aXplZC4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSBvcGVyYXRvciAtIFRoZSBvcGVyYXRvciB0byBiZSBuZWdhdGVkIHRvIGZpbHRlciB3aXRoLCBmb2xsb3dpbmcKICAqIFBvc3RnUkVTVCBzeW50YXgKICAqIEBwYXJhbSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBmaWx0ZXIgd2l0aCwgZm9sbG93aW5nIFBvc3RnUkVTVCBzeW50YXgKICAqLwogIG5vdChjb2x1bW4sIG9wZXJhdG9yLCB2YWx1ZSkgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBub3QuJHtvcGVyYXRvcn0uJHt2YWx1ZX1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE1hdGNoIG9ubHkgcm93cyB3aGljaCBzYXRpc2Z5IGF0IGxlYXN0IG9uZSBvZiB0aGUgZmlsdGVycy4KICAqCiAgKiBVbmxpa2UgbW9zdCBmaWx0ZXJzLCBgZmlsdGVyc2AgaXMgdXNlZCBhcy1pcyBhbmQgbmVlZHMgdG8gZm9sbG93IFtQb3N0Z1JFU1QKICAqIHN5bnRheF0oaHR0cHM6Ly9wb3N0Z3Jlc3Qub3JnL2VuL3N0YWJsZS9hcGkuaHRtbCNvcGVyYXRvcnMpLiBZb3UgYWxzbyBuZWVkCiAgKiB0byBtYWtlIHN1cmUgaXQncyBwcm9wZXJseSBzYW5pdGl6ZWQuCiAgKgogICogSXQncyBjdXJyZW50bHkgbm90IHBvc3NpYmxlIHRvIGRvIGFuIGAub3IoKWAgZmlsdGVyIGFjcm9zcyBtdWx0aXBsZSB0YWJsZXMuCiAgKgogICogQHBhcmFtIGZpbHRlcnMgLSBUaGUgZmlsdGVycyB0byB1c2UsIGZvbGxvd2luZyBQb3N0Z1JFU1Qgc3ludGF4CiAgKiBAcGFyYW0gb3B0aW9ucyAtIE5hbWVkIHBhcmFtZXRlcnMKICAqIEBwYXJhbSBvcHRpb25zLnJlZmVyZW5jZWRUYWJsZSAtIFNldCB0aGlzIHRvIGZpbHRlciBvbiByZWZlcmVuY2VkIHRhYmxlcwogICogaW5zdGVhZCBvZiB0aGUgcGFyZW50IHRhYmxlCiAgKiBAcGFyYW0gb3B0aW9ucy5mb3JlaWduVGFibGUgLSBEZXByZWNhdGVkLCB1c2UgYHJlZmVyZW5jZWRUYWJsZWAgaW5zdGVhZAogICovCiAgb3IoZmlsdGVycywgeyBmb3JlaWduVGFibGUsIHJlZmVyZW5jZWRUYWJsZSA9IGZvcmVpZ25UYWJsZSB9ID0ge30pIHsKICAgIGNvbnN0IGtleSA9IHJlZmVyZW5jZWRUYWJsZSA/IGAke3JlZmVyZW5jZWRUYWJsZX0ub3JgIDogIm9yIjsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoa2V5LCBgKCR7ZmlsdGVyc30pYCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBNYXRjaCBvbmx5IHJvd3Mgd2hpY2ggc2F0aXNmeSB0aGUgZmlsdGVyLiBUaGlzIGlzIGFuIGVzY2FwZSBoYXRjaCAtIHlvdQogICogc2hvdWxkIHVzZSB0aGUgc3BlY2lmaWMgZmlsdGVyIG1ldGhvZHMgd2hlcmV2ZXIgcG9zc2libGUuCiAgKgogICogVW5saWtlIG1vc3QgZmlsdGVycywgYG9wZWFyYXRvcmAgYW5kIGB2YWx1ZWAgYXJlIHVzZWQgYXMtaXMgYW5kIG5lZWQgdG8KICAqIGZvbGxvdyBbUG9zdGdSRVNUCiAgKiBzeW50YXhdKGh0dHBzOi8vcG9zdGdyZXN0Lm9yZy9lbi9zdGFibGUvYXBpLmh0bWwjb3BlcmF0b3JzKS4gWW91IGFsc28gbmVlZAogICogdG8gbWFrZSBzdXJlIHRoZXkgYXJlIHByb3Blcmx5IHNhbml0aXplZC4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSBvcGVyYXRvciAtIFRoZSBvcGVyYXRvciB0byBmaWx0ZXIgd2l0aCwgZm9sbG93aW5nIFBvc3RnUkVTVCBzeW50YXgKICAqIEBwYXJhbSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBmaWx0ZXIgd2l0aCwgZm9sbG93aW5nIFBvc3RnUkVTVCBzeW50YXgKICAqLwogIGZpbHRlcihjb2x1bW4sIG9wZXJhdG9yLCB2YWx1ZSkgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGAke29wZXJhdG9yfS4ke3ZhbHVlfWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQp9Owp2YXIgUG9zdGdyZXN0UXVlcnlCdWlsZGVyID0gY2xhc3MgewogIC8qKgogICogQ3JlYXRlcyBhIHF1ZXJ5IGJ1aWxkZXIgc2NvcGVkIHRvIGEgUG9zdGdyZXMgdGFibGUgb3Igdmlldy4KICAqCiAgKiBAZXhhbXBsZQogICogYGBgdHMKICAqIGltcG9ydCBQb3N0Z3Jlc3RRdWVyeUJ1aWxkZXIgZnJvbSAnQHN1cGFiYXNlL3Bvc3RncmVzdC1qcycKICAqCiAgKiBjb25zdCBxdWVyeSA9IG5ldyBQb3N0Z3Jlc3RRdWVyeUJ1aWxkZXIoCiAgKiAgIG5ldyBVUkwoJ2h0dHBzOi8veHl6Y29tcGFueS5zdXBhYmFzZS5jby9yZXN0L3YxL3VzZXJzJyksCiAgKiAgIHsgaGVhZGVyczogeyBhcGlrZXk6ICdwdWJsaWMtYW5vbi1rZXknIH0gfQogICogKQogICogYGBgCiAgKi8KICBjb25zdHJ1Y3Rvcih1cmwsIHsgaGVhZGVycyA9IHt9LCBzY2hlbWEsIGZldGNoOiBmZXRjaCQxLCB1cmxMZW5ndGhMaW1pdCA9IDhlMyB9KSB7CiAgICB0aGlzLnVybCA9IHVybDsKICAgIHRoaXMuaGVhZGVycyA9IG5ldyBIZWFkZXJzKGhlYWRlcnMpOwogICAgdGhpcy5zY2hlbWEgPSBzY2hlbWE7CiAgICB0aGlzLmZldGNoID0gZmV0Y2gkMTsKICAgIHRoaXMudXJsTGVuZ3RoTGltaXQgPSB1cmxMZW5ndGhMaW1pdDsKICB9CiAgLyoqCiAgKiBDbG9uZSBVUkwgYW5kIGhlYWRlcnMgdG8gcHJldmVudCBzaGFyZWQgc3RhdGUgYmV0d2VlbiBvcGVyYXRpb25zLgogICovCiAgY2xvbmVSZXF1ZXN0U3RhdGUoKSB7CiAgICByZXR1cm4gewogICAgICB1cmw6IG5ldyBVUkwodGhpcy51cmwudG9TdHJpbmcoKSksCiAgICAgIGhlYWRlcnM6IG5ldyBIZWFkZXJzKHRoaXMuaGVhZGVycykKICAgIH07CiAgfQogIC8qKgogICogUGVyZm9ybSBhIFNFTEVDVCBxdWVyeSBvbiB0aGUgdGFibGUgb3Igdmlldy4KICAqCiAgKiBAcGFyYW0gY29sdW1ucyAtIFRoZSBjb2x1bW5zIHRvIHJldHJpZXZlLCBzZXBhcmF0ZWQgYnkgY29tbWFzLiBDb2x1bW5zIGNhbiBiZSByZW5hbWVkIHdoZW4gcmV0dXJuZWQgd2l0aCBgY3VzdG9tTmFtZTpjb2x1bW5OYW1lYAogICoKICAqIEBwYXJhbSBvcHRpb25zIC0gTmFtZWQgcGFyYW1ldGVycwogICoKICAqIEBwYXJhbSBvcHRpb25zLmhlYWQgLSBXaGVuIHNldCB0byBgdHJ1ZWAsIGBkYXRhYCB3aWxsIG5vdCBiZSByZXR1cm5lZC4KICAqIFVzZWZ1bCBpZiB5b3Ugb25seSBuZWVkIHRoZSBjb3VudC4KICAqCiAgKiBAcGFyYW0gb3B0aW9ucy5jb3VudCAtIENvdW50IGFsZ29yaXRobSB0byB1c2UgdG8gY291bnQgcm93cyBpbiB0aGUgdGFibGUgb3Igdmlldy4KICAqCiAgKiBgImV4YWN0ImA6IEV4YWN0IGJ1dCBzbG93IGNvdW50IGFsZ29yaXRobS4gUGVyZm9ybXMgYSBgQ09VTlQoKilgIHVuZGVyIHRoZQogICogaG9vZC4KICAqCiAgKiBgInBsYW5uZWQiYDogQXBwcm94aW1hdGVkIGJ1dCBmYXN0IGNvdW50IGFsZ29yaXRobS4gVXNlcyB0aGUgUG9zdGdyZXMKICAqIHN0YXRpc3RpY3MgdW5kZXIgdGhlIGhvb2QuCiAgKgogICogYCJlc3RpbWF0ZWQiYDogVXNlcyBleGFjdCBjb3VudCBmb3IgbG93IG51bWJlcnMgYW5kIHBsYW5uZWQgY291bnQgZm9yIGhpZ2gKICAqIG51bWJlcnMuCiAgKgogICogQHJlbWFya3MKICAqIFdoZW4gdXNpbmcgYGNvdW50YCB3aXRoIGAucmFuZ2UoKWAgb3IgYC5saW1pdCgpYCwgdGhlIHJldHVybmVkIGBjb3VudGAgaXMgdGhlIHRvdGFsIG51bWJlciBvZiByb3dzCiAgKiB0aGF0IG1hdGNoIHlvdXIgZmlsdGVycywgbm90IHRoZSBudW1iZXIgb2Ygcm93cyBpbiB0aGUgY3VycmVudCBwYWdlLiBVc2UgdGhpcyB0byBidWlsZCBwYWdpbmF0aW9uIFVJLgogICovCiAgc2VsZWN0KGNvbHVtbnMsIG9wdGlvbnMpIHsKICAgIGNvbnN0IHsgaGVhZDogaGVhZDIgPSBmYWxzZSwgY291bnQgfSA9IG9wdGlvbnMgIT09IG51bGwgJiYgb3B0aW9ucyAhPT0gdm9pZCAwID8gb3B0aW9ucyA6IHt9OwogICAgY29uc3QgbWV0aG9kID0gaGVhZDIgPyAiSEVBRCIgOiAiR0VUIjsKICAgIGxldCBxdW90ZWQgPSBmYWxzZTsKICAgIGNvbnN0IGNsZWFuZWRDb2x1bW5zID0gKGNvbHVtbnMgIT09IG51bGwgJiYgY29sdW1ucyAhPT0gdm9pZCAwID8gY29sdW1ucyA6ICIqIikuc3BsaXQoIiIpLm1hcCgoYykgPT4gewogICAgICBpZiAoL1xzLy50ZXN0KGMpICYmICFxdW90ZWQpIHJldHVybiAiIjsKICAgICAgaWYgKGMgPT09ICciJykgcXVvdGVkID0gIXF1b3RlZDsKICAgICAgcmV0dXJuIGM7CiAgICB9KS5qb2luKCIiKTsKICAgIGNvbnN0IHsgdXJsLCBoZWFkZXJzIH0gPSB0aGlzLmNsb25lUmVxdWVzdFN0YXRlKCk7CiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgic2VsZWN0IiwgY2xlYW5lZENvbHVtbnMpOwogICAgaWYgKGNvdW50KSBoZWFkZXJzLmFwcGVuZCgiUHJlZmVyIiwgYGNvdW50PSR7Y291bnR9YCk7CiAgICByZXR1cm4gbmV3IFBvc3RncmVzdEZpbHRlckJ1aWxkZXIoewogICAgICBtZXRob2QsCiAgICAgIHVybCwKICAgICAgaGVhZGVycywKICAgICAgc2NoZW1hOiB0aGlzLnNjaGVtYSwKICAgICAgZmV0Y2g6IHRoaXMuZmV0Y2gsCiAgICAgIHVybExlbmd0aExpbWl0OiB0aGlzLnVybExlbmd0aExpbWl0CiAgICB9KTsKICB9CiAgLyoqCiAgKiBQZXJmb3JtIGFuIElOU0VSVCBpbnRvIHRoZSB0YWJsZSBvciB2aWV3LgogICoKICAqIEJ5IGRlZmF1bHQsIGluc2VydGVkIHJvd3MgYXJlIG5vdCByZXR1cm5lZC4gVG8gcmV0dXJuIGl0LCBjaGFpbiB0aGUgY2FsbAogICogd2l0aCBgLnNlbGVjdCgpYC4KICAqCiAgKiBAcGFyYW0gdmFsdWVzIC0gVGhlIHZhbHVlcyB0byBpbnNlcnQuIFBhc3MgYW4gb2JqZWN0IHRvIGluc2VydCBhIHNpbmdsZSByb3cKICAqIG9yIGFuIGFycmF5IHRvIGluc2VydCBtdWx0aXBsZSByb3dzLgogICoKICAqIEBwYXJhbSBvcHRpb25zIC0gTmFtZWQgcGFyYW1ldGVycwogICoKICAqIEBwYXJhbSBvcHRpb25zLmNvdW50IC0gQ291bnQgYWxnb3JpdGhtIHRvIHVzZSB0byBjb3VudCBpbnNlcnRlZCByb3dzLgogICoKICAqIGAiZXhhY3QiYDogRXhhY3QgYnV0IHNsb3cgY291bnQgYWxnb3JpdGhtLiBQZXJmb3JtcyBhIGBDT1VOVCgqKWAgdW5kZXIgdGhlCiAgKiBob29kLgogICoKICAqIGAicGxhbm5lZCJgOiBBcHByb3hpbWF0ZWQgYnV0IGZhc3QgY291bnQgYWxnb3JpdGhtLiBVc2VzIHRoZSBQb3N0Z3JlcwogICogc3RhdGlzdGljcyB1bmRlciB0aGUgaG9vZC4KICAqCiAgKiBgImVzdGltYXRlZCJgOiBVc2VzIGV4YWN0IGNvdW50IGZvciBsb3cgbnVtYmVycyBhbmQgcGxhbm5lZCBjb3VudCBmb3IgaGlnaAogICogbnVtYmVycy4KICAqCiAgKiBAcGFyYW0gb3B0aW9ucy5kZWZhdWx0VG9OdWxsIC0gTWFrZSBtaXNzaW5nIGZpZWxkcyBkZWZhdWx0IHRvIGBudWxsYC4KICAqIE90aGVyd2lzZSwgdXNlIHRoZSBkZWZhdWx0IHZhbHVlIGZvciB0aGUgY29sdW1uLiBPbmx5IGFwcGxpZXMgZm9yIGJ1bGsKICAqIGluc2VydHMuCiAgKi8KICBpbnNlcnQodmFsdWVzLCB7IGNvdW50LCBkZWZhdWx0VG9OdWxsID0gdHJ1ZSB9ID0ge30pIHsKICAgIHZhciBfdGhpcyRmZXRjaDsKICAgIGNvbnN0IG1ldGhvZCA9ICJQT1NUIjsKICAgIGNvbnN0IHsgdXJsLCBoZWFkZXJzIH0gPSB0aGlzLmNsb25lUmVxdWVzdFN0YXRlKCk7CiAgICBpZiAoY291bnQpIGhlYWRlcnMuYXBwZW5kKCJQcmVmZXIiLCBgY291bnQ9JHtjb3VudH1gKTsKICAgIGlmICghZGVmYXVsdFRvTnVsbCkgaGVhZGVycy5hcHBlbmQoIlByZWZlciIsIGBtaXNzaW5nPWRlZmF1bHRgKTsKICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlcykpIHsKICAgICAgY29uc3QgY29sdW1ucyA9IHZhbHVlcy5yZWR1Y2UoKGFjYywgeDIpID0+IGFjYy5jb25jYXQoT2JqZWN0LmtleXMoeDIpKSwgW10pOwogICAgICBpZiAoY29sdW1ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3QgdW5pcXVlQ29sdW1ucyA9IFsuLi5uZXcgU2V0KGNvbHVtbnMpXS5tYXAoKGNvbHVtbikgPT4gYCIke2NvbHVtbn0iYCk7CiAgICAgICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoImNvbHVtbnMiLCB1bmlxdWVDb2x1bW5zLmpvaW4oIiwiKSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuZXcgUG9zdGdyZXN0RmlsdGVyQnVpbGRlcih7CiAgICAgIG1ldGhvZCwKICAgICAgdXJsLAogICAgICBoZWFkZXJzLAogICAgICBzY2hlbWE6IHRoaXMuc2NoZW1hLAogICAgICBib2R5OiB2YWx1ZXMsCiAgICAgIGZldGNoOiAoX3RoaXMkZmV0Y2ggPSB0aGlzLmZldGNoKSAhPT0gbnVsbCAmJiBfdGhpcyRmZXRjaCAhPT0gdm9pZCAwID8gX3RoaXMkZmV0Y2ggOiBmZXRjaCwKICAgICAgdXJsTGVuZ3RoTGltaXQ6IHRoaXMudXJsTGVuZ3RoTGltaXQKICAgIH0pOwogIH0KICAvKioKICAqIFBlcmZvcm0gYW4gVVBTRVJUIG9uIHRoZSB0YWJsZSBvciB2aWV3LiBEZXBlbmRpbmcgb24gdGhlIGNvbHVtbihzKSBwYXNzZWQKICAqIHRvIGBvbkNvbmZsaWN0YCwgYC51cHNlcnQoKWAgYWxsb3dzIHlvdSB0byBwZXJmb3JtIHRoZSBlcXVpdmFsZW50IG9mCiAgKiBgLmluc2VydCgpYCBpZiBhIHJvdyB3aXRoIHRoZSBjb3JyZXNwb25kaW5nIGBvbkNvbmZsaWN0YCBjb2x1bW5zIGRvZXNuJ3QKICAqIGV4aXN0LCBvciBpZiBpdCBkb2VzIGV4aXN0LCBwZXJmb3JtIGFuIGFsdGVybmF0aXZlIGFjdGlvbiBkZXBlbmRpbmcgb24KICAqIGBpZ25vcmVEdXBsaWNhdGVzYC4KICAqCiAgKiBCeSBkZWZhdWx0LCB1cHNlcnRlZCByb3dzIGFyZSBub3QgcmV0dXJuZWQuIFRvIHJldHVybiBpdCwgY2hhaW4gdGhlIGNhbGwKICAqIHdpdGggYC5zZWxlY3QoKWAuCiAgKgogICogQHBhcmFtIHZhbHVlcyAtIFRoZSB2YWx1ZXMgdG8gdXBzZXJ0IHdpdGguIFBhc3MgYW4gb2JqZWN0IHRvIHVwc2VydCBhCiAgKiBzaW5nbGUgcm93IG9yIGFuIGFycmF5IHRvIHVwc2VydCBtdWx0aXBsZSByb3dzLgogICoKICAqIEBwYXJhbSBvcHRpb25zIC0gTmFtZWQgcGFyYW1ldGVycwogICoKICAqIEBwYXJhbSBvcHRpb25zLm9uQ29uZmxpY3QgLSBDb21tYS1zZXBhcmF0ZWQgVU5JUVVFIGNvbHVtbihzKSB0byBzcGVjaWZ5IGhvdwogICogZHVwbGljYXRlIHJvd3MgYXJlIGRldGVybWluZWQuIFR3byByb3dzIGFyZSBkdXBsaWNhdGVzIGlmIGFsbCB0aGUKICAqIGBvbkNvbmZsaWN0YCBjb2x1bW5zIGFyZSBlcXVhbC4KICAqCiAgKiBAcGFyYW0gb3B0aW9ucy5pZ25vcmVEdXBsaWNhdGVzIC0gSWYgYHRydWVgLCBkdXBsaWNhdGUgcm93cyBhcmUgaWdub3JlZC4gSWYKICAqIGBmYWxzZWAsIGR1cGxpY2F0ZSByb3dzIGFyZSBtZXJnZWQgd2l0aCBleGlzdGluZyByb3dzLgogICoKICAqIEBwYXJhbSBvcHRpb25zLmNvdW50IC0gQ291bnQgYWxnb3JpdGhtIHRvIHVzZSB0byBjb3VudCB1cHNlcnRlZCByb3dzLgogICoKICAqIGAiZXhhY3QiYDogRXhhY3QgYnV0IHNsb3cgY291bnQgYWxnb3JpdGhtLiBQZXJmb3JtcyBhIGBDT1VOVCgqKWAgdW5kZXIgdGhlCiAgKiBob29kLgogICoKICAqIGAicGxhbm5lZCJgOiBBcHByb3hpbWF0ZWQgYnV0IGZhc3QgY291bnQgYWxnb3JpdGhtLiBVc2VzIHRoZSBQb3N0Z3JlcwogICogc3RhdGlzdGljcyB1bmRlciB0aGUgaG9vZC4KICAqCiAgKiBgImVzdGltYXRlZCJgOiBVc2VzIGV4YWN0IGNvdW50IGZvciBsb3cgbnVtYmVycyBhbmQgcGxhbm5lZCBjb3VudCBmb3IgaGlnaAogICogbnVtYmVycy4KICAqCiAgKiBAcGFyYW0gb3B0aW9ucy5kZWZhdWx0VG9OdWxsIC0gTWFrZSBtaXNzaW5nIGZpZWxkcyBkZWZhdWx0IHRvIGBudWxsYC4KICAqIE90aGVyd2lzZSwgdXNlIHRoZSBkZWZhdWx0IHZhbHVlIGZvciB0aGUgY29sdW1uLiBUaGlzIG9ubHkgYXBwbGllcyB3aGVuCiAgKiBpbnNlcnRpbmcgbmV3IHJvd3MsIG5vdCB3aGVuIG1lcmdpbmcgd2l0aCBleGlzdGluZyByb3dzIHVuZGVyCiAgKiBgaWdub3JlRHVwbGljYXRlczogZmFsc2VgLiBUaGlzIGFsc28gb25seSBhcHBsaWVzIHdoZW4gZG9pbmcgYnVsayB1cHNlcnRzLgogICoKICAqIEBleGFtcGxlIFVwc2VydCBhIHNpbmdsZSByb3cgdXNpbmcgYSB1bmlxdWUga2V5CiAgKiBgYGB0cwogICogLy8gVXBzZXJ0aW5nIGEgc2luZ2xlIHJvdywgb3ZlcndyaXRpbmcgYmFzZWQgb24gdGhlICd1c2VybmFtZScgdW5pcXVlIGNvbHVtbgogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLmZyb20oJ3VzZXJzJykKICAqICAgLnVwc2VydCh7IHVzZXJuYW1lOiAnc3VwYWJvdCcgfSwgeyBvbkNvbmZsaWN0OiAndXNlcm5hbWUnIH0pCiAgKgogICogLy8gRXhhbXBsZSByZXNwb25zZToKICAqIC8vIHsKICAqIC8vICAgZGF0YTogWwogICogLy8gICAgIHsgaWQ6IDQsIG1lc3NhZ2U6ICdiYXInLCB1c2VybmFtZTogJ3N1cGFib3QnIH0KICAqIC8vICAgXSwKICAqIC8vICAgZXJyb3I6IG51bGwKICAqIC8vIH0KICAqIGBgYAogICoKICAqIEBleGFtcGxlIFVwc2VydCB3aXRoIGNvbmZsaWN0IHJlc29sdXRpb24gYW5kIGV4YWN0IHJvdyBjb3VudGluZwogICogYGBgdHMKICAqIC8vIFVwc2VydGluZyBhbmQgcmV0dXJuaW5nIGV4YWN0IGNvdW50CiAgKiBjb25zdCB7IGRhdGEsIGVycm9yLCBjb3VudCB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLmZyb20oJ3VzZXJzJykKICAqICAgLnVwc2VydCgKICAqICAgICB7CiAgKiAgICAgICBpZDogMywKICAqICAgICAgIG1lc3NhZ2U6ICdmb28nLAogICogICAgICAgdXNlcm5hbWU6ICdzdXBhYm90JwogICogICAgIH0sCiAgKiAgICAgewogICogICAgICAgb25Db25mbGljdDogJ3VzZXJuYW1lJywKICAqICAgICAgIGNvdW50OiAnZXhhY3QnCiAgKiAgICAgfQogICogICApCiAgKgogICogLy8gRXhhbXBsZSByZXNwb25zZToKICAqIC8vIHsKICAqIC8vICAgZGF0YTogWwogICogLy8gICAgIHsKICAqIC8vICAgICAgIGlkOiA0MiwKICAqIC8vICAgICAgIGhhbmRsZTogInNhb2lyc2UiLAogICogLy8gICAgICAgZGlzcGxheV9uYW1lOiAiU2FvaXJzZSIKICAqIC8vICAgICB9CiAgKiAvLyAgIF0sCiAgKiAvLyAgIGNvdW50OiAxLAogICogLy8gICBlcnJvcjogbnVsbAogICogLy8gfQogICogYGBgCiAgKi8KICB1cHNlcnQodmFsdWVzLCB7IG9uQ29uZmxpY3QsIGlnbm9yZUR1cGxpY2F0ZXMgPSBmYWxzZSwgY291bnQsIGRlZmF1bHRUb051bGwgPSB0cnVlIH0gPSB7fSkgewogICAgdmFyIF90aGlzJGZldGNoMjsKICAgIGNvbnN0IG1ldGhvZCA9ICJQT1NUIjsKICAgIGNvbnN0IHsgdXJsLCBoZWFkZXJzIH0gPSB0aGlzLmNsb25lUmVxdWVzdFN0YXRlKCk7CiAgICBoZWFkZXJzLmFwcGVuZCgiUHJlZmVyIiwgYHJlc29sdXRpb249JHtpZ25vcmVEdXBsaWNhdGVzID8gImlnbm9yZSIgOiAibWVyZ2UifS1kdXBsaWNhdGVzYCk7CiAgICBpZiAob25Db25mbGljdCAhPT0gdm9pZCAwKSB1cmwuc2VhcmNoUGFyYW1zLnNldCgib25fY29uZmxpY3QiLCBvbkNvbmZsaWN0KTsKICAgIGlmIChjb3VudCkgaGVhZGVycy5hcHBlbmQoIlByZWZlciIsIGBjb3VudD0ke2NvdW50fWApOwogICAgaWYgKCFkZWZhdWx0VG9OdWxsKSBoZWFkZXJzLmFwcGVuZCgiUHJlZmVyIiwgIm1pc3Npbmc9ZGVmYXVsdCIpOwogICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWVzKSkgewogICAgICBjb25zdCBjb2x1bW5zID0gdmFsdWVzLnJlZHVjZSgoYWNjLCB4MikgPT4gYWNjLmNvbmNhdChPYmplY3Qua2V5cyh4MikpLCBbXSk7CiAgICAgIGlmIChjb2x1bW5zLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCB1bmlxdWVDb2x1bW5zID0gWy4uLm5ldyBTZXQoY29sdW1ucyldLm1hcCgoY29sdW1uKSA9PiBgIiR7Y29sdW1ufSJgKTsKICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgiY29sdW1ucyIsIHVuaXF1ZUNvbHVtbnMuam9pbigiLCIpKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG5ldyBQb3N0Z3Jlc3RGaWx0ZXJCdWlsZGVyKHsKICAgICAgbWV0aG9kLAogICAgICB1cmwsCiAgICAgIGhlYWRlcnMsCiAgICAgIHNjaGVtYTogdGhpcy5zY2hlbWEsCiAgICAgIGJvZHk6IHZhbHVlcywKICAgICAgZmV0Y2g6IChfdGhpcyRmZXRjaDIgPSB0aGlzLmZldGNoKSAhPT0gbnVsbCAmJiBfdGhpcyRmZXRjaDIgIT09IHZvaWQgMCA/IF90aGlzJGZldGNoMiA6IGZldGNoLAogICAgICB1cmxMZW5ndGhMaW1pdDogdGhpcy51cmxMZW5ndGhMaW1pdAogICAgfSk7CiAgfQogIC8qKgogICogUGVyZm9ybSBhbiBVUERBVEUgb24gdGhlIHRhYmxlIG9yIHZpZXcuCiAgKgogICogQnkgZGVmYXVsdCwgdXBkYXRlZCByb3dzIGFyZSBub3QgcmV0dXJuZWQuIFRvIHJldHVybiBpdCwgY2hhaW4gdGhlIGNhbGwKICAqIHdpdGggYC5zZWxlY3QoKWAgYWZ0ZXIgZmlsdGVycy4KICAqCiAgKiBAcGFyYW0gdmFsdWVzIC0gVGhlIHZhbHVlcyB0byB1cGRhdGUgd2l0aAogICoKICAqIEBwYXJhbSBvcHRpb25zIC0gTmFtZWQgcGFyYW1ldGVycwogICoKICAqIEBwYXJhbSBvcHRpb25zLmNvdW50IC0gQ291bnQgYWxnb3JpdGhtIHRvIHVzZSB0byBjb3VudCB1cGRhdGVkIHJvd3MuCiAgKgogICogYCJleGFjdCJgOiBFeGFjdCBidXQgc2xvdyBjb3VudCBhbGdvcml0aG0uIFBlcmZvcm1zIGEgYENPVU5UKCopYCB1bmRlciB0aGUKICAqIGhvb2QuCiAgKgogICogYCJwbGFubmVkImA6IEFwcHJveGltYXRlZCBidXQgZmFzdCBjb3VudCBhbGdvcml0aG0uIFVzZXMgdGhlIFBvc3RncmVzCiAgKiBzdGF0aXN0aWNzIHVuZGVyIHRoZSBob29kLgogICoKICAqIGAiZXN0aW1hdGVkImA6IFVzZXMgZXhhY3QgY291bnQgZm9yIGxvdyBudW1iZXJzIGFuZCBwbGFubmVkIGNvdW50IGZvciBoaWdoCiAgKiBudW1iZXJzLgogICovCiAgdXBkYXRlKHZhbHVlcywgeyBjb3VudCB9ID0ge30pIHsKICAgIHZhciBfdGhpcyRmZXRjaDM7CiAgICBjb25zdCBtZXRob2QgPSAiUEFUQ0giOwogICAgY29uc3QgeyB1cmwsIGhlYWRlcnMgfSA9IHRoaXMuY2xvbmVSZXF1ZXN0U3RhdGUoKTsKICAgIGlmIChjb3VudCkgaGVhZGVycy5hcHBlbmQoIlByZWZlciIsIGBjb3VudD0ke2NvdW50fWApOwogICAgcmV0dXJuIG5ldyBQb3N0Z3Jlc3RGaWx0ZXJCdWlsZGVyKHsKICAgICAgbWV0aG9kLAogICAgICB1cmwsCiAgICAgIGhlYWRlcnMsCiAgICAgIHNjaGVtYTogdGhpcy5zY2hlbWEsCiAgICAgIGJvZHk6IHZhbHVlcywKICAgICAgZmV0Y2g6IChfdGhpcyRmZXRjaDMgPSB0aGlzLmZldGNoKSAhPT0gbnVsbCAmJiBfdGhpcyRmZXRjaDMgIT09IHZvaWQgMCA/IF90aGlzJGZldGNoMyA6IGZldGNoLAogICAgICB1cmxMZW5ndGhMaW1pdDogdGhpcy51cmxMZW5ndGhMaW1pdAogICAgfSk7CiAgfQogIC8qKgogICogUGVyZm9ybSBhIERFTEVURSBvbiB0aGUgdGFibGUgb3Igdmlldy4KICAqCiAgKiBCeSBkZWZhdWx0LCBkZWxldGVkIHJvd3MgYXJlIG5vdCByZXR1cm5lZC4gVG8gcmV0dXJuIGl0LCBjaGFpbiB0aGUgY2FsbAogICogd2l0aCBgLnNlbGVjdCgpYCBhZnRlciBmaWx0ZXJzLgogICoKICAqIEBwYXJhbSBvcHRpb25zIC0gTmFtZWQgcGFyYW1ldGVycwogICoKICAqIEBwYXJhbSBvcHRpb25zLmNvdW50IC0gQ291bnQgYWxnb3JpdGhtIHRvIHVzZSB0byBjb3VudCBkZWxldGVkIHJvd3MuCiAgKgogICogYCJleGFjdCJgOiBFeGFjdCBidXQgc2xvdyBjb3VudCBhbGdvcml0aG0uIFBlcmZvcm1zIGEgYENPVU5UKCopYCB1bmRlciB0aGUKICAqIGhvb2QuCiAgKgogICogYCJwbGFubmVkImA6IEFwcHJveGltYXRlZCBidXQgZmFzdCBjb3VudCBhbGdvcml0aG0uIFVzZXMgdGhlIFBvc3RncmVzCiAgKiBzdGF0aXN0aWNzIHVuZGVyIHRoZSBob29kLgogICoKICAqIGAiZXN0aW1hdGVkImA6IFVzZXMgZXhhY3QgY291bnQgZm9yIGxvdyBudW1iZXJzIGFuZCBwbGFubmVkIGNvdW50IGZvciBoaWdoCiAgKiBudW1iZXJzLgogICovCiAgZGVsZXRlKHsgY291bnQgfSA9IHt9KSB7CiAgICB2YXIgX3RoaXMkZmV0Y2g0OwogICAgY29uc3QgbWV0aG9kID0gIkRFTEVURSI7CiAgICBjb25zdCB7IHVybCwgaGVhZGVycyB9ID0gdGhpcy5jbG9uZVJlcXVlc3RTdGF0ZSgpOwogICAgaWYgKGNvdW50KSBoZWFkZXJzLmFwcGVuZCgiUHJlZmVyIiwgYGNvdW50PSR7Y291bnR9YCk7CiAgICByZXR1cm4gbmV3IFBvc3RncmVzdEZpbHRlckJ1aWxkZXIoewogICAgICBtZXRob2QsCiAgICAgIHVybCwKICAgICAgaGVhZGVycywKICAgICAgc2NoZW1hOiB0aGlzLnNjaGVtYSwKICAgICAgZmV0Y2g6IChfdGhpcyRmZXRjaDQgPSB0aGlzLmZldGNoKSAhPT0gbnVsbCAmJiBfdGhpcyRmZXRjaDQgIT09IHZvaWQgMCA/IF90aGlzJGZldGNoNCA6IGZldGNoLAogICAgICB1cmxMZW5ndGhMaW1pdDogdGhpcy51cmxMZW5ndGhMaW1pdAogICAgfSk7CiAgfQp9OwpmdW5jdGlvbiBfdHlwZW9mKG8pIHsKICAiQGJhYmVsL2hlbHBlcnMgLSB0eXBlb2YiOwogIHJldHVybiBfdHlwZW9mID0gImZ1bmN0aW9uIiA9PSB0eXBlb2YgU3ltYm9sICYmICJzeW1ib2wiID09IHR5cGVvZiBTeW1ib2wuaXRlcmF0b3IgPyBmdW5jdGlvbihvJDEpIHsKICAgIHJldHVybiB0eXBlb2YgbyQxOwogIH0gOiBmdW5jdGlvbihvJDEpIHsKICAgIHJldHVybiBvJDEgJiYgImZ1bmN0aW9uIiA9PSB0eXBlb2YgU3ltYm9sICYmIG8kMS5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG8kMSAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogdHlwZW9mIG8kMTsKICB9LCBfdHlwZW9mKG8pOwp9CmZ1bmN0aW9uIHRvUHJpbWl0aXZlKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IF90eXBlb2YodCkgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gX3R5cGVvZihpKSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gdG9Qcm9wZXJ0eUtleSh0KSB7CiAgdmFyIGkgPSB0b1ByaW1pdGl2ZSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IF90eXBlb2YoaSkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTM0KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IHRvUHJvcGVydHlLZXkocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7CiAgICB2YWx1ZTogdCwKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICB3cml0YWJsZTogdHJ1ZQogIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIG93bktleXMzMihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ociQxKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIkMSkuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjEwKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMzIoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIkMSkgewogICAgICBfZGVmaW5lUHJvcGVydHkzNChlLCByJDEsIHRbciQxXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czMyKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyJDEpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIkMSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByJDEpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQp2YXIgUG9zdGdyZXN0Q2xpZW50ID0gY2xhc3MgUG9zdGdyZXN0Q2xpZW50MiB7CiAgLyoqCiAgKiBDcmVhdGVzIGEgUG9zdGdSRVNUIGNsaWVudC4KICAqCiAgKiBAcGFyYW0gdXJsIC0gVVJMIG9mIHRoZSBQb3N0Z1JFU1QgZW5kcG9pbnQKICAqIEBwYXJhbSBvcHRpb25zIC0gTmFtZWQgcGFyYW1ldGVycwogICogQHBhcmFtIG9wdGlvbnMuaGVhZGVycyAtIEN1c3RvbSBoZWFkZXJzCiAgKiBAcGFyYW0gb3B0aW9ucy5zY2hlbWEgLSBQb3N0Z3JlcyBzY2hlbWEgdG8gc3dpdGNoIHRvCiAgKiBAcGFyYW0gb3B0aW9ucy5mZXRjaCAtIEN1c3RvbSBmZXRjaAogICogQHBhcmFtIG9wdGlvbnMudGltZW91dCAtIE9wdGlvbmFsIHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzIGZvciBhbGwgcmVxdWVzdHMuIFdoZW4gc2V0LCByZXF1ZXN0cyB3aWxsIGF1dG9tYXRpY2FsbHkgYWJvcnQgYWZ0ZXIgdGhpcyBkdXJhdGlvbiB0byBwcmV2ZW50IGluZGVmaW5pdGUgaGFuZ3MuCiAgKiBAcGFyYW0gb3B0aW9ucy51cmxMZW5ndGhMaW1pdCAtIE1heGltdW0gVVJMIGxlbmd0aCBpbiBjaGFyYWN0ZXJzIGJlZm9yZSB3YXJuaW5ncy9lcnJvcnMgYXJlIHRyaWdnZXJlZC4gRGVmYXVsdHMgdG8gODAwMC4KICAqIEBleGFtcGxlCiAgKiBgYGB0cwogICogaW1wb3J0IFBvc3RncmVzdENsaWVudCBmcm9tICdAc3VwYWJhc2UvcG9zdGdyZXN0LWpzJwogICoKICAqIGNvbnN0IHBvc3RncmVzdCA9IG5ldyBQb3N0Z3Jlc3RDbGllbnQoJ2h0dHBzOi8veHl6Y29tcGFueS5zdXBhYmFzZS5jby9yZXN0L3YxJywgewogICogICBoZWFkZXJzOiB7IGFwaWtleTogJ3B1YmxpYy1hbm9uLWtleScgfSwKICAqICAgc2NoZW1hOiAncHVibGljJywKICAqICAgdGltZW91dDogMzAwMDAsIC8vIDMwIHNlY29uZCB0aW1lb3V0CiAgKiB9KQogICogYGBgCiAgKi8KICBjb25zdHJ1Y3Rvcih1cmwsIHsgaGVhZGVycyA9IHt9LCBzY2hlbWEsIGZldGNoOiBmZXRjaCQxLCB0aW1lb3V0LCB1cmxMZW5ndGhMaW1pdCA9IDhlMyB9ID0ge30pIHsKICAgIHRoaXMudXJsID0gdXJsOwogICAgdGhpcy5oZWFkZXJzID0gbmV3IEhlYWRlcnMoaGVhZGVycyk7CiAgICB0aGlzLnNjaGVtYU5hbWUgPSBzY2hlbWE7CiAgICB0aGlzLnVybExlbmd0aExpbWl0ID0gdXJsTGVuZ3RoTGltaXQ7CiAgICBjb25zdCBvcmlnaW5hbEZldGNoID0gZmV0Y2gkMSAhPT0gbnVsbCAmJiBmZXRjaCQxICE9PSB2b2lkIDAgPyBmZXRjaCQxIDogZ2xvYmFsVGhpcy5mZXRjaDsKICAgIGlmICh0aW1lb3V0ICE9PSB2b2lkIDAgJiYgdGltZW91dCA+IDApIHRoaXMuZmV0Y2ggPSAoaW5wdXQsIGluaXQpID0+IHsKICAgICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgICAgY29uc3QgdGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiBjb250cm9sbGVyLmFib3J0KCksIHRpbWVvdXQpOwogICAgICBjb25zdCBleGlzdGluZ1NpZ25hbCA9IGluaXQgPT09IG51bGwgfHwgaW5pdCA9PT0gdm9pZCAwID8gdm9pZCAwIDogaW5pdC5zaWduYWw7CiAgICAgIGlmIChleGlzdGluZ1NpZ25hbCkgewogICAgICAgIGlmIChleGlzdGluZ1NpZ25hbC5hYm9ydGVkKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTsKICAgICAgICAgIHJldHVybiBvcmlnaW5hbEZldGNoKGlucHV0LCBpbml0KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYWJvcnRIYW5kbGVyID0gKCkgPT4gewogICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgICAgICAgICBjb250cm9sbGVyLmFib3J0KCk7CiAgICAgICAgfTsKICAgICAgICBleGlzdGluZ1NpZ25hbC5hZGRFdmVudExpc3RlbmVyKCJhYm9ydCIsIGFib3J0SGFuZGxlciwgeyBvbmNlOiB0cnVlIH0pOwogICAgICAgIHJldHVybiBvcmlnaW5hbEZldGNoKGlucHV0LCBfb2JqZWN0U3ByZWFkMjEwKF9vYmplY3RTcHJlYWQyMTAoe30sIGluaXQpLCB7fSwgeyBzaWduYWw6IGNvbnRyb2xsZXIuc2lnbmFsIH0pKS5maW5hbGx5KCgpID0+IHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICAgICAgZXhpc3RpbmdTaWduYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBhYm9ydEhhbmRsZXIpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBvcmlnaW5hbEZldGNoKGlucHV0LCBfb2JqZWN0U3ByZWFkMjEwKF9vYmplY3RTcHJlYWQyMTAoe30sIGluaXQpLCB7fSwgeyBzaWduYWw6IGNvbnRyb2xsZXIuc2lnbmFsIH0pKS5maW5hbGx5KCgpID0+IGNsZWFyVGltZW91dCh0aW1lb3V0SWQpKTsKICAgIH07CiAgICBlbHNlIHRoaXMuZmV0Y2ggPSBvcmlnaW5hbEZldGNoOwogIH0KICAvKioKICAqIFBlcmZvcm0gYSBxdWVyeSBvbiBhIHRhYmxlIG9yIGEgdmlldy4KICAqCiAgKiBAcGFyYW0gcmVsYXRpb24gLSBUaGUgdGFibGUgb3IgdmlldyBuYW1lIHRvIHF1ZXJ5CiAgKi8KICBmcm9tKHJlbGF0aW9uKSB7CiAgICBpZiAoIXJlbGF0aW9uIHx8IHR5cGVvZiByZWxhdGlvbiAhPT0gInN0cmluZyIgfHwgcmVsYXRpb24udHJpbSgpID09PSAiIikgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHJlbGF0aW9uIG5hbWU6IHJlbGF0aW9uIG11c3QgYmUgYSBub24tZW1wdHkgc3RyaW5nLiIpOwogICAgcmV0dXJuIG5ldyBQb3N0Z3Jlc3RRdWVyeUJ1aWxkZXIobmV3IFVSTChgJHt0aGlzLnVybH0vJHtyZWxhdGlvbn1gKSwgewogICAgICBoZWFkZXJzOiBuZXcgSGVhZGVycyh0aGlzLmhlYWRlcnMpLAogICAgICBzY2hlbWE6IHRoaXMuc2NoZW1hTmFtZSwKICAgICAgZmV0Y2g6IHRoaXMuZmV0Y2gsCiAgICAgIHVybExlbmd0aExpbWl0OiB0aGlzLnVybExlbmd0aExpbWl0CiAgICB9KTsKICB9CiAgLyoqCiAgKiBTZWxlY3QgYSBzY2hlbWEgdG8gcXVlcnkgb3IgcGVyZm9ybSBhbiBmdW5jdGlvbiAocnBjKSBjYWxsLgogICoKICAqIFRoZSBzY2hlbWEgbmVlZHMgdG8gYmUgb24gdGhlIGxpc3Qgb2YgZXhwb3NlZCBzY2hlbWFzIGluc2lkZSBTdXBhYmFzZS4KICAqCiAgKiBAcGFyYW0gc2NoZW1hIC0gVGhlIHNjaGVtYSB0byBxdWVyeQogICovCiAgc2NoZW1hKHNjaGVtYSkgewogICAgcmV0dXJuIG5ldyBQb3N0Z3Jlc3RDbGllbnQyKHRoaXMudXJsLCB7CiAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgc2NoZW1hLAogICAgICBmZXRjaDogdGhpcy5mZXRjaCwKICAgICAgdXJsTGVuZ3RoTGltaXQ6IHRoaXMudXJsTGVuZ3RoTGltaXQKICAgIH0pOwogIH0KICAvKioKICAqIFBlcmZvcm0gYSBmdW5jdGlvbiBjYWxsLgogICoKICAqIEBwYXJhbSBmbiAtIFRoZSBmdW5jdGlvbiBuYW1lIHRvIGNhbGwKICAqIEBwYXJhbSBhcmdzIC0gVGhlIGFyZ3VtZW50cyB0byBwYXNzIHRvIHRoZSBmdW5jdGlvbiBjYWxsCiAgKiBAcGFyYW0gb3B0aW9ucyAtIE5hbWVkIHBhcmFtZXRlcnMKICAqIEBwYXJhbSBvcHRpb25zLmhlYWQgLSBXaGVuIHNldCB0byBgdHJ1ZWAsIGBkYXRhYCB3aWxsIG5vdCBiZSByZXR1cm5lZC4KICAqIFVzZWZ1bCBpZiB5b3Ugb25seSBuZWVkIHRoZSBjb3VudC4KICAqIEBwYXJhbSBvcHRpb25zLmdldCAtIFdoZW4gc2V0IHRvIGB0cnVlYCwgdGhlIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdpdGgKICAqIHJlYWQtb25seSBhY2Nlc3MgbW9kZS4KICAqIEBwYXJhbSBvcHRpb25zLmNvdW50IC0gQ291bnQgYWxnb3JpdGhtIHRvIHVzZSB0byBjb3VudCByb3dzIHJldHVybmVkIGJ5IHRoZQogICogZnVuY3Rpb24uIE9ubHkgYXBwbGljYWJsZSBmb3IgW3NldC1yZXR1cm5pbmcKICAqIGZ1bmN0aW9uc10oaHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy9jdXJyZW50L2Z1bmN0aW9ucy1zcmYuaHRtbCkuCiAgKgogICogYCJleGFjdCJgOiBFeGFjdCBidXQgc2xvdyBjb3VudCBhbGdvcml0aG0uIFBlcmZvcm1zIGEgYENPVU5UKCopYCB1bmRlciB0aGUKICAqIGhvb2QuCiAgKgogICogYCJwbGFubmVkImA6IEFwcHJveGltYXRlZCBidXQgZmFzdCBjb3VudCBhbGdvcml0aG0uIFVzZXMgdGhlIFBvc3RncmVzCiAgKiBzdGF0aXN0aWNzIHVuZGVyIHRoZSBob29kLgogICoKICAqIGAiZXN0aW1hdGVkImA6IFVzZXMgZXhhY3QgY291bnQgZm9yIGxvdyBudW1iZXJzIGFuZCBwbGFubmVkIGNvdW50IGZvciBoaWdoCiAgKiBudW1iZXJzLgogICoKICAqIEBleGFtcGxlCiAgKiBgYGB0cwogICogLy8gRm9yIGNyb3NzLXNjaGVtYSBmdW5jdGlvbnMgd2hlcmUgdHlwZSBpbmZlcmVuY2UgZmFpbHMsIHVzZSBvdmVycmlkZVR5cGVzOgogICogY29uc3QgeyBkYXRhIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc2NoZW1hKCdzY2hlbWFfYicpCiAgKiAgIC5ycGMoJ2Z1bmN0aW9uX2EnLCB7fSkKICAqICAgLm92ZXJyaWRlVHlwZXM8eyBpZDogc3RyaW5nOyB1c2VyX2lkOiBzdHJpbmcgfVtdPigpCiAgKiBgYGAKICAqLwogIHJwYyhmbiwgYXJncyA9IHt9LCB7IGhlYWQ6IGhlYWQyID0gZmFsc2UsIGdldDogZ2V0NiA9IGZhbHNlLCBjb3VudCB9ID0ge30pIHsKICAgIHZhciBfdGhpcyRmZXRjaDsKICAgIGxldCBtZXRob2Q7CiAgICBjb25zdCB1cmwgPSBuZXcgVVJMKGAke3RoaXMudXJsfS9ycGMvJHtmbn1gKTsKICAgIGxldCBib2R5OwogICAgY29uc3QgX2lzT2JqZWN0ID0gKHYpID0+IHYgIT09IG51bGwgJiYgdHlwZW9mIHYgPT09ICJvYmplY3QiICYmICghQXJyYXkuaXNBcnJheSh2KSB8fCB2LnNvbWUoX2lzT2JqZWN0KSk7CiAgICBjb25zdCBfaGFzT2JqZWN0QXJnID0gaGVhZDIgJiYgT2JqZWN0LnZhbHVlcyhhcmdzKS5zb21lKF9pc09iamVjdCk7CiAgICBpZiAoX2hhc09iamVjdEFyZykgewogICAgICBtZXRob2QgPSAiUE9TVCI7CiAgICAgIGJvZHkgPSBhcmdzOwogICAgfSBlbHNlIGlmIChoZWFkMiB8fCBnZXQ2KSB7CiAgICAgIG1ldGhvZCA9IGhlYWQyID8gIkhFQUQiIDogIkdFVCI7CiAgICAgIE9iamVjdC5lbnRyaWVzKGFyZ3MpLmZpbHRlcigoW18sIHZhbHVlXSkgPT4gdmFsdWUgIT09IHZvaWQgMCkubWFwKChbbmFtZSwgdmFsdWVdKSA9PiBbbmFtZSwgQXJyYXkuaXNBcnJheSh2YWx1ZSkgPyBgeyR7dmFsdWUuam9pbigiLCIpfX1gIDogYCR7dmFsdWV9YF0pLmZvckVhY2goKFtuYW1lLCB2YWx1ZV0pID0+IHsKICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChuYW1lLCB2YWx1ZSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgbWV0aG9kID0gIlBPU1QiOwogICAgICBib2R5ID0gYXJnczsKICAgIH0KICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgSGVhZGVycyh0aGlzLmhlYWRlcnMpOwogICAgaWYgKF9oYXNPYmplY3RBcmcpIGhlYWRlcnMuc2V0KCJQcmVmZXIiLCBjb3VudCA/IGBjb3VudD0ke2NvdW50fSxyZXR1cm49bWluaW1hbGAgOiAicmV0dXJuPW1pbmltYWwiKTsKICAgIGVsc2UgaWYgKGNvdW50KSBoZWFkZXJzLnNldCgiUHJlZmVyIiwgYGNvdW50PSR7Y291bnR9YCk7CiAgICByZXR1cm4gbmV3IFBvc3RncmVzdEZpbHRlckJ1aWxkZXIoewogICAgICBtZXRob2QsCiAgICAgIHVybCwKICAgICAgaGVhZGVycywKICAgICAgc2NoZW1hOiB0aGlzLnNjaGVtYU5hbWUsCiAgICAgIGJvZHksCiAgICAgIGZldGNoOiAoX3RoaXMkZmV0Y2ggPSB0aGlzLmZldGNoKSAhPT0gbnVsbCAmJiBfdGhpcyRmZXRjaCAhPT0gdm9pZCAwID8gX3RoaXMkZmV0Y2ggOiBmZXRjaCwKICAgICAgdXJsTGVuZ3RoTGltaXQ6IHRoaXMudXJsTGVuZ3RoTGltaXQKICAgIH0pOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrcmVhbHRpbWUtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvcmVhbHRpbWUtanMvZGlzdC9tb2R1bGUvbGliL3dlYnNvY2tldC1mYWN0b3J5LmpzCnZhciBXZWJTb2NrZXRGYWN0b3J5ID0gY2xhc3MgewogIC8qKgogICAqIFN0YXRpYy1vbmx5IHV0aWxpdHkg4oCTIHByZXZlbnQgaW5zdGFudGlhdGlvbi4KICAgKi8KICBjb25zdHJ1Y3RvcigpIHsKICB9CiAgc3RhdGljIGRldGVjdEVudmlyb25tZW50KCkgewogICAgdmFyIF9hOwogICAgaWYgKHR5cGVvZiBXZWJTb2NrZXQgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHJldHVybiB7IHR5cGU6ICJuYXRpdmUiLCBjb25zdHJ1Y3RvcjogV2ViU29ja2V0IH07CiAgICB9CiAgICBpZiAodHlwZW9mIGdsb2JhbFRoaXMgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBnbG9iYWxUaGlzLldlYlNvY2tldCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgcmV0dXJuIHsgdHlwZTogIm5hdGl2ZSIsIGNvbnN0cnVjdG9yOiBnbG9iYWxUaGlzLldlYlNvY2tldCB9OwogICAgfQogICAgaWYgKHR5cGVvZiBnbG9iYWwgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBnbG9iYWwuV2ViU29ja2V0ICE9PSAidW5kZWZpbmVkIikgewogICAgICByZXR1cm4geyB0eXBlOiAibmF0aXZlIiwgY29uc3RydWN0b3I6IGdsb2JhbC5XZWJTb2NrZXQgfTsKICAgIH0KICAgIGlmICh0eXBlb2YgZ2xvYmFsVGhpcyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIGdsb2JhbFRoaXMuV2ViU29ja2V0UGFpciAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIGdsb2JhbFRoaXMuV2ViU29ja2V0ID09PSAidW5kZWZpbmVkIikgewogICAgICByZXR1cm4gewogICAgICAgIHR5cGU6ICJjbG91ZGZsYXJlIiwKICAgICAgICBlcnJvcjogIkNsb3VkZmxhcmUgV29ya2VycyBkZXRlY3RlZC4gV2ViU29ja2V0IGNsaWVudHMgYXJlIG5vdCBzdXBwb3J0ZWQgaW4gQ2xvdWRmbGFyZSBXb3JrZXJzLiIsCiAgICAgICAgd29ya2Fyb3VuZDogIlVzZSBDbG91ZGZsYXJlIFdvcmtlcnMgV2ViU29ja2V0IEFQSSBmb3Igc2VydmVyLXNpZGUgV2ViU29ja2V0IGhhbmRsaW5nLCBvciBkZXBsb3kgdG8gYSBkaWZmZXJlbnQgcnVudGltZS4iCiAgICAgIH07CiAgICB9CiAgICBpZiAodHlwZW9mIGdsb2JhbFRoaXMgIT09ICJ1bmRlZmluZWQiICYmIGdsb2JhbFRoaXMuRWRnZVJ1bnRpbWUgfHwgdHlwZW9mIG5hdmlnYXRvciAhPT0gInVuZGVmaW5lZCIgJiYgKChfYSA9IG5hdmlnYXRvci51c2VyQWdlbnQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5pbmNsdWRlcygiVmVyY2VsLUVkZ2UiKSkpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB0eXBlOiAidW5zdXBwb3J0ZWQiLAogICAgICAgIGVycm9yOiAiRWRnZSBydW50aW1lIGRldGVjdGVkIChWZXJjZWwgRWRnZS9OZXRsaWZ5IEVkZ2UpLiBXZWJTb2NrZXRzIGFyZSBub3Qgc3VwcG9ydGVkIGluIGVkZ2UgZnVuY3Rpb25zLiIsCiAgICAgICAgd29ya2Fyb3VuZDogIlVzZSBzZXJ2ZXJsZXNzIGZ1bmN0aW9ucyBvciBhIGRpZmZlcmVudCBkZXBsb3ltZW50IHRhcmdldCBmb3IgV2ViU29ja2V0IGZ1bmN0aW9uYWxpdHkuIgogICAgICB9OwogICAgfQogICAgY29uc3QgX3Byb2Nlc3MgPSBnbG9iYWxUaGlzWyJwcm9jZXNzIl07CiAgICBpZiAoX3Byb2Nlc3MpIHsKICAgICAgY29uc3QgcHJvY2Vzc1ZlcnNpb25zID0gX3Byb2Nlc3NbInZlcnNpb25zIl07CiAgICAgIGlmIChwcm9jZXNzVmVyc2lvbnMgJiYgcHJvY2Vzc1ZlcnNpb25zWyJub2RlIl0pIHsKICAgICAgICBjb25zdCB2ZXJzaW9uU3RyaW5nID0gcHJvY2Vzc1ZlcnNpb25zWyJub2RlIl07CiAgICAgICAgY29uc3Qgbm9kZVZlcnNpb24gPSBwYXJzZUludCh2ZXJzaW9uU3RyaW5nLnJlcGxhY2UoL152LywgIiIpLnNwbGl0KCIuIilbMF0pOwogICAgICAgIGlmIChub2RlVmVyc2lvbiA+PSAyMikgewogICAgICAgICAgaWYgKHR5cGVvZiBnbG9iYWxUaGlzLldlYlNvY2tldCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIHsgdHlwZTogIm5hdGl2ZSIsIGNvbnN0cnVjdG9yOiBnbG9iYWxUaGlzLldlYlNvY2tldCB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdHlwZTogInVuc3VwcG9ydGVkIiwKICAgICAgICAgICAgZXJyb3I6IGBOb2RlLmpzICR7bm9kZVZlcnNpb259IGRldGVjdGVkIGJ1dCBuYXRpdmUgV2ViU29ja2V0IG5vdCBmb3VuZC5gLAogICAgICAgICAgICB3b3JrYXJvdW5kOiAiUHJvdmlkZSBhIFdlYlNvY2tldCBpbXBsZW1lbnRhdGlvbiB2aWEgdGhlIHRyYW5zcG9ydCBvcHRpb24uIgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHR5cGU6ICJ1bnN1cHBvcnRlZCIsCiAgICAgICAgICBlcnJvcjogYE5vZGUuanMgJHtub2RlVmVyc2lvbn0gZGV0ZWN0ZWQgd2l0aG91dCBuYXRpdmUgV2ViU29ja2V0IHN1cHBvcnQuYCwKICAgICAgICAgIHdvcmthcm91bmQ6ICdGb3IgTm9kZS5qcyA8IDIyLCBpbnN0YWxsICJ3cyIgcGFja2FnZSBhbmQgcHJvdmlkZSBpdCB2aWEgdGhlIHRyYW5zcG9ydCBvcHRpb246XG5pbXBvcnQgd3MgZnJvbSAid3MiXG5uZXcgUmVhbHRpbWVDbGllbnQodXJsLCB7IHRyYW5zcG9ydDogd3MgfSknCiAgICAgICAgfTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgdHlwZTogInVuc3VwcG9ydGVkIiwKICAgICAgZXJyb3I6ICJVbmtub3duIEphdmFTY3JpcHQgcnVudGltZSB3aXRob3V0IFdlYlNvY2tldCBzdXBwb3J0LiIsCiAgICAgIHdvcmthcm91bmQ6ICJFbnN1cmUgeW91J3JlIHJ1bm5pbmcgaW4gYSBzdXBwb3J0ZWQgZW52aXJvbm1lbnQgKGJyb3dzZXIsIE5vZGUuanMsIERlbm8pIG9yIHByb3ZpZGUgYSBjdXN0b20gV2ViU29ja2V0IGltcGxlbWVudGF0aW9uLiIKICAgIH07CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGJlc3QgYXZhaWxhYmxlIFdlYlNvY2tldCBjb25zdHJ1Y3RvciBmb3IgdGhlIGN1cnJlbnQgcnVudGltZS4KICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHMKICAgKiBjb25zdCBXUyA9IFdlYlNvY2tldEZhY3RvcnkuZ2V0V2ViU29ja2V0Q29uc3RydWN0b3IoKQogICAqIGNvbnN0IHNvY2tldCA9IG5ldyBXUygnd3NzOi8vcmVhbHRpbWUuc3VwYWJhc2UuY28vc29ja2V0JykKICAgKiBgYGAKICAgKi8KICBzdGF0aWMgZ2V0V2ViU29ja2V0Q29uc3RydWN0b3IoKSB7CiAgICBjb25zdCBlbnYgPSB0aGlzLmRldGVjdEVudmlyb25tZW50KCk7CiAgICBpZiAoZW52LmNvbnN0cnVjdG9yKSB7CiAgICAgIHJldHVybiBlbnYuY29uc3RydWN0b3I7CiAgICB9CiAgICBsZXQgZXJyb3JNZXNzYWdlID0gZW52LmVycm9yIHx8ICJXZWJTb2NrZXQgbm90IHN1cHBvcnRlZCBpbiB0aGlzIGVudmlyb25tZW50LiI7CiAgICBpZiAoZW52Lndvcmthcm91bmQpIHsKICAgICAgZXJyb3JNZXNzYWdlICs9IGAKClN1Z2dlc3RlZCBzb2x1dGlvbjogJHtlbnYud29ya2Fyb3VuZH1gOwogICAgfQogICAgdGhyb3cgbmV3IEVycm9yKGVycm9yTWVzc2FnZSk7CiAgfQogIC8qKgogICAqIENyZWF0ZXMgYSBXZWJTb2NrZXQgdXNpbmcgdGhlIGRldGVjdGVkIGNvbnN0cnVjdG9yLgogICAqCiAgICogQGV4YW1wbGUKICAgKiBgYGB0cwogICAqIGNvbnN0IHNvY2tldCA9IFdlYlNvY2tldEZhY3RvcnkuY3JlYXRlV2ViU29ja2V0KCd3c3M6Ly9yZWFsdGltZS5zdXBhYmFzZS5jby9zb2NrZXQnKQogICAqIGBgYAogICAqLwogIHN0YXRpYyBjcmVhdGVXZWJTb2NrZXQodXJsLCBwcm90b2NvbHMpIHsKICAgIGNvbnN0IFdTID0gdGhpcy5nZXRXZWJTb2NrZXRDb25zdHJ1Y3RvcigpOwogICAgcmV0dXJuIG5ldyBXUyh1cmwsIHByb3RvY29scyk7CiAgfQogIC8qKgogICAqIERldGVjdHMgd2hldGhlciB0aGUgcnVudGltZSBjYW4gZXN0YWJsaXNoIFdlYlNvY2tldCBjb25uZWN0aW9ucy4KICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHMKICAgKiBpZiAoIVdlYlNvY2tldEZhY3RvcnkuaXNXZWJTb2NrZXRTdXBwb3J0ZWQoKSkgewogICAqICAgY29uc29sZS53YXJuKCdGYWxsaW5nIGJhY2sgdG8gbG9uZyBwb2xsaW5nJykKICAgKiB9CiAgICogYGBgCiAgICovCiAgc3RhdGljIGlzV2ViU29ja2V0U3VwcG9ydGVkKCkgewogICAgdHJ5IHsKICAgICAgY29uc3QgZW52ID0gdGhpcy5kZXRlY3RFbnZpcm9ubWVudCgpOwogICAgICByZXR1cm4gZW52LnR5cGUgPT09ICJuYXRpdmUiIHx8IGVudi50eXBlID09PSAid3MiOwogICAgfSBjYXRjaCAoX2EpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KfTsKdmFyIHdlYnNvY2tldF9mYWN0b3J5X2RlZmF1bHQgPSBXZWJTb2NrZXRGYWN0b3J5OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZStyZWFsdGltZS1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9yZWFsdGltZS1qcy9kaXN0L21vZHVsZS9saWIvdmVyc2lvbi5qcwp2YXIgdmVyc2lvbjIgPSAiMi45Ny4wIjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrcmVhbHRpbWUtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvcmVhbHRpbWUtanMvZGlzdC9tb2R1bGUvbGliL2NvbnN0YW50cy5qcwp2YXIgREVGQVVMVF9WRVJTSU9OID0gYHJlYWx0aW1lLWpzLyR7dmVyc2lvbjJ9YDsKdmFyIFZTTl8xXzBfMCA9ICIxLjAuMCI7CnZhciBWU05fMl8wXzAgPSAiMi4wLjAiOwp2YXIgREVGQVVMVF9WU04gPSBWU05fMl8wXzA7CnZhciBERUZBVUxUX1RJTUVPVVQgPSAxZTQ7CnZhciBXU19DTE9TRV9OT1JNQUwgPSAxZTM7CnZhciBNQVhfUFVTSF9CVUZGRVJfU0laRSA9IDEwMDsKdmFyIFNPQ0tFVF9TVEFURVM7CihmdW5jdGlvbihTT0NLRVRfU1RBVEVTMikgewogIFNPQ0tFVF9TVEFURVMyW1NPQ0tFVF9TVEFURVMyWyJjb25uZWN0aW5nIl0gPSAwXSA9ICJjb25uZWN0aW5nIjsKICBTT0NLRVRfU1RBVEVTMltTT0NLRVRfU1RBVEVTMlsib3BlbiJdID0gMV0gPSAib3BlbiI7CiAgU09DS0VUX1NUQVRFUzJbU09DS0VUX1NUQVRFUzJbImNsb3NpbmciXSA9IDJdID0gImNsb3NpbmciOwogIFNPQ0tFVF9TVEFURVMyW1NPQ0tFVF9TVEFURVMyWyJjbG9zZWQiXSA9IDNdID0gImNsb3NlZCI7Cn0pKFNPQ0tFVF9TVEFURVMgfHwgKFNPQ0tFVF9TVEFURVMgPSB7fSkpOwp2YXIgQ0hBTk5FTF9TVEFURVM7CihmdW5jdGlvbihDSEFOTkVMX1NUQVRFUzIpIHsKICBDSEFOTkVMX1NUQVRFUzJbImNsb3NlZCJdID0gImNsb3NlZCI7CiAgQ0hBTk5FTF9TVEFURVMyWyJlcnJvcmVkIl0gPSAiZXJyb3JlZCI7CiAgQ0hBTk5FTF9TVEFURVMyWyJqb2luZWQiXSA9ICJqb2luZWQiOwogIENIQU5ORUxfU1RBVEVTMlsiam9pbmluZyJdID0gImpvaW5pbmciOwogIENIQU5ORUxfU1RBVEVTMlsibGVhdmluZyJdID0gImxlYXZpbmciOwp9KShDSEFOTkVMX1NUQVRFUyB8fCAoQ0hBTk5FTF9TVEFURVMgPSB7fSkpOwp2YXIgQ0hBTk5FTF9FVkVOVFM7CihmdW5jdGlvbihDSEFOTkVMX0VWRU5UUzIpIHsKICBDSEFOTkVMX0VWRU5UUzJbImNsb3NlIl0gPSAicGh4X2Nsb3NlIjsKICBDSEFOTkVMX0VWRU5UUzJbImVycm9yIl0gPSAicGh4X2Vycm9yIjsKICBDSEFOTkVMX0VWRU5UUzJbImpvaW4iXSA9ICJwaHhfam9pbiI7CiAgQ0hBTk5FTF9FVkVOVFMyWyJyZXBseSJdID0gInBoeF9yZXBseSI7CiAgQ0hBTk5FTF9FVkVOVFMyWyJsZWF2ZSJdID0gInBoeF9sZWF2ZSI7CiAgQ0hBTk5FTF9FVkVOVFMyWyJhY2Nlc3NfdG9rZW4iXSA9ICJhY2Nlc3NfdG9rZW4iOwp9KShDSEFOTkVMX0VWRU5UUyB8fCAoQ0hBTk5FTF9FVkVOVFMgPSB7fSkpOwp2YXIgVFJBTlNQT1JUUzsKKGZ1bmN0aW9uKFRSQU5TUE9SVFMyKSB7CiAgVFJBTlNQT1JUUzJbIndlYnNvY2tldCJdID0gIndlYnNvY2tldCI7Cn0pKFRSQU5TUE9SVFMgfHwgKFRSQU5TUE9SVFMgPSB7fSkpOwp2YXIgQ09OTkVDVElPTl9TVEFURTsKKGZ1bmN0aW9uKENPTk5FQ1RJT05fU1RBVEUyKSB7CiAgQ09OTkVDVElPTl9TVEFURTJbIkNvbm5lY3RpbmciXSA9ICJjb25uZWN0aW5nIjsKICBDT05ORUNUSU9OX1NUQVRFMlsiT3BlbiJdID0gIm9wZW4iOwogIENPTk5FQ1RJT05fU1RBVEUyWyJDbG9zaW5nIl0gPSAiY2xvc2luZyI7CiAgQ09OTkVDVElPTl9TVEFURTJbIkNsb3NlZCJdID0gImNsb3NlZCI7Cn0pKENPTk5FQ1RJT05fU1RBVEUgfHwgKENPTk5FQ1RJT05fU1RBVEUgPSB7fSkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZStyZWFsdGltZS1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9yZWFsdGltZS1qcy9kaXN0L21vZHVsZS9saWIvc2VyaWFsaXplci5qcwp2YXIgU2VyaWFsaXplciA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihhbGxvd2VkTWV0YWRhdGFLZXlzKSB7CiAgICB0aGlzLkhFQURFUl9MRU5HVEggPSAxOwogICAgdGhpcy5VU0VSX0JST0FEQ0FTVF9QVVNIX01FVEFfTEVOR1RIID0gNjsKICAgIHRoaXMuS0lORFMgPSB7IHVzZXJCcm9hZGNhc3RQdXNoOiAzLCB1c2VyQnJvYWRjYXN0OiA0IH07CiAgICB0aGlzLkJJTkFSWV9FTkNPRElORyA9IDA7CiAgICB0aGlzLkpTT05fRU5DT0RJTkcgPSAxOwogICAgdGhpcy5CUk9BRENBU1RfRVZFTlQgPSAiYnJvYWRjYXN0IjsKICAgIHRoaXMuYWxsb3dlZE1ldGFkYXRhS2V5cyA9IFtdOwogICAgdGhpcy5hbGxvd2VkTWV0YWRhdGFLZXlzID0gYWxsb3dlZE1ldGFkYXRhS2V5cyAhPT0gbnVsbCAmJiBhbGxvd2VkTWV0YWRhdGFLZXlzICE9PSB2b2lkIDAgPyBhbGxvd2VkTWV0YWRhdGFLZXlzIDogW107CiAgfQogIGVuY29kZShtc2csIGNhbGxiYWNrKSB7CiAgICBpZiAobXNnLmV2ZW50ID09PSB0aGlzLkJST0FEQ0FTVF9FVkVOVCAmJiAhKG1zZy5wYXlsb2FkIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpICYmIHR5cGVvZiBtc2cucGF5bG9hZC5ldmVudCA9PT0gInN0cmluZyIpIHsKICAgICAgcmV0dXJuIGNhbGxiYWNrKHRoaXMuX2JpbmFyeUVuY29kZVVzZXJCcm9hZGNhc3RQdXNoKG1zZykpOwogICAgfQogICAgbGV0IHBheWxvYWQgPSBbbXNnLmpvaW5fcmVmLCBtc2cucmVmLCBtc2cudG9waWMsIG1zZy5ldmVudCwgbXNnLnBheWxvYWRdOwogICAgcmV0dXJuIGNhbGxiYWNrKEpTT04uc3RyaW5naWZ5KHBheWxvYWQpKTsKICB9CiAgX2JpbmFyeUVuY29kZVVzZXJCcm9hZGNhc3RQdXNoKG1lc3NhZ2UpIHsKICAgIHZhciBfYTsKICAgIGlmICh0aGlzLl9pc0FycmF5QnVmZmVyKChfYSA9IG1lc3NhZ2UucGF5bG9hZCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnBheWxvYWQpKSB7CiAgICAgIHJldHVybiB0aGlzLl9lbmNvZGVCaW5hcnlVc2VyQnJvYWRjYXN0UHVzaChtZXNzYWdlKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLl9lbmNvZGVKc29uVXNlckJyb2FkY2FzdFB1c2gobWVzc2FnZSk7CiAgICB9CiAgfQogIF9lbmNvZGVCaW5hcnlVc2VyQnJvYWRjYXN0UHVzaChtZXNzYWdlKSB7CiAgICB2YXIgX2EsIF9iOwogICAgY29uc3QgdXNlclBheWxvYWQgPSAoX2IgPSAoX2EgPSBtZXNzYWdlLnBheWxvYWQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wYXlsb2FkKSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiBuZXcgQXJyYXlCdWZmZXIoMCk7CiAgICByZXR1cm4gdGhpcy5fZW5jb2RlVXNlckJyb2FkY2FzdFB1c2gobWVzc2FnZSwgdGhpcy5CSU5BUllfRU5DT0RJTkcsIHVzZXJQYXlsb2FkKTsKICB9CiAgX2VuY29kZUpzb25Vc2VyQnJvYWRjYXN0UHVzaChtZXNzYWdlKSB7CiAgICB2YXIgX2EsIF9iOwogICAgY29uc3QgdXNlclBheWxvYWQgPSAoX2IgPSAoX2EgPSBtZXNzYWdlLnBheWxvYWQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wYXlsb2FkKSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiB7fTsKICAgIGNvbnN0IGVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTsKICAgIGNvbnN0IGVuY29kZWRVc2VyUGF5bG9hZCA9IGVuY29kZXIuZW5jb2RlKEpTT04uc3RyaW5naWZ5KHVzZXJQYXlsb2FkKSkuYnVmZmVyOwogICAgcmV0dXJuIHRoaXMuX2VuY29kZVVzZXJCcm9hZGNhc3RQdXNoKG1lc3NhZ2UsIHRoaXMuSlNPTl9FTkNPRElORywgZW5jb2RlZFVzZXJQYXlsb2FkKTsKICB9CiAgX2VuY29kZVVzZXJCcm9hZGNhc3RQdXNoKG1lc3NhZ2UsIGVuY29kaW5nVHlwZSwgZW5jb2RlZFBheWxvYWQpIHsKICAgIHZhciBfYSwgX2I7CiAgICBjb25zdCB0b3BpYyA9IG1lc3NhZ2UudG9waWM7CiAgICBjb25zdCByZWYgPSAoX2EgPSBtZXNzYWdlLnJlZikgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogIiI7CiAgICBjb25zdCBqb2luUmVmID0gKF9iID0gbWVzc2FnZS5qb2luX3JlZikgIT09IG51bGwgJiYgX2IgIT09IHZvaWQgMCA/IF9iIDogIiI7CiAgICBjb25zdCB1c2VyRXZlbnQgPSBtZXNzYWdlLnBheWxvYWQuZXZlbnQ7CiAgICBjb25zdCByZXN0ID0gdGhpcy5hbGxvd2VkTWV0YWRhdGFLZXlzID8gdGhpcy5fcGljayhtZXNzYWdlLnBheWxvYWQsIHRoaXMuYWxsb3dlZE1ldGFkYXRhS2V5cykgOiB7fTsKICAgIGNvbnN0IG1ldGFkYXRhID0gT2JqZWN0LmtleXMocmVzdCkubGVuZ3RoID09PSAwID8gIiIgOiBKU09OLnN0cmluZ2lmeShyZXN0KTsKICAgIGlmIChqb2luUmVmLmxlbmd0aCA+IDI1NSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYGpvaW5SZWYgbGVuZ3RoICR7am9pblJlZi5sZW5ndGh9IGV4Y2VlZHMgbWF4aW11bSBvZiAyNTVgKTsKICAgIH0KICAgIGlmIChyZWYubGVuZ3RoID4gMjU1KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgcmVmIGxlbmd0aCAke3JlZi5sZW5ndGh9IGV4Y2VlZHMgbWF4aW11bSBvZiAyNTVgKTsKICAgIH0KICAgIGlmICh0b3BpYy5sZW5ndGggPiAyNTUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGB0b3BpYyBsZW5ndGggJHt0b3BpYy5sZW5ndGh9IGV4Y2VlZHMgbWF4aW11bSBvZiAyNTVgKTsKICAgIH0KICAgIGlmICh1c2VyRXZlbnQubGVuZ3RoID4gMjU1KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgdXNlckV2ZW50IGxlbmd0aCAke3VzZXJFdmVudC5sZW5ndGh9IGV4Y2VlZHMgbWF4aW11bSBvZiAyNTVgKTsKICAgIH0KICAgIGlmIChtZXRhZGF0YS5sZW5ndGggPiAyNTUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBtZXRhZGF0YSBsZW5ndGggJHttZXRhZGF0YS5sZW5ndGh9IGV4Y2VlZHMgbWF4aW11bSBvZiAyNTVgKTsKICAgIH0KICAgIGNvbnN0IG1ldGFMZW5ndGggPSB0aGlzLlVTRVJfQlJPQURDQVNUX1BVU0hfTUVUQV9MRU5HVEggKyBqb2luUmVmLmxlbmd0aCArIHJlZi5sZW5ndGggKyB0b3BpYy5sZW5ndGggKyB1c2VyRXZlbnQubGVuZ3RoICsgbWV0YWRhdGEubGVuZ3RoOwogICAgY29uc3QgaGVhZGVyID0gbmV3IEFycmF5QnVmZmVyKHRoaXMuSEVBREVSX0xFTkdUSCArIG1ldGFMZW5ndGgpOwogICAgbGV0IHZpZXcgPSBuZXcgRGF0YVZpZXcoaGVhZGVyKTsKICAgIGxldCBvZmZzZXQgPSAwOwogICAgdmlldy5zZXRVaW50OChvZmZzZXQrKywgdGhpcy5LSU5EUy51c2VyQnJvYWRjYXN0UHVzaCk7CiAgICB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCBqb2luUmVmLmxlbmd0aCk7CiAgICB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCByZWYubGVuZ3RoKTsKICAgIHZpZXcuc2V0VWludDgob2Zmc2V0KyssIHRvcGljLmxlbmd0aCk7CiAgICB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCB1c2VyRXZlbnQubGVuZ3RoKTsKICAgIHZpZXcuc2V0VWludDgob2Zmc2V0KyssIG1ldGFkYXRhLmxlbmd0aCk7CiAgICB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCBlbmNvZGluZ1R5cGUpOwogICAgQXJyYXkuZnJvbShqb2luUmVmLCAoY2hhcikgPT4gdmlldy5zZXRVaW50OChvZmZzZXQrKywgY2hhci5jaGFyQ29kZUF0KDApKSk7CiAgICBBcnJheS5mcm9tKHJlZiwgKGNoYXIpID0+IHZpZXcuc2V0VWludDgob2Zmc2V0KyssIGNoYXIuY2hhckNvZGVBdCgwKSkpOwogICAgQXJyYXkuZnJvbSh0b3BpYywgKGNoYXIpID0+IHZpZXcuc2V0VWludDgob2Zmc2V0KyssIGNoYXIuY2hhckNvZGVBdCgwKSkpOwogICAgQXJyYXkuZnJvbSh1c2VyRXZlbnQsIChjaGFyKSA9PiB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCBjaGFyLmNoYXJDb2RlQXQoMCkpKTsKICAgIEFycmF5LmZyb20obWV0YWRhdGEsIChjaGFyKSA9PiB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCBjaGFyLmNoYXJDb2RlQXQoMCkpKTsKICAgIHZhciBjb21iaW5lZCA9IG5ldyBVaW50OEFycmF5KGhlYWRlci5ieXRlTGVuZ3RoICsgZW5jb2RlZFBheWxvYWQuYnl0ZUxlbmd0aCk7CiAgICBjb21iaW5lZC5zZXQobmV3IFVpbnQ4QXJyYXkoaGVhZGVyKSwgMCk7CiAgICBjb21iaW5lZC5zZXQobmV3IFVpbnQ4QXJyYXkoZW5jb2RlZFBheWxvYWQpLCBoZWFkZXIuYnl0ZUxlbmd0aCk7CiAgICByZXR1cm4gY29tYmluZWQuYnVmZmVyOwogIH0KICBkZWNvZGUocmF3UGF5bG9hZCwgY2FsbGJhY2spIHsKICAgIGlmICh0aGlzLl9pc0FycmF5QnVmZmVyKHJhd1BheWxvYWQpKSB7CiAgICAgIGxldCByZXN1bHQgPSB0aGlzLl9iaW5hcnlEZWNvZGUocmF3UGF5bG9hZCk7CiAgICAgIHJldHVybiBjYWxsYmFjayhyZXN1bHQpOwogICAgfQogICAgaWYgKHR5cGVvZiByYXdQYXlsb2FkID09PSAic3RyaW5nIikgewogICAgICBjb25zdCBqc29uUGF5bG9hZCA9IEpTT04ucGFyc2UocmF3UGF5bG9hZCk7CiAgICAgIGNvbnN0IFtqb2luX3JlZiwgcmVmLCB0b3BpYywgZXZlbnQsIHBheWxvYWRdID0ganNvblBheWxvYWQ7CiAgICAgIHJldHVybiBjYWxsYmFjayh7IGpvaW5fcmVmLCByZWYsIHRvcGljLCBldmVudCwgcGF5bG9hZCB9KTsKICAgIH0KICAgIHJldHVybiBjYWxsYmFjayh7fSk7CiAgfQogIF9iaW5hcnlEZWNvZGUoYnVmZmVyKSB7CiAgICBjb25zdCB2aWV3ID0gbmV3IERhdGFWaWV3KGJ1ZmZlcik7CiAgICBjb25zdCBraW5kID0gdmlldy5nZXRVaW50OCgwKTsKICAgIGNvbnN0IGRlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoKTsKICAgIHN3aXRjaCAoa2luZCkgewogICAgICBjYXNlIHRoaXMuS0lORFMudXNlckJyb2FkY2FzdDoKICAgICAgICByZXR1cm4gdGhpcy5fZGVjb2RlVXNlckJyb2FkY2FzdChidWZmZXIsIHZpZXcsIGRlY29kZXIpOwogICAgfQogIH0KICBfZGVjb2RlVXNlckJyb2FkY2FzdChidWZmZXIsIHZpZXcsIGRlY29kZXIpIHsKICAgIGNvbnN0IHRvcGljU2l6ZSA9IHZpZXcuZ2V0VWludDgoMSk7CiAgICBjb25zdCB1c2VyRXZlbnRTaXplID0gdmlldy5nZXRVaW50OCgyKTsKICAgIGNvbnN0IG1ldGFkYXRhU2l6ZSA9IHZpZXcuZ2V0VWludDgoMyk7CiAgICBjb25zdCBwYXlsb2FkRW5jb2RpbmcgPSB2aWV3LmdldFVpbnQ4KDQpOwogICAgbGV0IG9mZnNldCA9IHRoaXMuSEVBREVSX0xFTkdUSCArIDQ7CiAgICBjb25zdCB0b3BpYyA9IGRlY29kZXIuZGVjb2RlKGJ1ZmZlci5zbGljZShvZmZzZXQsIG9mZnNldCArIHRvcGljU2l6ZSkpOwogICAgb2Zmc2V0ID0gb2Zmc2V0ICsgdG9waWNTaXplOwogICAgY29uc3QgdXNlckV2ZW50ID0gZGVjb2Rlci5kZWNvZGUoYnVmZmVyLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgdXNlckV2ZW50U2l6ZSkpOwogICAgb2Zmc2V0ID0gb2Zmc2V0ICsgdXNlckV2ZW50U2l6ZTsKICAgIGNvbnN0IG1ldGFkYXRhID0gZGVjb2Rlci5kZWNvZGUoYnVmZmVyLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgbWV0YWRhdGFTaXplKSk7CiAgICBvZmZzZXQgPSBvZmZzZXQgKyBtZXRhZGF0YVNpemU7CiAgICBjb25zdCBwYXlsb2FkID0gYnVmZmVyLnNsaWNlKG9mZnNldCwgYnVmZmVyLmJ5dGVMZW5ndGgpOwogICAgY29uc3QgcGFyc2VkUGF5bG9hZCA9IHBheWxvYWRFbmNvZGluZyA9PT0gdGhpcy5KU09OX0VOQ09ESU5HID8gSlNPTi5wYXJzZShkZWNvZGVyLmRlY29kZShwYXlsb2FkKSkgOiBwYXlsb2FkOwogICAgY29uc3QgZGF0YSA9IHsKICAgICAgdHlwZTogdGhpcy5CUk9BRENBU1RfRVZFTlQsCiAgICAgIGV2ZW50OiB1c2VyRXZlbnQsCiAgICAgIHBheWxvYWQ6IHBhcnNlZFBheWxvYWQKICAgIH07CiAgICBpZiAobWV0YWRhdGFTaXplID4gMCkgewogICAgICBkYXRhWyJtZXRhIl0gPSBKU09OLnBhcnNlKG1ldGFkYXRhKTsKICAgIH0KICAgIHJldHVybiB7IGpvaW5fcmVmOiBudWxsLCByZWY6IG51bGwsIHRvcGljLCBldmVudDogdGhpcy5CUk9BRENBU1RfRVZFTlQsIHBheWxvYWQ6IGRhdGEgfTsKICB9CiAgX2lzQXJyYXlCdWZmZXIoYnVmZmVyKSB7CiAgICB2YXIgX2E7CiAgICByZXR1cm4gYnVmZmVyIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIgfHwgKChfYSA9IGJ1ZmZlciA9PT0gbnVsbCB8fCBidWZmZXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGJ1ZmZlci5jb25zdHJ1Y3RvcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLm5hbWUpID09PSAiQXJyYXlCdWZmZXIiOwogIH0KICBfcGljayhvYmosIGtleXMpIHsKICAgIGlmICghb2JqIHx8IHR5cGVvZiBvYmogIT09ICJvYmplY3QiKSB7CiAgICAgIHJldHVybiB7fTsKICAgIH0KICAgIHJldHVybiBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMob2JqKS5maWx0ZXIoKFtrZXldKSA9PiBrZXlzLmluY2x1ZGVzKGtleSkpKTsKICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK3JlYWx0aW1lLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL3JlYWx0aW1lLWpzL2Rpc3QvbW9kdWxlL2xpYi90aW1lci5qcwp2YXIgVGltZXIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY2FsbGJhY2ssIHRpbWVyQ2FsYykgewogICAgdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgdGhpcy50aW1lckNhbGMgPSB0aW1lckNhbGM7CiAgICB0aGlzLnRpbWVyID0gdm9pZCAwOwogICAgdGhpcy50cmllcyA9IDA7CiAgICB0aGlzLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICB0aGlzLnRpbWVyQ2FsYyA9IHRpbWVyQ2FsYzsKICB9CiAgcmVzZXQoKSB7CiAgICB0aGlzLnRyaWVzID0gMDsKICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKICAgIHRoaXMudGltZXIgPSB2b2lkIDA7CiAgfQogIC8vIENhbmNlbHMgYW55IHByZXZpb3VzIHNjaGVkdWxlVGltZW91dCBhbmQgc2NoZWR1bGVzIGNhbGxiYWNrCiAgc2NoZWR1bGVUaW1lb3V0KCkgewogICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZXIpOwogICAgdGhpcy50aW1lciA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICB0aGlzLnRyaWVzID0gdGhpcy50cmllcyArIDE7CiAgICAgIHRoaXMuY2FsbGJhY2soKTsKICAgIH0sIHRoaXMudGltZXJDYWxjKHRoaXMudHJpZXMgKyAxKSk7CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZStyZWFsdGltZS1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9yZWFsdGltZS1qcy9kaXN0L21vZHVsZS9saWIvdHJhbnNmb3JtZXJzLmpzCnZhciBQb3N0Z3Jlc1R5cGVzOwooZnVuY3Rpb24oUG9zdGdyZXNUeXBlczIpIHsKICBQb3N0Z3Jlc1R5cGVzMlsiYWJzdGltZSJdID0gImFic3RpbWUiOwogIFBvc3RncmVzVHlwZXMyWyJib29sIl0gPSAiYm9vbCI7CiAgUG9zdGdyZXNUeXBlczJbImRhdGUiXSA9ICJkYXRlIjsKICBQb3N0Z3Jlc1R5cGVzMlsiZGF0ZXJhbmdlIl0gPSAiZGF0ZXJhbmdlIjsKICBQb3N0Z3Jlc1R5cGVzMlsiZmxvYXQ0Il0gPSAiZmxvYXQ0IjsKICBQb3N0Z3Jlc1R5cGVzMlsiZmxvYXQ4Il0gPSAiZmxvYXQ4IjsKICBQb3N0Z3Jlc1R5cGVzMlsiaW50MiJdID0gImludDIiOwogIFBvc3RncmVzVHlwZXMyWyJpbnQ0Il0gPSAiaW50NCI7CiAgUG9zdGdyZXNUeXBlczJbImludDRyYW5nZSJdID0gImludDRyYW5nZSI7CiAgUG9zdGdyZXNUeXBlczJbImludDgiXSA9ICJpbnQ4IjsKICBQb3N0Z3Jlc1R5cGVzMlsiaW50OHJhbmdlIl0gPSAiaW50OHJhbmdlIjsKICBQb3N0Z3Jlc1R5cGVzMlsianNvbiJdID0gImpzb24iOwogIFBvc3RncmVzVHlwZXMyWyJqc29uYiJdID0gImpzb25iIjsKICBQb3N0Z3Jlc1R5cGVzMlsibW9uZXkiXSA9ICJtb25leSI7CiAgUG9zdGdyZXNUeXBlczJbIm51bWVyaWMiXSA9ICJudW1lcmljIjsKICBQb3N0Z3Jlc1R5cGVzMlsib2lkIl0gPSAib2lkIjsKICBQb3N0Z3Jlc1R5cGVzMlsicmVsdGltZSJdID0gInJlbHRpbWUiOwogIFBvc3RncmVzVHlwZXMyWyJ0ZXh0Il0gPSAidGV4dCI7CiAgUG9zdGdyZXNUeXBlczJbInRpbWUiXSA9ICJ0aW1lIjsKICBQb3N0Z3Jlc1R5cGVzMlsidGltZXN0YW1wIl0gPSAidGltZXN0YW1wIjsKICBQb3N0Z3Jlc1R5cGVzMlsidGltZXN0YW1wdHoiXSA9ICJ0aW1lc3RhbXB0eiI7CiAgUG9zdGdyZXNUeXBlczJbInRpbWV0eiJdID0gInRpbWV0eiI7CiAgUG9zdGdyZXNUeXBlczJbInRzcmFuZ2UiXSA9ICJ0c3JhbmdlIjsKICBQb3N0Z3Jlc1R5cGVzMlsidHN0enJhbmdlIl0gPSAidHN0enJhbmdlIjsKfSkoUG9zdGdyZXNUeXBlcyB8fCAoUG9zdGdyZXNUeXBlcyA9IHt9KSk7CnZhciBjb252ZXJ0Q2hhbmdlRGF0YSA9IChjb2x1bW5zLCByZWNvcmQsIG9wdGlvbnMgPSB7fSkgPT4gewogIHZhciBfYTsKICBjb25zdCBza2lwVHlwZXMgPSAoX2EgPSBvcHRpb25zLnNraXBUeXBlcykgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogW107CiAgaWYgKCFyZWNvcmQpIHsKICAgIHJldHVybiB7fTsKICB9CiAgcmV0dXJuIE9iamVjdC5rZXlzKHJlY29yZCkucmVkdWNlKChhY2MsIHJlY19rZXkpID0+IHsKICAgIGFjY1tyZWNfa2V5XSA9IGNvbnZlcnRDb2x1bW4ocmVjX2tleSwgY29sdW1ucywgcmVjb3JkLCBza2lwVHlwZXMpOwogICAgcmV0dXJuIGFjYzsKICB9LCB7fSk7Cn07CnZhciBjb252ZXJ0Q29sdW1uID0gKGNvbHVtbk5hbWUsIGNvbHVtbnMsIHJlY29yZCwgc2tpcFR5cGVzKSA9PiB7CiAgY29uc3QgY29sdW1uID0gY29sdW1ucy5maW5kKCh4MikgPT4geDIubmFtZSA9PT0gY29sdW1uTmFtZSk7CiAgY29uc3QgY29sVHlwZSA9IGNvbHVtbiA9PT0gbnVsbCB8fCBjb2x1bW4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNvbHVtbi50eXBlOwogIGNvbnN0IHZhbHVlID0gcmVjb3JkW2NvbHVtbk5hbWVdOwogIGlmIChjb2xUeXBlICYmICFza2lwVHlwZXMuaW5jbHVkZXMoY29sVHlwZSkpIHsKICAgIHJldHVybiBjb252ZXJ0Q2VsbChjb2xUeXBlLCB2YWx1ZSk7CiAgfQogIHJldHVybiBub29wNCh2YWx1ZSk7Cn07CnZhciBjb252ZXJ0Q2VsbCA9ICh0eXBlLCB2YWx1ZSkgPT4gewogIGlmICh0eXBlLmNoYXJBdCgwKSA9PT0gIl8iKSB7CiAgICBjb25zdCBkYXRhVHlwZSA9IHR5cGUuc2xpY2UoMSwgdHlwZS5sZW5ndGgpOwogICAgcmV0dXJuIHRvQXJyYXkodmFsdWUsIGRhdGFUeXBlKTsKICB9CiAgc3dpdGNoICh0eXBlKSB7CiAgICBjYXNlIFBvc3RncmVzVHlwZXMuYm9vbDoKICAgICAgcmV0dXJuIHRvQm9vbGVhbih2YWx1ZSk7CiAgICBjYXNlIFBvc3RncmVzVHlwZXMuZmxvYXQ0OgogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLmZsb2F0ODoKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy5pbnQyOgogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLmludDQ6CiAgICBjYXNlIFBvc3RncmVzVHlwZXMuaW50ODoKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy5udW1lcmljOgogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLm9pZDoKICAgICAgcmV0dXJuIHRvTnVtYmVyKHZhbHVlKTsKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy5qc29uOgogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLmpzb25iOgogICAgICByZXR1cm4gdG9Kc29uKHZhbHVlKTsKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy50aW1lc3RhbXA6CiAgICAgIHJldHVybiB0b1RpbWVzdGFtcFN0cmluZyh2YWx1ZSk7CiAgICBjYXNlIFBvc3RncmVzVHlwZXMuYWJzdGltZToKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy5kYXRlOgogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLmRhdGVyYW5nZToKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy5pbnQ0cmFuZ2U6CiAgICBjYXNlIFBvc3RncmVzVHlwZXMuaW50OHJhbmdlOgogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLm1vbmV5OgogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLnJlbHRpbWU6CiAgICBjYXNlIFBvc3RncmVzVHlwZXMudGV4dDoKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy50aW1lOgogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLnRpbWVzdGFtcHR6OgogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLnRpbWV0ejoKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy50c3JhbmdlOgogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLnRzdHpyYW5nZToKICAgICAgcmV0dXJuIG5vb3A0KHZhbHVlKTsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiBub29wNCh2YWx1ZSk7CiAgfQp9Owp2YXIgbm9vcDQgPSAodmFsdWUpID0+IHsKICByZXR1cm4gdmFsdWU7Cn07CnZhciB0b0Jvb2xlYW4gPSAodmFsdWUpID0+IHsKICBzd2l0Y2ggKHZhbHVlKSB7CiAgICBjYXNlICJ0IjoKICAgICAgcmV0dXJuIHRydWU7CiAgICBjYXNlICJmIjoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIHZhbHVlOwogIH0KfTsKdmFyIHRvTnVtYmVyID0gKHZhbHVlKSA9PiB7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpIHsKICAgIGNvbnN0IHBhcnNlZFZhbHVlID0gcGFyc2VGbG9hdCh2YWx1ZSk7CiAgICBpZiAoIU51bWJlci5pc05hTihwYXJzZWRWYWx1ZSkpIHsKICAgICAgcmV0dXJuIHBhcnNlZFZhbHVlOwogICAgfQogIH0KICByZXR1cm4gdmFsdWU7Cn07CnZhciB0b0pzb24gPSAodmFsdWUpID0+IHsKICBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIEpTT04ucGFyc2UodmFsdWUpOwogICAgfSBjYXRjaCAoX2EpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogIH0KICByZXR1cm4gdmFsdWU7Cn07CnZhciB0b0FycmF5ID0gKHZhbHVlLCB0eXBlKSA9PiB7CiAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgY29uc3QgbGFzdElkeCA9IHZhbHVlLmxlbmd0aCAtIDE7CiAgY29uc3QgY2xvc2VCcmFjZSA9IHZhbHVlW2xhc3RJZHhdOwogIGNvbnN0IG9wZW5CcmFjZSA9IHZhbHVlWzBdOwogIGlmIChvcGVuQnJhY2UgPT09ICJ7IiAmJiBjbG9zZUJyYWNlID09PSAifSIpIHsKICAgIGxldCBhcnI7CiAgICBjb25zdCB2YWxUcmltID0gdmFsdWUuc2xpY2UoMSwgbGFzdElkeCk7CiAgICB0cnkgewogICAgICBhcnIgPSBKU09OLnBhcnNlKCJbIiArIHZhbFRyaW0gKyAiXSIpOwogICAgfSBjYXRjaCAoXykgewogICAgICBhcnIgPSB2YWxUcmltID8gdmFsVHJpbS5zcGxpdCgiLCIpIDogW107CiAgICB9CiAgICByZXR1cm4gYXJyLm1hcCgodmFsKSA9PiBjb252ZXJ0Q2VsbCh0eXBlLCB2YWwpKTsKICB9CiAgcmV0dXJuIHZhbHVlOwp9Owp2YXIgdG9UaW1lc3RhbXBTdHJpbmcgPSAodmFsdWUpID0+IHsKICBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewogICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoIiAiLCAiVCIpOwogIH0KICByZXR1cm4gdmFsdWU7Cn07CnZhciBodHRwRW5kcG9pbnRVUkwgPSAoc29ja2V0VXJsKSA9PiB7CiAgY29uc3Qgd3NVcmwgPSBuZXcgVVJMKHNvY2tldFVybCk7CiAgd3NVcmwucHJvdG9jb2wgPSB3c1VybC5wcm90b2NvbC5yZXBsYWNlKC9ed3MvaSwgImh0dHAiKTsKICB3c1VybC5wYXRobmFtZSA9IHdzVXJsLnBhdGhuYW1lLnJlcGxhY2UoL1wvKyQvLCAiIikucmVwbGFjZSgvXC9zb2NrZXRcL3dlYnNvY2tldCQvaSwgIiIpLnJlcGxhY2UoL1wvc29ja2V0JC9pLCAiIikucmVwbGFjZSgvXC93ZWJzb2NrZXQkL2ksICIiKTsKICBpZiAod3NVcmwucGF0aG5hbWUgPT09ICIiIHx8IHdzVXJsLnBhdGhuYW1lID09PSAiLyIpIHsKICAgIHdzVXJsLnBhdGhuYW1lID0gIi9hcGkvYnJvYWRjYXN0IjsKICB9IGVsc2UgewogICAgd3NVcmwucGF0aG5hbWUgPSB3c1VybC5wYXRobmFtZSArICIvYXBpL2Jyb2FkY2FzdCI7CiAgfQogIHJldHVybiB3c1VybC5ocmVmOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZStyZWFsdGltZS1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9yZWFsdGltZS1qcy9kaXN0L21vZHVsZS9saWIvcHVzaC5qcwp2YXIgUHVzaCA9IGNsYXNzIHsKICAvKioKICAgKiBJbml0aWFsaXplcyB0aGUgUHVzaAogICAqCiAgICogQHBhcmFtIGNoYW5uZWwgVGhlIENoYW5uZWwKICAgKiBAcGFyYW0gZXZlbnQgVGhlIGV2ZW50LCBmb3IgZXhhbXBsZSBgInBoeF9qb2luImAKICAgKiBAcGFyYW0gcGF5bG9hZCBUaGUgcGF5bG9hZCwgZm9yIGV4YW1wbGUgYHt1c2VyX2lkOiAxMjN9YAogICAqIEBwYXJhbSB0aW1lb3V0IFRoZSBwdXNoIHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzCiAgICovCiAgY29uc3RydWN0b3IoY2hhbm5lbCwgZXZlbnQsIHBheWxvYWQgPSB7fSwgdGltZW91dCA9IERFRkFVTFRfVElNRU9VVCkgewogICAgdGhpcy5jaGFubmVsID0gY2hhbm5lbDsKICAgIHRoaXMuZXZlbnQgPSBldmVudDsKICAgIHRoaXMucGF5bG9hZCA9IHBheWxvYWQ7CiAgICB0aGlzLnRpbWVvdXQgPSB0aW1lb3V0OwogICAgdGhpcy5zZW50ID0gZmFsc2U7CiAgICB0aGlzLnRpbWVvdXRUaW1lciA9IHZvaWQgMDsKICAgIHRoaXMucmVmID0gIiI7CiAgICB0aGlzLnJlY2VpdmVkUmVzcCA9IG51bGw7CiAgICB0aGlzLnJlY0hvb2tzID0gW107CiAgICB0aGlzLnJlZkV2ZW50ID0gbnVsbDsKICB9CiAgcmVzZW5kKHRpbWVvdXQpIHsKICAgIHRoaXMudGltZW91dCA9IHRpbWVvdXQ7CiAgICB0aGlzLl9jYW5jZWxSZWZFdmVudCgpOwogICAgdGhpcy5yZWYgPSAiIjsKICAgIHRoaXMucmVmRXZlbnQgPSBudWxsOwogICAgdGhpcy5yZWNlaXZlZFJlc3AgPSBudWxsOwogICAgdGhpcy5zZW50ID0gZmFsc2U7CiAgICB0aGlzLnNlbmQoKTsKICB9CiAgc2VuZCgpIHsKICAgIGlmICh0aGlzLl9oYXNSZWNlaXZlZCgidGltZW91dCIpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuc3RhcnRUaW1lb3V0KCk7CiAgICB0aGlzLnNlbnQgPSB0cnVlOwogICAgdGhpcy5jaGFubmVsLnNvY2tldC5wdXNoKHsKICAgICAgdG9waWM6IHRoaXMuY2hhbm5lbC50b3BpYywKICAgICAgZXZlbnQ6IHRoaXMuZXZlbnQsCiAgICAgIHBheWxvYWQ6IHRoaXMucGF5bG9hZCwKICAgICAgcmVmOiB0aGlzLnJlZiwKICAgICAgam9pbl9yZWY6IHRoaXMuY2hhbm5lbC5fam9pblJlZigpCiAgICB9KTsKICB9CiAgdXBkYXRlUGF5bG9hZChwYXlsb2FkKSB7CiAgICB0aGlzLnBheWxvYWQgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHRoaXMucGF5bG9hZCksIHBheWxvYWQpOwogIH0KICByZWNlaXZlKHN0YXR1cywgY2FsbGJhY2spIHsKICAgIHZhciBfYTsKICAgIGlmICh0aGlzLl9oYXNSZWNlaXZlZChzdGF0dXMpKSB7CiAgICAgIGNhbGxiYWNrKChfYSA9IHRoaXMucmVjZWl2ZWRSZXNwKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucmVzcG9uc2UpOwogICAgfQogICAgdGhpcy5yZWNIb29rcy5wdXNoKHsgc3RhdHVzLCBjYWxsYmFjayB9KTsKICAgIHJldHVybiB0aGlzOwogIH0KICBzdGFydFRpbWVvdXQoKSB7CiAgICBpZiAodGhpcy50aW1lb3V0VGltZXIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5yZWYgPSB0aGlzLmNoYW5uZWwuc29ja2V0Ll9tYWtlUmVmKCk7CiAgICB0aGlzLnJlZkV2ZW50ID0gdGhpcy5jaGFubmVsLl9yZXBseUV2ZW50TmFtZSh0aGlzLnJlZik7CiAgICBjb25zdCBjYWxsYmFjayA9IChwYXlsb2FkKSA9PiB7CiAgICAgIHRoaXMuX2NhbmNlbFJlZkV2ZW50KCk7CiAgICAgIHRoaXMuX2NhbmNlbFRpbWVvdXQoKTsKICAgICAgdGhpcy5yZWNlaXZlZFJlc3AgPSBwYXlsb2FkOwogICAgICB0aGlzLl9tYXRjaFJlY2VpdmUocGF5bG9hZCk7CiAgICB9OwogICAgdGhpcy5jaGFubmVsLl9vbih0aGlzLnJlZkV2ZW50LCB7fSwgY2FsbGJhY2spOwogICAgdGhpcy50aW1lb3V0VGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgdGhpcy50cmlnZ2VyKCJ0aW1lb3V0Iiwge30pOwogICAgfSwgdGhpcy50aW1lb3V0KTsKICB9CiAgdHJpZ2dlcihzdGF0dXMsIHJlc3BvbnNlKSB7CiAgICBpZiAodGhpcy5yZWZFdmVudCkKICAgICAgdGhpcy5jaGFubmVsLl90cmlnZ2VyKHRoaXMucmVmRXZlbnQsIHsgc3RhdHVzLCByZXNwb25zZSB9KTsKICB9CiAgZGVzdHJveSgpIHsKICAgIHRoaXMuX2NhbmNlbFJlZkV2ZW50KCk7CiAgICB0aGlzLl9jYW5jZWxUaW1lb3V0KCk7CiAgfQogIF9jYW5jZWxSZWZFdmVudCgpIHsKICAgIGlmICghdGhpcy5yZWZFdmVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLmNoYW5uZWwuX29mZih0aGlzLnJlZkV2ZW50LCB7fSk7CiAgfQogIF9jYW5jZWxUaW1lb3V0KCkgewogICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dFRpbWVyKTsKICAgIHRoaXMudGltZW91dFRpbWVyID0gdm9pZCAwOwogIH0KICBfbWF0Y2hSZWNlaXZlKHsgc3RhdHVzLCByZXNwb25zZSB9KSB7CiAgICB0aGlzLnJlY0hvb2tzLmZpbHRlcigoaCkgPT4gaC5zdGF0dXMgPT09IHN0YXR1cykuZm9yRWFjaCgoaCkgPT4gaC5jYWxsYmFjayhyZXNwb25zZSkpOwogIH0KICBfaGFzUmVjZWl2ZWQoc3RhdHVzKSB7CiAgICByZXR1cm4gdGhpcy5yZWNlaXZlZFJlc3AgJiYgdGhpcy5yZWNlaXZlZFJlc3Auc3RhdHVzID09PSBzdGF0dXM7CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZStyZWFsdGltZS1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9yZWFsdGltZS1qcy9kaXN0L21vZHVsZS9SZWFsdGltZVByZXNlbmNlLmpzCnZhciBSRUFMVElNRV9QUkVTRU5DRV9MSVNURU5fRVZFTlRTOwooZnVuY3Rpb24oUkVBTFRJTUVfUFJFU0VOQ0VfTElTVEVOX0VWRU5UUzIpIHsKICBSRUFMVElNRV9QUkVTRU5DRV9MSVNURU5fRVZFTlRTMlsiU1lOQyJdID0gInN5bmMiOwogIFJFQUxUSU1FX1BSRVNFTkNFX0xJU1RFTl9FVkVOVFMyWyJKT0lOIl0gPSAiam9pbiI7CiAgUkVBTFRJTUVfUFJFU0VOQ0VfTElTVEVOX0VWRU5UUzJbIkxFQVZFIl0gPSAibGVhdmUiOwp9KShSRUFMVElNRV9QUkVTRU5DRV9MSVNURU5fRVZFTlRTIHx8IChSRUFMVElNRV9QUkVTRU5DRV9MSVNURU5fRVZFTlRTID0ge30pKTsKdmFyIFJlYWx0aW1lUHJlc2VuY2UgPSBjbGFzcyBfUmVhbHRpbWVQcmVzZW5jZSB7CiAgLyoqCiAgICogQ3JlYXRlcyBhIFByZXNlbmNlIGhlbHBlciB0aGF0IGtlZXBzIHRoZSBsb2NhbCBwcmVzZW5jZSBzdGF0ZSBpbiBzeW5jIHdpdGggdGhlIHNlcnZlci4KICAgKgogICAqIEBwYXJhbSBjaGFubmVsIC0gVGhlIHJlYWx0aW1lIGNoYW5uZWwgdG8gYmluZCB0by4KICAgKiBAcGFyYW0gb3B0cyAtIE9wdGlvbmFsIGN1c3RvbSBldmVudCBuYW1lcywgZS5nLiBgeyBldmVudHM6IHsgc3RhdGU6ICdzdGF0ZScsIGRpZmY6ICdkaWZmJyB9IH1gLgogICAqCiAgICogQGV4YW1wbGUKICAgKiBgYGB0cwogICAqIGNvbnN0IHByZXNlbmNlID0gbmV3IFJlYWx0aW1lUHJlc2VuY2UoY2hhbm5lbCkKICAgKgogICAqIGNoYW5uZWwub24oJ3ByZXNlbmNlJywgKHsgZXZlbnQsIGtleSB9KSA9PiB7CiAgICogICBjb25zb2xlLmxvZyhgUHJlc2VuY2UgJHtldmVudH0gb24gJHtrZXl9YCkKICAgKiB9KQogICAqIGBgYAogICAqLwogIGNvbnN0cnVjdG9yKGNoYW5uZWwsIG9wdHMpIHsKICAgIHRoaXMuY2hhbm5lbCA9IGNoYW5uZWw7CiAgICB0aGlzLnN0YXRlID0ge307CiAgICB0aGlzLnBlbmRpbmdEaWZmcyA9IFtdOwogICAgdGhpcy5qb2luUmVmID0gbnVsbDsKICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwogICAgdGhpcy5jYWxsZXIgPSB7CiAgICAgIG9uSm9pbjogKCkgPT4gewogICAgICB9LAogICAgICBvbkxlYXZlOiAoKSA9PiB7CiAgICAgIH0sCiAgICAgIG9uU3luYzogKCkgPT4gewogICAgICB9CiAgICB9OwogICAgY29uc3QgZXZlbnRzID0gKG9wdHMgPT09IG51bGwgfHwgb3B0cyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0cy5ldmVudHMpIHx8IHsKICAgICAgc3RhdGU6ICJwcmVzZW5jZV9zdGF0ZSIsCiAgICAgIGRpZmY6ICJwcmVzZW5jZV9kaWZmIgogICAgfTsKICAgIHRoaXMuY2hhbm5lbC5fb24oZXZlbnRzLnN0YXRlLCB7fSwgKG5ld1N0YXRlKSA9PiB7CiAgICAgIGNvbnN0IHsgb25Kb2luLCBvbkxlYXZlLCBvblN5bmMgfSA9IHRoaXMuY2FsbGVyOwogICAgICB0aGlzLmpvaW5SZWYgPSB0aGlzLmNoYW5uZWwuX2pvaW5SZWYoKTsKICAgICAgdGhpcy5zdGF0ZSA9IF9SZWFsdGltZVByZXNlbmNlLnN5bmNTdGF0ZSh0aGlzLnN0YXRlLCBuZXdTdGF0ZSwgb25Kb2luLCBvbkxlYXZlKTsKICAgICAgdGhpcy5wZW5kaW5nRGlmZnMuZm9yRWFjaCgoZGlmZikgPT4gewogICAgICAgIHRoaXMuc3RhdGUgPSBfUmVhbHRpbWVQcmVzZW5jZS5zeW5jRGlmZih0aGlzLnN0YXRlLCBkaWZmLCBvbkpvaW4sIG9uTGVhdmUpOwogICAgICB9KTsKICAgICAgdGhpcy5wZW5kaW5nRGlmZnMgPSBbXTsKICAgICAgb25TeW5jKCk7CiAgICB9KTsKICAgIHRoaXMuY2hhbm5lbC5fb24oZXZlbnRzLmRpZmYsIHt9LCAoZGlmZikgPT4gewogICAgICBjb25zdCB7IG9uSm9pbiwgb25MZWF2ZSwgb25TeW5jIH0gPSB0aGlzLmNhbGxlcjsKICAgICAgaWYgKHRoaXMuaW5QZW5kaW5nU3luY1N0YXRlKCkpIHsKICAgICAgICB0aGlzLnBlbmRpbmdEaWZmcy5wdXNoKGRpZmYpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuc3RhdGUgPSBfUmVhbHRpbWVQcmVzZW5jZS5zeW5jRGlmZih0aGlzLnN0YXRlLCBkaWZmLCBvbkpvaW4sIG9uTGVhdmUpOwogICAgICAgIG9uU3luYygpOwogICAgICB9CiAgICB9KTsKICAgIHRoaXMub25Kb2luKChrZXksIGN1cnJlbnRQcmVzZW5jZXMsIG5ld1ByZXNlbmNlcykgPT4gewogICAgICB0aGlzLmNoYW5uZWwuX3RyaWdnZXIoInByZXNlbmNlIiwgewogICAgICAgIGV2ZW50OiAiam9pbiIsCiAgICAgICAga2V5LAogICAgICAgIGN1cnJlbnRQcmVzZW5jZXMsCiAgICAgICAgbmV3UHJlc2VuY2VzCiAgICAgIH0pOwogICAgfSk7CiAgICB0aGlzLm9uTGVhdmUoKGtleSwgY3VycmVudFByZXNlbmNlcywgbGVmdFByZXNlbmNlcykgPT4gewogICAgICB0aGlzLmNoYW5uZWwuX3RyaWdnZXIoInByZXNlbmNlIiwgewogICAgICAgIGV2ZW50OiAibGVhdmUiLAogICAgICAgIGtleSwKICAgICAgICBjdXJyZW50UHJlc2VuY2VzLAogICAgICAgIGxlZnRQcmVzZW5jZXMKICAgICAgfSk7CiAgICB9KTsKICAgIHRoaXMub25TeW5jKCgpID0+IHsKICAgICAgdGhpcy5jaGFubmVsLl90cmlnZ2VyKCJwcmVzZW5jZSIsIHsgZXZlbnQ6ICJzeW5jIiB9KTsKICAgIH0pOwogIH0KICAvKioKICAgKiBVc2VkIHRvIHN5bmMgdGhlIGxpc3Qgb2YgcHJlc2VuY2VzIG9uIHRoZSBzZXJ2ZXIgd2l0aCB0aGUKICAgKiBjbGllbnQncyBzdGF0ZS4KICAgKgogICAqIEFuIG9wdGlvbmFsIGBvbkpvaW5gIGFuZCBgb25MZWF2ZWAgY2FsbGJhY2sgY2FuIGJlIHByb3ZpZGVkIHRvCiAgICogcmVhY3QgdG8gY2hhbmdlcyBpbiB0aGUgY2xpZW50J3MgbG9jYWwgcHJlc2VuY2VzIGFjcm9zcwogICAqIGRpc2Nvbm5lY3RzIGFuZCByZWNvbm5lY3RzIHdpdGggdGhlIHNlcnZlci4KICAgKgogICAqIEBpbnRlcm5hbAogICAqLwogIHN0YXRpYyBzeW5jU3RhdGUoY3VycmVudFN0YXRlLCBuZXdTdGF0ZSwgb25Kb2luLCBvbkxlYXZlKSB7CiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuY2xvbmVEZWVwKGN1cnJlbnRTdGF0ZSk7CiAgICBjb25zdCB0cmFuc2Zvcm1lZFN0YXRlID0gdGhpcy50cmFuc2Zvcm1TdGF0ZShuZXdTdGF0ZSk7CiAgICBjb25zdCBqb2lucyA9IHt9OwogICAgY29uc3QgbGVhdmVzID0ge307CiAgICB0aGlzLm1hcChzdGF0ZSwgKGtleSwgcHJlc2VuY2VzKSA9PiB7CiAgICAgIGlmICghdHJhbnNmb3JtZWRTdGF0ZVtrZXldKSB7CiAgICAgICAgbGVhdmVzW2tleV0gPSBwcmVzZW5jZXM7CiAgICAgIH0KICAgIH0pOwogICAgdGhpcy5tYXAodHJhbnNmb3JtZWRTdGF0ZSwgKGtleSwgbmV3UHJlc2VuY2VzKSA9PiB7CiAgICAgIGNvbnN0IGN1cnJlbnRQcmVzZW5jZXMgPSBzdGF0ZVtrZXldOwogICAgICBpZiAoY3VycmVudFByZXNlbmNlcykgewogICAgICAgIGNvbnN0IG5ld1ByZXNlbmNlUmVmcyA9IG5ld1ByZXNlbmNlcy5tYXAoKG0pID0+IG0ucHJlc2VuY2VfcmVmKTsKICAgICAgICBjb25zdCBjdXJQcmVzZW5jZVJlZnMgPSBjdXJyZW50UHJlc2VuY2VzLm1hcCgobSkgPT4gbS5wcmVzZW5jZV9yZWYpOwogICAgICAgIGNvbnN0IGpvaW5lZFByZXNlbmNlcyA9IG5ld1ByZXNlbmNlcy5maWx0ZXIoKG0pID0+IGN1clByZXNlbmNlUmVmcy5pbmRleE9mKG0ucHJlc2VuY2VfcmVmKSA8IDApOwogICAgICAgIGNvbnN0IGxlZnRQcmVzZW5jZXMgPSBjdXJyZW50UHJlc2VuY2VzLmZpbHRlcigobSkgPT4gbmV3UHJlc2VuY2VSZWZzLmluZGV4T2YobS5wcmVzZW5jZV9yZWYpIDwgMCk7CiAgICAgICAgaWYgKGpvaW5lZFByZXNlbmNlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICBqb2luc1trZXldID0gam9pbmVkUHJlc2VuY2VzOwogICAgICAgIH0KICAgICAgICBpZiAobGVmdFByZXNlbmNlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICBsZWF2ZXNba2V5XSA9IGxlZnRQcmVzZW5jZXM7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGpvaW5zW2tleV0gPSBuZXdQcmVzZW5jZXM7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHRoaXMuc3luY0RpZmYoc3RhdGUsIHsgam9pbnMsIGxlYXZlcyB9LCBvbkpvaW4sIG9uTGVhdmUpOwogIH0KICAvKioKICAgKiBVc2VkIHRvIHN5bmMgYSBkaWZmIG9mIHByZXNlbmNlIGpvaW4gYW5kIGxlYXZlIGV2ZW50cyBmcm9tIHRoZQogICAqIHNlcnZlciwgYXMgdGhleSBoYXBwZW4uCiAgICoKICAgKiBMaWtlIGBzeW5jU3RhdGVgLCBgc3luY0RpZmZgIGFjY2VwdHMgb3B0aW9uYWwgYG9uSm9pbmAgYW5kCiAgICogYG9uTGVhdmVgIGNhbGxiYWNrcyB0byByZWFjdCB0byBhIHVzZXIgam9pbmluZyBvciBsZWF2aW5nIGZyb20gYQogICAqIGRldmljZS4KICAgKgogICAqIEBpbnRlcm5hbAogICAqLwogIHN0YXRpYyBzeW5jRGlmZihzdGF0ZSwgZGlmZiwgb25Kb2luLCBvbkxlYXZlKSB7CiAgICBjb25zdCB7IGpvaW5zLCBsZWF2ZXMgfSA9IHsKICAgICAgam9pbnM6IHRoaXMudHJhbnNmb3JtU3RhdGUoZGlmZi5qb2lucyksCiAgICAgIGxlYXZlczogdGhpcy50cmFuc2Zvcm1TdGF0ZShkaWZmLmxlYXZlcykKICAgIH07CiAgICBpZiAoIW9uSm9pbikgewogICAgICBvbkpvaW4gPSAoKSA9PiB7CiAgICAgIH07CiAgICB9CiAgICBpZiAoIW9uTGVhdmUpIHsKICAgICAgb25MZWF2ZSA9ICgpID0+IHsKICAgICAgfTsKICAgIH0KICAgIHRoaXMubWFwKGpvaW5zLCAoa2V5LCBuZXdQcmVzZW5jZXMpID0+IHsKICAgICAgdmFyIF9hOwogICAgICBjb25zdCBjdXJyZW50UHJlc2VuY2VzID0gKF9hID0gc3RhdGVba2V5XSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogW107CiAgICAgIHN0YXRlW2tleV0gPSB0aGlzLmNsb25lRGVlcChuZXdQcmVzZW5jZXMpOwogICAgICBpZiAoY3VycmVudFByZXNlbmNlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3Qgam9pbmVkUHJlc2VuY2VSZWZzID0gc3RhdGVba2V5XS5tYXAoKG0pID0+IG0ucHJlc2VuY2VfcmVmKTsKICAgICAgICBjb25zdCBjdXJQcmVzZW5jZXMgPSBjdXJyZW50UHJlc2VuY2VzLmZpbHRlcigobSkgPT4gam9pbmVkUHJlc2VuY2VSZWZzLmluZGV4T2YobS5wcmVzZW5jZV9yZWYpIDwgMCk7CiAgICAgICAgc3RhdGVba2V5XS51bnNoaWZ0KC4uLmN1clByZXNlbmNlcyk7CiAgICAgIH0KICAgICAgb25Kb2luKGtleSwgY3VycmVudFByZXNlbmNlcywgbmV3UHJlc2VuY2VzKTsKICAgIH0pOwogICAgdGhpcy5tYXAobGVhdmVzLCAoa2V5LCBsZWZ0UHJlc2VuY2VzKSA9PiB7CiAgICAgIGxldCBjdXJyZW50UHJlc2VuY2VzID0gc3RhdGVba2V5XTsKICAgICAgaWYgKCFjdXJyZW50UHJlc2VuY2VzKQogICAgICAgIHJldHVybjsKICAgICAgY29uc3QgcHJlc2VuY2VSZWZzVG9SZW1vdmUgPSBsZWZ0UHJlc2VuY2VzLm1hcCgobSkgPT4gbS5wcmVzZW5jZV9yZWYpOwogICAgICBjdXJyZW50UHJlc2VuY2VzID0gY3VycmVudFByZXNlbmNlcy5maWx0ZXIoKG0pID0+IHByZXNlbmNlUmVmc1RvUmVtb3ZlLmluZGV4T2YobS5wcmVzZW5jZV9yZWYpIDwgMCk7CiAgICAgIHN0YXRlW2tleV0gPSBjdXJyZW50UHJlc2VuY2VzOwogICAgICBvbkxlYXZlKGtleSwgY3VycmVudFByZXNlbmNlcywgbGVmdFByZXNlbmNlcyk7CiAgICAgIGlmIChjdXJyZW50UHJlc2VuY2VzLmxlbmd0aCA9PT0gMCkKICAgICAgICBkZWxldGUgc3RhdGVba2V5XTsKICAgIH0pOwogICAgcmV0dXJuIHN0YXRlOwogIH0KICAvKiogQGludGVybmFsICovCiAgc3RhdGljIG1hcChvYmosIGZ1bmMpIHsKICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhvYmopLm1hcCgoa2V5KSA9PiBmdW5jKGtleSwgb2JqW2tleV0pKTsKICB9CiAgLyoqCiAgICogUmVtb3ZlICdtZXRhcycga2V5CiAgICogQ2hhbmdlICdwaHhfcmVmJyB0byAncHJlc2VuY2VfcmVmJwogICAqIFJlbW92ZSAncGh4X3JlZicgYW5kICdwaHhfcmVmX3ByZXYnCiAgICoKICAgKiBAZXhhbXBsZQogICAqIC8vIHJldHVybnMgewogICAqICBhYmMxMjM6IFsKICAgKiAgICB7IHByZXNlbmNlX3JlZjogJzInLCB1c2VyX2lkOiAxIH0sCiAgICogICAgeyBwcmVzZW5jZV9yZWY6ICczJywgdXNlcl9pZDogMiB9CiAgICogIF0KICAgKiB9CiAgICogUmVhbHRpbWVQcmVzZW5jZS50cmFuc2Zvcm1TdGF0ZSh7CiAgICogIGFiYzEyMzogewogICAqICAgIG1ldGFzOiBbCiAgICogICAgICB7IHBoeF9yZWY6ICcyJywgcGh4X3JlZl9wcmV2OiAnMScgdXNlcl9pZDogMSB9LAogICAqICAgICAgeyBwaHhfcmVmOiAnMycsIHVzZXJfaWQ6IDIgfQogICAqICAgIF0KICAgKiAgfQogICAqIH0pCiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KICBzdGF0aWMgdHJhbnNmb3JtU3RhdGUoc3RhdGUpIHsKICAgIHN0YXRlID0gdGhpcy5jbG9uZURlZXAoc3RhdGUpOwogICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHN0YXRlKS5yZWR1Y2UoKG5ld1N0YXRlLCBrZXkpID0+IHsKICAgICAgY29uc3QgcHJlc2VuY2VzID0gc3RhdGVba2V5XTsKICAgICAgaWYgKCJtZXRhcyIgaW4gcHJlc2VuY2VzKSB7CiAgICAgICAgbmV3U3RhdGVba2V5XSA9IHByZXNlbmNlcy5tZXRhcy5tYXAoKHByZXNlbmNlKSA9PiB7CiAgICAgICAgICBwcmVzZW5jZVsicHJlc2VuY2VfcmVmIl0gPSBwcmVzZW5jZVsicGh4X3JlZiJdOwogICAgICAgICAgZGVsZXRlIHByZXNlbmNlWyJwaHhfcmVmIl07CiAgICAgICAgICBkZWxldGUgcHJlc2VuY2VbInBoeF9yZWZfcHJldiJdOwogICAgICAgICAgcmV0dXJuIHByZXNlbmNlOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIG5ld1N0YXRlW2tleV0gPSBwcmVzZW5jZXM7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ld1N0YXRlOwogICAgfSwge30pOwogIH0KICAvKiogQGludGVybmFsICovCiAgc3RhdGljIGNsb25lRGVlcChvYmopIHsKICAgIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG9iaikpOwogIH0KICAvKiogQGludGVybmFsICovCiAgb25Kb2luKGNhbGxiYWNrKSB7CiAgICB0aGlzLmNhbGxlci5vbkpvaW4gPSBjYWxsYmFjazsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIG9uTGVhdmUoY2FsbGJhY2spIHsKICAgIHRoaXMuY2FsbGVyLm9uTGVhdmUgPSBjYWxsYmFjazsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIG9uU3luYyhjYWxsYmFjaykgewogICAgdGhpcy5jYWxsZXIub25TeW5jID0gY2FsbGJhY2s7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBpblBlbmRpbmdTeW5jU3RhdGUoKSB7CiAgICByZXR1cm4gIXRoaXMuam9pblJlZiB8fCB0aGlzLmpvaW5SZWYgIT09IHRoaXMuY2hhbm5lbC5fam9pblJlZigpOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrcmVhbHRpbWUtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvcmVhbHRpbWUtanMvZGlzdC9tb2R1bGUvUmVhbHRpbWVDaGFubmVsLmpzCnZhciBSRUFMVElNRV9QT1NUR1JFU19DSEFOR0VTX0xJU1RFTl9FVkVOVDsKKGZ1bmN0aW9uKFJFQUxUSU1FX1BPU1RHUkVTX0NIQU5HRVNfTElTVEVOX0VWRU5UMikgewogIFJFQUxUSU1FX1BPU1RHUkVTX0NIQU5HRVNfTElTVEVOX0VWRU5UMlsiQUxMIl0gPSAiKiI7CiAgUkVBTFRJTUVfUE9TVEdSRVNfQ0hBTkdFU19MSVNURU5fRVZFTlQyWyJJTlNFUlQiXSA9ICJJTlNFUlQiOwogIFJFQUxUSU1FX1BPU1RHUkVTX0NIQU5HRVNfTElTVEVOX0VWRU5UMlsiVVBEQVRFIl0gPSAiVVBEQVRFIjsKICBSRUFMVElNRV9QT1NUR1JFU19DSEFOR0VTX0xJU1RFTl9FVkVOVDJbIkRFTEVURSJdID0gIkRFTEVURSI7Cn0pKFJFQUxUSU1FX1BPU1RHUkVTX0NIQU5HRVNfTElTVEVOX0VWRU5UIHx8IChSRUFMVElNRV9QT1NUR1JFU19DSEFOR0VTX0xJU1RFTl9FVkVOVCA9IHt9KSk7CnZhciBSRUFMVElNRV9MSVNURU5fVFlQRVM7CihmdW5jdGlvbihSRUFMVElNRV9MSVNURU5fVFlQRVMyKSB7CiAgUkVBTFRJTUVfTElTVEVOX1RZUEVTMlsiQlJPQURDQVNUIl0gPSAiYnJvYWRjYXN0IjsKICBSRUFMVElNRV9MSVNURU5fVFlQRVMyWyJQUkVTRU5DRSJdID0gInByZXNlbmNlIjsKICBSRUFMVElNRV9MSVNURU5fVFlQRVMyWyJQT1NUR1JFU19DSEFOR0VTIl0gPSAicG9zdGdyZXNfY2hhbmdlcyI7CiAgUkVBTFRJTUVfTElTVEVOX1RZUEVTMlsiU1lTVEVNIl0gPSAic3lzdGVtIjsKfSkoUkVBTFRJTUVfTElTVEVOX1RZUEVTIHx8IChSRUFMVElNRV9MSVNURU5fVFlQRVMgPSB7fSkpOwp2YXIgUkVBTFRJTUVfU1VCU0NSSUJFX1NUQVRFUzsKKGZ1bmN0aW9uKFJFQUxUSU1FX1NVQlNDUklCRV9TVEFURVMyKSB7CiAgUkVBTFRJTUVfU1VCU0NSSUJFX1NUQVRFUzJbIlNVQlNDUklCRUQiXSA9ICJTVUJTQ1JJQkVEIjsKICBSRUFMVElNRV9TVUJTQ1JJQkVfU1RBVEVTMlsiVElNRURfT1VUIl0gPSAiVElNRURfT1VUIjsKICBSRUFMVElNRV9TVUJTQ1JJQkVfU1RBVEVTMlsiQ0xPU0VEIl0gPSAiQ0xPU0VEIjsKICBSRUFMVElNRV9TVUJTQ1JJQkVfU1RBVEVTMlsiQ0hBTk5FTF9FUlJPUiJdID0gIkNIQU5ORUxfRVJST1IiOwp9KShSRUFMVElNRV9TVUJTQ1JJQkVfU1RBVEVTIHx8IChSRUFMVElNRV9TVUJTQ1JJQkVfU1RBVEVTID0ge30pKTsKdmFyIFJlYWx0aW1lQ2hhbm5lbCA9IGNsYXNzIF9SZWFsdGltZUNoYW5uZWwgewogIC8qKgogICAqIENyZWF0ZXMgYSBjaGFubmVsIHRoYXQgY2FuIGJyb2FkY2FzdCBtZXNzYWdlcywgc3luYyBwcmVzZW5jZSwgYW5kIGxpc3RlbiB0byBQb3N0Z3JlcyBjaGFuZ2VzLgogICAqCiAgICogVGhlIHRvcGljIGRldGVybWluZXMgd2hpY2ggcmVhbHRpbWUgc3RyZWFtIHlvdSBhcmUgc3Vic2NyaWJpbmcgdG8uIENvbmZpZyBvcHRpb25zIGxldCB5b3UKICAgKiBlbmFibGUgYWNrbm93bGVkZ2VtZW50IGZvciBicm9hZGNhc3RzLCBwcmVzZW5jZSB0cmFja2luZywgb3IgcHJpdmF0ZSBjaGFubmVscy4KICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHMKICAgKiBpbXBvcnQgUmVhbHRpbWVDbGllbnQgZnJvbSAnQHN1cGFiYXNlL3JlYWx0aW1lLWpzJwogICAqCiAgICogY29uc3QgY2xpZW50ID0gbmV3IFJlYWx0aW1lQ2xpZW50KCdodHRwczovL3h5emNvbXBhbnkuc3VwYWJhc2UuY28vcmVhbHRpbWUvdjEnLCB7CiAgICogICBwYXJhbXM6IHsgYXBpa2V5OiAncHVibGljLWFub24ta2V5JyB9LAogICAqIH0pCiAgICogY29uc3QgY2hhbm5lbCA9IG5ldyBSZWFsdGltZUNoYW5uZWwoJ3JlYWx0aW1lOnB1YmxpYzptZXNzYWdlcycsIHsgY29uZmlnOiB7fSB9LCBjbGllbnQpCiAgICogYGBgCiAgICovCiAgY29uc3RydWN0b3IodG9waWMsIHBhcmFtcyA9IHsgY29uZmlnOiB7fSB9LCBzb2NrZXQpIHsKICAgIHZhciBfYSwgX2I7CiAgICB0aGlzLnRvcGljID0gdG9waWM7CiAgICB0aGlzLnBhcmFtcyA9IHBhcmFtczsKICAgIHRoaXMuc29ja2V0ID0gc29ja2V0OwogICAgdGhpcy5iaW5kaW5ncyA9IHt9OwogICAgdGhpcy5zdGF0ZSA9IENIQU5ORUxfU1RBVEVTLmNsb3NlZDsKICAgIHRoaXMuam9pbmVkT25jZSA9IGZhbHNlOwogICAgdGhpcy5wdXNoQnVmZmVyID0gW107CiAgICB0aGlzLnN1YlRvcGljID0gdG9waWMucmVwbGFjZSgvXnJlYWx0aW1lOi9pLCAiIik7CiAgICB0aGlzLnBhcmFtcy5jb25maWcgPSBPYmplY3QuYXNzaWduKHsKICAgICAgYnJvYWRjYXN0OiB7IGFjazogZmFsc2UsIHNlbGY6IGZhbHNlIH0sCiAgICAgIHByZXNlbmNlOiB7IGtleTogIiIsIGVuYWJsZWQ6IGZhbHNlIH0sCiAgICAgIHByaXZhdGU6IGZhbHNlCiAgICB9LCBwYXJhbXMuY29uZmlnKTsKICAgIHRoaXMudGltZW91dCA9IHRoaXMuc29ja2V0LnRpbWVvdXQ7CiAgICB0aGlzLmpvaW5QdXNoID0gbmV3IFB1c2godGhpcywgQ0hBTk5FTF9FVkVOVFMuam9pbiwgdGhpcy5wYXJhbXMsIHRoaXMudGltZW91dCk7CiAgICB0aGlzLnJlam9pblRpbWVyID0gbmV3IFRpbWVyKCgpID0+IHRoaXMuX3Jlam9pblVudGlsQ29ubmVjdGVkKCksIHRoaXMuc29ja2V0LnJlY29ubmVjdEFmdGVyTXMpOwogICAgdGhpcy5qb2luUHVzaC5yZWNlaXZlKCJvayIsICgpID0+IHsKICAgICAgdGhpcy5zdGF0ZSA9IENIQU5ORUxfU1RBVEVTLmpvaW5lZDsKICAgICAgdGhpcy5yZWpvaW5UaW1lci5yZXNldCgpOwogICAgICB0aGlzLnB1c2hCdWZmZXIuZm9yRWFjaCgocHVzaEV2ZW50KSA9PiBwdXNoRXZlbnQuc2VuZCgpKTsKICAgICAgdGhpcy5wdXNoQnVmZmVyID0gW107CiAgICB9KTsKICAgIHRoaXMuX29uQ2xvc2UoKCkgPT4gewogICAgICB0aGlzLnJlam9pblRpbWVyLnJlc2V0KCk7CiAgICAgIHRoaXMuc29ja2V0LmxvZygiY2hhbm5lbCIsIGBjbG9zZSAke3RoaXMudG9waWN9ICR7dGhpcy5fam9pblJlZigpfWApOwogICAgICB0aGlzLnN0YXRlID0gQ0hBTk5FTF9TVEFURVMuY2xvc2VkOwogICAgICB0aGlzLnNvY2tldC5fcmVtb3ZlKHRoaXMpOwogICAgfSk7CiAgICB0aGlzLl9vbkVycm9yKChyZWFzb24pID0+IHsKICAgICAgaWYgKHRoaXMuX2lzTGVhdmluZygpIHx8IHRoaXMuX2lzQ2xvc2VkKCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdGhpcy5zb2NrZXQubG9nKCJjaGFubmVsIiwgYGVycm9yICR7dGhpcy50b3BpY31gLCByZWFzb24pOwogICAgICB0aGlzLnN0YXRlID0gQ0hBTk5FTF9TVEFURVMuZXJyb3JlZDsKICAgICAgdGhpcy5yZWpvaW5UaW1lci5zY2hlZHVsZVRpbWVvdXQoKTsKICAgIH0pOwogICAgdGhpcy5qb2luUHVzaC5yZWNlaXZlKCJ0aW1lb3V0IiwgKCkgPT4gewogICAgICBpZiAoIXRoaXMuX2lzSm9pbmluZygpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMuc29ja2V0LmxvZygiY2hhbm5lbCIsIGB0aW1lb3V0ICR7dGhpcy50b3BpY31gLCB0aGlzLmpvaW5QdXNoLnRpbWVvdXQpOwogICAgICB0aGlzLnN0YXRlID0gQ0hBTk5FTF9TVEFURVMuZXJyb3JlZDsKICAgICAgdGhpcy5yZWpvaW5UaW1lci5zY2hlZHVsZVRpbWVvdXQoKTsKICAgIH0pOwogICAgdGhpcy5qb2luUHVzaC5yZWNlaXZlKCJlcnJvciIsIChyZWFzb24pID0+IHsKICAgICAgaWYgKHRoaXMuX2lzTGVhdmluZygpIHx8IHRoaXMuX2lzQ2xvc2VkKCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdGhpcy5zb2NrZXQubG9nKCJjaGFubmVsIiwgYGVycm9yICR7dGhpcy50b3BpY31gLCByZWFzb24pOwogICAgICB0aGlzLnN0YXRlID0gQ0hBTk5FTF9TVEFURVMuZXJyb3JlZDsKICAgICAgdGhpcy5yZWpvaW5UaW1lci5zY2hlZHVsZVRpbWVvdXQoKTsKICAgIH0pOwogICAgdGhpcy5fb24oQ0hBTk5FTF9FVkVOVFMucmVwbHksIHt9LCAocGF5bG9hZCwgcmVmKSA9PiB7CiAgICAgIHRoaXMuX3RyaWdnZXIodGhpcy5fcmVwbHlFdmVudE5hbWUocmVmKSwgcGF5bG9hZCk7CiAgICB9KTsKICAgIHRoaXMucHJlc2VuY2UgPSBuZXcgUmVhbHRpbWVQcmVzZW5jZSh0aGlzKTsKICAgIHRoaXMuYnJvYWRjYXN0RW5kcG9pbnRVUkwgPSBodHRwRW5kcG9pbnRVUkwodGhpcy5zb2NrZXQuZW5kUG9pbnQpOwogICAgdGhpcy5wcml2YXRlID0gdGhpcy5wYXJhbXMuY29uZmlnLnByaXZhdGUgfHwgZmFsc2U7CiAgICBpZiAoIXRoaXMucHJpdmF0ZSAmJiAoKF9iID0gKF9hID0gdGhpcy5wYXJhbXMuY29uZmlnKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuYnJvYWRjYXN0KSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IucmVwbGF5KSkgewogICAgICB0aHJvdyBgdHJpZWQgdG8gdXNlIHJlcGxheSBvbiBwdWJsaWMgY2hhbm5lbCAnJHt0aGlzLnRvcGljfScuIEl0IG11c3QgYmUgYSBwcml2YXRlIGNoYW5uZWwuYDsKICAgIH0KICB9CiAgLyoqIFN1YnNjcmliZSByZWdpc3RlcnMgeW91ciBjbGllbnQgd2l0aCB0aGUgc2VydmVyICovCiAgc3Vic2NyaWJlKGNhbGxiYWNrLCB0aW1lb3V0ID0gdGhpcy50aW1lb3V0KSB7CiAgICB2YXIgX2EsIF9iLCBfYzsKICAgIGlmICghdGhpcy5zb2NrZXQuaXNDb25uZWN0ZWQoKSkgewogICAgICB0aGlzLnNvY2tldC5jb25uZWN0KCk7CiAgICB9CiAgICBpZiAodGhpcy5zdGF0ZSA9PSBDSEFOTkVMX1NUQVRFUy5jbG9zZWQpIHsKICAgICAgY29uc3QgeyBjb25maWc6IHsgYnJvYWRjYXN0LCBwcmVzZW5jZSwgcHJpdmF0ZTogaXNQcml2YXRlIH0gfSA9IHRoaXMucGFyYW1zOwogICAgICBjb25zdCBwb3N0Z3Jlc19jaGFuZ2VzID0gKF9iID0gKF9hID0gdGhpcy5iaW5kaW5ncy5wb3N0Z3Jlc19jaGFuZ2VzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubWFwKChyMikgPT4gcjIuZmlsdGVyKSkgIT09IG51bGwgJiYgX2IgIT09IHZvaWQgMCA/IF9iIDogW107CiAgICAgIGNvbnN0IHByZXNlbmNlX2VuYWJsZWQgPSAhIXRoaXMuYmluZGluZ3NbUkVBTFRJTUVfTElTVEVOX1RZUEVTLlBSRVNFTkNFXSAmJiB0aGlzLmJpbmRpbmdzW1JFQUxUSU1FX0xJU1RFTl9UWVBFUy5QUkVTRU5DRV0ubGVuZ3RoID4gMCB8fCAoKF9jID0gdGhpcy5wYXJhbXMuY29uZmlnLnByZXNlbmNlKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuZW5hYmxlZCkgPT09IHRydWU7CiAgICAgIGNvbnN0IGFjY2Vzc1Rva2VuUGF5bG9hZCA9IHt9OwogICAgICBjb25zdCBjb25maWcgPSB7CiAgICAgICAgYnJvYWRjYXN0LAogICAgICAgIHByZXNlbmNlOiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHByZXNlbmNlKSwgeyBlbmFibGVkOiBwcmVzZW5jZV9lbmFibGVkIH0pLAogICAgICAgIHBvc3RncmVzX2NoYW5nZXMsCiAgICAgICAgcHJpdmF0ZTogaXNQcml2YXRlCiAgICAgIH07CiAgICAgIGlmICh0aGlzLnNvY2tldC5hY2Nlc3NUb2tlblZhbHVlKSB7CiAgICAgICAgYWNjZXNzVG9rZW5QYXlsb2FkLmFjY2Vzc190b2tlbiA9IHRoaXMuc29ja2V0LmFjY2Vzc1Rva2VuVmFsdWU7CiAgICAgIH0KICAgICAgdGhpcy5fb25FcnJvcigoZSkgPT4gY2FsbGJhY2sgPT09IG51bGwgfHwgY2FsbGJhY2sgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNhbGxiYWNrKFJFQUxUSU1FX1NVQlNDUklCRV9TVEFURVMuQ0hBTk5FTF9FUlJPUiwgZSkpOwogICAgICB0aGlzLl9vbkNsb3NlKCgpID0+IGNhbGxiYWNrID09PSBudWxsIHx8IGNhbGxiYWNrID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjYWxsYmFjayhSRUFMVElNRV9TVUJTQ1JJQkVfU1RBVEVTLkNMT1NFRCkpOwogICAgICB0aGlzLnVwZGF0ZUpvaW5QYXlsb2FkKE9iamVjdC5hc3NpZ24oeyBjb25maWcgfSwgYWNjZXNzVG9rZW5QYXlsb2FkKSk7CiAgICAgIHRoaXMuam9pbmVkT25jZSA9IHRydWU7CiAgICAgIHRoaXMuX3Jlam9pbih0aW1lb3V0KTsKICAgICAgdGhpcy5qb2luUHVzaC5yZWNlaXZlKCJvayIsIGFzeW5jICh7IHBvc3RncmVzX2NoYW5nZXM6IHBvc3RncmVzX2NoYW5nZXMyIH0pID0+IHsKICAgICAgICB2YXIgX2EyOwogICAgICAgIGlmICghdGhpcy5zb2NrZXQuX2lzTWFudWFsVG9rZW4oKSkgewogICAgICAgICAgdGhpcy5zb2NrZXQuc2V0QXV0aCgpOwogICAgICAgIH0KICAgICAgICBpZiAocG9zdGdyZXNfY2hhbmdlczIgPT09IHZvaWQgMCkgewogICAgICAgICAgY2FsbGJhY2sgPT09IG51bGwgfHwgY2FsbGJhY2sgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNhbGxiYWNrKFJFQUxUSU1FX1NVQlNDUklCRV9TVEFURVMuU1VCU0NSSUJFRCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnN0IGNsaWVudFBvc3RncmVzQmluZGluZ3MgPSB0aGlzLmJpbmRpbmdzLnBvc3RncmVzX2NoYW5nZXM7CiAgICAgICAgICBjb25zdCBiaW5kaW5nc0xlbiA9IChfYTIgPSBjbGllbnRQb3N0Z3Jlc0JpbmRpbmdzID09PSBudWxsIHx8IGNsaWVudFBvc3RncmVzQmluZGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNsaWVudFBvc3RncmVzQmluZGluZ3MubGVuZ3RoKSAhPT0gbnVsbCAmJiBfYTIgIT09IHZvaWQgMCA/IF9hMiA6IDA7CiAgICAgICAgICBjb25zdCBuZXdQb3N0Z3Jlc0JpbmRpbmdzID0gW107CiAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJpbmRpbmdzTGVuOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgY2xpZW50UG9zdGdyZXNCaW5kaW5nID0gY2xpZW50UG9zdGdyZXNCaW5kaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgeyBmaWx0ZXI6IHsgZXZlbnQsIHNjaGVtYSwgdGFibGUsIGZpbHRlciB9IH0gPSBjbGllbnRQb3N0Z3Jlc0JpbmRpbmc7CiAgICAgICAgICAgIGNvbnN0IHNlcnZlclBvc3RncmVzRmlsdGVyID0gcG9zdGdyZXNfY2hhbmdlczIgJiYgcG9zdGdyZXNfY2hhbmdlczJbaV07CiAgICAgICAgICAgIGlmIChzZXJ2ZXJQb3N0Z3Jlc0ZpbHRlciAmJiBzZXJ2ZXJQb3N0Z3Jlc0ZpbHRlci5ldmVudCA9PT0gZXZlbnQgJiYgX1JlYWx0aW1lQ2hhbm5lbC5pc0ZpbHRlclZhbHVlRXF1YWwoc2VydmVyUG9zdGdyZXNGaWx0ZXIuc2NoZW1hLCBzY2hlbWEpICYmIF9SZWFsdGltZUNoYW5uZWwuaXNGaWx0ZXJWYWx1ZUVxdWFsKHNlcnZlclBvc3RncmVzRmlsdGVyLnRhYmxlLCB0YWJsZSkgJiYgX1JlYWx0aW1lQ2hhbm5lbC5pc0ZpbHRlclZhbHVlRXF1YWwoc2VydmVyUG9zdGdyZXNGaWx0ZXIuZmlsdGVyLCBmaWx0ZXIpKSB7CiAgICAgICAgICAgICAgbmV3UG9zdGdyZXNCaW5kaW5ncy5wdXNoKE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgY2xpZW50UG9zdGdyZXNCaW5kaW5nKSwgeyBpZDogc2VydmVyUG9zdGdyZXNGaWx0ZXIuaWQgfSkpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTsKICAgICAgICAgICAgICB0aGlzLnN0YXRlID0gQ0hBTk5FTF9TVEFURVMuZXJyb3JlZDsKICAgICAgICAgICAgICBjYWxsYmFjayA9PT0gbnVsbCB8fCBjYWxsYmFjayA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2FsbGJhY2soUkVBTFRJTUVfU1VCU0NSSUJFX1NUQVRFUy5DSEFOTkVMX0VSUk9SLCBuZXcgRXJyb3IoIm1pc21hdGNoIGJldHdlZW4gc2VydmVyIGFuZCBjbGllbnQgYmluZGluZ3MgZm9yIHBvc3RncmVzIGNoYW5nZXMiKSk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmJpbmRpbmdzLnBvc3RncmVzX2NoYW5nZXMgPSBuZXdQb3N0Z3Jlc0JpbmRpbmdzOwogICAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soUkVBTFRJTUVfU1VCU0NSSUJFX1NUQVRFUy5TVUJTQ1JJQkVEKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0pLnJlY2VpdmUoImVycm9yIiwgKGVycm9yKSA9PiB7CiAgICAgICAgdGhpcy5zdGF0ZSA9IENIQU5ORUxfU1RBVEVTLmVycm9yZWQ7CiAgICAgICAgY2FsbGJhY2sgPT09IG51bGwgfHwgY2FsbGJhY2sgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNhbGxiYWNrKFJFQUxUSU1FX1NVQlNDUklCRV9TVEFURVMuQ0hBTk5FTF9FUlJPUiwgbmV3IEVycm9yKEpTT04uc3RyaW5naWZ5KE9iamVjdC52YWx1ZXMoZXJyb3IpLmpvaW4oIiwgIikgfHwgImVycm9yIikpKTsKICAgICAgICByZXR1cm47CiAgICAgIH0pLnJlY2VpdmUoInRpbWVvdXQiLCAoKSA9PiB7CiAgICAgICAgY2FsbGJhY2sgPT09IG51bGwgfHwgY2FsbGJhY2sgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNhbGxiYWNrKFJFQUxUSU1FX1NVQlNDUklCRV9TVEFURVMuVElNRURfT1VUKTsKICAgICAgICByZXR1cm47CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIGN1cnJlbnQgcHJlc2VuY2Ugc3RhdGUgZm9yIHRoaXMgY2hhbm5lbC4KICAgKgogICAqIFRoZSBzaGFwZSBpcyBhIG1hcCBrZXllZCBieSBwcmVzZW5jZSBrZXkgKGZvciBleGFtcGxlIGEgdXNlciBpZCkgd2hlcmUgZWFjaCBlbnRyeSBjb250YWlucyB0aGUKICAgKiB0cmFja2VkIG1ldGFkYXRhIGZvciB0aGF0IHVzZXIuCiAgICovCiAgcHJlc2VuY2VTdGF0ZSgpIHsKICAgIHJldHVybiB0aGlzLnByZXNlbmNlLnN0YXRlOwogIH0KICAvKioKICAgKiBTZW5kcyB0aGUgc3VwcGxpZWQgcGF5bG9hZCB0byB0aGUgcHJlc2VuY2UgdHJhY2tlciBzbyBvdGhlciBzdWJzY3JpYmVycyBjYW4gc2VlIHRoYXQgdGhpcwogICAqIGNsaWVudCBpcyBvbmxpbmUuIFVzZSBgdW50cmFja2AgdG8gc3RvcCBicm9hZGNhc3RpbmcgcHJlc2VuY2UgZm9yIHRoZSBzYW1lIGtleS4KICAgKi8KICBhc3luYyB0cmFjayhwYXlsb2FkLCBvcHRzID0ge30pIHsKICAgIHJldHVybiBhd2FpdCB0aGlzLnNlbmQoewogICAgICB0eXBlOiAicHJlc2VuY2UiLAogICAgICBldmVudDogInRyYWNrIiwKICAgICAgcGF5bG9hZAogICAgfSwgb3B0cy50aW1lb3V0IHx8IHRoaXMudGltZW91dCk7CiAgfQogIC8qKgogICAqIFJlbW92ZXMgdGhlIGN1cnJlbnQgcHJlc2VuY2Ugc3RhdGUgZm9yIHRoaXMgY2xpZW50LgogICAqLwogIGFzeW5jIHVudHJhY2sob3B0cyA9IHt9KSB7CiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kKHsKICAgICAgdHlwZTogInByZXNlbmNlIiwKICAgICAgZXZlbnQ6ICJ1bnRyYWNrIgogICAgfSwgb3B0cyk7CiAgfQogIG9uKHR5cGUsIGZpbHRlciwgY2FsbGJhY2spIHsKICAgIGlmICh0aGlzLnN0YXRlID09PSBDSEFOTkVMX1NUQVRFUy5qb2luZWQgJiYgdHlwZSA9PT0gUkVBTFRJTUVfTElTVEVOX1RZUEVTLlBSRVNFTkNFKSB7CiAgICAgIHRoaXMuc29ja2V0LmxvZygiY2hhbm5lbCIsIGByZXN1YnNjcmliZSB0byAke3RoaXMudG9waWN9IGR1ZSB0byBjaGFuZ2UgaW4gcHJlc2VuY2UgY2FsbGJhY2tzIG9uIGpvaW5lZCBjaGFubmVsYCk7CiAgICAgIHRoaXMudW5zdWJzY3JpYmUoKS50aGVuKGFzeW5jICgpID0+IGF3YWl0IHRoaXMuc3Vic2NyaWJlKCkpOwogICAgfQogICAgcmV0dXJuIHRoaXMuX29uKHR5cGUsIGZpbHRlciwgY2FsbGJhY2spOwogIH0KICAvKioKICAgKiBTZW5kcyBhIGJyb2FkY2FzdCBtZXNzYWdlIGV4cGxpY2l0bHkgdmlhIFJFU1QgQVBJLgogICAqCiAgICogVGhpcyBtZXRob2QgYWx3YXlzIHVzZXMgdGhlIFJFU1QgQVBJIGVuZHBvaW50IHJlZ2FyZGxlc3Mgb2YgV2ViU29ja2V0IGNvbm5lY3Rpb24gc3RhdGUuCiAgICogVXNlZnVsIHdoZW4geW91IHdhbnQgdG8gZ3VhcmFudGVlIFJFU1QgZGVsaXZlcnkgb3Igd2hlbiBncmFkdWFsbHkgbWlncmF0aW5nIGZyb20gaW1wbGljaXQgUkVTVCBmYWxsYmFjay4KICAgKgogICAqIEBwYXJhbSBldmVudCBUaGUgbmFtZSBvZiB0aGUgYnJvYWRjYXN0IGV2ZW50CiAgICogQHBhcmFtIHBheWxvYWQgUGF5bG9hZCB0byBiZSBzZW50IChyZXF1aXJlZCkKICAgKiBAcGFyYW0gb3B0cyBPcHRpb25zIGluY2x1ZGluZyB0aW1lb3V0CiAgICogQHJldHVybnMgUHJvbWlzZSByZXNvbHZpbmcgdG8gb2JqZWN0IHdpdGggc3VjY2VzcyBzdGF0dXMsIGFuZCBlcnJvciBkZXRhaWxzIGlmIGZhaWxlZAogICAqLwogIGFzeW5jIGh0dHBTZW5kKGV2ZW50LCBwYXlsb2FkLCBvcHRzID0ge30pIHsKICAgIHZhciBfYTsKICAgIGlmIChwYXlsb2FkID09PSB2b2lkIDAgfHwgcGF5bG9hZCA9PT0gbnVsbCkgewogICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoIlBheWxvYWQgaXMgcmVxdWlyZWQgZm9yIGh0dHBTZW5kKCkiKTsKICAgIH0KICAgIGNvbnN0IGhlYWRlcnMgPSB7CiAgICAgIGFwaWtleTogdGhpcy5zb2NrZXQuYXBpS2V5ID8gdGhpcy5zb2NrZXQuYXBpS2V5IDogIiIsCiAgICAgICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIKICAgIH07CiAgICBpZiAodGhpcy5zb2NrZXQuYWNjZXNzVG9rZW5WYWx1ZSkgewogICAgICBoZWFkZXJzWyJBdXRob3JpemF0aW9uIl0gPSBgQmVhcmVyICR7dGhpcy5zb2NrZXQuYWNjZXNzVG9rZW5WYWx1ZX1gOwogICAgfQogICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgIGhlYWRlcnMsCiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICBtZXNzYWdlczogWwogICAgICAgICAgewogICAgICAgICAgICB0b3BpYzogdGhpcy5zdWJUb3BpYywKICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgIHBheWxvYWQsCiAgICAgICAgICAgIHByaXZhdGU6IHRoaXMucHJpdmF0ZQogICAgICAgICAgfQogICAgICAgIF0KICAgICAgfSkKICAgIH07CiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuX2ZldGNoV2l0aFRpbWVvdXQodGhpcy5icm9hZGNhc3RFbmRwb2ludFVSTCwgb3B0aW9ucywgKF9hID0gb3B0cy50aW1lb3V0KSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiB0aGlzLnRpbWVvdXQpOwogICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAyKSB7CiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTsKICAgIH0KICAgIGxldCBlcnJvck1lc3NhZ2UgPSByZXNwb25zZS5zdGF0dXNUZXh0OwogICAgdHJ5IHsKICAgICAgY29uc3QgZXJyb3JCb2R5ID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwogICAgICBlcnJvck1lc3NhZ2UgPSBlcnJvckJvZHkuZXJyb3IgfHwgZXJyb3JCb2R5Lm1lc3NhZ2UgfHwgZXJyb3JNZXNzYWdlOwogICAgfSBjYXRjaCAoX2IpIHsKICAgIH0KICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoZXJyb3JNZXNzYWdlKSk7CiAgfQogIC8qKgogICAqIFNlbmRzIGEgbWVzc2FnZSBpbnRvIHRoZSBjaGFubmVsLgogICAqCiAgICogQHBhcmFtIGFyZ3MgQXJndW1lbnRzIHRvIHNlbmQgdG8gY2hhbm5lbAogICAqIEBwYXJhbSBhcmdzLnR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdG8gc2VuZAogICAqIEBwYXJhbSBhcmdzLmV2ZW50IFRoZSBuYW1lIG9mIHRoZSBldmVudCBiZWluZyBzZW50CiAgICogQHBhcmFtIGFyZ3MucGF5bG9hZCBQYXlsb2FkIHRvIGJlIHNlbnQKICAgKiBAcGFyYW0gb3B0cyBPcHRpb25zIHRvIGJlIHVzZWQgZHVyaW5nIHRoZSBzZW5kIHByb2Nlc3MKICAgKi8KICBhc3luYyBzZW5kKGFyZ3MsIG9wdHMgPSB7fSkgewogICAgdmFyIF9hLCBfYjsKICAgIGlmICghdGhpcy5fY2FuUHVzaCgpICYmIGFyZ3MudHlwZSA9PT0gImJyb2FkY2FzdCIpIHsKICAgICAgY29uc29sZS53YXJuKCJSZWFsdGltZSBzZW5kKCkgaXMgYXV0b21hdGljYWxseSBmYWxsaW5nIGJhY2sgdG8gUkVTVCBBUEkuIFRoaXMgYmVoYXZpb3Igd2lsbCBiZSBkZXByZWNhdGVkIGluIHRoZSBmdXR1cmUuIFBsZWFzZSB1c2UgaHR0cFNlbmQoKSBleHBsaWNpdGx5IGZvciBSRVNUIGRlbGl2ZXJ5LiIpOwogICAgICBjb25zdCB7IGV2ZW50LCBwYXlsb2FkOiBlbmRwb2ludF9wYXlsb2FkIH0gPSBhcmdzOwogICAgICBjb25zdCBoZWFkZXJzID0gewogICAgICAgIGFwaWtleTogdGhpcy5zb2NrZXQuYXBpS2V5ID8gdGhpcy5zb2NrZXQuYXBpS2V5IDogIiIsCiAgICAgICAgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIgogICAgICB9OwogICAgICBpZiAodGhpcy5zb2NrZXQuYWNjZXNzVG9rZW5WYWx1ZSkgewogICAgICAgIGhlYWRlcnNbIkF1dGhvcml6YXRpb24iXSA9IGBCZWFyZXIgJHt0aGlzLnNvY2tldC5hY2Nlc3NUb2tlblZhbHVlfWA7CiAgICAgIH0KICAgICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgICBoZWFkZXJzLAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgIG1lc3NhZ2VzOiBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB0b3BpYzogdGhpcy5zdWJUb3BpYywKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBwYXlsb2FkOiBlbmRwb2ludF9wYXlsb2FkLAogICAgICAgICAgICAgIHByaXZhdGU6IHRoaXMucHJpdmF0ZQogICAgICAgICAgICB9CiAgICAgICAgICBdCiAgICAgICAgfSkKICAgICAgfTsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuX2ZldGNoV2l0aFRpbWVvdXQodGhpcy5icm9hZGNhc3RFbmRwb2ludFVSTCwgb3B0aW9ucywgKF9hID0gb3B0cy50aW1lb3V0KSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiB0aGlzLnRpbWVvdXQpOwogICAgICAgIGF3YWl0ICgoX2IgPSByZXNwb25zZS5ib2R5KSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuY2FuY2VsKCkpOwogICAgICAgIHJldHVybiByZXNwb25zZS5vayA/ICJvayIgOiAiZXJyb3IiOwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGlmIChlcnJvci5uYW1lID09PSAiQWJvcnRFcnJvciIpIHsKICAgICAgICAgIHJldHVybiAidGltZWQgb3V0IjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuICJlcnJvciI7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgICB2YXIgX2EyLCBfYjIsIF9jOwogICAgICAgIGNvbnN0IHB1c2ggPSB0aGlzLl9wdXNoKGFyZ3MudHlwZSwgYXJncywgb3B0cy50aW1lb3V0IHx8IHRoaXMudGltZW91dCk7CiAgICAgICAgaWYgKGFyZ3MudHlwZSA9PT0gImJyb2FkY2FzdCIgJiYgISgoX2MgPSAoX2IyID0gKF9hMiA9IHRoaXMucGFyYW1zKSA9PT0gbnVsbCB8fCBfYTIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hMi5jb25maWcpID09PSBudWxsIHx8IF9iMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IyLmJyb2FkY2FzdCkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmFjaykpIHsKICAgICAgICAgIHJlc29sdmUoIm9rIik7CiAgICAgICAgfQogICAgICAgIHB1c2gucmVjZWl2ZSgib2siLCAoKSA9PiByZXNvbHZlKCJvayIpKTsKICAgICAgICBwdXNoLnJlY2VpdmUoImVycm9yIiwgKCkgPT4gcmVzb2x2ZSgiZXJyb3IiKSk7CiAgICAgICAgcHVzaC5yZWNlaXZlKCJ0aW1lb3V0IiwgKCkgPT4gcmVzb2x2ZSgidGltZWQgb3V0IikpOwogICAgICB9KTsKICAgIH0KICB9CiAgLyoqCiAgICogVXBkYXRlcyB0aGUgcGF5bG9hZCB0aGF0IHdpbGwgYmUgc2VudCB0aGUgbmV4dCB0aW1lIHRoZSBjaGFubmVsIGpvaW5zIChyZWNvbm5lY3RzKS4KICAgKiBVc2VmdWwgZm9yIHJvdGF0aW5nIGFjY2VzcyB0b2tlbnMgb3IgdXBkYXRpbmcgY29uZmlnIHdpdGhvdXQgcmUtY3JlYXRpbmcgdGhlIGNoYW5uZWwuCiAgICovCiAgdXBkYXRlSm9pblBheWxvYWQocGF5bG9hZCkgewogICAgdGhpcy5qb2luUHVzaC51cGRhdGVQYXlsb2FkKHBheWxvYWQpOwogIH0KICAvKioKICAgKiBMZWF2ZXMgdGhlIGNoYW5uZWwuCiAgICoKICAgKiBVbnN1YnNjcmliZXMgZnJvbSBzZXJ2ZXIgZXZlbnRzLCBhbmQgaW5zdHJ1Y3RzIGNoYW5uZWwgdG8gdGVybWluYXRlIG9uIHNlcnZlci4KICAgKiBUcmlnZ2VycyBvbkNsb3NlKCkgaG9va3MuCiAgICoKICAgKiBUbyByZWNlaXZlIGxlYXZlIGFja25vd2xlZGdlbWVudHMsIHVzZSB0aGUgYSBgcmVjZWl2ZWAgaG9vayB0byBiaW5kIHRvIHRoZSBzZXJ2ZXIgYWNrLCBpZToKICAgKiBjaGFubmVsLnVuc3Vic2NyaWJlKCkucmVjZWl2ZSgib2siLCAoKSA9PiBhbGVydCgibGVmdCEiKSApCiAgICovCiAgdW5zdWJzY3JpYmUodGltZW91dCA9IHRoaXMudGltZW91dCkgewogICAgdGhpcy5zdGF0ZSA9IENIQU5ORUxfU1RBVEVTLmxlYXZpbmc7CiAgICBjb25zdCBvbkNsb3NlID0gKCkgPT4gewogICAgICB0aGlzLnNvY2tldC5sb2coImNoYW5uZWwiLCBgbGVhdmUgJHt0aGlzLnRvcGljfWApOwogICAgICB0aGlzLl90cmlnZ2VyKENIQU5ORUxfRVZFTlRTLmNsb3NlLCAibGVhdmUiLCB0aGlzLl9qb2luUmVmKCkpOwogICAgfTsKICAgIHRoaXMuam9pblB1c2guZGVzdHJveSgpOwogICAgbGV0IGxlYXZlUHVzaCA9IG51bGw7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHsKICAgICAgbGVhdmVQdXNoID0gbmV3IFB1c2godGhpcywgQ0hBTk5FTF9FVkVOVFMubGVhdmUsIHt9LCB0aW1lb3V0KTsKICAgICAgbGVhdmVQdXNoLnJlY2VpdmUoIm9rIiwgKCkgPT4gewogICAgICAgIG9uQ2xvc2UoKTsKICAgICAgICByZXNvbHZlKCJvayIpOwogICAgICB9KS5yZWNlaXZlKCJ0aW1lb3V0IiwgKCkgPT4gewogICAgICAgIG9uQ2xvc2UoKTsKICAgICAgICByZXNvbHZlKCJ0aW1lZCBvdXQiKTsKICAgICAgfSkucmVjZWl2ZSgiZXJyb3IiLCAoKSA9PiB7CiAgICAgICAgcmVzb2x2ZSgiZXJyb3IiKTsKICAgICAgfSk7CiAgICAgIGxlYXZlUHVzaC5zZW5kKCk7CiAgICAgIGlmICghdGhpcy5fY2FuUHVzaCgpKSB7CiAgICAgICAgbGVhdmVQdXNoLnRyaWdnZXIoIm9rIiwge30pOwogICAgICB9CiAgICB9KS5maW5hbGx5KCgpID0+IHsKICAgICAgbGVhdmVQdXNoID09PSBudWxsIHx8IGxlYXZlUHVzaCA9PT0gdm9pZCAwID8gdm9pZCAwIDogbGVhdmVQdXNoLmRlc3Ryb3koKTsKICAgIH0pOwogIH0KICAvKioKICAgKiBUZWFyZG93biB0aGUgY2hhbm5lbC4KICAgKgogICAqIERlc3Ryb3lzIGFuZCBzdG9wcyByZWxhdGVkIHRpbWVycy4KICAgKi8KICB0ZWFyZG93bigpIHsKICAgIHRoaXMucHVzaEJ1ZmZlci5mb3JFYWNoKChwdXNoKSA9PiBwdXNoLmRlc3Ryb3koKSk7CiAgICB0aGlzLnB1c2hCdWZmZXIgPSBbXTsKICAgIHRoaXMucmVqb2luVGltZXIucmVzZXQoKTsKICAgIHRoaXMuam9pblB1c2guZGVzdHJveSgpOwogICAgdGhpcy5zdGF0ZSA9IENIQU5ORUxfU1RBVEVTLmNsb3NlZDsKICAgIHRoaXMuYmluZGluZ3MgPSB7fTsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIGFzeW5jIF9mZXRjaFdpdGhUaW1lb3V0KHVybCwgb3B0aW9ucywgdGltZW91dCkgewogICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IGlkID0gc2V0VGltZW91dCgoKSA9PiBjb250cm9sbGVyLmFib3J0KCksIHRpbWVvdXQpOwogICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLnNvY2tldC5mZXRjaCh1cmwsIE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyksIHsgc2lnbmFsOiBjb250cm9sbGVyLnNpZ25hbCB9KSk7CiAgICBjbGVhclRpbWVvdXQoaWQpOwogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0KICAvKiogQGludGVybmFsICovCiAgX3B1c2goZXZlbnQsIHBheWxvYWQsIHRpbWVvdXQgPSB0aGlzLnRpbWVvdXQpIHsKICAgIGlmICghdGhpcy5qb2luZWRPbmNlKSB7CiAgICAgIHRocm93IGB0cmllZCB0byBwdXNoICcke2V2ZW50fScgdG8gJyR7dGhpcy50b3BpY30nIGJlZm9yZSBqb2luaW5nLiBVc2UgY2hhbm5lbC5zdWJzY3JpYmUoKSBiZWZvcmUgcHVzaGluZyBldmVudHNgOwogICAgfQogICAgbGV0IHB1c2hFdmVudCA9IG5ldyBQdXNoKHRoaXMsIGV2ZW50LCBwYXlsb2FkLCB0aW1lb3V0KTsKICAgIGlmICh0aGlzLl9jYW5QdXNoKCkpIHsKICAgICAgcHVzaEV2ZW50LnNlbmQoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX2FkZFRvUHVzaEJ1ZmZlcihwdXNoRXZlbnQpOwogICAgfQogICAgcmV0dXJuIHB1c2hFdmVudDsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIF9hZGRUb1B1c2hCdWZmZXIocHVzaEV2ZW50KSB7CiAgICBwdXNoRXZlbnQuc3RhcnRUaW1lb3V0KCk7CiAgICB0aGlzLnB1c2hCdWZmZXIucHVzaChwdXNoRXZlbnQpOwogICAgaWYgKHRoaXMucHVzaEJ1ZmZlci5sZW5ndGggPiBNQVhfUFVTSF9CVUZGRVJfU0laRSkgewogICAgICBjb25zdCByZW1vdmVkUHVzaCA9IHRoaXMucHVzaEJ1ZmZlci5zaGlmdCgpOwogICAgICBpZiAocmVtb3ZlZFB1c2gpIHsKICAgICAgICByZW1vdmVkUHVzaC5kZXN0cm95KCk7CiAgICAgICAgdGhpcy5zb2NrZXQubG9nKCJjaGFubmVsIiwgYGRpc2NhcmRlZCBwdXNoIGR1ZSB0byBidWZmZXIgb3ZlcmZsb3c6ICR7cmVtb3ZlZFB1c2guZXZlbnR9YCwgcmVtb3ZlZFB1c2gucGF5bG9hZCk7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogT3ZlcnJpZGFibGUgbWVzc2FnZSBob29rCiAgICoKICAgKiBSZWNlaXZlcyBhbGwgZXZlbnRzIGZvciBzcGVjaWFsaXplZCBtZXNzYWdlIGhhbmRsaW5nIGJlZm9yZSBkaXNwYXRjaGluZyB0byB0aGUgY2hhbm5lbCBjYWxsYmFja3MuCiAgICogTXVzdCByZXR1cm4gdGhlIHBheWxvYWQsIG1vZGlmaWVkIG9yIHVubW9kaWZpZWQuCiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KICBfb25NZXNzYWdlKF9ldmVudCwgcGF5bG9hZCwgX3JlZjIpIHsKICAgIHJldHVybiBwYXlsb2FkOwogIH0KICAvKiogQGludGVybmFsICovCiAgX2lzTWVtYmVyKHRvcGljKSB7CiAgICByZXR1cm4gdGhpcy50b3BpYyA9PT0gdG9waWM7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfam9pblJlZigpIHsKICAgIHJldHVybiB0aGlzLmpvaW5QdXNoLnJlZjsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIF90cmlnZ2VyKHR5cGUsIHBheWxvYWQsIHJlZikgewogICAgdmFyIF9hLCBfYjsKICAgIGNvbnN0IHR5cGVMb3dlciA9IHR5cGUudG9Mb2NhbGVMb3dlckNhc2UoKTsKICAgIGNvbnN0IHsgY2xvc2UsIGVycm9yLCBsZWF2ZSwgam9pbiB9ID0gQ0hBTk5FTF9FVkVOVFM7CiAgICBjb25zdCBldmVudHMgPSBbY2xvc2UsIGVycm9yLCBsZWF2ZSwgam9pbl07CiAgICBpZiAocmVmICYmIGV2ZW50cy5pbmRleE9mKHR5cGVMb3dlcikgPj0gMCAmJiByZWYgIT09IHRoaXMuX2pvaW5SZWYoKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBsZXQgaGFuZGxlZFBheWxvYWQgPSB0aGlzLl9vbk1lc3NhZ2UodHlwZUxvd2VyLCBwYXlsb2FkLCByZWYpOwogICAgaWYgKHBheWxvYWQgJiYgIWhhbmRsZWRQYXlsb2FkKSB7CiAgICAgIHRocm93ICJjaGFubmVsIG9uTWVzc2FnZSBjYWxsYmFja3MgbXVzdCByZXR1cm4gdGhlIHBheWxvYWQsIG1vZGlmaWVkIG9yIHVubW9kaWZpZWQiOwogICAgfQogICAgaWYgKFsiaW5zZXJ0IiwgInVwZGF0ZSIsICJkZWxldGUiXS5pbmNsdWRlcyh0eXBlTG93ZXIpKSB7CiAgICAgIChfYSA9IHRoaXMuYmluZGluZ3MucG9zdGdyZXNfY2hhbmdlcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmZpbHRlcigoYmluZCkgPT4gewogICAgICAgIHZhciBfYTIsIF9iMiwgX2M7CiAgICAgICAgcmV0dXJuICgoX2EyID0gYmluZC5maWx0ZXIpID09PSBudWxsIHx8IF9hMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EyLmV2ZW50KSA9PT0gIioiIHx8ICgoX2MgPSAoX2IyID0gYmluZC5maWx0ZXIpID09PSBudWxsIHx8IF9iMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IyLmV2ZW50KSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MudG9Mb2NhbGVMb3dlckNhc2UoKSkgPT09IHR5cGVMb3dlcjsKICAgICAgfSkubWFwKChiaW5kKSA9PiBiaW5kLmNhbGxiYWNrKGhhbmRsZWRQYXlsb2FkLCByZWYpKTsKICAgIH0gZWxzZSB7CiAgICAgIChfYiA9IHRoaXMuYmluZGluZ3NbdHlwZUxvd2VyXSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmZpbHRlcigoYmluZCkgPT4gewogICAgICAgIHZhciBfYTIsIF9iMiwgX2MsIF9kLCBfZSwgX2Y7CiAgICAgICAgaWYgKFsiYnJvYWRjYXN0IiwgInByZXNlbmNlIiwgInBvc3RncmVzX2NoYW5nZXMiXS5pbmNsdWRlcyh0eXBlTG93ZXIpKSB7CiAgICAgICAgICBpZiAoImlkIiBpbiBiaW5kKSB7CiAgICAgICAgICAgIGNvbnN0IGJpbmRJZCA9IGJpbmQuaWQ7CiAgICAgICAgICAgIGNvbnN0IGJpbmRFdmVudCA9IChfYTIgPSBiaW5kLmZpbHRlcikgPT09IG51bGwgfHwgX2EyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYTIuZXZlbnQ7CiAgICAgICAgICAgIHJldHVybiBiaW5kSWQgJiYgKChfYjIgPSBwYXlsb2FkLmlkcykgPT09IG51bGwgfHwgX2IyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYjIuaW5jbHVkZXMoYmluZElkKSkgJiYgKGJpbmRFdmVudCA9PT0gIioiIHx8IChiaW5kRXZlbnQgPT09IG51bGwgfHwgYmluZEV2ZW50ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBiaW5kRXZlbnQudG9Mb2NhbGVMb3dlckNhc2UoKSkgPT09ICgoX2MgPSBwYXlsb2FkLmRhdGEpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy50eXBlLnRvTG9jYWxlTG93ZXJDYXNlKCkpKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGJpbmRFdmVudCA9IChfZSA9IChfZCA9IGJpbmQgPT09IG51bGwgfHwgYmluZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogYmluZC5maWx0ZXIpID09PSBudWxsIHx8IF9kID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZC5ldmVudCkgPT09IG51bGwgfHwgX2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lLnRvTG9jYWxlTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHJldHVybiBiaW5kRXZlbnQgPT09ICIqIiB8fCBiaW5kRXZlbnQgPT09ICgoX2YgPSBwYXlsb2FkID09PSBudWxsIHx8IHBheWxvYWQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBheWxvYWQuZXZlbnQpID09PSBudWxsIHx8IF9mID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZi50b0xvY2FsZUxvd2VyQ2FzZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIGJpbmQudHlwZS50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSB0eXBlTG93ZXI7CiAgICAgICAgfQogICAgICB9KS5tYXAoKGJpbmQpID0+IHsKICAgICAgICBpZiAodHlwZW9mIGhhbmRsZWRQYXlsb2FkID09PSAib2JqZWN0IiAmJiAiaWRzIiBpbiBoYW5kbGVkUGF5bG9hZCkgewogICAgICAgICAgY29uc3QgcG9zdGdyZXNDaGFuZ2VzID0gaGFuZGxlZFBheWxvYWQuZGF0YTsKICAgICAgICAgIGNvbnN0IHsgc2NoZW1hLCB0YWJsZSwgY29tbWl0X3RpbWVzdGFtcCwgdHlwZTogdHlwZTIsIGVycm9yczogZXJyb3JzMyB9ID0gcG9zdGdyZXNDaGFuZ2VzOwogICAgICAgICAgY29uc3QgZW5yaWNoZWRQYXlsb2FkID0gewogICAgICAgICAgICBzY2hlbWEsCiAgICAgICAgICAgIHRhYmxlLAogICAgICAgICAgICBjb21taXRfdGltZXN0YW1wLAogICAgICAgICAgICBldmVudFR5cGU6IHR5cGUyLAogICAgICAgICAgICBuZXc6IHt9LAogICAgICAgICAgICBvbGQ6IHt9LAogICAgICAgICAgICBlcnJvcnM6IGVycm9yczMKICAgICAgICAgIH07CiAgICAgICAgICBoYW5kbGVkUGF5bG9hZCA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgZW5yaWNoZWRQYXlsb2FkKSwgdGhpcy5fZ2V0UGF5bG9hZFJlY29yZHMocG9zdGdyZXNDaGFuZ2VzKSk7CiAgICAgICAgfQogICAgICAgIGJpbmQuY2FsbGJhY2soaGFuZGxlZFBheWxvYWQsIHJlZik7CiAgICAgIH0pOwogICAgfQogIH0KICAvKiogQGludGVybmFsICovCiAgX2lzQ2xvc2VkKCkgewogICAgcmV0dXJuIHRoaXMuc3RhdGUgPT09IENIQU5ORUxfU1RBVEVTLmNsb3NlZDsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIF9pc0pvaW5lZCgpIHsKICAgIHJldHVybiB0aGlzLnN0YXRlID09PSBDSEFOTkVMX1NUQVRFUy5qb2luZWQ7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfaXNKb2luaW5nKCkgewogICAgcmV0dXJuIHRoaXMuc3RhdGUgPT09IENIQU5ORUxfU1RBVEVTLmpvaW5pbmc7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfaXNMZWF2aW5nKCkgewogICAgcmV0dXJuIHRoaXMuc3RhdGUgPT09IENIQU5ORUxfU1RBVEVTLmxlYXZpbmc7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfcmVwbHlFdmVudE5hbWUocmVmKSB7CiAgICByZXR1cm4gYGNoYW5fcmVwbHlfJHtyZWZ9YDsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIF9vbih0eXBlLCBmaWx0ZXIsIGNhbGxiYWNrKSB7CiAgICBjb25zdCB0eXBlTG93ZXIgPSB0eXBlLnRvTG9jYWxlTG93ZXJDYXNlKCk7CiAgICBjb25zdCBiaW5kaW5nID0gewogICAgICB0eXBlOiB0eXBlTG93ZXIsCiAgICAgIGZpbHRlciwKICAgICAgY2FsbGJhY2sKICAgIH07CiAgICBpZiAodGhpcy5iaW5kaW5nc1t0eXBlTG93ZXJdKSB7CiAgICAgIHRoaXMuYmluZGluZ3NbdHlwZUxvd2VyXS5wdXNoKGJpbmRpbmcpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5iaW5kaW5nc1t0eXBlTG93ZXJdID0gW2JpbmRpbmddOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfb2ZmKHR5cGUsIGZpbHRlcikgewogICAgY29uc3QgdHlwZUxvd2VyID0gdHlwZS50b0xvY2FsZUxvd2VyQ2FzZSgpOwogICAgaWYgKHRoaXMuYmluZGluZ3NbdHlwZUxvd2VyXSkgewogICAgICB0aGlzLmJpbmRpbmdzW3R5cGVMb3dlcl0gPSB0aGlzLmJpbmRpbmdzW3R5cGVMb3dlcl0uZmlsdGVyKChiaW5kKSA9PiB7CiAgICAgICAgdmFyIF9hOwogICAgICAgIHJldHVybiAhKCgoX2EgPSBiaW5kLnR5cGUpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS50b0xvY2FsZUxvd2VyQ2FzZSgpKSA9PT0gdHlwZUxvd2VyICYmIF9SZWFsdGltZUNoYW5uZWwuaXNFcXVhbChiaW5kLmZpbHRlciwgZmlsdGVyKSk7CiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBzdGF0aWMgaXNFcXVhbChvYmoxLCBvYmoyKSB7CiAgICBpZiAoT2JqZWN0LmtleXMob2JqMSkubGVuZ3RoICE9PSBPYmplY3Qua2V5cyhvYmoyKS5sZW5ndGgpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgZm9yIChjb25zdCBrIGluIG9iajEpIHsKICAgICAgaWYgKG9iajFba10gIT09IG9iajJba10pIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KICAvKioKICAgKiBDb21wYXJlcyB0d28gb3B0aW9uYWwgZmlsdGVyIHZhbHVlcyBmb3IgZXF1YWxpdHkuCiAgICogVHJlYXRzIHVuZGVmaW5lZCwgbnVsbCwgYW5kIGVtcHR5IHN0cmluZyBhcyBlcXVpdmFsZW50IGVtcHR5IHZhbHVlcy4KICAgKiBAaW50ZXJuYWwKICAgKi8KICBzdGF0aWMgaXNGaWx0ZXJWYWx1ZUVxdWFsKHNlcnZlclZhbHVlLCBjbGllbnRWYWx1ZSkgewogICAgY29uc3Qgbm9ybWFsaXplZFNlcnZlciA9IHNlcnZlclZhbHVlICE9PSBudWxsICYmIHNlcnZlclZhbHVlICE9PSB2b2lkIDAgPyBzZXJ2ZXJWYWx1ZSA6IHZvaWQgMDsKICAgIGNvbnN0IG5vcm1hbGl6ZWRDbGllbnQgPSBjbGllbnRWYWx1ZSAhPT0gbnVsbCAmJiBjbGllbnRWYWx1ZSAhPT0gdm9pZCAwID8gY2xpZW50VmFsdWUgOiB2b2lkIDA7CiAgICByZXR1cm4gbm9ybWFsaXplZFNlcnZlciA9PT0gbm9ybWFsaXplZENsaWVudDsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIF9yZWpvaW5VbnRpbENvbm5lY3RlZCgpIHsKICAgIHRoaXMucmVqb2luVGltZXIuc2NoZWR1bGVUaW1lb3V0KCk7CiAgICBpZiAodGhpcy5zb2NrZXQuaXNDb25uZWN0ZWQoKSkgewogICAgICB0aGlzLl9yZWpvaW4oKTsKICAgIH0KICB9CiAgLyoqCiAgICogUmVnaXN0ZXJzIGEgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIHdoZW4gdGhlIGNoYW5uZWwgY2xvc2VzLgogICAqCiAgICogQGludGVybmFsCiAgICovCiAgX29uQ2xvc2UoY2FsbGJhY2spIHsKICAgIHRoaXMuX29uKENIQU5ORUxfRVZFTlRTLmNsb3NlLCB7fSwgY2FsbGJhY2spOwogIH0KICAvKioKICAgKiBSZWdpc3RlcnMgYSBjYWxsYmFjayB0aGF0IHdpbGwgYmUgZXhlY3V0ZWQgd2hlbiB0aGUgY2hhbm5lbCBlbmNvdW50ZXJlcyBhbiBlcnJvci4KICAgKgogICAqIEBpbnRlcm5hbAogICAqLwogIF9vbkVycm9yKGNhbGxiYWNrKSB7CiAgICB0aGlzLl9vbihDSEFOTkVMX0VWRU5UUy5lcnJvciwge30sIChyZWFzb24pID0+IGNhbGxiYWNrKHJlYXNvbikpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgc29ja2V0IGlzIGNvbm5lY3RlZCBhbmQgdGhlIGNoYW5uZWwgaGFzIGJlZW4gam9pbmVkLgogICAqCiAgICogQGludGVybmFsCiAgICovCiAgX2NhblB1c2goKSB7CiAgICByZXR1cm4gdGhpcy5zb2NrZXQuaXNDb25uZWN0ZWQoKSAmJiB0aGlzLl9pc0pvaW5lZCgpOwogIH0KICAvKiogQGludGVybmFsICovCiAgX3Jlam9pbih0aW1lb3V0ID0gdGhpcy50aW1lb3V0KSB7CiAgICBpZiAodGhpcy5faXNMZWF2aW5nKCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5zb2NrZXQuX2xlYXZlT3BlblRvcGljKHRoaXMudG9waWMpOwogICAgdGhpcy5zdGF0ZSA9IENIQU5ORUxfU1RBVEVTLmpvaW5pbmc7CiAgICB0aGlzLmpvaW5QdXNoLnJlc2VuZCh0aW1lb3V0KTsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIF9nZXRQYXlsb2FkUmVjb3JkcyhwYXlsb2FkKSB7CiAgICBjb25zdCByZWNvcmRzID0gewogICAgICBuZXc6IHt9LAogICAgICBvbGQ6IHt9CiAgICB9OwogICAgaWYgKHBheWxvYWQudHlwZSA9PT0gIklOU0VSVCIgfHwgcGF5bG9hZC50eXBlID09PSAiVVBEQVRFIikgewogICAgICByZWNvcmRzLm5ldyA9IGNvbnZlcnRDaGFuZ2VEYXRhKHBheWxvYWQuY29sdW1ucywgcGF5bG9hZC5yZWNvcmQpOwogICAgfQogICAgaWYgKHBheWxvYWQudHlwZSA9PT0gIlVQREFURSIgfHwgcGF5bG9hZC50eXBlID09PSAiREVMRVRFIikgewogICAgICByZWNvcmRzLm9sZCA9IGNvbnZlcnRDaGFuZ2VEYXRhKHBheWxvYWQuY29sdW1ucywgcGF5bG9hZC5vbGRfcmVjb3JkKTsKICAgIH0KICAgIHJldHVybiByZWNvcmRzOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrcmVhbHRpbWUtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvcmVhbHRpbWUtanMvZGlzdC9tb2R1bGUvUmVhbHRpbWVDbGllbnQuanMKdmFyIG5vb3A1ID0gKCkgPT4gewp9Owp2YXIgQ09OTkVDVElPTl9USU1FT1VUUyA9IHsKICBIRUFSVEJFQVRfSU5URVJWQUw6IDI1ZTMsCiAgUkVDT05ORUNUX0RFTEFZOiAxMCwKICBIRUFSVEJFQVRfVElNRU9VVF9GQUxMQkFDSzogMTAwCn07CnZhciBSRUNPTk5FQ1RfSU5URVJWQUxTID0gWzFlMywgMmUzLCA1ZTMsIDFlNF07CnZhciBERUZBVUxUX1JFQ09OTkVDVF9GQUxMQkFDSyA9IDFlNDsKdmFyIFdPUktFUl9TQ1JJUFQgPSBgCiAgYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIChlKSA9PiB7CiAgICBpZiAoZS5kYXRhLmV2ZW50ID09PSAic3RhcnQiKSB7CiAgICAgIHNldEludGVydmFsKCgpID0+IHBvc3RNZXNzYWdlKHsgZXZlbnQ6ICJrZWVwQWxpdmUiIH0pLCBlLmRhdGEuaW50ZXJ2YWwpOwogICAgfQogIH0pO2A7CnZhciBSZWFsdGltZUNsaWVudCA9IGNsYXNzIHsKICAvKioKICAgKiBJbml0aWFsaXplcyB0aGUgU29ja2V0LgogICAqCiAgICogQHBhcmFtIGVuZFBvaW50IFRoZSBzdHJpbmcgV2ViU29ja2V0IGVuZHBvaW50LCBpZSwgIndzOi8vZXhhbXBsZS5jb20vc29ja2V0IiwgIndzczovL2V4YW1wbGUuY29tIiwgIi9zb2NrZXQiIChpbmhlcml0ZWQgaG9zdCAmIHByb3RvY29sKQogICAqIEBwYXJhbSBodHRwRW5kcG9pbnQgVGhlIHN0cmluZyBIVFRQIGVuZHBvaW50LCBpZSwgImh0dHBzOi8vZXhhbXBsZS5jb20iLCAiLyIgKGluaGVyaXRlZCBob3N0ICYgcHJvdG9jb2wpCiAgICogQHBhcmFtIG9wdGlvbnMudHJhbnNwb3J0IFRoZSBXZWJzb2NrZXQgVHJhbnNwb3J0LCBmb3IgZXhhbXBsZSBXZWJTb2NrZXQuIFRoaXMgY2FuIGJlIGEgY3VzdG9tIGltcGxlbWVudGF0aW9uCiAgICogQHBhcmFtIG9wdGlvbnMudGltZW91dCBUaGUgZGVmYXVsdCB0aW1lb3V0IGluIG1pbGxpc2Vjb25kcyB0byB0cmlnZ2VyIHB1c2ggdGltZW91dHMuCiAgICogQHBhcmFtIG9wdGlvbnMucGFyYW1zIFRoZSBvcHRpb25hbCBwYXJhbXMgdG8gcGFzcyB3aGVuIGNvbm5lY3RpbmcuCiAgICogQHBhcmFtIG9wdGlvbnMuaGVhZGVycyBEZXByZWNhdGVkOiBoZWFkZXJzIGNhbm5vdCBiZSBzZXQgb24gd2Vic29ja2V0IGNvbm5lY3Rpb25zIGFuZCB0aGlzIG9wdGlvbiB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIGZ1dHVyZS4KICAgKiBAcGFyYW0gb3B0aW9ucy5oZWFydGJlYXRJbnRlcnZhbE1zIFRoZSBtaWxsaXNlYyBpbnRlcnZhbCB0byBzZW5kIGEgaGVhcnRiZWF0IG1lc3NhZ2UuCiAgICogQHBhcmFtIG9wdGlvbnMuaGVhcnRiZWF0Q2FsbGJhY2sgVGhlIG9wdGlvbmFsIGZ1bmN0aW9uIHRvIGhhbmRsZSBoZWFydGJlYXQgc3RhdHVzIGFuZCBsYXRlbmN5LgogICAqIEBwYXJhbSBvcHRpb25zLmxvZ2dlciBUaGUgb3B0aW9uYWwgZnVuY3Rpb24gZm9yIHNwZWNpYWxpemVkIGxvZ2dpbmcsIGllOiBsb2dnZXI6IChraW5kLCBtc2csIGRhdGEpID0+IHsgY29uc29sZS5sb2coYCR7a2luZH06ICR7bXNnfWAsIGRhdGEpIH0KICAgKiBAcGFyYW0gb3B0aW9ucy5sb2dMZXZlbCBTZXRzIHRoZSBsb2cgbGV2ZWwgZm9yIFJlYWx0aW1lCiAgICogQHBhcmFtIG9wdGlvbnMuZW5jb2RlIFRoZSBmdW5jdGlvbiB0byBlbmNvZGUgb3V0Z29pbmcgbWVzc2FnZXMuIERlZmF1bHRzIHRvIEpTT046IChwYXlsb2FkLCBjYWxsYmFjaykgPT4gY2FsbGJhY2soSlNPTi5zdHJpbmdpZnkocGF5bG9hZCkpCiAgICogQHBhcmFtIG9wdGlvbnMuZGVjb2RlIFRoZSBmdW5jdGlvbiB0byBkZWNvZGUgaW5jb21pbmcgbWVzc2FnZXMuIERlZmF1bHRzIHRvIFNlcmlhbGl6ZXIncyBkZWNvZGUuCiAgICogQHBhcmFtIG9wdGlvbnMucmVjb25uZWN0QWZ0ZXJNcyBoZSBvcHRpb25hbCBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlIG1pbGxzZWMgcmVjb25uZWN0IGludGVydmFsLiBEZWZhdWx0cyB0byBzdGVwcGVkIGJhY2tvZmYgb2ZmLgogICAqIEBwYXJhbSBvcHRpb25zLndvcmtlciBVc2UgV2ViIFdvcmtlciB0byBzZXQgYSBzaWRlIGZsb3cuIERlZmF1bHRzIHRvIGZhbHNlLgogICAqIEBwYXJhbSBvcHRpb25zLndvcmtlclVybCBUaGUgVVJMIG9mIHRoZSB3b3JrZXIgc2NyaXB0LiBEZWZhdWx0cyB0byBodHRwczovL3JlYWx0aW1lLnN1cGFiYXNlLmNvbS93b3JrZXIuanMgdGhhdCBpbmNsdWRlcyBhIGhlYXJ0YmVhdCBldmVudCBjYWxsIHRvIGtlZXAgdGhlIGNvbm5lY3Rpb24gYWxpdmUuCiAgICogQHBhcmFtIG9wdGlvbnMudnNuIFRoZSBwcm90b2NvbCB2ZXJzaW9uIHRvIHVzZSB3aGVuIGNvbm5lY3RpbmcuIFN1cHBvcnRlZCB2ZXJzaW9ucyBhcmUgIjEuMC4wIiBhbmQgIjIuMC4wIi4gRGVmYXVsdHMgdG8gIjIuMC4wIi4KICAgKiBAZXhhbXBsZQogICAqIGBgYHRzCiAgICogaW1wb3J0IFJlYWx0aW1lQ2xpZW50IGZyb20gJ0BzdXBhYmFzZS9yZWFsdGltZS1qcycKICAgKgogICAqIGNvbnN0IGNsaWVudCA9IG5ldyBSZWFsdGltZUNsaWVudCgnaHR0cHM6Ly94eXpjb21wYW55LnN1cGFiYXNlLmNvL3JlYWx0aW1lL3YxJywgewogICAqICAgcGFyYW1zOiB7IGFwaWtleTogJ3B1YmxpYy1hbm9uLWtleScgfSwKICAgKiB9KQogICAqIGNsaWVudC5jb25uZWN0KCkKICAgKiBgYGAKICAgKi8KICBjb25zdHJ1Y3RvcihlbmRQb2ludCwgb3B0aW9ucykgewogICAgdmFyIF9hOwogICAgdGhpcy5hY2Nlc3NUb2tlblZhbHVlID0gbnVsbDsKICAgIHRoaXMuYXBpS2V5ID0gbnVsbDsKICAgIHRoaXMuX21hbnVhbGx5U2V0VG9rZW4gPSBmYWxzZTsKICAgIHRoaXMuY2hhbm5lbHMgPSBuZXcgQXJyYXkoKTsKICAgIHRoaXMuZW5kUG9pbnQgPSAiIjsKICAgIHRoaXMuaHR0cEVuZHBvaW50ID0gIiI7CiAgICB0aGlzLmhlYWRlcnMgPSB7fTsKICAgIHRoaXMucGFyYW1zID0ge307CiAgICB0aGlzLnRpbWVvdXQgPSBERUZBVUxUX1RJTUVPVVQ7CiAgICB0aGlzLnRyYW5zcG9ydCA9IG51bGw7CiAgICB0aGlzLmhlYXJ0YmVhdEludGVydmFsTXMgPSBDT05ORUNUSU9OX1RJTUVPVVRTLkhFQVJUQkVBVF9JTlRFUlZBTDsKICAgIHRoaXMuaGVhcnRiZWF0VGltZXIgPSB2b2lkIDA7CiAgICB0aGlzLnBlbmRpbmdIZWFydGJlYXRSZWYgPSBudWxsOwogICAgdGhpcy5oZWFydGJlYXRDYWxsYmFjayA9IG5vb3A1OwogICAgdGhpcy5yZWYgPSAwOwogICAgdGhpcy5yZWNvbm5lY3RUaW1lciA9IG51bGw7CiAgICB0aGlzLnZzbiA9IERFRkFVTFRfVlNOOwogICAgdGhpcy5sb2dnZXIgPSBub29wNTsKICAgIHRoaXMuY29ubiA9IG51bGw7CiAgICB0aGlzLnNlbmRCdWZmZXIgPSBbXTsKICAgIHRoaXMuc2VyaWFsaXplciA9IG5ldyBTZXJpYWxpemVyKCk7CiAgICB0aGlzLnN0YXRlQ2hhbmdlQ2FsbGJhY2tzID0gewogICAgICBvcGVuOiBbXSwKICAgICAgY2xvc2U6IFtdLAogICAgICBlcnJvcjogW10sCiAgICAgIG1lc3NhZ2U6IFtdCiAgICB9OwogICAgdGhpcy5hY2Nlc3NUb2tlbiA9IG51bGw7CiAgICB0aGlzLl9jb25uZWN0aW9uU3RhdGUgPSAiZGlzY29ubmVjdGVkIjsKICAgIHRoaXMuX3dhc01hbnVhbERpc2Nvbm5lY3QgPSBmYWxzZTsKICAgIHRoaXMuX2F1dGhQcm9taXNlID0gbnVsbDsKICAgIHRoaXMuX2hlYXJ0YmVhdFNlbnRBdCA9IG51bGw7CiAgICB0aGlzLl9yZXNvbHZlRmV0Y2ggPSAoY3VzdG9tRmV0Y2gpID0+IHsKICAgICAgaWYgKGN1c3RvbUZldGNoKSB7CiAgICAgICAgcmV0dXJuICguLi5hcmdzKSA9PiBjdXN0b21GZXRjaCguLi5hcmdzKTsKICAgICAgfQogICAgICByZXR1cm4gKC4uLmFyZ3MpID0+IGZldGNoKC4uLmFyZ3MpOwogICAgfTsKICAgIGlmICghKChfYSA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5wYXJhbXMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5hcGlrZXkpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiQVBJIGtleSBpcyByZXF1aXJlZCB0byBjb25uZWN0IHRvIFJlYWx0aW1lIik7CiAgICB9CiAgICB0aGlzLmFwaUtleSA9IG9wdGlvbnMucGFyYW1zLmFwaWtleTsKICAgIHRoaXMuZW5kUG9pbnQgPSBgJHtlbmRQb2ludH0vJHtUUkFOU1BPUlRTLndlYnNvY2tldH1gOwogICAgdGhpcy5odHRwRW5kcG9pbnQgPSBodHRwRW5kcG9pbnRVUkwoZW5kUG9pbnQpOwogICAgdGhpcy5faW5pdGlhbGl6ZU9wdGlvbnMob3B0aW9ucyk7CiAgICB0aGlzLl9zZXR1cFJlY29ubmVjdGlvblRpbWVyKCk7CiAgICB0aGlzLmZldGNoID0gdGhpcy5fcmVzb2x2ZUZldGNoKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5mZXRjaCk7CiAgfQogIC8qKgogICAqIENvbm5lY3RzIHRoZSBzb2NrZXQsIHVubGVzcyBhbHJlYWR5IGNvbm5lY3RlZC4KICAgKi8KICBjb25uZWN0KCkgewogICAgaWYgKHRoaXMuaXNDb25uZWN0aW5nKCkgfHwgdGhpcy5pc0Rpc2Nvbm5lY3RpbmcoKSB8fCB0aGlzLmNvbm4gIT09IG51bGwgJiYgdGhpcy5pc0Nvbm5lY3RlZCgpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX3NldENvbm5lY3Rpb25TdGF0ZSgiY29ubmVjdGluZyIpOwogICAgaWYgKHRoaXMuYWNjZXNzVG9rZW4gJiYgIXRoaXMuX2F1dGhQcm9taXNlKSB7CiAgICAgIHRoaXMuX3NldEF1dGhTYWZlbHkoImNvbm5lY3QiKTsKICAgIH0KICAgIGlmICh0aGlzLnRyYW5zcG9ydCkgewogICAgICB0aGlzLmNvbm4gPSBuZXcgdGhpcy50cmFuc3BvcnQodGhpcy5lbmRwb2ludFVSTCgpKTsKICAgIH0gZWxzZSB7CiAgICAgIHRyeSB7CiAgICAgICAgdGhpcy5jb25uID0gd2Vic29ja2V0X2ZhY3RvcnlfZGVmYXVsdC5jcmVhdGVXZWJTb2NrZXQodGhpcy5lbmRwb2ludFVSTCgpKTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICB0aGlzLl9zZXRDb25uZWN0aW9uU3RhdGUoImRpc2Nvbm5lY3RlZCIpOwogICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7CiAgICAgICAgaWYgKGVycm9yTWVzc2FnZS5pbmNsdWRlcygiTm9kZS5qcyIpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7ZXJyb3JNZXNzYWdlfQoKVG8gdXNlIFJlYWx0aW1lIGluIE5vZGUuanMsIHlvdSBuZWVkIHRvIHByb3ZpZGUgYSBXZWJTb2NrZXQgaW1wbGVtZW50YXRpb246CgpPcHRpb24gMTogVXNlIE5vZGUuanMgMjIrIHdoaWNoIGhhcyBuYXRpdmUgV2ViU29ja2V0IHN1cHBvcnQKT3B0aW9uIDI6IEluc3RhbGwgYW5kIHByb3ZpZGUgdGhlICJ3cyIgcGFja2FnZToKCiAgbnBtIGluc3RhbGwgd3MKCiAgaW1wb3J0IHdzIGZyb20gIndzIgogIGNvbnN0IGNsaWVudCA9IG5ldyBSZWFsdGltZUNsaWVudCh1cmwsIHsKICAgIC4uLm9wdGlvbnMsCiAgICB0cmFuc3BvcnQ6IHdzCiAgfSlgKTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBXZWJTb2NrZXQgbm90IGF2YWlsYWJsZTogJHtlcnJvck1lc3NhZ2V9YCk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuX3NldHVwQ29ubmVjdGlvbkhhbmRsZXJzKCk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIFVSTCBvZiB0aGUgd2Vic29ja2V0LgogICAqIEByZXR1cm5zIHN0cmluZyBUaGUgVVJMIG9mIHRoZSB3ZWJzb2NrZXQuCiAgICovCiAgZW5kcG9pbnRVUkwoKSB7CiAgICByZXR1cm4gdGhpcy5fYXBwZW5kUGFyYW1zKHRoaXMuZW5kUG9pbnQsIE9iamVjdC5hc3NpZ24oe30sIHRoaXMucGFyYW1zLCB7IHZzbjogdGhpcy52c24gfSkpOwogIH0KICAvKioKICAgKiBEaXNjb25uZWN0cyB0aGUgc29ja2V0LgogICAqCiAgICogQHBhcmFtIGNvZGUgQSBudW1lcmljIHN0YXR1cyBjb2RlIHRvIHNlbmQgb24gZGlzY29ubmVjdC4KICAgKiBAcGFyYW0gcmVhc29uIEEgY3VzdG9tIHJlYXNvbiBmb3IgdGhlIGRpc2Nvbm5lY3QuCiAgICovCiAgZGlzY29ubmVjdChjb2RlLCByZWFzb24pIHsKICAgIGlmICh0aGlzLmlzRGlzY29ubmVjdGluZygpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX3NldENvbm5lY3Rpb25TdGF0ZSgiZGlzY29ubmVjdGluZyIsIHRydWUpOwogICAgaWYgKHRoaXMuY29ubikgewogICAgICBjb25zdCBmYWxsYmFja1RpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgdGhpcy5fc2V0Q29ubmVjdGlvblN0YXRlKCJkaXNjb25uZWN0ZWQiKTsKICAgICAgfSwgMTAwKTsKICAgICAgdGhpcy5jb25uLm9uY2xvc2UgPSAoKSA9PiB7CiAgICAgICAgY2xlYXJUaW1lb3V0KGZhbGxiYWNrVGltZXIpOwogICAgICAgIHRoaXMuX3NldENvbm5lY3Rpb25TdGF0ZSgiZGlzY29ubmVjdGVkIik7CiAgICAgIH07CiAgICAgIGlmICh0eXBlb2YgdGhpcy5jb25uLmNsb3NlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgaWYgKGNvZGUpIHsKICAgICAgICAgIHRoaXMuY29ubi5jbG9zZShjb2RlLCByZWFzb24gIT09IG51bGwgJiYgcmVhc29uICE9PSB2b2lkIDAgPyByZWFzb24gOiAiIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuY29ubi5jbG9zZSgpOwogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLl90ZWFyZG93bkNvbm5lY3Rpb24oKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuX3NldENvbm5lY3Rpb25TdGF0ZSgiZGlzY29ubmVjdGVkIik7CiAgICB9CiAgfQogIC8qKgogICAqIFJldHVybnMgYWxsIGNyZWF0ZWQgY2hhbm5lbHMKICAgKi8KICBnZXRDaGFubmVscygpIHsKICAgIHJldHVybiB0aGlzLmNoYW5uZWxzOwogIH0KICAvKioKICAgKiBVbnN1YnNjcmliZXMgYW5kIHJlbW92ZXMgYSBzaW5nbGUgY2hhbm5lbAogICAqIEBwYXJhbSBjaGFubmVsIEEgUmVhbHRpbWVDaGFubmVsIGluc3RhbmNlCiAgICovCiAgYXN5bmMgcmVtb3ZlQ2hhbm5lbChjaGFubmVsKSB7CiAgICBjb25zdCBzdGF0dXMgPSBhd2FpdCBjaGFubmVsLnVuc3Vic2NyaWJlKCk7CiAgICBpZiAodGhpcy5jaGFubmVscy5sZW5ndGggPT09IDApIHsKICAgICAgdGhpcy5kaXNjb25uZWN0KCk7CiAgICB9CiAgICByZXR1cm4gc3RhdHVzOwogIH0KICAvKioKICAgKiBVbnN1YnNjcmliZXMgYW5kIHJlbW92ZXMgYWxsIGNoYW5uZWxzCiAgICovCiAgYXN5bmMgcmVtb3ZlQWxsQ2hhbm5lbHMoKSB7CiAgICBjb25zdCB2YWx1ZXNfMSA9IGF3YWl0IFByb21pc2UuYWxsKHRoaXMuY2hhbm5lbHMubWFwKChjaGFubmVsKSA9PiBjaGFubmVsLnVuc3Vic2NyaWJlKCkpKTsKICAgIHRoaXMuY2hhbm5lbHMgPSBbXTsKICAgIHRoaXMuZGlzY29ubmVjdCgpOwogICAgcmV0dXJuIHZhbHVlc18xOwogIH0KICAvKioKICAgKiBMb2dzIHRoZSBtZXNzYWdlLgogICAqCiAgICogRm9yIGN1c3RvbWl6ZWQgbG9nZ2luZywgYHRoaXMubG9nZ2VyYCBjYW4gYmUgb3ZlcnJpZGRlbi4KICAgKi8KICBsb2coa2luZCwgbXNnLCBkYXRhKSB7CiAgICB0aGlzLmxvZ2dlcihraW5kLCBtc2csIGRhdGEpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBzb2NrZXQuCiAgICovCiAgY29ubmVjdGlvblN0YXRlKCkgewogICAgc3dpdGNoICh0aGlzLmNvbm4gJiYgdGhpcy5jb25uLnJlYWR5U3RhdGUpIHsKICAgICAgY2FzZSBTT0NLRVRfU1RBVEVTLmNvbm5lY3Rpbmc6CiAgICAgICAgcmV0dXJuIENPTk5FQ1RJT05fU1RBVEUuQ29ubmVjdGluZzsKICAgICAgY2FzZSBTT0NLRVRfU1RBVEVTLm9wZW46CiAgICAgICAgcmV0dXJuIENPTk5FQ1RJT05fU1RBVEUuT3BlbjsKICAgICAgY2FzZSBTT0NLRVRfU1RBVEVTLmNsb3Npbmc6CiAgICAgICAgcmV0dXJuIENPTk5FQ1RJT05fU1RBVEUuQ2xvc2luZzsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gQ09OTkVDVElPTl9TVEFURS5DbG9zZWQ7CiAgICB9CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlzIHRoZSBjb25uZWN0aW9uIGlzIG9wZW4uCiAgICovCiAgaXNDb25uZWN0ZWQoKSB7CiAgICByZXR1cm4gdGhpcy5jb25uZWN0aW9uU3RhdGUoKSA9PT0gQ09OTkVDVElPTl9TVEFURS5PcGVuOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgY29ubmVjdGlvbiBpcyBjdXJyZW50bHkgY29ubmVjdGluZy4KICAgKi8KICBpc0Nvbm5lY3RpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvblN0YXRlID09PSAiY29ubmVjdGluZyI7CiAgfQogIC8qKgogICAqIFJldHVybnMgYHRydWVgIGlmIHRoZSBjb25uZWN0aW9uIGlzIGN1cnJlbnRseSBkaXNjb25uZWN0aW5nLgogICAqLwogIGlzRGlzY29ubmVjdGluZygpIHsKICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uU3RhdGUgPT09ICJkaXNjb25uZWN0aW5nIjsKICB9CiAgLyoqCiAgICogQ3JlYXRlcyAob3IgcmV1c2VzKSBhIHtAbGluayBSZWFsdGltZUNoYW5uZWx9IGZvciB0aGUgcHJvdmlkZWQgdG9waWMuCiAgICoKICAgKiBUb3BpY3MgYXJlIGF1dG9tYXRpY2FsbHkgcHJlZml4ZWQgd2l0aCBgcmVhbHRpbWU6YCB0byBtYXRjaCB0aGUgUmVhbHRpbWUgc2VydmljZS4KICAgKiBJZiBhIGNoYW5uZWwgd2l0aCB0aGUgc2FtZSB0b3BpYyBhbHJlYWR5IGV4aXN0cyBpdCB3aWxsIGJlIHJldHVybmVkIGluc3RlYWQgb2YgY3JlYXRpbmcKICAgKiBhIGR1cGxpY2F0ZSBjb25uZWN0aW9uLgogICAqLwogIGNoYW5uZWwodG9waWMsIHBhcmFtcyA9IHsgY29uZmlnOiB7fSB9KSB7CiAgICBjb25zdCByZWFsdGltZVRvcGljID0gYHJlYWx0aW1lOiR7dG9waWN9YDsKICAgIGNvbnN0IGV4aXN0cyA9IHRoaXMuZ2V0Q2hhbm5lbHMoKS5maW5kKChjKSA9PiBjLnRvcGljID09PSByZWFsdGltZVRvcGljKTsKICAgIGlmICghZXhpc3RzKSB7CiAgICAgIGNvbnN0IGNoYW4gPSBuZXcgUmVhbHRpbWVDaGFubmVsKGByZWFsdGltZToke3RvcGljfWAsIHBhcmFtcywgdGhpcyk7CiAgICAgIHRoaXMuY2hhbm5lbHMucHVzaChjaGFuKTsKICAgICAgcmV0dXJuIGNoYW47CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZXhpc3RzOwogICAgfQogIH0KICAvKioKICAgKiBQdXNoIG91dCBhIG1lc3NhZ2UgaWYgdGhlIHNvY2tldCBpcyBjb25uZWN0ZWQuCiAgICoKICAgKiBJZiB0aGUgc29ja2V0IGlzIG5vdCBjb25uZWN0ZWQsIHRoZSBtZXNzYWdlIGdldHMgZW5xdWV1ZWQgd2l0aGluIGEgbG9jYWwgYnVmZmVyLCBhbmQgc2VudCBvdXQgd2hlbiBhIGNvbm5lY3Rpb24gaXMgbmV4dCBlc3RhYmxpc2hlZC4KICAgKi8KICBwdXNoKGRhdGEpIHsKICAgIGNvbnN0IHsgdG9waWMsIGV2ZW50LCBwYXlsb2FkLCByZWYgfSA9IGRhdGE7CiAgICBjb25zdCBjYWxsYmFjayA9ICgpID0+IHsKICAgICAgdGhpcy5lbmNvZGUoZGF0YSwgKHJlc3VsdCkgPT4gewogICAgICAgIHZhciBfYTsKICAgICAgICAoX2EgPSB0aGlzLmNvbm4pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zZW5kKHJlc3VsdCk7CiAgICAgIH0pOwogICAgfTsKICAgIHRoaXMubG9nKCJwdXNoIiwgYCR7dG9waWN9ICR7ZXZlbnR9ICgke3JlZn0pYCwgcGF5bG9hZCk7CiAgICBpZiAodGhpcy5pc0Nvbm5lY3RlZCgpKSB7CiAgICAgIGNhbGxiYWNrKCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnNlbmRCdWZmZXIucHVzaChjYWxsYmFjayk7CiAgICB9CiAgfQogIC8qKgogICAqIFNldHMgdGhlIEpXVCBhY2Nlc3MgdG9rZW4gdXNlZCBmb3IgY2hhbm5lbCBzdWJzY3JpcHRpb24gYXV0aG9yaXphdGlvbiBhbmQgUmVhbHRpbWUgUkxTLgogICAqCiAgICogSWYgcGFyYW0gaXMgbnVsbCBpdCB3aWxsIHVzZSB0aGUgYGFjY2Vzc1Rva2VuYCBjYWxsYmFjayBmdW5jdGlvbiBvciB0aGUgdG9rZW4gc2V0IG9uIHRoZSBjbGllbnQuCiAgICoKICAgKiBPbiBjYWxsYmFjayB1c2VkLCBpdCB3aWxsIHNldCB0aGUgdmFsdWUgb2YgdGhlIHRva2VuIGludGVybmFsIHRvIHRoZSBjbGllbnQuCiAgICoKICAgKiBXaGVuIGEgdG9rZW4gaXMgZXhwbGljaXRseSBwcm92aWRlZCwgaXQgd2lsbCBiZSBwcmVzZXJ2ZWQgYWNyb3NzIGNoYW5uZWwgb3BlcmF0aW9ucwogICAqIChpbmNsdWRpbmcgcmVtb3ZlQ2hhbm5lbCBhbmQgcmVzdWJzY3JpYmUpLiBUaGUgYGFjY2Vzc1Rva2VuYCBjYWxsYmFjayB3aWxsIG5vdCBiZQogICAqIGludm9rZWQgdW50aWwgYHNldEF1dGgoKWAgaXMgY2FsbGVkIHdpdGhvdXQgYXJndW1lbnRzLgogICAqCiAgICogQHBhcmFtIHRva2VuIEEgSldUIHN0cmluZyB0byBvdmVycmlkZSB0aGUgdG9rZW4gc2V0IG9uIHRoZSBjbGllbnQuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIC8vIFVzZSBhIG1hbnVhbCB0b2tlbiAocHJlc2VydmVkIGFjcm9zcyByZXN1YnNjcmliZXMsIGlnbm9yZXMgYWNjZXNzVG9rZW4gY2FsbGJhY2spCiAgICogY2xpZW50LnJlYWx0aW1lLnNldEF1dGgoJ215LWN1c3RvbS1qd3QnKQogICAqCiAgICogLy8gU3dpdGNoIGJhY2sgdG8gdXNpbmcgdGhlIGFjY2Vzc1Rva2VuIGNhbGxiYWNrCiAgICogY2xpZW50LnJlYWx0aW1lLnNldEF1dGgoKQogICAqLwogIGFzeW5jIHNldEF1dGgodG9rZW4gPSBudWxsKSB7CiAgICB0aGlzLl9hdXRoUHJvbWlzZSA9IHRoaXMuX3BlcmZvcm1BdXRoKHRva2VuKTsKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuX2F1dGhQcm9taXNlOwogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fYXV0aFByb21pc2UgPSBudWxsOwogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGN1cnJlbnQgYWNjZXNzIHRva2VuIHdhcyBleHBsaWNpdGx5IHNldCB2aWEgc2V0QXV0aCh0b2tlbiksCiAgICogZmFsc2UgaWYgaXQgd2FzIG9idGFpbmVkIHZpYSB0aGUgYWNjZXNzVG9rZW4gY2FsbGJhY2suCiAgICogQGludGVybmFsCiAgICovCiAgX2lzTWFudWFsVG9rZW4oKSB7CiAgICByZXR1cm4gdGhpcy5fbWFudWFsbHlTZXRUb2tlbjsKICB9CiAgLyoqCiAgICogU2VuZHMgYSBoZWFydGJlYXQgbWVzc2FnZSBpZiB0aGUgc29ja2V0IGlzIGNvbm5lY3RlZC4KICAgKi8KICBhc3luYyBzZW5kSGVhcnRiZWF0KCkgewogICAgdmFyIF9hOwogICAgaWYgKCF0aGlzLmlzQ29ubmVjdGVkKCkpIHsKICAgICAgdHJ5IHsKICAgICAgICB0aGlzLmhlYXJ0YmVhdENhbGxiYWNrKCJkaXNjb25uZWN0ZWQiKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHRoaXMubG9nKCJlcnJvciIsICJlcnJvciBpbiBoZWFydGJlYXQgY2FsbGJhY2siLCBlKTsKICAgICAgfQogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAodGhpcy5wZW5kaW5nSGVhcnRiZWF0UmVmKSB7CiAgICAgIHRoaXMucGVuZGluZ0hlYXJ0YmVhdFJlZiA9IG51bGw7CiAgICAgIHRoaXMuX2hlYXJ0YmVhdFNlbnRBdCA9IG51bGw7CiAgICAgIHRoaXMubG9nKCJ0cmFuc3BvcnQiLCAiaGVhcnRiZWF0IHRpbWVvdXQuIEF0dGVtcHRpbmcgdG8gcmUtZXN0YWJsaXNoIGNvbm5lY3Rpb24iKTsKICAgICAgdHJ5IHsKICAgICAgICB0aGlzLmhlYXJ0YmVhdENhbGxiYWNrKCJ0aW1lb3V0Iik7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB0aGlzLmxvZygiZXJyb3IiLCAiZXJyb3IgaW4gaGVhcnRiZWF0IGNhbGxiYWNrIiwgZSk7CiAgICAgIH0KICAgICAgdGhpcy5fd2FzTWFudWFsRGlzY29ubmVjdCA9IGZhbHNlOwogICAgICAoX2EgPSB0aGlzLmNvbm4pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jbG9zZShXU19DTE9TRV9OT1JNQUwsICJoZWFydGJlYXQgdGltZW91dCIpOwogICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICB2YXIgX2EyOwogICAgICAgIGlmICghdGhpcy5pc0Nvbm5lY3RlZCgpKSB7CiAgICAgICAgICAoX2EyID0gdGhpcy5yZWNvbm5lY3RUaW1lcikgPT09IG51bGwgfHwgX2EyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYTIuc2NoZWR1bGVUaW1lb3V0KCk7CiAgICAgICAgfQogICAgICB9LCBDT05ORUNUSU9OX1RJTUVPVVRTLkhFQVJUQkVBVF9USU1FT1VUX0ZBTExCQUNLKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5faGVhcnRiZWF0U2VudEF0ID0gRGF0ZS5ub3coKTsKICAgIHRoaXMucGVuZGluZ0hlYXJ0YmVhdFJlZiA9IHRoaXMuX21ha2VSZWYoKTsKICAgIHRoaXMucHVzaCh7CiAgICAgIHRvcGljOiAicGhvZW5peCIsCiAgICAgIGV2ZW50OiAiaGVhcnRiZWF0IiwKICAgICAgcGF5bG9hZDoge30sCiAgICAgIHJlZjogdGhpcy5wZW5kaW5nSGVhcnRiZWF0UmVmCiAgICB9KTsKICAgIHRyeSB7CiAgICAgIHRoaXMuaGVhcnRiZWF0Q2FsbGJhY2soInNlbnQiKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgdGhpcy5sb2coImVycm9yIiwgImVycm9yIGluIGhlYXJ0YmVhdCBjYWxsYmFjayIsIGUpOwogICAgfQogICAgdGhpcy5fc2V0QXV0aFNhZmVseSgiaGVhcnRiZWF0Iik7CiAgfQogIC8qKgogICAqIFNldHMgYSBjYWxsYmFjayB0aGF0IHJlY2VpdmVzIGxpZmVjeWNsZSBldmVudHMgZm9yIGludGVybmFsIGhlYXJ0YmVhdCBtZXNzYWdlcy4KICAgKiBVc2VmdWwgZm9yIGluc3RydW1lbnRpbmcgY29ubmVjdGlvbiBoZWFsdGggKGUuZy4gc2VudC9vay90aW1lb3V0L2Rpc2Nvbm5lY3RlZCkuCiAgICovCiAgb25IZWFydGJlYXQoY2FsbGJhY2spIHsKICAgIHRoaXMuaGVhcnRiZWF0Q2FsbGJhY2sgPSBjYWxsYmFjazsKICB9CiAgLyoqCiAgICogRmx1c2hlcyBzZW5kIGJ1ZmZlcgogICAqLwogIGZsdXNoU2VuZEJ1ZmZlcigpIHsKICAgIGlmICh0aGlzLmlzQ29ubmVjdGVkKCkgJiYgdGhpcy5zZW5kQnVmZmVyLmxlbmd0aCA+IDApIHsKICAgICAgdGhpcy5zZW5kQnVmZmVyLmZvckVhY2goKGNhbGxiYWNrKSA9PiBjYWxsYmFjaygpKTsKICAgICAgdGhpcy5zZW5kQnVmZmVyID0gW107CiAgICB9CiAgfQogIC8qKgogICAqIFJldHVybiB0aGUgbmV4dCBtZXNzYWdlIHJlZiwgYWNjb3VudGluZyBmb3Igb3ZlcmZsb3dzCiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KICBfbWFrZVJlZigpIHsKICAgIGxldCBuZXdSZWYgPSB0aGlzLnJlZiArIDE7CiAgICBpZiAobmV3UmVmID09PSB0aGlzLnJlZikgewogICAgICB0aGlzLnJlZiA9IDA7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnJlZiA9IG5ld1JlZjsKICAgIH0KICAgIHJldHVybiB0aGlzLnJlZi50b1N0cmluZygpOwogIH0KICAvKioKICAgKiBVbnN1YnNjcmliZSBmcm9tIGNoYW5uZWxzIHdpdGggdGhlIHNwZWNpZmllZCB0b3BpYy4KICAgKgogICAqIEBpbnRlcm5hbAogICAqLwogIF9sZWF2ZU9wZW5Ub3BpYyh0b3BpYykgewogICAgbGV0IGR1cENoYW5uZWwgPSB0aGlzLmNoYW5uZWxzLmZpbmQoKGMpID0+IGMudG9waWMgPT09IHRvcGljICYmIChjLl9pc0pvaW5lZCgpIHx8IGMuX2lzSm9pbmluZygpKSk7CiAgICBpZiAoZHVwQ2hhbm5lbCkgewogICAgICB0aGlzLmxvZygidHJhbnNwb3J0IiwgYGxlYXZpbmcgZHVwbGljYXRlIHRvcGljICIke3RvcGljfSJgKTsKICAgICAgZHVwQ2hhbm5lbC51bnN1YnNjcmliZSgpOwogICAgfQogIH0KICAvKioKICAgKiBSZW1vdmVzIGEgc3Vic2NyaXB0aW9uIGZyb20gdGhlIHNvY2tldC4KICAgKgogICAqIEBwYXJhbSBjaGFubmVsIEFuIG9wZW4gc3Vic2NyaXB0aW9uLgogICAqCiAgICogQGludGVybmFsCiAgICovCiAgX3JlbW92ZShjaGFubmVsKSB7CiAgICB0aGlzLmNoYW5uZWxzID0gdGhpcy5jaGFubmVscy5maWx0ZXIoKGMpID0+IGMudG9waWMgIT09IGNoYW5uZWwudG9waWMpOwogIH0KICAvKiogQGludGVybmFsICovCiAgX29uQ29ubk1lc3NhZ2UocmF3TWVzc2FnZSkgewogICAgdGhpcy5kZWNvZGUocmF3TWVzc2FnZS5kYXRhLCAobXNnKSA9PiB7CiAgICAgIGlmIChtc2cudG9waWMgPT09ICJwaG9lbml4IiAmJiBtc2cuZXZlbnQgPT09ICJwaHhfcmVwbHkiICYmIG1zZy5yZWYgJiYgbXNnLnJlZiA9PT0gdGhpcy5wZW5kaW5nSGVhcnRiZWF0UmVmKSB7CiAgICAgICAgY29uc3QgbGF0ZW5jeSA9IHRoaXMuX2hlYXJ0YmVhdFNlbnRBdCA/IERhdGUubm93KCkgLSB0aGlzLl9oZWFydGJlYXRTZW50QXQgOiB2b2lkIDA7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHRoaXMuaGVhcnRiZWF0Q2FsbGJhY2sobXNnLnBheWxvYWQuc3RhdHVzID09PSAib2siID8gIm9rIiA6ICJlcnJvciIsIGxhdGVuY3kpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHRoaXMubG9nKCJlcnJvciIsICJlcnJvciBpbiBoZWFydGJlYXQgY2FsbGJhY2siLCBlKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5faGVhcnRiZWF0U2VudEF0ID0gbnVsbDsKICAgICAgICB0aGlzLnBlbmRpbmdIZWFydGJlYXRSZWYgPSBudWxsOwogICAgICB9CiAgICAgIGNvbnN0IHsgdG9waWMsIGV2ZW50LCBwYXlsb2FkLCByZWYgfSA9IG1zZzsKICAgICAgY29uc3QgcmVmU3RyaW5nID0gcmVmID8gYCgke3JlZn0pYCA6ICIiOwogICAgICBjb25zdCBzdGF0dXMgPSBwYXlsb2FkLnN0YXR1cyB8fCAiIjsKICAgICAgdGhpcy5sb2coInJlY2VpdmUiLCBgJHtzdGF0dXN9ICR7dG9waWN9ICR7ZXZlbnR9ICR7cmVmU3RyaW5nfWAudHJpbSgpLCBwYXlsb2FkKTsKICAgICAgdGhpcy5jaGFubmVscy5maWx0ZXIoKGNoYW5uZWwpID0+IGNoYW5uZWwuX2lzTWVtYmVyKHRvcGljKSkuZm9yRWFjaCgoY2hhbm5lbCkgPT4gY2hhbm5lbC5fdHJpZ2dlcihldmVudCwgcGF5bG9hZCwgcmVmKSk7CiAgICAgIHRoaXMuX3RyaWdnZXJTdGF0ZUNhbGxiYWNrcygibWVzc2FnZSIsIG1zZyk7CiAgICB9KTsKICB9CiAgLyoqCiAgICogQ2xlYXIgc3BlY2lmaWMgdGltZXIKICAgKiBAaW50ZXJuYWwKICAgKi8KICBfY2xlYXJUaW1lcih0aW1lcikgewogICAgdmFyIF9hOwogICAgaWYgKHRpbWVyID09PSAiaGVhcnRiZWF0IiAmJiB0aGlzLmhlYXJ0YmVhdFRpbWVyKSB7CiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5oZWFydGJlYXRUaW1lcik7CiAgICAgIHRoaXMuaGVhcnRiZWF0VGltZXIgPSB2b2lkIDA7CiAgICB9IGVsc2UgaWYgKHRpbWVyID09PSAicmVjb25uZWN0IikgewogICAgICAoX2EgPSB0aGlzLnJlY29ubmVjdFRpbWVyKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucmVzZXQoKTsKICAgIH0KICB9CiAgLyoqCiAgICogQ2xlYXIgYWxsIHRpbWVycwogICAqIEBpbnRlcm5hbAogICAqLwogIF9jbGVhckFsbFRpbWVycygpIHsKICAgIHRoaXMuX2NsZWFyVGltZXIoImhlYXJ0YmVhdCIpOwogICAgdGhpcy5fY2xlYXJUaW1lcigicmVjb25uZWN0Iik7CiAgfQogIC8qKgogICAqIFNldHVwIGNvbm5lY3Rpb24gaGFuZGxlcnMgZm9yIFdlYlNvY2tldCBldmVudHMKICAgKiBAaW50ZXJuYWwKICAgKi8KICBfc2V0dXBDb25uZWN0aW9uSGFuZGxlcnMoKSB7CiAgICBpZiAoIXRoaXMuY29ubikKICAgICAgcmV0dXJuOwogICAgaWYgKCJiaW5hcnlUeXBlIiBpbiB0aGlzLmNvbm4pIHsKICAgICAgOwogICAgICB0aGlzLmNvbm4uYmluYXJ5VHlwZSA9ICJhcnJheWJ1ZmZlciI7CiAgICB9CiAgICB0aGlzLmNvbm4ub25vcGVuID0gKCkgPT4gdGhpcy5fb25Db25uT3BlbigpOwogICAgdGhpcy5jb25uLm9uZXJyb3IgPSAoZXJyb3IpID0+IHRoaXMuX29uQ29ubkVycm9yKGVycm9yKTsKICAgIHRoaXMuY29ubi5vbm1lc3NhZ2UgPSAoZXZlbnQpID0+IHRoaXMuX29uQ29ubk1lc3NhZ2UoZXZlbnQpOwogICAgdGhpcy5jb25uLm9uY2xvc2UgPSAoZXZlbnQpID0+IHRoaXMuX29uQ29ubkNsb3NlKGV2ZW50KTsKICAgIGlmICh0aGlzLmNvbm4ucmVhZHlTdGF0ZSA9PT0gU09DS0VUX1NUQVRFUy5vcGVuKSB7CiAgICAgIHRoaXMuX29uQ29ubk9wZW4oKTsKICAgIH0KICB9CiAgLyoqCiAgICogVGVhcmRvd24gY29ubmVjdGlvbiBhbmQgY2xlYW51cCByZXNvdXJjZXMKICAgKiBAaW50ZXJuYWwKICAgKi8KICBfdGVhcmRvd25Db25uZWN0aW9uKCkgewogICAgaWYgKHRoaXMuY29ubikgewogICAgICBpZiAodGhpcy5jb25uLnJlYWR5U3RhdGUgPT09IFNPQ0tFVF9TVEFURVMub3BlbiB8fCB0aGlzLmNvbm4ucmVhZHlTdGF0ZSA9PT0gU09DS0VUX1NUQVRFUy5jb25uZWN0aW5nKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHRoaXMuY29ubi5jbG9zZSgpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHRoaXMubG9nKCJlcnJvciIsICJFcnJvciBjbG9zaW5nIGNvbm5lY3Rpb24iLCBlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5jb25uLm9ub3BlbiA9IG51bGw7CiAgICAgIHRoaXMuY29ubi5vbmVycm9yID0gbnVsbDsKICAgICAgdGhpcy5jb25uLm9ubWVzc2FnZSA9IG51bGw7CiAgICAgIHRoaXMuY29ubi5vbmNsb3NlID0gbnVsbDsKICAgICAgdGhpcy5jb25uID0gbnVsbDsKICAgIH0KICAgIHRoaXMuX2NsZWFyQWxsVGltZXJzKCk7CiAgICB0aGlzLl90ZXJtaW5hdGVXb3JrZXIoKTsKICAgIHRoaXMuY2hhbm5lbHMuZm9yRWFjaCgoY2hhbm5lbCkgPT4gY2hhbm5lbC50ZWFyZG93bigpKTsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIF9vbkNvbm5PcGVuKCkgewogICAgdGhpcy5fc2V0Q29ubmVjdGlvblN0YXRlKCJjb25uZWN0ZWQiKTsKICAgIHRoaXMubG9nKCJ0cmFuc3BvcnQiLCBgY29ubmVjdGVkIHRvICR7dGhpcy5lbmRwb2ludFVSTCgpfWApOwogICAgY29uc3QgYXV0aFByb21pc2UgPSB0aGlzLl9hdXRoUHJvbWlzZSB8fCAodGhpcy5hY2Nlc3NUb2tlbiAmJiAhdGhpcy5hY2Nlc3NUb2tlblZhbHVlID8gdGhpcy5zZXRBdXRoKCkgOiBQcm9taXNlLnJlc29sdmUoKSk7CiAgICBhdXRoUHJvbWlzZS50aGVuKCgpID0+IHsKICAgICAgdGhpcy5mbHVzaFNlbmRCdWZmZXIoKTsKICAgIH0pLmNhdGNoKChlKSA9PiB7CiAgICAgIHRoaXMubG9nKCJlcnJvciIsICJlcnJvciB3YWl0aW5nIGZvciBhdXRoIG9uIGNvbm5lY3QiLCBlKTsKICAgICAgdGhpcy5mbHVzaFNlbmRCdWZmZXIoKTsKICAgIH0pOwogICAgdGhpcy5fY2xlYXJUaW1lcigicmVjb25uZWN0Iik7CiAgICBpZiAoIXRoaXMud29ya2VyKSB7CiAgICAgIHRoaXMuX3N0YXJ0SGVhcnRiZWF0KCk7CiAgICB9IGVsc2UgewogICAgICBpZiAoIXRoaXMud29ya2VyUmVmKSB7CiAgICAgICAgdGhpcy5fc3RhcnRXb3JrZXJIZWFydGJlYXQoKTsKICAgICAgfQogICAgfQogICAgdGhpcy5fdHJpZ2dlclN0YXRlQ2FsbGJhY2tzKCJvcGVuIik7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfc3RhcnRIZWFydGJlYXQoKSB7CiAgICB0aGlzLmhlYXJ0YmVhdFRpbWVyICYmIGNsZWFySW50ZXJ2YWwodGhpcy5oZWFydGJlYXRUaW1lcik7CiAgICB0aGlzLmhlYXJ0YmVhdFRpbWVyID0gc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5zZW5kSGVhcnRiZWF0KCksIHRoaXMuaGVhcnRiZWF0SW50ZXJ2YWxNcyk7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfc3RhcnRXb3JrZXJIZWFydGJlYXQoKSB7CiAgICBpZiAodGhpcy53b3JrZXJVcmwpIHsKICAgICAgdGhpcy5sb2coIndvcmtlciIsIGBzdGFydGluZyB3b3JrZXIgZm9yIGZyb20gJHt0aGlzLndvcmtlclVybH1gKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMubG9nKCJ3b3JrZXIiLCBgc3RhcnRpbmcgZGVmYXVsdCB3b3JrZXJgKTsKICAgIH0KICAgIGNvbnN0IG9iamVjdFVybCA9IHRoaXMuX3dvcmtlck9iamVjdFVybCh0aGlzLndvcmtlclVybCk7CiAgICB0aGlzLndvcmtlclJlZiA9IG5ldyBXb3JrZXIob2JqZWN0VXJsKTsKICAgIHRoaXMud29ya2VyUmVmLm9uZXJyb3IgPSAoZXJyb3IpID0+IHsKICAgICAgdGhpcy5sb2coIndvcmtlciIsICJ3b3JrZXIgZXJyb3IiLCBlcnJvci5tZXNzYWdlKTsKICAgICAgdGhpcy5fdGVybWluYXRlV29ya2VyKCk7CiAgICB9OwogICAgdGhpcy53b3JrZXJSZWYub25tZXNzYWdlID0gKGV2ZW50KSA9PiB7CiAgICAgIGlmIChldmVudC5kYXRhLmV2ZW50ID09PSAia2VlcEFsaXZlIikgewogICAgICAgIHRoaXMuc2VuZEhlYXJ0YmVhdCgpOwogICAgICB9CiAgICB9OwogICAgdGhpcy53b3JrZXJSZWYucG9zdE1lc3NhZ2UoewogICAgICBldmVudDogInN0YXJ0IiwKICAgICAgaW50ZXJ2YWw6IHRoaXMuaGVhcnRiZWF0SW50ZXJ2YWxNcwogICAgfSk7CiAgfQogIC8qKgogICAqIFRlcm1pbmF0ZSB0aGUgV2ViIFdvcmtlciBhbmQgY2xlYXIgdGhlIHJlZmVyZW5jZQogICAqIEBpbnRlcm5hbAogICAqLwogIF90ZXJtaW5hdGVXb3JrZXIoKSB7CiAgICBpZiAodGhpcy53b3JrZXJSZWYpIHsKICAgICAgdGhpcy5sb2coIndvcmtlciIsICJ0ZXJtaW5hdGluZyB3b3JrZXIiKTsKICAgICAgdGhpcy53b3JrZXJSZWYudGVybWluYXRlKCk7CiAgICAgIHRoaXMud29ya2VyUmVmID0gdm9pZCAwOwogICAgfQogIH0KICAvKiogQGludGVybmFsICovCiAgX29uQ29ubkNsb3NlKGV2ZW50KSB7CiAgICB2YXIgX2E7CiAgICB0aGlzLl9zZXRDb25uZWN0aW9uU3RhdGUoImRpc2Nvbm5lY3RlZCIpOwogICAgdGhpcy5sb2coInRyYW5zcG9ydCIsICJjbG9zZSIsIGV2ZW50KTsKICAgIHRoaXMuX3RyaWdnZXJDaGFuRXJyb3IoKTsKICAgIHRoaXMuX2NsZWFyVGltZXIoImhlYXJ0YmVhdCIpOwogICAgaWYgKCF0aGlzLl93YXNNYW51YWxEaXNjb25uZWN0KSB7CiAgICAgIChfYSA9IHRoaXMucmVjb25uZWN0VGltZXIpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5zY2hlZHVsZVRpbWVvdXQoKTsKICAgIH0KICAgIHRoaXMuX3RyaWdnZXJTdGF0ZUNhbGxiYWNrcygiY2xvc2UiLCBldmVudCk7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfb25Db25uRXJyb3IoZXJyb3IpIHsKICAgIHRoaXMuX3NldENvbm5lY3Rpb25TdGF0ZSgiZGlzY29ubmVjdGVkIik7CiAgICB0aGlzLmxvZygidHJhbnNwb3J0IiwgYCR7ZXJyb3J9YCk7CiAgICB0aGlzLl90cmlnZ2VyQ2hhbkVycm9yKCk7CiAgICB0aGlzLl90cmlnZ2VyU3RhdGVDYWxsYmFja3MoImVycm9yIiwgZXJyb3IpOwogICAgdHJ5IHsKICAgICAgdGhpcy5oZWFydGJlYXRDYWxsYmFjaygiZXJyb3IiKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgdGhpcy5sb2coImVycm9yIiwgImVycm9yIGluIGhlYXJ0YmVhdCBjYWxsYmFjayIsIGUpOwogICAgfQogIH0KICAvKiogQGludGVybmFsICovCiAgX3RyaWdnZXJDaGFuRXJyb3IoKSB7CiAgICB0aGlzLmNoYW5uZWxzLmZvckVhY2goKGNoYW5uZWwpID0+IGNoYW5uZWwuX3RyaWdnZXIoQ0hBTk5FTF9FVkVOVFMuZXJyb3IpKTsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIF9hcHBlbmRQYXJhbXModXJsLCBwYXJhbXMpIHsKICAgIGlmIChPYmplY3Qua2V5cyhwYXJhbXMpLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gdXJsOwogICAgfQogICAgY29uc3QgcHJlZml4ID0gdXJsLm1hdGNoKC9cPy8pID8gIiYiIDogIj8iOwogICAgY29uc3QgcXVlcnkgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHBhcmFtcyk7CiAgICByZXR1cm4gYCR7dXJsfSR7cHJlZml4fSR7cXVlcnl9YDsKICB9CiAgX3dvcmtlck9iamVjdFVybCh1cmwpIHsKICAgIGxldCByZXN1bHRfdXJsOwogICAgaWYgKHVybCkgewogICAgICByZXN1bHRfdXJsID0gdXJsOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFtXT1JLRVJfU0NSSVBUXSwgeyB0eXBlOiAiYXBwbGljYXRpb24vamF2YXNjcmlwdCIgfSk7CiAgICAgIHJlc3VsdF91cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogICAgfQogICAgcmV0dXJuIHJlc3VsdF91cmw7CiAgfQogIC8qKgogICAqIFNldCBjb25uZWN0aW9uIHN0YXRlIHdpdGggcHJvcGVyIHN0YXRlIG1hbmFnZW1lbnQKICAgKiBAaW50ZXJuYWwKICAgKi8KICBfc2V0Q29ubmVjdGlvblN0YXRlKHN0YXRlLCBtYW51YWwgPSBmYWxzZSkgewogICAgdGhpcy5fY29ubmVjdGlvblN0YXRlID0gc3RhdGU7CiAgICBpZiAoc3RhdGUgPT09ICJjb25uZWN0aW5nIikgewogICAgICB0aGlzLl93YXNNYW51YWxEaXNjb25uZWN0ID0gZmFsc2U7CiAgICB9IGVsc2UgaWYgKHN0YXRlID09PSAiZGlzY29ubmVjdGluZyIpIHsKICAgICAgdGhpcy5fd2FzTWFudWFsRGlzY29ubmVjdCA9IG1hbnVhbDsKICAgIH0KICB9CiAgLyoqCiAgICogUGVyZm9ybSB0aGUgYWN0dWFsIGF1dGggb3BlcmF0aW9uCiAgICogQGludGVybmFsCiAgICovCiAgYXN5bmMgX3BlcmZvcm1BdXRoKHRva2VuID0gbnVsbCkgewogICAgbGV0IHRva2VuVG9TZW5kOwogICAgbGV0IGlzTWFudWFsVG9rZW4gPSBmYWxzZTsKICAgIGlmICh0b2tlbikgewogICAgICB0b2tlblRvU2VuZCA9IHRva2VuOwogICAgICBpc01hbnVhbFRva2VuID0gdHJ1ZTsKICAgIH0gZWxzZSBpZiAodGhpcy5hY2Nlc3NUb2tlbikgewogICAgICB0cnkgewogICAgICAgIHRva2VuVG9TZW5kID0gYXdhaXQgdGhpcy5hY2Nlc3NUb2tlbigpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgdGhpcy5sb2coImVycm9yIiwgIkVycm9yIGZldGNoaW5nIGFjY2VzcyB0b2tlbiBmcm9tIGNhbGxiYWNrIiwgZSk7CiAgICAgICAgdG9rZW5Ub1NlbmQgPSB0aGlzLmFjY2Vzc1Rva2VuVmFsdWU7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRva2VuVG9TZW5kID0gdGhpcy5hY2Nlc3NUb2tlblZhbHVlOwogICAgfQogICAgaWYgKGlzTWFudWFsVG9rZW4pIHsKICAgICAgdGhpcy5fbWFudWFsbHlTZXRUb2tlbiA9IHRydWU7CiAgICB9IGVsc2UgaWYgKHRoaXMuYWNjZXNzVG9rZW4pIHsKICAgICAgdGhpcy5fbWFudWFsbHlTZXRUb2tlbiA9IGZhbHNlOwogICAgfQogICAgaWYgKHRoaXMuYWNjZXNzVG9rZW5WYWx1ZSAhPSB0b2tlblRvU2VuZCkgewogICAgICB0aGlzLmFjY2Vzc1Rva2VuVmFsdWUgPSB0b2tlblRvU2VuZDsKICAgICAgdGhpcy5jaGFubmVscy5mb3JFYWNoKChjaGFubmVsKSA9PiB7CiAgICAgICAgY29uc3QgcGF5bG9hZCA9IHsKICAgICAgICAgIGFjY2Vzc190b2tlbjogdG9rZW5Ub1NlbmQsCiAgICAgICAgICB2ZXJzaW9uOiBERUZBVUxUX1ZFUlNJT04KICAgICAgICB9OwogICAgICAgIHRva2VuVG9TZW5kICYmIGNoYW5uZWwudXBkYXRlSm9pblBheWxvYWQocGF5bG9hZCk7CiAgICAgICAgaWYgKGNoYW5uZWwuam9pbmVkT25jZSAmJiBjaGFubmVsLl9pc0pvaW5lZCgpKSB7CiAgICAgICAgICBjaGFubmVsLl9wdXNoKENIQU5ORUxfRVZFTlRTLmFjY2Vzc190b2tlbiwgewogICAgICAgICAgICBhY2Nlc3NfdG9rZW46IHRva2VuVG9TZW5kCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0KICAvKioKICAgKiBXYWl0IGZvciBhbnkgaW4tZmxpZ2h0IGF1dGggb3BlcmF0aW9ucyB0byBjb21wbGV0ZQogICAqIEBpbnRlcm5hbAogICAqLwogIGFzeW5jIF93YWl0Rm9yQXV0aElmTmVlZGVkKCkgewogICAgaWYgKHRoaXMuX2F1dGhQcm9taXNlKSB7CiAgICAgIGF3YWl0IHRoaXMuX2F1dGhQcm9taXNlOwogICAgfQogIH0KICAvKioKICAgKiBTYWZlbHkgY2FsbCBzZXRBdXRoIHdpdGggc3RhbmRhcmRpemVkIGVycm9yIGhhbmRsaW5nCiAgICogQGludGVybmFsCiAgICovCiAgX3NldEF1dGhTYWZlbHkoY29udGV4dCA9ICJnZW5lcmFsIikgewogICAgaWYgKCF0aGlzLl9pc01hbnVhbFRva2VuKCkpIHsKICAgICAgdGhpcy5zZXRBdXRoKCkuY2F0Y2goKGUpID0+IHsKICAgICAgICB0aGlzLmxvZygiZXJyb3IiLCBgRXJyb3Igc2V0dGluZyBhdXRoIGluICR7Y29udGV4dH1gLCBlKTsKICAgICAgfSk7CiAgICB9CiAgfQogIC8qKgogICAqIFRyaWdnZXIgc3RhdGUgY2hhbmdlIGNhbGxiYWNrcyB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZwogICAqIEBpbnRlcm5hbAogICAqLwogIF90cmlnZ2VyU3RhdGVDYWxsYmFja3MoZXZlbnQsIGRhdGEpIHsKICAgIHRyeSB7CiAgICAgIHRoaXMuc3RhdGVDaGFuZ2VDYWxsYmFja3NbZXZlbnRdLmZvckVhY2goKGNhbGxiYWNrKSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNhbGxiYWNrKGRhdGEpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHRoaXMubG9nKCJlcnJvciIsIGBlcnJvciBpbiAke2V2ZW50fSBjYWxsYmFja2AsIGUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHRoaXMubG9nKCJlcnJvciIsIGBlcnJvciB0cmlnZ2VyaW5nICR7ZXZlbnR9IGNhbGxiYWNrc2AsIGUpOwogICAgfQogIH0KICAvKioKICAgKiBTZXR1cCByZWNvbm5lY3Rpb24gdGltZXIgd2l0aCBwcm9wZXIgY29uZmlndXJhdGlvbgogICAqIEBpbnRlcm5hbAogICAqLwogIF9zZXR1cFJlY29ubmVjdGlvblRpbWVyKCkgewogICAgdGhpcy5yZWNvbm5lY3RUaW1lciA9IG5ldyBUaW1lcihhc3luYyAoKSA9PiB7CiAgICAgIHNldFRpbWVvdXQoYXN5bmMgKCkgPT4gewogICAgICAgIGF3YWl0IHRoaXMuX3dhaXRGb3JBdXRoSWZOZWVkZWQoKTsKICAgICAgICBpZiAoIXRoaXMuaXNDb25uZWN0ZWQoKSkgewogICAgICAgICAgdGhpcy5jb25uZWN0KCk7CiAgICAgICAgfQogICAgICB9LCBDT05ORUNUSU9OX1RJTUVPVVRTLlJFQ09OTkVDVF9ERUxBWSk7CiAgICB9LCB0aGlzLnJlY29ubmVjdEFmdGVyTXMpOwogIH0KICAvKioKICAgKiBJbml0aWFsaXplIGNsaWVudCBvcHRpb25zIHdpdGggZGVmYXVsdHMKICAgKiBAaW50ZXJuYWwKICAgKi8KICBfaW5pdGlhbGl6ZU9wdGlvbnMob3B0aW9ucykgewogICAgdmFyIF9hLCBfYiwgX2MsIF9kLCBfZSwgX2YsIF9nLCBfaCwgX2osIF9rLCBfbCwgX207CiAgICB0aGlzLnRyYW5zcG9ydCA9IChfYSA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy50cmFuc3BvcnQpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IG51bGw7CiAgICB0aGlzLnRpbWVvdXQgPSAoX2IgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMudGltZW91dCkgIT09IG51bGwgJiYgX2IgIT09IHZvaWQgMCA/IF9iIDogREVGQVVMVF9USU1FT1VUOwogICAgdGhpcy5oZWFydGJlYXRJbnRlcnZhbE1zID0gKF9jID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmhlYXJ0YmVhdEludGVydmFsTXMpICE9PSBudWxsICYmIF9jICE9PSB2b2lkIDAgPyBfYyA6IENPTk5FQ1RJT05fVElNRU9VVFMuSEVBUlRCRUFUX0lOVEVSVkFMOwogICAgdGhpcy53b3JrZXIgPSAoX2QgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMud29ya2VyKSAhPT0gbnVsbCAmJiBfZCAhPT0gdm9pZCAwID8gX2QgOiBmYWxzZTsKICAgIHRoaXMuYWNjZXNzVG9rZW4gPSAoX2UgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuYWNjZXNzVG9rZW4pICE9PSBudWxsICYmIF9lICE9PSB2b2lkIDAgPyBfZSA6IG51bGw7CiAgICB0aGlzLmhlYXJ0YmVhdENhbGxiYWNrID0gKF9mID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmhlYXJ0YmVhdENhbGxiYWNrKSAhPT0gbnVsbCAmJiBfZiAhPT0gdm9pZCAwID8gX2YgOiBub29wNTsKICAgIHRoaXMudnNuID0gKF9nID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnZzbikgIT09IG51bGwgJiYgX2cgIT09IHZvaWQgMCA/IF9nIDogREVGQVVMVF9WU047CiAgICBpZiAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnBhcmFtcykKICAgICAgdGhpcy5wYXJhbXMgPSBvcHRpb25zLnBhcmFtczsKICAgIGlmIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMubG9nZ2VyKQogICAgICB0aGlzLmxvZ2dlciA9IG9wdGlvbnMubG9nZ2VyOwogICAgaWYgKChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMubG9nTGV2ZWwpIHx8IChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMubG9nX2xldmVsKSkgewogICAgICB0aGlzLmxvZ0xldmVsID0gb3B0aW9ucy5sb2dMZXZlbCB8fCBvcHRpb25zLmxvZ19sZXZlbDsKICAgICAgdGhpcy5wYXJhbXMgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHRoaXMucGFyYW1zKSwgeyBsb2dfbGV2ZWw6IHRoaXMubG9nTGV2ZWwgfSk7CiAgICB9CiAgICB0aGlzLnJlY29ubmVjdEFmdGVyTXMgPSAoX2ggPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMucmVjb25uZWN0QWZ0ZXJNcykgIT09IG51bGwgJiYgX2ggIT09IHZvaWQgMCA/IF9oIDogKHRyaWVzKSA9PiB7CiAgICAgIHJldHVybiBSRUNPTk5FQ1RfSU5URVJWQUxTW3RyaWVzIC0gMV0gfHwgREVGQVVMVF9SRUNPTk5FQ1RfRkFMTEJBQ0s7CiAgICB9OwogICAgc3dpdGNoICh0aGlzLnZzbikgewogICAgICBjYXNlIFZTTl8xXzBfMDoKICAgICAgICB0aGlzLmVuY29kZSA9IChfaiA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5lbmNvZGUpICE9PSBudWxsICYmIF9qICE9PSB2b2lkIDAgPyBfaiA6IChwYXlsb2FkLCBjYWxsYmFjaykgPT4gewogICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKEpTT04uc3RyaW5naWZ5KHBheWxvYWQpKTsKICAgICAgICB9OwogICAgICAgIHRoaXMuZGVjb2RlID0gKF9rID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmRlY29kZSkgIT09IG51bGwgJiYgX2sgIT09IHZvaWQgMCA/IF9rIDogKHBheWxvYWQsIGNhbGxiYWNrKSA9PiB7CiAgICAgICAgICByZXR1cm4gY2FsbGJhY2soSlNPTi5wYXJzZShwYXlsb2FkKSk7CiAgICAgICAgfTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSBWU05fMl8wXzA6CiAgICAgICAgdGhpcy5lbmNvZGUgPSAoX2wgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuZW5jb2RlKSAhPT0gbnVsbCAmJiBfbCAhPT0gdm9pZCAwID8gX2wgOiB0aGlzLnNlcmlhbGl6ZXIuZW5jb2RlLmJpbmQodGhpcy5zZXJpYWxpemVyKTsKICAgICAgICB0aGlzLmRlY29kZSA9IChfbSA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5kZWNvZGUpICE9PSBudWxsICYmIF9tICE9PSB2b2lkIDAgPyBfbSA6IHRoaXMuc2VyaWFsaXplci5kZWNvZGUuYmluZCh0aGlzLnNlcmlhbGl6ZXIpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5zdXBwb3J0ZWQgc2VyaWFsaXplciB2ZXJzaW9uOiAke3RoaXMudnNufWApOwogICAgfQogICAgaWYgKHRoaXMud29ya2VyKSB7CiAgICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiAhd2luZG93LldvcmtlcikgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiV2ViIFdvcmtlciBpcyBub3Qgc3VwcG9ydGVkIik7CiAgICAgIH0KICAgICAgdGhpcy53b3JrZXJVcmwgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMud29ya2VyVXJsOwogICAgfQogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9pY2ViZXJnLWpzQDAuOC4xL25vZGVfbW9kdWxlcy9pY2ViZXJnLWpzL2Rpc3QvaW5kZXgubWpzCnZhciBJY2ViZXJnRXJyb3IgPSBjbGFzcyBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBvcHRzKSB7CiAgICBzdXBlcihtZXNzYWdlKTsKICAgIHRoaXMubmFtZSA9ICJJY2ViZXJnRXJyb3IiOwogICAgdGhpcy5zdGF0dXMgPSBvcHRzLnN0YXR1czsKICAgIHRoaXMuaWNlYmVyZ1R5cGUgPSBvcHRzLmljZWJlcmdUeXBlOwogICAgdGhpcy5pY2ViZXJnQ29kZSA9IG9wdHMuaWNlYmVyZ0NvZGU7CiAgICB0aGlzLmRldGFpbHMgPSBvcHRzLmRldGFpbHM7CiAgICB0aGlzLmlzQ29tbWl0U3RhdGVVbmtub3duID0gb3B0cy5pY2ViZXJnVHlwZSA9PT0gIkNvbW1pdFN0YXRlVW5rbm93bkV4Y2VwdGlvbiIgfHwgWzUwMCwgNTAyLCA1MDRdLmluY2x1ZGVzKG9wdHMuc3RhdHVzKSAmJiBvcHRzLmljZWJlcmdUeXBlPy5pbmNsdWRlcygiQ29tbWl0U3RhdGUiKSA9PT0gdHJ1ZTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBlcnJvciBpcyBhIDQwNCBOb3QgRm91bmQgZXJyb3IuCiAgICovCiAgaXNOb3RGb3VuZCgpIHsKICAgIHJldHVybiB0aGlzLnN0YXR1cyA9PT0gNDA0OwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIGVycm9yIGlzIGEgNDA5IENvbmZsaWN0IGVycm9yLgogICAqLwogIGlzQ29uZmxpY3QoKSB7CiAgICByZXR1cm4gdGhpcy5zdGF0dXMgPT09IDQwOTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBlcnJvciBpcyBhIDQxOSBBdXRoZW50aWNhdGlvbiBUaW1lb3V0IGVycm9yLgogICAqLwogIGlzQXV0aGVudGljYXRpb25UaW1lb3V0KCkgewogICAgcmV0dXJuIHRoaXMuc3RhdHVzID09PSA0MTk7CiAgfQp9OwpmdW5jdGlvbiBidWlsZFVybChiYXNlVXJsLCBwYXRoMiwgcXVlcnkpIHsKICBjb25zdCB1cmwgPSBuZXcgVVJMKHBhdGgyLCBiYXNlVXJsKTsKICBpZiAocXVlcnkpIHsKICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHF1ZXJ5KSkgewogICAgICBpZiAodmFsdWUgIT09IHZvaWQgMCkgewogICAgICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KGtleSwgdmFsdWUpOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiB1cmwudG9TdHJpbmcoKTsKfQphc3luYyBmdW5jdGlvbiBidWlsZEF1dGhIZWFkZXJzKGF1dGgpIHsKICBpZiAoIWF1dGggfHwgYXV0aC50eXBlID09PSAibm9uZSIpIHsKICAgIHJldHVybiB7fTsKICB9CiAgaWYgKGF1dGgudHlwZSA9PT0gImJlYXJlciIpIHsKICAgIHJldHVybiB7IEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHthdXRoLnRva2VufWAgfTsKICB9CiAgaWYgKGF1dGgudHlwZSA9PT0gImhlYWRlciIpIHsKICAgIHJldHVybiB7IFthdXRoLm5hbWVdOiBhdXRoLnZhbHVlIH07CiAgfQogIGlmIChhdXRoLnR5cGUgPT09ICJjdXN0b20iKSB7CiAgICByZXR1cm4gYXdhaXQgYXV0aC5nZXRIZWFkZXJzKCk7CiAgfQogIHJldHVybiB7fTsKfQpmdW5jdGlvbiBjcmVhdGVGZXRjaENsaWVudChvcHRpb25zKSB7CiAgY29uc3QgZmV0Y2hGbiA9IG9wdGlvbnMuZmV0Y2hJbXBsID8/IGdsb2JhbFRoaXMuZmV0Y2g7CiAgcmV0dXJuIHsKICAgIGFzeW5jIHJlcXVlc3QoewogICAgICBtZXRob2QsCiAgICAgIHBhdGg6IHBhdGgyLAogICAgICBxdWVyeSwKICAgICAgYm9keSwKICAgICAgaGVhZGVycwogICAgfSkgewogICAgICBjb25zdCB1cmwgPSBidWlsZFVybChvcHRpb25zLmJhc2VVcmwsIHBhdGgyLCBxdWVyeSk7CiAgICAgIGNvbnN0IGF1dGhIZWFkZXJzID0gYXdhaXQgYnVpbGRBdXRoSGVhZGVycyhvcHRpb25zLmF1dGgpOwogICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaEZuKHVybCwgewogICAgICAgIG1ldGhvZCwKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAuLi5ib2R5ID8geyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0gOiB7fSwKICAgICAgICAgIC4uLmF1dGhIZWFkZXJzLAogICAgICAgICAgLi4uaGVhZGVycwogICAgICAgIH0sCiAgICAgICAgYm9keTogYm9keSA/IEpTT04uc3RyaW5naWZ5KGJvZHkpIDogdm9pZCAwCiAgICAgIH0pOwogICAgICBjb25zdCB0ZXh0ID0gYXdhaXQgcmVzLnRleHQoKTsKICAgICAgY29uc3QgaXNKc29uID0gKHJlcy5oZWFkZXJzLmdldCgiY29udGVudC10eXBlIikgfHwgIiIpLmluY2x1ZGVzKCJhcHBsaWNhdGlvbi9qc29uIik7CiAgICAgIGNvbnN0IGRhdGEgPSBpc0pzb24gJiYgdGV4dCA/IEpTT04ucGFyc2UodGV4dCkgOiB0ZXh0OwogICAgICBpZiAoIXJlcy5vaykgewogICAgICAgIGNvbnN0IGVyckJvZHkgPSBpc0pzb24gPyBkYXRhIDogdm9pZCAwOwogICAgICAgIGNvbnN0IGVycm9yRGV0YWlsID0gZXJyQm9keT8uZXJyb3I7CiAgICAgICAgdGhyb3cgbmV3IEljZWJlcmdFcnJvcigKICAgICAgICAgIGVycm9yRGV0YWlsPy5tZXNzYWdlID8/IGBSZXF1ZXN0IGZhaWxlZCB3aXRoIHN0YXR1cyAke3Jlcy5zdGF0dXN9YCwKICAgICAgICAgIHsKICAgICAgICAgICAgc3RhdHVzOiByZXMuc3RhdHVzLAogICAgICAgICAgICBpY2ViZXJnVHlwZTogZXJyb3JEZXRhaWw/LnR5cGUsCiAgICAgICAgICAgIGljZWJlcmdDb2RlOiBlcnJvckRldGFpbD8uY29kZSwKICAgICAgICAgICAgZGV0YWlsczogZXJyQm9keQogICAgICAgICAgfQogICAgICAgICk7CiAgICAgIH0KICAgICAgcmV0dXJuIHsgc3RhdHVzOiByZXMuc3RhdHVzLCBoZWFkZXJzOiByZXMuaGVhZGVycywgZGF0YSB9OwogICAgfQogIH07Cn0KZnVuY3Rpb24gbmFtZXNwYWNlVG9QYXRoKG5hbWVzcGFjZSkgewogIHJldHVybiBuYW1lc3BhY2Uuam9pbigiHyIpOwp9CnZhciBOYW1lc3BhY2VPcGVyYXRpb25zID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGNsaWVudCwgcHJlZml4ID0gIiIpIHsKICAgIHRoaXMuY2xpZW50ID0gY2xpZW50OwogICAgdGhpcy5wcmVmaXggPSBwcmVmaXg7CiAgfQogIGFzeW5jIGxpc3ROYW1lc3BhY2VzKHBhcmVudCkgewogICAgY29uc3QgcXVlcnkgPSBwYXJlbnQgPyB7IHBhcmVudDogbmFtZXNwYWNlVG9QYXRoKHBhcmVudC5uYW1lc3BhY2UpIH0gOiB2b2lkIDA7CiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuY2xpZW50LnJlcXVlc3QoewogICAgICBtZXRob2Q6ICJHRVQiLAogICAgICBwYXRoOiBgJHt0aGlzLnByZWZpeH0vbmFtZXNwYWNlc2AsCiAgICAgIHF1ZXJ5CiAgICB9KTsKICAgIHJldHVybiByZXNwb25zZS5kYXRhLm5hbWVzcGFjZXMubWFwKChucykgPT4gKHsgbmFtZXNwYWNlOiBucyB9KSk7CiAgfQogIGFzeW5jIGNyZWF0ZU5hbWVzcGFjZShpZCwgbWV0YWRhdGEpIHsKICAgIGNvbnN0IHJlcXVlc3QgPSB7CiAgICAgIG5hbWVzcGFjZTogaWQubmFtZXNwYWNlLAogICAgICBwcm9wZXJ0aWVzOiBtZXRhZGF0YT8ucHJvcGVydGllcwogICAgfTsKICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5jbGllbnQucmVxdWVzdCh7CiAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICBwYXRoOiBgJHt0aGlzLnByZWZpeH0vbmFtZXNwYWNlc2AsCiAgICAgIGJvZHk6IHJlcXVlc3QKICAgIH0pOwogICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7CiAgfQogIGFzeW5jIGRyb3BOYW1lc3BhY2UoaWQpIHsKICAgIGF3YWl0IHRoaXMuY2xpZW50LnJlcXVlc3QoewogICAgICBtZXRob2Q6ICJERUxFVEUiLAogICAgICBwYXRoOiBgJHt0aGlzLnByZWZpeH0vbmFtZXNwYWNlcy8ke25hbWVzcGFjZVRvUGF0aChpZC5uYW1lc3BhY2UpfWAKICAgIH0pOwogIH0KICBhc3luYyBsb2FkTmFtZXNwYWNlTWV0YWRhdGEoaWQpIHsKICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5jbGllbnQucmVxdWVzdCh7CiAgICAgIG1ldGhvZDogIkdFVCIsCiAgICAgIHBhdGg6IGAke3RoaXMucHJlZml4fS9uYW1lc3BhY2VzLyR7bmFtZXNwYWNlVG9QYXRoKGlkLm5hbWVzcGFjZSl9YAogICAgfSk7CiAgICByZXR1cm4gewogICAgICBwcm9wZXJ0aWVzOiByZXNwb25zZS5kYXRhLnByb3BlcnRpZXMKICAgIH07CiAgfQogIGFzeW5jIG5hbWVzcGFjZUV4aXN0cyhpZCkgewogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5jbGllbnQucmVxdWVzdCh7CiAgICAgICAgbWV0aG9kOiAiSEVBRCIsCiAgICAgICAgcGF0aDogYCR7dGhpcy5wcmVmaXh9L25hbWVzcGFjZXMvJHtuYW1lc3BhY2VUb1BhdGgoaWQubmFtZXNwYWNlKX1gCiAgICAgIH0pOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEljZWJlcmdFcnJvciAmJiBlcnJvci5zdGF0dXMgPT09IDQwNCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgYXN5bmMgY3JlYXRlTmFtZXNwYWNlSWZOb3RFeGlzdHMoaWQsIG1ldGFkYXRhKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5jcmVhdGVOYW1lc3BhY2UoaWQsIG1ldGFkYXRhKTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEljZWJlcmdFcnJvciAmJiBlcnJvci5zdGF0dXMgPT09IDQwOSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9Cn07CmZ1bmN0aW9uIG5hbWVzcGFjZVRvUGF0aDIobmFtZXNwYWNlKSB7CiAgcmV0dXJuIG5hbWVzcGFjZS5qb2luKCIfIik7Cn0KdmFyIFRhYmxlT3BlcmF0aW9ucyA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihjbGllbnQsIHByZWZpeCA9ICIiLCBhY2Nlc3NEZWxlZ2F0aW9uKSB7CiAgICB0aGlzLmNsaWVudCA9IGNsaWVudDsKICAgIHRoaXMucHJlZml4ID0gcHJlZml4OwogICAgdGhpcy5hY2Nlc3NEZWxlZ2F0aW9uID0gYWNjZXNzRGVsZWdhdGlvbjsKICB9CiAgYXN5bmMgbGlzdFRhYmxlcyhuYW1lc3BhY2UpIHsKICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5jbGllbnQucmVxdWVzdCh7CiAgICAgIG1ldGhvZDogIkdFVCIsCiAgICAgIHBhdGg6IGAke3RoaXMucHJlZml4fS9uYW1lc3BhY2VzLyR7bmFtZXNwYWNlVG9QYXRoMihuYW1lc3BhY2UubmFtZXNwYWNlKX0vdGFibGVzYAogICAgfSk7CiAgICByZXR1cm4gcmVzcG9uc2UuZGF0YS5pZGVudGlmaWVyczsKICB9CiAgYXN5bmMgY3JlYXRlVGFibGUobmFtZXNwYWNlLCByZXF1ZXN0KSB7CiAgICBjb25zdCBoZWFkZXJzID0ge307CiAgICBpZiAodGhpcy5hY2Nlc3NEZWxlZ2F0aW9uKSB7CiAgICAgIGhlYWRlcnNbIlgtSWNlYmVyZy1BY2Nlc3MtRGVsZWdhdGlvbiJdID0gdGhpcy5hY2Nlc3NEZWxlZ2F0aW9uOwogICAgfQogICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNsaWVudC5yZXF1ZXN0KHsKICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgIHBhdGg6IGAke3RoaXMucHJlZml4fS9uYW1lc3BhY2VzLyR7bmFtZXNwYWNlVG9QYXRoMihuYW1lc3BhY2UubmFtZXNwYWNlKX0vdGFibGVzYCwKICAgICAgYm9keTogcmVxdWVzdCwKICAgICAgaGVhZGVycwogICAgfSk7CiAgICByZXR1cm4gcmVzcG9uc2UuZGF0YS5tZXRhZGF0YTsKICB9CiAgYXN5bmMgdXBkYXRlVGFibGUoaWQsIHJlcXVlc3QpIHsKICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5jbGllbnQucmVxdWVzdCh7CiAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICBwYXRoOiBgJHt0aGlzLnByZWZpeH0vbmFtZXNwYWNlcy8ke25hbWVzcGFjZVRvUGF0aDIoaWQubmFtZXNwYWNlKX0vdGFibGVzLyR7aWQubmFtZX1gLAogICAgICBib2R5OiByZXF1ZXN0CiAgICB9KTsKICAgIHJldHVybiB7CiAgICAgICJtZXRhZGF0YS1sb2NhdGlvbiI6IHJlc3BvbnNlLmRhdGFbIm1ldGFkYXRhLWxvY2F0aW9uIl0sCiAgICAgIG1ldGFkYXRhOiByZXNwb25zZS5kYXRhLm1ldGFkYXRhCiAgICB9OwogIH0KICBhc3luYyBkcm9wVGFibGUoaWQsIG9wdGlvbnMpIHsKICAgIGF3YWl0IHRoaXMuY2xpZW50LnJlcXVlc3QoewogICAgICBtZXRob2Q6ICJERUxFVEUiLAogICAgICBwYXRoOiBgJHt0aGlzLnByZWZpeH0vbmFtZXNwYWNlcy8ke25hbWVzcGFjZVRvUGF0aDIoaWQubmFtZXNwYWNlKX0vdGFibGVzLyR7aWQubmFtZX1gLAogICAgICBxdWVyeTogeyBwdXJnZVJlcXVlc3RlZDogU3RyaW5nKG9wdGlvbnM/LnB1cmdlID8/IGZhbHNlKSB9CiAgICB9KTsKICB9CiAgYXN5bmMgbG9hZFRhYmxlKGlkKSB7CiAgICBjb25zdCBoZWFkZXJzID0ge307CiAgICBpZiAodGhpcy5hY2Nlc3NEZWxlZ2F0aW9uKSB7CiAgICAgIGhlYWRlcnNbIlgtSWNlYmVyZy1BY2Nlc3MtRGVsZWdhdGlvbiJdID0gdGhpcy5hY2Nlc3NEZWxlZ2F0aW9uOwogICAgfQogICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNsaWVudC5yZXF1ZXN0KHsKICAgICAgbWV0aG9kOiAiR0VUIiwKICAgICAgcGF0aDogYCR7dGhpcy5wcmVmaXh9L25hbWVzcGFjZXMvJHtuYW1lc3BhY2VUb1BhdGgyKGlkLm5hbWVzcGFjZSl9L3RhYmxlcy8ke2lkLm5hbWV9YCwKICAgICAgaGVhZGVycwogICAgfSk7CiAgICByZXR1cm4gcmVzcG9uc2UuZGF0YS5tZXRhZGF0YTsKICB9CiAgYXN5bmMgdGFibGVFeGlzdHMoaWQpIHsKICAgIGNvbnN0IGhlYWRlcnMgPSB7fTsKICAgIGlmICh0aGlzLmFjY2Vzc0RlbGVnYXRpb24pIHsKICAgICAgaGVhZGVyc1siWC1JY2ViZXJnLUFjY2Vzcy1EZWxlZ2F0aW9uIl0gPSB0aGlzLmFjY2Vzc0RlbGVnYXRpb247CiAgICB9CiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLmNsaWVudC5yZXF1ZXN0KHsKICAgICAgICBtZXRob2Q6ICJIRUFEIiwKICAgICAgICBwYXRoOiBgJHt0aGlzLnByZWZpeH0vbmFtZXNwYWNlcy8ke25hbWVzcGFjZVRvUGF0aDIoaWQubmFtZXNwYWNlKX0vdGFibGVzLyR7aWQubmFtZX1gLAogICAgICAgIGhlYWRlcnMKICAgICAgfSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgSWNlYmVyZ0Vycm9yICYmIGVycm9yLnN0YXR1cyA9PT0gNDA0KSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICBhc3luYyBjcmVhdGVUYWJsZUlmTm90RXhpc3RzKG5hbWVzcGFjZSwgcmVxdWVzdCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuY3JlYXRlVGFibGUobmFtZXNwYWNlLCByZXF1ZXN0KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEljZWJlcmdFcnJvciAmJiBlcnJvci5zdGF0dXMgPT09IDQwOSkgewogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmxvYWRUYWJsZSh7IG5hbWVzcGFjZTogbmFtZXNwYWNlLm5hbWVzcGFjZSwgbmFtZTogcmVxdWVzdC5uYW1lIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KfTsKdmFyIEljZWJlcmdSZXN0Q2F0YWxvZyA9IGNsYXNzIHsKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IEljZWJlcmcgUkVTVCBDYXRhbG9nIGNsaWVudC4KICAgKgogICAqIEBwYXJhbSBvcHRpb25zIC0gQ29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgY2F0YWxvZyBjbGllbnQKICAgKi8KICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICBsZXQgcHJlZml4ID0gInYxIjsKICAgIGlmIChvcHRpb25zLmNhdGFsb2dOYW1lKSB7CiAgICAgIHByZWZpeCArPSBgLyR7b3B0aW9ucy5jYXRhbG9nTmFtZX1gOwogICAgfQogICAgY29uc3QgYmFzZVVybCA9IG9wdGlvbnMuYmFzZVVybC5lbmRzV2l0aCgiLyIpID8gb3B0aW9ucy5iYXNlVXJsIDogYCR7b3B0aW9ucy5iYXNlVXJsfS9gOwogICAgdGhpcy5jbGllbnQgPSBjcmVhdGVGZXRjaENsaWVudCh7CiAgICAgIGJhc2VVcmwsCiAgICAgIGF1dGg6IG9wdGlvbnMuYXV0aCwKICAgICAgZmV0Y2hJbXBsOiBvcHRpb25zLmZldGNoCiAgICB9KTsKICAgIHRoaXMuYWNjZXNzRGVsZWdhdGlvbiA9IG9wdGlvbnMuYWNjZXNzRGVsZWdhdGlvbj8uam9pbigiLCIpOwogICAgdGhpcy5uYW1lc3BhY2VPcHMgPSBuZXcgTmFtZXNwYWNlT3BlcmF0aW9ucyh0aGlzLmNsaWVudCwgcHJlZml4KTsKICAgIHRoaXMudGFibGVPcHMgPSBuZXcgVGFibGVPcGVyYXRpb25zKHRoaXMuY2xpZW50LCBwcmVmaXgsIHRoaXMuYWNjZXNzRGVsZWdhdGlvbik7CiAgfQogIC8qKgogICAqIExpc3RzIGFsbCBuYW1lc3BhY2VzIGluIHRoZSBjYXRhbG9nLgogICAqCiAgICogQHBhcmFtIHBhcmVudCAtIE9wdGlvbmFsIHBhcmVudCBuYW1lc3BhY2UgdG8gbGlzdCBjaGlsZHJlbiB1bmRlcgogICAqIEByZXR1cm5zIEFycmF5IG9mIG5hbWVzcGFjZSBpZGVudGlmaWVycwogICAqCiAgICogQGV4YW1wbGUKICAgKiBgYGB0eXBlc2NyaXB0CiAgICogLy8gTGlzdCBhbGwgdG9wLWxldmVsIG5hbWVzcGFjZXMKICAgKiBjb25zdCBuYW1lc3BhY2VzID0gYXdhaXQgY2F0YWxvZy5saXN0TmFtZXNwYWNlcygpOwogICAqCiAgICogLy8gTGlzdCBuYW1lc3BhY2VzIHVuZGVyIGEgcGFyZW50CiAgICogY29uc3QgY2hpbGRyZW4gPSBhd2FpdCBjYXRhbG9nLmxpc3ROYW1lc3BhY2VzKHsgbmFtZXNwYWNlOiBbJ2FuYWx5dGljcyddIH0pOwogICAqIGBgYAogICAqLwogIGFzeW5jIGxpc3ROYW1lc3BhY2VzKHBhcmVudCkgewogICAgcmV0dXJuIHRoaXMubmFtZXNwYWNlT3BzLmxpc3ROYW1lc3BhY2VzKHBhcmVudCk7CiAgfQogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgbmFtZXNwYWNlIGluIHRoZSBjYXRhbG9nLgogICAqCiAgICogQHBhcmFtIGlkIC0gTmFtZXNwYWNlIGlkZW50aWZpZXIgdG8gY3JlYXRlCiAgICogQHBhcmFtIG1ldGFkYXRhIC0gT3B0aW9uYWwgbWV0YWRhdGEgcHJvcGVydGllcyBmb3IgdGhlIG5hbWVzcGFjZQogICAqIEByZXR1cm5zIFJlc3BvbnNlIGNvbnRhaW5pbmcgdGhlIGNyZWF0ZWQgbmFtZXNwYWNlIGFuZCBpdHMgcHJvcGVydGllcwogICAqCiAgICogQGV4YW1wbGUKICAgKiBgYGB0eXBlc2NyaXB0CiAgICogY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBjYXRhbG9nLmNyZWF0ZU5hbWVzcGFjZSgKICAgKiAgIHsgbmFtZXNwYWNlOiBbJ2FuYWx5dGljcyddIH0sCiAgICogICB7IHByb3BlcnRpZXM6IHsgb3duZXI6ICdkYXRhLXRlYW0nIH0gfQogICAqICk7CiAgICogY29uc29sZS5sb2cocmVzcG9uc2UubmFtZXNwYWNlKTsgLy8gWydhbmFseXRpY3MnXQogICAqIGNvbnNvbGUubG9nKHJlc3BvbnNlLnByb3BlcnRpZXMpOyAvLyB7IG93bmVyOiAnZGF0YS10ZWFtJywgLi4uIH0KICAgKiBgYGAKICAgKi8KICBhc3luYyBjcmVhdGVOYW1lc3BhY2UoaWQsIG1ldGFkYXRhKSB7CiAgICByZXR1cm4gdGhpcy5uYW1lc3BhY2VPcHMuY3JlYXRlTmFtZXNwYWNlKGlkLCBtZXRhZGF0YSk7CiAgfQogIC8qKgogICAqIERyb3BzIGEgbmFtZXNwYWNlIGZyb20gdGhlIGNhdGFsb2cuCiAgICoKICAgKiBUaGUgbmFtZXNwYWNlIG11c3QgYmUgZW1wdHkgKGNvbnRhaW4gbm8gdGFibGVzKSBiZWZvcmUgaXQgY2FuIGJlIGRyb3BwZWQuCiAgICoKICAgKiBAcGFyYW0gaWQgLSBOYW1lc3BhY2UgaWRlbnRpZmllciB0byBkcm9wCiAgICoKICAgKiBAZXhhbXBsZQogICAqIGBgYHR5cGVzY3JpcHQKICAgKiBhd2FpdCBjYXRhbG9nLmRyb3BOYW1lc3BhY2UoeyBuYW1lc3BhY2U6IFsnYW5hbHl0aWNzJ10gfSk7CiAgICogYGBgCiAgICovCiAgYXN5bmMgZHJvcE5hbWVzcGFjZShpZCkgewogICAgYXdhaXQgdGhpcy5uYW1lc3BhY2VPcHMuZHJvcE5hbWVzcGFjZShpZCk7CiAgfQogIC8qKgogICAqIExvYWRzIG1ldGFkYXRhIGZvciBhIG5hbWVzcGFjZS4KICAgKgogICAqIEBwYXJhbSBpZCAtIE5hbWVzcGFjZSBpZGVudGlmaWVyIHRvIGxvYWQKICAgKiBAcmV0dXJucyBOYW1lc3BhY2UgbWV0YWRhdGEgaW5jbHVkaW5nIHByb3BlcnRpZXMKICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHlwZXNjcmlwdAogICAqIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgY2F0YWxvZy5sb2FkTmFtZXNwYWNlTWV0YWRhdGEoeyBuYW1lc3BhY2U6IFsnYW5hbHl0aWNzJ10gfSk7CiAgICogY29uc29sZS5sb2cobWV0YWRhdGEucHJvcGVydGllcyk7CiAgICogYGBgCiAgICovCiAgYXN5bmMgbG9hZE5hbWVzcGFjZU1ldGFkYXRhKGlkKSB7CiAgICByZXR1cm4gdGhpcy5uYW1lc3BhY2VPcHMubG9hZE5hbWVzcGFjZU1ldGFkYXRhKGlkKTsKICB9CiAgLyoqCiAgICogTGlzdHMgYWxsIHRhYmxlcyBpbiBhIG5hbWVzcGFjZS4KICAgKgogICAqIEBwYXJhbSBuYW1lc3BhY2UgLSBOYW1lc3BhY2UgaWRlbnRpZmllciB0byBsaXN0IHRhYmxlcyBmcm9tCiAgICogQHJldHVybnMgQXJyYXkgb2YgdGFibGUgaWRlbnRpZmllcnMKICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHlwZXNjcmlwdAogICAqIGNvbnN0IHRhYmxlcyA9IGF3YWl0IGNhdGFsb2cubGlzdFRhYmxlcyh7IG5hbWVzcGFjZTogWydhbmFseXRpY3MnXSB9KTsKICAgKiBjb25zb2xlLmxvZyh0YWJsZXMpOyAvLyBbeyBuYW1lc3BhY2U6IFsnYW5hbHl0aWNzJ10sIG5hbWU6ICdldmVudHMnIH0sIC4uLl0KICAgKiBgYGAKICAgKi8KICBhc3luYyBsaXN0VGFibGVzKG5hbWVzcGFjZSkgewogICAgcmV0dXJuIHRoaXMudGFibGVPcHMubGlzdFRhYmxlcyhuYW1lc3BhY2UpOwogIH0KICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IHRhYmxlIGluIHRoZSBjYXRhbG9nLgogICAqCiAgICogQHBhcmFtIG5hbWVzcGFjZSAtIE5hbWVzcGFjZSB0byBjcmVhdGUgdGhlIHRhYmxlIGluCiAgICogQHBhcmFtIHJlcXVlc3QgLSBUYWJsZSBjcmVhdGlvbiByZXF1ZXN0IGluY2x1ZGluZyBuYW1lLCBzY2hlbWEsIHBhcnRpdGlvbiBzcGVjLCBldGMuCiAgICogQHJldHVybnMgVGFibGUgbWV0YWRhdGEgZm9yIHRoZSBjcmVhdGVkIHRhYmxlCiAgICoKICAgKiBAZXhhbXBsZQogICAqIGBgYHR5cGVzY3JpcHQKICAgKiBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IGNhdGFsb2cuY3JlYXRlVGFibGUoCiAgICogICB7IG5hbWVzcGFjZTogWydhbmFseXRpY3MnXSB9LAogICAqICAgewogICAqICAgICBuYW1lOiAnZXZlbnRzJywKICAgKiAgICAgc2NoZW1hOiB7CiAgICogICAgICAgdHlwZTogJ3N0cnVjdCcsCiAgICogICAgICAgZmllbGRzOiBbCiAgICogICAgICAgICB7IGlkOiAxLCBuYW1lOiAnaWQnLCB0eXBlOiAnbG9uZycsIHJlcXVpcmVkOiB0cnVlIH0sCiAgICogICAgICAgICB7IGlkOiAyLCBuYW1lOiAndGltZXN0YW1wJywgdHlwZTogJ3RpbWVzdGFtcCcsIHJlcXVpcmVkOiB0cnVlIH0KICAgKiAgICAgICBdLAogICAqICAgICAgICdzY2hlbWEtaWQnOiAwCiAgICogICAgIH0sCiAgICogICAgICdwYXJ0aXRpb24tc3BlYyc6IHsKICAgKiAgICAgICAnc3BlYy1pZCc6IDAsCiAgICogICAgICAgZmllbGRzOiBbCiAgICogICAgICAgICB7IHNvdXJjZV9pZDogMiwgZmllbGRfaWQ6IDEwMDAsIG5hbWU6ICd0c19kYXknLCB0cmFuc2Zvcm06ICdkYXknIH0KICAgKiAgICAgICBdCiAgICogICAgIH0KICAgKiAgIH0KICAgKiApOwogICAqIGBgYAogICAqLwogIGFzeW5jIGNyZWF0ZVRhYmxlKG5hbWVzcGFjZSwgcmVxdWVzdCkgewogICAgcmV0dXJuIHRoaXMudGFibGVPcHMuY3JlYXRlVGFibGUobmFtZXNwYWNlLCByZXF1ZXN0KTsKICB9CiAgLyoqCiAgICogVXBkYXRlcyBhbiBleGlzdGluZyB0YWJsZSdzIG1ldGFkYXRhLgogICAqCiAgICogQ2FuIHVwZGF0ZSB0aGUgc2NoZW1hLCBwYXJ0aXRpb24gc3BlYywgb3IgcHJvcGVydGllcyBvZiBhIHRhYmxlLgogICAqCiAgICogQHBhcmFtIGlkIC0gVGFibGUgaWRlbnRpZmllciB0byB1cGRhdGUKICAgKiBAcGFyYW0gcmVxdWVzdCAtIFVwZGF0ZSByZXF1ZXN0IHdpdGggZmllbGRzIHRvIG1vZGlmeQogICAqIEByZXR1cm5zIFJlc3BvbnNlIGNvbnRhaW5pbmcgdGhlIG1ldGFkYXRhIGxvY2F0aW9uIGFuZCB1cGRhdGVkIHRhYmxlIG1ldGFkYXRhCiAgICoKICAgKiBAZXhhbXBsZQogICAqIGBgYHR5cGVzY3JpcHQKICAgKiBjb25zdCByZXNwb25zZSA9IGF3YWl0IGNhdGFsb2cudXBkYXRlVGFibGUoCiAgICogICB7IG5hbWVzcGFjZTogWydhbmFseXRpY3MnXSwgbmFtZTogJ2V2ZW50cycgfSwKICAgKiAgIHsKICAgKiAgICAgcHJvcGVydGllczogeyAncmVhZC5zcGxpdC50YXJnZXQtc2l6ZSc6ICcxMzQyMTc3MjgnIH0KICAgKiAgIH0KICAgKiApOwogICAqIGNvbnNvbGUubG9nKHJlc3BvbnNlWydtZXRhZGF0YS1sb2NhdGlvbiddKTsgLy8gczM6Ly8uLi4KICAgKiBjb25zb2xlLmxvZyhyZXNwb25zZS5tZXRhZGF0YSk7IC8vIFRhYmxlTWV0YWRhdGEgb2JqZWN0CiAgICogYGBgCiAgICovCiAgYXN5bmMgdXBkYXRlVGFibGUoaWQsIHJlcXVlc3QpIHsKICAgIHJldHVybiB0aGlzLnRhYmxlT3BzLnVwZGF0ZVRhYmxlKGlkLCByZXF1ZXN0KTsKICB9CiAgLyoqCiAgICogRHJvcHMgYSB0YWJsZSBmcm9tIHRoZSBjYXRhbG9nLgogICAqCiAgICogQHBhcmFtIGlkIC0gVGFibGUgaWRlbnRpZmllciB0byBkcm9wCiAgICoKICAgKiBAZXhhbXBsZQogICAqIGBgYHR5cGVzY3JpcHQKICAgKiBhd2FpdCBjYXRhbG9nLmRyb3BUYWJsZSh7IG5hbWVzcGFjZTogWydhbmFseXRpY3MnXSwgbmFtZTogJ2V2ZW50cycgfSk7CiAgICogYGBgCiAgICovCiAgYXN5bmMgZHJvcFRhYmxlKGlkLCBvcHRpb25zKSB7CiAgICBhd2FpdCB0aGlzLnRhYmxlT3BzLmRyb3BUYWJsZShpZCwgb3B0aW9ucyk7CiAgfQogIC8qKgogICAqIExvYWRzIG1ldGFkYXRhIGZvciBhIHRhYmxlLgogICAqCiAgICogQHBhcmFtIGlkIC0gVGFibGUgaWRlbnRpZmllciB0byBsb2FkCiAgICogQHJldHVybnMgVGFibGUgbWV0YWRhdGEgaW5jbHVkaW5nIHNjaGVtYSwgcGFydGl0aW9uIHNwZWMsIGxvY2F0aW9uLCBldGMuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIGBgYHR5cGVzY3JpcHQKICAgKiBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IGNhdGFsb2cubG9hZFRhYmxlKHsgbmFtZXNwYWNlOiBbJ2FuYWx5dGljcyddLCBuYW1lOiAnZXZlbnRzJyB9KTsKICAgKiBjb25zb2xlLmxvZyhtZXRhZGF0YS5zY2hlbWEpOwogICAqIGNvbnNvbGUubG9nKG1ldGFkYXRhLmxvY2F0aW9uKTsKICAgKiBgYGAKICAgKi8KICBhc3luYyBsb2FkVGFibGUoaWQpIHsKICAgIHJldHVybiB0aGlzLnRhYmxlT3BzLmxvYWRUYWJsZShpZCk7CiAgfQogIC8qKgogICAqIENoZWNrcyBpZiBhIG5hbWVzcGFjZSBleGlzdHMgaW4gdGhlIGNhdGFsb2cuCiAgICoKICAgKiBAcGFyYW0gaWQgLSBOYW1lc3BhY2UgaWRlbnRpZmllciB0byBjaGVjawogICAqIEByZXR1cm5zIFRydWUgaWYgdGhlIG5hbWVzcGFjZSBleGlzdHMsIGZhbHNlIG90aGVyd2lzZQogICAqCiAgICogQGV4YW1wbGUKICAgKiBgYGB0eXBlc2NyaXB0CiAgICogY29uc3QgZXhpc3RzID0gYXdhaXQgY2F0YWxvZy5uYW1lc3BhY2VFeGlzdHMoeyBuYW1lc3BhY2U6IFsnYW5hbHl0aWNzJ10gfSk7CiAgICogY29uc29sZS5sb2coZXhpc3RzKTsgLy8gdHJ1ZSBvciBmYWxzZQogICAqIGBgYAogICAqLwogIGFzeW5jIG5hbWVzcGFjZUV4aXN0cyhpZCkgewogICAgcmV0dXJuIHRoaXMubmFtZXNwYWNlT3BzLm5hbWVzcGFjZUV4aXN0cyhpZCk7CiAgfQogIC8qKgogICAqIENoZWNrcyBpZiBhIHRhYmxlIGV4aXN0cyBpbiB0aGUgY2F0YWxvZy4KICAgKgogICAqIEBwYXJhbSBpZCAtIFRhYmxlIGlkZW50aWZpZXIgdG8gY2hlY2sKICAgKiBAcmV0dXJucyBUcnVlIGlmIHRoZSB0YWJsZSBleGlzdHMsIGZhbHNlIG90aGVyd2lzZQogICAqCiAgICogQGV4YW1wbGUKICAgKiBgYGB0eXBlc2NyaXB0CiAgICogY29uc3QgZXhpc3RzID0gYXdhaXQgY2F0YWxvZy50YWJsZUV4aXN0cyh7IG5hbWVzcGFjZTogWydhbmFseXRpY3MnXSwgbmFtZTogJ2V2ZW50cycgfSk7CiAgICogY29uc29sZS5sb2coZXhpc3RzKTsgLy8gdHJ1ZSBvciBmYWxzZQogICAqIGBgYAogICAqLwogIGFzeW5jIHRhYmxlRXhpc3RzKGlkKSB7CiAgICByZXR1cm4gdGhpcy50YWJsZU9wcy50YWJsZUV4aXN0cyhpZCk7CiAgfQogIC8qKgogICAqIENyZWF0ZXMgYSBuYW1lc3BhY2UgaWYgaXQgZG9lcyBub3QgZXhpc3QuCiAgICoKICAgKiBJZiB0aGUgbmFtZXNwYWNlIGFscmVhZHkgZXhpc3RzLCByZXR1cm5zIHZvaWQuIElmIGNyZWF0ZWQsIHJldHVybnMgdGhlIHJlc3BvbnNlLgogICAqCiAgICogQHBhcmFtIGlkIC0gTmFtZXNwYWNlIGlkZW50aWZpZXIgdG8gY3JlYXRlCiAgICogQHBhcmFtIG1ldGFkYXRhIC0gT3B0aW9uYWwgbWV0YWRhdGEgcHJvcGVydGllcyBmb3IgdGhlIG5hbWVzcGFjZQogICAqIEByZXR1cm5zIFJlc3BvbnNlIGNvbnRhaW5pbmcgdGhlIGNyZWF0ZWQgbmFtZXNwYWNlIGFuZCBpdHMgcHJvcGVydGllcywgb3Igdm9pZCBpZiBpdCBhbHJlYWR5IGV4aXN0cwogICAqCiAgICogQGV4YW1wbGUKICAgKiBgYGB0eXBlc2NyaXB0CiAgICogY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBjYXRhbG9nLmNyZWF0ZU5hbWVzcGFjZUlmTm90RXhpc3RzKAogICAqICAgeyBuYW1lc3BhY2U6IFsnYW5hbHl0aWNzJ10gfSwKICAgKiAgIHsgcHJvcGVydGllczogeyBvd25lcjogJ2RhdGEtdGVhbScgfSB9CiAgICogKTsKICAgKiBpZiAocmVzcG9uc2UpIHsKICAgKiAgIGNvbnNvbGUubG9nKCdDcmVhdGVkOicsIHJlc3BvbnNlLm5hbWVzcGFjZSk7CiAgICogfSBlbHNlIHsKICAgKiAgIGNvbnNvbGUubG9nKCdBbHJlYWR5IGV4aXN0cycpOwogICAqIH0KICAgKiBgYGAKICAgKi8KICBhc3luYyBjcmVhdGVOYW1lc3BhY2VJZk5vdEV4aXN0cyhpZCwgbWV0YWRhdGEpIHsKICAgIHJldHVybiB0aGlzLm5hbWVzcGFjZU9wcy5jcmVhdGVOYW1lc3BhY2VJZk5vdEV4aXN0cyhpZCwgbWV0YWRhdGEpOwogIH0KICAvKioKICAgKiBDcmVhdGVzIGEgdGFibGUgaWYgaXQgZG9lcyBub3QgZXhpc3QuCiAgICoKICAgKiBJZiB0aGUgdGFibGUgYWxyZWFkeSBleGlzdHMsIHJldHVybnMgaXRzIG1ldGFkYXRhIGluc3RlYWQuCiAgICoKICAgKiBAcGFyYW0gbmFtZXNwYWNlIC0gTmFtZXNwYWNlIHRvIGNyZWF0ZSB0aGUgdGFibGUgaW4KICAgKiBAcGFyYW0gcmVxdWVzdCAtIFRhYmxlIGNyZWF0aW9uIHJlcXVlc3QgaW5jbHVkaW5nIG5hbWUsIHNjaGVtYSwgcGFydGl0aW9uIHNwZWMsIGV0Yy4KICAgKiBAcmV0dXJucyBUYWJsZSBtZXRhZGF0YSBmb3IgdGhlIGNyZWF0ZWQgb3IgZXhpc3RpbmcgdGFibGUKICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHlwZXNjcmlwdAogICAqIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgY2F0YWxvZy5jcmVhdGVUYWJsZUlmTm90RXhpc3RzKAogICAqICAgeyBuYW1lc3BhY2U6IFsnYW5hbHl0aWNzJ10gfSwKICAgKiAgIHsKICAgKiAgICAgbmFtZTogJ2V2ZW50cycsCiAgICogICAgIHNjaGVtYTogewogICAqICAgICAgIHR5cGU6ICdzdHJ1Y3QnLAogICAqICAgICAgIGZpZWxkczogWwogICAqICAgICAgICAgeyBpZDogMSwgbmFtZTogJ2lkJywgdHlwZTogJ2xvbmcnLCByZXF1aXJlZDogdHJ1ZSB9LAogICAqICAgICAgICAgeyBpZDogMiwgbmFtZTogJ3RpbWVzdGFtcCcsIHR5cGU6ICd0aW1lc3RhbXAnLCByZXF1aXJlZDogdHJ1ZSB9CiAgICogICAgICAgXSwKICAgKiAgICAgICAnc2NoZW1hLWlkJzogMAogICAqICAgICB9CiAgICogICB9CiAgICogKTsKICAgKiBgYGAKICAgKi8KICBhc3luYyBjcmVhdGVUYWJsZUlmTm90RXhpc3RzKG5hbWVzcGFjZSwgcmVxdWVzdCkgewogICAgcmV0dXJuIHRoaXMudGFibGVPcHMuY3JlYXRlVGFibGVJZk5vdEV4aXN0cyhuYW1lc3BhY2UsIHJlcXVlc3QpOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2Urc3RvcmFnZS1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9zdG9yYWdlLWpzL2Rpc3QvaW5kZXgubWpzCnZhciBTdG9yYWdlRXJyb3IgPSBjbGFzcyBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBuYW1lc3BhY2UgPSAic3RvcmFnZSIsIHN0YXR1cywgc3RhdHVzQ29kZSkgewogICAgc3VwZXIobWVzc2FnZSk7CiAgICB0aGlzLl9faXNTdG9yYWdlRXJyb3IgPSB0cnVlOwogICAgdGhpcy5uYW1lc3BhY2UgPSBuYW1lc3BhY2U7CiAgICB0aGlzLm5hbWUgPSBuYW1lc3BhY2UgPT09ICJ2ZWN0b3JzIiA/ICJTdG9yYWdlVmVjdG9yc0Vycm9yIiA6ICJTdG9yYWdlRXJyb3IiOwogICAgdGhpcy5zdGF0dXMgPSBzdGF0dXM7CiAgICB0aGlzLnN0YXR1c0NvZGUgPSBzdGF0dXNDb2RlOwogIH0KfTsKZnVuY3Rpb24gaXNTdG9yYWdlRXJyb3IoZXJyb3IpIHsKICByZXR1cm4gdHlwZW9mIGVycm9yID09PSAib2JqZWN0IiAmJiBlcnJvciAhPT0gbnVsbCAmJiAiX19pc1N0b3JhZ2VFcnJvciIgaW4gZXJyb3I7Cn0KdmFyIFN0b3JhZ2VBcGlFcnJvciA9IGNsYXNzIGV4dGVuZHMgU3RvcmFnZUVycm9yIHsKICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBzdGF0dXMsIHN0YXR1c0NvZGUsIG5hbWVzcGFjZSA9ICJzdG9yYWdlIikgewogICAgc3VwZXIobWVzc2FnZSwgbmFtZXNwYWNlLCBzdGF0dXMsIHN0YXR1c0NvZGUpOwogICAgdGhpcy5uYW1lID0gbmFtZXNwYWNlID09PSAidmVjdG9ycyIgPyAiU3RvcmFnZVZlY3RvcnNBcGlFcnJvciIgOiAiU3RvcmFnZUFwaUVycm9yIjsKICAgIHRoaXMuc3RhdHVzID0gc3RhdHVzOwogICAgdGhpcy5zdGF0dXNDb2RlID0gc3RhdHVzQ29kZTsKICB9CiAgdG9KU09OKCkgewogICAgcmV0dXJuIHsKICAgICAgbmFtZTogdGhpcy5uYW1lLAogICAgICBtZXNzYWdlOiB0aGlzLm1lc3NhZ2UsCiAgICAgIHN0YXR1czogdGhpcy5zdGF0dXMsCiAgICAgIHN0YXR1c0NvZGU6IHRoaXMuc3RhdHVzQ29kZQogICAgfTsKICB9Cn07CnZhciBTdG9yYWdlVW5rbm93bkVycm9yID0gY2xhc3MgZXh0ZW5kcyBTdG9yYWdlRXJyb3IgewogIGNvbnN0cnVjdG9yKG1lc3NhZ2UsIG9yaWdpbmFsRXJyb3IsIG5hbWVzcGFjZSA9ICJzdG9yYWdlIikgewogICAgc3VwZXIobWVzc2FnZSwgbmFtZXNwYWNlKTsKICAgIHRoaXMubmFtZSA9IG5hbWVzcGFjZSA9PT0gInZlY3RvcnMiID8gIlN0b3JhZ2VWZWN0b3JzVW5rbm93bkVycm9yIiA6ICJTdG9yYWdlVW5rbm93bkVycm9yIjsKICAgIHRoaXMub3JpZ2luYWxFcnJvciA9IG9yaWdpbmFsRXJyb3I7CiAgfQp9Owp2YXIgcmVzb2x2ZUZldGNoMiA9IChjdXN0b21GZXRjaCkgPT4gewogIGlmIChjdXN0b21GZXRjaCkgcmV0dXJuICguLi5hcmdzKSA9PiBjdXN0b21GZXRjaCguLi5hcmdzKTsKICByZXR1cm4gKC4uLmFyZ3MpID0+IGZldGNoKC4uLmFyZ3MpOwp9Owp2YXIgaXNQbGFpbk9iamVjdDQgPSAodmFsdWUpID0+IHsKICBpZiAodHlwZW9mIHZhbHVlICE9PSAib2JqZWN0IiB8fCB2YWx1ZSA9PT0gbnVsbCkgcmV0dXJuIGZhbHNlOwogIGNvbnN0IHByb3RvdHlwZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih2YWx1ZSk7CiAgcmV0dXJuIChwcm90b3R5cGUgPT09IG51bGwgfHwgcHJvdG90eXBlID09PSBPYmplY3QucHJvdG90eXBlIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihwcm90b3R5cGUpID09PSBudWxsKSAmJiAhKFN5bWJvbC50b1N0cmluZ1RhZyBpbiB2YWx1ZSkgJiYgIShTeW1ib2wuaXRlcmF0b3IgaW4gdmFsdWUpOwp9Owp2YXIgcmVjdXJzaXZlVG9DYW1lbCA9IChpdGVtKSA9PiB7CiAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkpIHJldHVybiBpdGVtLm1hcCgoZWwpID0+IHJlY3Vyc2l2ZVRvQ2FtZWwoZWwpKTsKICBlbHNlIGlmICh0eXBlb2YgaXRlbSA9PT0gImZ1bmN0aW9uIiB8fCBpdGVtICE9PSBPYmplY3QoaXRlbSkpIHJldHVybiBpdGVtOwogIGNvbnN0IHJlc3VsdCA9IHt9OwogIE9iamVjdC5lbnRyaWVzKGl0ZW0pLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4gewogICAgY29uc3QgbmV3S2V5ID0ga2V5LnJlcGxhY2UoLyhbLV9dW2Etel0pL2dpLCAoYykgPT4gYy50b1VwcGVyQ2FzZSgpLnJlcGxhY2UoL1stX10vZywgIiIpKTsKICAgIHJlc3VsdFtuZXdLZXldID0gcmVjdXJzaXZlVG9DYW1lbCh2YWx1ZSk7CiAgfSk7CiAgcmV0dXJuIHJlc3VsdDsKfTsKdmFyIGlzVmFsaWRCdWNrZXROYW1lID0gKGJ1Y2tldE5hbWUpID0+IHsKICBpZiAoIWJ1Y2tldE5hbWUgfHwgdHlwZW9mIGJ1Y2tldE5hbWUgIT09ICJzdHJpbmciKSByZXR1cm4gZmFsc2U7CiAgaWYgKGJ1Y2tldE5hbWUubGVuZ3RoID09PSAwIHx8IGJ1Y2tldE5hbWUubGVuZ3RoID4gMTAwKSByZXR1cm4gZmFsc2U7CiAgaWYgKGJ1Y2tldE5hbWUudHJpbSgpICE9PSBidWNrZXROYW1lKSByZXR1cm4gZmFsc2U7CiAgaWYgKGJ1Y2tldE5hbWUuaW5jbHVkZXMoIi8iKSB8fCBidWNrZXROYW1lLmluY2x1ZGVzKCJcXCIpKSByZXR1cm4gZmFsc2U7CiAgcmV0dXJuIC9eW1x3IS5cKicoKSAmJEA9OzorLD8tXSskLy50ZXN0KGJ1Y2tldE5hbWUpOwp9OwpmdW5jdGlvbiBfdHlwZW9mMihvKSB7CiAgIkBiYWJlbC9oZWxwZXJzIC0gdHlwZW9mIjsKICByZXR1cm4gX3R5cGVvZjIgPSAiZnVuY3Rpb24iID09IHR5cGVvZiBTeW1ib2wgJiYgInN5bWJvbCIgPT0gdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA/IGZ1bmN0aW9uKG8kMSkgewogICAgcmV0dXJuIHR5cGVvZiBvJDE7CiAgfSA6IGZ1bmN0aW9uKG8kMSkgewogICAgcmV0dXJuIG8kMSAmJiAiZnVuY3Rpb24iID09IHR5cGVvZiBTeW1ib2wgJiYgbyQxLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgbyQxICE9PSBTeW1ib2wucHJvdG90eXBlID8gInN5bWJvbCIgOiB0eXBlb2YgbyQxOwogIH0sIF90eXBlb2YyKG8pOwp9CmZ1bmN0aW9uIHRvUHJpbWl0aXZlMih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSBfdHlwZW9mMih0KSB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSBfdHlwZW9mMihpKSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gdG9Qcm9wZXJ0eUtleTIodCkgewogIHZhciBpID0gdG9QcmltaXRpdmUyKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gX3R5cGVvZjIoaSkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTM1KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IHRvUHJvcGVydHlLZXkyKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgewogICAgdmFsdWU6IHQsCiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgd3JpdGFibGU6IHRydWUKICB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBvd25LZXlzMzMoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIkMSkgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByJDEpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDIxMShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czMzKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyJDEpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MzUoZSwgciQxLCB0W3IkMV0pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzMyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ociQxKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByJDEsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgciQxKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KdmFyIF9nZXRFcnJvck1lc3NhZ2UgPSAoZXJyKSA9PiB7CiAgdmFyIF9lcnIkZXJyb3I7CiAgcmV0dXJuIGVyci5tc2cgfHwgZXJyLm1lc3NhZ2UgfHwgZXJyLmVycm9yX2Rlc2NyaXB0aW9uIHx8ICh0eXBlb2YgZXJyLmVycm9yID09PSAic3RyaW5nIiA/IGVyci5lcnJvciA6IChfZXJyJGVycm9yID0gZXJyLmVycm9yKSA9PT0gbnVsbCB8fCBfZXJyJGVycm9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZXJyJGVycm9yLm1lc3NhZ2UpIHx8IEpTT04uc3RyaW5naWZ5KGVycik7Cn07CnZhciBoYW5kbGVFcnJvciA9IGFzeW5jIChlcnJvciwgcmVqZWN0LCBvcHRpb25zLCBuYW1lc3BhY2UpID0+IHsKICBpZiAoZXJyb3IgJiYgdHlwZW9mIGVycm9yID09PSAib2JqZWN0IiAmJiAic3RhdHVzIiBpbiBlcnJvciAmJiAib2siIGluIGVycm9yICYmIHR5cGVvZiBlcnJvci5zdGF0dXMgPT09ICJudW1iZXIiICYmICEob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLm5vUmVzb2x2ZUpzb24pKSB7CiAgICBjb25zdCByZXNwb25zZUVycm9yID0gZXJyb3I7CiAgICBjb25zdCBzdGF0dXMgPSByZXNwb25zZUVycm9yLnN0YXR1cyB8fCA1MDA7CiAgICBpZiAodHlwZW9mIHJlc3BvbnNlRXJyb3IuanNvbiA9PT0gImZ1bmN0aW9uIikgcmVzcG9uc2VFcnJvci5qc29uKCkudGhlbigoZXJyKSA9PiB7CiAgICAgIGNvbnN0IHN0YXR1c0NvZGUgPSAoZXJyID09PSBudWxsIHx8IGVyciA9PT0gdm9pZCAwID8gdm9pZCAwIDogZXJyLnN0YXR1c0NvZGUpIHx8IChlcnIgPT09IG51bGwgfHwgZXJyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBlcnIuY29kZSkgfHwgc3RhdHVzICsgIiI7CiAgICAgIHJlamVjdChuZXcgU3RvcmFnZUFwaUVycm9yKF9nZXRFcnJvck1lc3NhZ2UoZXJyKSwgc3RhdHVzLCBzdGF0dXNDb2RlLCBuYW1lc3BhY2UpKTsKICAgIH0pLmNhdGNoKCgpID0+IHsKICAgICAgaWYgKG5hbWVzcGFjZSA9PT0gInZlY3RvcnMiKSB7CiAgICAgICAgY29uc3Qgc3RhdHVzQ29kZSA9IHN0YXR1cyArICIiOwogICAgICAgIHJlamVjdChuZXcgU3RvcmFnZUFwaUVycm9yKHJlc3BvbnNlRXJyb3Iuc3RhdHVzVGV4dCB8fCBgSFRUUCAke3N0YXR1c30gZXJyb3JgLCBzdGF0dXMsIHN0YXR1c0NvZGUsIG5hbWVzcGFjZSkpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHN0YXR1c0NvZGUgPSBzdGF0dXMgKyAiIjsKICAgICAgICByZWplY3QobmV3IFN0b3JhZ2VBcGlFcnJvcihyZXNwb25zZUVycm9yLnN0YXR1c1RleHQgfHwgYEhUVFAgJHtzdGF0dXN9IGVycm9yYCwgc3RhdHVzLCBzdGF0dXNDb2RlLCBuYW1lc3BhY2UpKTsKICAgICAgfQogICAgfSk7CiAgICBlbHNlIHsKICAgICAgY29uc3Qgc3RhdHVzQ29kZSA9IHN0YXR1cyArICIiOwogICAgICByZWplY3QobmV3IFN0b3JhZ2VBcGlFcnJvcihyZXNwb25zZUVycm9yLnN0YXR1c1RleHQgfHwgYEhUVFAgJHtzdGF0dXN9IGVycm9yYCwgc3RhdHVzLCBzdGF0dXNDb2RlLCBuYW1lc3BhY2UpKTsKICAgIH0KICB9IGVsc2UgcmVqZWN0KG5ldyBTdG9yYWdlVW5rbm93bkVycm9yKF9nZXRFcnJvck1lc3NhZ2UoZXJyb3IpLCBlcnJvciwgbmFtZXNwYWNlKSk7Cn07CnZhciBfZ2V0UmVxdWVzdFBhcmFtcyA9IChtZXRob2QsIG9wdGlvbnMsIHBhcmFtZXRlcnMsIGJvZHkpID0+IHsKICBjb25zdCBwYXJhbXMgPSB7CiAgICBtZXRob2QsCiAgICBoZWFkZXJzOiAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmhlYWRlcnMpIHx8IHt9CiAgfTsKICBpZiAobWV0aG9kID09PSAiR0VUIiB8fCBtZXRob2QgPT09ICJIRUFEIiB8fCAhYm9keSkgcmV0dXJuIF9vYmplY3RTcHJlYWQyMTEoX29iamVjdFNwcmVhZDIxMSh7fSwgcGFyYW1zKSwgcGFyYW1ldGVycyk7CiAgaWYgKGlzUGxhaW5PYmplY3Q0KGJvZHkpKSB7CiAgICBwYXJhbXMuaGVhZGVycyA9IF9vYmplY3RTcHJlYWQyMTEoeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sIG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5oZWFkZXJzKTsKICAgIHBhcmFtcy5ib2R5ID0gSlNPTi5zdHJpbmdpZnkoYm9keSk7CiAgfSBlbHNlIHBhcmFtcy5ib2R5ID0gYm9keTsKICBpZiAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmR1cGxleCkgcGFyYW1zLmR1cGxleCA9IG9wdGlvbnMuZHVwbGV4OwogIHJldHVybiBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIHBhcmFtcyksIHBhcmFtZXRlcnMpOwp9Owphc3luYyBmdW5jdGlvbiBfaGFuZGxlUmVxdWVzdChmZXRjaGVyLCBtZXRob2QsIHVybCwgb3B0aW9ucywgcGFyYW1ldGVycywgYm9keSwgbmFtZXNwYWNlKSB7CiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIGZldGNoZXIodXJsLCBfZ2V0UmVxdWVzdFBhcmFtcyhtZXRob2QsIG9wdGlvbnMsIHBhcmFtZXRlcnMsIGJvZHkpKS50aGVuKChyZXN1bHQpID0+IHsKICAgICAgaWYgKCFyZXN1bHQub2spIHRocm93IHJlc3VsdDsKICAgICAgaWYgKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5ub1Jlc29sdmVKc29uKSByZXR1cm4gcmVzdWx0OwogICAgICBpZiAobmFtZXNwYWNlID09PSAidmVjdG9ycyIpIHsKICAgICAgICBjb25zdCBjb250ZW50VHlwZSA9IHJlc3VsdC5oZWFkZXJzLmdldCgiY29udGVudC10eXBlIik7CiAgICAgICAgaWYgKHJlc3VsdC5oZWFkZXJzLmdldCgiY29udGVudC1sZW5ndGgiKSA9PT0gIjAiIHx8IHJlc3VsdC5zdGF0dXMgPT09IDIwNCkgcmV0dXJuIHt9OwogICAgICAgIGlmICghY29udGVudFR5cGUgfHwgIWNvbnRlbnRUeXBlLmluY2x1ZGVzKCJhcHBsaWNhdGlvbi9qc29uIikpIHJldHVybiB7fTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0Lmpzb24oKTsKICAgIH0pLnRoZW4oKGRhdGEpID0+IHJlc29sdmUoZGF0YSkpLmNhdGNoKChlcnJvcikgPT4gaGFuZGxlRXJyb3IoZXJyb3IsIHJlamVjdCwgb3B0aW9ucywgbmFtZXNwYWNlKSk7CiAgfSk7Cn0KZnVuY3Rpb24gY3JlYXRlRmV0Y2hBcGkobmFtZXNwYWNlID0gInN0b3JhZ2UiKSB7CiAgcmV0dXJuIHsKICAgIGdldDogYXN5bmMgKGZldGNoZXIsIHVybCwgb3B0aW9ucywgcGFyYW1ldGVycykgPT4gewogICAgICByZXR1cm4gX2hhbmRsZVJlcXVlc3QoZmV0Y2hlciwgIkdFVCIsIHVybCwgb3B0aW9ucywgcGFyYW1ldGVycywgdm9pZCAwLCBuYW1lc3BhY2UpOwogICAgfSwKICAgIHBvc3Q6IGFzeW5jIChmZXRjaGVyLCB1cmwsIGJvZHksIG9wdGlvbnMsIHBhcmFtZXRlcnMpID0+IHsKICAgICAgcmV0dXJuIF9oYW5kbGVSZXF1ZXN0KGZldGNoZXIsICJQT1NUIiwgdXJsLCBvcHRpb25zLCBwYXJhbWV0ZXJzLCBib2R5LCBuYW1lc3BhY2UpOwogICAgfSwKICAgIHB1dDogYXN5bmMgKGZldGNoZXIsIHVybCwgYm9keSwgb3B0aW9ucywgcGFyYW1ldGVycykgPT4gewogICAgICByZXR1cm4gX2hhbmRsZVJlcXVlc3QoZmV0Y2hlciwgIlBVVCIsIHVybCwgb3B0aW9ucywgcGFyYW1ldGVycywgYm9keSwgbmFtZXNwYWNlKTsKICAgIH0sCiAgICBoZWFkOiBhc3luYyAoZmV0Y2hlciwgdXJsLCBvcHRpb25zLCBwYXJhbWV0ZXJzKSA9PiB7CiAgICAgIHJldHVybiBfaGFuZGxlUmVxdWVzdChmZXRjaGVyLCAiSEVBRCIsIHVybCwgX29iamVjdFNwcmVhZDIxMShfb2JqZWN0U3ByZWFkMjExKHt9LCBvcHRpb25zKSwge30sIHsgbm9SZXNvbHZlSnNvbjogdHJ1ZSB9KSwgcGFyYW1ldGVycywgdm9pZCAwLCBuYW1lc3BhY2UpOwogICAgfSwKICAgIHJlbW92ZTogYXN5bmMgKGZldGNoZXIsIHVybCwgYm9keSwgb3B0aW9ucywgcGFyYW1ldGVycykgPT4gewogICAgICByZXR1cm4gX2hhbmRsZVJlcXVlc3QoZmV0Y2hlciwgIkRFTEVURSIsIHVybCwgb3B0aW9ucywgcGFyYW1ldGVycywgYm9keSwgbmFtZXNwYWNlKTsKICAgIH0KICB9Owp9CnZhciBkZWZhdWx0QXBpID0gY3JlYXRlRmV0Y2hBcGkoInN0b3JhZ2UiKTsKdmFyIHsgZ2V0OiBnZXQ1LCBwb3N0LCBwdXQsIGhlYWQsIHJlbW92ZSB9ID0gZGVmYXVsdEFwaTsKdmFyIHZlY3RvcnNBcGkgPSBjcmVhdGVGZXRjaEFwaSgidmVjdG9ycyIpOwp2YXIgQmFzZUFwaUNsaWVudCA9IGNsYXNzIHsKICAvKioKICAqIENyZWF0ZXMgYSBuZXcgQmFzZUFwaUNsaWVudCBpbnN0YW5jZQogICogQHBhcmFtIHVybCAtIEJhc2UgVVJMIGZvciBBUEkgcmVxdWVzdHMKICAqIEBwYXJhbSBoZWFkZXJzIC0gRGVmYXVsdCBoZWFkZXJzIGZvciBBUEkgcmVxdWVzdHMKICAqIEBwYXJhbSBmZXRjaCAtIE9wdGlvbmFsIGN1c3RvbSBmZXRjaCBpbXBsZW1lbnRhdGlvbgogICogQHBhcmFtIG5hbWVzcGFjZSAtIEVycm9yIG5hbWVzcGFjZSAoJ3N0b3JhZ2UnIG9yICd2ZWN0b3JzJykKICAqLwogIGNvbnN0cnVjdG9yKHVybCwgaGVhZGVycyA9IHt9LCBmZXRjaCQxLCBuYW1lc3BhY2UgPSAic3RvcmFnZSIpIHsKICAgIHRoaXMuc2hvdWxkVGhyb3dPbkVycm9yID0gZmFsc2U7CiAgICB0aGlzLnVybCA9IHVybDsKICAgIHRoaXMuaGVhZGVycyA9IGhlYWRlcnM7CiAgICB0aGlzLmZldGNoID0gcmVzb2x2ZUZldGNoMihmZXRjaCQxKTsKICAgIHRoaXMubmFtZXNwYWNlID0gbmFtZXNwYWNlOwogIH0KICAvKioKICAqIEVuYWJsZSB0aHJvd2luZyBlcnJvcnMgaW5zdGVhZCBvZiByZXR1cm5pbmcgdGhlbS4KICAqIFdoZW4gZW5hYmxlZCwgZXJyb3JzIGFyZSB0aHJvd24gaW5zdGVhZCBvZiByZXR1cm5lZCBpbiB7IGRhdGEsIGVycm9yIH0gZm9ybWF0LgogICoKICAqIEByZXR1cm5zIHRoaXMgLSBGb3IgbWV0aG9kIGNoYWluaW5nCiAgKi8KICB0aHJvd09uRXJyb3IoKSB7CiAgICB0aGlzLnNob3VsZFRocm93T25FcnJvciA9IHRydWU7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBTZXQgYW4gSFRUUCBoZWFkZXIgZm9yIHRoZSByZXF1ZXN0LgogICogQ3JlYXRlcyBhIHNoYWxsb3cgY29weSBvZiBoZWFkZXJzIHRvIGF2b2lkIG11dGF0aW5nIHNoYXJlZCBzdGF0ZS4KICAqCiAgKiBAcGFyYW0gbmFtZSAtIEhlYWRlciBuYW1lCiAgKiBAcGFyYW0gdmFsdWUgLSBIZWFkZXIgdmFsdWUKICAqIEByZXR1cm5zIHRoaXMgLSBGb3IgbWV0aG9kIGNoYWluaW5nCiAgKi8KICBzZXRIZWFkZXIobmFtZSwgdmFsdWUpIHsKICAgIHRoaXMuaGVhZGVycyA9IF9vYmplY3RTcHJlYWQyMTEoX29iamVjdFNwcmVhZDIxMSh7fSwgdGhpcy5oZWFkZXJzKSwge30sIHsgW25hbWVdOiB2YWx1ZSB9KTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIEhhbmRsZXMgQVBJIG9wZXJhdGlvbiB3aXRoIHN0YW5kYXJkaXplZCBlcnJvciBoYW5kbGluZwogICogRWxpbWluYXRlcyByZXBldGl0aXZlIHRyeS1jYXRjaCBibG9ja3MgYWNyb3NzIGFsbCBBUEkgbWV0aG9kcwogICoKICAqIFRoaXMgd3JhcHBlcjoKICAqIDEuIEV4ZWN1dGVzIHRoZSBvcGVyYXRpb24KICAqIDIuIFJldHVybnMgeyBkYXRhLCBlcnJvcjogbnVsbCB9IG9uIHN1Y2Nlc3MKICAqIDMuIFJldHVybnMgeyBkYXRhOiBudWxsLCBlcnJvciB9IG9uIGZhaWx1cmUgKGlmIHNob3VsZFRocm93T25FcnJvciBpcyBmYWxzZSkKICAqIDQuIFRocm93cyBlcnJvciBvbiBmYWlsdXJlIChpZiBzaG91bGRUaHJvd09uRXJyb3IgaXMgdHJ1ZSkKICAqCiAgKiBAdHlwZVBhcmFtIFQgLSBUaGUgZXhwZWN0ZWQgZGF0YSB0eXBlIGZyb20gdGhlIG9wZXJhdGlvbgogICogQHBhcmFtIG9wZXJhdGlvbiAtIEFzeW5jIGZ1bmN0aW9uIHRoYXQgcGVyZm9ybXMgdGhlIEFQSSBjYWxsCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggeyBkYXRhLCBlcnJvciB9IHR1cGxlCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGFzeW5jIGxpc3RCdWNrZXRzKCkgewogICogICByZXR1cm4gdGhpcy5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICogICAgIHJldHVybiBhd2FpdCBnZXQodGhpcy5mZXRjaCwgYCR7dGhpcy51cmx9L2J1Y2tldGAsIHsKICAqICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAqICAgICB9KQogICogICB9KQogICogfQogICogYGBgCiAgKi8KICBhc3luYyBoYW5kbGVPcGVyYXRpb24ob3BlcmF0aW9uKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgdHJ5IHsKICAgICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiBhd2FpdCBvcGVyYXRpb24oKSwKICAgICAgICBlcnJvcjogbnVsbAogICAgICB9OwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKF90aGlzLnNob3VsZFRocm93T25FcnJvcikgdGhyb3cgZXJyb3I7CiAgICAgIGlmIChpc1N0b3JhZ2VFcnJvcihlcnJvcikpIHJldHVybiB7CiAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICBlcnJvcgogICAgICB9OwogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9Cn07CnZhciBTdHJlYW1Eb3dubG9hZEJ1aWxkZXIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoZG93bmxvYWRGbiwgc2hvdWxkVGhyb3dPbkVycm9yKSB7CiAgICB0aGlzLmRvd25sb2FkRm4gPSBkb3dubG9hZEZuOwogICAgdGhpcy5zaG91bGRUaHJvd09uRXJyb3IgPSBzaG91bGRUaHJvd09uRXJyb3I7CiAgfQogIHRoZW4ob25mdWxmaWxsZWQsIG9ucmVqZWN0ZWQpIHsKICAgIHJldHVybiB0aGlzLmV4ZWN1dGUoKS50aGVuKG9uZnVsZmlsbGVkLCBvbnJlamVjdGVkKTsKICB9CiAgYXN5bmMgZXhlY3V0ZSgpIHsKICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICB0cnkgewogICAgICByZXR1cm4gewogICAgICAgIGRhdGE6IChhd2FpdCBfdGhpcy5kb3dubG9hZEZuKCkpLmJvZHksCiAgICAgICAgZXJyb3I6IG51bGwKICAgICAgfTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChfdGhpcy5zaG91bGRUaHJvd09uRXJyb3IpIHRocm93IGVycm9yOwogICAgICBpZiAoaXNTdG9yYWdlRXJyb3IoZXJyb3IpKSByZXR1cm4gewogICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgZXJyb3IKICAgICAgfTsKICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQp9Owp2YXIgX1N5bWJvbCR0b1N0cmluZ1RhZzsKX1N5bWJvbCR0b1N0cmluZ1RhZyA9IFN5bWJvbC50b1N0cmluZ1RhZzsKdmFyIEJsb2JEb3dubG9hZEJ1aWxkZXIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoZG93bmxvYWRGbiwgc2hvdWxkVGhyb3dPbkVycm9yKSB7CiAgICB0aGlzLmRvd25sb2FkRm4gPSBkb3dubG9hZEZuOwogICAgdGhpcy5zaG91bGRUaHJvd09uRXJyb3IgPSBzaG91bGRUaHJvd09uRXJyb3I7CiAgICB0aGlzW19TeW1ib2wkdG9TdHJpbmdUYWddID0gIkJsb2JEb3dubG9hZEJ1aWxkZXIiOwogICAgdGhpcy5wcm9taXNlID0gbnVsbDsKICB9CiAgYXNTdHJlYW0oKSB7CiAgICByZXR1cm4gbmV3IFN0cmVhbURvd25sb2FkQnVpbGRlcih0aGlzLmRvd25sb2FkRm4sIHRoaXMuc2hvdWxkVGhyb3dPbkVycm9yKTsKICB9CiAgdGhlbihvbmZ1bGZpbGxlZCwgb25yZWplY3RlZCkgewogICAgcmV0dXJuIHRoaXMuZ2V0UHJvbWlzZSgpLnRoZW4ob25mdWxmaWxsZWQsIG9ucmVqZWN0ZWQpOwogIH0KICBjYXRjaChvbnJlamVjdGVkKSB7CiAgICByZXR1cm4gdGhpcy5nZXRQcm9taXNlKCkuY2F0Y2gob25yZWplY3RlZCk7CiAgfQogIGZpbmFsbHkob25maW5hbGx5KSB7CiAgICByZXR1cm4gdGhpcy5nZXRQcm9taXNlKCkuZmluYWxseShvbmZpbmFsbHkpOwogIH0KICBnZXRQcm9taXNlKCkgewogICAgaWYgKCF0aGlzLnByb21pc2UpIHRoaXMucHJvbWlzZSA9IHRoaXMuZXhlY3V0ZSgpOwogICAgcmV0dXJuIHRoaXMucHJvbWlzZTsKICB9CiAgYXN5bmMgZXhlY3V0ZSgpIHsKICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICB0cnkgewogICAgICByZXR1cm4gewogICAgICAgIGRhdGE6IGF3YWl0IChhd2FpdCBfdGhpcy5kb3dubG9hZEZuKCkpLmJsb2IoKSwKICAgICAgICBlcnJvcjogbnVsbAogICAgICB9OwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKF90aGlzLnNob3VsZFRocm93T25FcnJvcikgdGhyb3cgZXJyb3I7CiAgICAgIGlmIChpc1N0b3JhZ2VFcnJvcihlcnJvcikpIHJldHVybiB7CiAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICBlcnJvcgogICAgICB9OwogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9Cn07CnZhciBERUZBVUxUX1NFQVJDSF9PUFRJT05TID0gewogIGxpbWl0OiAxMDAsCiAgb2Zmc2V0OiAwLAogIHNvcnRCeTogewogICAgY29sdW1uOiAibmFtZSIsCiAgICBvcmRlcjogImFzYyIKICB9Cn07CnZhciBERUZBVUxUX0ZJTEVfT1BUSU9OUyA9IHsKICBjYWNoZUNvbnRyb2w6ICIzNjAwIiwKICBjb250ZW50VHlwZTogInRleHQvcGxhaW47Y2hhcnNldD1VVEYtOCIsCiAgdXBzZXJ0OiBmYWxzZQp9Owp2YXIgU3RvcmFnZUZpbGVBcGkgPSBjbGFzcyBleHRlbmRzIEJhc2VBcGlDbGllbnQgewogIGNvbnN0cnVjdG9yKHVybCwgaGVhZGVycyA9IHt9LCBidWNrZXRJZCwgZmV0Y2gkMSkgewogICAgc3VwZXIodXJsLCBoZWFkZXJzLCBmZXRjaCQxLCAic3RvcmFnZSIpOwogICAgdGhpcy5idWNrZXRJZCA9IGJ1Y2tldElkOwogIH0KICAvKioKICAqIFVwbG9hZHMgYSBmaWxlIHRvIGFuIGV4aXN0aW5nIGJ1Y2tldCBvciByZXBsYWNlcyBhbiBleGlzdGluZyBmaWxlIGF0IHRoZSBzcGVjaWZpZWQgcGF0aCB3aXRoIGEgbmV3IG9uZS4KICAqCiAgKiBAcGFyYW0gbWV0aG9kIEhUVFAgbWV0aG9kLgogICogQHBhcmFtIHBhdGggVGhlIHJlbGF0aXZlIGZpbGUgcGF0aC4gU2hvdWxkIGJlIG9mIHRoZSBmb3JtYXQgYGZvbGRlci9zdWJmb2xkZXIvZmlsZW5hbWUucG5nYC4gVGhlIGJ1Y2tldCBtdXN0IGFscmVhZHkgZXhpc3QgYmVmb3JlIGF0dGVtcHRpbmcgdG8gdXBsb2FkLgogICogQHBhcmFtIGZpbGVCb2R5IFRoZSBib2R5IG9mIHRoZSBmaWxlIHRvIGJlIHN0b3JlZCBpbiB0aGUgYnVja2V0LgogICovCiAgYXN5bmMgdXBsb2FkT3JVcGRhdGUobWV0aG9kLCBwYXRoMiwgZmlsZUJvZHksIGZpbGVPcHRpb25zKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIGxldCBib2R5OwogICAgICBjb25zdCBvcHRpb25zID0gX29iamVjdFNwcmVhZDIxMShfb2JqZWN0U3ByZWFkMjExKHt9LCBERUZBVUxUX0ZJTEVfT1BUSU9OUyksIGZpbGVPcHRpb25zKTsKICAgICAgbGV0IGhlYWRlcnMgPSBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIF90aGlzLmhlYWRlcnMpLCBtZXRob2QgPT09ICJQT1NUIiAmJiB7ICJ4LXVwc2VydCI6IFN0cmluZyhvcHRpb25zLnVwc2VydCkgfSk7CiAgICAgIGNvbnN0IG1ldGFkYXRhID0gb3B0aW9ucy5tZXRhZGF0YTsKICAgICAgaWYgKHR5cGVvZiBCbG9iICE9PSAidW5kZWZpbmVkIiAmJiBmaWxlQm9keSBpbnN0YW5jZW9mIEJsb2IpIHsKICAgICAgICBib2R5ID0gbmV3IEZvcm1EYXRhKCk7CiAgICAgICAgYm9keS5hcHBlbmQoImNhY2hlQ29udHJvbCIsIG9wdGlvbnMuY2FjaGVDb250cm9sKTsKICAgICAgICBpZiAobWV0YWRhdGEpIGJvZHkuYXBwZW5kKCJtZXRhZGF0YSIsIF90aGlzLmVuY29kZU1ldGFkYXRhKG1ldGFkYXRhKSk7CiAgICAgICAgYm9keS5hcHBlbmQoIiIsIGZpbGVCb2R5KTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgRm9ybURhdGEgIT09ICJ1bmRlZmluZWQiICYmIGZpbGVCb2R5IGluc3RhbmNlb2YgRm9ybURhdGEpIHsKICAgICAgICBib2R5ID0gZmlsZUJvZHk7CiAgICAgICAgaWYgKCFib2R5LmhhcygiY2FjaGVDb250cm9sIikpIGJvZHkuYXBwZW5kKCJjYWNoZUNvbnRyb2wiLCBvcHRpb25zLmNhY2hlQ29udHJvbCk7CiAgICAgICAgaWYgKG1ldGFkYXRhICYmICFib2R5LmhhcygibWV0YWRhdGEiKSkgYm9keS5hcHBlbmQoIm1ldGFkYXRhIiwgX3RoaXMuZW5jb2RlTWV0YWRhdGEobWV0YWRhdGEpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBib2R5ID0gZmlsZUJvZHk7CiAgICAgICAgaGVhZGVyc1siY2FjaGUtY29udHJvbCJdID0gYG1heC1hZ2U9JHtvcHRpb25zLmNhY2hlQ29udHJvbH1gOwogICAgICAgIGhlYWRlcnNbImNvbnRlbnQtdHlwZSJdID0gb3B0aW9ucy5jb250ZW50VHlwZTsKICAgICAgICBpZiAobWV0YWRhdGEpIGhlYWRlcnNbIngtbWV0YWRhdGEiXSA9IF90aGlzLnRvQmFzZTY0KF90aGlzLmVuY29kZU1ldGFkYXRhKG1ldGFkYXRhKSk7CiAgICAgICAgaWYgKCh0eXBlb2YgUmVhZGFibGVTdHJlYW0gIT09ICJ1bmRlZmluZWQiICYmIGJvZHkgaW5zdGFuY2VvZiBSZWFkYWJsZVN0cmVhbSB8fCBib2R5ICYmIHR5cGVvZiBib2R5ID09PSAib2JqZWN0IiAmJiAicGlwZSIgaW4gYm9keSAmJiB0eXBlb2YgYm9keS5waXBlID09PSAiZnVuY3Rpb24iKSAmJiAhb3B0aW9ucy5kdXBsZXgpIG9wdGlvbnMuZHVwbGV4ID0gImhhbGYiOwogICAgICB9CiAgICAgIGlmIChmaWxlT3B0aW9ucyA9PT0gbnVsbCB8fCBmaWxlT3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmlsZU9wdGlvbnMuaGVhZGVycykgaGVhZGVycyA9IF9vYmplY3RTcHJlYWQyMTEoX29iamVjdFNwcmVhZDIxMSh7fSwgaGVhZGVycyksIGZpbGVPcHRpb25zLmhlYWRlcnMpOwogICAgICBjb25zdCBjbGVhblBhdGggPSBfdGhpcy5fcmVtb3ZlRW1wdHlGb2xkZXJzKHBhdGgyKTsKICAgICAgY29uc3QgX3BhdGggPSBfdGhpcy5fZ2V0RmluYWxQYXRoKGNsZWFuUGF0aCk7CiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCAobWV0aG9kID09ICJQVVQiID8gcHV0IDogcG9zdCkoX3RoaXMuZmV0Y2gsIGAke190aGlzLnVybH0vb2JqZWN0LyR7X3BhdGh9YCwgYm9keSwgX29iamVjdFNwcmVhZDIxMSh7IGhlYWRlcnMgfSwgKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5kdXBsZXgpID8geyBkdXBsZXg6IG9wdGlvbnMuZHVwbGV4IH0gOiB7fSkpOwogICAgICByZXR1cm4gewogICAgICAgIHBhdGg6IGNsZWFuUGF0aCwKICAgICAgICBpZDogZGF0YS5JZCwKICAgICAgICBmdWxsUGF0aDogZGF0YS5LZXkKICAgICAgfTsKICAgIH0pOwogIH0KICAvKioKICAqIFVwbG9hZHMgYSBmaWxlIHRvIGFuIGV4aXN0aW5nIGJ1Y2tldC4KICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gcGF0aCBUaGUgZmlsZSBwYXRoLCBpbmNsdWRpbmcgdGhlIGZpbGUgbmFtZS4gU2hvdWxkIGJlIG9mIHRoZSBmb3JtYXQgYGZvbGRlci9zdWJmb2xkZXIvZmlsZW5hbWUucG5nYC4gVGhlIGJ1Y2tldCBtdXN0IGFscmVhZHkgZXhpc3QgYmVmb3JlIGF0dGVtcHRpbmcgdG8gdXBsb2FkLgogICogQHBhcmFtIGZpbGVCb2R5IFRoZSBib2R5IG9mIHRoZSBmaWxlIHRvIGJlIHN0b3JlZCBpbiB0aGUgYnVja2V0LgogICogQHBhcmFtIGZpbGVPcHRpb25zIE9wdGlvbmFsIGZpbGUgdXBsb2FkIG9wdGlvbnMgaW5jbHVkaW5nIGNhY2hlQ29udHJvbCwgY29udGVudFR5cGUsIHVwc2VydCwgYW5kIG1ldGFkYXRhLgogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIHJlc3BvbnNlIGNvbnRhaW5pbmcgZmlsZSBwYXRoLCBpZCwgYW5kIGZ1bGxQYXRoIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUgVXBsb2FkIGZpbGUKICAqIGBgYGpzCiAgKiBjb25zdCBhdmF0YXJGaWxlID0gZXZlbnQudGFyZ2V0LmZpbGVzWzBdCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZnJvbSgnYXZhdGFycycpCiAgKiAgIC51cGxvYWQoJ3B1YmxpYy9hdmF0YXIxLnBuZycsIGF2YXRhckZpbGUsIHsKICAqICAgICBjYWNoZUNvbnRyb2w6ICczNjAwJywKICAqICAgICB1cHNlcnQ6IGZhbHNlCiAgKiAgIH0pCiAgKiBgYGAKICAqCiAgKiBSZXNwb25zZToKICAqIGBgYGpzb24KICAqIHsKICAqICAgImRhdGEiOiB7CiAgKiAgICAgInBhdGgiOiAicHVibGljL2F2YXRhcjEucG5nIiwKICAqICAgICAiZnVsbFBhdGgiOiAiYXZhdGFycy9wdWJsaWMvYXZhdGFyMS5wbmciCiAgKiAgIH0sCiAgKiAgICJlcnJvciI6IG51bGwKICAqIH0KICAqIGBgYAogICoKICAqIEBleGFtcGxlIFVwbG9hZCBmaWxlIHVzaW5nIGBBcnJheUJ1ZmZlcmAgZnJvbSBiYXNlNjQgZmlsZSBkYXRhCiAgKiBgYGBqcwogICogaW1wb3J0IHsgZGVjb2RlIH0gZnJvbSAnYmFzZTY0LWFycmF5YnVmZmVyJwogICoKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLnVwbG9hZCgncHVibGljL2F2YXRhcjEucG5nJywgZGVjb2RlKCdiYXNlNjRGaWxlRGF0YScpLCB7CiAgKiAgICAgY29udGVudFR5cGU6ICdpbWFnZS9wbmcnCiAgKiAgIH0pCiAgKiBgYGAKICAqLwogIGFzeW5jIHVwbG9hZChwYXRoMiwgZmlsZUJvZHksIGZpbGVPcHRpb25zKSB7CiAgICByZXR1cm4gdGhpcy51cGxvYWRPclVwZGF0ZSgiUE9TVCIsIHBhdGgyLCBmaWxlQm9keSwgZmlsZU9wdGlvbnMpOwogIH0KICAvKioKICAqIFVwbG9hZCBhIGZpbGUgd2l0aCBhIHRva2VuIGdlbmVyYXRlZCBmcm9tIGBjcmVhdGVTaWduZWRVcGxvYWRVcmxgLgogICoKICAqIEBjYXRlZ29yeSBGaWxlIEJ1Y2tldHMKICAqIEBwYXJhbSBwYXRoIFRoZSBmaWxlIHBhdGgsIGluY2x1ZGluZyB0aGUgZmlsZSBuYW1lLiBTaG91bGQgYmUgb2YgdGhlIGZvcm1hdCBgZm9sZGVyL3N1YmZvbGRlci9maWxlbmFtZS5wbmdgLiBUaGUgYnVja2V0IG11c3QgYWxyZWFkeSBleGlzdCBiZWZvcmUgYXR0ZW1wdGluZyB0byB1cGxvYWQuCiAgKiBAcGFyYW0gdG9rZW4gVGhlIHRva2VuIGdlbmVyYXRlZCBmcm9tIGBjcmVhdGVTaWduZWRVcGxvYWRVcmxgCiAgKiBAcGFyYW0gZmlsZUJvZHkgVGhlIGJvZHkgb2YgdGhlIGZpbGUgdG8gYmUgc3RvcmVkIGluIHRoZSBidWNrZXQuCiAgKiBAcGFyYW0gZmlsZU9wdGlvbnMgSFRUUCBoZWFkZXJzIChjYWNoZUNvbnRyb2wsIGNvbnRlbnRUeXBlLCBldGMuKS4KICAqICoqTm90ZToqKiBUaGUgYHVwc2VydGAgb3B0aW9uIGhhcyBubyBlZmZlY3QgaGVyZS4gVG8gZW5hYmxlIHVwc2VydCBiZWhhdmlvciwKICAqIHBhc3MgYHsgdXBzZXJ0OiB0cnVlIH1gIHdoZW4gY2FsbGluZyBgY3JlYXRlU2lnbmVkVXBsb2FkVXJsKClgIGluc3RlYWQuCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBmaWxlIHBhdGggYW5kIGZ1bGxQYXRoIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUgVXBsb2FkIHRvIGEgc2lnbmVkIFVSTAogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLnVwbG9hZFRvU2lnbmVkVXJsKCdmb2xkZXIvY2F0LmpwZycsICd0b2tlbi1mcm9tLWNyZWF0ZVNpZ25lZFVwbG9hZFVybCcsIGZpbGUpCiAgKiBgYGAKICAqCiAgKiBSZXNwb25zZToKICAqIGBgYGpzb24KICAqIHsKICAqICAgImRhdGEiOiB7CiAgKiAgICAgInBhdGgiOiAiZm9sZGVyL2NhdC5qcGciLAogICogICAgICJmdWxsUGF0aCI6ICJhdmF0YXJzL2ZvbGRlci9jYXQuanBnIgogICogICB9LAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqLwogIGFzeW5jIHVwbG9hZFRvU2lnbmVkVXJsKHBhdGgyLCB0b2tlbiwgZmlsZUJvZHksIGZpbGVPcHRpb25zKSB7CiAgICB2YXIgX3RoaXMzID0gdGhpczsKICAgIGNvbnN0IGNsZWFuUGF0aCA9IF90aGlzMy5fcmVtb3ZlRW1wdHlGb2xkZXJzKHBhdGgyKTsKICAgIGNvbnN0IF9wYXRoID0gX3RoaXMzLl9nZXRGaW5hbFBhdGgoY2xlYW5QYXRoKTsKICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoX3RoaXMzLnVybCArIGAvb2JqZWN0L3VwbG9hZC9zaWduLyR7X3BhdGh9YCk7CiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgidG9rZW4iLCB0b2tlbik7CiAgICByZXR1cm4gX3RoaXMzLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIGxldCBib2R5OwogICAgICBjb25zdCBvcHRpb25zID0gX29iamVjdFNwcmVhZDIxMSh7IHVwc2VydDogREVGQVVMVF9GSUxFX09QVElPTlMudXBzZXJ0IH0sIGZpbGVPcHRpb25zKTsKICAgICAgY29uc3QgaGVhZGVycyA9IF9vYmplY3RTcHJlYWQyMTEoX29iamVjdFNwcmVhZDIxMSh7fSwgX3RoaXMzLmhlYWRlcnMpLCB7ICJ4LXVwc2VydCI6IFN0cmluZyhvcHRpb25zLnVwc2VydCkgfSk7CiAgICAgIGlmICh0eXBlb2YgQmxvYiAhPT0gInVuZGVmaW5lZCIgJiYgZmlsZUJvZHkgaW5zdGFuY2VvZiBCbG9iKSB7CiAgICAgICAgYm9keSA9IG5ldyBGb3JtRGF0YSgpOwogICAgICAgIGJvZHkuYXBwZW5kKCJjYWNoZUNvbnRyb2wiLCBvcHRpb25zLmNhY2hlQ29udHJvbCk7CiAgICAgICAgYm9keS5hcHBlbmQoIiIsIGZpbGVCb2R5KTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgRm9ybURhdGEgIT09ICJ1bmRlZmluZWQiICYmIGZpbGVCb2R5IGluc3RhbmNlb2YgRm9ybURhdGEpIHsKICAgICAgICBib2R5ID0gZmlsZUJvZHk7CiAgICAgICAgYm9keS5hcHBlbmQoImNhY2hlQ29udHJvbCIsIG9wdGlvbnMuY2FjaGVDb250cm9sKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBib2R5ID0gZmlsZUJvZHk7CiAgICAgICAgaGVhZGVyc1siY2FjaGUtY29udHJvbCJdID0gYG1heC1hZ2U9JHtvcHRpb25zLmNhY2hlQ29udHJvbH1gOwogICAgICAgIGhlYWRlcnNbImNvbnRlbnQtdHlwZSJdID0gb3B0aW9ucy5jb250ZW50VHlwZTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHBhdGg6IGNsZWFuUGF0aCwKICAgICAgICBmdWxsUGF0aDogKGF3YWl0IHB1dChfdGhpczMuZmV0Y2gsIHVybC50b1N0cmluZygpLCBib2R5LCB7IGhlYWRlcnMgfSkpLktleQogICAgICB9OwogICAgfSk7CiAgfQogIC8qKgogICogQ3JlYXRlcyBhIHNpZ25lZCB1cGxvYWQgVVJMLgogICogU2lnbmVkIHVwbG9hZCBVUkxzIGNhbiBiZSB1c2VkIHRvIHVwbG9hZCBmaWxlcyB0byB0aGUgYnVja2V0IHdpdGhvdXQgZnVydGhlciBhdXRoZW50aWNhdGlvbi4KICAqIFRoZXkgYXJlIHZhbGlkIGZvciAyIGhvdXJzLgogICoKICAqIEBjYXRlZ29yeSBGaWxlIEJ1Y2tldHMKICAqIEBwYXJhbSBwYXRoIFRoZSBmaWxlIHBhdGgsIGluY2x1ZGluZyB0aGUgY3VycmVudCBmaWxlIG5hbWUuIEZvciBleGFtcGxlIGBmb2xkZXIvaW1hZ2UucG5nYC4KICAqIEBwYXJhbSBvcHRpb25zLnVwc2VydCBJZiBzZXQgdG8gdHJ1ZSwgYWxsb3dzIHRoZSBmaWxlIHRvIGJlIG92ZXJ3cml0dGVuIGlmIGl0IGFscmVhZHkgZXhpc3RzLgogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIHJlc3BvbnNlIGNvbnRhaW5pbmcgc2lnbmVkIHVwbG9hZCBVUkwsIHRva2VuLCBhbmQgcGF0aCBvciBlcnJvcgogICoKICAqIEBleGFtcGxlIENyZWF0ZSBTaWduZWQgVXBsb2FkIFVSTAogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLmNyZWF0ZVNpZ25lZFVwbG9hZFVybCgnZm9sZGVyL2NhdC5qcGcnKQogICogYGBgCiAgKgogICogUmVzcG9uc2U6CiAgKiBgYGBqc29uCiAgKiB7CiAgKiAgICJkYXRhIjogewogICogICAgICJzaWduZWRVcmwiOiAiaHR0cHM6Ly9leGFtcGxlLnN1cGFiYXNlLmNvL3N0b3JhZ2UvdjEvb2JqZWN0L3VwbG9hZC9zaWduL2F2YXRhcnMvZm9sZGVyL2NhdC5qcGc/dG9rZW49PFRPS0VOPiIsCiAgKiAgICAgInBhdGgiOiAiZm9sZGVyL2NhdC5qcGciLAogICogICAgICJ0b2tlbiI6ICI8VE9LRU4+IgogICogICB9LAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqLwogIGFzeW5jIGNyZWF0ZVNpZ25lZFVwbG9hZFVybChwYXRoMiwgb3B0aW9ucykgewogICAgdmFyIF90aGlzNCA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXM0LmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIGxldCBfcGF0aCA9IF90aGlzNC5fZ2V0RmluYWxQYXRoKHBhdGgyKTsKICAgICAgY29uc3QgaGVhZGVycyA9IF9vYmplY3RTcHJlYWQyMTEoe30sIF90aGlzNC5oZWFkZXJzKTsKICAgICAgaWYgKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy51cHNlcnQpIGhlYWRlcnNbIngtdXBzZXJ0Il0gPSAidHJ1ZSI7CiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBwb3N0KF90aGlzNC5mZXRjaCwgYCR7X3RoaXM0LnVybH0vb2JqZWN0L3VwbG9hZC9zaWduLyR7X3BhdGh9YCwge30sIHsgaGVhZGVycyB9KTsKICAgICAgY29uc3QgdXJsID0gbmV3IFVSTChfdGhpczQudXJsICsgZGF0YS51cmwpOwogICAgICBjb25zdCB0b2tlbiA9IHVybC5zZWFyY2hQYXJhbXMuZ2V0KCJ0b2tlbiIpOwogICAgICBpZiAoIXRva2VuKSB0aHJvdyBuZXcgU3RvcmFnZUVycm9yKCJObyB0b2tlbiByZXR1cm5lZCBieSBBUEkiKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBzaWduZWRVcmw6IHVybC50b1N0cmluZygpLAogICAgICAgIHBhdGg6IHBhdGgyLAogICAgICAgIHRva2VuCiAgICAgIH07CiAgICB9KTsKICB9CiAgLyoqCiAgKiBSZXBsYWNlcyBhbiBleGlzdGluZyBmaWxlIGF0IHRoZSBzcGVjaWZpZWQgcGF0aCB3aXRoIGEgbmV3IG9uZS4KICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gcGF0aCBUaGUgcmVsYXRpdmUgZmlsZSBwYXRoLiBTaG91bGQgYmUgb2YgdGhlIGZvcm1hdCBgZm9sZGVyL3N1YmZvbGRlci9maWxlbmFtZS5wbmdgLiBUaGUgYnVja2V0IG11c3QgYWxyZWFkeSBleGlzdCBiZWZvcmUgYXR0ZW1wdGluZyB0byB1cGRhdGUuCiAgKiBAcGFyYW0gZmlsZUJvZHkgVGhlIGJvZHkgb2YgdGhlIGZpbGUgdG8gYmUgc3RvcmVkIGluIHRoZSBidWNrZXQuCiAgKiBAcGFyYW0gZmlsZU9wdGlvbnMgT3B0aW9uYWwgZmlsZSB1cGxvYWQgb3B0aW9ucyBpbmNsdWRpbmcgY2FjaGVDb250cm9sLCBjb250ZW50VHlwZSwgdXBzZXJ0LCBhbmQgbWV0YWRhdGEuCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBmaWxlIHBhdGgsIGlkLCBhbmQgZnVsbFBhdGggb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZSBVcGRhdGUgZmlsZQogICogYGBganMKICAqIGNvbnN0IGF2YXRhckZpbGUgPSBldmVudC50YXJnZXQuZmlsZXNbMF0KICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLnVwZGF0ZSgncHVibGljL2F2YXRhcjEucG5nJywgYXZhdGFyRmlsZSwgewogICogICAgIGNhY2hlQ29udHJvbDogJzM2MDAnLAogICogICAgIHVwc2VydDogdHJ1ZQogICogICB9KQogICogYGBgCiAgKgogICogUmVzcG9uc2U6CiAgKiBgYGBqc29uCiAgKiB7CiAgKiAgICJkYXRhIjogewogICogICAgICJwYXRoIjogInB1YmxpYy9hdmF0YXIxLnBuZyIsCiAgKiAgICAgImZ1bGxQYXRoIjogImF2YXRhcnMvcHVibGljL2F2YXRhcjEucG5nIgogICogICB9LAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqCiAgKiBAZXhhbXBsZSBVcGRhdGUgZmlsZSB1c2luZyBgQXJyYXlCdWZmZXJgIGZyb20gYmFzZTY0IGZpbGUgZGF0YQogICogYGBganMKICAqIGltcG9ydCB7ZGVjb2RlfSBmcm9tICdiYXNlNjQtYXJyYXlidWZmZXInCiAgKgogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmZyb20oJ2F2YXRhcnMnKQogICogICAudXBkYXRlKCdwdWJsaWMvYXZhdGFyMS5wbmcnLCBkZWNvZGUoJ2Jhc2U2NEZpbGVEYXRhJyksIHsKICAqICAgICBjb250ZW50VHlwZTogJ2ltYWdlL3BuZycKICAqICAgfSkKICAqIGBgYAogICovCiAgYXN5bmMgdXBkYXRlKHBhdGgyLCBmaWxlQm9keSwgZmlsZU9wdGlvbnMpIHsKICAgIHJldHVybiB0aGlzLnVwbG9hZE9yVXBkYXRlKCJQVVQiLCBwYXRoMiwgZmlsZUJvZHksIGZpbGVPcHRpb25zKTsKICB9CiAgLyoqCiAgKiBNb3ZlcyBhbiBleGlzdGluZyBmaWxlIHRvIGEgbmV3IHBhdGggaW4gdGhlIHNhbWUgYnVja2V0LgogICoKICAqIEBjYXRlZ29yeSBGaWxlIEJ1Y2tldHMKICAqIEBwYXJhbSBmcm9tUGF0aCBUaGUgb3JpZ2luYWwgZmlsZSBwYXRoLCBpbmNsdWRpbmcgdGhlIGN1cnJlbnQgZmlsZSBuYW1lLiBGb3IgZXhhbXBsZSBgZm9sZGVyL2ltYWdlLnBuZ2AuCiAgKiBAcGFyYW0gdG9QYXRoIFRoZSBuZXcgZmlsZSBwYXRoLCBpbmNsdWRpbmcgdGhlIG5ldyBmaWxlIG5hbWUuIEZvciBleGFtcGxlIGBmb2xkZXIvaW1hZ2UtbmV3LnBuZ2AuCiAgKiBAcGFyYW0gb3B0aW9ucyBUaGUgZGVzdGluYXRpb24gb3B0aW9ucy4KICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIHN1Y2Nlc3MgbWVzc2FnZSBvciBlcnJvcgogICoKICAqIEBleGFtcGxlIE1vdmUgZmlsZQogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLm1vdmUoJ3B1YmxpYy9hdmF0YXIxLnBuZycsICdwcml2YXRlL2F2YXRhcjIucG5nJykKICAqIGBgYAogICoKICAqIFJlc3BvbnNlOgogICogYGBganNvbgogICogewogICogICAiZGF0YSI6IHsKICAqICAgICAibWVzc2FnZSI6ICJTdWNjZXNzZnVsbHkgbW92ZWQiCiAgKiAgIH0sCiAgKiAgICJlcnJvciI6IG51bGwKICAqIH0KICAqIGBgYAogICovCiAgYXN5bmMgbW92ZShmcm9tUGF0aCwgdG9QYXRoLCBvcHRpb25zKSB7CiAgICB2YXIgX3RoaXM2ID0gdGhpczsKICAgIHJldHVybiBfdGhpczYuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHBvc3QoX3RoaXM2LmZldGNoLCBgJHtfdGhpczYudXJsfS9vYmplY3QvbW92ZWAsIHsKICAgICAgICBidWNrZXRJZDogX3RoaXM2LmJ1Y2tldElkLAogICAgICAgIHNvdXJjZUtleTogZnJvbVBhdGgsCiAgICAgICAgZGVzdGluYXRpb25LZXk6IHRvUGF0aCwKICAgICAgICBkZXN0aW5hdGlvbkJ1Y2tldDogb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmRlc3RpbmF0aW9uQnVja2V0CiAgICAgIH0sIHsgaGVhZGVyczogX3RoaXM2LmhlYWRlcnMgfSk7CiAgICB9KTsKICB9CiAgLyoqCiAgKiBDb3BpZXMgYW4gZXhpc3RpbmcgZmlsZSB0byBhIG5ldyBwYXRoIGluIHRoZSBzYW1lIGJ1Y2tldC4KICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gZnJvbVBhdGggVGhlIG9yaWdpbmFsIGZpbGUgcGF0aCwgaW5jbHVkaW5nIHRoZSBjdXJyZW50IGZpbGUgbmFtZS4gRm9yIGV4YW1wbGUgYGZvbGRlci9pbWFnZS5wbmdgLgogICogQHBhcmFtIHRvUGF0aCBUaGUgbmV3IGZpbGUgcGF0aCwgaW5jbHVkaW5nIHRoZSBuZXcgZmlsZSBuYW1lLiBGb3IgZXhhbXBsZSBgZm9sZGVyL2ltYWdlLWNvcHkucG5nYC4KICAqIEBwYXJhbSBvcHRpb25zIFRoZSBkZXN0aW5hdGlvbiBvcHRpb25zLgogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIHJlc3BvbnNlIGNvbnRhaW5pbmcgY29waWVkIGZpbGUgcGF0aCBvciBlcnJvcgogICoKICAqIEBleGFtcGxlIENvcHkgZmlsZQogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLmNvcHkoJ3B1YmxpYy9hdmF0YXIxLnBuZycsICdwcml2YXRlL2F2YXRhcjIucG5nJykKICAqIGBgYAogICoKICAqIFJlc3BvbnNlOgogICogYGBganNvbgogICogewogICogICAiZGF0YSI6IHsKICAqICAgICAicGF0aCI6ICJhdmF0YXJzL3ByaXZhdGUvYXZhdGFyMi5wbmciCiAgKiAgIH0sCiAgKiAgICJlcnJvciI6IG51bGwKICAqIH0KICAqIGBgYAogICovCiAgYXN5bmMgY29weShmcm9tUGF0aCwgdG9QYXRoLCBvcHRpb25zKSB7CiAgICB2YXIgX3RoaXM3ID0gdGhpczsKICAgIHJldHVybiBfdGhpczcuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIHsgcGF0aDogKGF3YWl0IHBvc3QoX3RoaXM3LmZldGNoLCBgJHtfdGhpczcudXJsfS9vYmplY3QvY29weWAsIHsKICAgICAgICBidWNrZXRJZDogX3RoaXM3LmJ1Y2tldElkLAogICAgICAgIHNvdXJjZUtleTogZnJvbVBhdGgsCiAgICAgICAgZGVzdGluYXRpb25LZXk6IHRvUGF0aCwKICAgICAgICBkZXN0aW5hdGlvbkJ1Y2tldDogb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmRlc3RpbmF0aW9uQnVja2V0CiAgICAgIH0sIHsgaGVhZGVyczogX3RoaXM3LmhlYWRlcnMgfSkpLktleSB9OwogICAgfSk7CiAgfQogIC8qKgogICogQ3JlYXRlcyBhIHNpZ25lZCBVUkwuIFVzZSBhIHNpZ25lZCBVUkwgdG8gc2hhcmUgYSBmaWxlIGZvciBhIGZpeGVkIGFtb3VudCBvZiB0aW1lLgogICoKICAqIEBjYXRlZ29yeSBGaWxlIEJ1Y2tldHMKICAqIEBwYXJhbSBwYXRoIFRoZSBmaWxlIHBhdGgsIGluY2x1ZGluZyB0aGUgY3VycmVudCBmaWxlIG5hbWUuIEZvciBleGFtcGxlIGBmb2xkZXIvaW1hZ2UucG5nYC4KICAqIEBwYXJhbSBleHBpcmVzSW4gVGhlIG51bWJlciBvZiBzZWNvbmRzIHVudGlsIHRoZSBzaWduZWQgVVJMIGV4cGlyZXMuIEZvciBleGFtcGxlLCBgNjBgIGZvciBhIFVSTCB3aGljaCBpcyB2YWxpZCBmb3Igb25lIG1pbnV0ZS4KICAqIEBwYXJhbSBvcHRpb25zLmRvd25sb2FkIHRyaWdnZXJzIHRoZSBmaWxlIGFzIGEgZG93bmxvYWQgaWYgc2V0IHRvIHRydWUuIFNldCB0aGlzIHBhcmFtZXRlciBhcyB0aGUgbmFtZSBvZiB0aGUgZmlsZSBpZiB5b3Ugd2FudCB0byB0cmlnZ2VyIHRoZSBkb3dubG9hZCB3aXRoIGEgZGlmZmVyZW50IGZpbGVuYW1lLgogICogQHBhcmFtIG9wdGlvbnMudHJhbnNmb3JtIFRyYW5zZm9ybSB0aGUgYXNzZXQgYmVmb3JlIHNlcnZpbmcgaXQgdG8gdGhlIGNsaWVudC4KICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIHNpZ25lZCBVUkwgb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZSBDcmVhdGUgU2lnbmVkIFVSTAogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLmNyZWF0ZVNpZ25lZFVybCgnZm9sZGVyL2F2YXRhcjEucG5nJywgNjApCiAgKiBgYGAKICAqCiAgKiBSZXNwb25zZToKICAqIGBgYGpzb24KICAqIHsKICAqICAgImRhdGEiOiB7CiAgKiAgICAgInNpZ25lZFVybCI6ICJodHRwczovL2V4YW1wbGUuc3VwYWJhc2UuY28vc3RvcmFnZS92MS9vYmplY3Qvc2lnbi9hdmF0YXJzL2ZvbGRlci9hdmF0YXIxLnBuZz90b2tlbj08VE9LRU4+IgogICogICB9LAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqCiAgKiBAZXhhbXBsZSBDcmVhdGUgYSBzaWduZWQgVVJMIGZvciBhbiBhc3NldCB3aXRoIHRyYW5zZm9ybWF0aW9ucwogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmZyb20oJ2F2YXRhcnMnKQogICogICAuY3JlYXRlU2lnbmVkVXJsKCdmb2xkZXIvYXZhdGFyMS5wbmcnLCA2MCwgewogICogICAgIHRyYW5zZm9ybTogewogICogICAgICAgd2lkdGg6IDEwMCwKICAqICAgICAgIGhlaWdodDogMTAwLAogICogICAgIH0KICAqICAgfSkKICAqIGBgYAogICoKICAqIEBleGFtcGxlIENyZWF0ZSBhIHNpZ25lZCBVUkwgd2hpY2ggdHJpZ2dlcnMgdGhlIGRvd25sb2FkIG9mIHRoZSBhc3NldAogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmZyb20oJ2F2YXRhcnMnKQogICogICAuY3JlYXRlU2lnbmVkVXJsKCdmb2xkZXIvYXZhdGFyMS5wbmcnLCA2MCwgewogICogICAgIGRvd25sb2FkOiB0cnVlLAogICogICB9KQogICogYGBgCiAgKi8KICBhc3luYyBjcmVhdGVTaWduZWRVcmwocGF0aDIsIGV4cGlyZXNJbiwgb3B0aW9ucykgewogICAgdmFyIF90aGlzOCA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXM4LmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIGxldCBfcGF0aCA9IF90aGlzOC5fZ2V0RmluYWxQYXRoKHBhdGgyKTsKICAgICAgbGV0IGRhdGEgPSBhd2FpdCBwb3N0KF90aGlzOC5mZXRjaCwgYCR7X3RoaXM4LnVybH0vb2JqZWN0L3NpZ24vJHtfcGF0aH1gLCBfb2JqZWN0U3ByZWFkMjExKHsgZXhwaXJlc0luIH0sIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMudHJhbnNmb3JtKSA/IHsgdHJhbnNmb3JtOiBvcHRpb25zLnRyYW5zZm9ybSB9IDoge30pLCB7IGhlYWRlcnM6IF90aGlzOC5oZWFkZXJzIH0pOwogICAgICBjb25zdCBkb3dubG9hZFF1ZXJ5UGFyYW0gPSAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmRvd25sb2FkKSA/IGAmZG93bmxvYWQ9JHtvcHRpb25zLmRvd25sb2FkID09PSB0cnVlID8gIiIgOiBvcHRpb25zLmRvd25sb2FkfWAgOiAiIjsKICAgICAgcmV0dXJuIHsgc2lnbmVkVXJsOiBlbmNvZGVVUkkoYCR7X3RoaXM4LnVybH0ke2RhdGEuc2lnbmVkVVJMfSR7ZG93bmxvYWRRdWVyeVBhcmFtfWApIH07CiAgICB9KTsKICB9CiAgLyoqCiAgKiBDcmVhdGVzIG11bHRpcGxlIHNpZ25lZCBVUkxzLiBVc2UgYSBzaWduZWQgVVJMIHRvIHNoYXJlIGEgZmlsZSBmb3IgYSBmaXhlZCBhbW91bnQgb2YgdGltZS4KICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gcGF0aHMgVGhlIGZpbGUgcGF0aHMgdG8gYmUgZG93bmxvYWRlZCwgaW5jbHVkaW5nIHRoZSBjdXJyZW50IGZpbGUgbmFtZXMuIEZvciBleGFtcGxlIGBbJ2ZvbGRlci9pbWFnZS5wbmcnLCAnZm9sZGVyMi9pbWFnZTIucG5nJ11gLgogICogQHBhcmFtIGV4cGlyZXNJbiBUaGUgbnVtYmVyIG9mIHNlY29uZHMgdW50aWwgdGhlIHNpZ25lZCBVUkxzIGV4cGlyZS4gRm9yIGV4YW1wbGUsIGA2MGAgZm9yIFVSTHMgd2hpY2ggYXJlIHZhbGlkIGZvciBvbmUgbWludXRlLgogICogQHBhcmFtIG9wdGlvbnMuZG93bmxvYWQgdHJpZ2dlcnMgdGhlIGZpbGUgYXMgYSBkb3dubG9hZCBpZiBzZXQgdG8gdHJ1ZS4gU2V0IHRoaXMgcGFyYW1ldGVyIGFzIHRoZSBuYW1lIG9mIHRoZSBmaWxlIGlmIHlvdSB3YW50IHRvIHRyaWdnZXIgdGhlIGRvd25sb2FkIHdpdGggYSBkaWZmZXJlbnQgZmlsZW5hbWUuCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBhcnJheSBvZiBvYmplY3RzIHdpdGggc2lnbmVkVXJsLCBwYXRoLCBhbmQgZXJyb3Igb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZSBDcmVhdGUgU2lnbmVkIFVSTHMKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZnJvbSgnYXZhdGFycycpCiAgKiAgIC5jcmVhdGVTaWduZWRVcmxzKFsnZm9sZGVyL2F2YXRhcjEucG5nJywgJ2ZvbGRlci9hdmF0YXIyLnBuZyddLCA2MCkKICAqIGBgYAogICoKICAqIFJlc3BvbnNlOgogICogYGBganNvbgogICogewogICogICAiZGF0YSI6IFsKICAqICAgICB7CiAgKiAgICAgICAiZXJyb3IiOiBudWxsLAogICogICAgICAgInBhdGgiOiAiZm9sZGVyL2F2YXRhcjEucG5nIiwKICAqICAgICAgICJzaWduZWRVUkwiOiAiL29iamVjdC9zaWduL2F2YXRhcnMvZm9sZGVyL2F2YXRhcjEucG5nP3Rva2VuPTxUT0tFTj4iLAogICogICAgICAgInNpZ25lZFVybCI6ICJodHRwczovL2V4YW1wbGUuc3VwYWJhc2UuY28vc3RvcmFnZS92MS9vYmplY3Qvc2lnbi9hdmF0YXJzL2ZvbGRlci9hdmF0YXIxLnBuZz90b2tlbj08VE9LRU4+IgogICogICAgIH0sCiAgKiAgICAgewogICogICAgICAgImVycm9yIjogbnVsbCwKICAqICAgICAgICJwYXRoIjogImZvbGRlci9hdmF0YXIyLnBuZyIsCiAgKiAgICAgICAic2lnbmVkVVJMIjogIi9vYmplY3Qvc2lnbi9hdmF0YXJzL2ZvbGRlci9hdmF0YXIyLnBuZz90b2tlbj08VE9LRU4+IiwKICAqICAgICAgICJzaWduZWRVcmwiOiAiaHR0cHM6Ly9leGFtcGxlLnN1cGFiYXNlLmNvL3N0b3JhZ2UvdjEvb2JqZWN0L3NpZ24vYXZhdGFycy9mb2xkZXIvYXZhdGFyMi5wbmc/dG9rZW49PFRPS0VOPiIKICAqICAgICB9CiAgKiAgIF0sCiAgKiAgICJlcnJvciI6IG51bGwKICAqIH0KICAqIGBgYAogICovCiAgYXN5bmMgY3JlYXRlU2lnbmVkVXJscyhwYXRocywgZXhwaXJlc0luLCBvcHRpb25zKSB7CiAgICB2YXIgX3RoaXM5ID0gdGhpczsKICAgIHJldHVybiBfdGhpczkuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHBvc3QoX3RoaXM5LmZldGNoLCBgJHtfdGhpczkudXJsfS9vYmplY3Qvc2lnbi8ke190aGlzOS5idWNrZXRJZH1gLCB7CiAgICAgICAgZXhwaXJlc0luLAogICAgICAgIHBhdGhzCiAgICAgIH0sIHsgaGVhZGVyczogX3RoaXM5LmhlYWRlcnMgfSk7CiAgICAgIGNvbnN0IGRvd25sb2FkUXVlcnlQYXJhbSA9IChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuZG93bmxvYWQpID8gYCZkb3dubG9hZD0ke29wdGlvbnMuZG93bmxvYWQgPT09IHRydWUgPyAiIiA6IG9wdGlvbnMuZG93bmxvYWR9YCA6ICIiOwogICAgICByZXR1cm4gZGF0YS5tYXAoKGRhdHVtKSA9PiBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIGRhdHVtKSwge30sIHsgc2lnbmVkVXJsOiBkYXR1bS5zaWduZWRVUkwgPyBlbmNvZGVVUkkoYCR7X3RoaXM5LnVybH0ke2RhdHVtLnNpZ25lZFVSTH0ke2Rvd25sb2FkUXVlcnlQYXJhbX1gKSA6IG51bGwgfSkpOwogICAgfSk7CiAgfQogIC8qKgogICogRG93bmxvYWRzIGEgZmlsZSBmcm9tIGEgcHJpdmF0ZSBidWNrZXQuIEZvciBwdWJsaWMgYnVja2V0cywgbWFrZSBhIHJlcXVlc3QgdG8gdGhlIFVSTCByZXR1cm5lZCBmcm9tIGBnZXRQdWJsaWNVcmxgIGluc3RlYWQuCiAgKgogICogQGNhdGVnb3J5IEZpbGUgQnVja2V0cwogICogQHBhcmFtIHBhdGggVGhlIGZ1bGwgcGF0aCBhbmQgZmlsZSBuYW1lIG9mIHRoZSBmaWxlIHRvIGJlIGRvd25sb2FkZWQuIEZvciBleGFtcGxlIGBmb2xkZXIvaW1hZ2UucG5nYC4KICAqIEBwYXJhbSBvcHRpb25zLnRyYW5zZm9ybSBUcmFuc2Zvcm0gdGhlIGFzc2V0IGJlZm9yZSBzZXJ2aW5nIGl0IHRvIHRoZSBjbGllbnQuCiAgKiBAcGFyYW0gcGFyYW1ldGVycyBBZGRpdGlvbmFsIGZldGNoIHBhcmFtZXRlcnMgbGlrZSBzaWduYWwgZm9yIGNhbmNlbGxhdGlvbi4gU3VwcG9ydHMgc3RhbmRhcmQgZmV0Y2ggb3B0aW9ucyBpbmNsdWRpbmcgY2FjaGUgY29udHJvbC4KICAqIEByZXR1cm5zIEJsb2JEb3dubG9hZEJ1aWxkZXIgaW5zdGFuY2UgZm9yIGRvd25sb2FkaW5nIHRoZSBmaWxlCiAgKgogICogQGV4YW1wbGUgRG93bmxvYWQgZmlsZQogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLmRvd25sb2FkKCdmb2xkZXIvYXZhdGFyMS5wbmcnKQogICogYGBgCiAgKgogICogUmVzcG9uc2U6CiAgKiBgYGBqc29uCiAgKiB7CiAgKiAgICJkYXRhIjogPEJMT0I+LAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqCiAgKiBAZXhhbXBsZSBEb3dubG9hZCBmaWxlIHdpdGggdHJhbnNmb3JtYXRpb25zCiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmZyb20oJ2F2YXRhcnMnKQogICogICAuZG93bmxvYWQoJ2ZvbGRlci9hdmF0YXIxLnBuZycsIHsKICAqICAgICB0cmFuc2Zvcm06IHsKICAqICAgICAgIHdpZHRoOiAxMDAsCiAgKiAgICAgICBoZWlnaHQ6IDEwMCwKICAqICAgICAgIHF1YWxpdHk6IDgwCiAgKiAgICAgfQogICogICB9KQogICogYGBgCiAgKgogICogQGV4YW1wbGUgRG93bmxvYWQgd2l0aCBjYWNoZSBjb250cm9sICh1c2VmdWwgaW4gRWRnZSBGdW5jdGlvbnMpCiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmZyb20oJ2F2YXRhcnMnKQogICogICAuZG93bmxvYWQoJ2ZvbGRlci9hdmF0YXIxLnBuZycsIHt9LCB7IGNhY2hlOiAnbm8tc3RvcmUnIH0pCiAgKiBgYGAKICAqCiAgKiBAZXhhbXBsZSBEb3dubG9hZCB3aXRoIGFib3J0IHNpZ25hbAogICogYGBganMKICAqIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCkKICAqIHNldFRpbWVvdXQoKCkgPT4gY29udHJvbGxlci5hYm9ydCgpLCA1MDAwKQogICoKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLmRvd25sb2FkKCdmb2xkZXIvYXZhdGFyMS5wbmcnLCB7fSwgeyBzaWduYWw6IGNvbnRyb2xsZXIuc2lnbmFsIH0pCiAgKiBgYGAKICAqLwogIGRvd25sb2FkKHBhdGgyLCBvcHRpb25zLCBwYXJhbWV0ZXJzKSB7CiAgICBjb25zdCByZW5kZXJQYXRoID0gdHlwZW9mIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMudHJhbnNmb3JtKSAhPT0gInVuZGVmaW5lZCIgPyAicmVuZGVyL2ltYWdlL2F1dGhlbnRpY2F0ZWQiIDogIm9iamVjdCI7CiAgICBjb25zdCB0cmFuc2Zvcm1hdGlvblF1ZXJ5ID0gdGhpcy50cmFuc2Zvcm1PcHRzVG9RdWVyeVN0cmluZygob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnRyYW5zZm9ybSkgfHwge30pOwogICAgY29uc3QgcXVlcnlTdHJpbmcgPSB0cmFuc2Zvcm1hdGlvblF1ZXJ5ID8gYD8ke3RyYW5zZm9ybWF0aW9uUXVlcnl9YCA6ICIiOwogICAgY29uc3QgX3BhdGggPSB0aGlzLl9nZXRGaW5hbFBhdGgocGF0aDIpOwogICAgY29uc3QgZG93bmxvYWRGbiA9ICgpID0+IGdldDUodGhpcy5mZXRjaCwgYCR7dGhpcy51cmx9LyR7cmVuZGVyUGF0aH0vJHtfcGF0aH0ke3F1ZXJ5U3RyaW5nfWAsIHsKICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICBub1Jlc29sdmVKc29uOiB0cnVlCiAgICB9LCBwYXJhbWV0ZXJzKTsKICAgIHJldHVybiBuZXcgQmxvYkRvd25sb2FkQnVpbGRlcihkb3dubG9hZEZuLCB0aGlzLnNob3VsZFRocm93T25FcnJvcik7CiAgfQogIC8qKgogICogUmV0cmlldmVzIHRoZSBkZXRhaWxzIG9mIGFuIGV4aXN0aW5nIGZpbGUuCiAgKgogICogQGNhdGVnb3J5IEZpbGUgQnVja2V0cwogICogQHBhcmFtIHBhdGggVGhlIGZpbGUgcGF0aCwgaW5jbHVkaW5nIHRoZSBmaWxlIG5hbWUuIEZvciBleGFtcGxlIGBmb2xkZXIvaW1hZ2UucG5nYC4KICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIGZpbGUgbWV0YWRhdGEgb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZSBHZXQgZmlsZSBpbmZvCiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmZyb20oJ2F2YXRhcnMnKQogICogICAuaW5mbygnZm9sZGVyL2F2YXRhcjEucG5nJykKICAqIGBgYAogICovCiAgYXN5bmMgaW5mbyhwYXRoMikgewogICAgdmFyIF90aGlzMTAgPSB0aGlzOwogICAgY29uc3QgX3BhdGggPSBfdGhpczEwLl9nZXRGaW5hbFBhdGgocGF0aDIpOwogICAgcmV0dXJuIF90aGlzMTAuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIHJlY3Vyc2l2ZVRvQ2FtZWwoYXdhaXQgZ2V0NShfdGhpczEwLmZldGNoLCBgJHtfdGhpczEwLnVybH0vb2JqZWN0L2luZm8vJHtfcGF0aH1gLCB7IGhlYWRlcnM6IF90aGlzMTAuaGVhZGVycyB9KSk7CiAgICB9KTsKICB9CiAgLyoqCiAgKiBDaGVja3MgdGhlIGV4aXN0ZW5jZSBvZiBhIGZpbGUuCiAgKgogICogQGNhdGVnb3J5IEZpbGUgQnVja2V0cwogICogQHBhcmFtIHBhdGggVGhlIGZpbGUgcGF0aCwgaW5jbHVkaW5nIHRoZSBmaWxlIG5hbWUuIEZvciBleGFtcGxlIGBmb2xkZXIvaW1hZ2UucG5nYC4KICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIGJvb2xlYW4gaW5kaWNhdGluZyBmaWxlIGV4aXN0ZW5jZSBvciBlcnJvcgogICoKICAqIEBleGFtcGxlIENoZWNrIGZpbGUgZXhpc3RlbmNlCiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmZyb20oJ2F2YXRhcnMnKQogICogICAuZXhpc3RzKCdmb2xkZXIvYXZhdGFyMS5wbmcnKQogICogYGBgCiAgKi8KICBhc3luYyBleGlzdHMocGF0aDIpIHsKICAgIHZhciBfdGhpczExID0gdGhpczsKICAgIGNvbnN0IF9wYXRoID0gX3RoaXMxMS5fZ2V0RmluYWxQYXRoKHBhdGgyKTsKICAgIHRyeSB7CiAgICAgIGF3YWl0IGhlYWQoX3RoaXMxMS5mZXRjaCwgYCR7X3RoaXMxMS51cmx9L29iamVjdC8ke19wYXRofWAsIHsgaGVhZGVyczogX3RoaXMxMS5oZWFkZXJzIH0pOwogICAgICByZXR1cm4gewogICAgICAgIGRhdGE6IHRydWUsCiAgICAgICAgZXJyb3I6IG51bGwKICAgICAgfTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChfdGhpczExLnNob3VsZFRocm93T25FcnJvcikgdGhyb3cgZXJyb3I7CiAgICAgIGlmIChpc1N0b3JhZ2VFcnJvcihlcnJvcikgJiYgZXJyb3IgaW5zdGFuY2VvZiBTdG9yYWdlVW5rbm93bkVycm9yKSB7CiAgICAgICAgY29uc3Qgb3JpZ2luYWxFcnJvciA9IGVycm9yLm9yaWdpbmFsRXJyb3I7CiAgICAgICAgaWYgKFs0MDAsIDQwNF0uaW5jbHVkZXMob3JpZ2luYWxFcnJvciA9PT0gbnVsbCB8fCBvcmlnaW5hbEVycm9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcmlnaW5hbEVycm9yLnN0YXR1cykpIHJldHVybiB7CiAgICAgICAgICBkYXRhOiBmYWxzZSwKICAgICAgICAgIGVycm9yCiAgICAgICAgfTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgKiBBIHNpbXBsZSBjb252ZW5pZW5jZSBmdW5jdGlvbiB0byBnZXQgdGhlIFVSTCBmb3IgYW4gYXNzZXQgaW4gYSBwdWJsaWMgYnVja2V0LiBJZiB5b3UgZG8gbm90IHdhbnQgdG8gdXNlIHRoaXMgZnVuY3Rpb24sIHlvdSBjYW4gY29uc3RydWN0IHRoZSBwdWJsaWMgVVJMIGJ5IGNvbmNhdGVuYXRpbmcgdGhlIGJ1Y2tldCBVUkwgd2l0aCB0aGUgcGF0aCB0byB0aGUgYXNzZXQuCiAgKiBUaGlzIGZ1bmN0aW9uIGRvZXMgbm90IHZlcmlmeSBpZiB0aGUgYnVja2V0IGlzIHB1YmxpYy4gSWYgYSBwdWJsaWMgVVJMIGlzIGNyZWF0ZWQgZm9yIGEgYnVja2V0IHdoaWNoIGlzIG5vdCBwdWJsaWMsIHlvdSB3aWxsIG5vdCBiZSBhYmxlIHRvIGRvd25sb2FkIHRoZSBhc3NldC4KICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gcGF0aCBUaGUgcGF0aCBhbmQgbmFtZSBvZiB0aGUgZmlsZSB0byBnZW5lcmF0ZSB0aGUgcHVibGljIFVSTCBmb3IuIEZvciBleGFtcGxlIGBmb2xkZXIvaW1hZ2UucG5nYC4KICAqIEBwYXJhbSBvcHRpb25zLmRvd25sb2FkIFRyaWdnZXJzIHRoZSBmaWxlIGFzIGEgZG93bmxvYWQgaWYgc2V0IHRvIHRydWUuIFNldCB0aGlzIHBhcmFtZXRlciBhcyB0aGUgbmFtZSBvZiB0aGUgZmlsZSBpZiB5b3Ugd2FudCB0byB0cmlnZ2VyIHRoZSBkb3dubG9hZCB3aXRoIGEgZGlmZmVyZW50IGZpbGVuYW1lLgogICogQHBhcmFtIG9wdGlvbnMudHJhbnNmb3JtIFRyYW5zZm9ybSB0aGUgYXNzZXQgYmVmb3JlIHNlcnZpbmcgaXQgdG8gdGhlIGNsaWVudC4KICAqIEByZXR1cm5zIE9iamVjdCB3aXRoIHB1YmxpYyBVUkwKICAqCiAgKiBAZXhhbXBsZSBSZXR1cm5zIHRoZSBVUkwgZm9yIGFuIGFzc2V0IGluIGEgcHVibGljIGJ1Y2tldAogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSB9ID0gc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmZyb20oJ3B1YmxpYy1idWNrZXQnKQogICogICAuZ2V0UHVibGljVXJsKCdmb2xkZXIvYXZhdGFyMS5wbmcnKQogICogYGBgCiAgKgogICogUmVzcG9uc2U6CiAgKiBgYGBqc29uCiAgKiB7CiAgKiAgICJkYXRhIjogewogICogICAgICJwdWJsaWNVcmwiOiAiaHR0cHM6Ly9leGFtcGxlLnN1cGFiYXNlLmNvL3N0b3JhZ2UvdjEvb2JqZWN0L3B1YmxpYy9wdWJsaWMtYnVja2V0L2ZvbGRlci9hdmF0YXIxLnBuZyIKICAqICAgfQogICogfQogICogYGBgCiAgKgogICogQGV4YW1wbGUgUmV0dXJucyB0aGUgVVJMIGZvciBhbiBhc3NldCBpbiBhIHB1YmxpYyBidWNrZXQgd2l0aCB0cmFuc2Zvcm1hdGlvbnMKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEgfSA9IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdwdWJsaWMtYnVja2V0JykKICAqICAgLmdldFB1YmxpY1VybCgnZm9sZGVyL2F2YXRhcjEucG5nJywgewogICogICAgIHRyYW5zZm9ybTogewogICogICAgICAgd2lkdGg6IDEwMCwKICAqICAgICAgIGhlaWdodDogMTAwLAogICogICAgIH0KICAqICAgfSkKICAqIGBgYAogICoKICAqIEBleGFtcGxlIFJldHVybnMgdGhlIFVSTCB3aGljaCB0cmlnZ2VycyB0aGUgZG93bmxvYWQgb2YgYW4gYXNzZXQgaW4gYSBwdWJsaWMgYnVja2V0CiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhIH0gPSBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZnJvbSgncHVibGljLWJ1Y2tldCcpCiAgKiAgIC5nZXRQdWJsaWNVcmwoJ2ZvbGRlci9hdmF0YXIxLnBuZycsIHsKICAqICAgICBkb3dubG9hZDogdHJ1ZSwKICAqICAgfSkKICAqIGBgYAogICovCiAgZ2V0UHVibGljVXJsKHBhdGgyLCBvcHRpb25zKSB7CiAgICBjb25zdCBfcGF0aCA9IHRoaXMuX2dldEZpbmFsUGF0aChwYXRoMik7CiAgICBjb25zdCBfcXVlcnlTdHJpbmcgPSBbXTsKICAgIGNvbnN0IGRvd25sb2FkUXVlcnlQYXJhbSA9IChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuZG93bmxvYWQpID8gYGRvd25sb2FkPSR7b3B0aW9ucy5kb3dubG9hZCA9PT0gdHJ1ZSA/ICIiIDogb3B0aW9ucy5kb3dubG9hZH1gIDogIiI7CiAgICBpZiAoZG93bmxvYWRRdWVyeVBhcmFtICE9PSAiIikgX3F1ZXJ5U3RyaW5nLnB1c2goZG93bmxvYWRRdWVyeVBhcmFtKTsKICAgIGNvbnN0IHJlbmRlclBhdGggPSB0eXBlb2YgKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy50cmFuc2Zvcm0pICE9PSAidW5kZWZpbmVkIiA/ICJyZW5kZXIvaW1hZ2UiIDogIm9iamVjdCI7CiAgICBjb25zdCB0cmFuc2Zvcm1hdGlvblF1ZXJ5ID0gdGhpcy50cmFuc2Zvcm1PcHRzVG9RdWVyeVN0cmluZygob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnRyYW5zZm9ybSkgfHwge30pOwogICAgaWYgKHRyYW5zZm9ybWF0aW9uUXVlcnkgIT09ICIiKSBfcXVlcnlTdHJpbmcucHVzaCh0cmFuc2Zvcm1hdGlvblF1ZXJ5KTsKICAgIGxldCBxdWVyeVN0cmluZyA9IF9xdWVyeVN0cmluZy5qb2luKCImIik7CiAgICBpZiAocXVlcnlTdHJpbmcgIT09ICIiKSBxdWVyeVN0cmluZyA9IGA/JHtxdWVyeVN0cmluZ31gOwogICAgcmV0dXJuIHsgZGF0YTogeyBwdWJsaWNVcmw6IGVuY29kZVVSSShgJHt0aGlzLnVybH0vJHtyZW5kZXJQYXRofS9wdWJsaWMvJHtfcGF0aH0ke3F1ZXJ5U3RyaW5nfWApIH0gfTsKICB9CiAgLyoqCiAgKiBEZWxldGVzIGZpbGVzIHdpdGhpbiB0aGUgc2FtZSBidWNrZXQKICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gcGF0aHMgQW4gYXJyYXkgb2YgZmlsZXMgdG8gZGVsZXRlLCBpbmNsdWRpbmcgdGhlIHBhdGggYW5kIGZpbGUgbmFtZS4gRm9yIGV4YW1wbGUgW2AnZm9sZGVyL2ltYWdlLnBuZydgXS4KICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIGFycmF5IG9mIGRlbGV0ZWQgZmlsZSBvYmplY3RzIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUgRGVsZXRlIGZpbGUKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZnJvbSgnYXZhdGFycycpCiAgKiAgIC5yZW1vdmUoWydmb2xkZXIvYXZhdGFyMS5wbmcnXSkKICAqIGBgYAogICoKICAqIFJlc3BvbnNlOgogICogYGBganNvbgogICogewogICogICAiZGF0YSI6IFtdLAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqLwogIGFzeW5jIHJlbW92ZShwYXRocykgewogICAgdmFyIF90aGlzMTIgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzMTIuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHJlbW92ZShfdGhpczEyLmZldGNoLCBgJHtfdGhpczEyLnVybH0vb2JqZWN0LyR7X3RoaXMxMi5idWNrZXRJZH1gLCB7IHByZWZpeGVzOiBwYXRocyB9LCB7IGhlYWRlcnM6IF90aGlzMTIuaGVhZGVycyB9KTsKICAgIH0pOwogIH0KICAvKioKICAqIEdldCBmaWxlIG1ldGFkYXRhCiAgKiBAcGFyYW0gaWQgdGhlIGZpbGUgaWQgdG8gcmV0cmlldmUgbWV0YWRhdGEKICAqLwogIC8qKgogICogVXBkYXRlIGZpbGUgbWV0YWRhdGEKICAqIEBwYXJhbSBpZCB0aGUgZmlsZSBpZCB0byB1cGRhdGUgbWV0YWRhdGEKICAqIEBwYXJhbSBtZXRhIHRoZSBuZXcgZmlsZSBtZXRhZGF0YQogICovCiAgLyoqCiAgKiBMaXN0cyBhbGwgdGhlIGZpbGVzIGFuZCBmb2xkZXJzIHdpdGhpbiBhIHBhdGggb2YgdGhlIGJ1Y2tldC4KICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gcGF0aCBUaGUgZm9sZGVyIHBhdGguCiAgKiBAcGFyYW0gb3B0aW9ucyBTZWFyY2ggb3B0aW9ucyBpbmNsdWRpbmcgbGltaXQgKGRlZmF1bHRzIHRvIDEwMCksIG9mZnNldCwgc29ydEJ5LCBhbmQgc2VhcmNoCiAgKiBAcGFyYW0gcGFyYW1ldGVycyBPcHRpb25hbCBmZXRjaCBwYXJhbWV0ZXJzIGluY2x1ZGluZyBzaWduYWwgZm9yIGNhbmNlbGxhdGlvbgogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIHJlc3BvbnNlIGNvbnRhaW5pbmcgYXJyYXkgb2YgZmlsZXMgb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZSBMaXN0IGZpbGVzIGluIGEgYnVja2V0CiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmZyb20oJ2F2YXRhcnMnKQogICogICAubGlzdCgnZm9sZGVyJywgewogICogICAgIGxpbWl0OiAxMDAsCiAgKiAgICAgb2Zmc2V0OiAwLAogICogICAgIHNvcnRCeTogeyBjb2x1bW46ICduYW1lJywgb3JkZXI6ICdhc2MnIH0sCiAgKiAgIH0pCiAgKiBgYGAKICAqCiAgKiBSZXNwb25zZToKICAqIGBgYGpzb24KICAqIHsKICAqICAgImRhdGEiOiBbCiAgKiAgICAgewogICogICAgICAgIm5hbWUiOiAiYXZhdGFyMS5wbmciLAogICogICAgICAgImlkIjogImU2NjhjZjdmLTgyMWItNGEyZi05ZGNlLTdkZmE1ZGQxY2ZkMiIsCiAgKiAgICAgICAidXBkYXRlZF9hdCI6ICIyMDI0LTA1LTIyVDIzOjA2OjA1LjU4MFoiLAogICogICAgICAgImNyZWF0ZWRfYXQiOiAiMjAyNC0wNS0yMlQyMzowNDozNC40NDNaIiwKICAqICAgICAgICJsYXN0X2FjY2Vzc2VkX2F0IjogIjIwMjQtMDUtMjJUMjM6MDQ6MzQuNDQzWiIsCiAgKiAgICAgICAibWV0YWRhdGEiOiB7CiAgKiAgICAgICAgICJlVGFnIjogIlwiYzVlOGM1NTMyMzVkOWFmMzBlZjRmNmUyODA3OTBiOTJcIiIsCiAgKiAgICAgICAgICJzaXplIjogMzIxNzUsCiAgKiAgICAgICAgICJtaW1ldHlwZSI6ICJpbWFnZS9wbmciLAogICogICAgICAgICAiY2FjaGVDb250cm9sIjogIm1heC1hZ2U9MzYwMCIsCiAgKiAgICAgICAgICJsYXN0TW9kaWZpZWQiOiAiMjAyNC0wNS0yMlQyMzowNjowNS41NzRaIiwKICAqICAgICAgICAgImNvbnRlbnRMZW5ndGgiOiAzMjE3NSwKICAqICAgICAgICAgImh0dHBTdGF0dXNDb2RlIjogMjAwCiAgKiAgICAgICB9CiAgKiAgICAgfQogICogICBdLAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqCiAgKiBAZXhhbXBsZSBTZWFyY2ggZmlsZXMgaW4gYSBidWNrZXQKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZnJvbSgnYXZhdGFycycpCiAgKiAgIC5saXN0KCdmb2xkZXInLCB7CiAgKiAgICAgbGltaXQ6IDEwMCwKICAqICAgICBvZmZzZXQ6IDAsCiAgKiAgICAgc29ydEJ5OiB7IGNvbHVtbjogJ25hbWUnLCBvcmRlcjogJ2FzYycgfSwKICAqICAgICBzZWFyY2g6ICdqb24nCiAgKiAgIH0pCiAgKiBgYGAKICAqLwogIGFzeW5jIGxpc3QocGF0aDIsIG9wdGlvbnMsIHBhcmFtZXRlcnMpIHsKICAgIHZhciBfdGhpczEzID0gdGhpczsKICAgIHJldHVybiBfdGhpczEzLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIGNvbnN0IGJvZHkgPSBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoX29iamVjdFNwcmVhZDIxMSh7fSwgREVGQVVMVF9TRUFSQ0hfT1BUSU9OUyksIG9wdGlvbnMpLCB7fSwgeyBwcmVmaXg6IHBhdGgyIHx8ICIiIH0pOwogICAgICByZXR1cm4gYXdhaXQgcG9zdChfdGhpczEzLmZldGNoLCBgJHtfdGhpczEzLnVybH0vb2JqZWN0L2xpc3QvJHtfdGhpczEzLmJ1Y2tldElkfWAsIGJvZHksIHsgaGVhZGVyczogX3RoaXMxMy5oZWFkZXJzIH0sIHBhcmFtZXRlcnMpOwogICAgfSk7CiAgfQogIC8qKgogICogQGV4cGVyaW1lbnRhbCB0aGlzIG1ldGhvZCBzaWduYXR1cmUgbWlnaHQgY2hhbmdlIGluIHRoZSBmdXR1cmUKICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gb3B0aW9ucyBzZWFyY2ggb3B0aW9ucwogICogQHBhcmFtIHBhcmFtZXRlcnMKICAqLwogIGFzeW5jIGxpc3RWMihvcHRpb25zLCBwYXJhbWV0ZXJzKSB7CiAgICB2YXIgX3RoaXMxNCA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXMxNC5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICBjb25zdCBib2R5ID0gX29iamVjdFNwcmVhZDIxMSh7fSwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBhd2FpdCBwb3N0KF90aGlzMTQuZmV0Y2gsIGAke190aGlzMTQudXJsfS9vYmplY3QvbGlzdC12Mi8ke190aGlzMTQuYnVja2V0SWR9YCwgYm9keSwgeyBoZWFkZXJzOiBfdGhpczE0LmhlYWRlcnMgfSwgcGFyYW1ldGVycyk7CiAgICB9KTsKICB9CiAgZW5jb2RlTWV0YWRhdGEobWV0YWRhdGEpIHsKICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShtZXRhZGF0YSk7CiAgfQogIHRvQmFzZTY0KGRhdGEpIHsKICAgIGlmICh0eXBlb2YgQnVmZmVyICE9PSAidW5kZWZpbmVkIikgcmV0dXJuIEJ1ZmZlci5mcm9tKGRhdGEpLnRvU3RyaW5nKCJiYXNlNjQiKTsKICAgIHJldHVybiBidG9hKGRhdGEpOwogIH0KICBfZ2V0RmluYWxQYXRoKHBhdGgyKSB7CiAgICByZXR1cm4gYCR7dGhpcy5idWNrZXRJZH0vJHtwYXRoMi5yZXBsYWNlKC9eXC8rLywgIiIpfWA7CiAgfQogIF9yZW1vdmVFbXB0eUZvbGRlcnMocGF0aDIpIHsKICAgIHJldHVybiBwYXRoMi5yZXBsYWNlKC9eXC98XC8kL2csICIiKS5yZXBsYWNlKC9cLysvZywgIi8iKTsKICB9CiAgdHJhbnNmb3JtT3B0c1RvUXVlcnlTdHJpbmcodHJhbnNmb3JtKSB7CiAgICBjb25zdCBwYXJhbXMgPSBbXTsKICAgIGlmICh0cmFuc2Zvcm0ud2lkdGgpIHBhcmFtcy5wdXNoKGB3aWR0aD0ke3RyYW5zZm9ybS53aWR0aH1gKTsKICAgIGlmICh0cmFuc2Zvcm0uaGVpZ2h0KSBwYXJhbXMucHVzaChgaGVpZ2h0PSR7dHJhbnNmb3JtLmhlaWdodH1gKTsKICAgIGlmICh0cmFuc2Zvcm0ucmVzaXplKSBwYXJhbXMucHVzaChgcmVzaXplPSR7dHJhbnNmb3JtLnJlc2l6ZX1gKTsKICAgIGlmICh0cmFuc2Zvcm0uZm9ybWF0KSBwYXJhbXMucHVzaChgZm9ybWF0PSR7dHJhbnNmb3JtLmZvcm1hdH1gKTsKICAgIGlmICh0cmFuc2Zvcm0ucXVhbGl0eSkgcGFyYW1zLnB1c2goYHF1YWxpdHk9JHt0cmFuc2Zvcm0ucXVhbGl0eX1gKTsKICAgIHJldHVybiBwYXJhbXMuam9pbigiJiIpOwogIH0KfTsKdmFyIHZlcnNpb24zID0gIjIuOTcuMCI7CnZhciBERUZBVUxUX0hFQURFUlMgPSB7ICJYLUNsaWVudC1JbmZvIjogYHN0b3JhZ2UtanMvJHt2ZXJzaW9uM31gIH07CnZhciBTdG9yYWdlQnVja2V0QXBpID0gY2xhc3MgZXh0ZW5kcyBCYXNlQXBpQ2xpZW50IHsKICBjb25zdHJ1Y3Rvcih1cmwsIGhlYWRlcnMgPSB7fSwgZmV0Y2gkMSwgb3B0cykgewogICAgY29uc3QgYmFzZVVybCA9IG5ldyBVUkwodXJsKTsKICAgIGlmIChvcHRzID09PSBudWxsIHx8IG9wdHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdHMudXNlTmV3SG9zdG5hbWUpIHsKICAgICAgaWYgKC9zdXBhYmFzZVwuKGNvfGlufHJlZCkkLy50ZXN0KGJhc2VVcmwuaG9zdG5hbWUpICYmICFiYXNlVXJsLmhvc3RuYW1lLmluY2x1ZGVzKCJzdG9yYWdlLnN1cGFiYXNlLiIpKSBiYXNlVXJsLmhvc3RuYW1lID0gYmFzZVVybC5ob3N0bmFtZS5yZXBsYWNlKCJzdXBhYmFzZS4iLCAic3RvcmFnZS5zdXBhYmFzZS4iKTsKICAgIH0KICAgIGNvbnN0IGZpbmFsVXJsID0gYmFzZVVybC5ocmVmLnJlcGxhY2UoL1wvJC8sICIiKTsKICAgIGNvbnN0IGZpbmFsSGVhZGVycyA9IF9vYmplY3RTcHJlYWQyMTEoX29iamVjdFNwcmVhZDIxMSh7fSwgREVGQVVMVF9IRUFERVJTKSwgaGVhZGVycyk7CiAgICBzdXBlcihmaW5hbFVybCwgZmluYWxIZWFkZXJzLCBmZXRjaCQxLCAic3RvcmFnZSIpOwogIH0KICAvKioKICAqIFJldHJpZXZlcyB0aGUgZGV0YWlscyBvZiBhbGwgU3RvcmFnZSBidWNrZXRzIHdpdGhpbiBhbiBleGlzdGluZyBwcm9qZWN0LgogICoKICAqIEBjYXRlZ29yeSBGaWxlIEJ1Y2tldHMKICAqIEBwYXJhbSBvcHRpb25zIFF1ZXJ5IHBhcmFtZXRlcnMgZm9yIGxpc3RpbmcgYnVja2V0cwogICogQHBhcmFtIG9wdGlvbnMubGltaXQgTWF4aW11bSBudW1iZXIgb2YgYnVja2V0cyB0byByZXR1cm4KICAqIEBwYXJhbSBvcHRpb25zLm9mZnNldCBOdW1iZXIgb2YgYnVja2V0cyB0byBza2lwCiAgKiBAcGFyYW0gb3B0aW9ucy5zb3J0Q29sdW1uIENvbHVtbiB0byBzb3J0IGJ5ICgnaWQnLCAnbmFtZScsICdjcmVhdGVkX2F0JywgJ3VwZGF0ZWRfYXQnKQogICogQHBhcmFtIG9wdGlvbnMuc29ydE9yZGVyIFNvcnQgb3JkZXIgKCdhc2MnIG9yICdkZXNjJykKICAqIEBwYXJhbSBvcHRpb25zLnNlYXJjaCBTZWFyY2ggdGVybSB0byBmaWx0ZXIgYnVja2V0IG5hbWVzCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBhcnJheSBvZiBidWNrZXRzIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUgTGlzdCBidWNrZXRzCiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmxpc3RCdWNrZXRzKCkKICAqIGBgYAogICoKICAqIEBleGFtcGxlIExpc3QgYnVja2V0cyB3aXRoIG9wdGlvbnMKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAubGlzdEJ1Y2tldHMoewogICogICAgIGxpbWl0OiAxMCwKICAqICAgICBvZmZzZXQ6IDAsCiAgKiAgICAgc29ydENvbHVtbjogJ2NyZWF0ZWRfYXQnLAogICogICAgIHNvcnRPcmRlcjogJ2Rlc2MnLAogICogICAgIHNlYXJjaDogJ3Byb2QnCiAgKiAgIH0pCiAgKiBgYGAKICAqLwogIGFzeW5jIGxpc3RCdWNrZXRzKG9wdGlvbnMpIHsKICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXMuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgY29uc3QgcXVlcnlTdHJpbmcgPSBfdGhpcy5saXN0QnVja2V0T3B0aW9uc1RvUXVlcnlTdHJpbmcob3B0aW9ucyk7CiAgICAgIHJldHVybiBhd2FpdCBnZXQ1KF90aGlzLmZldGNoLCBgJHtfdGhpcy51cmx9L2J1Y2tldCR7cXVlcnlTdHJpbmd9YCwgeyBoZWFkZXJzOiBfdGhpcy5oZWFkZXJzIH0pOwogICAgfSk7CiAgfQogIC8qKgogICogUmV0cmlldmVzIHRoZSBkZXRhaWxzIG9mIGFuIGV4aXN0aW5nIFN0b3JhZ2UgYnVja2V0LgogICoKICAqIEBjYXRlZ29yeSBGaWxlIEJ1Y2tldHMKICAqIEBwYXJhbSBpZCBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGJ1Y2tldCB5b3Ugd291bGQgbGlrZSB0byByZXRyaWV2ZS4KICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIGJ1Y2tldCBkZXRhaWxzIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUgR2V0IGJ1Y2tldAogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5nZXRCdWNrZXQoJ2F2YXRhcnMnKQogICogYGBgCiAgKgogICogUmVzcG9uc2U6CiAgKiBgYGBqc29uCiAgKiB7CiAgKiAgICJkYXRhIjogewogICogICAgICJpZCI6ICJhdmF0YXJzIiwKICAqICAgICAibmFtZSI6ICJhdmF0YXJzIiwKICAqICAgICAib3duZXIiOiAiIiwKICAqICAgICAicHVibGljIjogZmFsc2UsCiAgKiAgICAgImZpbGVfc2l6ZV9saW1pdCI6IDEwMjQsCiAgKiAgICAgImFsbG93ZWRfbWltZV90eXBlcyI6IFsKICAqICAgICAgICJpbWFnZS9wbmciCiAgKiAgICAgXSwKICAqICAgICAiY3JlYXRlZF9hdCI6ICIyMDI0LTA1LTIyVDIyOjI2OjA1LjEwMFoiLAogICogICAgICJ1cGRhdGVkX2F0IjogIjIwMjQtMDUtMjJUMjI6MjY6MDUuMTAwWiIKICAqICAgfSwKICAqICAgImVycm9yIjogbnVsbAogICogfQogICogYGBgCiAgKi8KICBhc3luYyBnZXRCdWNrZXQoaWQpIHsKICAgIHZhciBfdGhpczIgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzMi5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgZ2V0NShfdGhpczIuZmV0Y2gsIGAke190aGlzMi51cmx9L2J1Y2tldC8ke2lkfWAsIHsgaGVhZGVyczogX3RoaXMyLmhlYWRlcnMgfSk7CiAgICB9KTsKICB9CiAgLyoqCiAgKiBDcmVhdGVzIGEgbmV3IFN0b3JhZ2UgYnVja2V0CiAgKgogICogQGNhdGVnb3J5IEZpbGUgQnVja2V0cwogICogQHBhcmFtIGlkIEEgdW5pcXVlIGlkZW50aWZpZXIgZm9yIHRoZSBidWNrZXQgeW91IGFyZSBjcmVhdGluZy4KICAqIEBwYXJhbSBvcHRpb25zLnB1YmxpYyBUaGUgdmlzaWJpbGl0eSBvZiB0aGUgYnVja2V0LiBQdWJsaWMgYnVja2V0cyBkb24ndCByZXF1aXJlIGFuIGF1dGhvcml6YXRpb24gdG9rZW4gdG8gZG93bmxvYWQgb2JqZWN0cywgYnV0IHN0aWxsIHJlcXVpcmUgYSB2YWxpZCB0b2tlbiBmb3IgYWxsIG90aGVyIG9wZXJhdGlvbnMuIEJ5IGRlZmF1bHQsIGJ1Y2tldHMgYXJlIHByaXZhdGUuCiAgKiBAcGFyYW0gb3B0aW9ucy5maWxlU2l6ZUxpbWl0IHNwZWNpZmllcyB0aGUgbWF4IGZpbGUgc2l6ZSBpbiBieXRlcyB0aGF0IGNhbiBiZSB1cGxvYWRlZCB0byB0aGlzIGJ1Y2tldC4KICAqIFRoZSBnbG9iYWwgZmlsZSBzaXplIGxpbWl0IHRha2VzIHByZWNlZGVuY2Ugb3ZlciB0aGlzIHZhbHVlLgogICogVGhlIGRlZmF1bHQgdmFsdWUgaXMgbnVsbCwgd2hpY2ggZG9lc24ndCBzZXQgYSBwZXIgYnVja2V0IGZpbGUgc2l6ZSBsaW1pdC4KICAqIEBwYXJhbSBvcHRpb25zLmFsbG93ZWRNaW1lVHlwZXMgc3BlY2lmaWVzIHRoZSBhbGxvd2VkIG1pbWUgdHlwZXMgdGhhdCB0aGlzIGJ1Y2tldCBjYW4gYWNjZXB0IGR1cmluZyB1cGxvYWQuCiAgKiBUaGUgZGVmYXVsdCB2YWx1ZSBpcyBudWxsLCB3aGljaCBhbGxvd3MgZmlsZXMgd2l0aCBhbGwgbWltZSB0eXBlcyB0byBiZSB1cGxvYWRlZC4KICAqIEVhY2ggbWltZSB0eXBlIHNwZWNpZmllZCBjYW4gYmUgYSB3aWxkY2FyZCwgZS5nLiBpbWFnZS8qLCBvciBhIHNwZWNpZmljIG1pbWUgdHlwZSwgZS5nLiBpbWFnZS9wbmcuCiAgKiBAcGFyYW0gb3B0aW9ucy50eXBlIChwcml2YXRlLWJldGEpIHNwZWNpZmllcyB0aGUgYnVja2V0IHR5cGUuIHNlZSBgQnVja2V0VHlwZWAgZm9yIG1vcmUgZGV0YWlscy4KICAqICAgLSBkZWZhdWx0IGJ1Y2tldCB0eXBlIGlzIGBTVEFOREFSRGAKICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIG5ld2x5IGNyZWF0ZWQgYnVja2V0IG5hbWUgb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZSBDcmVhdGUgYnVja2V0CiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmNyZWF0ZUJ1Y2tldCgnYXZhdGFycycsIHsKICAqICAgICBwdWJsaWM6IGZhbHNlLAogICogICAgIGFsbG93ZWRNaW1lVHlwZXM6IFsnaW1hZ2UvcG5nJ10sCiAgKiAgICAgZmlsZVNpemVMaW1pdDogMTAyNAogICogICB9KQogICogYGBgCiAgKgogICogUmVzcG9uc2U6CiAgKiBgYGBqc29uCiAgKiB7CiAgKiAgICJkYXRhIjogewogICogICAgICJuYW1lIjogImF2YXRhcnMiCiAgKiAgIH0sCiAgKiAgICJlcnJvciI6IG51bGwKICAqIH0KICAqIGBgYAogICovCiAgYXN5bmMgY3JlYXRlQnVja2V0KGlkLCBvcHRpb25zID0geyBwdWJsaWM6IGZhbHNlIH0pIHsKICAgIHZhciBfdGhpczMgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzMy5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgcG9zdChfdGhpczMuZmV0Y2gsIGAke190aGlzMy51cmx9L2J1Y2tldGAsIHsKICAgICAgICBpZCwKICAgICAgICBuYW1lOiBpZCwKICAgICAgICB0eXBlOiBvcHRpb25zLnR5cGUsCiAgICAgICAgcHVibGljOiBvcHRpb25zLnB1YmxpYywKICAgICAgICBmaWxlX3NpemVfbGltaXQ6IG9wdGlvbnMuZmlsZVNpemVMaW1pdCwKICAgICAgICBhbGxvd2VkX21pbWVfdHlwZXM6IG9wdGlvbnMuYWxsb3dlZE1pbWVUeXBlcwogICAgICB9LCB7IGhlYWRlcnM6IF90aGlzMy5oZWFkZXJzIH0pOwogICAgfSk7CiAgfQogIC8qKgogICogVXBkYXRlcyBhIFN0b3JhZ2UgYnVja2V0CiAgKgogICogQGNhdGVnb3J5IEZpbGUgQnVja2V0cwogICogQHBhcmFtIGlkIEEgdW5pcXVlIGlkZW50aWZpZXIgZm9yIHRoZSBidWNrZXQgeW91IGFyZSB1cGRhdGluZy4KICAqIEBwYXJhbSBvcHRpb25zLnB1YmxpYyBUaGUgdmlzaWJpbGl0eSBvZiB0aGUgYnVja2V0LiBQdWJsaWMgYnVja2V0cyBkb24ndCByZXF1aXJlIGFuIGF1dGhvcml6YXRpb24gdG9rZW4gdG8gZG93bmxvYWQgb2JqZWN0cywgYnV0IHN0aWxsIHJlcXVpcmUgYSB2YWxpZCB0b2tlbiBmb3IgYWxsIG90aGVyIG9wZXJhdGlvbnMuCiAgKiBAcGFyYW0gb3B0aW9ucy5maWxlU2l6ZUxpbWl0IHNwZWNpZmllcyB0aGUgbWF4IGZpbGUgc2l6ZSBpbiBieXRlcyB0aGF0IGNhbiBiZSB1cGxvYWRlZCB0byB0aGlzIGJ1Y2tldC4KICAqIFRoZSBnbG9iYWwgZmlsZSBzaXplIGxpbWl0IHRha2VzIHByZWNlZGVuY2Ugb3ZlciB0aGlzIHZhbHVlLgogICogVGhlIGRlZmF1bHQgdmFsdWUgaXMgbnVsbCwgd2hpY2ggZG9lc24ndCBzZXQgYSBwZXIgYnVja2V0IGZpbGUgc2l6ZSBsaW1pdC4KICAqIEBwYXJhbSBvcHRpb25zLmFsbG93ZWRNaW1lVHlwZXMgc3BlY2lmaWVzIHRoZSBhbGxvd2VkIG1pbWUgdHlwZXMgdGhhdCB0aGlzIGJ1Y2tldCBjYW4gYWNjZXB0IGR1cmluZyB1cGxvYWQuCiAgKiBUaGUgZGVmYXVsdCB2YWx1ZSBpcyBudWxsLCB3aGljaCBhbGxvd3MgZmlsZXMgd2l0aCBhbGwgbWltZSB0eXBlcyB0byBiZSB1cGxvYWRlZC4KICAqIEVhY2ggbWltZSB0eXBlIHNwZWNpZmllZCBjYW4gYmUgYSB3aWxkY2FyZCwgZS5nLiBpbWFnZS8qLCBvciBhIHNwZWNpZmljIG1pbWUgdHlwZSwgZS5nLiBpbWFnZS9wbmcuCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBzdWNjZXNzIG1lc3NhZ2Ugb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZSBVcGRhdGUgYnVja2V0CiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLnVwZGF0ZUJ1Y2tldCgnYXZhdGFycycsIHsKICAqICAgICBwdWJsaWM6IGZhbHNlLAogICogICAgIGFsbG93ZWRNaW1lVHlwZXM6IFsnaW1hZ2UvcG5nJ10sCiAgKiAgICAgZmlsZVNpemVMaW1pdDogMTAyNAogICogICB9KQogICogYGBgCiAgKgogICogUmVzcG9uc2U6CiAgKiBgYGBqc29uCiAgKiB7CiAgKiAgICJkYXRhIjogewogICogICAgICJtZXNzYWdlIjogIlN1Y2Nlc3NmdWxseSB1cGRhdGVkIgogICogICB9LAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqLwogIGFzeW5jIHVwZGF0ZUJ1Y2tldChpZCwgb3B0aW9ucykgewogICAgdmFyIF90aGlzNCA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXM0LmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCBwdXQoX3RoaXM0LmZldGNoLCBgJHtfdGhpczQudXJsfS9idWNrZXQvJHtpZH1gLCB7CiAgICAgICAgaWQsCiAgICAgICAgbmFtZTogaWQsCiAgICAgICAgcHVibGljOiBvcHRpb25zLnB1YmxpYywKICAgICAgICBmaWxlX3NpemVfbGltaXQ6IG9wdGlvbnMuZmlsZVNpemVMaW1pdCwKICAgICAgICBhbGxvd2VkX21pbWVfdHlwZXM6IG9wdGlvbnMuYWxsb3dlZE1pbWVUeXBlcwogICAgICB9LCB7IGhlYWRlcnM6IF90aGlzNC5oZWFkZXJzIH0pOwogICAgfSk7CiAgfQogIC8qKgogICogUmVtb3ZlcyBhbGwgb2JqZWN0cyBpbnNpZGUgYSBzaW5nbGUgYnVja2V0LgogICoKICAqIEBjYXRlZ29yeSBGaWxlIEJ1Y2tldHMKICAqIEBwYXJhbSBpZCBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGJ1Y2tldCB5b3Ugd291bGQgbGlrZSB0byBlbXB0eS4KICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCBzdWNjZXNzIG1lc3NhZ2Ugb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZSBFbXB0eSBidWNrZXQKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZW1wdHlCdWNrZXQoJ2F2YXRhcnMnKQogICogYGBgCiAgKgogICogUmVzcG9uc2U6CiAgKiBgYGBqc29uCiAgKiB7CiAgKiAgICJkYXRhIjogewogICogICAgICJtZXNzYWdlIjogIlN1Y2Nlc3NmdWxseSBlbXB0aWVkIgogICogICB9LAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqLwogIGFzeW5jIGVtcHR5QnVja2V0KGlkKSB7CiAgICB2YXIgX3RoaXM1ID0gdGhpczsKICAgIHJldHVybiBfdGhpczUuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHBvc3QoX3RoaXM1LmZldGNoLCBgJHtfdGhpczUudXJsfS9idWNrZXQvJHtpZH0vZW1wdHlgLCB7fSwgeyBoZWFkZXJzOiBfdGhpczUuaGVhZGVycyB9KTsKICAgIH0pOwogIH0KICAvKioKICAqIERlbGV0ZXMgYW4gZXhpc3RpbmcgYnVja2V0LiBBIGJ1Y2tldCBjYW4ndCBiZSBkZWxldGVkIHdpdGggZXhpc3Rpbmcgb2JqZWN0cyBpbnNpZGUgaXQuCiAgKiBZb3UgbXVzdCBmaXJzdCBgZW1wdHkoKWAgdGhlIGJ1Y2tldC4KICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gaWQgVGhlIHVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBidWNrZXQgeW91IHdvdWxkIGxpa2UgdG8gZGVsZXRlLgogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIHN1Y2Nlc3MgbWVzc2FnZSBvciBlcnJvcgogICoKICAqIEBleGFtcGxlIERlbGV0ZSBidWNrZXQKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZGVsZXRlQnVja2V0KCdhdmF0YXJzJykKICAqIGBgYAogICoKICAqIFJlc3BvbnNlOgogICogYGBganNvbgogICogewogICogICAiZGF0YSI6IHsKICAqICAgICAibWVzc2FnZSI6ICJTdWNjZXNzZnVsbHkgZGVsZXRlZCIKICAqICAgfSwKICAqICAgImVycm9yIjogbnVsbAogICogfQogICogYGBgCiAgKi8KICBhc3luYyBkZWxldGVCdWNrZXQoaWQpIHsKICAgIHZhciBfdGhpczYgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzNi5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgcmVtb3ZlKF90aGlzNi5mZXRjaCwgYCR7X3RoaXM2LnVybH0vYnVja2V0LyR7aWR9YCwge30sIHsgaGVhZGVyczogX3RoaXM2LmhlYWRlcnMgfSk7CiAgICB9KTsKICB9CiAgbGlzdEJ1Y2tldE9wdGlvbnNUb1F1ZXJ5U3RyaW5nKG9wdGlvbnMpIHsKICAgIGNvbnN0IHBhcmFtcyA9IHt9OwogICAgaWYgKG9wdGlvbnMpIHsKICAgICAgaWYgKCJsaW1pdCIgaW4gb3B0aW9ucykgcGFyYW1zLmxpbWl0ID0gU3RyaW5nKG9wdGlvbnMubGltaXQpOwogICAgICBpZiAoIm9mZnNldCIgaW4gb3B0aW9ucykgcGFyYW1zLm9mZnNldCA9IFN0cmluZyhvcHRpb25zLm9mZnNldCk7CiAgICAgIGlmIChvcHRpb25zLnNlYXJjaCkgcGFyYW1zLnNlYXJjaCA9IG9wdGlvbnMuc2VhcmNoOwogICAgICBpZiAob3B0aW9ucy5zb3J0Q29sdW1uKSBwYXJhbXMuc29ydENvbHVtbiA9IG9wdGlvbnMuc29ydENvbHVtbjsKICAgICAgaWYgKG9wdGlvbnMuc29ydE9yZGVyKSBwYXJhbXMuc29ydE9yZGVyID0gb3B0aW9ucy5zb3J0T3JkZXI7CiAgICB9CiAgICByZXR1cm4gT2JqZWN0LmtleXMocGFyYW1zKS5sZW5ndGggPiAwID8gIj8iICsgbmV3IFVSTFNlYXJjaFBhcmFtcyhwYXJhbXMpLnRvU3RyaW5nKCkgOiAiIjsKICB9Cn07CnZhciBTdG9yYWdlQW5hbHl0aWNzQ2xpZW50ID0gY2xhc3MgZXh0ZW5kcyBCYXNlQXBpQ2xpZW50IHsKICAvKioKICAqIEBhbHBoYQogICoKICAqIENyZWF0ZXMgYSBuZXcgU3RvcmFnZUFuYWx5dGljc0NsaWVudCBpbnN0YW5jZQogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IEFuYWx5dGljcyBCdWNrZXRzCiAgKiBAcGFyYW0gdXJsIC0gVGhlIGJhc2UgVVJMIGZvciB0aGUgc3RvcmFnZSBBUEkKICAqIEBwYXJhbSBoZWFkZXJzIC0gSFRUUCBoZWFkZXJzIHRvIGluY2x1ZGUgaW4gcmVxdWVzdHMKICAqIEBwYXJhbSBmZXRjaCAtIE9wdGlvbmFsIGN1c3RvbSBmZXRjaCBpbXBsZW1lbnRhdGlvbgogICoKICAqIEBleGFtcGxlCiAgKiBgYGB0eXBlc2NyaXB0CiAgKiBjb25zdCBjbGllbnQgPSBuZXcgU3RvcmFnZUFuYWx5dGljc0NsaWVudCh1cmwsIGhlYWRlcnMpCiAgKiBgYGAKICAqLwogIGNvbnN0cnVjdG9yKHVybCwgaGVhZGVycyA9IHt9LCBmZXRjaCQxKSB7CiAgICBjb25zdCBmaW5hbFVybCA9IHVybC5yZXBsYWNlKC9cLyQvLCAiIik7CiAgICBjb25zdCBmaW5hbEhlYWRlcnMgPSBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIERFRkFVTFRfSEVBREVSUyksIGhlYWRlcnMpOwogICAgc3VwZXIoZmluYWxVcmwsIGZpbmFsSGVhZGVycywgZmV0Y2gkMSwgInN0b3JhZ2UiKTsKICB9CiAgLyoqCiAgKiBAYWxwaGEKICAqCiAgKiBDcmVhdGVzIGEgbmV3IGFuYWx5dGljcyBidWNrZXQgdXNpbmcgSWNlYmVyZyB0YWJsZXMKICAqIEFuYWx5dGljcyBidWNrZXRzIGFyZSBvcHRpbWl6ZWQgZm9yIGFuYWx5dGljYWwgcXVlcmllcyBhbmQgZGF0YSBwcm9jZXNzaW5nCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgQW5hbHl0aWNzIEJ1Y2tldHMKICAqIEBwYXJhbSBuYW1lIEEgdW5pcXVlIG5hbWUgZm9yIHRoZSBidWNrZXQgeW91IGFyZSBjcmVhdGluZwogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIHJlc3BvbnNlIGNvbnRhaW5pbmcgbmV3bHkgY3JlYXRlZCBhbmFseXRpY3MgYnVja2V0IG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUgQ3JlYXRlIGFuYWx5dGljcyBidWNrZXQKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuYW5hbHl0aWNzCiAgKiAgIC5jcmVhdGVCdWNrZXQoJ2FuYWx5dGljcy1kYXRhJykKICAqIGBgYAogICoKICAqIFJlc3BvbnNlOgogICogYGBganNvbgogICogewogICogICAiZGF0YSI6IHsKICAqICAgICAibmFtZSI6ICJhbmFseXRpY3MtZGF0YSIsCiAgKiAgICAgInR5cGUiOiAiQU5BTFlUSUNTIiwKICAqICAgICAiZm9ybWF0IjogImljZWJlcmciLAogICogICAgICJjcmVhdGVkX2F0IjogIjIwMjQtMDUtMjJUMjI6MjY6MDUuMTAwWiIsCiAgKiAgICAgInVwZGF0ZWRfYXQiOiAiMjAyNC0wNS0yMlQyMjoyNjowNS4xMDBaIgogICogICB9LAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqLwogIGFzeW5jIGNyZWF0ZUJ1Y2tldChuYW1lKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCBwb3N0KF90aGlzLmZldGNoLCBgJHtfdGhpcy51cmx9L2J1Y2tldGAsIHsgbmFtZSB9LCB7IGhlYWRlcnM6IF90aGlzLmhlYWRlcnMgfSk7CiAgICB9KTsKICB9CiAgLyoqCiAgKiBAYWxwaGEKICAqCiAgKiBSZXRyaWV2ZXMgdGhlIGRldGFpbHMgb2YgYWxsIEFuYWx5dGljcyBTdG9yYWdlIGJ1Y2tldHMgd2l0aGluIGFuIGV4aXN0aW5nIHByb2plY3QKICAqIE9ubHkgcmV0dXJucyBidWNrZXRzIG9mIHR5cGUgJ0FOQUxZVElDUycKICAqCiAgKiAqKlB1YmxpYyBhbHBoYToqKiBUaGlzIEFQSSBpcyBwYXJ0IG9mIGEgcHVibGljIGFscGhhIHJlbGVhc2UgYW5kIG1heSBub3QgYmUgYXZhaWxhYmxlIHRvIHlvdXIgYWNjb3VudCB0eXBlLgogICoKICAqIEBjYXRlZ29yeSBBbmFseXRpY3MgQnVja2V0cwogICogQHBhcmFtIG9wdGlvbnMgUXVlcnkgcGFyYW1ldGVycyBmb3IgbGlzdGluZyBidWNrZXRzCiAgKiBAcGFyYW0gb3B0aW9ucy5saW1pdCBNYXhpbXVtIG51bWJlciBvZiBidWNrZXRzIHRvIHJldHVybgogICogQHBhcmFtIG9wdGlvbnMub2Zmc2V0IE51bWJlciBvZiBidWNrZXRzIHRvIHNraXAKICAqIEBwYXJhbSBvcHRpb25zLnNvcnRDb2x1bW4gQ29sdW1uIHRvIHNvcnQgYnkgKCduYW1lJywgJ2NyZWF0ZWRfYXQnLCAndXBkYXRlZF9hdCcpCiAgKiBAcGFyYW0gb3B0aW9ucy5zb3J0T3JkZXIgU29ydCBvcmRlciAoJ2FzYycgb3IgJ2Rlc2MnKQogICogQHBhcmFtIG9wdGlvbnMuc2VhcmNoIFNlYXJjaCB0ZXJtIHRvIGZpbHRlciBidWNrZXQgbmFtZXMKICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIGFycmF5IG9mIGFuYWx5dGljcyBidWNrZXRzIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUgTGlzdCBhbmFseXRpY3MgYnVja2V0cwogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5hbmFseXRpY3MKICAqICAgLmxpc3RCdWNrZXRzKHsKICAqICAgICBsaW1pdDogMTAsCiAgKiAgICAgb2Zmc2V0OiAwLAogICogICAgIHNvcnRDb2x1bW46ICdjcmVhdGVkX2F0JywKICAqICAgICBzb3J0T3JkZXI6ICdkZXNjJwogICogICB9KQogICogYGBgCiAgKgogICogUmVzcG9uc2U6CiAgKiBgYGBqc29uCiAgKiB7CiAgKiAgICJkYXRhIjogWwogICogICAgIHsKICAqICAgICAgICJuYW1lIjogImFuYWx5dGljcy1kYXRhIiwKICAqICAgICAgICJ0eXBlIjogIkFOQUxZVElDUyIsCiAgKiAgICAgICAiZm9ybWF0IjogImljZWJlcmciLAogICogICAgICAgImNyZWF0ZWRfYXQiOiAiMjAyNC0wNS0yMlQyMjoyNjowNS4xMDBaIiwKICAqICAgICAgICJ1cGRhdGVkX2F0IjogIjIwMjQtMDUtMjJUMjI6MjY6MDUuMTAwWiIKICAqICAgICB9CiAgKiAgIF0sCiAgKiAgICJlcnJvciI6IG51bGwKICAqIH0KICAqIGBgYAogICovCiAgYXN5bmMgbGlzdEJ1Y2tldHMob3B0aW9ucykgewogICAgdmFyIF90aGlzMiA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXMyLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIGNvbnN0IHF1ZXJ5UGFyYW1zID0gbmV3IFVSTFNlYXJjaFBhcmFtcygpOwogICAgICBpZiAoKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5saW1pdCkgIT09IHZvaWQgMCkgcXVlcnlQYXJhbXMuc2V0KCJsaW1pdCIsIG9wdGlvbnMubGltaXQudG9TdHJpbmcoKSk7CiAgICAgIGlmICgob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLm9mZnNldCkgIT09IHZvaWQgMCkgcXVlcnlQYXJhbXMuc2V0KCJvZmZzZXQiLCBvcHRpb25zLm9mZnNldC50b1N0cmluZygpKTsKICAgICAgaWYgKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5zb3J0Q29sdW1uKSBxdWVyeVBhcmFtcy5zZXQoInNvcnRDb2x1bW4iLCBvcHRpb25zLnNvcnRDb2x1bW4pOwogICAgICBpZiAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNvcnRPcmRlcikgcXVlcnlQYXJhbXMuc2V0KCJzb3J0T3JkZXIiLCBvcHRpb25zLnNvcnRPcmRlcik7CiAgICAgIGlmIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc2VhcmNoKSBxdWVyeVBhcmFtcy5zZXQoInNlYXJjaCIsIG9wdGlvbnMuc2VhcmNoKTsKICAgICAgY29uc3QgcXVlcnlTdHJpbmcgPSBxdWVyeVBhcmFtcy50b1N0cmluZygpOwogICAgICBjb25zdCB1cmwgPSBxdWVyeVN0cmluZyA/IGAke190aGlzMi51cmx9L2J1Y2tldD8ke3F1ZXJ5U3RyaW5nfWAgOiBgJHtfdGhpczIudXJsfS9idWNrZXRgOwogICAgICByZXR1cm4gYXdhaXQgZ2V0NShfdGhpczIuZmV0Y2gsIHVybCwgeyBoZWFkZXJzOiBfdGhpczIuaGVhZGVycyB9KTsKICAgIH0pOwogIH0KICAvKioKICAqIEBhbHBoYQogICoKICAqIERlbGV0ZXMgYW4gZXhpc3RpbmcgYW5hbHl0aWNzIGJ1Y2tldAogICogQSBidWNrZXQgY2FuJ3QgYmUgZGVsZXRlZCB3aXRoIGV4aXN0aW5nIG9iamVjdHMgaW5zaWRlIGl0CiAgKiBZb3UgbXVzdCBmaXJzdCBlbXB0eSB0aGUgYnVja2V0IGJlZm9yZSBkZWxldGlvbgogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IEFuYWx5dGljcyBCdWNrZXRzCiAgKiBAcGFyYW0gYnVja2V0TmFtZSBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIGJ1Y2tldCB5b3Ugd291bGQgbGlrZSB0byBkZWxldGUKICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIHN1Y2Nlc3MgbWVzc2FnZSBvciBlcnJvcgogICoKICAqIEBleGFtcGxlIERlbGV0ZSBhbmFseXRpY3MgYnVja2V0CiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmFuYWx5dGljcwogICogICAuZGVsZXRlQnVja2V0KCdhbmFseXRpY3MtZGF0YScpCiAgKiBgYGAKICAqCiAgKiBSZXNwb25zZToKICAqIGBgYGpzb24KICAqIHsKICAqICAgImRhdGEiOiB7CiAgKiAgICAgIm1lc3NhZ2UiOiAiU3VjY2Vzc2Z1bGx5IGRlbGV0ZWQiCiAgKiAgIH0sCiAgKiAgICJlcnJvciI6IG51bGwKICAqIH0KICAqIGBgYAogICovCiAgYXN5bmMgZGVsZXRlQnVja2V0KGJ1Y2tldE5hbWUpIHsKICAgIHZhciBfdGhpczMgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzMy5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgcmVtb3ZlKF90aGlzMy5mZXRjaCwgYCR7X3RoaXMzLnVybH0vYnVja2V0LyR7YnVja2V0TmFtZX1gLCB7fSwgeyBoZWFkZXJzOiBfdGhpczMuaGVhZGVycyB9KTsKICAgIH0pOwogIH0KICAvKioKICAqIEBhbHBoYQogICoKICAqIEdldCBhbiBJY2ViZXJnIFJFU1QgQ2F0YWxvZyBjbGllbnQgY29uZmlndXJlZCBmb3IgYSBzcGVjaWZpYyBhbmFseXRpY3MgYnVja2V0CiAgKiBVc2UgdGhpcyB0byBwZXJmb3JtIGFkdmFuY2VkIHRhYmxlIGFuZCBuYW1lc3BhY2Ugb3BlcmF0aW9ucyB3aXRoaW4gdGhlIGJ1Y2tldAogICogVGhlIHJldHVybmVkIGNsaWVudCBwcm92aWRlcyBmdWxsIGFjY2VzcyB0byB0aGUgQXBhY2hlIEljZWJlcmcgUkVTVCBDYXRhbG9nIEFQSQogICogd2l0aCB0aGUgU3VwYWJhc2UgYHsgZGF0YSwgZXJyb3IgfWAgcGF0dGVybiBmb3IgY29uc2lzdGVudCBlcnJvciBoYW5kbGluZyBvbiBhbGwgb3BlcmF0aW9ucy4KICAqCiAgKiAqKlB1YmxpYyBhbHBoYToqKiBUaGlzIEFQSSBpcyBwYXJ0IG9mIGEgcHVibGljIGFscGhhIHJlbGVhc2UgYW5kIG1heSBub3QgYmUgYXZhaWxhYmxlIHRvIHlvdXIgYWNjb3VudCB0eXBlLgogICoKICAqIEBjYXRlZ29yeSBBbmFseXRpY3MgQnVja2V0cwogICogQHBhcmFtIGJ1Y2tldE5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgYW5hbHl0aWNzIGJ1Y2tldCAod2FyZWhvdXNlKSB0byBjb25uZWN0IHRvCiAgKiBAcmV0dXJucyBUaGUgd3JhcHBlZCBJY2ViZXJnIGNhdGFsb2cgY2xpZW50CiAgKiBAdGhyb3dzIHtTdG9yYWdlRXJyb3J9IElmIHRoZSBidWNrZXQgbmFtZSBpcyBpbnZhbGlkCiAgKgogICogQGV4YW1wbGUgR2V0IGNhdGFsb2cgYW5kIGNyZWF0ZSB0YWJsZQogICogYGBganMKICAqIC8vIEZpcnN0LCBjcmVhdGUgYW4gYW5hbHl0aWNzIGJ1Y2tldAogICogY29uc3QgeyBkYXRhOiBidWNrZXQsIGVycm9yOiBidWNrZXRFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmFuYWx5dGljcwogICogICAuY3JlYXRlQnVja2V0KCdhbmFseXRpY3MtZGF0YScpCiAgKgogICogLy8gR2V0IHRoZSBJY2ViZXJnIGNhdGFsb2cgZm9yIHRoYXQgYnVja2V0CiAgKiBjb25zdCBjYXRhbG9nID0gc3VwYWJhc2Uuc3RvcmFnZS5hbmFseXRpY3MuZnJvbSgnYW5hbHl0aWNzLWRhdGEnKQogICoKICAqIC8vIENyZWF0ZSBhIG5hbWVzcGFjZQogICogY29uc3QgeyBlcnJvcjogbnNFcnJvciB9ID0gYXdhaXQgY2F0YWxvZy5jcmVhdGVOYW1lc3BhY2UoeyBuYW1lc3BhY2U6IFsnZGVmYXVsdCddIH0pCiAgKgogICogLy8gQ3JlYXRlIGEgdGFibGUgd2l0aCBzY2hlbWEKICAqIGNvbnN0IHsgZGF0YTogdGFibGVNZXRhZGF0YSwgZXJyb3I6IHRhYmxlRXJyb3IgfSA9IGF3YWl0IGNhdGFsb2cuY3JlYXRlVGFibGUoCiAgKiAgIHsgbmFtZXNwYWNlOiBbJ2RlZmF1bHQnXSB9LAogICogICB7CiAgKiAgICAgbmFtZTogJ2V2ZW50cycsCiAgKiAgICAgc2NoZW1hOiB7CiAgKiAgICAgICB0eXBlOiAnc3RydWN0JywKICAqICAgICAgIGZpZWxkczogWwogICogICAgICAgICB7IGlkOiAxLCBuYW1lOiAnaWQnLCB0eXBlOiAnbG9uZycsIHJlcXVpcmVkOiB0cnVlIH0sCiAgKiAgICAgICAgIHsgaWQ6IDIsIG5hbWU6ICd0aW1lc3RhbXAnLCB0eXBlOiAndGltZXN0YW1wJywgcmVxdWlyZWQ6IHRydWUgfSwKICAqICAgICAgICAgeyBpZDogMywgbmFtZTogJ3VzZXJfaWQnLCB0eXBlOiAnc3RyaW5nJywgcmVxdWlyZWQ6IGZhbHNlIH0KICAqICAgICAgIF0sCiAgKiAgICAgICAnc2NoZW1hLWlkJzogMCwKICAqICAgICAgICdpZGVudGlmaWVyLWZpZWxkLWlkcyc6IFsxXQogICogICAgIH0sCiAgKiAgICAgJ3BhcnRpdGlvbi1zcGVjJzogewogICogICAgICAgJ3NwZWMtaWQnOiAwLAogICogICAgICAgZmllbGRzOiBbXQogICogICAgIH0sCiAgKiAgICAgJ3dyaXRlLW9yZGVyJzogewogICogICAgICAgJ29yZGVyLWlkJzogMCwKICAqICAgICAgIGZpZWxkczogW10KICAqICAgICB9LAogICogICAgIHByb3BlcnRpZXM6IHsKICAqICAgICAgICd3cml0ZS5mb3JtYXQuZGVmYXVsdCc6ICdwYXJxdWV0JwogICogICAgIH0KICAqICAgfQogICogKQogICogYGBgCiAgKgogICogQGV4YW1wbGUgTGlzdCB0YWJsZXMgaW4gbmFtZXNwYWNlCiAgKiBgYGBqcwogICogY29uc3QgY2F0YWxvZyA9IHN1cGFiYXNlLnN0b3JhZ2UuYW5hbHl0aWNzLmZyb20oJ2FuYWx5dGljcy1kYXRhJykKICAqCiAgKiAvLyBMaXN0IGFsbCB0YWJsZXMgaW4gdGhlIGRlZmF1bHQgbmFtZXNwYWNlCiAgKiBjb25zdCB7IGRhdGE6IHRhYmxlcywgZXJyb3I6IGxpc3RFcnJvciB9ID0gYXdhaXQgY2F0YWxvZy5saXN0VGFibGVzKHsgbmFtZXNwYWNlOiBbJ2RlZmF1bHQnXSB9KQogICogaWYgKGxpc3RFcnJvcikgewogICogICBpZiAobGlzdEVycm9yLmlzTm90Rm91bmQoKSkgewogICogICAgIGNvbnNvbGUubG9nKCdOYW1lc3BhY2Ugbm90IGZvdW5kJykKICAqICAgfQogICogICByZXR1cm4KICAqIH0KICAqIGNvbnNvbGUubG9nKHRhYmxlcykgLy8gW3sgbmFtZXNwYWNlOiBbJ2RlZmF1bHQnXSwgbmFtZTogJ2V2ZW50cycgfV0KICAqIGBgYAogICoKICAqIEBleGFtcGxlIFdvcmtpbmcgd2l0aCBuYW1lc3BhY2VzCiAgKiBgYGBqcwogICogY29uc3QgY2F0YWxvZyA9IHN1cGFiYXNlLnN0b3JhZ2UuYW5hbHl0aWNzLmZyb20oJ2FuYWx5dGljcy1kYXRhJykKICAqCiAgKiAvLyBMaXN0IGFsbCBuYW1lc3BhY2VzCiAgKiBjb25zdCB7IGRhdGE6IG5hbWVzcGFjZXMgfSA9IGF3YWl0IGNhdGFsb2cubGlzdE5hbWVzcGFjZXMoKQogICoKICAqIC8vIENyZWF0ZSBuYW1lc3BhY2Ugd2l0aCBwcm9wZXJ0aWVzCiAgKiBhd2FpdCBjYXRhbG9nLmNyZWF0ZU5hbWVzcGFjZSgKICAqICAgeyBuYW1lc3BhY2U6IFsncHJvZHVjdGlvbiddIH0sCiAgKiAgIHsgcHJvcGVydGllczogeyBvd25lcjogJ2RhdGEtdGVhbScsIGVudjogJ3Byb2QnIH0gfQogICogKQogICogYGBgCiAgKgogICogQGV4YW1wbGUgQ2xlYW51cCBvcGVyYXRpb25zCiAgKiBgYGBqcwogICogY29uc3QgY2F0YWxvZyA9IHN1cGFiYXNlLnN0b3JhZ2UuYW5hbHl0aWNzLmZyb20oJ2FuYWx5dGljcy1kYXRhJykKICAqCiAgKiAvLyBEcm9wIHRhYmxlIHdpdGggcHVyZ2Ugb3B0aW9uIChyZW1vdmVzIGFsbCBkYXRhKQogICogY29uc3QgeyBlcnJvcjogZHJvcEVycm9yIH0gPSBhd2FpdCBjYXRhbG9nLmRyb3BUYWJsZSgKICAqICAgeyBuYW1lc3BhY2U6IFsnZGVmYXVsdCddLCBuYW1lOiAnZXZlbnRzJyB9LAogICogICB7IHB1cmdlOiB0cnVlIH0KICAqICkKICAqCiAgKiBpZiAoZHJvcEVycm9yPy5pc05vdEZvdW5kKCkpIHsKICAqICAgY29uc29sZS5sb2coJ1RhYmxlIGRvZXMgbm90IGV4aXN0JykKICAqIH0KICAqCiAgKiAvLyBEcm9wIG5hbWVzcGFjZSAobXVzdCBiZSBlbXB0eSkKICAqIGF3YWl0IGNhdGFsb2cuZHJvcE5hbWVzcGFjZSh7IG5hbWVzcGFjZTogWydkZWZhdWx0J10gfSkKICAqIGBgYAogICoKICAqIEByZW1hcmtzCiAgKiBUaGlzIG1ldGhvZCBwcm92aWRlcyBhIGJyaWRnZSBiZXR3ZWVuIFN1cGFiYXNlJ3MgYnVja2V0IG1hbmFnZW1lbnQgYW5kIHRoZSBzdGFuZGFyZAogICogQXBhY2hlIEljZWJlcmcgUkVTVCBDYXRhbG9nIEFQSS4gVGhlIGJ1Y2tldCBuYW1lIG1hcHMgdG8gdGhlIEljZWJlcmcgd2FyZWhvdXNlIHBhcmFtZXRlci4KICAqIEFsbCBhdXRoZW50aWNhdGlvbiBhbmQgY29uZmlndXJhdGlvbiBpcyBoYW5kbGVkIGF1dG9tYXRpY2FsbHkgdXNpbmcgeW91ciBTdXBhYmFzZSBjcmVkZW50aWFscy4KICAqCiAgKiAqKkVycm9yIEhhbmRsaW5nKio6IEludmFsaWQgYnVja2V0IG5hbWVzIHRocm93IGltbWVkaWF0ZWx5LiBBbGwgY2F0YWxvZwogICogb3BlcmF0aW9ucyByZXR1cm4gYHsgZGF0YSwgZXJyb3IgfWAgd2hlcmUgZXJyb3JzIGFyZSBgSWNlYmVyZ0Vycm9yYCBpbnN0YW5jZXMgZnJvbSBpY2ViZXJnLWpzLgogICogVXNlIGhlbHBlciBtZXRob2RzIGxpa2UgYGVycm9yLmlzTm90Rm91bmQoKWAgb3IgY2hlY2sgYGVycm9yLnN0YXR1c2AgZm9yIHNwZWNpZmljIGVycm9yIGhhbmRsaW5nLgogICogVXNlIGAudGhyb3dPbkVycm9yKClgIG9uIHRoZSBhbmFseXRpY3MgY2xpZW50IGlmIHlvdSBwcmVmZXIgZXhjZXB0aW9ucyBmb3IgY2F0YWxvZyBvcGVyYXRpb25zLgogICoKICAqICoqQ2xlYW51cCBPcGVyYXRpb25zKio6IFdoZW4gdXNpbmcgYGRyb3BUYWJsZWAsIHRoZSBgcHVyZ2U6IHRydWVgIG9wdGlvbiBwZXJtYW5lbnRseQogICogZGVsZXRlcyBhbGwgdGFibGUgZGF0YS4gV2l0aG91dCBpdCwgdGhlIHRhYmxlIGlzIG1hcmtlZCBhcyBkZWxldGVkIGJ1dCBkYXRhIHJlbWFpbnMuCiAgKgogICogKipMaWJyYXJ5IERlcGVuZGVuY3kqKjogVGhlIHJldHVybmVkIGNhdGFsb2cgd3JhcHMgYEljZWJlcmdSZXN0Q2F0YWxvZ2AgZnJvbSBpY2ViZXJnLWpzLgogICogRm9yIGNvbXBsZXRlIEFQSSBkb2N1bWVudGF0aW9uIGFuZCBhZHZhbmNlZCB1c2FnZSwgcmVmZXIgdG8gdGhlCiAgKiBbaWNlYmVyZy1qcyBkb2N1bWVudGF0aW9uXShodHRwczovL3N1cGFiYXNlLmdpdGh1Yi5pby9pY2ViZXJnLWpzLykuCiAgKi8KICBmcm9tKGJ1Y2tldE5hbWUpIHsKICAgIHZhciBfdGhpczQgPSB0aGlzOwogICAgaWYgKCFpc1ZhbGlkQnVja2V0TmFtZShidWNrZXROYW1lKSkgdGhyb3cgbmV3IFN0b3JhZ2VFcnJvcigiSW52YWxpZCBidWNrZXQgbmFtZTogRmlsZSwgZm9sZGVyLCBhbmQgYnVja2V0IG5hbWVzIG11c3QgZm9sbG93IEFXUyBvYmplY3Qga2V5IG5hbWluZyBndWlkZWxpbmVzIGFuZCBzaG91bGQgYXZvaWQgdGhlIHVzZSBvZiBhbnkgb3RoZXIgY2hhcmFjdGVycy4iKTsKICAgIGNvbnN0IGNhdGFsb2cgPSBuZXcgSWNlYmVyZ1Jlc3RDYXRhbG9nKHsKICAgICAgYmFzZVVybDogdGhpcy51cmwsCiAgICAgIGNhdGFsb2dOYW1lOiBidWNrZXROYW1lLAogICAgICBhdXRoOiB7CiAgICAgICAgdHlwZTogImN1c3RvbSIsCiAgICAgICAgZ2V0SGVhZGVyczogYXN5bmMgKCkgPT4gX3RoaXM0LmhlYWRlcnMKICAgICAgfSwKICAgICAgZmV0Y2g6IHRoaXMuZmV0Y2gKICAgIH0pOwogICAgY29uc3Qgc2hvdWxkVGhyb3dPbkVycm9yID0gdGhpcy5zaG91bGRUaHJvd09uRXJyb3I7CiAgICByZXR1cm4gbmV3IFByb3h5KGNhdGFsb2csIHsgZ2V0KHRhcmdldCwgcHJvcCkgewogICAgICBjb25zdCB2YWx1ZSA9IHRhcmdldFtwcm9wXTsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gImZ1bmN0aW9uIikgcmV0dXJuIHZhbHVlOwogICAgICByZXR1cm4gYXN5bmMgKC4uLmFyZ3MpID0+IHsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZGF0YTogYXdhaXQgdmFsdWUuYXBwbHkodGFyZ2V0LCBhcmdzKSwKICAgICAgICAgICAgZXJyb3I6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgIGlmIChzaG91bGRUaHJvd09uRXJyb3IpIHRocm93IGVycm9yOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICAgICAgZXJyb3IKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9OwogICAgfSB9KTsKICB9Cn07CnZhciBWZWN0b3JJbmRleEFwaSA9IGNsYXNzIGV4dGVuZHMgQmFzZUFwaUNsaWVudCB7CiAgLyoqIENyZWF0ZXMgYSBuZXcgVmVjdG9ySW5kZXhBcGkgaW5zdGFuY2UgKi8KICBjb25zdHJ1Y3Rvcih1cmwsIGhlYWRlcnMgPSB7fSwgZmV0Y2gkMSkgewogICAgY29uc3QgZmluYWxVcmwgPSB1cmwucmVwbGFjZSgvXC8kLywgIiIpOwogICAgY29uc3QgZmluYWxIZWFkZXJzID0gX29iamVjdFNwcmVhZDIxMShfb2JqZWN0U3ByZWFkMjExKHt9LCBERUZBVUxUX0hFQURFUlMpLCB7fSwgeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sIGhlYWRlcnMpOwogICAgc3VwZXIoZmluYWxVcmwsIGZpbmFsSGVhZGVycywgZmV0Y2gkMSwgInZlY3RvcnMiKTsKICB9CiAgLyoqIENyZWF0ZXMgYSBuZXcgdmVjdG9yIGluZGV4IHdpdGhpbiBhIGJ1Y2tldCAqLwogIGFzeW5jIGNyZWF0ZUluZGV4KG9wdGlvbnMpIHsKICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXMuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHZlY3RvcnNBcGkucG9zdChfdGhpcy5mZXRjaCwgYCR7X3RoaXMudXJsfS9DcmVhdGVJbmRleGAsIG9wdGlvbnMsIHsgaGVhZGVyczogX3RoaXMuaGVhZGVycyB9KSB8fCB7fTsKICAgIH0pOwogIH0KICAvKiogUmV0cmlldmVzIG1ldGFkYXRhIGZvciBhIHNwZWNpZmljIHZlY3RvciBpbmRleCAqLwogIGFzeW5jIGdldEluZGV4KHZlY3RvckJ1Y2tldE5hbWUsIGluZGV4TmFtZSkgewogICAgdmFyIF90aGlzMiA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXMyLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB2ZWN0b3JzQXBpLnBvc3QoX3RoaXMyLmZldGNoLCBgJHtfdGhpczIudXJsfS9HZXRJbmRleGAsIHsKICAgICAgICB2ZWN0b3JCdWNrZXROYW1lLAogICAgICAgIGluZGV4TmFtZQogICAgICB9LCB7IGhlYWRlcnM6IF90aGlzMi5oZWFkZXJzIH0pOwogICAgfSk7CiAgfQogIC8qKiBMaXN0cyB2ZWN0b3IgaW5kZXhlcyB3aXRoaW4gYSBidWNrZXQgd2l0aCBvcHRpb25hbCBmaWx0ZXJpbmcgYW5kIHBhZ2luYXRpb24gKi8KICBhc3luYyBsaXN0SW5kZXhlcyhvcHRpb25zKSB7CiAgICB2YXIgX3RoaXMzID0gdGhpczsKICAgIHJldHVybiBfdGhpczMuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHZlY3RvcnNBcGkucG9zdChfdGhpczMuZmV0Y2gsIGAke190aGlzMy51cmx9L0xpc3RJbmRleGVzYCwgb3B0aW9ucywgeyBoZWFkZXJzOiBfdGhpczMuaGVhZGVycyB9KTsKICAgIH0pOwogIH0KICAvKiogRGVsZXRlcyBhIHZlY3RvciBpbmRleCBhbmQgYWxsIGl0cyBkYXRhICovCiAgYXN5bmMgZGVsZXRlSW5kZXgodmVjdG9yQnVja2V0TmFtZSwgaW5kZXhOYW1lKSB7CiAgICB2YXIgX3RoaXM0ID0gdGhpczsKICAgIHJldHVybiBfdGhpczQuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHZlY3RvcnNBcGkucG9zdChfdGhpczQuZmV0Y2gsIGAke190aGlzNC51cmx9L0RlbGV0ZUluZGV4YCwgewogICAgICAgIHZlY3RvckJ1Y2tldE5hbWUsCiAgICAgICAgaW5kZXhOYW1lCiAgICAgIH0sIHsgaGVhZGVyczogX3RoaXM0LmhlYWRlcnMgfSkgfHwge307CiAgICB9KTsKICB9Cn07CnZhciBWZWN0b3JEYXRhQXBpID0gY2xhc3MgZXh0ZW5kcyBCYXNlQXBpQ2xpZW50IHsKICAvKiogQ3JlYXRlcyBhIG5ldyBWZWN0b3JEYXRhQXBpIGluc3RhbmNlICovCiAgY29uc3RydWN0b3IodXJsLCBoZWFkZXJzID0ge30sIGZldGNoJDEpIHsKICAgIGNvbnN0IGZpbmFsVXJsID0gdXJsLnJlcGxhY2UoL1wvJC8sICIiKTsKICAgIGNvbnN0IGZpbmFsSGVhZGVycyA9IF9vYmplY3RTcHJlYWQyMTEoX29iamVjdFNwcmVhZDIxMSh7fSwgREVGQVVMVF9IRUFERVJTKSwge30sIHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LCBoZWFkZXJzKTsKICAgIHN1cGVyKGZpbmFsVXJsLCBmaW5hbEhlYWRlcnMsIGZldGNoJDEsICJ2ZWN0b3JzIik7CiAgfQogIC8qKiBJbnNlcnRzIG9yIHVwZGF0ZXMgdmVjdG9ycyBpbiBiYXRjaCAoMS01MDAgcGVyIHJlcXVlc3QpICovCiAgYXN5bmMgcHV0VmVjdG9ycyhvcHRpb25zKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgaWYgKG9wdGlvbnMudmVjdG9ycy5sZW5ndGggPCAxIHx8IG9wdGlvbnMudmVjdG9ycy5sZW5ndGggPiA1MDApIHRocm93IG5ldyBFcnJvcigiVmVjdG9yIGJhdGNoIHNpemUgbXVzdCBiZSBiZXR3ZWVuIDEgYW5kIDUwMCBpdGVtcyIpOwogICAgcmV0dXJuIF90aGlzLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB2ZWN0b3JzQXBpLnBvc3QoX3RoaXMuZmV0Y2gsIGAke190aGlzLnVybH0vUHV0VmVjdG9yc2AsIG9wdGlvbnMsIHsgaGVhZGVyczogX3RoaXMuaGVhZGVycyB9KSB8fCB7fTsKICAgIH0pOwogIH0KICAvKiogUmV0cmlldmVzIHZlY3RvcnMgYnkgdGhlaXIga2V5cyBpbiBiYXRjaCAqLwogIGFzeW5jIGdldFZlY3RvcnMob3B0aW9ucykgewogICAgdmFyIF90aGlzMiA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXMyLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB2ZWN0b3JzQXBpLnBvc3QoX3RoaXMyLmZldGNoLCBgJHtfdGhpczIudXJsfS9HZXRWZWN0b3JzYCwgb3B0aW9ucywgeyBoZWFkZXJzOiBfdGhpczIuaGVhZGVycyB9KTsKICAgIH0pOwogIH0KICAvKiogTGlzdHMgdmVjdG9ycyBpbiBhbiBpbmRleCB3aXRoIHBhZ2luYXRpb24gKi8KICBhc3luYyBsaXN0VmVjdG9ycyhvcHRpb25zKSB7CiAgICB2YXIgX3RoaXMzID0gdGhpczsKICAgIGlmIChvcHRpb25zLnNlZ21lbnRDb3VudCAhPT0gdm9pZCAwKSB7CiAgICAgIGlmIChvcHRpb25zLnNlZ21lbnRDb3VudCA8IDEgfHwgb3B0aW9ucy5zZWdtZW50Q291bnQgPiAxNikgdGhyb3cgbmV3IEVycm9yKCJzZWdtZW50Q291bnQgbXVzdCBiZSBiZXR3ZWVuIDEgYW5kIDE2Iik7CiAgICAgIGlmIChvcHRpb25zLnNlZ21lbnRJbmRleCAhPT0gdm9pZCAwKSB7CiAgICAgICAgaWYgKG9wdGlvbnMuc2VnbWVudEluZGV4IDwgMCB8fCBvcHRpb25zLnNlZ21lbnRJbmRleCA+PSBvcHRpb25zLnNlZ21lbnRDb3VudCkgdGhyb3cgbmV3IEVycm9yKGBzZWdtZW50SW5kZXggbXVzdCBiZSBiZXR3ZWVuIDAgYW5kICR7b3B0aW9ucy5zZWdtZW50Q291bnQgLSAxfWApOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gX3RoaXMzLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB2ZWN0b3JzQXBpLnBvc3QoX3RoaXMzLmZldGNoLCBgJHtfdGhpczMudXJsfS9MaXN0VmVjdG9yc2AsIG9wdGlvbnMsIHsgaGVhZGVyczogX3RoaXMzLmhlYWRlcnMgfSk7CiAgICB9KTsKICB9CiAgLyoqIFF1ZXJpZXMgZm9yIHNpbWlsYXIgdmVjdG9ycyB1c2luZyBhcHByb3hpbWF0ZSBuZWFyZXN0IG5laWdoYm9yIHNlYXJjaCAqLwogIGFzeW5jIHF1ZXJ5VmVjdG9ycyhvcHRpb25zKSB7CiAgICB2YXIgX3RoaXM0ID0gdGhpczsKICAgIHJldHVybiBfdGhpczQuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHZlY3RvcnNBcGkucG9zdChfdGhpczQuZmV0Y2gsIGAke190aGlzNC51cmx9L1F1ZXJ5VmVjdG9yc2AsIG9wdGlvbnMsIHsgaGVhZGVyczogX3RoaXM0LmhlYWRlcnMgfSk7CiAgICB9KTsKICB9CiAgLyoqIERlbGV0ZXMgdmVjdG9ycyBieSB0aGVpciBrZXlzIGluIGJhdGNoICgxLTUwMCBwZXIgcmVxdWVzdCkgKi8KICBhc3luYyBkZWxldGVWZWN0b3JzKG9wdGlvbnMpIHsKICAgIHZhciBfdGhpczUgPSB0aGlzOwogICAgaWYgKG9wdGlvbnMua2V5cy5sZW5ndGggPCAxIHx8IG9wdGlvbnMua2V5cy5sZW5ndGggPiA1MDApIHRocm93IG5ldyBFcnJvcigiS2V5cyBiYXRjaCBzaXplIG11c3QgYmUgYmV0d2VlbiAxIGFuZCA1MDAgaXRlbXMiKTsKICAgIHJldHVybiBfdGhpczUuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHZlY3RvcnNBcGkucG9zdChfdGhpczUuZmV0Y2gsIGAke190aGlzNS51cmx9L0RlbGV0ZVZlY3RvcnNgLCBvcHRpb25zLCB7IGhlYWRlcnM6IF90aGlzNS5oZWFkZXJzIH0pIHx8IHt9OwogICAgfSk7CiAgfQp9Owp2YXIgVmVjdG9yQnVja2V0QXBpID0gY2xhc3MgZXh0ZW5kcyBCYXNlQXBpQ2xpZW50IHsKICAvKiogQ3JlYXRlcyBhIG5ldyBWZWN0b3JCdWNrZXRBcGkgaW5zdGFuY2UgKi8KICBjb25zdHJ1Y3Rvcih1cmwsIGhlYWRlcnMgPSB7fSwgZmV0Y2gkMSkgewogICAgY29uc3QgZmluYWxVcmwgPSB1cmwucmVwbGFjZSgvXC8kLywgIiIpOwogICAgY29uc3QgZmluYWxIZWFkZXJzID0gX29iamVjdFNwcmVhZDIxMShfb2JqZWN0U3ByZWFkMjExKHt9LCBERUZBVUxUX0hFQURFUlMpLCB7fSwgeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sIGhlYWRlcnMpOwogICAgc3VwZXIoZmluYWxVcmwsIGZpbmFsSGVhZGVycywgZmV0Y2gkMSwgInZlY3RvcnMiKTsKICB9CiAgLyoqIENyZWF0ZXMgYSBuZXcgdmVjdG9yIGJ1Y2tldCAqLwogIGFzeW5jIGNyZWF0ZUJ1Y2tldCh2ZWN0b3JCdWNrZXROYW1lKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB2ZWN0b3JzQXBpLnBvc3QoX3RoaXMuZmV0Y2gsIGAke190aGlzLnVybH0vQ3JlYXRlVmVjdG9yQnVja2V0YCwgeyB2ZWN0b3JCdWNrZXROYW1lIH0sIHsgaGVhZGVyczogX3RoaXMuaGVhZGVycyB9KSB8fCB7fTsKICAgIH0pOwogIH0KICAvKiogUmV0cmlldmVzIG1ldGFkYXRhIGZvciBhIHNwZWNpZmljIHZlY3RvciBidWNrZXQgKi8KICBhc3luYyBnZXRCdWNrZXQodmVjdG9yQnVja2V0TmFtZSkgewogICAgdmFyIF90aGlzMiA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXMyLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB2ZWN0b3JzQXBpLnBvc3QoX3RoaXMyLmZldGNoLCBgJHtfdGhpczIudXJsfS9HZXRWZWN0b3JCdWNrZXRgLCB7IHZlY3RvckJ1Y2tldE5hbWUgfSwgeyBoZWFkZXJzOiBfdGhpczIuaGVhZGVycyB9KTsKICAgIH0pOwogIH0KICAvKiogTGlzdHMgdmVjdG9yIGJ1Y2tldHMgd2l0aCBvcHRpb25hbCBmaWx0ZXJpbmcgYW5kIHBhZ2luYXRpb24gKi8KICBhc3luYyBsaXN0QnVja2V0cyhvcHRpb25zID0ge30pIHsKICAgIHZhciBfdGhpczMgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzMy5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgdmVjdG9yc0FwaS5wb3N0KF90aGlzMy5mZXRjaCwgYCR7X3RoaXMzLnVybH0vTGlzdFZlY3RvckJ1Y2tldHNgLCBvcHRpb25zLCB7IGhlYWRlcnM6IF90aGlzMy5oZWFkZXJzIH0pOwogICAgfSk7CiAgfQogIC8qKiBEZWxldGVzIGEgdmVjdG9yIGJ1Y2tldCAobXVzdCBiZSBlbXB0eSBmaXJzdCkgKi8KICBhc3luYyBkZWxldGVCdWNrZXQodmVjdG9yQnVja2V0TmFtZSkgewogICAgdmFyIF90aGlzNCA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXM0LmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB2ZWN0b3JzQXBpLnBvc3QoX3RoaXM0LmZldGNoLCBgJHtfdGhpczQudXJsfS9EZWxldGVWZWN0b3JCdWNrZXRgLCB7IHZlY3RvckJ1Y2tldE5hbWUgfSwgeyBoZWFkZXJzOiBfdGhpczQuaGVhZGVycyB9KSB8fCB7fTsKICAgIH0pOwogIH0KfTsKdmFyIFN0b3JhZ2VWZWN0b3JzQ2xpZW50ID0gY2xhc3MgZXh0ZW5kcyBWZWN0b3JCdWNrZXRBcGkgewogIC8qKgogICogQGFscGhhCiAgKgogICogQ3JlYXRlcyBhIFN0b3JhZ2VWZWN0b3JzQ2xpZW50IHRoYXQgY2FuIG1hbmFnZSBidWNrZXRzLCBpbmRleGVzLCBhbmQgdmVjdG9ycy4KICAqCiAgKiAqKlB1YmxpYyBhbHBoYToqKiBUaGlzIEFQSSBpcyBwYXJ0IG9mIGEgcHVibGljIGFscGhhIHJlbGVhc2UgYW5kIG1heSBub3QgYmUgYXZhaWxhYmxlIHRvIHlvdXIgYWNjb3VudCB0eXBlLgogICoKICAqIEBjYXRlZ29yeSBWZWN0b3IgQnVja2V0cwogICogQHBhcmFtIHVybCAtIEJhc2UgVVJMIG9mIHRoZSBTdG9yYWdlIFZlY3RvcnMgUkVTVCBBUEkuCiAgKiBAcGFyYW0gb3B0aW9ucy5oZWFkZXJzIC0gT3B0aW9uYWwgaGVhZGVycyAoZm9yIGV4YW1wbGUgYEF1dGhvcml6YXRpb25gKSBhcHBsaWVkIHRvIGV2ZXJ5IHJlcXVlc3QuCiAgKiBAcGFyYW0gb3B0aW9ucy5mZXRjaCAtIE9wdGlvbmFsIGN1c3RvbSBgZmV0Y2hgIGltcGxlbWVudGF0aW9uIGZvciBub24tYnJvd3NlciBydW50aW1lcy4KICAqCiAgKiBAZXhhbXBsZQogICogYGBgdHlwZXNjcmlwdAogICogY29uc3QgY2xpZW50ID0gbmV3IFN0b3JhZ2VWZWN0b3JzQ2xpZW50KHVybCwgb3B0aW9ucykKICAqIGBgYAogICovCiAgY29uc3RydWN0b3IodXJsLCBvcHRpb25zID0ge30pIHsKICAgIHN1cGVyKHVybCwgb3B0aW9ucy5oZWFkZXJzIHx8IHt9LCBvcHRpb25zLmZldGNoKTsKICB9CiAgLyoqCiAgKgogICogQGFscGhhCiAgKgogICogQWNjZXNzIG9wZXJhdGlvbnMgZm9yIGEgc3BlY2lmaWMgdmVjdG9yIGJ1Y2tldAogICogUmV0dXJucyBhIHNjb3BlZCBjbGllbnQgZm9yIGluZGV4IGFuZCB2ZWN0b3Igb3BlcmF0aW9ucyB3aXRoaW4gdGhlIGJ1Y2tldAogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IFZlY3RvciBCdWNrZXRzCiAgKiBAcGFyYW0gdmVjdG9yQnVja2V0TmFtZSAtIE5hbWUgb2YgdGhlIHZlY3RvciBidWNrZXQKICAqIEByZXR1cm5zIEJ1Y2tldC1zY29wZWQgY2xpZW50IHdpdGggaW5kZXggYW5kIHZlY3RvciBvcGVyYXRpb25zCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGNvbnN0IGJ1Y2tldCA9IHN1cGFiYXNlLnN0b3JhZ2UudmVjdG9ycy5mcm9tKCdlbWJlZGRpbmdzLXByb2QnKQogICogYGBgCiAgKi8KICBmcm9tKHZlY3RvckJ1Y2tldE5hbWUpIHsKICAgIHJldHVybiBuZXcgVmVjdG9yQnVja2V0U2NvcGUodGhpcy51cmwsIHRoaXMuaGVhZGVycywgdmVjdG9yQnVja2V0TmFtZSwgdGhpcy5mZXRjaCk7CiAgfQogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIENyZWF0ZXMgYSBuZXcgdmVjdG9yIGJ1Y2tldAogICogVmVjdG9yIGJ1Y2tldHMgYXJlIGNvbnRhaW5lcnMgZm9yIHZlY3RvciBpbmRleGVzIGFuZCB0aGVpciBkYXRhCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgVmVjdG9yIEJ1Y2tldHMKICAqIEBwYXJhbSB2ZWN0b3JCdWNrZXROYW1lIC0gVW5pcXVlIG5hbWUgZm9yIHRoZSB2ZWN0b3IgYnVja2V0CiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggZW1wdHkgcmVzcG9uc2Ugb24gc3VjY2VzcyBvciBlcnJvcgogICoKICAqIEBleGFtcGxlCiAgKiBgYGB0eXBlc2NyaXB0CiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAudmVjdG9ycwogICogICAuY3JlYXRlQnVja2V0KCdlbWJlZGRpbmdzLXByb2QnKQogICogYGBgCiAgKi8KICBhc3luYyBjcmVhdGVCdWNrZXQodmVjdG9yQnVja2V0TmFtZSkgewogICAgdmFyIF9zdXBlcnByb3BfZ2V0Q3JlYXRlQnVja2V0ID0gKCkgPT4gc3VwZXIuY3JlYXRlQnVja2V0LCBfdGhpcyA9IHRoaXM7CiAgICByZXR1cm4gX3N1cGVycHJvcF9nZXRDcmVhdGVCdWNrZXQoKS5jYWxsKF90aGlzLCB2ZWN0b3JCdWNrZXROYW1lKTsKICB9CiAgLyoqCiAgKgogICogQGFscGhhCiAgKgogICogUmV0cmlldmVzIG1ldGFkYXRhIGZvciBhIHNwZWNpZmljIHZlY3RvciBidWNrZXQKICAqCiAgKiAqKlB1YmxpYyBhbHBoYToqKiBUaGlzIEFQSSBpcyBwYXJ0IG9mIGEgcHVibGljIGFscGhhIHJlbGVhc2UgYW5kIG1heSBub3QgYmUgYXZhaWxhYmxlIHRvIHlvdXIgYWNjb3VudCB0eXBlLgogICoKICAqIEBjYXRlZ29yeSBWZWN0b3IgQnVja2V0cwogICogQHBhcmFtIHZlY3RvckJ1Y2tldE5hbWUgLSBOYW1lIG9mIHRoZSB2ZWN0b3IgYnVja2V0CiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggYnVja2V0IG1ldGFkYXRhIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC52ZWN0b3JzCiAgKiAgIC5nZXRCdWNrZXQoJ2VtYmVkZGluZ3MtcHJvZCcpCiAgKgogICogY29uc29sZS5sb2coJ0J1Y2tldCBjcmVhdGVkOicsIGRhdGE/LnZlY3RvckJ1Y2tldC5jcmVhdGlvblRpbWUpCiAgKiBgYGAKICAqLwogIGFzeW5jIGdldEJ1Y2tldCh2ZWN0b3JCdWNrZXROYW1lKSB7CiAgICB2YXIgX3N1cGVycHJvcF9nZXRHZXRCdWNrZXQgPSAoKSA9PiBzdXBlci5nZXRCdWNrZXQsIF90aGlzMiA9IHRoaXM7CiAgICByZXR1cm4gX3N1cGVycHJvcF9nZXRHZXRCdWNrZXQoKS5jYWxsKF90aGlzMiwgdmVjdG9yQnVja2V0TmFtZSk7CiAgfQogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIExpc3RzIGFsbCB2ZWN0b3IgYnVja2V0cyB3aXRoIG9wdGlvbmFsIGZpbHRlcmluZyBhbmQgcGFnaW5hdGlvbgogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IFZlY3RvciBCdWNrZXRzCiAgKiBAcGFyYW0gb3B0aW9ucyAtIE9wdGlvbmFsIGZpbHRlcnMgKHByZWZpeCwgbWF4UmVzdWx0cywgbmV4dFRva2VuKQogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIGxpc3Qgb2YgYnVja2V0cyBvciBlcnJvcgogICoKICAqIEBleGFtcGxlCiAgKiBgYGB0eXBlc2NyaXB0CiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAudmVjdG9ycwogICogICAubGlzdEJ1Y2tldHMoeyBwcmVmaXg6ICdlbWJlZGRpbmdzLScgfSkKICAqCiAgKiBkYXRhPy52ZWN0b3JCdWNrZXRzLmZvckVhY2goYnVja2V0ID0+IHsKICAqICAgY29uc29sZS5sb2coYnVja2V0LnZlY3RvckJ1Y2tldE5hbWUpCiAgKiB9KQogICogYGBgCiAgKi8KICBhc3luYyBsaXN0QnVja2V0cyhvcHRpb25zID0ge30pIHsKICAgIHZhciBfc3VwZXJwcm9wX2dldExpc3RCdWNrZXRzID0gKCkgPT4gc3VwZXIubGlzdEJ1Y2tldHMsIF90aGlzMyA9IHRoaXM7CiAgICByZXR1cm4gX3N1cGVycHJvcF9nZXRMaXN0QnVja2V0cygpLmNhbGwoX3RoaXMzLCBvcHRpb25zKTsKICB9CiAgLyoqCiAgKgogICogQGFscGhhCiAgKgogICogRGVsZXRlcyBhIHZlY3RvciBidWNrZXQgKGJ1Y2tldCBtdXN0IGJlIGVtcHR5KQogICogQWxsIGluZGV4ZXMgbXVzdCBiZSBkZWxldGVkIGJlZm9yZSBkZWxldGluZyB0aGUgYnVja2V0CiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgVmVjdG9yIEJ1Y2tldHMKICAqIEBwYXJhbSB2ZWN0b3JCdWNrZXROYW1lIC0gTmFtZSBvZiB0aGUgdmVjdG9yIGJ1Y2tldCB0byBkZWxldGUKICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCBlbXB0eSByZXNwb25zZSBvbiBzdWNjZXNzIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC52ZWN0b3JzCiAgKiAgIC5kZWxldGVCdWNrZXQoJ2VtYmVkZGluZ3Mtb2xkJykKICAqIGBgYAogICovCiAgYXN5bmMgZGVsZXRlQnVja2V0KHZlY3RvckJ1Y2tldE5hbWUpIHsKICAgIHZhciBfc3VwZXJwcm9wX2dldERlbGV0ZUJ1Y2tldCA9ICgpID0+IHN1cGVyLmRlbGV0ZUJ1Y2tldCwgX3RoaXM0ID0gdGhpczsKICAgIHJldHVybiBfc3VwZXJwcm9wX2dldERlbGV0ZUJ1Y2tldCgpLmNhbGwoX3RoaXM0LCB2ZWN0b3JCdWNrZXROYW1lKTsKICB9Cn07CnZhciBWZWN0b3JCdWNrZXRTY29wZSA9IGNsYXNzIGV4dGVuZHMgVmVjdG9ySW5kZXhBcGkgewogIC8qKgogICogQGFscGhhCiAgKgogICogQ3JlYXRlcyBhIGhlbHBlciB0aGF0IGF1dG9tYXRpY2FsbHkgc2NvcGVzIGFsbCBpbmRleCBvcGVyYXRpb25zIHRvIHRoZSBwcm92aWRlZCBidWNrZXQuCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgVmVjdG9yIEJ1Y2tldHMKICAqIEBleGFtcGxlCiAgKiBgYGB0eXBlc2NyaXB0CiAgKiBjb25zdCBidWNrZXQgPSBzdXBhYmFzZS5zdG9yYWdlLnZlY3RvcnMuZnJvbSgnZW1iZWRkaW5ncy1wcm9kJykKICAqIGBgYAogICovCiAgY29uc3RydWN0b3IodXJsLCBoZWFkZXJzLCB2ZWN0b3JCdWNrZXROYW1lLCBmZXRjaCQxKSB7CiAgICBzdXBlcih1cmwsIGhlYWRlcnMsIGZldGNoJDEpOwogICAgdGhpcy52ZWN0b3JCdWNrZXROYW1lID0gdmVjdG9yQnVja2V0TmFtZTsKICB9CiAgLyoqCiAgKgogICogQGFscGhhCiAgKgogICogQ3JlYXRlcyBhIG5ldyB2ZWN0b3IgaW5kZXggaW4gdGhpcyBidWNrZXQKICAqIENvbnZlbmllbmNlIG1ldGhvZCB0aGF0IGF1dG9tYXRpY2FsbHkgaW5jbHVkZXMgdGhlIGJ1Y2tldCBuYW1lCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgVmVjdG9yIEJ1Y2tldHMKICAqIEBwYXJhbSBvcHRpb25zIC0gSW5kZXggY29uZmlndXJhdGlvbiAodmVjdG9yQnVja2V0TmFtZSBpcyBhdXRvbWF0aWNhbGx5IHNldCkKICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCBlbXB0eSByZXNwb25zZSBvbiBzdWNjZXNzIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGNvbnN0IGJ1Y2tldCA9IHN1cGFiYXNlLnN0b3JhZ2UudmVjdG9ycy5mcm9tKCdlbWJlZGRpbmdzLXByb2QnKQogICogYXdhaXQgYnVja2V0LmNyZWF0ZUluZGV4KHsKICAqICAgaW5kZXhOYW1lOiAnZG9jdW1lbnRzLW9wZW5haScsCiAgKiAgIGRhdGFUeXBlOiAnZmxvYXQzMicsCiAgKiAgIGRpbWVuc2lvbjogMTUzNiwKICAqICAgZGlzdGFuY2VNZXRyaWM6ICdjb3NpbmUnLAogICogICBtZXRhZGF0YUNvbmZpZ3VyYXRpb246IHsKICAqICAgICBub25GaWx0ZXJhYmxlTWV0YWRhdGFLZXlzOiBbJ3Jhd190ZXh0J10KICAqICAgfQogICogfSkKICAqIGBgYAogICovCiAgYXN5bmMgY3JlYXRlSW5kZXgob3B0aW9ucykgewogICAgdmFyIF9zdXBlcnByb3BfZ2V0Q3JlYXRlSW5kZXggPSAoKSA9PiBzdXBlci5jcmVhdGVJbmRleCwgX3RoaXM1ID0gdGhpczsKICAgIHJldHVybiBfc3VwZXJwcm9wX2dldENyZWF0ZUluZGV4KCkuY2FsbChfdGhpczUsIF9vYmplY3RTcHJlYWQyMTEoX29iamVjdFNwcmVhZDIxMSh7fSwgb3B0aW9ucyksIHt9LCB7IHZlY3RvckJ1Y2tldE5hbWU6IF90aGlzNS52ZWN0b3JCdWNrZXROYW1lIH0pKTsKICB9CiAgLyoqCiAgKgogICogQGFscGhhCiAgKgogICogTGlzdHMgaW5kZXhlcyBpbiB0aGlzIGJ1Y2tldAogICogQ29udmVuaWVuY2UgbWV0aG9kIHRoYXQgYXV0b21hdGljYWxseSBpbmNsdWRlcyB0aGUgYnVja2V0IG5hbWUKICAqCiAgKiAqKlB1YmxpYyBhbHBoYToqKiBUaGlzIEFQSSBpcyBwYXJ0IG9mIGEgcHVibGljIGFscGhhIHJlbGVhc2UgYW5kIG1heSBub3QgYmUgYXZhaWxhYmxlIHRvIHlvdXIgYWNjb3VudCB0eXBlLgogICoKICAqIEBjYXRlZ29yeSBWZWN0b3IgQnVja2V0cwogICogQHBhcmFtIG9wdGlvbnMgLSBMaXN0aW5nIG9wdGlvbnMgKHZlY3RvckJ1Y2tldE5hbWUgaXMgYXV0b21hdGljYWxseSBzZXQpCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBpbmRleGVzIGFycmF5IGFuZCBwYWdpbmF0aW9uIHRva2VuIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGNvbnN0IGJ1Y2tldCA9IHN1cGFiYXNlLnN0b3JhZ2UudmVjdG9ycy5mcm9tKCdlbWJlZGRpbmdzLXByb2QnKQogICogY29uc3QgeyBkYXRhIH0gPSBhd2FpdCBidWNrZXQubGlzdEluZGV4ZXMoeyBwcmVmaXg6ICdkb2N1bWVudHMtJyB9KQogICogYGBgCiAgKi8KICBhc3luYyBsaXN0SW5kZXhlcyhvcHRpb25zID0ge30pIHsKICAgIHZhciBfc3VwZXJwcm9wX2dldExpc3RJbmRleGVzID0gKCkgPT4gc3VwZXIubGlzdEluZGV4ZXMsIF90aGlzNiA9IHRoaXM7CiAgICByZXR1cm4gX3N1cGVycHJvcF9nZXRMaXN0SW5kZXhlcygpLmNhbGwoX3RoaXM2LCBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIG9wdGlvbnMpLCB7fSwgeyB2ZWN0b3JCdWNrZXROYW1lOiBfdGhpczYudmVjdG9yQnVja2V0TmFtZSB9KSk7CiAgfQogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIFJldHJpZXZlcyBtZXRhZGF0YSBmb3IgYSBzcGVjaWZpYyBpbmRleCBpbiB0aGlzIGJ1Y2tldAogICogQ29udmVuaWVuY2UgbWV0aG9kIHRoYXQgYXV0b21hdGljYWxseSBpbmNsdWRlcyB0aGUgYnVja2V0IG5hbWUKICAqCiAgKiAqKlB1YmxpYyBhbHBoYToqKiBUaGlzIEFQSSBpcyBwYXJ0IG9mIGEgcHVibGljIGFscGhhIHJlbGVhc2UgYW5kIG1heSBub3QgYmUgYXZhaWxhYmxlIHRvIHlvdXIgYWNjb3VudCB0eXBlLgogICoKICAqIEBjYXRlZ29yeSBWZWN0b3IgQnVja2V0cwogICogQHBhcmFtIGluZGV4TmFtZSAtIE5hbWUgb2YgdGhlIGluZGV4IHRvIHJldHJpZXZlCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggaW5kZXggbWV0YWRhdGEgb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZQogICogYGBgdHlwZXNjcmlwdAogICogY29uc3QgYnVja2V0ID0gc3VwYWJhc2Uuc3RvcmFnZS52ZWN0b3JzLmZyb20oJ2VtYmVkZGluZ3MtcHJvZCcpCiAgKiBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IGJ1Y2tldC5nZXRJbmRleCgnZG9jdW1lbnRzLW9wZW5haScpCiAgKiBjb25zb2xlLmxvZygnRGltZW5zaW9uOicsIGRhdGE/LmluZGV4LmRpbWVuc2lvbikKICAqIGBgYAogICovCiAgYXN5bmMgZ2V0SW5kZXgoaW5kZXhOYW1lKSB7CiAgICB2YXIgX3N1cGVycHJvcF9nZXRHZXRJbmRleCA9ICgpID0+IHN1cGVyLmdldEluZGV4LCBfdGhpczcgPSB0aGlzOwogICAgcmV0dXJuIF9zdXBlcnByb3BfZ2V0R2V0SW5kZXgoKS5jYWxsKF90aGlzNywgX3RoaXM3LnZlY3RvckJ1Y2tldE5hbWUsIGluZGV4TmFtZSk7CiAgfQogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIERlbGV0ZXMgYW4gaW5kZXggZnJvbSB0aGlzIGJ1Y2tldAogICogQ29udmVuaWVuY2UgbWV0aG9kIHRoYXQgYXV0b21hdGljYWxseSBpbmNsdWRlcyB0aGUgYnVja2V0IG5hbWUKICAqCiAgKiAqKlB1YmxpYyBhbHBoYToqKiBUaGlzIEFQSSBpcyBwYXJ0IG9mIGEgcHVibGljIGFscGhhIHJlbGVhc2UgYW5kIG1heSBub3QgYmUgYXZhaWxhYmxlIHRvIHlvdXIgYWNjb3VudCB0eXBlLgogICoKICAqIEBjYXRlZ29yeSBWZWN0b3IgQnVja2V0cwogICogQHBhcmFtIGluZGV4TmFtZSAtIE5hbWUgb2YgdGhlIGluZGV4IHRvIGRlbGV0ZQogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIGVtcHR5IHJlc3BvbnNlIG9uIHN1Y2Nlc3Mgb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZQogICogYGBgdHlwZXNjcmlwdAogICogY29uc3QgYnVja2V0ID0gc3VwYWJhc2Uuc3RvcmFnZS52ZWN0b3JzLmZyb20oJ2VtYmVkZGluZ3MtcHJvZCcpCiAgKiBhd2FpdCBidWNrZXQuZGVsZXRlSW5kZXgoJ29sZC1pbmRleCcpCiAgKiBgYGAKICAqLwogIGFzeW5jIGRlbGV0ZUluZGV4KGluZGV4TmFtZSkgewogICAgdmFyIF9zdXBlcnByb3BfZ2V0RGVsZXRlSW5kZXggPSAoKSA9PiBzdXBlci5kZWxldGVJbmRleCwgX3RoaXM4ID0gdGhpczsKICAgIHJldHVybiBfc3VwZXJwcm9wX2dldERlbGV0ZUluZGV4KCkuY2FsbChfdGhpczgsIF90aGlzOC52ZWN0b3JCdWNrZXROYW1lLCBpbmRleE5hbWUpOwogIH0KICAvKioKICAqCiAgKiBAYWxwaGEKICAqCiAgKiBBY2Nlc3Mgb3BlcmF0aW9ucyBmb3IgYSBzcGVjaWZpYyBpbmRleCB3aXRoaW4gdGhpcyBidWNrZXQKICAqIFJldHVybnMgYSBzY29wZWQgY2xpZW50IGZvciB2ZWN0b3IgZGF0YSBvcGVyYXRpb25zCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgVmVjdG9yIEJ1Y2tldHMKICAqIEBwYXJhbSBpbmRleE5hbWUgLSBOYW1lIG9mIHRoZSBpbmRleAogICogQHJldHVybnMgSW5kZXgtc2NvcGVkIGNsaWVudCB3aXRoIHZlY3RvciBkYXRhIG9wZXJhdGlvbnMKICAqCiAgKiBAZXhhbXBsZQogICogYGBgdHlwZXNjcmlwdAogICogY29uc3QgaW5kZXggPSBzdXBhYmFzZS5zdG9yYWdlLnZlY3RvcnMuZnJvbSgnZW1iZWRkaW5ncy1wcm9kJykuaW5kZXgoJ2RvY3VtZW50cy1vcGVuYWknKQogICoKICAqIC8vIEluc2VydCB2ZWN0b3JzCiAgKiBhd2FpdCBpbmRleC5wdXRWZWN0b3JzKHsKICAqICAgdmVjdG9yczogWwogICogICAgIHsga2V5OiAnZG9jLTEnLCBkYXRhOiB7IGZsb2F0MzI6IFsuLi5dIH0sIG1ldGFkYXRhOiB7IHRpdGxlOiAnSW50cm8nIH0gfQogICogICBdCiAgKiB9KQogICoKICAqIC8vIFF1ZXJ5IHNpbWlsYXIgdmVjdG9ycwogICogY29uc3QgeyBkYXRhIH0gPSBhd2FpdCBpbmRleC5xdWVyeVZlY3RvcnMoewogICogICBxdWVyeVZlY3RvcjogeyBmbG9hdDMyOiBbLi4uXSB9LAogICogICB0b3BLOiA1CiAgKiB9KQogICogYGBgCiAgKi8KICBpbmRleChpbmRleE5hbWUpIHsKICAgIHJldHVybiBuZXcgVmVjdG9ySW5kZXhTY29wZSh0aGlzLnVybCwgdGhpcy5oZWFkZXJzLCB0aGlzLnZlY3RvckJ1Y2tldE5hbWUsIGluZGV4TmFtZSwgdGhpcy5mZXRjaCk7CiAgfQp9Owp2YXIgVmVjdG9ySW5kZXhTY29wZSA9IGNsYXNzIGV4dGVuZHMgVmVjdG9yRGF0YUFwaSB7CiAgLyoqCiAgKgogICogQGFscGhhCiAgKgogICogQ3JlYXRlcyBhIGhlbHBlciB0aGF0IGF1dG9tYXRpY2FsbHkgc2NvcGVzIGFsbCB2ZWN0b3Igb3BlcmF0aW9ucyB0byB0aGUgcHJvdmlkZWQgYnVja2V0L2luZGV4IG5hbWVzLgogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IFZlY3RvciBCdWNrZXRzCiAgKiBAZXhhbXBsZQogICogYGBgdHlwZXNjcmlwdAogICogY29uc3QgaW5kZXggPSBzdXBhYmFzZS5zdG9yYWdlLnZlY3RvcnMuZnJvbSgnZW1iZWRkaW5ncy1wcm9kJykuaW5kZXgoJ2RvY3VtZW50cy1vcGVuYWknKQogICogYGBgCiAgKi8KICBjb25zdHJ1Y3Rvcih1cmwsIGhlYWRlcnMsIHZlY3RvckJ1Y2tldE5hbWUsIGluZGV4TmFtZSwgZmV0Y2gkMSkgewogICAgc3VwZXIodXJsLCBoZWFkZXJzLCBmZXRjaCQxKTsKICAgIHRoaXMudmVjdG9yQnVja2V0TmFtZSA9IHZlY3RvckJ1Y2tldE5hbWU7CiAgICB0aGlzLmluZGV4TmFtZSA9IGluZGV4TmFtZTsKICB9CiAgLyoqCiAgKgogICogQGFscGhhCiAgKgogICogSW5zZXJ0cyBvciB1cGRhdGVzIHZlY3RvcnMgaW4gdGhpcyBpbmRleAogICogQ29udmVuaWVuY2UgbWV0aG9kIHRoYXQgYXV0b21hdGljYWxseSBpbmNsdWRlcyBidWNrZXQgYW5kIGluZGV4IG5hbWVzCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgVmVjdG9yIEJ1Y2tldHMKICAqIEBwYXJhbSBvcHRpb25zIC0gVmVjdG9yIGluc2VydGlvbiBvcHRpb25zIChidWNrZXQgYW5kIGluZGV4IG5hbWVzIGF1dG9tYXRpY2FsbHkgc2V0KQogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIGVtcHR5IHJlc3BvbnNlIG9uIHN1Y2Nlc3Mgb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZQogICogYGBgdHlwZXNjcmlwdAogICogY29uc3QgaW5kZXggPSBzdXBhYmFzZS5zdG9yYWdlLnZlY3RvcnMuZnJvbSgnZW1iZWRkaW5ncy1wcm9kJykuaW5kZXgoJ2RvY3VtZW50cy1vcGVuYWknKQogICogYXdhaXQgaW5kZXgucHV0VmVjdG9ycyh7CiAgKiAgIHZlY3RvcnM6IFsKICAqICAgICB7CiAgKiAgICAgICBrZXk6ICdkb2MtMScsCiAgKiAgICAgICBkYXRhOiB7IGZsb2F0MzI6IFswLjEsIDAuMiwgLi4uXSB9LAogICogICAgICAgbWV0YWRhdGE6IHsgdGl0bGU6ICdJbnRyb2R1Y3Rpb24nLCBwYWdlOiAxIH0KICAqICAgICB9CiAgKiAgIF0KICAqIH0pCiAgKiBgYGAKICAqLwogIGFzeW5jIHB1dFZlY3RvcnMob3B0aW9ucykgewogICAgdmFyIF9zdXBlcnByb3BfZ2V0UHV0VmVjdG9ycyA9ICgpID0+IHN1cGVyLnB1dFZlY3RvcnMsIF90aGlzOSA9IHRoaXM7CiAgICByZXR1cm4gX3N1cGVycHJvcF9nZXRQdXRWZWN0b3JzKCkuY2FsbChfdGhpczksIF9vYmplY3RTcHJlYWQyMTEoX29iamVjdFNwcmVhZDIxMSh7fSwgb3B0aW9ucyksIHt9LCB7CiAgICAgIHZlY3RvckJ1Y2tldE5hbWU6IF90aGlzOS52ZWN0b3JCdWNrZXROYW1lLAogICAgICBpbmRleE5hbWU6IF90aGlzOS5pbmRleE5hbWUKICAgIH0pKTsKICB9CiAgLyoqCiAgKgogICogQGFscGhhCiAgKgogICogUmV0cmlldmVzIHZlY3RvcnMgYnkga2V5cyBmcm9tIHRoaXMgaW5kZXgKICAqIENvbnZlbmllbmNlIG1ldGhvZCB0aGF0IGF1dG9tYXRpY2FsbHkgaW5jbHVkZXMgYnVja2V0IGFuZCBpbmRleCBuYW1lcwogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IFZlY3RvciBCdWNrZXRzCiAgKiBAcGFyYW0gb3B0aW9ucyAtIFZlY3RvciByZXRyaWV2YWwgb3B0aW9ucyAoYnVja2V0IGFuZCBpbmRleCBuYW1lcyBhdXRvbWF0aWNhbGx5IHNldCkKICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIHZlY3RvcnMgYXJyYXkgb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZQogICogYGBgdHlwZXNjcmlwdAogICogY29uc3QgaW5kZXggPSBzdXBhYmFzZS5zdG9yYWdlLnZlY3RvcnMuZnJvbSgnZW1iZWRkaW5ncy1wcm9kJykuaW5kZXgoJ2RvY3VtZW50cy1vcGVuYWknKQogICogY29uc3QgeyBkYXRhIH0gPSBhd2FpdCBpbmRleC5nZXRWZWN0b3JzKHsKICAqICAga2V5czogWydkb2MtMScsICdkb2MtMiddLAogICogICByZXR1cm5NZXRhZGF0YTogdHJ1ZQogICogfSkKICAqIGBgYAogICovCiAgYXN5bmMgZ2V0VmVjdG9ycyhvcHRpb25zKSB7CiAgICB2YXIgX3N1cGVycHJvcF9nZXRHZXRWZWN0b3JzID0gKCkgPT4gc3VwZXIuZ2V0VmVjdG9ycywgX3RoaXMxMCA9IHRoaXM7CiAgICByZXR1cm4gX3N1cGVycHJvcF9nZXRHZXRWZWN0b3JzKCkuY2FsbChfdGhpczEwLCBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIG9wdGlvbnMpLCB7fSwgewogICAgICB2ZWN0b3JCdWNrZXROYW1lOiBfdGhpczEwLnZlY3RvckJ1Y2tldE5hbWUsCiAgICAgIGluZGV4TmFtZTogX3RoaXMxMC5pbmRleE5hbWUKICAgIH0pKTsKICB9CiAgLyoqCiAgKgogICogQGFscGhhCiAgKgogICogTGlzdHMgdmVjdG9ycyBpbiB0aGlzIGluZGV4IHdpdGggcGFnaW5hdGlvbgogICogQ29udmVuaWVuY2UgbWV0aG9kIHRoYXQgYXV0b21hdGljYWxseSBpbmNsdWRlcyBidWNrZXQgYW5kIGluZGV4IG5hbWVzCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgVmVjdG9yIEJ1Y2tldHMKICAqIEBwYXJhbSBvcHRpb25zIC0gTGlzdGluZyBvcHRpb25zIChidWNrZXQgYW5kIGluZGV4IG5hbWVzIGF1dG9tYXRpY2FsbHkgc2V0KQogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIHJlc3BvbnNlIGNvbnRhaW5pbmcgdmVjdG9ycyBhcnJheSBhbmQgcGFnaW5hdGlvbiB0b2tlbiBvciBlcnJvcgogICoKICAqIEBleGFtcGxlCiAgKiBgYGB0eXBlc2NyaXB0CiAgKiBjb25zdCBpbmRleCA9IHN1cGFiYXNlLnN0b3JhZ2UudmVjdG9ycy5mcm9tKCdlbWJlZGRpbmdzLXByb2QnKS5pbmRleCgnZG9jdW1lbnRzLW9wZW5haScpCiAgKiBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IGluZGV4Lmxpc3RWZWN0b3JzKHsKICAqICAgbWF4UmVzdWx0czogNTAwLAogICogICByZXR1cm5NZXRhZGF0YTogdHJ1ZQogICogfSkKICAqIGBgYAogICovCiAgYXN5bmMgbGlzdFZlY3RvcnMob3B0aW9ucyA9IHt9KSB7CiAgICB2YXIgX3N1cGVycHJvcF9nZXRMaXN0VmVjdG9ycyA9ICgpID0+IHN1cGVyLmxpc3RWZWN0b3JzLCBfdGhpczExID0gdGhpczsKICAgIHJldHVybiBfc3VwZXJwcm9wX2dldExpc3RWZWN0b3JzKCkuY2FsbChfdGhpczExLCBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIG9wdGlvbnMpLCB7fSwgewogICAgICB2ZWN0b3JCdWNrZXROYW1lOiBfdGhpczExLnZlY3RvckJ1Y2tldE5hbWUsCiAgICAgIGluZGV4TmFtZTogX3RoaXMxMS5pbmRleE5hbWUKICAgIH0pKTsKICB9CiAgLyoqCiAgKgogICogQGFscGhhCiAgKgogICogUXVlcmllcyBmb3Igc2ltaWxhciB2ZWN0b3JzIGluIHRoaXMgaW5kZXgKICAqIENvbnZlbmllbmNlIG1ldGhvZCB0aGF0IGF1dG9tYXRpY2FsbHkgaW5jbHVkZXMgYnVja2V0IGFuZCBpbmRleCBuYW1lcwogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IFZlY3RvciBCdWNrZXRzCiAgKiBAcGFyYW0gb3B0aW9ucyAtIFF1ZXJ5IG9wdGlvbnMgKGJ1Y2tldCBhbmQgaW5kZXggbmFtZXMgYXV0b21hdGljYWxseSBzZXQpCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBtYXRjaGVzIGFycmF5IG9mIHNpbWlsYXIgdmVjdG9ycyBvcmRlcmVkIGJ5IGRpc3RhbmNlIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGNvbnN0IGluZGV4ID0gc3VwYWJhc2Uuc3RvcmFnZS52ZWN0b3JzLmZyb20oJ2VtYmVkZGluZ3MtcHJvZCcpLmluZGV4KCdkb2N1bWVudHMtb3BlbmFpJykKICAqIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgaW5kZXgucXVlcnlWZWN0b3JzKHsKICAqICAgcXVlcnlWZWN0b3I6IHsgZmxvYXQzMjogWzAuMSwgMC4yLCAuLi5dIH0sCiAgKiAgIHRvcEs6IDUsCiAgKiAgIGZpbHRlcjogeyBjYXRlZ29yeTogJ3RlY2huaWNhbCcgfSwKICAqICAgcmV0dXJuRGlzdGFuY2U6IHRydWUsCiAgKiAgIHJldHVybk1ldGFkYXRhOiB0cnVlCiAgKiB9KQogICogYGBgCiAgKi8KICBhc3luYyBxdWVyeVZlY3RvcnMob3B0aW9ucykgewogICAgdmFyIF9zdXBlcnByb3BfZ2V0UXVlcnlWZWN0b3JzID0gKCkgPT4gc3VwZXIucXVlcnlWZWN0b3JzLCBfdGhpczEyID0gdGhpczsKICAgIHJldHVybiBfc3VwZXJwcm9wX2dldFF1ZXJ5VmVjdG9ycygpLmNhbGwoX3RoaXMxMiwgX29iamVjdFNwcmVhZDIxMShfb2JqZWN0U3ByZWFkMjExKHt9LCBvcHRpb25zKSwge30sIHsKICAgICAgdmVjdG9yQnVja2V0TmFtZTogX3RoaXMxMi52ZWN0b3JCdWNrZXROYW1lLAogICAgICBpbmRleE5hbWU6IF90aGlzMTIuaW5kZXhOYW1lCiAgICB9KSk7CiAgfQogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIERlbGV0ZXMgdmVjdG9ycyBieSBrZXlzIGZyb20gdGhpcyBpbmRleAogICogQ29udmVuaWVuY2UgbWV0aG9kIHRoYXQgYXV0b21hdGljYWxseSBpbmNsdWRlcyBidWNrZXQgYW5kIGluZGV4IG5hbWVzCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgVmVjdG9yIEJ1Y2tldHMKICAqIEBwYXJhbSBvcHRpb25zIC0gRGVsZXRpb24gb3B0aW9ucyAoYnVja2V0IGFuZCBpbmRleCBuYW1lcyBhdXRvbWF0aWNhbGx5IHNldCkKICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCBlbXB0eSByZXNwb25zZSBvbiBzdWNjZXNzIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGNvbnN0IGluZGV4ID0gc3VwYWJhc2Uuc3RvcmFnZS52ZWN0b3JzLmZyb20oJ2VtYmVkZGluZ3MtcHJvZCcpLmluZGV4KCdkb2N1bWVudHMtb3BlbmFpJykKICAqIGF3YWl0IGluZGV4LmRlbGV0ZVZlY3RvcnMoewogICogICBrZXlzOiBbJ2RvYy0xJywgJ2RvYy0yJywgJ2RvYy0zJ10KICAqIH0pCiAgKiBgYGAKICAqLwogIGFzeW5jIGRlbGV0ZVZlY3RvcnMob3B0aW9ucykgewogICAgdmFyIF9zdXBlcnByb3BfZ2V0RGVsZXRlVmVjdG9ycyA9ICgpID0+IHN1cGVyLmRlbGV0ZVZlY3RvcnMsIF90aGlzMTMgPSB0aGlzOwogICAgcmV0dXJuIF9zdXBlcnByb3BfZ2V0RGVsZXRlVmVjdG9ycygpLmNhbGwoX3RoaXMxMywgX29iamVjdFNwcmVhZDIxMShfb2JqZWN0U3ByZWFkMjExKHt9LCBvcHRpb25zKSwge30sIHsKICAgICAgdmVjdG9yQnVja2V0TmFtZTogX3RoaXMxMy52ZWN0b3JCdWNrZXROYW1lLAogICAgICBpbmRleE5hbWU6IF90aGlzMTMuaW5kZXhOYW1lCiAgICB9KSk7CiAgfQp9Owp2YXIgU3RvcmFnZUNsaWVudCA9IGNsYXNzIGV4dGVuZHMgU3RvcmFnZUJ1Y2tldEFwaSB7CiAgLyoqCiAgKiBDcmVhdGVzIGEgY2xpZW50IGZvciBTdG9yYWdlIGJ1Y2tldHMsIGZpbGVzLCBhbmFseXRpY3MsIGFuZCB2ZWN0b3JzLgogICoKICAqIEBjYXRlZ29yeSBGaWxlIEJ1Y2tldHMKICAqIEBleGFtcGxlCiAgKiBgYGB0cwogICogaW1wb3J0IHsgU3RvcmFnZUNsaWVudCB9IGZyb20gJ0BzdXBhYmFzZS9zdG9yYWdlLWpzJwogICoKICAqIGNvbnN0IHN0b3JhZ2UgPSBuZXcgU3RvcmFnZUNsaWVudCgnaHR0cHM6Ly94eXpjb21wYW55LnN1cGFiYXNlLmNvL3N0b3JhZ2UvdjEnLCB7CiAgKiAgIGFwaWtleTogJ3B1YmxpYy1hbm9uLWtleScsCiAgKiB9KQogICogY29uc3QgYXZhdGFycyA9IHN0b3JhZ2UuZnJvbSgnYXZhdGFycycpCiAgKiBgYGAKICAqLwogIGNvbnN0cnVjdG9yKHVybCwgaGVhZGVycyA9IHt9LCBmZXRjaCQxLCBvcHRzKSB7CiAgICBzdXBlcih1cmwsIGhlYWRlcnMsIGZldGNoJDEsIG9wdHMpOwogIH0KICAvKioKICAqIFBlcmZvcm0gZmlsZSBvcGVyYXRpb24gaW4gYSBidWNrZXQuCiAgKgogICogQGNhdGVnb3J5IEZpbGUgQnVja2V0cwogICogQHBhcmFtIGlkIFRoZSBidWNrZXQgaWQgdG8gb3BlcmF0ZSBvbi4KICAqCiAgKiBAZXhhbXBsZQogICogYGBgdHlwZXNjcmlwdAogICogY29uc3QgYXZhdGFycyA9IHN1cGFiYXNlLnN0b3JhZ2UuZnJvbSgnYXZhdGFycycpCiAgKiBgYGAKICAqLwogIGZyb20oaWQpIHsKICAgIHJldHVybiBuZXcgU3RvcmFnZUZpbGVBcGkodGhpcy51cmwsIHRoaXMuaGVhZGVycywgaWQsIHRoaXMuZmV0Y2gpOwogIH0KICAvKioKICAqCiAgKiBAYWxwaGEKICAqCiAgKiBBY2Nlc3MgdmVjdG9yIHN0b3JhZ2Ugb3BlcmF0aW9ucy4KICAqCiAgKiAqKlB1YmxpYyBhbHBoYToqKiBUaGlzIEFQSSBpcyBwYXJ0IG9mIGEgcHVibGljIGFscGhhIHJlbGVhc2UgYW5kIG1heSBub3QgYmUgYXZhaWxhYmxlIHRvIHlvdXIgYWNjb3VudCB0eXBlLgogICoKICAqIEBjYXRlZ29yeSBWZWN0b3IgQnVja2V0cwogICogQHJldHVybnMgQSBTdG9yYWdlVmVjdG9yc0NsaWVudCBpbnN0YW5jZSBjb25maWd1cmVkIHdpdGggdGhlIGN1cnJlbnQgc3RvcmFnZSBzZXR0aW5ncy4KICAqLwogIGdldCB2ZWN0b3JzKCkgewogICAgcmV0dXJuIG5ldyBTdG9yYWdlVmVjdG9yc0NsaWVudCh0aGlzLnVybCArICIvdmVjdG9yIiwgewogICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgIGZldGNoOiB0aGlzLmZldGNoCiAgICB9KTsKICB9CiAgLyoqCiAgKgogICogQGFscGhhCiAgKgogICogQWNjZXNzIGFuYWx5dGljcyBzdG9yYWdlIG9wZXJhdGlvbnMgdXNpbmcgSWNlYmVyZyB0YWJsZXMuCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgQW5hbHl0aWNzIEJ1Y2tldHMKICAqIEByZXR1cm5zIEEgU3RvcmFnZUFuYWx5dGljc0NsaWVudCBpbnN0YW5jZSBjb25maWd1cmVkIHdpdGggdGhlIGN1cnJlbnQgc3RvcmFnZSBzZXR0aW5ncy4KICAqLwogIGdldCBhbmFseXRpY3MoKSB7CiAgICByZXR1cm4gbmV3IFN0b3JhZ2VBbmFseXRpY3NDbGllbnQodGhpcy51cmwgKyAiL2ljZWJlcmciLCB0aGlzLmhlYWRlcnMsIHRoaXMuZmV0Y2gpOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrYXV0aC1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9hdXRoLWpzL2Rpc3QvbW9kdWxlL2xpYi92ZXJzaW9uLmpzCnZhciB2ZXJzaW9uNCA9ICIyLjk3LjAiOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZSthdXRoLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL2F1dGgtanMvZGlzdC9tb2R1bGUvbGliL2NvbnN0YW50cy5qcwp2YXIgQVVUT19SRUZSRVNIX1RJQ0tfRFVSQVRJT05fTVMgPSAzMCAqIDFlMzsKdmFyIEFVVE9fUkVGUkVTSF9USUNLX1RIUkVTSE9MRCA9IDM7CnZhciBFWFBJUllfTUFSR0lOX01TID0gQVVUT19SRUZSRVNIX1RJQ0tfVEhSRVNIT0xEICogQVVUT19SRUZSRVNIX1RJQ0tfRFVSQVRJT05fTVM7CnZhciBHT1RSVUVfVVJMID0gImh0dHA6Ly9sb2NhbGhvc3Q6OTk5OSI7CnZhciBTVE9SQUdFX0tFWSA9ICJzdXBhYmFzZS5hdXRoLnRva2VuIjsKdmFyIERFRkFVTFRfSEVBREVSUzIgPSB7ICJYLUNsaWVudC1JbmZvIjogYGdvdHJ1ZS1qcy8ke3ZlcnNpb240fWAgfTsKdmFyIEFQSV9WRVJTSU9OX0hFQURFUl9OQU1FID0gIlgtU3VwYWJhc2UtQXBpLVZlcnNpb24iOwp2YXIgQVBJX1ZFUlNJT05TID0gewogICIyMDI0LTAxLTAxIjogewogICAgdGltZXN0YW1wOiBEYXRlLnBhcnNlKCIyMDI0LTAxLTAxVDAwOjAwOjAwLjBaIiksCiAgICBuYW1lOiAiMjAyNC0wMS0wMSIKICB9Cn07CnZhciBCQVNFNjRVUkxfUkVHRVggPSAvXihbYS16MC05Xy1dezR9KSooJHxbYS16MC05Xy1dezN9JHxbYS16MC05Xy1dezJ9JCkkL2k7CnZhciBKV0tTX1RUTCA9IDEwICogNjAgKiAxZTM7CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK2F1dGgtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvYXV0aC1qcy9kaXN0L21vZHVsZS9saWIvZXJyb3JzLmpzCnZhciBBdXRoRXJyb3IgPSBjbGFzcyBleHRlbmRzIEVycm9yIHsKICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBzdGF0dXMsIGNvZGUpIHsKICAgIHN1cGVyKG1lc3NhZ2UpOwogICAgdGhpcy5fX2lzQXV0aEVycm9yID0gdHJ1ZTsKICAgIHRoaXMubmFtZSA9ICJBdXRoRXJyb3IiOwogICAgdGhpcy5zdGF0dXMgPSBzdGF0dXM7CiAgICB0aGlzLmNvZGUgPSBjb2RlOwogIH0KfTsKZnVuY3Rpb24gaXNBdXRoRXJyb3IoZXJyb3IpIHsKICByZXR1cm4gdHlwZW9mIGVycm9yID09PSAib2JqZWN0IiAmJiBlcnJvciAhPT0gbnVsbCAmJiAiX19pc0F1dGhFcnJvciIgaW4gZXJyb3I7Cn0KdmFyIEF1dGhBcGlFcnJvciA9IGNsYXNzIGV4dGVuZHMgQXV0aEVycm9yIHsKICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBzdGF0dXMsIGNvZGUpIHsKICAgIHN1cGVyKG1lc3NhZ2UsIHN0YXR1cywgY29kZSk7CiAgICB0aGlzLm5hbWUgPSAiQXV0aEFwaUVycm9yIjsKICAgIHRoaXMuc3RhdHVzID0gc3RhdHVzOwogICAgdGhpcy5jb2RlID0gY29kZTsKICB9Cn07CmZ1bmN0aW9uIGlzQXV0aEFwaUVycm9yKGVycm9yKSB7CiAgcmV0dXJuIGlzQXV0aEVycm9yKGVycm9yKSAmJiBlcnJvci5uYW1lID09PSAiQXV0aEFwaUVycm9yIjsKfQp2YXIgQXV0aFVua25vd25FcnJvciA9IGNsYXNzIGV4dGVuZHMgQXV0aEVycm9yIHsKICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBvcmlnaW5hbEVycm9yKSB7CiAgICBzdXBlcihtZXNzYWdlKTsKICAgIHRoaXMubmFtZSA9ICJBdXRoVW5rbm93bkVycm9yIjsKICAgIHRoaXMub3JpZ2luYWxFcnJvciA9IG9yaWdpbmFsRXJyb3I7CiAgfQp9Owp2YXIgQ3VzdG9tQXV0aEVycm9yID0gY2xhc3MgZXh0ZW5kcyBBdXRoRXJyb3IgewogIGNvbnN0cnVjdG9yKG1lc3NhZ2UsIG5hbWUsIHN0YXR1cywgY29kZSkgewogICAgc3VwZXIobWVzc2FnZSwgc3RhdHVzLCBjb2RlKTsKICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICB0aGlzLnN0YXR1cyA9IHN0YXR1czsKICB9Cn07CnZhciBBdXRoU2Vzc2lvbk1pc3NpbmdFcnJvciA9IGNsYXNzIGV4dGVuZHMgQ3VzdG9tQXV0aEVycm9yIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKCJBdXRoIHNlc3Npb24gbWlzc2luZyEiLCAiQXV0aFNlc3Npb25NaXNzaW5nRXJyb3IiLCA0MDAsIHZvaWQgMCk7CiAgfQp9OwpmdW5jdGlvbiBpc0F1dGhTZXNzaW9uTWlzc2luZ0Vycm9yKGVycm9yKSB7CiAgcmV0dXJuIGlzQXV0aEVycm9yKGVycm9yKSAmJiBlcnJvci5uYW1lID09PSAiQXV0aFNlc3Npb25NaXNzaW5nRXJyb3IiOwp9CnZhciBBdXRoSW52YWxpZFRva2VuUmVzcG9uc2VFcnJvciA9IGNsYXNzIGV4dGVuZHMgQ3VzdG9tQXV0aEVycm9yIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKCJBdXRoIHNlc3Npb24gb3IgdXNlciBtaXNzaW5nIiwgIkF1dGhJbnZhbGlkVG9rZW5SZXNwb25zZUVycm9yIiwgNTAwLCB2b2lkIDApOwogIH0KfTsKdmFyIEF1dGhJbnZhbGlkQ3JlZGVudGlhbHNFcnJvciA9IGNsYXNzIGV4dGVuZHMgQ3VzdG9tQXV0aEVycm9yIHsKICBjb25zdHJ1Y3RvcihtZXNzYWdlKSB7CiAgICBzdXBlcihtZXNzYWdlLCAiQXV0aEludmFsaWRDcmVkZW50aWFsc0Vycm9yIiwgNDAwLCB2b2lkIDApOwogIH0KfTsKdmFyIEF1dGhJbXBsaWNpdEdyYW50UmVkaXJlY3RFcnJvciA9IGNsYXNzIGV4dGVuZHMgQ3VzdG9tQXV0aEVycm9yIHsKICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBkZXRhaWxzID0gbnVsbCkgewogICAgc3VwZXIobWVzc2FnZSwgIkF1dGhJbXBsaWNpdEdyYW50UmVkaXJlY3RFcnJvciIsIDUwMCwgdm9pZCAwKTsKICAgIHRoaXMuZGV0YWlscyA9IG51bGw7CiAgICB0aGlzLmRldGFpbHMgPSBkZXRhaWxzOwogIH0KICB0b0pTT04oKSB7CiAgICByZXR1cm4gewogICAgICBuYW1lOiB0aGlzLm5hbWUsCiAgICAgIG1lc3NhZ2U6IHRoaXMubWVzc2FnZSwKICAgICAgc3RhdHVzOiB0aGlzLnN0YXR1cywKICAgICAgZGV0YWlsczogdGhpcy5kZXRhaWxzCiAgICB9OwogIH0KfTsKZnVuY3Rpb24gaXNBdXRoSW1wbGljaXRHcmFudFJlZGlyZWN0RXJyb3IoZXJyb3IpIHsKICByZXR1cm4gaXNBdXRoRXJyb3IoZXJyb3IpICYmIGVycm9yLm5hbWUgPT09ICJBdXRoSW1wbGljaXRHcmFudFJlZGlyZWN0RXJyb3IiOwp9CnZhciBBdXRoUEtDRUdyYW50Q29kZUV4Y2hhbmdlRXJyb3IgPSBjbGFzcyBleHRlbmRzIEN1c3RvbUF1dGhFcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSwgZGV0YWlscyA9IG51bGwpIHsKICAgIHN1cGVyKG1lc3NhZ2UsICJBdXRoUEtDRUdyYW50Q29kZUV4Y2hhbmdlRXJyb3IiLCA1MDAsIHZvaWQgMCk7CiAgICB0aGlzLmRldGFpbHMgPSBudWxsOwogICAgdGhpcy5kZXRhaWxzID0gZGV0YWlsczsKICB9CiAgdG9KU09OKCkgewogICAgcmV0dXJuIHsKICAgICAgbmFtZTogdGhpcy5uYW1lLAogICAgICBtZXNzYWdlOiB0aGlzLm1lc3NhZ2UsCiAgICAgIHN0YXR1czogdGhpcy5zdGF0dXMsCiAgICAgIGRldGFpbHM6IHRoaXMuZGV0YWlscwogICAgfTsKICB9Cn07CnZhciBBdXRoUEtDRUNvZGVWZXJpZmllck1pc3NpbmdFcnJvciA9IGNsYXNzIGV4dGVuZHMgQ3VzdG9tQXV0aEVycm9yIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKCJQS0NFIGNvZGUgdmVyaWZpZXIgbm90IGZvdW5kIGluIHN0b3JhZ2UuIFRoaXMgY2FuIGhhcHBlbiBpZiB0aGUgYXV0aCBmbG93IHdhcyBpbml0aWF0ZWQgaW4gYSBkaWZmZXJlbnQgYnJvd3NlciBvciBkZXZpY2UsIG9yIGlmIHRoZSBzdG9yYWdlIHdhcyBjbGVhcmVkLiBGb3IgU1NSIGZyYW1ld29ya3MgKE5leHQuanMsIFN2ZWx0ZUtpdCwgZXRjLiksIHVzZSBAc3VwYWJhc2Uvc3NyIG9uIGJvdGggdGhlIHNlcnZlciBhbmQgY2xpZW50IHRvIHN0b3JlIHRoZSBjb2RlIHZlcmlmaWVyIGluIGNvb2tpZXMuIiwgIkF1dGhQS0NFQ29kZVZlcmlmaWVyTWlzc2luZ0Vycm9yIiwgNDAwLCAicGtjZV9jb2RlX3ZlcmlmaWVyX25vdF9mb3VuZCIpOwogIH0KfTsKdmFyIEF1dGhSZXRyeWFibGVGZXRjaEVycm9yID0gY2xhc3MgZXh0ZW5kcyBDdXN0b21BdXRoRXJyb3IgewogIGNvbnN0cnVjdG9yKG1lc3NhZ2UsIHN0YXR1cykgewogICAgc3VwZXIobWVzc2FnZSwgIkF1dGhSZXRyeWFibGVGZXRjaEVycm9yIiwgc3RhdHVzLCB2b2lkIDApOwogIH0KfTsKZnVuY3Rpb24gaXNBdXRoUmV0cnlhYmxlRmV0Y2hFcnJvcihlcnJvcikgewogIHJldHVybiBpc0F1dGhFcnJvcihlcnJvcikgJiYgZXJyb3IubmFtZSA9PT0gIkF1dGhSZXRyeWFibGVGZXRjaEVycm9yIjsKfQp2YXIgQXV0aFdlYWtQYXNzd29yZEVycm9yID0gY2xhc3MgZXh0ZW5kcyBDdXN0b21BdXRoRXJyb3IgewogIGNvbnN0cnVjdG9yKG1lc3NhZ2UsIHN0YXR1cywgcmVhc29ucykgewogICAgc3VwZXIobWVzc2FnZSwgIkF1dGhXZWFrUGFzc3dvcmRFcnJvciIsIHN0YXR1cywgIndlYWtfcGFzc3dvcmQiKTsKICAgIHRoaXMucmVhc29ucyA9IHJlYXNvbnM7CiAgfQp9Owp2YXIgQXV0aEludmFsaWRKd3RFcnJvciA9IGNsYXNzIGV4dGVuZHMgQ3VzdG9tQXV0aEVycm9yIHsKICBjb25zdHJ1Y3RvcihtZXNzYWdlKSB7CiAgICBzdXBlcihtZXNzYWdlLCAiQXV0aEludmFsaWRKd3RFcnJvciIsIDQwMCwgImludmFsaWRfand0Iik7CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZSthdXRoLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL2F1dGgtanMvZGlzdC9tb2R1bGUvbGliL2Jhc2U2NHVybC5qcwp2YXIgVE9fQkFTRTY0VVJMID0gIkFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5LV8iLnNwbGl0KCIiKTsKdmFyIElHTk9SRV9CQVNFNjRVUkwgPSAiIAlcblxyPSIuc3BsaXQoIiIpOwp2YXIgRlJPTV9CQVNFNjRVUkwgPSAoKCkgPT4gewogIGNvbnN0IGNoYXJNYXAgPSBuZXcgQXJyYXkoMTI4KTsKICBmb3IgKGxldCBpID0gMDsgaSA8IGNoYXJNYXAubGVuZ3RoOyBpICs9IDEpIHsKICAgIGNoYXJNYXBbaV0gPSAtMTsKICB9CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBJR05PUkVfQkFTRTY0VVJMLmxlbmd0aDsgaSArPSAxKSB7CiAgICBjaGFyTWFwW0lHTk9SRV9CQVNFNjRVUkxbaV0uY2hhckNvZGVBdCgwKV0gPSAtMjsKICB9CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBUT19CQVNFNjRVUkwubGVuZ3RoOyBpICs9IDEpIHsKICAgIGNoYXJNYXBbVE9fQkFTRTY0VVJMW2ldLmNoYXJDb2RlQXQoMCldID0gaTsKICB9CiAgcmV0dXJuIGNoYXJNYXA7Cn0pKCk7CmZ1bmN0aW9uIGJ5dGVUb0Jhc2U2NFVSTChieXRlLCBzdGF0ZSwgZW1pdCkgewogIGlmIChieXRlICE9PSBudWxsKSB7CiAgICBzdGF0ZS5xdWV1ZSA9IHN0YXRlLnF1ZXVlIDw8IDggfCBieXRlOwogICAgc3RhdGUucXVldWVkQml0cyArPSA4OwogICAgd2hpbGUgKHN0YXRlLnF1ZXVlZEJpdHMgPj0gNikgewogICAgICBjb25zdCBwb3MgPSBzdGF0ZS5xdWV1ZSA+PiBzdGF0ZS5xdWV1ZWRCaXRzIC0gNiAmIDYzOwogICAgICBlbWl0KFRPX0JBU0U2NFVSTFtwb3NdKTsKICAgICAgc3RhdGUucXVldWVkQml0cyAtPSA2OwogICAgfQogIH0gZWxzZSBpZiAoc3RhdGUucXVldWVkQml0cyA+IDApIHsKICAgIHN0YXRlLnF1ZXVlID0gc3RhdGUucXVldWUgPDwgNiAtIHN0YXRlLnF1ZXVlZEJpdHM7CiAgICBzdGF0ZS5xdWV1ZWRCaXRzID0gNjsKICAgIHdoaWxlIChzdGF0ZS5xdWV1ZWRCaXRzID49IDYpIHsKICAgICAgY29uc3QgcG9zID0gc3RhdGUucXVldWUgPj4gc3RhdGUucXVldWVkQml0cyAtIDYgJiA2MzsKICAgICAgZW1pdChUT19CQVNFNjRVUkxbcG9zXSk7CiAgICAgIHN0YXRlLnF1ZXVlZEJpdHMgLT0gNjsKICAgIH0KICB9Cn0KZnVuY3Rpb24gYnl0ZUZyb21CYXNlNjRVUkwoY2hhckNvZGUsIHN0YXRlLCBlbWl0KSB7CiAgY29uc3QgYml0cyA9IEZST01fQkFTRTY0VVJMW2NoYXJDb2RlXTsKICBpZiAoYml0cyA+IC0xKSB7CiAgICBzdGF0ZS5xdWV1ZSA9IHN0YXRlLnF1ZXVlIDw8IDYgfCBiaXRzOwogICAgc3RhdGUucXVldWVkQml0cyArPSA2OwogICAgd2hpbGUgKHN0YXRlLnF1ZXVlZEJpdHMgPj0gOCkgewogICAgICBlbWl0KHN0YXRlLnF1ZXVlID4+IHN0YXRlLnF1ZXVlZEJpdHMgLSA4ICYgMjU1KTsKICAgICAgc3RhdGUucXVldWVkQml0cyAtPSA4OwogICAgfQogIH0gZWxzZSBpZiAoYml0cyA9PT0gLTIpIHsKICAgIHJldHVybjsKICB9IGVsc2UgewogICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIEJhc2U2NC1VUkwgY2hhcmFjdGVyICIke1N0cmluZy5mcm9tQ2hhckNvZGUoY2hhckNvZGUpfSJgKTsKICB9Cn0KZnVuY3Rpb24gc3RyaW5nRnJvbUJhc2U2NFVSTChzdHIpIHsKICBjb25zdCBjb252ID0gW107CiAgY29uc3QgdXRmOEVtaXQgPSAoY29kZXBvaW50KSA9PiB7CiAgICBjb252LnB1c2goU3RyaW5nLmZyb21Db2RlUG9pbnQoY29kZXBvaW50KSk7CiAgfTsKICBjb25zdCB1dGY4U3RhdGUgPSB7CiAgICB1dGY4c2VxOiAwLAogICAgY29kZXBvaW50OiAwCiAgfTsKICBjb25zdCBiNjRTdGF0ZSA9IHsgcXVldWU6IDAsIHF1ZXVlZEJpdHM6IDAgfTsKICBjb25zdCBieXRlRW1pdCA9IChieXRlKSA9PiB7CiAgICBzdHJpbmdGcm9tVVRGOChieXRlLCB1dGY4U3RhdGUsIHV0ZjhFbWl0KTsKICB9OwogIGZvciAobGV0IGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgaSArPSAxKSB7CiAgICBieXRlRnJvbUJhc2U2NFVSTChzdHIuY2hhckNvZGVBdChpKSwgYjY0U3RhdGUsIGJ5dGVFbWl0KTsKICB9CiAgcmV0dXJuIGNvbnYuam9pbigiIik7Cn0KZnVuY3Rpb24gY29kZXBvaW50VG9VVEY4KGNvZGVwb2ludCwgZW1pdCkgewogIGlmIChjb2RlcG9pbnQgPD0gMTI3KSB7CiAgICBlbWl0KGNvZGVwb2ludCk7CiAgICByZXR1cm47CiAgfSBlbHNlIGlmIChjb2RlcG9pbnQgPD0gMjA0NykgewogICAgZW1pdCgxOTIgfCBjb2RlcG9pbnQgPj4gNik7CiAgICBlbWl0KDEyOCB8IGNvZGVwb2ludCAmIDYzKTsKICAgIHJldHVybjsKICB9IGVsc2UgaWYgKGNvZGVwb2ludCA8PSA2NTUzNSkgewogICAgZW1pdCgyMjQgfCBjb2RlcG9pbnQgPj4gMTIpOwogICAgZW1pdCgxMjggfCBjb2RlcG9pbnQgPj4gNiAmIDYzKTsKICAgIGVtaXQoMTI4IHwgY29kZXBvaW50ICYgNjMpOwogICAgcmV0dXJuOwogIH0gZWxzZSBpZiAoY29kZXBvaW50IDw9IDExMTQxMTEpIHsKICAgIGVtaXQoMjQwIHwgY29kZXBvaW50ID4+IDE4KTsKICAgIGVtaXQoMTI4IHwgY29kZXBvaW50ID4+IDEyICYgNjMpOwogICAgZW1pdCgxMjggfCBjb2RlcG9pbnQgPj4gNiAmIDYzKTsKICAgIGVtaXQoMTI4IHwgY29kZXBvaW50ICYgNjMpOwogICAgcmV0dXJuOwogIH0KICB0aHJvdyBuZXcgRXJyb3IoYFVucmVjb2duaXplZCBVbmljb2RlIGNvZGVwb2ludDogJHtjb2RlcG9pbnQudG9TdHJpbmcoMTYpfWApOwp9CmZ1bmN0aW9uIHN0cmluZ1RvVVRGOChzdHIsIGVtaXQpIHsKICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ci5sZW5ndGg7IGkgKz0gMSkgewogICAgbGV0IGNvZGVwb2ludCA9IHN0ci5jaGFyQ29kZUF0KGkpOwogICAgaWYgKGNvZGVwb2ludCA+IDU1Mjk1ICYmIGNvZGVwb2ludCA8PSA1NjMxOSkgewogICAgICBjb25zdCBoaWdoU3Vycm9nYXRlID0gKGNvZGVwb2ludCAtIDU1Mjk2KSAqIDEwMjQgJiA2NTUzNTsKICAgICAgY29uc3QgbG93U3Vycm9nYXRlID0gc3RyLmNoYXJDb2RlQXQoaSArIDEpIC0gNTYzMjAgJiA2NTUzNTsKICAgICAgY29kZXBvaW50ID0gKGxvd1N1cnJvZ2F0ZSB8IGhpZ2hTdXJyb2dhdGUpICsgNjU1MzY7CiAgICAgIGkgKz0gMTsKICAgIH0KICAgIGNvZGVwb2ludFRvVVRGOChjb2RlcG9pbnQsIGVtaXQpOwogIH0KfQpmdW5jdGlvbiBzdHJpbmdGcm9tVVRGOChieXRlLCBzdGF0ZSwgZW1pdCkgewogIGlmIChzdGF0ZS51dGY4c2VxID09PSAwKSB7CiAgICBpZiAoYnl0ZSA8PSAxMjcpIHsKICAgICAgZW1pdChieXRlKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgZm9yIChsZXQgbGVhZGluZ0JpdCA9IDE7IGxlYWRpbmdCaXQgPCA2OyBsZWFkaW5nQml0ICs9IDEpIHsKICAgICAgaWYgKChieXRlID4+IDcgLSBsZWFkaW5nQml0ICYgMSkgPT09IDApIHsKICAgICAgICBzdGF0ZS51dGY4c2VxID0gbGVhZGluZ0JpdDsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgaWYgKHN0YXRlLnV0ZjhzZXEgPT09IDIpIHsKICAgICAgc3RhdGUuY29kZXBvaW50ID0gYnl0ZSAmIDMxOwogICAgfSBlbHNlIGlmIChzdGF0ZS51dGY4c2VxID09PSAzKSB7CiAgICAgIHN0YXRlLmNvZGVwb2ludCA9IGJ5dGUgJiAxNTsKICAgIH0gZWxzZSBpZiAoc3RhdGUudXRmOHNlcSA9PT0gNCkgewogICAgICBzdGF0ZS5jb2RlcG9pbnQgPSBieXRlICYgNzsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBVVEYtOCBzZXF1ZW5jZSIpOwogICAgfQogICAgc3RhdGUudXRmOHNlcSAtPSAxOwogIH0gZWxzZSBpZiAoc3RhdGUudXRmOHNlcSA+IDApIHsKICAgIGlmIChieXRlIDw9IDEyNykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgVVRGLTggc2VxdWVuY2UiKTsKICAgIH0KICAgIHN0YXRlLmNvZGVwb2ludCA9IHN0YXRlLmNvZGVwb2ludCA8PCA2IHwgYnl0ZSAmIDYzOwogICAgc3RhdGUudXRmOHNlcSAtPSAxOwogICAgaWYgKHN0YXRlLnV0ZjhzZXEgPT09IDApIHsKICAgICAgZW1pdChzdGF0ZS5jb2RlcG9pbnQpOwogICAgfQogIH0KfQpmdW5jdGlvbiBiYXNlNjRVcmxUb1VpbnQ4QXJyYXkoc3RyKSB7CiAgY29uc3QgcmVzdWx0ID0gW107CiAgY29uc3Qgc3RhdGUgPSB7IHF1ZXVlOiAwLCBxdWV1ZWRCaXRzOiAwIH07CiAgY29uc3Qgb25CeXRlID0gKGJ5dGUpID0+IHsKICAgIHJlc3VsdC5wdXNoKGJ5dGUpOwogIH07CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyBpICs9IDEpIHsKICAgIGJ5dGVGcm9tQmFzZTY0VVJMKHN0ci5jaGFyQ29kZUF0KGkpLCBzdGF0ZSwgb25CeXRlKTsKICB9CiAgcmV0dXJuIG5ldyBVaW50OEFycmF5KHJlc3VsdCk7Cn0KZnVuY3Rpb24gc3RyaW5nVG9VaW50OEFycmF5KHN0cikgewogIGNvbnN0IHJlc3VsdCA9IFtdOwogIHN0cmluZ1RvVVRGOChzdHIsIChieXRlKSA9PiByZXN1bHQucHVzaChieXRlKSk7CiAgcmV0dXJuIG5ldyBVaW50OEFycmF5KHJlc3VsdCk7Cn0KZnVuY3Rpb24gYnl0ZXNUb0Jhc2U2NFVSTChieXRlcykgewogIGNvbnN0IHJlc3VsdCA9IFtdOwogIGNvbnN0IHN0YXRlID0geyBxdWV1ZTogMCwgcXVldWVkQml0czogMCB9OwogIGNvbnN0IG9uQ2hhciA9IChjaGFyKSA9PiB7CiAgICByZXN1bHQucHVzaChjaGFyKTsKICB9OwogIGJ5dGVzLmZvckVhY2goKGJ5dGUpID0+IGJ5dGVUb0Jhc2U2NFVSTChieXRlLCBzdGF0ZSwgb25DaGFyKSk7CiAgYnl0ZVRvQmFzZTY0VVJMKG51bGwsIHN0YXRlLCBvbkNoYXIpOwogIHJldHVybiByZXN1bHQuam9pbigiIik7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrYXV0aC1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9hdXRoLWpzL2Rpc3QvbW9kdWxlL2xpYi9oZWxwZXJzLmpzCmZ1bmN0aW9uIGV4cGlyZXNBdChleHBpcmVzSW4pIHsKICBjb25zdCB0aW1lTm93ID0gTWF0aC5yb3VuZChEYXRlLm5vdygpIC8gMWUzKTsKICByZXR1cm4gdGltZU5vdyArIGV4cGlyZXNJbjsKfQpmdW5jdGlvbiBnZW5lcmF0ZUNhbGxiYWNrSWQoKSB7CiAgcmV0dXJuIFN5bWJvbCgiYXV0aC1jYWxsYmFjayIpOwp9CnZhciBpc0Jyb3dzZXIgPSAoKSA9PiB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiOwp2YXIgbG9jYWxTdG9yYWdlV3JpdGVUZXN0cyA9IHsKICB0ZXN0ZWQ6IGZhbHNlLAogIHdyaXRhYmxlOiBmYWxzZQp9Owp2YXIgc3VwcG9ydHNMb2NhbFN0b3JhZ2UgPSAoKSA9PiB7CiAgaWYgKCFpc0Jyb3dzZXIoKSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICB0cnkgewogICAgaWYgKHR5cGVvZiBnbG9iYWxUaGlzLmxvY2FsU3RvcmFnZSAhPT0gIm9iamVjdCIpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0gY2F0Y2ggKGUpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKGxvY2FsU3RvcmFnZVdyaXRlVGVzdHMudGVzdGVkKSB7CiAgICByZXR1cm4gbG9jYWxTdG9yYWdlV3JpdGVUZXN0cy53cml0YWJsZTsKICB9CiAgY29uc3QgcmFuZG9tS2V5ID0gYGxzd3QtJHtNYXRoLnJhbmRvbSgpfSR7TWF0aC5yYW5kb20oKX1gOwogIHRyeSB7CiAgICBnbG9iYWxUaGlzLmxvY2FsU3RvcmFnZS5zZXRJdGVtKHJhbmRvbUtleSwgcmFuZG9tS2V5KTsKICAgIGdsb2JhbFRoaXMubG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0ocmFuZG9tS2V5KTsKICAgIGxvY2FsU3RvcmFnZVdyaXRlVGVzdHMudGVzdGVkID0gdHJ1ZTsKICAgIGxvY2FsU3RvcmFnZVdyaXRlVGVzdHMud3JpdGFibGUgPSB0cnVlOwogIH0gY2F0Y2ggKGUpIHsKICAgIGxvY2FsU3RvcmFnZVdyaXRlVGVzdHMudGVzdGVkID0gdHJ1ZTsKICAgIGxvY2FsU3RvcmFnZVdyaXRlVGVzdHMud3JpdGFibGUgPSBmYWxzZTsKICB9CiAgcmV0dXJuIGxvY2FsU3RvcmFnZVdyaXRlVGVzdHMud3JpdGFibGU7Cn07CmZ1bmN0aW9uIHBhcnNlUGFyYW1ldGVyc0Zyb21VUkwoaHJlZikgewogIGNvbnN0IHJlc3VsdCA9IHt9OwogIGNvbnN0IHVybCA9IG5ldyBVUkwoaHJlZik7CiAgaWYgKHVybC5oYXNoICYmIHVybC5oYXNoWzBdID09PSAiIyIpIHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IGhhc2hTZWFyY2hQYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHVybC5oYXNoLnN1YnN0cmluZygxKSk7CiAgICAgIGhhc2hTZWFyY2hQYXJhbXMuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4gewogICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZSkgewogICAgfQogIH0KICB1cmwuc2VhcmNoUGFyYW1zLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHsKICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgfSk7CiAgcmV0dXJuIHJlc3VsdDsKfQp2YXIgcmVzb2x2ZUZldGNoMyA9IChjdXN0b21GZXRjaCkgPT4gewogIGlmIChjdXN0b21GZXRjaCkgewogICAgcmV0dXJuICguLi5hcmdzKSA9PiBjdXN0b21GZXRjaCguLi5hcmdzKTsKICB9CiAgcmV0dXJuICguLi5hcmdzKSA9PiBmZXRjaCguLi5hcmdzKTsKfTsKdmFyIGxvb2tzTGlrZUZldGNoUmVzcG9uc2UgPSAobWF5YmVSZXNwb25zZSkgPT4gewogIHJldHVybiB0eXBlb2YgbWF5YmVSZXNwb25zZSA9PT0gIm9iamVjdCIgJiYgbWF5YmVSZXNwb25zZSAhPT0gbnVsbCAmJiAic3RhdHVzIiBpbiBtYXliZVJlc3BvbnNlICYmICJvayIgaW4gbWF5YmVSZXNwb25zZSAmJiAianNvbiIgaW4gbWF5YmVSZXNwb25zZSAmJiB0eXBlb2YgbWF5YmVSZXNwb25zZS5qc29uID09PSAiZnVuY3Rpb24iOwp9Owp2YXIgc2V0SXRlbUFzeW5jID0gYXN5bmMgKHN0b3JhZ2UsIGtleSwgZGF0YSkgPT4gewogIGF3YWl0IHN0b3JhZ2Uuc2V0SXRlbShrZXksIEpTT04uc3RyaW5naWZ5KGRhdGEpKTsKfTsKdmFyIGdldEl0ZW1Bc3luYyA9IGFzeW5jIChzdG9yYWdlLCBrZXkpID0+IHsKICBjb25zdCB2YWx1ZSA9IGF3YWl0IHN0b3JhZ2UuZ2V0SXRlbShrZXkpOwogIGlmICghdmFsdWUpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB0cnkgewogICAgcmV0dXJuIEpTT04ucGFyc2UodmFsdWUpOwogIH0gY2F0Y2ggKF9hKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQp9Owp2YXIgcmVtb3ZlSXRlbUFzeW5jID0gYXN5bmMgKHN0b3JhZ2UsIGtleSkgPT4gewogIGF3YWl0IHN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpOwp9Owp2YXIgRGVmZXJyZWQgPSBjbGFzcyBfRGVmZXJyZWQgewogIGNvbnN0cnVjdG9yKCkgewogICAgOwogICAgdGhpcy5wcm9taXNlID0gbmV3IF9EZWZlcnJlZC5wcm9taXNlQ29uc3RydWN0b3IoKHJlcywgcmVqKSA9PiB7CiAgICAgIDsKICAgICAgdGhpcy5yZXNvbHZlID0gcmVzOwogICAgICB0aGlzLnJlamVjdCA9IHJlajsKICAgIH0pOwogIH0KfTsKRGVmZXJyZWQucHJvbWlzZUNvbnN0cnVjdG9yID0gUHJvbWlzZTsKZnVuY3Rpb24gZGVjb2RlSldUKHRva2VuKSB7CiAgY29uc3QgcGFydHMgPSB0b2tlbi5zcGxpdCgiLiIpOwogIGlmIChwYXJ0cy5sZW5ndGggIT09IDMpIHsKICAgIHRocm93IG5ldyBBdXRoSW52YWxpZEp3dEVycm9yKCJJbnZhbGlkIEpXVCBzdHJ1Y3R1cmUiKTsKICB9CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgaWYgKCFCQVNFNjRVUkxfUkVHRVgudGVzdChwYXJ0c1tpXSkpIHsKICAgICAgdGhyb3cgbmV3IEF1dGhJbnZhbGlkSnd0RXJyb3IoIkpXVCBub3QgaW4gYmFzZTY0dXJsIGZvcm1hdCIpOwogICAgfQogIH0KICBjb25zdCBkYXRhID0gewogICAgLy8gdXNpbmcgYmFzZTY0dXJsIGxpYgogICAgaGVhZGVyOiBKU09OLnBhcnNlKHN0cmluZ0Zyb21CYXNlNjRVUkwocGFydHNbMF0pKSwKICAgIHBheWxvYWQ6IEpTT04ucGFyc2Uoc3RyaW5nRnJvbUJhc2U2NFVSTChwYXJ0c1sxXSkpLAogICAgc2lnbmF0dXJlOiBiYXNlNjRVcmxUb1VpbnQ4QXJyYXkocGFydHNbMl0pLAogICAgcmF3OiB7CiAgICAgIGhlYWRlcjogcGFydHNbMF0sCiAgICAgIHBheWxvYWQ6IHBhcnRzWzFdCiAgICB9CiAgfTsKICByZXR1cm4gZGF0YTsKfQphc3luYyBmdW5jdGlvbiBzbGVlcCh0aW1lMikgewogIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZSgoYWNjZXB0KSA9PiB7CiAgICBzZXRUaW1lb3V0KCgpID0+IGFjY2VwdChudWxsKSwgdGltZTIpOwogIH0pOwp9CmZ1bmN0aW9uIHJldHJ5YWJsZShmbiwgaXNSZXRyeWFibGUpIHsKICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2UoKGFjY2VwdCwgcmVqZWN0KSA9PiB7CiAgICA7CiAgICAoYXN5bmMgKCkgPT4gewogICAgICBmb3IgKGxldCBhdHRlbXB0ID0gMDsgYXR0ZW1wdCA8IEluZmluaXR5OyBhdHRlbXB0KyspIHsKICAgICAgICB0cnkgewogICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZm4oYXR0ZW1wdCk7CiAgICAgICAgICBpZiAoIWlzUmV0cnlhYmxlKGF0dGVtcHQsIG51bGwsIHJlc3VsdCkpIHsKICAgICAgICAgICAgYWNjZXB0KHJlc3VsdCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBpZiAoIWlzUmV0cnlhYmxlKGF0dGVtcHQsIGUpKSB7CiAgICAgICAgICAgIHJlamVjdChlKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSkoKTsKICB9KTsKICByZXR1cm4gcHJvbWlzZTsKfQpmdW5jdGlvbiBkZWMyaGV4KGRlYykgewogIHJldHVybiAoIjAiICsgZGVjLnRvU3RyaW5nKDE2KSkuc3Vic3RyKC0yKTsKfQpmdW5jdGlvbiBnZW5lcmF0ZVBLQ0VWZXJpZmllcigpIHsKICBjb25zdCB2ZXJpZmllckxlbmd0aCA9IDU2OwogIGNvbnN0IGFycmF5ID0gbmV3IFVpbnQzMkFycmF5KHZlcmlmaWVyTGVuZ3RoKTsKICBpZiAodHlwZW9mIGNyeXB0byA9PT0gInVuZGVmaW5lZCIpIHsKICAgIGNvbnN0IGNoYXJTZXQgPSAiQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVphYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ejAxMjM0NTY3ODktLl9+IjsKICAgIGNvbnN0IGNoYXJTZXRMZW4gPSBjaGFyU2V0Lmxlbmd0aDsKICAgIGxldCB2ZXJpZmllciA9ICIiOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2ZXJpZmllckxlbmd0aDsgaSsrKSB7CiAgICAgIHZlcmlmaWVyICs9IGNoYXJTZXQuY2hhckF0KE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGNoYXJTZXRMZW4pKTsKICAgIH0KICAgIHJldHVybiB2ZXJpZmllcjsKICB9CiAgY3J5cHRvLmdldFJhbmRvbVZhbHVlcyhhcnJheSk7CiAgcmV0dXJuIEFycmF5LmZyb20oYXJyYXksIGRlYzJoZXgpLmpvaW4oIiIpOwp9CmFzeW5jIGZ1bmN0aW9uIHNoYTI1NihyYW5kb21TdHJpbmcyKSB7CiAgY29uc3QgZW5jb2RlciA9IG5ldyBUZXh0RW5jb2RlcigpOwogIGNvbnN0IGVuY29kZWREYXRhID0gZW5jb2Rlci5lbmNvZGUocmFuZG9tU3RyaW5nMik7CiAgY29uc3QgaGFzaCA9IGF3YWl0IGNyeXB0by5zdWJ0bGUuZGlnZXN0KCJTSEEtMjU2IiwgZW5jb2RlZERhdGEpOwogIGNvbnN0IGJ5dGVzID0gbmV3IFVpbnQ4QXJyYXkoaGFzaCk7CiAgcmV0dXJuIEFycmF5LmZyb20oYnl0ZXMpLm1hcCgoYykgPT4gU3RyaW5nLmZyb21DaGFyQ29kZShjKSkuam9pbigiIik7Cn0KYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVQS0NFQ2hhbGxlbmdlKHZlcmlmaWVyKSB7CiAgY29uc3QgaGFzQ3J5cHRvU3VwcG9ydCA9IHR5cGVvZiBjcnlwdG8gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBjcnlwdG8uc3VidGxlICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgVGV4dEVuY29kZXIgIT09ICJ1bmRlZmluZWQiOwogIGlmICghaGFzQ3J5cHRvU3VwcG9ydCkgewogICAgY29uc29sZS53YXJuKCJXZWJDcnlwdG8gQVBJIGlzIG5vdCBzdXBwb3J0ZWQuIENvZGUgY2hhbGxlbmdlIG1ldGhvZCB3aWxsIGRlZmF1bHQgdG8gdXNlIHBsYWluIGluc3RlYWQgb2Ygc2hhMjU2LiIpOwogICAgcmV0dXJuIHZlcmlmaWVyOwogIH0KICBjb25zdCBoYXNoZWQgPSBhd2FpdCBzaGEyNTYodmVyaWZpZXIpOwogIHJldHVybiBidG9hKGhhc2hlZCkucmVwbGFjZSgvXCsvZywgIi0iKS5yZXBsYWNlKC9cLy9nLCAiXyIpLnJlcGxhY2UoLz0rJC8sICIiKTsKfQphc3luYyBmdW5jdGlvbiBnZXRDb2RlQ2hhbGxlbmdlQW5kTWV0aG9kKHN0b3JhZ2UsIHN0b3JhZ2VLZXksIGlzUGFzc3dvcmRSZWNvdmVyeSA9IGZhbHNlKSB7CiAgY29uc3QgY29kZVZlcmlmaWVyID0gZ2VuZXJhdGVQS0NFVmVyaWZpZXIoKTsKICBsZXQgc3RvcmVkQ29kZVZlcmlmaWVyID0gY29kZVZlcmlmaWVyOwogIGlmIChpc1Bhc3N3b3JkUmVjb3ZlcnkpIHsKICAgIHN0b3JlZENvZGVWZXJpZmllciArPSAiL1BBU1NXT1JEX1JFQ09WRVJZIjsKICB9CiAgYXdhaXQgc2V0SXRlbUFzeW5jKHN0b3JhZ2UsIGAke3N0b3JhZ2VLZXl9LWNvZGUtdmVyaWZpZXJgLCBzdG9yZWRDb2RlVmVyaWZpZXIpOwogIGNvbnN0IGNvZGVDaGFsbGVuZ2UgPSBhd2FpdCBnZW5lcmF0ZVBLQ0VDaGFsbGVuZ2UoY29kZVZlcmlmaWVyKTsKICBjb25zdCBjb2RlQ2hhbGxlbmdlTWV0aG9kID0gY29kZVZlcmlmaWVyID09PSBjb2RlQ2hhbGxlbmdlID8gInBsYWluIiA6ICJzMjU2IjsKICByZXR1cm4gW2NvZGVDaGFsbGVuZ2UsIGNvZGVDaGFsbGVuZ2VNZXRob2RdOwp9CnZhciBBUElfVkVSU0lPTl9SRUdFWCA9IC9eMlswLTldezN9LSgwWzEtOV18MVswLTJdKS0oMFsxLTldfDFbMC05XXwyWzAtOV18M1swLTFdKSQvaTsKZnVuY3Rpb24gcGFyc2VSZXNwb25zZUFQSVZlcnNpb24ocmVzcG9uc2UpIHsKICBjb25zdCBhcGlWZXJzaW9uID0gcmVzcG9uc2UuaGVhZGVycy5nZXQoQVBJX1ZFUlNJT05fSEVBREVSX05BTUUpOwogIGlmICghYXBpVmVyc2lvbikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmICghYXBpVmVyc2lvbi5tYXRjaChBUElfVkVSU0lPTl9SRUdFWCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB0cnkgewogICAgY29uc3QgZGF0ZTIgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoYCR7YXBpVmVyc2lvbn1UMDA6MDA6MDAuMFpgKTsKICAgIHJldHVybiBkYXRlMjsKICB9IGNhdGNoIChlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9Cn0KZnVuY3Rpb24gdmFsaWRhdGVFeHAoZXhwKSB7CiAgaWYgKCFleHApIHsKICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBleHAgY2xhaW0iKTsKICB9CiAgY29uc3QgdGltZU5vdyA9IE1hdGguZmxvb3IoRGF0ZS5ub3coKSAvIDFlMyk7CiAgaWYgKGV4cCA8PSB0aW1lTm93KSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkpXVCBoYXMgZXhwaXJlZCIpOwogIH0KfQpmdW5jdGlvbiBnZXRBbGdvcml0aG0oYWxnKSB7CiAgc3dpdGNoIChhbGcpIHsKICAgIGNhc2UgIlJTMjU2IjoKICAgICAgcmV0dXJuIHsKICAgICAgICBuYW1lOiAiUlNBU1NBLVBLQ1MxLXYxXzUiLAogICAgICAgIGhhc2g6IHsgbmFtZTogIlNIQS0yNTYiIH0KICAgICAgfTsKICAgIGNhc2UgIkVTMjU2IjoKICAgICAgcmV0dXJuIHsKICAgICAgICBuYW1lOiAiRUNEU0EiLAogICAgICAgIG5hbWVkQ3VydmU6ICJQLTI1NiIsCiAgICAgICAgaGFzaDogeyBuYW1lOiAiU0hBLTI1NiIgfQogICAgICB9OwogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGFsZyBjbGFpbSIpOwogIH0KfQp2YXIgVVVJRF9SRUdFWCA9IC9eWzAtOWEtZl17OH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17MTJ9JC87CmZ1bmN0aW9uIHZhbGlkYXRlVVVJRChzdHIpIHsKICBpZiAoIVVVSURfUkVHRVgudGVzdChzdHIpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkBzdXBhYmFzZS9hdXRoLWpzOiBFeHBlY3RlZCBwYXJhbWV0ZXIgdG8gYmUgVVVJRCBidXQgaXMgbm90Iik7CiAgfQp9CmZ1bmN0aW9uIHVzZXJOb3RBdmFpbGFibGVQcm94eSgpIHsKICBjb25zdCBwcm94eVRhcmdldCA9IHt9OwogIHJldHVybiBuZXcgUHJveHkocHJveHlUYXJnZXQsIHsKICAgIGdldDogKHRhcmdldCwgcHJvcCkgPT4gewogICAgICBpZiAocHJvcCA9PT0gIl9faXNVc2VyTm90QXZhaWxhYmxlUHJveHkiKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBwcm9wID09PSAic3ltYm9sIikgewogICAgICAgIGNvbnN0IHNQcm9wID0gcHJvcC50b1N0cmluZygpOwogICAgICAgIGlmIChzUHJvcCA9PT0gIlN5bWJvbChTeW1ib2wudG9QcmltaXRpdmUpIiB8fCBzUHJvcCA9PT0gIlN5bWJvbChTeW1ib2wudG9TdHJpbmdUYWcpIiB8fCBzUHJvcCA9PT0gIlN5bWJvbCh1dGlsLmluc3BlY3QuY3VzdG9tKSIpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRocm93IG5ldyBFcnJvcihgQHN1cGFiYXNlL2F1dGgtanM6IGNsaWVudCB3YXMgY3JlYXRlZCB3aXRoIHVzZXJTdG9yYWdlIG9wdGlvbiBhbmQgdGhlcmUgd2FzIG5vIHVzZXIgc3RvcmVkIGluIHRoZSB1c2VyIHN0b3JhZ2UuIEFjY2Vzc2luZyB0aGUgIiR7cHJvcH0iIHByb3BlcnR5IG9mIHRoZSBzZXNzaW9uIG9iamVjdCBpcyBub3Qgc3VwcG9ydGVkLiBQbGVhc2UgdXNlIGdldFVzZXIoKSBpbnN0ZWFkLmApOwogICAgfSwKICAgIHNldDogKF90YXJnZXQsIHByb3ApID0+IHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBAc3VwYWJhc2UvYXV0aC1qczogY2xpZW50IHdhcyBjcmVhdGVkIHdpdGggdXNlclN0b3JhZ2Ugb3B0aW9uIGFuZCB0aGVyZSB3YXMgbm8gdXNlciBzdG9yZWQgaW4gdGhlIHVzZXIgc3RvcmFnZS4gU2V0dGluZyB0aGUgIiR7cHJvcH0iIHByb3BlcnR5IG9mIHRoZSBzZXNzaW9uIG9iamVjdCBpcyBub3Qgc3VwcG9ydGVkLiBQbGVhc2UgdXNlIGdldFVzZXIoKSB0byBmZXRjaCBhIHVzZXIgb2JqZWN0IHlvdSBjYW4gbWFuaXB1bGF0ZS5gKTsKICAgIH0sCiAgICBkZWxldGVQcm9wZXJ0eTogKF90YXJnZXQsIHByb3ApID0+IHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBAc3VwYWJhc2UvYXV0aC1qczogY2xpZW50IHdhcyBjcmVhdGVkIHdpdGggdXNlclN0b3JhZ2Ugb3B0aW9uIGFuZCB0aGVyZSB3YXMgbm8gdXNlciBzdG9yZWQgaW4gdGhlIHVzZXIgc3RvcmFnZS4gRGVsZXRpbmcgdGhlICIke3Byb3B9IiBwcm9wZXJ0eSBvZiB0aGUgc2Vzc2lvbiBvYmplY3QgaXMgbm90IHN1cHBvcnRlZC4gUGxlYXNlIHVzZSBnZXRVc2VyKCkgdG8gZmV0Y2ggYSB1c2VyIG9iamVjdCB5b3UgY2FuIG1hbmlwdWxhdGUuYCk7CiAgICB9CiAgfSk7Cn0KZnVuY3Rpb24gaW5zZWN1cmVVc2VyV2FybmluZ1Byb3h5KHVzZXIsIHN1cHByZXNzV2FybmluZ1JlZikgewogIHJldHVybiBuZXcgUHJveHkodXNlciwgewogICAgZ2V0OiAodGFyZ2V0LCBwcm9wLCByZWNlaXZlcikgPT4gewogICAgICBpZiAocHJvcCA9PT0gIl9faXNJbnNlY3VyZVVzZXJXYXJuaW5nUHJveHkiKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBwcm9wID09PSAic3ltYm9sIikgewogICAgICAgIGNvbnN0IHNQcm9wID0gcHJvcC50b1N0cmluZygpOwogICAgICAgIGlmIChzUHJvcCA9PT0gIlN5bWJvbChTeW1ib2wudG9QcmltaXRpdmUpIiB8fCBzUHJvcCA9PT0gIlN5bWJvbChTeW1ib2wudG9TdHJpbmdUYWcpIiB8fCBzUHJvcCA9PT0gIlN5bWJvbCh1dGlsLmluc3BlY3QuY3VzdG9tKSIgfHwgc1Byb3AgPT09ICJTeW1ib2wobm9kZWpzLnV0aWwuaW5zcGVjdC5jdXN0b20pIikgewogICAgICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0KHRhcmdldCwgcHJvcCwgcmVjZWl2ZXIpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIXN1cHByZXNzV2FybmluZ1JlZi52YWx1ZSAmJiB0eXBlb2YgcHJvcCA9PT0gInN0cmluZyIpIHsKICAgICAgICBjb25zb2xlLndhcm4oIlVzaW5nIHRoZSB1c2VyIG9iamVjdCBhcyByZXR1cm5lZCBmcm9tIHN1cGFiYXNlLmF1dGguZ2V0U2Vzc2lvbigpIG9yIGZyb20gc29tZSBzdXBhYmFzZS5hdXRoLm9uQXV0aFN0YXRlQ2hhbmdlKCkgZXZlbnRzIGNvdWxkIGJlIGluc2VjdXJlISBUaGlzIHZhbHVlIGNvbWVzIGRpcmVjdGx5IGZyb20gdGhlIHN0b3JhZ2UgbWVkaXVtICh1c3VhbGx5IGNvb2tpZXMgb24gdGhlIHNlcnZlcikgYW5kIG1heSBub3QgYmUgYXV0aGVudGljLiBVc2Ugc3VwYWJhc2UuYXV0aC5nZXRVc2VyKCkgaW5zdGVhZCB3aGljaCBhdXRoZW50aWNhdGVzIHRoZSBkYXRhIGJ5IGNvbnRhY3RpbmcgdGhlIFN1cGFiYXNlIEF1dGggc2VydmVyLiIpOwogICAgICAgIHN1cHByZXNzV2FybmluZ1JlZi52YWx1ZSA9IHRydWU7CiAgICAgIH0KICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0KHRhcmdldCwgcHJvcCwgcmVjZWl2ZXIpOwogICAgfQogIH0pOwp9CmZ1bmN0aW9uIGRlZXBDbG9uZShvYmopIHsKICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvYmopKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZSthdXRoLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL2F1dGgtanMvZGlzdC9tb2R1bGUvbGliL2ZldGNoLmpzCnZhciBfZ2V0RXJyb3JNZXNzYWdlMiA9IChlcnIpID0+IGVyci5tc2cgfHwgZXJyLm1lc3NhZ2UgfHwgZXJyLmVycm9yX2Rlc2NyaXB0aW9uIHx8IGVyci5lcnJvciB8fCBKU09OLnN0cmluZ2lmeShlcnIpOwp2YXIgTkVUV09SS19FUlJPUl9DT0RFUyA9IFs1MDIsIDUwMywgNTA0XTsKYXN5bmMgZnVuY3Rpb24gaGFuZGxlRXJyb3IyKGVycm9yKSB7CiAgdmFyIF9hOwogIGlmICghbG9va3NMaWtlRmV0Y2hSZXNwb25zZShlcnJvcikpIHsKICAgIHRocm93IG5ldyBBdXRoUmV0cnlhYmxlRmV0Y2hFcnJvcihfZ2V0RXJyb3JNZXNzYWdlMihlcnJvciksIDApOwogIH0KICBpZiAoTkVUV09SS19FUlJPUl9DT0RFUy5pbmNsdWRlcyhlcnJvci5zdGF0dXMpKSB7CiAgICB0aHJvdyBuZXcgQXV0aFJldHJ5YWJsZUZldGNoRXJyb3IoX2dldEVycm9yTWVzc2FnZTIoZXJyb3IpLCBlcnJvci5zdGF0dXMpOwogIH0KICBsZXQgZGF0YTsKICB0cnkgewogICAgZGF0YSA9IGF3YWl0IGVycm9yLmpzb24oKTsKICB9IGNhdGNoIChlKSB7CiAgICB0aHJvdyBuZXcgQXV0aFVua25vd25FcnJvcihfZ2V0RXJyb3JNZXNzYWdlMihlKSwgZSk7CiAgfQogIGxldCBlcnJvckNvZGUgPSB2b2lkIDA7CiAgY29uc3QgcmVzcG9uc2VBUElWZXJzaW9uID0gcGFyc2VSZXNwb25zZUFQSVZlcnNpb24oZXJyb3IpOwogIGlmIChyZXNwb25zZUFQSVZlcnNpb24gJiYgcmVzcG9uc2VBUElWZXJzaW9uLmdldFRpbWUoKSA+PSBBUElfVkVSU0lPTlNbIjIwMjQtMDEtMDEiXS50aW1lc3RhbXAgJiYgdHlwZW9mIGRhdGEgPT09ICJvYmplY3QiICYmIGRhdGEgJiYgdHlwZW9mIGRhdGEuY29kZSA9PT0gInN0cmluZyIpIHsKICAgIGVycm9yQ29kZSA9IGRhdGEuY29kZTsKICB9IGVsc2UgaWYgKHR5cGVvZiBkYXRhID09PSAib2JqZWN0IiAmJiBkYXRhICYmIHR5cGVvZiBkYXRhLmVycm9yX2NvZGUgPT09ICJzdHJpbmciKSB7CiAgICBlcnJvckNvZGUgPSBkYXRhLmVycm9yX2NvZGU7CiAgfQogIGlmICghZXJyb3JDb2RlKSB7CiAgICBpZiAodHlwZW9mIGRhdGEgPT09ICJvYmplY3QiICYmIGRhdGEgJiYgdHlwZW9mIGRhdGEud2Vha19wYXNzd29yZCA9PT0gIm9iamVjdCIgJiYgZGF0YS53ZWFrX3Bhc3N3b3JkICYmIEFycmF5LmlzQXJyYXkoZGF0YS53ZWFrX3Bhc3N3b3JkLnJlYXNvbnMpICYmIGRhdGEud2Vha19wYXNzd29yZC5yZWFzb25zLmxlbmd0aCAmJiBkYXRhLndlYWtfcGFzc3dvcmQucmVhc29ucy5yZWR1Y2UoKGEsIGkpID0+IGEgJiYgdHlwZW9mIGkgPT09ICJzdHJpbmciLCB0cnVlKSkgewogICAgICB0aHJvdyBuZXcgQXV0aFdlYWtQYXNzd29yZEVycm9yKF9nZXRFcnJvck1lc3NhZ2UyKGRhdGEpLCBlcnJvci5zdGF0dXMsIGRhdGEud2Vha19wYXNzd29yZC5yZWFzb25zKTsKICAgIH0KICB9IGVsc2UgaWYgKGVycm9yQ29kZSA9PT0gIndlYWtfcGFzc3dvcmQiKSB7CiAgICB0aHJvdyBuZXcgQXV0aFdlYWtQYXNzd29yZEVycm9yKF9nZXRFcnJvck1lc3NhZ2UyKGRhdGEpLCBlcnJvci5zdGF0dXMsICgoX2EgPSBkYXRhLndlYWtfcGFzc3dvcmQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5yZWFzb25zKSB8fCBbXSk7CiAgfSBlbHNlIGlmIChlcnJvckNvZGUgPT09ICJzZXNzaW9uX25vdF9mb3VuZCIpIHsKICAgIHRocm93IG5ldyBBdXRoU2Vzc2lvbk1pc3NpbmdFcnJvcigpOwogIH0KICB0aHJvdyBuZXcgQXV0aEFwaUVycm9yKF9nZXRFcnJvck1lc3NhZ2UyKGRhdGEpLCBlcnJvci5zdGF0dXMgfHwgNTAwLCBlcnJvckNvZGUpOwp9CnZhciBfZ2V0UmVxdWVzdFBhcmFtczIgPSAobWV0aG9kLCBvcHRpb25zLCBwYXJhbWV0ZXJzLCBib2R5KSA9PiB7CiAgY29uc3QgcGFyYW1zID0geyBtZXRob2QsIGhlYWRlcnM6IChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuaGVhZGVycykgfHwge30gfTsKICBpZiAobWV0aG9kID09PSAiR0VUIikgewogICAgcmV0dXJuIHBhcmFtczsKICB9CiAgcGFyYW1zLmhlYWRlcnMgPSBPYmplY3QuYXNzaWduKHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uO2NoYXJzZXQ9VVRGLTgiIH0sIG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5oZWFkZXJzKTsKICBwYXJhbXMuYm9keSA9IEpTT04uc3RyaW5naWZ5KGJvZHkpOwogIHJldHVybiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHBhcmFtcyksIHBhcmFtZXRlcnMpOwp9Owphc3luYyBmdW5jdGlvbiBfcmVxdWVzdChmZXRjaGVyLCBtZXRob2QsIHVybCwgb3B0aW9ucykgewogIHZhciBfYTsKICBjb25zdCBoZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmhlYWRlcnMpOwogIGlmICghaGVhZGVyc1tBUElfVkVSU0lPTl9IRUFERVJfTkFNRV0pIHsKICAgIGhlYWRlcnNbQVBJX1ZFUlNJT05fSEVBREVSX05BTUVdID0gQVBJX1ZFUlNJT05TWyIyMDI0LTAxLTAxIl0ubmFtZTsKICB9CiAgaWYgKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5qd3QpIHsKICAgIGhlYWRlcnNbIkF1dGhvcml6YXRpb24iXSA9IGBCZWFyZXIgJHtvcHRpb25zLmp3dH1gOwogIH0KICBjb25zdCBxcyA9IChfYSA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5xdWVyeSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDoge307CiAgaWYgKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5yZWRpcmVjdFRvKSB7CiAgICBxc1sicmVkaXJlY3RfdG8iXSA9IG9wdGlvbnMucmVkaXJlY3RUbzsKICB9CiAgY29uc3QgcXVlcnlTdHJpbmcgPSBPYmplY3Qua2V5cyhxcykubGVuZ3RoID8gIj8iICsgbmV3IFVSTFNlYXJjaFBhcmFtcyhxcykudG9TdHJpbmcoKSA6ICIiOwogIGNvbnN0IGRhdGEgPSBhd2FpdCBfaGFuZGxlUmVxdWVzdDIoZmV0Y2hlciwgbWV0aG9kLCB1cmwgKyBxdWVyeVN0cmluZywgewogICAgaGVhZGVycywKICAgIG5vUmVzb2x2ZUpzb246IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5ub1Jlc29sdmVKc29uCiAgfSwge30sIG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5ib2R5KTsKICByZXR1cm4gKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy54Zm9ybSkgPyBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMueGZvcm0oZGF0YSkgOiB7IGRhdGE6IE9iamVjdC5hc3NpZ24oe30sIGRhdGEpLCBlcnJvcjogbnVsbCB9Owp9CmFzeW5jIGZ1bmN0aW9uIF9oYW5kbGVSZXF1ZXN0MihmZXRjaGVyLCBtZXRob2QsIHVybCwgb3B0aW9ucywgcGFyYW1ldGVycywgYm9keSkgewogIGNvbnN0IHJlcXVlc3RQYXJhbXMgPSBfZ2V0UmVxdWVzdFBhcmFtczIobWV0aG9kLCBvcHRpb25zLCBwYXJhbWV0ZXJzLCBib2R5KTsKICBsZXQgcmVzdWx0OwogIHRyeSB7CiAgICByZXN1bHQgPSBhd2FpdCBmZXRjaGVyKHVybCwgT2JqZWN0LmFzc2lnbih7fSwgcmVxdWVzdFBhcmFtcykpOwogIH0gY2F0Y2ggKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICB0aHJvdyBuZXcgQXV0aFJldHJ5YWJsZUZldGNoRXJyb3IoX2dldEVycm9yTWVzc2FnZTIoZSksIDApOwogIH0KICBpZiAoIXJlc3VsdC5vaykgewogICAgYXdhaXQgaGFuZGxlRXJyb3IyKHJlc3VsdCk7CiAgfQogIGlmIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMubm9SZXNvbHZlSnNvbikgewogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgdHJ5IHsKICAgIHJldHVybiBhd2FpdCByZXN1bHQuanNvbigpOwogIH0gY2F0Y2ggKGUpIHsKICAgIGF3YWl0IGhhbmRsZUVycm9yMihlKTsKICB9Cn0KZnVuY3Rpb24gX3Nlc3Npb25SZXNwb25zZShkYXRhKSB7CiAgdmFyIF9hOwogIGxldCBzZXNzaW9uID0gbnVsbDsKICBpZiAoaGFzU2Vzc2lvbihkYXRhKSkgewogICAgc2Vzc2lvbiA9IE9iamVjdC5hc3NpZ24oe30sIGRhdGEpOwogICAgaWYgKCFkYXRhLmV4cGlyZXNfYXQpIHsKICAgICAgc2Vzc2lvbi5leHBpcmVzX2F0ID0gZXhwaXJlc0F0KGRhdGEuZXhwaXJlc19pbik7CiAgICB9CiAgfQogIGNvbnN0IHVzZXIgPSAoX2EgPSBkYXRhLnVzZXIpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IGRhdGE7CiAgcmV0dXJuIHsgZGF0YTogeyBzZXNzaW9uLCB1c2VyIH0sIGVycm9yOiBudWxsIH07Cn0KZnVuY3Rpb24gX3Nlc3Npb25SZXNwb25zZVBhc3N3b3JkKGRhdGEpIHsKICBjb25zdCByZXNwb25zZSA9IF9zZXNzaW9uUmVzcG9uc2UoZGF0YSk7CiAgaWYgKCFyZXNwb25zZS5lcnJvciAmJiBkYXRhLndlYWtfcGFzc3dvcmQgJiYgdHlwZW9mIGRhdGEud2Vha19wYXNzd29yZCA9PT0gIm9iamVjdCIgJiYgQXJyYXkuaXNBcnJheShkYXRhLndlYWtfcGFzc3dvcmQucmVhc29ucykgJiYgZGF0YS53ZWFrX3Bhc3N3b3JkLnJlYXNvbnMubGVuZ3RoICYmIGRhdGEud2Vha19wYXNzd29yZC5tZXNzYWdlICYmIHR5cGVvZiBkYXRhLndlYWtfcGFzc3dvcmQubWVzc2FnZSA9PT0gInN0cmluZyIgJiYgZGF0YS53ZWFrX3Bhc3N3b3JkLnJlYXNvbnMucmVkdWNlKChhLCBpKSA9PiBhICYmIHR5cGVvZiBpID09PSAic3RyaW5nIiwgdHJ1ZSkpIHsKICAgIHJlc3BvbnNlLmRhdGEud2Vha19wYXNzd29yZCA9IGRhdGEud2Vha19wYXNzd29yZDsKICB9CiAgcmV0dXJuIHJlc3BvbnNlOwp9CmZ1bmN0aW9uIF91c2VyUmVzcG9uc2UoZGF0YSkgewogIHZhciBfYTsKICBjb25zdCB1c2VyID0gKF9hID0gZGF0YS51c2VyKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBkYXRhOwogIHJldHVybiB7IGRhdGE6IHsgdXNlciB9LCBlcnJvcjogbnVsbCB9Owp9CmZ1bmN0aW9uIF9zc29SZXNwb25zZShkYXRhKSB7CiAgcmV0dXJuIHsgZGF0YSwgZXJyb3I6IG51bGwgfTsKfQpmdW5jdGlvbiBfZ2VuZXJhdGVMaW5rUmVzcG9uc2UoZGF0YSkgewogIGNvbnN0IHsgYWN0aW9uX2xpbmssIGVtYWlsX290cCwgaGFzaGVkX3Rva2VuLCByZWRpcmVjdF90bywgdmVyaWZpY2F0aW9uX3R5cGUgfSA9IGRhdGEsIHJlc3QgPSBfX3Jlc3QoZGF0YSwgWyJhY3Rpb25fbGluayIsICJlbWFpbF9vdHAiLCAiaGFzaGVkX3Rva2VuIiwgInJlZGlyZWN0X3RvIiwgInZlcmlmaWNhdGlvbl90eXBlIl0pOwogIGNvbnN0IHByb3BlcnRpZXMgPSB7CiAgICBhY3Rpb25fbGluaywKICAgIGVtYWlsX290cCwKICAgIGhhc2hlZF90b2tlbiwKICAgIHJlZGlyZWN0X3RvLAogICAgdmVyaWZpY2F0aW9uX3R5cGUKICB9OwogIGNvbnN0IHVzZXIgPSBPYmplY3QuYXNzaWduKHt9LCByZXN0KTsKICByZXR1cm4gewogICAgZGF0YTogewogICAgICBwcm9wZXJ0aWVzLAogICAgICB1c2VyCiAgICB9LAogICAgZXJyb3I6IG51bGwKICB9Owp9CmZ1bmN0aW9uIF9ub1Jlc29sdmVKc29uUmVzcG9uc2UoZGF0YSkgewogIHJldHVybiBkYXRhOwp9CmZ1bmN0aW9uIGhhc1Nlc3Npb24oZGF0YSkgewogIHJldHVybiBkYXRhLmFjY2Vzc190b2tlbiAmJiBkYXRhLnJlZnJlc2hfdG9rZW4gJiYgZGF0YS5leHBpcmVzX2luOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK2F1dGgtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvYXV0aC1qcy9kaXN0L21vZHVsZS9saWIvdHlwZXMuanMKdmFyIFNJR05fT1VUX1NDT1BFUyA9IFsiZ2xvYmFsIiwgImxvY2FsIiwgIm90aGVycyJdOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZSthdXRoLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL2F1dGgtanMvZGlzdC9tb2R1bGUvR29UcnVlQWRtaW5BcGkuanMKdmFyIEdvVHJ1ZUFkbWluQXBpID0gY2xhc3MgewogIC8qKgogICAqIENyZWF0ZXMgYW4gYWRtaW4gQVBJIGNsaWVudCB0aGF0IGNhbiBiZSB1c2VkIHRvIG1hbmFnZSB1c2VycyBhbmQgT0F1dGggY2xpZW50cy4KICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHMKICAgKiBpbXBvcnQgeyBHb1RydWVBZG1pbkFwaSB9IGZyb20gJ0BzdXBhYmFzZS9hdXRoLWpzJwogICAqCiAgICogY29uc3QgYWRtaW4gPSBuZXcgR29UcnVlQWRtaW5BcGkoewogICAqICAgdXJsOiAnaHR0cHM6Ly94eXpjb21wYW55LnN1cGFiYXNlLmNvL2F1dGgvdjEnLAogICAqICAgaGVhZGVyczogeyBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7cHJvY2Vzcy5lbnYuU1VQQUJBU0VfU0VSVklDRV9ST0xFX0tFWX1gIH0sCiAgICogfSkKICAgKiBgYGAKICAgKi8KICBjb25zdHJ1Y3Rvcih7IHVybCA9ICIiLCBoZWFkZXJzID0ge30sIGZldGNoOiBmZXRjaDIgfSkgewogICAgdGhpcy51cmwgPSB1cmw7CiAgICB0aGlzLmhlYWRlcnMgPSBoZWFkZXJzOwogICAgdGhpcy5mZXRjaCA9IHJlc29sdmVGZXRjaDMoZmV0Y2gyKTsKICAgIHRoaXMubWZhID0gewogICAgICBsaXN0RmFjdG9yczogdGhpcy5fbGlzdEZhY3RvcnMuYmluZCh0aGlzKSwKICAgICAgZGVsZXRlRmFjdG9yOiB0aGlzLl9kZWxldGVGYWN0b3IuYmluZCh0aGlzKQogICAgfTsKICAgIHRoaXMub2F1dGggPSB7CiAgICAgIGxpc3RDbGllbnRzOiB0aGlzLl9saXN0T0F1dGhDbGllbnRzLmJpbmQodGhpcyksCiAgICAgIGNyZWF0ZUNsaWVudDogdGhpcy5fY3JlYXRlT0F1dGhDbGllbnQuYmluZCh0aGlzKSwKICAgICAgZ2V0Q2xpZW50OiB0aGlzLl9nZXRPQXV0aENsaWVudC5iaW5kKHRoaXMpLAogICAgICB1cGRhdGVDbGllbnQ6IHRoaXMuX3VwZGF0ZU9BdXRoQ2xpZW50LmJpbmQodGhpcyksCiAgICAgIGRlbGV0ZUNsaWVudDogdGhpcy5fZGVsZXRlT0F1dGhDbGllbnQuYmluZCh0aGlzKSwKICAgICAgcmVnZW5lcmF0ZUNsaWVudFNlY3JldDogdGhpcy5fcmVnZW5lcmF0ZU9BdXRoQ2xpZW50U2VjcmV0LmJpbmQodGhpcykKICAgIH07CiAgfQogIC8qKgogICAqIFJlbW92ZXMgYSBsb2dnZWQtaW4gc2Vzc2lvbi4KICAgKiBAcGFyYW0gand0IEEgdmFsaWQsIGxvZ2dlZC1pbiBKV1QuCiAgICogQHBhcmFtIHNjb3BlIFRoZSBsb2dvdXQgc29wZS4KICAgKi8KICBhc3luYyBzaWduT3V0KGp3dCwgc2NvcGUgPSBTSUdOX09VVF9TQ09QRVNbMF0pIHsKICAgIGlmIChTSUdOX09VVF9TQ09QRVMuaW5kZXhPZihzY29wZSkgPCAwKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgQHN1cGFiYXNlL2F1dGgtanM6IFBhcmFtZXRlciBzY29wZSBtdXN0IGJlIG9uZSBvZiAke1NJR05fT1VUX1NDT1BFUy5qb2luKCIsICIpfWApOwogICAgfQogICAgdHJ5IHsKICAgICAgYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vbG9nb3V0P3Njb3BlPSR7c2NvcGV9YCwgewogICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICBqd3QsCiAgICAgICAgbm9SZXNvbHZlSnNvbjogdHJ1ZQogICAgICB9KTsKICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3I6IG51bGwgfTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvciB9OwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBTZW5kcyBhbiBpbnZpdGUgbGluayB0byBhbiBlbWFpbCBhZGRyZXNzLgogICAqIEBwYXJhbSBlbWFpbCBUaGUgZW1haWwgYWRkcmVzcyBvZiB0aGUgdXNlci4KICAgKiBAcGFyYW0gb3B0aW9ucyBBZGRpdGlvbmFsIG9wdGlvbnMgdG8gYmUgaW5jbHVkZWQgd2hlbiBpbnZpdGluZy4KICAgKi8KICBhc3luYyBpbnZpdGVVc2VyQnlFbWFpbChlbWFpbCwgb3B0aW9ucyA9IHt9KSB7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vaW52aXRlYCwgewogICAgICAgIGJvZHk6IHsgZW1haWwsIGRhdGE6IG9wdGlvbnMuZGF0YSB9LAogICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICByZWRpcmVjdFRvOiBvcHRpb25zLnJlZGlyZWN0VG8sCiAgICAgICAgeGZvcm06IF91c2VyUmVzcG9uc2UKICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogeyB1c2VyOiBudWxsIH0sIGVycm9yIH07CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIEdlbmVyYXRlcyBlbWFpbCBsaW5rcyBhbmQgT1RQcyB0byBiZSBzZW50IHZpYSBhIGN1c3RvbSBlbWFpbCBwcm92aWRlci4KICAgKiBAcGFyYW0gZW1haWwgVGhlIHVzZXIncyBlbWFpbC4KICAgKiBAcGFyYW0gb3B0aW9ucy5wYXNzd29yZCBVc2VyIHBhc3N3b3JkLiBGb3Igc2lnbnVwIG9ubHkuCiAgICogQHBhcmFtIG9wdGlvbnMuZGF0YSBPcHRpb25hbCB1c2VyIG1ldGFkYXRhLiBGb3Igc2lnbnVwIG9ubHkuCiAgICogQHBhcmFtIG9wdGlvbnMucmVkaXJlY3RUbyBUaGUgcmVkaXJlY3QgdXJsIHdoaWNoIHNob3VsZCBiZSBhcHBlbmRlZCB0byB0aGUgZ2VuZXJhdGVkIGxpbmsKICAgKi8KICBhc3luYyBnZW5lcmF0ZUxpbmsocGFyYW1zKSB7CiAgICB0cnkgewogICAgICBjb25zdCB7IG9wdGlvbnMgfSA9IHBhcmFtcywgcmVzdCA9IF9fcmVzdChwYXJhbXMsIFsib3B0aW9ucyJdKTsKICAgICAgY29uc3QgYm9keSA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgcmVzdCksIG9wdGlvbnMpOwogICAgICBpZiAoIm5ld0VtYWlsIiBpbiByZXN0KSB7CiAgICAgICAgYm9keS5uZXdfZW1haWwgPSByZXN0ID09PSBudWxsIHx8IHJlc3QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlc3QubmV3RW1haWw7CiAgICAgICAgZGVsZXRlIGJvZHlbIm5ld0VtYWlsIl07CiAgICAgIH0KICAgICAgcmV0dXJuIGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L2FkbWluL2dlbmVyYXRlX2xpbmtgLCB7CiAgICAgICAgYm9keSwKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgeGZvcm06IF9nZW5lcmF0ZUxpbmtSZXNwb25zZSwKICAgICAgICByZWRpcmVjdFRvOiBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMucmVkaXJlY3RUbwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZGF0YTogewogICAgICAgICAgICBwcm9wZXJ0aWVzOiBudWxsLAogICAgICAgICAgICB1c2VyOiBudWxsCiAgICAgICAgICB9LAogICAgICAgICAgZXJyb3IKICAgICAgICB9OwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvLyBVc2VyIEFkbWluIEFQSQogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgdXNlci4KICAgKiBUaGlzIGZ1bmN0aW9uIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBvbiBhIHNlcnZlci4gTmV2ZXIgZXhwb3NlIHlvdXIgYHNlcnZpY2Vfcm9sZWAga2V5IGluIHRoZSBicm93c2VyLgogICAqLwogIGFzeW5jIGNyZWF0ZVVzZXIoYXR0cmlidXRlcykgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L2FkbWluL3VzZXJzYCwgewogICAgICAgIGJvZHk6IGF0dHJpYnV0ZXMsCiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIHhmb3JtOiBfdXNlclJlc3BvbnNlCiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB7IGRhdGE6IHsgdXNlcjogbnVsbCB9LCBlcnJvciB9OwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBHZXQgYSBsaXN0IG9mIHVzZXJzLgogICAqCiAgICogVGhpcyBmdW5jdGlvbiBzaG91bGQgb25seSBiZSBjYWxsZWQgb24gYSBzZXJ2ZXIuIE5ldmVyIGV4cG9zZSB5b3VyIGBzZXJ2aWNlX3JvbGVgIGtleSBpbiB0aGUgYnJvd3Nlci4KICAgKiBAcGFyYW0gcGFyYW1zIEFuIG9iamVjdCB3aGljaCBzdXBwb3J0cyBgcGFnZWAgYW5kIGBwZXJQYWdlYCBhcyBudW1iZXJzLCB0byBhbHRlciB0aGUgcGFnaW5hdGVkIHJlc3VsdHMuCiAgICovCiAgYXN5bmMgbGlzdFVzZXJzKHBhcmFtcykgewogICAgdmFyIF9hLCBfYiwgX2MsIF9kLCBfZSwgX2YsIF9nOwogICAgdHJ5IHsKICAgICAgY29uc3QgcGFnaW5hdGlvbiA9IHsgbmV4dFBhZ2U6IG51bGwsIGxhc3RQYWdlOiAwLCB0b3RhbDogMCB9OwogICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJHRVQiLCBgJHt0aGlzLnVybH0vYWRtaW4vdXNlcnNgLCB7CiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIG5vUmVzb2x2ZUpzb246IHRydWUsCiAgICAgICAgcXVlcnk6IHsKICAgICAgICAgIHBhZ2U6IChfYiA9IChfYSA9IHBhcmFtcyA9PT0gbnVsbCB8fCBwYXJhbXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBhcmFtcy5wYWdlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EudG9TdHJpbmcoKSkgIT09IG51bGwgJiYgX2IgIT09IHZvaWQgMCA/IF9iIDogIiIsCiAgICAgICAgICBwZXJfcGFnZTogKF9kID0gKF9jID0gcGFyYW1zID09PSBudWxsIHx8IHBhcmFtcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogcGFyYW1zLnBlclBhZ2UpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy50b1N0cmluZygpKSAhPT0gbnVsbCAmJiBfZCAhPT0gdm9pZCAwID8gX2QgOiAiIgogICAgICAgIH0sCiAgICAgICAgeGZvcm06IF9ub1Jlc29sdmVKc29uUmVzcG9uc2UKICAgICAgfSk7CiAgICAgIGlmIChyZXNwb25zZS5lcnJvcikKICAgICAgICB0aHJvdyByZXNwb25zZS5lcnJvcjsKICAgICAgY29uc3QgdXNlcnMgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7CiAgICAgIGNvbnN0IHRvdGFsID0gKF9lID0gcmVzcG9uc2UuaGVhZGVycy5nZXQoIngtdG90YWwtY291bnQiKSkgIT09IG51bGwgJiYgX2UgIT09IHZvaWQgMCA/IF9lIDogMDsKICAgICAgY29uc3QgbGlua3MgPSAoX2cgPSAoX2YgPSByZXNwb25zZS5oZWFkZXJzLmdldCgibGluayIpKSA9PT0gbnVsbCB8fCBfZiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Yuc3BsaXQoIiwiKSkgIT09IG51bGwgJiYgX2cgIT09IHZvaWQgMCA/IF9nIDogW107CiAgICAgIGlmIChsaW5rcy5sZW5ndGggPiAwKSB7CiAgICAgICAgbGlua3MuZm9yRWFjaCgobGluaykgPT4gewogICAgICAgICAgY29uc3QgcGFnZSA9IHBhcnNlSW50KGxpbmsuc3BsaXQoIjsiKVswXS5zcGxpdCgiPSIpWzFdLnN1YnN0cmluZygwLCAxKSk7CiAgICAgICAgICBjb25zdCByZWwgPSBKU09OLnBhcnNlKGxpbmsuc3BsaXQoIjsiKVsxXS5zcGxpdCgiPSIpWzFdKTsKICAgICAgICAgIHBhZ2luYXRpb25bYCR7cmVsfVBhZ2VgXSA9IHBhZ2U7CiAgICAgICAgfSk7CiAgICAgICAgcGFnaW5hdGlvbi50b3RhbCA9IHBhcnNlSW50KHRvdGFsKTsKICAgICAgfQogICAgICByZXR1cm4geyBkYXRhOiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHVzZXJzKSwgcGFnaW5hdGlvbiksIGVycm9yOiBudWxsIH07CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogeyB1c2VyczogW10gfSwgZXJyb3IgfTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogR2V0IHVzZXIgYnkgaWQuCiAgICoKICAgKiBAcGFyYW0gdWlkIFRoZSB1c2VyJ3MgdW5pcXVlIGlkZW50aWZpZXIKICAgKgogICAqIFRoaXMgZnVuY3Rpb24gc2hvdWxkIG9ubHkgYmUgY2FsbGVkIG9uIGEgc2VydmVyLiBOZXZlciBleHBvc2UgeW91ciBgc2VydmljZV9yb2xlYCBrZXkgaW4gdGhlIGJyb3dzZXIuCiAgICovCiAgYXN5bmMgZ2V0VXNlckJ5SWQodWlkKSB7CiAgICB2YWxpZGF0ZVVVSUQodWlkKTsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiR0VUIiwgYCR7dGhpcy51cmx9L2FkbWluL3VzZXJzLyR7dWlkfWAsIHsKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgeGZvcm06IF91c2VyUmVzcG9uc2UKICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogeyB1c2VyOiBudWxsIH0sIGVycm9yIH07CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIFVwZGF0ZXMgdGhlIHVzZXIgZGF0YS4gQ2hhbmdlcyBhcmUgYXBwbGllZCBkaXJlY3RseSB3aXRob3V0IGNvbmZpcm1hdGlvbiBmbG93cy4KICAgKgogICAqIEBwYXJhbSB1aWQgVGhlIHVzZXIncyB1bmlxdWUgaWRlbnRpZmllcgogICAqIEBwYXJhbSBhdHRyaWJ1dGVzIFRoZSBkYXRhIHlvdSB3YW50IHRvIHVwZGF0ZS4KICAgKgogICAqIFRoaXMgZnVuY3Rpb24gc2hvdWxkIG9ubHkgYmUgY2FsbGVkIG9uIGEgc2VydmVyLiBOZXZlciBleHBvc2UgeW91ciBgc2VydmljZV9yb2xlYCBrZXkgaW4gdGhlIGJyb3dzZXIuCiAgICoKICAgKiBAcmVtYXJrcwogICAqICoqSW1wb3J0YW50OioqIFRoaXMgaXMgYSBzZXJ2ZXItc2lkZSBvcGVyYXRpb24gYW5kIGRvZXMgKipub3QqKiB0cmlnZ2VyIGNsaWVudC1zaWRlCiAgICogYG9uQXV0aFN0YXRlQ2hhbmdlYCBsaXN0ZW5lcnMuIFRoZSBhZG1pbiBBUEkgaGFzIG5vIGNvbm5lY3Rpb24gdG8gY2xpZW50IHN0YXRlLgogICAqCiAgICogVG8gc3luYyBjaGFuZ2VzIHRvIHRoZSBjbGllbnQgYWZ0ZXIgY2FsbGluZyB0aGlzIG1ldGhvZDoKICAgKiAxLiBPbiB0aGUgY2xpZW50LCBjYWxsIGBzdXBhYmFzZS5hdXRoLnJlZnJlc2hTZXNzaW9uKClgIHRvIGZldGNoIHRoZSB1cGRhdGVkIHVzZXIgZGF0YQogICAqIDIuIFRoaXMgd2lsbCB0cmlnZ2VyIHRoZSBgVE9LRU5fUkVGUkVTSEVEYCBldmVudCBhbmQgbm90aWZ5IGFsbCBsaXN0ZW5lcnMKICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHlwZXNjcmlwdAogICAqIC8vIFNlcnZlci1zaWRlIChFZGdlIEZ1bmN0aW9uKQogICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlLmF1dGguYWRtaW4udXBkYXRlVXNlckJ5SWQoCiAgICogICB1c2VySWQsCiAgICogICB7IHVzZXJfbWV0YWRhdGE6IHsgcHJlZmVyZW5jZXM6IHsgdGhlbWU6ICdkYXJrJyB9IH0gfQogICAqICkKICAgKgogICAqIC8vIENsaWVudC1zaWRlICh0byBzeW5jIHRoZSBjaGFuZ2VzKQogICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlLmF1dGgucmVmcmVzaFNlc3Npb24oKQogICAqIC8vIG9uQXV0aFN0YXRlQ2hhbmdlIGxpc3RlbmVycyB3aWxsIG5vdyBiZSBub3RpZmllZCB3aXRoIHVwZGF0ZWQgdXNlcgogICAqIGBgYAogICAqCiAgICogQHNlZSB7QGxpbmsgR29UcnVlQ2xpZW50LnJlZnJlc2hTZXNzaW9ufSBmb3Igc3luY2luZyBhZG1pbiBjaGFuZ2VzIHRvIHRoZSBjbGllbnQKICAgKiBAc2VlIHtAbGluayBHb1RydWVDbGllbnQudXBkYXRlVXNlcn0gZm9yIGNsaWVudC1zaWRlIHVzZXIgdXBkYXRlcyAodHJpZ2dlcnMgbGlzdGVuZXJzIGF1dG9tYXRpY2FsbHkpCiAgICovCiAgYXN5bmMgdXBkYXRlVXNlckJ5SWQodWlkLCBhdHRyaWJ1dGVzKSB7CiAgICB2YWxpZGF0ZVVVSUQodWlkKTsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUFVUIiwgYCR7dGhpcy51cmx9L2FkbWluL3VzZXJzLyR7dWlkfWAsIHsKICAgICAgICBib2R5OiBhdHRyaWJ1dGVzLAogICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICB4Zm9ybTogX3VzZXJSZXNwb25zZQogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiB7IHVzZXI6IG51bGwgfSwgZXJyb3IgfTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogRGVsZXRlIGEgdXNlci4gUmVxdWlyZXMgYSBgc2VydmljZV9yb2xlYCBrZXkuCiAgICoKICAgKiBAcGFyYW0gaWQgVGhlIHVzZXIgaWQgeW91IHdhbnQgdG8gcmVtb3ZlLgogICAqIEBwYXJhbSBzaG91bGRTb2Z0RGVsZXRlIElmIHRydWUsIHRoZW4gdGhlIHVzZXIgd2lsbCBiZSBzb2Z0LWRlbGV0ZWQgZnJvbSB0aGUgYXV0aCBzY2hlbWEuIFNvZnQgZGVsZXRpb24gYWxsb3dzIHVzZXIgaWRlbnRpZmljYXRpb24gZnJvbSB0aGUgaGFzaGVkIHVzZXIgSUQgYnV0IGlzIG5vdCByZXZlcnNpYmxlLgogICAqIERlZmF1bHRzIHRvIGZhbHNlIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LgogICAqCiAgICogVGhpcyBmdW5jdGlvbiBzaG91bGQgb25seSBiZSBjYWxsZWQgb24gYSBzZXJ2ZXIuIE5ldmVyIGV4cG9zZSB5b3VyIGBzZXJ2aWNlX3JvbGVgIGtleSBpbiB0aGUgYnJvd3Nlci4KICAgKi8KICBhc3luYyBkZWxldGVVc2VyKGlkLCBzaG91bGRTb2Z0RGVsZXRlID0gZmFsc2UpIHsKICAgIHZhbGlkYXRlVVVJRChpZCk7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIkRFTEVURSIsIGAke3RoaXMudXJsfS9hZG1pbi91c2Vycy8ke2lkfWAsIHsKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgYm9keTogewogICAgICAgICAgc2hvdWxkX3NvZnRfZGVsZXRlOiBzaG91bGRTb2Z0RGVsZXRlCiAgICAgICAgfSwKICAgICAgICB4Zm9ybTogX3VzZXJSZXNwb25zZQogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiB7IHVzZXI6IG51bGwgfSwgZXJyb3IgfTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgYXN5bmMgX2xpc3RGYWN0b3JzKHBhcmFtcykgewogICAgdmFsaWRhdGVVVUlEKHBhcmFtcy51c2VySWQpOwogICAgdHJ5IHsKICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIkdFVCIsIGAke3RoaXMudXJsfS9hZG1pbi91c2Vycy8ke3BhcmFtcy51c2VySWR9L2ZhY3RvcnNgLCB7CiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIHhmb3JtOiAoZmFjdG9ycykgPT4gewogICAgICAgICAgcmV0dXJuIHsgZGF0YTogeyBmYWN0b3JzIH0sIGVycm9yOiBudWxsIH07CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHsgZGF0YSwgZXJyb3IgfTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvciB9OwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICBhc3luYyBfZGVsZXRlRmFjdG9yKHBhcmFtcykgewogICAgdmFsaWRhdGVVVUlEKHBhcmFtcy51c2VySWQpOwogICAgdmFsaWRhdGVVVUlEKHBhcmFtcy5pZCk7CiAgICB0cnkgewogICAgICBjb25zdCBkYXRhID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIkRFTEVURSIsIGAke3RoaXMudXJsfS9hZG1pbi91c2Vycy8ke3BhcmFtcy51c2VySWR9L2ZhY3RvcnMvJHtwYXJhbXMuaWR9YCwgewogICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycwogICAgICB9KTsKICAgICAgcmV0dXJuIHsgZGF0YSwgZXJyb3I6IG51bGwgfTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvciB9OwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBMaXN0cyBhbGwgT0F1dGggY2xpZW50cyB3aXRoIG9wdGlvbmFsIHBhZ2luYXRpb24uCiAgICogT25seSByZWxldmFudCB3aGVuIHRoZSBPQXV0aCAyLjEgc2VydmVyIGlzIGVuYWJsZWQgaW4gU3VwYWJhc2UgQXV0aC4KICAgKgogICAqIFRoaXMgZnVuY3Rpb24gc2hvdWxkIG9ubHkgYmUgY2FsbGVkIG9uIGEgc2VydmVyLiBOZXZlciBleHBvc2UgeW91ciBgc2VydmljZV9yb2xlYCBrZXkgaW4gdGhlIGJyb3dzZXIuCiAgICovCiAgYXN5bmMgX2xpc3RPQXV0aENsaWVudHMocGFyYW1zKSB7CiAgICB2YXIgX2EsIF9iLCBfYywgX2QsIF9lLCBfZiwgX2c7CiAgICB0cnkgewogICAgICBjb25zdCBwYWdpbmF0aW9uID0geyBuZXh0UGFnZTogbnVsbCwgbGFzdFBhZ2U6IDAsIHRvdGFsOiAwIH07CiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIkdFVCIsIGAke3RoaXMudXJsfS9hZG1pbi9vYXV0aC9jbGllbnRzYCwgewogICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICBub1Jlc29sdmVKc29uOiB0cnVlLAogICAgICAgIHF1ZXJ5OiB7CiAgICAgICAgICBwYWdlOiAoX2IgPSAoX2EgPSBwYXJhbXMgPT09IG51bGwgfHwgcGFyYW1zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwYXJhbXMucGFnZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnRvU3RyaW5nKCkpICE9PSBudWxsICYmIF9iICE9PSB2b2lkIDAgPyBfYiA6ICIiLAogICAgICAgICAgcGVyX3BhZ2U6IChfZCA9IChfYyA9IHBhcmFtcyA9PT0gbnVsbCB8fCBwYXJhbXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBhcmFtcy5wZXJQYWdlKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MudG9TdHJpbmcoKSkgIT09IG51bGwgJiYgX2QgIT09IHZvaWQgMCA/IF9kIDogIiIKICAgICAgICB9LAogICAgICAgIHhmb3JtOiBfbm9SZXNvbHZlSnNvblJlc3BvbnNlCiAgICAgIH0pOwogICAgICBpZiAocmVzcG9uc2UuZXJyb3IpCiAgICAgICAgdGhyb3cgcmVzcG9uc2UuZXJyb3I7CiAgICAgIGNvbnN0IGNsaWVudHMgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7CiAgICAgIGNvbnN0IHRvdGFsID0gKF9lID0gcmVzcG9uc2UuaGVhZGVycy5nZXQoIngtdG90YWwtY291bnQiKSkgIT09IG51bGwgJiYgX2UgIT09IHZvaWQgMCA/IF9lIDogMDsKICAgICAgY29uc3QgbGlua3MgPSAoX2cgPSAoX2YgPSByZXNwb25zZS5oZWFkZXJzLmdldCgibGluayIpKSA9PT0gbnVsbCB8fCBfZiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Yuc3BsaXQoIiwiKSkgIT09IG51bGwgJiYgX2cgIT09IHZvaWQgMCA/IF9nIDogW107CiAgICAgIGlmIChsaW5rcy5sZW5ndGggPiAwKSB7CiAgICAgICAgbGlua3MuZm9yRWFjaCgobGluaykgPT4gewogICAgICAgICAgY29uc3QgcGFnZSA9IHBhcnNlSW50KGxpbmsuc3BsaXQoIjsiKVswXS5zcGxpdCgiPSIpWzFdLnN1YnN0cmluZygwLCAxKSk7CiAgICAgICAgICBjb25zdCByZWwgPSBKU09OLnBhcnNlKGxpbmsuc3BsaXQoIjsiKVsxXS5zcGxpdCgiPSIpWzFdKTsKICAgICAgICAgIHBhZ2luYXRpb25bYCR7cmVsfVBhZ2VgXSA9IHBhZ2U7CiAgICAgICAgfSk7CiAgICAgICAgcGFnaW5hdGlvbi50b3RhbCA9IHBhcnNlSW50KHRvdGFsKTsKICAgICAgfQogICAgICByZXR1cm4geyBkYXRhOiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIGNsaWVudHMpLCBwYWdpbmF0aW9uKSwgZXJyb3I6IG51bGwgfTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiB7IGNsaWVudHM6IFtdIH0sIGVycm9yIH07CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgT0F1dGggY2xpZW50LgogICAqIE9ubHkgcmVsZXZhbnQgd2hlbiB0aGUgT0F1dGggMi4xIHNlcnZlciBpcyBlbmFibGVkIGluIFN1cGFiYXNlIEF1dGguCiAgICoKICAgKiBUaGlzIGZ1bmN0aW9uIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBvbiBhIHNlcnZlci4gTmV2ZXIgZXhwb3NlIHlvdXIgYHNlcnZpY2Vfcm9sZWAga2V5IGluIHRoZSBicm93c2VyLgogICAqLwogIGFzeW5jIF9jcmVhdGVPQXV0aENsaWVudChwYXJhbXMpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGAke3RoaXMudXJsfS9hZG1pbi9vYXV0aC9jbGllbnRzYCwgewogICAgICAgIGJvZHk6IHBhcmFtcywKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgeGZvcm06IChjbGllbnQpID0+IHsKICAgICAgICAgIHJldHVybiB7IGRhdGE6IGNsaWVudCwgZXJyb3I6IG51bGwgfTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB7IGRhdGE6IG51bGwsIGVycm9yIH07CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIEdldHMgZGV0YWlscyBvZiBhIHNwZWNpZmljIE9BdXRoIGNsaWVudC4KICAgKiBPbmx5IHJlbGV2YW50IHdoZW4gdGhlIE9BdXRoIDIuMSBzZXJ2ZXIgaXMgZW5hYmxlZCBpbiBTdXBhYmFzZSBBdXRoLgogICAqCiAgICogVGhpcyBmdW5jdGlvbiBzaG91bGQgb25seSBiZSBjYWxsZWQgb24gYSBzZXJ2ZXIuIE5ldmVyIGV4cG9zZSB5b3VyIGBzZXJ2aWNlX3JvbGVgIGtleSBpbiB0aGUgYnJvd3Nlci4KICAgKi8KICBhc3luYyBfZ2V0T0F1dGhDbGllbnQoY2xpZW50SWQpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiR0VUIiwgYCR7dGhpcy51cmx9L2FkbWluL29hdXRoL2NsaWVudHMvJHtjbGllbnRJZH1gLCB7CiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIHhmb3JtOiAoY2xpZW50KSA9PiB7CiAgICAgICAgICByZXR1cm4geyBkYXRhOiBjbGllbnQsIGVycm9yOiBudWxsIH07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvciB9OwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBVcGRhdGVzIGFuIGV4aXN0aW5nIE9BdXRoIGNsaWVudC4KICAgKiBPbmx5IHJlbGV2YW50IHdoZW4gdGhlIE9BdXRoIDIuMSBzZXJ2ZXIgaXMgZW5hYmxlZCBpbiBTdXBhYmFzZSBBdXRoLgogICAqCiAgICogVGhpcyBmdW5jdGlvbiBzaG91bGQgb25seSBiZSBjYWxsZWQgb24gYSBzZXJ2ZXIuIE5ldmVyIGV4cG9zZSB5b3VyIGBzZXJ2aWNlX3JvbGVgIGtleSBpbiB0aGUgYnJvd3Nlci4KICAgKi8KICBhc3luYyBfdXBkYXRlT0F1dGhDbGllbnQoY2xpZW50SWQsIHBhcmFtcykgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQVVQiLCBgJHt0aGlzLnVybH0vYWRtaW4vb2F1dGgvY2xpZW50cy8ke2NsaWVudElkfWAsIHsKICAgICAgICBib2R5OiBwYXJhbXMsCiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIHhmb3JtOiAoY2xpZW50KSA9PiB7CiAgICAgICAgICByZXR1cm4geyBkYXRhOiBjbGllbnQsIGVycm9yOiBudWxsIH07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvciB9OwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBEZWxldGVzIGFuIE9BdXRoIGNsaWVudC4KICAgKiBPbmx5IHJlbGV2YW50IHdoZW4gdGhlIE9BdXRoIDIuMSBzZXJ2ZXIgaXMgZW5hYmxlZCBpbiBTdXBhYmFzZSBBdXRoLgogICAqCiAgICogVGhpcyBmdW5jdGlvbiBzaG91bGQgb25seSBiZSBjYWxsZWQgb24gYSBzZXJ2ZXIuIE5ldmVyIGV4cG9zZSB5b3VyIGBzZXJ2aWNlX3JvbGVgIGtleSBpbiB0aGUgYnJvd3Nlci4KICAgKi8KICBhc3luYyBfZGVsZXRlT0F1dGhDbGllbnQoY2xpZW50SWQpIHsKICAgIHRyeSB7CiAgICAgIGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJERUxFVEUiLCBgJHt0aGlzLnVybH0vYWRtaW4vb2F1dGgvY2xpZW50cy8ke2NsaWVudElkfWAsIHsKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgbm9SZXNvbHZlSnNvbjogdHJ1ZQogICAgICB9KTsKICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3I6IG51bGwgfTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvciB9OwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBSZWdlbmVyYXRlcyB0aGUgc2VjcmV0IGZvciBhbiBPQXV0aCBjbGllbnQuCiAgICogT25seSByZWxldmFudCB3aGVuIHRoZSBPQXV0aCAyLjEgc2VydmVyIGlzIGVuYWJsZWQgaW4gU3VwYWJhc2UgQXV0aC4KICAgKgogICAqIFRoaXMgZnVuY3Rpb24gc2hvdWxkIG9ubHkgYmUgY2FsbGVkIG9uIGEgc2VydmVyLiBOZXZlciBleHBvc2UgeW91ciBgc2VydmljZV9yb2xlYCBrZXkgaW4gdGhlIGJyb3dzZXIuCiAgICovCiAgYXN5bmMgX3JlZ2VuZXJhdGVPQXV0aENsaWVudFNlY3JldChjbGllbnRJZCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L2FkbWluL29hdXRoL2NsaWVudHMvJHtjbGllbnRJZH0vcmVnZW5lcmF0ZV9zZWNyZXRgLCB7CiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIHhmb3JtOiAoY2xpZW50KSA9PiB7CiAgICAgICAgICByZXR1cm4geyBkYXRhOiBjbGllbnQsIGVycm9yOiBudWxsIH07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvciB9OwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrYXV0aC1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9hdXRoLWpzL2Rpc3QvbW9kdWxlL2xpYi9sb2NhbC1zdG9yYWdlLmpzCmZ1bmN0aW9uIG1lbW9yeUxvY2FsU3RvcmFnZUFkYXB0ZXIoc3RvcmUgPSB7fSkgewogIHJldHVybiB7CiAgICBnZXRJdGVtOiAoa2V5KSA9PiB7CiAgICAgIHJldHVybiBzdG9yZVtrZXldIHx8IG51bGw7CiAgICB9LAogICAgc2V0SXRlbTogKGtleSwgdmFsdWUpID0+IHsKICAgICAgc3RvcmVba2V5XSA9IHZhbHVlOwogICAgfSwKICAgIHJlbW92ZUl0ZW06IChrZXkpID0+IHsKICAgICAgZGVsZXRlIHN0b3JlW2tleV07CiAgICB9CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZSthdXRoLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL2F1dGgtanMvZGlzdC9tb2R1bGUvbGliL2xvY2tzLmpzCnZhciBpbnRlcm5hbHMgPSB7CiAgLyoqCiAgICogQGV4cGVyaW1lbnRhbAogICAqLwogIGRlYnVnOiAhIShnbG9iYWxUaGlzICYmIHN1cHBvcnRzTG9jYWxTdG9yYWdlKCkgJiYgZ2xvYmFsVGhpcy5sb2NhbFN0b3JhZ2UgJiYgZ2xvYmFsVGhpcy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbSgic3VwYWJhc2UuZ290cnVlLWpzLmxvY2tzLmRlYnVnIikgPT09ICJ0cnVlIikKfTsKdmFyIExvY2tBY3F1aXJlVGltZW91dEVycm9yID0gY2xhc3MgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSkgewogICAgc3VwZXIobWVzc2FnZSk7CiAgICB0aGlzLmlzQWNxdWlyZVRpbWVvdXQgPSB0cnVlOwogIH0KfTsKdmFyIE5hdmlnYXRvckxvY2tBY3F1aXJlVGltZW91dEVycm9yID0gY2xhc3MgZXh0ZW5kcyBMb2NrQWNxdWlyZVRpbWVvdXRFcnJvciB7Cn07CmFzeW5jIGZ1bmN0aW9uIG5hdmlnYXRvckxvY2sobmFtZSwgYWNxdWlyZVRpbWVvdXQsIGZuKSB7CiAgaWYgKGludGVybmFscy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coIkBzdXBhYmFzZS9nb3RydWUtanM6IG5hdmlnYXRvckxvY2s6IGFjcXVpcmUgbG9jayIsIG5hbWUsIGFjcXVpcmVUaW1lb3V0KTsKICB9CiAgY29uc3QgYWJvcnRDb250cm9sbGVyID0gbmV3IGdsb2JhbFRoaXMuQWJvcnRDb250cm9sbGVyKCk7CiAgaWYgKGFjcXVpcmVUaW1lb3V0ID4gMCkgewogICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgIGFib3J0Q29udHJvbGxlci5hYm9ydCgpOwogICAgICBpZiAoaW50ZXJuYWxzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coIkBzdXBhYmFzZS9nb3RydWUtanM6IG5hdmlnYXRvckxvY2sgYWNxdWlyZSB0aW1lZCBvdXQiLCBuYW1lKTsKICAgICAgfQogICAgfSwgYWNxdWlyZVRpbWVvdXQpOwogIH0KICBhd2FpdCBQcm9taXNlLnJlc29sdmUoKTsKICB0cnkgewogICAgcmV0dXJuIGF3YWl0IGdsb2JhbFRoaXMubmF2aWdhdG9yLmxvY2tzLnJlcXVlc3QobmFtZSwgYWNxdWlyZVRpbWVvdXQgPT09IDAgPyB7CiAgICAgIG1vZGU6ICJleGNsdXNpdmUiLAogICAgICBpZkF2YWlsYWJsZTogdHJ1ZQogICAgfSA6IHsKICAgICAgbW9kZTogImV4Y2x1c2l2ZSIsCiAgICAgIHNpZ25hbDogYWJvcnRDb250cm9sbGVyLnNpZ25hbAogICAgfSwgYXN5bmMgKGxvY2spID0+IHsKICAgICAgaWYgKGxvY2spIHsKICAgICAgICBpZiAoaW50ZXJuYWxzLmRlYnVnKSB7CiAgICAgICAgICBjb25zb2xlLmxvZygiQHN1cGFiYXNlL2dvdHJ1ZS1qczogbmF2aWdhdG9yTG9jazogYWNxdWlyZWQiLCBuYW1lLCBsb2NrLm5hbWUpOwogICAgICAgIH0KICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIGF3YWl0IGZuKCk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmIChpbnRlcm5hbHMuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coIkBzdXBhYmFzZS9nb3RydWUtanM6IG5hdmlnYXRvckxvY2s6IHJlbGVhc2VkIiwgbmFtZSwgbG9jay5uYW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGFjcXVpcmVUaW1lb3V0ID09PSAwKSB7CiAgICAgICAgICBpZiAoaW50ZXJuYWxzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJAc3VwYWJhc2UvZ290cnVlLWpzOiBuYXZpZ2F0b3JMb2NrOiBub3QgaW1tZWRpYXRlbHkgYXZhaWxhYmxlIiwgbmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgTmF2aWdhdG9yTG9ja0FjcXVpcmVUaW1lb3V0RXJyb3IoYEFjcXVpcmluZyBhbiBleGNsdXNpdmUgTmF2aWdhdG9yIExvY2tNYW5hZ2VyIGxvY2sgIiR7bmFtZX0iIGltbWVkaWF0ZWx5IGZhaWxlZGApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoaW50ZXJuYWxzLmRlYnVnKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2xvYmFsVGhpcy5uYXZpZ2F0b3IubG9ja3MucXVlcnkoKTsKICAgICAgICAgICAgICBjb25zb2xlLmxvZygiQHN1cGFiYXNlL2dvdHJ1ZS1qczogTmF2aWdhdG9yIExvY2tNYW5hZ2VyIHN0YXRlIiwgSlNPTi5zdHJpbmdpZnkocmVzdWx0LCBudWxsLCAiICAiKSk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkBzdXBhYmFzZS9nb3RydWUtanM6IEVycm9yIHdoZW4gcXVlcnlpbmcgTmF2aWdhdG9yIExvY2tNYW5hZ2VyIHN0YXRlIiwgZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNvbnNvbGUud2FybigiQHN1cGFiYXNlL2dvdHJ1ZS1qczogTmF2aWdhdG9yIExvY2tNYW5hZ2VyIHJldHVybmVkIGEgbnVsbCBsb2NrIHdoZW4gdXNpbmcgI3JlcXVlc3Qgd2l0aG91dCBpZkF2YWlsYWJsZSBzZXQgdG8gdHJ1ZSwgaXQgYXBwZWFycyB0aGlzIGJyb3dzZXIgaXMgbm90IGZvbGxvd2luZyB0aGUgTG9ja01hbmFnZXIgc3BlYyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvTG9ja01hbmFnZXIvcmVxdWVzdCIpOwogICAgICAgICAgcmV0dXJuIGF3YWl0IGZuKCk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9IGNhdGNoIChlKSB7CiAgICBpZiAoKGUgPT09IG51bGwgfHwgZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZS5uYW1lKSA9PT0gIkFib3J0RXJyb3IiKSB7CiAgICAgIHRocm93IG5ldyBOYXZpZ2F0b3JMb2NrQWNxdWlyZVRpbWVvdXRFcnJvcihgQWNxdWlyaW5nIGFuIGV4Y2x1c2l2ZSBOYXZpZ2F0b3IgTG9ja01hbmFnZXIgbG9jayAiJHtuYW1lfSIgdGltZWQgb3V0IHdhaXRpbmcgJHthY3F1aXJlVGltZW91dH1tc2ApOwogICAgfQogICAgdGhyb3cgZTsKICB9Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrYXV0aC1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9hdXRoLWpzL2Rpc3QvbW9kdWxlL2xpYi9wb2x5ZmlsbHMuanMKZnVuY3Rpb24gcG9seWZpbGxHbG9iYWxUaGlzKCkgewogIGlmICh0eXBlb2YgZ2xvYmFsVGhpcyA9PT0gIm9iamVjdCIpCiAgICByZXR1cm47CiAgdHJ5IHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShPYmplY3QucHJvdG90eXBlLCAiX19tYWdpY19fIiwgewogICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9LAogICAgICBjb25maWd1cmFibGU6IHRydWUKICAgIH0pOwogICAgX19tYWdpY19fLmdsb2JhbFRoaXMgPSBfX21hZ2ljX187CiAgICBkZWxldGUgT2JqZWN0LnByb3RvdHlwZS5fX21hZ2ljX187CiAgfSBjYXRjaCAoZSkgewogICAgaWYgKHR5cGVvZiBzZWxmICE9PSAidW5kZWZpbmVkIikgewogICAgICBzZWxmLmdsb2JhbFRoaXMgPSBzZWxmOwogICAgfQogIH0KfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZSthdXRoLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL2F1dGgtanMvZGlzdC9tb2R1bGUvbGliL3dlYjMvZXRoZXJldW0uanMKZnVuY3Rpb24gZ2V0QWRkcmVzcyhhZGRyZXNzKSB7CiAgaWYgKCEvXjB4W2EtZkEtRjAtOV17NDB9JC8udGVzdChhZGRyZXNzKSkgewogICAgdGhyb3cgbmV3IEVycm9yKGBAc3VwYWJhc2UvYXV0aC1qczogQWRkcmVzcyAiJHthZGRyZXNzfSIgaXMgaW52YWxpZC5gKTsKICB9CiAgcmV0dXJuIGFkZHJlc3MudG9Mb3dlckNhc2UoKTsKfQpmdW5jdGlvbiBmcm9tSGV4KGhleDIpIHsKICByZXR1cm4gcGFyc2VJbnQoaGV4MiwgMTYpOwp9CmZ1bmN0aW9uIHRvSGV4KHZhbHVlKSB7CiAgY29uc3QgYnl0ZXMgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUodmFsdWUpOwogIGNvbnN0IGhleDIgPSBBcnJheS5mcm9tKGJ5dGVzLCAoYnl0ZSkgPT4gYnl0ZS50b1N0cmluZygxNikucGFkU3RhcnQoMiwgIjAiKSkuam9pbigiIik7CiAgcmV0dXJuICIweCIgKyBoZXgyOwp9CmZ1bmN0aW9uIGNyZWF0ZVNpd2VNZXNzYWdlKHBhcmFtZXRlcnMpIHsKICB2YXIgX2E7CiAgY29uc3QgeyBjaGFpbklkLCBkb21haW4sIGV4cGlyYXRpb25UaW1lLCBpc3N1ZWRBdCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpLCBub25jZSwgbm90QmVmb3JlLCByZXF1ZXN0SWQsIHJlc291cmNlcywgc2NoZW1lLCB1cmksIHZlcnNpb246IHZlcnNpb242IH0gPSBwYXJhbWV0ZXJzOwogIHsKICAgIGlmICghTnVtYmVyLmlzSW50ZWdlcihjaGFpbklkKSkKICAgICAgdGhyb3cgbmV3IEVycm9yKGBAc3VwYWJhc2UvYXV0aC1qczogSW52YWxpZCBTSVdFIG1lc3NhZ2UgZmllbGQgImNoYWluSWQiLiBDaGFpbiBJRCBtdXN0IGJlIGEgRUlQLTE1NSBjaGFpbiBJRC4gUHJvdmlkZWQgdmFsdWU6ICR7Y2hhaW5JZH1gKTsKICAgIGlmICghZG9tYWluKQogICAgICB0aHJvdyBuZXcgRXJyb3IoYEBzdXBhYmFzZS9hdXRoLWpzOiBJbnZhbGlkIFNJV0UgbWVzc2FnZSBmaWVsZCAiZG9tYWluIi4gRG9tYWluIG11c3QgYmUgcHJvdmlkZWQuYCk7CiAgICBpZiAobm9uY2UgJiYgbm9uY2UubGVuZ3RoIDwgOCkKICAgICAgdGhyb3cgbmV3IEVycm9yKGBAc3VwYWJhc2UvYXV0aC1qczogSW52YWxpZCBTSVdFIG1lc3NhZ2UgZmllbGQgIm5vbmNlIi4gTm9uY2UgbXVzdCBiZSBhdCBsZWFzdCA4IGNoYXJhY3RlcnMuIFByb3ZpZGVkIHZhbHVlOiAke25vbmNlfWApOwogICAgaWYgKCF1cmkpCiAgICAgIHRocm93IG5ldyBFcnJvcihgQHN1cGFiYXNlL2F1dGgtanM6IEludmFsaWQgU0lXRSBtZXNzYWdlIGZpZWxkICJ1cmkiLiBVUkkgbXVzdCBiZSBwcm92aWRlZC5gKTsKICAgIGlmICh2ZXJzaW9uNiAhPT0gIjEiKQogICAgICB0aHJvdyBuZXcgRXJyb3IoYEBzdXBhYmFzZS9hdXRoLWpzOiBJbnZhbGlkIFNJV0UgbWVzc2FnZSBmaWVsZCAidmVyc2lvbiIuIFZlcnNpb24gbXVzdCBiZSAnMScuIFByb3ZpZGVkIHZhbHVlOiAke3ZlcnNpb242fWApOwogICAgaWYgKChfYSA9IHBhcmFtZXRlcnMuc3RhdGVtZW50KSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuaW5jbHVkZXMoIlxuIikpCiAgICAgIHRocm93IG5ldyBFcnJvcihgQHN1cGFiYXNlL2F1dGgtanM6IEludmFsaWQgU0lXRSBtZXNzYWdlIGZpZWxkICJzdGF0ZW1lbnQiLiBTdGF0ZW1lbnQgbXVzdCBub3QgaW5jbHVkZSAnXFxuJy4gUHJvdmlkZWQgdmFsdWU6ICR7cGFyYW1ldGVycy5zdGF0ZW1lbnR9YCk7CiAgfQogIGNvbnN0IGFkZHJlc3MgPSBnZXRBZGRyZXNzKHBhcmFtZXRlcnMuYWRkcmVzcyk7CiAgY29uc3Qgb3JpZ2luID0gc2NoZW1lID8gYCR7c2NoZW1lfTovLyR7ZG9tYWlufWAgOiBkb21haW47CiAgY29uc3Qgc3RhdGVtZW50ID0gcGFyYW1ldGVycy5zdGF0ZW1lbnQgPyBgJHtwYXJhbWV0ZXJzLnN0YXRlbWVudH0KYCA6ICIiOwogIGNvbnN0IHByZWZpeCA9IGAke29yaWdpbn0gd2FudHMgeW91IHRvIHNpZ24gaW4gd2l0aCB5b3VyIEV0aGVyZXVtIGFjY291bnQ6CiR7YWRkcmVzc30KCiR7c3RhdGVtZW50fWA7CiAgbGV0IHN1ZmZpeDIgPSBgVVJJOiAke3VyaX0KVmVyc2lvbjogJHt2ZXJzaW9uNn0KQ2hhaW4gSUQ6ICR7Y2hhaW5JZH0ke25vbmNlID8gYApOb25jZTogJHtub25jZX1gIDogIiJ9Cklzc3VlZCBBdDogJHtpc3N1ZWRBdC50b0lTT1N0cmluZygpfWA7CiAgaWYgKGV4cGlyYXRpb25UaW1lKQogICAgc3VmZml4MiArPSBgCkV4cGlyYXRpb24gVGltZTogJHtleHBpcmF0aW9uVGltZS50b0lTT1N0cmluZygpfWA7CiAgaWYgKG5vdEJlZm9yZSkKICAgIHN1ZmZpeDIgKz0gYApOb3QgQmVmb3JlOiAke25vdEJlZm9yZS50b0lTT1N0cmluZygpfWA7CiAgaWYgKHJlcXVlc3RJZCkKICAgIHN1ZmZpeDIgKz0gYApSZXF1ZXN0IElEOiAke3JlcXVlc3RJZH1gOwogIGlmIChyZXNvdXJjZXMpIHsKICAgIGxldCBjb250ZW50ID0gIlxuUmVzb3VyY2VzOiI7CiAgICBmb3IgKGNvbnN0IHJlc291cmNlIG9mIHJlc291cmNlcykgewogICAgICBpZiAoIXJlc291cmNlIHx8IHR5cGVvZiByZXNvdXJjZSAhPT0gInN0cmluZyIpCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBAc3VwYWJhc2UvYXV0aC1qczogSW52YWxpZCBTSVdFIG1lc3NhZ2UgZmllbGQgInJlc291cmNlcyIuIEV2ZXJ5IHJlc291cmNlIG11c3QgYmUgYSB2YWxpZCBzdHJpbmcuIFByb3ZpZGVkIHZhbHVlOiAke3Jlc291cmNlfWApOwogICAgICBjb250ZW50ICs9IGAKLSAke3Jlc291cmNlfWA7CiAgICB9CiAgICBzdWZmaXgyICs9IGNvbnRlbnQ7CiAgfQogIHJldHVybiBgJHtwcmVmaXh9CiR7c3VmZml4Mn1gOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK2F1dGgtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvYXV0aC1qcy9kaXN0L21vZHVsZS9saWIvd2ViYXV0aG4uZXJyb3JzLmpzCnZhciBXZWJBdXRobkVycm9yID0gY2xhc3MgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IoeyBtZXNzYWdlLCBjb2RlLCBjYXVzZSwgbmFtZSB9KSB7CiAgICB2YXIgX2E7CiAgICBzdXBlcihtZXNzYWdlLCB7IGNhdXNlIH0pOwogICAgdGhpcy5fX2lzV2ViQXV0aG5FcnJvciA9IHRydWU7CiAgICB0aGlzLm5hbWUgPSAoX2EgPSBuYW1lICE9PSBudWxsICYmIG5hbWUgIT09IHZvaWQgMCA/IG5hbWUgOiBjYXVzZSBpbnN0YW5jZW9mIEVycm9yID8gY2F1c2UubmFtZSA6IHZvaWQgMCkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogIlVua25vd24gRXJyb3IiOwogICAgdGhpcy5jb2RlID0gY29kZTsKICB9Cn07CnZhciBXZWJBdXRoblVua25vd25FcnJvciA9IGNsYXNzIGV4dGVuZHMgV2ViQXV0aG5FcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSwgb3JpZ2luYWxFcnJvcikgewogICAgc3VwZXIoewogICAgICBjb2RlOiAiRVJST1JfUEFTU1RIUk9VR0hfU0VFX0NBVVNFX1BST1BFUlRZIiwKICAgICAgY2F1c2U6IG9yaWdpbmFsRXJyb3IsCiAgICAgIG1lc3NhZ2UKICAgIH0pOwogICAgdGhpcy5uYW1lID0gIldlYkF1dGhuVW5rbm93bkVycm9yIjsKICAgIHRoaXMub3JpZ2luYWxFcnJvciA9IG9yaWdpbmFsRXJyb3I7CiAgfQp9OwpmdW5jdGlvbiBpZGVudGlmeVJlZ2lzdHJhdGlvbkVycm9yKHsgZXJyb3IsIG9wdGlvbnMgfSkgewogIHZhciBfYSwgX2IsIF9jOwogIGNvbnN0IHsgcHVibGljS2V5IH0gPSBvcHRpb25zOwogIGlmICghcHVibGljS2V5KSB7CiAgICB0aHJvdyBFcnJvcigib3B0aW9ucyB3YXMgbWlzc2luZyByZXF1aXJlZCBwdWJsaWNLZXkgcHJvcGVydHkiKTsKICB9CiAgaWYgKGVycm9yLm5hbWUgPT09ICJBYm9ydEVycm9yIikgewogICAgaWYgKG9wdGlvbnMuc2lnbmFsIGluc3RhbmNlb2YgQWJvcnRTaWduYWwpIHsKICAgICAgcmV0dXJuIG5ldyBXZWJBdXRobkVycm9yKHsKICAgICAgICBtZXNzYWdlOiAiUmVnaXN0cmF0aW9uIGNlcmVtb255IHdhcyBzZW50IGFuIGFib3J0IHNpZ25hbCIsCiAgICAgICAgY29kZTogIkVSUk9SX0NFUkVNT05ZX0FCT1JURUQiLAogICAgICAgIGNhdXNlOiBlcnJvcgogICAgICB9KTsKICAgIH0KICB9IGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICJDb25zdHJhaW50RXJyb3IiKSB7CiAgICBpZiAoKChfYSA9IHB1YmxpY0tleS5hdXRoZW50aWNhdG9yU2VsZWN0aW9uKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucmVxdWlyZVJlc2lkZW50S2V5KSA9PT0gdHJ1ZSkgewogICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgIG1lc3NhZ2U6ICJEaXNjb3ZlcmFibGUgY3JlZGVudGlhbHMgd2VyZSByZXF1aXJlZCBidXQgbm8gYXZhaWxhYmxlIGF1dGhlbnRpY2F0b3Igc3VwcG9ydGVkIGl0IiwKICAgICAgICBjb2RlOiAiRVJST1JfQVVUSEVOVElDQVRPUl9NSVNTSU5HX0RJU0NPVkVSQUJMRV9DUkVERU5USUFMX1NVUFBPUlQiLAogICAgICAgIGNhdXNlOiBlcnJvcgogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoCiAgICAgIC8vIEB0cy1pZ25vcmU6IGBtZWRpYXRpb25gIGRvZXNuJ3QgeWV0IGV4aXN0IG9uIENyZWRlbnRpYWxDcmVhdGlvbk9wdGlvbnMgYnV0IGl0J3MgcG9zc2libGUgYXMgb2YgU2VwdCAyMDI0CiAgICAgIG9wdGlvbnMubWVkaWF0aW9uID09PSAiY29uZGl0aW9uYWwiICYmICgoX2IgPSBwdWJsaWNLZXkuYXV0aGVudGljYXRvclNlbGVjdGlvbikgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnVzZXJWZXJpZmljYXRpb24pID09PSAicmVxdWlyZWQiCiAgICApIHsKICAgICAgcmV0dXJuIG5ldyBXZWJBdXRobkVycm9yKHsKICAgICAgICBtZXNzYWdlOiAiVXNlciB2ZXJpZmljYXRpb24gd2FzIHJlcXVpcmVkIGR1cmluZyBhdXRvbWF0aWMgcmVnaXN0cmF0aW9uIGJ1dCBpdCBjb3VsZCBub3QgYmUgcGVyZm9ybWVkIiwKICAgICAgICBjb2RlOiAiRVJST1JfQVVUT19SRUdJU1RFUl9VU0VSX1ZFUklGSUNBVElPTl9GQUlMVVJFIiwKICAgICAgICBjYXVzZTogZXJyb3IKICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKCgoX2MgPSBwdWJsaWNLZXkuYXV0aGVudGljYXRvclNlbGVjdGlvbikgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLnVzZXJWZXJpZmljYXRpb24pID09PSAicmVxdWlyZWQiKSB7CiAgICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgICAgbWVzc2FnZTogIlVzZXIgdmVyaWZpY2F0aW9uIHdhcyByZXF1aXJlZCBidXQgbm8gYXZhaWxhYmxlIGF1dGhlbnRpY2F0b3Igc3VwcG9ydGVkIGl0IiwKICAgICAgICBjb2RlOiAiRVJST1JfQVVUSEVOVElDQVRPUl9NSVNTSU5HX1VTRVJfVkVSSUZJQ0FUSU9OX1NVUFBPUlQiLAogICAgICAgIGNhdXNlOiBlcnJvcgogICAgICB9KTsKICAgIH0KICB9IGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICJJbnZhbGlkU3RhdGVFcnJvciIpIHsKICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgIG1lc3NhZ2U6ICJUaGUgYXV0aGVudGljYXRvciB3YXMgcHJldmlvdXNseSByZWdpc3RlcmVkIiwKICAgICAgY29kZTogIkVSUk9SX0FVVEhFTlRJQ0FUT1JfUFJFVklPVVNMWV9SRUdJU1RFUkVEIiwKICAgICAgY2F1c2U6IGVycm9yCiAgICB9KTsKICB9IGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICJOb3RBbGxvd2VkRXJyb3IiKSB7CiAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLAogICAgICBjb2RlOiAiRVJST1JfUEFTU1RIUk9VR0hfU0VFX0NBVVNFX1BST1BFUlRZIiwKICAgICAgY2F1c2U6IGVycm9yCiAgICB9KTsKICB9IGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICJOb3RTdXBwb3J0ZWRFcnJvciIpIHsKICAgIGNvbnN0IHZhbGlkUHViS2V5Q3JlZFBhcmFtcyA9IHB1YmxpY0tleS5wdWJLZXlDcmVkUGFyYW1zLmZpbHRlcigocGFyYW0pID0+IHBhcmFtLnR5cGUgPT09ICJwdWJsaWMta2V5Iik7CiAgICBpZiAodmFsaWRQdWJLZXlDcmVkUGFyYW1zLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgIG1lc3NhZ2U6ICdObyBlbnRyeSBpbiBwdWJLZXlDcmVkUGFyYW1zIHdhcyBvZiB0eXBlICJwdWJsaWMta2V5IicsCiAgICAgICAgY29kZTogIkVSUk9SX01BTEZPUk1FRF9QVUJLRVlDUkVEUEFSQU1TIiwKICAgICAgICBjYXVzZTogZXJyb3IKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICBtZXNzYWdlOiAiTm8gYXZhaWxhYmxlIGF1dGhlbnRpY2F0b3Igc3VwcG9ydGVkIGFueSBvZiB0aGUgc3BlY2lmaWVkIHB1YktleUNyZWRQYXJhbXMgYWxnb3JpdGhtcyIsCiAgICAgIGNvZGU6ICJFUlJPUl9BVVRIRU5USUNBVE9SX05PX1NVUFBPUlRFRF9QVUJLRVlDUkVEUEFSQU1TX0FMRyIsCiAgICAgIGNhdXNlOiBlcnJvcgogICAgfSk7CiAgfSBlbHNlIGlmIChlcnJvci5uYW1lID09PSAiU2VjdXJpdHlFcnJvciIpIHsKICAgIGNvbnN0IGVmZmVjdGl2ZURvbWFpbiA9IHdpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZTsKICAgIGlmICghaXNWYWxpZERvbWFpbihlZmZlY3RpdmVEb21haW4pKSB7CiAgICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgICAgbWVzc2FnZTogYCR7d2luZG93LmxvY2F0aW9uLmhvc3RuYW1lfSBpcyBhbiBpbnZhbGlkIGRvbWFpbmAsCiAgICAgICAgY29kZTogIkVSUk9SX0lOVkFMSURfRE9NQUlOIiwKICAgICAgICBjYXVzZTogZXJyb3IKICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKHB1YmxpY0tleS5ycC5pZCAhPT0gZWZmZWN0aXZlRG9tYWluKSB7CiAgICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgICAgbWVzc2FnZTogYFRoZSBSUCBJRCAiJHtwdWJsaWNLZXkucnAuaWR9IiBpcyBpbnZhbGlkIGZvciB0aGlzIGRvbWFpbmAsCiAgICAgICAgY29kZTogIkVSUk9SX0lOVkFMSURfUlBfSUQiLAogICAgICAgIGNhdXNlOiBlcnJvcgogICAgICB9KTsKICAgIH0KICB9IGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICJUeXBlRXJyb3IiKSB7CiAgICBpZiAocHVibGljS2V5LnVzZXIuaWQuYnl0ZUxlbmd0aCA8IDEgfHwgcHVibGljS2V5LnVzZXIuaWQuYnl0ZUxlbmd0aCA+IDY0KSB7CiAgICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgICAgbWVzc2FnZTogIlVzZXIgSUQgd2FzIG5vdCBiZXR3ZWVuIDEgYW5kIDY0IGNoYXJhY3RlcnMiLAogICAgICAgIGNvZGU6ICJFUlJPUl9JTlZBTElEX1VTRVJfSURfTEVOR1RIIiwKICAgICAgICBjYXVzZTogZXJyb3IKICAgICAgfSk7CiAgICB9CiAgfSBlbHNlIGlmIChlcnJvci5uYW1lID09PSAiVW5rbm93bkVycm9yIikgewogICAgcmV0dXJuIG5ldyBXZWJBdXRobkVycm9yKHsKICAgICAgbWVzc2FnZTogIlRoZSBhdXRoZW50aWNhdG9yIHdhcyB1bmFibGUgdG8gcHJvY2VzcyB0aGUgc3BlY2lmaWVkIG9wdGlvbnMsIG9yIGNvdWxkIG5vdCBjcmVhdGUgYSBuZXcgY3JlZGVudGlhbCIsCiAgICAgIGNvZGU6ICJFUlJPUl9BVVRIRU5USUNBVE9SX0dFTkVSQUxfRVJST1IiLAogICAgICBjYXVzZTogZXJyb3IKICAgIH0pOwogIH0KICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgbWVzc2FnZTogImEgTm9uLVdlYmF1dGhuIHJlbGF0ZWQgZXJyb3IgaGFzIG9jY3VycmVkIiwKICAgIGNvZGU6ICJFUlJPUl9QQVNTVEhST1VHSF9TRUVfQ0FVU0VfUFJPUEVSVFkiLAogICAgY2F1c2U6IGVycm9yCiAgfSk7Cn0KZnVuY3Rpb24gaWRlbnRpZnlBdXRoZW50aWNhdGlvbkVycm9yKHsgZXJyb3IsIG9wdGlvbnMgfSkgewogIGNvbnN0IHsgcHVibGljS2V5IH0gPSBvcHRpb25zOwogIGlmICghcHVibGljS2V5KSB7CiAgICB0aHJvdyBFcnJvcigib3B0aW9ucyB3YXMgbWlzc2luZyByZXF1aXJlZCBwdWJsaWNLZXkgcHJvcGVydHkiKTsKICB9CiAgaWYgKGVycm9yLm5hbWUgPT09ICJBYm9ydEVycm9yIikgewogICAgaWYgKG9wdGlvbnMuc2lnbmFsIGluc3RhbmNlb2YgQWJvcnRTaWduYWwpIHsKICAgICAgcmV0dXJuIG5ldyBXZWJBdXRobkVycm9yKHsKICAgICAgICBtZXNzYWdlOiAiQXV0aGVudGljYXRpb24gY2VyZW1vbnkgd2FzIHNlbnQgYW4gYWJvcnQgc2lnbmFsIiwKICAgICAgICBjb2RlOiAiRVJST1JfQ0VSRU1PTllfQUJPUlRFRCIsCiAgICAgICAgY2F1c2U6IGVycm9yCiAgICAgIH0pOwogICAgfQogIH0gZWxzZSBpZiAoZXJyb3IubmFtZSA9PT0gIk5vdEFsbG93ZWRFcnJvciIpIHsKICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsCiAgICAgIGNvZGU6ICJFUlJPUl9QQVNTVEhST1VHSF9TRUVfQ0FVU0VfUFJPUEVSVFkiLAogICAgICBjYXVzZTogZXJyb3IKICAgIH0pOwogIH0gZWxzZSBpZiAoZXJyb3IubmFtZSA9PT0gIlNlY3VyaXR5RXJyb3IiKSB7CiAgICBjb25zdCBlZmZlY3RpdmVEb21haW4gPSB3aW5kb3cubG9jYXRpb24uaG9zdG5hbWU7CiAgICBpZiAoIWlzVmFsaWREb21haW4oZWZmZWN0aXZlRG9tYWluKSkgewogICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgIG1lc3NhZ2U6IGAke3dpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZX0gaXMgYW4gaW52YWxpZCBkb21haW5gLAogICAgICAgIGNvZGU6ICJFUlJPUl9JTlZBTElEX0RPTUFJTiIsCiAgICAgICAgY2F1c2U6IGVycm9yCiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChwdWJsaWNLZXkucnBJZCAhPT0gZWZmZWN0aXZlRG9tYWluKSB7CiAgICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgICAgbWVzc2FnZTogYFRoZSBSUCBJRCAiJHtwdWJsaWNLZXkucnBJZH0iIGlzIGludmFsaWQgZm9yIHRoaXMgZG9tYWluYCwKICAgICAgICBjb2RlOiAiRVJST1JfSU5WQUxJRF9SUF9JRCIsCiAgICAgICAgY2F1c2U6IGVycm9yCiAgICAgIH0pOwogICAgfQogIH0gZWxzZSBpZiAoZXJyb3IubmFtZSA9PT0gIlVua25vd25FcnJvciIpIHsKICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgIG1lc3NhZ2U6ICJUaGUgYXV0aGVudGljYXRvciB3YXMgdW5hYmxlIHRvIHByb2Nlc3MgdGhlIHNwZWNpZmllZCBvcHRpb25zLCBvciBjb3VsZCBub3QgY3JlYXRlIGEgbmV3IGFzc2VydGlvbiBzaWduYXR1cmUiLAogICAgICBjb2RlOiAiRVJST1JfQVVUSEVOVElDQVRPUl9HRU5FUkFMX0VSUk9SIiwKICAgICAgY2F1c2U6IGVycm9yCiAgICB9KTsKICB9CiAgcmV0dXJuIG5ldyBXZWJBdXRobkVycm9yKHsKICAgIG1lc3NhZ2U6ICJhIE5vbi1XZWJhdXRobiByZWxhdGVkIGVycm9yIGhhcyBvY2N1cnJlZCIsCiAgICBjb2RlOiAiRVJST1JfUEFTU1RIUk9VR0hfU0VFX0NBVVNFX1BST1BFUlRZIiwKICAgIGNhdXNlOiBlcnJvcgogIH0pOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK2F1dGgtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvYXV0aC1qcy9kaXN0L21vZHVsZS9saWIvd2ViYXV0aG4uanMKdmFyIFdlYkF1dGhuQWJvcnRTZXJ2aWNlID0gY2xhc3MgewogIC8qKgogICAqIENyZWF0ZSBhbiBhYm9ydCBzaWduYWwgZm9yIGEgbmV3IFdlYkF1dGhuIG9wZXJhdGlvbi4KICAgKiBBdXRvbWF0aWNhbGx5IGNhbmNlbHMgYW55IGV4aXN0aW5nIG9wZXJhdGlvbi4KICAgKgogICAqIEByZXR1cm5zIHtBYm9ydFNpZ25hbH0gU2lnbmFsIHRvIHBhc3MgdG8gbmF2aWdhdG9yLmNyZWRlbnRpYWxzLmNyZWF0ZSgpIG9yIC5nZXQoKQogICAqIEBzZWUge0BsaW5rIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9BYm9ydFNpZ25hbCBNRE4gLSBBYm9ydFNpZ25hbH0KICAgKi8KICBjcmVhdGVOZXdBYm9ydFNpZ25hbCgpIHsKICAgIGlmICh0aGlzLmNvbnRyb2xsZXIpIHsKICAgICAgY29uc3QgYWJvcnRFcnJvciA9IG5ldyBFcnJvcigiQ2FuY2VsbGluZyBleGlzdGluZyBXZWJBdXRobiBBUEkgY2FsbCBmb3IgbmV3IG9uZSIpOwogICAgICBhYm9ydEVycm9yLm5hbWUgPSAiQWJvcnRFcnJvciI7CiAgICAgIHRoaXMuY29udHJvbGxlci5hYm9ydChhYm9ydEVycm9yKTsKICAgIH0KICAgIGNvbnN0IG5ld0NvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICB0aGlzLmNvbnRyb2xsZXIgPSBuZXdDb250cm9sbGVyOwogICAgcmV0dXJuIG5ld0NvbnRyb2xsZXIuc2lnbmFsOwogIH0KICAvKioKICAgKiBNYW51YWxseSBjYW5jZWwgdGhlIGN1cnJlbnQgV2ViQXV0aG4gb3BlcmF0aW9uLgogICAqIFVzZWZ1bCBmb3IgY2xlYW5pbmcgdXAgd2hlbiB1c2VyIGNhbmNlbHMgb3IgbmF2aWdhdGVzIGF3YXkuCiAgICoKICAgKiBAc2VlIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvQWJvcnRDb250cm9sbGVyL2Fib3J0IE1ETiAtIEFib3J0Q29udHJvbGxlci5hYm9ydH0KICAgKi8KICBjYW5jZWxDZXJlbW9ueSgpIHsKICAgIGlmICh0aGlzLmNvbnRyb2xsZXIpIHsKICAgICAgY29uc3QgYWJvcnRFcnJvciA9IG5ldyBFcnJvcigiTWFudWFsbHkgY2FuY2VsbGluZyBleGlzdGluZyBXZWJBdXRobiBBUEkgY2FsbCIpOwogICAgICBhYm9ydEVycm9yLm5hbWUgPSAiQWJvcnRFcnJvciI7CiAgICAgIHRoaXMuY29udHJvbGxlci5hYm9ydChhYm9ydEVycm9yKTsKICAgICAgdGhpcy5jb250cm9sbGVyID0gdm9pZCAwOwogICAgfQogIH0KfTsKdmFyIHdlYkF1dGhuQWJvcnRTZXJ2aWNlID0gbmV3IFdlYkF1dGhuQWJvcnRTZXJ2aWNlKCk7CmZ1bmN0aW9uIGRlc2VyaWFsaXplQ3JlZGVudGlhbENyZWF0aW9uT3B0aW9ucyhvcHRpb25zKSB7CiAgaWYgKCFvcHRpb25zKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkNyZWRlbnRpYWwgY3JlYXRpb24gb3B0aW9ucyBhcmUgcmVxdWlyZWQiKTsKICB9CiAgaWYgKHR5cGVvZiBQdWJsaWNLZXlDcmVkZW50aWFsICE9PSAidW5kZWZpbmVkIiAmJiAicGFyc2VDcmVhdGlvbk9wdGlvbnNGcm9tSlNPTiIgaW4gUHVibGljS2V5Q3JlZGVudGlhbCAmJiB0eXBlb2YgUHVibGljS2V5Q3JlZGVudGlhbC5wYXJzZUNyZWF0aW9uT3B0aW9uc0Zyb21KU09OID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gUHVibGljS2V5Q3JlZGVudGlhbC5wYXJzZUNyZWF0aW9uT3B0aW9uc0Zyb21KU09OKAogICAgICAvKiogd2UgYXNzZXJ0IHRoZSBvcHRpb25zIGhlcmUgYXMgdHlwZXNjcmlwdCBzdGlsbCBkb2Vzbid0IGtub3cgYWJvdXQgZnV0dXJlIHdlYmF1dGhuIHR5cGVzICovCiAgICAgIG9wdGlvbnMKICAgICk7CiAgfQogIGNvbnN0IHsgY2hhbGxlbmdlOiBjaGFsbGVuZ2VTdHIsIHVzZXI6IHVzZXJPcHRzLCBleGNsdWRlQ3JlZGVudGlhbHMgfSA9IG9wdGlvbnMsIHJlc3RPcHRpb25zID0gX19yZXN0KAogICAgb3B0aW9ucywKICAgIFsiY2hhbGxlbmdlIiwgInVzZXIiLCAiZXhjbHVkZUNyZWRlbnRpYWxzIl0KICApOwogIGNvbnN0IGNoYWxsZW5nZSA9IGJhc2U2NFVybFRvVWludDhBcnJheShjaGFsbGVuZ2VTdHIpLmJ1ZmZlcjsKICBjb25zdCB1c2VyID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCB1c2VyT3B0cyksIHsgaWQ6IGJhc2U2NFVybFRvVWludDhBcnJheSh1c2VyT3B0cy5pZCkuYnVmZmVyIH0pOwogIGNvbnN0IHJlc3VsdCA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgcmVzdE9wdGlvbnMpLCB7CiAgICBjaGFsbGVuZ2UsCiAgICB1c2VyCiAgfSk7CiAgaWYgKGV4Y2x1ZGVDcmVkZW50aWFscyAmJiBleGNsdWRlQ3JlZGVudGlhbHMubGVuZ3RoID4gMCkgewogICAgcmVzdWx0LmV4Y2x1ZGVDcmVkZW50aWFscyA9IG5ldyBBcnJheShleGNsdWRlQ3JlZGVudGlhbHMubGVuZ3RoKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZXhjbHVkZUNyZWRlbnRpYWxzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGNyZWQgPSBleGNsdWRlQ3JlZGVudGlhbHNbaV07CiAgICAgIHJlc3VsdC5leGNsdWRlQ3JlZGVudGlhbHNbaV0gPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIGNyZWQpLCB7CiAgICAgICAgaWQ6IGJhc2U2NFVybFRvVWludDhBcnJheShjcmVkLmlkKS5idWZmZXIsCiAgICAgICAgdHlwZTogY3JlZC50eXBlIHx8ICJwdWJsaWMta2V5IiwKICAgICAgICAvLyBDYXN0IHRyYW5zcG9ydHMgdG8gaGFuZGxlIGZ1dHVyZSB0cmFuc3BvcnQgdHlwZXMgbGlrZSAiY2FibGUiCiAgICAgICAgdHJhbnNwb3J0czogY3JlZC50cmFuc3BvcnRzCiAgICAgIH0pOwogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIGRlc2VyaWFsaXplQ3JlZGVudGlhbFJlcXVlc3RPcHRpb25zKG9wdGlvbnMpIHsKICBpZiAoIW9wdGlvbnMpIHsKICAgIHRocm93IG5ldyBFcnJvcigiQ3JlZGVudGlhbCByZXF1ZXN0IG9wdGlvbnMgYXJlIHJlcXVpcmVkIik7CiAgfQogIGlmICh0eXBlb2YgUHVibGljS2V5Q3JlZGVudGlhbCAhPT0gInVuZGVmaW5lZCIgJiYgInBhcnNlUmVxdWVzdE9wdGlvbnNGcm9tSlNPTiIgaW4gUHVibGljS2V5Q3JlZGVudGlhbCAmJiB0eXBlb2YgUHVibGljS2V5Q3JlZGVudGlhbC5wYXJzZVJlcXVlc3RPcHRpb25zRnJvbUpTT04gPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBQdWJsaWNLZXlDcmVkZW50aWFsLnBhcnNlUmVxdWVzdE9wdGlvbnNGcm9tSlNPTihvcHRpb25zKTsKICB9CiAgY29uc3QgeyBjaGFsbGVuZ2U6IGNoYWxsZW5nZVN0ciwgYWxsb3dDcmVkZW50aWFscyB9ID0gb3B0aW9ucywgcmVzdE9wdGlvbnMgPSBfX3Jlc3QoCiAgICBvcHRpb25zLAogICAgWyJjaGFsbGVuZ2UiLCAiYWxsb3dDcmVkZW50aWFscyJdCiAgKTsKICBjb25zdCBjaGFsbGVuZ2UgPSBiYXNlNjRVcmxUb1VpbnQ4QXJyYXkoY2hhbGxlbmdlU3RyKS5idWZmZXI7CiAgY29uc3QgcmVzdWx0ID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCByZXN0T3B0aW9ucyksIHsgY2hhbGxlbmdlIH0pOwogIGlmIChhbGxvd0NyZWRlbnRpYWxzICYmIGFsbG93Q3JlZGVudGlhbHMubGVuZ3RoID4gMCkgewogICAgcmVzdWx0LmFsbG93Q3JlZGVudGlhbHMgPSBuZXcgQXJyYXkoYWxsb3dDcmVkZW50aWFscy5sZW5ndGgpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhbGxvd0NyZWRlbnRpYWxzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGNyZWQgPSBhbGxvd0NyZWRlbnRpYWxzW2ldOwogICAgICByZXN1bHQuYWxsb3dDcmVkZW50aWFsc1tpXSA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgY3JlZCksIHsKICAgICAgICBpZDogYmFzZTY0VXJsVG9VaW50OEFycmF5KGNyZWQuaWQpLmJ1ZmZlciwKICAgICAgICB0eXBlOiBjcmVkLnR5cGUgfHwgInB1YmxpYy1rZXkiLAogICAgICAgIC8vIENhc3QgdHJhbnNwb3J0cyB0byBoYW5kbGUgZnV0dXJlIHRyYW5zcG9ydCB0eXBlcyBsaWtlICJjYWJsZSIKICAgICAgICB0cmFuc3BvcnRzOiBjcmVkLnRyYW5zcG9ydHMKICAgICAgfSk7CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gc2VyaWFsaXplQ3JlZGVudGlhbENyZWF0aW9uUmVzcG9uc2UoY3JlZGVudGlhbCkgewogIHZhciBfYTsKICBpZiAoInRvSlNPTiIgaW4gY3JlZGVudGlhbCAmJiB0eXBlb2YgY3JlZGVudGlhbC50b0pTT04gPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBjcmVkZW50aWFsLnRvSlNPTigpOwogIH0KICBjb25zdCBjcmVkZW50aWFsV2l0aEF0dGFjaG1lbnQgPSBjcmVkZW50aWFsOwogIHJldHVybiB7CiAgICBpZDogY3JlZGVudGlhbC5pZCwKICAgIHJhd0lkOiBjcmVkZW50aWFsLmlkLAogICAgcmVzcG9uc2U6IHsKICAgICAgYXR0ZXN0YXRpb25PYmplY3Q6IGJ5dGVzVG9CYXNlNjRVUkwobmV3IFVpbnQ4QXJyYXkoY3JlZGVudGlhbC5yZXNwb25zZS5hdHRlc3RhdGlvbk9iamVjdCkpLAogICAgICBjbGllbnREYXRhSlNPTjogYnl0ZXNUb0Jhc2U2NFVSTChuZXcgVWludDhBcnJheShjcmVkZW50aWFsLnJlc3BvbnNlLmNsaWVudERhdGFKU09OKSkKICAgIH0sCiAgICB0eXBlOiAicHVibGljLWtleSIsCiAgICBjbGllbnRFeHRlbnNpb25SZXN1bHRzOiBjcmVkZW50aWFsLmdldENsaWVudEV4dGVuc2lvblJlc3VsdHMoKSwKICAgIC8vIENvbnZlcnQgbnVsbCB0byB1bmRlZmluZWQgYW5kIGNhc3QgdG8gQXV0aGVudGljYXRvckF0dGFjaG1lbnQgdHlwZQogICAgYXV0aGVudGljYXRvckF0dGFjaG1lbnQ6IChfYSA9IGNyZWRlbnRpYWxXaXRoQXR0YWNobWVudC5hdXRoZW50aWNhdG9yQXR0YWNobWVudCkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogdm9pZCAwCiAgfTsKfQpmdW5jdGlvbiBzZXJpYWxpemVDcmVkZW50aWFsUmVxdWVzdFJlc3BvbnNlKGNyZWRlbnRpYWwpIHsKICB2YXIgX2E7CiAgaWYgKCJ0b0pTT04iIGluIGNyZWRlbnRpYWwgJiYgdHlwZW9mIGNyZWRlbnRpYWwudG9KU09OID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gY3JlZGVudGlhbC50b0pTT04oKTsKICB9CiAgY29uc3QgY3JlZGVudGlhbFdpdGhBdHRhY2htZW50ID0gY3JlZGVudGlhbDsKICBjb25zdCBjbGllbnRFeHRlbnNpb25SZXN1bHRzID0gY3JlZGVudGlhbC5nZXRDbGllbnRFeHRlbnNpb25SZXN1bHRzKCk7CiAgY29uc3QgYXNzZXJ0aW9uUmVzcG9uc2UgPSBjcmVkZW50aWFsLnJlc3BvbnNlOwogIHJldHVybiB7CiAgICBpZDogY3JlZGVudGlhbC5pZCwKICAgIHJhd0lkOiBjcmVkZW50aWFsLmlkLAogICAgLy8gVzNDIHNwZWMgZXhwZWN0cyByYXdJZCB0byBtYXRjaCBpZCBmb3IgSlNPTiBmb3JtYXQKICAgIHJlc3BvbnNlOiB7CiAgICAgIGF1dGhlbnRpY2F0b3JEYXRhOiBieXRlc1RvQmFzZTY0VVJMKG5ldyBVaW50OEFycmF5KGFzc2VydGlvblJlc3BvbnNlLmF1dGhlbnRpY2F0b3JEYXRhKSksCiAgICAgIGNsaWVudERhdGFKU09OOiBieXRlc1RvQmFzZTY0VVJMKG5ldyBVaW50OEFycmF5KGFzc2VydGlvblJlc3BvbnNlLmNsaWVudERhdGFKU09OKSksCiAgICAgIHNpZ25hdHVyZTogYnl0ZXNUb0Jhc2U2NFVSTChuZXcgVWludDhBcnJheShhc3NlcnRpb25SZXNwb25zZS5zaWduYXR1cmUpKSwKICAgICAgdXNlckhhbmRsZTogYXNzZXJ0aW9uUmVzcG9uc2UudXNlckhhbmRsZSA/IGJ5dGVzVG9CYXNlNjRVUkwobmV3IFVpbnQ4QXJyYXkoYXNzZXJ0aW9uUmVzcG9uc2UudXNlckhhbmRsZSkpIDogdm9pZCAwCiAgICB9LAogICAgdHlwZTogInB1YmxpYy1rZXkiLAogICAgY2xpZW50RXh0ZW5zaW9uUmVzdWx0cywKICAgIC8vIENvbnZlcnQgbnVsbCB0byB1bmRlZmluZWQgYW5kIGNhc3QgdG8gQXV0aGVudGljYXRvckF0dGFjaG1lbnQgdHlwZQogICAgYXV0aGVudGljYXRvckF0dGFjaG1lbnQ6IChfYSA9IGNyZWRlbnRpYWxXaXRoQXR0YWNobWVudC5hdXRoZW50aWNhdG9yQXR0YWNobWVudCkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogdm9pZCAwCiAgfTsKfQpmdW5jdGlvbiBpc1ZhbGlkRG9tYWluKGhvc3RuYW1lKSB7CiAgcmV0dXJuICgKICAgIC8vIENvbnNpZGVyIGxvY2FsaG9zdCB2YWxpZCBhcyB3ZWxsIHNpbmNlIGl0J3Mgb2theSB3cnQgU2VjdXJlIENvbnRleHRzCiAgICBob3N0bmFtZSA9PT0gImxvY2FsaG9zdCIgfHwgL14oW2EtejAtOV0rKC1bYS16MC05XSspKlwuKStbYS16XXsyLH0kL2kudGVzdChob3N0bmFtZSkKICApOwp9CmZ1bmN0aW9uIGJyb3dzZXJTdXBwb3J0c1dlYkF1dGhuKCkgewogIHZhciBfYSwgX2I7CiAgcmV0dXJuICEhKGlzQnJvd3NlcigpICYmICJQdWJsaWNLZXlDcmVkZW50aWFsIiBpbiB3aW5kb3cgJiYgd2luZG93LlB1YmxpY0tleUNyZWRlbnRpYWwgJiYgImNyZWRlbnRpYWxzIiBpbiBuYXZpZ2F0b3IgJiYgdHlwZW9mICgoX2EgPSBuYXZpZ2F0b3IgPT09IG51bGwgfHwgbmF2aWdhdG9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBuYXZpZ2F0b3IuY3JlZGVudGlhbHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jcmVhdGUpID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiAoKF9iID0gbmF2aWdhdG9yID09PSBudWxsIHx8IG5hdmlnYXRvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogbmF2aWdhdG9yLmNyZWRlbnRpYWxzKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuZ2V0KSA9PT0gImZ1bmN0aW9uIik7Cn0KYXN5bmMgZnVuY3Rpb24gY3JlYXRlQ3JlZGVudGlhbChvcHRpb25zKSB7CiAgdHJ5IHsKICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgbmF2aWdhdG9yLmNyZWRlbnRpYWxzLmNyZWF0ZSgKICAgICAgLyoqIHdlIGFzc2VydCB0aGUgdHlwZSBoZXJlIHVudGlsIHR5cGVzY3JpcHQgdHlwZXMgYXJlIHVwZGF0ZWQgKi8KICAgICAgb3B0aW9ucwogICAgKTsKICAgIGlmICghcmVzcG9uc2UpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiBudWxsLAogICAgICAgIGVycm9yOiBuZXcgV2ViQXV0aG5Vbmtub3duRXJyb3IoIkVtcHR5IGNyZWRlbnRpYWwgcmVzcG9uc2UiLCByZXNwb25zZSkKICAgICAgfTsKICAgIH0KICAgIGlmICghKHJlc3BvbnNlIGluc3RhbmNlb2YgUHVibGljS2V5Q3JlZGVudGlhbCkpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiBudWxsLAogICAgICAgIGVycm9yOiBuZXcgV2ViQXV0aG5Vbmtub3duRXJyb3IoIkJyb3dzZXIgcmV0dXJuZWQgdW5leHBlY3RlZCBjcmVkZW50aWFsIHR5cGUiLCByZXNwb25zZSkKICAgICAgfTsKICAgIH0KICAgIHJldHVybiB7IGRhdGE6IHJlc3BvbnNlLCBlcnJvcjogbnVsbCB9OwogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIHsKICAgICAgZGF0YTogbnVsbCwKICAgICAgZXJyb3I6IGlkZW50aWZ5UmVnaXN0cmF0aW9uRXJyb3IoewogICAgICAgIGVycm9yOiBlcnIsCiAgICAgICAgb3B0aW9ucwogICAgICB9KQogICAgfTsKICB9Cn0KYXN5bmMgZnVuY3Rpb24gZ2V0Q3JlZGVudGlhbChvcHRpb25zKSB7CiAgdHJ5IHsKICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgbmF2aWdhdG9yLmNyZWRlbnRpYWxzLmdldCgKICAgICAgLyoqIHdlIGFzc2VydCB0aGUgdHlwZSBoZXJlIHVudGlsIHR5cGVzY3JpcHQgdHlwZXMgYXJlIHVwZGF0ZWQgKi8KICAgICAgb3B0aW9ucwogICAgKTsKICAgIGlmICghcmVzcG9uc2UpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiBudWxsLAogICAgICAgIGVycm9yOiBuZXcgV2ViQXV0aG5Vbmtub3duRXJyb3IoIkVtcHR5IGNyZWRlbnRpYWwgcmVzcG9uc2UiLCByZXNwb25zZSkKICAgICAgfTsKICAgIH0KICAgIGlmICghKHJlc3BvbnNlIGluc3RhbmNlb2YgUHVibGljS2V5Q3JlZGVudGlhbCkpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiBudWxsLAogICAgICAgIGVycm9yOiBuZXcgV2ViQXV0aG5Vbmtub3duRXJyb3IoIkJyb3dzZXIgcmV0dXJuZWQgdW5leHBlY3RlZCBjcmVkZW50aWFsIHR5cGUiLCByZXNwb25zZSkKICAgICAgfTsKICAgIH0KICAgIHJldHVybiB7IGRhdGE6IHJlc3BvbnNlLCBlcnJvcjogbnVsbCB9OwogIH0gY2F0Y2ggKGVycikgewogICAgcmV0dXJuIHsKICAgICAgZGF0YTogbnVsbCwKICAgICAgZXJyb3I6IGlkZW50aWZ5QXV0aGVudGljYXRpb25FcnJvcih7CiAgICAgICAgZXJyb3I6IGVyciwKICAgICAgICBvcHRpb25zCiAgICAgIH0pCiAgICB9OwogIH0KfQp2YXIgREVGQVVMVF9DUkVBVElPTl9PUFRJT05TID0gewogIGhpbnRzOiBbInNlY3VyaXR5LWtleSJdLAogIGF1dGhlbnRpY2F0b3JTZWxlY3Rpb246IHsKICAgIGF1dGhlbnRpY2F0b3JBdHRhY2htZW50OiAiY3Jvc3MtcGxhdGZvcm0iLAogICAgcmVxdWlyZVJlc2lkZW50S2V5OiBmYWxzZSwKICAgIC8qKiBzZXQgdG8gcHJlZmVycmVkIGJlY2F1c2Ugb2xkZXIgeXViaWtleXMgZG9uJ3QgaGF2ZSBQSU4vQmlvbWV0cmljICovCiAgICB1c2VyVmVyaWZpY2F0aW9uOiAicHJlZmVycmVkIiwKICAgIHJlc2lkZW50S2V5OiAiZGlzY291cmFnZWQiCiAgfSwKICBhdHRlc3RhdGlvbjogImRpcmVjdCIKfTsKdmFyIERFRkFVTFRfUkVRVUVTVF9PUFRJT05TID0gewogIC8qKiBzZXQgdG8gcHJlZmVycmVkIGJlY2F1c2Ugb2xkZXIgeXViaWtleXMgZG9uJ3QgaGF2ZSBQSU4vQmlvbWV0cmljICovCiAgdXNlclZlcmlmaWNhdGlvbjogInByZWZlcnJlZCIsCiAgaGludHM6IFsic2VjdXJpdHkta2V5Il0sCiAgYXR0ZXN0YXRpb246ICJkaXJlY3QiCn07CmZ1bmN0aW9uIGRlZXBNZXJnZSguLi5zb3VyY2VzKSB7CiAgY29uc3QgaXNPYmplY3QgPSAodmFsKSA9PiB2YWwgIT09IG51bGwgJiYgdHlwZW9mIHZhbCA9PT0gIm9iamVjdCIgJiYgIUFycmF5LmlzQXJyYXkodmFsKTsKICBjb25zdCBpc0FycmF5QnVmZmVyTGlrZSA9ICh2YWwpID0+IHZhbCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyIHx8IEFycmF5QnVmZmVyLmlzVmlldyh2YWwpOwogIGNvbnN0IHJlc3VsdCA9IHt9OwogIGZvciAoY29uc3Qgc291cmNlIG9mIHNvdXJjZXMpIHsKICAgIGlmICghc291cmNlKQogICAgICBjb250aW51ZTsKICAgIGZvciAoY29uc3Qga2V5IGluIHNvdXJjZSkgewogICAgICBjb25zdCB2YWx1ZSA9IHNvdXJjZVtrZXldOwogICAgICBpZiAodmFsdWUgPT09IHZvaWQgMCkKICAgICAgICBjb250aW51ZTsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICAgICAgfSBlbHNlIGlmIChpc0FycmF5QnVmZmVyTGlrZSh2YWx1ZSkpIHsKICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogICAgICB9IGVsc2UgaWYgKGlzT2JqZWN0KHZhbHVlKSkgewogICAgICAgIGNvbnN0IGV4aXN0aW5nID0gcmVzdWx0W2tleV07CiAgICAgICAgaWYgKGlzT2JqZWN0KGV4aXN0aW5nKSkgewogICAgICAgICAgcmVzdWx0W2tleV0gPSBkZWVwTWVyZ2UoZXhpc3RpbmcsIHZhbHVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmVzdWx0W2tleV0gPSBkZWVwTWVyZ2UodmFsdWUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gbWVyZ2VDcmVkZW50aWFsQ3JlYXRpb25PcHRpb25zKGJhc2VPcHRpb25zLCBvdmVycmlkZXMpIHsKICByZXR1cm4gZGVlcE1lcmdlKERFRkFVTFRfQ1JFQVRJT05fT1BUSU9OUywgYmFzZU9wdGlvbnMsIG92ZXJyaWRlcyB8fCB7fSk7Cn0KZnVuY3Rpb24gbWVyZ2VDcmVkZW50aWFsUmVxdWVzdE9wdGlvbnMoYmFzZU9wdGlvbnMsIG92ZXJyaWRlcykgewogIHJldHVybiBkZWVwTWVyZ2UoREVGQVVMVF9SRVFVRVNUX09QVElPTlMsIGJhc2VPcHRpb25zLCBvdmVycmlkZXMgfHwge30pOwp9CnZhciBXZWJBdXRobkFwaSA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihjbGllbnQpIHsKICAgIHRoaXMuY2xpZW50ID0gY2xpZW50OwogICAgdGhpcy5lbnJvbGwgPSB0aGlzLl9lbnJvbGwuYmluZCh0aGlzKTsKICAgIHRoaXMuY2hhbGxlbmdlID0gdGhpcy5fY2hhbGxlbmdlLmJpbmQodGhpcyk7CiAgICB0aGlzLnZlcmlmeSA9IHRoaXMuX3ZlcmlmeS5iaW5kKHRoaXMpOwogICAgdGhpcy5hdXRoZW50aWNhdGUgPSB0aGlzLl9hdXRoZW50aWNhdGUuYmluZCh0aGlzKTsKICAgIHRoaXMucmVnaXN0ZXIgPSB0aGlzLl9yZWdpc3Rlci5iaW5kKHRoaXMpOwogIH0KICAvKioKICAgKiBFbnJvbGwgYSBuZXcgV2ViQXV0aG4gZmFjdG9yLgogICAqIENyZWF0ZXMgYW4gdW52ZXJpZmllZCBXZWJBdXRobiBmYWN0b3IgdGhhdCBtdXN0IGJlIHZlcmlmaWVkIHdpdGggYSBjcmVkZW50aWFsLgogICAqCiAgICogQGV4cGVyaW1lbnRhbCBUaGlzIG1ldGhvZCBpcyBleHBlcmltZW50YWwgYW5kIG1heSBjaGFuZ2UgaW4gZnV0dXJlIHJlbGVhc2VzCiAgICogQHBhcmFtIHtPbWl0PE1GQUVucm9sbFdlYmF1dGhuUGFyYW1zLCAnZmFjdG9yVHlwZSc+fSBwYXJhbXMgLSBFbnJvbGxtZW50IHBhcmFtZXRlcnMgKGZyaWVuZGx5TmFtZSByZXF1aXJlZCkKICAgKiBAcmV0dXJucyB7UHJvbWlzZTxBdXRoTUZBRW5yb2xsV2ViYXV0aG5SZXNwb25zZT59IEVucm9sbGVkIGZhY3RvciBkZXRhaWxzIG9yIGVycm9yCiAgICogQHNlZSB7QGxpbmsgaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmF1dGhuLyNzY3RuLXJlZ2lzdGVyaW5nLWEtbmV3LWNyZWRlbnRpYWwgVzNDIFdlYkF1dGhuIFNwZWMgLSBSZWdpc3RlcmluZyBhIE5ldyBDcmVkZW50aWFsfQogICAqLwogIGFzeW5jIF9lbnJvbGwocGFyYW1zKSB7CiAgICByZXR1cm4gdGhpcy5jbGllbnQubWZhLmVucm9sbChPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHBhcmFtcyksIHsgZmFjdG9yVHlwZTogIndlYmF1dGhuIiB9KSk7CiAgfQogIC8qKgogICAqIENoYWxsZW5nZSBmb3IgV2ViQXV0aG4gY3JlZGVudGlhbCBjcmVhdGlvbiBvciBhdXRoZW50aWNhdGlvbi4KICAgKiBDb21iaW5lcyBzZXJ2ZXIgY2hhbGxlbmdlIHdpdGggYnJvd3NlciBjcmVkZW50aWFsIG9wZXJhdGlvbnMuCiAgICogSGFuZGxlcyBib3RoIHJlZ2lzdHJhdGlvbiAoY3JlYXRlKSBhbmQgYXV0aGVudGljYXRpb24gKHJlcXVlc3QpIGZsb3dzLgogICAqCiAgICogQGV4cGVyaW1lbnRhbCBUaGlzIG1ldGhvZCBpcyBleHBlcmltZW50YWwgYW5kIG1heSBjaGFuZ2UgaW4gZnV0dXJlIHJlbGVhc2VzCiAgICogQHBhcmFtIHtNRkFDaGFsbGVuZ2VXZWJhdXRoblBhcmFtcyAmIHsgZnJpZW5kbHlOYW1lPzogc3RyaW5nOyBzaWduYWw/OiBBYm9ydFNpZ25hbCB9fSBwYXJhbXMgLSBDaGFsbGVuZ2UgcGFyYW1ldGVycyBpbmNsdWRpbmcgZmFjdG9ySWQKICAgKiBAcGFyYW0ge09iamVjdH0gb3ZlcnJpZGVzIC0gQWxsb3dzIHlvdSB0byBvdmVycmlkZSB0aGUgcGFyYW1ldGVycyBwYXNzZWQgdG8gbmF2aWdhdG9yLmNyZWRlbnRpYWxzCiAgICogQHBhcmFtIHtQdWJsaWNLZXlDcmVkZW50aWFsQ3JlYXRpb25PcHRpb25zRnV0dXJlfSBvdmVycmlkZXMuY3JlYXRlIC0gT3ZlcnJpZGUgb3B0aW9ucyBmb3IgY3JlZGVudGlhbCBjcmVhdGlvbgogICAqIEBwYXJhbSB7UHVibGljS2V5Q3JlZGVudGlhbFJlcXVlc3RPcHRpb25zRnV0dXJlfSBvdmVycmlkZXMucmVxdWVzdCAtIE92ZXJyaWRlIG9wdGlvbnMgZm9yIGNyZWRlbnRpYWwgcmVxdWVzdAogICAqIEByZXR1cm5zIHtQcm9taXNlPFJlcXVlc3RSZXN1bHQ+fSBDaGFsbGVuZ2UgcmVzcG9uc2Ugd2l0aCBjcmVkZW50aWFsIG9yIGVycm9yCiAgICogQHNlZSB7QGxpbmsgaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmF1dGhuLyNzY3RuLWNyZWRlbnRpYWwtY3JlYXRpb24gVzNDIFdlYkF1dGhuIFNwZWMgLSBDcmVkZW50aWFsIENyZWF0aW9ufQogICAqIEBzZWUge0BsaW5rIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJhdXRobi8jc2N0bi12ZXJpZnlpbmctYXNzZXJ0aW9uIFczQyBXZWJBdXRobiBTcGVjIC0gVmVyaWZ5aW5nIEFzc2VydGlvbn0KICAgKi8KICBhc3luYyBfY2hhbGxlbmdlKHsgZmFjdG9ySWQsIHdlYmF1dGhuLCBmcmllbmRseU5hbWUsIHNpZ25hbCB9LCBvdmVycmlkZXMpIHsKICAgIHZhciBfYTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHsgZGF0YTogY2hhbGxlbmdlUmVzcG9uc2UsIGVycm9yOiBjaGFsbGVuZ2VFcnJvciB9ID0gYXdhaXQgdGhpcy5jbGllbnQubWZhLmNoYWxsZW5nZSh7CiAgICAgICAgZmFjdG9ySWQsCiAgICAgICAgd2ViYXV0aG4KICAgICAgfSk7CiAgICAgIGlmICghY2hhbGxlbmdlUmVzcG9uc2UpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvcjogY2hhbGxlbmdlRXJyb3IgfTsKICAgICAgfQogICAgICBjb25zdCBhYm9ydFNpZ25hbCA9IHNpZ25hbCAhPT0gbnVsbCAmJiBzaWduYWwgIT09IHZvaWQgMCA/IHNpZ25hbCA6IHdlYkF1dGhuQWJvcnRTZXJ2aWNlLmNyZWF0ZU5ld0Fib3J0U2lnbmFsKCk7CiAgICAgIGlmIChjaGFsbGVuZ2VSZXNwb25zZS53ZWJhdXRobi50eXBlID09PSAiY3JlYXRlIikgewogICAgICAgIGNvbnN0IHsgdXNlciB9ID0gY2hhbGxlbmdlUmVzcG9uc2Uud2ViYXV0aG4uY3JlZGVudGlhbF9vcHRpb25zLnB1YmxpY0tleTsKICAgICAgICBpZiAoIXVzZXIubmFtZSkgewogICAgICAgICAgY29uc3QgbmFtZVRvVXNlID0gZnJpZW5kbHlOYW1lOwogICAgICAgICAgaWYgKCFuYW1lVG9Vc2UpIHsKICAgICAgICAgICAgY29uc3QgY3VycmVudFVzZXIgPSBhd2FpdCB0aGlzLmNsaWVudC5nZXRVc2VyKCk7CiAgICAgICAgICAgIGNvbnN0IHVzZXJEYXRhID0gY3VycmVudFVzZXIuZGF0YS51c2VyOwogICAgICAgICAgICBjb25zdCBmYWxsYmFja05hbWUgPSAoKF9hID0gdXNlckRhdGEgPT09IG51bGwgfHwgdXNlckRhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHVzZXJEYXRhLnVzZXJfbWV0YWRhdGEpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5uYW1lKSB8fCAodXNlckRhdGEgPT09IG51bGwgfHwgdXNlckRhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHVzZXJEYXRhLmVtYWlsKSB8fCAodXNlckRhdGEgPT09IG51bGwgfHwgdXNlckRhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHVzZXJEYXRhLmlkKSB8fCAiVXNlciI7CiAgICAgICAgICAgIHVzZXIubmFtZSA9IGAke3VzZXIuaWR9OiR7ZmFsbGJhY2tOYW1lfWA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1c2VyLm5hbWUgPSBgJHt1c2VyLmlkfToke25hbWVUb1VzZX1gOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIXVzZXIuZGlzcGxheU5hbWUpIHsKICAgICAgICAgIHVzZXIuZGlzcGxheU5hbWUgPSB1c2VyLm5hbWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHN3aXRjaCAoY2hhbGxlbmdlUmVzcG9uc2Uud2ViYXV0aG4udHlwZSkgewogICAgICAgIGNhc2UgImNyZWF0ZSI6IHsKICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSBtZXJnZUNyZWRlbnRpYWxDcmVhdGlvbk9wdGlvbnMoY2hhbGxlbmdlUmVzcG9uc2Uud2ViYXV0aG4uY3JlZGVudGlhbF9vcHRpb25zLnB1YmxpY0tleSwgb3ZlcnJpZGVzID09PSBudWxsIHx8IG92ZXJyaWRlcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3ZlcnJpZGVzLmNyZWF0ZSk7CiAgICAgICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBjcmVhdGVDcmVkZW50aWFsKHsKICAgICAgICAgICAgcHVibGljS2V5OiBvcHRpb25zLAogICAgICAgICAgICBzaWduYWw6IGFib3J0U2lnbmFsCiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgICAgZmFjdG9ySWQsCiAgICAgICAgICAgICAgICBjaGFsbGVuZ2VJZDogY2hhbGxlbmdlUmVzcG9uc2UuaWQsCiAgICAgICAgICAgICAgICB3ZWJhdXRobjogewogICAgICAgICAgICAgICAgICB0eXBlOiBjaGFsbGVuZ2VSZXNwb25zZS53ZWJhdXRobi50eXBlLAogICAgICAgICAgICAgICAgICBjcmVkZW50aWFsX3Jlc3BvbnNlOiBkYXRhCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBlcnJvcjogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3IgfTsKICAgICAgICB9CiAgICAgICAgY2FzZSAicmVxdWVzdCI6IHsKICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSBtZXJnZUNyZWRlbnRpYWxSZXF1ZXN0T3B0aW9ucyhjaGFsbGVuZ2VSZXNwb25zZS53ZWJhdXRobi5jcmVkZW50aWFsX29wdGlvbnMucHVibGljS2V5LCBvdmVycmlkZXMgPT09IG51bGwgfHwgb3ZlcnJpZGVzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvdmVycmlkZXMucmVxdWVzdCk7CiAgICAgICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBnZXRDcmVkZW50aWFsKE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgY2hhbGxlbmdlUmVzcG9uc2Uud2ViYXV0aG4uY3JlZGVudGlhbF9vcHRpb25zKSwgeyBwdWJsaWNLZXk6IG9wdGlvbnMsIHNpZ25hbDogYWJvcnRTaWduYWwgfSkpOwogICAgICAgICAgaWYgKGRhdGEpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBkYXRhOiB7CiAgICAgICAgICAgICAgICBmYWN0b3JJZCwKICAgICAgICAgICAgICAgIGNoYWxsZW5nZUlkOiBjaGFsbGVuZ2VSZXNwb25zZS5pZCwKICAgICAgICAgICAgICAgIHdlYmF1dGhuOiB7CiAgICAgICAgICAgICAgICAgIHR5cGU6IGNoYWxsZW5nZVJlc3BvbnNlLndlYmF1dGhuLnR5cGUsCiAgICAgICAgICAgICAgICAgIGNyZWRlbnRpYWxfcmVzcG9uc2U6IGRhdGEKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGVycm9yOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvciB9OwogICAgICAgIH0KICAgICAgfQogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB7IGRhdGE6IG51bGwsIGVycm9yIH07CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiBudWxsLAogICAgICAgIGVycm9yOiBuZXcgQXV0aFVua25vd25FcnJvcigiVW5leHBlY3RlZCBlcnJvciBpbiBjaGFsbGVuZ2UiLCBlcnJvcikKICAgICAgfTsKICAgIH0KICB9CiAgLyoqCiAgICogVmVyaWZ5IGEgV2ViQXV0aG4gY3JlZGVudGlhbCB3aXRoIHRoZSBzZXJ2ZXIuCiAgICogQ29tcGxldGVzIHRoZSBXZWJBdXRobiBjZXJlbW9ueSBieSBzZW5kaW5nIHRoZSBjcmVkZW50aWFsIHRvIHRoZSBzZXJ2ZXIgZm9yIHZlcmlmaWNhdGlvbi4KICAgKgogICAqIEBleHBlcmltZW50YWwgVGhpcyBtZXRob2QgaXMgZXhwZXJpbWVudGFsIGFuZCBtYXkgY2hhbmdlIGluIGZ1dHVyZSByZWxlYXNlcwogICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgLSBWZXJpZmljYXRpb24gcGFyYW1ldGVycwogICAqIEBwYXJhbSB7c3RyaW5nfSBwYXJhbXMuY2hhbGxlbmdlSWQgLSBJRCBvZiB0aGUgY2hhbGxlbmdlIGJlaW5nIHZlcmlmaWVkCiAgICogQHBhcmFtIHtzdHJpbmd9IHBhcmFtcy5mYWN0b3JJZCAtIElEIG9mIHRoZSBXZWJBdXRobiBmYWN0b3IKICAgKiBAcGFyYW0ge01GQVZlcmlmeVdlYmF1dGhuUGFyYW1zPFQ+Wyd3ZWJhdXRobiddfSBwYXJhbXMud2ViYXV0aG4gLSBXZWJBdXRobiBjcmVkZW50aWFsIHJlc3BvbnNlCiAgICogQHJldHVybnMge1Byb21pc2U8QXV0aE1GQVZlcmlmeVJlc3BvbnNlPn0gVmVyaWZpY2F0aW9uIHJlc3VsdCB3aXRoIHNlc3Npb24gb3IgZXJyb3IKICAgKiBAc2VlIHtAbGluayBodHRwczovL3czYy5naXRodWIuaW8vd2ViYXV0aG4vI3NjdG4tdmVyaWZ5aW5nLWFzc2VydGlvbiBXM0MgV2ViQXV0aG4gU3BlYyAtIFZlcmlmeWluZyBhbiBBdXRoZW50aWNhdGlvbiBBc3NlcnRpb259CiAgICogKi8KICBhc3luYyBfdmVyaWZ5KHsgY2hhbGxlbmdlSWQsIGZhY3RvcklkLCB3ZWJhdXRobiB9KSB7CiAgICByZXR1cm4gdGhpcy5jbGllbnQubWZhLnZlcmlmeSh7CiAgICAgIGZhY3RvcklkLAogICAgICBjaGFsbGVuZ2VJZCwKICAgICAgd2ViYXV0aG4KICAgIH0pOwogIH0KICAvKioKICAgKiBDb21wbGV0ZSBXZWJBdXRobiBhdXRoZW50aWNhdGlvbiBmbG93LgogICAqIFBlcmZvcm1zIGNoYWxsZW5nZSBhbmQgdmVyaWZpY2F0aW9uIGluIGEgc2luZ2xlIG9wZXJhdGlvbiBmb3IgZXhpc3RpbmcgY3JlZGVudGlhbHMuCiAgICoKICAgKiBAZXhwZXJpbWVudGFsIFRoaXMgbWV0aG9kIGlzIGV4cGVyaW1lbnRhbCBhbmQgbWF5IGNoYW5nZSBpbiBmdXR1cmUgcmVsZWFzZXMKICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1zIC0gQXV0aGVudGljYXRpb24gcGFyYW1ldGVycwogICAqIEBwYXJhbSB7c3RyaW5nfSBwYXJhbXMuZmFjdG9ySWQgLSBJRCBvZiB0aGUgV2ViQXV0aG4gZmFjdG9yIHRvIGF1dGhlbnRpY2F0ZSB3aXRoCiAgICogQHBhcmFtIHtPYmplY3R9IHBhcmFtcy53ZWJhdXRobiAtIFdlYkF1dGhuIGNvbmZpZ3VyYXRpb24KICAgKiBAcGFyYW0ge3N0cmluZ30gcGFyYW1zLndlYmF1dGhuLnJwSWQgLSBSZWx5aW5nIFBhcnR5IElEIChkZWZhdWx0cyB0byBjdXJyZW50IGhvc3RuYW1lKQogICAqIEBwYXJhbSB7c3RyaW5nW119IHBhcmFtcy53ZWJhdXRobi5ycE9yaWdpbnMgLSBBbGxvd2VkIG9yaWdpbnMgKGRlZmF1bHRzIHRvIGN1cnJlbnQgb3JpZ2luKQogICAqIEBwYXJhbSB7QWJvcnRTaWduYWx9IHBhcmFtcy53ZWJhdXRobi5zaWduYWwgLSBPcHRpb25hbCBhYm9ydCBzaWduYWwKICAgKiBAcGFyYW0ge1B1YmxpY0tleUNyZWRlbnRpYWxSZXF1ZXN0T3B0aW9uc0Z1dHVyZX0gb3ZlcnJpZGVzIC0gT3ZlcnJpZGUgb3B0aW9ucyBmb3IgbmF2aWdhdG9yLmNyZWRlbnRpYWxzLmdldAogICAqIEByZXR1cm5zIHtQcm9taXNlPFJlcXVlc3RSZXN1bHQ8QXV0aE1GQVZlcmlmeVJlc3BvbnNlRGF0YSwgV2ViQXV0aG5FcnJvciB8IEF1dGhFcnJvcj4+fSBBdXRoZW50aWNhdGlvbiByZXN1bHQKICAgKiBAc2VlIHtAbGluayBodHRwczovL3czYy5naXRodWIuaW8vd2ViYXV0aG4vI3NjdG4tYXV0aGVudGljYXRpb24gVzNDIFdlYkF1dGhuIFNwZWMgLSBBdXRoZW50aWNhdGlvbiBDZXJlbW9ueX0KICAgKiBAc2VlIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvUHVibGljS2V5Q3JlZGVudGlhbFJlcXVlc3RPcHRpb25zIE1ETiAtIFB1YmxpY0tleUNyZWRlbnRpYWxSZXF1ZXN0T3B0aW9uc30KICAgKi8KICBhc3luYyBfYXV0aGVudGljYXRlKHsgZmFjdG9ySWQsIHdlYmF1dGhuOiB7IHJwSWQgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IHdpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZSA6IHZvaWQgMCwgcnBPcmlnaW5zID0gdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyBbd2luZG93LmxvY2F0aW9uLm9yaWdpbl0gOiB2b2lkIDAsIHNpZ25hbCB9ID0ge30gfSwgb3ZlcnJpZGVzKSB7CiAgICBpZiAoIXJwSWQpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiBudWxsLAogICAgICAgIGVycm9yOiBuZXcgQXV0aEVycm9yKCJycElkIGlzIHJlcXVpcmVkIGZvciBXZWJBdXRobiBhdXRoZW50aWNhdGlvbiIpCiAgICAgIH07CiAgICB9CiAgICB0cnkgewogICAgICBpZiAoIWJyb3dzZXJTdXBwb3J0c1dlYkF1dGhuKCkpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICAgIGVycm9yOiBuZXcgQXV0aFVua25vd25FcnJvcigiQnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IFdlYkF1dGhuIiwgbnVsbCkKICAgICAgICB9OwogICAgICB9CiAgICAgIGNvbnN0IHsgZGF0YTogY2hhbGxlbmdlUmVzcG9uc2UsIGVycm9yOiBjaGFsbGVuZ2VFcnJvciB9ID0gYXdhaXQgdGhpcy5jaGFsbGVuZ2UoewogICAgICAgIGZhY3RvcklkLAogICAgICAgIHdlYmF1dGhuOiB7IHJwSWQsIHJwT3JpZ2lucyB9LAogICAgICAgIHNpZ25hbAogICAgICB9LCB7IHJlcXVlc3Q6IG92ZXJyaWRlcyB9KTsKICAgICAgaWYgKCFjaGFsbGVuZ2VSZXNwb25zZSkgewogICAgICAgIHJldHVybiB7IGRhdGE6IG51bGwsIGVycm9yOiBjaGFsbGVuZ2VFcnJvciB9OwogICAgICB9CiAgICAgIGNvbnN0IHsgd2ViYXV0aG4gfSA9IGNoYWxsZW5nZVJlc3BvbnNlOwogICAgICByZXR1cm4gdGhpcy5fdmVyaWZ5KHsKICAgICAgICBmYWN0b3JJZCwKICAgICAgICBjaGFsbGVuZ2VJZDogY2hhbGxlbmdlUmVzcG9uc2UuY2hhbGxlbmdlSWQsCiAgICAgICAgd2ViYXV0aG46IHsKICAgICAgICAgIHR5cGU6IHdlYmF1dGhuLnR5cGUsCiAgICAgICAgICBycElkLAogICAgICAgICAgcnBPcmlnaW5zLAogICAgICAgICAgY3JlZGVudGlhbF9yZXNwb25zZTogd2ViYXV0aG4uY3JlZGVudGlhbF9yZXNwb25zZQogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3IgfTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgZXJyb3I6IG5ldyBBdXRoVW5rbm93bkVycm9yKCJVbmV4cGVjdGVkIGVycm9yIGluIGF1dGhlbnRpY2F0ZSIsIGVycm9yKQogICAgICB9OwogICAgfQogIH0KICAvKioKICAgKiBDb21wbGV0ZSBXZWJBdXRobiByZWdpc3RyYXRpb24gZmxvdy4KICAgKiBQZXJmb3JtcyBlbnJvbGxtZW50LCBjaGFsbGVuZ2UsIGFuZCB2ZXJpZmljYXRpb24gaW4gYSBzaW5nbGUgb3BlcmF0aW9uIGZvciBuZXcgY3JlZGVudGlhbHMuCiAgICoKICAgKiBAZXhwZXJpbWVudGFsIFRoaXMgbWV0aG9kIGlzIGV4cGVyaW1lbnRhbCBhbmQgbWF5IGNoYW5nZSBpbiBmdXR1cmUgcmVsZWFzZXMKICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1zIC0gUmVnaXN0cmF0aW9uIHBhcmFtZXRlcnMKICAgKiBAcGFyYW0ge3N0cmluZ30gcGFyYW1zLmZyaWVuZGx5TmFtZSAtIFVzZXItZnJpZW5kbHkgbmFtZSBmb3IgdGhlIGNyZWRlbnRpYWwKICAgKiBAcGFyYW0ge3N0cmluZ30gcGFyYW1zLnJwSWQgLSBSZWx5aW5nIFBhcnR5IElEIChkZWZhdWx0cyB0byBjdXJyZW50IGhvc3RuYW1lKQogICAqIEBwYXJhbSB7c3RyaW5nW119IHBhcmFtcy5ycE9yaWdpbnMgLSBBbGxvd2VkIG9yaWdpbnMgKGRlZmF1bHRzIHRvIGN1cnJlbnQgb3JpZ2luKQogICAqIEBwYXJhbSB7QWJvcnRTaWduYWx9IHBhcmFtcy5zaWduYWwgLSBPcHRpb25hbCBhYm9ydCBzaWduYWwKICAgKiBAcGFyYW0ge1B1YmxpY0tleUNyZWRlbnRpYWxDcmVhdGlvbk9wdGlvbnNGdXR1cmV9IG92ZXJyaWRlcyAtIE92ZXJyaWRlIG9wdGlvbnMgZm9yIG5hdmlnYXRvci5jcmVkZW50aWFscy5jcmVhdGUKICAgKiBAcmV0dXJucyB7UHJvbWlzZTxSZXF1ZXN0UmVzdWx0PEF1dGhNRkFWZXJpZnlSZXNwb25zZURhdGEsIFdlYkF1dGhuRXJyb3IgfCBBdXRoRXJyb3I+Pn0gUmVnaXN0cmF0aW9uIHJlc3VsdAogICAqIEBzZWUge0BsaW5rIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJhdXRobi8jc2N0bi1yZWdpc3RlcmluZy1hLW5ldy1jcmVkZW50aWFsIFczQyBXZWJBdXRobiBTcGVjIC0gUmVnaXN0cmF0aW9uIENlcmVtb255fQogICAqIEBzZWUge0BsaW5rIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9QdWJsaWNLZXlDcmVkZW50aWFsQ3JlYXRpb25PcHRpb25zIE1ETiAtIFB1YmxpY0tleUNyZWRlbnRpYWxDcmVhdGlvbk9wdGlvbnN9CiAgICovCiAgYXN5bmMgX3JlZ2lzdGVyKHsgZnJpZW5kbHlOYW1lLCB3ZWJhdXRobjogeyBycElkID0gdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cubG9jYXRpb24uaG9zdG5hbWUgOiB2b2lkIDAsIHJwT3JpZ2lucyA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gW3dpbmRvdy5sb2NhdGlvbi5vcmlnaW5dIDogdm9pZCAwLCBzaWduYWwgfSA9IHt9IH0sIG92ZXJyaWRlcykgewogICAgaWYgKCFycElkKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICBlcnJvcjogbmV3IEF1dGhFcnJvcigicnBJZCBpcyByZXF1aXJlZCBmb3IgV2ViQXV0aG4gcmVnaXN0cmF0aW9uIikKICAgICAgfTsKICAgIH0KICAgIHRyeSB7CiAgICAgIGlmICghYnJvd3NlclN1cHBvcnRzV2ViQXV0aG4oKSkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBkYXRhOiBudWxsLAogICAgICAgICAgZXJyb3I6IG5ldyBBdXRoVW5rbm93bkVycm9yKCJCcm93c2VyIGRvZXMgbm90IHN1cHBvcnQgV2ViQXV0aG4iLCBudWxsKQogICAgICAgIH07CiAgICAgIH0KICAgICAgY29uc3QgeyBkYXRhOiBmYWN0b3IsIGVycm9yOiBlbnJvbGxFcnJvciB9ID0gYXdhaXQgdGhpcy5fZW5yb2xsKHsKICAgICAgICBmcmllbmRseU5hbWUKICAgICAgfSk7CiAgICAgIGlmICghZmFjdG9yKSB7CiAgICAgICAgYXdhaXQgdGhpcy5jbGllbnQubWZhLmxpc3RGYWN0b3JzKCkudGhlbigoZmFjdG9ycykgPT4gewogICAgICAgICAgdmFyIF9hOwogICAgICAgICAgcmV0dXJuIChfYSA9IGZhY3RvcnMuZGF0YSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmFsbC5maW5kKCh2KSA9PiB2LmZhY3Rvcl90eXBlID09PSAid2ViYXV0aG4iICYmIHYuZnJpZW5kbHlfbmFtZSA9PT0gZnJpZW5kbHlOYW1lICYmIHYuc3RhdHVzICE9PSAidW52ZXJpZmllZCIpOwogICAgICAgIH0pLnRoZW4oKGZhY3RvcjIpID0+IGZhY3RvcjIgPyB0aGlzLmNsaWVudC5tZmEudW5lbnJvbGwoeyBmYWN0b3JJZDogZmFjdG9yMiA9PT0gbnVsbCB8fCBmYWN0b3IyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmYWN0b3IyLmlkIH0pIDogdm9pZCAwKTsKICAgICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvcjogZW5yb2xsRXJyb3IgfTsKICAgICAgfQogICAgICBjb25zdCB7IGRhdGE6IGNoYWxsZW5nZVJlc3BvbnNlLCBlcnJvcjogY2hhbGxlbmdlRXJyb3IgfSA9IGF3YWl0IHRoaXMuX2NoYWxsZW5nZSh7CiAgICAgICAgZmFjdG9ySWQ6IGZhY3Rvci5pZCwKICAgICAgICBmcmllbmRseU5hbWU6IGZhY3Rvci5mcmllbmRseV9uYW1lLAogICAgICAgIHdlYmF1dGhuOiB7IHJwSWQsIHJwT3JpZ2lucyB9LAogICAgICAgIHNpZ25hbAogICAgICB9LCB7CiAgICAgICAgY3JlYXRlOiBvdmVycmlkZXMKICAgICAgfSk7CiAgICAgIGlmICghY2hhbGxlbmdlUmVzcG9uc2UpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvcjogY2hhbGxlbmdlRXJyb3IgfTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fdmVyaWZ5KHsKICAgICAgICBmYWN0b3JJZDogZmFjdG9yLmlkLAogICAgICAgIGNoYWxsZW5nZUlkOiBjaGFsbGVuZ2VSZXNwb25zZS5jaGFsbGVuZ2VJZCwKICAgICAgICB3ZWJhdXRobjogewogICAgICAgICAgcnBJZCwKICAgICAgICAgIHJwT3JpZ2lucywKICAgICAgICAgIHR5cGU6IGNoYWxsZW5nZVJlc3BvbnNlLndlYmF1dGhuLnR5cGUsCiAgICAgICAgICBjcmVkZW50aWFsX3Jlc3BvbnNlOiBjaGFsbGVuZ2VSZXNwb25zZS53ZWJhdXRobi5jcmVkZW50aWFsX3Jlc3BvbnNlCiAgICAgICAgfQogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvciB9OwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICBlcnJvcjogbmV3IEF1dGhVbmtub3duRXJyb3IoIlVuZXhwZWN0ZWQgZXJyb3IgaW4gcmVnaXN0ZXIiLCBlcnJvcikKICAgICAgfTsKICAgIH0KICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK2F1dGgtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvYXV0aC1qcy9kaXN0L21vZHVsZS9Hb1RydWVDbGllbnQuanMKcG9seWZpbGxHbG9iYWxUaGlzKCk7CnZhciBERUZBVUxUX09QVElPTlMgPSB7CiAgdXJsOiBHT1RSVUVfVVJMLAogIHN0b3JhZ2VLZXk6IFNUT1JBR0VfS0VZLAogIGF1dG9SZWZyZXNoVG9rZW46IHRydWUsCiAgcGVyc2lzdFNlc3Npb246IHRydWUsCiAgZGV0ZWN0U2Vzc2lvbkluVXJsOiB0cnVlLAogIGhlYWRlcnM6IERFRkFVTFRfSEVBREVSUzIsCiAgZmxvd1R5cGU6ICJpbXBsaWNpdCIsCiAgZGVidWc6IGZhbHNlLAogIGhhc0N1c3RvbUF1dGhvcml6YXRpb25IZWFkZXI6IGZhbHNlLAogIHRocm93T25FcnJvcjogZmFsc2UsCiAgbG9ja0FjcXVpcmVUaW1lb3V0OiAxZTQsCiAgLy8gMTAgc2Vjb25kcwogIHNraXBBdXRvSW5pdGlhbGl6ZTogZmFsc2UKfTsKYXN5bmMgZnVuY3Rpb24gbG9ja05vT3AobmFtZSwgYWNxdWlyZVRpbWVvdXQsIGZuKSB7CiAgcmV0dXJuIGF3YWl0IGZuKCk7Cn0KdmFyIEdMT0JBTF9KV0tTID0ge307CnZhciBHb1RydWVDbGllbnQgPSBjbGFzcyBfR29UcnVlQ2xpZW50IHsKICAvKioKICAgKiBUaGUgSldLUyB1c2VkIGZvciB2ZXJpZnlpbmcgYXN5bW1ldHJpYyBKV1RzCiAgICovCiAgZ2V0IGp3a3MoKSB7CiAgICB2YXIgX2EsIF9iOwogICAgcmV0dXJuIChfYiA9IChfYSA9IEdMT0JBTF9KV0tTW3RoaXMuc3RvcmFnZUtleV0pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5qd2tzKSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiB7IGtleXM6IFtdIH07CiAgfQogIHNldCBqd2tzKHZhbHVlKSB7CiAgICBHTE9CQUxfSldLU1t0aGlzLnN0b3JhZ2VLZXldID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBHTE9CQUxfSldLU1t0aGlzLnN0b3JhZ2VLZXldKSwgeyBqd2tzOiB2YWx1ZSB9KTsKICB9CiAgZ2V0IGp3a3NfY2FjaGVkX2F0KCkgewogICAgdmFyIF9hLCBfYjsKICAgIHJldHVybiAoX2IgPSAoX2EgPSBHTE9CQUxfSldLU1t0aGlzLnN0b3JhZ2VLZXldKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2FjaGVkQXQpICE9PSBudWxsICYmIF9iICE9PSB2b2lkIDAgPyBfYiA6IE51bWJlci5NSU5fU0FGRV9JTlRFR0VSOwogIH0KICBzZXQgandrc19jYWNoZWRfYXQodmFsdWUpIHsKICAgIEdMT0JBTF9KV0tTW3RoaXMuc3RvcmFnZUtleV0gPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIEdMT0JBTF9KV0tTW3RoaXMuc3RvcmFnZUtleV0pLCB7IGNhY2hlZEF0OiB2YWx1ZSB9KTsKICB9CiAgLyoqCiAgICogQ3JlYXRlIGEgbmV3IGNsaWVudCBmb3IgdXNlIGluIHRoZSBicm93c2VyLgogICAqCiAgICogQGV4YW1wbGUKICAgKiBgYGB0cwogICAqIGltcG9ydCB7IEdvVHJ1ZUNsaWVudCB9IGZyb20gJ0BzdXBhYmFzZS9hdXRoLWpzJwogICAqCiAgICogY29uc3QgYXV0aCA9IG5ldyBHb1RydWVDbGllbnQoewogICAqICAgdXJsOiAnaHR0cHM6Ly94eXpjb21wYW55LnN1cGFiYXNlLmNvL2F1dGgvdjEnLAogICAqICAgaGVhZGVyczogeyBhcGlrZXk6ICdwdWJsaWMtYW5vbi1rZXknIH0sCiAgICogICBzdG9yYWdlS2V5OiAnc3VwYWJhc2UtYXV0aCcsCiAgICogfSkKICAgKiBgYGAKICAgKi8KICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICB2YXIgX2EsIF9iLCBfYzsKICAgIHRoaXMudXNlclN0b3JhZ2UgPSBudWxsOwogICAgdGhpcy5tZW1vcnlTdG9yYWdlID0gbnVsbDsKICAgIHRoaXMuc3RhdGVDaGFuZ2VFbWl0dGVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICB0aGlzLmF1dG9SZWZyZXNoVGlja2VyID0gbnVsbDsKICAgIHRoaXMuYXV0b1JlZnJlc2hUaWNrVGltZW91dCA9IG51bGw7CiAgICB0aGlzLnZpc2liaWxpdHlDaGFuZ2VkQ2FsbGJhY2sgPSBudWxsOwogICAgdGhpcy5yZWZyZXNoaW5nRGVmZXJyZWQgPSBudWxsOwogICAgdGhpcy5pbml0aWFsaXplUHJvbWlzZSA9IG51bGw7CiAgICB0aGlzLmRldGVjdFNlc3Npb25JblVybCA9IHRydWU7CiAgICB0aGlzLmhhc0N1c3RvbUF1dGhvcml6YXRpb25IZWFkZXIgPSBmYWxzZTsKICAgIHRoaXMuc3VwcHJlc3NHZXRTZXNzaW9uV2FybmluZyA9IGZhbHNlOwogICAgdGhpcy5sb2NrQWNxdWlyZWQgPSBmYWxzZTsKICAgIHRoaXMucGVuZGluZ0luTG9jayA9IFtdOwogICAgdGhpcy5icm9hZGNhc3RDaGFubmVsID0gbnVsbDsKICAgIHRoaXMubG9nZ2VyID0gY29uc29sZS5sb2c7CiAgICBjb25zdCBzZXR0aW5ncyA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgREVGQVVMVF9PUFRJT05TKSwgb3B0aW9ucyk7CiAgICB0aGlzLnN0b3JhZ2VLZXkgPSBzZXR0aW5ncy5zdG9yYWdlS2V5OwogICAgdGhpcy5pbnN0YW5jZUlEID0gKF9hID0gX0dvVHJ1ZUNsaWVudC5uZXh0SW5zdGFuY2VJRFt0aGlzLnN0b3JhZ2VLZXldKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiAwOwogICAgX0dvVHJ1ZUNsaWVudC5uZXh0SW5zdGFuY2VJRFt0aGlzLnN0b3JhZ2VLZXldID0gdGhpcy5pbnN0YW5jZUlEICsgMTsKICAgIHRoaXMubG9nRGVidWdNZXNzYWdlcyA9ICEhc2V0dGluZ3MuZGVidWc7CiAgICBpZiAodHlwZW9mIHNldHRpbmdzLmRlYnVnID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRoaXMubG9nZ2VyID0gc2V0dGluZ3MuZGVidWc7CiAgICB9CiAgICBpZiAodGhpcy5pbnN0YW5jZUlEID4gMCAmJiBpc0Jyb3dzZXIoKSkgewogICAgICBjb25zdCBtZXNzYWdlID0gYCR7dGhpcy5fbG9nUHJlZml4KCl9IE11bHRpcGxlIEdvVHJ1ZUNsaWVudCBpbnN0YW5jZXMgZGV0ZWN0ZWQgaW4gdGhlIHNhbWUgYnJvd3NlciBjb250ZXh0LiBJdCBpcyBub3QgYW4gZXJyb3IsIGJ1dCB0aGlzIHNob3VsZCBiZSBhdm9pZGVkIGFzIGl0IG1heSBwcm9kdWNlIHVuZGVmaW5lZCBiZWhhdmlvciB3aGVuIHVzZWQgY29uY3VycmVudGx5IHVuZGVyIHRoZSBzYW1lIHN0b3JhZ2Uga2V5LmA7CiAgICAgIGNvbnNvbGUud2FybihtZXNzYWdlKTsKICAgICAgaWYgKHRoaXMubG9nRGVidWdNZXNzYWdlcykgewogICAgICAgIGNvbnNvbGUudHJhY2UobWVzc2FnZSk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMucGVyc2lzdFNlc3Npb24gPSBzZXR0aW5ncy5wZXJzaXN0U2Vzc2lvbjsKICAgIHRoaXMuYXV0b1JlZnJlc2hUb2tlbiA9IHNldHRpbmdzLmF1dG9SZWZyZXNoVG9rZW47CiAgICB0aGlzLmFkbWluID0gbmV3IEdvVHJ1ZUFkbWluQXBpKHsKICAgICAgdXJsOiBzZXR0aW5ncy51cmwsCiAgICAgIGhlYWRlcnM6IHNldHRpbmdzLmhlYWRlcnMsCiAgICAgIGZldGNoOiBzZXR0aW5ncy5mZXRjaAogICAgfSk7CiAgICB0aGlzLnVybCA9IHNldHRpbmdzLnVybDsKICAgIHRoaXMuaGVhZGVycyA9IHNldHRpbmdzLmhlYWRlcnM7CiAgICB0aGlzLmZldGNoID0gcmVzb2x2ZUZldGNoMyhzZXR0aW5ncy5mZXRjaCk7CiAgICB0aGlzLmxvY2sgPSBzZXR0aW5ncy5sb2NrIHx8IGxvY2tOb09wOwogICAgdGhpcy5kZXRlY3RTZXNzaW9uSW5VcmwgPSBzZXR0aW5ncy5kZXRlY3RTZXNzaW9uSW5Vcmw7CiAgICB0aGlzLmZsb3dUeXBlID0gc2V0dGluZ3MuZmxvd1R5cGU7CiAgICB0aGlzLmhhc0N1c3RvbUF1dGhvcml6YXRpb25IZWFkZXIgPSBzZXR0aW5ncy5oYXNDdXN0b21BdXRob3JpemF0aW9uSGVhZGVyOwogICAgdGhpcy50aHJvd09uRXJyb3IgPSBzZXR0aW5ncy50aHJvd09uRXJyb3I7CiAgICB0aGlzLmxvY2tBY3F1aXJlVGltZW91dCA9IHNldHRpbmdzLmxvY2tBY3F1aXJlVGltZW91dDsKICAgIGlmIChzZXR0aW5ncy5sb2NrKSB7CiAgICAgIHRoaXMubG9jayA9IHNldHRpbmdzLmxvY2s7CiAgICB9IGVsc2UgaWYgKHRoaXMucGVyc2lzdFNlc3Npb24gJiYgaXNCcm93c2VyKCkgJiYgKChfYiA9IGdsb2JhbFRoaXMgPT09IG51bGwgfHwgZ2xvYmFsVGhpcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogZ2xvYmFsVGhpcy5uYXZpZ2F0b3IpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5sb2NrcykpIHsKICAgICAgdGhpcy5sb2NrID0gbmF2aWdhdG9yTG9jazsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMubG9jayA9IGxvY2tOb09wOwogICAgfQogICAgaWYgKCF0aGlzLmp3a3MpIHsKICAgICAgdGhpcy5qd2tzID0geyBrZXlzOiBbXSB9OwogICAgICB0aGlzLmp3a3NfY2FjaGVkX2F0ID0gTnVtYmVyLk1JTl9TQUZFX0lOVEVHRVI7CiAgICB9CiAgICB0aGlzLm1mYSA9IHsKICAgICAgdmVyaWZ5OiB0aGlzLl92ZXJpZnkuYmluZCh0aGlzKSwKICAgICAgZW5yb2xsOiB0aGlzLl9lbnJvbGwuYmluZCh0aGlzKSwKICAgICAgdW5lbnJvbGw6IHRoaXMuX3VuZW5yb2xsLmJpbmQodGhpcyksCiAgICAgIGNoYWxsZW5nZTogdGhpcy5fY2hhbGxlbmdlLmJpbmQodGhpcyksCiAgICAgIGxpc3RGYWN0b3JzOiB0aGlzLl9saXN0RmFjdG9ycy5iaW5kKHRoaXMpLAogICAgICBjaGFsbGVuZ2VBbmRWZXJpZnk6IHRoaXMuX2NoYWxsZW5nZUFuZFZlcmlmeS5iaW5kKHRoaXMpLAogICAgICBnZXRBdXRoZW50aWNhdG9yQXNzdXJhbmNlTGV2ZWw6IHRoaXMuX2dldEF1dGhlbnRpY2F0b3JBc3N1cmFuY2VMZXZlbC5iaW5kKHRoaXMpLAogICAgICB3ZWJhdXRobjogbmV3IFdlYkF1dGhuQXBpKHRoaXMpCiAgICB9OwogICAgdGhpcy5vYXV0aCA9IHsKICAgICAgZ2V0QXV0aG9yaXphdGlvbkRldGFpbHM6IHRoaXMuX2dldEF1dGhvcml6YXRpb25EZXRhaWxzLmJpbmQodGhpcyksCiAgICAgIGFwcHJvdmVBdXRob3JpemF0aW9uOiB0aGlzLl9hcHByb3ZlQXV0aG9yaXphdGlvbi5iaW5kKHRoaXMpLAogICAgICBkZW55QXV0aG9yaXphdGlvbjogdGhpcy5fZGVueUF1dGhvcml6YXRpb24uYmluZCh0aGlzKSwKICAgICAgbGlzdEdyYW50czogdGhpcy5fbGlzdE9BdXRoR3JhbnRzLmJpbmQodGhpcyksCiAgICAgIHJldm9rZUdyYW50OiB0aGlzLl9yZXZva2VPQXV0aEdyYW50LmJpbmQodGhpcykKICAgIH07CiAgICBpZiAodGhpcy5wZXJzaXN0U2Vzc2lvbikgewogICAgICBpZiAoc2V0dGluZ3Muc3RvcmFnZSkgewogICAgICAgIHRoaXMuc3RvcmFnZSA9IHNldHRpbmdzLnN0b3JhZ2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHN1cHBvcnRzTG9jYWxTdG9yYWdlKCkpIHsKICAgICAgICAgIHRoaXMuc3RvcmFnZSA9IGdsb2JhbFRoaXMubG9jYWxTdG9yYWdlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLm1lbW9yeVN0b3JhZ2UgPSB7fTsKICAgICAgICAgIHRoaXMuc3RvcmFnZSA9IG1lbW9yeUxvY2FsU3RvcmFnZUFkYXB0ZXIodGhpcy5tZW1vcnlTdG9yYWdlKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHNldHRpbmdzLnVzZXJTdG9yYWdlKSB7CiAgICAgICAgdGhpcy51c2VyU3RvcmFnZSA9IHNldHRpbmdzLnVzZXJTdG9yYWdlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0aGlzLm1lbW9yeVN0b3JhZ2UgPSB7fTsKICAgICAgdGhpcy5zdG9yYWdlID0gbWVtb3J5TG9jYWxTdG9yYWdlQWRhcHRlcih0aGlzLm1lbW9yeVN0b3JhZ2UpOwogICAgfQogICAgaWYgKGlzQnJvd3NlcigpICYmIGdsb2JhbFRoaXMuQnJvYWRjYXN0Q2hhbm5lbCAmJiB0aGlzLnBlcnNpc3RTZXNzaW9uICYmIHRoaXMuc3RvcmFnZUtleSkgewogICAgICB0cnkgewogICAgICAgIHRoaXMuYnJvYWRjYXN0Q2hhbm5lbCA9IG5ldyBnbG9iYWxUaGlzLkJyb2FkY2FzdENoYW5uZWwodGhpcy5zdG9yYWdlS2V5KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBjcmVhdGUgYSBuZXcgQnJvYWRjYXN0Q2hhbm5lbCwgbXVsdGktdGFiIHN0YXRlIGNoYW5nZXMgd2lsbCBub3QgYmUgYXZhaWxhYmxlIiwgZSk7CiAgICAgIH0KICAgICAgKF9jID0gdGhpcy5icm9hZGNhc3RDaGFubmVsKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsIGFzeW5jIChldmVudCkgPT4gewogICAgICAgIHRoaXMuX2RlYnVnKCJyZWNlaXZlZCBicm9hZGNhc3Qgbm90aWZpY2F0aW9uIGZyb20gb3RoZXIgdGFiIG9yIGNsaWVudCIsIGV2ZW50KTsKICAgICAgICB0cnkgewogICAgICAgICAgYXdhaXQgdGhpcy5fbm90aWZ5QWxsU3Vic2NyaWJlcnMoZXZlbnQuZGF0YS5ldmVudCwgZXZlbnQuZGF0YS5zZXNzaW9uLCBmYWxzZSk7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgIHRoaXMuX2RlYnVnKCIjYnJvYWRjYXN0Q2hhbm5lbCIsICJlcnJvciIsIGVycm9yKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgaWYgKCFzZXR0aW5ncy5za2lwQXV0b0luaXRpYWxpemUpIHsKICAgICAgdGhpcy5pbml0aWFsaXplKCkuY2F0Y2goKGVycm9yKSA9PiB7CiAgICAgICAgdGhpcy5fZGVidWcoIiNpbml0aWFsaXplKCkiLCAiZXJyb3IiLCBlcnJvcik7CiAgICAgIH0pOwogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm5zIHdoZXRoZXIgZXJyb3IgdGhyb3dpbmcgbW9kZSBpcyBlbmFibGVkIGZvciB0aGlzIGNsaWVudC4KICAgKi8KICBpc1Rocm93T25FcnJvckVuYWJsZWQoKSB7CiAgICByZXR1cm4gdGhpcy50aHJvd09uRXJyb3I7CiAgfQogIC8qKgogICAqIENlbnRyYWxpemVzIHJldHVybiBoYW5kbGluZyB3aXRoIG9wdGlvbmFsIGVycm9yIHRocm93aW5nLiBXaGVuIGB0aHJvd09uRXJyb3JgIGlzIGVuYWJsZWQKICAgKiBhbmQgdGhlIHByb3ZpZGVkIHJlc3VsdCBjb250YWlucyBhIG5vbi1udWxsaXNoIGVycm9yLCB0aGUgZXJyb3IgaXMgdGhyb3duIGluc3RlYWQgb2YKICAgKiBiZWluZyByZXR1cm5lZC4gVGhpcyBlbnN1cmVzIGNvbnNpc3RlbnQgYmVoYXZpb3IgYWNyb3NzIGFsbCBwdWJsaWMgQVBJIG1ldGhvZHMuCiAgICovCiAgX3JldHVyblJlc3VsdChyZXN1bHQpIHsKICAgIGlmICh0aGlzLnRocm93T25FcnJvciAmJiByZXN1bHQgJiYgcmVzdWx0LmVycm9yKSB7CiAgICAgIHRocm93IHJlc3VsdC5lcnJvcjsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIF9sb2dQcmVmaXgoKSB7CiAgICByZXR1cm4gYEdvVHJ1ZUNsaWVudEAke3RoaXMuc3RvcmFnZUtleX06JHt0aGlzLmluc3RhbmNlSUR9ICgke3ZlcnNpb240fSkgJHsoLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkpLnRvSVNPU3RyaW5nKCl9YDsKICB9CiAgX2RlYnVnKC4uLmFyZ3MpIHsKICAgIGlmICh0aGlzLmxvZ0RlYnVnTWVzc2FnZXMpIHsKICAgICAgdGhpcy5sb2dnZXIodGhpcy5fbG9nUHJlZml4KCksIC4uLmFyZ3MpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICAqIEluaXRpYWxpemVzIHRoZSBjbGllbnQgc2Vzc2lvbiBlaXRoZXIgZnJvbSB0aGUgdXJsIG9yIGZyb20gc3RvcmFnZS4KICAgKiBUaGlzIG1ldGhvZCBpcyBhdXRvbWF0aWNhbGx5IGNhbGxlZCB3aGVuIGluc3RhbnRpYXRpbmcgdGhlIGNsaWVudCwgYnV0IHNob3VsZCBhbHNvIGJlIGNhbGxlZAogICAqIG1hbnVhbGx5IHdoZW4gY2hlY2tpbmcgZm9yIGFuIGVycm9yIGZyb20gYW4gYXV0aCByZWRpcmVjdCAob2F1dGgsIG1hZ2ljbGluaywgcGFzc3dvcmQgcmVjb3ZlcnksIGV0YykuCiAgICovCiAgYXN5bmMgaW5pdGlhbGl6ZSgpIHsKICAgIGlmICh0aGlzLmluaXRpYWxpemVQcm9taXNlKSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmluaXRpYWxpemVQcm9taXNlOwogICAgfQogICAgdGhpcy5pbml0aWFsaXplUHJvbWlzZSA9IChhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9hY3F1aXJlTG9jayh0aGlzLmxvY2tBY3F1aXJlVGltZW91dCwgYXN5bmMgKCkgPT4gewogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9pbml0aWFsaXplKCk7CiAgICAgIH0pOwogICAgfSkoKTsKICAgIHJldHVybiBhd2FpdCB0aGlzLmluaXRpYWxpemVQcm9taXNlOwogIH0KICAvKioKICAgKiBJTVBPUlRBTlQ6CiAgICogMS4gTmV2ZXIgdGhyb3cgaW4gdGhpcyBtZXRob2QsIGFzIGl0IGlzIGNhbGxlZCBmcm9tIHRoZSBjb25zdHJ1Y3RvcgogICAqIDIuIE5ldmVyIHJldHVybiBhIHNlc3Npb24gZnJvbSB0aGlzIG1ldGhvZCBhcyBpdCB3b3VsZCBiZSBjYWNoZWQgb3ZlcgogICAqICAgIHRoZSB3aG9sZSBsaWZldGltZSBvZiB0aGUgY2xpZW50CiAgICovCiAgYXN5bmMgX2luaXRpYWxpemUoKSB7CiAgICB2YXIgX2E7CiAgICB0cnkgewogICAgICBsZXQgcGFyYW1zID0ge307CiAgICAgIGxldCBjYWxsYmFja1VybFR5cGUgPSAibm9uZSI7CiAgICAgIGlmIChpc0Jyb3dzZXIoKSkgewogICAgICAgIHBhcmFtcyA9IHBhcnNlUGFyYW1ldGVyc0Zyb21VUkwod2luZG93LmxvY2F0aW9uLmhyZWYpOwogICAgICAgIGlmICh0aGlzLl9pc0ltcGxpY2l0R3JhbnRDYWxsYmFjayhwYXJhbXMpKSB7CiAgICAgICAgICBjYWxsYmFja1VybFR5cGUgPSAiaW1wbGljaXQiOwogICAgICAgIH0gZWxzZSBpZiAoYXdhaXQgdGhpcy5faXNQS0NFQ2FsbGJhY2socGFyYW1zKSkgewogICAgICAgICAgY2FsbGJhY2tVcmxUeXBlID0gInBrY2UiOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoaXNCcm93c2VyKCkgJiYgdGhpcy5kZXRlY3RTZXNzaW9uSW5VcmwgJiYgY2FsbGJhY2tVcmxUeXBlICE9PSAibm9uZSIpIHsKICAgICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCB0aGlzLl9nZXRTZXNzaW9uRnJvbVVSTChwYXJhbXMsIGNhbGxiYWNrVXJsVHlwZSk7CiAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICB0aGlzLl9kZWJ1ZygiI19pbml0aWFsaXplKCkiLCAiZXJyb3IgZGV0ZWN0aW5nIHNlc3Npb24gZnJvbSBVUkwiLCBlcnJvcik7CiAgICAgICAgICBpZiAoaXNBdXRoSW1wbGljaXRHcmFudFJlZGlyZWN0RXJyb3IoZXJyb3IpKSB7CiAgICAgICAgICAgIGNvbnN0IGVycm9yQ29kZSA9IChfYSA9IGVycm9yLmRldGFpbHMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5jb2RlOwogICAgICAgICAgICBpZiAoZXJyb3JDb2RlID09PSAiaWRlbnRpdHlfYWxyZWFkeV9leGlzdHMiIHx8IGVycm9yQ29kZSA9PT0gImlkZW50aXR5X25vdF9mb3VuZCIgfHwgZXJyb3JDb2RlID09PSAic2luZ2xlX2lkZW50aXR5X25vdF9kZWxldGFibGUiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHsgZXJyb3IgfTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsgZXJyb3IgfTsKICAgICAgICB9CiAgICAgICAgY29uc3QgeyBzZXNzaW9uLCByZWRpcmVjdFR5cGUgfSA9IGRhdGE7CiAgICAgICAgdGhpcy5fZGVidWcoIiNfaW5pdGlhbGl6ZSgpIiwgImRldGVjdGVkIHNlc3Npb24gaW4gVVJMIiwgc2Vzc2lvbiwgInJlZGlyZWN0IHR5cGUiLCByZWRpcmVjdFR5cGUpOwogICAgICAgIGF3YWl0IHRoaXMuX3NhdmVTZXNzaW9uKHNlc3Npb24pOwogICAgICAgIHNldFRpbWVvdXQoYXN5bmMgKCkgPT4gewogICAgICAgICAgaWYgKHJlZGlyZWN0VHlwZSA9PT0gInJlY292ZXJ5IikgewogICAgICAgICAgICBhd2FpdCB0aGlzLl9ub3RpZnlBbGxTdWJzY3JpYmVycygiUEFTU1dPUkRfUkVDT1ZFUlkiLCBzZXNzaW9uKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGF3YWl0IHRoaXMuX25vdGlmeUFsbFN1YnNjcmliZXJzKCJTSUdORURfSU4iLCBzZXNzaW9uKTsKICAgICAgICAgIH0KICAgICAgICB9LCAwKTsKICAgICAgICByZXR1cm4geyBlcnJvcjogbnVsbCB9OwogICAgICB9CiAgICAgIGF3YWl0IHRoaXMuX3JlY292ZXJBbmRSZWZyZXNoKCk7CiAgICAgIHJldHVybiB7IGVycm9yOiBudWxsIH07CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGVycm9yIH0pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoewogICAgICAgIGVycm9yOiBuZXcgQXV0aFVua25vd25FcnJvcigiVW5leHBlY3RlZCBlcnJvciBkdXJpbmcgaW5pdGlhbGl6YXRpb24iLCBlcnJvcikKICAgICAgfSk7CiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCB0aGlzLl9oYW5kbGVWaXNpYmlsaXR5Q2hhbmdlKCk7CiAgICAgIHRoaXMuX2RlYnVnKCIjX2luaXRpYWxpemUoKSIsICJlbmQiKTsKICAgIH0KICB9CiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBhbm9ueW1vdXMgdXNlci4KICAgKgogICAqIEByZXR1cm5zIEEgc2Vzc2lvbiB3aGVyZSB0aGUgaXNfYW5vbnltb3VzIGNsYWltIGluIHRoZSBhY2Nlc3MgdG9rZW4gSldUIHNldCB0byB0cnVlCiAgICovCiAgYXN5bmMgc2lnbkluQW5vbnltb3VzbHkoY3JlZGVudGlhbHMpIHsKICAgIHZhciBfYSwgX2IsIF9jOwogICAgdHJ5IHsKICAgICAgY29uc3QgcmVzID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vc2lnbnVwYCwgewogICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICBib2R5OiB7CiAgICAgICAgICBkYXRhOiAoX2IgPSAoX2EgPSBjcmVkZW50aWFscyA9PT0gbnVsbCB8fCBjcmVkZW50aWFscyA9PT0gdm9pZCAwID8gdm9pZCAwIDogY3JlZGVudGlhbHMub3B0aW9ucykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmRhdGEpICE9PSBudWxsICYmIF9iICE9PSB2b2lkIDAgPyBfYiA6IHt9LAogICAgICAgICAgZ290cnVlX21ldGFfc2VjdXJpdHk6IHsgY2FwdGNoYV90b2tlbjogKF9jID0gY3JlZGVudGlhbHMgPT09IG51bGwgfHwgY3JlZGVudGlhbHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNyZWRlbnRpYWxzLm9wdGlvbnMpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5jYXB0Y2hhVG9rZW4gfQogICAgICAgIH0sCiAgICAgICAgeGZvcm06IF9zZXNzaW9uUmVzcG9uc2UKICAgICAgfSk7CiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IHJlczsKICAgICAgaWYgKGVycm9yIHx8ICFkYXRhKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICBjb25zdCBzZXNzaW9uID0gZGF0YS5zZXNzaW9uOwogICAgICBjb25zdCB1c2VyID0gZGF0YS51c2VyOwogICAgICBpZiAoZGF0YS5zZXNzaW9uKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fc2F2ZVNlc3Npb24oZGF0YS5zZXNzaW9uKTsKICAgICAgICBhd2FpdCB0aGlzLl9ub3RpZnlBbGxTdWJzY3JpYmVycygiU0lHTkVEX0lOIiwgc2Vzc2lvbik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlciwgc2Vzc2lvbiB9LCBlcnJvcjogbnVsbCB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IHVzZXIuCiAgICoKICAgKiBCZSBhd2FyZSB0aGF0IGlmIGEgdXNlciBhY2NvdW50IGV4aXN0cyBpbiB0aGUgc3lzdGVtIHlvdSBtYXkgZ2V0IGJhY2sgYW4KICAgKiBlcnJvciBtZXNzYWdlIHRoYXQgYXR0ZW1wdHMgdG8gaGlkZSB0aGlzIGluZm9ybWF0aW9uIGZyb20gdGhlIHVzZXIuCiAgICogVGhpcyBtZXRob2QgaGFzIHN1cHBvcnQgZm9yIFBLQ0UgdmlhIGVtYWlsIHNpZ251cHMuIFRoZSBQS0NFIGZsb3cgY2Fubm90IGJlIHVzZWQgd2hlbiBhdXRvY29uZmlybSBpcyBlbmFibGVkLgogICAqCiAgICogQHJldHVybnMgQSBsb2dnZWQtaW4gc2Vzc2lvbiBpZiB0aGUgc2VydmVyIGhhcyAiYXV0b2NvbmZpcm0iIE9OCiAgICogQHJldHVybnMgQSB1c2VyIGlmIHRoZSBzZXJ2ZXIgaGFzICJhdXRvY29uZmlybSIgT0ZGCiAgICovCiAgYXN5bmMgc2lnblVwKGNyZWRlbnRpYWxzKSB7CiAgICB2YXIgX2EsIF9iLCBfYzsKICAgIHRyeSB7CiAgICAgIGxldCByZXM7CiAgICAgIGlmICgiZW1haWwiIGluIGNyZWRlbnRpYWxzKSB7CiAgICAgICAgY29uc3QgeyBlbWFpbCwgcGFzc3dvcmQsIG9wdGlvbnMgfSA9IGNyZWRlbnRpYWxzOwogICAgICAgIGxldCBjb2RlQ2hhbGxlbmdlID0gbnVsbDsKICAgICAgICBsZXQgY29kZUNoYWxsZW5nZU1ldGhvZCA9IG51bGw7CiAgICAgICAgaWYgKHRoaXMuZmxvd1R5cGUgPT09ICJwa2NlIikgewogICAgICAgICAgOwogICAgICAgICAgW2NvZGVDaGFsbGVuZ2UsIGNvZGVDaGFsbGVuZ2VNZXRob2RdID0gYXdhaXQgZ2V0Q29kZUNoYWxsZW5nZUFuZE1ldGhvZCh0aGlzLnN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSk7CiAgICAgICAgfQogICAgICAgIHJlcyA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L3NpZ251cGAsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIHJlZGlyZWN0VG86IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5lbWFpbFJlZGlyZWN0VG8sCiAgICAgICAgICBib2R5OiB7CiAgICAgICAgICAgIGVtYWlsLAogICAgICAgICAgICBwYXNzd29yZCwKICAgICAgICAgICAgZGF0YTogKF9hID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmRhdGEpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IHt9LAogICAgICAgICAgICBnb3RydWVfbWV0YV9zZWN1cml0eTogeyBjYXB0Y2hhX3Rva2VuOiBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuY2FwdGNoYVRva2VuIH0sCiAgICAgICAgICAgIGNvZGVfY2hhbGxlbmdlOiBjb2RlQ2hhbGxlbmdlLAogICAgICAgICAgICBjb2RlX2NoYWxsZW5nZV9tZXRob2Q6IGNvZGVDaGFsbGVuZ2VNZXRob2QKICAgICAgICAgIH0sCiAgICAgICAgICB4Zm9ybTogX3Nlc3Npb25SZXNwb25zZQogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKCJwaG9uZSIgaW4gY3JlZGVudGlhbHMpIHsKICAgICAgICBjb25zdCB7IHBob25lLCBwYXNzd29yZCwgb3B0aW9ucyB9ID0gY3JlZGVudGlhbHM7CiAgICAgICAgcmVzID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vc2lnbnVwYCwgewogICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgYm9keTogewogICAgICAgICAgICBwaG9uZSwKICAgICAgICAgICAgcGFzc3dvcmQsCiAgICAgICAgICAgIGRhdGE6IChfYiA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5kYXRhKSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiB7fSwKICAgICAgICAgICAgY2hhbm5lbDogKF9jID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmNoYW5uZWwpICE9PSBudWxsICYmIF9jICE9PSB2b2lkIDAgPyBfYyA6ICJzbXMiLAogICAgICAgICAgICBnb3RydWVfbWV0YV9zZWN1cml0eTogeyBjYXB0Y2hhX3Rva2VuOiBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuY2FwdGNoYVRva2VuIH0KICAgICAgICAgIH0sCiAgICAgICAgICB4Zm9ybTogX3Nlc3Npb25SZXNwb25zZQogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBBdXRoSW52YWxpZENyZWRlbnRpYWxzRXJyb3IoIllvdSBtdXN0IHByb3ZpZGUgZWl0aGVyIGFuIGVtYWlsIG9yIHBob25lIG51bWJlciBhbmQgYSBwYXNzd29yZCIpOwogICAgICB9CiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IHJlczsKICAgICAgaWYgKGVycm9yIHx8ICFkYXRhKSB7CiAgICAgICAgYXdhaXQgcmVtb3ZlSXRlbUFzeW5jKHRoaXMuc3RvcmFnZSwgYCR7dGhpcy5zdG9yYWdlS2V5fS1jb2RlLXZlcmlmaWVyYCk7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICBjb25zdCBzZXNzaW9uID0gZGF0YS5zZXNzaW9uOwogICAgICBjb25zdCB1c2VyID0gZGF0YS51c2VyOwogICAgICBpZiAoZGF0YS5zZXNzaW9uKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fc2F2ZVNlc3Npb24oZGF0YS5zZXNzaW9uKTsKICAgICAgICBhd2FpdCB0aGlzLl9ub3RpZnlBbGxTdWJzY3JpYmVycygiU0lHTkVEX0lOIiwgc2Vzc2lvbik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlciwgc2Vzc2lvbiB9LCBlcnJvcjogbnVsbCB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGF3YWl0IHJlbW92ZUl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIGAke3RoaXMuc3RvcmFnZUtleX0tY29kZS12ZXJpZmllcmApOwogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogTG9nIGluIGFuIGV4aXN0aW5nIHVzZXIgd2l0aCBhbiBlbWFpbCBhbmQgcGFzc3dvcmQgb3IgcGhvbmUgYW5kIHBhc3N3b3JkLgogICAqCiAgICogQmUgYXdhcmUgdGhhdCB5b3UgbWF5IGdldCBiYWNrIGFuIGVycm9yIG1lc3NhZ2UgdGhhdCB3aWxsIG5vdCBkaXN0aW5ndWlzaAogICAqIGJldHdlZW4gdGhlIGNhc2VzIHdoZXJlIHRoZSBhY2NvdW50IGRvZXMgbm90IGV4aXN0IG9yIHRoYXQgdGhlCiAgICogZW1haWwvcGhvbmUgYW5kIHBhc3N3b3JkIGNvbWJpbmF0aW9uIGlzIHdyb25nIG9yIHRoYXQgdGhlIGFjY291bnQgY2FuIG9ubHkKICAgKiBiZSBhY2Nlc3NlZCB2aWEgc29jaWFsIGxvZ2luLgogICAqLwogIGFzeW5jIHNpZ25JbldpdGhQYXNzd29yZChjcmVkZW50aWFscykgewogICAgdHJ5IHsKICAgICAgbGV0IHJlczsKICAgICAgaWYgKCJlbWFpbCIgaW4gY3JlZGVudGlhbHMpIHsKICAgICAgICBjb25zdCB7IGVtYWlsLCBwYXNzd29yZCwgb3B0aW9ucyB9ID0gY3JlZGVudGlhbHM7CiAgICAgICAgcmVzID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vdG9rZW4/Z3JhbnRfdHlwZT1wYXNzd29yZGAsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGJvZHk6IHsKICAgICAgICAgICAgZW1haWwsCiAgICAgICAgICAgIHBhc3N3b3JkLAogICAgICAgICAgICBnb3RydWVfbWV0YV9zZWN1cml0eTogeyBjYXB0Y2hhX3Rva2VuOiBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuY2FwdGNoYVRva2VuIH0KICAgICAgICAgIH0sCiAgICAgICAgICB4Zm9ybTogX3Nlc3Npb25SZXNwb25zZVBhc3N3b3JkCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSBpZiAoInBob25lIiBpbiBjcmVkZW50aWFscykgewogICAgICAgIGNvbnN0IHsgcGhvbmUsIHBhc3N3b3JkLCBvcHRpb25zIH0gPSBjcmVkZW50aWFsczsKICAgICAgICByZXMgPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGAke3RoaXMudXJsfS90b2tlbj9ncmFudF90eXBlPXBhc3N3b3JkYCwgewogICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgYm9keTogewogICAgICAgICAgICBwaG9uZSwKICAgICAgICAgICAgcGFzc3dvcmQsCiAgICAgICAgICAgIGdvdHJ1ZV9tZXRhX3NlY3VyaXR5OiB7IGNhcHRjaGFfdG9rZW46IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5jYXB0Y2hhVG9rZW4gfQogICAgICAgICAgfSwKICAgICAgICAgIHhmb3JtOiBfc2Vzc2lvblJlc3BvbnNlUGFzc3dvcmQKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgQXV0aEludmFsaWRDcmVkZW50aWFsc0Vycm9yKCJZb3UgbXVzdCBwcm92aWRlIGVpdGhlciBhbiBlbWFpbCBvciBwaG9uZSBudW1iZXIgYW5kIGEgcGFzc3dvcmQiKTsKICAgICAgfQogICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSByZXM7CiAgICAgIGlmIChlcnJvcikgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0gZWxzZSBpZiAoIWRhdGEgfHwgIWRhdGEuc2Vzc2lvbiB8fCAhZGF0YS51c2VyKSB7CiAgICAgICAgY29uc3QgaW52YWxpZFRva2VuRXJyb3IgPSBuZXcgQXV0aEludmFsaWRUb2tlblJlc3BvbnNlRXJyb3IoKTsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yOiBpbnZhbGlkVG9rZW5FcnJvciB9KTsKICAgICAgfQogICAgICBpZiAoZGF0YS5zZXNzaW9uKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fc2F2ZVNlc3Npb24oZGF0YS5zZXNzaW9uKTsKICAgICAgICBhd2FpdCB0aGlzLl9ub3RpZnlBbGxTdWJzY3JpYmVycygiU0lHTkVEX0lOIiwgZGF0YS5zZXNzaW9uKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsKICAgICAgICBkYXRhOiBPYmplY3QuYXNzaWduKHsgdXNlcjogZGF0YS51c2VyLCBzZXNzaW9uOiBkYXRhLnNlc3Npb24gfSwgZGF0YS53ZWFrX3Bhc3N3b3JkID8geyB3ZWFrUGFzc3dvcmQ6IGRhdGEud2Vha19wYXNzd29yZCB9IDogbnVsbCksCiAgICAgICAgZXJyb3IKICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogTG9nIGluIGFuIGV4aXN0aW5nIHVzZXIgdmlhIGEgdGhpcmQtcGFydHkgcHJvdmlkZXIuCiAgICogVGhpcyBtZXRob2Qgc3VwcG9ydHMgdGhlIFBLQ0UgZmxvdy4KICAgKi8KICBhc3luYyBzaWduSW5XaXRoT0F1dGgoY3JlZGVudGlhbHMpIHsKICAgIHZhciBfYSwgX2IsIF9jLCBfZDsKICAgIHJldHVybiBhd2FpdCB0aGlzLl9oYW5kbGVQcm92aWRlclNpZ25JbihjcmVkZW50aWFscy5wcm92aWRlciwgewogICAgICByZWRpcmVjdFRvOiAoX2EgPSBjcmVkZW50aWFscy5vcHRpb25zKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucmVkaXJlY3RUbywKICAgICAgc2NvcGVzOiAoX2IgPSBjcmVkZW50aWFscy5vcHRpb25zKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Iuc2NvcGVzLAogICAgICBxdWVyeVBhcmFtczogKF9jID0gY3JlZGVudGlhbHMub3B0aW9ucykgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLnF1ZXJ5UGFyYW1zLAogICAgICBza2lwQnJvd3NlclJlZGlyZWN0OiAoX2QgPSBjcmVkZW50aWFscy5vcHRpb25zKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Quc2tpcEJyb3dzZXJSZWRpcmVjdAogICAgfSk7CiAgfQogIC8qKgogICAqIExvZyBpbiBhbiBleGlzdGluZyB1c2VyIGJ5IGV4Y2hhbmdpbmcgYW4gQXV0aCBDb2RlIGlzc3VlZCBkdXJpbmcgdGhlIFBLQ0UgZmxvdy4KICAgKi8KICBhc3luYyBleGNoYW5nZUNvZGVGb3JTZXNzaW9uKGF1dGhDb2RlKSB7CiAgICBhd2FpdCB0aGlzLmluaXRpYWxpemVQcm9taXNlOwogICAgcmV0dXJuIHRoaXMuX2FjcXVpcmVMb2NrKHRoaXMubG9ja0FjcXVpcmVUaW1lb3V0LCBhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiB0aGlzLl9leGNoYW5nZUNvZGVGb3JTZXNzaW9uKGF1dGhDb2RlKTsKICAgIH0pOwogIH0KICAvKioKICAgKiBTaWducyBpbiBhIHVzZXIgYnkgdmVyaWZ5aW5nIGEgbWVzc2FnZSBzaWduZWQgYnkgdGhlIHVzZXIncyBwcml2YXRlIGtleS4KICAgKiBTdXBwb3J0cyBFdGhlcmV1bSAodmlhIFNpZ24tSW4tV2l0aC1FdGhlcmV1bSkgJiBTb2xhbmEgKFNpZ24tSW4tV2l0aC1Tb2xhbmEpIHN0YW5kYXJkcywKICAgKiBib3RoIG9mIHdoaWNoIGRlcml2ZSBmcm9tIHRoZSBFSVAtNDM2MSBzdGFuZGFyZAogICAqIFdpdGggc2xpZ2h0IHZhcmlhdGlvbiBvbiBTb2xhbmEncyBzaWRlLgogICAqIEByZWZlcmVuY2UgaHR0cHM6Ly9laXBzLmV0aGVyZXVtLm9yZy9FSVBTL2VpcC00MzYxCiAgICovCiAgYXN5bmMgc2lnbkluV2l0aFdlYjMoY3JlZGVudGlhbHMpIHsKICAgIGNvbnN0IHsgY2hhaW4gfSA9IGNyZWRlbnRpYWxzOwogICAgc3dpdGNoIChjaGFpbikgewogICAgICBjYXNlICJldGhlcmV1bSI6CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc2lnbkluV2l0aEV0aGVyZXVtKGNyZWRlbnRpYWxzKTsKICAgICAgY2FzZSAic29sYW5hIjoKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5zaWduSW5XaXRoU29sYW5hKGNyZWRlbnRpYWxzKTsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEBzdXBhYmFzZS9hdXRoLWpzOiBVbnN1cHBvcnRlZCBjaGFpbiAiJHtjaGFpbn0iYCk7CiAgICB9CiAgfQogIGFzeW5jIHNpZ25JbldpdGhFdGhlcmV1bShjcmVkZW50aWFscykgewogICAgdmFyIF9hLCBfYiwgX2MsIF9kLCBfZSwgX2YsIF9nLCBfaCwgX2osIF9rLCBfbDsKICAgIGxldCBtZXNzYWdlOwogICAgbGV0IHNpZ25hdHVyZTsKICAgIGlmICgibWVzc2FnZSIgaW4gY3JlZGVudGlhbHMpIHsKICAgICAgbWVzc2FnZSA9IGNyZWRlbnRpYWxzLm1lc3NhZ2U7CiAgICAgIHNpZ25hdHVyZSA9IGNyZWRlbnRpYWxzLnNpZ25hdHVyZTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IHsgY2hhaW4sIHdhbGxldCwgc3RhdGVtZW50LCBvcHRpb25zIH0gPSBjcmVkZW50aWFsczsKICAgICAgbGV0IHJlc29sdmVkV2FsbGV0OwogICAgICBpZiAoIWlzQnJvd3NlcigpKSB7CiAgICAgICAgaWYgKHR5cGVvZiB3YWxsZXQgIT09ICJvYmplY3QiIHx8ICEob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnVybCkpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQHN1cGFiYXNlL2F1dGgtanM6IEJvdGggd2FsbGV0IGFuZCB1cmwgbXVzdCBiZSBzcGVjaWZpZWQgaW4gbm9uLWJyb3dzZXIgZW52aXJvbm1lbnRzLiIpOwogICAgICAgIH0KICAgICAgICByZXNvbHZlZFdhbGxldCA9IHdhbGxldDsKICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygd2FsbGV0ID09PSAib2JqZWN0IikgewogICAgICAgIHJlc29sdmVkV2FsbGV0ID0gd2FsbGV0OwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHdpbmRvd0FueSA9IHdpbmRvdzsKICAgICAgICBpZiAoImV0aGVyZXVtIiBpbiB3aW5kb3dBbnkgJiYgdHlwZW9mIHdpbmRvd0FueS5ldGhlcmV1bSA9PT0gIm9iamVjdCIgJiYgInJlcXVlc3QiIGluIHdpbmRvd0FueS5ldGhlcmV1bSAmJiB0eXBlb2Ygd2luZG93QW55LmV0aGVyZXVtLnJlcXVlc3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHJlc29sdmVkV2FsbGV0ID0gd2luZG93QW55LmV0aGVyZXVtOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEBzdXBhYmFzZS9hdXRoLWpzOiBObyBjb21wYXRpYmxlIEV0aGVyZXVtIHdhbGxldCBpbnRlcmZhY2Ugb24gdGhlIHdpbmRvdyBvYmplY3QgKHdpbmRvdy5ldGhlcmV1bSkgZGV0ZWN0ZWQuIE1ha2Ugc3VyZSB0aGUgdXNlciBhbHJlYWR5IGhhcyBhIHdhbGxldCBpbnN0YWxsZWQgYW5kIGNvbm5lY3RlZCBmb3IgdGhpcyBhcHAuIFByZWZlciBwYXNzaW5nIHRoZSB3YWxsZXQgaW50ZXJmYWNlIG9iamVjdCBkaXJlY3RseSB0byBzaWduSW5XaXRoV2ViMyh7IGNoYWluOiAnZXRoZXJldW0nLCB3YWxsZXQ6IHJlc29sdmVkVXNlcldhbGxldCB9KSBpbnN0ZWFkLmApOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCB1cmwgPSBuZXcgVVJMKChfYSA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy51cmwpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IHdpbmRvdy5sb2NhdGlvbi5ocmVmKTsKICAgICAgY29uc3QgYWNjb3VudHMgPSBhd2FpdCByZXNvbHZlZFdhbGxldC5yZXF1ZXN0KHsKICAgICAgICBtZXRob2Q6ICJldGhfcmVxdWVzdEFjY291bnRzIgogICAgICB9KS50aGVuKChhY2NzKSA9PiBhY2NzKS5jYXRjaCgoKSA9PiB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBAc3VwYWJhc2UvYXV0aC1qczogV2FsbGV0IG1ldGhvZCBldGhfcmVxdWVzdEFjY291bnRzIGlzIG1pc3Npbmcgb3IgaW52YWxpZGApOwogICAgICB9KTsKICAgICAgaWYgKCFhY2NvdW50cyB8fCBhY2NvdW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEBzdXBhYmFzZS9hdXRoLWpzOiBObyBhY2NvdW50cyBhdmFpbGFibGUuIFBsZWFzZSBlbnN1cmUgdGhlIHdhbGxldCBpcyBjb25uZWN0ZWQuYCk7CiAgICAgIH0KICAgICAgY29uc3QgYWRkcmVzcyA9IGdldEFkZHJlc3MoYWNjb3VudHNbMF0pOwogICAgICBsZXQgY2hhaW5JZCA9IChfYiA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5zaWduSW5XaXRoRXRoZXJldW0pID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5jaGFpbklkOwogICAgICBpZiAoIWNoYWluSWQpIHsKICAgICAgICBjb25zdCBjaGFpbklkSGV4ID0gYXdhaXQgcmVzb2x2ZWRXYWxsZXQucmVxdWVzdCh7CiAgICAgICAgICBtZXRob2Q6ICJldGhfY2hhaW5JZCIKICAgICAgICB9KTsKICAgICAgICBjaGFpbklkID0gZnJvbUhleChjaGFpbklkSGV4KTsKICAgICAgfQogICAgICBjb25zdCBzaXdlTWVzc2FnZSA9IHsKICAgICAgICBkb21haW46IHVybC5ob3N0LAogICAgICAgIGFkZHJlc3MsCiAgICAgICAgc3RhdGVtZW50LAogICAgICAgIHVyaTogdXJsLmhyZWYsCiAgICAgICAgdmVyc2lvbjogIjEiLAogICAgICAgIGNoYWluSWQsCiAgICAgICAgbm9uY2U6IChfYyA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5zaWduSW5XaXRoRXRoZXJldW0pID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5ub25jZSwKICAgICAgICBpc3N1ZWRBdDogKF9lID0gKF9kID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNpZ25JbldpdGhFdGhlcmV1bSkgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kLmlzc3VlZEF0KSAhPT0gbnVsbCAmJiBfZSAhPT0gdm9pZCAwID8gX2UgOiAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSwKICAgICAgICBleHBpcmF0aW9uVGltZTogKF9mID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNpZ25JbldpdGhFdGhlcmV1bSkgPT09IG51bGwgfHwgX2YgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9mLmV4cGlyYXRpb25UaW1lLAogICAgICAgIG5vdEJlZm9yZTogKF9nID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNpZ25JbldpdGhFdGhlcmV1bSkgPT09IG51bGwgfHwgX2cgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9nLm5vdEJlZm9yZSwKICAgICAgICByZXF1ZXN0SWQ6IChfaCA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5zaWduSW5XaXRoRXRoZXJldW0pID09PSBudWxsIHx8IF9oID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfaC5yZXF1ZXN0SWQsCiAgICAgICAgcmVzb3VyY2VzOiAoX2ogPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc2lnbkluV2l0aEV0aGVyZXVtKSA9PT0gbnVsbCB8fCBfaiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2oucmVzb3VyY2VzCiAgICAgIH07CiAgICAgIG1lc3NhZ2UgPSBjcmVhdGVTaXdlTWVzc2FnZShzaXdlTWVzc2FnZSk7CiAgICAgIHNpZ25hdHVyZSA9IGF3YWl0IHJlc29sdmVkV2FsbGV0LnJlcXVlc3QoewogICAgICAgIG1ldGhvZDogInBlcnNvbmFsX3NpZ24iLAogICAgICAgIHBhcmFtczogW3RvSGV4KG1lc3NhZ2UpLCBhZGRyZXNzXQogICAgICB9KTsKICAgIH0KICAgIHRyeSB7CiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L3Rva2VuP2dyYW50X3R5cGU9d2ViM2AsIHsKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgYm9keTogT2JqZWN0LmFzc2lnbih7CiAgICAgICAgICBjaGFpbjogImV0aGVyZXVtIiwKICAgICAgICAgIG1lc3NhZ2UsCiAgICAgICAgICBzaWduYXR1cmUKICAgICAgICB9LCAoKF9rID0gY3JlZGVudGlhbHMub3B0aW9ucykgPT09IG51bGwgfHwgX2sgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9rLmNhcHRjaGFUb2tlbikgPyB7IGdvdHJ1ZV9tZXRhX3NlY3VyaXR5OiB7IGNhcHRjaGFfdG9rZW46IChfbCA9IGNyZWRlbnRpYWxzLm9wdGlvbnMpID09PSBudWxsIHx8IF9sID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfbC5jYXB0Y2hhVG9rZW4gfSB9IDogbnVsbCksCiAgICAgICAgeGZvcm06IF9zZXNzaW9uUmVzcG9uc2UKICAgICAgfSk7CiAgICAgIGlmIChlcnJvcikgewogICAgICAgIHRocm93IGVycm9yOwogICAgICB9CiAgICAgIGlmICghZGF0YSB8fCAhZGF0YS5zZXNzaW9uIHx8ICFkYXRhLnVzZXIpIHsKICAgICAgICBjb25zdCBpbnZhbGlkVG9rZW5FcnJvciA9IG5ldyBBdXRoSW52YWxpZFRva2VuUmVzcG9uc2VFcnJvcigpOwogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3I6IGludmFsaWRUb2tlbkVycm9yIH0pOwogICAgICB9CiAgICAgIGlmIChkYXRhLnNlc3Npb24pIHsKICAgICAgICBhd2FpdCB0aGlzLl9zYXZlU2Vzc2lvbihkYXRhLnNlc3Npb24pOwogICAgICAgIGF3YWl0IHRoaXMuX25vdGlmeUFsbFN1YnNjcmliZXJzKCJTSUdORURfSU4iLCBkYXRhLnNlc3Npb24pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBPYmplY3QuYXNzaWduKHt9LCBkYXRhKSwgZXJyb3IgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgYXN5bmMgc2lnbkluV2l0aFNvbGFuYShjcmVkZW50aWFscykgewogICAgdmFyIF9hLCBfYiwgX2MsIF9kLCBfZSwgX2YsIF9nLCBfaCwgX2osIF9rLCBfbCwgX207CiAgICBsZXQgbWVzc2FnZTsKICAgIGxldCBzaWduYXR1cmU7CiAgICBpZiAoIm1lc3NhZ2UiIGluIGNyZWRlbnRpYWxzKSB7CiAgICAgIG1lc3NhZ2UgPSBjcmVkZW50aWFscy5tZXNzYWdlOwogICAgICBzaWduYXR1cmUgPSBjcmVkZW50aWFscy5zaWduYXR1cmU7CiAgICB9IGVsc2UgewogICAgICBjb25zdCB7IGNoYWluLCB3YWxsZXQsIHN0YXRlbWVudCwgb3B0aW9ucyB9ID0gY3JlZGVudGlhbHM7CiAgICAgIGxldCByZXNvbHZlZFdhbGxldDsKICAgICAgaWYgKCFpc0Jyb3dzZXIoKSkgewogICAgICAgIGlmICh0eXBlb2Ygd2FsbGV0ICE9PSAib2JqZWN0IiB8fCAhKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy51cmwpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkBzdXBhYmFzZS9hdXRoLWpzOiBCb3RoIHdhbGxldCBhbmQgdXJsIG11c3QgYmUgc3BlY2lmaWVkIGluIG5vbi1icm93c2VyIGVudmlyb25tZW50cy4iKTsKICAgICAgICB9CiAgICAgICAgcmVzb2x2ZWRXYWxsZXQgPSB3YWxsZXQ7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHdhbGxldCA9PT0gIm9iamVjdCIpIHsKICAgICAgICByZXNvbHZlZFdhbGxldCA9IHdhbGxldDsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCB3aW5kb3dBbnkgPSB3aW5kb3c7CiAgICAgICAgaWYgKCJzb2xhbmEiIGluIHdpbmRvd0FueSAmJiB0eXBlb2Ygd2luZG93QW55LnNvbGFuYSA9PT0gIm9iamVjdCIgJiYgKCJzaWduSW4iIGluIHdpbmRvd0FueS5zb2xhbmEgJiYgdHlwZW9mIHdpbmRvd0FueS5zb2xhbmEuc2lnbkluID09PSAiZnVuY3Rpb24iIHx8ICJzaWduTWVzc2FnZSIgaW4gd2luZG93QW55LnNvbGFuYSAmJiB0eXBlb2Ygd2luZG93QW55LnNvbGFuYS5zaWduTWVzc2FnZSA9PT0gImZ1bmN0aW9uIikpIHsKICAgICAgICAgIHJlc29sdmVkV2FsbGV0ID0gd2luZG93QW55LnNvbGFuYTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBAc3VwYWJhc2UvYXV0aC1qczogTm8gY29tcGF0aWJsZSBTb2xhbmEgd2FsbGV0IGludGVyZmFjZSBvbiB0aGUgd2luZG93IG9iamVjdCAod2luZG93LnNvbGFuYSkgZGV0ZWN0ZWQuIE1ha2Ugc3VyZSB0aGUgdXNlciBhbHJlYWR5IGhhcyBhIHdhbGxldCBpbnN0YWxsZWQgYW5kIGNvbm5lY3RlZCBmb3IgdGhpcyBhcHAuIFByZWZlciBwYXNzaW5nIHRoZSB3YWxsZXQgaW50ZXJmYWNlIG9iamVjdCBkaXJlY3RseSB0byBzaWduSW5XaXRoV2ViMyh7IGNoYWluOiAnc29sYW5hJywgd2FsbGV0OiByZXNvbHZlZFVzZXJXYWxsZXQgfSkgaW5zdGVhZC5gKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgdXJsID0gbmV3IFVSTCgoX2EgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMudXJsKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiB3aW5kb3cubG9jYXRpb24uaHJlZik7CiAgICAgIGlmICgic2lnbkluIiBpbiByZXNvbHZlZFdhbGxldCAmJiByZXNvbHZlZFdhbGxldC5zaWduSW4pIHsKICAgICAgICBjb25zdCBvdXRwdXQgPSBhd2FpdCByZXNvbHZlZFdhbGxldC5zaWduSW4oT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oeyBpc3N1ZWRBdDogKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS50b0lTT1N0cmluZygpIH0sIG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5zaWduSW5XaXRoU29sYW5hKSwgewogICAgICAgICAgLy8gbm9uLW92ZXJyaWRhYmxlIHByb3BlcnRpZXMKICAgICAgICAgIHZlcnNpb246ICIxIiwKICAgICAgICAgIGRvbWFpbjogdXJsLmhvc3QsCiAgICAgICAgICB1cmk6IHVybC5ocmVmCiAgICAgICAgfSksIHN0YXRlbWVudCA/IHsgc3RhdGVtZW50IH0gOiBudWxsKSk7CiAgICAgICAgbGV0IG91dHB1dFRvUHJvY2VzczsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShvdXRwdXQpICYmIG91dHB1dFswXSAmJiB0eXBlb2Ygb3V0cHV0WzBdID09PSAib2JqZWN0IikgewogICAgICAgICAgb3V0cHV0VG9Qcm9jZXNzID0gb3V0cHV0WzBdOwogICAgICAgIH0gZWxzZSBpZiAob3V0cHV0ICYmIHR5cGVvZiBvdXRwdXQgPT09ICJvYmplY3QiICYmICJzaWduZWRNZXNzYWdlIiBpbiBvdXRwdXQgJiYgInNpZ25hdHVyZSIgaW4gb3V0cHV0KSB7CiAgICAgICAgICBvdXRwdXRUb1Byb2Nlc3MgPSBvdXRwdXQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQHN1cGFiYXNlL2F1dGgtanM6IFdhbGxldCBtZXRob2Qgc2lnbkluKCkgcmV0dXJuZWQgdW5yZWNvZ25pemVkIHZhbHVlIik7CiAgICAgICAgfQogICAgICAgIGlmICgic2lnbmVkTWVzc2FnZSIgaW4gb3V0cHV0VG9Qcm9jZXNzICYmICJzaWduYXR1cmUiIGluIG91dHB1dFRvUHJvY2VzcyAmJiAodHlwZW9mIG91dHB1dFRvUHJvY2Vzcy5zaWduZWRNZXNzYWdlID09PSAic3RyaW5nIiB8fCBvdXRwdXRUb1Byb2Nlc3Muc2lnbmVkTWVzc2FnZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpICYmIG91dHB1dFRvUHJvY2Vzcy5zaWduYXR1cmUgaW5zdGFuY2VvZiBVaW50OEFycmF5KSB7CiAgICAgICAgICBtZXNzYWdlID0gdHlwZW9mIG91dHB1dFRvUHJvY2Vzcy5zaWduZWRNZXNzYWdlID09PSAic3RyaW5nIiA/IG91dHB1dFRvUHJvY2Vzcy5zaWduZWRNZXNzYWdlIDogbmV3IFRleHREZWNvZGVyKCkuZGVjb2RlKG91dHB1dFRvUHJvY2Vzcy5zaWduZWRNZXNzYWdlKTsKICAgICAgICAgIHNpZ25hdHVyZSA9IG91dHB1dFRvUHJvY2Vzcy5zaWduYXR1cmU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQHN1cGFiYXNlL2F1dGgtanM6IFdhbGxldCBtZXRob2Qgc2lnbkluKCkgQVBJIHJldHVybmVkIG9iamVjdCB3aXRob3V0IHNpZ25lZE1lc3NhZ2UgYW5kIHNpZ25hdHVyZSBmaWVsZHMiKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCEoInNpZ25NZXNzYWdlIiBpbiByZXNvbHZlZFdhbGxldCkgfHwgdHlwZW9mIHJlc29sdmVkV2FsbGV0LnNpZ25NZXNzYWdlICE9PSAiZnVuY3Rpb24iIHx8ICEoInB1YmxpY0tleSIgaW4gcmVzb2x2ZWRXYWxsZXQpIHx8IHR5cGVvZiByZXNvbHZlZFdhbGxldCAhPT0gIm9iamVjdCIgfHwgIXJlc29sdmVkV2FsbGV0LnB1YmxpY0tleSB8fCAhKCJ0b0Jhc2U1OCIgaW4gcmVzb2x2ZWRXYWxsZXQucHVibGljS2V5KSB8fCB0eXBlb2YgcmVzb2x2ZWRXYWxsZXQucHVibGljS2V5LnRvQmFzZTU4ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkBzdXBhYmFzZS9hdXRoLWpzOiBXYWxsZXQgZG9lcyBub3QgaGF2ZSBhIGNvbXBhdGlibGUgc2lnbk1lc3NhZ2UoKSBhbmQgcHVibGljS2V5LnRvQmFzZTU4KCkgQVBJIik7CiAgICAgICAgfQogICAgICAgIG1lc3NhZ2UgPSBbCiAgICAgICAgICBgJHt1cmwuaG9zdH0gd2FudHMgeW91IHRvIHNpZ24gaW4gd2l0aCB5b3VyIFNvbGFuYSBhY2NvdW50OmAsCiAgICAgICAgICByZXNvbHZlZFdhbGxldC5wdWJsaWNLZXkudG9CYXNlNTgoKSwKICAgICAgICAgIC4uLnN0YXRlbWVudCA/IFsiIiwgc3RhdGVtZW50LCAiIl0gOiBbIiJdLAogICAgICAgICAgIlZlcnNpb246IDEiLAogICAgICAgICAgYFVSSTogJHt1cmwuaHJlZn1gLAogICAgICAgICAgYElzc3VlZCBBdDogJHsoX2MgPSAoX2IgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc2lnbkluV2l0aFNvbGFuYSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmlzc3VlZEF0KSAhPT0gbnVsbCAmJiBfYyAhPT0gdm9pZCAwID8gX2MgOiAoLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkpLnRvSVNPU3RyaW5nKCl9YCwKICAgICAgICAgIC4uLigoX2QgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc2lnbkluV2l0aFNvbGFuYSkgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kLm5vdEJlZm9yZSkgPyBbYE5vdCBCZWZvcmU6ICR7b3B0aW9ucy5zaWduSW5XaXRoU29sYW5hLm5vdEJlZm9yZX1gXSA6IFtdLAogICAgICAgICAgLi4uKChfZSA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5zaWduSW5XaXRoU29sYW5hKSA9PT0gbnVsbCB8fCBfZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2UuZXhwaXJhdGlvblRpbWUpID8gW2BFeHBpcmF0aW9uIFRpbWU6ICR7b3B0aW9ucy5zaWduSW5XaXRoU29sYW5hLmV4cGlyYXRpb25UaW1lfWBdIDogW10sCiAgICAgICAgICAuLi4oKF9mID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNpZ25JbldpdGhTb2xhbmEpID09PSBudWxsIHx8IF9mID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZi5jaGFpbklkKSA/IFtgQ2hhaW4gSUQ6ICR7b3B0aW9ucy5zaWduSW5XaXRoU29sYW5hLmNoYWluSWR9YF0gOiBbXSwKICAgICAgICAgIC4uLigoX2cgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc2lnbkluV2l0aFNvbGFuYSkgPT09IG51bGwgfHwgX2cgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9nLm5vbmNlKSA/IFtgTm9uY2U6ICR7b3B0aW9ucy5zaWduSW5XaXRoU29sYW5hLm5vbmNlfWBdIDogW10sCiAgICAgICAgICAuLi4oKF9oID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNpZ25JbldpdGhTb2xhbmEpID09PSBudWxsIHx8IF9oID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfaC5yZXF1ZXN0SWQpID8gW2BSZXF1ZXN0IElEOiAke29wdGlvbnMuc2lnbkluV2l0aFNvbGFuYS5yZXF1ZXN0SWR9YF0gOiBbXSwKICAgICAgICAgIC4uLigoX2sgPSAoX2ogPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc2lnbkluV2l0aFNvbGFuYSkgPT09IG51bGwgfHwgX2ogPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9qLnJlc291cmNlcykgPT09IG51bGwgfHwgX2sgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9rLmxlbmd0aCkgPyBbCiAgICAgICAgICAgICJSZXNvdXJjZXMiLAogICAgICAgICAgICAuLi5vcHRpb25zLnNpZ25JbldpdGhTb2xhbmEucmVzb3VyY2VzLm1hcCgocmVzb3VyY2UpID0+IGAtICR7cmVzb3VyY2V9YCkKICAgICAgICAgIF0gOiBbXQogICAgICAgIF0uam9pbigiXG4iKTsKICAgICAgICBjb25zdCBtYXliZVNpZ25hdHVyZSA9IGF3YWl0IHJlc29sdmVkV2FsbGV0LnNpZ25NZXNzYWdlKG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShtZXNzYWdlKSwgInV0ZjgiKTsKICAgICAgICBpZiAoIW1heWJlU2lnbmF0dXJlIHx8ICEobWF5YmVTaWduYXR1cmUgaW5zdGFuY2VvZiBVaW50OEFycmF5KSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJAc3VwYWJhc2UvYXV0aC1qczogV2FsbGV0IHNpZ25NZXNzYWdlKCkgQVBJIHJldHVybmVkIGFuIHJlY29nbml6ZWQgdmFsdWUiKTsKICAgICAgICB9CiAgICAgICAgc2lnbmF0dXJlID0gbWF5YmVTaWduYXR1cmU7CiAgICAgIH0KICAgIH0KICAgIHRyeSB7CiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L3Rva2VuP2dyYW50X3R5cGU9d2ViM2AsIHsKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgYm9keTogT2JqZWN0LmFzc2lnbih7IGNoYWluOiAic29sYW5hIiwgbWVzc2FnZSwgc2lnbmF0dXJlOiBieXRlc1RvQmFzZTY0VVJMKHNpZ25hdHVyZSkgfSwgKChfbCA9IGNyZWRlbnRpYWxzLm9wdGlvbnMpID09PSBudWxsIHx8IF9sID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfbC5jYXB0Y2hhVG9rZW4pID8geyBnb3RydWVfbWV0YV9zZWN1cml0eTogeyBjYXB0Y2hhX3Rva2VuOiAoX20gPSBjcmVkZW50aWFscy5vcHRpb25zKSA9PT0gbnVsbCB8fCBfbSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX20uY2FwdGNoYVRva2VuIH0gfSA6IG51bGwpLAogICAgICAgIHhmb3JtOiBfc2Vzc2lvblJlc3BvbnNlCiAgICAgIH0pOwogICAgICBpZiAoZXJyb3IpIHsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgICBpZiAoIWRhdGEgfHwgIWRhdGEuc2Vzc2lvbiB8fCAhZGF0YS51c2VyKSB7CiAgICAgICAgY29uc3QgaW52YWxpZFRva2VuRXJyb3IgPSBuZXcgQXV0aEludmFsaWRUb2tlblJlc3BvbnNlRXJyb3IoKTsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yOiBpbnZhbGlkVG9rZW5FcnJvciB9KTsKICAgICAgfQogICAgICBpZiAoZGF0YS5zZXNzaW9uKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fc2F2ZVNlc3Npb24oZGF0YS5zZXNzaW9uKTsKICAgICAgICBhd2FpdCB0aGlzLl9ub3RpZnlBbGxTdWJzY3JpYmVycygiU0lHTkVEX0lOIiwgZGF0YS5zZXNzaW9uKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogT2JqZWN0LmFzc2lnbih7fSwgZGF0YSksIGVycm9yIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIGFzeW5jIF9leGNoYW5nZUNvZGVGb3JTZXNzaW9uKGF1dGhDb2RlKSB7CiAgICBjb25zdCBzdG9yYWdlSXRlbSA9IGF3YWl0IGdldEl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIGAke3RoaXMuc3RvcmFnZUtleX0tY29kZS12ZXJpZmllcmApOwogICAgY29uc3QgW2NvZGVWZXJpZmllciwgcmVkaXJlY3RUeXBlXSA9IChzdG9yYWdlSXRlbSAhPT0gbnVsbCAmJiBzdG9yYWdlSXRlbSAhPT0gdm9pZCAwID8gc3RvcmFnZUl0ZW0gOiAiIikuc3BsaXQoIi8iKTsKICAgIHRyeSB7CiAgICAgIGlmICghY29kZVZlcmlmaWVyICYmIHRoaXMuZmxvd1R5cGUgPT09ICJwa2NlIikgewogICAgICAgIHRocm93IG5ldyBBdXRoUEtDRUNvZGVWZXJpZmllck1pc3NpbmdFcnJvcigpOwogICAgICB9CiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L3Rva2VuP2dyYW50X3R5cGU9cGtjZWAsIHsKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgYm9keTogewogICAgICAgICAgYXV0aF9jb2RlOiBhdXRoQ29kZSwKICAgICAgICAgIGNvZGVfdmVyaWZpZXI6IGNvZGVWZXJpZmllcgogICAgICAgIH0sCiAgICAgICAgeGZvcm06IF9zZXNzaW9uUmVzcG9uc2UKICAgICAgfSk7CiAgICAgIGF3YWl0IHJlbW92ZUl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIGAke3RoaXMuc3RvcmFnZUtleX0tY29kZS12ZXJpZmllcmApOwogICAgICBpZiAoZXJyb3IpIHsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgICBpZiAoIWRhdGEgfHwgIWRhdGEuc2Vzc2lvbiB8fCAhZGF0YS51c2VyKSB7CiAgICAgICAgY29uc3QgaW52YWxpZFRva2VuRXJyb3IgPSBuZXcgQXV0aEludmFsaWRUb2tlblJlc3BvbnNlRXJyb3IoKTsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsKICAgICAgICAgIGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCwgcmVkaXJlY3RUeXBlOiBudWxsIH0sCiAgICAgICAgICBlcnJvcjogaW52YWxpZFRva2VuRXJyb3IKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoZGF0YS5zZXNzaW9uKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fc2F2ZVNlc3Npb24oZGF0YS5zZXNzaW9uKTsKICAgICAgICBhd2FpdCB0aGlzLl9ub3RpZnlBbGxTdWJzY3JpYmVycygiU0lHTkVEX0lOIiwgZGF0YS5zZXNzaW9uKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBkYXRhKSwgeyByZWRpcmVjdFR5cGU6IHJlZGlyZWN0VHlwZSAhPT0gbnVsbCAmJiByZWRpcmVjdFR5cGUgIT09IHZvaWQgMCA/IHJlZGlyZWN0VHlwZSA6IG51bGwgfSksIGVycm9yIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgYXdhaXQgcmVtb3ZlSXRlbUFzeW5jKHRoaXMuc3RvcmFnZSwgYCR7dGhpcy5zdG9yYWdlS2V5fS1jb2RlLXZlcmlmaWVyYCk7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsKICAgICAgICAgIGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCwgcmVkaXJlY3RUeXBlOiBudWxsIH0sCiAgICAgICAgICBlcnJvcgogICAgICAgIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBBbGxvd3Mgc2lnbmluZyBpbiB3aXRoIGFuIE9JREMgSUQgdG9rZW4uIFRoZSBhdXRoZW50aWNhdGlvbiBwcm92aWRlciB1c2VkCiAgICogc2hvdWxkIGJlIGVuYWJsZWQgYW5kIGNvbmZpZ3VyZWQuCiAgICovCiAgYXN5bmMgc2lnbkluV2l0aElkVG9rZW4oY3JlZGVudGlhbHMpIHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHsgb3B0aW9ucywgcHJvdmlkZXIsIHRva2VuLCBhY2Nlc3NfdG9rZW4sIG5vbmNlIH0gPSBjcmVkZW50aWFsczsKICAgICAgY29uc3QgcmVzID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vdG9rZW4/Z3JhbnRfdHlwZT1pZF90b2tlbmAsIHsKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgYm9keTogewogICAgICAgICAgcHJvdmlkZXIsCiAgICAgICAgICBpZF90b2tlbjogdG9rZW4sCiAgICAgICAgICBhY2Nlc3NfdG9rZW4sCiAgICAgICAgICBub25jZSwKICAgICAgICAgIGdvdHJ1ZV9tZXRhX3NlY3VyaXR5OiB7IGNhcHRjaGFfdG9rZW46IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5jYXB0Y2hhVG9rZW4gfQogICAgICAgIH0sCiAgICAgICAgeGZvcm06IF9zZXNzaW9uUmVzcG9uc2UKICAgICAgfSk7CiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IHJlczsKICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfSBlbHNlIGlmICghZGF0YSB8fCAhZGF0YS5zZXNzaW9uIHx8ICFkYXRhLnVzZXIpIHsKICAgICAgICBjb25zdCBpbnZhbGlkVG9rZW5FcnJvciA9IG5ldyBBdXRoSW52YWxpZFRva2VuUmVzcG9uc2VFcnJvcigpOwogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3I6IGludmFsaWRUb2tlbkVycm9yIH0pOwogICAgICB9CiAgICAgIGlmIChkYXRhLnNlc3Npb24pIHsKICAgICAgICBhd2FpdCB0aGlzLl9zYXZlU2Vzc2lvbihkYXRhLnNlc3Npb24pOwogICAgICAgIGF3YWl0IHRoaXMuX25vdGlmeUFsbFN1YnNjcmliZXJzKCJTSUdORURfSU4iLCBkYXRhLnNlc3Npb24pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhLCBlcnJvciB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBMb2cgaW4gYSB1c2VyIHVzaW5nIG1hZ2ljbGluayBvciBhIG9uZS10aW1lIHBhc3N3b3JkIChPVFApLgogICAqCiAgICogSWYgdGhlIGB7eyAuQ29uZmlybWF0aW9uVVJMIH19YCB2YXJpYWJsZSBpcyBzcGVjaWZpZWQgaW4gdGhlIGVtYWlsIHRlbXBsYXRlLCBhIG1hZ2ljbGluayB3aWxsIGJlIHNlbnQuCiAgICogSWYgdGhlIGB7eyAuVG9rZW4gfX1gIHZhcmlhYmxlIGlzIHNwZWNpZmllZCBpbiB0aGUgZW1haWwgdGVtcGxhdGUsIGFuIE9UUCB3aWxsIGJlIHNlbnQuCiAgICogSWYgeW91J3JlIHVzaW5nIHBob25lIHNpZ24taW5zLCBvbmx5IGFuIE9UUCB3aWxsIGJlIHNlbnQuIFlvdSB3b24ndCBiZSBhYmxlIHRvIHNlbmQgYSBtYWdpY2xpbmsgZm9yIHBob25lIHNpZ24taW5zLgogICAqCiAgICogQmUgYXdhcmUgdGhhdCB5b3UgbWF5IGdldCBiYWNrIGFuIGVycm9yIG1lc3NhZ2UgdGhhdCB3aWxsIG5vdCBkaXN0aW5ndWlzaAogICAqIGJldHdlZW4gdGhlIGNhc2VzIHdoZXJlIHRoZSBhY2NvdW50IGRvZXMgbm90IGV4aXN0IG9yLCB0aGF0IHRoZSBhY2NvdW50CiAgICogY2FuIG9ubHkgYmUgYWNjZXNzZWQgdmlhIHNvY2lhbCBsb2dpbi4KICAgKgogICAqIERvIG5vdGUgdGhhdCB5b3Ugd2lsbCBuZWVkIHRvIGNvbmZpZ3VyZSBhIFdoYXRzYXBwIHNlbmRlciBvbiBUd2lsaW8KICAgKiBpZiB5b3UgYXJlIHVzaW5nIHBob25lIHNpZ24gaW4gd2l0aCB0aGUgJ3doYXRzYXBwJyBjaGFubmVsLiBUaGUgd2hhdHNhcHAKICAgKiBjaGFubmVsIGlzIG5vdCBzdXBwb3J0ZWQgb24gb3RoZXIgcHJvdmlkZXJzCiAgICogYXQgdGhpcyB0aW1lLgogICAqIFRoaXMgbWV0aG9kIHN1cHBvcnRzIFBLQ0Ugd2hlbiBhbiBlbWFpbCBpcyBwYXNzZWQuCiAgICovCiAgYXN5bmMgc2lnbkluV2l0aE90cChjcmVkZW50aWFscykgewogICAgdmFyIF9hLCBfYiwgX2MsIF9kLCBfZTsKICAgIHRyeSB7CiAgICAgIGlmICgiZW1haWwiIGluIGNyZWRlbnRpYWxzKSB7CiAgICAgICAgY29uc3QgeyBlbWFpbCwgb3B0aW9ucyB9ID0gY3JlZGVudGlhbHM7CiAgICAgICAgbGV0IGNvZGVDaGFsbGVuZ2UgPSBudWxsOwogICAgICAgIGxldCBjb2RlQ2hhbGxlbmdlTWV0aG9kID0gbnVsbDsKICAgICAgICBpZiAodGhpcy5mbG93VHlwZSA9PT0gInBrY2UiKSB7CiAgICAgICAgICA7CiAgICAgICAgICBbY29kZUNoYWxsZW5nZSwgY29kZUNoYWxsZW5nZU1ldGhvZF0gPSBhd2FpdCBnZXRDb2RlQ2hhbGxlbmdlQW5kTWV0aG9kKHRoaXMuc3RvcmFnZSwgdGhpcy5zdG9yYWdlS2V5KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vb3RwYCwgewogICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgYm9keTogewogICAgICAgICAgICBlbWFpbCwKICAgICAgICAgICAgZGF0YTogKF9hID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmRhdGEpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IHt9LAogICAgICAgICAgICBjcmVhdGVfdXNlcjogKF9iID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNob3VsZENyZWF0ZVVzZXIpICE9PSBudWxsICYmIF9iICE9PSB2b2lkIDAgPyBfYiA6IHRydWUsCiAgICAgICAgICAgIGdvdHJ1ZV9tZXRhX3NlY3VyaXR5OiB7IGNhcHRjaGFfdG9rZW46IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5jYXB0Y2hhVG9rZW4gfSwKICAgICAgICAgICAgY29kZV9jaGFsbGVuZ2U6IGNvZGVDaGFsbGVuZ2UsCiAgICAgICAgICAgIGNvZGVfY2hhbGxlbmdlX21ldGhvZDogY29kZUNoYWxsZW5nZU1ldGhvZAogICAgICAgICAgfSwKICAgICAgICAgIHJlZGlyZWN0VG86IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5lbWFpbFJlZGlyZWN0VG8KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9CiAgICAgIGlmICgicGhvbmUiIGluIGNyZWRlbnRpYWxzKSB7CiAgICAgICAgY29uc3QgeyBwaG9uZSwgb3B0aW9ucyB9ID0gY3JlZGVudGlhbHM7CiAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vb3RwYCwgewogICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgYm9keTogewogICAgICAgICAgICBwaG9uZSwKICAgICAgICAgICAgZGF0YTogKF9jID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmRhdGEpICE9PSBudWxsICYmIF9jICE9PSB2b2lkIDAgPyBfYyA6IHt9LAogICAgICAgICAgICBjcmVhdGVfdXNlcjogKF9kID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNob3VsZENyZWF0ZVVzZXIpICE9PSBudWxsICYmIF9kICE9PSB2b2lkIDAgPyBfZCA6IHRydWUsCiAgICAgICAgICAgIGdvdHJ1ZV9tZXRhX3NlY3VyaXR5OiB7IGNhcHRjaGFfdG9rZW46IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5jYXB0Y2hhVG9rZW4gfSwKICAgICAgICAgICAgY2hhbm5lbDogKF9lID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmNoYW5uZWwpICE9PSBudWxsICYmIF9lICE9PSB2b2lkIDAgPyBfZSA6ICJzbXMiCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7CiAgICAgICAgICBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwsIG1lc3NhZ2VJZDogZGF0YSA9PT0gbnVsbCB8fCBkYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhLm1lc3NhZ2VfaWQgfSwKICAgICAgICAgIGVycm9yCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgbmV3IEF1dGhJbnZhbGlkQ3JlZGVudGlhbHNFcnJvcigiWW91IG11c3QgcHJvdmlkZSBlaXRoZXIgYW4gZW1haWwgb3IgcGhvbmUgbnVtYmVyLiIpOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgYXdhaXQgcmVtb3ZlSXRlbUFzeW5jKHRoaXMuc3RvcmFnZSwgYCR7dGhpcy5zdG9yYWdlS2V5fS1jb2RlLXZlcmlmaWVyYCk7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBMb2cgaW4gYSB1c2VyIGdpdmVuIGEgVXNlciBzdXBwbGllZCBPVFAgb3IgVG9rZW5IYXNoIHJlY2VpdmVkIHRocm91Z2ggbW9iaWxlIG9yIGVtYWlsLgogICAqLwogIGFzeW5jIHZlcmlmeU90cChwYXJhbXMpIHsKICAgIHZhciBfYSwgX2I7CiAgICB0cnkgewogICAgICBsZXQgcmVkaXJlY3RUbyA9IHZvaWQgMDsKICAgICAgbGV0IGNhcHRjaGFUb2tlbiA9IHZvaWQgMDsKICAgICAgaWYgKCJvcHRpb25zIiBpbiBwYXJhbXMpIHsKICAgICAgICByZWRpcmVjdFRvID0gKF9hID0gcGFyYW1zLm9wdGlvbnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5yZWRpcmVjdFRvOwogICAgICAgIGNhcHRjaGFUb2tlbiA9IChfYiA9IHBhcmFtcy5vcHRpb25zKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuY2FwdGNoYVRva2VuOwogICAgICB9CiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L3ZlcmlmeWAsIHsKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgYm9keTogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBwYXJhbXMpLCB7IGdvdHJ1ZV9tZXRhX3NlY3VyaXR5OiB7IGNhcHRjaGFfdG9rZW46IGNhcHRjaGFUb2tlbiB9IH0pLAogICAgICAgIHJlZGlyZWN0VG8sCiAgICAgICAgeGZvcm06IF9zZXNzaW9uUmVzcG9uc2UKICAgICAgfSk7CiAgICAgIGlmIChlcnJvcikgewogICAgICAgIHRocm93IGVycm9yOwogICAgICB9CiAgICAgIGlmICghZGF0YSkgewogICAgICAgIGNvbnN0IHRva2VuVmVyaWZpY2F0aW9uRXJyb3IgPSBuZXcgRXJyb3IoIkFuIGVycm9yIG9jY3VycmVkIG9uIHRva2VuIHZlcmlmaWNhdGlvbi4iKTsKICAgICAgICB0aHJvdyB0b2tlblZlcmlmaWNhdGlvbkVycm9yOwogICAgICB9CiAgICAgIGNvbnN0IHNlc3Npb24gPSBkYXRhLnNlc3Npb247CiAgICAgIGNvbnN0IHVzZXIgPSBkYXRhLnVzZXI7CiAgICAgIGlmIChzZXNzaW9uID09PSBudWxsIHx8IHNlc3Npb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNlc3Npb24uYWNjZXNzX3Rva2VuKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fc2F2ZVNlc3Npb24oc2Vzc2lvbik7CiAgICAgICAgYXdhaXQgdGhpcy5fbm90aWZ5QWxsU3Vic2NyaWJlcnMocGFyYW1zLnR5cGUgPT0gInJlY292ZXJ5IiA/ICJQQVNTV09SRF9SRUNPVkVSWSIgOiAiU0lHTkVEX0lOIiwgc2Vzc2lvbik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlciwgc2Vzc2lvbiB9LCBlcnJvcjogbnVsbCB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBBdHRlbXB0cyBhIHNpbmdsZS1zaWduIG9uIHVzaW5nIGFuIGVudGVycHJpc2UgSWRlbnRpdHkgUHJvdmlkZXIuIEEKICAgKiBzdWNjZXNzZnVsIFNTTyBhdHRlbXB0IHdpbGwgcmVkaXJlY3QgdGhlIGN1cnJlbnQgcGFnZSB0byB0aGUgaWRlbnRpdHkKICAgKiBwcm92aWRlciBhdXRob3JpemF0aW9uIHBhZ2UuIFRoZSByZWRpcmVjdCBVUkwgaXMgaW1wbGVtZW50YXRpb24gYW5kIFNTTwogICAqIHByb3RvY29sIHNwZWNpZmljLgogICAqCiAgICogWW91IGNhbiB1c2UgaXQgYnkgcHJvdmlkaW5nIGEgU1NPIGRvbWFpbi4gVHlwaWNhbGx5IHlvdSBjYW4gZXh0cmFjdCB0aGlzCiAgICogZG9tYWluIGJ5IGFza2luZyB1c2VycyBmb3IgdGhlaXIgZW1haWwgYWRkcmVzcy4gSWYgdGhpcyBkb21haW4gaXMKICAgKiByZWdpc3RlcmVkIG9uIHRoZSBBdXRoIGluc3RhbmNlIHRoZSByZWRpcmVjdCB3aWxsIHVzZSB0aGF0IG9yZ2FuaXphdGlvbidzCiAgICogY3VycmVudGx5IGFjdGl2ZSBTU08gSWRlbnRpdHkgUHJvdmlkZXIgZm9yIHRoZSBsb2dpbi4KICAgKgogICAqIElmIHlvdSBoYXZlIGJ1aWx0IGFuIG9yZ2FuaXphdGlvbi1zcGVjaWZpYyBsb2dpbiBwYWdlLCB5b3UgY2FuIHVzZSB0aGUKICAgKiBvcmdhbml6YXRpb24ncyBTU08gSWRlbnRpdHkgUHJvdmlkZXIgVVVJRCBkaXJlY3RseSBpbnN0ZWFkLgogICAqLwogIGFzeW5jIHNpZ25JbldpdGhTU08ocGFyYW1zKSB7CiAgICB2YXIgX2EsIF9iLCBfYywgX2QsIF9lOwogICAgdHJ5IHsKICAgICAgbGV0IGNvZGVDaGFsbGVuZ2UgPSBudWxsOwogICAgICBsZXQgY29kZUNoYWxsZW5nZU1ldGhvZCA9IG51bGw7CiAgICAgIGlmICh0aGlzLmZsb3dUeXBlID09PSAicGtjZSIpIHsKICAgICAgICA7CiAgICAgICAgW2NvZGVDaGFsbGVuZ2UsIGNvZGVDaGFsbGVuZ2VNZXRob2RdID0gYXdhaXQgZ2V0Q29kZUNoYWxsZW5nZUFuZE1ldGhvZCh0aGlzLnN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSk7CiAgICAgIH0KICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vc3NvYCwgewogICAgICAgIGJvZHk6IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgInByb3ZpZGVySWQiIGluIHBhcmFtcyA/IHsgcHJvdmlkZXJfaWQ6IHBhcmFtcy5wcm92aWRlcklkIH0gOiBudWxsKSwgImRvbWFpbiIgaW4gcGFyYW1zID8geyBkb21haW46IHBhcmFtcy5kb21haW4gfSA6IG51bGwpLCB7IHJlZGlyZWN0X3RvOiAoX2IgPSAoX2EgPSBwYXJhbXMub3B0aW9ucykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlZGlyZWN0VG8pICE9PSBudWxsICYmIF9iICE9PSB2b2lkIDAgPyBfYiA6IHZvaWQgMCB9KSwgKChfYyA9IHBhcmFtcyA9PT0gbnVsbCB8fCBwYXJhbXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBhcmFtcy5vcHRpb25zKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuY2FwdGNoYVRva2VuKSA/IHsgZ290cnVlX21ldGFfc2VjdXJpdHk6IHsgY2FwdGNoYV90b2tlbjogcGFyYW1zLm9wdGlvbnMuY2FwdGNoYVRva2VuIH0gfSA6IG51bGwpLCB7IHNraXBfaHR0cF9yZWRpcmVjdDogdHJ1ZSwgY29kZV9jaGFsbGVuZ2U6IGNvZGVDaGFsbGVuZ2UsIGNvZGVfY2hhbGxlbmdlX21ldGhvZDogY29kZUNoYWxsZW5nZU1ldGhvZCB9KSwKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgeGZvcm06IF9zc29SZXNwb25zZQogICAgICB9KTsKICAgICAgaWYgKCgoX2QgPSByZXN1bHQuZGF0YSkgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kLnVybCkgJiYgaXNCcm93c2VyKCkgJiYgISgoX2UgPSBwYXJhbXMub3B0aW9ucykgPT09IG51bGwgfHwgX2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lLnNraXBCcm93c2VyUmVkaXJlY3QpKSB7CiAgICAgICAgd2luZG93LmxvY2F0aW9uLmFzc2lnbihyZXN1bHQuZGF0YS51cmwpOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQocmVzdWx0KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGF3YWl0IHJlbW92ZUl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIGAke3RoaXMuc3RvcmFnZUtleX0tY29kZS12ZXJpZmllcmApOwogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBTZW5kcyBhIHJlYXV0aGVudGljYXRpb24gT1RQIHRvIHRoZSB1c2VyJ3MgZW1haWwgb3IgcGhvbmUgbnVtYmVyLgogICAqIFJlcXVpcmVzIHRoZSB1c2VyIHRvIGJlIHNpZ25lZC1pbi4KICAgKi8KICBhc3luYyByZWF1dGhlbnRpY2F0ZSgpIHsKICAgIGF3YWl0IHRoaXMuaW5pdGlhbGl6ZVByb21pc2U7CiAgICByZXR1cm4gYXdhaXQgdGhpcy5fYWNxdWlyZUxvY2sodGhpcy5sb2NrQWNxdWlyZVRpbWVvdXQsIGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3JlYXV0aGVudGljYXRlKCk7CiAgICB9KTsKICB9CiAgYXN5bmMgX3JlYXV0aGVudGljYXRlKCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3VzZVNlc3Npb24oYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICAgIGNvbnN0IHsgZGF0YTogeyBzZXNzaW9uIH0sIGVycm9yOiBzZXNzaW9uRXJyb3IgfSA9IHJlc3VsdDsKICAgICAgICBpZiAoc2Vzc2lvbkVycm9yKQogICAgICAgICAgdGhyb3cgc2Vzc2lvbkVycm9yOwogICAgICAgIGlmICghc2Vzc2lvbikKICAgICAgICAgIHRocm93IG5ldyBBdXRoU2Vzc2lvbk1pc3NpbmdFcnJvcigpOwogICAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJHRVQiLCBgJHt0aGlzLnVybH0vcmVhdXRoZW50aWNhdGVgLCB7CiAgICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgICBqd3Q6IHNlc3Npb24uYWNjZXNzX3Rva2VuCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogUmVzZW5kcyBhbiBleGlzdGluZyBzaWdudXAgY29uZmlybWF0aW9uIGVtYWlsLCBlbWFpbCBjaGFuZ2UgZW1haWwsIFNNUyBPVFAgb3IgcGhvbmUgY2hhbmdlIE9UUC4KICAgKi8KICBhc3luYyByZXNlbmQoY3JlZGVudGlhbHMpIHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IGVuZHBvaW50ID0gYCR7dGhpcy51cmx9L3Jlc2VuZGA7CiAgICAgIGlmICgiZW1haWwiIGluIGNyZWRlbnRpYWxzKSB7CiAgICAgICAgY29uc3QgeyBlbWFpbCwgdHlwZSwgb3B0aW9ucyB9ID0gY3JlZGVudGlhbHM7CiAgICAgICAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBlbmRwb2ludCwgewogICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgYm9keTogewogICAgICAgICAgICBlbWFpbCwKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAgZ290cnVlX21ldGFfc2VjdXJpdHk6IHsgY2FwdGNoYV90b2tlbjogb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmNhcHRjaGFUb2tlbiB9CiAgICAgICAgICB9LAogICAgICAgICAgcmVkaXJlY3RUbzogb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmVtYWlsUmVkaXJlY3RUbwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0gZWxzZSBpZiAoInBob25lIiBpbiBjcmVkZW50aWFscykgewogICAgICAgIGNvbnN0IHsgcGhvbmUsIHR5cGUsIG9wdGlvbnMgfSA9IGNyZWRlbnRpYWxzOwogICAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgZW5kcG9pbnQsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGJvZHk6IHsKICAgICAgICAgICAgcGhvbmUsCiAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgIGdvdHJ1ZV9tZXRhX3NlY3VyaXR5OiB7IGNhcHRjaGFfdG9rZW46IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5jYXB0Y2hhVG9rZW4gfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoewogICAgICAgICAgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsLCBtZXNzYWdlSWQ6IGRhdGEgPT09IG51bGwgfHwgZGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YS5tZXNzYWdlX2lkIH0sCiAgICAgICAgICBlcnJvcgogICAgICAgIH0pOwogICAgICB9CiAgICAgIHRocm93IG5ldyBBdXRoSW52YWxpZENyZWRlbnRpYWxzRXJyb3IoIllvdSBtdXN0IHByb3ZpZGUgZWl0aGVyIGFuIGVtYWlsIG9yIHBob25lIG51bWJlciBhbmQgYSB0eXBlIik7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgc2Vzc2lvbiwgcmVmcmVzaGluZyBpdCBpZiBuZWNlc3NhcnkuCiAgICoKICAgKiBUaGUgc2Vzc2lvbiByZXR1cm5lZCBjYW4gYmUgbnVsbCBpZiB0aGUgc2Vzc2lvbiBpcyBub3QgZGV0ZWN0ZWQgd2hpY2ggY2FuIGhhcHBlbiBpbiB0aGUgZXZlbnQgYSB1c2VyIGlzIG5vdCBzaWduZWQtaW4gb3IgaGFzIGxvZ2dlZCBvdXQuCiAgICoKICAgKiAqKklNUE9SVEFOVDoqKiBUaGlzIG1ldGhvZCBsb2FkcyB2YWx1ZXMgZGlyZWN0bHkgZnJvbSB0aGUgc3RvcmFnZSBhdHRhY2hlZAogICAqIHRvIHRoZSBjbGllbnQuIElmIHRoYXQgc3RvcmFnZSBpcyBiYXNlZCBvbiByZXF1ZXN0IGNvb2tpZXMgZm9yIGV4YW1wbGUsCiAgICogdGhlIHZhbHVlcyBpbiBpdCBtYXkgbm90IGJlIGF1dGhlbnRpYyBhbmQgdGhlcmVmb3JlIGl0J3Mgc3Ryb25nbHkgYWR2aXNlZAogICAqIGFnYWluc3QgdXNpbmcgdGhpcyBtZXRob2QgYW5kIGl0cyByZXN1bHRzIGluIHN1Y2ggY2lyY3Vtc3RhbmNlcy4gQSB3YXJuaW5nCiAgICogd2lsbCBiZSBlbWl0dGVkIGlmIHRoaXMgaXMgZGV0ZWN0ZWQuIFVzZSB7QGxpbmsgI2dldFVzZXIoKX0gaW5zdGVhZC4KICAgKi8KICBhc3luYyBnZXRTZXNzaW9uKCkgewogICAgYXdhaXQgdGhpcy5pbml0aWFsaXplUHJvbWlzZTsKICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuX2FjcXVpcmVMb2NrKHRoaXMubG9ja0FjcXVpcmVUaW1lb3V0LCBhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiB0aGlzLl91c2VTZXNzaW9uKGFzeW5jIChyZXN1bHQyKSA9PiB7CiAgICAgICAgcmV0dXJuIHJlc3VsdDI7CiAgICAgIH0pOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICAvKioKICAgKiBBY3F1aXJlcyBhIGdsb2JhbCBsb2NrIGJhc2VkIG9uIHRoZSBzdG9yYWdlIGtleS4KICAgKi8KICBhc3luYyBfYWNxdWlyZUxvY2soYWNxdWlyZVRpbWVvdXQsIGZuKSB7CiAgICB0aGlzLl9kZWJ1ZygiI19hY3F1aXJlTG9jayIsICJiZWdpbiIsIGFjcXVpcmVUaW1lb3V0KTsKICAgIHRyeSB7CiAgICAgIGlmICh0aGlzLmxvY2tBY3F1aXJlZCkgewogICAgICAgIGNvbnN0IGxhc3QyID0gdGhpcy5wZW5kaW5nSW5Mb2NrLmxlbmd0aCA/IHRoaXMucGVuZGluZ0luTG9ja1t0aGlzLnBlbmRpbmdJbkxvY2subGVuZ3RoIC0gMV0gOiBQcm9taXNlLnJlc29sdmUoKTsKICAgICAgICBjb25zdCByZXN1bHQgPSAoYXN5bmMgKCkgPT4gewogICAgICAgICAgYXdhaXQgbGFzdDI7CiAgICAgICAgICByZXR1cm4gYXdhaXQgZm4oKTsKICAgICAgICB9KSgpOwogICAgICAgIHRoaXMucGVuZGluZ0luTG9jay5wdXNoKChhc3luYyAoKSA9PiB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCByZXN1bHQ7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICB9CiAgICAgICAgfSkoKSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICByZXR1cm4gYXdhaXQgdGhpcy5sb2NrKGBsb2NrOiR7dGhpcy5zdG9yYWdlS2V5fWAsIGFjcXVpcmVUaW1lb3V0LCBhc3luYyAoKSA9PiB7CiAgICAgICAgdGhpcy5fZGVidWcoIiNfYWNxdWlyZUxvY2siLCAibG9jayBhY3F1aXJlZCBmb3Igc3RvcmFnZSBrZXkiLCB0aGlzLnN0b3JhZ2VLZXkpOwogICAgICAgIHRyeSB7CiAgICAgICAgICB0aGlzLmxvY2tBY3F1aXJlZCA9IHRydWU7CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBmbigpOwogICAgICAgICAgdGhpcy5wZW5kaW5nSW5Mb2NrLnB1c2goKGFzeW5jICgpID0+IHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBhd2FpdCByZXN1bHQ7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgfQogICAgICAgICAgfSkoKSk7CiAgICAgICAgICBhd2FpdCByZXN1bHQ7CiAgICAgICAgICB3aGlsZSAodGhpcy5wZW5kaW5nSW5Mb2NrLmxlbmd0aCkgewogICAgICAgICAgICBjb25zdCB3YWl0T24gPSBbLi4udGhpcy5wZW5kaW5nSW5Mb2NrXTsKICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwod2FpdE9uKTsKICAgICAgICAgICAgdGhpcy5wZW5kaW5nSW5Mb2NrLnNwbGljZSgwLCB3YWl0T24ubGVuZ3RoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBhd2FpdCByZXN1bHQ7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIHRoaXMuX2RlYnVnKCIjX2FjcXVpcmVMb2NrIiwgImxvY2sgcmVsZWFzZWQgZm9yIHN0b3JhZ2Uga2V5IiwgdGhpcy5zdG9yYWdlS2V5KTsKICAgICAgICAgIHRoaXMubG9ja0FjcXVpcmVkID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX2RlYnVnKCIjX2FjcXVpcmVMb2NrIiwgImVuZCIpOwogICAgfQogIH0KICAvKioKICAgKiBVc2UgaW5zdGVhZCBvZiB7QGxpbmsgI2dldFNlc3Npb259IGluc2lkZSB0aGUgbGlicmFyeS4gSXQgaXMKICAgKiBzZW1hbnRpY2FsbHkgdXN1YWxseSB3aGF0IHlvdSB3YW50LCBhcyBnZXR0aW5nIGEgc2Vzc2lvbiBpbnZvbHZlcyBzb21lCiAgICogcHJvY2Vzc2luZyBhZnRlcndhcmRzIHRoYXQgcmVxdWlyZXMgb25seSBvbmUgY2xpZW50IG9wZXJhdGluZyBvbiB0aGUKICAgKiBzZXNzaW9uIGF0IG9uY2UgYWNyb3NzIG11bHRpcGxlIHRhYnMgb3IgcHJvY2Vzc2VzLgogICAqLwogIGFzeW5jIF91c2VTZXNzaW9uKGZuKSB7CiAgICB0aGlzLl9kZWJ1ZygiI191c2VTZXNzaW9uIiwgImJlZ2luIik7CiAgICB0cnkgewogICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLl9fbG9hZFNlc3Npb24oKTsKICAgICAgcmV0dXJuIGF3YWl0IGZuKHJlc3VsdCk7CiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl9kZWJ1ZygiI191c2VTZXNzaW9uIiwgImVuZCIpOwogICAgfQogIH0KICAvKioKICAgKiBORVZFUiBVU0UgRElSRUNUTFkhCiAgICoKICAgKiBBbHdheXMgdXNlIHtAbGluayAjX3VzZVNlc3Npb259LgogICAqLwogIGFzeW5jIF9fbG9hZFNlc3Npb24oKSB7CiAgICB0aGlzLl9kZWJ1ZygiI19fbG9hZFNlc3Npb24oKSIsICJiZWdpbiIpOwogICAgaWYgKCF0aGlzLmxvY2tBY3F1aXJlZCkgewogICAgICB0aGlzLl9kZWJ1ZygiI19fbG9hZFNlc3Npb24oKSIsICJ1c2VkIG91dHNpZGUgb2YgYW4gYWNxdWlyZWQgbG9jayEiLCBuZXcgRXJyb3IoKS5zdGFjayk7CiAgICB9CiAgICB0cnkgewogICAgICBsZXQgY3VycmVudFNlc3Npb24gPSBudWxsOwogICAgICBjb25zdCBtYXliZVNlc3Npb24gPSBhd2FpdCBnZXRJdGVtQXN5bmModGhpcy5zdG9yYWdlLCB0aGlzLnN0b3JhZ2VLZXkpOwogICAgICB0aGlzLl9kZWJ1ZygiI2dldFNlc3Npb24oKSIsICJzZXNzaW9uIGZyb20gc3RvcmFnZSIsIG1heWJlU2Vzc2lvbik7CiAgICAgIGlmIChtYXliZVNlc3Npb24gIT09IG51bGwpIHsKICAgICAgICBpZiAodGhpcy5faXNWYWxpZFNlc3Npb24obWF5YmVTZXNzaW9uKSkgewogICAgICAgICAgY3VycmVudFNlc3Npb24gPSBtYXliZVNlc3Npb247CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuX2RlYnVnKCIjZ2V0U2Vzc2lvbigpIiwgInNlc3Npb24gZnJvbSBzdG9yYWdlIGlzIG5vdCB2YWxpZCIpOwogICAgICAgICAgYXdhaXQgdGhpcy5fcmVtb3ZlU2Vzc2lvbigpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoIWN1cnJlbnRTZXNzaW9uKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogeyBzZXNzaW9uOiBudWxsIH0sIGVycm9yOiBudWxsIH07CiAgICAgIH0KICAgICAgY29uc3QgaGFzRXhwaXJlZCA9IGN1cnJlbnRTZXNzaW9uLmV4cGlyZXNfYXQgPyBjdXJyZW50U2Vzc2lvbi5leHBpcmVzX2F0ICogMWUzIC0gRGF0ZS5ub3coKSA8IEVYUElSWV9NQVJHSU5fTVMgOiBmYWxzZTsKICAgICAgdGhpcy5fZGVidWcoIiNfX2xvYWRTZXNzaW9uKCkiLCBgc2Vzc2lvbiBoYXMke2hhc0V4cGlyZWQgPyAiIiA6ICIgbm90In0gZXhwaXJlZGAsICJleHBpcmVzX2F0IiwgY3VycmVudFNlc3Npb24uZXhwaXJlc19hdCk7CiAgICAgIGlmICghaGFzRXhwaXJlZCkgewogICAgICAgIGlmICh0aGlzLnVzZXJTdG9yYWdlKSB7CiAgICAgICAgICBjb25zdCBtYXliZVVzZXIgPSBhd2FpdCBnZXRJdGVtQXN5bmModGhpcy51c2VyU3RvcmFnZSwgdGhpcy5zdG9yYWdlS2V5ICsgIi11c2VyIik7CiAgICAgICAgICBpZiAobWF5YmVVc2VyID09PSBudWxsIHx8IG1heWJlVXNlciA9PT0gdm9pZCAwID8gdm9pZCAwIDogbWF5YmVVc2VyLnVzZXIpIHsKICAgICAgICAgICAgY3VycmVudFNlc3Npb24udXNlciA9IG1heWJlVXNlci51c2VyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY3VycmVudFNlc3Npb24udXNlciA9IHVzZXJOb3RBdmFpbGFibGVQcm94eSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5zdG9yYWdlLmlzU2VydmVyICYmIGN1cnJlbnRTZXNzaW9uLnVzZXIgJiYgIWN1cnJlbnRTZXNzaW9uLnVzZXIuX19pc1VzZXJOb3RBdmFpbGFibGVQcm94eSkgewogICAgICAgICAgY29uc3Qgc3VwcHJlc3NXYXJuaW5nUmVmID0geyB2YWx1ZTogdGhpcy5zdXBwcmVzc0dldFNlc3Npb25XYXJuaW5nIH07CiAgICAgICAgICBjdXJyZW50U2Vzc2lvbi51c2VyID0gaW5zZWN1cmVVc2VyV2FybmluZ1Byb3h5KGN1cnJlbnRTZXNzaW9uLnVzZXIsIHN1cHByZXNzV2FybmluZ1JlZik7CiAgICAgICAgICBpZiAoc3VwcHJlc3NXYXJuaW5nUmVmLnZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuc3VwcHJlc3NHZXRTZXNzaW9uV2FybmluZyA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB7IGRhdGE6IHsgc2Vzc2lvbjogY3VycmVudFNlc3Npb24gfSwgZXJyb3I6IG51bGwgfTsKICAgICAgfQogICAgICBjb25zdCB7IGRhdGE6IHNlc3Npb24sIGVycm9yIH0gPSBhd2FpdCB0aGlzLl9jYWxsUmVmcmVzaFRva2VuKGN1cnJlbnRTZXNzaW9uLnJlZnJlc2hfdG9rZW4pOwogICAgICBpZiAoZXJyb3IpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyBzZXNzaW9uOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHNlc3Npb24gfSwgZXJyb3I6IG51bGwgfSk7CiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl9kZWJ1ZygiI19fbG9hZFNlc3Npb24oKSIsICJlbmQiKTsKICAgIH0KICB9CiAgLyoqCiAgICogR2V0cyB0aGUgY3VycmVudCB1c2VyIGRldGFpbHMgaWYgdGhlcmUgaXMgYW4gZXhpc3Rpbmcgc2Vzc2lvbi4gVGhpcyBtZXRob2QKICAgKiBwZXJmb3JtcyBhIG5ldHdvcmsgcmVxdWVzdCB0byB0aGUgU3VwYWJhc2UgQXV0aCBzZXJ2ZXIsIHNvIHRoZSByZXR1cm5lZAogICAqIHZhbHVlIGlzIGF1dGhlbnRpYyBhbmQgY2FuIGJlIHVzZWQgdG8gYmFzZSBhdXRob3JpemF0aW9uIHJ1bGVzIG9uLgogICAqCiAgICogQHBhcmFtIGp3dCBUYWtlcyBpbiBhbiBvcHRpb25hbCBhY2Nlc3MgdG9rZW4gSldULiBJZiBubyBKV1QgaXMgcHJvdmlkZWQsIHRoZSBKV1QgZnJvbSB0aGUgY3VycmVudCBzZXNzaW9uIGlzIHVzZWQuCiAgICovCiAgYXN5bmMgZ2V0VXNlcihqd3QpIHsKICAgIGlmIChqd3QpIHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2dldFVzZXIoand0KTsKICAgIH0KICAgIGF3YWl0IHRoaXMuaW5pdGlhbGl6ZVByb21pc2U7CiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLl9hY3F1aXJlTG9jayh0aGlzLmxvY2tBY3F1aXJlVGltZW91dCwgYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0VXNlcigpOwogICAgfSk7CiAgICBpZiAocmVzdWx0LmRhdGEudXNlcikgewogICAgICB0aGlzLnN1cHByZXNzR2V0U2Vzc2lvbldhcm5pbmcgPSB0cnVlOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgYXN5bmMgX2dldFVzZXIoand0KSB7CiAgICB0cnkgewogICAgICBpZiAoand0KSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJHRVQiLCBgJHt0aGlzLnVybH0vdXNlcmAsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGp3dCwKICAgICAgICAgIHhmb3JtOiBfdXNlclJlc3BvbnNlCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3VzZVNlc3Npb24oYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICAgIHZhciBfYSwgX2IsIF9jOwogICAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IHJlc3VsdDsKICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0KICAgICAgICBpZiAoISgoX2EgPSBkYXRhLnNlc3Npb24pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5hY2Nlc3NfdG9rZW4pICYmICF0aGlzLmhhc0N1c3RvbUF1dGhvcml6YXRpb25IZWFkZXIpIHsKICAgICAgICAgIHJldHVybiB7IGRhdGE6IHsgdXNlcjogbnVsbCB9LCBlcnJvcjogbmV3IEF1dGhTZXNzaW9uTWlzc2luZ0Vycm9yKCkgfTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJHRVQiLCBgJHt0aGlzLnVybH0vdXNlcmAsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGp3dDogKF9jID0gKF9iID0gZGF0YS5zZXNzaW9uKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuYWNjZXNzX3Rva2VuKSAhPT0gbnVsbCAmJiBfYyAhPT0gdm9pZCAwID8gX2MgOiB2b2lkIDAsCiAgICAgICAgICB4Zm9ybTogX3VzZXJSZXNwb25zZQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICBpZiAoaXNBdXRoU2Vzc2lvbk1pc3NpbmdFcnJvcihlcnJvcikpIHsKICAgICAgICAgIGF3YWl0IHRoaXMuX3JlbW92ZVNlc3Npb24oKTsKICAgICAgICAgIGF3YWl0IHJlbW92ZUl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIGAke3RoaXMuc3RvcmFnZUtleX0tY29kZS12ZXJpZmllcmApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBVcGRhdGVzIHVzZXIgZGF0YSBmb3IgYSBsb2dnZWQgaW4gdXNlci4KICAgKi8KICBhc3luYyB1cGRhdGVVc2VyKGF0dHJpYnV0ZXMsIG9wdGlvbnMgPSB7fSkgewogICAgYXdhaXQgdGhpcy5pbml0aWFsaXplUHJvbWlzZTsKICAgIHJldHVybiBhd2FpdCB0aGlzLl9hY3F1aXJlTG9jayh0aGlzLmxvY2tBY3F1aXJlVGltZW91dCwgYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fdXBkYXRlVXNlcihhdHRyaWJ1dGVzLCBvcHRpb25zKTsKICAgIH0pOwogIH0KICBhc3luYyBfdXBkYXRlVXNlcihhdHRyaWJ1dGVzLCBvcHRpb25zID0ge30pIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl91c2VTZXNzaW9uKGFzeW5jIChyZXN1bHQpID0+IHsKICAgICAgICBjb25zdCB7IGRhdGE6IHNlc3Npb25EYXRhLCBlcnJvcjogc2Vzc2lvbkVycm9yIH0gPSByZXN1bHQ7CiAgICAgICAgaWYgKHNlc3Npb25FcnJvcikgewogICAgICAgICAgdGhyb3cgc2Vzc2lvbkVycm9yOwogICAgICAgIH0KICAgICAgICBpZiAoIXNlc3Npb25EYXRhLnNlc3Npb24pIHsKICAgICAgICAgIHRocm93IG5ldyBBdXRoU2Vzc2lvbk1pc3NpbmdFcnJvcigpOwogICAgICAgIH0KICAgICAgICBjb25zdCBzZXNzaW9uID0gc2Vzc2lvbkRhdGEuc2Vzc2lvbjsKICAgICAgICBsZXQgY29kZUNoYWxsZW5nZSA9IG51bGw7CiAgICAgICAgbGV0IGNvZGVDaGFsbGVuZ2VNZXRob2QgPSBudWxsOwogICAgICAgIGlmICh0aGlzLmZsb3dUeXBlID09PSAicGtjZSIgJiYgYXR0cmlidXRlcy5lbWFpbCAhPSBudWxsKSB7CiAgICAgICAgICA7CiAgICAgICAgICBbY29kZUNoYWxsZW5nZSwgY29kZUNoYWxsZW5nZU1ldGhvZF0gPSBhd2FpdCBnZXRDb2RlQ2hhbGxlbmdlQW5kTWV0aG9kKHRoaXMuc3RvcmFnZSwgdGhpcy5zdG9yYWdlS2V5KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvcjogdXNlckVycm9yIH0gPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUFVUIiwgYCR7dGhpcy51cmx9L3VzZXJgLCB7CiAgICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgICByZWRpcmVjdFRvOiBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuZW1haWxSZWRpcmVjdFRvLAogICAgICAgICAgYm9keTogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBhdHRyaWJ1dGVzKSwgeyBjb2RlX2NoYWxsZW5nZTogY29kZUNoYWxsZW5nZSwgY29kZV9jaGFsbGVuZ2VfbWV0aG9kOiBjb2RlQ2hhbGxlbmdlTWV0aG9kIH0pLAogICAgICAgICAgand0OiBzZXNzaW9uLmFjY2Vzc190b2tlbiwKICAgICAgICAgIHhmb3JtOiBfdXNlclJlc3BvbnNlCiAgICAgICAgfSk7CiAgICAgICAgaWYgKHVzZXJFcnJvcikgewogICAgICAgICAgdGhyb3cgdXNlckVycm9yOwogICAgICAgIH0KICAgICAgICBzZXNzaW9uLnVzZXIgPSBkYXRhLnVzZXI7CiAgICAgICAgYXdhaXQgdGhpcy5fc2F2ZVNlc3Npb24oc2Vzc2lvbik7CiAgICAgICAgYXdhaXQgdGhpcy5fbm90aWZ5QWxsU3Vic2NyaWJlcnMoIlVTRVJfVVBEQVRFRCIsIHNlc3Npb24pOwogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IHNlc3Npb24udXNlciB9LCBlcnJvcjogbnVsbCB9KTsKICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBhd2FpdCByZW1vdmVJdGVtQXN5bmModGhpcy5zdG9yYWdlLCBgJHt0aGlzLnN0b3JhZ2VLZXl9LWNvZGUtdmVyaWZpZXJgKTsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIFNldHMgdGhlIHNlc3Npb24gZGF0YSBmcm9tIHRoZSBjdXJyZW50IHNlc3Npb24uIElmIHRoZSBjdXJyZW50IHNlc3Npb24gaXMgZXhwaXJlZCwgc2V0U2Vzc2lvbiB3aWxsIHRha2UgY2FyZSBvZiByZWZyZXNoaW5nIGl0IHRvIG9idGFpbiBhIG5ldyBzZXNzaW9uLgogICAqIElmIHRoZSByZWZyZXNoIHRva2VuIG9yIGFjY2VzcyB0b2tlbiBpbiB0aGUgY3VycmVudCBzZXNzaW9uIGlzIGludmFsaWQsIGFuIGVycm9yIHdpbGwgYmUgdGhyb3duLgogICAqIEBwYXJhbSBjdXJyZW50U2Vzc2lvbiBUaGUgY3VycmVudCBzZXNzaW9uIHRoYXQgbWluaW1hbGx5IGNvbnRhaW5zIGFuIGFjY2VzcyB0b2tlbiBhbmQgcmVmcmVzaCB0b2tlbi4KICAgKi8KICBhc3luYyBzZXRTZXNzaW9uKGN1cnJlbnRTZXNzaW9uKSB7CiAgICBhd2FpdCB0aGlzLmluaXRpYWxpemVQcm9taXNlOwogICAgcmV0dXJuIGF3YWl0IHRoaXMuX2FjcXVpcmVMb2NrKHRoaXMubG9ja0FjcXVpcmVUaW1lb3V0LCBhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9zZXRTZXNzaW9uKGN1cnJlbnRTZXNzaW9uKTsKICAgIH0pOwogIH0KICBhc3luYyBfc2V0U2Vzc2lvbihjdXJyZW50U2Vzc2lvbikgewogICAgdHJ5IHsKICAgICAgaWYgKCFjdXJyZW50U2Vzc2lvbi5hY2Nlc3NfdG9rZW4gfHwgIWN1cnJlbnRTZXNzaW9uLnJlZnJlc2hfdG9rZW4pIHsKICAgICAgICB0aHJvdyBuZXcgQXV0aFNlc3Npb25NaXNzaW5nRXJyb3IoKTsKICAgICAgfQogICAgICBjb25zdCB0aW1lTm93ID0gRGF0ZS5ub3coKSAvIDFlMzsKICAgICAgbGV0IGV4cGlyZXNBdDIgPSB0aW1lTm93OwogICAgICBsZXQgaGFzRXhwaXJlZCA9IHRydWU7CiAgICAgIGxldCBzZXNzaW9uID0gbnVsbDsKICAgICAgY29uc3QgeyBwYXlsb2FkIH0gPSBkZWNvZGVKV1QoY3VycmVudFNlc3Npb24uYWNjZXNzX3Rva2VuKTsKICAgICAgaWYgKHBheWxvYWQuZXhwKSB7CiAgICAgICAgZXhwaXJlc0F0MiA9IHBheWxvYWQuZXhwOwogICAgICAgIGhhc0V4cGlyZWQgPSBleHBpcmVzQXQyIDw9IHRpbWVOb3c7CiAgICAgIH0KICAgICAgaWYgKGhhc0V4cGlyZWQpIHsKICAgICAgICBjb25zdCB7IGRhdGE6IHJlZnJlc2hlZFNlc3Npb24sIGVycm9yIH0gPSBhd2FpdCB0aGlzLl9jYWxsUmVmcmVzaFRva2VuKGN1cnJlbnRTZXNzaW9uLnJlZnJlc2hfdG9rZW4pOwogICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKCFyZWZyZXNoZWRTZXNzaW9uKSB7CiAgICAgICAgICByZXR1cm4geyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3I6IG51bGwgfTsKICAgICAgICB9CiAgICAgICAgc2Vzc2lvbiA9IHJlZnJlc2hlZFNlc3Npb247CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgdGhpcy5fZ2V0VXNlcihjdXJyZW50U2Vzc2lvbi5hY2Nlc3NfdG9rZW4pOwogICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgICB9CiAgICAgICAgc2Vzc2lvbiA9IHsKICAgICAgICAgIGFjY2Vzc190b2tlbjogY3VycmVudFNlc3Npb24uYWNjZXNzX3Rva2VuLAogICAgICAgICAgcmVmcmVzaF90b2tlbjogY3VycmVudFNlc3Npb24ucmVmcmVzaF90b2tlbiwKICAgICAgICAgIHVzZXI6IGRhdGEudXNlciwKICAgICAgICAgIHRva2VuX3R5cGU6ICJiZWFyZXIiLAogICAgICAgICAgZXhwaXJlc19pbjogZXhwaXJlc0F0MiAtIHRpbWVOb3csCiAgICAgICAgICBleHBpcmVzX2F0OiBleHBpcmVzQXQyCiAgICAgICAgfTsKICAgICAgICBhd2FpdCB0aGlzLl9zYXZlU2Vzc2lvbihzZXNzaW9uKTsKICAgICAgICBhd2FpdCB0aGlzLl9ub3RpZnlBbGxTdWJzY3JpYmVycygiU0lHTkVEX0lOIiwgc2Vzc2lvbik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogc2Vzc2lvbi51c2VyLCBzZXNzaW9uIH0sIGVycm9yOiBudWxsIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHNlc3Npb246IG51bGwsIHVzZXI6IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIFJldHVybnMgYSBuZXcgc2Vzc2lvbiwgcmVnYXJkbGVzcyBvZiBleHBpcnkgc3RhdHVzLgogICAqIFRha2VzIGluIGFuIG9wdGlvbmFsIGN1cnJlbnQgc2Vzc2lvbi4gSWYgbm90IHBhc3NlZCBpbiwgdGhlbiByZWZyZXNoU2Vzc2lvbigpIHdpbGwgYXR0ZW1wdCB0byByZXRyaWV2ZSBpdCBmcm9tIGdldFNlc3Npb24oKS4KICAgKiBJZiB0aGUgY3VycmVudCBzZXNzaW9uJ3MgcmVmcmVzaCB0b2tlbiBpcyBpbnZhbGlkLCBhbiBlcnJvciB3aWxsIGJlIHRocm93bi4KICAgKiBAcGFyYW0gY3VycmVudFNlc3Npb24gVGhlIGN1cnJlbnQgc2Vzc2lvbi4gSWYgcGFzc2VkIGluLCBpdCBtdXN0IGNvbnRhaW4gYSByZWZyZXNoIHRva2VuLgogICAqLwogIGFzeW5jIHJlZnJlc2hTZXNzaW9uKGN1cnJlbnRTZXNzaW9uKSB7CiAgICBhd2FpdCB0aGlzLmluaXRpYWxpemVQcm9taXNlOwogICAgcmV0dXJuIGF3YWl0IHRoaXMuX2FjcXVpcmVMb2NrKHRoaXMubG9ja0FjcXVpcmVUaW1lb3V0LCBhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9yZWZyZXNoU2Vzc2lvbihjdXJyZW50U2Vzc2lvbik7CiAgICB9KTsKICB9CiAgYXN5bmMgX3JlZnJlc2hTZXNzaW9uKGN1cnJlbnRTZXNzaW9uKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fdXNlU2Vzc2lvbihhc3luYyAocmVzdWx0KSA9PiB7CiAgICAgICAgdmFyIF9hOwogICAgICAgIGlmICghY3VycmVudFNlc3Npb24pIHsKICAgICAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3I6IGVycm9yMiB9ID0gcmVzdWx0OwogICAgICAgICAgaWYgKGVycm9yMikgewogICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgICBjdXJyZW50U2Vzc2lvbiA9IChfYSA9IGRhdGEuc2Vzc2lvbikgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogdm9pZCAwOwogICAgICAgIH0KICAgICAgICBpZiAoIShjdXJyZW50U2Vzc2lvbiA9PT0gbnVsbCB8fCBjdXJyZW50U2Vzc2lvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogY3VycmVudFNlc3Npb24ucmVmcmVzaF90b2tlbikpIHsKICAgICAgICAgIHRocm93IG5ldyBBdXRoU2Vzc2lvbk1pc3NpbmdFcnJvcigpOwogICAgICAgIH0KICAgICAgICBjb25zdCB7IGRhdGE6IHNlc3Npb24sIGVycm9yIH0gPSBhd2FpdCB0aGlzLl9jYWxsUmVmcmVzaFRva2VuKGN1cnJlbnRTZXNzaW9uLnJlZnJlc2hfdG9rZW4pOwogICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKCFzZXNzaW9uKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yOiBudWxsIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBzZXNzaW9uLnVzZXIsIHNlc3Npb24gfSwgZXJyb3I6IG51bGwgfSk7CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIEdldHMgdGhlIHNlc3Npb24gZGF0YSBmcm9tIGEgVVJMIHN0cmluZwogICAqLwogIGFzeW5jIF9nZXRTZXNzaW9uRnJvbVVSTChwYXJhbXMsIGNhbGxiYWNrVXJsVHlwZSkgewogICAgdHJ5IHsKICAgICAgaWYgKCFpc0Jyb3dzZXIoKSkKICAgICAgICB0aHJvdyBuZXcgQXV0aEltcGxpY2l0R3JhbnRSZWRpcmVjdEVycm9yKCJObyBicm93c2VyIGRldGVjdGVkLiIpOwogICAgICBpZiAocGFyYW1zLmVycm9yIHx8IHBhcmFtcy5lcnJvcl9kZXNjcmlwdGlvbiB8fCBwYXJhbXMuZXJyb3JfY29kZSkgewogICAgICAgIHRocm93IG5ldyBBdXRoSW1wbGljaXRHcmFudFJlZGlyZWN0RXJyb3IocGFyYW1zLmVycm9yX2Rlc2NyaXB0aW9uIHx8ICJFcnJvciBpbiBVUkwgd2l0aCB1bnNwZWNpZmllZCBlcnJvcl9kZXNjcmlwdGlvbiIsIHsKICAgICAgICAgIGVycm9yOiBwYXJhbXMuZXJyb3IgfHwgInVuc3BlY2lmaWVkX2Vycm9yIiwKICAgICAgICAgIGNvZGU6IHBhcmFtcy5lcnJvcl9jb2RlIHx8ICJ1bnNwZWNpZmllZF9jb2RlIgogICAgICAgIH0pOwogICAgICB9CiAgICAgIHN3aXRjaCAoY2FsbGJhY2tVcmxUeXBlKSB7CiAgICAgICAgY2FzZSAiaW1wbGljaXQiOgogICAgICAgICAgaWYgKHRoaXMuZmxvd1R5cGUgPT09ICJwa2NlIikgewogICAgICAgICAgICB0aHJvdyBuZXcgQXV0aFBLQ0VHcmFudENvZGVFeGNoYW5nZUVycm9yKCJOb3QgYSB2YWxpZCBQS0NFIGZsb3cgdXJsLiIpOwogICAgICAgICAgfQogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAicGtjZSI6CiAgICAgICAgICBpZiAodGhpcy5mbG93VHlwZSA9PT0gImltcGxpY2l0IikgewogICAgICAgICAgICB0aHJvdyBuZXcgQXV0aEltcGxpY2l0R3JhbnRSZWRpcmVjdEVycm9yKCJOb3QgYSB2YWxpZCBpbXBsaWNpdCBncmFudCBmbG93IHVybC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgIH0KICAgICAgaWYgKGNhbGxiYWNrVXJsVHlwZSA9PT0gInBrY2UiKSB7CiAgICAgICAgdGhpcy5fZGVidWcoIiNfaW5pdGlhbGl6ZSgpIiwgImJlZ2luIiwgImlzIFBLQ0UgZmxvdyIsIHRydWUpOwogICAgICAgIGlmICghcGFyYW1zLmNvZGUpCiAgICAgICAgICB0aHJvdyBuZXcgQXV0aFBLQ0VHcmFudENvZGVFeGNoYW5nZUVycm9yKCJObyBjb2RlIGRldGVjdGVkLiIpOwogICAgICAgIGNvbnN0IHsgZGF0YTogZGF0YTIsIGVycm9yOiBlcnJvcjIgfSA9IGF3YWl0IHRoaXMuX2V4Y2hhbmdlQ29kZUZvclNlc3Npb24ocGFyYW1zLmNvZGUpOwogICAgICAgIGlmIChlcnJvcjIpCiAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgY29uc3QgdXJsID0gbmV3IFVSTCh3aW5kb3cubG9jYXRpb24uaHJlZik7CiAgICAgICAgdXJsLnNlYXJjaFBhcmFtcy5kZWxldGUoImNvZGUiKTsKICAgICAgICB3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUod2luZG93Lmhpc3Rvcnkuc3RhdGUsICIiLCB1cmwudG9TdHJpbmcoKSk7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogeyBzZXNzaW9uOiBkYXRhMi5zZXNzaW9uLCByZWRpcmVjdFR5cGU6IG51bGwgfSwgZXJyb3I6IG51bGwgfTsKICAgICAgfQogICAgICBjb25zdCB7IHByb3ZpZGVyX3Rva2VuLCBwcm92aWRlcl9yZWZyZXNoX3Rva2VuLCBhY2Nlc3NfdG9rZW4sIHJlZnJlc2hfdG9rZW4sIGV4cGlyZXNfaW4sIGV4cGlyZXNfYXQsIHRva2VuX3R5cGUgfSA9IHBhcmFtczsKICAgICAgaWYgKCFhY2Nlc3NfdG9rZW4gfHwgIWV4cGlyZXNfaW4gfHwgIXJlZnJlc2hfdG9rZW4gfHwgIXRva2VuX3R5cGUpIHsKICAgICAgICB0aHJvdyBuZXcgQXV0aEltcGxpY2l0R3JhbnRSZWRpcmVjdEVycm9yKCJObyBzZXNzaW9uIGRlZmluZWQgaW4gVVJMIik7CiAgICAgIH0KICAgICAgY29uc3QgdGltZU5vdyA9IE1hdGgucm91bmQoRGF0ZS5ub3coKSAvIDFlMyk7CiAgICAgIGNvbnN0IGV4cGlyZXNJbiA9IHBhcnNlSW50KGV4cGlyZXNfaW4pOwogICAgICBsZXQgZXhwaXJlc0F0MiA9IHRpbWVOb3cgKyBleHBpcmVzSW47CiAgICAgIGlmIChleHBpcmVzX2F0KSB7CiAgICAgICAgZXhwaXJlc0F0MiA9IHBhcnNlSW50KGV4cGlyZXNfYXQpOwogICAgICB9CiAgICAgIGNvbnN0IGFjdHVhbGx5RXhwaXJlc0luID0gZXhwaXJlc0F0MiAtIHRpbWVOb3c7CiAgICAgIGlmIChhY3R1YWxseUV4cGlyZXNJbiAqIDFlMyA8PSBBVVRPX1JFRlJFU0hfVElDS19EVVJBVElPTl9NUykgewogICAgICAgIGNvbnNvbGUud2FybihgQHN1cGFiYXNlL2dvdHJ1ZS1qczogU2Vzc2lvbiBhcyByZXRyaWV2ZWQgZnJvbSBVUkwgZXhwaXJlcyBpbiAke2FjdHVhbGx5RXhwaXJlc0lufXMsIHNob3VsZCBoYXZlIGJlZW4gY2xvc2VyIHRvICR7ZXhwaXJlc0lufXNgKTsKICAgICAgfQogICAgICBjb25zdCBpc3N1ZWRBdCA9IGV4cGlyZXNBdDIgLSBleHBpcmVzSW47CiAgICAgIGlmICh0aW1lTm93IC0gaXNzdWVkQXQgPj0gMTIwKSB7CiAgICAgICAgY29uc29sZS53YXJuKCJAc3VwYWJhc2UvZ290cnVlLWpzOiBTZXNzaW9uIGFzIHJldHJpZXZlZCBmcm9tIFVSTCB3YXMgaXNzdWVkIG92ZXIgMTIwcyBhZ28sIFVSTCBjb3VsZCBiZSBzdGFsZSIsIGlzc3VlZEF0LCBleHBpcmVzQXQyLCB0aW1lTm93KTsKICAgICAgfSBlbHNlIGlmICh0aW1lTm93IC0gaXNzdWVkQXQgPCAwKSB7CiAgICAgICAgY29uc29sZS53YXJuKCJAc3VwYWJhc2UvZ290cnVlLWpzOiBTZXNzaW9uIGFzIHJldHJpZXZlZCBmcm9tIFVSTCB3YXMgaXNzdWVkIGluIHRoZSBmdXR1cmU/IENoZWNrIHRoZSBkZXZpY2UgY2xvY2sgZm9yIHNrZXciLCBpc3N1ZWRBdCwgZXhwaXJlc0F0MiwgdGltZU5vdyk7CiAgICAgIH0KICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgdGhpcy5fZ2V0VXNlcihhY2Nlc3NfdG9rZW4pOwogICAgICBpZiAoZXJyb3IpCiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIGNvbnN0IHNlc3Npb24gPSB7CiAgICAgICAgcHJvdmlkZXJfdG9rZW4sCiAgICAgICAgcHJvdmlkZXJfcmVmcmVzaF90b2tlbiwKICAgICAgICBhY2Nlc3NfdG9rZW4sCiAgICAgICAgZXhwaXJlc19pbjogZXhwaXJlc0luLAogICAgICAgIGV4cGlyZXNfYXQ6IGV4cGlyZXNBdDIsCiAgICAgICAgcmVmcmVzaF90b2tlbiwKICAgICAgICB0b2tlbl90eXBlLAogICAgICAgIHVzZXI6IGRhdGEudXNlcgogICAgICB9OwogICAgICB3aW5kb3cubG9jYXRpb24uaGFzaCA9ICIiOwogICAgICB0aGlzLl9kZWJ1ZygiI19nZXRTZXNzaW9uRnJvbVVSTCgpIiwgImNsZWFyaW5nIHdpbmRvdy5sb2NhdGlvbi5oYXNoIik7CiAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHNlc3Npb24sIHJlZGlyZWN0VHlwZTogcGFyYW1zLnR5cGUgfSwgZXJyb3I6IG51bGwgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgc2Vzc2lvbjogbnVsbCwgcmVkaXJlY3RUeXBlOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBDaGVja3MgaWYgdGhlIGN1cnJlbnQgVVJMIGNvbnRhaW5zIHBhcmFtZXRlcnMgZ2l2ZW4gYnkgYW4gaW1wbGljaXQgb2F1dGggZ3JhbnQgZmxvdyAoaHR0cHM6Ly93d3cucmZjLWVkaXRvci5vcmcvcmZjL3JmYzY3NDkuaHRtbCNzZWN0aW9uLTQuMikKICAgKgogICAqIElmIGBkZXRlY3RTZXNzaW9uSW5VcmxgIGlzIGEgZnVuY3Rpb24sIGl0IHdpbGwgYmUgY2FsbGVkIHdpdGggdGhlIFVSTCBhbmQgcGFyYW1zIHRvIGRldGVybWluZQogICAqIGlmIHRoZSBVUkwgc2hvdWxkIGJlIHByb2Nlc3NlZCBhcyBhIFN1cGFiYXNlIGF1dGggY2FsbGJhY2suIFRoaXMgYWxsb3dzIHVzZXJzIHRvIGV4Y2x1ZGUKICAgKiBVUkxzIGZyb20gb3RoZXIgT0F1dGggcHJvdmlkZXJzIChlLmcuLCBGYWNlYm9vayBMb2dpbikgdGhhdCBhbHNvIHJldHVybiBhY2Nlc3NfdG9rZW4gaW4gdGhlIGZyYWdtZW50LgogICAqLwogIF9pc0ltcGxpY2l0R3JhbnRDYWxsYmFjayhwYXJhbXMpIHsKICAgIGlmICh0eXBlb2YgdGhpcy5kZXRlY3RTZXNzaW9uSW5VcmwgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgcmV0dXJuIHRoaXMuZGV0ZWN0U2Vzc2lvbkluVXJsKG5ldyBVUkwod2luZG93LmxvY2F0aW9uLmhyZWYpLCBwYXJhbXMpOwogICAgfQogICAgcmV0dXJuIEJvb2xlYW4ocGFyYW1zLmFjY2Vzc190b2tlbiB8fCBwYXJhbXMuZXJyb3JfZGVzY3JpcHRpb24pOwogIH0KICAvKioKICAgKiBDaGVja3MgaWYgdGhlIGN1cnJlbnQgVVJMIGFuZCBiYWNraW5nIHN0b3JhZ2UgY29udGFpbiBwYXJhbWV0ZXJzIGdpdmVuIGJ5IGEgUEtDRSBmbG93CiAgICovCiAgYXN5bmMgX2lzUEtDRUNhbGxiYWNrKHBhcmFtcykgewogICAgY29uc3QgY3VycmVudFN0b3JhZ2VDb250ZW50ID0gYXdhaXQgZ2V0SXRlbUFzeW5jKHRoaXMuc3RvcmFnZSwgYCR7dGhpcy5zdG9yYWdlS2V5fS1jb2RlLXZlcmlmaWVyYCk7CiAgICByZXR1cm4gISEocGFyYW1zLmNvZGUgJiYgY3VycmVudFN0b3JhZ2VDb250ZW50KTsKICB9CiAgLyoqCiAgICogSW5zaWRlIGEgYnJvd3NlciBjb250ZXh0LCBgc2lnbk91dCgpYCB3aWxsIHJlbW92ZSB0aGUgbG9nZ2VkIGluIHVzZXIgZnJvbSB0aGUgYnJvd3NlciBzZXNzaW9uIGFuZCBsb2cgdGhlbSBvdXQgLSByZW1vdmluZyBhbGwgaXRlbXMgZnJvbSBsb2NhbHN0b3JhZ2UgYW5kIHRoZW4gdHJpZ2dlciBhIGAiU0lHTkVEX09VVCJgIGV2ZW50LgogICAqCiAgICogRm9yIHNlcnZlci1zaWRlIG1hbmFnZW1lbnQsIHlvdSBjYW4gcmV2b2tlIGFsbCByZWZyZXNoIHRva2VucyBmb3IgYSB1c2VyIGJ5IHBhc3NpbmcgYSB1c2VyJ3MgSldUIHRocm91Z2ggdG8gYGF1dGguYXBpLnNpZ25PdXQoSldUOiBzdHJpbmcpYC4KICAgKiBUaGVyZSBpcyBubyB3YXkgdG8gcmV2b2tlIGEgdXNlcidzIGFjY2VzcyB0b2tlbiBqd3QgdW50aWwgaXQgZXhwaXJlcy4gSXQgaXMgcmVjb21tZW5kZWQgdG8gc2V0IGEgc2hvcnRlciBleHBpcnkgb24gdGhlIGp3dCBmb3IgdGhpcyByZWFzb24uCiAgICoKICAgKiBJZiB1c2luZyBgb3RoZXJzYCBzY29wZSwgbm8gYFNJR05FRF9PVVRgIGV2ZW50IGlzIGZpcmVkIQogICAqLwogIGFzeW5jIHNpZ25PdXQob3B0aW9ucyA9IHsgc2NvcGU6ICJnbG9iYWwiIH0pIHsKICAgIGF3YWl0IHRoaXMuaW5pdGlhbGl6ZVByb21pc2U7CiAgICByZXR1cm4gYXdhaXQgdGhpcy5fYWNxdWlyZUxvY2sodGhpcy5sb2NrQWNxdWlyZVRpbWVvdXQsIGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3NpZ25PdXQob3B0aW9ucyk7CiAgICB9KTsKICB9CiAgYXN5bmMgX3NpZ25PdXQoeyBzY29wZSB9ID0geyBzY29wZTogImdsb2JhbCIgfSkgewogICAgcmV0dXJuIGF3YWl0IHRoaXMuX3VzZVNlc3Npb24oYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICB2YXIgX2E7CiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3I6IHNlc3Npb25FcnJvciB9ID0gcmVzdWx0OwogICAgICBpZiAoc2Vzc2lvbkVycm9yICYmICFpc0F1dGhTZXNzaW9uTWlzc2luZ0Vycm9yKHNlc3Npb25FcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZXJyb3I6IHNlc3Npb25FcnJvciB9KTsKICAgICAgfQogICAgICBjb25zdCBhY2Nlc3NUb2tlbiA9IChfYSA9IGRhdGEuc2Vzc2lvbikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmFjY2Vzc190b2tlbjsKICAgICAgaWYgKGFjY2Vzc1Rva2VuKSB7CiAgICAgICAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgdGhpcy5hZG1pbi5zaWduT3V0KGFjY2Vzc1Rva2VuLCBzY29wZSk7CiAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICBpZiAoIShpc0F1dGhBcGlFcnJvcihlcnJvcikgJiYgKGVycm9yLnN0YXR1cyA9PT0gNDA0IHx8IGVycm9yLnN0YXR1cyA9PT0gNDAxIHx8IGVycm9yLnN0YXR1cyA9PT0gNDAzKSB8fCBpc0F1dGhTZXNzaW9uTWlzc2luZ0Vycm9yKGVycm9yKSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGVycm9yIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoc2NvcGUgIT09ICJvdGhlcnMiKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fcmVtb3ZlU2Vzc2lvbigpOwogICAgICAgIGF3YWl0IHJlbW92ZUl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIGAke3RoaXMuc3RvcmFnZUtleX0tY29kZS12ZXJpZmllcmApOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBlcnJvcjogbnVsbCB9KTsKICAgIH0pOwogIH0KICBvbkF1dGhTdGF0ZUNoYW5nZShjYWxsYmFjaykgewogICAgY29uc3QgaWQgPSBnZW5lcmF0ZUNhbGxiYWNrSWQoKTsKICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHsKICAgICAgaWQsCiAgICAgIGNhbGxiYWNrLAogICAgICB1bnN1YnNjcmliZTogKCkgPT4gewogICAgICAgIHRoaXMuX2RlYnVnKCIjdW5zdWJzY3JpYmUoKSIsICJzdGF0ZSBjaGFuZ2UgY2FsbGJhY2sgd2l0aCBpZCByZW1vdmVkIiwgaWQpOwogICAgICAgIHRoaXMuc3RhdGVDaGFuZ2VFbWl0dGVycy5kZWxldGUoaWQpOwogICAgICB9CiAgICB9OwogICAgdGhpcy5fZGVidWcoIiNvbkF1dGhTdGF0ZUNoYW5nZSgpIiwgInJlZ2lzdGVyZWQgY2FsbGJhY2sgd2l0aCBpZCIsIGlkKTsKICAgIHRoaXMuc3RhdGVDaGFuZ2VFbWl0dGVycy5zZXQoaWQsIHN1YnNjcmlwdGlvbik7CiAgICAoYXN5bmMgKCkgPT4gewogICAgICBhd2FpdCB0aGlzLmluaXRpYWxpemVQcm9taXNlOwogICAgICBhd2FpdCB0aGlzLl9hY3F1aXJlTG9jayh0aGlzLmxvY2tBY3F1aXJlVGltZW91dCwgYXN5bmMgKCkgPT4gewogICAgICAgIHRoaXMuX2VtaXRJbml0aWFsU2Vzc2lvbihpZCk7CiAgICAgIH0pOwogICAgfSkoKTsKICAgIHJldHVybiB7IGRhdGE6IHsgc3Vic2NyaXB0aW9uIH0gfTsKICB9CiAgYXN5bmMgX2VtaXRJbml0aWFsU2Vzc2lvbihpZCkgewogICAgcmV0dXJuIGF3YWl0IHRoaXMuX3VzZVNlc3Npb24oYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICB2YXIgX2EsIF9iOwogICAgICB0cnkgewogICAgICAgIGNvbnN0IHsgZGF0YTogeyBzZXNzaW9uIH0sIGVycm9yIH0gPSByZXN1bHQ7CiAgICAgICAgaWYgKGVycm9yKQogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgYXdhaXQgKChfYSA9IHRoaXMuc3RhdGVDaGFuZ2VFbWl0dGVycy5nZXQoaWQpKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2FsbGJhY2soIklOSVRJQUxfU0VTU0lPTiIsIHNlc3Npb24pKTsKICAgICAgICB0aGlzLl9kZWJ1ZygiSU5JVElBTF9TRVNTSU9OIiwgImNhbGxiYWNrIGlkIiwgaWQsICJzZXNzaW9uIiwgc2Vzc2lvbik7CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGF3YWl0ICgoX2IgPSB0aGlzLnN0YXRlQ2hhbmdlRW1pdHRlcnMuZ2V0KGlkKSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmNhbGxiYWNrKCJJTklUSUFMX1NFU1NJT04iLCBudWxsKSk7CiAgICAgICAgdGhpcy5fZGVidWcoIklOSVRJQUxfU0VTU0lPTiIsICJjYWxsYmFjayBpZCIsIGlkLCAiZXJyb3IiLCBlcnIpOwogICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTsKICAgICAgfQogICAgfSk7CiAgfQogIC8qKgogICAqIFNlbmRzIGEgcGFzc3dvcmQgcmVzZXQgcmVxdWVzdCB0byBhbiBlbWFpbCBhZGRyZXNzLiBUaGlzIG1ldGhvZCBzdXBwb3J0cyB0aGUgUEtDRSBmbG93LgogICAqCiAgICogQHBhcmFtIGVtYWlsIFRoZSBlbWFpbCBhZGRyZXNzIG9mIHRoZSB1c2VyLgogICAqIEBwYXJhbSBvcHRpb25zLnJlZGlyZWN0VG8gVGhlIFVSTCB0byBzZW5kIHRoZSB1c2VyIHRvIGFmdGVyIHRoZXkgY2xpY2sgdGhlIHBhc3N3b3JkIHJlc2V0IGxpbmsuCiAgICogQHBhcmFtIG9wdGlvbnMuY2FwdGNoYVRva2VuIFZlcmlmaWNhdGlvbiB0b2tlbiByZWNlaXZlZCB3aGVuIHRoZSB1c2VyIGNvbXBsZXRlcyB0aGUgY2FwdGNoYSBvbiB0aGUgc2l0ZS4KICAgKi8KICBhc3luYyByZXNldFBhc3N3b3JkRm9yRW1haWwoZW1haWwsIG9wdGlvbnMgPSB7fSkgewogICAgbGV0IGNvZGVDaGFsbGVuZ2UgPSBudWxsOwogICAgbGV0IGNvZGVDaGFsbGVuZ2VNZXRob2QgPSBudWxsOwogICAgaWYgKHRoaXMuZmxvd1R5cGUgPT09ICJwa2NlIikgewogICAgICA7CiAgICAgIFtjb2RlQ2hhbGxlbmdlLCBjb2RlQ2hhbGxlbmdlTWV0aG9kXSA9IGF3YWl0IGdldENvZGVDaGFsbGVuZ2VBbmRNZXRob2QoCiAgICAgICAgdGhpcy5zdG9yYWdlLAogICAgICAgIHRoaXMuc3RvcmFnZUtleSwKICAgICAgICB0cnVlCiAgICAgICAgLy8gaXNQYXNzd29yZFJlY292ZXJ5CiAgICAgICk7CiAgICB9CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vcmVjb3ZlcmAsIHsKICAgICAgICBib2R5OiB7CiAgICAgICAgICBlbWFpbCwKICAgICAgICAgIGNvZGVfY2hhbGxlbmdlOiBjb2RlQ2hhbGxlbmdlLAogICAgICAgICAgY29kZV9jaGFsbGVuZ2VfbWV0aG9kOiBjb2RlQ2hhbGxlbmdlTWV0aG9kLAogICAgICAgICAgZ290cnVlX21ldGFfc2VjdXJpdHk6IHsgY2FwdGNoYV90b2tlbjogb3B0aW9ucy5jYXB0Y2hhVG9rZW4gfQogICAgICAgIH0sCiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIHJlZGlyZWN0VG86IG9wdGlvbnMucmVkaXJlY3RUbwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGF3YWl0IHJlbW92ZUl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIGAke3RoaXMuc3RvcmFnZUtleX0tY29kZS12ZXJpZmllcmApOwogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBHZXRzIGFsbCB0aGUgaWRlbnRpdGllcyBsaW5rZWQgdG8gYSB1c2VyLgogICAqLwogIGFzeW5jIGdldFVzZXJJZGVudGl0aWVzKCkgewogICAgdmFyIF9hOwogICAgdHJ5IHsKICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgdGhpcy5nZXRVc2VyKCk7CiAgICAgIGlmIChlcnJvcikKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgaWRlbnRpdGllczogKF9hID0gZGF0YS51c2VyLmlkZW50aXRpZXMpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IFtdIH0sIGVycm9yOiBudWxsIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgYXN5bmMgbGlua0lkZW50aXR5KGNyZWRlbnRpYWxzKSB7CiAgICBpZiAoInRva2VuIiBpbiBjcmVkZW50aWFscykgewogICAgICByZXR1cm4gdGhpcy5saW5rSWRlbnRpdHlJZFRva2VuKGNyZWRlbnRpYWxzKTsKICAgIH0KICAgIHJldHVybiB0aGlzLmxpbmtJZGVudGl0eU9BdXRoKGNyZWRlbnRpYWxzKTsKICB9CiAgYXN5bmMgbGlua0lkZW50aXR5T0F1dGgoY3JlZGVudGlhbHMpIHsKICAgIHZhciBfYTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHRoaXMuX3VzZVNlc3Npb24oYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICAgIHZhciBfYTIsIF9iLCBfYywgX2QsIF9lOwogICAgICAgIGNvbnN0IHsgZGF0YTogZGF0YTIsIGVycm9yOiBlcnJvcjIgfSA9IHJlc3VsdDsKICAgICAgICBpZiAoZXJyb3IyKQogICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgIGNvbnN0IHVybCA9IGF3YWl0IHRoaXMuX2dldFVybEZvclByb3ZpZGVyKGAke3RoaXMudXJsfS91c2VyL2lkZW50aXRpZXMvYXV0aG9yaXplYCwgY3JlZGVudGlhbHMucHJvdmlkZXIsIHsKICAgICAgICAgIHJlZGlyZWN0VG86IChfYTIgPSBjcmVkZW50aWFscy5vcHRpb25zKSA9PT0gbnVsbCB8fCBfYTIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hMi5yZWRpcmVjdFRvLAogICAgICAgICAgc2NvcGVzOiAoX2IgPSBjcmVkZW50aWFscy5vcHRpb25zKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Iuc2NvcGVzLAogICAgICAgICAgcXVlcnlQYXJhbXM6IChfYyA9IGNyZWRlbnRpYWxzLm9wdGlvbnMpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5xdWVyeVBhcmFtcywKICAgICAgICAgIHNraXBCcm93c2VyUmVkaXJlY3Q6IHRydWUKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIkdFVCIsIHVybCwgewogICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgand0OiAoX2UgPSAoX2QgPSBkYXRhMi5zZXNzaW9uKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2QuYWNjZXNzX3Rva2VuKSAhPT0gbnVsbCAmJiBfZSAhPT0gdm9pZCAwID8gX2UgOiB2b2lkIDAKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIGlmIChlcnJvcikKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgaWYgKGlzQnJvd3NlcigpICYmICEoKF9hID0gY3JlZGVudGlhbHMub3B0aW9ucykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnNraXBCcm93c2VyUmVkaXJlY3QpKSB7CiAgICAgICAgd2luZG93LmxvY2F0aW9uLmFzc2lnbihkYXRhID09PSBudWxsIHx8IGRhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGEudXJsKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsKICAgICAgICBkYXRhOiB7IHByb3ZpZGVyOiBjcmVkZW50aWFscy5wcm92aWRlciwgdXJsOiBkYXRhID09PSBudWxsIHx8IGRhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGEudXJsIH0sCiAgICAgICAgZXJyb3I6IG51bGwKICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgcHJvdmlkZXI6IGNyZWRlbnRpYWxzLnByb3ZpZGVyLCB1cmw6IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIGFzeW5jIGxpbmtJZGVudGl0eUlkVG9rZW4oY3JlZGVudGlhbHMpIHsKICAgIHJldHVybiBhd2FpdCB0aGlzLl91c2VTZXNzaW9uKGFzeW5jIChyZXN1bHQpID0+IHsKICAgICAgdmFyIF9hOwogICAgICB0cnkgewogICAgICAgIGNvbnN0IHsgZXJyb3I6IHNlc3Npb25FcnJvciwgZGF0YTogeyBzZXNzaW9uIH0gfSA9IHJlc3VsdDsKICAgICAgICBpZiAoc2Vzc2lvbkVycm9yKQogICAgICAgICAgdGhyb3cgc2Vzc2lvbkVycm9yOwogICAgICAgIGNvbnN0IHsgb3B0aW9ucywgcHJvdmlkZXIsIHRva2VuLCBhY2Nlc3NfdG9rZW4sIG5vbmNlIH0gPSBjcmVkZW50aWFsczsKICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGAke3RoaXMudXJsfS90b2tlbj9ncmFudF90eXBlPWlkX3Rva2VuYCwgewogICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgand0OiAoX2EgPSBzZXNzaW9uID09PSBudWxsIHx8IHNlc3Npb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNlc3Npb24uYWNjZXNzX3Rva2VuKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiB2b2lkIDAsCiAgICAgICAgICBib2R5OiB7CiAgICAgICAgICAgIHByb3ZpZGVyLAogICAgICAgICAgICBpZF90b2tlbjogdG9rZW4sCiAgICAgICAgICAgIGFjY2Vzc190b2tlbiwKICAgICAgICAgICAgbm9uY2UsCiAgICAgICAgICAgIGxpbmtfaWRlbnRpdHk6IHRydWUsCiAgICAgICAgICAgIGdvdHJ1ZV9tZXRhX3NlY3VyaXR5OiB7IGNhcHRjaGFfdG9rZW46IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5jYXB0Y2hhVG9rZW4gfQogICAgICAgICAgfSwKICAgICAgICAgIHhmb3JtOiBfc2Vzc2lvblJlc3BvbnNlCiAgICAgICAgfSk7CiAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gcmVzOwogICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgICB9IGVsc2UgaWYgKCFkYXRhIHx8ICFkYXRhLnNlc3Npb24gfHwgIWRhdGEudXNlcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7CiAgICAgICAgICAgIGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LAogICAgICAgICAgICBlcnJvcjogbmV3IEF1dGhJbnZhbGlkVG9rZW5SZXNwb25zZUVycm9yKCkKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoZGF0YS5zZXNzaW9uKSB7CiAgICAgICAgICBhd2FpdCB0aGlzLl9zYXZlU2Vzc2lvbihkYXRhLnNlc3Npb24pOwogICAgICAgICAgYXdhaXQgdGhpcy5fbm90aWZ5QWxsU3Vic2NyaWJlcnMoIlVTRVJfVVBEQVRFRCIsIGRhdGEuc2Vzc2lvbik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhLCBlcnJvciB9KTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBhd2FpdCByZW1vdmVJdGVtQXN5bmModGhpcy5zdG9yYWdlLCBgJHt0aGlzLnN0b3JhZ2VLZXl9LWNvZGUtdmVyaWZpZXJgKTsKICAgICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yIH0pOwogICAgICAgIH0KICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgfSk7CiAgfQogIC8qKgogICAqIFVubGlua3MgYW4gaWRlbnRpdHkgZnJvbSBhIHVzZXIgYnkgZGVsZXRpbmcgaXQuIFRoZSB1c2VyIHdpbGwgbm8gbG9uZ2VyIGJlIGFibGUgdG8gc2lnbiBpbiB3aXRoIHRoYXQgaWRlbnRpdHkgb25jZSBpdCdzIHVubGlua2VkLgogICAqLwogIGFzeW5jIHVubGlua0lkZW50aXR5KGlkZW50aXR5NCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3VzZVNlc3Npb24oYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICAgIHZhciBfYSwgX2I7CiAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gcmVzdWx0OwogICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiREVMRVRFIiwgYCR7dGhpcy51cmx9L3VzZXIvaWRlbnRpdGllcy8ke2lkZW50aXR5NC5pZGVudGl0eV9pZH1gLCB7CiAgICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgICBqd3Q6IChfYiA9IChfYSA9IGRhdGEuc2Vzc2lvbikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmFjY2Vzc190b2tlbikgIT09IG51bGwgJiYgX2IgIT09IHZvaWQgMCA/IF9iIDogdm9pZCAwCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogR2VuZXJhdGVzIGEgbmV3IEpXVC4KICAgKiBAcGFyYW0gcmVmcmVzaFRva2VuIEEgdmFsaWQgcmVmcmVzaCB0b2tlbiB0aGF0IHdhcyByZXR1cm5lZCBvbiBsb2dpbi4KICAgKi8KICBhc3luYyBfcmVmcmVzaEFjY2Vzc1Rva2VuKHJlZnJlc2hUb2tlbikgewogICAgY29uc3QgZGVidWdOYW1lID0gYCNfcmVmcmVzaEFjY2Vzc1Rva2VuKCR7cmVmcmVzaFRva2VuLnN1YnN0cmluZygwLCA1KX0uLi4pYDsKICAgIHRoaXMuX2RlYnVnKGRlYnVnTmFtZSwgImJlZ2luIik7CiAgICB0cnkgewogICAgICBjb25zdCBzdGFydGVkQXQgPSBEYXRlLm5vdygpOwogICAgICByZXR1cm4gYXdhaXQgcmV0cnlhYmxlKGFzeW5jIChhdHRlbXB0KSA9PiB7CiAgICAgICAgaWYgKGF0dGVtcHQgPiAwKSB7CiAgICAgICAgICBhd2FpdCBzbGVlcCgyMDAgKiBNYXRoLnBvdygyLCBhdHRlbXB0IC0gMSkpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9kZWJ1ZyhkZWJ1Z05hbWUsICJyZWZyZXNoaW5nIGF0dGVtcHQiLCBhdHRlbXB0KTsKICAgICAgICByZXR1cm4gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vdG9rZW4/Z3JhbnRfdHlwZT1yZWZyZXNoX3Rva2VuYCwgewogICAgICAgICAgYm9keTogeyByZWZyZXNoX3Rva2VuOiByZWZyZXNoVG9rZW4gfSwKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIHhmb3JtOiBfc2Vzc2lvblJlc3BvbnNlCiAgICAgICAgfSk7CiAgICAgIH0sIChhdHRlbXB0LCBlcnJvcikgPT4gewogICAgICAgIGNvbnN0IG5leHRCYWNrT2ZmSW50ZXJ2YWwgPSAyMDAgKiBNYXRoLnBvdygyLCBhdHRlbXB0KTsKICAgICAgICByZXR1cm4gZXJyb3IgJiYgaXNBdXRoUmV0cnlhYmxlRmV0Y2hFcnJvcihlcnJvcikgJiYgLy8gcmV0cnlhYmxlIG9ubHkgaWYgdGhlIHJlcXVlc3QgY2FuIGJlIHNlbnQgYmVmb3JlIHRoZSBiYWNrb2ZmIG92ZXJmbG93cyB0aGUgdGljayBkdXJhdGlvbgogICAgICAgIERhdGUubm93KCkgKyBuZXh0QmFja09mZkludGVydmFsIC0gc3RhcnRlZEF0IDwgQVVUT19SRUZSRVNIX1RJQ0tfRFVSQVRJT05fTVM7CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgdGhpcy5fZGVidWcoZGVidWdOYW1lLCAiZXJyb3IiLCBlcnJvcik7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyBzZXNzaW9uOiBudWxsLCB1c2VyOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fZGVidWcoZGVidWdOYW1lLCAiZW5kIik7CiAgICB9CiAgfQogIF9pc1ZhbGlkU2Vzc2lvbihtYXliZVNlc3Npb24pIHsKICAgIGNvbnN0IGlzVmFsaWRTZXNzaW9uID0gdHlwZW9mIG1heWJlU2Vzc2lvbiA9PT0gIm9iamVjdCIgJiYgbWF5YmVTZXNzaW9uICE9PSBudWxsICYmICJhY2Nlc3NfdG9rZW4iIGluIG1heWJlU2Vzc2lvbiAmJiAicmVmcmVzaF90b2tlbiIgaW4gbWF5YmVTZXNzaW9uICYmICJleHBpcmVzX2F0IiBpbiBtYXliZVNlc3Npb247CiAgICByZXR1cm4gaXNWYWxpZFNlc3Npb247CiAgfQogIGFzeW5jIF9oYW5kbGVQcm92aWRlclNpZ25Jbihwcm92aWRlciwgb3B0aW9ucykgewogICAgY29uc3QgdXJsID0gYXdhaXQgdGhpcy5fZ2V0VXJsRm9yUHJvdmlkZXIoYCR7dGhpcy51cmx9L2F1dGhvcml6ZWAsIHByb3ZpZGVyLCB7CiAgICAgIHJlZGlyZWN0VG86IG9wdGlvbnMucmVkaXJlY3RUbywKICAgICAgc2NvcGVzOiBvcHRpb25zLnNjb3BlcywKICAgICAgcXVlcnlQYXJhbXM6IG9wdGlvbnMucXVlcnlQYXJhbXMKICAgIH0pOwogICAgdGhpcy5fZGVidWcoIiNfaGFuZGxlUHJvdmlkZXJTaWduSW4oKSIsICJwcm92aWRlciIsIHByb3ZpZGVyLCAib3B0aW9ucyIsIG9wdGlvbnMsICJ1cmwiLCB1cmwpOwogICAgaWYgKGlzQnJvd3NlcigpICYmICFvcHRpb25zLnNraXBCcm93c2VyUmVkaXJlY3QpIHsKICAgICAgd2luZG93LmxvY2F0aW9uLmFzc2lnbih1cmwpOwogICAgfQogICAgcmV0dXJuIHsgZGF0YTogeyBwcm92aWRlciwgdXJsIH0sIGVycm9yOiBudWxsIH07CiAgfQogIC8qKgogICAqIFJlY292ZXJzIHRoZSBzZXNzaW9uIGZyb20gTG9jYWxTdG9yYWdlIGFuZCByZWZyZXNoZXMgdGhlIHRva2VuCiAgICogTm90ZTogdGhpcyBtZXRob2QgaXMgYXN5bmMgdG8gYWNjb21tb2RhdGUgZm9yIEFzeW5jU3RvcmFnZSBlLmcuIGluIFJlYWN0IG5hdGl2ZS4KICAgKi8KICBhc3luYyBfcmVjb3ZlckFuZFJlZnJlc2goKSB7CiAgICB2YXIgX2EsIF9iOwogICAgY29uc3QgZGVidWdOYW1lID0gIiNfcmVjb3ZlckFuZFJlZnJlc2goKSI7CiAgICB0aGlzLl9kZWJ1ZyhkZWJ1Z05hbWUsICJiZWdpbiIpOwogICAgdHJ5IHsKICAgICAgY29uc3QgY3VycmVudFNlc3Npb24gPSBhd2FpdCBnZXRJdGVtQXN5bmModGhpcy5zdG9yYWdlLCB0aGlzLnN0b3JhZ2VLZXkpOwogICAgICBpZiAoY3VycmVudFNlc3Npb24gJiYgdGhpcy51c2VyU3RvcmFnZSkgewogICAgICAgIGxldCBtYXliZVVzZXIgPSBhd2FpdCBnZXRJdGVtQXN5bmModGhpcy51c2VyU3RvcmFnZSwgdGhpcy5zdG9yYWdlS2V5ICsgIi11c2VyIik7CiAgICAgICAgaWYgKCF0aGlzLnN0b3JhZ2UuaXNTZXJ2ZXIgJiYgT2JqZWN0LmlzKHRoaXMuc3RvcmFnZSwgdGhpcy51c2VyU3RvcmFnZSkgJiYgIW1heWJlVXNlcikgewogICAgICAgICAgbWF5YmVVc2VyID0geyB1c2VyOiBjdXJyZW50U2Vzc2lvbi51c2VyIH07CiAgICAgICAgICBhd2FpdCBzZXRJdGVtQXN5bmModGhpcy51c2VyU3RvcmFnZSwgdGhpcy5zdG9yYWdlS2V5ICsgIi11c2VyIiwgbWF5YmVVc2VyKTsKICAgICAgICB9CiAgICAgICAgY3VycmVudFNlc3Npb24udXNlciA9IChfYSA9IG1heWJlVXNlciA9PT0gbnVsbCB8fCBtYXliZVVzZXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG1heWJlVXNlci51c2VyKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiB1c2VyTm90QXZhaWxhYmxlUHJveHkoKTsKICAgICAgfSBlbHNlIGlmIChjdXJyZW50U2Vzc2lvbiAmJiAhY3VycmVudFNlc3Npb24udXNlcikgewogICAgICAgIGlmICghY3VycmVudFNlc3Npb24udXNlcikgewogICAgICAgICAgY29uc3Qgc2VwYXJhdGVVc2VyID0gYXdhaXQgZ2V0SXRlbUFzeW5jKHRoaXMuc3RvcmFnZSwgdGhpcy5zdG9yYWdlS2V5ICsgIi11c2VyIik7CiAgICAgICAgICBpZiAoc2VwYXJhdGVVc2VyICYmIChzZXBhcmF0ZVVzZXIgPT09IG51bGwgfHwgc2VwYXJhdGVVc2VyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXBhcmF0ZVVzZXIudXNlcikpIHsKICAgICAgICAgICAgY3VycmVudFNlc3Npb24udXNlciA9IHNlcGFyYXRlVXNlci51c2VyOwogICAgICAgICAgICBhd2FpdCByZW1vdmVJdGVtQXN5bmModGhpcy5zdG9yYWdlLCB0aGlzLnN0b3JhZ2VLZXkgKyAiLXVzZXIiKTsKICAgICAgICAgICAgYXdhaXQgc2V0SXRlbUFzeW5jKHRoaXMuc3RvcmFnZSwgdGhpcy5zdG9yYWdlS2V5LCBjdXJyZW50U2Vzc2lvbik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjdXJyZW50U2Vzc2lvbi51c2VyID0gdXNlck5vdEF2YWlsYWJsZVByb3h5KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuX2RlYnVnKGRlYnVnTmFtZSwgInNlc3Npb24gZnJvbSBzdG9yYWdlIiwgY3VycmVudFNlc3Npb24pOwogICAgICBpZiAoIXRoaXMuX2lzVmFsaWRTZXNzaW9uKGN1cnJlbnRTZXNzaW9uKSkgewogICAgICAgIHRoaXMuX2RlYnVnKGRlYnVnTmFtZSwgInNlc3Npb24gaXMgbm90IHZhbGlkIik7CiAgICAgICAgaWYgKGN1cnJlbnRTZXNzaW9uICE9PSBudWxsKSB7CiAgICAgICAgICBhd2FpdCB0aGlzLl9yZW1vdmVTZXNzaW9uKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBjb25zdCBleHBpcmVzV2l0aE1hcmdpbiA9ICgoX2IgPSBjdXJyZW50U2Vzc2lvbi5leHBpcmVzX2F0KSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiBJbmZpbml0eSkgKiAxZTMgLSBEYXRlLm5vdygpIDwgRVhQSVJZX01BUkdJTl9NUzsKICAgICAgdGhpcy5fZGVidWcoZGVidWdOYW1lLCBgc2Vzc2lvbiBoYXMke2V4cGlyZXNXaXRoTWFyZ2luID8gIiIgOiAiIG5vdCJ9IGV4cGlyZWQgd2l0aCBtYXJnaW4gb2YgJHtFWFBJUllfTUFSR0lOX01TfXNgKTsKICAgICAgaWYgKGV4cGlyZXNXaXRoTWFyZ2luKSB7CiAgICAgICAgaWYgKHRoaXMuYXV0b1JlZnJlc2hUb2tlbiAmJiBjdXJyZW50U2Vzc2lvbi5yZWZyZXNoX3Rva2VuKSB7CiAgICAgICAgICBjb25zdCB7IGVycm9yIH0gPSBhd2FpdCB0aGlzLl9jYWxsUmVmcmVzaFRva2VuKGN1cnJlbnRTZXNzaW9uLnJlZnJlc2hfdG9rZW4pOwogICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpOwogICAgICAgICAgICBpZiAoIWlzQXV0aFJldHJ5YWJsZUZldGNoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgICAgICAgdGhpcy5fZGVidWcoZGVidWdOYW1lLCAicmVmcmVzaCBmYWlsZWQgd2l0aCBhIG5vbi1yZXRyeWFibGUgZXJyb3IsIHJlbW92aW5nIHRoZSBzZXNzaW9uIiwgZXJyb3IpOwogICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3JlbW92ZVNlc3Npb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChjdXJyZW50U2Vzc2lvbi51c2VyICYmIGN1cnJlbnRTZXNzaW9uLnVzZXIuX19pc1VzZXJOb3RBdmFpbGFibGVQcm94eSA9PT0gdHJ1ZSkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBjb25zdCB7IGRhdGEsIGVycm9yOiB1c2VyRXJyb3IgfSA9IGF3YWl0IHRoaXMuX2dldFVzZXIoY3VycmVudFNlc3Npb24uYWNjZXNzX3Rva2VuKTsKICAgICAgICAgIGlmICghdXNlckVycm9yICYmIChkYXRhID09PSBudWxsIHx8IGRhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGEudXNlcikpIHsKICAgICAgICAgICAgY3VycmVudFNlc3Npb24udXNlciA9IGRhdGEudXNlcjsKICAgICAgICAgICAgYXdhaXQgdGhpcy5fc2F2ZVNlc3Npb24oY3VycmVudFNlc3Npb24pOwogICAgICAgICAgICBhd2FpdCB0aGlzLl9ub3RpZnlBbGxTdWJzY3JpYmVycygiU0lHTkVEX0lOIiwgY3VycmVudFNlc3Npb24pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fZGVidWcoZGVidWdOYW1lLCAiY291bGQgbm90IGdldCB1c2VyIGRhdGEsIHNraXBwaW5nIFNJR05FRF9JTiBub3RpZmljYXRpb24iKTsKICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChnZXRVc2VyRXJyb3IpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkVycm9yIGdldHRpbmcgdXNlciBkYXRhOiIsIGdldFVzZXJFcnJvcik7CiAgICAgICAgICB0aGlzLl9kZWJ1ZyhkZWJ1Z05hbWUsICJlcnJvciBnZXR0aW5nIHVzZXIgZGF0YSwgc2tpcHBpbmcgU0lHTkVEX0lOIG5vdGlmaWNhdGlvbiIsIGdldFVzZXJFcnJvcik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGF3YWl0IHRoaXMuX25vdGlmeUFsbFN1YnNjcmliZXJzKCJTSUdORURfSU4iLCBjdXJyZW50U2Vzc2lvbik7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGVycikgewogICAgICB0aGlzLl9kZWJ1ZyhkZWJ1Z05hbWUsICJlcnJvciIsIGVycik7CiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTsKICAgICAgcmV0dXJuOwogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fZGVidWcoZGVidWdOYW1lLCAiZW5kIik7CiAgICB9CiAgfQogIGFzeW5jIF9jYWxsUmVmcmVzaFRva2VuKHJlZnJlc2hUb2tlbikgewogICAgdmFyIF9hLCBfYjsKICAgIGlmICghcmVmcmVzaFRva2VuKSB7CiAgICAgIHRocm93IG5ldyBBdXRoU2Vzc2lvbk1pc3NpbmdFcnJvcigpOwogICAgfQogICAgaWYgKHRoaXMucmVmcmVzaGluZ0RlZmVycmVkKSB7CiAgICAgIHJldHVybiB0aGlzLnJlZnJlc2hpbmdEZWZlcnJlZC5wcm9taXNlOwogICAgfQogICAgY29uc3QgZGVidWdOYW1lID0gYCNfY2FsbFJlZnJlc2hUb2tlbigke3JlZnJlc2hUb2tlbi5zdWJzdHJpbmcoMCwgNSl9Li4uKWA7CiAgICB0aGlzLl9kZWJ1ZyhkZWJ1Z05hbWUsICJiZWdpbiIpOwogICAgdHJ5IHsKICAgICAgdGhpcy5yZWZyZXNoaW5nRGVmZXJyZWQgPSBuZXcgRGVmZXJyZWQoKTsKICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgdGhpcy5fcmVmcmVzaEFjY2Vzc1Rva2VuKHJlZnJlc2hUb2tlbik7CiAgICAgIGlmIChlcnJvcikKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgaWYgKCFkYXRhLnNlc3Npb24pCiAgICAgICAgdGhyb3cgbmV3IEF1dGhTZXNzaW9uTWlzc2luZ0Vycm9yKCk7CiAgICAgIGF3YWl0IHRoaXMuX3NhdmVTZXNzaW9uKGRhdGEuc2Vzc2lvbik7CiAgICAgIGF3YWl0IHRoaXMuX25vdGlmeUFsbFN1YnNjcmliZXJzKCJUT0tFTl9SRUZSRVNIRUQiLCBkYXRhLnNlc3Npb24pOwogICAgICBjb25zdCByZXN1bHQgPSB7IGRhdGE6IGRhdGEuc2Vzc2lvbiwgZXJyb3I6IG51bGwgfTsKICAgICAgdGhpcy5yZWZyZXNoaW5nRGVmZXJyZWQucmVzb2x2ZShyZXN1bHQpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgdGhpcy5fZGVidWcoZGVidWdOYW1lLCAiZXJyb3IiLCBlcnJvcik7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSB7IGRhdGE6IG51bGwsIGVycm9yIH07CiAgICAgICAgaWYgKCFpc0F1dGhSZXRyeWFibGVGZXRjaEVycm9yKGVycm9yKSkgewogICAgICAgICAgYXdhaXQgdGhpcy5fcmVtb3ZlU2Vzc2lvbigpOwogICAgICAgIH0KICAgICAgICAoX2EgPSB0aGlzLnJlZnJlc2hpbmdEZWZlcnJlZCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlc29sdmUocmVzdWx0KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIChfYiA9IHRoaXMucmVmcmVzaGluZ0RlZmVycmVkKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IucmVqZWN0KGVycm9yKTsKICAgICAgdGhyb3cgZXJyb3I7CiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLnJlZnJlc2hpbmdEZWZlcnJlZCA9IG51bGw7CiAgICAgIHRoaXMuX2RlYnVnKGRlYnVnTmFtZSwgImVuZCIpOwogICAgfQogIH0KICBhc3luYyBfbm90aWZ5QWxsU3Vic2NyaWJlcnMoZXZlbnQsIHNlc3Npb24sIGJyb2FkY2FzdCA9IHRydWUpIHsKICAgIGNvbnN0IGRlYnVnTmFtZSA9IGAjX25vdGlmeUFsbFN1YnNjcmliZXJzKCR7ZXZlbnR9KWA7CiAgICB0aGlzLl9kZWJ1ZyhkZWJ1Z05hbWUsICJiZWdpbiIsIHNlc3Npb24sIGBicm9hZGNhc3QgPSAke2Jyb2FkY2FzdH1gKTsKICAgIHRyeSB7CiAgICAgIGlmICh0aGlzLmJyb2FkY2FzdENoYW5uZWwgJiYgYnJvYWRjYXN0KSB7CiAgICAgICAgdGhpcy5icm9hZGNhc3RDaGFubmVsLnBvc3RNZXNzYWdlKHsgZXZlbnQsIHNlc3Npb24gfSk7CiAgICAgIH0KICAgICAgY29uc3QgZXJyb3JzMyA9IFtdOwogICAgICBjb25zdCBwcm9taXNlcyA9IEFycmF5LmZyb20odGhpcy5zdGF0ZUNoYW5nZUVtaXR0ZXJzLnZhbHVlcygpKS5tYXAoYXN5bmMgKHgyKSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGF3YWl0IHgyLmNhbGxiYWNrKGV2ZW50LCBzZXNzaW9uKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBlcnJvcnMzLnB1c2goZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpOwogICAgICBpZiAoZXJyb3JzMy5sZW5ndGggPiAwKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlcnJvcnMzLmxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yczNbaV0pOwogICAgICAgIH0KICAgICAgICB0aHJvdyBlcnJvcnMzWzBdOwogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl9kZWJ1ZyhkZWJ1Z05hbWUsICJlbmQiKTsKICAgIH0KICB9CiAgLyoqCiAgICogc2V0IGN1cnJlbnRTZXNzaW9uIGFuZCBjdXJyZW50VXNlcgogICAqIHByb2Nlc3MgdG8gX3N0YXJ0QXV0b1JlZnJlc2hUb2tlbiBpZiBwb3NzaWJsZQogICAqLwogIGFzeW5jIF9zYXZlU2Vzc2lvbihzZXNzaW9uKSB7CiAgICB0aGlzLl9kZWJ1ZygiI19zYXZlU2Vzc2lvbigpIiwgc2Vzc2lvbik7CiAgICB0aGlzLnN1cHByZXNzR2V0U2Vzc2lvbldhcm5pbmcgPSB0cnVlOwogICAgYXdhaXQgcmVtb3ZlSXRlbUFzeW5jKHRoaXMuc3RvcmFnZSwgYCR7dGhpcy5zdG9yYWdlS2V5fS1jb2RlLXZlcmlmaWVyYCk7CiAgICBjb25zdCBzZXNzaW9uVG9Qcm9jZXNzID0gT2JqZWN0LmFzc2lnbih7fSwgc2Vzc2lvbik7CiAgICBjb25zdCB1c2VySXNQcm94eSA9IHNlc3Npb25Ub1Byb2Nlc3MudXNlciAmJiBzZXNzaW9uVG9Qcm9jZXNzLnVzZXIuX19pc1VzZXJOb3RBdmFpbGFibGVQcm94eSA9PT0gdHJ1ZTsKICAgIGlmICh0aGlzLnVzZXJTdG9yYWdlKSB7CiAgICAgIGlmICghdXNlcklzUHJveHkgJiYgc2Vzc2lvblRvUHJvY2Vzcy51c2VyKSB7CiAgICAgICAgYXdhaXQgc2V0SXRlbUFzeW5jKHRoaXMudXNlclN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSArICItdXNlciIsIHsKICAgICAgICAgIHVzZXI6IHNlc3Npb25Ub1Byb2Nlc3MudXNlcgogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHVzZXJJc1Byb3h5KSB7CiAgICAgIH0KICAgICAgY29uc3QgbWFpblNlc3Npb25EYXRhID0gT2JqZWN0LmFzc2lnbih7fSwgc2Vzc2lvblRvUHJvY2Vzcyk7CiAgICAgIGRlbGV0ZSBtYWluU2Vzc2lvbkRhdGEudXNlcjsKICAgICAgY29uc3QgY2xvbmVkTWFpblNlc3Npb25EYXRhID0gZGVlcENsb25lKG1haW5TZXNzaW9uRGF0YSk7CiAgICAgIGF3YWl0IHNldEl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSwgY2xvbmVkTWFpblNlc3Npb25EYXRhKTsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGNsb25lZFNlc3Npb24gPSBkZWVwQ2xvbmUoc2Vzc2lvblRvUHJvY2Vzcyk7CiAgICAgIGF3YWl0IHNldEl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSwgY2xvbmVkU2Vzc2lvbik7CiAgICB9CiAgfQogIGFzeW5jIF9yZW1vdmVTZXNzaW9uKCkgewogICAgdGhpcy5fZGVidWcoIiNfcmVtb3ZlU2Vzc2lvbigpIik7CiAgICB0aGlzLnN1cHByZXNzR2V0U2Vzc2lvbldhcm5pbmcgPSBmYWxzZTsKICAgIGF3YWl0IHJlbW92ZUl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSk7CiAgICBhd2FpdCByZW1vdmVJdGVtQXN5bmModGhpcy5zdG9yYWdlLCB0aGlzLnN0b3JhZ2VLZXkgKyAiLWNvZGUtdmVyaWZpZXIiKTsKICAgIGF3YWl0IHJlbW92ZUl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSArICItdXNlciIpOwogICAgaWYgKHRoaXMudXNlclN0b3JhZ2UpIHsKICAgICAgYXdhaXQgcmVtb3ZlSXRlbUFzeW5jKHRoaXMudXNlclN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSArICItdXNlciIpOwogICAgfQogICAgYXdhaXQgdGhpcy5fbm90aWZ5QWxsU3Vic2NyaWJlcnMoIlNJR05FRF9PVVQiLCBudWxsKTsKICB9CiAgLyoqCiAgICogUmVtb3ZlcyBhbnkgcmVnaXN0ZXJlZCB2aXNpYmlsaXR5Y2hhbmdlIGNhbGxiYWNrLgogICAqCiAgICoge0BzZWUgI3N0YXJ0QXV0b1JlZnJlc2h9CiAgICoge0BzZWUgI3N0b3BBdXRvUmVmcmVzaH0KICAgKi8KICBfcmVtb3ZlVmlzaWJpbGl0eUNoYW5nZWRDYWxsYmFjaygpIHsKICAgIHRoaXMuX2RlYnVnKCIjX3JlbW92ZVZpc2liaWxpdHlDaGFuZ2VkQ2FsbGJhY2soKSIpOwogICAgY29uc3QgY2FsbGJhY2sgPSB0aGlzLnZpc2liaWxpdHlDaGFuZ2VkQ2FsbGJhY2s7CiAgICB0aGlzLnZpc2liaWxpdHlDaGFuZ2VkQ2FsbGJhY2sgPSBudWxsOwogICAgdHJ5IHsKICAgICAgaWYgKGNhbGxiYWNrICYmIGlzQnJvd3NlcigpICYmICh3aW5kb3cgPT09IG51bGwgfHwgd2luZG93ID09PSB2b2lkIDAgPyB2b2lkIDAgOiB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcikpIHsKICAgICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigidmlzaWJpbGl0eWNoYW5nZSIsIGNhbGxiYWNrKTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBjb25zb2xlLmVycm9yKCJyZW1vdmluZyB2aXNpYmlsaXR5Y2hhbmdlIGNhbGxiYWNrIGZhaWxlZCIsIGUpOwogICAgfQogIH0KICAvKioKICAgKiBUaGlzIGlzIHRoZSBwcml2YXRlIGltcGxlbWVudGF0aW9uIG9mIHtAbGluayAjc3RhcnRBdXRvUmVmcmVzaH0uIFVzZSB0aGlzCiAgICogd2l0aGluIHRoZSBsaWJyYXJ5LgogICAqLwogIGFzeW5jIF9zdGFydEF1dG9SZWZyZXNoKCkgewogICAgYXdhaXQgdGhpcy5fc3RvcEF1dG9SZWZyZXNoKCk7CiAgICB0aGlzLl9kZWJ1ZygiI19zdGFydEF1dG9SZWZyZXNoKCkiKTsKICAgIGNvbnN0IHRpY2tlcjIgPSBzZXRJbnRlcnZhbCgoKSA9PiB0aGlzLl9hdXRvUmVmcmVzaFRva2VuVGljaygpLCBBVVRPX1JFRlJFU0hfVElDS19EVVJBVElPTl9NUyk7CiAgICB0aGlzLmF1dG9SZWZyZXNoVGlja2VyID0gdGlja2VyMjsKICAgIGlmICh0aWNrZXIyICYmIHR5cGVvZiB0aWNrZXIyID09PSAib2JqZWN0IiAmJiB0eXBlb2YgdGlja2VyMi51bnJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICB0aWNrZXIyLnVucmVmKCk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBEZW5vICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgRGVuby51bnJlZlRpbWVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIERlbm8udW5yZWZUaW1lcih0aWNrZXIyKTsKICAgIH0KICAgIGNvbnN0IHRpbWVvdXQgPSBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsKICAgICAgYXdhaXQgdGhpcy5pbml0aWFsaXplUHJvbWlzZTsKICAgICAgYXdhaXQgdGhpcy5fYXV0b1JlZnJlc2hUb2tlblRpY2soKTsKICAgIH0sIDApOwogICAgdGhpcy5hdXRvUmVmcmVzaFRpY2tUaW1lb3V0ID0gdGltZW91dDsKICAgIGlmICh0aW1lb3V0ICYmIHR5cGVvZiB0aW1lb3V0ID09PSAib2JqZWN0IiAmJiB0eXBlb2YgdGltZW91dC51bnJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICB0aW1lb3V0LnVucmVmKCk7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBEZW5vICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgRGVuby51bnJlZlRpbWVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIERlbm8udW5yZWZUaW1lcih0aW1lb3V0KTsKICAgIH0KICB9CiAgLyoqCiAgICogVGhpcyBpcyB0aGUgcHJpdmF0ZSBpbXBsZW1lbnRhdGlvbiBvZiB7QGxpbmsgI3N0b3BBdXRvUmVmcmVzaH0uIFVzZSB0aGlzCiAgICogd2l0aGluIHRoZSBsaWJyYXJ5LgogICAqLwogIGFzeW5jIF9zdG9wQXV0b1JlZnJlc2goKSB7CiAgICB0aGlzLl9kZWJ1ZygiI19zdG9wQXV0b1JlZnJlc2goKSIpOwogICAgY29uc3QgdGlja2VyMiA9IHRoaXMuYXV0b1JlZnJlc2hUaWNrZXI7CiAgICB0aGlzLmF1dG9SZWZyZXNoVGlja2VyID0gbnVsbDsKICAgIGlmICh0aWNrZXIyKSB7CiAgICAgIGNsZWFySW50ZXJ2YWwodGlja2VyMik7CiAgICB9CiAgICBjb25zdCB0aW1lb3V0ID0gdGhpcy5hdXRvUmVmcmVzaFRpY2tUaW1lb3V0OwogICAgdGhpcy5hdXRvUmVmcmVzaFRpY2tUaW1lb3V0ID0gbnVsbDsKICAgIGlmICh0aW1lb3V0KSB7CiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgIH0KICB9CiAgLyoqCiAgICogU3RhcnRzIGFuIGF1dG8tcmVmcmVzaCBwcm9jZXNzIGluIHRoZSBiYWNrZ3JvdW5kLiBUaGUgc2Vzc2lvbiBpcyBjaGVja2VkCiAgICogZXZlcnkgZmV3IHNlY29uZHMuIENsb3NlIHRvIHRoZSB0aW1lIG9mIGV4cGlyYXRpb24gYSBwcm9jZXNzIGlzIHN0YXJ0ZWQgdG8KICAgKiByZWZyZXNoIHRoZSBzZXNzaW9uLiBJZiByZWZyZXNoaW5nIGZhaWxzIGl0IHdpbGwgYmUgcmV0cmllZCBmb3IgYXMgbG9uZyBhcwogICAqIG5lY2Vzc2FyeS4KICAgKgogICAqIElmIHlvdSBzZXQgdGhlIHtAbGluayBHb1RydWVDbGllbnRPcHRpb25zI2F1dG9SZWZyZXNoVG9rZW59IHlvdSBkb24ndCBuZWVkCiAgICogdG8gY2FsbCB0aGlzIGZ1bmN0aW9uLCBpdCB3aWxsIGJlIGNhbGxlZCBmb3IgeW91LgogICAqCiAgICogT24gYnJvd3NlcnMgdGhlIHJlZnJlc2ggcHJvY2VzcyB3b3JrcyBvbmx5IHdoZW4gdGhlIHRhYi93aW5kb3cgaXMgaW4gdGhlCiAgICogZm9yZWdyb3VuZCB0byBjb25zZXJ2ZSByZXNvdXJjZXMgYXMgd2VsbCBhcyBwcmV2ZW50IHJhY2UgY29uZGl0aW9ucyBhbmQKICAgKiBmbG9vZGluZyBhdXRoIHdpdGggcmVxdWVzdHMuIElmIHlvdSBjYWxsIHRoaXMgbWV0aG9kIGFueSBtYW5hZ2VkCiAgICogdmlzaWJpbGl0eSBjaGFuZ2UgY2FsbGJhY2sgd2lsbCBiZSByZW1vdmVkIGFuZCB5b3UgbXVzdCBtYW5hZ2UgdmlzaWJpbGl0eQogICAqIGNoYW5nZXMgb24geW91ciBvd24uCiAgICoKICAgKiBPbiBub24tYnJvd3NlciBwbGF0Zm9ybXMgdGhlIHJlZnJlc2ggcHJvY2VzcyB3b3JrcyAqY29udGludW91c2x5KiBpbiB0aGUKICAgKiBiYWNrZ3JvdW5kLCB3aGljaCBtYXkgbm90IGJlIGRlc2lyYWJsZS4gWW91IHNob3VsZCBob29rIGludG8geW91cgogICAqIHBsYXRmb3JtJ3MgZm9yZWdyb3VuZCBpbmRpY2F0aW9uIG1lY2hhbmlzbSBhbmQgY2FsbCB0aGVzZSBtZXRob2RzCiAgICogYXBwcm9wcmlhdGVseSB0byBjb25zZXJ2ZSByZXNvdXJjZXMuCiAgICoKICAgKiB7QHNlZSAjc3RvcEF1dG9SZWZyZXNofQogICAqLwogIGFzeW5jIHN0YXJ0QXV0b1JlZnJlc2goKSB7CiAgICB0aGlzLl9yZW1vdmVWaXNpYmlsaXR5Q2hhbmdlZENhbGxiYWNrKCk7CiAgICBhd2FpdCB0aGlzLl9zdGFydEF1dG9SZWZyZXNoKCk7CiAgfQogIC8qKgogICAqIFN0b3BzIGFuIGFjdGl2ZSBhdXRvIHJlZnJlc2ggcHJvY2VzcyBydW5uaW5nIGluIHRoZSBiYWNrZ3JvdW5kIChpZiBhbnkpLgogICAqCiAgICogSWYgeW91IGNhbGwgdGhpcyBtZXRob2QgYW55IG1hbmFnZWQgdmlzaWJpbGl0eSBjaGFuZ2UgY2FsbGJhY2sgd2lsbCBiZQogICAqIHJlbW92ZWQgYW5kIHlvdSBtdXN0IG1hbmFnZSB2aXNpYmlsaXR5IGNoYW5nZXMgb24geW91ciBvd24uCiAgICoKICAgKiBTZWUge0BsaW5rICNzdGFydEF1dG9SZWZyZXNofSBmb3IgbW9yZSBkZXRhaWxzLgogICAqLwogIGFzeW5jIHN0b3BBdXRvUmVmcmVzaCgpIHsKICAgIHRoaXMuX3JlbW92ZVZpc2liaWxpdHlDaGFuZ2VkQ2FsbGJhY2soKTsKICAgIGF3YWl0IHRoaXMuX3N0b3BBdXRvUmVmcmVzaCgpOwogIH0KICAvKioKICAgKiBSdW5zIHRoZSBhdXRvIHJlZnJlc2ggdG9rZW4gdGljay4KICAgKi8KICBhc3luYyBfYXV0b1JlZnJlc2hUb2tlblRpY2soKSB7CiAgICB0aGlzLl9kZWJ1ZygiI19hdXRvUmVmcmVzaFRva2VuVGljaygpIiwgImJlZ2luIik7CiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9hY3F1aXJlTG9jaygwLCBhc3luYyAoKSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fdXNlU2Vzc2lvbihhc3luYyAocmVzdWx0KSA9PiB7CiAgICAgICAgICAgICAgY29uc3QgeyBkYXRhOiB7IHNlc3Npb24gfSB9ID0gcmVzdWx0OwogICAgICAgICAgICAgIGlmICghc2Vzc2lvbiB8fCAhc2Vzc2lvbi5yZWZyZXNoX3Rva2VuIHx8ICFzZXNzaW9uLmV4cGlyZXNfYXQpIHsKICAgICAgICAgICAgICAgIHRoaXMuX2RlYnVnKCIjX2F1dG9SZWZyZXNoVG9rZW5UaWNrKCkiLCAibm8gc2Vzc2lvbiIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zdCBleHBpcmVzSW5UaWNrcyA9IE1hdGguZmxvb3IoKHNlc3Npb24uZXhwaXJlc19hdCAqIDFlMyAtIG5vdykgLyBBVVRPX1JFRlJFU0hfVElDS19EVVJBVElPTl9NUyk7CiAgICAgICAgICAgICAgdGhpcy5fZGVidWcoIiNfYXV0b1JlZnJlc2hUb2tlblRpY2soKSIsIGBhY2Nlc3MgdG9rZW4gZXhwaXJlcyBpbiAke2V4cGlyZXNJblRpY2tzfSB0aWNrcywgYSB0aWNrIGxhc3RzICR7QVVUT19SRUZSRVNIX1RJQ0tfRFVSQVRJT05fTVN9bXMsIHJlZnJlc2ggdGhyZXNob2xkIGlzICR7QVVUT19SRUZSRVNIX1RJQ0tfVEhSRVNIT0xEfSB0aWNrc2ApOwogICAgICAgICAgICAgIGlmIChleHBpcmVzSW5UaWNrcyA8PSBBVVRPX1JFRlJFU0hfVElDS19USFJFU0hPTEQpIHsKICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX2NhbGxSZWZyZXNoVG9rZW4oc2Vzc2lvbi5yZWZyZXNoX3Rva2VuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCJBdXRvIHJlZnJlc2ggdGljayBmYWlsZWQgd2l0aCBlcnJvci4gVGhpcyBpcyBsaWtlbHkgYSB0cmFuc2llbnQgZXJyb3IuIiwgZSk7CiAgICAgICAgICB9CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIHRoaXMuX2RlYnVnKCIjX2F1dG9SZWZyZXNoVG9rZW5UaWNrKCkiLCAiZW5kIik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaWYgKGUuaXNBY3F1aXJlVGltZW91dCB8fCBlIGluc3RhbmNlb2YgTG9ja0FjcXVpcmVUaW1lb3V0RXJyb3IpIHsKICAgICAgICB0aGlzLl9kZWJ1ZygiYXV0byByZWZyZXNoIHRva2VuIHRpY2sgbG9jayBub3QgYXZhaWxhYmxlIik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgZTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBSZWdpc3RlcnMgY2FsbGJhY2tzIG9uIHRoZSBicm93c2VyIC8gcGxhdGZvcm0sIHdoaWNoIGluLXR1cm4gcnVuCiAgICogYWxnb3JpdGhtcyB3aGVuIHRoZSBicm93c2VyIHdpbmRvdy90YWIgYXJlIGluIGZvcmVncm91bmQuIE9uIG5vbi1icm93c2VyCiAgICogcGxhdGZvcm1zIGl0IGFzc3VtZXMgYWx3YXlzIGZvcmVncm91bmQuCiAgICovCiAgYXN5bmMgX2hhbmRsZVZpc2liaWxpdHlDaGFuZ2UoKSB7CiAgICB0aGlzLl9kZWJ1ZygiI19oYW5kbGVWaXNpYmlsaXR5Q2hhbmdlKCkiKTsKICAgIGlmICghaXNCcm93c2VyKCkgfHwgISh3aW5kb3cgPT09IG51bGwgfHwgd2luZG93ID09PSB2b2lkIDAgPyB2b2lkIDAgOiB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcikpIHsKICAgICAgaWYgKHRoaXMuYXV0b1JlZnJlc2hUb2tlbikgewogICAgICAgIHRoaXMuc3RhcnRBdXRvUmVmcmVzaCgpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHRyeSB7CiAgICAgIHRoaXMudmlzaWJpbGl0eUNoYW5nZWRDYWxsYmFjayA9IGFzeW5jICgpID0+IHsKICAgICAgICB0cnkgewogICAgICAgICAgYXdhaXQgdGhpcy5fb25WaXNpYmlsaXR5Q2hhbmdlZChmYWxzZSk7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgIHRoaXMuX2RlYnVnKCIjdmlzaWJpbGl0eUNoYW5nZWRDYWxsYmFjayIsICJlcnJvciIsIGVycm9yKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHdpbmRvdyA9PT0gbnVsbCB8fCB3aW5kb3cgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ2aXNpYmlsaXR5Y2hhbmdlIiwgdGhpcy52aXNpYmlsaXR5Q2hhbmdlZENhbGxiYWNrKTsKICAgICAgYXdhaXQgdGhpcy5fb25WaXNpYmlsaXR5Q2hhbmdlZCh0cnVlKTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIl9oYW5kbGVWaXNpYmlsaXR5Q2hhbmdlIiwgZXJyb3IpOwogICAgfQogIH0KICAvKioKICAgKiBDYWxsYmFjayByZWdpc3RlcmVkIHdpdGggYHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd2aXNpYmlsaXR5Y2hhbmdlJylgLgogICAqLwogIGFzeW5jIF9vblZpc2liaWxpdHlDaGFuZ2VkKGNhbGxlZEZyb21Jbml0aWFsaXplKSB7CiAgICBjb25zdCBtZXRob2ROYW1lID0gYCNfb25WaXNpYmlsaXR5Q2hhbmdlZCgke2NhbGxlZEZyb21Jbml0aWFsaXplfSlgOwogICAgdGhpcy5fZGVidWcobWV0aG9kTmFtZSwgInZpc2liaWxpdHlTdGF0ZSIsIGRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZSk7CiAgICBpZiAoZG9jdW1lbnQudmlzaWJpbGl0eVN0YXRlID09PSAidmlzaWJsZSIpIHsKICAgICAgaWYgKHRoaXMuYXV0b1JlZnJlc2hUb2tlbikgewogICAgICAgIHRoaXMuX3N0YXJ0QXV0b1JlZnJlc2goKTsKICAgICAgfQogICAgICBpZiAoIWNhbGxlZEZyb21Jbml0aWFsaXplKSB7CiAgICAgICAgYXdhaXQgdGhpcy5pbml0aWFsaXplUHJvbWlzZTsKICAgICAgICBhd2FpdCB0aGlzLl9hY3F1aXJlTG9jayh0aGlzLmxvY2tBY3F1aXJlVGltZW91dCwgYXN5bmMgKCkgPT4gewogICAgICAgICAgaWYgKGRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZSAhPT0gInZpc2libGUiKSB7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnKG1ldGhvZE5hbWUsICJhY3F1aXJlZCB0aGUgbG9jayB0byByZWNvdmVyIHRoZSBzZXNzaW9uLCBidXQgdGhlIGJyb3dzZXIgdmlzaWJpbGl0eVN0YXRlIGlzIG5vIGxvbmdlciB2aXNpYmxlLCBhYm9ydGluZyIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBhd2FpdCB0aGlzLl9yZWNvdmVyQW5kUmVmcmVzaCgpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZSA9PT0gImhpZGRlbiIpIHsKICAgICAgaWYgKHRoaXMuYXV0b1JlZnJlc2hUb2tlbikgewogICAgICAgIHRoaXMuX3N0b3BBdXRvUmVmcmVzaCgpOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIEdlbmVyYXRlcyB0aGUgcmVsZXZhbnQgbG9naW4gVVJMIGZvciBhIHRoaXJkLXBhcnR5IHByb3ZpZGVyLgogICAqIEBwYXJhbSBvcHRpb25zLnJlZGlyZWN0VG8gQSBVUkwgb3IgbW9iaWxlIGFkZHJlc3MgdG8gc2VuZCB0aGUgdXNlciB0byBhZnRlciB0aGV5IGFyZSBjb25maXJtZWQuCiAgICogQHBhcmFtIG9wdGlvbnMuc2NvcGVzIEEgc3BhY2Utc2VwYXJhdGVkIGxpc3Qgb2Ygc2NvcGVzIGdyYW50ZWQgdG8gdGhlIE9BdXRoIGFwcGxpY2F0aW9uLgogICAqIEBwYXJhbSBvcHRpb25zLnF1ZXJ5UGFyYW1zIEFuIG9iamVjdCBvZiBrZXktdmFsdWUgcGFpcnMgY29udGFpbmluZyBxdWVyeSBwYXJhbWV0ZXJzIGdyYW50ZWQgdG8gdGhlIE9BdXRoIGFwcGxpY2F0aW9uLgogICAqLwogIGFzeW5jIF9nZXRVcmxGb3JQcm92aWRlcih1cmwsIHByb3ZpZGVyLCBvcHRpb25zKSB7CiAgICBjb25zdCB1cmxQYXJhbXMgPSBbYHByb3ZpZGVyPSR7ZW5jb2RlVVJJQ29tcG9uZW50KHByb3ZpZGVyKX1gXTsKICAgIGlmIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMucmVkaXJlY3RUbykgewogICAgICB1cmxQYXJhbXMucHVzaChgcmVkaXJlY3RfdG89JHtlbmNvZGVVUklDb21wb25lbnQob3B0aW9ucy5yZWRpcmVjdFRvKX1gKTsKICAgIH0KICAgIGlmIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc2NvcGVzKSB7CiAgICAgIHVybFBhcmFtcy5wdXNoKGBzY29wZXM9JHtlbmNvZGVVUklDb21wb25lbnQob3B0aW9ucy5zY29wZXMpfWApOwogICAgfQogICAgaWYgKHRoaXMuZmxvd1R5cGUgPT09ICJwa2NlIikgewogICAgICBjb25zdCBbY29kZUNoYWxsZW5nZSwgY29kZUNoYWxsZW5nZU1ldGhvZF0gPSBhd2FpdCBnZXRDb2RlQ2hhbGxlbmdlQW5kTWV0aG9kKHRoaXMuc3RvcmFnZSwgdGhpcy5zdG9yYWdlS2V5KTsKICAgICAgY29uc3QgZmxvd1BhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMoewogICAgICAgIGNvZGVfY2hhbGxlbmdlOiBgJHtlbmNvZGVVUklDb21wb25lbnQoY29kZUNoYWxsZW5nZSl9YCwKICAgICAgICBjb2RlX2NoYWxsZW5nZV9tZXRob2Q6IGAke2VuY29kZVVSSUNvbXBvbmVudChjb2RlQ2hhbGxlbmdlTWV0aG9kKX1gCiAgICAgIH0pOwogICAgICB1cmxQYXJhbXMucHVzaChmbG93UGFyYW1zLnRvU3RyaW5nKCkpOwogICAgfQogICAgaWYgKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5xdWVyeVBhcmFtcykgewogICAgICBjb25zdCBxdWVyeSA9IG5ldyBVUkxTZWFyY2hQYXJhbXMob3B0aW9ucy5xdWVyeVBhcmFtcyk7CiAgICAgIHVybFBhcmFtcy5wdXNoKHF1ZXJ5LnRvU3RyaW5nKCkpOwogICAgfQogICAgaWYgKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5za2lwQnJvd3NlclJlZGlyZWN0KSB7CiAgICAgIHVybFBhcmFtcy5wdXNoKGBza2lwX2h0dHBfcmVkaXJlY3Q9JHtvcHRpb25zLnNraXBCcm93c2VyUmVkaXJlY3R9YCk7CiAgICB9CiAgICByZXR1cm4gYCR7dXJsfT8ke3VybFBhcmFtcy5qb2luKCImIil9YDsKICB9CiAgYXN5bmMgX3VuZW5yb2xsKHBhcmFtcykgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3VzZVNlc3Npb24oYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICAgIHZhciBfYTsKICAgICAgICBjb25zdCB7IGRhdGE6IHNlc3Npb25EYXRhLCBlcnJvcjogc2Vzc2lvbkVycm9yIH0gPSByZXN1bHQ7CiAgICAgICAgaWYgKHNlc3Npb25FcnJvcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yOiBzZXNzaW9uRXJyb3IgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiREVMRVRFIiwgYCR7dGhpcy51cmx9L2ZhY3RvcnMvJHtwYXJhbXMuZmFjdG9ySWR9YCwgewogICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgand0OiAoX2EgPSBzZXNzaW9uRGF0YSA9PT0gbnVsbCB8fCBzZXNzaW9uRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2Vzc2lvbkRhdGEuc2Vzc2lvbikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmFjY2Vzc190b2tlbgogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIGFzeW5jIF9lbnJvbGwocGFyYW1zKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fdXNlU2Vzc2lvbihhc3luYyAocmVzdWx0KSA9PiB7CiAgICAgICAgdmFyIF9hLCBfYjsKICAgICAgICBjb25zdCB7IGRhdGE6IHNlc3Npb25EYXRhLCBlcnJvcjogc2Vzc2lvbkVycm9yIH0gPSByZXN1bHQ7CiAgICAgICAgaWYgKHNlc3Npb25FcnJvcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yOiBzZXNzaW9uRXJyb3IgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJvZHkgPSBPYmplY3QuYXNzaWduKHsgZnJpZW5kbHlfbmFtZTogcGFyYW1zLmZyaWVuZGx5TmFtZSwgZmFjdG9yX3R5cGU6IHBhcmFtcy5mYWN0b3JUeXBlIH0sIHBhcmFtcy5mYWN0b3JUeXBlID09PSAicGhvbmUiID8geyBwaG9uZTogcGFyYW1zLnBob25lIH0gOiBwYXJhbXMuZmFjdG9yVHlwZSA9PT0gInRvdHAiID8geyBpc3N1ZXI6IHBhcmFtcy5pc3N1ZXIgfSA6IHt9KTsKICAgICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGAke3RoaXMudXJsfS9mYWN0b3JzYCwgewogICAgICAgICAgYm9keSwKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGp3dDogKF9hID0gc2Vzc2lvbkRhdGEgPT09IG51bGwgfHwgc2Vzc2lvbkRhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNlc3Npb25EYXRhLnNlc3Npb24pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5hY2Nlc3NfdG9rZW4KICAgICAgICB9KTsKICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvciB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKHBhcmFtcy5mYWN0b3JUeXBlID09PSAidG90cCIgJiYgZGF0YS50eXBlID09PSAidG90cCIgJiYgKChfYiA9IGRhdGEgPT09IG51bGwgfHwgZGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YS50b3RwKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IucXJfY29kZSkpIHsKICAgICAgICAgIGRhdGEudG90cC5xcl9jb2RlID0gYGRhdGE6aW1hZ2Uvc3ZnK3htbDt1dGYtOCwke2RhdGEudG90cC5xcl9jb2RlfWA7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhLCBlcnJvcjogbnVsbCB9KTsKICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICBhc3luYyBfdmVyaWZ5KHBhcmFtcykgewogICAgcmV0dXJuIHRoaXMuX2FjcXVpcmVMb2NrKHRoaXMubG9ja0FjcXVpcmVUaW1lb3V0LCBhc3luYyAoKSA9PiB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3VzZVNlc3Npb24oYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICAgICAgdmFyIF9hOwogICAgICAgICAgY29uc3QgeyBkYXRhOiBzZXNzaW9uRGF0YSwgZXJyb3I6IHNlc3Npb25FcnJvciB9ID0gcmVzdWx0OwogICAgICAgICAgaWYgKHNlc3Npb25FcnJvcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3I6IHNlc3Npb25FcnJvciB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGJvZHkgPSBPYmplY3QuYXNzaWduKHsgY2hhbGxlbmdlX2lkOiBwYXJhbXMuY2hhbGxlbmdlSWQgfSwgIndlYmF1dGhuIiBpbiBwYXJhbXMgPyB7CiAgICAgICAgICAgIHdlYmF1dGhuOiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHBhcmFtcy53ZWJhdXRobiksIHsgY3JlZGVudGlhbF9yZXNwb25zZTogcGFyYW1zLndlYmF1dGhuLnR5cGUgPT09ICJjcmVhdGUiID8gc2VyaWFsaXplQ3JlZGVudGlhbENyZWF0aW9uUmVzcG9uc2UocGFyYW1zLndlYmF1dGhuLmNyZWRlbnRpYWxfcmVzcG9uc2UpIDogc2VyaWFsaXplQ3JlZGVudGlhbFJlcXVlc3RSZXNwb25zZShwYXJhbXMud2ViYXV0aG4uY3JlZGVudGlhbF9yZXNwb25zZSkgfSkKICAgICAgICAgIH0gOiB7IGNvZGU6IHBhcmFtcy5jb2RlIH0pOwogICAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vZmFjdG9ycy8ke3BhcmFtcy5mYWN0b3JJZH0vdmVyaWZ5YCwgewogICAgICAgICAgICBib2R5LAogICAgICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgICAgIGp3dDogKF9hID0gc2Vzc2lvbkRhdGEgPT09IG51bGwgfHwgc2Vzc2lvbkRhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNlc3Npb25EYXRhLnNlc3Npb24pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5hY2Nlc3NfdG9rZW4KICAgICAgICAgIH0pOwogICAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvciB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGF3YWl0IHRoaXMuX3NhdmVTZXNzaW9uKE9iamVjdC5hc3NpZ24oeyBleHBpcmVzX2F0OiBNYXRoLnJvdW5kKERhdGUubm93KCkgLyAxZTMpICsgZGF0YS5leHBpcmVzX2luIH0sIGRhdGEpKTsKICAgICAgICAgIGF3YWl0IHRoaXMuX25vdGlmeUFsbFN1YnNjcmliZXJzKCJNRkFfQ0hBTExFTkdFX1ZFUklGSUVEIiwgZGF0YSk7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YSwgZXJyb3IgfSk7CiAgICAgICAgfSk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yIH0pOwogICAgICAgIH0KICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgfSk7CiAgfQogIGFzeW5jIF9jaGFsbGVuZ2UocGFyYW1zKSB7CiAgICByZXR1cm4gdGhpcy5fYWNxdWlyZUxvY2sodGhpcy5sb2NrQWNxdWlyZVRpbWVvdXQsIGFzeW5jICgpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fdXNlU2Vzc2lvbihhc3luYyAocmVzdWx0KSA9PiB7CiAgICAgICAgICB2YXIgX2E7CiAgICAgICAgICBjb25zdCB7IGRhdGE6IHNlc3Npb25EYXRhLCBlcnJvcjogc2Vzc2lvbkVycm9yIH0gPSByZXN1bHQ7CiAgICAgICAgICBpZiAoc2Vzc2lvbkVycm9yKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvcjogc2Vzc2lvbkVycm9yIH0pOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGAke3RoaXMudXJsfS9mYWN0b3JzLyR7cGFyYW1zLmZhY3RvcklkfS9jaGFsbGVuZ2VgLCB7CiAgICAgICAgICAgIGJvZHk6IHBhcmFtcywKICAgICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgICBqd3Q6IChfYSA9IHNlc3Npb25EYXRhID09PSBudWxsIHx8IHNlc3Npb25EYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXNzaW9uRGF0YS5zZXNzaW9uKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuYWNjZXNzX3Rva2VuCiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChyZXNwb25zZS5lcnJvcikgewogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCB7IGRhdGEgfSA9IHJlc3BvbnNlOwogICAgICAgICAgaWYgKGRhdGEudHlwZSAhPT0gIndlYmF1dGhuIikgewogICAgICAgICAgICByZXR1cm4geyBkYXRhLCBlcnJvcjogbnVsbCB9OwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoIChkYXRhLndlYmF1dGhuLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSAiY3JlYXRlIjoKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgZGF0YTogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBkYXRhKSwgeyB3ZWJhdXRobjogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBkYXRhLndlYmF1dGhuKSwgeyBjcmVkZW50aWFsX29wdGlvbnM6IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgZGF0YS53ZWJhdXRobi5jcmVkZW50aWFsX29wdGlvbnMpLCB7IHB1YmxpY0tleTogZGVzZXJpYWxpemVDcmVkZW50aWFsQ3JlYXRpb25PcHRpb25zKGRhdGEud2ViYXV0aG4uY3JlZGVudGlhbF9vcHRpb25zLnB1YmxpY0tleSkgfSkgfSkgfSksCiAgICAgICAgICAgICAgICBlcnJvcjogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNhc2UgInJlcXVlc3QiOgogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBkYXRhOiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIGRhdGEpLCB7IHdlYmF1dGhuOiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIGRhdGEud2ViYXV0aG4pLCB7IGNyZWRlbnRpYWxfb3B0aW9uczogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBkYXRhLndlYmF1dGhuLmNyZWRlbnRpYWxfb3B0aW9ucyksIHsgcHVibGljS2V5OiBkZXNlcmlhbGl6ZUNyZWRlbnRpYWxSZXF1ZXN0T3B0aW9ucyhkYXRhLndlYmF1dGhuLmNyZWRlbnRpYWxfb3B0aW9ucy5wdWJsaWNLZXkpIH0pIH0pIH0pLAogICAgICAgICAgICAgICAgZXJyb3I6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvciB9KTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0KICAgIH0pOwogIH0KICAvKioKICAgKiB7QHNlZSBHb1RydWVNRkFBcGkjY2hhbGxlbmdlQW5kVmVyaWZ5fQogICAqLwogIGFzeW5jIF9jaGFsbGVuZ2VBbmRWZXJpZnkocGFyYW1zKSB7CiAgICBjb25zdCB7IGRhdGE6IGNoYWxsZW5nZURhdGEsIGVycm9yOiBjaGFsbGVuZ2VFcnJvciB9ID0gYXdhaXQgdGhpcy5fY2hhbGxlbmdlKHsKICAgICAgZmFjdG9ySWQ6IHBhcmFtcy5mYWN0b3JJZAogICAgfSk7CiAgICBpZiAoY2hhbGxlbmdlRXJyb3IpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yOiBjaGFsbGVuZ2VFcnJvciB9KTsKICAgIH0KICAgIHJldHVybiBhd2FpdCB0aGlzLl92ZXJpZnkoewogICAgICBmYWN0b3JJZDogcGFyYW1zLmZhY3RvcklkLAogICAgICBjaGFsbGVuZ2VJZDogY2hhbGxlbmdlRGF0YS5pZCwKICAgICAgY29kZTogcGFyYW1zLmNvZGUKICAgIH0pOwogIH0KICAvKioKICAgKiB7QHNlZSBHb1RydWVNRkFBcGkjbGlzdEZhY3RvcnN9CiAgICovCiAgYXN5bmMgX2xpc3RGYWN0b3JzKCkgewogICAgdmFyIF9hOwogICAgY29uc3QgeyBkYXRhOiB7IHVzZXIgfSwgZXJyb3I6IHVzZXJFcnJvciB9ID0gYXdhaXQgdGhpcy5nZXRVc2VyKCk7CiAgICBpZiAodXNlckVycm9yKSB7CiAgICAgIHJldHVybiB7IGRhdGE6IG51bGwsIGVycm9yOiB1c2VyRXJyb3IgfTsKICAgIH0KICAgIGNvbnN0IGRhdGEgPSB7CiAgICAgIGFsbDogW10sCiAgICAgIHBob25lOiBbXSwKICAgICAgdG90cDogW10sCiAgICAgIHdlYmF1dGhuOiBbXQogICAgfTsKICAgIGZvciAoY29uc3QgZmFjdG9yIG9mIChfYSA9IHVzZXIgPT09IG51bGwgfHwgdXNlciA9PT0gdm9pZCAwID8gdm9pZCAwIDogdXNlci5mYWN0b3JzKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBbXSkgewogICAgICBkYXRhLmFsbC5wdXNoKGZhY3Rvcik7CiAgICAgIGlmIChmYWN0b3Iuc3RhdHVzID09PSAidmVyaWZpZWQiKSB7CiAgICAgICAgOwogICAgICAgIGRhdGFbZmFjdG9yLmZhY3Rvcl90eXBlXS5wdXNoKGZhY3Rvcik7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgIGRhdGEsCiAgICAgIGVycm9yOiBudWxsCiAgICB9OwogIH0KICAvKioKICAgKiB7QHNlZSBHb1RydWVNRkFBcGkjZ2V0QXV0aGVudGljYXRvckFzc3VyYW5jZUxldmVsfQogICAqLwogIGFzeW5jIF9nZXRBdXRoZW50aWNhdG9yQXNzdXJhbmNlTGV2ZWwoand0KSB7CiAgICB2YXIgX2EsIF9iLCBfYywgX2Q7CiAgICBpZiAoand0KSB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgeyBwYXlsb2FkOiBwYXlsb2FkMiB9ID0gZGVjb2RlSldUKGp3dCk7CiAgICAgICAgbGV0IGN1cnJlbnRMZXZlbDIgPSBudWxsOwogICAgICAgIGlmIChwYXlsb2FkMi5hYWwpIHsKICAgICAgICAgIGN1cnJlbnRMZXZlbDIgPSBwYXlsb2FkMi5hYWw7CiAgICAgICAgfQogICAgICAgIGxldCBuZXh0TGV2ZWwyID0gY3VycmVudExldmVsMjsKICAgICAgICBjb25zdCB7IGRhdGE6IHsgdXNlciB9LCBlcnJvcjogdXNlckVycm9yIH0gPSBhd2FpdCB0aGlzLmdldFVzZXIoand0KTsKICAgICAgICBpZiAodXNlckVycm9yKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3I6IHVzZXJFcnJvciB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmVyaWZpZWRGYWN0b3JzMiA9IChfYiA9IChfYSA9IHVzZXIgPT09IG51bGwgfHwgdXNlciA9PT0gdm9pZCAwID8gdm9pZCAwIDogdXNlci5mYWN0b3JzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuZmlsdGVyKChmYWN0b3IpID0+IGZhY3Rvci5zdGF0dXMgPT09ICJ2ZXJpZmllZCIpKSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiBbXTsKICAgICAgICBpZiAodmVyaWZpZWRGYWN0b3JzMi5sZW5ndGggPiAwKSB7CiAgICAgICAgICBuZXh0TGV2ZWwyID0gImFhbDIiOwogICAgICAgIH0KICAgICAgICBjb25zdCBjdXJyZW50QXV0aGVudGljYXRpb25NZXRob2RzMiA9IHBheWxvYWQyLmFtciB8fCBbXTsKICAgICAgICByZXR1cm4geyBkYXRhOiB7IGN1cnJlbnRMZXZlbDogY3VycmVudExldmVsMiwgbmV4dExldmVsOiBuZXh0TGV2ZWwyLCBjdXJyZW50QXV0aGVudGljYXRpb25NZXRob2RzOiBjdXJyZW50QXV0aGVudGljYXRpb25NZXRob2RzMiB9LCBlcnJvcjogbnVsbCB9OwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvciB9KTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHsgZGF0YTogeyBzZXNzaW9uIH0sIGVycm9yOiBzZXNzaW9uRXJyb3IgfSA9IGF3YWl0IHRoaXMuZ2V0U2Vzc2lvbigpOwogICAgaWYgKHNlc3Npb25FcnJvcikgewogICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3I6IHNlc3Npb25FcnJvciB9KTsKICAgIH0KICAgIGlmICghc2Vzc2lvbikgewogICAgICByZXR1cm4gewogICAgICAgIGRhdGE6IHsgY3VycmVudExldmVsOiBudWxsLCBuZXh0TGV2ZWw6IG51bGwsIGN1cnJlbnRBdXRoZW50aWNhdGlvbk1ldGhvZHM6IFtdIH0sCiAgICAgICAgZXJyb3I6IG51bGwKICAgICAgfTsKICAgIH0KICAgIGNvbnN0IHsgcGF5bG9hZCB9ID0gZGVjb2RlSldUKHNlc3Npb24uYWNjZXNzX3Rva2VuKTsKICAgIGxldCBjdXJyZW50TGV2ZWwgPSBudWxsOwogICAgaWYgKHBheWxvYWQuYWFsKSB7CiAgICAgIGN1cnJlbnRMZXZlbCA9IHBheWxvYWQuYWFsOwogICAgfQogICAgbGV0IG5leHRMZXZlbCA9IGN1cnJlbnRMZXZlbDsKICAgIGNvbnN0IHZlcmlmaWVkRmFjdG9ycyA9IChfZCA9IChfYyA9IHNlc3Npb24udXNlci5mYWN0b3JzKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuZmlsdGVyKChmYWN0b3IpID0+IGZhY3Rvci5zdGF0dXMgPT09ICJ2ZXJpZmllZCIpKSAhPT0gbnVsbCAmJiBfZCAhPT0gdm9pZCAwID8gX2QgOiBbXTsKICAgIGlmICh2ZXJpZmllZEZhY3RvcnMubGVuZ3RoID4gMCkgewogICAgICBuZXh0TGV2ZWwgPSAiYWFsMiI7CiAgICB9CiAgICBjb25zdCBjdXJyZW50QXV0aGVudGljYXRpb25NZXRob2RzID0gcGF5bG9hZC5hbXIgfHwgW107CiAgICByZXR1cm4geyBkYXRhOiB7IGN1cnJlbnRMZXZlbCwgbmV4dExldmVsLCBjdXJyZW50QXV0aGVudGljYXRpb25NZXRob2RzIH0sIGVycm9yOiBudWxsIH07CiAgfQogIC8qKgogICAqIFJldHJpZXZlcyBkZXRhaWxzIGFib3V0IGFuIE9BdXRoIGF1dGhvcml6YXRpb24gcmVxdWVzdC4KICAgKiBPbmx5IHJlbGV2YW50IHdoZW4gdGhlIE9BdXRoIDIuMSBzZXJ2ZXIgaXMgZW5hYmxlZCBpbiBTdXBhYmFzZSBBdXRoLgogICAqCiAgICogUmV0dXJucyBhdXRob3JpemF0aW9uIGRldGFpbHMgaW5jbHVkaW5nIGNsaWVudCBpbmZvLCBzY29wZXMsIGFuZCB1c2VyIGluZm9ybWF0aW9uLgogICAqIElmIHRoZSByZXNwb25zZSBpbmNsdWRlcyBvbmx5IGEgcmVkaXJlY3RfdXJsIGZpZWxkLCBpdCBtZWFucyBjb25zZW50IHdhcyBhbHJlYWR5IGdpdmVuIC0gdGhlIGNhbGxlcgogICAqIHNob3VsZCBoYW5kbGUgdGhlIHJlZGlyZWN0IG1hbnVhbGx5IGlmIG5lZWRlZC4KICAgKi8KICBhc3luYyBfZ2V0QXV0aG9yaXphdGlvbkRldGFpbHMoYXV0aG9yaXphdGlvbklkKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fdXNlU2Vzc2lvbihhc3luYyAocmVzdWx0KSA9PiB7CiAgICAgICAgY29uc3QgeyBkYXRhOiB7IHNlc3Npb24gfSwgZXJyb3I6IHNlc3Npb25FcnJvciB9ID0gcmVzdWx0OwogICAgICAgIGlmIChzZXNzaW9uRXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvcjogc2Vzc2lvbkVycm9yIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoIXNlc3Npb24pIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvcjogbmV3IEF1dGhTZXNzaW9uTWlzc2luZ0Vycm9yKCkgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiR0VUIiwgYCR7dGhpcy51cmx9L29hdXRoL2F1dGhvcml6YXRpb25zLyR7YXV0aG9yaXphdGlvbklkfWAsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGp3dDogc2Vzc2lvbi5hY2Nlc3NfdG9rZW4sCiAgICAgICAgICB4Zm9ybTogKGRhdGEpID0+ICh7IGRhdGEsIGVycm9yOiBudWxsIH0pCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogQXBwcm92ZXMgYW4gT0F1dGggYXV0aG9yaXphdGlvbiByZXF1ZXN0LgogICAqIE9ubHkgcmVsZXZhbnQgd2hlbiB0aGUgT0F1dGggMi4xIHNlcnZlciBpcyBlbmFibGVkIGluIFN1cGFiYXNlIEF1dGguCiAgICovCiAgYXN5bmMgX2FwcHJvdmVBdXRob3JpemF0aW9uKGF1dGhvcml6YXRpb25JZCwgb3B0aW9ucykgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3VzZVNlc3Npb24oYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICAgIGNvbnN0IHsgZGF0YTogeyBzZXNzaW9uIH0sIGVycm9yOiBzZXNzaW9uRXJyb3IgfSA9IHJlc3VsdDsKICAgICAgICBpZiAoc2Vzc2lvbkVycm9yKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3I6IHNlc3Npb25FcnJvciB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKCFzZXNzaW9uKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3I6IG5ldyBBdXRoU2Vzc2lvbk1pc3NpbmdFcnJvcigpIH0pOwogICAgICAgIH0KICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L29hdXRoL2F1dGhvcml6YXRpb25zLyR7YXV0aG9yaXphdGlvbklkfS9jb25zZW50YCwgewogICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgand0OiBzZXNzaW9uLmFjY2Vzc190b2tlbiwKICAgICAgICAgIGJvZHk6IHsgYWN0aW9uOiAiYXBwcm92ZSIgfSwKICAgICAgICAgIHhmb3JtOiAoZGF0YSkgPT4gKHsgZGF0YSwgZXJyb3I6IG51bGwgfSkKICAgICAgICB9KTsKICAgICAgICBpZiAocmVzcG9uc2UuZGF0YSAmJiByZXNwb25zZS5kYXRhLnJlZGlyZWN0X3VybCkgewogICAgICAgICAgaWYgKGlzQnJvd3NlcigpICYmICEob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNraXBCcm93c2VyUmVkaXJlY3QpKSB7CiAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5hc3NpZ24ocmVzcG9uc2UuZGF0YS5yZWRpcmVjdF91cmwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogRGVuaWVzIGFuIE9BdXRoIGF1dGhvcml6YXRpb24gcmVxdWVzdC4KICAgKiBPbmx5IHJlbGV2YW50IHdoZW4gdGhlIE9BdXRoIDIuMSBzZXJ2ZXIgaXMgZW5hYmxlZCBpbiBTdXBhYmFzZSBBdXRoLgogICAqLwogIGFzeW5jIF9kZW55QXV0aG9yaXphdGlvbihhdXRob3JpemF0aW9uSWQsIG9wdGlvbnMpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl91c2VTZXNzaW9uKGFzeW5jIChyZXN1bHQpID0+IHsKICAgICAgICBjb25zdCB7IGRhdGE6IHsgc2Vzc2lvbiB9LCBlcnJvcjogc2Vzc2lvbkVycm9yIH0gPSByZXN1bHQ7CiAgICAgICAgaWYgKHNlc3Npb25FcnJvcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yOiBzZXNzaW9uRXJyb3IgfSk7CiAgICAgICAgfQogICAgICAgIGlmICghc2Vzc2lvbikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yOiBuZXcgQXV0aFNlc3Npb25NaXNzaW5nRXJyb3IoKSB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGAke3RoaXMudXJsfS9vYXV0aC9hdXRob3JpemF0aW9ucy8ke2F1dGhvcml6YXRpb25JZH0vY29uc2VudGAsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGp3dDogc2Vzc2lvbi5hY2Nlc3NfdG9rZW4sCiAgICAgICAgICBib2R5OiB7IGFjdGlvbjogImRlbnkiIH0sCiAgICAgICAgICB4Zm9ybTogKGRhdGEpID0+ICh7IGRhdGEsIGVycm9yOiBudWxsIH0pCiAgICAgICAgfSk7CiAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEgJiYgcmVzcG9uc2UuZGF0YS5yZWRpcmVjdF91cmwpIHsKICAgICAgICAgIGlmIChpc0Jyb3dzZXIoKSAmJiAhKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5za2lwQnJvd3NlclJlZGlyZWN0KSkgewogICAgICAgICAgICB3aW5kb3cubG9jYXRpb24uYXNzaWduKHJlc3BvbnNlLmRhdGEucmVkaXJlY3RfdXJsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIExpc3RzIGFsbCBPQXV0aCBncmFudHMgdGhhdCB0aGUgYXV0aGVudGljYXRlZCB1c2VyIGhhcyBhdXRob3JpemVkLgogICAqIE9ubHkgcmVsZXZhbnQgd2hlbiB0aGUgT0F1dGggMi4xIHNlcnZlciBpcyBlbmFibGVkIGluIFN1cGFiYXNlIEF1dGguCiAgICovCiAgYXN5bmMgX2xpc3RPQXV0aEdyYW50cygpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl91c2VTZXNzaW9uKGFzeW5jIChyZXN1bHQpID0+IHsKICAgICAgICBjb25zdCB7IGRhdGE6IHsgc2Vzc2lvbiB9LCBlcnJvcjogc2Vzc2lvbkVycm9yIH0gPSByZXN1bHQ7CiAgICAgICAgaWYgKHNlc3Npb25FcnJvcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yOiBzZXNzaW9uRXJyb3IgfSk7CiAgICAgICAgfQogICAgICAgIGlmICghc2Vzc2lvbikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yOiBuZXcgQXV0aFNlc3Npb25NaXNzaW5nRXJyb3IoKSB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJHRVQiLCBgJHt0aGlzLnVybH0vdXNlci9vYXV0aC9ncmFudHNgLCB7CiAgICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgICBqd3Q6IHNlc3Npb24uYWNjZXNzX3Rva2VuLAogICAgICAgICAgeGZvcm06IChkYXRhKSA9PiAoeyBkYXRhLCBlcnJvcjogbnVsbCB9KQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIFJldm9rZXMgYSB1c2VyJ3MgT0F1dGggZ3JhbnQgZm9yIGEgc3BlY2lmaWMgY2xpZW50LgogICAqIE9ubHkgcmVsZXZhbnQgd2hlbiB0aGUgT0F1dGggMi4xIHNlcnZlciBpcyBlbmFibGVkIGluIFN1cGFiYXNlIEF1dGguCiAgICovCiAgYXN5bmMgX3Jldm9rZU9BdXRoR3JhbnQob3B0aW9ucykgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3VzZVNlc3Npb24oYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICAgIGNvbnN0IHsgZGF0YTogeyBzZXNzaW9uIH0sIGVycm9yOiBzZXNzaW9uRXJyb3IgfSA9IHJlc3VsdDsKICAgICAgICBpZiAoc2Vzc2lvbkVycm9yKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3I6IHNlc3Npb25FcnJvciB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKCFzZXNzaW9uKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3I6IG5ldyBBdXRoU2Vzc2lvbk1pc3NpbmdFcnJvcigpIH0pOwogICAgICAgIH0KICAgICAgICBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiREVMRVRFIiwgYCR7dGhpcy51cmx9L3VzZXIvb2F1dGgvZ3JhbnRzYCwgewogICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgand0OiBzZXNzaW9uLmFjY2Vzc190b2tlbiwKICAgICAgICAgIHF1ZXJ5OiB7IGNsaWVudF9pZDogb3B0aW9ucy5jbGllbnRJZCB9LAogICAgICAgICAgbm9SZXNvbHZlSnNvbjogdHJ1ZQogICAgICAgIH0pOwogICAgICAgIHJldHVybiB7IGRhdGE6IHt9LCBlcnJvcjogbnVsbCB9OwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIGFzeW5jIGZldGNoSndrKGtpZCwgandrcyA9IHsga2V5czogW10gfSkgewogICAgbGV0IGp3ayA9IGp3a3Mua2V5cy5maW5kKChrZXkpID0+IGtleS5raWQgPT09IGtpZCk7CiAgICBpZiAoandrKSB7CiAgICAgIHJldHVybiBqd2s7CiAgICB9CiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOwogICAgandrID0gdGhpcy5qd2tzLmtleXMuZmluZCgoa2V5KSA9PiBrZXkua2lkID09PSBraWQpOwogICAgaWYgKGp3ayAmJiB0aGlzLmp3a3NfY2FjaGVkX2F0ICsgSldLU19UVEwgPiBub3cpIHsKICAgICAgcmV0dXJuIGp3azsKICAgIH0KICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJHRVQiLCBgJHt0aGlzLnVybH0vLndlbGwta25vd24vandrcy5qc29uYCwgewogICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMKICAgIH0pOwogICAgaWYgKGVycm9yKSB7CiAgICAgIHRocm93IGVycm9yOwogICAgfQogICAgaWYgKCFkYXRhLmtleXMgfHwgZGF0YS5rZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHRoaXMuandrcyA9IGRhdGE7CiAgICB0aGlzLmp3a3NfY2FjaGVkX2F0ID0gbm93OwogICAgandrID0gZGF0YS5rZXlzLmZpbmQoKGtleSkgPT4ga2V5LmtpZCA9PT0ga2lkKTsKICAgIGlmICghandrKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgcmV0dXJuIGp3azsKICB9CiAgLyoqCiAgICogRXh0cmFjdHMgdGhlIEpXVCBjbGFpbXMgcHJlc2VudCBpbiB0aGUgYWNjZXNzIHRva2VuIGJ5IGZpcnN0IHZlcmlmeWluZyB0aGUKICAgKiBKV1QgYWdhaW5zdCB0aGUgc2VydmVyJ3MgSlNPTiBXZWIgS2V5IFNldCBlbmRwb2ludAogICAqIGAvLndlbGwta25vd24vandrcy5qc29uYCB3aGljaCBpcyBvZnRlbiBjYWNoZWQsIHJlc3VsdGluZyBpbiBzaWduaWZpY2FudGx5CiAgICogZmFzdGVyIHJlc3BvbnNlcy4gUHJlZmVyIHRoaXMgbWV0aG9kIG92ZXIge0BsaW5rICNnZXRVc2VyfSB3aGljaCBhbHdheXMKICAgKiBzZW5kcyBhIHJlcXVlc3QgdG8gdGhlIEF1dGggc2VydmVyIGZvciBlYWNoIEpXVC4KICAgKgogICAqIElmIHRoZSBwcm9qZWN0IGlzIG5vdCB1c2luZyBhbiBhc3ltbWV0cmljIEpXVCBzaWduaW5nIGtleSAobGlrZSBFQ0Mgb3IKICAgKiBSU0EpIGl0IGFsd2F5cyBzZW5kcyBhIHJlcXVlc3QgdG8gdGhlIEF1dGggc2VydmVyIChzaW1pbGFyIHRvIHtAbGluawogICAqICNnZXRVc2VyfSkgdG8gdmVyaWZ5IHRoZSBKV1QuCiAgICoKICAgKiBAcGFyYW0gand0IEFuIG9wdGlvbmFsIHNwZWNpZmljIEpXVCB5b3Ugd2lzaCB0byB2ZXJpZnksIG5vdCB0aGUgb25lIHlvdQogICAqICAgICAgICAgICAgY2FuIG9idGFpbiBmcm9tIHtAbGluayAjZ2V0U2Vzc2lvbn0uCiAgICogQHBhcmFtIG9wdGlvbnMgVmFyaW91cyBhZGRpdGlvbmFsIG9wdGlvbnMgdGhhdCBhbGxvdyB5b3UgdG8gY3VzdG9taXplIHRoZQogICAqICAgICAgICAgICAgICAgIGJlaGF2aW9yIG9mIHRoaXMgbWV0aG9kLgogICAqLwogIGFzeW5jIGdldENsYWltcyhqd3QsIG9wdGlvbnMgPSB7fSkgewogICAgdHJ5IHsKICAgICAgbGV0IHRva2VuID0gand0OwogICAgICBpZiAoIXRva2VuKSB7CiAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgdGhpcy5nZXRTZXNzaW9uKCk7CiAgICAgICAgaWYgKGVycm9yIHx8ICFkYXRhLnNlc3Npb24pIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvciB9KTsKICAgICAgICB9CiAgICAgICAgdG9rZW4gPSBkYXRhLnNlc3Npb24uYWNjZXNzX3Rva2VuOwogICAgICB9CiAgICAgIGNvbnN0IHsgaGVhZGVyLCBwYXlsb2FkLCBzaWduYXR1cmUsIHJhdzogeyBoZWFkZXI6IHJhd0hlYWRlciwgcGF5bG9hZDogcmF3UGF5bG9hZCB9IH0gPSBkZWNvZGVKV1QodG9rZW4pOwogICAgICBpZiAoIShvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuYWxsb3dFeHBpcmVkKSkgewogICAgICAgIHZhbGlkYXRlRXhwKHBheWxvYWQuZXhwKTsKICAgICAgfQogICAgICBjb25zdCBzaWduaW5nS2V5ID0gIWhlYWRlci5hbGcgfHwgaGVhZGVyLmFsZy5zdGFydHNXaXRoKCJIUyIpIHx8ICFoZWFkZXIua2lkIHx8ICEoImNyeXB0byIgaW4gZ2xvYmFsVGhpcyAmJiAic3VidGxlIiBpbiBnbG9iYWxUaGlzLmNyeXB0bykgPyBudWxsIDogYXdhaXQgdGhpcy5mZXRjaEp3ayhoZWFkZXIua2lkLCAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmtleXMpID8geyBrZXlzOiBvcHRpb25zLmtleXMgfSA6IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5qd2tzKTsKICAgICAgaWYgKCFzaWduaW5nS2V5KSB7CiAgICAgICAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgdGhpcy5nZXRVc2VyKHRva2VuKTsKICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0KICAgICAgICByZXR1cm4gewogICAgICAgICAgZGF0YTogewogICAgICAgICAgICBjbGFpbXM6IHBheWxvYWQsCiAgICAgICAgICAgIGhlYWRlciwKICAgICAgICAgICAgc2lnbmF0dXJlCiAgICAgICAgICB9LAogICAgICAgICAgZXJyb3I6IG51bGwKICAgICAgICB9OwogICAgICB9CiAgICAgIGNvbnN0IGFsZ29yaXRobSA9IGdldEFsZ29yaXRobShoZWFkZXIuYWxnKTsKICAgICAgY29uc3QgcHVibGljS2V5ID0gYXdhaXQgY3J5cHRvLnN1YnRsZS5pbXBvcnRLZXkoImp3ayIsIHNpZ25pbmdLZXksIGFsZ29yaXRobSwgdHJ1ZSwgWwogICAgICAgICJ2ZXJpZnkiCiAgICAgIF0pOwogICAgICBjb25zdCBpc1ZhbGlkID0gYXdhaXQgY3J5cHRvLnN1YnRsZS52ZXJpZnkoYWxnb3JpdGhtLCBwdWJsaWNLZXksIHNpZ25hdHVyZSwgc3RyaW5nVG9VaW50OEFycmF5KGAke3Jhd0hlYWRlcn0uJHtyYXdQYXlsb2FkfWApKTsKICAgICAgaWYgKCFpc1ZhbGlkKSB7CiAgICAgICAgdGhyb3cgbmV3IEF1dGhJbnZhbGlkSnd0RXJyb3IoIkludmFsaWQgSldUIHNpZ25hdHVyZSIpOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgZGF0YTogewogICAgICAgICAgY2xhaW1zOiBwYXlsb2FkLAogICAgICAgICAgaGVhZGVyLAogICAgICAgICAgc2lnbmF0dXJlCiAgICAgICAgfSwKICAgICAgICBlcnJvcjogbnVsbAogICAgICB9OwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9Cn07CkdvVHJ1ZUNsaWVudC5uZXh0SW5zdGFuY2VJRCA9IHt9Owp2YXIgR29UcnVlQ2xpZW50X2RlZmF1bHQgPSBHb1RydWVDbGllbnQ7CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK2F1dGgtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvYXV0aC1qcy9kaXN0L21vZHVsZS9BdXRoQ2xpZW50LmpzCnZhciBBdXRoQ2xpZW50ID0gR29UcnVlQ2xpZW50X2RlZmF1bHQ7CnZhciBBdXRoQ2xpZW50X2RlZmF1bHQgPSBBdXRoQ2xpZW50OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZStzdXBhYmFzZS1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9zdXBhYmFzZS1qcy9kaXN0L2luZGV4Lm1qcwp2YXIgdmVyc2lvbjUgPSAiMi45Ny4wIjsKdmFyIEpTX0VOViA9ICIiOwppZiAodHlwZW9mIERlbm8gIT09ICJ1bmRlZmluZWQiKSBKU19FTlYgPSAiZGVubyI7CmVsc2UgaWYgKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIpIEpTX0VOViA9ICJ3ZWIiOwplbHNlIGlmICh0eXBlb2YgbmF2aWdhdG9yICE9PSAidW5kZWZpbmVkIiAmJiBuYXZpZ2F0b3IucHJvZHVjdCA9PT0gIlJlYWN0TmF0aXZlIikgSlNfRU5WID0gInJlYWN0LW5hdGl2ZSI7CmVsc2UgSlNfRU5WID0gIm5vZGUiOwp2YXIgREVGQVVMVF9IRUFERVJTMyA9IHsgIlgtQ2xpZW50LUluZm8iOiBgc3VwYWJhc2UtanMtJHtKU19FTlZ9LyR7dmVyc2lvbjV9YCB9Owp2YXIgREVGQVVMVF9HTE9CQUxfT1BUSU9OUyA9IHsgaGVhZGVyczogREVGQVVMVF9IRUFERVJTMyB9Owp2YXIgREVGQVVMVF9EQl9PUFRJT05TID0geyBzY2hlbWE6ICJwdWJsaWMiIH07CnZhciBERUZBVUxUX0FVVEhfT1BUSU9OUyA9IHsKICBhdXRvUmVmcmVzaFRva2VuOiB0cnVlLAogIHBlcnNpc3RTZXNzaW9uOiB0cnVlLAogIGRldGVjdFNlc3Npb25JblVybDogdHJ1ZSwKICBmbG93VHlwZTogImltcGxpY2l0Igp9Owp2YXIgREVGQVVMVF9SRUFMVElNRV9PUFRJT05TID0ge307CmZ1bmN0aW9uIF90eXBlb2YzKG8pIHsKICAiQGJhYmVsL2hlbHBlcnMgLSB0eXBlb2YiOwogIHJldHVybiBfdHlwZW9mMyA9ICJmdW5jdGlvbiIgPT0gdHlwZW9mIFN5bWJvbCAmJiAic3ltYm9sIiA9PSB0eXBlb2YgU3ltYm9sLml0ZXJhdG9yID8gZnVuY3Rpb24obyQxKSB7CiAgICByZXR1cm4gdHlwZW9mIG8kMTsKICB9IDogZnVuY3Rpb24obyQxKSB7CiAgICByZXR1cm4gbyQxICYmICJmdW5jdGlvbiIgPT0gdHlwZW9mIFN5bWJvbCAmJiBvJDEuY29uc3RydWN0b3IgPT09IFN5bWJvbCAmJiBvJDEgIT09IFN5bWJvbC5wcm90b3R5cGUgPyAic3ltYm9sIiA6IHR5cGVvZiBvJDE7CiAgfSwgX3R5cGVvZjMobyk7Cn0KZnVuY3Rpb24gdG9QcmltaXRpdmUzKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IF90eXBlb2YzKHQpIHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IF90eXBlb2YzKGkpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiB0b1Byb3BlcnR5S2V5Myh0KSB7CiAgdmFyIGkgPSB0b1ByaW1pdGl2ZTModCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSBfdHlwZW9mMyhpKSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MzYoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gdG9Qcm9wZXJ0eUtleTMocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7CiAgICB2YWx1ZTogdCwKICAgIGVudW1lcmFibGU6IHRydWUsCiAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICB3cml0YWJsZTogdHJ1ZQogIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIG93bktleXMzNChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ociQxKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIkMSkuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjEyKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMzQoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIkMSkgewogICAgICBfZGVmaW5lUHJvcGVydHkzNihlLCByJDEsIHRbciQxXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czM0KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyJDEpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIkMSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByJDEpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQp2YXIgcmVzb2x2ZUZldGNoNCA9IChjdXN0b21GZXRjaCkgPT4gewogIGlmIChjdXN0b21GZXRjaCkgcmV0dXJuICguLi5hcmdzKSA9PiBjdXN0b21GZXRjaCguLi5hcmdzKTsKICByZXR1cm4gKC4uLmFyZ3MpID0+IGZldGNoKC4uLmFyZ3MpOwp9Owp2YXIgcmVzb2x2ZUhlYWRlcnNDb25zdHJ1Y3RvciA9ICgpID0+IHsKICByZXR1cm4gSGVhZGVyczsKfTsKdmFyIGZldGNoV2l0aEF1dGggPSAoc3VwYWJhc2VLZXksIGdldEFjY2Vzc1Rva2VuLCBjdXN0b21GZXRjaCkgPT4gewogIGNvbnN0IGZldGNoJDEgPSByZXNvbHZlRmV0Y2g0KGN1c3RvbUZldGNoKTsKICBjb25zdCBIZWFkZXJzQ29uc3RydWN0b3IgPSByZXNvbHZlSGVhZGVyc0NvbnN0cnVjdG9yKCk7CiAgcmV0dXJuIGFzeW5jIChpbnB1dCwgaW5pdCkgPT4gewogICAgdmFyIF9hd2FpdCRnZXRBY2Nlc3NUb2tlbjsKICAgIGNvbnN0IGFjY2Vzc1Rva2VuID0gKF9hd2FpdCRnZXRBY2Nlc3NUb2tlbiA9IGF3YWl0IGdldEFjY2Vzc1Rva2VuKCkpICE9PSBudWxsICYmIF9hd2FpdCRnZXRBY2Nlc3NUb2tlbiAhPT0gdm9pZCAwID8gX2F3YWl0JGdldEFjY2Vzc1Rva2VuIDogc3VwYWJhc2VLZXk7CiAgICBsZXQgaGVhZGVycyA9IG5ldyBIZWFkZXJzQ29uc3RydWN0b3IoaW5pdCA9PT0gbnVsbCB8fCBpbml0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBpbml0LmhlYWRlcnMpOwogICAgaWYgKCFoZWFkZXJzLmhhcygiYXBpa2V5IikpIGhlYWRlcnMuc2V0KCJhcGlrZXkiLCBzdXBhYmFzZUtleSk7CiAgICBpZiAoIWhlYWRlcnMuaGFzKCJBdXRob3JpemF0aW9uIikpIGhlYWRlcnMuc2V0KCJBdXRob3JpemF0aW9uIiwgYEJlYXJlciAke2FjY2Vzc1Rva2VufWApOwogICAgcmV0dXJuIGZldGNoJDEoaW5wdXQsIF9vYmplY3RTcHJlYWQyMTIoX29iamVjdFNwcmVhZDIxMih7fSwgaW5pdCksIHt9LCB7IGhlYWRlcnMgfSkpOwogIH07Cn07CmZ1bmN0aW9uIGVuc3VyZVRyYWlsaW5nU2xhc2godXJsKSB7CiAgcmV0dXJuIHVybC5lbmRzV2l0aCgiLyIpID8gdXJsIDogdXJsICsgIi8iOwp9CmZ1bmN0aW9uIGFwcGx5U2V0dGluZ0RlZmF1bHRzKG9wdGlvbnMsIGRlZmF1bHRzKSB7CiAgdmFyIF9ERUZBVUxUX0dMT0JBTF9PUFRJTywgX2dsb2JhbE9wdGlvbnMkaGVhZGVyOwogIGNvbnN0IHsgZGI6IGRiT3B0aW9ucywgYXV0aDogYXV0aE9wdGlvbnMsIHJlYWx0aW1lOiByZWFsdGltZU9wdGlvbnMsIGdsb2JhbDogZ2xvYmFsT3B0aW9ucyB9ID0gb3B0aW9uczsKICBjb25zdCB7IGRiOiBERUZBVUxUX0RCX09QVElPTlMkMSwgYXV0aDogREVGQVVMVF9BVVRIX09QVElPTlMkMSwgcmVhbHRpbWU6IERFRkFVTFRfUkVBTFRJTUVfT1BUSU9OUyQxLCBnbG9iYWw6IERFRkFVTFRfR0xPQkFMX09QVElPTlMkMSB9ID0gZGVmYXVsdHM7CiAgY29uc3QgcmVzdWx0ID0gewogICAgZGI6IF9vYmplY3RTcHJlYWQyMTIoX29iamVjdFNwcmVhZDIxMih7fSwgREVGQVVMVF9EQl9PUFRJT05TJDEpLCBkYk9wdGlvbnMpLAogICAgYXV0aDogX29iamVjdFNwcmVhZDIxMihfb2JqZWN0U3ByZWFkMjEyKHt9LCBERUZBVUxUX0FVVEhfT1BUSU9OUyQxKSwgYXV0aE9wdGlvbnMpLAogICAgcmVhbHRpbWU6IF9vYmplY3RTcHJlYWQyMTIoX29iamVjdFNwcmVhZDIxMih7fSwgREVGQVVMVF9SRUFMVElNRV9PUFRJT05TJDEpLCByZWFsdGltZU9wdGlvbnMpLAogICAgc3RvcmFnZToge30sCiAgICBnbG9iYWw6IF9vYmplY3RTcHJlYWQyMTIoX29iamVjdFNwcmVhZDIxMihfb2JqZWN0U3ByZWFkMjEyKHt9LCBERUZBVUxUX0dMT0JBTF9PUFRJT05TJDEpLCBnbG9iYWxPcHRpb25zKSwge30sIHsgaGVhZGVyczogX29iamVjdFNwcmVhZDIxMihfb2JqZWN0U3ByZWFkMjEyKHt9LCAoX0RFRkFVTFRfR0xPQkFMX09QVElPID0gREVGQVVMVF9HTE9CQUxfT1BUSU9OUyQxID09PSBudWxsIHx8IERFRkFVTFRfR0xPQkFMX09QVElPTlMkMSA9PT0gdm9pZCAwID8gdm9pZCAwIDogREVGQVVMVF9HTE9CQUxfT1BUSU9OUyQxLmhlYWRlcnMpICE9PSBudWxsICYmIF9ERUZBVUxUX0dMT0JBTF9PUFRJTyAhPT0gdm9pZCAwID8gX0RFRkFVTFRfR0xPQkFMX09QVElPIDoge30pLCAoX2dsb2JhbE9wdGlvbnMkaGVhZGVyID0gZ2xvYmFsT3B0aW9ucyA9PT0gbnVsbCB8fCBnbG9iYWxPcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBnbG9iYWxPcHRpb25zLmhlYWRlcnMpICE9PSBudWxsICYmIF9nbG9iYWxPcHRpb25zJGhlYWRlciAhPT0gdm9pZCAwID8gX2dsb2JhbE9wdGlvbnMkaGVhZGVyIDoge30pIH0pLAogICAgYWNjZXNzVG9rZW46IGFzeW5jICgpID0+ICIiCiAgfTsKICBpZiAob3B0aW9ucy5hY2Nlc3NUb2tlbikgcmVzdWx0LmFjY2Vzc1Rva2VuID0gb3B0aW9ucy5hY2Nlc3NUb2tlbjsKICBlbHNlIGRlbGV0ZSByZXN1bHQuYWNjZXNzVG9rZW47CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiB2YWxpZGF0ZVN1cGFiYXNlVXJsKHN1cGFiYXNlVXJsMikgewogIGNvbnN0IHRyaW1tZWRVcmwgPSBzdXBhYmFzZVVybDIgPT09IG51bGwgfHwgc3VwYWJhc2VVcmwyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzdXBhYmFzZVVybDIudHJpbSgpOwogIGlmICghdHJpbW1lZFVybCkgdGhyb3cgbmV3IEVycm9yKCJzdXBhYmFzZVVybCBpcyByZXF1aXJlZC4iKTsKICBpZiAoIXRyaW1tZWRVcmwubWF0Y2goL15odHRwcz86XC9cLy9pKSkgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHN1cGFiYXNlVXJsOiBNdXN0IGJlIGEgdmFsaWQgSFRUUCBvciBIVFRQUyBVUkwuIik7CiAgdHJ5IHsKICAgIHJldHVybiBuZXcgVVJMKGVuc3VyZVRyYWlsaW5nU2xhc2godHJpbW1lZFVybCkpOwogIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgIHRocm93IEVycm9yKCJJbnZhbGlkIHN1cGFiYXNlVXJsOiBQcm92aWRlZCBVUkwgaXMgbWFsZm9ybWVkLiIpOwogIH0KfQp2YXIgU3VwYWJhc2VBdXRoQ2xpZW50ID0gY2xhc3MgZXh0ZW5kcyBBdXRoQ2xpZW50X2RlZmF1bHQgewogIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsKICAgIHN1cGVyKG9wdGlvbnMpOwogIH0KfTsKdmFyIFN1cGFiYXNlQ2xpZW50ID0gY2xhc3MgewogIC8qKgogICogQ3JlYXRlIGEgbmV3IGNsaWVudCBmb3IgdXNlIGluIHRoZSBicm93c2VyLgogICogQHBhcmFtIHN1cGFiYXNlVXJsIFRoZSB1bmlxdWUgU3VwYWJhc2UgVVJMIHdoaWNoIGlzIHN1cHBsaWVkIHdoZW4geW91IGNyZWF0ZSBhIG5ldyBwcm9qZWN0IGluIHlvdXIgcHJvamVjdCBkYXNoYm9hcmQuCiAgKiBAcGFyYW0gc3VwYWJhc2VLZXkgVGhlIHVuaXF1ZSBTdXBhYmFzZSBLZXkgd2hpY2ggaXMgc3VwcGxpZWQgd2hlbiB5b3UgY3JlYXRlIGEgbmV3IHByb2plY3QgaW4geW91ciBwcm9qZWN0IGRhc2hib2FyZC4KICAqIEBwYXJhbSBvcHRpb25zLmRiLnNjaGVtYSBZb3UgY2FuIHN3aXRjaCBpbiBiZXR3ZWVuIHNjaGVtYXMuIFRoZSBzY2hlbWEgbmVlZHMgdG8gYmUgb24gdGhlIGxpc3Qgb2YgZXhwb3NlZCBzY2hlbWFzIGluc2lkZSBTdXBhYmFzZS4KICAqIEBwYXJhbSBvcHRpb25zLmF1dGguYXV0b1JlZnJlc2hUb2tlbiBTZXQgdG8gInRydWUiIGlmIHlvdSB3YW50IHRvIGF1dG9tYXRpY2FsbHkgcmVmcmVzaCB0aGUgdG9rZW4gYmVmb3JlIGV4cGlyaW5nLgogICogQHBhcmFtIG9wdGlvbnMuYXV0aC5wZXJzaXN0U2Vzc2lvbiBTZXQgdG8gInRydWUiIGlmIHlvdSB3YW50IHRvIGF1dG9tYXRpY2FsbHkgc2F2ZSB0aGUgdXNlciBzZXNzaW9uIGludG8gbG9jYWwgc3RvcmFnZS4KICAqIEBwYXJhbSBvcHRpb25zLmF1dGguZGV0ZWN0U2Vzc2lvbkluVXJsIFNldCB0byAidHJ1ZSIgaWYgeW91IHdhbnQgdG8gYXV0b21hdGljYWxseSBkZXRlY3RzIE9BdXRoIGdyYW50cyBpbiB0aGUgVVJMIGFuZCBzaWducyBpbiB0aGUgdXNlci4KICAqIEBwYXJhbSBvcHRpb25zLnJlYWx0aW1lIE9wdGlvbnMgcGFzc2VkIGFsb25nIHRvIHJlYWx0aW1lLWpzIGNvbnN0cnVjdG9yLgogICogQHBhcmFtIG9wdGlvbnMuc3RvcmFnZSBPcHRpb25zIHBhc3NlZCBhbG9uZyB0byB0aGUgc3RvcmFnZS1qcyBjb25zdHJ1Y3Rvci4KICAqIEBwYXJhbSBvcHRpb25zLmdsb2JhbC5mZXRjaCBBIGN1c3RvbSBmZXRjaCBpbXBsZW1lbnRhdGlvbi4KICAqIEBwYXJhbSBvcHRpb25zLmdsb2JhbC5oZWFkZXJzIEFueSBhZGRpdGlvbmFsIGhlYWRlcnMgdG8gc2VuZCB3aXRoIGVhY2ggbmV0d29yayByZXF1ZXN0LgogICogQGV4YW1wbGUKICAqIGBgYHRzCiAgKiBpbXBvcnQgeyBjcmVhdGVDbGllbnQgfSBmcm9tICdAc3VwYWJhc2Uvc3VwYWJhc2UtanMnCiAgKgogICogY29uc3Qgc3VwYWJhc2UgPSBjcmVhdGVDbGllbnQoJ2h0dHBzOi8veHl6Y29tcGFueS5zdXBhYmFzZS5jbycsICdwdWJsaWMtYW5vbi1rZXknKQogICogY29uc3QgeyBkYXRhIH0gPSBhd2FpdCBzdXBhYmFzZS5mcm9tKCdwcm9maWxlcycpLnNlbGVjdCgnKicpCiAgKiBgYGAKICAqLwogIGNvbnN0cnVjdG9yKHN1cGFiYXNlVXJsMiwgc3VwYWJhc2VLZXksIG9wdGlvbnMpIHsKICAgIHZhciBfc2V0dGluZ3MkYXV0aCRzdG9yYWcsIF9zZXR0aW5ncyRnbG9iYWwkaGVhZDsKICAgIHRoaXMuc3VwYWJhc2VVcmwgPSBzdXBhYmFzZVVybDI7CiAgICB0aGlzLnN1cGFiYXNlS2V5ID0gc3VwYWJhc2VLZXk7CiAgICBjb25zdCBiYXNlVXJsID0gdmFsaWRhdGVTdXBhYmFzZVVybChzdXBhYmFzZVVybDIpOwogICAgaWYgKCFzdXBhYmFzZUtleSkgdGhyb3cgbmV3IEVycm9yKCJzdXBhYmFzZUtleSBpcyByZXF1aXJlZC4iKTsKICAgIHRoaXMucmVhbHRpbWVVcmwgPSBuZXcgVVJMKCJyZWFsdGltZS92MSIsIGJhc2VVcmwpOwogICAgdGhpcy5yZWFsdGltZVVybC5wcm90b2NvbCA9IHRoaXMucmVhbHRpbWVVcmwucHJvdG9jb2wucmVwbGFjZSgiaHR0cCIsICJ3cyIpOwogICAgdGhpcy5hdXRoVXJsID0gbmV3IFVSTCgiYXV0aC92MSIsIGJhc2VVcmwpOwogICAgdGhpcy5zdG9yYWdlVXJsID0gbmV3IFVSTCgic3RvcmFnZS92MSIsIGJhc2VVcmwpOwogICAgdGhpcy5mdW5jdGlvbnNVcmwgPSBuZXcgVVJMKCJmdW5jdGlvbnMvdjEiLCBiYXNlVXJsKTsKICAgIGNvbnN0IGRlZmF1bHRTdG9yYWdlS2V5ID0gYHNiLSR7YmFzZVVybC5ob3N0bmFtZS5zcGxpdCgiLiIpWzBdfS1hdXRoLXRva2VuYDsKICAgIGNvbnN0IERFRkFVTFRTID0gewogICAgICBkYjogREVGQVVMVF9EQl9PUFRJT05TLAogICAgICByZWFsdGltZTogREVGQVVMVF9SRUFMVElNRV9PUFRJT05TLAogICAgICBhdXRoOiBfb2JqZWN0U3ByZWFkMjEyKF9vYmplY3RTcHJlYWQyMTIoe30sIERFRkFVTFRfQVVUSF9PUFRJT05TKSwge30sIHsgc3RvcmFnZUtleTogZGVmYXVsdFN0b3JhZ2VLZXkgfSksCiAgICAgIGdsb2JhbDogREVGQVVMVF9HTE9CQUxfT1BUSU9OUwogICAgfTsKICAgIGNvbnN0IHNldHRpbmdzID0gYXBwbHlTZXR0aW5nRGVmYXVsdHMob3B0aW9ucyAhPT0gbnVsbCAmJiBvcHRpb25zICE9PSB2b2lkIDAgPyBvcHRpb25zIDoge30sIERFRkFVTFRTKTsKICAgIHRoaXMuc3RvcmFnZUtleSA9IChfc2V0dGluZ3MkYXV0aCRzdG9yYWcgPSBzZXR0aW5ncy5hdXRoLnN0b3JhZ2VLZXkpICE9PSBudWxsICYmIF9zZXR0aW5ncyRhdXRoJHN0b3JhZyAhPT0gdm9pZCAwID8gX3NldHRpbmdzJGF1dGgkc3RvcmFnIDogIiI7CiAgICB0aGlzLmhlYWRlcnMgPSAoX3NldHRpbmdzJGdsb2JhbCRoZWFkID0gc2V0dGluZ3MuZ2xvYmFsLmhlYWRlcnMpICE9PSBudWxsICYmIF9zZXR0aW5ncyRnbG9iYWwkaGVhZCAhPT0gdm9pZCAwID8gX3NldHRpbmdzJGdsb2JhbCRoZWFkIDoge307CiAgICBpZiAoIXNldHRpbmdzLmFjY2Vzc1Rva2VuKSB7CiAgICAgIHZhciBfc2V0dGluZ3MkYXV0aDsKICAgICAgdGhpcy5hdXRoID0gdGhpcy5faW5pdFN1cGFiYXNlQXV0aENsaWVudCgoX3NldHRpbmdzJGF1dGggPSBzZXR0aW5ncy5hdXRoKSAhPT0gbnVsbCAmJiBfc2V0dGluZ3MkYXV0aCAhPT0gdm9pZCAwID8gX3NldHRpbmdzJGF1dGggOiB7fSwgdGhpcy5oZWFkZXJzLCBzZXR0aW5ncy5nbG9iYWwuZmV0Y2gpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5hY2Nlc3NUb2tlbiA9IHNldHRpbmdzLmFjY2Vzc1Rva2VuOwogICAgICB0aGlzLmF1dGggPSBuZXcgUHJveHkoe30sIHsgZ2V0OiAoXywgcHJvcCkgPT4gewogICAgICAgIHRocm93IG5ldyBFcnJvcihgQHN1cGFiYXNlL3N1cGFiYXNlLWpzOiBTdXBhYmFzZSBDbGllbnQgaXMgY29uZmlndXJlZCB3aXRoIHRoZSBhY2Nlc3NUb2tlbiBvcHRpb24sIGFjY2Vzc2luZyBzdXBhYmFzZS5hdXRoLiR7U3RyaW5nKHByb3ApfSBpcyBub3QgcG9zc2libGVgKTsKICAgICAgfSB9KTsKICAgIH0KICAgIHRoaXMuZmV0Y2ggPSBmZXRjaFdpdGhBdXRoKHN1cGFiYXNlS2V5LCB0aGlzLl9nZXRBY2Nlc3NUb2tlbi5iaW5kKHRoaXMpLCBzZXR0aW5ncy5nbG9iYWwuZmV0Y2gpOwogICAgdGhpcy5yZWFsdGltZSA9IHRoaXMuX2luaXRSZWFsdGltZUNsaWVudChfb2JqZWN0U3ByZWFkMjEyKHsKICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICBhY2Nlc3NUb2tlbjogdGhpcy5fZ2V0QWNjZXNzVG9rZW4uYmluZCh0aGlzKQogICAgfSwgc2V0dGluZ3MucmVhbHRpbWUpKTsKICAgIGlmICh0aGlzLmFjY2Vzc1Rva2VuKSBQcm9taXNlLnJlc29sdmUodGhpcy5hY2Nlc3NUb2tlbigpKS50aGVuKCh0b2tlbikgPT4gdGhpcy5yZWFsdGltZS5zZXRBdXRoKHRva2VuKSkuY2F0Y2goKGUpID0+IGNvbnNvbGUud2FybigiRmFpbGVkIHRvIHNldCBpbml0aWFsIFJlYWx0aW1lIGF1dGggdG9rZW46IiwgZSkpOwogICAgdGhpcy5yZXN0ID0gbmV3IFBvc3RncmVzdENsaWVudChuZXcgVVJMKCJyZXN0L3YxIiwgYmFzZVVybCkuaHJlZiwgewogICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgIHNjaGVtYTogc2V0dGluZ3MuZGIuc2NoZW1hLAogICAgICBmZXRjaDogdGhpcy5mZXRjaCwKICAgICAgdGltZW91dDogc2V0dGluZ3MuZGIudGltZW91dCwKICAgICAgdXJsTGVuZ3RoTGltaXQ6IHNldHRpbmdzLmRiLnVybExlbmd0aExpbWl0CiAgICB9KTsKICAgIHRoaXMuc3RvcmFnZSA9IG5ldyBTdG9yYWdlQ2xpZW50KHRoaXMuc3RvcmFnZVVybC5ocmVmLCB0aGlzLmhlYWRlcnMsIHRoaXMuZmV0Y2gsIG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5zdG9yYWdlKTsKICAgIGlmICghc2V0dGluZ3MuYWNjZXNzVG9rZW4pIHRoaXMuX2xpc3RlbkZvckF1dGhFdmVudHMoKTsKICB9CiAgLyoqCiAgKiBTdXBhYmFzZSBGdW5jdGlvbnMgYWxsb3dzIHlvdSB0byBkZXBsb3kgYW5kIGludm9rZSBlZGdlIGZ1bmN0aW9ucy4KICAqLwogIGdldCBmdW5jdGlvbnMoKSB7CiAgICByZXR1cm4gbmV3IEZ1bmN0aW9uc0NsaWVudCh0aGlzLmZ1bmN0aW9uc1VybC5ocmVmLCB7CiAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgY3VzdG9tRmV0Y2g6IHRoaXMuZmV0Y2gKICAgIH0pOwogIH0KICAvKioKICAqIFBlcmZvcm0gYSBxdWVyeSBvbiBhIHRhYmxlIG9yIGEgdmlldy4KICAqCiAgKiBAcGFyYW0gcmVsYXRpb24gLSBUaGUgdGFibGUgb3IgdmlldyBuYW1lIHRvIHF1ZXJ5CiAgKi8KICBmcm9tKHJlbGF0aW9uKSB7CiAgICByZXR1cm4gdGhpcy5yZXN0LmZyb20ocmVsYXRpb24pOwogIH0KICAvKioKICAqIFNlbGVjdCBhIHNjaGVtYSB0byBxdWVyeSBvciBwZXJmb3JtIGFuIGZ1bmN0aW9uIChycGMpIGNhbGwuCiAgKgogICogVGhlIHNjaGVtYSBuZWVkcyB0byBiZSBvbiB0aGUgbGlzdCBvZiBleHBvc2VkIHNjaGVtYXMgaW5zaWRlIFN1cGFiYXNlLgogICoKICAqIEBwYXJhbSBzY2hlbWEgLSBUaGUgc2NoZW1hIHRvIHF1ZXJ5CiAgKi8KICBzY2hlbWEoc2NoZW1hKSB7CiAgICByZXR1cm4gdGhpcy5yZXN0LnNjaGVtYShzY2hlbWEpOwogIH0KICAvKioKICAqIFBlcmZvcm0gYSBmdW5jdGlvbiBjYWxsLgogICoKICAqIEBwYXJhbSBmbiAtIFRoZSBmdW5jdGlvbiBuYW1lIHRvIGNhbGwKICAqIEBwYXJhbSBhcmdzIC0gVGhlIGFyZ3VtZW50cyB0byBwYXNzIHRvIHRoZSBmdW5jdGlvbiBjYWxsCiAgKiBAcGFyYW0gb3B0aW9ucyAtIE5hbWVkIHBhcmFtZXRlcnMKICAqIEBwYXJhbSBvcHRpb25zLmhlYWQgLSBXaGVuIHNldCB0byBgdHJ1ZWAsIGBkYXRhYCB3aWxsIG5vdCBiZSByZXR1cm5lZC4KICAqIFVzZWZ1bCBpZiB5b3Ugb25seSBuZWVkIHRoZSBjb3VudC4KICAqIEBwYXJhbSBvcHRpb25zLmdldCAtIFdoZW4gc2V0IHRvIGB0cnVlYCwgdGhlIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdpdGgKICAqIHJlYWQtb25seSBhY2Nlc3MgbW9kZS4KICAqIEBwYXJhbSBvcHRpb25zLmNvdW50IC0gQ291bnQgYWxnb3JpdGhtIHRvIHVzZSB0byBjb3VudCByb3dzIHJldHVybmVkIGJ5IHRoZQogICogZnVuY3Rpb24uIE9ubHkgYXBwbGljYWJsZSBmb3IgW3NldC1yZXR1cm5pbmcKICAqIGZ1bmN0aW9uc10oaHR0cHM6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy9jdXJyZW50L2Z1bmN0aW9ucy1zcmYuaHRtbCkuCiAgKgogICogYCJleGFjdCJgOiBFeGFjdCBidXQgc2xvdyBjb3VudCBhbGdvcml0aG0uIFBlcmZvcm1zIGEgYENPVU5UKCopYCB1bmRlciB0aGUKICAqIGhvb2QuCiAgKgogICogYCJwbGFubmVkImA6IEFwcHJveGltYXRlZCBidXQgZmFzdCBjb3VudCBhbGdvcml0aG0uIFVzZXMgdGhlIFBvc3RncmVzCiAgKiBzdGF0aXN0aWNzIHVuZGVyIHRoZSBob29kLgogICoKICAqIGAiZXN0aW1hdGVkImA6IFVzZXMgZXhhY3QgY291bnQgZm9yIGxvdyBudW1iZXJzIGFuZCBwbGFubmVkIGNvdW50IGZvciBoaWdoCiAgKiBudW1iZXJzLgogICovCiAgcnBjKGZuLCBhcmdzID0ge30sIG9wdGlvbnMgPSB7CiAgICBoZWFkOiBmYWxzZSwKICAgIGdldDogZmFsc2UsCiAgICBjb3VudDogdm9pZCAwCiAgfSkgewogICAgcmV0dXJuIHRoaXMucmVzdC5ycGMoZm4sIGFyZ3MsIG9wdGlvbnMpOwogIH0KICAvKioKICAqIENyZWF0ZXMgYSBSZWFsdGltZSBjaGFubmVsIHdpdGggQnJvYWRjYXN0LCBQcmVzZW5jZSwgYW5kIFBvc3RncmVzIENoYW5nZXMuCiAgKgogICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgUmVhbHRpbWUgY2hhbm5lbC4KICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzIC0gVGhlIG9wdGlvbnMgdG8gcGFzcyB0byB0aGUgUmVhbHRpbWUgY2hhbm5lbC4KICAqCiAgKi8KICBjaGFubmVsKG5hbWUsIG9wdHMgPSB7IGNvbmZpZzoge30gfSkgewogICAgcmV0dXJuIHRoaXMucmVhbHRpbWUuY2hhbm5lbChuYW1lLCBvcHRzKTsKICB9CiAgLyoqCiAgKiBSZXR1cm5zIGFsbCBSZWFsdGltZSBjaGFubmVscy4KICAqLwogIGdldENoYW5uZWxzKCkgewogICAgcmV0dXJuIHRoaXMucmVhbHRpbWUuZ2V0Q2hhbm5lbHMoKTsKICB9CiAgLyoqCiAgKiBVbnN1YnNjcmliZXMgYW5kIHJlbW92ZXMgUmVhbHRpbWUgY2hhbm5lbCBmcm9tIFJlYWx0aW1lIGNsaWVudC4KICAqCiAgKiBAcGFyYW0ge1JlYWx0aW1lQ2hhbm5lbH0gY2hhbm5lbCAtIFRoZSBuYW1lIG9mIHRoZSBSZWFsdGltZSBjaGFubmVsLgogICoKICAqLwogIHJlbW92ZUNoYW5uZWwoY2hhbm5lbCkgewogICAgcmV0dXJuIHRoaXMucmVhbHRpbWUucmVtb3ZlQ2hhbm5lbChjaGFubmVsKTsKICB9CiAgLyoqCiAgKiBVbnN1YnNjcmliZXMgYW5kIHJlbW92ZXMgYWxsIFJlYWx0aW1lIGNoYW5uZWxzIGZyb20gUmVhbHRpbWUgY2xpZW50LgogICovCiAgcmVtb3ZlQWxsQ2hhbm5lbHMoKSB7CiAgICByZXR1cm4gdGhpcy5yZWFsdGltZS5yZW1vdmVBbGxDaGFubmVscygpOwogIH0KICBhc3luYyBfZ2V0QWNjZXNzVG9rZW4oKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgdmFyIF9kYXRhJHNlc3Npb24kYWNjZXNzXywgX2RhdGEkc2Vzc2lvbjsKICAgIGlmIChfdGhpcy5hY2Nlc3NUb2tlbikgcmV0dXJuIGF3YWl0IF90aGlzLmFjY2Vzc1Rva2VuKCk7CiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IF90aGlzLmF1dGguZ2V0U2Vzc2lvbigpOwogICAgcmV0dXJuIChfZGF0YSRzZXNzaW9uJGFjY2Vzc18gPSAoX2RhdGEkc2Vzc2lvbiA9IGRhdGEuc2Vzc2lvbikgPT09IG51bGwgfHwgX2RhdGEkc2Vzc2lvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2RhdGEkc2Vzc2lvbi5hY2Nlc3NfdG9rZW4pICE9PSBudWxsICYmIF9kYXRhJHNlc3Npb24kYWNjZXNzXyAhPT0gdm9pZCAwID8gX2RhdGEkc2Vzc2lvbiRhY2Nlc3NfIDogX3RoaXMuc3VwYWJhc2VLZXk7CiAgfQogIF9pbml0U3VwYWJhc2VBdXRoQ2xpZW50KHsgYXV0b1JlZnJlc2hUb2tlbiwgcGVyc2lzdFNlc3Npb24sIGRldGVjdFNlc3Npb25JblVybCwgc3RvcmFnZSwgdXNlclN0b3JhZ2UsIHN0b3JhZ2VLZXksIGZsb3dUeXBlLCBsb2NrLCBkZWJ1ZywgdGhyb3dPbkVycm9yIH0sIGhlYWRlcnMsIGZldGNoJDEpIHsKICAgIGNvbnN0IGF1dGhIZWFkZXJzID0gewogICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dGhpcy5zdXBhYmFzZUtleX1gLAogICAgICBhcGlrZXk6IGAke3RoaXMuc3VwYWJhc2VLZXl9YAogICAgfTsKICAgIHJldHVybiBuZXcgU3VwYWJhc2VBdXRoQ2xpZW50KHsKICAgICAgdXJsOiB0aGlzLmF1dGhVcmwuaHJlZiwKICAgICAgaGVhZGVyczogX29iamVjdFNwcmVhZDIxMihfb2JqZWN0U3ByZWFkMjEyKHt9LCBhdXRoSGVhZGVycyksIGhlYWRlcnMpLAogICAgICBzdG9yYWdlS2V5LAogICAgICBhdXRvUmVmcmVzaFRva2VuLAogICAgICBwZXJzaXN0U2Vzc2lvbiwKICAgICAgZGV0ZWN0U2Vzc2lvbkluVXJsLAogICAgICBzdG9yYWdlLAogICAgICB1c2VyU3RvcmFnZSwKICAgICAgZmxvd1R5cGUsCiAgICAgIGxvY2ssCiAgICAgIGRlYnVnLAogICAgICB0aHJvd09uRXJyb3IsCiAgICAgIGZldGNoOiBmZXRjaCQxLAogICAgICBoYXNDdXN0b21BdXRob3JpemF0aW9uSGVhZGVyOiBPYmplY3Qua2V5cyh0aGlzLmhlYWRlcnMpLnNvbWUoKGtleSkgPT4ga2V5LnRvTG93ZXJDYXNlKCkgPT09ICJhdXRob3JpemF0aW9uIikKICAgIH0pOwogIH0KICBfaW5pdFJlYWx0aW1lQ2xpZW50KG9wdGlvbnMpIHsKICAgIHJldHVybiBuZXcgUmVhbHRpbWVDbGllbnQodGhpcy5yZWFsdGltZVVybC5ocmVmLCBfb2JqZWN0U3ByZWFkMjEyKF9vYmplY3RTcHJlYWQyMTIoe30sIG9wdGlvbnMpLCB7fSwgeyBwYXJhbXM6IF9vYmplY3RTcHJlYWQyMTIoX29iamVjdFNwcmVhZDIxMih7fSwgeyBhcGlrZXk6IHRoaXMuc3VwYWJhc2VLZXkgfSksIG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5wYXJhbXMpIH0pKTsKICB9CiAgX2xpc3RlbkZvckF1dGhFdmVudHMoKSB7CiAgICByZXR1cm4gdGhpcy5hdXRoLm9uQXV0aFN0YXRlQ2hhbmdlKChldmVudCwgc2Vzc2lvbikgPT4gewogICAgICB0aGlzLl9oYW5kbGVUb2tlbkNoYW5nZWQoZXZlbnQsICJDTElFTlQiLCBzZXNzaW9uID09PSBudWxsIHx8IHNlc3Npb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNlc3Npb24uYWNjZXNzX3Rva2VuKTsKICAgIH0pOwogIH0KICBfaGFuZGxlVG9rZW5DaGFuZ2VkKGV2ZW50LCBzb3VyY2UsIHRva2VuKSB7CiAgICBpZiAoKGV2ZW50ID09PSAiVE9LRU5fUkVGUkVTSEVEIiB8fCBldmVudCA9PT0gIlNJR05FRF9JTiIpICYmIHRoaXMuY2hhbmdlZEFjY2Vzc1Rva2VuICE9PSB0b2tlbikgewogICAgICB0aGlzLmNoYW5nZWRBY2Nlc3NUb2tlbiA9IHRva2VuOwogICAgICB0aGlzLnJlYWx0aW1lLnNldEF1dGgodG9rZW4pOwogICAgfSBlbHNlIGlmIChldmVudCA9PT0gIlNJR05FRF9PVVQiKSB7CiAgICAgIHRoaXMucmVhbHRpbWUuc2V0QXV0aCgpOwogICAgICBpZiAoc291cmNlID09ICJTVE9SQUdFIikgdGhpcy5hdXRoLnNpZ25PdXQoKTsKICAgICAgdGhpcy5jaGFuZ2VkQWNjZXNzVG9rZW4gPSB2b2lkIDA7CiAgICB9CiAgfQp9Owp2YXIgY3JlYXRlQ2xpZW50ID0gKHN1cGFiYXNlVXJsMiwgc3VwYWJhc2VLZXksIG9wdGlvbnMpID0+IHsKICByZXR1cm4gbmV3IFN1cGFiYXNlQ2xpZW50KHN1cGFiYXNlVXJsMiwgc3VwYWJhc2VLZXksIG9wdGlvbnMpOwp9OwpmdW5jdGlvbiBzaG91bGRTaG93RGVwcmVjYXRpb25XYXJuaW5nKCkgewogIGlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIikgcmV0dXJuIGZhbHNlOwogIGNvbnN0IF9wcm9jZXNzID0gZ2xvYmFsVGhpc1sicHJvY2VzcyJdOwogIGlmICghX3Byb2Nlc3MpIHJldHVybiBmYWxzZTsKICBjb25zdCBwcm9jZXNzVmVyc2lvbiA9IF9wcm9jZXNzWyJ2ZXJzaW9uIl07CiAgaWYgKHByb2Nlc3NWZXJzaW9uID09PSB2b2lkIDAgfHwgcHJvY2Vzc1ZlcnNpb24gPT09IG51bGwpIHJldHVybiBmYWxzZTsKICBjb25zdCB2ZXJzaW9uTWF0Y2ggPSBwcm9jZXNzVmVyc2lvbi5tYXRjaCgvXnYoXGQrKVwuLyk7CiAgaWYgKCF2ZXJzaW9uTWF0Y2gpIHJldHVybiBmYWxzZTsKICByZXR1cm4gcGFyc2VJbnQodmVyc2lvbk1hdGNoWzFdLCAxMCkgPD0gMTg7Cn0KaWYgKHNob3VsZFNob3dEZXByZWNhdGlvbldhcm5pbmcoKSkgY29uc29sZS53YXJuKCJcdTI2QTBcdUZFMEYgIE5vZGUuanMgMTggYW5kIGJlbG93IGFyZSBkZXByZWNhdGVkIGFuZCB3aWxsIG5vIGxvbmdlciBiZSBzdXBwb3J0ZWQgaW4gZnV0dXJlIHZlcnNpb25zIG9mIEBzdXBhYmFzZS9zdXBhYmFzZS1qcy4gUGxlYXNlIHVwZ3JhZGUgdG8gTm9kZS5qcyAyMCBvciBsYXRlci4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHZpc2l0OiBodHRwczovL2dpdGh1Yi5jb20vb3Jncy9zdXBhYmFzZS9kaXNjdXNzaW9ucy8zNzIxNyIpOwoKLy8gc3JjL3N1cGFiYXNlLnRzCnZhciBzdXBhYmFzZVVybCA9IHdpbmRvdy5TVVBBQkFTRV9FTlY/LnVybCB8fCBpbXBvcnQubWV0YS5lbnY/LlZJVEVfU1VQQUJBU0VfVVJMIHx8ICIiOwp2YXIgc3VwYWJhc2VBbm9uS2V5ID0gd2luZG93LlNVUEFCQVNFX0VOVj8uYW5vbktleSB8fCBpbXBvcnQubWV0YS5lbnY/LlZJVEVfU1VQQUJBU0VfQU5PTl9LRVkgfHwgIiI7CnZhciBzdXBhYmFzZSA9IHN1cGFiYXNlVXJsICYmIHN1cGFiYXNlQW5vbktleSA/IGNyZWF0ZUNsaWVudChzdXBhYmFzZVVybCwgc3VwYWJhc2VBbm9uS2V5KSA6IG51bGw7CgovLyBzcmMvY29tcG9uZW50cy9Mb2dpbk1vZGFsLnRzeAp2YXIgaW1wb3J0X3JlYWN0NTEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSwgMSk7CnZhciBpbXBvcnRfanN4X3J1bnRpbWUgPSBfX3RvRVNNKHJlcXVpcmVfanN4X3J1bnRpbWUoKSwgMSk7CnZhciBDT0xPUlMgPSB7CiAgcHJpbWFyeTogIiMxQjQzMzIiLAogIHByaW1hcnlEYXJrOiAiIzBGMkIxRiIsCiAgcHJpbWFyeUxpZ2h0OiAiIzJENkE0RiIsCiAgYWNjZW50OiAiIzQwOTE2QyIsCiAgYWNjZW50TGlnaHQ6ICIjRThGNUU5IiwKICBiZzogIiNGNUY1RjAiLAogIGNhcmQ6ICIjRkZGRkZGIiwKICBib3JkZXI6ICIjRTVFN0VCIiwKICBib3JkZXJMaWdodDogIiNGMEYwRjAiLAogIHRleHRNYWluOiAiIzFBMUExQSIsCiAgdGV4dFNlY29uZGFyeTogIiM2QjcyODAiLAogIHRleHRNdXRlZDogIiM5Q0EzQUYiLAogIGVycm9yOiAiI0RDMjYyNiIsCiAgZXJyb3JCZzogIiNGRUYyRjIiLAogIHN1Y2Nlc3M6ICIjMDU5NjY5IiwKICBzdWNjZXNzQmc6ICIjRUNGREY1Igp9Owp2YXIgaW5wdXRTdHlsZSA9IChmb2N1c2VkKSA9PiAoewogIHdpZHRoOiAiMTAwJSIsCiAgcGFkZGluZzogIjE2cHggMTZweCAxNnB4IDQ4cHgiLAogIGJhY2tncm91bmRDb2xvcjogZm9jdXNlZCA/ICIjRkZGRkZGIiA6ICIjRjlGQUZCIiwKICBib3JkZXI6IGAxcHggc29saWQgJHtmb2N1c2VkID8gQ09MT1JTLnByaW1hcnkgOiBDT0xPUlMuYm9yZGVyfWAsCiAgYm9yZGVyUmFkaXVzOiAxNiwKICBmb250U2l6ZTogMTUsCiAgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwKICBvdXRsaW5lOiAibm9uZSIsCiAgdHJhbnNpdGlvbjogImFsbCAwLjJzIiwKICBib3hTaXppbmc6ICJib3JkZXItYm94IiwKICBib3hTaGFkb3c6IGZvY3VzZWQgPyBgMCAwIDAgNHB4ICR7Q09MT1JTLmFjY2VudExpZ2h0fWAgOiAibm9uZSIKfSk7CnZhciBMb2dpbk1vZGFsID0gKHsgb25DbG9zZSwgb25Mb2dpblN1Y2Nlc3MgfSkgPT4gewogIGNvbnN0IFttb2RlLCBzZXRNb2RlXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoIkxPR0lOIik7CiAgY29uc3QgW2VtYWlsLCBzZXRFbWFpbF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKCIiKTsKICBjb25zdCBbcGFzc3dvcmQsIHNldFBhc3N3b3JkXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFtjb25maXJtUGFzc3dvcmQsIHNldENvbmZpcm1QYXNzd29yZF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKCIiKTsKICBjb25zdCBbbG9hZGluZywgc2V0TG9hZGluZ10gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbZXJyb3IsIHNldEVycm9yXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFtzdWNjZXNzLCBzZXRTdWNjZXNzXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFtlbWFpbEZvY3VzZWQsIHNldEVtYWlsRm9jdXNlZF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbcGFzc3dvcmRGb2N1c2VkLCBzZXRQYXNzd29yZEZvY3VzZWRdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW2NvbmZpcm1Gb2N1c2VkLCBzZXRDb25maXJtRm9jdXNlZF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBoYW5kbGVMb2dpbiA9IGFzeW5jIChlKSA9PiB7CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICBzZXRFcnJvcigiIik7CiAgICBzZXRTdWNjZXNzKCIiKTsKICAgIGlmICghc3VwYWJhc2UpIHsKICAgICAgc2V0RXJyb3IoIkNsb3VkIHN5bmMgaXMgY3VycmVudGx5IHVuYXZhaWxhYmxlLiBQbGVhc2UgdHJ5IGFnYWluIGxhdGVyLiIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBzZXRMb2FkaW5nKHRydWUpOwogICAgY29uc3QgeyBlcnJvcjogZXJyb3IyIH0gPSBhd2FpdCBzdXBhYmFzZS5hdXRoLnNpZ25JbldpdGhQYXNzd29yZCh7IGVtYWlsLCBwYXNzd29yZCB9KTsKICAgIHNldExvYWRpbmcoZmFsc2UpOwogICAgaWYgKGVycm9yMikgewogICAgICBjb25zb2xlLmVycm9yKCJMb2dpbiBlcnJvcjoiLCBlcnJvcjIpOwogICAgICBpZiAoZXJyb3IyLm1lc3NhZ2U/LnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoImludmFsaWQgbG9naW4gY3JlZGVudGlhbHMiKSkgewogICAgICAgIHNldEVycm9yKCJJbnZhbGlkIGVtYWlsIG9yIHBhc3N3b3JkLiBQbGVhc2UgdHJ5IGFnYWluLiIpOwogICAgICB9IGVsc2UgaWYgKGVycm9yMi5tZXNzYWdlPy50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCJlbWFpbCBub3QgY29uZmlybWVkIikpIHsKICAgICAgICBzZXRFcnJvcigiUGxlYXNlIGNoZWNrIHlvdXIgaW5ib3ggYW5kIGNvbmZpcm0geW91ciBlbWFpbCBiZWZvcmUgbG9nZ2luZyBpbi4iKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRFcnJvcihlcnJvcjIubWVzc2FnZSB8fCAiTG9naW4gZmFpbGVkLiBQbGVhc2UgdHJ5IGFnYWluLiIpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBvbkxvZ2luU3VjY2VzcygpOwogICAgfQogIH07CiAgY29uc3QgaGFuZGxlU2lnblVwID0gYXN5bmMgKGUpID0+IHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIHNldEVycm9yKCIiKTsKICAgIHNldFN1Y2Nlc3MoIiIpOwogICAgaWYgKCFzdXBhYmFzZSkgewogICAgICBzZXRFcnJvcigiQ2xvdWQgc3luYyBpcyBjdXJyZW50bHkgdW5hdmFpbGFibGUuIFBsZWFzZSB0cnkgYWdhaW4gbGF0ZXIuIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChwYXNzd29yZC5sZW5ndGggPCA2KSB7CiAgICAgIHNldEVycm9yKCJQYXNzd29yZCBtdXN0IGJlIGF0IGxlYXN0IDYgY2hhcmFjdGVycyBsb25nLiIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocGFzc3dvcmQgIT09IGNvbmZpcm1QYXNzd29yZCkgewogICAgICBzZXRFcnJvcigiUGFzc3dvcmRzIGRvIG5vdCBtYXRjaC4iKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgc2V0TG9hZGluZyh0cnVlKTsKICAgIGNvbnN0IHsgZGF0YSwgZXJyb3I6IGVycm9yMiB9ID0gYXdhaXQgc3VwYWJhc2UuYXV0aC5zaWduVXAoeyBlbWFpbCwgcGFzc3dvcmQgfSk7CiAgICBzZXRMb2FkaW5nKGZhbHNlKTsKICAgIGlmIChlcnJvcjIpIHsKICAgICAgY29uc29sZS5lcnJvcigiU2lnbiB1cCBlcnJvcjoiLCBlcnJvcjIpOwogICAgICBpZiAoZXJyb3IyLm1lc3NhZ2U/LnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoImFscmVhZHkgcmVnaXN0ZXJlZCIpKSB7CiAgICAgICAgc2V0RXJyb3IoIkFuIGFjY291bnQgd2l0aCB0aGlzIGVtYWlsIGFscmVhZHkgZXhpc3RzLiBUcnkgbG9nZ2luZyBpbiBpbnN0ZWFkLiIpOwogICAgICB9IGVsc2UgewogICAgICAgIHNldEVycm9yKGVycm9yMi5tZXNzYWdlIHx8ICJTaWduIHVwIGZhaWxlZC4gUGxlYXNlIHRyeSBhZ2Fpbi4iKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChkYXRhLnNlc3Npb24pIHsKICAgICAgb25Mb2dpblN1Y2Nlc3MoKTsKICAgIH0gZWxzZSB7CiAgICAgIHNldFN1Y2Nlc3MoIkFjY291bnQgY3JlYXRlZCEgUGxlYXNlIGNoZWNrIHlvdXIgZW1haWwgdG8gY29uZmlybSB5b3VyIGFjY291bnQsIHRoZW4gbG9nIGluLiIpOwogICAgICBzZXRNb2RlKCJMT0dJTiIpOwogICAgICBzZXRQYXNzd29yZCgiIik7CiAgICAgIHNldENvbmZpcm1QYXNzd29yZCgiIik7CiAgICB9CiAgfTsKICBjb25zdCBzd2l0Y2hNb2RlID0gKCkgPT4gewogICAgc2V0TW9kZShtb2RlID09PSAiTE9HSU4iID8gIlNJR05VUCIgOiAiTE9HSU4iKTsKICAgIHNldEVycm9yKCIiKTsKICAgIHNldFN1Y2Nlc3MoIiIpOwogICAgc2V0UGFzc3dvcmQoIiIpOwogICAgc2V0Q29uZmlybVBhc3N3b3JkKCIiKTsKICB9OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgcG9zaXRpb246ICJmaXhlZCIsCiAgICBpbnNldDogMCwKICAgIGJhY2tncm91bmRDb2xvcjogInJnYmEoMCwwLDAsMC40KSIsCiAgICBiYWNrZHJvcEZpbHRlcjogImJsdXIoNHB4KSIsCiAgICB6SW5kZXg6IDk5OTksCiAgICBkaXNwbGF5OiAiZmxleCIsCiAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgIHBhZGRpbmc6IDIwCiAgfSwgY2hpbGRyZW46IFsKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsCiAgICAgIGJvcmRlclJhZGl1czogMjQsCiAgICAgIGJveFNoYWRvdzogIjAgMjVweCA1MHB4IC0xMnB4IHJnYmEoMCwgMCwgMCwgMC4yNSkiLAogICAgICB3aWR0aDogIjEwMCUiLAogICAgICBtYXhXaWR0aDogNDQwLAogICAgICBvdmVyZmxvdzogImhpZGRlbiIsCiAgICAgIGFuaW1hdGlvbjogImZhZGVJbiAwLjJzIGVhc2Utb3V0IgogICAgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogIjI0cHggMzJweCAyMHB4IiwgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiZmxleC1zdGFydCIgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaDIiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAyNCwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBtYXJnaW46ICIwIDAgOHB4IDAiLCBsZXR0ZXJTcGFjaW5nOiAiLTAuMDJlbSIgfSwgY2hpbGRyZW46IG1vZGUgPT09ICJMT0dJTiIgPyAiTG9naW4iIDogIlNpZ24gVXAiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpbjogMCwgbGluZUhlaWdodDogMS41IH0sIGNoaWxkcmVuOiBtb2RlID09PSAiTE9HSU4iID8gIlNpZ24gaW4gdG8gc3luYyB5b3VyIGJ1ZGdldCBhY3Jvc3MgZGV2aWNlcy4iIDogIkNyZWF0ZSBhbiBhY2NvdW50IHRvIHNhdmUgYW5kIHN5bmMgeW91ciBidWRnZXQuIiB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBvbkNsb3NlLCBzdHlsZTogewogICAgICAgICAgYmFja2dyb3VuZDogIm5vbmUiLAogICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgIHBhZGRpbmc6IDgsCiAgICAgICAgICBtYXJnaW46ICItOHB4IC04cHggMCAwIiwKICAgICAgICAgIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLAogICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgICBib3JkZXJSYWRpdXM6ICI1MCUiLAogICAgICAgICAgdHJhbnNpdGlvbjogImJhY2tncm91bmQtY29sb3IgMC4ycyIKICAgICAgICB9LCBvbk1vdXNlRW50ZXI6IChlKSA9PiBlLmN1cnJlbnRUYXJnZXQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gQ09MT1JTLmJnLCBvbk1vdXNlTGVhdmU6IChlKSA9PiBlLmN1cnJlbnRUYXJnZXQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gInRyYW5zcGFyZW50IiwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoWCwgeyBzaXplOiAyMCB9KSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAiMCAzMnB4IDMycHgiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgZXJyb3IgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICAgIG1hcmdpbkJvdHRvbTogMjAsCiAgICAgICAgICBwYWRkaW5nOiAiMTJweCAxNnB4IiwKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmVycm9yQmcsCiAgICAgICAgICBib3JkZXJSYWRpdXM6IDEyLAogICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgYWxpZ25JdGVtczogImZsZXgtc3RhcnQiLAogICAgICAgICAgZ2FwOiAxMiwKICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5lcnJvcn0yMGAKICAgICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDaXJjbGVBbGVydCwgeyBzaXplOiAxOCwgY29sb3I6IENPTE9SUy5lcnJvciwgc3R5bGU6IHsgbWFyZ2luVG9wOiAyLCBmbGV4U2hyaW5rOiAwIH0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy5lcnJvciwgbGluZUhlaWdodDogMS41LCBmb250V2VpZ2h0OiA1MDAgfSwgY2hpbGRyZW46IGVycm9yIH0pCiAgICAgICAgXSB9KSwKICAgICAgICBzdWNjZXNzICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgICAgICBtYXJnaW5Cb3R0b206IDIwLAogICAgICAgICAgcGFkZGluZzogIjEycHggMTZweCIsCiAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5zdWNjZXNzQmcsCiAgICAgICAgICBib3JkZXJSYWRpdXM6IDEyLAogICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgYWxpZ25JdGVtczogImZsZXgtc3RhcnQiLAogICAgICAgICAgZ2FwOiAxMiwKICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5zdWNjZXNzfTIwYAogICAgICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKENpcmNsZUNoZWNrQmlnLCB7IHNpemU6IDE4LCBjb2xvcjogQ09MT1JTLnN1Y2Nlc3MsIHN0eWxlOiB7IG1hcmdpblRvcDogMiwgZmxleFNocmluazogMCB9IH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMuc3VjY2VzcywgbGluZUhlaWdodDogMS41LCBmb250V2VpZ2h0OiA1MDAgfSwgY2hpbGRyZW46IHN1Y2Nlc3MgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJmb3JtIiwgeyBvblN1Ym1pdDogbW9kZSA9PT0gIkxPR0lOIiA/IGhhbmRsZUxvZ2luIDogaGFuZGxlU2lnblVwLCBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGZsZXhEaXJlY3Rpb246ICJjb2x1bW4iLCBnYXA6IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwb3NpdGlvbjogInJlbGF0aXZlIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKE1haWwsIHsgc2l6ZTogMTgsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBzdHlsZTogeyBwb3NpdGlvbjogImFic29sdXRlIiwgbGVmdDogMTYsIHRvcDogIjUwJSIsIHRyYW5zZm9ybTogInRyYW5zbGF0ZVkoLTUwJSkiIH0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICAgImlucHV0IiwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0eXBlOiAiZW1haWwiLAogICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZW1haWwsCiAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldEVtYWlsKGUudGFyZ2V0LnZhbHVlKSwKICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAieW91QGVtYWlsLmNvbSIsCiAgICAgICAgICAgICAgICBzdHlsZTogaW5wdXRTdHlsZShlbWFpbEZvY3VzZWQpLAogICAgICAgICAgICAgICAgb25Gb2N1czogKCkgPT4gc2V0RW1haWxGb2N1c2VkKHRydWUpLAogICAgICAgICAgICAgICAgb25CbHVyOiAoKSA9PiBzZXRFbWFpbEZvY3VzZWQoZmFsc2UpLAogICAgICAgICAgICAgICAgYXV0b0ZvY3VzOiB0cnVlCiAgICAgICAgICAgICAgfQogICAgICAgICAgICApCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcG9zaXRpb246ICJyZWxhdGl2ZSIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShMb2NrLCB7IHNpemU6IDE4LCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgc3R5bGU6IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIGxlZnQ6IDE2LCB0b3A6ICI1MCUiLCB0cmFuc2Zvcm06ICJ0cmFuc2xhdGVZKC01MCUpIiB9IH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdHlwZTogInBhc3N3b3JkIiwKICAgICAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IHBhc3N3b3JkLAogICAgICAgICAgICAgICAgb25DaGFuZ2U6IChlKSA9PiBzZXRQYXNzd29yZChlLnRhcmdldC52YWx1ZSksCiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcjogIlBhc3N3b3JkIiwKICAgICAgICAgICAgICAgIHN0eWxlOiBpbnB1dFN0eWxlKHBhc3N3b3JkRm9jdXNlZCksCiAgICAgICAgICAgICAgICBvbkZvY3VzOiAoKSA9PiBzZXRQYXNzd29yZEZvY3VzZWQodHJ1ZSksCiAgICAgICAgICAgICAgICBvbkJsdXI6ICgpID0+IHNldFBhc3N3b3JkRm9jdXNlZChmYWxzZSkKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICkKICAgICAgICAgIF0gfSksCiAgICAgICAgICBtb2RlID09PSAiU0lHTlVQIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwb3NpdGlvbjogInJlbGF0aXZlIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKExvY2ssIHsgc2l6ZTogMTgsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBzdHlsZTogeyBwb3NpdGlvbjogImFic29sdXRlIiwgbGVmdDogMTYsIHRvcDogIjUwJSIsIHRyYW5zZm9ybTogInRyYW5zbGF0ZVkoLTUwJSkiIH0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICAgImlucHV0IiwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0eXBlOiAicGFzc3dvcmQiLAogICAgICAgICAgICAgICAgcmVxdWlyZWQ6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogY29uZmlybVBhc3N3b3JkLAogICAgICAgICAgICAgICAgb25DaGFuZ2U6IChlKSA9PiBzZXRDb25maXJtUGFzc3dvcmQoZS50YXJnZXQudmFsdWUpLAogICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI6ICJDb25maXJtIFBhc3N3b3JkIiwKICAgICAgICAgICAgICAgIHN0eWxlOiBpbnB1dFN0eWxlKGNvbmZpcm1Gb2N1c2VkKSwKICAgICAgICAgICAgICAgIG9uRm9jdXM6ICgpID0+IHNldENvbmZpcm1Gb2N1c2VkKHRydWUpLAogICAgICAgICAgICAgICAgb25CbHVyOiAoKSA9PiBzZXRDb25maXJtRm9jdXNlZChmYWxzZSkKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICkKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgewogICAgICAgICAgICAgIHR5cGU6ICJzdWJtaXQiLAogICAgICAgICAgICAgIGRpc2FibGVkOiBsb2FkaW5nIHx8ICFlbWFpbCB8fCAhcGFzc3dvcmQgfHwgbW9kZSA9PT0gIlNJR05VUCIgJiYgIWNvbmZpcm1QYXNzd29yZCwKICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgd2lkdGg6ICIxMDAlIiwKICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLnByaW1hcnksCiAgICAgICAgICAgICAgICBjb2xvcjogIndoaXRlIiwKICAgICAgICAgICAgICAgIHBhZGRpbmc6ICIxNnB4IiwKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTYsCiAgICAgICAgICAgICAgICBmb250U2l6ZTogMTYsCiAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgICAgIGN1cnNvcjogbG9hZGluZyA/ICJub3QtYWxsb3dlZCIgOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICBvcGFjaXR5OiBsb2FkaW5nIHx8ICFlbWFpbCB8fCAhcGFzc3dvcmQgPyAwLjcgOiAxLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogImFsbCAwLjJzIiwKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgZ2FwOiA4LAogICAgICAgICAgICAgICAgbWFyZ2luVG9wOiA0CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBvbk1vdXNlRW50ZXI6IChlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIWxvYWRpbmcpIHsKICAgICAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLnRyYW5zZm9ybSA9ICJ0cmFuc2xhdGVZKC0xcHgpIjsKICAgICAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IENPTE9SUy5wcmltYXJ5RGFyazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG9uTW91c2VMZWF2ZTogKGUpID0+IHsKICAgICAgICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS50cmFuc2Zvcm0gPSAidHJhbnNsYXRlWSgwKSI7CiAgICAgICAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gQ09MT1JTLnByaW1hcnk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjaGlsZHJlbjogbG9hZGluZyA/IG1vZGUgPT09ICJMT0dJTiIgPyAiTG9nZ2luZyBpbi4uLiIgOiAiQ3JlYXRpbmcgYWNjb3VudC4uLiIgOiBtb2RlID09PSAiTE9HSU4iID8gIkxvZ2luIiA6ICJDcmVhdGUgQWNjb3VudCIKICAgICAgICAgICAgfQogICAgICAgICAgKSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIG1hcmdpblRvcDogLTQgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIG1vZGUgPT09ICJMT0dJTiIgPyAiRG9uJ3QgaGF2ZSBhbiBhY2NvdW50PyAiIDogIkFscmVhZHkgaGF2ZSBhbiBhY2NvdW50PyAiLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHR5cGU6ICJidXR0b24iLAogICAgICAgICAgICAgICAgb25DbGljazogc3dpdGNoTW9kZSwKICAgICAgICAgICAgICAgIHN0eWxlOiB7IGJhY2tncm91bmQ6ICJub25lIiwgYm9yZGVyOiAibm9uZSIsIGNvbG9yOiBDT0xPUlMucHJpbWFyeSwgZm9udFdlaWdodDogNjAwLCBjdXJzb3I6ICJwb2ludGVyIiwgcGFkZGluZzogMCB9LAogICAgICAgICAgICAgICAgY2hpbGRyZW46IG1vZGUgPT09ICJMT0dJTiIgPyAiU2lnbiBVcCIgOiAiTG9naW4iCiAgICAgICAgICAgICAgfQogICAgICAgICAgICApCiAgICAgICAgICBdIH0pIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pCiAgICBdIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3R5bGUiLCB7IGNoaWxkcmVuOiBgCiAgICAgICAgICAgICAgICAgICAgQGtleWZyYW1lcyBmYWRlSW4gewogICAgICAgICAgICAgICAgICAgICAgICBmcm9tIHsgb3BhY2l0eTogMDsgdHJhbnNmb3JtOiBzY2FsZSgwLjk1KSB0cmFuc2xhdGVZKDEwcHgpOyB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRvIHsgb3BhY2l0eTogMTsgdHJhbnNmb3JtOiBzY2FsZSgxKSB0cmFuc2xhdGVZKDApOyB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYCB9KQogIF0gfSk7Cn07CgovLyBzcmMvTXlCdWRnZXQudHN4CnZhciBpbXBvcnRfanN4X3J1bnRpbWUyID0gX190b0VTTShyZXF1aXJlX2pzeF9ydW50aW1lKCksIDEpOwp2YXIgU1RPUkFHRV9LRVkyID0gIk1ZX0JVREdFVF9EQVRBIjsKdmFyIEJVREdFVFNfTElTVF9LRVkgPSAiTVlfQlVER0VUX0xJU1QiOwp2YXIgZ2VuZXJhdGVJZCA9ICgpID0+IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KTsKdmFyIENPTE9SUzIgPSB7CiAgcHJpbWFyeTogIiMxQjQzMzIiLAogIHByaW1hcnlEYXJrOiAiIzBGMkIxRiIsCiAgcHJpbWFyeUxpZ2h0OiAiIzJENkE0RiIsCiAgYWNjZW50OiAiIzQwOTE2QyIsCiAgYWNjZW50TGlnaHQ6ICIjRThGNUU5IiwKICBiZzogIiNGNUY1RjAiLAogIGNhcmQ6ICIjRkZGRkZGIiwKICBib3JkZXI6ICIjRTVFN0VCIiwKICBib3JkZXJMaWdodDogIiNGMEYwRjAiLAogIHRleHRNYWluOiAiIzFBMUExQSIsCiAgdGV4dFNlY29uZGFyeTogIiM2QjcyODAiLAogIHRleHRNdXRlZDogIiM5Q0EzQUYiLAogIGluY29tZTogIiMwNTk2NjkiLAogIGluY29tZUJnOiAiI0VDRkRGNSIsCiAgZXhwZW5zZTogIiNEQzI2MjYiLAogIGV4cGVuc2VCZzogIiNGRUYyRjIiLAogIGFzc2V0OiAiIzI1NjNFQiIsCiAgYXNzZXRCZzogIiNFRkY2RkYiLAogIG5vbkxpcXVpZDogIiM3QzNBRUQiLAogIG5vbkxpcXVpZEJnOiAiI0Y1RjNGRiIsCiAgcmV0aXJlbWVudDogIiMwODkxQjIiLAogIHJldGlyZW1lbnRCZzogIiNFQ0ZFRkYiLAogIGxpYWJpbGl0eTogIiNFQTU4MEMiLAogIGxpYWJpbGl0eUJnOiAiI0ZGRjdFRCIsCiAgcG9zaXRpdmU6ICIjMDU5NjY5IiwKICBuZWdhdGl2ZTogIiNEQzI2MjYiLAogIHdhcm5pbmc6ICIjRDk3NzA2Igp9Owp2YXIgZm10ID0gKG4pID0+IHsKICBpZiAoTWF0aC5hYnMobikgPj0gMWU2KSByZXR1cm4gYCQkeyhuIC8gMWU2KS50b0ZpeGVkKDIpfU1gOwogIHJldHVybiBuLnRvTG9jYWxlU3RyaW5nKCJlbi1VUyIsIHsgc3R5bGU6ICJjdXJyZW5jeSIsIGN1cnJlbmN5OiAiVVNEIiwgbWluaW11bUZyYWN0aW9uRGlnaXRzOiAwLCBtYXhpbXVtRnJhY3Rpb25EaWdpdHM6IDAgfSk7Cn07CnZhciBmbXRFeGFjdCA9IChuKSA9PiBuLnRvTG9jYWxlU3RyaW5nKCJlbi1VUyIsIHsgc3R5bGU6ICJjdXJyZW5jeSIsIGN1cnJlbmN5OiAiVVNEIiwgbWluaW11bUZyYWN0aW9uRGlnaXRzOiAwLCBtYXhpbXVtRnJhY3Rpb25EaWdpdHM6IDAgfSk7CnZhciBmbXRQcmljZSA9IChuKSA9PiBuLnRvTG9jYWxlU3RyaW5nKCJlbi1VUyIsIHsgc3R5bGU6ICJjdXJyZW5jeSIsIGN1cnJlbmN5OiAiVVNEIiwgbWluaW11bUZyYWN0aW9uRGlnaXRzOiAyLCBtYXhpbXVtRnJhY3Rpb25EaWdpdHM6IDIgfSk7CnZhciBlbXB0eUJ1ZGdldCA9ICgpID0+ICh7CiAgaWQ6IGdlbmVyYXRlSWQoKSwKICBuYW1lOiAiTXkgQnVkZ2V0IFBsYW4iLAogIGluY29tZTogW10sCiAgZXhwZW5zZXM6IFtdLAogIGFzc2V0czogW10sCiAgbm9uTGlxdWlkQXNzZXRzOiBbXSwKICByZXRpcmVtZW50OiBbXSwKICBsaWFiaWxpdGllczogW10sCiAgbm9uTGlxdWlkRGlzY291bnQ6IDI1LAogIGNyZWF0ZWRBdDogRGF0ZS5ub3coKSwKICB1cGRhdGVkQXQ6IERhdGUubm93KCkKfSk7CnZhciBlbXB0eUl0ZW0gPSAoZnJlcSA9ICJtb250aGx5IikgPT4gKHsKICBpZDogZ2VuZXJhdGVJZCgpLAogIG5hbWU6ICIiLAogIGFtb3VudDogMCwKICBmcmVxdWVuY3k6IGZyZXEsCiAgdG90YWxWYWx1ZTogMCwKICBtb250aGx5VmFsdWU6IDAKfSk7CnZhciBjb21wdXRlVmFsdWVzID0gKGFtb3VudCwgZnJlcXVlbmN5KSA9PiB7CiAgc3dpdGNoIChmcmVxdWVuY3kpIHsKICAgIGNhc2UgIm1vbnRobHkiOgogICAgICByZXR1cm4geyB0b3RhbFZhbHVlOiBhbW91bnQgKiAxMiwgbW9udGhseVZhbHVlOiBhbW91bnQgfTsKICAgIGNhc2UgInllYXJseSI6CiAgICAgIHJldHVybiB7IHRvdGFsVmFsdWU6IGFtb3VudCwgbW9udGhseVZhbHVlOiBNYXRoLnJvdW5kKGFtb3VudCAvIDEyICogMTAwKSAvIDEwMCB9OwogICAgY2FzZSAib25lX3RpbWUiOgogICAgICByZXR1cm4geyB0b3RhbFZhbHVlOiBhbW91bnQsIG1vbnRobHlWYWx1ZTogMCB9OwogIH0KfTsKdmFyIEFQSV9CQVNFID0gKCgpID0+IHsKICB0cnkgewogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCA9PT0gImZpbGU6IikgewogICAgICByZXR1cm4gImh0dHBzOi8vbXktYnVkZ2V0LXBsYW5uZXIub25yZW5kZXIuY29tIjsKICAgIH0KICAgIHJldHVybiAiIjsKICB9IGNhdGNoIHsKICAgIHJldHVybiAiIjsKICB9Cn0pKCk7CnZhciB0cmFja0V2ZW50ID0gKGV2ZW50LCBkYXRhKSA9PiB7CiAgZmV0Y2goYCR7QVBJX0JBU0V9L2FwaS90cmFja2AsIHsKICAgIG1ldGhvZDogIlBPU1QiLAogICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sCiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGV2ZW50LCBkYXRhOiBkYXRhIHx8IHt9IH0pCiAgfSkuY2F0Y2goKCkgPT4gewogIH0pOwp9Owp2YXIgQ09JTkdFQ0tPX0JBU0UgPSAiaHR0cHM6Ly9hcGkuY29pbmdlY2tvLmNvbS9hcGkvdjMiOwp2YXIgc2VhcmNoQ29pbnMgPSBhc3luYyAocXVlcnkpID0+IHsKICBpZiAoIXF1ZXJ5IHx8IHF1ZXJ5Lmxlbmd0aCA8IDIpIHJldHVybiBbXTsKICB0cnkgewogICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2goYCR7Q09JTkdFQ0tPX0JBU0V9L3NlYXJjaD9xdWVyeT0ke2VuY29kZVVSSUNvbXBvbmVudChxdWVyeSl9YCk7CiAgICBpZiAoIXJlcy5vaykgcmV0dXJuIFtdOwogICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcy5qc29uKCk7CiAgICByZXR1cm4gKGRhdGEuY29pbnMgfHwgW10pLnNsaWNlKDAsIDgpLm1hcCgoYykgPT4gKHsKICAgICAgaWQ6IGMuaWQsCiAgICAgIG5hbWU6IGMubmFtZSwKICAgICAgc3ltYm9sOiBjLnN5bWJvbCwKICAgICAgdGh1bWI6IGMudGh1bWIKICAgIH0pKTsKICB9IGNhdGNoIHsKICAgIHJldHVybiBbXTsKICB9Cn07CnZhciBmZXRjaENyeXB0b1ByaWNlcyA9IGFzeW5jIChpZHMpID0+IHsKICBpZiAoaWRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHt9OwogIHRyeSB7CiAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaChgJHtDT0lOR0VDS09fQkFTRX0vc2ltcGxlL3ByaWNlP2lkcz0ke2lkcy5qb2luKCIsIil9JnZzX2N1cnJlbmNpZXM9dXNkYCk7CiAgICBpZiAoIXJlcy5vaykgcmV0dXJuIHt9OwogICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcy5qc29uKCk7CiAgICBjb25zdCBwcmljZXMgPSB7fTsKICAgIGZvciAoY29uc3QgaWQgb2YgaWRzKSB7CiAgICAgIGlmIChkYXRhW2lkXT8udXNkKSBwcmljZXNbaWRdID0gZGF0YVtpZF0udXNkOwogICAgfQogICAgcmV0dXJuIHByaWNlczsKICB9IGNhdGNoIHsKICAgIHJldHVybiB7fTsKICB9Cn07CnZhciBGSU5OSFVCX0tFWSA9ICJkNjUyZXRocjAxcXFibG41a2pqZ2Q2NTJldGhyMDFxcWJsbjVramswIjsKdmFyIGZldGNoU3RvY2tQcmljZXMgPSBhc3luYyAoc3ltYm9scykgPT4gewogIGlmIChzeW1ib2xzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHt9OwogIGNvbnN0IHJlc3VsdHMgPSB7fTsKICBhd2FpdCBQcm9taXNlLmFsbChzeW1ib2xzLm1hcChhc3luYyAoc3ltYm9sKSA9PiB7CiAgICB0cnkgewogICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaChgaHR0cHM6Ly9maW5uaHViLmlvL2FwaS92MS9xdW90ZT9zeW1ib2w9JHtzeW1ib2x9JnRva2VuPSR7RklOTkhVQl9LRVl9YCk7CiAgICAgIGlmICghcmVzLm9rKSByZXR1cm47CiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXMuanNvbigpOwogICAgICBpZiAoZGF0YS5jICYmIGRhdGEuYyA+IDApIHJlc3VsdHNbc3ltYm9sXSA9IGRhdGEuYzsKICAgIH0gY2F0Y2ggewogICAgfQogIH0pKTsKICByZXR1cm4gcmVzdWx0czsKfTsKdmFyIG1pID0gKG5hbWUsIGFtb3VudCwgZnJlcSA9ICJtb250aGx5IikgPT4gKHsKICBpZDogZ2VuZXJhdGVJZCgpLAogIG5hbWUsCiAgYW1vdW50LAogIGZyZXF1ZW5jeTogZnJlcSwKICB0b3RhbFZhbHVlOiBmcmVxID09PSAibW9udGhseSIgPyBhbW91bnQgKiAxMiA6IGZyZXEgPT09ICJ5ZWFybHkiID8gYW1vdW50IDogYW1vdW50LAogIG1vbnRobHlWYWx1ZTogZnJlcSA9PT0gIm1vbnRobHkiID8gYW1vdW50IDogZnJlcSA9PT0gInllYXJseSIgPyBNYXRoLnJvdW5kKGFtb3VudCAvIDEyKSA6IDAKfSk7CnZhciBtaWEgPSAobmFtZSwgYW1vdW50KSA9PiAoewogIGlkOiBnZW5lcmF0ZUlkKCksCiAgbmFtZSwKICBhbW91bnQsCiAgZnJlcXVlbmN5OiAib25lX3RpbWUiLAogIHRvdGFsVmFsdWU6IGFtb3VudCwKICBtb250aGx5VmFsdWU6IDAKfSk7CnZhciBCVURHRVRfUFJFU0VUUyA9IFsKICB7CiAgICAvLyBHZW4gWjogfjIyLTI4LCBtZWRpYW4gc2FsYXJ5IH4kNDBrLCB+JDIsODAwL21vIGFmdGVyIHRheAogICAga2V5OiAiZ2VuX3oiLAogICAgbGFiZWw6ICJHZW4gWiIsCiAgICBlbW9qaTogIlx1ezFGNEYxfSIsCiAgICBkZXNjOiAiU3RhcnRpbmcgb3V0LCBzaWRlIGh1c3RsZXMgJiBzdWJzY3JpcHRpb25zIiwKICAgIGJ1ZGdldDogewogICAgICBuYW1lOiAiR2VuIFogQnVkZ2V0IiwKICAgICAgaW5jb21lOiBbbWkoIlBhcnQtdGltZSAvIEZ1bGwtdGltZSBKb2IiLCAyNDAwKSwgbWkoIkZyZWVsYW5jZSAvIFNpZGUgSHVzdGxlIiwgNTAwKSwgbWkoIlRpcHMgLyBHaWcgV29yayIsIDIwMCldLAogICAgICBleHBlbnNlczogW21pKCJSZW50IChzaGFyZWQpIiwgOTUwKSwgbWkoIkdyb2NlcmllcyIsIDM1MCksIG1pKCJQaG9uZSBQbGFuIiwgODApLCBtaSgiU3RyZWFtaW5nIChOZXRmbGl4LCBTcG90aWZ5KSIsIDMwKSwgbWkoIkRpbmluZyBPdXQiLCAyMDApLCBtaSgiVWJlciAvIFRyYW5zaXQiLCAxMjApLCBtaSgiR3ltIE1lbWJlcnNoaXAiLCA0MCksIG1pKCJTdWJzY3JpcHRpb25zIChhcHBzKSIsIDI1KSwgbWkoIkNsb3RoaW5nIiwgNzUpLCBtaSgiRW50ZXJ0YWlubWVudCIsIDEwMCldLAogICAgICBhc3NldHM6IFttaWEoIlNhdmluZ3MgQWNjb3VudCIsIDI1MDApLCBtaWEoIlZlbm1vIC8gQ2FzaCBBcHAgQmFsYW5jZSIsIDMwMCksIG1pYSgiQ3J5cHRvIiwgNTAwKV0sCiAgICAgIG5vbkxpcXVpZEFzc2V0czogW21pYSgiTGFwdG9wIiwgMTIwMCksIG1pYSgiUGhvbmUiLCA4MDApXSwKICAgICAgcmV0aXJlbWVudDogW21pYSgiUm90aCBJUkEiLCAzZTMpXSwKICAgICAgbGlhYmlsaXRpZXM6IFttaWEoIlN0dWRlbnQgTG9hbnMiLCAyOGUzKSwgbWlhKCJDcmVkaXQgQ2FyZCBCYWxhbmNlIiwgMjUwMCksIG1pKCJCdXkgTm93IFBheSBMYXRlciIsIDUwKV0sCiAgICAgIG5vbkxpcXVpZERpc2NvdW50OiA1MAogICAgfQogIH0sCiAgewogICAgLy8gTWlsbGVubmlhbDogfjI5LTQzLCBtZWRpYW4gc2FsYXJ5IH4kNjVrLCB+JDQsMjAwL21vIGFmdGVyIHRheAogICAga2V5OiAibWlsbGVubmlhbCIsCiAgICBsYWJlbDogIk1pbGxlbm5pYWwiLAogICAgZW1vamk6ICJcdXsxRjRCQ30iLAogICAgZGVzYzogIkNhcmVlciBncm93dGgsIGJ1aWxkaW5nIHdlYWx0aCIsCiAgICBidWRnZXQ6IHsKICAgICAgbmFtZTogIk1pbGxlbm5pYWwgQnVkZ2V0IiwKICAgICAgaW5jb21lOiBbbWkoIlNhbGFyeSIsIDQyMDApLCBtaSgiQm9udXMiLCA1ZTMsICJ5ZWFybHkiKSwgbWkoIlNpZGUgUHJvamVjdCAvIEZyZWVsYW5jZSIsIDQwMCldLAogICAgICBleHBlbnNlczogW21pKCJSZW50IC8gTW9ydGdhZ2UiLCAxNTAwKSwgbWkoIkdyb2NlcmllcyIsIDQ1MCksIG1pKCJDYXIgUGF5bWVudCIsIDUwMCksIG1pKCJDYXIgSW5zdXJhbmNlIiwgMTUwKSwgbWkoIlV0aWxpdGllcyIsIDIwMCksIG1pKCJQaG9uZSBQbGFuIiwgODUpLCBtaSgiSW50ZXJuZXQiLCA3MCksIG1pKCJTdHJlYW1pbmcgU2VydmljZXMiLCA0NSksIG1pKCJEaW5pbmcgT3V0IiwgMjUwKSwgbWkoIkd5bSIsIDUwKSwgbWkoIlBldCBFeHBlbnNlcyIsIDEwMCksIG1pKCJUcmF2ZWwgRnVuZCIsIDIwMCldLAogICAgICBhc3NldHM6IFttaWEoIkNoZWNraW5nIEFjY291bnQiLCA0ZTMpLCBtaWEoIlNhdmluZ3MgQWNjb3VudCIsIDEyZTMpLCBtaWEoIkJyb2tlcmFnZSBBY2NvdW50IiwgMTVlMyksIG1pYSgiQ3J5cHRvIFBvcnRmb2xpbyIsIDNlMyldLAogICAgICBub25MaXF1aWRBc3NldHM6IFttaWEoIkNhciIsIDE4ZTMpLCBtaWEoIkZ1cm5pdHVyZSAmIEVsZWN0cm9uaWNzIiwgNWUzKV0sCiAgICAgIHJldGlyZW1lbnQ6IFttaWEoIjQwMWsiLCAzNWUzKSwgbWlhKCJSb3RoIElSQSIsIDEyZTMpXSwKICAgICAgbGlhYmlsaXRpZXM6IFttaWEoIlN0dWRlbnQgTG9hbnMiLCAyMmUzKSwgbWlhKCJDcmVkaXQgQ2FyZCBCYWxhbmNlIiwgNDUwMCksIG1pYSgiQ2FyIExvYW4iLCAxNWUzKV0sCiAgICAgIG5vbkxpcXVpZERpc2NvdW50OiAzMAogICAgfQogIH0sCiAgewogICAgLy8gRmFtaWx5OiBkdWFsIGluY29tZSwgMzUtNTQsIGNvbWJpbmVkIH4kOTRrIHByZS10YXgg4oaSIH4kNiw1MDAvbW8gYWZ0ZXIgdGF4CiAgICBrZXk6ICJmYW1pbHkiLAogICAgbGFiZWw6ICJGYW1pbHkiLAogICAgZW1vamk6ICJcdXsxRjQ2OH1cdTIwMERcdXsxRjQ2OX1cdTIwMERcdXsxRjQ2N31cdTIwMERcdXsxRjQ2Nn0iLAogICAgZGVzYzogIkR1YWwgaW5jb21lLCBraWRzLCBob21lIG93bmVyc2hpcCIsCiAgICBidWRnZXQ6IHsKICAgICAgbmFtZTogIkZhbWlseSBCdWRnZXQiLAogICAgICBpbmNvbWU6IFttaSgiU2FsYXJ5IChQcmltYXJ5KSIsIDRlMyksIG1pKCJTYWxhcnkgKFNwb3VzZSkiLCAzMjAwKSwgbWkoIkNoaWxkIFRheCBDcmVkaXQiLCAyNTApXSwKICAgICAgZXhwZW5zZXM6IFttaSgiTW9ydGdhZ2UiLCAyMTAwKSwgbWkoIlByb3BlcnR5IFRheCIsIDQ4MDAsICJ5ZWFybHkiKSwgbWkoIkhvbWVvd25lcidzIEluc3VyYW5jZSIsIDE4MDAsICJ5ZWFybHkiKSwgbWkoIkdyb2NlcmllcyIsIDcwMCksIG1pKCJVdGlsaXRpZXMiLCAzODApLCBtaSgiQ2hpbGRjYXJlIC8gRGF5Y2FyZSIsIDEyMDApLCBtaSgiS2lkcyBBY3Rpdml0aWVzIiwgMTUwKSwgbWkoIkNhciBQYXltZW50IiwgNTUwKSwgbWkoIkNhciBJbnN1cmFuY2UiLCAyMDApLCBtaSgiR2FzIiwgMTgwKSwgbWkoIlBob25lIFBsYW5zIiwgMTQwKSwgbWkoIkludGVybmV0IiwgNzUpLCBtaSgiU3RyZWFtaW5nIiwgNTApLCBtaSgiRGluaW5nIE91dCIsIDI1MCksIG1pKCJDbG90aGluZyIsIDE3MCksIG1pKCJNZWRpY2FsIC8gQ29wYXlzIiwgMTAwKSwgbWkoIlNjaG9vbCBTdXBwbGllcyIsIDUwKV0sCiAgICAgIGFzc2V0czogW21pYSgiQ2hlY2tpbmcgQWNjb3VudCIsIDZlMyksIG1pYSgiSm9pbnQgU2F2aW5ncyIsIDI1ZTMpLCBtaWEoIjUyOSBDb2xsZWdlIEZ1bmQiLCAxOGUzKSwgbWlhKCJCcm9rZXJhZ2UgQWNjb3VudCIsIDNlNCldLAogICAgICBub25MaXF1aWRBc3NldHM6IFttaWEoIkhvbWUgRXF1aXR5IiwgMTJlNCksIG1pYSgiQ2FyIChQcmltYXJ5KSIsIDIyZTMpLCBtaWEoIkNhciAoU3BvdXNlKSIsIDE1ZTMpXSwKICAgICAgcmV0aXJlbWVudDogW21pYSgiNDAxayAoUHJpbWFyeSkiLCA2NWUzKSwgbWlhKCI0MDFrIChTcG91c2UpIiwgNGU0KSwgbWlhKCJSb3RoIElSQSIsIDE1ZTMpXSwKICAgICAgbGlhYmlsaXRpZXM6IFttaWEoIk1vcnRnYWdlIEJhbGFuY2UiLCAyOGU0KSwgbWlhKCJDYXIgTG9hbiIsIDE4ZTMpLCBtaWEoIkNyZWRpdCBDYXJkIiwgNmUzKSwgbWlhKCJNZWRpY2FsIEJpbGxzIiwgMmUzKV0sCiAgICAgIG5vbkxpcXVpZERpc2NvdW50OiAyMAogICAgfQogIH0sCiAgewogICAgLy8gUmV0aXJlZTogNjUrLCBhdmcgU1MgfiQxLDkwNy9tbywgc3BlbmRpbmcgfiQ0LDYwMC9tbwogICAga2V5OiAicmV0aXJlZSIsCiAgICBsYWJlbDogIlJldGlyZWUiLAogICAgZW1vamk6ICJcdXsxRjNENn1cdUZFMEYiLAogICAgZGVzYzogIkZpeGVkIGluY29tZSwgbG93IGRlYnQsIGVuam95aW5nIGxpZmUiLAogICAgYnVkZ2V0OiB7CiAgICAgIG5hbWU6ICJSZXRpcmVlIEJ1ZGdldCIsCiAgICAgIGluY29tZTogW21pKCJTb2NpYWwgU2VjdXJpdHkiLCAxOTAwKSwgbWkoIlBlbnNpb24iLCAxNTAwKSwgbWkoIlJldGlyZW1lbnQgV2l0aGRyYXdhbHMiLCAxMjAwKSwgbWkoIlJlbnRhbCBJbmNvbWUiLCA4MDApXSwKICAgICAgZXhwZW5zZXM6IFttaSgiTW9ydGdhZ2UgLyBSZW50IiwgMTIwMCksIG1pKCJVdGlsaXRpZXMiLCAzMDApLCBtaSgiR3JvY2VyaWVzIiwgNTAwKSwgbWkoIk1lZGljYXJlIC8gSGVhbHRoIEluc3VyYW5jZSIsIDM0MCksIG1pKCJQcmVzY3JpcHRpb25zIiwgMTUwKSwgbWkoIkNhciBJbnN1cmFuY2UiLCAxMjApLCBtaSgiR2FzIiwgMTAwKSwgbWkoIlBob25lIiwgNjApLCBtaSgiSW50ZXJuZXQgLyBDYWJsZSIsIDkwKSwgbWkoIkRpbmluZyBPdXQiLCAyMDApLCBtaSgiVHJhdmVsIC8gVmFjYXRpb25zIiwgMzAwKSwgbWkoIkhvYmJpZXMiLCAxMDApLCBtaSgiR2lmdHMgLyBEb25hdGlvbnMiLCAxNTApXSwKICAgICAgYXNzZXRzOiBbbWlhKCJDaGVja2luZyBBY2NvdW50IiwgOGUzKSwgbWlhKCJTYXZpbmdzIEFjY291bnQiLCA0NWUzKSwgbWlhKCJDRHMgLyBCb25kcyIsIDVlNCksIG1pYSgiQnJva2VyYWdlIEFjY291bnQiLCA4ZTQpXSwKICAgICAgbm9uTGlxdWlkQXNzZXRzOiBbbWlhKCJIb21lIiwgM2U1KSwgbWlhKCJDYXIiLCAxNWUzKSwgbWlhKCJKZXdlbHJ5IC8gQ29sbGVjdGlibGVzIiwgMWU0KV0sCiAgICAgIHJldGlyZW1lbnQ6IFttaWEoIjQwMWsgLyBJUkEiLCAyNWU0KSwgbWlhKCJQZW5zaW9uIEZ1bmQiLCAxNWU0KSwgbWlhKCJBbm51aXR5IiwgNzVlMyldLAogICAgICBsaWFiaWxpdGllczogW21pYSgiTW9ydGdhZ2UgQmFsYW5jZSIsIDg1ZTMpLCBtaWEoIk1lZGljYWwgQmlsbHMiLCAzZTMpXSwKICAgICAgbm9uTGlxdWlkRGlzY291bnQ6IDIwCiAgICB9CiAgfQpdOwp2YXIgbWlncmF0ZUl0ZW0gPSAoaXRlbSkgPT4gewogIGlmIChpdGVtLmFtb3VudCAhPT0gdm9pZCAwICYmIGl0ZW0uZnJlcXVlbmN5ICE9PSB2b2lkIDApIHJldHVybiBpdGVtOwogIGlmIChpdGVtLm1vbnRobHlWYWx1ZSAmJiBpdGVtLm1vbnRobHlWYWx1ZSA+IDApIHsKICAgIHJldHVybiB7IC4uLml0ZW0sIGFtb3VudDogaXRlbS5tb250aGx5VmFsdWUsIGZyZXF1ZW5jeTogIm1vbnRobHkiIH07CiAgfQogIHJldHVybiB7IC4uLml0ZW0sIGFtb3VudDogaXRlbS50b3RhbFZhbHVlIHx8IDAsIGZyZXF1ZW5jeTogIm9uZV90aW1lIiB9Owp9Owp2YXIgbWlncmF0ZUJ1ZGdldCA9IChiKSA9PiAoewogIC4uLmIsCiAgaW5jb21lOiAoYi5pbmNvbWUgfHwgW10pLm1hcChtaWdyYXRlSXRlbSksCiAgZXhwZW5zZXM6IChiLmV4cGVuc2VzIHx8IFtdKS5tYXAobWlncmF0ZUl0ZW0pLAogIGFzc2V0czogKGIuYXNzZXRzIHx8IFtdKS5tYXAobWlncmF0ZUl0ZW0pLAogIG5vbkxpcXVpZEFzc2V0czogKGIubm9uTGlxdWlkQXNzZXRzIHx8IFtdKS5tYXAobWlncmF0ZUl0ZW0pLAogIHJldGlyZW1lbnQ6IChiLnJldGlyZW1lbnQgfHwgW10pLm1hcChtaWdyYXRlSXRlbSksCiAgbGlhYmlsaXRpZXM6IChiLmxpYWJpbGl0aWVzIHx8IFtdKS5tYXAobWlncmF0ZUl0ZW0pCn0pOwp2YXIgbG9hZEJ1ZGdldHMgPSAoKSA9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IGRhdGEgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShCVURHRVRTX0xJU1RfS0VZKTsKICAgIGlmIChkYXRhKSByZXR1cm4gSlNPTi5wYXJzZShkYXRhKS5tYXAobWlncmF0ZUJ1ZGdldCk7CiAgfSBjYXRjaCB7CiAgfQogIHJldHVybiBbXTsKfTsKdmFyIHNhdmVCdWRnZXRzID0gKGJ1ZGdldHMpID0+IHsKICB0cnkgewogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oQlVER0VUU19MSVNUX0tFWSwgSlNPTi5zdHJpbmdpZnkoYnVkZ2V0cykpOwogIH0gY2F0Y2ggewogIH0KfTsKdmFyIGxvYWRDdXJyZW50QnVkZ2V0ID0gKCkgPT4gewogIHRyeSB7CiAgICBjb25zdCBkYXRhID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oU1RPUkFHRV9LRVkyKTsKICAgIGlmIChkYXRhKSByZXR1cm4gbWlncmF0ZUJ1ZGdldChKU09OLnBhcnNlKGRhdGEpKTsKICB9IGNhdGNoIHsKICB9CiAgcmV0dXJuIG51bGw7Cn07CnZhciBzYXZlQ3VycmVudEJ1ZGdldCA9IChidWRnZXQpID0+IHsKICB0cnkgewogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oU1RPUkFHRV9LRVkyLCBKU09OLnN0cmluZ2lmeShidWRnZXQpKTsKICB9IGNhdGNoIHsKICB9Cn07CnZhciBQUkVTRVRTID0gewogIGluY29tZTogWwogICAgeyBuYW1lOiAiV29yayBTYWxhcnkiLCBlbW9qaTogIlx1ezFGNEJDfSIgfSwKICAgIHsgbmFtZTogIkZyZWVsYW5jZSBJbmNvbWUiLCBlbW9qaTogIlx1ezFGNEJCfSIgfSwKICAgIHsgbmFtZTogIlJlbnRhbCBJbmNvbWUiLCBlbW9qaTogIlx1ezFGM0UwfSIgfSwKICAgIHsgbmFtZTogIkludmVzdG1lbnQgRGl2aWRlbmRzIiwgZW1vamk6ICJcdXsxRjRDOH0iIH0sCiAgICB7IG5hbWU6ICJHb3Zlcm5tZW50IEJlbmVmaXRzIiwgZW1vamk6ICJcdXsxRjNEQn1cdUZFMEYiIH0sCiAgICB7IG5hbWU6ICJTaWRlIEJ1c2luZXNzIiwgZW1vamk6ICJcdXsxRjNFQX0iIH0sCiAgICB7IG5hbWU6ICJQZW5zaW9uIiwgZW1vamk6ICJcdXsxRjlEM30iIH0KICBdLAogIGV4cGVuc2VzOiBbCiAgICB7IG5hbWU6ICJSZW50IiwgZW1vamk6ICJcdXsxRjNFMH0iIH0sCiAgICB7IG5hbWU6ICJNb3J0Z2FnZSBQYXltZW50IiwgZW1vamk6ICJcdXsxRjNFNn0iIH0sCiAgICB7IG5hbWU6ICJVdGlsaXRpZXMiLCBlbW9qaTogIlx1ezFGNEExfSIgfSwKICAgIHsgbmFtZTogIkdyb2NlcmllcyIsIGVtb2ppOiAiXHV7MUY2RDJ9IiB9LAogICAgeyBuYW1lOiAiQ2FyIFBheW1lbnQiLCBlbW9qaTogIlx1ezFGNjk3fSIgfSwKICAgIHsgbmFtZTogIkluc3VyYW5jZSIsIGVtb2ppOiAiXHV7MUY2RTF9XHVGRTBGIiB9LAogICAgeyBuYW1lOiAiU3Vic2NyaXB0aW9ucyIsIGVtb2ppOiAiXHV7MUY0RkF9IiB9LAogICAgeyBuYW1lOiAiUGhvbmUgQmlsbCIsIGVtb2ppOiAiXHV7MUY0RjF9IiB9LAogICAgeyBuYW1lOiAiSW50ZXJuZXQiLCBlbW9qaTogIlx1ezFGMzEwfSIgfSwKICAgIHsgbmFtZTogIkdhcy9UcmFuc3BvcnRhdGlvbiIsIGVtb2ppOiAiXHUyNkZEIiB9CiAgXSwKICBhc3NldHM6IFsKICAgIHsgbmFtZTogIkNoZWNraW5nIEFjY291bnQiLCBlbW9qaTogIlx1ezFGM0U2fSIgfSwKICAgIHsgbmFtZTogIlNhdmluZ3MgQWNjb3VudCIsIGVtb2ppOiAiXHV7MUY0QjB9IiB9LAogICAgeyBuYW1lOiAiU3RvY2tzL0Jyb2tlcmFnZSIsIGVtb2ppOiAiXHV7MUY0Q0F9IiwgcGVyc2lzdGVudDogdHJ1ZSwgYXNzZXRUeXBlOiAic3RvY2siIH0sCiAgICB7IG5hbWU6ICJDcnlwdG8iLCBlbW9qaTogIlx1MjBCRiIgfSwKICAgIHsgbmFtZTogIjQwMWsvUmV0aXJlbWVudCIsIGVtb2ppOiAiXHV7MUY5RDN9IiB9LAogICAgeyBuYW1lOiAiRW1lcmdlbmN5IEZ1bmQiLCBlbW9qaTogIlx1ezFGMTk4fSIgfSwKICAgIHsgbmFtZTogIkNEL0JvbmRzIiwgZW1vamk6ICJcdXsxRjREQ30iIH0KICBdLAogIG5vbkxpcXVpZEFzc2V0czogWwogICAgeyBuYW1lOiAiSG9tZSBWYWx1ZSIsIGVtb2ppOiAiXHV7MUYzRTF9IiB9LAogICAgeyBuYW1lOiAiQ2FyIFZhbHVlIiwgZW1vamk6ICJcdXsxRjY5N30iIH0sCiAgICB7IG5hbWU6ICJKZXdlbHJ5L1dhdGNoZXMiLCBlbW9qaTogIlx1ezFGNDhFfSIgfSwKICAgIHsgbmFtZTogIkFydC9Db2xsZWN0aWJsZXMiLCBlbW9qaTogIlx1ezFGM0E4fSIgfSwKICAgIHsgbmFtZTogIkJ1c2luZXNzIEVxdWl0eSIsIGVtb2ppOiAiXHV7MUYzRTJ9IiB9LAogICAgeyBuYW1lOiAiRnVybml0dXJlL0VsZWN0cm9uaWNzIiwgZW1vamk6ICJcdXsxRkE5MX0iIH0KICBdLAogIHJldGlyZW1lbnQ6IFsKICAgIHsgbmFtZTogIjQwMWsiLCBlbW9qaTogIlx1ezFGM0U2fSIgfSwKICAgIHsgbmFtZTogIlJvdGggSVJBIiwgZW1vamk6ICJcdXsxRjRDQX0iIH0sCiAgICB7IG5hbWU6ICJUcmFkaXRpb25hbCBJUkEiLCBlbW9qaTogIlx1ezFGNEM4fSIgfSwKICAgIHsgbmFtZTogIlBlbnNpb24gRnVuZCIsIGVtb2ppOiAiXHV7MUY5RDN9IiB9LAogICAgeyBuYW1lOiAiU0VQIElSQSIsIGVtb2ppOiAiXHV7MUY0QkN9IiB9LAogICAgeyBuYW1lOiAiNDAzYiIsIGVtb2ppOiAiXHV7MUYzRUJ9IiB9CiAgXSwKICBsaWFiaWxpdGllczogWwogICAgeyBuYW1lOiAiTW9ydGdhZ2UiLCBlbW9qaTogIlx1ezFGM0U2fSIgfSwKICAgIHsgbmFtZTogIkNhciBMb2FuIiwgZW1vamk6ICJcdXsxRjY5N30iIH0sCiAgICB7IG5hbWU6ICJTdHVkZW50IExvYW5zIiwgZW1vamk6ICJcdXsxRjM5M30iIH0sCiAgICB7IG5hbWU6ICJDcmVkaXQgQ2FyZCBEZWJ0IiwgZW1vamk6ICJcdXsxRjRCM30iIH0sCiAgICB7IG5hbWU6ICJQZXJzb25hbCBMb2FuIiwgZW1vamk6ICJcdXsxRjkxRH0iIH0sCiAgICB7IG5hbWU6ICJNZWRpY2FsIERlYnQiLCBlbW9qaTogIlx1ezFGM0U1fSIgfSwKICAgIHsgbmFtZTogIlBlcnNvbmFsIEV4cGVuc2VzIiwgZW1vamk6ICJcdXsxRjZDRH1cdUZFMEYiIH0KICBdCn07CnZhciBTZWN0aW9uSGVhZGVyID0gKHsgdGl0bGUsIGljb24sIGNvbG9yOiBjb2xvcjIsIGJnQ29sb3IsIHRvdGFsLCBtb250aGx5VG90YWwsIGNvdW50LCBpc09wZW4sIG9uVG9nZ2xlIH0pID0+IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBvblRvZ2dsZSwgc3R5bGU6IHsKICB3aWR0aDogIjEwMCUiLAogIGRpc3BsYXk6ICJmbGV4IiwKICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLAogIHBhZGRpbmc6ICIxNHB4IDE2cHgiLAogIGJvcmRlcjogIm5vbmUiLAogIGJvcmRlclJhZGl1czogMTIsCiAgY3Vyc29yOiAicG9pbnRlciIsCiAgYmFja2dyb3VuZENvbG9yOiBiZ0NvbG9yLAogIHRyYW5zaXRpb246ICJhbGwgMC4ycyIKfSwgY2hpbGRyZW46IFsKICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAxMCB9LCBjaGlsZHJlbjogWwogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6IDM2LCBoZWlnaHQ6IDM2LCBib3JkZXJSYWRpdXM6IDEwLCBiYWNrZ3JvdW5kQ29sb3I6IGNvbG9yMiwgY29sb3I6ICJ3aGl0ZSIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiB9LCBjaGlsZHJlbjogaWNvbiB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyB0ZXh0QWxpZ246ICJsZWZ0IiB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTUsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUzIudGV4dE1haW4gfSwgY2hpbGRyZW46IHRpdGxlIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgY291bnQsCiAgICAgICAgIiBpdGVtIiwKICAgICAgICBjb3VudCAhPT0gMSA/ICJzIiA6ICIiCiAgICAgIF0gfSkKICAgIF0gfSkKICBdIH0pLAogIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgdGV4dEFsaWduOiAicmlnaHQiIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNiwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogY29sb3IyIH0sIGNoaWxkcmVuOiBmbXQodG90YWwpIH0pLAogICAgICBtb250aGx5VG90YWwgIT09IHZvaWQgMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgZm10KG1vbnRobHlUb3RhbCksCiAgICAgICAgIi9tbyIKICAgICAgXSB9KQogICAgXSB9KSwKICAgIGlzT3BlbiA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKENoZXZyb25VcCwgeyBzaXplOiAxOCwgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSB9KSA6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKENoZXZyb25Eb3duLCB7IHNpemU6IDE4LCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5IH0pCiAgXSB9KQpdIH0pOwp2YXIgQ29pblNlYXJjaERyb3Bkb3duID0gKHsgb25TZWxlY3QsIGlucHV0U3R5bGU6IGlucHV0U3R5bGUyIH0pID0+IHsKICBjb25zdCBbcXVlcnksIHNldFF1ZXJ5XSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFtyZXN1bHRzLCBzZXRSZXN1bHRzXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoW10pOwogIGNvbnN0IFtsb2FkaW5nLCBzZXRMb2FkaW5nXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoZmFsc2UpOwogIGNvbnN0IFtzaG93RHJvcGRvd24sIHNldFNob3dEcm9wZG93bl0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCB0aW1lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VSZWYpKG51bGwpOwogIGNvbnN0IGNvbnRhaW5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VSZWYpKG51bGwpOwogICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VFZmZlY3QpKCgpID0+IHsKICAgIGNvbnN0IGhhbmRsZUNsaWNrT3V0c2lkZSA9IChlKSA9PiB7CiAgICAgIGlmIChjb250YWluZXJSZWYuY3VycmVudCAmJiAhY29udGFpbmVyUmVmLmN1cnJlbnQuY29udGFpbnMoZS50YXJnZXQpKSBzZXRTaG93RHJvcGRvd24oZmFsc2UpOwogICAgfTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIGhhbmRsZUNsaWNrT3V0c2lkZSk7CiAgICByZXR1cm4gKCkgPT4gZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigibW91c2Vkb3duIiwgaGFuZGxlQ2xpY2tPdXRzaWRlKTsKICB9LCBbXSk7CiAgY29uc3QgaGFuZGxlU2VhcmNoID0gKHZhbCkgPT4gewogICAgc2V0UXVlcnkodmFsKTsKICAgIGlmICh0aW1lclJlZi5jdXJyZW50KSBjbGVhclRpbWVvdXQodGltZXJSZWYuY3VycmVudCk7CiAgICBpZiAodmFsLmxlbmd0aCA8IDIpIHsKICAgICAgc2V0UmVzdWx0cyhbXSk7CiAgICAgIHNldFNob3dEcm9wZG93bihmYWxzZSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHNldExvYWRpbmcodHJ1ZSk7CiAgICB0aW1lclJlZi5jdXJyZW50ID0gc2V0VGltZW91dChhc3luYyAoKSA9PiB7CiAgICAgIGNvbnN0IGNvaW5zID0gYXdhaXQgc2VhcmNoQ29pbnModmFsKTsKICAgICAgc2V0UmVzdWx0cyhjb2lucyk7CiAgICAgIHNldFNob3dEcm9wZG93bihjb2lucy5sZW5ndGggPiAwKTsKICAgICAgc2V0TG9hZGluZyhmYWxzZSk7CiAgICB9LCAzMDApOwogIH07CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyByZWY6IGNvbnRhaW5lclJlZiwgc3R5bGU6IHsgcG9zaXRpb246ICJyZWxhdGl2ZSIgfSwgY2hpbGRyZW46IFsKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwb3NpdGlvbjogInJlbGF0aXZlIiB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShTZWFyY2gsIHsgc2l6ZTogMTQsIHN0eWxlOiB7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCBsZWZ0OiA4LCB0b3A6ICI1MCUiLCB0cmFuc2Zvcm06ICJ0cmFuc2xhdGVZKC01MCUpIiwgY29sb3I6IENPTE9SUzIudGV4dE11dGVkIH0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKAogICAgICAgICJpbnB1dCIsCiAgICAgICAgewogICAgICAgICAgc3R5bGU6IHsgLi4uaW5wdXRTdHlsZTIsIHBhZGRpbmdMZWZ0OiAyOCB9LAogICAgICAgICAgdmFsdWU6IHF1ZXJ5LAogICAgICAgICAgb25DaGFuZ2U6IChlKSA9PiBoYW5kbGVTZWFyY2goZS50YXJnZXQudmFsdWUpLAogICAgICAgICAgb25Gb2N1czogKCkgPT4gewogICAgICAgICAgICBpZiAocmVzdWx0cy5sZW5ndGggPiAwKSBzZXRTaG93RHJvcGRvd24odHJ1ZSk7CiAgICAgICAgICB9LAogICAgICAgICAgcGxhY2Vob2xkZXI6ICJTZWFyY2ggY3J5cHRvIChlLmcuIGJpdGNvaW4pIgogICAgICAgIH0KICAgICAgKSwKICAgICAgbG9hZGluZyAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShMb2FkZXJDaXJjbGUsIHsgc2l6ZTogMTQsIHN0eWxlOiB7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCByaWdodDogOCwgdG9wOiAiNTAlIiwgdHJhbnNmb3JtOiAidHJhbnNsYXRlWSgtNTAlKSIsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgYW5pbWF0aW9uOiAic3BpbiAxcyBsaW5lYXIgaW5maW5pdGUiIH0gfSkKICAgIF0gfSksCiAgICBzaG93RHJvcGRvd24gJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgICAgIHRvcDogIjEwMCUiLAogICAgICBsZWZ0OiAwLAogICAgICByaWdodDogMCwKICAgICAgekluZGV4OiA1MCwKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLmNhcmQsCiAgICAgIGJvcmRlclJhZGl1czogOCwKICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJ9YCwKICAgICAgYm94U2hhZG93OiAiMCA0cHggMTJweCByZ2JhKDAsMCwwLDAuMSkiLAogICAgICBtYXhIZWlnaHQ6IDIwMCwKICAgICAgb3ZlcmZsb3dZOiAiYXV0byIsCiAgICAgIG1hcmdpblRvcDogMgogICAgfSwgY2hpbGRyZW46IHJlc3VsdHMubWFwKChjb2luKSA9PiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoCiAgICAgICJidXR0b24iLAogICAgICB7CiAgICAgICAgb25DbGljazogKCkgPT4gewogICAgICAgICAgb25TZWxlY3QoY29pbik7CiAgICAgICAgICBzZXRRdWVyeSgiIik7CiAgICAgICAgICBzZXRTaG93RHJvcGRvd24oZmFsc2UpOwogICAgICAgICAgc2V0UmVzdWx0cyhbXSk7CiAgICAgICAgfSwKICAgICAgICBzdHlsZTogewogICAgICAgICAgd2lkdGg6ICIxMDAlIiwKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgZ2FwOiA4LAogICAgICAgICAgcGFkZGluZzogIjhweCAxMHB4IiwKICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICB0ZXh0QWxpZ246ICJsZWZ0IiwKICAgICAgICAgIGZvbnRTaXplOiAxMywKICAgICAgICAgIGNvbG9yOiBDT0xPUlMyLnRleHRNYWluLAogICAgICAgICAgYm9yZGVyQm90dG9tOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJMaWdodH1gCiAgICAgICAgfSwKICAgICAgICBvbk1vdXNlRW50ZXI6IChlKSA9PiB7CiAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gQ09MT1JTMi5hc3NldEJnOwogICAgICAgIH0sCiAgICAgICAgb25Nb3VzZUxlYXZlOiAoZSkgPT4gewogICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICJ0cmFuc3BhcmVudCI7CiAgICAgICAgfSwKICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImltZyIsIHsgc3JjOiBjb2luLnRodW1iLCBhbHQ6ICIiLCBzdHlsZTogeyB3aWR0aDogMjAsIGhlaWdodDogMjAsIGJvcmRlclJhZGl1czogMTAgfSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA2MDAgfSwgY2hpbGRyZW46IGNvaW4ubmFtZSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsIGZvbnRTaXplOiAxMSwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIgfSwgY2hpbGRyZW46IGNvaW4uc3ltYm9sIH0pCiAgICAgICAgXQogICAgICB9LAogICAgICBjb2luLmlkCiAgICApKSB9KQogIF0gfSk7Cn07CnZhciBTdG9ja1RpY2tlcklucHV0ID0gKHsgZHJhZnQsIHNldERyYWZ0LCBpbnB1dFN0eWxlOiBpbnB1dFN0eWxlMiwgY29sb3I6IGNvbG9yMiB9KSA9PiB7CiAgY29uc3QgW2ZldGNoaW5nLCBzZXRGZXRjaGluZ10gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbdGlja2VySW5wdXQsIHNldFRpY2tlcklucHV0XSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoZHJhZnQudGlja2VyIHx8ICIiKTsKICBjb25zdCBbcHJpY2VJbnB1dCwgc2V0UHJpY2VJbnB1dF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGRyYWZ0LmxpdmVQcmljZSA/IFN0cmluZyhkcmFmdC5saXZlUHJpY2UpIDogIiIpOwogIGNvbnN0IGRlYm91bmNlUmVmID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVJlZikobnVsbCk7CiAgY29uc3QgcmVjYWxjQW1vdW50ID0gKHByaWNlLCBxdHkpID0+IE1hdGgucm91bmQocHJpY2UgKiBxdHkgKiAxMDApIC8gMTAwOwogICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChkZWJvdW5jZVJlZi5jdXJyZW50KSBjbGVhclRpbWVvdXQoZGVib3VuY2VSZWYuY3VycmVudCk7CiAgICBjb25zdCBzeW1ib2wgPSB0aWNrZXJJbnB1dC50cmltKCk7CiAgICBpZiAoc3ltYm9sLmxlbmd0aCA8IDEpIHsKICAgICAgc2V0RHJhZnQoKGQpID0+ICh7IC4uLmQsIHRpY2tlcjogdm9pZCAwLCBsaXZlUHJpY2U6IHZvaWQgMCwgbmFtZTogIiIgfSkpOwogICAgICByZXR1cm47CiAgICB9CiAgICBzZXREcmFmdCgoZCkgPT4gKHsgLi4uZCwgdGlja2VyOiBzeW1ib2wsIG5hbWU6IHN5bWJvbCB9KSk7CiAgICBpZiAoc3ltYm9sLmxlbmd0aCA8IDIpIHJldHVybjsKICAgIGRlYm91bmNlUmVmLmN1cnJlbnQgPSBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsKICAgICAgc2V0RmV0Y2hpbmcodHJ1ZSk7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgcHJpY2VzID0gYXdhaXQgZmV0Y2hTdG9ja1ByaWNlcyhbc3ltYm9sXSk7CiAgICAgICAgaWYgKHByaWNlc1tzeW1ib2xdKSB7CiAgICAgICAgICBjb25zdCBwcmljZSA9IHByaWNlc1tzeW1ib2xdOwogICAgICAgICAgc2V0UHJpY2VJbnB1dChTdHJpbmcocHJpY2UpKTsKICAgICAgICAgIHNldERyYWZ0KChkKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IG5ld0Ftb3VudCA9IGQucXVhbnRpdHkgPyByZWNhbGNBbW91bnQocHJpY2UsIGQucXVhbnRpdHkpIDogcHJpY2U7CiAgICAgICAgICAgIHJldHVybiB7IC4uLmQsIGxpdmVQcmljZTogcHJpY2UsIGFtb3VudDogbmV3QW1vdW50IH07CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggewogICAgICB9CiAgICAgIHNldEZldGNoaW5nKGZhbHNlKTsKICAgIH0sIDYwMCk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAoZGVib3VuY2VSZWYuY3VycmVudCkgY2xlYXJUaW1lb3V0KGRlYm91bmNlUmVmLmN1cnJlbnQpOwogICAgfTsKICB9LCBbdGlja2VySW5wdXRdKTsKICBjb25zdCBoYXNUaWNrZXIgPSB0aWNrZXJJbnB1dC50cmltKCkubGVuZ3RoID49IDE7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiVGlja2VyIFN5bWJvbCIgfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgImlucHV0IiwKICAgICAgewogICAgICAgIHN0eWxlOiB7IC4uLmlucHV0U3R5bGUyLCB0ZXh0VHJhbnNmb3JtOiAidXBwZXJjYXNlIiB9LAogICAgICAgIHZhbHVlOiB0aWNrZXJJbnB1dCwKICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldFRpY2tlcklucHV0KGUudGFyZ2V0LnZhbHVlLnRvVXBwZXJDYXNlKCkucmVwbGFjZSgvW15BLVouXS9nLCAiIikpLAogICAgICAgIHBsYWNlaG9sZGVyOiAiZS5nLiBBQVBMLCBUU0xBLCBWT08iLAogICAgICAgIGF1dG9Gb2N1czogdHJ1ZQogICAgICB9CiAgICApLAogICAgZmV0Y2hpbmcgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgY29sb3I6ICIjMjU2M0VCIiwgbWFyZ2luVG9wOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICJMb29raW5nIHVwICIsCiAgICAgIHRpY2tlcklucHV0LAogICAgICAiLi4uIgogICAgXSB9KSwKICAgIGhhc1RpY2tlciAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImdyaWQiLCBncmlkVGVtcGxhdGVDb2x1bW5zOiAiMWZyIDFmciIsIGdhcDogOCwgbWFyZ2luVG9wOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiUHJpY2UgLyBTaGFyZSIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogaW5wdXRTdHlsZTIsCiAgICAgICAgICAgIHR5cGU6ICJudW1iZXIiLAogICAgICAgICAgICBzdGVwOiAiYW55IiwKICAgICAgICAgICAgdmFsdWU6IHByaWNlSW5wdXQsCiAgICAgICAgICAgIG9uQ2hhbmdlOiAoZSkgPT4gewogICAgICAgICAgICAgIHNldFByaWNlSW5wdXQoZS50YXJnZXQudmFsdWUpOwogICAgICAgICAgICAgIGNvbnN0IHByaWNlID0gcGFyc2VGbG9hdChlLnRhcmdldC52YWx1ZSkgfHwgMDsKICAgICAgICAgICAgICBjb25zdCBxdHkgPSBkcmFmdC5xdWFudGl0eSB8fCAwOwogICAgICAgICAgICAgIHNldERyYWZ0KChkKSA9PiAoeyAuLi5kLCBsaXZlUHJpY2U6IHByaWNlIHx8IHZvaWQgMCwgYW1vdW50OiBxdHkgPiAwICYmIHByaWNlID4gMCA/IHJlY2FsY0Ftb3VudChwcmljZSwgcXR5KSA6IHByaWNlIH0pKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgcGxhY2Vob2xkZXI6ICIkMC4wMCIKICAgICAgICAgIH0KICAgICAgICApCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiU2hhcmVzIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiBpbnB1dFN0eWxlMiwKICAgICAgICAgICAgdHlwZTogIm51bWJlciIsCiAgICAgICAgICAgIHN0ZXA6ICJhbnkiLAogICAgICAgICAgICB2YWx1ZTogZHJhZnQucXVhbnRpdHkgfHwgIiIsCiAgICAgICAgICAgIG9uQ2hhbmdlOiAoZSkgPT4gewogICAgICAgICAgICAgIGNvbnN0IHF0eSA9IHBhcnNlRmxvYXQoZS50YXJnZXQudmFsdWUpIHx8IDA7CiAgICAgICAgICAgICAgY29uc3QgcHJpY2UgPSBwYXJzZUZsb2F0KHByaWNlSW5wdXQpIHx8IDA7CiAgICAgICAgICAgICAgY29uc3QgbmV3QW1vdW50ID0gcXR5ID4gMCAmJiBwcmljZSA+IDAgPyByZWNhbGNBbW91bnQocHJpY2UsIHF0eSkgOiBkcmFmdC5hbW91bnQ7CiAgICAgICAgICAgICAgc2V0RHJhZnQoKGQpID0+ICh7IC4uLmQsIHF1YW50aXR5OiBxdHkgfHwgdm9pZCAwLCBhbW91bnQ6IG5ld0Ftb3VudCB9KSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAiUXR5IgogICAgICAgICAgfQogICAgICAgICkKICAgICAgXSB9KQogICAgXSB9KSwKICAgIGhhc1RpY2tlciAmJiBkcmFmdC5saXZlUHJpY2UgJiYgZHJhZnQucXVhbnRpdHkgJiYgZHJhZnQucXVhbnRpdHkgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksIG1hcmdpblRvcDogNiwgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBwYWRkaW5nOiAiNnB4IDEwcHgiLCBiYWNrZ3JvdW5kQ29sb3I6ICIjMjU2M0VCMTAiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogIjFweCBzb2xpZCAjMjU2M0VCMzAiIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgic3BhbiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAiXHV7MUY0Qzh9ICIsCiAgICAgICAgZHJhZnQudGlja2VyLAogICAgICAgICIgXHhENyAiLAogICAgICAgIGRyYWZ0LnF1YW50aXR5CiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInN0cm9uZyIsIHsgc3R5bGU6IHsgY29sb3I6IGNvbG9yMiB9LCBjaGlsZHJlbjogZm10KGRyYWZ0LmFtb3VudCkgfSkgfSkKICAgIF0gfSkKICBdIH0pOwp9Owp2YXIgSXRlbVJvdyA9ICh7IGl0ZW0sIG9uVXBkYXRlLCBvbkRlbGV0ZSwgaW5wdXRNb2RlLCBjb2xvcjogY29sb3IyIH0pID0+IHsKICBjb25zdCBpc05ldyA9ICFpdGVtLmFtb3VudDsKICBjb25zdCBbZWRpdGluZywgc2V0RWRpdGluZ10gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGlzTmV3KTsKICBjb25zdCBbZHJhZnQsIHNldERyYWZ0XSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoaXRlbSk7CiAgKDAsIGltcG9ydF9yZWFjdDUyLnVzZUVmZmVjdCkoKCkgPT4gewogICAgc2V0RHJhZnQoaXRlbSk7CiAgfSwgW2l0ZW1dKTsKICBjb25zdCBzYXZlID0gKCkgPT4gewogICAgY29uc3QgZnJlcSA9IGRyYWZ0LmZyZXF1ZW5jeSB8fCAoaW5wdXRNb2RlID09PSAicmVjdXJyaW5nIiA/ICJtb250aGx5IiA6ICJvbmVfdGltZSIpOwogICAgbGV0IGFtb3VudCA9IGRyYWZ0LmFtb3VudDsKICAgIGlmICgoZHJhZnQuYXNzZXRUeXBlID09PSAiY3J5cHRvIiB8fCBkcmFmdC5hc3NldFR5cGUgPT09ICJzdG9jayIpICYmIGRyYWZ0LnRpY2tlciAmJiBkcmFmdC5saXZlUHJpY2UgJiYgZHJhZnQucXVhbnRpdHkpIHsKICAgICAgYW1vdW50ID0gTWF0aC5yb3VuZChkcmFmdC5saXZlUHJpY2UgKiBkcmFmdC5xdWFudGl0eSAqIDEwMCkgLyAxMDA7CiAgICB9CiAgICBjb25zdCBjb21wdXRlZCA9IGNvbXB1dGVWYWx1ZXMoYW1vdW50LCBmcmVxKTsKICAgIG9uVXBkYXRlKHsgLi4uZHJhZnQsIGFtb3VudCwgZnJlcXVlbmN5OiBmcmVxLCAuLi5jb21wdXRlZCB9KTsKICAgIHNldEVkaXRpbmcoZmFsc2UpOwogIH07CiAgY29uc3QgaW5wdXRTdHlsZTIgPSB7CiAgICBwYWRkaW5nOiAiOHB4IDEwcHgiLAogICAgYm9yZGVyUmFkaXVzOiA4LAogICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJ9YCwKICAgIGZvbnRTaXplOiAxMywKICAgIHdpZHRoOiAiMTAwJSIsCiAgICBib3hTaXppbmc6ICJib3JkZXItYm94IiwKICAgIGZvbnRGYW1pbHk6ICJpbmhlcml0IiwKICAgIG91dGxpbmU6ICJub25lIgogIH07CiAgY29uc3Qgc2VsZWN0U3R5bGUgPSB7CiAgICAuLi5pbnB1dFN0eWxlMiwKICAgIGFwcGVhcmFuY2U6ICJub25lIiwKICAgIGJhY2tncm91bmRJbWFnZTogYHVybCgiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMicgaGVpZ2h0PScxMicgdmlld0JveD0nMCAwIDI0IDI0JyBmaWxsPSdub25lJyBzdHJva2U9JyUyMzlDQTNBRicgc3Ryb2tlLXdpZHRoPScyJyUzRSUzQ3BhdGggZD0nTTYgOWw2IDYgNi02Jy8lM0UlM0Mvc3ZnJTNFIilgLAogICAgYmFja2dyb3VuZFJlcGVhdDogIm5vLXJlcGVhdCIsCiAgICBiYWNrZ3JvdW5kUG9zaXRpb246ICJyaWdodCA4cHggY2VudGVyIiwKICAgIHBhZGRpbmdSaWdodDogMjQKICB9OwogIGNvbnN0IGZyZXFMYWJlbCA9IChmKSA9PiBmID09PSAibW9udGhseSIgPyAiL21vIiA6IGYgPT09ICJ5ZWFybHkiID8gIi95ciIgOiAiIjsKICBjb25zdCBoYW5kbGVDb2luU2VsZWN0ID0gYXN5bmMgKGNvaW4pID0+IHsKICAgIHNldERyYWZ0KChkKSA9PiAoeyAuLi5kLCBuYW1lOiBjb2luLm5hbWUsIGFzc2V0VHlwZTogImNyeXB0byIsIHRpY2tlcjogY29pbi5pZCB9KSk7CiAgICB0cnkgewogICAgICBjb25zdCBwcmljZXMgPSBhd2FpdCBmZXRjaENyeXB0b1ByaWNlcyhbY29pbi5pZF0pOwogICAgICBpZiAocHJpY2VzW2NvaW4uaWRdKSB7CiAgICAgICAgc2V0RHJhZnQoKGQpID0+IHsKICAgICAgICAgIGNvbnN0IHByaWNlID0gcHJpY2VzW2NvaW4uaWRdOwogICAgICAgICAgY29uc3QgbmV3QW1vdW50ID0gZC5xdWFudGl0eSA/IE1hdGgucm91bmQocHJpY2UgKiBkLnF1YW50aXR5ICogMTAwKSAvIDEwMCA6IGQuYW1vdW50OwogICAgICAgICAgcmV0dXJuIHsgLi4uZCwgbGl2ZVByaWNlOiBwcmljZSwgYW1vdW50OiBuZXdBbW91bnQgfTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSBjYXRjaCB7CiAgICB9CiAgfTsKICBpZiAoZWRpdGluZykgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAiMTBweCAxMnB4IiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLmNhcmQsIGJvcmRlclJhZGl1czogMTAsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsIG1hcmdpbkJvdHRvbTogNiB9LCBjaGlsZHJlbjogWwogICAgICBpbnB1dE1vZGUgPT09ICJhc3NldCIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA2LCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXREcmFmdCgoZCkgPT4gKHsgLi4uZCwgYXNzZXRUeXBlOiAiY3J5cHRvIiB9KSksCiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgcGFkZGluZzogIjRweCAxMHB4IiwKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDYsCiAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7ZHJhZnQuYXNzZXRUeXBlID09PSAiY3J5cHRvIiA/ICIjRjc5MzFBIiA6IENPTE9SUzIuYm9yZGVyfWAsCiAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBkcmFmdC5hc3NldFR5cGUgPT09ICJjcnlwdG8iID8gIiNGNzkzMUExNSIgOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgIGNvbG9yOiBkcmFmdC5hc3NldFR5cGUgPT09ICJjcnlwdG8iID8gIiNGNzkzMUEiIDogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LAogICAgICAgICAgICAgIGZvbnRTaXplOiAxMSwKICAgICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2hpbGRyZW46ICJcdTIwQkYgQ3J5cHRvIgogICAgICAgICAgfQogICAgICAgICksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgb25DbGljazogKCkgPT4gc2V0RHJhZnQoKGQpID0+ICh7IC4uLmQsIGFzc2V0VHlwZTogInN0b2NrIiwgdGlja2VyOiB2b2lkIDAsIGxpdmVQcmljZTogdm9pZCAwIH0pKSwKICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICBwYWRkaW5nOiAiNHB4IDEwcHgiLAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtkcmFmdC5hc3NldFR5cGUgPT09ICJzdG9jayIgPyAiIzI1NjNFQiIgOiBDT0xPUlMyLmJvcmRlcn1gLAogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogZHJhZnQuYXNzZXRUeXBlID09PSAic3RvY2siID8gIiMyNTYzRUIxNSIgOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgIGNvbG9yOiBkcmFmdC5hc3NldFR5cGUgPT09ICJzdG9jayIgPyAiIzI1NjNFQiIgOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksCiAgICAgICAgICAgICAgZm9udFNpemU6IDExLAogICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIgogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGlsZHJlbjogIlx1ezFGNEM4fSBTdG9jayIKICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldERyYWZ0KChkKSA9PiAoeyAuLi5kLCBhc3NldFR5cGU6IHZvaWQgMCwgdGlja2VyOiB2b2lkIDAsIGxpdmVQcmljZTogdm9pZCAwIH0pKSwKICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICBwYWRkaW5nOiAiNHB4IDEwcHgiLAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHshZHJhZnQuYXNzZXRUeXBlIHx8IGRyYWZ0LmFzc2V0VHlwZSA9PT0gIm1hbnVhbCIgPyBjb2xvcjIgOiBDT0xPUlMyLmJvcmRlcn1gLAogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIWRyYWZ0LmFzc2V0VHlwZSB8fCBkcmFmdC5hc3NldFR5cGUgPT09ICJtYW51YWwiID8gYCR7Y29sb3IyfTE1YCA6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICAgICAgY29sb3I6ICFkcmFmdC5hc3NldFR5cGUgfHwgZHJhZnQuYXNzZXRUeXBlID09PSAibWFudWFsIiA/IGNvbG9yMiA6IENPTE9SUzIudGV4dFNlY29uZGFyeSwKICAgICAgICAgICAgICBmb250U2l6ZTogMTEsCiAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiAiTWFudWFsIgogICAgICAgICAgfQogICAgICAgICkKICAgICAgXSB9KSwKICAgICAgaW5wdXRNb2RlID09PSAiYXNzZXQiICYmIGRyYWZ0LmFzc2V0VHlwZSA9PT0gImNyeXB0byIgJiYgIWRyYWZ0LnRpY2tlciAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUzIudGV4dE11dGVkLCBtYXJnaW5Cb3R0b206IDIsIGRpc3BsYXk6ICJibG9jayIgfSwgY2hpbGRyZW46ICJTZWFyY2ggQ3J5cHRvY3VycmVuY3kiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKENvaW5TZWFyY2hEcm9wZG93biwgeyBvblNlbGVjdDogaGFuZGxlQ29pblNlbGVjdCwgaW5wdXRTdHlsZTogaW5wdXRTdHlsZTIgfSkKICAgICAgXSB9KSwKICAgICAgaW5wdXRNb2RlID09PSAiYXNzZXQiICYmIGRyYWZ0LmFzc2V0VHlwZSA9PT0gImNyeXB0byIgJiYgZHJhZnQudGlja2VyICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA2LCBwYWRkaW5nOiAiNnB4IDEwcHgiLCBiYWNrZ3JvdW5kQ29sb3I6ICIjRjc5MzFBMTAiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogIjFweCBzb2xpZCAjRjc5MzFBMzAiLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiAiI0Y3OTMxQSIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgIlx1MjBCRiAiLAogICAgICAgICAgICBkcmFmdC5uYW1lCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAiKCIsCiAgICAgICAgICAgIGRyYWZ0LnRpY2tlciwKICAgICAgICAgICAgIikiCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gc2V0RHJhZnQoKGQpID0+ICh7IC4uLmQsIHRpY2tlcjogdm9pZCAwLCBuYW1lOiAiIiwgbGl2ZVByaWNlOiB2b2lkIDAgfSkpLCBzdHlsZTogeyBtYXJnaW5MZWZ0OiAiYXV0byIsIHBhZGRpbmc6IDIsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kOiAibm9uZSIsIGN1cnNvcjogInBvaW50ZXIiLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsIGRpc3BsYXk6ICJmbGV4IiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoWCwgeyBzaXplOiAxNCB9KSB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUzIudGV4dE11dGVkLCBtYXJnaW5Cb3R0b206IDIsIGRpc3BsYXk6ICJibG9jayIgfSwgY2hpbGRyZW46ICJRdWFudGl0eSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiaW5wdXQiLCB7IHN0eWxlOiBpbnB1dFN0eWxlMiwgdHlwZTogIm51bWJlciIsIHN0ZXA6ICJhbnkiLCB2YWx1ZTogZHJhZnQucXVhbnRpdHkgfHwgIiIsIG9uQ2hhbmdlOiAoZSkgPT4gewogICAgICAgICAgICBjb25zdCBxdHkgPSBwYXJzZUZsb2F0KGUudGFyZ2V0LnZhbHVlKSB8fCAwOwogICAgICAgICAgICBjb25zdCBuZXdBbW91bnQgPSBkcmFmdC5saXZlUHJpY2UgPyBNYXRoLnJvdW5kKGRyYWZ0LmxpdmVQcmljZSAqIHF0eSAqIDEwMCkgLyAxMDAgOiBkcmFmdC5hbW91bnQ7CiAgICAgICAgICAgIHNldERyYWZ0KChkKSA9PiAoeyAuLi5kLCBxdWFudGl0eTogcXR5IHx8IHZvaWQgMCwgYW1vdW50OiBuZXdBbW91bnQgfSkpOwogICAgICAgICAgfSwgcGxhY2Vob2xkZXI6ICJIb3cgbWFueT8iLCBhdXRvRm9jdXM6IHRydWUgfSkKICAgICAgICBdIH0pLAogICAgICAgIGRyYWZ0LmxpdmVQcmljZSA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksIG1hcmdpblRvcDogNCwgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoInNwYW4iLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJQcmljZTogIiwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInN0cm9uZyIsIHsgY2hpbGRyZW46IGZtdFByaWNlKGRyYWZ0LmxpdmVQcmljZSkgfSksCiAgICAgICAgICAgICIvdW5pdCIKICAgICAgICAgIF0gfSksCiAgICAgICAgICBkcmFmdC5xdWFudGl0eSA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgic3BhbiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgIlRvdGFsOiAiLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3Ryb25nIiwgeyBzdHlsZTogeyBjb2xvcjogY29sb3IyIH0sIGNoaWxkcmVuOiBmbXQoZHJhZnQubGl2ZVByaWNlICogZHJhZnQucXVhbnRpdHkpIH0pCiAgICAgICAgICBdIH0pIDogbnVsbAogICAgICAgIF0gfSkgOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgbWFyZ2luVG9wOiA0IH0sIGNoaWxkcmVuOiAiRmV0Y2hpbmcgcHJpY2UuLi4iIH0pCiAgICAgIF0gfSksCiAgICAgIGlucHV0TW9kZSA9PT0gImFzc2V0IiAmJiBkcmFmdC5hc3NldFR5cGUgPT09ICJzdG9jayIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoU3RvY2tUaWNrZXJJbnB1dCwgeyBkcmFmdCwgc2V0RHJhZnQsIGlucHV0U3R5bGU6IGlucHV0U3R5bGUyLCBjb2xvcjogY29sb3IyIH0pLAogICAgICAoaW5wdXRNb2RlICE9PSAiYXNzZXQiIHx8ICFkcmFmdC5hc3NldFR5cGUgfHwgZHJhZnQuYXNzZXRUeXBlID09PSAibWFudWFsIikgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiTmFtZSIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImlucHV0IiwgeyBhdXRvRm9jdXM6ICFkcmFmdC5uYW1lLCBzdHlsZTogaW5wdXRTdHlsZTIsIHZhbHVlOiBkcmFmdC5uYW1lLCBvbkNoYW5nZTogKGUpID0+IHNldERyYWZ0KHsgLi4uZHJhZnQsIG5hbWU6IGUudGFyZ2V0LnZhbHVlIH0pLCBwbGFjZWhvbGRlcjogIkRlc2NyaXB0aW9uIiB9KQogICAgICBdIH0pLAogICAgICBpbnB1dE1vZGUgPT09ICJyZWN1cnJpbmciICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZ3JpZCIsIGdyaWRUZW1wbGF0ZUNvbHVtbnM6ICIxZnIgMWZyIiwgZ2FwOiA4LCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiQW1vdW50IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJpbnB1dCIsIHsgYXV0b0ZvY3VzOiAhIWRyYWZ0Lm5hbWUsIHN0eWxlOiBpbnB1dFN0eWxlMiwgdHlwZTogIm51bWJlciIsIHZhbHVlOiBkcmFmdC5hbW91bnQgfHwgIiIsIG9uQ2hhbmdlOiAoZSkgPT4gc2V0RHJhZnQoeyAuLi5kcmFmdCwgYW1vdW50OiBwYXJzZUZsb2F0KGUudGFyZ2V0LnZhbHVlKSB8fCAwIH0pLCBwbGFjZWhvbGRlcjogIiQwIiB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMiwgZGlzcGxheTogImJsb2NrIiB9LCBjaGlsZHJlbjogIkZyZXF1ZW5jeSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoInNlbGVjdCIsIHsgc3R5bGU6IHNlbGVjdFN0eWxlLCB2YWx1ZTogZHJhZnQuZnJlcXVlbmN5IHx8ICJtb250aGx5Iiwgb25DaGFuZ2U6IChlKSA9PiBzZXREcmFmdCh7IC4uLmRyYWZ0LCBmcmVxdWVuY3k6IGUudGFyZ2V0LnZhbHVlIH0pLCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgib3B0aW9uIiwgeyB2YWx1ZTogIm1vbnRobHkiLCBjaGlsZHJlbjogIk1vbnRobHkiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgib3B0aW9uIiwgeyB2YWx1ZTogInllYXJseSIsIGNoaWxkcmVuOiAiWWVhcmx5IiB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoIm9wdGlvbiIsIHsgdmFsdWU6ICJvbmVfdGltZSIsIGNoaWxkcmVuOiAiT25lLXRpbWUiIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICBpbnB1dE1vZGUgPT09ICJhc3NldCIgJiYgKCFkcmFmdC5hc3NldFR5cGUgfHwgZHJhZnQuYXNzZXRUeXBlID09PSAibWFudWFsIikgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJncmlkIiwgZ3JpZFRlbXBsYXRlQ29sdW1uczogIjFmciAxZnIiLCBnYXA6IDgsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUzIudGV4dE11dGVkLCBtYXJnaW5Cb3R0b206IDIsIGRpc3BsYXk6ICJibG9jayIgfSwgY2hpbGRyZW46ICJWYWx1ZSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiaW5wdXQiLCB7IGF1dG9Gb2N1czogISFkcmFmdC5uYW1lLCBzdHlsZTogaW5wdXRTdHlsZTIsIHR5cGU6ICJudW1iZXIiLCB2YWx1ZTogZHJhZnQuYW1vdW50IHx8ICIiLCBvbkNoYW5nZTogKGUpID0+IHNldERyYWZ0KHsgLi4uZHJhZnQsIGFtb3VudDogcGFyc2VGbG9hdChlLnRhcmdldC52YWx1ZSkgfHwgMCB9KSwgcGxhY2Vob2xkZXI6ICIkMCIgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUzIudGV4dE11dGVkLCBtYXJnaW5Cb3R0b206IDIsIGRpc3BsYXk6ICJibG9jayIgfSwgY2hpbGRyZW46ICJRdWFudGl0eSAob3B0aW9uYWwpIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJpbnB1dCIsIHsgc3R5bGU6IGlucHV0U3R5bGUyLCB0eXBlOiAibnVtYmVyIiwgc3RlcDogImFueSIsIHZhbHVlOiBkcmFmdC5xdWFudGl0eSB8fCAiIiwgb25DaGFuZ2U6IChlKSA9PiBzZXREcmFmdCh7IC4uLmRyYWZ0LCBxdWFudGl0eTogcGFyc2VGbG9hdChlLnRhcmdldC52YWx1ZSkgfHwgdm9pZCAwIH0pLCBwbGFjZWhvbGRlcjogIlF0eSIgfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIGlucHV0TW9kZSA9PT0gInZhbHVlX29ubHkiICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMiwgZGlzcGxheTogImJsb2NrIiB9LCBjaGlsZHJlbjogIlZhbHVlIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiaW5wdXQiLCB7IGF1dG9Gb2N1czogISFkcmFmdC5uYW1lLCBzdHlsZTogaW5wdXRTdHlsZTIsIHR5cGU6ICJudW1iZXIiLCB2YWx1ZTogZHJhZnQuYW1vdW50IHx8ICIiLCBvbkNoYW5nZTogKGUpID0+IHNldERyYWZ0KHsgLi4uZHJhZnQsIGFtb3VudDogcGFyc2VGbG9hdChlLnRhcmdldC52YWx1ZSkgfHwgMCB9KSwgcGxhY2Vob2xkZXI6ICIkMCIgfSkKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA2LCBqdXN0aWZ5Q29udGVudDogImZsZXgtZW5kIiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgIGlmICghaXRlbS5uYW1lICYmICFpdGVtLmFtb3VudCkgewogICAgICAgICAgICBvbkRlbGV0ZSgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2V0RHJhZnQoaXRlbSk7CiAgICAgICAgICAgIHNldEVkaXRpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0sIHN0eWxlOiB7IHBhZGRpbmc6ICI2cHggMTJweCIsIGJvcmRlclJhZGl1czogNiwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJ9YCwgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBmb250U2l6ZTogMTIsIGN1cnNvcjogInBvaW50ZXIiLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiQ2FuY2VsIiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBzYXZlLCBzdHlsZTogeyBwYWRkaW5nOiAiNnB4IDEycHgiLCBib3JkZXJSYWRpdXM6IDYsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kQ29sb3I6IGNvbG9yMiwgY29sb3I6ICJ3aGl0ZSIsIGZvbnRTaXplOiAxMiwgZm9udFdlaWdodDogNjAwLCBjdXJzb3I6ICJwb2ludGVyIiB9LCBjaGlsZHJlbjogIlNhdmUiIH0pCiAgICAgIF0gfSkKICAgIF0gfSk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwKICAgIHBhZGRpbmc6ICIxMHB4IDZweCAxMHB4IDRweCIsCiAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuY2FyZCwKICAgIGJvcmRlclJhZGl1czogMTAsCiAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlckxpZ2h0fWAsCiAgICBtYXJnaW5Cb3R0b206IDQsCiAgICB0cmFuc2l0aW9uOiAiYWxsIDAuMTVzIgogIH0sIGNoaWxkcmVuOiBbCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBjbGFzc05hbWU6ICJkcmFnLWhhbmRsZSIsIHN0eWxlOiB7IHBhZGRpbmc6ICI0cHggNHB4IiwgY3Vyc29yOiAiZ3JhYiIsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgZGlzcGxheTogImZsZXgiLCBmbGV4U2hyaW5rOiAwIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShHcmlwVmVydGljYWwsIHsgc2l6ZTogMTYgfSkgfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSwgbWluV2lkdGg6IDAsIHBhZGRpbmdMZWZ0OiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGZvbnRXZWlnaHQ6IDUwMCwgY29sb3I6IENPTE9SUzIudGV4dE1haW4sIG92ZXJmbG93OiAiaGlkZGVuIiwgdGV4dE92ZXJmbG93OiAiZWxsaXBzaXMiLCB3aGl0ZVNwYWNlOiAibm93cmFwIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgaXRlbS5hc3NldFR5cGUgPT09ICJjcnlwdG8iICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGNvbG9yOiAiI0Y3OTMxQSIsIGZvbnRXZWlnaHQ6IDcwMCB9LCBjaGlsZHJlbjogIlx1MjBCRiIgfSksCiAgICAgICAgaXRlbS5hc3NldFR5cGUgPT09ICJzdG9jayIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgY29sb3I6ICIjMjU2M0VCIiwgZm9udFdlaWdodDogNzAwIH0sIGNoaWxkcmVuOiAiXHV7MUY0Qzh9IiB9KSwKICAgICAgICBpdGVtLm5hbWUgfHwgIlVubmFtZWQiCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksIGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4LCBtYXJnaW5Ub3A6IDIgfSwgY2hpbGRyZW46IFsKICAgICAgICBpdGVtLnF1YW50aXR5ICE9PSB2b2lkIDAgJiYgaXRlbS5xdWFudGl0eSA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJzcGFuIiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgIlF0eTogIiwKICAgICAgICAgIGl0ZW0ucXVhbnRpdHkKICAgICAgICBdIH0pLAogICAgICAgIChpdGVtLmFzc2V0VHlwZSA9PT0gImNyeXB0byIgfHwgaXRlbS5hc3NldFR5cGUgPT09ICJzdG9jayIpICYmIGl0ZW0ubGl2ZVByaWNlICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgic3BhbiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICJAICIsCiAgICAgICAgICBmbXRQcmljZShpdGVtLmxpdmVQcmljZSkKICAgICAgICBdIH0pLAogICAgICAgIGlucHV0TW9kZSA9PT0gInJlY3VycmluZyIgJiYgaXRlbS5mcmVxdWVuY3kgIT09ICJvbmVfdGltZSIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJzcGFuIiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgZm10KGl0ZW0uYW1vdW50KSwKICAgICAgICAgIGZyZXFMYWJlbChpdGVtLmZyZXF1ZW5jeSkKICAgICAgICBdIH0pLAogICAgICAgIGlucHV0TW9kZSA9PT0gInJlY3VycmluZyIgJiYgaXRlbS5mcmVxdWVuY3kgPT09ICJ5ZWFybHkiICYmIGl0ZW0ubW9udGhseVZhbHVlID4gMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoInNwYW4iLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAiKCIsCiAgICAgICAgICBmbXQoaXRlbS5tb250aGx5VmFsdWUpLAogICAgICAgICAgIi9tbykiCiAgICAgICAgXSB9KSwKICAgICAgICBpbnB1dE1vZGUgPT09ICJyZWN1cnJpbmciICYmIGl0ZW0uZnJlcXVlbmN5ID09PSAibW9udGhseSIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJzcGFuIiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgIigiLAogICAgICAgICAgZm10KGl0ZW0udG90YWxWYWx1ZSksCiAgICAgICAgICAiL3lyKSIKICAgICAgICBdIH0pCiAgICAgIF0gfSkKICAgIF0gfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNSwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogY29sb3IyLCB3aGl0ZVNwYWNlOiAibm93cmFwIiB9LCBjaGlsZHJlbjogZm10RXhhY3QoaXRlbS50b3RhbFZhbHVlKSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gc2V0RWRpdGluZyh0cnVlKSwgc3R5bGU6IHsgcGFkZGluZzogNCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmQ6ICJub25lIiwgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgZGlzcGxheTogImZsZXgiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShQZW4sIHsgc2l6ZTogMTQgfSkgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6IG9uRGVsZXRlLCBzdHlsZTogeyBwYWRkaW5nOiA0LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZDogIm5vbmUiLCBjdXJzb3I6ICJwb2ludGVyIiwgY29sb3I6IENPTE9SUzIudGV4dE11dGVkLCBkaXNwbGF5OiAiZmxleCIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFRyYXNoMiwgeyBzaXplOiAxNCB9KSB9KQogICAgXSB9KQogIF0gfSk7Cn07CnZhciBCdWRnZXRTZWN0aW9uID0gKHsgdGl0bGUsIGljb24sIGNvbG9yOiBjb2xvcjIsIGJnQ29sb3IsIGl0ZW1zLCBvblVwZGF0ZSwgb25BZGQsIG9uQWRkUHJlc2V0LCBvbkRlbGV0ZSwgb25SZW9yZGVyLCBpbnB1dE1vZGUsIHByZXNldHMsIGZvb3RlciB9KSA9PiB7CiAgY29uc3QgW2lzT3Blbiwgc2V0SXNPcGVuXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoZmFsc2UpOwogIGNvbnN0IFtkcmFnSWR4LCBzZXREcmFnSWR4XSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkobnVsbCk7CiAgY29uc3QgW292ZXJJZHgsIHNldE92ZXJJZHhdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShudWxsKTsKICBjb25zdCB0b3RhbCA9IGl0ZW1zLnJlZHVjZSgocywgaSkgPT4gcyArIGkudG90YWxWYWx1ZSwgMCk7CiAgY29uc3Qgc2hvd01vbnRobHkgPSBpbnB1dE1vZGUgPT09ICJyZWN1cnJpbmciOwogIGNvbnN0IG1vbnRobHlUb3RhbCA9IHNob3dNb250aGx5ID8gaXRlbXMucmVkdWNlKChzLCBpKSA9PiBzICsgaS5tb250aGx5VmFsdWUsIDApIDogdm9pZCAwOwogIGNvbnN0IGV4aXN0aW5nTmFtZXMgPSBuZXcgU2V0KGl0ZW1zLm1hcCgoaSkgPT4gaS5uYW1lLnRvTG93ZXJDYXNlKCkpKTsKICBjb25zdCBhdmFpbGFibGVQcmVzZXRzID0gKHByZXNldHMgfHwgW10pLmZpbHRlcigocCkgPT4gcC5wZXJzaXN0ZW50IHx8ICFleGlzdGluZ05hbWVzLmhhcyhwLm5hbWUudG9Mb3dlckNhc2UoKSkpOwogIGNvbnN0IGhhbmRsZURyYWdTdGFydCA9IChlLCBpZHgpID0+IHsKICAgIHNldERyYWdJZHgoaWR4KTsKICAgIGUuZGF0YVRyYW5zZmVyLmVmZmVjdEFsbG93ZWQgPSAibW92ZSI7CiAgfTsKICBjb25zdCBoYW5kbGVEcmFnT3ZlciA9IChlLCBpZHgpID0+IHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIGUuZGF0YVRyYW5zZmVyLmRyb3BFZmZlY3QgPSAibW92ZSI7CiAgICBzZXRPdmVySWR4KGlkeCk7CiAgfTsKICBjb25zdCBoYW5kbGVEcm9wID0gKGUsIGlkeCkgPT4gewogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgaWYgKGRyYWdJZHggIT09IG51bGwgJiYgZHJhZ0lkeCAhPT0gaWR4KSBvblJlb3JkZXIoZHJhZ0lkeCwgaWR4KTsKICAgIHNldERyYWdJZHgobnVsbCk7CiAgICBzZXRPdmVySWR4KG51bGwpOwogIH07CiAgY29uc3QgaGFuZGxlRHJhZ0VuZCA9ICgpID0+IHsKICAgIHNldERyYWdJZHgobnVsbCk7CiAgICBzZXRPdmVySWR4KG51bGwpOwogIH07CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgU2VjdGlvbkhlYWRlciwKICAgICAgewogICAgICAgIHRpdGxlLAogICAgICAgIGljb24sCiAgICAgICAgY29sb3I6IGNvbG9yMiwKICAgICAgICBiZ0NvbG9yLAogICAgICAgIHRvdGFsLAogICAgICAgIG1vbnRobHlUb3RhbCwKICAgICAgICBjb3VudDogaXRlbXMubGVuZ3RoLAogICAgICAgIGlzT3BlbiwKICAgICAgICBvblRvZ2dsZTogKCkgPT4gc2V0SXNPcGVuKCFpc09wZW4pCiAgICAgIH0KICAgICksCiAgICBpc09wZW4gJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBhZGRpbmc6ICIxMHB4IDEycHggMTJweCIsIGJvcmRlcjogYDFweCBzb2xpZCAke2NvbG9yMn0yMGAsIGJvcmRlclJhZGl1czogIjAgMCAxMnB4IDEycHgiLCBtYXJnaW5Ub3A6IC0yIH0sIGNoaWxkcmVuOiBbCiAgICAgIGl0ZW1zLm1hcCgoaXRlbSwgaWR4KSA9PiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgICAiZGl2IiwKICAgICAgICB7CiAgICAgICAgICBkcmFnZ2FibGU6IHRydWUsCiAgICAgICAgICBvbkRyYWdTdGFydDogKGUpID0+IGhhbmRsZURyYWdTdGFydChlLCBpZHgpLAogICAgICAgICAgb25EcmFnT3ZlcjogKGUpID0+IGhhbmRsZURyYWdPdmVyKGUsIGlkeCksCiAgICAgICAgICBvbkRyb3A6IChlKSA9PiBoYW5kbGVEcm9wKGUsIGlkeCksCiAgICAgICAgICBvbkRyYWdFbmQ6IGhhbmRsZURyYWdFbmQsCiAgICAgICAgICBzdHlsZTogeyBvcGFjaXR5OiBkcmFnSWR4ID09PSBpZHggPyAwLjQgOiAxLCBib3JkZXJUb3A6IG92ZXJJZHggPT09IGlkeCAmJiBkcmFnSWR4ICE9PSBudWxsICYmIGRyYWdJZHggIT09IGlkeCA/IGAycHggc29saWQgJHtjb2xvcjJ9YCA6ICIycHggc29saWQgdHJhbnNwYXJlbnQiLCB0cmFuc2l0aW9uOiAib3BhY2l0eSAwLjE1cyIgfSwKICAgICAgICAgIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgICAgICAgSXRlbVJvdywKICAgICAgICAgICAgewogICAgICAgICAgICAgIGl0ZW0sCiAgICAgICAgICAgICAgY29sb3I6IGNvbG9yMiwKICAgICAgICAgICAgICBvblVwZGF0ZTogKHUpID0+IG9uVXBkYXRlKGl0ZW0uaWQsIHUpLAogICAgICAgICAgICAgIG9uRGVsZXRlOiAoKSA9PiBvbkRlbGV0ZShpdGVtLmlkKSwKICAgICAgICAgICAgICBpbnB1dE1vZGUKICAgICAgICAgICAgfQogICAgICAgICAgKQogICAgICAgIH0sCiAgICAgICAgaXRlbS5pZAogICAgICApKSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogMTIsIG1hcmdpbkJvdHRvbTogNiB9LCBjaGlsZHJlbjogWwogICAgICAgIGF2YWlsYWJsZVByZXNldHMubGVuZ3RoID4gMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUzIudGV4dE11dGVkLCBtYXJnaW5Cb3R0b206IDYsIHBhZGRpbmdMZWZ0OiAyIH0sIGNoaWxkcmVuOiAiUXVpY2sgYWRkOiIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZmxleFdyYXA6ICJ3cmFwIiwgZ2FwOiA2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICBhdmFpbGFibGVQcmVzZXRzLm1hcCgocCkgPT4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKAogICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgewogICAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IG9uQWRkUHJlc2V0KHAubmFtZSwgcC5hc3NldFR5cGUpLAogICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICBwYWRkaW5nOiAiNnB4IDEycHgiLAogICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAyMCwKICAgICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke2NvbG9yMn0zMGAsCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGAke2JnQ29sb3J9YCwKICAgICAgICAgICAgICAgIGNvbG9yOiBjb2xvcjIsCiAgICAgICAgICAgICAgICBmb250U2l6ZTogMTIsCiAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA1MDAsCiAgICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgZ2FwOiA0LAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogImFsbCAwLjE1cyIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG9uTW91c2VFbnRlcjogKGUpID0+IHsKICAgICAgICAgICAgICAgIGUudGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGAke2NvbG9yMn0xNWA7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBvbk1vdXNlTGVhdmU6IChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnRhcmdldC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBiZ0NvbG9yOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBjaGlsZHJlbjogcC5lbW9qaSB9KSwKICAgICAgICAgICAgICAgICIgIiwKICAgICAgICAgICAgICAgIHAubmFtZQogICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgcC5uYW1lCiAgICAgICAgICApKSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgKICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBvbkNsaWNrOiBvbkFkZCwKICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgcGFkZGluZzogIjZweCAxMnB4IiwKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMjAsCiAgICAgICAgICAgICAgICBib3JkZXI6IGAxcHggZGFzaGVkICR7Y29sb3IyfTUwYCwKICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogInRyYW5zcGFyZW50IiwKICAgICAgICAgICAgICAgIGNvbG9yOiBjb2xvcjIsCiAgICAgICAgICAgICAgICBmb250U2l6ZTogMTIsCiAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA1MDAsCiAgICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgICAgZ2FwOiA0LAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbjogImFsbCAwLjE1cyIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG9uTW91c2VFbnRlcjogKGUpID0+IHsKICAgICAgICAgICAgICAgIGUudGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGAke2NvbG9yMn0xMGA7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBvbk1vdXNlTGVhdmU6IChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnRhcmdldC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAidHJhbnNwYXJlbnQiOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFBsdXMsIHsgc2l6ZTogMTQgfSksCiAgICAgICAgICAgICAgICAiIEN1c3RvbSIKICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0KICAgICAgICAgICkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIGZvb3RlcgogICAgXSB9KQogIF0gfSk7Cn07CnZhciBTdW1tYXJ5U2VjdGlvbiA9ICh7IGJ1ZGdldCB9KSA9PiB7CiAgY29uc3QgdG90YWxNb250aGx5SW5jb21lID0gYnVkZ2V0LmluY29tZS5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLm1vbnRobHlWYWx1ZSwgMCk7CiAgY29uc3QgdG90YWxNb250aGx5RXhwZW5zZXMgPSBidWRnZXQuZXhwZW5zZXMucmVkdWNlKChzLCBpKSA9PiBzICsgaS5tb250aGx5VmFsdWUsIDApOwogIGNvbnN0IHRvdGFsTW9udGhseUxpYWJpbGl0eVBheW1lbnRzID0gYnVkZ2V0LmxpYWJpbGl0aWVzLnJlZHVjZSgocywgaSkgPT4gcyArIGkubW9udGhseVZhbHVlLCAwKTsKICBjb25zdCBtb250aGx5TmV0ID0gdG90YWxNb250aGx5SW5jb21lIC0gdG90YWxNb250aGx5RXhwZW5zZXMgLSB0b3RhbE1vbnRobHlMaWFiaWxpdHlQYXltZW50czsKICBjb25zdCBhbm51YWxOZXQgPSBtb250aGx5TmV0ICogMTI7CiAgY29uc3QgdG90YWxMaXF1aWRBc3NldHMgPSBidWRnZXQuYXNzZXRzLnJlZHVjZSgocywgaSkgPT4gcyArIGkudG90YWxWYWx1ZSwgMCk7CiAgY29uc3QgdG90YWxOb25MaXF1aWRBc3NldHMgPSBidWRnZXQubm9uTGlxdWlkQXNzZXRzLnJlZHVjZSgocywgaSkgPT4gcyArIGkudG90YWxWYWx1ZSwgMCk7CiAgY29uc3QgdG90YWxSZXRpcmVtZW50ID0gYnVkZ2V0LnJldGlyZW1lbnQucmVkdWNlKChzLCBpKSA9PiBzICsgaS50b3RhbFZhbHVlLCAwKTsKICBjb25zdCBub25MaXF1aWRBdERpc2NvdW50ID0gdG90YWxOb25MaXF1aWRBc3NldHMgKiAoMSAtIGJ1ZGdldC5ub25MaXF1aWREaXNjb3VudCAvIDEwMCk7CiAgY29uc3Qgb25lVGltZUxpYWJpbGl0aWVzID0gYnVkZ2V0LmxpYWJpbGl0aWVzLmZpbHRlcigoaSkgPT4gaS5mcmVxdWVuY3kgPT09ICJvbmVfdGltZSIpLnJlZHVjZSgocywgaSkgPT4gcyArIGkudG90YWxWYWx1ZSwgMCk7CiAgY29uc3QgdG90YWxMaWFiaWxpdGllcyA9IGJ1ZGdldC5saWFiaWxpdGllcy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLnRvdGFsVmFsdWUsIDApOwogIGNvbnN0IGxpcXVpZEFmdGVyTGlhYmlsaXRpZXMgPSB0b3RhbExpcXVpZEFzc2V0cyAtIG9uZVRpbWVMaWFiaWxpdGllczsKICBjb25zdCBuZXRXb3J0aCA9IGxpcXVpZEFmdGVyTGlhYmlsaXRpZXMgKyBub25MaXF1aWRBdERpc2NvdW50ICsgdG90YWxSZXRpcmVtZW50OwogIGNvbnN0IG1vbnRobHlCdXJuID0gdG90YWxNb250aGx5RXhwZW5zZXMgKyB0b3RhbE1vbnRobHlMaWFiaWxpdHlQYXltZW50cyAtIHRvdGFsTW9udGhseUluY29tZTsKICBjb25zdCBsaXF1aWRGb3JSdW53YXkgPSBNYXRoLm1heCgwLCBsaXF1aWRBZnRlckxpYWJpbGl0aWVzKTsKICBjb25zdCBydW53YXlNb250aHMgPSBtb250aGx5QnVybiA+IDAgJiYgbGlxdWlkRm9yUnVud2F5ID4gMCA/IGxpcXVpZEZvclJ1bndheSAvIG1vbnRobHlCdXJuIDogbnVsbDsKICBjb25zdCBydW53YXlZZWFycyA9IHJ1bndheU1vbnRocyA/IHJ1bndheU1vbnRocyAvIDEyIDogbnVsbDsKICBjb25zdCBleHRlbmRlZEZvclJ1bndheSA9IGxpcXVpZEZvclJ1bndheSArIG5vbkxpcXVpZEF0RGlzY291bnQ7CiAgY29uc3QgZXh0UnVud2F5TW9udGhzID0gbW9udGhseUJ1cm4gPiAwICYmIGV4dGVuZGVkRm9yUnVud2F5ID4gMCA/IGV4dGVuZGVkRm9yUnVud2F5IC8gbW9udGhseUJ1cm4gOiBudWxsOwogIGNvbnN0IGV4dFJ1bndheVllYXJzID0gZXh0UnVud2F5TW9udGhzID8gZXh0UnVud2F5TW9udGhzIC8gMTIgOiBudWxsOwogIGNvbnN0IHNhdmluZ3NSYXRlID0gdG90YWxNb250aGx5SW5jb21lID4gMCA/IG1vbnRobHlOZXQgLyB0b3RhbE1vbnRobHlJbmNvbWUgKiAxMDAgOiAwOwogIGNvbnN0IGlzUG9zaXRpdmUgPSBtb250aGx5TmV0ID49IDA7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogewogICAgICBiYWNrZ3JvdW5kQ29sb3I6IGlzUG9zaXRpdmUgPyBDT0xPUlMyLmluY29tZUJnIDogQ09MT1JTMi5leHBlbnNlQmcsCiAgICAgIGJvcmRlclJhZGl1czogMTYsCiAgICAgIHBhZGRpbmc6ICIyMHB4IDE2cHgiLAogICAgICBtYXJnaW5Cb3R0b206IDEyLAogICAgICBib3JkZXI6IGAxcHggc29saWQgJHtpc1Bvc2l0aXZlID8gQ09MT1JTMi5pbmNvbWUgOiBDT0xPUlMyLmV4cGVuc2V9MjBgCiAgICB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiAxNiwgYWxpZ25JdGVtczogImZsZXgtc3RhcnQiIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmbGV4OiAxIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksIHRleHRUcmFuc2Zvcm06ICJ1cHBlcmNhc2UiLCBsZXR0ZXJTcGFjaW5nOiAwLjUsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogIk1vbnRobHkgQ2FzaCBGbG93IiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiYmFzZWxpbmUiLCBnYXA6IDYsIG1hcmdpbkJvdHRvbTogMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMjgsIGZvbnRXZWlnaHQ6IDgwMCwgY29sb3I6IGlzUG9zaXRpdmUgPyBDT0xPUlMyLnBvc2l0aXZlIDogQ09MT1JTMi5uZWdhdGl2ZSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICBtb250aGx5TmV0ID49IDAgPyAiKyIgOiAiIiwKICAgICAgICAgICAgZm10KG1vbnRobHlOZXQpCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIi9tbyIgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksIG1hcmdpbkJvdHRvbTogMTAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIGFubnVhbE5ldCA+PSAwID8gIisiIDogIiIsCiAgICAgICAgICBmbXQoYW5udWFsTmV0KSwKICAgICAgICAgICIgL3llYXIiCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDEyLCBmbGV4V3JhcDogIndyYXAiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQgfSwgY2hpbGRyZW46ICJJbmNvbWUiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLmluY29tZSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIGZtdCh0b3RhbE1vbnRobHlJbmNvbWUpLAogICAgICAgICAgICAgICIvbW8iCiAgICAgICAgICAgIF0gfSkKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQgfSwgY2hpbGRyZW46ICJFeHBlbnNlcyIgfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUzIuZXhwZW5zZSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIGZtdCh0b3RhbE1vbnRobHlFeHBlbnNlcyksCiAgICAgICAgICAgICAgIi9tbyIKICAgICAgICAgICAgXSB9KQogICAgICAgICAgXSB9KSwKICAgICAgICAgIHRvdGFsTW9udGhseUxpYWJpbGl0eVBheW1lbnRzID4gMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQgfSwgY2hpbGRyZW46ICJMaWFiaWxpdGllcyIgfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUzIubGlhYmlsaXR5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgZm10KHRvdGFsTW9udGhseUxpYWJpbGl0eVBheW1lbnRzKSwKICAgICAgICAgICAgICAiL21vIgogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICBydW53YXlNb250aHMgIT09IG51bGwgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgYm9yZGVyTGVmdDogYDFweCBzb2xpZCAke2lzUG9zaXRpdmUgPyBDT0xPUlMyLmluY29tZSA6IENPTE9SUzIuZXhwZW5zZX0yMGAsIHBhZGRpbmdMZWZ0OiAxNiwgbWluV2lkdGg6IDEyMCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDQsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoQ2xvY2ssIHsgc2l6ZTogMTQsIGNvbG9yOiBDT0xPUlMyLmV4cGVuc2UgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLmV4cGVuc2UsIHRleHRUcmFuc2Zvcm06ICJ1cHBlcmNhc2UiIH0sIGNoaWxkcmVuOiAiUnVud2F5IiB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAxIH0sIGNoaWxkcmVuOiAiTGlxdWlkIG9ubHkiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDIwLCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBDT0xPUlMyLmV4cGVuc2UgfSwgY2hpbGRyZW46IHJ1bndheVllYXJzID49IDEgPyBgJHtydW53YXlZZWFycy50b0ZpeGVkKDEpfSB5cnNgIDogYCR7TWF0aC5yb3VuZChydW53YXlNb250aHMpfSBtb2AgfSkKICAgICAgICBdIH0pLAogICAgICAgIGV4dFJ1bndheU1vbnRocyAhPT0gbnVsbCAmJiBub25MaXF1aWRBdERpc2NvdW50ID4gMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAxIH0sIGNoaWxkcmVuOiAiKyBOb24tbGlxdWlkIHNvbGQiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDIwLCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBDT0xPUlMyLm5vbkxpcXVpZCB9LCBjaGlsZHJlbjogZXh0UnVud2F5WWVhcnMgPj0gMSA/IGAke2V4dFJ1bndheVllYXJzLnRvRml4ZWQoMSl9IHlyc2AgOiBgJHtNYXRoLnJvdW5kKGV4dFJ1bndheU1vbnRocyl9IG1vYCB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KSA6IGlzUG9zaXRpdmUgJiYgbW9udGhseU5ldCA+IDAgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgYm9yZGVyTGVmdDogYDFweCBzb2xpZCAke0NPTE9SUzIuaW5jb21lfTIwYCwgcGFkZGluZ0xlZnQ6IDE2LCBtaW5XaWR0aDogMTIwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShBcnJvd1VwUmlnaHQsIHsgc2l6ZTogMTQsIGNvbG9yOiBDT0xPUlMyLmluY29tZSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUzIuaW5jb21lLCB0ZXh0VHJhbnNmb3JtOiAidXBwZXJjYXNlIiB9LCBjaGlsZHJlbjogIkdyb3d0aCIgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMyLnRleHRNYWluIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3Ryb25nIiwgeyBjaGlsZHJlbjogZm10KGFubnVhbE5ldCkgfSksCiAgICAgICAgICAiL3lyIgogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSwgbWFyZ2luVG9wOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAiMnlyOiArIiwKICAgICAgICAgIGZtdChhbm51YWxOZXQgKiAyKSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJiciIsIHt9KSwKICAgICAgICAgICI1eXI6ICsiLAogICAgICAgICAgZm10KGFubnVhbE5ldCAqIDUpCiAgICAgICAgXSB9KQogICAgICBdIH0pIDogbnVsbAogICAgXSB9KSB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuY2FyZCwKICAgICAgYm9yZGVyUmFkaXVzOiAxMiwKICAgICAgcGFkZGluZzogIjE2cHgiLAogICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLAogICAgICBtYXJnaW5Cb3R0b206IDEyCiAgICB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIsIGxldHRlclNwYWNpbmc6IDAuNSwgbWFyZ2luQm90dG9tOiAxMiB9LCBjaGlsZHJlbjogIkFzc2V0IEJyZWFrZG93biIgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGZsZXhEaXJlY3Rpb246ICJjb2x1bW4iLCBnYXA6IDYgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIkxpcXVpZCBhc3NldHMiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTMi5hc3NldCB9LCBjaGlsZHJlbjogZm10RXhhY3QodG90YWxMaXF1aWRBc3NldHMpIH0pCiAgICAgICAgXSB9KSwKICAgICAgICBvbmVUaW1lTGlhYmlsaXRpZXMgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBwYWRkaW5nTGVmdDogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCB9LCBjaGlsZHJlbjogIlx1MjIxMiBPbmUtdGltZSBkZWJ0cyIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTMi5saWFiaWxpdHkgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgIlx1MjIxMiIsCiAgICAgICAgICAgIGZtdEV4YWN0KG9uZVRpbWVMaWFiaWxpdGllcykKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBwYWRkaW5nTGVmdDogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIj0gTGlxdWlkIGF2YWlsYWJsZSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBsaXF1aWRBZnRlckxpYWJpbGl0aWVzID49IDAgPyBDT0xPUlMyLnBvc2l0aXZlIDogQ09MT1JTMi5uZWdhdGl2ZSB9LCBjaGlsZHJlbjogZm10RXhhY3QobGlxdWlkQWZ0ZXJMaWFiaWxpdGllcykgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBib3JkZXJUb3A6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlckxpZ2h0fWAsIG1hcmdpblRvcDogNCwgcGFkZGluZ1RvcDogNiwgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgIk5vbi1saXF1aWQgKGF0ICIsCiAgICAgICAgICAgIGJ1ZGdldC5ub25MaXF1aWREaXNjb3VudCwKICAgICAgICAgICAgIiUgZGlzY291bnQpIgogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUzIubm9uTGlxdWlkIH0sIGNoaWxkcmVuOiBmbXRFeGFjdChub25MaXF1aWRBdERpc2NvdW50KSB9KQogICAgICAgIF0gfSksCiAgICAgICAgdG90YWxSZXRpcmVtZW50ID4gMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIjQwMWsgLyBSZXRpcmVtZW50IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUzIucmV0aXJlbWVudCB9LCBjaGlsZHJlbjogZm10RXhhY3QodG90YWxSZXRpcmVtZW50KSB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGJvcmRlclRvcDogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsIG1hcmdpblRvcDogNCwgcGFkZGluZ1RvcDogOCwgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTMi50ZXh0TWFpbiB9LCBjaGlsZHJlbjogIk5ldCBXb3J0aCIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE4LCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBuZXRXb3J0aCA+PSAwID8gQ09MT1JTMi5wb3NpdGl2ZSA6IENPTE9SUzIubmVnYXRpdmUgfSwgY2hpbGRyZW46IGZtdEV4YWN0KG5ldFdvcnRoKSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KQogICAgXSB9KSwKICAgICgoKSA9PiB7CiAgICAgIGNvbnN0IHByb2plY3Rpb25ZZWFycyA9IDIwOwogICAgICBjb25zdCBzdGFydExpcXVpZCA9IE1hdGgubWF4KDAsIGxpcXVpZEFmdGVyTGlhYmlsaXRpZXMpOwogICAgICBjb25zdCBzdGFydEV4dCA9IE1hdGgubWF4KDAsIG5ldFdvcnRoKTsKICAgICAgY29uc3QgZGF0YSA9IFtdOwogICAgICBjb25zdCBhbm51YWxCdXJuID0gbW9udGhseUJ1cm4gKiAxMjsKICAgICAgbGV0IGJhbExpcXVpZCA9IHN0YXJ0TGlxdWlkOwogICAgICBsZXQgYmFsRXh0ZW5kZWQgPSBzdGFydEV4dDsKICAgICAgbGV0IGxpcXVpZEhpdFplcm8gPSBmYWxzZTsKICAgICAgbGV0IGV4dEhpdFplcm8gPSBmYWxzZTsKICAgICAgZm9yIChsZXQgeXIgPSAwOyB5ciA8PSBwcm9qZWN0aW9uWWVhcnM7IHlyKyspIHsKICAgICAgICBkYXRhLnB1c2goewogICAgICAgICAgeWVhcjogeXIsCiAgICAgICAgICBsaXF1aWQ6IE1hdGgucm91bmQoTWF0aC5tYXgoMCwgYmFsTGlxdWlkKSksCiAgICAgICAgICBleHRlbmRlZDogbm9uTGlxdWlkQXREaXNjb3VudCA+IDAgfHwgdG90YWxSZXRpcmVtZW50ID4gMCA/IE1hdGgucm91bmQoTWF0aC5tYXgoMCwgYmFsRXh0ZW5kZWQpKSA6IDAKICAgICAgICB9KTsKICAgICAgICBpZiAobW9udGhseUJ1cm4gPiAwKSB7CiAgICAgICAgICBiYWxMaXF1aWQgLT0gYW5udWFsQnVybjsKICAgICAgICAgIGJhbEV4dGVuZGVkIC09IGFubnVhbEJ1cm47CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhbExpcXVpZCArPSBhbm51YWxOZXQ7CiAgICAgICAgICBiYWxFeHRlbmRlZCArPSBhbm51YWxOZXQ7CiAgICAgICAgfQogICAgICAgIGlmIChiYWxMaXF1aWQgPD0gMCkgbGlxdWlkSGl0WmVybyA9IHRydWU7CiAgICAgICAgaWYgKGJhbEV4dGVuZGVkIDw9IDApIGV4dEhpdFplcm8gPSB0cnVlOwogICAgICAgIGlmIChsaXF1aWRIaXRaZXJvICYmIGV4dEhpdFplcm8pIGJyZWFrOwogICAgICB9CiAgICAgIGNvbnN0IGxpcXVpZFplcm9ZZWFyID0gbW9udGhseUJ1cm4gPiAwID8gZGF0YS5maW5kKChkLCBpKSA9PiBpID4gMCAmJiBkLmxpcXVpZCA9PT0gMCk/LnllYXIgOiBudWxsOwogICAgICBjb25zdCBleHRaZXJvWWVhciA9IG1vbnRobHlCdXJuID4gMCA/IGRhdGEuZmluZCgoZCwgaSkgPT4gaSA+IDAgJiYgZC5leHRlbmRlZCA9PT0gMCk/LnllYXIgOiBudWxsOwogICAgICBjb25zdCBtYXhWYWwgPSBNYXRoLm1heCguLi5kYXRhLm1hcCgoZCkgPT4gTWF0aC5tYXgoZC5saXF1aWQsIGQuZXh0ZW5kZWQpKSk7CiAgICAgIGNvbnN0IG1pblZhbCA9IE1hdGgubWluKC4uLmRhdGEubWFwKChkKSA9PiBNYXRoLm1pbihkLmxpcXVpZCwgZC5leHRlbmRlZCkpKTsKICAgICAgY29uc3QgZm9ybWF0WUF4aXMgPSAodmFsKSA9PiB7CiAgICAgICAgaWYgKE1hdGguYWJzKHZhbCkgPj0gMWU2KSByZXR1cm4gYCQkeyh2YWwgLyAxZTYpLnRvRml4ZWQoMSl9TWA7CiAgICAgICAgaWYgKE1hdGguYWJzKHZhbCkgPj0gMWUzKSByZXR1cm4gYCQkeyh2YWwgLyAxZTMpLnRvRml4ZWQoMCl9S2A7CiAgICAgICAgcmV0dXJuIGAkJHt2YWx9YDsKICAgICAgfTsKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5jYXJkLAogICAgICAgIGJvcmRlclJhZGl1czogMTIsCiAgICAgICAgcGFkZGluZzogIjE2cHgiLAogICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsCiAgICAgICAgbWFyZ2luQm90dG9tOiAxMgogICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIsIGxldHRlclNwYWNpbmc6IDAuNSwgbWFyZ2luQm90dG9tOiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgbW9udGhseUJ1cm4gPiAwID8gIlJ1bndheSBQcm9qZWN0aW9uIiA6ICJXZWFsdGggUHJvamVjdGlvbiIsCiAgICAgICAgICAiIFx1MjAxNCAiLAogICAgICAgICAgcHJvamVjdGlvblllYXJzLAogICAgICAgICAgIiBZZWFycyIKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGhlaWdodDogMjQwLCB3aWR0aDogIjEwMCUiLCBmb250U2l6ZTogMTEgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFJlc3BvbnNpdmVDb250YWluZXIsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKShBcmVhQ2hhcnQsIHsgZGF0YSwgbWFyZ2luOiB7IHRvcDogMTAsIHJpZ2h0OiAxMCwgbGVmdDogLTEwLCBib3R0b206IDAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGVmcyIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJsaW5lYXJHcmFkaWVudCIsIHsgaWQ6ICJncmFkTGlxdWlkIiwgeDE6ICIwIiwgeTE6ICIwIiwgeDI6ICIwIiwgeTI6ICIxIiwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3RvcCIsIHsgb2Zmc2V0OiAiNSUiLCBzdG9wQ29sb3I6IG1vbnRobHlCdXJuID4gMCA/IENPTE9SUzIuZXhwZW5zZSA6IENPTE9SUzIuaW5jb21lLCBzdG9wT3BhY2l0eTogMC4xNSB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3RvcCIsIHsgb2Zmc2V0OiAiOTUlIiwgc3RvcENvbG9yOiBtb250aGx5QnVybiA+IDAgPyBDT0xPUlMyLmV4cGVuc2UgOiBDT0xPUlMyLmluY29tZSwgc3RvcE9wYWNpdHk6IDAgfSkKICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJsaW5lYXJHcmFkaWVudCIsIHsgaWQ6ICJncmFkRXh0ZW5kZWQiLCB4MTogIjAiLCB5MTogIjAiLCB4MjogIjAiLCB5MjogIjEiLCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzdG9wIiwgeyBvZmZzZXQ6ICI1JSIsIHN0b3BDb2xvcjogQ09MT1JTMi5ub25MaXF1aWQsIHN0b3BPcGFjaXR5OiAwLjEgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInN0b3AiLCB7IG9mZnNldDogIjk1JSIsIHN0b3BDb2xvcjogQ09MT1JTMi5ub25MaXF1aWQsIHN0b3BPcGFjaXR5OiAwIH0pCiAgICAgICAgICAgIF0gfSkKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShDYXJ0ZXNpYW5HcmlkLCB7IHN0cm9rZURhc2hhcnJheTogIjMgMyIsIHZlcnRpY2FsOiBmYWxzZSwgc3Ryb2tlOiBDT0xPUlMyLmJvcmRlckxpZ2h0IH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgICAgIFhBeGlzLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZGF0YUtleTogInllYXIiLAogICAgICAgICAgICAgIHRpY2s6IHsgZmlsbDogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTEgfSwKICAgICAgICAgICAgICB0aWNrTGluZTogZmFsc2UsCiAgICAgICAgICAgICAgYXhpc0xpbmU6IHsgc3Ryb2tlOiBDT0xPUlMyLmJvcmRlciB9LAogICAgICAgICAgICAgIHRpY2tGb3JtYXR0ZXI6ICh2KSA9PiBgWXIgJHt2fWAKICAgICAgICAgICAgfQogICAgICAgICAgKSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKAogICAgICAgICAgICBZQXhpcywKICAgICAgICAgICAgewogICAgICAgICAgICAgIHRpY2s6IHsgZmlsbDogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTEgfSwKICAgICAgICAgICAgICB0aWNrRm9ybWF0dGVyOiBmb3JtYXRZQXhpcywKICAgICAgICAgICAgICB0aWNrTGluZTogZmFsc2UsCiAgICAgICAgICAgICAgYXhpc0xpbmU6IGZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICAgICksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgICAgICAgVG9vbHRpcCwKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvbnRlbnQ6ICh7IGFjdGl2ZSwgcGF5bG9hZCwgbGFiZWwgfSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGFjdGl2ZSAmJiBwYXlsb2FkICYmIHBheWxvYWQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGxpcSA9IHBheWxvYWQuZmluZCgocCkgPT4gcC5kYXRhS2V5ID09PSAibGlxdWlkIik/LnZhbHVlOwogICAgICAgICAgICAgICAgICBjb25zdCBleHQgPSBwYXlsb2FkLmZpbmQoKHApID0+IHAuZGF0YUtleSA9PT0gImV4dGVuZGVkIik/LnZhbHVlOwogICAgICAgICAgICAgICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwgcGFkZGluZzogMTIsIGJvcmRlclJhZGl1czogOCwgYm94U2hhZG93OiAiMCA0cHggMTJweCByZ2JhKDAsMCwwLDAuMSkiLCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLCBmb250U2l6ZTogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNzAwLCBtYXJnaW5Cb3R0b206IDYsIGNvbG9yOiBDT0xPUlMyLnRleHRNYWluIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAiWWVhciAiLAogICAgICAgICAgICAgICAgICAgICAgbGFiZWwKICAgICAgICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGdhcDogMTYsIG1hcmdpbkJvdHRvbTogMyB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGNvbG9yOiBtb250aGx5QnVybiA+IDAgPyBDT0xPUlMyLmV4cGVuc2UgOiBDT0xPUlMyLmluY29tZSwgZm9udFdlaWdodDogNjAwIH0sIGNoaWxkcmVuOiAiTGlxdWlkIiB9KSwKICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBsaXEgPj0gMCA/IENPTE9SUzIucG9zaXRpdmUgOiBDT0xPUlMyLm5lZ2F0aXZlIH0sIGNoaWxkcmVuOiBmbXQobGlxKSB9KQogICAgICAgICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgICAgICAgbm9uTGlxdWlkQXREaXNjb3VudCA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgZ2FwOiAxNiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMyLm5vbkxpcXVpZCwgZm9udFdlaWdodDogNjAwIH0sIGNoaWxkcmVuOiAiKyBOb24tbGlxdWlkIiB9KSwKICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBleHQgPj0gMCA/IENPTE9SUzIucG9zaXRpdmUgOiBDT0xPUlMyLm5lZ2F0aXZlIH0sIGNoaWxkcmVuOiBmbXQoZXh0KSB9KQogICAgICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICAgICAgXSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgKSwKICAgICAgICAgIG5vbkxpcXVpZEF0RGlzY291bnQgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKEFyZWEsIHsgdHlwZTogIm1vbm90b25lIiwgZGF0YUtleTogImV4dGVuZGVkIiwgc3Ryb2tlOiBDT0xPUlMyLm5vbkxpcXVpZCwgZmlsbDogInVybCgjZ3JhZEV4dGVuZGVkKSIsIHN0cm9rZVdpZHRoOiAyLCBzdHJva2VEYXNoYXJyYXk6ICI1IDUiLCBuYW1lOiAiRXh0ZW5kZWQiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoQXJlYSwgeyB0eXBlOiAibW9ub3RvbmUiLCBkYXRhS2V5OiAibGlxdWlkIiwgc3Ryb2tlOiBtb250aGx5QnVybiA+IDAgPyBDT0xPUlMyLmV4cGVuc2UgOiBDT0xPUlMyLmluY29tZSwgZmlsbDogInVybCgjZ3JhZExpcXVpZCkiLCBzdHJva2VXaWR0aDogMiwgbmFtZTogIkxpcXVpZCIgfSkKICAgICAgICBdIH0pIH0pIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgZ2FwOiAxNiwgbWFyZ2luVG9wOiA4LCBmb250U2l6ZTogMTEgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6IDE2LCBoZWlnaHQ6IDMsIGJhY2tncm91bmRDb2xvcjogbW9udGhseUJ1cm4gPiAwID8gQ09MT1JTMi5leHBlbnNlIDogQ09MT1JTMi5pbmNvbWUsIGJvcmRlclJhZGl1czogMiB9IH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIkxpcXVpZCBhc3NldHMiIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgbm9uTGlxdWlkQXREaXNjb3VudCA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyB3aWR0aDogMTYsIGhlaWdodDogMywgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLm5vbkxpcXVpZCwgYm9yZGVyUmFkaXVzOiAyLCBib3JkZXJUb3A6ICIxcHggZGFzaGVkIiB9IH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIisgTm9uLWxpcXVpZCBzb2xkIiB9KQogICAgICAgICAgXSB9KQogICAgICAgIF0gfSksCiAgICAgICAgbW9udGhseUJ1cm4gPiAwICYmIChsaXF1aWRaZXJvWWVhciB8fCBleHRaZXJvWWVhcikgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogOCwgcGFkZGluZzogIjhweCAxMnB4IiwgYm9yZGVyUmFkaXVzOiA4LCBiYWNrZ3JvdW5kQ29sb3I6IGAke0NPTE9SUzIuZXhwZW5zZX0wOGAsIGZvbnRTaXplOiAxMSwgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgbGlxdWlkWmVyb1llYXIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJMaXF1aWQgYXNzZXRzIGRlcGxldGVkIGF0ICIsCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgic3Ryb25nIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTMi5leHBlbnNlIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgInllYXIgIiwKICAgICAgICAgICAgICBsaXF1aWRaZXJvWWVhcgogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgZXh0WmVyb1llYXIgJiYgbm9uTGlxdWlkQXREaXNjb3VudCA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJBbGwgYXNzZXRzIGRlcGxldGVkIGF0ICIsCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgic3Ryb25nIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTMi5ub25MaXF1aWQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAieWVhciAiLAogICAgICAgICAgICAgIGV4dFplcm9ZZWFyCiAgICAgICAgICAgIF0gfSkKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSk7CiAgICB9KSgpCiAgXSB9KTsKfTsKdmFyIGh5ZHJhdGVGcm9tSW5pdGlhbERhdGEgPSAoZGF0YSkgPT4gewogIGlmICghZGF0YSB8fCB0eXBlb2YgZGF0YSAhPT0gIm9iamVjdCIpIHJldHVybiBudWxsOwogIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhkYXRhKS5maWx0ZXIoKGspID0+IGsgIT09ICJyZWFkeSIgJiYgayAhPT0gInRpbWVzdGFtcCIgJiYgayAhPT0gImlucHV0X3NvdXJjZSIgJiYgayAhPT0gInN1bW1hcnkiICYmIGsgIT09ICJzdWdnZXN0ZWRfZm9sbG93dXBzIik7CiAgaWYgKGtleXMubGVuZ3RoID09PSAwKSByZXR1cm4gbnVsbDsKICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gQXBwbHlpbmcgaW5pdGlhbERhdGE6IiwgZGF0YSk7CiAgY29uc3QgZmluZE9yQWRkID0gKGFyciwgbmFtZSwgYW1vdW50LCBmcmVxID0gIm9uZV90aW1lIikgPT4gewogICAgY29uc3QgZXhpc3RpbmcgPSBhcnIuZmluZCgoaSkgPT4gaS5uYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICBpZiAoZXhpc3RpbmcpIHsKICAgICAgZXhpc3RpbmcuYW1vdW50ID0gYW1vdW50OwogICAgICBPYmplY3QuYXNzaWduKGV4aXN0aW5nLCBjb21wdXRlVmFsdWVzKGFtb3VudCwgZXhpc3RpbmcuZnJlcXVlbmN5KSk7CiAgICAgIHJldHVybiBhcnI7CiAgICB9CiAgICBjb25zdCBpdGVtID0gZnJlcSA9PT0gIm9uZV90aW1lIiA/IG1pYShuYW1lLCBhbW91bnQpIDogbWkobmFtZSwgYW1vdW50LCBmcmVxKTsKICAgIHJldHVybiBbLi4uYXJyLCBpdGVtXTsKICB9OwogIGNvbnN0IHVwc2VydCA9IChhcnIsIG5hbWUsIGFtb3VudCwgZnJlcSA9ICJvbmVfdGltZSIpID0+IHsKICAgIGNvbnN0IGxjID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgY29uc3QgaWR4ID0gYXJyLmZpbmRJbmRleCgoaSkgPT4gaS5uYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMobGMpIHx8IGxjLmluY2x1ZGVzKGkubmFtZS50b0xvd2VyQ2FzZSgpKSk7CiAgICBpZiAoaWR4ID49IDApIHsKICAgICAgY29uc3QgaXRlbTIgPSBhcnJbaWR4XTsKICAgICAgYXJyW2lkeF0gPSB7IC4uLml0ZW0yLCBhbW91bnQsIC4uLmNvbXB1dGVWYWx1ZXMoYW1vdW50LCBpdGVtMi5mcmVxdWVuY3kpIH07CiAgICAgIHJldHVybiBhcnI7CiAgICB9CiAgICBjb25zdCBpdGVtID0gZnJlcSA9PT0gIm9uZV90aW1lIiA/IG1pYShuYW1lLCBhbW91bnQpIDogbWkobmFtZSwgYW1vdW50LCBmcmVxKTsKICAgIHJldHVybiBbLi4uYXJyLCBpdGVtXTsKICB9OwogIGxldCBiYXNlOwogIGlmIChkYXRhLnByZXNldCkgewogICAgY29uc3QgcHJlc2V0ID0gQlVER0VUX1BSRVNFVFMuZmluZCgocCkgPT4gcC5rZXkgPT09IGRhdGEucHJlc2V0KTsKICAgIGlmIChwcmVzZXQpIHsKICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgYmFzZSA9IHsgLi4uZW1wdHlCdWRnZXQoKSwgLi4ucHJlc2V0LmJ1ZGdldCwgaWQ6IGdlbmVyYXRlSWQoKSwgY3JlYXRlZEF0OiBub3csIHVwZGF0ZWRBdDogbm93IH07CiAgICB9IGVsc2UgewogICAgICBiYXNlID0gZW1wdHlCdWRnZXQoKTsKICAgIH0KICB9IGVsc2UgewogICAgYmFzZSA9IGVtcHR5QnVkZ2V0KCk7CiAgfQogIGlmIChkYXRhLmJ1ZGdldF9uYW1lKSBiYXNlLm5hbWUgPSBkYXRhLmJ1ZGdldF9uYW1lOwogIGlmIChkYXRhLmlzX3VuZW1wbG95ZWQpIHsKICAgIGlmIChiYXNlLmluY29tZS5sZW5ndGggPiAwKSB7CiAgICAgIGJhc2UuaW5jb21lID0gYmFzZS5pbmNvbWUubWFwKChpKSA9PiAoeyAuLi5pLCBhbW91bnQ6IDAsIC4uLmNvbXB1dGVWYWx1ZXMoMCwgaS5mcmVxdWVuY3kpIH0pKTsKICAgIH0KICAgIGlmICghYmFzZS5hc3NldHMuc29tZSgoYSkgPT4gL2VtZXJnZW5jeS9pLnRlc3QoYS5uYW1lKSkpIHsKICAgICAgYmFzZS5hc3NldHMgPSBmaW5kT3JBZGQoYmFzZS5hc3NldHMsICJFbWVyZ2VuY3kgRnVuZCIsIDApOwogICAgfQogIH0KICBpZiAoZGF0YS5pc19ob21lb3duZXIpIHsKICAgIGJhc2UuZXhwZW5zZXMgPSBiYXNlLmV4cGVuc2VzLm1hcCgoaSkgPT4gewogICAgICBpZiAoL1xicmVudFxiL2kudGVzdChpLm5hbWUpICYmICEvbW9ydGdhZ2UvaS50ZXN0KGkubmFtZSkpIHsKICAgICAgICByZXR1cm4geyAuLi5pLCBuYW1lOiAiTW9ydGdhZ2UgUGF5bWVudCIgfTsKICAgICAgfQogICAgICByZXR1cm4gaTsKICAgIH0pOwogIH0KICBpZiAoZGF0YS5udW1fY2hpbGRyZW4gJiYgZGF0YS5udW1fY2hpbGRyZW4gPiAwKSB7CiAgICBpZiAoIWJhc2UuZXhwZW5zZXMuc29tZSgoZSkgPT4gL2NoaWxkfGRheWNhcmV8a2lkcy9pLnRlc3QoZS5uYW1lKSkpIHsKICAgICAgYmFzZS5leHBlbnNlcyA9IGZpbmRPckFkZChiYXNlLmV4cGVuc2VzLCAiQ2hpbGRjYXJlIC8gRGF5Y2FyZSIsIGRhdGEubnVtX2NoaWxkcmVuICogODAwLCAibW9udGhseSIpOwogICAgfQogIH0KICBjb25zdCBlZmZlY3RpdmVNb250aGx5SW5jb21lID0gZGF0YS5tb250aGx5X2luY29tZSB8fCAoZGF0YS5hbm51YWxfaW5jb21lID8gTWF0aC5yb3VuZChkYXRhLmFubnVhbF9pbmNvbWUgLyAxMikgOiB2b2lkIDApOwogIGlmIChkYXRhLnNhbGFyeSkgYmFzZS5pbmNvbWUgPSB1cHNlcnQoYmFzZS5pbmNvbWUsICJTYWxhcnkiLCBkYXRhLnNhbGFyeSwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5zaWRlX2luY29tZSkgYmFzZS5pbmNvbWUgPSB1cHNlcnQoYmFzZS5pbmNvbWUsICJGcmVlbGFuY2UgLyBTaWRlIEh1c3RsZSIsIGRhdGEuc2lkZV9pbmNvbWUsICJtb250aGx5Iik7CiAgaWYgKGRhdGEucmVudGFsX2luY29tZSkgYmFzZS5pbmNvbWUgPSB1cHNlcnQoYmFzZS5pbmNvbWUsICJSZW50YWwgSW5jb21lIiwgZGF0YS5yZW50YWxfaW5jb21lLCAibW9udGhseSIpOwogIGlmIChkYXRhLnNvY2lhbF9zZWN1cml0eSkgYmFzZS5pbmNvbWUgPSB1cHNlcnQoYmFzZS5pbmNvbWUsICJTb2NpYWwgU2VjdXJpdHkiLCBkYXRhLnNvY2lhbF9zZWN1cml0eSwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5wZW5zaW9uX2luY29tZSkgYmFzZS5pbmNvbWUgPSB1cHNlcnQoYmFzZS5pbmNvbWUsICJQZW5zaW9uIiwgZGF0YS5wZW5zaW9uX2luY29tZSwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5pbnZlc3RtZW50X2luY29tZSkgYmFzZS5pbmNvbWUgPSB1cHNlcnQoYmFzZS5pbmNvbWUsICJJbnZlc3RtZW50IEluY29tZSIsIGRhdGEuaW52ZXN0bWVudF9pbmNvbWUsICJtb250aGx5Iik7CiAgaWYgKGVmZmVjdGl2ZU1vbnRobHlJbmNvbWUgJiYgIWRhdGEuc2FsYXJ5ICYmICFkYXRhLnNpZGVfaW5jb21lICYmICFkYXRhLnJlbnRhbF9pbmNvbWUgJiYgIWRhdGEuc29jaWFsX3NlY3VyaXR5ICYmICFkYXRhLnBlbnNpb25faW5jb21lKSB7CiAgICBjb25zdCBjdXJyZW50VG90YWwgPSBiYXNlLmluY29tZS5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLm1vbnRobHlWYWx1ZSwgMCk7CiAgICBpZiAoY3VycmVudFRvdGFsID4gMCkgewogICAgICBjb25zdCByYXRpbyA9IGVmZmVjdGl2ZU1vbnRobHlJbmNvbWUgLyBjdXJyZW50VG90YWw7CiAgICAgIGJhc2UuaW5jb21lID0gYmFzZS5pbmNvbWUubWFwKChpKSA9PiB7CiAgICAgICAgY29uc3QgbmV3QW10ID0gTWF0aC5yb3VuZChpLmFtb3VudCAqIHJhdGlvKTsKICAgICAgICByZXR1cm4geyAuLi5pLCBhbW91bnQ6IG5ld0FtdCwgLi4uY29tcHV0ZVZhbHVlcyhuZXdBbXQsIGkuZnJlcXVlbmN5KSB9OwogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoYmFzZS5pbmNvbWUubGVuZ3RoID09PSAwKSB7CiAgICAgIGJhc2UuaW5jb21lID0gW21pKCJJbmNvbWUiLCBlZmZlY3RpdmVNb250aGx5SW5jb21lKV07CiAgICB9CiAgfQogIGlmIChkYXRhLnJlbnQpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIlJlbnQiLCBkYXRhLnJlbnQsICJtb250aGx5Iik7CiAgaWYgKGRhdGEubW9ydGdhZ2VfcGF5bWVudCkgYmFzZS5leHBlbnNlcyA9IHVwc2VydChiYXNlLmV4cGVuc2VzLCAiTW9ydGdhZ2UgUGF5bWVudCIsIGRhdGEubW9ydGdhZ2VfcGF5bWVudCwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS51dGlsaXRpZXMpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIlV0aWxpdGllcyIsIGRhdGEudXRpbGl0aWVzLCAibW9udGhseSIpOwogIGlmIChkYXRhLmdyb2NlcmllcykgYmFzZS5leHBlbnNlcyA9IHVwc2VydChiYXNlLmV4cGVuc2VzLCAiR3JvY2VyaWVzIiwgZGF0YS5ncm9jZXJpZXMsICJtb250aGx5Iik7CiAgaWYgKGRhdGEuY2FyX3BheW1lbnQpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIkNhciBQYXltZW50IiwgZGF0YS5jYXJfcGF5bWVudCwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5jYXJfaW5zdXJhbmNlKSBiYXNlLmV4cGVuc2VzID0gdXBzZXJ0KGJhc2UuZXhwZW5zZXMsICJDYXIgSW5zdXJhbmNlIiwgZGF0YS5jYXJfaW5zdXJhbmNlLCAibW9udGhseSIpOwogIGlmIChkYXRhLmhlYWx0aF9pbnN1cmFuY2UpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIkhlYWx0aCBJbnN1cmFuY2UiLCBkYXRhLmhlYWx0aF9pbnN1cmFuY2UsICJtb250aGx5Iik7CiAgaWYgKGRhdGEucGhvbmVfYmlsbCkgYmFzZS5leHBlbnNlcyA9IHVwc2VydChiYXNlLmV4cGVuc2VzLCAiUGhvbmUgQmlsbCIsIGRhdGEucGhvbmVfYmlsbCwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5pbnRlcm5ldCkgYmFzZS5leHBlbnNlcyA9IHVwc2VydChiYXNlLmV4cGVuc2VzLCAiSW50ZXJuZXQiLCBkYXRhLmludGVybmV0LCAibW9udGhseSIpOwogIGlmIChkYXRhLmNoaWxkY2FyZSkgYmFzZS5leHBlbnNlcyA9IHVwc2VydChiYXNlLmV4cGVuc2VzLCAiQ2hpbGRjYXJlIC8gRGF5Y2FyZSIsIGRhdGEuY2hpbGRjYXJlLCAibW9udGhseSIpOwogIGlmIChkYXRhLnN1YnNjcmlwdGlvbnMpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIlN1YnNjcmlwdGlvbnMiLCBkYXRhLnN1YnNjcmlwdGlvbnMsICJtb250aGx5Iik7CiAgaWYgKGRhdGEuZGluaW5nX291dCkgYmFzZS5leHBlbnNlcyA9IHVwc2VydChiYXNlLmV4cGVuc2VzLCAiRGluaW5nIE91dCIsIGRhdGEuZGluaW5nX291dCwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS50cmFuc3BvcnRhdGlvbikgYmFzZS5leHBlbnNlcyA9IHVwc2VydChiYXNlLmV4cGVuc2VzLCAiR2FzIC8gVHJhbnNwb3J0YXRpb24iLCBkYXRhLnRyYW5zcG9ydGF0aW9uLCAibW9udGhseSIpOwogIGlmIChkYXRhLm1vbnRobHlfZXhwZW5zZXMgJiYgIWRhdGEucmVudCAmJiAhZGF0YS5tb3J0Z2FnZV9wYXltZW50ICYmICFkYXRhLmdyb2NlcmllcykgewogICAgY29uc3QgY3VycmVudFRvdGFsID0gYmFzZS5leHBlbnNlcy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLm1vbnRobHlWYWx1ZSwgMCk7CiAgICBpZiAoY3VycmVudFRvdGFsID4gMCkgewogICAgICBjb25zdCByYXRpbyA9IGRhdGEubW9udGhseV9leHBlbnNlcyAvIGN1cnJlbnRUb3RhbDsKICAgICAgYmFzZS5leHBlbnNlcyA9IGJhc2UuZXhwZW5zZXMubWFwKChpKSA9PiB7CiAgICAgICAgY29uc3QgbmV3QW10ID0gTWF0aC5yb3VuZChpLmFtb3VudCAqIHJhdGlvKTsKICAgICAgICByZXR1cm4geyAuLi5pLCBhbW91bnQ6IG5ld0FtdCwgLi4uY29tcHV0ZVZhbHVlcyhuZXdBbXQsIGkuZnJlcXVlbmN5KSB9OwogICAgICB9KTsKICAgIH0KICB9CiAgaWYgKGRhdGEuY2hlY2tpbmdfYmFsYW5jZSkgYmFzZS5hc3NldHMgPSB1cHNlcnQoYmFzZS5hc3NldHMsICJDaGVja2luZyBBY2NvdW50IiwgZGF0YS5jaGVja2luZ19iYWxhbmNlKTsKICBpZiAoZGF0YS5zYXZpbmdzX2JhbGFuY2UpIGJhc2UuYXNzZXRzID0gdXBzZXJ0KGJhc2UuYXNzZXRzLCAiU2F2aW5ncyBBY2NvdW50IiwgZGF0YS5zYXZpbmdzX2JhbGFuY2UpOwogIGlmIChkYXRhLmVtZXJnZW5jeV9mdW5kKSBiYXNlLmFzc2V0cyA9IHVwc2VydChiYXNlLmFzc2V0cywgIkVtZXJnZW5jeSBGdW5kIiwgZGF0YS5lbWVyZ2VuY3lfZnVuZCk7CiAgaWYgKGRhdGEuaW52ZXN0bWVudF9iYWxhbmNlKSBiYXNlLmFzc2V0cyA9IHVwc2VydChiYXNlLmFzc2V0cywgIkJyb2tlcmFnZSBBY2NvdW50IiwgZGF0YS5pbnZlc3RtZW50X2JhbGFuY2UpOwogIGlmIChkYXRhLmNyeXB0b190aWNrZXJzKSB7CiAgICBjb25zdCB0aWNrZXJzID0gZGF0YS5jcnlwdG9fdGlja2Vycy5zcGxpdCgiLCIpLm1hcCgodCkgPT4gdC50cmltKCkudG9Mb3dlckNhc2UoKSkuZmlsdGVyKEJvb2xlYW4pOwogICAgZm9yIChjb25zdCB0aWNrZXIyIG9mIHRpY2tlcnMpIHsKICAgICAgY29uc3QgbmFtZSA9IHRpY2tlcjIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyB0aWNrZXIyLnNsaWNlKDEpOwogICAgICBpZiAoIWJhc2UuYXNzZXRzLnNvbWUoKGEpID0+IGEudGlja2VyID09PSB0aWNrZXIyKSkgewogICAgICAgIGJhc2UuYXNzZXRzLnB1c2goeyAuLi5taWEobmFtZSwgMCksIGFzc2V0VHlwZTogImNyeXB0byIsIHRpY2tlcjogdGlja2VyMiwgcXVhbnRpdHk6IHZvaWQgMCB9KTsKICAgICAgfQogICAgfQogIH0gZWxzZSBpZiAoZGF0YS5oYXNfY3J5cHRvIHx8IGRhdGEuY3J5cHRvX2JhbGFuY2UpIHsKICAgIGlmICghYmFzZS5hc3NldHMuc29tZSgoYSkgPT4gYS5hc3NldFR5cGUgPT09ICJjcnlwdG8iIHx8IC9jcnlwdG8vaS50ZXN0KGEubmFtZSkpKSB7CiAgICAgIGJhc2UuYXNzZXRzLnB1c2goeyAuLi5taWEoIkNyeXB0byBQb3J0Zm9saW8iLCBkYXRhLmNyeXB0b19iYWxhbmNlIHx8IDApLCBhc3NldFR5cGU6ICJjcnlwdG8iLCB0aWNrZXI6ICJiaXRjb2luIiB9KTsKICAgIH0gZWxzZSBpZiAoZGF0YS5jcnlwdG9fYmFsYW5jZSkgewogICAgICBiYXNlLmFzc2V0cyA9IGJhc2UuYXNzZXRzLm1hcCgoYSkgPT4gYS5hc3NldFR5cGUgPT09ICJjcnlwdG8iIHx8IC9jcnlwdG8vaS50ZXN0KGEubmFtZSkgPyB7IC4uLmEsIGFtb3VudDogZGF0YS5jcnlwdG9fYmFsYW5jZSwgdG90YWxWYWx1ZTogZGF0YS5jcnlwdG9fYmFsYW5jZSB9IDogYSk7CiAgICB9CiAgfQogIGlmIChkYXRhLnN0b2NrX3RpY2tlcnMpIHsKICAgIGNvbnN0IHRpY2tlcnMgPSBkYXRhLnN0b2NrX3RpY2tlcnMuc3BsaXQoIiwiKS5tYXAoKHQpID0+IHQudHJpbSgpLnRvVXBwZXJDYXNlKCkpLmZpbHRlcihCb29sZWFuKTsKICAgIGZvciAoY29uc3QgdGlja2VyMiBvZiB0aWNrZXJzKSB7CiAgICAgIGlmICghYmFzZS5hc3NldHMuc29tZSgoYSkgPT4gYS50aWNrZXIgPT09IHRpY2tlcjIgJiYgYS5hc3NldFR5cGUgPT09ICJzdG9jayIpKSB7CiAgICAgICAgYmFzZS5hc3NldHMucHVzaCh7IC4uLm1pYSh0aWNrZXIyLCAwKSwgYXNzZXRUeXBlOiAic3RvY2siLCB0aWNrZXI6IHRpY2tlcjIsIHF1YW50aXR5OiB2b2lkIDAgfSk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgaWYgKGRhdGEuaGFzX3N0b2NrcykgewogICAgaWYgKCFiYXNlLmFzc2V0cy5zb21lKChhKSA9PiBhLmFzc2V0VHlwZSA9PT0gInN0b2NrIiB8fCAvc3RvY2t8YnJva2VyYWdlL2kudGVzdChhLm5hbWUpKSkgewogICAgICBiYXNlLmFzc2V0cy5wdXNoKHsgLi4ubWlhKCJTdG9ja3MvQnJva2VyYWdlIiwgMCksIGFzc2V0VHlwZTogInN0b2NrIiB9KTsKICAgIH0KICB9CiAgaWYgKGRhdGEubGlxdWlkX2Fzc2V0cyAmJiAhZGF0YS5jaGVja2luZ19iYWxhbmNlICYmICFkYXRhLnNhdmluZ3NfYmFsYW5jZSAmJiAhZGF0YS5lbWVyZ2VuY3lfZnVuZCkgewogICAgY29uc3QgbGlxdWlkSXRlbXMgPSBiYXNlLmFzc2V0cy5maWx0ZXIoKGEpID0+ICFhLmFzc2V0VHlwZSB8fCBhLmFzc2V0VHlwZSA9PT0gIm1hbnVhbCIpOwogICAgY29uc3QgY3VycmVudFRvdGFsID0gbGlxdWlkSXRlbXMucmVkdWNlKChzLCBpKSA9PiBzICsgaS50b3RhbFZhbHVlLCAwKTsKICAgIGlmIChjdXJyZW50VG90YWwgPiAwKSB7CiAgICAgIGNvbnN0IHJhdGlvID0gZGF0YS5saXF1aWRfYXNzZXRzIC8gY3VycmVudFRvdGFsOwogICAgICBiYXNlLmFzc2V0cyA9IGJhc2UuYXNzZXRzLm1hcCgoaSkgPT4gewogICAgICAgIGlmIChpLmFzc2V0VHlwZSAmJiBpLmFzc2V0VHlwZSAhPT0gIm1hbnVhbCIpIHJldHVybiBpOwogICAgICAgIGNvbnN0IG5ld0FtdCA9IE1hdGgucm91bmQoaS5hbW91bnQgKiByYXRpbyk7CiAgICAgICAgcmV0dXJuIHsgLi4uaSwgYW1vdW50OiBuZXdBbXQsIHRvdGFsVmFsdWU6IG5ld0FtdCwgbW9udGhseVZhbHVlOiAwIH07CiAgICAgIH0pOwogICAgfQogIH0KICBpZiAoZGF0YS5ob21lX3ZhbHVlKSBiYXNlLm5vbkxpcXVpZEFzc2V0cyA9IHVwc2VydChiYXNlLm5vbkxpcXVpZEFzc2V0cywgIkhvbWUgVmFsdWUiLCBkYXRhLmhvbWVfdmFsdWUpOwogIGlmIChkYXRhLmNhcl92YWx1ZSkgYmFzZS5ub25MaXF1aWRBc3NldHMgPSB1cHNlcnQoYmFzZS5ub25MaXF1aWRBc3NldHMsICJDYXIgVmFsdWUiLCBkYXRhLmNhcl92YWx1ZSk7CiAgaWYgKGRhdGEuamV3ZWxyeV9jb2xsZWN0aWJsZXMpIGJhc2Uubm9uTGlxdWlkQXNzZXRzID0gdXBzZXJ0KGJhc2Uubm9uTGlxdWlkQXNzZXRzLCAiSmV3ZWxyeSAvIENvbGxlY3RpYmxlcyIsIGRhdGEuamV3ZWxyeV9jb2xsZWN0aWJsZXMpOwogIGlmIChkYXRhLmJ1c2luZXNzX2VxdWl0eSkgYmFzZS5ub25MaXF1aWRBc3NldHMgPSB1cHNlcnQoYmFzZS5ub25MaXF1aWRBc3NldHMsICJCdXNpbmVzcyBFcXVpdHkiLCBkYXRhLmJ1c2luZXNzX2VxdWl0eSk7CiAgaWYgKGRhdGEubm9ubGlxdWlkX2Fzc2V0cyAmJiAhZGF0YS5ob21lX3ZhbHVlICYmICFkYXRhLmNhcl92YWx1ZSkgewogICAgY29uc3QgY3VycmVudFRvdGFsID0gYmFzZS5ub25MaXF1aWRBc3NldHMucmVkdWNlKChzLCBpKSA9PiBzICsgaS50b3RhbFZhbHVlLCAwKTsKICAgIGlmIChjdXJyZW50VG90YWwgPiAwKSB7CiAgICAgIGNvbnN0IHJhdGlvID0gZGF0YS5ub25saXF1aWRfYXNzZXRzIC8gY3VycmVudFRvdGFsOwogICAgICBiYXNlLm5vbkxpcXVpZEFzc2V0cyA9IGJhc2Uubm9uTGlxdWlkQXNzZXRzLm1hcCgoaSkgPT4gewogICAgICAgIGNvbnN0IG5ld0FtdCA9IE1hdGgucm91bmQoaS5hbW91bnQgKiByYXRpbyk7CiAgICAgICAgcmV0dXJuIHsgLi4uaSwgYW1vdW50OiBuZXdBbXQsIHRvdGFsVmFsdWU6IG5ld0FtdCwgbW9udGhseVZhbHVlOiAwIH07CiAgICAgIH0pOwogICAgfQogIH0KICBpZiAoZGF0YS5ub25saXF1aWRfZGlzY291bnQgIT09IHZvaWQgMCkgYmFzZS5ub25MaXF1aWREaXNjb3VudCA9IGRhdGEubm9ubGlxdWlkX2Rpc2NvdW50OwogIGlmIChkYXRhLmJhbGFuY2VfNDAxaykgYmFzZS5yZXRpcmVtZW50ID0gdXBzZXJ0KGJhc2UucmV0aXJlbWVudCwgIjQwMWsiLCBkYXRhLmJhbGFuY2VfNDAxayk7CiAgaWYgKGRhdGEucm90aF9pcmEpIGJhc2UucmV0aXJlbWVudCA9IHVwc2VydChiYXNlLnJldGlyZW1lbnQsICJSb3RoIElSQSIsIGRhdGEucm90aF9pcmEpOwogIGlmIChkYXRhLnRyYWRpdGlvbmFsX2lyYSkgYmFzZS5yZXRpcmVtZW50ID0gdXBzZXJ0KGJhc2UucmV0aXJlbWVudCwgIlRyYWRpdGlvbmFsIElSQSIsIGRhdGEudHJhZGl0aW9uYWxfaXJhKTsKICBpZiAoZGF0YS5wZW5zaW9uX2Z1bmQpIGJhc2UucmV0aXJlbWVudCA9IHVwc2VydChiYXNlLnJldGlyZW1lbnQsICJQZW5zaW9uIEZ1bmQiLCBkYXRhLnBlbnNpb25fZnVuZCk7CiAgaWYgKGRhdGEuYmFsYW5jZV80MDNiKSBiYXNlLnJldGlyZW1lbnQgPSB1cHNlcnQoYmFzZS5yZXRpcmVtZW50LCAiNDAzYiIsIGRhdGEuYmFsYW5jZV80MDNiKTsKICBpZiAoZGF0YS5zZXBfaXJhKSBiYXNlLnJldGlyZW1lbnQgPSB1cHNlcnQoYmFzZS5yZXRpcmVtZW50LCAiU0VQIElSQSIsIGRhdGEuc2VwX2lyYSk7CiAgaWYgKGRhdGEucmV0aXJlbWVudF9zYXZpbmdzICYmICFkYXRhLmJhbGFuY2VfNDAxayAmJiAhZGF0YS5yb3RoX2lyYSAmJiAhZGF0YS50cmFkaXRpb25hbF9pcmEpIHsKICAgIGNvbnN0IGN1cnJlbnRUb3RhbCA9IGJhc2UucmV0aXJlbWVudC5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLnRvdGFsVmFsdWUsIDApOwogICAgaWYgKGN1cnJlbnRUb3RhbCA+IDApIHsKICAgICAgY29uc3QgcmF0aW8gPSBkYXRhLnJldGlyZW1lbnRfc2F2aW5ncyAvIGN1cnJlbnRUb3RhbDsKICAgICAgYmFzZS5yZXRpcmVtZW50ID0gYmFzZS5yZXRpcmVtZW50Lm1hcCgoaSkgPT4gewogICAgICAgIGNvbnN0IG5ld0FtdCA9IE1hdGgucm91bmQoaS5hbW91bnQgKiByYXRpbyk7CiAgICAgICAgcmV0dXJuIHsgLi4uaSwgYW1vdW50OiBuZXdBbXQsIHRvdGFsVmFsdWU6IG5ld0FtdCwgbW9udGhseVZhbHVlOiAwIH07CiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChiYXNlLnJldGlyZW1lbnQubGVuZ3RoID09PSAwKSB7CiAgICAgIGJhc2UucmV0aXJlbWVudCA9IFttaWEoIlJldGlyZW1lbnQgU2F2aW5ncyIsIGRhdGEucmV0aXJlbWVudF9zYXZpbmdzKV07CiAgICB9CiAgfQogIGlmIChkYXRhLm1vcnRnYWdlX2JhbGFuY2UpIGJhc2UubGlhYmlsaXRpZXMgPSB1cHNlcnQoYmFzZS5saWFiaWxpdGllcywgIk1vcnRnYWdlIiwgZGF0YS5tb3J0Z2FnZV9iYWxhbmNlKTsKICBpZiAoZGF0YS5zdHVkZW50X2xvYW5zKSBiYXNlLmxpYWJpbGl0aWVzID0gdXBzZXJ0KGJhc2UubGlhYmlsaXRpZXMsICJTdHVkZW50IExvYW5zIiwgZGF0YS5zdHVkZW50X2xvYW5zKTsKICBpZiAoZGF0YS5jYXJfbG9hbikgYmFzZS5saWFiaWxpdGllcyA9IHVwc2VydChiYXNlLmxpYWJpbGl0aWVzLCAiQ2FyIExvYW4iLCBkYXRhLmNhcl9sb2FuKTsKICBpZiAoZGF0YS5jcmVkaXRfY2FyZF9kZWJ0KSBiYXNlLmxpYWJpbGl0aWVzID0gdXBzZXJ0KGJhc2UubGlhYmlsaXRpZXMsICJDcmVkaXQgQ2FyZCBEZWJ0IiwgZGF0YS5jcmVkaXRfY2FyZF9kZWJ0KTsKICBpZiAoZGF0YS5wZXJzb25hbF9sb2FuKSBiYXNlLmxpYWJpbGl0aWVzID0gdXBzZXJ0KGJhc2UubGlhYmlsaXRpZXMsICJQZXJzb25hbCBMb2FuIiwgZGF0YS5wZXJzb25hbF9sb2FuKTsKICBpZiAoZGF0YS5tZWRpY2FsX2RlYnQpIGJhc2UubGlhYmlsaXRpZXMgPSB1cHNlcnQoYmFzZS5saWFiaWxpdGllcywgIk1lZGljYWwgQmlsbHMiLCBkYXRhLm1lZGljYWxfZGVidCk7CiAgaWYgKGRhdGEubGlhYmlsaXRpZXMgJiYgIWRhdGEubW9ydGdhZ2VfYmFsYW5jZSAmJiAhZGF0YS5zdHVkZW50X2xvYW5zICYmICFkYXRhLmNhcl9sb2FuICYmICFkYXRhLmNyZWRpdF9jYXJkX2RlYnQpIHsKICAgIGNvbnN0IGN1cnJlbnRUb3RhbCA9IGJhc2UubGlhYmlsaXRpZXMucmVkdWNlKChzLCBpKSA9PiBzICsgaS50b3RhbFZhbHVlLCAwKTsKICAgIGlmIChjdXJyZW50VG90YWwgPiAwKSB7CiAgICAgIGNvbnN0IHJhdGlvID0gZGF0YS5saWFiaWxpdGllcyAvIGN1cnJlbnRUb3RhbDsKICAgICAgYmFzZS5saWFiaWxpdGllcyA9IGJhc2UubGlhYmlsaXRpZXMubWFwKChpKSA9PiB7CiAgICAgICAgY29uc3QgbmV3QW10ID0gTWF0aC5yb3VuZChpLmFtb3VudCAqIHJhdGlvKTsKICAgICAgICByZXR1cm4geyAuLi5pLCBhbW91bnQ6IG5ld0FtdCwgLi4uY29tcHV0ZVZhbHVlcyhuZXdBbXQsIGkuZnJlcXVlbmN5KSB9OwogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoYmFzZS5saWFiaWxpdGllcy5sZW5ndGggPT09IDApIHsKICAgICAgYmFzZS5saWFiaWxpdGllcyA9IFttaWEoIlRvdGFsIERlYnQiLCBkYXRhLmxpYWJpbGl0aWVzKV07CiAgICB9CiAgfQogIHJldHVybiBiYXNlOwp9OwpmdW5jdGlvbiBNeUJ1ZGdldCh7IGluaXRpYWxEYXRhOiBpbml0aWFsRGF0YTIgfSkgewogIGNvbnN0IFtzZXNzaW9uLCBzZXRTZXNzaW9uXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkobnVsbCk7CiAgY29uc3QgW3Nob3dMb2dpbk1vZGFsLCBzZXRTaG93TG9naW5Nb2RhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbc2F2ZWRCdWRnZXRzLCBzZXRTYXZlZEJ1ZGdldHNdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSgoKSA9PiBsb2FkQnVkZ2V0cygpKTsKICBjb25zdCBbY3VycmVudFZpZXcsIHNldEN1cnJlbnRWaWV3XSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoImJ1ZGdldCIpOwogIGNvbnN0IFtidWRnZXQsIHNldEJ1ZGdldF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKCgpID0+IHsKICAgIGNvbnN0IGh5ZHJhdGVkID0gaHlkcmF0ZUZyb21Jbml0aWFsRGF0YShpbml0aWFsRGF0YTIpOwogICAgaWYgKGh5ZHJhdGVkKSByZXR1cm4gaHlkcmF0ZWQ7CiAgICByZXR1cm4gbG9hZEN1cnJlbnRCdWRnZXQoKSB8fCBlbXB0eUJ1ZGdldCgpOwogIH0pOwogIGNvbnN0IFtlZGl0aW5nTmFtZSwgc2V0RWRpdGluZ05hbWVdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW25hbWVJbnB1dCwgc2V0TmFtZUlucHV0XSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoYnVkZ2V0Lm5hbWUpOwogIGNvbnN0IFtyZWZyZXNoaW5nLCBzZXRSZWZyZXNoaW5nXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoZmFsc2UpOwogIGNvbnN0IFtzaG93U3Vic2NyaWJlTW9kYWwsIHNldFNob3dTdWJzY3JpYmVNb2RhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbc3Vic2NyaWJlRW1haWwsIHNldFN1YnNjcmliZUVtYWlsXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFtzdWJzY3JpYmVTdGF0dXMsIHNldFN1YnNjcmliZVN0YXR1c10gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKCJpZGxlIik7CiAgY29uc3QgW3N1YnNjcmliZU1lc3NhZ2UsIHNldFN1YnNjcmliZU1lc3NhZ2VdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSgiIik7CiAgY29uc3QgW3Nob3dGZWVkYmFja01vZGFsLCBzZXRTaG93RmVlZGJhY2tNb2RhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbZmVlZGJhY2tUZXh0LCBzZXRGZWVkYmFja1RleHRdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSgiIik7CiAgY29uc3QgW2ZlZWRiYWNrU3RhdHVzLCBzZXRGZWVkYmFja1N0YXR1c10gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKCJpZGxlIik7CiAgY29uc3QgW2NvbmZpcm1EaWFsb2csIHNldENvbmZpcm1EaWFsb2ddID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShudWxsKTsKICBjb25zdCBbZW5qb3lWb3RlLCBzZXRFbmpveVZvdGVdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShudWxsKTsKICBjb25zdCBbc2hvd05hbWVCdWRnZXRNb2RhbCwgc2V0U2hvd05hbWVCdWRnZXRNb2RhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbbmFtZUJ1ZGdldFZhbHVlLCBzZXROYW1lQnVkZ2V0VmFsdWVdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSgiIik7CiAgY29uc3QgW3NhdmVUb2FzdCwgc2V0U2F2ZVRvYXN0XSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoZmFsc2UpOwogIGNvbnN0IGNvbnRhaW5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VSZWYpKG51bGwpOwogIGNvbnN0IFtwaWxsUmlnaHQsIHNldFBpbGxSaWdodF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKDE2KTsKICAoMCwgaW1wb3J0X3JlYWN0NTIudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBzYXZlQ3VycmVudEJ1ZGdldChidWRnZXQpOwogICAgaWYgKHNlc3Npb24gJiYgc3VwYWJhc2UgJiYgYnVkZ2V0LmlkKSB7CiAgICAgIGNvbnN0IHN5bmNUb0Nsb3VkID0gYXN5bmMgKCkgPT4gewogICAgICAgIHRyeSB7CiAgICAgICAgICBhd2FpdCBzdXBhYmFzZS5mcm9tKCJidWRnZXRzIikudXBzZXJ0KHsKICAgICAgICAgICAgaWQ6IGJ1ZGdldC5pZCwKICAgICAgICAgICAgdXNlcl9pZDogc2Vzc2lvbi51c2VyLmlkLAogICAgICAgICAgICBidWRnZXRfZGF0YTogYnVkZ2V0LAogICAgICAgICAgICB1cGRhdGVkX2F0OiAoLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkpLnRvSVNPU3RyaW5nKCkKICAgICAgICAgIH0pOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBzeW5jIGJ1ZGdldCB0byBjbG91ZCIsIGUpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgc3luY1RvQ2xvdWQoKTsKICAgIH0KICB9LCBbYnVkZ2V0LCBzZXNzaW9uXSk7CiAgKDAsIGltcG9ydF9yZWFjdDUyLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFzdXBhYmFzZSkgcmV0dXJuOwogICAgY29uc3QgbG9hZENsb3VkRGF0YSA9IGFzeW5jICh1c2VySWQpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZS5mcm9tKCJidWRnZXRzIikuc2VsZWN0KCJidWRnZXRfZGF0YSIpLmVxKCJ1c2VyX2lkIiwgdXNlcklkKTsKICAgICAgICBpZiAoIWVycm9yICYmIGRhdGEgJiYgZGF0YS5sZW5ndGggPiAwKSB7CiAgICAgICAgICBjb25zdCBjbG91ZEJ1ZGdldHMgPSBkYXRhLm1hcCgocm93KSA9PiB7CiAgICAgICAgICAgIGlmICghcm93LmJ1ZGdldF9kYXRhLnVwZGF0ZWRBdCkgcm93LmJ1ZGdldF9kYXRhLnVwZGF0ZWRBdCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIHJldHVybiByb3cuYnVkZ2V0X2RhdGE7CiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChjbG91ZEJ1ZGdldHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBzZXRTYXZlZEJ1ZGdldHMoY2xvdWRCdWRnZXRzKTsKICAgICAgICAgICAgY29uc3QgbW9zdFJlY2VudCA9IFsuLi5jbG91ZEJ1ZGdldHNdLnNvcnQoKGEsIGIpID0+IGIudXBkYXRlZEF0IC0gYS51cGRhdGVkQXQpWzBdOwogICAgICAgICAgICBzZXRCdWRnZXQobW9zdFJlY2VudCk7CiAgICAgICAgICAgIHNhdmVDdXJyZW50QnVkZ2V0KG1vc3RSZWNlbnQpOwogICAgICAgICAgICBzYXZlQnVkZ2V0cyhjbG91ZEJ1ZGdldHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBsb2FkIGNsb3VkIGJ1ZGdldHMiLCBlKTsKICAgICAgfQogICAgfTsKICAgIHN1cGFiYXNlLmF1dGguZ2V0U2Vzc2lvbigpLnRoZW4oKHsgZGF0YTogeyBzZXNzaW9uOiBzZXNzaW9uMiB9IH0pID0+IHsKICAgICAgc2V0U2Vzc2lvbihzZXNzaW9uMik7CiAgICAgIGlmIChzZXNzaW9uMikgbG9hZENsb3VkRGF0YShzZXNzaW9uMi51c2VyLmlkKTsKICAgIH0pOwogICAgY29uc3QgewogICAgICBkYXRhOiB7IHN1YnNjcmlwdGlvbiB9CiAgICB9ID0gc3VwYWJhc2UuYXV0aC5vbkF1dGhTdGF0ZUNoYW5nZSgoX2V2ZW50LCBzZXNzaW9uMikgPT4gewogICAgICBzZXRTZXNzaW9uKHNlc3Npb24yKTsKICAgICAgaWYgKHNlc3Npb24yKSBsb2FkQ2xvdWREYXRhKHNlc3Npb24yLnVzZXIuaWQpOwogICAgfSk7CiAgICByZXR1cm4gKCkgPT4gc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7CiAgfSwgW10pOwogICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VFZmZlY3QpKCgpID0+IHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHYgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgiZW5qb3lWb3RlX2J1ZGdldCIpOwogICAgICBpZiAodiA9PT0gInVwIiB8fCB2ID09PSAiZG93biIpIHNldEVuam95Vm90ZSh2KTsKICAgIH0gY2F0Y2ggewogICAgfQogIH0sIFtdKTsKICAoMCwgaW1wb3J0X3JlYWN0NTIudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBjb25zdCB1cGRhdGUgPSAoKSA9PiB7CiAgICAgIGlmIChjb250YWluZXJSZWYuY3VycmVudCkgewogICAgICAgIGNvbnN0IHJlY3QgPSBjb250YWluZXJSZWYuY3VycmVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICBzZXRQaWxsUmlnaHQoTWF0aC5tYXgoMTYsIHdpbmRvdy5pbm5lcldpZHRoIC0gcmVjdC5yaWdodCArIDE2KSk7CiAgICAgIH0KICAgIH07CiAgICB1cGRhdGUoKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJyZXNpemUiLCB1cGRhdGUpOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInNjcm9sbCIsIHVwZGF0ZSk7CiAgICBjb25zdCBybyA9IHR5cGVvZiBSZXNpemVPYnNlcnZlciAhPT0gInVuZGVmaW5lZCIgPyBuZXcgUmVzaXplT2JzZXJ2ZXIodXBkYXRlKSA6IG51bGw7CiAgICBpZiAocm8gJiYgY29udGFpbmVyUmVmLmN1cnJlbnQpIHJvLm9ic2VydmUoY29udGFpbmVyUmVmLmN1cnJlbnQpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInJlc2l6ZSIsIHVwZGF0ZSk7CiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJzY3JvbGwiLCB1cGRhdGUpOwogICAgICBybz8uZGlzY29ubmVjdCgpOwogICAgfTsKICB9LCBbXSk7CiAgY29uc3QgaGFuZGxlRW5qb3lWb3RlID0gKHZvdGUpID0+IHsKICAgIGlmIChlbmpveVZvdGUpIHJldHVybjsKICAgIHNldEVuam95Vm90ZSh2b3RlKTsKICAgIHRyeSB7CiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCJlbmpveVZvdGVfYnVkZ2V0Iiwgdm90ZSk7CiAgICB9IGNhdGNoIHsKICAgIH0KICAgIHRyYWNrRXZlbnQoImVuam95X3ZvdGUiLCB7IHZvdGUsIGJ1ZGdldE5hbWU6IGJ1ZGdldC5uYW1lIHx8IG51bGwgfSk7CiAgICBzZXRTaG93RmVlZGJhY2tNb2RhbCh0cnVlKTsKICB9OwogIGNvbnN0IHJlZnJlc2hQcmljZXMgPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlQ2FsbGJhY2spKGFzeW5jICgpID0+IHsKICAgIHRyYWNrRXZlbnQoInJlZnJlc2hfcHJpY2VzIiwgeyBidWRnZXROYW1lOiBidWRnZXQubmFtZSB8fCBudWxsIH0pOwogICAgY29uc3QgYWxsSXRlbXMgPSBbLi4uYnVkZ2V0LmFzc2V0cywgLi4uYnVkZ2V0Lm5vbkxpcXVpZEFzc2V0cywgLi4uYnVkZ2V0LnJldGlyZW1lbnRdOwogICAgY29uc3QgY3J5cHRvSXRlbXMgPSBhbGxJdGVtcy5maWx0ZXIoKGkpID0+IGkuYXNzZXRUeXBlID09PSAiY3J5cHRvIiAmJiBpLnRpY2tlcik7CiAgICBjb25zdCBzdG9ja0l0ZW1zID0gYWxsSXRlbXMuZmlsdGVyKChpKSA9PiBpLmFzc2V0VHlwZSA9PT0gInN0b2NrIiAmJiBpLnRpY2tlcik7CiAgICBpZiAoY3J5cHRvSXRlbXMubGVuZ3RoID09PSAwICYmIHN0b2NrSXRlbXMubGVuZ3RoID09PSAwKSByZXR1cm47CiAgICBzZXRSZWZyZXNoaW5nKHRydWUpOwogICAgdHJ5IHsKICAgICAgY29uc3QgW2NyeXB0b1ByaWNlcywgc3RvY2tQcmljZXNdID0gYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgICAgIGNyeXB0b0l0ZW1zLmxlbmd0aCA+IDAgPyBmZXRjaENyeXB0b1ByaWNlcyhbLi4ubmV3IFNldChjcnlwdG9JdGVtcy5tYXAoKGkpID0+IGkudGlja2VyKSldKSA6IHt9LAogICAgICAgIHN0b2NrSXRlbXMubGVuZ3RoID4gMCA/IGZldGNoU3RvY2tQcmljZXMoWy4uLm5ldyBTZXQoc3RvY2tJdGVtcy5tYXAoKGkpID0+IGkudGlja2VyKSldKSA6IHt9CiAgICAgIF0pOwogICAgICBjb25zdCBhbGxQcmljZXMgPSB7IC4uLmNyeXB0b1ByaWNlcywgLi4uc3RvY2tQcmljZXMgfTsKICAgICAgc2V0QnVkZ2V0KChiKSA9PiB7CiAgICAgICAgY29uc3QgdXBkYXRlU2VjdGlvbiA9IChpdGVtcykgPT4gaXRlbXMubWFwKChpdGVtKSA9PiB7CiAgICAgICAgICBpZiAoIWl0ZW0uYXNzZXRUeXBlIHx8IGl0ZW0uYXNzZXRUeXBlID09PSAibWFudWFsIiB8fCAhaXRlbS50aWNrZXIgfHwgIWFsbFByaWNlc1tpdGVtLnRpY2tlcl0pIHJldHVybiBpdGVtOwogICAgICAgICAgY29uc3QgbmV3UHJpY2UgPSBhbGxQcmljZXNbaXRlbS50aWNrZXJdOwogICAgICAgICAgY29uc3QgbmV3QW1vdW50ID0gaXRlbS5xdWFudGl0eSA/IE1hdGgucm91bmQobmV3UHJpY2UgKiBpdGVtLnF1YW50aXR5ICogMTAwKSAvIDEwMCA6IGl0ZW0uYW1vdW50OwogICAgICAgICAgY29uc3QgY29tcHV0ZWQgPSBjb21wdXRlVmFsdWVzKG5ld0Ftb3VudCwgaXRlbS5mcmVxdWVuY3kpOwogICAgICAgICAgcmV0dXJuIHsgLi4uaXRlbSwgbGl2ZVByaWNlOiBuZXdQcmljZSwgYW1vdW50OiBuZXdBbW91bnQsIC4uLmNvbXB1dGVkIH07CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIC4uLmIsCiAgICAgICAgICBhc3NldHM6IHVwZGF0ZVNlY3Rpb24oYi5hc3NldHMpLAogICAgICAgICAgbm9uTGlxdWlkQXNzZXRzOiB1cGRhdGVTZWN0aW9uKGIubm9uTGlxdWlkQXNzZXRzKSwKICAgICAgICAgIHJldGlyZW1lbnQ6IHVwZGF0ZVNlY3Rpb24oYi5yZXRpcmVtZW50KSwKICAgICAgICAgIGxhc3RQcmljZVJlZnJlc2g6IERhdGUubm93KCksCiAgICAgICAgICB1cGRhdGVkQXQ6IERhdGUubm93KCkKICAgICAgICB9OwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIHJlZnJlc2ggcHJpY2VzIiwgZSk7CiAgICB9IGZpbmFsbHkgewogICAgICBzZXRSZWZyZXNoaW5nKGZhbHNlKTsKICAgIH0KICB9LCBbYnVkZ2V0LmFzc2V0cywgYnVkZ2V0Lm5vbkxpcXVpZEFzc2V0cywgYnVkZ2V0LnJldGlyZW1lbnRdKTsKICBjb25zdCB1cGRhdGVJdGVtID0gKHNlY3Rpb24sIGlkLCB1cGRhdGVzKSA9PiB7CiAgICBzZXRCdWRnZXQoKGIpID0+ICh7CiAgICAgIC4uLmIsCiAgICAgIFtzZWN0aW9uXTogYltzZWN0aW9uXS5tYXAoKGl0ZW0pID0+IGl0ZW0uaWQgPT09IGlkID8geyAuLi5pdGVtLCAuLi51cGRhdGVzIH0gOiBpdGVtKSwKICAgICAgdXBkYXRlZEF0OiBEYXRlLm5vdygpCiAgICB9KSk7CiAgfTsKICBjb25zdCBhZGRJdGVtID0gKHNlY3Rpb24sIGZyZXEgPSAibW9udGhseSIpID0+IHsKICAgIHRyYWNrRXZlbnQoImFkZF9pdGVtIiwgeyBzZWN0aW9uLCBmcmVxdWVuY3k6IGZyZXEsIGJ1ZGdldE5hbWU6IGJ1ZGdldC5uYW1lIHx8IG51bGwgfSk7CiAgICBzZXRCdWRnZXQoKGIpID0+ICh7CiAgICAgIC4uLmIsCiAgICAgIFtzZWN0aW9uXTogWy4uLmJbc2VjdGlvbl0sIGVtcHR5SXRlbShmcmVxKV0sCiAgICAgIHVwZGF0ZWRBdDogRGF0ZS5ub3coKQogICAgfSkpOwogIH07CiAgY29uc3QgYWRkUHJlc2V0SXRlbSA9IChzZWN0aW9uLCBuYW1lLCBmcmVxID0gIm1vbnRobHkiLCBhc3NldFR5cGUpID0+IHsKICAgIHRyYWNrRXZlbnQoImFkZF9wcmVzZXRfaXRlbSIsIHsgc2VjdGlvbiwgcHJlc2V0TmFtZTogbmFtZSwgZnJlcXVlbmN5OiBmcmVxLCBhc3NldFR5cGUgfSk7CiAgICBzZXRCdWRnZXQoKGIpID0+ICh7CiAgICAgIC4uLmIsCiAgICAgIFtzZWN0aW9uXTogWy4uLmJbc2VjdGlvbl0sIHsgLi4uZW1wdHlJdGVtKGZyZXEpLCBuYW1lLCAuLi5hc3NldFR5cGUgPyB7IGFzc2V0VHlwZSB9IDoge30gfV0sCiAgICAgIHVwZGF0ZWRBdDogRGF0ZS5ub3coKQogICAgfSkpOwogIH07CiAgY29uc3QgcmVvcmRlckl0ZW1zID0gKHNlY3Rpb24sIGZyb21JbmRleCwgdG9JbmRleCkgPT4gewogICAgc2V0QnVkZ2V0KChiKSA9PiB7CiAgICAgIGNvbnN0IGFyciA9IFsuLi5iW3NlY3Rpb25dXTsKICAgICAgY29uc3QgW21vdmVkXSA9IGFyci5zcGxpY2UoZnJvbUluZGV4LCAxKTsKICAgICAgYXJyLnNwbGljZSh0b0luZGV4LCAwLCBtb3ZlZCk7CiAgICAgIHJldHVybiB7IC4uLmIsIFtzZWN0aW9uXTogYXJyLCB1cGRhdGVkQXQ6IERhdGUubm93KCkgfTsKICAgIH0pOwogIH07CiAgY29uc3QgZGVsZXRlSXRlbSA9IChzZWN0aW9uLCBpZCkgPT4gewogICAgdHJhY2tFdmVudCgiZGVsZXRlX2l0ZW0iLCB7IHNlY3Rpb24sIGJ1ZGdldE5hbWU6IGJ1ZGdldC5uYW1lIHx8IG51bGwgfSk7CiAgICBzZXRCdWRnZXQoKGIpID0+ICh7CiAgICAgIC4uLmIsCiAgICAgIFtzZWN0aW9uXTogYltzZWN0aW9uXS5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0uaWQgIT09IGlkKSwKICAgICAgdXBkYXRlZEF0OiBEYXRlLm5vdygpCiAgICB9KSk7CiAgfTsKICBjb25zdCBkb1NhdmVCdWRnZXQgPSAoYnVkZ2V0VG9TYXZlKSA9PiB7CiAgICBjb25zdCB1cGRhdGVkQnVkZ2V0ID0geyAuLi5idWRnZXRUb1NhdmUsIHVwZGF0ZWRBdDogRGF0ZS5ub3coKSB9OwogICAgY29uc3QgZXhpc3RpbmcgPSBsb2FkQnVkZ2V0cygpOwogICAgY29uc3QgaWR4ID0gZXhpc3RpbmcuZmluZEluZGV4KChiKSA9PiBiLmlkID09PSB1cGRhdGVkQnVkZ2V0LmlkKTsKICAgIGNvbnN0IGlzTmV3ID0gaWR4IDwgMDsKICAgIGlmIChpZHggPj0gMCkgewogICAgICBleGlzdGluZ1tpZHhdID0gdXBkYXRlZEJ1ZGdldDsKICAgIH0gZWxzZSB7CiAgICAgIGV4aXN0aW5nLnB1c2godXBkYXRlZEJ1ZGdldCk7CiAgICB9CiAgICBzYXZlQnVkZ2V0cyhleGlzdGluZyk7CiAgICBzZXRTYXZlZEJ1ZGdldHMoZXhpc3RpbmcpOwogICAgc2V0QnVkZ2V0KHVwZGF0ZWRCdWRnZXQpOwogICAgdHJhY2tFdmVudCgic2F2ZV9idWRnZXQiLCB7IGJ1ZGdldE5hbWU6IHVwZGF0ZWRCdWRnZXQubmFtZSwgaXNOZXcgfSk7CiAgICBzZXRTYXZlVG9hc3QodHJ1ZSk7CiAgICBzZXRUaW1lb3V0KCgpID0+IHNldFNhdmVUb2FzdChmYWxzZSksIDE1MDApOwogIH07CiAgY29uc3QgaGFuZGxlU2F2ZUJ1ZGdldCA9ICgpID0+IHsKICAgIGNvbnN0IGlzRmlyc3RTYXZlID0gIXNhdmVkQnVkZ2V0cy5zb21lKChiKSA9PiBiLmlkID09PSBidWRnZXQuaWQpOwogICAgaWYgKGlzRmlyc3RTYXZlKSB7CiAgICAgIGNvbnN0IHN1Z2dlc3RlZCA9IGJ1ZGdldC5uYW1lICE9PSAiTXkgQnVkZ2V0IFBsYW4iID8gYnVkZ2V0Lm5hbWUgOiAiIjsKICAgICAgc2V0TmFtZUJ1ZGdldFZhbHVlKHN1Z2dlc3RlZCk7CiAgICAgIHNldFNob3dOYW1lQnVkZ2V0TW9kYWwodHJ1ZSk7CiAgICB9IGVsc2UgewogICAgICBkb1NhdmVCdWRnZXQoYnVkZ2V0KTsKICAgIH0KICB9OwogIGNvbnN0IHNhdmVCdWRnZXRUb0xpc3QgPSAoKSA9PiB7CiAgICBjb25zdCBleGlzdGluZyA9IGxvYWRCdWRnZXRzKCk7CiAgICBjb25zdCBpZHggPSBleGlzdGluZy5maW5kSW5kZXgoKGIpID0+IGIuaWQgPT09IGJ1ZGdldC5pZCk7CiAgICBpZiAoaWR4ID49IDApIHsKICAgICAgZXhpc3RpbmdbaWR4XSA9IHsgLi4uYnVkZ2V0LCB1cGRhdGVkQXQ6IERhdGUubm93KCkgfTsKICAgIH0gZWxzZSB7CiAgICAgIGV4aXN0aW5nLnB1c2goeyAuLi5idWRnZXQsIHVwZGF0ZWRBdDogRGF0ZS5ub3coKSB9KTsKICAgIH0KICAgIHNhdmVCdWRnZXRzKGV4aXN0aW5nKTsKICAgIHNldFNhdmVkQnVkZ2V0cyhleGlzdGluZyk7CiAgfTsKICBjb25zdCBoYW5kbGVOZXdCdWRnZXQgPSAoKSA9PiB7CiAgICB0cmFja0V2ZW50KCJuZXdfYnVkZ2V0Iik7CiAgICBpZiAoYnVkZ2V0LmluY29tZS5sZW5ndGggPiAwIHx8IGJ1ZGdldC5leHBlbnNlcy5sZW5ndGggPiAwIHx8IGJ1ZGdldC5hc3NldHMubGVuZ3RoID4gMCkgewogICAgICBzYXZlQnVkZ2V0VG9MaXN0KCk7CiAgICB9CiAgICBjb25zdCBuZXdCID0gZW1wdHlCdWRnZXQoKTsKICAgIHNldEJ1ZGdldChuZXdCKTsKICAgIHNldE5hbWVJbnB1dChuZXdCLm5hbWUpOwogICAgc2V0Q3VycmVudFZpZXcoImJ1ZGdldCIpOwogIH07CiAgY29uc3QgaGFuZGxlT3BlbkJ1ZGdldCA9IChiKSA9PiB7CiAgICB0cmFja0V2ZW50KCJvcGVuX2J1ZGdldCIsIHsgYnVkZ2V0TmFtZTogYi5uYW1lIHx8IG51bGwgfSk7CiAgICBpZiAoYnVkZ2V0LmluY29tZS5sZW5ndGggPiAwIHx8IGJ1ZGdldC5leHBlbnNlcy5sZW5ndGggPiAwIHx8IGJ1ZGdldC5hc3NldHMubGVuZ3RoID4gMCkgewogICAgICBzYXZlQnVkZ2V0VG9MaXN0KCk7CiAgICB9CiAgICBzZXRCdWRnZXQoYik7CiAgICBzZXROYW1lSW5wdXQoYi5uYW1lKTsKICAgIHNhdmVDdXJyZW50QnVkZ2V0KGIpOwogICAgc2V0Q3VycmVudFZpZXcoImJ1ZGdldCIpOwogIH07CiAgY29uc3QgaGFuZGxlRGVsZXRlQnVkZ2V0ID0gKGlkKSA9PiB7CiAgICB0cmFja0V2ZW50KCJkZWxldGVfYnVkZ2V0IiwgeyBidWRnZXRJZDogaWQgfSk7CiAgICBjb25zdCB1cGRhdGVkID0gc2F2ZWRCdWRnZXRzLmZpbHRlcigoYikgPT4gYi5pZCAhPT0gaWQpOwogICAgc2F2ZUJ1ZGdldHModXBkYXRlZCk7CiAgICBzZXRTYXZlZEJ1ZGdldHModXBkYXRlZCk7CiAgfTsKICBjb25zdCBoYW5kbGVSZXNldCA9ICgpID0+IHsKICAgIHNldENvbmZpcm1EaWFsb2coewogICAgICBtZXNzYWdlOiAiQ2xlYXIgYWxsIGJ1ZGdldCBkYXRhIG9uIHRoZSBjdXJyZW50IHNjcmVlbj8iLAogICAgICBvbkNvbmZpcm06ICgpID0+IHsKICAgICAgICB0cmFja0V2ZW50KCJyZXNldCIsIHsgYnVkZ2V0TmFtZTogYnVkZ2V0Lm5hbWUsIGl0ZW1Db3VudDogYnVkZ2V0LmluY29tZS5sZW5ndGggKyBidWRnZXQuZXhwZW5zZXMubGVuZ3RoICsgYnVkZ2V0LmFzc2V0cy5sZW5ndGggfSk7CiAgICAgICAgY29uc3QgbmV3QiA9IGVtcHR5QnVkZ2V0KCk7CiAgICAgICAgc2V0QnVkZ2V0KG5ld0IpOwogICAgICAgIHNldE5hbWVJbnB1dChuZXdCLm5hbWUpOwogICAgICB9CiAgICB9KTsKICB9OwogIGNvbnN0IGhhbmRsZVN1YnNjcmliZSA9IGFzeW5jICgpID0+IHsKICAgIGlmICghc3Vic2NyaWJlRW1haWwgfHwgIXN1YnNjcmliZUVtYWlsLmluY2x1ZGVzKCJAIikpIHsKICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZSgiUGxlYXNlIGVudGVyIGEgdmFsaWQgZW1haWwuIik7CiAgICAgIHNldFN1YnNjcmliZVN0YXR1cygiZXJyb3IiKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJsb2FkaW5nIik7CiAgICB0cnkgewogICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGAke0FQSV9CQVNFfS9hcGkvc3Vic2NyaWJlYCwgewogICAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICAgIGhlYWRlcnM6IHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZW1haWw6IHN1YnNjcmliZUVtYWlsLCB0b3BpY0lkOiAiYnVkZ2V0LXBsYW5uZXItbmV3cyIsIHRvcGljTmFtZTogIkJ1ZGdldCBQbGFubmVyIFVwZGF0ZXMiIH0pCiAgICAgIH0pOwogICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwogICAgICBpZiAocmVzcG9uc2Uub2sgJiYgZGF0YS5zdWNjZXNzKSB7CiAgICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJzdWNjZXNzIik7CiAgICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZShkYXRhLm1lc3NhZ2UpOwogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgc2V0U2hvd1N1YnNjcmliZU1vZGFsKGZhbHNlKTsKICAgICAgICAgIHNldFN1YnNjcmliZUVtYWlsKCIiKTsKICAgICAgICAgIHNldFN1YnNjcmliZVN0YXR1cygiaWRsZSIpOwogICAgICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZSgiIik7CiAgICAgICAgfSwgM2UzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRTdWJzY3JpYmVTdGF0dXMoImVycm9yIik7CiAgICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZShkYXRhLmVycm9yIHx8ICJGYWlsZWQgdG8gc3Vic2NyaWJlLiIpOwogICAgICB9CiAgICB9IGNhdGNoIHsKICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJlcnJvciIpOwogICAgICBzZXRTdWJzY3JpYmVNZXNzYWdlKCJOZXR3b3JrIGVycm9yLiBQbGVhc2UgdHJ5IGFnYWluLiIpOwogICAgfQogIH07CiAgY29uc3QgaGFuZGxlRmVlZGJhY2tTdWJtaXQgPSBhc3luYyAoKSA9PiB7CiAgICBpZiAoIWZlZWRiYWNrVGV4dC50cmltKCkpIHJldHVybjsKICAgIHNldEZlZWRiYWNrU3RhdHVzKCJzdWJtaXR0aW5nIik7CiAgICB0cnkgewogICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGAke0FQSV9CQVNFfS9hcGkvdHJhY2tgLCB7CiAgICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBldmVudDogInVzZXJfZmVlZGJhY2siLCBkYXRhOiB7IGZlZWRiYWNrOiBmZWVkYmFja1RleHQsIHRvb2w6ICJidWRnZXQtcGxhbm5lciIsIGJ1ZGdldE5hbWU6IGJ1ZGdldC5uYW1lIHx8IG51bGwgfSB9KQogICAgICB9KTsKICAgICAgaWYgKHJlc3BvbnNlLm9rKSB7CiAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoInN1Y2Nlc3MiKTsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHNldFNob3dGZWVkYmFja01vZGFsKGZhbHNlKTsKICAgICAgICAgIHNldEZlZWRiYWNrVGV4dCgiIik7CiAgICAgICAgICBzZXRGZWVkYmFja1N0YXR1cygiaWRsZSIpOwogICAgICAgIH0sIDJlMyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoImVycm9yIik7CiAgICAgIH0KICAgIH0gY2F0Y2ggewogICAgICBzZXRGZWVkYmFja1N0YXR1cygiZXJyb3IiKTsKICAgIH0KICB9OwogIGNvbnN0IGhhbmRsZUJhY2tUb0hvbWUgPSAoKSA9PiB7CiAgICB0cmFja0V2ZW50KCJiYWNrX3RvX2hvbWUiKTsKICAgIHNhdmVCdWRnZXRUb0xpc3QoKTsKICAgIHNldEN1cnJlbnRWaWV3KCJob21lIik7CiAgfTsKICBjb25zdCBoYW5kbGVQcmludCA9ICgpID0+IHsKICAgIHdpbmRvdy5wcmludCgpOwogIH07CiAgaWYgKGN1cnJlbnRWaWV3ID09PSAiaG9tZSIpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgcmVmOiBjb250YWluZXJSZWYsIHN0eWxlOiB7IGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5iZywgZm9udEZhbWlseTogIidJbnRlcicsIC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgJ1NlZ29lIFVJJywgUm9ib3RvLCBzYW5zLXNlcmlmIiwgbWF4V2lkdGg6IDYwMCwgbWFyZ2luOiAiMCBhdXRvIiwgb3ZlcmZsb3c6ICJoaWRkZW4iLCBib3hTaXppbmc6ICJib3JkZXItYm94IiwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJ9YCwgYm9yZGVyUmFkaXVzOiAxNiB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIucHJpbWFyeSwgcGFkZGluZzogIjI0cHggMjBweCIsIGNvbG9yOiAid2hpdGUiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiZmxleC1zdGFydCIgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiaDEiLCB7IHN0eWxlOiB7IG1hcmdpbjogMCwgZm9udFNpemU6IDIyLCBmb250V2VpZ2h0OiA3MDAsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogMTAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoRG9sbGFyU2lnbiwgeyBzaXplOiAyOCB9KSwKICAgICAgICAgICAgIiBUaGUgUGVyc29uYWwgQnVkZ2V0IFBsYW5uZXIiCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInAiLCB7IHN0eWxlOiB7IG1hcmdpbjogIjZweCAwIDAiLCBmb250U2l6ZTogMTIsIG9wYWNpdHk6IDAuODUsIGxldHRlclNwYWNpbmc6IDAuMiB9LCBjaGlsZHJlbjogIkJ1aWx0IG9uIHRoZSA1MC8zMC8yMCBydWxlIHVzZWQgYnkgZmluYW5jaWFsIGFkdmlzb3JzIiB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA2IH0sIGNoaWxkcmVuOiBzZXNzaW9uID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gc3VwYWJhc2U/LmF1dGguc2lnbk91dCgpLCBzdHlsZTogewogICAgICAgICAgcGFkZGluZzogIjZweCAxMHB4IiwKICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAicmdiYSgyNTUsMjU1LDI1NSwwLjIpIiwKICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgIGdhcDogNCwKICAgICAgICAgIGZvbnRTaXplOiAxMSwKICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMAogICAgICAgIH0sIGNoaWxkcmVuOiAiTG9nIE91dCIgfSkgOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRTaG93TG9naW5Nb2RhbCh0cnVlKSwgc3R5bGU6IHsKICAgICAgICAgIHBhZGRpbmc6ICI2cHggMTBweCIsCiAgICAgICAgICBib3JkZXJSYWRpdXM6IDYsCiAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwKICAgICAgICAgIGNvbG9yOiBDT0xPUlMyLnByaW1hcnksCiAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgZ2FwOiA0LAogICAgICAgICAgZm9udFNpemU6IDExLAogICAgICAgICAgZm9udFdlaWdodDogNjAwCiAgICAgICAgfSwgY2hpbGRyZW46ICJMb2cgSW4iIH0pIH0pCiAgICAgIF0gfSkgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAyMCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBoYW5kbGVOZXdCdWRnZXQsIHN0eWxlOiB7CiAgICAgICAgICB3aWR0aDogIjEwMCUiLAogICAgICAgICAgcGFkZGluZzogMTYsCiAgICAgICAgICBib3JkZXJSYWRpdXM6IDEyLAogICAgICAgICAgYm9yZGVyOiBgMnB4IGRhc2hlZCAke0NPTE9SUzIucHJpbWFyeX1gLAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLmFjY2VudExpZ2h0LAogICAgICAgICAgY29sb3I6IENPTE9SUzIucHJpbWFyeURhcmssCiAgICAgICAgICBmb250U2l6ZTogMTUsCiAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgICAgZ2FwOiA4LAogICAgICAgICAgbWFyZ2luQm90dG9tOiAyMAogICAgICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShQbHVzLCB7IHNpemU6IDIwIH0pLAogICAgICAgICAgIiBDcmVhdGUgTmV3IEJ1ZGdldCIKICAgICAgICBdIH0pLAogICAgICAgIHNhdmVkQnVkZ2V0cy5sZW5ndGggPT09IDAgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgdGV4dEFsaWduOiAiY2VudGVyIiwgcGFkZGluZzogNDAsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFBpZ2d5QmFuaywgeyBzaXplOiA0OCwgc3R5bGU6IHsgb3BhY2l0eTogMC4zLCBtYXJnaW5Cb3R0b206IDE2IH0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgicCIsIHsgc3R5bGU6IHsgbWFyZ2luOiAwIH0sIGNoaWxkcmVuOiAiTm8gc2F2ZWQgYnVkZ2V0cyB5ZXQiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInAiLCB7IHN0eWxlOiB7IG1hcmdpbjogIjRweCAwIDAiLCBmb250U2l6ZTogMTMgfSwgY2hpbGRyZW46ICJDcmVhdGUgeW91ciBmaXJzdCBidWRnZXQgdG8gZ2V0IHN0YXJ0ZWQiIH0pCiAgICAgICAgXSB9KSA6IHNhdmVkQnVkZ2V0cy5tYXAoKGIpID0+IHsKICAgICAgICAgIGNvbnN0IHRvdGFsSW5jb21lID0gYi5pbmNvbWUucmVkdWNlKChzLCBpKSA9PiBzICsgaS5tb250aGx5VmFsdWUsIDApOwogICAgICAgICAgY29uc3QgdG90YWxFeHBlbnNlcyA9IGIuZXhwZW5zZXMucmVkdWNlKChzLCBpKSA9PiBzICsgaS5tb250aGx5VmFsdWUsIDApOwogICAgICAgICAgY29uc3QgbmV0ID0gdG90YWxJbmNvbWUgLSB0b3RhbEV4cGVuc2VzOwogICAgICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuY2FyZCwKICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMiwKICAgICAgICAgICAgcGFkZGluZzogIjE0cHggMTZweCIsCiAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsCiAgICAgICAgICAgIG1hcmdpbkJvdHRvbTogOCwKICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIKICAgICAgICAgIH0sIG9uQ2xpY2s6ICgpID0+IGhhbmRsZU9wZW5CdWRnZXQoYiksIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTMi50ZXh0TWFpbiB9LCBjaGlsZHJlbjogYi5uYW1lIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgYi5pbmNvbWUubGVuZ3RoICsgYi5leHBlbnNlcy5sZW5ndGggKyBiLmFzc2V0cy5sZW5ndGggKyBiLm5vbkxpcXVpZEFzc2V0cy5sZW5ndGggKyAoYi5yZXRpcmVtZW50IHx8IFtdKS5sZW5ndGggKyBiLmxpYWJpbGl0aWVzLmxlbmd0aCwKICAgICAgICAgICAgICAgICIgaXRlbXMgXHhCNyBVcGRhdGVkICIsCiAgICAgICAgICAgICAgICBuZXcgRGF0ZShiLnVwZGF0ZWRBdCkudG9Mb2NhbGVEYXRlU3RyaW5nKCkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHRleHRBbGlnbjogInJpZ2h0IiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNSwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogbmV0ID49IDAgPyBDT0xPUlMyLnBvc2l0aXZlIDogQ09MT1JTMi5uZWdhdGl2ZSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIG5ldCA+PSAwID8gIisiIDogIiIsCiAgICAgICAgICAgICAgZm10KG5ldCksCiAgICAgICAgICAgICAgIi9tbyIKICAgICAgICAgICAgXSB9KSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKGUpID0+IHsKICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIGhhbmRsZURlbGV0ZUJ1ZGdldChiLmlkKTsKICAgICAgICAgICAgfSwgc3R5bGU6IHsKICAgICAgICAgICAgICBwYWRkaW5nOiA2LAogICAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICAgIGJhY2tncm91bmQ6ICJub25lIiwKICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsCiAgICAgICAgICAgICAgbWFyZ2luTGVmdDogOAogICAgICAgICAgICB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoVHJhc2gyLCB7IHNpemU6IDE2IH0pIH0pCiAgICAgICAgICBdIH0sIGIuaWQpOwogICAgICAgIH0pCiAgICAgIF0gfSkKICAgIF0gfSk7CiAgfQogIGNvbnN0IGhhc0J1ZGdldENvbnRlbnQgPSBidWRnZXQuaW5jb21lLmxlbmd0aCA+IDAgfHwgYnVkZ2V0LmV4cGVuc2VzLmxlbmd0aCA+IDAgfHwgYnVkZ2V0LmFzc2V0cy5sZW5ndGggPiAwIHx8IGJ1ZGdldC5ub25MaXF1aWRBc3NldHMubGVuZ3RoID4gMCB8fCBidWRnZXQucmV0aXJlbWVudC5sZW5ndGggPiAwIHx8IGJ1ZGdldC5saWFiaWxpdGllcy5sZW5ndGggPiAwOwogIGNvbnN0IGhhc0xpdmVBc3NldHMgPSBbLi4uYnVkZ2V0LmFzc2V0cywgLi4uYnVkZ2V0Lm5vbkxpcXVpZEFzc2V0cywgLi4uYnVkZ2V0LnJldGlyZW1lbnRdLnNvbWUoKGkpID0+IChpLmFzc2V0VHlwZSA9PT0gImNyeXB0byIgfHwgaS5hc3NldFR5cGUgPT09ICJzdG9jayIpICYmIGkudGlja2VyKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHJlZjogY29udGFpbmVyUmVmLCBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuYmcsIGZvbnRGYW1pbHk6ICInSW50ZXInLCAtYXBwbGUtc3lzdGVtLCBCbGlua01hY1N5c3RlbUZvbnQsICdTZWdvZSBVSScsIFJvYm90bywgc2Fucy1zZXJpZiIsIG1heFdpZHRoOiA2MDAsIG1hcmdpbjogIjAgYXV0byIsIGJveFNpemluZzogImJvcmRlci1ib3giLCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLCBib3JkZXJSYWRpdXM6IDE2LCBvdmVyZmxvdzogImhpZGRlbiIgfSwgY2hpbGRyZW46IFsKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzdHlsZSIsIHsgY2hpbGRyZW46IGBAa2V5ZnJhbWVzIHNwaW4geyBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC01MCUpIHJvdGF0ZSgwZGVnKTsgfSB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTAlKSByb3RhdGUoMzYwZGVnKTsgfSB9IEBrZXlmcmFtZXMgc3BpbkJ0biB7IGZyb20geyB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsgfSB0byB7IHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZyk7IH0gfSBAa2V5ZnJhbWVzIGZhZGVJbk91dCB7IDAlIHsgb3BhY2l0eTogMDsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpIHRyYW5zbGF0ZVkoLThweCk7IH0gMTUlIHsgb3BhY2l0eTogMTsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpIHRyYW5zbGF0ZVkoMCk7IH0gODAlIHsgb3BhY2l0eTogMTsgfSAxMDAlIHsgb3BhY2l0eTogMDsgfSB9YCB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIucHJpbWFyeSwgcGFkZGluZzogIjIwcHggMTZweCIsIGNvbG9yOiAid2hpdGUiIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShEb2xsYXJTaWduLCB7IHNpemU6IDI0IH0pLAogICAgICAgICAgZWRpdGluZ05hbWUgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJpbnB1dCIsIHsgdmFsdWU6IG5hbWVJbnB1dCwgb25DaGFuZ2U6IChlKSA9PiBzZXROYW1lSW5wdXQoZS50YXJnZXQudmFsdWUpLCBzdHlsZTogewogICAgICAgICAgICAgIGJhY2tncm91bmQ6ICJyZ2JhKDI1NSwyNTUsMjU1LDAuMikiLAogICAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgICAgIGZvbnRTaXplOiAyMCwKICAgICAgICAgICAgICBmb250V2VpZ2h0OiA3MDAsCiAgICAgICAgICAgICAgcGFkZGluZzogIjJweCA4cHgiLAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgICAgICBvdXRsaW5lOiAibm9uZSIsCiAgICAgICAgICAgICAgd2lkdGg6IDE4MCwKICAgICAgICAgICAgICBmb250RmFtaWx5OiAiaW5oZXJpdCIKICAgICAgICAgICAgfSwgYXV0b0ZvY3VzOiB0cnVlLCBvbktleURvd246IChlKSA9PiB7CiAgICAgICAgICAgICAgaWYgKGUua2V5ID09PSAiRW50ZXIiKSB7CiAgICAgICAgICAgICAgICBzZXRCdWRnZXQoKGIpID0+ICh7IC4uLmIsIG5hbWU6IG5hbWVJbnB1dCB9KSk7CiAgICAgICAgICAgICAgICBzZXRFZGl0aW5nTmFtZShmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgc2V0QnVkZ2V0KChiKSA9PiAoeyAuLi5iLCBuYW1lOiBuYW1lSW5wdXQgfSkpOwogICAgICAgICAgICAgIHNldEVkaXRpbmdOYW1lKGZhbHNlKTsKICAgICAgICAgICAgfSwgc3R5bGU6IHsgcGFkZGluZzogNCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmQ6ICJub25lIiwgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiAid2hpdGUiLCBkaXNwbGF5OiAiZmxleCIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKENoZWNrLCB7IHNpemU6IDE4IH0pIH0pCiAgICAgICAgICBdIH0pIDogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImgxIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRFZGl0aW5nTmFtZSh0cnVlKSwgc3R5bGU6IHsgbWFyZ2luOiAwLCBmb250U2l6ZTogMjAsIGZvbnRXZWlnaHQ6IDcwMCwgY3Vyc29yOiAicG9pbnRlciIgfSwgY2hpbGRyZW46IGJ1ZGdldC5uYW1lIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICBzZXNzaW9uID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gc3VwYWJhc2U/LmF1dGguc2lnbk91dCgpLCBzdHlsZTogewogICAgICAgICAgICBwYWRkaW5nOiAiNnB4IDEwcHgiLAogICAgICAgICAgICBib3JkZXJSYWRpdXM6IDYsCiAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJyZ2JhKDI1NSwyNTUsMjU1LDAuMikiLAogICAgICAgICAgICBjb2xvcjogIndoaXRlIiwKICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgIGdhcDogNCwKICAgICAgICAgICAgZm9udFNpemU6IDExLAogICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAKICAgICAgICAgIH0sIGNoaWxkcmVuOiAiTG9nIE91dCIgfSkgOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRTaG93TG9naW5Nb2RhbCh0cnVlKSwgc3R5bGU6IHsKICAgICAgICAgICAgcGFkZGluZzogIjZweCAxMHB4IiwKICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA2LAogICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLAogICAgICAgICAgICBjb2xvcjogQ09MT1JTMi5wcmltYXJ5LAogICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgZ2FwOiA0LAogICAgICAgICAgICBmb250U2l6ZTogMTEsCiAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMAogICAgICAgICAgfSwgY2hpbGRyZW46ICJMb2cgSW4iIH0pLAogICAgICAgICAgaGFzTGl2ZUFzc2V0cyAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImJ1dHRvbiIsIHsgb25DbGljazogcmVmcmVzaFByaWNlcywgZGlzYWJsZWQ6IHJlZnJlc2hpbmcsIHN0eWxlOiB7CiAgICAgICAgICAgIHBhZGRpbmc6ICI2cHggMTBweCIsCiAgICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogcmVmcmVzaGluZyA/ICJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIDogInJnYmEoMjU1LDI1NSwyNTUsMC4yKSIsCiAgICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgICBjdXJzb3I6IHJlZnJlc2hpbmcgPyAiZGVmYXVsdCIgOiAicG9pbnRlciIsCiAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgIGdhcDogNCwKICAgICAgICAgICAgZm9udFNpemU6IDExLAogICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgIG9wYWNpdHk6IHJlZnJlc2hpbmcgPyAwLjcgOiAxCiAgICAgICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShSZWZyZXNoQ3csIHsgc2l6ZTogMTQsIHN0eWxlOiByZWZyZXNoaW5nID8geyBhbmltYXRpb246ICJzcGluQnRuIDFzIGxpbmVhciBpbmZpbml0ZSIgfSA6IHZvaWQgMCB9KSwKICAgICAgICAgICAgcmVmcmVzaGluZyA/ICJVcGRhdGluZy4uLiIgOiAiUmVmcmVzaCIKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBoYW5kbGVCYWNrVG9Ib21lLCBzdHlsZTogeyBwYWRkaW5nOiA2LCBib3JkZXJSYWRpdXM6IDYsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kQ29sb3I6ICJyZ2JhKDI1NSwyNTUsMjU1LDAuMikiLCBjb2xvcjogIndoaXRlIiwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoSG91c2UsIHsgc2l6ZTogMTYgfSkgfSksCiAgICAgICAgICBoYXNCdWRnZXRDb250ZW50ICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6IGhhbmRsZVNhdmVCdWRnZXQsIHN0eWxlOiB7IHBhZGRpbmc6IDYsIGJvcmRlclJhZGl1czogNiwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmRDb2xvcjogInJnYmEoMjU1LDI1NSwyNTUsMC4yKSIsIGNvbG9yOiAid2hpdGUiLCBjdXJzb3I6ICJwb2ludGVyIiwgZGlzcGxheTogImZsZXgiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShTYXZlLCB7IHNpemU6IDE2IH0pIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJidXR0b24iLCB7IG9uQ2xpY2s6IGhhbmRsZU5ld0J1ZGdldCwgc3R5bGU6IHsgcGFkZGluZzogIjZweCAxMHB4IiwgYm9yZGVyUmFkaXVzOiA2LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBjb2xvcjogQ09MT1JTMi5wcmltYXJ5LCBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShQbHVzLCB7IHNpemU6IDE0IH0pLAogICAgICAgICAgICAiIE5ldyIKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInAiLCB7IHN0eWxlOiB7IG1hcmdpbjogMCwgZm9udFNpemU6IDExLCBvcGFjaXR5OiAwLjgsIGxldHRlclNwYWNpbmc6IDAuMiB9LCBjaGlsZHJlbjogIkJ1aWx0IG9uIHRoZSA1MC8zMC8yMCBydWxlIHVzZWQgYnkgZmluYW5jaWFsIGFkdmlzb3JzIiB9KSwKICAgICAgICBidWRnZXQubGFzdFByaWNlUmVmcmVzaCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgb3BhY2l0eTogMC42IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAiUHJpY2VzOiAiLAogICAgICAgICAgbmV3IERhdGUoYnVkZ2V0Lmxhc3RQcmljZVJlZnJlc2gpLnRvTG9jYWxlVGltZVN0cmluZygpCiAgICAgICAgXSB9KQogICAgICBdIH0pCiAgICBdIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBhZGRpbmc6ICIxNnB4IDE2cHggNDBweCIgfSwgY2hpbGRyZW46IFsKICAgICAgYnVkZ2V0LmluY29tZS5sZW5ndGggPT09IDAgJiYgYnVkZ2V0LmV4cGVuc2VzLmxlbmd0aCA9PT0gMCAmJiBidWRnZXQuYXNzZXRzLmxlbmd0aCA9PT0gMCAmJiBidWRnZXQubm9uTGlxdWlkQXNzZXRzLmxlbmd0aCA9PT0gMCAmJiBidWRnZXQucmV0aXJlbWVudC5sZW5ndGggPT09IDAgJiYgYnVkZ2V0LmxpYWJpbGl0aWVzLmxlbmd0aCA9PT0gMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiAxNiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LCBtYXJnaW5Cb3R0b206IDgsIHRleHRBbGlnbjogImNlbnRlciIgfSwgY2hpbGRyZW46ICJTdGFydCB3aXRoIGEgdGVtcGxhdGUiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA2IH0sIGNoaWxkcmVuOiBCVURHRVRfUFJFU0VUUy5tYXAoKHApID0+IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICBjb25zdCBwcmVzZXQgPSBwLmJ1ZGdldDsKICAgICAgICAgICAgICBjb25zdCByZWdlbmVyYXRlZCA9IHsKICAgICAgICAgICAgICAgIC4uLnByZXNldCwKICAgICAgICAgICAgICAgIGlkOiBidWRnZXQuaWQsCiAgICAgICAgICAgICAgICBpbmNvbWU6IHByZXNldC5pbmNvbWUubWFwKChpKSA9PiAoeyAuLi5pLCBpZDogZ2VuZXJhdGVJZCgpIH0pKSwKICAgICAgICAgICAgICAgIGV4cGVuc2VzOiBwcmVzZXQuZXhwZW5zZXMubWFwKChpKSA9PiAoeyAuLi5pLCBpZDogZ2VuZXJhdGVJZCgpIH0pKSwKICAgICAgICAgICAgICAgIGFzc2V0czogcHJlc2V0LmFzc2V0cy5tYXAoKGkpID0+ICh7IC4uLmksIGlkOiBnZW5lcmF0ZUlkKCkgfSkpLAogICAgICAgICAgICAgICAgbm9uTGlxdWlkQXNzZXRzOiBwcmVzZXQubm9uTGlxdWlkQXNzZXRzLm1hcCgoaSkgPT4gKHsgLi4uaSwgaWQ6IGdlbmVyYXRlSWQoKSB9KSksCiAgICAgICAgICAgICAgICByZXRpcmVtZW50OiBwcmVzZXQucmV0aXJlbWVudC5tYXAoKGkpID0+ICh7IC4uLmksIGlkOiBnZW5lcmF0ZUlkKCkgfSkpLAogICAgICAgICAgICAgICAgbGlhYmlsaXRpZXM6IHByZXNldC5saWFiaWxpdGllcy5tYXAoKGkpID0+ICh7IC4uLmksIGlkOiBnZW5lcmF0ZUlkKCkgfSkpLAogICAgICAgICAgICAgICAgY3JlYXRlZEF0OiBub3csCiAgICAgICAgICAgICAgICB1cGRhdGVkQXQ6IG5vdwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgc2V0QnVkZ2V0KHJlZ2VuZXJhdGVkKTsKICAgICAgICAgICAgICBzZXROYW1lSW5wdXQocHJlc2V0Lm5hbWUpOwogICAgICAgICAgICAgIHRyYWNrRXZlbnQoImxvYWRfcHJlc2V0IiwgeyBwcmVzZXQ6IHAua2V5IH0pOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgIGZsZXg6IDEsCiAgICAgICAgICAgICAgcGFkZGluZzogIjhweCA0cHgiLAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTAsCiAgICAgICAgICAgICAgYm9yZGVyOiBgMS41cHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLAogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5jYXJkLAogICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgIHRleHRBbGlnbjogImNlbnRlciIsCiAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgIGZsZXhEaXJlY3Rpb246ICJjb2x1bW4iLAogICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgIGdhcDogMiwKICAgICAgICAgICAgICB0cmFuc2l0aW9uOiAiYm9yZGVyLWNvbG9yIDAuMTVzLCBib3gtc2hhZG93IDAuMTVzIgogICAgICAgICAgICB9LAogICAgICAgICAgICBvbk1vdXNlRW50ZXI6IChlKSA9PiB7CiAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJvcmRlckNvbG9yID0gQ09MT1JTMi5hY2NlbnQ7CiAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJveFNoYWRvdyA9IGAwIDJweCA4cHggJHtDT0xPUlMyLmFjY2VudH0yMGA7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uTW91c2VMZWF2ZTogKGUpID0+IHsKICAgICAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQuc3R5bGUuYm9yZGVyQ29sb3IgPSBDT0xPUlMyLmJvcmRlcjsKICAgICAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQuc3R5bGUuYm94U2hhZG93ID0gIm5vbmUiOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTYgfSwgY2hpbGRyZW46IHAuZW1vamkgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTMi50ZXh0TWFpbiB9LCBjaGlsZHJlbjogcC5sYWJlbCB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LCBsaW5lSGVpZ2h0OiAxLjIgfSwgY2hpbGRyZW46IHAuZGVzYyB9KQogICAgICAgICAgICBdCiAgICAgICAgICB9LAogICAgICAgICAgcC5rZXkKICAgICAgICApKSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgICBCdWRnZXRTZWN0aW9uLAogICAgICAgIHsKICAgICAgICAgIHRpdGxlOiAiSW5jb21lIiwKICAgICAgICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFRyZW5kaW5nVXAsIHsgc2l6ZTogMTggfSksCiAgICAgICAgICBjb2xvcjogQ09MT1JTMi5pbmNvbWUsCiAgICAgICAgICBiZ0NvbG9yOiBDT0xPUlMyLmluY29tZUJnLAogICAgICAgICAgaXRlbXM6IGJ1ZGdldC5pbmNvbWUsCiAgICAgICAgICBpbnB1dE1vZGU6ICJyZWN1cnJpbmciLAogICAgICAgICAgcHJlc2V0czogUFJFU0VUUy5pbmNvbWUsCiAgICAgICAgICBvblVwZGF0ZTogKGlkLCB1KSA9PiB1cGRhdGVJdGVtKCJpbmNvbWUiLCBpZCwgdSksCiAgICAgICAgICBvbkFkZDogKCkgPT4gYWRkSXRlbSgiaW5jb21lIiwgIm1vbnRobHkiKSwKICAgICAgICAgIG9uQWRkUHJlc2V0OiAobmFtZSwgYXQpID0+IGFkZFByZXNldEl0ZW0oImluY29tZSIsIG5hbWUsICJtb250aGx5IiwgYXQpLAogICAgICAgICAgb25EZWxldGU6IChpZCkgPT4gZGVsZXRlSXRlbSgiaW5jb21lIiwgaWQpLAogICAgICAgICAgb25SZW9yZGVyOiAoZnJvbTIsIHRvMikgPT4gcmVvcmRlckl0ZW1zKCJpbmNvbWUiLCBmcm9tMiwgdG8yKQogICAgICAgIH0KICAgICAgKSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgQnVkZ2V0U2VjdGlvbiwKICAgICAgICB7CiAgICAgICAgICB0aXRsZTogIkV4cGVuc2VzIiwKICAgICAgICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFRyZW5kaW5nRG93biwgeyBzaXplOiAxOCB9KSwKICAgICAgICAgIGNvbG9yOiBDT0xPUlMyLmV4cGVuc2UsCiAgICAgICAgICBiZ0NvbG9yOiBDT0xPUlMyLmV4cGVuc2VCZywKICAgICAgICAgIGl0ZW1zOiBidWRnZXQuZXhwZW5zZXMsCiAgICAgICAgICBpbnB1dE1vZGU6ICJyZWN1cnJpbmciLAogICAgICAgICAgcHJlc2V0czogUFJFU0VUUy5leHBlbnNlcywKICAgICAgICAgIG9uVXBkYXRlOiAoaWQsIHUpID0+IHVwZGF0ZUl0ZW0oImV4cGVuc2VzIiwgaWQsIHUpLAogICAgICAgICAgb25BZGQ6ICgpID0+IGFkZEl0ZW0oImV4cGVuc2VzIiwgIm1vbnRobHkiKSwKICAgICAgICAgIG9uQWRkUHJlc2V0OiAobmFtZSwgYXQpID0+IGFkZFByZXNldEl0ZW0oImV4cGVuc2VzIiwgbmFtZSwgIm1vbnRobHkiLCBhdCksCiAgICAgICAgICBvbkRlbGV0ZTogKGlkKSA9PiBkZWxldGVJdGVtKCJleHBlbnNlcyIsIGlkKSwKICAgICAgICAgIG9uUmVvcmRlcjogKGZyb20yLCB0bzIpID0+IHJlb3JkZXJJdGVtcygiZXhwZW5zZXMiLCBmcm9tMiwgdG8yKQogICAgICAgIH0KICAgICAgKSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgQnVkZ2V0U2VjdGlvbiwKICAgICAgICB7CiAgICAgICAgICB0aXRsZTogIkFzc2V0cyIsCiAgICAgICAgICBpY29uOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShXYWxsZXQsIHsgc2l6ZTogMTggfSksCiAgICAgICAgICBjb2xvcjogQ09MT1JTMi5hc3NldCwKICAgICAgICAgIGJnQ29sb3I6IENPTE9SUzIuYXNzZXRCZywKICAgICAgICAgIGl0ZW1zOiBidWRnZXQuYXNzZXRzLAogICAgICAgICAgaW5wdXRNb2RlOiAiYXNzZXQiLAogICAgICAgICAgcHJlc2V0czogUFJFU0VUUy5hc3NldHMsCiAgICAgICAgICBvblVwZGF0ZTogKGlkLCB1KSA9PiB1cGRhdGVJdGVtKCJhc3NldHMiLCBpZCwgdSksCiAgICAgICAgICBvbkFkZDogKCkgPT4gYWRkSXRlbSgiYXNzZXRzIiwgIm9uZV90aW1lIiksCiAgICAgICAgICBvbkFkZFByZXNldDogKG5hbWUsIGF0KSA9PiBhZGRQcmVzZXRJdGVtKCJhc3NldHMiLCBuYW1lLCAib25lX3RpbWUiLCBhdCksCiAgICAgICAgICBvbkRlbGV0ZTogKGlkKSA9PiBkZWxldGVJdGVtKCJhc3NldHMiLCBpZCksCiAgICAgICAgICBvblJlb3JkZXI6IChmcm9tMiwgdG8yKSA9PiByZW9yZGVySXRlbXMoImFzc2V0cyIsIGZyb20yLCB0bzIpCiAgICAgICAgfQogICAgICApLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgICBCdWRnZXRTZWN0aW9uLAogICAgICAgIHsKICAgICAgICAgIHRpdGxlOiAiTm9uLUxpcXVpZCBBc3NldHMiLAogICAgICAgICAgaWNvbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoQnVpbGRpbmcyLCB7IHNpemU6IDE4IH0pLAogICAgICAgICAgY29sb3I6IENPTE9SUzIubm9uTGlxdWlkLAogICAgICAgICAgYmdDb2xvcjogQ09MT1JTMi5ub25MaXF1aWRCZywKICAgICAgICAgIGl0ZW1zOiBidWRnZXQubm9uTGlxdWlkQXNzZXRzLAogICAgICAgICAgaW5wdXRNb2RlOiAidmFsdWVfb25seSIsCiAgICAgICAgICBwcmVzZXRzOiBQUkVTRVRTLm5vbkxpcXVpZEFzc2V0cywKICAgICAgICAgIG9uVXBkYXRlOiAoaWQsIHUpID0+IHVwZGF0ZUl0ZW0oIm5vbkxpcXVpZEFzc2V0cyIsIGlkLCB1KSwKICAgICAgICAgIG9uQWRkOiAoKSA9PiBhZGRJdGVtKCJub25MaXF1aWRBc3NldHMiLCAib25lX3RpbWUiKSwKICAgICAgICAgIG9uQWRkUHJlc2V0OiAobmFtZSwgYXQpID0+IGFkZFByZXNldEl0ZW0oIm5vbkxpcXVpZEFzc2V0cyIsIG5hbWUsICJvbmVfdGltZSIsIGF0KSwKICAgICAgICAgIG9uRGVsZXRlOiAoaWQpID0+IGRlbGV0ZUl0ZW0oIm5vbkxpcXVpZEFzc2V0cyIsIGlkKSwKICAgICAgICAgIG9uUmVvcmRlcjogKGZyb20yLCB0bzIpID0+IHJlb3JkZXJJdGVtcygibm9uTGlxdWlkQXNzZXRzIiwgZnJvbTIsIHRvMiksCiAgICAgICAgICBmb290ZXI6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuY2FyZCwgYm9yZGVyUmFkaXVzOiAxMCwgcGFkZGluZzogIjEwcHggMTJweCIsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyTGlnaHR9YCwgbWFyZ2luVG9wOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBtYXJnaW5Cb3R0b206IDYgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICJEaXNjb3VudCBSYXRlIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTMi5ub25MaXF1aWQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIGJ1ZGdldC5ub25MaXF1aWREaXNjb3VudCwKICAgICAgICAgICAgICAgICIlIgogICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgICAgICAgImlucHV0IiwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0eXBlOiAicmFuZ2UiLAogICAgICAgICAgICAgICAgbWluOiAwLAogICAgICAgICAgICAgICAgbWF4OiA3NSwKICAgICAgICAgICAgICAgIHZhbHVlOiBidWRnZXQubm9uTGlxdWlkRGlzY291bnQsCiAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldEJ1ZGdldCgoYikgPT4gKHsgLi4uYiwgbm9uTGlxdWlkRGlzY291bnQ6IHBhcnNlSW50KGUudGFyZ2V0LnZhbHVlKSB9KSksCiAgICAgICAgICAgICAgICBzdHlsZTogeyB3aWR0aDogIjEwMCUiLCBhY2NlbnRDb2xvcjogQ09MT1JTMi5ub25MaXF1aWQgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgZm9udFNpemU6IDEwLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgY2hpbGRyZW46ICIwJSIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IGNoaWxkcmVuOiAiMjUlIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgY2hpbGRyZW46ICI1MCUiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBjaGlsZHJlbjogIjc1JSIgfSkKICAgICAgICAgICAgXSB9KQogICAgICAgICAgXSB9KQogICAgICAgIH0KICAgICAgKSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgQnVkZ2V0U2VjdGlvbiwKICAgICAgICB7CiAgICAgICAgICB0aXRsZTogIjQwMWsgLyBSZXRpcmVtZW50IiwKICAgICAgICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKExhbmRtYXJrLCB7IHNpemU6IDE4IH0pLAogICAgICAgICAgY29sb3I6IENPTE9SUzIucmV0aXJlbWVudCwKICAgICAgICAgIGJnQ29sb3I6IENPTE9SUzIucmV0aXJlbWVudEJnLAogICAgICAgICAgaXRlbXM6IGJ1ZGdldC5yZXRpcmVtZW50LAogICAgICAgICAgaW5wdXRNb2RlOiAidmFsdWVfb25seSIsCiAgICAgICAgICBwcmVzZXRzOiBQUkVTRVRTLnJldGlyZW1lbnQsCiAgICAgICAgICBvblVwZGF0ZTogKGlkLCB1KSA9PiB1cGRhdGVJdGVtKCJyZXRpcmVtZW50IiwgaWQsIHUpLAogICAgICAgICAgb25BZGQ6ICgpID0+IGFkZEl0ZW0oInJldGlyZW1lbnQiLCAib25lX3RpbWUiKSwKICAgICAgICAgIG9uQWRkUHJlc2V0OiAobmFtZSwgYXQpID0+IGFkZFByZXNldEl0ZW0oInJldGlyZW1lbnQiLCBuYW1lLCAib25lX3RpbWUiLCBhdCksCiAgICAgICAgICBvbkRlbGV0ZTogKGlkKSA9PiBkZWxldGVJdGVtKCJyZXRpcmVtZW50IiwgaWQpLAogICAgICAgICAgb25SZW9yZGVyOiAoZnJvbTIsIHRvMikgPT4gcmVvcmRlckl0ZW1zKCJyZXRpcmVtZW50IiwgZnJvbTIsIHRvMikKICAgICAgICB9CiAgICAgICksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKAogICAgICAgIEJ1ZGdldFNlY3Rpb24sCiAgICAgICAgewogICAgICAgICAgdGl0bGU6ICJMaWFiaWxpdGllcyIsCiAgICAgICAgICBpY29uOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShUcmlhbmdsZUFsZXJ0LCB7IHNpemU6IDE4IH0pLAogICAgICAgICAgY29sb3I6IENPTE9SUzIubGlhYmlsaXR5LAogICAgICAgICAgYmdDb2xvcjogQ09MT1JTMi5saWFiaWxpdHlCZywKICAgICAgICAgIGl0ZW1zOiBidWRnZXQubGlhYmlsaXRpZXMsCiAgICAgICAgICBpbnB1dE1vZGU6ICJyZWN1cnJpbmciLAogICAgICAgICAgcHJlc2V0czogUFJFU0VUUy5saWFiaWxpdGllcywKICAgICAgICAgIG9uVXBkYXRlOiAoaWQsIHUpID0+IHVwZGF0ZUl0ZW0oImxpYWJpbGl0aWVzIiwgaWQsIHUpLAogICAgICAgICAgb25BZGQ6ICgpID0+IGFkZEl0ZW0oImxpYWJpbGl0aWVzIiwgIm9uZV90aW1lIiksCiAgICAgICAgICBvbkFkZFByZXNldDogKG5hbWUsIGF0KSA9PiBhZGRQcmVzZXRJdGVtKCJsaWFiaWxpdGllcyIsIG5hbWUsICJvbmVfdGltZSIsIGF0KSwKICAgICAgICAgIG9uRGVsZXRlOiAoaWQpID0+IGRlbGV0ZUl0ZW0oImxpYWJpbGl0aWVzIiwgaWQpLAogICAgICAgICAgb25SZW9yZGVyOiAoZnJvbTIsIHRvMikgPT4gcmVvcmRlckl0ZW1zKCJsaWFiaWxpdGllcyIsIGZyb20yLCB0bzIpCiAgICAgICAgfQogICAgICApLAogICAgICAoYnVkZ2V0LmluY29tZS5sZW5ndGggPiAwIHx8IGJ1ZGdldC5leHBlbnNlcy5sZW5ndGggPiAwIHx8IGJ1ZGdldC5hc3NldHMubGVuZ3RoID4gMCB8fCBidWRnZXQubGlhYmlsaXRpZXMubGVuZ3RoID4gMCkgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoU3VtbWFyeVNlY3Rpb24sIHsgYnVkZ2V0IH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogIjE2cHggMCIsIGJvcmRlclRvcDogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyTGlnaHR9YCB9LCBjbGFzc05hbWU6ICJuby1wcmludCIsIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIsIGxldHRlclNwYWNpbmc6IDAuNSwgbWFyZ2luQm90dG9tOiAxMCB9LCBjaGlsZHJlbjogIlJlbGF0ZWQgQXBwcyIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDEwLCBmbGV4V3JhcDogIndyYXAiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICB7IGVtb2ppOiAiXHUyNzAyXHVGRTBGIiwgYWNjZW50OiAiI0VGNDQ0NCIsIGFjY2VudEJnOiAiI0ZFRjJGMiIsIGxhYmVsOiAiSnVzdCBDYW5jZWwgSXQiLCBkZXNjOiAiQ2FuY2VsIHlvdXIgc3Vic2NyaXB0aW9ucyBmb3IgZnJlZSIgfSwKICAgICAgICAgIHsgZW1vamk6ICJcdXsxRjNENn1cdUZFMEYiLCBhY2NlbnQ6ICIjRjU5RTBCIiwgYWNjZW50Qmc6ICIjRkZGQkVCIiwgbGFiZWw6ICJSZXRpcmVtZW50IENhbGN1bGF0b3IiLCBkZXNjOiAiUGxhbiB5b3VyIHJldGlyZW1lbnQgd2l0aCBjb25maWRlbmNlIiB9LAogICAgICAgICAgeyBlbW9qaTogIlx1ezFGNENBfSIsIGFjY2VudDogIiM2MzY2RjEiLCBhY2NlbnRCZzogIiNFRUYyRkYiLCBsYWJlbDogIlBvcnRmb2xpbyBPcHRpbWl6ZXIiLCBkZXNjOiAiT3B0aW1pemUgeW91ciBpbnZlc3RtZW50IHBvcnRmb2xpbyIgfQogICAgICAgIF0ubWFwKChhcHAsIGkpID0+IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB0cmFja0V2ZW50KCJyZWxhdGVkX2FwcF9jbGljayIsIHsgYXBwOiBhcHAubGFiZWwgfSksCiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgZmxleDogIjEgMSAwIiwKICAgICAgICAgICAgICBtaW5XaWR0aDogMTQwLAogICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICBmbGV4RGlyZWN0aW9uOiAiY29sdW1uIiwKICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICBnYXA6IDgsCiAgICAgICAgICAgICAgcGFkZGluZzogIjE2cHggMTJweCIsCiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxNCwKICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHthcHAuYWNjZW50fTIwYCwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGFwcC5hY2NlbnRCZywKICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICB0ZXh0QWxpZ246ICJjZW50ZXIiLAogICAgICAgICAgICAgIHRyYW5zaXRpb246ICJ0cmFuc2Zvcm0gMC4xNXMsIGJveC1zaGFkb3cgMC4xNXMiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uTW91c2VFbnRlcjogKGUpID0+IHsKICAgICAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQuc3R5bGUudHJhbnNmb3JtID0gInRyYW5zbGF0ZVkoLTJweCkiOwogICAgICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS5ib3hTaGFkb3cgPSBgMCA0cHggMTJweCAke2FwcC5hY2NlbnR9MjBgOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvbk1vdXNlTGVhdmU6IChlKSA9PiB7CiAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLnRyYW5zZm9ybSA9ICIiOwogICAgICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS5ib3hTaGFkb3cgPSAiIjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyB3aWR0aDogNDQsIGhlaWdodDogNDQsIGJvcmRlclJhZGl1czogMTIsIGJhY2tncm91bmQ6IGBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAke2FwcC5hY2NlbnR9MjAsICR7YXBwLmFjY2VudH0wOClgLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIGZvbnRTaXplOiAyMiB9LCBjaGlsZHJlbjogYXBwLmVtb2ppIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNYWluIH0sIGNoaWxkcmVuOiBhcHAubGFiZWwgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogYXBwLmRlc2MgfSkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0KICAgICAgICAgIH0sCiAgICAgICAgICBpCiAgICAgICAgKSkgfSkKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgICAgbWFyZ2luVG9wOiAxNiwKICAgICAgICBwYWRkaW5nOiAiMTZweCAwIiwKICAgICAgICBib3JkZXJUb3A6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLAogICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgZ2FwOiA4LAogICAgICAgIGZsZXhXcmFwOiAid3JhcCIKICAgICAgfSwgY2xhc3NOYW1lOiAibm8tcHJpbnQiLCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogeyBwYWRkaW5nOiAiOHB4IDE0cHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5jYXJkLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNiB9LAogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgdHJhY2tFdmVudCgic3Vic2NyaWJlX2NsaWNrIik7CiAgICAgICAgICAgICAgc2V0U2hvd1N1YnNjcmliZU1vZGFsKHRydWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKE1haWwsIHsgc2l6ZTogMTUgfSksCiAgICAgICAgICAgICAgIiBTdWJzY3JpYmUiCiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogeyBwYWRkaW5nOiAiOHB4IDE0cHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5jYXJkLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNiB9LAogICAgICAgICAgICBvbkNsaWNrOiBoYW5kbGVSZXNldCwKICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShSb3RhdGVDY3csIHsgc2l6ZTogMTUgfSksCiAgICAgICAgICAgICAgIiBSZXNldCIKICAgICAgICAgICAgXQogICAgICAgICAgfQogICAgICAgICksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTRweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJ9YCwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLmNhcmQsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksIGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNjAwLCBjdXJzb3I6ICJwb2ludGVyIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA2IH0sCiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHRyYWNrRXZlbnQoImRvbmF0ZV9jbGljayIpLAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKEhlYXJ0LCB7IHNpemU6IDE1IH0pLAogICAgICAgICAgICAgICIgRG9uYXRlIgogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNHB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuY2FyZCwgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSwgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIGN1cnNvcjogInBvaW50ZXIiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDYgfSwKICAgICAgICAgICAgb25DbGljazogKCkgPT4gewogICAgICAgICAgICAgIHRyYWNrRXZlbnQoImZlZWRiYWNrX2NsaWNrIik7CiAgICAgICAgICAgICAgc2V0U2hvd0ZlZWRiYWNrTW9kYWwodHJ1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoTWVzc2FnZVNxdWFyZSwgeyBzaXplOiAxNSB9KSwKICAgICAgICAgICAgICAiIEZlZWRiYWNrIgogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNHB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuY2FyZCwgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSwgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIGN1cnNvcjogInBvaW50ZXIiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDYgfSwKICAgICAgICAgICAgb25DbGljazogKCkgPT4gewogICAgICAgICAgICAgIHRyYWNrRXZlbnQoInByaW50X2NsaWNrIik7CiAgICAgICAgICAgICAgd2luZG93LnByaW50KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoUHJpbnRlciwgeyBzaXplOiAxNSB9KSwKICAgICAgICAgICAgICAiIFByaW50IgogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICBdIH0pCiAgICBdIH0pLAogICAgY29uZmlybURpYWxvZyAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgImRpdiIsCiAgICAgIHsKICAgICAgICBzdHlsZTogeyBwb3NpdGlvbjogImZpeGVkIiwgaW5zZXQ6IDAsIGJhY2tncm91bmRDb2xvcjogInJnYmEoMCwwLDAsMC40KSIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgekluZGV4OiAxZTMgfSwKICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXRDb25maXJtRGlhbG9nKG51bGwpLAogICAgICAgIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoCiAgICAgICAgICAiZGl2IiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLmNhcmQsIGJvcmRlclJhZGl1czogMTYsIHBhZGRpbmc6IDI0LCBtYXhXaWR0aDogMzQwLCB3aWR0aDogIjkwJSIsIGJveFNoYWRvdzogIjAgOHB4IDMwcHggcmdiYSgwLDAsMCwwLjE1KSIgfSwKICAgICAgICAgICAgb25DbGljazogKGUpID0+IGUuc3RvcFByb3BhZ2F0aW9uKCksCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE1LCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNYWluLCBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiBjb25maXJtRGlhbG9nLm1lc3NhZ2UgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4LCBqdXN0aWZ5Q29udGVudDogImZsZXgtZW5kIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gc2V0Q29uZmlybURpYWxvZyhudWxsKSwgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNnB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLCBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIGZvbnRTaXplOiAxMywgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICJDYW5jZWwiIH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gewogICAgICAgICAgICAgICAgICBjb25maXJtRGlhbG9nLm9uQ29uZmlybSgpOwogICAgICAgICAgICAgICAgICBzZXRDb25maXJtRGlhbG9nKG51bGwpOwogICAgICAgICAgICAgICAgfSwgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNnB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLmV4cGVuc2UsIGNvbG9yOiAid2hpdGUiLCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIgfSwgY2hpbGRyZW46ICJDb25maXJtIiB9KQogICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgXQogICAgICAgICAgfQogICAgICAgICkKICAgICAgfQogICAgKSwKICAgIHNob3dTdWJzY3JpYmVNb2RhbCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgImRpdiIsCiAgICAgIHsKICAgICAgICBzdHlsZTogeyBwb3NpdGlvbjogImZpeGVkIiwgaW5zZXQ6IDAsIGJhY2tncm91bmRDb2xvcjogInJnYmEoMCwwLDAsMC40KSIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgekluZGV4OiAxZTMgfSwKICAgICAgICBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICBzZXRTaG93U3Vic2NyaWJlTW9kYWwoZmFsc2UpOwogICAgICAgICAgc2V0U3Vic2NyaWJlRW1haWwoIiIpOwogICAgICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJpZGxlIik7CiAgICAgICAgICBzZXRTdWJzY3JpYmVNZXNzYWdlKCIiKTsKICAgICAgICB9LAogICAgICAgIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoCiAgICAgICAgICAiZGl2IiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLmNhcmQsIGJvcmRlclJhZGl1czogMTYsIHBhZGRpbmc6IDI0LCBtYXhXaWR0aDogMzgwLCB3aWR0aDogIjkwJSIsIGJveFNoYWRvdzogIjAgOHB4IDMwcHggcmdiYSgwLDAsMCwwLjE1KSIgfSwKICAgICAgICAgICAgb25DbGljazogKGUpID0+IGUuc3RvcFByb3BhZ2F0aW9uKCksCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgYWxpZ25JdGVtczogImNlbnRlciIsIG1hcmdpbkJvdHRvbTogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJoMyIsIHsgc3R5bGU6IHsgbWFyZ2luOiAwLCBmb250U2l6ZTogMTcsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUzIudGV4dE1haW4gfSwgY2hpbGRyZW46ICJTdWJzY3JpYmUgdG8gVXBkYXRlcyIgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgIHNldFNob3dTdWJzY3JpYmVNb2RhbChmYWxzZSk7CiAgICAgICAgICAgICAgICAgIHNldFN1YnNjcmliZUVtYWlsKCIiKTsKICAgICAgICAgICAgICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJpZGxlIik7CiAgICAgICAgICAgICAgICAgIHNldFN1YnNjcmliZU1lc3NhZ2UoIiIpOwogICAgICAgICAgICAgICAgfSwgc3R5bGU6IHsgcGFkZGluZzogNCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmQ6ICJub25lIiwgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoWCwgeyBzaXplOiAxOCB9KSB9KQogICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInAiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSwgbWFyZ2luOiAiMCAwIDEycHgiIH0sIGNoaWxkcmVuOiAiR2V0IG5vdGlmaWVkIGFib3V0IG5ldyBmZWF0dXJlcyBhbmQgdXBkYXRlcy4iIH0pLAogICAgICAgICAgICAgIHN1YnNjcmliZVN0YXR1cyA9PT0gInN1Y2Nlc3MiID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogMTIsIGJvcmRlclJhZGl1czogOCwgYmFja2dyb3VuZENvbG9yOiBgJHtDT0xPUlMyLmluY29tZX0xMGAsIGNvbG9yOiBDT0xPUlMyLmluY29tZSwgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIHRleHRBbGlnbjogImNlbnRlciIgfSwgY2hpbGRyZW46IHN1YnNjcmliZU1lc3NhZ2UgfHwgIlN1YnNjcmliZWQhIiB9KSA6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKShpbXBvcnRfanN4X3J1bnRpbWUyLkZyYWdtZW50LCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgICAgICAgICAgICAgImlucHV0IiwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBzdWJzY3JpYmVFbWFpbCwKICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldFN1YnNjcmliZUVtYWlsKGUudGFyZ2V0LnZhbHVlKSwKICAgICAgICAgICAgICAgICAgICBvbktleURvd246IChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5rZXkgPT09ICJFbnRlciIpIGhhbmRsZVN1YnNjcmliZSgpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI6ICJ5b3VyQGVtYWlsLmNvbSIsCiAgICAgICAgICAgICAgICAgICAgYXV0b0ZvY3VzOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7IHdpZHRoOiAiMTAwJSIsIHBhZGRpbmc6ICIxMHB4IDEycHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsIGZvbnRTaXplOiAxNCwgZm9udEZhbWlseTogImluaGVyaXQiLCBvdXRsaW5lOiAibm9uZSIsIGJveFNpemluZzogImJvcmRlci1ib3giLCBtYXJnaW5Cb3R0b206IDggfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgc3Vic2NyaWJlTWVzc2FnZSAmJiBzdWJzY3JpYmVTdGF0dXMgPT09ICJlcnJvciIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTMi5leHBlbnNlLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IHN1YnNjcmliZU1lc3NhZ2UgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBoYW5kbGVTdWJzY3JpYmUsIGRpc2FibGVkOiBzdWJzY3JpYmVTdGF0dXMgPT09ICJsb2FkaW5nIiwgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgd2lkdGg6ICIxMDAlIiwKICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjEwcHggMTZweCIsCiAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogOCwKICAgICAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5wcmltYXJ5LAogICAgICAgICAgICAgICAgICBjb2xvcjogIndoaXRlIiwKICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDE0LAogICAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgICAgICAgIGN1cnNvcjogc3Vic2NyaWJlU3RhdHVzID09PSAibG9hZGluZyIgPyAiZGVmYXVsdCIgOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHN1YnNjcmliZVN0YXR1cyA9PT0gImxvYWRpbmciID8gMC43IDogMQogICAgICAgICAgICAgICAgfSwgY2hpbGRyZW46IHN1YnNjcmliZVN0YXR1cyA9PT0gImxvYWRpbmciID8gIlN1YnNjcmliaW5nLi4uIiA6ICJTdWJzY3JpYmUiIH0pCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICB9CiAgICApLAogICAgc2hvd0ZlZWRiYWNrTW9kYWwgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICJkaXYiLAogICAgICB7CiAgICAgICAgc3R5bGU6IHsgcG9zaXRpb246ICJmaXhlZCIsIGluc2V0OiAwLCBiYWNrZ3JvdW5kQ29sb3I6ICJyZ2JhKDAsMCwwLDAuNCkiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIHpJbmRleDogMWUzIH0sCiAgICAgICAgb25DbGljazogKCkgPT4gewogICAgICAgICAgc2V0U2hvd0ZlZWRiYWNrTW9kYWwoZmFsc2UpOwogICAgICAgICAgc2V0RmVlZGJhY2tUZXh0KCIiKTsKICAgICAgICAgIHNldEZlZWRiYWNrU3RhdHVzKCJpZGxlIik7CiAgICAgICAgfSwKICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKAogICAgICAgICAgImRpdiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5jYXJkLCBib3JkZXJSYWRpdXM6IDE2LCBwYWRkaW5nOiAyNCwgbWF4V2lkdGg6IDM4MCwgd2lkdGg6ICI5MCUiLCBib3hTaGFkb3c6ICIwIDhweCAzMHB4IHJnYmEoMCwwLDAsMC4xNSkiIH0sCiAgICAgICAgICAgIG9uQ2xpY2s6IChlKSA9PiBlLnN0b3BQcm9wYWdhdGlvbigpLAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBtYXJnaW5Cb3R0b206IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiaDMiLCB7IHN0eWxlOiB7IG1hcmdpbjogMCwgZm9udFNpemU6IDE3LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNYWluIH0sIGNoaWxkcmVuOiAiU2VuZCBGZWVkYmFjayIgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgIHNldFNob3dGZWVkYmFja01vZGFsKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgc2V0RmVlZGJhY2tUZXh0KCIiKTsKICAgICAgICAgICAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoImlkbGUiKTsKICAgICAgICAgICAgICAgIH0sIHN0eWxlOiB7IHBhZGRpbmc6IDQsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kOiAibm9uZSIsIGN1cnNvcjogInBvaW50ZXIiLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFgsIHsgc2l6ZTogMTggfSkgfSkKICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgIGVuam95Vm90ZSAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICAgICAgICAgIHBhZGRpbmc6ICI4cHggMTJweCIsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDgsCiAgICAgICAgICAgICAgICBtYXJnaW5Cb3R0b206IDEyLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBlbmpveVZvdGUgPT09ICJ1cCIgPyBgJHtDT0xPUlMyLmluY29tZX0xMGAgOiBgJHtDT0xPUlMyLmV4cGVuc2V9MTBgLAogICAgICAgICAgICAgICAgY29sb3I6IGVuam95Vm90ZSA9PT0gInVwIiA/IENPTE9SUzIuaW5jb21lIDogQ09MT1JTMi5leHBlbnNlLAogICAgICAgICAgICAgICAgZm9udFNpemU6IDEzLAogICAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgICBnYXA6IDYKICAgICAgICAgICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgZW5qb3lWb3RlID09PSAidXAiID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoVGh1bWJzVXAsIHsgc2l6ZTogMTQgfSkgOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShUaHVtYnNEb3duLCB7IHNpemU6IDE0IH0pLAogICAgICAgICAgICAgICAgZW5qb3lWb3RlID09PSAidXAiID8gIkdsYWQgeW91J3JlIGVuam95aW5nIGl0ISIgOiAiU29ycnkgdG8gaGVhciB0aGF0LiIKICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgIGZlZWRiYWNrU3RhdHVzID09PSAic3VjY2VzcyIgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAxMiwgYm9yZGVyUmFkaXVzOiA4LCBiYWNrZ3JvdW5kQ29sb3I6IGAke0NPTE9SUzIuaW5jb21lfTEwYCwgY29sb3I6IENPTE9SUzIuaW5jb21lLCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgdGV4dEFsaWduOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogIlRoYW5rIHlvdSBmb3IgeW91ciBmZWVkYmFjayEiIH0pIDogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKGltcG9ydF9qc3hfcnVudGltZTIuRnJhZ21lbnQsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKAogICAgICAgICAgICAgICAgICAidGV4dGFyZWEiLAogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZlZWRiYWNrVGV4dCwKICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldEZlZWRiYWNrVGV4dChlLnRhcmdldC52YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI6IGVuam95Vm90ZSA9PT0gInVwIiA/ICJXaGF0IGRvIHlvdSBsaWtlIG1vc3Q/IEFueSBmZWF0dXJlcyB5b3UnZCBsb3ZlIHRvIHNlZT8iIDogZW5qb3lWb3RlID09PSAiZG93biIgPyAiV2hhdCB3ZW50IHdyb25nPyBIb3cgY2FuIHdlIGltcHJvdmU/IiA6ICJXaGF0IGNhbiB3ZSBpbXByb3ZlPyBCdWcgcmVwb3J0cywgZmVhdHVyZSByZXF1ZXN0cywgYW55dGhpbmcuLi4iLAogICAgICAgICAgICAgICAgICAgIGF1dG9Gb2N1czogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICByb3dzOiA0LAogICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7IHdpZHRoOiAiMTAwJSIsIHBhZGRpbmc6ICIxMHB4IDEycHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsIGZvbnRTaXplOiAxNCwgZm9udEZhbWlseTogImluaGVyaXQiLCBvdXRsaW5lOiAibm9uZSIsIGJveFNpemluZzogImJvcmRlci1ib3giLCBtYXJnaW5Cb3R0b206IDgsIHJlc2l6ZTogInZlcnRpY2FsIiB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICBmZWVkYmFja1N0YXR1cyA9PT0gImVycm9yIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMyLmV4cGVuc2UsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogIkZhaWxlZCB0byBzZW5kLiBQbGVhc2UgdHJ5IGFnYWluLiIgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBoYW5kbGVGZWVkYmFja1N1Ym1pdCwgZGlzYWJsZWQ6IGZlZWRiYWNrU3RhdHVzID09PSAic3VibWl0dGluZyIgfHwgIWZlZWRiYWNrVGV4dC50cmltKCksIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICIxMHB4IDE2cHgiLAogICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDgsCiAgICAgICAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIucHJpbWFyeSwKICAgICAgICAgICAgICAgICAgY29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgICAgICAgICAgIGZvbnRTaXplOiAxNCwKICAgICAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgICAgICBjdXJzb3I6IGZlZWRiYWNrU3RhdHVzID09PSAic3VibWl0dGluZyIgfHwgIWZlZWRiYWNrVGV4dC50cmltKCkgPyAiZGVmYXVsdCIgOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IGZlZWRiYWNrU3RhdHVzID09PSAic3VibWl0dGluZyIgfHwgIWZlZWRiYWNrVGV4dC50cmltKCkgPyAwLjcgOiAxCiAgICAgICAgICAgICAgICB9LCBjaGlsZHJlbjogZmVlZGJhY2tTdGF0dXMgPT09ICJzdWJtaXR0aW5nIiA/ICJTZW5kaW5nLi4uIiA6ICJTdWJtaXQgRmVlZGJhY2siIH0pCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICB9CiAgICApLAogICAgc2hvd05hbWVCdWRnZXRNb2RhbCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgImRpdiIsCiAgICAgIHsKICAgICAgICBzdHlsZTogeyBwb3NpdGlvbjogImZpeGVkIiwgaW5zZXQ6IDAsIGJhY2tncm91bmRDb2xvcjogInJnYmEoMCwwLDAsMC40KSIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgekluZGV4OiAxZTMgfSwKICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXRTaG93TmFtZUJ1ZGdldE1vZGFsKGZhbHNlKSwKICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKAogICAgICAgICAgImRpdiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5jYXJkLCBib3JkZXJSYWRpdXM6IDE2LCBwYWRkaW5nOiAyNCwgbWF4V2lkdGg6IDM4MCwgd2lkdGg6ICI5MCUiLCBib3hTaGFkb3c6ICIwIDhweCAzMHB4IHJnYmEoMCwwLDAsMC4xNSkiIH0sCiAgICAgICAgICAgIG9uQ2xpY2s6IChlKSA9PiBlLnN0b3BQcm9wYWdhdGlvbigpLAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiaDMiLCB7IHN0eWxlOiB7IG1hcmdpbjogMCwgZm9udFNpemU6IDE3LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNYWluIH0sIGNoaWxkcmVuOiAiTmFtZSBZb3VyIEJ1ZGdldCIgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRTaG93TmFtZUJ1ZGdldE1vZGFsKGZhbHNlKSwgc3R5bGU6IHsgcGFkZGluZzogNCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmQ6ICJub25lIiwgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoWCwgeyBzaXplOiAxOCB9KSB9KQogICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YWx1ZTogbmFtZUJ1ZGdldFZhbHVlLAogICAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldE5hbWVCdWRnZXRWYWx1ZShlLnRhcmdldC52YWx1ZSksCiAgICAgICAgICAgICAgICAgIG9uS2V5RG93bjogKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoZS5rZXkgPT09ICJFbnRlciIgJiYgbmFtZUJ1ZGdldFZhbHVlLnRyaW0oKSkgewogICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmFtZWQyID0geyAuLi5idWRnZXQsIG5hbWU6IG5hbWVCdWRnZXRWYWx1ZS50cmltKCkgfTsKICAgICAgICAgICAgICAgICAgICAgIHNldEJ1ZGdldChuYW1lZDIpOwogICAgICAgICAgICAgICAgICAgICAgc2V0TmFtZUlucHV0KG5hbWVCdWRnZXRWYWx1ZS50cmltKCkpOwogICAgICAgICAgICAgICAgICAgICAgZG9TYXZlQnVkZ2V0KG5hbWVkMik7CiAgICAgICAgICAgICAgICAgICAgICBzZXRTaG93TmFtZUJ1ZGdldE1vZGFsKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAiZS5nLiBNb250aGx5IEJ1ZGdldCwgSG91c2Vob2xkLCBTaWRlIEh1c3RsZSIsCiAgICAgICAgICAgICAgICAgIGF1dG9Gb2N1czogdHJ1ZSwKICAgICAgICAgICAgICAgICAgc3R5bGU6IHsgd2lkdGg6ICIxMDAlIiwgcGFkZGluZzogIjEwcHggMTJweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJ9YCwgZm9udFNpemU6IDE0LCBmb250RmFtaWx5OiAiaW5oZXJpdCIsIG91dGxpbmU6ICJub25lIiwgYm94U2l6aW5nOiAiYm9yZGVyLWJveCIsIG1hcmdpbkJvdHRvbTogMTIgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4LCBqdXN0aWZ5Q29udGVudDogImZsZXgtZW5kIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gc2V0U2hvd05hbWVCdWRnZXRNb2RhbChmYWxzZSksIHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTZweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJ9YCwgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBmb250U2l6ZTogMTMsIGN1cnNvcjogInBvaW50ZXIiLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiQ2FuY2VsIiB9KSwKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgY29uc3QgbmFtZSA9IG5hbWVCdWRnZXRWYWx1ZS50cmltKCkgfHwgIk15IEJ1ZGdldCI7CiAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWVkMiA9IHsgLi4uYnVkZ2V0LCBuYW1lIH07CiAgICAgICAgICAgICAgICAgIHNldEJ1ZGdldChuYW1lZDIpOwogICAgICAgICAgICAgICAgICBzZXROYW1lSW5wdXQobmFtZSk7CiAgICAgICAgICAgICAgICAgIGRvU2F2ZUJ1ZGdldChuYW1lZDIpOwogICAgICAgICAgICAgICAgICBzZXRTaG93TmFtZUJ1ZGdldE1vZGFsKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0sIHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTZweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5wcmltYXJ5LCBjb2xvcjogIndoaXRlIiwgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIGN1cnNvcjogInBvaW50ZXIiIH0sIGNoaWxkcmVuOiAiU2F2ZSIgfSkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICApCiAgICAgIH0KICAgICksCiAgICBzYXZlVG9hc3QgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgIHBvc2l0aW9uOiAiZml4ZWQiLAogICAgICB0b3A6IDIwLAogICAgICBsZWZ0OiAiNTAlIiwKICAgICAgdHJhbnNmb3JtOiAidHJhbnNsYXRlWCgtNTAlKSIsCiAgICAgIHpJbmRleDogMTEwMCwKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLnByaW1hcnksCiAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICBwYWRkaW5nOiAiMTBweCAyMHB4IiwKICAgICAgYm9yZGVyUmFkaXVzOiAxMiwKICAgICAgZm9udFNpemU6IDEzLAogICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgIGJveFNoYWRvdzogIjAgNHB4IDE2cHggcmdiYSgwLDAsMCwwLjE1KSIsCiAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgIGdhcDogOCwKICAgICAgYW5pbWF0aW9uOiAiZmFkZUluT3V0IDEuNXMgZWFzZSIKICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKENoZWNrLCB7IHNpemU6IDE2IH0pLAogICAgICAiIEJ1ZGdldCBzYXZlZCEiCiAgICBdIH0pLAogICAgIWVuam95Vm90ZSAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBwb3NpdGlvbjogImZpeGVkIiwgYm90dG9tOiAyMCwgcmlnaHQ6IHBpbGxSaWdodCwgekluZGV4OiA5MDAsIHBvaW50ZXJFdmVudHM6ICJub25lIiB9LCBjbGFzc05hbWU6ICJuby1wcmludCIsIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgcG9pbnRlckV2ZW50czogImF1dG8iLAogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuY2FyZCwKICAgICAgYm9yZGVyUmFkaXVzOiAyNCwKICAgICAgcGFkZGluZzogIjEwcHggMTZweCIsCiAgICAgIGJveFNoYWRvdzogIjAgNHB4IDIwcHggcmdiYSgwLDAsMCwwLjEyKSIsCiAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsCiAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgIGdhcDogMTAKICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUzIudGV4dE1haW4gfSwgY2hpbGRyZW46ICJFbmpveWluZyB0aGlzIGFwcD8iIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBoYW5kbGVFbmpveVZvdGUoInVwIiksIHN0eWxlOiB7CiAgICAgICAgcGFkZGluZzogNiwKICAgICAgICBib3JkZXJSYWRpdXM6IDgsCiAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJ9YCwKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgIGNvbG9yOiBDT0xPUlMyLmluY29tZQogICAgICB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoVGh1bWJzVXAsIHsgc2l6ZTogMTYgfSkgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IGhhbmRsZUVuam95Vm90ZSgiZG93biIpLCBzdHlsZTogewogICAgICAgIHBhZGRpbmc6IDYsCiAgICAgICAgYm9yZGVyUmFkaXVzOiA4LAogICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsCiAgICAgICAgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLAogICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICBjb2xvcjogQ09MT1JTMi5leHBlbnNlCiAgICAgIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShUaHVtYnNEb3duLCB7IHNpemU6IDE2IH0pIH0pCiAgICBdIH0pIH0pLAogICAgc2hvd0xvZ2luTW9kYWwgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgIExvZ2luTW9kYWwsCiAgICAgIHsKICAgICAgICBvbkNsb3NlOiAoKSA9PiBzZXRTaG93TG9naW5Nb2RhbChmYWxzZSksCiAgICAgICAgb25Mb2dpblN1Y2Nlc3M6ICgpID0+IHsKICAgICAgICAgIHNldFNob3dMb2dpbk1vZGFsKGZhbHNlKTsKICAgICAgICB9CiAgICAgIH0KICAgICkKICBdIH0pOwp9CgovLyBzcmMvbWFpbi50c3gKdmFyIGltcG9ydF9qc3hfcnVudGltZTMgPSBfX3RvRVNNKHJlcXVpcmVfanN4X3J1bnRpbWUoKSwgMSk7CnZhciBFcnJvckJvdW5kYXJ5ID0gY2xhc3MgZXh0ZW5kcyBpbXBvcnRfcmVhY3Q1My5kZWZhdWx0LkNvbXBvbmVudCB7CiAgY29uc3RydWN0b3IocHJvcHMpIHsKICAgIHN1cGVyKHByb3BzKTsKICAgIHRoaXMuc3RhdGUgPSB7IGhhc0Vycm9yOiBmYWxzZSB9OwogIH0KICBzdGF0aWMgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yKGVycm9yKSB7CiAgICByZXR1cm4geyBoYXNFcnJvcjogdHJ1ZSwgZXJyb3IgfTsKICB9CiAgY29tcG9uZW50RGlkQ2F0Y2goZXJyb3IsIGVycm9ySW5mbykgewogICAgY29uc29sZS5lcnJvcigiV2lkZ2V0IEVycm9yIEJvdW5kYXJ5IGNhdWdodCBlcnJvcjoiLCBlcnJvciwgZXJyb3JJbmZvKTsKICAgIHRyeSB7CiAgICAgIGZldGNoKCIvYXBpL3RyYWNrIiwgewogICAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICAgIGhlYWRlcnM6IHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgIGV2ZW50OiAiY3Jhc2giLAogICAgICAgICAgZGF0YTogewogICAgICAgICAgICBlcnJvcjogZXJyb3I/Lm1lc3NhZ2UgfHwgIlVua25vd24gZXJyb3IiLAogICAgICAgICAgICBzdGFjazogZXJyb3I/LnN0YWNrLAogICAgICAgICAgICBjb21wb25lbnRTdGFjazogZXJyb3JJbmZvPy5jb21wb25lbnRTdGFjawogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgIH0pLmNhdGNoKChlKSA9PiBjb25zb2xlLmVycm9yKCJGYWlsZWQgdG8gcmVwb3J0IGNyYXNoIiwgZSkpOwogICAgfSBjYXRjaCAoZSkgewogICAgfQogIH0KICByZW5kZXIoKSB7CiAgICBpZiAodGhpcy5zdGF0ZS5oYXNFcnJvcikgewogICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUzLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBhZGRpbmc6IDIwLCB0ZXh0QWxpZ246ICJjZW50ZXIiLCBmb250RmFtaWx5OiAic2Fucy1zZXJpZiIsIGNvbG9yOiAiI0RDMjYyNiIsIHdvcmRCcmVhazogImJyZWFrLXdvcmQiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUzLmpzeCkoImgzIiwgeyBjaGlsZHJlbjogIlNvbWV0aGluZyB3ZW50IHdyb25nLiIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUzLmpzeCkoInAiLCB7IGNoaWxkcmVuOiAiUGxlYXNlIHRyeSByZWZyZXNoaW5nIHRoZSBwYWdlLiIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUzLmpzeHMpKCJkZXRhaWxzIiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDEwLCB0ZXh0QWxpZ246ICJsZWZ0IiwgZm9udFNpemU6ICIxMnB4IiwgY29sb3I6ICIjNjY2IiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUzLmpzeCkoInN1bW1hcnkiLCB7IGNoaWxkcmVuOiAiRGVidWcgRXJyb3IgRGV0YWlscyIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTMuanN4cykoInByZSIsIHsgc3R5bGU6IHsgd2hpdGVTcGFjZTogInByZS13cmFwIiwgYmFja2dyb3VuZDogIiNmNWY1ZjUiLCBwYWRkaW5nOiAxMCwgYm9yZGVyUmFkaXVzOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIHRoaXMuc3RhdGUuZXJyb3I/LnRvU3RyaW5nKCksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMy5qc3gpKCJiciIsIHt9KSwKICAgICAgICAgICAgdGhpcy5zdGF0ZS5lcnJvcj8uc3RhY2sKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5wcm9wcy5jaGlsZHJlbjsKICB9Cn07CnZhciBnZXRIeWRyYXRpb25EYXRhID0gKCkgPT4gewogIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBTdGFydGluZyBoeWRyYXRpb24gY2hlY2suLi4iKTsKICBpZiAodHlwZW9mIHdpbmRvdyA9PT0gInVuZGVmaW5lZCIpIHsKICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBXaW5kb3cgaXMgdW5kZWZpbmVkIik7CiAgICByZXR1cm4ge307CiAgfQogIGNvbnN0IG9hID0gd2luZG93Lm9wZW5haTsKICBpZiAoIW9hKSB7CiAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gd2luZG93Lm9wZW5haSBub3QgZm91bmQsIHJlbmRlcmluZyB3aXRoIGRlZmF1bHRzIik7CiAgICByZXR1cm4ge307CiAgfQogIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSB3aW5kb3cub3BlbmFpIGZvdW5kOiIsIE9iamVjdC5rZXlzKG9hKSk7CiAgY29uc3QgY2FuZGlkYXRlcyA9IFsKICAgIG9hLnRvb2xPdXRwdXQsCiAgICBvYS5zdHJ1Y3R1cmVkQ29udGVudCwKICAgIG9hLnJlc3VsdD8uc3RydWN0dXJlZENvbnRlbnQsCiAgICBvYS50b29sSW5wdXQKICBdOwogIGZvciAoY29uc3QgY2FuZGlkYXRlIG9mIGNhbmRpZGF0ZXMpIHsKICAgIGlmIChjYW5kaWRhdGUgJiYgdHlwZW9mIGNhbmRpZGF0ZSA9PT0gIm9iamVjdCIgJiYgT2JqZWN0LmtleXMoY2FuZGlkYXRlKS5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBGb3VuZCBkYXRhOiIsIGNhbmRpZGF0ZSk7CiAgICAgIHJldHVybiBjYW5kaWRhdGU7CiAgICB9CiAgfQogIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBObyBkYXRhIGZvdW5kIGluIGFueSBjYW5kaWRhdGUgc291cmNlIik7CiAgcmV0dXJuIHt9Owp9Owpjb25zb2xlLmxvZygiW01haW5dIE15IEJ1ZGdldCBtYWluLnRzeCBsb2FkaW5nLi4uIik7CmZ1bmN0aW9uIEFwcCh7IGluaXRpYWxEYXRhOiBpbml0aWFsRGF0YTIgfSkgewogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTMuanN4KShNeUJ1ZGdldCwgeyBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyIH0pOwp9CnZhciBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibXktYnVkZ2V0LXJvb3QiKTsKaWYgKCFjb250YWluZXIpIHsKICB0aHJvdyBuZXcgRXJyb3IoIm15LWJ1ZGdldC1yb290IGVsZW1lbnQgbm90IGZvdW5kIik7Cn0KdmFyIHJvb3QgPSAoMCwgaW1wb3J0X2NsaWVudC5jcmVhdGVSb290KShjb250YWluZXIpOwp2YXIgcmVuZGVyQXBwID0gKGRhdGEpID0+IHsKICByb290LnJlbmRlcigKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMy5qc3gpKGltcG9ydF9yZWFjdDUzLmRlZmF1bHQuU3RyaWN0TW9kZSwgeyBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUzLmpzeCkoRXJyb3JCb3VuZGFyeSwgeyBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUzLmpzeCkoQXBwLCB7IGluaXRpYWxEYXRhOiBkYXRhIH0sIERhdGUubm93KCkpIH0pIH0pCiAgKTsKfTsKdmFyIGluaXRpYWxEYXRhID0gZ2V0SHlkcmF0aW9uRGF0YSgpOwpyZW5kZXJBcHAoaW5pdGlhbERhdGEpOwp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigib3BlbmFpOnNldF9nbG9iYWxzIiwgKGV2KSA9PiB7CiAgY29uc3QgZ2xvYmFscyA9IGV2Py5kZXRhaWw/Lmdsb2JhbHM7CiAgaWYgKGdsb2JhbHMpIHsKICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBMYXRlIGV2ZW50IHJlY2VpdmVkOiIsIGdsb2JhbHMpOwogICAgY29uc3QgY2FuZGlkYXRlcyA9IFsKICAgICAgZ2xvYmFscy50b29sT3V0cHV0LAogICAgICBnbG9iYWxzLnN0cnVjdHVyZWRDb250ZW50LAogICAgICBnbG9iYWxzLnJlc3VsdD8uc3RydWN0dXJlZENvbnRlbnQsCiAgICAgIGdsb2JhbHMudG9vbElucHV0CiAgICBdOwogICAgZm9yIChjb25zdCBjYW5kaWRhdGUgb2YgY2FuZGlkYXRlcykgewogICAgICBpZiAoY2FuZGlkYXRlICYmIHR5cGVvZiBjYW5kaWRhdGUgPT09ICJvYmplY3QiICYmIE9iamVjdC5rZXlzKGNhbmRpZGF0ZSkubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBSZS1yZW5kZXJpbmcgd2l0aCBsYXRlIGRhdGE6IiwgY2FuZGlkYXRlKTsKICAgICAgICByZW5kZXJBcHAoY2FuZGlkYXRlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICB9Cn0pOwp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigKICAibWVzc2FnZSIsCiAgKGV2ZW50KSA9PiB7CiAgICBpZiAoZXZlbnQuc291cmNlICE9PSB3aW5kb3cucGFyZW50KSByZXR1cm47CiAgICBjb25zdCBtZXNzYWdlID0gZXZlbnQuZGF0YTsKICAgIGlmICghbWVzc2FnZSB8fCBtZXNzYWdlLmpzb25ycGMgIT09ICIyLjAiKSByZXR1cm47CiAgICBpZiAobWVzc2FnZS5tZXRob2QgIT09ICJ1aS9ub3RpZmljYXRpb25zL3Rvb2wtcmVzdWx0IikgcmV0dXJuOwogICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIE1DUCBBcHBzIGJyaWRnZSB0b29sLXJlc3VsdCByZWNlaXZlZDoiLCBtZXNzYWdlLnBhcmFtcyk7CiAgICBjb25zdCB0b29sUmVzdWx0ID0gbWVzc2FnZS5wYXJhbXM7CiAgICBjb25zdCBkYXRhID0gdG9vbFJlc3VsdD8uc3RydWN0dXJlZENvbnRlbnQgPz8gdG9vbFJlc3VsdD8ucmVzdWx0Py5zdHJ1Y3R1cmVkQ29udGVudCA/PyB7fTsKICAgIGlmIChkYXRhICYmIHR5cGVvZiBkYXRhID09PSAib2JqZWN0IiAmJiBPYmplY3Qua2V5cyhkYXRhKS5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBSZS1yZW5kZXJpbmcgd2l0aCBNQ1AgQXBwcyBicmlkZ2UgZGF0YToiLCBkYXRhKTsKICAgICAgcmVuZGVyQXBwKGRhdGEpOwogICAgfQogIH0sCiAgeyBwYXNzaXZlOiB0cnVlIH0KKTsKLyohIEJ1bmRsZWQgbGljZW5zZSBpbmZvcm1hdGlvbjoKCnJlYWN0L2Nqcy9yZWFjdC5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnNjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnJlYWN0LWRvbS9janMvcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKICAoKioKICAgKiBDaGVja3MgaWYgYW4gZXZlbnQgaXMgc3VwcG9ydGVkIGluIHRoZSBjdXJyZW50IGV4ZWN1dGlvbiBlbnZpcm9ubWVudC4KICAgKgogICAqIE5PVEU6IFRoaXMgd2lsbCBub3Qgd29yayBjb3JyZWN0bHkgZm9yIG5vbi1nZW5lcmljIGV2ZW50cyBzdWNoIGFzIGBjaGFuZ2VgLAogICAqIGByZXNldGAsIGBsb2FkYCwgYGVycm9yYCwgYW5kIGBzZWxlY3RgLgogICAqCiAgICogQm9ycm93cyBmcm9tIE1vZGVybml6ci4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudE5hbWVTdWZmaXggRXZlbnQgbmFtZSwgZS5nLiAiY2xpY2siLgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZC4KICAgKiBAaW50ZXJuYWwKICAgKiBAbGljZW5zZSBNb2Rlcm5penIgMy4wLjBwcmUgKEN1c3RvbSBCdWlsZCkgfCBNSVQKICAgKikKCnVzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBNZXRhIFBsYXRmb3JtcywgSW5jLiBhbmQgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnVzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltL3dpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiB1c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltL3dpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanMKICAgKgogICAqIENvcHlyaWdodCAoYykgTWV0YSBQbGF0Zm9ybXMsIEluYy4gYW5kIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpkZWNpbWFsLmpzLWxpZ2h0L2RlY2ltYWwuanM6CiAgKCohIGRlY2ltYWwuanMtbGlnaHQgdjIuNS4xIGh0dHBzOi8vZ2l0aHViLmNvbS9NaWtlTWNsL2RlY2ltYWwuanMtbGlnaHQvTElDRU5DRSAqKQoKdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXdpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiB1c2Utc3luYy1leHRlcm5hbC1zdG9yZS13aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIE1ldGEgUGxhdGZvcm1zLCBJbmMuIGFuZCBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKcmVhY3QvY2pzL3JlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogcmVhY3QtanN4LXJ1bnRpbWUuZGV2ZWxvcG1lbnQuanMKICAgKgogICAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL3NoYXJlZC9zcmMvdXRpbHMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9kZWZhdWx0QXR0cmlidXRlcy5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL0ljb24uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9jcmVhdGVMdWNpZGVJY29uLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYXJyb3ctdXAtcmlnaHQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9idWlsZGluZy0yLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hlY2suanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGV2cm9uLWRvd24uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGV2cm9uLXVwLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2lyY2xlLWFsZXJ0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2lyY2xlLWNoZWNrLWJpZy5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2Nsb2NrLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvZG9sbGFyLXNpZ24uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9ncmlwLXZlcnRpY2FsLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvaGVhcnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9ob3VzZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2xhbmRtYXJrLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbG9hZGVyLWNpcmNsZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2xvY2suanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9tYWlsLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbWVzc2FnZS1zcXVhcmUuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wZW4uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9waWdneS1iYW5rLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcGx1cy5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3ByaW50ZXIuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9yZWZyZXNoLWN3LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcm90YXRlLWNjdy5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3NhdmUuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9zZWFyY2guanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90aHVtYnMtZG93bi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RodW1icy11cC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RyYXNoLTIuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90cmVuZGluZy1kb3duLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdHJlbmRpbmctdXAuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90cmlhbmdsZS1hbGVydC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3dhbGxldC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3guanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9sdWNpZGUtcmVhY3QuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKKi8K";
      const decodedScript = atob(encodedScript);
      const blob = new Blob([decodedScript], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      import(url)
        .catch(err => {
          console.error('[My Budget] Failed to load:', err);
          const root = document.getElementById('my-budget-root');
          if (root) {
            root.innerHTML = '<div style="padding:20px;text-align:center;font-family:sans-serif;color:#DC2626"><h3>Failed to load budget</h3><p>Please refresh the page.</p></div>';
          }
        });
    </script>
  </body>
</html>
