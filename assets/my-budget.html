<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Budget â€” Personal Budget Tool</title>
    <meta name="description" content="An interactive personal budget tool. Track income, expenses, and savings goals." />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #FAFAFA;
        color: #1A1A1A;
        -webkit-font-smoothing: antialiased;
      }
      #my-budget-root {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        box-sizing: border-box;
      }
      #my-budget-root > * {
        width: 100%;
        max-width: 100%;
      }
      @media print {
        .no-print { display: none !important; }
        body { background: white; }
      }
    </style>
  </head>
  <body>
    <div id="my-budget-root"></div>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <script type="module">
      // Decode and execute the base64-encoded React bundle
      const encodedScript = "dmFyIF9fY3JlYXRlID0gT2JqZWN0LmNyZWF0ZTsKdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZ2V0T3duUHJvcERlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOwp2YXIgX19nZXRPd25Qcm9wTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lczsKdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CnZhciBfX2NvbW1vbkpTID0gKGNiLCBtb2QpID0+IGZ1bmN0aW9uIF9fcmVxdWlyZSgpIHsKICByZXR1cm4gbW9kIHx8ICgwLCBjYltfX2dldE93blByb3BOYW1lcyhjYilbMF1dKSgobW9kID0geyBleHBvcnRzOiB7fSB9KS5leHBvcnRzLCBtb2QpLCBtb2QuZXhwb3J0czsKfTsKdmFyIF9fZXhwb3J0ID0gKHRhcmdldCwgYWxsKSA9PiB7CiAgZm9yICh2YXIgbmFtZSBpbiBhbGwpCiAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwp9Owp2YXIgX19jb3B5UHJvcHMgPSAodG8yLCBmcm9tMiwgZXhjZXB0LCBkZXNjKSA9PiB7CiAgaWYgKGZyb20yICYmIHR5cGVvZiBmcm9tMiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGZyb20yID09PSAiZnVuY3Rpb24iKSB7CiAgICBmb3IgKGxldCBrZXkgb2YgX19nZXRPd25Qcm9wTmFtZXMoZnJvbTIpKQogICAgICBpZiAoIV9faGFzT3duUHJvcC5jYWxsKHRvMiwga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICBfX2RlZlByb3AodG8yLCBrZXksIHsgZ2V0OiAoKSA9PiBmcm9tMltrZXldLCBlbnVtZXJhYmxlOiAhKGRlc2MgPSBfX2dldE93blByb3BEZXNjKGZyb20yLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgfQogIHJldHVybiB0bzI7Cn07CnZhciBfX3RvRVNNID0gKG1vZCwgaXNOb2RlTW9kZSwgdGFyZ2V0KSA9PiAodGFyZ2V0ID0gbW9kICE9IG51bGwgPyBfX2NyZWF0ZShfX2dldFByb3RvT2YobW9kKSkgOiB7fSwgX19jb3B5UHJvcHMoCiAgLy8gSWYgdGhlIGltcG9ydGVyIGlzIGluIG5vZGUgY29tcGF0aWJpbGl0eSBtb2RlIG9yIHRoaXMgaXMgbm90IGFuIEVTTQogIC8vIGZpbGUgdGhhdCBoYXMgYmVlbiBjb252ZXJ0ZWQgdG8gYSBDb21tb25KUyBmaWxlIHVzaW5nIGEgQmFiZWwtCiAgLy8gY29tcGF0aWJsZSB0cmFuc2Zvcm0gKGkuZS4gIl9fZXNNb2R1bGUiIGhhcyBub3QgYmVlbiBzZXQpLCB0aGVuIHNldAogIC8vICJkZWZhdWx0IiB0byB0aGUgQ29tbW9uSlMgIm1vZHVsZS5leHBvcnRzIiBmb3Igbm9kZSBjb21wYXRpYmlsaXR5LgogIGlzTm9kZU1vZGUgfHwgIW1vZCB8fCAhbW9kLl9fZXNNb2R1bGUgPyBfX2RlZlByb3AodGFyZ2V0LCAiZGVmYXVsdCIsIHsgdmFsdWU6IG1vZCwgZW51bWVyYWJsZTogdHJ1ZSB9KSA6IHRhcmdldCwKICBtb2QKKSk7CgovLyBub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3JlYWN0X2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKHRydWUpIHsKICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RWZXJzaW9uID0gIjE4LjMuMSI7CiAgICAgICAgdmFyIFJFQUNUX0VMRU1FTlRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmVsZW1lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfUE9SVEFMX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wb3J0YWwiKTsKICAgICAgICB2YXIgUkVBQ1RfRlJBR01FTlRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmZyYWdtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdHJpY3RfbW9kZSIpOwogICAgICAgIHZhciBSRUFDVF9QUk9GSUxFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvZmlsZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPVklERVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb3ZpZGVyIik7CiAgICAgICAgdmFyIFJFQUNUX0NPTlRFWFRfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmNvbnRleHQiKTsKICAgICAgICB2YXIgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIgPSBTeW1ib2wuZm9yKCJyZWFjdC5mb3J3YXJkX3JlZiIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2UiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3VzcGVuc2VfbGlzdCIpOwogICAgICAgIHZhciBSRUFDVF9NRU1PX1RZUEUyID0gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwogICAgICAgIHZhciBSRUFDVF9MQVpZX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sYXp5Iik7CiAgICAgICAgdmFyIFJFQUNUX09GRlNDUkVFTl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Qub2Zmc2NyZWVuIik7CiAgICAgICAgdmFyIE1BWUJFX0lURVJBVE9SX1NZTUJPTCA9IFN5bWJvbC5pdGVyYXRvcjsKICAgICAgICB2YXIgRkFVWF9JVEVSQVRPUl9TWU1CT0wgPSAiQEBpdGVyYXRvciI7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXRlcmF0b3JGbihtYXliZUl0ZXJhYmxlKSB7CiAgICAgICAgICBpZiAobWF5YmVJdGVyYWJsZSA9PT0gbnVsbCB8fCB0eXBlb2YgbWF5YmVJdGVyYWJsZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWF5YmVJdGVyYXRvciA9IE1BWUJFX0lURVJBVE9SX1NZTUJPTCAmJiBtYXliZUl0ZXJhYmxlW01BWUJFX0lURVJBVE9SX1NZTUJPTF0gfHwgbWF5YmVJdGVyYWJsZVtGQVVYX0lURVJBVE9SX1NZTUJPTF07CiAgICAgICAgICBpZiAodHlwZW9mIG1heWJlSXRlcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIG1heWJlSXRlcmF0b3I7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICogQHR5cGUge1JlYWN0Q29tcG9uZW50fQogICAgICAgICAgICovCiAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcgPSB7CiAgICAgICAgICB0cmFuc2l0aW9uOiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50QWN0UXVldWUgPSB7CiAgICAgICAgICBjdXJyZW50OiBudWxsLAogICAgICAgICAgLy8gVXNlZCB0byByZXByb2R1Y2UgYmVoYXZpb3Igb2YgYGJhdGNoZWRVcGRhdGVzYCBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgIGlzQmF0Y2hpbmdMZWdhY3k6IGZhbHNlLAogICAgICAgICAgZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGU6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICogQHR5cGUge1JlYWN0Q29tcG9uZW50fQogICAgICAgICAgICovCiAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgfTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IHt9OwogICAgICAgIHZhciBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBzZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudEV4dHJhU3RhY2tGcmFtZSA9IHN0YWNrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB7CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLnNldEV4dHJhU3RhY2tGcmFtZSA9IGZ1bmN0aW9uKHN0YWNrKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjdXJyZW50RXh0cmFTdGFja0ZyYW1lID0gc3RhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IG51bGw7CiAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldFN0YWNrQWRkZW5kdW0gPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHN0YWNrID0gIiI7CiAgICAgICAgICAgIGlmIChjdXJyZW50RXh0cmFTdGFja0ZyYW1lKSB7CiAgICAgICAgICAgICAgc3RhY2sgKz0gY3VycmVudEV4dHJhU3RhY2tGcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW1wbCA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrOwogICAgICAgICAgICBpZiAoaW1wbCkgewogICAgICAgICAgICAgIHN0YWNrICs9IGltcGwoKSB8fCAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RhY2s7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZW5hYmxlU2NvcGVBUEkgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlQ2FjaGVFbGVtZW50ID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVEZWJ1Z1RyYWNpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgUmVhY3RTaGFyZWRJbnRlcm5hbHMgPSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLAogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcsCiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lcgogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRBY3RRdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuMyhmb3JtYXQyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuID4gMSA/IF9sZW4gLSAxIDogMCksIF9rZXkgPSAxOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkgLSAxXSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJpbnRXYXJuaW5nKCJ3YXJuIiwgZm9ybWF0MiwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXJyb3IoZm9ybWF0MikgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQyLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmludFdhcm5pbmcobGV2ZWwsIGZvcm1hdDIsIGFyZ3MpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICAgICAgdmFyIHN0YWNrID0gUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIuZ2V0U3RhY2tBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoc3RhY2sgIT09ICIiKSB7CiAgICAgICAgICAgICAgZm9ybWF0MiArPSAiJXMiOwogICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQyKTsKICAgICAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZVtsZXZlbF0sIGNvbnNvbGUsIGFyZ3NXaXRoRm9ybWF0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5TdGF0ZVVwZGF0ZUZvclVubW91bnRlZENvbXBvbmVudCA9IHt9OwogICAgICAgIGZ1bmN0aW9uIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBfY29uc3RydWN0b3IgPSBwdWJsaWNJbnN0YW5jZS5jb25zdHJ1Y3RvcjsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBfY29uc3RydWN0b3IgJiYgKF9jb25zdHJ1Y3Rvci5kaXNwbGF5TmFtZSB8fCBfY29uc3RydWN0b3IubmFtZSkgfHwgIlJlYWN0Q2xhc3MiOwogICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IGNvbXBvbmVudE5hbWUgKyAiLiIgKyBjYWxsZXJOYW1lOwogICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yVW5tb3VudGVkQ29tcG9uZW50W3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVycm9yKCJDYW4ndCBjYWxsICVzIG9uIGEgY29tcG9uZW50IHRoYXQgaXMgbm90IHlldCBtb3VudGVkLiBUaGlzIGlzIGEgbm8tb3AsIGJ1dCBpdCBtaWdodCBpbmRpY2F0ZSBhIGJ1ZyBpbiB5b3VyIGFwcGxpY2F0aW9uLiBJbnN0ZWFkLCBhc3NpZ24gdG8gYHRoaXMuc3RhdGVgIGRpcmVjdGx5IG9yIGRlZmluZSBhIGBzdGF0ZSA9IHt9O2AgY2xhc3MgcHJvcGVydHkgd2l0aCB0aGUgZGVzaXJlZCBzdGF0ZSBpbiB0aGUgJXMgY29tcG9uZW50LiIsIGNhbGxlck5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnRbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3ROb29wVXBkYXRlUXVldWUgPSB7CiAgICAgICAgICAvKioKICAgICAgICAgICAqIENoZWNrcyB3aGV0aGVyIG9yIG5vdCB0aGlzIGNvbXBvc2l0ZSBjb21wb25lbnQgaXMgbW91bnRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7UmVhY3RDbGFzc30gcHVibGljSW5zdGFuY2UgVGhlIGluc3RhbmNlIHdlIHdhbnQgdG8gdGVzdC4KICAgICAgICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgbW91bnRlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAgICogQHByb3RlY3RlZAogICAgICAgICAgICogQGZpbmFsCiAgICAgICAgICAgKi8KICAgICAgICAgIGlzTW91bnRlZDogZnVuY3Rpb24ocHVibGljSW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogRm9yY2VzIGFuIHVwZGF0ZS4gVGhpcyBzaG91bGQgb25seSBiZSBpbnZva2VkIHdoZW4gaXQgaXMga25vd24gd2l0aAogICAgICAgICAgICogY2VydGFpbnR5IHRoYXQgd2UgYXJlICoqbm90KiogaW4gYSBET00gdHJhbnNhY3Rpb24uCiAgICAgICAgICAgKgogICAgICAgICAgICogWW91IG1heSB3YW50IHRvIGNhbGwgdGhpcyB3aGVuIHlvdSBrbm93IHRoYXQgc29tZSBkZWVwZXIgYXNwZWN0IG9mIHRoZQogICAgICAgICAgICogY29tcG9uZW50J3Mgc3RhdGUgaGFzIGNoYW5nZWQgYnV0IGBzZXRTdGF0ZWAgd2FzIG5vdCBjYWxsZWQuCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhpcyB3aWxsIG5vdCBpbnZva2UgYHNob3VsZENvbXBvbmVudFVwZGF0ZWAsIGJ1dCBpdCB3aWxsIGludm9rZQogICAgICAgICAgICogYGNvbXBvbmVudFdpbGxVcGRhdGVgIGFuZCBgY29tcG9uZW50RGlkVXBkYXRlYC4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB0aGF0IHNob3VsZCByZXJlbmRlci4KICAgICAgICAgICAqIEBwYXJhbSB7P2Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsZWQgYWZ0ZXIgY29tcG9uZW50IGlzIHVwZGF0ZWQuCiAgICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IGNhbGxlck5hbWUgbmFtZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBpbiB0aGUgcHVibGljIEFQSS4KICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICBlbnF1ZXVlRm9yY2VVcGRhdGU6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlLCBjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgImZvcmNlVXBkYXRlIik7CiAgICAgICAgICB9LAogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBSZXBsYWNlcyBhbGwgb2YgdGhlIHN0YXRlLiBBbHdheXMgdXNlIHRoaXMgb3IgYHNldFN0YXRlYCB0byBtdXRhdGUgc3RhdGUuCiAgICAgICAgICAgKiBZb3Ugc2hvdWxkIHRyZWF0IGB0aGlzLnN0YXRlYCBhcyBpbW11dGFibGUuCiAgICAgICAgICAgKgogICAgICAgICAgICogVGhlcmUgaXMgbm8gZ3VhcmFudGVlIHRoYXQgYHRoaXMuc3RhdGVgIHdpbGwgYmUgaW1tZWRpYXRlbHkgdXBkYXRlZCwgc28KICAgICAgICAgICAqIGFjY2Vzc2luZyBgdGhpcy5zdGF0ZWAgYWZ0ZXIgY2FsbGluZyB0aGlzIG1ldGhvZCBtYXkgcmV0dXJuIHRoZSBvbGQgdmFsdWUuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2UgdGhhdCBzaG91bGQgcmVyZW5kZXIuCiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gY29tcGxldGVTdGF0ZSBOZXh0IHN0YXRlLgogICAgICAgICAgICogQHBhcmFtIHs/ZnVuY3Rpb259IGNhbGxiYWNrIENhbGxlZCBhZnRlciBjb21wb25lbnQgaXMgdXBkYXRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7P3N0cmluZ30gY2FsbGVyTmFtZSBuYW1lIG9mIHRoZSBjYWxsaW5nIGZ1bmN0aW9uIGluIHRoZSBwdWJsaWMgQVBJLgogICAgICAgICAgICogQGludGVybmFsCiAgICAgICAgICAgKi8KICAgICAgICAgIGVucXVldWVSZXBsYWNlU3RhdGU6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlLCBjb21wbGV0ZVN0YXRlLCBjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgInJlcGxhY2VTdGF0ZSIpOwogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogU2V0cyBhIHN1YnNldCBvZiB0aGUgc3RhdGUuIFRoaXMgb25seSBleGlzdHMgYmVjYXVzZSBfcGVuZGluZ1N0YXRlIGlzCiAgICAgICAgICAgKiBpbnRlcm5hbC4gVGhpcyBwcm92aWRlcyBhIG1lcmdpbmcgc3RyYXRlZ3kgdGhhdCBpcyBub3QgYXZhaWxhYmxlIHRvIGRlZXAKICAgICAgICAgICAqIHByb3BlcnRpZXMgd2hpY2ggaXMgY29uZnVzaW5nLiBUT0RPOiBFeHBvc2UgcGVuZGluZ1N0YXRlIG9yIGRvbid0IHVzZSBpdAogICAgICAgICAgICogZHVyaW5nIHRoZSBtZXJnZS4KICAgICAgICAgICAqCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB0aGF0IHNob3VsZCByZXJlbmRlci4KICAgICAgICAgICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJ0aWFsU3RhdGUgTmV4dCBwYXJ0aWFsIHN0YXRlIHRvIGJlIG1lcmdlZCB3aXRoIHN0YXRlLgogICAgICAgICAgICogQHBhcmFtIHs/ZnVuY3Rpb259IGNhbGxiYWNrIENhbGxlZCBhZnRlciBjb21wb25lbnQgaXMgdXBkYXRlZC4KICAgICAgICAgICAqIEBwYXJhbSB7P3N0cmluZ30gTmFtZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBpbiB0aGUgcHVibGljIEFQSS4KICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICBlbnF1ZXVlU2V0U3RhdGU6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlLCBwYXJ0aWFsU3RhdGUsIGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIHdhcm5Ob29wKHB1YmxpY0luc3RhbmNlLCAic2V0U3RhdGUiKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBhc3NpZ24yID0gT2JqZWN0LmFzc2lnbjsKICAgICAgICB2YXIgZW1wdHlPYmplY3QgPSB7fTsKICAgICAgICB7CiAgICAgICAgICBPYmplY3QuZnJlZXplKGVtcHR5T2JqZWN0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gQ29tcG9uZW50KHByb3BzLCBjb250ZXh0LCB1cGRhdGVyKSB7CiAgICAgICAgICB0aGlzLnByb3BzID0gcHJvcHM7CiAgICAgICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgdGhpcy5yZWZzID0gZW1wdHlPYmplY3Q7CiAgICAgICAgICB0aGlzLnVwZGF0ZXIgPSB1cGRhdGVyIHx8IFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlOwogICAgICAgIH0KICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQgPSB7fTsKICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLnNldFN0YXRlID0gZnVuY3Rpb24ocGFydGlhbFN0YXRlLCBjYWxsYmFjaykgewogICAgICAgICAgaWYgKHR5cGVvZiBwYXJ0aWFsU3RhdGUgIT09ICJvYmplY3QiICYmIHR5cGVvZiBwYXJ0aWFsU3RhdGUgIT09ICJmdW5jdGlvbiIgJiYgcGFydGlhbFN0YXRlICE9IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzZXRTdGF0ZSguLi4pOiB0YWtlcyBhbiBvYmplY3Qgb2Ygc3RhdGUgdmFyaWFibGVzIHRvIHVwZGF0ZSBvciBhIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgYW4gb2JqZWN0IG9mIHN0YXRlIHZhcmlhYmxlcy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMudXBkYXRlci5lbnF1ZXVlU2V0U3RhdGUodGhpcywgcGFydGlhbFN0YXRlLCBjYWxsYmFjaywgInNldFN0YXRlIik7CiAgICAgICAgfTsKICAgICAgICBDb21wb25lbnQucHJvdG90eXBlLmZvcmNlVXBkYXRlID0gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIHRoaXMudXBkYXRlci5lbnF1ZXVlRm9yY2VVcGRhdGUodGhpcywgY2FsbGJhY2ssICJmb3JjZVVwZGF0ZSIpOwogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIGRlcHJlY2F0ZWRBUElzID0gewogICAgICAgICAgICBpc01vdW50ZWQ6IFsiaXNNb3VudGVkIiwgIkluc3RlYWQsIG1ha2Ugc3VyZSB0byBjbGVhbiB1cCBzdWJzY3JpcHRpb25zIGFuZCBwZW5kaW5nIHJlcXVlc3RzIGluIGNvbXBvbmVudFdpbGxVbm1vdW50IHRvIHByZXZlbnQgbWVtb3J5IGxlYWtzLiJdLAogICAgICAgICAgICByZXBsYWNlU3RhdGU6IFsicmVwbGFjZVN0YXRlIiwgIlJlZmFjdG9yIHlvdXIgY29kZSB0byB1c2Ugc2V0U3RhdGUgaW5zdGVhZCAoc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9yZWFjdC9pc3N1ZXMvMzIzNikuIl0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZGVmaW5lRGVwcmVjYXRpb25XYXJuaW5nID0gZnVuY3Rpb24obWV0aG9kTmFtZSwgaW5mbykgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoQ29tcG9uZW50LnByb3RvdHlwZSwgbWV0aG9kTmFtZSwgewogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB3YXJuMygiJXMoLi4uKSBpcyBkZXByZWNhdGVkIGluIHBsYWluIEphdmFTY3JpcHQgUmVhY3QgY2xhc3Nlcy4gJXMiLCBpbmZvWzBdLCBpbmZvWzFdKTsKICAgICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICBmb3IgKHZhciBmbk5hbWUgaW4gZGVwcmVjYXRlZEFQSXMpIHsKICAgICAgICAgICAgaWYgKGRlcHJlY2F0ZWRBUElzLmhhc093blByb3BlcnR5KGZuTmFtZSkpIHsKICAgICAgICAgICAgICBkZWZpbmVEZXByZWNhdGlvbldhcm5pbmcoZm5OYW1lLCBkZXByZWNhdGVkQVBJc1tmbk5hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBDb21wb25lbnREdW1teSgpIHsKICAgICAgICB9CiAgICAgICAgQ29tcG9uZW50RHVtbXkucHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICBmdW5jdGlvbiBQdXJlQ29tcG9uZW50Myhwcm9wcywgY29udGV4dCwgdXBkYXRlcikgewogICAgICAgICAgdGhpcy5wcm9wcyA9IHByb3BzOwogICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIHRoaXMucmVmcyA9IGVtcHR5T2JqZWN0OwogICAgICAgICAgdGhpcy51cGRhdGVyID0gdXBkYXRlciB8fCBSZWFjdE5vb3BVcGRhdGVRdWV1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIHB1cmVDb21wb25lbnRQcm90b3R5cGUgPSBQdXJlQ29tcG9uZW50My5wcm90b3R5cGUgPSBuZXcgQ29tcG9uZW50RHVtbXkoKTsKICAgICAgICBwdXJlQ29tcG9uZW50UHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUHVyZUNvbXBvbmVudDM7CiAgICAgICAgYXNzaWduMihwdXJlQ29tcG9uZW50UHJvdG90eXBlLCBDb21wb25lbnQucHJvdG90eXBlKTsKICAgICAgICBwdXJlQ29tcG9uZW50UHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50ID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSZWYoKSB7CiAgICAgICAgICB2YXIgcmVmT2JqZWN0ID0gewogICAgICAgICAgICBjdXJyZW50OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBPYmplY3Quc2VhbChyZWZPYmplY3QpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlZk9iamVjdDsKICAgICAgICB9CiAgICAgICAgdmFyIGlzQXJyYXlJbXBsID0gQXJyYXkuaXNBcnJheTsKICAgICAgICBmdW5jdGlvbiBpc0FycmF5MihhKSB7CiAgICAgICAgICByZXR1cm4gaXNBcnJheUltcGwoYSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHR5cGVOYW1lKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXNUb1N0cmluZ1RhZyA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgU3ltYm9sLnRvU3RyaW5nVGFnOwogICAgICAgICAgICB2YXIgdHlwZSA9IGhhc1RvU3RyaW5nVGFnICYmIHZhbHVlW1N5bWJvbC50b1N0cmluZ1RhZ10gfHwgdmFsdWUuY29uc3RydWN0b3IubmFtZSB8fCAiT2JqZWN0IjsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0tleVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGtleSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IG91dGVyVHlwZS5kaXNwbGF5TmFtZTsKICAgICAgICAgIGlmIChkaXNwbGF5TmFtZSkgewogICAgICAgICAgICByZXR1cm4gZGlzcGxheU5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUudGFnID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhbiB1bmV4cGVjdGVkIG9iamVjdCBpbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoKS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlBvcnRhbCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBnZXRXcmFwcGVkTmFtZSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZS5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3V0ZXJOYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0KHBheWxvYWQpKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICAgICAgdmFyIFJFU0VSVkVEX1BST1BTID0gewogICAgICAgICAga2V5OiB0cnVlLAogICAgICAgICAgcmVmOiB0cnVlLAogICAgICAgICAgX19zZWxmOiB0cnVlLAogICAgICAgICAgX19zb3VyY2U6IHRydWUKICAgICAgICB9OwogICAgICAgIHZhciBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93biwgc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24sIGRpZFdhcm5BYm91dFN0cmluZ1JlZnM7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNWYWxpZFJlZihjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCAicmVmIikpIHsKICAgICAgICAgICAgICB2YXIgZ2V0dGVyID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjb25maWcsICJyZWYiKS5nZXQ7CiAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb25maWcucmVmICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkS2V5KGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJrZXkiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgImtleSIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5rZXkgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nS2V5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGBrZXlgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nS2V5LmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgImtleSIsIHsKICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdLZXksCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgICAgdmFyIHdhcm5BYm91dEFjY2Vzc2luZ1JlZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93bikgewogICAgICAgICAgICAgICAgc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBgcmVmYCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGJlaW5nIHJldHVybmVkLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNhbWUgdmFsdWUgd2l0aGluIHRoZSBjaGlsZCBjb21wb25lbnQsIHlvdSBzaG91bGQgcGFzcyBpdCBhcyBhIGRpZmZlcmVudCBwcm9wLiAoaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NwZWNpYWwtcHJvcHMpIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5BYm91dEFjY2Vzc2luZ1JlZi5pc1JlYWN0V2FybmluZyA9IHRydWU7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICJyZWYiLCB7CiAgICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nUmVmLAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY29uZmlnLnJlZiA9PT0gInN0cmluZyIgJiYgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCAmJiBjb25maWcuX19zZWxmICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQuc3RhdGVOb2RlICE9PSBjb25maWcuX19zZWxmKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCdDb21wb25lbnQgIiVzIiBjb250YWlucyB0aGUgc3RyaW5nIHJlZiAiJXMiLiBTdXBwb3J0IGZvciBzdHJpbmcgcmVmcyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gVGhpcyBjYXNlIGNhbm5vdCBiZSBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBhbiBhcnJvdyBmdW5jdGlvbi4gV2UgYXNrIHlvdSB0byBtYW51YWxseSBmaXggdGhpcyBjYXNlIGJ5IHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBjb21wb25lbnROYW1lLCBjb25maWcucmVmKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RFbGVtZW50ID0gZnVuY3Rpb24odHlwZSwga2V5LCByZWYsIHNlbGYyLCBzb3VyY2UsIG93bmVyLCBwcm9wcykgewogICAgICAgICAgdmFyIGVsZW1lbnQgPSB7CiAgICAgICAgICAgIC8vIFRoaXMgdGFnIGFsbG93cyB1cyB0byB1bmlxdWVseSBpZGVudGlmeSB0aGlzIGFzIGEgUmVhY3QgRWxlbWVudAogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfRUxFTUVOVF9UWVBFLAogICAgICAgICAgICAvLyBCdWlsdC1pbiBwcm9wZXJ0aWVzIHRoYXQgYmVsb25nIG9uIHRoZSBlbGVtZW50CiAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgIGtleSwKICAgICAgICAgICAgcmVmLAogICAgICAgICAgICBwcm9wcywKICAgICAgICAgICAgLy8gUmVjb3JkIHRoZSBjb21wb25lbnQgcmVzcG9uc2libGUgZm9yIGNyZWF0aW5nIHRoaXMgZWxlbWVudC4KICAgICAgICAgICAgX293bmVyOiBvd25lcgogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgZWxlbWVudC5fc3RvcmUgPSB7fTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQuX3N0b3JlLCAidmFsaWRhdGVkIiwgewogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgICAgICAgdmFsdWU6IGZhbHNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudCwgIl9zZWxmIiwgewogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHZhbHVlOiBzZWxmMgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQsICJfc291cmNlIiwgewogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgd3JpdGFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHZhbHVlOiBzb3VyY2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChPYmplY3QuZnJlZXplKSB7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50LnByb3BzKTsKICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQzOSh0eXBlLCBjb25maWcsIGNoaWxkcmVuKSB7CiAgICAgICAgICB2YXIgcHJvcE5hbWU7CiAgICAgICAgICB2YXIgcHJvcHMgPSB7fTsKICAgICAgICAgIHZhciBrZXkgPSBudWxsOwogICAgICAgICAgdmFyIHJlZiA9IG51bGw7CiAgICAgICAgICB2YXIgc2VsZjIgPSBudWxsOwogICAgICAgICAgdmFyIHNvdXJjZSA9IG51bGw7CiAgICAgICAgICBpZiAoY29uZmlnICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKGhhc1ZhbGlkUmVmKGNvbmZpZykpIHsKICAgICAgICAgICAgICByZWYgPSBjb25maWcucmVmOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdhcm5JZlN0cmluZ1JlZkNhbm5vdEJlQXV0b0NvbnZlcnRlZChjb25maWcpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaGFzVmFsaWRLZXkoY29uZmlnKSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oY29uZmlnLmtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGtleSA9ICIiICsgY29uZmlnLmtleTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmMiA9IGNvbmZpZy5fX3NlbGYgPT09IHZvaWQgMCA/IG51bGwgOiBjb25maWcuX19zZWxmOwogICAgICAgICAgICBzb3VyY2UgPSBjb25maWcuX19zb3VyY2UgPT09IHZvaWQgMCA/IG51bGwgOiBjb25maWcuX19zb3VyY2U7CiAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gY29uZmlnKSB7CiAgICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCBwcm9wTmFtZSkgJiYgIVJFU0VSVkVEX1BST1BTLmhhc093blByb3BlcnR5KHByb3BOYW1lKSkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gY29uZmlnW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZHJlbkxlbmd0aCA9IGFyZ3VtZW50cy5sZW5ndGggLSAyOwogICAgICAgICAgaWYgKGNoaWxkcmVuTGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRyZW47CiAgICAgICAgICB9IGVsc2UgaWYgKGNoaWxkcmVuTGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgY2hpbGRBcnJheSA9IEFycmF5KGNoaWxkcmVuTGVuZ3RoKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbkxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgY2hpbGRBcnJheVtpXSA9IGFyZ3VtZW50c1tpICsgMl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChPYmplY3QuZnJlZXplKSB7CiAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGNoaWxkQXJyYXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkQXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSAmJiB0eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzID0gdHlwZS5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBkZWZhdWx0UHJvcHNbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoa2V5IHx8IHJlZikgewogICAgICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iID8gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgIlVua25vd24iIDogdHlwZTsKICAgICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgICBkZWZpbmVLZXlQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVmKSB7CiAgICAgICAgICAgICAgICBkZWZpbmVSZWZQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIFJlYWN0RWxlbWVudCh0eXBlLCBrZXksIHJlZiwgc2VsZjIsIHNvdXJjZSwgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCwgcHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbG9uZUFuZFJlcGxhY2VLZXkob2xkRWxlbWVudCwgbmV3S2V5KSB7CiAgICAgICAgICB2YXIgbmV3RWxlbWVudCA9IFJlYWN0RWxlbWVudChvbGRFbGVtZW50LnR5cGUsIG5ld0tleSwgb2xkRWxlbWVudC5yZWYsIG9sZEVsZW1lbnQuX3NlbGYsIG9sZEVsZW1lbnQuX3NvdXJjZSwgb2xkRWxlbWVudC5fb3duZXIsIG9sZEVsZW1lbnQucHJvcHMpOwogICAgICAgICAgcmV0dXJuIG5ld0VsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsb25lRWxlbWVudDgoZWxlbWVudCwgY29uZmlnLCBjaGlsZHJlbikgewogICAgICAgICAgaWYgKGVsZW1lbnQgPT09IG51bGwgfHwgZWxlbWVudCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVhY3QuY2xvbmVFbGVtZW50KC4uLik6IFRoZSBhcmd1bWVudCBtdXN0IGJlIGEgUmVhY3QgZWxlbWVudCwgYnV0IHlvdSBwYXNzZWQgIiArIGVsZW1lbnQgKyAiLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb3BOYW1lOwogICAgICAgICAgdmFyIHByb3BzID0gYXNzaWduMih7fSwgZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICB2YXIga2V5ID0gZWxlbWVudC5rZXk7CiAgICAgICAgICB2YXIgcmVmID0gZWxlbWVudC5yZWY7CiAgICAgICAgICB2YXIgc2VsZjIgPSBlbGVtZW50Ll9zZWxmOwogICAgICAgICAgdmFyIHNvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgaWYgKGNvbmZpZyAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgICBvd25lciA9IFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkS2V5KGNvbmZpZykpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGNvbmZpZy5rZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIGNvbmZpZy5rZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wczsKICAgICAgICAgICAgaWYgKGVsZW1lbnQudHlwZSAmJiBlbGVtZW50LnR5cGUuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgZGVmYXVsdFByb3BzID0gZWxlbWVudC50eXBlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGNvbmZpZykgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgcHJvcE5hbWUpICYmICFSRVNFUlZFRF9QUk9QUy5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgIGlmIChjb25maWdbcHJvcE5hbWVdID09PSB2b2lkIDAgJiYgZGVmYXVsdFByb3BzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGNvbmZpZ1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGRyZW5MZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoIC0gMjsKICAgICAgICAgIGlmIChjaGlsZHJlbkxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICAgICAgfSBlbHNlIGlmIChjaGlsZHJlbkxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdmFyIGNoaWxkQXJyYXkgPSBBcnJheShjaGlsZHJlbkxlbmd0aCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW5MZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNoaWxkQXJyYXlbaV0gPSBhcmd1bWVudHNbaSArIDJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb3BzLmNoaWxkcmVuID0gY2hpbGRBcnJheTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQoZWxlbWVudC50eXBlLCBrZXksIHJlZiwgc2VsZjIsIHNvdXJjZSwgb3duZXIsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnQxNShvYmplY3QpIHsKICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAib2JqZWN0IiAmJiBvYmplY3QgIT09IG51bGwgJiYgb2JqZWN0LiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICAgICAgfQogICAgICAgIHZhciBTRVBBUkFUT1IgPSAiLiI7CiAgICAgICAgdmFyIFNVQlNFUEFSQVRPUiA9ICI6IjsKICAgICAgICBmdW5jdGlvbiBlc2NhcGUoa2V5KSB7CiAgICAgICAgICB2YXIgZXNjYXBlUmVnZXggPSAvWz06XS9nOwogICAgICAgICAgdmFyIGVzY2FwZXJMb29rdXAgPSB7CiAgICAgICAgICAgICI9IjogIj0wIiwKICAgICAgICAgICAgIjoiOiAiPTIiCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGVzY2FwZWRTdHJpbmcgPSBrZXkucmVwbGFjZShlc2NhcGVSZWdleCwgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgICAgICAgcmV0dXJuIGVzY2FwZXJMb29rdXBbbWF0Y2hdOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gIiQiICsgZXNjYXBlZFN0cmluZzsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHMgPSBmYWxzZTsKICAgICAgICB2YXIgdXNlclByb3ZpZGVkS2V5RXNjYXBlUmVnZXggPSAvXC8rL2c7CiAgICAgICAgZnVuY3Rpb24gZXNjYXBlVXNlclByb3ZpZGVkS2V5KHRleHQpIHsKICAgICAgICAgIHJldHVybiB0ZXh0LnJlcGxhY2UodXNlclByb3ZpZGVkS2V5RXNjYXBlUmVnZXgsICIkJi8iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RWxlbWVudEtleShlbGVtZW50LCBpbmRleCkgewogICAgICAgICAgaWYgKHR5cGVvZiBlbGVtZW50ID09PSAib2JqZWN0IiAmJiBlbGVtZW50ICE9PSBudWxsICYmIGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oZWxlbWVudC5rZXkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBlc2NhcGUoIiIgKyBlbGVtZW50LmtleSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5kZXgudG9TdHJpbmcoMzYpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXBJbnRvQXJyYXkoY2hpbGRyZW4sIGFycmF5LCBlc2NhcGVkUHJlZml4LCBuYW1lU29GYXIsIGNhbGxiYWNrKSB7CiAgICAgICAgICB2YXIgdHlwZSA9IHR5cGVvZiBjaGlsZHJlbjsKICAgICAgICAgIGlmICh0eXBlID09PSAidW5kZWZpbmVkIiB8fCB0eXBlID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgY2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGludm9rZUNhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgICBpZiAoY2hpbGRyZW4gPT09IG51bGwpIHsKICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICAgIHN3aXRjaCAoY2hpbGRyZW4uJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgaW52b2tlQ2FsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW52b2tlQ2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIF9jaGlsZCA9IGNoaWxkcmVuOwogICAgICAgICAgICB2YXIgbWFwcGVkQ2hpbGQgPSBjYWxsYmFjayhfY2hpbGQpOwogICAgICAgICAgICB2YXIgY2hpbGRLZXkgPSBuYW1lU29GYXIgPT09ICIiID8gU0VQQVJBVE9SICsgZ2V0RWxlbWVudEtleShfY2hpbGQsIDApIDogbmFtZVNvRmFyOwogICAgICAgICAgICBpZiAoaXNBcnJheTIobWFwcGVkQ2hpbGQpKSB7CiAgICAgICAgICAgICAgdmFyIGVzY2FwZWRDaGlsZEtleSA9ICIiOwogICAgICAgICAgICAgIGlmIChjaGlsZEtleSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlc2NhcGVkQ2hpbGRLZXkgPSBlc2NhcGVVc2VyUHJvdmlkZWRLZXkoY2hpbGRLZXkpICsgIi8iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBtYXBJbnRvQXJyYXkobWFwcGVkQ2hpbGQsIGFycmF5LCBlc2NhcGVkQ2hpbGRLZXksICIiLCBmdW5jdGlvbihjKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYzsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIGlmIChtYXBwZWRDaGlsZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50MTUobWFwcGVkQ2hpbGQpKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChtYXBwZWRDaGlsZC5rZXkgJiYgKCFfY2hpbGQgfHwgX2NoaWxkLmtleSAhPT0gbWFwcGVkQ2hpbGQua2V5KSkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24obWFwcGVkQ2hpbGQua2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbWFwcGVkQ2hpbGQgPSBjbG9uZUFuZFJlcGxhY2VLZXkoCiAgICAgICAgICAgICAgICAgIG1hcHBlZENoaWxkLAogICAgICAgICAgICAgICAgICAvLyBLZWVwIGJvdGggdGhlIChtYXBwZWQpIGFuZCBvbGQga2V5cyBpZiB0aGV5IGRpZmZlciwganVzdCBhcwogICAgICAgICAgICAgICAgICAvLyB0cmF2ZXJzZUFsbENoaWxkcmVuIHVzZWQgdG8gZG8gZm9yIG9iamVjdHMgYXMgY2hpbGRyZW4KICAgICAgICAgICAgICAgICAgZXNjYXBlZFByZWZpeCArIC8vICRGbG93Rml4TWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgUmVhY3QuUG9ydGFsIGRvZXNuJ3QgaGF2ZSBhIGtleQogICAgICAgICAgICAgICAgICAobWFwcGVkQ2hpbGQua2V5ICYmICghX2NoaWxkIHx8IF9jaGlsZC5rZXkgIT09IG1hcHBlZENoaWxkLmtleSkgPyAoCiAgICAgICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSBGbG93IGluY29ycmVjdGx5IHRoaW5rcyBleGlzdGluZyBlbGVtZW50J3Mga2V5IGNhbiBiZSBhIG51bWJlcgogICAgICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC1pbnRlcm5hbC9zYWZlLXN0cmluZy1jb2VyY2lvbgogICAgICAgICAgICAgICAgICAgIGVzY2FwZVVzZXJQcm92aWRlZEtleSgiIiArIG1hcHBlZENoaWxkLmtleSkgKyAiLyIKICAgICAgICAgICAgICAgICAgKSA6ICIiKSArIGNoaWxkS2V5CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhcnJheS5wdXNoKG1hcHBlZENoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZDsKICAgICAgICAgIHZhciBuZXh0TmFtZTsKICAgICAgICAgIHZhciBzdWJ0cmVlQ291bnQgPSAwOwogICAgICAgICAgdmFyIG5leHROYW1lUHJlZml4ID0gbmFtZVNvRmFyID09PSAiIiA/IFNFUEFSQVRPUiA6IG5hbWVTb0ZhciArIFNVQlNFUEFSQVRPUjsKICAgICAgICAgIGlmIChpc0FycmF5MihjaGlsZHJlbikpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICAgICAgICAgICAgbmV4dE5hbWUgPSBuZXh0TmFtZVByZWZpeCArIGdldEVsZW1lbnRLZXkoY2hpbGQsIGkpOwogICAgICAgICAgICAgIHN1YnRyZWVDb3VudCArPSBtYXBJbnRvQXJyYXkoY2hpbGQsIGFycmF5LCBlc2NhcGVkUHJlZml4LCBuZXh0TmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4oY2hpbGRyZW4pOwogICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgaXRlcmFibGVDaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChpdGVyYXRvckZuID09PSBpdGVyYWJsZUNoaWxkcmVuLmVudHJpZXMpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNYXBzKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybjMoIlVzaW5nIE1hcHMgYXMgY2hpbGRyZW4gaXMgbm90IHN1cHBvcnRlZC4gVXNlIGFuIGFycmF5IG9mIGtleWVkIFJlYWN0RWxlbWVudHMgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNYXBzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKGl0ZXJhYmxlQ2hpbGRyZW4pOwogICAgICAgICAgICAgIHZhciBzdGVwOwogICAgICAgICAgICAgIHZhciBpaSA9IDA7CiAgICAgICAgICAgICAgd2hpbGUgKCEoc3RlcCA9IGl0ZXJhdG9yLm5leHQoKSkuZG9uZSkgewogICAgICAgICAgICAgICAgY2hpbGQgPSBzdGVwLnZhbHVlOwogICAgICAgICAgICAgICAgbmV4dE5hbWUgPSBuZXh0TmFtZVByZWZpeCArIGdldEVsZW1lbnRLZXkoY2hpbGQsIGlpKyspOwogICAgICAgICAgICAgICAgc3VidHJlZUNvdW50ICs9IG1hcEludG9BcnJheShjaGlsZCwgYXJyYXksIGVzY2FwZWRQcmVmaXgsIG5leHROYW1lLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkcmVuU3RyaW5nID0gU3RyaW5nKGNoaWxkcmVuKTsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9iamVjdHMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkIChmb3VuZDogIiArIChjaGlsZHJlblN0cmluZyA9PT0gIltvYmplY3QgT2JqZWN0XSIgPyAib2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKGNoaWxkcmVuKS5qb2luKCIsICIpICsgIn0iIDogY2hpbGRyZW5TdHJpbmcpICsgIikuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBjb2xsZWN0aW9uIG9mIGNoaWxkcmVuLCB1c2UgYW4gYXJyYXkgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN1YnRyZWVDb3VudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmMsIGNvbnRleHQpIHsKICAgICAgICAgIGlmIChjaGlsZHJlbiA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgICAgIHZhciBjb3VudCA9IDA7CiAgICAgICAgICBtYXBJbnRvQXJyYXkoY2hpbGRyZW4sIHJlc3VsdCwgIiIsICIiLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICByZXR1cm4gZnVuYy5jYWxsKGNvbnRleHQsIGNoaWxkLCBjb3VudCsrKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY291bnRDaGlsZHJlbihjaGlsZHJlbikgewogICAgICAgICAgdmFyIG4gPSAwOwogICAgICAgICAgbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBuKys7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmb3JFYWNoQ2hpbGRyZW4oY2hpbGRyZW4sIGZvckVhY2hGdW5jLCBmb3JFYWNoQ29udGV4dCkgewogICAgICAgICAgbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmb3JFYWNoRnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgfSwgZm9yRWFjaENvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0b0FycmF5KGNoaWxkcmVuKSB7CiAgICAgICAgICByZXR1cm4gbWFwQ2hpbGRyZW4oY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgIH0pIHx8IFtdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvbmx5Q2hpbGQoY2hpbGRyZW4pIHsKICAgICAgICAgIGlmICghaXNWYWxpZEVsZW1lbnQxNShjaGlsZHJlbikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdC5DaGlsZHJlbi5vbmx5IGV4cGVjdGVkIHRvIHJlY2VpdmUgYSBzaW5nbGUgUmVhY3QgZWxlbWVudCBjaGlsZC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ29udGV4dDEyKGRlZmF1bHRWYWx1ZSkgewogICAgICAgICAgdmFyIGNvbnRleHQgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9DT05URVhUX1RZUEUsCiAgICAgICAgICAgIC8vIEFzIGEgd29ya2Fyb3VuZCB0byBzdXBwb3J0IG11bHRpcGxlIGNvbmN1cnJlbnQgcmVuZGVyZXJzLCB3ZSBjYXRlZ29yaXplCiAgICAgICAgICAgIC8vIHNvbWUgcmVuZGVyZXJzIGFzIHByaW1hcnkgYW5kIG90aGVycyBhcyBzZWNvbmRhcnkuIFdlIG9ubHkgZXhwZWN0CiAgICAgICAgICAgIC8vIHRoZXJlIHRvIGJlIHR3byBjb25jdXJyZW50IHJlbmRlcmVycyBhdCBtb3N0OiBSZWFjdCBOYXRpdmUgKHByaW1hcnkpIGFuZAogICAgICAgICAgICAvLyBGYWJyaWMgKHNlY29uZGFyeSk7IFJlYWN0IERPTSAocHJpbWFyeSkgYW5kIFJlYWN0IEFSVCAoc2Vjb25kYXJ5KS4KICAgICAgICAgICAgLy8gU2Vjb25kYXJ5IHJlbmRlcmVycyBzdG9yZSB0aGVpciBjb250ZXh0IHZhbHVlcyBvbiBzZXBhcmF0ZSBmaWVsZHMuCiAgICAgICAgICAgIF9jdXJyZW50VmFsdWU6IGRlZmF1bHRWYWx1ZSwKICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTI6IGRlZmF1bHRWYWx1ZSwKICAgICAgICAgICAgLy8gVXNlZCB0byB0cmFjayBob3cgbWFueSBjb25jdXJyZW50IHJlbmRlcmVycyB0aGlzIGNvbnRleHQgY3VycmVudGx5CiAgICAgICAgICAgIC8vIHN1cHBvcnRzIHdpdGhpbiBpbiBhIHNpbmdsZSByZW5kZXJlci4gU3VjaCBhcyBwYXJhbGxlbCBzZXJ2ZXIgcmVuZGVyaW5nLgogICAgICAgICAgICBfdGhyZWFkQ291bnQ6IDAsCiAgICAgICAgICAgIC8vIFRoZXNlIGFyZSBjaXJjdWxhcgogICAgICAgICAgICBQcm92aWRlcjogbnVsbCwKICAgICAgICAgICAgQ29uc3VtZXI6IG51bGwsCiAgICAgICAgICAgIC8vIEFkZCB0aGVzZSB0byB1c2Ugc2FtZSBoaWRkZW4gY2xhc3MgaW4gVk0gYXMgU2VydmVyQ29udGV4dAogICAgICAgICAgICBfZGVmYXVsdFZhbHVlOiBudWxsLAogICAgICAgICAgICBfZ2xvYmFsTmFtZTogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGNvbnRleHQuUHJvdmlkZXIgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9QUk9WSURFUl9UWVBFLAogICAgICAgICAgICBfY29udGV4dDogY29udGV4dAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycyA9IGZhbHNlOwogICAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXREaXNwbGF5TmFtZU9uQ29uc3VtZXIgPSBmYWxzZTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIENvbnN1bWVyID0gewogICAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9DT05URVhUX1RZUEUsCiAgICAgICAgICAgICAgX2NvbnRleHQ6IGNvbnRleHQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoQ29uc3VtZXIsIHsKICAgICAgICAgICAgICBQcm92aWRlcjogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nQ29uc3VtZXJQcm92aWRlcikgewogICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyaW5nIDxDb250ZXh0LkNvbnN1bWVyLlByb3ZpZGVyPiBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIHJlbmRlciA8Q29udGV4dC5Qcm92aWRlcj4gaW5zdGVhZD8iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5Qcm92aWRlcjsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9Qcm92aWRlcikgewogICAgICAgICAgICAgICAgICBjb250ZXh0LlByb3ZpZGVyID0gX1Byb3ZpZGVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuX2N1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9jdXJyZW50VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlID0gX2N1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIF9jdXJyZW50VmFsdWUyOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5fY3VycmVudFZhbHVlMjsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKF9jdXJyZW50VmFsdWUyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZTIgPSBfY3VycmVudFZhbHVlMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIF90aHJlYWRDb3VudDogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuX3RocmVhZENvdW50OwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX3RocmVhZENvdW50KSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuX3RocmVhZENvdW50ID0gX3RocmVhZENvdW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgQ29uc3VtZXI6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ05lc3RlZENvbnRleHRDb25zdW1lcnMpIHsKICAgICAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlbmRlcmluZyA8Q29udGV4dC5Db25zdW1lci5Db25zdW1lcj4gaXMgbm90IHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIERpZCB5b3UgbWVhbiB0byByZW5kZXIgPENvbnRleHQuQ29uc3VtZXI+IGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuQ29uc3VtZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBkaXNwbGF5TmFtZTogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuZGlzcGxheU5hbWU7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihkaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0RGlzcGxheU5hbWVPbkNvbnN1bWVyKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybjMoIlNldHRpbmcgYGRpc3BsYXlOYW1lYCBvbiBDb250ZXh0LkNvbnN1bWVyIGhhcyBubyBlZmZlY3QuIFlvdSBzaG91bGQgc2V0IGl0IGRpcmVjdGx5IG9uIHRoZSBjb250ZXh0IHdpdGggQ29udGV4dC5kaXNwbGF5TmFtZSA9ICclcycuIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0RGlzcGxheU5hbWVPbkNvbnN1bWVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnRleHQuQ29uc3VtZXIgPSBDb25zdW1lcjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFJlbmRlcmVyID0gbnVsbDsKICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFJlbmRlcmVyMiA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICB9CiAgICAgICAgdmFyIFVuaW5pdGlhbGl6ZWQgPSAtMTsKICAgICAgICB2YXIgUGVuZGluZyA9IDA7CiAgICAgICAgdmFyIFJlc29sdmVkID0gMTsKICAgICAgICB2YXIgUmVqZWN0ZWQgPSAyOwogICAgICAgIGZ1bmN0aW9uIGxhenlJbml0aWFsaXplcihwYXlsb2FkKSB7CiAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgIHZhciBjdG9yID0gcGF5bG9hZC5fcmVzdWx0OwogICAgICAgICAgICB2YXIgdGhlbmFibGUgPSBjdG9yKCk7CiAgICAgICAgICAgIHRoZW5hYmxlLnRoZW4oZnVuY3Rpb24obW9kdWxlT2JqZWN0MikgewogICAgICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFBlbmRpbmcgfHwgcGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWQgPSBwYXlsb2FkOwogICAgICAgICAgICAgICAgcmVzb2x2ZWQuX3N0YXR1cyA9IFJlc29sdmVkOwogICAgICAgICAgICAgICAgcmVzb2x2ZWQuX3Jlc3VsdCA9IG1vZHVsZU9iamVjdDI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCBmdW5jdGlvbihlcnJvcjIpIHsKICAgICAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBQZW5kaW5nIHx8IHBheWxvYWQuX3N0YXR1cyA9PT0gVW5pbml0aWFsaXplZCkgewogICAgICAgICAgICAgICAgdmFyIHJlamVjdGVkID0gcGF5bG9hZDsKICAgICAgICAgICAgICAgIHJlamVjdGVkLl9zdGF0dXMgPSBSZWplY3RlZDsKICAgICAgICAgICAgICAgIHJlamVjdGVkLl9yZXN1bHQgPSBlcnJvcjI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gVW5pbml0aWFsaXplZCkgewogICAgICAgICAgICAgIHZhciBwZW5kaW5nID0gcGF5bG9hZDsKICAgICAgICAgICAgICBwZW5kaW5nLl9zdGF0dXMgPSBQZW5kaW5nOwogICAgICAgICAgICAgIHBlbmRpbmcuX3Jlc3VsdCA9IHRoZW5hYmxlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBSZXNvbHZlZCkgewogICAgICAgICAgICB2YXIgbW9kdWxlT2JqZWN0ID0gcGF5bG9hZC5fcmVzdWx0OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKG1vZHVsZU9iamVjdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBlcnJvcigibGF6eTogRXhwZWN0ZWQgdGhlIHJlc3VsdCBvZiBhIGR5bmFtaWMgaW1wb3J0KCkgY2FsbC4gSW5zdGVhZCByZWNlaXZlZDogJXNcblxuWW91ciBjb2RlIHNob3VsZCBsb29rIGxpa2U6IFxuICBjb25zdCBNeUNvbXBvbmVudCA9IGxhenkoKCkgPT4gaW1wb3J0KCcuL015Q29tcG9uZW50JykpXG5cbkRpZCB5b3UgYWNjaWRlbnRhbGx5IHB1dCBjdXJseSBicmFjZXMgYXJvdW5kIHRoZSBpbXBvcnQ/IiwgbW9kdWxlT2JqZWN0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghKCJkZWZhdWx0IiBpbiBtb2R1bGVPYmplY3QpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigibGF6eTogRXhwZWN0ZWQgdGhlIHJlc3VsdCBvZiBhIGR5bmFtaWMgaW1wb3J0KCkgY2FsbC4gSW5zdGVhZCByZWNlaXZlZDogJXNcblxuWW91ciBjb2RlIHNob3VsZCBsb29rIGxpa2U6IFxuICBjb25zdCBNeUNvbXBvbmVudCA9IGxhenkoKCkgPT4gaW1wb3J0KCcuL015Q29tcG9uZW50JykpIiwgbW9kdWxlT2JqZWN0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1vZHVsZU9iamVjdC5kZWZhdWx0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgcGF5bG9hZC5fcmVzdWx0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsYXp5KGN0b3IpIHsKICAgICAgICAgIHZhciBwYXlsb2FkID0gewogICAgICAgICAgICAvLyBXZSB1c2UgdGhlc2UgZmllbGRzIHRvIHN0b3JlIHRoZSByZXN1bHQuCiAgICAgICAgICAgIF9zdGF0dXM6IFVuaW5pdGlhbGl6ZWQsCiAgICAgICAgICAgIF9yZXN1bHQ6IGN0b3IKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgbGF6eVR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9MQVpZX1RZUEUsCiAgICAgICAgICAgIF9wYXlsb2FkOiBwYXlsb2FkLAogICAgICAgICAgICBfaW5pdDogbGF6eUluaXRpYWxpemVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzOwogICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhsYXp5VHlwZSwgewogICAgICAgICAgICAgIGRlZmF1bHRQcm9wczogewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRQcm9wczsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5ld0RlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QubGF6eSguLi4pOiBJdCBpcyBub3Qgc3VwcG9ydGVkIHRvIGFzc2lnbiBgZGVmYXVsdFByb3BzYCB0byBhIGxhenkgY29tcG9uZW50IGltcG9ydC4gRWl0aGVyIHNwZWNpZnkgdGhlbSB3aGVyZSB0aGUgY29tcG9uZW50IGlzIGRlZmluZWQsIG9yIGNyZWF0ZSBhIHdyYXBwaW5nIGNvbXBvbmVudCBhcm91bmQgaXQuIik7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHRQcm9wcyA9IG5ld0RlZmF1bHRQcm9wczsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGxhenlUeXBlLCAiZGVmYXVsdFByb3BzIiwgewogICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBwcm9wVHlwZXM6IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBwcm9wVHlwZXM7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuZXdQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0LmxhenkoLi4uKTogSXQgaXMgbm90IHN1cHBvcnRlZCB0byBhc3NpZ24gYHByb3BUeXBlc2AgdG8gYSBsYXp5IGNvbXBvbmVudCBpbXBvcnQuIEVpdGhlciBzcGVjaWZ5IHRoZW0gd2hlcmUgdGhlIGNvbXBvbmVudCBpcyBkZWZpbmVkLCBvciBjcmVhdGUgYSB3cmFwcGluZyBjb21wb25lbnQgYXJvdW5kIGl0LiIpOwogICAgICAgICAgICAgICAgICBwcm9wVHlwZXMgPSBuZXdQcm9wVHlwZXM7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShsYXp5VHlwZSwgInByb3BUeXBlcyIsIHsKICAgICAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGF6eVR5cGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcndhcmRSZWYxNShyZW5kZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlbmRlciAhPSBudWxsICYmIHJlbmRlci4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFMikgewogICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlcXVpcmVzIGEgcmVuZGVyIGZ1bmN0aW9uIGJ1dCByZWNlaXZlZCBhIGBtZW1vYCBjb21wb25lbnQuIEluc3RlYWQgb2YgZm9yd2FyZFJlZihtZW1vKC4uLikpLCB1c2UgbWVtbyhmb3J3YXJkUmVmKC4uLikpLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiByZW5kZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZXF1aXJlcyBhIHJlbmRlciBmdW5jdGlvbiBidXQgd2FzIGdpdmVuICVzLiIsIHJlbmRlciA9PT0gbnVsbCA/ICJudWxsIiA6IHR5cGVvZiByZW5kZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChyZW5kZXIubGVuZ3RoICE9PSAwICYmIHJlbmRlci5sZW5ndGggIT09IDIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlbmRlciBmdW5jdGlvbnMgYWNjZXB0IGV4YWN0bHkgdHdvIHBhcmFtZXRlcnM6IHByb3BzIGFuZCByZWYuICVzIiwgcmVuZGVyLmxlbmd0aCA9PT0gMSA/ICJEaWQgeW91IGZvcmdldCB0byB1c2UgdGhlIHJlZiBwYXJhbWV0ZXI/IiA6ICJBbnkgYWRkaXRpb25hbCBwYXJhbWV0ZXIgd2lsbCBiZSB1bmRlZmluZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZW5kZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChyZW5kZXIuZGVmYXVsdFByb3BzICE9IG51bGwgfHwgcmVuZGVyLnByb3BUeXBlcyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiZm9yd2FyZFJlZiByZW5kZXIgZnVuY3Rpb25zIGRvIG5vdCBzdXBwb3J0IHByb3BUeXBlcyBvciBkZWZhdWx0UHJvcHMuIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgYSBSZWFjdCBjb21wb25lbnQ/Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiwKICAgICAgICAgICAgcmVuZGVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgb3duTmFtZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnRUeXBlLCAiZGlzcGxheU5hbWUiLCB7CiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb3duTmFtZTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgICAgb3duTmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBpZiAoIXJlbmRlci5uYW1lICYmICFyZW5kZXIuZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyLmRpc3BsYXlOYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRUeXBlOwogICAgICAgIH0KICAgICAgICB2YXIgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRTsKICAgICAgICB7CiAgICAgICAgICBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFID0gU3ltYm9sLmZvcigicmVhY3QubW9kdWxlLnJlZmVyZW5jZSIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIiB8fCB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1BST0ZJTEVSX1RZUEUgfHwgZW5hYmxlRGVidWdUcmFjaW5nIHx8IHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfU1VTUEVOU0VfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgfHwgZW5hYmxlTGVnYWN5SGlkZGVuIHx8IHR5cGUgPT09IFJFQUNUX09GRlNDUkVFTl9UWVBFIHx8IGVuYWJsZVNjb3BlQVBJIHx8IGVuYWJsZUNhY2hlRWxlbWVudCB8fCBlbmFibGVUcmFuc2l0aW9uVHJhY2luZykgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRTIgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfUFJPVklERVJfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9DT05URVhUX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIgfHwgLy8gVGhpcyBuZWVkcyB0byBpbmNsdWRlIGFsbCBwb3NzaWJsZSBtb2R1bGUgcmVmZXJlbmNlIG9iamVjdAogICAgICAgICAgICAvLyB0eXBlcyBzdXBwb3J0ZWQgYnkgYW55IEZsaWdodCBjb25maWd1cmF0aW9uIGFueXdoZXJlIHNpbmNlCiAgICAgICAgICAgIC8vIHdlIGRvbid0IGtub3cgd2hpY2ggRmxpZ2h0IGJ1aWxkIHRoaXMgd2lsbCBlbmQgdXAgYmVpbmcgdXNlZAogICAgICAgICAgICAvLyB3aXRoLgogICAgICAgICAgICB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFIHx8IHR5cGUuZ2V0TW9kdWxlSWQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1lbW83KHR5cGUsIGNvbXBhcmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSkpIHsKICAgICAgICAgICAgICBlcnJvcigibWVtbzogVGhlIGZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBjb21wb25lbnQuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzIiwgdHlwZSA9PT0gbnVsbCA/ICJudWxsIiA6IHR5cGVvZiB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gewogICAgICAgICAgICAkJHR5cGVvZjogUkVBQ1RfTUVNT19UWVBFMiwKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAgY29tcGFyZTogY29tcGFyZSA9PT0gdm9pZCAwID8gbnVsbCA6IGNvbXBhcmUKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25OYW1lOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudFR5cGUsICJkaXNwbGF5TmFtZSIsIHsKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvd25OYW1lOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICBvd25OYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIGlmICghdHlwZS5uYW1lICYmICF0eXBlLmRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgIHR5cGUuZGlzcGxheU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudFR5cGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVEaXNwYXRjaGVyKCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaXNwYXRjaGVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgaG9vayBjYWxsLiBIb29rcyBjYW4gb25seSBiZSBjYWxsZWQgaW5zaWRlIG9mIHRoZSBib2R5IG9mIGEgZnVuY3Rpb24gY29tcG9uZW50LiBUaGlzIGNvdWxkIGhhcHBlbiBmb3Igb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVhc29uczpcbjEuIFlvdSBtaWdodCBoYXZlIG1pc21hdGNoaW5nIHZlcnNpb25zIG9mIFJlYWN0IGFuZCB0aGUgcmVuZGVyZXIgKHN1Y2ggYXMgUmVhY3QgRE9NKVxuMi4gWW91IG1pZ2h0IGJlIGJyZWFraW5nIHRoZSBSdWxlcyBvZiBIb29rc1xuMy4gWW91IG1pZ2h0IGhhdmUgbW9yZSB0aGFuIG9uZSBjb3B5IG9mIFJlYWN0IGluIHRoZSBzYW1lIGFwcFxuU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWhvb2stY2FsbCBmb3IgdGlwcyBhYm91dCBob3cgdG8gZGVidWcgYW5kIGZpeCB0aGlzIHByb2JsZW0uIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VDb250ZXh0MTIoQ29udGV4dCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoQ29udGV4dC5fY29udGV4dCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIHJlYWxDb250ZXh0ID0gQ29udGV4dC5fY29udGV4dDsKICAgICAgICAgICAgICBpZiAocmVhbENvbnRleHQuQ29uc3VtZXIgPT09IENvbnRleHQpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJDYWxsaW5nIHVzZUNvbnRleHQoQ29udGV4dC5Db25zdW1lcikgaXMgbm90IHN1cHBvcnRlZCwgbWF5IGNhdXNlIGJ1Z3MsIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgdXNlQ29udGV4dChDb250ZXh0KSBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVhbENvbnRleHQuUHJvdmlkZXIgPT09IENvbnRleHQpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJDYWxsaW5nIHVzZUNvbnRleHQoQ29udGV4dC5Qcm92aWRlcikgaXMgbm90IHN1cHBvcnRlZC4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgdXNlQ29udGV4dChDb250ZXh0KSBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlQ29udGV4dChDb250ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlU3RhdGUxMihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlU3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVJlZjE2KGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlUmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUVmZmVjdDE0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VMYXlvdXRFZmZlY3Q5KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUNhbGxiYWNrOChjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VNZW1vOShjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlSW1wZXJhdGl2ZUhhbmRsZTMocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VEZWJ1Z1ZhbHVlMih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VEZWJ1Z1ZhbHVlKHZhbHVlLCBmb3JtYXR0ZXJGbik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VUcmFuc2l0aW9uKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZURlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VJZDIoKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VJZCgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VTeW5jRXh0ZXJuYWxTdG9yZTIoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpc2FibGVkRGVwdGggPSAwOwogICAgICAgIHZhciBwcmV2TG9nOwogICAgICAgIHZhciBwcmV2SW5mbzsKICAgICAgICB2YXIgcHJldldhcm47CiAgICAgICAgdmFyIHByZXZFcnJvcjsKICAgICAgICB2YXIgcHJldkdyb3VwOwogICAgICAgIHZhciBwcmV2R3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgdmFyIHByZXZHcm91cEVuZDsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlZExvZygpIHsKICAgICAgICB9CiAgICAgICAgZGlzYWJsZWRMb2cuX19yZWFjdERpc2FibGVkTG9nID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICBwcmV2TG9nID0gY29uc29sZS5sb2c7CiAgICAgICAgICAgICAgcHJldkluZm8gPSBjb25zb2xlLmluZm87CiAgICAgICAgICAgICAgcHJldldhcm4gPSBjb25zb2xlLndhcm47CiAgICAgICAgICAgICAgcHJldkVycm9yID0gY29uc29sZS5lcnJvcjsKICAgICAgICAgICAgICBwcmV2R3JvdXAgPSBjb25zb2xlLmdyb3VwOwogICAgICAgICAgICAgIHByZXZHcm91cENvbGxhcHNlZCA9IGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgICAgICAgcHJldkdyb3VwRW5kID0gY29uc29sZS5ncm91cEVuZDsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IGRpc2FibGVkTG9nLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGluZm86IHByb3BzLAogICAgICAgICAgICAgICAgbG9nOiBwcm9wcywKICAgICAgICAgICAgICAgIHdhcm46IHByb3BzLAogICAgICAgICAgICAgICAgZXJyb3I6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXA6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IHByb3BzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlzYWJsZWREZXB0aCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVuYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgtLTsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGxvZzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHdhcm46IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2V2FybgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBlcnJvcjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cENvbGxhcHNlZAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cEVuZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyOwogICAgICAgIHZhciBwcmVmaXg7CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmVmaXggPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB4Mi5zdGFjay50cmltKCkubWF0Y2goL1xuKCAqKGF0ICk/KS8pOwogICAgICAgICAgICAgICAgcHJlZml4ID0gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiXG4iICsgcHJlZml4ICsgbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICB2YXIgY29tcG9uZW50RnJhbWVDYWNoZTsKICAgICAgICB7CiAgICAgICAgICB2YXIgUG9zc2libHlXZWFrTWFwID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZSA9IG5ldyBQb3NzaWJseVdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgY29uc3RydWN0KSB7CiAgICAgICAgICBpZiAoIWZuIHx8IHJlZW50cnkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgZnJhbWUgPSBjb21wb25lbnRGcmFtZUNhY2hlLmdldChmbik7CiAgICAgICAgICAgIGlmIChmcmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udHJvbDsKICAgICAgICAgIHJlZW50cnkgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2UgPSBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gdm9pZCAwOwogICAgICAgICAgdmFyIHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgcHJldmlvdXNEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgZGlzYWJsZUxvZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChjb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICB2YXIgRmFrZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShGYWtlLnByb3RvdHlwZSwgInByb3BzIiwgewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09ICJvYmplY3QiICYmIFJlZmxlY3QuY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChGYWtlLCBbXSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChmbiwgW10sIEZha2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBGYWtlLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChzYW1wbGUpIHsKICAgICAgICAgICAgaWYgKHNhbXBsZSAmJiBjb250cm9sICYmIHR5cGVvZiBzYW1wbGUuc3RhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgdmFyIHNhbXBsZUxpbmVzID0gc2FtcGxlLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBjb250cm9sTGluZXMgPSBjb250cm9sLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBzID0gc2FtcGxlTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB2YXIgYyA9IGNvbnRyb2xMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHdoaWxlIChzID49IDEgJiYgYyA+PSAwICYmIHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICg7IHMgPj0gMSAmJiBjID49IDA7IHMtLSwgYy0tKSB7CiAgICAgICAgICAgICAgICBpZiAoc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICBpZiAocyAhPT0gMSB8fCBjICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgcy0tOwogICAgICAgICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGMgPCAwIHx8IHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9mcmFtZSA9ICJcbiIgKyBzYW1wbGVMaW5lc1tzXS5yZXBsYWNlKCIgYXQgbmV3ICIsICIgYXQgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbi5kaXNwbGF5TmFtZSAmJiBfZnJhbWUuaW5jbHVkZXMoIjxhbm9ueW1vdXM+IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBfZnJhbWUgPSBfZnJhbWUucmVwbGFjZSgiPGFub255bW91cz4iLCBmbi5kaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBfZnJhbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2ZyYW1lOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKHMgPj0gMSAmJiBjID49IDApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICAgICAgcmVlbmFibGVMb2dzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBmbiA/IGZuLmRpc3BsYXlOYW1lIHx8IGZuLm5hbWUgOiAiIjsKICAgICAgICAgIHZhciBzeW50aGV0aWNGcmFtZSA9IG5hbWUgPyBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lKSA6ICIiOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIHN5bnRoZXRpY0ZyYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY0ZyYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZm4sIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QoQ29tcG9uZW50MikgewogICAgICAgICAgdmFyIHByb3RvdHlwZSA9IENvbXBvbmVudDIucHJvdG90eXBlOwogICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIGlmICh0eXBlID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZSh0eXBlLCBzaG91bGRDb25zdHJ1Y3QodHlwZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlTGlzdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZSh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVih0eXBlLnR5cGUsIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoaW5pdChwYXlsb2FkKSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBsb2dnZWRUeXBlRmFpbHVyZXMgPSB7fTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGVsZW1lbnQudHlwZSwgZWxlbWVudC5fc291cmNlLCBvd25lciA/IG93bmVyLnR5cGUgOiBudWxsKTsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFR5cGVzKHR5cGVTcGVjcywgdmFsdWVzLCBsb2NhdGlvbiwgY29tcG9uZW50TmFtZSwgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzMyA9IEZ1bmN0aW9uLmNhbGwuYmluZChoYXNPd25Qcm9wZXJ0eSk7CiAgICAgICAgICAgIGZvciAodmFyIHR5cGVTcGVjTmFtZSBpbiB0eXBlU3BlY3MpIHsKICAgICAgICAgICAgICBpZiAoaGFzMyh0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBFcnJvcigoY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiKSArICI6ICIgKyBsb2NhdGlvbiArICIgdHlwZSBgIiArIHR5cGVTcGVjTmFtZSArICJgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tIHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZSwgYnV0IHJlY2VpdmVkIGAiICsgdHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICsgImAuVGhpcyBvZnRlbiBoYXBwZW5zIGJlY2F1c2Ugb2YgdHlwb3Mgc3VjaCBhcyBgUHJvcFR5cGVzLmZ1bmN0aW9uYCBpbnN0ZWFkIG9mIGBQcm9wVHlwZXMuZnVuY2AuIik7CiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIHNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2V0RXh0cmFTdGFja0ZyYW1lKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93bjsKICAgICAgICB7CiAgICAgICAgICBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93biA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSB7CiAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCkgewogICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnR5cGUpOwogICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgbmFtZSArICJgLiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW0oc291cmNlKSB7CiAgICAgICAgICBpZiAoc291cmNlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFyIGZpbGVOYW1lID0gc291cmNlLmZpbGVOYW1lLnJlcGxhY2UoL14uKltcXFwvXS8sICIiKTsKICAgICAgICAgICAgdmFyIGxpbmVOdW1iZXIgPSBzb3VyY2UubGluZU51bWJlcjsKICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgeW91ciBjb2RlIGF0ICIgKyBmaWxlTmFtZSArICI6IiArIGxpbmVOdW1iZXIgKyAiLiI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtRm9yUHJvcHMoZWxlbWVudFByb3BzKSB7CiAgICAgICAgICBpZiAoZWxlbWVudFByb3BzICE9PSBudWxsICYmIGVsZW1lbnRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShlbGVtZW50UHJvcHMuX19zb3VyY2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudENvbXBvbmVudEVycm9ySW5mbyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICB2YXIgaW5mbyA9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgaWYgKCFpbmZvKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnROYW1lID0gdHlwZW9mIHBhcmVudFR5cGUgPT09ICJzdHJpbmciID8gcGFyZW50VHlwZSA6IHBhcmVudFR5cGUuZGlzcGxheU5hbWUgfHwgcGFyZW50VHlwZS5uYW1lOwogICAgICAgICAgICBpZiAocGFyZW50TmFtZSkgewogICAgICAgICAgICAgIGluZm8gPSAiXG5cbkNoZWNrIHRoZSB0b3AtbGV2ZWwgcmVuZGVyIGNhbGwgdXNpbmcgPCIgKyBwYXJlbnROYW1lICsgIj4uIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluZm87CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRXhwbGljaXRLZXkoZWxlbWVudCwgcGFyZW50VHlwZSkgewogICAgICAgICAgaWYgKCFlbGVtZW50Ll9zdG9yZSB8fCBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgfHwgZWxlbWVudC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8gPSBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpOwogICAgICAgICAgaWYgKG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBvd25lckhhc0tleVVzZVdhcm5pbmdbY3VycmVudENvbXBvbmVudEVycm9ySW5mb10gPSB0cnVlOwogICAgICAgICAgdmFyIGNoaWxkT3duZXIgPSAiIjsKICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyICE9PSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICAgIGNoaWxkT3duZXIgPSAiIEl0IHdhcyBwYXNzZWQgYSBjaGlsZCBmcm9tICIgKyBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoZWxlbWVudC5fb3duZXIudHlwZSkgKyAiLiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCk7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiVzJXMgU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93YXJuaW5nLWtleXMgZm9yIG1vcmUgaW5mb3JtYXRpb24uJywgY3VycmVudENvbXBvbmVudEVycm9ySW5mbywgY2hpbGRPd25lcik7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlQ2hpbGRLZXlzKG5vZGUsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlb2Ygbm9kZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQXJyYXkyKG5vZGUpKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGVbaV07CiAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50MTUoY2hpbGQpKSB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KGNoaWxkLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNWYWxpZEVsZW1lbnQxNShub2RlKSkgewogICAgICAgICAgICBpZiAobm9kZS5fc3RvcmUpIHsKICAgICAgICAgICAgICBub2RlLl9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUpIHsKICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKG5vZGUpOwogICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAoaXRlcmF0b3JGbiAhPT0gbm9kZS5lbnRyaWVzKSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlcmF0b3IgPSBpdGVyYXRvckZuLmNhbGwobm9kZSk7CiAgICAgICAgICAgICAgICB2YXIgc3RlcDsKICAgICAgICAgICAgICAgIHdoaWxlICghKHN0ZXAgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsaWRFbGVtZW50MTUoc3RlcC52YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KHN0ZXAudmFsdWUsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcFR5cGVzKGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgIGlmICh0eXBlID09PSBudWxsIHx8IHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb3BUeXBlczsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzID0gdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmICh0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiB8fCAvLyBOb3RlOiBNZW1vIG9ubHkgY2hlY2tzIG91dGVyIHByb3BzIGhlcmUuCiAgICAgICAgICAgIC8vIElubmVyIHByb3BzIGFyZSBjaGVja2VkIGluIHRoZSByZWNvbmNpbGVyLgogICAgICAgICAgICB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyKSkgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMocHJvcFR5cGVzLCBlbGVtZW50LnByb3BzLCAicHJvcCIsIG5hbWUsIGVsZW1lbnQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUuUHJvcFR5cGVzICE9PSB2b2lkIDAgJiYgIXByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgIHZhciBfbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBlcnJvcigiQ29tcG9uZW50ICVzIGRlY2xhcmVkIGBQcm9wVHlwZXNgIGluc3RlYWQgb2YgYHByb3BUeXBlc2AuIERpZCB5b3UgbWlzc3BlbGwgdGhlIHByb3BlcnR5IGFzc2lnbm1lbnQ/IiwgX25hbWUgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUuZ2V0RGVmYXVsdFByb3BzID09PSAiZnVuY3Rpb24iICYmICF0eXBlLmdldERlZmF1bHRQcm9wcy5pc1JlYWN0Q2xhc3NBcHByb3ZlZCkgewogICAgICAgICAgICAgIGVycm9yKCJnZXREZWZhdWx0UHJvcHMgaXMgb25seSB1c2VkIG9uIGNsYXNzaWMgUmVhY3QuY3JlYXRlQ2xhc3MgZGVmaW5pdGlvbnMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSBuYW1lZCBgZGVmYXVsdFByb3BzYCBpbnN0ZWFkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhmcmFnbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKGZyYWdtZW50LnByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGtleSA9IGtleXNbaV07CiAgICAgICAgICAgICAgaWYgKGtleSAhPT0gImNoaWxkcmVuIiAmJiBrZXkgIT09ICJrZXkiKSB7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIHByb3AgYCVzYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiBSZWFjdC5GcmFnbWVudCBjYW4gb25seSBoYXZlIGBrZXlgIGFuZCBgY2hpbGRyZW5gIHByb3BzLiIsIGtleSk7CiAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmcmFnbWVudC5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGZyYWdtZW50KTsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhdHRyaWJ1dGUgYHJlZmAgc3VwcGxpZWQgdG8gYFJlYWN0LkZyYWdtZW50YC4iKTsKICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnRXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywgY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciB2YWxpZFR5cGUgPSBpc1ZhbGlkRWxlbWVudFR5cGUodHlwZSk7CiAgICAgICAgICBpZiAoIXZhbGlkVHlwZSkgewogICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsICYmIE9iamVjdC5rZXlzKHR5cGUpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgIGluZm8gKz0gIiBZb3UgbGlrZWx5IGZvcmdvdCB0byBleHBvcnQgeW91ciBjb21wb25lbnQgZnJvbSB0aGUgZmlsZSBpdCdzIGRlZmluZWQgaW4sIG9yIHlvdSBtaWdodCBoYXZlIG1peGVkIHVwIGRlZmF1bHQgYW5kIG5hbWVkIGltcG9ydHMuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc291cmNlSW5mbyA9IGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtRm9yUHJvcHMocHJvcHMpOwogICAgICAgICAgICBpZiAoc291cmNlSW5mbykgewogICAgICAgICAgICAgIGluZm8gKz0gc291cmNlSW5mbzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpbmZvICs9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0eXBlU3RyaW5nOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAibnVsbCI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheTIodHlwZSkpIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gImFycmF5IjsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlICE9PSB2b2lkIDAgJiYgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRUxFTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICI8IiArIChnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiVW5rbm93biIpICsgIiAvPiI7CiAgICAgICAgICAgICAgaW5mbyA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgZXhwb3J0IGEgSlNYIGxpdGVyYWwgaW5zdGVhZCBvZiBhIGNvbXBvbmVudD8iOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSB0eXBlb2YgdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0LmNyZWF0ZUVsZW1lbnQ6IHR5cGUgaXMgaW52YWxpZCAtLSBleHBlY3RlZCBhIHN0cmluZyAoZm9yIGJ1aWx0LWluIGNvbXBvbmVudHMpIG9yIGEgY2xhc3MvZnVuY3Rpb24gKGZvciBjb21wb3NpdGUgY29tcG9uZW50cykgYnV0IGdvdDogJXMuJXMiLCB0eXBlU3RyaW5nLCBpbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVsZW1lbnQgPSBjcmVhdGVFbGVtZW50MzkuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIGlmIChlbGVtZW50ID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmFsaWRUeXBlKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAyOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoYXJndW1lbnRzW2ldLCB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgdmFsaWRhdGVGcmFnbWVudFByb3BzKGVsZW1lbnQpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dERlcHJlY2F0ZWRDcmVhdGVGYWN0b3J5ID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmFjdG9yeVdpdGhWYWxpZGF0aW9uKHR5cGUpIHsKICAgICAgICAgIHZhciB2YWxpZGF0ZWRGYWN0b3J5ID0gY3JlYXRlRWxlbWVudFdpdGhWYWxpZGF0aW9uLmJpbmQobnVsbCwgdHlwZSk7CiAgICAgICAgICB2YWxpZGF0ZWRGYWN0b3J5LnR5cGUgPSB0eXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERlcHJlY2F0ZWRDcmVhdGVGYWN0b3J5KSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGVwcmVjYXRlZENyZWF0ZUZhY3RvcnkgPSB0cnVlOwogICAgICAgICAgICAgIHdhcm4zKCJSZWFjdC5jcmVhdGVGYWN0b3J5KCkgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIENvbnNpZGVyIHVzaW5nIEpTWCBvciB1c2UgUmVhY3QuY3JlYXRlRWxlbWVudCgpIGRpcmVjdGx5IGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHZhbGlkYXRlZEZhY3RvcnksICJ0eXBlIiwgewogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB3YXJuMygiRmFjdG9yeS50eXBlIGlzIGRlcHJlY2F0ZWQuIEFjY2VzcyB0aGUgY2xhc3MgZGlyZWN0bHkgYmVmb3JlIHBhc3NpbmcgaXQgdG8gY3JlYXRlRmFjdG9yeS4iKTsKICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAidHlwZSIsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHR5cGUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWxpZGF0ZWRGYWN0b3J5OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbG9uZUVsZW1lbnRXaXRoVmFsaWRhdGlvbihlbGVtZW50LCBwcm9wcywgY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciBuZXdFbGVtZW50ID0gY2xvbmVFbGVtZW50OC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgZm9yICh2YXIgaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoYXJndW1lbnRzW2ldLCBuZXdFbGVtZW50LnR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMobmV3RWxlbWVudCk7CiAgICAgICAgICByZXR1cm4gbmV3RWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRUcmFuc2l0aW9uKHNjb3BlLCBvcHRpb25zKSB7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHt9OwogICAgICAgICAgdmFyIGN1cnJlbnRUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzY29wZSgpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHByZXZUcmFuc2l0aW9uID09PSBudWxsICYmIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlZEZpYmVyc0NvdW50ID0gY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuc2l6ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVkRmliZXJzQ291bnQgPiAxMCkgewogICAgICAgICAgICAgICAgICB3YXJuMygiRGV0ZWN0ZWQgYSBsYXJnZSBudW1iZXIgb2YgdXBkYXRlcyBpbnNpZGUgc3RhcnRUcmFuc2l0aW9uLiBJZiB0aGlzIGlzIGR1ZSB0byBhIHN1YnNjcmlwdGlvbiBwbGVhc2UgcmUtd3JpdGUgaXQgdG8gdXNlIFJlYWN0IHByb3ZpZGVkIGhvb2tzLiBPdGhlcndpc2UgY29uY3VycmVudCBtb2RlIGd1YXJhbnRlZXMgYXJlIG9mZiB0aGUgdGFibGUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5jbGVhcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0TWVzc2FnZUNoYW5uZWwgPSBmYWxzZTsKICAgICAgICB2YXIgZW5xdWV1ZVRhc2tJbXBsID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlVGFzayh0YXNrMikgewogICAgICAgICAgaWYgKGVucXVldWVUYXNrSW1wbCA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciByZXF1aXJlU3RyaW5nID0gKCJyZXF1aXJlIiArIE1hdGgucmFuZG9tKCkpLnNsaWNlKDAsIDcpOwogICAgICAgICAgICAgIHZhciBub2RlUmVxdWlyZSA9IG1vZHVsZSAmJiBtb2R1bGVbcmVxdWlyZVN0cmluZ107CiAgICAgICAgICAgICAgZW5xdWV1ZVRhc2tJbXBsID0gbm9kZVJlcXVpcmUuY2FsbChtb2R1bGUsICJ0aW1lcnMiKS5zZXRJbW1lZGlhdGU7CiAgICAgICAgICAgIH0gY2F0Y2ggKF9lcnIpIHsKICAgICAgICAgICAgICBlbnF1ZXVlVGFza0ltcGwgPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoZGlkV2FybkFib3V0TWVzc2FnZUNoYW5uZWwgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWVzc2FnZUNoYW5uZWwgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgTWVzc2FnZUNoYW5uZWwgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiVGhpcyBicm93c2VyIGRvZXMgbm90IGhhdmUgYSBNZXNzYWdlQ2hhbm5lbCBpbXBsZW1lbnRhdGlvbiwgc28gZW5xdWV1aW5nIHRhc2tzIHZpYSBhd2FpdCBhY3QoYXN5bmMgKCkgPT4gLi4uKSB3aWxsIGZhaWwuIFBsZWFzZSBmaWxlIGFuIGlzc3VlIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9yZWFjdC9pc3N1ZXMgaWYgeW91IGVuY291bnRlciB0aGlzIHdhcm5pbmcuIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgY2hhbm5lbCA9IG5ldyBNZXNzYWdlQ2hhbm5lbCgpOwogICAgICAgICAgICAgICAgY2hhbm5lbC5wb3J0MS5vbm1lc3NhZ2UgPSBjYWxsYmFjazsKICAgICAgICAgICAgICAgIGNoYW5uZWwucG9ydDIucG9zdE1lc3NhZ2Uodm9pZCAwKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZW5xdWV1ZVRhc2tJbXBsKHRhc2syKTsKICAgICAgICB9CiAgICAgICAgdmFyIGFjdFNjb3BlRGVwdGggPSAwOwogICAgICAgIHZhciBkaWRXYXJuTm9Bd2FpdEFjdCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGFjdChjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcHJldkFjdFNjb3BlRGVwdGggPSBhY3RTY29wZURlcHRoOwogICAgICAgICAgICBhY3RTY29wZURlcHRoKys7CiAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcmV2SXNCYXRjaGluZ0xlZ2FjeSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlLmlzQmF0Y2hpbmdMZWdhY3k7CiAgICAgICAgICAgIHZhciByZXN1bHQ7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuaXNCYXRjaGluZ0xlZ2FjeSA9IHRydWU7CiAgICAgICAgICAgICAgcmVzdWx0ID0gY2FsbGJhY2soKTsKICAgICAgICAgICAgICBpZiAoIXByZXZJc0JhdGNoaW5nTGVnYWN5ICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlKSB7CiAgICAgICAgICAgICAgICB2YXIgcXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKHF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGZsdXNoQWN0UXVldWUocXVldWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5pc0JhdGNoaW5nTGVnYWN5ID0gcHJldklzQmF0Y2hpbmdMZWdhY3k7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlc3VsdCAhPT0gbnVsbCAmJiB0eXBlb2YgcmVzdWx0ID09PSAib2JqZWN0IiAmJiB0eXBlb2YgcmVzdWx0LnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgdGhlbmFibGVSZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgICAgICAgdmFyIHdhc0F3YWl0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgdGhlbmFibGUgPSB7CiAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgd2FzQXdhaXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHRoZW5hYmxlUmVzdWx0LnRoZW4oZnVuY3Rpb24ocmV0dXJuVmFsdWUyKSB7CiAgICAgICAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgICAgICAgIGlmIChhY3RTY29wZURlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICByZWN1cnNpdmVseUZsdXNoQXN5bmNBY3RXb3JrKHJldHVyblZhbHVlMiwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZTIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2Fybk5vQXdhaXRBY3QgJiYgdHlwZW9mIFByb21pc2UgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF3YXNBd2FpdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICBkaWRXYXJuTm9Bd2FpdEFjdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiWW91IGNhbGxlZCBhY3QoYXN5bmMgKCkgPT4gLi4uKSB3aXRob3V0IGF3YWl0LiBUaGlzIGNvdWxkIGxlYWQgdG8gdW5leHBlY3RlZCB0ZXN0aW5nIGJlaGF2aW91ciwgaW50ZXJsZWF2aW5nIG11bHRpcGxlIGFjdCBjYWxscyBhbmQgbWl4aW5nIHRoZWlyIHNjb3Blcy4gWW91IHNob3VsZCAtIGF3YWl0IGFjdChhc3luYyAoKSA9PiAuLi4pOyIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0aGVuYWJsZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgcmV0dXJuVmFsdWUgPSByZXN1bHQ7CiAgICAgICAgICAgICAgcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpOwogICAgICAgICAgICAgIGlmIChhY3RTY29wZURlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICB2YXIgX3F1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudDsKICAgICAgICAgICAgICAgIGlmIChfcXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZmx1c2hBY3RRdWV1ZShfcXVldWUpOwogICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBfdGhlbmFibGUgPSB7CiAgICAgICAgICAgICAgICAgIHRoZW46IGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID0gW107CiAgICAgICAgICAgICAgICAgICAgICByZWN1cnNpdmVseUZsdXNoQXN5bmNBY3RXb3JrKHJldHVyblZhbHVlLCByZXNvbHZlLCByZWplY3QpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJldHVyblZhbHVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoZW5hYmxlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgX3RoZW5hYmxlMiA9IHsKICAgICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoZW5hYmxlMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wQWN0U2NvcGUocHJldkFjdFNjb3BlRGVwdGgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByZXZBY3RTY29wZURlcHRoICE9PSBhY3RTY29wZURlcHRoIC0gMSkgewogICAgICAgICAgICAgIGVycm9yKCJZb3Ugc2VlbSB0byBoYXZlIG92ZXJsYXBwaW5nIGFjdCgpIGNhbGxzLCB0aGlzIGlzIG5vdCBzdXBwb3J0ZWQuIEJlIHN1cmUgdG8gYXdhaXQgcHJldmlvdXMgYWN0KCkgY2FsbHMgYmVmb3JlIG1ha2luZyBhIG5ldyBvbmUuICIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFjdFNjb3BlRGVwdGggPSBwcmV2QWN0U2NvcGVEZXB0aDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBxdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChxdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBmbHVzaEFjdFF1ZXVlKHF1ZXVlKTsKICAgICAgICAgICAgICAgIGVucXVldWVUYXNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAocXVldWUubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlGbHVzaEFzeW5jQWN0V29yayhyZXR1cm5WYWx1ZSwgcmVzb2x2ZSwgcmVqZWN0KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzb2x2ZShyZXR1cm5WYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzRmx1c2hpbmcgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBmbHVzaEFjdFF1ZXVlKHF1ZXVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghaXNGbHVzaGluZykgewogICAgICAgICAgICAgIGlzRmx1c2hpbmcgPSB0cnVlOwogICAgICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZm9yICg7IGkgPCBxdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBxdWV1ZVtpXTsKICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sodHJ1ZSk7CiAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGNhbGxiYWNrICE9PSBudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHF1ZXVlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICBxdWV1ZSA9IHF1ZXVlLnNsaWNlKGkgKyAxKTsKICAgICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgaXNGbHVzaGluZyA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgY3JlYXRlRWxlbWVudCQxID0gY3JlYXRlRWxlbWVudFdpdGhWYWxpZGF0aW9uOwogICAgICAgIHZhciBjbG9uZUVsZW1lbnQkMSA9IGNsb25lRWxlbWVudFdpdGhWYWxpZGF0aW9uOwogICAgICAgIHZhciBjcmVhdGVGYWN0b3J5ID0gY3JlYXRlRmFjdG9yeVdpdGhWYWxpZGF0aW9uOwogICAgICAgIHZhciBDaGlsZHJlbjIgPSB7CiAgICAgICAgICBtYXA6IG1hcENoaWxkcmVuLAogICAgICAgICAgZm9yRWFjaDogZm9yRWFjaENoaWxkcmVuLAogICAgICAgICAgY291bnQ6IGNvdW50Q2hpbGRyZW4sCiAgICAgICAgICB0b0FycmF5LAogICAgICAgICAgb25seTogb25seUNoaWxkCiAgICAgICAgfTsKICAgICAgICBleHBvcnRzLkNoaWxkcmVuID0gQ2hpbGRyZW4yOwogICAgICAgIGV4cG9ydHMuQ29tcG9uZW50ID0gQ29tcG9uZW50OwogICAgICAgIGV4cG9ydHMuRnJhZ21lbnQgPSBSRUFDVF9GUkFHTUVOVF9UWVBFOwogICAgICAgIGV4cG9ydHMuUHJvZmlsZXIgPSBSRUFDVF9QUk9GSUxFUl9UWVBFOwogICAgICAgIGV4cG9ydHMuUHVyZUNvbXBvbmVudCA9IFB1cmVDb21wb25lbnQzOwogICAgICAgIGV4cG9ydHMuU3RyaWN0TW9kZSA9IFJFQUNUX1NUUklDVF9NT0RFX1RZUEU7CiAgICAgICAgZXhwb3J0cy5TdXNwZW5zZSA9IFJFQUNUX1NVU1BFTlNFX1RZUEU7CiAgICAgICAgZXhwb3J0cy5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzOwogICAgICAgIGV4cG9ydHMuYWN0ID0gYWN0OwogICAgICAgIGV4cG9ydHMuY2xvbmVFbGVtZW50ID0gY2xvbmVFbGVtZW50JDE7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVDb250ZXh0ID0gY3JlYXRlQ29udGV4dDEyOwogICAgICAgIGV4cG9ydHMuY3JlYXRlRWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQkMTsKICAgICAgICBleHBvcnRzLmNyZWF0ZUZhY3RvcnkgPSBjcmVhdGVGYWN0b3J5OwogICAgICAgIGV4cG9ydHMuY3JlYXRlUmVmID0gY3JlYXRlUmVmOwogICAgICAgIGV4cG9ydHMuZm9yd2FyZFJlZiA9IGZvcndhcmRSZWYxNTsKICAgICAgICBleHBvcnRzLmlzVmFsaWRFbGVtZW50ID0gaXNWYWxpZEVsZW1lbnQxNTsKICAgICAgICBleHBvcnRzLmxhenkgPSBsYXp5OwogICAgICAgIGV4cG9ydHMubWVtbyA9IG1lbW83OwogICAgICAgIGV4cG9ydHMuc3RhcnRUcmFuc2l0aW9uID0gc3RhcnRUcmFuc2l0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfYWN0ID0gYWN0OwogICAgICAgIGV4cG9ydHMudXNlQ2FsbGJhY2sgPSB1c2VDYWxsYmFjazg7CiAgICAgICAgZXhwb3J0cy51c2VDb250ZXh0ID0gdXNlQ29udGV4dDEyOwogICAgICAgIGV4cG9ydHMudXNlRGVidWdWYWx1ZSA9IHVzZURlYnVnVmFsdWUyOwogICAgICAgIGV4cG9ydHMudXNlRGVmZXJyZWRWYWx1ZSA9IHVzZURlZmVycmVkVmFsdWU7CiAgICAgICAgZXhwb3J0cy51c2VFZmZlY3QgPSB1c2VFZmZlY3QxNDsKICAgICAgICBleHBvcnRzLnVzZUlkID0gdXNlSWQyOwogICAgICAgIGV4cG9ydHMudXNlSW1wZXJhdGl2ZUhhbmRsZSA9IHVzZUltcGVyYXRpdmVIYW5kbGUzOwogICAgICAgIGV4cG9ydHMudXNlSW5zZXJ0aW9uRWZmZWN0ID0gdXNlSW5zZXJ0aW9uRWZmZWN0OwogICAgICAgIGV4cG9ydHMudXNlTGF5b3V0RWZmZWN0ID0gdXNlTGF5b3V0RWZmZWN0OTsKICAgICAgICBleHBvcnRzLnVzZU1lbW8gPSB1c2VNZW1vOTsKICAgICAgICBleHBvcnRzLnVzZVJlZHVjZXIgPSB1c2VSZWR1Y2VyOwogICAgICAgIGV4cG9ydHMudXNlUmVmID0gdXNlUmVmMTY7CiAgICAgICAgZXhwb3J0cy51c2VTdGF0ZSA9IHVzZVN0YXRlMTI7CiAgICAgICAgZXhwb3J0cy51c2VTeW5jRXh0ZXJuYWxTdG9yZSA9IHVzZVN5bmNFeHRlcm5hbFN0b3JlMjsKICAgICAgICBleHBvcnRzLnVzZVRyYW5zaXRpb24gPSB1c2VUcmFuc2l0aW9uOwogICAgICAgIGV4cG9ydHMudmVyc2lvbiA9IFJlYWN0VmVyc2lvbjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC9pbmRleC5qcwp2YXIgcmVxdWlyZV9yZWFjdCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvcmVhY3QvaW5kZXguanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yZWFjdF9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvc2NoZWR1bGVyL2Nqcy9zY2hlZHVsZXIuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfc2NoZWR1bGVyX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9zY2hlZHVsZXIvY2pzL3NjaGVkdWxlci5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKHRydWUpIHsKICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgICB2YXIgZW5hYmxlU2NoZWR1bGVyRGVidWdnaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZVByb2ZpbGluZyA9IGZhbHNlOwogICAgICAgIHZhciBmcmFtZVlpZWxkTXMgPSA1OwogICAgICAgIGZ1bmN0aW9uIHB1c2goaGVhcCwgbm9kZSkgewogICAgICAgICAgdmFyIGluZGV4ID0gaGVhcC5sZW5ndGg7CiAgICAgICAgICBoZWFwLnB1c2gobm9kZSk7CiAgICAgICAgICBzaWZ0VXAoaGVhcCwgbm9kZSwgaW5kZXgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwZWVrMyhoZWFwKSB7CiAgICAgICAgICByZXR1cm4gaGVhcC5sZW5ndGggPT09IDAgPyBudWxsIDogaGVhcFswXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wKGhlYXApIHsKICAgICAgICAgIGlmIChoZWFwLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdCA9IGhlYXBbMF07CiAgICAgICAgICB2YXIgbGFzdDIgPSBoZWFwLnBvcCgpOwogICAgICAgICAgaWYgKGxhc3QyICE9PSBmaXJzdCkgewogICAgICAgICAgICBoZWFwWzBdID0gbGFzdDI7CiAgICAgICAgICAgIHNpZnREb3duKGhlYXAsIGxhc3QyLCAwKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaXJzdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2lmdFVwKGhlYXAsIG5vZGUsIGkpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGk7CiAgICAgICAgICB3aGlsZSAoaW5kZXggPiAwKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRJbmRleCA9IGluZGV4IC0gMSA+Pj4gMTsKICAgICAgICAgICAgdmFyIHBhcmVudCA9IGhlYXBbcGFyZW50SW5kZXhdOwogICAgICAgICAgICBpZiAoY29tcGFyZShwYXJlbnQsIG5vZGUpID4gMCkgewogICAgICAgICAgICAgIGhlYXBbcGFyZW50SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICBoZWFwW2luZGV4XSA9IHBhcmVudDsKICAgICAgICAgICAgICBpbmRleCA9IHBhcmVudEluZGV4OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaWZ0RG93bihoZWFwLCBub2RlLCBpKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IGhlYXAubGVuZ3RoOwogICAgICAgICAgdmFyIGhhbGZMZW5ndGggPSBsZW5ndGggPj4+IDE7CiAgICAgICAgICB3aGlsZSAoaW5kZXggPCBoYWxmTGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciBsZWZ0SW5kZXggPSAoaW5kZXggKyAxKSAqIDIgLSAxOwogICAgICAgICAgICB2YXIgbGVmdCA9IGhlYXBbbGVmdEluZGV4XTsKICAgICAgICAgICAgdmFyIHJpZ2h0SW5kZXggPSBsZWZ0SW5kZXggKyAxOwogICAgICAgICAgICB2YXIgcmlnaHQgPSBoZWFwW3JpZ2h0SW5kZXhdOwogICAgICAgICAgICBpZiAoY29tcGFyZShsZWZ0LCBub2RlKSA8IDApIHsKICAgICAgICAgICAgICBpZiAocmlnaHRJbmRleCA8IGxlbmd0aCAmJiBjb21wYXJlKHJpZ2h0LCBsZWZ0KSA8IDApIHsKICAgICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcmlnaHQ7CiAgICAgICAgICAgICAgICBoZWFwW3JpZ2h0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICAgIGluZGV4ID0gcmlnaHRJbmRleDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaGVhcFtpbmRleF0gPSBsZWZ0OwogICAgICAgICAgICAgICAgaGVhcFtsZWZ0SW5kZXhdID0gbm9kZTsKICAgICAgICAgICAgICAgIGluZGV4ID0gbGVmdEluZGV4OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyaWdodEluZGV4IDwgbGVuZ3RoICYmIGNvbXBhcmUocmlnaHQsIG5vZGUpIDwgMCkgewogICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gcmlnaHQ7CiAgICAgICAgICAgICAgaGVhcFtyaWdodEluZGV4XSA9IG5vZGU7CiAgICAgICAgICAgICAgaW5kZXggPSByaWdodEluZGV4OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wYXJlKGEsIGIpIHsKICAgICAgICAgIHZhciBkaWZmID0gYS5zb3J0SW5kZXggLSBiLnNvcnRJbmRleDsKICAgICAgICAgIHJldHVybiBkaWZmICE9PSAwID8gZGlmZiA6IGEuaWQgLSBiLmlkOwogICAgICAgIH0KICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSAxOwogICAgICAgIHZhciBVc2VyQmxvY2tpbmdQcmlvcml0eSA9IDI7CiAgICAgICAgdmFyIE5vcm1hbFByaW9yaXR5ID0gMzsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSA0OwogICAgICAgIHZhciBJZGxlUHJpb3JpdHkgPSA1OwogICAgICAgIGZ1bmN0aW9uIG1hcmtUYXNrRXJyb3JlZCh0YXNrMiwgbXMpIHsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1BlcmZvcm1hbmNlTm93ID0gdHlwZW9mIHBlcmZvcm1hbmNlID09PSAib2JqZWN0IiAmJiB0eXBlb2YgcGVyZm9ybWFuY2Uubm93ID09PSAiZnVuY3Rpb24iOwogICAgICAgIGlmIChoYXNQZXJmb3JtYW5jZU5vdykgewogICAgICAgICAgdmFyIGxvY2FsUGVyZm9ybWFuY2UgPSBwZXJmb3JtYW5jZTsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfbm93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbFBlcmZvcm1hbmNlLm5vdygpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGxvY2FsRGF0ZTIgPSBEYXRlOwogICAgICAgICAgdmFyIGluaXRpYWxUaW1lID0gbG9jYWxEYXRlMi5ub3coKTsKICAgICAgICAgIGV4cG9ydHMudW5zdGFibGVfbm93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBsb2NhbERhdGUyLm5vdygpIC0gaW5pdGlhbFRpbWU7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgbWF4U2lnbmVkMzFCaXRJbnQgPSAxMDczNzQxODIzOwogICAgICAgIHZhciBJTU1FRElBVEVfUFJJT1JJVFlfVElNRU9VVCA9IC0xOwogICAgICAgIHZhciBVU0VSX0JMT0NLSU5HX1BSSU9SSVRZX1RJTUVPVVQgPSAyNTA7CiAgICAgICAgdmFyIE5PUk1BTF9QUklPUklUWV9USU1FT1VUID0gNWUzOwogICAgICAgIHZhciBMT1dfUFJJT1JJVFlfVElNRU9VVCA9IDFlNDsKICAgICAgICB2YXIgSURMRV9QUklPUklUWV9USU1FT1VUID0gbWF4U2lnbmVkMzFCaXRJbnQ7CiAgICAgICAgdmFyIHRhc2tRdWV1ZSA9IFtdOwogICAgICAgIHZhciB0aW1lclF1ZXVlID0gW107CiAgICAgICAgdmFyIHRhc2tJZENvdW50ZXIgPSAxOwogICAgICAgIHZhciBjdXJyZW50VGFzayA9IG51bGw7CiAgICAgICAgdmFyIGN1cnJlbnRQcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgdmFyIGlzUGVyZm9ybWluZ1dvcmsgPSBmYWxzZTsKICAgICAgICB2YXIgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICB2YXIgaXNIb3N0VGltZW91dFNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgIHZhciBsb2NhbFNldFRpbWVvdXQgPSB0eXBlb2Ygc2V0VGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IHNldFRpbWVvdXQgOiBudWxsOwogICAgICAgIHZhciBsb2NhbENsZWFyVGltZW91dCA9IHR5cGVvZiBjbGVhclRpbWVvdXQgPT09ICJmdW5jdGlvbiIgPyBjbGVhclRpbWVvdXQgOiBudWxsOwogICAgICAgIHZhciBsb2NhbFNldEltbWVkaWF0ZSA9IHR5cGVvZiBzZXRJbW1lZGlhdGUgIT09ICJ1bmRlZmluZWQiID8gc2V0SW1tZWRpYXRlIDogbnVsbDsKICAgICAgICB2YXIgaXNJbnB1dFBlbmRpbmcgPSB0eXBlb2YgbmF2aWdhdG9yICE9PSAidW5kZWZpbmVkIiAmJiBuYXZpZ2F0b3Iuc2NoZWR1bGluZyAhPT0gdm9pZCAwICYmIG5hdmlnYXRvci5zY2hlZHVsaW5nLmlzSW5wdXRQZW5kaW5nICE9PSB2b2lkIDAgPyBuYXZpZ2F0b3Iuc2NoZWR1bGluZy5pc0lucHV0UGVuZGluZy5iaW5kKG5hdmlnYXRvci5zY2hlZHVsaW5nKSA6IG51bGw7CiAgICAgICAgZnVuY3Rpb24gYWR2YW5jZVRpbWVycyhjdXJyZW50VGltZSkgewogICAgICAgICAgdmFyIHRpbWVyID0gcGVlazModGltZXJRdWV1ZSk7CiAgICAgICAgICB3aGlsZSAodGltZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHRpbWVyLmNhbGxiYWNrID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcG9wKHRpbWVyUXVldWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRpbWVyLnN0YXJ0VGltZSA8PSBjdXJyZW50VGltZSkgewogICAgICAgICAgICAgIHBvcCh0aW1lclF1ZXVlKTsKICAgICAgICAgICAgICB0aW1lci5zb3J0SW5kZXggPSB0aW1lci5leHBpcmF0aW9uVGltZTsKICAgICAgICAgICAgICBwdXNoKHRhc2tRdWV1ZSwgdGltZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aW1lciA9IHBlZWszKHRpbWVyUXVldWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVUaW1lb3V0KGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKTsKICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQpIHsKICAgICAgICAgICAgaWYgKHBlZWszKHRhc2tRdWV1ZSkgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgcmVxdWVzdEhvc3RDYWxsYmFjayhmbHVzaFdvcmspOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBmaXJzdFRpbWVyID0gcGVlazModGltZXJRdWV1ZSk7CiAgICAgICAgICAgICAgaWYgKGZpcnN0VGltZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBmaXJzdFRpbWVyLnN0YXJ0VGltZSAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hXb3JrKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMikgewogICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIGlmIChpc0hvc3RUaW1lb3V0U2NoZWR1bGVkKSB7CiAgICAgICAgICAgIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgICAgY2FuY2VsSG9zdFRpbWVvdXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlzUGVyZm9ybWluZ1dvcmsgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGluZykgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0xvb3AoaGFzVGltZVJlbWFpbmluZywgaW5pdGlhbFRpbWUyKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgICAgICAgIG1hcmtUYXNrRXJyb3JlZChjdXJyZW50VGFzaywgY3VycmVudFRpbWUpOwogICAgICAgICAgICAgICAgICBjdXJyZW50VGFzay5pc1F1ZXVlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiB3b3JrTG9vcChoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50VGFzayA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcHJldmlvdXNQcmlvcml0eUxldmVsOwogICAgICAgICAgICBpc1BlcmZvcm1pbmdXb3JrID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMikgewogICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gaW5pdGlhbFRpbWUyOwogICAgICAgICAgYWR2YW5jZVRpbWVycyhjdXJyZW50VGltZSk7CiAgICAgICAgICBjdXJyZW50VGFzayA9IHBlZWszKHRhc2tRdWV1ZSk7CiAgICAgICAgICB3aGlsZSAoY3VycmVudFRhc2sgIT09IG51bGwgJiYgIWVuYWJsZVNjaGVkdWxlckRlYnVnZ2luZykgewogICAgICAgICAgICBpZiAoY3VycmVudFRhc2suZXhwaXJhdGlvblRpbWUgPiBjdXJyZW50VGltZSAmJiAoIWhhc1RpbWVSZW1haW5pbmcgfHwgc2hvdWxkWWllbGRUb0hvc3QoKSkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBjdXJyZW50VGFzay5jYWxsYmFjazsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGN1cnJlbnRUYXNrLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRUYXNrLnByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgdmFyIGRpZFVzZXJDYWxsYmFja1RpbWVvdXQgPSBjdXJyZW50VGFzay5leHBpcmF0aW9uVGltZSA8PSBjdXJyZW50VGltZTsKICAgICAgICAgICAgICB2YXIgY29udGludWF0aW9uQ2FsbGJhY2sgPSBjYWxsYmFjayhkaWRVc2VyQ2FsbGJhY2tUaW1lb3V0KTsKICAgICAgICAgICAgICBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250aW51YXRpb25DYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgY3VycmVudFRhc2suY2FsbGJhY2sgPSBjb250aW51YXRpb25DYWxsYmFjazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrID09PSBwZWVrMyh0YXNrUXVldWUpKSB7CiAgICAgICAgICAgICAgICAgIHBvcCh0YXNrUXVldWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBhZHZhbmNlVGltZXJzKGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwb3AodGFza1F1ZXVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50VGFzayA9IHBlZWszKHRhc2tRdWV1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudFRhc2sgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZmlyc3RUaW1lciA9IHBlZWszKHRpbWVyUXVldWUpOwogICAgICAgICAgICBpZiAoZmlyc3RUaW1lciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBmaXJzdFRpbWVyLnN0YXJ0VGltZSAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3J1bldpdGhQcmlvcml0eShwcmlvcml0eUxldmVsLCBldmVudEhhbmRsZXIpIHsKICAgICAgICAgIHN3aXRjaCAocHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICBjYXNlIExvd1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIElkbGVQcmlvcml0eToKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfbmV4dChldmVudEhhbmRsZXIpIHsKICAgICAgICAgIHZhciBwcmlvcml0eUxldmVsOwogICAgICAgICAgc3dpdGNoIChjdXJyZW50UHJpb3JpdHlMZXZlbCkgewogICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfd3JhcENhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICAgICAgICB2YXIgcGFyZW50UHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eUxldmVsID0gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIGN1cnJlbnRQcmlvcml0eUxldmVsID0gcGFyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayhwcmlvcml0eUxldmVsLCBjYWxsYmFjaywgb3B0aW9ucykgewogICAgICAgICAgdmFyIGN1cnJlbnRUaW1lID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKTsKICAgICAgICAgIHZhciBzdGFydFRpbWUyOwogICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAib2JqZWN0IiAmJiBvcHRpb25zICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBkZWxheSA9IG9wdGlvbnMuZGVsYXk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZGVsYXkgPT09ICJudW1iZXIiICYmIGRlbGF5ID4gMCkgewogICAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZSArIGRlbGF5OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhcnRUaW1lMiA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRpbWVvdXQ7CiAgICAgICAgICBzd2l0Y2ggKHByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgICAgY2FzZSBJbW1lZGlhdGVQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gSU1NRURJQVRFX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IFVTRVJfQkxPQ0tJTkdfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBJZGxlUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IElETEVfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBMb3dQcmlvcml0eToKICAgICAgICAgICAgICB0aW1lb3V0ID0gTE9XX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGltZW91dCA9IE5PUk1BTF9QUklPUklUWV9USU1FT1VUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lID0gc3RhcnRUaW1lMiArIHRpbWVvdXQ7CiAgICAgICAgICB2YXIgbmV3VGFzayA9IHsKICAgICAgICAgICAgaWQ6IHRhc2tJZENvdW50ZXIrKywKICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgIHByaW9yaXR5TGV2ZWwsCiAgICAgICAgICAgIHN0YXJ0VGltZTogc3RhcnRUaW1lMiwKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWUsCiAgICAgICAgICAgIHNvcnRJbmRleDogLTEKICAgICAgICAgIH07CiAgICAgICAgICBpZiAoc3RhcnRUaW1lMiA+IGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgIG5ld1Rhc2suc29ydEluZGV4ID0gc3RhcnRUaW1lMjsKICAgICAgICAgICAgcHVzaCh0aW1lclF1ZXVlLCBuZXdUYXNrKTsKICAgICAgICAgICAgaWYgKHBlZWszKHRhc2tRdWV1ZSkgPT09IG51bGwgJiYgbmV3VGFzayA9PT0gcGVlazModGltZXJRdWV1ZSkpIHsKICAgICAgICAgICAgICBpZiAoaXNIb3N0VGltZW91dFNjaGVkdWxlZCkgewogICAgICAgICAgICAgICAgY2FuY2VsSG9zdFRpbWVvdXQoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaXNIb3N0VGltZW91dFNjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlcXVlc3RIb3N0VGltZW91dChoYW5kbGVUaW1lb3V0LCBzdGFydFRpbWUyIC0gY3VycmVudFRpbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXdUYXNrLnNvcnRJbmRleCA9IGV4cGlyYXRpb25UaW1lOwogICAgICAgICAgICBwdXNoKHRhc2tRdWV1ZSwgbmV3VGFzayk7CiAgICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgJiYgIWlzUGVyZm9ybWluZ1dvcmspIHsKICAgICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgcmVxdWVzdEhvc3RDYWxsYmFjayhmbHVzaFdvcmspOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV3VGFzazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfcGF1c2VFeGVjdXRpb24oKSB7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2NvbnRpbnVlRXhlY3V0aW9uKCkgewogICAgICAgICAgaWYgKCFpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCAmJiAhaXNQZXJmb3JtaW5nV29yaykgewogICAgICAgICAgICBpc0hvc3RDYWxsYmFja1NjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICAgIHJlcXVlc3RIb3N0Q2FsbGJhY2soZmx1c2hXb3JrKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfZ2V0Rmlyc3RDYWxsYmFja05vZGUoKSB7CiAgICAgICAgICByZXR1cm4gcGVlazModGFza1F1ZXVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfY2FuY2VsQ2FsbGJhY2sodGFzazIpIHsKICAgICAgICAgIHRhc2syLmNhbGxiYWNrID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWwoKSB7CiAgICAgICAgICByZXR1cm4gY3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgfQogICAgICAgIHZhciBpc01lc3NhZ2VMb29wUnVubmluZyA9IGZhbHNlOwogICAgICAgIHZhciBzY2hlZHVsZWRIb3N0Q2FsbGJhY2sgPSBudWxsOwogICAgICAgIHZhciB0YXNrVGltZW91dElEID0gLTE7CiAgICAgICAgdmFyIGZyYW1lSW50ZXJ2YWwgPSBmcmFtZVlpZWxkTXM7CiAgICAgICAgdmFyIHN0YXJ0VGltZSA9IC0xOwogICAgICAgIGZ1bmN0aW9uIHNob3VsZFlpZWxkVG9Ib3N0KCkgewogICAgICAgICAgdmFyIHRpbWVFbGFwc2VkID0gZXhwb3J0cy51bnN0YWJsZV9ub3coKSAtIHN0YXJ0VGltZTsKICAgICAgICAgIGlmICh0aW1lRWxhcHNlZCA8IGZyYW1lSW50ZXJ2YWwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RQYWludCgpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yY2VGcmFtZVJhdGUoZnBzKSB7CiAgICAgICAgICBpZiAoZnBzIDwgMCB8fCBmcHMgPiAxMjUpIHsKICAgICAgICAgICAgY29uc29sZVsiZXJyb3IiXSgiZm9yY2VGcmFtZVJhdGUgdGFrZXMgYSBwb3NpdGl2ZSBpbnQgYmV0d2VlbiAwIGFuZCAxMjUsIGZvcmNpbmcgZnJhbWUgcmF0ZXMgaGlnaGVyIHRoYW4gMTI1IGZwcyBpcyBub3Qgc3VwcG9ydGVkIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmcHMgPiAwKSB7CiAgICAgICAgICAgIGZyYW1lSW50ZXJ2YWwgPSBNYXRoLmZsb29yKDFlMyAvIGZwcyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmcmFtZUludGVydmFsID0gZnJhbWVZaWVsZE1zOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoc2NoZWR1bGVkSG9zdENhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICAgIHN0YXJ0VGltZSA9IGN1cnJlbnRUaW1lOwogICAgICAgICAgICB2YXIgaGFzVGltZVJlbWFpbmluZyA9IHRydWU7CiAgICAgICAgICAgIHZhciBoYXNNb3JlV29yayA9IHRydWU7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaGFzTW9yZVdvcmsgPSBzY2hlZHVsZWRIb3N0Q2FsbGJhY2soaGFzVGltZVJlbWFpbmluZywgY3VycmVudFRpbWUpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIGlmIChoYXNNb3JlV29yaykgewogICAgICAgICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUoKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHNjaGVkdWxlZEhvc3RDYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpc01lc3NhZ2VMb29wUnVubmluZyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lOwogICAgICAgIGlmICh0eXBlb2YgbG9jYWxTZXRJbW1lZGlhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGxvY2FsU2V0SW1tZWRpYXRlKHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIE1lc3NhZ2VDaGFubmVsICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgdmFyIGNoYW5uZWwgPSBuZXcgTWVzc2FnZUNoYW5uZWwoKTsKICAgICAgICAgIHZhciBwb3J0ID0gY2hhbm5lbC5wb3J0MjsKICAgICAgICAgIGNoYW5uZWwucG9ydDEub25tZXNzYWdlID0gcGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lOwogICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcG9ydC5wb3N0TWVzc2FnZShudWxsKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGxvY2FsU2V0VGltZW91dChwZXJmb3JtV29ya1VudGlsRGVhZGxpbmUsIDApOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEhvc3RDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgc2NoZWR1bGVkSG9zdENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICBpZiAoIWlzTWVzc2FnZUxvb3BSdW5uaW5nKSB7CiAgICAgICAgICAgIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gdHJ1ZTsKICAgICAgICAgICAgc2NoZWR1bGVQZXJmb3JtV29ya1VudGlsRGVhZGxpbmUoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEhvc3RUaW1lb3V0KGNhbGxiYWNrLCBtcykgewogICAgICAgICAgdGFza1RpbWVvdXRJRCA9IGxvY2FsU2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgY2FsbGJhY2soZXhwb3J0cy51bnN0YWJsZV9ub3coKSk7CiAgICAgICAgICB9LCBtcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbmNlbEhvc3RUaW1lb3V0KCkgewogICAgICAgICAgbG9jYWxDbGVhclRpbWVvdXQodGFza1RpbWVvdXRJRCk7CiAgICAgICAgICB0YXNrVGltZW91dElEID0gLTE7CiAgICAgICAgfQogICAgICAgIHZhciB1bnN0YWJsZV9yZXF1ZXN0UGFpbnQgPSByZXF1ZXN0UGFpbnQ7CiAgICAgICAgdmFyIHVuc3RhYmxlX1Byb2ZpbGluZyA9IG51bGw7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9JZGxlUHJpb3JpdHkgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9JbW1lZGlhdGVQcmlvcml0eSA9IEltbWVkaWF0ZVByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfTG93UHJpb3JpdHkgPSBMb3dQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX05vcm1hbFByaW9yaXR5ID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Qcm9maWxpbmcgPSB1bnN0YWJsZV9Qcm9maWxpbmc7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Vc2VyQmxvY2tpbmdQcmlvcml0eSA9IFVzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfY2FuY2VsQ2FsbGJhY2sgPSB1bnN0YWJsZV9jYW5jZWxDYWxsYmFjazsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2NvbnRpbnVlRXhlY3V0aW9uID0gdW5zdGFibGVfY29udGludWVFeGVjdXRpb247CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9mb3JjZUZyYW1lUmF0ZSA9IGZvcmNlRnJhbWVSYXRlOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWwgPSB1bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2dldEZpcnN0Q2FsbGJhY2tOb2RlID0gdW5zdGFibGVfZ2V0Rmlyc3RDYWxsYmFja05vZGU7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9uZXh0ID0gdW5zdGFibGVfbmV4dDsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uID0gdW5zdGFibGVfcGF1c2VFeGVjdXRpb247CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9yZXF1ZXN0UGFpbnQgPSB1bnN0YWJsZV9yZXF1ZXN0UGFpbnQ7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9ydW5XaXRoUHJpb3JpdHkgPSB1bnN0YWJsZV9ydW5XaXRoUHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9zY2hlZHVsZUNhbGxiYWNrID0gdW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3Nob3VsZFlpZWxkID0gc2hvdWxkWWllbGRUb0hvc3Q7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV93cmFwQ2FsbGJhY2sgPSB1bnN0YWJsZV93cmFwQ2FsbGJhY2s7CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICB9KSgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvc2NoZWR1bGVyL2luZGV4LmpzCnZhciByZXF1aXJlX3NjaGVkdWxlciA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvc2NoZWR1bGVyL2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfc2NoZWR1bGVyX2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWFjdC1kb20vY2pzL3JlYWN0LWRvbS5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV9yZWFjdF9kb21fZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9janMvcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdDM4ID0gcmVxdWlyZV9yZWFjdCgpOwogICAgICAgIHZhciBTY2hlZHVsZXIgPSByZXF1aXJlX3NjaGVkdWxlcigpOwogICAgICAgIHZhciBSZWFjdFNoYXJlZEludGVybmFscyA9IFJlYWN0MzguX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CiAgICAgICAgdmFyIHN1cHByZXNzV2FybmluZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHNldFN1cHByZXNzV2FybmluZyhuZXdTdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3VwcHJlc3NXYXJuaW5nID0gbmV3U3VwcHJlc3NXYXJuaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuMyhmb3JtYXQyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghc3VwcHJlc3NXYXJuaW5nKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygid2FybiIsIGZvcm1hdDIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFzdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjIgPiAxID8gX2xlbjIgLSAxIDogMCksIF9rZXkyID0gMTsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5MiAtIDFdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJpbnRXYXJuaW5nKCJlcnJvciIsIGZvcm1hdDIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByaW50V2FybmluZyhsZXZlbCwgZm9ybWF0MiwgYXJncykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgICAgICB2YXIgc3RhY2sgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lMi5nZXRTdGFja0FkZGVuZHVtKCk7CiAgICAgICAgICAgIGlmIChzdGFjayAhPT0gIiIpIHsKICAgICAgICAgICAgICBmb3JtYXQyICs9ICIlcyI7CiAgICAgICAgICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KFtzdGFja10pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhcmdzV2l0aEZvcm1hdCA9IGFyZ3MubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKGl0ZW0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYXJnc1dpdGhGb3JtYXQudW5zaGlmdCgiV2FybmluZzogIiArIGZvcm1hdDIpOwogICAgICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW2xldmVsXSwgY29uc29sZSwgYXJnc1dpdGhGb3JtYXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgRnVuY3Rpb25Db21wb25lbnQgPSAwOwogICAgICAgIHZhciBDbGFzc0NvbXBvbmVudCA9IDE7CiAgICAgICAgdmFyIEluZGV0ZXJtaW5hdGVDb21wb25lbnQgPSAyOwogICAgICAgIHZhciBIb3N0Um9vdCA9IDM7CiAgICAgICAgdmFyIEhvc3RQb3J0YWwgPSA0OwogICAgICAgIHZhciBIb3N0Q29tcG9uZW50ID0gNTsKICAgICAgICB2YXIgSG9zdFRleHQgPSA2OwogICAgICAgIHZhciBGcmFnbWVudDkgPSA3OwogICAgICAgIHZhciBNb2RlID0gODsKICAgICAgICB2YXIgQ29udGV4dENvbnN1bWVyID0gOTsKICAgICAgICB2YXIgQ29udGV4dFByb3ZpZGVyID0gMTA7CiAgICAgICAgdmFyIEZvcndhcmRSZWYyID0gMTE7CiAgICAgICAgdmFyIFByb2ZpbGVyID0gMTI7CiAgICAgICAgdmFyIFN1c3BlbnNlQ29tcG9uZW50ID0gMTM7CiAgICAgICAgdmFyIE1lbW9Db21wb25lbnQgPSAxNDsKICAgICAgICB2YXIgU2ltcGxlTWVtb0NvbXBvbmVudCA9IDE1OwogICAgICAgIHZhciBMYXp5Q29tcG9uZW50ID0gMTY7CiAgICAgICAgdmFyIEluY29tcGxldGVDbGFzc0NvbXBvbmVudCA9IDE3OwogICAgICAgIHZhciBEZWh5ZHJhdGVkRnJhZ21lbnQgPSAxODsKICAgICAgICB2YXIgU3VzcGVuc2VMaXN0Q29tcG9uZW50ID0gMTk7CiAgICAgICAgdmFyIFNjb3BlQ29tcG9uZW50ID0gMjE7CiAgICAgICAgdmFyIE9mZnNjcmVlbkNvbXBvbmVudCA9IDIyOwogICAgICAgIHZhciBMZWdhY3lIaWRkZW5Db21wb25lbnQgPSAyMzsKICAgICAgICB2YXIgQ2FjaGVDb21wb25lbnQgPSAyNDsKICAgICAgICB2YXIgVHJhY2luZ01hcmtlckNvbXBvbmVudCA9IDI1OwogICAgICAgIHZhciBlbmFibGVDbGllbnRSZW5kZXJGYWxsYmFja09uVGV4dE1pc21hdGNoID0gdHJ1ZTsKICAgICAgICB2YXIgZW5hYmxlTmV3UmVjb25jaWxlciA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMYXp5Q29udGV4dFByb3BhZ2F0aW9uID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVTdXNwZW5zZUF2b2lkVGhpc0ZhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgdmFyIGRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQgPSBmYWxzZTsKICAgICAgICB2YXIgd2FybkFib3V0U3RyaW5nUmVmcyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlciA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVByb2ZpbGVyVGltZXIgPSB0cnVlOwogICAgICAgIHZhciBlbmFibGVQcm9maWxlckNvbW1pdEhvb2tzID0gdHJ1ZTsKICAgICAgICB2YXIgYWxsTmF0aXZlRXZlbnRzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcyA9IHt9OwogICAgICAgIHZhciBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzID0ge307CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJUd29QaGFzZUV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lLCBkZXBlbmRlbmNpZXMpOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lICsgIkNhcHR1cmUiLCBkZXBlbmRlbmNpZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlckRpcmVjdEV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSkgewogICAgICAgICAgICAgIGVycm9yKCJFdmVudFJlZ2lzdHJ5OiBNb3JlIHRoYW4gb25lIHBsdWdpbiBhdHRlbXB0ZWQgdG8gcHVibGlzaCB0aGUgc2FtZSByZWdpc3RyYXRpb24gbmFtZSwgYCVzYC4iLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSA9IGRlcGVuZGVuY2llczsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gcmVnaXN0cmF0aW9uTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzW2xvd2VyQ2FzZWROYW1lXSA9IHJlZ2lzdHJhdGlvbk5hbWU7CiAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lID09PSAib25Eb3VibGVDbGljayIpIHsKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzLm9uZGJsY2xpY2sgPSByZWdpc3RyYXRpb25OYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlcGVuZGVuY2llcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhbGxOYXRpdmVFdmVudHMuYWRkKGRlcGVuZGVuY2llc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjYW5Vc2VET00yID0gISEodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50ICE9PSAidW5kZWZpbmVkIik7CiAgICAgICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgICAgICBmdW5jdGlvbiB0eXBlTmFtZSh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzVG9TdHJpbmdUYWcgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC50b1N0cmluZ1RhZzsKICAgICAgICAgICAgdmFyIHR5cGUgPSBoYXNUb1N0cmluZ1RhZyAmJiB2YWx1ZVtTeW1ib2wudG9TdHJpbmdUYWddIHx8IHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUgfHwgIk9iamVjdCI7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbih2YWx1ZSwgYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBgJXNgIGF0dHJpYnV0ZSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgYXR0cmlidXRlTmFtZSwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0tleVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGtleSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1Byb3BTdHJpbmdDb2VyY2lvbih2YWx1ZSwgcHJvcE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQgYCVzYCBwcm9wIGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCBwcm9wTmFtZSwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0NTU1Byb3BlcnR5U3RyaW5nQ29lcmNpb24odmFsdWUsIHByb3BOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGAlc2AgQ1NTIHByb3BlcnR5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCBwcm9wTmFtZSwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0h0bWxTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBIVE1MIG1hcmt1cCB1c2VzIGEgdmFsdWUgb2YgdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiRm9ybSBmaWVsZCB2YWx1ZXMgKHZhbHVlLCBjaGVja2VkLCBkZWZhdWx0VmFsdWUsIG9yIGRlZmF1bHRDaGVja2VkIHByb3BzKSBtdXN0IGJlIHN0cmluZ3MsIG5vdCAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJFU0VSVkVEID0gMDsKICAgICAgICB2YXIgU1RSSU5HID0gMTsKICAgICAgICB2YXIgQk9PTEVBTklTSF9TVFJJTkcgPSAyOwogICAgICAgIHZhciBCT09MRUFOID0gMzsKICAgICAgICB2YXIgT1ZFUkxPQURFRF9CT09MRUFOID0gNDsKICAgICAgICB2YXIgTlVNRVJJQyA9IDU7CiAgICAgICAgdmFyIFBPU0lUSVZFX05VTUVSSUMgPSA2OwogICAgICAgIHZhciBBVFRSSUJVVEVfTkFNRV9TVEFSVF9DSEFSID0gIjpBLVpfYS16XFx1MDBDMC1cXHUwMEQ2XFx1MDBEOC1cXHUwMEY2XFx1MDBGOC1cXHUwMkZGXFx1MDM3MC1cXHUwMzdEXFx1MDM3Ri1cXHUxRkZGXFx1MjAwQy1cXHUyMDBEXFx1MjA3MC1cXHUyMThGXFx1MkMwMC1cXHUyRkVGXFx1MzAwMS1cXHVEN0ZGXFx1RjkwMC1cXHVGRENGXFx1RkRGMC1cXHVGRkZEIjsKICAgICAgICB2YXIgQVRUUklCVVRFX05BTUVfQ0hBUiA9IEFUVFJJQlVURV9OQU1FX1NUQVJUX0NIQVIgKyAiXFwtLjAtOVxcdTAwQjdcXHUwMzAwLVxcdTAzNkZcXHUyMDNGLVxcdTIwNDAiOwogICAgICAgIHZhciBWQUxJRF9BVFRSSUJVVEVfTkFNRV9SRUdFWCA9IG5ldyBSZWdFeHAoIl5bIiArIEFUVFJJQlVURV9OQU1FX1NUQVJUX0NIQVIgKyAiXVsiICsgQVRUUklCVVRFX05BTUVfQ0hBUiArICJdKiQiKTsKICAgICAgICB2YXIgaWxsZWdhbEF0dHJpYnV0ZU5hbWVDYWNoZSA9IHt9OwogICAgICAgIHZhciB2YWxpZGF0ZWRBdHRyaWJ1dGVOYW1lQ2FjaGUgPSB7fTsKICAgICAgICBmdW5jdGlvbiBpc0F0dHJpYnV0ZU5hbWVTYWZlKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbGlkYXRlZEF0dHJpYnV0ZU5hbWVDYWNoZSwgYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChpbGxlZ2FsQXR0cmlidXRlTmFtZUNhY2hlLCBhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoVkFMSURfQVRUUklCVVRFX05BTUVfUkVHRVgudGVzdChhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICB2YWxpZGF0ZWRBdHRyaWJ1dGVOYW1lQ2FjaGVbYXR0cmlidXRlTmFtZV0gPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlsbGVnYWxBdHRyaWJ1dGVOYW1lQ2FjaGVbYXR0cmlidXRlTmFtZV0gPSB0cnVlOwogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhdHRyaWJ1dGUgbmFtZTogYCVzYCIsIGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRJZ25vcmVBdHRyaWJ1dGUobmFtZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYW1lLmxlbmd0aCA+IDIgJiYgKG5hbWVbMF0gPT09ICJvIiB8fCBuYW1lWzBdID09PSAiTyIpICYmIChuYW1lWzFdID09PSAibiIgfHwgbmFtZVsxXSA9PT0gIk4iKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgICAgICAgY2FzZSAic3ltYm9sIjoKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6IHsKICAgICAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuICFwcm9wZXJ0eUluZm8uYWNjZXB0c0Jvb2xlYW5zOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgcHJlZml4MiA9IG5hbWUudG9Mb3dlckNhc2UoKS5zbGljZSgwLCA1KTsKICAgICAgICAgICAgICAgIHJldHVybiBwcmVmaXgyICE9PSAiZGF0YS0iICYmIHByZWZpeDIgIT09ICJhcmlhLSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZVdpdGhXYXJuaW5nKG5hbWUsIHZhbHVlLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgIHN3aXRjaCAocHJvcGVydHlJbmZvLnR5cGUpIHsKICAgICAgICAgICAgICBjYXNlIEJPT0xFQU46CiAgICAgICAgICAgICAgICByZXR1cm4gIXZhbHVlOwogICAgICAgICAgICAgIGNhc2UgT1ZFUkxPQURFRF9CT09MRUFOOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09PSBmYWxzZTsKICAgICAgICAgICAgICBjYXNlIE5VTUVSSUM6CiAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4odmFsdWUpOwogICAgICAgICAgICAgIGNhc2UgUE9TSVRJVkVfTlVNRVJJQzoKICAgICAgICAgICAgICAgIHJldHVybiBpc05hTih2YWx1ZSkgfHwgdmFsdWUgPCAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFByb3BlcnR5SW5mbyhuYW1lKSB7CiAgICAgICAgICByZXR1cm4gcHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSA/IHByb3BlcnRpZXNbbmFtZV0gOiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBQcm9wZXJ0eUluZm9SZWNvcmQobmFtZSwgdHlwZSwgbXVzdFVzZVByb3BlcnR5LCBhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVOYW1lc3BhY2UsIHNhbml0aXplVVJMMiwgcmVtb3ZlRW1wdHlTdHJpbmcpIHsKICAgICAgICAgIHRoaXMuYWNjZXB0c0Jvb2xlYW5zID0gdHlwZSA9PT0gQk9PTEVBTklTSF9TVFJJTkcgfHwgdHlwZSA9PT0gQk9PTEVBTiB8fCB0eXBlID09PSBPVkVSTE9BREVEX0JPT0xFQU47CiAgICAgICAgICB0aGlzLmF0dHJpYnV0ZU5hbWUgPSBhdHRyaWJ1dGVOYW1lOwogICAgICAgICAgdGhpcy5hdHRyaWJ1dGVOYW1lc3BhY2UgPSBhdHRyaWJ1dGVOYW1lc3BhY2U7CiAgICAgICAgICB0aGlzLm11c3RVc2VQcm9wZXJ0eSA9IG11c3RVc2VQcm9wZXJ0eTsKICAgICAgICAgIHRoaXMucHJvcGVydHlOYW1lID0gbmFtZTsKICAgICAgICAgIHRoaXMudHlwZSA9IHR5cGU7CiAgICAgICAgICB0aGlzLnNhbml0aXplVVJMID0gc2FuaXRpemVVUkwyOwogICAgICAgICAgdGhpcy5yZW1vdmVFbXB0eVN0cmluZyA9IHJlbW92ZUVtcHR5U3RyaW5nOwogICAgICAgIH0KICAgICAgICB2YXIgcHJvcGVydGllcyA9IHt9OwogICAgICAgIHZhciByZXNlcnZlZFByb3BzID0gWwogICAgICAgICAgImNoaWxkcmVuIiwKICAgICAgICAgICJkYW5nZXJvdXNseVNldElubmVySFRNTCIsCiAgICAgICAgICAvLyBUT0RPOiBUaGlzIHByZXZlbnRzIHRoZSBhc3NpZ25tZW50IG9mIGRlZmF1bHRWYWx1ZSB0byByZWd1bGFyCiAgICAgICAgICAvLyBlbGVtZW50cyAobm90IGp1c3QgaW5wdXRzKS4gTm93IHRoYXQgUmVhY3RET01JbnB1dCBhc3NpZ25zIHRvIHRoZQogICAgICAgICAgLy8gZGVmYXVsdFZhbHVlIHByb3BlcnR5IC0tIGRvIHdlIG5lZWQgdGhpcz8KICAgICAgICAgICJkZWZhdWx0VmFsdWUiLAogICAgICAgICAgImRlZmF1bHRDaGVja2VkIiwKICAgICAgICAgICJpbm5lckhUTUwiLAogICAgICAgICAgInN1cHByZXNzQ29udGVudEVkaXRhYmxlV2FybmluZyIsCiAgICAgICAgICAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIiwKICAgICAgICAgICJzdHlsZSIKICAgICAgICBdOwogICAgICAgIHJlc2VydmVkUHJvcHMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgUkVTRVJWRUQsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFtbImFjY2VwdENoYXJzZXQiLCAiYWNjZXB0LWNoYXJzZXQiXSwgWyJjbGFzc05hbWUiLCAiY2xhc3MiXSwgWyJodG1sRm9yIiwgImZvciJdLCBbImh0dHBFcXVpdiIsICJodHRwLWVxdWl2Il1dLmZvckVhY2goZnVuY3Rpb24oX3JlZjIpIHsKICAgICAgICAgIHZhciBuYW1lID0gX3JlZjJbMF0sIGF0dHJpYnV0ZU5hbWUgPSBfcmVmMlsxXTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsiY29udGVudEVkaXRhYmxlIiwgImRyYWdnYWJsZSIsICJzcGVsbENoZWNrIiwgInZhbHVlIl0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTklTSF9TVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWyJhdXRvUmV2ZXJzZSIsICJleHRlcm5hbFJlc291cmNlc1JlcXVpcmVkIiwgImZvY3VzYWJsZSIsICJwcmVzZXJ2ZUFscGhhIl0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTklTSF9TVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJhbGxvd0Z1bGxTY3JlZW4iLAogICAgICAgICAgImFzeW5jIiwKICAgICAgICAgIC8vIE5vdGU6IHRoZXJlIGlzIGEgc3BlY2lhbCBjYXNlIHRoYXQgcHJldmVudHMgaXQgZnJvbSBiZWluZyB3cml0dGVuIHRvIHRoZSBET00KICAgICAgICAgIC8vIG9uIHRoZSBjbGllbnQgc2lkZSBiZWNhdXNlIHRoZSBicm93c2VycyBhcmUgaW5jb25zaXN0ZW50LiBJbnN0ZWFkIHdlIGNhbGwgZm9jdXMoKS4KICAgICAgICAgICJhdXRvRm9jdXMiLAogICAgICAgICAgImF1dG9QbGF5IiwKICAgICAgICAgICJjb250cm9scyIsCiAgICAgICAgICAiZGVmYXVsdCIsCiAgICAgICAgICAiZGVmZXIiLAogICAgICAgICAgImRpc2FibGVkIiwKICAgICAgICAgICJkaXNhYmxlUGljdHVyZUluUGljdHVyZSIsCiAgICAgICAgICAiZGlzYWJsZVJlbW90ZVBsYXliYWNrIiwKICAgICAgICAgICJmb3JtTm9WYWxpZGF0ZSIsCiAgICAgICAgICAiaGlkZGVuIiwKICAgICAgICAgICJsb29wIiwKICAgICAgICAgICJub01vZHVsZSIsCiAgICAgICAgICAibm9WYWxpZGF0ZSIsCiAgICAgICAgICAib3BlbiIsCiAgICAgICAgICAicGxheXNJbmxpbmUiLAogICAgICAgICAgInJlYWRPbmx5IiwKICAgICAgICAgICJyZXF1aXJlZCIsCiAgICAgICAgICAicmV2ZXJzZWQiLAogICAgICAgICAgInNjb3BlZCIsCiAgICAgICAgICAic2VhbWxlc3MiLAogICAgICAgICAgLy8gTWljcm9kYXRhCiAgICAgICAgICAiaXRlbVNjb3BlIgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTiwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAiY2hlY2tlZCIsCiAgICAgICAgICAvLyBOb3RlOiBgb3B0aW9uLnNlbGVjdGVkYCBpcyBub3QgdXBkYXRlZCBpZiBgc2VsZWN0Lm11bHRpcGxlYCBpcwogICAgICAgICAgLy8gZGlzYWJsZWQgd2l0aCBgcmVtb3ZlQXR0cmlidXRlYC4gV2UgaGF2ZSBzcGVjaWFsIGxvZ2ljIGZvciBoYW5kbGluZyB0aGlzLgogICAgICAgICAgIm11bHRpcGxlIiwKICAgICAgICAgICJtdXRlZCIsCiAgICAgICAgICAic2VsZWN0ZWQiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIEJPT0xFQU4sCiAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImNhcHR1cmUiLAogICAgICAgICAgImRvd25sb2FkIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBPVkVSTE9BREVEX0JPT0xFQU4sCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJjb2xzIiwKICAgICAgICAgICJyb3dzIiwKICAgICAgICAgICJzaXplIiwKICAgICAgICAgICJzcGFuIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBQT1NJVElWRV9OVU1FUklDLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbInJvd1NwYW4iLCAic3RhcnQiXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBOVU1FUklDLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIHZhciBDQU1FTElaRSA9IC9bXC1cOl0oW2Etel0pL2c7CiAgICAgICAgdmFyIGNhcGl0YWxpemUgPSBmdW5jdGlvbih0b2tlbikgewogICAgICAgICAgcmV0dXJuIHRva2VuWzFdLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgfTsKICAgICAgICBbCiAgICAgICAgICAiYWNjZW50LWhlaWdodCIsCiAgICAgICAgICAiYWxpZ25tZW50LWJhc2VsaW5lIiwKICAgICAgICAgICJhcmFiaWMtZm9ybSIsCiAgICAgICAgICAiYmFzZWxpbmUtc2hpZnQiLAogICAgICAgICAgImNhcC1oZWlnaHQiLAogICAgICAgICAgImNsaXAtcGF0aCIsCiAgICAgICAgICAiY2xpcC1ydWxlIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uLWZpbHRlcnMiLAogICAgICAgICAgImNvbG9yLXByb2ZpbGUiLAogICAgICAgICAgImNvbG9yLXJlbmRlcmluZyIsCiAgICAgICAgICAiZG9taW5hbnQtYmFzZWxpbmUiLAogICAgICAgICAgImVuYWJsZS1iYWNrZ3JvdW5kIiwKICAgICAgICAgICJmaWxsLW9wYWNpdHkiLAogICAgICAgICAgImZpbGwtcnVsZSIsCiAgICAgICAgICAiZmxvb2QtY29sb3IiLAogICAgICAgICAgImZsb29kLW9wYWNpdHkiLAogICAgICAgICAgImZvbnQtZmFtaWx5IiwKICAgICAgICAgICJmb250LXNpemUiLAogICAgICAgICAgImZvbnQtc2l6ZS1hZGp1c3QiLAogICAgICAgICAgImZvbnQtc3RyZXRjaCIsCiAgICAgICAgICAiZm9udC1zdHlsZSIsCiAgICAgICAgICAiZm9udC12YXJpYW50IiwKICAgICAgICAgICJmb250LXdlaWdodCIsCiAgICAgICAgICAiZ2x5cGgtbmFtZSIsCiAgICAgICAgICAiZ2x5cGgtb3JpZW50YXRpb24taG9yaXpvbnRhbCIsCiAgICAgICAgICAiZ2x5cGgtb3JpZW50YXRpb24tdmVydGljYWwiLAogICAgICAgICAgImhvcml6LWFkdi14IiwKICAgICAgICAgICJob3Jpei1vcmlnaW4teCIsCiAgICAgICAgICAiaW1hZ2UtcmVuZGVyaW5nIiwKICAgICAgICAgICJsZXR0ZXItc3BhY2luZyIsCiAgICAgICAgICAibGlnaHRpbmctY29sb3IiLAogICAgICAgICAgIm1hcmtlci1lbmQiLAogICAgICAgICAgIm1hcmtlci1taWQiLAogICAgICAgICAgIm1hcmtlci1zdGFydCIsCiAgICAgICAgICAib3ZlcmxpbmUtcG9zaXRpb24iLAogICAgICAgICAgIm92ZXJsaW5lLXRoaWNrbmVzcyIsCiAgICAgICAgICAicGFpbnQtb3JkZXIiLAogICAgICAgICAgInBhbm9zZS0xIiwKICAgICAgICAgICJwb2ludGVyLWV2ZW50cyIsCiAgICAgICAgICAicmVuZGVyaW5nLWludGVudCIsCiAgICAgICAgICAic2hhcGUtcmVuZGVyaW5nIiwKICAgICAgICAgICJzdG9wLWNvbG9yIiwKICAgICAgICAgICJzdG9wLW9wYWNpdHkiLAogICAgICAgICAgInN0cmlrZXRocm91Z2gtcG9zaXRpb24iLAogICAgICAgICAgInN0cmlrZXRocm91Z2gtdGhpY2tuZXNzIiwKICAgICAgICAgICJzdHJva2UtZGFzaGFycmF5IiwKICAgICAgICAgICJzdHJva2UtZGFzaG9mZnNldCIsCiAgICAgICAgICAic3Ryb2tlLWxpbmVjYXAiLAogICAgICAgICAgInN0cm9rZS1saW5lam9pbiIsCiAgICAgICAgICAic3Ryb2tlLW1pdGVybGltaXQiLAogICAgICAgICAgInN0cm9rZS1vcGFjaXR5IiwKICAgICAgICAgICJzdHJva2Utd2lkdGgiLAogICAgICAgICAgInRleHQtYW5jaG9yIiwKICAgICAgICAgICJ0ZXh0LWRlY29yYXRpb24iLAogICAgICAgICAgInRleHQtcmVuZGVyaW5nIiwKICAgICAgICAgICJ1bmRlcmxpbmUtcG9zaXRpb24iLAogICAgICAgICAgInVuZGVybGluZS10aGlja25lc3MiLAogICAgICAgICAgInVuaWNvZGUtYmlkaSIsCiAgICAgICAgICAidW5pY29kZS1yYW5nZSIsCiAgICAgICAgICAidW5pdHMtcGVyLWVtIiwKICAgICAgICAgICJ2LWFscGhhYmV0aWMiLAogICAgICAgICAgInYtaGFuZ2luZyIsCiAgICAgICAgICAidi1pZGVvZ3JhcGhpYyIsCiAgICAgICAgICAidi1tYXRoZW1hdGljYWwiLAogICAgICAgICAgInZlY3Rvci1lZmZlY3QiLAogICAgICAgICAgInZlcnQtYWR2LXkiLAogICAgICAgICAgInZlcnQtb3JpZ2luLXgiLAogICAgICAgICAgInZlcnQtb3JpZ2luLXkiLAogICAgICAgICAgIndvcmQtc3BhY2luZyIsCiAgICAgICAgICAid3JpdGluZy1tb2RlIiwKICAgICAgICAgICJ4bWxuczp4bGluayIsCiAgICAgICAgICAieC1oZWlnaHQiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoQ0FNRUxJWkUsIGNhcGl0YWxpemUpOwogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJ4bGluazphY3R1YXRlIiwKICAgICAgICAgICJ4bGluazphcmNyb2xlIiwKICAgICAgICAgICJ4bGluazpyb2xlIiwKICAgICAgICAgICJ4bGluazpzaG93IiwKICAgICAgICAgICJ4bGluazp0aXRsZSIsCiAgICAgICAgICAieGxpbms6dHlwZSIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZU5hbWUucmVwbGFjZShDQU1FTElaRSwgY2FwaXRhbGl6ZSk7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJ4bWw6YmFzZSIsCiAgICAgICAgICAieG1sOmxhbmciLAogICAgICAgICAgInhtbDpzcGFjZSIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZU5hbWUucmVwbGFjZShDQU1FTElaRSwgY2FwaXRhbGl6ZSk7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgICJodHRwOi8vd3d3LnczLm9yZy9YTUwvMTk5OC9uYW1lc3BhY2UiLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWyJ0YWJJbmRleCIsICJjcm9zc09yaWdpbiJdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1thdHRyaWJ1dGVOYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgeGxpbmtIcmVmID0gInhsaW5rSHJlZiI7CiAgICAgICAgcHJvcGVydGllc1t4bGlua0hyZWZdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICJ4bGlua0hyZWYiLAogICAgICAgICAgU1RSSU5HLAogICAgICAgICAgZmFsc2UsCiAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICJ4bGluazpocmVmIiwKICAgICAgICAgICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiwKICAgICAgICAgIHRydWUsCiAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIFsic3JjIiwgImhyZWYiLCAiYWN0aW9uIiwgImZvcm1BY3Rpb24iXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbYXR0cmlidXRlTmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICB0cnVlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICB0cnVlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIHZhciBpc0phdmFTY3JpcHRQcm90b2NvbCA9IC9eW1x1MDAwMC1cdTAwMUYgXSpqW1xyXG5cdF0qYVtcclxuXHRdKnZbXHJcblx0XSphW1xyXG5cdF0qc1tcclxuXHRdKmNbXHJcblx0XSpyW1xyXG5cdF0qaVtcclxuXHRdKnBbXHJcblx0XSp0W1xyXG5cdF0qXDovaTsKICAgICAgICB2YXIgZGlkV2FybiA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHNhbml0aXplVVJMKHVybCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm4gJiYgaXNKYXZhU2NyaXB0UHJvdG9jb2wudGVzdCh1cmwpKSB7CiAgICAgICAgICAgICAgZGlkV2FybiA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoIkEgZnV0dXJlIHZlcnNpb24gb2YgUmVhY3Qgd2lsbCBibG9jayBqYXZhc2NyaXB0OiBVUkxzIGFzIGEgc2VjdXJpdHkgcHJlY2F1dGlvbi4gVXNlIGV2ZW50IGhhbmRsZXJzIGluc3RlYWQgaWYgeW91IGNhbi4gSWYgeW91IG5lZWQgdG8gZ2VuZXJhdGUgdW5zYWZlIEhUTUwgdHJ5IHVzaW5nIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIGluc3RlYWQuIFJlYWN0IHdhcyBwYXNzZWQgJXMuIiwgSlNPTi5zdHJpbmdpZnkodXJsKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmFsdWVGb3JQcm9wZXJ0eShub2RlLCBuYW1lLCBleHBlY3RlZCwgcHJvcGVydHlJbmZvKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8ubXVzdFVzZVByb3BlcnR5KSB7CiAgICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IHByb3BlcnR5SW5mby5wcm9wZXJ0eU5hbWU7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGVbcHJvcGVydHlOYW1lXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKGV4cGVjdGVkLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby5zYW5pdGl6ZVVSTCkgewogICAgICAgICAgICAgICAgc2FuaXRpemVVUkwoIiIgKyBleHBlY3RlZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVOYW1lID0gcHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWU7CiAgICAgICAgICAgICAgdmFyIHN0cmluZ1ZhbHVlID0gbnVsbDsKICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnR5cGUgPT09IE9WRVJMT0FERURfQk9PTEVBTikgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCBleHBlY3RlZCwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnR5cGUgPT09IEJPT0xFQU4pIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RyaW5nVmFsdWUgPSBub2RlLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCBleHBlY3RlZCwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmdWYWx1ZSA9PT0gbnVsbCA/IGV4cGVjdGVkIDogc3RyaW5nVmFsdWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJpbmdWYWx1ZSA9PT0gIiIgKyBleHBlY3RlZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RyaW5nVmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFZhbHVlRm9yQXR0cmlidXRlKG5vZGUsIG5hbWUsIGV4cGVjdGVkLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzQXR0cmlidXRlTmFtZVNhZmUobmFtZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFub2RlLmhhc0F0dHJpYnV0ZShuYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdmFsdWUgPSBub2RlLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24oZXhwZWN0ZWQsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gIiIgKyBleHBlY3RlZCkgewogICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgbmFtZSwgdmFsdWUsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICB2YXIgcHJvcGVydHlJbmZvID0gZ2V0UHJvcGVydHlJbmZvKG5hbWUpOwogICAgICAgICAgaWYgKHNob3VsZElnbm9yZUF0dHJpYnV0ZShuYW1lLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSkgewogICAgICAgICAgICB2YWx1ZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcgfHwgcHJvcGVydHlJbmZvID09PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChpc0F0dHJpYnV0ZU5hbWVTYWZlKG5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIF9hdHRyaWJ1dGVOYW1lID0gbmFtZTsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKF9hdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBuYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKF9hdHRyaWJ1dGVOYW1lLCAiIiArIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG11c3RVc2VQcm9wZXJ0eSA9IHByb3BlcnR5SW5mby5tdXN0VXNlUHJvcGVydHk7CiAgICAgICAgICBpZiAobXVzdFVzZVByb3BlcnR5KSB7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eUluZm8ucHJvcGVydHlOYW1lOwogICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgdHlwZSA9IHByb3BlcnR5SW5mby50eXBlOwogICAgICAgICAgICAgIG5vZGVbcHJvcGVydHlOYW1lXSA9IHR5cGUgPT09IEJPT0xFQU4gPyBmYWxzZSA6ICIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5vZGVbcHJvcGVydHlOYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhdHRyaWJ1dGVOYW1lID0gcHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZU5hbWVzcGFjZSA9IHByb3BlcnR5SW5mby5hdHRyaWJ1dGVOYW1lc3BhY2U7CiAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX3R5cGUgPSBwcm9wZXJ0eUluZm8udHlwZTsKICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZVZhbHVlOwogICAgICAgICAgICBpZiAoX3R5cGUgPT09IEJPT0xFQU4gfHwgX3R5cGUgPT09IE9WRVJMT0FERURfQk9PTEVBTiAmJiB2YWx1ZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIGF0dHJpYnV0ZVZhbHVlID0gIiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGF0dHJpYnV0ZVZhbHVlID0gIiIgKyB2YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby5zYW5pdGl6ZVVSTCkgewogICAgICAgICAgICAgICAgc2FuaXRpemVVUkwoYXR0cmlidXRlVmFsdWUudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVOYW1lc3BhY2UpIHsKICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZU5TKGF0dHJpYnV0ZU5hbWVzcGFjZSwgYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZVZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZWxlbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9QT1JUQUxfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnBvcnRhbCIpOwogICAgICAgIHZhciBSRUFDVF9GUkFHTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZnJhZ21lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfU1RSSUNUX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN0cmljdF9tb2RlIik7CiAgICAgICAgdmFyIFJFQUNUX1BST0ZJTEVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm9maWxlciIpOwogICAgICAgIHZhciBSRUFDVF9QUk9WSURFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvdmlkZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfQ09OVEVYVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY29udGV4dCIpOwogICAgICAgIHZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0LmZvcndhcmRfcmVmIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZSIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZV9saXN0Iik7CiAgICAgICAgdmFyIFJFQUNUX01FTU9fVFlQRTIgPSBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CiAgICAgICAgdmFyIFJFQUNUX0xBWllfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmxhenkiKTsKICAgICAgICB2YXIgUkVBQ1RfU0NPUEVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnNjb3BlIik7CiAgICAgICAgdmFyIFJFQUNUX0RFQlVHX1RSQUNJTkdfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZGVidWdfdHJhY2VfbW9kZSIpOwogICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgIHZhciBSRUFDVF9MRUdBQ1lfSElEREVOX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sZWdhY3lfaGlkZGVuIik7CiAgICAgICAgdmFyIFJFQUNUX0NBQ0hFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jYWNoZSIpOwogICAgICAgIHZhciBSRUFDVF9UUkFDSU5HX01BUktFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QudHJhY2luZ19tYXJrZXIiKTsKICAgICAgICB2YXIgTUFZQkVfSVRFUkFUT1JfU1lNQk9MID0gU3ltYm9sLml0ZXJhdG9yOwogICAgICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICJAQGl0ZXJhdG9yIjsKICAgICAgICBmdW5jdGlvbiBnZXRJdGVyYXRvckZuKG1heWJlSXRlcmFibGUpIHsKICAgICAgICAgIGlmIChtYXliZUl0ZXJhYmxlID09PSBudWxsIHx8IHR5cGVvZiBtYXliZUl0ZXJhYmxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXliZUl0ZXJhdG9yID0gTUFZQkVfSVRFUkFUT1JfU1lNQk9MICYmIG1heWJlSXRlcmFibGVbTUFZQkVfSVRFUkFUT1JfU1lNQk9MXSB8fCBtYXliZUl0ZXJhYmxlW0ZBVVhfSVRFUkFUT1JfU1lNQk9MXTsKICAgICAgICAgIGlmICh0eXBlb2YgbWF5YmVJdGVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gbWF5YmVJdGVyYXRvcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgYXNzaWduMiA9IE9iamVjdC5hc3NpZ247CiAgICAgICAgdmFyIGRpc2FibGVkRGVwdGggPSAwOwogICAgICAgIHZhciBwcmV2TG9nOwogICAgICAgIHZhciBwcmV2SW5mbzsKICAgICAgICB2YXIgcHJldldhcm47CiAgICAgICAgdmFyIHByZXZFcnJvcjsKICAgICAgICB2YXIgcHJldkdyb3VwOwogICAgICAgIHZhciBwcmV2R3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgdmFyIHByZXZHcm91cEVuZDsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlZExvZygpIHsKICAgICAgICB9CiAgICAgICAgZGlzYWJsZWRMb2cuX19yZWFjdERpc2FibGVkTG9nID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICBwcmV2TG9nID0gY29uc29sZS5sb2c7CiAgICAgICAgICAgICAgcHJldkluZm8gPSBjb25zb2xlLmluZm87CiAgICAgICAgICAgICAgcHJldldhcm4gPSBjb25zb2xlLndhcm47CiAgICAgICAgICAgICAgcHJldkVycm9yID0gY29uc29sZS5lcnJvcjsKICAgICAgICAgICAgICBwcmV2R3JvdXAgPSBjb25zb2xlLmdyb3VwOwogICAgICAgICAgICAgIHByZXZHcm91cENvbGxhcHNlZCA9IGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgICAgICAgcHJldkdyb3VwRW5kID0gY29uc29sZS5ncm91cEVuZDsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IGRpc2FibGVkTG9nLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGluZm86IHByb3BzLAogICAgICAgICAgICAgICAgbG9nOiBwcm9wcywKICAgICAgICAgICAgICAgIHdhcm46IHByb3BzLAogICAgICAgICAgICAgICAgZXJyb3I6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXA6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IHByb3BzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlzYWJsZWREZXB0aCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVuYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgtLTsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGxvZzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHdhcm46IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2V2FybgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBlcnJvcjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cENvbGxhcHNlZAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cEVuZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICB2YXIgcHJlZml4OwogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0geDIuc3RhY2sudHJpbSgpLm1hdGNoKC9cbiggKihhdCApPykvKTsKICAgICAgICAgICAgICAgIHByZWZpeCA9IG1hdGNoICYmIG1hdGNoWzFdIHx8ICIiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIlxuIiArIHByZWZpeCArIG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbXBvbmVudEZyYW1lQ2FjaGU7CiAgICAgICAgewogICAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCA9IHR5cGVvZiBXZWFrTWFwID09PSAiZnVuY3Rpb24iID8gV2Vha01hcCA6IE1hcDsKICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGNvbnN0cnVjdCkgewogICAgICAgICAgaWYgKCFmbiB8fCByZWVudHJ5KSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZyYW1lID0gY29tcG9uZW50RnJhbWVDYWNoZS5nZXQoZm4pOwogICAgICAgICAgICBpZiAoZnJhbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiBmcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRyb2w7CiAgICAgICAgICByZWVudHJ5ID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlID0gRXJyb3IucHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHZvaWQgMDsKICAgICAgICAgIHZhciBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByZXZpb3VzRGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudDsKICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgZGlzYWJsZUxvZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChjb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICB2YXIgRmFrZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShGYWtlLnByb3RvdHlwZSwgInByb3BzIiwgewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09ICJvYmplY3QiICYmIFJlZmxlY3QuY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChGYWtlLCBbXSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChmbiwgW10sIEZha2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBGYWtlLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChzYW1wbGUpIHsKICAgICAgICAgICAgaWYgKHNhbXBsZSAmJiBjb250cm9sICYmIHR5cGVvZiBzYW1wbGUuc3RhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgdmFyIHNhbXBsZUxpbmVzID0gc2FtcGxlLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBjb250cm9sTGluZXMgPSBjb250cm9sLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBzID0gc2FtcGxlTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB2YXIgYyA9IGNvbnRyb2xMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHdoaWxlIChzID49IDEgJiYgYyA+PSAwICYmIHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICg7IHMgPj0gMSAmJiBjID49IDA7IHMtLSwgYy0tKSB7CiAgICAgICAgICAgICAgICBpZiAoc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICBpZiAocyAhPT0gMSB8fCBjICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgcy0tOwogICAgICAgICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGMgPCAwIHx8IHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9mcmFtZSA9ICJcbiIgKyBzYW1wbGVMaW5lc1tzXS5yZXBsYWNlKCIgYXQgbmV3ICIsICIgYXQgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbi5kaXNwbGF5TmFtZSAmJiBfZnJhbWUuaW5jbHVkZXMoIjxhbm9ueW1vdXM+IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBfZnJhbWUgPSBfZnJhbWUucmVwbGFjZSgiPGFub255bW91cz4iLCBmbi5kaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBfZnJhbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2ZyYW1lOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKHMgPj0gMSAmJiBjID49IDApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50ID0gcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgICAgIHJlZW5hYmxlTG9ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lID0gZm4gPyBmbi5kaXNwbGF5TmFtZSB8fCBmbi5uYW1lIDogIiI7CiAgICAgICAgICB2YXIgc3ludGhldGljRnJhbWUgPSBuYW1lID8gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSkgOiAiIjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBzeW50aGV0aWNGcmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzeW50aGV0aWNGcmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVDbGFzc0NvbXBvbmVudEZyYW1lKGN0b3IsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShjdG9yLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZuLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0KENvbXBvbmVudCkgewogICAgICAgICAgdmFyIHByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgICByZXR1cm4gISEocHJvdG90eXBlICYmIHByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKHR5cGUsIHNob3VsZENvbnN0cnVjdCh0eXBlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKHR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGaWJlcihmaWJlcikgewogICAgICAgICAgdmFyIG93bmVyID0gZmliZXIuX2RlYnVnT3duZXIgPyBmaWJlci5fZGVidWdPd25lci50eXBlIDogbnVsbDsKICAgICAgICAgIHZhciBzb3VyY2UgPSBmaWJlci5fZGVidWdTb3VyY2U7CiAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUpOwogICAgICAgICAgICBjYXNlIExhenlDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJMYXp5Iik7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlTGlzdCIpOwogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUpOwogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZS5yZW5kZXIpOwogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUNsYXNzQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdGFja0J5RmliZXJJbkRldkFuZFByb2Qod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICB2YXIgbm9kZSA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGluZm8gKz0gZGVzY3JpYmVGaWJlcihub2RlKTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0gd2hpbGUgKG5vZGUpOwogICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgIHJldHVybiAiXG5FcnJvciBnZW5lcmF0aW5nIHN0YWNrOiAiICsgeDIubWVzc2FnZSArICJcbiIgKyB4Mi5zdGFjazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUob3V0ZXJUeXBlLCBpbm5lclR5cGUsIHdyYXBwZXJOYW1lKSB7CiAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSBvdXRlclR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICBpZiAoZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlLnRhZyA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgYW4gdW5leHBlY3RlZCBvYmplY3QgaW4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKCkuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQb3J0YWwiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQcm9maWxlciI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN0cmljdE1vZGUiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2VMaXN0IjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05URVhUX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUoY29udGV4dCkgKyAiLkNvbnN1bWVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZSQxKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBvdXRlclR5cGUuZGlzcGxheU5hbWUgfHwgKGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUkMSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciB0YWcgPSBmaWJlci50YWcsIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIkNhY2hlIjsKICAgICAgICAgICAgY2FzZSBDb250ZXh0Q29uc3VtZXI6CiAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0eXBlOwogICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZSQxKGNvbnRleHQpICsgIi5Db25zdW1lciI7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lJDEocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgIGNhc2UgRGVoeWRyYXRlZEZyYWdtZW50OgogICAgICAgICAgICAgIHJldHVybiAiRGVoeWRyYXRlZEZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUkMSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgY2FzZSBGcmFnbWVudDk6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICByZXR1cm4gIlJvb3QiOwogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHJldHVybiAiVGV4dCI7CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiAiTW9kZSI7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiAiT2Zmc2NyZWVuIjsKICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlNjb3BlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJUcmFjaW5nTWFya2VyIjsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICB2YXIgY3VycmVudDMgPSBudWxsOwogICAgICAgIHZhciBpc1JlbmRlcmluZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb3duZXIgPSBjdXJyZW50My5fZGVidWdPd25lcjsKICAgICAgICAgICAgaWYgKG93bmVyICE9PSBudWxsICYmIHR5cGVvZiBvd25lciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXJTdGFja0luRGV2KCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGdldFN0YWNrQnlGaWJlckluRGV2QW5kUHJvZChjdXJyZW50Myk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0Q3VycmVudEZpYmVyKCkgewogICAgICAgICAgewogICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnQzID0gbnVsbDsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrID0gZmliZXIgPT09IG51bGwgPyBudWxsIDogZ2V0Q3VycmVudEZpYmVyU3RhY2tJbkRldjsKICAgICAgICAgICAgY3VycmVudDMgPSBmaWJlcjsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gY3VycmVudDM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldElzUmVuZGVyaW5nKHJlbmRlcmluZykgewogICAgICAgICAgewogICAgICAgICAgICBpc1JlbmRlcmluZyA9IHJlbmRlcmluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG9TdHJpbmcodmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUb1N0cmluZ1ZhbHVlKHZhbHVlKSB7CiAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgICAgICBjYXNlICJib29sZWFuIjoKICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGhhc1JlYWRPbmx5VmFsdWUgPSB7CiAgICAgICAgICBidXR0b246IHRydWUsCiAgICAgICAgICBjaGVja2JveDogdHJ1ZSwKICAgICAgICAgIGltYWdlOiB0cnVlLAogICAgICAgICAgaGlkZGVuOiB0cnVlLAogICAgICAgICAgcmFkaW86IHRydWUsCiAgICAgICAgICByZXNldDogdHJ1ZSwKICAgICAgICAgIHN1Ym1pdDogdHJ1ZQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY2hlY2tDb250cm9sbGVkVmFsdWVQcm9wcyh0YWdOYW1lLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIShoYXNSZWFkT25seVZhbHVlW3Byb3BzLnR5cGVdIHx8IHByb3BzLm9uQ2hhbmdlIHx8IHByb3BzLm9uSW5wdXQgfHwgcHJvcHMucmVhZE9ubHkgfHwgcHJvcHMuZGlzYWJsZWQgfHwgcHJvcHMudmFsdWUgPT0gbnVsbCkpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHByb3ZpZGVkIGEgYHZhbHVlYCBwcm9wIHRvIGEgZm9ybSBmaWVsZCB3aXRob3V0IGFuIGBvbkNoYW5nZWAgaGFuZGxlci4gVGhpcyB3aWxsIHJlbmRlciBhIHJlYWQtb25seSBmaWVsZC4gSWYgdGhlIGZpZWxkIHNob3VsZCBiZSBtdXRhYmxlIHVzZSBgZGVmYXVsdFZhbHVlYC4gT3RoZXJ3aXNlLCBzZXQgZWl0aGVyIGBvbkNoYW5nZWAgb3IgYHJlYWRPbmx5YC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIShwcm9wcy5vbkNoYW5nZSB8fCBwcm9wcy5yZWFkT25seSB8fCBwcm9wcy5kaXNhYmxlZCB8fCBwcm9wcy5jaGVja2VkID09IG51bGwpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwcm92aWRlZCBhIGBjaGVja2VkYCBwcm9wIHRvIGEgZm9ybSBmaWVsZCB3aXRob3V0IGFuIGBvbkNoYW5nZWAgaGFuZGxlci4gVGhpcyB3aWxsIHJlbmRlciBhIHJlYWQtb25seSBmaWVsZC4gSWYgdGhlIGZpZWxkIHNob3VsZCBiZSBtdXRhYmxlIHVzZSBgZGVmYXVsdENoZWNrZWRgLiBPdGhlcndpc2UsIHNldCBlaXRoZXIgYG9uQ2hhbmdlYCBvciBgcmVhZE9ubHlgLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ2hlY2thYmxlKGVsZW0pIHsKICAgICAgICAgIHZhciB0eXBlID0gZWxlbS50eXBlOwogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZSAmJiBub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmICh0eXBlID09PSAiY2hlY2tib3giIHx8IHR5cGUgPT09ICJyYWRpbyIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUcmFja2VyKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlLl92YWx1ZVRyYWNrZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaFRyYWNrZXIobm9kZSkgewogICAgICAgICAgbm9kZS5fdmFsdWVUcmFja2VyID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmFsdWVGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSAiIjsKICAgICAgICAgIGlmICghbm9kZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDaGVja2FibGUobm9kZSkpIHsKICAgICAgICAgICAgdmFsdWUgPSBub2RlLmNoZWNrZWQgPyAidHJ1ZSIgOiAiZmFsc2UiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUgPSBub2RlLnZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFja1ZhbHVlT25Ob2RlKG5vZGUpIHsKICAgICAgICAgIHZhciB2YWx1ZUZpZWxkID0gaXNDaGVja2FibGUobm9kZSkgPyAiY2hlY2tlZCIgOiAidmFsdWUiOwogICAgICAgICAgdmFyIGRlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG5vZGUuY29uc3RydWN0b3IucHJvdG90eXBlLCB2YWx1ZUZpZWxkKTsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKG5vZGVbdmFsdWVGaWVsZF0pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9ICIiICsgbm9kZVt2YWx1ZUZpZWxkXTsKICAgICAgICAgIGlmIChub2RlLmhhc093blByb3BlcnR5KHZhbHVlRmllbGQpIHx8IHR5cGVvZiBkZXNjcmlwdG9yID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgZGVzY3JpcHRvci5nZXQgIT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGRlc2NyaXB0b3Iuc2V0ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBnZXQ2ID0gZGVzY3JpcHRvci5nZXQsIHNldDQgPSBkZXNjcmlwdG9yLnNldDsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShub2RlLCB2YWx1ZUZpZWxkLCB7CiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Ni5jYWxsKHRoaXMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudFZhbHVlID0gIiIgKyB2YWx1ZTsKICAgICAgICAgICAgICBzZXQ0LmNhbGwodGhpcywgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShub2RlLCB2YWx1ZUZpZWxkLCB7CiAgICAgICAgICAgIGVudW1lcmFibGU6IGRlc2NyaXB0b3IuZW51bWVyYWJsZQogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgdHJhY2tlciA9IHsKICAgICAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VmFsdWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9ICIiICsgdmFsdWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0b3BUcmFja2luZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZGV0YWNoVHJhY2tlcihub2RlKTsKICAgICAgICAgICAgICBkZWxldGUgbm9kZVt2YWx1ZUZpZWxkXTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB0cmFja2VyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFjayhub2RlKSB7CiAgICAgICAgICBpZiAoZ2V0VHJhY2tlcihub2RlKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl92YWx1ZVRyYWNrZXIgPSB0cmFja1ZhbHVlT25Ob2RlKG5vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVWYWx1ZUlmQ2hhbmdlZChub2RlKSB7CiAgICAgICAgICBpZiAoIW5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRyYWNrZXIgPSBnZXRUcmFja2VyKG5vZGUpOwogICAgICAgICAgaWYgKCF0cmFja2VyKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhc3RWYWx1ZSA9IHRyYWNrZXIuZ2V0VmFsdWUoKTsKICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBnZXRWYWx1ZUZyb21Ob2RlKG5vZGUpOwogICAgICAgICAgaWYgKG5leHRWYWx1ZSAhPT0gbGFzdFZhbHVlKSB7CiAgICAgICAgICAgIHRyYWNrZXIuc2V0VmFsdWUobmV4dFZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEFjdGl2ZUVsZW1lbnQoZG9jKSB7CiAgICAgICAgICBkb2MgPSBkb2MgfHwgKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgPyBkb2N1bWVudCA6IHZvaWQgMCk7CiAgICAgICAgICBpZiAodHlwZW9mIGRvYyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZG9jLmFjdGl2ZUVsZW1lbnQgfHwgZG9jLmJvZHk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBkb2MuYm9keTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5WYWx1ZURlZmF1bHRWYWx1ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5Db250cm9sbGVkVG9VbmNvbnRyb2xsZWQgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGlzQ29udHJvbGxlZChwcm9wcykgewogICAgICAgICAgdmFyIHVzZXNDaGVja2VkID0gcHJvcHMudHlwZSA9PT0gImNoZWNrYm94IiB8fCBwcm9wcy50eXBlID09PSAicmFkaW8iOwogICAgICAgICAgcmV0dXJuIHVzZXNDaGVja2VkID8gcHJvcHMuY2hlY2tlZCAhPSBudWxsIDogcHJvcHMudmFsdWUgIT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFByb3BzKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgY2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CiAgICAgICAgICB2YXIgaG9zdFByb3BzID0gYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgZGVmYXVsdENoZWNrZWQ6IHZvaWQgMCwKICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGNoZWNrZWQ6IGNoZWNrZWQgIT0gbnVsbCA/IGNoZWNrZWQgOiBub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbENoZWNrZWQKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NvbnRyb2xsZWRWYWx1ZVByb3BzKCJpbnB1dCIsIHByb3BzKTsKICAgICAgICAgICAgaWYgKHByb3BzLmNoZWNrZWQgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0Q2hlY2tlZCAhPT0gdm9pZCAwICYmICFkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIGNoZWNrZWQgYW5kIGRlZmF1bHRDaGVja2VkIHByb3BzLiBJbnB1dCBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIGNoZWNrZWQgcHJvcCwgb3IgdGhlIGRlZmF1bHRDaGVja2VkIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgaW5wdXQgZWxlbWVudCBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIiwgZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB8fCAiQSBjb21wb25lbnQiLCBwcm9wcy50eXBlKTsKICAgICAgICAgICAgICBkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIHZhbHVlIGFuZCBkZWZhdWx0VmFsdWUgcHJvcHMuIElucHV0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgdmFsdWUgcHJvcCwgb3IgdGhlIGRlZmF1bHRWYWx1ZSBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIGlucHV0IGVsZW1lbnQgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50IiwgcHJvcHMudHlwZSk7CiAgICAgICAgICAgICAgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZSA9PSBudWxsID8gIiIgOiBwcm9wcy5kZWZhdWx0VmFsdWU7CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIGluaXRpYWxDaGVja2VkOiBwcm9wcy5jaGVja2VkICE9IG51bGwgPyBwcm9wcy5jaGVja2VkIDogcHJvcHMuZGVmYXVsdENoZWNrZWQsCiAgICAgICAgICAgIGluaXRpYWxWYWx1ZTogZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSAhPSBudWxsID8gcHJvcHMudmFsdWUgOiBkZWZhdWx0VmFsdWUpLAogICAgICAgICAgICBjb250cm9sbGVkOiBpc0NvbnRyb2xsZWQocHJvcHMpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDaGVja2VkKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgY2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CiAgICAgICAgICBpZiAoY2hlY2tlZCAhPSBudWxsKSB7CiAgICAgICAgICAgIHNldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgImNoZWNrZWQiLCBjaGVja2VkLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdyYXBwZXIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNvbnRyb2xsZWQgPSBpc0NvbnRyb2xsZWQocHJvcHMpOwogICAgICAgICAgICBpZiAoIW5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmIGNvbnRyb2xsZWQgJiYgIWRpZFdhcm5VbmNvbnRyb2xsZWRUb0NvbnRyb2xsZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb21wb25lbnQgaXMgY2hhbmdpbmcgYW4gdW5jb250cm9sbGVkIGlucHV0IHRvIGJlIGNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSB1bmRlZmluZWQgdG8gYSBkZWZpbmVkIHZhbHVlLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmICFjb250cm9sbGVkICYmICFkaWRXYXJuQ29udHJvbGxlZFRvVW5jb250cm9sbGVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGNoYW5naW5nIGEgY29udHJvbGxlZCBpbnB1dCB0byBiZSB1bmNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSBhIGRlZmluZWQgdG8gdW5kZWZpbmVkLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FybkNvbnRyb2xsZWRUb1VuY29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZUNoZWNrZWQoZWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgdmFyIHZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSk7CiAgICAgICAgICB2YXIgdHlwZSA9IHByb3BzLnR5cGU7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IDAgJiYgbm9kZS52YWx1ZSA9PT0gIiIgfHwgLy8gV2UgZXhwbGljaXRseSB3YW50IHRvIGNvZXJjZSB0byBudW1iZXIgaGVyZSBpZiBwb3NzaWJsZS4KICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUKICAgICAgICAgICAgICBub2RlLnZhbHVlICE9IHZhbHVlKSB7CiAgICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJzdWJtaXQiIHx8IHR5cGUgPT09ICJyZXNldCIpIHsKICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoInZhbHVlIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLmhhc093blByb3BlcnR5KCJ2YWx1ZSIpKSB7CiAgICAgICAgICAgICAgc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHByb3BzLnR5cGUsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgICBzZXREZWZhdWx0VmFsdWUobm9kZSwgcHJvcHMudHlwZSwgZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy5kZWZhdWx0VmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMuY2hlY2tlZCA9PSBudWxsICYmIHByb3BzLmRlZmF1bHRDaGVja2VkICE9IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRDaGVja2VkID0gISFwcm9wcy5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyKGVsZW1lbnQsIHByb3BzLCBpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgidmFsdWUiKSB8fCBwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBwcm9wcy50eXBlOwogICAgICAgICAgICB2YXIgaXNCdXR0b24gPSB0eXBlID09PSAic3VibWl0IiB8fCB0eXBlID09PSAicmVzZXQiOwogICAgICAgICAgICBpZiAoaXNCdXR0b24gJiYgKHByb3BzLnZhbHVlID09PSB2b2lkIDAgfHwgcHJvcHMudmFsdWUgPT09IG51bGwpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbml0aWFsVmFsdWUgPSB0b1N0cmluZyhub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlICE9PSBub2RlLnZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUudmFsdWUgPSBpbml0aWFsVmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IGluaXRpYWxWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBub2RlLm5hbWU7CiAgICAgICAgICBpZiAobmFtZSAhPT0gIiIpIHsKICAgICAgICAgICAgbm9kZS5uYW1lID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG5vZGUuZGVmYXVsdENoZWNrZWQgPSAhbm9kZS5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0Q2hlY2tlZCA9ICEhbm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxDaGVja2VkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWUgIT09ICIiKSB7CiAgICAgICAgICAgIG5vZGUubmFtZSA9IG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHVwZGF0ZVdyYXBwZXIobm9kZSwgcHJvcHMpOwogICAgICAgICAgdXBkYXRlTmFtZWRDb3VzaW5zKG5vZGUsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTmFtZWRDb3VzaW5zKHJvb3ROb2RlLCBwcm9wcykgewogICAgICAgICAgdmFyIG5hbWUgPSBwcm9wcy5uYW1lOwogICAgICAgICAgaWYgKHByb3BzLnR5cGUgPT09ICJyYWRpbyIgJiYgbmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciBxdWVyeVJvb3QgPSByb290Tm9kZTsKICAgICAgICAgICAgd2hpbGUgKHF1ZXJ5Um9vdC5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgcXVlcnlSb290ID0gcXVlcnlSb290LnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24obmFtZSwgIm5hbWUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZ3JvdXAgPSBxdWVyeVJvb3QucXVlcnlTZWxlY3RvckFsbCgiaW5wdXRbbmFtZT0iICsgSlNPTi5zdHJpbmdpZnkoIiIgKyBuYW1lKSArICddW3R5cGU9InJhZGlvIl0nKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBncm91cC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBvdGhlck5vZGUgPSBncm91cFtpXTsKICAgICAgICAgICAgICBpZiAob3RoZXJOb2RlID09PSByb290Tm9kZSB8fCBvdGhlck5vZGUuZm9ybSAhPT0gcm9vdE5vZGUuZm9ybSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBvdGhlclByb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShvdGhlck5vZGUpOwogICAgICAgICAgICAgIGlmICghb3RoZXJQcm9wcykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdERPTUlucHV0OiBNaXhpbmcgUmVhY3QgYW5kIG5vbi1SZWFjdCByYWRpbyBpbnB1dHMgd2l0aCB0aGUgc2FtZSBgbmFtZWAgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlVmFsdWVJZkNoYW5nZWQob3RoZXJOb2RlKTsKICAgICAgICAgICAgICB1cGRhdGVXcmFwcGVyKG90aGVyTm9kZSwgb3RoZXJQcm9wcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIEZvY3VzZWQgbnVtYmVyIGlucHV0cyBzeW5jaHJvbml6ZSBvbiBibHVyLiBTZWUgQ2hhbmdlRXZlbnRQbHVnaW4uanMKICAgICAgICAgICAgdHlwZSAhPT0gIm51bWJlciIgfHwgZ2V0QWN0aXZlRWxlbWVudChub2RlLm93bmVyRG9jdW1lbnQpICE9PSBub2RlCiAgICAgICAgICApIHsKICAgICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuZGVmYXVsdFZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkludmFsaWRDaGlsZCA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuSW52YWxpZElubmVySFRNTCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcHMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLnZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAib2JqZWN0IiAmJiBwcm9wcy5jaGlsZHJlbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgUmVhY3QzOC5DaGlsZHJlbi5mb3JFYWNoKHByb3BzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkID09PSAic3RyaW5nIiB8fCB0eXBlb2YgY2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkludmFsaWRDaGlsZCkgewogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgaW5mZXIgdGhlIG9wdGlvbiB2YWx1ZSBvZiBjb21wbGV4IGNoaWxkcmVuLiBQYXNzIGEgYHZhbHVlYCBwcm9wIG9yIHVzZSBhIHBsYWluIHN0cmluZyBhcyBjaGlsZHJlbiB0byA8b3B0aW9uPi4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5JbnZhbGlkSW5uZXJIVE1MKSB7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSW5uZXJIVE1MID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlBhc3MgYSBgdmFsdWVgIHByb3AgaWYgeW91IHNldCBkYW5nZXJvdXNseUlubmVySFRNTCBzbyBSZWFjdCBrbm93cyB3aGljaCB2YWx1ZSBzaG91bGQgYmUgc2VsZWN0ZWQuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcy5zZWxlY3RlZCAhPSBudWxsICYmICFkaWRXYXJuU2VsZWN0ZWRTZXRPbk9wdGlvbikgewogICAgICAgICAgICAgIGVycm9yKCJVc2UgdGhlIGBkZWZhdWx0VmFsdWVgIG9yIGB2YWx1ZWAgcHJvcHMgb24gPHNlbGVjdD4gaW5zdGVhZCBvZiBzZXR0aW5nIGBzZWxlY3RlZGAgb24gPG9wdGlvbj4uIik7CiAgICAgICAgICAgICAgZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvc3RNb3VudFdyYXBwZXIkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgaWYgKHByb3BzLnZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoInZhbHVlIiwgdG9TdHJpbmcoZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSkpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzQXJyYXlJbXBsID0gQXJyYXkuaXNBcnJheTsKICAgICAgICBmdW5jdGlvbiBpc0FycmF5MihhKSB7CiAgICAgICAgICByZXR1cm4gaXNBcnJheUltcGwoYSk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSB7CiAgICAgICAgICB2YXIgb3duZXJOYW1lID0gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKTsKICAgICAgICAgIGlmIChvd25lck5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBvd25lck5hbWUgKyAiYC4iOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgdmFsdWVQcm9wTmFtZXMgPSBbInZhbHVlIiwgImRlZmF1bHRWYWx1ZSJdOwogICAgICAgIGZ1bmN0aW9uIGNoZWNrU2VsZWN0UHJvcFR5cGVzKHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInNlbGVjdCIsIHByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YWx1ZVByb3BOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBwcm9wTmFtZSA9IHZhbHVlUHJvcE5hbWVzW2ldOwogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBwcm9wTmFtZUlzQXJyYXkgPSBpc0FycmF5Mihwcm9wc1twcm9wTmFtZV0pOwogICAgICAgICAgICAgIGlmIChwcm9wcy5tdWx0aXBsZSAmJiAhcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGFuIGFycmF5IGlmIGBtdWx0aXBsZWAgaXMgdHJ1ZS4lcyIsIHByb3BOYW1lLCBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghcHJvcHMubXVsdGlwbGUgJiYgcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGEgc2NhbGFyIHZhbHVlIGlmIGBtdWx0aXBsZWAgaXMgZmFsc2UuJXMiLCBwcm9wTmFtZSwgZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVPcHRpb25zMihub2RlLCBtdWx0aXBsZSwgcHJvcFZhbHVlLCBzZXREZWZhdWx0U2VsZWN0ZWQpIHsKICAgICAgICAgIHZhciBvcHRpb25zMiA9IG5vZGUub3B0aW9uczsKICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICB2YXIgc2VsZWN0ZWRWYWx1ZXMgPSBwcm9wVmFsdWU7CiAgICAgICAgICAgIHZhciBzZWxlY3RlZFZhbHVlID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VsZWN0ZWRWYWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBzZWxlY3RlZFZhbHVlWyIkIiArIHNlbGVjdGVkVmFsdWVzW2ldXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IG9wdGlvbnMyLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgIHZhciBzZWxlY3RlZCA9IHNlbGVjdGVkVmFsdWUuaGFzT3duUHJvcGVydHkoIiQiICsgb3B0aW9uczJbX2ldLnZhbHVlKTsKICAgICAgICAgICAgICBpZiAob3B0aW9uczJbX2ldLnNlbGVjdGVkICE9PSBzZWxlY3RlZCkgewogICAgICAgICAgICAgICAgb3B0aW9uczJbX2ldLnNlbGVjdGVkID0gc2VsZWN0ZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzZWxlY3RlZCAmJiBzZXREZWZhdWx0U2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pXS5kZWZhdWx0U2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIF9zZWxlY3RlZFZhbHVlID0gdG9TdHJpbmcoZ2V0VG9TdHJpbmdWYWx1ZShwcm9wVmFsdWUpKTsKICAgICAgICAgICAgdmFyIGRlZmF1bHRTZWxlY3RlZCA9IG51bGw7CiAgICAgICAgICAgIGZvciAodmFyIF9pMiA9IDA7IF9pMiA8IG9wdGlvbnMyLmxlbmd0aDsgX2kyKyspIHsKICAgICAgICAgICAgICBpZiAob3B0aW9uczJbX2kyXS52YWx1ZSA9PT0gX3NlbGVjdGVkVmFsdWUpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pMl0uc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHNldERlZmF1bHRTZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICBvcHRpb25zMltfaTJdLmRlZmF1bHRTZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkZWZhdWx0U2VsZWN0ZWQgPT09IG51bGwgJiYgIW9wdGlvbnMyW19pMl0uZGlzYWJsZWQpIHsKICAgICAgICAgICAgICAgIGRlZmF1bHRTZWxlY3RlZCA9IG9wdGlvbnMyW19pMl07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWZhdWx0U2VsZWN0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBkZWZhdWx0U2VsZWN0ZWQuc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICByZXR1cm4gYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgdmFsdWU6IHZvaWQgMAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRXcmFwcGVyU3RhdGUkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgewogICAgICAgICAgICBjaGVja1NlbGVjdFByb3BUeXBlcyhwcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIHdhc011bHRpcGxlOiAhIXByb3BzLm11bHRpcGxlCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDEpIHsKICAgICAgICAgICAgICBlcnJvcigiU2VsZWN0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgdmFsdWUgcHJvcCwgb3IgdGhlIGRlZmF1bHRWYWx1ZSBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIHNlbGVjdCBlbGVtZW50IGFuZCByZW1vdmUgb25lIG9mIHRoZXNlIHByb3BzLiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiKTsKICAgICAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdE1vdW50V3JhcHBlciQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICBub2RlLm11bHRpcGxlID0gISFwcm9wcy5tdWx0aXBsZTsKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgcHJvcHMuZGVmYXVsdFZhbHVlLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdFVwZGF0ZVdyYXBwZXIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB3YXNNdWx0aXBsZSA9IG5vZGUuX3dyYXBwZXJTdGF0ZS53YXNNdWx0aXBsZTsKICAgICAgICAgIG5vZGUuX3dyYXBwZXJTdGF0ZS53YXNNdWx0aXBsZSA9ICEhcHJvcHMubXVsdGlwbGU7CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHdhc011bHRpcGxlICE9PSAhIXByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgIGlmIChwcm9wcy5kZWZhdWx0VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHByb3BzLmRlZmF1bHRWYWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgcHJvcHMubXVsdGlwbGUgPyBbXSA6ICIiLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsRGVmYXVsdFZhbCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICBpZiAocHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImBkYW5nZXJvdXNseVNldElubmVySFRNTGAgZG9lcyBub3QgbWFrZSBzZW5zZSBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhvc3RQcm9wcyA9IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGRlZmF1bHRWYWx1ZTogdm9pZCAwLAogICAgICAgICAgICBjaGlsZHJlbjogdG9TdHJpbmcobm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSkKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZSQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInRleHRhcmVhIiwgcHJvcHMpOwogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbERlZmF1bHRWYWwpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgY29udGFpbnMgYSB0ZXh0YXJlYSB3aXRoIGJvdGggdmFsdWUgYW5kIGRlZmF1bHRWYWx1ZSBwcm9wcy4gVGV4dGFyZWEgZWxlbWVudHMgbXVzdCBiZSBlaXRoZXIgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgKHNwZWNpZnkgZWl0aGVyIHRoZSB2YWx1ZSBwcm9wLCBvciB0aGUgZGVmYXVsdFZhbHVlIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgdGV4dGFyZWEgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgZGlkV2FyblZhbERlZmF1bHRWYWwgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5pdGlhbFZhbHVlID0gcHJvcHMudmFsdWU7CiAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gcHJvcHMuY2hpbGRyZW4sIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgaWYgKGNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiVXNlIHRoZSBgZGVmYXVsdFZhbHVlYCBvciBgdmFsdWVgIHByb3BzIGluc3RlYWQgb2Ygc2V0dGluZyBjaGlsZHJlbiBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJZiB5b3Ugc3VwcGx5IGBkZWZhdWx0VmFsdWVgIG9uIGEgPHRleHRhcmVhPiwgZG8gbm90IHBhc3MgY2hpbGRyZW4uIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaXNBcnJheTIoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCI8dGV4dGFyZWE+IGNhbiBvbmx5IGhhdmUgYXQgbW9zdCBvbmUgY2hpbGQuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2hpbGRyZW4gPSBjaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlZmF1bHRWYWx1ZSA9IGNoaWxkcmVuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBkZWZhdWx0VmFsdWUgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbml0aWFsVmFsdWUgPSBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIGluaXRpYWxWYWx1ZTogZ2V0VG9TdHJpbmdWYWx1ZShpbml0aWFsVmFsdWUpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVXcmFwcGVyJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB2YWx1ZSA9IGdldFRvU3RyaW5nVmFsdWUocHJvcHMudmFsdWUpOwogICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IGdldFRvU3RyaW5nVmFsdWUocHJvcHMuZGVmYXVsdFZhbHVlKTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgaWYgKG5ld1ZhbHVlICE9PSBub2RlLnZhbHVlKSB7CiAgICAgICAgICAgICAgbm9kZS52YWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcy5kZWZhdWx0VmFsdWUgPT0gbnVsbCAmJiBub2RlLmRlZmF1bHRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0VmFsdWUgPSB0b1N0cmluZyhkZWZhdWx0VmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyJDMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB0ZXh0Q29udGVudCA9IG5vZGUudGV4dENvbnRlbnQ7CiAgICAgICAgICBpZiAodGV4dENvbnRlbnQgPT09IG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgaWYgKHRleHRDb250ZW50ICE9PSAiIiAmJiB0ZXh0Q29udGVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUudmFsdWUgPSB0ZXh0Q29udGVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHVwZGF0ZVdyYXBwZXIkMShlbGVtZW50LCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIHZhciBIVE1MX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIjsKICAgICAgICB2YXIgTUFUSF9OQU1FU1BBQ0UgPSAiaHR0cDovL3d3dy53My5vcmcvMTk5OC9NYXRoL01hdGhNTCI7CiAgICAgICAgdmFyIFNWR19OQU1FU1BBQ0UgPSAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciOwogICAgICAgIGZ1bmN0aW9uIGdldEludHJpbnNpY05hbWVzcGFjZSh0eXBlKSB7CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSAic3ZnIjoKICAgICAgICAgICAgICByZXR1cm4gU1ZHX05BTUVTUEFDRTsKICAgICAgICAgICAgY2FzZSAibWF0aCI6CiAgICAgICAgICAgICAgcmV0dXJuIE1BVEhfTkFNRVNQQUNFOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBIVE1MX05BTUVTUEFDRTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q2hpbGROYW1lc3BhY2UocGFyZW50TmFtZXNwYWNlLCB0eXBlKSB7CiAgICAgICAgICBpZiAocGFyZW50TmFtZXNwYWNlID09IG51bGwgfHwgcGFyZW50TmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICByZXR1cm4gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcmVudE5hbWVzcGFjZSA9PT0gU1ZHX05BTUVTUEFDRSAmJiB0eXBlID09PSAiZm9yZWlnbk9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIEhUTUxfTkFNRVNQQUNFOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhcmVudE5hbWVzcGFjZTsKICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZU1pY3Jvc29mdFVuc2FmZUxvY2FsRnVuY3Rpb24gPSBmdW5jdGlvbihmdW5jKSB7CiAgICAgICAgICBpZiAodHlwZW9mIE1TQXBwICE9PSAidW5kZWZpbmVkIiAmJiBNU0FwcC5leGVjVW5zYWZlTG9jYWxGdW5jdGlvbikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJnMCwgYXJnMSwgYXJnMiwgYXJnMykgewogICAgICAgICAgICAgIE1TQXBwLmV4ZWNVbnNhZmVMb2NhbEZ1bmN0aW9uKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmMoYXJnMCwgYXJnMSwgYXJnMiwgYXJnMyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciByZXVzYWJsZVNWR0NvbnRhaW5lcjsKICAgICAgICB2YXIgc2V0SW5uZXJIVE1MID0gY3JlYXRlTWljcm9zb2Z0VW5zYWZlTG9jYWxGdW5jdGlvbihmdW5jdGlvbihub2RlLCBodG1sKSB7CiAgICAgICAgICBpZiAobm9kZS5uYW1lc3BhY2VVUkkgPT09IFNWR19OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgaWYgKCEoImlubmVySFRNTCIgaW4gbm9kZSkpIHsKICAgICAgICAgICAgICByZXVzYWJsZVNWR0NvbnRhaW5lciA9IHJldXNhYmxlU1ZHQ29udGFpbmVyIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgIHJldXNhYmxlU1ZHQ29udGFpbmVyLmlubmVySFRNTCA9ICI8c3ZnPiIgKyBodG1sLnZhbHVlT2YoKS50b1N0cmluZygpICsgIjwvc3ZnPiI7CiAgICAgICAgICAgICAgdmFyIHN2Z05vZGUgPSByZXVzYWJsZVNWR0NvbnRhaW5lci5maXJzdENoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChub2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQ2hpbGQobm9kZS5maXJzdENoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKHN2Z05vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChzdmdOb2RlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5vZGUuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICB9KTsKICAgICAgICB2YXIgRUxFTUVOVF9OT0RFID0gMTsKICAgICAgICB2YXIgVEVYVF9OT0RFID0gMzsKICAgICAgICB2YXIgQ09NTUVOVF9OT0RFID0gODsKICAgICAgICB2YXIgRE9DVU1FTlRfTk9ERSA9IDk7CiAgICAgICAgdmFyIERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgPSAxMTsKICAgICAgICB2YXIgc2V0VGV4dENvbnRlbnQgPSBmdW5jdGlvbihub2RlLCB0ZXh0KSB7CiAgICAgICAgICBpZiAodGV4dCkgewogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IG5vZGUuZmlyc3RDaGlsZDsKICAgICAgICAgICAgaWYgKGZpcnN0Q2hpbGQgJiYgZmlyc3RDaGlsZCA9PT0gbm9kZS5sYXN0Q2hpbGQgJiYgZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5ub2RlVmFsdWUgPSB0ZXh0OwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbm9kZS50ZXh0Q29udGVudCA9IHRleHQ7CiAgICAgICAgfTsKICAgICAgICB2YXIgc2hvcnRoYW5kVG9Mb25naGFuZCA9IHsKICAgICAgICAgIGFuaW1hdGlvbjogWyJhbmltYXRpb25EZWxheSIsICJhbmltYXRpb25EaXJlY3Rpb24iLCAiYW5pbWF0aW9uRHVyYXRpb24iLCAiYW5pbWF0aW9uRmlsbE1vZGUiLCAiYW5pbWF0aW9uSXRlcmF0aW9uQ291bnQiLCAiYW5pbWF0aW9uTmFtZSIsICJhbmltYXRpb25QbGF5U3RhdGUiLCAiYW5pbWF0aW9uVGltaW5nRnVuY3Rpb24iXSwKICAgICAgICAgIGJhY2tncm91bmQ6IFsiYmFja2dyb3VuZEF0dGFjaG1lbnQiLCAiYmFja2dyb3VuZENsaXAiLCAiYmFja2dyb3VuZENvbG9yIiwgImJhY2tncm91bmRJbWFnZSIsICJiYWNrZ3JvdW5kT3JpZ2luIiwgImJhY2tncm91bmRQb3NpdGlvblgiLCAiYmFja2dyb3VuZFBvc2l0aW9uWSIsICJiYWNrZ3JvdW5kUmVwZWF0IiwgImJhY2tncm91bmRTaXplIl0sCiAgICAgICAgICBiYWNrZ3JvdW5kUG9zaXRpb246IFsiYmFja2dyb3VuZFBvc2l0aW9uWCIsICJiYWNrZ3JvdW5kUG9zaXRpb25ZIl0sCiAgICAgICAgICBib3JkZXI6IFsiYm9yZGVyQm90dG9tQ29sb3IiLCAiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyQm90dG9tV2lkdGgiLCAiYm9yZGVySW1hZ2VPdXRzZXQiLCAiYm9yZGVySW1hZ2VSZXBlYXQiLCAiYm9yZGVySW1hZ2VTbGljZSIsICJib3JkZXJJbWFnZVNvdXJjZSIsICJib3JkZXJJbWFnZVdpZHRoIiwgImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0Q29sb3IiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJSaWdodFdpZHRoIiwgImJvcmRlclRvcENvbG9yIiwgImJvcmRlclRvcFN0eWxlIiwgImJvcmRlclRvcFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJCbG9ja0VuZDogWyJib3JkZXJCbG9ja0VuZENvbG9yIiwgImJvcmRlckJsb2NrRW5kU3R5bGUiLCAiYm9yZGVyQmxvY2tFbmRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyQmxvY2tTdGFydDogWyJib3JkZXJCbG9ja1N0YXJ0Q29sb3IiLCAiYm9yZGVyQmxvY2tTdGFydFN0eWxlIiwgImJvcmRlckJsb2NrU3RhcnRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyQm90dG9tOiBbImJvcmRlckJvdHRvbUNvbG9yIiwgImJvcmRlckJvdHRvbVN0eWxlIiwgImJvcmRlckJvdHRvbVdpZHRoIl0sCiAgICAgICAgICBib3JkZXJDb2xvcjogWyJib3JkZXJCb3R0b21Db2xvciIsICJib3JkZXJMZWZ0Q29sb3IiLCAiYm9yZGVyUmlnaHRDb2xvciIsICJib3JkZXJUb3BDb2xvciJdLAogICAgICAgICAgYm9yZGVySW1hZ2U6IFsiYm9yZGVySW1hZ2VPdXRzZXQiLCAiYm9yZGVySW1hZ2VSZXBlYXQiLCAiYm9yZGVySW1hZ2VTbGljZSIsICJib3JkZXJJbWFnZVNvdXJjZSIsICJib3JkZXJJbWFnZVdpZHRoIl0sCiAgICAgICAgICBib3JkZXJJbmxpbmVFbmQ6IFsiYm9yZGVySW5saW5lRW5kQ29sb3IiLCAiYm9yZGVySW5saW5lRW5kU3R5bGUiLCAiYm9yZGVySW5saW5lRW5kV2lkdGgiXSwKICAgICAgICAgIGJvcmRlcklubGluZVN0YXJ0OiBbImJvcmRlcklubGluZVN0YXJ0Q29sb3IiLCAiYm9yZGVySW5saW5lU3RhcnRTdHlsZSIsICJib3JkZXJJbmxpbmVTdGFydFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJMZWZ0OiBbImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyTGVmdFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJSYWRpdXM6IFsiYm9yZGVyQm90dG9tTGVmdFJhZGl1cyIsICJib3JkZXJCb3R0b21SaWdodFJhZGl1cyIsICJib3JkZXJUb3BMZWZ0UmFkaXVzIiwgImJvcmRlclRvcFJpZ2h0UmFkaXVzIl0sCiAgICAgICAgICBib3JkZXJSaWdodDogWyJib3JkZXJSaWdodENvbG9yIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyUmlnaHRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyU3R5bGU6IFsiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyTGVmdFN0eWxlIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyVG9wU3R5bGUiXSwKICAgICAgICAgIGJvcmRlclRvcDogWyJib3JkZXJUb3BDb2xvciIsICJib3JkZXJUb3BTdHlsZSIsICJib3JkZXJUb3BXaWR0aCJdLAogICAgICAgICAgYm9yZGVyV2lkdGg6IFsiYm9yZGVyQm90dG9tV2lkdGgiLCAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0V2lkdGgiLCAiYm9yZGVyVG9wV2lkdGgiXSwKICAgICAgICAgIGNvbHVtblJ1bGU6IFsiY29sdW1uUnVsZUNvbG9yIiwgImNvbHVtblJ1bGVTdHlsZSIsICJjb2x1bW5SdWxlV2lkdGgiXSwKICAgICAgICAgIGNvbHVtbnM6IFsiY29sdW1uQ291bnQiLCAiY29sdW1uV2lkdGgiXSwKICAgICAgICAgIGZsZXg6IFsiZmxleEJhc2lzIiwgImZsZXhHcm93IiwgImZsZXhTaHJpbmsiXSwKICAgICAgICAgIGZsZXhGbG93OiBbImZsZXhEaXJlY3Rpb24iLCAiZmxleFdyYXAiXSwKICAgICAgICAgIGZvbnQ6IFsiZm9udEZhbWlseSIsICJmb250RmVhdHVyZVNldHRpbmdzIiwgImZvbnRLZXJuaW5nIiwgImZvbnRMYW5ndWFnZU92ZXJyaWRlIiwgImZvbnRTaXplIiwgImZvbnRTaXplQWRqdXN0IiwgImZvbnRTdHJldGNoIiwgImZvbnRTdHlsZSIsICJmb250VmFyaWFudCIsICJmb250VmFyaWFudEFsdGVybmF0ZXMiLCAiZm9udFZhcmlhbnRDYXBzIiwgImZvbnRWYXJpYW50RWFzdEFzaWFuIiwgImZvbnRWYXJpYW50TGlnYXR1cmVzIiwgImZvbnRWYXJpYW50TnVtZXJpYyIsICJmb250VmFyaWFudFBvc2l0aW9uIiwgImZvbnRXZWlnaHQiLCAibGluZUhlaWdodCJdLAogICAgICAgICAgZm9udFZhcmlhbnQ6IFsiZm9udFZhcmlhbnRBbHRlcm5hdGVzIiwgImZvbnRWYXJpYW50Q2FwcyIsICJmb250VmFyaWFudEVhc3RBc2lhbiIsICJmb250VmFyaWFudExpZ2F0dXJlcyIsICJmb250VmFyaWFudE51bWVyaWMiLCAiZm9udFZhcmlhbnRQb3NpdGlvbiJdLAogICAgICAgICAgZ2FwOiBbImNvbHVtbkdhcCIsICJyb3dHYXAiXSwKICAgICAgICAgIGdyaWQ6IFsiZ3JpZEF1dG9Db2x1bW5zIiwgImdyaWRBdXRvRmxvdyIsICJncmlkQXV0b1Jvd3MiLCAiZ3JpZFRlbXBsYXRlQXJlYXMiLCAiZ3JpZFRlbXBsYXRlQ29sdW1ucyIsICJncmlkVGVtcGxhdGVSb3dzIl0sCiAgICAgICAgICBncmlkQXJlYTogWyJncmlkQ29sdW1uRW5kIiwgImdyaWRDb2x1bW5TdGFydCIsICJncmlkUm93RW5kIiwgImdyaWRSb3dTdGFydCJdLAogICAgICAgICAgZ3JpZENvbHVtbjogWyJncmlkQ29sdW1uRW5kIiwgImdyaWRDb2x1bW5TdGFydCJdLAogICAgICAgICAgZ3JpZENvbHVtbkdhcDogWyJjb2x1bW5HYXAiXSwKICAgICAgICAgIGdyaWRHYXA6IFsiY29sdW1uR2FwIiwgInJvd0dhcCJdLAogICAgICAgICAgZ3JpZFJvdzogWyJncmlkUm93RW5kIiwgImdyaWRSb3dTdGFydCJdLAogICAgICAgICAgZ3JpZFJvd0dhcDogWyJyb3dHYXAiXSwKICAgICAgICAgIGdyaWRUZW1wbGF0ZTogWyJncmlkVGVtcGxhdGVBcmVhcyIsICJncmlkVGVtcGxhdGVDb2x1bW5zIiwgImdyaWRUZW1wbGF0ZVJvd3MiXSwKICAgICAgICAgIGxpc3RTdHlsZTogWyJsaXN0U3R5bGVJbWFnZSIsICJsaXN0U3R5bGVQb3NpdGlvbiIsICJsaXN0U3R5bGVUeXBlIl0sCiAgICAgICAgICBtYXJnaW46IFsibWFyZ2luQm90dG9tIiwgIm1hcmdpbkxlZnQiLCAibWFyZ2luUmlnaHQiLCAibWFyZ2luVG9wIl0sCiAgICAgICAgICBtYXJrZXI6IFsibWFya2VyRW5kIiwgIm1hcmtlck1pZCIsICJtYXJrZXJTdGFydCJdLAogICAgICAgICAgbWFzazogWyJtYXNrQ2xpcCIsICJtYXNrQ29tcG9zaXRlIiwgIm1hc2tJbWFnZSIsICJtYXNrTW9kZSIsICJtYXNrT3JpZ2luIiwgIm1hc2tQb3NpdGlvblgiLCAibWFza1Bvc2l0aW9uWSIsICJtYXNrUmVwZWF0IiwgIm1hc2tTaXplIl0sCiAgICAgICAgICBtYXNrUG9zaXRpb246IFsibWFza1Bvc2l0aW9uWCIsICJtYXNrUG9zaXRpb25ZIl0sCiAgICAgICAgICBvdXRsaW5lOiBbIm91dGxpbmVDb2xvciIsICJvdXRsaW5lU3R5bGUiLCAib3V0bGluZVdpZHRoIl0sCiAgICAgICAgICBvdmVyZmxvdzogWyJvdmVyZmxvd1giLCAib3ZlcmZsb3dZIl0sCiAgICAgICAgICBwYWRkaW5nOiBbInBhZGRpbmdCb3R0b20iLCAicGFkZGluZ0xlZnQiLCAicGFkZGluZ1JpZ2h0IiwgInBhZGRpbmdUb3AiXSwKICAgICAgICAgIHBsYWNlQ29udGVudDogWyJhbGlnbkNvbnRlbnQiLCAianVzdGlmeUNvbnRlbnQiXSwKICAgICAgICAgIHBsYWNlSXRlbXM6IFsiYWxpZ25JdGVtcyIsICJqdXN0aWZ5SXRlbXMiXSwKICAgICAgICAgIHBsYWNlU2VsZjogWyJhbGlnblNlbGYiLCAianVzdGlmeVNlbGYiXSwKICAgICAgICAgIHRleHREZWNvcmF0aW9uOiBbInRleHREZWNvcmF0aW9uQ29sb3IiLCAidGV4dERlY29yYXRpb25MaW5lIiwgInRleHREZWNvcmF0aW9uU3R5bGUiXSwKICAgICAgICAgIHRleHRFbXBoYXNpczogWyJ0ZXh0RW1waGFzaXNDb2xvciIsICJ0ZXh0RW1waGFzaXNTdHlsZSJdLAogICAgICAgICAgdHJhbnNpdGlvbjogWyJ0cmFuc2l0aW9uRGVsYXkiLCAidHJhbnNpdGlvbkR1cmF0aW9uIiwgInRyYW5zaXRpb25Qcm9wZXJ0eSIsICJ0cmFuc2l0aW9uVGltaW5nRnVuY3Rpb24iXSwKICAgICAgICAgIHdvcmRXcmFwOiBbIm92ZXJmbG93V3JhcCJdCiAgICAgICAgfTsKICAgICAgICB2YXIgaXNVbml0bGVzc051bWJlciA9IHsKICAgICAgICAgIGFuaW1hdGlvbkl0ZXJhdGlvbkNvdW50OiB0cnVlLAogICAgICAgICAgYXNwZWN0UmF0aW86IHRydWUsCiAgICAgICAgICBib3JkZXJJbWFnZU91dHNldDogdHJ1ZSwKICAgICAgICAgIGJvcmRlckltYWdlU2xpY2U6IHRydWUsCiAgICAgICAgICBib3JkZXJJbWFnZVdpZHRoOiB0cnVlLAogICAgICAgICAgYm94RmxleDogdHJ1ZSwKICAgICAgICAgIGJveEZsZXhHcm91cDogdHJ1ZSwKICAgICAgICAgIGJveE9yZGluYWxHcm91cDogdHJ1ZSwKICAgICAgICAgIGNvbHVtbkNvdW50OiB0cnVlLAogICAgICAgICAgY29sdW1uczogdHJ1ZSwKICAgICAgICAgIGZsZXg6IHRydWUsCiAgICAgICAgICBmbGV4R3JvdzogdHJ1ZSwKICAgICAgICAgIGZsZXhQb3NpdGl2ZTogdHJ1ZSwKICAgICAgICAgIGZsZXhTaHJpbms6IHRydWUsCiAgICAgICAgICBmbGV4TmVnYXRpdmU6IHRydWUsCiAgICAgICAgICBmbGV4T3JkZXI6IHRydWUsCiAgICAgICAgICBncmlkQXJlYTogdHJ1ZSwKICAgICAgICAgIGdyaWRSb3c6IHRydWUsCiAgICAgICAgICBncmlkUm93RW5kOiB0cnVlLAogICAgICAgICAgZ3JpZFJvd1NwYW46IHRydWUsCiAgICAgICAgICBncmlkUm93U3RhcnQ6IHRydWUsCiAgICAgICAgICBncmlkQ29sdW1uOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtbkVuZDogdHJ1ZSwKICAgICAgICAgIGdyaWRDb2x1bW5TcGFuOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtblN0YXJ0OiB0cnVlLAogICAgICAgICAgZm9udFdlaWdodDogdHJ1ZSwKICAgICAgICAgIGxpbmVDbGFtcDogdHJ1ZSwKICAgICAgICAgIGxpbmVIZWlnaHQ6IHRydWUsCiAgICAgICAgICBvcGFjaXR5OiB0cnVlLAogICAgICAgICAgb3JkZXI6IHRydWUsCiAgICAgICAgICBvcnBoYW5zOiB0cnVlLAogICAgICAgICAgdGFiU2l6ZTogdHJ1ZSwKICAgICAgICAgIHdpZG93czogdHJ1ZSwKICAgICAgICAgIHpJbmRleDogdHJ1ZSwKICAgICAgICAgIHpvb206IHRydWUsCiAgICAgICAgICAvLyBTVkctcmVsYXRlZCBwcm9wZXJ0aWVzCiAgICAgICAgICBmaWxsT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgIGZsb29kT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgIHN0b3BPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlRGFzaGFycmF5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlRGFzaG9mZnNldDogdHJ1ZSwKICAgICAgICAgIHN0cm9rZU1pdGVybGltaXQ6IHRydWUsCiAgICAgICAgICBzdHJva2VPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlV2lkdGg6IHRydWUKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHByZWZpeEtleShwcmVmaXgyLCBrZXkpIHsKICAgICAgICAgIHJldHVybiBwcmVmaXgyICsga2V5LmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsga2V5LnN1YnN0cmluZygxKTsKICAgICAgICB9CiAgICAgICAgdmFyIHByZWZpeGVzMiA9IFsiV2Via2l0IiwgIm1zIiwgIk1veiIsICJPIl07CiAgICAgICAgT2JqZWN0LmtleXMoaXNVbml0bGVzc051bWJlcikuZm9yRWFjaChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICBwcmVmaXhlczIuZm9yRWFjaChmdW5jdGlvbihwcmVmaXgyKSB7CiAgICAgICAgICAgIGlzVW5pdGxlc3NOdW1iZXJbcHJlZml4S2V5KHByZWZpeDIsIHByb3ApXSA9IGlzVW5pdGxlc3NOdW1iZXJbcHJvcF07CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiBkYW5nZXJvdXNTdHlsZVZhbHVlKG5hbWUsIHZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KSB7CiAgICAgICAgICB2YXIgaXNFbXB0eSA9IHZhbHVlID09IG51bGwgfHwgdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgfHwgdmFsdWUgPT09ICIiOwogICAgICAgICAgaWYgKGlzRW1wdHkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0N1c3RvbVByb3BlcnR5ICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgJiYgdmFsdWUgIT09IDAgJiYgIShpc1VuaXRsZXNzTnVtYmVyLmhhc093blByb3BlcnR5KG5hbWUpICYmIGlzVW5pdGxlc3NOdW1iZXJbbmFtZV0pKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSArICJweCI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ1NTUHJvcGVydHlTdHJpbmdDb2VyY2lvbih2YWx1ZSwgbmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gKCIiICsgdmFsdWUpLnRyaW0oKTsKICAgICAgICB9CiAgICAgICAgdmFyIHVwcGVyY2FzZVBhdHRlcm4gPSAvKFtBLVpdKS9nOwogICAgICAgIHZhciBtc1BhdHRlcm4gPSAvXm1zLS87CiAgICAgICAgZnVuY3Rpb24gaHlwaGVuYXRlU3R5bGVOYW1lKG5hbWUpIHsKICAgICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UodXBwZXJjYXNlUGF0dGVybiwgIi0kMSIpLnRvTG93ZXJDYXNlKCkucmVwbGFjZShtc1BhdHRlcm4sICItbXMtIik7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuVmFsaWRTdHlsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybiA9IC9eKD86d2Via2l0fG1venxvKVtBLVpdLzsKICAgICAgICAgIHZhciBtc1BhdHRlcm4kMSA9IC9eLW1zLS87CiAgICAgICAgICB2YXIgaHlwaGVuUGF0dGVybiA9IC8tKC4pL2c7CiAgICAgICAgICB2YXIgYmFkU3R5bGVWYWx1ZVdpdGhTZW1pY29sb25QYXR0ZXJuID0gLztccyokLzsKICAgICAgICAgIHZhciB3YXJuZWRTdHlsZU5hbWVzID0ge307CiAgICAgICAgICB2YXIgd2FybmVkU3R5bGVWYWx1ZXMgPSB7fTsKICAgICAgICAgIHZhciB3YXJuZWRGb3JOYU5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgdmFyIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSBmYWxzZTsKICAgICAgICAgIHZhciBjYW1lbGl6ZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoaHlwaGVuUGF0dGVybiwgZnVuY3Rpb24oXywgY2hhcmFjdGVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJhY3Rlci50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2Fybkh5cGhlbmF0ZWRTdHlsZU5hbWUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRTdHlsZU5hbWVzLmhhc093blByb3BlcnR5KG5hbWUpICYmIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FybmVkU3R5bGVOYW1lc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKAogICAgICAgICAgICAgICJVbnN1cHBvcnRlZCBzdHlsZSBwcm9wZXJ0eSAlcy4gRGlkIHlvdSBtZWFuICVzPyIsCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICAvLyBBcyBBbmRpIFNtaXRoIHN1Z2dlc3RzCiAgICAgICAgICAgICAgLy8gKGh0dHA6Ly93d3cuYW5kaXNtaXRoLmNvbS9ibG9nLzIwMTIvMDIvbW9kZXJuaXpyLXByZWZpeGVkLyksIGFuIGAtbXNgIHByZWZpeAogICAgICAgICAgICAgIC8vIGlzIGNvbnZlcnRlZCB0byBsb3dlcmNhc2UgYG1zYC4KICAgICAgICAgICAgICBjYW1lbGl6ZShuYW1lLnJlcGxhY2UobXNQYXR0ZXJuJDEsICJtcy0iKSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVOYW1lcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiB3YXJuZWRTdHlsZU5hbWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiVW5zdXBwb3J0ZWQgdmVuZG9yLXByZWZpeGVkIHN0eWxlIHByb3BlcnR5ICVzLiBEaWQgeW91IG1lYW4gJXM/IiwgbmFtZSwgbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSkpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuU3R5bGVWYWx1ZVdpdGhTZW1pY29sb24gPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVWYWx1ZXMuaGFzT3duUHJvcGVydHkodmFsdWUpICYmIHdhcm5lZFN0eWxlVmFsdWVzW3ZhbHVlXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRTdHlsZVZhbHVlc1t2YWx1ZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcihgU3R5bGUgcHJvcGVydHkgdmFsdWVzIHNob3VsZG4ndCBjb250YWluIGEgc2VtaWNvbG9uLiBUcnkgIiVzOiAlcyIgaW5zdGVhZC5gLCBuYW1lLCB2YWx1ZS5yZXBsYWNlKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybiwgIiIpKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FyblN0eWxlVmFsdWVJc05hTiA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JOYU5WYWx1ZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRGb3JOYU5WYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJgTmFOYCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JJbmZpbml0eVZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiYEluZmluaXR5YCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FyblZhbGlkU3R5bGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCItIikgPiAtMSkgewogICAgICAgICAgICAgIHdhcm5IeXBoZW5hdGVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybi50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybi50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlV2l0aFNlbWljb2xvbihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAoaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICAgICAgICB3YXJuU3R5bGVWYWx1ZUlzTmFOKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpc0Zpbml0ZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgd2FyblZhbGlkU3R5bGUkMSA9IHdhcm5WYWxpZFN0eWxlOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZURhbmdlcm91c1N0cmluZ0ZvclN0eWxlcyhzdHlsZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlcmlhbGl6ZWQgPSAiIjsKICAgICAgICAgICAgdmFyIGRlbGltaXRlciA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBzdHlsZU5hbWUgaW4gc3R5bGVzKSB7CiAgICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gc3R5bGVzW3N0eWxlTmFtZV07CiAgICAgICAgICAgICAgaWYgKHN0eWxlVmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGlzQ3VzdG9tUHJvcGVydHkgPSBzdHlsZU5hbWUuaW5kZXhPZigiLS0iKSA9PT0gMDsKICAgICAgICAgICAgICAgIHNlcmlhbGl6ZWQgKz0gZGVsaW1pdGVyICsgKGlzQ3VzdG9tUHJvcGVydHkgPyBzdHlsZU5hbWUgOiBoeXBoZW5hdGVTdHlsZU5hbWUoc3R5bGVOYW1lKSkgKyAiOiI7CiAgICAgICAgICAgICAgICBzZXJpYWxpemVkICs9IGRhbmdlcm91c1N0eWxlVmFsdWUoc3R5bGVOYW1lLCBzdHlsZVZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgICAgIGRlbGltaXRlciA9ICI7IjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0VmFsdWVGb3JTdHlsZXMobm9kZSwgc3R5bGVzKSB7CiAgICAgICAgICB2YXIgc3R5bGUyID0gbm9kZS5zdHlsZTsKICAgICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc0N1c3RvbVByb3BlcnR5ID0gc3R5bGVOYW1lLmluZGV4T2YoIi0tIikgPT09IDA7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICAgIHdhcm5WYWxpZFN0eWxlJDEoc3R5bGVOYW1lLCBzdHlsZXNbc3R5bGVOYW1lXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gZGFuZ2Vyb3VzU3R5bGVWYWx1ZShzdHlsZU5hbWUsIHN0eWxlc1tzdHlsZU5hbWVdLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgaWYgKHN0eWxlTmFtZSA9PT0gImZsb2F0IikgewogICAgICAgICAgICAgIHN0eWxlTmFtZSA9ICJjc3NGbG9hdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICBzdHlsZTIuc2V0UHJvcGVydHkoc3R5bGVOYW1lLCBzdHlsZVZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdHlsZTJbc3R5bGVOYW1lXSA9IHN0eWxlVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWx1ZUVtcHR5KHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiB8fCB2YWx1ZSA9PT0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZXMpIHsKICAgICAgICAgIHZhciBleHBhbmRlZCA9IHt9OwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHN0eWxlcykgewogICAgICAgICAgICB2YXIgbG9uZ2hhbmRzID0gc2hvcnRoYW5kVG9Mb25naGFuZFtrZXldIHx8IFtrZXldOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxvbmdoYW5kcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGV4cGFuZGVkW2xvbmdoYW5kc1tpXV0gPSBrZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleHBhbmRlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVTaG9ydGhhbmRQcm9wZXJ0eUNvbGxpc2lvbkluRGV2KHN0eWxlVXBkYXRlcywgbmV4dFN0eWxlcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIW5leHRTdHlsZXMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4cGFuZGVkVXBkYXRlcyA9IGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICB2YXIgZXhwYW5kZWRTdHlsZXMgPSBleHBhbmRTaG9ydGhhbmRNYXAobmV4dFN0eWxlcyk7CiAgICAgICAgICAgIHZhciB3YXJuZWRBYm91dCA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXhwYW5kZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsS2V5ID0gZXhwYW5kZWRVcGRhdGVzW2tleV07CiAgICAgICAgICAgICAgdmFyIGNvcnJlY3RPcmlnaW5hbEtleSA9IGV4cGFuZGVkU3R5bGVzW2tleV07CiAgICAgICAgICAgICAgaWYgKGNvcnJlY3RPcmlnaW5hbEtleSAmJiBvcmlnaW5hbEtleSAhPT0gY29ycmVjdE9yaWdpbmFsS2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IG9yaWdpbmFsS2V5ICsgIiwiICsgY29ycmVjdE9yaWdpbmFsS2V5OwogICAgICAgICAgICAgICAgaWYgKHdhcm5lZEFib3V0W3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2FybmVkQWJvdXRbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGEgc3R5bGUgcHJvcGVydHkgZHVyaW5nIHJlcmVuZGVyICglcykgd2hlbiBhIGNvbmZsaWN0aW5nIHByb3BlcnR5IGlzIHNldCAoJXMpIGNhbiBsZWFkIHRvIHN0eWxpbmcgYnVncy4gVG8gYXZvaWQgdGhpcywgZG9uJ3QgbWl4IHNob3J0aGFuZCBhbmQgbm9uLXNob3J0aGFuZCBwcm9wZXJ0aWVzIGZvciB0aGUgc2FtZSB2YWx1ZTsgaW5zdGVhZCwgcmVwbGFjZSB0aGUgc2hvcnRoYW5kIHdpdGggc2VwYXJhdGUgdmFsdWVzLiIsIGlzVmFsdWVFbXB0eShzdHlsZVVwZGF0ZXNbb3JpZ2luYWxLZXldKSA/ICJSZW1vdmluZyIgOiAiVXBkYXRpbmciLCBvcmlnaW5hbEtleSwgY29ycmVjdE9yaWdpbmFsS2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG9taXR0ZWRDbG9zZVRhZ3MgPSB7CiAgICAgICAgICBhcmVhOiB0cnVlLAogICAgICAgICAgYmFzZTogdHJ1ZSwKICAgICAgICAgIGJyOiB0cnVlLAogICAgICAgICAgY29sOiB0cnVlLAogICAgICAgICAgZW1iZWQ6IHRydWUsCiAgICAgICAgICBocjogdHJ1ZSwKICAgICAgICAgIGltZzogdHJ1ZSwKICAgICAgICAgIGlucHV0OiB0cnVlLAogICAgICAgICAga2V5Z2VuOiB0cnVlLAogICAgICAgICAgbGluazogdHJ1ZSwKICAgICAgICAgIG1ldGE6IHRydWUsCiAgICAgICAgICBwYXJhbTogdHJ1ZSwKICAgICAgICAgIHNvdXJjZTogdHJ1ZSwKICAgICAgICAgIHRyYWNrOiB0cnVlLAogICAgICAgICAgd2JyOiB0cnVlCiAgICAgICAgICAvLyBOT1RFOiBtZW51aXRlbSdzIGNsb3NlIHRhZyBzaG91bGQgYmUgb21pdHRlZCwgYnV0IHRoYXQgY2F1c2VzIHByb2JsZW1zLgogICAgICAgIH07CiAgICAgICAgdmFyIHZvaWRFbGVtZW50VGFncyA9IGFzc2lnbjIoewogICAgICAgICAgbWVudWl0ZW06IHRydWUKICAgICAgICB9LCBvbWl0dGVkQ2xvc2VUYWdzKTsKICAgICAgICB2YXIgSFRNTCA9ICJfX2h0bWwiOwogICAgICAgIGZ1bmN0aW9uIGFzc2VydFZhbGlkUHJvcHModGFnLCBwcm9wcykgewogICAgICAgICAgaWYgKCFwcm9wcykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodm9pZEVsZW1lbnRUYWdzW3RhZ10pIHsKICAgICAgICAgICAgaWYgKHByb3BzLmNoaWxkcmVuICE9IG51bGwgfHwgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcih0YWcgKyAiIGlzIGEgdm9pZCBlbGVtZW50IHRhZyBhbmQgbXVzdCBuZWl0aGVyIGhhdmUgYGNoaWxkcmVuYCBub3IgdXNlIGBkYW5nZXJvdXNseVNldElubmVySFRNTGAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChwcm9wcy5jaGlsZHJlbiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW4gb25seSBzZXQgb25lIG9mIGBjaGlsZHJlbmAgb3IgYHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9PSAib2JqZWN0IiB8fCAhKEhUTUwgaW4gcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgIG11c3QgYmUgaW4gdGhlIGZvcm0gYHtfX2h0bWw6IC4uLn1gLiBQbGVhc2UgdmlzaXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Rhbmdlcm91c2x5LXNldC1pbm5lci1odG1sIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghcHJvcHMuc3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nICYmIHByb3BzLmNvbnRlbnRFZGl0YWJsZSAmJiBwcm9wcy5jaGlsZHJlbiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGBjb250ZW50RWRpdGFibGVgIGFuZCBjb250YWlucyBgY2hpbGRyZW5gIG1hbmFnZWQgYnkgUmVhY3QuIEl0IGlzIG5vdyB5b3VyIHJlc3BvbnNpYmlsaXR5IHRvIGd1YXJhbnRlZSB0aGF0IG5vbmUgb2YgdGhvc2Ugbm9kZXMgYXJlIHVuZXhwZWN0ZWRseSBtb2RpZmllZCBvciBkdXBsaWNhdGVkLiBUaGlzIGlzIHByb2JhYmx5IG5vdCBpbnRlbnRpb25hbC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3BzLnN0eWxlICE9IG51bGwgJiYgdHlwZW9mIHByb3BzLnN0eWxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBgc3R5bGVgIHByb3AgZXhwZWN0cyBhIG1hcHBpbmcgZnJvbSBzdHlsZSBwcm9wZXJ0aWVzIHRvIHZhbHVlcywgbm90IGEgc3RyaW5nLiBGb3IgZXhhbXBsZSwgc3R5bGU9e3ttYXJnaW5SaWdodDogc3BhY2luZyArICdlbSd9fSB3aGVuIHVzaW5nIEpTWC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDdXN0b21Db21wb25lbnQodGFnTmFtZSwgcHJvcHMpIHsKICAgICAgICAgIGlmICh0YWdOYW1lLmluZGV4T2YoIi0iKSA9PT0gLTEpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBwcm9wcy5pcyA9PT0gInN0cmluZyI7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRhZ05hbWUpIHsKICAgICAgICAgICAgY2FzZSAiYW5ub3RhdGlvbi14bWwiOgogICAgICAgICAgICBjYXNlICJjb2xvci1wcm9maWxlIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLXNyYyI6CiAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS11cmkiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2UtZm9ybWF0IjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLW5hbWUiOgogICAgICAgICAgICBjYXNlICJtaXNzaW5nLWdseXBoIjoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBwb3NzaWJsZVN0YW5kYXJkTmFtZXMgPSB7CiAgICAgICAgICAvLyBIVE1MCiAgICAgICAgICBhY2NlcHQ6ICJhY2NlcHQiLAogICAgICAgICAgYWNjZXB0Y2hhcnNldDogImFjY2VwdENoYXJzZXQiLAogICAgICAgICAgImFjY2VwdC1jaGFyc2V0IjogImFjY2VwdENoYXJzZXQiLAogICAgICAgICAgYWNjZXNza2V5OiAiYWNjZXNzS2V5IiwKICAgICAgICAgIGFjdGlvbjogImFjdGlvbiIsCiAgICAgICAgICBhbGxvd2Z1bGxzY3JlZW46ICJhbGxvd0Z1bGxTY3JlZW4iLAogICAgICAgICAgYWx0OiAiYWx0IiwKICAgICAgICAgIGFzOiAiYXMiLAogICAgICAgICAgYXN5bmM6ICJhc3luYyIsCiAgICAgICAgICBhdXRvY2FwaXRhbGl6ZTogImF1dG9DYXBpdGFsaXplIiwKICAgICAgICAgIGF1dG9jb21wbGV0ZTogImF1dG9Db21wbGV0ZSIsCiAgICAgICAgICBhdXRvY29ycmVjdDogImF1dG9Db3JyZWN0IiwKICAgICAgICAgIGF1dG9mb2N1czogImF1dG9Gb2N1cyIsCiAgICAgICAgICBhdXRvcGxheTogImF1dG9QbGF5IiwKICAgICAgICAgIGF1dG9zYXZlOiAiYXV0b1NhdmUiLAogICAgICAgICAgY2FwdHVyZTogImNhcHR1cmUiLAogICAgICAgICAgY2VsbHBhZGRpbmc6ICJjZWxsUGFkZGluZyIsCiAgICAgICAgICBjZWxsc3BhY2luZzogImNlbGxTcGFjaW5nIiwKICAgICAgICAgIGNoYWxsZW5nZTogImNoYWxsZW5nZSIsCiAgICAgICAgICBjaGFyc2V0OiAiY2hhclNldCIsCiAgICAgICAgICBjaGVja2VkOiAiY2hlY2tlZCIsCiAgICAgICAgICBjaGlsZHJlbjogImNoaWxkcmVuIiwKICAgICAgICAgIGNpdGU6ICJjaXRlIiwKICAgICAgICAgIGNsYXNzOiAiY2xhc3NOYW1lIiwKICAgICAgICAgIGNsYXNzaWQ6ICJjbGFzc0lEIiwKICAgICAgICAgIGNsYXNzbmFtZTogImNsYXNzTmFtZSIsCiAgICAgICAgICBjb2xzOiAiY29scyIsCiAgICAgICAgICBjb2xzcGFuOiAiY29sU3BhbiIsCiAgICAgICAgICBjb250ZW50OiAiY29udGVudCIsCiAgICAgICAgICBjb250ZW50ZWRpdGFibGU6ICJjb250ZW50RWRpdGFibGUiLAogICAgICAgICAgY29udGV4dG1lbnU6ICJjb250ZXh0TWVudSIsCiAgICAgICAgICBjb250cm9sczogImNvbnRyb2xzIiwKICAgICAgICAgIGNvbnRyb2xzbGlzdDogImNvbnRyb2xzTGlzdCIsCiAgICAgICAgICBjb29yZHM6ICJjb29yZHMiLAogICAgICAgICAgY3Jvc3NvcmlnaW46ICJjcm9zc09yaWdpbiIsCiAgICAgICAgICBkYW5nZXJvdXNseXNldGlubmVyaHRtbDogImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwKICAgICAgICAgIGRhdGE6ICJkYXRhIiwKICAgICAgICAgIGRhdGV0aW1lOiAiZGF0ZVRpbWUiLAogICAgICAgICAgZGVmYXVsdDogImRlZmF1bHQiLAogICAgICAgICAgZGVmYXVsdGNoZWNrZWQ6ICJkZWZhdWx0Q2hlY2tlZCIsCiAgICAgICAgICBkZWZhdWx0dmFsdWU6ICJkZWZhdWx0VmFsdWUiLAogICAgICAgICAgZGVmZXI6ICJkZWZlciIsCiAgICAgICAgICBkaXI6ICJkaXIiLAogICAgICAgICAgZGlzYWJsZWQ6ICJkaXNhYmxlZCIsCiAgICAgICAgICBkaXNhYmxlcGljdHVyZWlucGljdHVyZTogImRpc2FibGVQaWN0dXJlSW5QaWN0dXJlIiwKICAgICAgICAgIGRpc2FibGVyZW1vdGVwbGF5YmFjazogImRpc2FibGVSZW1vdGVQbGF5YmFjayIsCiAgICAgICAgICBkb3dubG9hZDogImRvd25sb2FkIiwKICAgICAgICAgIGRyYWdnYWJsZTogImRyYWdnYWJsZSIsCiAgICAgICAgICBlbmN0eXBlOiAiZW5jVHlwZSIsCiAgICAgICAgICBlbnRlcmtleWhpbnQ6ICJlbnRlcktleUhpbnQiLAogICAgICAgICAgZm9yOiAiaHRtbEZvciIsCiAgICAgICAgICBmb3JtOiAiZm9ybSIsCiAgICAgICAgICBmb3JtbWV0aG9kOiAiZm9ybU1ldGhvZCIsCiAgICAgICAgICBmb3JtYWN0aW9uOiAiZm9ybUFjdGlvbiIsCiAgICAgICAgICBmb3JtZW5jdHlwZTogImZvcm1FbmNUeXBlIiwKICAgICAgICAgIGZvcm1ub3ZhbGlkYXRlOiAiZm9ybU5vVmFsaWRhdGUiLAogICAgICAgICAgZm9ybXRhcmdldDogImZvcm1UYXJnZXQiLAogICAgICAgICAgZnJhbWVib3JkZXI6ICJmcmFtZUJvcmRlciIsCiAgICAgICAgICBoZWFkZXJzOiAiaGVhZGVycyIsCiAgICAgICAgICBoZWlnaHQ6ICJoZWlnaHQiLAogICAgICAgICAgaGlkZGVuOiAiaGlkZGVuIiwKICAgICAgICAgIGhpZ2g6ICJoaWdoIiwKICAgICAgICAgIGhyZWY6ICJocmVmIiwKICAgICAgICAgIGhyZWZsYW5nOiAiaHJlZkxhbmciLAogICAgICAgICAgaHRtbGZvcjogImh0bWxGb3IiLAogICAgICAgICAgaHR0cGVxdWl2OiAiaHR0cEVxdWl2IiwKICAgICAgICAgICJodHRwLWVxdWl2IjogImh0dHBFcXVpdiIsCiAgICAgICAgICBpY29uOiAiaWNvbiIsCiAgICAgICAgICBpZDogImlkIiwKICAgICAgICAgIGltYWdlc2l6ZXM6ICJpbWFnZVNpemVzIiwKICAgICAgICAgIGltYWdlc3Jjc2V0OiAiaW1hZ2VTcmNTZXQiLAogICAgICAgICAgaW5uZXJodG1sOiAiaW5uZXJIVE1MIiwKICAgICAgICAgIGlucHV0bW9kZTogImlucHV0TW9kZSIsCiAgICAgICAgICBpbnRlZ3JpdHk6ICJpbnRlZ3JpdHkiLAogICAgICAgICAgaXM6ICJpcyIsCiAgICAgICAgICBpdGVtaWQ6ICJpdGVtSUQiLAogICAgICAgICAgaXRlbXByb3A6ICJpdGVtUHJvcCIsCiAgICAgICAgICBpdGVtcmVmOiAiaXRlbVJlZiIsCiAgICAgICAgICBpdGVtc2NvcGU6ICJpdGVtU2NvcGUiLAogICAgICAgICAgaXRlbXR5cGU6ICJpdGVtVHlwZSIsCiAgICAgICAgICBrZXlwYXJhbXM6ICJrZXlQYXJhbXMiLAogICAgICAgICAga2V5dHlwZTogImtleVR5cGUiLAogICAgICAgICAga2luZDogImtpbmQiLAogICAgICAgICAgbGFiZWw6ICJsYWJlbCIsCiAgICAgICAgICBsYW5nOiAibGFuZyIsCiAgICAgICAgICBsaXN0OiAibGlzdCIsCiAgICAgICAgICBsb29wOiAibG9vcCIsCiAgICAgICAgICBsb3c6ICJsb3ciLAogICAgICAgICAgbWFuaWZlc3Q6ICJtYW5pZmVzdCIsCiAgICAgICAgICBtYXJnaW53aWR0aDogIm1hcmdpbldpZHRoIiwKICAgICAgICAgIG1hcmdpbmhlaWdodDogIm1hcmdpbkhlaWdodCIsCiAgICAgICAgICBtYXg6ICJtYXgiLAogICAgICAgICAgbWF4bGVuZ3RoOiAibWF4TGVuZ3RoIiwKICAgICAgICAgIG1lZGlhOiAibWVkaWEiLAogICAgICAgICAgbWVkaWFncm91cDogIm1lZGlhR3JvdXAiLAogICAgICAgICAgbWV0aG9kOiAibWV0aG9kIiwKICAgICAgICAgIG1pbjogIm1pbiIsCiAgICAgICAgICBtaW5sZW5ndGg6ICJtaW5MZW5ndGgiLAogICAgICAgICAgbXVsdGlwbGU6ICJtdWx0aXBsZSIsCiAgICAgICAgICBtdXRlZDogIm11dGVkIiwKICAgICAgICAgIG5hbWU6ICJuYW1lIiwKICAgICAgICAgIG5vbW9kdWxlOiAibm9Nb2R1bGUiLAogICAgICAgICAgbm9uY2U6ICJub25jZSIsCiAgICAgICAgICBub3ZhbGlkYXRlOiAibm9WYWxpZGF0ZSIsCiAgICAgICAgICBvcGVuOiAib3BlbiIsCiAgICAgICAgICBvcHRpbXVtOiAib3B0aW11bSIsCiAgICAgICAgICBwYXR0ZXJuOiAicGF0dGVybiIsCiAgICAgICAgICBwbGFjZWhvbGRlcjogInBsYWNlaG9sZGVyIiwKICAgICAgICAgIHBsYXlzaW5saW5lOiAicGxheXNJbmxpbmUiLAogICAgICAgICAgcG9zdGVyOiAicG9zdGVyIiwKICAgICAgICAgIHByZWxvYWQ6ICJwcmVsb2FkIiwKICAgICAgICAgIHByb2ZpbGU6ICJwcm9maWxlIiwKICAgICAgICAgIHJhZGlvZ3JvdXA6ICJyYWRpb0dyb3VwIiwKICAgICAgICAgIHJlYWRvbmx5OiAicmVhZE9ubHkiLAogICAgICAgICAgcmVmZXJyZXJwb2xpY3k6ICJyZWZlcnJlclBvbGljeSIsCiAgICAgICAgICByZWw6ICJyZWwiLAogICAgICAgICAgcmVxdWlyZWQ6ICJyZXF1aXJlZCIsCiAgICAgICAgICByZXZlcnNlZDogInJldmVyc2VkIiwKICAgICAgICAgIHJvbGU6ICJyb2xlIiwKICAgICAgICAgIHJvd3M6ICJyb3dzIiwKICAgICAgICAgIHJvd3NwYW46ICJyb3dTcGFuIiwKICAgICAgICAgIHNhbmRib3g6ICJzYW5kYm94IiwKICAgICAgICAgIHNjb3BlOiAic2NvcGUiLAogICAgICAgICAgc2NvcGVkOiAic2NvcGVkIiwKICAgICAgICAgIHNjcm9sbGluZzogInNjcm9sbGluZyIsCiAgICAgICAgICBzZWFtbGVzczogInNlYW1sZXNzIiwKICAgICAgICAgIHNlbGVjdGVkOiAic2VsZWN0ZWQiLAogICAgICAgICAgc2hhcGU6ICJzaGFwZSIsCiAgICAgICAgICBzaXplOiAic2l6ZSIsCiAgICAgICAgICBzaXplczogInNpemVzIiwKICAgICAgICAgIHNwYW46ICJzcGFuIiwKICAgICAgICAgIHNwZWxsY2hlY2s6ICJzcGVsbENoZWNrIiwKICAgICAgICAgIHNyYzogInNyYyIsCiAgICAgICAgICBzcmNkb2M6ICJzcmNEb2MiLAogICAgICAgICAgc3JjbGFuZzogInNyY0xhbmciLAogICAgICAgICAgc3Jjc2V0OiAic3JjU2V0IiwKICAgICAgICAgIHN0YXJ0OiAic3RhcnQiLAogICAgICAgICAgc3RlcDogInN0ZXAiLAogICAgICAgICAgc3R5bGU6ICJzdHlsZSIsCiAgICAgICAgICBzdW1tYXJ5OiAic3VtbWFyeSIsCiAgICAgICAgICB0YWJpbmRleDogInRhYkluZGV4IiwKICAgICAgICAgIHRhcmdldDogInRhcmdldCIsCiAgICAgICAgICB0aXRsZTogInRpdGxlIiwKICAgICAgICAgIHR5cGU6ICJ0eXBlIiwKICAgICAgICAgIHVzZW1hcDogInVzZU1hcCIsCiAgICAgICAgICB2YWx1ZTogInZhbHVlIiwKICAgICAgICAgIHdpZHRoOiAid2lkdGgiLAogICAgICAgICAgd21vZGU6ICJ3bW9kZSIsCiAgICAgICAgICB3cmFwOiAid3JhcCIsCiAgICAgICAgICAvLyBTVkcKICAgICAgICAgIGFib3V0OiAiYWJvdXQiLAogICAgICAgICAgYWNjZW50aGVpZ2h0OiAiYWNjZW50SGVpZ2h0IiwKICAgICAgICAgICJhY2NlbnQtaGVpZ2h0IjogImFjY2VudEhlaWdodCIsCiAgICAgICAgICBhY2N1bXVsYXRlOiAiYWNjdW11bGF0ZSIsCiAgICAgICAgICBhZGRpdGl2ZTogImFkZGl0aXZlIiwKICAgICAgICAgIGFsaWdubWVudGJhc2VsaW5lOiAiYWxpZ25tZW50QmFzZWxpbmUiLAogICAgICAgICAgImFsaWdubWVudC1iYXNlbGluZSI6ICJhbGlnbm1lbnRCYXNlbGluZSIsCiAgICAgICAgICBhbGxvd3Jlb3JkZXI6ICJhbGxvd1Jlb3JkZXIiLAogICAgICAgICAgYWxwaGFiZXRpYzogImFscGhhYmV0aWMiLAogICAgICAgICAgYW1wbGl0dWRlOiAiYW1wbGl0dWRlIiwKICAgICAgICAgIGFyYWJpY2Zvcm06ICJhcmFiaWNGb3JtIiwKICAgICAgICAgICJhcmFiaWMtZm9ybSI6ICJhcmFiaWNGb3JtIiwKICAgICAgICAgIGFzY2VudDogImFzY2VudCIsCiAgICAgICAgICBhdHRyaWJ1dGVuYW1lOiAiYXR0cmlidXRlTmFtZSIsCiAgICAgICAgICBhdHRyaWJ1dGV0eXBlOiAiYXR0cmlidXRlVHlwZSIsCiAgICAgICAgICBhdXRvcmV2ZXJzZTogImF1dG9SZXZlcnNlIiwKICAgICAgICAgIGF6aW11dGg6ICJhemltdXRoIiwKICAgICAgICAgIGJhc2VmcmVxdWVuY3k6ICJiYXNlRnJlcXVlbmN5IiwKICAgICAgICAgIGJhc2VsaW5lc2hpZnQ6ICJiYXNlbGluZVNoaWZ0IiwKICAgICAgICAgICJiYXNlbGluZS1zaGlmdCI6ICJiYXNlbGluZVNoaWZ0IiwKICAgICAgICAgIGJhc2Vwcm9maWxlOiAiYmFzZVByb2ZpbGUiLAogICAgICAgICAgYmJveDogImJib3giLAogICAgICAgICAgYmVnaW46ICJiZWdpbiIsCiAgICAgICAgICBiaWFzOiAiYmlhcyIsCiAgICAgICAgICBieTogImJ5IiwKICAgICAgICAgIGNhbGNtb2RlOiAiY2FsY01vZGUiLAogICAgICAgICAgY2FwaGVpZ2h0OiAiY2FwSGVpZ2h0IiwKICAgICAgICAgICJjYXAtaGVpZ2h0IjogImNhcEhlaWdodCIsCiAgICAgICAgICBjbGlwOiAiY2xpcCIsCiAgICAgICAgICBjbGlwcGF0aDogImNsaXBQYXRoIiwKICAgICAgICAgICJjbGlwLXBhdGgiOiAiY2xpcFBhdGgiLAogICAgICAgICAgY2xpcHBhdGh1bml0czogImNsaXBQYXRoVW5pdHMiLAogICAgICAgICAgY2xpcHJ1bGU6ICJjbGlwUnVsZSIsCiAgICAgICAgICAiY2xpcC1ydWxlIjogImNsaXBSdWxlIiwKICAgICAgICAgIGNvbG9yOiAiY29sb3IiLAogICAgICAgICAgY29sb3JpbnRlcnBvbGF0aW9uOiAiY29sb3JJbnRlcnBvbGF0aW9uIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uIjogImNvbG9ySW50ZXJwb2xhdGlvbiIsCiAgICAgICAgICBjb2xvcmludGVycG9sYXRpb25maWx0ZXJzOiAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgICAgICAgICAiY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzIjogImNvbG9ySW50ZXJwb2xhdGlvbkZpbHRlcnMiLAogICAgICAgICAgY29sb3Jwcm9maWxlOiAiY29sb3JQcm9maWxlIiwKICAgICAgICAgICJjb2xvci1wcm9maWxlIjogImNvbG9yUHJvZmlsZSIsCiAgICAgICAgICBjb2xvcnJlbmRlcmluZzogImNvbG9yUmVuZGVyaW5nIiwKICAgICAgICAgICJjb2xvci1yZW5kZXJpbmciOiAiY29sb3JSZW5kZXJpbmciLAogICAgICAgICAgY29udGVudHNjcmlwdHR5cGU6ICJjb250ZW50U2NyaXB0VHlwZSIsCiAgICAgICAgICBjb250ZW50c3R5bGV0eXBlOiAiY29udGVudFN0eWxlVHlwZSIsCiAgICAgICAgICBjdXJzb3I6ICJjdXJzb3IiLAogICAgICAgICAgY3g6ICJjeCIsCiAgICAgICAgICBjeTogImN5IiwKICAgICAgICAgIGQ6ICJkIiwKICAgICAgICAgIGRhdGF0eXBlOiAiZGF0YXR5cGUiLAogICAgICAgICAgZGVjZWxlcmF0ZTogImRlY2VsZXJhdGUiLAogICAgICAgICAgZGVzY2VudDogImRlc2NlbnQiLAogICAgICAgICAgZGlmZnVzZWNvbnN0YW50OiAiZGlmZnVzZUNvbnN0YW50IiwKICAgICAgICAgIGRpcmVjdGlvbjogImRpcmVjdGlvbiIsCiAgICAgICAgICBkaXNwbGF5OiAiZGlzcGxheSIsCiAgICAgICAgICBkaXZpc29yOiAiZGl2aXNvciIsCiAgICAgICAgICBkb21pbmFudGJhc2VsaW5lOiAiZG9taW5hbnRCYXNlbGluZSIsCiAgICAgICAgICAiZG9taW5hbnQtYmFzZWxpbmUiOiAiZG9taW5hbnRCYXNlbGluZSIsCiAgICAgICAgICBkdXI6ICJkdXIiLAogICAgICAgICAgZHg6ICJkeCIsCiAgICAgICAgICBkeTogImR5IiwKICAgICAgICAgIGVkZ2Vtb2RlOiAiZWRnZU1vZGUiLAogICAgICAgICAgZWxldmF0aW9uOiAiZWxldmF0aW9uIiwKICAgICAgICAgIGVuYWJsZWJhY2tncm91bmQ6ICJlbmFibGVCYWNrZ3JvdW5kIiwKICAgICAgICAgICJlbmFibGUtYmFja2dyb3VuZCI6ICJlbmFibGVCYWNrZ3JvdW5kIiwKICAgICAgICAgIGVuZDogImVuZCIsCiAgICAgICAgICBleHBvbmVudDogImV4cG9uZW50IiwKICAgICAgICAgIGV4dGVybmFscmVzb3VyY2VzcmVxdWlyZWQ6ICJleHRlcm5hbFJlc291cmNlc1JlcXVpcmVkIiwKICAgICAgICAgIGZpbGw6ICJmaWxsIiwKICAgICAgICAgIGZpbGxvcGFjaXR5OiAiZmlsbE9wYWNpdHkiLAogICAgICAgICAgImZpbGwtb3BhY2l0eSI6ICJmaWxsT3BhY2l0eSIsCiAgICAgICAgICBmaWxscnVsZTogImZpbGxSdWxlIiwKICAgICAgICAgICJmaWxsLXJ1bGUiOiAiZmlsbFJ1bGUiLAogICAgICAgICAgZmlsdGVyOiAiZmlsdGVyIiwKICAgICAgICAgIGZpbHRlcnJlczogImZpbHRlclJlcyIsCiAgICAgICAgICBmaWx0ZXJ1bml0czogImZpbHRlclVuaXRzIiwKICAgICAgICAgIGZsb29kb3BhY2l0eTogImZsb29kT3BhY2l0eSIsCiAgICAgICAgICAiZmxvb2Qtb3BhY2l0eSI6ICJmbG9vZE9wYWNpdHkiLAogICAgICAgICAgZmxvb2Rjb2xvcjogImZsb29kQ29sb3IiLAogICAgICAgICAgImZsb29kLWNvbG9yIjogImZsb29kQ29sb3IiLAogICAgICAgICAgZm9jdXNhYmxlOiAiZm9jdXNhYmxlIiwKICAgICAgICAgIGZvbnRmYW1pbHk6ICJmb250RmFtaWx5IiwKICAgICAgICAgICJmb250LWZhbWlseSI6ICJmb250RmFtaWx5IiwKICAgICAgICAgIGZvbnRzaXplOiAiZm9udFNpemUiLAogICAgICAgICAgImZvbnQtc2l6ZSI6ICJmb250U2l6ZSIsCiAgICAgICAgICBmb250c2l6ZWFkanVzdDogImZvbnRTaXplQWRqdXN0IiwKICAgICAgICAgICJmb250LXNpemUtYWRqdXN0IjogImZvbnRTaXplQWRqdXN0IiwKICAgICAgICAgIGZvbnRzdHJldGNoOiAiZm9udFN0cmV0Y2giLAogICAgICAgICAgImZvbnQtc3RyZXRjaCI6ICJmb250U3RyZXRjaCIsCiAgICAgICAgICBmb250c3R5bGU6ICJmb250U3R5bGUiLAogICAgICAgICAgImZvbnQtc3R5bGUiOiAiZm9udFN0eWxlIiwKICAgICAgICAgIGZvbnR2YXJpYW50OiAiZm9udFZhcmlhbnQiLAogICAgICAgICAgImZvbnQtdmFyaWFudCI6ICJmb250VmFyaWFudCIsCiAgICAgICAgICBmb250d2VpZ2h0OiAiZm9udFdlaWdodCIsCiAgICAgICAgICAiZm9udC13ZWlnaHQiOiAiZm9udFdlaWdodCIsCiAgICAgICAgICBmb3JtYXQ6ICJmb3JtYXQiLAogICAgICAgICAgZnJvbTogImZyb20iLAogICAgICAgICAgZng6ICJmeCIsCiAgICAgICAgICBmeTogImZ5IiwKICAgICAgICAgIGcxOiAiZzEiLAogICAgICAgICAgZzI6ICJnMiIsCiAgICAgICAgICBnbHlwaG5hbWU6ICJnbHlwaE5hbWUiLAogICAgICAgICAgImdseXBoLW5hbWUiOiAiZ2x5cGhOYW1lIiwKICAgICAgICAgIGdseXBob3JpZW50YXRpb25ob3Jpem9udGFsOiAiZ2x5cGhPcmllbnRhdGlvbkhvcml6b250YWwiLAogICAgICAgICAgImdseXBoLW9yaWVudGF0aW9uLWhvcml6b250YWwiOiAiZ2x5cGhPcmllbnRhdGlvbkhvcml6b250YWwiLAogICAgICAgICAgZ2x5cGhvcmllbnRhdGlvbnZlcnRpY2FsOiAiZ2x5cGhPcmllbnRhdGlvblZlcnRpY2FsIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi12ZXJ0aWNhbCI6ICJnbHlwaE9yaWVudGF0aW9uVmVydGljYWwiLAogICAgICAgICAgZ2x5cGhyZWY6ICJnbHlwaFJlZiIsCiAgICAgICAgICBncmFkaWVudHRyYW5zZm9ybTogImdyYWRpZW50VHJhbnNmb3JtIiwKICAgICAgICAgIGdyYWRpZW50dW5pdHM6ICJncmFkaWVudFVuaXRzIiwKICAgICAgICAgIGhhbmdpbmc6ICJoYW5naW5nIiwKICAgICAgICAgIGhvcml6YWR2eDogImhvcml6QWR2WCIsCiAgICAgICAgICAiaG9yaXotYWR2LXgiOiAiaG9yaXpBZHZYIiwKICAgICAgICAgIGhvcml6b3JpZ2lueDogImhvcml6T3JpZ2luWCIsCiAgICAgICAgICAiaG9yaXotb3JpZ2luLXgiOiAiaG9yaXpPcmlnaW5YIiwKICAgICAgICAgIGlkZW9ncmFwaGljOiAiaWRlb2dyYXBoaWMiLAogICAgICAgICAgaW1hZ2VyZW5kZXJpbmc6ICJpbWFnZVJlbmRlcmluZyIsCiAgICAgICAgICAiaW1hZ2UtcmVuZGVyaW5nIjogImltYWdlUmVuZGVyaW5nIiwKICAgICAgICAgIGluMjogImluMiIsCiAgICAgICAgICBpbjogImluIiwKICAgICAgICAgIGlubGlzdDogImlubGlzdCIsCiAgICAgICAgICBpbnRlcmNlcHQ6ICJpbnRlcmNlcHQiLAogICAgICAgICAgazE6ICJrMSIsCiAgICAgICAgICBrMjogImsyIiwKICAgICAgICAgIGszOiAiazMiLAogICAgICAgICAgazQ6ICJrNCIsCiAgICAgICAgICBrOiAiayIsCiAgICAgICAgICBrZXJuZWxtYXRyaXg6ICJrZXJuZWxNYXRyaXgiLAogICAgICAgICAga2VybmVsdW5pdGxlbmd0aDogImtlcm5lbFVuaXRMZW5ndGgiLAogICAgICAgICAga2VybmluZzogImtlcm5pbmciLAogICAgICAgICAga2V5cG9pbnRzOiAia2V5UG9pbnRzIiwKICAgICAgICAgIGtleXNwbGluZXM6ICJrZXlTcGxpbmVzIiwKICAgICAgICAgIGtleXRpbWVzOiAia2V5VGltZXMiLAogICAgICAgICAgbGVuZ3RoYWRqdXN0OiAibGVuZ3RoQWRqdXN0IiwKICAgICAgICAgIGxldHRlcnNwYWNpbmc6ICJsZXR0ZXJTcGFjaW5nIiwKICAgICAgICAgICJsZXR0ZXItc3BhY2luZyI6ICJsZXR0ZXJTcGFjaW5nIiwKICAgICAgICAgIGxpZ2h0aW5nY29sb3I6ICJsaWdodGluZ0NvbG9yIiwKICAgICAgICAgICJsaWdodGluZy1jb2xvciI6ICJsaWdodGluZ0NvbG9yIiwKICAgICAgICAgIGxpbWl0aW5nY29uZWFuZ2xlOiAibGltaXRpbmdDb25lQW5nbGUiLAogICAgICAgICAgbG9jYWw6ICJsb2NhbCIsCiAgICAgICAgICBtYXJrZXJlbmQ6ICJtYXJrZXJFbmQiLAogICAgICAgICAgIm1hcmtlci1lbmQiOiAibWFya2VyRW5kIiwKICAgICAgICAgIG1hcmtlcmhlaWdodDogIm1hcmtlckhlaWdodCIsCiAgICAgICAgICBtYXJrZXJtaWQ6ICJtYXJrZXJNaWQiLAogICAgICAgICAgIm1hcmtlci1taWQiOiAibWFya2VyTWlkIiwKICAgICAgICAgIG1hcmtlcnN0YXJ0OiAibWFya2VyU3RhcnQiLAogICAgICAgICAgIm1hcmtlci1zdGFydCI6ICJtYXJrZXJTdGFydCIsCiAgICAgICAgICBtYXJrZXJ1bml0czogIm1hcmtlclVuaXRzIiwKICAgICAgICAgIG1hcmtlcndpZHRoOiAibWFya2VyV2lkdGgiLAogICAgICAgICAgbWFzazogIm1hc2siLAogICAgICAgICAgbWFza2NvbnRlbnR1bml0czogIm1hc2tDb250ZW50VW5pdHMiLAogICAgICAgICAgbWFza3VuaXRzOiAibWFza1VuaXRzIiwKICAgICAgICAgIG1hdGhlbWF0aWNhbDogIm1hdGhlbWF0aWNhbCIsCiAgICAgICAgICBtb2RlOiAibW9kZSIsCiAgICAgICAgICBudW1vY3RhdmVzOiAibnVtT2N0YXZlcyIsCiAgICAgICAgICBvZmZzZXQ6ICJvZmZzZXQiLAogICAgICAgICAgb3BhY2l0eTogIm9wYWNpdHkiLAogICAgICAgICAgb3BlcmF0b3I6ICJvcGVyYXRvciIsCiAgICAgICAgICBvcmRlcjogIm9yZGVyIiwKICAgICAgICAgIG9yaWVudDogIm9yaWVudCIsCiAgICAgICAgICBvcmllbnRhdGlvbjogIm9yaWVudGF0aW9uIiwKICAgICAgICAgIG9yaWdpbjogIm9yaWdpbiIsCiAgICAgICAgICBvdmVyZmxvdzogIm92ZXJmbG93IiwKICAgICAgICAgIG92ZXJsaW5lcG9zaXRpb246ICJvdmVybGluZVBvc2l0aW9uIiwKICAgICAgICAgICJvdmVybGluZS1wb3NpdGlvbiI6ICJvdmVybGluZVBvc2l0aW9uIiwKICAgICAgICAgIG92ZXJsaW5ldGhpY2tuZXNzOiAib3ZlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgIm92ZXJsaW5lLXRoaWNrbmVzcyI6ICJvdmVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICBwYWludG9yZGVyOiAicGFpbnRPcmRlciIsCiAgICAgICAgICAicGFpbnQtb3JkZXIiOiAicGFpbnRPcmRlciIsCiAgICAgICAgICBwYW5vc2UxOiAicGFub3NlMSIsCiAgICAgICAgICAicGFub3NlLTEiOiAicGFub3NlMSIsCiAgICAgICAgICBwYXRobGVuZ3RoOiAicGF0aExlbmd0aCIsCiAgICAgICAgICBwYXR0ZXJuY29udGVudHVuaXRzOiAicGF0dGVybkNvbnRlbnRVbml0cyIsCiAgICAgICAgICBwYXR0ZXJudHJhbnNmb3JtOiAicGF0dGVyblRyYW5zZm9ybSIsCiAgICAgICAgICBwYXR0ZXJudW5pdHM6ICJwYXR0ZXJuVW5pdHMiLAogICAgICAgICAgcG9pbnRlcmV2ZW50czogInBvaW50ZXJFdmVudHMiLAogICAgICAgICAgInBvaW50ZXItZXZlbnRzIjogInBvaW50ZXJFdmVudHMiLAogICAgICAgICAgcG9pbnRzOiAicG9pbnRzIiwKICAgICAgICAgIHBvaW50c2F0eDogInBvaW50c0F0WCIsCiAgICAgICAgICBwb2ludHNhdHk6ICJwb2ludHNBdFkiLAogICAgICAgICAgcG9pbnRzYXR6OiAicG9pbnRzQXRaIiwKICAgICAgICAgIHByZWZpeDogInByZWZpeCIsCiAgICAgICAgICBwcmVzZXJ2ZWFscGhhOiAicHJlc2VydmVBbHBoYSIsCiAgICAgICAgICBwcmVzZXJ2ZWFzcGVjdHJhdGlvOiAicHJlc2VydmVBc3BlY3RSYXRpbyIsCiAgICAgICAgICBwcmltaXRpdmV1bml0czogInByaW1pdGl2ZVVuaXRzIiwKICAgICAgICAgIHByb3BlcnR5OiAicHJvcGVydHkiLAogICAgICAgICAgcjogInIiLAogICAgICAgICAgcmFkaXVzOiAicmFkaXVzIiwKICAgICAgICAgIHJlZng6ICJyZWZYIiwKICAgICAgICAgIHJlZnk6ICJyZWZZIiwKICAgICAgICAgIHJlbmRlcmluZ2ludGVudDogInJlbmRlcmluZ0ludGVudCIsCiAgICAgICAgICAicmVuZGVyaW5nLWludGVudCI6ICJyZW5kZXJpbmdJbnRlbnQiLAogICAgICAgICAgcmVwZWF0Y291bnQ6ICJyZXBlYXRDb3VudCIsCiAgICAgICAgICByZXBlYXRkdXI6ICJyZXBlYXREdXIiLAogICAgICAgICAgcmVxdWlyZWRleHRlbnNpb25zOiAicmVxdWlyZWRFeHRlbnNpb25zIiwKICAgICAgICAgIHJlcXVpcmVkZmVhdHVyZXM6ICJyZXF1aXJlZEZlYXR1cmVzIiwKICAgICAgICAgIHJlc291cmNlOiAicmVzb3VyY2UiLAogICAgICAgICAgcmVzdGFydDogInJlc3RhcnQiLAogICAgICAgICAgcmVzdWx0OiAicmVzdWx0IiwKICAgICAgICAgIHJlc3VsdHM6ICJyZXN1bHRzIiwKICAgICAgICAgIHJvdGF0ZTogInJvdGF0ZSIsCiAgICAgICAgICByeDogInJ4IiwKICAgICAgICAgIHJ5OiAicnkiLAogICAgICAgICAgc2NhbGU6ICJzY2FsZSIsCiAgICAgICAgICBzZWN1cml0eTogInNlY3VyaXR5IiwKICAgICAgICAgIHNlZWQ6ICJzZWVkIiwKICAgICAgICAgIHNoYXBlcmVuZGVyaW5nOiAic2hhcGVSZW5kZXJpbmciLAogICAgICAgICAgInNoYXBlLXJlbmRlcmluZyI6ICJzaGFwZVJlbmRlcmluZyIsCiAgICAgICAgICBzbG9wZTogInNsb3BlIiwKICAgICAgICAgIHNwYWNpbmc6ICJzcGFjaW5nIiwKICAgICAgICAgIHNwZWN1bGFyY29uc3RhbnQ6ICJzcGVjdWxhckNvbnN0YW50IiwKICAgICAgICAgIHNwZWN1bGFyZXhwb25lbnQ6ICJzcGVjdWxhckV4cG9uZW50IiwKICAgICAgICAgIHNwZWVkOiAic3BlZWQiLAogICAgICAgICAgc3ByZWFkbWV0aG9kOiAic3ByZWFkTWV0aG9kIiwKICAgICAgICAgIHN0YXJ0b2Zmc2V0OiAic3RhcnRPZmZzZXQiLAogICAgICAgICAgc3RkZGV2aWF0aW9uOiAic3RkRGV2aWF0aW9uIiwKICAgICAgICAgIHN0ZW1oOiAic3RlbWgiLAogICAgICAgICAgc3RlbXY6ICJzdGVtdiIsCiAgICAgICAgICBzdGl0Y2h0aWxlczogInN0aXRjaFRpbGVzIiwKICAgICAgICAgIHN0b3Bjb2xvcjogInN0b3BDb2xvciIsCiAgICAgICAgICAic3RvcC1jb2xvciI6ICJzdG9wQ29sb3IiLAogICAgICAgICAgc3RvcG9wYWNpdHk6ICJzdG9wT3BhY2l0eSIsCiAgICAgICAgICAic3RvcC1vcGFjaXR5IjogInN0b3BPcGFjaXR5IiwKICAgICAgICAgIHN0cmlrZXRocm91Z2hwb3NpdGlvbjogInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC1wb3NpdGlvbiI6ICJzdHJpa2V0aHJvdWdoUG9zaXRpb24iLAogICAgICAgICAgc3RyaWtldGhyb3VnaHRoaWNrbmVzczogInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICAgICAgICAgInN0cmlrZXRocm91Z2gtdGhpY2tuZXNzIjogInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICAgICAgICAgc3RyaW5nOiAic3RyaW5nIiwKICAgICAgICAgIHN0cm9rZTogInN0cm9rZSIsCiAgICAgICAgICBzdHJva2VkYXNoYXJyYXk6ICJzdHJva2VEYXNoYXJyYXkiLAogICAgICAgICAgInN0cm9rZS1kYXNoYXJyYXkiOiAic3Ryb2tlRGFzaGFycmF5IiwKICAgICAgICAgIHN0cm9rZWRhc2hvZmZzZXQ6ICJzdHJva2VEYXNob2Zmc2V0IiwKICAgICAgICAgICJzdHJva2UtZGFzaG9mZnNldCI6ICJzdHJva2VEYXNob2Zmc2V0IiwKICAgICAgICAgIHN0cm9rZWxpbmVjYXA6ICJzdHJva2VMaW5lY2FwIiwKICAgICAgICAgICJzdHJva2UtbGluZWNhcCI6ICJzdHJva2VMaW5lY2FwIiwKICAgICAgICAgIHN0cm9rZWxpbmVqb2luOiAic3Ryb2tlTGluZWpvaW4iLAogICAgICAgICAgInN0cm9rZS1saW5lam9pbiI6ICJzdHJva2VMaW5lam9pbiIsCiAgICAgICAgICBzdHJva2VtaXRlcmxpbWl0OiAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgICAgICAgICAic3Ryb2tlLW1pdGVybGltaXQiOiAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgICAgICAgICBzdHJva2V3aWR0aDogInN0cm9rZVdpZHRoIiwKICAgICAgICAgICJzdHJva2Utd2lkdGgiOiAic3Ryb2tlV2lkdGgiLAogICAgICAgICAgc3Ryb2tlb3BhY2l0eTogInN0cm9rZU9wYWNpdHkiLAogICAgICAgICAgInN0cm9rZS1vcGFjaXR5IjogInN0cm9rZU9wYWNpdHkiLAogICAgICAgICAgc3VwcHJlc3Njb250ZW50ZWRpdGFibGV3YXJuaW5nOiAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIiwKICAgICAgICAgIHN1cHByZXNzaHlkcmF0aW9ud2FybmluZzogInN1cHByZXNzSHlkcmF0aW9uV2FybmluZyIsCiAgICAgICAgICBzdXJmYWNlc2NhbGU6ICJzdXJmYWNlU2NhbGUiLAogICAgICAgICAgc3lzdGVtbGFuZ3VhZ2U6ICJzeXN0ZW1MYW5ndWFnZSIsCiAgICAgICAgICB0YWJsZXZhbHVlczogInRhYmxlVmFsdWVzIiwKICAgICAgICAgIHRhcmdldHg6ICJ0YXJnZXRYIiwKICAgICAgICAgIHRhcmdldHk6ICJ0YXJnZXRZIiwKICAgICAgICAgIHRleHRhbmNob3I6ICJ0ZXh0QW5jaG9yIiwKICAgICAgICAgICJ0ZXh0LWFuY2hvciI6ICJ0ZXh0QW5jaG9yIiwKICAgICAgICAgIHRleHRkZWNvcmF0aW9uOiAidGV4dERlY29yYXRpb24iLAogICAgICAgICAgInRleHQtZGVjb3JhdGlvbiI6ICJ0ZXh0RGVjb3JhdGlvbiIsCiAgICAgICAgICB0ZXh0bGVuZ3RoOiAidGV4dExlbmd0aCIsCiAgICAgICAgICB0ZXh0cmVuZGVyaW5nOiAidGV4dFJlbmRlcmluZyIsCiAgICAgICAgICAidGV4dC1yZW5kZXJpbmciOiAidGV4dFJlbmRlcmluZyIsCiAgICAgICAgICB0bzogInRvIiwKICAgICAgICAgIHRyYW5zZm9ybTogInRyYW5zZm9ybSIsCiAgICAgICAgICB0eXBlb2Y6ICJ0eXBlb2YiLAogICAgICAgICAgdTE6ICJ1MSIsCiAgICAgICAgICB1MjogInUyIiwKICAgICAgICAgIHVuZGVybGluZXBvc2l0aW9uOiAidW5kZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgInVuZGVybGluZS1wb3NpdGlvbiI6ICJ1bmRlcmxpbmVQb3NpdGlvbiIsCiAgICAgICAgICB1bmRlcmxpbmV0aGlja25lc3M6ICJ1bmRlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgInVuZGVybGluZS10aGlja25lc3MiOiAidW5kZXJsaW5lVGhpY2tuZXNzIiwKICAgICAgICAgIHVuaWNvZGU6ICJ1bmljb2RlIiwKICAgICAgICAgIHVuaWNvZGViaWRpOiAidW5pY29kZUJpZGkiLAogICAgICAgICAgInVuaWNvZGUtYmlkaSI6ICJ1bmljb2RlQmlkaSIsCiAgICAgICAgICB1bmljb2RlcmFuZ2U6ICJ1bmljb2RlUmFuZ2UiLAogICAgICAgICAgInVuaWNvZGUtcmFuZ2UiOiAidW5pY29kZVJhbmdlIiwKICAgICAgICAgIHVuaXRzcGVyZW06ICJ1bml0c1BlckVtIiwKICAgICAgICAgICJ1bml0cy1wZXItZW0iOiAidW5pdHNQZXJFbSIsCiAgICAgICAgICB1bnNlbGVjdGFibGU6ICJ1bnNlbGVjdGFibGUiLAogICAgICAgICAgdmFscGhhYmV0aWM6ICJ2QWxwaGFiZXRpYyIsCiAgICAgICAgICAidi1hbHBoYWJldGljIjogInZBbHBoYWJldGljIiwKICAgICAgICAgIHZhbHVlczogInZhbHVlcyIsCiAgICAgICAgICB2ZWN0b3JlZmZlY3Q6ICJ2ZWN0b3JFZmZlY3QiLAogICAgICAgICAgInZlY3Rvci1lZmZlY3QiOiAidmVjdG9yRWZmZWN0IiwKICAgICAgICAgIHZlcnNpb246ICJ2ZXJzaW9uIiwKICAgICAgICAgIHZlcnRhZHZ5OiAidmVydEFkdlkiLAogICAgICAgICAgInZlcnQtYWR2LXkiOiAidmVydEFkdlkiLAogICAgICAgICAgdmVydG9yaWdpbng6ICJ2ZXJ0T3JpZ2luWCIsCiAgICAgICAgICAidmVydC1vcmlnaW4teCI6ICJ2ZXJ0T3JpZ2luWCIsCiAgICAgICAgICB2ZXJ0b3JpZ2lueTogInZlcnRPcmlnaW5ZIiwKICAgICAgICAgICJ2ZXJ0LW9yaWdpbi15IjogInZlcnRPcmlnaW5ZIiwKICAgICAgICAgIHZoYW5naW5nOiAidkhhbmdpbmciLAogICAgICAgICAgInYtaGFuZ2luZyI6ICJ2SGFuZ2luZyIsCiAgICAgICAgICB2aWRlb2dyYXBoaWM6ICJ2SWRlb2dyYXBoaWMiLAogICAgICAgICAgInYtaWRlb2dyYXBoaWMiOiAidklkZW9ncmFwaGljIiwKICAgICAgICAgIHZpZXdib3g6ICJ2aWV3Qm94IiwKICAgICAgICAgIHZpZXd0YXJnZXQ6ICJ2aWV3VGFyZ2V0IiwKICAgICAgICAgIHZpc2liaWxpdHk6ICJ2aXNpYmlsaXR5IiwKICAgICAgICAgIHZtYXRoZW1hdGljYWw6ICJ2TWF0aGVtYXRpY2FsIiwKICAgICAgICAgICJ2LW1hdGhlbWF0aWNhbCI6ICJ2TWF0aGVtYXRpY2FsIiwKICAgICAgICAgIHZvY2FiOiAidm9jYWIiLAogICAgICAgICAgd2lkdGhzOiAid2lkdGhzIiwKICAgICAgICAgIHdvcmRzcGFjaW5nOiAid29yZFNwYWNpbmciLAogICAgICAgICAgIndvcmQtc3BhY2luZyI6ICJ3b3JkU3BhY2luZyIsCiAgICAgICAgICB3cml0aW5nbW9kZTogIndyaXRpbmdNb2RlIiwKICAgICAgICAgICJ3cml0aW5nLW1vZGUiOiAid3JpdGluZ01vZGUiLAogICAgICAgICAgeDE6ICJ4MSIsCiAgICAgICAgICB4MjogIngyIiwKICAgICAgICAgIHg6ICJ4IiwKICAgICAgICAgIHhjaGFubmVsc2VsZWN0b3I6ICJ4Q2hhbm5lbFNlbGVjdG9yIiwKICAgICAgICAgIHhoZWlnaHQ6ICJ4SGVpZ2h0IiwKICAgICAgICAgICJ4LWhlaWdodCI6ICJ4SGVpZ2h0IiwKICAgICAgICAgIHhsaW5rYWN0dWF0ZTogInhsaW5rQWN0dWF0ZSIsCiAgICAgICAgICAieGxpbms6YWN0dWF0ZSI6ICJ4bGlua0FjdHVhdGUiLAogICAgICAgICAgeGxpbmthcmNyb2xlOiAieGxpbmtBcmNyb2xlIiwKICAgICAgICAgICJ4bGluazphcmNyb2xlIjogInhsaW5rQXJjcm9sZSIsCiAgICAgICAgICB4bGlua2hyZWY6ICJ4bGlua0hyZWYiLAogICAgICAgICAgInhsaW5rOmhyZWYiOiAieGxpbmtIcmVmIiwKICAgICAgICAgIHhsaW5rcm9sZTogInhsaW5rUm9sZSIsCiAgICAgICAgICAieGxpbms6cm9sZSI6ICJ4bGlua1JvbGUiLAogICAgICAgICAgeGxpbmtzaG93OiAieGxpbmtTaG93IiwKICAgICAgICAgICJ4bGluazpzaG93IjogInhsaW5rU2hvdyIsCiAgICAgICAgICB4bGlua3RpdGxlOiAieGxpbmtUaXRsZSIsCiAgICAgICAgICAieGxpbms6dGl0bGUiOiAieGxpbmtUaXRsZSIsCiAgICAgICAgICB4bGlua3R5cGU6ICJ4bGlua1R5cGUiLAogICAgICAgICAgInhsaW5rOnR5cGUiOiAieGxpbmtUeXBlIiwKICAgICAgICAgIHhtbGJhc2U6ICJ4bWxCYXNlIiwKICAgICAgICAgICJ4bWw6YmFzZSI6ICJ4bWxCYXNlIiwKICAgICAgICAgIHhtbGxhbmc6ICJ4bWxMYW5nIiwKICAgICAgICAgICJ4bWw6bGFuZyI6ICJ4bWxMYW5nIiwKICAgICAgICAgIHhtbG5zOiAieG1sbnMiLAogICAgICAgICAgInhtbDpzcGFjZSI6ICJ4bWxTcGFjZSIsCiAgICAgICAgICB4bWxuc3hsaW5rOiAieG1sbnNYbGluayIsCiAgICAgICAgICAieG1sbnM6eGxpbmsiOiAieG1sbnNYbGluayIsCiAgICAgICAgICB4bWxzcGFjZTogInhtbFNwYWNlIiwKICAgICAgICAgIHkxOiAieTEiLAogICAgICAgICAgeTI6ICJ5MiIsCiAgICAgICAgICB5OiAieSIsCiAgICAgICAgICB5Y2hhbm5lbHNlbGVjdG9yOiAieUNoYW5uZWxTZWxlY3RvciIsCiAgICAgICAgICB6OiAieiIsCiAgICAgICAgICB6b29tYW5kcGFuOiAiem9vbUFuZFBhbiIKICAgICAgICB9OwogICAgICAgIHZhciBhcmlhUHJvcGVydGllcyA9IHsKICAgICAgICAgICJhcmlhLWN1cnJlbnQiOiAwLAogICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICJhcmlhLWRlc2NyaXB0aW9uIjogMCwKICAgICAgICAgICJhcmlhLWRldGFpbHMiOiAwLAogICAgICAgICAgImFyaWEtZGlzYWJsZWQiOiAwLAogICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICJhcmlhLWhpZGRlbiI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEtaW52YWxpZCI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEta2V5c2hvcnRjdXRzIjogMCwKICAgICAgICAgICJhcmlhLWxhYmVsIjogMCwKICAgICAgICAgICJhcmlhLXJvbGVkZXNjcmlwdGlvbiI6IDAsCiAgICAgICAgICAvLyBXaWRnZXQgQXR0cmlidXRlcwogICAgICAgICAgImFyaWEtYXV0b2NvbXBsZXRlIjogMCwKICAgICAgICAgICJhcmlhLWNoZWNrZWQiOiAwLAogICAgICAgICAgImFyaWEtZXhwYW5kZWQiOiAwLAogICAgICAgICAgImFyaWEtaGFzcG9wdXAiOiAwLAogICAgICAgICAgImFyaWEtbGV2ZWwiOiAwLAogICAgICAgICAgImFyaWEtbW9kYWwiOiAwLAogICAgICAgICAgImFyaWEtbXVsdGlsaW5lIjogMCwKICAgICAgICAgICJhcmlhLW11bHRpc2VsZWN0YWJsZSI6IDAsCiAgICAgICAgICAiYXJpYS1vcmllbnRhdGlvbiI6IDAsCiAgICAgICAgICAiYXJpYS1wbGFjZWhvbGRlciI6IDAsCiAgICAgICAgICAiYXJpYS1wcmVzc2VkIjogMCwKICAgICAgICAgICJhcmlhLXJlYWRvbmx5IjogMCwKICAgICAgICAgICJhcmlhLXJlcXVpcmVkIjogMCwKICAgICAgICAgICJhcmlhLXNlbGVjdGVkIjogMCwKICAgICAgICAgICJhcmlhLXNvcnQiOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVtYXgiOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVtaW4iOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVub3ciOiAwLAogICAgICAgICAgImFyaWEtdmFsdWV0ZXh0IjogMCwKICAgICAgICAgIC8vIExpdmUgUmVnaW9uIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWF0b21pYyI6IDAsCiAgICAgICAgICAiYXJpYS1idXN5IjogMCwKICAgICAgICAgICJhcmlhLWxpdmUiOiAwLAogICAgICAgICAgImFyaWEtcmVsZXZhbnQiOiAwLAogICAgICAgICAgLy8gRHJhZy1hbmQtRHJvcCBBdHRyaWJ1dGVzCiAgICAgICAgICAiYXJpYS1kcm9wZWZmZWN0IjogMCwKICAgICAgICAgICJhcmlhLWdyYWJiZWQiOiAwLAogICAgICAgICAgLy8gUmVsYXRpb25zaGlwIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiOiAwLAogICAgICAgICAgImFyaWEtY29sY291bnQiOiAwLAogICAgICAgICAgImFyaWEtY29saW5kZXgiOiAwLAogICAgICAgICAgImFyaWEtY29sc3BhbiI6IDAsCiAgICAgICAgICAiYXJpYS1jb250cm9scyI6IDAsCiAgICAgICAgICAiYXJpYS1kZXNjcmliZWRieSI6IDAsCiAgICAgICAgICAiYXJpYS1lcnJvcm1lc3NhZ2UiOiAwLAogICAgICAgICAgImFyaWEtZmxvd3RvIjogMCwKICAgICAgICAgICJhcmlhLWxhYmVsbGVkYnkiOiAwLAogICAgICAgICAgImFyaWEtb3ducyI6IDAsCiAgICAgICAgICAiYXJpYS1wb3NpbnNldCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3djb3VudCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3dpbmRleCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3dzcGFuIjogMCwKICAgICAgICAgICJhcmlhLXNldHNpemUiOiAwCiAgICAgICAgfTsKICAgICAgICB2YXIgd2FybmVkUHJvcGVydGllcyA9IHt9OwogICAgICAgIHZhciByQVJJQSA9IG5ldyBSZWdFeHAoIl4oYXJpYSktWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIHZhciByQVJJQUNhbWVsID0gbmV3IFJlZ0V4cCgiXihhcmlhKVtBLVpdWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydHkodGFnTmFtZSwgbmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh3YXJuZWRQcm9wZXJ0aWVzLCBuYW1lKSAmJiB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBQ2FtZWwudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIHZhciBhcmlhTmFtZSA9ICJhcmlhLSIgKyBuYW1lLnNsaWNlKDQpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgdmFyIGNvcnJlY3ROYW1lID0gYXJpYVByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoYXJpYU5hbWUpID8gYXJpYU5hbWUgOiBudWxsOwogICAgICAgICAgICAgIGlmIChjb3JyZWN0TmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBBUklBIGF0dHJpYnV0ZSBgJXNgLiBBUklBIGF0dHJpYnV0ZXMgZm9sbG93IHRoZSBwYXR0ZXJuIGFyaWEtKiBhbmQgbXVzdCBiZSBsb3dlcmNhc2UuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmFtZSAhPT0gY29ycmVjdE5hbWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIEFSSUEgYXR0cmlidXRlIGAlc2AuIERpZCB5b3UgbWVhbiBgJXNgPyIsIG5hbWUsIGNvcnJlY3ROYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyQVJJQS50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIHZhciBzdGFuZGFyZE5hbWUgPSBhcmlhUHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkgPyBsb3dlckNhc2VkTmFtZSA6IG51bGw7CiAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5hbWUgIT09IHN0YW5kYXJkTmFtZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlVua25vd24gQVJJQSBhdHRyaWJ1dGUgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgc3RhbmRhcmROYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkludmFsaWRBUklBUHJvcHModHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGludmFsaWRQcm9wcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9IHZhbGlkYXRlUHJvcGVydHkodHlwZSwga2V5KTsKICAgICAgICAgICAgICBpZiAoIWlzVmFsaWQpIHsKICAgICAgICAgICAgICAgIGludmFsaWRQcm9wcy5wdXNoKGtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB1bmtub3duUHJvcFN0cmluZyA9IGludmFsaWRQcm9wcy5tYXAoZnVuY3Rpb24ocHJvcCkgewogICAgICAgICAgICAgIHJldHVybiAiYCIgKyBwcm9wICsgImAiOwogICAgICAgICAgICB9KS5qb2luKCIsICIpOwogICAgICAgICAgICBpZiAoaW52YWxpZFByb3BzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGFyaWEgcHJvcCAlcyBvbiA8JXM+IHRhZy4gRm9yIGRldGFpbHMsIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1hcmlhLXByb3BzIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGludmFsaWRQcm9wcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXJpYSBwcm9wcyAlcyBvbiA8JXM+IHRhZy4gRm9yIGRldGFpbHMsIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1hcmlhLXByb3BzIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydGllcyh0eXBlLCBwcm9wcykgewogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuSW52YWxpZEFSSUFQcm9wcyh0eXBlLCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVOdWxsID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0aWVzJDEodHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGUgIT09ICJpbnB1dCIgJiYgdHlwZSAhPT0gInRleHRhcmVhIiAmJiB0eXBlICE9PSAic2VsZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMgIT0gbnVsbCAmJiBwcm9wcy52YWx1ZSA9PT0gbnVsbCAmJiAhZGlkV2FyblZhbHVlTnVsbCkgewogICAgICAgICAgICAgIGRpZFdhcm5WYWx1ZU51bGwgPSB0cnVlOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSAic2VsZWN0IiAmJiBwcm9wcy5tdWx0aXBsZSkgewogICAgICAgICAgICAgICAgZXJyb3IoImB2YWx1ZWAgcHJvcCBvbiBgJXNgIHNob3VsZCBub3QgYmUgbnVsbC4gQ29uc2lkZXIgdXNpbmcgYW4gZW1wdHkgYXJyYXkgd2hlbiBgbXVsdGlwbGVgIGlzIHNldCB0byBgdHJ1ZWAgdG8gY2xlYXIgdGhlIGNvbXBvbmVudCBvciBgdW5kZWZpbmVkYCBmb3IgdW5jb250cm9sbGVkIGNvbXBvbmVudHMuIiwgdHlwZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCJgdmFsdWVgIHByb3Agb24gYCVzYCBzaG91bGQgbm90IGJlIG51bGwuIENvbnNpZGVyIHVzaW5nIGFuIGVtcHR5IHN0cmluZyB0byBjbGVhciB0aGUgY29tcG9uZW50IG9yIGB1bmRlZmluZWRgIGZvciB1bmNvbnRyb2xsZWQgY29tcG9uZW50cy4iLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHZhbGlkYXRlUHJvcGVydHkkMSA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIHdhcm5lZFByb3BlcnRpZXMkMSA9IHt9OwogICAgICAgICAgdmFyIEVWRU5UX05BTUVfUkVHRVggPSAvXm9uLi87CiAgICAgICAgICB2YXIgSU5WQUxJRF9FVkVOVF9OQU1FX1JFR0VYID0gL15vblteQS1aXS87CiAgICAgICAgICB2YXIgckFSSUEkMSA9IG5ldyBSZWdFeHAoIl4oYXJpYSktWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgICAgdmFyIHJBUklBQ2FtZWwkMSA9IG5ldyBSZWdFeHAoIl4oYXJpYSlbQS1aXVsiICsgQVRUUklCVVRFX05BTUVfQ0hBUiArICJdKiQiKTsKICAgICAgICAgIHZhbGlkYXRlUHJvcGVydHkkMSA9IGZ1bmN0aW9uKHRhZ05hbWUsIG5hbWUsIHZhbHVlLCBldmVudFJlZ2lzdHJ5KSB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFByb3BlcnRpZXMkMSwgbmFtZSkgJiYgd2FybmVkUHJvcGVydGllcyQxW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBpZiAobG93ZXJDYXNlZE5hbWUgPT09ICJvbmZvY3VzaW4iIHx8IGxvd2VyQ2FzZWROYW1lID09PSAib25mb2N1c291dCIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgdXNlcyBvbkZvY3VzIGFuZCBvbkJsdXIgaW5zdGVhZCBvZiBvbkZvY3VzSW4gYW5kIG9uRm9jdXNPdXQuIEFsbCBSZWFjdCBldmVudHMgYXJlIG5vcm1hbGl6ZWQgdG8gYnViYmxlLCBzbyBvbkZvY3VzSW4gYW5kIG9uRm9jdXNPdXQgYXJlIG5vdCBuZWVkZWQvc3VwcG9ydGVkIGJ5IFJlYWN0LiIpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV2ZW50UmVnaXN0cnkgIT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciByZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzMiA9IGV2ZW50UmVnaXN0cnkucmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcywgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lczIgPSBldmVudFJlZ2lzdHJ5LnBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXM7CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMyLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWUgPSBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMi5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkgPyBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMltsb3dlckNhc2VkTmFtZV0gOiBudWxsOwogICAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChFVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJVbmtub3duIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gSXQgd2lsbCBiZSBpZ25vcmVkLiIsIG5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChFVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICBpZiAoSU5WQUxJRF9FVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gUmVhY3QgZXZlbnRzIHVzZSB0aGUgY2FtZWxDYXNlIG5hbWluZyBjb252ZW50aW9uLCBmb3IgZXhhbXBsZSBgb25DbGlja2AuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBJDEudGVzdChuYW1lKSB8fCByQVJJQUNhbWVsJDEudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImlubmVyaHRtbCIpIHsKICAgICAgICAgICAgICBlcnJvcigiRGlyZWN0bHkgc2V0dGluZyBwcm9wZXJ0eSBgaW5uZXJIVE1MYCBpcyBub3QgcGVybWl0dGVkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgbG9va3VwIGRvY3VtZW50YXRpb24gb24gYGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImFyaWEiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBgYXJpYWAgYXR0cmlidXRlIGlzIHJlc2VydmVkIGZvciBmdXR1cmUgdXNlIGluIFJlYWN0LiBQYXNzIGluZGl2aWR1YWwgYGFyaWEtYCBhdHRyaWJ1dGVzIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobG93ZXJDYXNlZE5hbWUgPT09ICJpcyIgJiYgdmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHZvaWQgMCAmJiB0eXBlb2YgdmFsdWUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGEgYCVzYCBmb3IgYSBzdHJpbmcgYXR0cmlidXRlIGBpc2AuIElmIHRoaXMgaXMgZXhwZWN0ZWQsIGNhc3QgdGhlIHZhbHVlIHRvIGEgc3RyaW5nLiIsIHR5cGVvZiB2YWx1ZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiAmJiBpc05hTih2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgTmFOIGZvciB0aGUgYCVzYCBhdHRyaWJ1dGUuIElmIHRoaXMgaXMgZXhwZWN0ZWQsIGNhc3QgdGhlIHZhbHVlIHRvIGEgc3RyaW5nLiIsIG5hbWUpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb3BlcnR5SW5mbyA9IGdldFByb3BlcnR5SW5mbyhuYW1lKTsKICAgICAgICAgICAgdmFyIGlzUmVzZXJ2ZWQgPSBwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEOwogICAgICAgICAgICBpZiAocG9zc2libGVTdGFuZGFyZE5hbWVzLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSkgewogICAgICAgICAgICAgIHZhciBzdGFuZGFyZE5hbWUgPSBwb3NzaWJsZVN0YW5kYXJkTmFtZXNbbG93ZXJDYXNlZE5hbWVdOwogICAgICAgICAgICAgIGlmIChzdGFuZGFyZE5hbWUgIT09IG5hbWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIERPTSBwcm9wZXJ0eSBgJXNgLiBEaWQgeW91IG1lYW4gYCVzYD8iLCBuYW1lLCBzdGFuZGFyZE5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICghaXNSZXNlcnZlZCAmJiBuYW1lICE9PSBsb3dlckNhc2VkTmFtZSkgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBkb2VzIG5vdCByZWNvZ25pemUgdGhlIGAlc2AgcHJvcCBvbiBhIERPTSBlbGVtZW50LiBJZiB5b3UgaW50ZW50aW9uYWxseSB3YW50IGl0IHRvIGFwcGVhciBpbiB0aGUgRE9NIGFzIGEgY3VzdG9tIGF0dHJpYnV0ZSwgc3BlbGwgaXQgYXMgbG93ZXJjYXNlIGAlc2AgaW5zdGVhZC4gSWYgeW91IGFjY2lkZW50YWxseSBwYXNzZWQgaXQgZnJvbSBhIHBhcmVudCBjb21wb25lbnQsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gZWxlbWVudC4iLCBuYW1lLCBsb3dlckNhc2VkTmFtZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgJiYgc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBlcnJvcignUmVjZWl2ZWQgYCVzYCBmb3IgYSBub24tYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC5cblxuSWYgeW91IHdhbnQgdG8gd3JpdGUgaXQgdG8gdGhlIERPTSwgcGFzcyBhIHN0cmluZyBpbnN0ZWFkOiAlcz0iJXMiIG9yICVzPXt2YWx1ZS50b1N0cmluZygpfS4nLCB2YWx1ZSwgbmFtZSwgbmFtZSwgdmFsdWUsIG5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcignUmVjZWl2ZWQgYCVzYCBmb3IgYSBub24tYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC5cblxuSWYgeW91IHdhbnQgdG8gd3JpdGUgaXQgdG8gdGhlIERPTSwgcGFzcyBhIHN0cmluZyBpbnN0ZWFkOiAlcz0iJXMiIG9yICVzPXt2YWx1ZS50b1N0cmluZygpfS5cblxuSWYgeW91IHVzZWQgdG8gY29uZGl0aW9uYWxseSBvbWl0IGl0IHdpdGggJXM9e2NvbmRpdGlvbiAmJiB2YWx1ZX0sIHBhc3MgJXM9e2NvbmRpdGlvbiA/IHZhbHVlIDogdW5kZWZpbmVkfSBpbnN0ZWFkLicsIHZhbHVlLCBuYW1lLCBuYW1lLCB2YWx1ZSwgbmFtZSwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzUmVzZXJ2ZWQpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gImZhbHNlIiB8fCB2YWx1ZSA9PT0gInRydWUiKSAmJiBwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IEJPT0xFQU4pIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgdGhlIHN0cmluZyBgJXNgIGZvciB0aGUgYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC4gJXMgRGlkIHlvdSBtZWFuICVzPXslc30/IiwgdmFsdWUsIG5hbWUsIHZhbHVlID09PSAiZmFsc2UiID8gIlRoZSBicm93c2VyIHdpbGwgaW50ZXJwcmV0IGl0IGFzIGEgdHJ1dGh5IHZhbHVlLiIgOiAnQWx0aG91Z2ggdGhpcyB3b3JrcywgaXQgd2lsbCBub3Qgd29yayBhcyBleHBlY3RlZCBpZiB5b3UgcGFzcyB0aGUgc3RyaW5nICJmYWxzZSIuJywgbmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgd2FyblVua25vd25Qcm9wZXJ0aWVzID0gZnVuY3Rpb24odHlwZSwgcHJvcHMsIGV2ZW50UmVnaXN0cnkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9IHZhbGlkYXRlUHJvcGVydHkkMSh0eXBlLCBrZXksIHByb3BzW2tleV0sIGV2ZW50UmVnaXN0cnkpOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCkgewogICAgICAgICAgICAgICAgdW5rbm93blByb3BzLnB1c2goa2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wU3RyaW5nID0gdW5rbm93blByb3BzLm1hcChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJgIiArIHByb3AgKyAiYCI7CiAgICAgICAgICAgIH0pLmpvaW4oIiwgIik7CiAgICAgICAgICAgIGlmICh1bmtub3duUHJvcHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgdmFsdWUgZm9yIHByb3AgJXMgb24gPCVzPiB0YWcuIEVpdGhlciByZW1vdmUgaXQgZnJvbSB0aGUgZWxlbWVudCwgb3IgcGFzcyBhIHN0cmluZyBvciBudW1iZXIgdmFsdWUgdG8ga2VlcCBpdCBpbiB0aGUgRE9NLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9hdHRyaWJ1dGUtYmVoYXZpb3IgIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHVua25vd25Qcm9wcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgdmFsdWVzIGZvciBwcm9wcyAlcyBvbiA8JXM+IHRhZy4gRWl0aGVyIHJlbW92ZSB0aGVtIGZyb20gdGhlIGVsZW1lbnQsIG9yIHBhc3MgYSBzdHJpbmcgb3IgbnVtYmVyIHZhbHVlIHRvIGtlZXAgdGhlbSBpbiB0aGUgRE9NLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9hdHRyaWJ1dGUtYmVoYXZpb3IgIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnRpZXMkMih0eXBlLCBwcm9wcywgZXZlbnRSZWdpc3RyeSkgewogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuVW5rbm93blByb3BlcnRpZXModHlwZSwgcHJvcHMsIGV2ZW50UmVnaXN0cnkpOwogICAgICAgIH0KICAgICAgICB2YXIgSVNfRVZFTlRfSEFORExFX05PTl9NQU5BR0VEX05PREUgPSAxOwogICAgICAgIHZhciBJU19OT05fREVMRUdBVEVEID0gMSA8PCAxOwogICAgICAgIHZhciBJU19DQVBUVVJFX1BIQVNFID0gMSA8PCAyOwogICAgICAgIHZhciBTSE9VTERfTk9UX1BST0NFU1NfUE9MWUZJTExfRVZFTlRfUExVR0lOUyA9IElTX0VWRU5UX0hBTkRMRV9OT05fTUFOQUdFRF9OT0RFIHwgSVNfTk9OX0RFTEVHQVRFRCB8IElTX0NBUFRVUkVfUEhBU0U7CiAgICAgICAgdmFyIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gc2V0UmVwbGF5aW5nRXZlbnQoZXZlbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRSZXBsYXlpbmdFdmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBjdXJyZW50bHkgcmVwbGF5aW5nIGV2ZW50IHRvIGJlIG51bGwuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IGV2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFJlcGxheWluZ0V2ZW50KCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudFJlcGxheWluZ0V2ZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGN1cnJlbnRseSByZXBsYXlpbmcgZXZlbnQgdG8gbm90IGJlIG51bGwuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVwbGF5aW5nRXZlbnQoZXZlbnQpIHsKICAgICAgICAgIHJldHVybiBldmVudCA9PT0gY3VycmVudFJlcGxheWluZ0V2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIHRhcmdldCA9IG5hdGl2ZUV2ZW50LnRhcmdldCB8fCBuYXRpdmVFdmVudC5zcmNFbGVtZW50IHx8IHdpbmRvdzsKICAgICAgICAgIGlmICh0YXJnZXQuY29ycmVzcG9uZGluZ1VzZUVsZW1lbnQpIHsKICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LmNvcnJlc3BvbmRpbmdVc2VFbGVtZW50OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRhcmdldC5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFID8gdGFyZ2V0LnBhcmVudE5vZGUgOiB0YXJnZXQ7CiAgICAgICAgfQogICAgICAgIHZhciByZXN0b3JlSW1wbCA9IG51bGw7CiAgICAgICAgdmFyIHJlc3RvcmVUYXJnZXQgPSBudWxsOwogICAgICAgIHZhciByZXN0b3JlUXVldWUgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KHRhcmdldCkgewogICAgICAgICAgdmFyIGludGVybmFsSW5zdGFuY2UgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKHRhcmdldCk7CiAgICAgICAgICBpZiAoIWludGVybmFsSW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiByZXN0b3JlSW1wbCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbigpIG5lZWRzIHRvIGJlIGNhbGxlZCB0byBoYW5kbGUgYSB0YXJnZXQgZm9yIGNvbnRyb2xsZWQgZXZlbnRzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IGludGVybmFsSW5zdGFuY2Uuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKHN0YXRlTm9kZSkgewogICAgICAgICAgICB2YXIgX3Byb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShzdGF0ZU5vZGUpOwogICAgICAgICAgICByZXN0b3JlSW1wbChpbnRlcm5hbEluc3RhbmNlLnN0YXRlTm9kZSwgaW50ZXJuYWxJbnN0YW5jZS50eXBlLCBfcHJvcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRSZXN0b3JlSW1wbGVtZW50YXRpb24oaW1wbCkgewogICAgICAgICAgcmVzdG9yZUltcGwgPSBpbXBsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlU3RhdGVSZXN0b3JlKHRhcmdldCkgewogICAgICAgICAgaWYgKHJlc3RvcmVUYXJnZXQpIHsKICAgICAgICAgICAgaWYgKHJlc3RvcmVRdWV1ZSkgewogICAgICAgICAgICAgIHJlc3RvcmVRdWV1ZS5wdXNoKHRhcmdldCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzdG9yZVF1ZXVlID0gW3RhcmdldF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3RvcmVUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5lZWRzU3RhdGVSZXN0b3JlKCkgewogICAgICAgICAgcmV0dXJuIHJlc3RvcmVUYXJnZXQgIT09IG51bGwgfHwgcmVzdG9yZVF1ZXVlICE9PSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlU3RhdGVJZk5lZWRlZCgpIHsKICAgICAgICAgIGlmICghcmVzdG9yZVRhcmdldCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gcmVzdG9yZVRhcmdldDsKICAgICAgICAgIHZhciBxdWV1ZWRUYXJnZXRzID0gcmVzdG9yZVF1ZXVlOwogICAgICAgICAgcmVzdG9yZVRhcmdldCA9IG51bGw7CiAgICAgICAgICByZXN0b3JlUXVldWUgPSBudWxsOwogICAgICAgICAgcmVzdG9yZVN0YXRlT2ZUYXJnZXQodGFyZ2V0KTsKICAgICAgICAgIGlmIChxdWV1ZWRUYXJnZXRzKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWVkVGFyZ2V0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KHF1ZXVlZFRhcmdldHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBiYXRjaGVkVXBkYXRlc0ltcGwgPSBmdW5jdGlvbihmbiwgYm9va2tlZXBpbmcpIHsKICAgICAgICAgIHJldHVybiBmbihib29ra2VlcGluZyk7CiAgICAgICAgfTsKICAgICAgICB2YXIgZmx1c2hTeW5jSW1wbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgdmFyIGlzSW5zaWRlRXZlbnRIYW5kbGVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmluaXNoRXZlbnRIYW5kbGVyKCkgewogICAgICAgICAgdmFyIGNvbnRyb2xsZWRDb21wb25lbnRzSGF2ZVBlbmRpbmdVcGRhdGVzID0gbmVlZHNTdGF0ZVJlc3RvcmUoKTsKICAgICAgICAgIGlmIChjb250cm9sbGVkQ29tcG9uZW50c0hhdmVQZW5kaW5nVXBkYXRlcykgewogICAgICAgICAgICBmbHVzaFN5bmNJbXBsKCk7CiAgICAgICAgICAgIHJlc3RvcmVTdGF0ZUlmTmVlZGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhdGNoZWRVcGRhdGVzKGZuLCBhLCBiKSB7CiAgICAgICAgICBpZiAoaXNJbnNpZGVFdmVudEhhbmRsZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZuKGEsIGIpOwogICAgICAgICAgfQogICAgICAgICAgaXNJbnNpZGVFdmVudEhhbmRsZXIgPSB0cnVlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGJhdGNoZWRVcGRhdGVzSW1wbChmbiwgYSwgYik7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBpc0luc2lkZUV2ZW50SGFuZGxlciA9IGZhbHNlOwogICAgICAgICAgICBmaW5pc2hFdmVudEhhbmRsZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0QmF0Y2hpbmdJbXBsZW1lbnRhdGlvbihfYmF0Y2hlZFVwZGF0ZXNJbXBsLCBfZGlzY3JldGVVcGRhdGVzSW1wbCwgX2ZsdXNoU3luY0ltcGwpIHsKICAgICAgICAgIGJhdGNoZWRVcGRhdGVzSW1wbCA9IF9iYXRjaGVkVXBkYXRlc0ltcGw7CiAgICAgICAgICBmbHVzaFN5bmNJbXBsID0gX2ZsdXNoU3luY0ltcGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzSW50ZXJhY3RpdmUodGFnKSB7CiAgICAgICAgICByZXR1cm4gdGFnID09PSAiYnV0dG9uIiB8fCB0YWcgPT09ICJpbnB1dCIgfHwgdGFnID09PSAic2VsZWN0IiB8fCB0YWcgPT09ICJ0ZXh0YXJlYSI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFByZXZlbnRNb3VzZUV2ZW50KG5hbWUsIHR5cGUsIHByb3BzKSB7CiAgICAgICAgICBzd2l0Y2ggKG5hbWUpIHsKICAgICAgICAgICAgY2FzZSAib25DbGljayI6CiAgICAgICAgICAgIGNhc2UgIm9uQ2xpY2tDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Eb3VibGVDbGljayI6CiAgICAgICAgICAgIGNhc2UgIm9uRG91YmxlQ2xpY2tDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZURvd24iOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRG93bkNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlTW92ZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VNb3ZlQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VVcCI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VVcENhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRW50ZXIiOgogICAgICAgICAgICAgIHJldHVybiAhIShwcm9wcy5kaXNhYmxlZCAmJiBpc0ludGVyYWN0aXZlKHR5cGUpKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExpc3RlbmVyKGluc3QsIHJlZ2lzdHJhdGlvbk5hbWUpIHsKICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSBpbnN0LnN0YXRlTm9kZTsKICAgICAgICAgIGlmIChzdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKHN0YXRlTm9kZSk7CiAgICAgICAgICBpZiAocHJvcHMgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGlzdGVuZXIyID0gcHJvcHNbcmVnaXN0cmF0aW9uTmFtZV07CiAgICAgICAgICBpZiAoc2hvdWxkUHJldmVudE1vdXNlRXZlbnQocmVnaXN0cmF0aW9uTmFtZSwgaW5zdC50eXBlLCBwcm9wcykpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobGlzdGVuZXIyICYmIHR5cGVvZiBsaXN0ZW5lcjIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBgIiArIHJlZ2lzdHJhdGlvbk5hbWUgKyAiYCBsaXN0ZW5lciB0byBiZSBhIGZ1bmN0aW9uLCBpbnN0ZWFkIGdvdCBhIHZhbHVlIG9mIGAiICsgdHlwZW9mIGxpc3RlbmVyMiArICJgIHR5cGUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICB2YXIgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICBpZiAoY2FuVXNlRE9NMikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB7fTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9wdGlvbnMsICJwYXNzaXZlIiwgewogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZChuYW1lLCBmdW5jLCBjb250ZXh0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICB2YXIgZnVuY0FyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDMpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZnVuYy5hcHBseShjb250ZXh0LCBmdW5jQXJncyk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgdGhpcy5vbkVycm9yKGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpbnZva2VHdWFyZGVkQ2FsbGJhY2tJbXBsID0gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZDsKICAgICAgICB7CiAgICAgICAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kaXNwYXRjaEV2ZW50ID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIGRvY3VtZW50LmNyZWF0ZUV2ZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBmYWtlTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInJlYWN0Iik7CiAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwgPSBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tEZXYobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8IGRvY3VtZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBgZG9jdW1lbnRgIGdsb2JhbCB3YXMgZGVmaW5lZCB3aGVuIFJlYWN0IHdhcyBpbml0aWFsaXplZCwgYnV0IGlzIG5vdCBkZWZpbmVkIGFueW1vcmUuIFRoaXMgY2FuIGhhcHBlbiBpbiBhIHRlc3QgZW52aXJvbm1lbnQgaWYgYSBjb21wb25lbnQgc2NoZWR1bGVzIGFuIHVwZGF0ZSBmcm9tIGFuIGFzeW5jaHJvbm91cyBjYWxsYmFjaywgYnV0IHRoZSB0ZXN0IGhhcyBhbHJlYWR5IGZpbmlzaGVkIHJ1bm5pbmcuIFRvIHNvbHZlIHRoaXMsIHlvdSBjYW4gZWl0aGVyIHVubW91bnQgdGhlIGNvbXBvbmVudCBhdCB0aGUgZW5kIG9mIHlvdXIgdGVzdCAoYW5kIGVuc3VyZSB0aGF0IGFueSBhc3luY2hyb25vdXMgb3BlcmF0aW9ucyBnZXQgY2FuY2VsZWQgaW4gYGNvbXBvbmVudFdpbGxVbm1vdW50YCksIG9yIHlvdSBjYW4gY2hhbmdlIHRoZSB0ZXN0IGl0c2VsZiB0byBiZSBhc3luY2hyb25vdXMuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBldnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiRXZlbnQiKTsKICAgICAgICAgICAgICB2YXIgZGlkQ2FsbCA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciBkaWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIHdpbmRvd0V2ZW50ID0gd2luZG93LmV2ZW50OwogICAgICAgICAgICAgIHZhciB3aW5kb3dFdmVudERlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHdpbmRvdywgImV2ZW50Iik7CiAgICAgICAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUFmdGVyRGlzcGF0Y2goKSB7CiAgICAgICAgICAgICAgICBmYWtlTm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKGV2dFR5cGUsIGNhbGxDYWxsYmFjazIsIGZhbHNlKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygd2luZG93LmV2ZW50ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuaGFzT3duUHJvcGVydHkoImV2ZW50IikpIHsKICAgICAgICAgICAgICAgICAgd2luZG93LmV2ZW50ID0gd2luZG93RXZlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBmdW5jQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMyk7CiAgICAgICAgICAgICAgZnVuY3Rpb24gY2FsbENhbGxiYWNrMigpIHsKICAgICAgICAgICAgICAgIGRpZENhbGwgPSB0cnVlOwogICAgICAgICAgICAgICAgcmVzdG9yZUFmdGVyRGlzcGF0Y2goKTsKICAgICAgICAgICAgICAgIGZ1bmMuYXBwbHkoY29udGV4dCwgZnVuY0FyZ3MpOwogICAgICAgICAgICAgICAgZGlkRXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGVycm9yMjsKICAgICAgICAgICAgICB2YXIgZGlkU2V0RXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgaXNDcm9zc09yaWdpbkVycm9yID0gZmFsc2U7CiAgICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlV2luZG93RXJyb3IoZXZlbnQpIHsKICAgICAgICAgICAgICAgIGVycm9yMiA9IGV2ZW50LmVycm9yOwogICAgICAgICAgICAgICAgZGlkU2V0RXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKGVycm9yMiA9PT0gbnVsbCAmJiBldmVudC5jb2xubyA9PT0gMCAmJiBldmVudC5saW5lbm8gPT09IDApIHsKICAgICAgICAgICAgICAgICAgaXNDcm9zc09yaWdpbkVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChldmVudC5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChlcnJvcjIgIT0gbnVsbCAmJiB0eXBlb2YgZXJyb3IyID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcjIuX3N1cHByZXNzTG9nZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoaW5uZXIpIHsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGV2dFR5cGUgPSAicmVhY3QtIiArIChuYW1lID8gbmFtZSA6ICJpbnZva2VndWFyZGVkY2FsbGJhY2siKTsKICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBoYW5kbGVXaW5kb3dFcnJvcik7CiAgICAgICAgICAgICAgZmFrZU5vZGUuYWRkRXZlbnRMaXN0ZW5lcihldnRUeXBlLCBjYWxsQ2FsbGJhY2syLCBmYWxzZSk7CiAgICAgICAgICAgICAgZXZ0LmluaXRFdmVudChldnRUeXBlLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICAgIGZha2VOb2RlLmRpc3BhdGNoRXZlbnQoZXZ0KTsKICAgICAgICAgICAgICBpZiAod2luZG93RXZlbnREZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LCAiZXZlbnQiLCB3aW5kb3dFdmVudERlc2NyaXB0b3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGlkQ2FsbCAmJiBkaWRFcnJvcikgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTZXRFcnJvcikgewogICAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IoYEFuIGVycm9yIHdhcyB0aHJvd24gaW5zaWRlIG9uZSBvZiB5b3VyIGNvbXBvbmVudHMsIGJ1dCBSZWFjdCBkb2Vzbid0IGtub3cgd2hhdCBpdCB3YXMuIFRoaXMgaXMgbGlrZWx5IGR1ZSB0byBicm93c2VyIGZsYWtpbmVzcy4gUmVhY3QgZG9lcyBpdHMgYmVzdCB0byBwcmVzZXJ2ZSB0aGUgIlBhdXNlIG9uIGV4Y2VwdGlvbnMiIGJlaGF2aW9yIG9mIHRoZSBEZXZUb29scywgd2hpY2ggcmVxdWlyZXMgc29tZSBERVYtbW9kZSBvbmx5IHRyaWNrcy4gSXQncyBwb3NzaWJsZSB0aGF0IHRoZXNlIGRvbid0IHdvcmsgaW4geW91ciBicm93c2VyLiBUcnkgdHJpZ2dlcmluZyB0aGUgZXJyb3IgaW4gcHJvZHVjdGlvbiBtb2RlLCBvciBzd2l0Y2hpbmcgdG8gYSBtb2Rlcm4gYnJvd3Nlci4gSWYgeW91IHN1c3BlY3QgdGhhdCB0aGlzIGlzIGFjdHVhbGx5IGFuIGlzc3VlIHdpdGggUmVhY3QsIHBsZWFzZSBmaWxlIGFuIGlzc3VlLmApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0Nyb3NzT3JpZ2luRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKCJBIGNyb3NzLW9yaWdpbiBlcnJvciB3YXMgdGhyb3duLiBSZWFjdCBkb2Vzbid0IGhhdmUgYWNjZXNzIHRvIHRoZSBhY3R1YWwgZXJyb3Igb2JqZWN0IGluIGRldmVsb3BtZW50LiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Nyb3Nzb3JpZ2luLWVycm9yIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5vbkVycm9yKGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJlcnJvciIsIGhhbmRsZVdpbmRvd0Vycm9yKTsKICAgICAgICAgICAgICBpZiAoIWRpZENhbGwpIHsKICAgICAgICAgICAgICAgIHJlc3RvcmVBZnRlckRpc3BhdGNoKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwkMSA9IGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGw7CiAgICAgICAgdmFyIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgdmFyIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICB2YXIgaGFzUmV0aHJvd0Vycm9yID0gZmFsc2U7CiAgICAgICAgdmFyIHJldGhyb3dFcnJvciA9IG51bGw7CiAgICAgICAgdmFyIHJlcG9ydGVyID0gewogICAgICAgICAgb25FcnJvcjogZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICAgIGhhc0Vycm9yID0gdHJ1ZTsKICAgICAgICAgICAgY2F1Z2h0RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2sobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICAgIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwkMS5hcHBseShyZXBvcnRlciwgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgaWYgKGhhc0Vycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSBjbGVhckNhdWdodEVycm9yKCk7CiAgICAgICAgICAgIGlmICghaGFzUmV0aHJvd0Vycm9yKSB7CiAgICAgICAgICAgICAgaGFzUmV0aHJvd0Vycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICByZXRocm93RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0aHJvd0NhdWdodEVycm9yKCkgewogICAgICAgICAgaWYgKGhhc1JldGhyb3dFcnJvcikgewogICAgICAgICAgICB2YXIgZXJyb3IyID0gcmV0aHJvd0Vycm9yOwogICAgICAgICAgICBoYXNSZXRocm93RXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgcmV0aHJvd0Vycm9yID0gbnVsbDsKICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNDYXVnaHRFcnJvcigpIHsKICAgICAgICAgIHJldHVybiBoYXNFcnJvcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xlYXJDYXVnaHRFcnJvcigpIHsKICAgICAgICAgIGlmIChoYXNFcnJvcikgewogICAgICAgICAgICB2YXIgZXJyb3IyID0gY2F1Z2h0RXJyb3I7CiAgICAgICAgICAgIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgICAgIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIGVycm9yMjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2xlYXJDYXVnaHRFcnJvciB3YXMgY2FsbGVkIGJ1dCBubyBlcnJvciB3YXMgY2FwdHVyZWQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldDUoa2V5KSB7CiAgICAgICAgICByZXR1cm4ga2V5Ll9yZWFjdEludGVybmFsczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzMyhrZXkpIHsKICAgICAgICAgIHJldHVybiBrZXkuX3JlYWN0SW50ZXJuYWxzICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldDMoa2V5LCB2YWx1ZSkgewogICAgICAgICAga2V5Ll9yZWFjdEludGVybmFscyA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICB2YXIgTm9GbGFncyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgUGVyZm9ybWVkV29yayA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgUGxhY2VtZW50ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgVXBkYXRlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgQ2hpbGREZWxldGlvbiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNgogICAgICAgICk7CiAgICAgICAgdmFyIENvbnRlbnRSZXNldCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzIKICAgICAgICApOwogICAgICAgIHZhciBDYWxsYmFjayA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY0CiAgICAgICAgKTsKICAgICAgICB2YXIgRGlkQ2FwdHVyZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMjgKICAgICAgICApOwogICAgICAgIHZhciBGb3JjZUNsaWVudFJlbmRlciA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgKi8KICAgICAgICAgIDI1NgogICAgICAgICk7CiAgICAgICAgdmFyIFJlZjIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDUxMgogICAgICAgICk7CiAgICAgICAgdmFyIFNuYXBzaG90ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTAyNAogICAgICAgICk7CiAgICAgICAgdmFyIFBhc3NpdmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA0OAogICAgICAgICk7CiAgICAgICAgdmFyIEh5ZHJhdGluZyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDA5NgogICAgICAgICk7CiAgICAgICAgdmFyIFZpc2liaWxpdHkgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgODE5MgogICAgICAgICk7CiAgICAgICAgdmFyIFN0b3JlQ29uc2lzdGVuY3kgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgMTYzODQKICAgICAgICApOwogICAgICAgIHZhciBMaWZlY3ljbGVFZmZlY3RNYXNrID0gUGFzc2l2ZSB8IFVwZGF0ZSB8IENhbGxiYWNrIHwgUmVmMiB8IFNuYXBzaG90IHwgU3RvcmVDb25zaXN0ZW5jeTsKICAgICAgICB2YXIgSG9zdEVmZmVjdE1hc2sgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2NwogICAgICAgICk7CiAgICAgICAgdmFyIEluY29tcGxldGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzI3NjgKICAgICAgICApOwogICAgICAgIHZhciBTaG91bGRDYXB0dXJlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY1NTM2CiAgICAgICAgKTsKICAgICAgICB2YXIgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSA9ICgKICAgICAgICAgIC8qICovCiAgICAgICAgICAxMzEwNzIKICAgICAgICApOwogICAgICAgIHZhciBGb3JrZWQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwNDg1NzYKICAgICAgICApOwogICAgICAgIHZhciBSZWZTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwOTcxNTIKICAgICAgICApOwogICAgICAgIHZhciBMYXlvdXRTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQzMDQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlU3RhdGljID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgzODg2MDgKICAgICAgICApOwogICAgICAgIHZhciBNb3VudExheW91dERldiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2Nzc3MjE2CiAgICAgICAgKTsKICAgICAgICB2YXIgTW91bnRQYXNzaXZlRGV2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICovCiAgICAgICAgICAzMzU1NDQzMgogICAgICAgICk7CiAgICAgICAgdmFyIEJlZm9yZU11dGF0aW9uTWFzayA9ICgKICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSBVcGRhdGUgZmxhZyBmcm9tIGJlZm9yZSBtdXRhdGlvbiBwaGFzZSBieSByZS1sYW5kaW5nIFZpc2liaWxpdHkKICAgICAgICAgIC8vIGZsYWcgbG9naWMgKHNlZSAjMjAwNDMpCiAgICAgICAgICBVcGRhdGUgfCBTbmFwc2hvdCB8IDAKICAgICAgICApOwogICAgICAgIHZhciBNdXRhdGlvbk1hc2sgPSBQbGFjZW1lbnQgfCBVcGRhdGUgfCBDaGlsZERlbGV0aW9uIHwgQ29udGVudFJlc2V0IHwgUmVmMiB8IEh5ZHJhdGluZyB8IFZpc2liaWxpdHk7CiAgICAgICAgdmFyIExheW91dE1hc2sgPSBVcGRhdGUgfCBDYWxsYmFjayB8IFJlZjIgfCBWaXNpYmlsaXR5OwogICAgICAgIHZhciBQYXNzaXZlTWFzayA9IFBhc3NpdmUgfCBDaGlsZERlbGV0aW9uOwogICAgICAgIHZhciBTdGF0aWNNYXNrID0gTGF5b3V0U3RhdGljIHwgUGFzc2l2ZVN0YXRpYyB8IFJlZlN0YXRpYzsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICBmdW5jdGlvbiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgdmFyIG5lYXJlc3RNb3VudGVkID0gZmliZXI7CiAgICAgICAgICBpZiAoIWZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICB2YXIgbmV4dE5vZGUgPSBub2RlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgbm9kZSA9IG5leHROb2RlOwogICAgICAgICAgICAgIGlmICgobm9kZS5mbGFncyAmIChQbGFjZW1lbnQgfCBIeWRyYXRpbmcpKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgbmVhcmVzdE1vdW50ZWQgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbmV4dE5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfSB3aGlsZSAobmV4dE5vZGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2hpbGUgKG5vZGUucmV0dXJuKSB7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHJldHVybiBuZWFyZXN0TW91bnRlZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5zZUluc3RhbmNlRnJvbUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRhaW5lckZyb21GaWJlcihmaWJlcikgewogICAgICAgICAgcmV0dXJuIGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QgPyBmaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRmliZXJNb3VudGVkKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcihmaWJlcikgPT09IGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc01vdW50ZWQoY29tcG9uZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25lciA9IFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyRmliZXIgPSBvd25lcjsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBvd25lckZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoIWluc3RhbmNlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlcikgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGlzIGFjY2Vzc2luZyBpc01vdW50ZWQgaW5zaWRlIGl0cyByZW5kZXIoKSBmdW5jdGlvbi4gcmVuZGVyKCkgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIEl0IHNob3VsZCBuZXZlciBhY2Nlc3Mgc29tZXRoaW5nIHRoYXQgcmVxdWlyZXMgc3RhbGUgZGF0YSBmcm9tIHRoZSBwcmV2aW91cyByZW5kZXIsIHN1Y2ggYXMgcmVmcy4gTW92ZSB0aGlzIGxvZ2ljIHRvIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnREaWRVcGRhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKG93bmVyRmliZXIpIHx8ICJBIGNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpbnN0YW5jZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ1KGNvbXBvbmVudCk7CiAgICAgICAgICBpZiAoIWZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSA9PT0gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFzc2VydElzTW91bnRlZChmaWJlcikgewogICAgICAgICAgaWYgKGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpICE9PSBmaWJlcikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoIWFsdGVybmF0ZSkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkICE9PSBmaWJlcikgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhID0gZmliZXI7CiAgICAgICAgICB2YXIgYiA9IGFsdGVybmF0ZTsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRBID0gYS5yZXR1cm47CiAgICAgICAgICAgIGlmIChwYXJlbnRBID09PSBudWxsKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBhcmVudEIgPSBwYXJlbnRBLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKHBhcmVudEIgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV4dFBhcmVudCA9IHBhcmVudEEucmV0dXJuOwogICAgICAgICAgICAgIGlmIChuZXh0UGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhID0gYiA9IG5leHRQYXJlbnQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhcmVudEEuY2hpbGQgPT09IHBhcmVudEIuY2hpbGQpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnRBLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCkgewogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGEucmV0dXJuICE9PSBiLnJldHVybikgewogICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBkaWRGaW5kQ2hpbGQgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgX2NoaWxkID0gcGFyZW50QS5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBiID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBhID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfY2hpbGQgPSBfY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgIF9jaGlsZCA9IHBhcmVudEIuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGEpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDaGlsZCB3YXMgbm90IGZvdW5kIGluIGVpdGhlciBwYXJlbnQgc2V0LiBUaGlzIGluZGljYXRlcyBhIGJ1ZyBpbiBSZWFjdCByZWxhdGVkIHRvIHRoZSByZXR1cm4gcG9pbnRlci4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhLmFsdGVybmF0ZSAhPT0gYikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmV0dXJuIGZpYmVycyBzaG91bGQgYWx3YXlzIGJlIGVhY2ggb3RoZXJzJyBhbHRlcm5hdGVzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYS50YWcgIT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGEuc3RhdGVOb2RlLmN1cnJlbnQgPT09IGEpIHsKICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXIocGFyZW50KSB7CiAgICAgICAgICB2YXIgY3VycmVudFBhcmVudCA9IGZpbmRDdXJyZW50RmliZXJVc2luZ1Nsb3dQYXRoKHBhcmVudCk7CiAgICAgICAgICByZXR1cm4gY3VycmVudFBhcmVudCAhPT0gbnVsbCA/IGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChub2RlKSB7CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgbm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBmaW5kQ3VycmVudEhvc3RGaWJlckltcGwoY2hpbGQpOwogICAgICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFscyhwYXJlbnQpIHsKICAgICAgICAgIHZhciBjdXJyZW50UGFyZW50ID0gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgocGFyZW50KTsKICAgICAgICAgIHJldHVybiBjdXJyZW50UGFyZW50ICE9PSBudWxsID8gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzSW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwobm9kZSkgewogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyAhPT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgIHZhciBtYXRjaCA9IGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwoY2hpbGQpOwogICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIHNjaGVkdWxlQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICB2YXIgY2FuY2VsQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfY2FuY2VsQ2FsbGJhY2s7CiAgICAgICAgdmFyIHNob3VsZFlpZWxkID0gU2NoZWR1bGVyLnVuc3RhYmxlX3Nob3VsZFlpZWxkOwogICAgICAgIHZhciByZXF1ZXN0UGFpbnQgPSBTY2hlZHVsZXIudW5zdGFibGVfcmVxdWVzdFBhaW50OwogICAgICAgIHZhciBub3cgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgIHZhciBnZXRDdXJyZW50UHJpb3JpdHlMZXZlbCA9IFNjaGVkdWxlci51bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfSW1tZWRpYXRlUHJpb3JpdHk7CiAgICAgICAgdmFyIFVzZXJCbG9ja2luZ1ByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX1VzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgIHZhciBOb3JtYWxQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eTsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfTG93UHJpb3JpdHk7CiAgICAgICAgdmFyIElkbGVQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9JZGxlUHJpb3JpdHk7CiAgICAgICAgdmFyIHVuc3RhYmxlX3lpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfeWllbGRWYWx1ZTsKICAgICAgICB2YXIgdW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWU7CiAgICAgICAgdmFyIHJlbmRlcmVySUQgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZEhvb2sgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZFByb2ZpbGluZ0hvb2tzID0gbnVsbDsKICAgICAgICB2YXIgaGFzTG9nZ2VkRXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgaXNEZXZUb29sc1ByZXNlbnQgPSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIjsKICAgICAgICBmdW5jdGlvbiBpbmplY3RJbnRlcm5hbHMoaW50ZXJuYWxzKSB7CiAgICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhvb2sgPSBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX187CiAgICAgICAgICBpZiAoaG9vay5pc0Rpc2FibGVkKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFob29rLnN1cHBvcnRzRmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgaW5zdGFsbGVkIHZlcnNpb24gb2YgUmVhY3QgRGV2VG9vbHMgaXMgdG9vIG9sZCBhbmQgd2lsbCBub3Qgd29yayB3aXRoIHRoZSBjdXJyZW50IHZlcnNpb24gb2YgUmVhY3QuIFBsZWFzZSB1cGRhdGUgUmVhY3QgRGV2VG9vbHMuIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWFjdC1kZXZ0b29scyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlcikgewogICAgICAgICAgICAgIGludGVybmFscyA9IGFzc2lnbjIoe30sIGludGVybmFscywgewogICAgICAgICAgICAgICAgZ2V0TGFuZUxhYmVsTWFwLAogICAgICAgICAgICAgICAgaW5qZWN0UHJvZmlsaW5nSG9va3MKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZW5kZXJlcklEID0gaG9vay5pbmplY3QoaW50ZXJuYWxzKTsKICAgICAgICAgICAgaW5qZWN0ZWRIb29rID0gaG9vazsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMuIiwgZXJyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhvb2suY2hlY2tEQ0UpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uU2NoZWR1bGVSb290KHJvb3QzLCBjaGlsZHJlbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2sub25TY2hlZHVsZUZpYmVyUm9vdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25TY2hlZHVsZUZpYmVyUm9vdChyZW5kZXJlcklELCByb290MywgY2hpbGRyZW4pOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25Db21taXRSb290KHJvb3QzLCBldmVudFByaW9yaXR5KSB7CiAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclJvb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgZGlkRXJyb3IgPSAocm9vdDMuY3VycmVudC5mbGFncyAmIERpZENhcHR1cmUpID09PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxlclRpbWVyKSB7CiAgICAgICAgICAgICAgICB2YXIgc2NoZWR1bGVyUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGV2ZW50UHJpb3JpdHkpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBDb250aW51b3VzRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IFVzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgSWRsZUV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBOb3JtYWxQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyUm9vdChyZW5kZXJlcklELCByb290Mywgc2NoZWR1bGVyUHJpb3JpdHksIGRpZEVycm9yKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzLCB2b2lkIDAsIGRpZEVycm9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uUG9zdENvbW1pdFJvb3Qocm9vdDMpIHsKICAgICAgICAgIGlmIChpbmplY3RlZEhvb2sgJiYgdHlwZW9mIGluamVjdGVkSG9vay5vblBvc3RDb21taXRGaWJlclJvb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25Qb3N0Q29tbWl0RmliZXJSb290KHJlbmRlcmVySUQsIHJvb3QzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gb25Db21taXRVbm1vdW50KGZpYmVyKSB7CiAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclVubW91bnQocmVuZGVyZXJJRCwgZmliZXIpOwogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhuZXdJc1N0cmljdE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB1bnN0YWJsZV95aWVsZFZhbHVlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWUobmV3SXNTdHJpY3RNb2RlKTsKICAgICAgICAgICAgICBzZXRTdXBwcmVzc1dhcm5pbmcobmV3SXNTdHJpY3RNb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2suc2V0U3RyaWN0TW9kZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpbmplY3RlZEhvb2suc2V0U3RyaWN0TW9kZShyZW5kZXJlcklELCBuZXdJc1N0cmljdE1vZGUpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmplY3RQcm9maWxpbmdIb29rcyhwcm9maWxpbmdIb29rcykgewogICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcyA9IHByb2ZpbGluZ0hvb2tzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRMYW5lTGFiZWxNYXAoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBtYXAzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxOwogICAgICAgICAgICBmb3IgKHZhciBpbmRleDIgPSAwOyBpbmRleDIgPCBUb3RhbExhbmVzOyBpbmRleDIrKykgewogICAgICAgICAgICAgIHZhciBsYWJlbCA9IGdldExhYmVsRm9yTGFuZShsYW5lKTsKICAgICAgICAgICAgICBtYXAzLnNldChsYW5lLCBsYWJlbCk7CiAgICAgICAgICAgICAgbGFuZSAqPSAyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXAzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tbWl0U3RhcnRlZChsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21taXRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tbWl0U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50RXJyb3JlZChmaWJlciwgdGhyb3duVmFsdWUsIGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRFcnJvcmVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50RXJyb3JlZChmaWJlciwgdGhyb3duVmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50U3VzcGVuZGVkKGZpYmVyLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFN1c3BlbmRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFN1c3BlbmRlZChmaWJlciwgd2FrZWFibGUsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtMYXlvdXRFZmZlY3RzU3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVuZGVyU3RhcnRlZChsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJZaWVsZGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyWWllbGRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlcllpZWxkZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVuZGVyU3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlbmRlclNjaGVkdWxlZChsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTY2hlZHVsZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTY2hlZHVsZWQobGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtGb3JjZVVwZGF0ZVNjaGVkdWxlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBOb01vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIENvbmN1cnJlbnRNb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgUHJvZmlsZU1vZGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBTdHJpY3RMZWdhY3lNb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgOAogICAgICAgICk7CiAgICAgICAgdmFyIFN0cmljdEVmZmVjdHNNb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICovCiAgICAgICAgICAxNgogICAgICAgICk7CiAgICAgICAgdmFyIGNsejMyID0gTWF0aC5jbHozMiA/IE1hdGguY2x6MzIgOiBjbHozMkZhbGxiYWNrOwogICAgICAgIHZhciBsb2cyID0gTWF0aC5sb2c7CiAgICAgICAgdmFyIExOMiA9IE1hdGguTE4yOwogICAgICAgIGZ1bmN0aW9uIGNsejMyRmFsbGJhY2soeDIpIHsKICAgICAgICAgIHZhciBhc1VpbnQgPSB4MiA+Pj4gMDsKICAgICAgICAgIGlmIChhc1VpbnQgPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIDMyOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIDMxIC0gKGxvZzIoYXNVaW50KSAvIExOMiB8IDApIHwgMDsKICAgICAgICB9CiAgICAgICAgdmFyIFRvdGFsTGFuZXMgPSAzMTsKICAgICAgICB2YXIgTm9MYW5lcyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBOb0xhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBTeW5jTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBJbnB1dENvbnRpbnVvdXNMYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgKi8KICAgICAgICAgIDQKICAgICAgICApOwogICAgICAgIHZhciBEZWZhdWx0SHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgKi8KICAgICAgICAgIDgKICAgICAgICApOwogICAgICAgIHZhciBEZWZhdWx0TGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQyNDAKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA2NAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEyOAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI1NgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDUxMgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwMjQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTYgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyMDQ4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU3ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDA5NgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lOCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgxOTIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTkgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNjM4NAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTAgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMyNzY4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjU1MzYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMzEwNzIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNjIxNDQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTE0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MjQyODgKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTE1ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDQ4NTc2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxNiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA5NzE1MgogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTMwMDIzNDI0CiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lMSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDE5NDMwNAogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgzODg2MDgKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmUzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNjc3NzIxNgogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMzNTU0NDMyCiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lNSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjcxMDg4NjQKICAgICAgICApOwogICAgICAgIHZhciBTb21lUmV0cnlMYW5lID0gUmV0cnlMYW5lMTsKICAgICAgICB2YXIgU2VsZWN0aXZlSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICovCiAgICAgICAgICAxMzQyMTc3MjgKICAgICAgICApOwogICAgICAgIHZhciBOb25JZGxlTGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI2ODQzNTQ1NQogICAgICAgICk7CiAgICAgICAgdmFyIElkbGVIeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgMjY4NDM1NDU2CiAgICAgICAgKTsKICAgICAgICB2YXIgSWRsZUxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MzY4NzA5MTIKICAgICAgICApOwogICAgICAgIHZhciBPZmZzY3JlZW5MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwNzM3NDE4MjQKICAgICAgICApOwogICAgICAgIGZ1bmN0aW9uIGdldExhYmVsRm9yTGFuZShsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChsYW5lICYgU3luY0xhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlN5bmMiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSW5wdXRDb250aW51b3VzSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElucHV0Q29udGludW91c0xhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIklucHV0Q29udGludW91cyI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBEZWZhdWx0SHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiRGVmYXVsdEh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBEZWZhdWx0TGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiRGVmYXVsdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiVHJhbnNpdGlvbkh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBUcmFuc2l0aW9uTGFuZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gIlRyYW5zaXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgUmV0cnlMYW5lcykgewogICAgICAgICAgICAgIHJldHVybiAiUmV0cnkiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgU2VsZWN0aXZlSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiU2VsZWN0aXZlSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElkbGVIeWRyYXRpb25MYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJZGxlSHlkcmF0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElkbGVMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJZGxlIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIE9mZnNjcmVlbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIk9mZnNjcmVlbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIE5vVGltZXN0YW1wID0gLTE7CiAgICAgICAgdmFyIG5leHRUcmFuc2l0aW9uTGFuZSA9IFRyYW5zaXRpb25MYW5lMTsKICAgICAgICB2YXIgbmV4dFJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobGFuZXMpIHsKICAgICAgICAgIHN3aXRjaCAoZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcykpIHsKICAgICAgICAgICAgY2FzZSBTeW5jTGFuZToKICAgICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNMYW5lOgogICAgICAgICAgICAgIHJldHVybiBJbnB1dENvbnRpbnVvdXNMYW5lOwogICAgICAgICAgICBjYXNlIERlZmF1bHRIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0SHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdExhbmU7CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU2OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTg6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU5OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTA6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTY6CiAgICAgICAgICAgICAgcmV0dXJuIGxhbmVzICYgVHJhbnNpdGlvbkxhbmVzOwogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTE6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUzOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTQ6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNToKICAgICAgICAgICAgICByZXR1cm4gbGFuZXMgJiBSZXRyeUxhbmVzOwogICAgICAgICAgICBjYXNlIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgSWRsZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIElkbGVIeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICAgIHJldHVybiBJZGxlTGFuZTsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5MYW5lOgogICAgICAgICAgICAgIHJldHVybiBPZmZzY3JlZW5MYW5lOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVycm9yKCJTaG91bGQgaGF2ZSBmb3VuZCBtYXRjaGluZyBsYW5lcy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGxhbmVzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0TGFuZXMocm9vdDMsIHdpcExhbmVzKSB7CiAgICAgICAgICB2YXIgcGVuZGluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKHBlbmRpbmdMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHN1c3BlbmRlZExhbmVzID0gcm9vdDMuc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICB2YXIgcGluZ2VkTGFuZXMgPSByb290My5waW5nZWRMYW5lczsKICAgICAgICAgIHZhciBub25JZGxlUGVuZGluZ0xhbmVzID0gcGVuZGluZ0xhbmVzICYgTm9uSWRsZUxhbmVzOwogICAgICAgICAgaWYgKG5vbklkbGVQZW5kaW5nTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgdmFyIG5vbklkbGVVbmJsb2NrZWRMYW5lcyA9IG5vbklkbGVQZW5kaW5nTGFuZXMgJiB+c3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgIGlmIChub25JZGxlVW5ibG9ja2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBuZXh0TGFuZXMgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lcyhub25JZGxlVW5ibG9ja2VkTGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBub25JZGxlUGluZ2VkTGFuZXMgPSBub25JZGxlUGVuZGluZ0xhbmVzICYgcGluZ2VkTGFuZXM7CiAgICAgICAgICAgICAgaWYgKG5vbklkbGVQaW5nZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobm9uSWRsZVBpbmdlZExhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB1bmJsb2NrZWRMYW5lcyA9IHBlbmRpbmdMYW5lcyAmIH5zdXNwZW5kZWRMYW5lczsKICAgICAgICAgICAgaWYgKHVuYmxvY2tlZExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXModW5ibG9ja2VkTGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChwaW5nZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMocGluZ2VkTGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5leHRMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3aXBMYW5lcyAhPT0gTm9MYW5lcyAmJiB3aXBMYW5lcyAhPT0gbmV4dExhbmVzICYmIC8vIElmIHdlIGFscmVhZHkgc3VzcGVuZGVkIHdpdGggYSBkZWxheSwgdGhlbiBpbnRlcnJ1cHRpbmcgaXMgZmluZS4gRG9uJ3QKICAgICAgICAgIC8vIGJvdGhlciB3YWl0aW5nIHVudGlsIHRoZSByb290IGlzIGNvbXBsZXRlLgogICAgICAgICAgKHdpcExhbmVzICYgc3VzcGVuZGVkTGFuZXMpID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHZhciBuZXh0TGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobmV4dExhbmVzKTsKICAgICAgICAgICAgdmFyIHdpcExhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKHdpcExhbmVzKTsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIC8vIFRlc3RzIHdoZXRoZXIgdGhlIG5leHQgbGFuZSBpcyBlcXVhbCBvciBsb3dlciBwcmlvcml0eSB0aGFuIHRoZSB3aXAKICAgICAgICAgICAgICAvLyBvbmUuIFRoaXMgd29ya3MgYmVjYXVzZSB0aGUgYml0cyBkZWNyZWFzZSBpbiBwcmlvcml0eSBhcyB5b3UgZ28gbGVmdC4KICAgICAgICAgICAgICBuZXh0TGFuZSA+PSB3aXBMYW5lIHx8IC8vIERlZmF1bHQgcHJpb3JpdHkgdXBkYXRlcyBzaG91bGQgbm90IGludGVycnVwdCB0cmFuc2l0aW9uIHVwZGF0ZXMuIFRoZQogICAgICAgICAgICAgIC8vIG9ubHkgZGlmZmVyZW5jZSBiZXR3ZWVuIGRlZmF1bHQgdXBkYXRlcyBhbmQgdHJhbnNpdGlvbiB1cGRhdGVzIGlzIHRoYXQKICAgICAgICAgICAgICAvLyBkZWZhdWx0IHVwZGF0ZXMgZG8gbm90IHN1cHBvcnQgcmVmcmVzaCB0cmFuc2l0aW9ucy4KICAgICAgICAgICAgICBuZXh0TGFuZSA9PT0gRGVmYXVsdExhbmUgJiYgKHdpcExhbmUgJiBUcmFuc2l0aW9uTGFuZXMpICE9PSBOb0xhbmVzCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIHJldHVybiB3aXBMYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKChuZXh0TGFuZXMgJiBJbnB1dENvbnRpbnVvdXNMYW5lKSAhPT0gTm9MYW5lcykgewogICAgICAgICAgICBuZXh0TGFuZXMgfD0gcGVuZGluZ0xhbmVzICYgRGVmYXVsdExhbmU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZW50YW5nbGVkTGFuZXMgPSByb290My5lbnRhbmdsZWRMYW5lczsKICAgICAgICAgIGlmIChlbnRhbmdsZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgZW50YW5nbGVtZW50cyA9IHJvb3QzLmVudGFuZ2xlbWVudHM7CiAgICAgICAgICAgIHZhciBsYW5lcyA9IG5leHRMYW5lcyAmIGVudGFuZ2xlZExhbmVzOwogICAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgICAgbmV4dExhbmVzIHw9IGVudGFuZ2xlbWVudHNbaW5kZXgyXTsKICAgICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5leHRMYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TW9zdFJlY2VudEV2ZW50VGltZShyb290MywgbGFuZXMpIHsKICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBtb3N0UmVjZW50RXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IGV2ZW50VGltZXNbaW5kZXgyXTsKICAgICAgICAgICAgaWYgKGV2ZW50VGltZSA+IG1vc3RSZWNlbnRFdmVudFRpbWUpIHsKICAgICAgICAgICAgICBtb3N0UmVjZW50RXZlbnRUaW1lID0gZXZlbnRUaW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1vc3RSZWNlbnRFdmVudFRpbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXB1dGVFeHBpcmF0aW9uVGltZShsYW5lLCBjdXJyZW50VGltZSkgewogICAgICAgICAgc3dpdGNoIChsYW5lKSB7CiAgICAgICAgICAgIGNhc2UgU3luY0xhbmU6CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNMYW5lOgogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VGltZSArIDI1MDsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0SHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTc6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lOToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEwOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE2OgogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VGltZSArIDVlMzsKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgICBjYXNlIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgSWRsZUh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgSWRsZUxhbmU6CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuTGFuZToKICAgICAgICAgICAgICByZXR1cm4gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZXJyb3IoIlNob3VsZCBoYXZlIGZvdW5kIG1hdGNoaW5nIGxhbmVzLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gTm9UaW1lc3RhbXA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTdGFydmVkTGFuZXNBc0V4cGlyZWQocm9vdDMsIGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgcGVuZGluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgdmFyIHN1c3BlbmRlZExhbmVzID0gcm9vdDMuc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICB2YXIgcGluZ2VkTGFuZXMgPSByb290My5waW5nZWRMYW5lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBwZW5kaW5nTGFuZXM7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lID0gZXhwaXJhdGlvblRpbWVzW2luZGV4Ml07CiAgICAgICAgICAgIGlmIChleHBpcmF0aW9uVGltZSA9PT0gTm9UaW1lc3RhbXApIHsKICAgICAgICAgICAgICBpZiAoKGxhbmUgJiBzdXNwZW5kZWRMYW5lcykgPT09IE5vTGFuZXMgfHwgKGxhbmUgJiBwaW5nZWRMYW5lcykgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lc1tpbmRleDJdID0gY29tcHV0ZUV4cGlyYXRpb25UaW1lKGxhbmUsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhwaXJhdGlvblRpbWUgPD0gY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgICByb290My5leHBpcmVkTGFuZXMgfD0gbGFuZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5UGVuZGluZ0xhbmVzKHJvb3QzKSB7CiAgICAgICAgICByZXR1cm4gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMocm9vdDMucGVuZGluZ0xhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGFuZXNUb1JldHJ5U3luY2hyb25vdXNseU9uRXJyb3Iocm9vdDMpIHsKICAgICAgICAgIHZhciBldmVyeXRoaW5nQnV0T2Zmc2NyZWVuID0gcm9vdDMucGVuZGluZ0xhbmVzICYgfk9mZnNjcmVlbkxhbmU7CiAgICAgICAgICBpZiAoZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiAhPT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gZXZlcnl0aGluZ0J1dE9mZnNjcmVlbjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChldmVyeXRoaW5nQnV0T2Zmc2NyZWVuICYgT2Zmc2NyZWVuTGFuZSkgewogICAgICAgICAgICByZXR1cm4gT2Zmc2NyZWVuTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc1N5bmNMYW5lKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgU3luY0xhbmUpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc05vbklkbGVXb3JrKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgTm9uSWRsZUxhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNPbmx5UmV0cmllcyhsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFJldHJ5TGFuZXMpID09PSBsYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNPbmx5Tm9uVXJnZW50TGFuZXMobGFuZXMpIHsKICAgICAgICAgIHZhciBVcmdlbnRMYW5lcyA9IFN5bmNMYW5lIHwgSW5wdXRDb250aW51b3VzTGFuZSB8IERlZmF1bHRMYW5lOwogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFVyZ2VudExhbmVzKSA9PT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNPbmx5VHJhbnNpdGlvbnMobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBUcmFuc2l0aW9uTGFuZXMpID09PSBsYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgU3luY0RlZmF1bHRMYW5lcyA9IElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmUgfCBJbnB1dENvbnRpbnVvdXNMYW5lIHwgRGVmYXVsdEh5ZHJhdGlvbkxhbmUgfCBEZWZhdWx0TGFuZTsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBTeW5jRGVmYXVsdExhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNFeHBpcmVkTGFuZShyb290MywgbGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiByb290My5leHBpcmVkTGFuZXMpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1RyYW5zaXRpb25MYW5lKGxhbmUpIHsKICAgICAgICAgIHJldHVybiAobGFuZSAmIFRyYW5zaXRpb25MYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsYWltTmV4dFRyYW5zaXRpb25MYW5lKCkgewogICAgICAgICAgdmFyIGxhbmUgPSBuZXh0VHJhbnNpdGlvbkxhbmU7CiAgICAgICAgICBuZXh0VHJhbnNpdGlvbkxhbmUgPDw9IDE7CiAgICAgICAgICBpZiAoKG5leHRUcmFuc2l0aW9uTGFuZSAmIFRyYW5zaXRpb25MYW5lcykgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgbmV4dFRyYW5zaXRpb25MYW5lID0gVHJhbnNpdGlvbkxhbmUxOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsYWltTmV4dFJldHJ5TGFuZSgpIHsKICAgICAgICAgIHZhciBsYW5lID0gbmV4dFJldHJ5TGFuZTsKICAgICAgICAgIG5leHRSZXRyeUxhbmUgPDw9IDE7CiAgICAgICAgICBpZiAoKG5leHRSZXRyeUxhbmUgJiBSZXRyeUxhbmVzKSA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBuZXh0UmV0cnlMYW5lID0gUmV0cnlMYW5lMTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gbGFuZXMgJiAtbGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBpY2tBcmJpdHJhcnlMYW5lKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAzMSAtIGNsejMyKGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGFuZVRvSW5kZXgobGFuZSkgewogICAgICAgICAgcmV0dXJuIHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzU29tZUxhbmUoYSwgYikgewogICAgICAgICAgcmV0dXJuIChhICYgYikgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU3Vic2V0T2ZMYW5lcyhzZXQ0LCBzdWJzZXQpIHsKICAgICAgICAgIHJldHVybiAoc2V0NCAmIHN1YnNldCkgPT09IHN1YnNldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWVyZ2VMYW5lcyhhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSB8IGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUxhbmVzKHNldDQsIHN1YnNldCkgewogICAgICAgICAgcmV0dXJuIHNldDQgJiB+c3Vic2V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnRlcnNlY3RMYW5lcyhhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSAmIGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhbmVUb0xhbmVzKGxhbmUpIHsKICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWdoZXJQcmlvcml0eUxhbmUoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgIT09IE5vTGFuZSAmJiBhIDwgYiA/IGEgOiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVMYW5lTWFwKGluaXRpYWwpIHsKICAgICAgICAgIHZhciBsYW5lTWFwID0gW107CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IFRvdGFsTGFuZXM7IGkrKykgewogICAgICAgICAgICBsYW5lTWFwLnB1c2goaW5pdGlhbCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZU1hcDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCB1cGRhdGVMYW5lLCBldmVudFRpbWUpIHsKICAgICAgICAgIHJvb3QzLnBlbmRpbmdMYW5lcyB8PSB1cGRhdGVMYW5lOwogICAgICAgICAgaWYgKHVwZGF0ZUxhbmUgIT09IElkbGVMYW5lKSB7CiAgICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50VGltZXMgPSByb290My5ldmVudFRpbWVzOwogICAgICAgICAgdmFyIGluZGV4MiA9IGxhbmVUb0luZGV4KHVwZGF0ZUxhbmUpOwogICAgICAgICAgZXZlbnRUaW1lc1tpbmRleDJdID0gZXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUm9vdFN1c3BlbmRlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpIHsKICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzIHw9IHN1c3BlbmRlZExhbmVzOwogICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgJj0gfnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lcyA9IHJvb3QzLmV4cGlyYXRpb25UaW1lczsKICAgICAgICAgIHZhciBsYW5lcyA9IHN1c3BlbmRlZExhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lc1tpbmRleDJdID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUm9vdFBpbmdlZChyb290MywgcGluZ2VkTGFuZXMsIGV2ZW50VGltZSkgewogICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgfD0gcm9vdDMuc3VzcGVuZGVkTGFuZXMgJiBwaW5nZWRMYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RGaW5pc2hlZChyb290MywgcmVtYWluaW5nTGFuZXMpIHsKICAgICAgICAgIHZhciBub0xvbmdlclBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lcyAmIH5yZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLnBlbmRpbmdMYW5lcyA9IHJlbWFpbmluZ0xhbmVzOwogICAgICAgICAgcm9vdDMuc3VzcGVuZGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgcm9vdDMucGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgcm9vdDMuZXhwaXJlZExhbmVzICY9IHJlbWFpbmluZ0xhbmVzOwogICAgICAgICAgcm9vdDMubXV0YWJsZVJlYWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLmVudGFuZ2xlZExhbmVzICY9IHJlbWFpbmluZ0xhbmVzOwogICAgICAgICAgdmFyIGVudGFuZ2xlbWVudHMgPSByb290My5lbnRhbmdsZW1lbnRzOwogICAgICAgICAgdmFyIGV2ZW50VGltZXMgPSByb290My5ldmVudFRpbWVzOwogICAgICAgICAgdmFyIGV4cGlyYXRpb25UaW1lcyA9IHJvb3QzLmV4cGlyYXRpb25UaW1lczsKICAgICAgICAgIHZhciBsYW5lcyA9IG5vTG9uZ2VyUGVuZGluZ0xhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSA9IE5vTGFuZXM7CiAgICAgICAgICAgIGV2ZW50VGltZXNbaW5kZXgyXSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICBleHBpcmF0aW9uVGltZXNbaW5kZXgyXSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RFbnRhbmdsZWQocm9vdDMsIGVudGFuZ2xlZExhbmVzKSB7CiAgICAgICAgICB2YXIgcm9vdEVudGFuZ2xlZExhbmVzID0gcm9vdDMuZW50YW5nbGVkTGFuZXMgfD0gZW50YW5nbGVkTGFuZXM7CiAgICAgICAgICB2YXIgZW50YW5nbGVtZW50cyA9IHJvb3QzLmVudGFuZ2xlbWVudHM7CiAgICAgICAgICB2YXIgbGFuZXMgPSByb290RW50YW5nbGVkTGFuZXM7CiAgICAgICAgICB3aGlsZSAobGFuZXMpIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgLy8gSXMgdGhpcyBvbmUgb2YgdGhlIG5ld2x5IGVudGFuZ2xlZCBsYW5lcz8KICAgICAgICAgICAgICBsYW5lICYgZW50YW5nbGVkTGFuZXMgfCAvLyBJcyB0aGlzIGxhbmUgdHJhbnNpdGl2ZWx5IGVudGFuZ2xlZCB3aXRoIHRoZSBuZXdseSBlbnRhbmdsZWQgbGFuZXM/CiAgICAgICAgICAgICAgZW50YW5nbGVtZW50c1tpbmRleDJdICYgZW50YW5nbGVkTGFuZXMKICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgZW50YW5nbGVtZW50c1tpbmRleDJdIHw9IGVudGFuZ2xlZExhbmVzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRCdW1wZWRMYW5lRm9ySHlkcmF0aW9uKHJvb3QzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciByZW5kZXJMYW5lID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIGxhbmU7CiAgICAgICAgICBzd2l0Y2ggKHJlbmRlckxhbmUpIHsKICAgICAgICAgICAgY2FzZSBJbnB1dENvbnRpbnVvdXNMYW5lOgogICAgICAgICAgICAgIGxhbmUgPSBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIERlZmF1bHRMYW5lOgogICAgICAgICAgICAgIGxhbmUgPSBEZWZhdWx0SHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTc6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lOToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEwOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE2OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTE6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUzOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTQ6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNToKICAgICAgICAgICAgICBsYW5lID0gVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgSWRsZUxhbmU6CiAgICAgICAgICAgICAgbGFuZSA9IElkbGVIeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGxhbmUgPSBOb0xhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoKGxhbmUgJiAocm9vdDMuc3VzcGVuZGVkTGFuZXMgfCByZW5kZXJMYW5lczIpKSAhPT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHVybiBOb0xhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRmliZXJUb0xhbmVzTWFwKHJvb3QzLCBmaWJlciwgbGFuZXMpIHsKICAgICAgICAgIGlmICghaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBlbmRpbmdVcGRhdGVyc0xhbmVNYXAgPSByb290My5wZW5kaW5nVXBkYXRlcnNMYW5lTWFwOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gbGFuZVRvSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICB2YXIgdXBkYXRlcnMgPSBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwW2luZGV4Ml07CiAgICAgICAgICAgIHVwZGF0ZXJzLmFkZChmaWJlcik7CiAgICAgICAgICAgIGxhbmVzICY9IH5sYW5lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3ZlUGVuZGluZ0ZpYmVyc1RvTWVtb2l6ZWQocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICBpZiAoIWlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gcm9vdDMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcDsKICAgICAgICAgIHZhciBtZW1vaXplZFVwZGF0ZXJzID0gcm9vdDMubWVtb2l6ZWRVcGRhdGVyczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IGxhbmVUb0luZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIHVwZGF0ZXJzID0gcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcFtpbmRleDJdOwogICAgICAgICAgICBpZiAodXBkYXRlcnMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB1cGRhdGVycy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSA9PT0gbnVsbCB8fCAhbWVtb2l6ZWRVcGRhdGVycy5oYXMoYWx0ZXJuYXRlKSkgewogICAgICAgICAgICAgICAgICBtZW1vaXplZFVwZGF0ZXJzLmFkZChmaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcyhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBEaXNjcmV0ZUV2ZW50UHJpb3JpdHkgPSBTeW5jTGFuZTsKICAgICAgICB2YXIgQ29udGludW91c0V2ZW50UHJpb3JpdHkgPSBJbnB1dENvbnRpbnVvdXNMYW5lOwogICAgICAgIHZhciBEZWZhdWx0RXZlbnRQcmlvcml0eSA9IERlZmF1bHRMYW5lOwogICAgICAgIHZhciBJZGxlRXZlbnRQcmlvcml0eSA9IElkbGVMYW5lOwogICAgICAgIHZhciBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBOb0xhbmU7CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCkgewogICAgICAgICAgcmV0dXJuIGN1cnJlbnRVcGRhdGVQcmlvcml0eTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KG5ld1ByaW9yaXR5KSB7CiAgICAgICAgICBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBuZXdQcmlvcml0eTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcnVuV2l0aFByaW9yaXR5KHByaW9yaXR5LCBmbikgewogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBjdXJyZW50VXBkYXRlUHJpb3JpdHk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBwcmlvcml0eTsKICAgICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBjdXJyZW50VXBkYXRlUHJpb3JpdHkgPSBwcmV2aW91c1ByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWdoZXJFdmVudFByaW9yaXR5KGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhICE9PSAwICYmIGEgPCBiID8gYSA6IGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxvd2VyRXZlbnRQcmlvcml0eShhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSA9PT0gMCB8fCBhID4gYiA/IGEgOiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0hpZ2hlckV2ZW50UHJpb3JpdHkoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgIT09IDAgJiYgYSA8IGI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhbmVzVG9FdmVudFByaW9yaXR5KGxhbmVzKSB7CiAgICAgICAgICB2YXIgbGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpOwogICAgICAgICAgaWYgKCFpc0hpZ2hlckV2ZW50UHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5LCBsYW5lKSkgewogICAgICAgICAgICByZXR1cm4gRGlzY3JldGVFdmVudFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0hpZ2hlckV2ZW50UHJpb3JpdHkoQ29udGludW91c0V2ZW50UHJpb3JpdHksIGxhbmUpKSB7CiAgICAgICAgICAgIHJldHVybiBDb250aW51b3VzRXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbmNsdWRlc05vbklkbGVXb3JrKGxhbmUpKSB7CiAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBJZGxlRXZlbnRQcmlvcml0eTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSb290RGVoeWRyYXRlZChyb290MykgewogICAgICAgICAgdmFyIGN1cnJlbnRTdGF0ZSA9IHJvb3QzLmN1cnJlbnQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBjdXJyZW50U3RhdGUuaXNEZWh5ZHJhdGVkOwogICAgICAgIH0KICAgICAgICB2YXIgX2F0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oZm4pIHsKICAgICAgICAgIF9hdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24gPSBmbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICBfYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uOwogICAgICAgIGZ1bmN0aW9uIHNldEF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKGZuKSB7CiAgICAgICAgICBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbiA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5OwogICAgICAgIGZ1bmN0aW9uIHNldEF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eShmbikgewogICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5ID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkkMTsKICAgICAgICBmdW5jdGlvbiBzZXRHZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoZm4pIHsKICAgICAgICAgIGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSQxID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBhdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eTsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0SHlkcmF0aW9uQXRQcmlvcml0eShmbikgewogICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkgPSBmbjsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQgPSBmYWxzZTsKICAgICAgICB2YXIgcXVldWVkRGlzY3JldGVFdmVudHMgPSBbXTsKICAgICAgICB2YXIgcXVldWVkRm9jdXMgPSBudWxsOwogICAgICAgIHZhciBxdWV1ZWREcmFnID0gbnVsbDsKICAgICAgICB2YXIgcXVldWVkTW91c2UgPSBudWxsOwogICAgICAgIHZhciBxdWV1ZWRQb2ludGVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgdmFyIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgdmFyIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cyA9IFtdOwogICAgICAgIHZhciBkaXNjcmV0ZVJlcGxheWFibGVFdmVudHMgPSBbCiAgICAgICAgICAibW91c2Vkb3duIiwKICAgICAgICAgICJtb3VzZXVwIiwKICAgICAgICAgICJ0b3VjaGNhbmNlbCIsCiAgICAgICAgICAidG91Y2hlbmQiLAogICAgICAgICAgInRvdWNoc3RhcnQiLAogICAgICAgICAgImF1eGNsaWNrIiwKICAgICAgICAgICJkYmxjbGljayIsCiAgICAgICAgICAicG9pbnRlcmNhbmNlbCIsCiAgICAgICAgICAicG9pbnRlcmRvd24iLAogICAgICAgICAgInBvaW50ZXJ1cCIsCiAgICAgICAgICAiZHJhZ2VuZCIsCiAgICAgICAgICAiZHJhZ3N0YXJ0IiwKICAgICAgICAgICJkcm9wIiwKICAgICAgICAgICJjb21wb3NpdGlvbmVuZCIsCiAgICAgICAgICAiY29tcG9zaXRpb25zdGFydCIsCiAgICAgICAgICAia2V5ZG93biIsCiAgICAgICAgICAia2V5cHJlc3MiLAogICAgICAgICAgImtleXVwIiwKICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAidGV4dElucHV0IiwKICAgICAgICAgIC8vIEludGVudGlvbmFsbHkgY2FtZWxDYXNlCiAgICAgICAgICAiY29weSIsCiAgICAgICAgICAiY3V0IiwKICAgICAgICAgICJwYXN0ZSIsCiAgICAgICAgICAiY2xpY2siLAogICAgICAgICAgImNoYW5nZSIsCiAgICAgICAgICAiY29udGV4dG1lbnUiLAogICAgICAgICAgInJlc2V0IiwKICAgICAgICAgICJzdWJtaXQiCiAgICAgICAgXTsKICAgICAgICBmdW5jdGlvbiBpc0Rpc2NyZXRlRXZlbnRUaGF0UmVxdWlyZXNIeWRyYXRpb24oZXZlbnRUeXBlKSB7CiAgICAgICAgICByZXR1cm4gZGlzY3JldGVSZXBsYXlhYmxlRXZlbnRzLmluZGV4T2YoZXZlbnRUeXBlKSA+IC0xOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVRdWV1ZWRSZXBsYXlhYmxlRXZlbnQoYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGJsb2NrZWRPbiwKICAgICAgICAgICAgZG9tRXZlbnROYW1lLAogICAgICAgICAgICBldmVudFN5c3RlbUZsYWdzLAogICAgICAgICAgICBuYXRpdmVFdmVudCwKICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVyczogW3RhcmdldENvbnRhaW5lcl0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFySWZDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiZm9jdXNpbiI6CiAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgICBxdWV1ZWRGb2N1cyA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6CiAgICAgICAgICAgIGNhc2UgImRyYWdsZWF2ZSI6CiAgICAgICAgICAgICAgcXVldWVkRHJhZyA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3ZlciI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm91dCI6IHsKICAgICAgICAgICAgICB2YXIgcG9pbnRlcklkID0gbmF0aXZlRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJzLmRlbGV0ZShwb2ludGVySWQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAibG9zdHBvaW50ZXJjYXB0dXJlIjogewogICAgICAgICAgICAgIHZhciBfcG9pbnRlcklkID0gbmF0aXZlRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5kZWxldGUoX3BvaW50ZXJJZCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChleGlzdGluZ1F1ZXVlZEV2ZW50LCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKGV4aXN0aW5nUXVldWVkRXZlbnQgPT09IG51bGwgfHwgZXhpc3RpbmdRdWV1ZWRFdmVudC5uYXRpdmVFdmVudCAhPT0gbmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlZEV2ZW50ID0gY3JlYXRlUXVldWVkUmVwbGF5YWJsZUV2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgaWYgKGJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBfZmliZXIyID0gZ2V0SW5zdGFuY2VGcm9tTm9kZShibG9ja2VkT24pOwogICAgICAgICAgICAgIGlmIChfZmliZXIyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihfZmliZXIyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHF1ZXVlZEV2ZW50OwogICAgICAgICAgfQogICAgICAgICAgZXhpc3RpbmdRdWV1ZWRFdmVudC5ldmVudFN5c3RlbUZsYWdzIHw9IGV2ZW50U3lzdGVtRmxhZ3M7CiAgICAgICAgICB2YXIgdGFyZ2V0Q29udGFpbmVycyA9IGV4aXN0aW5nUXVldWVkRXZlbnQudGFyZ2V0Q29udGFpbmVyczsKICAgICAgICAgIGlmICh0YXJnZXRDb250YWluZXIgIT09IG51bGwgJiYgdGFyZ2V0Q29udGFpbmVycy5pbmRleE9mKHRhcmdldENvbnRhaW5lcikgPT09IC0xKSB7CiAgICAgICAgICAgIHRhcmdldENvbnRhaW5lcnMucHVzaCh0YXJnZXRDb250YWluZXIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4aXN0aW5nUXVldWVkRXZlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlSWZDb250aW51b3VzRXZlbnQoYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOiB7CiAgICAgICAgICAgICAgdmFyIGZvY3VzRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICBxdWV1ZWRGb2N1cyA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkRm9jdXMsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIGZvY3VzRXZlbnQpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6IHsKICAgICAgICAgICAgICB2YXIgZHJhZ0V2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgcXVldWVkRHJhZyA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkRHJhZywgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgZHJhZ0V2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOiB7CiAgICAgICAgICAgICAgdmFyIG1vdXNlRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkTW91c2UsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG1vdXNlRXZlbnQpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjogewogICAgICAgICAgICAgIHZhciBwb2ludGVyRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgICB2YXIgcG9pbnRlcklkID0gcG9pbnRlckV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVycy5zZXQocG9pbnRlcklkLCBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZFBvaW50ZXJzLmdldChwb2ludGVySWQpIHx8IG51bGwsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIHBvaW50ZXJFdmVudCkpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjogewogICAgICAgICAgICAgIHZhciBfcG9pbnRlckV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgdmFyIF9wb2ludGVySWQyID0gX3BvaW50ZXJFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICAgICAgcXVldWVkUG9pbnRlckNhcHR1cmVzLnNldChfcG9pbnRlcklkMiwgYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZ2V0KF9wb2ludGVySWQyKSB8fCBudWxsLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBfcG9pbnRlckV2ZW50KSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHF1ZXVlZFRhcmdldCkgewogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShxdWV1ZWRUYXJnZXQudGFyZ2V0KTsKICAgICAgICAgIGlmICh0YXJnZXRJbnN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIodGFyZ2V0SW5zdCk7CiAgICAgICAgICAgIGlmIChuZWFyZXN0TW91bnRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciB0YWcgPSBuZWFyZXN0TW91bnRlZC50YWc7CiAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFN1c3BlbnNlSW5zdGFuY2VGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkocXVldWVkVGFyZ2V0LnByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gbmVhcmVzdE1vdW50ZWQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBnZXRDb250YWluZXJGcm9tRmliZXIobmVhcmVzdE1vdW50ZWQpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcXVldWVFeHBsaWNpdEh5ZHJhdGlvblRhcmdldCh0YXJnZXQpIHsKICAgICAgICAgIHZhciB1cGRhdGVQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSQxKCk7CiAgICAgICAgICB2YXIgcXVldWVkVGFyZ2V0ID0gewogICAgICAgICAgICBibG9ja2VkT246IG51bGwsCiAgICAgICAgICAgIHRhcmdldCwKICAgICAgICAgICAgcHJpb3JpdHk6IHVwZGF0ZVByaW9yaXR5CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgZm9yICg7IGkgPCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKCFpc0hpZ2hlckV2ZW50UHJpb3JpdHkodXBkYXRlUHJpb3JpdHksIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0c1tpXS5wcmlvcml0eSkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLnNwbGljZShpLCAwLCBxdWV1ZWRUYXJnZXQpOwogICAgICAgICAgaWYgKGkgPT09IDApIHsKICAgICAgICAgICAgYXR0ZW1wdEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHF1ZXVlZFRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkRXZlbnQpIHsKICAgICAgICAgIGlmIChxdWV1ZWRFdmVudC5ibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lcnMgPSBxdWV1ZWRFdmVudC50YXJnZXRDb250YWluZXJzOwogICAgICAgICAgd2hpbGUgKHRhcmdldENvbnRhaW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgdGFyZ2V0Q29udGFpbmVyID0gdGFyZ2V0Q29udGFpbmVyc1swXTsKICAgICAgICAgICAgdmFyIG5leHRCbG9ja2VkT24gPSBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KHF1ZXVlZEV2ZW50LmRvbUV2ZW50TmFtZSwgcXVldWVkRXZlbnQuZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBxdWV1ZWRFdmVudC5uYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGlmIChuZXh0QmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50ID0gcXVldWVkRXZlbnQubmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgICB2YXIgbmF0aXZlRXZlbnRDbG9uZSA9IG5ldyBuYXRpdmVFdmVudC5jb25zdHJ1Y3RvcihuYXRpdmVFdmVudC50eXBlLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgICBzZXRSZXBsYXlpbmdFdmVudChuYXRpdmVFdmVudENsb25lKTsKICAgICAgICAgICAgICAgIG5hdGl2ZUV2ZW50LnRhcmdldC5kaXNwYXRjaEV2ZW50KG5hdGl2ZUV2ZW50Q2xvbmUpOwogICAgICAgICAgICAgICAgcmVzZXRSZXBsYXlpbmdFdmVudCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyMyA9IGdldEluc3RhbmNlRnJvbU5vZGUobmV4dEJsb2NrZWRPbik7CiAgICAgICAgICAgICAgaWYgKF9maWJlcjMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKF9maWJlcjMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBxdWV1ZWRFdmVudC5ibG9ja2VkT24gPSBuZXh0QmxvY2tlZE9uOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0YXJnZXRDb250YWluZXJzLnNoaWZ0KCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudEluTWFwKHF1ZXVlZEV2ZW50LCBrZXksIG1hcDMpIHsKICAgICAgICAgIGlmIChhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEV2ZW50KSkgewogICAgICAgICAgICBtYXAzLmRlbGV0ZShrZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXBsYXlVbmJsb2NrZWRFdmVudHMoKSB7CiAgICAgICAgICBoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0ID0gZmFsc2U7CiAgICAgICAgICBpZiAocXVldWVkRm9jdXMgIT09IG51bGwgJiYgYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWRGb2N1cykpIHsKICAgICAgICAgICAgcXVldWVkRm9jdXMgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZERyYWcgIT09IG51bGwgJiYgYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWREcmFnKSkgewogICAgICAgICAgICBxdWV1ZWREcmFnID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWRNb3VzZSAhPT0gbnVsbCAmJiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZE1vdXNlKSkgewogICAgICAgICAgICBxdWV1ZWRNb3VzZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZWRQb2ludGVycy5mb3JFYWNoKGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnRJbk1hcCk7CiAgICAgICAgICBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZm9yRWFjaChhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50SW5NYXApOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRXZlbnQsIHVuYmxvY2tlZCkgewogICAgICAgICAgaWYgKHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9PT0gdW5ibG9ja2VkKSB7CiAgICAgICAgICAgIHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgICAgIGlmICghaGFzU2NoZWR1bGVkUmVwbGF5QXR0ZW1wdCkgewogICAgICAgICAgICAgIGhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQgPSB0cnVlOwogICAgICAgICAgICAgIFNjaGVkdWxlci51bnN0YWJsZV9zY2hlZHVsZUNhbGxiYWNrKFNjaGVkdWxlci51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eSwgcmVwbGF5VW5ibG9ja2VkRXZlbnRzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeUlmQmxvY2tlZE9uKHVuYmxvY2tlZCkgewogICAgICAgICAgaWYgKHF1ZXVlZERpc2NyZXRlRXZlbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZERpc2NyZXRlRXZlbnRzWzBdLCB1bmJsb2NrZWQpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHF1ZXVlZERpc2NyZXRlRXZlbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlZEV2ZW50ID0gcXVldWVkRGlzY3JldGVFdmVudHNbaV07CiAgICAgICAgICAgICAgaWYgKHF1ZXVlZEV2ZW50LmJsb2NrZWRPbiA9PT0gdW5ibG9ja2VkKSB7CiAgICAgICAgICAgICAgICBxdWV1ZWRFdmVudC5ibG9ja2VkT24gPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZEZvY3VzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRGb2N1cywgdW5ibG9ja2VkKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWREcmFnICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWREcmFnLCB1bmJsb2NrZWQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlZE1vdXNlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWRNb3VzZSwgdW5ibG9ja2VkKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1bmJsb2NrID0gZnVuY3Rpb24ocXVldWVkRXZlbnQyKSB7CiAgICAgICAgICAgIHJldHVybiBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRXZlbnQyLCB1bmJsb2NrZWQpOwogICAgICAgICAgfTsKICAgICAgICAgIHF1ZXVlZFBvaW50ZXJzLmZvckVhY2godW5ibG9jayk7CiAgICAgICAgICBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZm9yRWFjaCh1bmJsb2NrKTsKICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgIHZhciBxdWV1ZWRUYXJnZXQgPSBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHNbX2ldOwogICAgICAgICAgICBpZiAocXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9PT0gdW5ibG9ja2VkKSB7CiAgICAgICAgICAgICAgcXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgbmV4dEV4cGxpY2l0VGFyZ2V0ID0gcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzWzBdOwogICAgICAgICAgICBpZiAobmV4dEV4cGxpY2l0VGFyZ2V0LmJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGF0dGVtcHRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldChuZXh0RXhwbGljaXRUYXJnZXQpOwogICAgICAgICAgICAgIGlmIChuZXh0RXhwbGljaXRUYXJnZXQuYmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMuc2hpZnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QmF0Y2hDb25maWc7CiAgICAgICAgdmFyIF9lbmFibGVkID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBzZXRFbmFibGVkKGVuYWJsZWQpIHsKICAgICAgICAgIF9lbmFibGVkID0gISFlbmFibGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0VuYWJsZWQoKSB7CiAgICAgICAgICByZXR1cm4gX2VuYWJsZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUV2ZW50TGlzdGVuZXJXcmFwcGVyV2l0aFByaW9yaXR5KHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzKSB7CiAgICAgICAgICB2YXIgZXZlbnRQcmlvcml0eSA9IGdldEV2ZW50UHJpb3JpdHkoZG9tRXZlbnROYW1lKTsKICAgICAgICAgIHZhciBsaXN0ZW5lcldyYXBwZXI7CiAgICAgICAgICBzd2l0Y2ggKGV2ZW50UHJpb3JpdHkpIHsKICAgICAgICAgICAgY2FzZSBEaXNjcmV0ZUV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgbGlzdGVuZXJXcmFwcGVyID0gZGlzcGF0Y2hEaXNjcmV0ZUV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgIGxpc3RlbmVyV3JhcHBlciA9IGRpc3BhdGNoQ29udGludW91c0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGxpc3RlbmVyV3JhcHBlciA9IGRpc3BhdGNoRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXJXcmFwcGVyLmJpbmQobnVsbCwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaERpc2NyZXRlRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBjb250YWluZXIyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBkaXNwYXRjaEV2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyMiwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyMiwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoQ29udGludW91c0V2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBkaXNwYXRjaEV2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyMiwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBpZiAoIV9lbmFibGVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgZGlzcGF0Y2hFdmVudFdpdGhFbmFibGVDYXB0dXJlUGhhc2VTZWxlY3RpdmVIeWRyYXRpb25XaXRob3V0RGlzY3JldGVFdmVudFJlcGxheShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50V2l0aEVuYWJsZUNhcHR1cmVQaGFzZVNlbGVjdGl2ZUh5ZHJhdGlvbldpdGhvdXREaXNjcmV0ZUV2ZW50UmVwbGF5KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGJsb2NrZWRPbiA9IGZpbmRJbnN0YW5jZUJsb2NraW5nRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIGlmIChibG9ja2VkT24gPT09IG51bGwpIHsKICAgICAgICAgICAgZGlzcGF0Y2hFdmVudEZvclBsdWdpbkV2ZW50U3lzdGVtKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIHJldHVybl90YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpOwogICAgICAgICAgICBjbGVhcklmQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVJZkNvbnRpbnVvdXNFdmVudChibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgbmF0aXZlRXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGNsZWFySWZDb250aW51b3VzRXZlbnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICBpZiAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0NBUFRVUkVfUEhBU0UgJiYgaXNEaXNjcmV0ZUV2ZW50VGhhdFJlcXVpcmVzSHlkcmF0aW9uKGRvbUV2ZW50TmFtZSkpIHsKICAgICAgICAgICAgd2hpbGUgKGJsb2NrZWRPbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBmaWJlciA9IGdldEluc3RhbmNlRnJvbU5vZGUoYmxvY2tlZE9uKTsKICAgICAgICAgICAgICBpZiAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBuZXh0QmxvY2tlZE9uID0gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgIGlmIChuZXh0QmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgcmV0dXJuX3RhcmdldEluc3QsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChuZXh0QmxvY2tlZE9uID09PSBibG9ja2VkT24pIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBibG9ja2VkT24gPSBuZXh0QmxvY2tlZE9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICBuYXRpdmVFdmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgbnVsbCwgdGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIHJldHVybl90YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuX3RhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50VGFyZ2V0ID0gZ2V0RXZlbnRUYXJnZXQobmF0aXZlRXZlbnQpOwogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKHRhcmdldEluc3QpOwogICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgdGFnID0gbmVhcmVzdE1vdW50ZWQudGFnOwogICAgICAgICAgICAgIGlmICh0YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRTdXNwZW5zZUluc3RhbmNlRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIHZhciByb290MyA9IG5lYXJlc3RNb3VudGVkLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChpc1Jvb3REZWh5ZHJhdGVkKHJvb3QzKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGFpbmVyRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobmVhcmVzdE1vdW50ZWQgIT09IHRhcmdldEluc3QpIHsKICAgICAgICAgICAgICAgIHRhcmdldEluc3QgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuX3RhcmdldEluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50UHJpb3JpdHkoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJjbGljayI6CiAgICAgICAgICAgIGNhc2UgImNsb3NlIjoKICAgICAgICAgICAgY2FzZSAiY29udGV4dG1lbnUiOgogICAgICAgICAgICBjYXNlICJjb3B5IjoKICAgICAgICAgICAgY2FzZSAiY3V0IjoKICAgICAgICAgICAgY2FzZSAiYXV4Y2xpY2siOgogICAgICAgICAgICBjYXNlICJkYmxjbGljayI6CiAgICAgICAgICAgIGNhc2UgImRyYWdlbmQiOgogICAgICAgICAgICBjYXNlICJkcmFnc3RhcnQiOgogICAgICAgICAgICBjYXNlICJkcm9wIjoKICAgICAgICAgICAgY2FzZSAiZm9jdXNpbiI6CiAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICBjYXNlICJpbnZhbGlkIjoKICAgICAgICAgICAgY2FzZSAia2V5ZG93biI6CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgY2FzZSAia2V5dXAiOgogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICBjYXNlICJtb3VzZXVwIjoKICAgICAgICAgICAgY2FzZSAicGFzdGUiOgogICAgICAgICAgICBjYXNlICJwYXVzZSI6CiAgICAgICAgICAgIGNhc2UgInBsYXkiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmRvd24iOgogICAgICAgICAgICBjYXNlICJwb2ludGVydXAiOgogICAgICAgICAgICBjYXNlICJyYXRlY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAicmVzZXQiOgogICAgICAgICAgICBjYXNlICJyZXNpemUiOgogICAgICAgICAgICBjYXNlICJzZWVrZWQiOgogICAgICAgICAgICBjYXNlICJzdWJtaXQiOgogICAgICAgICAgICBjYXNlICJ0b3VjaGNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoZW5kIjoKICAgICAgICAgICAgY2FzZSAidG91Y2hzdGFydCI6CiAgICAgICAgICAgIGNhc2UgInZvbHVtZWNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgImNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdGlvbmNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgInRleHRJbnB1dCI6CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uc3RhcnQiOgogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9udXBkYXRlIjoKICAgICAgICAgICAgY2FzZSAiYmVmb3JlYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImFmdGVyYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImJlZm9yZWlucHV0IjoKICAgICAgICAgICAgY2FzZSAiYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImZ1bGxzY3JlZW5jaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJmb2N1cyI6CiAgICAgICAgICAgIGNhc2UgImhhc2hjaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJwb3BzdGF0ZSI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdHN0YXJ0IjoKICAgICAgICAgICAgICByZXR1cm4gRGlzY3JldGVFdmVudFByaW9yaXR5OwogICAgICAgICAgICBjYXNlICJkcmFnIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VudGVyIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2V4aXQiOgogICAgICAgICAgICBjYXNlICJkcmFnbGVhdmUiOgogICAgICAgICAgICBjYXNlICJkcmFnb3ZlciI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlbW92ZSI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm1vdmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3V0IjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm92ZXIiOgogICAgICAgICAgICBjYXNlICJzY3JvbGwiOgogICAgICAgICAgICBjYXNlICJ0b2dnbGUiOgogICAgICAgICAgICBjYXNlICJ0b3VjaG1vdmUiOgogICAgICAgICAgICBjYXNlICJ3aGVlbCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZW50ZXIiOgogICAgICAgICAgICBjYXNlICJtb3VzZWxlYXZlIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmVudGVyIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmxlYXZlIjoKICAgICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgIGNhc2UgIm1lc3NhZ2UiOiB7CiAgICAgICAgICAgICAgdmFyIHNjaGVkdWxlclByaW9yaXR5ID0gZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWwoKTsKICAgICAgICAgICAgICBzd2l0Y2ggKHNjaGVkdWxlclByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICBjYXNlIEltbWVkaWF0ZVByaW9yaXR5OgogICAgICAgICAgICAgICAgICByZXR1cm4gRGlzY3JldGVFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgY2FzZSBVc2VyQmxvY2tpbmdQcmlvcml0eToKICAgICAgICAgICAgICAgICAgcmV0dXJuIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgY2FzZSBOb3JtYWxQcmlvcml0eToKICAgICAgICAgICAgICAgIGNhc2UgTG93UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICAgIGNhc2UgSWRsZVByaW9yaXR5OgogICAgICAgICAgICAgICAgICByZXR1cm4gSWRsZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRFdmVudEJ1YmJsZUxpc3RlbmVyKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lcjIpIHsKICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIyLCBmYWxzZSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcih0YXJnZXQsIGV2ZW50VHlwZSwgbGlzdGVuZXIyKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyMiwgdHJ1ZSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXQsIGV2ZW50VHlwZSwgbGlzdGVuZXIyLCBwYXNzaXZlKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyMiwgewogICAgICAgICAgICBjYXB0dXJlOiB0cnVlLAogICAgICAgICAgICBwYXNzaXZlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEV2ZW50QnViYmxlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyMiwgcGFzc2l2ZSkgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lcjIsIHsKICAgICAgICAgICAgcGFzc2l2ZQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICB2YXIgcm9vdDIgPSBudWxsOwogICAgICAgIHZhciBzdGFydFRleHQgPSBudWxsOwogICAgICAgIHZhciBmYWxsYmFja1RleHQgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIGluaXRpYWxpemUobmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgIHJvb3QyID0gbmF0aXZlRXZlbnRUYXJnZXQ7CiAgICAgICAgICBzdGFydFRleHQgPSBnZXRUZXh0KCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXQoKSB7CiAgICAgICAgICByb290MiA9IG51bGw7CiAgICAgICAgICBzdGFydFRleHQgPSBudWxsOwogICAgICAgICAgZmFsbGJhY2tUZXh0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RGF0YSgpIHsKICAgICAgICAgIGlmIChmYWxsYmFja1RleHQpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrVGV4dDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGFydDsKICAgICAgICAgIHZhciBzdGFydFZhbHVlID0gc3RhcnRUZXh0OwogICAgICAgICAgdmFyIHN0YXJ0TGVuZ3RoID0gc3RhcnRWYWx1ZS5sZW5ndGg7CiAgICAgICAgICB2YXIgZW5kOwogICAgICAgICAgdmFyIGVuZFZhbHVlID0gZ2V0VGV4dCgpOwogICAgICAgICAgdmFyIGVuZExlbmd0aCA9IGVuZFZhbHVlLmxlbmd0aDsKICAgICAgICAgIGZvciAoc3RhcnQgPSAwOyBzdGFydCA8IHN0YXJ0TGVuZ3RoOyBzdGFydCsrKSB7CiAgICAgICAgICAgIGlmIChzdGFydFZhbHVlW3N0YXJ0XSAhPT0gZW5kVmFsdWVbc3RhcnRdKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBtaW5FbmQgPSBzdGFydExlbmd0aCAtIHN0YXJ0OwogICAgICAgICAgZm9yIChlbmQgPSAxOyBlbmQgPD0gbWluRW5kOyBlbmQrKykgewogICAgICAgICAgICBpZiAoc3RhcnRWYWx1ZVtzdGFydExlbmd0aCAtIGVuZF0gIT09IGVuZFZhbHVlW2VuZExlbmd0aCAtIGVuZF0pIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHNsaWNlVGFpbCA9IGVuZCA+IDEgPyAxIC0gZW5kIDogdm9pZCAwOwogICAgICAgICAgZmFsbGJhY2tUZXh0ID0gZW5kVmFsdWUuc2xpY2Uoc3RhcnQsIHNsaWNlVGFpbCk7CiAgICAgICAgICByZXR1cm4gZmFsbGJhY2tUZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUZXh0KCkgewogICAgICAgICAgaWYgKCJ2YWx1ZSIgaW4gcm9vdDIpIHsKICAgICAgICAgICAgcmV0dXJuIHJvb3QyLnZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJvb3QyLnRleHRDb250ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgY2hhckNvZGU7CiAgICAgICAgICB2YXIga2V5Q29kZSA9IG5hdGl2ZUV2ZW50LmtleUNvZGU7CiAgICAgICAgICBpZiAoImNoYXJDb2RlIiBpbiBuYXRpdmVFdmVudCkgewogICAgICAgICAgICBjaGFyQ29kZSA9IG5hdGl2ZUV2ZW50LmNoYXJDb2RlOwogICAgICAgICAgICBpZiAoY2hhckNvZGUgPT09IDAgJiYga2V5Q29kZSA9PT0gMTMpIHsKICAgICAgICAgICAgICBjaGFyQ29kZSA9IDEzOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjaGFyQ29kZSA9IGtleUNvZGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2hhckNvZGUgPT09IDEwKSB7CiAgICAgICAgICAgIGNoYXJDb2RlID0gMTM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY2hhckNvZGUgPj0gMzIgfHwgY2hhckNvZGUgPT09IDEzKSB7CiAgICAgICAgICAgIHJldHVybiBjaGFyQ29kZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZSgpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmdW5jdGlvblRoYXRSZXR1cm5zRmFsc2UoKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEludGVyZmFjZSkgewogICAgICAgICAgZnVuY3Rpb24gU3ludGhldGljQmFzZUV2ZW50KHJlYWN0TmFtZSwgcmVhY3RFdmVudFR5cGUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgICB0aGlzLl9yZWFjdE5hbWUgPSByZWFjdE5hbWU7CiAgICAgICAgICAgIHRoaXMuX3RhcmdldEluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICB0aGlzLnR5cGUgPSByZWFjdEV2ZW50VHlwZTsKICAgICAgICAgICAgdGhpcy5uYXRpdmVFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICB0aGlzLnRhcmdldCA9IG5hdGl2ZUV2ZW50VGFyZ2V0OwogICAgICAgICAgICB0aGlzLmN1cnJlbnRUYXJnZXQgPSBudWxsOwogICAgICAgICAgICBmb3IgKHZhciBfcHJvcE5hbWUgaW4gSW50ZXJmYWNlKSB7CiAgICAgICAgICAgICAgaWYgKCFJbnRlcmZhY2UuaGFzT3duUHJvcGVydHkoX3Byb3BOYW1lKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBub3JtYWxpemUyID0gSW50ZXJmYWNlW19wcm9wTmFtZV07CiAgICAgICAgICAgICAgaWYgKG5vcm1hbGl6ZTIpIHsKICAgICAgICAgICAgICAgIHRoaXNbX3Byb3BOYW1lXSA9IG5vcm1hbGl6ZTIobmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzW19wcm9wTmFtZV0gPSBuYXRpdmVFdmVudFtfcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVmYXVsdFByZXZlbnRlZCA9IG5hdGl2ZUV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgIT0gbnVsbCA/IG5hdGl2ZUV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQgOiBuYXRpdmVFdmVudC5yZXR1cm5WYWx1ZSA9PT0gZmFsc2U7CiAgICAgICAgICAgIGlmIChkZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNGYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc0ZhbHNlOwogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KICAgICAgICAgIGFzc2lnbjIoU3ludGhldGljQmFzZUV2ZW50LnByb3RvdHlwZSwgewogICAgICAgICAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdGhpcy5kZWZhdWx0UHJldmVudGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgZXZlbnQgPSB0aGlzLm5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIGlmICghZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGV2ZW50LnByZXZlbnREZWZhdWx0KSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV2ZW50LnJldHVyblZhbHVlICE9PSAidW5rbm93biIpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gdGhpcy5uYXRpdmVFdmVudDsKICAgICAgICAgICAgICBpZiAoIWV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChldmVudC5zdG9wUHJvcGFnYXRpb24pIHsKICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGV2ZW50LmNhbmNlbEJ1YmJsZSAhPT0gInVua25vd24iKSB7CiAgICAgICAgICAgICAgICBldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmlzUHJvcGFnYXRpb25TdG9wcGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBXZSByZWxlYXNlIGFsbCBkaXNwYXRjaGVkIGBTeW50aGV0aWNFdmVudGBzIGFmdGVyIGVhY2ggZXZlbnQgbG9vcCwgYWRkaW5nCiAgICAgICAgICAgICAqIHRoZW0gYmFjayBpbnRvIHRoZSBwb29sLiBUaGlzIGFsbG93cyBhIHdheSB0byBob2xkIG9udG8gYSByZWZlcmVuY2UgdGhhdAogICAgICAgICAgICAgKiB3b24ndCBiZSBhZGRlZCBiYWNrIGludG8gdGhlIHBvb2wuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBwZXJzaXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgLyoqCiAgICAgICAgICAgICAqIENoZWNrcyBpZiB0aGlzIGV2ZW50IHNob3VsZCBiZSByZWxlYXNlZCBiYWNrIGludG8gdGhlIHBvb2wuCiAgICAgICAgICAgICAqCiAgICAgICAgICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhpcyBzaG91bGQgbm90IGJlIHJlbGVhc2VkLCBmYWxzZSBvdGhlcndpc2UuCiAgICAgICAgICAgICAqLwogICAgICAgICAgICBpc1BlcnNpc3RlbnQ6IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlCiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiBTeW50aGV0aWNCYXNlRXZlbnQ7CiAgICAgICAgfQogICAgICAgIHZhciBFdmVudEludGVyZmFjZSA9IHsKICAgICAgICAgIGV2ZW50UGhhc2U6IDAsCiAgICAgICAgICBidWJibGVzOiAwLAogICAgICAgICAgY2FuY2VsYWJsZTogMCwKICAgICAgICAgIHRpbWVTdGFtcDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnRpbWVTdGFtcCB8fCBEYXRlLm5vdygpOwogICAgICAgICAgfSwKICAgICAgICAgIGRlZmF1bHRQcmV2ZW50ZWQ6IDAsCiAgICAgICAgICBpc1RydXN0ZWQ6IDAKICAgICAgICB9OwogICAgICAgIHZhciBTeW50aGV0aWNFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgVUlFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICB2aWV3OiAwLAogICAgICAgICAgZGV0YWlsOiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1VJRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChVSUV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgbGFzdE1vdmVtZW50WDsKICAgICAgICB2YXIgbGFzdE1vdmVtZW50WTsKICAgICAgICB2YXIgbGFzdE1vdXNlRXZlbnQ7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTW91c2VNb3ZlbWVudFBvbHlmaWxsU3RhdGUoZXZlbnQpIHsKICAgICAgICAgIGlmIChldmVudCAhPT0gbGFzdE1vdXNlRXZlbnQpIHsKICAgICAgICAgICAgaWYgKGxhc3RNb3VzZUV2ZW50ICYmIGV2ZW50LnR5cGUgPT09ICJtb3VzZW1vdmUiKSB7CiAgICAgICAgICAgICAgbGFzdE1vdmVtZW50WCA9IGV2ZW50LnNjcmVlblggLSBsYXN0TW91c2VFdmVudC5zY3JlZW5YOwogICAgICAgICAgICAgIGxhc3RNb3ZlbWVudFkgPSBldmVudC5zY3JlZW5ZIC0gbGFzdE1vdXNlRXZlbnQuc2NyZWVuWTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRYID0gMDsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRZID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0TW91c2VFdmVudCA9IGV2ZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTW91c2VFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIFVJRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHNjcmVlblg6IDAsCiAgICAgICAgICBzY3JlZW5ZOiAwLAogICAgICAgICAgY2xpZW50WDogMCwKICAgICAgICAgIGNsaWVudFk6IDAsCiAgICAgICAgICBwYWdlWDogMCwKICAgICAgICAgIHBhZ2VZOiAwLAogICAgICAgICAgY3RybEtleTogMCwKICAgICAgICAgIHNoaWZ0S2V5OiAwLAogICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZSwKICAgICAgICAgIGJ1dHRvbjogMCwKICAgICAgICAgIGJ1dHRvbnM6IDAsCiAgICAgICAgICByZWxhdGVkVGFyZ2V0OiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQucmVsYXRlZFRhcmdldCA9PT0gdm9pZCAwKSByZXR1cm4gZXZlbnQuZnJvbUVsZW1lbnQgPT09IGV2ZW50LnNyY0VsZW1lbnQgPyBldmVudC50b0VsZW1lbnQgOiBldmVudC5mcm9tRWxlbWVudDsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50LnJlbGF0ZWRUYXJnZXQ7CiAgICAgICAgICB9LAogICAgICAgICAgbW92ZW1lbnRYOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoIm1vdmVtZW50WCIgaW4gZXZlbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQubW92ZW1lbnRYOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZU1vdXNlTW92ZW1lbnRQb2x5ZmlsbFN0YXRlKGV2ZW50KTsKICAgICAgICAgICAgcmV0dXJuIGxhc3RNb3ZlbWVudFg7CiAgICAgICAgICB9LAogICAgICAgICAgbW92ZW1lbnRZOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoIm1vdmVtZW50WSIgaW4gZXZlbnQpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQubW92ZW1lbnRZOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsYXN0TW92ZW1lbnRZOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNNb3VzZUV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoTW91c2VFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIERyYWdFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRhdGFUcmFuc2ZlcjogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNEcmFnRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChEcmFnRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBGb2N1c0V2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAgcmVsYXRlZFRhcmdldDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNGb2N1c0V2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoRm9jdXNFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIEFuaW1hdGlvbkV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGFuaW1hdGlvbk5hbWU6IDAsCiAgICAgICAgICBlbGFwc2VkVGltZTogMCwKICAgICAgICAgIHBzZXVkb0VsZW1lbnQ6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljQW5pbWF0aW9uRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChBbmltYXRpb25FdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIENsaXBib2FyZEV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGNsaXBib2FyZERhdGE6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAiY2xpcGJvYXJkRGF0YSIgaW4gZXZlbnQgPyBldmVudC5jbGlwYm9hcmREYXRhIDogd2luZG93LmNsaXBib2FyZERhdGE7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0NsaXBib2FyZEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoQ2xpcGJvYXJkRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBDb21wb3NpdGlvbkV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRhdGE6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljQ29tcG9zaXRpb25FdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KENvbXBvc2l0aW9uRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBTeW50aGV0aWNJbnB1dEV2ZW50ID0gU3ludGhldGljQ29tcG9zaXRpb25FdmVudDsKICAgICAgICB2YXIgbm9ybWFsaXplS2V5ID0gewogICAgICAgICAgRXNjOiAiRXNjYXBlIiwKICAgICAgICAgIFNwYWNlYmFyOiAiICIsCiAgICAgICAgICBMZWZ0OiAiQXJyb3dMZWZ0IiwKICAgICAgICAgIFVwOiAiQXJyb3dVcCIsCiAgICAgICAgICBSaWdodDogIkFycm93UmlnaHQiLAogICAgICAgICAgRG93bjogIkFycm93RG93biIsCiAgICAgICAgICBEZWw6ICJEZWxldGUiLAogICAgICAgICAgV2luOiAiT1MiLAogICAgICAgICAgTWVudTogIkNvbnRleHRNZW51IiwKICAgICAgICAgIEFwcHM6ICJDb250ZXh0TWVudSIsCiAgICAgICAgICBTY3JvbGw6ICJTY3JvbGxMb2NrIiwKICAgICAgICAgIE1velByaW50YWJsZUtleTogIlVuaWRlbnRpZmllZCIKICAgICAgICB9OwogICAgICAgIHZhciB0cmFuc2xhdGVUb0tleSA9IHsKICAgICAgICAgICI4IjogIkJhY2tzcGFjZSIsCiAgICAgICAgICAiOSI6ICJUYWIiLAogICAgICAgICAgIjEyIjogIkNsZWFyIiwKICAgICAgICAgICIxMyI6ICJFbnRlciIsCiAgICAgICAgICAiMTYiOiAiU2hpZnQiLAogICAgICAgICAgIjE3IjogIkNvbnRyb2wiLAogICAgICAgICAgIjE4IjogIkFsdCIsCiAgICAgICAgICAiMTkiOiAiUGF1c2UiLAogICAgICAgICAgIjIwIjogIkNhcHNMb2NrIiwKICAgICAgICAgICIyNyI6ICJFc2NhcGUiLAogICAgICAgICAgIjMyIjogIiAiLAogICAgICAgICAgIjMzIjogIlBhZ2VVcCIsCiAgICAgICAgICAiMzQiOiAiUGFnZURvd24iLAogICAgICAgICAgIjM1IjogIkVuZCIsCiAgICAgICAgICAiMzYiOiAiSG9tZSIsCiAgICAgICAgICAiMzciOiAiQXJyb3dMZWZ0IiwKICAgICAgICAgICIzOCI6ICJBcnJvd1VwIiwKICAgICAgICAgICIzOSI6ICJBcnJvd1JpZ2h0IiwKICAgICAgICAgICI0MCI6ICJBcnJvd0Rvd24iLAogICAgICAgICAgIjQ1IjogIkluc2VydCIsCiAgICAgICAgICAiNDYiOiAiRGVsZXRlIiwKICAgICAgICAgICIxMTIiOiAiRjEiLAogICAgICAgICAgIjExMyI6ICJGMiIsCiAgICAgICAgICAiMTE0IjogIkYzIiwKICAgICAgICAgICIxMTUiOiAiRjQiLAogICAgICAgICAgIjExNiI6ICJGNSIsCiAgICAgICAgICAiMTE3IjogIkY2IiwKICAgICAgICAgICIxMTgiOiAiRjciLAogICAgICAgICAgIjExOSI6ICJGOCIsCiAgICAgICAgICAiMTIwIjogIkY5IiwKICAgICAgICAgICIxMjEiOiAiRjEwIiwKICAgICAgICAgICIxMjIiOiAiRjExIiwKICAgICAgICAgICIxMjMiOiAiRjEyIiwKICAgICAgICAgICIxNDQiOiAiTnVtTG9jayIsCiAgICAgICAgICAiMTQ1IjogIlNjcm9sbExvY2siLAogICAgICAgICAgIjIyNCI6ICJNZXRhIgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRLZXkobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5rZXkpIHsKICAgICAgICAgICAgdmFyIGtleSA9IG5vcm1hbGl6ZUtleVtuYXRpdmVFdmVudC5rZXldIHx8IG5hdGl2ZUV2ZW50LmtleTsKICAgICAgICAgICAgaWYgKGtleSAhPT0gIlVuaWRlbnRpZmllZCIpIHsKICAgICAgICAgICAgICByZXR1cm4ga2V5OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmF0aXZlRXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICB2YXIgY2hhckNvZGUgPSBnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgcmV0dXJuIGNoYXJDb2RlID09PSAxMyA/ICJFbnRlciIgOiBTdHJpbmcuZnJvbUNoYXJDb2RlKGNoYXJDb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYXRpdmVFdmVudC50eXBlID09PSAia2V5ZG93biIgfHwgbmF0aXZlRXZlbnQudHlwZSA9PT0gImtleXVwIikgewogICAgICAgICAgICByZXR1cm4gdHJhbnNsYXRlVG9LZXlbbmF0aXZlRXZlbnQua2V5Q29kZV0gfHwgIlVuaWRlbnRpZmllZCI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBtb2RpZmllcktleVRvUHJvcCA9IHsKICAgICAgICAgIEFsdDogImFsdEtleSIsCiAgICAgICAgICBDb250cm9sOiAiY3RybEtleSIsCiAgICAgICAgICBNZXRhOiAibWV0YUtleSIsCiAgICAgICAgICBTaGlmdDogInNoaWZ0S2V5IgogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gbW9kaWZpZXJTdGF0ZUdldHRlcihrZXlBcmcpIHsKICAgICAgICAgIHZhciBzeW50aGV0aWNFdmVudCA9IHRoaXM7CiAgICAgICAgICB2YXIgbmF0aXZlRXZlbnQgPSBzeW50aGV0aWNFdmVudC5uYXRpdmVFdmVudDsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5nZXRNb2RpZmllclN0YXRlKSB7CiAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5nZXRNb2RpZmllclN0YXRlKGtleUFyZyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIga2V5UHJvcCA9IG1vZGlmaWVyS2V5VG9Qcm9wW2tleUFyZ107CiAgICAgICAgICByZXR1cm4ga2V5UHJvcCA/ICEhbmF0aXZlRXZlbnRba2V5UHJvcF0gOiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRNb2RpZmllclN0YXRlKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gbW9kaWZpZXJTdGF0ZUdldHRlcjsKICAgICAgICB9CiAgICAgICAgdmFyIEtleWJvYXJkRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBrZXk6IGdldEV2ZW50S2V5LAogICAgICAgICAgY29kZTogMCwKICAgICAgICAgIGxvY2F0aW9uOiAwLAogICAgICAgICAgY3RybEtleTogMCwKICAgICAgICAgIHNoaWZ0S2V5OiAwLAogICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgIHJlcGVhdDogMCwKICAgICAgICAgIGxvY2FsZTogMCwKICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZSwKICAgICAgICAgIC8vIExlZ2FjeSBJbnRlcmZhY2UKICAgICAgICAgIGNoYXJDb2RlOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleXByZXNzIikgewogICAgICAgICAgICAgIHJldHVybiBnZXRFdmVudENoYXJDb2RlKGV2ZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0sCiAgICAgICAgICBrZXlDb2RlOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICBpZiAoZXZlbnQudHlwZSA9PT0gImtleWRvd24iIHx8IGV2ZW50LnR5cGUgPT09ICJrZXl1cCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZXZlbnQua2V5Q29kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgIH0sCiAgICAgICAgICB3aGljaDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlwcmVzcyIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0RXZlbnRDaGFyQ29kZShldmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlkb3duIiB8fCBldmVudC50eXBlID09PSAia2V5dXAiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmtleUNvZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0tleWJvYXJkRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChLZXlib2FyZEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgUG9pbnRlckV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgTW91c2VFdmVudEludGVyZmFjZSwgewogICAgICAgICAgcG9pbnRlcklkOiAwLAogICAgICAgICAgd2lkdGg6IDAsCiAgICAgICAgICBoZWlnaHQ6IDAsCiAgICAgICAgICBwcmVzc3VyZTogMCwKICAgICAgICAgIHRhbmdlbnRpYWxQcmVzc3VyZTogMCwKICAgICAgICAgIHRpbHRYOiAwLAogICAgICAgICAgdGlsdFk6IDAsCiAgICAgICAgICB0d2lzdDogMCwKICAgICAgICAgIHBvaW50ZXJUeXBlOiAwLAogICAgICAgICAgaXNQcmltYXJ5OiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1BvaW50ZXJFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFBvaW50ZXJFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFRvdWNoRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICB0b3VjaGVzOiAwLAogICAgICAgICAgdGFyZ2V0VG91Y2hlczogMCwKICAgICAgICAgIGNoYW5nZWRUb3VjaGVzOiAwLAogICAgICAgICAgYWx0S2V5OiAwLAogICAgICAgICAgbWV0YUtleTogMCwKICAgICAgICAgIGN0cmxLZXk6IDAsCiAgICAgICAgICBzaGlmdEtleTogMCwKICAgICAgICAgIGdldE1vZGlmaWVyU3RhdGU6IGdldEV2ZW50TW9kaWZpZXJTdGF0ZQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNUb3VjaEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoVG91Y2hFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBwcm9wZXJ0eU5hbWU6IDAsCiAgICAgICAgICBlbGFwc2VkVGltZTogMCwKICAgICAgICAgIHBzZXVkb0VsZW1lbnQ6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljVHJhbnNpdGlvbkV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoVHJhbnNpdGlvbkV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgV2hlZWxFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIGRlbHRhWDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuICJkZWx0YVgiIGluIGV2ZW50ID8gZXZlbnQuZGVsdGFYIDogKAogICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIGB3aGVlbERlbHRhWGAgZm9yIFdlYmtpdCBhbmQgbm9ybWFsaXplIChyaWdodCBpcyBwb3NpdGl2ZSkuCiAgICAgICAgICAgICAgIndoZWVsRGVsdGFYIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhWCA6IDAKICAgICAgICAgICAgKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZWx0YVk6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAiZGVsdGFZIiBpbiBldmVudCA/IGV2ZW50LmRlbHRhWSA6ICgKICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YVlgIGZvciBXZWJraXQgYW5kIG5vcm1hbGl6ZSAoZG93biBpcyBwb3NpdGl2ZSkuCiAgICAgICAgICAgICAgIndoZWVsRGVsdGFZIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhWSA6ICgKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIGB3aGVlbERlbHRhYCBmb3IgSUU8OSBhbmQgbm9ybWFsaXplIChkb3duIGlzIHBvc2l0aXZlKS4KICAgICAgICAgICAgICAgICJ3aGVlbERlbHRhIiBpbiBldmVudCA/IC1ldmVudC53aGVlbERlbHRhIDogMAogICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZWx0YVo6IDAsCiAgICAgICAgICAvLyBCcm93c2VycyB3aXRob3V0ICJkZWx0YU1vZGUiIGlzIHJlcG9ydGluZyBpbiByYXcgd2hlZWwgZGVsdGEgd2hlcmUgb25lCiAgICAgICAgICAvLyBub3RjaCBvbiB0aGUgc2Nyb2xsIGlzIGFsd2F5cyArLy0gMTIwLCByb3VnaGx5IGVxdWl2YWxlbnQgdG8gcGl4ZWxzLgogICAgICAgICAgLy8gQSBnb29kIGFwcHJveGltYXRpb24gb2YgRE9NX0RFTFRBX0xJTkUgKDEpIGlzIDUlIG9mIHZpZXdwb3J0IHNpemUgb3IKICAgICAgICAgIC8vIH40MCBwaXhlbHMsIGZvciBET01fREVMVEFfU0NSRUVOICgyKSBpdCBpcyA4Ny41JSBvZiB2aWV3cG9ydCBzaXplLgogICAgICAgICAgZGVsdGFNb2RlOiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1doZWVsRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChXaGVlbEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgRU5EX0tFWUNPREVTID0gWzksIDEzLCAyNywgMzJdOwogICAgICAgIHZhciBTVEFSVF9LRVlDT0RFID0gMjI5OwogICAgICAgIHZhciBjYW5Vc2VDb21wb3NpdGlvbkV2ZW50ID0gY2FuVXNlRE9NMiAmJiAiQ29tcG9zaXRpb25FdmVudCIgaW4gd2luZG93OwogICAgICAgIHZhciBkb2N1bWVudE1vZGUgPSBudWxsOwogICAgICAgIGlmIChjYW5Vc2VET00yICYmICJkb2N1bWVudE1vZGUiIGluIGRvY3VtZW50KSB7CiAgICAgICAgICBkb2N1bWVudE1vZGUgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgICAgfQogICAgICAgIHZhciBjYW5Vc2VUZXh0SW5wdXRFdmVudCA9IGNhblVzZURPTTIgJiYgIlRleHRFdmVudCIgaW4gd2luZG93ICYmICFkb2N1bWVudE1vZGU7CiAgICAgICAgdmFyIHVzZUZhbGxiYWNrQ29tcG9zaXRpb25EYXRhID0gY2FuVXNlRE9NMiAmJiAoIWNhblVzZUNvbXBvc2l0aW9uRXZlbnQgfHwgZG9jdW1lbnRNb2RlICYmIGRvY3VtZW50TW9kZSA+IDggJiYgZG9jdW1lbnRNb2RlIDw9IDExKTsKICAgICAgICB2YXIgU1BBQ0VCQVJfQ09ERSA9IDMyOwogICAgICAgIHZhciBTUEFDRUJBUl9DSEFSID0gU3RyaW5nLmZyb21DaGFyQ29kZShTUEFDRUJBUl9DT0RFKTsKICAgICAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50cygpIHsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25CZWZvcmVJbnB1dCIsIFsiY29tcG9zaXRpb25lbmQiLCAia2V5cHJlc3MiLCAidGV4dElucHV0IiwgInBhc3RlIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uRW5kIiwgWyJjb21wb3NpdGlvbmVuZCIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25Db21wb3NpdGlvblN0YXJ0IiwgWyJjb21wb3NpdGlvbnN0YXJ0IiwgImZvY3Vzb3V0IiwgImtleWRvd24iLCAia2V5cHJlc3MiLCAia2V5dXAiLCAibW91c2Vkb3duIl0pOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNvbXBvc2l0aW9uVXBkYXRlIiwgWyJjb21wb3NpdGlvbnVwZGF0ZSIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1NwYWNlS2V5cHJlc3MgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBpc0tleXByZXNzQ29tbWFuZChuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuIChuYXRpdmVFdmVudC5jdHJsS2V5IHx8IG5hdGl2ZUV2ZW50LmFsdEtleSB8fCBuYXRpdmVFdmVudC5tZXRhS2V5KSAmJiAvLyBjdHJsS2V5ICYmIGFsdEtleSBpcyBlcXVpdmFsZW50IHRvIEFsdEdyLCBhbmQgaXMgbm90IGEgY29tbWFuZC4KICAgICAgICAgICEobmF0aXZlRXZlbnQuY3RybEtleSAmJiBuYXRpdmVFdmVudC5hbHRLZXkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb3NpdGlvbkV2ZW50VHlwZShkb21FdmVudE5hbWUpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uc3RhcnQiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvblN0YXJ0IjsKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25lbmQiOgogICAgICAgICAgICAgIHJldHVybiAib25Db21wb3NpdGlvbkVuZCI7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9udXBkYXRlIjoKICAgICAgICAgICAgICByZXR1cm4gIm9uQ29tcG9zaXRpb25VcGRhdGUiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0ZhbGxiYWNrQ29tcG9zaXRpb25TdGFydChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gZG9tRXZlbnROYW1lID09PSAia2V5ZG93biIgJiYgbmF0aXZlRXZlbnQua2V5Q29kZSA9PT0gU1RBUlRfS0VZQ09ERTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICByZXR1cm4gRU5EX0tFWUNPREVTLmluZGV4T2YobmF0aXZlRXZlbnQua2V5Q29kZSkgIT09IC0xOwogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgICByZXR1cm4gbmF0aXZlRXZlbnQua2V5Q29kZSAhPT0gU1RBUlRfS0VZQ09ERTsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREYXRhRnJvbUN1c3RvbUV2ZW50KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgZGV0YWlsID0gbmF0aXZlRXZlbnQuZGV0YWlsOwogICAgICAgICAgaWYgKHR5cGVvZiBkZXRhaWwgPT09ICJvYmplY3QiICYmICJkYXRhIiBpbiBkZXRhaWwpIHsKICAgICAgICAgICAgcmV0dXJuIGRldGFpbC5kYXRhOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5sb2NhbGUgPT09ICJrbyI7CiAgICAgICAgfQogICAgICAgIHZhciBpc0NvbXBvc2luZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RDb21wb3NpdGlvbkV2ZW50KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICB2YXIgZXZlbnRUeXBlOwogICAgICAgICAgdmFyIGZhbGxiYWNrRGF0YTsKICAgICAgICAgIGlmIChjYW5Vc2VDb21wb3NpdGlvbkV2ZW50KSB7CiAgICAgICAgICAgIGV2ZW50VHlwZSA9IGdldENvbXBvc2l0aW9uRXZlbnRUeXBlKGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKCFpc0NvbXBvc2luZykgewogICAgICAgICAgICBpZiAoaXNGYWxsYmFja0NvbXBvc2l0aW9uU3RhcnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgICBldmVudFR5cGUgPSAib25Db21wb3NpdGlvblN0YXJ0IjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc0ZhbGxiYWNrQ29tcG9zaXRpb25FbmQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgZXZlbnRUeXBlID0gIm9uQ29tcG9zaXRpb25FbmQiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFldmVudFR5cGUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodXNlRmFsbGJhY2tDb21wb3NpdGlvbkRhdGEgJiYgIWlzVXNpbmdLb3JlYW5JTUUobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIGlmICghaXNDb21wb3NpbmcgJiYgZXZlbnRUeXBlID09PSAib25Db21wb3NpdGlvblN0YXJ0IikgewogICAgICAgICAgICAgIGlzQ29tcG9zaW5nID0gaW5pdGlhbGl6ZShuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSAib25Db21wb3NpdGlvbkVuZCIpIHsKICAgICAgICAgICAgICBpZiAoaXNDb21wb3NpbmcpIHsKICAgICAgICAgICAgICAgIGZhbGxiYWNrRGF0YSA9IGdldERhdGEoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgZXZlbnRUeXBlKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljQ29tcG9zaXRpb25FdmVudChldmVudFR5cGUsIGRvbUV2ZW50TmFtZSwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGlmIChmYWxsYmFja0RhdGEpIHsKICAgICAgICAgICAgICBldmVudC5kYXRhID0gZmFsbGJhY2tEYXRhOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBjdXN0b21EYXRhID0gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICAgICAgaWYgKGN1c3RvbURhdGEgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBjdXN0b21EYXRhOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROYXRpdmVCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICB2YXIgd2hpY2ggPSBuYXRpdmVFdmVudC53aGljaDsKICAgICAgICAgICAgICBpZiAod2hpY2ggIT09IFNQQUNFQkFSX0NPREUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBoYXNTcGFjZUtleXByZXNzID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gU1BBQ0VCQVJfQ0hBUjsKICAgICAgICAgICAgY2FzZSAidGV4dElucHV0IjoKICAgICAgICAgICAgICB2YXIgY2hhcnMgPSBuYXRpdmVFdmVudC5kYXRhOwogICAgICAgICAgICAgIGlmIChjaGFycyA9PT0gU1BBQ0VCQVJfQ0hBUiAmJiBoYXNTcGFjZUtleXByZXNzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJzOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGYWxsYmFja0JlZm9yZUlucHV0Q2hhcnMoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKGlzQ29tcG9zaW5nKSB7CiAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjb21wb3NpdGlvbmVuZCIgfHwgIWNhblVzZUNvbXBvc2l0aW9uRXZlbnQgJiYgaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgICAgdmFyIGNoYXJzID0gZ2V0RGF0YSgpOwogICAgICAgICAgICAgIHJlc2V0KCk7CiAgICAgICAgICAgICAgaXNDb21wb3NpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gY2hhcnM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgICBpZiAoIWlzS2V5cHJlc3NDb21tYW5kKG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LmNoYXIgJiYgbmF0aXZlRXZlbnQuY2hhci5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBuYXRpdmVFdmVudC5jaGFyOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuYXRpdmVFdmVudC53aGljaCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShuYXRpdmVFdmVudC53aGljaCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIHVzZUZhbGxiYWNrQ29tcG9zaXRpb25EYXRhICYmICFpc1VzaW5nS29yZWFuSU1FKG5hdGl2ZUV2ZW50KSA/IG51bGwgOiBuYXRpdmVFdmVudC5kYXRhOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0QmVmb3JlSW5wdXRFdmVudChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGNoYXJzOwogICAgICAgICAgaWYgKGNhblVzZVRleHRJbnB1dEV2ZW50KSB7CiAgICAgICAgICAgIGNoYXJzID0gZ2V0TmF0aXZlQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNoYXJzID0gZ2V0RmFsbGJhY2tCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFjaGFycykgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgIm9uQmVmb3JlSW5wdXQiKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljSW5wdXRFdmVudCgib25CZWZvcmVJbnB1dCIsICJiZWZvcmVpbnB1dCIsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBldmVudC5kYXRhID0gY2hhcnM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgZXh0cmFjdENvbXBvc2l0aW9uRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgZXh0cmFjdEJlZm9yZUlucHV0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgIH0KICAgICAgICB2YXIgc3VwcG9ydGVkSW5wdXRUeXBlcyA9IHsKICAgICAgICAgIGNvbG9yOiB0cnVlLAogICAgICAgICAgZGF0ZTogdHJ1ZSwKICAgICAgICAgIGRhdGV0aW1lOiB0cnVlLAogICAgICAgICAgImRhdGV0aW1lLWxvY2FsIjogdHJ1ZSwKICAgICAgICAgIGVtYWlsOiB0cnVlLAogICAgICAgICAgbW9udGg6IHRydWUsCiAgICAgICAgICBudW1iZXI6IHRydWUsCiAgICAgICAgICBwYXNzd29yZDogdHJ1ZSwKICAgICAgICAgIHJhbmdlOiB0cnVlLAogICAgICAgICAgc2VhcmNoOiB0cnVlLAogICAgICAgICAgdGVsOiB0cnVlLAogICAgICAgICAgdGV4dDogdHJ1ZSwKICAgICAgICAgIHRpbWU6IHRydWUsCiAgICAgICAgICB1cmw6IHRydWUsCiAgICAgICAgICB3ZWVrOiB0cnVlCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBpc1RleHRJbnB1dEVsZW1lbnQoZWxlbSkgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbSAmJiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIGlmIChub2RlTmFtZSA9PT0gImlucHV0IikgewogICAgICAgICAgICByZXR1cm4gISFzdXBwb3J0ZWRJbnB1dFR5cGVzW2VsZW0udHlwZV07CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRXZlbnRTdXBwb3J0ZWQoZXZlbnROYW1lU3VmZml4KSB7CiAgICAgICAgICBpZiAoIWNhblVzZURPTTIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50TmFtZSA9ICJvbiIgKyBldmVudE5hbWVTdWZmaXg7CiAgICAgICAgICB2YXIgaXNTdXBwb3J0ZWQgPSBldmVudE5hbWUgaW4gZG9jdW1lbnQ7CiAgICAgICAgICBpZiAoIWlzU3VwcG9ydGVkKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKGV2ZW50TmFtZSwgInJldHVybjsiKTsKICAgICAgICAgICAgaXNTdXBwb3J0ZWQgPSB0eXBlb2YgZWxlbWVudFtldmVudE5hbWVdID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGlzU3VwcG9ydGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50cyQxKCkgewogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvbkNoYW5nZSIsIFsiY2hhbmdlIiwgImNsaWNrIiwgImZvY3VzaW4iLCAiZm9jdXNvdXQiLCAiaW5wdXQiLCAia2V5ZG93biIsICJrZXl1cCIsICJzZWxlY3Rpb25jaGFuZ2UiXSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUFuZEFjY3VtdWxhdGVDaGFuZ2VFdmVudChkaXNwYXRjaFF1ZXVlLCBpbnN0LCBuYXRpdmVFdmVudCwgdGFyZ2V0KSB7CiAgICAgICAgICBlbnF1ZXVlU3RhdGVSZXN0b3JlKHRhcmdldCk7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gYWNjdW11bGF0ZVR3b1BoYXNlTGlzdGVuZXJzKGluc3QsICJvbkNoYW5nZSIpOwogICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBTeW50aGV0aWNFdmVudCgib25DaGFuZ2UiLCAiY2hhbmdlIiwgbnVsbCwgbmF0aXZlRXZlbnQsIHRhcmdldCk7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYWN0aXZlRWxlbWVudCA9IG51bGw7CiAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnRJbnN0ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBzaG91bGRVc2VDaGFuZ2VFdmVudChlbGVtKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZSA9PT0gInNlbGVjdCIgfHwgbm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgZWxlbS50eXBlID09PSAiZmlsZSI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hbnVhbERpc3BhdGNoQ2hhbmdlRXZlbnQobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaFF1ZXVlID0gW107CiAgICAgICAgICBjcmVhdGVBbmRBY2N1bXVsYXRlQ2hhbmdlRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgYWN0aXZlRWxlbWVudEluc3QsIG5hdGl2ZUV2ZW50LCBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCkpOwogICAgICAgICAgYmF0Y2hlZFVwZGF0ZXMocnVuRXZlbnRJbkJhdGNoLCBkaXNwYXRjaFF1ZXVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcnVuRXZlbnRJbkJhdGNoKGRpc3BhdGNoUXVldWUpIHsKICAgICAgICAgIHByb2Nlc3NEaXNwYXRjaFF1ZXVlKGRpc3BhdGNoUXVldWUsIDApOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQodGFyZ2V0SW5zdCkgewogICAgICAgICAgdmFyIHRhcmdldE5vZGUgPSBnZXROb2RlRnJvbUluc3RhbmNlKHRhcmdldEluc3QpOwogICAgICAgICAgaWYgKHVwZGF0ZVZhbHVlSWZDaGFuZ2VkKHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9yQ2hhbmdlRXZlbnQoZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiY2hhbmdlIikgewogICAgICAgICAgICByZXR1cm4gdGFyZ2V0SW5zdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzSW5wdXRFdmVudFN1cHBvcnRlZCA9IGZhbHNlOwogICAgICAgIGlmIChjYW5Vc2VET00yKSB7CiAgICAgICAgICBpc0lucHV0RXZlbnRTdXBwb3J0ZWQgPSBpc0V2ZW50U3VwcG9ydGVkKCJpbnB1dCIpICYmICghZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHx8IGRvY3VtZW50LmRvY3VtZW50TW9kZSA+IDkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UodGFyZ2V0LCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBhY3RpdmVFbGVtZW50ID0gdGFyZ2V0OwogICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgYWN0aXZlRWxlbWVudC5hdHRhY2hFdmVudCgib25wcm9wZXJ0eWNoYW5nZSIsIGhhbmRsZVByb3BlcnR5Q2hhbmdlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKSB7CiAgICAgICAgICBpZiAoIWFjdGl2ZUVsZW1lbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgYWN0aXZlRWxlbWVudC5kZXRhY2hFdmVudCgib25wcm9wZXJ0eWNoYW5nZSIsIGhhbmRsZVByb3BlcnR5Q2hhbmdlKTsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnQgPSBudWxsOwogICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVQcm9wZXJ0eUNoYW5nZShuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LnByb3BlcnR5TmFtZSAhPT0gInZhbHVlIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKGFjdGl2ZUVsZW1lbnRJbnN0KSkgewogICAgICAgICAgICBtYW51YWxEaXNwYXRjaENoYW5nZUV2ZW50KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlRXZlbnRzRm9ySW5wdXRFdmVudFBvbHlmaWxsKGRvbUV2ZW50TmFtZSwgdGFyZ2V0LCB0YXJnZXRJbnN0KSB7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiZm9jdXNpbiIpIHsKICAgICAgICAgICAgc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKTsKICAgICAgICAgICAgc3RhcnRXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKHRhcmdldCwgdGFyZ2V0SW5zdCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImZvY3Vzb3V0IikgewogICAgICAgICAgICBzdG9wV2F0Y2hpbmdGb3JWYWx1ZUNoYW5nZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRFdmVudFBvbHlmaWxsKGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gInNlbGVjdGlvbmNoYW5nZSIgfHwgZG9tRXZlbnROYW1lID09PSAia2V5dXAiIHx8IGRvbUV2ZW50TmFtZSA9PT0gImtleWRvd24iKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQoYWN0aXZlRWxlbWVudEluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRVc2VDbGlja0V2ZW50KGVsZW0pIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0ubm9kZU5hbWU7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgJiYgbm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImlucHV0IiAmJiAoZWxlbS50eXBlID09PSAiY2hlY2tib3giIHx8IGVsZW0udHlwZSA9PT0gInJhZGlvIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRhcmdldEluc3RGb3JDbGlja0V2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImNsaWNrIikgewogICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKHRhcmdldEluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRPckNoYW5nZUV2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImlucHV0IiB8fCBkb21FdmVudE5hbWUgPT09ICJjaGFuZ2UiKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRJbnN0SWZWYWx1ZUNoYW5nZWQodGFyZ2V0SW5zdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUNvbnRyb2xsZWRJbnB1dEJsdXIobm9kZSkgewogICAgICAgICAgdmFyIHN0YXRlID0gbm9kZS5fd3JhcHBlclN0YXRlOwogICAgICAgICAgaWYgKCFzdGF0ZSB8fCAhc3RhdGUuY29udHJvbGxlZCB8fCBub2RlLnR5cGUgIT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgc2V0RGVmYXVsdFZhbHVlKG5vZGUsICJudW1iZXIiLCBub2RlLnZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQxKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciB0YXJnZXROb2RlID0gdGFyZ2V0SW5zdCA/IGdldE5vZGVGcm9tSW5zdGFuY2UodGFyZ2V0SW5zdCkgOiB3aW5kb3c7CiAgICAgICAgICB2YXIgZ2V0VGFyZ2V0SW5zdEZ1bmMsIGhhbmRsZUV2ZW50RnVuYzsKICAgICAgICAgIGlmIChzaG91bGRVc2VDaGFuZ2VFdmVudCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JDaGFuZ2VFdmVudDsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNUZXh0SW5wdXRFbGVtZW50KHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgIGlmIChpc0lucHV0RXZlbnRTdXBwb3J0ZWQpIHsKICAgICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JJbnB1dE9yQ2hhbmdlRXZlbnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRFdmVudFBvbHlmaWxsOwogICAgICAgICAgICAgIGhhbmRsZUV2ZW50RnVuYyA9IGhhbmRsZUV2ZW50c0ZvcklucHV0RXZlbnRQb2x5ZmlsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChzaG91bGRVc2VDbGlja0V2ZW50KHRhcmdldE5vZGUpKSB7CiAgICAgICAgICAgIGdldFRhcmdldEluc3RGdW5jID0gZ2V0VGFyZ2V0SW5zdEZvckNsaWNrRXZlbnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0VGFyZ2V0SW5zdEZ1bmMpIHsKICAgICAgICAgICAgdmFyIGluc3QgPSBnZXRUYXJnZXRJbnN0RnVuYyhkb21FdmVudE5hbWUsIHRhcmdldEluc3QpOwogICAgICAgICAgICBpZiAoaW5zdCkgewogICAgICAgICAgICAgIGNyZWF0ZUFuZEFjY3VtdWxhdGVDaGFuZ2VFdmVudChkaXNwYXRjaFF1ZXVlLCBpbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhbmRsZUV2ZW50RnVuYykgewogICAgICAgICAgICBoYW5kbGVFdmVudEZ1bmMoZG9tRXZlbnROYW1lLCB0YXJnZXROb2RlLCB0YXJnZXRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJmb2N1c291dCIpIHsKICAgICAgICAgICAgaGFuZGxlQ29udHJvbGxlZElucHV0Qmx1cih0YXJnZXROb2RlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMkMigpIHsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uTW91c2VFbnRlciIsIFsibW91c2VvdXQiLCAibW91c2VvdmVyIl0pOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudCgib25Nb3VzZUxlYXZlIiwgWyJtb3VzZW91dCIsICJtb3VzZW92ZXIiXSk7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvblBvaW50ZXJFbnRlciIsIFsicG9pbnRlcm91dCIsICJwb2ludGVyb3ZlciJdKTsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uUG9pbnRlckxlYXZlIiwgWyJwb2ludGVyb3V0IiwgInBvaW50ZXJvdmVyIl0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDIoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgdmFyIGlzT3ZlckV2ZW50ID0gZG9tRXZlbnROYW1lID09PSAibW91c2VvdmVyIiB8fCBkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3ZlciI7CiAgICAgICAgICB2YXIgaXNPdXRFdmVudCA9IGRvbUV2ZW50TmFtZSA9PT0gIm1vdXNlb3V0IiB8fCBkb21FdmVudE5hbWUgPT09ICJwb2ludGVyb3V0IjsKICAgICAgICAgIGlmIChpc092ZXJFdmVudCAmJiAhaXNSZXBsYXlpbmdFdmVudChuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgdmFyIHJlbGF0ZWQgPSBuYXRpdmVFdmVudC5yZWxhdGVkVGFyZ2V0IHx8IG5hdGl2ZUV2ZW50LmZyb21FbGVtZW50OwogICAgICAgICAgICBpZiAocmVsYXRlZCkgewogICAgICAgICAgICAgIGlmIChnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZShyZWxhdGVkKSB8fCBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChyZWxhdGVkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc091dEV2ZW50ICYmICFpc092ZXJFdmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2luOwogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50VGFyZ2V0LndpbmRvdyA9PT0gbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgICAgd2luID0gbmF0aXZlRXZlbnRUYXJnZXQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZG9jID0gbmF0aXZlRXZlbnRUYXJnZXQub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgaWYgKGRvYykgewogICAgICAgICAgICAgIHdpbiA9IGRvYy5kZWZhdWx0VmlldyB8fCBkb2MucGFyZW50V2luZG93OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdpbiA9IHdpbmRvdzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGZyb20yOwogICAgICAgICAgdmFyIHRvMjsKICAgICAgICAgIGlmIChpc091dEV2ZW50KSB7CiAgICAgICAgICAgIHZhciBfcmVsYXRlZCA9IG5hdGl2ZUV2ZW50LnJlbGF0ZWRUYXJnZXQgfHwgbmF0aXZlRXZlbnQudG9FbGVtZW50OwogICAgICAgICAgICBmcm9tMiA9IHRhcmdldEluc3Q7CiAgICAgICAgICAgIHRvMiA9IF9yZWxhdGVkID8gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUoX3JlbGF0ZWQpIDogbnVsbDsKICAgICAgICAgICAgaWYgKHRvMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZWFyZXN0TW91bnRlZCA9IGdldE5lYXJlc3RNb3VudGVkRmliZXIodG8yKTsKICAgICAgICAgICAgICBpZiAodG8yICE9PSBuZWFyZXN0TW91bnRlZCB8fCB0bzIudGFnICE9PSBIb3N0Q29tcG9uZW50ICYmIHRvMi50YWcgIT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICB0bzIgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnJvbTIgPSBudWxsOwogICAgICAgICAgICB0bzIgPSB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZyb20yID09PSB0bzIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY01vdXNlRXZlbnQ7CiAgICAgICAgICB2YXIgbGVhdmVFdmVudFR5cGUgPSAib25Nb3VzZUxlYXZlIjsKICAgICAgICAgIHZhciBlbnRlckV2ZW50VHlwZSA9ICJvbk1vdXNlRW50ZXIiOwogICAgICAgICAgdmFyIGV2ZW50VHlwZVByZWZpeCA9ICJtb3VzZSI7CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm91dCIgfHwgZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm92ZXIiKSB7CiAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1BvaW50ZXJFdmVudDsKICAgICAgICAgICAgbGVhdmVFdmVudFR5cGUgPSAib25Qb2ludGVyTGVhdmUiOwogICAgICAgICAgICBlbnRlckV2ZW50VHlwZSA9ICJvblBvaW50ZXJFbnRlciI7CiAgICAgICAgICAgIGV2ZW50VHlwZVByZWZpeCA9ICJwb2ludGVyIjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmcm9tTm9kZSA9IGZyb20yID09IG51bGwgPyB3aW4gOiBnZXROb2RlRnJvbUluc3RhbmNlKGZyb20yKTsKICAgICAgICAgIHZhciB0b05vZGUgPSB0bzIgPT0gbnVsbCA/IHdpbiA6IGdldE5vZGVGcm9tSW5zdGFuY2UodG8yKTsKICAgICAgICAgIHZhciBsZWF2ZSA9IG5ldyBTeW50aGV0aWNFdmVudEN0b3IobGVhdmVFdmVudFR5cGUsIGV2ZW50VHlwZVByZWZpeCArICJsZWF2ZSIsIGZyb20yLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgbGVhdmUudGFyZ2V0ID0gZnJvbU5vZGU7CiAgICAgICAgICBsZWF2ZS5yZWxhdGVkVGFyZ2V0ID0gdG9Ob2RlOwogICAgICAgICAgdmFyIGVudGVyID0gbnVsbDsKICAgICAgICAgIHZhciBuYXRpdmVUYXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKG5hdGl2ZVRhcmdldEluc3QgPT09IHRhcmdldEluc3QpIHsKICAgICAgICAgICAgdmFyIGVudGVyRXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKGVudGVyRXZlbnRUeXBlLCBldmVudFR5cGVQcmVmaXggKyAiZW50ZXIiLCB0bzIsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGVudGVyRXZlbnQudGFyZ2V0ID0gdG9Ob2RlOwogICAgICAgICAgICBlbnRlckV2ZW50LnJlbGF0ZWRUYXJnZXQgPSBmcm9tTm9kZTsKICAgICAgICAgICAgZW50ZXIgPSBlbnRlckV2ZW50OwogICAgICAgICAgfQogICAgICAgICAgYWNjdW11bGF0ZUVudGVyTGVhdmVUd29QaGFzZUxpc3RlbmVycyhkaXNwYXRjaFF1ZXVlLCBsZWF2ZSwgZW50ZXIsIGZyb20yLCB0bzIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpczQoeDIsIHkyKSB7CiAgICAgICAgICByZXR1cm4geDIgPT09IHkyICYmICh4MiAhPT0gMCB8fCAxIC8geDIgPT09IDEgLyB5MikgfHwgeDIgIT09IHgyICYmIHkyICE9PSB5MjsKICAgICAgICB9CiAgICAgICAgdmFyIG9iamVjdElzID0gdHlwZW9mIE9iamVjdC5pcyA9PT0gImZ1bmN0aW9uIiA/IE9iamVjdC5pcyA6IGlzNDsKICAgICAgICBmdW5jdGlvbiBzaGFsbG93RXF1YWwyKG9iakEsIG9iakIpIHsKICAgICAgICAgIGlmIChvYmplY3RJcyhvYmpBLCBvYmpCKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2Ygb2JqQSAhPT0gIm9iamVjdCIgfHwgb2JqQSA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqQiAhPT0gIm9iamVjdCIgfHwgb2JqQiA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIga2V5c0EgPSBPYmplY3Qua2V5cyhvYmpBKTsKICAgICAgICAgIHZhciBrZXlzQiA9IE9iamVjdC5rZXlzKG9iakIpOwogICAgICAgICAgaWYgKGtleXNBLmxlbmd0aCAhPT0ga2V5c0IubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5c0EubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRLZXkgPSBrZXlzQVtpXTsKICAgICAgICAgICAgaWYgKCFoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iakIsIGN1cnJlbnRLZXkpIHx8ICFvYmplY3RJcyhvYmpBW2N1cnJlbnRLZXldLCBvYmpCW2N1cnJlbnRLZXldKSkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExlYWZOb2RlKG5vZGUpIHsKICAgICAgICAgIHdoaWxlIChub2RlICYmIG5vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICBub2RlID0gbm9kZS5maXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNpYmxpbmdOb2RlKG5vZGUpIHsKICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlLm5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUZvckNoYXJhY3Rlck9mZnNldChyb290Mywgb2Zmc2V0KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGdldExlYWZOb2RlKHJvb3QzKTsKICAgICAgICAgIHZhciBub2RlU3RhcnQgPSAwOwogICAgICAgICAgdmFyIG5vZGVFbmQgPSAwOwogICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkgewogICAgICAgICAgICAgIG5vZGVFbmQgPSBub2RlU3RhcnQgKyBub2RlLnRleHRDb250ZW50Lmxlbmd0aDsKICAgICAgICAgICAgICBpZiAobm9kZVN0YXJ0IDw9IG9mZnNldCAmJiBub2RlRW5kID49IG9mZnNldCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgbm9kZSwKICAgICAgICAgICAgICAgICAgb2Zmc2V0OiBvZmZzZXQgLSBub2RlU3RhcnQKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGVTdGFydCA9IG5vZGVFbmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IGdldExlYWZOb2RlKGdldFNpYmxpbmdOb2RlKG5vZGUpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0T2Zmc2V0cyhvdXRlck5vZGUpIHsKICAgICAgICAgIHZhciBvd25lckRvY3VtZW50ID0gb3V0ZXJOb2RlLm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICB2YXIgd2luID0gb3duZXJEb2N1bWVudCAmJiBvd25lckRvY3VtZW50LmRlZmF1bHRWaWV3IHx8IHdpbmRvdzsKICAgICAgICAgIHZhciBzZWxlY3Rpb24gPSB3aW4uZ2V0U2VsZWN0aW9uICYmIHdpbi5nZXRTZWxlY3Rpb24oKTsKICAgICAgICAgIGlmICghc2VsZWN0aW9uIHx8IHNlbGVjdGlvbi5yYW5nZUNvdW50ID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGFuY2hvck5vZGUgPSBzZWxlY3Rpb24uYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0ID0gc2VsZWN0aW9uLmFuY2hvck9mZnNldCwgZm9jdXNOb2RlID0gc2VsZWN0aW9uLmZvY3VzTm9kZSwgZm9jdXNPZmZzZXQgPSBzZWxlY3Rpb24uZm9jdXNPZmZzZXQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBhbmNob3JOb2RlLm5vZGVUeXBlOwogICAgICAgICAgICBmb2N1c05vZGUubm9kZVR5cGU7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldE1vZGVybk9mZnNldHNGcm9tUG9pbnRzKG91dGVyTm9kZSwgYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0LCBmb2N1c05vZGUsIGZvY3VzT2Zmc2V0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TW9kZXJuT2Zmc2V0c0Zyb21Qb2ludHMob3V0ZXJOb2RlLCBhbmNob3JOb2RlLCBhbmNob3JPZmZzZXQsIGZvY3VzTm9kZSwgZm9jdXNPZmZzZXQpIHsKICAgICAgICAgIHZhciBsZW5ndGggPSAwOwogICAgICAgICAgdmFyIHN0YXJ0ID0gLTE7CiAgICAgICAgICB2YXIgZW5kID0gLTE7CiAgICAgICAgICB2YXIgaW5kZXhXaXRoaW5BbmNob3IgPSAwOwogICAgICAgICAgdmFyIGluZGV4V2l0aGluRm9jdXMgPSAwOwogICAgICAgICAgdmFyIG5vZGUgPSBvdXRlck5vZGU7CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IG51bGw7CiAgICAgICAgICBvdXRlcjogd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgdmFyIG5leHQgPSBudWxsOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIGlmIChub2RlID09PSBhbmNob3JOb2RlICYmIChhbmNob3JPZmZzZXQgPT09IDAgfHwgbm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSkgewogICAgICAgICAgICAgICAgc3RhcnQgPSBsZW5ndGggKyBhbmNob3JPZmZzZXQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlID09PSBmb2N1c05vZGUgJiYgKGZvY3VzT2Zmc2V0ID09PSAwIHx8IG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkpIHsKICAgICAgICAgICAgICAgIGVuZCA9IGxlbmd0aCArIGZvY3VzT2Zmc2V0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgICBsZW5ndGggKz0gbm9kZS5ub2RlVmFsdWUubGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKG5leHQgPSBub2RlLmZpcnN0Q2hpbGQpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50Tm9kZSA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IG5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gb3V0ZXJOb2RlKSB7CiAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IGFuY2hvck5vZGUgJiYgKytpbmRleFdpdGhpbkFuY2hvciA9PT0gYW5jaG9yT2Zmc2V0KSB7CiAgICAgICAgICAgICAgICBzdGFydCA9IGxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IGZvY3VzTm9kZSAmJiArK2luZGV4V2l0aGluRm9jdXMgPT09IGZvY3VzT2Zmc2V0KSB7CiAgICAgICAgICAgICAgICBlbmQgPSBsZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgobmV4dCA9IG5vZGUubmV4dFNpYmxpbmcpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgICAgcGFyZW50Tm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbmV4dDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdGFydCA9PT0gLTEgfHwgZW5kID09PSAtMSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHN0YXJ0LAogICAgICAgICAgICBlbmQKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldE9mZnNldHMobm9kZSwgb2Zmc2V0cykgewogICAgICAgICAgdmFyIGRvYyA9IG5vZGUub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudDsKICAgICAgICAgIHZhciB3aW4gPSBkb2MgJiYgZG9jLmRlZmF1bHRWaWV3IHx8IHdpbmRvdzsKICAgICAgICAgIGlmICghd2luLmdldFNlbGVjdGlvbikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbigpOwogICAgICAgICAgdmFyIGxlbmd0aCA9IG5vZGUudGV4dENvbnRlbnQubGVuZ3RoOwogICAgICAgICAgdmFyIHN0YXJ0ID0gTWF0aC5taW4ob2Zmc2V0cy5zdGFydCwgbGVuZ3RoKTsKICAgICAgICAgIHZhciBlbmQgPSBvZmZzZXRzLmVuZCA9PT0gdm9pZCAwID8gc3RhcnQgOiBNYXRoLm1pbihvZmZzZXRzLmVuZCwgbGVuZ3RoKTsKICAgICAgICAgIGlmICghc2VsZWN0aW9uLmV4dGVuZCAmJiBzdGFydCA+IGVuZCkgewogICAgICAgICAgICB2YXIgdGVtcCA9IGVuZDsKICAgICAgICAgICAgZW5kID0gc3RhcnQ7CiAgICAgICAgICAgIHN0YXJ0ID0gdGVtcDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzdGFydE1hcmtlciA9IGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQobm9kZSwgc3RhcnQpOwogICAgICAgICAgdmFyIGVuZE1hcmtlciA9IGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQobm9kZSwgZW5kKTsKICAgICAgICAgIGlmIChzdGFydE1hcmtlciAmJiBlbmRNYXJrZXIpIHsKICAgICAgICAgICAgaWYgKHNlbGVjdGlvbi5yYW5nZUNvdW50ID09PSAxICYmIHNlbGVjdGlvbi5hbmNob3JOb2RlID09PSBzdGFydE1hcmtlci5ub2RlICYmIHNlbGVjdGlvbi5hbmNob3JPZmZzZXQgPT09IHN0YXJ0TWFya2VyLm9mZnNldCAmJiBzZWxlY3Rpb24uZm9jdXNOb2RlID09PSBlbmRNYXJrZXIubm9kZSAmJiBzZWxlY3Rpb24uZm9jdXNPZmZzZXQgPT09IGVuZE1hcmtlci5vZmZzZXQpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJhbmdlNCA9IGRvYy5jcmVhdGVSYW5nZSgpOwogICAgICAgICAgICByYW5nZTQuc2V0U3RhcnQoc3RhcnRNYXJrZXIubm9kZSwgc3RhcnRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcygpOwogICAgICAgICAgICBpZiAoc3RhcnQgPiBlbmQpIHsKICAgICAgICAgICAgICBzZWxlY3Rpb24uYWRkUmFuZ2UocmFuZ2U0KTsKICAgICAgICAgICAgICBzZWxlY3Rpb24uZXh0ZW5kKGVuZE1hcmtlci5ub2RlLCBlbmRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByYW5nZTQuc2V0RW5kKGVuZE1hcmtlci5ub2RlLCBlbmRNYXJrZXIub2Zmc2V0KTsKICAgICAgICAgICAgICBzZWxlY3Rpb24uYWRkUmFuZ2UocmFuZ2U0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1RleHROb2RlKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlICYmIG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29udGFpbnNOb2RlKG91dGVyTm9kZSwgaW5uZXJOb2RlKSB7CiAgICAgICAgICBpZiAoIW91dGVyTm9kZSB8fCAhaW5uZXJOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0gZWxzZSBpZiAob3V0ZXJOb2RlID09PSBpbm5lck5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVGV4dE5vZGUob3V0ZXJOb2RlKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVGV4dE5vZGUoaW5uZXJOb2RlKSkgewogICAgICAgICAgICByZXR1cm4gY29udGFpbnNOb2RlKG91dGVyTm9kZSwgaW5uZXJOb2RlLnBhcmVudE5vZGUpOwogICAgICAgICAgfSBlbHNlIGlmICgiY29udGFpbnMiIGluIG91dGVyTm9kZSkgewogICAgICAgICAgICByZXR1cm4gb3V0ZXJOb2RlLmNvbnRhaW5zKGlubmVyTm9kZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKG91dGVyTm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgewogICAgICAgICAgICByZXR1cm4gISEob3V0ZXJOb2RlLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGlubmVyTm9kZSkgJiAxNik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzSW5Eb2N1bWVudChub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZSAmJiBub2RlLm93bmVyRG9jdW1lbnQgJiYgY29udGFpbnNOb2RlKG5vZGUub3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIG5vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1NhbWVPcmlnaW5GcmFtZShpZnJhbWUpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2YgaWZyYW1lLmNvbnRlbnRXaW5kb3cubG9jYXRpb24uaHJlZiA9PT0gInN0cmluZyI7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRBY3RpdmVFbGVtZW50RGVlcCgpIHsKICAgICAgICAgIHZhciB3aW4gPSB3aW5kb3c7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IGdldEFjdGl2ZUVsZW1lbnQoKTsKICAgICAgICAgIHdoaWxlIChlbGVtZW50IGluc3RhbmNlb2Ygd2luLkhUTUxJRnJhbWVFbGVtZW50KSB7CiAgICAgICAgICAgIGlmIChpc1NhbWVPcmlnaW5GcmFtZShlbGVtZW50KSkgewogICAgICAgICAgICAgIHdpbiA9IGVsZW1lbnQuY29udGVudFdpbmRvdzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50ID0gZ2V0QWN0aXZlRWxlbWVudCh3aW4uZG9jdW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1NlbGVjdGlvbkNhcGFiaWxpdGllcyhlbGVtKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtICYmIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lICYmIChub2RlTmFtZSA9PT0gImlucHV0IiAmJiAoZWxlbS50eXBlID09PSAidGV4dCIgfHwgZWxlbS50eXBlID09PSAic2VhcmNoIiB8fCBlbGVtLnR5cGUgPT09ICJ0ZWwiIHx8IGVsZW0udHlwZSA9PT0gInVybCIgfHwgZWxlbS50eXBlID09PSAicGFzc3dvcmQiKSB8fCBub2RlTmFtZSA9PT0gInRleHRhcmVhIiB8fCBlbGVtLmNvbnRlbnRFZGl0YWJsZSA9PT0gInRydWUiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U2VsZWN0aW9uSW5mb3JtYXRpb24oKSB7CiAgICAgICAgICB2YXIgZm9jdXNlZEVsZW0gPSBnZXRBY3RpdmVFbGVtZW50RGVlcCgpOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZm9jdXNlZEVsZW0sCiAgICAgICAgICAgIHNlbGVjdGlvblJhbmdlOiBoYXNTZWxlY3Rpb25DYXBhYmlsaXRpZXMoZm9jdXNlZEVsZW0pID8gZ2V0U2VsZWN0aW9uKGZvY3VzZWRFbGVtKSA6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTZWxlY3Rpb24ocHJpb3JTZWxlY3Rpb25JbmZvcm1hdGlvbikgewogICAgICAgICAgdmFyIGN1ckZvY3VzZWRFbGVtID0gZ2V0QWN0aXZlRWxlbWVudERlZXAoKTsKICAgICAgICAgIHZhciBwcmlvckZvY3VzZWRFbGVtID0gcHJpb3JTZWxlY3Rpb25JbmZvcm1hdGlvbi5mb2N1c2VkRWxlbTsKICAgICAgICAgIHZhciBwcmlvclNlbGVjdGlvblJhbmdlID0gcHJpb3JTZWxlY3Rpb25JbmZvcm1hdGlvbi5zZWxlY3Rpb25SYW5nZTsKICAgICAgICAgIGlmIChjdXJGb2N1c2VkRWxlbSAhPT0gcHJpb3JGb2N1c2VkRWxlbSAmJiBpc0luRG9jdW1lbnQocHJpb3JGb2N1c2VkRWxlbSkpIHsKICAgICAgICAgICAgaWYgKHByaW9yU2VsZWN0aW9uUmFuZ2UgIT09IG51bGwgJiYgaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKHByaW9yRm9jdXNlZEVsZW0pKSB7CiAgICAgICAgICAgICAgc2V0U2VsZWN0aW9uKHByaW9yRm9jdXNlZEVsZW0sIHByaW9yU2VsZWN0aW9uUmFuZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhbmNlc3RvcnMgPSBbXTsKICAgICAgICAgICAgdmFyIGFuY2VzdG9yID0gcHJpb3JGb2N1c2VkRWxlbTsKICAgICAgICAgICAgd2hpbGUgKGFuY2VzdG9yID0gYW5jZXN0b3IucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgIGlmIChhbmNlc3Rvci5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICBhbmNlc3RvcnMucHVzaCh7CiAgICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGFuY2VzdG9yLAogICAgICAgICAgICAgICAgICBsZWZ0OiBhbmNlc3Rvci5zY3JvbGxMZWZ0LAogICAgICAgICAgICAgICAgICB0b3A6IGFuY2VzdG9yLnNjcm9sbFRvcAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJpb3JGb2N1c2VkRWxlbS5mb2N1cyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHByaW9yRm9jdXNlZEVsZW0uZm9jdXMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFuY2VzdG9ycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBpbmZvID0gYW5jZXN0b3JzW2ldOwogICAgICAgICAgICAgIGluZm8uZWxlbWVudC5zY3JvbGxMZWZ0ID0gaW5mby5sZWZ0OwogICAgICAgICAgICAgIGluZm8uZWxlbWVudC5zY3JvbGxUb3AgPSBpbmZvLnRvcDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTZWxlY3Rpb24oaW5wdXQpIHsKICAgICAgICAgIHZhciBzZWxlY3Rpb247CiAgICAgICAgICBpZiAoInNlbGVjdGlvblN0YXJ0IiBpbiBpbnB1dCkgewogICAgICAgICAgICBzZWxlY3Rpb24gPSB7CiAgICAgICAgICAgICAgc3RhcnQ6IGlucHV0LnNlbGVjdGlvblN0YXJ0LAogICAgICAgICAgICAgIGVuZDogaW5wdXQuc2VsZWN0aW9uRW5kCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZWxlY3Rpb24gPSBnZXRPZmZzZXRzKGlucHV0KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzZWxlY3Rpb24gfHwgewogICAgICAgICAgICBzdGFydDogMCwKICAgICAgICAgICAgZW5kOiAwCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRTZWxlY3Rpb24oaW5wdXQsIG9mZnNldHMpIHsKICAgICAgICAgIHZhciBzdGFydCA9IG9mZnNldHMuc3RhcnQ7CiAgICAgICAgICB2YXIgZW5kID0gb2Zmc2V0cy5lbmQ7CiAgICAgICAgICBpZiAoZW5kID09PSB2b2lkIDApIHsKICAgICAgICAgICAgZW5kID0gc3RhcnQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoInNlbGVjdGlvblN0YXJ0IiBpbiBpbnB1dCkgewogICAgICAgICAgICBpbnB1dC5zZWxlY3Rpb25TdGFydCA9IHN0YXJ0OwogICAgICAgICAgICBpbnB1dC5zZWxlY3Rpb25FbmQgPSBNYXRoLm1pbihlbmQsIGlucHV0LnZhbHVlLmxlbmd0aCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXRPZmZzZXRzKGlucHV0LCBvZmZzZXRzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHNraXBTZWxlY3Rpb25DaGFuZ2VFdmVudCA9IGNhblVzZURPTTIgJiYgImRvY3VtZW50TW9kZSIgaW4gZG9jdW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIDw9IDExOwogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDMoKSB7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uU2VsZWN0IiwgWyJmb2N1c291dCIsICJjb250ZXh0bWVudSIsICJkcmFnZW5kIiwgImZvY3VzaW4iLCAia2V5ZG93biIsICJrZXl1cCIsICJtb3VzZWRvd24iLCAibW91c2V1cCIsICJzZWxlY3Rpb25jaGFuZ2UiXSk7CiAgICAgICAgfQogICAgICAgIHZhciBhY3RpdmVFbGVtZW50JDEgPSBudWxsOwogICAgICAgIHZhciBhY3RpdmVFbGVtZW50SW5zdCQxID0gbnVsbDsKICAgICAgICB2YXIgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgdmFyIG1vdXNlRG93biA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdGlvbiQxKG5vZGUpIHsKICAgICAgICAgIGlmICgic2VsZWN0aW9uU3RhcnQiIGluIG5vZGUgJiYgaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKG5vZGUpKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgc3RhcnQ6IG5vZGUuc2VsZWN0aW9uU3RhcnQsCiAgICAgICAgICAgICAgZW5kOiBub2RlLnNlbGVjdGlvbkVuZAogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHdpbiA9IG5vZGUub3duZXJEb2N1bWVudCAmJiBub2RlLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcgfHwgd2luZG93OwogICAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbigpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGFuY2hvck5vZGU6IHNlbGVjdGlvbi5hbmNob3JOb2RlLAogICAgICAgICAgICAgIGFuY2hvck9mZnNldDogc2VsZWN0aW9uLmFuY2hvck9mZnNldCwKICAgICAgICAgICAgICBmb2N1c05vZGU6IHNlbGVjdGlvbi5mb2N1c05vZGUsCiAgICAgICAgICAgICAgZm9jdXNPZmZzZXQ6IHNlbGVjdGlvbi5mb2N1c09mZnNldAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFRhcmdldERvY3VtZW50KGV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICByZXR1cm4gZXZlbnRUYXJnZXQud2luZG93ID09PSBldmVudFRhcmdldCA/IGV2ZW50VGFyZ2V0LmRvY3VtZW50IDogZXZlbnRUYXJnZXQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyBldmVudFRhcmdldCA6IGV2ZW50VGFyZ2V0Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnN0cnVjdFNlbGVjdEV2ZW50KGRpc3BhdGNoUXVldWUsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGRvYyA9IGdldEV2ZW50VGFyZ2V0RG9jdW1lbnQobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKG1vdXNlRG93biB8fCBhY3RpdmVFbGVtZW50JDEgPT0gbnVsbCB8fCBhY3RpdmVFbGVtZW50JDEgIT09IGdldEFjdGl2ZUVsZW1lbnQoZG9jKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudFNlbGVjdGlvbiA9IGdldFNlbGVjdGlvbiQxKGFjdGl2ZUVsZW1lbnQkMSk7CiAgICAgICAgICBpZiAoIWxhc3RTZWxlY3Rpb24gfHwgIXNoYWxsb3dFcXVhbDIobGFzdFNlbGVjdGlvbiwgY3VycmVudFNlbGVjdGlvbikpIHsKICAgICAgICAgICAgbGFzdFNlbGVjdGlvbiA9IGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBhY2N1bXVsYXRlVHdvUGhhc2VMaXN0ZW5lcnMoYWN0aXZlRWxlbWVudEluc3QkMSwgIm9uU2VsZWN0Iik7CiAgICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHZhciBldmVudCA9IG5ldyBTeW50aGV0aWNFdmVudCgib25TZWxlY3QiLCAic2VsZWN0IiwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBldmVudC50YXJnZXQgPSBhY3RpdmVFbGVtZW50JDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciB0YXJnZXROb2RlID0gdGFyZ2V0SW5zdCA/IGdldE5vZGVGcm9tSW5zdGFuY2UodGFyZ2V0SW5zdCkgOiB3aW5kb3c7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgICBpZiAoaXNUZXh0SW5wdXRFbGVtZW50KHRhcmdldE5vZGUpIHx8IHRhcmdldE5vZGUuY29udGVudEVkaXRhYmxlID09PSAidHJ1ZSIpIHsKICAgICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQkMSA9IHRhcmdldE5vZGU7CiAgICAgICAgICAgICAgICBhY3RpdmVFbGVtZW50SW5zdCQxID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgICAgIGxhc3RTZWxlY3Rpb24gPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnQkMSA9IG51bGw7CiAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QkMSA9IG51bGw7CiAgICAgICAgICAgICAgbGFzdFNlbGVjdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm1vdXNlZG93biI6CiAgICAgICAgICAgICAgbW91c2VEb3duID0gdHJ1ZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiY29udGV4dG1lbnUiOgogICAgICAgICAgICBjYXNlICJtb3VzZXVwIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VuZCI6CiAgICAgICAgICAgICAgbW91c2VEb3duID0gZmFsc2U7CiAgICAgICAgICAgICAgY29uc3RydWN0U2VsZWN0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0aW9uY2hhbmdlIjoKICAgICAgICAgICAgICBpZiAoc2tpcFNlbGVjdGlvbkNoYW5nZUV2ZW50KSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImtleWRvd24iOgogICAgICAgICAgICBjYXNlICJrZXl1cCI6CiAgICAgICAgICAgICAgY29uc3RydWN0U2VsZWN0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFrZVByZWZpeE1hcChzdHlsZVByb3AsIGV2ZW50TmFtZSkgewogICAgICAgICAgdmFyIHByZWZpeGVzMyA9IHt9OwogICAgICAgICAgcHJlZml4ZXMzW3N0eWxlUHJvcC50b0xvd2VyQ2FzZSgpXSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcHJlZml4ZXMzWyJXZWJraXQiICsgc3R5bGVQcm9wXSA9ICJ3ZWJraXQiICsgZXZlbnROYW1lOwogICAgICAgICAgcHJlZml4ZXMzWyJNb3oiICsgc3R5bGVQcm9wXSA9ICJtb3oiICsgZXZlbnROYW1lOwogICAgICAgICAgcmV0dXJuIHByZWZpeGVzMzsKICAgICAgICB9CiAgICAgICAgdmFyIHZlbmRvclByZWZpeGVzID0gewogICAgICAgICAgYW5pbWF0aW9uZW5kOiBtYWtlUHJlZml4TWFwKCJBbmltYXRpb24iLCAiQW5pbWF0aW9uRW5kIiksCiAgICAgICAgICBhbmltYXRpb25pdGVyYXRpb246IG1ha2VQcmVmaXhNYXAoIkFuaW1hdGlvbiIsICJBbmltYXRpb25JdGVyYXRpb24iKSwKICAgICAgICAgIGFuaW1hdGlvbnN0YXJ0OiBtYWtlUHJlZml4TWFwKCJBbmltYXRpb24iLCAiQW5pbWF0aW9uU3RhcnQiKSwKICAgICAgICAgIHRyYW5zaXRpb25lbmQ6IG1ha2VQcmVmaXhNYXAoIlRyYW5zaXRpb24iLCAiVHJhbnNpdGlvbkVuZCIpCiAgICAgICAgfTsKICAgICAgICB2YXIgcHJlZml4ZWRFdmVudE5hbWVzID0ge307CiAgICAgICAgdmFyIHN0eWxlID0ge307CiAgICAgICAgaWYgKGNhblVzZURPTTIpIHsKICAgICAgICAgIHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iikuc3R5bGU7CiAgICAgICAgICBpZiAoISgiQW5pbWF0aW9uRXZlbnQiIGluIHdpbmRvdykpIHsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLmFuaW1hdGlvbmVuZC5hbmltYXRpb247CiAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy5hbmltYXRpb25pdGVyYXRpb24uYW5pbWF0aW9uOwogICAgICAgICAgICBkZWxldGUgdmVuZG9yUHJlZml4ZXMuYW5pbWF0aW9uc3RhcnQuYW5pbWF0aW9uOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCEoIlRyYW5zaXRpb25FdmVudCIgaW4gd2luZG93KSkgewogICAgICAgICAgICBkZWxldGUgdmVuZG9yUHJlZml4ZXMudHJhbnNpdGlvbmVuZC50cmFuc2l0aW9uOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZShldmVudE5hbWUpIHsKICAgICAgICAgIGlmIChwcmVmaXhlZEV2ZW50TmFtZXNbZXZlbnROYW1lXSkgewogICAgICAgICAgICByZXR1cm4gcHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV07CiAgICAgICAgICB9IGVsc2UgaWYgKCF2ZW5kb3JQcmVmaXhlc1tldmVudE5hbWVdKSB7CiAgICAgICAgICAgIHJldHVybiBldmVudE5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJlZml4TWFwID0gdmVuZG9yUHJlZml4ZXNbZXZlbnROYW1lXTsKICAgICAgICAgIGZvciAodmFyIHN0eWxlUHJvcCBpbiBwcmVmaXhNYXApIHsKICAgICAgICAgICAgaWYgKHByZWZpeE1hcC5oYXNPd25Qcm9wZXJ0eShzdHlsZVByb3ApICYmIHN0eWxlUHJvcCBpbiBzdHlsZSkgewogICAgICAgICAgICAgIHJldHVybiBwcmVmaXhlZEV2ZW50TmFtZXNbZXZlbnROYW1lXSA9IHByZWZpeE1hcFtzdHlsZVByb3BdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXZlbnROYW1lOwogICAgICAgIH0KICAgICAgICB2YXIgQU5JTUFUSU9OX0VORCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJhbmltYXRpb25lbmQiKTsKICAgICAgICB2YXIgQU5JTUFUSU9OX0lURVJBVElPTiA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJhbmltYXRpb25pdGVyYXRpb24iKTsKICAgICAgICB2YXIgQU5JTUFUSU9OX1NUQVJUID0gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoImFuaW1hdGlvbnN0YXJ0Iik7CiAgICAgICAgdmFyIFRSQU5TSVRJT05fRU5EID0gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoInRyYW5zaXRpb25lbmQiKTsKICAgICAgICB2YXIgdG9wTGV2ZWxFdmVudHNUb1JlYWN0TmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHZhciBzaW1wbGVFdmVudFBsdWdpbkV2ZW50cyA9IFsiYWJvcnQiLCAiYXV4Q2xpY2siLCAiY2FuY2VsIiwgImNhblBsYXkiLCAiY2FuUGxheVRocm91Z2giLCAiY2xpY2siLCAiY2xvc2UiLCAiY29udGV4dE1lbnUiLCAiY29weSIsICJjdXQiLCAiZHJhZyIsICJkcmFnRW5kIiwgImRyYWdFbnRlciIsICJkcmFnRXhpdCIsICJkcmFnTGVhdmUiLCAiZHJhZ092ZXIiLCAiZHJhZ1N0YXJ0IiwgImRyb3AiLCAiZHVyYXRpb25DaGFuZ2UiLCAiZW1wdGllZCIsICJlbmNyeXB0ZWQiLCAiZW5kZWQiLCAiZXJyb3IiLCAiZ290UG9pbnRlckNhcHR1cmUiLCAiaW5wdXQiLCAiaW52YWxpZCIsICJrZXlEb3duIiwgImtleVByZXNzIiwgImtleVVwIiwgImxvYWQiLCAibG9hZGVkRGF0YSIsICJsb2FkZWRNZXRhZGF0YSIsICJsb2FkU3RhcnQiLCAibG9zdFBvaW50ZXJDYXB0dXJlIiwgIm1vdXNlRG93biIsICJtb3VzZU1vdmUiLCAibW91c2VPdXQiLCAibW91c2VPdmVyIiwgIm1vdXNlVXAiLCAicGFzdGUiLCAicGF1c2UiLCAicGxheSIsICJwbGF5aW5nIiwgInBvaW50ZXJDYW5jZWwiLCAicG9pbnRlckRvd24iLCAicG9pbnRlck1vdmUiLCAicG9pbnRlck91dCIsICJwb2ludGVyT3ZlciIsICJwb2ludGVyVXAiLCAicHJvZ3Jlc3MiLCAicmF0ZUNoYW5nZSIsICJyZXNldCIsICJyZXNpemUiLCAic2Vla2VkIiwgInNlZWtpbmciLCAic3RhbGxlZCIsICJzdWJtaXQiLCAic3VzcGVuZCIsICJ0aW1lVXBkYXRlIiwgInRvdWNoQ2FuY2VsIiwgInRvdWNoRW5kIiwgInRvdWNoU3RhcnQiLCAidm9sdW1lQ2hhbmdlIiwgInNjcm9sbCIsICJ0b2dnbGUiLCAidG91Y2hNb3ZlIiwgIndhaXRpbmciLCAid2hlZWwiXTsKICAgICAgICBmdW5jdGlvbiByZWdpc3RlclNpbXBsZUV2ZW50KGRvbUV2ZW50TmFtZSwgcmVhY3ROYW1lKSB7CiAgICAgICAgICB0b3BMZXZlbEV2ZW50c1RvUmVhY3ROYW1lcy5zZXQoZG9tRXZlbnROYW1lLCByZWFjdE5hbWUpOwogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KHJlYWN0TmFtZSwgW2RvbUV2ZW50TmFtZV0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlclNpbXBsZUV2ZW50cygpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2ltcGxlRXZlbnRQbHVnaW5FdmVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIGV2ZW50TmFtZSA9IHNpbXBsZUV2ZW50UGx1Z2luRXZlbnRzW2ldOwogICAgICAgICAgICB2YXIgZG9tRXZlbnROYW1lID0gZXZlbnROYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHZhciBjYXBpdGFsaXplZEV2ZW50ID0gZXZlbnROYW1lWzBdLnRvVXBwZXJDYXNlKCkgKyBldmVudE5hbWUuc2xpY2UoMSk7CiAgICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoZG9tRXZlbnROYW1lLCAib24iICsgY2FwaXRhbGl6ZWRFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KEFOSU1BVElPTl9FTkQsICJvbkFuaW1hdGlvbkVuZCIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChBTklNQVRJT05fSVRFUkFUSU9OLCAib25BbmltYXRpb25JdGVyYXRpb24iKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoQU5JTUFUSU9OX1NUQVJULCAib25BbmltYXRpb25TdGFydCIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudCgiZGJsY2xpY2siLCAib25Eb3VibGVDbGljayIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudCgiZm9jdXNpbiIsICJvbkZvY3VzIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KCJmb2N1c291dCIsICJvbkJsdXIiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoVFJBTlNJVElPTl9FTkQsICJvblRyYW5zaXRpb25FbmQiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQ0KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciByZWFjdE5hbWUgPSB0b3BMZXZlbEV2ZW50c1RvUmVhY3ROYW1lcy5nZXQoZG9tRXZlbnROYW1lKTsKICAgICAgICAgIGlmIChyZWFjdE5hbWUgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRXZlbnQ7CiAgICAgICAgICB2YXIgcmVhY3RFdmVudFR5cGUgPSBkb21FdmVudE5hbWU7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJrZXlwcmVzcyI6CiAgICAgICAgICAgICAgaWYgKGdldEV2ZW50Q2hhckNvZGUobmF0aXZlRXZlbnQpID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgY2FzZSAia2V5dXAiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0tleWJvYXJkRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICAgIHJlYWN0RXZlbnRUeXBlID0gImZvY3VzIjsKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNGb2N1c0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcmVhY3RFdmVudFR5cGUgPSAiYmx1ciI7CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRm9jdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiYmVmb3JlYmx1ciI6CiAgICAgICAgICAgIGNhc2UgImFmdGVyYmx1ciI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRm9jdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiY2xpY2siOgogICAgICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5idXR0b24gPT09IDIpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgImF1eGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAiZGJsY2xpY2siOgogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICBjYXNlICJtb3VzZW1vdmUiOgogICAgICAgICAgICBjYXNlICJtb3VzZXVwIjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdXQiOgogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOgogICAgICAgICAgICBjYXNlICJjb250ZXh0bWVudSI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljTW91c2VFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZHJhZyI6CiAgICAgICAgICAgIGNhc2UgImRyYWdlbmQiOgogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOgogICAgICAgICAgICBjYXNlICJkcmFnZXhpdCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdsZWF2ZSI6CiAgICAgICAgICAgIGNhc2UgImRyYWdvdmVyIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ3N0YXJ0IjoKICAgICAgICAgICAgY2FzZSAiZHJvcCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRHJhZ0V2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0b3VjaGNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoZW5kIjoKICAgICAgICAgICAgY2FzZSAidG91Y2htb3ZlIjoKICAgICAgICAgICAgY2FzZSAidG91Y2hzdGFydCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljVG91Y2hFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fRU5EOgogICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9JVEVSQVRJT046CiAgICAgICAgICAgIGNhc2UgQU5JTUFUSU9OX1NUQVJUOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0FuaW1hdGlvbkV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFRSQU5TSVRJT05fRU5EOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1RyYW5zaXRpb25FdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2Nyb2xsIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNVSUV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ3aGVlbCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljV2hlZWxFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiY29weSI6CiAgICAgICAgICAgIGNhc2UgImN1dCI6CiAgICAgICAgICAgIGNhc2UgInBhc3RlIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNDbGlwYm9hcmRFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZ290cG9pbnRlcmNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJsb3N0cG9pbnRlcmNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmRvd24iOgogICAgICAgICAgICBjYXNlICJwb2ludGVybW92ZSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdXQiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJ1cCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljUG9pbnRlckV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluQ2FwdHVyZVBoYXNlID0gKGV2ZW50U3lzdGVtRmxhZ3MgJiBJU19DQVBUVVJFX1BIQVNFKSAhPT0gMDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGFjY3VtdWxhdGVUYXJnZXRPbmx5ID0gIWluQ2FwdHVyZVBoYXNlICYmIC8vIFRPRE86IGlkZWFsbHksIHdlJ2QgZXZlbnR1YWxseSBhZGQgYWxsIGV2ZW50cyBmcm9tCiAgICAgICAgICAgIC8vIG5vbkRlbGVnYXRlZEV2ZW50cyBsaXN0IGluIERPTVBsdWdpbkV2ZW50U3lzdGVtLgogICAgICAgICAgICAvLyBUaGVuIHdlIGNhbiByZW1vdmUgdGhpcyBzcGVjaWFsIGxpc3QuCiAgICAgICAgICAgIC8vIFRoaXMgaXMgYSBicmVha2luZyBjaGFuZ2UgdGhhdCBjYW4gd2FpdCB1bnRpbCBSZWFjdCAxOC4KICAgICAgICAgICAgZG9tRXZlbnROYW1lID09PSAic2Nyb2xsIjsKICAgICAgICAgICAgdmFyIF9saXN0ZW5lcnMgPSBhY2N1bXVsYXRlU2luZ2xlUGhhc2VMaXN0ZW5lcnModGFyZ2V0SW5zdCwgcmVhY3ROYW1lLCBuYXRpdmVFdmVudC50eXBlLCBpbkNhcHR1cmVQaGFzZSwgYWNjdW11bGF0ZVRhcmdldE9ubHkpOwogICAgICAgICAgICBpZiAoX2xpc3RlbmVycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9ldmVudCA9IG5ldyBTeW50aGV0aWNFdmVudEN0b3IocmVhY3ROYW1lLCByZWFjdEV2ZW50VHlwZSwgbnVsbCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgICAgZXZlbnQ6IF9ldmVudCwKICAgICAgICAgICAgICAgIGxpc3RlbmVyczogX2xpc3RlbmVycwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnRzKCk7CiAgICAgICAgcmVnaXN0ZXJFdmVudHMkMigpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzJDEoKTsKICAgICAgICByZWdpc3RlckV2ZW50cyQzKCk7CiAgICAgICAgcmVnaXN0ZXJFdmVudHMoKTsKICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzJDUoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgZXh0cmFjdEV2ZW50cyQ0KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzKTsKICAgICAgICAgIHZhciBzaG91bGRQcm9jZXNzUG9seWZpbGxQbHVnaW5zID0gKGV2ZW50U3lzdGVtRmxhZ3MgJiBTSE9VTERfTk9UX1BST0NFU1NfUE9MWUZJTExfRVZFTlRfUExVR0lOUykgPT09IDA7CiAgICAgICAgICBpZiAoc2hvdWxkUHJvY2Vzc1BvbHlmaWxsUGx1Z2lucykgewogICAgICAgICAgICBleHRyYWN0RXZlbnRzJDIoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBleHRyYWN0RXZlbnRzJDEoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBleHRyYWN0RXZlbnRzJDMoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBleHRyYWN0RXZlbnRzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG1lZGlhRXZlbnRUeXBlcyA9IFsiYWJvcnQiLCAiY2FucGxheSIsICJjYW5wbGF5dGhyb3VnaCIsICJkdXJhdGlvbmNoYW5nZSIsICJlbXB0aWVkIiwgImVuY3J5cHRlZCIsICJlbmRlZCIsICJlcnJvciIsICJsb2FkZWRkYXRhIiwgImxvYWRlZG1ldGFkYXRhIiwgImxvYWRzdGFydCIsICJwYXVzZSIsICJwbGF5IiwgInBsYXlpbmciLCAicHJvZ3Jlc3MiLCAicmF0ZWNoYW5nZSIsICJyZXNpemUiLCAic2Vla2VkIiwgInNlZWtpbmciLCAic3RhbGxlZCIsICJzdXNwZW5kIiwgInRpbWV1cGRhdGUiLCAidm9sdW1lY2hhbmdlIiwgIndhaXRpbmciXTsKICAgICAgICB2YXIgbm9uRGVsZWdhdGVkRXZlbnRzID0gbmV3IFNldChbImNhbmNlbCIsICJjbG9zZSIsICJpbnZhbGlkIiwgImxvYWQiLCAic2Nyb2xsIiwgInRvZ2dsZSJdLmNvbmNhdChtZWRpYUV2ZW50VHlwZXMpKTsKICAgICAgICBmdW5jdGlvbiBleGVjdXRlRGlzcGF0Y2goZXZlbnQsIGxpc3RlbmVyMiwgY3VycmVudFRhcmdldCkgewogICAgICAgICAgdmFyIHR5cGUgPSBldmVudC50eXBlIHx8ICJ1bmtub3duLWV2ZW50IjsKICAgICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBjdXJyZW50VGFyZ2V0OwogICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKHR5cGUsIGxpc3RlbmVyMiwgdm9pZCAwLCBldmVudCk7CiAgICAgICAgICBldmVudC5jdXJyZW50VGFyZ2V0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc0Rpc3BhdGNoUXVldWVJdGVtc0luT3JkZXIoZXZlbnQsIGRpc3BhdGNoTGlzdGVuZXJzLCBpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgdmFyIHByZXZpb3VzSW5zdGFuY2U7CiAgICAgICAgICBpZiAoaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IGRpc3BhdGNoTGlzdGVuZXJzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgICAgICAgICAgdmFyIF9kaXNwYXRjaExpc3RlbmVycyRpID0gZGlzcGF0Y2hMaXN0ZW5lcnNbaV0sIGluc3RhbmNlID0gX2Rpc3BhdGNoTGlzdGVuZXJzJGkuaW5zdGFuY2UsIGN1cnJlbnRUYXJnZXQgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkaS5jdXJyZW50VGFyZ2V0LCBsaXN0ZW5lcjIgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkaS5saXN0ZW5lcjsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IHByZXZpb3VzSW5zdGFuY2UgJiYgZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBleGVjdXRlRGlzcGF0Y2goZXZlbnQsIGxpc3RlbmVyMiwgY3VycmVudFRhcmdldCk7CiAgICAgICAgICAgICAgcHJldmlvdXNJbnN0YW5jZSA9IGluc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgZGlzcGF0Y2hMaXN0ZW5lcnMubGVuZ3RoOyBfaSsrKSB7CiAgICAgICAgICAgICAgdmFyIF9kaXNwYXRjaExpc3RlbmVycyRfaSA9IGRpc3BhdGNoTGlzdGVuZXJzW19pXSwgX2luc3RhbmNlID0gX2Rpc3BhdGNoTGlzdGVuZXJzJF9pLmluc3RhbmNlLCBfY3VycmVudFRhcmdldCA9IF9kaXNwYXRjaExpc3RlbmVycyRfaS5jdXJyZW50VGFyZ2V0LCBfbGlzdGVuZXIgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkX2kubGlzdGVuZXI7CiAgICAgICAgICAgICAgaWYgKF9pbnN0YW5jZSAhPT0gcHJldmlvdXNJbnN0YW5jZSAmJiBldmVudC5pc1Byb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV4ZWN1dGVEaXNwYXRjaChldmVudCwgX2xpc3RlbmVyLCBfY3VycmVudFRhcmdldCk7CiAgICAgICAgICAgICAgcHJldmlvdXNJbnN0YW5jZSA9IF9pbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzRGlzcGF0Y2hRdWV1ZShkaXNwYXRjaFF1ZXVlLCBldmVudFN5c3RlbUZsYWdzKSB7CiAgICAgICAgICB2YXIgaW5DYXB0dXJlUGhhc2UgPSAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0NBUFRVUkVfUEhBU0UpICE9PSAwOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXNwYXRjaFF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBfZGlzcGF0Y2hRdWV1ZSRpID0gZGlzcGF0Y2hRdWV1ZVtpXSwgZXZlbnQgPSBfZGlzcGF0Y2hRdWV1ZSRpLmV2ZW50LCBsaXN0ZW5lcnMgPSBfZGlzcGF0Y2hRdWV1ZSRpLmxpc3RlbmVyczsKICAgICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWVJdGVtc0luT3JkZXIoZXZlbnQsIGxpc3RlbmVycywgaW5DYXB0dXJlUGhhc2UpOwogICAgICAgICAgfQogICAgICAgICAgcmV0aHJvd0NhdWdodEVycm9yKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRzRm9yUGx1Z2lucyhkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCB0YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBuYXRpdmVFdmVudFRhcmdldCA9IGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIHZhciBkaXNwYXRjaFF1ZXVlID0gW107CiAgICAgICAgICBleHRyYWN0RXZlbnRzJDUoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgICAgcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoZG9tRXZlbnROYW1lLCB0YXJnZXRFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghbm9uRGVsZWdhdGVkRXZlbnRzLmhhcyhkb21FdmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ0RpZCBub3QgZXhwZWN0IGEgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgpIGNhbGwgZm9yICIlcyIuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLicsIGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyID0gZmFsc2U7CiAgICAgICAgICB2YXIgbGlzdGVuZXJTZXQgPSBnZXRFdmVudExpc3RlbmVyU2V0KHRhcmdldEVsZW1lbnQpOwogICAgICAgICAgdmFyIGxpc3RlbmVyU2V0S2V5ID0gZ2V0TGlzdGVuZXJTZXRLZXkoZG9tRXZlbnROYW1lLCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKTsKICAgICAgICAgIGlmICghbGlzdGVuZXJTZXQuaGFzKGxpc3RlbmVyU2V0S2V5KSkgewogICAgICAgICAgICBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXRFbGVtZW50LCBkb21FdmVudE5hbWUsIElTX05PTl9ERUxFR0FURUQsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpOwogICAgICAgICAgICBsaXN0ZW5lclNldC5hZGQobGlzdGVuZXJTZXRLZXkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lciwgdGFyZ2V0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChub25EZWxlZ2F0ZWRFdmVudHMuaGFzKGRvbUV2ZW50TmFtZSkgJiYgIWlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgICBlcnJvcignRGlkIG5vdCBleHBlY3QgYSBsaXN0ZW5Ub05hdGl2ZUV2ZW50KCkgY2FsbCBmb3IgIiVzIiBpbiB0aGUgYnViYmxlIHBoYXNlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4nLCBkb21FdmVudE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRTeXN0ZW1GbGFncyA9IDA7CiAgICAgICAgICBpZiAoaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcikgewogICAgICAgICAgICBldmVudFN5c3RlbUZsYWdzIHw9IElTX0NBUFRVUkVfUEhBU0U7CiAgICAgICAgICB9CiAgICAgICAgICBhZGRUcmFwcGVkRXZlbnRMaXN0ZW5lcih0YXJnZXQsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcik7CiAgICAgICAgfQogICAgICAgIHZhciBsaXN0ZW5pbmdNYXJrZXIgPSAiX3JlYWN0TGlzdGVuaW5nIiArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpOwogICAgICAgIGZ1bmN0aW9uIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICBpZiAoIXJvb3RDb250YWluZXJFbGVtZW50W2xpc3RlbmluZ01hcmtlcl0pIHsKICAgICAgICAgICAgcm9vdENvbnRhaW5lckVsZW1lbnRbbGlzdGVuaW5nTWFya2VyXSA9IHRydWU7CiAgICAgICAgICAgIGFsbE5hdGl2ZUV2ZW50cy5mb3JFYWNoKGZ1bmN0aW9uKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgIT09ICJzZWxlY3Rpb25jaGFuZ2UiKSB7CiAgICAgICAgICAgICAgICBpZiAoIW5vbkRlbGVnYXRlZEV2ZW50cy5oYXMoZG9tRXZlbnROYW1lKSkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgZmFsc2UsIHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxpc3RlblRvTmF0aXZlRXZlbnQoZG9tRXZlbnROYW1lLCB0cnVlLCByb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdmFyIG93bmVyRG9jdW1lbnQgPSByb290Q29udGFpbmVyRWxlbWVudC5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/IHJvb3RDb250YWluZXJFbGVtZW50IDogcm9vdENvbnRhaW5lckVsZW1lbnQub3duZXJEb2N1bWVudDsKICAgICAgICAgICAgaWYgKG93bmVyRG9jdW1lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoIW93bmVyRG9jdW1lbnRbbGlzdGVuaW5nTWFya2VyXSkgewogICAgICAgICAgICAgICAgb3duZXJEb2N1bWVudFtsaXN0ZW5pbmdNYXJrZXJdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGxpc3RlblRvTmF0aXZlRXZlbnQoInNlbGVjdGlvbmNoYW5nZSIsIGZhbHNlLCBvd25lckRvY3VtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkVHJhcHBlZEV2ZW50TGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIsIGlzRGVmZXJyZWRMaXN0ZW5lckZvckxlZ2FjeUZCU3VwcG9ydCkgewogICAgICAgICAgdmFyIGxpc3RlbmVyMiA9IGNyZWF0ZUV2ZW50TGlzdGVuZXJXcmFwcGVyV2l0aFByaW9yaXR5KHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzKTsKICAgICAgICAgIHZhciBpc1Bhc3NpdmVMaXN0ZW5lciA9IHZvaWQgMDsKICAgICAgICAgIGlmIChwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCkgewogICAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAidG91Y2hzdGFydCIgfHwgZG9tRXZlbnROYW1lID09PSAidG91Y2htb3ZlIiB8fCBkb21FdmVudE5hbWUgPT09ICJ3aGVlbCIpIHsKICAgICAgICAgICAgICBpc1Bhc3NpdmVMaXN0ZW5lciA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRhcmdldENvbnRhaW5lciA9IHRhcmdldENvbnRhaW5lcjsKICAgICAgICAgIHZhciB1bnN1YnNjcmliZUxpc3RlbmVyOwogICAgICAgICAgaWYgKGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgaWYgKGlzUGFzc2l2ZUxpc3RlbmVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyMiwgaXNQYXNzaXZlTGlzdGVuZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVuc3Vic2NyaWJlTGlzdGVuZXIgPSBhZGRFdmVudENhcHR1cmVMaXN0ZW5lcih0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGlzUGFzc2l2ZUxpc3RlbmVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcldpdGhQYXNzaXZlRmxhZyh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgbGlzdGVuZXIyLCBpc1Bhc3NpdmVMaXN0ZW5lcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdW5zdWJzY3JpYmVMaXN0ZW5lciA9IGFkZEV2ZW50QnViYmxlTGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNNYXRjaGluZ1Jvb3RDb250YWluZXIoZ3JhbmRDb250YWluZXIsIHRhcmdldENvbnRhaW5lcikgewogICAgICAgICAgcmV0dXJuIGdyYW5kQ29udGFpbmVyID09PSB0YXJnZXRDb250YWluZXIgfHwgZ3JhbmRDb250YWluZXIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSAmJiBncmFuZENvbnRhaW5lci5wYXJlbnROb2RlID09PSB0YXJnZXRDb250YWluZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCB0YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBhbmNlc3Rvckluc3QgPSB0YXJnZXRJbnN0OwogICAgICAgICAgaWYgKChldmVudFN5c3RlbUZsYWdzICYgSVNfRVZFTlRfSEFORExFX05PTl9NQU5BR0VEX05PREUpID09PSAwICYmIChldmVudFN5c3RlbUZsYWdzICYgSVNfTk9OX0RFTEVHQVRFRCkgPT09IDApIHsKICAgICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lck5vZGUgPSB0YXJnZXRDb250YWluZXI7CiAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICAgIG1haW5Mb29wOiB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG5vZGVUYWcgPSBub2RlLnRhZzsKICAgICAgICAgICAgICAgIGlmIChub2RlVGFnID09PSBIb3N0Um9vdCB8fCBub2RlVGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gbm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdSb290Q29udGFpbmVyKGNvbnRhaW5lcjIsIHRhcmdldENvbnRhaW5lck5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKG5vZGVUYWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZ3JhbmROb2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGdyYW5kTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGdyYW5kVGFnID0gZ3JhbmROb2RlLnRhZzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChncmFuZFRhZyA9PT0gSG9zdFJvb3QgfHwgZ3JhbmRUYWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdyYW5kQ29udGFpbmVyID0gZ3JhbmROb2RlLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNNYXRjaGluZ1Jvb3RDb250YWluZXIoZ3JhbmRDb250YWluZXIsIHRhcmdldENvbnRhaW5lck5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBncmFuZE5vZGUgPSBncmFuZE5vZGUucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB3aGlsZSAoY29udGFpbmVyMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUoY29udGFpbmVyMik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFRhZyA9IHBhcmVudE5vZGUudGFnOwogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRUYWcgPT09IEhvc3RDb21wb25lbnQgfHwgcGFyZW50VGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgICAgICAgbm9kZSA9IGFuY2VzdG9ySW5zdCA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSBtYWluTG9vcDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyMiA9IGNvbnRhaW5lcjIucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgYmF0Y2hlZFVwZGF0ZXMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBkaXNwYXRjaEV2ZW50c0ZvclBsdWdpbnMoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgYW5jZXN0b3JJbnN0KTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBsaXN0ZW5lcjIsIGN1cnJlbnRUYXJnZXQpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICBsaXN0ZW5lcjogbGlzdGVuZXIyLAogICAgICAgICAgICBjdXJyZW50VGFyZ2V0CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlU2luZ2xlUGhhc2VMaXN0ZW5lcnModGFyZ2V0RmliZXIsIHJlYWN0TmFtZSwgbmF0aXZlRXZlbnRUeXBlLCBpbkNhcHR1cmVQaGFzZSwgYWNjdW11bGF0ZVRhcmdldE9ubHksIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgY2FwdHVyZU5hbWUgPSByZWFjdE5hbWUgIT09IG51bGwgPyByZWFjdE5hbWUgKyAiQ2FwdHVyZSIgOiBudWxsOwogICAgICAgICAgdmFyIHJlYWN0RXZlbnROYW1lID0gaW5DYXB0dXJlUGhhc2UgPyBjYXB0dXJlTmFtZSA6IHJlYWN0TmFtZTsKICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHRhcmdldEZpYmVyOwogICAgICAgICAgdmFyIGxhc3RIb3N0Q29tcG9uZW50ID0gbnVsbDsKICAgICAgICAgIHdoaWxlIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgX2luc3RhbmNlMiA9IGluc3RhbmNlLCBzdGF0ZU5vZGUgPSBfaW5zdGFuY2UyLnN0YXRlTm9kZSwgdGFnID0gX2luc3RhbmNlMi50YWc7CiAgICAgICAgICAgIGlmICh0YWcgPT09IEhvc3RDb21wb25lbnQgJiYgc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbGFzdEhvc3RDb21wb25lbnQgPSBzdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHJlYWN0RXZlbnROYW1lICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXIyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlYWN0RXZlbnROYW1lKTsKICAgICAgICAgICAgICAgIGlmIChsaXN0ZW5lcjIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBsaXN0ZW5lcjIsIGxhc3RIb3N0Q29tcG9uZW50KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhY2N1bXVsYXRlVGFyZ2V0T25seSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2UucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZVR3b1BoYXNlTGlzdGVuZXJzKHRhcmdldEZpYmVyLCByZWFjdE5hbWUpIHsKICAgICAgICAgIHZhciBjYXB0dXJlTmFtZSA9IHJlYWN0TmFtZSArICJDYXB0dXJlIjsKICAgICAgICAgIHZhciBsaXN0ZW5lcnMgPSBbXTsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHRhcmdldEZpYmVyOwogICAgICAgICAgd2hpbGUgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBfaW5zdGFuY2UzID0gaW5zdGFuY2UsIHN0YXRlTm9kZSA9IF9pbnN0YW5jZTMuc3RhdGVOb2RlLCB0YWcgPSBfaW5zdGFuY2UzLnRhZzsKICAgICAgICAgICAgaWYgKHRhZyA9PT0gSG9zdENvbXBvbmVudCAmJiBzdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudFRhcmdldCA9IHN0YXRlTm9kZTsKICAgICAgICAgICAgICB2YXIgY2FwdHVyZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIGNhcHR1cmVOYW1lKTsKICAgICAgICAgICAgICBpZiAoY2FwdHVyZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVycy51bnNoaWZ0KGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGNhcHR1cmVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgYnViYmxlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVhY3ROYW1lKTsKICAgICAgICAgICAgICBpZiAoYnViYmxlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgbGlzdGVuZXJzLnB1c2goY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgYnViYmxlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZS5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQYXJlbnQoaW5zdCkgewogICAgICAgICAgaWYgKGluc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGluc3QgPSBpbnN0LnJldHVybjsKICAgICAgICAgIH0gd2hpbGUgKGluc3QgJiYgaW5zdC50YWcgIT09IEhvc3RDb21wb25lbnQpOwogICAgICAgICAgaWYgKGluc3QpIHsKICAgICAgICAgICAgcmV0dXJuIGluc3Q7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TG93ZXN0Q29tbW9uQW5jZXN0b3IoaW5zdEEsIGluc3RCKSB7CiAgICAgICAgICB2YXIgbm9kZUEgPSBpbnN0QTsKICAgICAgICAgIHZhciBub2RlQiA9IGluc3RCOwogICAgICAgICAgdmFyIGRlcHRoQSA9IDA7CiAgICAgICAgICBmb3IgKHZhciB0ZW1wQSA9IG5vZGVBOyB0ZW1wQTsgdGVtcEEgPSBnZXRQYXJlbnQodGVtcEEpKSB7CiAgICAgICAgICAgIGRlcHRoQSsrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRlcHRoQiA9IDA7CiAgICAgICAgICBmb3IgKHZhciB0ZW1wQiA9IG5vZGVCOyB0ZW1wQjsgdGVtcEIgPSBnZXRQYXJlbnQodGVtcEIpKSB7CiAgICAgICAgICAgIGRlcHRoQisrOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGRlcHRoQSAtIGRlcHRoQiA+IDApIHsKICAgICAgICAgICAgbm9kZUEgPSBnZXRQYXJlbnQobm9kZUEpOwogICAgICAgICAgICBkZXB0aEEtLTsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChkZXB0aEIgLSBkZXB0aEEgPiAwKSB7CiAgICAgICAgICAgIG5vZGVCID0gZ2V0UGFyZW50KG5vZGVCKTsKICAgICAgICAgICAgZGVwdGhCLS07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZGVwdGggPSBkZXB0aEE7CiAgICAgICAgICB3aGlsZSAoZGVwdGgtLSkgewogICAgICAgICAgICBpZiAobm9kZUEgPT09IG5vZGVCIHx8IG5vZGVCICE9PSBudWxsICYmIG5vZGVBID09PSBub2RlQi5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICByZXR1cm4gbm9kZUE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZUEgPSBnZXRQYXJlbnQobm9kZUEpOwogICAgICAgICAgICBub2RlQiA9IGdldFBhcmVudChub2RlQik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZUVudGVyTGVhdmVMaXN0ZW5lcnNGb3JFdmVudChkaXNwYXRjaFF1ZXVlLCBldmVudCwgdGFyZ2V0LCBjb21tb24sIGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZSA9IGV2ZW50Ll9yZWFjdE5hbWU7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXQ7CiAgICAgICAgICB3aGlsZSAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGluc3RhbmNlID09PSBjb21tb24pIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX2luc3RhbmNlNCA9IGluc3RhbmNlLCBhbHRlcm5hdGUgPSBfaW5zdGFuY2U0LmFsdGVybmF0ZSwgc3RhdGVOb2RlID0gX2luc3RhbmNlNC5zdGF0ZU5vZGUsIHRhZyA9IF9pbnN0YW5jZTQudGFnOwogICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsICYmIGFsdGVybmF0ZSA9PT0gY29tbW9uKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gSG9zdENvbXBvbmVudCAmJiBzdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudFRhcmdldCA9IHN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgICAgICAgIHZhciBjYXB0dXJlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoY2FwdHVyZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnVuc2hpZnQoY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgY2FwdHVyZUxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgICAgICAgIHZhciBidWJibGVMaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3RhbmNlLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgICAgIGlmIChidWJibGVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGJ1YmJsZUxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2UucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGxpc3RlbmVycy5sZW5ndGggIT09IDApIHsKICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICBldmVudCwKICAgICAgICAgICAgICBsaXN0ZW5lcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVFbnRlckxlYXZlVHdvUGhhc2VMaXN0ZW5lcnMoZGlzcGF0Y2hRdWV1ZSwgbGVhdmVFdmVudCwgZW50ZXJFdmVudCwgZnJvbTIsIHRvMikgewogICAgICAgICAgdmFyIGNvbW1vbiA9IGZyb20yICYmIHRvMiA/IGdldExvd2VzdENvbW1vbkFuY2VzdG9yKGZyb20yLCB0bzIpIDogbnVsbDsKICAgICAgICAgIGlmIChmcm9tMiAhPT0gbnVsbCkgewogICAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZUxpc3RlbmVyc0ZvckV2ZW50KGRpc3BhdGNoUXVldWUsIGxlYXZlRXZlbnQsIGZyb20yLCBjb21tb24sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0bzIgIT09IG51bGwgJiYgZW50ZXJFdmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBhY2N1bXVsYXRlRW50ZXJMZWF2ZUxpc3RlbmVyc0ZvckV2ZW50KGRpc3BhdGNoUXVldWUsIGVudGVyRXZlbnQsIHRvMiwgY29tbW9uLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGlzdGVuZXJTZXRLZXkoZG9tRXZlbnROYW1lLCBjYXB0dXJlKSB7CiAgICAgICAgICByZXR1cm4gZG9tRXZlbnROYW1lICsgIl9fIiArIChjYXB0dXJlID8gImNhcHR1cmUiIDogImJ1YmJsZSIpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwgPSAiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiOwogICAgICAgIHZhciBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgPSAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIjsKICAgICAgICB2YXIgU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcgPSAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIjsKICAgICAgICB2YXIgQVVUT0ZPQ1VTID0gImF1dG9Gb2N1cyI7CiAgICAgICAgdmFyIENISUxEUkVOID0gImNoaWxkcmVuIjsKICAgICAgICB2YXIgU1RZTEUgPSAic3R5bGUiOwogICAgICAgIHZhciBIVE1MJDEgPSAiX19odG1sIjsKICAgICAgICB2YXIgd2FybmVkVW5rbm93blRhZ3M7CiAgICAgICAgdmFyIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQ7CiAgICAgICAgdmFyIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZTsKICAgICAgICB2YXIgd2FybkZvckV4dHJhQXR0cmlidXRlczsKICAgICAgICB2YXIgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyOwogICAgICAgIHZhciBjYW5EaWZmU3R5bGVGb3JIeWRyYXRpb25XYXJuaW5nOwogICAgICAgIHZhciBub3JtYWxpemVIVE1MOwogICAgICAgIHsKICAgICAgICAgIHdhcm5lZFVua25vd25UYWdzID0gewogICAgICAgICAgICAvLyBUaGVyZSBhcmUgd29ya2luZyBwb2x5ZmlsbHMgZm9yIDxkaWFsb2c+LiBMZXQgcGVvcGxlIHVzZSBpdC4KICAgICAgICAgICAgZGlhbG9nOiB0cnVlLAogICAgICAgICAgICAvLyBFbGVjdHJvbiBzaGlwcyBhIGN1c3RvbSA8d2Vidmlldz4gdGFnIHRvIGRpc3BsYXkgZXh0ZXJuYWwgd2ViIGNvbnRlbnQgaW4KICAgICAgICAgICAgLy8gYW4gaXNvbGF0ZWQgZnJhbWUgYW5kIHByb2Nlc3MuCiAgICAgICAgICAgIC8vIFRoaXMgdGFnIGlzIG5vdCBwcmVzZW50IGluIG5vbiBFbGVjdHJvbiBlbnZpcm9ubWVudHMgc3VjaCBhcyBKU0RvbSB3aGljaAogICAgICAgICAgICAvLyBpcyBvZnRlbiB1c2VkIGZvciB0ZXN0aW5nIHB1cnBvc2VzLgogICAgICAgICAgICAvLyBAc2VlIGh0dHBzOi8vZWxlY3Ryb25qcy5vcmcvZG9jcy9hcGkvd2Vidmlldy10YWcKICAgICAgICAgICAgd2VidmlldzogdHJ1ZQogICAgICAgICAgfTsKICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQgPSBmdW5jdGlvbih0eXBlLCBwcm9wcykgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXModHlwZSwgcHJvcHMpOwogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXMkMSh0eXBlLCBwcm9wcyk7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllcyQyKHR5cGUsIHByb3BzLCB7CiAgICAgICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcywKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfTsKICAgICAgICAgIGNhbkRpZmZTdHlsZUZvckh5ZHJhdGlvbldhcm5pbmcgPSBjYW5Vc2VET00yICYmICFkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UgPSBmdW5jdGlvbihwcm9wTmFtZSwgc2VydmVyVmFsdWUsIGNsaWVudFZhbHVlKSB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbm9ybWFsaXplZENsaWVudFZhbHVlID0gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKGNsaWVudFZhbHVlKTsKICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWRTZXJ2ZXJWYWx1ZSA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShzZXJ2ZXJWYWx1ZSk7CiAgICAgICAgICAgIGlmIChub3JtYWxpemVkU2VydmVyVmFsdWUgPT09IG5vcm1hbGl6ZWRDbGllbnRWYWx1ZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJQcm9wIGAlc2AgZGlkIG5vdCBtYXRjaC4gU2VydmVyOiAlcyBDbGllbnQ6ICVzIiwgcHJvcE5hbWUsIEpTT04uc3RyaW5naWZ5KG5vcm1hbGl6ZWRTZXJ2ZXJWYWx1ZSksIEpTT04uc3RyaW5naWZ5KG5vcm1hbGl6ZWRDbGllbnRWYWx1ZSkpOwogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5Gb3JFeHRyYUF0dHJpYnV0ZXMgPSBmdW5jdGlvbihhdHRyaWJ1dGVOYW1lcykgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICB2YXIgbmFtZXMgPSBbXTsKICAgICAgICAgICAgYXR0cmlidXRlTmFtZXMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgbmFtZXMucHVzaChuYW1lKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGVycm9yKCJFeHRyYSBhdHRyaWJ1dGVzIGZyb20gdGhlIHNlcnZlcjogJXMiLCBuYW1lcyk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyID0gZnVuY3Rpb24ocmVnaXN0cmF0aW9uTmFtZSwgbGlzdGVuZXIyKSB7CiAgICAgICAgICAgIGlmIChsaXN0ZW5lcjIgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGAlc2AgbGlzdGVuZXIgdG8gYmUgYSBmdW5jdGlvbiwgaW5zdGVhZCBnb3QgYGZhbHNlYC5cblxuSWYgeW91IHVzZWQgdG8gY29uZGl0aW9uYWxseSBvbWl0IGl0IHdpdGggJXM9e2NvbmRpdGlvbiAmJiB2YWx1ZX0sIHBhc3MgJXM9e2NvbmRpdGlvbiA/IHZhbHVlIDogdW5kZWZpbmVkfSBpbnN0ZWFkLiIsIHJlZ2lzdHJhdGlvbk5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBgJXNgIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24sIGluc3RlYWQgZ290IGEgdmFsdWUgb2YgYCVzYCB0eXBlLiIsIHJlZ2lzdHJhdGlvbk5hbWUsIHR5cGVvZiBsaXN0ZW5lcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgbm9ybWFsaXplSFRNTCA9IGZ1bmN0aW9uKHBhcmVudCwgaHRtbCkgewogICAgICAgICAgICB2YXIgdGVzdEVsZW1lbnQgPSBwYXJlbnQubmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSA/IHBhcmVudC5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQocGFyZW50LnRhZ05hbWUpIDogcGFyZW50Lm93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKHBhcmVudC5uYW1lc3BhY2VVUkksIHBhcmVudC50YWdOYW1lKTsKICAgICAgICAgICAgdGVzdEVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICAgICAgcmV0dXJuIHRlc3RFbGVtZW50LmlubmVySFRNTDsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBOT1JNQUxJWkVfTkVXTElORVNfUkVHRVggPSAvXHJcbj8vZzsKICAgICAgICB2YXIgTk9STUFMSVpFX05VTExfQU5EX1JFUExBQ0VNRU5UX1JFR0VYID0gL1x1MDAwMHxcdUZGRkQvZzsKICAgICAgICBmdW5jdGlvbiBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUobWFya3VwKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrSHRtbFN0cmluZ0NvZXJjaW9uKG1hcmt1cCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWFya3VwU3RyaW5nID0gdHlwZW9mIG1hcmt1cCA9PT0gInN0cmluZyIgPyBtYXJrdXAgOiAiIiArIG1hcmt1cDsKICAgICAgICAgIHJldHVybiBtYXJrdXBTdHJpbmcucmVwbGFjZShOT1JNQUxJWkVfTkVXTElORVNfUkVHRVgsICJcbiIpLnJlcGxhY2UoTk9STUFMSVpFX05VTExfQU5EX1JFUExBQ0VNRU5UX1JFR0VYLCAiIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRm9yVW5tYXRjaGVkVGV4dChzZXJ2ZXJUZXh0LCBjbGllbnRUZXh0LCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICB2YXIgbm9ybWFsaXplZENsaWVudFRleHQgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoY2xpZW50VGV4dCk7CiAgICAgICAgICB2YXIgbm9ybWFsaXplZFNlcnZlclRleHQgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoc2VydmVyVGV4dCk7CiAgICAgICAgICBpZiAobm9ybWFsaXplZFNlcnZlclRleHQgPT09IG5vcm1hbGl6ZWRDbGllbnRUZXh0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcignVGV4dCBjb250ZW50IGRpZCBub3QgbWF0Y2guIFNlcnZlcjogIiVzIiBDbGllbnQ6ICIlcyInLCBub3JtYWxpemVkU2VydmVyVGV4dCwgbm9ybWFsaXplZENsaWVudFRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgJiYgZW5hYmxlQ2xpZW50UmVuZGVyRmFsbGJhY2tPblRleHRNaXNtYXRjaCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRleHQgY29udGVudCBkb2VzIG5vdCBtYXRjaCBzZXJ2ZXItcmVuZGVyZWQgSFRNTC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICByZXR1cm4gcm9vdENvbnRhaW5lckVsZW1lbnQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyByb290Q29udGFpbmVyRWxlbWVudCA6IHJvb3RDb250YWluZXJFbGVtZW50Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5vb3A0KCkgewogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChub2RlKSB7CiAgICAgICAgICBub2RlLm9uY2xpY2sgPSBub29wNDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SW5pdGlhbERPTVByb3BlcnRpZXModGFnLCBkb21FbGVtZW50LCByb290Q29udGFpbmVyRWxlbWVudCwgbmV4dFByb3BzLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgZm9yICh2YXIgcHJvcEtleSBpbiBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgaWYgKCFuZXh0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV4dFByb3AgPSBuZXh0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JTdHlsZXMoZG9tRWxlbWVudCwgbmV4dFByb3ApOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIGlmIChuZXh0SHRtbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXRJbm5lckhUTUwoZG9tRWxlbWVudCwgbmV4dEh0bWwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FuU2V0VGV4dENvbnRlbnQgPSB0YWcgIT09ICJ0ZXh0YXJlYSIgfHwgbmV4dFByb3AgIT09ICIiOwogICAgICAgICAgICAgICAgaWYgKGNhblNldFRleHRDb250ZW50KSB7CiAgICAgICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsICIiICsgbmV4dFByb3ApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcpIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gQVVUT0ZPQ1VTKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICBzZXRWYWx1ZUZvclByb3BlcnR5KGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRE9NUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB3YXNDdXN0b21Db21wb25lbnRUYWcsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHVwZGF0ZVBheWxvYWQubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgICAgdmFyIHByb3BLZXkgPSB1cGRhdGVQYXlsb2FkW2ldOwogICAgICAgICAgICB2YXIgcHJvcFZhbHVlID0gdXBkYXRlUGF5bG9hZFtpICsgMV07CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHNldFZhbHVlRm9yU3R5bGVzKGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwpIHsKICAgICAgICAgICAgICBzZXRJbm5lckhUTUwoZG9tRWxlbWVudCwgcHJvcFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JQcm9wZXJ0eShkb21FbGVtZW50LCBwcm9wS2V5LCBwcm9wVmFsdWUsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50MzkodHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJFbGVtZW50LCBwYXJlbnROYW1lc3BhY2UpIHsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZzsKICAgICAgICAgIHZhciBvd25lckRvY3VtZW50ID0gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KTsKICAgICAgICAgIHZhciBkb21FbGVtZW50OwogICAgICAgICAgdmFyIG5hbWVzcGFjZVVSSSA9IHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgIGlmIChuYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIG5hbWVzcGFjZVVSSSA9IGdldEludHJpbnNpY05hbWVzcGFjZSh0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYW1lc3BhY2VVUkkgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKTsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tQ29tcG9uZW50VGFnICYmIHR5cGUgIT09IHR5cGUudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIjwlcyAvPiBpcyB1c2luZyBpbmNvcnJlY3QgY2FzaW5nLiBVc2UgUGFzY2FsQ2FzZSBmb3IgUmVhY3QgY29tcG9uZW50cywgb3IgbG93ZXJjYXNlIGZvciBIVE1MIGVsZW1lbnRzLiIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSA9PT0gInNjcmlwdCIpIHsKICAgICAgICAgICAgICB2YXIgZGl2ID0gb3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gIjxzY3JpcHQ+PFwvc2NyaXB0PiI7CiAgICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBkaXYuZmlyc3RDaGlsZDsKICAgICAgICAgICAgICBkb21FbGVtZW50ID0gZGl2LnJlbW92ZUNoaWxkKGZpcnN0Q2hpbGQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm9wcy5pcyA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICBkb21FbGVtZW50ID0gb3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KHR5cGUsIHsKICAgICAgICAgICAgICAgIGlzOiBwcm9wcy5pcwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodHlwZSk7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJzZWxlY3QiKSB7CiAgICAgICAgICAgICAgICB2YXIgbm9kZSA9IGRvbUVsZW1lbnQ7CiAgICAgICAgICAgICAgICBpZiAocHJvcHMubXVsdGlwbGUpIHsKICAgICAgICAgICAgICAgICAgbm9kZS5tdWx0aXBsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BzLnNpemUpIHsKICAgICAgICAgICAgICAgICAgbm9kZS5zaXplID0gcHJvcHMuc2l6ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRvbUVsZW1lbnQgPSBvd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2VVUkksIHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgIGlmICghaXNDdXN0b21Db21wb25lbnRUYWcgJiYgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGRvbUVsZW1lbnQpID09PSAiW29iamVjdCBIVE1MVW5rbm93bkVsZW1lbnRdIiAmJiAhaGFzT3duUHJvcGVydHkuY2FsbCh3YXJuZWRVbmtub3duVGFncywgdHlwZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5lZFVua25vd25UYWdzW3R5cGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgdGFnIDwlcz4gaXMgdW5yZWNvZ25pemVkIGluIHRoaXMgYnJvd3Nlci4gSWYgeW91IG1lYW50IHRvIHJlbmRlciBhIFJlYWN0IGNvbXBvbmVudCwgc3RhcnQgaXRzIG5hbWUgd2l0aCBhbiB1cHBlcmNhc2UgbGV0dGVyLiIsIHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRvbUVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVRleHROb2RlKHRleHQsIHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICByZXR1cm4gZ2V0T3duZXJEb2N1bWVudEZyb21Sb290Q29udGFpbmVyKHJvb3RDb250YWluZXJFbGVtZW50KS5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SW5pdGlhbFByb3BlcnRpZXMoZG9tRWxlbWVudCwgdGFnLCByYXdQcm9wcywgcm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50KHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb3BzOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiZGlhbG9nIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjYW5jZWwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjbG9zZSIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlmcmFtZSI6CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgIGNhc2UgImVtYmVkIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidmlkZW8iOgogICAgICAgICAgICBjYXNlICJhdWRpbyI6CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZWRpYUV2ZW50VHlwZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQobWVkaWFFdmVudFR5cGVzW2ldLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic291cmNlIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgIGNhc2UgImltYWdlIjoKICAgICAgICAgICAgY2FzZSAibGluayI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgidG9nZ2xlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIHByb3BzID0gZ2V0SG9zdFByb3BzKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wcyhkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSByYXdQcm9wczsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIHByb3BzID0gZ2V0SG9zdFByb3BzJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgcHJvcHMgPSBnZXRIb3N0UHJvcHMkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgcHJvcHMpOwogICAgICAgICAgc2V0SW5pdGlhbERPTVByb3BlcnRpZXModGFnLCBkb21FbGVtZW50LCByb290Q29udGFpbmVyRWxlbWVudCwgcHJvcHMsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyKGRvbUVsZW1lbnQsIHJhd1Byb3BzLCBmYWxzZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDMoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQxKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyJDIoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMub25DbGljayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWZmUHJvcGVydGllcyhkb21FbGVtZW50LCB0YWcsIGxhc3RSYXdQcm9wcywgbmV4dFJhd1Byb3BzLCByb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50KHRhZywgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gbnVsbDsKICAgICAgICAgIHZhciBsYXN0UHJvcHM7CiAgICAgICAgICB2YXIgbmV4dFByb3BzOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGdldEhvc3RQcm9wcyhkb21FbGVtZW50LCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyhkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMShkb21FbGVtZW50LCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IGdldEhvc3RQcm9wcyQxKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgbGFzdFByb3BzID0gZ2V0SG9zdFByb3BzJDIoZG9tRWxlbWVudCwgbGFzdFJhd1Byb3BzKTsKICAgICAgICAgICAgICBuZXh0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMihkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBsYXN0UmF3UHJvcHM7CiAgICAgICAgICAgICAgbmV4dFByb3BzID0gbmV4dFJhd1Byb3BzOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgbGFzdFByb3BzLm9uQ2xpY2sgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG5leHRQcm9wcy5vbkNsaWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0cmFwQ2xpY2tPbk5vbkludGVyYWN0aXZlRWxlbWVudChkb21FbGVtZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgbmV4dFByb3BzKTsKICAgICAgICAgIHZhciBwcm9wS2V5OwogICAgICAgICAgdmFyIHN0eWxlTmFtZTsKICAgICAgICAgIHZhciBzdHlsZVVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgZm9yIChwcm9wS2V5IGluIGxhc3RQcm9wcykgewogICAgICAgICAgICBpZiAobmV4dFByb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpIHx8ICFsYXN0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkgfHwgbGFzdFByb3BzW3Byb3BLZXldID09IG51bGwpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICB2YXIgbGFzdFN0eWxlID0gbGFzdFByb3BzW3Byb3BLZXldOwogICAgICAgICAgICAgIGZvciAoc3R5bGVOYW1lIGluIGxhc3RTdHlsZSkgewogICAgICAgICAgICAgICAgaWYgKGxhc3RTdHlsZS5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGlmICghc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0ge307CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzW3N0eWxlTmFtZV0gPSAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gREFOR0VST1VTTFlfU0VUX0lOTkVSX0hUTUwgfHwgcHJvcEtleSA9PT0gQ0hJTERSRU4pIDsKICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IEFVVE9GT0NVUykgOwogICAgICAgICAgICBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZm9yIChwcm9wS2V5IGluIG5leHRQcm9wcykgewogICAgICAgICAgICB2YXIgbmV4dFByb3AgPSBuZXh0UHJvcHNbcHJvcEtleV07CiAgICAgICAgICAgIHZhciBsYXN0UHJvcCA9IGxhc3RQcm9wcyAhPSBudWxsID8gbGFzdFByb3BzW3Byb3BLZXldIDogdm9pZCAwOwogICAgICAgICAgICBpZiAoIW5leHRQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSB8fCBuZXh0UHJvcCA9PT0gbGFzdFByb3AgfHwgbmV4dFByb3AgPT0gbnVsbCAmJiBsYXN0UHJvcCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUobmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobGFzdFByb3ApIHsKICAgICAgICAgICAgICAgIGZvciAoc3R5bGVOYW1lIGluIGxhc3RQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChsYXN0UHJvcC5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpICYmICghbmV4dFByb3AgfHwgIW5leHRQcm9wLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IHt9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXNbc3R5bGVOYW1lXSA9ICIiOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKHN0eWxlTmFtZSBpbiBuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBpZiAobmV4dFByb3AuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSAmJiBsYXN0UHJvcFtzdHlsZU5hbWVdICE9PSBuZXh0UHJvcFtzdHlsZU5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IHt9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXNbc3R5bGVOYW1lXSA9IG5leHRQcm9wW3N0eWxlTmFtZV07CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgICAgaWYgKCF1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQucHVzaChwcm9wS2V5LCBzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzID0gbmV4dFByb3A7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgIHZhciBsYXN0SHRtbCA9IGxhc3RQcm9wID8gbGFzdFByb3BbSFRNTCQxXSA6IHZvaWQgMDsKICAgICAgICAgICAgICBpZiAobmV4dEh0bWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGxhc3RIdG1sICE9PSBuZXh0SHRtbCkgewogICAgICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgbmV4dEh0bWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBDSElMRFJFTikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJzdHJpbmciIHx8IHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCAiIiArIG5leHRQcm9wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB3YXJuRm9ySW52YWxpZEV2ZW50TGlzdGVuZXIocHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09ICJvblNjcm9sbCIpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgic2Nyb2xsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghdXBkYXRlUGF5bG9hZCAmJiBsYXN0UHJvcCAhPT0gbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHN0eWxlVXBkYXRlcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsaWRhdGVTaG9ydGhhbmRQcm9wZXJ0eUNvbGxpc2lvbkluRGV2KHN0eWxlVXBkYXRlcywgbmV4dFByb3BzW1NUWUxFXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKFNUWUxFLCBzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgdGFnLCBsYXN0UmF3UHJvcHMsIG5leHRSYXdQcm9wcykgewogICAgICAgICAgaWYgKHRhZyA9PT0gImlucHV0IiAmJiBuZXh0UmF3UHJvcHMudHlwZSA9PT0gInJhZGlvIiAmJiBuZXh0UmF3UHJvcHMubmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZUNoZWNrZWQoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB3YXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICB2YXIgaXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICB1cGRhdGVET01Qcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHdhc0N1c3RvbUNvbXBvbmVudFRhZywgaXNDdXN0b21Db21wb25lbnRUYWcpOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHVwZGF0ZVdyYXBwZXIoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHVwZGF0ZVdyYXBwZXIkMShkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIHBvc3RVcGRhdGVXcmFwcGVyKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFBvc3NpYmxlU3RhbmRhcmROYW1lKHByb3BOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBsb3dlckNhc2VkTmFtZSA9IHByb3BOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIGlmICghcG9zc2libGVTdGFuZGFyZE5hbWVzLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwb3NzaWJsZVN0YW5kYXJkTmFtZXNbbG93ZXJDYXNlZE5hbWVdIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZmZIeWRyYXRlZFByb3BlcnRpZXMoZG9tRWxlbWVudCwgdGFnLCByYXdQcm9wcywgcGFyZW50TmFtZXNwYWNlLCByb290Q29udGFpbmVyRWxlbWVudCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldikgewogICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnOwogICAgICAgICAgdmFyIGV4dHJhQXR0cmlidXRlTmFtZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICAgIHZhbGlkYXRlUHJvcGVydGllc0luRGV2ZWxvcG1lbnQodGFnLCByYXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJkaWFsb2ciOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNhbmNlbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImNsb3NlIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlmcmFtZSI6CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgIGNhc2UgImVtYmVkIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInZpZGVvIjoKICAgICAgICAgICAgY2FzZSAiYXVkaW8iOgogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWVkaWFFdmVudFR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KG1lZGlhRXZlbnRUeXBlc1tpXSwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzb3VyY2UiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImVycm9yIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgIGNhc2UgImltYWdlIjoKICAgICAgICAgICAgY2FzZSAibGluayI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJsb2FkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRldGFpbHMiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInRvZ2dsZSIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgIHZhbGlkYXRlUHJvcHMoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NlcnRWYWxpZFByb3BzKHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgewogICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZXMgPSBkb21FbGVtZW50LmF0dHJpYnV0ZXM7CiAgICAgICAgICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBhdHRyaWJ1dGVzLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgIHZhciBuYW1lID0gYXR0cmlidXRlc1tfaV0ubmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIHN3aXRjaCAobmFtZSkgewogICAgICAgICAgICAgICAgY2FzZSAidmFsdWUiOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImNoZWNrZWQiOgogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInNlbGVjdGVkIjoKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmFkZChhdHRyaWJ1dGVzW19pXS5uYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gbnVsbDsKICAgICAgICAgIGZvciAodmFyIHByb3BLZXkgaW4gcmF3UHJvcHMpIHsKICAgICAgICAgICAgaWYgKCFyYXdQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZXh0UHJvcCA9IHJhd1Byb3BzW3Byb3BLZXldOwogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gQ0hJTERSRU4pIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgaWYgKGRvbUVsZW1lbnQudGV4dENvbnRlbnQgIT09IG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQoZG9tRWxlbWVudC50ZXh0Q29udGVudCwgbmV4dFByb3AsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbQ0hJTERSRU4sIG5leHRQcm9wXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgIGlmIChkb21FbGVtZW50LnRleHRDb250ZW50ICE9PSAiIiArIG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQoZG9tRWxlbWVudC50ZXh0Q29udGVudCwgbmV4dFByb3AsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbQ0hJTERSRU4sICIiICsgbmV4dFByb3BdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSAib25TY3JvbGwiKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInNjcm9sbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChzaG91bGRXYXJuRGV2ICYmIHRydWUgJiYgLy8gQ29udmluY2UgRmxvdyB3ZSd2ZSBjYWxjdWxhdGVkIGl0IChpdCdzIERFVi1vbmx5IGluIHRoaXMgbWV0aG9kLikKICAgICAgICAgICAgdHlwZW9mIGlzQ3VzdG9tQ29tcG9uZW50VGFnID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgICAgICB2YXIgc2VydmVyVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgICAgICAgdmFyIHByb3BlcnR5SW5mbyA9IGlzQ3VzdG9tQ29tcG9uZW50VGFnICYmIGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQgPyBudWxsIDogZ2V0UHJvcGVydHlJbmZvKHByb3BLZXkpOwogICAgICAgICAgICAgIGlmIChyYXdQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklOR10gPT09IHRydWUpIDsKICAgICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBTVVBQUkVTU19DT05URU5UX0VESVRBQkxFX1dBUk5JTkcgfHwgcHJvcEtleSA9PT0gU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkcgfHwgLy8gQ29udHJvbGxlZCBhdHRyaWJ1dGVzIGFyZSBub3QgdmFsaWRhdGVkCiAgICAgICAgICAgICAgLy8gVE9ETzogT25seSBpZ25vcmUgdGhlbSBvbiBjb250cm9sbGVkIHRhZ3MuCiAgICAgICAgICAgICAgcHJvcEtleSA9PT0gInZhbHVlIiB8fCBwcm9wS2V5ID09PSAiY2hlY2tlZCIgfHwgcHJvcEtleSA9PT0gInNlbGVjdGVkIikgOwogICAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgICB2YXIgc2VydmVySFRNTCA9IGRvbUVsZW1lbnQuaW5uZXJIVE1MOwogICAgICAgICAgICAgICAgdmFyIG5leHRIdG1sID0gbmV4dFByb3AgPyBuZXh0UHJvcFtIVE1MJDFdIDogdm9pZCAwOwogICAgICAgICAgICAgICAgaWYgKG5leHRIdG1sICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGV4cGVjdGVkSFRNTCA9IG5vcm1hbGl6ZUhUTUwoZG9tRWxlbWVudCwgbmV4dEh0bWwpOwogICAgICAgICAgICAgICAgICBpZiAoZXhwZWN0ZWRIVE1MICE9PSBzZXJ2ZXJIVE1MKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlckhUTUwsIGV4cGVjdGVkSFRNTCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wS2V5KTsKICAgICAgICAgICAgICAgIGlmIChjYW5EaWZmU3R5bGVGb3JIeWRyYXRpb25XYXJuaW5nKSB7CiAgICAgICAgICAgICAgICAgIHZhciBleHBlY3RlZFN0eWxlID0gY3JlYXRlRGFuZ2Vyb3VzU3RyaW5nRm9yU3R5bGVzKG5leHRQcm9wKTsKICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBkb21FbGVtZW50LmdldEF0dHJpYnV0ZSgic3R5bGUiKTsKICAgICAgICAgICAgICAgICAgaWYgKGV4cGVjdGVkU3R5bGUgIT09IHNlcnZlclZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlclZhbHVlLCBleHBlY3RlZFN0eWxlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcgJiYgIWVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQpIHsKICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICBzZXJ2ZXJWYWx1ZSA9IGdldFZhbHVlRm9yQXR0cmlidXRlKGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcCAhPT0gc2VydmVyVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlKHByb3BLZXksIHNlcnZlclZhbHVlLCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghc2hvdWxkSWdub3JlQXR0cmlidXRlKHByb3BLZXksIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpICYmICFzaG91bGRSZW1vdmVBdHRyaWJ1dGUocHJvcEtleSwgbmV4dFByb3AsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpKSB7CiAgICAgICAgICAgICAgICB2YXIgaXNNaXNtYXRjaER1ZVRvQmFkQ2FzaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BlcnR5SW5mby5hdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBnZXRWYWx1ZUZvclByb3BlcnR5KGRvbUVsZW1lbnQsIHByb3BLZXksIG5leHRQcm9wLCBwcm9wZXJ0eUluZm8pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIG93bk5hbWVzcGFjZSA9IHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgICAgICAgICAgaWYgKG93bk5hbWVzcGFjZSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgICAgICAgICBvd25OYW1lc3BhY2UgPSBnZXRJbnRyaW5zaWNOYW1lc3BhY2UodGFnKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAob3duTmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0YW5kYXJkTmFtZSA9IGdldFBvc3NpYmxlU3RhbmRhcmROYW1lKHByb3BLZXkpOwogICAgICAgICAgICAgICAgICAgIGlmIChzdGFuZGFyZE5hbWUgIT09IG51bGwgJiYgc3RhbmRhcmROYW1lICE9PSBwcm9wS2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICBpc01pc21hdGNoRHVlVG9CYWRDYXNpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUoc3RhbmRhcmROYW1lKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBnZXRWYWx1ZUZvckF0dHJpYnV0ZShkb21FbGVtZW50LCBwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgZG9udFdhcm5DdXN0b21FbGVtZW50ID0gZW5hYmxlQ3VzdG9tRWxlbWVudFByb3BlcnR5U3VwcG9ydDsKICAgICAgICAgICAgICAgIGlmICghZG9udFdhcm5DdXN0b21FbGVtZW50ICYmIG5leHRQcm9wICE9PSBzZXJ2ZXJWYWx1ZSAmJiAhaXNNaXNtYXRjaER1ZVRvQmFkQ2FzaW5nKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZShwcm9wS2V5LCBzZXJ2ZXJWYWx1ZSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoc2hvdWxkV2FybkRldikgewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIC8vICRGbG93Rml4TWUgLSBTaG91bGQgYmUgaW5mZXJyZWQgYXMgbm90IHVuZGVmaW5lZC4KICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuc2l6ZSA+IDAgJiYgcmF3UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkddICE9PSB0cnVlCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRXh0cmFBdHRyaWJ1dGVzKGV4dHJhQXR0cmlidXRlTmFtZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIoZG9tRWxlbWVudCwgcmF3UHJvcHMsIHRydWUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgdHJhY2soZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQzKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmICh0eXBlb2YgcmF3UHJvcHMub25DbGljayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZmZIeWRyYXRlZFRleHQodGV4dE5vZGUsIHRleHQsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHZhciBpc0RpZmZlcmVudCA9IHRleHROb2RlLm5vZGVWYWx1ZSAhPT0gdGV4dDsKICAgICAgICAgIHJldHVybiBpc0RpZmZlcmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnROb2RlLCBjaGlsZCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiRGlkIG5vdCBleHBlY3Qgc2VydmVyIEhUTUwgdG8gY29udGFpbiBhIDwlcz4gaW4gPCVzPi4iLCBjaGlsZC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudE5vZGUsIGNoaWxkKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCdEaWQgbm90IGV4cGVjdCBzZXJ2ZXIgSFRNTCB0byBjb250YWluIHRoZSB0ZXh0IG5vZGUgIiVzIiBpbiA8JXM+LicsIGNoaWxkLm5vZGVWYWx1ZSwgcGFyZW50Tm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudE5vZGUsIHRhZywgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gYSBtYXRjaGluZyA8JXM+IGluIDwlcz4uIiwgdGFnLCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZFRleHQocGFyZW50Tm9kZSwgdGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodGV4dCA9PT0gIiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0V4cGVjdGVkIHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gYSBtYXRjaGluZyB0ZXh0IG5vZGUgZm9yICIlcyIgaW4gPCVzPi4nLCB0ZXh0LCBwYXJlbnROb2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDMoZG9tRWxlbWVudCwgdGFnLCBwcm9wcykgewogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIHJlc3RvcmVDb250cm9sbGVkU3RhdGUoZG9tRWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMihkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgIHJlc3RvcmVDb250cm9sbGVkU3RhdGUkMShkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsaWRhdGVET01OZXN0aW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgfTsKICAgICAgICB2YXIgdXBkYXRlZEFuY2VzdG9ySW5mbyA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIHNwZWNpYWxUYWdzID0gWyJhZGRyZXNzIiwgImFwcGxldCIsICJhcmVhIiwgImFydGljbGUiLCAiYXNpZGUiLCAiYmFzZSIsICJiYXNlZm9udCIsICJiZ3NvdW5kIiwgImJsb2NrcXVvdGUiLCAiYm9keSIsICJiciIsICJidXR0b24iLCAiY2FwdGlvbiIsICJjZW50ZXIiLCAiY29sIiwgImNvbGdyb3VwIiwgImRkIiwgImRldGFpbHMiLCAiZGlyIiwgImRpdiIsICJkbCIsICJkdCIsICJlbWJlZCIsICJmaWVsZHNldCIsICJmaWdjYXB0aW9uIiwgImZpZ3VyZSIsICJmb290ZXIiLCAiZm9ybSIsICJmcmFtZSIsICJmcmFtZXNldCIsICJoMSIsICJoMiIsICJoMyIsICJoNCIsICJoNSIsICJoNiIsICJoZWFkIiwgImhlYWRlciIsICJoZ3JvdXAiLCAiaHIiLCAiaHRtbCIsICJpZnJhbWUiLCAiaW1nIiwgImlucHV0IiwgImlzaW5kZXgiLCAibGkiLCAibGluayIsICJsaXN0aW5nIiwgIm1haW4iLCAibWFycXVlZSIsICJtZW51IiwgIm1lbnVpdGVtIiwgIm1ldGEiLCAibmF2IiwgIm5vZW1iZWQiLCAibm9mcmFtZXMiLCAibm9zY3JpcHQiLCAib2JqZWN0IiwgIm9sIiwgInAiLCAicGFyYW0iLCAicGxhaW50ZXh0IiwgInByZSIsICJzY3JpcHQiLCAic2VjdGlvbiIsICJzZWxlY3QiLCAic291cmNlIiwgInN0eWxlIiwgInN1bW1hcnkiLCAidGFibGUiLCAidGJvZHkiLCAidGQiLCAidGVtcGxhdGUiLCAidGV4dGFyZWEiLCAidGZvb3QiLCAidGgiLCAidGhlYWQiLCAidGl0bGUiLCAidHIiLCAidHJhY2siLCAidWwiLCAid2JyIiwgInhtcCJdOwogICAgICAgICAgdmFyIGluU2NvcGVUYWdzID0gWwogICAgICAgICAgICAiYXBwbGV0IiwKICAgICAgICAgICAgImNhcHRpb24iLAogICAgICAgICAgICAiaHRtbCIsCiAgICAgICAgICAgICJ0YWJsZSIsCiAgICAgICAgICAgICJ0ZCIsCiAgICAgICAgICAgICJ0aCIsCiAgICAgICAgICAgICJtYXJxdWVlIiwKICAgICAgICAgICAgIm9iamVjdCIsCiAgICAgICAgICAgICJ0ZW1wbGF0ZSIsCiAgICAgICAgICAgIC8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3N5bnRheC5odG1sI2h0bWwtaW50ZWdyYXRpb24tcG9pbnQKICAgICAgICAgICAgLy8gVE9ETzogRGlzdGluZ3Vpc2ggYnkgbmFtZXNwYWNlIGhlcmUgLS0gZm9yIDx0aXRsZT4sIGluY2x1ZGluZyBpdCBoZXJlCiAgICAgICAgICAgIC8vIGVycnMgb24gdGhlIHNpZGUgb2YgZmV3ZXIgd2FybmluZ3MKICAgICAgICAgICAgImZvcmVpZ25PYmplY3QiLAogICAgICAgICAgICAiZGVzYyIsCiAgICAgICAgICAgICJ0aXRsZSIKICAgICAgICAgIF07CiAgICAgICAgICB2YXIgYnV0dG9uU2NvcGVUYWdzID0gaW5TY29wZVRhZ3MuY29uY2F0KFsiYnV0dG9uIl0pOwogICAgICAgICAgdmFyIGltcGxpZWRFbmRUYWdzID0gWyJkZCIsICJkdCIsICJsaSIsICJvcHRpb24iLCAib3B0Z3JvdXAiLCAicCIsICJycCIsICJydCJdOwogICAgICAgICAgdmFyIGVtcHR5QW5jZXN0b3JJbmZvID0gewogICAgICAgICAgICBjdXJyZW50OiBudWxsLAogICAgICAgICAgICBmb3JtVGFnOiBudWxsLAogICAgICAgICAgICBhVGFnSW5TY29wZTogbnVsbCwKICAgICAgICAgICAgYnV0dG9uVGFnSW5TY29wZTogbnVsbCwKICAgICAgICAgICAgbm9iclRhZ0luU2NvcGU6IG51bGwsCiAgICAgICAgICAgIHBUYWdJbkJ1dHRvblNjb3BlOiBudWxsLAogICAgICAgICAgICBsaXN0SXRlbVRhZ0F1dG9jbG9zaW5nOiBudWxsLAogICAgICAgICAgICBkbEl0ZW1UYWdBdXRvY2xvc2luZzogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHVwZGF0ZWRBbmNlc3RvckluZm8gPSBmdW5jdGlvbihvbGRJbmZvLCB0YWcpIHsKICAgICAgICAgICAgdmFyIGFuY2VzdG9ySW5mbyA9IGFzc2lnbjIoe30sIG9sZEluZm8gfHwgZW1wdHlBbmNlc3RvckluZm8pOwogICAgICAgICAgICB2YXIgaW5mbyA9IHsKICAgICAgICAgICAgICB0YWcKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGluU2NvcGVUYWdzLmluZGV4T2YodGFnKSAhPT0gLTEpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYVRhZ0luU2NvcGUgPSBudWxsOwogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5idXR0b25UYWdJblNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ubm9iclRhZ0luU2NvcGUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChidXR0b25TY29wZVRhZ3MuaW5kZXhPZih0YWcpICE9PSAtMSkgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5wVGFnSW5CdXR0b25TY29wZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNwZWNpYWxUYWdzLmluZGV4T2YodGFnKSAhPT0gLTEgJiYgdGFnICE9PSAiYWRkcmVzcyIgJiYgdGFnICE9PSAiZGl2IiAmJiB0YWcgIT09ICJwIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5saXN0SXRlbVRhZ0F1dG9jbG9zaW5nID0gbnVsbDsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uZGxJdGVtVGFnQXV0b2Nsb3NpbmcgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFuY2VzdG9ySW5mby5jdXJyZW50ID0gaW5mbzsKICAgICAgICAgICAgaWYgKHRhZyA9PT0gImZvcm0iKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmZvcm1UYWcgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJhIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5hVGFnSW5TY29wZSA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImJ1dHRvbiIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYnV0dG9uVGFnSW5TY29wZSA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gIm5vYnIiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLm5vYnJUYWdJblNjb3BlID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAicCIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGUgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJsaSIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ubGlzdEl0ZW1UYWdBdXRvY2xvc2luZyA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gImRkIiB8fCB0YWcgPT09ICJkdCIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uZGxJdGVtVGFnQXV0b2Nsb3NpbmcgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm87CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGlzVGFnVmFsaWRXaXRoUGFyZW50ID0gZnVuY3Rpb24odGFnLCBwYXJlbnRUYWcpIHsKICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRUYWcpIHsKICAgICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gIm9wdGlvbiIgfHwgdGFnID09PSAib3B0Z3JvdXAiIHx8IHRhZyA9PT0gIiN0ZXh0IjsKICAgICAgICAgICAgICBjYXNlICJvcHRncm91cCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAib3B0aW9uIiB8fCB0YWcgPT09ICIjdGV4dCI7CiAgICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICIjdGV4dCI7CiAgICAgICAgICAgICAgY2FzZSAidHIiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gInRoIiB8fCB0YWcgPT09ICJ0ZCIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgInRib2R5IjoKICAgICAgICAgICAgICBjYXNlICJ0aGVhZCI6CiAgICAgICAgICAgICAgY2FzZSAidGZvb3QiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gInRyIiB8fCB0YWcgPT09ICJzdHlsZSIgfHwgdGFnID09PSAic2NyaXB0IiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgY2FzZSAiY29sZ3JvdXAiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImNvbCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgInRhYmxlIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJjYXB0aW9uIiB8fCB0YWcgPT09ICJjb2xncm91cCIgfHwgdGFnID09PSAidGJvZHkiIHx8IHRhZyA9PT0gInRmb290IiB8fCB0YWcgPT09ICJ0aGVhZCIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgImhlYWQiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImJhc2UiIHx8IHRhZyA9PT0gImJhc2Vmb250IiB8fCB0YWcgPT09ICJiZ3NvdW5kIiB8fCB0YWcgPT09ICJsaW5rIiB8fCB0YWcgPT09ICJtZXRhIiB8fCB0YWcgPT09ICJ0aXRsZSIgfHwgdGFnID09PSAibm9zY3JpcHQiIHx8IHRhZyA9PT0gIm5vZnJhbWVzIiB8fCB0YWcgPT09ICJzdHlsZSIgfHwgdGFnID09PSAic2NyaXB0IiB8fCB0YWcgPT09ICJ0ZW1wbGF0ZSI7CiAgICAgICAgICAgICAgY2FzZSAiaHRtbCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiaGVhZCIgfHwgdGFnID09PSAiYm9keSIgfHwgdGFnID09PSAiZnJhbWVzZXQiOwogICAgICAgICAgICAgIGNhc2UgImZyYW1lc2V0IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJmcmFtZSI7CiAgICAgICAgICAgICAgY2FzZSAiI2RvY3VtZW50IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJodG1sIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgImgxIjoKICAgICAgICAgICAgICBjYXNlICJoMiI6CiAgICAgICAgICAgICAgY2FzZSAiaDMiOgogICAgICAgICAgICAgIGNhc2UgImg0IjoKICAgICAgICAgICAgICBjYXNlICJoNSI6CiAgICAgICAgICAgICAgY2FzZSAiaDYiOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudFRhZyAhPT0gImgxIiAmJiBwYXJlbnRUYWcgIT09ICJoMiIgJiYgcGFyZW50VGFnICE9PSAiaDMiICYmIHBhcmVudFRhZyAhPT0gImg0IiAmJiBwYXJlbnRUYWcgIT09ICJoNSIgJiYgcGFyZW50VGFnICE9PSAiaDYiOwogICAgICAgICAgICAgIGNhc2UgInJwIjoKICAgICAgICAgICAgICBjYXNlICJydCI6CiAgICAgICAgICAgICAgICByZXR1cm4gaW1wbGllZEVuZFRhZ3MuaW5kZXhPZihwYXJlbnRUYWcpID09PSAtMTsKICAgICAgICAgICAgICBjYXNlICJib2R5IjoKICAgICAgICAgICAgICBjYXNlICJjYXB0aW9uIjoKICAgICAgICAgICAgICBjYXNlICJjb2wiOgogICAgICAgICAgICAgIGNhc2UgImNvbGdyb3VwIjoKICAgICAgICAgICAgICBjYXNlICJmcmFtZXNldCI6CiAgICAgICAgICAgICAgY2FzZSAiZnJhbWUiOgogICAgICAgICAgICAgIGNhc2UgImhlYWQiOgogICAgICAgICAgICAgIGNhc2UgImh0bWwiOgogICAgICAgICAgICAgIGNhc2UgInRib2R5IjoKICAgICAgICAgICAgICBjYXNlICJ0ZCI6CiAgICAgICAgICAgICAgY2FzZSAidGZvb3QiOgogICAgICAgICAgICAgIGNhc2UgInRoIjoKICAgICAgICAgICAgICBjYXNlICJ0aGVhZCI6CiAgICAgICAgICAgICAgY2FzZSAidHIiOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudFRhZyA9PSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBmaW5kSW52YWxpZEFuY2VzdG9yRm9yVGFnID0gZnVuY3Rpb24odGFnLCBhbmNlc3RvckluZm8pIHsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlICJhZGRyZXNzIjoKICAgICAgICAgICAgICBjYXNlICJhcnRpY2xlIjoKICAgICAgICAgICAgICBjYXNlICJhc2lkZSI6CiAgICAgICAgICAgICAgY2FzZSAiYmxvY2txdW90ZSI6CiAgICAgICAgICAgICAgY2FzZSAiY2VudGVyIjoKICAgICAgICAgICAgICBjYXNlICJkZXRhaWxzIjoKICAgICAgICAgICAgICBjYXNlICJkaWFsb2ciOgogICAgICAgICAgICAgIGNhc2UgImRpciI6CiAgICAgICAgICAgICAgY2FzZSAiZGl2IjoKICAgICAgICAgICAgICBjYXNlICJkbCI6CiAgICAgICAgICAgICAgY2FzZSAiZmllbGRzZXQiOgogICAgICAgICAgICAgIGNhc2UgImZpZ2NhcHRpb24iOgogICAgICAgICAgICAgIGNhc2UgImZpZ3VyZSI6CiAgICAgICAgICAgICAgY2FzZSAiZm9vdGVyIjoKICAgICAgICAgICAgICBjYXNlICJoZWFkZXIiOgogICAgICAgICAgICAgIGNhc2UgImhncm91cCI6CiAgICAgICAgICAgICAgY2FzZSAibWFpbiI6CiAgICAgICAgICAgICAgY2FzZSAibWVudSI6CiAgICAgICAgICAgICAgY2FzZSAibmF2IjoKICAgICAgICAgICAgICBjYXNlICJvbCI6CiAgICAgICAgICAgICAgY2FzZSAicCI6CiAgICAgICAgICAgICAgY2FzZSAic2VjdGlvbiI6CiAgICAgICAgICAgICAgY2FzZSAic3VtbWFyeSI6CiAgICAgICAgICAgICAgY2FzZSAidWwiOgogICAgICAgICAgICAgIGNhc2UgInByZSI6CiAgICAgICAgICAgICAgY2FzZSAibGlzdGluZyI6CiAgICAgICAgICAgICAgY2FzZSAidGFibGUiOgogICAgICAgICAgICAgIGNhc2UgImhyIjoKICAgICAgICAgICAgICBjYXNlICJ4bXAiOgogICAgICAgICAgICAgIGNhc2UgImgxIjoKICAgICAgICAgICAgICBjYXNlICJoMiI6CiAgICAgICAgICAgICAgY2FzZSAiaDMiOgogICAgICAgICAgICAgIGNhc2UgImg0IjoKICAgICAgICAgICAgICBjYXNlICJoNSI6CiAgICAgICAgICAgICAgY2FzZSAiaDYiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5wVGFnSW5CdXR0b25TY29wZTsKICAgICAgICAgICAgICBjYXNlICJmb3JtIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8uZm9ybVRhZyB8fCBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGU7CiAgICAgICAgICAgICAgY2FzZSAibGkiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5saXN0SXRlbVRhZ0F1dG9jbG9zaW5nOwogICAgICAgICAgICAgIGNhc2UgImRkIjoKICAgICAgICAgICAgICBjYXNlICJkdCI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmRsSXRlbVRhZ0F1dG9jbG9zaW5nOwogICAgICAgICAgICAgIGNhc2UgImJ1dHRvbiI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmJ1dHRvblRhZ0luU2NvcGU7CiAgICAgICAgICAgICAgY2FzZSAiYSI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmFUYWdJblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgIm5vYnIiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5ub2JyVGFnSW5TY29wZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZGlkV2FybiQxID0ge307CiAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcgPSBmdW5jdGlvbihjaGlsZFRhZywgY2hpbGRUZXh0LCBhbmNlc3RvckluZm8pIHsKICAgICAgICAgICAgYW5jZXN0b3JJbmZvID0gYW5jZXN0b3JJbmZvIHx8IGVtcHR5QW5jZXN0b3JJbmZvOwogICAgICAgICAgICB2YXIgcGFyZW50SW5mbyA9IGFuY2VzdG9ySW5mby5jdXJyZW50OwogICAgICAgICAgICB2YXIgcGFyZW50VGFnID0gcGFyZW50SW5mbyAmJiBwYXJlbnRJbmZvLnRhZzsKICAgICAgICAgICAgaWYgKGNoaWxkVGV4dCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGNoaWxkVGFnICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJ2YWxpZGF0ZURPTU5lc3Rpbmc6IHdoZW4gY2hpbGRUZXh0IGlzIHBhc3NlZCwgY2hpbGRUYWcgc2hvdWxkIGJlIG51bGwiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGRUYWcgPSAiI3RleHQiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbnZhbGlkUGFyZW50ID0gaXNUYWdWYWxpZFdpdGhQYXJlbnQoY2hpbGRUYWcsIHBhcmVudFRhZykgPyBudWxsIDogcGFyZW50SW5mbzsKICAgICAgICAgICAgdmFyIGludmFsaWRBbmNlc3RvciA9IGludmFsaWRQYXJlbnQgPyBudWxsIDogZmluZEludmFsaWRBbmNlc3RvckZvclRhZyhjaGlsZFRhZywgYW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgdmFyIGludmFsaWRQYXJlbnRPckFuY2VzdG9yID0gaW52YWxpZFBhcmVudCB8fCBpbnZhbGlkQW5jZXN0b3I7CiAgICAgICAgICAgIGlmICghaW52YWxpZFBhcmVudE9yQW5jZXN0b3IpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFuY2VzdG9yVGFnID0gaW52YWxpZFBhcmVudE9yQW5jZXN0b3IudGFnOwogICAgICAgICAgICB2YXIgd2FybktleSA9ICEhaW52YWxpZFBhcmVudCArICJ8IiArIGNoaWxkVGFnICsgInwiICsgYW5jZXN0b3JUYWc7CiAgICAgICAgICAgIGlmIChkaWRXYXJuJDFbd2FybktleV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybiQxW3dhcm5LZXldID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIHRhZ0Rpc3BsYXlOYW1lID0gY2hpbGRUYWc7CiAgICAgICAgICAgIHZhciB3aGl0ZXNwYWNlSW5mbyA9ICIiOwogICAgICAgICAgICBpZiAoY2hpbGRUYWcgPT09ICIjdGV4dCIpIHsKICAgICAgICAgICAgICBpZiAoL1xTLy50ZXN0KGNoaWxkVGV4dCkpIHsKICAgICAgICAgICAgICAgIHRhZ0Rpc3BsYXlOYW1lID0gIlRleHQgbm9kZXMiOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YWdEaXNwbGF5TmFtZSA9ICJXaGl0ZXNwYWNlIHRleHQgbm9kZXMiOwogICAgICAgICAgICAgICAgd2hpdGVzcGFjZUluZm8gPSAiIE1ha2Ugc3VyZSB5b3UgZG9uJ3QgaGF2ZSBhbnkgZXh0cmEgd2hpdGVzcGFjZSBiZXR3ZWVuIHRhZ3Mgb24gZWFjaCBsaW5lIG9mIHlvdXIgc291cmNlIGNvZGUuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGFnRGlzcGxheU5hbWUgPSAiPCIgKyBjaGlsZFRhZyArICI+IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW52YWxpZFBhcmVudCkgewogICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgaWYgKGFuY2VzdG9yVGFnID09PSAidGFibGUiICYmIGNoaWxkVGFnID09PSAidHIiKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9ICIgQWRkIGEgPHRib2R5PiwgPHRoZWFkPiBvciA8dGZvb3Q+IHRvIHlvdXIgY29kZSB0byBtYXRjaCB0aGUgRE9NIHRyZWUgZ2VuZXJhdGVkIGJ5IHRoZSBicm93c2VyLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVycm9yKCJ2YWxpZGF0ZURPTU5lc3RpbmcoLi4uKTogJXMgY2Fubm90IGFwcGVhciBhcyBhIGNoaWxkIG9mIDwlcz4uJXMlcyIsIHRhZ0Rpc3BsYXlOYW1lLCBhbmNlc3RvclRhZywgd2hpdGVzcGFjZUluZm8sIGluZm8pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGVycm9yKCJ2YWxpZGF0ZURPTU5lc3RpbmcoLi4uKTogJXMgY2Fubm90IGFwcGVhciBhcyBhIGRlc2NlbmRhbnQgb2YgPCVzPi4iLCB0YWdEaXNwbGF5TmFtZSwgYW5jZXN0b3JUYWcpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMSA9ICJzdXBwcmVzc0h5ZHJhdGlvbldhcm5pbmciOwogICAgICAgIHZhciBTVVNQRU5TRV9TVEFSVF9EQVRBID0gIiQiOwogICAgICAgIHZhciBTVVNQRU5TRV9FTkRfREFUQSA9ICIvJCI7CiAgICAgICAgdmFyIFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSA9ICIkPyI7CiAgICAgICAgdmFyIFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgPSAiJCEiOwogICAgICAgIHZhciBTVFlMRSQxID0gInN0eWxlIjsKICAgICAgICB2YXIgZXZlbnRzRW5hYmxlZCA9IG51bGw7CiAgICAgICAgdmFyIHNlbGVjdGlvbkluZm9ybWF0aW9uID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBnZXRSb290SG9zdENvbnRleHQocm9vdENvbnRhaW5lckluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgdHlwZTsKICAgICAgICAgIHZhciBuYW1lc3BhY2U7CiAgICAgICAgICB2YXIgbm9kZVR5cGUgPSByb290Q29udGFpbmVySW5zdGFuY2Uubm9kZVR5cGU7CiAgICAgICAgICBzd2l0Y2ggKG5vZGVUeXBlKSB7CiAgICAgICAgICAgIGNhc2UgRE9DVU1FTlRfTk9ERToKICAgICAgICAgICAgY2FzZSBET0NVTUVOVF9GUkFHTUVOVF9OT0RFOiB7CiAgICAgICAgICAgICAgdHlwZSA9IG5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFID8gIiNkb2N1bWVudCIgOiAiI2ZyYWdtZW50IjsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSByb290Q29udGFpbmVySW5zdGFuY2UuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgICAgIG5hbWVzcGFjZSA9IHJvb3QzID8gcm9vdDMubmFtZXNwYWNlVVJJIDogZ2V0Q2hpbGROYW1lc3BhY2UobnVsbCwgIiIpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IG5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyByb290Q29udGFpbmVySW5zdGFuY2UucGFyZW50Tm9kZSA6IHJvb3RDb250YWluZXJJbnN0YW5jZTsKICAgICAgICAgICAgICB2YXIgb3duTmFtZXNwYWNlID0gY29udGFpbmVyMi5uYW1lc3BhY2VVUkkgfHwgbnVsbDsKICAgICAgICAgICAgICB0eXBlID0gY29udGFpbmVyMi50YWdOYW1lOwogICAgICAgICAgICAgIG5hbWVzcGFjZSA9IGdldENoaWxkTmFtZXNwYWNlKG93bk5hbWVzcGFjZSwgdHlwZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHZhbGlkYXRlZFRhZyA9IHR5cGUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgdmFyIGFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8obnVsbCwgdmFsaWRhdGVkVGFnKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBuYW1lc3BhY2UsCiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENoaWxkSG9zdENvbnRleHQocGFyZW50SG9zdENvbnRleHQsIHR5cGUsIHJvb3RDb250YWluZXJJbnN0YW5jZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcGFyZW50SG9zdENvbnRleHREZXYgPSBwYXJlbnRIb3N0Q29udGV4dDsKICAgICAgICAgICAgdmFyIG5hbWVzcGFjZSA9IGdldENoaWxkTmFtZXNwYWNlKHBhcmVudEhvc3RDb250ZXh0RGV2Lm5hbWVzcGFjZSwgdHlwZSk7CiAgICAgICAgICAgIHZhciBhbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKHBhcmVudEhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbywgdHlwZSk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICAgIGFuY2VzdG9ySW5mbwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQdWJsaWNJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlRm9yQ29tbWl0KGNvbnRhaW5lckluZm8pIHsKICAgICAgICAgIGV2ZW50c0VuYWJsZWQgPSBpc0VuYWJsZWQoKTsKICAgICAgICAgIHNlbGVjdGlvbkluZm9ybWF0aW9uID0gZ2V0U2VsZWN0aW9uSW5mb3JtYXRpb24oKTsKICAgICAgICAgIHZhciBhY3RpdmVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICBzZXRFbmFibGVkKGZhbHNlKTsKICAgICAgICAgIHJldHVybiBhY3RpdmVJbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRBZnRlckNvbW1pdChjb250YWluZXJJbmZvKSB7CiAgICAgICAgICByZXN0b3JlU2VsZWN0aW9uKHNlbGVjdGlvbkluZm9ybWF0aW9uKTsKICAgICAgICAgIHNldEVuYWJsZWQoZXZlbnRzRW5hYmxlZCk7CiAgICAgICAgICBldmVudHNFbmFibGVkID0gbnVsbDsKICAgICAgICAgIHNlbGVjdGlvbkluZm9ybWF0aW9uID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSW5zdGFuY2UodHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHZhciBwYXJlbnROYW1lc3BhY2U7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0Q29udGV4dERldiA9IGhvc3RDb250ZXh0OwogICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcodHlwZSwgbnVsbCwgaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wcy5jaGlsZHJlbiA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHZhciBzdHJpbmcgPSAiIiArIHByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBvd25BbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbywgdHlwZSk7CiAgICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKG51bGwsIHN0cmluZywgb3duQW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJlbnROYW1lc3BhY2UgPSBob3N0Q29udGV4dERldi5uYW1lc3BhY2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZG9tRWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQzOSh0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBwYXJlbnROYW1lc3BhY2UpOwogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgZG9tRWxlbWVudCk7CiAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgIHJldHVybiBkb21FbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRJbml0aWFsQ2hpbGQocGFyZW50SW5zdGFuY2UsIGNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5hcHBlbmRDaGlsZChjaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmFsaXplSW5pdGlhbENoaWxkcmVuKGRvbUVsZW1lbnQsIHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0KSB7CiAgICAgICAgICBzZXRJbml0aWFsUHJvcGVydGllcyhkb21FbGVtZW50LCB0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKTsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICByZXR1cm4gISFwcm9wcy5hdXRvRm9jdXM7CiAgICAgICAgICAgIGNhc2UgImltZyI6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVXBkYXRlKGRvbUVsZW1lbnQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdQcm9wcy5jaGlsZHJlbiAhPT0gdHlwZW9mIG9sZFByb3BzLmNoaWxkcmVuICYmICh0eXBlb2YgbmV3UHJvcHMuY2hpbGRyZW4gPT09ICJzdHJpbmciIHx8IHR5cGVvZiBuZXdQcm9wcy5jaGlsZHJlbiA9PT0gIm51bWJlciIpKSB7CiAgICAgICAgICAgICAgdmFyIHN0cmluZyA9ICIiICsgbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIG93bkFuY2VzdG9ySW5mbyA9IHVwZGF0ZWRBbmNlc3RvckluZm8oaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvLCB0eXBlKTsKICAgICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgc3RyaW5nLCBvd25BbmNlc3RvckluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlmZlByb3BlcnRpZXMoZG9tRWxlbWVudCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkU2V0VGV4dENvbnRlbnQodHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHJldHVybiB0eXBlID09PSAidGV4dGFyZWEiIHx8IHR5cGUgPT09ICJub3NjcmlwdCIgfHwgdHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAic3RyaW5nIiB8fCB0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJudW1iZXIiIHx8IHR5cGVvZiBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCA9PT0gIm9iamVjdCIgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT09IG51bGwgJiYgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwuX19odG1sICE9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVRleHRJbnN0YW5jZSh0ZXh0LCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0Q29udGV4dERldiA9IGhvc3RDb250ZXh0OwogICAgICAgICAgICB2YWxpZGF0ZURPTU5lc3RpbmcobnVsbCwgdGV4dCwgaG9zdENvbnRleHREZXYuYW5jZXN0b3JJbmZvKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0ZXh0Tm9kZSA9IGNyZWF0ZVRleHROb2RlKHRleHQsIHJvb3RDb250YWluZXJJbnN0YW5jZSk7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCB0ZXh0Tm9kZSk7CiAgICAgICAgICByZXR1cm4gdGV4dE5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRFdmVudFByaW9yaXR5KCkgewogICAgICAgICAgdmFyIGN1cnJlbnRFdmVudCA9IHdpbmRvdy5ldmVudDsKICAgICAgICAgIGlmIChjdXJyZW50RXZlbnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0RXZlbnRQcmlvcml0eShjdXJyZW50RXZlbnQudHlwZSk7CiAgICAgICAgfQogICAgICAgIHZhciBzY2hlZHVsZVRpbWVvdXQgPSB0eXBlb2Ygc2V0VGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IHNldFRpbWVvdXQgOiB2b2lkIDA7CiAgICAgICAgdmFyIGNhbmNlbFRpbWVvdXQgPSB0eXBlb2YgY2xlYXJUaW1lb3V0ID09PSAiZnVuY3Rpb24iID8gY2xlYXJUaW1lb3V0IDogdm9pZCAwOwogICAgICAgIHZhciBub1RpbWVvdXQgPSAtMTsKICAgICAgICB2YXIgbG9jYWxQcm9taXNlID0gdHlwZW9mIFByb21pc2UgPT09ICJmdW5jdGlvbiIgPyBQcm9taXNlIDogdm9pZCAwOwogICAgICAgIHZhciBzY2hlZHVsZU1pY3JvdGFzayA9IHR5cGVvZiBxdWV1ZU1pY3JvdGFzayA9PT0gImZ1bmN0aW9uIiA/IHF1ZXVlTWljcm90YXNrIDogdHlwZW9mIGxvY2FsUHJvbWlzZSAhPT0gInVuZGVmaW5lZCIgPyBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIGxvY2FsUHJvbWlzZS5yZXNvbHZlKG51bGwpLnRoZW4oY2FsbGJhY2spLmNhdGNoKGhhbmRsZUVycm9ySW5OZXh0VGljayk7CiAgICAgICAgfSA6IHNjaGVkdWxlVGltZW91dDsKICAgICAgICBmdW5jdGlvbiBoYW5kbGVFcnJvckluTmV4dFRpY2soZXJyb3IyKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TW91bnQoZG9tRWxlbWVudCwgdHlwZSwgbmV3UHJvcHMsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBpZiAobmV3UHJvcHMuYXV0b0ZvY3VzKSB7CiAgICAgICAgICAgICAgICBkb21FbGVtZW50LmZvY3VzKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAiaW1nIjogewogICAgICAgICAgICAgIGlmIChuZXdQcm9wcy5zcmMpIHsKICAgICAgICAgICAgICAgIGRvbUVsZW1lbnQuc3JjID0gbmV3UHJvcHMuc3JjOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0VXBkYXRlKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgdXBkYXRlUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgdXBkYXRlRmliZXJQcm9wcyhkb21FbGVtZW50LCBuZXdQcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCkgewogICAgICAgICAgc2V0VGV4dENvbnRlbnQoZG9tRWxlbWVudCwgIiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRUZXh0VXBkYXRlKHRleHRJbnN0YW5jZSwgb2xkVGV4dCwgbmV3VGV4dCkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9IG5ld1RleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGVuZENoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRDaGlsZFRvQ29udGFpbmVyKGNvbnRhaW5lcjIsIGNoaWxkKSB7CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZTsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgcGFyZW50Tm9kZSA9IGNvbnRhaW5lcjIucGFyZW50Tm9kZTsKICAgICAgICAgICAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGNvbnRhaW5lcjIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGFyZW50Tm9kZSA9IGNvbnRhaW5lcjI7CiAgICAgICAgICAgIHBhcmVudE5vZGUuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlYWN0Um9vdENvbnRhaW5lciA9IGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgIGlmICgocmVhY3RSb290Q29udGFpbmVyID09PSBudWxsIHx8IHJlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwKSAmJiBwYXJlbnROb2RlLm9uY2xpY2sgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQocGFyZW50Tm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydEJlZm9yZShwYXJlbnRJbnN0YW5jZSwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0SW5Db250YWluZXJCZWZvcmUoY29udGFpbmVyMiwgY2hpbGQsIGJlZm9yZUNoaWxkKSB7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoY2hpbGQsIGJlZm9yZUNoaWxkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIuaW5zZXJ0QmVmb3JlKGNoaWxkLCBiZWZvcmVDaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW92ZUNoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVDaGlsZEZyb21Db250YWluZXIoY29udGFpbmVyMiwgY2hpbGQpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgY29udGFpbmVyMi5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQoY2hpbGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhclN1c3BlbnNlQm91bmRhcnkocGFyZW50SW5zdGFuY2UsIHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBub2RlID0gc3VzcGVuc2VJbnN0YW5jZTsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHZhciBuZXh0Tm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLnJlbW92ZUNoaWxkKG5vZGUpOwogICAgICAgICAgICBpZiAobmV4dE5vZGUgJiYgbmV4dE5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBkYXRhID0gbmV4dE5vZGUuZGF0YTsKICAgICAgICAgICAgICBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfRU5EX0RBVEEpIHsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5yZW1vdmVDaGlsZChuZXh0Tm9kZSk7CiAgICAgICAgICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbmV4dE5vZGU7CiAgICAgICAgICB9IHdoaWxlIChub2RlKTsKICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyU3VzcGVuc2VCb3VuZGFyeUZyb21Db250YWluZXIoY29udGFpbmVyMiwgc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoY29udGFpbmVyMi5wYXJlbnROb2RlLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNsZWFyU3VzcGVuc2VCb3VuZGFyeShjb250YWluZXIyLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oY29udGFpbmVyMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZGVJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgIHZhciBzdHlsZTIgPSBpbnN0YW5jZS5zdHlsZTsKICAgICAgICAgIGlmICh0eXBlb2Ygc3R5bGUyLnNldFByb3BlcnR5ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHN0eWxlMi5zZXRQcm9wZXJ0eSgiZGlzcGxheSIsICJub25lIiwgImltcG9ydGFudCIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3R5bGUyLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhpZGVUZXh0SW5zdGFuY2UodGV4dEluc3RhbmNlKSB7CiAgICAgICAgICB0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlID0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuaGlkZUluc3RhbmNlKGluc3RhbmNlLCBwcm9wcykgewogICAgICAgICAgaW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgIHZhciBzdHlsZVByb3AgPSBwcm9wc1tTVFlMRSQxXTsKICAgICAgICAgIHZhciBkaXNwbGF5ID0gc3R5bGVQcm9wICE9PSB2b2lkIDAgJiYgc3R5bGVQcm9wICE9PSBudWxsICYmIHN0eWxlUHJvcC5oYXNPd25Qcm9wZXJ0eSgiZGlzcGxheSIpID8gc3R5bGVQcm9wLmRpc3BsYXkgOiBudWxsOwogICAgICAgICAgaW5zdGFuY2Uuc3R5bGUuZGlzcGxheSA9IGRhbmdlcm91c1N0eWxlVmFsdWUoImRpc3BsYXkiLCBkaXNwbGF5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5oaWRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9IHRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsZWFyQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgY29udGFpbmVyMi50ZXh0Q29udGVudCA9ICIiOwogICAgICAgICAgfSBlbHNlIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLmRvY3VtZW50RWxlbWVudCkgewogICAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQoY29udGFpbmVyMi5kb2N1bWVudEVsZW1lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVJbnN0YW5jZShpbnN0YW5jZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSAhPT0gRUxFTUVOVF9OT0RFIHx8IHR5cGUudG9Mb3dlckNhc2UoKSAhPT0gaW5zdGFuY2Uubm9kZU5hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShpbnN0YW5jZSwgdGV4dCkgewogICAgICAgICAgaWYgKHRleHQgPT09ICIiIHx8IGluc3RhbmNlLm5vZGVUeXBlICE9PSBURVhUX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKGluc3RhbmNlKSB7CiAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdXNwZW5zZUluc3RhbmNlUGVuZGluZyhpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGluc3RhbmNlLmRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZS5kYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2tFcnJvckRldGFpbHMoaW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBkYXRhc2V0ID0gaW5zdGFuY2UubmV4dFNpYmxpbmcgJiYgaW5zdGFuY2UubmV4dFNpYmxpbmcuZGF0YXNldDsKICAgICAgICAgIHZhciBkaWdlc3QsIG1lc3NhZ2UsIHN0YWNrOwogICAgICAgICAgaWYgKGRhdGFzZXQpIHsKICAgICAgICAgICAgZGlnZXN0ID0gZGF0YXNldC5kZ3N0OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWVzc2FnZSA9IGRhdGFzZXQubXNnOwogICAgICAgICAgICAgIHN0YWNrID0gZGF0YXNldC5zdGNrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbWVzc2FnZSwKICAgICAgICAgICAgICBkaWdlc3QsCiAgICAgICAgICAgICAgc3RhY2sKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTdXNwZW5zZUluc3RhbmNlUmV0cnkoaW5zdGFuY2UsIGNhbGxiYWNrKSB7CiAgICAgICAgICBpbnN0YW5jZS5fcmVhY3RSZXRyeSA9IGNhbGxiYWNrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZShub2RlKSB7CiAgICAgICAgICBmb3IgKDsgbm9kZSAhPSBudWxsOyBub2RlID0gbm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICB2YXIgbm9kZVR5cGUgPSBub2RlLm5vZGVUeXBlOwogICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgbm9kZURhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKG5vZGVEYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBIHx8IG5vZGVEYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZURhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZShpbnN0YW5jZS5uZXh0U2libGluZyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkKHBhcmVudEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUocGFyZW50SW5zdGFuY2UuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lcikgewogICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKHBhcmVudENvbnRhaW5lci5maXJzdENoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHBhcmVudEluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUocGFyZW50SW5zdGFuY2UubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlSW5zdGFuY2UoaW5zdGFuY2UsIHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBpbnN0YW5jZSk7CiAgICAgICAgICB1cGRhdGVGaWJlclByb3BzKGluc3RhbmNlLCBwcm9wcyk7CiAgICAgICAgICB2YXIgcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgcGFyZW50TmFtZXNwYWNlID0gaG9zdENvbnRleHREZXYubmFtZXNwYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZS5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICByZXR1cm4gZGlmZkh5ZHJhdGVkUHJvcGVydGllcyhpbnN0YW5jZSwgdHlwZSwgcHJvcHMsIHBhcmVudE5hbWVzcGFjZSwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZVRleHRJbnN0YW5jZSh0ZXh0SW5zdGFuY2UsIHRleHQsIGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHRleHRJbnN0YW5jZSk7CiAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChpbnRlcm5hbEluc3RhbmNlSGFuZGxlLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgIHJldHVybiBkaWZmSHlkcmF0ZWRUZXh0KHRleHRJbnN0YW5jZSwgdGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXROZXh0SHlkcmF0YWJsZUluc3RhbmNlQWZ0ZXJTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBub2RlID0gc3VzcGVuc2VJbnN0YW5jZS5uZXh0U2libGluZzsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlU2libGluZyhub2RlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBkZXB0aCsrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQYXJlbnRTdXNwZW5zZUluc3RhbmNlKHRhcmdldEluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHRhcmdldEluc3RhbmNlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgIHZhciBkZXB0aCA9IDA7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGRhdGEgPSBub2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEpIHsKICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlcHRoLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09PSBTVVNQRU5TRV9FTkRfREFUQSkgewogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEh5ZHJhdGVkQ29udGFpbmVyKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHJldHJ5SWZCbG9ja2VkT24oY29udGFpbmVyMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGREZWxldGVVbmh5ZHJhdGVkVGFpbEluc3RhbmNlcyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50VHlwZSAhPT0gImhlYWQiICYmIHBhcmVudFR5cGUgIT09ICJib2R5IjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90TWF0Y2hIeWRyYXRlZENvbnRhaW5lclRleHRJbnN0YW5jZShwYXJlbnRDb250YWluZXIsIHRleHRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgdmFyIHNob3VsZFdhcm5EZXYgPSB0cnVlOwogICAgICAgICAgY2hlY2tGb3JVbm1hdGNoZWRUZXh0KHRleHRJbnN0YW5jZS5ub2RlVmFsdWUsIHRleHQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RNYXRjaEh5ZHJhdGVkVGV4dEluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdGV4dEluc3RhbmNlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICBpZiAocGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgdmFyIHNob3VsZFdhcm5EZXYgPSB0cnVlOwogICAgICAgICAgICBjaGVja0ZvclVubWF0Y2hlZFRleHQodGV4dEluc3RhbmNlLm5vZGVWYWx1ZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnRDb250YWluZXIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Q29udGFpbmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudE5vZGUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGluc3RhbmNlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIDsKICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZVRleHQocGFyZW50Tm9kZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RIeWRyYXRlSW5zdGFuY2UocGFyZW50VHlwZSwgcGFyZW50UHJvcHMsIHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVFbGVtZW50KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudEluc3RhbmNlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0eXBlLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50Q29udGFpbmVyLCB0eXBlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnRDb250YWluZXIsIHRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudE5vZGUsIHR5cGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UocGFyZW50SW5zdGFuY2UsIHRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBwYXJlbnRJbnN0YW5jZS5wYXJlbnROb2RlOwogICAgICAgICAgICBpZiAocGFyZW50Tm9kZSAhPT0gbnVsbCkgd2FybkZvckluc2VydGVkSHlkcmF0ZWRUZXh0KHBhcmVudE5vZGUsIHRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdHlwZSwgcHJvcHMsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgfHwgcGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZEVsZW1lbnQocGFyZW50SW5zdGFuY2UsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNDb25jdXJyZW50TW9kZSB8fCBwYXJlbnRQcm9wc1tTVVBQUkVTU19IWURSQVRJT05fV0FSTklORyQxXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnRJbnN0YW5jZSwgdGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXJyb3JIeWRyYXRpbmdDb250YWluZXIocGFyZW50Q29udGFpbmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJBbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgaHlkcmF0aW9uLiBUaGUgc2VydmVyIEhUTUwgd2FzIHJlcGxhY2VkIHdpdGggY2xpZW50IGNvbnRlbnQgaW4gPCVzPi4iLCBwYXJlbnRDb250YWluZXIubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVQb3J0YWxNb3VudChwb3J0YWxJbnN0YW5jZSkgewogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocG9ydGFsSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICB2YXIgcmFuZG9tS2V5ID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc2xpY2UoMik7CiAgICAgICAgdmFyIGludGVybmFsSW5zdGFuY2VLZXkgPSAiX19yZWFjdEZpYmVyJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsUHJvcHNLZXkgPSAiX19yZWFjdFByb3BzJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXkgPSAiX19yZWFjdENvbnRhaW5lciQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXkgPSAiX19yZWFjdEV2ZW50cyQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlckxpc3RlbmVyc0tleSA9ICJfX3JlYWN0TGlzdGVuZXJzJCIgKyByYW5kb21LZXk7CiAgICAgICAgdmFyIGludGVybmFsRXZlbnRIYW5kbGVzU2V0S2V5ID0gIl9fcmVhY3RIYW5kbGVzJCIgKyByYW5kb21LZXk7CiAgICAgICAgZnVuY3Rpb24gZGV0YWNoRGVsZXRlZEluc3RhbmNlKG5vZGUpIHsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxQcm9wc0tleV07CiAgICAgICAgICBkZWxldGUgbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJMaXN0ZW5lcnNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXNTZXRLZXldOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVjYWNoZUZpYmVyTm9kZShob3N0SW5zdCwgbm9kZSkgewogICAgICAgICAgbm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XSA9IGhvc3RJbnN0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29udGFpbmVyQXNSb290KGhvc3RSb290LCBub2RlKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldID0gaG9zdFJvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVubWFya0NvbnRhaW5lckFzUm9vdChub2RlKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb250YWluZXJNYXJrZWRBc1Jvb3Qobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUodGFyZ2V0Tm9kZSkgewogICAgICAgICAgdmFyIHRhcmdldEluc3QgPSB0YXJnZXROb2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgaWYgKHRhcmdldEluc3QpIHsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IHRhcmdldE5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgIHdoaWxlIChwYXJlbnROb2RlKSB7CiAgICAgICAgICAgIHRhcmdldEluc3QgPSBwYXJlbnROb2RlW2ludGVybmFsQ29udGFpbmVySW5zdGFuY2VLZXldIHx8IHBhcmVudE5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV07CiAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IHRhcmdldEluc3QuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmICh0YXJnZXRJbnN0LmNoaWxkICE9PSBudWxsIHx8IGFsdGVybmF0ZSAhPT0gbnVsbCAmJiBhbHRlcm5hdGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZSh0YXJnZXROb2RlKTsKICAgICAgICAgICAgICAgIHdoaWxlIChzdXNwZW5zZUluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXRTdXNwZW5zZUluc3QgPSBzdXNwZW5zZUluc3RhbmNlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0U3VzcGVuc2VJbnN0KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldFN1c3BlbnNlSW5zdDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzdXNwZW5zZUluc3RhbmNlID0gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0Tm9kZSA9IHBhcmVudE5vZGU7CiAgICAgICAgICAgIHBhcmVudE5vZGUgPSB0YXJnZXROb2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SW5zdGFuY2VGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgaW5zdCA9IG5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV0gfHwgbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XTsKICAgICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICAgIGlmIChpbnN0LnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBpbnN0LnRhZyA9PT0gSG9zdFRleHQgfHwgaW5zdC50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50IHx8IGluc3QudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgIHJldHVybiBpbnN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Tm9kZUZyb21JbnN0YW5jZShpbnN0KSB7CiAgICAgICAgICBpZiAoaW5zdC50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgaW5zdC50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBpbnN0LnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZ2V0Tm9kZUZyb21JbnN0YW5jZTogSW52YWxpZCBhcmd1bWVudC4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZVtpbnRlcm5hbFByb3BzS2V5XSB8fCBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGaWJlclByb3BzKG5vZGUsIHByb3BzKSB7CiAgICAgICAgICBub2RlW2ludGVybmFsUHJvcHNLZXldID0gcHJvcHM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50TGlzdGVuZXJTZXQobm9kZSkgewogICAgICAgICAgdmFyIGVsZW1lbnRMaXN0ZW5lclNldCA9IG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJzS2V5XTsKICAgICAgICAgIGlmIChlbGVtZW50TGlzdGVuZXJTZXQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBlbGVtZW50TGlzdGVuZXJTZXQgPSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVyc0tleV0gPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnRMaXN0ZW5lclNldDsKICAgICAgICB9CiAgICAgICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXM0ID0gRnVuY3Rpb24uY2FsbC5iaW5kKGhhc093blByb3BlcnR5KTsKICAgICAgICAgICAgZm9yICh2YXIgdHlwZVNwZWNOYW1lIGluIHR5cGVTcGVjcykgewogICAgICAgICAgICAgIGlmIChoYXM0KHR5cGVTcGVjcywgdHlwZVNwZWNOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IEVycm9yKChjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIpICsgIjogIiArIGxvY2F0aW9uICsgIiB0eXBlIGAiICsgdHlwZVNwZWNOYW1lICsgImAgaXMgaW52YWxpZDsgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uLCB1c3VhbGx5IGZyb20gdGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLCBidXQgcmVjZWl2ZWQgYCIgKyB0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gKyAiYC5UaGlzIG9mdGVuIGhhcHBlbnMgYmVjYXVzZSBvZiB0eXBvcyBzdWNoIGFzIGBQcm9wVHlwZXMuZnVuY3Rpb25gIGluc3RlYWQgb2YgYFByb3BUeXBlcy5mdW5jYC4iKTsKICAgICAgICAgICAgICAgICAgICBlcnIubmFtZSA9ICJJbnZhcmlhbnQgVmlvbGF0aW9uIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdKHZhbHVlcywgdHlwZVNwZWNOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgbnVsbCwgIlNFQ1JFVF9ET19OT1RfUEFTU19USElTX09SX1lPVV9XSUxMX0JFX0ZJUkVEIik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICBlcnJvciQxID0gZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSAmJiAhKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvcikpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogdHlwZSBzcGVjaWZpY2F0aW9uIG9mICVzIGAlc2AgaXMgaW52YWxpZDsgdGhlIHR5cGUgY2hlY2tlciBmdW5jdGlvbiBtdXN0IHJldHVybiBgbnVsbGAgb3IgYW4gYEVycm9yYCBidXQgcmV0dXJuZWQgYSAlcy4gWW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBwYXNzIGFuIGFyZ3VtZW50IHRvIHRoZSB0eXBlIGNoZWNrZXIgY3JlYXRvciAoYXJyYXlPZiwgaW5zdGFuY2VPZiwgb2JqZWN0T2YsIG9uZU9mLCBvbmVPZlR5cGUsIGFuZCBzaGFwZSBhbGwgcmVxdWlyZSBhbiBhcmd1bWVudCkuIiwgY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiLCBsb2NhdGlvbiwgdHlwZVNwZWNOYW1lLCB0eXBlb2YgZXJyb3IkMSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvciAmJiAhKGVycm9yJDEubWVzc2FnZSBpbiBsb2dnZWRUeXBlRmFpbHVyZXMpKSB7CiAgICAgICAgICAgICAgICAgIGxvZ2dlZFR5cGVGYWlsdXJlc1tlcnJvciQxLm1lc3NhZ2VdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJGYWlsZWQgJXMgdHlwZTogJXMiLCBsb2NhdGlvbiwgZXJyb3IkMS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciB2YWx1ZVN0YWNrID0gW107CiAgICAgICAgdmFyIGZpYmVyU3RhY2s7CiAgICAgICAgewogICAgICAgICAgZmliZXJTdGFjayA9IFtdOwogICAgICAgIH0KICAgICAgICB2YXIgaW5kZXggPSAtMTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVDdXJzb3IoZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBjdXJyZW50OiBkZWZhdWx0VmFsdWUKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcChjdXJzb3IsIGZpYmVyKSB7CiAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCBwb3AuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoZmliZXIgIT09IGZpYmVyU3RhY2tbaW5kZXhdKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgRmliZXIgcG9wcGVkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjdXJzb3IuY3VycmVudCA9IHZhbHVlU3RhY2tbaW5kZXhdOwogICAgICAgICAgdmFsdWVTdGFja1tpbmRleF0gPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlclN0YWNrW2luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpbmRleC0tOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoKGN1cnNvciwgdmFsdWUsIGZpYmVyKSB7CiAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgdmFsdWVTdGFja1tpbmRleF0gPSBjdXJzb3IuY3VycmVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJTdGFja1tpbmRleF0gPSBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnNvci5jdXJyZW50ID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHQ7CiAgICAgICAgewogICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0ID0ge307CiAgICAgICAgfQogICAgICAgIHZhciBlbXB0eUNvbnRleHRPYmplY3QgPSB7fTsKICAgICAgICB7CiAgICAgICAgICBPYmplY3QuZnJlZXplKGVtcHR5Q29udGV4dE9iamVjdCk7CiAgICAgICAgfQogICAgICAgIHZhciBjb250ZXh0U3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoZW1wdHlDb250ZXh0T2JqZWN0KTsKICAgICAgICB2YXIgZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihmYWxzZSk7CiAgICAgICAgdmFyIHByZXZpb3VzQ29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICBmdW5jdGlvbiBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIGRpZFB1c2hPd25Db250ZXh0SWZQcm92aWRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkUHVzaE93bkNvbnRleHRJZlByb3ZpZGVyICYmIGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJldmlvdXNDb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0U3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FjaGVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0LCBtYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkVW5tYXNrZWRDaGlsZENvbnRleHQgPSB1bm1hc2tlZENvbnRleHQ7CiAgICAgICAgICAgIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0ID0gbWFza2VkQ29udGV4dDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICB2YXIgY29udGV4dFR5cGVzID0gdHlwZS5jb250ZXh0VHlwZXM7CiAgICAgICAgICAgIGlmICghY29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UgJiYgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRVbm1hc2tlZENoaWxkQ29udGV4dCA9PT0gdW5tYXNrZWRDb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWFza2VkQ2hpbGRDb250ZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb250ZXh0ID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBjb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICBjb250ZXh0W2tleV0gPSB1bm1hc2tlZENvbnRleHRba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzMikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNvbnRleHRUeXBlcywgY29udGV4dCwgImNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UpIHsKICAgICAgICAgICAgICBjYWNoZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQsIGNvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNDb250ZXh0Q2hhbmdlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb250ZXh0UHJvdmlkZXIodHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSB0eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICByZXR1cm4gY2hpbGRDb250ZXh0VHlwZXMgIT09IG51bGwgJiYgY2hpbGRDb250ZXh0VHlwZXMgIT09IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wQ29udGV4dChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFRvcExldmVsQ29udGV4dE9iamVjdChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hUb3BMZXZlbENvbnRleHRPYmplY3QoZmliZXIsIGNvbnRleHQsIGRpZENoYW5nZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQgIT09IGVtcHR5Q29udGV4dE9iamVjdCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBjb250ZXh0IGZvdW5kIG9uIHN0YWNrLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBjb250ZXh0LCBmaWJlcik7CiAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkQ2hhbmdlLCBmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NDaGlsZENvbnRleHQoZmliZXIsIHR5cGUsIHBhcmVudENvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0VHlwZXMgPSB0eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldENoaWxkQ29udGV4dCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgaWYgKCF3YXJuZWRBYm91dE1pc3NpbmdHZXRDaGlsZENvbnRleHRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzLmNoaWxkQ29udGV4dFR5cGVzIGlzIHNwZWNpZmllZCBidXQgdGhlcmUgaXMgbm8gZ2V0Q2hpbGRDb250ZXh0KCkgbWV0aG9kIG9uIHRoZSBpbnN0YW5jZS4gWW91IGNhbiBlaXRoZXIgZGVmaW5lIGdldENoaWxkQ29udGV4dCgpIG9uICVzIG9yIHJlbW92ZSBjaGlsZENvbnRleHRUeXBlcyBmcm9tIGl0LiIsIGNvbXBvbmVudE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGRDb250ZXh0ID0gaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0KCk7CiAgICAgICAgICAgIGZvciAodmFyIGNvbnRleHRLZXkgaW4gY2hpbGRDb250ZXh0KSB7CiAgICAgICAgICAgICAgaWYgKCEoY29udGV4dEtleSBpbiBjaGlsZENvbnRleHRUeXBlcykpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iKSArICcuZ2V0Q2hpbGRDb250ZXh0KCk6IGtleSAiJyArIGNvbnRleHRLZXkgKyAnIiBpcyBub3QgZGVmaW5lZCBpbiBjaGlsZENvbnRleHRUeXBlcy4nKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKGNoaWxkQ29udGV4dFR5cGVzLCBjaGlsZENvbnRleHQsICJjaGlsZCBjb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGFzc2lnbjIoe30sIHBhcmVudENvbnRleHQsIGNoaWxkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIHZhciBtZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCA9IGluc3RhbmNlICYmIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0IHx8IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgICAgcHJldmlvdXNDb250ZXh0ID0gY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yLCBtZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgcHVzaChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgdHlwZSwgZGlkQ2hhbmdlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmICghaW5zdGFuY2UpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYW4gaW5zdGFuY2UgYnkgdGhpcyBwb2ludC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkQ2hhbmdlKSB7CiAgICAgICAgICAgICAgdmFyIG1lcmdlZENvbnRleHQgPSBwcm9jZXNzQ2hpbGRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdHlwZSwgcHJldmlvdXNDb250ZXh0KTsKICAgICAgICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCA9IG1lcmdlZENvbnRleHQ7CiAgICAgICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciwgbWVyZ2VkQ29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwb3AoZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kQ3VycmVudFVubWFza2VkQ29udGV4dChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzRmliZXJNb3VudGVkKGZpYmVyKSB8fCBmaWJlci50YWcgIT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBzdWJ0cmVlIHBhcmVudCB0byBiZSBhIG1vdW50ZWQgY2xhc3MgY29tcG9uZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5vZGUudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGUuY29udGV4dDsKICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IG5vZGUudHlwZTsKICAgICAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGUuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQ7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfSB3aGlsZSAobm9kZSAhPT0gbnVsbCk7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRm91bmQgdW5leHBlY3RlZCBkZXRhY2hlZCBzdWJ0cmVlIHBhcmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIExlZ2FjeVJvb3QgPSAwOwogICAgICAgIHZhciBDb25jdXJyZW50Um9vdCA9IDE7CiAgICAgICAgdmFyIHN5bmNRdWV1ZSA9IG51bGw7CiAgICAgICAgdmFyIGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcyA9IGZhbHNlOwogICAgICAgIHZhciBpc0ZsdXNoaW5nU3luY1F1ZXVlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVTeW5jQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIGlmIChzeW5jUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgc3luY1F1ZXVlID0gW2NhbGxiYWNrXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN5bmNRdWV1ZS5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVMZWdhY3lTeW5jQ2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcyA9IHRydWU7CiAgICAgICAgICBzY2hlZHVsZVN5bmNDYWxsYmFjayhjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoU3luY0NhbGxiYWNrc09ubHlJbkxlZ2FjeU1vZGUoKSB7CiAgICAgICAgICBpZiAoaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzKSB7CiAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmNDYWxsYmFja3MoKSB7CiAgICAgICAgICBpZiAoIWlzRmx1c2hpbmdTeW5jUXVldWUgJiYgc3luY1F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlzRmx1c2hpbmdTeW5jUXVldWUgPSB0cnVlOwogICAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1VwZGF0ZVByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIGlzU3luYyA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gc3luY1F1ZXVlOwogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICAgIGZvciAoOyBpIDwgcXVldWUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHF1ZXVlW2ldOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrKGlzU3luYyk7CiAgICAgICAgICAgICAgICB9IHdoaWxlIChjYWxsYmFjayAhPT0gbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHN5bmNRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgaW5jbHVkZXNMZWdhY3lTeW5jQ2FsbGJhY2tzID0gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGlmIChzeW5jUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHN5bmNRdWV1ZSA9IHN5bmNRdWV1ZS5zbGljZShpICsgMSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2soSW1tZWRpYXRlUHJpb3JpdHksIGZsdXNoU3luY0NhbGxiYWNrcyk7CiAgICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1VwZGF0ZVByaW9yaXR5KTsKICAgICAgICAgICAgICBpc0ZsdXNoaW5nU3luY1F1ZXVlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgZm9ya1N0YWNrID0gW107CiAgICAgICAgdmFyIGZvcmtTdGFja0luZGV4ID0gMDsKICAgICAgICB2YXIgdHJlZUZvcmtQcm92aWRlciA9IG51bGw7CiAgICAgICAgdmFyIHRyZWVGb3JrQ291bnQgPSAwOwogICAgICAgIHZhciBpZFN0YWNrID0gW107CiAgICAgICAgdmFyIGlkU3RhY2tJbmRleCA9IDA7CiAgICAgICAgdmFyIHRyZWVDb250ZXh0UHJvdmlkZXIgPSBudWxsOwogICAgICAgIHZhciB0cmVlQ29udGV4dElkID0gMTsKICAgICAgICB2YXIgdHJlZUNvbnRleHRPdmVyZmxvdyA9ICIiOwogICAgICAgIGZ1bmN0aW9uIGlzRm9ya2VkQ2hpbGQod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIHJldHVybiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9ya2VkKSAhPT0gTm9GbGFnczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Rm9ya3NBdExldmVsKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICByZXR1cm4gdHJlZUZvcmtDb3VudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VHJlZUlkKCkgewogICAgICAgICAgdmFyIG92ZXJmbG93ID0gdHJlZUNvbnRleHRPdmVyZmxvdzsKICAgICAgICAgIHZhciBpZFdpdGhMZWFkaW5nQml0ID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgIHZhciBpZCA9IGlkV2l0aExlYWRpbmdCaXQgJiB+Z2V0TGVhZGluZ0JpdChpZFdpdGhMZWFkaW5nQml0KTsKICAgICAgICAgIHJldHVybiBpZC50b1N0cmluZygzMikgKyBvdmVyZmxvdzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFRyZWVGb3JrKHdvcmtJblByb2dyZXNzMiwgdG90YWxDaGlsZHJlbikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXgrK10gPSB0cmVlRm9ya0NvdW50OwogICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4KytdID0gdHJlZUZvcmtQcm92aWRlcjsKICAgICAgICAgIHRyZWVGb3JrUHJvdmlkZXIgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB0cmVlRm9ya0NvdW50ID0gdG90YWxDaGlsZHJlbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIsIHRvdGFsQ2hpbGRyZW4sIGluZGV4MikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0UHJvdmlkZXI7CiAgICAgICAgICB0cmVlQ29udGV4dFByb3ZpZGVyID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgdmFyIGJhc2VJZFdpdGhMZWFkaW5nQml0ID0gdHJlZUNvbnRleHRJZDsKICAgICAgICAgIHZhciBiYXNlT3ZlcmZsb3cgPSB0cmVlQ29udGV4dE92ZXJmbG93OwogICAgICAgICAgdmFyIGJhc2VMZW5ndGggPSBnZXRCaXRMZW5ndGgoYmFzZUlkV2l0aExlYWRpbmdCaXQpIC0gMTsKICAgICAgICAgIHZhciBiYXNlSWQgPSBiYXNlSWRXaXRoTGVhZGluZ0JpdCAmIH4oMSA8PCBiYXNlTGVuZ3RoKTsKICAgICAgICAgIHZhciBzbG90ID0gaW5kZXgyICsgMTsKICAgICAgICAgIHZhciBsZW5ndGggPSBnZXRCaXRMZW5ndGgodG90YWxDaGlsZHJlbikgKyBiYXNlTGVuZ3RoOwogICAgICAgICAgaWYgKGxlbmd0aCA+IDMwKSB7CiAgICAgICAgICAgIHZhciBudW1iZXJPZk92ZXJmbG93Qml0cyA9IGJhc2VMZW5ndGggLSBiYXNlTGVuZ3RoICUgNTsKICAgICAgICAgICAgdmFyIG5ld092ZXJmbG93Qml0cyA9ICgxIDw8IG51bWJlck9mT3ZlcmZsb3dCaXRzKSAtIDE7CiAgICAgICAgICAgIHZhciBuZXdPdmVyZmxvdyA9IChiYXNlSWQgJiBuZXdPdmVyZmxvd0JpdHMpLnRvU3RyaW5nKDMyKTsKICAgICAgICAgICAgdmFyIHJlc3RPZkJhc2VJZCA9IGJhc2VJZCA+PiBudW1iZXJPZk92ZXJmbG93Qml0czsKICAgICAgICAgICAgdmFyIHJlc3RPZkJhc2VMZW5ndGggPSBiYXNlTGVuZ3RoIC0gbnVtYmVyT2ZPdmVyZmxvd0JpdHM7CiAgICAgICAgICAgIHZhciByZXN0T2ZMZW5ndGggPSBnZXRCaXRMZW5ndGgodG90YWxDaGlsZHJlbikgKyByZXN0T2ZCYXNlTGVuZ3RoOwogICAgICAgICAgICB2YXIgcmVzdE9mTmV3Qml0cyA9IHNsb3QgPDwgcmVzdE9mQmFzZUxlbmd0aDsKICAgICAgICAgICAgdmFyIGlkID0gcmVzdE9mTmV3Qml0cyB8IHJlc3RPZkJhc2VJZDsKICAgICAgICAgICAgdmFyIG92ZXJmbG93ID0gbmV3T3ZlcmZsb3cgKyBiYXNlT3ZlcmZsb3c7CiAgICAgICAgICAgIHRyZWVDb250ZXh0SWQgPSAxIDw8IHJlc3RPZkxlbmd0aCB8IGlkOwogICAgICAgICAgICB0cmVlQ29udGV4dE92ZXJmbG93ID0gb3ZlcmZsb3c7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbmV3Qml0cyA9IHNsb3QgPDwgYmFzZUxlbmd0aDsKICAgICAgICAgICAgdmFyIF9pZCA9IG5ld0JpdHMgfCBiYXNlSWQ7CiAgICAgICAgICAgIHZhciBfb3ZlcmZsb3cgPSBiYXNlT3ZlcmZsb3c7CiAgICAgICAgICAgIHRyZWVDb250ZXh0SWQgPSAxIDw8IGxlbmd0aCB8IF9pZDsKICAgICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IF9vdmVyZmxvdzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gd29ya0luUHJvZ3Jlc3MyLnJldHVybjsKICAgICAgICAgIGlmIChyZXR1cm5GaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IDE7CiAgICAgICAgICAgIHZhciBzbG90SW5kZXggPSAwOwogICAgICAgICAgICBwdXNoVHJlZUZvcmsod29ya0luUHJvZ3Jlc3MyLCBudW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgcHVzaFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIsIG51bWJlck9mRm9ya3MsIHNsb3RJbmRleCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEJpdExlbmd0aChudW1iZXI0KSB7CiAgICAgICAgICByZXR1cm4gMzIgLSBjbHozMihudW1iZXI0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGVhZGluZ0JpdChpZCkgewogICAgICAgICAgcmV0dXJuIDEgPDwgZ2V0Qml0TGVuZ3RoKGlkKSAtIDE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzMiA9PT0gdHJlZUZvcmtQcm92aWRlcikgewogICAgICAgICAgICB0cmVlRm9ya1Byb3ZpZGVyID0gZm9ya1N0YWNrWy0tZm9ya1N0YWNrSW5kZXhdOwogICAgICAgICAgICBmb3JrU3RhY2tbZm9ya1N0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUZvcmtDb3VudCA9IGZvcmtTdGFja1stLWZvcmtTdGFja0luZGV4XTsKICAgICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAod29ya0luUHJvZ3Jlc3MyID09PSB0cmVlQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgIHRyZWVDb250ZXh0UHJvdmlkZXIgPSBpZFN0YWNrWy0taWRTdGFja0luZGV4XTsKICAgICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IGlkU3RhY2tbLS1pZFN0YWNrSW5kZXhdOwogICAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleF0gPSBudWxsOwogICAgICAgICAgICB0cmVlQ29udGV4dElkID0gaWRTdGFja1stLWlkU3RhY2tJbmRleF07CiAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbmRlZFRyZWVDb250ZXh0KCkgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZiAodHJlZUNvbnRleHRQcm92aWRlciAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGlkOiB0cmVlQ29udGV4dElkLAogICAgICAgICAgICAgIG92ZXJmbG93OiB0cmVlQ29udGV4dE92ZXJmbG93CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVN1c3BlbmRlZFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuZGVkQ29udGV4dCkgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleCsrXSA9IHRyZWVDb250ZXh0UHJvdmlkZXI7CiAgICAgICAgICB0cmVlQ29udGV4dElkID0gc3VzcGVuZGVkQ29udGV4dC5pZDsKICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBzdXNwZW5kZWRDb250ZXh0Lm92ZXJmbG93OwogICAgICAgICAgdHJlZUNvbnRleHRQcm92aWRlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmTm90SHlkcmF0aW5nKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdG8gYmUgaHlkcmF0aW5nLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsOwogICAgICAgIHZhciBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICB2YXIgaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICB2YXIgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiB3YXJuSWZIeWRyYXRpbmcoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0h5ZHJhdGluZykgewogICAgICAgICAgICAgIGVycm9yKCJXZSBzaG91bGQgbm90IGJlIGh5ZHJhdGluZyBoZXJlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhIGJ1Zy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWRTdXNwZW5kT3JFcnJvcldoaWxlSHlkcmF0aW5nREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGlkU3VzcGVuZE9yRXJyb3JERVY7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVudGVySHlkcmF0aW9uU3RhdGUoZmliZXIpIHsKICAgICAgICAgIHZhciBwYXJlbnRJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluQ29udGFpbmVyKHBhcmVudEluc3RhbmNlKTsKICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBudWxsOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVudGVySHlkcmF0aW9uU3RhdGVGcm9tRGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIsIHN1c3BlbnNlSW5zdGFuY2UsIHRyZWVDb250ZXh0KSB7CiAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGRXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgIGlzSHlkcmF0aW5nID0gdHJ1ZTsKICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IG51bGw7CiAgICAgICAgICBkaWRTdXNwZW5kT3JFcnJvckRFViA9IGZhbHNlOwogICAgICAgICAgaWYgKHRyZWVDb250ZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJlc3RvcmVTdXNwZW5kZWRUcmVlQ29udGV4dChmaWJlciwgdHJlZUNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluQ29udGFpbmVyKHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICBkaWROb3RIeWRyYXRlSW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLnR5cGUsCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLm1lbW9pemVkUHJvcHMsCiAgICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLnN0YXRlTm9kZSwKICAgICAgICAgICAgICAgICAgaW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgIGlzQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSByZXR1cm5GaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgZGlkTm90SHlkcmF0ZUluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWxldGVIeWRyYXRhYmxlSW5zdGFuY2UocmV0dXJuRmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB3YXJuVW5oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGNyZWF0ZUZpYmVyRnJvbUhvc3RJbnN0YW5jZUZvckRlbGV0aW9uKCk7CiAgICAgICAgICBjaGlsZFRvRGVsZXRlLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgY2hpbGRUb0RlbGV0ZS5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IFtjaGlsZFRvRGVsZXRlXTsKICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuTm9uaHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRPckVycm9yREVWKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgdmFyIHBhcmVudENvbnRhaW5lciA9IHJldHVybkZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdGV4dCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50VHlwZSA9IHJldHVybkZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGFyZW50UHJvcHMgPSByZXR1cm5GaWJlci5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgICB2YXIgX3Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50VHlwZSwKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICBfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgIF9wcm9wcywKICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF90ZXh0ID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBfaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICAgIF90ZXh0LAogICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICAgIF9pc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gcmV0dXJuRmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBfcGFyZW50SW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoX3BhcmVudEluc3RhbmNlICE9PSBudWxsKSBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgdmFyIF90eXBlMiA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9wcm9wczIgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UoX3BhcmVudEluc3RhbmNlLCBfdHlwZTIpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgICAgICAgIHZhciBfdGV4dDIgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKF9wYXJlbnRJbnN0YW5jZSwgX3RleHQyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE5vbkh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGZpYmVyKSB7CiAgICAgICAgICBmaWJlci5mbGFncyA9IGZpYmVyLmZsYWdzICYgfkh5ZHJhdGluZyB8IFBsYWNlbWVudDsKICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeUh5ZHJhdGUoZmliZXIsIG5leHRJbnN0YW5jZSkgewogICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBjYW5IeWRyYXRlSW5zdGFuY2UobmV4dEluc3RhbmNlLCB0eXBlKTsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB2YXIgdGV4dCA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gY2FuSHlkcmF0ZVRleHRJbnN0YW5jZShuZXh0SW5zdGFuY2UsIHRleHQpOwogICAgICAgICAgICAgIGlmICh0ZXh0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHRleHRJbnN0YW5jZTsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gY2FuSHlkcmF0ZVN1c3BlbnNlSW5zdGFuY2UobmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VJbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSB7CiAgICAgICAgICAgICAgICAgIGRlaHlkcmF0ZWQ6IHN1c3BlbnNlSW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgIHRyZWVDb250ZXh0OiBnZXRTdXNwZW5kZWRUcmVlQ29udGV4dCgpLAogICAgICAgICAgICAgICAgICByZXRyeUxhbmU6IE9mZnNjcmVlbkxhbmUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFN0YXRlID0gc3VzcGVuc2VTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21EZWh5ZHJhdGVkRnJhZ21lbnQoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBkZWh5ZHJhdGVkRnJhZ21lbnQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgICBmaWJlci5jaGlsZCA9IGRlaHlkcmF0ZWRGcmFnbWVudDsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgIHJldHVybiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlICYmIChmaWJlci5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goZmliZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSHlkcmF0aW9uIGZhaWxlZCBiZWNhdXNlIHRoZSBpbml0aWFsIFVJIGRvZXMgbm90IG1hdGNoIHdoYXQgd2FzIHJlbmRlcmVkIG9uIHRoZSBzZXJ2ZXIuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICBpZiAoIWlzSHlkcmF0aW5nKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0SW5zdGFuY2UgPSBuZXh0SHlkcmF0YWJsZUluc3RhbmNlOwogICAgICAgICAgaWYgKCFuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpKSB7CiAgICAgICAgICAgICAgd2Fybk5vbmh5ZHJhdGVkSW5zdGFuY2UoaHlkcmF0aW9uUGFyZW50RmliZXIsIGZpYmVyKTsKICAgICAgICAgICAgICB0aHJvd09uSHlkcmF0aW9uTWlzbWF0Y2goKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnNlcnROb25IeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdEF0dGVtcHRlZEluc3RhbmNlID0gbmV4dEluc3RhbmNlOwogICAgICAgICAgaWYgKCF0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDbGllbnRSZW5kZXJPbk1pc21hdGNoKGZpYmVyKSkgewogICAgICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEluc3RhbmNlID0gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpcnN0QXR0ZW1wdGVkSW5zdGFuY2UpOwogICAgICAgICAgICB2YXIgcHJldkh5ZHJhdGlvblBhcmVudEZpYmVyID0gaHlkcmF0aW9uUGFyZW50RmliZXI7CiAgICAgICAgICAgIGlmICghbmV4dEluc3RhbmNlIHx8ICF0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgaW5zZXJ0Tm9uSHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKHByZXZIeWRyYXRpb25QYXJlbnRGaWJlciwgZmlyc3RBdHRlbXB0ZWRJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2UoZmliZXIsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBzaG91bGRXYXJuSWZNaXNtYXRjaERldiA9ICFkaWRTdXNwZW5kT3JFcnJvckRFVjsKICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gaHlkcmF0ZUluc3RhbmNlKGluc3RhbmNlLCBmaWJlci50eXBlLCBmaWJlci5tZW1vaXplZFByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBmaWJlciwgc2hvdWxkV2FybklmTWlzbWF0Y2hEZXYpOwogICAgICAgICAgZmliZXIudXBkYXRlUXVldWUgPSB1cGRhdGVQYXlsb2FkOwogICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0VGV4dEluc3RhbmNlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgdGV4dEluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIHRleHRDb250ZW50ID0gZmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBoeWRyYXRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSwgdGV4dENvbnRlbnQsIGZpYmVyKTsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gaHlkcmF0aW9uUGFyZW50RmliZXI7CiAgICAgICAgICAgIGlmIChyZXR1cm5GaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocmV0dXJuRmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRDb250YWluZXIgPSByZXR1cm5GaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgICBkaWROb3RNYXRjaEh5ZHJhdGVkQ29udGFpbmVyVGV4dEluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgIHBhcmVudENvbnRhaW5lciwKICAgICAgICAgICAgICAgICAgICB0ZXh0SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgdGV4dENvbnRlbnQsCiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUeXBlID0gcmV0dXJuRmliZXIudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFByb3BzID0gcmV0dXJuRmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEluc3RhbmNlID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB2YXIgX2lzQ29uY3VycmVudE1vZGUyID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgZGlkTm90TWF0Y2hIeWRyYXRlZFRleHRJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgICBwYXJlbnRUeXBlLAogICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgIHRleHRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICB0ZXh0Q29udGVudCwKICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICAgIF9pc0NvbmN1cnJlbnRNb2RlMgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzaG91bGRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb0h5ZHJhdGVIb3N0U3VzcGVuc2VJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlICE9PSBudWxsID8gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkIDogbnVsbDsKICAgICAgICAgIGlmICghc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYSBoeWRyYXRlZCBzdXNwZW5zZSBpbnN0YW5jZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2tpcFBhc3REZWh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBzdXNwZW5zZVN0YXRlICE9PSBudWxsID8gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkIDogbnVsbDsKICAgICAgICAgIGlmICghc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGhhdmUgYSBoeWRyYXRlZCBzdXNwZW5zZSBpbnN0YW5jZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZUluc3RhbmNlQWZ0ZXJTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCAmJiBwYXJlbnQudGFnICE9PSBIb3N0Q29tcG9uZW50ICYmIHBhcmVudC50YWcgIT09IEhvc3RSb290ICYmIHBhcmVudC50YWcgIT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IHBhcmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wSHlkcmF0aW9uU3RhdGUoZmliZXIpIHsKICAgICAgICAgIGlmIChmaWJlciAhPT0gaHlkcmF0aW9uUGFyZW50RmliZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZykgewogICAgICAgICAgICBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKTsKICAgICAgICAgICAgaXNIeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBIb3N0Um9vdCAmJiAoZmliZXIudGFnICE9PSBIb3N0Q29tcG9uZW50IHx8IHNob3VsZERlbGV0ZVVuaHlkcmF0ZWRUYWlsSW5zdGFuY2VzKGZpYmVyLnR5cGUpICYmICFzaG91bGRTZXRUZXh0Q29udGVudChmaWJlci50eXBlLCBmaWJlci5tZW1vaXplZFByb3BzKSkpIHsKICAgICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICAgIGlmIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICBpZiAoc2hvdWxkQ2xpZW50UmVuZGVyT25NaXNtYXRjaChmaWJlcikpIHsKICAgICAgICAgICAgICAgIHdhcm5JZlVuaHlkcmF0ZWRUYWlsTm9kZXMoZmliZXIpOwogICAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdoaWxlIChuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKGZpYmVyLCBuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICBuZXh0SW5zdGFuY2UgPSBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcobmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHBvcFRvTmV4dEhvc3RQYXJlbnQoZmliZXIpOwogICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IHNraXBQYXN0RGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGh5ZHJhdGlvblBhcmVudEZpYmVyID8gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGZpYmVyLnN0YXRlTm9kZSkgOiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1VuaHlkcmF0ZWRUYWlsTm9kZXMoKSB7CiAgICAgICAgICByZXR1cm4gaXNIeWRyYXRpbmcgJiYgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSAhPT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmVW5oeWRyYXRlZFRhaWxOb2RlcyhmaWJlcikgewogICAgICAgICAgdmFyIG5leHRJbnN0YW5jZSA9IG5leHRIeWRyYXRhYmxlSW5zdGFuY2U7CiAgICAgICAgICB3aGlsZSAobmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgIHdhcm5Vbmh5ZHJhdGVkSW5zdGFuY2UoZmliZXIsIG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhuZXh0SW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEh5ZHJhdGlvblN0YXRlKCkgewogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBudWxsOwogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKSB7CiAgICAgICAgICBpZiAoaHlkcmF0aW9uRXJyb3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlUmVjb3ZlcmFibGVFcnJvcnMoaHlkcmF0aW9uRXJyb3JzKTsKICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SXNIeWRyYXRpbmcoKSB7CiAgICAgICAgICByZXR1cm4gaXNIeWRyYXRpbmc7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlSHlkcmF0aW9uRXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICBpZiAoaHlkcmF0aW9uRXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IFtlcnJvcjJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaHlkcmF0aW9uRXJyb3JzLnB1c2goZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZzsKICAgICAgICB2YXIgTm9UcmFuc2l0aW9uID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSB7CiAgICAgICAgICByZXR1cm4gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMS50cmFuc2l0aW9uOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MgPSB7CiAgICAgICAgICByZWNvcmRVbnNhZmVMaWZlY3ljbGVXYXJuaW5nczogZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB9LAogICAgICAgICAgZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3M6IGZ1bmN0aW9uKCkgewogICAgICAgICAgfSwKICAgICAgICAgIHJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nOiBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgIH0sCiAgICAgICAgICBmbHVzaExlZ2FjeUNvbnRleHRXYXJuaW5nOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0sCiAgICAgICAgICBkaXNjYXJkUGVuZGluZ1dhcm5pbmdzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHZhciBmaW5kU3RyaWN0Um9vdCA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciBtYXliZVN0cmljdFJvb3QgPSBudWxsOwogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBtYXliZVN0cmljdFJvb3QgPSBub2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG1heWJlU3RyaWN0Um9vdDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgc2V0VG9Tb3J0ZWRTdHJpbmcgPSBmdW5jdGlvbihzZXQ0KSB7CiAgICAgICAgICAgIHZhciBhcnJheSA9IFtdOwogICAgICAgICAgICBzZXQ0LmZvckVhY2goZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBhcnJheS5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiBhcnJheS5zb3J0KCkuam9pbigiLCAiKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MgPSBmdW5jdGlvbihmaWJlciwgaW5zdGFuY2UpIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuaGFzKGZpYmVyLnR5cGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iICYmIC8vIERvbid0IHdhcm4gYWJvdXQgcmVhY3QtbGlmZWN5Y2xlcy1jb21wYXQgcG9seWZpbGxlZCBjb21wb25lbnRzLgogICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzLl9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSAmJiB0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZS5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5mbHVzaFBlbmRpbmdVbnNhZmVMaWZlY3ljbGVXYXJuaW5ncyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIGVycm9yKCJVc2luZyBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IGluIHN0cmljdCBtb2RlIGlzIG5vdCByZWNvbW1lbmRlZCBhbmQgbWF5IGluZGljYXRlIGJ1Z3MgaW4geW91ciBjb2RlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGNvZGUgd2l0aCBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkTW91bnQsIGFuZCBzZXQgaW5pdGlhbCBzdGF0ZSBpbiB0aGUgY29uc3RydWN0b3IuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIHNvcnRlZE5hbWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgaW4gc3RyaWN0IG1vZGUgaXMgbm90IHJlY29tbWVuZGVkIGFuZCBtYXkgaW5kaWNhdGUgYnVncyBpbiB5b3VyIGNvZGUuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG4qIElmIHlvdSdyZSB1cGRhdGluZyBzdGF0ZSB3aGVuZXZlciBwcm9wcyBjaGFuZ2UsIHJlZmFjdG9yIHlvdXIgY29kZSB0byB1c2UgbWVtb2l6YXRpb24gdGVjaG5pcXVlcyBvciBtb3ZlIGl0IHRvIHN0YXRpYyBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIExlYXJuIG1vcmUgYXQ6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9kZXJpdmVkLXN0YXRlXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzMiA9IHNldFRvU29ydGVkU3RyaW5nKFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIGVycm9yKCJVc2luZyBVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSBpbiBzdHJpY3QgbW9kZSBpcyBub3QgcmVjb21tZW5kZWQgYW5kIG1heSBpbmRpY2F0ZSBidWdzIGluIHlvdXIgY29kZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczMgPSBzZXRUb1NvcnRlZFN0cmluZyhjb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybjMoImNvbXBvbmVudFdpbGxNb3VudCBoYXMgYmVlbiByZW5hbWVkLCBhbmQgaXMgbm90IHJlY29tbWVuZGVkIGZvciB1c2UuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgY29kZSB3aXRoIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRNb3VudCwgYW5kIHNldCBpbml0aWFsIHN0YXRlIGluIHRoZSBjb25zdHJ1Y3Rvci5cbiogUmVuYW1lIGNvbXBvbmVudFdpbGxNb3VudCB0byBVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IHRvIHN1cHByZXNzIHRoaXMgd2FybmluZyBpbiBub24tc3RyaWN0IG1vZGUuIEluIFJlYWN0IDE4LngsIG9ubHkgdGhlIFVOU0FGRV8gbmFtZSB3aWxsIHdvcmsuIFRvIHJlbmFtZSBhbGwgZGVwcmVjYXRlZCBsaWZlY3ljbGVzIHRvIHRoZWlyIG5ldyBuYW1lcywgeW91IGNhbiBydW4gYG5weCByZWFjdC1jb2RlbW9kIHJlbmFtZS11bnNhZmUtbGlmZWN5Y2xlc2AgaW4geW91ciBwcm9qZWN0IHNvdXJjZSBmb2xkZXIuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzNCA9IHNldFRvU29ydGVkU3RyaW5nKGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgd2FybjMoImNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgaGFzIGJlZW4gcmVuYW1lZCwgYW5kIGlzIG5vdCByZWNvbW1lbmRlZCBmb3IgdXNlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGRhdGEgZmV0Y2hpbmcgY29kZSBvciBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkVXBkYXRlLlxuKiBJZiB5b3UncmUgdXBkYXRpbmcgc3RhdGUgd2hlbmV2ZXIgcHJvcHMgY2hhbmdlLCByZWZhY3RvciB5b3VyIGNvZGUgdG8gdXNlIG1lbW9pemF0aW9uIHRlY2huaXF1ZXMgb3IgbW92ZSBpdCB0byBzdGF0aWMgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBMZWFybiBtb3JlIGF0OiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZGVyaXZlZC1zdGF0ZVxuKiBSZW5hbWUgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyB0byBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyB0byBzdXBwcmVzcyB0aGlzIHdhcm5pbmcgaW4gbm9uLXN0cmljdCBtb2RlLiBJbiBSZWFjdCAxOC54LCBvbmx5IHRoZSBVTlNBRkVfIG5hbWUgd2lsbCB3b3JrLiBUbyByZW5hbWUgYWxsIGRlcHJlY2F0ZWQgbGlmZWN5Y2xlcyB0byB0aGVpciBuZXcgbmFtZXMsIHlvdSBjYW4gcnVuIGBucHggcmVhY3QtY29kZW1vZCByZW5hbWUtdW5zYWZlLWxpZmVjeWNsZXNgIGluIHlvdXIgcHJvamVjdCBzb3VyY2UgZm9sZGVyLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBfc29ydGVkTmFtZXM0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczUgPSBzZXRUb1NvcnRlZFN0cmluZyhjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIHdhcm4zKCJjb21wb25lbnRXaWxsVXBkYXRlIGhhcyBiZWVuIHJlbmFtZWQsIGFuZCBpcyBub3QgcmVjb21tZW5kZWQgZm9yIHVzZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cbiogUmVuYW1lIGNvbXBvbmVudFdpbGxVcGRhdGUgdG8gVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgdG8gc3VwcHJlc3MgdGhpcyB3YXJuaW5nIGluIG5vbi1zdHJpY3QgbW9kZS4gSW4gUmVhY3QgMTgueCwgb25seSB0aGUgVU5TQUZFXyBuYW1lIHdpbGwgd29yay4gVG8gcmVuYW1lIGFsbCBkZXByZWNhdGVkIGxpZmVjeWNsZXMgdG8gdGhlaXIgbmV3IG5hbWVzLCB5b3UgY2FuIHJ1biBgbnB4IHJlYWN0LWNvZGVtb2QgcmVuYW1lLXVuc2FmZS1saWZlY3ljbGVzYCBpbiB5b3VyIHByb2plY3Qgc291cmNlIGZvbGRlci5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nID0gZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciBzdHJpY3RSb290ID0gZmluZFN0cmljdFJvb3QoZmliZXIpOwogICAgICAgICAgICBpZiAoc3RyaWN0Um9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB0byBmaW5kIGEgU3RyaWN0TW9kZSBjb21wb25lbnQgaW4gYSBzdHJpY3QgbW9kZSB0cmVlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dC5oYXMoZmliZXIudHlwZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHdhcm5pbmdzRm9yUm9vdCA9IHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5nZXQoc3RyaWN0Um9vdCk7CiAgICAgICAgICAgIGlmIChmaWJlci50eXBlLmNvbnRleHRUeXBlcyAhPSBudWxsIHx8IGZpYmVyLnR5cGUuY2hpbGRDb250ZXh0VHlwZXMgIT0gbnVsbCB8fCBpbnN0YW5jZSAhPT0gbnVsbCAmJiB0eXBlb2YgaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHdhcm5pbmdzRm9yUm9vdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB3YXJuaW5nc0ZvclJvb3QgPSBbXTsKICAgICAgICAgICAgICAgIHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZy5zZXQoc3RyaWN0Um9vdCwgd2FybmluZ3NGb3JSb290KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2FybmluZ3NGb3JSb290LnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hMZWdhY3lDb250ZXh0V2FybmluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcuZm9yRWFjaChmdW5jdGlvbihmaWJlckFycmF5LCBzdHJpY3RSb290KSB7CiAgICAgICAgICAgICAgaWYgKGZpYmVyQXJyYXkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBmaXJzdEZpYmVyID0gZmliZXJBcnJheVswXTsKICAgICAgICAgICAgICB2YXIgdW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIGZpYmVyQXJyYXkuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgdW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciBzb3J0ZWROYW1lcyA9IHNldFRvU29ydGVkU3RyaW5nKHVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpcnN0RmliZXIpOwogICAgICAgICAgICAgICAgZXJyb3IoIkxlZ2FjeSBjb250ZXh0IEFQSSBoYXMgYmVlbiBkZXRlY3RlZCB3aXRoaW4gYSBzdHJpY3QtbW9kZSB0cmVlLlxuXG5UaGUgb2xkIEFQSSB3aWxsIGJlIHN1cHBvcnRlZCBpbiBhbGwgMTYueCByZWxlYXNlcywgYnV0IGFwcGxpY2F0aW9ucyB1c2luZyBpdCBzaG91bGQgbWlncmF0ZSB0byB0aGUgbmV3IHZlcnNpb24uXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlc1xuXG5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBzb3J0ZWROYW1lcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5kaXNjYXJkUGVuZGluZ1dhcm5pbmdzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1hcHM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdlbmVyYXRvcnM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0cmluZ1JlZnM7CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZzsKICAgICAgICB2YXIgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nOwogICAgICAgIHZhciB3YXJuRm9yTWlzc2luZ0tleSA9IGZ1bmN0aW9uKGNoaWxkLCByZXR1cm5GaWJlcikgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0R2VuZXJhdG9ycyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmcyA9IHt9OwogICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgICBvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmcgPSB7fTsKICAgICAgICAgIHdhcm5Gb3JNaXNzaW5nS2V5ID0gZnVuY3Rpb24oY2hpbGQsIHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgIGlmIChjaGlsZCA9PT0gbnVsbCB8fCB0eXBlb2YgY2hpbGQgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghY2hpbGQuX3N0b3JlIHx8IGNoaWxkLl9zdG9yZS52YWxpZGF0ZWQgfHwgY2hpbGQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBjaGlsZC5fc3RvcmUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdCBDb21wb25lbnQgaW4gd2FybkZvck1pc3NpbmdLZXkgc2hvdWxkIGhhdmUgYSBfc3RvcmUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIGlmIChvd25lckhhc0tleVVzZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoJ0VhY2ggY2hpbGQgaW4gYSBsaXN0IHNob3VsZCBoYXZlIGEgdW5pcXVlICJrZXkiIHByb3AuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvd2FybmluZy1rZXlzIGZvciBtb3JlIGluZm9ybWF0aW9uLicpOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSZWFjdENsYXNzKHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlLnByb3RvdHlwZSAmJiB0eXBlLnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnQ0LCBlbGVtZW50KSB7CiAgICAgICAgICB2YXIgbWl4ZWRSZWYgPSBlbGVtZW50LnJlZjsKICAgICAgICAgIGlmIChtaXhlZFJlZiAhPT0gbnVsbCAmJiB0eXBlb2YgbWl4ZWRSZWYgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIG1peGVkUmVmICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKChyZXR1cm5GaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSB8fCB3YXJuQWJvdXRTdHJpbmdSZWZzKSAmJiAvLyBXZSB3YXJuIGluIFJlYWN0RWxlbWVudC5qcyBpZiBvd25lciBhbmQgc2VsZiBhcmUgZXF1YWwgZm9yIHN0cmluZyByZWZzCiAgICAgICAgICAgICAgLy8gYmVjYXVzZSB0aGVzZSBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gYW4gYXJyb3cgZnVuY3Rpb24KICAgICAgICAgICAgICAvLyB1c2luZyBhIGNvZGVtb2QuIFRoZXJlZm9yZSwgd2UgZG9uJ3QgaGF2ZSB0byB3YXJuIGFib3V0IHN0cmluZyByZWZzIGFnYWluLgogICAgICAgICAgICAgICEoZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fc2VsZiAmJiBlbGVtZW50Ll9vd25lci5zdGF0ZU5vZGUgIT09IGVsZW1lbnQuX3NlbGYpICYmIC8vIFdpbGwgYWxyZWFkeSB0aHJvdyB3aXRoICJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHN0cmluZyByZWZzIgogICAgICAgICAgICAgICEoZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fb3duZXIudGFnICE9PSBDbGFzc0NvbXBvbmVudCkgJiYgLy8gV2lsbCBhbHJlYWR5IHdhcm4gd2l0aCAiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgYmUgZ2l2ZW4gcmVmcyIKICAgICAgICAgICAgICAhKHR5cGVvZiBlbGVtZW50LnR5cGUgPT09ICJmdW5jdGlvbiIgJiYgIWlzUmVhY3RDbGFzcyhlbGVtZW50LnR5cGUpKSAmJiAvLyBXaWxsIGFscmVhZHkgdGhyb3cgd2l0aCAiRWxlbWVudCByZWYgd2FzIHNwZWNpZmllZCBhcyBhIHN0cmluZyAoc29tZVN0cmluZ1JlZikgYnV0IG5vIG93bmVyIHdhcyBzZXQiCiAgICAgICAgICAgICAgZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCdDb21wb25lbnQgIiVzIiBjb250YWlucyB0aGUgc3RyaW5nIHJlZiAiJXMiLiBTdXBwb3J0IGZvciBzdHJpbmcgcmVmcyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gV2UgcmVjb21tZW5kIHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBjb21wb25lbnROYW1lLCBtaXhlZFJlZik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlbGVtZW50Ll9vd25lcikgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBpbnN0OwogICAgICAgICAgICAgIGlmIChvd25lcikgewogICAgICAgICAgICAgICAgdmFyIG93bmVyRmliZXIgPSBvd25lcjsKICAgICAgICAgICAgICAgIGlmIChvd25lckZpYmVyLnRhZyAhPT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJGdW5jdGlvbiBjb21wb25lbnRzIGNhbm5vdCBoYXZlIHN0cmluZyByZWZzLiBXZSByZWNvbW1lbmQgdXNpbmcgdXNlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5zdCA9IG93bmVyRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWluc3QpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBvd25lciBmb3Igc3RyaW5nIHJlZiAiICsgbWl4ZWRSZWYgKyAiLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRJbnN0ID0gaW5zdDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BTdHJpbmdDb2VyY2lvbihtaXhlZFJlZiwgInJlZiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgc3RyaW5nUmVmID0gIiIgKyBtaXhlZFJlZjsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgY3VycmVudDQucmVmICE9PSBudWxsICYmIHR5cGVvZiBjdXJyZW50NC5yZWYgPT09ICJmdW5jdGlvbiIgJiYgY3VycmVudDQucmVmLl9zdHJpbmdSZWYgPT09IHN0cmluZ1JlZikgewogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQ0LnJlZjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlZiA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVmcyA9IHJlc29sdmVkSW5zdC5yZWZzOwogICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZSByZWZzW3N0cmluZ1JlZl07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZWZzW3N0cmluZ1JlZl0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHJlZi5fc3RyaW5nUmVmID0gc3RyaW5nUmVmOwogICAgICAgICAgICAgIHJldHVybiByZWY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtaXhlZFJlZiAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgcmVmIHRvIGJlIGEgZnVuY3Rpb24sIGEgc3RyaW5nLCBhbiBvYmplY3QgcmV0dXJuZWQgYnkgUmVhY3QuY3JlYXRlUmVmKCksIG9yIG51bGwuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCByZWYgd2FzIHNwZWNpZmllZCBhcyBhIHN0cmluZyAoIiArIG1peGVkUmVmICsgIikgYnV0IG5vIG93bmVyIHdhcyBzZXQuIFRoaXMgY291bGQgaGFwcGVuIGZvciBvbmUgb2YgdGhlIGZvbGxvd2luZyByZWFzb25zOlxuMS4gWW91IG1heSBiZSBhZGRpbmcgYSByZWYgdG8gYSBmdW5jdGlvbiBjb21wb25lbnRcbjIuIFlvdSBtYXkgYmUgYWRkaW5nIGEgcmVmIHRvIGEgY29tcG9uZW50IHRoYXQgd2FzIG5vdCBjcmVhdGVkIGluc2lkZSBhIGNvbXBvbmVudCdzIHJlbmRlciBtZXRob2RcbjMuIFlvdSBoYXZlIG11bHRpcGxlIGNvcGllcyBvZiBSZWFjdCBsb2FkZWRcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVmcy1tdXN0LWhhdmUtb3duZXIgZm9yIG1vcmUgaW5mb3JtYXRpb24uIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWl4ZWRSZWY7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpIHsKICAgICAgICAgIHZhciBjaGlsZFN0cmluZyA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChuZXdDaGlsZCk7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk9iamVjdHMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkIChmb3VuZDogIiArIChjaGlsZFN0cmluZyA9PT0gIltvYmplY3QgT2JqZWN0XSIgPyAib2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKG5ld0NoaWxkKS5qb2luKCIsICIpICsgIn0iIDogY2hpbGRTdHJpbmcpICsgIikuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBjb2xsZWN0aW9uIG9mIGNoaWxkcmVuLCB1c2UgYW4gYXJyYXkgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihyZXR1cm5GaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgIGlmIChvd25lckhhc0Z1bmN0aW9uVHlwZVdhcm5pbmdbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIkZ1bmN0aW9ucyBhcmUgbm90IHZhbGlkIGFzIGEgUmVhY3QgY2hpbGQuIFRoaXMgbWF5IGhhcHBlbiBpZiB5b3UgcmV0dXJuIGEgQ29tcG9uZW50IGluc3RlYWQgb2YgPENvbXBvbmVudCAvPiBmcm9tIHJlbmRlci4gT3IgbWF5YmUgeW91IG1lYW50IHRvIGNhbGwgdGhpcyBmdW5jdGlvbiByYXRoZXIgdGhhbiByZXR1cm4gaXQuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVMYXp5KGxhenlUeXBlKSB7CiAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlUeXBlLl9wYXlsb2FkOwogICAgICAgICAgdmFyIGluaXQgPSBsYXp5VHlwZS5faW5pdDsKICAgICAgICAgIHJldHVybiBpbml0KHBheWxvYWQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBDaGlsZFJlY29uY2lsZXIoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgZnVuY3Rpb24gZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpIHsKICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSByZXR1cm5GaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgIGlmIChkZWxldGlvbnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5kZWxldGlvbnMgPSBbY2hpbGRUb0RlbGV0ZV07CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKSB7CiAgICAgICAgICAgIGlmICghc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjaGlsZFRvRGVsZXRlID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZFRvRGVsZXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgICAgIGNoaWxkVG9EZWxldGUgPSBjaGlsZFRvRGVsZXRlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGRyZW4gPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoZXhpc3RpbmdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChleGlzdGluZ0NoaWxkLmtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5zZXQoZXhpc3RpbmdDaGlsZC5rZXksIGV4aXN0aW5nQ2hpbGQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLnNldChleGlzdGluZ0NoaWxkLmluZGV4LCBleGlzdGluZ0NoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZCA9IGV4aXN0aW5nQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXhpc3RpbmdDaGlsZHJlbjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVzZUZpYmVyKGZpYmVyLCBwZW5kaW5nUHJvcHMpIHsKICAgICAgICAgICAgdmFyIGNsb25lID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoZmliZXIsIHBlbmRpbmdQcm9wcyk7CiAgICAgICAgICAgIGNsb25lLmluZGV4ID0gMDsKICAgICAgICAgICAgY2xvbmUuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiBjbG9uZTsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBsYWNlQ2hpbGQobmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SW5kZXgpIHsKICAgICAgICAgICAgbmV3RmliZXIuaW5kZXggPSBuZXdJbmRleDsKICAgICAgICAgICAgaWYgKCFzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gRm9ya2VkOwogICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gbmV3RmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgb2xkSW5kZXggPSBjdXJyZW50NC5pbmRleDsKICAgICAgICAgICAgICBpZiAob2xkSW5kZXggPCBsYXN0UGxhY2VkSW5kZXgpIHsKICAgICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBvbGRJbmRleDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICAgIHJldHVybiBsYXN0UGxhY2VkSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHBsYWNlU2luZ2xlQ2hpbGQobmV3RmliZXIpIHsKICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMgJiYgbmV3RmliZXIuYWx0ZXJuYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV3RmliZXIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXdGaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBjdXJyZW50NCwgdGV4dENvbnRlbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC50YWcgIT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KHRleHRDb250ZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50NCwgdGV4dENvbnRlbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudDQsIGVsZW1lbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKGVsZW1lbnRUeXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgY3VycmVudDQsIGVsZW1lbnQucHJvcHMuY2hpbGRyZW4sIGxhbmVzLCBlbGVtZW50LmtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0LmVsZW1lbnRUeXBlID09PSBlbGVtZW50VHlwZSB8fCAvLyBLZWVwIHRoaXMgY2hlY2sgaW5saW5lIHNvIGl0IG9ubHkgcnVucyBvbiB0aGUgZmFsc2UgcGF0aDoKICAgICAgICAgICAgICBpc0NvbXBhdGlibGVGYW1pbHlGb3JIb3RSZWxvYWRpbmcoY3VycmVudDQsIGVsZW1lbnQpIHx8IC8vIExhenkgdHlwZXMgc2hvdWxkIHJlY29uY2lsZSB0aGVpciByZXNvbHZlZCB0eXBlLgogICAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gZG8gdGhpcyBhZnRlciB0aGUgSG90IFJlbG9hZGluZyBjaGVjayBhYm92ZSwKICAgICAgICAgICAgICAvLyBiZWNhdXNlIGhvdCByZWxvYWRpbmcgaGFzIGRpZmZlcmVudCBzZW1hbnRpY3MgdGhhbiBwcm9kIGJlY2F1c2UKICAgICAgICAgICAgICAvLyBpdCBkb2Vzbid0IHJlc3VzcGVuZC4gU28gd2UgY2FuJ3QgbGV0IHRoZSBjYWxsIGJlbG93IHN1c3BlbmQuCiAgICAgICAgICAgICAgdHlwZW9mIGVsZW1lbnRUeXBlID09PSAib2JqZWN0IiAmJiBlbGVtZW50VHlwZSAhPT0gbnVsbCAmJiBlbGVtZW50VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFICYmIHJlc29sdmVMYXp5KGVsZW1lbnRUeXBlKSA9PT0gY3VycmVudDQudHlwZSkgewogICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDQsIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgICAgZXhpc3RpbmcucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50NCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICBjcmVhdGVkLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgY3VycmVudDQsIGVsZW1lbnQpOwogICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudDQsIHBvcnRhbCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IGN1cnJlbnQ0LnRhZyAhPT0gSG9zdFBvcnRhbCB8fCBjdXJyZW50NC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyAhPT0gcG9ydGFsLmNvbnRhaW5lckluZm8gfHwgY3VycmVudDQuc3RhdGVOb2RlLmltcGxlbWVudGF0aW9uICE9PSBwb3J0YWwuaW1wbGVtZW50YXRpb24pIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChwb3J0YWwsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQ0LCBwb3J0YWwuY2hpbGRyZW4gfHwgW10pOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlRnJhZ21lbnQyKHJldHVybkZpYmVyLCBjdXJyZW50NCwgZnJhZ21lbnQsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IGN1cnJlbnQ0LnRhZyAhPT0gRnJhZ21lbnQ5KSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmcmFnbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50NCwgZnJhZ21lbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tVGV4dCgiIiArIG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQobmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBudWxsLCBuZXdDaGlsZCk7CiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZDIgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwobmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICAgICAgX2NyZWF0ZWQyLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gX2NyZWF0ZWQyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBuZXdDaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQgPSBuZXdDaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5MihuZXdDaGlsZCkgfHwgZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHZhciBfY3JlYXRlZDMgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChuZXdDaGlsZCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgICAgX2NyZWF0ZWQzLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkMzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3dPbkludmFsaWRPYmplY3RUeXBlKHJldHVybkZpYmVyLCBuZXdDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHdhcm5PbkZ1bmN0aW9uVHlwZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICB2YXIga2V5ID0gb2xkRmliZXIgIT09IG51bGwgPyBvbGRGaWJlci5rZXkgOiBudWxsOwogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGlmIChrZXkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVGV4dE5vZGUocmV0dXJuRmliZXIsIG9sZEZpYmVyLCAiIiArIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5ld0NoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRTogewogICAgICAgICAgICAgICAgICBpZiAobmV3Q2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0NoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVBvcnRhbChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTbG90KHJldHVybkZpYmVyLCBvbGRGaWJlciwgaW5pdChwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNBcnJheTIobmV3Q2hpbGQpIHx8IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICBpZiAoa2V5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkLCBsYW5lcywgbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZyb21NYXAoZXhpc3RpbmdDaGlsZHJlbiwgcmV0dXJuRmliZXIsIG5ld0lkeCwgbmV3Q2hpbGQsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJzdHJpbmciICYmIG5ld0NoaWxkICE9PSAiIiB8fCB0eXBlb2YgbmV3Q2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgdmFyIG1hdGNoZWRGaWJlciA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG5ld0lkeCkgfHwgbnVsbDsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVGV4dE5vZGUocmV0dXJuRmliZXIsIG1hdGNoZWRGaWJlciwgIiIgKyBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdDaGlsZC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBuZXdDaGlsZC5rZXkpIHx8IG51bGw7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFbGVtZW50KHJldHVybkZpYmVyLCBfbWF0Y2hlZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgX21hdGNoZWRGaWJlcjIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdDaGlsZC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBuZXdDaGlsZC5rZXkpIHx8IG51bGw7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWwocmV0dXJuRmliZXIsIF9tYXRjaGVkRmliZXIyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIGluaXQocGF5bG9hZCksIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIzID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3SWR4KSB8fCBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlcjMsIG5ld0NoaWxkLCBsYW5lcywgbnVsbCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cywgcmV0dXJuRmliZXIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgY2hpbGQgIT09ICJvYmplY3QiIHx8IGNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4ga25vd25LZXlzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzd2l0Y2ggKGNoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRToKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JNaXNzaW5nS2V5KGNoaWxkLCByZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgICAgIHZhciBrZXkgPSBjaGlsZC5rZXk7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Yga2V5ICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChrbm93bktleXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBrbm93bktleXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgICAgICAgIGtub3duS2V5cy5hZGQoa2V5KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoIWtub3duS2V5cy5oYXMoa2V5KSkgewogICAgICAgICAgICAgICAgICAgIGtub3duS2V5cy5hZGQoa2V5KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlcnJvcigiRW5jb3VudGVyZWQgdHdvIGNoaWxkcmVuIHdpdGggdGhlIHNhbWUga2V5LCBgJXNgLiBLZXlzIHNob3VsZCBiZSB1bmlxdWUgc28gdGhhdCBjb21wb25lbnRzIG1haW50YWluIHRoZWlyIGlkZW50aXR5IGFjcm9zcyB1cGRhdGVzLiBOb24tdW5pcXVlIGtleXMgbWF5IGNhdXNlIGNoaWxkcmVuIHRvIGJlIGR1cGxpY2F0ZWQgYW5kL29yIG9taXR0ZWQgXHUyMDE0IHRoZSBiZWhhdmlvciBpcyB1bnN1cHBvcnRlZCBhbmQgY291bGQgY2hhbmdlIGluIGEgZnV0dXJlIHZlcnNpb24uIiwga2V5KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRToKICAgICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBjaGlsZC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgICAgdmFyIGluaXQgPSBjaGlsZC5faW5pdDsKICAgICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZEtleShpbml0KHBheWxvYWQpLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBrbm93bktleXM7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVDaGlsZHJlbkFycmF5KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGRyZW4sIGxhbmVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIga25vd25LZXlzID0gbnVsbDsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5ld0NoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBuZXdDaGlsZHJlbltpXTsKICAgICAgICAgICAgICAgIGtub3duS2V5cyA9IHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cywgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IG51bGw7CiAgICAgICAgICAgIHZhciBwcmV2aW91c05ld0ZpYmVyID0gbnVsbDsKICAgICAgICAgICAgdmFyIG9sZEZpYmVyID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHZhciBsYXN0UGxhY2VkSW5kZXggPSAwOwogICAgICAgICAgICB2YXIgbmV3SWR4ID0gMDsKICAgICAgICAgICAgdmFyIG5leHRPbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgIGZvciAoOyBvbGRGaWJlciAhPT0gbnVsbCAmJiBuZXdJZHggPCBuZXdDaGlsZHJlbi5sZW5ndGg7IG5ld0lkeCsrKSB7CiAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyLmluZGV4ID4gbmV3SWR4KSB7CiAgICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlcjsKICAgICAgICAgICAgICAgIG9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXIuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5ld0ZpYmVyID0gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIG5ld0NoaWxkcmVuW25ld0lkeF0sIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAobmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyICYmIG5ld0ZpYmVyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmV3SWR4ID09PSBuZXdDaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IG5ld0lkeDsKICAgICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgbnVtYmVyT2ZGb3Jrcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGZvciAoOyBuZXdJZHggPCBuZXdDaGlsZHJlbi5sZW5ndGg7IG5ld0lkeCsrKSB7CiAgICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyID0gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIG5ld0NoaWxkcmVuW25ld0lkeF0sIGxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3MgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGRyZW4gPSBtYXBSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICBmb3IgKDsgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgIHZhciBfbmV3RmliZXIyID0gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIyLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZGVsZXRlKF9uZXdGaWJlcjIua2V5ID09PSBudWxsID8gbmV3SWR4IDogX25ld0ZpYmVyMi5rZXkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlcjIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXIyOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gX25ld0ZpYmVyMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXIyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihjaGlsZDIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrczIgPSBuZXdJZHg7CiAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5JdGVyYXRvcihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkcmVuSXRlcmFibGUsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihuZXdDaGlsZHJlbkl0ZXJhYmxlKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbiBvYmplY3QgaXMgbm90IGFuIGl0ZXJhYmxlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiAvLyAkRmxvd0ZpeE1lIEZsb3cgZG9lc24ndCBrbm93IGFib3V0IHRvU3RyaW5nVGFnCiAgICAgICAgICAgICAgbmV3Q2hpbGRyZW5JdGVyYWJsZVtTeW1ib2wudG9TdHJpbmdUYWddID09PSAiR2VuZXJhdG9yIikgewogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRHZW5lcmF0b3JzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVc2luZyBHZW5lcmF0b3JzIGFzIGNoaWxkcmVuIGlzIHVuc3VwcG9ydGVkIGFuZCB3aWxsIGxpa2VseSB5aWVsZCB1bmV4cGVjdGVkIHJlc3VsdHMgYmVjYXVzZSBlbnVtZXJhdGluZyBhIGdlbmVyYXRvciBtdXRhdGVzIGl0LiBZb3UgbWF5IGNvbnZlcnQgaXQgdG8gYW4gYXJyYXkgd2l0aCBgQXJyYXkuZnJvbSgpYCBvciB0aGUgYFsuLi5zcHJlYWRdYCBvcGVyYXRvciBiZWZvcmUgcmVuZGVyaW5nLiBLZWVwIGluIG1pbmQgeW91IG1pZ2h0IG5lZWQgdG8gcG9seWZpbGwgdGhlc2UgZmVhdHVyZXMgZm9yIG9sZGVyIGJyb3dzZXJzLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2VuZXJhdG9ycyA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChuZXdDaGlsZHJlbkl0ZXJhYmxlLmVudHJpZXMgPT09IGl0ZXJhdG9yRm4pIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TWFwcykgewogICAgICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgTWFwcyBhcyBjaGlsZHJlbiBpcyBub3Qgc3VwcG9ydGVkLiBVc2UgYW4gYXJyYXkgb2Yga2V5ZWQgUmVhY3RFbGVtZW50cyBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBfbmV3Q2hpbGRyZW4gPSBpdGVyYXRvckZuLmNhbGwobmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICAgICAgaWYgKF9uZXdDaGlsZHJlbikgewogICAgICAgICAgICAgICAgdmFyIGtub3duS2V5cyA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgX3N0ZXAgPSBfbmV3Q2hpbGRyZW4ubmV4dCgpOwogICAgICAgICAgICAgICAgZm9yICg7ICFfc3RlcC5kb25lOyBfc3RlcCA9IF9uZXdDaGlsZHJlbi5uZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gX3N0ZXAudmFsdWU7CiAgICAgICAgICAgICAgICAgIGtub3duS2V5cyA9IHdhcm5PbkludmFsaWRLZXkoY2hpbGQsIGtub3duS2V5cywgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW4gPSBpdGVyYXRvckZuLmNhbGwobmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICAgIGlmIChuZXdDaGlsZHJlbiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBbiBpdGVyYWJsZSBvYmplY3QgcHJvdmlkZWQgbm8gaXRlcmF0b3IuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBudWxsOwogICAgICAgICAgICB2YXIgcHJldmlvdXNOZXdGaWJlciA9IG51bGw7CiAgICAgICAgICAgIHZhciBvbGRGaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB2YXIgbGFzdFBsYWNlZEluZGV4ID0gMDsKICAgICAgICAgICAgdmFyIG5ld0lkeCA9IDA7CiAgICAgICAgICAgIHZhciBuZXh0T2xkRmliZXIgPSBudWxsOwogICAgICAgICAgICB2YXIgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKTsKICAgICAgICAgICAgZm9yICg7IG9sZEZpYmVyICE9PSBudWxsICYmICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyLmluZGV4ID4gbmV3SWR4KSB7CiAgICAgICAgICAgICAgICBuZXh0T2xkRmliZXIgPSBvbGRGaWJlcjsKICAgICAgICAgICAgICAgIG9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXIuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5ld0ZpYmVyID0gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAobmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgaWYgKG9sZEZpYmVyICYmIG5ld0ZpYmVyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgb2xkRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBuZXdGaWJlcjsKICAgICAgICAgICAgICBvbGRGaWJlciA9IG5leHRPbGRGaWJlcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc3RlcC5kb25lKSB7CiAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmb3IgKDsgIXN0ZXAuZG9uZTsgbmV3SWR4KyssIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbmV3RmliZXIzID0gY3JlYXRlQ2hpbGQocmV0dXJuRmliZXIsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXIzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIzLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gX25ld0ZpYmVyMzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyMzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrczMgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzMyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgdmFyIF9uZXdGaWJlcjQgPSB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIHN0ZXAudmFsdWUsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyNCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjQuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5kZWxldGUoX25ld0ZpYmVyNC5rZXkgPT09IG51bGwgPyBuZXdJZHggOiBfbmV3RmliZXI0LmtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQoX25ld0ZpYmVyNCwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5mb3JFYWNoKGZ1bmN0aW9uKGNoaWxkMikgewogICAgICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZDIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzNCA9IG5ld0lkeDsKICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIF9udW1iZXJPZkZvcmtzNCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVTaW5nbGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIHRleHRDb250ZW50LCBsYW5lcykgewogICAgICAgICAgICBpZiAoY3VycmVudEZpcnN0Q2hpbGQgIT09IG51bGwgJiYgY3VycmVudEZpcnN0Q2hpbGQudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50Rmlyc3RDaGlsZCwgdGV4dENvbnRlbnQpOwogICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQpOwogICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVRleHQodGV4dENvbnRlbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVTaW5nbGVFbGVtZW50KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgZWxlbWVudCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgICB2YXIgY2hpbGQgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGNoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudFR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyA9PT0gRnJhZ21lbnQ5KSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkLnNpYmxpbmcpOwogICAgICAgICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGNoaWxkLCBlbGVtZW50LnByb3BzLmNoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICBleGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5lbGVtZW50VHlwZSA9PT0gZWxlbWVudFR5cGUgfHwgLy8gS2VlcCB0aGlzIGNoZWNrIGlubGluZSBzbyBpdCBvbmx5IHJ1bnMgb24gdGhlIGZhbHNlIHBhdGg6CiAgICAgICAgICAgICAgICAgIGlzQ29tcGF0aWJsZUZhbWlseUZvckhvdFJlbG9hZGluZyhjaGlsZCwgZWxlbWVudCkgfHwgLy8gTGF6eSB0eXBlcyBzaG91bGQgcmVjb25jaWxlIHRoZWlyIHJlc29sdmVkIHR5cGUuCiAgICAgICAgICAgICAgICAgIC8vIFdlIG5lZWQgdG8gZG8gdGhpcyBhZnRlciB0aGUgSG90IFJlbG9hZGluZyBjaGVjayBhYm92ZSwKICAgICAgICAgICAgICAgICAgLy8gYmVjYXVzZSBob3QgcmVsb2FkaW5nIGhhcyBkaWZmZXJlbnQgc2VtYW50aWNzIHRoYW4gcHJvZCBiZWNhdXNlCiAgICAgICAgICAgICAgICAgIC8vIGl0IGRvZXNuJ3QgcmVzdXNwZW5kLiBTbyB3ZSBjYW4ndCBsZXQgdGhlIGNhbGwgYmVsb3cgc3VzcGVuZC4KICAgICAgICAgICAgICAgICAgdHlwZW9mIGVsZW1lbnRUeXBlID09PSAib2JqZWN0IiAmJiBlbGVtZW50VHlwZSAhPT0gbnVsbCAmJiBlbGVtZW50VHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFICYmIHJlc29sdmVMYXp5KGVsZW1lbnRUeXBlKSA9PT0gY2hpbGQudHlwZSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgICB2YXIgX2V4aXN0aW5nID0gdXNlRmliZXIoY2hpbGQsIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGNoaWxkLCBlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgX2V4aXN0aW5nLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5fZGVidWdPd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2V4aXN0aW5nOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWxlbWVudC50eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChlbGVtZW50LnByb3BzLmNoaWxkcmVuLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcywgZWxlbWVudC5rZXkpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9jcmVhdGVkNCA9IGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgIF9jcmVhdGVkNC5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBlbGVtZW50KTsKICAgICAgICAgICAgICBfY3JlYXRlZDQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkNDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlUG9ydGFsKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgcG9ydGFsLCBsYW5lcykgewogICAgICAgICAgICB2YXIga2V5ID0gcG9ydGFsLmtleTsKICAgICAgICAgICAgdmFyIGNoaWxkID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyA9PT0gSG9zdFBvcnRhbCAmJiBjaGlsZC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyA9PT0gcG9ydGFsLmNvbnRhaW5lckluZm8gJiYgY2hpbGQuc3RhdGVOb2RlLmltcGxlbWVudGF0aW9uID09PSBwb3J0YWwuaW1wbGVtZW50YXRpb24pIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkLnNpYmxpbmcpOwogICAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjaGlsZCwgcG9ydGFsLmNoaWxkcmVuIHx8IFtdKTsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwocG9ydGFsLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRGaWJlcnMyKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBpc1Vua2V5ZWRUb3BMZXZlbEZyYWdtZW50ID0gdHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCAmJiBuZXdDaGlsZC50eXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFICYmIG5ld0NoaWxkLmtleSA9PT0gbnVsbDsKICAgICAgICAgICAgaWYgKGlzVW5rZXllZFRvcExldmVsRnJhZ21lbnQpIHsKICAgICAgICAgICAgICBuZXdDaGlsZCA9IG5ld0NoaWxkLnByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJlY29uY2lsZVNpbmdsZUVsZW1lbnQocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpKTsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJlY29uY2lsZVNpbmdsZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcykpOwogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZEZpYmVyczIocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5MihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZHJlbkFycmF5KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRyZW5JdGVyYXRvcihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJzdHJpbmciICYmIG5ld0NoaWxkICE9PSAiIiB8fCB0eXBlb2YgbmV3Q2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHBsYWNlU2luZ2xlQ2hpbGQocmVjb25jaWxlU2luZ2xlVGV4dE5vZGUocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCAiIiArIG5ld0NoaWxkLCBsYW5lcykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZWNvbmNpbGVDaGlsZEZpYmVyczI7CiAgICAgICAgfQogICAgICAgIHZhciByZWNvbmNpbGVDaGlsZEZpYmVycyA9IENoaWxkUmVjb25jaWxlcih0cnVlKTsKICAgICAgICB2YXIgbW91bnRDaGlsZEZpYmVycyA9IENoaWxkUmVjb25jaWxlcihmYWxzZSk7CiAgICAgICAgZnVuY3Rpb24gY2xvbmVDaGlsZEZpYmVycyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgd29ya0luUHJvZ3Jlc3MyLmNoaWxkICE9PSBjdXJyZW50NC5jaGlsZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlc3VtaW5nIHdvcmsgbm90IHlldCBpbXBsZW1lbnRlZC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIHZhciBuZXdDaGlsZCA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRDaGlsZCwgY3VycmVudENoaWxkLnBlbmRpbmdQcm9wcyk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBuZXdDaGlsZDsKICAgICAgICAgIG5ld0NoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHdoaWxlIChjdXJyZW50Q2hpbGQuc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICBjdXJyZW50Q2hpbGQgPSBjdXJyZW50Q2hpbGQuc2libGluZzsKICAgICAgICAgICAgbmV3Q2hpbGQgPSBuZXdDaGlsZC5zaWJsaW5nID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudENoaWxkLCBjdXJyZW50Q2hpbGQucGVuZGluZ1Byb3BzKTsKICAgICAgICAgICAgbmV3Q2hpbGQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgfQogICAgICAgICAgbmV3Q2hpbGQuc2libGluZyA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBsYW5lcykgewogICAgICAgICAgdmFyIGNoaWxkID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3MoY2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsdWVDdXJzb3IgPSBjcmVhdGVDdXJzb3IobnVsbCk7CiAgICAgICAgdmFyIHJlbmRlcmVyU2lnaWw7CiAgICAgICAgewogICAgICAgICAgcmVuZGVyZXJTaWdpbCA9IHt9OwogICAgICAgIH0KICAgICAgICB2YXIgY3VycmVudGx5UmVuZGVyaW5nRmliZXIgPSBudWxsOwogICAgICAgIHZhciBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBudWxsOwogICAgICAgIHZhciBsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPSBudWxsOwogICAgICAgIHZhciBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gcmVzZXRDb250ZXh0RGVwZW5kZW5jaWVzKCkgewogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIgPSBudWxsOwogICAgICAgICAgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gbnVsbDsKICAgICAgICAgIGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50ZXJEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4aXREaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoUHJvdmlkZXIocHJvdmlkZXJGaWJlciwgY29udGV4dCwgbmV4dFZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHB1c2godmFsdWVDdXJzb3IsIGNvbnRleHQuX2N1cnJlbnRWYWx1ZSwgcHJvdmlkZXJGaWJlcik7CiAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZSA9IG5leHRWYWx1ZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgIT09IHZvaWQgMCAmJiBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgIT09IG51bGwgJiYgY29udGV4dC5fY3VycmVudFJlbmRlcmVyICE9PSByZW5kZXJlclNpZ2lsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiRGV0ZWN0ZWQgbXVsdGlwbGUgcmVuZGVyZXJzIGNvbmN1cnJlbnRseSByZW5kZXJpbmcgdGhlIHNhbWUgY29udGV4dCBwcm92aWRlci4gVGhpcyBpcyBjdXJyZW50bHkgdW5zdXBwb3J0ZWQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciA9IHJlbmRlcmVyU2lnaWw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wUHJvdmlkZXIoY29udGV4dCwgcHJvdmlkZXJGaWJlcikgewogICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9IHZhbHVlQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICBwb3AodmFsdWVDdXJzb3IsIHByb3ZpZGVyRmliZXIpOwogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlID0gY3VycmVudFZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgocGFyZW50LCByZW5kZXJMYW5lczIsIHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgdmFyIG5vZGUgPSBwYXJlbnQ7CiAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gbm9kZS5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmICghaXNTdWJzZXRPZkxhbmVzKG5vZGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgIG5vZGUuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobm9kZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGFsdGVybmF0ZS5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWx0ZXJuYXRlICE9PSBudWxsICYmICFpc1N1YnNldE9mTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICBhbHRlcm5hdGUuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5vZGUgIT09IHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB0byBmaW5kIHRoZSBwcm9wYWdhdGlvbiByb290IHdoZW4gc2NoZWR1bGluZyBjb250ZXh0IHdvcmsuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvcGFnYXRlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlX2VhZ2VyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvcGFnYXRlQ29udGV4dENoYW5nZV9lYWdlcih3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGZpYmVyID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgaWYgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZpYmVyLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChmaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmV4dEZpYmVyID0gdm9pZCAwOwogICAgICAgICAgICB2YXIgbGlzdCA9IGZpYmVyLmRlcGVuZGVuY2llczsKICAgICAgICAgICAgaWYgKGxpc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgICB2YXIgZGVwZW5kZW5jeSA9IGxpc3QuZmlyc3RDb250ZXh0OwogICAgICAgICAgICAgIHdoaWxlIChkZXBlbmRlbmN5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwZW5kZW5jeS5jb250ZXh0ID09PSBjb250ZXh0KSB7CiAgICAgICAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxhbmUgPSBwaWNrQXJiaXRyYXJ5TGFuZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIGxhbmUpOwogICAgICAgICAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBGb3JjZVVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaWJlci51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgPT09IG51bGwpIDsKICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBzaGFyZWRRdWV1ZSA9IHVwZGF0ZVF1ZXVlLnNoYXJlZDsKICAgICAgICAgICAgICAgICAgICAgIHZhciBwZW5kaW5nID0gc2hhcmVkUXVldWUucGVuZGluZzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChwZW5kaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBwZW5kaW5nLm5leHQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHBlbmRpbmcubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHNoYXJlZFF1ZXVlLnBlbmRpbmcgPSB1cGRhdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGZpYmVyLmxhbmVzID0gbWVyZ2VMYW5lcyhmaWJlci5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGFsdGVybmF0ZS5sYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlQ29udGV4dFdvcmtPblBhcmVudFBhdGgoZmliZXIucmV0dXJuLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIGxpc3QubGFuZXMgPSBtZXJnZUxhbmVzKGxpc3QubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVwZW5kZW5jeSA9IGRlcGVuZGVuY3kubmV4dDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmliZXIudGFnID09PSBDb250ZXh0UHJvdmlkZXIpIHsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci50eXBlID09PSB3b3JrSW5Qcm9ncmVzczIudHlwZSA/IG51bGwgOiBmaWJlci5jaGlsZDsKICAgICAgICAgICAgfSBlbHNlIGlmIChmaWJlci50YWcgPT09IERlaHlkcmF0ZWRGcmFnbWVudCkgewogICAgICAgICAgICAgIHZhciBwYXJlbnRTdXNwZW5zZSA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBpZiAocGFyZW50U3VzcGVuc2UgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2UganVzdCBjYW1lIGZyb20gYSBwYXJlbnQgc28gd2UgbXVzdCBoYXZlIGhhZCBhIHBhcmVudC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50U3VzcGVuc2UubGFuZXMgPSBtZXJnZUxhbmVzKHBhcmVudFN1c3BlbnNlLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHZhciBfYWx0ZXJuYXRlID0gcGFyZW50U3VzcGVuc2UuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChfYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBfYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhfYWx0ZXJuYXRlLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzY2hlZHVsZUNvbnRleHRXb3JrT25QYXJlbnRQYXRoKHBhcmVudFN1c3BlbnNlLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmV4dEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgIHdoaWxlIChuZXh0RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0RmliZXIgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgICBuZXh0RmliZXIgPSBudWxsOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gbmV4dEZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IG5leHRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV4dEZpYmVyID0gbmV4dEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIgPSBuZXh0RmliZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IG51bGw7CiAgICAgICAgICBsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPSBudWxsOwogICAgICAgICAgdmFyIGRlcGVuZGVuY2llcyA9IHdvcmtJblByb2dyZXNzMi5kZXBlbmRlbmNpZXM7CiAgICAgICAgICBpZiAoZGVwZW5kZW5jaWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgZmlyc3RDb250ZXh0ID0gZGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dDsKICAgICAgICAgICAgICBpZiAoZmlyc3RDb250ZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZShkZXBlbmRlbmNpZXMubGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlcGVuZGVuY2llcy5maXJzdENvbnRleHQgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFkQ29udGV4dChjb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkNvbnRleHQgY2FuIG9ubHkgYmUgcmVhZCB3aGlsZSBSZWFjdCBpcyByZW5kZXJpbmcuIEluIGNsYXNzZXMsIHlvdSBjYW4gcmVhZCBpdCBpbiB0aGUgcmVuZGVyIG1ldGhvZCBvciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIEluIGZ1bmN0aW9uIGNvbXBvbmVudHMsIHlvdSBjYW4gcmVhZCBpdCBkaXJlY3RseSBpbiB0aGUgZnVuY3Rpb24gYm9keSwgYnV0IG5vdCBpbnNpZGUgSG9va3MgbGlrZSB1c2VSZWR1Y2VyKCkgb3IgdXNlTWVtbygpLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdmFsdWUgPSBjb250ZXh0Ll9jdXJyZW50VmFsdWU7CiAgICAgICAgICBpZiAobGFzdEZ1bGx5T2JzZXJ2ZWRDb250ZXh0ID09PSBjb250ZXh0KSA7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdmFyIGNvbnRleHRJdGVtID0gewogICAgICAgICAgICAgIGNvbnRleHQsCiAgICAgICAgICAgICAgbWVtb2l6ZWRWYWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAobGFzdENvbnRleHREZXBlbmRlbmN5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNvbnRleHQgY2FuIG9ubHkgYmUgcmVhZCB3aGlsZSBSZWFjdCBpcyByZW5kZXJpbmcuIEluIGNsYXNzZXMsIHlvdSBjYW4gcmVhZCBpdCBpbiB0aGUgcmVuZGVyIG1ldGhvZCBvciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIEluIGZ1bmN0aW9uIGNvbXBvbmVudHMsIHlvdSBjYW4gcmVhZCBpdCBkaXJlY3RseSBpbiB0aGUgZnVuY3Rpb24gYm9keSwgYnV0IG5vdCBpbnNpZGUgSG9va3MgbGlrZSB1c2VSZWR1Y2VyKCkgb3IgdXNlTWVtbygpLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBjb250ZXh0SXRlbTsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlci5kZXBlbmRlbmNpZXMgPSB7CiAgICAgICAgICAgICAgICBsYW5lczogTm9MYW5lcywKICAgICAgICAgICAgICAgIGZpcnN0Q29udGV4dDogY29udGV4dEl0ZW0KICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IGxhc3RDb250ZXh0RGVwZW5kZW5jeS5uZXh0ID0gY29udGV4dEl0ZW07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgdmFyIGNvbmN1cnJlbnRRdWV1ZXMgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpIHsKICAgICAgICAgIGlmIChjb25jdXJyZW50UXVldWVzID09PSBudWxsKSB7CiAgICAgICAgICAgIGNvbmN1cnJlbnRRdWV1ZXMgPSBbcXVldWVdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uY3VycmVudFF1ZXVlcy5wdXNoKHF1ZXVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluaXNoUXVldWVpbmdDb25jdXJyZW50VXBkYXRlcygpIHsKICAgICAgICAgIGlmIChjb25jdXJyZW50UXVldWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY29uY3VycmVudFF1ZXVlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBxdWV1ZSA9IGNvbmN1cnJlbnRRdWV1ZXNbaV07CiAgICAgICAgICAgICAgdmFyIGxhc3RJbnRlcmxlYXZlZFVwZGF0ZSA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgICAgIGlmIChsYXN0SW50ZXJsZWF2ZWRVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBmaXJzdEludGVybGVhdmVkVXBkYXRlID0gbGFzdEludGVybGVhdmVkVXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICB2YXIgbGFzdFBlbmRpbmdVcGRhdGUgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgICAgICAgaWYgKGxhc3RQZW5kaW5nVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBmaXJzdFBlbmRpbmdVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0OwogICAgICAgICAgICAgICAgICBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0ID0gZmlyc3RJbnRlcmxlYXZlZFVwZGF0ZTsKICAgICAgICAgICAgICAgICAgbGFzdEludGVybGVhdmVkVXBkYXRlLm5leHQgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbGFzdEludGVybGVhdmVkVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb25jdXJyZW50UXVldWVzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgIGlmIChpbnRlcmxlYXZlZCA9PT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIGludGVybGVhdmVkLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IHVwZGF0ZTsKICAgICAgICAgIHJldHVybiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZUFuZEVhZ2VybHlCYWlsb3V0KGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgIGlmIChpbnRlcmxlYXZlZCA9PT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgcHVzaENvbmN1cnJlbnRVcGRhdGVRdWV1ZShxdWV1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIGludGVybGVhdmVkLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRDbGFzc1VwZGF0ZShmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSkgewogICAgICAgICAgdmFyIGludGVybGVhdmVkID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICBpZiAoaW50ZXJsZWF2ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICBpbnRlcmxlYXZlZC5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUuaW50ZXJsZWF2ZWQgPSB1cGRhdGU7CiAgICAgICAgICByZXR1cm4gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHJldHVybiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIHZhciB1bnNhZmVfbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QgPSBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdDsKICAgICAgICBmdW5jdGlvbiBtYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChzb3VyY2VGaWJlciwgbGFuZSkgewogICAgICAgICAgc291cmNlRmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKHNvdXJjZUZpYmVyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBzb3VyY2VGaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFsdGVybmF0ZS5sYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmxhbmVzLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSA9PT0gbnVsbCAmJiAoc291cmNlRmliZXIuZmxhZ3MgJiAoUGxhY2VtZW50IHwgSHlkcmF0aW5nKSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICB3YXJuQWJvdXRVcGRhdGVPbk5vdFlldE1vdW50ZWRGaWJlckluREVWKHNvdXJjZUZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vZGUgPSBzb3VyY2VGaWJlcjsKICAgICAgICAgIHZhciBwYXJlbnQgPSBzb3VyY2VGaWJlci5yZXR1cm47CiAgICAgICAgICB3aGlsZSAocGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHBhcmVudC5jaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhwYXJlbnQuY2hpbGRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgIGFsdGVybmF0ZSA9IHBhcmVudC5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBhbHRlcm5hdGUuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIGxhbmUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgocGFyZW50LmZsYWdzICYgKFBsYWNlbWVudCB8IEh5ZHJhdGluZykpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5BYm91dFVwZGF0ZU9uTm90WWV0TW91bnRlZEZpYmVySW5ERVYoc291cmNlRmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gcGFyZW50OwogICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICB2YXIgcm9vdDMgPSBub2RlLnN0YXRlTm9kZTsKICAgICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBVcGRhdGVTdGF0ZSA9IDA7CiAgICAgICAgdmFyIFJlcGxhY2VTdGF0ZSA9IDE7CiAgICAgICAgdmFyIEZvcmNlVXBkYXRlID0gMjsKICAgICAgICB2YXIgQ2FwdHVyZVVwZGF0ZSA9IDM7CiAgICAgICAgdmFyIGhhc0ZvcmNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGU7CiAgICAgICAgdmFyIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuVXBkYXRlSW5zaWRlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0aWFsaXplVXBkYXRlUXVldWUoZmliZXIpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHsKICAgICAgICAgICAgYmFzZVN0YXRlOiBmaWJlci5tZW1vaXplZFN0YXRlLAogICAgICAgICAgICBmaXJzdEJhc2VVcGRhdGU6IG51bGwsCiAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlOiBudWxsLAogICAgICAgICAgICBzaGFyZWQ6IHsKICAgICAgICAgICAgICBwZW5kaW5nOiBudWxsLAogICAgICAgICAgICAgIGludGVybGVhdmVkOiBudWxsLAogICAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVmZmVjdHM6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICBmaWJlci51cGRhdGVRdWV1ZSA9IHF1ZXVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbG9uZVVwZGF0ZVF1ZXVlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBjdXJyZW50UXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmIChxdWV1ZSA9PT0gY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICBiYXNlU3RhdGU6IGN1cnJlbnRRdWV1ZS5iYXNlU3RhdGUsCiAgICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlOiBjdXJyZW50UXVldWUuZmlyc3RCYXNlVXBkYXRlLAogICAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlOiBjdXJyZW50UXVldWUubGFzdEJhc2VVcGRhdGUsCiAgICAgICAgICAgICAgc2hhcmVkOiBjdXJyZW50UXVldWUuc2hhcmVkLAogICAgICAgICAgICAgIGVmZmVjdHM6IGN1cnJlbnRRdWV1ZS5lZmZlY3RzCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGNsb25lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVVcGRhdGUoZXZlbnRUaW1lLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlID0gewogICAgICAgICAgICBldmVudFRpbWUsCiAgICAgICAgICAgIGxhbmUsCiAgICAgICAgICAgIHRhZzogVXBkYXRlU3RhdGUsCiAgICAgICAgICAgIHBheWxvYWQ6IG51bGwsCiAgICAgICAgICAgIGNhbGxiYWNrOiBudWxsLAogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaWJlci51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzaGFyZWRRdWV1ZSA9IHVwZGF0ZVF1ZXVlLnNoYXJlZDsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9PT0gc2hhcmVkUXVldWUgJiYgIWRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGUpIHsKICAgICAgICAgICAgICBlcnJvcigiQW4gdXBkYXRlIChzZXRTdGF0ZSwgcmVwbGFjZVN0YXRlLCBvciBmb3JjZVVwZGF0ZSkgd2FzIHNjaGVkdWxlZCBmcm9tIGluc2lkZSBhbiB1cGRhdGUgZnVuY3Rpb24uIFVwZGF0ZSBmdW5jdGlvbnMgc2hvdWxkIGJlIHB1cmUsIHdpdGggemVybyBzaWRlLWVmZmVjdHMuIENvbnNpZGVyIHVzaW5nIGNvbXBvbmVudERpZFVwZGF0ZSBvciBhIGNhbGxiYWNrLiIpOwogICAgICAgICAgICAgIGRpZFdhcm5VcGRhdGVJbnNpZGVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNVbnNhZmVDbGFzc1JlbmRlclBoYXNlVXBkYXRlKCkpIHsKICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBzaGFyZWRRdWV1ZS5wZW5kaW5nOwogICAgICAgICAgICBpZiAocGVuZGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gcGVuZGluZy5uZXh0OwogICAgICAgICAgICAgIHBlbmRpbmcubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzaGFyZWRRdWV1ZS5wZW5kaW5nID0gdXBkYXRlOwogICAgICAgICAgICByZXR1cm4gdW5zYWZlX21hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBlbnF1ZXVlQ29uY3VycmVudENsYXNzVXBkYXRlKGZpYmVyLCBzaGFyZWRRdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzaGFyZWRRdWV1ZSA9IHVwZGF0ZVF1ZXVlLnNoYXJlZDsKICAgICAgICAgIGlmIChpc1RyYW5zaXRpb25MYW5lKGxhbmUpKSB7CiAgICAgICAgICAgIHZhciBxdWV1ZUxhbmVzID0gc2hhcmVkUXVldWUubGFuZXM7CiAgICAgICAgICAgIHF1ZXVlTGFuZXMgPSBpbnRlcnNlY3RMYW5lcyhxdWV1ZUxhbmVzLCByb290My5wZW5kaW5nTGFuZXMpOwogICAgICAgICAgICB2YXIgbmV3UXVldWVMYW5lcyA9IG1lcmdlTGFuZXMocXVldWVMYW5lcywgbGFuZSk7CiAgICAgICAgICAgIHNoYXJlZFF1ZXVlLmxhbmVzID0gbmV3UXVldWVMYW5lczsKICAgICAgICAgICAgbWFya1Jvb3RFbnRhbmdsZWQocm9vdDMsIG5ld1F1ZXVlTGFuZXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjYXB0dXJlZFVwZGF0ZSkgewogICAgICAgICAgdmFyIHF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudFF1ZXVlID0gY3VycmVudDQudXBkYXRlUXVldWU7CiAgICAgICAgICAgIGlmIChxdWV1ZSA9PT0gY3VycmVudFF1ZXVlKSB7CiAgICAgICAgICAgICAgdmFyIG5ld0ZpcnN0ID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgbmV3TGFzdCA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGZpcnN0QmFzZVVwZGF0ZSA9IHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgICBpZiAoZmlyc3RCYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgICAgZXZlbnRUaW1lOiB1cGRhdGUuZXZlbnRUaW1lLAogICAgICAgICAgICAgICAgICAgIGxhbmU6IHVwZGF0ZS5sYW5lLAogICAgICAgICAgICAgICAgICAgIHRhZzogdXBkYXRlLnRhZywKICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiB1cGRhdGUucGF5bG9hZCwKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogdXBkYXRlLmNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0xhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBuZXdGaXJzdCA9IG5ld0xhc3QgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBuZXdMYXN0Lm5leHQgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgICBuZXdMYXN0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgICB9IHdoaWxlICh1cGRhdGUgIT09IG51bGwpOwogICAgICAgICAgICAgICAgaWYgKG5ld0xhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbmV3Rmlyc3QgPSBuZXdMYXN0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBuZXdMYXN0Lm5leHQgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICAgICAgbmV3TGFzdCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXdGaXJzdCA9IG5ld0xhc3QgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcXVldWUgPSB7CiAgICAgICAgICAgICAgICBiYXNlU3RhdGU6IGN1cnJlbnRRdWV1ZS5iYXNlU3RhdGUsCiAgICAgICAgICAgICAgICBmaXJzdEJhc2VVcGRhdGU6IG5ld0ZpcnN0LAogICAgICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGU6IG5ld0xhc3QsCiAgICAgICAgICAgICAgICBzaGFyZWQ6IGN1cnJlbnRRdWV1ZS5zaGFyZWQsCiAgICAgICAgICAgICAgICBlZmZlY3RzOiBjdXJyZW50UXVldWUuZWZmZWN0cwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gcXVldWU7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFzdEJhc2VVcGRhdGUgPSBxdWV1ZS5sYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgIGlmIChsYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZS5maXJzdEJhc2VVcGRhdGUgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlLm5leHQgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmxhc3RCYXNlVXBkYXRlID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN0YXRlRnJvbVVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHF1ZXVlLCB1cGRhdGUsIHByZXZTdGF0ZSwgbmV4dFByb3BzLCBpbnN0YW5jZSkgewogICAgICAgICAgc3dpdGNoICh1cGRhdGUudGFnKSB7CiAgICAgICAgICAgIGNhc2UgUmVwbGFjZVN0YXRlOiB7CiAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSB1cGRhdGUucGF5bG9hZDsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHBheWxvYWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZW50ZXJEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHBheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIHBheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGV4aXREaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIG5leHRTdGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHBheWxvYWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDYXB0dXJlVXBkYXRlOiB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgVXBkYXRlU3RhdGU6IHsKICAgICAgICAgICAgICB2YXIgX3BheWxvYWQgPSB1cGRhdGUucGF5bG9hZDsKICAgICAgICAgICAgICB2YXIgcGFydGlhbFN0YXRlOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgX3BheWxvYWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgZW50ZXJEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFydGlhbFN0YXRlID0gX3BheWxvYWQuY2FsbChpbnN0YW5jZSwgcHJldlN0YXRlLCBuZXh0UHJvcHMpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIF9wYXlsb2FkLmNhbGwoaW5zdGFuY2UsIHByZXZTdGF0ZSwgbmV4dFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBleGl0RGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcGFydGlhbFN0YXRlID0gX3BheWxvYWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwYXJ0aWFsU3RhdGUgPT09IG51bGwgfHwgcGFydGlhbFN0YXRlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBhc3NpZ24yKHt9LCBwcmV2U3RhdGUsIHBhcnRpYWxTdGF0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBGb3JjZVVwZGF0ZTogewogICAgICAgICAgICAgIGhhc0ZvcmNlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gcHJldlN0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcHJldlN0YXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyLCBwcm9wcywgaW5zdGFuY2UsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIHF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaGFzRm9yY2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlID0gcXVldWUuc2hhcmVkOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpcnN0QmFzZVVwZGF0ZSA9IHF1ZXVlLmZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgIHZhciBsYXN0QmFzZVVwZGF0ZSA9IHF1ZXVlLmxhc3RCYXNlVXBkYXRlOwogICAgICAgICAgdmFyIHBlbmRpbmdRdWV1ZSA9IHF1ZXVlLnNoYXJlZC5wZW5kaW5nOwogICAgICAgICAgaWYgKHBlbmRpbmdRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZS5zaGFyZWQucGVuZGluZyA9IG51bGw7CiAgICAgICAgICAgIHZhciBsYXN0UGVuZGluZ1VwZGF0ZSA9IHBlbmRpbmdRdWV1ZTsKICAgICAgICAgICAgdmFyIGZpcnN0UGVuZGluZ1VwZGF0ZSA9IGxhc3RQZW5kaW5nVXBkYXRlLm5leHQ7CiAgICAgICAgICAgIGxhc3RQZW5kaW5nVXBkYXRlLm5leHQgPSBudWxsOwogICAgICAgICAgICBpZiAobGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmaXJzdEJhc2VVcGRhdGUgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGUubmV4dCA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZSA9IGxhc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICB2YXIgY3VycmVudDQgPSB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudFF1ZXVlID0gY3VycmVudDQudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRMYXN0QmFzZVVwZGF0ZSA9IGN1cnJlbnRRdWV1ZS5sYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgICBpZiAoY3VycmVudExhc3RCYXNlVXBkYXRlICE9PSBsYXN0QmFzZVVwZGF0ZSkgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRMYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjdXJyZW50UXVldWUuZmlyc3RCYXNlVXBkYXRlID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY3VycmVudExhc3RCYXNlVXBkYXRlLm5leHQgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50UXVldWUubGFzdEJhc2VVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChmaXJzdEJhc2VVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gcXVldWUuYmFzZVN0YXRlOwogICAgICAgICAgICB2YXIgbmV3TGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICB2YXIgbmV3QmFzZVN0YXRlID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5ld0ZpcnN0QmFzZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBuZXdMYXN0QmFzZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBmaXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICB2YXIgdXBkYXRlTGFuZSA9IHVwZGF0ZS5sYW5lOwogICAgICAgICAgICAgIHZhciB1cGRhdGVFdmVudFRpbWUgPSB1cGRhdGUuZXZlbnRUaW1lOwogICAgICAgICAgICAgIGlmICghaXNTdWJzZXRPZkxhbmVzKHJlbmRlckxhbmVzMiwgdXBkYXRlTGFuZSkpIHsKICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgZXZlbnRUaW1lOiB1cGRhdGVFdmVudFRpbWUsCiAgICAgICAgICAgICAgICAgIGxhbmU6IHVwZGF0ZUxhbmUsCiAgICAgICAgICAgICAgICAgIHRhZzogdXBkYXRlLnRhZywKICAgICAgICAgICAgICAgICAgcGF5bG9hZDogdXBkYXRlLnBheWxvYWQsCiAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiB1cGRhdGUuY2FsbGJhY2ssCiAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAobmV3TGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbmV3Rmlyc3RCYXNlVXBkYXRlID0gbmV3TGFzdEJhc2VVcGRhdGUgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgbmV3QmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBuZXdMYXN0QmFzZVVwZGF0ZSA9IG5ld0xhc3RCYXNlVXBkYXRlLm5leHQgPSBjbG9uZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5ld0xhbmVzID0gbWVyZ2VMYW5lcyhuZXdMYW5lcywgdXBkYXRlTGFuZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChuZXdMYXN0QmFzZVVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgX2Nsb25lID0gewogICAgICAgICAgICAgICAgICAgIGV2ZW50VGltZTogdXBkYXRlRXZlbnRUaW1lLAogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgdXBkYXRlIGlzIGdvaW5nIHRvIGJlIGNvbW1pdHRlZCBzbyB3ZSBuZXZlciB3YW50IHVuY29tbWl0CiAgICAgICAgICAgICAgICAgICAgLy8gaXQuIFVzaW5nIE5vTGFuZSB3b3JrcyBiZWNhdXNlIDAgaXMgYSBzdWJzZXQgb2YgYWxsIGJpdG1hc2tzLCBzbwogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgd2lsbCBuZXZlciBiZSBza2lwcGVkIGJ5IHRoZSBjaGVjayBhYm92ZS4KICAgICAgICAgICAgICAgICAgICBsYW5lOiBOb0xhbmUsCiAgICAgICAgICAgICAgICAgICAgdGFnOiB1cGRhdGUudGFnLAogICAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IHVwZGF0ZS5wYXlsb2FkLAogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiB1cGRhdGUuY2FsbGJhY2ssCiAgICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBuZXdMYXN0QmFzZVVwZGF0ZSA9IG5ld0xhc3RCYXNlVXBkYXRlLm5leHQgPSBfY2xvbmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXdTdGF0ZSA9IGdldFN0YXRlRnJvbVVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHF1ZXVlLCB1cGRhdGUsIG5ld1N0YXRlLCBwcm9wcywgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gdXBkYXRlLmNhbGxiYWNrOwogICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSBudWxsICYmIC8vIElmIHRoZSB1cGRhdGUgd2FzIGFscmVhZHkgY29tbWl0dGVkLCB3ZSBzaG91bGQgbm90IHF1ZXVlIGl0cwogICAgICAgICAgICAgICAgLy8gY2FsbGJhY2sgYWdhaW4uCiAgICAgICAgICAgICAgICB1cGRhdGUubGFuZSAhPT0gTm9MYW5lKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBDYWxsYmFjazsKICAgICAgICAgICAgICAgICAgdmFyIGVmZmVjdHMgPSBxdWV1ZS5lZmZlY3RzOwogICAgICAgICAgICAgICAgICBpZiAoZWZmZWN0cyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHF1ZXVlLmVmZmVjdHMgPSBbdXBkYXRlXTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlZmZlY3RzLnB1c2godXBkYXRlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgICBpZiAodXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBwZW5kaW5nUXVldWUgPSBxdWV1ZS5zaGFyZWQucGVuZGluZzsKICAgICAgICAgICAgICAgIGlmIChwZW5kaW5nUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgX2xhc3RQZW5kaW5nVXBkYXRlID0gcGVuZGluZ1F1ZXVlOwogICAgICAgICAgICAgICAgICB2YXIgX2ZpcnN0UGVuZGluZ1VwZGF0ZSA9IF9sYXN0UGVuZGluZ1VwZGF0ZS5uZXh0OwogICAgICAgICAgICAgICAgICBfbGFzdFBlbmRpbmdVcGRhdGUubmV4dCA9IG51bGw7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZSA9IF9maXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgICAgIHF1ZXVlLmxhc3RCYXNlVXBkYXRlID0gX2xhc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgICBxdWV1ZS5zaGFyZWQucGVuZGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICAgICAgaWYgKG5ld0xhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV3QmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcXVldWUuYmFzZVN0YXRlID0gbmV3QmFzZVN0YXRlOwogICAgICAgICAgICBxdWV1ZS5maXJzdEJhc2VVcGRhdGUgPSBuZXdGaXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgIHF1ZXVlLmxhc3RCYXNlVXBkYXRlID0gbmV3TGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgIHZhciBsYXN0SW50ZXJsZWF2ZWQgPSBxdWV1ZS5zaGFyZWQuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICAgIGlmIChsYXN0SW50ZXJsZWF2ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBsYXN0SW50ZXJsZWF2ZWQ7CiAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgbmV3TGFuZXMgPSBtZXJnZUxhbmVzKG5ld0xhbmVzLCBpbnRlcmxlYXZlZC5sYW5lKTsKICAgICAgICAgICAgICAgIGludGVybGVhdmVkID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgICB9IHdoaWxlIChpbnRlcmxlYXZlZCAhPT0gbGFzdEludGVybGVhdmVkKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChmaXJzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBxdWV1ZS5zaGFyZWQubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMobmV3TGFuZXMpOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBuZXdMYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FsbENhbGxiYWNrKGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBhcmd1bWVudCBwYXNzZWQgYXMgY2FsbGJhY2suIEV4cGVjdGVkIGEgZnVuY3Rpb24uIEluc3RlYWQgIiArICgicmVjZWl2ZWQ6ICIgKyBjYWxsYmFjaykpOwogICAgICAgICAgfQogICAgICAgICAgY2FsbGJhY2suY2FsbChjb250ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRIYXNGb3JjZVVwZGF0ZUJlZm9yZVByb2Nlc3NpbmcoKSB7CiAgICAgICAgICBoYXNGb3JjZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkgewogICAgICAgICAgcmV0dXJuIGhhc0ZvcmNlVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRVcGRhdGVRdWV1ZShmaW5pc2hlZFdvcmssIGZpbmlzaGVkUXVldWUsIGluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgZWZmZWN0cyA9IGZpbmlzaGVkUXVldWUuZWZmZWN0czsKICAgICAgICAgIGZpbmlzaGVkUXVldWUuZWZmZWN0cyA9IG51bGw7CiAgICAgICAgICBpZiAoZWZmZWN0cyAhPT0gbnVsbCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVmZmVjdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgZWZmZWN0ID0gZWZmZWN0c1tpXTsKICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBlZmZlY3QuY2FsbGJhY2s7CiAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBlZmZlY3QuY2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICAgICAgY2FsbENhbGxiYWNrKGNhbGxiYWNrLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBOT19DT05URVhUID0ge307CiAgICAgICAgdmFyIGNvbnRleHRTdGFja0N1cnNvciQxID0gY3JlYXRlQ3Vyc29yKE5PX0NPTlRFWFQpOwogICAgICAgIHZhciBjb250ZXh0RmliZXJTdGFja0N1cnNvciA9IGNyZWF0ZUN1cnNvcihOT19DT05URVhUKTsKICAgICAgICB2YXIgcm9vdEluc3RhbmNlU3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoTk9fQ09OVEVYVCk7CiAgICAgICAgZnVuY3Rpb24gcmVxdWlyZWRDb250ZXh0KGMpIHsKICAgICAgICAgIGlmIChjID09PSBOT19DT05URVhUKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgaG9zdCBjb250ZXh0IHRvIGV4aXN0LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFJvb3RIb3N0Q29udGFpbmVyKCkgewogICAgICAgICAgdmFyIHJvb3RJbnN0YW5jZSA9IHJlcXVpcmVkQ29udGV4dChyb290SW5zdGFuY2VTdGFja0N1cnNvci5jdXJyZW50KTsKICAgICAgICAgIHJldHVybiByb290SW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hIb3N0Q29udGFpbmVyKGZpYmVyLCBuZXh0Um9vdEluc3RhbmNlKSB7CiAgICAgICAgICBwdXNoKHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLCBuZXh0Um9vdEluc3RhbmNlLCBmaWJlcik7CiAgICAgICAgICBwdXNoKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlciwgZmliZXIpOwogICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IkMSwgTk9fQ09OVEVYVCwgZmliZXIpOwogICAgICAgICAgdmFyIG5leHRSb290Q29udGV4dCA9IGdldFJvb3RIb3N0Q29udGV4dChuZXh0Um9vdEluc3RhbmNlKTsKICAgICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IkMSwgZmliZXIpOwogICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IkMSwgbmV4dFJvb3RDb250ZXh0LCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcEhvc3RDb250YWluZXIoZmliZXIpIHsKICAgICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IkMSwgZmliZXIpOwogICAgICAgICAgcG9wKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgICBwb3Aocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdENvbnRleHQoKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHJlcXVpcmVkQ29udGV4dChjb250ZXh0U3RhY2tDdXJzb3IkMS5jdXJyZW50KTsKICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoSG9zdENvbnRleHQoZmliZXIpIHsKICAgICAgICAgIHZhciByb290SW5zdGFuY2UgPSByZXF1aXJlZENvbnRleHQocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IuY3VycmVudCk7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHJlcXVpcmVkQ29udGV4dChjb250ZXh0U3RhY2tDdXJzb3IkMS5jdXJyZW50KTsKICAgICAgICAgIHZhciBuZXh0Q29udGV4dCA9IGdldENoaWxkSG9zdENvbnRleHQoY29udGV4dCwgZmliZXIudHlwZSk7CiAgICAgICAgICBpZiAoY29udGV4dCA9PT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcHVzaChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yJDEsIG5leHRDb250ZXh0LCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcEhvc3RDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICBpZiAoY29udGV4dEZpYmVyU3RhY2tDdXJzb3IuY3VycmVudCAhPT0gZmliZXIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciQxLCBmaWJlcik7CiAgICAgICAgICBwb3AoY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIERlZmF1bHRTdXNwZW5zZUNvbnRleHQgPSAwOwogICAgICAgIHZhciBTdWJ0cmVlU3VzcGVuc2VDb250ZXh0TWFzayA9IDE7CiAgICAgICAgdmFyIEludmlzaWJsZVBhcmVudFN1c3BlbnNlQ29udGV4dCA9IDE7CiAgICAgICAgdmFyIEZvcmNlU3VzcGVuc2VGYWxsYmFjayA9IDI7CiAgICAgICAgdmFyIHN1c3BlbnNlU3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoRGVmYXVsdFN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgZnVuY3Rpb24gaGFzU3VzcGVuc2VDb250ZXh0KHBhcmVudENvbnRleHQsIGZsYWcpIHsKICAgICAgICAgIHJldHVybiAocGFyZW50Q29udGV4dCAmIGZsYWcpICE9PSAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0KSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dCAmIFN1YnRyZWVTdXNwZW5zZUNvbnRleHRNYXNrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHBhcmVudENvbnRleHQsIHNoYWxsb3dDb250ZXh0KSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dCAmIFN1YnRyZWVTdXNwZW5zZUNvbnRleHRNYXNrIHwgc2hhbGxvd0NvbnRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZFN1YnRyZWVTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCwgc3VidHJlZUNvbnRleHQpIHsKICAgICAgICAgIHJldHVybiBwYXJlbnRDb250ZXh0IHwgc3VidHJlZUNvbnRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hTdXNwZW5zZUNvbnRleHQoZmliZXIsIG5ld0NvbnRleHQpIHsKICAgICAgICAgIHB1c2goc3VzcGVuc2VTdGFja0N1cnNvciwgbmV3Q29udGV4dCwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BTdXNwZW5zZUNvbnRleHQoZmliZXIpIHsKICAgICAgICAgIHBvcChzdXNwZW5zZVN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENhcHR1cmVTdXNwZW5zZSh3b3JrSW5Qcm9ncmVzczIsIGhhc0ludmlzaWJsZVBhcmVudCkgewogICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKG5leHRTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobmV4dFN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRGaXJzdFN1c3BlbmRlZChyb3cpIHsKICAgICAgICAgIHZhciBub2RlID0gcm93OwogICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBzdGF0ZSA9IG5vZGUubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBkZWh5ZHJhdGVkID0gc3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgICAgIGlmIChkZWh5ZHJhdGVkID09PSBudWxsIHx8IGlzU3VzcGVuc2VJbnN0YW5jZVBlbmRpbmcoZGVoeWRyYXRlZCkgfHwgaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soZGVoeWRyYXRlZCkpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBTdXNwZW5zZUxpc3RDb21wb25lbnQgJiYgLy8gcmV2ZWFsT3JkZXIgdW5kZWZpbmVkIGNhbid0IGJlIHRydXN0ZWQgYmVjYXVzZSBpdCBkb24ndAogICAgICAgICAgICAvLyBrZWVwIHRyYWNrIG9mIHdoZXRoZXIgaXQgc3VzcGVuZGVkIG9yIG5vdC4KICAgICAgICAgICAgbm9kZS5tZW1vaXplZFByb3BzLnJldmVhbE9yZGVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgZGlkU3VzcGVuZCA9IChub2RlLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLmNoaWxkOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlID09PSByb3cpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSByb3cpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBOb0ZsYWdzJDEgPSAoCiAgICAgICAgICAvKiAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgSGFzRWZmZWN0ID0gKAogICAgICAgICAgLyogKi8KICAgICAgICAgIDEKICAgICAgICApOwogICAgICAgIHZhciBJbnNlcnRpb24gPSAoCiAgICAgICAgICAvKiAgKi8KICAgICAgICAgIDIKICAgICAgICApOwogICAgICAgIHZhciBMYXlvdXQgPSAoCiAgICAgICAgICAvKiAgICAqLwogICAgICAgICAgNAogICAgICAgICk7CiAgICAgICAgdmFyIFBhc3NpdmUkMSA9ICgKICAgICAgICAgIC8qICAgKi8KICAgICAgICAgIDgKICAgICAgICApOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1NvdXJjZXMgPSBbXTsKICAgICAgICBmdW5jdGlvbiByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHdvcmtJblByb2dyZXNzU291cmNlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgbXV0YWJsZVNvdXJjZSA9IHdvcmtJblByb2dyZXNzU291cmNlc1tpXTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG11dGFibGVTb3VyY2UuX3dvcmtJblByb2dyZXNzVmVyc2lvblByaW1hcnkgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1NvdXJjZXMubGVuZ3RoID0gMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJNdXRhYmxlU291cmNlRm9ySHlkcmF0aW9uKHJvb3QzLCBtdXRhYmxlU291cmNlKSB7CiAgICAgICAgICB2YXIgZ2V0VmVyc2lvbiA9IG11dGFibGVTb3VyY2UuX2dldFZlcnNpb247CiAgICAgICAgICB2YXIgdmVyc2lvbjIgPSBnZXRWZXJzaW9uKG11dGFibGVTb3VyY2UuX3NvdXJjZSk7CiAgICAgICAgICBpZiAocm9vdDMubXV0YWJsZVNvdXJjZUVhZ2VySHlkcmF0aW9uRGF0YSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJvb3QzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEgPSBbbXV0YWJsZVNvdXJjZSwgdmVyc2lvbjJdOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcm9vdDMubXV0YWJsZVNvdXJjZUVhZ2VySHlkcmF0aW9uRGF0YS5wdXNoKG11dGFibGVTb3VyY2UsIHZlcnNpb24yKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXIsIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZzsKICAgICAgICB2YXIgZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdDsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRNaXNtYXRjaGVkSG9va3NGb3JDb21wb25lbnQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgIH0KICAgICAgICB2YXIgcmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxID0gbnVsbDsKICAgICAgICB2YXIgY3VycmVudEhvb2sgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBudWxsOwogICAgICAgIHZhciBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGZhbHNlOwogICAgICAgIHZhciBsb2NhbElkQ291bnRlciA9IDA7CiAgICAgICAgdmFyIGdsb2JhbENsaWVudElkQ291bnRlciA9IDA7CiAgICAgICAgdmFyIFJFX1JFTkRFUl9MSU1JVCA9IDI1OwogICAgICAgIHZhciBjdXJyZW50SG9va05hbWVJbkRldiA9IG51bGw7CiAgICAgICAgdmFyIGhvb2tUeXBlc0RldiA9IG51bGw7CiAgICAgICAgdmFyIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID0gLTE7CiAgICAgICAgdmFyIGlnbm9yZVByZXZpb3VzRGVwZW5kZW5jaWVzID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gbW91bnRIb29rVHlwZXNEZXYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob29rTmFtZSA9IGN1cnJlbnRIb29rTmFtZUluRGV2OwogICAgICAgICAgICBpZiAoaG9va1R5cGVzRGV2ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaG9va1R5cGVzRGV2ID0gW2hvb2tOYW1lXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBob29rVHlwZXNEZXYucHVzaChob29rTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSG9va1R5cGVzRGV2KCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9va05hbWUgPSBjdXJyZW50SG9va05hbWVJbkRldjsKICAgICAgICAgICAgaWYgKGhvb2tUeXBlc0RldiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2Kys7CiAgICAgICAgICAgICAgaWYgKGhvb2tUeXBlc0Rldltob29rVHlwZXNVcGRhdGVJbmRleERldl0gIT09IGhvb2tOYW1lKSB7CiAgICAgICAgICAgICAgICB3YXJuT25Ib29rTWlzbWF0Y2hJbkRldihob29rTmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRlcHMgIT09IHZvaWQgMCAmJiBkZXBzICE9PSBudWxsICYmICFpc0FycmF5MihkZXBzKSkgewogICAgICAgICAgICAgIGVycm9yKCIlcyByZWNlaXZlZCBhIGZpbmFsIGFyZ3VtZW50IHRoYXQgaXMgbm90IGFuIGFycmF5IChpbnN0ZWFkLCByZWNlaXZlZCBgJXNgKS4gV2hlbiBzcGVjaWZpZWQsIHRoZSBmaW5hbCBhcmd1bWVudCBtdXN0IGJlIGFuIGFycmF5LiIsIGN1cnJlbnRIb29rTmFtZUluRGV2LCB0eXBlb2YgZGVwcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk9uSG9va01pc21hdGNoSW5EZXYoY3VycmVudEhvb2tOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxKTsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNaXNtYXRjaGVkSG9va3NGb3JDb21wb25lbnQuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50LmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICBpZiAoaG9va1R5cGVzRGV2ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgdGFibGUgPSAiIjsKICAgICAgICAgICAgICAgIHZhciBzZWNvbmRDb2x1bW5TdGFydCA9IDMwOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPD0gaG9va1R5cGVzVXBkYXRlSW5kZXhEZXY7IGkrKykgewogICAgICAgICAgICAgICAgICB2YXIgb2xkSG9va05hbWUgPSBob29rVHlwZXNEZXZbaV07CiAgICAgICAgICAgICAgICAgIHZhciBuZXdIb29rTmFtZSA9IGkgPT09IGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID8gY3VycmVudEhvb2tOYW1lIDogb2xkSG9va05hbWU7CiAgICAgICAgICAgICAgICAgIHZhciByb3cgPSBpICsgMSArICIuICIgKyBvbGRIb29rTmFtZTsKICAgICAgICAgICAgICAgICAgd2hpbGUgKHJvdy5sZW5ndGggPCBzZWNvbmRDb2x1bW5TdGFydCkgewogICAgICAgICAgICAgICAgICAgIHJvdyArPSAiICI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcm93ICs9IG5ld0hvb2tOYW1lICsgIlxuIjsKICAgICAgICAgICAgICAgICAgdGFibGUgKz0gcm93OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGhhcyBkZXRlY3RlZCBhIGNoYW5nZSBpbiB0aGUgb3JkZXIgb2YgSG9va3MgY2FsbGVkIGJ5ICVzLiBUaGlzIHdpbGwgbGVhZCB0byBidWdzIGFuZCBlcnJvcnMgaWYgbm90IGZpeGVkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgcmVhZCB0aGUgUnVsZXMgb2YgSG9va3M6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9ydWxlcy1vZi1ob29rc1xuXG4gICBQcmV2aW91cyByZW5kZXIgICAgICAgICAgICBOZXh0IHJlbmRlclxuICAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4lcyAgIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXlxuIiwgY29tcG9uZW50TmFtZSwgdGFibGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd0ludmFsaWRIb29rRXJyb3IoKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgaG9vayBjYWxsLiBIb29rcyBjYW4gb25seSBiZSBjYWxsZWQgaW5zaWRlIG9mIHRoZSBib2R5IG9mIGEgZnVuY3Rpb24gY29tcG9uZW50LiBUaGlzIGNvdWxkIGhhcHBlbiBmb3Igb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVhc29uczpcbjEuIFlvdSBtaWdodCBoYXZlIG1pc21hdGNoaW5nIHZlcnNpb25zIG9mIFJlYWN0IGFuZCB0aGUgcmVuZGVyZXIgKHN1Y2ggYXMgUmVhY3QgRE9NKVxuMi4gWW91IG1pZ2h0IGJlIGJyZWFraW5nIHRoZSBSdWxlcyBvZiBIb29rc1xuMy4gWW91IG1pZ2h0IGhhdmUgbW9yZSB0aGFuIG9uZSBjb3B5IG9mIFJlYWN0IGluIHRoZSBzYW1lIGFwcFxuU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9pbnZhbGlkLWhvb2stY2FsbCBmb3IgdGlwcyBhYm91dCBob3cgdG8gZGVidWcgYW5kIGZpeCB0aGlzIHByb2JsZW0uIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFyZUhvb2tJbnB1dHNFcXVhbChuZXh0RGVwcywgcHJldkRlcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlnbm9yZVByZXZpb3VzRGVwZW5kZW5jaWVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJldkRlcHMgPT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCIlcyByZWNlaXZlZCBhIGZpbmFsIGFyZ3VtZW50IGR1cmluZyB0aGlzIHJlbmRlciwgYnV0IG5vdCBkdXJpbmcgdGhlIHByZXZpb3VzIHJlbmRlci4gRXZlbiB0aG91Z2ggdGhlIGZpbmFsIGFyZ3VtZW50IGlzIG9wdGlvbmFsLCBpdHMgdHlwZSBjYW5ub3QgY2hhbmdlIGJldHdlZW4gcmVuZGVycy4iLCBjdXJyZW50SG9va05hbWVJbkRldik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobmV4dERlcHMubGVuZ3RoICE9PSBwcmV2RGVwcy5sZW5ndGgpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGZpbmFsIGFyZ3VtZW50IHBhc3NlZCB0byAlcyBjaGFuZ2VkIHNpemUgYmV0d2VlbiByZW5kZXJzLiBUaGUgb3JkZXIgYW5kIHNpemUgb2YgdGhpcyBhcnJheSBtdXN0IHJlbWFpbiBjb25zdGFudC5cblxuUHJldmlvdXM6ICVzXG5JbmNvbWluZzogJXMiLCBjdXJyZW50SG9va05hbWVJbkRldiwgIlsiICsgcHJldkRlcHMuam9pbigiLCAiKSArICJdIiwgIlsiICsgbmV4dERlcHMuam9pbigiLCAiKSArICJdIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJldkRlcHMubGVuZ3RoICYmIGkgPCBuZXh0RGVwcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBpZiAob2JqZWN0SXMobmV4dERlcHNbaV0sIHByZXZEZXBzW2ldKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJXaXRoSG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgc2Vjb25kQXJnLCBuZXh0UmVuZGVyTGFuZXMpIHsKICAgICAgICAgIHJlbmRlckxhbmVzID0gbmV4dFJlbmRlckxhbmVzOwogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHsKICAgICAgICAgICAgaG9va1R5cGVzRGV2ID0gY3VycmVudDQgIT09IG51bGwgPyBjdXJyZW50NC5fZGVidWdIb29rVHlwZXMgOiBudWxsOwogICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgICBpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcyA9IGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0LnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC5tZW1vaXplZFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICB9IGVsc2UgaWYgKGhvb2tUeXBlc0RldiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSG9va3NEaXNwYXRjaGVyT25Nb3VudFdpdGhIb29rVHlwZXNJbkRFVjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkcmVuID0gQ29tcG9uZW50KHByb3BzLCBzZWNvbmRBcmcpOwogICAgICAgICAgaWYgKGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcykgewogICAgICAgICAgICB2YXIgbnVtYmVyT2ZSZVJlbmRlcnMgPSAwOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZmFsc2U7CiAgICAgICAgICAgICAgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgICAgICAgIGlmIChudW1iZXJPZlJlUmVuZGVycyA+PSBSRV9SRU5ERVJfTElNSVQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVG9vIG1hbnkgcmUtcmVuZGVycy4gUmVhY3QgbGltaXRzIHRoZSBudW1iZXIgb2YgcmVuZGVycyB0byBwcmV2ZW50IGFuIGluZmluaXRlIGxvb3AuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG51bWJlck9mUmVSZW5kZXJzICs9IDE7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICBjaGlsZHJlbiA9IENvbXBvbmVudChwcm9wcywgc2Vjb25kQXJnKTsKICAgICAgICAgICAgfSB3aGlsZSAoZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzKTsKICAgICAgICAgIH0KICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnSG9va1R5cGVzID0gaG9va1R5cGVzRGV2OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRpZFJlbmRlclRvb0Zld0hvb2tzID0gY3VycmVudEhvb2sgIT09IG51bGwgJiYgY3VycmVudEhvb2submV4dCAhPT0gbnVsbDsKICAgICAgICAgIHJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSBudWxsOwogICAgICAgICAgY3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSBudWxsOwogICAgICAgICAgICBob29rVHlwZXNEZXYgPSBudWxsOwogICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgKGN1cnJlbnQ0LmZsYWdzICYgU3RhdGljTWFzaykgIT09ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBTdGF0aWNNYXNrKSAmJiAvLyBEaXNhYmxlIHRoaXMgd2FybmluZyBpbiBsZWdhY3kgbW9kZSwgYmVjYXVzZSBsZWdhY3kgU3VzcGVuc2UgaXMgd2VpcmQKICAgICAgICAgICAgLy8gYW5kIGNyZWF0ZXMgZmFsc2UgcG9zaXRpdmVzLiBUbyBtYWtlIHRoaXMgd29yayBpbiBsZWdhY3kgbW9kZSwgd2UnZAogICAgICAgICAgICAvLyBuZWVkIHRvIG1hcmsgZmliZXJzIHRoYXQgY29tbWl0IGluIGFuIGluY29tcGxldGUgc3RhdGUsIHNvbWVob3cuIEZvcgogICAgICAgICAgICAvLyBub3cgSSdsbCBkaXNhYmxlIHRoZSB3YXJuaW5nIHRoYXQgbW9zdCBvZiB0aGUgYnVncyB0aGF0IHdvdWxkIHRyaWdnZXIKICAgICAgICAgICAgLy8gaXQgYXJlIGVpdGhlciBleGNsdXNpdmUgdG8gY29uY3VycmVudCBtb2RlIG9yIGV4aXN0IGluIGJvdGguCiAgICAgICAgICAgIChjdXJyZW50NC5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICBlcnJvcigiSW50ZXJuYWwgUmVhY3QgZXJyb3I6IEV4cGVjdGVkIHN0YXRpYyBmbGFnIHdhcyBtaXNzaW5nLiBQbGVhc2Ugbm90aWZ5IHRoZSBSZWFjdCB0ZWFtLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICBpZiAoZGlkUmVuZGVyVG9vRmV3SG9va3MpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZW5kZXJlZCBmZXdlciBob29rcyB0aGFuIGV4cGVjdGVkLiBUaGlzIG1heSBiZSBjYXVzZWQgYnkgYW4gYWNjaWRlbnRhbCBlYXJseSByZXR1cm4gc3RhdGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNoaWxkcmVuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0RpZFJlbmRlcklkSG9vaygpIHsKICAgICAgICAgIHZhciBkaWRSZW5kZXJJZEhvb2sgPSBsb2NhbElkQ291bnRlciAhPT0gMDsKICAgICAgICAgIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICAgIHJldHVybiBkaWRSZW5kZXJJZEhvb2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhaWxvdXRIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBsYW5lcykgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gY3VycmVudDQudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IH4oTW91bnRQYXNzaXZlRGV2IHwgTW91bnRMYXlvdXREZXYgfCBQYXNzaXZlIHwgVXBkYXRlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+KFBhc3NpdmUgfCBVcGRhdGUpOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudDQubGFuZXMgPSByZW1vdmVMYW5lcyhjdXJyZW50NC5sYW5lcywgbGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldEhvb2tzQWZ0ZXJUaHJvdygpIHsKICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgaWYgKGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHdoaWxlIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHF1ZXVlID0gaG9vay5xdWV1ZTsKICAgICAgICAgICAgICBpZiAocXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBob29rID0gaG9vay5uZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSBudWxsOwogICAgICAgICAgY3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgaG9va1R5cGVzRGV2ID0gbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSBudWxsOwogICAgICAgICAgICBpc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MgPSBmYWxzZTsKICAgICAgICAgIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHsKICAgICAgICAgICAgbWVtb2l6ZWRTdGF0ZTogbnVsbCwKICAgICAgICAgICAgYmFzZVN0YXRlOiBudWxsLAogICAgICAgICAgICBiYXNlUXVldWU6IG51bGwsCiAgICAgICAgICAgIHF1ZXVlOiBudWxsLAogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzSG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGUgPSB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBob29rOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gd29ya0luUHJvZ3Jlc3NIb29rLm5leHQgPSBob29rOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzSG9vazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCkgewogICAgICAgICAgdmFyIG5leHRDdXJyZW50SG9vazsKICAgICAgICAgIGlmIChjdXJyZW50SG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudDQgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV4dEN1cnJlbnRIb29rID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0Q3VycmVudEhvb2sgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0Q3VycmVudEhvb2sgPSBjdXJyZW50SG9vay5uZXh0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRXb3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgIG5leHRXb3JrSW5Qcm9ncmVzc0hvb2sgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0V29ya0luUHJvZ3Jlc3NIb29rID0gd29ya0luUHJvZ3Jlc3NIb29rLm5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmV4dFdvcmtJblByb2dyZXNzSG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBuZXh0V29ya0luUHJvZ3Jlc3NIb29rOwogICAgICAgICAgICBuZXh0V29ya0luUHJvZ3Jlc3NIb29rID0gd29ya0luUHJvZ3Jlc3NIb29rLm5leHQ7CiAgICAgICAgICAgIGN1cnJlbnRIb29rID0gbmV4dEN1cnJlbnRIb29rOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG5leHRDdXJyZW50SG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVuZGVyZWQgbW9yZSBob29rcyB0aGFuIGR1cmluZyB0aGUgcHJldmlvdXMgcmVuZGVyLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnRIb29rID0gbmV4dEN1cnJlbnRIb29rOwogICAgICAgICAgICB2YXIgbmV3SG9vayA9IHsKICAgICAgICAgICAgICBtZW1vaXplZFN0YXRlOiBjdXJyZW50SG9vay5tZW1vaXplZFN0YXRlLAogICAgICAgICAgICAgIGJhc2VTdGF0ZTogY3VycmVudEhvb2suYmFzZVN0YXRlLAogICAgICAgICAgICAgIGJhc2VRdWV1ZTogY3VycmVudEhvb2suYmFzZVF1ZXVlLAogICAgICAgICAgICAgIHF1ZXVlOiBjdXJyZW50SG9vay5xdWV1ZSwKICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc0hvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1lbW9pemVkU3RhdGUgPSB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBuZXdIb29rOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0ID0gbmV3SG9vazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzSG9vazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRnVuY3Rpb25Db21wb25lbnRVcGRhdGVRdWV1ZSgpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGxhc3RFZmZlY3Q6IG51bGwsCiAgICAgICAgICAgIHN0b3JlczogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmFzaWNTdGF0ZVJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgICAgcmV0dXJuIHR5cGVvZiBhY3Rpb24gPT09ICJmdW5jdGlvbiIgPyBhY3Rpb24oc3RhdGUpIDogYWN0aW9uOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIGluaXRpYWxTdGF0ZTEzOwogICAgICAgICAgaWYgKGluaXQgIT09IHZvaWQgMCkgewogICAgICAgICAgICBpbml0aWFsU3RhdGUxMyA9IGluaXQoaW5pdGlhbEFyZyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpbml0aWFsU3RhdGUxMyA9IGluaXRpYWxBcmc7CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBob29rLmJhc2VTdGF0ZSA9IGluaXRpYWxTdGF0ZTEzOwogICAgICAgICAgdmFyIHF1ZXVlID0gewogICAgICAgICAgICBwZW5kaW5nOiBudWxsLAogICAgICAgICAgICBpbnRlcmxlYXZlZDogbnVsbCwKICAgICAgICAgICAgbGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgIGRpc3BhdGNoOiBudWxsLAogICAgICAgICAgICBsYXN0UmVuZGVyZWRSZWR1Y2VyOiByZWR1Y2VyLAogICAgICAgICAgICBsYXN0UmVuZGVyZWRTdGF0ZTogaW5pdGlhbFN0YXRlMTMKICAgICAgICAgIH07CiAgICAgICAgICBob29rLnF1ZXVlID0gcXVldWU7CiAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSBxdWV1ZS5kaXNwYXRjaCA9IGRpc3BhdGNoUmVkdWNlckFjdGlvbi5iaW5kKG51bGwsIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEsIHF1ZXVlKTsKICAgICAgICAgIHJldHVybiBbaG9vay5tZW1vaXplZFN0YXRlLCBkaXNwYXRjaF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBxdWV1ZSA9IGhvb2sucXVldWU7CiAgICAgICAgICBpZiAocXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgaGF2ZSBhIHF1ZXVlLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyID0gcmVkdWNlcjsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IGN1cnJlbnRIb29rOwogICAgICAgICAgdmFyIGJhc2VRdWV1ZSA9IGN1cnJlbnQ0LmJhc2VRdWV1ZTsKICAgICAgICAgIHZhciBwZW5kaW5nUXVldWUgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgaWYgKHBlbmRpbmdRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoYmFzZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGJhc2VGaXJzdCA9IGJhc2VRdWV1ZS5uZXh0OwogICAgICAgICAgICAgIHZhciBwZW5kaW5nRmlyc3QgPSBwZW5kaW5nUXVldWUubmV4dDsKICAgICAgICAgICAgICBiYXNlUXVldWUubmV4dCA9IHBlbmRpbmdGaXJzdDsKICAgICAgICAgICAgICBwZW5kaW5nUXVldWUubmV4dCA9IGJhc2VGaXJzdDsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0LmJhc2VRdWV1ZSAhPT0gYmFzZVF1ZXVlKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW50ZXJuYWwgZXJyb3I6IEV4cGVjdGVkIHdvcmstaW4tcHJvZ3Jlc3MgcXVldWUgdG8gYmUgYSBjbG9uZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudDQuYmFzZVF1ZXVlID0gYmFzZVF1ZXVlID0gcGVuZGluZ1F1ZXVlOwogICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChiYXNlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpcnN0ID0gYmFzZVF1ZXVlLm5leHQ7CiAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGN1cnJlbnQ0LmJhc2VTdGF0ZTsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBuZXdCYXNlUXVldWVGaXJzdCA9IG51bGw7CiAgICAgICAgICAgIHZhciBuZXdCYXNlUXVldWVMYXN0ID0gbnVsbDsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGZpcnN0OwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZUxhbmUgPSB1cGRhdGUubGFuZTsKICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhyZW5kZXJMYW5lcywgdXBkYXRlTGFuZSkpIHsKICAgICAgICAgICAgICAgIHZhciBjbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgbGFuZTogdXBkYXRlTGFuZSwKICAgICAgICAgICAgICAgICAgYWN0aW9uOiB1cGRhdGUuYWN0aW9uLAogICAgICAgICAgICAgICAgICBoYXNFYWdlclN0YXRlOiB1cGRhdGUuaGFzRWFnZXJTdGF0ZSwKICAgICAgICAgICAgICAgICAgZWFnZXJTdGF0ZTogdXBkYXRlLmVhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAobmV3QmFzZVF1ZXVlTGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXdCYXNlUXVldWVGaXJzdCA9IG5ld0Jhc2VRdWV1ZUxhc3QgPSBjbG9uZTsKICAgICAgICAgICAgICAgICAgbmV3QmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBuZXdCYXNlUXVldWVMYXN0ID0gbmV3QmFzZVF1ZXVlTGFzdC5uZXh0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzID0gbWVyZ2VMYW5lcyhjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzLCB1cGRhdGVMYW5lKTsKICAgICAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXModXBkYXRlTGFuZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChuZXdCYXNlUXVldWVMYXN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyB1cGRhdGUgaXMgZ29pbmcgdG8gYmUgY29tbWl0dGVkIHNvIHdlIG5ldmVyIHdhbnQgdW5jb21taXQKICAgICAgICAgICAgICAgICAgICAvLyBpdC4gVXNpbmcgTm9MYW5lIHdvcmtzIGJlY2F1c2UgMCBpcyBhIHN1YnNldCBvZiBhbGwgYml0bWFza3MsIHNvCiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyB3aWxsIG5ldmVyIGJlIHNraXBwZWQgYnkgdGhlIGNoZWNrIGFib3ZlLgogICAgICAgICAgICAgICAgICAgIGxhbmU6IE5vTGFuZSwKICAgICAgICAgICAgICAgICAgICBhY3Rpb246IHVwZGF0ZS5hY3Rpb24sCiAgICAgICAgICAgICAgICAgICAgaGFzRWFnZXJTdGF0ZTogdXBkYXRlLmhhc0VhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgICAgZWFnZXJTdGF0ZTogdXBkYXRlLmVhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBuZXdCYXNlUXVldWVMYXN0ID0gbmV3QmFzZVF1ZXVlTGFzdC5uZXh0ID0gX2Nsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHVwZGF0ZS5oYXNFYWdlclN0YXRlKSB7CiAgICAgICAgICAgICAgICAgIG5ld1N0YXRlID0gdXBkYXRlLmVhZ2VyU3RhdGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gdXBkYXRlLmFjdGlvbjsKICAgICAgICAgICAgICAgICAgbmV3U3RhdGUgPSByZWR1Y2VyKG5ld1N0YXRlLCBhY3Rpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAodXBkYXRlICE9PSBudWxsICYmIHVwZGF0ZSAhPT0gZmlyc3QpOwogICAgICAgICAgICBpZiAobmV3QmFzZVF1ZXVlTGFzdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5ld0Jhc2VRdWV1ZUxhc3QubmV4dCA9IG5ld0Jhc2VRdWV1ZUZpcnN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV3U3RhdGUsIGhvb2subWVtb2l6ZWRTdGF0ZSkpIHsKICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld0Jhc2VTdGF0ZTsKICAgICAgICAgICAgaG9vay5iYXNlUXVldWUgPSBuZXdCYXNlUXVldWVMYXN0OwogICAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhc3RJbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgaWYgKGxhc3RJbnRlcmxlYXZlZCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWQgPSBsYXN0SW50ZXJsZWF2ZWQ7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICB2YXIgaW50ZXJsZWF2ZWRMYW5lID0gaW50ZXJsZWF2ZWQubGFuZTsKICAgICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzID0gbWVyZ2VMYW5lcyhjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmxhbmVzLCBpbnRlcmxlYXZlZExhbmUpOwogICAgICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMoaW50ZXJsZWF2ZWRMYW5lKTsKICAgICAgICAgICAgICBpbnRlcmxlYXZlZCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKGludGVybGVhdmVkICE9PSBsYXN0SW50ZXJsZWF2ZWQpOwogICAgICAgICAgfSBlbHNlIGlmIChiYXNlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRpc3BhdGNoID0gcXVldWUuZGlzcGF0Y2g7CiAgICAgICAgICByZXR1cm4gW2hvb2subWVtb2l6ZWRTdGF0ZSwgZGlzcGF0Y2hdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBxdWV1ZSA9IGhvb2sucXVldWU7CiAgICAgICAgICBpZiAocXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgaGF2ZSBhIHF1ZXVlLiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyID0gcmVkdWNlcjsKICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHF1ZXVlLmRpc3BhdGNoOwogICAgICAgICAgdmFyIGxhc3RSZW5kZXJQaGFzZVVwZGF0ZSA9IHF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAobGFzdFJlbmRlclBoYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICB2YXIgZmlyc3RSZW5kZXJQaGFzZVVwZGF0ZSA9IGxhc3RSZW5kZXJQaGFzZVVwZGF0ZS5uZXh0OwogICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3RSZW5kZXJQaGFzZVVwZGF0ZTsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciBhY3Rpb24gPSB1cGRhdGUuYWN0aW9uOwogICAgICAgICAgICAgIG5ld1N0YXRlID0gcmVkdWNlcihuZXdTdGF0ZSwgYWN0aW9uKTsKICAgICAgICAgICAgICB1cGRhdGUgPSB1cGRhdGUubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAodXBkYXRlICE9PSBmaXJzdFJlbmRlclBoYXNlVXBkYXRlKTsKICAgICAgICAgICAgaWYgKCFvYmplY3RJcyhuZXdTdGF0ZSwgaG9vay5tZW1vaXplZFN0YXRlKSkgewogICAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIGlmIChob29rLmJhc2VRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcXVldWUubGFzdFJlbmRlcmVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBbbmV3U3RhdGUsIGRpc3BhdGNoXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRNdXRhYmxlU291cmNlKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVNdXRhYmxlU291cmNlKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxOwogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHRTbmFwc2hvdDsKICAgICAgICAgIHZhciBpc0h5ZHJhdGluZzIgPSBnZXRJc0h5ZHJhdGluZygpOwogICAgICAgICAgaWYgKGlzSHlkcmF0aW5nMikgewogICAgICAgICAgICBpZiAoZ2V0U2VydmVyU25hcHNob3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWlzc2luZyBnZXRTZXJ2ZXJTbmFwc2hvdCwgd2hpY2ggaXMgcmVxdWlyZWQgZm9yIHNlcnZlci1yZW5kZXJlZCBjb250ZW50LiBXaWxsIHJldmVydCB0byBjbGllbnQgcmVuZGVyaW5nLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRTbmFwc2hvdCA9IGdldFNlcnZlclNuYXBzaG90KCk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90KSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dFNuYXBzaG90ICE9PSBnZXRTZXJ2ZXJTbmFwc2hvdCgpKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgcmVzdWx0IG9mIGdldFNlcnZlclNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0U25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCkgewogICAgICAgICAgICAgICAgdmFyIGNhY2hlZFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV4dFNuYXBzaG90LCBjYWNoZWRTbmFwc2hvdCkpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlRoZSByZXN1bHQgb2YgZ2V0U25hcHNob3Qgc2hvdWxkIGJlIGNhY2hlZCB0byBhdm9pZCBhbiBpbmZpbml0ZSBsb29wIik7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCk7CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgYSB3b3JrLWluLXByb2dyZXNzIHJvb3QuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIHJlbmRlckxhbmVzKSkgewogICAgICAgICAgICAgIHB1c2hTdG9yZUNvbnNpc3RlbmN5Q2hlY2soZmliZXIsIGdldFNuYXBzaG90LCBuZXh0U25hcHNob3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICB2YXIgaW5zdCA9IHsKICAgICAgICAgICAgdmFsdWU6IG5leHRTbmFwc2hvdCwKICAgICAgICAgICAgZ2V0U25hcHNob3QKICAgICAgICAgIH07CiAgICAgICAgICBob29rLnF1ZXVlID0gaW5zdDsKICAgICAgICAgIG1vdW50RWZmZWN0KHN1YnNjcmliZVRvU3RvcmUuYmluZChudWxsLCBmaWJlciwgaW5zdCwgc3Vic2NyaWJlKSwgW3N1YnNjcmliZV0pOwogICAgICAgICAgZmliZXIuZmxhZ3MgfD0gUGFzc2l2ZTsKICAgICAgICAgIHB1c2hFZmZlY3QoSGFzRWZmZWN0IHwgUGFzc2l2ZSQxLCB1cGRhdGVTdG9yZUluc3RhbmNlLmJpbmQobnVsbCwgZmliZXIsIGluc3QsIG5leHRTbmFwc2hvdCwgZ2V0U25hcHNob3QpLCB2b2lkIDAsIG51bGwpOwogICAgICAgICAgcmV0dXJuIG5leHRTbmFwc2hvdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDE7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHRTbmFwc2hvdCA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgICAgICB2YXIgY2FjaGVkU25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV4dFNuYXBzaG90LCBjYWNoZWRTbmFwc2hvdCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgcmVzdWx0IG9mIGdldFNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIpOwogICAgICAgICAgICAgICAgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZTbmFwc2hvdCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBzbmFwc2hvdENoYW5nZWQgPSAhb2JqZWN0SXMocHJldlNuYXBzaG90LCBuZXh0U25hcHNob3QpOwogICAgICAgICAgaWYgKHNuYXBzaG90Q2hhbmdlZCkgewogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdCA9IGhvb2sucXVldWU7CiAgICAgICAgICB1cGRhdGVFZmZlY3Qoc3Vic2NyaWJlVG9TdG9yZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBzdWJzY3JpYmUpLCBbc3Vic2NyaWJlXSk7CiAgICAgICAgICBpZiAoaW5zdC5nZXRTbmFwc2hvdCAhPT0gZ2V0U25hcHNob3QgfHwgc25hcHNob3RDaGFuZ2VkIHx8IC8vIENoZWNrIGlmIHRoZSBzdXNiY3JpYmUgZnVuY3Rpb24gY2hhbmdlZC4gV2UgY2FuIHNhdmUgc29tZSBtZW1vcnkgYnkKICAgICAgICAgIC8vIGNoZWNraW5nIHdoZXRoZXIgd2Ugc2NoZWR1bGVkIGEgc3Vic2NyaXB0aW9uIGVmZmVjdCBhYm92ZS4KICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayAhPT0gbnVsbCAmJiB3b3JrSW5Qcm9ncmVzc0hvb2subWVtb2l6ZWRTdGF0ZS50YWcgJiBIYXNFZmZlY3QpIHsKICAgICAgICAgICAgZmliZXIuZmxhZ3MgfD0gUGFzc2l2ZTsKICAgICAgICAgICAgcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBQYXNzaXZlJDEsIHVwZGF0ZVN0b3JlSW5zdGFuY2UuYmluZChudWxsLCBmaWJlciwgaW5zdCwgbmV4dFNuYXBzaG90LCBnZXRTbmFwc2hvdCksIHZvaWQgMCwgbnVsbCk7CiAgICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgICBpZiAocm9vdDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGEgd29yay1pbi1wcm9ncmVzcyByb290LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCByZW5kZXJMYW5lcykpIHsKICAgICAgICAgICAgICBwdXNoU3RvcmVDb25zaXN0ZW5jeUNoZWNrKGZpYmVyLCBnZXRTbmFwc2hvdCwgbmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5leHRTbmFwc2hvdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFN0b3JlQ29uc2lzdGVuY3lDaGVjayhmaWJlciwgZ2V0U25hcHNob3QsIHJlbmRlcmVkU25hcHNob3QpIHsKICAgICAgICAgIGZpYmVyLmZsYWdzIHw9IFN0b3JlQ29uc2lzdGVuY3k7CiAgICAgICAgICB2YXIgY2hlY2sgPSB7CiAgICAgICAgICAgIGdldFNuYXBzaG90LAogICAgICAgICAgICB2YWx1ZTogcmVuZGVyZWRTbmFwc2hvdAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAoY29tcG9uZW50VXBkYXRlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUgPSBjcmVhdGVGdW5jdGlvbkNvbXBvbmVudFVwZGF0ZVF1ZXVlKCk7CiAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEudXBkYXRlUXVldWUgPSBjb21wb25lbnRVcGRhdGVRdWV1ZTsKICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUuc3RvcmVzID0gW2NoZWNrXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzdG9yZXMgPSBjb21wb25lbnRVcGRhdGVRdWV1ZS5zdG9yZXM7CiAgICAgICAgICAgIGlmIChzdG9yZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5zdG9yZXMgPSBbY2hlY2tdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN0b3Jlcy5wdXNoKGNoZWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdG9yZUluc3RhbmNlKGZpYmVyLCBpbnN0LCBuZXh0U25hcHNob3QsIGdldFNuYXBzaG90KSB7CiAgICAgICAgICBpbnN0LnZhbHVlID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgaW5zdC5nZXRTbmFwc2hvdCA9IGdldFNuYXBzaG90OwogICAgICAgICAgaWYgKGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkpIHsKICAgICAgICAgICAgZm9yY2VTdG9yZVJlcmVuZGVyKGZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3Vic2NyaWJlVG9TdG9yZShmaWJlciwgaW5zdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICB2YXIgaGFuZGxlU3RvcmVDaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkpIHsKICAgICAgICAgICAgICBmb3JjZVN0b3JlUmVyZW5kZXIoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHN1YnNjcmliZShoYW5kbGVTdG9yZUNoYW5nZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkgewogICAgICAgICAgdmFyIGxhdGVzdEdldFNuYXBzaG90ID0gaW5zdC5nZXRTbmFwc2hvdDsKICAgICAgICAgIHZhciBwcmV2VmFsdWUgPSBpbnN0LnZhbHVlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IGxhdGVzdEdldFNuYXBzaG90KCk7CiAgICAgICAgICAgIHJldHVybiAhb2JqZWN0SXMocHJldlZhbHVlLCBuZXh0VmFsdWUpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmb3JjZVN0b3JlUmVyZW5kZXIoZmliZXIpIHsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGlmICh0eXBlb2YgaW5pdGlhbFN0YXRlMTMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaW5pdGlhbFN0YXRlMTMgPSBpbml0aWFsU3RhdGUxMygpOwogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gaG9vay5iYXNlU3RhdGUgPSBpbml0aWFsU3RhdGUxMzsKICAgICAgICAgIHZhciBxdWV1ZSA9IHsKICAgICAgICAgICAgcGVuZGluZzogbnVsbCwKICAgICAgICAgICAgaW50ZXJsZWF2ZWQ6IG51bGwsCiAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICBkaXNwYXRjaDogbnVsbCwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkUmVkdWNlcjogYmFzaWNTdGF0ZVJlZHVjZXIsCiAgICAgICAgICAgIGxhc3RSZW5kZXJlZFN0YXRlOiBpbml0aWFsU3RhdGUxMwogICAgICAgICAgfTsKICAgICAgICAgIGhvb2sucXVldWUgPSBxdWV1ZTsKICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHF1ZXVlLmRpc3BhdGNoID0gZGlzcGF0Y2hTZXRTdGF0ZS5iaW5kKG51bGwsIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEsIHF1ZXVlKTsKICAgICAgICAgIHJldHVybiBbaG9vay5tZW1vaXplZFN0YXRlLCBkaXNwYXRjaF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN0YXRlKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlUmVkdWNlcihiYXNpY1N0YXRlUmVkdWNlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyU3RhdGUoaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgIHJldHVybiByZXJlbmRlclJlZHVjZXIoYmFzaWNTdGF0ZVJlZHVjZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoRWZmZWN0KHRhZywgY3JlYXRlLCBkZXN0cm95LCBkZXBzKSB7CiAgICAgICAgICB2YXIgZWZmZWN0ID0gewogICAgICAgICAgICB0YWcsCiAgICAgICAgICAgIGNyZWF0ZSwKICAgICAgICAgICAgZGVzdHJveSwKICAgICAgICAgICAgZGVwcywKICAgICAgICAgICAgLy8gQ2lyY3VsYXIKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb21wb25lbnRVcGRhdGVRdWV1ZSA9IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAoY29tcG9uZW50VXBkYXRlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUgPSBjcmVhdGVGdW5jdGlvbkNvbXBvbmVudFVwZGF0ZVF1ZXVlKCk7CiAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEudXBkYXRlUXVldWUgPSBjb21wb25lbnRVcGRhdGVRdWV1ZTsKICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUubGFzdEVmZmVjdCA9IGVmZmVjdC5uZXh0ID0gZWZmZWN0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGxhc3RFZmZlY3QgPSBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0OwogICAgICAgICAgICBpZiAobGFzdEVmZmVjdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgPSBlZmZlY3QubmV4dCA9IGVmZmVjdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZmlyc3RFZmZlY3QgPSBsYXN0RWZmZWN0Lm5leHQ7CiAgICAgICAgICAgICAgbGFzdEVmZmVjdC5uZXh0ID0gZWZmZWN0OwogICAgICAgICAgICAgIGVmZmVjdC5uZXh0ID0gZmlyc3RFZmZlY3Q7CiAgICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUubGFzdEVmZmVjdCA9IGVmZmVjdDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVmZmVjdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRSZWYoaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBfcmVmMiA9IHsKICAgICAgICAgICAgICBjdXJyZW50OiBpbml0aWFsVmFsdWUKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gX3JlZjI7CiAgICAgICAgICAgIHJldHVybiBfcmVmMjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUmVmKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHJldHVybiBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RWZmZWN0SW1wbChmaWJlckZsYWdzLCBob29rRmxhZ3MsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmZsYWdzIHw9IGZpYmVyRmxhZ3M7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBwdXNoRWZmZWN0KEhhc0VmZmVjdCB8IGhvb2tGbGFncywgY3JlYXRlLCB2b2lkIDAsIG5leHREZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRWZmZWN0SW1wbChmaWJlckZsYWdzLCBob29rRmxhZ3MsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgdmFyIGRlc3Ryb3kgPSB2b2lkIDA7CiAgICAgICAgICBpZiAoY3VycmVudEhvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHByZXZFZmZlY3QgPSBjdXJyZW50SG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBkZXN0cm95ID0gcHJldkVmZmVjdC5kZXN0cm95OwogICAgICAgICAgICBpZiAobmV4dERlcHMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJldkRlcHMgPSBwcmV2RWZmZWN0LmRlcHM7CiAgICAgICAgICAgICAgaWYgKGFyZUhvb2tJbnB1dHNFcXVhbChuZXh0RGVwcywgcHJldkRlcHMpKSB7CiAgICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBwdXNoRWZmZWN0KGhvb2tGbGFncywgY3JlYXRlLCBkZXN0cm95LCBuZXh0RGVwcyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLmZsYWdzIHw9IGZpYmVyRmxhZ3M7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBwdXNoRWZmZWN0KEhhc0VmZmVjdCB8IGhvb2tGbGFncywgY3JlYXRlLCBkZXN0cm95LCBuZXh0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgaWYgKChjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3RJbXBsKE1vdW50UGFzc2l2ZURldiB8IFBhc3NpdmUgfCBQYXNzaXZlU3RhdGljLCBQYXNzaXZlJDEsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3RJbXBsKFBhc3NpdmUgfCBQYXNzaXZlU3RhdGljLCBQYXNzaXZlJDEsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3RJbXBsKFBhc3NpdmUsIFBhc3NpdmUkMSwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3RJbXBsKFVwZGF0ZSwgSW5zZXJ0aW9uLCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChVcGRhdGUsIEluc2VydGlvbiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3RJbXBsKGZpYmVyRmxhZ3MsIExheW91dCwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoVXBkYXRlLCBMYXlvdXQsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGltcGVyYXRpdmVIYW5kbGVFZmZlY3QoY3JlYXRlLCByZWYpIHsKICAgICAgICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciByZWZDYWxsYmFjayA9IHJlZjsKICAgICAgICAgICAgdmFyIF9pbnN0ID0gY3JlYXRlKCk7CiAgICAgICAgICAgIHJlZkNhbGxiYWNrKF9pbnN0KTsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJlZkNhbGxiYWNrKG51bGwpOwogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIGlmIChyZWYgIT09IG51bGwgJiYgcmVmICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFyIHJlZk9iamVjdCA9IHJlZjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghcmVmT2JqZWN0Lmhhc093blByb3BlcnR5KCJjdXJyZW50IikpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB1c2VJbXBlcmF0aXZlSGFuZGxlKCkgZmlyc3QgYXJndW1lbnQgdG8gZWl0aGVyIGJlIGEgcmVmIGNhbGxiYWNrIG9yIFJlYWN0LmNyZWF0ZVJlZigpIG9iamVjdC4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgImFuIG9iamVjdCB3aXRoIGtleXMgeyIgKyBPYmplY3Qua2V5cyhyZWZPYmplY3QpLmpvaW4oIiwgIikgKyAifSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX2luc3QyID0gY3JlYXRlKCk7CiAgICAgICAgICAgIHJlZk9iamVjdC5jdXJyZW50ID0gX2luc3QyOwogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmVmT2JqZWN0LmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjcmVhdGUgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdXNlSW1wZXJhdGl2ZUhhbmRsZSgpIHNlY29uZCBhcmd1bWVudCB0byBiZSBhIGZ1bmN0aW9uIHRoYXQgY3JlYXRlcyBhIGhhbmRsZS4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY3JlYXRlICE9PSBudWxsID8gdHlwZW9mIGNyZWF0ZSA6ICJudWxsIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBlZmZlY3REZXBzID0gZGVwcyAhPT0gbnVsbCAmJiBkZXBzICE9PSB2b2lkIDAgPyBkZXBzLmNvbmNhdChbcmVmXSkgOiBudWxsOwogICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChmaWJlckZsYWdzLCBMYXlvdXQsIGltcGVyYXRpdmVIYW5kbGVFZmZlY3QuYmluZChudWxsLCBjcmVhdGUsIHJlZiksIGVmZmVjdERlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3JlYXRlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHVzZUltcGVyYXRpdmVIYW5kbGUoKSBzZWNvbmQgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbiB0aGF0IGNyZWF0ZXMgYSBoYW5kbGUuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNyZWF0ZSAhPT0gbnVsbCA/IHR5cGVvZiBjcmVhdGUgOiAibnVsbCIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWZmZWN0RGVwcyA9IGRlcHMgIT09IG51bGwgJiYgZGVwcyAhPT0gdm9pZCAwID8gZGVwcy5jb25jYXQoW3JlZl0pIDogbnVsbDsKICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3RJbXBsKFVwZGF0ZSwgTGF5b3V0LCBpbXBlcmF0aXZlSGFuZGxlRWZmZWN0LmJpbmQobnVsbCwgY3JlYXRlLCByZWYpLCBlZmZlY3REZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnREZWJ1Z1ZhbHVlKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgIH0KICAgICAgICB2YXIgdXBkYXRlRGVidWdWYWx1ZSA9IG1vdW50RGVidWdWYWx1ZTsKICAgICAgICBmdW5jdGlvbiBtb3VudENhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IFtjYWxsYmFjaywgbmV4dERlcHNdOwogICAgICAgICAgcmV0dXJuIGNhbGxiYWNrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDYWxsYmFjayhjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5leHREZXBzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZEZXBzID0gcHJldlN0YXRlWzFdOwogICAgICAgICAgICAgIGlmIChhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZVswXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IFtjYWxsYmFjaywgbmV4dERlcHNdOwogICAgICAgICAgcmV0dXJuIGNhbGxiYWNrOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudE1lbW8obmV4dENyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gbmV4dENyZWF0ZSgpOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gW25leHRWYWx1ZSwgbmV4dERlcHNdOwogICAgICAgICAgcmV0dXJuIG5leHRWYWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTWVtbyhuZXh0Q3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobmV4dERlcHMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJldkRlcHMgPSBwcmV2U3RhdGVbMV07CiAgICAgICAgICAgICAgaWYgKGFyZUhvb2tJbnB1dHNFcXVhbChuZXh0RGVwcywgcHJldkRlcHMpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJldlN0YXRlWzBdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IG5leHRDcmVhdGUoKTsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IFtuZXh0VmFsdWUsIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBuZXh0VmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RGVmZXJyZWRWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gdmFsdWU7CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgcmVzb2x2ZWRDdXJyZW50SG9vayA9IGN1cnJlbnRIb29rOwogICAgICAgICAgdmFyIHByZXZWYWx1ZSA9IHJlc29sdmVkQ3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiB1cGRhdGVEZWZlcnJlZFZhbHVlSW1wbChob29rLCBwcmV2VmFsdWUsIHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVyZW5kZXJEZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgaWYgKGN1cnJlbnRIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHZhbHVlOwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcHJldlZhbHVlID0gY3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWVJbXBsKGhvb2ssIHByZXZWYWx1ZSwgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVEZWZlcnJlZFZhbHVlSW1wbChob29rLCBwcmV2VmFsdWUsIHZhbHVlKSB7CiAgICAgICAgICB2YXIgc2hvdWxkRGVmZXJWYWx1ZSA9ICFpbmNsdWRlc09ubHlOb25VcmdlbnRMYW5lcyhyZW5kZXJMYW5lcyk7CiAgICAgICAgICBpZiAoc2hvdWxkRGVmZXJWYWx1ZSkgewogICAgICAgICAgICBpZiAoIW9iamVjdElzKHZhbHVlLCBwcmV2VmFsdWUpKSB7CiAgICAgICAgICAgICAgdmFyIGRlZmVycmVkTGFuZSA9IGNsYWltTmV4dFRyYW5zaXRpb25MYW5lKCk7CiAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcyA9IG1lcmdlTGFuZXMoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcywgZGVmZXJyZWRMYW5lKTsKICAgICAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKGRlZmVycmVkTGFuZSk7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwcmV2VmFsdWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoaG9vay5iYXNlU3RhdGUpIHsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gdmFsdWU7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRUcmFuc2l0aW9uKHNldFBlbmRpbmcsIGNhbGxiYWNrLCBvcHRpb25zMikgewogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShoaWdoZXJFdmVudFByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHksIENvbnRpbnVvdXNFdmVudFByaW9yaXR5KSk7CiAgICAgICAgICBzZXRQZW5kaW5nKHRydWUpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uOwogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uID0ge307CiAgICAgICAgICB2YXIgY3VycmVudFRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb247CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZXRQZW5kaW5nKGZhbHNlKTsKICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAocHJldlRyYW5zaXRpb24gPT09IG51bGwgJiYgY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMpIHsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGVkRmliZXJzQ291bnQgPSBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5zaXplOwogICAgICAgICAgICAgICAgaWYgKHVwZGF0ZWRGaWJlcnNDb3VudCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgIHdhcm4zKCJEZXRlY3RlZCBhIGxhcmdlIG51bWJlciBvZiB1cGRhdGVzIGluc2lkZSBzdGFydFRyYW5zaXRpb24uIElmIHRoaXMgaXMgZHVlIHRvIGEgc3Vic2NyaXB0aW9uIHBsZWFzZSByZS13cml0ZSBpdCB0byB1c2UgUmVhY3QgcHJvdmlkZWQgaG9va3MuIE90aGVyd2lzZSBjb25jdXJyZW50IG1vZGUgZ3VhcmFudGVlcyBhcmUgb2ZmIHRoZSB0YWJsZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLmNsZWFyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50VHJhbnNpdGlvbigpIHsKICAgICAgICAgIHZhciBfbW91bnRTdGF0ZSA9IG1vdW50U3RhdGUoZmFsc2UpLCBpc1BlbmRpbmcgPSBfbW91bnRTdGF0ZVswXSwgc2V0UGVuZGluZyA9IF9tb3VudFN0YXRlWzFdOwogICAgICAgICAgdmFyIHN0YXJ0ID0gc3RhcnRUcmFuc2l0aW9uLmJpbmQobnVsbCwgc2V0UGVuZGluZyk7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBzdGFydDsKICAgICAgICAgIHJldHVybiBbaXNQZW5kaW5nLCBzdGFydF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX3VwZGF0ZVN0YXRlID0gdXBkYXRlU3RhdGUoKSwgaXNQZW5kaW5nID0gX3VwZGF0ZVN0YXRlWzBdOwogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBzdGFydCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBbaXNQZW5kaW5nLCBzdGFydF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyVHJhbnNpdGlvbigpIHsKICAgICAgICAgIHZhciBfcmVyZW5kZXJTdGF0ZSA9IHJlcmVuZGVyU3RhdGUoKSwgaXNQZW5kaW5nID0gX3JlcmVuZGVyU3RhdGVbMF07CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHN0YXJ0ID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgcmV0dXJuIFtpc1BlbmRpbmcsIHN0YXJ0XTsKICAgICAgICB9CiAgICAgICAgdmFyIGlzVXBkYXRpbmdPcGFxdWVWYWx1ZUluUmVuZGVyUGhhc2UgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBnZXRJc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlSW5ERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBpc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudElkKCkgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHJvb3QzID0gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCk7CiAgICAgICAgICB2YXIgaWRlbnRpZmllclByZWZpeCA9IHJvb3QzLmlkZW50aWZpZXJQcmVmaXg7CiAgICAgICAgICB2YXIgaWQ7CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICB2YXIgdHJlZUlkID0gZ2V0VHJlZUlkKCk7CiAgICAgICAgICAgIGlkID0gIjoiICsgaWRlbnRpZmllclByZWZpeCArICJSIiArIHRyZWVJZDsKICAgICAgICAgICAgdmFyIGxvY2FsSWQgPSBsb2NhbElkQ291bnRlcisrOwogICAgICAgICAgICBpZiAobG9jYWxJZCA+IDApIHsKICAgICAgICAgICAgICBpZCArPSAiSCIgKyBsb2NhbElkLnRvU3RyaW5nKDMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZCArPSAiOiI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZ2xvYmFsQ2xpZW50SWQgPSBnbG9iYWxDbGllbnRJZENvdW50ZXIrKzsKICAgICAgICAgICAgaWQgPSAiOiIgKyBpZGVudGlmaWVyUHJlZml4ICsgInIiICsgZ2xvYmFsQ2xpZW50SWQudG9TdHJpbmcoMzIpICsgIjoiOwogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gaWQ7CiAgICAgICAgICByZXR1cm4gaWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUlkKCkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBpZCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBpZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hSZWR1Y2VyQWN0aW9uKGZpYmVyLCBxdWV1ZSwgYWN0aW9uKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzNdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlN0YXRlIHVwZGF0ZXMgZnJvbSB0aGUgdXNlU3RhdGUoKSBhbmQgdXNlUmVkdWNlcigpIEhvb2tzIGRvbid0IHN1cHBvcnQgdGhlIHNlY29uZCBjYWxsYmFjayBhcmd1bWVudC4gVG8gZXhlY3V0ZSBhIHNpZGUgZWZmZWN0IGFmdGVyIHJlbmRlcmluZywgZGVjbGFyZSBpdCBpbiB0aGUgY29tcG9uZW50IGJvZHkgd2l0aCB1c2VFZmZlY3QoKS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICB2YXIgdXBkYXRlID0gewogICAgICAgICAgICBsYW5lLAogICAgICAgICAgICBhY3Rpb24sCiAgICAgICAgICAgIGhhc0VhZ2VyU3RhdGU6IGZhbHNlLAogICAgICAgICAgICBlYWdlclN0YXRlOiBudWxsLAogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKGlzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpKSB7CiAgICAgICAgICAgIGVucXVldWVSZW5kZXJQaGFzZVVwZGF0ZShxdWV1ZSwgdXBkYXRlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZShmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25VcGRhdGUocm9vdDMsIHF1ZXVlLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbWFya1VwZGF0ZUluRGV2VG9vbHMoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaFNldFN0YXRlKGZpYmVyLCBxdWV1ZSwgYWN0aW9uKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzNdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlN0YXRlIHVwZGF0ZXMgZnJvbSB0aGUgdXNlU3RhdGUoKSBhbmQgdXNlUmVkdWNlcigpIEhvb2tzIGRvbid0IHN1cHBvcnQgdGhlIHNlY29uZCBjYWxsYmFjayBhcmd1bWVudC4gVG8gZXhlY3V0ZSBhIHNpZGUgZWZmZWN0IGFmdGVyIHJlbmRlcmluZywgZGVjbGFyZSBpdCBpbiB0aGUgY29tcG9uZW50IGJvZHkgd2l0aCB1c2VFZmZlY3QoKS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICB2YXIgdXBkYXRlID0gewogICAgICAgICAgICBsYW5lLAogICAgICAgICAgICBhY3Rpb24sCiAgICAgICAgICAgIGhhc0VhZ2VyU3RhdGU6IGZhbHNlLAogICAgICAgICAgICBlYWdlclN0YXRlOiBudWxsLAogICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKGlzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpKSB7CiAgICAgICAgICAgIGVucXVldWVSZW5kZXJQaGFzZVVwZGF0ZShxdWV1ZSwgdXBkYXRlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChmaWJlci5sYW5lcyA9PT0gTm9MYW5lcyAmJiAoYWx0ZXJuYXRlID09PSBudWxsIHx8IGFsdGVybmF0ZS5sYW5lcyA9PT0gTm9MYW5lcykpIHsKICAgICAgICAgICAgICB2YXIgbGFzdFJlbmRlcmVkUmVkdWNlciA9IHF1ZXVlLmxhc3RSZW5kZXJlZFJlZHVjZXI7CiAgICAgICAgICAgICAgaWYgKGxhc3RSZW5kZXJlZFJlZHVjZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U3RhdGUgPSBxdWV1ZS5sYXN0UmVuZGVyZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgdmFyIGVhZ2VyU3RhdGUgPSBsYXN0UmVuZGVyZWRSZWR1Y2VyKGN1cnJlbnRTdGF0ZSwgYWN0aW9uKTsKICAgICAgICAgICAgICAgICAgdXBkYXRlLmhhc0VhZ2VyU3RhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICB1cGRhdGUuZWFnZXJTdGF0ZSA9IGVhZ2VyU3RhdGU7CiAgICAgICAgICAgICAgICAgIGlmIChvYmplY3RJcyhlYWdlclN0YXRlLCBjdXJyZW50U3RhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlQW5kRWFnZXJseUJhaWxvdXQoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNSZW5kZXJQaGFzZVVwZGF0ZShmaWJlcikgewogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIHJldHVybiBmaWJlciA9PT0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSB8fCBhbHRlcm5hdGUgIT09IG51bGwgJiYgYWx0ZXJuYXRlID09PSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSkgewogICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICB2YXIgcGVuZGluZyA9IHF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICBpZiAocGVuZGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gcGVuZGluZy5uZXh0OwogICAgICAgICAgICBwZW5kaW5nLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gdXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnRhbmdsZVRyYW5zaXRpb25VcGRhdGUocm9vdDMsIHF1ZXVlLCBsYW5lKSB7CiAgICAgICAgICBpZiAoaXNUcmFuc2l0aW9uTGFuZShsYW5lKSkgewogICAgICAgICAgICB2YXIgcXVldWVMYW5lcyA9IHF1ZXVlLmxhbmVzOwogICAgICAgICAgICBxdWV1ZUxhbmVzID0gaW50ZXJzZWN0TGFuZXMocXVldWVMYW5lcywgcm9vdDMucGVuZGluZ0xhbmVzKTsKICAgICAgICAgICAgdmFyIG5ld1F1ZXVlTGFuZXMgPSBtZXJnZUxhbmVzKHF1ZXVlTGFuZXMsIGxhbmUpOwogICAgICAgICAgICBxdWV1ZS5sYW5lcyA9IG5ld1F1ZXVlTGFuZXM7CiAgICAgICAgICAgIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBuZXdRdWV1ZUxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1VwZGF0ZUluRGV2VG9vbHMoZmliZXIsIGxhbmUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgQ29udGV4dE9ubHlEaXNwYXRjaGVyID0gewogICAgICAgICAgcmVhZENvbnRleHQsCiAgICAgICAgICB1c2VDYWxsYmFjazogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlQ29udGV4dDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlRWZmZWN0OiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlTWVtbzogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlUmVkdWNlcjogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlUmVmOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VTdGF0ZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlRGVidWdWYWx1ZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlVHJhbnNpdGlvbjogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUlkOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICB9OwogICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVYgPSBudWxsOwogICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPbk1vdW50V2l0aEhvb2tUeXBlc0luREVWID0gbnVsbDsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSBudWxsOwogICAgICAgIHsKICAgICAgICAgIHZhciB3YXJuSW52YWxpZENvbnRleHRBY2Nlc3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXJyb3IoIkNvbnRleHQgY2FuIG9ubHkgYmUgcmVhZCB3aGlsZSBSZWFjdCBpcyByZW5kZXJpbmcuIEluIGNsYXNzZXMsIHlvdSBjYW4gcmVhZCBpdCBpbiB0aGUgcmVuZGVyIG1ldGhvZCBvciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMuIEluIGZ1bmN0aW9uIGNvbXBvbmVudHMsIHlvdSBjYW4gcmVhZCBpdCBkaXJlY3RseSBpbiB0aGUgZnVuY3Rpb24gYm9keSwgYnV0IG5vdCBpbnNpZGUgSG9va3MgbGlrZSB1c2VSZWR1Y2VyKCkgb3IgdXNlTWVtbygpLiIpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuSW52YWxpZEhvb2tBY2Nlc3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZXJyb3IoIkRvIG5vdCBjYWxsIEhvb2tzIGluc2lkZSB1c2VFZmZlY3QoLi4uKSwgdXNlTWVtbyguLi4pLCBvciBvdGhlciBidWlsdC1pbiBIb29rcy4gWW91IGNhbiBvbmx5IGNhbGwgSG9va3MgYXQgdGhlIHRvcCBsZXZlbCBvZiB5b3VyIFJlYWN0IGZ1bmN0aW9uLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9ydWxlcy1vZi1ob29rcyIpOwogICAgICAgICAgfTsKICAgICAgICAgIEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudENhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudElkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEhvb2tzRGlzcGF0Y2hlck9uTW91bnRXaXRoSG9va1R5cGVzSW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50Q2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudE1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50VHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICB3YXJuSW52YWxpZENvbnRleHRBY2Nlc3MoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudENhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudElkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHdhcm5JbnZhbGlkQ29udGV4dEFjY2VzcygpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUluc2VydGlvbkVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWYoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgICAgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICB3YXJuSW52YWxpZENvbnRleHRBY2Nlc3MoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVSZWYoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3RhdGU6IGZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3RhdGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU11dGFibGVTb3VyY2UoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlU3luY0V4dGVybmFsU3RvcmU6IGZ1bmN0aW9uKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlU3luY0V4dGVybmFsU3RvcmUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUlkIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSWQoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgbm93JDEgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgIHZhciBjb21taXRUaW1lID0gMDsKICAgICAgICB2YXIgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgdmFyIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgdmFyIHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICB2YXIgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gZmFsc2U7CiAgICAgICAgdmFyIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGlzQ3VycmVudFVwZGF0ZU5lc3RlZCgpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50VXBkYXRlSXNOZXN0ZWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtOZXN0ZWRVcGRhdGVTY2hlZHVsZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0TmVzdGVkVXBkYXRlRmxhZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gZmFsc2U7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZVNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzeW5jTmVzdGVkVXBkYXRlRmxhZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZUlzTmVzdGVkID0gbmVzdGVkVXBkYXRlU2NoZWR1bGVkOwogICAgICAgICAgICBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tbWl0VGltZSgpIHsKICAgICAgICAgIHJldHVybiBjb21taXRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvcmRDb21taXRUaW1lKCkgewogICAgICAgICAgY29tbWl0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0UHJvZmlsZXJUaW1lcihmaWJlcikgewogICAgICAgICAgcHJvZmlsZXJTdGFydFRpbWUgPSBub3ckMSgpOwogICAgICAgICAgaWYgKGZpYmVyLmFjdHVhbFN0YXJ0VGltZSA8IDApIHsKICAgICAgICAgICAgZmliZXIuYWN0dWFsU3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoZmliZXIpIHsKICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoZmliZXIsIG92ZXJyaWRlQmFzZVRpbWUpIHsKICAgICAgICAgIGlmIChwcm9maWxlclN0YXJ0VGltZSA+PSAwKSB7CiAgICAgICAgICAgIHZhciBlbGFwc2VkVGltZSA9IG5vdyQxKCkgLSBwcm9maWxlclN0YXJ0VGltZTsKICAgICAgICAgICAgZmliZXIuYWN0dWFsRHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgIGlmIChvdmVycmlkZUJhc2VUaW1lKSB7CiAgICAgICAgICAgICAgZmliZXIuc2VsZkJhc2VEdXJhdGlvbiA9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICBpZiAobGF5b3V0RWZmZWN0U3RhcnRUaW1lID49IDApIHsKICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gbm93JDEoKSAtIGxheW91dEVmZmVjdFN0YXJ0VGltZTsKICAgICAgICAgICAgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgd2hpbGUgKHBhcmVudEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgcm9vdDMuZWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbiArPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oZmliZXIpIHsKICAgICAgICAgIGlmIChwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID49IDApIHsKICAgICAgICAgICAgdmFyIGVsYXBzZWRUaW1lID0gbm93JDEoKSAtIHBhc3NpdmVFZmZlY3RTdGFydFRpbWU7CiAgICAgICAgICAgIHBhc3NpdmVFZmZlY3RTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByb290My5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFN0YXRlTm9kZSA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudFN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydExheW91dEVmZmVjdFRpbWVyKCkgewogICAgICAgICAgbGF5b3V0RWZmZWN0U3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKSB7CiAgICAgICAgICBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhbnNmZXJBY3R1YWxEdXJhdGlvbihmaWJlcikgewogICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQpIHsKICAgICAgICAgICAgZmliZXIuYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZURlZmF1bHRQcm9wczIoQ29tcG9uZW50LCBiYXNlUHJvcHMpIHsKICAgICAgICAgIGlmIChDb21wb25lbnQgJiYgQ29tcG9uZW50LmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICB2YXIgcHJvcHMgPSBhc3NpZ24yKHt9LCBiYXNlUHJvcHMpOwogICAgICAgICAgICB2YXIgZGVmYXVsdFByb3BzID0gQ29tcG9uZW50LmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgZm9yICh2YXIgcHJvcE5hbWUgaW4gZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBkZWZhdWx0UHJvcHNbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHJvcHM7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYmFzZVByb3BzOwogICAgICAgIH0KICAgICAgICB2YXIgZmFrZUludGVybmFsSW5zdGFuY2UgPSB7fTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbmluaXRpYWxpemVkU3RhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdldFNuYXBzaG90QmVmb3JlVXBkYXRlV2l0aG91dERpZFVwZGF0ZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0TGVnYWN5TGlmZWN5Y2xlc0FuZERlcml2ZWRTdGF0ZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlOwogICAgICAgIHZhciB3YXJuT25VbmRlZmluZWREZXJpdmVkU3RhdGU7CiAgICAgICAgdmFyIHdhcm5PbkludmFsaWRDYWxsYmFjazsKICAgICAgICB2YXIgZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dENvbnRleHRUeXBlQW5kQ29udGV4dFR5cGVzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRJbnZhbGlkYXRlQ29udGV4dFR5cGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRTdGF0ZUFzc2lnbm1lbnRGb3JDb21wb25lbnQgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dEdldFNuYXBzaG90QmVmb3JlVXBkYXRlV2l0aG91dERpZFVwZGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lMaWZlY3ljbGVzQW5kRGVyaXZlZFN0YXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dFVuZGVmaW5lZERlcml2ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRJbnZhbGlkYXRlQ29udGV4dFR5cGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCQxID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIHZhciBkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2sgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrID0gZnVuY3Rpb24oY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrID09PSBudWxsIHx8IHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIga2V5ID0gY2FsbGVyTmFtZSArICJfIiArIGNhbGxiYWNrOwogICAgICAgICAgICBpZiAoIWRpZFdhcm5PbkludmFsaWRDYWxsYmFjay5oYXMoa2V5KSkgewogICAgICAgICAgICAgIGRpZFdhcm5PbkludmFsaWRDYWxsYmFjay5hZGQoa2V5KTsKICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogRXhwZWN0ZWQgdGhlIGxhc3Qgb3B0aW9uYWwgYGNhbGxiYWNrYCBhcmd1bWVudCB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjYWxsZXJOYW1lLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB3YXJuT25VbmRlZmluZWREZXJpdmVkU3RhdGUgPSBmdW5jdGlvbih0eXBlLCBwYXJ0aWFsU3RhdGUpIHsKICAgICAgICAgICAgaWYgKHBhcnRpYWxTdGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVbmRlZmluZWREZXJpdmVkU3RhdGUuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbmRlZmluZWREZXJpdmVkU3RhdGUuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcygpOiBBIHZhbGlkIHN0YXRlIG9iamVjdCAob3IgbnVsbCkgbXVzdCBiZSByZXR1cm5lZC4gWW91IGhhdmUgcmV0dXJuZWQgdW5kZWZpbmVkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShmYWtlSW50ZXJuYWxJbnN0YW5jZSwgIl9wcm9jZXNzQ2hpbGRDb250ZXh0IiwgewogICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiX3Byb2Nlc3NDaGlsZENvbnRleHQgaXMgbm90IGF2YWlsYWJsZSBpbiBSZWFjdCAxNisuIFRoaXMgbGlrZWx5IG1lYW5zIHlvdSBoYXZlIG11bHRpcGxlIGNvcGllcyBvZiBSZWFjdCBhbmQgYXJlIGF0dGVtcHRpbmcgdG8gbmVzdCBhIFJlYWN0IDE1IHRyZWUgaW5zaWRlIGEgUmVhY3QgMTYgdHJlZSB1c2luZyB1bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lciwgd2hpY2ggaXNuJ3Qgc3VwcG9ydGVkLiBUcnkgdG8gbWFrZSBzdXJlIHlvdSBoYXZlIG9ubHkgb25lIGNvcHkgb2YgUmVhY3QgKGFuZCBpZGVhbGx5LCBzd2l0Y2ggdG8gUmVhY3RET00uY3JlYXRlUG9ydGFsKS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICBPYmplY3QuZnJlZXplKGZha2VJbnRlcm5hbEluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXBwbHlEZXJpdmVkU3RhdGVGcm9tUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMsIG5leHRQcm9wcykgewogICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHBhcnRpYWxTdGF0ZSA9IGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyhuZXh0UHJvcHMsIHByZXZTdGF0ZSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcGFydGlhbFN0YXRlID0gZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKG5leHRQcm9wcywgcHJldlN0YXRlKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuT25VbmRlZmluZWREZXJpdmVkU3RhdGUoY3RvciwgcGFydGlhbFN0YXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtZW1vaXplZFN0YXRlID0gcGFydGlhbFN0YXRlID09PSBudWxsIHx8IHBhcnRpYWxTdGF0ZSA9PT0gdm9pZCAwID8gcHJldlN0YXRlIDogYXNzaWduMih7fSwgcHJldlN0YXRlLCBwYXJ0aWFsU3RhdGUpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBtZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5sYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmJhc2VTdGF0ZSA9IG1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjbGFzc0NvbXBvbmVudFVwZGF0ZXIgPSB7CiAgICAgICAgICBpc01vdW50ZWQsCiAgICAgICAgICBlbnF1ZXVlU2V0U3RhdGU6IGZ1bmN0aW9uKGluc3QsIHBheWxvYWQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGdldDUoaW5zdCk7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICAgIHVwZGF0ZS5wYXlsb2FkID0gcGF5bG9hZDsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2soY2FsbGJhY2ssICJzZXRTdGF0ZSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwKICAgICAgICAgIGVucXVldWVSZXBsYWNlU3RhdGU6IGZ1bmN0aW9uKGluc3QsIHBheWxvYWQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGdldDUoaW5zdCk7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBSZXBsYWNlU3RhdGU7CiAgICAgICAgICAgIHVwZGF0ZS5wYXlsb2FkID0gcGF5bG9hZDsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2soY2FsbGJhY2ssICJyZXBsYWNlU3RhdGUiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBlbnF1ZXVlRm9yY2VVcGRhdGU6IGZ1bmN0aW9uKGluc3QsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IGdldDUoaW5zdCk7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBGb3JjZVVwZGF0ZTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrICE9PSB2b2lkIDAgJiYgY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2soY2FsbGJhY2ssICJmb3JjZVVwZGF0ZSIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0ZvcmNlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY2hlY2tTaG91bGRDb21wb25lbnRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBvbGRQcm9wcywgbmV3UHJvcHMsIG9sZFN0YXRlLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gaW5zdGFuY2Uuc2hvdWxkQ29tcG9uZW50VXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzaG91bGRVcGRhdGUgPSBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzLnNob3VsZENvbXBvbmVudFVwZGF0ZSgpOiBSZXR1cm5lZCB1bmRlZmluZWQgaW5zdGVhZCBvZiBhIGJvb2xlYW4gdmFsdWUuIE1ha2Ugc3VyZSB0byByZXR1cm4gdHJ1ZSBvciBmYWxzZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIGN0b3IucHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50KSB7CiAgICAgICAgICAgIHJldHVybiAhc2hhbGxvd0VxdWFsMihvbGRQcm9wcywgbmV3UHJvcHMpIHx8ICFzaGFsbG93RXF1YWwyKG9sZFN0YXRlLCBuZXdTdGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICB2YXIgcmVuZGVyUHJlc2VudCA9IGluc3RhbmNlLnJlbmRlcjsKICAgICAgICAgICAgaWYgKCFyZW5kZXJQcmVzZW50KSB7CiAgICAgICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIHR5cGVvZiBjdG9yLnByb3RvdHlwZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBObyBgcmVuZGVyYCBtZXRob2QgZm91bmQgb24gdGhlIHJldHVybmVkIGNvbXBvbmVudCBpbnN0YW5jZTogZGlkIHlvdSBhY2NpZGVudGFsbHkgcmV0dXJuIGFuIG9iamVjdCBmcm9tIHRoZSBjb25zdHJ1Y3Rvcj8iLCBuYW1lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IE5vIGByZW5kZXJgIG1ldGhvZCBmb3VuZCBvbiB0aGUgcmV0dXJuZWQgY29tcG9uZW50IGluc3RhbmNlOiB5b3UgbWF5IGhhdmUgZm9yZ290dGVuIHRvIGRlZmluZSBgcmVuZGVyYC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmdldEluaXRpYWxTdGF0ZSAmJiAhaW5zdGFuY2UuZ2V0SW5pdGlhbFN0YXRlLmlzUmVhY3RDbGFzc0FwcHJvdmVkICYmICFpbnN0YW5jZS5zdGF0ZSkgewogICAgICAgICAgICAgIGVycm9yKCJnZXRJbml0aWFsU3RhdGUgd2FzIGRlZmluZWQgb24gJXMsIGEgcGxhaW4gSmF2YVNjcmlwdCBjbGFzcy4gVGhpcyBpcyBvbmx5IHN1cHBvcnRlZCBmb3IgY2xhc3NlcyBjcmVhdGVkIHVzaW5nIFJlYWN0LmNyZWF0ZUNsYXNzLiBEaWQgeW91IG1lYW4gdG8gZGVmaW5lIGEgc3RhdGUgcHJvcGVydHkgaW5zdGVhZD8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UuZ2V0RGVmYXVsdFByb3BzICYmICFpbnN0YW5jZS5nZXREZWZhdWx0UHJvcHMuaXNSZWFjdENsYXNzQXBwcm92ZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiZ2V0RGVmYXVsdFByb3BzIHdhcyBkZWZpbmVkIG9uICVzLCBhIHBsYWluIEphdmFTY3JpcHQgY2xhc3MuIFRoaXMgaXMgb25seSBzdXBwb3J0ZWQgZm9yIGNsYXNzZXMgY3JlYXRlZCB1c2luZyBSZWFjdC5jcmVhdGVDbGFzcy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IHRvIGRlZmluZSBkZWZhdWx0UHJvcHMgaW5zdGVhZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgZXJyb3IoInByb3BUeXBlcyB3YXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IHRvIGRlZmluZSBwcm9wVHlwZXMgaW5zdGVhZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UuY29udGV4dFR5cGUpIHsKICAgICAgICAgICAgICBlcnJvcigiY29udGV4dFR5cGUgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgY29udGV4dFR5cGUgaW5zdGVhZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGN0b3IuY2hpbGRDb250ZXh0VHlwZXMgJiYgIWRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5oYXMoY3RvcikgJiYgLy8gU3RyaWN0IE1vZGUgaGFzIGl0cyBvd24gd2FybmluZyBmb3IgbGVnYWN5IGNvbnRleHQsIHNvIHdlIGNhbiBza2lwCiAgICAgICAgICAgICAgLy8gdGhpcyBvbmUuCiAgICAgICAgICAgICAgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCQxLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyB1c2VzIHRoZSBsZWdhY3kgY2hpbGRDb250ZXh0VHlwZXMgQVBJIHdoaWNoIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciByZWxlYXNlLiBVc2UgUmVhY3QuY3JlYXRlQ29udGV4dCgpIGluc3RlYWRcblxuLkxlYXJuIG1vcmUgYWJvdXQgdGhpcyB3YXJuaW5nIGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9sZWdhY3ktY29udGV4dCIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoY3Rvci5jb250ZXh0VHlwZXMgJiYgIWRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5oYXMoY3RvcikgJiYgLy8gU3RyaWN0IE1vZGUgaGFzIGl0cyBvd24gd2FybmluZyBmb3IgbGVnYWN5IGNvbnRleHQsIHNvIHdlIGNhbiBza2lwCiAgICAgICAgICAgICAgLy8gdGhpcyBvbmUuCiAgICAgICAgICAgICAgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCQxLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyB1c2VzIHRoZSBsZWdhY3kgY29udGV4dFR5cGVzIEFQSSB3aGljaCBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gVXNlIFJlYWN0LmNyZWF0ZUNvbnRleHQoKSB3aXRoIHN0YXRpYyBjb250ZXh0VHlwZSBpbnN0ZWFkLlxuXG5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLmNvbnRleHRUeXBlcykgewogICAgICAgICAgICAgICAgZXJyb3IoImNvbnRleHRUeXBlcyB3YXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IHRvIGRlZmluZSBjb250ZXh0VHlwZXMgaW5zdGVhZC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGN0b3IuY29udGV4dFR5cGUgJiYgY3Rvci5jb250ZXh0VHlwZXMgJiYgIWRpZFdhcm5BYm91dENvbnRleHRUeXBlQW5kQ29udGV4dFR5cGVzLmhhcyhjdG9yKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVBbmRDb250ZXh0VHlwZXMuYWRkKGN0b3IpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGRlY2xhcmVzIGJvdGggY29udGV4dFR5cGVzIGFuZCBjb250ZXh0VHlwZSBzdGF0aWMgcHJvcGVydGllcy4gVGhlIGxlZ2FjeSBjb250ZXh0VHlwZXMgcHJvcGVydHkgd2lsbCBiZSBpZ25vcmVkLiIsIG5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFNob3VsZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIGNvbXBvbmVudFNob3VsZFVwZGF0ZSgpLiBEaWQgeW91IG1lYW4gc2hvdWxkQ29tcG9uZW50VXBkYXRlKCk/IFRoZSBuYW1lIGlzIHBocmFzZWQgYXMgYSBxdWVzdGlvbiBiZWNhdXNlIHRoZSBmdW5jdGlvbiBpcyBleHBlY3RlZCB0byByZXR1cm4gYSB2YWx1ZS4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY3Rvci5wcm90b3R5cGUgJiYgY3Rvci5wcm90b3R5cGUuaXNQdXJlUmVhY3RDb21wb25lbnQgJiYgdHlwZW9mIGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBzaG91bGRDb21wb25lbnRVcGRhdGUoKS4gc2hvdWxkQ29tcG9uZW50VXBkYXRlIHNob3VsZCBub3QgYmUgdXNlZCB3aGVuIGV4dGVuZGluZyBSZWFjdC5QdXJlQ29tcG9uZW50LiBQbGVhc2UgZXh0ZW5kIFJlYWN0LkNvbXBvbmVudCBpZiBzaG91bGRDb21wb25lbnRVcGRhdGUgaXMgdXNlZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkEgcHVyZSBjb21wb25lbnQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBjb21wb25lbnREaWRVbm1vdW50KCkuIEJ1dCB0aGVyZSBpcyBubyBzdWNoIGxpZmVjeWNsZSBtZXRob2QuIERpZCB5b3UgbWVhbiBjb21wb25lbnRXaWxsVW5tb3VudCgpPyIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50RGlkUmVjZWl2ZVByb3BzKCkuIEJ1dCB0aGVyZSBpcyBubyBzdWNoIGxpZmVjeWNsZSBtZXRob2QuIElmIHlvdSBtZWFudCB0byB1cGRhdGUgdGhlIHN0YXRlIGluIHJlc3BvbnNlIHRvIGNoYW5naW5nIHByb3BzLCB1c2UgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpLiBJZiB5b3UgbWVhbnQgdG8gZmV0Y2ggZGF0YSBvciBydW4gc2lkZS1lZmZlY3RzIG9yIG11dGF0aW9ucyBhZnRlciBSZWFjdCBoYXMgdXBkYXRlZCB0aGUgVUksIHVzZSBjb21wb25lbnREaWRVcGRhdGUoKS4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBjb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzKCkuIERpZCB5b3UgbWVhbiBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKCk/IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzKCkuIERpZCB5b3UgbWVhbiBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpPyIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYXNNdXRhdGVkUHJvcHMgPSBpbnN0YW5jZS5wcm9wcyAhPT0gbmV3UHJvcHM7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wcyAhPT0gdm9pZCAwICYmIGhhc011dGF0ZWRQcm9wcykgewogICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBXaGVuIGNhbGxpbmcgc3VwZXIoKSBpbiBgJXNgLCBtYWtlIHN1cmUgdG8gcGFzcyB1cCB0aGUgc2FtZSBwcm9wcyB0aGF0IHlvdXIgY29tcG9uZW50J3MgY29uc3RydWN0b3Igd2FzIHBhc3NlZC4iLCBuYW1lLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdGFuY2UuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlNldHRpbmcgZGVmYXVsdFByb3BzIGFzIGFuIGluc3RhbmNlIHByb3BlcnR5IG9uICVzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgaWdub3JlZC4gSW5zdGVhZCwgZGVmaW5lIGRlZmF1bHRQcm9wcyBhcyBhIHN0YXRpYyBwcm9wZXJ0eSBvbiAlcy4iLCBuYW1lLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUgIT09ICJmdW5jdGlvbiIgJiYgIWRpZFdhcm5BYm91dEdldFNuYXBzaG90QmVmb3JlVXBkYXRlV2l0aG91dERpZFVwZGF0ZS5oYXMoY3RvcikpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUuYWRkKGN0b3IpOwogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSBzaG91bGQgYmUgdXNlZCB3aXRoIGNvbXBvbmVudERpZFVwZGF0ZSgpLiBUaGlzIGNvbXBvbmVudCBkZWZpbmVzIGdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCkgb25seS4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzOiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKSBpcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIG1ldGhvZCBhbmQgd2lsbCBiZSBpZ25vcmVkLiBJbnN0ZWFkLCBkZWNsYXJlIGl0IGFzIGEgc3RhdGljIG1ldGhvZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yKCkgaXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBtZXRob2QgYW5kIHdpbGwgYmUgaWdub3JlZC4gSW5zdGVhZCwgZGVjbGFyZSBpdCBhcyBhIHN0YXRpYyBtZXRob2QuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzOiBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIGlzIGRlZmluZWQgYXMgYSBzdGF0aWMgbWV0aG9kIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlY2xhcmUgaXQgYXMgYW4gaW5zdGFuY2UgbWV0aG9kLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBfc3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgICAgaWYgKF9zdGF0ZSAmJiAodHlwZW9mIF9zdGF0ZSAhPT0gIm9iamVjdCIgfHwgaXNBcnJheTIoX3N0YXRlKSkpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMuc3RhdGU6IG11c3QgYmUgc2V0IHRvIGFuIG9iamVjdCBvciBudWxsIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRDaGlsZENvbnRleHQgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGN0b3IuY2hpbGRDb250ZXh0VHlwZXMgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzLmdldENoaWxkQ29udGV4dCgpOiBjaGlsZENvbnRleHRUeXBlcyBtdXN0IGJlIGRlZmluZWQgaW4gb3JkZXIgdG8gdXNlIGdldENoaWxkQ29udGV4dCgpLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkb3B0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKSB7CiAgICAgICAgICBpbnN0YW5jZS51cGRhdGVyID0gY2xhc3NDb21wb25lbnRVcGRhdGVyOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgc2V0MyhpbnN0YW5jZSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaW5zdGFuY2UuX3JlYWN0SW50ZXJuYWxJbnN0YW5jZSA9IGZha2VJbnRlcm5hbEluc3RhbmNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb25zdHJ1Y3RDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgcHJvcHMpIHsKICAgICAgICAgIHZhciBpc0xlZ2FjeUNvbnRleHRDb25zdW1lciA9IGZhbHNlOwogICAgICAgICAgdmFyIHVubWFza2VkQ29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIHZhciBjb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgdmFyIGNvbnRleHRUeXBlID0gY3Rvci5jb250ZXh0VHlwZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCJjb250ZXh0VHlwZSIgaW4gY3RvcikgewogICAgICAgICAgICAgIHZhciBpc1ZhbGlkID0gKAogICAgICAgICAgICAgICAgLy8gQWxsb3cgbnVsbCBmb3IgY29uZGl0aW9uYWwgZGVjbGFyYXRpb24KICAgICAgICAgICAgICAgIGNvbnRleHRUeXBlID09PSBudWxsIHx8IGNvbnRleHRUeXBlICE9PSB2b2lkIDAgJiYgY29udGV4dFR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0NPTlRFWFRfVFlQRSAmJiBjb250ZXh0VHlwZS5fY29udGV4dCA9PT0gdm9pZCAwCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICBpZiAoIWlzVmFsaWQgJiYgIWRpZFdhcm5BYm91dEludmFsaWRhdGVDb250ZXh0VHlwZS5oYXMoY3RvcikpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEludmFsaWRhdGVDb250ZXh0VHlwZS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICB2YXIgYWRkZW5kdW0gPSAiIjsKICAgICAgICAgICAgICAgIGlmIChjb250ZXh0VHlwZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBIb3dldmVyLCBpdCBpcyBzZXQgdG8gdW5kZWZpbmVkLiBUaGlzIGNhbiBiZSBjYXVzZWQgYnkgYSB0eXBvIG9yIGJ5IG1peGluZyB1cCBuYW1lZCBhbmQgZGVmYXVsdCBpbXBvcnRzLiBUaGlzIGNhbiBhbHNvIGhhcHBlbiBkdWUgdG8gYSBjaXJjdWxhciBkZXBlbmRlbmN5LCBzbyB0cnkgbW92aW5nIHRoZSBjcmVhdGVDb250ZXh0KCkgY2FsbCB0byBhIHNlcGFyYXRlIGZpbGUuIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGNvbnRleHRUeXBlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgSG93ZXZlciwgaXQgaXMgc2V0IHRvIGEgIiArIHR5cGVvZiBjb250ZXh0VHlwZSArICIuIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29udGV4dFR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX1BST1ZJREVSX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIERpZCB5b3UgYWNjaWRlbnRhbGx5IHBhc3MgdGhlIENvbnRleHQuUHJvdmlkZXIgaW5zdGVhZD8iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb250ZXh0VHlwZS5fY29udGV4dCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBEaWQgeW91IGFjY2lkZW50YWxseSBwYXNzIHRoZSBDb250ZXh0LkNvbnN1bWVyIGluc3RlYWQ/IjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBIb3dldmVyLCBpdCBpcyBzZXQgdG8gYW4gb2JqZWN0IHdpdGgga2V5cyB7IiArIE9iamVjdC5rZXlzKGNvbnRleHRUeXBlKS5qb2luKCIsICIpICsgIn0uIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVycm9yKCIlcyBkZWZpbmVzIGFuIGludmFsaWQgY29udGV4dFR5cGUuIGNvbnRleHRUeXBlIHNob3VsZCBwb2ludCB0byB0aGUgQ29udGV4dCBvYmplY3QgcmV0dXJuZWQgYnkgUmVhY3QuY3JlYXRlQ29udGV4dCgpLiVzIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiLCBhZGRlbmR1bSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBjb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIHZhciBjb250ZXh0VHlwZXMgPSBjdG9yLmNvbnRleHRUeXBlczsKICAgICAgICAgICAgaXNMZWdhY3lDb250ZXh0Q29uc3VtZXIgPSBjb250ZXh0VHlwZXMgIT09IG51bGwgJiYgY29udGV4dFR5cGVzICE9PSB2b2lkIDA7CiAgICAgICAgICAgIGNvbnRleHQgPSBpc0xlZ2FjeUNvbnRleHRDb25zdW1lciA/IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQpIDogZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluc3RhbmNlID0gbmV3IGN0b3IocHJvcHMsIGNvbnRleHQpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGluc3RhbmNlID0gbmV3IGN0b3IocHJvcHMsIGNvbnRleHQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IGluc3RhbmNlLnN0YXRlICE9PSBudWxsICYmIGluc3RhbmNlLnN0YXRlICE9PSB2b2lkIDAgPyBpbnN0YW5jZS5zdGF0ZSA6IG51bGw7CiAgICAgICAgICBhZG9wdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgc3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVuaW5pdGlhbGl6ZWRTdGF0ZS5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuaW5pdGlhbGl6ZWRTdGF0ZS5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBlcnJvcigiYCVzYCB1c2VzIGBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHNgIGJ1dCBpdHMgaW5pdGlhbCBzdGF0ZSBpcyAlcy4gVGhpcyBpcyBub3QgcmVjb21tZW5kZWQuIEluc3RlYWQsIGRlZmluZSB0aGUgaW5pdGlhbCBzdGF0ZSBieSBhc3NpZ25pbmcgYW4gb2JqZWN0IHRvIGB0aGlzLnN0YXRlYCBpbiB0aGUgY29uc3RydWN0b3Igb2YgYCVzYC4gVGhpcyBlbnN1cmVzIHRoYXQgYGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wc2AgYXJndW1lbnRzIGhhdmUgYSBjb25zaXN0ZW50IHNoYXBlLiIsIGNvbXBvbmVudE5hbWUsIGluc3RhbmNlLnN0YXRlID09PSBudWxsID8gIm51bGwiIDogInVuZGVmaW5lZCIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBmb3VuZFdpbGxNb3VudE5hbWUgPSBudWxsOwogICAgICAgICAgICAgIHZhciBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgZm91bmRXaWxsVXBkYXRlTmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50Ll9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIGZvdW5kV2lsbE1vdW50TmFtZSA9ICJjb21wb25lbnRXaWxsTW91bnQiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGZvdW5kV2lsbE1vdW50TmFtZSA9ICJVTlNBRkVfY29tcG9uZW50V2lsbE1vdW50IjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSA9ICJjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSA9ICJVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlLl9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIGZvdW5kV2lsbFVwZGF0ZU5hbWUgPSAiY29tcG9uZW50V2lsbFVwZGF0ZSI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGZvdW5kV2lsbFVwZGF0ZU5hbWUgPSAiVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZm91bmRXaWxsTW91bnROYW1lICE9PSBudWxsIHx8IGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgIT09IG51bGwgfHwgZm91bmRXaWxsVXBkYXRlTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIF9jb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgICAgdmFyIG5ld0FwaU5hbWUgPSB0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgPyAiZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKCkiIDogImdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCkiOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRMZWdhY3lMaWZlY3ljbGVzQW5kRGVyaXZlZFN0YXRlLmhhcyhfY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5TGlmZWN5Y2xlc0FuZERlcml2ZWRTdGF0ZS5hZGQoX2NvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBlcnJvcigiVW5zYWZlIGxlZ2FjeSBsaWZlY3ljbGVzIHdpbGwgbm90IGJlIGNhbGxlZCBmb3IgY29tcG9uZW50cyB1c2luZyBuZXcgY29tcG9uZW50IEFQSXMuXG5cbiVzIHVzZXMgJXMgYnV0IGFsc28gY29udGFpbnMgdGhlIGZvbGxvd2luZyBsZWdhY3kgbGlmZWN5Y2xlczolcyVzJXNcblxuVGhlIGFib3ZlIGxpZmVjeWNsZXMgc2hvdWxkIGJlIHJlbW92ZWQuIExlYXJuIG1vcmUgYWJvdXQgdGhpcyB3YXJuaW5nIGhlcmU6XG5odHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIiwgX2NvbXBvbmVudE5hbWUsIG5ld0FwaU5hbWUsIGZvdW5kV2lsbE1vdW50TmFtZSAhPT0gbnVsbCA/ICJcbiAgIiArIGZvdW5kV2lsbE1vdW50TmFtZSA6ICIiLCBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lICE9PSBudWxsID8gIlxuICAiICsgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSA6ICIiLCBmb3VuZFdpbGxVcGRhdGVOYW1lICE9PSBudWxsID8gIlxuICAiICsgZm91bmRXaWxsVXBkYXRlTmFtZSA6ICIiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0xlZ2FjeUNvbnRleHRDb25zdW1lcikgewogICAgICAgICAgICBjYWNoZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQsIGNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYWxsQ29tcG9uZW50V2lsbE1vdW50KHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpIHsKICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IGluc3RhbmNlLnN0YXRlOwogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG9sZFN0YXRlICE9PSBpbnN0YW5jZS5zdGF0ZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzLmNvbXBvbmVudFdpbGxNb3VudCgpOiBBc3NpZ25pbmcgZGlyZWN0bHkgdG8gdGhpcy5zdGF0ZSBpcyBkZXByZWNhdGVkIChleGNlcHQgaW5zaWRlIGEgY29tcG9uZW50J3MgY29uc3RydWN0b3IpLiBVc2Ugc2V0U3RhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzMikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNsYXNzQ29tcG9uZW50VXBkYXRlci5lbnF1ZXVlUmVwbGFjZVN0YXRlKGluc3RhbmNlLCBpbnN0YW5jZS5zdGF0ZSwgbnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbGxDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UsIG5ld1Byb3BzLCBuZXh0Q29udGV4dCkgewogICAgICAgICAgdmFyIG9sZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBvbGRTdGF0ZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzMikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRTdGF0ZUFzc2lnbm1lbnRGb3JDb21wb25lbnQuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRTdGF0ZUFzc2lnbm1lbnRGb3JDb21wb25lbnQuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKTogQXNzaWduaW5nIGRpcmVjdGx5IHRvIHRoaXMuc3RhdGUgaXMgZGVwcmVjYXRlZCAoZXhjZXB0IGluc2lkZSBhIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yKS4gVXNlIHNldFN0YXRlIGluc3RlYWQuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNsYXNzQ29tcG9uZW50VXBkYXRlci5lbnF1ZXVlUmVwbGFjZVN0YXRlKGluc3RhbmNlLCBpbnN0YW5jZS5zdGF0ZSwgbnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaW5zdGFuY2UucmVmcyA9IHt9OwogICAgICAgICAgaW5pdGlhbGl6ZVVwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgY29udGV4dFR5cGUgPSBjdG9yLmNvbnRleHRUeXBlOwogICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgPT09IG5ld1Byb3BzKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXREaXJlY3RseUFzc2lnbmluZ1Byb3BzVG9TdGF0ZS5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogSXQgaXMgbm90IHJlY29tbWVuZGVkIHRvIGFzc2lnbiBwcm9wcyBkaXJlY3RseSB0byBzdGF0ZSBiZWNhdXNlIHVwZGF0ZXMgdG8gcHJvcHMgd29uJ3QgYmUgcmVmbGVjdGVkIGluIHN0YXRlLiBJbiBtb3N0IGNhc2VzLCBpdCBpcyBiZXR0ZXIgdG8gdXNlIHByb3BzIGRpcmVjdGx5LiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkTGVnYWN5Q29udGV4dFdhcm5pbmcod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZFVuc2FmZUxpZmVjeWNsZVdhcm5pbmdzKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9IGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzOwogICAgICAgICAgaWYgKHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgYXBwbHlEZXJpdmVkU3RhdGVGcm9tUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlICE9PSAiZnVuY3Rpb24iICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbE1vdW50KHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpOwogICAgICAgICAgICBwcm9jZXNzVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyLCBuZXdQcm9wcywgaW5zdGFuY2UsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gZmliZXJGbGFnczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdW1lTW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgY3RvciwgbmV3UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciBvbGRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzOwogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBvbGRQcm9wczsKICAgICAgICAgIHZhciBvbGRDb250ZXh0ID0gaW5zdGFuY2UuY29udGV4dDsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBuZXh0Q29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBuZXh0TGVnYWN5VW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIG5leHRMZWdhY3lVbm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9IGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzOwogICAgICAgICAgdmFyIGhhc05ld0xpZmVjeWNsZXMgPSB0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIjsKICAgICAgICAgIGlmICghaGFzTmV3TGlmZWN5Y2xlcyAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICBpZiAob2xkUHJvcHMgIT09IG5ld1Byb3BzIHx8IG9sZENvbnRleHQgIT09IG5leHRDb250ZXh0KSB7CiAgICAgICAgICAgICAgY2FsbENvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSwgbmV3UHJvcHMsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVzZXRIYXNGb3JjZVVwZGF0ZUJlZm9yZVByb2Nlc3NpbmcoKTsKICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIG5ld1N0YXRlID0gaW5zdGFuY2Uuc3RhdGUgPSBvbGRTdGF0ZTsKICAgICAgICAgIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIG5ld1Byb3BzLCBpbnN0YW5jZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAob2xkUHJvcHMgPT09IG5ld1Byb3BzICYmIG9sZFN0YXRlID09PSBuZXdTdGF0ZSAmJiAhaGFzQ29udGV4dENoYW5nZWQoKSAmJiAhY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gZmliZXJGbGFnczsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBhcHBseURlcml2ZWRTdGF0ZUZyb21Qcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcywgbmV3UHJvcHMpOwogICAgICAgICAgICBuZXdTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZSA9IGNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSB8fCBjaGVja1Nob3VsZENvbXBvbmVudFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG9sZFByb3BzLCBuZXdQcm9wcywgb2xkU3RhdGUsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICAgIGlmICghaGFzTmV3TGlmZWN5Y2xlcyAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBfZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IF9maWJlckZsYWdzOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlckZsYWdzMiA9IFVwZGF0ZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBfZmliZXJGbGFnczIgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIF9maWJlckZsYWdzMiB8PSBNb3VudExheW91dERldjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IF9maWJlckZsYWdzMjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gbmV4dENvbnRleHQ7CiAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDbGFzc0luc3RhbmNlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBjbG9uZVVwZGF0ZVF1ZXVlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIHVucmVzb2x2ZWRPbGRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzOwogICAgICAgICAgdmFyIG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUgPT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA/IHVucmVzb2x2ZWRPbGRQcm9wcyA6IHJlc29sdmVEZWZhdWx0UHJvcHMyKHdvcmtJblByb2dyZXNzMi50eXBlLCB1bnJlc29sdmVkT2xkUHJvcHMpOwogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBvbGRQcm9wczsKICAgICAgICAgIHZhciB1bnJlc29sdmVkTmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIG9sZENvbnRleHQgPSBpbnN0YW5jZS5jb250ZXh0OwogICAgICAgICAgdmFyIGNvbnRleHRUeXBlID0gY3Rvci5jb250ZXh0VHlwZTsKICAgICAgICAgIHZhciBuZXh0Q29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gcmVhZENvbnRleHQoY29udGV4dFR5cGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG5leHRVbm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCB0cnVlKTsKICAgICAgICAgICAgbmV4dENvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgbmV4dFVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID0gY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHM7CiAgICAgICAgICB2YXIgaGFzTmV3TGlmZWN5Y2xlcyA9IHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iOwogICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IHVucmVzb2x2ZWROZXdQcm9wcyB8fCBvbGRDb250ZXh0ICE9PSBuZXh0Q29udGV4dCkgewogICAgICAgICAgICAgIGNhbGxDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UsIG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlc2V0SGFzRm9yY2VVcGRhdGVCZWZvcmVQcm9jZXNzaW5nKCk7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGluc3RhbmNlLnN0YXRlID0gb2xkU3RhdGU7CiAgICAgICAgICBwcm9jZXNzVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyLCBuZXdQcm9wcywgaW5zdGFuY2UsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICBuZXdTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyA9PT0gdW5yZXNvbHZlZE5ld1Byb3BzICYmIG9sZFN0YXRlID09PSBuZXdTdGF0ZSAmJiAhaGFzQ29udGV4dENoYW5nZWQoKSAmJiAhY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpICYmICFlbmFibGVMYXp5Q29udGV4dFByb3BhZ2F0aW9uKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gY3VycmVudDQubWVtb2l6ZWRQcm9wcyB8fCBvbGRTdGF0ZSAhPT0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTbmFwc2hvdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgYXBwbHlEZXJpdmVkU3RhdGVGcm9tUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkgfHwgY2hlY2tTaG91bGRDb21wb25lbnRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBvbGRQcm9wcywgbmV3UHJvcHMsIG9sZFN0YXRlLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpIHx8IC8vIFRPRE86IEluIHNvbWUgY2FzZXMsIHdlJ2xsIGVuZCB1cCBjaGVja2luZyBpZiBjb250ZXh0IGhhcyBjaGFuZ2VkIHR3aWNlLAogICAgICAgICAgLy8gYm90aCBiZWZvcmUgYW5kIGFmdGVyIGBzaG91bGRDb21wb25lbnRVcGRhdGVgIGhhcyBiZWVuIGNhbGxlZC4gTm90IGlkZWFsLAogICAgICAgICAgLy8gYnV0IEknbSBsb2F0aCB0byByZWZhY3RvciB0aGlzIGZ1bmN0aW9uLiBUaGlzIG9ubHkgaGFwcGVucyBmb3IgbWVtb2l6ZWQKICAgICAgICAgIC8vIGNvbXBvbmVudHMgc28gaXQncyBub3QgdGhhdCBjb21tb24uCiAgICAgICAgICBlbmFibGVMYXp5Q29udGV4dFByb3BhZ2F0aW9uOwogICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICBpZiAoIWhhc05ld0xpZmVjeWNsZXMgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUobmV3UHJvcHMsIG5ld1N0YXRlLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTbmFwc2hvdDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSBjdXJyZW50NC5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50NC5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gY3VycmVudDQubWVtb2l6ZWRQcm9wcyB8fCBvbGRTdGF0ZSAhPT0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNuYXBzaG90OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICBpbnN0YW5jZS5jb250ZXh0ID0gbmV4dENvbnRleHQ7CiAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcih2YWx1ZSwgc291cmNlKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgc291cmNlLAogICAgICAgICAgICBzdGFjazogZ2V0U3RhY2tCeUZpYmVySW5EZXZBbmRQcm9kKHNvdXJjZSksCiAgICAgICAgICAgIGRpZ2VzdDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2FwdHVyZWRWYWx1ZSh2YWx1ZSwgZGlnZXN0LCBzdGFjaykgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHNvdXJjZTogbnVsbCwKICAgICAgICAgICAgc3RhY2s6IHN0YWNrICE9IG51bGwgPyBzdGFjayA6IG51bGwsCiAgICAgICAgICAgIGRpZ2VzdDogZGlnZXN0ICE9IG51bGwgPyBkaWdlc3QgOiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG93RXJyb3JEaWFsb2coYm91bmRhcnksIGVycm9ySW5mbykgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxvZ0NhcHR1cmVkRXJyb3IoYm91bmRhcnksIGVycm9ySW5mbykgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIGxvZ0Vycm9yID0gc2hvd0Vycm9yRGlhbG9nKGJvdW5kYXJ5LCBlcnJvckluZm8pOwogICAgICAgICAgICBpZiAobG9nRXJyb3IgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSBlcnJvckluZm8udmFsdWU7CiAgICAgICAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgICAgICAgdmFyIHNvdXJjZSA9IGVycm9ySW5mby5zb3VyY2U7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZXJyb3JJbmZvLnN0YWNrOwogICAgICAgICAgICAgIHZhciBjb21wb25lbnRTdGFjayA9IHN0YWNrICE9PSBudWxsID8gc3RhY2sgOiAiIjsKICAgICAgICAgICAgICBpZiAoZXJyb3IyICE9IG51bGwgJiYgZXJyb3IyLl9zdXBwcmVzc0xvZ2dpbmcpIHsKICAgICAgICAgICAgICAgIGlmIChib3VuZGFyeS50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBzb3VyY2UgPyBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHNvdXJjZSkgOiBudWxsOwogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lTWVzc2FnZSA9IGNvbXBvbmVudE5hbWUgPyAiVGhlIGFib3ZlIGVycm9yIG9jY3VycmVkIGluIHRoZSA8IiArIGNvbXBvbmVudE5hbWUgKyAiPiBjb21wb25lbnQ6IiA6ICJUaGUgYWJvdmUgZXJyb3Igb2NjdXJyZWQgaW4gb25lIG9mIHlvdXIgUmVhY3QgY29tcG9uZW50czoiOwogICAgICAgICAgICAgIHZhciBlcnJvckJvdW5kYXJ5TWVzc2FnZTsKICAgICAgICAgICAgICBpZiAoYm91bmRhcnkudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICAgICAgZXJyb3JCb3VuZGFyeU1lc3NhZ2UgPSAiQ29uc2lkZXIgYWRkaW5nIGFuIGVycm9yIGJvdW5kYXJ5IHRvIHlvdXIgdHJlZSB0byBjdXN0b21pemUgZXJyb3IgaGFuZGxpbmcgYmVoYXZpb3IuXG5WaXNpdCBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZXJyb3ItYm91bmRhcmllcyB0byBsZWFybiBtb3JlIGFib3V0IGVycm9yIGJvdW5kYXJpZXMuIjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGVycm9yQm91bmRhcnlOYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihib3VuZGFyeSkgfHwgIkFub255bW91cyI7CiAgICAgICAgICAgICAgICBlcnJvckJvdW5kYXJ5TWVzc2FnZSA9ICJSZWFjdCB3aWxsIHRyeSB0byByZWNyZWF0ZSB0aGlzIGNvbXBvbmVudCB0cmVlIGZyb20gc2NyYXRjaCAiICsgKCJ1c2luZyB0aGUgZXJyb3IgYm91bmRhcnkgeW91IHByb3ZpZGVkLCAiICsgZXJyb3JCb3VuZGFyeU5hbWUgKyAiLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgY29tYmluZWRNZXNzYWdlID0gY29tcG9uZW50TmFtZU1lc3NhZ2UgKyAiXG4iICsgY29tcG9uZW50U3RhY2sgKyAiXG5cbiIgKyAoIiIgKyBlcnJvckJvdW5kYXJ5TWVzc2FnZSk7CiAgICAgICAgICAgICAgY29uc29sZVsiZXJyb3IiXShjb21iaW5lZE1lc3NhZ2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUG9zc2libHlXZWFrTWFwJDEgPSB0eXBlb2YgV2Vha01hcCA9PT0gImZ1bmN0aW9uIiA/IFdlYWtNYXAgOiBNYXA7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUm9vdEVycm9yVXBkYXRlKGZpYmVyLCBlcnJvckluZm8sIGxhbmUpIHsKICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIGxhbmUpOwogICAgICAgICAgdXBkYXRlLnRhZyA9IENhcHR1cmVVcGRhdGU7CiAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHsKICAgICAgICAgICAgZWxlbWVudDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHZhciBlcnJvcjIgPSBlcnJvckluZm8udmFsdWU7CiAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgb25VbmNhdWdodEVycm9yKGVycm9yMik7CiAgICAgICAgICAgIGxvZ0NhcHR1cmVkRXJyb3IoZmliZXIsIGVycm9ySW5mbyk7CiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2xhc3NFcnJvclVwZGF0ZShmaWJlciwgZXJyb3JJbmZvLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKE5vVGltZXN0YW1wLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS50YWcgPSBDYXB0dXJlVXBkYXRlOwogICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9IGZpYmVyLnR5cGUuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yOwogICAgICAgICAgaWYgKHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIGVycm9yJDEgPSBlcnJvckluZm8udmFsdWU7CiAgICAgICAgICAgIHVwZGF0ZS5wYXlsb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcihlcnJvciQxKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFya0ZhaWxlZEVycm9yQm91bmRhcnlGb3JIb3RSZWxvYWRpbmcoZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluc3QgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICBpZiAoaW5zdCAhPT0gbnVsbCAmJiB0eXBlb2YgaW5zdC5jb21wb25lbnREaWRDYXRjaCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBmdW5jdGlvbiBjYWxsYmFjaygpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXJrRmFpbGVkRXJyb3JCb3VuZGFyeUZvckhvdFJlbG9hZGluZyhmaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGxvZ0NhcHR1cmVkRXJyb3IoZmliZXIsIGVycm9ySW5mbyk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIG1hcmtMZWdhY3lFcnJvckJvdW5kYXJ5QXNGYWlsZWQodGhpcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBlcnJvciQxMiA9IGVycm9ySW5mby52YWx1ZTsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBlcnJvckluZm8uc3RhY2s7CiAgICAgICAgICAgICAgdGhpcy5jb21wb25lbnREaWRDYXRjaChlcnJvciQxMiwgewogICAgICAgICAgICAgICAgY29tcG9uZW50U3RhY2s6IHN0YWNrICE9PSBudWxsID8gc3RhY2sgOiAiIgogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaW5jbHVkZXNTb21lTGFuZShmaWJlci5sYW5lcywgU3luY0xhbmUpKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBFcnJvciBib3VuZGFyaWVzIHNob3VsZCBpbXBsZW1lbnQgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yKCkuIEluIHRoYXQgbWV0aG9kLCByZXR1cm4gYSBzdGF0ZSB1cGRhdGUgdG8gZGlzcGxheSBhbiBlcnJvciBtZXNzYWdlIG9yIGZhbGxiYWNrIFVJLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJVbmtub3duIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRhY2hQaW5nTGlzdGVuZXIocm9vdDMsIHdha2VhYmxlLCBsYW5lcykgewogICAgICAgICAgdmFyIHBpbmdDYWNoZSA9IHJvb3QzLnBpbmdDYWNoZTsKICAgICAgICAgIHZhciB0aHJlYWRJRHM7CiAgICAgICAgICBpZiAocGluZ0NhY2hlID09PSBudWxsKSB7CiAgICAgICAgICAgIHBpbmdDYWNoZSA9IHJvb3QzLnBpbmdDYWNoZSA9IG5ldyBQb3NzaWJseVdlYWtNYXAkMSgpOwogICAgICAgICAgICB0aHJlYWRJRHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBwaW5nQ2FjaGUuc2V0KHdha2VhYmxlLCB0aHJlYWRJRHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyZWFkSURzID0gcGluZ0NhY2hlLmdldCh3YWtlYWJsZSk7CiAgICAgICAgICAgIGlmICh0aHJlYWRJRHMgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRocmVhZElEcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgICAgcGluZ0NhY2hlLnNldCh3YWtlYWJsZSwgdGhyZWFkSURzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCF0aHJlYWRJRHMuaGFzKGxhbmVzKSkgewogICAgICAgICAgICB0aHJlYWRJRHMuYWRkKGxhbmVzKTsKICAgICAgICAgICAgdmFyIHBpbmcgPSBwaW5nU3VzcGVuZGVkUm9vdC5iaW5kKG51bGwsIHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdha2VhYmxlLnRoZW4ocGluZywgcGluZyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGFjaFJldHJ5TGlzdGVuZXIoc3VzcGVuc2VCb3VuZGFyeSwgcm9vdDMsIHdha2VhYmxlLCBsYW5lcykgewogICAgICAgICAgdmFyIHdha2VhYmxlcyA9IHN1c3BlbnNlQm91bmRhcnkudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAod2FrZWFibGVzID09PSBudWxsKSB7CiAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIHVwZGF0ZVF1ZXVlLmFkZCh3YWtlYWJsZSk7CiAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkudXBkYXRlUXVldWUgPSB1cGRhdGVRdWV1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdha2VhYmxlcy5hZGQod2FrZWFibGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFN1c3BlbmRlZENvbXBvbmVudChzb3VyY2VGaWJlciwgcm9vdFJlbmRlckxhbmVzKSB7CiAgICAgICAgICB2YXIgdGFnID0gc291cmNlRmliZXIudGFnOwogICAgICAgICAgaWYgKChzb3VyY2VGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgKHRhZyA9PT0gRnVuY3Rpb25Db21wb25lbnQgfHwgdGFnID09PSBGb3J3YXJkUmVmMiB8fCB0YWcgPT09IFNpbXBsZU1lbW9Db21wb25lbnQpKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50U291cmNlID0gc291cmNlRmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudFNvdXJjZSkgewogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLnVwZGF0ZVF1ZXVlID0gY3VycmVudFNvdXJjZS51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5tZW1vaXplZFN0YXRlID0gY3VycmVudFNvdXJjZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmxhbmVzID0gY3VycmVudFNvdXJjZS5sYW5lczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgc291cmNlRmliZXIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmVhcmVzdFN1c3BlbnNlQm91bmRhcnlUb0NhcHR1cmUocmV0dXJuRmliZXIpIHsKICAgICAgICAgIHZhciBub2RlID0gcmV0dXJuRmliZXI7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQgJiYgc2hvdWxkQ2FwdHVyZVN1c3BlbnNlKG5vZGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAobm9kZSAhPT0gbnVsbCk7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1N1c3BlbnNlQm91bmRhcnlTaG91bGRDYXB0dXJlKHN1c3BlbnNlQm91bmRhcnksIHJldHVybkZpYmVyLCBzb3VyY2VGaWJlciwgcm9vdDMsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgaWYgKChzdXNwZW5zZUJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeSA9PT0gcmV0dXJuRmliZXIpIHsKICAgICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzIHw9IEZvcmNlVXBkYXRlRm9yTGVnYWN5U3VzcGVuc2U7CiAgICAgICAgICAgICAgc291cmNlRmliZXIuZmxhZ3MgJj0gfihMaWZlY3ljbGVFZmZlY3RNYXNrIHwgSW5jb21wbGV0ZSk7CiAgICAgICAgICAgICAgaWYgKHNvdXJjZUZpYmVyLnRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U291cmNlRmliZXIgPSBzb3VyY2VGaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFNvdXJjZUZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNvdXJjZUZpYmVyLnRhZyA9IEluY29tcGxldGVDbGFzc0NvbXBvbmVudDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVVcGRhdGUoTm9UaW1lc3RhbXAsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgICAgdXBkYXRlLnRhZyA9IEZvcmNlVXBkYXRlOwogICAgICAgICAgICAgICAgICBlbnF1ZXVlVXBkYXRlKHNvdXJjZUZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc291cmNlRmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKHNvdXJjZUZpYmVyLmxhbmVzLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN1c3BlbnNlQm91bmRhcnk7CiAgICAgICAgICB9CiAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmxhbmVzID0gcm9vdFJlbmRlckxhbmVzOwogICAgICAgICAgcmV0dXJuIHN1c3BlbnNlQm91bmRhcnk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRocm93RXhjZXB0aW9uKHJvb3QzLCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHZhbHVlLCByb290UmVuZGVyTGFuZXMpIHsKICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzIHw9IEluY29tcGxldGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB2YWx1ZS50aGVuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciB3YWtlYWJsZSA9IHZhbHVlOwogICAgICAgICAgICByZXNldFN1c3BlbmRlZENvbXBvbmVudChzb3VyY2VGaWJlcik7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBzb3VyY2VGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICAgIG1hcmtEaWRUaHJvd1doaWxlSHlkcmF0aW5nREVWKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdXNwZW5zZUJvdW5kYXJ5ID0gZ2V0TmVhcmVzdFN1c3BlbnNlQm91bmRhcnlUb0NhcHR1cmUocmV0dXJuRmliZXIpOwogICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkuZmxhZ3MgJj0gfkZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICAgIG1hcmtTdXNwZW5zZUJvdW5kYXJ5U2hvdWxkQ2FwdHVyZShzdXNwZW5zZUJvdW5kYXJ5LCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHJvb3QzLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZUJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgICAgICAgYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXR0YWNoUmV0cnlMaXN0ZW5lcihzdXNwZW5zZUJvdW5kYXJ5LCByb290Mywgd2FrZWFibGUpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVzU3luY0xhbmUocm9vdFJlbmRlckxhbmVzKSkgewogICAgICAgICAgICAgICAgYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHVuY2F1Z2h0U3VzcGVuc2VFcnJvciA9IG5ldyBFcnJvcigiQSBjb21wb25lbnQgc3VzcGVuZGVkIHdoaWxlIHJlc3BvbmRpbmcgdG8gc3luY2hyb25vdXMgaW5wdXQuIFRoaXMgd2lsbCBjYXVzZSB0aGUgVUkgdG8gYmUgcmVwbGFjZWQgd2l0aCBhIGxvYWRpbmcgaW5kaWNhdG9yLiBUbyBmaXgsIHVwZGF0ZXMgdGhhdCBzdXNwZW5kIHNob3VsZCBiZSB3cmFwcGVkIHdpdGggc3RhcnRUcmFuc2l0aW9uLiIpOwogICAgICAgICAgICAgIHZhbHVlID0gdW5jYXVnaHRTdXNwZW5zZUVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBzb3VyY2VGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpOwogICAgICAgICAgICAgIHZhciBfc3VzcGVuc2VCb3VuZGFyeSA9IGdldE5lYXJlc3RTdXNwZW5zZUJvdW5kYXJ5VG9DYXB0dXJlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICBpZiAoX3N1c3BlbnNlQm91bmRhcnkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICgoX3N1c3BlbnNlQm91bmRhcnkuZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICBfc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBGb3JjZUNsaWVudFJlbmRlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1hcmtTdXNwZW5zZUJvdW5kYXJ5U2hvdWxkQ2FwdHVyZShfc3VzcGVuc2VCb3VuZGFyeSwgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCByb290Mywgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IoY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZUZpYmVyKSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YWx1ZSA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKHZhbHVlLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICByZW5kZXJEaWRFcnJvcih2YWx1ZSk7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MyID0gcmV0dXJuRmliZXI7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHZhciBfZXJyb3JJbmZvID0gdmFsdWU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVSb290RXJyb3JVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBfZXJyb3JJbmZvLCBsYW5lKTsKICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHVwZGF0ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gdmFsdWU7CiAgICAgICAgICAgICAgICB2YXIgY3RvciA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MgJiYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIiB8fCBpbnN0YW5jZSAhPT0gbnVsbCAmJiB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIgJiYgIWlzQWxyZWFkeUZhaWxlZExlZ2FjeUVycm9yQm91bmRhcnkoaW5zdGFuY2UpKSkgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU2hvdWxkQ2FwdHVyZTsKICAgICAgICAgICAgICAgICAgdmFyIF9sYW5lID0gcGlja0FyYml0cmFyeUxhbmUocm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMsIF9sYW5lKTsKICAgICAgICAgICAgICAgICAgdmFyIF91cGRhdGUgPSBjcmVhdGVDbGFzc0Vycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgZXJyb3JJbmZvLCBfbGFuZSk7CiAgICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIF91cGRhdGUpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIgPSB3b3JrSW5Qcm9ncmVzczIucmV0dXJuOwogICAgICAgICAgfSB3aGlsZSAod29ya0luUHJvZ3Jlc3MyICE9PSBudWxsKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3VzcGVuZGVkQ2FjaGUoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEJhZENsYXNzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXI7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dEJhZENsYXNzID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50ID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnQgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnQgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmcyA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXIgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50ID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbW91bnRDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIG51bGwsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgY3VycmVudDQuY2hpbGQsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yY2VVbm1vdW50Q3VycmVudEFuZFJlY29uY2lsZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVjb25jaWxlQ2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBjdXJyZW50NC5jaGlsZCwgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGb3J3YXJkUmVmKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVuZGVyMiA9IENvbXBvbmVudC5yZW5kZXI7CiAgICAgICAgICB2YXIgcmVmID0gd29ya0luUHJvZ3Jlc3MyLnJlZjsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW47CiAgICAgICAgICB2YXIgaGFzSWQ7CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXIyLCBuZXh0UHJvcHMsIHJlZiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXIyLCBuZXh0UHJvcHMsIHJlZiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgIWRpZFJlY2VpdmVVcGRhdGUpIHsKICAgICAgICAgICAgYmFpbG91dEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBoYXNJZCkgewogICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1lbW9Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHZhciB0eXBlID0gQ29tcG9uZW50LnR5cGU7CiAgICAgICAgICAgIGlmIChpc1NpbXBsZUZ1bmN0aW9uQ29tcG9uZW50KHR5cGUpICYmIENvbXBvbmVudC5jb21wYXJlID09PSBudWxsICYmIC8vIFNpbXBsZU1lbW9Db21wb25lbnQgY29kZXBhdGggZG9lc24ndCByZXNvbHZlIG91dGVyIHByb3BzIGVpdGhlci4KICAgICAgICAgICAgQ29tcG9uZW50LmRlZmF1bHRQcm9wcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIHJlc29sdmVkVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gU2ltcGxlTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IHJlc29sdmVkVHlwZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUZ1bmN0aW9uQ29tcG9uZW50SW5EZXYod29ya0luUHJvZ3Jlc3MyLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVNpbXBsZU1lbW9Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVzb2x2ZWRUeXBlLCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBpbm5lclByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoQ29tcG9uZW50LmRlZmF1bHRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBTdXBwb3J0IGZvciBkZWZhdWx0UHJvcHMgd2lsbCBiZSByZW1vdmVkIGZyb20gbWVtbyBjb21wb25lbnRzIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFVzZSBKYXZhU2NyaXB0IGRlZmF1bHQgcGFyYW1ldGVycyBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkID0gY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKENvbXBvbmVudC50eXBlLCBudWxsLCBuZXh0UHJvcHMsIHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLm1vZGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNoaWxkLnJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIF90eXBlID0gQ29tcG9uZW50LnR5cGU7CiAgICAgICAgICAgIHZhciBfaW5uZXJQcm9wVHlwZXMgPSBfdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIGlmIChfaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgIF9pbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoX3R5cGUpCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRDaGlsZCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCA9IGNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQ0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgaWYgKCFoYXNTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQpIHsKICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnRDaGlsZC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB2YXIgY29tcGFyZSA9IENvbXBvbmVudC5jb21wYXJlOwogICAgICAgICAgICBjb21wYXJlID0gY29tcGFyZSAhPT0gbnVsbCA/IGNvbXBhcmUgOiBzaGFsbG93RXF1YWwyOwogICAgICAgICAgICBpZiAoY29tcGFyZShwcmV2UHJvcHMsIG5leHRQcm9wcykgJiYgY3VycmVudDQucmVmID09PSB3b3JrSW5Qcm9ncmVzczIucmVmKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICB2YXIgbmV3Q2hpbGQgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50Q2hpbGQsIG5leHRQcm9wcyk7CiAgICAgICAgICBuZXdDaGlsZC5yZWYgPSB3b3JrSW5Qcm9ncmVzczIucmVmOwogICAgICAgICAgbmV3Q2hpbGQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbmV3Q2hpbGQ7CiAgICAgICAgICByZXR1cm4gbmV3Q2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVNpbXBsZU1lbW9Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgIHZhciBvdXRlck1lbW9UeXBlID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlOwogICAgICAgICAgICAgIGlmIChvdXRlck1lbW9UeXBlLiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gb3V0ZXJNZW1vVHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIG91dGVyTWVtb1R5cGUgPSBpbml0KHBheWxvYWQpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgb3V0ZXJNZW1vVHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJQcm9wVHlwZXMgPSBvdXRlck1lbW9UeXBlICYmIG91dGVyTWVtb1R5cGUucHJvcFR5cGVzOwogICAgICAgICAgICAgICAgaWYgKG91dGVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICAgIG91dGVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCAoU2ltcGxlTWVtb0NvbXBvbmVudCBoYXMgbm8gZGVmYXVsdFByb3BzKQogICAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUob3V0ZXJNZW1vVHlwZSkKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgcHJldlByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgaWYgKHNoYWxsb3dFcXVhbDIocHJldlByb3BzLCBuZXh0UHJvcHMpICYmIGN1cnJlbnQ0LnJlZiA9PT0gd29ya0luUHJvZ3Jlc3MyLnJlZiAmJiAvLyBQcmV2ZW50IGJhaWxvdXQgaWYgdGhlIGltcGxlbWVudGF0aW9uIGNoYW5nZWQgZHVlIHRvIGhvdCByZWxvYWQuCiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID09PSBjdXJyZW50NC50eXBlKSB7CiAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMgPSBuZXh0UHJvcHMgPSBwcmV2UHJvcHM7CiAgICAgICAgICAgICAgaWYgKCFjaGVja1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dChjdXJyZW50NCwgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDQubGFuZXM7CiAgICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGN1cnJlbnQ0LmZsYWdzICYgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVPZmZzY3JlZW5Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQgIT09IG51bGwgPyBjdXJyZW50NC5tZW1vaXplZFN0YXRlIDogbnVsbDsKICAgICAgICAgIGlmIChuZXh0UHJvcHMubW9kZSA9PT0gImhpZGRlbiIgfHwgZW5hYmxlTGVnYWN5SGlkZGVuKSB7CiAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB7CiAgICAgICAgICAgICAgICBiYXNlTGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IG51bGwsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXh0U3RhdGU7CiAgICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfSBlbHNlIGlmICghaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIE9mZnNjcmVlbkxhbmUpKSB7CiAgICAgICAgICAgICAgdmFyIHNwYXduZWRDYWNoZVBvb2wgPSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXh0QmFzZUxhbmVzOwogICAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2QmFzZUxhbmVzID0gcHJldlN0YXRlLmJhc2VMYW5lczsKICAgICAgICAgICAgICAgIG5leHRCYXNlTGFuZXMgPSBtZXJnZUxhbmVzKHByZXZCYXNlTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRCYXNlTGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gbGFuZVRvTGFuZXMoT2Zmc2NyZWVuTGFuZSk7CiAgICAgICAgICAgICAgdmFyIF9uZXh0U3RhdGUgPSB7CiAgICAgICAgICAgICAgICBiYXNlTGFuZXM6IG5leHRCYXNlTGFuZXMsCiAgICAgICAgICAgICAgICBjYWNoZVBvb2w6IHNwYXduZWRDYWNoZVBvb2wsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbAogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBfbmV4dFN0YXRlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgbmV4dEJhc2VMYW5lcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0U3RhdGUyID0gewogICAgICAgICAgICAgICAgYmFzZUxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgICAgY2FjaGVQb29sOiBudWxsLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gX25leHRTdGF0ZTI7CiAgICAgICAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lczIgPSBwcmV2U3RhdGUgIT09IG51bGwgPyBwcmV2U3RhdGUuYmFzZUxhbmVzIDogcmVuZGVyTGFuZXMyOwogICAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIHN1YnRyZWVSZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX3N1YnRyZWVSZW5kZXJMYW5lczsKICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIF9zdWJ0cmVlUmVuZGVyTGFuZXMgPSBtZXJnZUxhbmVzKHByZXZTdGF0ZS5iYXNlTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIF9zdWJ0cmVlUmVuZGVyTGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHVzaFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMiwgX3N1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcmFnbWVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTW9kZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlUHJvZmlsZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVmKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHZhciByZWYgPSB3b3JrSW5Qcm9ncmVzczIucmVmOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsICYmIHJlZiAhPT0gbnVsbCB8fCBjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC5yZWYgIT09IHJlZikgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmMjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBSZWZTdGF0aWM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRnVuY3Rpb25Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgIHZhciBpbm5lclByb3BUeXBlcyA9IENvbXBvbmVudC5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgaWYgKGlubmVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgaW5uZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgcHJvcHMKICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb250ZXh0OwogICAgICAgICAgewogICAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCB0cnVlKTsKICAgICAgICAgICAgY29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbjsKICAgICAgICAgIHZhciBoYXNJZDsKICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyh0cnVlKTsKICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gcmVuZGVyV2l0aEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gcmVuZGVyV2l0aEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiAhZGlkUmVjZWl2ZVVwZGF0ZSkgewogICAgICAgICAgICBiYWlsb3V0SG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpICYmIGhhc0lkKSB7CiAgICAgICAgICAgIHB1c2hNYXRlcmlhbGl6ZWRUcmVlSWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2xhc3NDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKHNob3VsZEVycm9yKHdvcmtJblByb2dyZXNzMikpIHsKICAgICAgICAgICAgICBjYXNlIGZhbHNlOiB7CiAgICAgICAgICAgICAgICB2YXIgX2luc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHZhciBjdG9yID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgICB2YXIgdGVtcEluc3RhbmNlID0gbmV3IGN0b3Iod29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMsIF9pbnN0YW5jZS5jb250ZXh0KTsKICAgICAgICAgICAgICAgIHZhciBzdGF0ZSA9IHRlbXBJbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgICAgICAgIF9pbnN0YW5jZS51cGRhdGVyLmVucXVldWVTZXRTdGF0ZShfaW5zdGFuY2UsIHN0YXRlLCBudWxsKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIHRydWU6IHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IkMSA9IG5ldyBFcnJvcigiU2ltdWxhdGVkIGVycm9yIGNvbWluZyBmcm9tIERldlRvb2xzIik7CiAgICAgICAgICAgICAgICB2YXIgbGFuZSA9IHBpY2tBcmJpdHJhcnlMYW5lKHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzMi5sYW5lcywgbGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlQ2xhc3NFcnJvclVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKGVycm9yJDEsIHdvcmtJblByb2dyZXNzMiksIGxhbmUpOwogICAgICAgICAgICAgICAgZW5xdWV1ZUNhcHR1cmVkVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgdXBkYXRlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgIHZhciBpbm5lclByb3BUeXBlcyA9IENvbXBvbmVudC5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgaWYgKGlubmVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgaW5uZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgIG5leHRQcm9wcywKICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgcHJvcHMKICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBoYXNDb250ZXh0OwogICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlOwogICAgICAgICAgaWYgKGluc3RhbmNlID09PSBudWxsKSB7CiAgICAgICAgICAgIHJlc2V0U3VzcGVuZGVkQ3VycmVudE9uTW91bnRJbkxlZ2FjeU1vZGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIGNvbnN0cnVjdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcyk7CiAgICAgICAgICAgIG1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBzaG91bGRVcGRhdGUgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICBzaG91bGRVcGRhdGUgPSByZXN1bWVNb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHVwZGF0ZUNsYXNzSW5zdGFuY2UoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFVuaXRPZldvcmsgPSBmaW5pc2hDbGFzc0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHNob3VsZFVwZGF0ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGluc3QgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlICYmIGluc3QucHJvcHMgIT09IG5leHRQcm9wcykgewogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcykgewogICAgICAgICAgICAgICAgZXJyb3IoIkl0IGxvb2tzIGxpa2UgJXMgaXMgcmVhc3NpZ25pbmcgaXRzIG93biBgdGhpcy5wcm9wc2Agd2hpbGUgcmVuZGVyaW5nLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIGNhbiBsZWFkIHRvIGNvbmZ1c2luZyBidWdzLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MyKSB8fCAiYSBjb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXh0VW5pdE9mV29yazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluaXNoQ2xhc3NDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBzaG91bGRVcGRhdGUsIGhhc0NvbnRleHQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgbWFya1JlZihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBkaWRDYXB0dXJlRXJyb3IgPSAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoIXNob3VsZFVwZGF0ZSAmJiAhZGlkQ2FwdHVyZUVycm9yKSB7CiAgICAgICAgICAgIGlmIChoYXNDb250ZXh0KSB7CiAgICAgICAgICAgICAgaW52YWxpZGF0ZUNvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbjsKICAgICAgICAgIGlmIChkaWRDYXB0dXJlRXJyb3IgJiYgdHlwZW9mIENvbXBvbmVudC5nZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gbnVsbDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzZXRJc1JlbmRlcmluZyh0cnVlKTsKICAgICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBpbnN0YW5jZS5yZW5kZXIoKTsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLnJlbmRlcigpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmIGRpZENhcHR1cmVFcnJvcikgewogICAgICAgICAgICBmb3JjZVVubW91bnRDdXJyZW50QW5kUmVjb25jaWxlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICBpZiAoaGFzQ29udGV4dCkgewogICAgICAgICAgICBpbnZhbGlkYXRlQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hIb3N0Um9vdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB2YXIgcm9vdDMgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKHJvb3QzLnBlbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgIHB1c2hUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MyLCByb290My5wZW5kaW5nQ29udGV4dCwgcm9vdDMucGVuZGluZ0NvbnRleHQgIT09IHJvb3QzLmNvbnRleHQpOwogICAgICAgICAgfSBlbHNlIGlmIChyb290My5jb250ZXh0KSB7CiAgICAgICAgICAgIHB1c2hUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MyLCByb290My5jb250ZXh0LCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIsIHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVIb3N0Um9vdChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHB1c2hIb3N0Um9vdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBoYXZlIGEgY3VycmVudCBmaWJlci4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHByZXZDaGlsZHJlbiA9IHByZXZTdGF0ZS5lbGVtZW50OwogICAgICAgICAgY2xvbmVVcGRhdGVRdWV1ZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHByb2Nlc3NVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIsIG5leHRQcm9wcywgbnVsbCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gbmV4dFN0YXRlLmVsZW1lbnQ7CiAgICAgICAgICBpZiAocHJldlN0YXRlLmlzRGVoeWRyYXRlZCkgewogICAgICAgICAgICB2YXIgb3ZlcnJpZGVTdGF0ZSA9IHsKICAgICAgICAgICAgICBlbGVtZW50OiBuZXh0Q2hpbGRyZW4sCiAgICAgICAgICAgICAgaXNEZWh5ZHJhdGVkOiBmYWxzZSwKICAgICAgICAgICAgICBjYWNoZTogbmV4dFN0YXRlLmNhY2hlLAogICAgICAgICAgICAgIHBlbmRpbmdTdXNwZW5zZUJvdW5kYXJpZXM6IG5leHRTdGF0ZS5wZW5kaW5nU3VzcGVuc2VCb3VuZGFyaWVzLAogICAgICAgICAgICAgIHRyYW5zaXRpb25zOiBuZXh0U3RhdGUudHJhbnNpdGlvbnMKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICB1cGRhdGVRdWV1ZS5iYXNlU3RhdGUgPSBvdmVycmlkZVN0YXRlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG92ZXJyaWRlU3RhdGU7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBGb3JjZUNsaWVudFJlbmRlcikgewogICAgICAgICAgICAgIHZhciByZWNvdmVyYWJsZUVycm9yID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIobmV3IEVycm9yKCJUaGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgaHlkcmF0aW5nLiBCZWNhdXNlIHRoZSBlcnJvciBoYXBwZW5lZCBvdXRzaWRlIG9mIGEgU3VzcGVuc2UgYm91bmRhcnksIHRoZSBlbnRpcmUgcm9vdCB3aWxsIHN3aXRjaCB0byBjbGllbnQgcmVuZGVyaW5nLiIpLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEhvc3RSb290V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMiwgcmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobmV4dENoaWxkcmVuICE9PSBwcmV2Q2hpbGRyZW4pIHsKICAgICAgICAgICAgICB2YXIgX3JlY292ZXJhYmxlRXJyb3IgPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihuZXcgRXJyb3IoIlRoaXMgcm9vdCByZWNlaXZlZCBhbiBlYXJseSB1cGRhdGUsIGJlZm9yZSBhbnl0aGluZyB3YXMgYWJsZSBoeWRyYXRlLiBTd2l0Y2hlZCB0aGUgZW50aXJlIHJvb3QgdG8gY2xpZW50IHJlbmRlcmluZy4iKSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRIb3N0Um9vdFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIsIF9yZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlbnRlckh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbW91bnRDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIG51bGwsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjaGlsZDsKICAgICAgICAgICAgICB2YXIgbm9kZSA9IGNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgICAgICBub2RlLmZsYWdzID0gbm9kZS5mbGFncyAmIH5QbGFjZW1lbnQgfCBIeWRyYXRpbmc7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZSgpOwogICAgICAgICAgICBpZiAobmV4dENoaWxkcmVuID09PSBwcmV2Q2hpbGRyZW4pIHsKICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SG9zdFJvb3RXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyLCByZWNvdmVyYWJsZUVycm9yKSB7CiAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICBxdWV1ZUh5ZHJhdGlvbkVycm9yKHJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSG9zdENvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHB1c2hIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcHJldlByb3BzID0gY3VycmVudDQgIT09IG51bGwgPyBjdXJyZW50NC5tZW1vaXplZFByb3BzIDogbnVsbDsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YXIgaXNEaXJlY3RUZXh0Q2hpbGQgPSBzaG91bGRTZXRUZXh0Q29udGVudCh0eXBlLCBuZXh0UHJvcHMpOwogICAgICAgICAgaWYgKGlzRGlyZWN0VGV4dENoaWxkKSB7CiAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgaWYgKHByZXZQcm9wcyAhPT0gbnVsbCAmJiBzaG91bGRTZXRUZXh0Q29udGVudCh0eXBlLCBwcmV2UHJvcHMpKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBDb250ZW50UmVzZXQ7CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUmVmKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSG9zdFRleHQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRMYXp5Q29tcG9uZW50KF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIsIGVsZW1lbnRUeXBlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJlc2V0U3VzcGVuZGVkQ3VycmVudE9uTW91bnRJbkxlZ2FjeU1vZGUoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgcHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSBlbGVtZW50VHlwZTsKICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgIHZhciBDb21wb25lbnQgPSBpbml0KHBheWxvYWQpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBDb21wb25lbnQ7CiAgICAgICAgICB2YXIgcmVzb2x2ZWRUYWcgPSB3b3JrSW5Qcm9ncmVzczIudGFnID0gcmVzb2x2ZUxhenlDb21wb25lbnRUYWcoQ29tcG9uZW50KTsKICAgICAgICAgIHZhciByZXNvbHZlZFByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wczIoQ29tcG9uZW50LCBwcm9wcyk7CiAgICAgICAgICB2YXIgY2hpbGQ7CiAgICAgICAgICBzd2l0Y2ggKHJlc29sdmVkVGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUZ1bmN0aW9uQ29tcG9uZW50SW5EZXYod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQpOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBDb21wb25lbnQgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcoQ29tcG9uZW50KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSB1cGRhdGVGdW5jdGlvbkNvbXBvbmVudChudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50ID0gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlQ2xhc3NDb21wb25lbnQobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudCA9IHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlRm9yd2FyZFJlZihudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcmVzb2x2ZWRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIG91dGVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICAgICAgaWYgKG91dGVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgICAgICBvdXRlclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkUHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBmb3Igb3V0ZXIgb25seQogICAgICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlTWVtb0NvbXBvbmVudCgKICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICBDb21wb25lbnQsCiAgICAgICAgICAgICAgICByZXNvbHZlRGVmYXVsdFByb3BzMihDb21wb25lbnQudHlwZSwgcmVzb2x2ZWRQcm9wcyksCiAgICAgICAgICAgICAgICAvLyBUaGUgaW5uZXIgdHlwZSBjYW4gaGF2ZSBkZWZhdWx0cyB0b28KICAgICAgICAgICAgICAgIHJlbmRlckxhbmVzMgogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaGludCA9ICIiOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoQ29tcG9uZW50ICE9PSBudWxsICYmIHR5cGVvZiBDb21wb25lbnQgPT09ICJvYmplY3QiICYmIENvbXBvbmVudC4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgaGludCA9ICIgRGlkIHlvdSB3cmFwIGEgY29tcG9uZW50IGluIFJlYWN0LmxhenkoKSBtb3JlIHRoYW4gb25jZT8iOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkVsZW1lbnQgdHlwZSBpcyBpbnZhbGlkLiBSZWNlaXZlZCBhIHByb21pc2UgdGhhdCByZXNvbHZlcyB0bzogIiArIENvbXBvbmVudCArICIuICIgKyAoIkxhenkgZWxlbWVudCB0eXBlIG11c3QgcmVzb2x2ZSB0byBhIGNsYXNzIG9yIGZ1bmN0aW9uLiIgKyBoaW50KSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50KF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJlc2V0U3VzcGVuZGVkQ3VycmVudE9uTW91bnRJbkxlZ2FjeU1vZGUoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICB2YXIgaGFzQ29udGV4dDsKICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgIGhhc0NvbnRleHQgPSB0cnVlOwogICAgICAgICAgICBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBoYXNDb250ZXh0ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICBjb25zdHJ1Y3RDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMpOwogICAgICAgICAgbW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gZmluaXNoQ2xhc3NDb21wb25lbnQobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUsIGhhc0NvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SW5kZXRlcm1pbmF0ZUNvbXBvbmVudChfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciBwcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgY29udGV4dDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgZmFsc2UpOwogICAgICAgICAgICBjb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgdmFsdWU7CiAgICAgICAgICB2YXIgaGFzSWQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb21wb25lbnQucHJvdG90eXBlICYmIHR5cGVvZiBDb21wb25lbnQucHJvdG90eXBlLnJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0QmFkQ2xhc3NbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgPCVzIC8+IGNvbXBvbmVudCBhcHBlYXJzIHRvIGhhdmUgYSByZW5kZXIgbWV0aG9kLCBidXQgZG9lc24ndCBleHRlbmQgUmVhY3QuQ29tcG9uZW50LiBUaGlzIGlzIGxpa2VseSB0byBjYXVzZSBlcnJvcnMuIENoYW5nZSAlcyB0byBleHRlbmQgUmVhY3QuQ29tcG9uZW50IGluc3RlYWQuIiwgY29tcG9uZW50TmFtZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRCYWRDbGFzc1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRMZWdhY3lDb250ZXh0V2FybmluZyh3b3JrSW5Qcm9ncmVzczIsIG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHZhbHVlID0gcmVuZGVyV2l0aEhvb2tzKG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlLnJlbmRlciA9PT0gImZ1bmN0aW9uIiAmJiB2YWx1ZS4kJHR5cGVvZiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIF9jb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TW9kdWxlUGF0dGVybkNvbXBvbmVudFtfY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgPCVzIC8+IGNvbXBvbmVudCBhcHBlYXJzIHRvIGJlIGEgZnVuY3Rpb24gY29tcG9uZW50IHRoYXQgcmV0dXJucyBhIGNsYXNzIGluc3RhbmNlLiBDaGFuZ2UgJXMgdG8gYSBjbGFzcyB0aGF0IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IGluc3RlYWQuIElmIHlvdSBjYW4ndCB1c2UgYSBjbGFzcyB0cnkgYXNzaWduaW5nIHRoZSBwcm90b3R5cGUgb24gdGhlIGZ1bmN0aW9uIGFzIGEgd29ya2Fyb3VuZC4gYCVzLnByb3RvdHlwZSA9IFJlYWN0LkNvbXBvbmVudC5wcm90b3R5cGVgLiBEb24ndCB1c2UgYW4gYXJyb3cgZnVuY3Rpb24gc2luY2UgaXQgY2Fubm90IGJlIGNhbGxlZCB3aXRoIGBuZXdgIGJ5IFJlYWN0LiIsIF9jb21wb25lbnROYW1lLCBfY29tcG9uZW50TmFtZSwgX2NvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TW9kdWxlUGF0dGVybkNvbXBvbmVudFtfY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKAogICAgICAgICAgICAvLyBSdW4gdGhlc2UgY2hlY2tzIGluIHByb2R1Y3Rpb24gb25seSBpZiB0aGUgZmxhZyBpcyBvZmYuCiAgICAgICAgICAgIC8vIEV2ZW50dWFsbHkgd2UnbGwgZGVsZXRlIHRoaXMgYnJhbmNoIGFsdG9nZXRoZXIuCiAgICAgICAgICAgIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlLnJlbmRlciA9PT0gImZ1bmN0aW9uIiAmJiB2YWx1ZS4kJHR5cGVvZiA9PT0gdm9pZCAwCiAgICAgICAgICApIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZTIgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRNb2R1bGVQYXR0ZXJuQ29tcG9uZW50W19jb21wb25lbnROYW1lMl0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgPCVzIC8+IGNvbXBvbmVudCBhcHBlYXJzIHRvIGJlIGEgZnVuY3Rpb24gY29tcG9uZW50IHRoYXQgcmV0dXJucyBhIGNsYXNzIGluc3RhbmNlLiBDaGFuZ2UgJXMgdG8gYSBjbGFzcyB0aGF0IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50IGluc3RlYWQuIElmIHlvdSBjYW4ndCB1c2UgYSBjbGFzcyB0cnkgYXNzaWduaW5nIHRoZSBwcm90b3R5cGUgb24gdGhlIGZ1bmN0aW9uIGFzIGEgd29ya2Fyb3VuZC4gYCVzLnByb3RvdHlwZSA9IFJlYWN0LkNvbXBvbmVudC5wcm90b3R5cGVgLiBEb24ndCB1c2UgYW4gYXJyb3cgZnVuY3Rpb24gc2luY2UgaXQgY2Fubm90IGJlIGNhbGxlZCB3aXRoIGBuZXdgIGJ5IFJlYWN0LiIsIF9jb21wb25lbnROYW1lMiwgX2NvbXBvbmVudE5hbWUyLCBfY29tcG9uZW50TmFtZTIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TW9kdWxlUGF0dGVybkNvbXBvbmVudFtfY29tcG9uZW50TmFtZTJdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRhZyA9IENsYXNzQ29tcG9uZW50OwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBoYXNDb250ZXh0ID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgaGFzQ29udGV4dCA9IHRydWU7CiAgICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGhhc0NvbnRleHQgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IHZhbHVlLnN0YXRlICE9PSBudWxsICYmIHZhbHVlLnN0YXRlICE9PSB2b2lkIDAgPyB2YWx1ZS5zdGF0ZSA6IG51bGw7CiAgICAgICAgICAgIGluaXRpYWxpemVVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICBhZG9wdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCB2YWx1ZSk7CiAgICAgICAgICAgIG1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiBmaW5pc2hDbGFzc0NvbXBvbmVudChudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSwgaGFzQ29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50YWcgPSBGdW5jdGlvbkNvbXBvbmVudDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgdmFsdWUgPSByZW5kZXJXaXRoSG9va3MobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHByb3BzLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyhmYWxzZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpICYmIGhhc0lkKSB7CiAgICAgICAgICAgICAgcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKG51bGwsIHdvcmtJblByb2dyZXNzMiwgdmFsdWUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YWxpZGF0ZUZ1bmN0aW9uQ29tcG9uZW50SW5EZXYod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlRnVuY3Rpb25Db21wb25lbnRJbkRldih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgaWYgKENvbXBvbmVudC5jaGlsZENvbnRleHRUeXBlcykgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IGNoaWxkQ29udGV4dFR5cGVzIGNhbm5vdCBiZSBkZWZpbmVkIG9uIGEgZnVuY3Rpb24gY29tcG9uZW50LiIsIENvbXBvbmVudC5kaXNwbGF5TmFtZSB8fCBDb21wb25lbnQubmFtZSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIucmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgICB2YXIgb3duZXJOYW1lID0gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKTsKICAgICAgICAgICAgICBpZiAob3duZXJOYW1lKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9ICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBvd25lck5hbWUgKyAiYC4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IG93bmVyTmFtZSB8fCAiIjsKICAgICAgICAgICAgICB2YXIgZGVidWdTb3VyY2UgPSB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnU291cmNlOwogICAgICAgICAgICAgIGlmIChkZWJ1Z1NvdXJjZSkgewogICAgICAgICAgICAgICAgd2FybmluZ0tleSA9IGRlYnVnU291cmNlLmZpbGVOYW1lICsgIjoiICsgZGVidWdTb3VyY2UubGluZU51bWJlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRGdW5jdGlvblJlZnNbd2FybmluZ0tleV0pIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEZ1bmN0aW9uUmVmc1t3YXJuaW5nS2V5XSA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgYmUgZ2l2ZW4gcmVmcy4gQXR0ZW1wdHMgdG8gYWNjZXNzIHRoaXMgcmVmIHdpbGwgZmFpbC4gRGlkIHlvdSBtZWFuIHRvIHVzZSBSZWFjdC5mb3J3YXJkUmVmKCk/JXMiLCBpbmZvKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKENvbXBvbmVudC5kZWZhdWx0UHJvcHMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudFtjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBTdXBwb3J0IGZvciBkZWZhdWx0UHJvcHMgd2lsbCBiZSByZW1vdmVkIGZyb20gZnVuY3Rpb24gY29tcG9uZW50cyBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBVc2UgSmF2YVNjcmlwdCBkZWZhdWx0IHBhcmFtZXRlcnMgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnRbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIENvbXBvbmVudC5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUzID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0R2V0RGVyaXZlZFN0YXRlT25GdW5jdGlvbkNvbXBvbmVudFtfY29tcG9uZW50TmFtZTNdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IEZ1bmN0aW9uIGNvbXBvbmVudHMgZG8gbm90IHN1cHBvcnQgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiIsIF9jb21wb25lbnROYW1lMyk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50W19jb21wb25lbnROYW1lM10gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIENvbXBvbmVudC5jb250ZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgQ29tcG9uZW50LmNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIF9jb21wb25lbnROYW1lNCA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dENvbnRleHRUeXBlT25GdW5jdGlvbkNvbXBvbmVudFtfY29tcG9uZW50TmFtZTRdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IEZ1bmN0aW9uIGNvbXBvbmVudHMgZG8gbm90IHN1cHBvcnQgY29udGV4dFR5cGUuIiwgX2NvbXBvbmVudE5hbWU0KTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dENvbnRleHRUeXBlT25GdW5jdGlvbkNvbXBvbmVudFtfY29tcG9uZW50TmFtZTRdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFNVU1BFTkRFRF9NQVJLRVIgPSB7CiAgICAgICAgICBkZWh5ZHJhdGVkOiBudWxsLAogICAgICAgICAgdHJlZUNvbnRleHQ6IG51bGwsCiAgICAgICAgICByZXRyeUxhbmU6IE5vTGFuZQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgYmFzZUxhbmVzOiByZW5kZXJMYW5lczIsCiAgICAgICAgICAgIGNhY2hlUG9vbDogZ2V0U3VzcGVuZGVkQ2FjaGUoKSwKICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocHJldk9mZnNjcmVlblN0YXRlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBjYWNoZVBvb2wgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgYmFzZUxhbmVzOiBtZXJnZUxhbmVzKHByZXZPZmZzY3JlZW5TdGF0ZS5iYXNlTGFuZXMsIHJlbmRlckxhbmVzMiksCiAgICAgICAgICAgIGNhY2hlUG9vbCwKICAgICAgICAgICAgdHJhbnNpdGlvbnM6IHByZXZPZmZzY3JlZW5TdGF0ZS50cmFuc2l0aW9ucwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkUmVtYWluT25GYWxsYmFjayhzdXNwZW5zZUNvbnRleHQsIGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBoYXNTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSZW1haW5pbmdXb3JrSW5QcmltYXJ5VHJlZShjdXJyZW50NCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXR1cm4gcmVtb3ZlTGFuZXMoY3VycmVudDQuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHNob3VsZFN1c3BlbmQod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3VzcGVuc2VDb250ZXh0ID0gc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgdmFyIHNob3dGYWxsYmFjayA9IGZhbHNlOwogICAgICAgICAgdmFyIGRpZFN1c3BlbmQgPSAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoZGlkU3VzcGVuZCB8fCBzaG91bGRSZW1haW5PbkZhbGxiYWNrKHN1c3BlbnNlQ29udGV4dCwgY3VycmVudDQpKSB7CiAgICAgICAgICAgIHNob3dGYWxsYmFjayA9IHRydWU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+RGlkQ2FwdHVyZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC5tZW1vaXplZFN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gYWRkU3VidHJlZVN1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEludmlzaWJsZVBhcmVudFN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgdHJ5VG9DbGFpbU5leHRIeWRyYXRhYmxlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZGVoeWRyYXRlZCA9IHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgICBpZiAoZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVoeWRyYXRlZFN1c3BlbnNlQ29tcG9uZW50KHdvcmtJblByb2dyZXNzMiwgZGVoeWRyYXRlZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZXh0UHJpbWFyeUNoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICB2YXIgbmV4dEZhbGxiYWNrQ2hpbGRyZW4gPSBuZXh0UHJvcHMuZmFsbGJhY2s7CiAgICAgICAgICAgIGlmIChzaG93RmFsbGJhY2spIHsKICAgICAgICAgICAgICB2YXIgZmFsbGJhY2tGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgbmV4dFByaW1hcnlDaGlsZHJlbiwgbmV4dEZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50Lm1lbW9pemVkU3RhdGUgPSBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IFNVU1BFTkRFRF9NQVJLRVI7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbGxiYWNrRnJhZ21lbnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJpbWFyeUNoaWxkcmVuKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgX2RlaHlkcmF0ZWQgPSBwcmV2U3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgICBpZiAoX2RlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWh5ZHJhdGVkU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgZGlkU3VzcGVuZCwgbmV4dFByb3BzLCBfZGVoeWRyYXRlZCwgcHJldlN0YXRlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvd0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0RmFsbGJhY2tDaGlsZHJlbiA9IG5leHRQcm9wcy5mYWxsYmFjazsKICAgICAgICAgICAgICB2YXIgX25leHRQcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IHVwZGF0ZVN1c3BlbnNlRmFsbGJhY2tDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBfbmV4dFByaW1hcnlDaGlsZHJlbiwgX25leHRGYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQyID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3RhdGUgPSBjdXJyZW50NC5jaGlsZC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDIubWVtb2l6ZWRTdGF0ZSA9IHByZXZPZmZzY3JlZW5TdGF0ZSA9PT0gbnVsbCA/IG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpIDogdXBkYXRlU3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShwcmV2T2Zmc2NyZWVuU3RhdGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgX3ByaW1hcnlDaGlsZEZyYWdtZW50Mi5jaGlsZExhbmVzID0gZ2V0UmVtYWluaW5nV29ya0luUHJpbWFyeVRyZWUoY3VycmVudDQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBTVVNQRU5ERURfTUFSS0VSOwogICAgICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0UHJpbWFyeUNoaWxkcmVuMiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50MyA9IHVwZGF0ZVN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIF9uZXh0UHJpbWFyeUNoaWxkcmVuMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdXNwZW5zZVByaW1hcnlDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IHdvcmtJblByb2dyZXNzMi5tb2RlOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAidmlzaWJsZSIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIocHJpbWFyeUNoaWxkUHJvcHMsIG1vZGUpOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCBmYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBtb2RlID0gd29ya0luUHJvZ3Jlc3MyLm1vZGU7CiAgICAgICAgICB2YXIgcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRQcm9wcyA9IHsKICAgICAgICAgICAgbW9kZTogImhpZGRlbiIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgaWYgKChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQ7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmNoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5wZW5kaW5nUHJvcHMgPSBwcmltYXJ5Q2hpbGRQcm9wczsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuYWN0dWFsU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2VsZkJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZmFsbGJhY2tDaGlsZHJlbiwgbW9kZSwgcmVuZGVyTGFuZXMyLCBudWxsKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gbW91bnRXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKHByaW1hcnlDaGlsZFByb3BzLCBtb2RlKTsKICAgICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZmFsbGJhY2tDaGlsZHJlbiwgbW9kZSwgcmVuZGVyTGFuZXMyLCBudWxsKTsKICAgICAgICAgIH0KICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICByZXR1cm4gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIob2Zmc2NyZWVuUHJvcHMsIG1vZGUsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbU9mZnNjcmVlbihvZmZzY3JlZW5Qcm9wcywgbW9kZSwgTm9MYW5lcywgbnVsbCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIoY3VycmVudDQsIG9mZnNjcmVlblByb3BzKSB7CiAgICAgICAgICByZXR1cm4gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudDQsIG9mZnNjcmVlblByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgIHZhciBjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmc7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCwgewogICAgICAgICAgICBtb2RlOiAidmlzaWJsZSIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgIH0pOwogICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmxhbmVzID0gcmVuZGVyTGFuZXMyOwogICAgICAgICAgfQogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZyA9IG51bGw7CiAgICAgICAgICBpZiAoY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9uczsKICAgICAgICAgICAgaWYgKGRlbGV0aW9ucyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBbY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudF07CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IENoaWxkRGVsZXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGVsZXRpb25zLnB1c2goY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCBmYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBtb2RlID0gd29ya0luUHJvZ3Jlc3MyLm1vZGU7CiAgICAgICAgICB2YXIgY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50ID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICB2YXIgY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZFByb3BzID0gewogICAgICAgICAgICBtb2RlOiAiaGlkZGVuIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgLy8gSW4gbGVnYWN5IG1vZGUsIHdlIGNvbW1pdCB0aGUgcHJpbWFyeSB0cmVlIGFzIGlmIGl0IHN1Y2Nlc3NmdWxseQogICAgICAgICAgICAvLyBjb21wbGV0ZWQsIGV2ZW4gdGhvdWdoIGl0J3MgaW4gYW4gaW5jb25zaXN0ZW50IHN0YXRlLgogICAgICAgICAgICAobW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmIC8vIE1ha2Ugc3VyZSB3ZSdyZSBvbiB0aGUgc2Vjb25kIHBhc3MsIGkuZS4gdGhlIHByaW1hcnkgY2hpbGQgZnJhZ21lbnQgd2FzCiAgICAgICAgICAgIC8vIGFscmVhZHkgY2xvbmVkLiBJbiBsZWdhY3kgbW9kZSwgdGhlIG9ubHkgY2FzZSB3aGVyZSB0aGlzIGlzbid0IHRydWUgaXMKICAgICAgICAgICAgLy8gd2hlbiBEZXZUb29scyBmb3JjZXMgdXMgdG8gZGlzcGxheSBhIGZhbGxiYWNrOyB3ZSBza2lwIHRoZSBmaXJzdCByZW5kZXIKICAgICAgICAgICAgLy8gcGFzcyBlbnRpcmVseSBhbmQgZ28gc3RyYWlnaHQgdG8gcmVuZGVyaW5nIHRoZSBmYWxsYmFjay4gKEluIENvbmN1cnJlbnQKICAgICAgICAgICAgLy8gTW9kZSwgU3VzcGVuc2VMaXN0IGNhbiBhbHNvIHRyaWdnZXIgdGhpcyBzY2VuYXJpbywgYnV0IHRoaXMgaXMgYSBsZWdhY3ktCiAgICAgICAgICAgIC8vIG9ubHkgY29kZXBhdGguKQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgIT09IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudAogICAgICAgICAgKSB7CiAgICAgICAgICAgIHZhciBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQ7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmNoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5wZW5kaW5nUHJvcHMgPSBwcmltYXJ5Q2hpbGRQcm9wczsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5hY3R1YWxEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuYWN0dWFsU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2VsZkJhc2VEdXJhdGlvbiA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb24gPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQsIHByaW1hcnlDaGlsZFByb3BzKTsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc3VidHJlZUZsYWdzID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnN1YnRyZWVGbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgaWYgKGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCwgZmFsbGJhY2tDaGlsZHJlbik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBtb2RlLCByZW5kZXJMYW5lczIsIG51bGwpOwogICAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgfQogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJldHJ5U3VzcGVuc2VDb21wb25lbnRXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMiwgcmVjb3ZlcmFibGVFcnJvcikgewogICAgICAgICAgaWYgKHJlY292ZXJhYmxlRXJyb3IgIT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWVIeWRyYXRpb25FcnJvcihyZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgY3VycmVudDQuY2hpbGQsIG51bGwsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuKTsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgIHJldHVybiBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTdXNwZW5zZUZhbGxiYWNrQWZ0ZXJSZXRyeVdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcHJpbWFyeUNoaWxkcmVuLCBmYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBmaWJlck1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRQcm9wcyA9IHsKICAgICAgICAgICAgbW9kZTogInZpc2libGUiLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gbW91bnRXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKHByaW1hcnlDaGlsZFByb3BzLCBmaWJlck1vZGUpOwogICAgICAgICAgdmFyIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGZhbGxiYWNrQ2hpbGRyZW4sIGZpYmVyTW9kZSwgcmVuZGVyTGFuZXMyLCBudWxsKTsKICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZyA9IGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgY3VycmVudDQuY2hpbGQsIG51bGwsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudERlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlSW5zdGFuY2UsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiQ2Fubm90IGh5ZHJhdGUgU3VzcGVuc2UgaW4gbGVnYWN5IG1vZGUuIFN3aXRjaCBmcm9tIFJlYWN0RE9NLmh5ZHJhdGUoZWxlbWVudCwgY29udGFpbmVyKSB0byBSZWFjdERPTUNsaWVudC5oeWRyYXRlUm9vdChjb250YWluZXIsIDxBcHAgLz4pLnJlbmRlcihlbGVtZW50KSBvciByZW1vdmUgdGhlIFN1c3BlbnNlIGNvbXBvbmVudHMgZnJvbSB0aGUgc2VydmVyIHJlbmRlcmVkIGNvbXBvbmVudHMuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbGFuZVRvTGFuZXMoU3luY0xhbmUpOwogICAgICAgICAgfSBlbHNlIGlmIChpc1N1c3BlbnNlSW5zdGFuY2VGYWxsYmFjayhzdXNwZW5zZUluc3RhbmNlKSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBsYW5lVG9MYW5lcyhEZWZhdWx0SHlkcmF0aW9uTGFuZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBsYW5lVG9MYW5lcyhPZmZzY3JlZW5MYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVEZWh5ZHJhdGVkU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgZGlkU3VzcGVuZCwgbmV4dFByb3BzLCBzdXNwZW5zZUluc3RhbmNlLCBzdXNwZW5zZVN0YXRlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmICghZGlkU3VzcGVuZCkgewogICAgICAgICAgICB3YXJuSWZIeWRyYXRpbmcoKTsKICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJldHJ5U3VzcGVuc2VDb21wb25lbnRXaXRob3V0SHlkcmF0aW5nKAogICAgICAgICAgICAgICAgY3VycmVudDQsCiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICByZW5kZXJMYW5lczIsCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBXaGVuIHdlIGRlbGV0ZSBsZWdhY3kgbW9kZSwgd2Ugc2hvdWxkIG1ha2UgdGhpcyBlcnJvciBhcmd1bWVudAogICAgICAgICAgICAgICAgLy8gcmVxdWlyZWQg4oCUIGV2ZXJ5IGNvbmN1cnJlbnQgbW9kZSBwYXRoIHRoYXQgY2F1c2VzIGh5ZHJhdGlvbiB0bwogICAgICAgICAgICAgICAgLy8gZGUtb3B0IHRvIGNsaWVudCByZW5kZXJpbmcgc2hvdWxkIGhhdmUgYW4gZXJyb3IgbWVzc2FnZS4KICAgICAgICAgICAgICAgIG51bGwKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc1N1c3BlbnNlSW5zdGFuY2VGYWxsYmFjayhzdXNwZW5zZUluc3RhbmNlKSkgewogICAgICAgICAgICAgIHZhciBkaWdlc3QsIG1lc3NhZ2UsIHN0YWNrOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBfZ2V0U3VzcGVuc2VJbnN0YW5jZUYgPSBnZXRTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2tFcnJvckRldGFpbHMoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBkaWdlc3QgPSBfZ2V0U3VzcGVuc2VJbnN0YW5jZUYuZGlnZXN0OwogICAgICAgICAgICAgICAgbWVzc2FnZSA9IF9nZXRTdXNwZW5zZUluc3RhbmNlRi5tZXNzYWdlOwogICAgICAgICAgICAgICAgc3RhY2sgPSBfZ2V0U3VzcGVuc2VJbnN0YW5jZUYuc3RhY2s7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBlcnJvcjI7CiAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UpIHsKICAgICAgICAgICAgICAgIGVycm9yMiA9IG5ldyBFcnJvcihtZXNzYWdlKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKCJUaGUgc2VydmVyIGNvdWxkIG5vdCBmaW5pc2ggdGhpcyBTdXNwZW5zZSBib3VuZGFyeSwgbGlrZWx5IGR1ZSB0byBhbiBlcnJvciBkdXJpbmcgc2VydmVyIHJlbmRlcmluZy4gU3dpdGNoZWQgdG8gY2xpZW50IHJlbmRlcmluZy4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNhcHR1cmVkVmFsdWUgPSBjcmVhdGVDYXB0dXJlZFZhbHVlKGVycm9yMiwgZGlnZXN0LCBzdGFjayk7CiAgICAgICAgICAgICAgcmV0dXJuIHJldHJ5U3VzcGVuc2VDb21wb25lbnRXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMiwgY2FwdHVyZWRWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc0NvbnRleHRDaGFuZ2VkMiA9IGluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCBjdXJyZW50NC5jaGlsZExhbmVzKTsKICAgICAgICAgICAgaWYgKGRpZFJlY2VpdmVVcGRhdGUgfHwgaGFzQ29udGV4dENoYW5nZWQyKSB7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSA9IGdldEJ1bXBlZExhbmVGb3JIeWRyYXRpb24ocm9vdDMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICBpZiAoYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSAhPT0gTm9MYW5lICYmIGF0dGVtcHRIeWRyYXRpb25BdExhbmUgIT09IHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lKSB7CiAgICAgICAgICAgICAgICAgIHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lID0gYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZTsKICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICAgICAgICBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoY3VycmVudDQsIGF0dGVtcHRIeWRyYXRpb25BdExhbmUpOwogICAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGN1cnJlbnQ0LCBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCk7CiAgICAgICAgICAgICAgdmFyIF9jYXB0dXJlZFZhbHVlID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZShuZXcgRXJyb3IoIlRoaXMgU3VzcGVuc2UgYm91bmRhcnkgcmVjZWl2ZWQgYW4gdXBkYXRlIGJlZm9yZSBpdCBmaW5pc2hlZCBoeWRyYXRpbmcuIFRoaXMgY2F1c2VkIHRoZSBib3VuZGFyeSB0byBzd2l0Y2ggdG8gY2xpZW50IHJlbmRlcmluZy4gVGhlIHVzdWFsIHdheSB0byBmaXggdGhpcyBpcyB0byB3cmFwIHRoZSBvcmlnaW5hbCB1cGRhdGUgaW4gc3RhcnRUcmFuc2l0aW9uLiIpKTsKICAgICAgICAgICAgICByZXR1cm4gcmV0cnlTdXNwZW5zZUNvbXBvbmVudFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyLCBfY2FwdHVyZWRWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNTdXNwZW5zZUluc3RhbmNlUGVuZGluZyhzdXNwZW5zZUluc3RhbmNlKSkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgICAgIHZhciByZXRyeSA9IHJldHJ5RGVoeWRyYXRlZFN1c3BlbnNlQm91bmRhcnkuYmluZChudWxsLCBjdXJyZW50NCk7CiAgICAgICAgICAgICAgcmVnaXN0ZXJTdXNwZW5zZUluc3RhbmNlUmV0cnkoc3VzcGVuc2VJbnN0YW5jZSwgcmV0cnkpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlZW50ZXJIeWRyYXRpb25TdGF0ZUZyb21EZWh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlSW5zdGFuY2UsIHN1c3BlbnNlU3RhdGUudHJlZUNvbnRleHQpOwogICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gbW91bnRTdXNwZW5zZVByaW1hcnlDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbik7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuZmxhZ3MgfD0gSHlkcmF0aW5nOwogICAgICAgICAgICAgIHJldHVybiBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmNlQ2xpZW50UmVuZGVyKSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IH5Gb3JjZUNsaWVudFJlbmRlcjsKICAgICAgICAgICAgICB2YXIgX2NhcHR1cmVkVmFsdWUyID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZShuZXcgRXJyb3IoIlRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBoeWRyYXRpbmcgdGhpcyBTdXNwZW5zZSBib3VuZGFyeS4gU3dpdGNoZWQgdG8gY2xpZW50IHJlbmRlcmluZy4iKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJldHJ5U3VzcGVuc2VDb21wb25lbnRXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMiwgX2NhcHR1cmVkVmFsdWUyKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBuZXh0UHJpbWFyeUNoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBuZXh0RmFsbGJhY2tDaGlsZHJlbiA9IG5leHRQcm9wcy5mYWxsYmFjazsKICAgICAgICAgICAgICB2YXIgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gbW91bnRTdXNwZW5zZUZhbGxiYWNrQWZ0ZXJSZXRyeVdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dFByaW1hcnlDaGlsZHJlbiwgbmV4dEZhbGxiYWNrQ2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgdmFyIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgX3ByaW1hcnlDaGlsZEZyYWdtZW50NC5tZW1vaXplZFN0YXRlID0gbW91bnRTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBTVVNQRU5ERURfTUFSS0VSOwogICAgICAgICAgICAgIHJldHVybiBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVTdXNwZW5zZVdvcmtPbkZpYmVyKGZpYmVyLCByZW5kZXJMYW5lczIsIHByb3BhZ2F0aW9uUm9vdCkgewogICAgICAgICAgZmliZXIubGFuZXMgPSBtZXJnZUxhbmVzKGZpYmVyLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgYWx0ZXJuYXRlLmxhbmVzID0gbWVyZ2VMYW5lcyhhbHRlcm5hdGUubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICBzY2hlZHVsZUNvbnRleHRXb3JrT25QYXJlbnRQYXRoKGZpYmVyLnJldHVybiwgcmVuZGVyTGFuZXMyLCBwcm9wYWdhdGlvblJvb3QpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9wYWdhdGVTdXNwZW5zZUNvbnRleHRDaGFuZ2Uod29ya0luUHJvZ3Jlc3MyLCBmaXJzdENoaWxkLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBub2RlID0gZmlyc3RDaGlsZDsKICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgc3RhdGUgPSBub2RlLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVN1c3BlbnNlV29ya09uRmliZXIobm9kZSwgcmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VMaXN0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVTdXNwZW5zZVdvcmtPbkZpYmVyKG5vZGUsIHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLmNoaWxkOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlID09PSB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRMYXN0Q29udGVudFJvdyhmaXJzdENoaWxkKSB7CiAgICAgICAgICB2YXIgcm93ID0gZmlyc3RDaGlsZDsKICAgICAgICAgIHZhciBsYXN0Q29udGVudFJvdyA9IG51bGw7CiAgICAgICAgICB3aGlsZSAocm93ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Um93ID0gcm93LmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnRSb3cgIT09IG51bGwgJiYgZmluZEZpcnN0U3VzcGVuZGVkKGN1cnJlbnRSb3cpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgbGFzdENvbnRlbnRSb3cgPSByb3c7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcm93ID0gcm93LnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFzdENvbnRlbnRSb3c7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUmV2ZWFsT3JkZXIocmV2ZWFsT3JkZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJldmVhbE9yZGVyICE9PSB2b2lkIDAgJiYgcmV2ZWFsT3JkZXIgIT09ICJmb3J3YXJkcyIgJiYgcmV2ZWFsT3JkZXIgIT09ICJiYWNrd2FyZHMiICYmIHJldmVhbE9yZGVyICE9PSAidG9nZXRoZXIiICYmICFkaWRXYXJuQWJvdXRSZXZlYWxPcmRlcltyZXZlYWxPcmRlcl0pIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRSZXZlYWxPcmRlcltyZXZlYWxPcmRlcl0gPSB0cnVlOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV2ZWFsT3JkZXIgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBzd2l0Y2ggKHJldmVhbE9yZGVyLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAgICAgICAgICAgY2FzZSAidG9nZXRoZXIiOgogICAgICAgICAgICAgICAgICBjYXNlICJmb3J3YXJkcyI6CiAgICAgICAgICAgICAgICAgIGNhc2UgImJhY2t3YXJkcyI6IHsKICAgICAgICAgICAgICAgICAgICBlcnJvcignIiVzIiBpcyBub3QgYSB2YWxpZCB2YWx1ZSBmb3IgcmV2ZWFsT3JkZXIgb24gPFN1c3BlbnNlTGlzdCAvPi4gVXNlIGxvd2VyY2FzZSAiJXMiIGluc3RlYWQuJywgcmV2ZWFsT3JkZXIsIHJldmVhbE9yZGVyLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNhc2UgImZvcndhcmQiOgogICAgICAgICAgICAgICAgICBjYXNlICJiYWNrd2FyZCI6IHsKICAgICAgICAgICAgICAgICAgICBlcnJvcignIiVzIiBpcyBub3QgYSB2YWxpZCB2YWx1ZSBmb3IgcmV2ZWFsT3JkZXIgb24gPFN1c3BlbnNlTGlzdCAvPi4gUmVhY3QgdXNlcyB0aGUgLXMgc3VmZml4IGluIHRoZSBzcGVsbGluZy4gVXNlICIlc3MiIGluc3RlYWQuJywgcmV2ZWFsT3JkZXIsIHJldmVhbE9yZGVyLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoJyIlcyIgaXMgbm90IGEgc3VwcG9ydGVkIHJldmVhbE9yZGVyIG9uIDxTdXNwZW5zZUxpc3QgLz4uIERpZCB5b3UgbWVhbiAidG9nZXRoZXIiLCAiZm9yd2FyZHMiIG9yICJiYWNrd2FyZHMiPycsIHJldmVhbE9yZGVyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXJyb3IoJyVzIGlzIG5vdCBhIHN1cHBvcnRlZCB2YWx1ZSBmb3IgcmV2ZWFsT3JkZXIgb24gPFN1c3BlbnNlTGlzdCAvPi4gRGlkIHlvdSBtZWFuICJ0b2dldGhlciIsICJmb3J3YXJkcyIgb3IgImJhY2t3YXJkcyI/JywgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVRhaWxPcHRpb25zKHRhaWxNb2RlLCByZXZlYWxPcmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodGFpbE1vZGUgIT09IHZvaWQgMCAmJiAhZGlkV2FybkFib3V0VGFpbE9wdGlvbnNbdGFpbE1vZGVdKSB7CiAgICAgICAgICAgICAgaWYgKHRhaWxNb2RlICE9PSAiY29sbGFwc2VkIiAmJiB0YWlsTW9kZSAhPT0gImhpZGRlbiIpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zW3RhaWxNb2RlXSA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcignIiVzIiBpcyBub3QgYSBzdXBwb3J0ZWQgdmFsdWUgZm9yIHRhaWwgb24gPFN1c3BlbnNlTGlzdCAvPi4gRGlkIHlvdSBtZWFuICJjb2xsYXBzZWQiIG9yICJoaWRkZW4iPycsIHRhaWxNb2RlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJldmVhbE9yZGVyICE9PSAiZm9yd2FyZHMiICYmIHJldmVhbE9yZGVyICE9PSAiYmFja3dhcmRzIikgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VGFpbE9wdGlvbnNbdGFpbE1vZGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCc8U3VzcGVuc2VMaXN0IHRhaWw9IiVzIiAvPiBpcyBvbmx5IHZhbGlkIGlmIHJldmVhbE9yZGVyIGlzICJmb3J3YXJkcyIgb3IgImJhY2t3YXJkcyIuIERpZCB5b3UgbWVhbiB0byBzcGVjaWZ5IHJldmVhbE9yZGVyPSJmb3J3YXJkcyI/JywgdGFpbE1vZGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVN1c3BlbnNlTGlzdE5lc3RlZENoaWxkKGNoaWxkU2xvdCwgaW5kZXgyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpc0FuQXJyYXkgPSBpc0FycmF5MihjaGlsZFNsb3QpOwogICAgICAgICAgICB2YXIgaXNJdGVyYWJsZSA9ICFpc0FuQXJyYXkgJiYgdHlwZW9mIGdldEl0ZXJhdG9yRm4oY2hpbGRTbG90KSA9PT0gImZ1bmN0aW9uIjsKICAgICAgICAgICAgaWYgKGlzQW5BcnJheSB8fCBpc0l0ZXJhYmxlKSB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSBpc0FuQXJyYXkgPyAiYXJyYXkiIDogIml0ZXJhYmxlIjsKICAgICAgICAgICAgICBlcnJvcigiQSBuZXN0ZWQgJXMgd2FzIHBhc3NlZCB0byByb3cgIyVzIGluIDxTdXNwZW5zZUxpc3QgLz4uIFdyYXAgaXQgaW4gYW4gYWRkaXRpb25hbCBTdXNwZW5zZUxpc3QgdG8gY29uZmlndXJlIGl0cyByZXZlYWxPcmRlcjogPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0uLi4+IC4uLiA8U3VzcGVuc2VMaXN0IHJldmVhbE9yZGVyPS4uLj57JXN9PC9TdXNwZW5zZUxpc3Q+IC4uLiA8L1N1c3BlbnNlTGlzdD4iLCB0eXBlLCBpbmRleDIsIHR5cGUpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlU3VzcGVuc2VMaXN0Q2hpbGRyZW4oY2hpbGRyZW4sIHJldmVhbE9yZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICgocmV2ZWFsT3JkZXIgPT09ICJmb3J3YXJkcyIgfHwgcmV2ZWFsT3JkZXIgPT09ICJiYWNrd2FyZHMiKSAmJiBjaGlsZHJlbiAhPT0gdm9pZCAwICYmIGNoaWxkcmVuICE9PSBudWxsICYmIGNoaWxkcmVuICE9PSBmYWxzZSkgewogICAgICAgICAgICAgIGlmIChpc0FycmF5MihjaGlsZHJlbikpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZVN1c3BlbnNlTGlzdE5lc3RlZENoaWxkKGNoaWxkcmVuW2ldLCBpKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4oY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjaGlsZHJlbkl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKGNoaWxkcmVuKTsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkcmVuSXRlcmF0b3IpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RlcCA9IGNoaWxkcmVuSXRlcmF0b3IubmV4dCgpOwogICAgICAgICAgICAgICAgICAgIHZhciBfaSA9IDA7CiAgICAgICAgICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IHN0ZXAgPSBjaGlsZHJlbkl0ZXJhdG9yLm5leHQoKSkgewogICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZVN1c3BlbnNlTGlzdE5lc3RlZENoaWxkKHN0ZXAudmFsdWUsIF9pKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBfaSsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoJ0Egc2luZ2xlIHJvdyB3YXMgcGFzc2VkIHRvIGEgPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0iJXMiIC8+LiBUaGlzIGlzIG5vdCB1c2VmdWwgc2luY2UgaXQgbmVlZHMgbXVsdGlwbGUgcm93cy4gRGlkIHlvdSBtZWFuIHRvIHBhc3MgbXVsdGlwbGUgY2hpbGRyZW4gb3IgYW4gYXJyYXk/JywgcmV2ZWFsT3JkZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUod29ya0luUHJvZ3Jlc3MyLCBpc0JhY2t3YXJkcywgdGFpbCwgbGFzdENvbnRlbnRSb3csIHRhaWxNb2RlKSB7CiAgICAgICAgICB2YXIgcmVuZGVyU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IHsKICAgICAgICAgICAgICBpc0JhY2t3YXJkcywKICAgICAgICAgICAgICByZW5kZXJpbmc6IG51bGwsCiAgICAgICAgICAgICAgcmVuZGVyaW5nU3RhcnRUaW1lOiAwLAogICAgICAgICAgICAgIGxhc3Q6IGxhc3RDb250ZW50Um93LAogICAgICAgICAgICAgIHRhaWwsCiAgICAgICAgICAgICAgdGFpbE1vZGUKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLmlzQmFja3dhcmRzID0gaXNCYWNrd2FyZHM7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZyA9IG51bGw7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZ1N0YXJ0VGltZSA9IDA7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLmxhc3QgPSBsYXN0Q29udGVudFJvdzsKICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IHRhaWw7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWxNb2RlID0gdGFpbE1vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHJldmVhbE9yZGVyID0gbmV4dFByb3BzLnJldmVhbE9yZGVyOwogICAgICAgICAgdmFyIHRhaWxNb2RlID0gbmV4dFByb3BzLnRhaWw7CiAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW4gPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB2YWxpZGF0ZVJldmVhbE9yZGVyKHJldmVhbE9yZGVyKTsKICAgICAgICAgIHZhbGlkYXRlVGFpbE9wdGlvbnModGFpbE1vZGUsIHJldmVhbE9yZGVyKTsKICAgICAgICAgIHZhbGlkYXRlU3VzcGVuc2VMaXN0Q2hpbGRyZW4obmV3Q2hpbGRyZW4sIHJldmVhbE9yZGVyKTsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5ld0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIHN1c3BlbnNlQ29udGV4dCA9IHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIHZhciBzaG91bGRGb3JjZUZhbGxiYWNrID0gaGFzU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgRm9yY2VTdXNwZW5zZUZhbGxiYWNrKTsKICAgICAgICAgIGlmIChzaG91bGRGb3JjZUZhbGxiYWNrKSB7CiAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kQmVmb3JlID0gY3VycmVudDQgIT09IG51bGwgJiYgKGN1cnJlbnQ0LmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kQmVmb3JlKSB7CiAgICAgICAgICAgICAgcHJvcGFnYXRlU3VzcGVuc2VDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzd2l0Y2ggKHJldmVhbE9yZGVyKSB7CiAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZHMiOiB7CiAgICAgICAgICAgICAgICB2YXIgbGFzdENvbnRlbnRSb3cgPSBmaW5kTGFzdENvbnRlbnRSb3cod29ya0luUHJvZ3Jlc3MyLmNoaWxkKTsKICAgICAgICAgICAgICAgIHZhciB0YWlsOwogICAgICAgICAgICAgICAgaWYgKGxhc3RDb250ZW50Um93ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRhaWwgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0YWlsID0gbGFzdENvbnRlbnRSb3cuc2libGluZzsKICAgICAgICAgICAgICAgICAgbGFzdENvbnRlbnRSb3cuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbml0U3VzcGVuc2VMaXN0UmVuZGVyU3RhdGUoCiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiwKICAgICAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgICAgIC8vIGlzQmFja3dhcmRzCiAgICAgICAgICAgICAgICAgIHRhaWwsCiAgICAgICAgICAgICAgICAgIGxhc3RDb250ZW50Um93LAogICAgICAgICAgICAgICAgICB0YWlsTW9kZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlICJiYWNrd2FyZHMiOiB7CiAgICAgICAgICAgICAgICB2YXIgX3RhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIHJvdyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICB3aGlsZSAocm93ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50Um93ID0gcm93LmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRSb3cgIT09IG51bGwgJiYgZmluZEZpcnN0U3VzcGVuZGVkKGN1cnJlbnRSb3cpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcm93OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBuZXh0Um93ID0gcm93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIHJvdy5zaWJsaW5nID0gX3RhaWw7CiAgICAgICAgICAgICAgICAgIF90YWlsID0gcm93OwogICAgICAgICAgICAgICAgICByb3cgPSBuZXh0Um93OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgICAgICAgIC8vIGlzQmFja3dhcmRzCiAgICAgICAgICAgICAgICAgIF90YWlsLAogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAvLyBsYXN0CiAgICAgICAgICAgICAgICAgIHRhaWxNb2RlCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgInRvZ2V0aGVyIjogewogICAgICAgICAgICAgICAgaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgICAgICAvLyBpc0JhY2t3YXJkcwogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAvLyB0YWlsCiAgICAgICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgICAgIC8vIGxhc3QKICAgICAgICAgICAgICAgICAgdm9pZCAwCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcnRhbENvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW4gPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbnVsbCwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdOb1ZhbHVlUHJvcE9uQ29udGV4dFByb3ZpZGVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ29udGV4dFByb3ZpZGVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIHByb3ZpZGVyVHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgdmFyIGNvbnRleHQgPSBwcm92aWRlclR5cGUuX2NvbnRleHQ7CiAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIG9sZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBuZXdQcm9wcy52YWx1ZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCEoInZhbHVlIiBpbiBuZXdQcm9wcykpIHsKICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdOb1ZhbHVlUHJvcE9uQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nTm9WYWx1ZVByb3BPbkNvbnRleHRQcm92aWRlciA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGB2YWx1ZWAgcHJvcCBpcyByZXF1aXJlZCBmb3IgdGhlIGA8Q29udGV4dC5Qcm92aWRlcj5gLiBEaWQgeW91IG1pc3NwZWxsIGl0IG9yIGZvcmdldCB0byBwYXNzIGl0PyIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvdmlkZXJQcm9wVHlwZXMgPSB3b3JrSW5Qcm9ncmVzczIudHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIGlmIChwcm92aWRlclByb3BUeXBlcykgewogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKHByb3ZpZGVyUHJvcFR5cGVzLCBuZXdQcm9wcywgInByb3AiLCAiQ29udGV4dC5Qcm92aWRlciIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwdXNoUHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCBuZXdWYWx1ZSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBvbGRWYWx1ZSA9IG9sZFByb3BzLnZhbHVlOwogICAgICAgICAgICAgIGlmIChvYmplY3RJcyhvbGRWYWx1ZSwgbmV3VmFsdWUpKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkUHJvcHMuY2hpbGRyZW4gPT09IG5ld1Byb3BzLmNoaWxkcmVuICYmICFoYXNDb250ZXh0Q2hhbmdlZCgpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2Uod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXdDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nQ29udGV4dEFzQ29uc3VtZXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb250ZXh0Q29uc3VtZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGV4dC5fY29udGV4dCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKGNvbnRleHQgIT09IGNvbnRleHQuQ29uc3VtZXIpIHsKICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXRVc2luZ0NvbnRleHRBc0NvbnN1bWVyKSB7CiAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdDb250ZXh0QXNDb25zdW1lciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZW5kZXJpbmcgPENvbnRleHQ+IGRpcmVjdGx5IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gcmVuZGVyIDxDb250ZXh0LkNvbnN1bWVyPiBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dC5fY29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciByZW5kZXIyID0gbmV3UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVuZGVyMiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJBIGNvbnRleHQgY29uc3VtZXIgd2FzIHJlbmRlcmVkIHdpdGggbXVsdGlwbGUgY2hpbGRyZW4sIG9yIGEgY2hpbGQgdGhhdCBpc24ndCBhIGZ1bmN0aW9uLiBBIGNvbnRleHQgY29uc3VtZXIgZXhwZWN0cyBhIHNpbmdsZSBjaGlsZCB0aGF0IGlzIGEgZnVuY3Rpb24uIElmIHlvdSBkaWQgcGFzcyBhIGZ1bmN0aW9uLCBtYWtlIHN1cmUgdGhlcmUgaXMgbm8gdHJhaWxpbmcgb3IgbGVhZGluZyB3aGl0ZXNwYWNlIGFyb3VuZCBpdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIG5ld1ZhbHVlID0gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2hpbGRyZW47CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIG5ld0NoaWxkcmVuID0gcmVuZGVyMihuZXdWYWx1ZSk7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV3Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpIHsKICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjdXJyZW50NC5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudDQuZGVwZW5kZW5jaWVzOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZygpOwogICAgICAgICAgfQogICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMpOwogICAgICAgICAgaWYgKCFpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMpKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY2xvbmVDaGlsZEZpYmVycyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbW91bnRGaWJlcihjdXJyZW50NCwgb2xkV29ya0luUHJvZ3Jlc3MsIG5ld1dvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IG9sZFdvcmtJblByb2dyZXNzLnJldHVybjsKICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgc3dhcCB0aGUgcm9vdCBmaWJlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50NC5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBvbGRXb3JrSW5Qcm9ncmVzcy5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5pbmRleCA9IG9sZFdvcmtJblByb2dyZXNzLmluZGV4OwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5zaWJsaW5nID0gb2xkV29ya0luUHJvZ3Jlc3Muc2libGluZzsKICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MucmV0dXJuID0gb2xkV29ya0luUHJvZ3Jlc3MucmV0dXJuOwogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5yZWYgPSBvbGRXb3JrSW5Qcm9ncmVzcy5yZWY7CiAgICAgICAgICAgIGlmIChvbGRXb3JrSW5Qcm9ncmVzcyA9PT0gcmV0dXJuRmliZXIuY2hpbGQpIHsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5jaGlsZCA9IG5ld1dvcmtJblByb2dyZXNzOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBwcmV2U2libGluZyA9IHJldHVybkZpYmVyLmNoaWxkOwogICAgICAgICAgICAgIGlmIChwcmV2U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBwYXJlbnQgdG8gaGF2ZSBhIGNoaWxkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAocHJldlNpYmxpbmcuc2libGluZyAhPT0gb2xkV29ya0luUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgICAgIHByZXZTaWJsaW5nID0gcHJldlNpYmxpbmcuc2libGluZzsKICAgICAgICAgICAgICAgIGlmIChwcmV2U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgdGhlIHByZXZpb3VzIHNpYmxpbmcuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByZXZTaWJsaW5nLnNpYmxpbmcgPSBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcmV0dXJuRmliZXIuZGVsZXRpb25zOwogICAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gW2N1cnJlbnQ0XTsKICAgICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBDaGlsZERlbGV0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGN1cnJlbnQ0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdXb3JrSW5Qcm9ncmVzcy5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgIHJldHVybiBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIHVwZGF0ZUxhbmVzID0gY3VycmVudDQubGFuZXM7CiAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZSh1cGRhdGVMYW5lcywgcmVuZGVyTGFuZXMyKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdEVhcmx5QmFpbG91dElmTm9TY2hlZHVsZWRVcGRhdGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICBwdXNoSG9zdFJvb3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICBwdXNoSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcHVzaEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjogewogICAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzLnZhbHVlOwogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcHVzaFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgbmV3VmFsdWUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIGhhc0NoaWxkV29yayA9IGluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICAgICAgICBzdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZExhbmVzID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQuY2hpbGRMYW5lczsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgcHJpbWFyeUNoaWxkTGFuZXMpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldERlZmF1bHRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCkpOwogICAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgZGlkU3VzcGVuZEJlZm9yZSA9IChjdXJyZW50NC5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIHZhciBfaGFzQ2hpbGRXb3JrID0gaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzKTsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEJlZm9yZSkgewogICAgICAgICAgICAgICAgaWYgKF9oYXNDaGlsZFdvcmspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN1c3BlbnNlTGlzdENvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciByZW5kZXJTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUubGFzdEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgICAgIGlmIChfaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU9mZnNjcmVlbkNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiZWdpbldvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuX2RlYnVnTmVlZHNSZW1vdW50ICYmIGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlbW91bnRGaWJlcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHMod29ya0luUHJvZ3Jlc3MyLnR5cGUsIHdvcmtJblByb2dyZXNzMi5rZXksIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMsIHdvcmtJblByb2dyZXNzMi5fZGVidWdPd25lciB8fCBudWxsLCB3b3JrSW5Qcm9ncmVzczIubW9kZSwgd29ya0luUHJvZ3Jlc3MyLmxhbmVzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgb2xkUHJvcHMgPSBjdXJyZW50NC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICBpZiAob2xkUHJvcHMgIT09IG5ld1Byb3BzIHx8IGhhc0NvbnRleHRDaGFuZ2VkKCkgfHwgLy8gRm9yY2UgYSByZS1yZW5kZXIgaWYgdGhlIGltcGxlbWVudGF0aW9uIGNoYW5nZWQgZHVlIHRvIGhvdCByZWxvYWQ6CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlICE9PSBjdXJyZW50NC50eXBlKSB7CiAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCA9IGNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQ0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIGlmICghaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0ICYmIC8vIElmIHRoaXMgaXMgdGhlIHNlY29uZCBwYXNzIG9mIGFuIGVycm9yIG9yIHN1c3BlbnNlIGJvdW5kYXJ5LCB0aGVyZQogICAgICAgICAgICAgIC8vIG1heSBub3QgYmUgd29yayBzY2hlZHVsZWQgb24gYGN1cnJlbnRgLCBzbyB3ZSBjaGVjayBmb3IgdGhpcyBmbGFnLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgcmV0dXJuIGF0dGVtcHRFYXJseUJhaWxvdXRJZk5vU2NoZWR1bGVkVXBkYXRlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgoY3VycmVudDQuZmxhZ3MgJiBGb3JjZVVwZGF0ZUZvckxlZ2FjeVN1c3BlbnNlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgZGlkUmVjZWl2ZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaXNGb3JrZWRDaGlsZCh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgdmFyIHNsb3RJbmRleCA9IHdvcmtJblByb2dyZXNzMi5pbmRleDsKICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZGb3JrcyA9IGdldEZvcmtzQXRMZXZlbCgpOwogICAgICAgICAgICAgIHB1c2hUcmVlSWQod29ya0luUHJvZ3Jlc3MyLCBudW1iZXJPZkZvcmtzLCBzbG90SW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBtb3VudEluZGV0ZXJtaW5hdGVDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnR5cGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExhenlDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgZWxlbWVudFR5cGUsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgdW5yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgcmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA9PT0gQ29tcG9uZW50ID8gdW5yZXNvbHZlZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wczIoQ29tcG9uZW50LCB1bnJlc29sdmVkUHJvcHMpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGdW5jdGlvbkNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBfQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciBfcmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA9PT0gX0NvbXBvbmVudCA/IF91bnJlc29sdmVkUHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzMihfQ29tcG9uZW50LCBfdW5yZXNvbHZlZFByb3BzKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ2xhc3NDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgX0NvbXBvbmVudCwgX3Jlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSG9zdFJvb3QoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVIb3N0Q29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUhvc3RUZXh0KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVBvcnRhbENvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOiB7CiAgICAgICAgICAgICAgdmFyIHR5cGUgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wczIgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciBfcmVzb2x2ZWRQcm9wczIgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPT09IHR5cGUgPyBfdW5yZXNvbHZlZFByb3BzMiA6IHJlc29sdmVEZWZhdWx0UHJvcHMyKHR5cGUsIF91bnJlc29sdmVkUHJvcHMyKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRm9yd2FyZFJlZihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBfcmVzb2x2ZWRQcm9wczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBGcmFnbWVudDk6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZyYWdtZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgTW9kZToKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTW9kZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQcm9maWxlcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ29udGV4dFByb3ZpZGVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVDb250ZXh0Q29uc3VtZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF90eXBlMiA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIHZhciBfdW5yZXNvbHZlZFByb3BzMyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIF9yZXNvbHZlZFByb3BzMyA9IHJlc29sdmVEZWZhdWx0UHJvcHMyKF90eXBlMiwgX3VucmVzb2x2ZWRQcm9wczMpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBvdXRlclByb3BUeXBlcyA9IF90eXBlMi5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICAgICAgb3V0ZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgICAgICBfcmVzb2x2ZWRQcm9wczMsCiAgICAgICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBmb3Igb3V0ZXIgb25seQogICAgICAgICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKF90eXBlMikKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIF9yZXNvbHZlZFByb3BzMyA9IHJlc29sdmVEZWZhdWx0UHJvcHMyKF90eXBlMi50eXBlLCBfcmVzb2x2ZWRQcm9wczMpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIF90eXBlMiwgX3Jlc29sdmVkUHJvcHMzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTaW1wbGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi50eXBlLCB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQyID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHM0ID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHM0ID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSBfQ29tcG9uZW50MiA/IF91bnJlc29sdmVkUHJvcHM0IDogcmVzb2x2ZURlZmF1bHRQcm9wczIoX0NvbXBvbmVudDIsIF91bnJlc29sdmVkUHJvcHM0KTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgX0NvbXBvbmVudDIsIF9yZXNvbHZlZFByb3BzNCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUxpc3RDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlT2Zmc2NyZWVuQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biB1bml0IG9mIHdvcmsgdGFnICgiICsgd29ya0luUHJvZ3Jlc3MyLnRhZyArICIpLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlZiQxKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFJlZjI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBSZWZTdGF0aWM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBhcHBlbmRBbGxDaGlsZHJlbjsKICAgICAgICB2YXIgdXBkYXRlSG9zdENvbnRhaW5lcjsKICAgICAgICB2YXIgdXBkYXRlSG9zdENvbXBvbmVudCQxOwogICAgICAgIHZhciB1cGRhdGVIb3N0VGV4dCQxOwogICAgICAgIHsKICAgICAgICAgIGFwcGVuZEFsbENoaWxkcmVuID0gZnVuY3Rpb24ocGFyZW50LCB3b3JrSW5Qcm9ncmVzczIsIG5lZWRzVmlzaWJpbGl0eVRvZ2dsZSwgaXNIaWRkZW4pIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgYXBwZW5kSW5pdGlhbENoaWxkKHBhcmVudCwgbm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgICAgICBlbHNlIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVIb3N0Q29udGFpbmVyID0gZnVuY3Rpb24oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgfTsKICAgICAgICAgIHVwZGF0ZUhvc3RDb21wb25lbnQkMSA9IGZ1bmN0aW9uKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpIHsKICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgaWYgKG9sZFByb3BzID09PSBuZXdQcm9wcykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgY3VycmVudEhvc3RDb250ZXh0ID0gZ2V0SG9zdENvbnRleHQoKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBwcmVwYXJlVXBkYXRlKGluc3RhbmNlLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgY3VycmVudEhvc3RDb250ZXh0KTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gdXBkYXRlUGF5bG9hZDsKICAgICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQpIHsKICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVIb3N0VGV4dCQxID0gZnVuY3Rpb24oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgb2xkVGV4dCwgbmV3VGV4dCkgewogICAgICAgICAgICBpZiAob2xkVGV4dCAhPT0gbmV3VGV4dCkgewogICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3V0T2ZmVGFpbElmTmVlZGVkKHJlbmRlclN0YXRlLCBoYXNSZW5kZXJlZEFUYWlsRmFsbGJhY2spIHsKICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAocmVuZGVyU3RhdGUudGFpbE1vZGUpIHsKICAgICAgICAgICAgY2FzZSAiaGlkZGVuIjogewogICAgICAgICAgICAgIHZhciB0YWlsTm9kZSA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgdmFyIGxhc3RUYWlsTm9kZSA9IG51bGw7CiAgICAgICAgICAgICAgd2hpbGUgKHRhaWxOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodGFpbE5vZGUuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxhc3RUYWlsTm9kZSA9IHRhaWxOb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFpbE5vZGUgPSB0YWlsTm9kZS5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobGFzdFRhaWxOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGFzdFRhaWxOb2RlLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJjb2xsYXBzZWQiOiB7CiAgICAgICAgICAgICAgdmFyIF90YWlsTm9kZSA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgdmFyIF9sYXN0VGFpbE5vZGUgPSBudWxsOwogICAgICAgICAgICAgIHdoaWxlIChfdGFpbE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChfdGFpbE5vZGUuYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIF9sYXN0VGFpbE5vZGUgPSBfdGFpbE5vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfdGFpbE5vZGUgPSBfdGFpbE5vZGUuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKF9sYXN0VGFpbE5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICghaGFzUmVuZGVyZWRBVGFpbEZhbGxiYWNrICYmIHJlbmRlclN0YXRlLnRhaWwgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBfbGFzdFRhaWxOb2RlLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBidWJibGVQcm9wZXJ0aWVzKGNvbXBsZXRlZFdvcmspIHsKICAgICAgICAgIHZhciBkaWRCYWlsb3V0ID0gY29tcGxldGVkV29yay5hbHRlcm5hdGUgIT09IG51bGwgJiYgY29tcGxldGVkV29yay5hbHRlcm5hdGUuY2hpbGQgPT09IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICB2YXIgbmV3Q2hpbGRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB2YXIgc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgIGlmICghZGlkQmFpbG91dCkgewogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgdmFyIGFjdHVhbER1cmF0aW9uID0gY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICB2YXIgdHJlZUJhc2VEdXJhdGlvbiA9IGNvbXBsZXRlZFdvcmsuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhjaGlsZC5sYW5lcywgY2hpbGQuY2hpbGRMYW5lcykpOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IGNoaWxkLnN1YnRyZWVGbGFnczsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBjaGlsZC5mbGFnczsKICAgICAgICAgICAgICAgIGFjdHVhbER1cmF0aW9uICs9IGNoaWxkLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgICAgdHJlZUJhc2VEdXJhdGlvbiArPSBjaGlsZC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21wbGV0ZWRXb3JrLmFjdHVhbER1cmF0aW9uID0gYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgY29tcGxldGVkV29yay50cmVlQmFzZUR1cmF0aW9uID0gdHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2NoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBuZXdDaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhuZXdDaGlsZExhbmVzLCBtZXJnZUxhbmVzKF9jaGlsZC5sYW5lcywgX2NoaWxkLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQuc3VidHJlZUZsYWdzOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZC5mbGFnczsKICAgICAgICAgICAgICAgIF9jaGlsZC5yZXR1cm4gPSBjb21wbGV0ZWRXb3JrOwogICAgICAgICAgICAgICAgX2NoaWxkID0gX2NoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuc3VidHJlZUZsYWdzIHw9IHN1YnRyZWVGbGFnczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICB2YXIgX3RyZWVCYXNlRHVyYXRpb24gPSBjb21wbGV0ZWRXb3JrLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgdmFyIF9jaGlsZDIgPSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChfY2hpbGQyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBuZXdDaGlsZExhbmVzID0gbWVyZ2VMYW5lcyhuZXdDaGlsZExhbmVzLCBtZXJnZUxhbmVzKF9jaGlsZDIubGFuZXMsIF9jaGlsZDIuY2hpbGRMYW5lcykpOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDIuc3VidHJlZUZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQyLmZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgICAgICAgIF90cmVlQmFzZUR1cmF0aW9uICs9IF9jaGlsZDIudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgIF9jaGlsZDIgPSBfY2hpbGQyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsudHJlZUJhc2VEdXJhdGlvbiA9IF90cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfY2hpbGQzID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkMyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQzLmxhbmVzLCBfY2hpbGQzLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQzLnN1YnRyZWVGbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMy5mbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBfY2hpbGQzLnJldHVybiA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICAgICAgICBfY2hpbGQzID0gX2NoaWxkMy5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnN1YnRyZWVGbGFncyB8PSBzdWJ0cmVlRmxhZ3M7CiAgICAgICAgICB9CiAgICAgICAgICBjb21wbGV0ZWRXb3JrLmNoaWxkTGFuZXMgPSBuZXdDaGlsZExhbmVzOwogICAgICAgICAgcmV0dXJuIGRpZEJhaWxvdXQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlRGVoeWRyYXRlZFN1c3BlbnNlQm91bmRhcnkoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dFN0YXRlKSB7CiAgICAgICAgICBpZiAoaGFzVW5oeWRyYXRlZFRhaWxOb2RlcygpICYmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlICYmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICB3YXJuSWZVbmh5ZHJhdGVkVGFpbE5vZGVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyIHwgSW5jb21wbGV0ZSB8IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB3YXNIeWRyYXRlZCA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBpZiAobmV4dFN0YXRlICE9PSBudWxsICYmIG5leHRTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmICghd2FzSHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQSBkZWh5ZHJhdGVkIHN1c3BlbnNlIGNvbXBvbmVudCB3YXMgY29tcGxldGVkIHdpdGhvdXQgYSBoeWRyYXRlZCBub2RlLiBUaGlzIGlzIHByb2JhYmx5IGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmVwYXJlVG9IeWRyYXRlSG9zdFN1c3BlbnNlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBpc1RpbWVkT3V0U3VzcGVuc2UgPSBuZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICAgIGlmIChpc1RpbWVkT3V0U3VzcGVuc2UpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByaW1hcnlDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiAtPSBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZSgpOwogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfaXNUaW1lZE91dFN1c3BlbnNlID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoX2lzVGltZWRPdXRTdXNwZW5zZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9wcmltYXJ5Q2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gLT0gX3ByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBsZXRlV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBuZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMYXp5Q29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgIGNhc2UgRnJhZ21lbnQ5OgogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgIGNhc2UgQ29udGV4dENvbnN1bWVyOgogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIENvbXBvbmVudCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyUm9vdCA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIGlmIChmaWJlclJvb3QucGVuZGluZ0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIGZpYmVyUm9vdC5jb250ZXh0ID0gZmliZXJSb290LnBlbmRpbmdDb250ZXh0OwogICAgICAgICAgICAgICAgZmliZXJSb290LnBlbmRpbmdDb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IGN1cnJlbnQ0LmNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgd2FzSHlkcmF0ZWQgPSBwb3BIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgaWYgKHdhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIHRoaXMgaXMgYSBjbGllbnQgcm9vdAogICAgICAgICAgICAgICAgICAgICAgIXByZXZTdGF0ZS5pc0RlaHlkcmF0ZWQgfHwgLy8gQ2hlY2sgaWYgd2UgcmV2ZXJ0ZWQgdG8gY2xpZW50IHJlbmRlcmluZyAoZS5nLiBkdWUgdG8gYW4gZXJyb3IpCiAgICAgICAgICAgICAgICAgICAgICAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpICE9PSBOb0ZsYWdzCiAgICAgICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgICAgICAgICB1cGdyYWRlSHlkcmF0aW9uRXJyb3JzVG9SZWNvdmVyYWJsZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB1cGRhdGVIb3N0Q29udGFpbmVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciByb290Q29udGFpbmVySW5zdGFuY2UgPSBnZXRSb290SG9zdENvbnRhaW5lcigpOwogICAgICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbXBvbmVudCQxKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0LnJlZiAhPT0gd29ya0luUHJvZ3Jlc3MyLnJlZikgewogICAgICAgICAgICAgICAgICBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFuZXdQcm9wcykgewogICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2UgbXVzdCBoYXZlIG5ldyBwcm9wcyBmb3IgbmV3IG1vdW50cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgICAgICB2YXIgX3dhc0h5ZHJhdGVkID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmIChfd2FzSHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgICAgaWYgKHByZXBhcmVUb0h5ZHJhdGVIb3N0SW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCkpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGNyZWF0ZUluc3RhbmNlKHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgYXBwZW5kQWxsQ2hpbGRyZW4oaW5zdGFuY2UsIHdvcmtJblByb2dyZXNzMiwgZmFsc2UsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGluc3RhbmNlOwogICAgICAgICAgICAgICAgICBpZiAoZmluYWxpemVJbml0aWFsQ2hpbGRyZW4oaW5zdGFuY2UsIHR5cGUsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBtYXJrUmVmJDEod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB2YXIgbmV3VGV4dCA9IG5ld1Byb3BzOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAmJiB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBvbGRUZXh0ID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvc3RUZXh0JDEoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgb2xkVGV4dCwgbmV3VGV4dCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3VGV4dCAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlIG11c3QgaGF2ZSBuZXcgcHJvcHMgZm9yIG5ldyBtb3VudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBfcm9vdENvbnRhaW5lckluc3RhbmNlID0gZ2V0Um9vdEhvc3RDb250YWluZXIoKTsKICAgICAgICAgICAgICAgIHZhciBfY3VycmVudEhvc3RDb250ZXh0ID0gZ2V0SG9zdENvbnRleHQoKTsKICAgICAgICAgICAgICAgIHZhciBfd2FzSHlkcmF0ZWQyID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmIChfd2FzSHlkcmF0ZWQyKSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcmVwYXJlVG9IeWRyYXRlSG9zdFRleHRJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gY3JlYXRlVGV4dEluc3RhbmNlKG5ld1RleHQsIF9yb290Q29udGFpbmVySW5zdGFuY2UsIF9jdXJyZW50SG9zdENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIG5leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC5tZW1vaXplZFN0YXRlICE9PSBudWxsICYmIGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGZhbGx0aHJvdWdoVG9Ob3JtYWxTdXNwZW5zZVBhdGggPSBjb21wbGV0ZURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRTdGF0ZSk7CiAgICAgICAgICAgICAgICBpZiAoIWZhbGx0aHJvdWdoVG9Ob3JtYWxTdXNwZW5zZVBhdGgpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIFNob3VsZENhcHR1cmUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB0cmFuc2ZlckFjdHVhbER1cmF0aW9uKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbmV4dERpZFRpbWVvdXQgPSBuZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgdmFyIHByZXZEaWRUaW1lb3V0ID0gY3VycmVudDQgIT09IG51bGwgJiYgY3VycmVudDQubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQgIT09IHByZXZEaWRUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9vZmZzY3JlZW5GaWJlcjIgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIF9vZmZzY3JlZW5GaWJlcjIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhhc0ludmlzaWJsZUNoaWxkQ29udGV4dCA9IGN1cnJlbnQ0ID09PSBudWxsICYmICh3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcy51bnN0YWJsZV9hdm9pZFRoaXNGYWxsYmFjayAhPT0gdHJ1ZSB8fCAhZW5hYmxlU3VzcGVuc2VBdm9pZFRoaXNGYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0ludmlzaWJsZUNoaWxkQ29udGV4dCB8fCBoYXNTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50LCBJbnZpc2libGVQYXJlbnRTdXNwZW5zZUNvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdha2VhYmxlcyA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBpZiAod2FrZWFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXh0RGlkVGltZW91dCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICBpZiAocHJpbWFyeUNoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uIC09IHByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHByZXBhcmVQb3J0YWxNb3VudCh3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF9Db21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoX0NvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgdmFyIHJlbmRlclN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmRBbHJlYWR5ID0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIHZhciByZW5kZXJlZFRhaWwgPSByZW5kZXJTdGF0ZS5yZW5kZXJpbmc7CiAgICAgICAgICAgICAgaWYgKHJlbmRlcmVkVGFpbCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTdXNwZW5kQWxyZWFkeSkgewogICAgICAgICAgICAgICAgICB2YXIgY2Fubm90QmVTdXNwZW5kZWQgPSByZW5kZXJIYXNOb3RTdXNwZW5kZWRZZXQoKSAmJiAoY3VycmVudDQgPT09IG51bGwgfHwgKGN1cnJlbnQ0LmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpOwogICAgICAgICAgICAgICAgICBpZiAoIWNhbm5vdEJlU3VzcGVuZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJvdyA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAocm93ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgc3VzcGVuZGVkID0gZmluZEZpcnN0U3VzcGVuZGVkKHJvdyk7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3VzcGVuZGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VGhlbmFibGVzID0gc3VzcGVuZGVkLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3VGhlbmFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbmV3VGhlbmFibGVzOwogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc2V0Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjaykpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgcm93ID0gcm93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsICYmIG5vdygpID4gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgZGlkU3VzcGVuZEFscmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IFNvbWVSZXRyeUxhbmU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFN1c3BlbmRBbHJlYWR5KSB7CiAgICAgICAgICAgICAgICAgIHZhciBfc3VzcGVuZGVkID0gZmluZEZpcnN0U3VzcGVuZGVkKHJlbmRlcmVkVGFpbCk7CiAgICAgICAgICAgICAgICAgIGlmIChfc3VzcGVuZGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgICAgZGlkU3VzcGVuZEFscmVhZHkgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHZhciBfbmV3VGhlbmFibGVzID0gX3N1c3BlbmRlZC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoX25ld1RoZW5hYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gX25ld1RoZW5hYmxlczsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlLnRhaWwgPT09IG51bGwgJiYgcmVuZGVyU3RhdGUudGFpbE1vZGUgPT09ICJoaWRkZW4iICYmICFyZW5kZXJlZFRhaWwuYWx0ZXJuYXRlICYmICFnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHRpbWUgaXQgdG9vayB0byByZW5kZXIgbGFzdCByb3cgaXMgZ3JlYXRlciB0aGFuIHRoZSByZW1haW5pbmcKICAgICAgICAgICAgICAgICAgICAvLyB0aW1lIHdlIGhhdmUgdG8gcmVuZGVyLiBTbyByZW5kZXJpbmcgb25lIG1vcmUgcm93IHdvdWxkIGxpa2VseQogICAgICAgICAgICAgICAgICAgIC8vIGV4Y2VlZCBpdC4KICAgICAgICAgICAgICAgICAgICBub3coKSAqIDIgLSByZW5kZXJTdGF0ZS5yZW5kZXJpbmdTdGFydFRpbWUgPiBnZXRSZW5kZXJUYXJnZXRUaW1lKCkgJiYgcmVuZGVyTGFuZXMyICE9PSBPZmZzY3JlZW5MYW5lCiAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBTb21lUmV0cnlMYW5lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUuaXNCYWNrd2FyZHMpIHsKICAgICAgICAgICAgICAgICAgcmVuZGVyZWRUYWlsLnNpYmxpbmcgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlbmRlcmVkVGFpbDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c1NpYmxpbmcgPSByZW5kZXJTdGF0ZS5sYXN0OwogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNTaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNTaWJsaW5nLnNpYmxpbmcgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLmxhc3QgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IHJlbmRlclN0YXRlLnRhaWw7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmcgPSBuZXh0OwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IG5leHQuc2libGluZzsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZ1N0YXJ0VGltZSA9IG5vdygpOwogICAgICAgICAgICAgICAgbmV4dC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZUNvbnRleHQgPSBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEFscmVhZHkpIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV4dDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBfbmV4dFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgdmFyIG5leHRJc0hpZGRlbiA9IF9uZXh0U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgX3ByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgcHJldklzSGlkZGVuID0gX3ByZXZTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChwcmV2SXNIaWRkZW4gIT09IG5leHRJc0hpZGRlbiAmJiAvLyBMZWdhY3lIaWRkZW4gZG9lc24ndCBkbyBhbnkgaGlkaW5nIOKAlCBpdCBvbmx5IHByZS1yZW5kZXJzLgogICAgICAgICAgICAgICAgIWVuYWJsZUxlZ2FjeUhpZGRlbikgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFuZXh0SXNIaWRkZW4gfHwgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUoc3VidHJlZVJlbmRlckxhbmVzLCBPZmZzY3JlZW5MYW5lKSkgewogICAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyAmIChQbGFjZW1lbnQgfCBVcGRhdGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVmlzaWJpbGl0eTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgVHJhY2luZ01hcmtlckNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gdW5pdCBvZiB3b3JrIHRhZyAoIiArIHdvcmtJblByb2dyZXNzMi50YWcgKyAiKS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW53aW5kV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHBvcFRyZWVDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcG9wQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgU2hvdWxkQ2FwdHVyZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJhbnNmZXJBY3R1YWxEdXJhdGlvbih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIHZhciBfZmxhZ3MgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKChfZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSAhPT0gTm9GbGFncyAmJiAoX2ZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IF9mbGFncyAmIH5TaG91bGRDYXB0dXJlIHwgRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcEhvc3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgIT09IG51bGwgJiYgc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRocmV3IGluIG5ld2x5IG1vdW50ZWQgZGVoeWRyYXRlZCBjb21wb25lbnQuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIF9mbGFnczIgPSB3b3JrSW5Qcm9ncmVzczIuZmxhZ3M7CiAgICAgICAgICAgICAgaWYgKF9mbGFnczIgJiBTaG91bGRDYXB0dXJlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBfZmxhZ3MyICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24od29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDb250ZXh0UHJvdmlkZXI6CiAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZS5fY29udGV4dDsKICAgICAgICAgICAgICBwb3BQcm92aWRlcihjb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW53aW5kSW50ZXJydXB0ZWRXb3JrKGN1cnJlbnQ0LCBpbnRlcnJ1cHRlZFdvcmssIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcG9wVHJlZUNvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgIHN3aXRjaCAoaW50ZXJydXB0ZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dFR5cGVzID0gaW50ZXJydXB0ZWRXb3JrLnR5cGUuY2hpbGRDb250ZXh0VHlwZXM7CiAgICAgICAgICAgICAgaWYgKGNoaWxkQ29udGV4dFR5cGVzICE9PSBudWxsICYmIGNoaWxkQ29udGV4dFR5cGVzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IGludGVycnVwdGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcihpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIHBvcFRvcExldmVsQ29udGV4dE9iamVjdChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIHJlc2V0V29ya0luUHJvZ3Jlc3NWZXJzaW9ucygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcEhvc3RDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICBwb3BTdXNwZW5zZUNvbnRleHQoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gaW50ZXJydXB0ZWRXb3JrLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFJlbmRlckxhbmVzKGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbmRlZmluZWRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkU25hcHNob3RCZWZvcmVVcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgIH0KICAgICAgICB2YXIgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBmYWxzZTsKICAgICAgICB2YXIgUG9zc2libHlXZWFrU2V0ID0gdHlwZW9mIFdlYWtTZXQgPT09ICJmdW5jdGlvbiIgPyBXZWFrU2V0IDogU2V0OwogICAgICAgIHZhciBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICB2YXIgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICB2YXIgaW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlcG9ydFVuY2F1Z2h0RXJyb3JJbkRFVihlcnJvcjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrKG51bGwsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNhbGxDb21wb25lbnRXaWxsVW5tb3VudFdpdGhUaW1lciA9IGZ1bmN0aW9uKGN1cnJlbnQ0LCBpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UucHJvcHMgPSBjdXJyZW50NC5tZW1vaXplZFByb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKGN1cnJlbnQ0Lm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsVW5tb3VudCgpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGN1cnJlbnQ0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQoKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxDb21taXRIb29rTGF5b3V0RWZmZWN0TGlzdE1vdW50KGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KExheW91dCwgY3VycmVudDQpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsQ29tcG9uZW50V2lsbFVubW91bnQoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGluc3RhbmNlKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFVubW91bnRXaXRoVGltZXIoY3VycmVudDQsIGluc3RhbmNlKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5Q2FsbENvbXBvbmVudERpZE1vdW50KGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBpbnN0YW5jZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5QXR0YWNoUmVmKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb21taXRBdHRhY2hSZWYoY3VycmVudDQpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlEZXRhY2hSZWYoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHZhciByZWYgPSBjdXJyZW50NC5yZWY7CiAgICAgICAgICBpZiAocmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHJldFZhbDsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaWYgKGVuYWJsZVByb2ZpbGVyVGltZXIgJiYgZW5hYmxlUHJvZmlsZXJDb21taXRIb29rcyAmJiBjdXJyZW50NC5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0VmFsID0gcmVmKG51bGwpOwogICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGN1cnJlbnQ0KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmV0VmFsID0gcmVmKG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV0VmFsID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIHJldHVybiB2YWx1ZSBmcm9tIGEgY2FsbGJhY2sgcmVmIGluICVzLiBBIGNhbGxiYWNrIHJlZiBzaG91bGQgbm90IHJldHVybiBhIGZ1bmN0aW9uLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoY3VycmVudDQpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVmLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxEZXN0cm95KGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBkZXN0cm95KCk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBudWxsOwogICAgICAgIHZhciBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIGZvY3VzZWRJbnN0YW5jZUhhbmRsZSA9IHByZXBhcmVGb3JDb21taXQocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c19iZWdpbigpOwogICAgICAgICAgdmFyIHNob3VsZEZpcmUgPSBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXI7CiAgICAgICAgICBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIgPSBmYWxzZTsKICAgICAgICAgIGZvY3VzZWRJbnN0YW5jZUhhbmRsZSA9IG51bGw7CiAgICAgICAgICByZXR1cm4gc2hvdWxkRmlyZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2JlZ2luKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmICgoZmliZXIuc3VidHJlZUZsYWdzICYgQmVmb3JlTXV0YXRpb25NYXNrKSAhPT0gTm9GbGFncyAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfY29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfY29tcGxldGUoKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c09uRmliZXIoZmliZXIpOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICB2YXIgZmxhZ3MgPSBmaW5pc2hlZFdvcmsuZmxhZ3M7CiAgICAgICAgICBpZiAoKGZsYWdzICYgU25hcHNob3QpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50NC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBwcm9wcyB0byBtYXRjaCBtZW1vaXplZCBwcm9wcyBiZWZvcmUgZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMucHJvcHNgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBzdGF0ZSB0byBtYXRjaCBtZW1vaXplZCBzdGF0ZSBiZWZvcmUgZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMuc3RhdGVgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBzbmFwc2hvdCA9IGluc3RhbmNlLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlKGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSA9PT0gZmluaXNoZWRXb3JrLnR5cGUgPyBwcmV2UHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzMihmaW5pc2hlZFdvcmsudHlwZSwgcHJldlByb3BzKSwgcHJldlN0YXRlKTsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBkaWRXYXJuU2V0ID0gZGlkV2FybkFib3V0VW5kZWZpbmVkU25hcHNob3RCZWZvcmVVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNuYXBzaG90ID09PSB2b2lkIDAgJiYgIWRpZFdhcm5TZXQuaGFzKGZpbmlzaGVkV29yay50eXBlKSkgewogICAgICAgICAgICAgICAgICAgICAgZGlkV2FyblNldC5hZGQoZmluaXNoZWRXb3JrLnR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzLmdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCk6IEEgc25hcHNob3QgdmFsdWUgKG9yIG51bGwpIG11c3QgYmUgcmV0dXJuZWQuIFlvdSBoYXZlIHJldHVybmVkIHVuZGVmaW5lZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9IHNuYXBzaG90OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgY2xlYXJDb250YWluZXIocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6CiAgICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIGNhc2UgSW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHVuaXQgb2Ygd29yayB0YWcgc2hvdWxkIG5vdCBoYXZlIHNpZGUtZWZmZWN0cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KGZsYWdzLCBmaW5pc2hlZFdvcmssIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUgIT09IG51bGwgPyB1cGRhdGVRdWV1ZS5sYXN0RWZmZWN0IDogbnVsbDsKICAgICAgICAgIGlmIChsYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYgKChlZmZlY3QudGFnICYgZmxhZ3MpID09PSBmbGFncykgewogICAgICAgICAgICAgICAgdmFyIGRlc3Ryb3kgPSBlZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgICAgIGVmZmVjdC5kZXN0cm95ID0gdm9pZCAwOwogICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIFBhc3NpdmUkMSkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZChmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGZsYWdzICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIHNldElzUnVubmluZ0luc2VydGlvbkVmZmVjdCh0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbERlc3Ryb3koZmluaXNoZWRXb3JrLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KTsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIHNldElzUnVubmluZ0luc2VydGlvbkVmZmVjdChmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlZmZlY3QgPSBlZmZlY3QubmV4dDsKICAgICAgICAgICAgfSB3aGlsZSAoZWZmZWN0ICE9PSBmaXJzdEVmZmVjdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoZmxhZ3MsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGxhc3RFZmZlY3QgPSB1cGRhdGVRdWV1ZSAhPT0gbnVsbCA/IHVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgOiBudWxsOwogICAgICAgICAgaWYgKGxhc3RFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpcnN0RWZmZWN0ID0gbGFzdEVmZmVjdC5uZXh0OwogICAgICAgICAgICB2YXIgZWZmZWN0ID0gZmlyc3RFZmZlY3Q7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBpZiAoKGVmZmVjdC50YWcgJiBmbGFncykgPT09IGZsYWdzKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBQYXNzaXZlJDEpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RhcnRlZChmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmbGFncyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGNyZWF0ZSA9IGVmZmVjdC5jcmVhdGU7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QodHJ1ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVmZmVjdC5kZXN0cm95ID0gY3JlYXRlKCk7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBQYXNzaXZlJDEpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmbGFncyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YXIgZGVzdHJveSA9IGVmZmVjdC5kZXN0cm95OwogICAgICAgICAgICAgICAgICBpZiAoZGVzdHJveSAhPT0gdm9pZCAwICYmIHR5cGVvZiBkZXN0cm95ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGhvb2tOYW1lID0gdm9pZCAwOwogICAgICAgICAgICAgICAgICAgIGlmICgoZWZmZWN0LnRhZyAmIExheW91dCkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgIGhvb2tOYW1lID0gInVzZUxheW91dEVmZmVjdCI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZWZmZWN0LnRhZyAmIEluc2VydGlvbikgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgIGhvb2tOYW1lID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGhvb2tOYW1lID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBhZGRlbmR1bSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgICBpZiAoZGVzdHJveSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIFlvdSByZXR1cm5lZCBudWxsLiBJZiB5b3VyIGVmZmVjdCBkb2VzIG5vdCByZXF1aXJlIGNsZWFuIHVwLCByZXR1cm4gdW5kZWZpbmVkIChvciBub3RoaW5nKS4iOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRlc3Ryb3kudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiXG5cbkl0IGxvb2tzIGxpa2UgeW91IHdyb3RlICIgKyBob29rTmFtZSArICIoYXN5bmMgKCkgPT4gLi4uKSBvciByZXR1cm5lZCBhIFByb21pc2UuIEluc3RlYWQsIHdyaXRlIHRoZSBhc3luYyBmdW5jdGlvbiBpbnNpZGUgeW91ciBlZmZlY3QgYW5kIGNhbGwgaXQgaW1tZWRpYXRlbHk6XG5cbiIgKyBob29rTmFtZSArICIoKCkgPT4ge1xuICBhc3luYyBmdW5jdGlvbiBmZXRjaERhdGEoKSB7XG4gICAgLy8gWW91IGNhbiBhd2FpdCBoZXJlXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBNeUFQSS5nZXREYXRhKHNvbWVJZCk7XG4gICAgLy8gLi4uXG4gIH1cbiAgZmV0Y2hEYXRhKCk7XG59LCBbc29tZUlkXSk7IC8vIE9yIFtdIGlmIGVmZmVjdCBkb2Vzbid0IG5lZWQgcHJvcHMgb3Igc3RhdGVcblxuTGVhcm4gbW9yZSBhYm91dCBkYXRhIGZldGNoaW5nIHdpdGggSG9va3M6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9ob29rcy1kYXRhLWZldGNoaW5nIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIFlvdSByZXR1cm5lZDogIiArIGRlc3Ryb3k7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcyBtdXN0IG5vdCByZXR1cm4gYW55dGhpbmcgYmVzaWRlcyBhIGZ1bmN0aW9uLCB3aGljaCBpcyB1c2VkIGZvciBjbGVhbi11cC4lcyIsIGhvb2tOYW1lLCBhZGRlbmR1bSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKGVmZmVjdCAhPT0gZmlyc3RFZmZlY3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlRWZmZWN0RHVyYXRpb25zKGZpbmlzaGVkUm9vdCwgZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICgoZmluaXNoZWRXb3JrLmZsYWdzICYgVXBkYXRlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjogewogICAgICAgICAgICAgICAgICB2YXIgcGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgIHZhciBfZmluaXNoZWRXb3JrJG1lbW9pemUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcywgaWQgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUuaWQsIG9uUG9zdENvbW1pdCA9IF9maW5pc2hlZFdvcmskbWVtb2l6ZS5vblBvc3RDb21taXQ7CiAgICAgICAgICAgICAgICAgIHZhciBjb21taXRUaW1lMiA9IGdldENvbW1pdFRpbWUoKTsKICAgICAgICAgICAgICAgICAgdmFyIHBoYXNlID0gZmluaXNoZWRXb3JrLmFsdGVybmF0ZSA9PT0gbnVsbCA/ICJtb3VudCIgOiAidXBkYXRlIjsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0N1cnJlbnRVcGRhdGVOZXN0ZWQoKSkgewogICAgICAgICAgICAgICAgICAgICAgcGhhc2UgPSAibmVzdGVkLXVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25Qb3N0Q29tbWl0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgb25Qb3N0Q29tbWl0KGlkLCBwaGFzZSwgcGFzc2l2ZUVmZmVjdER1cmF0aW9uLCBjb21taXRUaW1lMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmluaXNoZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgICAgICAgb3V0ZXI6IHdoaWxlIChwYXJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50RmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvb3QzLnBhc3NpdmVFZmZlY3REdXJhdGlvbiArPSBwYXNzaXZlRWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIG91dGVyOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFN0YXRlTm9kZSA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50U3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiArPSBwYXNzaXZlRWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIG91dGVyOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0RWZmZWN0T25GaWJlcihmaW5pc2hlZFJvb3QsIGN1cnJlbnQ0LCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICBpZiAoKGZpbmlzaGVkV29yay5mbGFncyAmIExheW91dE1hc2spICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIGNvbXBvbmVudERpZE1vdW50LiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIGNvbXBvbmVudERpZE1vdW50LiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCgpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlByb3BzID0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlID09PSBmaW5pc2hlZFdvcmsudHlwZSA/IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzMihmaW5pc2hlZFdvcmsudHlwZSwgY3VycmVudDQubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIGNvbXBvbmVudERpZFVwZGF0ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBjb21wb25lbnREaWRVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMuc3RhdGVgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzLCBwcmV2U3RhdGUsIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbFNuYXBzaG90QmVmb3JlVXBkYXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzLCBwcmV2U3RhdGUsIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbFNuYXBzaG90QmVmb3JlVXBkYXRlKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay50eXBlID09PSBmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgJiYgIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5wcm9wcyAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBwcm9jZXNzaW5nIHRoZSB1cGRhdGUgcXVldWUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMucHJvcHNgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uuc3RhdGUgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBzdGF0ZSB0byBtYXRjaCBtZW1vaXplZCBzdGF0ZSBiZWZvcmUgcHJvY2Vzc2luZyB0aGUgdXBkYXRlIHF1ZXVlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb21taXRVcGRhdGVRdWV1ZShmaW5pc2hlZFdvcmssIHVwZGF0ZVF1ZXVlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgdmFyIF91cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgIGlmIChfdXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay5jaGlsZC50YWcpIHsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgICAgICAgX2luc3RhbmNlID0gZ2V0UHVibGljSW5zdGFuY2UoZmluaXNoZWRXb3JrLmNoaWxkLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgICAgICAgX2luc3RhbmNlID0gZmluaXNoZWRXb3JrLmNoaWxkLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGNvbW1pdFVwZGF0ZVF1ZXVlKGZpbmlzaGVkV29yaywgX3VwZGF0ZVF1ZXVlLCBfaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTIgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsICYmIGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGZpbmlzaGVkV29yay50eXBlOwogICAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgY29tbWl0TW91bnQoX2luc3RhbmNlMiwgdHlwZSwgcHJvcHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOiB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBfZmluaXNoZWRXb3JrJG1lbW9pemUyID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMsIG9uQ29tbWl0ID0gX2ZpbmlzaGVkV29yayRtZW1vaXplMi5vbkNvbW1pdCwgb25SZW5kZXIgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUyLm9uUmVuZGVyOwogICAgICAgICAgICAgICAgICB2YXIgZWZmZWN0RHVyYXRpb24gPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICB2YXIgY29tbWl0VGltZTIgPSBnZXRDb21taXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHZhciBwaGFzZSA9IGN1cnJlbnQ0ID09PSBudWxsID8gIm1vdW50IiA6ICJ1cGRhdGUiOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzQ3VycmVudFVwZGF0ZU5lc3RlZCgpKSB7CiAgICAgICAgICAgICAgICAgICAgICBwaGFzZSA9ICJuZXN0ZWQtdXBkYXRlIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvblJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIG9uUmVuZGVyKGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLmlkLCBwaGFzZSwgZmluaXNoZWRXb3JrLmFjdHVhbER1cmF0aW9uLCBmaW5pc2hlZFdvcmsudHJlZUJhc2VEdXJhdGlvbiwgZmluaXNoZWRXb3JrLmFjdHVhbFN0YXJ0VGltZSwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uQ29tbWl0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICBvbkNvbW1pdChmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcy5pZCwgcGhhc2UsIGVmZmVjdER1cmF0aW9uLCBjb21taXRUaW1lMik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVucXVldWVQZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0KGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZmluaXNoZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgICAgICAgICBvdXRlcjogd2hpbGUgKHBhcmVudEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICByb290My5lZmZlY3REdXJhdGlvbiArPSBlZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50U3RhdGVOb2RlID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbiArPSBlZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEZpYmVyID0gcGFyZW50RmliZXIucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGNvbW1pdFN1c3BlbnNlSHlkcmF0aW9uQ2FsbGJhY2tzKGZpbmlzaGVkUm9vdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgVHJhY2luZ01hcmtlckNvbXBvbmVudDogewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgdW5pdCBvZiB3b3JrIHRhZyBzaG91bGQgbm90IGhhdmUgc2lkZS1lZmZlY3RzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBSZWYyKSB7CiAgICAgICAgICAgICAgICBjb21taXRBdHRhY2hSZWYoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVhcHBlYXJMYXlvdXRFZmZlY3RzT25GaWJlcihub2RlKSB7CiAgICAgICAgICBzd2l0Y2ggKG5vZGUudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmIChub2RlLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsQ29tbWl0SG9va0xheW91dEVmZmVjdExpc3RNb3VudChub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihub2RlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbW1pdEhvb2tMYXlvdXRFZmZlY3RMaXN0TW91bnQobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudERpZE1vdW50KG5vZGUsIG5vZGUucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNhZmVseUF0dGFjaFJlZihub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgc2FmZWx5QXR0YWNoUmVmKG5vZGUsIG5vZGUucmV0dXJuKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWRlT3JVbmhpZGVBbGxDaGlsZHJlbihmaW5pc2hlZFdvcmssIGlzSGlkZGVuKSB7CiAgICAgICAgICB2YXIgaG9zdFN1YnRyZWVSb290ID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG5vZGUgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG5vZGU7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBoaWRlSW5zdGFuY2UoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB1bmhpZGVJbnN0YW5jZShub2RlLnN0YXRlTm9kZSwgbm9kZS5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTMgPSBub2RlLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICAgIGhpZGVUZXh0SW5zdGFuY2UoX2luc3RhbmNlMyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHVuaGlkZVRleHRJbnN0YW5jZShfaW5zdGFuY2UzLCBub2RlLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICgobm9kZS50YWcgPT09IE9mZnNjcmVlbkNvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gTGVnYWN5SGlkZGVuQ29tcG9uZW50KSAmJiBub2RlLm1lbW9pemVkU3RhdGUgIT09IG51bGwgJiYgbm9kZSAhPT0gZmluaXNoZWRXb3JrKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBub2RlKSB7CiAgICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChob3N0U3VidHJlZVJvb3QgPT09IG5vZGUpIHsKICAgICAgICAgICAgICAgIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEF0dGFjaFJlZihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciByZWYgPSBmaW5pc2hlZFdvcmsucmVmOwogICAgICAgICAgaWYgKHJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgaW5zdGFuY2VUb1VzZTsKICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgaW5zdGFuY2VUb1VzZSA9IGdldFB1YmxpY0luc3RhbmNlKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBpbnN0YW5jZVRvVXNlID0gaW5zdGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiByZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgcmV0VmFsOwogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihpbnN0YW5jZVRvVXNlKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihpbnN0YW5jZVRvVXNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXRWYWwgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgcmV0dXJuIHZhbHVlIGZyb20gYSBjYWxsYmFjayByZWYgaW4gJXMuIEEgY2FsbGJhY2sgcmVmIHNob3VsZCBub3QgcmV0dXJuIGEgZnVuY3Rpb24uIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFyZWYuaGFzT3duUHJvcGVydHkoImN1cnJlbnQiKSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCByZWYgb2JqZWN0IHByb3ZpZGVkIGZvciAlcy4gVXNlIGVpdGhlciBhIHJlZi1zZXR0ZXIgZnVuY3Rpb24gb3IgUmVhY3QuY3JlYXRlUmVmKCkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVmLmN1cnJlbnQgPSBpbnN0YW5jZVRvVXNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaEZpYmVyTXV0YXRpb24oZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFsdGVybmF0ZS5yZXR1cm4gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZmliZXIucmV0dXJuID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGV0YWNoRmliZXJBZnRlckVmZmVjdHMoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZSA9IG51bGw7CiAgICAgICAgICAgIGRldGFjaEZpYmVyQWZ0ZXJFZmZlY3RzKGFsdGVybmF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgZmliZXIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgZmliZXIuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IEhvc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgaG9zdEluc3RhbmNlID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGRldGFjaERlbGV0ZWRJbnN0YW5jZShob3N0SW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBmaWJlci5yZXR1cm4gPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLmRlcGVuZGVuY2llcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0UGFyZW50RmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciBwYXJlbnQgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB3aGlsZSAocGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChpc0hvc3RQYXJlbnQocGFyZW50KSkgewogICAgICAgICAgICAgIHJldHVybiBwYXJlbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gZmluZCBhIGhvc3QgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0hvc3RQYXJlbnQoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBmaWJlci50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgZmliZXIudGFnID09PSBIb3N0Um9vdCB8fCBmaWJlci50YWcgPT09IEhvc3RQb3J0YWw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RTaWJsaW5nKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgc2libGluZ3M6IHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgaXNIb3N0UGFyZW50KG5vZGUucmV0dXJuKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIHdoaWxlIChub2RlLnRhZyAhPT0gSG9zdENvbXBvbmVudCAmJiBub2RlLnRhZyAhPT0gSG9zdFRleHQgJiYgbm9kZS50YWcgIT09IERlaHlkcmF0ZWRGcmFnbWVudCkgewogICAgICAgICAgICAgIGlmIChub2RlLmZsYWdzICYgUGxhY2VtZW50KSB7CiAgICAgICAgICAgICAgICBjb250aW51ZSBzaWJsaW5nczsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUuY2hpbGQgPT09IG51bGwgfHwgbm9kZS50YWcgPT09IEhvc3RQb3J0YWwpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlIHNpYmxpbmdzOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCEobm9kZS5mbGFncyAmIFBsYWNlbWVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGxhY2VtZW50KGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIHBhcmVudEZpYmVyID0gZ2V0SG9zdFBhcmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChwYXJlbnRGaWJlci5mbGFncyAmIENvbnRlbnRSZXNldCkgewogICAgICAgICAgICAgICAgcmVzZXRUZXh0Q29udGVudChwYXJlbnQpOwogICAgICAgICAgICAgICAgcGFyZW50RmliZXIuZmxhZ3MgJj0gfkNvbnRlbnRSZXNldDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGJlZm9yZSA9IGdldEhvc3RTaWJsaW5nKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlKGZpbmlzaGVkV29yaywgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHZhciBfcGFyZW50ID0gcGFyZW50RmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgdmFyIF9iZWZvcmUgPSBnZXRIb3N0U2libGluZyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZUludG9Db250YWluZXIoZmluaXNoZWRXb3JrLCBfYmVmb3JlLCBfcGFyZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBob3N0IHBhcmVudCBmaWJlci4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihub2RlLCBiZWZvcmUsIHBhcmVudCkgewogICAgICAgICAgdmFyIHRhZyA9IG5vZGUudGFnOwogICAgICAgICAgdmFyIGlzSG9zdCA9IHRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCB0YWcgPT09IEhvc3RUZXh0OwogICAgICAgICAgaWYgKGlzSG9zdCkgewogICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChiZWZvcmUpIHsKICAgICAgICAgICAgICBpbnNlcnRJbkNvbnRhaW5lckJlZm9yZShwYXJlbnQsIHN0YXRlTm9kZSwgYmVmb3JlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBhcHBlbmRDaGlsZFRvQ29udGFpbmVyKHBhcmVudCwgc3RhdGVOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKGNoaWxkLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIHdoaWxlIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKHNpYmxpbmcsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICAgIHNpYmxpbmcgPSBzaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShub2RlLCBiZWZvcmUsIHBhcmVudCkgewogICAgICAgICAgdmFyIHRhZyA9IG5vZGUudGFnOwogICAgICAgICAgdmFyIGlzSG9zdCA9IHRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCB0YWcgPT09IEhvc3RUZXh0OwogICAgICAgICAgaWYgKGlzSG9zdCkgewogICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIGlmIChiZWZvcmUpIHsKICAgICAgICAgICAgICBpbnNlcnRCZWZvcmUocGFyZW50LCBzdGF0ZU5vZGUsIGJlZm9yZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXBwZW5kQ2hpbGQocGFyZW50LCBzdGF0ZU5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFBvcnRhbCkgOwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShjaGlsZCwgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB3aGlsZSAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlKHNpYmxpbmcsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICAgIHNpYmxpbmcgPSBzaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICB2YXIgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RGVsZXRpb25FZmZlY3RzKHJvb3QzLCByZXR1cm5GaWJlciwgZGVsZXRlZEZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgZmluZFBhcmVudDogd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50LnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBwYXJlbnQuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHBhcmVudC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcGFyZW50LnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICBicmVhayBmaW5kUGFyZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChob3N0UGFyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBmaW5kIGEgaG9zdCBwYXJlbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWl0RGVsZXRpb25FZmZlY3RzT25GaWJlcihyb290MywgcmV0dXJuRmliZXIsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBudWxsOwogICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGRldGFjaEZpYmVyTXV0YXRpb24oZGVsZXRlZEZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIHBhcmVudCkgewogICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50LmNoaWxkOwogICAgICAgICAgd2hpbGUgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBjaGlsZCk7CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RGVsZXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcikgewogICAgICAgICAgb25Db21taXRVbm1vdW50KGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICBzd2l0Y2ggKGRlbGV0ZWRGaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2SG9zdFBhcmVudCA9IGhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICB2YXIgcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcHJldkhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBwcmV2SG9zdFBhcmVudElzQ29udGFpbmVyOwogICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnRJc0NvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIHJlbW92ZUNoaWxkRnJvbUNvbnRhaW5lcihob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVDaGlsZChob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBEZWh5ZHJhdGVkRnJhZ21lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdFBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBpZiAoaG9zdFBhcmVudElzQ29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJTdXNwZW5zZUJvdW5kYXJ5RnJvbUNvbnRhaW5lcihob3N0UGFyZW50LCBkZWxldGVkRmliZXIuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBfcHJldkhvc3RQYXJlbnQgPSBob3N0UGFyZW50OwogICAgICAgICAgICAgICAgdmFyIF9wcmV2SG9zdFBhcmVudElzQ29udGFpbmVyID0gaG9zdFBhcmVudElzQ29udGFpbmVyOwogICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IHRydWU7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBfcHJldkhvc3RQYXJlbnQ7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSBfcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBkZWxldGVkRmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIGxhc3RFZmZlY3QgPSB1cGRhdGVRdWV1ZS5sYXN0RWZmZWN0OwogICAgICAgICAgICAgICAgICBpZiAobGFzdEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgICAgICAgICB2YXIgZWZmZWN0ID0gZmlyc3RFZmZlY3Q7CiAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgdmFyIF9lZmZlY3QgPSBlZmZlY3QsIGRlc3Ryb3kgPSBfZWZmZWN0LmRlc3Ryb3ksIHRhZyA9IF9lZmZlY3QudGFnOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHRhZyAmIEluc2VydGlvbikgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKHRhZyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZChkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVsZXRlZEZpYmVyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbERlc3Ryb3koZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZXN0cm95KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoZWZmZWN0ICE9PSBmaXJzdEVmZmVjdCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpOwogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZGVsZXRlZEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSB0aGlzIGRlYWQgZmxhZwogICAgICAgICAgICAgICAgZGVsZXRlZEZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiB8fCBkZWxldGVkRmliZXIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRTdXNwZW5zZUNhbGxiYWNrKGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIG5ld1N0YXRlID0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFN1c3BlbnNlSHlkcmF0aW9uQ2FsbGJhY2tzKGZpbmlzaGVkUm9vdCwgZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChuZXdTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudDQgPSBmaW5pc2hlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VJbnN0YW5jZSA9IHByZXZTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlSW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY29tbWl0SHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRhY2hTdXNwZW5zZVJldHJ5TGlzdGVuZXJzKGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIHdha2VhYmxlcyA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmICh3YWtlYWJsZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgdmFyIHJldHJ5Q2FjaGUgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAocmV0cnlDYWNoZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHJ5Q2FjaGUgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlID0gbmV3IFBvc3NpYmx5V2Vha1NldCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdha2VhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uKHdha2VhYmxlKSB7CiAgICAgICAgICAgICAgdmFyIHJldHJ5ID0gcmVzb2x2ZVJldHJ5V2FrZWFibGUuYmluZChudWxsLCBmaW5pc2hlZFdvcmssIHdha2VhYmxlKTsKICAgICAgICAgICAgICBpZiAoIXJldHJ5Q2FjaGUuaGFzKHdha2VhYmxlKSkgewogICAgICAgICAgICAgICAgcmV0cnlDYWNoZS5hZGQod2FrZWFibGUpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5Qcm9ncmVzc0xhbmVzICE9PSBudWxsICYmIGluUHJvZ3Jlc3NSb290ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKGluUHJvZ3Jlc3NSb290LCBpblByb2dyZXNzTGFuZXMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigiRXhwZWN0ZWQgZmluaXNoZWQgcm9vdCBhbmQgbGFuZXMgdG8gYmUgc2V0LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2FrZWFibGUudGhlbihyZXRyeSwgcmV0cnkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdE11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gY29tbWl0dGVkTGFuZXM7CiAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IHJvb3QzOwogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICBjb21taXRNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGZpbmlzaGVkV29yaywgcm9vdDMpOwogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpbmlzaGVkV29yayk7CiAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBudWxsOwogICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBwYXJlbnRGaWJlciwgbGFuZXMpIHsKICAgICAgICAgIHZhciBkZWxldGlvbnMgPSBwYXJlbnRGaWJlci5kZWxldGlvbnM7CiAgICAgICAgICBpZiAoZGVsZXRpb25zICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVsZXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkVG9EZWxldGUgPSBkZWxldGlvbnNbaV07CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0cyhyb290MywgcGFyZW50RmliZXIsIGNoaWxkVG9EZWxldGUpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY2hpbGRUb0RlbGV0ZSwgcGFyZW50RmliZXIsIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldkRlYnVnRmliZXIgPSBnZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIGlmIChwYXJlbnRGaWJlci5zdWJ0cmVlRmxhZ3MgJiBNdXRhdGlvbk1hc2spIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gcGFyZW50RmliZXIuY2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihjaGlsZCk7CiAgICAgICAgICAgICAgY29tbWl0TXV0YXRpb25FZmZlY3RzT25GaWJlcihjaGlsZCwgcm9vdDMpOwogICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKHByZXZEZWJ1Z0ZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TXV0YXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFdvcmssIHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmluaXNoZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgIHZhciBmbGFncyA9IGZpbmlzaGVkV29yay5mbGFnczsKICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoSW5zZXJ0aW9uIHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KEluc2VydGlvbiB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBSZWYyKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQ0LCBjdXJyZW50NC5yZXR1cm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBSZWYyKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQ0LCBjdXJyZW50NC5yZXR1cm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLmZsYWdzICYgQ29udGVudFJlc2V0KSB7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgcmVzZXRUZXh0Q29udGVudChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2U0ID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKF9pbnN0YW5jZTQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBuZXdQcm9wcyA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciBvbGRQcm9wcyA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQubWVtb2l6ZWRQcm9wcyA6IG5ld1Byb3BzOwogICAgICAgICAgICAgICAgICAgIHZhciB0eXBlID0gZmluaXNoZWRXb3JrLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVBheWxvYWQgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICAgICAgZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICBpZiAodXBkYXRlUGF5bG9hZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgY29tbWl0VXBkYXRlKF9pbnN0YW5jZTQsIHVwZGF0ZVBheWxvYWQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgc2hvdWxkIGhhdmUgYSB0ZXh0IG5vZGUgaW5pdGlhbGl6ZWQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHRleHRJbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHZhciBuZXdUZXh0ID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIHZhciBvbGRUZXh0ID0gY3VycmVudDQgIT09IG51bGwgPyBjdXJyZW50NC5tZW1vaXplZFByb3BzIDogbmV3VGV4dDsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjb21taXRUZXh0VXBkYXRlKHRleHRJbnN0YW5jZSwgb2xkVGV4dCwgbmV3VGV4dCk7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBwcmV2Um9vdFN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAocHJldlJvb3RTdGF0ZS5pc0RlaHlkcmF0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdEh5ZHJhdGVkQ29udGFpbmVyKHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIHZhciBvZmZzY3JlZW5GaWJlciA9IGZpbmlzaGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICBpZiAob2Zmc2NyZWVuRmliZXIuZmxhZ3MgJiBWaXNpYmlsaXR5KSB7CiAgICAgICAgICAgICAgICB2YXIgb2Zmc2NyZWVuSW5zdGFuY2UgPSBvZmZzY3JlZW5GaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBvZmZzY3JlZW5GaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgdmFyIGlzSGlkZGVuID0gbmV3U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5JbnN0YW5jZS5pc0hpZGRlbiA9IGlzSGlkZGVuOwogICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgIHZhciB3YXNIaWRkZW4gPSBvZmZzY3JlZW5GaWJlci5hbHRlcm5hdGUgIT09IG51bGwgJiYgb2Zmc2NyZWVuRmliZXIuYWx0ZXJuYXRlLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICAgIGlmICghd2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbW1pdFRpbWVPZkZhbGxiYWNrKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRTdXNwZW5zZUNhbGxiYWNrKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYXR0YWNoU3VzcGVuc2VSZXRyeUxpc3RlbmVycyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgX3dhc0hpZGRlbiA9IGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIHRoaXMgZGVhZCBmbGFnCiAgICAgICAgICAgICAgICBmaW5pc2hlZFdvcmsubW9kZSAmIENvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuIHx8IF93YXNIaWRkZW47CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoZmxhZ3MgJiBWaXNpYmlsaXR5KSB7CiAgICAgICAgICAgICAgICB2YXIgX29mZnNjcmVlbkluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHZhciBfbmV3U3RhdGUgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBfaXNIaWRkZW4gPSBfbmV3U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgb2Zmc2NyZWVuQm91bmRhcnkgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgICAgICBfb2Zmc2NyZWVuSW5zdGFuY2UuaXNIaWRkZW4gPSBfaXNIaWRkZW47CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChfaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIV93YXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICgob2Zmc2NyZWVuQm91bmRhcnkubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBvZmZzY3JlZW5Cb3VuZGFyeTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkNoaWxkID0gb2Zmc2NyZWVuQm91bmRhcnkuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChvZmZzY3JlZW5DaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBvZmZzY3JlZW5DaGlsZDsKICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKG9mZnNjcmVlbkNoaWxkKTsKICAgICAgICAgICAgICAgICAgICAgICAgICBvZmZzY3JlZW5DaGlsZCA9IG9mZnNjcmVlbkNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaGlkZU9yVW5oaWRlQWxsQ2hpbGRyZW4ob2Zmc2NyZWVuQm91bmRhcnksIF9pc0hpZGRlbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICBhdHRhY2hTdXNwZW5zZVJldHJ5TGlzdGVuZXJzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgZmxhZ3MgPSBmaW5pc2hlZFdvcmsuZmxhZ3M7CiAgICAgICAgICBpZiAoZmxhZ3MgJiBQbGFjZW1lbnQpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBjb21taXRQbGFjZW1lbnQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpbmlzaGVkV29yay5mbGFncyAmPSB+UGxhY2VtZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZsYWdzICYgSHlkcmF0aW5nKSB7CiAgICAgICAgICAgIGZpbmlzaGVkV29yay5mbGFncyAmPSB+SHlkcmF0aW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRMYXlvdXRFZmZlY3RzKGZpbmlzaGVkV29yaywgcm9vdDMsIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBjb21taXR0ZWRMYW5lczsKICAgICAgICAgIGluUHJvZ3Jlc3NSb290ID0gcm9vdDM7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0c19iZWdpbihmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICBpblByb2dyZXNzTGFuZXMgPSBudWxsOwogICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRMYXlvdXRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIHZhciBpc01vZGVyblJvb3QgPSAoc3VidHJlZVJvb3QubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gT2Zmc2NyZWVuQ29tcG9uZW50ICYmIGlzTW9kZXJuUm9vdCkgewogICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IGZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgdmFyIG5ld09mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IGlzSGlkZGVuIHx8IG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICBpZiAobmV3T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgdmFyIHdhc0hpZGRlbiA9IGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgbmV3T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IHdhc0hpZGRlbiB8fCBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gbmV3T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IG5ld09mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBpZiAob2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiAmJiAhcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyOwogICAgICAgICAgICAgICAgICByZWFwcGVhckxheW91dEVmZmVjdHNfYmVnaW4oZmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdHNfYmVnaW4oCiAgICAgICAgICAgICAgICAgICAgY2hpbGQsCiAgICAgICAgICAgICAgICAgICAgLy8gTmV3IHJvb3Q7IGJ1YmJsZSBiYWNrIHVwIHRvIGhlcmUgYW5kIHN0b3AuCiAgICAgICAgICAgICAgICAgICAgcm9vdDMsCiAgICAgICAgICAgICAgICAgICAgY29tbWl0dGVkTGFuZXMKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIGNvbW1pdExheW91dE1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIExheW91dE1hc2spICE9PSBOb0ZsYWdzICYmIGZpcnN0Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmaXJzdENoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbW1pdExheW91dE1vdW50RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgaWYgKChmaWJlci5mbGFncyAmIExheW91dE1hc2spICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdE9uRmliZXIocm9vdDMsIGN1cnJlbnQ0LCBmaWJlciwgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19iZWdpbihzdWJ0cmVlUm9vdCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgdmFyIGZpcnN0Q2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0LCBmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaWJlcik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChMYXlvdXQsIGZpYmVyLCBmaWJlci5yZXR1cm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGZpYmVyLCBmaWJlci5yZXR1cm4sIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIGlzSGlkZGVuID0gZmliZXIubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpcnN0Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmaXJzdENoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRpc2FwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc2FwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIGlmIChmaWJlciA9PT0gc3VidHJlZVJvb3QpIHsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFwcGVhckxheW91dEVmZmVjdHNfYmVnaW4oc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IE9mZnNjcmVlbkNvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IGZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICByZWFwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZWFwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZWFwcGVhckxheW91dEVmZmVjdHNPbkZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpIHsKICAgICAgICAgIG5leHRFZmZlY3QgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2JlZ2luKGZpbmlzaGVkV29yaywgcm9vdDMsIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHNfYmVnaW4oc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmICgoZmliZXIuc3VidHJlZUZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzICYmIGZpcnN0Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBmaXJzdENoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIGlmICgoZmliZXIuZmxhZ3MgJiBQYXNzaXZlKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVNb3VudE9uRmliZXIocm9vdDMsIGZpYmVyLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZU1vdW50T25GaWJlcihmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yaywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzKGZpcnN0Q2hpbGQpIHsKICAgICAgICAgIG5leHRFZmZlY3QgPSBmaXJzdENoaWxkOwogICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2JlZ2luKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c19iZWdpbigpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKG5leHRFZmZlY3QuZmxhZ3MgJiBDaGlsZERlbGV0aW9uKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHZhciBkZWxldGlvbnMgPSBmaWJlci5kZWxldGlvbnM7CiAgICAgICAgICAgICAgaWYgKGRlbGV0aW9ucyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkZWxldGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIGZpYmVyVG9EZWxldGUgPSBkZWxldGlvbnNbaV07CiAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlclRvRGVsZXRlOwogICAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2JlZ2luKGZpYmVyVG9EZWxldGUsIGZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0ZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGRldGFjaGVkQ2hpbGQgPSBwcmV2aW91c0ZpYmVyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChkZXRhY2hlZENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0ZpYmVyLmNoaWxkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRldGFjaGVkU2libGluZyA9IGRldGFjaGVkQ2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWNoZWRDaGlsZC5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWNoZWRDaGlsZCA9IGRldGFjaGVkU2libGluZzsKICAgICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGRldGFjaGVkQ2hpbGQgIT09IG51bGwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfY29tcGxldGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfY29tcGxldGUoKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgUGFzc2l2ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50T25GaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50T25GaWJlcihmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgICByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9iZWdpbihkZWxldGVkU3VidHJlZVJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50SW5zaWRlRGVsZXRlZFRyZWVPbkZpYmVyKGZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgdmFyIGNoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBjaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNJbnNpZGVPZkRlbGV0ZWRUcmVlX2NvbXBsZXRlKGRlbGV0ZWRTdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9jb21wbGV0ZShkZWxldGVkU3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZGV0YWNoRmliZXJBZnRlckVmZmVjdHMoZmliZXIpOwogICAgICAgICAgICAgIGlmIChmaWJlciA9PT0gZGVsZXRlZFN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gcmV0dXJuRmliZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50SW5zaWRlRGVsZXRlZFRyZWVPbkZpYmVyKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICBzd2l0Y2ggKGN1cnJlbnQ0LnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFBhc3NpdmVFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSwgY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpOwogICAgICAgICAgICAgICAgcmVjb3JkUGFzc2l2ZUVmZmVjdER1cmF0aW9uKGN1cnJlbnQ0KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSwgY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VMYXlvdXRFZmZlY3RNb3VudEluREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpYmVyKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VQYXNzaXZlRWZmZWN0TW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoUGFzc2l2ZSQxIHwgSGFzRWZmZWN0LCBmaWJlcik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VMYXlvdXRFZmZlY3RVbm1vdW50SW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaWJlciwgZmliZXIucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGZpYmVyLCBmaWJlci5yZXR1cm4sIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VQYXNzaXZlRWZmZWN0VW5tb3VudEluREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIENPTVBPTkVOVF9UWVBFID0gMDsKICAgICAgICB2YXIgSEFTX1BTRVVET19DTEFTU19UWVBFID0gMTsKICAgICAgICB2YXIgUk9MRV9UWVBFID0gMjsKICAgICAgICB2YXIgVEVTVF9OQU1FX1RZUEUgPSAzOwogICAgICAgIHZhciBURVhUX1RZUEUgPSA0OwogICAgICAgIGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC5mb3IpIHsKICAgICAgICAgIHZhciBzeW1ib2xGb3IgPSBTeW1ib2wuZm9yOwogICAgICAgICAgQ09NUE9ORU5UX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLmNvbXBvbmVudCIpOwogICAgICAgICAgSEFTX1BTRVVET19DTEFTU19UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5oYXNfcHNldWRvX2NsYXNzIik7CiAgICAgICAgICBST0xFX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLnJvbGUiKTsKICAgICAgICAgIFRFU1RfTkFNRV9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci50ZXN0X2lkIik7CiAgICAgICAgICBURVhUX1RZUEUgPSBzeW1ib2xGb3IoInNlbGVjdG9yLnRleHQiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGNvbW1pdEhvb2tzID0gW107CiAgICAgICAgZnVuY3Rpb24gb25Db21taXRSb290JDEoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNvbW1pdEhvb2tzLmZvckVhY2goZnVuY3Rpb24oY29tbWl0SG9vaykgewogICAgICAgICAgICAgIHJldHVybiBjb21taXRIb29rKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50QWN0UXVldWUgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRBY3RRdWV1ZTsKICAgICAgICBmdW5jdGlvbiBpc0xlZ2FjeUFjdEVudmlyb25tZW50KGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWwgPSAoCiAgICAgICAgICAgICAgLy8gJEZsb3dFeHBlY3RlZEVycm9yIOKAkyBGbG93IGRvZXNuJ3Qga25vdyBhYm91dCBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgZ2xvYmFsCiAgICAgICAgICAgICAgdHlwZW9mIElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCAhPT0gInVuZGVmaW5lZCIgPyBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgOiB2b2lkIDAKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdmFyIGplc3RJc0RlZmluZWQgPSB0eXBlb2YgamVzdCAhPT0gInVuZGVmaW5lZCI7CiAgICAgICAgICAgIHJldHVybiBqZXN0SXNEZWZpbmVkICYmIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCAhPT0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsID0gKAogICAgICAgICAgICAgIC8vICRGbG93RXhwZWN0ZWRFcnJvciDigJMgRmxvdyBkb2Vzbid0IGtub3cgYWJvdXQgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIGdsb2JhbAogICAgICAgICAgICAgIHR5cGVvZiBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgIT09ICJ1bmRlZmluZWQiID8gSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIDogdm9pZCAwCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGlmICghaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGN1cnJlbnQgdGVzdGluZyBlbnZpcm9ubWVudCBpcyBub3QgY29uZmlndXJlZCB0byBzdXBwb3J0IGFjdCguLi4pIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNlaWwgPSBNYXRoLmNlaWw7CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXIsIFJlYWN0Q3VycmVudE93bmVyJDIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lciwgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMyA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLCBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QWN0UXVldWU7CiAgICAgICAgdmFyIE5vQ29udGV4dCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgQmF0Y2hlZENvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgUmVuZGVyQ29udGV4dCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgQ29tbWl0Q29udGV4dCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgUm9vdEluUHJvZ3Jlc3MgPSAwOwogICAgICAgIHZhciBSb290RmF0YWxFcnJvcmVkID0gMTsKICAgICAgICB2YXIgUm9vdEVycm9yZWQgPSAyOwogICAgICAgIHZhciBSb290U3VzcGVuZGVkID0gMzsKICAgICAgICB2YXIgUm9vdFN1c3BlbmRlZFdpdGhEZWxheSA9IDQ7CiAgICAgICAgdmFyIFJvb3RDb21wbGV0ZWQgPSA1OwogICAgICAgIHZhciBSb290RGlkTm90Q29tcGxldGUgPSA2OwogICAgICAgIHZhciBleGVjdXRpb25Db250ZXh0ID0gTm9Db250ZXh0OwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgc3VidHJlZVJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgc3VidHJlZVJlbmRlckxhbmVzQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5vTGFuZXMpOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEluUHJvZ3Jlc3M7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3IgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RJbmNsdWRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290U2tpcHBlZExhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnMgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9IG51bGw7CiAgICAgICAgdmFyIGdsb2JhbE1vc3RSZWNlbnRGYWxsYmFja1RpbWUgPSAwOwogICAgICAgIHZhciBGQUxMQkFDS19USFJPVFRMRV9NUyA9IDUwMDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyVGFyZ2V0VGltZSA9IEluZmluaXR5OwogICAgICAgIHZhciBSRU5ERVJfVElNRU9VVF9NUyA9IDUwMDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gcmVzZXRSZW5kZXJUaW1lcigpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWUgPSBub3coKSArIFJFTkRFUl9USU1FT1VUX01TOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSZW5kZXJUYXJnZXRUaW1lKCkgewogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWU7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNVbmNhdWdodEVycm9yID0gZmFsc2U7CiAgICAgICAgdmFyIGZpcnN0VW5jYXVnaHRFcnJvciA9IG51bGw7CiAgICAgICAgdmFyIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID0gbnVsbDsKICAgICAgICB2YXIgcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICB2YXIgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPSBudWxsOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3RzID0gW107CiAgICAgICAgdmFyIHBlbmRpbmdQYXNzaXZlVHJhbnNpdGlvbnMgPSBudWxsOwogICAgICAgIHZhciBORVNURURfVVBEQVRFX0xJTUlUID0gNTA7CiAgICAgICAgdmFyIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICB2YXIgcm9vdFdpdGhOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICB2YXIgaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICB2YXIgTkVTVEVEX1BBU1NJVkVfVVBEQVRFX0xJTUlUID0gNTA7CiAgICAgICAgdmFyIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgdmFyIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgIHZhciBjdXJyZW50RXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgdmFyIGN1cnJlbnRFdmVudFRyYW5zaXRpb25MYW5lID0gTm9MYW5lczsKICAgICAgICB2YXIgaXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0ID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0V29ya0luUHJvZ3Jlc3NSb290KCkgewogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEV2ZW50VGltZSgpIHsKICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIG5vdygpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnRFdmVudFRpbWUgIT09IE5vVGltZXN0YW1wKSB7CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUaW1lOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudEV2ZW50VGltZSA9IG5vdygpOwogICAgICAgICAgcmV0dXJuIGN1cnJlbnRFdmVudFRpbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IGZpYmVyLm1vZGU7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICB9IGVsc2UgaWYgKChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgIT09IE5vQ29udGV4dCAmJiB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICByZXR1cm4gcGlja0FyYml0cmFyeUxhbmUod29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGlzVHJhbnNpdGlvbiA9IHJlcXVlc3RDdXJyZW50VHJhbnNpdGlvbigpICE9PSBOb1RyYW5zaXRpb247CiAgICAgICAgICBpZiAoaXNUcmFuc2l0aW9uKSB7CiAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgdHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgICAgICBpZiAoIXRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMpIHsKICAgICAgICAgICAgICAgIHRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLmFkZChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN1cnJlbnRFdmVudFRyYW5zaXRpb25MYW5lID09PSBOb0xhbmUpIHsKICAgICAgICAgICAgICBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IGNsYWltTmV4dFRyYW5zaXRpb25MYW5lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRFdmVudFRyYW5zaXRpb25MYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZUxhbmUgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIGlmICh1cGRhdGVMYW5lICE9PSBOb0xhbmUpIHsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUxhbmU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRMYW5lID0gZ2V0Q3VycmVudEV2ZW50UHJpb3JpdHkoKTsKICAgICAgICAgIHJldHVybiBldmVudExhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RSZXRyeUxhbmUoZmliZXIpIHsKICAgICAgICAgIHZhciBtb2RlID0gZmliZXIubW9kZTsKICAgICAgICAgIGlmICgobW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBTeW5jTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjbGFpbU5leHRSZXRyeUxhbmUoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICBjaGVja0Zvck5lc3RlZFVwZGF0ZXMoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCkgewogICAgICAgICAgICAgIGVycm9yKCJ1c2VJbnNlcnRpb25FZmZlY3QgbXVzdCBub3Qgc2NoZWR1bGUgdXBkYXRlcy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0xhbmVzICYmIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QpIHsKICAgICAgICAgICAgd2FybkFib3V0UmVuZGVyUGhhc2VVcGRhdGVzSW5ERVYoZmliZXIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgYWRkRmliZXJUb0xhbmVzTWFwKHJvb3QzLCBmaWJlciwgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5JZlVwZGF0ZXNOb3RXcmFwcGVkV2l0aEFjdERFVihmaWJlcik7CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzLCBsYW5lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkpIHsKICAgICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgICBpZiAobGFuZSA9PT0gU3luY0xhbmUgJiYgZXhlY3V0aW9uQ29udGV4dCA9PT0gTm9Db250ZXh0ICYmIChmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUgJiYgLy8gVHJlYXQgYGFjdGAgYXMgaWYgaXQncyBpbnNpZGUgYGJhdGNoZWRVcGRhdGVzYCwgZXZlbiBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgICAgIVJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuaXNCYXRjaGluZ0xlZ2FjeSkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3NPbmx5SW5MZWdhY3lNb2RlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVJbml0aWFsSHlkcmF0aW9uT25Sb290KHJvb3QzLCBsYW5lLCBldmVudFRpbWUpIHsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IHJvb3QzLmN1cnJlbnQ7CiAgICAgICAgICBjdXJyZW50NC5sYW5lcyA9IGxhbmU7CiAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIGV2ZW50VGltZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVW5zYWZlQ2xhc3NSZW5kZXJQaGFzZVVwZGF0ZShmaWJlcikgewogICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgLy8gVE9ETzogUmVtb3ZlIG91dGRhdGVkIGRlZmVyUmVuZGVyUGhhc2VVcGRhdGVUb05leHRCYXRjaCBleHBlcmltZW50LiBXZQogICAgICAgICAgICAvLyBkZWNpZGVkIG5vdCB0byBlbmFibGUgaXQuCiAgICAgICAgICAgIChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgIT09IE5vQ29udGV4dAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBjdXJyZW50VGltZSkgewogICAgICAgICAgdmFyIGV4aXN0aW5nQ2FsbGJhY2tOb2RlID0gcm9vdDMuY2FsbGJhY2tOb2RlOwogICAgICAgICAgbWFya1N0YXJ2ZWRMYW5lc0FzRXhwaXJlZChyb290MywgY3VycmVudFRpbWUpOwogICAgICAgICAgdmFyIG5leHRMYW5lcyA9IGdldE5leHRMYW5lcyhyb290Mywgcm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCA/IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzIDogTm9MYW5lcyk7CiAgICAgICAgICBpZiAobmV4dExhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIGlmIChleGlzdGluZ0NhbGxiYWNrTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNhbmNlbENhbGxiYWNrJDEoZXhpc3RpbmdDYWxsYmFja05vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG51bGw7CiAgICAgICAgICAgIHJvb3QzLmNhbGxiYWNrUHJpb3JpdHkgPSBOb0xhbmU7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdDYWxsYmFja1ByaW9yaXR5ID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShuZXh0TGFuZXMpOwogICAgICAgICAgdmFyIGV4aXN0aW5nQ2FsbGJhY2tQcmlvcml0eSA9IHJvb3QzLmNhbGxiYWNrUHJpb3JpdHk7CiAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja1ByaW9yaXR5ID09PSBuZXdDYWxsYmFja1ByaW9yaXR5ICYmIC8vIFNwZWNpYWwgY2FzZSByZWxhdGVkIHRvIGBhY3RgLiBJZiB0aGUgY3VycmVudGx5IHNjaGVkdWxlZCB0YXNrIGlzIGEKICAgICAgICAgIC8vIFNjaGVkdWxlciB0YXNrLCByYXRoZXIgdGhhbiBhbiBgYWN0YCB0YXNrLCBjYW5jZWwgaXQgYW5kIHJlLXNjaGVkdWxlZAogICAgICAgICAgLy8gb24gdGhlIGBhY3RgIHF1ZXVlLgogICAgICAgICAgIShSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgIT09IG51bGwgJiYgZXhpc3RpbmdDYWxsYmFja05vZGUgIT09IGZha2VBY3RDYWxsYmFja05vZGUpKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgPT0gbnVsbCAmJiBleGlzdGluZ0NhbGxiYWNrUHJpb3JpdHkgIT09IFN5bmNMYW5lKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgc2NoZWR1bGVkIGNhbGxiYWNrIHRvIGV4aXN0LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgIT0gbnVsbCkgewogICAgICAgICAgICBjYW5jZWxDYWxsYmFjayQxKGV4aXN0aW5nQ2FsbGJhY2tOb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdDYWxsYmFja05vZGU7CiAgICAgICAgICBpZiAobmV3Q2FsbGJhY2tQcmlvcml0eSA9PT0gU3luY0xhbmUpIHsKICAgICAgICAgICAgaWYgKHJvb3QzLnRhZyA9PT0gTGVnYWN5Um9vdCkgewogICAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmlzQmF0Y2hpbmdMZWdhY3kgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzY2hlZHVsZUxlZ2FjeVN5bmNDYWxsYmFjayhwZXJmb3JtU3luY1dvcmtPblJvb3QuYmluZChudWxsLCByb290MykpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNjaGVkdWxlU3luY0NhbGxiYWNrKHBlcmZvcm1TeW5jV29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudC5wdXNoKGZsdXNoU3luY0NhbGxiYWNrcyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlTWljcm90YXNrKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdDYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHNjaGVkdWxlclByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIHN3aXRjaCAobGFuZXNUb0V2ZW50UHJpb3JpdHkobmV4dExhbmVzKSkgewogICAgICAgICAgICAgIGNhc2UgRGlzY3JldGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IEltbWVkaWF0ZVByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBDb250aW51b3VzRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBVc2VyQmxvY2tpbmdQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRGVmYXVsdEV2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIElkbGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IElkbGVQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXdDYWxsYmFja05vZGUgPSBzY2hlZHVsZUNhbGxiYWNrJDEoc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCwgcGVyZm9ybUNvbmN1cnJlbnRXb3JrT25Sb290LmJpbmQobnVsbCwgcm9vdDMpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJvb3QzLmNhbGxiYWNrUHJpb3JpdHkgPSBuZXdDYWxsYmFja1ByaW9yaXR5OwogICAgICAgICAgcm9vdDMuY2FsbGJhY2tOb2RlID0gbmV3Q2FsbGJhY2tOb2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwZXJmb3JtQ29uY3VycmVudFdvcmtPblJvb3Qocm9vdDMsIGRpZFRpbWVvdXQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmVzZXROZXN0ZWRVcGRhdGVGbGFnKCk7CiAgICAgICAgICB9CiAgICAgICAgICBjdXJyZW50RXZlbnRUaW1lID0gTm9UaW1lc3RhbXA7CiAgICAgICAgICBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IE5vTGFuZXM7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIG5vdCBhbHJlYWR5IGJlIHdvcmtpbmcuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgb3JpZ2luYWxDYWxsYmFja05vZGUgPSByb290My5jYWxsYmFja05vZGU7CiAgICAgICAgICB2YXIgZGlkRmx1c2hQYXNzaXZlRWZmZWN0cyA9IGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIGlmIChkaWRGbHVzaFBhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgIGlmIChyb290My5jYWxsYmFja05vZGUgIT09IG9yaWdpbmFsQ2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lcyA9IGdldE5leHRMYW5lcyhyb290Mywgcm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCA/IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzIDogTm9MYW5lcyk7CiAgICAgICAgICBpZiAobGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVGltZVNsaWNlID0gIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcykgJiYgIWluY2x1ZGVzRXhwaXJlZExhbmUocm9vdDMsIGxhbmVzKSAmJiAhZGlkVGltZW91dDsKICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gc2hvdWxkVGltZVNsaWNlID8gcmVuZGVyUm9vdENvbmN1cnJlbnQocm9vdDMsIGxhbmVzKSA6IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICBpZiAoZXhpdFN0YXR1cyAhPT0gUm9vdEluUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RFcnJvcmVkKSB7CiAgICAgICAgICAgICAgdmFyIGVycm9yUmV0cnlMYW5lcyA9IGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKTsKICAgICAgICAgICAgICBpZiAoZXJyb3JSZXRyeUxhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBsYW5lcyA9IGVycm9yUmV0cnlMYW5lczsKICAgICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RGYXRhbEVycm9yZWQpIHsKICAgICAgICAgICAgICB2YXIgZmF0YWxFcnJvciA9IHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgICB0aHJvdyBmYXRhbEVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RGlkTm90Q29tcGxldGUpIHsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHJlbmRlcldhc0NvbmN1cnJlbnQgPSAhaW5jbHVkZXNCbG9ja2luZ0xhbmUocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB2YXIgZmluaXNoZWRXb3JrID0gcm9vdDMuY3VycmVudC5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgaWYgKHJlbmRlcldhc0NvbmN1cnJlbnQgJiYgIWlzUmVuZGVyQ29uc2lzdGVudFdpdGhFeHRlcm5hbFN0b3JlcyhmaW5pc2hlZFdvcmspKSB7CiAgICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICAgICAgICB2YXIgX2Vycm9yUmV0cnlMYW5lcyA9IGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKTsKICAgICAgICAgICAgICAgICAgaWYgKF9lcnJvclJldHJ5TGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgICAgICBsYW5lcyA9IF9lcnJvclJldHJ5TGFuZXM7CiAgICAgICAgICAgICAgICAgICAgZXhpdFN0YXR1cyA9IHJlY292ZXJGcm9tQ29uY3VycmVudEVycm9yKHJvb3QzLCBfZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RGYXRhbEVycm9yZWQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9mYXRhbEVycm9yID0gd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvcjsKICAgICAgICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgICAgICAgICB0aHJvdyBfZmF0YWxFcnJvcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBsYW5lczsKICAgICAgICAgICAgICBmaW5pc2hDb25jdXJyZW50UmVuZGVyKHJvb3QzLCBleGl0U3RhdHVzLCBsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgaWYgKHJvb3QzLmNhbGxiYWNrTm9kZSA9PT0gb3JpZ2luYWxDYWxsYmFja05vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIHBlcmZvcm1Db25jdXJyZW50V29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgZXJyb3JSZXRyeUxhbmVzKSB7CiAgICAgICAgICB2YXIgZXJyb3JzRnJvbUZpcnN0QXR0ZW1wdCA9IHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnM7CiAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgdmFyIHJvb3RXb3JrSW5Qcm9ncmVzcyA9IHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBlcnJvclJldHJ5TGFuZXMpOwogICAgICAgICAgICByb290V29ya0luUHJvZ3Jlc3MuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvckh5ZHJhdGluZ0NvbnRhaW5lcihyb290My5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGV4aXRTdGF0dXMgPSByZW5kZXJSb290U3luYyhyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgIGlmIChleGl0U3RhdHVzICE9PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICB2YXIgZXJyb3JzRnJvbVNlY29uZEF0dGVtcHQgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9yczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMgPSBlcnJvcnNGcm9tRmlyc3RBdHRlbXB0OwogICAgICAgICAgICBpZiAoZXJyb3JzRnJvbVNlY29uZEF0dGVtcHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBxdWV1ZVJlY292ZXJhYmxlRXJyb3JzKGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV4aXRTdGF0dXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlUmVjb3ZlcmFibGVFcnJvcnMoZXJyb3JzMykgewogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gZXJyb3JzMzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLnB1c2guYXBwbHkod29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIGVycm9yczMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5pc2hDb25jdXJyZW50UmVuZGVyKHJvb3QzLCBleGl0U3RhdHVzLCBsYW5lcykgewogICAgICAgICAgc3dpdGNoIChleGl0U3RhdHVzKSB7CiAgICAgICAgICAgIGNhc2UgUm9vdEluUHJvZ3Jlc3M6CiAgICAgICAgICAgIGNhc2UgUm9vdEZhdGFsRXJyb3JlZDogewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUm9vdCBkaWQgbm90IGNvbXBsZXRlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUm9vdEVycm9yZWQ6IHsKICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSb290U3VzcGVuZGVkOiB7CiAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIGlmIChpbmNsdWRlc09ubHlSZXRyaWVzKGxhbmVzKSAmJiAvLyBkbyBub3QgZGVsYXkgaWYgd2UncmUgaW5zaWRlIGFuIGFjdCgpIHNjb3BlCiAgICAgICAgICAgICAgIXNob3VsZEZvcmNlRmx1c2hGYWxsYmFja3NJbkRFVigpKSB7CiAgICAgICAgICAgICAgICB2YXIgbXNVbnRpbFRpbWVvdXQgPSBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lICsgRkFMTEJBQ0tfVEhST1RUTEVfTVMgLSBub3coKTsKICAgICAgICAgICAgICAgIGlmIChtc1VudGlsVGltZW91dCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICAgICAgICBpZiAobmV4dExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIHN1c3BlbmRlZExhbmVzID0gcm9vdDMuc3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgICAgICAgIGlmICghaXNTdWJzZXRPZkxhbmVzKHN1c3BlbmRlZExhbmVzLCBsYW5lcykpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgICAgIG1hcmtSb290UGluZ2VkKHJvb3QzLCBzdXNwZW5kZWRMYW5lcyk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcm9vdDMudGltZW91dEhhbmRsZSA9IHNjaGVkdWxlVGltZW91dChjb21taXRSb290LmJpbmQobnVsbCwgcm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKSwgbXNVbnRpbFRpbWVvdXQpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUm9vdFN1c3BlbmRlZFdpdGhEZWxheTogewogICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNPbmx5VHJhbnNpdGlvbnMobGFuZXMpKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFzaG91bGRGb3JjZUZsdXNoRmFsbGJhY2tzSW5ERVYoKSkgewogICAgICAgICAgICAgICAgdmFyIG1vc3RSZWNlbnRFdmVudFRpbWUgPSBnZXRNb3N0UmVjZW50RXZlbnRUaW1lKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lTXMgPSBtb3N0UmVjZW50RXZlbnRUaW1lOwogICAgICAgICAgICAgICAgdmFyIHRpbWVFbGFwc2VkTXMgPSBub3coKSAtIGV2ZW50VGltZU1zOwogICAgICAgICAgICAgICAgdmFyIF9tc1VudGlsVGltZW91dCA9IGpuZCh0aW1lRWxhcHNlZE1zKSAtIHRpbWVFbGFwc2VkTXM7CiAgICAgICAgICAgICAgICBpZiAoX21zVW50aWxUaW1lb3V0ID4gMTApIHsKICAgICAgICAgICAgICAgICAgcm9vdDMudGltZW91dEhhbmRsZSA9IHNjaGVkdWxlVGltZW91dChjb21taXRSb290LmJpbmQobnVsbCwgcm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKSwgX21zVW50aWxUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RDb21wbGV0ZWQ6IHsKICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biByb290IGV4aXQgc3RhdHVzLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVuZGVyQ29uc2lzdGVudFdpdGhFeHRlcm5hbFN0b3JlcyhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBub2RlID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgaWYgKG5vZGUuZmxhZ3MgJiBTdG9yZUNvbnNpc3RlbmN5KSB7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gbm9kZS51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBjaGVja3MgPSB1cGRhdGVRdWV1ZS5zdG9yZXM7CiAgICAgICAgICAgICAgICBpZiAoY2hlY2tzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hlY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNoZWNrID0gY2hlY2tzW2ldOwogICAgICAgICAgICAgICAgICAgIHZhciBnZXRTbmFwc2hvdCA9IGNoZWNrLmdldFNuYXBzaG90OwogICAgICAgICAgICAgICAgICAgIHZhciByZW5kZXJlZFZhbHVlID0gY2hlY2sudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghb2JqZWN0SXMoZ2V0U25hcHNob3QoKSwgcmVuZGVyZWRWYWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBpZiAobm9kZS5zdWJ0cmVlRmxhZ3MgJiBTdG9yZUNvbnNpc3RlbmN5ICYmIGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gY2hpbGQ7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IGZpbmlzaGVkV29yaykgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RTdXNwZW5kZWQkMShyb290Mywgc3VzcGVuZGVkTGFuZXMpIHsKICAgICAgICAgIHN1c3BlbmRlZExhbmVzID0gcmVtb3ZlTGFuZXMoc3VzcGVuZGVkTGFuZXMsIHdvcmtJblByb2dyZXNzUm9vdFBpbmdlZExhbmVzKTsKICAgICAgICAgIHN1c3BlbmRlZExhbmVzID0gcmVtb3ZlTGFuZXMoc3VzcGVuZGVkTGFuZXMsIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzKTsKICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkKHJvb3QzLCBzdXNwZW5kZWRMYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1TeW5jV29ya09uUm9vdChyb290MykgewogICAgICAgICAgewogICAgICAgICAgICBzeW5jTmVzdGVkVXBkYXRlRmxhZygpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgdmFyIGxhbmVzID0gZ2V0TmV4dExhbmVzKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgIGlmICghaW5jbHVkZXNTb21lTGFuZShsYW5lcywgU3luY0xhbmUpKSB7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGxhbmVzKTsKICAgICAgICAgIGlmIChyb290My50YWcgIT09IExlZ2FjeVJvb3QgJiYgZXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgdmFyIGVycm9yUmV0cnlMYW5lcyA9IGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKTsKICAgICAgICAgICAgaWYgKGVycm9yUmV0cnlMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgIGxhbmVzID0gZXJyb3JSZXRyeUxhbmVzOwogICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3RGYXRhbEVycm9yZWQpIHsKICAgICAgICAgICAgdmFyIGZhdGFsRXJyb3IgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yOwogICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgIHRocm93IGZhdGFsRXJyb3I7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdERpZE5vdENvbXBsZXRlKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUm9vdCBkaWQgbm90IGNvbXBsZXRlLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmN1cnJlbnQuYWx0ZXJuYXRlOwogICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgcm9vdDMuZmluaXNoZWRMYW5lcyA9IGxhbmVzOwogICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hSb290KHJvb3QzLCBsYW5lcykgewogICAgICAgICAgaWYgKGxhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBtZXJnZUxhbmVzKGxhbmVzLCBTeW5jTGFuZSkpOwogICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYXRjaGVkVXBkYXRlcyQxKGZuLCBhKSB7CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBCYXRjaGVkQ29udGV4dDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiBmbihhKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgaWYgKGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCAmJiAvLyBUcmVhdCBgYWN0YCBhcyBpZiBpdCdzIGluc2lkZSBgYmF0Y2hlZFVwZGF0ZXNgLCBldmVuIGluIGxlZ2FjeSBtb2RlLgogICAgICAgICAgICAhUmVhY3RDdXJyZW50QWN0UXVldWUkMS5pc0JhdGNoaW5nTGVnYWN5KSB7CiAgICAgICAgICAgICAgcmVzZXRSZW5kZXJUaW1lcigpOwogICAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrc09ubHlJbkxlZ2FjeU1vZGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNjcmV0ZVVwZGF0ZXMoZm4sIGEsIGIsIGMsIGQpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgcmV0dXJuIGZuKGEsIGIsIGMsIGQpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgaWYgKGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmMoZm4pIHsKICAgICAgICAgIGlmIChyb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyAhPT0gbnVsbCAmJiByb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cy50YWcgPT09IExlZ2FjeVJvb3QgJiYgKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IEJhdGNoZWRDb250ZXh0OwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBpZiAoZm4pIHsKICAgICAgICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0FscmVhZHlSZW5kZXJpbmcoKSB7CiAgICAgICAgICByZXR1cm4gKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoUmVuZGVyTGFuZXMoZmliZXIsIGxhbmVzKSB7CiAgICAgICAgICBwdXNoKHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciwgc3VidHJlZVJlbmRlckxhbmVzLCBmaWJlcik7CiAgICAgICAgICBzdWJ0cmVlUmVuZGVyTGFuZXMgPSBtZXJnZUxhbmVzKHN1YnRyZWVSZW5kZXJMYW5lcywgbGFuZXMpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcywgbGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BSZW5kZXJMYW5lcyhmaWJlcikgewogICAgICAgICAgc3VidHJlZVJlbmRlckxhbmVzID0gc3VidHJlZVJlbmRlckxhbmVzQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICBwb3Aoc3VidHJlZVJlbmRlckxhbmVzQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHRpbWVvdXRIYW5kbGUgPSByb290My50aW1lb3V0SGFuZGxlOwogICAgICAgICAgaWYgKHRpbWVvdXRIYW5kbGUgIT09IG5vVGltZW91dCkgewogICAgICAgICAgICByb290My50aW1lb3V0SGFuZGxlID0gbm9UaW1lb3V0OwogICAgICAgICAgICBjYW5jZWxUaW1lb3V0KHRpbWVvdXRIYW5kbGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBpbnRlcnJ1cHRlZFdvcmsgPSB3b3JrSW5Qcm9ncmVzcy5yZXR1cm47CiAgICAgICAgICAgIHdoaWxlIChpbnRlcnJ1cHRlZFdvcmsgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgY3VycmVudDQgPSBpbnRlcnJ1cHRlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIHVud2luZEludGVycnVwdGVkV29yayhjdXJyZW50NCwgaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBpbnRlcnJ1cHRlZFdvcmsgPSBpbnRlcnJ1cHRlZFdvcmsucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSByb290MzsKICAgICAgICAgIHZhciByb290V29ya0luUHJvZ3Jlc3MgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhyb290My5jdXJyZW50LCBudWxsKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gcm9vdFdvcmtJblByb2dyZXNzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBzdWJ0cmVlUmVuZGVyTGFuZXMgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RJbmNsdWRlZExhbmVzID0gbGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEluUHJvZ3Jlc3M7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gbnVsbDsKICAgICAgICAgIGZpbmlzaFF1ZXVlaW5nQ29uY3VycmVudFVwZGF0ZXMoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZGlzY2FyZFBlbmRpbmdXYXJuaW5ncygpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJvb3RXb3JrSW5Qcm9ncmVzczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlRXJyb3Iocm9vdDMsIHRocm93blZhbHVlKSB7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIHZhciBlcnJvcmVkV29yayA9IHdvcmtJblByb2dyZXNzOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgICAgIHJlc2V0SG9va3NBZnRlclRocm93KCk7CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICAgIGlmIChlcnJvcmVkV29yayA9PT0gbnVsbCB8fCBlcnJvcmVkV29yay5yZXR1cm4gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290RmF0YWxFcnJvcmVkOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvciA9IHRocm93blZhbHVlOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZW5hYmxlUHJvZmlsZXJUaW1lciAmJiBlcnJvcmVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoZXJyb3JlZFdvcmssIHRydWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZW5hYmxlU2NoZWR1bGluZ1Byb2ZpbGVyKSB7CiAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICAgICAgaWYgKHRocm93blZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB0aHJvd25WYWx1ZSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHRocm93blZhbHVlLnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgdmFyIHdha2VhYmxlID0gdGhyb3duVmFsdWU7CiAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRTdXNwZW5kZWQoZXJyb3JlZFdvcmssIHdha2VhYmxlLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50RXJyb3JlZChlcnJvcmVkV29yaywgdGhyb3duVmFsdWUsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3dFeGNlcHRpb24ocm9vdDMsIGVycm9yZWRXb3JrLnJldHVybiwgZXJyb3JlZFdvcmssIHRocm93blZhbHVlLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgY29tcGxldGVVbml0T2ZXb3JrKGVycm9yZWRXb3JrKTsKICAgICAgICAgICAgfSBjYXRjaCAoeWV0QW5vdGhlclRocm93blZhbHVlKSB7CiAgICAgICAgICAgICAgdGhyb3duVmFsdWUgPSB5ZXRBbm90aGVyVGhyb3duVmFsdWU7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzID09PSBlcnJvcmVkV29yayAmJiBlcnJvcmVkV29yayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXJyb3JlZFdvcmsgPSBlcnJvcmVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IGVycm9yZWRXb3JrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcmVkV29yayA9IHdvcmtJblByb2dyZXNzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaERpc3BhdGNoZXIoKSB7CiAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIuY3VycmVudDsKICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMi5jdXJyZW50ID0gQ29udGV4dE9ubHlEaXNwYXRjaGVyOwogICAgICAgICAgaWYgKHByZXZEaXNwYXRjaGVyID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBDb250ZXh0T25seURpc3BhdGNoZXI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpIHsKICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMi5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtDb21taXRUaW1lT2ZGYWxsYmFjaygpIHsKICAgICAgICAgIGdsb2JhbE1vc3RSZWNlbnRGYWxsYmFja1RpbWUgPSBub3coKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1NraXBwZWRVcGRhdGVMYW5lcyhsYW5lKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMgPSBtZXJnZUxhbmVzKGxhbmUsIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckRpZFN1c3BlbmQoKSB7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEluUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RTdXNwZW5kZWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlckRpZFN1c3BlbmREZWxheUlmUG9zc2libGUoKSB7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEluUHJvZ3Jlc3MgfHwgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdFN1c3BlbmRlZCB8fCB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdFN1c3BlbmRlZFdpdGhEZWxheTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IG51bGwgJiYgKGluY2x1ZGVzTm9uSWRsZVdvcmsod29ya0luUHJvZ3Jlc3NSb290U2tpcHBlZExhbmVzKSB8fCBpbmNsdWRlc05vbklkbGVXb3JrKHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzKSkpIHsKICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMSh3b3JrSW5Qcm9ncmVzc1Jvb3QsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyRGlkRXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyAhPT0gUm9vdFN1c3BlbmRlZFdpdGhEZWxheSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdEVycm9yZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID0gW2Vycm9yMl07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzLnB1c2goZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVySGFzTm90U3VzcGVuZGVkWWV0KCkgewogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJSb290U3luYyhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IFJlbmRlckNvbnRleHQ7CiAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBwdXNoRGlzcGF0Y2hlcigpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdCAhPT0gcm9vdDMgfHwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgIT09IGxhbmVzKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgIHZhciBtZW1vaXplZFVwZGF0ZXJzID0gcm9vdDMubWVtb2l6ZWRVcGRhdGVyczsKICAgICAgICAgICAgICAgIGlmIChtZW1vaXplZFVwZGF0ZXJzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgIHJlc3RvcmVQZW5kaW5nVXBkYXRlcnMocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgICAgbWVtb2l6ZWRVcGRhdGVycy5jbGVhcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbW92ZVBlbmRpbmdGaWJlcnNUb01lbW9pemVkKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMgPSBnZXRUcmFuc2l0aW9uc0ZvckxhbmVzKCk7CiAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB3b3JrTG9vcFN5bmMoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBjYXRjaCAodGhyb3duVmFsdWUpIHsKICAgICAgICAgICAgICBoYW5kbGVFcnJvcihyb290MywgdGhyb3duVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgcG9wRGlzcGF0Y2hlcihwcmV2RGlzcGF0Y2hlcik7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgIT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgY29tbWl0IGFuIGluY29tcGxldGUgcm9vdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1JlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1czsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd29ya0xvb3BTeW5jKCkgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHBlcmZvcm1Vbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyUm9vdENvbmN1cnJlbnQocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBSZW5kZXJDb250ZXh0OwogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gcHVzaERpc3BhdGNoZXIoKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IHJvb3QzIHx8IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzICE9PSBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgICBpZiAobWVtb2l6ZWRVcGRhdGVycy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1vdmVQZW5kaW5nRmliZXJzVG9NZW1vaXplZChyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zID0gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcygpOwogICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB3b3JrTG9vcENvbmN1cnJlbnQoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBjYXRjaCAodGhyb3duVmFsdWUpIHsKICAgICAgICAgICAgICBoYW5kbGVFcnJvcihyb290MywgdGhyb3duVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgcG9wRGlzcGF0Y2hlcihwcmV2RGlzcGF0Y2hlcik7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgIT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtSZW5kZXJZaWVsZGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFJvb3RJblByb2dyZXNzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1czsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd29ya0xvb3BDb25jdXJyZW50KCkgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzICE9PSBudWxsICYmICFzaG91bGRZaWVsZCgpKSB7CiAgICAgICAgICAgIHBlcmZvcm1Vbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGVyZm9ybVVuaXRPZldvcmsodW5pdE9mV29yaykgewogICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gdW5pdE9mV29yay5hbHRlcm5hdGU7CiAgICAgICAgICBzZXRDdXJyZW50RmliZXIodW5pdE9mV29yayk7CiAgICAgICAgICB2YXIgbmV4dDsKICAgICAgICAgIGlmICgodW5pdE9mV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgc3RhcnRQcm9maWxlclRpbWVyKHVuaXRPZldvcmspOwogICAgICAgICAgICBuZXh0ID0gYmVnaW5Xb3JrJDEoY3VycmVudDQsIHVuaXRPZldvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEodW5pdE9mV29yaywgdHJ1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuZXh0ID0gYmVnaW5Xb3JrJDEoY3VycmVudDQsIHVuaXRPZldvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgdW5pdE9mV29yay5tZW1vaXplZFByb3BzID0gdW5pdE9mV29yay5wZW5kaW5nUHJvcHM7CiAgICAgICAgICBpZiAobmV4dCA9PT0gbnVsbCkgewogICAgICAgICAgICBjb21wbGV0ZVVuaXRPZldvcmsodW5pdE9mV29yayk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQyLmN1cnJlbnQgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZVVuaXRPZldvcmsodW5pdE9mV29yaykgewogICAgICAgICAgdmFyIGNvbXBsZXRlZFdvcmsgPSB1bml0T2ZXb3JrOwogICAgICAgICAgZG8gewogICAgICAgICAgICB2YXIgY3VycmVudDQgPSBjb21wbGV0ZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgdmFyIHJldHVybkZpYmVyID0gY29tcGxldGVkV29yay5yZXR1cm47CiAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5mbGFncyAmIEluY29tcGxldGUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGNvbXBsZXRlZFdvcmspOwogICAgICAgICAgICAgIHZhciBuZXh0ID0gdm9pZCAwOwogICAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIG5leHQgPSBjb21wbGV0ZVdvcmsoY3VycmVudDQsIGNvbXBsZXRlZFdvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcihjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICAgIG5leHQgPSBjb21wbGV0ZVdvcmsoY3VycmVudDQsIGNvbXBsZXRlZFdvcmssIHN1YnRyZWVSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKGNvbXBsZXRlZFdvcmssIGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICBpZiAobmV4dCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBuZXh0OwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX25leHQgPSB1bndpbmRXb3JrKGN1cnJlbnQ0LCBjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICBpZiAoX25leHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIF9uZXh0LmZsYWdzICY9IEhvc3RFZmZlY3RNYXNrOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBfbmV4dDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKChjb21wbGV0ZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShjb21wbGV0ZWRXb3JrLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB2YXIgYWN0dWFsRHVyYXRpb24gPSBjb21wbGV0ZWRXb3JrLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBhY3R1YWxEdXJhdGlvbiArPSBjaGlsZC5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbiA9IGFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmV0dXJuRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLmZsYWdzIHw9IEluY29tcGxldGU7CiAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3REaWROb3RDb21wbGV0ZTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmdGaWJlciA9IGNvbXBsZXRlZFdvcmsuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmdGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gc2libGluZ0ZpYmVyOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wbGV0ZWRXb3JrID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gY29tcGxldGVkV29yazsKICAgICAgICAgIH0gd2hpbGUgKGNvbXBsZXRlZFdvcmsgIT09IG51bGwpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290Q29tcGxldGVkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRSb290KHJvb3QzLCByZWNvdmVyYWJsZUVycm9ycywgdHJhbnNpdGlvbnMpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1VwZGF0ZUxhbmVQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIGNvbW1pdFJvb3RJbXBsKHJvb3QzLCByZWNvdmVyYWJsZUVycm9ycywgdHJhbnNpdGlvbnMsIHByZXZpb3VzVXBkYXRlTGFuZVByaW9yaXR5KTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNVcGRhdGVMYW5lUHJpb3JpdHkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFJvb3RJbXBsKHJvb3QzLCByZWNvdmVyYWJsZUVycm9ycywgdHJhbnNpdGlvbnMsIHJlbmRlclByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgfSB3aGlsZSAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwpOwogICAgICAgICAgZmx1c2hSZW5kZXJQaGFzZVN0cmljdE1vZGVXYXJuaW5nc0luREVWKCk7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIG5vdCBhbHJlYWR5IGJlIHdvcmtpbmcuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmluaXNoZWRXb3JrID0gcm9vdDMuZmluaXNoZWRXb3JrOwogICAgICAgICAgdmFyIGxhbmVzID0gcm9vdDMuZmluaXNoZWRMYW5lczsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya0NvbW1pdFN0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZpbmlzaGVkV29yayA9PT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0NvbW1pdFN0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAobGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJyb290LmZpbmlzaGVkTGFuZXMgc2hvdWxkIG5vdCBiZSBlbXB0eSBkdXJpbmcgYSBjb21taXQuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByb290My5maW5pc2hlZFdvcmsgPSBudWxsOwogICAgICAgICAgcm9vdDMuZmluaXNoZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrID09PSByb290My5jdXJyZW50KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGNvbW1pdCB0aGUgc2FtZSB0cmVlIGFzIGJlZm9yZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG51bGw7CiAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgICAgdmFyIHJlbWFpbmluZ0xhbmVzID0gbWVyZ2VMYW5lcyhmaW5pc2hlZFdvcmsubGFuZXMsIGZpbmlzaGVkV29yay5jaGlsZExhbmVzKTsKICAgICAgICAgIG1hcmtSb290RmluaXNoZWQocm9vdDMsIHJlbWFpbmluZ0xhbmVzKTsKICAgICAgICAgIGlmIChyb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChmaW5pc2hlZFdvcmsuc3VidHJlZUZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzIHx8IChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBQYXNzaXZlTWFzaykgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgaWYgKCFyb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gdHJhbnNpdGlvbnM7CiAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFjayQxKE5vcm1hbFByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3VidHJlZUhhc0VmZmVjdHMgPSAoZmluaXNoZWRXb3JrLnN1YnRyZWVGbGFncyAmIChCZWZvcmVNdXRhdGlvbk1hc2sgfCBNdXRhdGlvbk1hc2sgfCBMYXlvdXRNYXNrIHwgUGFzc2l2ZU1hc2spKSAhPT0gTm9GbGFnczsKICAgICAgICAgIHZhciByb290SGFzRWZmZWN0ID0gKGZpbmlzaGVkV29yay5mbGFncyAmIChCZWZvcmVNdXRhdGlvbk1hc2sgfCBNdXRhdGlvbk1hc2sgfCBMYXlvdXRNYXNrIHwgUGFzc2l2ZU1hc2spKSAhPT0gTm9GbGFnczsKICAgICAgICAgIGlmIChzdWJ0cmVlSGFzRWZmZWN0cyB8fCByb290SGFzRWZmZWN0KSB7CiAgICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQ29tbWl0Q29udGV4dDsKICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgdmFyIHNob3VsZEZpcmVBZnRlckFjdGl2ZUluc3RhbmNlQmx1cjIgPSBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZWNvcmRDb21taXRUaW1lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWl0TXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmssIGxhbmVzKTsKICAgICAgICAgICAgcmVzZXRBZnRlckNvbW1pdChyb290My5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgcm9vdDMuY3VycmVudCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZChsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWl0TGF5b3V0RWZmZWN0cyhmaW5pc2hlZFdvcmssIHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXF1ZXN0UGFpbnQoKTsKICAgICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcm9vdDMuY3VycmVudCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJlY29yZENvbW1pdFRpbWUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3REaWRIYXZlUGFzc2l2ZUVmZmVjdHMgPSByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0czsKICAgICAgICAgIGlmIChyb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgICByb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyA9IHJvb3QzOwogICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IGxhbmVzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhQYXNzaXZlTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlbWFpbmluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKHJlbWFpbmluZ0xhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFyb290RGlkSGF2ZVBhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKHJvb3QzLmN1cnJlbnQsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgb25Db21taXRSb290KGZpbmlzaGVkV29yay5zdGF0ZU5vZGUsIHJlbmRlclByaW9yaXR5TGV2ZWwpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICByb290My5tZW1vaXplZFVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgb25Db21taXRSb290JDEoKTsKICAgICAgICAgIH0KICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgaWYgKHJlY292ZXJhYmxlRXJyb3JzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBvblJlY292ZXJhYmxlRXJyb3IgPSByb290My5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVjb3ZlcmFibGVFcnJvcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcmVjb3ZlcmFibGVFcnJvciA9IHJlY292ZXJhYmxlRXJyb3JzW2ldOwogICAgICAgICAgICAgIHZhciBjb21wb25lbnRTdGFjayA9IHJlY292ZXJhYmxlRXJyb3Iuc3RhY2s7CiAgICAgICAgICAgICAgdmFyIGRpZ2VzdCA9IHJlY292ZXJhYmxlRXJyb3IuZGlnZXN0OwogICAgICAgICAgICAgIG9uUmVjb3ZlcmFibGVFcnJvcihyZWNvdmVyYWJsZUVycm9yLnZhbHVlLCB7CiAgICAgICAgICAgICAgICBjb21wb25lbnRTdGFjaywKICAgICAgICAgICAgICAgIGRpZ2VzdAogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaGFzVW5jYXVnaHRFcnJvcikgewogICAgICAgICAgICBoYXNVbmNhdWdodEVycm9yID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBlcnJvciQxID0gZmlyc3RVbmNhdWdodEVycm9yOwogICAgICAgICAgICBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgICAgICB0aHJvdyBlcnJvciQxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUocGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMsIFN5bmNMYW5lKSAmJiByb290My50YWcgIT09IExlZ2FjeVJvb3QpIHsKICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgfQogICAgICAgICAgcmVtYWluaW5nTGFuZXMgPSByb290My5wZW5kaW5nTGFuZXM7CiAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZShyZW1haW5pbmdMYW5lcywgU3luY0xhbmUpKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrTmVzdGVkVXBkYXRlU2NoZWR1bGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJvb3QzID09PSByb290V2l0aE5lc3RlZFVwZGF0ZXMpIHsKICAgICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCsrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICByb290V2l0aE5lc3RlZFVwZGF0ZXMgPSByb290MzsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgfQogICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21taXRTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hQYXNzaXZlRWZmZWN0cygpIHsKICAgICAgICAgIGlmIChyb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgcmVuZGVyUHJpb3JpdHkgPSBsYW5lc1RvRXZlbnRQcmlvcml0eShwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyk7CiAgICAgICAgICAgIHZhciBwcmlvcml0eSA9IGxvd2VyRXZlbnRQcmlvcml0eShEZWZhdWx0RXZlbnRQcmlvcml0eSwgcmVuZGVyUHJpb3JpdHkpOwogICAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJpb3JpdHkpOwogICAgICAgICAgICAgIHJldHVybiBmbHVzaFBhc3NpdmVFZmZlY3RzSW1wbCgpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlUGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0cy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgaWYgKCFyb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrJDEoTm9ybWFsUHJpb3JpdHksIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hQYXNzaXZlRWZmZWN0c0ltcGwoKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRyYW5zaXRpb25zID0gcGVuZGluZ1Bhc3NpdmVUcmFuc2l0aW9uczsKICAgICAgICAgIHBlbmRpbmdQYXNzaXZlVHJhbnNpdGlvbnMgPSBudWxsOwogICAgICAgICAgdmFyIHJvb3QzID0gcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lczsKICAgICAgICAgIHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID0gbnVsbDsKICAgICAgICAgIHBlbmRpbmdQYXNzaXZlRWZmZWN0c0xhbmVzID0gTm9MYW5lczsKICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgZmx1c2ggcGFzc2l2ZSBlZmZlY3RzIHdoaWxlIGFscmVhZHkgcmVuZGVyaW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpc0ZsdXNoaW5nUGFzc2l2ZUVmZmVjdHMgPSB0cnVlOwogICAgICAgICAgICBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtQYXNzaXZlRWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQ29tbWl0Q29udGV4dDsKICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0cyhyb290My5jdXJyZW50KTsKICAgICAgICAgIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHMocm9vdDMsIHJvb3QzLmN1cnJlbnQsIGxhbmVzLCB0cmFuc2l0aW9ucyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwcm9maWxlckVmZmVjdHMgPSBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0czsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHMgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9maWxlckVmZmVjdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyID0gcHJvZmlsZXJFZmZlY3RzW2ldOwogICAgICAgICAgICAgIGNvbW1pdFBhc3NpdmVFZmZlY3REdXJhdGlvbnMocm9vdDMsIF9maWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1Bhc3NpdmVFZmZlY3RzU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBjb21taXREb3VibGVJbnZva2VFZmZlY3RzSW5ERVYocm9vdDMuY3VycmVudCwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBpZiAocm9vdDMgPT09IHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMpIHsKICAgICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCsrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgICAgcm9vdFdpdGhQYXNzaXZlTmVzdGVkVXBkYXRlcyA9IHJvb3QzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgICBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBvblBvc3RDb21taXRSb290KHJvb3QzKTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IHJvb3QzLmN1cnJlbnQuc3RhdGVOb2RlOwogICAgICAgICAgICBzdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgICBzdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0FscmVhZHlGYWlsZWRMZWdhY3lFcnJvckJvdW5kYXJ5KGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQgIT09IG51bGwgJiYgbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQuaGFzKGluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0xlZ2FjeUVycm9yQm91bmRhcnlBc0ZhaWxlZChpbnN0YW5jZSkgewogICAgICAgICAgaWYgKGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID09PSBudWxsKSB7CiAgICAgICAgICAgIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW2luc3RhbmNlXSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZC5hZGQoaW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9UaHJvd1VuY2F1Z2h0RXJyb3IoZXJyb3IyKSB7CiAgICAgICAgICBpZiAoIWhhc1VuY2F1Z2h0RXJyb3IpIHsKICAgICAgICAgICAgaGFzVW5jYXVnaHRFcnJvciA9IHRydWU7CiAgICAgICAgICAgIGZpcnN0VW5jYXVnaHRFcnJvciA9IGVycm9yMjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG9uVW5jYXVnaHRFcnJvciA9IHByZXBhcmVUb1Rocm93VW5jYXVnaHRFcnJvcjsKICAgICAgICBmdW5jdGlvbiBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvck9uUm9vdChyb290RmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvcjIpIHsKICAgICAgICAgIHZhciBlcnJvckluZm8gPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihlcnJvcjIsIHNvdXJjZUZpYmVyKTsKICAgICAgICAgIHZhciB1cGRhdGUgPSBjcmVhdGVSb290RXJyb3JVcGRhdGUocm9vdEZpYmVyLCBlcnJvckluZm8sIFN5bmNMYW5lKTsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUocm9vdEZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBTeW5jTGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihzb3VyY2VGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IkMSkgewogICAgICAgICAgewogICAgICAgICAgICByZXBvcnRVbmNhdWdodEVycm9ySW5ERVYoZXJyb3IkMSk7CiAgICAgICAgICAgIHNldElzUnVubmluZ0luc2VydGlvbkVmZmVjdChmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc291cmNlRmliZXIudGFnID09PSBIb3N0Um9vdCkgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvck9uUm9vdChzb3VyY2VGaWJlciwgc291cmNlRmliZXIsIGVycm9yJDEpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlciA9IG5lYXJlc3RNb3VudGVkQW5jZXN0b3I7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvck9uUm9vdChmaWJlciwgc291cmNlRmliZXIsIGVycm9yJDEpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfSBlbHNlIGlmIChmaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIGN0b3IgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRDYXRjaCA9PT0gImZ1bmN0aW9uIiAmJiAhaXNBbHJlYWR5RmFpbGVkTGVnYWN5RXJyb3JCb3VuZGFyeShpbnN0YW5jZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvckluZm8gPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihlcnJvciQxLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlQ2xhc3NFcnJvclVwZGF0ZShmaWJlciwgZXJyb3JJbmZvLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGZpYmVyLCB1cGRhdGUsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBTeW5jTGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIkludGVybmFsIFJlYWN0IGVycm9yOiBBdHRlbXB0ZWQgdG8gY2FwdHVyZSBhIGNvbW1pdCBwaGFzZSBlcnJvciBpbnNpZGUgYSBkZXRhY2hlZCB0cmVlLiBUaGlzIGluZGljYXRlcyBhIGJ1ZyBpbiBSZWFjdC4gTGlrZWx5IGNhdXNlcyBpbmNsdWRlIGRlbGV0aW5nIHRoZSBzYW1lIGZpYmVyIG1vcmUgdGhhbiBvbmNlLCBjb21taXR0aW5nIGFuIGFscmVhZHktZmluaXNoZWQgdHJlZSwgb3IgYW4gaW5jb25zaXN0ZW50IHJldHVybiBwb2ludGVyLlxuXG5FcnJvciBtZXNzYWdlOlxuXG4lcyIsIGVycm9yJDEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwaW5nU3VzcGVuZGVkUm9vdChyb290Mywgd2FrZWFibGUsIHBpbmdlZExhbmVzKSB7CiAgICAgICAgICB2YXIgcGluZ0NhY2hlID0gcm9vdDMucGluZ0NhY2hlOwogICAgICAgICAgaWYgKHBpbmdDYWNoZSAhPT0gbnVsbCkgewogICAgICAgICAgICBwaW5nQ2FjaGUuZGVsZXRlKHdha2VhYmxlKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICBtYXJrUm9vdFBpbmdlZChyb290MywgcGluZ2VkTGFuZXMpOwogICAgICAgICAgd2FybklmU3VzcGVuc2VSZXNvbHV0aW9uTm90V3JhcHBlZFdpdGhBY3RERVYocm9vdDMpOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdCA9PT0gcm9vdDMgJiYgaXNTdWJzZXRPZkxhbmVzKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzLCBwaW5nZWRMYW5lcykpIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkgfHwgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdFN1c3BlbmRlZCAmJiBpbmNsdWRlc09ubHlSZXRyaWVzKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKSAmJiBub3coKSAtIGdsb2JhbE1vc3RSZWNlbnRGYWxsYmFja1RpbWUgPCBGQUxMQkFDS19USFJPVFRMRV9NUykgewogICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMsIHBpbmdlZExhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeVRpbWVkT3V0Qm91bmRhcnkoYm91bmRhcnlGaWJlciwgcmV0cnlMYW5lKSB7CiAgICAgICAgICBpZiAocmV0cnlMYW5lID09PSBOb0xhbmUpIHsKICAgICAgICAgICAgcmV0cnlMYW5lID0gcmVxdWVzdFJldHJ5TGFuZShib3VuZGFyeUZpYmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoYm91bmRhcnlGaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIHJldHJ5TGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIpIHsKICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gYm91bmRhcnlGaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgdmFyIHJldHJ5TGFuZSA9IE5vTGFuZTsKICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHJ5TGFuZSA9IHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVSZXRyeVdha2VhYmxlKGJvdW5kYXJ5RmliZXIsIHdha2VhYmxlKSB7CiAgICAgICAgICB2YXIgcmV0cnlMYW5lID0gTm9MYW5lOwogICAgICAgICAgdmFyIHJldHJ5Q2FjaGU7CiAgICAgICAgICBzd2l0Y2ggKGJvdW5kYXJ5RmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0cnlDYWNoZSA9IGJvdW5kYXJ5RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gYm91bmRhcnlGaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXRyeUxhbmUgPSBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIHJldHJ5Q2FjaGUgPSBib3VuZGFyeUZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBpbmdlZCB1bmtub3duIHN1c3BlbnNlIGJvdW5kYXJ5IHR5cGUuIFRoaXMgaXMgcHJvYmFibHkgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmV0cnlDYWNoZSAhPT0gbnVsbCkgewogICAgICAgICAgICByZXRyeUNhY2hlLmRlbGV0ZSh3YWtlYWJsZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXRyeVRpbWVkT3V0Qm91bmRhcnkoYm91bmRhcnlGaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gam5kKHRpbWVFbGFwc2VkKSB7CiAgICAgICAgICByZXR1cm4gdGltZUVsYXBzZWQgPCAxMjAgPyAxMjAgOiB0aW1lRWxhcHNlZCA8IDQ4MCA/IDQ4MCA6IHRpbWVFbGFwc2VkIDwgMTA4MCA/IDEwODAgOiB0aW1lRWxhcHNlZCA8IDE5MjAgPyAxOTIwIDogdGltZUVsYXBzZWQgPCAzZTMgPyAzZTMgOiB0aW1lRWxhcHNlZCA8IDQzMjAgPyA0MzIwIDogY2VpbCh0aW1lRWxhcHNlZCAvIDE5NjApICogMTk2MDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tGb3JOZXN0ZWRVcGRhdGVzKCkgewogICAgICAgICAgaWYgKG5lc3RlZFVwZGF0ZUNvdW50ID4gTkVTVEVEX1VQREFURV9MSU1JVCkgewogICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgIHJvb3RXaXRoTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTWF4aW11bSB1cGRhdGUgZGVwdGggZXhjZWVkZWQuIFRoaXMgY2FuIGhhcHBlbiB3aGVuIGEgY29tcG9uZW50IHJlcGVhdGVkbHkgY2FsbHMgc2V0U3RhdGUgaW5zaWRlIGNvbXBvbmVudFdpbGxVcGRhdGUgb3IgY29tcG9uZW50RGlkVXBkYXRlLiBSZWFjdCBsaW1pdHMgdGhlIG51bWJlciBvZiBuZXN0ZWQgdXBkYXRlcyB0byBwcmV2ZW50IGluZmluaXRlIGxvb3BzLiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAobmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID4gTkVTVEVEX1BBU1NJVkVfVVBEQVRFX0xJTUlUKSB7CiAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICAgICAgICBlcnJvcigiTWF4aW11bSB1cGRhdGUgZGVwdGggZXhjZWVkZWQuIFRoaXMgY2FuIGhhcHBlbiB3aGVuIGEgY29tcG9uZW50IGNhbGxzIHNldFN0YXRlIGluc2lkZSB1c2VFZmZlY3QsIGJ1dCB1c2VFZmZlY3QgZWl0aGVyIGRvZXNuJ3QgaGF2ZSBhIGRlcGVuZGVuY3kgYXJyYXksIG9yIG9uZSBvZiB0aGUgZGVwZW5kZW5jaWVzIGNoYW5nZXMgb24gZXZlcnkgcmVuZGVyLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUmVuZGVyUGhhc2VTdHJpY3RNb2RlV2FybmluZ3NJbkRFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hMZWdhY3lDb250ZXh0V2FybmluZygpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXREb3VibGVJbnZva2VFZmZlY3RzSW5ERVYoZmliZXIsIGhhc1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRMYXlvdXREZXYsIGludm9rZUxheW91dEVmZmVjdFVubW91bnRJbkRFVik7CiAgICAgICAgICAgIGlmIChoYXNQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRQYXNzaXZlRGV2LCBpbnZva2VQYXNzaXZlRWZmZWN0VW5tb3VudEluREVWKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50TGF5b3V0RGV2LCBpbnZva2VMYXlvdXRFZmZlY3RNb3VudEluREVWKTsKICAgICAgICAgICAgaWYgKGhhc1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgaW52b2tlRWZmZWN0c0luRGV2KGZpYmVyLCBNb3VudFBhc3NpdmVEZXYsIGludm9rZVBhc3NpdmVFZmZlY3RNb3VudEluREVWKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnZva2VFZmZlY3RzSW5EZXYoZmlyc3RDaGlsZCwgZmliZXJGbGFncywgaW52b2tlRWZmZWN0Rm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgdmFyIHN1YnRyZWVSb290ID0gbnVsbDsKICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByaW1hcnlTdWJ0cmVlRmxhZyA9IGN1cnJlbnQ0LnN1YnRyZWVGbGFncyAmIGZpYmVyRmxhZ3M7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBzdWJ0cmVlUm9vdCAmJiBjdXJyZW50NC5jaGlsZCAhPT0gbnVsbCAmJiBwcmltYXJ5U3VidHJlZUZsYWcgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnQ0ID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICgoY3VycmVudDQuZmxhZ3MgJiBmaWJlckZsYWdzKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICBpbnZva2VFZmZlY3RGbihjdXJyZW50NCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQuc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjdXJyZW50NCA9IGN1cnJlbnQ0LnNpYmxpbmc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXJyZW50NCA9IHN1YnRyZWVSb290ID0gY3VycmVudDQucmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gd2FybkFib3V0VXBkYXRlT25Ob3RZZXRNb3VudGVkRmliZXJJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiBSZW5kZXJDb250ZXh0KSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghKGZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHRhZyA9IGZpYmVyLnRhZzsKICAgICAgICAgICAgaWYgKHRhZyAhPT0gSW5kZXRlcm1pbmF0ZUNvbXBvbmVudCAmJiB0YWcgIT09IEhvc3RSb290ICYmIHRhZyAhPT0gQ2xhc3NDb21wb25lbnQgJiYgdGFnICE9PSBGdW5jdGlvbkNvbXBvbmVudCAmJiB0YWcgIT09IEZvcndhcmRSZWYyICYmIHRhZyAhPT0gTWVtb0NvbXBvbmVudCAmJiB0YWcgIT09IFNpbXBsZU1lbW9Db21wb25lbnQpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiUmVhY3RDb21wb25lbnQiOwogICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50Lmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50LmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkaWRXYXJuU3RhdGVVcGRhdGVGb3JOb3RZZXRNb3VudGVkQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW2NvbXBvbmVudE5hbWVdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldmlvdXNGaWJlciA9IGN1cnJlbnQzOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgZXJyb3IoIkNhbid0IHBlcmZvcm0gYSBSZWFjdCBzdGF0ZSB1cGRhdGUgb24gYSBjb21wb25lbnQgdGhhdCBoYXNuJ3QgbW91bnRlZCB5ZXQuIFRoaXMgaW5kaWNhdGVzIHRoYXQgeW91IGhhdmUgYSBzaWRlLWVmZmVjdCBpbiB5b3VyIHJlbmRlciBmdW5jdGlvbiB0aGF0IGFzeW5jaHJvbm91c2x5IGxhdGVyIGNhbGxzIHRyaWVzIHRvIHVwZGF0ZSB0aGUgY29tcG9uZW50LiBNb3ZlIHRoaXMgd29yayB0byB1c2VFZmZlY3QgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlcikgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGJlZ2luV29yayQxOwogICAgICAgIHsKICAgICAgICAgIHZhciBkdW1teUZpYmVyID0gbnVsbDsKICAgICAgICAgIGJlZ2luV29yayQxID0gZnVuY3Rpb24oY3VycmVudDQsIHVuaXRPZldvcmssIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBvcmlnaW5hbFdvcmtJblByb2dyZXNzQ29weSA9IGFzc2lnbkZpYmVyUHJvcGVydGllc0luREVWKGR1bW15RmliZXIsIHVuaXRPZldvcmspOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHJldHVybiBiZWdpbldvcmsoY3VycmVudDQsIHVuaXRPZldvcmssIGxhbmVzKTsKICAgICAgICAgICAgfSBjYXRjaCAob3JpZ2luYWxFcnJvcikgewogICAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kT3JFcnJvcldoaWxlSHlkcmF0aW5nREVWKCkgfHwgb3JpZ2luYWxFcnJvciAhPT0gbnVsbCAmJiB0eXBlb2Ygb3JpZ2luYWxFcnJvciA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdGhyb3cgb3JpZ2luYWxFcnJvcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVzZXRDb250ZXh0RGVwZW5kZW5jaWVzKCk7CiAgICAgICAgICAgICAgcmVzZXRIb29rc0FmdGVyVGhyb3coKTsKICAgICAgICAgICAgICB1bndpbmRJbnRlcnJ1cHRlZFdvcmsoY3VycmVudDQsIHVuaXRPZldvcmspOwogICAgICAgICAgICAgIGFzc2lnbkZpYmVyUHJvcGVydGllc0luREVWKHVuaXRPZldvcmssIG9yaWdpbmFsV29ya0luUHJvZ3Jlc3NDb3B5KTsKICAgICAgICAgICAgICBpZiAodW5pdE9mV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcih1bml0T2ZXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaW52b2tlR3VhcmRlZENhbGxiYWNrKG51bGwsIGJlZ2luV29yaywgbnVsbCwgY3VycmVudDQsIHVuaXRPZldvcmssIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaGFzQ2F1Z2h0RXJyb3IoKSkgewogICAgICAgICAgICAgICAgdmFyIHJlcGxheUVycm9yID0gY2xlYXJDYXVnaHRFcnJvcigpOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXBsYXlFcnJvciA9PT0gIm9iamVjdCIgJiYgcmVwbGF5RXJyb3IgIT09IG51bGwgJiYgcmVwbGF5RXJyb3IuX3N1cHByZXNzTG9nZ2luZyAmJiB0eXBlb2Ygb3JpZ2luYWxFcnJvciA9PT0gIm9iamVjdCIgJiYgb3JpZ2luYWxFcnJvciAhPT0gbnVsbCAmJiAhb3JpZ2luYWxFcnJvci5fc3VwcHJlc3NMb2dnaW5nKSB7CiAgICAgICAgICAgICAgICAgIG9yaWdpbmFsRXJyb3IuX3N1cHByZXNzTG9nZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93IG9yaWdpbmFsRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlciA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlckZvckFub3RoZXJDb21wb25lbnQ7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkFib3V0UmVuZGVyUGhhc2VVcGRhdGVzSW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzUmVuZGVyaW5nICYmICFnZXRJc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlSW5ERVYoKSkgewogICAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyaW5nQ29tcG9uZW50TmFtZSA9IHdvcmtJblByb2dyZXNzICYmIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIod29ya0luUHJvZ3Jlc3MpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICAgICAgdmFyIGRlZHVwZUtleSA9IHJlbmRlcmluZ0NvbXBvbmVudE5hbWU7CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50LmhhcyhkZWR1cGVLZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50LmFkZChkZWR1cGVLZXkpOwogICAgICAgICAgICAgICAgICAgIHZhciBzZXRTdGF0ZUNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCB1cGRhdGUgYSBjb21wb25lbnQgKGAlc2ApIHdoaWxlIHJlbmRlcmluZyBhIGRpZmZlcmVudCBjb21wb25lbnQgKGAlc2ApLiBUbyBsb2NhdGUgdGhlIGJhZCBzZXRTdGF0ZSgpIGNhbGwgaW5zaWRlIGAlc2AsIGZvbGxvdyB0aGUgc3RhY2sgdHJhY2UgYXMgZGVzY3JpYmVkIGluIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zZXRzdGF0ZS1pbi1yZW5kZXIiLCBzZXRTdGF0ZUNvbXBvbmVudE5hbWUsIHJlbmRlcmluZ0NvbXBvbmVudE5hbWUsIHJlbmRlcmluZ0NvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCB1cGRhdGUgZHVyaW5nIGFuIGV4aXN0aW5nIHN0YXRlIHRyYW5zaXRpb24gKHN1Y2ggYXMgd2l0aGluIGByZW5kZXJgKS4gUmVuZGVyIG1ldGhvZHMgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIik7CiAgICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgbWVtb2l6ZWRVcGRhdGVycy5mb3JFYWNoKGZ1bmN0aW9uKHNjaGVkdWxpbmdGaWJlcikgewogICAgICAgICAgICAgICAgYWRkRmliZXJUb0xhbmVzTWFwKHJvb3QzLCBzY2hlZHVsaW5nRmliZXIsIGxhbmVzKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZmFrZUFjdENhbGxiYWNrTm9kZSA9IHt9OwogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlQ2FsbGJhY2skMShwcmlvcml0eUxldmVsLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgYWN0UXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChhY3RRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGFjdFF1ZXVlLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgICAgIHJldHVybiBmYWtlQWN0Q2FsbGJhY2tOb2RlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBzY2hlZHVsZUNhbGxiYWNrKHByaW9yaXR5TGV2ZWwsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5jZWxDYWxsYmFjayQxKGNhbGxiYWNrTm9kZSkgewogICAgICAgICAgaWYgKGNhbGxiYWNrTm9kZSA9PT0gZmFrZUFjdENhbGxiYWNrTm9kZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2FuY2VsQ2FsbGJhY2soY2FsbGJhY2tOb2RlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkRm9yY2VGbHVzaEZhbGxiYWNrc0luREVWKCkgewogICAgICAgICAgcmV0dXJuIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCAhPT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmVXBkYXRlc05vdFdyYXBwZWRXaXRoQWN0REVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICBpZiAoIWlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKCFpc0xlZ2FjeUFjdEVudmlyb25tZW50KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGV4ZWN1dGlvbkNvbnRleHQgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBGdW5jdGlvbkNvbXBvbmVudCAmJiBmaWJlci50YWcgIT09IEZvcndhcmRSZWYyICYmIGZpYmVyLnRhZyAhPT0gU2ltcGxlTWVtb0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50MzsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICAgIGVycm9yKCJBbiB1cGRhdGUgdG8gJXMgaW5zaWRlIGEgdGVzdCB3YXMgbm90IHdyYXBwZWQgaW4gYWN0KC4uLikuXG5cbldoZW4gdGVzdGluZywgY29kZSB0aGF0IGNhdXNlcyBSZWFjdCBzdGF0ZSB1cGRhdGVzIHNob3VsZCBiZSB3cmFwcGVkIGludG8gYWN0KC4uLik6XG5cbmFjdCgoKSA9PiB7XG4gIC8qIGZpcmUgZXZlbnRzIHRoYXQgdXBkYXRlIHN0YXRlICovXG59KTtcbi8qIGFzc2VydCBvbiB0aGUgb3V0cHV0ICovXG5cblRoaXMgZW5zdXJlcyB0aGF0IHlvdSdyZSB0ZXN0aW5nIHRoZSBiZWhhdmlvciB0aGUgdXNlciB3b3VsZCBzZWUgaW4gdGhlIGJyb3dzZXIuIExlYXJuIG1vcmUgYXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dyYXAtdGVzdHMtd2l0aC1hY3QiLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0ZpYmVyKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZTdXNwZW5zZVJlc29sdXRpb25Ob3RXcmFwcGVkV2l0aEFjdERFVihyb290MykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocm9vdDMudGFnICE9PSBMZWdhY3lSb290ICYmIGlzQ29uY3VycmVudEFjdEVudmlyb25tZW50KCkgJiYgUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgc3VzcGVuZGVkIHJlc291cmNlIGZpbmlzaGVkIGxvYWRpbmcgaW5zaWRlIGEgdGVzdCwgYnV0IHRoZSBldmVudCB3YXMgbm90IHdyYXBwZWQgaW4gYWN0KC4uLikuXG5cbldoZW4gdGVzdGluZywgY29kZSB0aGF0IHJlc29sdmVzIHN1c3BlbmRlZCBkYXRhIHNob3VsZCBiZSB3cmFwcGVkIGludG8gYWN0KC4uLik6XG5cbmFjdCgoKSA9PiB7XG4gIC8qIGZpbmlzaCBsb2FkaW5nIHN1c3BlbmRlZCBkYXRhICovXG59KTtcbi8qIGFzc2VydCBvbiB0aGUgb3V0cHV0ICovXG5cblRoaXMgZW5zdXJlcyB0aGF0IHlvdSdyZSB0ZXN0aW5nIHRoZSBiZWhhdmlvciB0aGUgdXNlciB3b3VsZCBzZWUgaW4gdGhlIGJyb3dzZXIuIExlYXJuIG1vcmUgYXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dyYXAtdGVzdHMtd2l0aC1hY3QiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoaXNSdW5uaW5nKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCA9IGlzUnVubmluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlc29sdmVGYW1pbHkgPSBudWxsOwogICAgICAgIHZhciBmYWlsZWRCb3VuZGFyaWVzID0gbnVsbDsKICAgICAgICB2YXIgc2V0UmVmcmVzaEhhbmRsZXIgPSBmdW5jdGlvbihoYW5kbGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJlc29sdmVGYW1pbHkgPSBoYW5kbGVyOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseSh0eXBlKTsKICAgICAgICAgICAgaWYgKGZhbWlseSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbWlseS5jdXJyZW50OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcodHlwZSkgewogICAgICAgICAgcmV0dXJuIHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUZvcndhcmRSZWZGb3JIb3RSZWxvYWRpbmcodHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBmYW1pbHkgPSByZXNvbHZlRmFtaWx5KHR5cGUpOwogICAgICAgICAgICBpZiAoZmFtaWx5ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZiAodHlwZSAhPT0gbnVsbCAmJiB0eXBlICE9PSB2b2lkIDAgJiYgdHlwZW9mIHR5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFJlbmRlciA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlLnJlbmRlcik7CiAgICAgICAgICAgICAgICBpZiAodHlwZS5yZW5kZXIgIT09IGN1cnJlbnRSZW5kZXIpIHsKICAgICAgICAgICAgICAgICAgdmFyIHN5bnRoZXRpY1R5cGUgPSB7CiAgICAgICAgICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyLAogICAgICAgICAgICAgICAgICAgIHJlbmRlcjogY3VycmVudFJlbmRlcgogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICBpZiAodHlwZS5kaXNwbGF5TmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgc3ludGhldGljVHlwZS5kaXNwbGF5TmFtZSA9IHR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY1R5cGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYW1pbHkuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDb21wYXRpYmxlRmFtaWx5Rm9ySG90UmVsb2FkaW5nKGZpYmVyLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcmV2VHlwZSA9IGZpYmVyLmVsZW1lbnRUeXBlOwogICAgICAgICAgICB2YXIgbmV4dFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgIHZhciBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IGZhbHNlOwogICAgICAgICAgICB2YXIgJCR0eXBlb2ZOZXh0VHlwZSA9IHR5cGVvZiBuZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgbmV4dFR5cGUgIT09IG51bGwgPyBuZXh0VHlwZS4kJHR5cGVvZiA6IG51bGw7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0VHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0VHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjogewogICAgICAgICAgICAgICAgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzQ29tcGFyZUZhbWlsaWVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoJCR0eXBlb2ZOZXh0VHlwZSA9PT0gUkVBQ1RfTUVNT19UWVBFMikgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobmVlZHNDb21wYXJlRmFtaWxpZXMpIHsKICAgICAgICAgICAgICB2YXIgcHJldkZhbWlseSA9IHJlc29sdmVGYW1pbHkocHJldlR5cGUpOwogICAgICAgICAgICAgIGlmIChwcmV2RmFtaWx5ICE9PSB2b2lkIDAgJiYgcHJldkZhbWlseSA9PT0gcmVzb2x2ZUZhbWlseShuZXh0VHlwZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtGYWlsZWRFcnJvckJvdW5kYXJ5Rm9ySG90UmVsb2FkaW5nKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgV2Vha1NldCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmFpbGVkQm91bmRhcmllcyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGZhaWxlZEJvdW5kYXJpZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmYWlsZWRCb3VuZGFyaWVzLmFkZChmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBzY2hlZHVsZVJlZnJlc2ggPSBmdW5jdGlvbihyb290MywgdXBkYXRlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdGFsZUZhbWlsaWVzID0gdXBkYXRlLnN0YWxlRmFtaWxpZXMsIHVwZGF0ZWRGYW1pbGllcyA9IHVwZGF0ZS51cGRhdGVkRmFtaWxpZXM7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgZmx1c2hTeW5jKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkocm9vdDMuY3VycmVudCwgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB2YXIgc2NoZWR1bGVSb290ID0gZnVuY3Rpb24ocm9vdDMsIGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJvb3QzLmNvbnRleHQgIT09IGVtcHR5Q29udGV4dE9iamVjdCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB1cGRhdGVDb250YWluZXIoZWxlbWVudCwgcm9vdDMsIG51bGwsIG51bGwpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkoZmliZXIsIHVwZGF0ZWRGYW1pbGllcywgc3RhbGVGYW1pbGllcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlLCBjaGlsZCA9IGZpYmVyLmNoaWxkLCBzaWJsaW5nID0gZmliZXIuc2libGluZywgdGFnID0gZmliZXIudGFnLCB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgdmFyIGNhbmRpZGF0ZVR5cGUgPSBudWxsOwogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZS5yZW5kZXI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgcmVzb2x2ZUZhbWlseSB0byBiZSBzZXQgZHVyaW5nIGhvdCByZWxvYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5lZWRzUmVuZGVyID0gZmFsc2U7CiAgICAgICAgICAgIHZhciBuZWVkc1JlbW91bnQgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZVR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseShjYW5kaWRhdGVUeXBlKTsKICAgICAgICAgICAgICBpZiAoZmFtaWx5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGlmIChzdGFsZUZhbWlsaWVzLmhhcyhmYW1pbHkpKSB7CiAgICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHVwZGF0ZWRGYW1pbGllcy5oYXMoZmFtaWx5KSkgewogICAgICAgICAgICAgICAgICBpZiAodGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmVlZHNSZW5kZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmYWlsZWRCb3VuZGFyaWVzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKGZhaWxlZEJvdW5kYXJpZXMuaGFzKGZpYmVyKSB8fCBhbHRlcm5hdGUgIT09IG51bGwgJiYgZmFpbGVkQm91bmRhcmllcy5oYXMoYWx0ZXJuYXRlKSkgewogICAgICAgICAgICAgICAgbmVlZHNSZW1vdW50ID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lZWRzUmVtb3VudCkgewogICAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z05lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lZWRzUmVtb3VudCB8fCBuZWVkc1JlbmRlcikgewogICAgICAgICAgICAgIHZhciBfcm9vdCA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgIGlmIChfcm9vdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKF9yb290LCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsICYmICFuZWVkc1JlbW91bnQpIHsKICAgICAgICAgICAgICBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KGNoaWxkLCB1cGRhdGVkRmFtaWxpZXMsIHN0YWxlRmFtaWxpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVGaWJlcnNXaXRoRmFtaWxpZXNSZWN1cnNpdmVseShzaWJsaW5nLCB1cGRhdGVkRmFtaWxpZXMsIHN0YWxlRmFtaWxpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBmaW5kSG9zdEluc3RhbmNlc0ZvclJlZnJlc2ggPSBmdW5jdGlvbihyb290MywgZmFtaWxpZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvc3RJbnN0YW5jZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB2YXIgdHlwZXMgPSBuZXcgU2V0KGZhbWlsaWVzLm1hcChmdW5jdGlvbihmYW1pbHkpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFtaWx5LmN1cnJlbnQ7CiAgICAgICAgICAgIH0pKTsKICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KHJvb3QzLmN1cnJlbnQsIHR5cGVzLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgcmV0dXJuIGhvc3RJbnN0YW5jZXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlc0Zvck1hdGNoaW5nRmliZXJzUmVjdXJzaXZlbHkoZmliZXIsIHR5cGVzLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkLCBzaWJsaW5nID0gZmliZXIuc2libGluZywgdGFnID0gZmliZXIudGFnLCB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgdmFyIGNhbmRpZGF0ZVR5cGUgPSBudWxsOwogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgICBjYW5kaWRhdGVUeXBlID0gdHlwZS5yZW5kZXI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGlkTWF0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZVR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodHlwZXMuaGFzKGNhbmRpZGF0ZVR5cGUpKSB7CiAgICAgICAgICAgICAgICBkaWRNYXRjaCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaWRNYXRjaCkgewogICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yRmliZXJTaGFsbG93bHkoZmliZXIsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KGNoaWxkLCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KHNpYmxpbmcsIHR5cGVzLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmb3VuZEhvc3RJbnN0YW5jZXMgPSBmaW5kQ2hpbGRIb3N0SW5zdGFuY2VzRm9yRmliZXJTaGFsbG93bHkoZmliZXIsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICBpZiAoZm91bmRIb3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChub2RlLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIGhvc3RJbnN0YW5jZXMuYWRkKG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byByZWFjaCByb290IGZpcnN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZENoaWxkSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBub2RlID0gZmliZXI7CiAgICAgICAgICAgIHZhciBmb3VuZEhvc3RJbnN0YW5jZXMgPSBmYWxzZTsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgIGZvdW5kSG9zdEluc3RhbmNlcyA9IHRydWU7CiAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBub2RlLmNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZmliZXIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmb3VuZEhvc3RJbnN0YW5jZXM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gZmliZXIpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvdW5kSG9zdEluc3RhbmNlczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIG5vZGUgPSBub2RlLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc0JhZE1hcFBvbHlmaWxsOwogICAgICAgIHsKICAgICAgICAgIGhhc0JhZE1hcFBvbHlmaWxsID0gZmFsc2U7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgbm9uRXh0ZW5zaWJsZU9iamVjdCA9IE9iamVjdC5wcmV2ZW50RXh0ZW5zaW9ucyh7fSk7CiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKFtbbm9uRXh0ZW5zaWJsZU9iamVjdCwgbnVsbF1dKTsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovIG5ldyBTZXQoW25vbkV4dGVuc2libGVPYmplY3RdKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaGFzQmFkTWFwUG9seWZpbGwgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBGaWJlck5vZGUodGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSkgewogICAgICAgICAgdGhpcy50YWcgPSB0YWc7CiAgICAgICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgICAgIHRoaXMuZWxlbWVudFR5cGUgPSBudWxsOwogICAgICAgICAgdGhpcy50eXBlID0gbnVsbDsKICAgICAgICAgIHRoaXMuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgIHRoaXMucmV0dXJuID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2hpbGQgPSBudWxsOwogICAgICAgICAgdGhpcy5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgIHRoaXMuaW5kZXggPSAwOwogICAgICAgICAgdGhpcy5yZWYgPSBudWxsOwogICAgICAgICAgdGhpcy5wZW5kaW5nUHJvcHMgPSBwZW5kaW5nUHJvcHM7CiAgICAgICAgICB0aGlzLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgdGhpcy51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICB0aGlzLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgdGhpcy5kZXBlbmRlbmNpZXMgPSBudWxsOwogICAgICAgICAgdGhpcy5tb2RlID0gbW9kZTsKICAgICAgICAgIHRoaXMuZmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgdGhpcy5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgdGhpcy5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgdGhpcy5sYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmNoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICB0aGlzLmFjdHVhbER1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy5hY3R1YWxTdGFydFRpbWUgPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLnNlbGZCYXNlRHVyYXRpb24gPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLnRyZWVCYXNlRHVyYXRpb24gPSBOdW1iZXIuTmFOOwogICAgICAgICAgICB0aGlzLmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgdGhpcy5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZGVidWdTb3VyY2UgPSBudWxsOwogICAgICAgICAgICB0aGlzLl9kZWJ1Z093bmVyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5fZGVidWdOZWVkc1JlbW91bnQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fZGVidWdIb29rVHlwZXMgPSBudWxsOwogICAgICAgICAgICBpZiAoIWhhc0JhZE1hcFBvbHlmaWxsICYmIHR5cGVvZiBPYmplY3QucHJldmVudEV4dGVuc2lvbnMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBPYmplY3QucHJldmVudEV4dGVuc2lvbnModGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZUZpYmVyID0gZnVuY3Rpb24odGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSkgewogICAgICAgICAgcmV0dXJuIG5ldyBGaWJlck5vZGUodGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QkMShDb21wb25lbnQpIHsKICAgICAgICAgIHZhciBwcm90b3R5cGUgPSBDb21wb25lbnQucHJvdG90eXBlOwogICAgICAgICAgcmV0dXJuICEhKHByb3RvdHlwZSAmJiBwcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU2ltcGxlRnVuY3Rpb25Db21wb25lbnQodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iICYmICFzaG91bGRDb25zdHJ1Y3QkMSh0eXBlKSAmJiB0eXBlLmRlZmF1bHRQcm9wcyA9PT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlTGF6eUNvbXBvbmVudFRhZyhDb21wb25lbnQpIHsKICAgICAgICAgIGlmICh0eXBlb2YgQ29tcG9uZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBzaG91bGRDb25zdHJ1Y3QkMShDb21wb25lbnQpID8gQ2xhc3NDb21wb25lbnQgOiBGdW5jdGlvbkNvbXBvbmVudDsKICAgICAgICAgIH0gZWxzZSBpZiAoQ29tcG9uZW50ICE9PSB2b2lkIDAgJiYgQ29tcG9uZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciAkJHR5cGVvZiA9IENvbXBvbmVudC4kJHR5cGVvZjsKICAgICAgICAgICAgaWYgKCQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMikgewogICAgICAgICAgICAgIHJldHVybiBGb3J3YXJkUmVmMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRTIpIHsKICAgICAgICAgICAgICByZXR1cm4gTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnQ0LCBwZW5kaW5nUHJvcHMpIHsKICAgICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzczIgPSBjdXJyZW50NC5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMiA9IGNyZWF0ZUZpYmVyKGN1cnJlbnQ0LnRhZywgcGVuZGluZ1Byb3BzLCBjdXJyZW50NC5rZXksIGN1cnJlbnQ0Lm1vZGUpOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPSBjdXJyZW50NC5lbGVtZW50VHlwZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50NC50eXBlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gY3VycmVudDQuc3RhdGVOb2RlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z1NvdXJjZSA9IGN1cnJlbnQ0Ll9kZWJ1Z1NvdXJjZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnT3duZXIgPSBjdXJyZW50NC5fZGVidWdPd25lcjsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnSG9va1R5cGVzID0gY3VycmVudDQuX2RlYnVnSG9va1R5cGVzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPSBjdXJyZW50NDsKICAgICAgICAgICAgY3VycmVudDQuYWx0ZXJuYXRlID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wcyA9IHBlbmRpbmdQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50NC50eXBlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWN0dWFsRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5hY3R1YWxTdGFydFRpbWUgPSAtMTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gY3VycmVudDQuZmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBjdXJyZW50NC5jaGlsZExhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDQubGFuZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdmFyIGN1cnJlbnREZXBlbmRlbmNpZXMgPSBjdXJyZW50NC5kZXBlbmRlbmNpZXM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudERlcGVuZGVuY2llcyA9PT0gbnVsbCA/IG51bGwgOiB7CiAgICAgICAgICAgIGxhbmVzOiBjdXJyZW50RGVwZW5kZW5jaWVzLmxhbmVzLAogICAgICAgICAgICBmaXJzdENvbnRleHQ6IGN1cnJlbnREZXBlbmRlbmNpZXMuZmlyc3RDb250ZXh0CiAgICAgICAgICB9OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNpYmxpbmcgPSBjdXJyZW50NC5zaWJsaW5nOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmluZGV4ID0gY3VycmVudDQuaW5kZXg7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIucmVmID0gY3VycmVudDQucmVmOwogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc2VsZkJhc2VEdXJhdGlvbiA9IGN1cnJlbnQ0LnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uID0gY3VycmVudDQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z05lZWRzUmVtb3VudCA9IGN1cnJlbnQ0Ll9kZWJ1Z05lZWRzUmVtb3VudDsKICAgICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBJbmRldGVybWluYXRlQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcoY3VycmVudDQudHlwZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcoY3VycmVudDQudHlwZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlRm9yd2FyZFJlZkZvckhvdFJlbG9hZGluZyhjdXJyZW50NC50eXBlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFdvcmtJblByb2dyZXNzKHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gU3RhdGljTWFzayB8IFBsYWNlbWVudDsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNlbGZCYXNlRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMgPSBjdXJyZW50NC5jaGlsZExhbmVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBjdXJyZW50NC5sYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBjdXJyZW50NC5tZW1vaXplZFByb3BzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IGN1cnJlbnQ0LnR5cGU7CiAgICAgICAgICAgIHZhciBjdXJyZW50RGVwZW5kZW5jaWVzID0gY3VycmVudDQuZGVwZW5kZW5jaWVzOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzID0gY3VycmVudERlcGVuZGVuY2llcyA9PT0gbnVsbCA/IG51bGwgOiB7CiAgICAgICAgICAgICAgbGFuZXM6IGN1cnJlbnREZXBlbmRlbmNpZXMubGFuZXMsCiAgICAgICAgICAgICAgZmlyc3RDb250ZXh0OiBjdXJyZW50RGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dAogICAgICAgICAgICB9OwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNlbGZCYXNlRHVyYXRpb24gPSBjdXJyZW50NC5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uID0gY3VycmVudDQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlSG9zdFJvb3RGaWJlcih0YWcsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSkgewogICAgICAgICAgdmFyIG1vZGU7CiAgICAgICAgICBpZiAodGFnID09PSBDb25jdXJyZW50Um9vdCkgewogICAgICAgICAgICBtb2RlID0gQ29uY3VycmVudE1vZGU7CiAgICAgICAgICAgIGlmIChpc1N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdExlZ2FjeU1vZGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbW9kZSB8PSBTdHJpY3RFZmZlY3RzTW9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1vZGUgPSBOb01vZGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgbW9kZSB8PSBQcm9maWxlTW9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlcihIb3N0Um9vdCwgbnVsbCwgbnVsbCwgbW9kZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVR5cGVBbmRQcm9wcyh0eXBlLCBrZXksIHBlbmRpbmdQcm9wcywgb3duZXIsIG1vZGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZmliZXJUYWcgPSBJbmRldGVybWluYXRlQ29tcG9uZW50OwogICAgICAgICAgdmFyIHJlc29sdmVkVHlwZSA9IHR5cGU7CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaWYgKHNob3VsZENvbnN0cnVjdCQxKHR5cGUpKSB7CiAgICAgICAgICAgICAgZmliZXJUYWcgPSBDbGFzc0NvbXBvbmVudDsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXNvbHZlZFR5cGUgPSByZXNvbHZlQ2xhc3NGb3JIb3RSZWxvYWRpbmcocmVzb2x2ZWRUeXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICBmaWJlclRhZyA9IEhvc3RDb21wb25lbnQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnZXRUYWc6IHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21GcmFnbWVudChwZW5kaW5nUHJvcHMuY2hpbGRyZW4sIG1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gTW9kZTsKICAgICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0TGVnYWN5TW9kZTsKICAgICAgICAgICAgICAgIGlmICgobW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0RWZmZWN0c01vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tUHJvZmlsZXIocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2UocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21TdXNwZW5zZUxpc3QocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX09GRlNDUkVFTl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbU9mZnNjcmVlbihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEVHQUNZX0hJRERFTl9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfU0NPUEVfVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NBQ0hFX1RZUEU6CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9UUkFDSU5HX01BUktFUl9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfREVCVUdfVFJBQ0lOR19NT0RFX1RZUEU6CiAgICAgICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gQ29udGV4dFByb3ZpZGVyOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfQ09OVEVYVF9UWVBFOgogICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBDb250ZXh0Q29uc3VtZXI7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gRm9yd2FyZFJlZjI7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBNZW1vQ29tcG9uZW50OwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICAgICAgZmliZXJUYWcgPSBMYXp5Q29tcG9uZW50OwogICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGluZm8gPSAiIjsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0eXBlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpbmZvICs9ICIgWW91IGxpa2VseSBmb3Jnb3QgdG8gZXhwb3J0IHlvdXIgY29tcG9uZW50IGZyb20gdGhlIGZpbGUgaXQncyBkZWZpbmVkIGluLCBvciB5b3UgbWlnaHQgaGF2ZSBtaXhlZCB1cCBkZWZhdWx0IGFuZCBuYW1lZCBpbXBvcnRzLiI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgdmFyIG93bmVyTmFtZSA9IG93bmVyID8gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lcikgOiBudWxsOwogICAgICAgICAgICAgICAgICBpZiAob3duZXJOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaW5mbyArPSAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgb3duZXJOYW1lICsgImAuIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFbGVtZW50IHR5cGUgaXMgaW52YWxpZDogZXhwZWN0ZWQgYSBzdHJpbmcgKGZvciBidWlsdC1pbiBjb21wb25lbnRzKSBvciBhIGNsYXNzL2Z1bmN0aW9uIChmb3IgY29tcG9zaXRlIGNvbXBvbmVudHMpICIgKyAoImJ1dCBnb3Q6ICIgKyAodHlwZSA9PSBudWxsID8gdHlwZSA6IHR5cGVvZiB0eXBlKSArICIuIiArIGluZm8pKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKGZpYmVyVGFnLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IHR5cGU7CiAgICAgICAgICBmaWJlci50eXBlID0gcmVzb2x2ZWRUeXBlOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBvd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRWxlbWVudChlbGVtZW50LCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIG93bmVyID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0eXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgdmFyIHBlbmRpbmdQcm9wcyA9IGVsZW1lbnQucHJvcHM7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHModHlwZSwga2V5LCBwZW5kaW5nUHJvcHMsIG93bmVyLCBtb2RlLCBsYW5lcyk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgZmliZXIuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZWxlbWVudHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEZyYWdtZW50OSwgZWxlbWVudHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Qcm9maWxlcihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwZW5kaW5nUHJvcHMuaWQgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ1Byb2ZpbGVyIG11c3Qgc3BlY2lmeSBhbiAiaWQiIG9mIHR5cGUgYHN0cmluZ2AgYXMgYSBwcm9wLiBSZWNlaXZlZCB0aGUgdHlwZSBgJXNgIGluc3RlYWQuJywgdHlwZW9mIHBlbmRpbmdQcm9wcy5pZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKFByb2ZpbGVyLCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSB8IFByb2ZpbGVNb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gUkVBQ1RfUFJPRklMRVJfVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHsKICAgICAgICAgICAgICBlZmZlY3REdXJhdGlvbjogMCwKICAgICAgICAgICAgICBwYXNzaXZlRWZmZWN0RHVyYXRpb246IDAKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2UocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihTdXNwZW5zZUNvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9TVVNQRU5TRV9UWVBFOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2VMaXN0KHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoU3VzcGVuc2VMaXN0Q29tcG9uZW50LCBwZW5kaW5nUHJvcHMsIGtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbU9mZnNjcmVlbihwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKE9mZnNjcmVlbkNvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9PRkZTQ1JFRU5fVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkSW5zdGFuY2UgPSB7CiAgICAgICAgICAgIGlzSGlkZGVuOiBmYWxzZQogICAgICAgICAgfTsKICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHByaW1hcnlDaGlsZEluc3RhbmNlOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21UZXh0KGNvbnRlbnQsIG1vZGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0VGV4dCwgY29udGVudCwgbnVsbCwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21Ib3N0SW5zdGFuY2VGb3JEZWxldGlvbigpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RDb21wb25lbnQsIG51bGwsIG51bGwsIE5vTW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9ICJERUxFVEVEIjsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tRGVoeWRyYXRlZEZyYWdtZW50KGRlaHlkcmF0ZWROb2RlKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihEZWh5ZHJhdGVkRnJhZ21lbnQsIG51bGwsIG51bGwsIE5vTW9kZSk7CiAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBkZWh5ZHJhdGVkTm9kZTsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tUG9ydGFsKHBvcnRhbCwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBwZW5kaW5nUHJvcHMgPSBwb3J0YWwuY2hpbGRyZW4gIT09IG51bGwgPyBwb3J0YWwuY2hpbGRyZW4gOiBbXTsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKEhvc3RQb3J0YWwsIHBlbmRpbmdQcm9wcywgcG9ydGFsLmtleSwgbW9kZSk7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gewogICAgICAgICAgICBjb250YWluZXJJbmZvOiBwb3J0YWwuY29udGFpbmVySW5mbywKICAgICAgICAgICAgcGVuZGluZ0NoaWxkcmVuOiBudWxsLAogICAgICAgICAgICAvLyBVc2VkIGJ5IHBlcnNpc3RlbnQgdXBkYXRlcwogICAgICAgICAgICBpbXBsZW1lbnRhdGlvbjogcG9ydGFsLmltcGxlbWVudGF0aW9uCiAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVih0YXJnZXQsIHNvdXJjZSkgewogICAgICAgICAgaWYgKHRhcmdldCA9PT0gbnVsbCkgewogICAgICAgICAgICB0YXJnZXQgPSBjcmVhdGVGaWJlcihJbmRldGVybWluYXRlQ29tcG9uZW50LCBudWxsLCBudWxsLCBOb01vZGUpOwogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0LnRhZyA9IHNvdXJjZS50YWc7CiAgICAgICAgICB0YXJnZXQua2V5ID0gc291cmNlLmtleTsKICAgICAgICAgIHRhcmdldC5lbGVtZW50VHlwZSA9IHNvdXJjZS5lbGVtZW50VHlwZTsKICAgICAgICAgIHRhcmdldC50eXBlID0gc291cmNlLnR5cGU7CiAgICAgICAgICB0YXJnZXQuc3RhdGVOb2RlID0gc291cmNlLnN0YXRlTm9kZTsKICAgICAgICAgIHRhcmdldC5yZXR1cm4gPSBzb3VyY2UucmV0dXJuOwogICAgICAgICAgdGFyZ2V0LmNoaWxkID0gc291cmNlLmNoaWxkOwogICAgICAgICAgdGFyZ2V0LnNpYmxpbmcgPSBzb3VyY2Uuc2libGluZzsKICAgICAgICAgIHRhcmdldC5pbmRleCA9IHNvdXJjZS5pbmRleDsKICAgICAgICAgIHRhcmdldC5yZWYgPSBzb3VyY2UucmVmOwogICAgICAgICAgdGFyZ2V0LnBlbmRpbmdQcm9wcyA9IHNvdXJjZS5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB0YXJnZXQubWVtb2l6ZWRQcm9wcyA9IHNvdXJjZS5tZW1vaXplZFByb3BzOwogICAgICAgICAgdGFyZ2V0LnVwZGF0ZVF1ZXVlID0gc291cmNlLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgdGFyZ2V0Lm1lbW9pemVkU3RhdGUgPSBzb3VyY2UubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHRhcmdldC5kZXBlbmRlbmNpZXMgPSBzb3VyY2UuZGVwZW5kZW5jaWVzOwogICAgICAgICAgdGFyZ2V0Lm1vZGUgPSBzb3VyY2UubW9kZTsKICAgICAgICAgIHRhcmdldC5mbGFncyA9IHNvdXJjZS5mbGFnczsKICAgICAgICAgIHRhcmdldC5zdWJ0cmVlRmxhZ3MgPSBzb3VyY2Uuc3VidHJlZUZsYWdzOwogICAgICAgICAgdGFyZ2V0LmRlbGV0aW9ucyA9IHNvdXJjZS5kZWxldGlvbnM7CiAgICAgICAgICB0YXJnZXQubGFuZXMgPSBzb3VyY2UubGFuZXM7CiAgICAgICAgICB0YXJnZXQuY2hpbGRMYW5lcyA9IHNvdXJjZS5jaGlsZExhbmVzOwogICAgICAgICAgdGFyZ2V0LmFsdGVybmF0ZSA9IHNvdXJjZS5hbHRlcm5hdGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRhcmdldC5hY3R1YWxEdXJhdGlvbiA9IHNvdXJjZS5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgdGFyZ2V0LmFjdHVhbFN0YXJ0VGltZSA9IHNvdXJjZS5hY3R1YWxTdGFydFRpbWU7CiAgICAgICAgICAgIHRhcmdldC5zZWxmQmFzZUR1cmF0aW9uID0gc291cmNlLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgIHRhcmdldC50cmVlQmFzZUR1cmF0aW9uID0gc291cmNlLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICB0YXJnZXQuX2RlYnVnU291cmNlID0gc291cmNlLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgIHRhcmdldC5fZGVidWdPd25lciA9IHNvdXJjZS5fZGVidWdPd25lcjsKICAgICAgICAgIHRhcmdldC5fZGVidWdOZWVkc1JlbW91bnQgPSBzb3VyY2UuX2RlYnVnTmVlZHNSZW1vdW50OwogICAgICAgICAgdGFyZ2V0Ll9kZWJ1Z0hvb2tUeXBlcyA9IHNvdXJjZS5fZGVidWdIb29rVHlwZXM7CiAgICAgICAgICByZXR1cm4gdGFyZ2V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBGaWJlclJvb3ROb2RlKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcikgewogICAgICAgICAgdGhpcy50YWcgPSB0YWc7CiAgICAgICAgICB0aGlzLmNvbnRhaW5lckluZm8gPSBjb250YWluZXJJbmZvOwogICAgICAgICAgdGhpcy5wZW5kaW5nQ2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgdGhpcy5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgIHRoaXMucGluZ0NhY2hlID0gbnVsbDsKICAgICAgICAgIHRoaXMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHRoaXMudGltZW91dEhhbmRsZSA9IG5vVGltZW91dDsKICAgICAgICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICAgICAgICB0aGlzLnBlbmRpbmdDb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2FsbGJhY2tOb2RlID0gbnVsbDsKICAgICAgICAgIHRoaXMuY2FsbGJhY2tQcmlvcml0eSA9IE5vTGFuZTsKICAgICAgICAgIHRoaXMuZXZlbnRUaW1lcyA9IGNyZWF0ZUxhbmVNYXAoTm9MYW5lcyk7CiAgICAgICAgICB0aGlzLmV4cGlyYXRpb25UaW1lcyA9IGNyZWF0ZUxhbmVNYXAoTm9UaW1lc3RhbXApOwogICAgICAgICAgdGhpcy5wZW5kaW5nTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5zdXNwZW5kZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuZXhwaXJlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMubXV0YWJsZVJlYWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5lbnRhbmdsZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmVudGFuZ2xlbWVudHMgPSBjcmVhdGVMYW5lTWFwKE5vTGFuZXMpOwogICAgICAgICAgdGhpcy5pZGVudGlmaWVyUHJlZml4ID0gaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgIHRoaXMub25SZWNvdmVyYWJsZUVycm9yID0gb25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgewogICAgICAgICAgICB0aGlzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB0aGlzLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5wYXNzaXZlRWZmZWN0RHVyYXRpb24gPSAwOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB0aGlzLm1lbW9pemVkVXBkYXRlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB2YXIgcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IHRoaXMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgVG90YWxMYW5lczsgX2krKykgewogICAgICAgICAgICAgIHBlbmRpbmdVcGRhdGVyc0xhbmVNYXAucHVzaCgvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICAgIGNhc2UgQ29uY3VycmVudFJvb3Q6CiAgICAgICAgICAgICAgICB0aGlzLl9kZWJ1Z1Jvb3RUeXBlID0gaHlkcmF0ZTIgPyAiaHlkcmF0ZVJvb3QoKSIgOiAiY3JlYXRlUm9vdCgpIjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgTGVnYWN5Um9vdDoKICAgICAgICAgICAgICAgIHRoaXMuX2RlYnVnUm9vdFR5cGUgPSBoeWRyYXRlMiA/ICJoeWRyYXRlKCkiIDogInJlbmRlcigpIjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyUm9vdChjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpbml0aWFsQ2hpbGRyZW4sIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IsIHRyYW5zaXRpb25DYWxsYmFja3MpIHsKICAgICAgICAgIHZhciByb290MyA9IG5ldyBGaWJlclJvb3ROb2RlKGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICB2YXIgdW5pbml0aWFsaXplZEZpYmVyID0gY3JlYXRlSG9zdFJvb3RGaWJlcih0YWcsIGlzU3RyaWN0TW9kZSk7CiAgICAgICAgICByb290My5jdXJyZW50ID0gdW5pbml0aWFsaXplZEZpYmVyOwogICAgICAgICAgdW5pbml0aWFsaXplZEZpYmVyLnN0YXRlTm9kZSA9IHJvb3QzOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgX2luaXRpYWxTdGF0ZSA9IHsKICAgICAgICAgICAgICBlbGVtZW50OiBpbml0aWFsQ2hpbGRyZW4sCiAgICAgICAgICAgICAgaXNEZWh5ZHJhdGVkOiBoeWRyYXRlMiwKICAgICAgICAgICAgICBjYWNoZTogbnVsbCwKICAgICAgICAgICAgICAvLyBub3QgZW5hYmxlZCB5ZXQKICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbnVsbCwKICAgICAgICAgICAgICBwZW5kaW5nU3VzcGVuc2VCb3VuZGFyaWVzOiBudWxsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVuaW5pdGlhbGl6ZWRGaWJlci5tZW1vaXplZFN0YXRlID0gX2luaXRpYWxTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluaXRpYWxpemVVcGRhdGVRdWV1ZSh1bmluaXRpYWxpemVkRmliZXIpOwogICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RWZXJzaW9uID0gIjE4LjMuMSI7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUG9ydGFsMyhjaGlsZHJlbiwgY29udGFpbmVySW5mbywgaW1wbGVtZW50YXRpb24pIHsKICAgICAgICAgIHZhciBrZXkgPSBhcmd1bWVudHMubGVuZ3RoID4gMyAmJiBhcmd1bWVudHNbM10gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1szXSA6IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24oa2V5KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIC8vIFRoaXMgdGFnIGFsbG93IHVzIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IHRoaXMgYXMgYSBSZWFjdCBQb3J0YWwKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX1BPUlRBTF9UWVBFLAogICAgICAgICAgICBrZXk6IGtleSA9PSBudWxsID8gbnVsbCA6ICIiICsga2V5LAogICAgICAgICAgICBjaGlsZHJlbiwKICAgICAgICAgICAgY29udGFpbmVySW5mbywKICAgICAgICAgICAgaW1wbGVtZW50YXRpb24KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXROZXN0ZWRVcGRhdGVzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRGaW5kTm9kZUluU3RyaWN0TW9kZTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXROZXN0ZWRVcGRhdGVzID0gZmFsc2U7CiAgICAgICAgICBkaWRXYXJuQWJvdXRGaW5kTm9kZUluU3RyaWN0TW9kZSA9IHt9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0Rm9yU3VidHJlZShwYXJlbnRDb21wb25lbnQpIHsKICAgICAgICAgIGlmICghcGFyZW50Q29tcG9uZW50KSB7CiAgICAgICAgICAgIHJldHVybiBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ1KHBhcmVudENvbXBvbmVudCk7CiAgICAgICAgICB2YXIgcGFyZW50Q29udGV4dCA9IGZpbmRDdXJyZW50VW5tYXNrZWRDb250ZXh0KGZpYmVyKTsKICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSBmaWJlci50eXBlOwogICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgIHJldHVybiBwcm9jZXNzQ2hpbGRDb250ZXh0KGZpYmVyLCBDb21wb25lbnQsIHBhcmVudENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZVdpdGhXYXJuaW5nKGNvbXBvbmVudCwgbWV0aG9kTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ1KGNvbXBvbmVudCk7CiAgICAgICAgICAgIGlmIChmaWJlciA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb21wb25lbnQucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhjb21wb25lbnQpLmpvaW4oIiwiKTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQXJndW1lbnQgYXBwZWFycyB0byBub3QgYmUgYSBSZWFjdENvbXBvbmVudC4gS2V5czogIiArIGtleXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaG9zdEZpYmVyID0gZmluZEN1cnJlbnRIb3N0RmliZXIoZmliZXIpOwogICAgICAgICAgICBpZiAoaG9zdEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhvc3RGaWJlci5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRGaW5kTm9kZUluU3RyaWN0TW9kZVtjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGVbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50MzsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihob3N0RmliZXIpOwogICAgICAgICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXMgaXMgZGVwcmVjYXRlZCBpbiBTdHJpY3RNb2RlLiAlcyB3YXMgcGFzc2VkIGFuIGluc3RhbmNlIG9mICVzIHdoaWNoIGlzIGluc2lkZSBTdHJpY3RNb2RlLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiLCBtZXRob2ROYW1lLCBtZXRob2ROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXMgaXMgZGVwcmVjYXRlZCBpbiBTdHJpY3RNb2RlLiAlcyB3YXMgcGFzc2VkIGFuIGluc3RhbmNlIG9mICVzIHdoaWNoIHJlbmRlcnMgU3RyaWN0TW9kZSBjaGlsZHJlbi4gSW5zdGVhZCwgYWRkIGEgcmVmIGRpcmVjdGx5IHRvIHRoZSBlbGVtZW50IHlvdSB3YW50IHRvIHJlZmVyZW5jZS4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtZmluZC1ub2RlIiwgbWV0aG9kTmFtZSwgbWV0aG9kTmFtZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0ZpYmVyKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKHByZXZpb3VzRmliZXIpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGhvc3RGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNvbnRhaW5lcihjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IsIHRyYW5zaXRpb25DYWxsYmFja3MpIHsKICAgICAgICAgIHZhciBoeWRyYXRlMiA9IGZhbHNlOwogICAgICAgICAgdmFyIGluaXRpYWxDaGlsZHJlbiA9IG51bGw7CiAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJSb290KGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGluaXRpYWxDaGlsZHJlbiwgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcihpbml0aWFsQ2hpbGRyZW4sIGNhbGxiYWNrLCBjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IsIHRyYW5zaXRpb25DYWxsYmFja3MpIHsKICAgICAgICAgIHZhciBoeWRyYXRlMiA9IHRydWU7CiAgICAgICAgICB2YXIgcm9vdDMgPSBjcmVhdGVGaWJlclJvb3QoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaW5pdGlhbENoaWxkcmVuLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIHJvb3QzLmNvbnRleHQgPSBnZXRDb250ZXh0Rm9yU3VidHJlZShudWxsKTsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IHJvb3QzLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShjdXJyZW50NCk7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUuY2FsbGJhY2sgPSBjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsID8gY2FsbGJhY2sgOiBudWxsOwogICAgICAgICAgZW5xdWV1ZVVwZGF0ZShjdXJyZW50NCwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgIHNjaGVkdWxlSW5pdGlhbEh5ZHJhdGlvbk9uUm9vdChyb290MywgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgIHJldHVybiByb290MzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ29udGFpbmVyKGVsZW1lbnQsIGNvbnRhaW5lcjIsIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgb25TY2hlZHVsZVJvb3QoY29udGFpbmVyMiwgZWxlbWVudCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY3VycmVudCQxID0gY29udGFpbmVyMi5jdXJyZW50OwogICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoY3VycmVudCQxKTsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1JlbmRlclNjaGVkdWxlZChsYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb250ZXh0ID0gZ2V0Q29udGV4dEZvclN1YnRyZWUocGFyZW50Q29tcG9uZW50KTsKICAgICAgICAgIGlmIChjb250YWluZXIyLmNvbnRleHQgPT09IG51bGwpIHsKICAgICAgICAgICAgY29udGFpbmVyMi5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucGVuZGluZ0NvbnRleHQgPSBjb250ZXh0OwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNSZW5kZXJpbmcgJiYgY3VycmVudDMgIT09IG51bGwgJiYgIWRpZFdhcm5BYm91dE5lc3RlZFVwZGF0ZXMpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXROZXN0ZWRVcGRhdGVzID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyIG1ldGhvZHMgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGU7IHRyaWdnZXJpbmcgbmVzdGVkIGNvbXBvbmVudCB1cGRhdGVzIGZyb20gcmVuZGVyIGlzIG5vdCBhbGxvd2VkLiBJZiBuZWNlc3NhcnksIHRyaWdnZXIgbmVzdGVkIHVwZGF0ZXMgaW4gY29tcG9uZW50RGlkVXBkYXRlLlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiAlcy4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGN1cnJlbnQzKSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHsKICAgICAgICAgICAgZWxlbWVudAogICAgICAgICAgfTsKICAgICAgICAgIGNhbGxiYWNrID0gY2FsbGJhY2sgPT09IHZvaWQgMCA/IG51bGwgOiBjYWxsYmFjazsKICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBFeHBlY3RlZCB0aGUgbGFzdCBvcHRpb25hbCBgY2FsbGJhY2tgIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24uIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNhbGxiYWNrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKGN1cnJlbnQkMSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGN1cnJlbnQkMSwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgY3VycmVudCQxLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQdWJsaWNSb290SW5zdGFuY2UoY29udGFpbmVyMikgewogICAgICAgICAgdmFyIGNvbnRhaW5lckZpYmVyID0gY29udGFpbmVyMi5jdXJyZW50OwogICAgICAgICAgaWYgKCFjb250YWluZXJGaWJlci5jaGlsZCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAoY29udGFpbmVyRmliZXIuY2hpbGQudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZ2V0UHVibGljSW5zdGFuY2UoY29udGFpbmVyRmliZXIuY2hpbGQuc3RhdGVOb2RlKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gY29udGFpbmVyRmliZXIuY2hpbGQuc3RhdGVOb2RlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24kMShmaWJlcikgewogICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciByb290MyA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgICAgIHZhciBsYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eVBlbmRpbmdMYW5lcyhyb290Myk7CiAgICAgICAgICAgICAgICBmbHVzaFJvb3Qocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciByb290NCA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgaWYgKHJvb3Q0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290NCwgZmliZXIsIFN5bmNMYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHZhciByZXRyeUxhbmUgPSBTeW5jTGFuZTsKICAgICAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmV0cnlMYW5lSW1wbChmaWJlciwgcmV0cnlMYW5lKSB7CiAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCAmJiBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUgPSBoaWdoZXJQcmlvcml0eUxhbmUoc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmUsIHJldHJ5TGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCByZXRyeUxhbmUpIHsKICAgICAgICAgIG1hcmtSZXRyeUxhbmVJbXBsKGZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgIGlmIChhbHRlcm5hdGUpIHsKICAgICAgICAgICAgbWFya1JldHJ5TGFuZUltcGwoYWx0ZXJuYXRlLCByZXRyeUxhbmUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbiQxKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIGxhbmUpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eSQxKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgbGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtSZXRyeUxhbmVJZk5vdEh5ZHJhdGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZVdpdGhOb1BvcnRhbHMoZmliZXIpIHsKICAgICAgICAgIHZhciBob3N0RmliZXIgPSBmaW5kQ3VycmVudEhvc3RGaWJlcldpdGhOb1BvcnRhbHMoZmliZXIpOwogICAgICAgICAgaWYgKGhvc3RGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBob3N0RmliZXIuc3RhdGVOb2RlOwogICAgICAgIH0KICAgICAgICB2YXIgc2hvdWxkRXJyb3JJbXBsID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkRXJyb3IoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBzaG91bGRFcnJvckltcGwoZmliZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgc2hvdWxkU3VzcGVuZEltcGwgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkU3VzcGVuZChmaWJlcikgewogICAgICAgICAgcmV0dXJuIHNob3VsZFN1c3BlbmRJbXBsKGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIG92ZXJyaWRlSG9va1N0YXRlID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVIb29rU3RhdGVSZW5hbWVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVQcm9wcyA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlUHJvcHNEZWxldGVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGggPSBudWxsOwogICAgICAgIHZhciBzY2hlZHVsZVVwZGF0ZSA9IG51bGw7CiAgICAgICAgdmFyIHNldEVycm9ySGFuZGxlciA9IG51bGw7CiAgICAgICAgdmFyIHNldFN1c3BlbnNlSGFuZGxlciA9IG51bGw7CiAgICAgICAgewogICAgICAgICAgdmFyIGNvcHlXaXRoRGVsZXRlSW1wbCA9IGZ1bmN0aW9uKG9iaiwgcGF0aDIsIGluZGV4MikgewogICAgICAgICAgICB2YXIga2V5ID0gcGF0aDJbaW5kZXgyXTsKICAgICAgICAgICAgdmFyIHVwZGF0ZWQgPSBpc0FycmF5MihvYmopID8gb2JqLnNsaWNlKCkgOiBhc3NpZ24yKHt9LCBvYmopOwogICAgICAgICAgICBpZiAoaW5kZXgyICsgMSA9PT0gcGF0aDIubGVuZ3RoKSB7CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKHVwZGF0ZWQpKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVkLnNwbGljZShrZXksIDEpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGUgdXBkYXRlZFtrZXldOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVkW2tleV0gPSBjb3B5V2l0aERlbGV0ZUltcGwob2JqW2tleV0sIHBhdGgyLCBpbmRleDIgKyAxKTsKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWQ7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvcHlXaXRoRGVsZXRlID0gZnVuY3Rpb24ob2JqLCBwYXRoMikgewogICAgICAgICAgICByZXR1cm4gY29weVdpdGhEZWxldGVJbXBsKG9iaiwgcGF0aDIsIDApOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFJlbmFtZUltcGwgPSBmdW5jdGlvbihvYmosIG9sZFBhdGgsIG5ld1BhdGgsIGluZGV4MikgewogICAgICAgICAgICB2YXIgb2xkS2V5ID0gb2xkUGF0aFtpbmRleDJdOwogICAgICAgICAgICB2YXIgdXBkYXRlZCA9IGlzQXJyYXkyKG9iaikgPyBvYmouc2xpY2UoKSA6IGFzc2lnbjIoe30sIG9iaik7CiAgICAgICAgICAgIGlmIChpbmRleDIgKyAxID09PSBvbGRQYXRoLmxlbmd0aCkgewogICAgICAgICAgICAgIHZhciBuZXdLZXkgPSBuZXdQYXRoW2luZGV4Ml07CiAgICAgICAgICAgICAgdXBkYXRlZFtuZXdLZXldID0gdXBkYXRlZFtvbGRLZXldOwogICAgICAgICAgICAgIGlmIChpc0FycmF5Mih1cGRhdGVkKSkgewogICAgICAgICAgICAgICAgdXBkYXRlZC5zcGxpY2Uob2xkS2V5LCAxKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlIHVwZGF0ZWRbb2xkS2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlZFtvbGRLZXldID0gY29weVdpdGhSZW5hbWVJbXBsKAogICAgICAgICAgICAgICAgLy8gJEZsb3dGaXhNZSBudW1iZXIgb3Igc3RyaW5nIGlzIGZpbmUgaGVyZQogICAgICAgICAgICAgICAgb2JqW29sZEtleV0sCiAgICAgICAgICAgICAgICBvbGRQYXRoLAogICAgICAgICAgICAgICAgbmV3UGF0aCwKICAgICAgICAgICAgICAgIGluZGV4MiArIDEKICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFJlbmFtZSA9IGZ1bmN0aW9uKG9iaiwgb2xkUGF0aCwgbmV3UGF0aCkgewogICAgICAgICAgICBpZiAob2xkUGF0aC5sZW5ndGggIT09IG5ld1BhdGgubGVuZ3RoKSB7CiAgICAgICAgICAgICAgd2FybjMoImNvcHlXaXRoUmVuYW1lKCkgZXhwZWN0cyBwYXRocyBvZiB0aGUgc2FtZSBsZW5ndGgiKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdQYXRoLmxlbmd0aCAtIDE7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKG9sZFBhdGhbaV0gIT09IG5ld1BhdGhbaV0pIHsKICAgICAgICAgICAgICAgICAgd2FybjMoImNvcHlXaXRoUmVuYW1lKCkgZXhwZWN0cyBwYXRocyB0byBiZSB0aGUgc2FtZSBleGNlcHQgZm9yIHRoZSBkZWVwZXN0IGtleSIpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjb3B5V2l0aFJlbmFtZUltcGwob2JqLCBvbGRQYXRoLCBuZXdQYXRoLCAwKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhTZXRJbXBsID0gZnVuY3Rpb24ob2JqLCBwYXRoMiwgaW5kZXgyLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoaW5kZXgyID49IHBhdGgyLmxlbmd0aCkgewogICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIga2V5ID0gcGF0aDJbaW5kZXgyXTsKICAgICAgICAgICAgdmFyIHVwZGF0ZWQgPSBpc0FycmF5MihvYmopID8gb2JqLnNsaWNlKCkgOiBhc3NpZ24yKHt9LCBvYmopOwogICAgICAgICAgICB1cGRhdGVkW2tleV0gPSBjb3B5V2l0aFNldEltcGwob2JqW2tleV0sIHBhdGgyLCBpbmRleDIgKyAxLCB2YWx1ZSk7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aFNldCA9IGZ1bmN0aW9uKG9iaiwgcGF0aDIsIHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiBjb3B5V2l0aFNldEltcGwob2JqLCBwYXRoMiwgMCwgdmFsdWUpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBmaW5kSG9vayA9IGZ1bmN0aW9uKGZpYmVyLCBpZCkgewogICAgICAgICAgICB2YXIgY3VycmVudEhvb2syID0gZmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnRIb29rMiAhPT0gbnVsbCAmJiBpZCA+IDApIHsKICAgICAgICAgICAgICBjdXJyZW50SG9vazIgPSBjdXJyZW50SG9vazIubmV4dDsKICAgICAgICAgICAgICBpZC0tOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50SG9vazI7CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGUgPSBmdW5jdGlvbihmaWJlciwgaWQsIHBhdGgyLCB2YWx1ZSkgewogICAgICAgICAgICB2YXIgaG9vayA9IGZpbmRIb29rKGZpYmVyLCBpZCk7CiAgICAgICAgICAgIGlmIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhTZXQoaG9vay5tZW1vaXplZFN0YXRlLCBwYXRoMiwgdmFsdWUpOwogICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IGFzc2lnbjIoe30sIGZpYmVyLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZURlbGV0ZVBhdGggPSBmdW5jdGlvbihmaWJlciwgaWQsIHBhdGgyKSB7CiAgICAgICAgICAgIHZhciBob29rID0gZmluZEhvb2soZmliZXIsIGlkKTsKICAgICAgICAgICAgaWYgKGhvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBjb3B5V2l0aERlbGV0ZShob29rLm1lbW9pemVkU3RhdGUsIHBhdGgyKTsKICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBhc3NpZ24yKHt9LCBmaWJlci5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVSZW5hbWVQYXRoID0gZnVuY3Rpb24oZmliZXIsIGlkLCBvbGRQYXRoLCBuZXdQYXRoKSB7CiAgICAgICAgICAgIHZhciBob29rID0gZmluZEhvb2soZmliZXIsIGlkKTsKICAgICAgICAgICAgaWYgKGhvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBjb3B5V2l0aFJlbmFtZShob29rLm1lbW9pemVkU3RhdGUsIG9sZFBhdGgsIG5ld1BhdGgpOwogICAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRQcm9wcyA9IGFzc2lnbjIoe30sIGZpYmVyLm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZVByb3BzID0gZnVuY3Rpb24oZmliZXIsIHBhdGgyLCB2YWx1ZSkgewogICAgICAgICAgICBmaWJlci5wZW5kaW5nUHJvcHMgPSBjb3B5V2l0aFNldChmaWJlci5tZW1vaXplZFByb3BzLCBwYXRoMiwgdmFsdWUpOwogICAgICAgICAgICBpZiAoZmliZXIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgZmliZXIuYWx0ZXJuYXRlLnBlbmRpbmdQcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlUHJvcHNEZWxldGVQYXRoID0gZnVuY3Rpb24oZmliZXIsIHBhdGgyKSB7CiAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IGNvcHlXaXRoRGVsZXRlKGZpYmVyLm1lbW9pemVkUHJvcHMsIHBhdGgyKTsKICAgICAgICAgICAgaWYgKGZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZS5wZW5kaW5nUHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZVByb3BzUmVuYW1lUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBvbGRQYXRoLCBuZXdQYXRoKSB7CiAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IGNvcHlXaXRoUmVuYW1lKGZpYmVyLm1lbW9pemVkUHJvcHMsIG9sZFBhdGgsIG5ld1BhdGgpOwogICAgICAgICAgICBpZiAoZmliZXIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgZmliZXIuYWx0ZXJuYXRlLnBlbmRpbmdQcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgU3luY0xhbmUsIE5vVGltZXN0YW1wKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHNjaGVkdWxlVXBkYXRlID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBzZXRFcnJvckhhbmRsZXIgPSBmdW5jdGlvbihuZXdTaG91bGRFcnJvckltcGwpIHsKICAgICAgICAgICAgc2hvdWxkRXJyb3JJbXBsID0gbmV3U2hvdWxkRXJyb3JJbXBsOwogICAgICAgICAgfTsKICAgICAgICAgIHNldFN1c3BlbnNlSGFuZGxlciA9IGZ1bmN0aW9uKG5ld1Nob3VsZFN1c3BlbmRJbXBsKSB7CiAgICAgICAgICAgIHNob3VsZFN1c3BlbmRJbXBsID0gbmV3U2hvdWxkU3VzcGVuZEltcGw7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kSG9zdEluc3RhbmNlQnlGaWJlcihmaWJlcikgewogICAgICAgICAgdmFyIGhvc3RGaWJlciA9IGZpbmRDdXJyZW50SG9zdEZpYmVyKGZpYmVyKTsKICAgICAgICAgIGlmIChob3N0RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW1wdHlGaW5kRmliZXJCeUhvc3RJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRGaWJlckZvckRldlRvb2xzKCkgewogICAgICAgICAgcmV0dXJuIGN1cnJlbnQzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmplY3RJbnRvRGV2VG9vbHMoZGV2VG9vbHNDb25maWcpIHsKICAgICAgICAgIHZhciBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZSA9IGRldlRvb2xzQ29uZmlnLmZpbmRGaWJlckJ5SG9zdEluc3RhbmNlOwogICAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICAgIHJldHVybiBpbmplY3RJbnRlcm5hbHMoewogICAgICAgICAgICBidW5kbGVUeXBlOiBkZXZUb29sc0NvbmZpZy5idW5kbGVUeXBlLAogICAgICAgICAgICB2ZXJzaW9uOiBkZXZUb29sc0NvbmZpZy52ZXJzaW9uLAogICAgICAgICAgICByZW5kZXJlclBhY2thZ2VOYW1lOiBkZXZUb29sc0NvbmZpZy5yZW5kZXJlclBhY2thZ2VOYW1lLAogICAgICAgICAgICByZW5kZXJlckNvbmZpZzogZGV2VG9vbHNDb25maWcucmVuZGVyZXJDb25maWcsCiAgICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlLAogICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZURlbGV0ZVBhdGgsCiAgICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlUmVuYW1lUGF0aCwKICAgICAgICAgICAgb3ZlcnJpZGVQcm9wcywKICAgICAgICAgICAgb3ZlcnJpZGVQcm9wc0RlbGV0ZVBhdGgsCiAgICAgICAgICAgIG92ZXJyaWRlUHJvcHNSZW5hbWVQYXRoLAogICAgICAgICAgICBzZXRFcnJvckhhbmRsZXIsCiAgICAgICAgICAgIHNldFN1c3BlbnNlSGFuZGxlciwKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGUsCiAgICAgICAgICAgIGN1cnJlbnREaXNwYXRjaGVyUmVmOiBSZWFjdEN1cnJlbnREaXNwYXRjaGVyMiwKICAgICAgICAgICAgZmluZEhvc3RJbnN0YW5jZUJ5RmliZXIsCiAgICAgICAgICAgIGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlOiBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZSB8fCBlbXB0eUZpbmRGaWJlckJ5SG9zdEluc3RhbmNlLAogICAgICAgICAgICAvLyBSZWFjdCBSZWZyZXNoCiAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yUmVmcmVzaCwKICAgICAgICAgICAgc2NoZWR1bGVSZWZyZXNoLAogICAgICAgICAgICBzY2hlZHVsZVJvb3QsCiAgICAgICAgICAgIHNldFJlZnJlc2hIYW5kbGVyLAogICAgICAgICAgICAvLyBFbmFibGVzIERldlRvb2xzIHRvIGFwcGVuZCBvd25lciBzdGFja3MgdG8gZXJyb3IgbWVzc2FnZXMgaW4gREVWIG1vZGUuCiAgICAgICAgICAgIGdldEN1cnJlbnRGaWJlcjogZ2V0Q3VycmVudEZpYmVyRm9yRGV2VG9vbHMsCiAgICAgICAgICAgIC8vIEVuYWJsZXMgRGV2VG9vbHMgdG8gZGV0ZWN0IHJlY29uY2lsZXIgdmVyc2lvbiByYXRoZXIgdGhhbiByZW5kZXJlciB2ZXJzaW9uCiAgICAgICAgICAgIC8vIHdoaWNoIG1heSBub3QgbWF0Y2ggZm9yIHRoaXJkIHBhcnR5IHJlbmRlcmVycy4KICAgICAgICAgICAgcmVjb25jaWxlclZlcnNpb246IFJlYWN0VmVyc2lvbgogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHZhciBkZWZhdWx0T25SZWNvdmVyYWJsZUVycm9yID0gdHlwZW9mIHJlcG9ydEVycm9yID09PSAiZnVuY3Rpb24iID8gKAogICAgICAgICAgLy8gSW4gbW9kZXJuIGJyb3dzZXJzLCByZXBvcnRFcnJvciB3aWxsIGRpc3BhdGNoIGFuIGVycm9yIGV2ZW50LAogICAgICAgICAgLy8gZW11bGF0aW5nIGFuIHVuY2F1Z2h0IEphdmFTY3JpcHQgZXJyb3IuCiAgICAgICAgICByZXBvcnRFcnJvcgogICAgICAgICkgOiBmdW5jdGlvbihlcnJvcjIpIHsKICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oZXJyb3IyKTsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIFJlYWN0RE9NUm9vdChpbnRlcm5hbFJvb3QpIHsKICAgICAgICAgIHRoaXMuX2ludGVybmFsUm9vdCA9IGludGVybmFsUm9vdDsKICAgICAgICB9CiAgICAgICAgUmVhY3RET01IeWRyYXRpb25Sb290LnByb3RvdHlwZS5yZW5kZXIgPSBSZWFjdERPTVJvb3QucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKGNoaWxkcmVuKSB7CiAgICAgICAgICB2YXIgcm9vdDMgPSB0aGlzLl9pbnRlcm5hbFJvb3Q7CiAgICAgICAgICBpZiAocm9vdDMgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgdXBkYXRlIGFuIHVubW91bnRlZCByb290LiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1sxXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogZG9lcyBub3Qgc3VwcG9ydCB0aGUgc2Vjb25kIGNhbGxiYWNrIGFyZ3VtZW50LiBUbyBleGVjdXRlIGEgc2lkZSBlZmZlY3QgYWZ0ZXIgcmVuZGVyaW5nLCBkZWNsYXJlIGl0IGluIGEgY29tcG9uZW50IGJvZHkgd2l0aCB1c2VFZmZlY3QoKS4iKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc1ZhbGlkQ29udGFpbmVyKGFyZ3VtZW50c1sxXSkpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHBhc3NlZCBhIGNvbnRhaW5lciB0byB0aGUgc2Vjb25kIGFyZ3VtZW50IG9mIHJvb3QucmVuZGVyKC4uLikuIFlvdSBkb24ndCBuZWVkIHRvIHBhc3MgaXQgYWdhaW4gc2luY2UgeW91IGFscmVhZHkgcGFzc2VkIGl0IHRvIGNyZWF0ZSB0aGUgcm9vdC4iKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJndW1lbnRzWzFdICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgcGFzc2VkIGEgc2Vjb25kIGFyZ3VtZW50IHRvIHJvb3QucmVuZGVyKC4uLikgYnV0IGl0IG9ubHkgYWNjZXB0cyBvbmUgYXJndW1lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbnRhaW5lcjIgPSByb290My5jb250YWluZXJJbmZvOwogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSAhPT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGhvc3RJbnN0YW5jZSA9IGZpbmRIb3N0SW5zdGFuY2VXaXRoTm9Qb3J0YWxzKHJvb3QzLmN1cnJlbnQpOwogICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UpIHsKICAgICAgICAgICAgICAgIGlmIChob3N0SW5zdGFuY2UucGFyZW50Tm9kZSAhPT0gY29udGFpbmVyMikgewogICAgICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IEl0IGxvb2tzIGxpa2UgdGhlIFJlYWN0LXJlbmRlcmVkIGNvbnRlbnQgb2YgdGhlIHJvb3QgY29udGFpbmVyIHdhcyByZW1vdmVkIHdpdGhvdXQgdXNpbmcgUmVhY3QuIFRoaXMgaXMgbm90IHN1cHBvcnRlZCBhbmQgd2lsbCBjYXVzZSBlcnJvcnMuIEluc3RlYWQsIGNhbGwgcm9vdC51bm1vdW50KCkgdG8gZW1wdHkgYSByb290J3MgY29udGFpbmVyLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGNoaWxkcmVuLCByb290MywgbnVsbCwgbnVsbCk7CiAgICAgICAgfTsKICAgICAgICBSZWFjdERPTUh5ZHJhdGlvblJvb3QucHJvdG90eXBlLnVubW91bnQgPSBSZWFjdERPTVJvb3QucHJvdG90eXBlLnVubW91bnQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbMF0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigidW5tb3VudCguLi4pOiBkb2VzIG5vdCBzdXBwb3J0IGEgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gYSBjb21wb25lbnQgYm9keSB3aXRoIHVzZUVmZmVjdCgpLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSB0aGlzLl9pbnRlcm5hbFJvb3Q7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgdGhpcy5faW50ZXJuYWxSb290ID0gbnVsbDsKICAgICAgICAgICAgdmFyIGNvbnRhaW5lcjIgPSByb290My5jb250YWluZXJJbmZvOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzQWxyZWFkeVJlbmRlcmluZygpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiQXR0ZW1wdGVkIHRvIHN5bmNocm9ub3VzbHkgdW5tb3VudCBhIHJvb3Qgd2hpbGUgUmVhY3Qgd2FzIGFscmVhZHkgcmVuZGVyaW5nLiBSZWFjdCBjYW5ub3QgZmluaXNoIHVubW91bnRpbmcgdGhlIHJvb3QgdW50aWwgdGhlIGN1cnJlbnQgcmVuZGVyIGhhcyBjb21wbGV0ZWQsIHdoaWNoIG1heSBsZWFkIHRvIGEgcmFjZSBjb25kaXRpb24uIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB1cGRhdGVDb250YWluZXIobnVsbCwgcm9vdDMsIG51bGwsIG51bGwpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdW5tYXJrQ29udGFpbmVyQXNSb290KGNvbnRhaW5lcjIpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUm9vdDIoY29udGFpbmVyMiwgb3B0aW9uczIpIHsKICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lcihjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImNyZWF0ZVJvb3QoLi4uKTogVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHdhcm5JZlJlYWN0RE9NQ29udGFpbmVySW5ERVYoY29udGFpbmVyMik7CiAgICAgICAgICB2YXIgaXNTdHJpY3RNb2RlID0gZmFsc2U7CiAgICAgICAgICB2YXIgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSAiIjsKICAgICAgICAgIHZhciBvblJlY292ZXJhYmxlRXJyb3IgPSBkZWZhdWx0T25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgdmFyIHRyYW5zaXRpb25DYWxsYmFja3MgPSBudWxsOwogICAgICAgICAgaWYgKG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChvcHRpb25zMi5oeWRyYXRlKSB7CiAgICAgICAgICAgICAgICB3YXJuMygiaHlkcmF0ZSB0aHJvdWdoIGNyZWF0ZVJvb3QgaXMgZGVwcmVjYXRlZC4gVXNlIFJlYWN0RE9NQ2xpZW50Lmh5ZHJhdGVSb290KGNvbnRhaW5lciwgPEFwcCAvPikgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zMiA9PT0gIm9iamVjdCIgJiYgb3B0aW9uczIgIT09IG51bGwgJiYgb3B0aW9uczIuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiWW91IHBhc3NlZCBhIEpTWCBlbGVtZW50IHRvIGNyZWF0ZVJvb3QuIFlvdSBwcm9iYWJseSBtZWFudCB0byBjYWxsIHJvb3QucmVuZGVyIGluc3RlYWQuIEV4YW1wbGUgdXNhZ2U6XG5cbiAgbGV0IHJvb3QgPSBjcmVhdGVSb290KGRvbUNvbnRhaW5lcik7XG4gIHJvb3QucmVuZGVyKDxBcHAgLz4pOyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIudW5zdGFibGVfc3RyaWN0TW9kZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIGlzU3RyaWN0TW9kZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLmlkZW50aWZpZXJQcmVmaXggIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGlkZW50aWZpZXJQcmVmaXggPSBvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3IgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIG9uUmVjb3ZlcmFibGVFcnJvciA9IG9wdGlvbnMyLm9uUmVjb3ZlcmFibGVFcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIudHJhbnNpdGlvbkNhbGxiYWNrcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdHJhbnNpdGlvbkNhbGxiYWNrcyA9IG9wdGlvbnMyLnRyYW5zaXRpb25DYWxsYmFja3M7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUNvbnRhaW5lcihjb250YWluZXIyLCBDb25jdXJyZW50Um9vdCwgbnVsbCwgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgbWFya0NvbnRhaW5lckFzUm9vdChyb290My5jdXJyZW50LCBjb250YWluZXIyKTsKICAgICAgICAgIHZhciByb290Q29udGFpbmVyRWxlbWVudCA9IGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSA/IGNvbnRhaW5lcjIucGFyZW50Tm9kZSA6IGNvbnRhaW5lcjI7CiAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhyb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICByZXR1cm4gbmV3IFJlYWN0RE9NUm9vdChyb290Myk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIFJlYWN0RE9NSHlkcmF0aW9uUm9vdChpbnRlcm5hbFJvb3QpIHsKICAgICAgICAgIHRoaXMuX2ludGVybmFsUm9vdCA9IGludGVybmFsUm9vdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVIeWRyYXRpb24odGFyZ2V0KSB7CiAgICAgICAgICBpZiAodGFyZ2V0KSB7CiAgICAgICAgICAgIHF1ZXVlRXhwbGljaXRIeWRyYXRpb25UYXJnZXQodGFyZ2V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgUmVhY3RET01IeWRyYXRpb25Sb290LnByb3RvdHlwZS51bnN0YWJsZV9zY2hlZHVsZUh5ZHJhdGlvbiA9IHNjaGVkdWxlSHlkcmF0aW9uOwogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVSb290KGNvbnRhaW5lcjIsIGluaXRpYWxDaGlsZHJlbiwgb3B0aW9uczIpIHsKICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lcihjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImh5ZHJhdGVSb290KC4uLik6IFRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuSWZSZWFjdERPTUNvbnRhaW5lckluREVWKGNvbnRhaW5lcjIpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5pdGlhbENoaWxkcmVuID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICBlcnJvcigiTXVzdCBwcm92aWRlIGluaXRpYWwgY2hpbGRyZW4gYXMgc2Vjb25kIGFyZ3VtZW50IHRvIGh5ZHJhdGVSb290LiBFeGFtcGxlIHVzYWdlOiBoeWRyYXRlUm9vdChkb21Db250YWluZXIsIDxBcHAgLz4pIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBoeWRyYXRpb25DYWxsYmFja3MgPSBvcHRpb25zMiAhPSBudWxsID8gb3B0aW9uczIgOiBudWxsOwogICAgICAgICAgdmFyIG11dGFibGVTb3VyY2VzID0gb3B0aW9uczIgIT0gbnVsbCAmJiBvcHRpb25zMi5oeWRyYXRlZFNvdXJjZXMgfHwgbnVsbDsKICAgICAgICAgIHZhciBpc1N0cmljdE1vZGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlID0gZmFsc2U7CiAgICAgICAgICB2YXIgaWRlbnRpZmllclByZWZpeCA9ICIiOwogICAgICAgICAgdmFyIG9uUmVjb3ZlcmFibGVFcnJvciA9IGRlZmF1bHRPblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICBpZiAob3B0aW9uczIgIT09IG51bGwgJiYgb3B0aW9uczIgIT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAob3B0aW9uczIudW5zdGFibGVfc3RyaWN0TW9kZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIGlzU3RyaWN0TW9kZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLmlkZW50aWZpZXJQcmVmaXggIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGlkZW50aWZpZXJQcmVmaXggPSBvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3IgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIG9uUmVjb3ZlcmFibGVFcnJvciA9IG9wdGlvbnMyLm9uUmVjb3ZlcmFibGVFcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3QzID0gY3JlYXRlSHlkcmF0aW9uQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgbnVsbCwgY29udGFpbmVyMiwgQ29uY3VycmVudFJvb3QsIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgbWFya0NvbnRhaW5lckFzUm9vdChyb290My5jdXJyZW50LCBjb250YWluZXIyKTsKICAgICAgICAgIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKGNvbnRhaW5lcjIpOwogICAgICAgICAgaWYgKG11dGFibGVTb3VyY2VzKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbXV0YWJsZVNvdXJjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgbXV0YWJsZVNvdXJjZSA9IG11dGFibGVTb3VyY2VzW2ldOwogICAgICAgICAgICAgIHJlZ2lzdGVyTXV0YWJsZVNvdXJjZUZvckh5ZHJhdGlvbihyb290MywgbXV0YWJsZVNvdXJjZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXcgUmVhY3RET01IeWRyYXRpb25Sb290KHJvb3QzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZENvbnRhaW5lcihub2RlKSB7CiAgICAgICAgICByZXR1cm4gISEobm9kZSAmJiAobm9kZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfRlJBR01FTlRfTk9ERSB8fCAhZGlzYWJsZUNvbW1lbnRzQXNET01Db250YWluZXJzKSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRDb250YWluZXJMZWdhY3kobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhKG5vZGUgJiYgKG5vZGUubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFICYmIG5vZGUubm9kZVZhbHVlID09PSAiIHJlYWN0LW1vdW50LXBvaW50LXVuc3RhYmxlICIpKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmUmVhY3RET01Db250YWluZXJJbkRFVihjb250YWluZXIyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgJiYgY29udGFpbmVyMi50YWdOYW1lICYmIGNvbnRhaW5lcjIudGFnTmFtZS50b1VwcGVyQ2FzZSgpID09PSAiQk9EWSIpIHsKICAgICAgICAgICAgICBlcnJvcigiY3JlYXRlUm9vdCgpOiBDcmVhdGluZyByb290cyBkaXJlY3RseSB3aXRoIGRvY3VtZW50LmJvZHkgaXMgZGlzY291cmFnZWQsIHNpbmNlIGl0cyBjaGlsZHJlbiBhcmUgb2Z0ZW4gbWFuaXB1bGF0ZWQgYnkgdGhpcmQtcGFydHkgc2NyaXB0cyBhbmQgYnJvd3NlciBleHRlbnNpb25zLiBUaGlzIG1heSBsZWFkIHRvIHN1YnRsZSByZWNvbmNpbGlhdGlvbiBpc3N1ZXMuIFRyeSB1c2luZyBhIGNvbnRhaW5lciBlbGVtZW50IGNyZWF0ZWQgZm9yIHlvdXIgYXBwLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChjb250YWluZXIyKSkgewogICAgICAgICAgICAgIGlmIChjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJZb3UgYXJlIGNhbGxpbmcgUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpIG9uIGEgY29udGFpbmVyIHRoYXQgd2FzIHByZXZpb3VzbHkgcGFzc2VkIHRvIFJlYWN0RE9NLnJlbmRlcigpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCJZb3UgYXJlIGNhbGxpbmcgUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpIG9uIGEgY29udGFpbmVyIHRoYXQgaGFzIGFscmVhZHkgYmVlbiBwYXNzZWQgdG8gY3JlYXRlUm9vdCgpIGJlZm9yZS4gSW5zdGVhZCwgY2FsbCByb290LnJlbmRlcigpIG9uIHRoZSBleGlzdGluZyByb290IGluc3RlYWQgaWYgeW91IHdhbnQgdG8gdXBkYXRlIGl0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMyA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciB0b3BMZXZlbFVwZGF0ZVdhcm5pbmdzOwogICAgICAgIHsKICAgICAgICAgIHRvcExldmVsVXBkYXRlV2FybmluZ3MgPSBmdW5jdGlvbihjb250YWluZXIyKSB7CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgJiYgY29udGFpbmVyMi5ub2RlVHlwZSAhPT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIGhvc3RJbnN0YW5jZSA9IGZpbmRIb3N0SW5zdGFuY2VXaXRoTm9Qb3J0YWxzKGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lci5jdXJyZW50KTsKICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlLnBhcmVudE5vZGUgIT09IGNvbnRhaW5lcjIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBJdCBsb29rcyBsaWtlIHRoZSBSZWFjdC1yZW5kZXJlZCBjb250ZW50IG9mIHRoaXMgY29udGFpbmVyIHdhcyByZW1vdmVkIHdpdGhvdXQgdXNpbmcgUmVhY3QuIFRoaXMgaXMgbm90IHN1cHBvcnRlZCBhbmQgd2lsbCBjYXVzZSBlcnJvcnMuIEluc3RlYWQsIGNhbGwgUmVhY3RET00udW5tb3VudENvbXBvbmVudEF0Tm9kZSB0byBlbXB0eSBhIGNvbnRhaW5lci4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGlzUm9vdFJlbmRlcmVkQnlTb21lUmVhY3QgPSAhIWNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgICAgdmFyIHJvb3RFbCA9IGdldFJlYWN0Um9vdEVsZW1lbnRJbkNvbnRhaW5lcihjb250YWluZXIyKTsKICAgICAgICAgICAgdmFyIGhhc05vblJvb3RSZWFjdENoaWxkID0gISEocm9vdEVsICYmIGdldEluc3RhbmNlRnJvbU5vZGUocm9vdEVsKSk7CiAgICAgICAgICAgIGlmIChoYXNOb25Sb290UmVhY3RDaGlsZCAmJiAhaXNSb290UmVuZGVyZWRCeVNvbWVSZWFjdCkgewogICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogUmVwbGFjaW5nIFJlYWN0LXJlbmRlcmVkIGNoaWxkcmVuIHdpdGggYSBuZXcgcm9vdCBjb21wb25lbnQuIElmIHlvdSBpbnRlbmRlZCB0byB1cGRhdGUgdGhlIGNoaWxkcmVuIG9mIHRoaXMgbm9kZSwgeW91IHNob3VsZCBpbnN0ZWFkIGhhdmUgdGhlIGV4aXN0aW5nIGNoaWxkcmVuIHVwZGF0ZSB0aGVpciBzdGF0ZSBhbmQgcmVuZGVyIHRoZSBuZXcgY29tcG9uZW50cyBpbnN0ZWFkIG9mIGNhbGxpbmcgUmVhY3RET00ucmVuZGVyLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgJiYgY29udGFpbmVyMi50YWdOYW1lICYmIGNvbnRhaW5lcjIudGFnTmFtZS50b1VwcGVyQ2FzZSgpID09PSAiQk9EWSIpIHsKICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKCk6IFJlbmRlcmluZyBjb21wb25lbnRzIGRpcmVjdGx5IGludG8gZG9jdW1lbnQuYm9keSBpcyBkaXNjb3VyYWdlZCwgc2luY2UgaXRzIGNoaWxkcmVuIGFyZSBvZnRlbiBtYW5pcHVsYXRlZCBieSB0aGlyZC1wYXJ0eSBzY3JpcHRzIGFuZCBicm93c2VyIGV4dGVuc2lvbnMuIFRoaXMgbWF5IGxlYWQgdG8gc3VidGxlIHJlY29uY2lsaWF0aW9uIGlzc3Vlcy4gVHJ5IHJlbmRlcmluZyBpbnRvIGEgY29udGFpbmVyIGVsZW1lbnQgY3JlYXRlZCBmb3IgeW91ciBhcHAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFJlYWN0Um9vdEVsZW1lbnRJbkNvbnRhaW5lcihjb250YWluZXIyKSB7CiAgICAgICAgICBpZiAoIWNvbnRhaW5lcjIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSkgewogICAgICAgICAgICByZXR1cm4gY29udGFpbmVyMi5kb2N1bWVudEVsZW1lbnQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gY29udGFpbmVyMi5maXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBub29wT25SZWNvdmVyYWJsZUVycm9yKCkgewogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsZWdhY3lDcmVhdGVSb290RnJvbURPTUNvbnRhaW5lcihjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2ssIGlzSHlkcmF0aW9uQ29udGFpbmVyKSB7CiAgICAgICAgICBpZiAoaXNIeWRyYXRpb25Db250YWluZXIpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBvcmlnaW5hbENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFB1YmxpY1Jvb3RJbnN0YW5jZShyb290Myk7CiAgICAgICAgICAgICAgICBvcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gY3JlYXRlSHlkcmF0aW9uQ29udGFpbmVyKAogICAgICAgICAgICAgIGluaXRpYWxDaGlsZHJlbiwKICAgICAgICAgICAgICBjYWxsYmFjaywKICAgICAgICAgICAgICBjb250YWluZXIyLAogICAgICAgICAgICAgIExlZ2FjeVJvb3QsCiAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAvLyBoeWRyYXRpb25DYWxsYmFja3MKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBpc1N0cmljdE1vZGUKICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAvLyBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLAogICAgICAgICAgICAgICIiLAogICAgICAgICAgICAgIC8vIGlkZW50aWZpZXJQcmVmaXgKICAgICAgICAgICAgICBub29wT25SZWNvdmVyYWJsZUVycm9yCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9IHJvb3QzOwogICAgICAgICAgICBtYXJrQ29udGFpbmVyQXNSb290KHJvb3QzLmN1cnJlbnQsIGNvbnRhaW5lcjIpOwogICAgICAgICAgICB2YXIgcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhyb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgIGZsdXNoU3luYygpOwogICAgICAgICAgICByZXR1cm4gcm9vdDM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcm9vdFNpYmxpbmc7CiAgICAgICAgICAgIHdoaWxlIChyb290U2libGluZyA9IGNvbnRhaW5lcjIubGFzdENoaWxkKSB7CiAgICAgICAgICAgICAgY29udGFpbmVyMi5yZW1vdmVDaGlsZChyb290U2libGluZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBfb3JpZ2luYWxDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRQdWJsaWNSb290SW5zdGFuY2UoX3Jvb3QpOwogICAgICAgICAgICAgICAgX29yaWdpbmFsQ2FsbGJhY2suY2FsbChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX3Jvb3QgPSBjcmVhdGVDb250YWluZXIoCiAgICAgICAgICAgICAgY29udGFpbmVyMiwKICAgICAgICAgICAgICBMZWdhY3lSb290LAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgLy8gaHlkcmF0aW9uQ2FsbGJhY2tzCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gaXNTdHJpY3RNb2RlCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwKICAgICAgICAgICAgICAiIiwKICAgICAgICAgICAgICAvLyBpZGVudGlmaWVyUHJlZml4CiAgICAgICAgICAgICAgbm9vcE9uUmVjb3ZlcmFibGVFcnJvcgogICAgICAgICAgICApOwogICAgICAgICAgICBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPSBfcm9vdDsKICAgICAgICAgICAgbWFya0NvbnRhaW5lckFzUm9vdChfcm9vdC5jdXJyZW50LCBjb250YWluZXIyKTsKICAgICAgICAgICAgdmFyIF9yb290Q29udGFpbmVyRWxlbWVudCA9IGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSA/IGNvbnRhaW5lcjIucGFyZW50Tm9kZSA6IGNvbnRhaW5lcjI7CiAgICAgICAgICAgIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKF9yb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB1cGRhdGVDb250YWluZXIoaW5pdGlhbENoaWxkcmVuLCBfcm9vdCwgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gX3Jvb3Q7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5PbkludmFsaWRDYWxsYmFjayQxKGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCAmJiB0eXBlb2YgY2FsbGJhY2sgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogRXhwZWN0ZWQgdGhlIGxhc3Qgb3B0aW9uYWwgYGNhbGxiYWNrYCBhcmd1bWVudCB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjYWxsZXJOYW1lLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBjaGlsZHJlbiwgY29udGFpbmVyMiwgZm9yY2VIeWRyYXRlLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICB0b3BMZXZlbFVwZGF0ZVdhcm5pbmdzKGNvbnRhaW5lcjIpOwogICAgICAgICAgICB3YXJuT25JbnZhbGlkQ2FsbGJhY2skMShjYWxsYmFjayA9PT0gdm9pZCAwID8gbnVsbCA6IGNhbGxiYWNrLCAicmVuZGVyIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWF5YmVSb290ID0gY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyOwogICAgICAgICAgdmFyIHJvb3QzOwogICAgICAgICAgaWYgKCFtYXliZVJvb3QpIHsKICAgICAgICAgICAgcm9vdDMgPSBsZWdhY3lDcmVhdGVSb290RnJvbURPTUNvbnRhaW5lcihjb250YWluZXIyLCBjaGlsZHJlbiwgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjaywgZm9yY2VIeWRyYXRlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJvb3QzID0gbWF5YmVSb290OwogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0UHVibGljUm9vdEluc3RhbmNlKHJvb3QzKTsKICAgICAgICAgICAgICAgIG9yaWdpbmFsQ2FsbGJhY2suY2FsbChpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVDb250YWluZXIoY2hpbGRyZW4sIHJvb3QzLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXRQdWJsaWNSb290SW5zdGFuY2Uocm9vdDMpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0RmluZERPTU5vZGUgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBmaW5kRE9NTm9kZShjb21wb25lbnRPckVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRGaW5kRE9NTm9kZSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dEZpbmRET01Ob2RlID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigiZmluZERPTU5vZGUgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IG1ham9yIHJlbGVhc2UuIEluc3RlYWQsIGFkZCBhIHJlZiBkaXJlY3RseSB0byB0aGUgZWxlbWVudCB5b3Ugd2FudCB0byByZWZlcmVuY2UuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLWZpbmQtbm9kZSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBvd25lciA9IFJlYWN0Q3VycmVudE93bmVyJDMuY3VycmVudDsKICAgICAgICAgICAgaWYgKG93bmVyICE9PSBudWxsICYmIG93bmVyLnN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciB3YXJuZWRBYm91dFJlZnNJblJlbmRlciA9IG93bmVyLnN0YXRlTm9kZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXI7CiAgICAgICAgICAgICAgaWYgKCF3YXJuZWRBYm91dFJlZnNJblJlbmRlcikgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGlzIGFjY2Vzc2luZyBmaW5kRE9NTm9kZSBpbnNpZGUgaXRzIHJlbmRlcigpLiByZW5kZXIoKSBzaG91bGQgYmUgYSBwdXJlIGZ1bmN0aW9uIG9mIHByb3BzIGFuZCBzdGF0ZS4gSXQgc2hvdWxkIG5ldmVyIGFjY2VzcyBzb21ldGhpbmcgdGhhdCByZXF1aXJlcyBzdGFsZSBkYXRhIGZyb20gdGhlIHByZXZpb3VzIHJlbmRlciwgc3VjaCBhcyByZWZzLiBNb3ZlIHRoaXMgbG9naWMgdG8gY29tcG9uZW50RGlkTW91bnQgYW5kIGNvbXBvbmVudERpZFVwZGF0ZSBpbnN0ZWFkLiIsIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShvd25lci50eXBlKSB8fCAiQSBjb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgb3duZXIuc3RhdGVOb2RlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlciA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChjb21wb25lbnRPckVsZW1lbnQgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjb21wb25lbnRPckVsZW1lbnQubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICByZXR1cm4gY29tcG9uZW50T3JFbGVtZW50OwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmluZEhvc3RJbnN0YW5jZVdpdGhXYXJuaW5nKGNvbXBvbmVudE9yRWxlbWVudCwgImZpbmRET01Ob2RlIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGUoZWxlbWVudCwgY29udGFpbmVyMiwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIlJlYWN0RE9NLmh5ZHJhdGUgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBpbiBSZWFjdCAxOC4gVXNlIGh5ZHJhdGVSb290IGluc3RlYWQuIFVudGlsIHlvdSBzd2l0Y2ggdG8gdGhlIG5ldyBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikgJiYgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID09PSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NLmh5ZHJhdGUoKSBvbiBhIGNvbnRhaW5lciB0aGF0IHdhcyBwcmV2aW91c2x5IHBhc3NlZCB0byBSZWFjdERPTUNsaWVudC5jcmVhdGVSb290KCkuIFRoaXMgaXMgbm90IHN1cHBvcnRlZC4gRGlkIHlvdSBtZWFuIHRvIGNhbGwgaHlkcmF0ZVJvb3QoY29udGFpbmVyLCBlbGVtZW50KT8iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKG51bGwsIGVsZW1lbnQsIGNvbnRhaW5lcjIsIHRydWUsIGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyKGVsZW1lbnQsIGNvbnRhaW5lcjIsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdERPTS5yZW5kZXIgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBpbiBSZWFjdCAxOC4gVXNlIGNyZWF0ZVJvb3QgaW5zdGVhZC4gVW50aWwgeW91IHN3aXRjaCB0byB0aGUgbmV3IEFQSSwgeW91ciBhcHAgd2lsbCBiZWhhdmUgYXMgaWYgaXQncyBydW5uaW5nIFJlYWN0IDE3LiBMZWFybiBtb3JlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3dpdGNoLXRvLWNyZWF0ZXJvb3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpc01vZGVyblJvb3QgPSBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChjb250YWluZXIyKSAmJiBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPT09IHZvaWQgMDsKICAgICAgICAgICAgaWYgKGlzTW9kZXJuUm9vdCkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgYXJlIGNhbGxpbmcgUmVhY3RET00ucmVuZGVyKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIHJvb3QucmVuZGVyKGVsZW1lbnQpPyIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIobnVsbCwgZWxlbWVudCwgY29udGFpbmVyMiwgZmFsc2UsIGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiUmVhY3RET00udW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIoKSBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGluIFJlYWN0IDE4LiBDb25zaWRlciB1c2luZyBhIHBvcnRhbCBpbnN0ZWFkLiBVbnRpbCB5b3Ugc3dpdGNoIHRvIHRoZSBjcmVhdGVSb290IEFQSSwgeW91ciBhcHAgd2lsbCBiZWhhdmUgYXMgaWYgaXQncyBydW5uaW5nIFJlYWN0IDE3LiBMZWFybiBtb3JlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3dpdGNoLXRvLWNyZWF0ZXJvb3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXJOb2RlKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocGFyZW50Q29tcG9uZW50ID09IG51bGwgfHwgIWhhczMocGFyZW50Q29tcG9uZW50KSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInBhcmVudENvbXBvbmVudCBtdXN0IGJlIGEgdmFsaWQgUmVhY3QgQ29tcG9uZW50Iik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBmYWxzZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHVubW91bnRDb21wb25lbnRBdE5vZGUoY29udGFpbmVyMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVubW91bnRDb21wb25lbnRBdE5vZGUpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbm1vdW50Q29tcG9uZW50QXROb2RlID0gdHJ1ZTsKICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gU3dpdGNoIHRvIHRoZSBjcmVhdGVSb290IEFQSS4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVubW91bnRDb21wb25lbnRBdE5vZGUoLi4uKTogVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpICYmIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICBpZiAoaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS51bm1vdW50Q29tcG9uZW50QXROb2RlKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIHJvb3QudW5tb3VudCgpPyIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgcm9vdEVsID0gZ2V0UmVhY3RSb290RWxlbWVudEluQ29udGFpbmVyKGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgIHZhciByZW5kZXJlZEJ5RGlmZmVyZW50UmVhY3QgPSByb290RWwgJiYgIWdldEluc3RhbmNlRnJvbU5vZGUocm9vdEVsKTsKICAgICAgICAgICAgICBpZiAocmVuZGVyZWRCeURpZmZlcmVudFJlYWN0KSB7CiAgICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSgpOiBUaGUgbm9kZSB5b3UncmUgYXR0ZW1wdGluZyB0byB1bm1vdW50IHdhcyByZW5kZXJlZCBieSBhbm90aGVyIGNvcHkgb2YgUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihudWxsLCBudWxsLCBjb250YWluZXIyLCBmYWxzZSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPSBudWxsOwogICAgICAgICAgICAgICAgdW5tYXJrQ29udGFpbmVyQXNSb290KGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIF9yb290RWwgPSBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMik7CiAgICAgICAgICAgICAgdmFyIGhhc05vblJvb3RSZWFjdENoaWxkID0gISEoX3Jvb3RFbCAmJiBnZXRJbnN0YW5jZUZyb21Ob2RlKF9yb290RWwpKTsKICAgICAgICAgICAgICB2YXIgaXNDb250YWluZXJSZWFjdFJvb3QgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgJiYgaXNWYWxpZENvbnRhaW5lckxlZ2FjeShjb250YWluZXIyLnBhcmVudE5vZGUpICYmICEhY29udGFpbmVyMi5wYXJlbnROb2RlLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICAgICAgaWYgKGhhc05vblJvb3RSZWFjdENoaWxkKSB7CiAgICAgICAgICAgICAgICBlcnJvcigidW5tb3VudENvbXBvbmVudEF0Tm9kZSgpOiBUaGUgbm9kZSB5b3UncmUgYXR0ZW1wdGluZyB0byB1bm1vdW50IHdhcyByZW5kZXJlZCBieSBSZWFjdCBhbmQgaXMgbm90IGEgdG9wLWxldmVsIGNvbnRhaW5lci4gJXMiLCBpc0NvbnRhaW5lclJlYWN0Um9vdCA/ICJZb3UgbWF5IGhhdmUgYWNjaWRlbnRhbGx5IHBhc3NlZCBpbiBhIFJlYWN0IHJvb3Qgbm9kZSBpbnN0ZWFkIG9mIGl0cyBjb250YWluZXIuIiA6ICJJbnN0ZWFkLCBoYXZlIHRoZSBwYXJlbnQgY29tcG9uZW50IHVwZGF0ZSBpdHMgc3RhdGUgYW5kIHJlcmVuZGVyIGluIG9yZGVyIHRvIHJlbW92ZSB0aGlzIGNvbXBvbmVudC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZXRBdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uJDEpOwogICAgICAgIHNldEF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uKGF0dGVtcHRDb250aW51b3VzSHlkcmF0aW9uJDEpOwogICAgICAgIHNldEF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eShhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkkMSk7CiAgICAgICAgc2V0R2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSk7CiAgICAgICAgc2V0QXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkocnVuV2l0aFByaW9yaXR5KTsKICAgICAgICB7CiAgICAgICAgICBpZiAodHlwZW9mIE1hcCAhPT0gImZ1bmN0aW9uIiB8fCAvLyAkRmxvd0lzc3VlIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIE1hcCBoYXMgbm8gcHJvdG90eXBlCiAgICAgICAgICBNYXAucHJvdG90eXBlID09IG51bGwgfHwgdHlwZW9mIE1hcC5wcm90b3R5cGUuZm9yRWFjaCAhPT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgU2V0ICE9PSAiZnVuY3Rpb24iIHx8IC8vICRGbG93SXNzdWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgU2V0IGhhcyBubyBwcm90b3R5cGUKICAgICAgICAgIFNldC5wcm90b3R5cGUgPT0gbnVsbCB8fCB0eXBlb2YgU2V0LnByb3RvdHlwZS5jbGVhciAhPT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgU2V0LnByb3RvdHlwZS5mb3JFYWNoICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdCBkZXBlbmRzIG9uIE1hcCBhbmQgU2V0IGJ1aWx0LWluIHR5cGVzLiBNYWtlIHN1cmUgdGhhdCB5b3UgbG9hZCBhIHBvbHlmaWxsIGluIG9sZGVyIGJyb3dzZXJzLiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtcG9seWZpbGxzIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbihyZXN0b3JlQ29udHJvbGxlZFN0YXRlJDMpOwogICAgICAgIHNldEJhdGNoaW5nSW1wbGVtZW50YXRpb24oYmF0Y2hlZFVwZGF0ZXMkMSwgZGlzY3JldGVVcGRhdGVzLCBmbHVzaFN5bmMpOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVBvcnRhbCQxKGNoaWxkcmVuLCBjb250YWluZXIyKSB7CiAgICAgICAgICB2YXIga2V5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiBudWxsOwogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyKGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjcmVhdGVQb3J0YWwzKGNoaWxkcmVuLCBjb250YWluZXIyLCBudWxsLCBrZXkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihwYXJlbnRDb21wb25lbnQsIGVsZW1lbnQsIGNvbnRhaW5lck5vZGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICByZXR1cm4gdW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIHZhciBJbnRlcm5hbHMgPSB7CiAgICAgICAgICB1c2luZ0NsaWVudEVudHJ5UG9pbnQ6IGZhbHNlLAogICAgICAgICAgLy8gS2VlcCBpbiBzeW5jIHdpdGggUmVhY3RUZXN0VXRpbHMuanMuCiAgICAgICAgICAvLyBUaGlzIGlzIGFuIGFycmF5IGZvciBiZXR0ZXIgbWluaWZpY2F0aW9uLgogICAgICAgICAgRXZlbnRzOiBbZ2V0SW5zdGFuY2VGcm9tTm9kZSwgZ2V0Tm9kZUZyb21JbnN0YW5jZSwgZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZSwgZW5xdWV1ZVN0YXRlUmVzdG9yZSwgcmVzdG9yZVN0YXRlSWZOZWVkZWQsIGJhdGNoZWRVcGRhdGVzJDFdCiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVSb290JDEoY29udGFpbmVyMiwgb3B0aW9uczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFJbnRlcm5hbHMudXNpbmdDbGllbnRFbnRyeVBvaW50ICYmIHRydWUpIHsKICAgICAgICAgICAgICBlcnJvcignWW91IGFyZSBpbXBvcnRpbmcgY3JlYXRlUm9vdCBmcm9tICJyZWFjdC1kb20iIHdoaWNoIGlzIG5vdCBzdXBwb3J0ZWQuIFlvdSBzaG91bGQgaW5zdGVhZCBpbXBvcnQgaXQgZnJvbSAicmVhY3QtZG9tL2NsaWVudCIuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjcmVhdGVSb290Mihjb250YWluZXIyLCBvcHRpb25zMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVSb290JDEoY29udGFpbmVyMiwgaW5pdGlhbENoaWxkcmVuLCBvcHRpb25zMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIUludGVybmFscy51c2luZ0NsaWVudEVudHJ5UG9pbnQgJiYgdHJ1ZSkgewogICAgICAgICAgICAgIGVycm9yKCdZb3UgYXJlIGltcG9ydGluZyBoeWRyYXRlUm9vdCBmcm9tICJyZWFjdC1kb20iIHdoaWNoIGlzIG5vdCBzdXBwb3J0ZWQuIFlvdSBzaG91bGQgaW5zdGVhZCBpbXBvcnQgaXQgZnJvbSAicmVhY3QtZG9tL2NsaWVudCIuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBoeWRyYXRlUm9vdChjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jJDEoZm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQWxyZWFkeVJlbmRlcmluZygpKSB7CiAgICAgICAgICAgICAgZXJyb3IoImZsdXNoU3luYyB3YXMgY2FsbGVkIGZyb20gaW5zaWRlIGEgbGlmZWN5Y2xlIG1ldGhvZC4gUmVhY3QgY2Fubm90IGZsdXNoIHdoZW4gUmVhY3QgaXMgYWxyZWFkeSByZW5kZXJpbmcuIENvbnNpZGVyIG1vdmluZyB0aGlzIGNhbGwgdG8gYSBzY2hlZHVsZXIgdGFzayBvciBtaWNybyB0YXNrLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmx1c2hTeW5jKGZuKTsKICAgICAgICB9CiAgICAgICAgdmFyIGZvdW5kRGV2VG9vbHMgPSBpbmplY3RJbnRvRGV2VG9vbHMoewogICAgICAgICAgZmluZEZpYmVyQnlIb3N0SW5zdGFuY2U6IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlLAogICAgICAgICAgYnVuZGxlVHlwZTogMSwKICAgICAgICAgIHZlcnNpb246IFJlYWN0VmVyc2lvbiwKICAgICAgICAgIHJlbmRlcmVyUGFja2FnZU5hbWU6ICJyZWFjdC1kb20iCiAgICAgICAgfSk7CiAgICAgICAgewogICAgICAgICAgaWYgKCFmb3VuZERldlRvb2xzICYmIGNhblVzZURPTTIgJiYgd2luZG93LnRvcCA9PT0gd2luZG93LnNlbGYpIHsKICAgICAgICAgICAgaWYgKG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikgPiAtMSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIkVkZ2UiKSA9PT0gLTEgfHwgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJGaXJlZm94IikgPiAtMSkgewogICAgICAgICAgICAgIHZhciBwcm90b2NvbCA9IHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbDsKICAgICAgICAgICAgICBpZiAoL14oaHR0cHM/fGZpbGUpOiQvLnRlc3QocHJvdG9jb2wpKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmluZm8oIiVjRG93bmxvYWQgdGhlIFJlYWN0IERldlRvb2xzIGZvciBhIGJldHRlciBkZXZlbG9wbWVudCBleHBlcmllbmNlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtZGV2dG9vbHMiICsgKHByb3RvY29sID09PSAiZmlsZToiID8gIlxuWW91IG1pZ2h0IG5lZWQgdG8gdXNlIGEgbG9jYWwgSFRUUCBzZXJ2ZXIgKGluc3RlYWQgb2YgZmlsZTovLyk6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9yZWFjdC1kZXZ0b29scy1mYXEiIDogIiIpLCAiZm9udC13ZWlnaHQ6Ym9sZCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBleHBvcnRzLl9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEID0gSW50ZXJuYWxzOwogICAgICAgIGV4cG9ydHMuY3JlYXRlUG9ydGFsID0gY3JlYXRlUG9ydGFsJDE7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVSb290ID0gY3JlYXRlUm9vdCQxOwogICAgICAgIGV4cG9ydHMuZmluZERPTU5vZGUgPSBmaW5kRE9NTm9kZTsKICAgICAgICBleHBvcnRzLmZsdXNoU3luYyA9IGZsdXNoU3luYyQxOwogICAgICAgIGV4cG9ydHMuaHlkcmF0ZSA9IGh5ZHJhdGU7CiAgICAgICAgZXhwb3J0cy5oeWRyYXRlUm9vdCA9IGh5ZHJhdGVSb290JDE7CiAgICAgICAgZXhwb3J0cy5yZW5kZXIgPSByZW5kZXI7CiAgICAgICAgZXhwb3J0cy51bm1vdW50Q29tcG9uZW50QXROb2RlID0gdW5tb3VudENvbXBvbmVudEF0Tm9kZTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2JhdGNoZWRVcGRhdGVzID0gYmF0Y2hlZFVwZGF0ZXMkMTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyID0gcmVuZGVyU3VidHJlZUludG9Db250YWluZXI7CiAgICAgICAgZXhwb3J0cy52ZXJzaW9uID0gUmVhY3RWZXJzaW9uOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgfSkoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9pbmRleC5qcwp2YXIgcmVxdWlyZV9yZWFjdF9kb20gPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgY2hlY2tEQ0UoKTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JlYWN0X2RvbV9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVhY3QtZG9tL2NsaWVudC5qcwp2YXIgcmVxdWlyZV9jbGllbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9jbGllbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBtID0gcmVxdWlyZV9yZWFjdF9kb20oKTsKICAgIGlmIChmYWxzZSkgewogICAgICBleHBvcnRzLmNyZWF0ZVJvb3QgPSBtLmNyZWF0ZVJvb3Q7CiAgICAgIGV4cG9ydHMuaHlkcmF0ZVJvb3QgPSBtLmh5ZHJhdGVSb290OwogICAgfSBlbHNlIHsKICAgICAgaSA9IG0uX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CiAgICAgIGV4cG9ydHMuY3JlYXRlUm9vdCA9IGZ1bmN0aW9uKGMsIG8pIHsKICAgICAgICBpLnVzaW5nQ2xpZW50RW50cnlQb2ludCA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBtLmNyZWF0ZVJvb3QoYywgbyk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9OwogICAgICBleHBvcnRzLmh5ZHJhdGVSb290ID0gZnVuY3Rpb24oYywgaCwgbykgewogICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gdHJ1ZTsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIG0uaHlkcmF0ZVJvb3QoYywgaCwgbyk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9OwogICAgfQogICAgdmFyIGk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvX2ludGVybmFsL2lzVW5zYWZlUHJvcGVydHkuanMKdmFyIHJlcXVpcmVfaXNVbnNhZmVQcm9wZXJ0eSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L19pbnRlcm5hbC9pc1Vuc2FmZVByb3BlcnR5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzVW5zYWZlUHJvcGVydHkoa2V5KSB7CiAgICAgIHJldHVybiBrZXkgPT09ICJfX3Byb3RvX18iOwogICAgfQogICAgZXhwb3J0cy5pc1Vuc2FmZVByb3BlcnR5ID0gaXNVbnNhZmVQcm9wZXJ0eTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzRGVlcEtleS5qcwp2YXIgcmVxdWlyZV9pc0RlZXBLZXkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzRGVlcEtleS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc0RlZXBLZXkoa2V5KSB7CiAgICAgIHN3aXRjaCAodHlwZW9mIGtleSkgewogICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgY2FzZSAic3ltYm9sIjogewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBjYXNlICJzdHJpbmciOiB7CiAgICAgICAgICByZXR1cm4ga2V5LmluY2x1ZGVzKCIuIikgfHwga2V5LmluY2x1ZGVzKCJbIikgfHwga2V5LmluY2x1ZGVzKCJdIik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBleHBvcnRzLmlzRGVlcEtleSA9IGlzRGVlcEtleTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL3RvS2V5LmpzCnZhciByZXF1aXJlX3RvS2V5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC90b0tleS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiB0b0tleSh2YWx1ZSkgewogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiB8fCB0eXBlb2YgdmFsdWUgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICAgIGlmIChPYmplY3QuaXModmFsdWU/LnZhbHVlT2Y/LigpLCAtMCkpIHsKICAgICAgICByZXR1cm4gIi0wIjsKICAgICAgfQogICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKTsKICAgIH0KICAgIGV4cG9ydHMudG9LZXkgPSB0b0tleTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b1N0cmluZy5qcwp2YXIgcmVxdWlyZV90b1N0cmluZyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvU3RyaW5nLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIHRvU3RyaW5nKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuICIiOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHJldHVybiB2YWx1ZS5tYXAodG9TdHJpbmcpLmpvaW4oIiwiKTsKICAgICAgfQogICAgICBjb25zdCByZXN1bHQgPSBTdHJpbmcodmFsdWUpOwogICAgICBpZiAocmVzdWx0ID09PSAiMCIgJiYgT2JqZWN0LmlzKE51bWJlcih2YWx1ZSksIC0wKSkgewogICAgICAgIHJldHVybiAiLTAiOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLnRvU3RyaW5nID0gdG9TdHJpbmc7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvdG9QYXRoLmpzCnZhciByZXF1aXJlX3RvUGF0aCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvUGF0aC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgdG9TdHJpbmcgPSByZXF1aXJlX3RvU3RyaW5nKCk7CiAgICB2YXIgdG9LZXkgPSByZXF1aXJlX3RvS2V5KCk7CiAgICBmdW5jdGlvbiB0b1BhdGgoZGVlcEtleSkgewogICAgICBpZiAoQXJyYXkuaXNBcnJheShkZWVwS2V5KSkgewogICAgICAgIHJldHVybiBkZWVwS2V5Lm1hcCh0b0tleS50b0tleSk7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBkZWVwS2V5ID09PSAic3ltYm9sIikgewogICAgICAgIHJldHVybiBbZGVlcEtleV07CiAgICAgIH0KICAgICAgZGVlcEtleSA9IHRvU3RyaW5nLnRvU3RyaW5nKGRlZXBLZXkpOwogICAgICBjb25zdCByZXN1bHQgPSBbXTsKICAgICAgY29uc3QgbGVuZ3RoID0gZGVlcEtleS5sZW5ndGg7CiAgICAgIGlmIChsZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgIGxldCBrZXkgPSAiIjsKICAgICAgbGV0IHF1b3RlQ2hhciA9ICIiOwogICAgICBsZXQgYnJhY2tldCA9IGZhbHNlOwogICAgICBpZiAoZGVlcEtleS5jaGFyQ29kZUF0KDApID09PSA0NikgewogICAgICAgIHJlc3VsdC5wdXNoKCIiKTsKICAgICAgICBpbmRleCsrOwogICAgICB9CiAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgIGNvbnN0IGNoYXIgPSBkZWVwS2V5W2luZGV4XTsKICAgICAgICBpZiAocXVvdGVDaGFyKSB7CiAgICAgICAgICBpZiAoY2hhciA9PT0gIlxcIiAmJiBpbmRleCArIDEgPCBsZW5ndGgpIHsKICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAga2V5ICs9IGRlZXBLZXlbaW5kZXhdOwogICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSBxdW90ZUNoYXIpIHsKICAgICAgICAgICAgcXVvdGVDaGFyID0gIiI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrZXkgKz0gY2hhcjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGJyYWNrZXQpIHsKICAgICAgICAgIGlmIChjaGFyID09PSAnIicgfHwgY2hhciA9PT0gIiciKSB7CiAgICAgICAgICAgIHF1b3RlQ2hhciA9IGNoYXI7CiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICJdIikgewogICAgICAgICAgICBicmFja2V0ID0gZmFsc2U7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICAgICAgICAgIGtleSA9ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga2V5ICs9IGNoYXI7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChjaGFyID09PSAiWyIpIHsKICAgICAgICAgICAgYnJhY2tldCA9IHRydWU7CiAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaChrZXkpOwogICAgICAgICAgICAgIGtleSA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICIuIikgewogICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgICAgICAgICBrZXkgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga2V5ICs9IGNoYXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGluZGV4Kys7CiAgICAgIH0KICAgICAgaWYgKGtleSkgewogICAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGV4cG9ydHMudG9QYXRoID0gdG9QYXRoOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvZ2V0LmpzCnZhciByZXF1aXJlX2dldCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvZ2V0LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc1Vuc2FmZVByb3BlcnR5ID0gcmVxdWlyZV9pc1Vuc2FmZVByb3BlcnR5KCk7CiAgICB2YXIgaXNEZWVwS2V5ID0gcmVxdWlyZV9pc0RlZXBLZXkoKTsKICAgIHZhciB0b0tleSA9IHJlcXVpcmVfdG9LZXkoKTsKICAgIHZhciB0b1BhdGggPSByZXF1aXJlX3RvUGF0aCgpOwogICAgZnVuY3Rpb24gZ2V0NShvYmplY3QsIHBhdGgyLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgaWYgKG9iamVjdCA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgfQogICAgICBzd2l0Y2ggKHR5cGVvZiBwYXRoMikgewogICAgICAgIGNhc2UgInN0cmluZyI6IHsKICAgICAgICAgIGlmIChpc1Vuc2FmZVByb3BlcnR5LmlzVW5zYWZlUHJvcGVydHkocGF0aDIpKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBvYmplY3RbcGF0aDJdOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChpc0RlZXBLZXkuaXNEZWVwS2V5KHBhdGgyKSkgewogICAgICAgICAgICAgIHJldHVybiBnZXQ1KG9iamVjdCwgdG9QYXRoLnRvUGF0aChwYXRoMiksIGRlZmF1bHRWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICBjYXNlICJzeW1ib2wiOiB7CiAgICAgICAgICBpZiAodHlwZW9mIHBhdGgyID09PSAibnVtYmVyIikgewogICAgICAgICAgICBwYXRoMiA9IHRvS2V5LnRvS2V5KHBhdGgyKTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IG9iamVjdFtwYXRoMl07CiAgICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHBhdGgyKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0V2l0aFBhdGgob2JqZWN0LCBwYXRoMiwgZGVmYXVsdFZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChPYmplY3QuaXMocGF0aDI/LnZhbHVlT2YoKSwgLTApKSB7CiAgICAgICAgICAgIHBhdGgyID0gIi0wIjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhdGgyID0gU3RyaW5nKHBhdGgyKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc1Vuc2FmZVByb3BlcnR5LmlzVW5zYWZlUHJvcGVydHkocGF0aDIpKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBvYmplY3RbcGF0aDJdOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gZ2V0V2l0aFBhdGgob2JqZWN0LCBwYXRoMiwgZGVmYXVsdFZhbHVlKSB7CiAgICAgIGlmIChwYXRoMi5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICB9CiAgICAgIGxldCBjdXJyZW50MyA9IG9iamVjdDsKICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHBhdGgyLmxlbmd0aDsgaW5kZXgrKykgewogICAgICAgIGlmIChjdXJyZW50MyA9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgIH0KICAgICAgICBpZiAoaXNVbnNhZmVQcm9wZXJ0eS5pc1Vuc2FmZVByb3BlcnR5KHBhdGgyW2luZGV4XSkpIHsKICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgfQogICAgICAgIGN1cnJlbnQzID0gY3VycmVudDNbcGF0aDJbaW5kZXhdXTsKICAgICAgfQogICAgICBpZiAoY3VycmVudDMgPT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgIH0KICAgICAgcmV0dXJuIGN1cnJlbnQzOwogICAgfQogICAgZXhwb3J0cy5nZXQgPSBnZXQ1OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvZ2V0LmpzCnZhciByZXF1aXJlX2dldDIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L2dldC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfZ2V0KCkuZ2V0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L3VuaXFCeS5qcwp2YXIgcmVxdWlyZV91bmlxQnkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9hcnJheS91bmlxQnkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gdW5pcUJ5MihhcnIsIG1hcHBlcikgewogICAgICBjb25zdCBtYXAzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBpdGVtID0gYXJyW2ldOwogICAgICAgIGNvbnN0IGtleSA9IG1hcHBlcihpdGVtKTsKICAgICAgICBpZiAoIW1hcDMuaGFzKGtleSkpIHsKICAgICAgICAgIG1hcDMuc2V0KGtleSwgaXRlbSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBBcnJheS5mcm9tKG1hcDMudmFsdWVzKCkpOwogICAgfQogICAgZXhwb3J0cy51bmlxQnkgPSB1bmlxQnkyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2Z1bmN0aW9uL2lkZW50aXR5LmpzCnZhciByZXF1aXJlX2lkZW50aXR5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvZnVuY3Rpb24vaWRlbnRpdHkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gaWRlbnRpdHk0KHgyKSB7CiAgICAgIHJldHVybiB4MjsKICAgIH0KICAgIGV4cG9ydHMuaWRlbnRpdHkgPSBpZGVudGl0eTQ7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzTGVuZ3RoLmpzCnZhciByZXF1aXJlX2lzTGVuZ3RoID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzTGVuZ3RoLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzTGVuZ3RoKHZhbHVlKSB7CiAgICAgIHJldHVybiBOdW1iZXIuaXNTYWZlSW50ZWdlcih2YWx1ZSkgJiYgdmFsdWUgPj0gMDsKICAgIH0KICAgIGV4cG9ydHMuaXNMZW5ndGggPSBpc0xlbmd0aDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzQXJyYXlMaWtlLmpzCnZhciByZXF1aXJlX2lzQXJyYXlMaWtlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FycmF5TGlrZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNMZW5ndGggPSByZXF1aXJlX2lzTGVuZ3RoKCk7CiAgICBmdW5jdGlvbiBpc0FycmF5TGlrZSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgIT09ICJmdW5jdGlvbiIgJiYgaXNMZW5ndGguaXNMZW5ndGgodmFsdWUubGVuZ3RoKTsKICAgIH0KICAgIGV4cG9ydHMuaXNBcnJheUxpa2UgPSBpc0FycmF5TGlrZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzT2JqZWN0TGlrZS5qcwp2YXIgcmVxdWlyZV9pc09iamVjdExpa2UgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzT2JqZWN0TGlrZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc09iamVjdExpa2UodmFsdWUpIHsKICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGw7CiAgICB9CiAgICBleHBvcnRzLmlzT2JqZWN0TGlrZSA9IGlzT2JqZWN0TGlrZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzQXJyYXlMaWtlT2JqZWN0LmpzCnZhciByZXF1aXJlX2lzQXJyYXlMaWtlT2JqZWN0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FycmF5TGlrZU9iamVjdC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNBcnJheUxpa2UgPSByZXF1aXJlX2lzQXJyYXlMaWtlKCk7CiAgICB2YXIgaXNPYmplY3RMaWtlID0gcmVxdWlyZV9pc09iamVjdExpa2UoKTsKICAgIGZ1bmN0aW9uIGlzQXJyYXlMaWtlT2JqZWN0KHZhbHVlKSB7CiAgICAgIHJldHVybiBpc09iamVjdExpa2UuaXNPYmplY3RMaWtlKHZhbHVlKSAmJiBpc0FycmF5TGlrZS5pc0FycmF5TGlrZSh2YWx1ZSk7CiAgICB9CiAgICBleHBvcnRzLmlzQXJyYXlMaWtlT2JqZWN0ID0gaXNBcnJheUxpa2VPYmplY3Q7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9wcm9wZXJ0eS5qcwp2YXIgcmVxdWlyZV9wcm9wZXJ0eSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvcHJvcGVydHkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGdldDUgPSByZXF1aXJlX2dldCgpOwogICAgZnVuY3Rpb24gcHJvcGVydHkocGF0aDIpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHJldHVybiBnZXQ1LmdldChvYmplY3QsIHBhdGgyKTsKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMucHJvcGVydHkgPSBwcm9wZXJ0eTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzT2JqZWN0LmpzCnZhciByZXF1aXJlX2lzT2JqZWN0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc09iamVjdC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKTsKICAgIH0KICAgIGV4cG9ydHMuaXNPYmplY3QgPSBpc09iamVjdDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNQcmltaXRpdmUuanMKdmFyIHJlcXVpcmVfaXNQcmltaXRpdmUgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNQcmltaXRpdmUuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gaXNQcmltaXRpdmUodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09IG51bGwgfHwgdHlwZW9mIHZhbHVlICE9PSAib2JqZWN0IiAmJiB0eXBlb2YgdmFsdWUgIT09ICJmdW5jdGlvbiI7CiAgICB9CiAgICBleHBvcnRzLmlzUHJpbWl0aXZlID0gaXNQcmltaXRpdmU7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvZXEuanMKdmFyIHJlcXVpcmVfZXEgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC9lcS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBlcSh2YWx1ZSwgb3RoZXIpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSBvdGhlciB8fCBOdW1iZXIuaXNOYU4odmFsdWUpICYmIE51bWJlci5pc05hTihvdGhlcik7CiAgICB9CiAgICBleHBvcnRzLmVxID0gZXE7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc01hdGNoV2l0aC5qcwp2YXIgcmVxdWlyZV9pc01hdGNoV2l0aCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNNYXRjaFdpdGguanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzT2JqZWN0ID0gcmVxdWlyZV9pc09iamVjdCgpOwogICAgdmFyIGlzUHJpbWl0aXZlID0gcmVxdWlyZV9pc1ByaW1pdGl2ZSgpOwogICAgdmFyIGVxID0gcmVxdWlyZV9lcSgpOwogICAgZnVuY3Rpb24gaXNNYXRjaFdpdGgodGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUpIHsKICAgICAgaWYgKHR5cGVvZiBjb21wYXJlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgcmV0dXJuIGlzTWF0Y2hXaXRoKHRhcmdldCwgc291cmNlLCAoKSA9PiB2b2lkIDApOwogICAgICB9CiAgICAgIHJldHVybiBpc01hdGNoV2l0aEludGVybmFsKHRhcmdldCwgc291cmNlLCBmdW5jdGlvbiBkb2VzTWF0Y2gob2JqVmFsdWUsIHNyY1ZhbHVlLCBrZXksIG9iamVjdCwgc291cmNlMiwgc3RhY2spIHsKICAgICAgICBjb25zdCBpc0VxdWFsID0gY29tcGFyZShvYmpWYWx1ZSwgc3JjVmFsdWUsIGtleSwgb2JqZWN0LCBzb3VyY2UyLCBzdGFjayk7CiAgICAgICAgaWYgKGlzRXF1YWwgIT09IHZvaWQgMCkgewogICAgICAgICAgcmV0dXJuIEJvb2xlYW4oaXNFcXVhbCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBpc01hdGNoV2l0aEludGVybmFsKG9ialZhbHVlLCBzcmNWYWx1ZSwgZG9lc01hdGNoLCBzdGFjayk7CiAgICAgIH0sIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkpOwogICAgfQogICAgZnVuY3Rpb24gaXNNYXRjaFdpdGhJbnRlcm5hbCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spIHsKICAgICAgaWYgKHNvdXJjZSA9PT0gdGFyZ2V0KSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgc3dpdGNoICh0eXBlb2Ygc291cmNlKSB7CiAgICAgICAgY2FzZSAib2JqZWN0IjogewogICAgICAgICAgcmV0dXJuIGlzT2JqZWN0TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgICB9CiAgICAgICAgY2FzZSAiZnVuY3Rpb24iOiB7CiAgICAgICAgICBjb25zdCBzb3VyY2VLZXlzID0gT2JqZWN0LmtleXMoc291cmNlKTsKICAgICAgICAgIGlmIChzb3VyY2VLZXlzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgcmV0dXJuIGlzTWF0Y2hXaXRoSW50ZXJuYWwodGFyZ2V0LCB7IC4uLnNvdXJjZSB9LCBjb21wYXJlLCBzdGFjayk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZXEuZXEodGFyZ2V0LCBzb3VyY2UpOwogICAgICAgIH0KICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICBpZiAoIWlzT2JqZWN0LmlzT2JqZWN0KHRhcmdldCkpIHsKICAgICAgICAgICAgcmV0dXJuIGVxLmVxKHRhcmdldCwgc291cmNlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2Ygc291cmNlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gc291cmNlID09PSAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaXNPYmplY3RNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spIHsKICAgICAgaWYgKHNvdXJjZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc291cmNlKSkgewogICAgICAgIHJldHVybiBpc0FycmF5TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgfQogICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgTWFwKSB7CiAgICAgICAgcmV0dXJuIGlzTWFwTWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgfQogICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgU2V0KSB7CiAgICAgICAgcmV0dXJuIGlzU2V0TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgfQogICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoc291cmNlKTsKICAgICAgaWYgKHRhcmdldCA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGtleXMubGVuZ3RoID09PSAwOwogICAgICB9CiAgICAgIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmIChzdGFjaz8uaGFzKHNvdXJjZSkpIHsKICAgICAgICByZXR1cm4gc3RhY2suZ2V0KHNvdXJjZSkgPT09IHRhcmdldDsKICAgICAgfQogICAgICBzdGFjaz8uc2V0KHNvdXJjZSwgdGFyZ2V0KTsKICAgICAgdHJ5IHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICAgICAgICBpZiAoIWlzUHJpbWl0aXZlLmlzUHJpbWl0aXZlKHRhcmdldCkgJiYgIShrZXkgaW4gdGFyZ2V0KSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc291cmNlW2tleV0gPT09IHZvaWQgMCAmJiB0YXJnZXRba2V5XSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzb3VyY2Vba2V5XSA9PT0gbnVsbCAmJiB0YXJnZXRba2V5XSAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBpc0VxdWFsID0gY29tcGFyZSh0YXJnZXRba2V5XSwgc291cmNlW2tleV0sIGtleSwgdGFyZ2V0LCBzb3VyY2UsIHN0YWNrKTsKICAgICAgICAgIGlmICghaXNFcXVhbCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIHN0YWNrPy5kZWxldGUoc291cmNlKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaXNNYXBNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spIHsKICAgICAgaWYgKHNvdXJjZS5zaXplID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKCEodGFyZ2V0IGluc3RhbmNlb2YgTWFwKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBmb3IgKGNvbnN0IFtrZXksIHNvdXJjZVZhbHVlXSBvZiBzb3VyY2UuZW50cmllcygpKSB7CiAgICAgICAgY29uc3QgdGFyZ2V0VmFsdWUgPSB0YXJnZXQuZ2V0KGtleSk7CiAgICAgICAgY29uc3QgaXNFcXVhbCA9IGNvbXBhcmUodGFyZ2V0VmFsdWUsIHNvdXJjZVZhbHVlLCBrZXksIHRhcmdldCwgc291cmNlLCBzdGFjayk7CiAgICAgICAgaWYgKGlzRXF1YWwgPT09IGZhbHNlKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgZnVuY3Rpb24gaXNBcnJheU1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjaykgewogICAgICBpZiAoc291cmNlLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh0YXJnZXQpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGNvbnN0IGNvdW50ZWRJbmRleCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc291cmNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3Qgc291cmNlSXRlbSA9IHNvdXJjZVtpXTsKICAgICAgICBsZXQgZm91bmQgPSBmYWxzZTsKICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRhcmdldC5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKGNvdW50ZWRJbmRleC5oYXMoaikpIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCB0YXJnZXRJdGVtID0gdGFyZ2V0W2pdOwogICAgICAgICAgbGV0IG1hdGNoZXMyID0gZmFsc2U7CiAgICAgICAgICBjb25zdCBpc0VxdWFsID0gY29tcGFyZSh0YXJnZXRJdGVtLCBzb3VyY2VJdGVtLCBpLCB0YXJnZXQsIHNvdXJjZSwgc3RhY2spOwogICAgICAgICAgaWYgKGlzRXF1YWwpIHsKICAgICAgICAgICAgbWF0Y2hlczIgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG1hdGNoZXMyKSB7CiAgICAgICAgICAgIGNvdW50ZWRJbmRleC5hZGQoaik7CiAgICAgICAgICAgIGZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBmdW5jdGlvbiBpc1NldE1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjaykgewogICAgICBpZiAoc291cmNlLnNpemUgPT09IDApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoISh0YXJnZXQgaW5zdGFuY2VvZiBTZXQpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiBpc0FycmF5TWF0Y2goWy4uLnRhcmdldF0sIFsuLi5zb3VyY2VdLCBjb21wYXJlLCBzdGFjayk7CiAgICB9CiAgICBleHBvcnRzLmlzTWF0Y2hXaXRoID0gaXNNYXRjaFdpdGg7CiAgICBleHBvcnRzLmlzU2V0TWF0Y2ggPSBpc1NldE1hdGNoOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNNYXRjaC5qcwp2YXIgcmVxdWlyZV9pc01hdGNoID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc01hdGNoLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc01hdGNoV2l0aCA9IHJlcXVpcmVfaXNNYXRjaFdpdGgoKTsKICAgIGZ1bmN0aW9uIGlzTWF0Y2godGFyZ2V0LCBzb3VyY2UpIHsKICAgICAgcmV0dXJuIGlzTWF0Y2hXaXRoLmlzTWF0Y2hXaXRoKHRhcmdldCwgc291cmNlLCAoKSA9PiB2b2lkIDApOwogICAgfQogICAgZXhwb3J0cy5pc01hdGNoID0gaXNNYXRjaDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2dldFN5bWJvbHMuanMKdmFyIHJlcXVpcmVfZ2V0U3ltYm9scyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvZ2V0U3ltYm9scy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBnZXRTeW1ib2xzKG9iamVjdCkgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhvYmplY3QpLmZpbHRlcigoc3ltYm9sKSA9PiBPYmplY3QucHJvdG90eXBlLnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwob2JqZWN0LCBzeW1ib2wpKTsKICAgIH0KICAgIGV4cG9ydHMuZ2V0U3ltYm9scyA9IGdldFN5bWJvbHM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9nZXRUYWcuanMKdmFyIHJlcXVpcmVfZ2V0VGFnID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9nZXRUYWcuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZ2V0VGFnKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlID09PSB2b2lkIDAgPyAiW29iamVjdCBVbmRlZmluZWRdIiA6ICJbb2JqZWN0IE51bGxdIjsKICAgICAgfQogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKTsKICAgIH0KICAgIGV4cG9ydHMuZ2V0VGFnID0gZ2V0VGFnOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdGFncy5qcwp2YXIgcmVxdWlyZV90YWdzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC90YWdzLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciByZWdleHBUYWcgPSAiW29iamVjdCBSZWdFeHBdIjsKICAgIHZhciBzdHJpbmdUYWcgPSAiW29iamVjdCBTdHJpbmddIjsKICAgIHZhciBudW1iZXJUYWcgPSAiW29iamVjdCBOdW1iZXJdIjsKICAgIHZhciBib29sZWFuVGFnID0gIltvYmplY3QgQm9vbGVhbl0iOwogICAgdmFyIGFyZ3VtZW50c1RhZyA9ICJbb2JqZWN0IEFyZ3VtZW50c10iOwogICAgdmFyIHN5bWJvbFRhZyA9ICJbb2JqZWN0IFN5bWJvbF0iOwogICAgdmFyIGRhdGVUYWcgPSAiW29iamVjdCBEYXRlXSI7CiAgICB2YXIgbWFwVGFnID0gIltvYmplY3QgTWFwXSI7CiAgICB2YXIgc2V0VGFnID0gIltvYmplY3QgU2V0XSI7CiAgICB2YXIgYXJyYXlUYWcgPSAiW29iamVjdCBBcnJheV0iOwogICAgdmFyIGZ1bmN0aW9uVGFnID0gIltvYmplY3QgRnVuY3Rpb25dIjsKICAgIHZhciBhcnJheUJ1ZmZlclRhZyA9ICJbb2JqZWN0IEFycmF5QnVmZmVyXSI7CiAgICB2YXIgb2JqZWN0VGFnID0gIltvYmplY3QgT2JqZWN0XSI7CiAgICB2YXIgZXJyb3JUYWcgPSAiW29iamVjdCBFcnJvcl0iOwogICAgdmFyIGRhdGFWaWV3VGFnID0gIltvYmplY3QgRGF0YVZpZXddIjsKICAgIHZhciB1aW50OEFycmF5VGFnID0gIltvYmplY3QgVWludDhBcnJheV0iOwogICAgdmFyIHVpbnQ4Q2xhbXBlZEFycmF5VGFnID0gIltvYmplY3QgVWludDhDbGFtcGVkQXJyYXldIjsKICAgIHZhciB1aW50MTZBcnJheVRhZyA9ICJbb2JqZWN0IFVpbnQxNkFycmF5XSI7CiAgICB2YXIgdWludDMyQXJyYXlUYWcgPSAiW29iamVjdCBVaW50MzJBcnJheV0iOwogICAgdmFyIGJpZ1VpbnQ2NEFycmF5VGFnID0gIltvYmplY3QgQmlnVWludDY0QXJyYXldIjsKICAgIHZhciBpbnQ4QXJyYXlUYWcgPSAiW29iamVjdCBJbnQ4QXJyYXldIjsKICAgIHZhciBpbnQxNkFycmF5VGFnID0gIltvYmplY3QgSW50MTZBcnJheV0iOwogICAgdmFyIGludDMyQXJyYXlUYWcgPSAiW29iamVjdCBJbnQzMkFycmF5XSI7CiAgICB2YXIgYmlnSW50NjRBcnJheVRhZyA9ICJbb2JqZWN0IEJpZ0ludDY0QXJyYXldIjsKICAgIHZhciBmbG9hdDMyQXJyYXlUYWcgPSAiW29iamVjdCBGbG9hdDMyQXJyYXldIjsKICAgIHZhciBmbG9hdDY0QXJyYXlUYWcgPSAiW29iamVjdCBGbG9hdDY0QXJyYXldIjsKICAgIGV4cG9ydHMuYXJndW1lbnRzVGFnID0gYXJndW1lbnRzVGFnOwogICAgZXhwb3J0cy5hcnJheUJ1ZmZlclRhZyA9IGFycmF5QnVmZmVyVGFnOwogICAgZXhwb3J0cy5hcnJheVRhZyA9IGFycmF5VGFnOwogICAgZXhwb3J0cy5iaWdJbnQ2NEFycmF5VGFnID0gYmlnSW50NjRBcnJheVRhZzsKICAgIGV4cG9ydHMuYmlnVWludDY0QXJyYXlUYWcgPSBiaWdVaW50NjRBcnJheVRhZzsKICAgIGV4cG9ydHMuYm9vbGVhblRhZyA9IGJvb2xlYW5UYWc7CiAgICBleHBvcnRzLmRhdGFWaWV3VGFnID0gZGF0YVZpZXdUYWc7CiAgICBleHBvcnRzLmRhdGVUYWcgPSBkYXRlVGFnOwogICAgZXhwb3J0cy5lcnJvclRhZyA9IGVycm9yVGFnOwogICAgZXhwb3J0cy5mbG9hdDMyQXJyYXlUYWcgPSBmbG9hdDMyQXJyYXlUYWc7CiAgICBleHBvcnRzLmZsb2F0NjRBcnJheVRhZyA9IGZsb2F0NjRBcnJheVRhZzsKICAgIGV4cG9ydHMuZnVuY3Rpb25UYWcgPSBmdW5jdGlvblRhZzsKICAgIGV4cG9ydHMuaW50MTZBcnJheVRhZyA9IGludDE2QXJyYXlUYWc7CiAgICBleHBvcnRzLmludDMyQXJyYXlUYWcgPSBpbnQzMkFycmF5VGFnOwogICAgZXhwb3J0cy5pbnQ4QXJyYXlUYWcgPSBpbnQ4QXJyYXlUYWc7CiAgICBleHBvcnRzLm1hcFRhZyA9IG1hcFRhZzsKICAgIGV4cG9ydHMubnVtYmVyVGFnID0gbnVtYmVyVGFnOwogICAgZXhwb3J0cy5vYmplY3RUYWcgPSBvYmplY3RUYWc7CiAgICBleHBvcnRzLnJlZ2V4cFRhZyA9IHJlZ2V4cFRhZzsKICAgIGV4cG9ydHMuc2V0VGFnID0gc2V0VGFnOwogICAgZXhwb3J0cy5zdHJpbmdUYWcgPSBzdHJpbmdUYWc7CiAgICBleHBvcnRzLnN5bWJvbFRhZyA9IHN5bWJvbFRhZzsKICAgIGV4cG9ydHMudWludDE2QXJyYXlUYWcgPSB1aW50MTZBcnJheVRhZzsKICAgIGV4cG9ydHMudWludDMyQXJyYXlUYWcgPSB1aW50MzJBcnJheVRhZzsKICAgIGV4cG9ydHMudWludDhBcnJheVRhZyA9IHVpbnQ4QXJyYXlUYWc7CiAgICBleHBvcnRzLnVpbnQ4Q2xhbXBlZEFycmF5VGFnID0gdWludDhDbGFtcGVkQXJyYXlUYWc7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzVHlwZWRBcnJheS5qcwp2YXIgcmVxdWlyZV9pc1R5cGVkQXJyYXkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNUeXBlZEFycmF5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzVHlwZWRBcnJheSh4MikgewogICAgICByZXR1cm4gQXJyYXlCdWZmZXIuaXNWaWV3KHgyKSAmJiAhKHgyIGluc3RhbmNlb2YgRGF0YVZpZXcpOwogICAgfQogICAgZXhwb3J0cy5pc1R5cGVkQXJyYXkgPSBpc1R5cGVkQXJyYXk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3Qvb2JqZWN0L2Nsb25lRGVlcFdpdGguanMKdmFyIHJlcXVpcmVfY2xvbmVEZWVwV2l0aCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L29iamVjdC9jbG9uZURlZXBXaXRoLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBnZXRTeW1ib2xzID0gcmVxdWlyZV9nZXRTeW1ib2xzKCk7CiAgICB2YXIgZ2V0VGFnID0gcmVxdWlyZV9nZXRUYWcoKTsKICAgIHZhciB0YWdzID0gcmVxdWlyZV90YWdzKCk7CiAgICB2YXIgaXNQcmltaXRpdmUgPSByZXF1aXJlX2lzUHJpbWl0aXZlKCk7CiAgICB2YXIgaXNUeXBlZEFycmF5ID0gcmVxdWlyZV9pc1R5cGVkQXJyYXkoKTsKICAgIGZ1bmN0aW9uIGNsb25lRGVlcFdpdGgob2JqLCBjbG9uZVZhbHVlKSB7CiAgICAgIHJldHVybiBjbG9uZURlZXBXaXRoSW1wbChvYmosIHZvaWQgMCwgb2JqLCAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpLCBjbG9uZVZhbHVlKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNsb25lRGVlcFdpdGhJbXBsKHZhbHVlVG9DbG9uZSwga2V5VG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2sgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpLCBjbG9uZVZhbHVlID0gdm9pZCAwKSB7CiAgICAgIGNvbnN0IGNsb25lZCA9IGNsb25lVmFsdWU/Lih2YWx1ZVRvQ2xvbmUsIGtleVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrKTsKICAgICAgaWYgKGNsb25lZCAhPT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIGNsb25lZDsKICAgICAgfQogICAgICBpZiAoaXNQcmltaXRpdmUuaXNQcmltaXRpdmUodmFsdWVUb0Nsb25lKSkgewogICAgICAgIHJldHVybiB2YWx1ZVRvQ2xvbmU7CiAgICAgIH0KICAgICAgaWYgKHN0YWNrLmhhcyh2YWx1ZVRvQ2xvbmUpKSB7CiAgICAgICAgcmV0dXJuIHN0YWNrLmdldCh2YWx1ZVRvQ2xvbmUpOwogICAgICB9CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlVG9DbG9uZSkpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkodmFsdWVUb0Nsb25lLmxlbmd0aCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlVG9DbG9uZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgcmVzdWx0W2ldID0gY2xvbmVEZWVwV2l0aEltcGwodmFsdWVUb0Nsb25lW2ldLCBpLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIGlmIChPYmplY3QuaGFzT3duKHZhbHVlVG9DbG9uZSwgImluZGV4IikpIHsKICAgICAgICAgIHJlc3VsdC5pbmRleCA9IHZhbHVlVG9DbG9uZS5pbmRleDsKICAgICAgICB9CiAgICAgICAgaWYgKE9iamVjdC5oYXNPd24odmFsdWVUb0Nsb25lLCAiaW5wdXQiKSkgewogICAgICAgICAgcmVzdWx0LmlucHV0ID0gdmFsdWVUb0Nsb25lLmlucHV0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHZhbHVlVG9DbG9uZS5nZXRUaW1lKCkpOwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgUmVnRXhwKHZhbHVlVG9DbG9uZS5zb3VyY2UsIHZhbHVlVG9DbG9uZS5mbGFncyk7CiAgICAgICAgcmVzdWx0Lmxhc3RJbmRleCA9IHZhbHVlVG9DbG9uZS5sYXN0SW5kZXg7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgTWFwKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHZhbHVlVG9DbG9uZSkgewogICAgICAgICAgcmVzdWx0LnNldChrZXksIGNsb25lRGVlcFdpdGhJbXBsKHZhbHVlLCBrZXksIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIFNldCkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlVG9DbG9uZSkgewogICAgICAgICAgcmVzdWx0LmFkZChjbG9uZURlZXBXaXRoSW1wbCh2YWx1ZSwgdm9pZCAwLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgQnVmZmVyICE9PSAidW5kZWZpbmVkIiAmJiBCdWZmZXIuaXNCdWZmZXIodmFsdWVUb0Nsb25lKSkgewogICAgICAgIHJldHVybiB2YWx1ZVRvQ2xvbmUuc3ViYXJyYXkoKTsKICAgICAgfQogICAgICBpZiAoaXNUeXBlZEFycmF5LmlzVHlwZWRBcnJheSh2YWx1ZVRvQ2xvbmUpKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IChPYmplY3QuZ2V0UHJvdG90eXBlT2YodmFsdWVUb0Nsb25lKSkuY29uc3RydWN0b3IodmFsdWVUb0Nsb25lLmxlbmd0aCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlVG9DbG9uZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgcmVzdWx0W2ldID0gY2xvbmVEZWVwV2l0aEltcGwodmFsdWVUb0Nsb25lW2ldLCBpLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIEFycmF5QnVmZmVyIHx8IHR5cGVvZiBTaGFyZWRBcnJheUJ1ZmZlciAhPT0gInVuZGVmaW5lZCIgJiYgdmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgU2hhcmVkQXJyYXlCdWZmZXIpIHsKICAgICAgICByZXR1cm4gdmFsdWVUb0Nsb25lLnNsaWNlKDApOwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBEYXRhVmlldykgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBEYXRhVmlldyh2YWx1ZVRvQ2xvbmUuYnVmZmVyLnNsaWNlKDApLCB2YWx1ZVRvQ2xvbmUuYnl0ZU9mZnNldCwgdmFsdWVUb0Nsb25lLmJ5dGVMZW5ndGgpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgRmlsZSAhPT0gInVuZGVmaW5lZCIgJiYgdmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgRmlsZSkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBGaWxlKFt2YWx1ZVRvQ2xvbmVdLCB2YWx1ZVRvQ2xvbmUubmFtZSwgewogICAgICAgICAgdHlwZTogdmFsdWVUb0Nsb25lLnR5cGUKICAgICAgICB9KTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodHlwZW9mIEJsb2IgIT09ICJ1bmRlZmluZWQiICYmIHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIEJsb2IpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQmxvYihbdmFsdWVUb0Nsb25lXSwgeyB0eXBlOiB2YWx1ZVRvQ2xvbmUudHlwZSB9KTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgRXJyb3IpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgdmFsdWVUb0Nsb25lLmNvbnN0cnVjdG9yKCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICByZXN1bHQubWVzc2FnZSA9IHZhbHVlVG9DbG9uZS5tZXNzYWdlOwogICAgICAgIHJlc3VsdC5uYW1lID0gdmFsdWVUb0Nsb25lLm5hbWU7CiAgICAgICAgcmVzdWx0LnN0YWNrID0gdmFsdWVUb0Nsb25lLnN0YWNrOwogICAgICAgIHJlc3VsdC5jYXVzZSA9IHZhbHVlVG9DbG9uZS5jYXVzZTsKICAgICAgICBjb3B5UHJvcGVydGllcyhyZXN1bHQsIHZhbHVlVG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIEJvb2xlYW4pIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQm9vbGVhbih2YWx1ZVRvQ2xvbmUudmFsdWVPZigpKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgTnVtYmVyKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IE51bWJlcih2YWx1ZVRvQ2xvbmUudmFsdWVPZigpKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgU3RyaW5nKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IFN0cmluZyh2YWx1ZVRvQ2xvbmUudmFsdWVPZigpKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHZhbHVlVG9DbG9uZSA9PT0gIm9iamVjdCIgJiYgaXNDbG9uZWFibGVPYmplY3QodmFsdWVUb0Nsb25lKSkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IE9iamVjdC5jcmVhdGUoT2JqZWN0LmdldFByb3RvdHlwZU9mKHZhbHVlVG9DbG9uZSkpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZVRvQ2xvbmU7CiAgICB9CiAgICBmdW5jdGlvbiBjb3B5UHJvcGVydGllcyh0YXJnZXQsIHNvdXJjZSwgb2JqZWN0VG9DbG9uZSA9IHRhcmdldCwgc3RhY2ssIGNsb25lVmFsdWUpIHsKICAgICAgY29uc3Qga2V5cyA9IFsuLi5PYmplY3Qua2V5cyhzb3VyY2UpLCAuLi5nZXRTeW1ib2xzLmdldFN5bWJvbHMoc291cmNlKV07CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpOwogICAgICAgIGlmIChkZXNjcmlwdG9yID09IG51bGwgfHwgZGVzY3JpcHRvci53cml0YWJsZSkgewogICAgICAgICAgdGFyZ2V0W2tleV0gPSBjbG9uZURlZXBXaXRoSW1wbChzb3VyY2Vba2V5XSwga2V5LCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpc0Nsb25lYWJsZU9iamVjdChvYmplY3QpIHsKICAgICAgc3dpdGNoIChnZXRUYWcuZ2V0VGFnKG9iamVjdCkpIHsKICAgICAgICBjYXNlIHRhZ3MuYXJndW1lbnRzVGFnOgogICAgICAgIGNhc2UgdGFncy5hcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MuYXJyYXlCdWZmZXJUYWc6CiAgICAgICAgY2FzZSB0YWdzLmRhdGFWaWV3VGFnOgogICAgICAgIGNhc2UgdGFncy5ib29sZWFuVGFnOgogICAgICAgIGNhc2UgdGFncy5kYXRlVGFnOgogICAgICAgIGNhc2UgdGFncy5mbG9hdDMyQXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLmZsb2F0NjRBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MuaW50OEFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5pbnQxNkFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5pbnQzMkFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5tYXBUYWc6CiAgICAgICAgY2FzZSB0YWdzLm51bWJlclRhZzoKICAgICAgICBjYXNlIHRhZ3Mub2JqZWN0VGFnOgogICAgICAgIGNhc2UgdGFncy5yZWdleHBUYWc6CiAgICAgICAgY2FzZSB0YWdzLnNldFRhZzoKICAgICAgICBjYXNlIHRhZ3Muc3RyaW5nVGFnOgogICAgICAgIGNhc2UgdGFncy5zeW1ib2xUYWc6CiAgICAgICAgY2FzZSB0YWdzLnVpbnQ4QXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLnVpbnQ4Q2xhbXBlZEFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy51aW50MTZBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MudWludDMyQXJyYXlUYWc6IHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBleHBvcnRzLmNsb25lRGVlcFdpdGggPSBjbG9uZURlZXBXaXRoOwogICAgZXhwb3J0cy5jbG9uZURlZXBXaXRoSW1wbCA9IGNsb25lRGVlcFdpdGhJbXBsOwogICAgZXhwb3J0cy5jb3B5UHJvcGVydGllcyA9IGNvcHlQcm9wZXJ0aWVzOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L29iamVjdC9jbG9uZURlZXAuanMKdmFyIHJlcXVpcmVfY2xvbmVEZWVwID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3Qvb2JqZWN0L2Nsb25lRGVlcC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgY2xvbmVEZWVwV2l0aCA9IHJlcXVpcmVfY2xvbmVEZWVwV2l0aCgpOwogICAgZnVuY3Rpb24gY2xvbmVEZWVwKG9iaikgewogICAgICByZXR1cm4gY2xvbmVEZWVwV2l0aC5jbG9uZURlZXBXaXRoSW1wbChvYmosIHZvaWQgMCwgb2JqLCAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpLCB2b2lkIDApOwogICAgfQogICAgZXhwb3J0cy5jbG9uZURlZXAgPSBjbG9uZURlZXA7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9tYXRjaGVzLmpzCnZhciByZXF1aXJlX21hdGNoZXMgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXMuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzTWF0Y2ggPSByZXF1aXJlX2lzTWF0Y2goKTsKICAgIHZhciBjbG9uZURlZXAgPSByZXF1aXJlX2Nsb25lRGVlcCgpOwogICAgZnVuY3Rpb24gbWF0Y2hlczIoc291cmNlKSB7CiAgICAgIHNvdXJjZSA9IGNsb25lRGVlcC5jbG9uZURlZXAoc291cmNlKTsKICAgICAgcmV0dXJuICh0YXJnZXQpID0+IHsKICAgICAgICByZXR1cm4gaXNNYXRjaC5pc01hdGNoKHRhcmdldCwgc291cmNlKTsKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMubWF0Y2hlcyA9IG1hdGNoZXMyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvY2xvbmVEZWVwV2l0aC5qcwp2YXIgcmVxdWlyZV9jbG9uZURlZXBXaXRoMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvY2xvbmVEZWVwV2l0aC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgY2xvbmVEZWVwV2l0aCQxID0gcmVxdWlyZV9jbG9uZURlZXBXaXRoKCk7CiAgICB2YXIgdGFncyA9IHJlcXVpcmVfdGFncygpOwogICAgZnVuY3Rpb24gY2xvbmVEZWVwV2l0aChvYmosIGN1c3RvbWl6ZXIpIHsKICAgICAgcmV0dXJuIGNsb25lRGVlcFdpdGgkMS5jbG9uZURlZXBXaXRoKG9iaiwgKHZhbHVlLCBrZXksIG9iamVjdCwgc3RhY2spID0+IHsKICAgICAgICBjb25zdCBjbG9uZWQgPSBjdXN0b21pemVyPy4odmFsdWUsIGtleSwgb2JqZWN0LCBzdGFjayk7CiAgICAgICAgaWYgKGNsb25lZCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICByZXR1cm4gY2xvbmVkOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIG9iaiAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKG9iaikpIHsKICAgICAgICAgIGNhc2UgdGFncy5udW1iZXJUYWc6CiAgICAgICAgICBjYXNlIHRhZ3Muc3RyaW5nVGFnOgogICAgICAgICAgY2FzZSB0YWdzLmJvb2xlYW5UYWc6IHsKICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IG9iai5jb25zdHJ1Y3RvcihvYmo/LnZhbHVlT2YoKSk7CiAgICAgICAgICAgIGNsb25lRGVlcFdpdGgkMS5jb3B5UHJvcGVydGllcyhyZXN1bHQsIG9iaik7CiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgICBjYXNlIHRhZ3MuYXJndW1lbnRzVGFnOiB7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHt9OwogICAgICAgICAgICBjbG9uZURlZXBXaXRoJDEuY29weVByb3BlcnRpZXMocmVzdWx0LCBvYmopOwogICAgICAgICAgICByZXN1bHQubGVuZ3RoID0gb2JqLmxlbmd0aDsKICAgICAgICAgICAgcmVzdWx0W1N5bWJvbC5pdGVyYXRvcl0gPSBvYmpbU3ltYm9sLml0ZXJhdG9yXTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgZXhwb3J0cy5jbG9uZURlZXBXaXRoID0gY2xvbmVEZWVwV2l0aDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L2Nsb25lRGVlcC5qcwp2YXIgcmVxdWlyZV9jbG9uZURlZXAyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9jbG9uZURlZXAuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGNsb25lRGVlcFdpdGggPSByZXF1aXJlX2Nsb25lRGVlcFdpdGgyKCk7CiAgICBmdW5jdGlvbiBjbG9uZURlZXAob2JqKSB7CiAgICAgIHJldHVybiBjbG9uZURlZXBXaXRoLmNsb25lRGVlcFdpdGgob2JqKTsKICAgIH0KICAgIGV4cG9ydHMuY2xvbmVEZWVwID0gY2xvbmVEZWVwOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNJbmRleC5qcwp2YXIgcmVxdWlyZV9pc0luZGV4ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0luZGV4LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBJU19VTlNJR05FRF9JTlRFR0VSID0gL14oPzowfFsxLTldXGQqKSQvOwogICAgZnVuY3Rpb24gaXNJbmRleCh2YWx1ZSwgbGVuZ3RoID0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIpIHsKICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICBjYXNlICJudW1iZXIiOiB7CiAgICAgICAgICByZXR1cm4gTnVtYmVyLmlzSW50ZWdlcih2YWx1ZSkgJiYgdmFsdWUgPj0gMCAmJiB2YWx1ZSA8IGxlbmd0aDsKICAgICAgICB9CiAgICAgICAgY2FzZSAic3ltYm9sIjogewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBjYXNlICJzdHJpbmciOiB7CiAgICAgICAgICByZXR1cm4gSVNfVU5TSUdORURfSU5URUdFUi50ZXN0KHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaXNJbmRleCA9IGlzSW5kZXg7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FyZ3VtZW50cy5qcwp2YXIgcmVxdWlyZV9pc0FyZ3VtZW50cyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNBcmd1bWVudHMuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGdldFRhZyA9IHJlcXVpcmVfZ2V0VGFnKCk7CiAgICBmdW5jdGlvbiBpc0FyZ3VtZW50cyh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiBnZXRUYWcuZ2V0VGFnKHZhbHVlKSA9PT0gIltvYmplY3QgQXJndW1lbnRzXSI7CiAgICB9CiAgICBleHBvcnRzLmlzQXJndW1lbnRzID0gaXNBcmd1bWVudHM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9oYXMuanMKdmFyIHJlcXVpcmVfaGFzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9oYXMuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzRGVlcEtleSA9IHJlcXVpcmVfaXNEZWVwS2V5KCk7CiAgICB2YXIgaXNJbmRleCA9IHJlcXVpcmVfaXNJbmRleCgpOwogICAgdmFyIGlzQXJndW1lbnRzID0gcmVxdWlyZV9pc0FyZ3VtZW50cygpOwogICAgdmFyIHRvUGF0aCA9IHJlcXVpcmVfdG9QYXRoKCk7CiAgICBmdW5jdGlvbiBoYXMzKG9iamVjdCwgcGF0aDIpIHsKICAgICAgbGV0IHJlc29sdmVkUGF0aDsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkocGF0aDIpKSB7CiAgICAgICAgcmVzb2x2ZWRQYXRoID0gcGF0aDI7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHBhdGgyID09PSAic3RyaW5nIiAmJiBpc0RlZXBLZXkuaXNEZWVwS2V5KHBhdGgyKSAmJiBvYmplY3Q/LltwYXRoMl0gPT0gbnVsbCkgewogICAgICAgIHJlc29sdmVkUGF0aCA9IHRvUGF0aC50b1BhdGgocGF0aDIpOwogICAgICB9IGVsc2UgewogICAgICAgIHJlc29sdmVkUGF0aCA9IFtwYXRoMl07CiAgICAgIH0KICAgICAgaWYgKHJlc29sdmVkUGF0aC5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgbGV0IGN1cnJlbnQzID0gb2JqZWN0OwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc29sdmVkUGF0aC5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGtleSA9IHJlc29sdmVkUGF0aFtpXTsKICAgICAgICBpZiAoY3VycmVudDMgPT0gbnVsbCB8fCAhT2JqZWN0Lmhhc093bihjdXJyZW50Mywga2V5KSkgewogICAgICAgICAgY29uc3QgaXNTcGFyc2VJbmRleCA9IChBcnJheS5pc0FycmF5KGN1cnJlbnQzKSB8fCBpc0FyZ3VtZW50cy5pc0FyZ3VtZW50cyhjdXJyZW50MykpICYmIGlzSW5kZXguaXNJbmRleChrZXkpICYmIGtleSA8IGN1cnJlbnQzLmxlbmd0aDsKICAgICAgICAgIGlmICghaXNTcGFyc2VJbmRleCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGN1cnJlbnQzID0gY3VycmVudDNba2V5XTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGV4cG9ydHMuaGFzID0gaGFzMzsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXNQcm9wZXJ0eS5qcwp2YXIgcmVxdWlyZV9tYXRjaGVzUHJvcGVydHkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXNQcm9wZXJ0eS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNNYXRjaCA9IHJlcXVpcmVfaXNNYXRjaCgpOwogICAgdmFyIHRvS2V5ID0gcmVxdWlyZV90b0tleSgpOwogICAgdmFyIGNsb25lRGVlcCA9IHJlcXVpcmVfY2xvbmVEZWVwMigpOwogICAgdmFyIGdldDUgPSByZXF1aXJlX2dldCgpOwogICAgdmFyIGhhczMgPSByZXF1aXJlX2hhcygpOwogICAgZnVuY3Rpb24gbWF0Y2hlc1Byb3BlcnR5KHByb3BlcnR5LCBzb3VyY2UpIHsKICAgICAgc3dpdGNoICh0eXBlb2YgcHJvcGVydHkpIHsKICAgICAgICBjYXNlICJvYmplY3QiOiB7CiAgICAgICAgICBpZiAoT2JqZWN0LmlzKHByb3BlcnR5Py52YWx1ZU9mKCksIC0wKSkgewogICAgICAgICAgICBwcm9wZXJ0eSA9ICItMCI7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgY2FzZSAibnVtYmVyIjogewogICAgICAgICAgcHJvcGVydHkgPSB0b0tleS50b0tleShwcm9wZXJ0eSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgc291cmNlID0gY2xvbmVEZWVwLmNsb25lRGVlcChzb3VyY2UpOwogICAgICByZXR1cm4gZnVuY3Rpb24odGFyZ2V0KSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gZ2V0NS5nZXQodGFyZ2V0LCBwcm9wZXJ0eSk7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICByZXR1cm4gaGFzMy5oYXModGFyZ2V0LCBwcm9wZXJ0eSk7CiAgICAgICAgfQogICAgICAgIGlmIChzb3VyY2UgPT09IHZvaWQgMCkgewogICAgICAgICAgcmV0dXJuIHJlc3VsdCA9PT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaXNNYXRjaC5pc01hdGNoKHJlc3VsdCwgc291cmNlKTsKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMubWF0Y2hlc1Byb3BlcnR5ID0gbWF0Y2hlc1Byb3BlcnR5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL2l0ZXJhdGVlLmpzCnZhciByZXF1aXJlX2l0ZXJhdGVlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvaXRlcmF0ZWUuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlkZW50aXR5NCA9IHJlcXVpcmVfaWRlbnRpdHkoKTsKICAgIHZhciBwcm9wZXJ0eSA9IHJlcXVpcmVfcHJvcGVydHkoKTsKICAgIHZhciBtYXRjaGVzMiA9IHJlcXVpcmVfbWF0Y2hlcygpOwogICAgdmFyIG1hdGNoZXNQcm9wZXJ0eSA9IHJlcXVpcmVfbWF0Y2hlc1Byb3BlcnR5KCk7CiAgICBmdW5jdGlvbiBpdGVyYXRlZSh2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgICAgIHJldHVybiBpZGVudGl0eTQuaWRlbnRpdHk7CiAgICAgIH0KICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICBjYXNlICJmdW5jdGlvbiI6IHsKICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgY2FzZSAib2JqZWN0IjogewogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICByZXR1cm4gbWF0Y2hlc1Byb3BlcnR5Lm1hdGNoZXNQcm9wZXJ0eSh2YWx1ZVswXSwgdmFsdWVbMV0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoZXMyLm1hdGNoZXModmFsdWUpOwogICAgICAgIH0KICAgICAgICBjYXNlICJzdHJpbmciOgogICAgICAgIGNhc2UgInN5bWJvbCI6CiAgICAgICAgY2FzZSAibnVtYmVyIjogewogICAgICAgICAgcmV0dXJuIHByb3BlcnR5LnByb3BlcnR5KHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaXRlcmF0ZWUgPSBpdGVyYXRlZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvdW5pcUJ5LmpzCnZhciByZXF1aXJlX3VuaXFCeTIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvdW5pcUJ5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciB1bmlxQnkkMSA9IHJlcXVpcmVfdW5pcUJ5KCk7CiAgICB2YXIgaWRlbnRpdHk0ID0gcmVxdWlyZV9pZGVudGl0eSgpOwogICAgdmFyIGlzQXJyYXlMaWtlT2JqZWN0ID0gcmVxdWlyZV9pc0FycmF5TGlrZU9iamVjdCgpOwogICAgdmFyIGl0ZXJhdGVlID0gcmVxdWlyZV9pdGVyYXRlZSgpOwogICAgZnVuY3Rpb24gdW5pcUJ5MihhcnJheSwgaXRlcmF0ZWUkMSA9IGlkZW50aXR5NC5pZGVudGl0eSkgewogICAgICBpZiAoIWlzQXJyYXlMaWtlT2JqZWN0LmlzQXJyYXlMaWtlT2JqZWN0KGFycmF5KSkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgICByZXR1cm4gdW5pcUJ5JDEudW5pcUJ5KEFycmF5LmZyb20oYXJyYXkpLCBpdGVyYXRlZS5pdGVyYXRlZShpdGVyYXRlZSQxKSk7CiAgICB9CiAgICBleHBvcnRzLnVuaXFCeSA9IHVuaXFCeTI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC91bmlxQnkuanMKdmFyIHJlcXVpcmVfdW5pcUJ5MyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvdW5pcUJ5LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV91bmlxQnkyKCkudW5pcUJ5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0uZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfdXNlX3N5bmNfZXh0ZXJuYWxfc3RvcmVfc2hpbV9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0uZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIChmdW5jdGlvbigpIHsKICAgICAgZnVuY3Rpb24gaXM0KHgyLCB5MikgewogICAgICAgIHJldHVybiB4MiA9PT0geTIgJiYgKDAgIT09IHgyIHx8IDEgLyB4MiA9PT0gMSAvIHkyKSB8fCB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHVzZVN5bmNFeHRlcm5hbFN0b3JlJDIoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCkgewogICAgICAgIGRpZFdhcm5PbGQxOEFscGhhIHx8IHZvaWQgMCA9PT0gUmVhY3QzOC5zdGFydFRyYW5zaXRpb24gfHwgKGRpZFdhcm5PbGQxOEFscGhhID0gdHJ1ZSwgY29uc29sZS5lcnJvcigKICAgICAgICAgICJZb3UgYXJlIHVzaW5nIGFuIG91dGRhdGVkLCBwcmUtcmVsZWFzZSBhbHBoYSBvZiBSZWFjdCAxOCB0aGF0IGRvZXMgbm90IHN1cHBvcnQgdXNlU3luY0V4dGVybmFsU3RvcmUuIFRoZSB1c2Utc3luYy1leHRlcm5hbC1zdG9yZSBzaGltIHdpbGwgbm90IHdvcmsgY29ycmVjdGx5LiBVcGdyYWRlIHRvIGEgbmV3ZXIgcHJlLXJlbGVhc2UuIgogICAgICAgICkpOwogICAgICAgIHZhciB2YWx1ZSA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgaWYgKCFkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCkgewogICAgICAgICAgdmFyIGNhY2hlZFZhbHVlID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgIG9iamVjdElzKHZhbHVlLCBjYWNoZWRWYWx1ZSkgfHwgKGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAgICJUaGUgcmVzdWx0IG9mIGdldFNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIKICAgICAgICAgICksIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZSk7CiAgICAgICAgfQogICAgICAgIGNhY2hlZFZhbHVlID0gdXNlU3RhdGUxMih7CiAgICAgICAgICBpbnN0OiB7IHZhbHVlLCBnZXRTbmFwc2hvdCB9CiAgICAgICAgfSk7CiAgICAgICAgdmFyIGluc3QgPSBjYWNoZWRWYWx1ZVswXS5pbnN0LCBmb3JjZVVwZGF0ZSA9IGNhY2hlZFZhbHVlWzFdOwogICAgICAgIHVzZUxheW91dEVmZmVjdDkoCiAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5zdC52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICBpbnN0LmdldFNuYXBzaG90ID0gZ2V0U25hcHNob3Q7CiAgICAgICAgICAgIGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkgJiYgZm9yY2VVcGRhdGUoeyBpbnN0IH0pOwogICAgICAgICAgfSwKICAgICAgICAgIFtzdWJzY3JpYmUsIHZhbHVlLCBnZXRTbmFwc2hvdF0KICAgICAgICApOwogICAgICAgIHVzZUVmZmVjdDE0KAogICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkgJiYgZm9yY2VVcGRhdGUoeyBpbnN0IH0pOwogICAgICAgICAgICByZXR1cm4gc3Vic2NyaWJlKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGNoZWNrSWZTbmFwc2hvdENoYW5nZWQoaW5zdCkgJiYgZm9yY2VVcGRhdGUoeyBpbnN0IH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBbc3Vic2NyaWJlXQogICAgICAgICk7CiAgICAgICAgdXNlRGVidWdWYWx1ZTIodmFsdWUpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpIHsKICAgICAgICB2YXIgbGF0ZXN0R2V0U25hcHNob3QgPSBpbnN0LmdldFNuYXBzaG90OwogICAgICAgIGluc3QgPSBpbnN0LnZhbHVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICB2YXIgbmV4dFZhbHVlID0gbGF0ZXN0R2V0U25hcHNob3QoKTsKICAgICAgICAgIHJldHVybiAhb2JqZWN0SXMoaW5zdCwgbmV4dFZhbHVlKTsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHVzZVN5bmNFeHRlcm5hbFN0b3JlJDEoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCkgewogICAgICAgIHJldHVybiBnZXRTbmFwc2hvdCgpOwogICAgICB9CiAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQoRXJyb3IoKSk7CiAgICAgIHZhciBSZWFjdDM4ID0gcmVxdWlyZV9yZWFjdCgpLCBvYmplY3RJcyA9ICJmdW5jdGlvbiIgPT09IHR5cGVvZiBPYmplY3QuaXMgPyBPYmplY3QuaXMgOiBpczQsIHVzZVN0YXRlMTIgPSBSZWFjdDM4LnVzZVN0YXRlLCB1c2VFZmZlY3QxNCA9IFJlYWN0MzgudXNlRWZmZWN0LCB1c2VMYXlvdXRFZmZlY3Q5ID0gUmVhY3QzOC51c2VMYXlvdXRFZmZlY3QsIHVzZURlYnVnVmFsdWUyID0gUmVhY3QzOC51c2VEZWJ1Z1ZhbHVlLCBkaWRXYXJuT2xkMThBbHBoYSA9IGZhbHNlLCBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IGZhbHNlLCBzaGltID0gInVuZGVmaW5lZCIgPT09IHR5cGVvZiB3aW5kb3cgfHwgInVuZGVmaW5lZCIgPT09IHR5cGVvZiB3aW5kb3cuZG9jdW1lbnQgfHwgInVuZGVmaW5lZCIgPT09IHR5cGVvZiB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCA/IHVzZVN5bmNFeHRlcm5hbFN0b3JlJDEgOiB1c2VTeW5jRXh0ZXJuYWxTdG9yZSQyOwogICAgICBleHBvcnRzLnVzZVN5bmNFeHRlcm5hbFN0b3JlID0gdm9pZCAwICE9PSBSZWFjdDM4LnVzZVN5bmNFeHRlcm5hbFN0b3JlID8gUmVhY3QzOC51c2VTeW5jRXh0ZXJuYWxTdG9yZSA6IHNoaW07CiAgICAgICJ1bmRlZmluZWQiICE9PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICYmICJmdW5jdGlvbiIgPT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AgJiYgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKEVycm9yKCkpOwogICAgfSkoKTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3NoaW0vaW5kZXguanMKdmFyIHJlcXVpcmVfc2hpbSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvc2hpbS9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3VzZV9zeW5jX2V4dGVybmFsX3N0b3JlX3NoaW1fZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltL3dpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfd2l0aF9zZWxlY3Rvcl9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0vd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgKGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiBpczQoeDIsIHkyKSB7CiAgICAgICAgcmV0dXJuIHgyID09PSB5MiAmJiAoMCAhPT0geDIgfHwgMSAvIHgyID09PSAxIC8geTIpIHx8IHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgICAgIH0KICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgJiYgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChFcnJvcigpKTsKICAgICAgdmFyIFJlYWN0MzggPSByZXF1aXJlX3JlYWN0KCksIHNoaW0gPSByZXF1aXJlX3NoaW0oKSwgb2JqZWN0SXMgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgT2JqZWN0LmlzID8gT2JqZWN0LmlzIDogaXM0LCB1c2VTeW5jRXh0ZXJuYWxTdG9yZTIgPSBzaGltLnVzZVN5bmNFeHRlcm5hbFN0b3JlLCB1c2VSZWYxNiA9IFJlYWN0MzgudXNlUmVmLCB1c2VFZmZlY3QxNCA9IFJlYWN0MzgudXNlRWZmZWN0LCB1c2VNZW1vOSA9IFJlYWN0MzgudXNlTWVtbywgdXNlRGVidWdWYWx1ZTIgPSBSZWFjdDM4LnVzZURlYnVnVmFsdWU7CiAgICAgIGV4cG9ydHMudXNlU3luY0V4dGVybmFsU3RvcmVXaXRoU2VsZWN0b3IgPSBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCwgc2VsZWN0b3IsIGlzRXF1YWwpIHsKICAgICAgICB2YXIgaW5zdFJlZiA9IHVzZVJlZjE2KG51bGwpOwogICAgICAgIGlmIChudWxsID09PSBpbnN0UmVmLmN1cnJlbnQpIHsKICAgICAgICAgIHZhciBpbnN0ID0geyBoYXNWYWx1ZTogZmFsc2UsIHZhbHVlOiBudWxsIH07CiAgICAgICAgICBpbnN0UmVmLmN1cnJlbnQgPSBpbnN0OwogICAgICAgIH0gZWxzZSBpbnN0ID0gaW5zdFJlZi5jdXJyZW50OwogICAgICAgIGluc3RSZWYgPSB1c2VNZW1vOSgKICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmdW5jdGlvbiBtZW1vaXplZFNlbGVjdG9yKG5leHRTbmFwc2hvdCkgewogICAgICAgICAgICAgIGlmICghaGFzTWVtbykgewogICAgICAgICAgICAgICAgaGFzTWVtbyA9IHRydWU7CiAgICAgICAgICAgICAgICBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICAgICAgbmV4dFNuYXBzaG90ID0gc2VsZWN0b3IobmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IGlzRXF1YWwgJiYgaW5zdC5oYXNWYWx1ZSkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFNlbGVjdGlvbiA9IGluc3QudmFsdWU7CiAgICAgICAgICAgICAgICAgIGlmIChpc0VxdWFsKGN1cnJlbnRTZWxlY3Rpb24sIG5leHRTbmFwc2hvdCkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0aW9uID0gY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudFNlbGVjdGlvbiA9IG1lbW9pemVkU2VsZWN0aW9uOwogICAgICAgICAgICAgIGlmIChvYmplY3RJcyhtZW1vaXplZFNuYXBzaG90LCBuZXh0U25hcHNob3QpKQogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgICAgdmFyIG5leHRTZWxlY3Rpb24gPSBzZWxlY3RvcihuZXh0U25hcHNob3QpOwogICAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IGlzRXF1YWwgJiYgaXNFcXVhbChjdXJyZW50U2VsZWN0aW9uLCBuZXh0U2VsZWN0aW9uKSkKICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90LCBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICAgIG1lbW9pemVkU25hcHNob3QgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0aW9uID0gbmV4dFNlbGVjdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzTWVtbyA9IGZhbHNlLCBtZW1vaXplZFNuYXBzaG90LCBtZW1vaXplZFNlbGVjdGlvbiwgbWF5YmVHZXRTZXJ2ZXJTbmFwc2hvdCA9IHZvaWQgMCA9PT0gZ2V0U2VydmVyU25hcHNob3QgPyBudWxsIDogZ2V0U2VydmVyU25hcHNob3Q7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3RvcihnZXRTbmFwc2hvdCgpKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG51bGwgPT09IG1heWJlR2V0U2VydmVyU25hcHNob3QgPyB2b2lkIDAgOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdG9yKG1heWJlR2V0U2VydmVyU25hcHNob3QoKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBdOwogICAgICAgICAgfSwKICAgICAgICAgIFtnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QsIHNlbGVjdG9yLCBpc0VxdWFsXQogICAgICAgICk7CiAgICAgICAgdmFyIHZhbHVlID0gdXNlU3luY0V4dGVybmFsU3RvcmUyKHN1YnNjcmliZSwgaW5zdFJlZlswXSwgaW5zdFJlZlsxXSk7CiAgICAgICAgdXNlRWZmZWN0MTQoCiAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5zdC5oYXNWYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGluc3QudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgIH0sCiAgICAgICAgICBbdmFsdWVdCiAgICAgICAgKTsKICAgICAgICB1c2VEZWJ1Z1ZhbHVlMih2YWx1ZSk7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9OwogICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChFcnJvcigpKTsKICAgIH0pKCk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9zaGltL3dpdGgtc2VsZWN0b3IuanMKdmFyIHJlcXVpcmVfd2l0aF9zZWxlY3RvciA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvc2hpbS93aXRoLXNlbGVjdG9yLmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfd2l0aF9zZWxlY3Rvcl9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvY29tcGFyZVZhbHVlcy5qcwp2YXIgcmVxdWlyZV9jb21wYXJlVmFsdWVzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9jb21wYXJlVmFsdWVzLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGdldFByaW9yaXR5KGEpIHsKICAgICAgaWYgKHR5cGVvZiBhID09PSAic3ltYm9sIikgewogICAgICAgIHJldHVybiAxOwogICAgICB9CiAgICAgIGlmIChhID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIDI7CiAgICAgIH0KICAgICAgaWYgKGEgPT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiAzOwogICAgICB9CiAgICAgIGlmIChhICE9PSBhKSB7CiAgICAgICAgcmV0dXJuIDQ7CiAgICAgIH0KICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICB2YXIgY29tcGFyZVZhbHVlcyA9IChhLCBiLCBvcmRlcikgPT4gewogICAgICBpZiAoYSAhPT0gYikgewogICAgICAgIGNvbnN0IGFQcmlvcml0eSA9IGdldFByaW9yaXR5KGEpOwogICAgICAgIGNvbnN0IGJQcmlvcml0eSA9IGdldFByaW9yaXR5KGIpOwogICAgICAgIGlmIChhUHJpb3JpdHkgPT09IGJQcmlvcml0eSAmJiBhUHJpb3JpdHkgPT09IDApIHsKICAgICAgICAgIGlmIChhIDwgYikgewogICAgICAgICAgICByZXR1cm4gb3JkZXIgPT09ICJkZXNjIiA/IDEgOiAtMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhID4gYikgewogICAgICAgICAgICByZXR1cm4gb3JkZXIgPT09ICJkZXNjIiA/IC0xIDogMTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9yZGVyID09PSAiZGVzYyIgPyBiUHJpb3JpdHkgLSBhUHJpb3JpdHkgOiBhUHJpb3JpdHkgLSBiUHJpb3JpdHk7CiAgICAgIH0KICAgICAgcmV0dXJuIDA7CiAgICB9OwogICAgZXhwb3J0cy5jb21wYXJlVmFsdWVzID0gY29tcGFyZVZhbHVlczsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzU3ltYm9sLmpzCnZhciByZXF1aXJlX2lzU3ltYm9sID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc1N5bWJvbC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc1N5bWJvbCh2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAic3ltYm9sIiB8fCB2YWx1ZSBpbnN0YW5jZW9mIFN5bWJvbDsKICAgIH0KICAgIGV4cG9ydHMuaXNTeW1ib2wgPSBpc1N5bWJvbDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzS2V5LmpzCnZhciByZXF1aXJlX2lzS2V5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0tleS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNTeW1ib2wgPSByZXF1aXJlX2lzU3ltYm9sKCk7CiAgICB2YXIgcmVnZXhJc0RlZXBQcm9wID0gL1wufFxbKD86W15bXF1dKnwoWyInXSkoPzooPyFcMSlbXlxcXXxcXC4pKj9cMSlcXS87CiAgICB2YXIgcmVnZXhJc1BsYWluUHJvcCA9IC9eXHcqJC87CiAgICBmdW5jdGlvbiBpc0tleSh2YWx1ZSwgb2JqZWN0KSB7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiB8fCB0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiB8fCB2YWx1ZSA9PSBudWxsIHx8IGlzU3ltYm9sLmlzU3ltYm9sKHZhbHVlKSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciICYmIChyZWdleElzUGxhaW5Qcm9wLnRlc3QodmFsdWUpIHx8ICFyZWdleElzRGVlcFByb3AudGVzdCh2YWx1ZSkpIHx8IG9iamVjdCAhPSBudWxsICYmIE9iamVjdC5oYXNPd24ob2JqZWN0LCB2YWx1ZSk7CiAgICB9CiAgICBleHBvcnRzLmlzS2V5ID0gaXNLZXk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L29yZGVyQnkuanMKdmFyIHJlcXVpcmVfb3JkZXJCeSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9vcmRlckJ5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBjb21wYXJlVmFsdWVzID0gcmVxdWlyZV9jb21wYXJlVmFsdWVzKCk7CiAgICB2YXIgaXNLZXkgPSByZXF1aXJlX2lzS2V5KCk7CiAgICB2YXIgdG9QYXRoID0gcmVxdWlyZV90b1BhdGgoKTsKICAgIGZ1bmN0aW9uIG9yZGVyQnkoY29sbGVjdGlvbiwgY3JpdGVyaWEsIG9yZGVycywgZ3VhcmQpIHsKICAgICAgaWYgKGNvbGxlY3Rpb24gPT0gbnVsbCkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgICBvcmRlcnMgPSBndWFyZCA/IHZvaWQgMCA6IG9yZGVyczsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgICAgY29sbGVjdGlvbiA9IE9iamVjdC52YWx1ZXMoY29sbGVjdGlvbik7CiAgICAgIH0KICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGNyaXRlcmlhKSkgewogICAgICAgIGNyaXRlcmlhID0gY3JpdGVyaWEgPT0gbnVsbCA/IFtudWxsXSA6IFtjcml0ZXJpYV07CiAgICAgIH0KICAgICAgaWYgKGNyaXRlcmlhLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGNyaXRlcmlhID0gW251bGxdOwogICAgICB9CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShvcmRlcnMpKSB7CiAgICAgICAgb3JkZXJzID0gb3JkZXJzID09IG51bGwgPyBbXSA6IFtvcmRlcnNdOwogICAgICB9CiAgICAgIG9yZGVycyA9IG9yZGVycy5tYXAoKG9yZGVyKSA9PiBTdHJpbmcob3JkZXIpKTsKICAgICAgY29uc3QgZ2V0VmFsdWVCeU5lc3RlZFBhdGggPSAob2JqZWN0LCBwYXRoMikgPT4gewogICAgICAgIGxldCB0YXJnZXQgPSBvYmplY3Q7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXRoMi5sZW5ndGggJiYgdGFyZ2V0ICE9IG51bGw7ICsraSkgewogICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0W3BhdGgyW2ldXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgfTsKICAgICAgY29uc3QgZ2V0VmFsdWVCeUNyaXRlcmlvbiA9IChjcml0ZXJpb24sIG9iamVjdCkgPT4gewogICAgICAgIGlmIChvYmplY3QgPT0gbnVsbCB8fCBjcml0ZXJpb24gPT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBjcml0ZXJpb24gPT09ICJvYmplY3QiICYmICJrZXkiIGluIGNyaXRlcmlvbikgewogICAgICAgICAgaWYgKE9iamVjdC5oYXNPd24ob2JqZWN0LCBjcml0ZXJpb24ua2V5KSkgewogICAgICAgICAgICByZXR1cm4gb2JqZWN0W2NyaXRlcmlvbi5rZXldOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldFZhbHVlQnlOZXN0ZWRQYXRoKG9iamVjdCwgY3JpdGVyaW9uLnBhdGgpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGNyaXRlcmlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgcmV0dXJuIGNyaXRlcmlvbihvYmplY3QpOwogICAgICAgIH0KICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjcml0ZXJpb24pKSB7CiAgICAgICAgICByZXR1cm4gZ2V0VmFsdWVCeU5lc3RlZFBhdGgob2JqZWN0LCBjcml0ZXJpb24pOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIG9iamVjdCA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgIHJldHVybiBvYmplY3RbY3JpdGVyaW9uXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgfTsKICAgICAgY29uc3QgcHJlcGFyZWRDcml0ZXJpYSA9IGNyaXRlcmlhLm1hcCgoY3JpdGVyaW9uKSA9PiB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY3JpdGVyaW9uKSAmJiBjcml0ZXJpb24ubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICBjcml0ZXJpb24gPSBjcml0ZXJpb25bMF07CiAgICAgICAgfQogICAgICAgIGlmIChjcml0ZXJpb24gPT0gbnVsbCB8fCB0eXBlb2YgY3JpdGVyaW9uID09PSAiZnVuY3Rpb24iIHx8IEFycmF5LmlzQXJyYXkoY3JpdGVyaW9uKSB8fCBpc0tleS5pc0tleShjcml0ZXJpb24pKSB7CiAgICAgICAgICByZXR1cm4gY3JpdGVyaW9uOwogICAgICAgIH0KICAgICAgICByZXR1cm4geyBrZXk6IGNyaXRlcmlvbiwgcGF0aDogdG9QYXRoLnRvUGF0aChjcml0ZXJpb24pIH07CiAgICAgIH0pOwogICAgICBjb25zdCBwcmVwYXJlZENvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLm1hcCgoaXRlbSkgPT4gKHsKICAgICAgICBvcmlnaW5hbDogaXRlbSwKICAgICAgICBjcml0ZXJpYTogcHJlcGFyZWRDcml0ZXJpYS5tYXAoKGNyaXRlcmlvbikgPT4gZ2V0VmFsdWVCeUNyaXRlcmlvbihjcml0ZXJpb24sIGl0ZW0pKQogICAgICB9KSk7CiAgICAgIHJldHVybiBwcmVwYXJlZENvbGxlY3Rpb24uc2xpY2UoKS5zb3J0KChhLCBiKSA9PiB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcmVwYXJlZENyaXRlcmlhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBjb21wYXJlZFJlc3VsdCA9IGNvbXBhcmVWYWx1ZXMuY29tcGFyZVZhbHVlcyhhLmNyaXRlcmlhW2ldLCBiLmNyaXRlcmlhW2ldLCBvcmRlcnNbaV0pOwogICAgICAgICAgaWYgKGNvbXBhcmVkUmVzdWx0ICE9PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBjb21wYXJlZFJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0pLm1hcCgoaXRlbSkgPT4gaXRlbS5vcmlnaW5hbCk7CiAgICB9CiAgICBleHBvcnRzLm9yZGVyQnkgPSBvcmRlckJ5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L2ZsYXR0ZW4uanMKdmFyIHJlcXVpcmVfZmxhdHRlbiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L2ZsYXR0ZW4uanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZmxhdHRlbihhcnIsIGRlcHRoID0gMSkgewogICAgICBjb25zdCByZXN1bHQgPSBbXTsKICAgICAgY29uc3QgZmxvb3JlZERlcHRoID0gTWF0aC5mbG9vcihkZXB0aCk7CiAgICAgIGNvbnN0IHJlY3Vyc2l2ZSA9IChhcnIyLCBjdXJyZW50RGVwdGgpID0+IHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFycjIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGNvbnN0IGl0ZW0gPSBhcnIyW2ldOwogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkgJiYgY3VycmVudERlcHRoIDwgZmxvb3JlZERlcHRoKSB7CiAgICAgICAgICAgIHJlY3Vyc2l2ZShpdGVtLCBjdXJyZW50RGVwdGggKyAxKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgICAgcmVjdXJzaXZlKGFyciwgMCk7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLmZsYXR0ZW4gPSBmbGF0dGVuOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNJdGVyYXRlZUNhbGwuanMKdmFyIHJlcXVpcmVfaXNJdGVyYXRlZUNhbGwgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzSXRlcmF0ZWVDYWxsLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc0luZGV4ID0gcmVxdWlyZV9pc0luZGV4KCk7CiAgICB2YXIgaXNBcnJheUxpa2UgPSByZXF1aXJlX2lzQXJyYXlMaWtlKCk7CiAgICB2YXIgaXNPYmplY3QgPSByZXF1aXJlX2lzT2JqZWN0KCk7CiAgICB2YXIgZXEgPSByZXF1aXJlX2VxKCk7CiAgICBmdW5jdGlvbiBpc0l0ZXJhdGVlQ2FsbCh2YWx1ZSwgaW5kZXgsIG9iamVjdCkgewogICAgICBpZiAoIWlzT2JqZWN0LmlzT2JqZWN0KG9iamVjdCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBpbmRleCA9PT0gIm51bWJlciIgJiYgaXNBcnJheUxpa2UuaXNBcnJheUxpa2Uob2JqZWN0KSAmJiBpc0luZGV4LmlzSW5kZXgoaW5kZXgpICYmIGluZGV4IDwgb2JqZWN0Lmxlbmd0aCB8fCB0eXBlb2YgaW5kZXggPT09ICJzdHJpbmciICYmIGluZGV4IGluIG9iamVjdCkgewogICAgICAgIHJldHVybiBlcS5lcShvYmplY3RbaW5kZXhdLCB2YWx1ZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgZXhwb3J0cy5pc0l0ZXJhdGVlQ2FsbCA9IGlzSXRlcmF0ZWVDYWxsOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9zb3J0QnkuanMKdmFyIHJlcXVpcmVfc29ydEJ5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L3NvcnRCeS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgb3JkZXJCeSA9IHJlcXVpcmVfb3JkZXJCeSgpOwogICAgdmFyIGZsYXR0ZW4gPSByZXF1aXJlX2ZsYXR0ZW4oKTsKICAgIHZhciBpc0l0ZXJhdGVlQ2FsbCA9IHJlcXVpcmVfaXNJdGVyYXRlZUNhbGwoKTsKICAgIGZ1bmN0aW9uIHNvcnRCeTUoY29sbGVjdGlvbiwgLi4uY3JpdGVyaWEpIHsKICAgICAgY29uc3QgbGVuZ3RoID0gY3JpdGVyaWEubGVuZ3RoOwogICAgICBpZiAobGVuZ3RoID4gMSAmJiBpc0l0ZXJhdGVlQ2FsbC5pc0l0ZXJhdGVlQ2FsbChjb2xsZWN0aW9uLCBjcml0ZXJpYVswXSwgY3JpdGVyaWFbMV0pKSB7CiAgICAgICAgY3JpdGVyaWEgPSBbXTsKICAgICAgfSBlbHNlIGlmIChsZW5ndGggPiAyICYmIGlzSXRlcmF0ZWVDYWxsLmlzSXRlcmF0ZWVDYWxsKGNyaXRlcmlhWzBdLCBjcml0ZXJpYVsxXSwgY3JpdGVyaWFbMl0pKSB7CiAgICAgICAgY3JpdGVyaWEgPSBbY3JpdGVyaWFbMF1dOwogICAgICB9CiAgICAgIHJldHVybiBvcmRlckJ5Lm9yZGVyQnkoY29sbGVjdGlvbiwgZmxhdHRlbi5mbGF0dGVuKGNyaXRlcmlhKSwgWyJhc2MiXSk7CiAgICB9CiAgICBleHBvcnRzLnNvcnRCeSA9IHNvcnRCeTU7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9zb3J0QnkuanMKdmFyIHJlcXVpcmVfc29ydEJ5MiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvc29ydEJ5LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9zb3J0QnkoKS5zb3J0Qnk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvZnVuY3Rpb24vZGVib3VuY2UuanMKdmFyIHJlcXVpcmVfZGVib3VuY2UgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9mdW5jdGlvbi9kZWJvdW5jZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCBkZWJvdW5jZU1zLCB7IHNpZ25hbCwgZWRnZXMgfSA9IHt9KSB7CiAgICAgIGxldCBwZW5kaW5nVGhpcyA9IHZvaWQgMDsKICAgICAgbGV0IHBlbmRpbmdBcmdzID0gbnVsbDsKICAgICAgY29uc3QgbGVhZGluZyA9IGVkZ2VzICE9IG51bGwgJiYgZWRnZXMuaW5jbHVkZXMoImxlYWRpbmciKTsKICAgICAgY29uc3QgdHJhaWxpbmcgPSBlZGdlcyA9PSBudWxsIHx8IGVkZ2VzLmluY2x1ZGVzKCJ0cmFpbGluZyIpOwogICAgICBjb25zdCBpbnZva2UgPSAoKSA9PiB7CiAgICAgICAgaWYgKHBlbmRpbmdBcmdzICE9PSBudWxsKSB7CiAgICAgICAgICBmdW5jLmFwcGx5KHBlbmRpbmdUaGlzLCBwZW5kaW5nQXJncyk7CiAgICAgICAgICBwZW5kaW5nVGhpcyA9IHZvaWQgMDsKICAgICAgICAgIHBlbmRpbmdBcmdzID0gbnVsbDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IG9uVGltZXJFbmQgPSAoKSA9PiB7CiAgICAgICAgaWYgKHRyYWlsaW5nKSB7CiAgICAgICAgICBpbnZva2UoKTsKICAgICAgICB9CiAgICAgICAgY2FuY2VsKCk7CiAgICAgIH07CiAgICAgIGxldCB0aW1lb3V0SWQgPSBudWxsOwogICAgICBjb25zdCBzY2hlZHVsZSA9ICgpID0+IHsKICAgICAgICBpZiAodGltZW91dElkICE9IG51bGwpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICAgIH0KICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHRpbWVvdXRJZCA9IG51bGw7CiAgICAgICAgICBvblRpbWVyRW5kKCk7CiAgICAgICAgfSwgZGVib3VuY2VNcyk7CiAgICAgIH07CiAgICAgIGNvbnN0IGNhbmNlbFRpbWVyID0gKCkgPT4gewogICAgICAgIGlmICh0aW1lb3V0SWQgIT09IG51bGwpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICAgICAgdGltZW91dElkID0gbnVsbDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGNvbnN0IGNhbmNlbCA9ICgpID0+IHsKICAgICAgICBjYW5jZWxUaW1lcigpOwogICAgICAgIHBlbmRpbmdUaGlzID0gdm9pZCAwOwogICAgICAgIHBlbmRpbmdBcmdzID0gbnVsbDsKICAgICAgfTsKICAgICAgY29uc3QgZmx1c2ggPSAoKSA9PiB7CiAgICAgICAgaW52b2tlKCk7CiAgICAgIH07CiAgICAgIGNvbnN0IGRlYm91bmNlZCA9IGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgICBpZiAoc2lnbmFsPy5hYm9ydGVkKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHBlbmRpbmdUaGlzID0gdGhpczsKICAgICAgICBwZW5kaW5nQXJncyA9IGFyZ3M7CiAgICAgICAgY29uc3QgaXNGaXJzdENhbGwgPSB0aW1lb3V0SWQgPT0gbnVsbDsKICAgICAgICBzY2hlZHVsZSgpOwogICAgICAgIGlmIChsZWFkaW5nICYmIGlzRmlyc3RDYWxsKSB7CiAgICAgICAgICBpbnZva2UoKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGRlYm91bmNlZC5zY2hlZHVsZSA9IHNjaGVkdWxlOwogICAgICBkZWJvdW5jZWQuY2FuY2VsID0gY2FuY2VsOwogICAgICBkZWJvdW5jZWQuZmx1c2ggPSBmbHVzaDsKICAgICAgc2lnbmFsPy5hZGRFdmVudExpc3RlbmVyKCJhYm9ydCIsIGNhbmNlbCwgeyBvbmNlOiB0cnVlIH0pOwogICAgICByZXR1cm4gZGVib3VuY2VkOwogICAgfQogICAgZXhwb3J0cy5kZWJvdW5jZSA9IGRlYm91bmNlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9mdW5jdGlvbi9kZWJvdW5jZS5qcwp2YXIgcmVxdWlyZV9kZWJvdW5jZTIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvZnVuY3Rpb24vZGVib3VuY2UuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGRlYm91bmNlJDEgPSByZXF1aXJlX2RlYm91bmNlKCk7CiAgICBmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCBkZWJvdW5jZU1zID0gMCwgb3B0aW9ucyA9IHt9KSB7CiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gIm9iamVjdCIpIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KICAgICAgY29uc3QgeyBsZWFkaW5nID0gZmFsc2UsIHRyYWlsaW5nID0gdHJ1ZSwgbWF4V2FpdCB9ID0gb3B0aW9uczsKICAgICAgY29uc3QgZWRnZXMgPSBBcnJheSgyKTsKICAgICAgaWYgKGxlYWRpbmcpIHsKICAgICAgICBlZGdlc1swXSA9ICJsZWFkaW5nIjsKICAgICAgfQogICAgICBpZiAodHJhaWxpbmcpIHsKICAgICAgICBlZGdlc1sxXSA9ICJ0cmFpbGluZyI7CiAgICAgIH0KICAgICAgbGV0IHJlc3VsdCA9IHZvaWQgMDsKICAgICAgbGV0IHBlbmRpbmdBdCA9IG51bGw7CiAgICAgIGNvbnN0IF9kZWJvdW5jZWQgPSBkZWJvdW5jZSQxLmRlYm91bmNlKGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIHBlbmRpbmdBdCA9IG51bGw7CiAgICAgIH0sIGRlYm91bmNlTXMsIHsgZWRnZXMgfSk7CiAgICAgIGNvbnN0IGRlYm91bmNlZCA9IGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgICBpZiAobWF4V2FpdCAhPSBudWxsKSB7CiAgICAgICAgICBpZiAocGVuZGluZ0F0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHBlbmRpbmdBdCA9IERhdGUubm93KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIHBlbmRpbmdBdCA+PSBtYXhXYWl0KSB7CiAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIHBlbmRpbmdBdCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIF9kZWJvdW5jZWQuY2FuY2VsKCk7CiAgICAgICAgICAgIF9kZWJvdW5jZWQuc2NoZWR1bGUoKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgX2RlYm91bmNlZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBjb25zdCBmbHVzaCA9ICgpID0+IHsKICAgICAgICBfZGVib3VuY2VkLmZsdXNoKCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgZGVib3VuY2VkLmNhbmNlbCA9IF9kZWJvdW5jZWQuY2FuY2VsOwogICAgICBkZWJvdW5jZWQuZmx1c2ggPSBmbHVzaDsKICAgICAgcmV0dXJuIGRlYm91bmNlZDsKICAgIH0KICAgIGV4cG9ydHMuZGVib3VuY2UgPSBkZWJvdW5jZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvZnVuY3Rpb24vdGhyb3R0bGUuanMKdmFyIHJlcXVpcmVfdGhyb3R0bGUgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvZnVuY3Rpb24vdGhyb3R0bGUuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGRlYm91bmNlID0gcmVxdWlyZV9kZWJvdW5jZTIoKTsKICAgIGZ1bmN0aW9uIHRocm90dGxlMihmdW5jLCB0aHJvdHRsZU1zID0gMCwgb3B0aW9ucyA9IHt9KSB7CiAgICAgIGNvbnN0IHsgbGVhZGluZyA9IHRydWUsIHRyYWlsaW5nID0gdHJ1ZSB9ID0gb3B0aW9uczsKICAgICAgcmV0dXJuIGRlYm91bmNlLmRlYm91bmNlKGZ1bmMsIHRocm90dGxlTXMsIHsKICAgICAgICBsZWFkaW5nLAogICAgICAgIG1heFdhaXQ6IHRocm90dGxlTXMsCiAgICAgICAgdHJhaWxpbmcKICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLnRocm90dGxlID0gdGhyb3R0bGUyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvdGhyb3R0bGUuanMKdmFyIHJlcXVpcmVfdGhyb3R0bGUyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC90aHJvdHRsZS5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfdGhyb3R0bGUoKS50aHJvdHRsZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b051bWJlci5qcwp2YXIgcmVxdWlyZV90b051bWJlciA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvTnVtYmVyLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc1N5bWJvbCA9IHJlcXVpcmVfaXNTeW1ib2woKTsKICAgIGZ1bmN0aW9uIHRvTnVtYmVyKHZhbHVlKSB7CiAgICAgIGlmIChpc1N5bWJvbC5pc1N5bWJvbCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gTmFOOwogICAgICB9CiAgICAgIHJldHVybiBOdW1iZXIodmFsdWUpOwogICAgfQogICAgZXhwb3J0cy50b051bWJlciA9IHRvTnVtYmVyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvRmluaXRlLmpzCnZhciByZXF1aXJlX3RvRmluaXRlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3V0aWwvdG9GaW5pdGUuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIHRvTnVtYmVyID0gcmVxdWlyZV90b051bWJlcigpOwogICAgZnVuY3Rpb24gdG9GaW5pdGUodmFsdWUpIHsKICAgICAgaWYgKCF2YWx1ZSkgewogICAgICAgIHJldHVybiB2YWx1ZSA9PT0gMCA/IHZhbHVlIDogMDsKICAgICAgfQogICAgICB2YWx1ZSA9IHRvTnVtYmVyLnRvTnVtYmVyKHZhbHVlKTsKICAgICAgaWYgKHZhbHVlID09PSBJbmZpbml0eSB8fCB2YWx1ZSA9PT0gLUluZmluaXR5KSB7CiAgICAgICAgY29uc3Qgc2lnbjIgPSB2YWx1ZSA8IDAgPyAtMSA6IDE7CiAgICAgICAgcmV0dXJuIHNpZ24yICogTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWUgPT09IHZhbHVlID8gdmFsdWUgOiAwOwogICAgfQogICAgZXhwb3J0cy50b0Zpbml0ZSA9IHRvRmluaXRlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9tYXRoL3JhbmdlLmpzCnZhciByZXF1aXJlX3JhbmdlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L21hdGgvcmFuZ2UuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzSXRlcmF0ZWVDYWxsID0gcmVxdWlyZV9pc0l0ZXJhdGVlQ2FsbCgpOwogICAgdmFyIHRvRmluaXRlID0gcmVxdWlyZV90b0Zpbml0ZSgpOwogICAgZnVuY3Rpb24gcmFuZ2U0KHN0YXJ0LCBlbmQsIHN0ZXApIHsKICAgICAgaWYgKHN0ZXAgJiYgdHlwZW9mIHN0ZXAgIT09ICJudW1iZXIiICYmIGlzSXRlcmF0ZWVDYWxsLmlzSXRlcmF0ZWVDYWxsKHN0YXJ0LCBlbmQsIHN0ZXApKSB7CiAgICAgICAgZW5kID0gc3RlcCA9IHZvaWQgMDsKICAgICAgfQogICAgICBzdGFydCA9IHRvRmluaXRlLnRvRmluaXRlKHN0YXJ0KTsKICAgICAgaWYgKGVuZCA9PT0gdm9pZCAwKSB7CiAgICAgICAgZW5kID0gc3RhcnQ7CiAgICAgICAgc3RhcnQgPSAwOwogICAgICB9IGVsc2UgewogICAgICAgIGVuZCA9IHRvRmluaXRlLnRvRmluaXRlKGVuZCk7CiAgICAgIH0KICAgICAgc3RlcCA9IHN0ZXAgPT09IHZvaWQgMCA/IHN0YXJ0IDwgZW5kID8gMSA6IC0xIDogdG9GaW5pdGUudG9GaW5pdGUoc3RlcCk7CiAgICAgIGNvbnN0IGxlbmd0aCA9IE1hdGgubWF4KE1hdGguY2VpbCgoZW5kIC0gc3RhcnQpIC8gKHN0ZXAgfHwgMSkpLCAwKTsKICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IEFycmF5KGxlbmd0aCk7CiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICByZXN1bHRbaW5kZXhdID0gc3RhcnQ7CiAgICAgICAgc3RhcnQgKz0gc3RlcDsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZXhwb3J0cy5yYW5nZSA9IHJhbmdlNDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3JhbmdlLmpzCnZhciByZXF1aXJlX3JhbmdlMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvcmFuZ2UuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JhbmdlKCkucmFuZ2U7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9kZWNpbWFsLmpzLWxpZ2h0L2RlY2ltYWwuanMKdmFyIHJlcXVpcmVfZGVjaW1hbCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZGVjaW1hbC5qcy1saWdodC9kZWNpbWFsLmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIChmdW5jdGlvbihnbG9iYWxTY29wZSkgewogICAgICAidXNlIHN0cmljdCI7CiAgICAgIHZhciBNQVhfRElHSVRTID0gMWU5LCBEZWNpbWFsMyA9IHsKICAgICAgICAvLyBUaGVzZSB2YWx1ZXMgbXVzdCBiZSBpbnRlZ2VycyB3aXRoaW4gdGhlIHN0YXRlZCByYW5nZXMgKGluY2x1c2l2ZSkuCiAgICAgICAgLy8gTW9zdCBvZiB0aGVzZSB2YWx1ZXMgY2FuIGJlIGNoYW5nZWQgZHVyaW5nIHJ1bi10aW1lIHVzaW5nIGBEZWNpbWFsLmNvbmZpZ2AuCiAgICAgICAgLy8gVGhlIG1heGltdW0gbnVtYmVyIG9mIHNpZ25pZmljYW50IGRpZ2l0cyBvZiB0aGUgcmVzdWx0IG9mIGEgY2FsY3VsYXRpb24gb3IgYmFzZSBjb252ZXJzaW9uLgogICAgICAgIC8vIEUuZy4gYERlY2ltYWwuY29uZmlnKHsgcHJlY2lzaW9uOiAyMCB9KTtgCiAgICAgICAgcHJlY2lzaW9uOiAyMCwKICAgICAgICAvLyAxIHRvIE1BWF9ESUdJVFMKICAgICAgICAvLyBUaGUgcm91bmRpbmcgbW9kZSB1c2VkIGJ5IGRlZmF1bHQgYnkgYHRvSW50ZWdlcmAsIGB0b0RlY2ltYWxQbGFjZXNgLCBgdG9FeHBvbmVudGlhbGAsCiAgICAgICAgLy8gYHRvRml4ZWRgLCBgdG9QcmVjaXNpb25gIGFuZCBgdG9TaWduaWZpY2FudERpZ2l0c2AuCiAgICAgICAgLy8KICAgICAgICAvLyBST1VORF9VUCAgICAgICAgIDAgQXdheSBmcm9tIHplcm8uCiAgICAgICAgLy8gUk9VTkRfRE9XTiAgICAgICAxIFRvd2FyZHMgemVyby4KICAgICAgICAvLyBST1VORF9DRUlMICAgICAgIDIgVG93YXJkcyArSW5maW5pdHkuCiAgICAgICAgLy8gUk9VTkRfRkxPT1IgICAgICAzIFRvd2FyZHMgLUluZmluaXR5LgogICAgICAgIC8vIFJPVU5EX0hBTEZfVVAgICAgNCBUb3dhcmRzIG5lYXJlc3QgbmVpZ2hib3VyLiBJZiBlcXVpZGlzdGFudCwgdXAuCiAgICAgICAgLy8gUk9VTkRfSEFMRl9ET1dOICA1IFRvd2FyZHMgbmVhcmVzdCBuZWlnaGJvdXIuIElmIGVxdWlkaXN0YW50LCBkb3duLgogICAgICAgIC8vIFJPVU5EX0hBTEZfRVZFTiAgNiBUb3dhcmRzIG5lYXJlc3QgbmVpZ2hib3VyLiBJZiBlcXVpZGlzdGFudCwgdG93YXJkcyBldmVuIG5laWdoYm91ci4KICAgICAgICAvLyBST1VORF9IQUxGX0NFSUwgIDcgVG93YXJkcyBuZWFyZXN0IG5laWdoYm91ci4gSWYgZXF1aWRpc3RhbnQsIHRvd2FyZHMgK0luZmluaXR5LgogICAgICAgIC8vIFJPVU5EX0hBTEZfRkxPT1IgOCBUb3dhcmRzIG5lYXJlc3QgbmVpZ2hib3VyLiBJZiBlcXVpZGlzdGFudCwgdG93YXJkcyAtSW5maW5pdHkuCiAgICAgICAgLy8KICAgICAgICAvLyBFLmcuCiAgICAgICAgLy8gYERlY2ltYWwucm91bmRpbmcgPSA0O2AKICAgICAgICAvLyBgRGVjaW1hbC5yb3VuZGluZyA9IERlY2ltYWwuUk9VTkRfSEFMRl9VUDtgCiAgICAgICAgcm91bmRpbmc6IDQsCiAgICAgICAgLy8gMCB0byA4CiAgICAgICAgLy8gVGhlIGV4cG9uZW50IHZhbHVlIGF0IGFuZCBiZW5lYXRoIHdoaWNoIGB0b1N0cmluZ2AgcmV0dXJucyBleHBvbmVudGlhbCBub3RhdGlvbi4KICAgICAgICAvLyBKYXZhU2NyaXB0IG51bWJlcnM6IC03CiAgICAgICAgdG9FeHBOZWc6IC03LAogICAgICAgIC8vIDAgdG8gLU1BWF9FCiAgICAgICAgLy8gVGhlIGV4cG9uZW50IHZhbHVlIGF0IGFuZCBhYm92ZSB3aGljaCBgdG9TdHJpbmdgIHJldHVybnMgZXhwb25lbnRpYWwgbm90YXRpb24uCiAgICAgICAgLy8gSmF2YVNjcmlwdCBudW1iZXJzOiAyMQogICAgICAgIHRvRXhwUG9zOiAyMSwKICAgICAgICAvLyAwIHRvIE1BWF9FCiAgICAgICAgLy8gVGhlIG5hdHVyYWwgbG9nYXJpdGhtIG9mIDEwLgogICAgICAgIC8vIDExNSBkaWdpdHMKICAgICAgICBMTjEwOiAiMi4zMDI1ODUwOTI5OTQwNDU2ODQwMTc5OTE0NTQ2ODQzNjQyMDc2MDExMDE0ODg2Mjg3NzI5NzYwMzMzMjc5MDA5Njc1NzI2MDk2NzczNTI0ODAyMzU5OTcyMDUwODk1OTgyOTgzNDE5Njc3ODQwNDIyODYiCiAgICAgIH0sIGV4dGVybmFsID0gdHJ1ZSwgZGVjaW1hbEVycm9yID0gIltEZWNpbWFsRXJyb3JdICIsIGludmFsaWRBcmd1bWVudCA9IGRlY2ltYWxFcnJvciArICJJbnZhbGlkIGFyZ3VtZW50OiAiLCBleHBvbmVudE91dE9mUmFuZ2UgPSBkZWNpbWFsRXJyb3IgKyAiRXhwb25lbnQgb3V0IG9mIHJhbmdlOiAiLCBtYXRoZmxvb3IgPSBNYXRoLmZsb29yLCBtYXRocG93ID0gTWF0aC5wb3csIGlzRGVjaW1hbCA9IC9eKFxkKyhcLlxkKik/fFwuXGQrKShlWystXT9cZCspPyQvaSwgT05FLCBCQVNFID0gMWU3LCBMT0dfQkFTRSA9IDcsIE1BWF9TQUZFX0lOVEVHRVIgPSA5MDA3MTk5MjU0NzQwOTkxLCBNQVhfRSA9IG1hdGhmbG9vcihNQVhfU0FGRV9JTlRFR0VSIC8gTE9HX0JBU0UpLCBQID0ge307CiAgICAgIFAuYWJzb2x1dGVWYWx1ZSA9IFAuYWJzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcyk7CiAgICAgICAgaWYgKHgyLnMpIHgyLnMgPSAxOwogICAgICAgIHJldHVybiB4MjsKICAgICAgfTsKICAgICAgUC5jb21wYXJlZFRvID0gUC5jbXAgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBpLCBqLCB4ZEwsIHlkTCwgeDIgPSB0aGlzOwogICAgICAgIHkyID0gbmV3IHgyLmNvbnN0cnVjdG9yKHkyKTsKICAgICAgICBpZiAoeDIucyAhPT0geTIucykgcmV0dXJuIHgyLnMgfHwgLXkyLnM7CiAgICAgICAgaWYgKHgyLmUgIT09IHkyLmUpIHJldHVybiB4Mi5lID4geTIuZSBeIHgyLnMgPCAwID8gMSA6IC0xOwogICAgICAgIHhkTCA9IHgyLmQubGVuZ3RoOwogICAgICAgIHlkTCA9IHkyLmQubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IDAsIGogPSB4ZEwgPCB5ZEwgPyB4ZEwgOiB5ZEw7IGkgPCBqOyArK2kpIHsKICAgICAgICAgIGlmICh4Mi5kW2ldICE9PSB5Mi5kW2ldKSByZXR1cm4geDIuZFtpXSA+IHkyLmRbaV0gXiB4Mi5zIDwgMCA/IDEgOiAtMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHhkTCA9PT0geWRMID8gMCA6IHhkTCA+IHlkTCBeIHgyLnMgPCAwID8gMSA6IC0xOwogICAgICB9OwogICAgICBQLmRlY2ltYWxQbGFjZXMgPSBQLmRwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgdyA9IHgyLmQubGVuZ3RoIC0gMSwgZHAgPSAodyAtIHgyLmUpICogTE9HX0JBU0U7CiAgICAgICAgdyA9IHgyLmRbd107CiAgICAgICAgaWYgKHcpIGZvciAoOyB3ICUgMTAgPT0gMDsgdyAvPSAxMCkgZHAtLTsKICAgICAgICByZXR1cm4gZHAgPCAwID8gMCA6IGRwOwogICAgICB9OwogICAgICBQLmRpdmlkZWRCeSA9IFAuZGl2ID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICByZXR1cm4gZGl2aWRlKHRoaXMsIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHkyKSk7CiAgICAgIH07CiAgICAgIFAuZGl2aWRlZFRvSW50ZWdlckJ5ID0gUC5pZGl2ID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICB2YXIgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3I7CiAgICAgICAgcmV0dXJuIHJvdW5kKGRpdmlkZSh4MiwgbmV3IEN0b3IoeTIpLCAwLCAxKSwgQ3Rvci5wcmVjaXNpb24pOwogICAgICB9OwogICAgICBQLmVxdWFscyA9IFAuZXEgPSBmdW5jdGlvbih5MikgewogICAgICAgIHJldHVybiAhdGhpcy5jbXAoeTIpOwogICAgICB9OwogICAgICBQLmV4cG9uZW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGdldEJhc2UxMEV4cG9uZW50KHRoaXMpOwogICAgICB9OwogICAgICBQLmdyZWF0ZXJUaGFuID0gUC5ndCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY21wKHkyKSA+IDA7CiAgICAgIH07CiAgICAgIFAuZ3JlYXRlclRoYW5PckVxdWFsVG8gPSBQLmd0ZSA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY21wKHkyKSA+PSAwOwogICAgICB9OwogICAgICBQLmlzSW50ZWdlciA9IFAuaXNpbnQgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5lID4gdGhpcy5kLmxlbmd0aCAtIDI7CiAgICAgIH07CiAgICAgIFAuaXNOZWdhdGl2ZSA9IFAuaXNuZWcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zIDwgMDsKICAgICAgfTsKICAgICAgUC5pc1Bvc2l0aXZlID0gUC5pc3BvcyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnMgPiAwOwogICAgICB9OwogICAgICBQLmlzWmVybyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnMgPT09IDA7CiAgICAgIH07CiAgICAgIFAubGVzc1RoYW4gPSBQLmx0ID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICByZXR1cm4gdGhpcy5jbXAoeTIpIDwgMDsKICAgICAgfTsKICAgICAgUC5sZXNzVGhhbk9yRXF1YWxUbyA9IFAubHRlID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICByZXR1cm4gdGhpcy5jbXAoeTIpIDwgMTsKICAgICAgfTsKICAgICAgUC5sb2dhcml0aG0gPSBQLmxvZyA9IGZ1bmN0aW9uKGJhc2UpIHsKICAgICAgICB2YXIgcjIsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBwciA9IEN0b3IucHJlY2lzaW9uLCB3cHIgPSBwciArIDU7CiAgICAgICAgaWYgKGJhc2UgPT09IHZvaWQgMCkgewogICAgICAgICAgYmFzZSA9IG5ldyBDdG9yKDEwKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYmFzZSA9IG5ldyBDdG9yKGJhc2UpOwogICAgICAgICAgaWYgKGJhc2UucyA8IDEgfHwgYmFzZS5lcShPTkUpKSB0aHJvdyBFcnJvcihkZWNpbWFsRXJyb3IgKyAiTmFOIik7CiAgICAgICAgfQogICAgICAgIGlmICh4Mi5zIDwgMSkgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgKHgyLnMgPyAiTmFOIiA6ICItSW5maW5pdHkiKSk7CiAgICAgICAgaWYgKHgyLmVxKE9ORSkpIHJldHVybiBuZXcgQ3RvcigwKTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHIyID0gZGl2aWRlKGxuKHgyLCB3cHIpLCBsbihiYXNlLCB3cHIpLCB3cHIpOwogICAgICAgIGV4dGVybmFsID0gdHJ1ZTsKICAgICAgICByZXR1cm4gcm91bmQocjIsIHByKTsKICAgICAgfTsKICAgICAgUC5taW51cyA9IFAuc3ViID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICB2YXIgeDIgPSB0aGlzOwogICAgICAgIHkyID0gbmV3IHgyLmNvbnN0cnVjdG9yKHkyKTsKICAgICAgICByZXR1cm4geDIucyA9PSB5Mi5zID8gc3VidHJhY3QoeDIsIHkyKSA6IGFkZCh4MiwgKHkyLnMgPSAteTIucywgeTIpKTsKICAgICAgfTsKICAgICAgUC5tb2R1bG8gPSBQLm1vZCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIHEsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBwciA9IEN0b3IucHJlY2lzaW9uOwogICAgICAgIHkyID0gbmV3IEN0b3IoeTIpOwogICAgICAgIGlmICgheTIucykgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk5hTiIpOwogICAgICAgIGlmICgheDIucykgcmV0dXJuIHJvdW5kKG5ldyBDdG9yKHgyKSwgcHIpOwogICAgICAgIGV4dGVybmFsID0gZmFsc2U7CiAgICAgICAgcSA9IGRpdmlkZSh4MiwgeTIsIDAsIDEpLnRpbWVzKHkyKTsKICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgcmV0dXJuIHgyLm1pbnVzKHEpOwogICAgICB9OwogICAgICBQLm5hdHVyYWxFeHBvbmVudGlhbCA9IFAuZXhwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIGV4cCh0aGlzKTsKICAgICAgfTsKICAgICAgUC5uYXR1cmFsTG9nYXJpdGhtID0gUC5sbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBsbih0aGlzKTsKICAgICAgfTsKICAgICAgUC5uZWdhdGVkID0gUC5uZWcgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgeDIgPSBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzKTsKICAgICAgICB4Mi5zID0gLXgyLnMgfHwgMDsKICAgICAgICByZXR1cm4geDI7CiAgICAgIH07CiAgICAgIFAucGx1cyA9IFAuYWRkID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICB2YXIgeDIgPSB0aGlzOwogICAgICAgIHkyID0gbmV3IHgyLmNvbnN0cnVjdG9yKHkyKTsKICAgICAgICByZXR1cm4geDIucyA9PSB5Mi5zID8gYWRkKHgyLCB5MikgOiBzdWJ0cmFjdCh4MiwgKHkyLnMgPSAteTIucywgeTIpKTsKICAgICAgfTsKICAgICAgUC5wcmVjaXNpb24gPSBQLnNkID0gZnVuY3Rpb24oeikgewogICAgICAgIHZhciBlLCBzZCwgdywgeDIgPSB0aGlzOwogICAgICAgIGlmICh6ICE9PSB2b2lkIDAgJiYgeiAhPT0gISF6ICYmIHogIT09IDEgJiYgeiAhPT0gMCkgdGhyb3cgRXJyb3IoaW52YWxpZEFyZ3VtZW50ICsgeik7CiAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKSArIDE7CiAgICAgICAgdyA9IHgyLmQubGVuZ3RoIC0gMTsKICAgICAgICBzZCA9IHcgKiBMT0dfQkFTRSArIDE7CiAgICAgICAgdyA9IHgyLmRbd107CiAgICAgICAgaWYgKHcpIHsKICAgICAgICAgIGZvciAoOyB3ICUgMTAgPT0gMDsgdyAvPSAxMCkgc2QtLTsKICAgICAgICAgIGZvciAodyA9IHgyLmRbMF07IHcgPj0gMTA7IHcgLz0gMTApIHNkKys7CiAgICAgICAgfQogICAgICAgIHJldHVybiB6ICYmIGUgPiBzZCA/IGUgOiBzZDsKICAgICAgfTsKICAgICAgUC5zcXVhcmVSb290ID0gUC5zcXJ0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGUsIG4sIHByLCByMiwgcywgdCwgd3ByLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoeDIucyA8IDEpIHsKICAgICAgICAgIGlmICgheDIucykgcmV0dXJuIG5ldyBDdG9yKDApOwogICAgICAgICAgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk5hTiIpOwogICAgICAgIH0KICAgICAgICBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpOwogICAgICAgIGV4dGVybmFsID0gZmFsc2U7CiAgICAgICAgcyA9IE1hdGguc3FydCgreDIpOwogICAgICAgIGlmIChzID09IDAgfHwgcyA9PSAxIC8gMCkgewogICAgICAgICAgbiA9IGRpZ2l0c1RvU3RyaW5nKHgyLmQpOwogICAgICAgICAgaWYgKChuLmxlbmd0aCArIGUpICUgMiA9PSAwKSBuICs9ICIwIjsKICAgICAgICAgIHMgPSBNYXRoLnNxcnQobik7CiAgICAgICAgICBlID0gbWF0aGZsb29yKChlICsgMSkgLyAyKSAtIChlIDwgMCB8fCBlICUgMik7CiAgICAgICAgICBpZiAocyA9PSAxIC8gMCkgewogICAgICAgICAgICBuID0gIjVlIiArIGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBuID0gcy50b0V4cG9uZW50aWFsKCk7CiAgICAgICAgICAgIG4gPSBuLnNsaWNlKDAsIG4uaW5kZXhPZigiZSIpICsgMSkgKyBlOwogICAgICAgICAgfQogICAgICAgICAgcjIgPSBuZXcgQ3RvcihuKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcjIgPSBuZXcgQ3RvcihzLnRvU3RyaW5nKCkpOwogICAgICAgIH0KICAgICAgICBwciA9IEN0b3IucHJlY2lzaW9uOwogICAgICAgIHMgPSB3cHIgPSBwciArIDM7CiAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICB0ID0gcjI7CiAgICAgICAgICByMiA9IHQucGx1cyhkaXZpZGUoeDIsIHQsIHdwciArIDIpKS50aW1lcygwLjUpOwogICAgICAgICAgaWYgKGRpZ2l0c1RvU3RyaW5nKHQuZCkuc2xpY2UoMCwgd3ByKSA9PT0gKG4gPSBkaWdpdHNUb1N0cmluZyhyMi5kKSkuc2xpY2UoMCwgd3ByKSkgewogICAgICAgICAgICBuID0gbi5zbGljZSh3cHIgLSAzLCB3cHIgKyAxKTsKICAgICAgICAgICAgaWYgKHMgPT0gd3ByICYmIG4gPT0gIjQ5OTkiKSB7CiAgICAgICAgICAgICAgcm91bmQodCwgcHIgKyAxLCAwKTsKICAgICAgICAgICAgICBpZiAodC50aW1lcyh0KS5lcSh4MikpIHsKICAgICAgICAgICAgICAgIHIyID0gdDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChuICE9ICI5OTk5IikgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdwciArPSA0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgcmV0dXJuIHJvdW5kKHIyLCBwcik7CiAgICAgIH07CiAgICAgIFAudGltZXMgPSBQLm11bCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIGNhcnJ5LCBlLCBpLCBrLCByMiwgckwsIHQsIHhkTCwgeWRMLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgeGQgPSB4Mi5kLCB5ZCA9ICh5MiA9IG5ldyBDdG9yKHkyKSkuZDsKICAgICAgICBpZiAoIXgyLnMgfHwgIXkyLnMpIHJldHVybiBuZXcgQ3RvcigwKTsKICAgICAgICB5Mi5zICo9IHgyLnM7CiAgICAgICAgZSA9IHgyLmUgKyB5Mi5lOwogICAgICAgIHhkTCA9IHhkLmxlbmd0aDsKICAgICAgICB5ZEwgPSB5ZC5sZW5ndGg7CiAgICAgICAgaWYgKHhkTCA8IHlkTCkgewogICAgICAgICAgcjIgPSB4ZDsKICAgICAgICAgIHhkID0geWQ7CiAgICAgICAgICB5ZCA9IHIyOwogICAgICAgICAgckwgPSB4ZEw7CiAgICAgICAgICB4ZEwgPSB5ZEw7CiAgICAgICAgICB5ZEwgPSByTDsKICAgICAgICB9CiAgICAgICAgcjIgPSBbXTsKICAgICAgICByTCA9IHhkTCArIHlkTDsKICAgICAgICBmb3IgKGkgPSByTDsgaS0tOyApIHIyLnB1c2goMCk7CiAgICAgICAgZm9yIChpID0geWRMOyAtLWkgPj0gMDsgKSB7CiAgICAgICAgICBjYXJyeSA9IDA7CiAgICAgICAgICBmb3IgKGsgPSB4ZEwgKyBpOyBrID4gaTsgKSB7CiAgICAgICAgICAgIHQgPSByMltrXSArIHlkW2ldICogeGRbayAtIGkgLSAxXSArIGNhcnJ5OwogICAgICAgICAgICByMltrLS1dID0gdCAlIEJBU0UgfCAwOwogICAgICAgICAgICBjYXJyeSA9IHQgLyBCQVNFIHwgMDsKICAgICAgICAgIH0KICAgICAgICAgIHIyW2tdID0gKHIyW2tdICsgY2FycnkpICUgQkFTRSB8IDA7CiAgICAgICAgfQogICAgICAgIGZvciAoOyAhcjJbLS1yTF07ICkgcjIucG9wKCk7CiAgICAgICAgaWYgKGNhcnJ5KSArK2U7CiAgICAgICAgZWxzZSByMi5zaGlmdCgpOwogICAgICAgIHkyLmQgPSByMjsKICAgICAgICB5Mi5lID0gZTsKICAgICAgICByZXR1cm4gZXh0ZXJuYWwgPyByb3VuZCh5MiwgQ3Rvci5wcmVjaXNpb24pIDogeTI7CiAgICAgIH07CiAgICAgIFAudG9EZWNpbWFsUGxhY2VzID0gUC50b2RwID0gZnVuY3Rpb24oZHAsIHJtKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIHgyID0gbmV3IEN0b3IoeDIpOwogICAgICAgIGlmIChkcCA9PT0gdm9pZCAwKSByZXR1cm4geDI7CiAgICAgICAgY2hlY2tJbnQzMihkcCwgMCwgTUFYX0RJR0lUUyk7CiAgICAgICAgaWYgKHJtID09PSB2b2lkIDApIHJtID0gQ3Rvci5yb3VuZGluZzsKICAgICAgICBlbHNlIGNoZWNrSW50MzIocm0sIDAsIDgpOwogICAgICAgIHJldHVybiByb3VuZCh4MiwgZHAgKyBnZXRCYXNlMTBFeHBvbmVudCh4MikgKyAxLCBybSk7CiAgICAgIH07CiAgICAgIFAudG9FeHBvbmVudGlhbCA9IGZ1bmN0aW9uKGRwLCBybSkgewogICAgICAgIHZhciBzdHIsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIGlmIChkcCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICBzdHIgPSB0b1N0cmluZyh4MiwgdHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNoZWNrSW50MzIoZHAsIDAsIE1BWF9ESUdJVFMpOwogICAgICAgICAgaWYgKHJtID09PSB2b2lkIDApIHJtID0gQ3Rvci5yb3VuZGluZzsKICAgICAgICAgIGVsc2UgY2hlY2tJbnQzMihybSwgMCwgOCk7CiAgICAgICAgICB4MiA9IHJvdW5kKG5ldyBDdG9yKHgyKSwgZHAgKyAxLCBybSk7CiAgICAgICAgICBzdHIgPSB0b1N0cmluZyh4MiwgdHJ1ZSwgZHAgKyAxKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgfTsKICAgICAgUC50b0ZpeGVkID0gZnVuY3Rpb24oZHAsIHJtKSB7CiAgICAgICAgdmFyIHN0ciwgeTIsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIGlmIChkcCA9PT0gdm9pZCAwKSByZXR1cm4gdG9TdHJpbmcoeDIpOwogICAgICAgIGNoZWNrSW50MzIoZHAsIDAsIE1BWF9ESUdJVFMpOwogICAgICAgIGlmIChybSA9PT0gdm9pZCAwKSBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgZWxzZSBjaGVja0ludDMyKHJtLCAwLCA4KTsKICAgICAgICB5MiA9IHJvdW5kKG5ldyBDdG9yKHgyKSwgZHAgKyBnZXRCYXNlMTBFeHBvbmVudCh4MikgKyAxLCBybSk7CiAgICAgICAgc3RyID0gdG9TdHJpbmcoeTIuYWJzKCksIGZhbHNlLCBkcCArIGdldEJhc2UxMEV4cG9uZW50KHkyKSArIDEpOwogICAgICAgIHJldHVybiB4Mi5pc25lZygpICYmICF4Mi5pc1plcm8oKSA/ICItIiArIHN0ciA6IHN0cjsKICAgICAgfTsKICAgICAgUC50b0ludGVnZXIgPSBQLnRvaW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIHJldHVybiByb3VuZChuZXcgQ3Rvcih4MiksIGdldEJhc2UxMEV4cG9uZW50KHgyKSArIDEsIEN0b3Iucm91bmRpbmcpOwogICAgICB9OwogICAgICBQLnRvTnVtYmVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICt0aGlzOwogICAgICB9OwogICAgICBQLnRvUG93ZXIgPSBQLnBvdyA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIGUsIGssIHByLCByMiwgc2lnbjIsIHlJc0ludCwgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3IsIGd1YXJkID0gMTIsIHluID0gKyh5MiA9IG5ldyBDdG9yKHkyKSk7CiAgICAgICAgaWYgKCF5Mi5zKSByZXR1cm4gbmV3IEN0b3IoT05FKTsKICAgICAgICB4MiA9IG5ldyBDdG9yKHgyKTsKICAgICAgICBpZiAoIXgyLnMpIHsKICAgICAgICAgIGlmICh5Mi5zIDwgMSkgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIkluZmluaXR5Iik7CiAgICAgICAgICByZXR1cm4geDI7CiAgICAgICAgfQogICAgICAgIGlmICh4Mi5lcShPTkUpKSByZXR1cm4geDI7CiAgICAgICAgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoeTIuZXEoT05FKSkgcmV0dXJuIHJvdW5kKHgyLCBwcik7CiAgICAgICAgZSA9IHkyLmU7CiAgICAgICAgayA9IHkyLmQubGVuZ3RoIC0gMTsKICAgICAgICB5SXNJbnQgPSBlID49IGs7CiAgICAgICAgc2lnbjIgPSB4Mi5zOwogICAgICAgIGlmICgheUlzSW50KSB7CiAgICAgICAgICBpZiAoc2lnbjIgPCAwKSB0aHJvdyBFcnJvcihkZWNpbWFsRXJyb3IgKyAiTmFOIik7CiAgICAgICAgfSBlbHNlIGlmICgoayA9IHluIDwgMCA/IC15biA6IHluKSA8PSBNQVhfU0FGRV9JTlRFR0VSKSB7CiAgICAgICAgICByMiA9IG5ldyBDdG9yKE9ORSk7CiAgICAgICAgICBlID0gTWF0aC5jZWlsKHByIC8gTE9HX0JBU0UgKyA0KTsKICAgICAgICAgIGV4dGVybmFsID0gZmFsc2U7CiAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgaWYgKGsgJSAyKSB7CiAgICAgICAgICAgICAgcjIgPSByMi50aW1lcyh4Mik7CiAgICAgICAgICAgICAgdHJ1bmNhdGUocjIuZCwgZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgayA9IG1hdGhmbG9vcihrIC8gMik7CiAgICAgICAgICAgIGlmIChrID09PSAwKSBicmVhazsKICAgICAgICAgICAgeDIgPSB4Mi50aW1lcyh4Mik7CiAgICAgICAgICAgIHRydW5jYXRlKHgyLmQsIGUpOwogICAgICAgICAgfQogICAgICAgICAgZXh0ZXJuYWwgPSB0cnVlOwogICAgICAgICAgcmV0dXJuIHkyLnMgPCAwID8gbmV3IEN0b3IoT05FKS5kaXYocjIpIDogcm91bmQocjIsIHByKTsKICAgICAgICB9CiAgICAgICAgc2lnbjIgPSBzaWduMiA8IDAgJiYgeTIuZFtNYXRoLm1heChlLCBrKV0gJiAxID8gLTEgOiAxOwogICAgICAgIHgyLnMgPSAxOwogICAgICAgIGV4dGVybmFsID0gZmFsc2U7CiAgICAgICAgcjIgPSB5Mi50aW1lcyhsbih4MiwgcHIgKyBndWFyZCkpOwogICAgICAgIGV4dGVybmFsID0gdHJ1ZTsKICAgICAgICByMiA9IGV4cChyMik7CiAgICAgICAgcjIucyA9IHNpZ24yOwogICAgICAgIHJldHVybiByMjsKICAgICAgfTsKICAgICAgUC50b1ByZWNpc2lvbiA9IGZ1bmN0aW9uKHNkLCBybSkgewogICAgICAgIHZhciBlLCBzdHIsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIGlmIChzZCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpOwogICAgICAgICAgc3RyID0gdG9TdHJpbmcoeDIsIGUgPD0gQ3Rvci50b0V4cE5lZyB8fCBlID49IEN0b3IudG9FeHBQb3MpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjaGVja0ludDMyKHNkLCAxLCBNQVhfRElHSVRTKTsKICAgICAgICAgIGlmIChybSA9PT0gdm9pZCAwKSBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgICBlbHNlIGNoZWNrSW50MzIocm0sIDAsIDgpOwogICAgICAgICAgeDIgPSByb3VuZChuZXcgQ3Rvcih4MiksIHNkLCBybSk7CiAgICAgICAgICBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpOwogICAgICAgICAgc3RyID0gdG9TdHJpbmcoeDIsIHNkIDw9IGUgfHwgZSA8PSBDdG9yLnRvRXhwTmVnLCBzZCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHI7CiAgICAgIH07CiAgICAgIFAudG9TaWduaWZpY2FudERpZ2l0cyA9IFAudG9zZCA9IGZ1bmN0aW9uKHNkLCBybSkgewogICAgICAgIHZhciB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoc2QgPT09IHZvaWQgMCkgewogICAgICAgICAgc2QgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICAgIHJtID0gQ3Rvci5yb3VuZGluZzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2hlY2tJbnQzMihzZCwgMSwgTUFYX0RJR0lUUyk7CiAgICAgICAgICBpZiAocm0gPT09IHZvaWQgMCkgcm0gPSBDdG9yLnJvdW5kaW5nOwogICAgICAgICAgZWxzZSBjaGVja0ludDMyKHJtLCAwLCA4KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJvdW5kKG5ldyBDdG9yKHgyKSwgc2QsIHJtKTsKICAgICAgfTsKICAgICAgUC50b1N0cmluZyA9IFAudmFsdWVPZiA9IFAudmFsID0gUC50b0pTT04gPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgeDIgPSB0aGlzLCBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpLCBDdG9yID0geDIuY29uc3RydWN0b3I7CiAgICAgICAgcmV0dXJuIHRvU3RyaW5nKHgyLCBlIDw9IEN0b3IudG9FeHBOZWcgfHwgZSA+PSBDdG9yLnRvRXhwUG9zKTsKICAgICAgfTsKICAgICAgZnVuY3Rpb24gYWRkKHgyLCB5MikgewogICAgICAgIHZhciBjYXJyeSwgZCwgZSwgaSwgaywgbGVuLCB4ZCwgeWQsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoIXgyLnMgfHwgIXkyLnMpIHsKICAgICAgICAgIGlmICgheTIucykgeTIgPSBuZXcgQ3Rvcih4Mik7CiAgICAgICAgICByZXR1cm4gZXh0ZXJuYWwgPyByb3VuZCh5MiwgcHIpIDogeTI7CiAgICAgICAgfQogICAgICAgIHhkID0geDIuZDsKICAgICAgICB5ZCA9IHkyLmQ7CiAgICAgICAgayA9IHgyLmU7CiAgICAgICAgZSA9IHkyLmU7CiAgICAgICAgeGQgPSB4ZC5zbGljZSgpOwogICAgICAgIGkgPSBrIC0gZTsKICAgICAgICBpZiAoaSkgewogICAgICAgICAgaWYgKGkgPCAwKSB7CiAgICAgICAgICAgIGQgPSB4ZDsKICAgICAgICAgICAgaSA9IC1pOwogICAgICAgICAgICBsZW4gPSB5ZC5sZW5ndGg7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkID0geWQ7CiAgICAgICAgICAgIGUgPSBrOwogICAgICAgICAgICBsZW4gPSB4ZC5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgICBrID0gTWF0aC5jZWlsKHByIC8gTE9HX0JBU0UpOwogICAgICAgICAgbGVuID0gayA+IGxlbiA/IGsgKyAxIDogbGVuICsgMTsKICAgICAgICAgIGlmIChpID4gbGVuKSB7CiAgICAgICAgICAgIGkgPSBsZW47CiAgICAgICAgICAgIGQubGVuZ3RoID0gMTsKICAgICAgICAgIH0KICAgICAgICAgIGQucmV2ZXJzZSgpOwogICAgICAgICAgZm9yICg7IGktLTsgKSBkLnB1c2goMCk7CiAgICAgICAgICBkLnJldmVyc2UoKTsKICAgICAgICB9CiAgICAgICAgbGVuID0geGQubGVuZ3RoOwogICAgICAgIGkgPSB5ZC5sZW5ndGg7CiAgICAgICAgaWYgKGxlbiAtIGkgPCAwKSB7CiAgICAgICAgICBpID0gbGVuOwogICAgICAgICAgZCA9IHlkOwogICAgICAgICAgeWQgPSB4ZDsKICAgICAgICAgIHhkID0gZDsKICAgICAgICB9CiAgICAgICAgZm9yIChjYXJyeSA9IDA7IGk7ICkgewogICAgICAgICAgY2FycnkgPSAoeGRbLS1pXSA9IHhkW2ldICsgeWRbaV0gKyBjYXJyeSkgLyBCQVNFIHwgMDsKICAgICAgICAgIHhkW2ldICU9IEJBU0U7CiAgICAgICAgfQogICAgICAgIGlmIChjYXJyeSkgewogICAgICAgICAgeGQudW5zaGlmdChjYXJyeSk7CiAgICAgICAgICArK2U7CiAgICAgICAgfQogICAgICAgIGZvciAobGVuID0geGQubGVuZ3RoOyB4ZFstLWxlbl0gPT0gMDsgKSB4ZC5wb3AoKTsKICAgICAgICB5Mi5kID0geGQ7CiAgICAgICAgeTIuZSA9IGU7CiAgICAgICAgcmV0dXJuIGV4dGVybmFsID8gcm91bmQoeTIsIHByKSA6IHkyOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNoZWNrSW50MzIoaSwgbWluMiwgbWF4MikgewogICAgICAgIGlmIChpICE9PSB+fmkgfHwgaSA8IG1pbjIgfHwgaSA+IG1heDIpIHsKICAgICAgICAgIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIGkpOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBkaWdpdHNUb1N0cmluZyhkKSB7CiAgICAgICAgdmFyIGksIGssIHdzLCBpbmRleE9mTGFzdFdvcmQgPSBkLmxlbmd0aCAtIDEsIHN0ciA9ICIiLCB3ID0gZFswXTsKICAgICAgICBpZiAoaW5kZXhPZkxhc3RXb3JkID4gMCkgewogICAgICAgICAgc3RyICs9IHc7CiAgICAgICAgICBmb3IgKGkgPSAxOyBpIDwgaW5kZXhPZkxhc3RXb3JkOyBpKyspIHsKICAgICAgICAgICAgd3MgPSBkW2ldICsgIiI7CiAgICAgICAgICAgIGsgPSBMT0dfQkFTRSAtIHdzLmxlbmd0aDsKICAgICAgICAgICAgaWYgKGspIHN0ciArPSBnZXRaZXJvU3RyaW5nKGspOwogICAgICAgICAgICBzdHIgKz0gd3M7CiAgICAgICAgICB9CiAgICAgICAgICB3ID0gZFtpXTsKICAgICAgICAgIHdzID0gdyArICIiOwogICAgICAgICAgayA9IExPR19CQVNFIC0gd3MubGVuZ3RoOwogICAgICAgICAgaWYgKGspIHN0ciArPSBnZXRaZXJvU3RyaW5nKGspOwogICAgICAgIH0gZWxzZSBpZiAodyA9PT0gMCkgewogICAgICAgICAgcmV0dXJuICIwIjsKICAgICAgICB9CiAgICAgICAgZm9yICg7IHcgJSAxMCA9PT0gMDsgKSB3IC89IDEwOwogICAgICAgIHJldHVybiBzdHIgKyB3OwogICAgICB9CiAgICAgIHZhciBkaXZpZGUgPSAvKiBAX19QVVJFX18gKi8gZnVuY3Rpb24oKSB7CiAgICAgICAgZnVuY3Rpb24gbXVsdGlwbHlJbnRlZ2VyKHgyLCBrKSB7CiAgICAgICAgICB2YXIgdGVtcCwgY2FycnkgPSAwLCBpID0geDIubGVuZ3RoOwogICAgICAgICAgZm9yICh4MiA9IHgyLnNsaWNlKCk7IGktLTsgKSB7CiAgICAgICAgICAgIHRlbXAgPSB4MltpXSAqIGsgKyBjYXJyeTsKICAgICAgICAgICAgeDJbaV0gPSB0ZW1wICUgQkFTRSB8IDA7CiAgICAgICAgICAgIGNhcnJ5ID0gdGVtcCAvIEJBU0UgfCAwOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNhcnJ5KSB4Mi51bnNoaWZ0KGNhcnJ5KTsKICAgICAgICAgIHJldHVybiB4MjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGFyZShhLCBiLCBhTCwgYkwpIHsKICAgICAgICAgIHZhciBpLCByMjsKICAgICAgICAgIGlmIChhTCAhPSBiTCkgewogICAgICAgICAgICByMiA9IGFMID4gYkwgPyAxIDogLTE7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmb3IgKGkgPSByMiA9IDA7IGkgPCBhTDsgaSsrKSB7CiAgICAgICAgICAgICAgaWYgKGFbaV0gIT0gYltpXSkgewogICAgICAgICAgICAgICAgcjIgPSBhW2ldID4gYltpXSA/IDEgOiAtMTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHIyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdWJ0cmFjdDIoYSwgYiwgYUwpIHsKICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgIGZvciAoOyBhTC0tOyApIHsKICAgICAgICAgICAgYVthTF0gLT0gaTsKICAgICAgICAgICAgaSA9IGFbYUxdIDwgYlthTF0gPyAxIDogMDsKICAgICAgICAgICAgYVthTF0gPSBpICogQkFTRSArIGFbYUxdIC0gYlthTF07CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKDsgIWFbMF0gJiYgYS5sZW5ndGggPiAxOyApIGEuc2hpZnQoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKHgyLCB5MiwgcHIsIGRwKSB7CiAgICAgICAgICB2YXIgY21wLCBlLCBpLCBrLCBwcm9kLCBwcm9kTCwgcSwgcWQsIHJlbSwgcmVtTCwgcmVtMCwgc2QsIHQsIHhpLCB4TCwgeWQwLCB5TCwgeXosIEN0b3IgPSB4Mi5jb25zdHJ1Y3Rvciwgc2lnbjIgPSB4Mi5zID09IHkyLnMgPyAxIDogLTEsIHhkID0geDIuZCwgeWQgPSB5Mi5kOwogICAgICAgICAgaWYgKCF4Mi5zKSByZXR1cm4gbmV3IEN0b3IoeDIpOwogICAgICAgICAgaWYgKCF5Mi5zKSB0aHJvdyBFcnJvcihkZWNpbWFsRXJyb3IgKyAiRGl2aXNpb24gYnkgemVybyIpOwogICAgICAgICAgZSA9IHgyLmUgLSB5Mi5lOwogICAgICAgICAgeUwgPSB5ZC5sZW5ndGg7CiAgICAgICAgICB4TCA9IHhkLmxlbmd0aDsKICAgICAgICAgIHEgPSBuZXcgQ3RvcihzaWduMik7CiAgICAgICAgICBxZCA9IHEuZCA9IFtdOwogICAgICAgICAgZm9yIChpID0gMDsgeWRbaV0gPT0gKHhkW2ldIHx8IDApOyApICsraTsKICAgICAgICAgIGlmICh5ZFtpXSA+ICh4ZFtpXSB8fCAwKSkgLS1lOwogICAgICAgICAgaWYgKHByID09IG51bGwpIHsKICAgICAgICAgICAgc2QgPSBwciA9IEN0b3IucHJlY2lzaW9uOwogICAgICAgICAgfSBlbHNlIGlmIChkcCkgewogICAgICAgICAgICBzZCA9IHByICsgKGdldEJhc2UxMEV4cG9uZW50KHgyKSAtIGdldEJhc2UxMEV4cG9uZW50KHkyKSkgKyAxOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2QgPSBwcjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzZCA8IDApIHJldHVybiBuZXcgQ3RvcigwKTsKICAgICAgICAgIHNkID0gc2QgLyBMT0dfQkFTRSArIDIgfCAwOwogICAgICAgICAgaSA9IDA7CiAgICAgICAgICBpZiAoeUwgPT0gMSkgewogICAgICAgICAgICBrID0gMDsKICAgICAgICAgICAgeWQgPSB5ZFswXTsKICAgICAgICAgICAgc2QrKzsKICAgICAgICAgICAgZm9yICg7IChpIDwgeEwgfHwgaykgJiYgc2QtLTsgaSsrKSB7CiAgICAgICAgICAgICAgdCA9IGsgKiBCQVNFICsgKHhkW2ldIHx8IDApOwogICAgICAgICAgICAgIHFkW2ldID0gdCAvIHlkIHwgMDsKICAgICAgICAgICAgICBrID0gdCAlIHlkIHwgMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgayA9IEJBU0UgLyAoeWRbMF0gKyAxKSB8IDA7CiAgICAgICAgICAgIGlmIChrID4gMSkgewogICAgICAgICAgICAgIHlkID0gbXVsdGlwbHlJbnRlZ2VyKHlkLCBrKTsKICAgICAgICAgICAgICB4ZCA9IG11bHRpcGx5SW50ZWdlcih4ZCwgayk7CiAgICAgICAgICAgICAgeUwgPSB5ZC5sZW5ndGg7CiAgICAgICAgICAgICAgeEwgPSB4ZC5sZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgeGkgPSB5TDsKICAgICAgICAgICAgcmVtID0geGQuc2xpY2UoMCwgeUwpOwogICAgICAgICAgICByZW1MID0gcmVtLmxlbmd0aDsKICAgICAgICAgICAgZm9yICg7IHJlbUwgPCB5TDsgKSByZW1bcmVtTCsrXSA9IDA7CiAgICAgICAgICAgIHl6ID0geWQuc2xpY2UoKTsKICAgICAgICAgICAgeXoudW5zaGlmdCgwKTsKICAgICAgICAgICAgeWQwID0geWRbMF07CiAgICAgICAgICAgIGlmICh5ZFsxXSA+PSBCQVNFIC8gMikgKyt5ZDA7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBrID0gMDsKICAgICAgICAgICAgICBjbXAgPSBjb21wYXJlKHlkLCByZW0sIHlMLCByZW1MKTsKICAgICAgICAgICAgICBpZiAoY21wIDwgMCkgewogICAgICAgICAgICAgICAgcmVtMCA9IHJlbVswXTsKICAgICAgICAgICAgICAgIGlmICh5TCAhPSByZW1MKSByZW0wID0gcmVtMCAqIEJBU0UgKyAocmVtWzFdIHx8IDApOwogICAgICAgICAgICAgICAgayA9IHJlbTAgLyB5ZDAgfCAwOwogICAgICAgICAgICAgICAgaWYgKGsgPiAxKSB7CiAgICAgICAgICAgICAgICAgIGlmIChrID49IEJBU0UpIGsgPSBCQVNFIC0gMTsKICAgICAgICAgICAgICAgICAgcHJvZCA9IG11bHRpcGx5SW50ZWdlcih5ZCwgayk7CiAgICAgICAgICAgICAgICAgIHByb2RMID0gcHJvZC5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIHJlbUwgPSByZW0ubGVuZ3RoOwogICAgICAgICAgICAgICAgICBjbXAgPSBjb21wYXJlKHByb2QsIHJlbSwgcHJvZEwsIHJlbUwpOwogICAgICAgICAgICAgICAgICBpZiAoY21wID09IDEpIHsKICAgICAgICAgICAgICAgICAgICBrLS07CiAgICAgICAgICAgICAgICAgICAgc3VidHJhY3QyKHByb2QsIHlMIDwgcHJvZEwgPyB5eiA6IHlkLCBwcm9kTCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGlmIChrID09IDApIGNtcCA9IGsgPSAxOwogICAgICAgICAgICAgICAgICBwcm9kID0geWQuc2xpY2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByb2RMID0gcHJvZC5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAocHJvZEwgPCByZW1MKSBwcm9kLnVuc2hpZnQoMCk7CiAgICAgICAgICAgICAgICBzdWJ0cmFjdDIocmVtLCBwcm9kLCByZW1MKTsKICAgICAgICAgICAgICAgIGlmIChjbXAgPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgcmVtTCA9IHJlbS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIGNtcCA9IGNvbXBhcmUoeWQsIHJlbSwgeUwsIHJlbUwpOwogICAgICAgICAgICAgICAgICBpZiAoY21wIDwgMSkgewogICAgICAgICAgICAgICAgICAgIGsrKzsKICAgICAgICAgICAgICAgICAgICBzdWJ0cmFjdDIocmVtLCB5TCA8IHJlbUwgPyB5eiA6IHlkLCByZW1MKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmVtTCA9IHJlbS5sZW5ndGg7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChjbXAgPT09IDApIHsKICAgICAgICAgICAgICAgIGsrKzsKICAgICAgICAgICAgICAgIHJlbSA9IFswXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcWRbaSsrXSA9IGs7CiAgICAgICAgICAgICAgaWYgKGNtcCAmJiByZW1bMF0pIHsKICAgICAgICAgICAgICAgIHJlbVtyZW1MKytdID0geGRbeGldIHx8IDA7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlbSA9IFt4ZFt4aV1dOwogICAgICAgICAgICAgICAgcmVtTCA9IDE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IHdoaWxlICgoeGkrKyA8IHhMIHx8IHJlbVswXSAhPT0gdm9pZCAwKSAmJiBzZC0tKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghcWRbMF0pIHFkLnNoaWZ0KCk7CiAgICAgICAgICBxLmUgPSBlOwogICAgICAgICAgcmV0dXJuIHJvdW5kKHEsIGRwID8gcHIgKyBnZXRCYXNlMTBFeHBvbmVudChxKSArIDEgOiBwcik7CiAgICAgICAgfTsKICAgICAgfSgpOwogICAgICBmdW5jdGlvbiBleHAoeDIsIHNkKSB7CiAgICAgICAgdmFyIGRlbm9taW5hdG9yLCBndWFyZCwgcG93Miwgc3VtLCB0LCB3cHIsIGkgPSAwLCBrID0gMCwgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBwciA9IEN0b3IucHJlY2lzaW9uOwogICAgICAgIGlmIChnZXRCYXNlMTBFeHBvbmVudCh4MikgPiAxNikgdGhyb3cgRXJyb3IoZXhwb25lbnRPdXRPZlJhbmdlICsgZ2V0QmFzZTEwRXhwb25lbnQoeDIpKTsKICAgICAgICBpZiAoIXgyLnMpIHJldHVybiBuZXcgQ3RvcihPTkUpOwogICAgICAgIGlmIChzZCA9PSBudWxsKSB7CiAgICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgICAgd3ByID0gcHI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdwciA9IHNkOwogICAgICAgIH0KICAgICAgICB0ID0gbmV3IEN0b3IoMC4wMzEyNSk7CiAgICAgICAgd2hpbGUgKHgyLmFicygpLmd0ZSgwLjEpKSB7CiAgICAgICAgICB4MiA9IHgyLnRpbWVzKHQpOwogICAgICAgICAgayArPSA1OwogICAgICAgIH0KICAgICAgICBndWFyZCA9IE1hdGgubG9nKG1hdGhwb3coMiwgaykpIC8gTWF0aC5MTjEwICogMiArIDUgfCAwOwogICAgICAgIHdwciArPSBndWFyZDsKICAgICAgICBkZW5vbWluYXRvciA9IHBvdzIgPSBzdW0gPSBuZXcgQ3RvcihPTkUpOwogICAgICAgIEN0b3IucHJlY2lzaW9uID0gd3ByOwogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgcG93MiA9IHJvdW5kKHBvdzIudGltZXMoeDIpLCB3cHIpOwogICAgICAgICAgZGVub21pbmF0b3IgPSBkZW5vbWluYXRvci50aW1lcygrK2kpOwogICAgICAgICAgdCA9IHN1bS5wbHVzKGRpdmlkZShwb3cyLCBkZW5vbWluYXRvciwgd3ByKSk7CiAgICAgICAgICBpZiAoZGlnaXRzVG9TdHJpbmcodC5kKS5zbGljZSgwLCB3cHIpID09PSBkaWdpdHNUb1N0cmluZyhzdW0uZCkuc2xpY2UoMCwgd3ByKSkgewogICAgICAgICAgICB3aGlsZSAoay0tKSBzdW0gPSByb3VuZChzdW0udGltZXMoc3VtKSwgd3ByKTsKICAgICAgICAgICAgQ3Rvci5wcmVjaXNpb24gPSBwcjsKICAgICAgICAgICAgcmV0dXJuIHNkID09IG51bGwgPyAoZXh0ZXJuYWwgPSB0cnVlLCByb3VuZChzdW0sIHByKSkgOiBzdW07CiAgICAgICAgICB9CiAgICAgICAgICBzdW0gPSB0OwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRCYXNlMTBFeHBvbmVudCh4MikgewogICAgICAgIHZhciBlID0geDIuZSAqIExPR19CQVNFLCB3ID0geDIuZFswXTsKICAgICAgICBmb3IgKDsgdyA+PSAxMDsgdyAvPSAxMCkgZSsrOwogICAgICAgIHJldHVybiBlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGdldExuMTAoQ3Rvciwgc2QsIHByKSB7CiAgICAgICAgaWYgKHNkID4gQ3Rvci5MTjEwLnNkKCkpIHsKICAgICAgICAgIGV4dGVybmFsID0gdHJ1ZTsKICAgICAgICAgIGlmIChwcikgQ3Rvci5wcmVjaXNpb24gPSBwcjsKICAgICAgICAgIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJMTjEwIHByZWNpc2lvbiBsaW1pdCBleGNlZWRlZCIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcm91bmQobmV3IEN0b3IoQ3Rvci5MTjEwKSwgc2QpOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGdldFplcm9TdHJpbmcoaykgewogICAgICAgIHZhciB6cyA9ICIiOwogICAgICAgIGZvciAoOyBrLS07ICkgenMgKz0gIjAiOwogICAgICAgIHJldHVybiB6czsKICAgICAgfQogICAgICBmdW5jdGlvbiBsbih5Miwgc2QpIHsKICAgICAgICB2YXIgYywgYzAsIGRlbm9taW5hdG9yLCBlLCBudW1lcmF0b3IsIHN1bSwgdCwgd3ByLCB4MiwgbiA9IDEsIGd1YXJkID0gMTAsIHgzID0geTIsIHhkID0geDMuZCwgQ3RvciA9IHgzLmNvbnN0cnVjdG9yLCBwciA9IEN0b3IucHJlY2lzaW9uOwogICAgICAgIGlmICh4My5zIDwgMSkgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgKHgzLnMgPyAiTmFOIiA6ICItSW5maW5pdHkiKSk7CiAgICAgICAgaWYgKHgzLmVxKE9ORSkpIHJldHVybiBuZXcgQ3RvcigwKTsKICAgICAgICBpZiAoc2QgPT0gbnVsbCkgewogICAgICAgICAgZXh0ZXJuYWwgPSBmYWxzZTsKICAgICAgICAgIHdwciA9IHByOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3cHIgPSBzZDsKICAgICAgICB9CiAgICAgICAgaWYgKHgzLmVxKDEwKSkgewogICAgICAgICAgaWYgKHNkID09IG51bGwpIGV4dGVybmFsID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiBnZXRMbjEwKEN0b3IsIHdwcik7CiAgICAgICAgfQogICAgICAgIHdwciArPSBndWFyZDsKICAgICAgICBDdG9yLnByZWNpc2lvbiA9IHdwcjsKICAgICAgICBjID0gZGlnaXRzVG9TdHJpbmcoeGQpOwogICAgICAgIGMwID0gYy5jaGFyQXQoMCk7CiAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgzKTsKICAgICAgICBpZiAoTWF0aC5hYnMoZSkgPCAxNWUxNCkgewogICAgICAgICAgd2hpbGUgKGMwIDwgNyAmJiBjMCAhPSAxIHx8IGMwID09IDEgJiYgYy5jaGFyQXQoMSkgPiAzKSB7CiAgICAgICAgICAgIHgzID0geDMudGltZXMoeTIpOwogICAgICAgICAgICBjID0gZGlnaXRzVG9TdHJpbmcoeDMuZCk7CiAgICAgICAgICAgIGMwID0gYy5jaGFyQXQoMCk7CiAgICAgICAgICAgIG4rKzsKICAgICAgICAgIH0KICAgICAgICAgIGUgPSBnZXRCYXNlMTBFeHBvbmVudCh4Myk7CiAgICAgICAgICBpZiAoYzAgPiAxKSB7CiAgICAgICAgICAgIHgzID0gbmV3IEN0b3IoIjAuIiArIGMpOwogICAgICAgICAgICBlKys7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB4MyA9IG5ldyBDdG9yKGMwICsgIi4iICsgYy5zbGljZSgxKSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHQgPSBnZXRMbjEwKEN0b3IsIHdwciArIDIsIHByKS50aW1lcyhlICsgIiIpOwogICAgICAgICAgeDMgPSBsbihuZXcgQ3RvcihjMCArICIuIiArIGMuc2xpY2UoMSkpLCB3cHIgLSBndWFyZCkucGx1cyh0KTsKICAgICAgICAgIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICByZXR1cm4gc2QgPT0gbnVsbCA/IChleHRlcm5hbCA9IHRydWUsIHJvdW5kKHgzLCBwcikpIDogeDM7CiAgICAgICAgfQogICAgICAgIHN1bSA9IG51bWVyYXRvciA9IHgzID0gZGl2aWRlKHgzLm1pbnVzKE9ORSksIHgzLnBsdXMoT05FKSwgd3ByKTsKICAgICAgICB4MiA9IHJvdW5kKHgzLnRpbWVzKHgzKSwgd3ByKTsKICAgICAgICBkZW5vbWluYXRvciA9IDM7CiAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICBudW1lcmF0b3IgPSByb3VuZChudW1lcmF0b3IudGltZXMoeDIpLCB3cHIpOwogICAgICAgICAgdCA9IHN1bS5wbHVzKGRpdmlkZShudW1lcmF0b3IsIG5ldyBDdG9yKGRlbm9taW5hdG9yKSwgd3ByKSk7CiAgICAgICAgICBpZiAoZGlnaXRzVG9TdHJpbmcodC5kKS5zbGljZSgwLCB3cHIpID09PSBkaWdpdHNUb1N0cmluZyhzdW0uZCkuc2xpY2UoMCwgd3ByKSkgewogICAgICAgICAgICBzdW0gPSBzdW0udGltZXMoMik7CiAgICAgICAgICAgIGlmIChlICE9PSAwKSBzdW0gPSBzdW0ucGx1cyhnZXRMbjEwKEN0b3IsIHdwciArIDIsIHByKS50aW1lcyhlICsgIiIpKTsKICAgICAgICAgICAgc3VtID0gZGl2aWRlKHN1bSwgbmV3IEN0b3IobiksIHdwcik7CiAgICAgICAgICAgIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICAgIHJldHVybiBzZCA9PSBudWxsID8gKGV4dGVybmFsID0gdHJ1ZSwgcm91bmQoc3VtLCBwcikpIDogc3VtOwogICAgICAgICAgfQogICAgICAgICAgc3VtID0gdDsKICAgICAgICAgIGRlbm9taW5hdG9yICs9IDI7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIHBhcnNlRGVjaW1hbCh4Miwgc3RyKSB7CiAgICAgICAgdmFyIGUsIGksIGxlbjsKICAgICAgICBpZiAoKGUgPSBzdHIuaW5kZXhPZigiLiIpKSA+IC0xKSBzdHIgPSBzdHIucmVwbGFjZSgiLiIsICIiKTsKICAgICAgICBpZiAoKGkgPSBzdHIuc2VhcmNoKC9lL2kpKSA+IDApIHsKICAgICAgICAgIGlmIChlIDwgMCkgZSA9IGk7CiAgICAgICAgICBlICs9ICtzdHIuc2xpY2UoaSArIDEpOwogICAgICAgICAgc3RyID0gc3RyLnN1YnN0cmluZygwLCBpKTsKICAgICAgICB9IGVsc2UgaWYgKGUgPCAwKSB7CiAgICAgICAgICBlID0gc3RyLmxlbmd0aDsKICAgICAgICB9CiAgICAgICAgZm9yIChpID0gMDsgc3RyLmNoYXJDb2RlQXQoaSkgPT09IDQ4OyApICsraTsKICAgICAgICBmb3IgKGxlbiA9IHN0ci5sZW5ndGg7IHN0ci5jaGFyQ29kZUF0KGxlbiAtIDEpID09PSA0ODsgKSAtLWxlbjsKICAgICAgICBzdHIgPSBzdHIuc2xpY2UoaSwgbGVuKTsKICAgICAgICBpZiAoc3RyKSB7CiAgICAgICAgICBsZW4gLT0gaTsKICAgICAgICAgIGUgPSBlIC0gaSAtIDE7CiAgICAgICAgICB4Mi5lID0gbWF0aGZsb29yKGUgLyBMT0dfQkFTRSk7CiAgICAgICAgICB4Mi5kID0gW107CiAgICAgICAgICBpID0gKGUgKyAxKSAlIExPR19CQVNFOwogICAgICAgICAgaWYgKGUgPCAwKSBpICs9IExPR19CQVNFOwogICAgICAgICAgaWYgKGkgPCBsZW4pIHsKICAgICAgICAgICAgaWYgKGkpIHgyLmQucHVzaCgrc3RyLnNsaWNlKDAsIGkpKTsKICAgICAgICAgICAgZm9yIChsZW4gLT0gTE9HX0JBU0U7IGkgPCBsZW47ICkgeDIuZC5wdXNoKCtzdHIuc2xpY2UoaSwgaSArPSBMT0dfQkFTRSkpOwogICAgICAgICAgICBzdHIgPSBzdHIuc2xpY2UoaSk7CiAgICAgICAgICAgIGkgPSBMT0dfQkFTRSAtIHN0ci5sZW5ndGg7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpIC09IGxlbjsKICAgICAgICAgIH0KICAgICAgICAgIGZvciAoOyBpLS07ICkgc3RyICs9ICIwIjsKICAgICAgICAgIHgyLmQucHVzaCgrc3RyKTsKICAgICAgICAgIGlmIChleHRlcm5hbCAmJiAoeDIuZSA+IE1BWF9FIHx8IHgyLmUgPCAtTUFYX0UpKSB0aHJvdyBFcnJvcihleHBvbmVudE91dE9mUmFuZ2UgKyBlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeDIucyA9IDA7CiAgICAgICAgICB4Mi5lID0gMDsKICAgICAgICAgIHgyLmQgPSBbMF07CiAgICAgICAgfQogICAgICAgIHJldHVybiB4MjsKICAgICAgfQogICAgICBmdW5jdGlvbiByb3VuZCh4Miwgc2QsIHJtKSB7CiAgICAgICAgdmFyIGksIGosIGssIG4sIHJkLCBkb1JvdW5kLCB3LCB4ZGksIHhkID0geDIuZDsKICAgICAgICBmb3IgKG4gPSAxLCBrID0geGRbMF07IGsgPj0gMTA7IGsgLz0gMTApIG4rKzsKICAgICAgICBpID0gc2QgLSBuOwogICAgICAgIGlmIChpIDwgMCkgewogICAgICAgICAgaSArPSBMT0dfQkFTRTsKICAgICAgICAgIGogPSBzZDsKICAgICAgICAgIHcgPSB4ZFt4ZGkgPSAwXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeGRpID0gTWF0aC5jZWlsKChpICsgMSkgLyBMT0dfQkFTRSk7CiAgICAgICAgICBrID0geGQubGVuZ3RoOwogICAgICAgICAgaWYgKHhkaSA+PSBrKSByZXR1cm4geDI7CiAgICAgICAgICB3ID0gayA9IHhkW3hkaV07CiAgICAgICAgICBmb3IgKG4gPSAxOyBrID49IDEwOyBrIC89IDEwKSBuKys7CiAgICAgICAgICBpICU9IExPR19CQVNFOwogICAgICAgICAgaiA9IGkgLSBMT0dfQkFTRSArIG47CiAgICAgICAgfQogICAgICAgIGlmIChybSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBrID0gbWF0aHBvdygxMCwgbiAtIGogLSAxKTsKICAgICAgICAgIHJkID0gdyAvIGsgJSAxMCB8IDA7CiAgICAgICAgICBkb1JvdW5kID0gc2QgPCAwIHx8IHhkW3hkaSArIDFdICE9PSB2b2lkIDAgfHwgdyAlIGs7CiAgICAgICAgICBkb1JvdW5kID0gcm0gPCA0ID8gKHJkIHx8IGRvUm91bmQpICYmIChybSA9PSAwIHx8IHJtID09ICh4Mi5zIDwgMCA/IDMgOiAyKSkgOiByZCA+IDUgfHwgcmQgPT0gNSAmJiAocm0gPT0gNCB8fCBkb1JvdW5kIHx8IHJtID09IDYgJiYgLy8gQ2hlY2sgd2hldGhlciB0aGUgZGlnaXQgdG8gdGhlIGxlZnQgb2YgdGhlIHJvdW5kaW5nIGRpZ2l0IGlzIG9kZC4KICAgICAgICAgIChpID4gMCA/IGogPiAwID8gdyAvIG1hdGhwb3coMTAsIG4gLSBqKSA6IDAgOiB4ZFt4ZGkgLSAxXSkgJSAxMCAmIDEgfHwgcm0gPT0gKHgyLnMgPCAwID8gOCA6IDcpKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNkIDwgMSB8fCAheGRbMF0pIHsKICAgICAgICAgIGlmIChkb1JvdW5kKSB7CiAgICAgICAgICAgIGsgPSBnZXRCYXNlMTBFeHBvbmVudCh4Mik7CiAgICAgICAgICAgIHhkLmxlbmd0aCA9IDE7CiAgICAgICAgICAgIHNkID0gc2QgLSBrIC0gMTsKICAgICAgICAgICAgeGRbMF0gPSBtYXRocG93KDEwLCAoTE9HX0JBU0UgLSBzZCAlIExPR19CQVNFKSAlIExPR19CQVNFKTsKICAgICAgICAgICAgeDIuZSA9IG1hdGhmbG9vcigtc2QgLyBMT0dfQkFTRSkgfHwgMDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHhkLmxlbmd0aCA9IDE7CiAgICAgICAgICAgIHhkWzBdID0geDIuZSA9IHgyLnMgPSAwOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHgyOwogICAgICAgIH0KICAgICAgICBpZiAoaSA9PSAwKSB7CiAgICAgICAgICB4ZC5sZW5ndGggPSB4ZGk7CiAgICAgICAgICBrID0gMTsKICAgICAgICAgIHhkaS0tOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB4ZC5sZW5ndGggPSB4ZGkgKyAxOwogICAgICAgICAgayA9IG1hdGhwb3coMTAsIExPR19CQVNFIC0gaSk7CiAgICAgICAgICB4ZFt4ZGldID0gaiA+IDAgPyAodyAvIG1hdGhwb3coMTAsIG4gLSBqKSAlIG1hdGhwb3coMTAsIGopIHwgMCkgKiBrIDogMDsKICAgICAgICB9CiAgICAgICAgaWYgKGRvUm91bmQpIHsKICAgICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgICBpZiAoeGRpID09IDApIHsKICAgICAgICAgICAgICBpZiAoKHhkWzBdICs9IGspID09IEJBU0UpIHsKICAgICAgICAgICAgICAgIHhkWzBdID0gMTsKICAgICAgICAgICAgICAgICsreDIuZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgeGRbeGRpXSArPSBrOwogICAgICAgICAgICAgIGlmICh4ZFt4ZGldICE9IEJBU0UpIGJyZWFrOwogICAgICAgICAgICAgIHhkW3hkaS0tXSA9IDA7CiAgICAgICAgICAgICAgayA9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChpID0geGQubGVuZ3RoOyB4ZFstLWldID09PSAwOyApIHhkLnBvcCgpOwogICAgICAgIGlmIChleHRlcm5hbCAmJiAoeDIuZSA+IE1BWF9FIHx8IHgyLmUgPCAtTUFYX0UpKSB7CiAgICAgICAgICB0aHJvdyBFcnJvcihleHBvbmVudE91dE9mUmFuZ2UgKyBnZXRCYXNlMTBFeHBvbmVudCh4MikpOwogICAgICAgIH0KICAgICAgICByZXR1cm4geDI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gc3VidHJhY3QoeDIsIHkyKSB7CiAgICAgICAgdmFyIGQsIGUsIGksIGosIGssIGxlbiwgeGQsIHhlLCB4TFR5LCB5ZCwgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBwciA9IEN0b3IucHJlY2lzaW9uOwogICAgICAgIGlmICgheDIucyB8fCAheTIucykgewogICAgICAgICAgaWYgKHkyLnMpIHkyLnMgPSAteTIuczsKICAgICAgICAgIGVsc2UgeTIgPSBuZXcgQ3Rvcih4Mik7CiAgICAgICAgICByZXR1cm4gZXh0ZXJuYWwgPyByb3VuZCh5MiwgcHIpIDogeTI7CiAgICAgICAgfQogICAgICAgIHhkID0geDIuZDsKICAgICAgICB5ZCA9IHkyLmQ7CiAgICAgICAgZSA9IHkyLmU7CiAgICAgICAgeGUgPSB4Mi5lOwogICAgICAgIHhkID0geGQuc2xpY2UoKTsKICAgICAgICBrID0geGUgLSBlOwogICAgICAgIGlmIChrKSB7CiAgICAgICAgICB4TFR5ID0gayA8IDA7CiAgICAgICAgICBpZiAoeExUeSkgewogICAgICAgICAgICBkID0geGQ7CiAgICAgICAgICAgIGsgPSAtazsKICAgICAgICAgICAgbGVuID0geWQubGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZCA9IHlkOwogICAgICAgICAgICBlID0geGU7CiAgICAgICAgICAgIGxlbiA9IHhkLmxlbmd0aDsKICAgICAgICAgIH0KICAgICAgICAgIGkgPSBNYXRoLm1heChNYXRoLmNlaWwocHIgLyBMT0dfQkFTRSksIGxlbikgKyAyOwogICAgICAgICAgaWYgKGsgPiBpKSB7CiAgICAgICAgICAgIGsgPSBpOwogICAgICAgICAgICBkLmxlbmd0aCA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBkLnJldmVyc2UoKTsKICAgICAgICAgIGZvciAoaSA9IGs7IGktLTsgKSBkLnB1c2goMCk7CiAgICAgICAgICBkLnJldmVyc2UoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaSA9IHhkLmxlbmd0aDsKICAgICAgICAgIGxlbiA9IHlkLmxlbmd0aDsKICAgICAgICAgIHhMVHkgPSBpIDwgbGVuOwogICAgICAgICAgaWYgKHhMVHkpIGxlbiA9IGk7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKHhkW2ldICE9IHlkW2ldKSB7CiAgICAgICAgICAgICAgeExUeSA9IHhkW2ldIDwgeWRbaV07CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGsgPSAwOwogICAgICAgIH0KICAgICAgICBpZiAoeExUeSkgewogICAgICAgICAgZCA9IHhkOwogICAgICAgICAgeGQgPSB5ZDsKICAgICAgICAgIHlkID0gZDsKICAgICAgICAgIHkyLnMgPSAteTIuczsKICAgICAgICB9CiAgICAgICAgbGVuID0geGQubGVuZ3RoOwogICAgICAgIGZvciAoaSA9IHlkLmxlbmd0aCAtIGxlbjsgaSA+IDA7IC0taSkgeGRbbGVuKytdID0gMDsKICAgICAgICBmb3IgKGkgPSB5ZC5sZW5ndGg7IGkgPiBrOyApIHsKICAgICAgICAgIGlmICh4ZFstLWldIDwgeWRbaV0pIHsKICAgICAgICAgICAgZm9yIChqID0gaTsgaiAmJiB4ZFstLWpdID09PSAwOyApIHhkW2pdID0gQkFTRSAtIDE7CiAgICAgICAgICAgIC0teGRbal07CiAgICAgICAgICAgIHhkW2ldICs9IEJBU0U7CiAgICAgICAgICB9CiAgICAgICAgICB4ZFtpXSAtPSB5ZFtpXTsKICAgICAgICB9CiAgICAgICAgZm9yICg7IHhkWy0tbGVuXSA9PT0gMDsgKSB4ZC5wb3AoKTsKICAgICAgICBmb3IgKDsgeGRbMF0gPT09IDA7IHhkLnNoaWZ0KCkpIC0tZTsKICAgICAgICBpZiAoIXhkWzBdKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgeTIuZCA9IHhkOwogICAgICAgIHkyLmUgPSBlOwogICAgICAgIHJldHVybiBleHRlcm5hbCA/IHJvdW5kKHkyLCBwcikgOiB5MjsKICAgICAgfQogICAgICBmdW5jdGlvbiB0b1N0cmluZyh4MiwgaXNFeHAsIHNkKSB7CiAgICAgICAgdmFyIGssIGUgPSBnZXRCYXNlMTBFeHBvbmVudCh4MiksIHN0ciA9IGRpZ2l0c1RvU3RyaW5nKHgyLmQpLCBsZW4gPSBzdHIubGVuZ3RoOwogICAgICAgIGlmIChpc0V4cCkgewogICAgICAgICAgaWYgKHNkICYmIChrID0gc2QgLSBsZW4pID4gMCkgewogICAgICAgICAgICBzdHIgPSBzdHIuY2hhckF0KDApICsgIi4iICsgc3RyLnNsaWNlKDEpICsgZ2V0WmVyb1N0cmluZyhrKTsKICAgICAgICAgIH0gZWxzZSBpZiAobGVuID4gMSkgewogICAgICAgICAgICBzdHIgPSBzdHIuY2hhckF0KDApICsgIi4iICsgc3RyLnNsaWNlKDEpOwogICAgICAgICAgfQogICAgICAgICAgc3RyID0gc3RyICsgKGUgPCAwID8gImUiIDogImUrIikgKyBlOwogICAgICAgIH0gZWxzZSBpZiAoZSA8IDApIHsKICAgICAgICAgIHN0ciA9ICIwLiIgKyBnZXRaZXJvU3RyaW5nKC1lIC0gMSkgKyBzdHI7CiAgICAgICAgICBpZiAoc2QgJiYgKGsgPSBzZCAtIGxlbikgPiAwKSBzdHIgKz0gZ2V0WmVyb1N0cmluZyhrKTsKICAgICAgICB9IGVsc2UgaWYgKGUgPj0gbGVuKSB7CiAgICAgICAgICBzdHIgKz0gZ2V0WmVyb1N0cmluZyhlICsgMSAtIGxlbik7CiAgICAgICAgICBpZiAoc2QgJiYgKGsgPSBzZCAtIGUgLSAxKSA+IDApIHN0ciA9IHN0ciArICIuIiArIGdldFplcm9TdHJpbmcoayk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICgoayA9IGUgKyAxKSA8IGxlbikgc3RyID0gc3RyLnNsaWNlKDAsIGspICsgIi4iICsgc3RyLnNsaWNlKGspOwogICAgICAgICAgaWYgKHNkICYmIChrID0gc2QgLSBsZW4pID4gMCkgewogICAgICAgICAgICBpZiAoZSArIDEgPT09IGxlbikgc3RyICs9ICIuIjsKICAgICAgICAgICAgc3RyICs9IGdldFplcm9TdHJpbmcoayk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB4Mi5zIDwgMCA/ICItIiArIHN0ciA6IHN0cjsKICAgICAgfQogICAgICBmdW5jdGlvbiB0cnVuY2F0ZShhcnIsIGxlbikgewogICAgICAgIGlmIChhcnIubGVuZ3RoID4gbGVuKSB7CiAgICAgICAgICBhcnIubGVuZ3RoID0gbGVuOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNsb25lKG9iaikgewogICAgICAgIHZhciBpLCBwLCBwczsKICAgICAgICBmdW5jdGlvbiBEZWNpbWFsNCh2YWx1ZSkgewogICAgICAgICAgdmFyIHgyID0gdGhpczsKICAgICAgICAgIGlmICghKHgyIGluc3RhbmNlb2YgRGVjaW1hbDQpKSByZXR1cm4gbmV3IERlY2ltYWw0KHZhbHVlKTsKICAgICAgICAgIHgyLmNvbnN0cnVjdG9yID0gRGVjaW1hbDQ7CiAgICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEZWNpbWFsNCkgewogICAgICAgICAgICB4Mi5zID0gdmFsdWUuczsKICAgICAgICAgICAgeDIuZSA9IHZhbHVlLmU7CiAgICAgICAgICAgIHgyLmQgPSAodmFsdWUgPSB2YWx1ZS5kKSA/IHZhbHVlLnNsaWNlKCkgOiB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgaWYgKHZhbHVlICogMCAhPT0gMCkgewogICAgICAgICAgICAgIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmFsdWUgPiAwKSB7CiAgICAgICAgICAgICAgeDIucyA9IDE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUgPCAwKSB7CiAgICAgICAgICAgICAgdmFsdWUgPSAtdmFsdWU7CiAgICAgICAgICAgICAgeDIucyA9IC0xOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHgyLnMgPSAwOwogICAgICAgICAgICAgIHgyLmUgPSAwOwogICAgICAgICAgICAgIHgyLmQgPSBbMF07CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gfn52YWx1ZSAmJiB2YWx1ZSA8IDFlNykgewogICAgICAgICAgICAgIHgyLmUgPSAwOwogICAgICAgICAgICAgIHgyLmQgPSBbdmFsdWVdOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcGFyc2VEZWNpbWFsKHgyLCB2YWx1ZS50b1N0cmluZygpKTsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlICE9PSAic3RyaW5nIikgewogICAgICAgICAgICB0aHJvdyBFcnJvcihpbnZhbGlkQXJndW1lbnQgKyB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmFsdWUuY2hhckNvZGVBdCgwKSA9PT0gNDUpIHsKICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5zbGljZSgxKTsKICAgICAgICAgICAgeDIucyA9IC0xOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgeDIucyA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNEZWNpbWFsLnRlc3QodmFsdWUpKSBwYXJzZURlY2ltYWwoeDIsIHZhbHVlKTsKICAgICAgICAgIGVsc2UgdGhyb3cgRXJyb3IoaW52YWxpZEFyZ3VtZW50ICsgdmFsdWUpOwogICAgICAgIH0KICAgICAgICBEZWNpbWFsNC5wcm90b3R5cGUgPSBQOwogICAgICAgIERlY2ltYWw0LlJPVU5EX1VQID0gMDsKICAgICAgICBEZWNpbWFsNC5ST1VORF9ET1dOID0gMTsKICAgICAgICBEZWNpbWFsNC5ST1VORF9DRUlMID0gMjsKICAgICAgICBEZWNpbWFsNC5ST1VORF9GTE9PUiA9IDM7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfSEFMRl9VUCA9IDQ7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfSEFMRl9ET1dOID0gNTsKICAgICAgICBEZWNpbWFsNC5ST1VORF9IQUxGX0VWRU4gPSA2OwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfQ0VJTCA9IDc7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfSEFMRl9GTE9PUiA9IDg7CiAgICAgICAgRGVjaW1hbDQuY2xvbmUgPSBjbG9uZTsKICAgICAgICBEZWNpbWFsNC5jb25maWcgPSBEZWNpbWFsNC5zZXQgPSBjb25maWc7CiAgICAgICAgaWYgKG9iaiA9PT0gdm9pZCAwKSBvYmogPSB7fTsKICAgICAgICBpZiAob2JqKSB7CiAgICAgICAgICBwcyA9IFsicHJlY2lzaW9uIiwgInJvdW5kaW5nIiwgInRvRXhwTmVnIiwgInRvRXhwUG9zIiwgIkxOMTAiXTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwcy5sZW5ndGg7ICkgaWYgKCFvYmouaGFzT3duUHJvcGVydHkocCA9IHBzW2krK10pKSBvYmpbcF0gPSB0aGlzW3BdOwogICAgICAgIH0KICAgICAgICBEZWNpbWFsNC5jb25maWcob2JqKTsKICAgICAgICByZXR1cm4gRGVjaW1hbDQ7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY29uZmlnKG9iaikgewogICAgICAgIGlmICghb2JqIHx8IHR5cGVvZiBvYmogIT09ICJvYmplY3QiKSB7CiAgICAgICAgICB0aHJvdyBFcnJvcihkZWNpbWFsRXJyb3IgKyAiT2JqZWN0IGV4cGVjdGVkIik7CiAgICAgICAgfQogICAgICAgIHZhciBpLCBwLCB2LCBwcyA9IFsKICAgICAgICAgICJwcmVjaXNpb24iLAogICAgICAgICAgMSwKICAgICAgICAgIE1BWF9ESUdJVFMsCiAgICAgICAgICAicm91bmRpbmciLAogICAgICAgICAgMCwKICAgICAgICAgIDgsCiAgICAgICAgICAidG9FeHBOZWciLAogICAgICAgICAgLTEgLyAwLAogICAgICAgICAgMCwKICAgICAgICAgICJ0b0V4cFBvcyIsCiAgICAgICAgICAwLAogICAgICAgICAgMSAvIDAKICAgICAgICBdOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBwcy5sZW5ndGg7IGkgKz0gMykgewogICAgICAgICAgaWYgKCh2ID0gb2JqW3AgPSBwc1tpXV0pICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKG1hdGhmbG9vcih2KSA9PT0gdiAmJiB2ID49IHBzW2kgKyAxXSAmJiB2IDw9IHBzW2kgKyAyXSkgdGhpc1twXSA9IHY7CiAgICAgICAgICAgIGVsc2UgdGhyb3cgRXJyb3IoaW52YWxpZEFyZ3VtZW50ICsgcCArICI6ICIgKyB2KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCh2ID0gb2JqW3AgPSAiTE4xMCJdKSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBpZiAodiA9PSBNYXRoLkxOMTApIHRoaXNbcF0gPSBuZXcgdGhpcyh2KTsKICAgICAgICAgIGVsc2UgdGhyb3cgRXJyb3IoaW52YWxpZEFyZ3VtZW50ICsgcCArICI6ICIgKyB2KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgRGVjaW1hbDMgPSBjbG9uZShEZWNpbWFsMyk7CiAgICAgIERlY2ltYWwzWyJkZWZhdWx0Il0gPSBEZWNpbWFsMy5EZWNpbWFsID0gRGVjaW1hbDM7CiAgICAgIE9ORSA9IG5ldyBEZWNpbWFsMygxKTsKICAgICAgaWYgKHR5cGVvZiBkZWZpbmUgPT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSB7CiAgICAgICAgZGVmaW5lKGZ1bmN0aW9uKCkgewogICAgICAgICAgcmV0dXJuIERlY2ltYWwzOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBtb2R1bGUgIT0gInVuZGVmaW5lZCIgJiYgbW9kdWxlLmV4cG9ydHMpIHsKICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IERlY2ltYWwzOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghZ2xvYmFsU2NvcGUpIHsKICAgICAgICAgIGdsb2JhbFNjb3BlID0gdHlwZW9mIHNlbGYgIT0gInVuZGVmaW5lZCIgJiYgc2VsZiAmJiBzZWxmLnNlbGYgPT0gc2VsZiA/IHNlbGYgOiBGdW5jdGlvbigicmV0dXJuIHRoaXMiKSgpOwogICAgICAgIH0KICAgICAgICBnbG9iYWxTY29wZS5EZWNpbWFsID0gRGVjaW1hbDM7CiAgICAgIH0KICAgIH0pKGV4cG9ydHMpOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXZlbnRlbWl0dGVyMy9pbmRleC5qcwp2YXIgcmVxdWlyZV9ldmVudGVtaXR0ZXIzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9ldmVudGVtaXR0ZXIzL2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIHZhciBoYXMzID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgIHZhciBwcmVmaXggPSAifiI7CiAgICBmdW5jdGlvbiBFdmVudHMoKSB7CiAgICB9CiAgICBpZiAoT2JqZWN0LmNyZWF0ZSkgewogICAgICBFdmVudHMucHJvdG90eXBlID0gLyogQF9fUFVSRV9fICovIE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIGlmICghbmV3IEV2ZW50cygpLl9fcHJvdG9fXykgcHJlZml4ID0gZmFsc2U7CiAgICB9CiAgICBmdW5jdGlvbiBFRShmbiwgY29udGV4dCwgb25jZSkgewogICAgICB0aGlzLmZuID0gZm47CiAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgIHRoaXMub25jZSA9IG9uY2UgfHwgZmFsc2U7CiAgICB9CiAgICBmdW5jdGlvbiBhZGRMaXN0ZW5lcjIoZW1pdHRlciwgZXZlbnQsIGZuLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgIGlmICh0eXBlb2YgZm4gIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJUaGUgbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICAgIH0KICAgICAgdmFyIGxpc3RlbmVyMiA9IG5ldyBFRShmbiwgY29udGV4dCB8fCBlbWl0dGVyLCBvbmNlKSwgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDsKICAgICAgaWYgKCFlbWl0dGVyLl9ldmVudHNbZXZ0XSkgZW1pdHRlci5fZXZlbnRzW2V2dF0gPSBsaXN0ZW5lcjIsIGVtaXR0ZXIuX2V2ZW50c0NvdW50Kys7CiAgICAgIGVsc2UgaWYgKCFlbWl0dGVyLl9ldmVudHNbZXZ0XS5mbikgZW1pdHRlci5fZXZlbnRzW2V2dF0ucHVzaChsaXN0ZW5lcjIpOwogICAgICBlbHNlIGVtaXR0ZXIuX2V2ZW50c1tldnRdID0gW2VtaXR0ZXIuX2V2ZW50c1tldnRdLCBsaXN0ZW5lcjJdOwogICAgICByZXR1cm4gZW1pdHRlcjsKICAgIH0KICAgIGZ1bmN0aW9uIGNsZWFyRXZlbnQoZW1pdHRlciwgZXZ0KSB7CiAgICAgIGlmICgtLWVtaXR0ZXIuX2V2ZW50c0NvdW50ID09PSAwKSBlbWl0dGVyLl9ldmVudHMgPSBuZXcgRXZlbnRzKCk7CiAgICAgIGVsc2UgZGVsZXRlIGVtaXR0ZXIuX2V2ZW50c1tldnRdOwogICAgfQogICAgZnVuY3Rpb24gRXZlbnRFbWl0dGVyMigpIHsKICAgICAgdGhpcy5fZXZlbnRzID0gbmV3IEV2ZW50cygpOwogICAgICB0aGlzLl9ldmVudHNDb3VudCA9IDA7CiAgICB9CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5ldmVudE5hbWVzID0gZnVuY3Rpb24gZXZlbnROYW1lcygpIHsKICAgICAgdmFyIG5hbWVzID0gW10sIGV2ZW50cywgbmFtZTsKICAgICAgaWYgKHRoaXMuX2V2ZW50c0NvdW50ID09PSAwKSByZXR1cm4gbmFtZXM7CiAgICAgIGZvciAobmFtZSBpbiBldmVudHMgPSB0aGlzLl9ldmVudHMpIHsKICAgICAgICBpZiAoaGFzMy5jYWxsKGV2ZW50cywgbmFtZSkpIG5hbWVzLnB1c2gocHJlZml4ID8gbmFtZS5zbGljZSgxKSA6IG5hbWUpOwogICAgICB9CiAgICAgIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICAgICAgcmV0dXJuIG5hbWVzLmNvbmNhdChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGV2ZW50cykpOwogICAgICB9CiAgICAgIHJldHVybiBuYW1lczsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5saXN0ZW5lcnMgPSBmdW5jdGlvbiBsaXN0ZW5lcnMoZXZlbnQpIHsKICAgICAgdmFyIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQsIGhhbmRsZXJzID0gdGhpcy5fZXZlbnRzW2V2dF07CiAgICAgIGlmICghaGFuZGxlcnMpIHJldHVybiBbXTsKICAgICAgaWYgKGhhbmRsZXJzLmZuKSByZXR1cm4gW2hhbmRsZXJzLmZuXTsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBoYW5kbGVycy5sZW5ndGgsIGVlID0gbmV3IEFycmF5KGwpOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgZWVbaV0gPSBoYW5kbGVyc1tpXS5mbjsKICAgICAgfQogICAgICByZXR1cm4gZWU7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uIGxpc3RlbmVyQ291bnQoZXZlbnQpIHsKICAgICAgdmFyIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQsIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1tldnRdOwogICAgICBpZiAoIWxpc3RlbmVycykgcmV0dXJuIDA7CiAgICAgIGlmIChsaXN0ZW5lcnMuZm4pIHJldHVybiAxOwogICAgICByZXR1cm4gbGlzdGVuZXJzLmxlbmd0aDsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5lbWl0ID0gZnVuY3Rpb24gZW1pdChldmVudCwgYTEsIGEyLCBhMywgYTQsIGE1KSB7CiAgICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50OwogICAgICBpZiAoIXRoaXMuX2V2ZW50c1tldnRdKSByZXR1cm4gZmFsc2U7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbZXZ0XSwgbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncywgaTsKICAgICAgaWYgKGxpc3RlbmVycy5mbikgewogICAgICAgIGlmIChsaXN0ZW5lcnMub25jZSkgdGhpcy5yZW1vdmVMaXN0ZW5lcihldmVudCwgbGlzdGVuZXJzLmZuLCB2b2lkIDAsIHRydWUpOwogICAgICAgIHN3aXRjaCAobGVuKSB7CiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCksIHRydWU7CiAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEpLCB0cnVlOwogICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiksIHRydWU7CiAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEsIGEyLCBhMyksIHRydWU7CiAgICAgICAgICBjYXNlIDU6CiAgICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnMuZm4uY2FsbChsaXN0ZW5lcnMuY29udGV4dCwgYTEsIGEyLCBhMywgYTQpLCB0cnVlOwogICAgICAgICAgY2FzZSA2OgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMsIGE0LCBhNSksIHRydWU7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDEsIGFyZ3MgPSBuZXcgQXJyYXkobGVuIC0gMSk7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgYXJnc1tpIC0gMV0gPSBhcmd1bWVudHNbaV07CiAgICAgICAgfQogICAgICAgIGxpc3RlbmVycy5mbi5hcHBseShsaXN0ZW5lcnMuY29udGV4dCwgYXJncyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGxlbmd0aCA9IGxpc3RlbmVycy5sZW5ndGgsIGo7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAobGlzdGVuZXJzW2ldLm9uY2UpIHRoaXMucmVtb3ZlTGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVyc1tpXS5mbiwgdm9pZCAwLCB0cnVlKTsKICAgICAgICAgIHN3aXRjaCAobGVuKSB7CiAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICBsaXN0ZW5lcnNbaV0uZm4uY2FsbChsaXN0ZW5lcnNbaV0uY29udGV4dCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICBsaXN0ZW5lcnNbaV0uZm4uY2FsbChsaXN0ZW5lcnNbaV0uY29udGV4dCwgYTEpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExLCBhMik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgNDoKICAgICAgICAgICAgICBsaXN0ZW5lcnNbaV0uZm4uY2FsbChsaXN0ZW5lcnNbaV0uY29udGV4dCwgYTEsIGEyLCBhMyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgaWYgKCFhcmdzKSBmb3IgKGogPSAxLCBhcmdzID0gbmV3IEFycmF5KGxlbiAtIDEpOyBqIDwgbGVuOyBqKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbaiAtIDFdID0gYXJndW1lbnRzW2pdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsaXN0ZW5lcnNbaV0uZm4uYXBwbHkobGlzdGVuZXJzW2ldLmNvbnRleHQsIGFyZ3MpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uIG9uKGV2ZW50LCBmbiwgY29udGV4dCkgewogICAgICByZXR1cm4gYWRkTGlzdGVuZXIyKHRoaXMsIGV2ZW50LCBmbiwgY29udGV4dCwgZmFsc2UpOwogICAgfTsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbiBvbmNlKGV2ZW50LCBmbiwgY29udGV4dCkgewogICAgICByZXR1cm4gYWRkTGlzdGVuZXIyKHRoaXMsIGV2ZW50LCBmbiwgY29udGV4dCwgdHJ1ZSk7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUucmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcjIoZXZlbnQsIGZuLCBjb250ZXh0LCBvbmNlKSB7CiAgICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50OwogICAgICBpZiAoIXRoaXMuX2V2ZW50c1tldnRdKSByZXR1cm4gdGhpczsKICAgICAgaWYgKCFmbikgewogICAgICAgIGNsZWFyRXZlbnQodGhpcywgZXZ0KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2dF07CiAgICAgIGlmIChsaXN0ZW5lcnMuZm4pIHsKICAgICAgICBpZiAobGlzdGVuZXJzLmZuID09PSBmbiAmJiAoIW9uY2UgfHwgbGlzdGVuZXJzLm9uY2UpICYmICghY29udGV4dCB8fCBsaXN0ZW5lcnMuY29udGV4dCA9PT0gY29udGV4dCkpIHsKICAgICAgICAgIGNsZWFyRXZlbnQodGhpcywgZXZ0KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGV2ZW50cyA9IFtdLCBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChsaXN0ZW5lcnNbaV0uZm4gIT09IGZuIHx8IG9uY2UgJiYgIWxpc3RlbmVyc1tpXS5vbmNlIHx8IGNvbnRleHQgJiYgbGlzdGVuZXJzW2ldLmNvbnRleHQgIT09IGNvbnRleHQpIHsKICAgICAgICAgICAgZXZlbnRzLnB1c2gobGlzdGVuZXJzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGV2ZW50cy5sZW5ndGgpIHRoaXMuX2V2ZW50c1tldnRdID0gZXZlbnRzLmxlbmd0aCA9PT0gMSA/IGV2ZW50c1swXSA6IGV2ZW50czsKICAgICAgICBlbHNlIGNsZWFyRXZlbnQodGhpcywgZXZ0KTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBmdW5jdGlvbiByZW1vdmVBbGxMaXN0ZW5lcnMoZXZlbnQpIHsKICAgICAgdmFyIGV2dDsKICAgICAgaWYgKGV2ZW50KSB7CiAgICAgICAgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDsKICAgICAgICBpZiAodGhpcy5fZXZlbnRzW2V2dF0pIGNsZWFyRXZlbnQodGhpcywgZXZ0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9ldmVudHMgPSBuZXcgRXZlbnRzKCk7CiAgICAgICAgdGhpcy5fZXZlbnRzQ291bnQgPSAwOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfTsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLm9mZiA9IEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyOwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUuYWRkTGlzdGVuZXIgPSBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5vbjsKICAgIEV2ZW50RW1pdHRlcjIucHJlZml4ZWQgPSBwcmVmaXg7CiAgICBFdmVudEVtaXR0ZXIyLkV2ZW50RW1pdHRlciA9IEV2ZW50RW1pdHRlcjI7CiAgICBpZiAoInVuZGVmaW5lZCIgIT09IHR5cGVvZiBtb2R1bGUpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBFdmVudEVtaXR0ZXIyOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L2xhc3QuanMKdmFyIHJlcXVpcmVfbGFzdCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L2xhc3QuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gbGFzdDIoYXJyKSB7CiAgICAgIHJldHVybiBhcnJbYXJyLmxlbmd0aCAtIDFdOwogICAgfQogICAgZXhwb3J0cy5sYXN0ID0gbGFzdDI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC90b0FycmF5LmpzCnZhciByZXF1aXJlX3RvQXJyYXkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL3RvQXJyYXkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gdG9BcnJheSh2YWx1ZSkgewogICAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZSkgPyB2YWx1ZSA6IEFycmF5LmZyb20odmFsdWUpOwogICAgfQogICAgZXhwb3J0cy50b0FycmF5ID0gdG9BcnJheTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvbGFzdC5qcwp2YXIgcmVxdWlyZV9sYXN0MiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9sYXN0LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBsYXN0JDEgPSByZXF1aXJlX2xhc3QoKTsKICAgIHZhciB0b0FycmF5ID0gcmVxdWlyZV90b0FycmF5KCk7CiAgICB2YXIgaXNBcnJheUxpa2UgPSByZXF1aXJlX2lzQXJyYXlMaWtlKCk7CiAgICBmdW5jdGlvbiBsYXN0MihhcnJheSkgewogICAgICBpZiAoIWlzQXJyYXlMaWtlLmlzQXJyYXlMaWtlKGFycmF5KSkgewogICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgIH0KICAgICAgcmV0dXJuIGxhc3QkMS5sYXN0KHRvQXJyYXkudG9BcnJheShhcnJheSkpOwogICAgfQogICAgZXhwb3J0cy5sYXN0ID0gbGFzdDI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9sYXN0LmpzCnZhciByZXF1aXJlX2xhc3QzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9sYXN0LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9sYXN0MigpLmxhc3Q7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV91c2Vfc3luY19leHRlcm5hbF9zdG9yZV93aXRoX3NlbGVjdG9yX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgKGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiBpczQoeDIsIHkyKSB7CiAgICAgICAgcmV0dXJuIHgyID09PSB5MiAmJiAoMCAhPT0geDIgfHwgMSAvIHgyID09PSAxIC8geTIpIHx8IHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgICAgIH0KICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgJiYgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChFcnJvcigpKTsKICAgICAgdmFyIFJlYWN0MzggPSByZXF1aXJlX3JlYWN0KCksIG9iamVjdElzID0gImZ1bmN0aW9uIiA9PT0gdHlwZW9mIE9iamVjdC5pcyA/IE9iamVjdC5pcyA6IGlzNCwgdXNlU3luY0V4dGVybmFsU3RvcmUyID0gUmVhY3QzOC51c2VTeW5jRXh0ZXJuYWxTdG9yZSwgdXNlUmVmMTYgPSBSZWFjdDM4LnVzZVJlZiwgdXNlRWZmZWN0MTQgPSBSZWFjdDM4LnVzZUVmZmVjdCwgdXNlTWVtbzkgPSBSZWFjdDM4LnVzZU1lbW8sIHVzZURlYnVnVmFsdWUyID0gUmVhY3QzOC51c2VEZWJ1Z1ZhbHVlOwogICAgICBleHBvcnRzLnVzZVN5bmNFeHRlcm5hbFN0b3JlV2l0aFNlbGVjdG9yID0gZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QsIHNlbGVjdG9yLCBpc0VxdWFsKSB7CiAgICAgICAgdmFyIGluc3RSZWYgPSB1c2VSZWYxNihudWxsKTsKICAgICAgICBpZiAobnVsbCA9PT0gaW5zdFJlZi5jdXJyZW50KSB7CiAgICAgICAgICB2YXIgaW5zdCA9IHsgaGFzVmFsdWU6IGZhbHNlLCB2YWx1ZTogbnVsbCB9OwogICAgICAgICAgaW5zdFJlZi5jdXJyZW50ID0gaW5zdDsKICAgICAgICB9IGVsc2UgaW5zdCA9IGluc3RSZWYuY3VycmVudDsKICAgICAgICBpbnN0UmVmID0gdXNlTWVtbzkoCiAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZnVuY3Rpb24gbWVtb2l6ZWRTZWxlY3RvcihuZXh0U25hcHNob3QpIHsKICAgICAgICAgICAgICBpZiAoIWhhc01lbW8pIHsKICAgICAgICAgICAgICAgIGhhc01lbW8gPSB0cnVlOwogICAgICAgICAgICAgICAgbWVtb2l6ZWRTbmFwc2hvdCA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgICAgIG5leHRTbmFwc2hvdCA9IHNlbGVjdG9yKG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBpc0VxdWFsICYmIGluc3QuaGFzVmFsdWUpIHsKICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRTZWxlY3Rpb24gPSBpbnN0LnZhbHVlOwogICAgICAgICAgICAgICAgICBpZiAoaXNFcXVhbChjdXJyZW50U2VsZWN0aW9uLCBuZXh0U25hcHNob3QpKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3Rpb24gPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRTZWxlY3Rpb24gPSBtZW1vaXplZFNlbGVjdGlvbjsKICAgICAgICAgICAgICBpZiAob2JqZWN0SXMobWVtb2l6ZWRTbmFwc2hvdCwgbmV4dFNuYXBzaG90KSkKICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICAgIHZhciBuZXh0U2VsZWN0aW9uID0gc2VsZWN0b3IobmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgICBpZiAodm9pZCAwICE9PSBpc0VxdWFsICYmIGlzRXF1YWwoY3VycmVudFNlbGVjdGlvbiwgbmV4dFNlbGVjdGlvbikpCiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTbmFwc2hvdCA9IG5leHRTbmFwc2hvdCwgY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgICBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IG5leHRTZWxlY3Rpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhhc01lbW8gPSBmYWxzZSwgbWVtb2l6ZWRTbmFwc2hvdCwgbWVtb2l6ZWRTZWxlY3Rpb24sIG1heWJlR2V0U2VydmVyU25hcHNob3QgPSB2b2lkIDAgPT09IGdldFNlcnZlclNuYXBzaG90ID8gbnVsbCA6IGdldFNlcnZlclNuYXBzaG90OwogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0b3IoZ2V0U25hcHNob3QoKSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBudWxsID09PSBtYXliZUdldFNlcnZlclNuYXBzaG90ID8gdm9pZCAwIDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3RvcihtYXliZUdldFNlcnZlclNuYXBzaG90KCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgXTsKICAgICAgICAgIH0sCiAgICAgICAgICBbZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90LCBzZWxlY3RvciwgaXNFcXVhbF0KICAgICAgICApOwogICAgICAgIHZhciB2YWx1ZSA9IHVzZVN5bmNFeHRlcm5hbFN0b3JlMihzdWJzY3JpYmUsIGluc3RSZWZbMF0sIGluc3RSZWZbMV0pOwogICAgICAgIHVzZUVmZmVjdDE0KAogICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGluc3QuaGFzVmFsdWUgPSB0cnVlOwogICAgICAgICAgICBpbnN0LnZhbHVlID0gdmFsdWU7CiAgICAgICAgICB9LAogICAgICAgICAgW3ZhbHVlXQogICAgICAgICk7CiAgICAgICAgdXNlRGVidWdWYWx1ZTIodmFsdWUpOwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfTsKICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCAmJiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AoRXJyb3IoKSk7CiAgICB9KSgpOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvd2l0aC1zZWxlY3Rvci5qcwp2YXIgcmVxdWlyZV93aXRoX3NlbGVjdG9yMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvd2l0aC1zZWxlY3Rvci5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3VzZV9zeW5jX2V4dGVybmFsX3N0b3JlX3dpdGhfc2VsZWN0b3JfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0L2Nqcy9yZWFjdC1qc3gtcnVudGltZS5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV9yZWFjdF9qc3hfcnVudGltZV9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIHZhciBSZWFjdDM4ID0gcmVxdWlyZV9yZWFjdCgpOwogICAgICAgIHZhciBSRUFDVF9FTEVNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5lbGVtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1BPUlRBTF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucG9ydGFsIik7CiAgICAgICAgdmFyIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mcmFnbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3RyaWN0X21vZGUiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPRklMRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb2ZpbGVyIik7CiAgICAgICAgdmFyIFJFQUNUX1BST1ZJREVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm92aWRlciIpOwogICAgICAgIHZhciBSRUFDVF9DT05URVhUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jb250ZXh0Iik7CiAgICAgICAgdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0Lm1lbW8iKTsKICAgICAgICB2YXIgUkVBQ1RfTEFaWV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubGF6eSIpOwogICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgIHZhciBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgPSBTeW1ib2wuaXRlcmF0b3I7CiAgICAgICAgdmFyIEZBVVhfSVRFUkFUT1JfU1lNQk9MID0gIkBAaXRlcmF0b3IiOwogICAgICAgIGZ1bmN0aW9uIGdldEl0ZXJhdG9yRm4obWF5YmVJdGVyYWJsZSkgewogICAgICAgICAgaWYgKG1heWJlSXRlcmFibGUgPT09IG51bGwgfHwgdHlwZW9mIG1heWJlSXRlcmFibGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1heWJlSXRlcmF0b3IgPSBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgJiYgbWF5YmVJdGVyYWJsZVtNQVlCRV9JVEVSQVRPUl9TWU1CT0xdIHx8IG1heWJlSXRlcmFibGVbRkFVWF9JVEVSQVRPUl9TWU1CT0xdOwogICAgICAgICAgaWYgKHR5cGVvZiBtYXliZUl0ZXJhdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBtYXliZUl0ZXJhdG9yOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdFNoYXJlZEludGVybmFscyA9IFJlYWN0MzguX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CiAgICAgICAgZnVuY3Rpb24gZXJyb3IoZm9ybWF0MikgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4yID4gMSA/IF9sZW4yIC0gMSA6IDApLCBfa2V5MiA9IDE7IF9rZXkyIDwgX2xlbjI7IF9rZXkyKyspIHsKICAgICAgICAgICAgICAgIGFyZ3NbX2tleTIgLSAxXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygiZXJyb3IiLCBmb3JtYXQyLCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmludFdhcm5pbmcobGV2ZWwsIGZvcm1hdDIsIGFyZ3MpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICAgICAgdmFyIHN0YWNrID0gUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIuZ2V0U3RhY2tBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoc3RhY2sgIT09ICIiKSB7CiAgICAgICAgICAgICAgZm9ybWF0MiArPSAiJXMiOwogICAgICAgICAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbc3RhY2tdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYXJnc1dpdGhGb3JtYXQgPSBhcmdzLm1hcChmdW5jdGlvbihpdGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhpdGVtKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGFyZ3NXaXRoRm9ybWF0LnVuc2hpZnQoIldhcm5pbmc6ICIgKyBmb3JtYXQyKTsKICAgICAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZVtsZXZlbF0sIGNvbnNvbGUsIGFyZ3NXaXRoRm9ybWF0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGVuYWJsZVNjb3BlQVBJID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUNhY2hlRWxlbWVudCA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVUcmFuc2l0aW9uVHJhY2luZyA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMZWdhY3lIaWRkZW4gPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlRGVidWdUcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIFJFQUNUX01PRFVMRV9SRUZFUkVOQ0U7CiAgICAgICAgewogICAgICAgICAgUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm1vZHVsZS5yZWZlcmVuY2UiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUpIHsKICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9QUk9GSUxFUl9UWVBFIHx8IGVuYWJsZURlYnVnVHJhY2luZyB8fCB0eXBlID09PSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1NVU1BFTlNFX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFIHx8IGVuYWJsZUxlZ2FjeUhpZGRlbiB8fCB0eXBlID09PSBSRUFDVF9PRkZTQ1JFRU5fVFlQRSB8fCBlbmFibGVTY29wZUFQSSB8fCBlbmFibGVDYWNoZUVsZW1lbnQgfHwgZW5hYmxlVHJhbnNpdGlvblRyYWNpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX1BST1ZJREVSX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfQ09OVEVYVF9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyIHx8IC8vIFRoaXMgbmVlZHMgdG8gaW5jbHVkZSBhbGwgcG9zc2libGUgbW9kdWxlIHJlZmVyZW5jZSBvYmplY3QKICAgICAgICAgICAgLy8gdHlwZXMgc3VwcG9ydGVkIGJ5IGFueSBGbGlnaHQgY29uZmlndXJhdGlvbiBhbnl3aGVyZSBzaW5jZQogICAgICAgICAgICAvLyB3ZSBkb24ndCBrbm93IHdoaWNoIEZsaWdodCBidWlsZCB0aGlzIHdpbGwgZW5kIHVwIGJlaW5nIHVzZWQKICAgICAgICAgICAgLy8gd2l0aC4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTU9EVUxFX1JFRkVSRU5DRSB8fCB0eXBlLmdldE1vZHVsZUlkICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZShvdXRlclR5cGUsIGlubmVyVHlwZSwgd3JhcHBlck5hbWUpIHsKICAgICAgICAgIHZhciBkaXNwbGF5TmFtZSA9IG91dGVyVHlwZS5kaXNwbGF5TmFtZTsKICAgICAgICAgIGlmIChkaXNwbGF5TmFtZSkgewogICAgICAgICAgICByZXR1cm4gZGlzcGxheU5hbWU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnVuY3Rpb25OYW1lID0gaW5uZXJUeXBlLmRpc3BsYXlOYW1lIHx8IGlubmVyVHlwZS5uYW1lIHx8ICIiOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb250ZXh0TmFtZSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUudGFnID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIGVycm9yKCJSZWNlaXZlZCBhbiB1bmV4cGVjdGVkIG9iamVjdCBpbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoKS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfRlJBR01FTlRfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIkZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlBvcnRhbCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPRklMRVJfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdHlwZTsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZShjb250ZXh0KSArICIuQ29uc3VtZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUFJPVklERVJfVFlQRToKICAgICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBnZXRXcmFwcGVkTmFtZSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICB2YXIgb3V0ZXJOYW1lID0gdHlwZS5kaXNwbGF5TmFtZSB8fCBudWxsOwogICAgICAgICAgICAgICAgaWYgKG91dGVyTmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gb3V0ZXJOYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJNZW1vIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShpbml0KHBheWxvYWQpKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBhc3NpZ24yID0gT2JqZWN0LmFzc2lnbjsKICAgICAgICB2YXIgZGlzYWJsZWREZXB0aCA9IDA7CiAgICAgICAgdmFyIHByZXZMb2c7CiAgICAgICAgdmFyIHByZXZJbmZvOwogICAgICAgIHZhciBwcmV2V2FybjsKICAgICAgICB2YXIgcHJldkVycm9yOwogICAgICAgIHZhciBwcmV2R3JvdXA7CiAgICAgICAgdmFyIHByZXZHcm91cENvbGxhcHNlZDsKICAgICAgICB2YXIgcHJldkdyb3VwRW5kOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVkTG9nKCkgewogICAgICAgIH0KICAgICAgICBkaXNhYmxlZExvZy5fX3JlYWN0RGlzYWJsZWRMb2cgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHByZXZMb2cgPSBjb25zb2xlLmxvZzsKICAgICAgICAgICAgICBwcmV2SW5mbyA9IGNvbnNvbGUuaW5mbzsKICAgICAgICAgICAgICBwcmV2V2FybiA9IGNvbnNvbGUud2FybjsKICAgICAgICAgICAgICBwcmV2RXJyb3IgPSBjb25zb2xlLmVycm9yOwogICAgICAgICAgICAgIHByZXZHcm91cCA9IGNvbnNvbGUuZ3JvdXA7CiAgICAgICAgICAgICAgcHJldkdyb3VwQ29sbGFwc2VkID0gY29uc29sZS5ncm91cENvbGxhcHNlZDsKICAgICAgICAgICAgICBwcmV2R3JvdXBFbmQgPSBjb25zb2xlLmdyb3VwRW5kOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZGlzYWJsZWRMb2csCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgaW5mbzogcHJvcHMsCiAgICAgICAgICAgICAgICBsb2c6IHByb3BzLAogICAgICAgICAgICAgICAgd2FybjogcHJvcHMsCiAgICAgICAgICAgICAgICBlcnJvcjogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cEVuZDogcHJvcHMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaXNhYmxlZERlcHRoKys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZW5hYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlzYWJsZWREZXB0aC0tOwogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgbG9nOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkxvZwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBpbmZvOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkluZm8KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgd2FybjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZXYXJuCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGVycm9yOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkVycm9yCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwQ29sbGFwc2VkCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwRW5kCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoIDwgMCkgewogICAgICAgICAgICAgIGVycm9yKCJkaXNhYmxlZERlcHRoIGZlbGwgYmVsb3cgemVyby4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyOwogICAgICAgIHZhciBwcmVmaXg7CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcmVmaXggPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSB4Mi5zdGFjay50cmltKCkubWF0Y2goL1xuKCAqKGF0ICk/KS8pOwogICAgICAgICAgICAgICAgcHJlZml4ID0gbWF0Y2ggJiYgbWF0Y2hbMV0gfHwgIiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiXG4iICsgcHJlZml4ICsgbmFtZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHJlZW50cnkgPSBmYWxzZTsKICAgICAgICB2YXIgY29tcG9uZW50RnJhbWVDYWNoZTsKICAgICAgICB7CiAgICAgICAgICB2YXIgUG9zc2libHlXZWFrTWFwID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZSA9IG5ldyBQb3NzaWJseVdlYWtNYXAoKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgY29uc3RydWN0KSB7CiAgICAgICAgICBpZiAoIWZuIHx8IHJlZW50cnkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgZnJhbWUgPSBjb21wb25lbnRGcmFtZUNhY2hlLmdldChmbik7CiAgICAgICAgICAgIGlmIChmcmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udHJvbDsKICAgICAgICAgIHJlZW50cnkgPSB0cnVlOwogICAgICAgICAgdmFyIHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2UgPSBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gdm9pZCAwOwogICAgICAgICAgdmFyIHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgcHJldmlvdXNEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50OwogICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICBkaXNhYmxlTG9ncygpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGNvbnN0cnVjdCkgewogICAgICAgICAgICAgIHZhciBGYWtlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEZha2UucHJvdG90eXBlLCAicHJvcHMiLCB7CiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gIm9iamVjdCIgJiYgUmVmbGVjdC5jb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KEZha2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KGZuLCBbXSwgRmFrZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIEZha2UuY2FsbCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm4uY2FsbChGYWtlLnByb3RvdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKHNhbXBsZSkgewogICAgICAgICAgICBpZiAoc2FtcGxlICYmIGNvbnRyb2wgJiYgdHlwZW9mIHNhbXBsZS5zdGFjayA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICB2YXIgc2FtcGxlTGluZXMgPSBzYW1wbGUuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIGNvbnRyb2xMaW5lcyA9IGNvbnRyb2wuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIHMgPSBzYW1wbGVMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHZhciBjID0gY29udHJvbExpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgd2hpbGUgKHMgPj0gMSAmJiBjID49IDAgJiYgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKDsgcyA+PSAxICYmIGMgPj0gMDsgcy0tLCBjLS0pIHsKICAgICAgICAgICAgICAgIGlmIChzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzICE9PSAxIHx8IGMgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICBzLS07CiAgICAgICAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYyA8IDAgfHwgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2ZyYW1lID0gIlxuIiArIHNhbXBsZUxpbmVzW3NdLnJlcGxhY2UoIiBhdCBuZXcgIiwgIiBhdCAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuLmRpc3BsYXlOYW1lICYmIF9mcmFtZS5pbmNsdWRlcygiPGFub255bW91cz4iKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIF9mcmFtZSA9IF9mcmFtZS5yZXBsYWNlKCI8YW5vbnltb3VzPiIsIGZuLmRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIF9mcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyLmN1cnJlbnQgPSBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICAgICAgcmVlbmFibGVMb2dzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBmbiA/IGZuLmRpc3BsYXlOYW1lIHx8IGZuLm5hbWUgOiAiIjsKICAgICAgICAgIHZhciBzeW50aGV0aWNGcmFtZSA9IG5hbWUgPyBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lKSA6ICIiOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIHN5bnRoZXRpY0ZyYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHN5bnRoZXRpY0ZyYW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZm4sIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShmbiwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDb25zdHJ1Y3QoQ29tcG9uZW50KSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZSwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICBpZiAodHlwZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUodHlwZSwgc2hvdWxkQ29uc3RydWN0KHR5cGUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2UiKTsKICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZUxpc3QiKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUodHlwZS5yZW5kZXIpOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFMjoKICAgICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYodHlwZS50eXBlLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IHR5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGluaXQocGF5bG9hZCksIHNvdXJjZSwgb3duZXJGbik7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgICAgIHZhciBsb2dnZWRUeXBlRmFpbHVyZXMgPSB7fTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuc2V0RXh0cmFTdGFja0ZyYW1lKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFR5cGVzKHR5cGVTcGVjcywgdmFsdWVzLCBsb2NhdGlvbiwgY29tcG9uZW50TmFtZSwgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzMyA9IEZ1bmN0aW9uLmNhbGwuYmluZChoYXNPd25Qcm9wZXJ0eSk7CiAgICAgICAgICAgIGZvciAodmFyIHR5cGVTcGVjTmFtZSBpbiB0eXBlU3BlY3MpIHsKICAgICAgICAgICAgICBpZiAoaGFzMyh0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBFcnJvcigoY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiKSArICI6ICIgKyBsb2NhdGlvbiArICIgdHlwZSBgIiArIHR5cGVTcGVjTmFtZSArICJgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tIHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZSwgYnV0IHJlY2VpdmVkIGAiICsgdHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICsgImAuVGhpcyBvZnRlbiBoYXBwZW5zIGJlY2F1c2Ugb2YgdHlwb3Mgc3VjaCBhcyBgUHJvcFR5cGVzLmZ1bmN0aW9uYCBpbnN0ZWFkIG9mIGBQcm9wVHlwZXMuZnVuY2AuIik7CiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNBcnJheUltcGwgPSBBcnJheS5pc0FycmF5OwogICAgICAgIGZ1bmN0aW9uIGlzQXJyYXkyKGEpIHsKICAgICAgICAgIHJldHVybiBpc0FycmF5SW1wbChhKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHlwZU5hbWUodmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhc1RvU3RyaW5nVGFnID0gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wudG9TdHJpbmdUYWc7CiAgICAgICAgICAgIHZhciB0eXBlID0gaGFzVG9TdHJpbmdUYWcgJiYgdmFsdWVbU3ltYm9sLnRvU3RyaW5nVGFnXSB8fCB2YWx1ZS5jb25zdHJ1Y3Rvci5uYW1lIHx8ICJPYmplY3QiOwogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2lsbENvZXJjaW9uVGhyb3codmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgcmV0dXJuICIiICsgdmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQga2V5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCB0eXBlTmFtZSh2YWx1ZSkpOwogICAgICAgICAgICAgIHJldHVybiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnRPd25lciA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBSRVNFUlZFRF9QUk9QUyA9IHsKICAgICAgICAgIGtleTogdHJ1ZSwKICAgICAgICAgIHJlZjogdHJ1ZSwKICAgICAgICAgIF9fc2VsZjogdHJ1ZSwKICAgICAgICAgIF9fc291cmNlOiB0cnVlCiAgICAgICAgfTsKICAgICAgICB2YXIgc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd247CiAgICAgICAgdmFyIHNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnMgPSB7fTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRSZWYoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgInJlZiIpKSB7CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAicmVmIikuZ2V0OwogICAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29uZmlnLnJlZiAhPT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNWYWxpZEtleShjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCAia2V5IikpIHsKICAgICAgICAgICAgICB2YXIgZ2V0dGVyID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjb25maWcsICJrZXkiKS5nZXQ7CiAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb25maWcua2V5ICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlN0cmluZ1JlZkNhbm5vdEJlQXV0b0NvbnZlcnRlZChjb25maWcsIHNlbGYyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY29uZmlnLnJlZiA9PT0gInN0cmluZyIgJiYgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCAmJiBzZWxmMiAmJiBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnN0YXRlTm9kZSAhPT0gc2VsZjIpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnR5cGUpOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0U3RyaW5nUmVmc1tjb21wb25lbnROYW1lXSkgewogICAgICAgICAgICAgICAgZXJyb3IoJ0NvbXBvbmVudCAiJXMiIGNvbnRhaW5zIHRoZSBzdHJpbmcgcmVmICIlcyIuIFN1cHBvcnQgZm9yIHN0cmluZyByZWZzIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBUaGlzIGNhc2UgY2Fubm90IGJlIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIGFuIGFycm93IGZ1bmN0aW9uLiBXZSBhc2sgeW91IHRvIG1hbnVhbGx5IGZpeCB0aGlzIGNhc2UgYnkgdXNpbmcgdXNlUmVmKCkgb3IgY3JlYXRlUmVmKCkgaW5zdGVhZC4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtc3RyaW5nLXJlZicsIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnR5cGUpLCBjb25maWcucmVmKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWZpbmVLZXlQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHdhcm5BYm91dEFjY2Vzc2luZ0tleSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmICghc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICAgIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogYGtleWAgaXMgbm90IGEgcHJvcC4gVHJ5aW5nIHRvIGFjY2VzcyBpdCB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBiZWluZyByZXR1cm5lZC4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzYW1lIHZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgcHJvcC4gKGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zcGVjaWFsLXByb3BzKSIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdhcm5BYm91dEFjY2Vzc2luZ0tleS5pc1JlYWN0V2FybmluZyA9IHRydWU7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgImtleSIsIHsKICAgICAgICAgICAgICBnZXQ6IHdhcm5BYm91dEFjY2Vzc2luZ0tleSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgd2FybkFib3V0QWNjZXNzaW5nUmVmID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93bikgewogICAgICAgICAgICAgICAgc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBgcmVmYCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGJlaW5nIHJldHVybmVkLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNhbWUgdmFsdWUgd2l0aGluIHRoZSBjaGlsZCBjb21wb25lbnQsIHlvdSBzaG91bGQgcGFzcyBpdCBhcyBhIGRpZmZlcmVudCBwcm9wLiAoaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NwZWNpYWwtcHJvcHMpIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgd2FybkFib3V0QWNjZXNzaW5nUmVmLmlzUmVhY3RXYXJuaW5nID0gdHJ1ZTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAicmVmIiwgewogICAgICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nUmVmLAogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0RWxlbWVudCA9IGZ1bmN0aW9uKHR5cGUsIGtleSwgcmVmLCBzZWxmMiwgc291cmNlLCBvd25lciwgcHJvcHMpIHsKICAgICAgICAgIHZhciBlbGVtZW50ID0gewogICAgICAgICAgICAvLyBUaGlzIHRhZyBhbGxvd3MgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IEVsZW1lbnQKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0VMRU1FTlRfVFlQRSwKICAgICAgICAgICAgLy8gQnVpbHQtaW4gcHJvcGVydGllcyB0aGF0IGJlbG9uZyBvbiB0aGUgZWxlbWVudAogICAgICAgICAgICB0eXBlLAogICAgICAgICAgICBrZXksCiAgICAgICAgICAgIHJlZiwKICAgICAgICAgICAgcHJvcHMsCiAgICAgICAgICAgIC8vIFJlY29yZCB0aGUgY29tcG9uZW50IHJlc3BvbnNpYmxlIGZvciBjcmVhdGluZyB0aGlzIGVsZW1lbnQuCiAgICAgICAgICAgIF9vd25lcjogb3duZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIGVsZW1lbnQuX3N0b3JlID0ge307CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50Ll9zdG9yZSwgInZhbGlkYXRlZCIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgICAgIHZhbHVlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQsICJfc2VsZiIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc2VsZjIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NvdXJjZSIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc291cmNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBqc3hERVYodHlwZSwgY29uZmlnLCBtYXliZUtleSwgc291cmNlLCBzZWxmMikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcHJvcE5hbWU7CiAgICAgICAgICAgIHZhciBwcm9wcyA9IHt9OwogICAgICAgICAgICB2YXIga2V5ID0gbnVsbDsKICAgICAgICAgICAgdmFyIHJlZiA9IG51bGw7CiAgICAgICAgICAgIGlmIChtYXliZUtleSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihtYXliZUtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGtleSA9ICIiICsgbWF5YmVLZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkS2V5KGNvbmZpZykpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGNvbmZpZy5rZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIGNvbmZpZy5rZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkUmVmKGNvbmZpZykpIHsKICAgICAgICAgICAgICByZWYgPSBjb25maWcucmVmOwogICAgICAgICAgICAgIHdhcm5JZlN0cmluZ1JlZkNhbm5vdEJlQXV0b0NvbnZlcnRlZChjb25maWcsIHNlbGYyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGNvbmZpZykgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgcHJvcE5hbWUpICYmICFSRVNFUlZFRF9QUk9QUy5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGNvbmZpZ1twcm9wTmFtZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlICYmIHR5cGUuZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IHR5cGUuZGVmYXVsdFByb3BzOwogICAgICAgICAgICAgIGZvciAocHJvcE5hbWUgaW4gZGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgICBpZiAocHJvcHNbcHJvcE5hbWVdID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGtleSB8fCByZWYpIHsKICAgICAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIiA/IHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8ICJVbmtub3duIiA6IHR5cGU7CiAgICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJlZikgewogICAgICAgICAgICAgICAgZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIFJlYWN0RWxlbWVudCh0eXBlLCBrZXksIHJlZiwgc2VsZjIsIHNvdXJjZSwgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudCwgcHJvcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudE93bmVyOwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShzdGFjayk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd247CiAgICAgICAgewogICAgICAgICAgcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24gPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWxpZEVsZW1lbnQxNShvYmplY3QpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBvYmplY3QgPT09ICJvYmplY3QiICYmIG9iamVjdCAhPT0gbnVsbCAmJiBvYmplY3QuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50KSB7CiAgICAgICAgICAgICAgdmFyIG5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50LnR5cGUpOwogICAgICAgICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiBgIiArIG5hbWUgKyAiYC4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtKHNvdXJjZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoc291cmNlICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgZmlsZU5hbWUgPSBzb3VyY2UuZmlsZU5hbWUucmVwbGFjZSgvXi4qW1xcXC9dLywgIiIpOwogICAgICAgICAgICAgIHZhciBsaW5lTnVtYmVyID0gc291cmNlLmxpbmVOdW1iZXI7CiAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgeW91ciBjb2RlIGF0ICIgKyBmaWxlTmFtZSArICI6IiArIGxpbmVOdW1iZXIgKyAiLiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgb3duZXJIYXNLZXlVc2VXYXJuaW5nID0ge307CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudENvbXBvbmVudEVycm9ySW5mbyhwYXJlbnRUeXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbmZvID0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICAgIGlmICghaW5mbykgewogICAgICAgICAgICAgIHZhciBwYXJlbnROYW1lID0gdHlwZW9mIHBhcmVudFR5cGUgPT09ICJzdHJpbmciID8gcGFyZW50VHlwZSA6IHBhcmVudFR5cGUuZGlzcGxheU5hbWUgfHwgcGFyZW50VHlwZS5uYW1lOwogICAgICAgICAgICAgIGlmIChwYXJlbnROYW1lKSB7CiAgICAgICAgICAgICAgICBpbmZvID0gIlxuXG5DaGVjayB0aGUgdG9wLWxldmVsIHJlbmRlciBjYWxsIHVzaW5nIDwiICsgcGFyZW50TmFtZSArICI+LiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpbmZvOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUV4cGxpY2l0S2V5KGVsZW1lbnQsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFlbGVtZW50Ll9zdG9yZSB8fCBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgfHwgZWxlbWVudC5rZXkgIT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbGVtZW50Ll9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICB2YXIgY3VycmVudENvbXBvbmVudEVycm9ySW5mbyA9IGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSk7CiAgICAgICAgICAgIGlmIChvd25lckhhc0tleVVzZVdhcm5pbmdbY3VycmVudENvbXBvbmVudEVycm9ySW5mb10pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGNoaWxkT3duZXIgPSAiIjsKICAgICAgICAgICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fb3duZXIgIT09IFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCkgewogICAgICAgICAgICAgIGNoaWxkT3duZXIgPSAiIEl0IHdhcyBwYXNzZWQgYSBjaGlsZCBmcm9tICIgKyBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoZWxlbWVudC5fb3duZXIudHlwZSkgKyAiLiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShlbGVtZW50KTsKICAgICAgICAgICAgZXJyb3IoJ0VhY2ggY2hpbGQgaW4gYSBsaXN0IHNob3VsZCBoYXZlIGEgdW5pcXVlICJrZXkiIHByb3AuJXMlcyBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dhcm5pbmcta2V5cyBmb3IgbW9yZSBpbmZvcm1hdGlvbi4nLCBjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvLCBjaGlsZE93bmVyKTsKICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVDaGlsZEtleXMobm9kZSwgcGFyZW50VHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIG5vZGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpc0FycmF5Mihub2RlKSkgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZVtpXTsKICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudDE1KGNoaWxkKSkgewogICAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KGNoaWxkLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNWYWxpZEVsZW1lbnQxNShub2RlKSkgewogICAgICAgICAgICAgIGlmIChub2RlLl9zdG9yZSkgewogICAgICAgICAgICAgICAgbm9kZS5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZSkgewogICAgICAgICAgICAgIHZhciBpdGVyYXRvckZuID0gZ2V0SXRlcmF0b3JGbihub2RlKTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGl0ZXJhdG9yRm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGlmIChpdGVyYXRvckZuICE9PSBub2RlLmVudHJpZXMpIHsKICAgICAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yID0gaXRlcmF0b3JGbi5jYWxsKG5vZGUpOwogICAgICAgICAgICAgICAgICB2YXIgc3RlcDsKICAgICAgICAgICAgICAgICAgd2hpbGUgKCEoc3RlcCA9IGl0ZXJhdG9yLm5leHQoKSkuZG9uZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudDE1KHN0ZXAudmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZUV4cGxpY2l0S2V5KHN0ZXAudmFsdWUsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB0eXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCB8fCB0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBwcm9wVHlwZXM7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHByb3BUeXBlcyA9IHR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiAodHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIgfHwgLy8gTm90ZTogTWVtbyBvbmx5IGNoZWNrcyBvdXRlciBwcm9wcyBoZXJlLgogICAgICAgICAgICAvLyBJbm5lciBwcm9wcyBhcmUgY2hlY2tlZCBpbiB0aGUgcmVjb25jaWxlci4KICAgICAgICAgICAgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFMikpIHsKICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BUeXBlcykgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKHByb3BUeXBlcywgZWxlbWVudC5wcm9wcywgInByb3AiLCBuYW1lLCBlbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlLlByb3BUeXBlcyAhPT0gdm9pZCAwICYmICFwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93bikgewogICAgICAgICAgICAgIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICB2YXIgX25hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSk7CiAgICAgICAgICAgICAgZXJyb3IoIkNvbXBvbmVudCAlcyBkZWNsYXJlZCBgUHJvcFR5cGVzYCBpbnN0ZWFkIG9mIGBwcm9wVHlwZXNgLiBEaWQgeW91IG1pc3NwZWxsIHRoZSBwcm9wZXJ0eSBhc3NpZ25tZW50PyIsIF9uYW1lIHx8ICJVbmtub3duIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlLmdldERlZmF1bHRQcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiAhdHlwZS5nZXREZWZhdWx0UHJvcHMuaXNSZWFjdENsYXNzQXBwcm92ZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiZ2V0RGVmYXVsdFByb3BzIGlzIG9ubHkgdXNlZCBvbiBjbGFzc2ljIFJlYWN0LmNyZWF0ZUNsYXNzIGRlZmluaXRpb25zLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgbmFtZWQgYGRlZmF1bHRQcm9wc2AgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUZyYWdtZW50UHJvcHMoZnJhZ21lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhmcmFnbWVudC5wcm9wcyk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgICAgICAgICAgIGlmIChrZXkgIT09ICJjaGlsZHJlbiIgJiYga2V5ICE9PSAia2V5IikgewogICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShmcmFnbWVudCk7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBwcm9wIGAlc2Agc3VwcGxpZWQgdG8gYFJlYWN0LkZyYWdtZW50YC4gUmVhY3QuRnJhZ21lbnQgY2FuIG9ubHkgaGF2ZSBga2V5YCBhbmQgYGNoaWxkcmVuYCBwcm9wcy4iLCBrZXkpOwogICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShudWxsKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZnJhZ21lbnQucmVmICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShmcmFnbWVudCk7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXR0cmlidXRlIGByZWZgIHN1cHBsaWVkIHRvIGBSZWFjdC5GcmFnbWVudGAuIik7CiAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0S2V5U3ByZWFkID0ge307CiAgICAgICAgZnVuY3Rpb24ganN4V2l0aFZhbGlkYXRpb24odHlwZSwgcHJvcHMsIGtleSwgaXNTdGF0aWNDaGlsZHJlbiwgc291cmNlLCBzZWxmMikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdmFsaWRUeXBlID0gaXNWYWxpZEVsZW1lbnRUeXBlKHR5cGUpOwogICAgICAgICAgICBpZiAoIXZhbGlkVHlwZSkgewogICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IHZvaWQgMCB8fCB0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCAmJiBPYmplY3Qua2V5cyh0eXBlKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gIiBZb3UgbGlrZWx5IGZvcmdvdCB0byBleHBvcnQgeW91ciBjb21wb25lbnQgZnJvbSB0aGUgZmlsZSBpdCdzIGRlZmluZWQgaW4sIG9yIHlvdSBtaWdodCBoYXZlIG1peGVkIHVwIGRlZmF1bHQgYW5kIG5hbWVkIGltcG9ydHMuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHNvdXJjZUluZm8gPSBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpOwogICAgICAgICAgICAgIGlmIChzb3VyY2VJbmZvKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9IHNvdXJjZUluZm87CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluZm8gKz0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB0eXBlU3RyaW5nOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gIm51bGwiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNBcnJheTIodHlwZSkpIHsKICAgICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAiYXJyYXkiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSAhPT0gdm9pZCAwICYmIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0VMRU1FTlRfVFlQRSkgewogICAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICI8IiArIChnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiVW5rbm93biIpICsgIiAvPiI7CiAgICAgICAgICAgICAgICBpbmZvID0gIiBEaWQgeW91IGFjY2lkZW50YWxseSBleHBvcnQgYSBKU1ggbGl0ZXJhbCBpbnN0ZWFkIG9mIGEgY29tcG9uZW50PyI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSB0eXBlb2YgdHlwZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0LmpzeDogdHlwZSBpcyBpbnZhbGlkIC0tIGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgYnVpbHQtaW4gY29tcG9uZW50cykgb3IgYSBjbGFzcy9mdW5jdGlvbiAoZm9yIGNvbXBvc2l0ZSBjb21wb25lbnRzKSBidXQgZ290OiAlcy4lcyIsIHR5cGVTdHJpbmcsIGluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0ganN4REVWKHR5cGUsIHByb3BzLCBrZXksIHNvdXJjZSwgc2VsZjIpOwogICAgICAgICAgICBpZiAoZWxlbWVudCA9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZhbGlkVHlwZSkgewogICAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IHByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIGlmIChjaGlsZHJlbiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNTdGF0aWNDaGlsZHJlbikgewogICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheTIoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVDaGlsZEtleXMoY2hpbGRyZW5baV0sIHR5cGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShjaGlsZHJlbik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5qc3g6IFN0YXRpYyBjaGlsZHJlbiBzaG91bGQgYWx3YXlzIGJlIGFuIGFycmF5LiBZb3UgYXJlIGxpa2VseSBleHBsaWNpdGx5IGNhbGxpbmcgUmVhY3QuanN4cyBvciBSZWFjdC5qc3hERVYuIFVzZSB0aGUgQmFiZWwgdHJhbnNmb3JtIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGNoaWxkcmVuLCB0eXBlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHByb3BzLCAia2V5IikpIHsKICAgICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhwcm9wcykuZmlsdGVyKGZ1bmN0aW9uKGspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGsgIT09ICJrZXkiOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB2YXIgYmVmb3JlRXhhbXBsZSA9IGtleXMubGVuZ3RoID4gMCA/ICJ7a2V5OiBzb21lS2V5LCAiICsga2V5cy5qb2luKCI6IC4uLiwgIikgKyAiOiAuLi59IiA6ICJ7a2V5OiBzb21lS2V5fSI7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEtleVNwcmVhZFtjb21wb25lbnROYW1lICsgYmVmb3JlRXhhbXBsZV0pIHsKICAgICAgICAgICAgICAgICAgdmFyIGFmdGVyRXhhbXBsZSA9IGtleXMubGVuZ3RoID4gMCA/ICJ7IiArIGtleXMuam9pbigiOiAuLi4sICIpICsgIjogLi4ufSIgOiAie30iOwogICAgICAgICAgICAgICAgICBlcnJvcignQSBwcm9wcyBvYmplY3QgY29udGFpbmluZyBhICJrZXkiIHByb3AgaXMgYmVpbmcgc3ByZWFkIGludG8gSlNYOlxuICBsZXQgcHJvcHMgPSAlcztcbiAgPCVzIHsuLi5wcm9wc30gLz5cblJlYWN0IGtleXMgbXVzdCBiZSBwYXNzZWQgZGlyZWN0bHkgdG8gSlNYIHdpdGhvdXQgdXNpbmcgc3ByZWFkOlxuICBsZXQgcHJvcHMgPSAlcztcbiAgPCVzIGtleT17c29tZUtleX0gey4uLnByb3BzfSAvPicsIGJlZm9yZUV4YW1wbGUsIGNvbXBvbmVudE5hbWUsIGFmdGVyRXhhbXBsZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEtleVNwcmVhZFtjb21wb25lbnROYW1lICsgYmVmb3JlRXhhbXBsZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgIHZhbGlkYXRlRnJhZ21lbnRQcm9wcyhlbGVtZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24ganN4V2l0aFZhbGlkYXRpb25TdGF0aWModHlwZSwgcHJvcHMsIGtleSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4ganN4V2l0aFZhbGlkYXRpb24odHlwZSwgcHJvcHMsIGtleSwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uRHluYW1pYyh0eXBlLCBwcm9wcywga2V5KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBqc3hXaXRoVmFsaWRhdGlvbih0eXBlLCBwcm9wcywga2V5LCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBqc3gzID0ganN4V2l0aFZhbGlkYXRpb25EeW5hbWljOwogICAgICAgIHZhciBqc3hzMyA9IGpzeFdpdGhWYWxpZGF0aW9uU3RhdGljOwogICAgICAgIGV4cG9ydHMuRnJhZ21lbnQgPSBSRUFDVF9GUkFHTUVOVF9UWVBFOwogICAgICAgIGV4cG9ydHMuanN4ID0ganN4MzsKICAgICAgICBleHBvcnRzLmpzeHMgPSBqc3hzMzsKICAgICAgfSkoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlYWN0L2pzeC1ydW50aW1lLmpzCnZhciByZXF1aXJlX2pzeF9ydW50aW1lID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy9yZWFjdC9qc3gtcnVudGltZS5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JlYWN0X2pzeF9ydW50aW1lX2RldmVsb3BtZW50KCk7CiAgICB9CiAgfQp9KTsKCi8vIHNyYy9tYWluLnRzeAp2YXIgaW1wb3J0X3JlYWN0NTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSwgMSk7CnZhciBpbXBvcnRfY2xpZW50ID0gX190b0VTTShyZXF1aXJlX2NsaWVudCgpLCAxKTsKCi8vIHNyYy9NeUJ1ZGdldC50c3gKdmFyIGltcG9ydF9yZWFjdDUxID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCksIDEpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9jcmVhdGVMdWNpZGVJY29uLmpzCnZhciBpbXBvcnRfcmVhY3QyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9zaGFyZWQvc3JjL3V0aWxzLmpzCnZhciB0b0tlYmFiQ2FzZSA9IChzdHJpbmcpID0+IHN0cmluZy5yZXBsYWNlKC8oW2EtejAtOV0pKFtBLVpdKS9nLCAiJDEtJDIiKS50b0xvd2VyQ2FzZSgpOwp2YXIgdG9DYW1lbENhc2UgPSAoc3RyaW5nKSA9PiBzdHJpbmcucmVwbGFjZSgKICAvXihbQS1aXSl8W1xzLV9dKyhcdykvZywKICAobWF0Y2gsIHAxLCBwMikgPT4gcDIgPyBwMi50b1VwcGVyQ2FzZSgpIDogcDEudG9Mb3dlckNhc2UoKQopOwp2YXIgdG9QYXNjYWxDYXNlID0gKHN0cmluZykgPT4gewogIGNvbnN0IGNhbWVsQ2FzZSA9IHRvQ2FtZWxDYXNlKHN0cmluZyk7CiAgcmV0dXJuIGNhbWVsQ2FzZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIGNhbWVsQ2FzZS5zbGljZSgxKTsKfTsKdmFyIG1lcmdlQ2xhc3NlcyA9ICguLi5jbGFzc2VzKSA9PiBjbGFzc2VzLmZpbHRlcigoY2xhc3NOYW1lLCBpbmRleCwgYXJyYXkpID0+IHsKICByZXR1cm4gQm9vbGVhbihjbGFzc05hbWUpICYmIGNsYXNzTmFtZS50cmltKCkgIT09ICIiICYmIGFycmF5LmluZGV4T2YoY2xhc3NOYW1lKSA9PT0gaW5kZXg7Cn0pLmpvaW4oIiAiKS50cmltKCk7CnZhciBoYXNBMTF5UHJvcCA9IChwcm9wcykgPT4gewogIGZvciAoY29uc3QgcHJvcCBpbiBwcm9wcykgewogICAgaWYgKHByb3Auc3RhcnRzV2l0aCgiYXJpYS0iKSB8fCBwcm9wID09PSAicm9sZSIgfHwgcHJvcCA9PT0gInRpdGxlIikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9Cn07CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL0ljb24uanMKdmFyIGltcG9ydF9yZWFjdCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vZGVmYXVsdEF0dHJpYnV0ZXMuanMKdmFyIGRlZmF1bHRBdHRyaWJ1dGVzID0gewogIHhtbG5zOiAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciLAogIHdpZHRoOiAyNCwKICBoZWlnaHQ6IDI0LAogIHZpZXdCb3g6ICIwIDAgMjQgMjQiLAogIGZpbGw6ICJub25lIiwKICBzdHJva2U6ICJjdXJyZW50Q29sb3IiLAogIHN0cm9rZVdpZHRoOiAyLAogIHN0cm9rZUxpbmVjYXA6ICJyb3VuZCIsCiAgc3Ryb2tlTGluZWpvaW46ICJyb3VuZCIKfTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vSWNvbi5qcwp2YXIgSWNvbiA9ICgwLCBpbXBvcnRfcmVhY3QuZm9yd2FyZFJlZikoCiAgKHsKICAgIGNvbG9yOiBjb2xvcjIgPSAiY3VycmVudENvbG9yIiwKICAgIHNpemUgPSAyNCwKICAgIHN0cm9rZVdpZHRoID0gMiwKICAgIGFic29sdXRlU3Ryb2tlV2lkdGgsCiAgICBjbGFzc05hbWUgPSAiIiwKICAgIGNoaWxkcmVuLAogICAgaWNvbk5vZGUsCiAgICAuLi5yZXN0CiAgfSwgcmVmKSA9PiAoMCwgaW1wb3J0X3JlYWN0LmNyZWF0ZUVsZW1lbnQpKAogICAgInN2ZyIsCiAgICB7CiAgICAgIHJlZiwKICAgICAgLi4uZGVmYXVsdEF0dHJpYnV0ZXMsCiAgICAgIHdpZHRoOiBzaXplLAogICAgICBoZWlnaHQ6IHNpemUsCiAgICAgIHN0cm9rZTogY29sb3IyLAogICAgICBzdHJva2VXaWR0aDogYWJzb2x1dGVTdHJva2VXaWR0aCA/IE51bWJlcihzdHJva2VXaWR0aCkgKiAyNCAvIE51bWJlcihzaXplKSA6IHN0cm9rZVdpZHRoLAogICAgICBjbGFzc05hbWU6IG1lcmdlQ2xhc3NlcygibHVjaWRlIiwgY2xhc3NOYW1lKSwKICAgICAgLi4uIWNoaWxkcmVuICYmICFoYXNBMTF5UHJvcChyZXN0KSAmJiB7ICJhcmlhLWhpZGRlbiI6ICJ0cnVlIiB9LAogICAgICAuLi5yZXN0CiAgICB9LAogICAgWwogICAgICAuLi5pY29uTm9kZS5tYXAoKFt0YWcsIGF0dHJzXSkgPT4gKDAsIGltcG9ydF9yZWFjdC5jcmVhdGVFbGVtZW50KSh0YWcsIGF0dHJzKSksCiAgICAgIC4uLkFycmF5LmlzQXJyYXkoY2hpbGRyZW4pID8gY2hpbGRyZW4gOiBbY2hpbGRyZW5dCiAgICBdCiAgKQopOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9jcmVhdGVMdWNpZGVJY29uLmpzCnZhciBjcmVhdGVMdWNpZGVJY29uID0gKGljb25OYW1lLCBpY29uTm9kZSkgPT4gewogIGNvbnN0IENvbXBvbmVudCA9ICgwLCBpbXBvcnRfcmVhY3QyLmZvcndhcmRSZWYpKAogICAgKHsgY2xhc3NOYW1lLCAuLi5wcm9wcyB9LCByZWYpID0+ICgwLCBpbXBvcnRfcmVhY3QyLmNyZWF0ZUVsZW1lbnQpKEljb24sIHsKICAgICAgcmVmLAogICAgICBpY29uTm9kZSwKICAgICAgY2xhc3NOYW1lOiBtZXJnZUNsYXNzZXMoCiAgICAgICAgYGx1Y2lkZS0ke3RvS2ViYWJDYXNlKHRvUGFzY2FsQ2FzZShpY29uTmFtZSkpfWAsCiAgICAgICAgYGx1Y2lkZS0ke2ljb25OYW1lfWAsCiAgICAgICAgY2xhc3NOYW1lCiAgICAgICksCiAgICAgIC4uLnByb3BzCiAgICB9KQogICk7CiAgQ29tcG9uZW50LmRpc3BsYXlOYW1lID0gdG9QYXNjYWxDYXNlKGljb25OYW1lKTsKICByZXR1cm4gQ29tcG9uZW50Owp9OwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9hcnJvdy11cC1yaWdodC5qcwp2YXIgX19pY29uTm9kZSA9IFsKICBbInBhdGgiLCB7IGQ6ICJNNyA3aDEwdjEwIiwga2V5OiAiMXRpdm45IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNNyAxNyAxNyA3Iiwga2V5OiAiMXZraXphIiB9XQpdOwp2YXIgQXJyb3dVcFJpZ2h0ID0gY3JlYXRlTHVjaWRlSWNvbigiYXJyb3ctdXAtcmlnaHQiLCBfX2ljb25Ob2RlKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYnVpbGRpbmctMi5qcwp2YXIgX19pY29uTm9kZTIgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTEwIDEyaDQiLCBrZXk6ICJhNTZiMHAiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMCA4aDQiLCBrZXk6ICIxc3IyYWYiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xNCAyMXYtM2EyIDIgMCAwIDAtNCAwdjMiLCBrZXk6ICIxcmdpZWkiIH1dLAogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk02IDEwSDRhMiAyIDAgMCAwLTIgMnY3YTIgMiAwIDAgMCAyIDJoMTZhMiAyIDAgMCAwIDItMlY5YTIgMiAwIDAgMC0yLTJoLTIiLAogICAgICBrZXk6ICJzZWNtaTIiCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNNiAyMVY1YTIgMiAwIDAgMSAyLTJoOGEyIDIgMCAwIDEgMiAydjE2Iiwga2V5OiAiMTZyYTB0IiB9XQpdOwp2YXIgQnVpbGRpbmcyID0gY3JlYXRlTHVjaWRlSWNvbigiYnVpbGRpbmctMiIsIF9faWNvbk5vZGUyKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hhcnQtY29sdW1uLmpzCnZhciBfX2ljb25Ob2RlMyA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMyAzdjE2YTIgMiAwIDAgMCAyIDJoMTYiLCBrZXk6ICJjMjRpNDgiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xOCAxN1Y5Iiwga2V5OiAiMmJ6NjBuIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTMgMTdWNSIsIGtleTogIjFmcmR0OCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTggMTd2LTMiLCBrZXk6ICIxN3NrYTAiIH1dCl07CnZhciBDaGFydENvbHVtbiA9IGNyZWF0ZUx1Y2lkZUljb24oImNoYXJ0LWNvbHVtbiIsIF9faWNvbk5vZGUzKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hlY2suanMKdmFyIF9faWNvbk5vZGU0ID0gW1sicGF0aCIsIHsgZDogIk0yMCA2IDkgMTdsLTUtNSIsIGtleTogIjFnbWYyYyIgfV1dOwp2YXIgQ2hlY2sgPSBjcmVhdGVMdWNpZGVJY29uKCJjaGVjayIsIF9faWNvbk5vZGU0KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hldnJvbi1kb3duLmpzCnZhciBfX2ljb25Ob2RlNSA9IFtbInBhdGgiLCB7IGQ6ICJtNiA5IDYgNiA2LTYiLCBrZXk6ICJxcnVuc2wiIH1dXTsKdmFyIENoZXZyb25Eb3duID0gY3JlYXRlTHVjaWRlSWNvbigiY2hldnJvbi1kb3duIiwgX19pY29uTm9kZTUpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGV2cm9uLXVwLmpzCnZhciBfX2ljb25Ob2RlNiA9IFtbInBhdGgiLCB7IGQ6ICJtMTggMTUtNi02LTYgNiIsIGtleTogIjE1M3VkeiIgfV1dOwp2YXIgQ2hldnJvblVwID0gY3JlYXRlTHVjaWRlSWNvbigiY2hldnJvbi11cCIsIF9faWNvbk5vZGU2KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2xvY2suanMKdmFyIF9faWNvbk5vZGU3ID0gWwogIFsicGF0aCIsIHsgZDogIk0xMiA2djZsNCAyIiwga2V5OiAibW1rN3lnIiB9XSwKICBbImNpcmNsZSIsIHsgY3g6ICIxMiIsIGN5OiAiMTIiLCByOiAiMTAiLCBrZXk6ICIxbWdsYXkiIH1dCl07CnZhciBDbG9jayA9IGNyZWF0ZUx1Y2lkZUljb24oImNsb2NrIiwgX19pY29uTm9kZTcpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9kb2xsYXItc2lnbi5qcwp2YXIgX19pY29uTm9kZTggPSBbCiAgWyJsaW5lIiwgeyB4MTogIjEyIiwgeDI6ICIxMiIsIHkxOiAiMiIsIHkyOiAiMjIiLCBrZXk6ICI3ZXF5cWgiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xNyA1SDkuNWEzLjUgMy41IDAgMCAwIDAgN2g1YTMuNSAzLjUgMCAwIDEgMCA3SDYiLCBrZXk6ICIxYjBwNHMiIH1dCl07CnZhciBEb2xsYXJTaWduID0gY3JlYXRlTHVjaWRlSWNvbigiZG9sbGFyLXNpZ24iLCBfX2ljb25Ob2RlOCk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2dyaXAtdmVydGljYWwuanMKdmFyIF9faWNvbk5vZGU5ID0gWwogIFsiY2lyY2xlIiwgeyBjeDogIjkiLCBjeTogIjEyIiwgcjogIjEiLCBrZXk6ICIxdmN0Z2YiIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjkiLCBjeTogIjUiLCByOiAiMSIsIGtleTogImhwMHRjZiIgfV0sCiAgWyJjaXJjbGUiLCB7IGN4OiAiOSIsIGN5OiAiMTkiLCByOiAiMSIsIGtleTogImZrampmNiIgfV0sCiAgWyJjaXJjbGUiLCB7IGN4OiAiMTUiLCBjeTogIjEyIiwgcjogIjEiLCBrZXk6ICIxdG1haWoiIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjE1IiwgY3k6ICI1IiwgcjogIjEiLCBrZXk6ICIxOWwyOGUiIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjE1IiwgY3k6ICIxOSIsIHI6ICIxIiwga2V5OiAiZjR6b2ozIiB9XQpdOwp2YXIgR3JpcFZlcnRpY2FsID0gY3JlYXRlTHVjaWRlSWNvbigiZ3JpcC12ZXJ0aWNhbCIsIF9faWNvbk5vZGU5KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvaGVhcnQuanMKdmFyIF9faWNvbk5vZGUxMCA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMiA5LjVhNS41IDUuNSAwIDAgMSA5LjU5MS0zLjY3Ni41Ni41NiAwIDAgMCAuODE4IDBBNS40OSA1LjQ5IDAgMCAxIDIyIDkuNWMwIDIuMjktMS41IDQtMyA1LjVsLTUuNDkyIDUuMzEzYTIgMiAwIDAgMS0zIC4wMTlMNSAxNWMtMS41LTEuNS0zLTMuMi0zLTUuNSIsCiAgICAgIGtleTogIm12cjFhMCIKICAgIH0KICBdCl07CnZhciBIZWFydCA9IGNyZWF0ZUx1Y2lkZUljb24oImhlYXJ0IiwgX19pY29uTm9kZTEwKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvaG91c2UuanMKdmFyIF9faWNvbk5vZGUxMSA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTUgMjF2LThhMSAxIDAgMCAwLTEtMWgtNGExIDEgMCAwIDAtMSAxdjgiLCBrZXk6ICI1d3dscjUiIH1dLAogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0zIDEwYTIgMiAwIDAgMSAuNzA5LTEuNTI4bDctNmEyIDIgMCAwIDEgMi41ODIgMGw3IDZBMiAyIDAgMCAxIDIxIDEwdjlhMiAyIDAgMCAxLTIgMkg1YTIgMiAwIDAgMS0yLTJ6IiwKICAgICAga2V5OiAicjZuc3MxIgogICAgfQogIF0KXTsKdmFyIEhvdXNlID0gY3JlYXRlTHVjaWRlSWNvbigiaG91c2UiLCBfX2ljb25Ob2RlMTEpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9sYW5kbWFyay5qcwp2YXIgX19pY29uTm9kZTEyID0gWwogIFsicGF0aCIsIHsgZDogIk0xMCAxOHYtNyIsIGtleTogInd0MTE2YiIgfV0sCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTExLjEyIDIuMTk4YTIgMiAwIDAgMSAxLjc2LjAwNmw3Ljg2NiAzLjg0N2MuNDc2LjIzMy4zMS45NDktLjIyLjk0OUgzLjQ3NGMtLjUzIDAtLjY5NS0uNzE2LS4yMi0uOTQ5eiIsCiAgICAgIGtleTogIjFtMzI5bSIKICAgIH0KICBdLAogIFsicGF0aCIsIHsgZDogIk0xNCAxOHYtNyIsIGtleTogInZhdjZ0MyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTE4IDE4di03Iiwga2V5OiAiYWV4ZG1qIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMyAyMmgxOCIsIGtleTogIjhwcnI0NSIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTYgMTh2LTciLCBrZXk6ICIxaXZmbGsiIH1dCl07CnZhciBMYW5kbWFyayA9IGNyZWF0ZUx1Y2lkZUljb24oImxhbmRtYXJrIiwgX19pY29uTm9kZTEyKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbG9hZGVyLWNpcmNsZS5qcwp2YXIgX19pY29uTm9kZTEzID0gW1sicGF0aCIsIHsgZDogIk0yMSAxMmE5IDkgMCAxIDEtNi4yMTktOC41NiIsIGtleTogIjEzemFsZCIgfV1dOwp2YXIgTG9hZGVyQ2lyY2xlID0gY3JlYXRlTHVjaWRlSWNvbigibG9hZGVyLWNpcmNsZSIsIF9faWNvbk5vZGUxMyk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL21haWwuanMKdmFyIF9faWNvbk5vZGUxNCA9IFsKICBbInBhdGgiLCB7IGQ6ICJtMjIgNy04Ljk5MSA1LjcyN2EyIDIgMCAwIDEtMi4wMDkgMEwyIDciLCBrZXk6ICIxMzJxN3EiIH1dLAogIFsicmVjdCIsIHsgeDogIjIiLCB5OiAiNCIsIHdpZHRoOiAiMjAiLCBoZWlnaHQ6ICIxNiIsIHJ4OiAiMiIsIGtleTogIml6eGxhbyIgfV0KXTsKdmFyIE1haWwgPSBjcmVhdGVMdWNpZGVJY29uKCJtYWlsIiwgX19pY29uTm9kZTE0KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbWVzc2FnZS1zcXVhcmUuanMKdmFyIF9faWNvbk5vZGUxNSA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMjIgMTdhMiAyIDAgMCAxLTIgMkg2LjgyOGEyIDIgMCAwIDAtMS40MTQuNTg2bC0yLjIwMiAyLjIwMkEuNzEuNzEgMCAwIDEgMiAyMS4yODZWNWEyIDIgMCAwIDEgMi0yaDE2YTIgMiAwIDAgMSAyIDJ6IiwKICAgICAga2V5OiAiMTg4ODdwIgogICAgfQogIF0KXTsKdmFyIE1lc3NhZ2VTcXVhcmUgPSBjcmVhdGVMdWNpZGVJY29uKCJtZXNzYWdlLXNxdWFyZSIsIF9faWNvbk5vZGUxNSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3Blbi5qcwp2YXIgX19pY29uTm9kZTE2ID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0yMS4xNzQgNi44MTJhMSAxIDAgMCAwLTMuOTg2LTMuOTg3TDMuODQyIDE2LjE3NGEyIDIgMCAwIDAtLjUuODNsLTEuMzIxIDQuMzUyYS41LjUgMCAwIDAgLjYyMy42MjJsNC4zNTMtMS4zMmEyIDIgMCAwIDAgLjgzLS40OTd6IiwKICAgICAga2V5OiAiMWE4dXN1IgogICAgfQogIF0KXTsKdmFyIFBlbiA9IGNyZWF0ZUx1Y2lkZUljb24oInBlbiIsIF9faWNvbk5vZGUxNik7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3BpZ2d5LWJhbmsuanMKdmFyIF9faWNvbk5vZGUxNyA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMTEgMTdoM3YyYTEgMSAwIDAgMCAxIDFoMmExIDEgMCAwIDAgMS0xdi0zYTMuMTYgMy4xNiAwIDAgMCAyLTJoMWExIDEgMCAwIDAgMS0xdi0yYTEgMSAwIDAgMC0xLTFoLTFhNSA1IDAgMCAwLTItNFYzYTQgNCAwIDAgMC0zLjIgMS42bC0uMy40SDExYTYgNiAwIDAgMC02IDZ2MWE1IDUgMCAwIDAgMiA0djNhMSAxIDAgMCAwIDEgMWgyYTEgMSAwIDAgMCAxLTF6IiwKICAgICAga2V5OiAiMXBpZ2xjIgogICAgfQogIF0sCiAgWyJwYXRoIiwgeyBkOiAiTTE2IDEwaC4wMSIsIGtleTogIjFtOTR3eiIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTIgOHYxYTIgMiAwIDAgMCAyIDJoMSIsIGtleTogIjFlbnY0MyIgfV0KXTsKdmFyIFBpZ2d5QmFuayA9IGNyZWF0ZUx1Y2lkZUljb24oInBpZ2d5LWJhbmsiLCBfX2ljb25Ob2RlMTcpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wbHVzLmpzCnZhciBfX2ljb25Ob2RlMTggPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTUgMTJoMTQiLCBrZXk6ICIxYXlzMGgiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMiA1djE0Iiwga2V5OiAiczY5OWxlIiB9XQpdOwp2YXIgUGx1cyA9IGNyZWF0ZUx1Y2lkZUljb24oInBsdXMiLCBfX2ljb25Ob2RlMTgpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wcmludGVyLmpzCnZhciBfX2ljb25Ob2RlMTkgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTYgMThINGEyIDIgMCAwIDEtMi0ydi01YTIgMiAwIDAgMSAyLTJoMTZhMiAyIDAgMCAxIDIgMnY1YTIgMiAwIDAgMS0yIDJoLTIiLAogICAgICBrZXk6ICIxNDN3eWQiCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNNiA5VjNhMSAxIDAgMCAxIDEtMWgxMGExIDEgMCAwIDEgMSAxdjYiLCBrZXk6ICIxaXRuZTciIH1dLAogIFsicmVjdCIsIHsgeDogIjYiLCB5OiAiMTQiLCB3aWR0aDogIjEyIiwgaGVpZ2h0OiAiOCIsIHJ4OiAiMSIsIGtleTogIjF1ZTB0ZyIgfV0KXTsKdmFyIFByaW50ZXIgPSBjcmVhdGVMdWNpZGVJY29uKCJwcmludGVyIiwgX19pY29uTm9kZTE5KTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcmVmcmVzaC1jdy5qcwp2YXIgX19pY29uTm9kZTIwID0gWwogIFsicGF0aCIsIHsgZDogIk0zIDEyYTkgOSAwIDAgMSA5LTkgOS43NSA5Ljc1IDAgMCAxIDYuNzQgMi43NEwyMSA4Iiwga2V5OiAidjloNXZjIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMjEgM3Y1aC01Iiwga2V5OiAiMXE3dG8wIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMjEgMTJhOSA5IDAgMCAxLTkgOSA5Ljc1IDkuNzUgMCAwIDEtNi43NC0yLjc0TDMgMTYiLCBrZXk6ICIzdWlmbDMiIH1dLAogIFsicGF0aCIsIHsgZDogIk04IDE2SDN2NSIsIGtleTogIjFjdjY3OCIgfV0KXTsKdmFyIFJlZnJlc2hDdyA9IGNyZWF0ZUx1Y2lkZUljb24oInJlZnJlc2gtY3ciLCBfX2ljb25Ob2RlMjApOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9yb3RhdGUtY2N3LmpzCnZhciBfX2ljb25Ob2RlMjEgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTMgMTJhOSA5IDAgMSAwIDktOSA5Ljc1IDkuNzUgMCAwIDAtNi43NCAyLjc0TDMgOCIsIGtleTogIjEzNTdlMyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTMgM3Y1aDUiLCBrZXk6ICIxeGhxOGEiIH1dCl07CnZhciBSb3RhdGVDY3cgPSBjcmVhdGVMdWNpZGVJY29uKCJyb3RhdGUtY2N3IiwgX19pY29uTm9kZTIxKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvc2F2ZS5qcwp2YXIgX19pY29uTm9kZTIyID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0xNS4yIDNhMiAyIDAgMCAxIDEuNC42bDMuOCAzLjhhMiAyIDAgMCAxIC42IDEuNFYxOWEyIDIgMCAwIDEtMiAySDVhMiAyIDAgMCAxLTItMlY1YTIgMiAwIDAgMSAyLTJ6IiwKICAgICAga2V5OiAiMWM4NDc2IgogICAgfQogIF0sCiAgWyJwYXRoIiwgeyBkOiAiTTE3IDIxdi03YTEgMSAwIDAgMC0xLTFIOGExIDEgMCAwIDAtMSAxdjciLCBrZXk6ICIxeWR0b3MiIH1dLAogIFsicGF0aCIsIHsgZDogIk03IDN2NGExIDEgMCAwIDAgMSAxaDciLCBrZXk6ICJ0NTF1NzMiIH1dCl07CnZhciBTYXZlID0gY3JlYXRlTHVjaWRlSWNvbigic2F2ZSIsIF9faWNvbk5vZGUyMik7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3NlYXJjaC5qcwp2YXIgX19pY29uTm9kZTIzID0gWwogIFsicGF0aCIsIHsgZDogIm0yMSAyMS00LjM0LTQuMzQiLCBrZXk6ICIxNGo3cmoiIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjExIiwgY3k6ICIxMSIsIHI6ICI4Iiwga2V5OiAiNGVqOTd1IiB9XQpdOwp2YXIgU2VhcmNoID0gY3JlYXRlTHVjaWRlSWNvbigic2VhcmNoIiwgX19pY29uTm9kZTIzKTsKCi8vIG5vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdGh1bWJzLWRvd24uanMKdmFyIF9faWNvbk5vZGUyNCA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTcgMTRWMiIsIGtleTogIjh5bXFuayIgfV0sCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTkgMTguMTIgMTAgMTRINC4xN2EyIDIgMCAwIDEtMS45Mi0yLjU2bDIuMzMtOEEyIDIgMCAwIDEgNi41IDJIMjBhMiAyIDAgMCAxIDIgMnY4YTIgMiAwIDAgMS0yIDJoLTIuNzZhMiAyIDAgMCAwLTEuNzkgMS4xMUwxMiAyMmEzLjEzIDMuMTMgMCAwIDEtMy0zLjg4WiIsCiAgICAgIGtleTogIm02MW03NyIKICAgIH0KICBdCl07CnZhciBUaHVtYnNEb3duID0gY3JlYXRlTHVjaWRlSWNvbigidGh1bWJzLWRvd24iLCBfX2ljb25Ob2RlMjQpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90aHVtYnMtdXAuanMKdmFyIF9faWNvbk5vZGUyNSA9IFsKICBbInBhdGgiLCB7IGQ6ICJNNyAxMHYxMiIsIGtleTogIjFxYzkzbiIgfV0sCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTE1IDUuODggMTQgMTBoNS44M2EyIDIgMCAwIDEgMS45MiAyLjU2bC0yLjMzIDhBMiAyIDAgMCAxIDE3LjUgMjJINGEyIDIgMCAwIDEtMi0ydi04YTIgMiAwIDAgMSAyLTJoMi43NmEyIDIgMCAwIDAgMS43OS0xLjExTDEyIDJhMy4xMyAzLjEzIDAgMCAxIDMgMy44OFoiLAogICAgICBrZXk6ICJlbW1tY3IiCiAgICB9CiAgXQpdOwp2YXIgVGh1bWJzVXAgPSBjcmVhdGVMdWNpZGVJY29uKCJ0aHVtYnMtdXAiLCBfX2ljb25Ob2RlMjUpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90cmFzaC0yLmpzCnZhciBfX2ljb25Ob2RlMjYgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTEwIDExdjYiLCBrZXk6ICJuY28wb20iIH1dLAogIFsicGF0aCIsIHsgZDogIk0xNCAxMXY2Iiwga2V5OiAib3V0djF1IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTkgNnYxNGEyIDIgMCAwIDEtMiAySDdhMiAyIDAgMCAxLTItMlY2Iiwga2V5OiAibWl5dHJjIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMyA2aDE4Iiwga2V5OiAiZDB3bTBqIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNOCA2VjRhMiAyIDAgMCAxIDItMmg0YTIgMiAwIDAgMSAyIDJ2MiIsIGtleTogImU3OTFqaSIgfV0KXTsKdmFyIFRyYXNoMiA9IGNyZWF0ZUx1Y2lkZUljb24oInRyYXNoLTIiLCBfX2ljb25Ob2RlMjYpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90cmVuZGluZy1kb3duLmpzCnZhciBfX2ljb25Ob2RlMjcgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTE2IDE3aDZ2LTYiLCBrZXk6ICJ0Nm4yaXQiIH1dLAogIFsicGF0aCIsIHsgZDogIm0yMiAxNy04LjUtOC41LTUgNUwyIDciLCBrZXk6ICJ4NDczcCIgfV0KXTsKdmFyIFRyZW5kaW5nRG93biA9IGNyZWF0ZUx1Y2lkZUljb24oInRyZW5kaW5nLWRvd24iLCBfX2ljb25Ob2RlMjcpOwoKLy8gbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90cmVuZGluZy11cC5qcwp2YXIgX19pY29uTm9kZTI4ID0gWwogIFsicGF0aCIsIHsgZDogIk0xNiA3aDZ2NiIsIGtleTogImJveDU1bCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAibTIyIDctOC41IDguNS01LTVMMiAxNyIsIGtleTogIjF0MW03OSIgfV0KXTsKdmFyIFRyZW5kaW5nVXAgPSBjcmVhdGVMdWNpZGVJY29uKCJ0cmVuZGluZy11cCIsIF9faWNvbk5vZGUyOCk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RyaWFuZ2xlLWFsZXJ0LmpzCnZhciBfX2ljb25Ob2RlMjkgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAibTIxLjczIDE4LTgtMTRhMiAyIDAgMCAwLTMuNDggMGwtOCAxNEEyIDIgMCAwIDAgNCAyMWgxNmEyIDIgMCAwIDAgMS43My0zIiwKICAgICAga2V5OiAid21vZW5xIgogICAgfQogIF0sCiAgWyJwYXRoIiwgeyBkOiAiTTEyIDl2NCIsIGtleTogImp1enB1NyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTEyIDE3aC4wMSIsIGtleTogInAzMnAwNSIgfV0KXTsKdmFyIFRyaWFuZ2xlQWxlcnQgPSBjcmVhdGVMdWNpZGVJY29uKCJ0cmlhbmdsZS1hbGVydCIsIF9faWNvbk5vZGUyOSk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3dhbGxldC5qcwp2YXIgX19pY29uTm9kZTMwID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0xOSA3VjRhMSAxIDAgMCAwLTEtMUg1YTIgMiAwIDAgMCAwIDRoMTVhMSAxIDAgMCAxIDEgMXY0aC0zYTIgMiAwIDAgMCAwIDRoM2ExIDEgMCAwIDAgMS0xdi0yYTEgMSAwIDAgMC0xLTEiLAogICAgICBrZXk6ICIxOGV0YjYiCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNMyA1djE0YTIgMiAwIDAgMCAyIDJoMTVhMSAxIDAgMCAwIDEtMXYtNCIsIGtleTogInhvYzBxNCIgfV0KXTsKdmFyIFdhbGxldCA9IGNyZWF0ZUx1Y2lkZUljb24oIndhbGxldCIsIF9faWNvbk5vZGUzMCk7CgovLyBub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3guanMKdmFyIF9faWNvbk5vZGUzMSA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTggNiA2IDE4Iiwga2V5OiAiMWJsNWY4IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJtNiA2IDEyIDEyIiwga2V5OiAiZDhiazZ2IiB9XQpdOwp2YXIgWCA9IGNyZWF0ZUx1Y2lkZUljb24oIngiLCBfX2ljb25Ob2RlMzEpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250YWluZXIvU3VyZmFjZS5qcwp2YXIgUmVhY3QgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL2Nsc3gvZGlzdC9jbHN4Lm1qcwpmdW5jdGlvbiByKGUpIHsKICB2YXIgdCwgZiwgbiA9ICIiOwogIGlmICgic3RyaW5nIiA9PSB0eXBlb2YgZSB8fCAibnVtYmVyIiA9PSB0eXBlb2YgZSkgbiArPSBlOwogIGVsc2UgaWYgKCJvYmplY3QiID09IHR5cGVvZiBlKSBpZiAoQXJyYXkuaXNBcnJheShlKSkgewogICAgdmFyIG8gPSBlLmxlbmd0aDsKICAgIGZvciAodCA9IDA7IHQgPCBvOyB0KyspIGVbdF0gJiYgKGYgPSByKGVbdF0pKSAmJiAobiAmJiAobiArPSAiICIpLCBuICs9IGYpOwogIH0gZWxzZSBmb3IgKGYgaW4gZSkgZVtmXSAmJiAobiAmJiAobiArPSAiICIpLCBuICs9IGYpOwogIHJldHVybiBuOwp9CmZ1bmN0aW9uIGNsc3goKSB7CiAgZm9yICh2YXIgZSwgdCwgZiA9IDAsIG4gPSAiIiwgbyA9IGFyZ3VtZW50cy5sZW5ndGg7IGYgPCBvOyBmKyspIChlID0gYXJndW1lbnRzW2ZdKSAmJiAodCA9IHIoZSkpICYmIChuICYmIChuICs9ICIgIiksIG4gKz0gdCk7CiAgcmV0dXJuIG47Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zdmdQcm9wZXJ0aWVzQW5kRXZlbnRzLmpzCnZhciBpbXBvcnRfcmVhY3Q0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2V4Y2x1ZGVFdmVudFByb3BzLmpzCnZhciBFdmVudEtleXMgPSBbImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwgIm9uQ29weSIsICJvbkNvcHlDYXB0dXJlIiwgIm9uQ3V0IiwgIm9uQ3V0Q2FwdHVyZSIsICJvblBhc3RlIiwgIm9uUGFzdGVDYXB0dXJlIiwgIm9uQ29tcG9zaXRpb25FbmQiLCAib25Db21wb3NpdGlvbkVuZENhcHR1cmUiLCAib25Db21wb3NpdGlvblN0YXJ0IiwgIm9uQ29tcG9zaXRpb25TdGFydENhcHR1cmUiLCAib25Db21wb3NpdGlvblVwZGF0ZSIsICJvbkNvbXBvc2l0aW9uVXBkYXRlQ2FwdHVyZSIsICJvbkZvY3VzIiwgIm9uRm9jdXNDYXB0dXJlIiwgIm9uQmx1ciIsICJvbkJsdXJDYXB0dXJlIiwgIm9uQ2hhbmdlIiwgIm9uQ2hhbmdlQ2FwdHVyZSIsICJvbkJlZm9yZUlucHV0IiwgIm9uQmVmb3JlSW5wdXRDYXB0dXJlIiwgIm9uSW5wdXQiLCAib25JbnB1dENhcHR1cmUiLCAib25SZXNldCIsICJvblJlc2V0Q2FwdHVyZSIsICJvblN1Ym1pdCIsICJvblN1Ym1pdENhcHR1cmUiLCAib25JbnZhbGlkIiwgIm9uSW52YWxpZENhcHR1cmUiLCAib25Mb2FkIiwgIm9uTG9hZENhcHR1cmUiLCAib25FcnJvciIsICJvbkVycm9yQ2FwdHVyZSIsICJvbktleURvd24iLCAib25LZXlEb3duQ2FwdHVyZSIsICJvbktleVByZXNzIiwgIm9uS2V5UHJlc3NDYXB0dXJlIiwgIm9uS2V5VXAiLCAib25LZXlVcENhcHR1cmUiLCAib25BYm9ydCIsICJvbkFib3J0Q2FwdHVyZSIsICJvbkNhblBsYXkiLCAib25DYW5QbGF5Q2FwdHVyZSIsICJvbkNhblBsYXlUaHJvdWdoIiwgIm9uQ2FuUGxheVRocm91Z2hDYXB0dXJlIiwgIm9uRHVyYXRpb25DaGFuZ2UiLCAib25EdXJhdGlvbkNoYW5nZUNhcHR1cmUiLCAib25FbXB0aWVkIiwgIm9uRW1wdGllZENhcHR1cmUiLCAib25FbmNyeXB0ZWQiLCAib25FbmNyeXB0ZWRDYXB0dXJlIiwgIm9uRW5kZWQiLCAib25FbmRlZENhcHR1cmUiLCAib25Mb2FkZWREYXRhIiwgIm9uTG9hZGVkRGF0YUNhcHR1cmUiLCAib25Mb2FkZWRNZXRhZGF0YSIsICJvbkxvYWRlZE1ldGFkYXRhQ2FwdHVyZSIsICJvbkxvYWRTdGFydCIsICJvbkxvYWRTdGFydENhcHR1cmUiLCAib25QYXVzZSIsICJvblBhdXNlQ2FwdHVyZSIsICJvblBsYXkiLCAib25QbGF5Q2FwdHVyZSIsICJvblBsYXlpbmciLCAib25QbGF5aW5nQ2FwdHVyZSIsICJvblByb2dyZXNzIiwgIm9uUHJvZ3Jlc3NDYXB0dXJlIiwgIm9uUmF0ZUNoYW5nZSIsICJvblJhdGVDaGFuZ2VDYXB0dXJlIiwgIm9uU2Vla2VkIiwgIm9uU2Vla2VkQ2FwdHVyZSIsICJvblNlZWtpbmciLCAib25TZWVraW5nQ2FwdHVyZSIsICJvblN0YWxsZWQiLCAib25TdGFsbGVkQ2FwdHVyZSIsICJvblN1c3BlbmQiLCAib25TdXNwZW5kQ2FwdHVyZSIsICJvblRpbWVVcGRhdGUiLCAib25UaW1lVXBkYXRlQ2FwdHVyZSIsICJvblZvbHVtZUNoYW5nZSIsICJvblZvbHVtZUNoYW5nZUNhcHR1cmUiLCAib25XYWl0aW5nIiwgIm9uV2FpdGluZ0NhcHR1cmUiLCAib25BdXhDbGljayIsICJvbkF1eENsaWNrQ2FwdHVyZSIsICJvbkNsaWNrIiwgIm9uQ2xpY2tDYXB0dXJlIiwgIm9uQ29udGV4dE1lbnUiLCAib25Db250ZXh0TWVudUNhcHR1cmUiLCAib25Eb3VibGVDbGljayIsICJvbkRvdWJsZUNsaWNrQ2FwdHVyZSIsICJvbkRyYWciLCAib25EcmFnQ2FwdHVyZSIsICJvbkRyYWdFbmQiLCAib25EcmFnRW5kQ2FwdHVyZSIsICJvbkRyYWdFbnRlciIsICJvbkRyYWdFbnRlckNhcHR1cmUiLCAib25EcmFnRXhpdCIsICJvbkRyYWdFeGl0Q2FwdHVyZSIsICJvbkRyYWdMZWF2ZSIsICJvbkRyYWdMZWF2ZUNhcHR1cmUiLCAib25EcmFnT3ZlciIsICJvbkRyYWdPdmVyQ2FwdHVyZSIsICJvbkRyYWdTdGFydCIsICJvbkRyYWdTdGFydENhcHR1cmUiLCAib25Ecm9wIiwgIm9uRHJvcENhcHR1cmUiLCAib25Nb3VzZURvd24iLCAib25Nb3VzZURvd25DYXB0dXJlIiwgIm9uTW91c2VFbnRlciIsICJvbk1vdXNlTGVhdmUiLCAib25Nb3VzZU1vdmUiLCAib25Nb3VzZU1vdmVDYXB0dXJlIiwgIm9uTW91c2VPdXQiLCAib25Nb3VzZU91dENhcHR1cmUiLCAib25Nb3VzZU92ZXIiLCAib25Nb3VzZU92ZXJDYXB0dXJlIiwgIm9uTW91c2VVcCIsICJvbk1vdXNlVXBDYXB0dXJlIiwgIm9uU2VsZWN0IiwgIm9uU2VsZWN0Q2FwdHVyZSIsICJvblRvdWNoQ2FuY2VsIiwgIm9uVG91Y2hDYW5jZWxDYXB0dXJlIiwgIm9uVG91Y2hFbmQiLCAib25Ub3VjaEVuZENhcHR1cmUiLCAib25Ub3VjaE1vdmUiLCAib25Ub3VjaE1vdmVDYXB0dXJlIiwgIm9uVG91Y2hTdGFydCIsICJvblRvdWNoU3RhcnRDYXB0dXJlIiwgIm9uUG9pbnRlckRvd24iLCAib25Qb2ludGVyRG93bkNhcHR1cmUiLCAib25Qb2ludGVyTW92ZSIsICJvblBvaW50ZXJNb3ZlQ2FwdHVyZSIsICJvblBvaW50ZXJVcCIsICJvblBvaW50ZXJVcENhcHR1cmUiLCAib25Qb2ludGVyQ2FuY2VsIiwgIm9uUG9pbnRlckNhbmNlbENhcHR1cmUiLCAib25Qb2ludGVyRW50ZXIiLCAib25Qb2ludGVyRW50ZXJDYXB0dXJlIiwgIm9uUG9pbnRlckxlYXZlIiwgIm9uUG9pbnRlckxlYXZlQ2FwdHVyZSIsICJvblBvaW50ZXJPdmVyIiwgIm9uUG9pbnRlck92ZXJDYXB0dXJlIiwgIm9uUG9pbnRlck91dCIsICJvblBvaW50ZXJPdXRDYXB0dXJlIiwgIm9uR290UG9pbnRlckNhcHR1cmUiLCAib25Hb3RQb2ludGVyQ2FwdHVyZUNhcHR1cmUiLCAib25Mb3N0UG9pbnRlckNhcHR1cmUiLCAib25Mb3N0UG9pbnRlckNhcHR1cmVDYXB0dXJlIiwgIm9uU2Nyb2xsIiwgIm9uU2Nyb2xsQ2FwdHVyZSIsICJvbldoZWVsIiwgIm9uV2hlZWxDYXB0dXJlIiwgIm9uQW5pbWF0aW9uU3RhcnQiLCAib25BbmltYXRpb25TdGFydENhcHR1cmUiLCAib25BbmltYXRpb25FbmQiLCAib25BbmltYXRpb25FbmRDYXB0dXJlIiwgIm9uQW5pbWF0aW9uSXRlcmF0aW9uIiwgIm9uQW5pbWF0aW9uSXRlcmF0aW9uQ2FwdHVyZSIsICJvblRyYW5zaXRpb25FbmQiLCAib25UcmFuc2l0aW9uRW5kQ2FwdHVyZSJdOwpmdW5jdGlvbiBpc0V2ZW50S2V5KGtleSkgewogIGlmICh0eXBlb2Yga2V5ICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICB2YXIgYWxsb3dlZEV2ZW50S2V5cyA9IEV2ZW50S2V5czsKICByZXR1cm4gYWxsb3dlZEV2ZW50S2V5cy5pbmNsdWRlcyhrZXkpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc3ZnUHJvcGVydGllc05vRXZlbnRzLmpzCnZhciBpbXBvcnRfcmVhY3QzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgU1ZHRWxlbWVudFByb3BLZXlzID0gWwogICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiLAogICJhcmlhLWF0b21pYyIsCiAgImFyaWEtYXV0b2NvbXBsZXRlIiwKICAiYXJpYS1idXN5IiwKICAiYXJpYS1jaGVja2VkIiwKICAiYXJpYS1jb2xjb3VudCIsCiAgImFyaWEtY29saW5kZXgiLAogICJhcmlhLWNvbHNwYW4iLAogICJhcmlhLWNvbnRyb2xzIiwKICAiYXJpYS1jdXJyZW50IiwKICAiYXJpYS1kZXNjcmliZWRieSIsCiAgImFyaWEtZGV0YWlscyIsCiAgImFyaWEtZGlzYWJsZWQiLAogICJhcmlhLWVycm9ybWVzc2FnZSIsCiAgImFyaWEtZXhwYW5kZWQiLAogICJhcmlhLWZsb3d0byIsCiAgImFyaWEtaGFzcG9wdXAiLAogICJhcmlhLWhpZGRlbiIsCiAgImFyaWEtaW52YWxpZCIsCiAgImFyaWEta2V5c2hvcnRjdXRzIiwKICAiYXJpYS1sYWJlbCIsCiAgImFyaWEtbGFiZWxsZWRieSIsCiAgImFyaWEtbGV2ZWwiLAogICJhcmlhLWxpdmUiLAogICJhcmlhLW1vZGFsIiwKICAiYXJpYS1tdWx0aWxpbmUiLAogICJhcmlhLW11bHRpc2VsZWN0YWJsZSIsCiAgImFyaWEtb3JpZW50YXRpb24iLAogICJhcmlhLW93bnMiLAogICJhcmlhLXBsYWNlaG9sZGVyIiwKICAiYXJpYS1wb3NpbnNldCIsCiAgImFyaWEtcHJlc3NlZCIsCiAgImFyaWEtcmVhZG9ubHkiLAogICJhcmlhLXJlbGV2YW50IiwKICAiYXJpYS1yZXF1aXJlZCIsCiAgImFyaWEtcm9sZWRlc2NyaXB0aW9uIiwKICAiYXJpYS1yb3djb3VudCIsCiAgImFyaWEtcm93aW5kZXgiLAogICJhcmlhLXJvd3NwYW4iLAogICJhcmlhLXNlbGVjdGVkIiwKICAiYXJpYS1zZXRzaXplIiwKICAiYXJpYS1zb3J0IiwKICAiYXJpYS12YWx1ZW1heCIsCiAgImFyaWEtdmFsdWVtaW4iLAogICJhcmlhLXZhbHVlbm93IiwKICAiYXJpYS12YWx1ZXRleHQiLAogICJjbGFzc05hbWUiLAogICJjb2xvciIsCiAgImhlaWdodCIsCiAgImlkIiwKICAibGFuZyIsCiAgIm1heCIsCiAgIm1lZGlhIiwKICAibWV0aG9kIiwKICAibWluIiwKICAibmFtZSIsCiAgInN0eWxlIiwKICAvKgogICAqIHJlbW92ZWQgJ3R5cGUnIFNWR0VsZW1lbnRQcm9wS2V5IGJlY2F1c2Ugd2UgZG8gbm90IGN1cnJlbnRseSB1c2UgYW55IFNWRyBlbGVtZW50cwogICAqIHRoYXQgY2FuIHVzZSBpdCwgYW5kIGl0IGNvbmZsaWN0cyB3aXRoIHRoZSByZWNoYXJ0cyBwcm9wICd0eXBlJwogICAqIGh0dHBzOi8vZ2l0aHViLmNvbS9yZWNoYXJ0cy9yZWNoYXJ0cy9wdWxsLzMzMjcKICAgKiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9TVkcvQXR0cmlidXRlL3R5cGUKICAgKi8KICAvLyAndHlwZScsCiAgInRhcmdldCIsCiAgIndpZHRoIiwKICAicm9sZSIsCiAgInRhYkluZGV4IiwKICAiYWNjZW50SGVpZ2h0IiwKICAiYWNjdW11bGF0ZSIsCiAgImFkZGl0aXZlIiwKICAiYWxpZ25tZW50QmFzZWxpbmUiLAogICJhbGxvd1Jlb3JkZXIiLAogICJhbHBoYWJldGljIiwKICAiYW1wbGl0dWRlIiwKICAiYXJhYmljRm9ybSIsCiAgImFzY2VudCIsCiAgImF0dHJpYnV0ZU5hbWUiLAogICJhdHRyaWJ1dGVUeXBlIiwKICAiYXV0b1JldmVyc2UiLAogICJhemltdXRoIiwKICAiYmFzZUZyZXF1ZW5jeSIsCiAgImJhc2VsaW5lU2hpZnQiLAogICJiYXNlUHJvZmlsZSIsCiAgImJib3giLAogICJiZWdpbiIsCiAgImJpYXMiLAogICJieSIsCiAgImNhbGNNb2RlIiwKICAiY2FwSGVpZ2h0IiwKICAiY2xpcCIsCiAgImNsaXBQYXRoIiwKICAiY2xpcFBhdGhVbml0cyIsCiAgImNsaXBSdWxlIiwKICAiY29sb3JJbnRlcnBvbGF0aW9uIiwKICAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgImNvbG9yUHJvZmlsZSIsCiAgImNvbG9yUmVuZGVyaW5nIiwKICAiY29udGVudFNjcmlwdFR5cGUiLAogICJjb250ZW50U3R5bGVUeXBlIiwKICAiY3Vyc29yIiwKICAiY3giLAogICJjeSIsCiAgImQiLAogICJkZWNlbGVyYXRlIiwKICAiZGVzY2VudCIsCiAgImRpZmZ1c2VDb25zdGFudCIsCiAgImRpcmVjdGlvbiIsCiAgImRpc3BsYXkiLAogICJkaXZpc29yIiwKICAiZG9taW5hbnRCYXNlbGluZSIsCiAgImR1ciIsCiAgImR4IiwKICAiZHkiLAogICJlZGdlTW9kZSIsCiAgImVsZXZhdGlvbiIsCiAgImVuYWJsZUJhY2tncm91bmQiLAogICJlbmQiLAogICJleHBvbmVudCIsCiAgImV4dGVybmFsUmVzb3VyY2VzUmVxdWlyZWQiLAogICJmaWxsIiwKICAiZmlsbE9wYWNpdHkiLAogICJmaWxsUnVsZSIsCiAgImZpbHRlciIsCiAgImZpbHRlclJlcyIsCiAgImZpbHRlclVuaXRzIiwKICAiZmxvb2RDb2xvciIsCiAgImZsb29kT3BhY2l0eSIsCiAgImZvY3VzYWJsZSIsCiAgImZvbnRGYW1pbHkiLAogICJmb250U2l6ZSIsCiAgImZvbnRTaXplQWRqdXN0IiwKICAiZm9udFN0cmV0Y2giLAogICJmb250U3R5bGUiLAogICJmb250VmFyaWFudCIsCiAgImZvbnRXZWlnaHQiLAogICJmb3JtYXQiLAogICJmcm9tIiwKICAiZngiLAogICJmeSIsCiAgImcxIiwKICAiZzIiLAogICJnbHlwaE5hbWUiLAogICJnbHlwaE9yaWVudGF0aW9uSG9yaXpvbnRhbCIsCiAgImdseXBoT3JpZW50YXRpb25WZXJ0aWNhbCIsCiAgImdseXBoUmVmIiwKICAiZ3JhZGllbnRUcmFuc2Zvcm0iLAogICJncmFkaWVudFVuaXRzIiwKICAiaGFuZ2luZyIsCiAgImhvcml6QWR2WCIsCiAgImhvcml6T3JpZ2luWCIsCiAgImhyZWYiLAogICJpZGVvZ3JhcGhpYyIsCiAgImltYWdlUmVuZGVyaW5nIiwKICAiaW4yIiwKICAiaW4iLAogICJpbnRlcmNlcHQiLAogICJrMSIsCiAgImsyIiwKICAiazMiLAogICJrNCIsCiAgImsiLAogICJrZXJuZWxNYXRyaXgiLAogICJrZXJuZWxVbml0TGVuZ3RoIiwKICAia2VybmluZyIsCiAgImtleVBvaW50cyIsCiAgImtleVNwbGluZXMiLAogICJrZXlUaW1lcyIsCiAgImxlbmd0aEFkanVzdCIsCiAgImxldHRlclNwYWNpbmciLAogICJsaWdodGluZ0NvbG9yIiwKICAibGltaXRpbmdDb25lQW5nbGUiLAogICJsb2NhbCIsCiAgIm1hcmtlckVuZCIsCiAgIm1hcmtlckhlaWdodCIsCiAgIm1hcmtlck1pZCIsCiAgIm1hcmtlclN0YXJ0IiwKICAibWFya2VyVW5pdHMiLAogICJtYXJrZXJXaWR0aCIsCiAgIm1hc2siLAogICJtYXNrQ29udGVudFVuaXRzIiwKICAibWFza1VuaXRzIiwKICAibWF0aGVtYXRpY2FsIiwKICAibW9kZSIsCiAgIm51bU9jdGF2ZXMiLAogICJvZmZzZXQiLAogICJvcGFjaXR5IiwKICAib3BlcmF0b3IiLAogICJvcmRlciIsCiAgIm9yaWVudCIsCiAgIm9yaWVudGF0aW9uIiwKICAib3JpZ2luIiwKICAib3ZlcmZsb3ciLAogICJvdmVybGluZVBvc2l0aW9uIiwKICAib3ZlcmxpbmVUaGlja25lc3MiLAogICJwYWludE9yZGVyIiwKICAicGFub3NlMSIsCiAgInBhdGhMZW5ndGgiLAogICJwYXR0ZXJuQ29udGVudFVuaXRzIiwKICAicGF0dGVyblRyYW5zZm9ybSIsCiAgInBhdHRlcm5Vbml0cyIsCiAgInBvaW50ZXJFdmVudHMiLAogICJwb2ludHNBdFgiLAogICJwb2ludHNBdFkiLAogICJwb2ludHNBdFoiLAogICJwcmVzZXJ2ZUFscGhhIiwKICAicHJlc2VydmVBc3BlY3RSYXRpbyIsCiAgInByaW1pdGl2ZVVuaXRzIiwKICAiciIsCiAgInJhZGl1cyIsCiAgInJlZlgiLAogICJyZWZZIiwKICAicmVuZGVyaW5nSW50ZW50IiwKICAicmVwZWF0Q291bnQiLAogICJyZXBlYXREdXIiLAogICJyZXF1aXJlZEV4dGVuc2lvbnMiLAogICJyZXF1aXJlZEZlYXR1cmVzIiwKICAicmVzdGFydCIsCiAgInJlc3VsdCIsCiAgInJvdGF0ZSIsCiAgInJ4IiwKICAicnkiLAogICJzZWVkIiwKICAic2hhcGVSZW5kZXJpbmciLAogICJzbG9wZSIsCiAgInNwYWNpbmciLAogICJzcGVjdWxhckNvbnN0YW50IiwKICAic3BlY3VsYXJFeHBvbmVudCIsCiAgInNwZWVkIiwKICAic3ByZWFkTWV0aG9kIiwKICAic3RhcnRPZmZzZXQiLAogICJzdGREZXZpYXRpb24iLAogICJzdGVtaCIsCiAgInN0ZW12IiwKICAic3RpdGNoVGlsZXMiLAogICJzdG9wQ29sb3IiLAogICJzdG9wT3BhY2l0eSIsCiAgInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICJzdHJpbmciLAogICJzdHJva2UiLAogICJzdHJva2VEYXNoYXJyYXkiLAogICJzdHJva2VEYXNob2Zmc2V0IiwKICAic3Ryb2tlTGluZWNhcCIsCiAgInN0cm9rZUxpbmVqb2luIiwKICAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgInN0cm9rZU9wYWNpdHkiLAogICJzdHJva2VXaWR0aCIsCiAgInN1cmZhY2VTY2FsZSIsCiAgInN5c3RlbUxhbmd1YWdlIiwKICAidGFibGVWYWx1ZXMiLAogICJ0YXJnZXRYIiwKICAidGFyZ2V0WSIsCiAgInRleHRBbmNob3IiLAogICJ0ZXh0RGVjb3JhdGlvbiIsCiAgInRleHRMZW5ndGgiLAogICJ0ZXh0UmVuZGVyaW5nIiwKICAidG8iLAogICJ0cmFuc2Zvcm0iLAogICJ1MSIsCiAgInUyIiwKICAidW5kZXJsaW5lUG9zaXRpb24iLAogICJ1bmRlcmxpbmVUaGlja25lc3MiLAogICJ1bmljb2RlIiwKICAidW5pY29kZUJpZGkiLAogICJ1bmljb2RlUmFuZ2UiLAogICJ1bml0c1BlckVtIiwKICAidkFscGhhYmV0aWMiLAogICJ2YWx1ZXMiLAogICJ2ZWN0b3JFZmZlY3QiLAogICJ2ZXJzaW9uIiwKICAidmVydEFkdlkiLAogICJ2ZXJ0T3JpZ2luWCIsCiAgInZlcnRPcmlnaW5ZIiwKICAidkhhbmdpbmciLAogICJ2SWRlb2dyYXBoaWMiLAogICJ2aWV3VGFyZ2V0IiwKICAidmlzaWJpbGl0eSIsCiAgInZNYXRoZW1hdGljYWwiLAogICJ3aWR0aHMiLAogICJ3b3JkU3BhY2luZyIsCiAgIndyaXRpbmdNb2RlIiwKICAieDEiLAogICJ4MiIsCiAgIngiLAogICJ4Q2hhbm5lbFNlbGVjdG9yIiwKICAieEhlaWdodCIsCiAgInhsaW5rQWN0dWF0ZSIsCiAgInhsaW5rQXJjcm9sZSIsCiAgInhsaW5rSHJlZiIsCiAgInhsaW5rUm9sZSIsCiAgInhsaW5rU2hvdyIsCiAgInhsaW5rVGl0bGUiLAogICJ4bGlua1R5cGUiLAogICJ4bWxCYXNlIiwKICAieG1sTGFuZyIsCiAgInhtbG5zIiwKICAieG1sbnNYbGluayIsCiAgInhtbFNwYWNlIiwKICAieTEiLAogICJ5MiIsCiAgInkiLAogICJ5Q2hhbm5lbFNlbGVjdG9yIiwKICAieiIsCiAgInpvb21BbmRQYW4iLAogICJyZWYiLAogICJrZXkiLAogICJhbmdsZSIKXTsKdmFyIFNWR0VsZW1lbnRQcm9wS2V5U2V0ID0gbmV3IFNldChTVkdFbGVtZW50UHJvcEtleXMpOwpmdW5jdGlvbiBpc1N2Z0VsZW1lbnRQcm9wS2V5KGtleSkgewogIGlmICh0eXBlb2Yga2V5ICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gU1ZHRWxlbWVudFByb3BLZXlTZXQuaGFzKGtleSk7Cn0KZnVuY3Rpb24gaXNEYXRhQXR0cmlidXRlKGtleSkgewogIHJldHVybiB0eXBlb2Yga2V5ID09PSAic3RyaW5nIiAmJiBrZXkuc3RhcnRzV2l0aCgiZGF0YS0iKTsKfQpmdW5jdGlvbiBzdmdQcm9wZXJ0aWVzTm9FdmVudHMob2JqKSB7CiAgaWYgKHR5cGVvZiBvYmogIT09ICJvYmplY3QiIHx8IG9iaiA9PT0gbnVsbCkgewogICAgcmV0dXJuIHt9OwogIH0KICB2YXIgcmVzdWx0ID0ge307CiAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHsKICAgICAgaWYgKGlzU3ZnRWxlbWVudFByb3BLZXkoa2V5KSB8fCBpc0RhdGFBdHRyaWJ1dGUoa2V5KSkgewogICAgICAgIHJlc3VsdFtrZXldID0gb2JqW2tleV07CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiBzdmdQcm9wZXJ0aWVzTm9FdmVudHNGcm9tVW5rbm93bihpbnB1dCkgewogIGlmIChpbnB1dCA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0My5pc1ZhbGlkRWxlbWVudCkoaW5wdXQpICYmIHR5cGVvZiBpbnB1dC5wcm9wcyA9PT0gIm9iamVjdCIgJiYgaW5wdXQucHJvcHMgIT09IG51bGwpIHsKICAgIHZhciBwID0gaW5wdXQucHJvcHM7CiAgICByZXR1cm4gc3ZnUHJvcGVydGllc05vRXZlbnRzKHApOwogIH0KICBpZiAodHlwZW9mIGlucHV0ID09PSAib2JqZWN0IiAmJiAhQXJyYXkuaXNBcnJheShpbnB1dCkpIHsKICAgIHJldHVybiBzdmdQcm9wZXJ0aWVzTm9FdmVudHMoaW5wdXQpOwogIH0KICByZXR1cm4gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3N2Z1Byb3BlcnRpZXNBbmRFdmVudHMuanMKZnVuY3Rpb24gc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhvYmopIHsKICB2YXIgcmVzdWx0ID0ge307CiAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHsKICAgICAgaWYgKGlzU3ZnRWxlbWVudFByb3BLZXkoa2V5KSB8fCBpc0RhdGFBdHRyaWJ1dGUoa2V5KSB8fCBpc0V2ZW50S2V5KGtleSkpIHsKICAgICAgICByZXN1bHRba2V5XSA9IG9ialtrZXldOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gc3ZnUHJvcGVydGllc0FuZEV2ZW50c0Zyb21Vbmtub3duKGlucHV0KSB7CiAgaWYgKGlucHV0ID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0LmlzVmFsaWRFbGVtZW50KShpbnB1dCkpIHsKICAgIHJldHVybiBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKGlucHV0LnByb3BzKTsKICB9CiAgaWYgKHR5cGVvZiBpbnB1dCA9PT0gIm9iamVjdCIgJiYgIUFycmF5LmlzQXJyYXkoaW5wdXQpKSB7CiAgICByZXR1cm4gc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhpbnB1dCk7CiAgfQogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRhaW5lci9TdXJmYWNlLmpzCnZhciBfZXhjbHVkZWQgPSBbImNoaWxkcmVuIiwgIndpZHRoIiwgImhlaWdodCIsICJ2aWV3Qm94IiwgImNsYXNzTmFtZSIsICJzdHlsZSIsICJ0aXRsZSIsICJkZXNjIl07CmZ1bmN0aW9uIF9leHRlbmRzKCkgewogIHJldHVybiBfZXh0ZW5kcyA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZShyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIFN1cmZhY2UgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDUuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHZpZXdCb3gsCiAgICBjbGFzc05hbWUsCiAgICBzdHlsZSwKICAgIHRpdGxlLAogICAgZGVzYwogIH0gPSBwcm9wcywgb3RoZXJzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzKHByb3BzLCBfZXhjbHVkZWQpOwogIHZhciBzdmdWaWV3ID0gdmlld0JveCB8fCB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHg6IDAsCiAgICB5OiAwCiAgfTsKICB2YXIgbGF5ZXJDbGFzcyA9IGNsc3goInJlY2hhcnRzLXN1cmZhY2UiLCBjbGFzc05hbWUpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QuY3JlYXRlRWxlbWVudCgic3ZnIiwgX2V4dGVuZHMoe30sIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMob3RoZXJzKSwgewogICAgY2xhc3NOYW1lOiBsYXllckNsYXNzLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBzdHlsZSwKICAgIHZpZXdCb3g6ICIiLmNvbmNhdChzdmdWaWV3LngsICIgIikuY29uY2F0KHN2Z1ZpZXcueSwgIiAiKS5jb25jYXQoc3ZnVmlldy53aWR0aCwgIiAiKS5jb25jYXQoc3ZnVmlldy5oZWlnaHQpLAogICAgcmVmCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdC5jcmVhdGVFbGVtZW50KCJ0aXRsZSIsIG51bGwsIHRpdGxlKSwgLyogQF9fUFVSRV9fICovIFJlYWN0LmNyZWF0ZUVsZW1lbnQoImRlc2MiLCBudWxsLCBkZXNjKSwgY2hpbGRyZW4pOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL0xheWVyLmpzCnZhciBSZWFjdDIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQyID0gWyJjaGlsZHJlbiIsICJjbGFzc05hbWUiXTsKZnVuY3Rpb24gX2V4dGVuZHMyKCkgewogIHJldHVybiBfZXh0ZW5kczIgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczIuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMyKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UyKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UyKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgTGF5ZXIgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyLmZvcndhcmRSZWYoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICBjbGFzc05hbWUKICB9ID0gcHJvcHMsIG90aGVycyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczIocHJvcHMsIF9leGNsdWRlZDIpOwogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtbGF5ZXIiLCBjbGFzc05hbWUpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyLmNyZWF0ZUVsZW1lbnQoImciLCBfZXh0ZW5kczIoewogICAgY2xhc3NOYW1lOiBsYXllckNsYXNzCiAgfSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhvdGhlcnMpLCB7CiAgICByZWYKICB9KSwgY2hpbGRyZW4pOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9sZWdlbmRQb3J0YWxDb250ZXh0LmpzCnZhciBpbXBvcnRfcmVhY3Q2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgTGVnZW5kUG9ydGFsQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0Ni5jcmVhdGVDb250ZXh0KShudWxsKTsKCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY29uc3RhbnQuanMKZnVuY3Rpb24gY29uc3RhbnRfZGVmYXVsdCh4MikgewogIHJldHVybiBmdW5jdGlvbiBjb25zdGFudCgpIHsKICAgIHJldHVybiB4MjsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtcGF0aC9zcmMvcGF0aC5qcwp2YXIgcGkgPSBNYXRoLlBJOwp2YXIgdGF1ID0gMiAqIHBpOwp2YXIgZXBzaWxvbiA9IDFlLTY7CnZhciB0YXVFcHNpbG9uID0gdGF1IC0gZXBzaWxvbjsKZnVuY3Rpb24gYXBwZW5kKHN0cmluZ3MpIHsKICB0aGlzLl8gKz0gc3RyaW5nc1swXTsKICBmb3IgKGxldCBpID0gMSwgbiA9IHN0cmluZ3MubGVuZ3RoOyBpIDwgbjsgKytpKSB7CiAgICB0aGlzLl8gKz0gYXJndW1lbnRzW2ldICsgc3RyaW5nc1tpXTsKICB9Cn0KZnVuY3Rpb24gYXBwZW5kUm91bmQoZGlnaXRzKSB7CiAgbGV0IGQgPSBNYXRoLmZsb29yKGRpZ2l0cyk7CiAgaWYgKCEoZCA+PSAwKSkgdGhyb3cgbmV3IEVycm9yKGBpbnZhbGlkIGRpZ2l0czogJHtkaWdpdHN9YCk7CiAgaWYgKGQgPiAxNSkgcmV0dXJuIGFwcGVuZDsKICBjb25zdCBrID0gMTAgKiogZDsKICByZXR1cm4gZnVuY3Rpb24oc3RyaW5ncykgewogICAgdGhpcy5fICs9IHN0cmluZ3NbMF07CiAgICBmb3IgKGxldCBpID0gMSwgbiA9IHN0cmluZ3MubGVuZ3RoOyBpIDwgbjsgKytpKSB7CiAgICAgIHRoaXMuXyArPSBNYXRoLnJvdW5kKGFyZ3VtZW50c1tpXSAqIGspIC8gayArIHN0cmluZ3NbaV07CiAgICB9CiAgfTsKfQp2YXIgUGF0aCA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihkaWdpdHMpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feTAgPSAvLyBzdGFydCBvZiBjdXJyZW50IHN1YnBhdGgKICAgIHRoaXMuX3gxID0gdGhpcy5feTEgPSBudWxsOwogICAgdGhpcy5fID0gIiI7CiAgICB0aGlzLl9hcHBlbmQgPSBkaWdpdHMgPT0gbnVsbCA/IGFwcGVuZCA6IGFwcGVuZFJvdW5kKGRpZ2l0cyk7CiAgfQogIG1vdmVUbyh4MiwgeTIpIHsKICAgIHRoaXMuX2FwcGVuZGBNJHt0aGlzLl94MCA9IHRoaXMuX3gxID0gK3gyfSwke3RoaXMuX3kwID0gdGhpcy5feTEgPSAreTJ9YDsKICB9CiAgY2xvc2VQYXRoKCkgewogICAgaWYgKHRoaXMuX3gxICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX3gxID0gdGhpcy5feDAsIHRoaXMuX3kxID0gdGhpcy5feTA7CiAgICAgIHRoaXMuX2FwcGVuZGBaYDsKICAgIH0KICB9CiAgbGluZVRvKHgyLCB5MikgewogICAgdGhpcy5fYXBwZW5kYEwke3RoaXMuX3gxID0gK3gyfSwke3RoaXMuX3kxID0gK3kyfWA7CiAgfQogIHF1YWRyYXRpY0N1cnZlVG8oeDEsIHkxLCB4MiwgeTIpIHsKICAgIHRoaXMuX2FwcGVuZGBRJHsreDF9LCR7K3kxfSwke3RoaXMuX3gxID0gK3gyfSwke3RoaXMuX3kxID0gK3kyfWA7CiAgfQogIGJlemllckN1cnZlVG8oeDEsIHkxLCB4MiwgeTIsIHgzLCB5MykgewogICAgdGhpcy5fYXBwZW5kYEMkeyt4MX0sJHsreTF9LCR7K3gyfSwkeyt5Mn0sJHt0aGlzLl94MSA9ICt4M30sJHt0aGlzLl95MSA9ICt5M31gOwogIH0KICBhcmNUbyh4MSwgeTEsIHgyLCB5MiwgcjIpIHsKICAgIHgxID0gK3gxLCB5MSA9ICt5MSwgeDIgPSAreDIsIHkyID0gK3kyLCByMiA9ICtyMjsKICAgIGlmIChyMiA8IDApIHRocm93IG5ldyBFcnJvcihgbmVnYXRpdmUgcmFkaXVzOiAke3IyfWApOwogICAgbGV0IHgwID0gdGhpcy5feDEsIHkwID0gdGhpcy5feTEsIHgyMSA9IHgyIC0geDEsIHkyMSA9IHkyIC0geTEsIHgwMSA9IHgwIC0geDEsIHkwMSA9IHkwIC0geTEsIGwwMV8yID0geDAxICogeDAxICsgeTAxICogeTAxOwogICAgaWYgKHRoaXMuX3gxID09PSBudWxsKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBNJHt0aGlzLl94MSA9IHgxfSwke3RoaXMuX3kxID0geTF9YDsKICAgIH0gZWxzZSBpZiAoIShsMDFfMiA+IGVwc2lsb24pKSA7CiAgICBlbHNlIGlmICghKE1hdGguYWJzKHkwMSAqIHgyMSAtIHkyMSAqIHgwMSkgPiBlcHNpbG9uKSB8fCAhcjIpIHsKICAgICAgdGhpcy5fYXBwZW5kYEwke3RoaXMuX3gxID0geDF9LCR7dGhpcy5feTEgPSB5MX1gOwogICAgfSBlbHNlIHsKICAgICAgbGV0IHgyMCA9IHgyIC0geDAsIHkyMCA9IHkyIC0geTAsIGwyMV8yID0geDIxICogeDIxICsgeTIxICogeTIxLCBsMjBfMiA9IHgyMCAqIHgyMCArIHkyMCAqIHkyMCwgbDIxID0gTWF0aC5zcXJ0KGwyMV8yKSwgbDAxID0gTWF0aC5zcXJ0KGwwMV8yKSwgbCA9IHIyICogTWF0aC50YW4oKHBpIC0gTWF0aC5hY29zKChsMjFfMiArIGwwMV8yIC0gbDIwXzIpIC8gKDIgKiBsMjEgKiBsMDEpKSkgLyAyKSwgdDAxID0gbCAvIGwwMSwgdDIxID0gbCAvIGwyMTsKICAgICAgaWYgKE1hdGguYWJzKHQwMSAtIDEpID4gZXBzaWxvbikgewogICAgICAgIHRoaXMuX2FwcGVuZGBMJHt4MSArIHQwMSAqIHgwMX0sJHt5MSArIHQwMSAqIHkwMX1gOwogICAgICB9CiAgICAgIHRoaXMuX2FwcGVuZGBBJHtyMn0sJHtyMn0sMCwwLCR7Kyh5MDEgKiB4MjAgPiB4MDEgKiB5MjApfSwke3RoaXMuX3gxID0geDEgKyB0MjEgKiB4MjF9LCR7dGhpcy5feTEgPSB5MSArIHQyMSAqIHkyMX1gOwogICAgfQogIH0KICBhcmMoeDIsIHkyLCByMiwgYTAsIGExLCBjY3cpIHsKICAgIHgyID0gK3gyLCB5MiA9ICt5MiwgcjIgPSArcjIsIGNjdyA9ICEhY2N3OwogICAgaWYgKHIyIDwgMCkgdGhyb3cgbmV3IEVycm9yKGBuZWdhdGl2ZSByYWRpdXM6ICR7cjJ9YCk7CiAgICBsZXQgZHggPSByMiAqIE1hdGguY29zKGEwKSwgZHkgPSByMiAqIE1hdGguc2luKGEwKSwgeDAgPSB4MiArIGR4LCB5MCA9IHkyICsgZHksIGN3ID0gMSBeIGNjdywgZGEgPSBjY3cgPyBhMCAtIGExIDogYTEgLSBhMDsKICAgIGlmICh0aGlzLl94MSA9PT0gbnVsbCkgewogICAgICB0aGlzLl9hcHBlbmRgTSR7eDB9LCR7eTB9YDsKICAgIH0gZWxzZSBpZiAoTWF0aC5hYnModGhpcy5feDEgLSB4MCkgPiBlcHNpbG9uIHx8IE1hdGguYWJzKHRoaXMuX3kxIC0geTApID4gZXBzaWxvbikgewogICAgICB0aGlzLl9hcHBlbmRgTCR7eDB9LCR7eTB9YDsKICAgIH0KICAgIGlmICghcjIpIHJldHVybjsKICAgIGlmIChkYSA8IDApIGRhID0gZGEgJSB0YXUgKyB0YXU7CiAgICBpZiAoZGEgPiB0YXVFcHNpbG9uKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBBJHtyMn0sJHtyMn0sMCwxLCR7Y3d9LCR7eDIgLSBkeH0sJHt5MiAtIGR5fUEke3IyfSwke3IyfSwwLDEsJHtjd30sJHt0aGlzLl94MSA9IHgwfSwke3RoaXMuX3kxID0geTB9YDsKICAgIH0gZWxzZSBpZiAoZGEgPiBlcHNpbG9uKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBBJHtyMn0sJHtyMn0sMCwkeysoZGEgPj0gcGkpfSwke2N3fSwke3RoaXMuX3gxID0geDIgKyByMiAqIE1hdGguY29zKGExKX0sJHt0aGlzLl95MSA9IHkyICsgcjIgKiBNYXRoLnNpbihhMSl9YDsKICAgIH0KICB9CiAgcmVjdCh4MiwgeTIsIHcsIGgpIHsKICAgIHRoaXMuX2FwcGVuZGBNJHt0aGlzLl94MCA9IHRoaXMuX3gxID0gK3gyfSwke3RoaXMuX3kwID0gdGhpcy5feTEgPSAreTJ9aCR7dyA9ICt3fXYkeytofWgkey13fVpgOwogIH0KICB0b1N0cmluZygpIHsKICAgIHJldHVybiB0aGlzLl87CiAgfQp9OwpmdW5jdGlvbiBwYXRoKCkgewogIHJldHVybiBuZXcgUGF0aCgpOwp9CnBhdGgucHJvdG90eXBlID0gUGF0aC5wcm90b3R5cGU7CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL3BhdGguanMKZnVuY3Rpb24gd2l0aFBhdGgoc2hhcGUpIHsKICBsZXQgZGlnaXRzID0gMzsKICBzaGFwZS5kaWdpdHMgPSBmdW5jdGlvbihfKSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBkaWdpdHM7CiAgICBpZiAoXyA9PSBudWxsKSB7CiAgICAgIGRpZ2l0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBkID0gTWF0aC5mbG9vcihfKTsKICAgICAgaWYgKCEoZCA+PSAwKSkgdGhyb3cgbmV3IFJhbmdlRXJyb3IoYGludmFsaWQgZGlnaXRzOiAke199YCk7CiAgICAgIGRpZ2l0cyA9IGQ7CiAgICB9CiAgICByZXR1cm4gc2hhcGU7CiAgfTsKICByZXR1cm4gKCkgPT4gbmV3IFBhdGgoZGlnaXRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9hcnJheS5qcwp2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CmZ1bmN0aW9uIGFycmF5X2RlZmF1bHQoeDIpIHsKICByZXR1cm4gdHlwZW9mIHgyID09PSAib2JqZWN0IiAmJiAibGVuZ3RoIiBpbiB4MiA/IHgyIDogQXJyYXkuZnJvbSh4Mik7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvbGluZWFyLmpzCmZ1bmN0aW9uIExpbmVhcihjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KTGluZWFyLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IDA7CiAgfSwKICBhcmVhRW5kOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSBOYU47CiAgfSwKICBsaW5lU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIHRoaXMuX3BvaW50ID09PSAxKSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KfTsKZnVuY3Rpb24gbGluZWFyX2RlZmF1bHQoY29udGV4dCkgewogIHJldHVybiBuZXcgTGluZWFyKGNvbnRleHQpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL3BvaW50LmpzCmZ1bmN0aW9uIHgocCkgewogIHJldHVybiBwWzBdOwp9CmZ1bmN0aW9uIHkocCkgewogIHJldHVybiBwWzFdOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2xpbmUuanMKZnVuY3Rpb24gbGluZV9kZWZhdWx0KHgyLCB5MikgewogIHZhciBkZWZpbmVkMiA9IGNvbnN0YW50X2RlZmF1bHQodHJ1ZSksIGNvbnRleHQgPSBudWxsLCBjdXJ2ZSA9IGxpbmVhcl9kZWZhdWx0LCBvdXRwdXQgPSBudWxsLCBwYXRoMiA9IHdpdGhQYXRoKGxpbmUpOwogIHgyID0gdHlwZW9mIHgyID09PSAiZnVuY3Rpb24iID8geDIgOiB4MiA9PT0gdm9pZCAwID8geCA6IGNvbnN0YW50X2RlZmF1bHQoeDIpOwogIHkyID0gdHlwZW9mIHkyID09PSAiZnVuY3Rpb24iID8geTIgOiB5MiA9PT0gdm9pZCAwID8geSA6IGNvbnN0YW50X2RlZmF1bHQoeTIpOwogIGZ1bmN0aW9uIGxpbmUoZGF0YSkgewogICAgdmFyIGksIG4gPSAoZGF0YSA9IGFycmF5X2RlZmF1bHQoZGF0YSkpLmxlbmd0aCwgZCwgZGVmaW5lZDAgPSBmYWxzZSwgYnVmZmVyOwogICAgaWYgKGNvbnRleHQgPT0gbnVsbCkgb3V0cHV0ID0gY3VydmUoYnVmZmVyID0gcGF0aDIoKSk7CiAgICBmb3IgKGkgPSAwOyBpIDw9IG47ICsraSkgewogICAgICBpZiAoIShpIDwgbiAmJiBkZWZpbmVkMihkID0gZGF0YVtpXSwgaSwgZGF0YSkpID09PSBkZWZpbmVkMCkgewogICAgICAgIGlmIChkZWZpbmVkMCA9ICFkZWZpbmVkMCkgb3V0cHV0LmxpbmVTdGFydCgpOwogICAgICAgIGVsc2Ugb3V0cHV0LmxpbmVFbmQoKTsKICAgICAgfQogICAgICBpZiAoZGVmaW5lZDApIG91dHB1dC5wb2ludCgreDIoZCwgaSwgZGF0YSksICt5MihkLCBpLCBkYXRhKSk7CiAgICB9CiAgICBpZiAoYnVmZmVyKSByZXR1cm4gb3V0cHV0ID0gbnVsbCwgYnVmZmVyICsgIiIgfHwgbnVsbDsKICB9CiAgbGluZS54ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeDIgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgbGluZSkgOiB4MjsKICB9OwogIGxpbmUueSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHkyID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIGxpbmUpIDogeTI7CiAgfTsKICBsaW5lLmRlZmluZWQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkZWZpbmVkMiA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoISFfKSwgbGluZSkgOiBkZWZpbmVkMjsKICB9OwogIGxpbmUuY3VydmUgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChjdXJ2ZSA9IF8sIGNvbnRleHQgIT0gbnVsbCAmJiAob3V0cHV0ID0gY3VydmUoY29udGV4dCkpLCBsaW5lKSA6IGN1cnZlOwogIH07CiAgbGluZS5jb250ZXh0ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoXyA9PSBudWxsID8gY29udGV4dCA9IG91dHB1dCA9IG51bGwgOiBvdXRwdXQgPSBjdXJ2ZShjb250ZXh0ID0gXyksIGxpbmUpIDogY29udGV4dDsKICB9OwogIHJldHVybiBsaW5lOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2FyZWEuanMKZnVuY3Rpb24gYXJlYV9kZWZhdWx0KHgwLCB5MCwgeTEpIHsKICB2YXIgeDEgPSBudWxsLCBkZWZpbmVkMiA9IGNvbnN0YW50X2RlZmF1bHQodHJ1ZSksIGNvbnRleHQgPSBudWxsLCBjdXJ2ZSA9IGxpbmVhcl9kZWZhdWx0LCBvdXRwdXQgPSBudWxsLCBwYXRoMiA9IHdpdGhQYXRoKGFyZWEpOwogIHgwID0gdHlwZW9mIHgwID09PSAiZnVuY3Rpb24iID8geDAgOiB4MCA9PT0gdm9pZCAwID8geCA6IGNvbnN0YW50X2RlZmF1bHQoK3gwKTsKICB5MCA9IHR5cGVvZiB5MCA9PT0gImZ1bmN0aW9uIiA/IHkwIDogeTAgPT09IHZvaWQgMCA/IGNvbnN0YW50X2RlZmF1bHQoMCkgOiBjb25zdGFudF9kZWZhdWx0KCt5MCk7CiAgeTEgPSB0eXBlb2YgeTEgPT09ICJmdW5jdGlvbiIgPyB5MSA6IHkxID09PSB2b2lkIDAgPyB5IDogY29uc3RhbnRfZGVmYXVsdCgreTEpOwogIGZ1bmN0aW9uIGFyZWEoZGF0YSkgewogICAgdmFyIGksIGosIGssIG4gPSAoZGF0YSA9IGFycmF5X2RlZmF1bHQoZGF0YSkpLmxlbmd0aCwgZCwgZGVmaW5lZDAgPSBmYWxzZSwgYnVmZmVyLCB4MHogPSBuZXcgQXJyYXkobiksIHkweiA9IG5ldyBBcnJheShuKTsKICAgIGlmIChjb250ZXh0ID09IG51bGwpIG91dHB1dCA9IGN1cnZlKGJ1ZmZlciA9IHBhdGgyKCkpOwogICAgZm9yIChpID0gMDsgaSA8PSBuOyArK2kpIHsKICAgICAgaWYgKCEoaSA8IG4gJiYgZGVmaW5lZDIoZCA9IGRhdGFbaV0sIGksIGRhdGEpKSA9PT0gZGVmaW5lZDApIHsKICAgICAgICBpZiAoZGVmaW5lZDAgPSAhZGVmaW5lZDApIHsKICAgICAgICAgIGogPSBpOwogICAgICAgICAgb3V0cHV0LmFyZWFTdGFydCgpOwogICAgICAgICAgb3V0cHV0LmxpbmVTdGFydCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvdXRwdXQubGluZUVuZCgpOwogICAgICAgICAgb3V0cHV0LmxpbmVTdGFydCgpOwogICAgICAgICAgZm9yIChrID0gaSAtIDE7IGsgPj0gajsgLS1rKSB7CiAgICAgICAgICAgIG91dHB1dC5wb2ludCh4MHpba10sIHkweltrXSk7CiAgICAgICAgICB9CiAgICAgICAgICBvdXRwdXQubGluZUVuZCgpOwogICAgICAgICAgb3V0cHV0LmFyZWFFbmQoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQwKSB7CiAgICAgICAgeDB6W2ldID0gK3gwKGQsIGksIGRhdGEpLCB5MHpbaV0gPSAreTAoZCwgaSwgZGF0YSk7CiAgICAgICAgb3V0cHV0LnBvaW50KHgxID8gK3gxKGQsIGksIGRhdGEpIDogeDB6W2ldLCB5MSA/ICt5MShkLCBpLCBkYXRhKSA6IHkweltpXSk7CiAgICAgIH0KICAgIH0KICAgIGlmIChidWZmZXIpIHJldHVybiBvdXRwdXQgPSBudWxsLCBidWZmZXIgKyAiIiB8fCBudWxsOwogIH0KICBmdW5jdGlvbiBhcmVhbGluZSgpIHsKICAgIHJldHVybiBsaW5lX2RlZmF1bHQoKS5kZWZpbmVkKGRlZmluZWQyKS5jdXJ2ZShjdXJ2ZSkuY29udGV4dChjb250ZXh0KTsKICB9CiAgYXJlYS54ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeDAgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgeDEgPSBudWxsLCBhcmVhKSA6IHgwOwogIH07CiAgYXJlYS54MCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHgwID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIGFyZWEpIDogeDA7CiAgfTsKICBhcmVhLngxID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeDEgPSBfID09IG51bGwgPyBudWxsIDogdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIGFyZWEpIDogeDE7CiAgfTsKICBhcmVhLnkgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh5MCA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCB5MSA9IG51bGwsIGFyZWEpIDogeTA7CiAgfTsKICBhcmVhLnkwID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeTAgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgYXJlYSkgOiB5MDsKICB9OwogIGFyZWEueTEgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh5MSA9IF8gPT0gbnVsbCA/IG51bGwgOiB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgYXJlYSkgOiB5MTsKICB9OwogIGFyZWEubGluZVgwID0gYXJlYS5saW5lWTAgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBhcmVhbGluZSgpLngoeDApLnkoeTApOwogIH07CiAgYXJlYS5saW5lWTEgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBhcmVhbGluZSgpLngoeDApLnkoeTEpOwogIH07CiAgYXJlYS5saW5lWDEgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBhcmVhbGluZSgpLngoeDEpLnkoeTApOwogIH07CiAgYXJlYS5kZWZpbmVkID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZGVmaW5lZDIgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCEhXyksIGFyZWEpIDogZGVmaW5lZDI7CiAgfTsKICBhcmVhLmN1cnZlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoY3VydmUgPSBfLCBjb250ZXh0ICE9IG51bGwgJiYgKG91dHB1dCA9IGN1cnZlKGNvbnRleHQpKSwgYXJlYSkgOiBjdXJ2ZTsKICB9OwogIGFyZWEuY29udGV4dCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKF8gPT0gbnVsbCA/IGNvbnRleHQgPSBvdXRwdXQgPSBudWxsIDogb3V0cHV0ID0gY3VydmUoY29udGV4dCA9IF8pLCBhcmVhKSA6IGNvbnRleHQ7CiAgfTsKICByZXR1cm4gYXJlYTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9idW1wLmpzCnZhciBCdW1wID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGNvbnRleHQsIHgyKSB7CiAgICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKICAgIHRoaXMuX3ggPSB4MjsKICB9CiAgYXJlYVN0YXJ0KCkgewogICAgdGhpcy5fbGluZSA9IDA7CiAgfQogIGFyZWFFbmQoKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0KICBsaW5lU3RhcnQoKSB7CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfQogIGxpbmVFbmQoKSB7CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIHRoaXMuX3BvaW50ID09PSAxKSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0KICBwb2ludCh4MiwgeTIpIHsKICAgIHgyID0gK3gyLCB5MiA9ICt5MjsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAwOiB7CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIGlmICh0aGlzLl9saW5lKSB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpOwogICAgICAgIGVsc2UgdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICBkZWZhdWx0OiB7CiAgICAgICAgaWYgKHRoaXMuX3gpIHRoaXMuX2NvbnRleHQuYmV6aWVyQ3VydmVUbyh0aGlzLl94MCA9ICh0aGlzLl94MCArIHgyKSAvIDIsIHRoaXMuX3kwLCB0aGlzLl94MCwgeTIsIHgyLCB5Mik7CiAgICAgICAgZWxzZSB0aGlzLl9jb250ZXh0LmJlemllckN1cnZlVG8odGhpcy5feDAsIHRoaXMuX3kwID0gKHRoaXMuX3kwICsgeTIpIC8gMiwgeDIsIHRoaXMuX3kwLCB4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICB0aGlzLl94MCA9IHgyLCB0aGlzLl95MCA9IHkyOwogIH0KfTsKZnVuY3Rpb24gYnVtcFgoY29udGV4dCkgewogIHJldHVybiBuZXcgQnVtcChjb250ZXh0LCB0cnVlKTsKfQpmdW5jdGlvbiBidW1wWShjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBCdW1wKGNvbnRleHQsIGZhbHNlKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9ub29wLmpzCmZ1bmN0aW9uIG5vb3BfZGVmYXVsdCgpIHsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9iYXNpcy5qcwpmdW5jdGlvbiBwb2ludCh0aGF0LCB4MiwgeTIpIHsKICB0aGF0Ll9jb250ZXh0LmJlemllckN1cnZlVG8oCiAgICAoMiAqIHRoYXQuX3gwICsgdGhhdC5feDEpIC8gMywKICAgICgyICogdGhhdC5feTAgKyB0aGF0Ll95MSkgLyAzLAogICAgKHRoYXQuX3gwICsgMiAqIHRoYXQuX3gxKSAvIDMsCiAgICAodGhhdC5feTAgKyAyICogdGhhdC5feTEpIC8gMywKICAgICh0aGF0Ll94MCArIDQgKiB0aGF0Ll94MSArIHgyKSAvIDYsCiAgICAodGhhdC5feTAgKyA0ICogdGhhdC5feTEgKyB5MikgLyA2CiAgKTsKfQpmdW5jdGlvbiBCYXNpcyhjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KQmFzaXMucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9LAogIGFyZWFFbmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxID0gdGhpcy5feTAgPSB0aGlzLl95MSA9IE5hTjsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDM6CiAgICAgICAgcG9pbnQodGhpcywgdGhpcy5feDEsIHRoaXMuX3kxKTsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHRoaXMuX3gxLCB0aGlzLl95MSk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIHRoaXMuX3BvaW50ID09PSAxKSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX3BvaW50ID0gMzsKICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbygoNSAqIHRoaXMuX3gwICsgdGhpcy5feDEpIC8gNiwgKDUgKiB0aGlzLl95MCArIHRoaXMuX3kxKSAvIDYpOwogICAgICBkZWZhdWx0OgogICAgICAgIHBvaW50KHRoaXMsIHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxLCB0aGlzLl94MSA9IHgyOwogICAgdGhpcy5feTAgPSB0aGlzLl95MSwgdGhpcy5feTEgPSB5MjsKICB9Cn07CmZ1bmN0aW9uIGJhc2lzX2RlZmF1bHQoY29udGV4dCkgewogIHJldHVybiBuZXcgQmFzaXMoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvYmFzaXNDbG9zZWQuanMKZnVuY3Rpb24gQmFzaXNDbG9zZWQoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9CkJhc2lzQ2xvc2VkLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IG5vb3BfZGVmYXVsdCwKICBhcmVhRW5kOiBub29wX2RlZmF1bHQsCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feDEgPSB0aGlzLl94MiA9IHRoaXMuX3gzID0gdGhpcy5feDQgPSB0aGlzLl95MCA9IHRoaXMuX3kxID0gdGhpcy5feTIgPSB0aGlzLl95MyA9IHRoaXMuX3k0ID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMTogewogICAgICAgIHRoaXMuX2NvbnRleHQubW92ZVRvKHRoaXMuX3gyLCB0aGlzLl95Mik7CiAgICAgICAgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlIDI6IHsKICAgICAgICB0aGlzLl9jb250ZXh0Lm1vdmVUbygodGhpcy5feDIgKyAyICogdGhpcy5feDMpIC8gMywgKHRoaXMuX3kyICsgMiAqIHRoaXMuX3kzKSAvIDMpOwogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKCh0aGlzLl94MyArIDIgKiB0aGlzLl94MikgLyAzLCAodGhpcy5feTMgKyAyICogdGhpcy5feTIpIC8gMyk7CiAgICAgICAgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgICBjYXNlIDM6IHsKICAgICAgICB0aGlzLnBvaW50KHRoaXMuX3gyLCB0aGlzLl95Mik7CiAgICAgICAgdGhpcy5wb2ludCh0aGlzLl94MywgdGhpcy5feTMpOwogICAgICAgIHRoaXMucG9pbnQodGhpcy5feDQsIHRoaXMuX3k0KTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX3gyID0geDIsIHRoaXMuX3kyID0geTI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLl9wb2ludCA9IDI7CiAgICAgICAgdGhpcy5feDMgPSB4MiwgdGhpcy5feTMgPSB5MjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX3BvaW50ID0gMzsKICAgICAgICB0aGlzLl94NCA9IHgyLCB0aGlzLl95NCA9IHkyOwogICAgICAgIHRoaXMuX2NvbnRleHQubW92ZVRvKCh0aGlzLl94MCArIDQgKiB0aGlzLl94MSArIHgyKSAvIDYsICh0aGlzLl95MCArIDQgKiB0aGlzLl95MSArIHkyKSAvIDYpOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICAgIHBvaW50KHRoaXMsIHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxLCB0aGlzLl94MSA9IHgyOwogICAgdGhpcy5feTAgPSB0aGlzLl95MSwgdGhpcy5feTEgPSB5MjsKICB9Cn07CmZ1bmN0aW9uIGJhc2lzQ2xvc2VkX2RlZmF1bHQoY29udGV4dCkgewogIHJldHVybiBuZXcgQmFzaXNDbG9zZWQoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvYmFzaXNPcGVuLmpzCmZ1bmN0aW9uIEJhc2lzT3Blbihjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KQmFzaXNPcGVuLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IDA7CiAgfSwKICBhcmVhRW5kOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSBOYU47CiAgfSwKICBsaW5lU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5feDAgPSB0aGlzLl94MSA9IHRoaXMuX3kwID0gdGhpcy5feTEgPSBOYU47CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgdGhpcy5fcG9pbnQgPT09IDMpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMDoKICAgICAgICB0aGlzLl9wb2ludCA9IDE7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLl9wb2ludCA9IDI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLl9wb2ludCA9IDM7CiAgICAgICAgdmFyIHgwID0gKHRoaXMuX3gwICsgNCAqIHRoaXMuX3gxICsgeDIpIC8gNiwgeTAgPSAodGhpcy5feTAgKyA0ICogdGhpcy5feTEgKyB5MikgLyA2OwogICAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MCwgeTApIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDAsIHkwKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAzOgogICAgICAgIHRoaXMuX3BvaW50ID0gNDsKICAgICAgZGVmYXVsdDoKICAgICAgICBwb2ludCh0aGlzLCB4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgfQogICAgdGhpcy5feDAgPSB0aGlzLl94MSwgdGhpcy5feDEgPSB4MjsKICAgIHRoaXMuX3kwID0gdGhpcy5feTEsIHRoaXMuX3kxID0geTI7CiAgfQp9OwpmdW5jdGlvbiBiYXNpc09wZW5fZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBCYXNpc09wZW4oY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvbGluZWFyQ2xvc2VkLmpzCmZ1bmN0aW9uIExpbmVhckNsb3NlZChjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KTGluZWFyQ2xvc2VkLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IG5vb3BfZGVmYXVsdCwKICBhcmVhRW5kOiBub29wX2RlZmF1bHQsCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuX3BvaW50KSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgaWYgKHRoaXMuX3BvaW50KSB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpOwogICAgZWxzZSB0aGlzLl9wb2ludCA9IDEsIHRoaXMuX2NvbnRleHQubW92ZVRvKHgyLCB5Mik7CiAgfQp9OwpmdW5jdGlvbiBsaW5lYXJDbG9zZWRfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBMaW5lYXJDbG9zZWQoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvbW9ub3RvbmUuanMKZnVuY3Rpb24gc2lnbih4MikgewogIHJldHVybiB4MiA8IDAgPyAtMSA6IDE7Cn0KZnVuY3Rpb24gc2xvcGUzKHRoYXQsIHgyLCB5MikgewogIHZhciBoMCA9IHRoYXQuX3gxIC0gdGhhdC5feDAsIGgxID0geDIgLSB0aGF0Ll94MSwgczAgPSAodGhhdC5feTEgLSB0aGF0Ll95MCkgLyAoaDAgfHwgaDEgPCAwICYmIC0wKSwgczEgPSAoeTIgLSB0aGF0Ll95MSkgLyAoaDEgfHwgaDAgPCAwICYmIC0wKSwgcCA9IChzMCAqIGgxICsgczEgKiBoMCkgLyAoaDAgKyBoMSk7CiAgcmV0dXJuIChzaWduKHMwKSArIHNpZ24oczEpKSAqIE1hdGgubWluKE1hdGguYWJzKHMwKSwgTWF0aC5hYnMoczEpLCAwLjUgKiBNYXRoLmFicyhwKSkgfHwgMDsKfQpmdW5jdGlvbiBzbG9wZTIodGhhdCwgdCkgewogIHZhciBoID0gdGhhdC5feDEgLSB0aGF0Ll94MDsKICByZXR1cm4gaCA/ICgzICogKHRoYXQuX3kxIC0gdGhhdC5feTApIC8gaCAtIHQpIC8gMiA6IHQ7Cn0KZnVuY3Rpb24gcG9pbnQyKHRoYXQsIHQwMiwgdDEyKSB7CiAgdmFyIHgwID0gdGhhdC5feDAsIHkwID0gdGhhdC5feTAsIHgxID0gdGhhdC5feDEsIHkxID0gdGhhdC5feTEsIGR4ID0gKHgxIC0geDApIC8gMzsKICB0aGF0Ll9jb250ZXh0LmJlemllckN1cnZlVG8oeDAgKyBkeCwgeTAgKyBkeCAqIHQwMiwgeDEgLSBkeCwgeTEgLSBkeCAqIHQxMiwgeDEsIHkxKTsKfQpmdW5jdGlvbiBNb25vdG9uZVgoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9Ck1vbm90b25lWC5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feDEgPSB0aGlzLl95MCA9IHRoaXMuX3kxID0gdGhpcy5fdDAgPSBOYU47CiAgICB0aGlzLl9wb2ludCA9IDA7CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHRoaXMuX3gxLCB0aGlzLl95MSk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMzoKICAgICAgICBwb2ludDIodGhpcywgdGhpcy5fdDAsIHNsb3BlMih0aGlzLCB0aGlzLl90MCkpOwogICAgICAgIGJyZWFrOwogICAgfQogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiB0aGlzLl9wb2ludCA9PT0gMSkgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIHRoaXMuX2xpbmUgPSAxIC0gdGhpcy5fbGluZTsKICB9LAogIHBvaW50OiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHZhciB0MTIgPSBOYU47CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBpZiAoeDIgPT09IHRoaXMuX3gxICYmIHkyID09PSB0aGlzLl95MSkgcmV0dXJuOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX3BvaW50ID0gMzsKICAgICAgICBwb2ludDIodGhpcywgc2xvcGUyKHRoaXMsIHQxMiA9IHNsb3BlMyh0aGlzLCB4MiwgeTIpKSwgdDEyKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBwb2ludDIodGhpcywgdGhpcy5fdDAsIHQxMiA9IHNsb3BlMyh0aGlzLCB4MiwgeTIpKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIHRoaXMuX3gwID0gdGhpcy5feDEsIHRoaXMuX3gxID0geDI7CiAgICB0aGlzLl95MCA9IHRoaXMuX3kxLCB0aGlzLl95MSA9IHkyOwogICAgdGhpcy5fdDAgPSB0MTI7CiAgfQp9OwpmdW5jdGlvbiBNb25vdG9uZVkoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBuZXcgUmVmbGVjdENvbnRleHQoY29udGV4dCk7Cn0KKE1vbm90b25lWS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKE1vbm90b25lWC5wcm90b3R5cGUpKS5wb2ludCA9IGZ1bmN0aW9uKHgyLCB5MikgewogIE1vbm90b25lWC5wcm90b3R5cGUucG9pbnQuY2FsbCh0aGlzLCB5MiwgeDIpOwp9OwpmdW5jdGlvbiBSZWZsZWN0Q29udGV4dChjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KUmVmbGVjdENvbnRleHQucHJvdG90eXBlID0gewogIG1vdmVUbzogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB0aGlzLl9jb250ZXh0Lm1vdmVUbyh5MiwgeDIpOwogIH0sCiAgY2xvc2VQYXRoOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgfSwKICBsaW5lVG86IGZ1bmN0aW9uKHgyLCB5MikgewogICAgdGhpcy5fY29udGV4dC5saW5lVG8oeTIsIHgyKTsKICB9LAogIGJlemllckN1cnZlVG86IGZ1bmN0aW9uKHgxLCB5MSwgeDIsIHkyLCB4MywgeTMpIHsKICAgIHRoaXMuX2NvbnRleHQuYmV6aWVyQ3VydmVUbyh5MSwgeDEsIHkyLCB4MiwgeTMsIHgzKTsKICB9Cn07CmZ1bmN0aW9uIG1vbm90b25lWChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBNb25vdG9uZVgoY29udGV4dCk7Cn0KZnVuY3Rpb24gbW9ub3RvbmVZKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IE1vbm90b25lWShjb250ZXh0KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9uYXR1cmFsLmpzCmZ1bmN0aW9uIE5hdHVyYWwoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9Ck5hdHVyYWwucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9LAogIGFyZWFFbmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl94ID0gW107CiAgICB0aGlzLl95ID0gW107CiAgfSwKICBsaW5lRW5kOiBmdW5jdGlvbigpIHsKICAgIHZhciB4MiA9IHRoaXMuX3gsIHkyID0gdGhpcy5feSwgbiA9IHgyLmxlbmd0aDsKICAgIGlmIChuKSB7CiAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MlswXSwgeTJbMF0pIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDJbMF0sIHkyWzBdKTsKICAgICAgaWYgKG4gPT09IDIpIHsKICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MlsxXSwgeTJbMV0pOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBweCA9IGNvbnRyb2xQb2ludHMoeDIpLCBweSA9IGNvbnRyb2xQb2ludHMoeTIpOwogICAgICAgIGZvciAodmFyIGkwID0gMCwgaTEgPSAxOyBpMSA8IG47ICsraTAsICsraTEpIHsKICAgICAgICAgIHRoaXMuX2NvbnRleHQuYmV6aWVyQ3VydmVUbyhweFswXVtpMF0sIHB5WzBdW2kwXSwgcHhbMV1baTBdLCBweVsxXVtpMF0sIHgyW2kxXSwgeTJbaTFdKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgbiA9PT0gMSkgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIHRoaXMuX2xpbmUgPSAxIC0gdGhpcy5fbGluZTsKICAgIHRoaXMuX3ggPSB0aGlzLl95ID0gbnVsbDsKICB9LAogIHBvaW50OiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHRoaXMuX3gucHVzaCgreDIpOwogICAgdGhpcy5feS5wdXNoKCt5Mik7CiAgfQp9OwpmdW5jdGlvbiBjb250cm9sUG9pbnRzKHgyKSB7CiAgdmFyIGksIG4gPSB4Mi5sZW5ndGggLSAxLCBtLCBhID0gbmV3IEFycmF5KG4pLCBiID0gbmV3IEFycmF5KG4pLCByMiA9IG5ldyBBcnJheShuKTsKICBhWzBdID0gMCwgYlswXSA9IDIsIHIyWzBdID0geDJbMF0gKyAyICogeDJbMV07CiAgZm9yIChpID0gMTsgaSA8IG4gLSAxOyArK2kpIGFbaV0gPSAxLCBiW2ldID0gNCwgcjJbaV0gPSA0ICogeDJbaV0gKyAyICogeDJbaSArIDFdOwogIGFbbiAtIDFdID0gMiwgYltuIC0gMV0gPSA3LCByMltuIC0gMV0gPSA4ICogeDJbbiAtIDFdICsgeDJbbl07CiAgZm9yIChpID0gMTsgaSA8IG47ICsraSkgbSA9IGFbaV0gLyBiW2kgLSAxXSwgYltpXSAtPSBtLCByMltpXSAtPSBtICogcjJbaSAtIDFdOwogIGFbbiAtIDFdID0gcjJbbiAtIDFdIC8gYltuIC0gMV07CiAgZm9yIChpID0gbiAtIDI7IGkgPj0gMDsgLS1pKSBhW2ldID0gKHIyW2ldIC0gYVtpICsgMV0pIC8gYltpXTsKICBiW24gLSAxXSA9ICh4MltuXSArIGFbbiAtIDFdKSAvIDI7CiAgZm9yIChpID0gMDsgaSA8IG4gLSAxOyArK2kpIGJbaV0gPSAyICogeDJbaSArIDFdIC0gYVtpICsgMV07CiAgcmV0dXJuIFthLCBiXTsKfQpmdW5jdGlvbiBuYXR1cmFsX2RlZmF1bHQoY29udGV4dCkgewogIHJldHVybiBuZXcgTmF0dXJhbChjb250ZXh0KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9zdGVwLmpzCmZ1bmN0aW9uIFN0ZXAoY29udGV4dCwgdCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0OwogIHRoaXMuX3QgPSB0Owp9ClN0ZXAucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9LAogIGFyZWFFbmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl94ID0gdGhpcy5feSA9IE5hTjsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgaWYgKDAgPCB0aGlzLl90ICYmIHRoaXMuX3QgPCAxICYmIHRoaXMuX3BvaW50ID09PSAyKSB0aGlzLl9jb250ZXh0LmxpbmVUbyh0aGlzLl94LCB0aGlzLl95KTsKICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgdGhpcy5fcG9pbnQgPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICBpZiAodGhpcy5fbGluZSA+PSAwKSB0aGlzLl90ID0gMSAtIHRoaXMuX3QsIHRoaXMuX2xpbmUgPSAxIC0gdGhpcy5fbGluZTsKICB9LAogIHBvaW50OiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHgyID0gK3gyLCB5MiA9ICt5MjsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMuX3BvaW50ID0gMTsKICAgICAgICB0aGlzLl9saW5lID8gdGhpcy5fY29udGV4dC5saW5lVG8oeDIsIHkyKSA6IHRoaXMuX2NvbnRleHQubW92ZVRvKHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLl9wb2ludCA9IDI7CiAgICAgIGRlZmF1bHQ6IHsKICAgICAgICBpZiAodGhpcy5fdCA8PSAwKSB7CiAgICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbyh0aGlzLl94LCB5Mik7CiAgICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgeDEgPSB0aGlzLl94ICogKDEgLSB0aGlzLl90KSArIHgyICogdGhpcy5fdDsKICAgICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHgxLCB0aGlzLl95KTsKICAgICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHgxLCB5Mik7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICB0aGlzLl94ID0geDIsIHRoaXMuX3kgPSB5MjsKICB9Cn07CmZ1bmN0aW9uIHN0ZXBfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBTdGVwKGNvbnRleHQsIDAuNSk7Cn0KZnVuY3Rpb24gc3RlcEJlZm9yZShjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBTdGVwKGNvbnRleHQsIDApOwp9CmZ1bmN0aW9uIHN0ZXBBZnRlcihjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBTdGVwKGNvbnRleHQsIDEpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL29mZnNldC9ub25lLmpzCmZ1bmN0aW9uIG5vbmVfZGVmYXVsdChzZXJpZXMsIG9yZGVyKSB7CiAgaWYgKCEoKG4gPSBzZXJpZXMubGVuZ3RoKSA+IDEpKSByZXR1cm47CiAgZm9yICh2YXIgaSA9IDEsIGosIHMwLCBzMSA9IHNlcmllc1tvcmRlclswXV0sIG4sIG0gPSBzMS5sZW5ndGg7IGkgPCBuOyArK2kpIHsKICAgIHMwID0gczEsIHMxID0gc2VyaWVzW29yZGVyW2ldXTsKICAgIGZvciAoaiA9IDA7IGogPCBtOyArK2opIHsKICAgICAgczFbal1bMV0gKz0gczFbal1bMF0gPSBpc05hTihzMFtqXVsxXSkgPyBzMFtqXVswXSA6IHMwW2pdWzFdOwogICAgfQogIH0KfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9vcmRlci9ub25lLmpzCmZ1bmN0aW9uIG5vbmVfZGVmYXVsdDIoc2VyaWVzKSB7CiAgdmFyIG4gPSBzZXJpZXMubGVuZ3RoLCBvID0gbmV3IEFycmF5KG4pOwogIHdoaWxlICgtLW4gPj0gMCkgb1tuXSA9IG47CiAgcmV0dXJuIG87Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvc3RhY2suanMKZnVuY3Rpb24gc3RhY2tWYWx1ZShkLCBrZXkpIHsKICByZXR1cm4gZFtrZXldOwp9CmZ1bmN0aW9uIHN0YWNrU2VyaWVzKGtleSkgewogIGNvbnN0IHNlcmllcyA9IFtdOwogIHNlcmllcy5rZXkgPSBrZXk7CiAgcmV0dXJuIHNlcmllczsKfQpmdW5jdGlvbiBzdGFja19kZWZhdWx0KCkgewogIHZhciBrZXlzID0gY29uc3RhbnRfZGVmYXVsdChbXSksIG9yZGVyID0gbm9uZV9kZWZhdWx0Miwgb2Zmc2V0ID0gbm9uZV9kZWZhdWx0LCB2YWx1ZSA9IHN0YWNrVmFsdWU7CiAgZnVuY3Rpb24gc3RhY2soZGF0YSkgewogICAgdmFyIHN6ID0gQXJyYXkuZnJvbShrZXlzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyksIHN0YWNrU2VyaWVzKSwgaSwgbiA9IHN6Lmxlbmd0aCwgaiA9IC0xLCBvejsKICAgIGZvciAoY29uc3QgZCBvZiBkYXRhKSB7CiAgICAgIGZvciAoaSA9IDAsICsrajsgaSA8IG47ICsraSkgewogICAgICAgIChzeltpXVtqXSA9IFswLCArdmFsdWUoZCwgc3pbaV0ua2V5LCBqLCBkYXRhKV0pLmRhdGEgPSBkOwogICAgICB9CiAgICB9CiAgICBmb3IgKGkgPSAwLCBveiA9IGFycmF5X2RlZmF1bHQob3JkZXIoc3opKTsgaSA8IG47ICsraSkgewogICAgICBzeltveltpXV0uaW5kZXggPSBpOwogICAgfQogICAgb2Zmc2V0KHN6LCBveik7CiAgICByZXR1cm4gc3o7CiAgfQogIHN0YWNrLmtleXMgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChrZXlzID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdChBcnJheS5mcm9tKF8pKSwgc3RhY2spIDoga2V5czsKICB9OwogIHN0YWNrLnZhbHVlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodmFsdWUgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgc3RhY2spIDogdmFsdWU7CiAgfTsKICBzdGFjay5vcmRlciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKG9yZGVyID0gXyA9PSBudWxsID8gbm9uZV9kZWZhdWx0MiA6IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoQXJyYXkuZnJvbShfKSksIHN0YWNrKSA6IG9yZGVyOwogIH07CiAgc3RhY2sub2Zmc2V0ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAob2Zmc2V0ID0gXyA9PSBudWxsID8gbm9uZV9kZWZhdWx0IDogXywgc3RhY2spIDogb2Zmc2V0OwogIH07CiAgcmV0dXJuIHN0YWNrOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL29mZnNldC9leHBhbmQuanMKZnVuY3Rpb24gZXhwYW5kX2RlZmF1bHQoc2VyaWVzLCBvcmRlcikgewogIGlmICghKChuID0gc2VyaWVzLmxlbmd0aCkgPiAwKSkgcmV0dXJuOwogIGZvciAodmFyIGksIG4sIGogPSAwLCBtID0gc2VyaWVzWzBdLmxlbmd0aCwgeTI7IGogPCBtOyArK2opIHsKICAgIGZvciAoeTIgPSBpID0gMDsgaSA8IG47ICsraSkgeTIgKz0gc2VyaWVzW2ldW2pdWzFdIHx8IDA7CiAgICBpZiAoeTIpIGZvciAoaSA9IDA7IGkgPCBuOyArK2kpIHNlcmllc1tpXVtqXVsxXSAvPSB5MjsKICB9CiAgbm9uZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL29mZnNldC9zaWxob3VldHRlLmpzCmZ1bmN0aW9uIHNpbGhvdWV0dGVfZGVmYXVsdChzZXJpZXMsIG9yZGVyKSB7CiAgaWYgKCEoKG4gPSBzZXJpZXMubGVuZ3RoKSA+IDApKSByZXR1cm47CiAgZm9yICh2YXIgaiA9IDAsIHMwID0gc2VyaWVzW29yZGVyWzBdXSwgbiwgbSA9IHMwLmxlbmd0aDsgaiA8IG07ICsraikgewogICAgZm9yICh2YXIgaSA9IDAsIHkyID0gMDsgaSA8IG47ICsraSkgeTIgKz0gc2VyaWVzW2ldW2pdWzFdIHx8IDA7CiAgICBzMFtqXVsxXSArPSBzMFtqXVswXSA9IC15MiAvIDI7CiAgfQogIG5vbmVfZGVmYXVsdChzZXJpZXMsIG9yZGVyKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9vZmZzZXQvd2lnZ2xlLmpzCmZ1bmN0aW9uIHdpZ2dsZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpIHsKICBpZiAoISgobiA9IHNlcmllcy5sZW5ndGgpID4gMCkgfHwgISgobSA9IChzMCA9IHNlcmllc1tvcmRlclswXV0pLmxlbmd0aCkgPiAwKSkgcmV0dXJuOwogIGZvciAodmFyIHkyID0gMCwgaiA9IDEsIHMwLCBtLCBuOyBqIDwgbTsgKytqKSB7CiAgICBmb3IgKHZhciBpID0gMCwgczEgPSAwLCBzMiA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgdmFyIHNpID0gc2VyaWVzW29yZGVyW2ldXSwgc2lqMCA9IHNpW2pdWzFdIHx8IDAsIHNpajEgPSBzaVtqIC0gMV1bMV0gfHwgMCwgczMgPSAoc2lqMCAtIHNpajEpIC8gMjsKICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBpOyArK2spIHsKICAgICAgICB2YXIgc2sgPSBzZXJpZXNbb3JkZXJba11dLCBza2owID0gc2tbal1bMV0gfHwgMCwgc2tqMSA9IHNrW2ogLSAxXVsxXSB8fCAwOwogICAgICAgIHMzICs9IHNrajAgLSBza2oxOwogICAgICB9CiAgICAgIHMxICs9IHNpajAsIHMyICs9IHMzICogc2lqMDsKICAgIH0KICAgIHMwW2ogLSAxXVsxXSArPSBzMFtqIC0gMV1bMF0gPSB5MjsKICAgIGlmIChzMSkgeTIgLT0gczIgLyBzMTsKICB9CiAgczBbaiAtIDFdWzFdICs9IHMwW2ogLSAxXVswXSA9IHkyOwogIG5vbmVfZGVmYXVsdChzZXJpZXMsIG9yZGVyKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0RhdGFVdGlscy5qcwp2YXIgaW1wb3J0X2dldCA9IF9fdG9FU00ocmVxdWlyZV9nZXQyKCkpOwp2YXIgbWF0aFNpZ24gPSAodmFsdWUpID0+IHsKICBpZiAodmFsdWUgPT09IDApIHsKICAgIHJldHVybiAwOwogIH0KICBpZiAodmFsdWUgPiAwKSB7CiAgICByZXR1cm4gMTsKICB9CiAgcmV0dXJuIC0xOwp9Owp2YXIgaXNOYW4gPSAodmFsdWUpID0+IHsKICByZXR1cm4gdHlwZW9mIHZhbHVlID09ICJudW1iZXIiICYmIHZhbHVlICE9ICt2YWx1ZTsKfTsKdmFyIGlzUGVyY2VudCA9ICh2YWx1ZSkgPT4gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCIlIikgPT09IHZhbHVlLmxlbmd0aCAtIDE7CnZhciBpc051bWJlciA9ICh2YWx1ZSkgPT4gKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgfHwgdmFsdWUgaW5zdGFuY2VvZiBOdW1iZXIpICYmICFpc05hbih2YWx1ZSk7CnZhciBpc051bU9yU3RyID0gKHZhbHVlKSA9PiBpc051bWJlcih2YWx1ZSkgfHwgdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIjsKdmFyIGlkQ291bnRlciA9IDA7CnZhciB1bmlxdWVJZCA9IChwcmVmaXgpID0+IHsKICB2YXIgaWQgPSArK2lkQ291bnRlcjsKICByZXR1cm4gIiIuY29uY2F0KHByZWZpeCB8fCAiIikuY29uY2F0KGlkKTsKfTsKdmFyIGdldFBlcmNlbnRWYWx1ZSA9IGZ1bmN0aW9uIGdldFBlcmNlbnRWYWx1ZTIocGVyY2VudCwgdG90YWxWYWx1ZSkgewogIHZhciBkZWZhdWx0VmFsdWUgPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiBhcmd1bWVudHNbMl0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1syXSA6IDA7CiAgdmFyIHZhbGlkYXRlID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbM10gOiBmYWxzZTsKICBpZiAoIWlzTnVtYmVyKHBlcmNlbnQpICYmIHR5cGVvZiBwZXJjZW50ICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICB9CiAgdmFyIHZhbHVlOwogIGlmIChpc1BlcmNlbnQocGVyY2VudCkpIHsKICAgIGlmICh0b3RhbFZhbHVlID09IG51bGwpIHsKICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgIH0KICAgIHZhciBpbmRleCA9IHBlcmNlbnQuaW5kZXhPZigiJSIpOwogICAgdmFsdWUgPSB0b3RhbFZhbHVlICogcGFyc2VGbG9hdChwZXJjZW50LnNsaWNlKDAsIGluZGV4KSkgLyAxMDA7CiAgfSBlbHNlIHsKICAgIHZhbHVlID0gK3BlcmNlbnQ7CiAgfQogIGlmIChpc05hbih2YWx1ZSkpIHsKICAgIHZhbHVlID0gZGVmYXVsdFZhbHVlOwogIH0KICBpZiAodmFsaWRhdGUgJiYgdG90YWxWYWx1ZSAhPSBudWxsICYmIHZhbHVlID4gdG90YWxWYWx1ZSkgewogICAgdmFsdWUgPSB0b3RhbFZhbHVlOwogIH0KICByZXR1cm4gdmFsdWU7Cn07CnZhciBoYXNEdXBsaWNhdGUgPSAoYXJ5KSA9PiB7CiAgaWYgKCFBcnJheS5pc0FycmF5KGFyeSkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgdmFyIGxlbiA9IGFyeS5sZW5ndGg7CiAgdmFyIGNhY2hlID0ge307CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgaWYgKCFjYWNoZVthcnlbaV1dKSB7CiAgICAgIGNhY2hlW2FyeVtpXV0gPSB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfTsKZnVuY3Rpb24gaW50ZXJwb2xhdGUoc3RhcnQsIGVuZCwgdCkgewogIGlmIChpc051bWJlcihzdGFydCkgJiYgaXNOdW1iZXIoZW5kKSkgewogICAgcmV0dXJuIHN0YXJ0ICsgdCAqIChlbmQgLSBzdGFydCk7CiAgfQogIHJldHVybiBlbmQ7Cn0KZnVuY3Rpb24gZmluZEVudHJ5SW5BcnJheShhcnksIHNwZWNpZmllZEtleSwgc3BlY2lmaWVkVmFsdWUpIHsKICBpZiAoIWFyeSB8fCAhYXJ5Lmxlbmd0aCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGFyeS5maW5kKChlbnRyeSkgPT4gZW50cnkgJiYgKHR5cGVvZiBzcGVjaWZpZWRLZXkgPT09ICJmdW5jdGlvbiIgPyBzcGVjaWZpZWRLZXkoZW50cnkpIDogKDAsIGltcG9ydF9nZXQuZGVmYXVsdCkoZW50cnksIHNwZWNpZmllZEtleSkpID09PSBzcGVjaWZpZWRWYWx1ZSk7Cn0KdmFyIGlzTnVsbGlzaCA9ICh2YWx1ZSkgPT4gewogIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJ1bmRlZmluZWQiOwp9Owp2YXIgdXBwZXJGaXJzdCA9ICh2YWx1ZSkgPT4gewogIGlmIChpc051bGxpc2godmFsdWUpKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIHJldHVybiAiIi5jb25jYXQodmFsdWUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkpLmNvbmNhdCh2YWx1ZS5zbGljZSgxKSk7Cn07CmZ1bmN0aW9uIGlzTm90TmlsKHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlICE9IG51bGw7Cn0KZnVuY3Rpb24gbm9vcCgpIHsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3R5cGVzLmpzCnZhciBpbXBvcnRfcmVhY3Q3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaXNQb2xhckNvb3JkaW5hdGUgPSAoYykgPT4gewogIHJldHVybiAicmFkaXVzIiBpbiBjICYmICJzdGFydEFuZ2xlIiBpbiBjICYmICJlbmRBbmdsZSIgaW4gYzsKfTsKdmFyIGFkYXB0RXZlbnRIYW5kbGVycyA9IChwcm9wcywgbmV3SGFuZGxlcikgPT4gewogIGlmICghcHJvcHMgfHwgdHlwZW9mIHByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBwcm9wcyA9PT0gImJvb2xlYW4iKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGlucHV0UHJvcHMgPSBwcm9wczsKICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q3LmlzVmFsaWRFbGVtZW50KShwcm9wcykpIHsKICAgIGlucHV0UHJvcHMgPSBwcm9wcy5wcm9wczsKICB9CiAgaWYgKHR5cGVvZiBpbnB1dFByb3BzICE9PSAib2JqZWN0IiAmJiB0eXBlb2YgaW5wdXRQcm9wcyAhPT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBvdXQgPSB7fTsKICBPYmplY3Qua2V5cyhpbnB1dFByb3BzKS5mb3JFYWNoKChrZXkpID0+IHsKICAgIGlmIChpc0V2ZW50S2V5KGtleSkpIHsKICAgICAgb3V0W2tleV0gPSBuZXdIYW5kbGVyIHx8ICgoZSkgPT4gaW5wdXRQcm9wc1trZXldKGlucHV0UHJvcHMsIGUpKTsKICAgIH0KICB9KTsKICByZXR1cm4gb3V0Owp9Owp2YXIgZ2V0RXZlbnRIYW5kbGVyT2ZDaGlsZCA9IChvcmlnaW5hbEhhbmRsZXIsIGRhdGEsIGluZGV4KSA9PiAoZSkgPT4gewogIG9yaWdpbmFsSGFuZGxlcihkYXRhLCBpbmRleCwgZSk7CiAgcmV0dXJuIG51bGw7Cn07CnZhciBhZGFwdEV2ZW50c09mQ2hpbGQgPSAocHJvcHMsIGRhdGEsIGluZGV4KSA9PiB7CiAgaWYgKHByb3BzID09PSBudWxsIHx8IHR5cGVvZiBwcm9wcyAhPT0gIm9iamVjdCIgJiYgdHlwZW9mIHByb3BzICE9PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIG91dCA9IG51bGw7CiAgT2JqZWN0LmtleXMocHJvcHMpLmZvckVhY2goKGtleSkgPT4gewogICAgdmFyIGl0ZW0gPSBwcm9wc1trZXldOwogICAgaWYgKGlzRXZlbnRLZXkoa2V5KSAmJiB0eXBlb2YgaXRlbSA9PT0gImZ1bmN0aW9uIikgewogICAgICBpZiAoIW91dCkgb3V0ID0ge307CiAgICAgIG91dFtrZXldID0gZ2V0RXZlbnRIYW5kbGVyT2ZDaGlsZChpdGVtLCBkYXRhLCBpbmRleCk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIG91dDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9yZXNvbHZlRGVmYXVsdFByb3BzLmpzCmZ1bmN0aW9uIG93bktleXMoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gcmVzb2x2ZURlZmF1bHRQcm9wcyhyZWFsUHJvcHMsIGRlZmF1bHRQcm9wcykgewogIHZhciByZXNvbHZlZFByb3BzID0gX29iamVjdFNwcmVhZCh7fSwgcmVhbFByb3BzKTsKICB2YXIgZHAgPSBkZWZhdWx0UHJvcHM7CiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhkZWZhdWx0UHJvcHMpOwogIHZhciB3aXRoRGVmYXVsdHMgPSBrZXlzLnJlZHVjZSgoYWNjLCBrZXkpID0+IHsKICAgIGlmIChhY2Nba2V5XSA9PT0gdm9pZCAwICYmIGRwW2tleV0gIT09IHZvaWQgMCkgewogICAgICBhY2Nba2V5XSA9IGRwW2tleV07CiAgICB9CiAgICByZXR1cm4gYWNjOwogIH0sIHJlc29sdmVkUHJvcHMpOwogIHJldHVybiB3aXRoRGVmYXVsdHM7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9wYXlsb2FkL2dldFVuaXFQYXlsb2FkLmpzCnZhciBpbXBvcnRfdW5pcUJ5ID0gX190b0VTTShyZXF1aXJlX3VuaXFCeTMoKSk7CmZ1bmN0aW9uIGdldFVuaXFQYXlsb2FkKHBheWxvYWQsIG9wdGlvbiwgZGVmYXVsdFVuaXFCeTIpIHsKICBpZiAob3B0aW9uID09PSB0cnVlKSB7CiAgICByZXR1cm4gKDAsIGltcG9ydF91bmlxQnkuZGVmYXVsdCkocGF5bG9hZCwgZGVmYXVsdFVuaXFCeTIpOwogIH0KICBpZiAodHlwZW9mIG9wdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuICgwLCBpbXBvcnRfdW5pcUJ5LmRlZmF1bHQpKHBheWxvYWQsIG9wdGlvbik7CiAgfQogIHJldHVybiBwYXlsb2FkOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2hvb2tzLmpzCnZhciBpbXBvcnRfd2l0aF9zZWxlY3RvciA9IF9fdG9FU00ocmVxdWlyZV93aXRoX3NlbGVjdG9yKCkpOwp2YXIgaW1wb3J0X3JlYWN0OSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvUmVjaGFydHNSZWR1eENvbnRleHQuanMKdmFyIGltcG9ydF9yZWFjdDggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBSZWNoYXJ0c1JlZHV4Q29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0OC5jcmVhdGVDb250ZXh0KShudWxsKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvaG9va3MuanMKdmFyIG5vb3BEaXNwYXRjaCA9IChhKSA9PiBhOwp2YXIgdXNlQXBwRGlzcGF0Y2ggPSAoKSA9PiB7CiAgdmFyIGNvbnRleHQgPSAoMCwgaW1wb3J0X3JlYWN0OS51c2VDb250ZXh0KShSZWNoYXJ0c1JlZHV4Q29udGV4dCk7CiAgaWYgKGNvbnRleHQpIHsKICAgIHJldHVybiBjb250ZXh0LnN0b3JlLmRpc3BhdGNoOwogIH0KICByZXR1cm4gbm9vcERpc3BhdGNoOwp9Owp2YXIgbm9vcDIgPSAoKSA9PiB7Cn07CnZhciBhZGROZXN0ZWRTdWJOb29wID0gKCkgPT4gbm9vcDI7CnZhciByZWZFcXVhbGl0eSA9IChhLCBiKSA9PiBhID09PSBiOwpmdW5jdGlvbiB1c2VBcHBTZWxlY3RvcihzZWxlY3RvcikgewogIHZhciBjb250ZXh0ID0gKDAsIGltcG9ydF9yZWFjdDkudXNlQ29udGV4dCkoUmVjaGFydHNSZWR1eENvbnRleHQpOwogIHJldHVybiAoMCwgaW1wb3J0X3dpdGhfc2VsZWN0b3IudXNlU3luY0V4dGVybmFsU3RvcmVXaXRoU2VsZWN0b3IpKGNvbnRleHQgPyBjb250ZXh0LnN1YnNjcmlwdGlvbi5hZGROZXN0ZWRTdWIgOiBhZGROZXN0ZWRTdWJOb29wLCBjb250ZXh0ID8gY29udGV4dC5zdG9yZS5nZXRTdGF0ZSA6IG5vb3AyLCBjb250ZXh0ID8gY29udGV4dC5zdG9yZS5nZXRTdGF0ZSA6IG5vb3AyLCBjb250ZXh0ID8gc2VsZWN0b3IgOiBub29wMiwgcmVmRXF1YWxpdHkpOwp9CgovLyBub2RlX21vZHVsZXMvcmVzZWxlY3QvZGlzdC9yZXNlbGVjdC5tanMKdmFyIHJ1bklkZW50aXR5RnVuY3Rpb25DaGVjayA9IChyZXN1bHRGdW5jLCBpbnB1dFNlbGVjdG9yc1Jlc3VsdHMsIG91dHB1dFNlbGVjdG9yUmVzdWx0KSA9PiB7CiAgaWYgKGlucHV0U2VsZWN0b3JzUmVzdWx0cy5sZW5ndGggPT09IDEgJiYgaW5wdXRTZWxlY3RvcnNSZXN1bHRzWzBdID09PSBvdXRwdXRTZWxlY3RvclJlc3VsdCkgewogICAgbGV0IGlzSW5wdXRTYW1lQXNPdXRwdXQgPSBmYWxzZTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IGVtcHR5T2JqZWN0ID0ge307CiAgICAgIGlmIChyZXN1bHRGdW5jKGVtcHR5T2JqZWN0KSA9PT0gZW1wdHlPYmplY3QpCiAgICAgICAgaXNJbnB1dFNhbWVBc091dHB1dCA9IHRydWU7CiAgICB9IGNhdGNoIHsKICAgIH0KICAgIGlmIChpc0lucHV0U2FtZUFzT3V0cHV0KSB7CiAgICAgIGxldCBzdGFjayA9IHZvaWQgMDsKICAgICAgdHJ5IHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIDsKICAgICAgICAoeyBzdGFjayB9ID0gZSk7CiAgICAgIH0KICAgICAgY29uc29sZS53YXJuKAogICAgICAgICJUaGUgcmVzdWx0IGZ1bmN0aW9uIHJldHVybmVkIGl0cyBvd24gaW5wdXRzIHdpdGhvdXQgbW9kaWZpY2F0aW9uLiBlLmdcbmBjcmVhdGVTZWxlY3Rvcihbc3RhdGUgPT4gc3RhdGUudG9kb3NdLCB0b2RvcyA9PiB0b2RvcylgXG5UaGlzIGNvdWxkIGxlYWQgdG8gaW5lZmZpY2llbnQgbWVtb2l6YXRpb24gYW5kIHVubmVjZXNzYXJ5IHJlLXJlbmRlcnMuXG5FbnN1cmUgdHJhbnNmb3JtYXRpb24gbG9naWMgaXMgaW4gdGhlIHJlc3VsdCBmdW5jdGlvbiwgYW5kIGV4dHJhY3Rpb24gbG9naWMgaXMgaW4gdGhlIGlucHV0IHNlbGVjdG9ycy4iLAogICAgICAgIHsgc3RhY2sgfQogICAgICApOwogICAgfQogIH0KfTsKdmFyIHJ1bklucHV0U3RhYmlsaXR5Q2hlY2sgPSAoaW5wdXRTZWxlY3RvclJlc3VsdHNPYmplY3QsIG9wdGlvbnMsIGlucHV0U2VsZWN0b3JBcmdzKSA9PiB7CiAgY29uc3QgeyBtZW1vaXplLCBtZW1vaXplT3B0aW9ucyB9ID0gb3B0aW9uczsKICBjb25zdCB7IGlucHV0U2VsZWN0b3JSZXN1bHRzLCBpbnB1dFNlbGVjdG9yUmVzdWx0c0NvcHkgfSA9IGlucHV0U2VsZWN0b3JSZXN1bHRzT2JqZWN0OwogIGNvbnN0IGNyZWF0ZUFuRW1wdHlPYmplY3QgPSBtZW1vaXplKCgpID0+ICh7fSksIC4uLm1lbW9pemVPcHRpb25zKTsKICBjb25zdCBhcmVJbnB1dFNlbGVjdG9yUmVzdWx0c0VxdWFsID0gY3JlYXRlQW5FbXB0eU9iamVjdC5hcHBseShudWxsLCBpbnB1dFNlbGVjdG9yUmVzdWx0cykgPT09IGNyZWF0ZUFuRW1wdHlPYmplY3QuYXBwbHkobnVsbCwgaW5wdXRTZWxlY3RvclJlc3VsdHNDb3B5KTsKICBpZiAoIWFyZUlucHV0U2VsZWN0b3JSZXN1bHRzRXF1YWwpIHsKICAgIGxldCBzdGFjayA9IHZvaWQgMDsKICAgIHRyeSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgfSBjYXRjaCAoZSkgewogICAgICA7CiAgICAgICh7IHN0YWNrIH0gPSBlKTsKICAgIH0KICAgIGNvbnNvbGUud2FybigKICAgICAgIkFuIGlucHV0IHNlbGVjdG9yIHJldHVybmVkIGEgZGlmZmVyZW50IHJlc3VsdCB3aGVuIHBhc3NlZCBzYW1lIGFyZ3VtZW50cy5cblRoaXMgbWVhbnMgeW91ciBvdXRwdXQgc2VsZWN0b3Igd2lsbCBsaWtlbHkgcnVuIG1vcmUgZnJlcXVlbnRseSB0aGFuIGludGVuZGVkLlxuQXZvaWQgcmV0dXJuaW5nIGEgbmV3IHJlZmVyZW5jZSBpbnNpZGUgeW91ciBpbnB1dCBzZWxlY3RvciwgZS5nLlxuYGNyZWF0ZVNlbGVjdG9yKFtzdGF0ZSA9PiBzdGF0ZS50b2Rvcy5tYXAodG9kbyA9PiB0b2RvLmlkKV0sIHRvZG9JZHMgPT4gdG9kb0lkcy5sZW5ndGgpYCIsCiAgICAgIHsKICAgICAgICBhcmd1bWVudHM6IGlucHV0U2VsZWN0b3JBcmdzLAogICAgICAgIGZpcnN0SW5wdXRzOiBpbnB1dFNlbGVjdG9yUmVzdWx0cywKICAgICAgICBzZWNvbmRJbnB1dHM6IGlucHV0U2VsZWN0b3JSZXN1bHRzQ29weSwKICAgICAgICBzdGFjawogICAgICB9CiAgICApOwogIH0KfTsKdmFyIGdsb2JhbERldk1vZGVDaGVja3MgPSB7CiAgaW5wdXRTdGFiaWxpdHlDaGVjazogIm9uY2UiLAogIGlkZW50aXR5RnVuY3Rpb25DaGVjazogIm9uY2UiCn07CmZ1bmN0aW9uIGFzc2VydElzRnVuY3Rpb24oZnVuYywgZXJyb3JNZXNzYWdlID0gYGV4cGVjdGVkIGEgZnVuY3Rpb24sIGluc3RlYWQgcmVjZWl2ZWQgJHt0eXBlb2YgZnVuY31gKSB7CiAgaWYgKHR5cGVvZiBmdW5jICE9PSAiZnVuY3Rpb24iKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGVycm9yTWVzc2FnZSk7CiAgfQp9CmZ1bmN0aW9uIGFzc2VydElzT2JqZWN0KG9iamVjdCwgZXJyb3JNZXNzYWdlID0gYGV4cGVjdGVkIGFuIG9iamVjdCwgaW5zdGVhZCByZWNlaXZlZCAke3R5cGVvZiBvYmplY3R9YCkgewogIGlmICh0eXBlb2Ygb2JqZWN0ICE9PSAib2JqZWN0IikgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcihlcnJvck1lc3NhZ2UpOwogIH0KfQpmdW5jdGlvbiBhc3NlcnRJc0FycmF5T2ZGdW5jdGlvbnMoYXJyYXksIGVycm9yTWVzc2FnZSA9IGBleHBlY3RlZCBhbGwgaXRlbXMgdG8gYmUgZnVuY3Rpb25zLCBpbnN0ZWFkIHJlY2VpdmVkIHRoZSBmb2xsb3dpbmcgdHlwZXM6IGApIHsKICBpZiAoIWFycmF5LmV2ZXJ5KChpdGVtKSA9PiB0eXBlb2YgaXRlbSA9PT0gImZ1bmN0aW9uIikpIHsKICAgIGNvbnN0IGl0ZW1UeXBlcyA9IGFycmF5Lm1hcCgKICAgICAgKGl0ZW0pID0+IHR5cGVvZiBpdGVtID09PSAiZnVuY3Rpb24iID8gYGZ1bmN0aW9uICR7aXRlbS5uYW1lIHx8ICJ1bm5hbWVkIn0oKWAgOiB0eXBlb2YgaXRlbQogICAgKS5qb2luKCIsICIpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgJHtlcnJvck1lc3NhZ2V9WyR7aXRlbVR5cGVzfV1gKTsKICB9Cn0KdmFyIGVuc3VyZUlzQXJyYXkgPSAoaXRlbSkgPT4gewogIHJldHVybiBBcnJheS5pc0FycmF5KGl0ZW0pID8gaXRlbSA6IFtpdGVtXTsKfTsKZnVuY3Rpb24gZ2V0RGVwZW5kZW5jaWVzKGNyZWF0ZVNlbGVjdG9yQXJncykgewogIGNvbnN0IGRlcGVuZGVuY2llcyA9IEFycmF5LmlzQXJyYXkoY3JlYXRlU2VsZWN0b3JBcmdzWzBdKSA/IGNyZWF0ZVNlbGVjdG9yQXJnc1swXSA6IGNyZWF0ZVNlbGVjdG9yQXJnczsKICBhc3NlcnRJc0FycmF5T2ZGdW5jdGlvbnMoCiAgICBkZXBlbmRlbmNpZXMsCiAgICBgY3JlYXRlU2VsZWN0b3IgZXhwZWN0cyBhbGwgaW5wdXQtc2VsZWN0b3JzIHRvIGJlIGZ1bmN0aW9ucywgYnV0IHJlY2VpdmVkIHRoZSBmb2xsb3dpbmcgdHlwZXM6IGAKICApOwogIHJldHVybiBkZXBlbmRlbmNpZXM7Cn0KZnVuY3Rpb24gY29sbGVjdElucHV0U2VsZWN0b3JSZXN1bHRzKGRlcGVuZGVuY2llcywgaW5wdXRTZWxlY3RvckFyZ3MpIHsKICBjb25zdCBpbnB1dFNlbGVjdG9yUmVzdWx0cyA9IFtdOwogIGNvbnN0IHsgbGVuZ3RoIH0gPSBkZXBlbmRlbmNpZXM7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgaW5wdXRTZWxlY3RvclJlc3VsdHMucHVzaChkZXBlbmRlbmNpZXNbaV0uYXBwbHkobnVsbCwgaW5wdXRTZWxlY3RvckFyZ3MpKTsKICB9CiAgcmV0dXJuIGlucHV0U2VsZWN0b3JSZXN1bHRzOwp9CnZhciBnZXREZXZNb2RlQ2hlY2tzRXhlY3V0aW9uSW5mbyA9IChmaXJzdFJ1biwgZGV2TW9kZUNoZWNrcykgPT4gewogIGNvbnN0IHsgaWRlbnRpdHlGdW5jdGlvbkNoZWNrLCBpbnB1dFN0YWJpbGl0eUNoZWNrIH0gPSB7CiAgICAuLi5nbG9iYWxEZXZNb2RlQ2hlY2tzLAogICAgLi4uZGV2TW9kZUNoZWNrcwogIH07CiAgcmV0dXJuIHsKICAgIGlkZW50aXR5RnVuY3Rpb25DaGVjazogewogICAgICBzaG91bGRSdW46IGlkZW50aXR5RnVuY3Rpb25DaGVjayA9PT0gImFsd2F5cyIgfHwgaWRlbnRpdHlGdW5jdGlvbkNoZWNrID09PSAib25jZSIgJiYgZmlyc3RSdW4sCiAgICAgIHJ1bjogcnVuSWRlbnRpdHlGdW5jdGlvbkNoZWNrCiAgICB9LAogICAgaW5wdXRTdGFiaWxpdHlDaGVjazogewogICAgICBzaG91bGRSdW46IGlucHV0U3RhYmlsaXR5Q2hlY2sgPT09ICJhbHdheXMiIHx8IGlucHV0U3RhYmlsaXR5Q2hlY2sgPT09ICJvbmNlIiAmJiBmaXJzdFJ1biwKICAgICAgcnVuOiBydW5JbnB1dFN0YWJpbGl0eUNoZWNrCiAgICB9CiAgfTsKfTsKdmFyIFJFRFVYX1BST1hZX0xBQkVMID0gU3ltYm9sKCk7CnZhciBwcm90byA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih7fSk7CnZhciBTdHJvbmdSZWYgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IodmFsdWUpIHsKICAgIHRoaXMudmFsdWUgPSB2YWx1ZTsKICB9CiAgZGVyZWYoKSB7CiAgICByZXR1cm4gdGhpcy52YWx1ZTsKICB9Cn07CnZhciBSZWYgPSB0eXBlb2YgV2Vha1JlZiAhPT0gInVuZGVmaW5lZCIgPyBXZWFrUmVmIDogU3Ryb25nUmVmOwp2YXIgVU5URVJNSU5BVEVEID0gMDsKdmFyIFRFUk1JTkFURUQgPSAxOwpmdW5jdGlvbiBjcmVhdGVDYWNoZU5vZGUoKSB7CiAgcmV0dXJuIHsKICAgIHM6IFVOVEVSTUlOQVRFRCwKICAgIHY6IHZvaWQgMCwKICAgIG86IG51bGwsCiAgICBwOiBudWxsCiAgfTsKfQpmdW5jdGlvbiB3ZWFrTWFwTWVtb2l6ZShmdW5jLCBvcHRpb25zID0ge30pIHsKICBsZXQgZm5Ob2RlID0gY3JlYXRlQ2FjaGVOb2RlKCk7CiAgY29uc3QgeyByZXN1bHRFcXVhbGl0eUNoZWNrIH0gPSBvcHRpb25zOwogIGxldCBsYXN0UmVzdWx0OwogIGxldCByZXN1bHRzQ291bnQgPSAwOwogIGZ1bmN0aW9uIG1lbW9pemVkKCkgewogICAgbGV0IGNhY2hlTm9kZSA9IGZuTm9kZTsKICAgIGNvbnN0IHsgbGVuZ3RoIH0gPSBhcmd1bWVudHM7CiAgICBmb3IgKGxldCBpID0gMCwgbCA9IGxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICBjb25zdCBhcmcgPSBhcmd1bWVudHNbaV07CiAgICAgIGlmICh0eXBlb2YgYXJnID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBhcmcgPT09ICJvYmplY3QiICYmIGFyZyAhPT0gbnVsbCkgewogICAgICAgIGxldCBvYmplY3RDYWNoZSA9IGNhY2hlTm9kZS5vOwogICAgICAgIGlmIChvYmplY3RDYWNoZSA9PT0gbnVsbCkgewogICAgICAgICAgY2FjaGVOb2RlLm8gPSBvYmplY3RDYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBvYmplY3ROb2RlID0gb2JqZWN0Q2FjaGUuZ2V0KGFyZyk7CiAgICAgICAgaWYgKG9iamVjdE5vZGUgPT09IHZvaWQgMCkgewogICAgICAgICAgY2FjaGVOb2RlID0gY3JlYXRlQ2FjaGVOb2RlKCk7CiAgICAgICAgICBvYmplY3RDYWNoZS5zZXQoYXJnLCBjYWNoZU5vZGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjYWNoZU5vZGUgPSBvYmplY3ROb2RlOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBsZXQgcHJpbWl0aXZlQ2FjaGUgPSBjYWNoZU5vZGUucDsKICAgICAgICBpZiAocHJpbWl0aXZlQ2FjaGUgPT09IG51bGwpIHsKICAgICAgICAgIGNhY2hlTm9kZS5wID0gcHJpbWl0aXZlQ2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIH0KICAgICAgICBjb25zdCBwcmltaXRpdmVOb2RlID0gcHJpbWl0aXZlQ2FjaGUuZ2V0KGFyZyk7CiAgICAgICAgaWYgKHByaW1pdGl2ZU5vZGUgPT09IHZvaWQgMCkgewogICAgICAgICAgY2FjaGVOb2RlID0gY3JlYXRlQ2FjaGVOb2RlKCk7CiAgICAgICAgICBwcmltaXRpdmVDYWNoZS5zZXQoYXJnLCBjYWNoZU5vZGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjYWNoZU5vZGUgPSBwcmltaXRpdmVOb2RlOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgY29uc3QgdGVybWluYXRlZE5vZGUgPSBjYWNoZU5vZGU7CiAgICBsZXQgcmVzdWx0OwogICAgaWYgKGNhY2hlTm9kZS5zID09PSBURVJNSU5BVEVEKSB7CiAgICAgIHJlc3VsdCA9IGNhY2hlTm9kZS52OwogICAgfSBlbHNlIHsKICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShudWxsLCBhcmd1bWVudHMpOwogICAgICByZXN1bHRzQ291bnQrKzsKICAgICAgaWYgKHJlc3VsdEVxdWFsaXR5Q2hlY2spIHsKICAgICAgICBjb25zdCBsYXN0UmVzdWx0VmFsdWUgPSBsYXN0UmVzdWx0Py5kZXJlZj8uKCkgPz8gbGFzdFJlc3VsdDsKICAgICAgICBpZiAobGFzdFJlc3VsdFZhbHVlICE9IG51bGwgJiYgcmVzdWx0RXF1YWxpdHlDaGVjayhsYXN0UmVzdWx0VmFsdWUsIHJlc3VsdCkpIHsKICAgICAgICAgIHJlc3VsdCA9IGxhc3RSZXN1bHRWYWx1ZTsKICAgICAgICAgIHJlc3VsdHNDb3VudCAhPT0gMCAmJiByZXN1bHRzQ291bnQtLTsKICAgICAgICB9CiAgICAgICAgY29uc3QgbmVlZHNXZWFrUmVmID0gdHlwZW9mIHJlc3VsdCA9PT0gIm9iamVjdCIgJiYgcmVzdWx0ICE9PSBudWxsIHx8IHR5cGVvZiByZXN1bHQgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgbGFzdFJlc3VsdCA9IG5lZWRzV2Vha1JlZiA/IG5ldyBSZWYocmVzdWx0KSA6IHJlc3VsdDsKICAgICAgfQogICAgfQogICAgdGVybWluYXRlZE5vZGUucyA9IFRFUk1JTkFURUQ7CiAgICB0ZXJtaW5hdGVkTm9kZS52ID0gcmVzdWx0OwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgbWVtb2l6ZWQuY2xlYXJDYWNoZSA9ICgpID0+IHsKICAgIGZuTm9kZSA9IGNyZWF0ZUNhY2hlTm9kZSgpOwogICAgbWVtb2l6ZWQucmVzZXRSZXN1bHRzQ291bnQoKTsKICB9OwogIG1lbW9pemVkLnJlc3VsdHNDb3VudCA9ICgpID0+IHJlc3VsdHNDb3VudDsKICBtZW1vaXplZC5yZXNldFJlc3VsdHNDb3VudCA9ICgpID0+IHsKICAgIHJlc3VsdHNDb3VudCA9IDA7CiAgfTsKICByZXR1cm4gbWVtb2l6ZWQ7Cn0KZnVuY3Rpb24gY3JlYXRlU2VsZWN0b3JDcmVhdG9yKG1lbW9pemVPck9wdGlvbnMsIC4uLm1lbW9pemVPcHRpb25zRnJvbUFyZ3MpIHsKICBjb25zdCBjcmVhdGVTZWxlY3RvckNyZWF0b3JPcHRpb25zID0gdHlwZW9mIG1lbW9pemVPck9wdGlvbnMgPT09ICJmdW5jdGlvbiIgPyB7CiAgICBtZW1vaXplOiBtZW1vaXplT3JPcHRpb25zLAogICAgbWVtb2l6ZU9wdGlvbnM6IG1lbW9pemVPcHRpb25zRnJvbUFyZ3MKICB9IDogbWVtb2l6ZU9yT3B0aW9uczsKICBjb25zdCBjcmVhdGVTZWxlY3RvcjIgPSAoLi4uY3JlYXRlU2VsZWN0b3JBcmdzKSA9PiB7CiAgICBsZXQgcmVjb21wdXRhdGlvbnMgPSAwOwogICAgbGV0IGRlcGVuZGVuY3lSZWNvbXB1dGF0aW9ucyA9IDA7CiAgICBsZXQgbGFzdFJlc3VsdDsKICAgIGxldCBkaXJlY3RseVBhc3NlZE9wdGlvbnMgPSB7fTsKICAgIGxldCByZXN1bHRGdW5jID0gY3JlYXRlU2VsZWN0b3JBcmdzLnBvcCgpOwogICAgaWYgKHR5cGVvZiByZXN1bHRGdW5jID09PSAib2JqZWN0IikgewogICAgICBkaXJlY3RseVBhc3NlZE9wdGlvbnMgPSByZXN1bHRGdW5jOwogICAgICByZXN1bHRGdW5jID0gY3JlYXRlU2VsZWN0b3JBcmdzLnBvcCgpOwogICAgfQogICAgYXNzZXJ0SXNGdW5jdGlvbigKICAgICAgcmVzdWx0RnVuYywKICAgICAgYGNyZWF0ZVNlbGVjdG9yIGV4cGVjdHMgYW4gb3V0cHV0IGZ1bmN0aW9uIGFmdGVyIHRoZSBpbnB1dHMsIGJ1dCByZWNlaXZlZDogWyR7dHlwZW9mIHJlc3VsdEZ1bmN9XWAKICAgICk7CiAgICBjb25zdCBjb21iaW5lZE9wdGlvbnMgPSB7CiAgICAgIC4uLmNyZWF0ZVNlbGVjdG9yQ3JlYXRvck9wdGlvbnMsCiAgICAgIC4uLmRpcmVjdGx5UGFzc2VkT3B0aW9ucwogICAgfTsKICAgIGNvbnN0IHsKICAgICAgbWVtb2l6ZSwKICAgICAgbWVtb2l6ZU9wdGlvbnMgPSBbXSwKICAgICAgYXJnc01lbW9pemUgPSB3ZWFrTWFwTWVtb2l6ZSwKICAgICAgYXJnc01lbW9pemVPcHRpb25zID0gW10sCiAgICAgIGRldk1vZGVDaGVja3MgPSB7fQogICAgfSA9IGNvbWJpbmVkT3B0aW9uczsKICAgIGNvbnN0IGZpbmFsTWVtb2l6ZU9wdGlvbnMgPSBlbnN1cmVJc0FycmF5KG1lbW9pemVPcHRpb25zKTsKICAgIGNvbnN0IGZpbmFsQXJnc01lbW9pemVPcHRpb25zID0gZW5zdXJlSXNBcnJheShhcmdzTWVtb2l6ZU9wdGlvbnMpOwogICAgY29uc3QgZGVwZW5kZW5jaWVzID0gZ2V0RGVwZW5kZW5jaWVzKGNyZWF0ZVNlbGVjdG9yQXJncyk7CiAgICBjb25zdCBtZW1vaXplZFJlc3VsdEZ1bmMgPSBtZW1vaXplKGZ1bmN0aW9uIHJlY29tcHV0YXRpb25XcmFwcGVyKCkgewogICAgICByZWNvbXB1dGF0aW9ucysrOwogICAgICByZXR1cm4gcmVzdWx0RnVuYy5hcHBseSgKICAgICAgICBudWxsLAogICAgICAgIGFyZ3VtZW50cwogICAgICApOwogICAgfSwgLi4uZmluYWxNZW1vaXplT3B0aW9ucyk7CiAgICBsZXQgZmlyc3RSdW4gPSB0cnVlOwogICAgY29uc3Qgc2VsZWN0b3IgPSBhcmdzTWVtb2l6ZShmdW5jdGlvbiBkZXBlbmRlbmNpZXNDaGVja2VyKCkgewogICAgICBkZXBlbmRlbmN5UmVjb21wdXRhdGlvbnMrKzsKICAgICAgY29uc3QgaW5wdXRTZWxlY3RvclJlc3VsdHMgPSBjb2xsZWN0SW5wdXRTZWxlY3RvclJlc3VsdHMoCiAgICAgICAgZGVwZW5kZW5jaWVzLAogICAgICAgIGFyZ3VtZW50cwogICAgICApOwogICAgICBsYXN0UmVzdWx0ID0gbWVtb2l6ZWRSZXN1bHRGdW5jLmFwcGx5KG51bGwsIGlucHV0U2VsZWN0b3JSZXN1bHRzKTsKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBjb25zdCB7IGlkZW50aXR5RnVuY3Rpb25DaGVjaywgaW5wdXRTdGFiaWxpdHlDaGVjayB9ID0gZ2V0RGV2TW9kZUNoZWNrc0V4ZWN1dGlvbkluZm8oZmlyc3RSdW4sIGRldk1vZGVDaGVja3MpOwogICAgICAgIGlmIChpZGVudGl0eUZ1bmN0aW9uQ2hlY2suc2hvdWxkUnVuKSB7CiAgICAgICAgICBpZGVudGl0eUZ1bmN0aW9uQ2hlY2sucnVuKAogICAgICAgICAgICByZXN1bHRGdW5jLAogICAgICAgICAgICBpbnB1dFNlbGVjdG9yUmVzdWx0cywKICAgICAgICAgICAgbGFzdFJlc3VsdAogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGlucHV0U3RhYmlsaXR5Q2hlY2suc2hvdWxkUnVuKSB7CiAgICAgICAgICBjb25zdCBpbnB1dFNlbGVjdG9yUmVzdWx0c0NvcHkgPSBjb2xsZWN0SW5wdXRTZWxlY3RvclJlc3VsdHMoCiAgICAgICAgICAgIGRlcGVuZGVuY2llcywKICAgICAgICAgICAgYXJndW1lbnRzCiAgICAgICAgICApOwogICAgICAgICAgaW5wdXRTdGFiaWxpdHlDaGVjay5ydW4oCiAgICAgICAgICAgIHsgaW5wdXRTZWxlY3RvclJlc3VsdHMsIGlucHV0U2VsZWN0b3JSZXN1bHRzQ29weSB9LAogICAgICAgICAgICB7IG1lbW9pemUsIG1lbW9pemVPcHRpb25zOiBmaW5hbE1lbW9pemVPcHRpb25zIH0sCiAgICAgICAgICAgIGFyZ3VtZW50cwogICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGZpcnN0UnVuKQogICAgICAgICAgZmlyc3RSdW4gPSBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gbGFzdFJlc3VsdDsKICAgIH0sIC4uLmZpbmFsQXJnc01lbW9pemVPcHRpb25zKTsKICAgIHJldHVybiBPYmplY3QuYXNzaWduKHNlbGVjdG9yLCB7CiAgICAgIHJlc3VsdEZ1bmMsCiAgICAgIG1lbW9pemVkUmVzdWx0RnVuYywKICAgICAgZGVwZW5kZW5jaWVzLAogICAgICBkZXBlbmRlbmN5UmVjb21wdXRhdGlvbnM6ICgpID0+IGRlcGVuZGVuY3lSZWNvbXB1dGF0aW9ucywKICAgICAgcmVzZXREZXBlbmRlbmN5UmVjb21wdXRhdGlvbnM6ICgpID0+IHsKICAgICAgICBkZXBlbmRlbmN5UmVjb21wdXRhdGlvbnMgPSAwOwogICAgICB9LAogICAgICBsYXN0UmVzdWx0OiAoKSA9PiBsYXN0UmVzdWx0LAogICAgICByZWNvbXB1dGF0aW9uczogKCkgPT4gcmVjb21wdXRhdGlvbnMsCiAgICAgIHJlc2V0UmVjb21wdXRhdGlvbnM6ICgpID0+IHsKICAgICAgICByZWNvbXB1dGF0aW9ucyA9IDA7CiAgICAgIH0sCiAgICAgIG1lbW9pemUsCiAgICAgIGFyZ3NNZW1vaXplCiAgICB9KTsKICB9OwogIE9iamVjdC5hc3NpZ24oY3JlYXRlU2VsZWN0b3IyLCB7CiAgICB3aXRoVHlwZXM6ICgpID0+IGNyZWF0ZVNlbGVjdG9yMgogIH0pOwogIHJldHVybiBjcmVhdGVTZWxlY3RvcjI7Cn0KdmFyIGNyZWF0ZVNlbGVjdG9yID0gLyogQF9fUFVSRV9fICovIGNyZWF0ZVNlbGVjdG9yQ3JlYXRvcih3ZWFrTWFwTWVtb2l6ZSk7CnZhciBjcmVhdGVTdHJ1Y3R1cmVkU2VsZWN0b3IgPSBPYmplY3QuYXNzaWduKAogIChpbnB1dFNlbGVjdG9yc09iamVjdCwgc2VsZWN0b3JDcmVhdG9yID0gY3JlYXRlU2VsZWN0b3IpID0+IHsKICAgIGFzc2VydElzT2JqZWN0KAogICAgICBpbnB1dFNlbGVjdG9yc09iamVjdCwKICAgICAgYGNyZWF0ZVN0cnVjdHVyZWRTZWxlY3RvciBleHBlY3RzIGZpcnN0IGFyZ3VtZW50IHRvIGJlIGFuIG9iamVjdCB3aGVyZSBlYWNoIHByb3BlcnR5IGlzIGEgc2VsZWN0b3IsIGluc3RlYWQgcmVjZWl2ZWQgYSAke3R5cGVvZiBpbnB1dFNlbGVjdG9yc09iamVjdH1gCiAgICApOwogICAgY29uc3QgaW5wdXRTZWxlY3RvcktleXMgPSBPYmplY3Qua2V5cyhpbnB1dFNlbGVjdG9yc09iamVjdCk7CiAgICBjb25zdCBkZXBlbmRlbmNpZXMgPSBpbnB1dFNlbGVjdG9yS2V5cy5tYXAoCiAgICAgIChrZXkpID0+IGlucHV0U2VsZWN0b3JzT2JqZWN0W2tleV0KICAgICk7CiAgICBjb25zdCBzdHJ1Y3R1cmVkU2VsZWN0b3IgPSBzZWxlY3RvckNyZWF0b3IoCiAgICAgIGRlcGVuZGVuY2llcywKICAgICAgKC4uLmlucHV0U2VsZWN0b3JSZXN1bHRzKSA9PiB7CiAgICAgICAgcmV0dXJuIGlucHV0U2VsZWN0b3JSZXN1bHRzLnJlZHVjZSgoY29tcG9zaXRpb24sIHZhbHVlLCBpbmRleCkgPT4gewogICAgICAgICAgY29tcG9zaXRpb25baW5wdXRTZWxlY3RvcktleXNbaW5kZXhdXSA9IHZhbHVlOwogICAgICAgICAgcmV0dXJuIGNvbXBvc2l0aW9uOwogICAgICAgIH0sIHt9KTsKICAgICAgfQogICAgKTsKICAgIHJldHVybiBzdHJ1Y3R1cmVkU2VsZWN0b3I7CiAgfSwKICB7IHdpdGhUeXBlczogKCkgPT4gY3JlYXRlU3RydWN0dXJlZFNlbGVjdG9yIH0KKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2xlZ2VuZFNlbGVjdG9ycy5qcwp2YXIgaW1wb3J0X3NvcnRCeSA9IF9fdG9FU00ocmVxdWlyZV9zb3J0QnkyKCkpOwp2YXIgc2VsZWN0TGVnZW5kU2V0dGluZ3MgPSAoc3RhdGUpID0+IHN0YXRlLmxlZ2VuZC5zZXR0aW5nczsKdmFyIHNlbGVjdExlZ2VuZFNpemUgPSAoc3RhdGUpID0+IHN0YXRlLmxlZ2VuZC5zaXplOwp2YXIgc2VsZWN0QWxsTGVnZW5kUGF5bG9hZDJEQXJyYXkgPSAoc3RhdGUpID0+IHN0YXRlLmxlZ2VuZC5wYXlsb2FkOwp2YXIgc2VsZWN0TGVnZW5kUGF5bG9hZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxMZWdlbmRQYXlsb2FkMkRBcnJheSwgc2VsZWN0TGVnZW5kU2V0dGluZ3NdLCAocGF5bG9hZHMsIF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGl0ZW1Tb3J0ZXIKICB9ID0gX3JlZjI7CiAgdmFyIGZsYXQgPSBwYXlsb2Fkcy5mbGF0KDEpOwogIHJldHVybiBpdGVtU29ydGVyID8gKDAsIGltcG9ydF9zb3J0QnkuZGVmYXVsdCkoZmxhdCwgaXRlbVNvcnRlcikgOiBmbGF0Owp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VFbGVtZW50T2Zmc2V0LmpzCnZhciBpbXBvcnRfcmVhY3QxMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIEVQUyA9IDE7CmZ1bmN0aW9uIHVzZUVsZW1lbnRPZmZzZXQoKSB7CiAgdmFyIGV4dHJhRGVwZW5kZW5jaWVzID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMF0gOiBbXTsKICB2YXIgW2xhc3RCb3VuZGluZ0JveCwgc2V0TGFzdEJvdW5kaW5nQm94XSA9ICgwLCBpbXBvcnRfcmVhY3QxMC51c2VTdGF0ZSkoewogICAgaGVpZ2h0OiAwLAogICAgbGVmdDogMCwKICAgIHRvcDogMCwKICAgIHdpZHRoOiAwCiAgfSk7CiAgdmFyIHVwZGF0ZUJvdW5kaW5nQm94ID0gKDAsIGltcG9ydF9yZWFjdDEwLnVzZUNhbGxiYWNrKSgKICAgIChub2RlKSA9PiB7CiAgICAgIGlmIChub2RlICE9IG51bGwpIHsKICAgICAgICB2YXIgcmVjdCA9IG5vZGUuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgdmFyIGJveCA9IHsKICAgICAgICAgIGhlaWdodDogcmVjdC5oZWlnaHQsCiAgICAgICAgICBsZWZ0OiByZWN0LmxlZnQsCiAgICAgICAgICB0b3A6IHJlY3QudG9wLAogICAgICAgICAgd2lkdGg6IHJlY3Qud2lkdGgKICAgICAgICB9OwogICAgICAgIGlmIChNYXRoLmFicyhib3guaGVpZ2h0IC0gbGFzdEJvdW5kaW5nQm94LmhlaWdodCkgPiBFUFMgfHwgTWF0aC5hYnMoYm94LmxlZnQgLSBsYXN0Qm91bmRpbmdCb3gubGVmdCkgPiBFUFMgfHwgTWF0aC5hYnMoYm94LnRvcCAtIGxhc3RCb3VuZGluZ0JveC50b3ApID4gRVBTIHx8IE1hdGguYWJzKGJveC53aWR0aCAtIGxhc3RCb3VuZGluZ0JveC53aWR0aCkgPiBFUFMpIHsKICAgICAgICAgIHNldExhc3RCb3VuZGluZ0JveCh7CiAgICAgICAgICAgIGhlaWdodDogYm94LmhlaWdodCwKICAgICAgICAgICAgbGVmdDogYm94LmxlZnQsCiAgICAgICAgICAgIHRvcDogYm94LnRvcCwKICAgICAgICAgICAgd2lkdGg6IGJveC53aWR0aAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0LWhvb2tzL2V4aGF1c3RpdmUtZGVwcwogICAgW2xhc3RCb3VuZGluZ0JveC53aWR0aCwgbGFzdEJvdW5kaW5nQm94LmhlaWdodCwgbGFzdEJvdW5kaW5nQm94LnRvcCwgbGFzdEJvdW5kaW5nQm94LmxlZnQsIC4uLmV4dHJhRGVwZW5kZW5jaWVzXQogICk7CiAgcmV0dXJuIFtsYXN0Qm91bmRpbmdCb3gsIHVwZGF0ZUJvdW5kaW5nQm94XTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L2NoYXJ0TGF5b3V0Q29udGV4dC5qcwp2YXIgaW1wb3J0X3JlYWN0MTMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVkdXgvZGlzdC9yZWR1eC5tanMKdmFyICQkb2JzZXJ2YWJsZSA9IC8qIEBfX1BVUkVfXyAqLyAoKCkgPT4gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wub2JzZXJ2YWJsZSB8fCAiQEBvYnNlcnZhYmxlIikoKTsKdmFyIHN5bWJvbF9vYnNlcnZhYmxlX2RlZmF1bHQgPSAkJG9ic2VydmFibGU7CnZhciByYW5kb21TdHJpbmcgPSAoKSA9PiBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHJpbmcoNykuc3BsaXQoIiIpLmpvaW4oIi4iKTsKdmFyIEFjdGlvblR5cGVzID0gewogIElOSVQ6IGBAQHJlZHV4L0lOSVQkey8qIEBfX1BVUkVfXyAqLyByYW5kb21TdHJpbmcoKX1gLAogIFJFUExBQ0U6IGBAQHJlZHV4L1JFUExBQ0Ukey8qIEBfX1BVUkVfXyAqLyByYW5kb21TdHJpbmcoKX1gLAogIFBST0JFX1VOS05PV05fQUNUSU9OOiAoKSA9PiBgQEByZWR1eC9QUk9CRV9VTktOT1dOX0FDVElPTiR7cmFuZG9tU3RyaW5nKCl9YAp9Owp2YXIgYWN0aW9uVHlwZXNfZGVmYXVsdCA9IEFjdGlvblR5cGVzOwpmdW5jdGlvbiBpc1BsYWluT2JqZWN0KG9iaikgewogIGlmICh0eXBlb2Ygb2JqICE9PSAib2JqZWN0IiB8fCBvYmogPT09IG51bGwpCiAgICByZXR1cm4gZmFsc2U7CiAgbGV0IHByb3RvMiA9IG9iajsKICB3aGlsZSAoT2JqZWN0LmdldFByb3RvdHlwZU9mKHByb3RvMikgIT09IG51bGwpIHsKICAgIHByb3RvMiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihwcm90bzIpOwogIH0KICByZXR1cm4gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iaikgPT09IHByb3RvMiB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqKSA9PT0gbnVsbDsKfQpmdW5jdGlvbiBtaW5pS2luZE9mKHZhbCkgewogIGlmICh2YWwgPT09IHZvaWQgMCkKICAgIHJldHVybiAidW5kZWZpbmVkIjsKICBpZiAodmFsID09PSBudWxsKQogICAgcmV0dXJuICJudWxsIjsKICBjb25zdCB0eXBlID0gdHlwZW9mIHZhbDsKICBzd2l0Y2ggKHR5cGUpIHsKICAgIGNhc2UgImJvb2xlYW4iOgogICAgY2FzZSAic3RyaW5nIjoKICAgIGNhc2UgIm51bWJlciI6CiAgICBjYXNlICJzeW1ib2wiOgogICAgY2FzZSAiZnVuY3Rpb24iOiB7CiAgICAgIHJldHVybiB0eXBlOwogICAgfQogIH0KICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKQogICAgcmV0dXJuICJhcnJheSI7CiAgaWYgKGlzRGF0ZSh2YWwpKQogICAgcmV0dXJuICJkYXRlIjsKICBpZiAoaXNFcnJvcih2YWwpKQogICAgcmV0dXJuICJlcnJvciI7CiAgY29uc3QgY29uc3RydWN0b3JOYW1lID0gY3Rvck5hbWUodmFsKTsKICBzd2l0Y2ggKGNvbnN0cnVjdG9yTmFtZSkgewogICAgY2FzZSAiU3ltYm9sIjoKICAgIGNhc2UgIlByb21pc2UiOgogICAgY2FzZSAiV2Vha01hcCI6CiAgICBjYXNlICJXZWFrU2V0IjoKICAgIGNhc2UgIk1hcCI6CiAgICBjYXNlICJTZXQiOgogICAgICByZXR1cm4gY29uc3RydWN0b3JOYW1lOwogIH0KICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbCkuc2xpY2UoOCwgLTEpLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXHMvZywgIiIpOwp9CmZ1bmN0aW9uIGN0b3JOYW1lKHZhbCkgewogIHJldHVybiB0eXBlb2YgdmFsLmNvbnN0cnVjdG9yID09PSAiZnVuY3Rpb24iID8gdmFsLmNvbnN0cnVjdG9yLm5hbWUgOiBudWxsOwp9CmZ1bmN0aW9uIGlzRXJyb3IodmFsKSB7CiAgcmV0dXJuIHZhbCBpbnN0YW5jZW9mIEVycm9yIHx8IHR5cGVvZiB2YWwubWVzc2FnZSA9PT0gInN0cmluZyIgJiYgdmFsLmNvbnN0cnVjdG9yICYmIHR5cGVvZiB2YWwuY29uc3RydWN0b3Iuc3RhY2tUcmFjZUxpbWl0ID09PSAibnVtYmVyIjsKfQpmdW5jdGlvbiBpc0RhdGUodmFsKSB7CiAgaWYgKHZhbCBpbnN0YW5jZW9mIERhdGUpCiAgICByZXR1cm4gdHJ1ZTsKICByZXR1cm4gdHlwZW9mIHZhbC50b0RhdGVTdHJpbmcgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIHZhbC5nZXREYXRlID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiB2YWwuc2V0RGF0ZSA9PT0gImZ1bmN0aW9uIjsKfQpmdW5jdGlvbiBraW5kT2YodmFsKSB7CiAgbGV0IHR5cGVPZlZhbCA9IHR5cGVvZiB2YWw7CiAgaWYgKHRydWUpIHsKICAgIHR5cGVPZlZhbCA9IG1pbmlLaW5kT2YodmFsKTsKICB9CiAgcmV0dXJuIHR5cGVPZlZhbDsKfQpmdW5jdGlvbiBjcmVhdGVTdG9yZShyZWR1Y2VyLCBwcmVsb2FkZWRTdGF0ZSwgZW5oYW5jZXIpIHsKICBpZiAodHlwZW9mIHJlZHVjZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMikgOiBgRXhwZWN0ZWQgdGhlIHJvb3QgcmVkdWNlciB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkLCByZWNlaXZlZDogJyR7a2luZE9mKHJlZHVjZXIpfSdgKTsKICB9CiAgaWYgKHR5cGVvZiBwcmVsb2FkZWRTdGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgZW5oYW5jZXIgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGVuaGFuY2VyID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBhcmd1bWVudHNbM10gPT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMCkgOiAiSXQgbG9va3MgbGlrZSB5b3UgYXJlIHBhc3Npbmcgc2V2ZXJhbCBzdG9yZSBlbmhhbmNlcnMgdG8gY3JlYXRlU3RvcmUoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBJbnN0ZWFkLCBjb21wb3NlIHRoZW0gdG9nZXRoZXIgdG8gYSBzaW5nbGUgZnVuY3Rpb24uIFNlZSBodHRwczovL3JlZHV4LmpzLm9yZy90dXRvcmlhbHMvZnVuZGFtZW50YWxzL3BhcnQtNC1zdG9yZSNjcmVhdGluZy1hLXN0b3JlLXdpdGgtZW5oYW5jZXJzIGZvciBhbiBleGFtcGxlLiIpOwogIH0KICBpZiAodHlwZW9mIHByZWxvYWRlZFN0YXRlID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBlbmhhbmNlciA9PT0gInVuZGVmaW5lZCIpIHsKICAgIGVuaGFuY2VyID0gcHJlbG9hZGVkU3RhdGU7CiAgICBwcmVsb2FkZWRTdGF0ZSA9IHZvaWQgMDsKICB9CiAgaWYgKHR5cGVvZiBlbmhhbmNlciAhPT0gInVuZGVmaW5lZCIpIHsKICAgIGlmICh0eXBlb2YgZW5oYW5jZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxKSA6IGBFeHBlY3RlZCB0aGUgZW5oYW5jZXIgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCwgcmVjZWl2ZWQ6ICcke2tpbmRPZihlbmhhbmNlcil9J2ApOwogICAgfQogICAgcmV0dXJuIGVuaGFuY2VyKGNyZWF0ZVN0b3JlKShyZWR1Y2VyLCBwcmVsb2FkZWRTdGF0ZSk7CiAgfQogIGxldCBjdXJyZW50UmVkdWNlciA9IHJlZHVjZXI7CiAgbGV0IGN1cnJlbnRTdGF0ZSA9IHByZWxvYWRlZFN0YXRlOwogIGxldCBjdXJyZW50TGlzdGVuZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBsZXQgbmV4dExpc3RlbmVycyA9IGN1cnJlbnRMaXN0ZW5lcnM7CiAgbGV0IGxpc3RlbmVySWRDb3VudGVyID0gMDsKICBsZXQgaXNEaXNwYXRjaGluZyA9IGZhbHNlOwogIGZ1bmN0aW9uIGVuc3VyZUNhbk11dGF0ZU5leHRMaXN0ZW5lcnMoKSB7CiAgICBpZiAobmV4dExpc3RlbmVycyA9PT0gY3VycmVudExpc3RlbmVycykgewogICAgICBuZXh0TGlzdGVuZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgY3VycmVudExpc3RlbmVycy5mb3JFYWNoKChsaXN0ZW5lcjIsIGtleSkgPT4gewogICAgICAgIG5leHRMaXN0ZW5lcnMuc2V0KGtleSwgbGlzdGVuZXIyKTsKICAgICAgfSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdldFN0YXRlKCkgewogICAgaWYgKGlzRGlzcGF0Y2hpbmcpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgzKSA6ICJZb3UgbWF5IG5vdCBjYWxsIHN0b3JlLmdldFN0YXRlKCkgd2hpbGUgdGhlIHJlZHVjZXIgaXMgZXhlY3V0aW5nLiBUaGUgcmVkdWNlciBoYXMgYWxyZWFkeSByZWNlaXZlZCB0aGUgc3RhdGUgYXMgYW4gYXJndW1lbnQuIFBhc3MgaXQgZG93biBmcm9tIHRoZSB0b3AgcmVkdWNlciBpbnN0ZWFkIG9mIHJlYWRpbmcgaXQgZnJvbSB0aGUgc3RvcmUuIik7CiAgICB9CiAgICByZXR1cm4gY3VycmVudFN0YXRlOwogIH0KICBmdW5jdGlvbiBzdWJzY3JpYmUobGlzdGVuZXIyKSB7CiAgICBpZiAodHlwZW9mIGxpc3RlbmVyMiAhPT0gImZ1bmN0aW9uIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDQpIDogYEV4cGVjdGVkIHRoZSBsaXN0ZW5lciB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkLCByZWNlaXZlZDogJyR7a2luZE9mKGxpc3RlbmVyMil9J2ApOwogICAgfQogICAgaWYgKGlzRGlzcGF0Y2hpbmcpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg1KSA6ICJZb3UgbWF5IG5vdCBjYWxsIHN0b3JlLnN1YnNjcmliZSgpIHdoaWxlIHRoZSByZWR1Y2VyIGlzIGV4ZWN1dGluZy4gSWYgeW91IHdvdWxkIGxpa2UgdG8gYmUgbm90aWZpZWQgYWZ0ZXIgdGhlIHN0b3JlIGhhcyBiZWVuIHVwZGF0ZWQsIHN1YnNjcmliZSBmcm9tIGEgY29tcG9uZW50IGFuZCBpbnZva2Ugc3RvcmUuZ2V0U3RhdGUoKSBpbiB0aGUgY2FsbGJhY2sgdG8gYWNjZXNzIHRoZSBsYXRlc3Qgc3RhdGUuIFNlZSBodHRwczovL3JlZHV4LmpzLm9yZy9hcGkvc3RvcmUjc3Vic2NyaWJlbGlzdGVuZXIgZm9yIG1vcmUgZGV0YWlscy4iKTsKICAgIH0KICAgIGxldCBpc1N1YnNjcmliZWQgPSB0cnVlOwogICAgZW5zdXJlQ2FuTXV0YXRlTmV4dExpc3RlbmVycygpOwogICAgY29uc3QgbGlzdGVuZXJJZCA9IGxpc3RlbmVySWRDb3VudGVyKys7CiAgICBuZXh0TGlzdGVuZXJzLnNldChsaXN0ZW5lcklkLCBsaXN0ZW5lcjIpOwogICAgcmV0dXJuIGZ1bmN0aW9uIHVuc3Vic2NyaWJlKCkgewogICAgICBpZiAoIWlzU3Vic2NyaWJlZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoaXNEaXNwYXRjaGluZykgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNikgOiAiWW91IG1heSBub3QgdW5zdWJzY3JpYmUgZnJvbSBhIHN0b3JlIGxpc3RlbmVyIHdoaWxlIHRoZSByZWR1Y2VyIGlzIGV4ZWN1dGluZy4gU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL2FwaS9zdG9yZSNzdWJzY3JpYmVsaXN0ZW5lciBmb3IgbW9yZSBkZXRhaWxzLiIpOwogICAgICB9CiAgICAgIGlzU3Vic2NyaWJlZCA9IGZhbHNlOwogICAgICBlbnN1cmVDYW5NdXRhdGVOZXh0TGlzdGVuZXJzKCk7CiAgICAgIG5leHRMaXN0ZW5lcnMuZGVsZXRlKGxpc3RlbmVySWQpOwogICAgICBjdXJyZW50TGlzdGVuZXJzID0gbnVsbDsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGRpc3BhdGNoKGFjdGlvbikgewogICAgaWYgKCFpc1BsYWluT2JqZWN0KGFjdGlvbikpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg3KSA6IGBBY3Rpb25zIG11c3QgYmUgcGxhaW4gb2JqZWN0cy4gSW5zdGVhZCwgdGhlIGFjdHVhbCB0eXBlIHdhczogJyR7a2luZE9mKGFjdGlvbil9Jy4gWW91IG1heSBuZWVkIHRvIGFkZCBtaWRkbGV3YXJlIHRvIHlvdXIgc3RvcmUgc2V0dXAgdG8gaGFuZGxlIGRpc3BhdGNoaW5nIG90aGVyIHZhbHVlcywgc3VjaCBhcyAncmVkdXgtdGh1bmsnIHRvIGhhbmRsZSBkaXNwYXRjaGluZyBmdW5jdGlvbnMuIFNlZSBodHRwczovL3JlZHV4LmpzLm9yZy90dXRvcmlhbHMvZnVuZGFtZW50YWxzL3BhcnQtNC1zdG9yZSNtaWRkbGV3YXJlIGFuZCBodHRwczovL3JlZHV4LmpzLm9yZy90dXRvcmlhbHMvZnVuZGFtZW50YWxzL3BhcnQtNi1hc3luYy1sb2dpYyN1c2luZy10aGUtcmVkdXgtdGh1bmstbWlkZGxld2FyZSBmb3IgZXhhbXBsZXMuYCk7CiAgICB9CiAgICBpZiAodHlwZW9mIGFjdGlvbi50eXBlID09PSAidW5kZWZpbmVkIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDgpIDogJ0FjdGlvbnMgbWF5IG5vdCBoYXZlIGFuIHVuZGVmaW5lZCAidHlwZSIgcHJvcGVydHkuIFlvdSBtYXkgaGF2ZSBtaXNzcGVsbGVkIGFuIGFjdGlvbiB0eXBlIHN0cmluZyBjb25zdGFudC4nKTsKICAgIH0KICAgIGlmICh0eXBlb2YgYWN0aW9uLnR5cGUgIT09ICJzdHJpbmciKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTcpIDogYEFjdGlvbiAidHlwZSIgcHJvcGVydHkgbXVzdCBiZSBhIHN0cmluZy4gSW5zdGVhZCwgdGhlIGFjdHVhbCB0eXBlIHdhczogJyR7a2luZE9mKGFjdGlvbi50eXBlKX0nLiBWYWx1ZSB3YXM6ICcke2FjdGlvbi50eXBlfScgKHN0cmluZ2lmaWVkKWApOwogICAgfQogICAgaWYgKGlzRGlzcGF0Y2hpbmcpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg5KSA6ICJSZWR1Y2VycyBtYXkgbm90IGRpc3BhdGNoIGFjdGlvbnMuIik7CiAgICB9CiAgICB0cnkgewogICAgICBpc0Rpc3BhdGNoaW5nID0gdHJ1ZTsKICAgICAgY3VycmVudFN0YXRlID0gY3VycmVudFJlZHVjZXIoY3VycmVudFN0YXRlLCBhY3Rpb24pOwogICAgfSBmaW5hbGx5IHsKICAgICAgaXNEaXNwYXRjaGluZyA9IGZhbHNlOwogICAgfQogICAgY29uc3QgbGlzdGVuZXJzID0gY3VycmVudExpc3RlbmVycyA9IG5leHRMaXN0ZW5lcnM7CiAgICBsaXN0ZW5lcnMuZm9yRWFjaCgobGlzdGVuZXIyKSA9PiB7CiAgICAgIGxpc3RlbmVyMigpOwogICAgfSk7CiAgICByZXR1cm4gYWN0aW9uOwogIH0KICBmdW5jdGlvbiByZXBsYWNlUmVkdWNlcihuZXh0UmVkdWNlcikgewogICAgaWYgKHR5cGVvZiBuZXh0UmVkdWNlciAhPT0gImZ1bmN0aW9uIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEwKSA6IGBFeHBlY3RlZCB0aGUgbmV4dFJlZHVjZXIgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCwgcmVjZWl2ZWQ6ICcke2tpbmRPZihuZXh0UmVkdWNlcil9YCk7CiAgICB9CiAgICBjdXJyZW50UmVkdWNlciA9IG5leHRSZWR1Y2VyOwogICAgZGlzcGF0Y2goewogICAgICB0eXBlOiBhY3Rpb25UeXBlc19kZWZhdWx0LlJFUExBQ0UKICAgIH0pOwogIH0KICBmdW5jdGlvbiBvYnNlcnZhYmxlKCkgewogICAgY29uc3Qgb3V0ZXJTdWJzY3JpYmUgPSBzdWJzY3JpYmU7CiAgICByZXR1cm4gewogICAgICAvKioKICAgICAgICogVGhlIG1pbmltYWwgb2JzZXJ2YWJsZSBzdWJzY3JpcHRpb24gbWV0aG9kLgogICAgICAgKiBAcGFyYW0gb2JzZXJ2ZXIgQW55IG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIGFzIGFuIG9ic2VydmVyLgogICAgICAgKiBUaGUgb2JzZXJ2ZXIgb2JqZWN0IHNob3VsZCBoYXZlIGEgYG5leHRgIG1ldGhvZC4KICAgICAgICogQHJldHVybnMgQW4gb2JqZWN0IHdpdGggYW4gYHVuc3Vic2NyaWJlYCBtZXRob2QgdGhhdCBjYW4KICAgICAgICogYmUgdXNlZCB0byB1bnN1YnNjcmliZSB0aGUgb2JzZXJ2YWJsZSBmcm9tIHRoZSBzdG9yZSwgYW5kIHByZXZlbnQgZnVydGhlcgogICAgICAgKiBlbWlzc2lvbiBvZiB2YWx1ZXMgZnJvbSB0aGUgb2JzZXJ2YWJsZS4KICAgICAgICovCiAgICAgIHN1YnNjcmliZShvYnNlcnZlcikgewogICAgICAgIGlmICh0eXBlb2Ygb2JzZXJ2ZXIgIT09ICJvYmplY3QiIHx8IG9ic2VydmVyID09PSBudWxsKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDExKSA6IGBFeHBlY3RlZCB0aGUgb2JzZXJ2ZXIgdG8gYmUgYW4gb2JqZWN0LiBJbnN0ZWFkLCByZWNlaXZlZDogJyR7a2luZE9mKG9ic2VydmVyKX0nYCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9ic2VydmVTdGF0ZSgpIHsKICAgICAgICAgIGNvbnN0IG9ic2VydmVyQXNPYnNlcnZlciA9IG9ic2VydmVyOwogICAgICAgICAgaWYgKG9ic2VydmVyQXNPYnNlcnZlci5uZXh0KSB7CiAgICAgICAgICAgIG9ic2VydmVyQXNPYnNlcnZlci5uZXh0KGdldFN0YXRlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBvYnNlcnZlU3RhdGUoKTsKICAgICAgICBjb25zdCB1bnN1YnNjcmliZSA9IG91dGVyU3Vic2NyaWJlKG9ic2VydmVTdGF0ZSk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHVuc3Vic2NyaWJlCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgW3N5bWJvbF9vYnNlcnZhYmxlX2RlZmF1bHRdKCkgewogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICB9OwogIH0KICBkaXNwYXRjaCh7CiAgICB0eXBlOiBhY3Rpb25UeXBlc19kZWZhdWx0LklOSVQKICB9KTsKICBjb25zdCBzdG9yZSA9IHsKICAgIGRpc3BhdGNoLAogICAgc3Vic2NyaWJlLAogICAgZ2V0U3RhdGUsCiAgICByZXBsYWNlUmVkdWNlciwKICAgIFtzeW1ib2xfb2JzZXJ2YWJsZV9kZWZhdWx0XTogb2JzZXJ2YWJsZQogIH07CiAgcmV0dXJuIHN0b3JlOwp9CmZ1bmN0aW9uIHdhcm5pbmcobWVzc2FnZSkgewogIGlmICh0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIGNvbnNvbGUuZXJyb3IgPT09ICJmdW5jdGlvbiIpIHsKICAgIGNvbnNvbGUuZXJyb3IobWVzc2FnZSk7CiAgfQogIHRyeSB7CiAgICB0aHJvdyBuZXcgRXJyb3IobWVzc2FnZSk7CiAgfSBjYXRjaCAoZSkgewogIH0KfQpmdW5jdGlvbiBnZXRVbmV4cGVjdGVkU3RhdGVTaGFwZVdhcm5pbmdNZXNzYWdlKGlucHV0U3RhdGUsIHJlZHVjZXJzLCBhY3Rpb24sIHVuZXhwZWN0ZWRLZXlDYWNoZSkgewogIGNvbnN0IHJlZHVjZXJLZXlzID0gT2JqZWN0LmtleXMocmVkdWNlcnMpOwogIGNvbnN0IGFyZ3VtZW50TmFtZSA9IGFjdGlvbiAmJiBhY3Rpb24udHlwZSA9PT0gYWN0aW9uVHlwZXNfZGVmYXVsdC5JTklUID8gInByZWxvYWRlZFN0YXRlIGFyZ3VtZW50IHBhc3NlZCB0byBjcmVhdGVTdG9yZSIgOiAicHJldmlvdXMgc3RhdGUgcmVjZWl2ZWQgYnkgdGhlIHJlZHVjZXIiOwogIGlmIChyZWR1Y2VyS2V5cy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiAiU3RvcmUgZG9lcyBub3QgaGF2ZSBhIHZhbGlkIHJlZHVjZXIuIE1ha2Ugc3VyZSB0aGUgYXJndW1lbnQgcGFzc2VkIHRvIGNvbWJpbmVSZWR1Y2VycyBpcyBhbiBvYmplY3Qgd2hvc2UgdmFsdWVzIGFyZSByZWR1Y2Vycy4iOwogIH0KICBpZiAoIWlzUGxhaW5PYmplY3QoaW5wdXRTdGF0ZSkpIHsKICAgIHJldHVybiBgVGhlICR7YXJndW1lbnROYW1lfSBoYXMgdW5leHBlY3RlZCB0eXBlIG9mICIke2tpbmRPZihpbnB1dFN0YXRlKX0iLiBFeHBlY3RlZCBhcmd1bWVudCB0byBiZSBhbiBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIGtleXM6ICIke3JlZHVjZXJLZXlzLmpvaW4oJyIsICInKX0iYDsKICB9CiAgY29uc3QgdW5leHBlY3RlZEtleXMgPSBPYmplY3Qua2V5cyhpbnB1dFN0YXRlKS5maWx0ZXIoKGtleSkgPT4gIXJlZHVjZXJzLmhhc093blByb3BlcnR5KGtleSkgJiYgIXVuZXhwZWN0ZWRLZXlDYWNoZVtrZXldKTsKICB1bmV4cGVjdGVkS2V5cy5mb3JFYWNoKChrZXkpID0+IHsKICAgIHVuZXhwZWN0ZWRLZXlDYWNoZVtrZXldID0gdHJ1ZTsKICB9KTsKICBpZiAoYWN0aW9uICYmIGFjdGlvbi50eXBlID09PSBhY3Rpb25UeXBlc19kZWZhdWx0LlJFUExBQ0UpCiAgICByZXR1cm47CiAgaWYgKHVuZXhwZWN0ZWRLZXlzLmxlbmd0aCA+IDApIHsKICAgIHJldHVybiBgVW5leHBlY3RlZCAke3VuZXhwZWN0ZWRLZXlzLmxlbmd0aCA+IDEgPyAia2V5cyIgOiAia2V5In0gIiR7dW5leHBlY3RlZEtleXMuam9pbignIiwgIicpfSIgZm91bmQgaW4gJHthcmd1bWVudE5hbWV9LiBFeHBlY3RlZCB0byBmaW5kIG9uZSBvZiB0aGUga25vd24gcmVkdWNlciBrZXlzIGluc3RlYWQ6ICIke3JlZHVjZXJLZXlzLmpvaW4oJyIsICInKX0iLiBVbmV4cGVjdGVkIGtleXMgd2lsbCBiZSBpZ25vcmVkLmA7CiAgfQp9CmZ1bmN0aW9uIGFzc2VydFJlZHVjZXJTaGFwZShyZWR1Y2VycykgewogIE9iamVjdC5rZXlzKHJlZHVjZXJzKS5mb3JFYWNoKChrZXkpID0+IHsKICAgIGNvbnN0IHJlZHVjZXIgPSByZWR1Y2Vyc1trZXldOwogICAgY29uc3QgaW5pdGlhbFN0YXRlMTMgPSByZWR1Y2VyKHZvaWQgMCwgewogICAgICB0eXBlOiBhY3Rpb25UeXBlc19kZWZhdWx0LklOSVQKICAgIH0pOwogICAgaWYgKHR5cGVvZiBpbml0aWFsU3RhdGUxMyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxMikgOiBgVGhlIHNsaWNlIHJlZHVjZXIgZm9yIGtleSAiJHtrZXl9IiByZXR1cm5lZCB1bmRlZmluZWQgZHVyaW5nIGluaXRpYWxpemF0aW9uLiBJZiB0aGUgc3RhdGUgcGFzc2VkIHRvIHRoZSByZWR1Y2VyIGlzIHVuZGVmaW5lZCwgeW91IG11c3QgZXhwbGljaXRseSByZXR1cm4gdGhlIGluaXRpYWwgc3RhdGUuIFRoZSBpbml0aWFsIHN0YXRlIG1heSBub3QgYmUgdW5kZWZpbmVkLiBJZiB5b3UgZG9uJ3Qgd2FudCB0byBzZXQgYSB2YWx1ZSBmb3IgdGhpcyByZWR1Y2VyLCB5b3UgY2FuIHVzZSBudWxsIGluc3RlYWQgb2YgdW5kZWZpbmVkLmApOwogICAgfQogICAgaWYgKHR5cGVvZiByZWR1Y2VyKHZvaWQgMCwgewogICAgICB0eXBlOiBhY3Rpb25UeXBlc19kZWZhdWx0LlBST0JFX1VOS05PV05fQUNUSU9OKCkKICAgIH0pID09PSAidW5kZWZpbmVkIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEzKSA6IGBUaGUgc2xpY2UgcmVkdWNlciBmb3Iga2V5ICIke2tleX0iIHJldHVybmVkIHVuZGVmaW5lZCB3aGVuIHByb2JlZCB3aXRoIGEgcmFuZG9tIHR5cGUuIERvbid0IHRyeSB0byBoYW5kbGUgJyR7YWN0aW9uVHlwZXNfZGVmYXVsdC5JTklUfScgb3Igb3RoZXIgYWN0aW9ucyBpbiAicmVkdXgvKiIgbmFtZXNwYWNlLiBUaGV5IGFyZSBjb25zaWRlcmVkIHByaXZhdGUuIEluc3RlYWQsIHlvdSBtdXN0IHJldHVybiB0aGUgY3VycmVudCBzdGF0ZSBmb3IgYW55IHVua25vd24gYWN0aW9ucywgdW5sZXNzIGl0IGlzIHVuZGVmaW5lZCwgaW4gd2hpY2ggY2FzZSB5b3UgbXVzdCByZXR1cm4gdGhlIGluaXRpYWwgc3RhdGUsIHJlZ2FyZGxlc3Mgb2YgdGhlIGFjdGlvbiB0eXBlLiBUaGUgaW5pdGlhbCBzdGF0ZSBtYXkgbm90IGJlIHVuZGVmaW5lZCwgYnV0IGNhbiBiZSBudWxsLmApOwogICAgfQogIH0pOwp9CmZ1bmN0aW9uIGNvbWJpbmVSZWR1Y2VycyhyZWR1Y2VycykgewogIGNvbnN0IHJlZHVjZXJLZXlzID0gT2JqZWN0LmtleXMocmVkdWNlcnMpOwogIGNvbnN0IGZpbmFsUmVkdWNlcnMgPSB7fTsKICBmb3IgKGxldCBpID0gMDsgaSA8IHJlZHVjZXJLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBrZXkgPSByZWR1Y2VyS2V5c1tpXTsKICAgIGlmICh0cnVlKSB7CiAgICAgIGlmICh0eXBlb2YgcmVkdWNlcnNba2V5XSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICB3YXJuaW5nKGBObyByZWR1Y2VyIHByb3ZpZGVkIGZvciBrZXkgIiR7a2V5fSJgKTsKICAgICAgfQogICAgfQogICAgaWYgKHR5cGVvZiByZWR1Y2Vyc1trZXldID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGZpbmFsUmVkdWNlcnNba2V5XSA9IHJlZHVjZXJzW2tleV07CiAgICB9CiAgfQogIGNvbnN0IGZpbmFsUmVkdWNlcktleXMgPSBPYmplY3Qua2V5cyhmaW5hbFJlZHVjZXJzKTsKICBsZXQgdW5leHBlY3RlZEtleUNhY2hlOwogIGlmICh0cnVlKSB7CiAgICB1bmV4cGVjdGVkS2V5Q2FjaGUgPSB7fTsKICB9CiAgbGV0IHNoYXBlQXNzZXJ0aW9uRXJyb3I7CiAgdHJ5IHsKICAgIGFzc2VydFJlZHVjZXJTaGFwZShmaW5hbFJlZHVjZXJzKTsKICB9IGNhdGNoIChlKSB7CiAgICBzaGFwZUFzc2VydGlvbkVycm9yID0gZTsKICB9CiAgcmV0dXJuIGZ1bmN0aW9uIGNvbWJpbmF0aW9uKHN0YXRlID0ge30sIGFjdGlvbikgewogICAgaWYgKHNoYXBlQXNzZXJ0aW9uRXJyb3IpIHsKICAgICAgdGhyb3cgc2hhcGVBc3NlcnRpb25FcnJvcjsKICAgIH0KICAgIGlmICh0cnVlKSB7CiAgICAgIGNvbnN0IHdhcm5pbmdNZXNzYWdlID0gZ2V0VW5leHBlY3RlZFN0YXRlU2hhcGVXYXJuaW5nTWVzc2FnZShzdGF0ZSwgZmluYWxSZWR1Y2VycywgYWN0aW9uLCB1bmV4cGVjdGVkS2V5Q2FjaGUpOwogICAgICBpZiAod2FybmluZ01lc3NhZ2UpIHsKICAgICAgICB3YXJuaW5nKHdhcm5pbmdNZXNzYWdlKTsKICAgICAgfQogICAgfQogICAgbGV0IGhhc0NoYW5nZWQgPSBmYWxzZTsKICAgIGNvbnN0IG5leHRTdGF0ZSA9IHt9OwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaW5hbFJlZHVjZXJLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGtleSA9IGZpbmFsUmVkdWNlcktleXNbaV07CiAgICAgIGNvbnN0IHJlZHVjZXIgPSBmaW5hbFJlZHVjZXJzW2tleV07CiAgICAgIGNvbnN0IHByZXZpb3VzU3RhdGVGb3JLZXkgPSBzdGF0ZVtrZXldOwogICAgICBjb25zdCBuZXh0U3RhdGVGb3JLZXkgPSByZWR1Y2VyKHByZXZpb3VzU3RhdGVGb3JLZXksIGFjdGlvbik7CiAgICAgIGlmICh0eXBlb2YgbmV4dFN0YXRlRm9yS2V5ID09PSAidW5kZWZpbmVkIikgewogICAgICAgIGNvbnN0IGFjdGlvblR5cGUgPSBhY3Rpb24gJiYgYWN0aW9uLnR5cGU7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNCkgOiBgV2hlbiBjYWxsZWQgd2l0aCBhbiBhY3Rpb24gb2YgdHlwZSAke2FjdGlvblR5cGUgPyBgIiR7U3RyaW5nKGFjdGlvblR5cGUpfSJgIDogIih1bmtub3duIHR5cGUpIn0sIHRoZSBzbGljZSByZWR1Y2VyIGZvciBrZXkgIiR7a2V5fSIgcmV0dXJuZWQgdW5kZWZpbmVkLiBUbyBpZ25vcmUgYW4gYWN0aW9uLCB5b3UgbXVzdCBleHBsaWNpdGx5IHJldHVybiB0aGUgcHJldmlvdXMgc3RhdGUuIElmIHlvdSB3YW50IHRoaXMgcmVkdWNlciB0byBob2xkIG5vIHZhbHVlLCB5b3UgY2FuIHJldHVybiBudWxsIGluc3RlYWQgb2YgdW5kZWZpbmVkLmApOwogICAgICB9CiAgICAgIG5leHRTdGF0ZVtrZXldID0gbmV4dFN0YXRlRm9yS2V5OwogICAgICBoYXNDaGFuZ2VkID0gaGFzQ2hhbmdlZCB8fCBuZXh0U3RhdGVGb3JLZXkgIT09IHByZXZpb3VzU3RhdGVGb3JLZXk7CiAgICB9CiAgICBoYXNDaGFuZ2VkID0gaGFzQ2hhbmdlZCB8fCBmaW5hbFJlZHVjZXJLZXlzLmxlbmd0aCAhPT0gT2JqZWN0LmtleXMoc3RhdGUpLmxlbmd0aDsKICAgIHJldHVybiBoYXNDaGFuZ2VkID8gbmV4dFN0YXRlIDogc3RhdGU7CiAgfTsKfQpmdW5jdGlvbiBjb21wb3NlKC4uLmZ1bmNzKSB7CiAgaWYgKGZ1bmNzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIChhcmcpID0+IGFyZzsKICB9CiAgaWYgKGZ1bmNzLmxlbmd0aCA9PT0gMSkgewogICAgcmV0dXJuIGZ1bmNzWzBdOwogIH0KICByZXR1cm4gZnVuY3MucmVkdWNlKChhLCBiKSA9PiAoLi4uYXJncykgPT4gYShiKC4uLmFyZ3MpKSk7Cn0KZnVuY3Rpb24gYXBwbHlNaWRkbGV3YXJlKC4uLm1pZGRsZXdhcmVzKSB7CiAgcmV0dXJuIChjcmVhdGVTdG9yZTIpID0+IChyZWR1Y2VyLCBwcmVsb2FkZWRTdGF0ZSkgPT4gewogICAgY29uc3Qgc3RvcmUgPSBjcmVhdGVTdG9yZTIocmVkdWNlciwgcHJlbG9hZGVkU3RhdGUpOwogICAgbGV0IGRpc3BhdGNoID0gKCkgPT4gewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE1KSA6ICJEaXNwYXRjaGluZyB3aGlsZSBjb25zdHJ1Y3RpbmcgeW91ciBtaWRkbGV3YXJlIGlzIG5vdCBhbGxvd2VkLiBPdGhlciBtaWRkbGV3YXJlIHdvdWxkIG5vdCBiZSBhcHBsaWVkIHRvIHRoaXMgZGlzcGF0Y2guIik7CiAgICB9OwogICAgY29uc3QgbWlkZGxld2FyZUFQSSA9IHsKICAgICAgZ2V0U3RhdGU6IHN0b3JlLmdldFN0YXRlLAogICAgICBkaXNwYXRjaDogKGFjdGlvbiwgLi4uYXJncykgPT4gZGlzcGF0Y2goYWN0aW9uLCAuLi5hcmdzKQogICAgfTsKICAgIGNvbnN0IGNoYWluID0gbWlkZGxld2FyZXMubWFwKChtaWRkbGV3YXJlKSA9PiBtaWRkbGV3YXJlKG1pZGRsZXdhcmVBUEkpKTsKICAgIGRpc3BhdGNoID0gY29tcG9zZSguLi5jaGFpbikoc3RvcmUuZGlzcGF0Y2gpOwogICAgcmV0dXJuIHsKICAgICAgLi4uc3RvcmUsCiAgICAgIGRpc3BhdGNoCiAgICB9OwogIH07Cn0KZnVuY3Rpb24gaXNBY3Rpb24oYWN0aW9uKSB7CiAgcmV0dXJuIGlzUGxhaW5PYmplY3QoYWN0aW9uKSAmJiAidHlwZSIgaW4gYWN0aW9uICYmIHR5cGVvZiBhY3Rpb24udHlwZSA9PT0gInN0cmluZyI7Cn0KCi8vIG5vZGVfbW9kdWxlcy9AcmVkdXhqcy90b29sa2l0L25vZGVfbW9kdWxlcy9pbW1lci9kaXN0L2ltbWVyLm1qcwp2YXIgTk9USElORyA9IFN5bWJvbC5mb3IoImltbWVyLW5vdGhpbmciKTsKdmFyIERSQUZUQUJMRSA9IFN5bWJvbC5mb3IoImltbWVyLWRyYWZ0YWJsZSIpOwp2YXIgRFJBRlRfU1RBVEUgPSBTeW1ib2wuZm9yKCJpbW1lci1zdGF0ZSIpOwp2YXIgZXJyb3JzID0gdHJ1ZSA/IFsKICAvLyBBbGwgZXJyb3IgY29kZXMsIHN0YXJ0aW5nIGJ5IDA6CiAgZnVuY3Rpb24ocGx1Z2luKSB7CiAgICByZXR1cm4gYFRoZSBwbHVnaW4gZm9yICcke3BsdWdpbn0nIGhhcyBub3QgYmVlbiBsb2FkZWQgaW50byBJbW1lci4gVG8gZW5hYmxlIHRoZSBwbHVnaW4sIGltcG9ydCBhbmQgY2FsbCBcYGVuYWJsZSR7cGx1Z2lufSgpXGAgd2hlbiBpbml0aWFsaXppbmcgeW91ciBhcHBsaWNhdGlvbi5gOwogIH0sCiAgZnVuY3Rpb24odGhpbmcpIHsKICAgIHJldHVybiBgcHJvZHVjZSBjYW4gb25seSBiZSBjYWxsZWQgb24gdGhpbmdzIHRoYXQgYXJlIGRyYWZ0YWJsZTogcGxhaW4gb2JqZWN0cywgYXJyYXlzLCBNYXAsIFNldCBvciBjbGFzc2VzIHRoYXQgYXJlIG1hcmtlZCB3aXRoICdbaW1tZXJhYmxlXTogdHJ1ZScuIEdvdCAnJHt0aGluZ30nYDsKICB9LAogICJUaGlzIG9iamVjdCBoYXMgYmVlbiBmcm96ZW4gYW5kIHNob3VsZCBub3QgYmUgbXV0YXRlZCIsCiAgZnVuY3Rpb24oZGF0YSkgewogICAgcmV0dXJuICJDYW5ub3QgdXNlIGEgcHJveHkgdGhhdCBoYXMgYmVlbiByZXZva2VkLiBEaWQgeW91IHBhc3MgYW4gb2JqZWN0IGZyb20gaW5zaWRlIGFuIGltbWVyIGZ1bmN0aW9uIHRvIGFuIGFzeW5jIHByb2Nlc3M/ICIgKyBkYXRhOwogIH0sCiAgIkFuIGltbWVyIHByb2R1Y2VyIHJldHVybmVkIGEgbmV3IHZhbHVlICphbmQqIG1vZGlmaWVkIGl0cyBkcmFmdC4gRWl0aGVyIHJldHVybiBhIG5ldyB2YWx1ZSAqb3IqIG1vZGlmeSB0aGUgZHJhZnQuIiwKICAiSW1tZXIgZm9yYmlkcyBjaXJjdWxhciByZWZlcmVuY2VzIiwKICAiVGhlIGZpcnN0IG9yIHNlY29uZCBhcmd1bWVudCB0byBgcHJvZHVjZWAgbXVzdCBiZSBhIGZ1bmN0aW9uIiwKICAiVGhlIHRoaXJkIGFyZ3VtZW50IHRvIGBwcm9kdWNlYCBtdXN0IGJlIGEgZnVuY3Rpb24gb3IgdW5kZWZpbmVkIiwKICAiRmlyc3QgYXJndW1lbnQgdG8gYGNyZWF0ZURyYWZ0YCBtdXN0IGJlIGEgcGxhaW4gb2JqZWN0LCBhbiBhcnJheSwgb3IgYW4gaW1tZXJhYmxlIG9iamVjdCIsCiAgIkZpcnN0IGFyZ3VtZW50IHRvIGBmaW5pc2hEcmFmdGAgbXVzdCBiZSBhIGRyYWZ0IHJldHVybmVkIGJ5IGBjcmVhdGVEcmFmdGAiLAogIGZ1bmN0aW9uKHRoaW5nKSB7CiAgICByZXR1cm4gYCdjdXJyZW50JyBleHBlY3RzIGEgZHJhZnQsIGdvdDogJHt0aGluZ31gOwogIH0sCiAgIk9iamVjdC5kZWZpbmVQcm9wZXJ0eSgpIGNhbm5vdCBiZSB1c2VkIG9uIGFuIEltbWVyIGRyYWZ0IiwKICAiT2JqZWN0LnNldFByb3RvdHlwZU9mKCkgY2Fubm90IGJlIHVzZWQgb24gYW4gSW1tZXIgZHJhZnQiLAogICJJbW1lciBvbmx5IHN1cHBvcnRzIGRlbGV0aW5nIGFycmF5IGluZGljZXMiLAogICJJbW1lciBvbmx5IHN1cHBvcnRzIHNldHRpbmcgYXJyYXkgaW5kaWNlcyBhbmQgdGhlICdsZW5ndGgnIHByb3BlcnR5IiwKICBmdW5jdGlvbih0aGluZykgewogICAgcmV0dXJuIGAnb3JpZ2luYWwnIGV4cGVjdHMgYSBkcmFmdCwgZ290OiAke3RoaW5nfWA7CiAgfQogIC8vIE5vdGU6IGlmIG1vcmUgZXJyb3JzIGFyZSBhZGRlZCwgdGhlIGVycm9yT2Zmc2V0IGluIFBhdGNoZXMudHMgc2hvdWxkIGJlIGluY3JlYXNlZAogIC8vIFNlZSBQYXRjaGVzLnRzIGZvciBhZGRpdGlvbmFsIGVycm9ycwpdIDogW107CmZ1bmN0aW9uIGRpZShlcnJvciwgLi4uYXJncykgewogIGlmICh0cnVlKSB7CiAgICBjb25zdCBlID0gZXJyb3JzW2Vycm9yXTsKICAgIGNvbnN0IG1zZyA9IGlzRnVuY3Rpb24oZSkgPyBlLmFwcGx5KG51bGwsIGFyZ3MpIDogZTsKICAgIHRocm93IG5ldyBFcnJvcihgW0ltbWVyXSAke21zZ31gKTsKICB9CiAgdGhyb3cgbmV3IEVycm9yKAogICAgYFtJbW1lcl0gbWluaWZpZWQgZXJyb3IgbnI6ICR7ZXJyb3J9LiBGdWxsIGVycm9yIGF0OiBodHRwczovL2JpdC5seS8zY1hFS1dmYAogICk7Cn0KdmFyIE8gPSBPYmplY3Q7CnZhciBnZXRQcm90b3R5cGVPZiA9IE8uZ2V0UHJvdG90eXBlT2Y7CnZhciBDT05TVFJVQ1RPUiA9ICJjb25zdHJ1Y3RvciI7CnZhciBQUk9UT1RZUEUgPSAicHJvdG90eXBlIjsKdmFyIENPTkZJR1VSQUJMRSA9ICJjb25maWd1cmFibGUiOwp2YXIgRU5VTUVSQUJMRSA9ICJlbnVtZXJhYmxlIjsKdmFyIFdSSVRBQkxFID0gIndyaXRhYmxlIjsKdmFyIFZBTFVFID0gInZhbHVlIjsKdmFyIGlzRHJhZnQgPSAodmFsdWUpID0+ICEhdmFsdWUgJiYgISF2YWx1ZVtEUkFGVF9TVEFURV07CmZ1bmN0aW9uIGlzRHJhZnRhYmxlKHZhbHVlKSB7CiAgaWYgKCF2YWx1ZSkKICAgIHJldHVybiBmYWxzZTsKICByZXR1cm4gaXNQbGFpbk9iamVjdDIodmFsdWUpIHx8IGlzQXJyYXkodmFsdWUpIHx8ICEhdmFsdWVbRFJBRlRBQkxFXSB8fCAhIXZhbHVlW0NPTlNUUlVDVE9SXT8uW0RSQUZUQUJMRV0gfHwgaXNNYXAodmFsdWUpIHx8IGlzU2V0KHZhbHVlKTsKfQp2YXIgb2JqZWN0Q3RvclN0cmluZyA9IE9bUFJPVE9UWVBFXVtDT05TVFJVQ1RPUl0udG9TdHJpbmcoKTsKdmFyIGNhY2hlZEN0b3JTdHJpbmdzID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CmZ1bmN0aW9uIGlzUGxhaW5PYmplY3QyKHZhbHVlKSB7CiAgaWYgKCF2YWx1ZSB8fCAhaXNPYmplY3Rpc2godmFsdWUpKQogICAgcmV0dXJuIGZhbHNlOwogIGNvbnN0IHByb3RvMiA9IGdldFByb3RvdHlwZU9mKHZhbHVlKTsKICBpZiAocHJvdG8yID09PSBudWxsIHx8IHByb3RvMiA9PT0gT1tQUk9UT1RZUEVdKQogICAgcmV0dXJuIHRydWU7CiAgY29uc3QgQ3RvciA9IE8uaGFzT3duUHJvcGVydHkuY2FsbChwcm90bzIsIENPTlNUUlVDVE9SKSAmJiBwcm90bzJbQ09OU1RSVUNUT1JdOwogIGlmIChDdG9yID09PSBPYmplY3QpCiAgICByZXR1cm4gdHJ1ZTsKICBpZiAoIWlzRnVuY3Rpb24oQ3RvcikpCiAgICByZXR1cm4gZmFsc2U7CiAgbGV0IGN0b3JTdHJpbmcgPSBjYWNoZWRDdG9yU3RyaW5ncy5nZXQoQ3Rvcik7CiAgaWYgKGN0b3JTdHJpbmcgPT09IHZvaWQgMCkgewogICAgY3RvclN0cmluZyA9IEZ1bmN0aW9uLnRvU3RyaW5nLmNhbGwoQ3Rvcik7CiAgICBjYWNoZWRDdG9yU3RyaW5ncy5zZXQoQ3RvciwgY3RvclN0cmluZyk7CiAgfQogIHJldHVybiBjdG9yU3RyaW5nID09PSBvYmplY3RDdG9yU3RyaW5nOwp9CmZ1bmN0aW9uIGVhY2gob2JqLCBpdGVyLCBzdHJpY3QgPSB0cnVlKSB7CiAgaWYgKGdldEFyY2h0eXBlKG9iaikgPT09IDApIHsKICAgIGNvbnN0IGtleXMgPSBzdHJpY3QgPyBSZWZsZWN0Lm93bktleXMob2JqKSA6IE8ua2V5cyhvYmopOwogICAga2V5cy5mb3JFYWNoKChrZXkpID0+IHsKICAgICAgaXRlcihrZXksIG9ialtrZXldLCBvYmopOwogICAgfSk7CiAgfSBlbHNlIHsKICAgIG9iai5mb3JFYWNoKChlbnRyeSwgaW5kZXgpID0+IGl0ZXIoaW5kZXgsIGVudHJ5LCBvYmopKTsKICB9Cn0KZnVuY3Rpb24gZ2V0QXJjaHR5cGUodGhpbmcpIHsKICBjb25zdCBzdGF0ZSA9IHRoaW5nW0RSQUZUX1NUQVRFXTsKICByZXR1cm4gc3RhdGUgPyBzdGF0ZS50eXBlXyA6IGlzQXJyYXkodGhpbmcpID8gMSA6IGlzTWFwKHRoaW5nKSA/IDIgOiBpc1NldCh0aGluZykgPyAzIDogMDsKfQp2YXIgaGFzID0gKHRoaW5nLCBwcm9wLCB0eXBlID0gZ2V0QXJjaHR5cGUodGhpbmcpKSA9PiB0eXBlID09PSAyID8gdGhpbmcuaGFzKHByb3ApIDogT1tQUk9UT1RZUEVdLmhhc093blByb3BlcnR5LmNhbGwodGhpbmcsIHByb3ApOwp2YXIgZ2V0MiA9ICh0aGluZywgcHJvcCwgdHlwZSA9IGdldEFyY2h0eXBlKHRoaW5nKSkgPT4gKAogIC8vIEB0cy1pZ25vcmUKICB0eXBlID09PSAyID8gdGhpbmcuZ2V0KHByb3ApIDogdGhpbmdbcHJvcF0KKTsKdmFyIHNldCA9ICh0aGluZywgcHJvcE9yT2xkVmFsdWUsIHZhbHVlLCB0eXBlID0gZ2V0QXJjaHR5cGUodGhpbmcpKSA9PiB7CiAgaWYgKHR5cGUgPT09IDIpCiAgICB0aGluZy5zZXQocHJvcE9yT2xkVmFsdWUsIHZhbHVlKTsKICBlbHNlIGlmICh0eXBlID09PSAzKSB7CiAgICB0aGluZy5hZGQodmFsdWUpOwogIH0gZWxzZQogICAgdGhpbmdbcHJvcE9yT2xkVmFsdWVdID0gdmFsdWU7Cn07CmZ1bmN0aW9uIGlzKHgyLCB5MikgewogIGlmICh4MiA9PT0geTIpIHsKICAgIHJldHVybiB4MiAhPT0gMCB8fCAxIC8geDIgPT09IDEgLyB5MjsKICB9IGVsc2UgewogICAgcmV0dXJuIHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgfQp9CnZhciBpc0FycmF5ID0gQXJyYXkuaXNBcnJheTsKdmFyIGlzTWFwID0gKHRhcmdldCkgPT4gdGFyZ2V0IGluc3RhbmNlb2YgTWFwOwp2YXIgaXNTZXQgPSAodGFyZ2V0KSA9PiB0YXJnZXQgaW5zdGFuY2VvZiBTZXQ7CnZhciBpc09iamVjdGlzaCA9ICh0YXJnZXQpID0+IHR5cGVvZiB0YXJnZXQgPT09ICJvYmplY3QiOwp2YXIgaXNGdW5jdGlvbiA9ICh0YXJnZXQpID0+IHR5cGVvZiB0YXJnZXQgPT09ICJmdW5jdGlvbiI7CnZhciBpc0Jvb2xlYW4gPSAodGFyZ2V0KSA9PiB0eXBlb2YgdGFyZ2V0ID09PSAiYm9vbGVhbiI7CnZhciBsYXRlc3QgPSAoc3RhdGUpID0+IHN0YXRlLmNvcHlfIHx8IHN0YXRlLmJhc2VfOwp2YXIgZ2V0RmluYWxWYWx1ZSA9IChzdGF0ZSkgPT4gc3RhdGUubW9kaWZpZWRfID8gc3RhdGUuY29weV8gOiBzdGF0ZS5iYXNlXzsKZnVuY3Rpb24gc2hhbGxvd0NvcHkoYmFzZSwgc3RyaWN0KSB7CiAgaWYgKGlzTWFwKGJhc2UpKSB7CiAgICByZXR1cm4gbmV3IE1hcChiYXNlKTsKICB9CiAgaWYgKGlzU2V0KGJhc2UpKSB7CiAgICByZXR1cm4gbmV3IFNldChiYXNlKTsKICB9CiAgaWYgKGlzQXJyYXkoYmFzZSkpCiAgICByZXR1cm4gQXJyYXlbUFJPVE9UWVBFXS5zbGljZS5jYWxsKGJhc2UpOwogIGNvbnN0IGlzUGxhaW4yID0gaXNQbGFpbk9iamVjdDIoYmFzZSk7CiAgaWYgKHN0cmljdCA9PT0gdHJ1ZSB8fCBzdHJpY3QgPT09ICJjbGFzc19vbmx5IiAmJiAhaXNQbGFpbjIpIHsKICAgIGNvbnN0IGRlc2NyaXB0b3JzID0gTy5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKGJhc2UpOwogICAgZGVsZXRlIGRlc2NyaXB0b3JzW0RSQUZUX1NUQVRFXTsKICAgIGxldCBrZXlzID0gUmVmbGVjdC5vd25LZXlzKGRlc2NyaXB0b3JzKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBrZXkgPSBrZXlzW2ldOwogICAgICBjb25zdCBkZXNjID0gZGVzY3JpcHRvcnNba2V5XTsKICAgICAgaWYgKGRlc2NbV1JJVEFCTEVdID09PSBmYWxzZSkgewogICAgICAgIGRlc2NbV1JJVEFCTEVdID0gdHJ1ZTsKICAgICAgICBkZXNjW0NPTkZJR1VSQUJMRV0gPSB0cnVlOwogICAgICB9CiAgICAgIGlmIChkZXNjLmdldCB8fCBkZXNjLnNldCkKICAgICAgICBkZXNjcmlwdG9yc1trZXldID0gewogICAgICAgICAgW0NPTkZJR1VSQUJMRV06IHRydWUsCiAgICAgICAgICBbV1JJVEFCTEVdOiB0cnVlLAogICAgICAgICAgLy8gY291bGQgbGl2ZSB3aXRoICEhZGVzYy5zZXQgYXMgd2VsbCBoZXJlLi4uCiAgICAgICAgICBbRU5VTUVSQUJMRV06IGRlc2NbRU5VTUVSQUJMRV0sCiAgICAgICAgICBbVkFMVUVdOiBiYXNlW2tleV0KICAgICAgICB9OwogICAgfQogICAgcmV0dXJuIE8uY3JlYXRlKGdldFByb3RvdHlwZU9mKGJhc2UpLCBkZXNjcmlwdG9ycyk7CiAgfSBlbHNlIHsKICAgIGNvbnN0IHByb3RvMiA9IGdldFByb3RvdHlwZU9mKGJhc2UpOwogICAgaWYgKHByb3RvMiAhPT0gbnVsbCAmJiBpc1BsYWluMikgewogICAgICByZXR1cm4geyAuLi5iYXNlIH07CiAgICB9CiAgICBjb25zdCBvYmogPSBPLmNyZWF0ZShwcm90bzIpOwogICAgcmV0dXJuIE8uYXNzaWduKG9iaiwgYmFzZSk7CiAgfQp9CmZ1bmN0aW9uIGZyZWV6ZShvYmosIGRlZXAgPSBmYWxzZSkgewogIGlmIChpc0Zyb3plbihvYmopIHx8IGlzRHJhZnQob2JqKSB8fCAhaXNEcmFmdGFibGUob2JqKSkKICAgIHJldHVybiBvYmo7CiAgaWYgKGdldEFyY2h0eXBlKG9iaikgPiAxKSB7CiAgICBPLmRlZmluZVByb3BlcnRpZXMob2JqLCB7CiAgICAgIHNldDogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlLAogICAgICBhZGQ6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZSwKICAgICAgY2xlYXI6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZSwKICAgICAgZGVsZXRlOiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUKICAgIH0pOwogIH0KICBPLmZyZWV6ZShvYmopOwogIGlmIChkZWVwKQogICAgZWFjaCgKICAgICAgb2JqLAogICAgICAoX2tleSwgdmFsdWUpID0+IHsKICAgICAgICBmcmVlemUodmFsdWUsIHRydWUpOwogICAgICB9LAogICAgICBmYWxzZQogICAgKTsKICByZXR1cm4gb2JqOwp9CmZ1bmN0aW9uIGRvbnRNdXRhdGVGcm96ZW5Db2xsZWN0aW9ucygpIHsKICBkaWUoMik7Cn0KdmFyIGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZSA9IHsKICBbVkFMVUVdOiBkb250TXV0YXRlRnJvemVuQ29sbGVjdGlvbnMKfTsKZnVuY3Rpb24gaXNGcm96ZW4ob2JqKSB7CiAgaWYgKG9iaiA9PT0gbnVsbCB8fCAhaXNPYmplY3Rpc2gob2JqKSkKICAgIHJldHVybiB0cnVlOwogIHJldHVybiBPLmlzRnJvemVuKG9iaik7Cn0KdmFyIFBsdWdpbk1hcFNldCA9ICJNYXBTZXQiOwp2YXIgUGx1Z2luUGF0Y2hlcyA9ICJQYXRjaGVzIjsKdmFyIHBsdWdpbnMgPSB7fTsKZnVuY3Rpb24gZ2V0UGx1Z2luKHBsdWdpbktleSkgewogIGNvbnN0IHBsdWdpbiA9IHBsdWdpbnNbcGx1Z2luS2V5XTsKICBpZiAoIXBsdWdpbikgewogICAgZGllKDAsIHBsdWdpbktleSk7CiAgfQogIHJldHVybiBwbHVnaW47Cn0KdmFyIGlzUGx1Z2luTG9hZGVkID0gKHBsdWdpbktleSkgPT4gISFwbHVnaW5zW3BsdWdpbktleV07CnZhciBjdXJyZW50U2NvcGU7CnZhciBnZXRDdXJyZW50U2NvcGUgPSAoKSA9PiBjdXJyZW50U2NvcGU7CnZhciBjcmVhdGVTY29wZSA9IChwYXJlbnRfLCBpbW1lcl8pID0+ICh7CiAgZHJhZnRzXzogW10sCiAgcGFyZW50XywKICBpbW1lcl8sCiAgLy8gV2hlbmV2ZXIgdGhlIG1vZGlmaWVkIGRyYWZ0IGNvbnRhaW5zIGEgZHJhZnQgZnJvbSBhbm90aGVyIHNjb3BlLCB3ZQogIC8vIG5lZWQgdG8gcHJldmVudCBhdXRvLWZyZWV6aW5nIHNvIHRoZSB1bm93bmVkIGRyYWZ0IGNhbiBiZSBmaW5hbGl6ZWQuCiAgY2FuQXV0b0ZyZWV6ZV86IHRydWUsCiAgdW5maW5hbGl6ZWREcmFmdHNfOiAwLAogIGhhbmRsZWRTZXRfOiAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpLAogIHByb2Nlc3NlZEZvclBhdGNoZXNfOiAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpLAogIG1hcFNldFBsdWdpbl86IGlzUGx1Z2luTG9hZGVkKFBsdWdpbk1hcFNldCkgPyBnZXRQbHVnaW4oUGx1Z2luTWFwU2V0KSA6IHZvaWQgMAp9KTsKZnVuY3Rpb24gdXNlUGF0Y2hlc0luU2NvcGUoc2NvcGUsIHBhdGNoTGlzdGVuZXIpIHsKICBpZiAocGF0Y2hMaXN0ZW5lcikgewogICAgc2NvcGUucGF0Y2hQbHVnaW5fID0gZ2V0UGx1Z2luKFBsdWdpblBhdGNoZXMpOwogICAgc2NvcGUucGF0Y2hlc18gPSBbXTsKICAgIHNjb3BlLmludmVyc2VQYXRjaGVzXyA9IFtdOwogICAgc2NvcGUucGF0Y2hMaXN0ZW5lcl8gPSBwYXRjaExpc3RlbmVyOwogIH0KfQpmdW5jdGlvbiByZXZva2VTY29wZShzY29wZSkgewogIGxlYXZlU2NvcGUoc2NvcGUpOwogIHNjb3BlLmRyYWZ0c18uZm9yRWFjaChyZXZva2VEcmFmdCk7CiAgc2NvcGUuZHJhZnRzXyA9IG51bGw7Cn0KZnVuY3Rpb24gbGVhdmVTY29wZShzY29wZSkgewogIGlmIChzY29wZSA9PT0gY3VycmVudFNjb3BlKSB7CiAgICBjdXJyZW50U2NvcGUgPSBzY29wZS5wYXJlbnRfOwogIH0KfQp2YXIgZW50ZXJTY29wZSA9IChpbW1lcjIyKSA9PiBjdXJyZW50U2NvcGUgPSBjcmVhdGVTY29wZShjdXJyZW50U2NvcGUsIGltbWVyMjIpOwpmdW5jdGlvbiByZXZva2VEcmFmdChkcmFmdCkgewogIGNvbnN0IHN0YXRlID0gZHJhZnRbRFJBRlRfU1RBVEVdOwogIGlmIChzdGF0ZS50eXBlXyA9PT0gMCB8fCBzdGF0ZS50eXBlXyA9PT0gMSkKICAgIHN0YXRlLnJldm9rZV8oKTsKICBlbHNlCiAgICBzdGF0ZS5yZXZva2VkXyA9IHRydWU7Cn0KZnVuY3Rpb24gcHJvY2Vzc1Jlc3VsdChyZXN1bHQsIHNjb3BlKSB7CiAgc2NvcGUudW5maW5hbGl6ZWREcmFmdHNfID0gc2NvcGUuZHJhZnRzXy5sZW5ndGg7CiAgY29uc3QgYmFzZURyYWZ0ID0gc2NvcGUuZHJhZnRzX1swXTsKICBjb25zdCBpc1JlcGxhY2VkID0gcmVzdWx0ICE9PSB2b2lkIDAgJiYgcmVzdWx0ICE9PSBiYXNlRHJhZnQ7CiAgaWYgKGlzUmVwbGFjZWQpIHsKICAgIGlmIChiYXNlRHJhZnRbRFJBRlRfU1RBVEVdLm1vZGlmaWVkXykgewogICAgICByZXZva2VTY29wZShzY29wZSk7CiAgICAgIGRpZSg0KTsKICAgIH0KICAgIGlmIChpc0RyYWZ0YWJsZShyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IGZpbmFsaXplKHNjb3BlLCByZXN1bHQpOwogICAgfQogICAgY29uc3QgeyBwYXRjaFBsdWdpbl8gfSA9IHNjb3BlOwogICAgaWYgKHBhdGNoUGx1Z2luXykgewogICAgICBwYXRjaFBsdWdpbl8uZ2VuZXJhdGVSZXBsYWNlbWVudFBhdGNoZXNfKAogICAgICAgIGJhc2VEcmFmdFtEUkFGVF9TVEFURV0uYmFzZV8sCiAgICAgICAgcmVzdWx0LAogICAgICAgIHNjb3BlCiAgICAgICk7CiAgICB9CiAgfSBlbHNlIHsKICAgIHJlc3VsdCA9IGZpbmFsaXplKHNjb3BlLCBiYXNlRHJhZnQpOwogIH0KICBtYXliZUZyZWV6ZShzY29wZSwgcmVzdWx0LCB0cnVlKTsKICByZXZva2VTY29wZShzY29wZSk7CiAgaWYgKHNjb3BlLnBhdGNoZXNfKSB7CiAgICBzY29wZS5wYXRjaExpc3RlbmVyXyhzY29wZS5wYXRjaGVzXywgc2NvcGUuaW52ZXJzZVBhdGNoZXNfKTsKICB9CiAgcmV0dXJuIHJlc3VsdCAhPT0gTk9USElORyA/IHJlc3VsdCA6IHZvaWQgMDsKfQpmdW5jdGlvbiBmaW5hbGl6ZShyb290U2NvcGUsIHZhbHVlKSB7CiAgaWYgKGlzRnJvemVuKHZhbHVlKSkKICAgIHJldHVybiB2YWx1ZTsKICBjb25zdCBzdGF0ZSA9IHZhbHVlW0RSQUZUX1NUQVRFXTsKICBpZiAoIXN0YXRlKSB7CiAgICBjb25zdCBmaW5hbFZhbHVlID0gaGFuZGxlVmFsdWUodmFsdWUsIHJvb3RTY29wZS5oYW5kbGVkU2V0Xywgcm9vdFNjb3BlKTsKICAgIHJldHVybiBmaW5hbFZhbHVlOwogIH0KICBpZiAoIWlzU2FtZVNjb3BlKHN0YXRlLCByb290U2NvcGUpKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGlmICghc3RhdGUubW9kaWZpZWRfKSB7CiAgICByZXR1cm4gc3RhdGUuYmFzZV87CiAgfQogIGlmICghc3RhdGUuZmluYWxpemVkXykgewogICAgY29uc3QgeyBjYWxsYmFja3NfIH0gPSBzdGF0ZTsKICAgIGlmIChjYWxsYmFja3NfKSB7CiAgICAgIHdoaWxlIChjYWxsYmFja3NfLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCBjYWxsYmFjayA9IGNhbGxiYWNrc18ucG9wKCk7CiAgICAgICAgY2FsbGJhY2socm9vdFNjb3BlKTsKICAgICAgfQogICAgfQogICAgZ2VuZXJhdGVQYXRjaGVzQW5kRmluYWxpemUoc3RhdGUsIHJvb3RTY29wZSk7CiAgfQogIHJldHVybiBzdGF0ZS5jb3B5XzsKfQpmdW5jdGlvbiBtYXliZUZyZWV6ZShzY29wZSwgdmFsdWUsIGRlZXAgPSBmYWxzZSkgewogIGlmICghc2NvcGUucGFyZW50XyAmJiBzY29wZS5pbW1lcl8uYXV0b0ZyZWV6ZV8gJiYgc2NvcGUuY2FuQXV0b0ZyZWV6ZV8pIHsKICAgIGZyZWV6ZSh2YWx1ZSwgZGVlcCk7CiAgfQp9CmZ1bmN0aW9uIG1hcmtTdGF0ZUZpbmFsaXplZChzdGF0ZSkgewogIHN0YXRlLmZpbmFsaXplZF8gPSB0cnVlOwogIHN0YXRlLnNjb3BlXy51bmZpbmFsaXplZERyYWZ0c18tLTsKfQp2YXIgaXNTYW1lU2NvcGUgPSAoc3RhdGUsIHJvb3RTY29wZSkgPT4gc3RhdGUuc2NvcGVfID09PSByb290U2NvcGU7CnZhciBFTVBUWV9MT0NBVElPTlNfUkVTVUxUID0gW107CmZ1bmN0aW9uIHVwZGF0ZURyYWZ0SW5QYXJlbnQocGFyZW50LCBkcmFmdFZhbHVlLCBmaW5hbGl6ZWRWYWx1ZSwgb3JpZ2luYWxLZXkpIHsKICBjb25zdCBwYXJlbnRDb3B5ID0gbGF0ZXN0KHBhcmVudCk7CiAgY29uc3QgcGFyZW50VHlwZSA9IHBhcmVudC50eXBlXzsKICBpZiAob3JpZ2luYWxLZXkgIT09IHZvaWQgMCkgewogICAgY29uc3QgY3VycmVudFZhbHVlID0gZ2V0MihwYXJlbnRDb3B5LCBvcmlnaW5hbEtleSwgcGFyZW50VHlwZSk7CiAgICBpZiAoY3VycmVudFZhbHVlID09PSBkcmFmdFZhbHVlKSB7CiAgICAgIHNldChwYXJlbnRDb3B5LCBvcmlnaW5hbEtleSwgZmluYWxpemVkVmFsdWUsIHBhcmVudFR5cGUpOwogICAgICByZXR1cm47CiAgICB9CiAgfQogIGlmICghcGFyZW50LmRyYWZ0TG9jYXRpb25zXykgewogICAgY29uc3QgZHJhZnRMb2NhdGlvbnMgPSBwYXJlbnQuZHJhZnRMb2NhdGlvbnNfID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGVhY2gocGFyZW50Q29weSwgKGtleSwgdmFsdWUpID0+IHsKICAgICAgaWYgKGlzRHJhZnQodmFsdWUpKSB7CiAgICAgICAgY29uc3Qga2V5cyA9IGRyYWZ0TG9jYXRpb25zLmdldCh2YWx1ZSkgfHwgW107CiAgICAgICAga2V5cy5wdXNoKGtleSk7CiAgICAgICAgZHJhZnRMb2NhdGlvbnMuc2V0KHZhbHVlLCBrZXlzKTsKICAgICAgfQogICAgfSk7CiAgfQogIGNvbnN0IGxvY2F0aW9ucyA9IHBhcmVudC5kcmFmdExvY2F0aW9uc18uZ2V0KGRyYWZ0VmFsdWUpID8/IEVNUFRZX0xPQ0FUSU9OU19SRVNVTFQ7CiAgZm9yIChjb25zdCBsb2NhdGlvbiBvZiBsb2NhdGlvbnMpIHsKICAgIHNldChwYXJlbnRDb3B5LCBsb2NhdGlvbiwgZmluYWxpemVkVmFsdWUsIHBhcmVudFR5cGUpOwogIH0KfQpmdW5jdGlvbiByZWdpc3RlckNoaWxkRmluYWxpemF0aW9uQ2FsbGJhY2socGFyZW50LCBjaGlsZCwga2V5KSB7CiAgcGFyZW50LmNhbGxiYWNrc18ucHVzaChmdW5jdGlvbiBjaGlsZENsZWFudXAocm9vdFNjb3BlKSB7CiAgICBjb25zdCBzdGF0ZSA9IGNoaWxkOwogICAgaWYgKCFzdGF0ZSB8fCAhaXNTYW1lU2NvcGUoc3RhdGUsIHJvb3RTY29wZSkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcm9vdFNjb3BlLm1hcFNldFBsdWdpbl8/LmZpeFNldENvbnRlbnRzKHN0YXRlKTsKICAgIGNvbnN0IGZpbmFsaXplZFZhbHVlID0gZ2V0RmluYWxWYWx1ZShzdGF0ZSk7CiAgICB1cGRhdGVEcmFmdEluUGFyZW50KHBhcmVudCwgc3RhdGUuZHJhZnRfID8/IHN0YXRlLCBmaW5hbGl6ZWRWYWx1ZSwga2V5KTsKICAgIGdlbmVyYXRlUGF0Y2hlc0FuZEZpbmFsaXplKHN0YXRlLCByb290U2NvcGUpOwogIH0pOwp9CmZ1bmN0aW9uIGdlbmVyYXRlUGF0Y2hlc0FuZEZpbmFsaXplKHN0YXRlLCByb290U2NvcGUpIHsKICBjb25zdCBzaG91bGRGaW5hbGl6ZSA9IHN0YXRlLm1vZGlmaWVkXyAmJiAhc3RhdGUuZmluYWxpemVkXyAmJiAoc3RhdGUudHlwZV8gPT09IDMgfHwgKHN0YXRlLmFzc2lnbmVkXz8uc2l6ZSA/PyAwKSA+IDApOwogIGlmIChzaG91bGRGaW5hbGl6ZSkgewogICAgY29uc3QgeyBwYXRjaFBsdWdpbl8gfSA9IHJvb3RTY29wZTsKICAgIGlmIChwYXRjaFBsdWdpbl8pIHsKICAgICAgY29uc3QgYmFzZVBhdGggPSBwYXRjaFBsdWdpbl8uZ2V0UGF0aChzdGF0ZSk7CiAgICAgIGlmIChiYXNlUGF0aCkgewogICAgICAgIHBhdGNoUGx1Z2luXy5nZW5lcmF0ZVBhdGNoZXNfKHN0YXRlLCBiYXNlUGF0aCwgcm9vdFNjb3BlKTsKICAgICAgfQogICAgfQogICAgbWFya1N0YXRlRmluYWxpemVkKHN0YXRlKTsKICB9Cn0KZnVuY3Rpb24gaGFuZGxlQ3Jvc3NSZWZlcmVuY2UodGFyZ2V0LCBrZXksIHZhbHVlKSB7CiAgY29uc3QgeyBzY29wZV8gfSA9IHRhcmdldDsKICBpZiAoaXNEcmFmdCh2YWx1ZSkpIHsKICAgIGNvbnN0IHN0YXRlID0gdmFsdWVbRFJBRlRfU1RBVEVdOwogICAgaWYgKGlzU2FtZVNjb3BlKHN0YXRlLCBzY29wZV8pKSB7CiAgICAgIHN0YXRlLmNhbGxiYWNrc18ucHVzaChmdW5jdGlvbiBjcm9zc1JlZmVyZW5jZUNsZWFudXAoKSB7CiAgICAgICAgcHJlcGFyZUNvcHkodGFyZ2V0KTsKICAgICAgICBjb25zdCBmaW5hbGl6ZWRWYWx1ZSA9IGdldEZpbmFsVmFsdWUoc3RhdGUpOwogICAgICAgIHVwZGF0ZURyYWZ0SW5QYXJlbnQodGFyZ2V0LCB2YWx1ZSwgZmluYWxpemVkVmFsdWUsIGtleSk7CiAgICAgIH0pOwogICAgfQogIH0gZWxzZSBpZiAoaXNEcmFmdGFibGUodmFsdWUpKSB7CiAgICB0YXJnZXQuY2FsbGJhY2tzXy5wdXNoKGZ1bmN0aW9uIG5lc3RlZERyYWZ0Q2xlYW51cCgpIHsKICAgICAgY29uc3QgdGFyZ2V0Q29weSA9IGxhdGVzdCh0YXJnZXQpOwogICAgICBpZiAoZ2V0Mih0YXJnZXRDb3B5LCBrZXksIHRhcmdldC50eXBlXykgPT09IHZhbHVlKSB7CiAgICAgICAgaWYgKHNjb3BlXy5kcmFmdHNfLmxlbmd0aCA+IDEgJiYgKHRhcmdldC5hc3NpZ25lZF8uZ2V0KGtleSkgPz8gZmFsc2UpID09PSB0cnVlICYmIHRhcmdldC5jb3B5XykgewogICAgICAgICAgaGFuZGxlVmFsdWUoCiAgICAgICAgICAgIGdldDIodGFyZ2V0LmNvcHlfLCBrZXksIHRhcmdldC50eXBlXyksCiAgICAgICAgICAgIHNjb3BlXy5oYW5kbGVkU2V0XywKICAgICAgICAgICAgc2NvcGVfCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQp9CmZ1bmN0aW9uIGhhbmRsZVZhbHVlKHRhcmdldCwgaGFuZGxlZFNldCwgcm9vdFNjb3BlKSB7CiAgaWYgKCFyb290U2NvcGUuaW1tZXJfLmF1dG9GcmVlemVfICYmIHJvb3RTY29wZS51bmZpbmFsaXplZERyYWZ0c18gPCAxKSB7CiAgICByZXR1cm4gdGFyZ2V0OwogIH0KICBpZiAoaXNEcmFmdCh0YXJnZXQpIHx8IGhhbmRsZWRTZXQuaGFzKHRhcmdldCkgfHwgIWlzRHJhZnRhYmxlKHRhcmdldCkgfHwgaXNGcm96ZW4odGFyZ2V0KSkgewogICAgcmV0dXJuIHRhcmdldDsKICB9CiAgaGFuZGxlZFNldC5hZGQodGFyZ2V0KTsKICBlYWNoKHRhcmdldCwgKGtleSwgdmFsdWUpID0+IHsKICAgIGlmIChpc0RyYWZ0KHZhbHVlKSkgewogICAgICBjb25zdCBzdGF0ZSA9IHZhbHVlW0RSQUZUX1NUQVRFXTsKICAgICAgaWYgKGlzU2FtZVNjb3BlKHN0YXRlLCByb290U2NvcGUpKSB7CiAgICAgICAgY29uc3QgdXBkYXRlZFZhbHVlID0gZ2V0RmluYWxWYWx1ZShzdGF0ZSk7CiAgICAgICAgc2V0KHRhcmdldCwga2V5LCB1cGRhdGVkVmFsdWUsIHRhcmdldC50eXBlXyk7CiAgICAgICAgbWFya1N0YXRlRmluYWxpemVkKHN0YXRlKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc0RyYWZ0YWJsZSh2YWx1ZSkpIHsKICAgICAgaGFuZGxlVmFsdWUodmFsdWUsIGhhbmRsZWRTZXQsIHJvb3RTY29wZSk7CiAgICB9CiAgfSk7CiAgcmV0dXJuIHRhcmdldDsKfQpmdW5jdGlvbiBjcmVhdGVQcm94eVByb3h5KGJhc2UsIHBhcmVudCkgewogIGNvbnN0IGJhc2VJc0FycmF5ID0gaXNBcnJheShiYXNlKTsKICBjb25zdCBzdGF0ZSA9IHsKICAgIHR5cGVfOiBiYXNlSXNBcnJheSA/IDEgOiAwLAogICAgLy8gVHJhY2sgd2hpY2ggcHJvZHVjZSBjYWxsIHRoaXMgaXMgYXNzb2NpYXRlZCB3aXRoLgogICAgc2NvcGVfOiBwYXJlbnQgPyBwYXJlbnQuc2NvcGVfIDogZ2V0Q3VycmVudFNjb3BlKCksCiAgICAvLyBUcnVlIGZvciBib3RoIHNoYWxsb3cgYW5kIGRlZXAgY2hhbmdlcy4KICAgIG1vZGlmaWVkXzogZmFsc2UsCiAgICAvLyBVc2VkIGR1cmluZyBmaW5hbGl6YXRpb24uCiAgICBmaW5hbGl6ZWRfOiBmYWxzZSwKICAgIC8vIFRyYWNrIHdoaWNoIHByb3BlcnRpZXMgaGF2ZSBiZWVuIGFzc2lnbmVkICh0cnVlKSBvciBkZWxldGVkIChmYWxzZSkuCiAgICAvLyBhY3R1YWxseSBpbnN0YW50aWF0ZWQgaW4gYHByZXBhcmVDb3B5KClgCiAgICBhc3NpZ25lZF86IHZvaWQgMCwKICAgIC8vIFRoZSBwYXJlbnQgZHJhZnQgc3RhdGUuCiAgICBwYXJlbnRfOiBwYXJlbnQsCiAgICAvLyBUaGUgYmFzZSBzdGF0ZS4KICAgIGJhc2VfOiBiYXNlLAogICAgLy8gVGhlIGJhc2UgcHJveHkuCiAgICBkcmFmdF86IG51bGwsCiAgICAvLyBzZXQgYmVsb3cKICAgIC8vIFRoZSBiYXNlIGNvcHkgd2l0aCBhbnkgdXBkYXRlZCB2YWx1ZXMuCiAgICBjb3B5XzogbnVsbCwKICAgIC8vIENhbGxlZCBieSB0aGUgYHByb2R1Y2VgIGZ1bmN0aW9uLgogICAgcmV2b2tlXzogbnVsbCwKICAgIGlzTWFudWFsXzogZmFsc2UsCiAgICAvLyBgY2FsbGJhY2tzYCBhY3R1YWxseSBnZXRzIGFzc2lnbmVkIGluIGBjcmVhdGVQcm94eWAKICAgIGNhbGxiYWNrc186IHZvaWQgMAogIH07CiAgbGV0IHRhcmdldCA9IHN0YXRlOwogIGxldCB0cmFwcyA9IG9iamVjdFRyYXBzOwogIGlmIChiYXNlSXNBcnJheSkgewogICAgdGFyZ2V0ID0gW3N0YXRlXTsKICAgIHRyYXBzID0gYXJyYXlUcmFwczsKICB9CiAgY29uc3QgeyByZXZva2UsIHByb3h5IH0gPSBQcm94eS5yZXZvY2FibGUodGFyZ2V0LCB0cmFwcyk7CiAgc3RhdGUuZHJhZnRfID0gcHJveHk7CiAgc3RhdGUucmV2b2tlXyA9IHJldm9rZTsKICByZXR1cm4gW3Byb3h5LCBzdGF0ZV07Cn0KdmFyIG9iamVjdFRyYXBzID0gewogIGdldChzdGF0ZSwgcHJvcCkgewogICAgaWYgKHByb3AgPT09IERSQUZUX1NUQVRFKQogICAgICByZXR1cm4gc3RhdGU7CiAgICBjb25zdCBzb3VyY2UgPSBsYXRlc3Qoc3RhdGUpOwogICAgaWYgKCFoYXMoc291cmNlLCBwcm9wLCBzdGF0ZS50eXBlXykpIHsKICAgICAgcmV0dXJuIHJlYWRQcm9wRnJvbVByb3RvKHN0YXRlLCBzb3VyY2UsIHByb3ApOwogICAgfQogICAgY29uc3QgdmFsdWUgPSBzb3VyY2VbcHJvcF07CiAgICBpZiAoc3RhdGUuZmluYWxpemVkXyB8fCAhaXNEcmFmdGFibGUodmFsdWUpKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIGlmICh2YWx1ZSA9PT0gcGVlayhzdGF0ZS5iYXNlXywgcHJvcCkpIHsKICAgICAgcHJlcGFyZUNvcHkoc3RhdGUpOwogICAgICBjb25zdCBjaGlsZEtleSA9IHN0YXRlLnR5cGVfID09PSAxID8gK3Byb3AgOiBwcm9wOwogICAgICBjb25zdCBjaGlsZERyYWZ0ID0gY3JlYXRlUHJveHkoc3RhdGUuc2NvcGVfLCB2YWx1ZSwgc3RhdGUsIGNoaWxkS2V5KTsKICAgICAgcmV0dXJuIHN0YXRlLmNvcHlfW2NoaWxkS2V5XSA9IGNoaWxkRHJhZnQ7CiAgICB9CiAgICByZXR1cm4gdmFsdWU7CiAgfSwKICBoYXMoc3RhdGUsIHByb3ApIHsKICAgIHJldHVybiBwcm9wIGluIGxhdGVzdChzdGF0ZSk7CiAgfSwKICBvd25LZXlzKHN0YXRlKSB7CiAgICByZXR1cm4gUmVmbGVjdC5vd25LZXlzKGxhdGVzdChzdGF0ZSkpOwogIH0sCiAgc2V0KHN0YXRlLCBwcm9wLCB2YWx1ZSkgewogICAgY29uc3QgZGVzYyA9IGdldERlc2NyaXB0b3JGcm9tUHJvdG8obGF0ZXN0KHN0YXRlKSwgcHJvcCk7CiAgICBpZiAoZGVzYz8uc2V0KSB7CiAgICAgIGRlc2Muc2V0LmNhbGwoc3RhdGUuZHJhZnRfLCB2YWx1ZSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pIHsKICAgICAgY29uc3QgY3VycmVudDIyID0gcGVlayhsYXRlc3Qoc3RhdGUpLCBwcm9wKTsKICAgICAgY29uc3QgY3VycmVudFN0YXRlID0gY3VycmVudDIyPy5bRFJBRlRfU1RBVEVdOwogICAgICBpZiAoY3VycmVudFN0YXRlICYmIGN1cnJlbnRTdGF0ZS5iYXNlXyA9PT0gdmFsdWUpIHsKICAgICAgICBzdGF0ZS5jb3B5X1twcm9wXSA9IHZhbHVlOwogICAgICAgIHN0YXRlLmFzc2lnbmVkXy5zZXQocHJvcCwgZmFsc2UpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmIChpcyh2YWx1ZSwgY3VycmVudDIyKSAmJiAodmFsdWUgIT09IHZvaWQgMCB8fCBoYXMoc3RhdGUuYmFzZV8sIHByb3AsIHN0YXRlLnR5cGVfKSkpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIHByZXBhcmVDb3B5KHN0YXRlKTsKICAgICAgbWFya0NoYW5nZWQoc3RhdGUpOwogICAgfQogICAgaWYgKHN0YXRlLmNvcHlfW3Byb3BdID09PSB2YWx1ZSAmJiAvLyBzcGVjaWFsIGNhc2U6IGhhbmRsZSBuZXcgcHJvcHMgd2l0aCB2YWx1ZSAndW5kZWZpbmVkJwogICAgKHZhbHVlICE9PSB2b2lkIDAgfHwgcHJvcCBpbiBzdGF0ZS5jb3B5XykgfHwgLy8gc3BlY2lhbCBjYXNlOiBOYU4KICAgIE51bWJlci5pc05hTih2YWx1ZSkgJiYgTnVtYmVyLmlzTmFOKHN0YXRlLmNvcHlfW3Byb3BdKSkKICAgICAgcmV0dXJuIHRydWU7CiAgICBzdGF0ZS5jb3B5X1twcm9wXSA9IHZhbHVlOwogICAgc3RhdGUuYXNzaWduZWRfLnNldChwcm9wLCB0cnVlKTsKICAgIGhhbmRsZUNyb3NzUmVmZXJlbmNlKHN0YXRlLCBwcm9wLCB2YWx1ZSk7CiAgICByZXR1cm4gdHJ1ZTsKICB9LAogIGRlbGV0ZVByb3BlcnR5KHN0YXRlLCBwcm9wKSB7CiAgICBwcmVwYXJlQ29weShzdGF0ZSk7CiAgICBpZiAocGVlayhzdGF0ZS5iYXNlXywgcHJvcCkgIT09IHZvaWQgMCB8fCBwcm9wIGluIHN0YXRlLmJhc2VfKSB7CiAgICAgIHN0YXRlLmFzc2lnbmVkXy5zZXQocHJvcCwgZmFsc2UpOwogICAgICBtYXJrQ2hhbmdlZChzdGF0ZSk7CiAgICB9IGVsc2UgewogICAgICBzdGF0ZS5hc3NpZ25lZF8uZGVsZXRlKHByb3ApOwogICAgfQogICAgaWYgKHN0YXRlLmNvcHlfKSB7CiAgICAgIGRlbGV0ZSBzdGF0ZS5jb3B5X1twcm9wXTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0sCiAgLy8gTm90ZTogV2UgbmV2ZXIgY29lcmNlIGBkZXNjLnZhbHVlYCBpbnRvIGFuIEltbWVyIGRyYWZ0LCBiZWNhdXNlIHdlIGNhbid0IG1ha2UKICAvLyB0aGUgc2FtZSBndWFyYW50ZWUgaW4gRVM1IG1vZGUuCiAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHN0YXRlLCBwcm9wKSB7CiAgICBjb25zdCBvd25lciA9IGxhdGVzdChzdGF0ZSk7CiAgICBjb25zdCBkZXNjID0gUmVmbGVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob3duZXIsIHByb3ApOwogICAgaWYgKCFkZXNjKQogICAgICByZXR1cm4gZGVzYzsKICAgIHJldHVybiB7CiAgICAgIFtXUklUQUJMRV06IHRydWUsCiAgICAgIFtDT05GSUdVUkFCTEVdOiBzdGF0ZS50eXBlXyAhPT0gMSB8fCBwcm9wICE9PSAibGVuZ3RoIiwKICAgICAgW0VOVU1FUkFCTEVdOiBkZXNjW0VOVU1FUkFCTEVdLAogICAgICBbVkFMVUVdOiBvd25lcltwcm9wXQogICAgfTsKICB9LAogIGRlZmluZVByb3BlcnR5KCkgewogICAgZGllKDExKTsKICB9LAogIGdldFByb3RvdHlwZU9mKHN0YXRlKSB7CiAgICByZXR1cm4gZ2V0UHJvdG90eXBlT2Yoc3RhdGUuYmFzZV8pOwogIH0sCiAgc2V0UHJvdG90eXBlT2YoKSB7CiAgICBkaWUoMTIpOwogIH0KfTsKdmFyIGFycmF5VHJhcHMgPSB7fTsKZWFjaChvYmplY3RUcmFwcywgKGtleSwgZm4pID0+IHsKICBhcnJheVRyYXBzW2tleV0gPSBmdW5jdGlvbigpIHsKICAgIGNvbnN0IGFyZ3MgPSBhcmd1bWVudHM7CiAgICBhcmdzWzBdID0gYXJnc1swXVswXTsKICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmdzKTsKICB9Owp9KTsKYXJyYXlUcmFwcy5kZWxldGVQcm9wZXJ0eSA9IGZ1bmN0aW9uKHN0YXRlLCBwcm9wKSB7CiAgaWYgKGlzTmFOKHBhcnNlSW50KHByb3ApKSkKICAgIGRpZSgxMyk7CiAgcmV0dXJuIGFycmF5VHJhcHMuc2V0LmNhbGwodGhpcywgc3RhdGUsIHByb3AsIHZvaWQgMCk7Cn07CmFycmF5VHJhcHMuc2V0ID0gZnVuY3Rpb24oc3RhdGUsIHByb3AsIHZhbHVlKSB7CiAgaWYgKHByb3AgIT09ICJsZW5ndGgiICYmIGlzTmFOKHBhcnNlSW50KHByb3ApKSkKICAgIGRpZSgxNCk7CiAgcmV0dXJuIG9iamVjdFRyYXBzLnNldC5jYWxsKHRoaXMsIHN0YXRlWzBdLCBwcm9wLCB2YWx1ZSwgc3RhdGVbMF0pOwp9OwpmdW5jdGlvbiBwZWVrKGRyYWZ0LCBwcm9wKSB7CiAgY29uc3Qgc3RhdGUgPSBkcmFmdFtEUkFGVF9TVEFURV07CiAgY29uc3Qgc291cmNlID0gc3RhdGUgPyBsYXRlc3Qoc3RhdGUpIDogZHJhZnQ7CiAgcmV0dXJuIHNvdXJjZVtwcm9wXTsKfQpmdW5jdGlvbiByZWFkUHJvcEZyb21Qcm90byhzdGF0ZSwgc291cmNlLCBwcm9wKSB7CiAgY29uc3QgZGVzYyA9IGdldERlc2NyaXB0b3JGcm9tUHJvdG8oc291cmNlLCBwcm9wKTsKICByZXR1cm4gZGVzYyA/IFZBTFVFIGluIGRlc2MgPyBkZXNjW1ZBTFVFXSA6ICgKICAgIC8vIFRoaXMgaXMgYSB2ZXJ5IHNwZWNpYWwgY2FzZSwgaWYgdGhlIHByb3AgaXMgYSBnZXR0ZXIgZGVmaW5lZCBieSB0aGUKICAgIC8vIHByb3RvdHlwZSwgd2Ugc2hvdWxkIGludm9rZSBpdCB3aXRoIHRoZSBkcmFmdCBhcyBjb250ZXh0IQogICAgZGVzYy5nZXQ/LmNhbGwoc3RhdGUuZHJhZnRfKQogICkgOiB2b2lkIDA7Cn0KZnVuY3Rpb24gZ2V0RGVzY3JpcHRvckZyb21Qcm90byhzb3VyY2UsIHByb3ApIHsKICBpZiAoIShwcm9wIGluIHNvdXJjZSkpCiAgICByZXR1cm4gdm9pZCAwOwogIGxldCBwcm90bzIgPSBnZXRQcm90b3R5cGVPZihzb3VyY2UpOwogIHdoaWxlIChwcm90bzIpIHsKICAgIGNvbnN0IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHByb3RvMiwgcHJvcCk7CiAgICBpZiAoZGVzYykKICAgICAgcmV0dXJuIGRlc2M7CiAgICBwcm90bzIgPSBnZXRQcm90b3R5cGVPZihwcm90bzIpOwogIH0KICByZXR1cm4gdm9pZCAwOwp9CmZ1bmN0aW9uIG1hcmtDaGFuZ2VkKHN0YXRlKSB7CiAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pIHsKICAgIHN0YXRlLm1vZGlmaWVkXyA9IHRydWU7CiAgICBpZiAoc3RhdGUucGFyZW50XykgewogICAgICBtYXJrQ2hhbmdlZChzdGF0ZS5wYXJlbnRfKTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gcHJlcGFyZUNvcHkoc3RhdGUpIHsKICBpZiAoIXN0YXRlLmNvcHlfKSB7CiAgICBzdGF0ZS5hc3NpZ25lZF8gPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgc3RhdGUuY29weV8gPSBzaGFsbG93Q29weSgKICAgICAgc3RhdGUuYmFzZV8sCiAgICAgIHN0YXRlLnNjb3BlXy5pbW1lcl8udXNlU3RyaWN0U2hhbGxvd0NvcHlfCiAgICApOwogIH0KfQp2YXIgSW1tZXIyID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGNvbmZpZykgewogICAgdGhpcy5hdXRvRnJlZXplXyA9IHRydWU7CiAgICB0aGlzLnVzZVN0cmljdFNoYWxsb3dDb3B5XyA9IGZhbHNlOwogICAgdGhpcy51c2VTdHJpY3RJdGVyYXRpb25fID0gZmFsc2U7CiAgICB0aGlzLnByb2R1Y2UgPSAoYmFzZSwgcmVjaXBlLCBwYXRjaExpc3RlbmVyKSA9PiB7CiAgICAgIGlmIChpc0Z1bmN0aW9uKGJhc2UpICYmICFpc0Z1bmN0aW9uKHJlY2lwZSkpIHsKICAgICAgICBjb25zdCBkZWZhdWx0QmFzZSA9IHJlY2lwZTsKICAgICAgICByZWNpcGUgPSBiYXNlOwogICAgICAgIGNvbnN0IHNlbGYyID0gdGhpczsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gY3VycmllZFByb2R1Y2UoYmFzZTIgPSBkZWZhdWx0QmFzZSwgLi4uYXJncykgewogICAgICAgICAgcmV0dXJuIHNlbGYyLnByb2R1Y2UoYmFzZTIsIChkcmFmdCkgPT4gcmVjaXBlLmNhbGwodGhpcywgZHJhZnQsIC4uLmFyZ3MpKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIGlmICghaXNGdW5jdGlvbihyZWNpcGUpKQogICAgICAgIGRpZSg2KTsKICAgICAgaWYgKHBhdGNoTGlzdGVuZXIgIT09IHZvaWQgMCAmJiAhaXNGdW5jdGlvbihwYXRjaExpc3RlbmVyKSkKICAgICAgICBkaWUoNyk7CiAgICAgIGxldCByZXN1bHQ7CiAgICAgIGlmIChpc0RyYWZ0YWJsZShiYXNlKSkgewogICAgICAgIGNvbnN0IHNjb3BlID0gZW50ZXJTY29wZSh0aGlzKTsKICAgICAgICBjb25zdCBwcm94eSA9IGNyZWF0ZVByb3h5KHNjb3BlLCBiYXNlLCB2b2lkIDApOwogICAgICAgIGxldCBoYXNFcnJvciA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJlc3VsdCA9IHJlY2lwZShwcm94eSk7CiAgICAgICAgICBoYXNFcnJvciA9IGZhbHNlOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAoaGFzRXJyb3IpCiAgICAgICAgICAgIHJldm9rZVNjb3BlKHNjb3BlKTsKICAgICAgICAgIGVsc2UKICAgICAgICAgICAgbGVhdmVTY29wZShzY29wZSk7CiAgICAgICAgfQogICAgICAgIHVzZVBhdGNoZXNJblNjb3BlKHNjb3BlLCBwYXRjaExpc3RlbmVyKTsKICAgICAgICByZXR1cm4gcHJvY2Vzc1Jlc3VsdChyZXN1bHQsIHNjb3BlKTsKICAgICAgfSBlbHNlIGlmICghYmFzZSB8fCAhaXNPYmplY3Rpc2goYmFzZSkpIHsKICAgICAgICByZXN1bHQgPSByZWNpcGUoYmFzZSk7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKQogICAgICAgICAgcmVzdWx0ID0gYmFzZTsKICAgICAgICBpZiAocmVzdWx0ID09PSBOT1RISU5HKQogICAgICAgICAgcmVzdWx0ID0gdm9pZCAwOwogICAgICAgIGlmICh0aGlzLmF1dG9GcmVlemVfKQogICAgICAgICAgZnJlZXplKHJlc3VsdCwgdHJ1ZSk7CiAgICAgICAgaWYgKHBhdGNoTGlzdGVuZXIpIHsKICAgICAgICAgIGNvbnN0IHAgPSBbXTsKICAgICAgICAgIGNvbnN0IGlwID0gW107CiAgICAgICAgICBnZXRQbHVnaW4oUGx1Z2luUGF0Y2hlcykuZ2VuZXJhdGVSZXBsYWNlbWVudFBhdGNoZXNfKGJhc2UsIHJlc3VsdCwgewogICAgICAgICAgICBwYXRjaGVzXzogcCwKICAgICAgICAgICAgaW52ZXJzZVBhdGNoZXNfOiBpcAogICAgICAgICAgfSk7CiAgICAgICAgICBwYXRjaExpc3RlbmVyKHAsIGlwKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfSBlbHNlCiAgICAgICAgZGllKDEsIGJhc2UpOwogICAgfTsKICAgIHRoaXMucHJvZHVjZVdpdGhQYXRjaGVzID0gKGJhc2UsIHJlY2lwZSkgPT4gewogICAgICBpZiAoaXNGdW5jdGlvbihiYXNlKSkgewogICAgICAgIHJldHVybiAoc3RhdGUsIC4uLmFyZ3MpID0+IHRoaXMucHJvZHVjZVdpdGhQYXRjaGVzKHN0YXRlLCAoZHJhZnQpID0+IGJhc2UoZHJhZnQsIC4uLmFyZ3MpKTsKICAgICAgfQogICAgICBsZXQgcGF0Y2hlcywgaW52ZXJzZVBhdGNoZXM7CiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMucHJvZHVjZShiYXNlLCByZWNpcGUsIChwLCBpcCkgPT4gewogICAgICAgIHBhdGNoZXMgPSBwOwogICAgICAgIGludmVyc2VQYXRjaGVzID0gaXA7CiAgICAgIH0pOwogICAgICByZXR1cm4gW3Jlc3VsdCwgcGF0Y2hlcywgaW52ZXJzZVBhdGNoZXNdOwogICAgfTsKICAgIGlmIChpc0Jvb2xlYW4oY29uZmlnPy5hdXRvRnJlZXplKSkKICAgICAgdGhpcy5zZXRBdXRvRnJlZXplKGNvbmZpZy5hdXRvRnJlZXplKTsKICAgIGlmIChpc0Jvb2xlYW4oY29uZmlnPy51c2VTdHJpY3RTaGFsbG93Q29weSkpCiAgICAgIHRoaXMuc2V0VXNlU3RyaWN0U2hhbGxvd0NvcHkoY29uZmlnLnVzZVN0cmljdFNoYWxsb3dDb3B5KTsKICAgIGlmIChpc0Jvb2xlYW4oY29uZmlnPy51c2VTdHJpY3RJdGVyYXRpb24pKQogICAgICB0aGlzLnNldFVzZVN0cmljdEl0ZXJhdGlvbihjb25maWcudXNlU3RyaWN0SXRlcmF0aW9uKTsKICB9CiAgY3JlYXRlRHJhZnQoYmFzZSkgewogICAgaWYgKCFpc0RyYWZ0YWJsZShiYXNlKSkKICAgICAgZGllKDgpOwogICAgaWYgKGlzRHJhZnQoYmFzZSkpCiAgICAgIGJhc2UgPSBjdXJyZW50KGJhc2UpOwogICAgY29uc3Qgc2NvcGUgPSBlbnRlclNjb3BlKHRoaXMpOwogICAgY29uc3QgcHJveHkgPSBjcmVhdGVQcm94eShzY29wZSwgYmFzZSwgdm9pZCAwKTsKICAgIHByb3h5W0RSQUZUX1NUQVRFXS5pc01hbnVhbF8gPSB0cnVlOwogICAgbGVhdmVTY29wZShzY29wZSk7CiAgICByZXR1cm4gcHJveHk7CiAgfQogIGZpbmlzaERyYWZ0KGRyYWZ0LCBwYXRjaExpc3RlbmVyKSB7CiAgICBjb25zdCBzdGF0ZSA9IGRyYWZ0ICYmIGRyYWZ0W0RSQUZUX1NUQVRFXTsKICAgIGlmICghc3RhdGUgfHwgIXN0YXRlLmlzTWFudWFsXykKICAgICAgZGllKDkpOwogICAgY29uc3QgeyBzY29wZV86IHNjb3BlIH0gPSBzdGF0ZTsKICAgIHVzZVBhdGNoZXNJblNjb3BlKHNjb3BlLCBwYXRjaExpc3RlbmVyKTsKICAgIHJldHVybiBwcm9jZXNzUmVzdWx0KHZvaWQgMCwgc2NvcGUpOwogIH0KICAvKioKICAgKiBQYXNzIHRydWUgdG8gYXV0b21hdGljYWxseSBmcmVlemUgYWxsIGNvcGllcyBjcmVhdGVkIGJ5IEltbWVyLgogICAqCiAgICogQnkgZGVmYXVsdCwgYXV0by1mcmVlemluZyBpcyBlbmFibGVkLgogICAqLwogIHNldEF1dG9GcmVlemUodmFsdWUpIHsKICAgIHRoaXMuYXV0b0ZyZWV6ZV8gPSB2YWx1ZTsKICB9CiAgLyoqCiAgICogUGFzcyB0cnVlIHRvIGVuYWJsZSBzdHJpY3Qgc2hhbGxvdyBjb3B5LgogICAqCiAgICogQnkgZGVmYXVsdCwgaW1tZXIgZG9lcyBub3QgY29weSB0aGUgb2JqZWN0IGRlc2NyaXB0b3JzIHN1Y2ggYXMgZ2V0dGVyLCBzZXR0ZXIgYW5kIG5vbi1lbnVtcmFibGUgcHJvcGVydGllcy4KICAgKi8KICBzZXRVc2VTdHJpY3RTaGFsbG93Q29weSh2YWx1ZSkgewogICAgdGhpcy51c2VTdHJpY3RTaGFsbG93Q29weV8gPSB2YWx1ZTsKICB9CiAgLyoqCiAgICogUGFzcyBmYWxzZSB0byB1c2UgZmFzdGVyIGl0ZXJhdGlvbiB0aGF0IHNraXBzIG5vbi1lbnVtZXJhYmxlIHByb3BlcnRpZXMKICAgKiBidXQgc3RpbGwgaGFuZGxlcyBzeW1ib2xzIGZvciBjb21wYXRpYmlsaXR5LgogICAqCiAgICogQnkgZGVmYXVsdCwgc3RyaWN0IGl0ZXJhdGlvbiBpcyBlbmFibGVkIChpbmNsdWRlcyBhbGwgb3duIHByb3BlcnRpZXMpLgogICAqLwogIHNldFVzZVN0cmljdEl0ZXJhdGlvbih2YWx1ZSkgewogICAgdGhpcy51c2VTdHJpY3RJdGVyYXRpb25fID0gdmFsdWU7CiAgfQogIHNob3VsZFVzZVN0cmljdEl0ZXJhdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnVzZVN0cmljdEl0ZXJhdGlvbl87CiAgfQogIGFwcGx5UGF0Y2hlcyhiYXNlLCBwYXRjaGVzKSB7CiAgICBsZXQgaTsKICAgIGZvciAoaSA9IHBhdGNoZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgcGF0Y2ggPSBwYXRjaGVzW2ldOwogICAgICBpZiAocGF0Y2gucGF0aC5sZW5ndGggPT09IDAgJiYgcGF0Y2gub3AgPT09ICJyZXBsYWNlIikgewogICAgICAgIGJhc2UgPSBwYXRjaC52YWx1ZTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgaWYgKGkgPiAtMSkgewogICAgICBwYXRjaGVzID0gcGF0Y2hlcy5zbGljZShpICsgMSk7CiAgICB9CiAgICBjb25zdCBhcHBseVBhdGNoZXNJbXBsID0gZ2V0UGx1Z2luKFBsdWdpblBhdGNoZXMpLmFwcGx5UGF0Y2hlc187CiAgICBpZiAoaXNEcmFmdChiYXNlKSkgewogICAgICByZXR1cm4gYXBwbHlQYXRjaGVzSW1wbChiYXNlLCBwYXRjaGVzKTsKICAgIH0KICAgIHJldHVybiB0aGlzLnByb2R1Y2UoCiAgICAgIGJhc2UsCiAgICAgIChkcmFmdCkgPT4gYXBwbHlQYXRjaGVzSW1wbChkcmFmdCwgcGF0Y2hlcykKICAgICk7CiAgfQp9OwpmdW5jdGlvbiBjcmVhdGVQcm94eShyb290U2NvcGUsIHZhbHVlLCBwYXJlbnQsIGtleSkgewogIGNvbnN0IFtkcmFmdCwgc3RhdGVdID0gaXNNYXAodmFsdWUpID8gZ2V0UGx1Z2luKFBsdWdpbk1hcFNldCkucHJveHlNYXBfKHZhbHVlLCBwYXJlbnQpIDogaXNTZXQodmFsdWUpID8gZ2V0UGx1Z2luKFBsdWdpbk1hcFNldCkucHJveHlTZXRfKHZhbHVlLCBwYXJlbnQpIDogY3JlYXRlUHJveHlQcm94eSh2YWx1ZSwgcGFyZW50KTsKICBjb25zdCBzY29wZSA9IHBhcmVudD8uc2NvcGVfID8/IGdldEN1cnJlbnRTY29wZSgpOwogIHNjb3BlLmRyYWZ0c18ucHVzaChkcmFmdCk7CiAgc3RhdGUuY2FsbGJhY2tzXyA9IHBhcmVudD8uY2FsbGJhY2tzXyA/PyBbXTsKICBzdGF0ZS5rZXlfID0ga2V5OwogIGlmIChwYXJlbnQgJiYga2V5ICE9PSB2b2lkIDApIHsKICAgIHJlZ2lzdGVyQ2hpbGRGaW5hbGl6YXRpb25DYWxsYmFjayhwYXJlbnQsIHN0YXRlLCBrZXkpOwogIH0gZWxzZSB7CiAgICBzdGF0ZS5jYWxsYmFja3NfLnB1c2goZnVuY3Rpb24gcm9vdERyYWZ0Q2xlYW51cChyb290U2NvcGUyKSB7CiAgICAgIHJvb3RTY29wZTIubWFwU2V0UGx1Z2luXz8uZml4U2V0Q29udGVudHMoc3RhdGUpOwogICAgICBjb25zdCB7IHBhdGNoUGx1Z2luXyB9ID0gcm9vdFNjb3BlMjsKICAgICAgaWYgKHN0YXRlLm1vZGlmaWVkXyAmJiBwYXRjaFBsdWdpbl8pIHsKICAgICAgICBwYXRjaFBsdWdpbl8uZ2VuZXJhdGVQYXRjaGVzXyhzdGF0ZSwgW10sIHJvb3RTY29wZTIpOwogICAgICB9CiAgICB9KTsKICB9CiAgcmV0dXJuIGRyYWZ0Owp9CmZ1bmN0aW9uIGN1cnJlbnQodmFsdWUpIHsKICBpZiAoIWlzRHJhZnQodmFsdWUpKQogICAgZGllKDEwLCB2YWx1ZSk7CiAgcmV0dXJuIGN1cnJlbnRJbXBsKHZhbHVlKTsKfQpmdW5jdGlvbiBjdXJyZW50SW1wbCh2YWx1ZSkgewogIGlmICghaXNEcmFmdGFibGUodmFsdWUpIHx8IGlzRnJvemVuKHZhbHVlKSkKICAgIHJldHVybiB2YWx1ZTsKICBjb25zdCBzdGF0ZSA9IHZhbHVlW0RSQUZUX1NUQVRFXTsKICBsZXQgY29weTM7CiAgbGV0IHN0cmljdCA9IHRydWU7CiAgaWYgKHN0YXRlKSB7CiAgICBpZiAoIXN0YXRlLm1vZGlmaWVkXykKICAgICAgcmV0dXJuIHN0YXRlLmJhc2VfOwogICAgc3RhdGUuZmluYWxpemVkXyA9IHRydWU7CiAgICBjb3B5MyA9IHNoYWxsb3dDb3B5KHZhbHVlLCBzdGF0ZS5zY29wZV8uaW1tZXJfLnVzZVN0cmljdFNoYWxsb3dDb3B5Xyk7CiAgICBzdHJpY3QgPSBzdGF0ZS5zY29wZV8uaW1tZXJfLnNob3VsZFVzZVN0cmljdEl0ZXJhdGlvbigpOwogIH0gZWxzZSB7CiAgICBjb3B5MyA9IHNoYWxsb3dDb3B5KHZhbHVlLCB0cnVlKTsKICB9CiAgZWFjaCgKICAgIGNvcHkzLAogICAgKGtleSwgY2hpbGRWYWx1ZSkgPT4gewogICAgICBzZXQoY29weTMsIGtleSwgY3VycmVudEltcGwoY2hpbGRWYWx1ZSkpOwogICAgfSwKICAgIHN0cmljdAogICk7CiAgaWYgKHN0YXRlKSB7CiAgICBzdGF0ZS5maW5hbGl6ZWRfID0gZmFsc2U7CiAgfQogIHJldHVybiBjb3B5MzsKfQp2YXIgaW1tZXIgPSBuZXcgSW1tZXIyKCk7CnZhciBwcm9kdWNlID0gaW1tZXIucHJvZHVjZTsKCi8vIG5vZGVfbW9kdWxlcy9yZWR1eC10aHVuay9kaXN0L3JlZHV4LXRodW5rLm1qcwpmdW5jdGlvbiBjcmVhdGVUaHVua01pZGRsZXdhcmUoZXh0cmFBcmd1bWVudCkgewogIGNvbnN0IG1pZGRsZXdhcmUgPSAoeyBkaXNwYXRjaCwgZ2V0U3RhdGUgfSkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IHsKICAgIGlmICh0eXBlb2YgYWN0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJldHVybiBhY3Rpb24oZGlzcGF0Y2gsIGdldFN0YXRlLCBleHRyYUFyZ3VtZW50KTsKICAgIH0KICAgIHJldHVybiBuZXh0KGFjdGlvbik7CiAgfTsKICByZXR1cm4gbWlkZGxld2FyZTsKfQp2YXIgdGh1bmsgPSBjcmVhdGVUaHVua01pZGRsZXdhcmUoKTsKdmFyIHdpdGhFeHRyYUFyZ3VtZW50ID0gY3JlYXRlVGh1bmtNaWRkbGV3YXJlOwoKLy8gbm9kZV9tb2R1bGVzL0ByZWR1eGpzL3Rvb2xraXQvZGlzdC9yZWR1eC10b29sa2l0Lm1vZGVybi5tanMKdmFyIGNvbXBvc2VXaXRoRGV2VG9vbHMgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuX19SRURVWF9ERVZUT09MU19FWFRFTlNJT05fQ09NUE9TRV9fID8gd2luZG93Ll9fUkVEVVhfREVWVE9PTFNfRVhURU5TSU9OX0NPTVBPU0VfXyA6IGZ1bmN0aW9uKCkgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSByZXR1cm4gdm9pZCAwOwogIGlmICh0eXBlb2YgYXJndW1lbnRzWzBdID09PSAib2JqZWN0IikgcmV0dXJuIGNvbXBvc2U7CiAgcmV0dXJuIGNvbXBvc2UuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfTsKdmFyIGRldlRvb2xzRW5oYW5jZXIgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuX19SRURVWF9ERVZUT09MU19FWFRFTlNJT05fXyA/IHdpbmRvdy5fX1JFRFVYX0RFVlRPT0xTX0VYVEVOU0lPTl9fIDogZnVuY3Rpb24oKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKG5vb3AzMikgewogICAgcmV0dXJuIG5vb3AzMjsKICB9Owp9Owp2YXIgaGFzTWF0Y2hGdW5jdGlvbiA9ICh2KSA9PiB7CiAgcmV0dXJuIHYgJiYgdHlwZW9mIHYubWF0Y2ggPT09ICJmdW5jdGlvbiI7Cn07CmZ1bmN0aW9uIGNyZWF0ZUFjdGlvbih0eXBlLCBwcmVwYXJlQWN0aW9uKSB7CiAgZnVuY3Rpb24gYWN0aW9uQ3JlYXRvciguLi5hcmdzKSB7CiAgICBpZiAocHJlcGFyZUFjdGlvbikgewogICAgICBsZXQgcHJlcGFyZWQgPSBwcmVwYXJlQWN0aW9uKC4uLmFyZ3MpOwogICAgICBpZiAoIXByZXBhcmVkKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgwKSA6ICJwcmVwYXJlQWN0aW9uIGRpZCBub3QgcmV0dXJuIGFuIG9iamVjdCIpOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgdHlwZSwKICAgICAgICBwYXlsb2FkOiBwcmVwYXJlZC5wYXlsb2FkLAogICAgICAgIC4uLiJtZXRhIiBpbiBwcmVwYXJlZCAmJiB7CiAgICAgICAgICBtZXRhOiBwcmVwYXJlZC5tZXRhCiAgICAgICAgfSwKICAgICAgICAuLi4iZXJyb3IiIGluIHByZXBhcmVkICYmIHsKICAgICAgICAgIGVycm9yOiBwcmVwYXJlZC5lcnJvcgogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHR5cGUsCiAgICAgIHBheWxvYWQ6IGFyZ3NbMF0KICAgIH07CiAgfQogIGFjdGlvbkNyZWF0b3IudG9TdHJpbmcgPSAoKSA9PiBgJHt0eXBlfWA7CiAgYWN0aW9uQ3JlYXRvci50eXBlID0gdHlwZTsKICBhY3Rpb25DcmVhdG9yLm1hdGNoID0gKGFjdGlvbikgPT4gaXNBY3Rpb24oYWN0aW9uKSAmJiBhY3Rpb24udHlwZSA9PT0gdHlwZTsKICByZXR1cm4gYWN0aW9uQ3JlYXRvcjsKfQpmdW5jdGlvbiBpc0FjdGlvbkNyZWF0b3IoYWN0aW9uKSB7CiAgcmV0dXJuIHR5cGVvZiBhY3Rpb24gPT09ICJmdW5jdGlvbiIgJiYgInR5cGUiIGluIGFjdGlvbiAmJiAvLyBoYXNNYXRjaEZ1bmN0aW9uIG9ubHkgd2FudHMgTWF0Y2hlcnMgYnV0IEkgZG9uJ3Qgc2VlIHRoZSBwb2ludCBpbiByZXdyaXRpbmcgaXQKICBoYXNNYXRjaEZ1bmN0aW9uKGFjdGlvbik7Cn0KZnVuY3Rpb24gZ2V0TWVzc2FnZSh0eXBlKSB7CiAgY29uc3Qgc3BsaXRUeXBlID0gdHlwZSA/IGAke3R5cGV9YC5zcGxpdCgiLyIpIDogW107CiAgY29uc3QgYWN0aW9uTmFtZSA9IHNwbGl0VHlwZVtzcGxpdFR5cGUubGVuZ3RoIC0gMV0gfHwgImFjdGlvbkNyZWF0b3IiOwogIHJldHVybiBgRGV0ZWN0ZWQgYW4gYWN0aW9uIGNyZWF0b3Igd2l0aCB0eXBlICIke3R5cGUgfHwgInVua25vd24ifSIgYmVpbmcgZGlzcGF0Y2hlZC4gCk1ha2Ugc3VyZSB5b3UncmUgY2FsbGluZyB0aGUgYWN0aW9uIGNyZWF0b3IgYmVmb3JlIGRpc3BhdGNoaW5nLCBpLmUuIFxgZGlzcGF0Y2goJHthY3Rpb25OYW1lfSgpKVxgIGluc3RlYWQgb2YgXGBkaXNwYXRjaCgke2FjdGlvbk5hbWV9KVxgLiBUaGlzIGlzIG5lY2Vzc2FyeSBldmVuIGlmIHRoZSBhY3Rpb24gaGFzIG5vIHBheWxvYWQuYDsKfQpmdW5jdGlvbiBjcmVhdGVBY3Rpb25DcmVhdG9ySW52YXJpYW50TWlkZGxld2FyZShvcHRpb25zID0ge30pIHsKICBpZiAoZmFsc2UpIHsKICAgIHJldHVybiAoKSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gbmV4dChhY3Rpb24pOwogIH0KICBjb25zdCB7CiAgICBpc0FjdGlvbkNyZWF0b3I6IGlzQWN0aW9uQ3JlYXRvcjIgPSBpc0FjdGlvbkNyZWF0b3IKICB9ID0gb3B0aW9uczsKICByZXR1cm4gKCkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IHsKICAgIGlmIChpc0FjdGlvbkNyZWF0b3IyKGFjdGlvbikpIHsKICAgICAgY29uc29sZS53YXJuKGdldE1lc3NhZ2UoYWN0aW9uLnR5cGUpKTsKICAgIH0KICAgIHJldHVybiBuZXh0KGFjdGlvbik7CiAgfTsKfQpmdW5jdGlvbiBnZXRUaW1lTWVhc3VyZVV0aWxzKG1heERlbGF5LCBmbk5hbWUpIHsKICBsZXQgZWxhcHNlZCA9IDA7CiAgcmV0dXJuIHsKICAgIG1lYXN1cmVUaW1lKGZuKSB7CiAgICAgIGNvbnN0IHN0YXJ0ZWQgPSBEYXRlLm5vdygpOwogICAgICB0cnkgewogICAgICAgIHJldHVybiBmbigpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIGNvbnN0IGZpbmlzaGVkID0gRGF0ZS5ub3coKTsKICAgICAgICBlbGFwc2VkICs9IGZpbmlzaGVkIC0gc3RhcnRlZDsKICAgICAgfQogICAgfSwKICAgIHdhcm5JZkV4Y2VlZGVkKCkgewogICAgICBpZiAoZWxhcHNlZCA+IG1heERlbGF5KSB7CiAgICAgICAgY29uc29sZS53YXJuKGAke2ZuTmFtZX0gdG9vayAke2VsYXBzZWR9bXMsIHdoaWNoIGlzIG1vcmUgdGhhbiB0aGUgd2FybmluZyB0aHJlc2hvbGQgb2YgJHttYXhEZWxheX1tcy4gCklmIHlvdXIgc3RhdGUgb3IgYWN0aW9ucyBhcmUgdmVyeSBsYXJnZSwgeW91IG1heSB3YW50IHRvIGRpc2FibGUgdGhlIG1pZGRsZXdhcmUgYXMgaXQgbWlnaHQgY2F1c2UgdG9vIG11Y2ggb2YgYSBzbG93ZG93biBpbiBkZXZlbG9wbWVudCBtb2RlLiBTZWUgaHR0cHM6Ly9yZWR1eC10b29sa2l0LmpzLm9yZy9hcGkvZ2V0RGVmYXVsdE1pZGRsZXdhcmUgZm9yIGluc3RydWN0aW9ucy4KSXQgaXMgZGlzYWJsZWQgaW4gcHJvZHVjdGlvbiBidWlsZHMsIHNvIHlvdSBkb24ndCBuZWVkIHRvIHdvcnJ5IGFib3V0IHRoYXQuYCk7CiAgICAgIH0KICAgIH0KICB9Owp9CnZhciBUdXBsZSA9IGNsYXNzIF9UdXBsZSBleHRlbmRzIEFycmF5IHsKICBjb25zdHJ1Y3RvciguLi5pdGVtcykgewogICAgc3VwZXIoLi4uaXRlbXMpOwogICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKHRoaXMsIF9UdXBsZS5wcm90b3R5cGUpOwogIH0KICBzdGF0aWMgZ2V0IFtTeW1ib2wuc3BlY2llc10oKSB7CiAgICByZXR1cm4gX1R1cGxlOwogIH0KICBjb25jYXQoLi4uYXJyKSB7CiAgICByZXR1cm4gc3VwZXIuY29uY2F0LmFwcGx5KHRoaXMsIGFycik7CiAgfQogIHByZXBlbmQoLi4uYXJyKSB7CiAgICBpZiAoYXJyLmxlbmd0aCA9PT0gMSAmJiBBcnJheS5pc0FycmF5KGFyclswXSkpIHsKICAgICAgcmV0dXJuIG5ldyBfVHVwbGUoLi4uYXJyWzBdLmNvbmNhdCh0aGlzKSk7CiAgICB9CiAgICByZXR1cm4gbmV3IF9UdXBsZSguLi5hcnIuY29uY2F0KHRoaXMpKTsKICB9Cn07CmZ1bmN0aW9uIGZyZWV6ZURyYWZ0YWJsZSh2YWwpIHsKICByZXR1cm4gaXNEcmFmdGFibGUodmFsKSA/IHByb2R1Y2UodmFsLCAoKSA9PiB7CiAgfSkgOiB2YWw7Cn0KZnVuY3Rpb24gZ2V0T3JJbnNlcnRDb21wdXRlZChtYXAzLCBrZXksIGNvbXB1dGUpIHsKICBpZiAobWFwMy5oYXMoa2V5KSkgcmV0dXJuIG1hcDMuZ2V0KGtleSk7CiAgcmV0dXJuIG1hcDMuc2V0KGtleSwgY29tcHV0ZShrZXkpKS5nZXQoa2V5KTsKfQpmdW5jdGlvbiBpc0ltbXV0YWJsZURlZmF1bHQodmFsdWUpIHsKICByZXR1cm4gdHlwZW9mIHZhbHVlICE9PSAib2JqZWN0IiB8fCB2YWx1ZSA9PSBudWxsIHx8IE9iamVjdC5pc0Zyb3plbih2YWx1ZSk7Cn0KZnVuY3Rpb24gdHJhY2tGb3JNdXRhdGlvbnMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocywgb2JqKSB7CiAgY29uc3QgdHJhY2tlZFByb3BlcnRpZXMgPSB0cmFja1Byb3BlcnRpZXMoaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocywgb2JqKTsKICByZXR1cm4gewogICAgZGV0ZWN0TXV0YXRpb25zKCkgewogICAgICByZXR1cm4gZGV0ZWN0TXV0YXRpb25zKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMsIHRyYWNrZWRQcm9wZXJ0aWVzLCBvYmopOwogICAgfQogIH07Cn0KZnVuY3Rpb24gdHJhY2tQcm9wZXJ0aWVzKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMgPSBbXSwgb2JqLCBwYXRoMiA9ICIiLCBjaGVja2VkT2JqZWN0cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCkpIHsKICBjb25zdCB0cmFja2VkID0gewogICAgdmFsdWU6IG9iagogIH07CiAgaWYgKCFpc0ltbXV0YWJsZShvYmopICYmICFjaGVja2VkT2JqZWN0cy5oYXMob2JqKSkgewogICAgY2hlY2tlZE9iamVjdHMuYWRkKG9iaik7CiAgICB0cmFja2VkLmNoaWxkcmVuID0ge307CiAgICBjb25zdCBoYXNJZ25vcmVkUGF0aHMgPSBpZ25vcmVkUGF0aHMubGVuZ3RoID4gMDsKICAgIGZvciAoY29uc3Qga2V5IGluIG9iaikgewogICAgICBjb25zdCBuZXN0ZWRQYXRoID0gcGF0aDIgPyBwYXRoMiArICIuIiArIGtleSA6IGtleTsKICAgICAgaWYgKGhhc0lnbm9yZWRQYXRocykgewogICAgICAgIGNvbnN0IGhhc01hdGNoZXMgPSBpZ25vcmVkUGF0aHMuc29tZSgoaWdub3JlZCkgPT4gewogICAgICAgICAgaWYgKGlnbm9yZWQgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgICAgcmV0dXJuIGlnbm9yZWQudGVzdChuZXN0ZWRQYXRoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXN0ZWRQYXRoID09PSBpZ25vcmVkOwogICAgICAgIH0pOwogICAgICAgIGlmIChoYXNNYXRjaGVzKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdHJhY2tlZC5jaGlsZHJlbltrZXldID0gdHJhY2tQcm9wZXJ0aWVzKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMsIG9ialtrZXldLCBuZXN0ZWRQYXRoKTsKICAgIH0KICB9CiAgcmV0dXJuIHRyYWNrZWQ7Cn0KZnVuY3Rpb24gZGV0ZWN0TXV0YXRpb25zKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMgPSBbXSwgdHJhY2tlZFByb3BlcnR5LCBvYmosIHNhbWVQYXJlbnRSZWYgPSBmYWxzZSwgcGF0aDIgPSAiIikgewogIGNvbnN0IHByZXZPYmogPSB0cmFja2VkUHJvcGVydHkgPyB0cmFja2VkUHJvcGVydHkudmFsdWUgOiB2b2lkIDA7CiAgY29uc3Qgc2FtZVJlZiA9IHByZXZPYmogPT09IG9iajsKICBpZiAoc2FtZVBhcmVudFJlZiAmJiAhc2FtZVJlZiAmJiAhTnVtYmVyLmlzTmFOKG9iaikpIHsKICAgIHJldHVybiB7CiAgICAgIHdhc011dGF0ZWQ6IHRydWUsCiAgICAgIHBhdGg6IHBhdGgyCiAgICB9OwogIH0KICBpZiAoaXNJbW11dGFibGUocHJldk9iaikgfHwgaXNJbW11dGFibGUob2JqKSkgewogICAgcmV0dXJuIHsKICAgICAgd2FzTXV0YXRlZDogZmFsc2UKICAgIH07CiAgfQogIGNvbnN0IGtleXNUb0RldGVjdCA9IHt9OwogIGZvciAobGV0IGtleSBpbiB0cmFja2VkUHJvcGVydHkuY2hpbGRyZW4pIHsKICAgIGtleXNUb0RldGVjdFtrZXldID0gdHJ1ZTsKICB9CiAgZm9yIChsZXQga2V5IGluIG9iaikgewogICAga2V5c1RvRGV0ZWN0W2tleV0gPSB0cnVlOwogIH0KICBjb25zdCBoYXNJZ25vcmVkUGF0aHMgPSBpZ25vcmVkUGF0aHMubGVuZ3RoID4gMDsKICBmb3IgKGxldCBrZXkgaW4ga2V5c1RvRGV0ZWN0KSB7CiAgICBjb25zdCBuZXN0ZWRQYXRoID0gcGF0aDIgPyBwYXRoMiArICIuIiArIGtleSA6IGtleTsKICAgIGlmIChoYXNJZ25vcmVkUGF0aHMpIHsKICAgICAgY29uc3QgaGFzTWF0Y2hlcyA9IGlnbm9yZWRQYXRocy5zb21lKChpZ25vcmVkKSA9PiB7CiAgICAgICAgaWYgKGlnbm9yZWQgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgIHJldHVybiBpZ25vcmVkLnRlc3QobmVzdGVkUGF0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXN0ZWRQYXRoID09PSBpZ25vcmVkOwogICAgICB9KTsKICAgICAgaWYgKGhhc01hdGNoZXMpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgfQogICAgY29uc3QgcmVzdWx0ID0gZGV0ZWN0TXV0YXRpb25zKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMsIHRyYWNrZWRQcm9wZXJ0eS5jaGlsZHJlbltrZXldLCBvYmpba2V5XSwgc2FtZVJlZiwgbmVzdGVkUGF0aCk7CiAgICBpZiAocmVzdWx0Lndhc011dGF0ZWQpIHsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9CiAgcmV0dXJuIHsKICAgIHdhc011dGF0ZWQ6IGZhbHNlCiAgfTsKfQpmdW5jdGlvbiBjcmVhdGVJbW11dGFibGVTdGF0ZUludmFyaWFudE1pZGRsZXdhcmUob3B0aW9ucyA9IHt9KSB7CiAgaWYgKGZhbHNlKSB7CiAgICByZXR1cm4gKCkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IG5leHQoYWN0aW9uKTsKICB9IGVsc2UgewogICAgbGV0IHN0cmluZ2lmeTIgPSBmdW5jdGlvbihvYmosIHNlcmlhbGl6ZXIsIGluZGVudCwgZGVjeWNsZXIpIHsKICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaiwgZ2V0U2VyaWFsaXplMihzZXJpYWxpemVyLCBkZWN5Y2xlciksIGluZGVudCk7CiAgICB9LCBnZXRTZXJpYWxpemUyID0gZnVuY3Rpb24oc2VyaWFsaXplciwgZGVjeWNsZXIpIHsKICAgICAgbGV0IHN0YWNrID0gW10sIGtleXMgPSBbXTsKICAgICAgaWYgKCFkZWN5Y2xlcikgZGVjeWNsZXIgPSBmdW5jdGlvbihfLCB2YWx1ZSkgewogICAgICAgIGlmIChzdGFja1swXSA9PT0gdmFsdWUpIHJldHVybiAiW0NpcmN1bGFyIH5dIjsKICAgICAgICByZXR1cm4gIltDaXJjdWxhciB+LiIgKyBrZXlzLnNsaWNlKDAsIHN0YWNrLmluZGV4T2YodmFsdWUpKS5qb2luKCIuIikgKyAiXSI7CiAgICAgIH07CiAgICAgIHJldHVybiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgaWYgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHZhciB0aGlzUG9zID0gc3RhY2suaW5kZXhPZih0aGlzKTsKICAgICAgICAgIH50aGlzUG9zID8gc3RhY2suc3BsaWNlKHRoaXNQb3MgKyAxKSA6IHN0YWNrLnB1c2godGhpcyk7CiAgICAgICAgICB+dGhpc1BvcyA/IGtleXMuc3BsaWNlKHRoaXNQb3MsIEluZmluaXR5LCBrZXkpIDoga2V5cy5wdXNoKGtleSk7CiAgICAgICAgICBpZiAofnN0YWNrLmluZGV4T2YodmFsdWUpKSB2YWx1ZSA9IGRlY3ljbGVyLmNhbGwodGhpcywga2V5LCB2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHN0YWNrLnB1c2godmFsdWUpOwogICAgICAgIHJldHVybiBzZXJpYWxpemVyID09IG51bGwgPyB2YWx1ZSA6IHNlcmlhbGl6ZXIuY2FsbCh0aGlzLCBrZXksIHZhbHVlKTsKICAgICAgfTsKICAgIH07CiAgICB2YXIgc3RyaW5naWZ5ID0gc3RyaW5naWZ5MiwgZ2V0U2VyaWFsaXplID0gZ2V0U2VyaWFsaXplMjsKICAgIGxldCB7CiAgICAgIGlzSW1tdXRhYmxlID0gaXNJbW11dGFibGVEZWZhdWx0LAogICAgICBpZ25vcmVkUGF0aHMsCiAgICAgIHdhcm5BZnRlciA9IDMyCiAgICB9ID0gb3B0aW9uczsKICAgIGNvbnN0IHRyYWNrID0gdHJhY2tGb3JNdXRhdGlvbnMuYmluZChudWxsLCBpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzKTsKICAgIHJldHVybiAoewogICAgICBnZXRTdGF0ZQogICAgfSkgPT4gewogICAgICBsZXQgc3RhdGUgPSBnZXRTdGF0ZSgpOwogICAgICBsZXQgdHJhY2tlciA9IHRyYWNrKHN0YXRlKTsKICAgICAgbGV0IHJlc3VsdDsKICAgICAgcmV0dXJuIChuZXh0KSA9PiAoYWN0aW9uKSA9PiB7CiAgICAgICAgY29uc3QgbWVhc3VyZVV0aWxzID0gZ2V0VGltZU1lYXN1cmVVdGlscyh3YXJuQWZ0ZXIsICJJbW11dGFibGVTdGF0ZUludmFyaWFudE1pZGRsZXdhcmUiKTsKICAgICAgICBtZWFzdXJlVXRpbHMubWVhc3VyZVRpbWUoKCkgPT4gewogICAgICAgICAgc3RhdGUgPSBnZXRTdGF0ZSgpOwogICAgICAgICAgcmVzdWx0ID0gdHJhY2tlci5kZXRlY3RNdXRhdGlvbnMoKTsKICAgICAgICAgIHRyYWNrZXIgPSB0cmFjayhzdGF0ZSk7CiAgICAgICAgICBpZiAocmVzdWx0Lndhc011dGF0ZWQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxOSkgOiBgQSBzdGF0ZSBtdXRhdGlvbiB3YXMgZGV0ZWN0ZWQgYmV0d2VlbiBkaXNwYXRjaGVzLCBpbiB0aGUgcGF0aCAnJHtyZXN1bHQucGF0aCB8fCAiIn0nLiAgVGhpcyBtYXkgY2F1c2UgaW5jb3JyZWN0IGJlaGF2aW9yLiAoaHR0cHM6Ly9yZWR1eC5qcy5vcmcvc3R5bGUtZ3VpZGUvc3R5bGUtZ3VpZGUjZG8tbm90LW11dGF0ZS1zdGF0ZSlgKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBjb25zdCBkaXNwYXRjaGVkQWN0aW9uID0gbmV4dChhY3Rpb24pOwogICAgICAgIG1lYXN1cmVVdGlscy5tZWFzdXJlVGltZSgoKSA9PiB7CiAgICAgICAgICBzdGF0ZSA9IGdldFN0YXRlKCk7CiAgICAgICAgICByZXN1bHQgPSB0cmFja2VyLmRldGVjdE11dGF0aW9ucygpOwogICAgICAgICAgdHJhY2tlciA9IHRyYWNrKHN0YXRlKTsKICAgICAgICAgIGlmIChyZXN1bHQud2FzTXV0YXRlZCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDIwKSA6IGBBIHN0YXRlIG11dGF0aW9uIHdhcyBkZXRlY3RlZCBpbnNpZGUgYSBkaXNwYXRjaCwgaW4gdGhlIHBhdGg6ICR7cmVzdWx0LnBhdGggfHwgIiJ9LiBUYWtlIGEgbG9vayBhdCB0aGUgcmVkdWNlcihzKSBoYW5kbGluZyB0aGUgYWN0aW9uICR7c3RyaW5naWZ5MihhY3Rpb24pfS4gKGh0dHBzOi8vcmVkdXguanMub3JnL3N0eWxlLWd1aWRlL3N0eWxlLWd1aWRlI2RvLW5vdC1tdXRhdGUtc3RhdGUpYCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgbWVhc3VyZVV0aWxzLndhcm5JZkV4Y2VlZGVkKCk7CiAgICAgICAgcmV0dXJuIGRpc3BhdGNoZWRBY3Rpb247CiAgICAgIH07CiAgICB9OwogIH0KfQpmdW5jdGlvbiBpc1BsYWluKHZhbCkgewogIGNvbnN0IHR5cGUgPSB0eXBlb2YgdmFsOwogIHJldHVybiB2YWwgPT0gbnVsbCB8fCB0eXBlID09PSAic3RyaW5nIiB8fCB0eXBlID09PSAiYm9vbGVhbiIgfHwgdHlwZSA9PT0gIm51bWJlciIgfHwgQXJyYXkuaXNBcnJheSh2YWwpIHx8IGlzUGxhaW5PYmplY3QodmFsKTsKfQpmdW5jdGlvbiBmaW5kTm9uU2VyaWFsaXphYmxlVmFsdWUodmFsdWUsIHBhdGgyID0gIiIsIGlzU2VyaWFsaXphYmxlID0gaXNQbGFpbiwgZ2V0RW50cmllcywgaWdub3JlZFBhdGhzID0gW10sIGNhY2hlKSB7CiAgbGV0IGZvdW5kTmVzdGVkU2VyaWFsaXphYmxlOwogIGlmICghaXNTZXJpYWxpemFibGUodmFsdWUpKSB7CiAgICByZXR1cm4gewogICAgICBrZXlQYXRoOiBwYXRoMiB8fCAiPHJvb3Q+IiwKICAgICAgdmFsdWUKICAgIH07CiAgfQogIGlmICh0eXBlb2YgdmFsdWUgIT09ICJvYmplY3QiIHx8IHZhbHVlID09PSBudWxsKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGlmIChjYWNoZT8uaGFzKHZhbHVlKSkgcmV0dXJuIGZhbHNlOwogIGNvbnN0IGVudHJpZXMgPSBnZXRFbnRyaWVzICE9IG51bGwgPyBnZXRFbnRyaWVzKHZhbHVlKSA6IE9iamVjdC5lbnRyaWVzKHZhbHVlKTsKICBjb25zdCBoYXNJZ25vcmVkUGF0aHMgPSBpZ25vcmVkUGF0aHMubGVuZ3RoID4gMDsKICBmb3IgKGNvbnN0IFtrZXksIG5lc3RlZFZhbHVlXSBvZiBlbnRyaWVzKSB7CiAgICBjb25zdCBuZXN0ZWRQYXRoID0gcGF0aDIgPyBwYXRoMiArICIuIiArIGtleSA6IGtleTsKICAgIGlmIChoYXNJZ25vcmVkUGF0aHMpIHsKICAgICAgY29uc3QgaGFzTWF0Y2hlcyA9IGlnbm9yZWRQYXRocy5zb21lKChpZ25vcmVkKSA9PiB7CiAgICAgICAgaWYgKGlnbm9yZWQgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgIHJldHVybiBpZ25vcmVkLnRlc3QobmVzdGVkUGF0aCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXN0ZWRQYXRoID09PSBpZ25vcmVkOwogICAgICB9KTsKICAgICAgaWYgKGhhc01hdGNoZXMpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgfQogICAgaWYgKCFpc1NlcmlhbGl6YWJsZShuZXN0ZWRWYWx1ZSkpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBrZXlQYXRoOiBuZXN0ZWRQYXRoLAogICAgICAgIHZhbHVlOiBuZXN0ZWRWYWx1ZQogICAgICB9OwogICAgfQogICAgaWYgKHR5cGVvZiBuZXN0ZWRWYWx1ZSA9PT0gIm9iamVjdCIpIHsKICAgICAgZm91bmROZXN0ZWRTZXJpYWxpemFibGUgPSBmaW5kTm9uU2VyaWFsaXphYmxlVmFsdWUobmVzdGVkVmFsdWUsIG5lc3RlZFBhdGgsIGlzU2VyaWFsaXphYmxlLCBnZXRFbnRyaWVzLCBpZ25vcmVkUGF0aHMsIGNhY2hlKTsKICAgICAgaWYgKGZvdW5kTmVzdGVkU2VyaWFsaXphYmxlKSB7CiAgICAgICAgcmV0dXJuIGZvdW5kTmVzdGVkU2VyaWFsaXphYmxlOwogICAgICB9CiAgICB9CiAgfQogIGlmIChjYWNoZSAmJiBpc05lc3RlZEZyb3plbih2YWx1ZSkpIGNhY2hlLmFkZCh2YWx1ZSk7CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIGlzTmVzdGVkRnJvemVuKHZhbHVlKSB7CiAgaWYgKCFPYmplY3QuaXNGcm96ZW4odmFsdWUpKSByZXR1cm4gZmFsc2U7CiAgZm9yIChjb25zdCBuZXN0ZWRWYWx1ZSBvZiBPYmplY3QudmFsdWVzKHZhbHVlKSkgewogICAgaWYgKHR5cGVvZiBuZXN0ZWRWYWx1ZSAhPT0gIm9iamVjdCIgfHwgbmVzdGVkVmFsdWUgPT09IG51bGwpIGNvbnRpbnVlOwogICAgaWYgKCFpc05lc3RlZEZyb3plbihuZXN0ZWRWYWx1ZSkpIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gY3JlYXRlU2VyaWFsaXphYmxlU3RhdGVJbnZhcmlhbnRNaWRkbGV3YXJlKG9wdGlvbnMgPSB7fSkgewogIGlmIChmYWxzZSkgewogICAgcmV0dXJuICgpID0+IChuZXh0KSA9PiAoYWN0aW9uKSA9PiBuZXh0KGFjdGlvbik7CiAgfSBlbHNlIHsKICAgIGNvbnN0IHsKICAgICAgaXNTZXJpYWxpemFibGUgPSBpc1BsYWluLAogICAgICBnZXRFbnRyaWVzLAogICAgICBpZ25vcmVkQWN0aW9ucyA9IFtdLAogICAgICBpZ25vcmVkQWN0aW9uUGF0aHMgPSBbIm1ldGEuYXJnIiwgIm1ldGEuYmFzZVF1ZXJ5TWV0YSJdLAogICAgICBpZ25vcmVkUGF0aHMgPSBbXSwKICAgICAgd2FybkFmdGVyID0gMzIsCiAgICAgIGlnbm9yZVN0YXRlID0gZmFsc2UsCiAgICAgIGlnbm9yZUFjdGlvbnMgPSBmYWxzZSwKICAgICAgZGlzYWJsZUNhY2hlID0gZmFsc2UKICAgIH0gPSBvcHRpb25zOwogICAgY29uc3QgY2FjaGUgPSAhZGlzYWJsZUNhY2hlICYmIFdlYWtTZXQgPyAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtTZXQoKSA6IHZvaWQgMDsKICAgIHJldHVybiAoc3RvcmVBUEkpID0+IChuZXh0KSA9PiAoYWN0aW9uKSA9PiB7CiAgICAgIGlmICghaXNBY3Rpb24oYWN0aW9uKSkgewogICAgICAgIHJldHVybiBuZXh0KGFjdGlvbik7CiAgICAgIH0KICAgICAgY29uc3QgcmVzdWx0ID0gbmV4dChhY3Rpb24pOwogICAgICBjb25zdCBtZWFzdXJlVXRpbHMgPSBnZXRUaW1lTWVhc3VyZVV0aWxzKHdhcm5BZnRlciwgIlNlcmlhbGl6YWJsZVN0YXRlSW52YXJpYW50TWlkZGxld2FyZSIpOwogICAgICBpZiAoIWlnbm9yZUFjdGlvbnMgJiYgIShpZ25vcmVkQWN0aW9ucy5sZW5ndGggJiYgaWdub3JlZEFjdGlvbnMuaW5kZXhPZihhY3Rpb24udHlwZSkgIT09IC0xKSkgewogICAgICAgIG1lYXN1cmVVdGlscy5tZWFzdXJlVGltZSgoKSA9PiB7CiAgICAgICAgICBjb25zdCBmb3VuZEFjdGlvbk5vblNlcmlhbGl6YWJsZVZhbHVlID0gZmluZE5vblNlcmlhbGl6YWJsZVZhbHVlKGFjdGlvbiwgIiIsIGlzU2VyaWFsaXphYmxlLCBnZXRFbnRyaWVzLCBpZ25vcmVkQWN0aW9uUGF0aHMsIGNhY2hlKTsKICAgICAgICAgIGlmIChmb3VuZEFjdGlvbk5vblNlcmlhbGl6YWJsZVZhbHVlKSB7CiAgICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgICBrZXlQYXRoLAogICAgICAgICAgICAgIHZhbHVlCiAgICAgICAgICAgIH0gPSBmb3VuZEFjdGlvbk5vblNlcmlhbGl6YWJsZVZhbHVlOwogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBBIG5vbi1zZXJpYWxpemFibGUgdmFsdWUgd2FzIGRldGVjdGVkIGluIGFuIGFjdGlvbiwgaW4gdGhlIHBhdGg6IFxgJHtrZXlQYXRofVxgLiBWYWx1ZTpgLCB2YWx1ZSwgIlxuVGFrZSBhIGxvb2sgYXQgdGhlIGxvZ2ljIHRoYXQgZGlzcGF0Y2hlZCB0aGlzIGFjdGlvbjogIiwgYWN0aW9uLCAiXG4oU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL2ZhcS9hY3Rpb25zI3doeS1zaG91bGQtdHlwZS1iZS1hLXN0cmluZy1vci1hdC1sZWFzdC1zZXJpYWxpemFibGUtd2h5LXNob3VsZC1teS1hY3Rpb24tdHlwZXMtYmUtY29uc3RhbnRzKSIsICJcbihUbyBhbGxvdyBub24tc2VyaWFsaXphYmxlIHZhbHVlcyBzZWU6IGh0dHBzOi8vcmVkdXgtdG9vbGtpdC5qcy5vcmcvdXNhZ2UvdXNhZ2UtZ3VpZGUjd29ya2luZy13aXRoLW5vbi1zZXJpYWxpemFibGUtZGF0YSkiKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoIWlnbm9yZVN0YXRlKSB7CiAgICAgICAgbWVhc3VyZVV0aWxzLm1lYXN1cmVUaW1lKCgpID0+IHsKICAgICAgICAgIGNvbnN0IHN0YXRlID0gc3RvcmVBUEkuZ2V0U3RhdGUoKTsKICAgICAgICAgIGNvbnN0IGZvdW5kU3RhdGVOb25TZXJpYWxpemFibGVWYWx1ZSA9IGZpbmROb25TZXJpYWxpemFibGVWYWx1ZShzdGF0ZSwgIiIsIGlzU2VyaWFsaXphYmxlLCBnZXRFbnRyaWVzLCBpZ25vcmVkUGF0aHMsIGNhY2hlKTsKICAgICAgICAgIGlmIChmb3VuZFN0YXRlTm9uU2VyaWFsaXphYmxlVmFsdWUpIHsKICAgICAgICAgICAgY29uc3QgewogICAgICAgICAgICAgIGtleVBhdGgsCiAgICAgICAgICAgICAgdmFsdWUKICAgICAgICAgICAgfSA9IGZvdW5kU3RhdGVOb25TZXJpYWxpemFibGVWYWx1ZTsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgQSBub24tc2VyaWFsaXphYmxlIHZhbHVlIHdhcyBkZXRlY3RlZCBpbiB0aGUgc3RhdGUsIGluIHRoZSBwYXRoOiBcYCR7a2V5UGF0aH1cYC4gVmFsdWU6YCwgdmFsdWUsIGAKVGFrZSBhIGxvb2sgYXQgdGhlIHJlZHVjZXIocykgaGFuZGxpbmcgdGhpcyBhY3Rpb24gdHlwZTogJHthY3Rpb24udHlwZX0uCihTZWUgaHR0cHM6Ly9yZWR1eC5qcy5vcmcvZmFxL29yZ2FuaXppbmctc3RhdGUjY2FuLWktcHV0LWZ1bmN0aW9ucy1wcm9taXNlcy1vci1vdGhlci1ub24tc2VyaWFsaXphYmxlLWl0ZW1zLWluLW15LXN0b3JlLXN0YXRlKWApOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIG1lYXN1cmVVdGlscy53YXJuSWZFeGNlZWRlZCgpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9OwogIH0KfQpmdW5jdGlvbiBpc0Jvb2xlYW4yKHgyKSB7CiAgcmV0dXJuIHR5cGVvZiB4MiA9PT0gImJvb2xlYW4iOwp9CnZhciBidWlsZEdldERlZmF1bHRNaWRkbGV3YXJlID0gKCkgPT4gZnVuY3Rpb24gZ2V0RGVmYXVsdE1pZGRsZXdhcmUob3B0aW9ucykgewogIGNvbnN0IHsKICAgIHRodW5rOiB0aHVuazIgPSB0cnVlLAogICAgaW1tdXRhYmxlQ2hlY2sgPSB0cnVlLAogICAgc2VyaWFsaXphYmxlQ2hlY2sgPSB0cnVlLAogICAgYWN0aW9uQ3JlYXRvckNoZWNrID0gdHJ1ZQogIH0gPSBvcHRpb25zID8/IHt9OwogIGxldCBtaWRkbGV3YXJlQXJyYXkgPSBuZXcgVHVwbGUoKTsKICBpZiAodGh1bmsyKSB7CiAgICBpZiAoaXNCb29sZWFuMih0aHVuazIpKSB7CiAgICAgIG1pZGRsZXdhcmVBcnJheS5wdXNoKHRodW5rKTsKICAgIH0gZWxzZSB7CiAgICAgIG1pZGRsZXdhcmVBcnJheS5wdXNoKHdpdGhFeHRyYUFyZ3VtZW50KHRodW5rMi5leHRyYUFyZ3VtZW50KSk7CiAgICB9CiAgfQogIGlmICh0cnVlKSB7CiAgICBpZiAoaW1tdXRhYmxlQ2hlY2spIHsKICAgICAgbGV0IGltbXV0YWJsZU9wdGlvbnMgPSB7fTsKICAgICAgaWYgKCFpc0Jvb2xlYW4yKGltbXV0YWJsZUNoZWNrKSkgewogICAgICAgIGltbXV0YWJsZU9wdGlvbnMgPSBpbW11dGFibGVDaGVjazsKICAgICAgfQogICAgICBtaWRkbGV3YXJlQXJyYXkudW5zaGlmdChjcmVhdGVJbW11dGFibGVTdGF0ZUludmFyaWFudE1pZGRsZXdhcmUoaW1tdXRhYmxlT3B0aW9ucykpOwogICAgfQogICAgaWYgKHNlcmlhbGl6YWJsZUNoZWNrKSB7CiAgICAgIGxldCBzZXJpYWxpemFibGVPcHRpb25zID0ge307CiAgICAgIGlmICghaXNCb29sZWFuMihzZXJpYWxpemFibGVDaGVjaykpIHsKICAgICAgICBzZXJpYWxpemFibGVPcHRpb25zID0gc2VyaWFsaXphYmxlQ2hlY2s7CiAgICAgIH0KICAgICAgbWlkZGxld2FyZUFycmF5LnB1c2goY3JlYXRlU2VyaWFsaXphYmxlU3RhdGVJbnZhcmlhbnRNaWRkbGV3YXJlKHNlcmlhbGl6YWJsZU9wdGlvbnMpKTsKICAgIH0KICAgIGlmIChhY3Rpb25DcmVhdG9yQ2hlY2spIHsKICAgICAgbGV0IGFjdGlvbkNyZWF0b3JPcHRpb25zID0ge307CiAgICAgIGlmICghaXNCb29sZWFuMihhY3Rpb25DcmVhdG9yQ2hlY2spKSB7CiAgICAgICAgYWN0aW9uQ3JlYXRvck9wdGlvbnMgPSBhY3Rpb25DcmVhdG9yQ2hlY2s7CiAgICAgIH0KICAgICAgbWlkZGxld2FyZUFycmF5LnVuc2hpZnQoY3JlYXRlQWN0aW9uQ3JlYXRvckludmFyaWFudE1pZGRsZXdhcmUoYWN0aW9uQ3JlYXRvck9wdGlvbnMpKTsKICAgIH0KICB9CiAgcmV0dXJuIG1pZGRsZXdhcmVBcnJheTsKfTsKdmFyIFNIT1VMRF9BVVRPQkFUQ0ggPSAiUlRLX2F1dG9CYXRjaCI7CnZhciBwcmVwYXJlQXV0b0JhdGNoZWQgPSAoKSA9PiAocGF5bG9hZCkgPT4gKHsKICBwYXlsb2FkLAogIG1ldGE6IHsKICAgIFtTSE9VTERfQVVUT0JBVENIXTogdHJ1ZQogIH0KfSk7CnZhciBjcmVhdGVRdWV1ZVdpdGhUaW1lciA9ICh0aW1lb3V0KSA9PiB7CiAgcmV0dXJuIChub3RpZnkpID0+IHsKICAgIHNldFRpbWVvdXQobm90aWZ5LCB0aW1lb3V0KTsKICB9Owp9Owp2YXIgYXV0b0JhdGNoRW5oYW5jZXIgPSAob3B0aW9ucyA9IHsKICB0eXBlOiAicmFmIgp9KSA9PiAobmV4dCkgPT4gKC4uLmFyZ3MpID0+IHsKICBjb25zdCBzdG9yZSA9IG5leHQoLi4uYXJncyk7CiAgbGV0IG5vdGlmeWluZyA9IHRydWU7CiAgbGV0IHNob3VsZE5vdGlmeUF0RW5kT2ZUaWNrID0gZmFsc2U7CiAgbGV0IG5vdGlmaWNhdGlvblF1ZXVlZCA9IGZhbHNlOwogIGNvbnN0IGxpc3RlbmVycyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgY29uc3QgcXVldWVDYWxsYmFjayA9IG9wdGlvbnMudHlwZSA9PT0gInRpY2siID8gcXVldWVNaWNyb3Rhc2sgOiBvcHRpb25zLnR5cGUgPT09ICJyYWYiID8gKAogICAgLy8gcmVxdWVzdEFuaW1hdGlvbkZyYW1lIHdvbid0IGV4aXN0IGluIFNTUiBlbnZpcm9ubWVudHMuIEZhbGwgYmFjayB0byBhIHZhZ3VlIGFwcHJveGltYXRpb24ganVzdCB0byBrZWVwIGZyb20gZXJyb3JpbmcuCiAgICB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID8gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA6IGNyZWF0ZVF1ZXVlV2l0aFRpbWVyKDEwKQogICkgOiBvcHRpb25zLnR5cGUgPT09ICJjYWxsYmFjayIgPyBvcHRpb25zLnF1ZXVlTm90aWZpY2F0aW9uIDogY3JlYXRlUXVldWVXaXRoVGltZXIob3B0aW9ucy50aW1lb3V0KTsKICBjb25zdCBub3RpZnlMaXN0ZW5lcnMgPSAoKSA9PiB7CiAgICBub3RpZmljYXRpb25RdWV1ZWQgPSBmYWxzZTsKICAgIGlmIChzaG91bGROb3RpZnlBdEVuZE9mVGljaykgewogICAgICBzaG91bGROb3RpZnlBdEVuZE9mVGljayA9IGZhbHNlOwogICAgICBsaXN0ZW5lcnMuZm9yRWFjaCgobCkgPT4gbCgpKTsKICAgIH0KICB9OwogIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBzdG9yZSwgewogICAgLy8gT3ZlcnJpZGUgdGhlIGJhc2UgYHN0b3JlLnN1YnNjcmliZWAgbWV0aG9kIHRvIGtlZXAgb3JpZ2luYWwgbGlzdGVuZXJzCiAgICAvLyBmcm9tIHJ1bm5pbmcgaWYgd2UncmUgZGVsYXlpbmcgbm90aWZpY2F0aW9ucwogICAgc3Vic2NyaWJlKGxpc3RlbmVyMikgewogICAgICBjb25zdCB3cmFwcGVkTGlzdGVuZXIgPSAoKSA9PiBub3RpZnlpbmcgJiYgbGlzdGVuZXIyKCk7CiAgICAgIGNvbnN0IHVuc3Vic2NyaWJlID0gc3RvcmUuc3Vic2NyaWJlKHdyYXBwZWRMaXN0ZW5lcik7CiAgICAgIGxpc3RlbmVycy5hZGQobGlzdGVuZXIyKTsKICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICB1bnN1YnNjcmliZSgpOwogICAgICAgIGxpc3RlbmVycy5kZWxldGUobGlzdGVuZXIyKTsKICAgICAgfTsKICAgIH0sCiAgICAvLyBPdmVycmlkZSB0aGUgYmFzZSBgc3RvcmUuZGlzcGF0Y2hgIG1ldGhvZCBzbyB0aGF0IHdlIGNhbiBjaGVjayBhY3Rpb25zCiAgICAvLyBmb3IgdGhlIGBzaG91bGRBdXRvQmF0Y2hgIGZsYWcgYW5kIGRldGVybWluZSBpZiBiYXRjaGluZyBpcyBhY3RpdmUKICAgIGRpc3BhdGNoKGFjdGlvbikgewogICAgICB0cnkgewogICAgICAgIG5vdGlmeWluZyA9ICFhY3Rpb24/Lm1ldGE/LltTSE9VTERfQVVUT0JBVENIXTsKICAgICAgICBzaG91bGROb3RpZnlBdEVuZE9mVGljayA9ICFub3RpZnlpbmc7CiAgICAgICAgaWYgKHNob3VsZE5vdGlmeUF0RW5kT2ZUaWNrKSB7CiAgICAgICAgICBpZiAoIW5vdGlmaWNhdGlvblF1ZXVlZCkgewogICAgICAgICAgICBub3RpZmljYXRpb25RdWV1ZWQgPSB0cnVlOwogICAgICAgICAgICBxdWV1ZUNhbGxiYWNrKG5vdGlmeUxpc3RlbmVycyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdG9yZS5kaXNwYXRjaChhY3Rpb24pOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIG5vdGlmeWluZyA9IHRydWU7CiAgICAgIH0KICAgIH0KICB9KTsKfTsKdmFyIGJ1aWxkR2V0RGVmYXVsdEVuaGFuY2VycyA9IChtaWRkbGV3YXJlRW5oYW5jZXIpID0+IGZ1bmN0aW9uIGdldERlZmF1bHRFbmhhbmNlcnMob3B0aW9ucykgewogIGNvbnN0IHsKICAgIGF1dG9CYXRjaCA9IHRydWUKICB9ID0gb3B0aW9ucyA/PyB7fTsKICBsZXQgZW5oYW5jZXJBcnJheSA9IG5ldyBUdXBsZShtaWRkbGV3YXJlRW5oYW5jZXIpOwogIGlmIChhdXRvQmF0Y2gpIHsKICAgIGVuaGFuY2VyQXJyYXkucHVzaChhdXRvQmF0Y2hFbmhhbmNlcih0eXBlb2YgYXV0b0JhdGNoID09PSAib2JqZWN0IiA/IGF1dG9CYXRjaCA6IHZvaWQgMCkpOwogIH0KICByZXR1cm4gZW5oYW5jZXJBcnJheTsKfTsKZnVuY3Rpb24gY29uZmlndXJlU3RvcmUob3B0aW9ucykgewogIGNvbnN0IGdldERlZmF1bHRNaWRkbGV3YXJlID0gYnVpbGRHZXREZWZhdWx0TWlkZGxld2FyZSgpOwogIGNvbnN0IHsKICAgIHJlZHVjZXIgPSB2b2lkIDAsCiAgICBtaWRkbGV3YXJlLAogICAgZGV2VG9vbHMgPSB0cnVlLAogICAgZHVwbGljYXRlTWlkZGxld2FyZUNoZWNrID0gdHJ1ZSwKICAgIHByZWxvYWRlZFN0YXRlID0gdm9pZCAwLAogICAgZW5oYW5jZXJzID0gdm9pZCAwCiAgfSA9IG9wdGlvbnMgfHwge307CiAgbGV0IHJvb3RSZWR1Y2VyMjsKICBpZiAodHlwZW9mIHJlZHVjZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJvb3RSZWR1Y2VyMiA9IHJlZHVjZXI7CiAgfSBlbHNlIGlmIChpc1BsYWluT2JqZWN0KHJlZHVjZXIpKSB7CiAgICByb290UmVkdWNlcjIgPSBjb21iaW5lUmVkdWNlcnMocmVkdWNlcik7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMSkgOiAiYHJlZHVjZXJgIGlzIGEgcmVxdWlyZWQgYXJndW1lbnQsIGFuZCBtdXN0IGJlIGEgZnVuY3Rpb24gb3IgYW4gb2JqZWN0IG9mIGZ1bmN0aW9ucyB0aGF0IGNhbiBiZSBwYXNzZWQgdG8gY29tYmluZVJlZHVjZXJzIik7CiAgfQogIGlmIChtaWRkbGV3YXJlICYmIHR5cGVvZiBtaWRkbGV3YXJlICE9PSAiZnVuY3Rpb24iKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDIpIDogImBtaWRkbGV3YXJlYCBmaWVsZCBtdXN0IGJlIGEgY2FsbGJhY2siKTsKICB9CiAgbGV0IGZpbmFsTWlkZGxld2FyZTsKICBpZiAodHlwZW9mIG1pZGRsZXdhcmUgPT09ICJmdW5jdGlvbiIpIHsKICAgIGZpbmFsTWlkZGxld2FyZSA9IG1pZGRsZXdhcmUoZ2V0RGVmYXVsdE1pZGRsZXdhcmUpOwogICAgaWYgKCFBcnJheS5pc0FycmF5KGZpbmFsTWlkZGxld2FyZSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgzKSA6ICJ3aGVuIHVzaW5nIGEgbWlkZGxld2FyZSBidWlsZGVyIGZ1bmN0aW9uLCBhbiBhcnJheSBvZiBtaWRkbGV3YXJlIG11c3QgYmUgcmV0dXJuZWQiKTsKICAgIH0KICB9IGVsc2UgewogICAgZmluYWxNaWRkbGV3YXJlID0gZ2V0RGVmYXVsdE1pZGRsZXdhcmUoKTsKICB9CiAgaWYgKGZpbmFsTWlkZGxld2FyZS5zb21lKChpdGVtKSA9PiB0eXBlb2YgaXRlbSAhPT0gImZ1bmN0aW9uIikpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNCkgOiAiZWFjaCBtaWRkbGV3YXJlIHByb3ZpZGVkIHRvIGNvbmZpZ3VyZVN0b3JlIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogIH0KICBpZiAoZHVwbGljYXRlTWlkZGxld2FyZUNoZWNrKSB7CiAgICBsZXQgbWlkZGxld2FyZVJlZmVyZW5jZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgZmluYWxNaWRkbGV3YXJlLmZvckVhY2goKG1pZGRsZXdhcmUyKSA9PiB7CiAgICAgIGlmIChtaWRkbGV3YXJlUmVmZXJlbmNlcy5oYXMobWlkZGxld2FyZTIpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg0MikgOiAiRHVwbGljYXRlIG1pZGRsZXdhcmUgcmVmZXJlbmNlcyBmb3VuZCB3aGVuIGNyZWF0aW5nIHRoZSBzdG9yZS4gRW5zdXJlIHRoYXQgZWFjaCBtaWRkbGV3YXJlIGlzIG9ubHkgaW5jbHVkZWQgb25jZS4iKTsKICAgICAgfQogICAgICBtaWRkbGV3YXJlUmVmZXJlbmNlcy5hZGQobWlkZGxld2FyZTIpOwogICAgfSk7CiAgfQogIGxldCBmaW5hbENvbXBvc2UgPSBjb21wb3NlOwogIGlmIChkZXZUb29scykgewogICAgZmluYWxDb21wb3NlID0gY29tcG9zZVdpdGhEZXZUb29scyh7CiAgICAgIC8vIEVuYWJsZSBjYXB0dXJlIG9mIHN0YWNrIHRyYWNlcyBmb3IgZGlzcGF0Y2hlZCBSZWR1eCBhY3Rpb25zCiAgICAgIHRyYWNlOiB0cnVlLAogICAgICAuLi50eXBlb2YgZGV2VG9vbHMgPT09ICJvYmplY3QiICYmIGRldlRvb2xzCiAgICB9KTsKICB9CiAgY29uc3QgbWlkZGxld2FyZUVuaGFuY2VyID0gYXBwbHlNaWRkbGV3YXJlKC4uLmZpbmFsTWlkZGxld2FyZSk7CiAgY29uc3QgZ2V0RGVmYXVsdEVuaGFuY2VycyA9IGJ1aWxkR2V0RGVmYXVsdEVuaGFuY2VycyhtaWRkbGV3YXJlRW5oYW5jZXIpOwogIGlmIChlbmhhbmNlcnMgJiYgdHlwZW9mIGVuaGFuY2VycyAhPT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg1KSA6ICJgZW5oYW5jZXJzYCBmaWVsZCBtdXN0IGJlIGEgY2FsbGJhY2siKTsKICB9CiAgbGV0IHN0b3JlRW5oYW5jZXJzID0gdHlwZW9mIGVuaGFuY2VycyA9PT0gImZ1bmN0aW9uIiA/IGVuaGFuY2VycyhnZXREZWZhdWx0RW5oYW5jZXJzKSA6IGdldERlZmF1bHRFbmhhbmNlcnMoKTsKICBpZiAoIUFycmF5LmlzQXJyYXkoc3RvcmVFbmhhbmNlcnMpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDYpIDogImBlbmhhbmNlcnNgIGNhbGxiYWNrIG11c3QgcmV0dXJuIGFuIGFycmF5Iik7CiAgfQogIGlmIChzdG9yZUVuaGFuY2Vycy5zb21lKChpdGVtKSA9PiB0eXBlb2YgaXRlbSAhPT0gImZ1bmN0aW9uIikpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNykgOiAiZWFjaCBlbmhhbmNlciBwcm92aWRlZCB0byBjb25maWd1cmVTdG9yZSBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICB9CiAgaWYgKGZpbmFsTWlkZGxld2FyZS5sZW5ndGggJiYgIXN0b3JlRW5oYW5jZXJzLmluY2x1ZGVzKG1pZGRsZXdhcmVFbmhhbmNlcikpIHsKICAgIGNvbnNvbGUuZXJyb3IoIm1pZGRsZXdhcmVzIHdlcmUgcHJvdmlkZWQsIGJ1dCBtaWRkbGV3YXJlIGVuaGFuY2VyIHdhcyBub3QgaW5jbHVkZWQgaW4gZmluYWwgZW5oYW5jZXJzIC0gbWFrZSBzdXJlIHRvIGNhbGwgYGdldERlZmF1bHRFbmhhbmNlcnNgIik7CiAgfQogIGNvbnN0IGNvbXBvc2VkRW5oYW5jZXIgPSBmaW5hbENvbXBvc2UoLi4uc3RvcmVFbmhhbmNlcnMpOwogIHJldHVybiBjcmVhdGVTdG9yZShyb290UmVkdWNlcjIsIHByZWxvYWRlZFN0YXRlLCBjb21wb3NlZEVuaGFuY2VyKTsKfQpmdW5jdGlvbiBleGVjdXRlUmVkdWNlckJ1aWxkZXJDYWxsYmFjayhidWlsZGVyQ2FsbGJhY2spIHsKICBjb25zdCBhY3Rpb25zTWFwID0ge307CiAgY29uc3QgYWN0aW9uTWF0Y2hlcnMgPSBbXTsKICBsZXQgZGVmYXVsdENhc2VSZWR1Y2VyOwogIGNvbnN0IGJ1aWxkZXIgPSB7CiAgICBhZGRDYXNlKHR5cGVPckFjdGlvbkNyZWF0b3IsIHJlZHVjZXIpIHsKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBpZiAoYWN0aW9uTWF0Y2hlcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyNikgOiAiYGJ1aWxkZXIuYWRkQ2FzZWAgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGJlZm9yZSBjYWxsaW5nIGBidWlsZGVyLmFkZE1hdGNoZXJgIik7CiAgICAgICAgfQogICAgICAgIGlmIChkZWZhdWx0Q2FzZVJlZHVjZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjcpIDogImBidWlsZGVyLmFkZENhc2VgIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBiZWZvcmUgY2FsbGluZyBgYnVpbGRlci5hZGREZWZhdWx0Q2FzZWAiKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgdHlwZSA9IHR5cGVvZiB0eXBlT3JBY3Rpb25DcmVhdG9yID09PSAic3RyaW5nIiA/IHR5cGVPckFjdGlvbkNyZWF0b3IgOiB0eXBlT3JBY3Rpb25DcmVhdG9yLnR5cGU7CiAgICAgIGlmICghdHlwZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjgpIDogImBidWlsZGVyLmFkZENhc2VgIGNhbm5vdCBiZSBjYWxsZWQgd2l0aCBhbiBlbXB0eSBhY3Rpb24gdHlwZSIpOwogICAgICB9CiAgICAgIGlmICh0eXBlIGluIGFjdGlvbnNNYXApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDI5KSA6IGBcYGJ1aWxkZXIuYWRkQ2FzZVxgIGNhbm5vdCBiZSBjYWxsZWQgd2l0aCB0d28gcmVkdWNlcnMgZm9yIHRoZSBzYW1lIGFjdGlvbiB0eXBlICcke3R5cGV9J2ApOwogICAgICB9CiAgICAgIGFjdGlvbnNNYXBbdHlwZV0gPSByZWR1Y2VyOwogICAgICByZXR1cm4gYnVpbGRlcjsKICAgIH0sCiAgICBhZGRBc3luY1RodW5rKGFzeW5jVGh1bmssIHJlZHVjZXJzKSB7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgaWYgKGRlZmF1bHRDYXNlUmVkdWNlcikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg0MykgOiAiYGJ1aWxkZXIuYWRkQXN5bmNUaHVua2Agc2hvdWxkIG9ubHkgYmUgY2FsbGVkIGJlZm9yZSBjYWxsaW5nIGBidWlsZGVyLmFkZERlZmF1bHRDYXNlYCIpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAocmVkdWNlcnMucGVuZGluZykgYWN0aW9uc01hcFthc3luY1RodW5rLnBlbmRpbmcudHlwZV0gPSByZWR1Y2Vycy5wZW5kaW5nOwogICAgICBpZiAocmVkdWNlcnMucmVqZWN0ZWQpIGFjdGlvbnNNYXBbYXN5bmNUaHVuay5yZWplY3RlZC50eXBlXSA9IHJlZHVjZXJzLnJlamVjdGVkOwogICAgICBpZiAocmVkdWNlcnMuZnVsZmlsbGVkKSBhY3Rpb25zTWFwW2FzeW5jVGh1bmsuZnVsZmlsbGVkLnR5cGVdID0gcmVkdWNlcnMuZnVsZmlsbGVkOwogICAgICBpZiAocmVkdWNlcnMuc2V0dGxlZCkgYWN0aW9uTWF0Y2hlcnMucHVzaCh7CiAgICAgICAgbWF0Y2hlcjogYXN5bmNUaHVuay5zZXR0bGVkLAogICAgICAgIHJlZHVjZXI6IHJlZHVjZXJzLnNldHRsZWQKICAgICAgfSk7CiAgICAgIHJldHVybiBidWlsZGVyOwogICAgfSwKICAgIGFkZE1hdGNoZXIobWF0Y2hlciwgcmVkdWNlcikgewogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGlmIChkZWZhdWx0Q2FzZVJlZHVjZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMzApIDogImBidWlsZGVyLmFkZE1hdGNoZXJgIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBiZWZvcmUgY2FsbGluZyBgYnVpbGRlci5hZGREZWZhdWx0Q2FzZWAiKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgYWN0aW9uTWF0Y2hlcnMucHVzaCh7CiAgICAgICAgbWF0Y2hlciwKICAgICAgICByZWR1Y2VyCiAgICAgIH0pOwogICAgICByZXR1cm4gYnVpbGRlcjsKICAgIH0sCiAgICBhZGREZWZhdWx0Q2FzZShyZWR1Y2VyKSB7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgaWYgKGRlZmF1bHRDYXNlUmVkdWNlcikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgzMSkgOiAiYGJ1aWxkZXIuYWRkRGVmYXVsdENhc2VgIGNhbiBvbmx5IGJlIGNhbGxlZCBvbmNlIik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGRlZmF1bHRDYXNlUmVkdWNlciA9IHJlZHVjZXI7CiAgICAgIHJldHVybiBidWlsZGVyOwogICAgfQogIH07CiAgYnVpbGRlckNhbGxiYWNrKGJ1aWxkZXIpOwogIHJldHVybiBbYWN0aW9uc01hcCwgYWN0aW9uTWF0Y2hlcnMsIGRlZmF1bHRDYXNlUmVkdWNlcl07Cn0KZnVuY3Rpb24gaXNTdGF0ZUZ1bmN0aW9uKHgyKSB7CiAgcmV0dXJuIHR5cGVvZiB4MiA9PT0gImZ1bmN0aW9uIjsKfQpmdW5jdGlvbiBjcmVhdGVSZWR1Y2VyKGluaXRpYWxTdGF0ZTEzLCBtYXBPckJ1aWxkZXJDYWxsYmFjaykgewogIGlmICh0cnVlKSB7CiAgICBpZiAodHlwZW9mIG1hcE9yQnVpbGRlckNhbGxiYWNrID09PSAib2JqZWN0IikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDgpIDogIlRoZSBvYmplY3Qgbm90YXRpb24gZm9yIGBjcmVhdGVSZWR1Y2VyYCBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgdXNlIHRoZSAnYnVpbGRlciBjYWxsYmFjaycgbm90YXRpb24gaW5zdGVhZDogaHR0cHM6Ly9yZWR1eC10b29sa2l0LmpzLm9yZy9hcGkvY3JlYXRlUmVkdWNlciIpOwogICAgfQogIH0KICBsZXQgW2FjdGlvbnNNYXAsIGZpbmFsQWN0aW9uTWF0Y2hlcnMsIGZpbmFsRGVmYXVsdENhc2VSZWR1Y2VyXSA9IGV4ZWN1dGVSZWR1Y2VyQnVpbGRlckNhbGxiYWNrKG1hcE9yQnVpbGRlckNhbGxiYWNrKTsKICBsZXQgZ2V0SW5pdGlhbFN0YXRlOwogIGlmIChpc1N0YXRlRnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpKSB7CiAgICBnZXRJbml0aWFsU3RhdGUgPSAoKSA9PiBmcmVlemVEcmFmdGFibGUoaW5pdGlhbFN0YXRlMTMoKSk7CiAgfSBlbHNlIHsKICAgIGNvbnN0IGZyb3plbkluaXRpYWxTdGF0ZSA9IGZyZWV6ZURyYWZ0YWJsZShpbml0aWFsU3RhdGUxMyk7CiAgICBnZXRJbml0aWFsU3RhdGUgPSAoKSA9PiBmcm96ZW5Jbml0aWFsU3RhdGU7CiAgfQogIGZ1bmN0aW9uIHJlZHVjZXIoc3RhdGUgPSBnZXRJbml0aWFsU3RhdGUoKSwgYWN0aW9uKSB7CiAgICBsZXQgY2FzZVJlZHVjZXJzID0gW2FjdGlvbnNNYXBbYWN0aW9uLnR5cGVdLCAuLi5maW5hbEFjdGlvbk1hdGNoZXJzLmZpbHRlcigoewogICAgICBtYXRjaGVyCiAgICB9KSA9PiBtYXRjaGVyKGFjdGlvbikpLm1hcCgoewogICAgICByZWR1Y2VyOiByZWR1Y2VyMgogICAgfSkgPT4gcmVkdWNlcjIpXTsKICAgIGlmIChjYXNlUmVkdWNlcnMuZmlsdGVyKChjcikgPT4gISFjcikubGVuZ3RoID09PSAwKSB7CiAgICAgIGNhc2VSZWR1Y2VycyA9IFtmaW5hbERlZmF1bHRDYXNlUmVkdWNlcl07CiAgICB9CiAgICByZXR1cm4gY2FzZVJlZHVjZXJzLnJlZHVjZSgocHJldmlvdXNTdGF0ZSwgY2FzZVJlZHVjZXIpID0+IHsKICAgICAgaWYgKGNhc2VSZWR1Y2VyKSB7CiAgICAgICAgaWYgKGlzRHJhZnQocHJldmlvdXNTdGF0ZSkpIHsKICAgICAgICAgIGNvbnN0IGRyYWZ0ID0gcHJldmlvdXNTdGF0ZTsKICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNhc2VSZWR1Y2VyKGRyYWZ0LCBhY3Rpb24pOwogICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBwcmV2aW91c1N0YXRlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9IGVsc2UgaWYgKCFpc0RyYWZ0YWJsZShwcmV2aW91c1N0YXRlKSkgewogICAgICAgICAgY29uc3QgcmVzdWx0ID0gY2FzZVJlZHVjZXIocHJldmlvdXNTdGF0ZSwgYWN0aW9uKTsKICAgICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAocHJldmlvdXNTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBwcmV2aW91c1N0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93IEVycm9yKCJBIGNhc2UgcmVkdWNlciBvbiBhIG5vbi1kcmFmdGFibGUgdmFsdWUgbXVzdCBub3QgcmV0dXJuIHVuZGVmaW5lZCIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIHByb2R1Y2UocHJldmlvdXNTdGF0ZSwgKGRyYWZ0KSA9PiB7CiAgICAgICAgICAgIHJldHVybiBjYXNlUmVkdWNlcihkcmFmdCwgYWN0aW9uKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gcHJldmlvdXNTdGF0ZTsKICAgIH0sIHN0YXRlKTsKICB9CiAgcmVkdWNlci5nZXRJbml0aWFsU3RhdGUgPSBnZXRJbml0aWFsU3RhdGU7CiAgcmV0dXJuIHJlZHVjZXI7Cn0KdmFyIG1hdGNoZXMgPSAobWF0Y2hlciwgYWN0aW9uKSA9PiB7CiAgaWYgKGhhc01hdGNoRnVuY3Rpb24obWF0Y2hlcikpIHsKICAgIHJldHVybiBtYXRjaGVyLm1hdGNoKGFjdGlvbik7CiAgfSBlbHNlIHsKICAgIHJldHVybiBtYXRjaGVyKGFjdGlvbik7CiAgfQp9OwpmdW5jdGlvbiBpc0FueU9mKC4uLm1hdGNoZXJzKSB7CiAgcmV0dXJuIChhY3Rpb24pID0+IHsKICAgIHJldHVybiBtYXRjaGVycy5zb21lKChtYXRjaGVyKSA9PiBtYXRjaGVzKG1hdGNoZXIsIGFjdGlvbikpOwogIH07Cn0KdmFyIHVybEFscGhhYmV0ID0gIk1vZHVsZVN5bWJoYXNPd25Qci0wMTIzNDU2Nzg5QUJDREVGR0hOUlZmZ2N0aVV2el9LcVlUSmtMeHBaWElqUVciOwp2YXIgbmFub2lkID0gKHNpemUgPSAyMSkgPT4gewogIGxldCBpZCA9ICIiOwogIGxldCBpID0gc2l6ZTsKICB3aGlsZSAoaS0tKSB7CiAgICBpZCArPSB1cmxBbHBoYWJldFtNYXRoLnJhbmRvbSgpICogNjQgfCAwXTsKICB9CiAgcmV0dXJuIGlkOwp9Owp2YXIgY29tbW9uUHJvcGVydGllcyA9IFsibmFtZSIsICJtZXNzYWdlIiwgInN0YWNrIiwgImNvZGUiXTsKdmFyIFJlamVjdFdpdGhWYWx1ZSA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihwYXlsb2FkLCBtZXRhKSB7CiAgICB0aGlzLnBheWxvYWQgPSBwYXlsb2FkOwogICAgdGhpcy5tZXRhID0gbWV0YTsKICB9CiAgLyoKICB0eXBlLW9ubHkgcHJvcGVydHkgdG8gZGlzdGluZ3Vpc2ggYmV0d2VlbiBSZWplY3RXaXRoVmFsdWUgYW5kIEZ1bGZpbGxXaXRoTWV0YQogIGRvZXMgbm90IGV4aXN0IGF0IHJ1bnRpbWUKICAqLwogIF90eXBlOwp9Owp2YXIgRnVsZmlsbFdpdGhNZXRhID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKHBheWxvYWQsIG1ldGEpIHsKICAgIHRoaXMucGF5bG9hZCA9IHBheWxvYWQ7CiAgICB0aGlzLm1ldGEgPSBtZXRhOwogIH0KICAvKgogIHR5cGUtb25seSBwcm9wZXJ0eSB0byBkaXN0aW5ndWlzaCBiZXR3ZWVuIFJlamVjdFdpdGhWYWx1ZSBhbmQgRnVsZmlsbFdpdGhNZXRhCiAgZG9lcyBub3QgZXhpc3QgYXQgcnVudGltZQogICovCiAgX3R5cGU7Cn07CnZhciBtaW5pU2VyaWFsaXplRXJyb3IgPSAodmFsdWUpID0+IHsKICBpZiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgY29uc3Qgc2ltcGxlRXJyb3IgPSB7fTsKICAgIGZvciAoY29uc3QgcHJvcGVydHkgb2YgY29tbW9uUHJvcGVydGllcykgewogICAgICBpZiAodHlwZW9mIHZhbHVlW3Byb3BlcnR5XSA9PT0gInN0cmluZyIpIHsKICAgICAgICBzaW1wbGVFcnJvcltwcm9wZXJ0eV0gPSB2YWx1ZVtwcm9wZXJ0eV07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBzaW1wbGVFcnJvcjsKICB9CiAgcmV0dXJuIHsKICAgIG1lc3NhZ2U6IFN0cmluZyh2YWx1ZSkKICB9Owp9Owp2YXIgZXh0ZXJuYWxBYm9ydE1lc3NhZ2UgPSAiRXh0ZXJuYWwgc2lnbmFsIHdhcyBhYm9ydGVkIjsKdmFyIGNyZWF0ZUFzeW5jVGh1bmsgPSAvKiBAX19QVVJFX18gKi8gKCgpID0+IHsKICBmdW5jdGlvbiBjcmVhdGVBc3luY1RodW5rMih0eXBlUHJlZml4LCBwYXlsb2FkQ3JlYXRvciwgb3B0aW9ucykgewogICAgY29uc3QgZnVsZmlsbGVkID0gY3JlYXRlQWN0aW9uKHR5cGVQcmVmaXggKyAiL2Z1bGZpbGxlZCIsIChwYXlsb2FkLCByZXF1ZXN0SWQsIGFyZywgbWV0YSkgPT4gKHsKICAgICAgcGF5bG9hZCwKICAgICAgbWV0YTogewogICAgICAgIC4uLm1ldGEgfHwge30sCiAgICAgICAgYXJnLAogICAgICAgIHJlcXVlc3RJZCwKICAgICAgICByZXF1ZXN0U3RhdHVzOiAiZnVsZmlsbGVkIgogICAgICB9CiAgICB9KSk7CiAgICBjb25zdCBwZW5kaW5nID0gY3JlYXRlQWN0aW9uKHR5cGVQcmVmaXggKyAiL3BlbmRpbmciLCAocmVxdWVzdElkLCBhcmcsIG1ldGEpID0+ICh7CiAgICAgIHBheWxvYWQ6IHZvaWQgMCwKICAgICAgbWV0YTogewogICAgICAgIC4uLm1ldGEgfHwge30sCiAgICAgICAgYXJnLAogICAgICAgIHJlcXVlc3RJZCwKICAgICAgICByZXF1ZXN0U3RhdHVzOiAicGVuZGluZyIKICAgICAgfQogICAgfSkpOwogICAgY29uc3QgcmVqZWN0ZWQgPSBjcmVhdGVBY3Rpb24odHlwZVByZWZpeCArICIvcmVqZWN0ZWQiLCAoZXJyb3IsIHJlcXVlc3RJZCwgYXJnLCBwYXlsb2FkLCBtZXRhKSA9PiAoewogICAgICBwYXlsb2FkLAogICAgICBlcnJvcjogKG9wdGlvbnMgJiYgb3B0aW9ucy5zZXJpYWxpemVFcnJvciB8fCBtaW5pU2VyaWFsaXplRXJyb3IpKGVycm9yIHx8ICJSZWplY3RlZCIpLAogICAgICBtZXRhOiB7CiAgICAgICAgLi4ubWV0YSB8fCB7fSwKICAgICAgICBhcmcsCiAgICAgICAgcmVxdWVzdElkLAogICAgICAgIHJlamVjdGVkV2l0aFZhbHVlOiAhIXBheWxvYWQsCiAgICAgICAgcmVxdWVzdFN0YXR1czogInJlamVjdGVkIiwKICAgICAgICBhYm9ydGVkOiBlcnJvcj8ubmFtZSA9PT0gIkFib3J0RXJyb3IiLAogICAgICAgIGNvbmRpdGlvbjogZXJyb3I/Lm5hbWUgPT09ICJDb25kaXRpb25FcnJvciIKICAgICAgfQogICAgfSkpOwogICAgZnVuY3Rpb24gYWN0aW9uQ3JlYXRvcihhcmcsIHsKICAgICAgc2lnbmFsCiAgICB9ID0ge30pIHsKICAgICAgcmV0dXJuIChkaXNwYXRjaCwgZ2V0U3RhdGUsIGV4dHJhKSA9PiB7CiAgICAgICAgY29uc3QgcmVxdWVzdElkID0gb3B0aW9ucz8uaWRHZW5lcmF0b3IgPyBvcHRpb25zLmlkR2VuZXJhdG9yKGFyZykgOiBuYW5vaWQoKTsKICAgICAgICBjb25zdCBhYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICAgICAgbGV0IGFib3J0SGFuZGxlcjsKICAgICAgICBsZXQgYWJvcnRSZWFzb247CiAgICAgICAgZnVuY3Rpb24gYWJvcnQocmVhc29uKSB7CiAgICAgICAgICBhYm9ydFJlYXNvbiA9IHJlYXNvbjsKICAgICAgICAgIGFib3J0Q29udHJvbGxlci5hYm9ydCgpOwogICAgICAgIH0KICAgICAgICBpZiAoc2lnbmFsKSB7CiAgICAgICAgICBpZiAoc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgICAgICAgYWJvcnQoZXh0ZXJuYWxBYm9ydE1lc3NhZ2UpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoImFib3J0IiwgKCkgPT4gYWJvcnQoZXh0ZXJuYWxBYm9ydE1lc3NhZ2UpLCB7CiAgICAgICAgICAgICAgb25jZTogdHJ1ZQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgcHJvbWlzZSA9IGFzeW5jIGZ1bmN0aW9uKCkgewogICAgICAgICAgbGV0IGZpbmFsQWN0aW9uOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbGV0IGNvbmRpdGlvblJlc3VsdCA9IG9wdGlvbnM/LmNvbmRpdGlvbj8uKGFyZywgewogICAgICAgICAgICAgIGdldFN0YXRlLAogICAgICAgICAgICAgIGV4dHJhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoaXNUaGVuYWJsZShjb25kaXRpb25SZXN1bHQpKSB7CiAgICAgICAgICAgICAgY29uZGl0aW9uUmVzdWx0ID0gYXdhaXQgY29uZGl0aW9uUmVzdWx0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb25kaXRpb25SZXN1bHQgPT09IGZhbHNlIHx8IGFib3J0Q29udHJvbGxlci5zaWduYWwuYWJvcnRlZCkgewogICAgICAgICAgICAgIHRocm93IHsKICAgICAgICAgICAgICAgIG5hbWU6ICJDb25kaXRpb25FcnJvciIsCiAgICAgICAgICAgICAgICBtZXNzYWdlOiAiQWJvcnRlZCBkdWUgdG8gY29uZGl0aW9uIGNhbGxiYWNrIHJldHVybmluZyBmYWxzZS4iCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBhYm9ydGVkUHJvbWlzZSA9IG5ldyBQcm9taXNlKChfLCByZWplY3QpID0+IHsKICAgICAgICAgICAgICBhYm9ydEhhbmRsZXIgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICByZWplY3QoewogICAgICAgICAgICAgICAgICBuYW1lOiAiQWJvcnRFcnJvciIsCiAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGFib3J0UmVhc29uIHx8ICJBYm9ydGVkIgogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBhYm9ydENvbnRyb2xsZXIuc2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoImFib3J0IiwgYWJvcnRIYW5kbGVyKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGRpc3BhdGNoKHBlbmRpbmcocmVxdWVzdElkLCBhcmcsIG9wdGlvbnM/LmdldFBlbmRpbmdNZXRhPy4oewogICAgICAgICAgICAgIHJlcXVlc3RJZCwKICAgICAgICAgICAgICBhcmcKICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgIGdldFN0YXRlLAogICAgICAgICAgICAgIGV4dHJhCiAgICAgICAgICAgIH0pKSk7CiAgICAgICAgICAgIGZpbmFsQWN0aW9uID0gYXdhaXQgUHJvbWlzZS5yYWNlKFthYm9ydGVkUHJvbWlzZSwgUHJvbWlzZS5yZXNvbHZlKHBheWxvYWRDcmVhdG9yKGFyZywgewogICAgICAgICAgICAgIGRpc3BhdGNoLAogICAgICAgICAgICAgIGdldFN0YXRlLAogICAgICAgICAgICAgIGV4dHJhLAogICAgICAgICAgICAgIHJlcXVlc3RJZCwKICAgICAgICAgICAgICBzaWduYWw6IGFib3J0Q29udHJvbGxlci5zaWduYWwsCiAgICAgICAgICAgICAgYWJvcnQsCiAgICAgICAgICAgICAgcmVqZWN0V2l0aFZhbHVlOiAodmFsdWUsIG1ldGEpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUmVqZWN0V2l0aFZhbHVlKHZhbHVlLCBtZXRhKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGZ1bGZpbGxXaXRoVmFsdWU6ICh2YWx1ZSwgbWV0YSkgPT4gewogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBGdWxmaWxsV2l0aE1ldGEodmFsdWUsIG1ldGEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkpLnRoZW4oKHJlc3VsdCkgPT4gewogICAgICAgICAgICAgIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBSZWplY3RXaXRoVmFsdWUpIHsKICAgICAgICAgICAgICAgIHRocm93IHJlc3VsdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIEZ1bGZpbGxXaXRoTWV0YSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bGZpbGxlZChyZXN1bHQucGF5bG9hZCwgcmVxdWVzdElkLCBhcmcsIHJlc3VsdC5tZXRhKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZ1bGZpbGxlZChyZXN1bHQsIHJlcXVlc3RJZCwgYXJnKTsKICAgICAgICAgICAgfSldKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICBmaW5hbEFjdGlvbiA9IGVyciBpbnN0YW5jZW9mIFJlamVjdFdpdGhWYWx1ZSA/IHJlamVjdGVkKG51bGwsIHJlcXVlc3RJZCwgYXJnLCBlcnIucGF5bG9hZCwgZXJyLm1ldGEpIDogcmVqZWN0ZWQoZXJyLCByZXF1ZXN0SWQsIGFyZyk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBpZiAoYWJvcnRIYW5kbGVyKSB7CiAgICAgICAgICAgICAgYWJvcnRDb250cm9sbGVyLnNpZ25hbC5yZW1vdmVFdmVudExpc3RlbmVyKCJhYm9ydCIsIGFib3J0SGFuZGxlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHNraXBEaXNwYXRjaCA9IG9wdGlvbnMgJiYgIW9wdGlvbnMuZGlzcGF0Y2hDb25kaXRpb25SZWplY3Rpb24gJiYgcmVqZWN0ZWQubWF0Y2goZmluYWxBY3Rpb24pICYmIGZpbmFsQWN0aW9uLm1ldGEuY29uZGl0aW9uOwogICAgICAgICAgaWYgKCFza2lwRGlzcGF0Y2gpIHsKICAgICAgICAgICAgZGlzcGF0Y2goZmluYWxBY3Rpb24pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZpbmFsQWN0aW9uOwogICAgICAgIH0oKTsKICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihwcm9taXNlLCB7CiAgICAgICAgICBhYm9ydCwKICAgICAgICAgIHJlcXVlc3RJZCwKICAgICAgICAgIGFyZywKICAgICAgICAgIHVud3JhcCgpIHsKICAgICAgICAgICAgcmV0dXJuIHByb21pc2UudGhlbih1bndyYXBSZXN1bHQpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9OwogICAgfQogICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oYWN0aW9uQ3JlYXRvciwgewogICAgICBwZW5kaW5nLAogICAgICByZWplY3RlZCwKICAgICAgZnVsZmlsbGVkLAogICAgICBzZXR0bGVkOiBpc0FueU9mKHJlamVjdGVkLCBmdWxmaWxsZWQpLAogICAgICB0eXBlUHJlZml4CiAgICB9KTsKICB9CiAgY3JlYXRlQXN5bmNUaHVuazIud2l0aFR5cGVzID0gKCkgPT4gY3JlYXRlQXN5bmNUaHVuazI7CiAgcmV0dXJuIGNyZWF0ZUFzeW5jVGh1bmsyOwp9KSgpOwpmdW5jdGlvbiB1bndyYXBSZXN1bHQoYWN0aW9uKSB7CiAgaWYgKGFjdGlvbi5tZXRhICYmIGFjdGlvbi5tZXRhLnJlamVjdGVkV2l0aFZhbHVlKSB7CiAgICB0aHJvdyBhY3Rpb24ucGF5bG9hZDsKICB9CiAgaWYgKGFjdGlvbi5lcnJvcikgewogICAgdGhyb3cgYWN0aW9uLmVycm9yOwogIH0KICByZXR1cm4gYWN0aW9uLnBheWxvYWQ7Cn0KZnVuY3Rpb24gaXNUaGVuYWJsZSh2YWx1ZSkgewogIHJldHVybiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHR5cGVvZiB2YWx1ZS50aGVuID09PSAiZnVuY3Rpb24iOwp9CnZhciBhc3luY1RodW5rU3ltYm9sID0gLyogQF9fUFVSRV9fICovIFN5bWJvbC5mb3IoInJ0ay1zbGljZS1jcmVhdGVhc3luY3RodW5rIik7CnZhciBhc3luY1RodW5rQ3JlYXRvciA9IHsKICBbYXN5bmNUaHVua1N5bWJvbF06IGNyZWF0ZUFzeW5jVGh1bmsKfTsKZnVuY3Rpb24gZ2V0VHlwZShzbGljZTIsIGFjdGlvbktleSkgewogIHJldHVybiBgJHtzbGljZTJ9LyR7YWN0aW9uS2V5fWA7Cn0KZnVuY3Rpb24gYnVpbGRDcmVhdGVTbGljZSh7CiAgY3JlYXRvcnMKfSA9IHt9KSB7CiAgY29uc3QgY0FUID0gY3JlYXRvcnM/LmFzeW5jVGh1bms/Llthc3luY1RodW5rU3ltYm9sXTsKICByZXR1cm4gZnVuY3Rpb24gY3JlYXRlU2xpY2UyKG9wdGlvbnMpIHsKICAgIGNvbnN0IHsKICAgICAgbmFtZSwKICAgICAgcmVkdWNlclBhdGggPSBuYW1lCiAgICB9ID0gb3B0aW9uczsKICAgIGlmICghbmFtZSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDExKSA6ICJgbmFtZWAgaXMgYSByZXF1aXJlZCBvcHRpb24gZm9yIGNyZWF0ZVNsaWNlIik7CiAgICB9CiAgICBpZiAodHlwZW9mIHByb2Nlc3MgIT09ICJ1bmRlZmluZWQiICYmIHRydWUpIHsKICAgICAgaWYgKG9wdGlvbnMuaW5pdGlhbFN0YXRlID09PSB2b2lkIDApIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJZb3UgbXVzdCBwcm92aWRlIGFuIGBpbml0aWFsU3RhdGVgIHZhbHVlIHRoYXQgaXMgbm90IGB1bmRlZmluZWRgLiBZb3UgbWF5IGhhdmUgbWlzc3BlbGxlZCBgaW5pdGlhbFN0YXRlYCIpOwogICAgICB9CiAgICB9CiAgICBjb25zdCByZWR1Y2VycyA9ICh0eXBlb2Ygb3B0aW9ucy5yZWR1Y2VycyA9PT0gImZ1bmN0aW9uIiA/IG9wdGlvbnMucmVkdWNlcnMoYnVpbGRSZWR1Y2VyQ3JlYXRvcnMoKSkgOiBvcHRpb25zLnJlZHVjZXJzKSB8fCB7fTsKICAgIGNvbnN0IHJlZHVjZXJOYW1lcyA9IE9iamVjdC5rZXlzKHJlZHVjZXJzKTsKICAgIGNvbnN0IGNvbnRleHQgPSB7CiAgICAgIHNsaWNlQ2FzZVJlZHVjZXJzQnlOYW1lOiB7fSwKICAgICAgc2xpY2VDYXNlUmVkdWNlcnNCeVR5cGU6IHt9LAogICAgICBhY3Rpb25DcmVhdG9yczoge30sCiAgICAgIHNsaWNlTWF0Y2hlcnM6IFtdCiAgICB9OwogICAgY29uc3QgY29udGV4dE1ldGhvZHMgPSB7CiAgICAgIGFkZENhc2UodHlwZU9yQWN0aW9uQ3JlYXRvciwgcmVkdWNlcjIpIHsKICAgICAgICBjb25zdCB0eXBlID0gdHlwZW9mIHR5cGVPckFjdGlvbkNyZWF0b3IgPT09ICJzdHJpbmciID8gdHlwZU9yQWN0aW9uQ3JlYXRvciA6IHR5cGVPckFjdGlvbkNyZWF0b3IudHlwZTsKICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTIpIDogImBjb250ZXh0LmFkZENhc2VgIGNhbm5vdCBiZSBjYWxsZWQgd2l0aCBhbiBlbXB0eSBhY3Rpb24gdHlwZSIpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZSBpbiBjb250ZXh0LnNsaWNlQ2FzZVJlZHVjZXJzQnlUeXBlKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEzKSA6ICJgY29udGV4dC5hZGRDYXNlYCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggdHdvIHJlZHVjZXJzIGZvciB0aGUgc2FtZSBhY3Rpb24gdHlwZTogIiArIHR5cGUpOwogICAgICAgIH0KICAgICAgICBjb250ZXh0LnNsaWNlQ2FzZVJlZHVjZXJzQnlUeXBlW3R5cGVdID0gcmVkdWNlcjI7CiAgICAgICAgcmV0dXJuIGNvbnRleHRNZXRob2RzOwogICAgICB9LAogICAgICBhZGRNYXRjaGVyKG1hdGNoZXIsIHJlZHVjZXIyKSB7CiAgICAgICAgY29udGV4dC5zbGljZU1hdGNoZXJzLnB1c2goewogICAgICAgICAgbWF0Y2hlciwKICAgICAgICAgIHJlZHVjZXI6IHJlZHVjZXIyCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGNvbnRleHRNZXRob2RzOwogICAgICB9LAogICAgICBleHBvc2VBY3Rpb24obmFtZTIsIGFjdGlvbkNyZWF0b3IpIHsKICAgICAgICBjb250ZXh0LmFjdGlvbkNyZWF0b3JzW25hbWUyXSA9IGFjdGlvbkNyZWF0b3I7CiAgICAgICAgcmV0dXJuIGNvbnRleHRNZXRob2RzOwogICAgICB9LAogICAgICBleHBvc2VDYXNlUmVkdWNlcihuYW1lMiwgcmVkdWNlcjIpIHsKICAgICAgICBjb250ZXh0LnNsaWNlQ2FzZVJlZHVjZXJzQnlOYW1lW25hbWUyXSA9IHJlZHVjZXIyOwogICAgICAgIHJldHVybiBjb250ZXh0TWV0aG9kczsKICAgICAgfQogICAgfTsKICAgIHJlZHVjZXJOYW1lcy5mb3JFYWNoKChyZWR1Y2VyTmFtZSkgPT4gewogICAgICBjb25zdCByZWR1Y2VyRGVmaW5pdGlvbiA9IHJlZHVjZXJzW3JlZHVjZXJOYW1lXTsKICAgICAgY29uc3QgcmVkdWNlckRldGFpbHMgPSB7CiAgICAgICAgcmVkdWNlck5hbWUsCiAgICAgICAgdHlwZTogZ2V0VHlwZShuYW1lLCByZWR1Y2VyTmFtZSksCiAgICAgICAgY3JlYXRlTm90YXRpb246IHR5cGVvZiBvcHRpb25zLnJlZHVjZXJzID09PSAiZnVuY3Rpb24iCiAgICAgIH07CiAgICAgIGlmIChpc0FzeW5jVGh1bmtTbGljZVJlZHVjZXJEZWZpbml0aW9uKHJlZHVjZXJEZWZpbml0aW9uKSkgewogICAgICAgIGhhbmRsZVRodW5rQ2FzZVJlZHVjZXJEZWZpbml0aW9uKHJlZHVjZXJEZXRhaWxzLCByZWR1Y2VyRGVmaW5pdGlvbiwgY29udGV4dE1ldGhvZHMsIGNBVCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaGFuZGxlTm9ybWFsUmVkdWNlckRlZmluaXRpb24ocmVkdWNlckRldGFpbHMsIHJlZHVjZXJEZWZpbml0aW9uLCBjb250ZXh0TWV0aG9kcyk7CiAgICAgIH0KICAgIH0pOwogICAgZnVuY3Rpb24gYnVpbGRSZWR1Y2VyKCkgewogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5leHRyYVJlZHVjZXJzID09PSAib2JqZWN0IikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNCkgOiAiVGhlIG9iamVjdCBub3RhdGlvbiBmb3IgYGNyZWF0ZVNsaWNlLmV4dHJhUmVkdWNlcnNgIGhhcyBiZWVuIHJlbW92ZWQuIFBsZWFzZSB1c2UgdGhlICdidWlsZGVyIGNhbGxiYWNrJyBub3RhdGlvbiBpbnN0ZWFkOiBodHRwczovL3JlZHV4LXRvb2xraXQuanMub3JnL2FwaS9jcmVhdGVTbGljZSIpOwogICAgICAgIH0KICAgICAgfQogICAgICBjb25zdCBbZXh0cmFSZWR1Y2VycyA9IHt9LCBhY3Rpb25NYXRjaGVycyA9IFtdLCBkZWZhdWx0Q2FzZVJlZHVjZXIgPSB2b2lkIDBdID0gdHlwZW9mIG9wdGlvbnMuZXh0cmFSZWR1Y2VycyA9PT0gImZ1bmN0aW9uIiA/IGV4ZWN1dGVSZWR1Y2VyQnVpbGRlckNhbGxiYWNrKG9wdGlvbnMuZXh0cmFSZWR1Y2VycykgOiBbb3B0aW9ucy5leHRyYVJlZHVjZXJzXTsKICAgICAgY29uc3QgZmluYWxDYXNlUmVkdWNlcnMgPSB7CiAgICAgICAgLi4uZXh0cmFSZWR1Y2VycywKICAgICAgICAuLi5jb250ZXh0LnNsaWNlQ2FzZVJlZHVjZXJzQnlUeXBlCiAgICAgIH07CiAgICAgIHJldHVybiBjcmVhdGVSZWR1Y2VyKG9wdGlvbnMuaW5pdGlhbFN0YXRlLCAoYnVpbGRlcikgPT4gewogICAgICAgIGZvciAobGV0IGtleSBpbiBmaW5hbENhc2VSZWR1Y2VycykgewogICAgICAgICAgYnVpbGRlci5hZGRDYXNlKGtleSwgZmluYWxDYXNlUmVkdWNlcnNba2V5XSk7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IHNNIG9mIGNvbnRleHQuc2xpY2VNYXRjaGVycykgewogICAgICAgICAgYnVpbGRlci5hZGRNYXRjaGVyKHNNLm1hdGNoZXIsIHNNLnJlZHVjZXIpOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBtIG9mIGFjdGlvbk1hdGNoZXJzKSB7CiAgICAgICAgICBidWlsZGVyLmFkZE1hdGNoZXIobS5tYXRjaGVyLCBtLnJlZHVjZXIpOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmYXVsdENhc2VSZWR1Y2VyKSB7CiAgICAgICAgICBidWlsZGVyLmFkZERlZmF1bHRDYXNlKGRlZmF1bHRDYXNlUmVkdWNlcik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIGNvbnN0IHNlbGVjdFNlbGYgPSAoc3RhdGUpID0+IHN0YXRlOwogICAgY29uc3QgaW5qZWN0ZWRTZWxlY3RvckNhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgIGNvbnN0IGluamVjdGVkU3RhdGVDYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwogICAgbGV0IF9yZWR1Y2VyOwogICAgZnVuY3Rpb24gcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIGlmICghX3JlZHVjZXIpIF9yZWR1Y2VyID0gYnVpbGRSZWR1Y2VyKCk7CiAgICAgIHJldHVybiBfcmVkdWNlcihzdGF0ZSwgYWN0aW9uKTsKICAgIH0KICAgIGZ1bmN0aW9uIGdldEluaXRpYWxTdGF0ZSgpIHsKICAgICAgaWYgKCFfcmVkdWNlcikgX3JlZHVjZXIgPSBidWlsZFJlZHVjZXIoKTsKICAgICAgcmV0dXJuIF9yZWR1Y2VyLmdldEluaXRpYWxTdGF0ZSgpOwogICAgfQogICAgZnVuY3Rpb24gbWFrZVNlbGVjdG9yUHJvcHMocmVkdWNlclBhdGgyLCBpbmplY3RlZCA9IGZhbHNlKSB7CiAgICAgIGZ1bmN0aW9uIHNlbGVjdFNsaWNlKHN0YXRlKSB7CiAgICAgICAgbGV0IHNsaWNlU3RhdGUgPSBzdGF0ZVtyZWR1Y2VyUGF0aDJdOwogICAgICAgIGlmICh0eXBlb2Ygc2xpY2VTdGF0ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIGlmIChpbmplY3RlZCkgewogICAgICAgICAgICBzbGljZVN0YXRlID0gZ2V0T3JJbnNlcnRDb21wdXRlZChpbmplY3RlZFN0YXRlQ2FjaGUsIHNlbGVjdFNsaWNlLCBnZXRJbml0aWFsU3RhdGUpOwogICAgICAgICAgfSBlbHNlIGlmICh0cnVlKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTUpIDogInNlbGVjdFNsaWNlIHJldHVybmVkIHVuZGVmaW5lZCBmb3IgYW4gdW5pbmplY3RlZCBzbGljZSByZWR1Y2VyIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzbGljZVN0YXRlOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdG9ycyhzZWxlY3RTdGF0ZSA9IHNlbGVjdFNlbGYpIHsKICAgICAgICBjb25zdCBzZWxlY3RvckNhY2hlID0gZ2V0T3JJbnNlcnRDb21wdXRlZChpbmplY3RlZFNlbGVjdG9yQ2FjaGUsIGluamVjdGVkLCAoKSA9PiAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKSk7CiAgICAgICAgcmV0dXJuIGdldE9ySW5zZXJ0Q29tcHV0ZWQoc2VsZWN0b3JDYWNoZSwgc2VsZWN0U3RhdGUsICgpID0+IHsKICAgICAgICAgIGNvbnN0IG1hcDMgPSB7fTsKICAgICAgICAgIGZvciAoY29uc3QgW25hbWUyLCBzZWxlY3Rvcl0gb2YgT2JqZWN0LmVudHJpZXMob3B0aW9ucy5zZWxlY3RvcnMgPz8ge30pKSB7CiAgICAgICAgICAgIG1hcDNbbmFtZTJdID0gd3JhcFNlbGVjdG9yKHNlbGVjdG9yLCBzZWxlY3RTdGF0ZSwgKCkgPT4gZ2V0T3JJbnNlcnRDb21wdXRlZChpbmplY3RlZFN0YXRlQ2FjaGUsIHNlbGVjdFN0YXRlLCBnZXRJbml0aWFsU3RhdGUpLCBpbmplY3RlZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWFwMzsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHJlZHVjZXJQYXRoOiByZWR1Y2VyUGF0aDIsCiAgICAgICAgZ2V0U2VsZWN0b3JzLAogICAgICAgIGdldCBzZWxlY3RvcnMoKSB7CiAgICAgICAgICByZXR1cm4gZ2V0U2VsZWN0b3JzKHNlbGVjdFNsaWNlKTsKICAgICAgICB9LAogICAgICAgIHNlbGVjdFNsaWNlCiAgICAgIH07CiAgICB9CiAgICBjb25zdCBzbGljZTIgPSB7CiAgICAgIG5hbWUsCiAgICAgIHJlZHVjZXIsCiAgICAgIGFjdGlvbnM6IGNvbnRleHQuYWN0aW9uQ3JlYXRvcnMsCiAgICAgIGNhc2VSZWR1Y2VyczogY29udGV4dC5zbGljZUNhc2VSZWR1Y2Vyc0J5TmFtZSwKICAgICAgZ2V0SW5pdGlhbFN0YXRlLAogICAgICAuLi5tYWtlU2VsZWN0b3JQcm9wcyhyZWR1Y2VyUGF0aCksCiAgICAgIGluamVjdEludG8oaW5qZWN0YWJsZSwgewogICAgICAgIHJlZHVjZXJQYXRoOiBwYXRoT3B0LAogICAgICAgIC4uLmNvbmZpZwogICAgICB9ID0ge30pIHsKICAgICAgICBjb25zdCBuZXdSZWR1Y2VyUGF0aCA9IHBhdGhPcHQgPz8gcmVkdWNlclBhdGg7CiAgICAgICAgaW5qZWN0YWJsZS5pbmplY3QoewogICAgICAgICAgcmVkdWNlclBhdGg6IG5ld1JlZHVjZXJQYXRoLAogICAgICAgICAgcmVkdWNlcgogICAgICAgIH0sIGNvbmZpZyk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIC4uLnNsaWNlMiwKICAgICAgICAgIC4uLm1ha2VTZWxlY3RvclByb3BzKG5ld1JlZHVjZXJQYXRoLCB0cnVlKQogICAgICAgIH07CiAgICAgIH0KICAgIH07CiAgICByZXR1cm4gc2xpY2UyOwogIH07Cn0KZnVuY3Rpb24gd3JhcFNlbGVjdG9yKHNlbGVjdG9yLCBzZWxlY3RTdGF0ZSwgZ2V0SW5pdGlhbFN0YXRlLCBpbmplY3RlZCkgewogIGZ1bmN0aW9uIHdyYXBwZXIocm9vdFN0YXRlLCAuLi5hcmdzKSB7CiAgICBsZXQgc2xpY2VTdGF0ZSA9IHNlbGVjdFN0YXRlKHJvb3RTdGF0ZSk7CiAgICBpZiAodHlwZW9mIHNsaWNlU3RhdGUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIGlmIChpbmplY3RlZCkgewogICAgICAgIHNsaWNlU3RhdGUgPSBnZXRJbml0aWFsU3RhdGUoKTsKICAgICAgfSBlbHNlIGlmICh0cnVlKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNikgOiAic2VsZWN0U3RhdGUgcmV0dXJuZWQgdW5kZWZpbmVkIGZvciBhbiB1bmluamVjdGVkIHNsaWNlIHJlZHVjZXIiKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIHNlbGVjdG9yKHNsaWNlU3RhdGUsIC4uLmFyZ3MpOwogIH0KICB3cmFwcGVyLnVud3JhcHBlZCA9IHNlbGVjdG9yOwogIHJldHVybiB3cmFwcGVyOwp9CnZhciBjcmVhdGVTbGljZSA9IC8qIEBfX1BVUkVfXyAqLyBidWlsZENyZWF0ZVNsaWNlKCk7CmZ1bmN0aW9uIGJ1aWxkUmVkdWNlckNyZWF0b3JzKCkgewogIGZ1bmN0aW9uIGFzeW5jVGh1bmsocGF5bG9hZENyZWF0b3IsIGNvbmZpZykgewogICAgcmV0dXJuIHsKICAgICAgX3JlZHVjZXJEZWZpbml0aW9uVHlwZTogImFzeW5jVGh1bmsiLAogICAgICBwYXlsb2FkQ3JlYXRvciwKICAgICAgLi4uY29uZmlnCiAgICB9OwogIH0KICBhc3luY1RodW5rLndpdGhUeXBlcyA9ICgpID0+IGFzeW5jVGh1bms7CiAgcmV0dXJuIHsKICAgIHJlZHVjZXIoY2FzZVJlZHVjZXIpIHsKICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oewogICAgICAgIC8vIGhhY2sgc28gdGhlIHdyYXBwaW5nIGZ1bmN0aW9uIGhhcyB0aGUgc2FtZSBuYW1lIGFzIHRoZSBvcmlnaW5hbAogICAgICAgIC8vIHdlIG5lZWQgdG8gY3JlYXRlIGEgd3JhcHBlciBzbyB0aGUgYHJlZHVjZXJEZWZpbml0aW9uVHlwZWAgaXMgbm90IGFzc2lnbmVkIHRvIHRoZSBvcmlnaW5hbAogICAgICAgIFtjYXNlUmVkdWNlci5uYW1lXSguLi5hcmdzKSB7CiAgICAgICAgICByZXR1cm4gY2FzZVJlZHVjZXIoLi4uYXJncyk7CiAgICAgICAgfQogICAgICB9W2Nhc2VSZWR1Y2VyLm5hbWVdLCB7CiAgICAgICAgX3JlZHVjZXJEZWZpbml0aW9uVHlwZTogInJlZHVjZXIiCiAgICAgICAgLyogcmVkdWNlciAqLwogICAgICB9KTsKICAgIH0sCiAgICBwcmVwYXJlZFJlZHVjZXIocHJlcGFyZSwgcmVkdWNlcikgewogICAgICByZXR1cm4gewogICAgICAgIF9yZWR1Y2VyRGVmaW5pdGlvblR5cGU6ICJyZWR1Y2VyV2l0aFByZXBhcmUiLAogICAgICAgIHByZXBhcmUsCiAgICAgICAgcmVkdWNlcgogICAgICB9OwogICAgfSwKICAgIGFzeW5jVGh1bmsKICB9Owp9CmZ1bmN0aW9uIGhhbmRsZU5vcm1hbFJlZHVjZXJEZWZpbml0aW9uKHsKICB0eXBlLAogIHJlZHVjZXJOYW1lLAogIGNyZWF0ZU5vdGF0aW9uCn0sIG1heWJlUmVkdWNlcldpdGhQcmVwYXJlLCBjb250ZXh0KSB7CiAgbGV0IGNhc2VSZWR1Y2VyOwogIGxldCBwcmVwYXJlQ2FsbGJhY2s7CiAgaWYgKCJyZWR1Y2VyIiBpbiBtYXliZVJlZHVjZXJXaXRoUHJlcGFyZSkgewogICAgaWYgKGNyZWF0ZU5vdGF0aW9uICYmICFpc0Nhc2VSZWR1Y2VyV2l0aFByZXBhcmVEZWZpbml0aW9uKG1heWJlUmVkdWNlcldpdGhQcmVwYXJlKSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE3KSA6ICJQbGVhc2UgdXNlIHRoZSBgY3JlYXRlLnByZXBhcmVkUmVkdWNlcmAgbm90YXRpb24gZm9yIHByZXBhcmVkIGFjdGlvbiBjcmVhdG9ycyB3aXRoIHRoZSBgY3JlYXRlYCBub3RhdGlvbi4iKTsKICAgIH0KICAgIGNhc2VSZWR1Y2VyID0gbWF5YmVSZWR1Y2VyV2l0aFByZXBhcmUucmVkdWNlcjsKICAgIHByZXBhcmVDYWxsYmFjayA9IG1heWJlUmVkdWNlcldpdGhQcmVwYXJlLnByZXBhcmU7CiAgfSBlbHNlIHsKICAgIGNhc2VSZWR1Y2VyID0gbWF5YmVSZWR1Y2VyV2l0aFByZXBhcmU7CiAgfQogIGNvbnRleHQuYWRkQ2FzZSh0eXBlLCBjYXNlUmVkdWNlcikuZXhwb3NlQ2FzZVJlZHVjZXIocmVkdWNlck5hbWUsIGNhc2VSZWR1Y2VyKS5leHBvc2VBY3Rpb24ocmVkdWNlck5hbWUsIHByZXBhcmVDYWxsYmFjayA/IGNyZWF0ZUFjdGlvbih0eXBlLCBwcmVwYXJlQ2FsbGJhY2spIDogY3JlYXRlQWN0aW9uKHR5cGUpKTsKfQpmdW5jdGlvbiBpc0FzeW5jVGh1bmtTbGljZVJlZHVjZXJEZWZpbml0aW9uKHJlZHVjZXJEZWZpbml0aW9uKSB7CiAgcmV0dXJuIHJlZHVjZXJEZWZpbml0aW9uLl9yZWR1Y2VyRGVmaW5pdGlvblR5cGUgPT09ICJhc3luY1RodW5rIjsKfQpmdW5jdGlvbiBpc0Nhc2VSZWR1Y2VyV2l0aFByZXBhcmVEZWZpbml0aW9uKHJlZHVjZXJEZWZpbml0aW9uKSB7CiAgcmV0dXJuIHJlZHVjZXJEZWZpbml0aW9uLl9yZWR1Y2VyRGVmaW5pdGlvblR5cGUgPT09ICJyZWR1Y2VyV2l0aFByZXBhcmUiOwp9CmZ1bmN0aW9uIGhhbmRsZVRodW5rQ2FzZVJlZHVjZXJEZWZpbml0aW9uKHsKICB0eXBlLAogIHJlZHVjZXJOYW1lCn0sIHJlZHVjZXJEZWZpbml0aW9uLCBjb250ZXh0LCBjQVQpIHsKICBpZiAoIWNBVCkgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxOCkgOiAiQ2Fubm90IHVzZSBgY3JlYXRlLmFzeW5jVGh1bmtgIGluIHRoZSBidWlsdC1pbiBgY3JlYXRlU2xpY2VgLiBVc2UgYGJ1aWxkQ3JlYXRlU2xpY2UoeyBjcmVhdG9yczogeyBhc3luY1RodW5rOiBhc3luY1RodW5rQ3JlYXRvciB9IH0pYCB0byBjcmVhdGUgYSBjdXN0b21pc2VkIHZlcnNpb24gb2YgYGNyZWF0ZVNsaWNlYC4iKTsKICB9CiAgY29uc3QgewogICAgcGF5bG9hZENyZWF0b3IsCiAgICBmdWxmaWxsZWQsCiAgICBwZW5kaW5nLAogICAgcmVqZWN0ZWQsCiAgICBzZXR0bGVkLAogICAgb3B0aW9ucwogIH0gPSByZWR1Y2VyRGVmaW5pdGlvbjsKICBjb25zdCB0aHVuazIgPSBjQVQodHlwZSwgcGF5bG9hZENyZWF0b3IsIG9wdGlvbnMpOwogIGNvbnRleHQuZXhwb3NlQWN0aW9uKHJlZHVjZXJOYW1lLCB0aHVuazIpOwogIGlmIChmdWxmaWxsZWQpIHsKICAgIGNvbnRleHQuYWRkQ2FzZSh0aHVuazIuZnVsZmlsbGVkLCBmdWxmaWxsZWQpOwogIH0KICBpZiAocGVuZGluZykgewogICAgY29udGV4dC5hZGRDYXNlKHRodW5rMi5wZW5kaW5nLCBwZW5kaW5nKTsKICB9CiAgaWYgKHJlamVjdGVkKSB7CiAgICBjb250ZXh0LmFkZENhc2UodGh1bmsyLnJlamVjdGVkLCByZWplY3RlZCk7CiAgfQogIGlmIChzZXR0bGVkKSB7CiAgICBjb250ZXh0LmFkZE1hdGNoZXIodGh1bmsyLnNldHRsZWQsIHNldHRsZWQpOwogIH0KICBjb250ZXh0LmV4cG9zZUNhc2VSZWR1Y2VyKHJlZHVjZXJOYW1lLCB7CiAgICBmdWxmaWxsZWQ6IGZ1bGZpbGxlZCB8fCBub29wMywKICAgIHBlbmRpbmc6IHBlbmRpbmcgfHwgbm9vcDMsCiAgICByZWplY3RlZDogcmVqZWN0ZWQgfHwgbm9vcDMsCiAgICBzZXR0bGVkOiBzZXR0bGVkIHx8IG5vb3AzCiAgfSk7Cn0KZnVuY3Rpb24gbm9vcDMoKSB7Cn0KdmFyIHRhc2sgPSAidGFzayI7CnZhciBsaXN0ZW5lciA9ICJsaXN0ZW5lciI7CnZhciBjb21wbGV0ZWQgPSAiY29tcGxldGVkIjsKdmFyIGNhbmNlbGxlZCA9ICJjYW5jZWxsZWQiOwp2YXIgdGFza0NhbmNlbGxlZCA9IGB0YXNrLSR7Y2FuY2VsbGVkfWA7CnZhciB0YXNrQ29tcGxldGVkID0gYHRhc2stJHtjb21wbGV0ZWR9YDsKdmFyIGxpc3RlbmVyQ2FuY2VsbGVkID0gYCR7bGlzdGVuZXJ9LSR7Y2FuY2VsbGVkfWA7CnZhciBsaXN0ZW5lckNvbXBsZXRlZCA9IGAke2xpc3RlbmVyfS0ke2NvbXBsZXRlZH1gOwp2YXIgVGFza0Fib3J0RXJyb3IgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY29kZSkgewogICAgdGhpcy5jb2RlID0gY29kZTsKICAgIHRoaXMubWVzc2FnZSA9IGAke3Rhc2t9ICR7Y2FuY2VsbGVkfSAocmVhc29uOiAke2NvZGV9KWA7CiAgfQogIG5hbWUgPSAiVGFza0Fib3J0RXJyb3IiOwogIG1lc3NhZ2U7Cn07CnZhciBhc3NlcnRGdW5jdGlvbiA9IChmdW5jLCBleHBlY3RlZCkgPT4gewogIGlmICh0eXBlb2YgZnVuYyAhPT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IFR5cGVFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMzIpIDogYCR7ZXhwZWN0ZWR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CiAgfQp9Owp2YXIgbm9vcDIyID0gKCkgPT4gewp9Owp2YXIgY2F0Y2hSZWplY3Rpb24gPSAocHJvbWlzZSwgb25FcnJvciA9IG5vb3AyMikgPT4gewogIHByb21pc2UuY2F0Y2gob25FcnJvcik7CiAgcmV0dXJuIHByb21pc2U7Cn07CnZhciBhZGRBYm9ydFNpZ25hbExpc3RlbmVyID0gKGFib3J0U2lnbmFsLCBjYWxsYmFjaykgPT4gewogIGFib3J0U2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoImFib3J0IiwgY2FsbGJhY2ssIHsKICAgIG9uY2U6IHRydWUKICB9KTsKICByZXR1cm4gKCkgPT4gYWJvcnRTaWduYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBjYWxsYmFjayk7Cn07CnZhciBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uID0gKGFib3J0Q29udHJvbGxlciwgcmVhc29uKSA9PiB7CiAgY29uc3Qgc2lnbmFsID0gYWJvcnRDb250cm9sbGVyLnNpZ25hbDsKICBpZiAoc2lnbmFsLmFib3J0ZWQpIHsKICAgIHJldHVybjsKICB9CiAgaWYgKCEoInJlYXNvbiIgaW4gc2lnbmFsKSkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHNpZ25hbCwgInJlYXNvbiIsIHsKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgdmFsdWU6IHJlYXNvbiwKICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICB3cml0YWJsZTogdHJ1ZQogICAgfSk7CiAgfQogIDsKICBhYm9ydENvbnRyb2xsZXIuYWJvcnQocmVhc29uKTsKfTsKdmFyIHZhbGlkYXRlQWN0aXZlID0gKHNpZ25hbCkgPT4gewogIGlmIChzaWduYWwuYWJvcnRlZCkgewogICAgY29uc3QgewogICAgICByZWFzb24KICAgIH0gPSBzaWduYWw7CiAgICB0aHJvdyBuZXcgVGFza0Fib3J0RXJyb3IocmVhc29uKTsKICB9Cn07CmZ1bmN0aW9uIHJhY2VXaXRoU2lnbmFsKHNpZ25hbCwgcHJvbWlzZSkgewogIGxldCBjbGVhbnVwID0gbm9vcDIyOwogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBjb25zdCBub3RpZnlSZWplY3Rpb24gPSAoKSA9PiByZWplY3QobmV3IFRhc2tBYm9ydEVycm9yKHNpZ25hbC5yZWFzb24pKTsKICAgIGlmIChzaWduYWwuYWJvcnRlZCkgewogICAgICBub3RpZnlSZWplY3Rpb24oKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgY2xlYW51cCA9IGFkZEFib3J0U2lnbmFsTGlzdGVuZXIoc2lnbmFsLCBub3RpZnlSZWplY3Rpb24pOwogICAgcHJvbWlzZS5maW5hbGx5KCgpID0+IGNsZWFudXAoKSkudGhlbihyZXNvbHZlLCByZWplY3QpOwogIH0pLmZpbmFsbHkoKCkgPT4gewogICAgY2xlYW51cCA9IG5vb3AyMjsKICB9KTsKfQp2YXIgcnVuVGFzayA9IGFzeW5jICh0YXNrMiwgY2xlYW5VcCkgPT4gewogIHRyeSB7CiAgICBhd2FpdCBQcm9taXNlLnJlc29sdmUoKTsKICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgdGFzazIoKTsKICAgIHJldHVybiB7CiAgICAgIHN0YXR1czogIm9rIiwKICAgICAgdmFsdWUKICAgIH07CiAgfSBjYXRjaCAoZXJyb3IpIHsKICAgIHJldHVybiB7CiAgICAgIHN0YXR1czogZXJyb3IgaW5zdGFuY2VvZiBUYXNrQWJvcnRFcnJvciA/ICJjYW5jZWxsZWQiIDogInJlamVjdGVkIiwKICAgICAgZXJyb3IKICAgIH07CiAgfSBmaW5hbGx5IHsKICAgIGNsZWFuVXA/LigpOwogIH0KfTsKdmFyIGNyZWF0ZVBhdXNlID0gKHNpZ25hbCkgPT4gewogIHJldHVybiAocHJvbWlzZSkgPT4gewogICAgcmV0dXJuIGNhdGNoUmVqZWN0aW9uKHJhY2VXaXRoU2lnbmFsKHNpZ25hbCwgcHJvbWlzZSkudGhlbigob3V0cHV0KSA9PiB7CiAgICAgIHZhbGlkYXRlQWN0aXZlKHNpZ25hbCk7CiAgICAgIHJldHVybiBvdXRwdXQ7CiAgICB9KSk7CiAgfTsKfTsKdmFyIGNyZWF0ZURlbGF5ID0gKHNpZ25hbCkgPT4gewogIGNvbnN0IHBhdXNlID0gY3JlYXRlUGF1c2Uoc2lnbmFsKTsKICByZXR1cm4gKHRpbWVvdXRNcykgPT4gewogICAgcmV0dXJuIHBhdXNlKG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIHRpbWVvdXRNcykpKTsKICB9Owp9Owp2YXIgewogIGFzc2lnbgp9ID0gT2JqZWN0Owp2YXIgSU5URVJOQUxfTklMX1RPS0VOID0ge307CnZhciBhbG0gPSAibGlzdGVuZXJNaWRkbGV3YXJlIjsKdmFyIGNyZWF0ZUZvcmsgPSAocGFyZW50QWJvcnRTaWduYWwsIHBhcmVudEJsb2NraW5nUHJvbWlzZXMpID0+IHsKICBjb25zdCBsaW5rQ29udHJvbGxlcnMgPSAoY29udHJvbGxlcikgPT4gYWRkQWJvcnRTaWduYWxMaXN0ZW5lcihwYXJlbnRBYm9ydFNpZ25hbCwgKCkgPT4gYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihjb250cm9sbGVyLCBwYXJlbnRBYm9ydFNpZ25hbC5yZWFzb24pKTsKICByZXR1cm4gKHRhc2tFeGVjdXRvciwgb3B0cykgPT4gewogICAgYXNzZXJ0RnVuY3Rpb24odGFza0V4ZWN1dG9yLCAidGFza0V4ZWN1dG9yIik7CiAgICBjb25zdCBjaGlsZEFib3J0Q29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGxpbmtDb250cm9sbGVycyhjaGlsZEFib3J0Q29udHJvbGxlcik7CiAgICBjb25zdCByZXN1bHQgPSBydW5UYXNrKGFzeW5jICgpID0+IHsKICAgICAgdmFsaWRhdGVBY3RpdmUocGFyZW50QWJvcnRTaWduYWwpOwogICAgICB2YWxpZGF0ZUFjdGl2ZShjaGlsZEFib3J0Q29udHJvbGxlci5zaWduYWwpOwogICAgICBjb25zdCByZXN1bHQyID0gYXdhaXQgdGFza0V4ZWN1dG9yKHsKICAgICAgICBwYXVzZTogY3JlYXRlUGF1c2UoY2hpbGRBYm9ydENvbnRyb2xsZXIuc2lnbmFsKSwKICAgICAgICBkZWxheTogY3JlYXRlRGVsYXkoY2hpbGRBYm9ydENvbnRyb2xsZXIuc2lnbmFsKSwKICAgICAgICBzaWduYWw6IGNoaWxkQWJvcnRDb250cm9sbGVyLnNpZ25hbAogICAgICB9KTsKICAgICAgdmFsaWRhdGVBY3RpdmUoY2hpbGRBYm9ydENvbnRyb2xsZXIuc2lnbmFsKTsKICAgICAgcmV0dXJuIHJlc3VsdDI7CiAgICB9LCAoKSA9PiBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGNoaWxkQWJvcnRDb250cm9sbGVyLCB0YXNrQ29tcGxldGVkKSk7CiAgICBpZiAob3B0cz8uYXV0b0pvaW4pIHsKICAgICAgcGFyZW50QmxvY2tpbmdQcm9taXNlcy5wdXNoKHJlc3VsdC5jYXRjaChub29wMjIpKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgIHJlc3VsdDogY3JlYXRlUGF1c2UocGFyZW50QWJvcnRTaWduYWwpKHJlc3VsdCksCiAgICAgIGNhbmNlbCgpIHsKICAgICAgICBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGNoaWxkQWJvcnRDb250cm9sbGVyLCB0YXNrQ2FuY2VsbGVkKTsKICAgICAgfQogICAgfTsKICB9Owp9Owp2YXIgY3JlYXRlVGFrZVBhdHRlcm4gPSAoc3RhcnRMaXN0ZW5pbmcsIHNpZ25hbCkgPT4gewogIGNvbnN0IHRha2UgPSBhc3luYyAocHJlZGljYXRlLCB0aW1lb3V0KSA9PiB7CiAgICB2YWxpZGF0ZUFjdGl2ZShzaWduYWwpOwogICAgbGV0IHVuc3Vic2NyaWJlID0gKCkgPT4gewogICAgfTsKICAgIGNvbnN0IHR1cGxlUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgbGV0IHN0b3BMaXN0ZW5pbmcgPSBzdGFydExpc3RlbmluZyh7CiAgICAgICAgcHJlZGljYXRlLAogICAgICAgIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgICAgICAgIGxpc3RlbmVyQXBpLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICByZXNvbHZlKFthY3Rpb24sIGxpc3RlbmVyQXBpLmdldFN0YXRlKCksIGxpc3RlbmVyQXBpLmdldE9yaWdpbmFsU3RhdGUoKV0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHVuc3Vic2NyaWJlID0gKCkgPT4gewogICAgICAgIHN0b3BMaXN0ZW5pbmcoKTsKICAgICAgICByZWplY3QoKTsKICAgICAgfTsKICAgIH0pOwogICAgY29uc3QgcHJvbWlzZXMgPSBbdHVwbGVQcm9taXNlXTsKICAgIGlmICh0aW1lb3V0ICE9IG51bGwpIHsKICAgICAgcHJvbWlzZXMucHVzaChuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCB0aW1lb3V0LCBudWxsKSkpOwogICAgfQogICAgdHJ5IHsKICAgICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgcmFjZVdpdGhTaWduYWwoc2lnbmFsLCBQcm9taXNlLnJhY2UocHJvbWlzZXMpKTsKICAgICAgdmFsaWRhdGVBY3RpdmUoc2lnbmFsKTsKICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0gZmluYWxseSB7CiAgICAgIHVuc3Vic2NyaWJlKCk7CiAgICB9CiAgfTsKICByZXR1cm4gKHByZWRpY2F0ZSwgdGltZW91dCkgPT4gY2F0Y2hSZWplY3Rpb24odGFrZShwcmVkaWNhdGUsIHRpbWVvdXQpKTsKfTsKdmFyIGdldExpc3RlbmVyRW50cnlQcm9wc0Zyb20gPSAob3B0aW9ucykgPT4gewogIGxldCB7CiAgICB0eXBlLAogICAgYWN0aW9uQ3JlYXRvciwKICAgIG1hdGNoZXIsCiAgICBwcmVkaWNhdGUsCiAgICBlZmZlY3QKICB9ID0gb3B0aW9uczsKICBpZiAodHlwZSkgewogICAgcHJlZGljYXRlID0gY3JlYXRlQWN0aW9uKHR5cGUpLm1hdGNoOwogIH0gZWxzZSBpZiAoYWN0aW9uQ3JlYXRvcikgewogICAgdHlwZSA9IGFjdGlvbkNyZWF0b3IudHlwZTsKICAgIHByZWRpY2F0ZSA9IGFjdGlvbkNyZWF0b3IubWF0Y2g7CiAgfSBlbHNlIGlmIChtYXRjaGVyKSB7CiAgICBwcmVkaWNhdGUgPSBtYXRjaGVyOwogIH0gZWxzZSBpZiAocHJlZGljYXRlKSB7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjEpIDogIkNyZWF0aW5nIG9yIHJlbW92aW5nIGEgbGlzdGVuZXIgcmVxdWlyZXMgb25lIG9mIHRoZSBrbm93biBmaWVsZHMgZm9yIG1hdGNoaW5nIGFuIGFjdGlvbiIpOwogIH0KICBhc3NlcnRGdW5jdGlvbihlZmZlY3QsICJvcHRpb25zLmxpc3RlbmVyIik7CiAgcmV0dXJuIHsKICAgIHByZWRpY2F0ZSwKICAgIHR5cGUsCiAgICBlZmZlY3QKICB9Owp9Owp2YXIgY3JlYXRlTGlzdGVuZXJFbnRyeSA9IC8qIEBfX1BVUkVfXyAqLyBhc3NpZ24oKG9wdGlvbnMpID0+IHsKICBjb25zdCB7CiAgICB0eXBlLAogICAgcHJlZGljYXRlLAogICAgZWZmZWN0CiAgfSA9IGdldExpc3RlbmVyRW50cnlQcm9wc0Zyb20ob3B0aW9ucyk7CiAgY29uc3QgZW50cnkgPSB7CiAgICBpZDogbmFub2lkKCksCiAgICBlZmZlY3QsCiAgICB0eXBlLAogICAgcHJlZGljYXRlLAogICAgcGVuZGluZzogLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSwKICAgIHVuc3Vic2NyaWJlOiAoKSA9PiB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjIpIDogIlVuc3Vic2NyaWJlIG5vdCBpbml0aWFsaXplZCIpOwogICAgfQogIH07CiAgcmV0dXJuIGVudHJ5Owp9LCB7CiAgd2l0aFR5cGVzOiAoKSA9PiBjcmVhdGVMaXN0ZW5lckVudHJ5Cn0pOwp2YXIgZmluZExpc3RlbmVyRW50cnkgPSAobGlzdGVuZXJNYXAsIG9wdGlvbnMpID0+IHsKICBjb25zdCB7CiAgICB0eXBlLAogICAgZWZmZWN0LAogICAgcHJlZGljYXRlCiAgfSA9IGdldExpc3RlbmVyRW50cnlQcm9wc0Zyb20ob3B0aW9ucyk7CiAgcmV0dXJuIEFycmF5LmZyb20obGlzdGVuZXJNYXAudmFsdWVzKCkpLmZpbmQoKGVudHJ5KSA9PiB7CiAgICBjb25zdCBtYXRjaFByZWRpY2F0ZU9yVHlwZSA9IHR5cGVvZiB0eXBlID09PSAic3RyaW5nIiA/IGVudHJ5LnR5cGUgPT09IHR5cGUgOiBlbnRyeS5wcmVkaWNhdGUgPT09IHByZWRpY2F0ZTsKICAgIHJldHVybiBtYXRjaFByZWRpY2F0ZU9yVHlwZSAmJiBlbnRyeS5lZmZlY3QgPT09IGVmZmVjdDsKICB9KTsKfTsKdmFyIGNhbmNlbEFjdGl2ZUxpc3RlbmVycyA9IChlbnRyeSkgPT4gewogIGVudHJ5LnBlbmRpbmcuZm9yRWFjaCgoY29udHJvbGxlcikgPT4gewogICAgYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihjb250cm9sbGVyLCBsaXN0ZW5lckNhbmNlbGxlZCk7CiAgfSk7Cn07CnZhciBjcmVhdGVDbGVhckxpc3RlbmVyTWlkZGxld2FyZSA9IChsaXN0ZW5lck1hcCwgZXhlY3V0aW5nTGlzdGVuZXJzKSA9PiB7CiAgcmV0dXJuICgpID0+IHsKICAgIGZvciAoY29uc3QgbGlzdGVuZXIyIG9mIGV4ZWN1dGluZ0xpc3RlbmVycy5rZXlzKCkpIHsKICAgICAgY2FuY2VsQWN0aXZlTGlzdGVuZXJzKGxpc3RlbmVyMik7CiAgICB9CiAgICBsaXN0ZW5lck1hcC5jbGVhcigpOwogIH07Cn07CnZhciBzYWZlbHlOb3RpZnlFcnJvciA9IChlcnJvckhhbmRsZXIsIGVycm9yVG9Ob3RpZnksIGVycm9ySW5mbykgPT4gewogIHRyeSB7CiAgICBlcnJvckhhbmRsZXIoZXJyb3JUb05vdGlmeSwgZXJyb3JJbmZvKTsKICB9IGNhdGNoIChlcnJvckhhbmRsZXJFcnJvcikgewogICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgIHRocm93IGVycm9ySGFuZGxlckVycm9yOwogICAgfSwgMCk7CiAgfQp9Owp2YXIgYWRkTGlzdGVuZXIgPSAvKiBAX19QVVJFX18gKi8gYXNzaWduKC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVBY3Rpb24oYCR7YWxtfS9hZGRgKSwgewogIHdpdGhUeXBlczogKCkgPT4gYWRkTGlzdGVuZXIKfSk7CnZhciBjbGVhckFsbExpc3RlbmVycyA9IC8qIEBfX1BVUkVfXyAqLyBjcmVhdGVBY3Rpb24oYCR7YWxtfS9yZW1vdmVBbGxgKTsKdmFyIHJlbW92ZUxpc3RlbmVyID0gLyogQF9fUFVSRV9fICovIGFzc2lnbigvKiBAX19QVVJFX18gKi8gY3JlYXRlQWN0aW9uKGAke2FsbX0vcmVtb3ZlYCksIHsKICB3aXRoVHlwZXM6ICgpID0+IHJlbW92ZUxpc3RlbmVyCn0pOwp2YXIgZGVmYXVsdEVycm9ySGFuZGxlciA9ICguLi5hcmdzKSA9PiB7CiAgY29uc29sZS5lcnJvcihgJHthbG19L2Vycm9yYCwgLi4uYXJncyk7Cn07CnZhciBjcmVhdGVMaXN0ZW5lck1pZGRsZXdhcmUgPSAobWlkZGxld2FyZU9wdGlvbnMgPSB7fSkgPT4gewogIGNvbnN0IGxpc3RlbmVyTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBjb25zdCBleGVjdXRpbmdMaXN0ZW5lcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGNvbnN0IHRyYWNrRXhlY3V0aW5nTGlzdGVuZXIgPSAoZW50cnkpID0+IHsKICAgIGNvbnN0IGNvdW50ID0gZXhlY3V0aW5nTGlzdGVuZXJzLmdldChlbnRyeSkgPz8gMDsKICAgIGV4ZWN1dGluZ0xpc3RlbmVycy5zZXQoZW50cnksIGNvdW50ICsgMSk7CiAgfTsKICBjb25zdCB1bnRyYWNrRXhlY3V0aW5nTGlzdGVuZXIgPSAoZW50cnkpID0+IHsKICAgIGNvbnN0IGNvdW50ID0gZXhlY3V0aW5nTGlzdGVuZXJzLmdldChlbnRyeSkgPz8gMTsKICAgIGlmIChjb3VudCA9PT0gMSkgewogICAgICBleGVjdXRpbmdMaXN0ZW5lcnMuZGVsZXRlKGVudHJ5KTsKICAgIH0gZWxzZSB7CiAgICAgIGV4ZWN1dGluZ0xpc3RlbmVycy5zZXQoZW50cnksIGNvdW50IC0gMSk7CiAgICB9CiAgfTsKICBjb25zdCB7CiAgICBleHRyYSwKICAgIG9uRXJyb3IgPSBkZWZhdWx0RXJyb3JIYW5kbGVyCiAgfSA9IG1pZGRsZXdhcmVPcHRpb25zOwogIGFzc2VydEZ1bmN0aW9uKG9uRXJyb3IsICJvbkVycm9yIik7CiAgY29uc3QgaW5zZXJ0RW50cnkgPSAoZW50cnkpID0+IHsKICAgIGVudHJ5LnVuc3Vic2NyaWJlID0gKCkgPT4gbGlzdGVuZXJNYXAuZGVsZXRlKGVudHJ5LmlkKTsKICAgIGxpc3RlbmVyTWFwLnNldChlbnRyeS5pZCwgZW50cnkpOwogICAgcmV0dXJuIChjYW5jZWxPcHRpb25zKSA9PiB7CiAgICAgIGVudHJ5LnVuc3Vic2NyaWJlKCk7CiAgICAgIGlmIChjYW5jZWxPcHRpb25zPy5jYW5jZWxBY3RpdmUpIHsKICAgICAgICBjYW5jZWxBY3RpdmVMaXN0ZW5lcnMoZW50cnkpOwogICAgICB9CiAgICB9OwogIH07CiAgY29uc3Qgc3RhcnRMaXN0ZW5pbmcgPSAob3B0aW9ucykgPT4gewogICAgY29uc3QgZW50cnkgPSBmaW5kTGlzdGVuZXJFbnRyeShsaXN0ZW5lck1hcCwgb3B0aW9ucykgPz8gY3JlYXRlTGlzdGVuZXJFbnRyeShvcHRpb25zKTsKICAgIHJldHVybiBpbnNlcnRFbnRyeShlbnRyeSk7CiAgfTsKICBhc3NpZ24oc3RhcnRMaXN0ZW5pbmcsIHsKICAgIHdpdGhUeXBlczogKCkgPT4gc3RhcnRMaXN0ZW5pbmcKICB9KTsKICBjb25zdCBzdG9wTGlzdGVuaW5nID0gKG9wdGlvbnMpID0+IHsKICAgIGNvbnN0IGVudHJ5ID0gZmluZExpc3RlbmVyRW50cnkobGlzdGVuZXJNYXAsIG9wdGlvbnMpOwogICAgaWYgKGVudHJ5KSB7CiAgICAgIGVudHJ5LnVuc3Vic2NyaWJlKCk7CiAgICAgIGlmIChvcHRpb25zLmNhbmNlbEFjdGl2ZSkgewogICAgICAgIGNhbmNlbEFjdGl2ZUxpc3RlbmVycyhlbnRyeSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiAhIWVudHJ5OwogIH07CiAgYXNzaWduKHN0b3BMaXN0ZW5pbmcsIHsKICAgIHdpdGhUeXBlczogKCkgPT4gc3RvcExpc3RlbmluZwogIH0pOwogIGNvbnN0IG5vdGlmeUxpc3RlbmVyID0gYXN5bmMgKGVudHJ5LCBhY3Rpb24sIGFwaSwgZ2V0T3JpZ2luYWxTdGF0ZSkgPT4gewogICAgY29uc3QgaW50ZXJuYWxUYXNrQ29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTsKICAgIGNvbnN0IHRha2UgPSBjcmVhdGVUYWtlUGF0dGVybihzdGFydExpc3RlbmluZywgaW50ZXJuYWxUYXNrQ29udHJvbGxlci5zaWduYWwpOwogICAgY29uc3QgYXV0b0pvaW5Qcm9taXNlcyA9IFtdOwogICAgdHJ5IHsKICAgICAgZW50cnkucGVuZGluZy5hZGQoaW50ZXJuYWxUYXNrQ29udHJvbGxlcik7CiAgICAgIHRyYWNrRXhlY3V0aW5nTGlzdGVuZXIoZW50cnkpOwogICAgICBhd2FpdCBQcm9taXNlLnJlc29sdmUoZW50cnkuZWZmZWN0KAogICAgICAgIGFjdGlvbiwKICAgICAgICAvLyBVc2UgYXNzaWduKCkgcmF0aGVyIHRoYW4gLi4uIHRvIGF2b2lkIGV4dHJhIGhlbHBlciBmdW5jdGlvbnMgYWRkZWQgdG8gYnVuZGxlCiAgICAgICAgYXNzaWduKHt9LCBhcGksIHsKICAgICAgICAgIGdldE9yaWdpbmFsU3RhdGUsCiAgICAgICAgICBjb25kaXRpb246IChwcmVkaWNhdGUsIHRpbWVvdXQpID0+IHRha2UocHJlZGljYXRlLCB0aW1lb3V0KS50aGVuKEJvb2xlYW4pLAogICAgICAgICAgdGFrZSwKICAgICAgICAgIGRlbGF5OiBjcmVhdGVEZWxheShpbnRlcm5hbFRhc2tDb250cm9sbGVyLnNpZ25hbCksCiAgICAgICAgICBwYXVzZTogY3JlYXRlUGF1c2UoaW50ZXJuYWxUYXNrQ29udHJvbGxlci5zaWduYWwpLAogICAgICAgICAgZXh0cmEsCiAgICAgICAgICBzaWduYWw6IGludGVybmFsVGFza0NvbnRyb2xsZXIuc2lnbmFsLAogICAgICAgICAgZm9yazogY3JlYXRlRm9yayhpbnRlcm5hbFRhc2tDb250cm9sbGVyLnNpZ25hbCwgYXV0b0pvaW5Qcm9taXNlcyksCiAgICAgICAgICB1bnN1YnNjcmliZTogZW50cnkudW5zdWJzY3JpYmUsCiAgICAgICAgICBzdWJzY3JpYmU6ICgpID0+IHsKICAgICAgICAgICAgbGlzdGVuZXJNYXAuc2V0KGVudHJ5LmlkLCBlbnRyeSk7CiAgICAgICAgICB9LAogICAgICAgICAgY2FuY2VsQWN0aXZlTGlzdGVuZXJzOiAoKSA9PiB7CiAgICAgICAgICAgIGVudHJ5LnBlbmRpbmcuZm9yRWFjaCgoY29udHJvbGxlciwgXywgc2V0MykgPT4gewogICAgICAgICAgICAgIGlmIChjb250cm9sbGVyICE9PSBpbnRlcm5hbFRhc2tDb250cm9sbGVyKSB7CiAgICAgICAgICAgICAgICBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGNvbnRyb2xsZXIsIGxpc3RlbmVyQ2FuY2VsbGVkKTsKICAgICAgICAgICAgICAgIHNldDMuZGVsZXRlKGNvbnRyb2xsZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgY2FuY2VsOiAoKSA9PiB7CiAgICAgICAgICAgIGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24oaW50ZXJuYWxUYXNrQ29udHJvbGxlciwgbGlzdGVuZXJDYW5jZWxsZWQpOwogICAgICAgICAgICBlbnRyeS5wZW5kaW5nLmRlbGV0ZShpbnRlcm5hbFRhc2tDb250cm9sbGVyKTsKICAgICAgICAgIH0sCiAgICAgICAgICB0aHJvd0lmQ2FuY2VsbGVkOiAoKSA9PiB7CiAgICAgICAgICAgIHZhbGlkYXRlQWN0aXZlKGludGVybmFsVGFza0NvbnRyb2xsZXIuc2lnbmFsKTsKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICApKTsKICAgIH0gY2F0Y2ggKGxpc3RlbmVyRXJyb3IpIHsKICAgICAgaWYgKCEobGlzdGVuZXJFcnJvciBpbnN0YW5jZW9mIFRhc2tBYm9ydEVycm9yKSkgewogICAgICAgIHNhZmVseU5vdGlmeUVycm9yKG9uRXJyb3IsIGxpc3RlbmVyRXJyb3IsIHsKICAgICAgICAgIHJhaXNlZEJ5OiAiZWZmZWN0IgogICAgICAgIH0pOwogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICBhd2FpdCBQcm9taXNlLmFsbChhdXRvSm9pblByb21pc2VzKTsKICAgICAgYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihpbnRlcm5hbFRhc2tDb250cm9sbGVyLCBsaXN0ZW5lckNvbXBsZXRlZCk7CiAgICAgIHVudHJhY2tFeGVjdXRpbmdMaXN0ZW5lcihlbnRyeSk7CiAgICAgIGVudHJ5LnBlbmRpbmcuZGVsZXRlKGludGVybmFsVGFza0NvbnRyb2xsZXIpOwogICAgfQogIH07CiAgY29uc3QgY2xlYXJMaXN0ZW5lck1pZGRsZXdhcmUgPSBjcmVhdGVDbGVhckxpc3RlbmVyTWlkZGxld2FyZShsaXN0ZW5lck1hcCwgZXhlY3V0aW5nTGlzdGVuZXJzKTsKICBjb25zdCBtaWRkbGV3YXJlID0gKGFwaSkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IHsKICAgIGlmICghaXNBY3Rpb24oYWN0aW9uKSkgewogICAgICByZXR1cm4gbmV4dChhY3Rpb24pOwogICAgfQogICAgaWYgKGFkZExpc3RlbmVyLm1hdGNoKGFjdGlvbikpIHsKICAgICAgcmV0dXJuIHN0YXJ0TGlzdGVuaW5nKGFjdGlvbi5wYXlsb2FkKTsKICAgIH0KICAgIGlmIChjbGVhckFsbExpc3RlbmVycy5tYXRjaChhY3Rpb24pKSB7CiAgICAgIGNsZWFyTGlzdGVuZXJNaWRkbGV3YXJlKCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChyZW1vdmVMaXN0ZW5lci5tYXRjaChhY3Rpb24pKSB7CiAgICAgIHJldHVybiBzdG9wTGlzdGVuaW5nKGFjdGlvbi5wYXlsb2FkKTsKICAgIH0KICAgIGxldCBvcmlnaW5hbFN0YXRlID0gYXBpLmdldFN0YXRlKCk7CiAgICBjb25zdCBnZXRPcmlnaW5hbFN0YXRlID0gKCkgPT4gewogICAgICBpZiAob3JpZ2luYWxTdGF0ZSA9PT0gSU5URVJOQUxfTklMX1RPS0VOKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyMykgOiBgJHthbG19OiBnZXRPcmlnaW5hbFN0YXRlIGNhbiBvbmx5IGJlIGNhbGxlZCBzeW5jaHJvbm91c2x5YCk7CiAgICAgIH0KICAgICAgcmV0dXJuIG9yaWdpbmFsU3RhdGU7CiAgICB9OwogICAgbGV0IHJlc3VsdDsKICAgIHRyeSB7CiAgICAgIHJlc3VsdCA9IG5leHQoYWN0aW9uKTsKICAgICAgaWYgKGxpc3RlbmVyTWFwLnNpemUgPiAwKSB7CiAgICAgICAgY29uc3QgY3VycmVudFN0YXRlID0gYXBpLmdldFN0YXRlKCk7CiAgICAgICAgY29uc3QgbGlzdGVuZXJFbnRyaWVzID0gQXJyYXkuZnJvbShsaXN0ZW5lck1hcC52YWx1ZXMoKSk7CiAgICAgICAgZm9yIChjb25zdCBlbnRyeSBvZiBsaXN0ZW5lckVudHJpZXMpIHsKICAgICAgICAgIGxldCBydW5MaXN0ZW5lciA9IGZhbHNlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcnVuTGlzdGVuZXIgPSBlbnRyeS5wcmVkaWNhdGUoYWN0aW9uLCBjdXJyZW50U3RhdGUsIG9yaWdpbmFsU3RhdGUpOwogICAgICAgICAgfSBjYXRjaCAocHJlZGljYXRlRXJyb3IpIHsKICAgICAgICAgICAgcnVuTGlzdGVuZXIgPSBmYWxzZTsKICAgICAgICAgICAgc2FmZWx5Tm90aWZ5RXJyb3Iob25FcnJvciwgcHJlZGljYXRlRXJyb3IsIHsKICAgICAgICAgICAgICByYWlzZWRCeTogInByZWRpY2F0ZSIKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXJ1bkxpc3RlbmVyKSB7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQogICAgICAgICAgbm90aWZ5TGlzdGVuZXIoZW50cnksIGFjdGlvbiwgYXBpLCBnZXRPcmlnaW5hbFN0YXRlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIG9yaWdpbmFsU3RhdGUgPSBJTlRFUk5BTF9OSUxfVE9LRU47CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CiAgcmV0dXJuIHsKICAgIG1pZGRsZXdhcmUsCiAgICBzdGFydExpc3RlbmluZywKICAgIHN0b3BMaXN0ZW5pbmcsCiAgICBjbGVhckxpc3RlbmVyczogY2xlYXJMaXN0ZW5lck1pZGRsZXdhcmUKICB9Owp9Owp2YXIgT1JJR0lOQUxfU1RBVEUgPSBTeW1ib2wuZm9yKCJydGstc3RhdGUtcHJveHktb3JpZ2luYWwiKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvbGF5b3V0U2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZSA9IHsKICBsYXlvdXRUeXBlOiAiaG9yaXpvbnRhbCIsCiAgd2lkdGg6IDAsCiAgaGVpZ2h0OiAwLAogIG1hcmdpbjogewogICAgdG9wOiA1LAogICAgcmlnaHQ6IDUsCiAgICBib3R0b206IDUsCiAgICBsZWZ0OiA1CiAgfSwKICBzY2FsZTogMQp9Owp2YXIgY2hhcnRMYXlvdXRTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiY2hhcnRMYXlvdXQiLAogIGluaXRpYWxTdGF0ZSwKICByZWR1Y2VyczogewogICAgc2V0TGF5b3V0KHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUubGF5b3V0VHlwZSA9IGFjdGlvbi5wYXlsb2FkOwogICAgfSwKICAgIHNldENoYXJ0U2l6ZShzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLndpZHRoID0gYWN0aW9uLnBheWxvYWQud2lkdGg7CiAgICAgIHN0YXRlLmhlaWdodCA9IGFjdGlvbi5wYXlsb2FkLmhlaWdodDsKICAgIH0sCiAgICBzZXRNYXJnaW4oc3RhdGUsIGFjdGlvbikgewogICAgICB2YXIgX2FjdGlvbiRwYXlsb2FkJHRvcCwgX2FjdGlvbiRwYXlsb2FkJHJpZ2h0LCBfYWN0aW9uJHBheWxvYWQkYm90dG8sIF9hY3Rpb24kcGF5bG9hZCRsZWZ0OwogICAgICBzdGF0ZS5tYXJnaW4udG9wID0gKF9hY3Rpb24kcGF5bG9hZCR0b3AgPSBhY3Rpb24ucGF5bG9hZC50b3ApICE9PSBudWxsICYmIF9hY3Rpb24kcGF5bG9hZCR0b3AgIT09IHZvaWQgMCA/IF9hY3Rpb24kcGF5bG9hZCR0b3AgOiAwOwogICAgICBzdGF0ZS5tYXJnaW4ucmlnaHQgPSAoX2FjdGlvbiRwYXlsb2FkJHJpZ2h0ID0gYWN0aW9uLnBheWxvYWQucmlnaHQpICE9PSBudWxsICYmIF9hY3Rpb24kcGF5bG9hZCRyaWdodCAhPT0gdm9pZCAwID8gX2FjdGlvbiRwYXlsb2FkJHJpZ2h0IDogMDsKICAgICAgc3RhdGUubWFyZ2luLmJvdHRvbSA9IChfYWN0aW9uJHBheWxvYWQkYm90dG8gPSBhY3Rpb24ucGF5bG9hZC5ib3R0b20pICE9PSBudWxsICYmIF9hY3Rpb24kcGF5bG9hZCRib3R0byAhPT0gdm9pZCAwID8gX2FjdGlvbiRwYXlsb2FkJGJvdHRvIDogMDsKICAgICAgc3RhdGUubWFyZ2luLmxlZnQgPSAoX2FjdGlvbiRwYXlsb2FkJGxlZnQgPSBhY3Rpb24ucGF5bG9hZC5sZWZ0KSAhPT0gbnVsbCAmJiBfYWN0aW9uJHBheWxvYWQkbGVmdCAhPT0gdm9pZCAwID8gX2FjdGlvbiRwYXlsb2FkJGxlZnQgOiAwOwogICAgfSwKICAgIHNldFNjYWxlKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc2NhbGUgPSBhY3Rpb24ucGF5bG9hZDsKICAgIH0KICB9Cn0pOwp2YXIgewogIHNldE1hcmdpbiwKICBzZXRMYXlvdXQsCiAgc2V0Q2hhcnRTaXplLAogIHNldFNjYWxlCn0gPSBjaGFydExheW91dFNsaWNlLmFjdGlvbnM7CnZhciBjaGFydExheW91dFJlZHVjZXIgPSBjaGFydExheW91dFNsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvQ2hhcnRVdGlscy5qcwp2YXIgaW1wb3J0X3NvcnRCeTIgPSBfX3RvRVNNKHJlcXVpcmVfc29ydEJ5MigpKTsKdmFyIGltcG9ydF9nZXQyID0gX190b0VTTShyZXF1aXJlX2dldDIoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZ2V0U2xpY2VkLmpzCmZ1bmN0aW9uIGdldFNsaWNlZChhcnIsIHN0YXJ0SW5kZXgsIGVuZEluZGV4KSB7CiAgaWYgKCFBcnJheS5pc0FycmF5KGFycikpIHsKICAgIHJldHVybiBhcnI7CiAgfQogIGlmIChhcnIgJiYgc3RhcnRJbmRleCArIGVuZEluZGV4ICE9PSAwKSB7CiAgICByZXR1cm4gYXJyLnNsaWNlKHN0YXJ0SW5kZXgsIGVuZEluZGV4ICsgMSk7CiAgfQogIHJldHVybiBhcnI7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9DaGFydFV0aWxzLmpzCmZ1bmN0aW9uIG93bktleXMyKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czIoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTIoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTIocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5Mih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTIodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIGdldFZhbHVlQnlEYXRhS2V5KG9iaiwgZGF0YUtleSwgZGVmYXVsdFZhbHVlKSB7CiAgaWYgKGlzTnVsbGlzaChvYmopIHx8IGlzTnVsbGlzaChkYXRhS2V5KSkgewogICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICB9CiAgaWYgKGlzTnVtT3JTdHIoZGF0YUtleSkpIHsKICAgIHJldHVybiAoMCwgaW1wb3J0X2dldDIuZGVmYXVsdCkob2JqLCBkYXRhS2V5LCBkZWZhdWx0VmFsdWUpOwogIH0KICBpZiAodHlwZW9mIGRhdGFLZXkgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBkYXRhS2V5KG9iaik7CiAgfQogIHJldHVybiBkZWZhdWx0VmFsdWU7Cn0KdmFyIGFwcGVuZE9mZnNldE9mTGVnZW5kID0gKG9mZnNldCwgbGVnZW5kU2V0dGluZ3MsIGxlZ2VuZFNpemUpID0+IHsKICBpZiAobGVnZW5kU2V0dGluZ3MgJiYgbGVnZW5kU2l6ZSkgewogICAgdmFyIHsKICAgICAgd2lkdGg6IGJveFdpZHRoLAogICAgICBoZWlnaHQ6IGJveEhlaWdodAogICAgfSA9IGxlZ2VuZFNpemU7CiAgICB2YXIgewogICAgICBhbGlnbiwKICAgICAgdmVydGljYWxBbGlnbiwKICAgICAgbGF5b3V0CiAgICB9ID0gbGVnZW5kU2V0dGluZ3M7CiAgICBpZiAoKGxheW91dCA9PT0gInZlcnRpY2FsIiB8fCBsYXlvdXQgPT09ICJob3Jpem9udGFsIiAmJiB2ZXJ0aWNhbEFsaWduID09PSAibWlkZGxlIikgJiYgYWxpZ24gIT09ICJjZW50ZXIiICYmIGlzTnVtYmVyKG9mZnNldFthbGlnbl0pKSB7CiAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMihfb2JqZWN0U3ByZWFkMih7fSwgb2Zmc2V0KSwge30sIHsKICAgICAgICBbYWxpZ25dOiBvZmZzZXRbYWxpZ25dICsgKGJveFdpZHRoIHx8IDApCiAgICAgIH0pOwogICAgfQogICAgaWYgKChsYXlvdXQgPT09ICJob3Jpem9udGFsIiB8fCBsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIgJiYgYWxpZ24gPT09ICJjZW50ZXIiKSAmJiB2ZXJ0aWNhbEFsaWduICE9PSAibWlkZGxlIiAmJiBpc051bWJlcihvZmZzZXRbdmVydGljYWxBbGlnbl0pKSB7CiAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMihfb2JqZWN0U3ByZWFkMih7fSwgb2Zmc2V0KSwge30sIHsKICAgICAgICBbdmVydGljYWxBbGlnbl06IG9mZnNldFt2ZXJ0aWNhbEFsaWduXSArIChib3hIZWlnaHQgfHwgMCkKICAgICAgfSk7CiAgICB9CiAgfQogIHJldHVybiBvZmZzZXQ7Cn07CnZhciBpc0NhdGVnb3JpY2FsQXhpcyA9IChsYXlvdXQsIGF4aXNUeXBlKSA9PiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiAmJiBheGlzVHlwZSA9PT0gInhBeGlzIiB8fCBsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIgJiYgYXhpc1R5cGUgPT09ICJ5QXhpcyIgfHwgbGF5b3V0ID09PSAiY2VudHJpYyIgJiYgYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiIHx8IGxheW91dCA9PT0gInJhZGlhbCIgJiYgYXhpc1R5cGUgPT09ICJyYWRpdXNBeGlzIjsKdmFyIGdldENvb3JkaW5hdGVzT2ZHcmlkID0gKHRpY2tzMiwgbWluVmFsdWUsIG1heFZhbHVlLCBzeW5jV2l0aFRpY2tzKSA9PiB7CiAgaWYgKHN5bmNXaXRoVGlja3MpIHsKICAgIHJldHVybiB0aWNrczIubWFwKChlbnRyeSkgPT4gZW50cnkuY29vcmRpbmF0ZSk7CiAgfQogIHZhciBoYXNNaW4sIGhhc01heDsKICB2YXIgdmFsdWVzID0gdGlja3MyLm1hcCgoZW50cnkpID0+IHsKICAgIGlmIChlbnRyeS5jb29yZGluYXRlID09PSBtaW5WYWx1ZSkgewogICAgICBoYXNNaW4gPSB0cnVlOwogICAgfQogICAgaWYgKGVudHJ5LmNvb3JkaW5hdGUgPT09IG1heFZhbHVlKSB7CiAgICAgIGhhc01heCA9IHRydWU7CiAgICB9CiAgICByZXR1cm4gZW50cnkuY29vcmRpbmF0ZTsKICB9KTsKICBpZiAoIWhhc01pbikgewogICAgdmFsdWVzLnB1c2gobWluVmFsdWUpOwogIH0KICBpZiAoIWhhc01heCkgewogICAgdmFsdWVzLnB1c2gobWF4VmFsdWUpOwogIH0KICByZXR1cm4gdmFsdWVzOwp9Owp2YXIgZ2V0VGlja3NPZkF4aXMgPSAoYXhpcywgaXNHcmlkLCBpc0FsbCkgPT4gewogIGlmICghYXhpcykgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBkdXBsaWNhdGVEb21haW4sCiAgICB0eXBlLAogICAgcmFuZ2U6IHJhbmdlNCwKICAgIHNjYWxlLAogICAgcmVhbFNjYWxlVHlwZSwKICAgIGlzQ2F0ZWdvcmljYWwsCiAgICBjYXRlZ29yaWNhbERvbWFpbiwKICAgIHRpY2tDb3VudCwKICAgIHRpY2tzOiB0aWNrczIsCiAgICBuaWNlVGlja3MsCiAgICBheGlzVHlwZQogIH0gPSBheGlzOwogIGlmICghc2NhbGUpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgb2Zmc2V0Rm9yQmFuZCA9IHJlYWxTY2FsZVR5cGUgPT09ICJzY2FsZUJhbmQiICYmIHNjYWxlLmJhbmR3aWR0aCA/IHNjYWxlLmJhbmR3aWR0aCgpIC8gMiA6IDI7CiAgdmFyIG9mZnNldCA9IChpc0dyaWQgfHwgaXNBbGwpICYmIHR5cGUgPT09ICJjYXRlZ29yeSIgJiYgc2NhbGUuYmFuZHdpZHRoID8gc2NhbGUuYmFuZHdpZHRoKCkgLyBvZmZzZXRGb3JCYW5kIDogMDsKICBvZmZzZXQgPSBheGlzVHlwZSA9PT0gImFuZ2xlQXhpcyIgJiYgcmFuZ2U0ICYmIHJhbmdlNC5sZW5ndGggPj0gMiA/IG1hdGhTaWduKHJhbmdlNFswXSAtIHJhbmdlNFsxXSkgKiAyICogb2Zmc2V0IDogb2Zmc2V0OwogIGlmIChpc0dyaWQgJiYgKHRpY2tzMiB8fCBuaWNlVGlja3MpKSB7CiAgICB2YXIgcmVzdWx0ID0gKHRpY2tzMiB8fCBuaWNlVGlja3MgfHwgW10pLm1hcCgoZW50cnksIGluZGV4KSA9PiB7CiAgICAgIHZhciBzY2FsZUNvbnRlbnQgPSBkdXBsaWNhdGVEb21haW4gPyBkdXBsaWNhdGVEb21haW4uaW5kZXhPZihlbnRyeSkgOiBlbnRyeTsKICAgICAgcmV0dXJuIHsKICAgICAgICAvLyBJZiB0aGUgc2NhbGVDb250ZW50IGlzIG5vdCBhIG51bWJlciwgdGhlIGNvb3JkaW5hdGUgd2lsbCBiZSBOYU4uCiAgICAgICAgLy8gVGhhdCBjb3VsZCBiZSB0aGUgY2FzZSBmb3IgZXhhbXBsZSB3aXRoIGEgUG9pbnRTY2FsZSBhbmQgYSBzdHJpbmcgYXMgZG9tYWluLgogICAgICAgIGNvb3JkaW5hdGU6IHNjYWxlKHNjYWxlQ29udGVudCkgKyBvZmZzZXQsCiAgICAgICAgdmFsdWU6IGVudHJ5LAogICAgICAgIG9mZnNldCwKICAgICAgICBpbmRleAogICAgICB9OwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0LmZpbHRlcigocm93KSA9PiAhaXNOYW4ocm93LmNvb3JkaW5hdGUpKTsKICB9CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgY2F0ZWdvcmljYWxEb21haW4pIHsKICAgIHJldHVybiBjYXRlZ29yaWNhbERvbWFpbi5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIGluZGV4LAogICAgICBvZmZzZXQKICAgIH0pKTsKICB9CiAgaWYgKHNjYWxlLnRpY2tzICYmICFpc0FsbCAmJiB0aWNrQ291bnQgIT0gbnVsbCkgewogICAgcmV0dXJuIHNjYWxlLnRpY2tzKHRpY2tDb3VudCkubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgICAgdmFsdWU6IGVudHJ5LAogICAgICBvZmZzZXQsCiAgICAgIGluZGV4CiAgICB9KSk7CiAgfQogIHJldHVybiBzY2FsZS5kb21haW4oKS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgIHZhbHVlOiBkdXBsaWNhdGVEb21haW4gPyBkdXBsaWNhdGVEb21haW5bZW50cnldIDogZW50cnksCiAgICBpbmRleCwKICAgIG9mZnNldAogIH0pKTsKfTsKdmFyIEVQUzIgPSAxZS00Owp2YXIgY2hlY2tEb21haW5PZlNjYWxlID0gKHNjYWxlKSA9PiB7CiAgdmFyIGRvbWFpbiA9IHNjYWxlLmRvbWFpbigpOwogIGlmICghZG9tYWluIHx8IGRvbWFpbi5sZW5ndGggPD0gMikgewogICAgcmV0dXJuOwogIH0KICB2YXIgbGVuID0gZG9tYWluLmxlbmd0aDsKICB2YXIgcmFuZ2U0ID0gc2NhbGUucmFuZ2UoKTsKICB2YXIgbWluVmFsdWUgPSBNYXRoLm1pbihyYW5nZTRbMF0sIHJhbmdlNFsxXSkgLSBFUFMyOwogIHZhciBtYXhWYWx1ZSA9IE1hdGgubWF4KHJhbmdlNFswXSwgcmFuZ2U0WzFdKSArIEVQUzI7CiAgdmFyIGZpcnN0ID0gc2NhbGUoZG9tYWluWzBdKTsKICB2YXIgbGFzdDIgPSBzY2FsZShkb21haW5bbGVuIC0gMV0pOwogIGlmIChmaXJzdCA8IG1pblZhbHVlIHx8IGZpcnN0ID4gbWF4VmFsdWUgfHwgbGFzdDIgPCBtaW5WYWx1ZSB8fCBsYXN0MiA+IG1heFZhbHVlKSB7CiAgICBzY2FsZS5kb21haW4oW2RvbWFpblswXSwgZG9tYWluW2xlbiAtIDFdXSk7CiAgfQp9Owp2YXIgb2Zmc2V0U2lnbiA9IChzZXJpZXMpID0+IHsKICB2YXIgbiA9IHNlcmllcy5sZW5ndGg7CiAgaWYgKG4gPD0gMCkgewogICAgcmV0dXJuOwogIH0KICBmb3IgKHZhciBqID0gMCwgbSA9IHNlcmllc1swXS5sZW5ndGg7IGogPCBtOyArK2opIHsKICAgIHZhciBwb3NpdGl2ZSA9IDA7CiAgICB2YXIgbmVnYXRpdmUgPSAwOwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgdmFyIHZhbHVlID0gaXNOYW4oc2VyaWVzW2ldW2pdWzFdKSA/IHNlcmllc1tpXVtqXVswXSA6IHNlcmllc1tpXVtqXVsxXTsKICAgICAgaWYgKHZhbHVlID49IDApIHsKICAgICAgICBzZXJpZXNbaV1bal1bMF0gPSBwb3NpdGl2ZTsKICAgICAgICBzZXJpZXNbaV1bal1bMV0gPSBwb3NpdGl2ZSArIHZhbHVlOwogICAgICAgIHBvc2l0aXZlID0gc2VyaWVzW2ldW2pdWzFdOwogICAgICB9IGVsc2UgewogICAgICAgIHNlcmllc1tpXVtqXVswXSA9IG5lZ2F0aXZlOwogICAgICAgIHNlcmllc1tpXVtqXVsxXSA9IG5lZ2F0aXZlICsgdmFsdWU7CiAgICAgICAgbmVnYXRpdmUgPSBzZXJpZXNbaV1bal1bMV07CiAgICAgIH0KICAgIH0KICB9Cn07CnZhciBvZmZzZXRQb3NpdGl2ZSA9IChzZXJpZXMpID0+IHsKICB2YXIgbiA9IHNlcmllcy5sZW5ndGg7CiAgaWYgKG4gPD0gMCkgewogICAgcmV0dXJuOwogIH0KICBmb3IgKHZhciBqID0gMCwgbSA9IHNlcmllc1swXS5sZW5ndGg7IGogPCBtOyArK2opIHsKICAgIHZhciBwb3NpdGl2ZSA9IDA7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47ICsraSkgewogICAgICB2YXIgdmFsdWUgPSBpc05hbihzZXJpZXNbaV1bal1bMV0pID8gc2VyaWVzW2ldW2pdWzBdIDogc2VyaWVzW2ldW2pdWzFdOwogICAgICBpZiAodmFsdWUgPj0gMCkgewogICAgICAgIHNlcmllc1tpXVtqXVswXSA9IHBvc2l0aXZlOwogICAgICAgIHNlcmllc1tpXVtqXVsxXSA9IHBvc2l0aXZlICsgdmFsdWU7CiAgICAgICAgcG9zaXRpdmUgPSBzZXJpZXNbaV1bal1bMV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VyaWVzW2ldW2pdWzBdID0gMDsKICAgICAgICBzZXJpZXNbaV1bal1bMV0gPSAwOwogICAgICB9CiAgICB9CiAgfQp9Owp2YXIgU1RBQ0tfT0ZGU0VUX01BUCA9IHsKICBzaWduOiBvZmZzZXRTaWduLAogIC8vIEB0cy1leHBlY3QtZXJyb3IgZGVmaW5pdGVseXR5cGVkIHR5cGVzIGFyZSBpbmNvcnJlY3QKICBleHBhbmQ6IGV4cGFuZF9kZWZhdWx0LAogIC8vIEB0cy1leHBlY3QtZXJyb3IgZGVmaW5pdGVseXR5cGVkIHR5cGVzIGFyZSBpbmNvcnJlY3QKICBub25lOiBub25lX2RlZmF1bHQsCiAgLy8gQHRzLWV4cGVjdC1lcnJvciBkZWZpbml0ZWx5dHlwZWQgdHlwZXMgYXJlIGluY29ycmVjdAogIHNpbGhvdWV0dGU6IHNpbGhvdWV0dGVfZGVmYXVsdCwKICAvLyBAdHMtZXhwZWN0LWVycm9yIGRlZmluaXRlbHl0eXBlZCB0eXBlcyBhcmUgaW5jb3JyZWN0CiAgd2lnZ2xlOiB3aWdnbGVfZGVmYXVsdCwKICBwb3NpdGl2ZTogb2Zmc2V0UG9zaXRpdmUKfTsKdmFyIGdldFN0YWNrZWREYXRhID0gKGRhdGEsIGRhdGFLZXlzLCBvZmZzZXRUeXBlKSA9PiB7CiAgdmFyIG9mZnNldEFjY2Vzc29yID0gU1RBQ0tfT0ZGU0VUX01BUFtvZmZzZXRUeXBlXTsKICB2YXIgc3RhY2sgPSBzdGFja19kZWZhdWx0KCkua2V5cyhkYXRhS2V5cykudmFsdWUoKGQsIGtleSkgPT4gTnVtYmVyKGdldFZhbHVlQnlEYXRhS2V5KGQsIGtleSwgMCkpKS5vcmRlcihub25lX2RlZmF1bHQyKS5vZmZzZXQob2Zmc2V0QWNjZXNzb3IpOwogIHJldHVybiBzdGFjayhkYXRhKTsKfTsKZnVuY3Rpb24gZ2V0Tm9ybWFsaXplZFN0YWNrSWQocHVibGljU3RhY2tJZCkgewogIHJldHVybiBwdWJsaWNTdGFja0lkID09IG51bGwgPyB2b2lkIDAgOiBTdHJpbmcocHVibGljU3RhY2tJZCk7Cn0KZnVuY3Rpb24gZ2V0Q2F0ZUNvb3JkaW5hdGVPZkxpbmUoX3JlZjIpIHsKICB2YXIgewogICAgYXhpcywKICAgIHRpY2tzOiB0aWNrczIsCiAgICBiYW5kU2l6ZSwKICAgIGVudHJ5LAogICAgaW5kZXgsCiAgICBkYXRhS2V5CiAgfSA9IF9yZWYyOwogIGlmIChheGlzLnR5cGUgPT09ICJjYXRlZ29yeSIpIHsKICAgIGlmICghYXhpcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSAmJiBheGlzLmRhdGFLZXkgJiYgIWlzTnVsbGlzaChlbnRyeVtheGlzLmRhdGFLZXldKSkgewogICAgICB2YXIgbWF0Y2hlZFRpY2sgPSBmaW5kRW50cnlJbkFycmF5KHRpY2tzMiwgInZhbHVlIiwgZW50cnlbYXhpcy5kYXRhS2V5XSk7CiAgICAgIGlmIChtYXRjaGVkVGljaykgewogICAgICAgIHJldHVybiBtYXRjaGVkVGljay5jb29yZGluYXRlICsgYmFuZFNpemUgLyAyOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGlja3MyW2luZGV4XSA/IHRpY2tzMltpbmRleF0uY29vcmRpbmF0ZSArIGJhbmRTaXplIC8gMiA6IG51bGw7CiAgfQogIHZhciB2YWx1ZSA9IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCAhaXNOdWxsaXNoKGRhdGFLZXkpID8gZGF0YUtleSA6IGF4aXMuZGF0YUtleSk7CiAgcmV0dXJuICFpc051bGxpc2godmFsdWUpID8gYXhpcy5zY2FsZSh2YWx1ZSkgOiBudWxsOwp9CnZhciBnZXREb21haW5PZlNpbmdsZSA9IChkYXRhKSA9PiB7CiAgdmFyIGZsYXQgPSBkYXRhLmZsYXQoMikuZmlsdGVyKGlzTnVtYmVyKTsKICByZXR1cm4gW01hdGgubWluKC4uLmZsYXQpLCBNYXRoLm1heCguLi5mbGF0KV07Cn07CnZhciBtYWtlRG9tYWluRmluaXRlID0gKGRvbWFpbikgPT4gewogIHJldHVybiBbZG9tYWluWzBdID09PSBJbmZpbml0eSA/IDAgOiBkb21haW5bMF0sIGRvbWFpblsxXSA9PT0gLUluZmluaXR5ID8gMCA6IGRvbWFpblsxXV07Cn07CnZhciBnZXREb21haW5PZlN0YWNrR3JvdXBzID0gKHN0YWNrR3JvdXBzLCBzdGFydEluZGV4LCBlbmRJbmRleCkgPT4gewogIGlmIChzdGFja0dyb3VwcyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gbWFrZURvbWFpbkZpbml0ZShPYmplY3Qua2V5cyhzdGFja0dyb3VwcykucmVkdWNlKChyZXN1bHQsIHN0YWNrSWQpID0+IHsKICAgIHZhciBncm91cCA9IHN0YWNrR3JvdXBzW3N0YWNrSWRdOwogICAgdmFyIHsKICAgICAgc3RhY2tlZERhdGEKICAgIH0gPSBncm91cDsKICAgIHZhciBkb21haW4gPSBzdGFja2VkRGF0YS5yZWR1Y2UoKHJlcywgZW50cnkpID0+IHsKICAgICAgdmFyIHNsaWNlZCA9IGdldFNsaWNlZChlbnRyeSwgc3RhcnRJbmRleCwgZW5kSW5kZXgpOwogICAgICB2YXIgcyA9IGdldERvbWFpbk9mU2luZ2xlKHNsaWNlZCk7CiAgICAgIHJldHVybiBbTWF0aC5taW4ocmVzWzBdLCBzWzBdKSwgTWF0aC5tYXgocmVzWzFdLCBzWzFdKV07CiAgICB9LCBbSW5maW5pdHksIC1JbmZpbml0eV0pOwogICAgcmV0dXJuIFtNYXRoLm1pbihkb21haW5bMF0sIHJlc3VsdFswXSksIE1hdGgubWF4KGRvbWFpblsxXSwgcmVzdWx0WzFdKV07CiAgfSwgW0luZmluaXR5LCAtSW5maW5pdHldKSk7Cn07CnZhciBNSU5fVkFMVUVfUkVHID0gL15kYXRhTWluW1xzXSotW1xzXSooWzAtOV0rKFsuXXsxfVswLTldKyl7MCwxfSkkLzsKdmFyIE1BWF9WQUxVRV9SRUcgPSAvXmRhdGFNYXhbXHNdKlwrW1xzXSooWzAtOV0rKFsuXXsxfVswLTldKyl7MCwxfSkkLzsKdmFyIGdldEJhbmRTaXplT2ZBeGlzID0gKGF4aXMsIHRpY2tzMiwgaXNCYXIpID0+IHsKICBpZiAoYXhpcyAmJiBheGlzLnNjYWxlICYmIGF4aXMuc2NhbGUuYmFuZHdpZHRoKSB7CiAgICB2YXIgYmFuZFdpZHRoID0gYXhpcy5zY2FsZS5iYW5kd2lkdGgoKTsKICAgIGlmICghaXNCYXIgfHwgYmFuZFdpZHRoID4gMCkgewogICAgICByZXR1cm4gYmFuZFdpZHRoOwogICAgfQogIH0KICBpZiAoYXhpcyAmJiB0aWNrczIgJiYgdGlja3MyLmxlbmd0aCA+PSAyKSB7CiAgICB2YXIgb3JkZXJlZFRpY2tzID0gKDAsIGltcG9ydF9zb3J0QnkyLmRlZmF1bHQpKHRpY2tzMiwgKG8pID0+IG8uY29vcmRpbmF0ZSk7CiAgICB2YXIgYmFuZFNpemUgPSBJbmZpbml0eTsKICAgIGZvciAodmFyIGkgPSAxLCBsZW4gPSBvcmRlcmVkVGlja3MubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgdmFyIGN1ciA9IG9yZGVyZWRUaWNrc1tpXTsKICAgICAgdmFyIHByZXYgPSBvcmRlcmVkVGlja3NbaSAtIDFdOwogICAgICBiYW5kU2l6ZSA9IE1hdGgubWluKChjdXIuY29vcmRpbmF0ZSB8fCAwKSAtIChwcmV2LmNvb3JkaW5hdGUgfHwgMCksIGJhbmRTaXplKTsKICAgIH0KICAgIHJldHVybiBiYW5kU2l6ZSA9PT0gSW5maW5pdHkgPyAwIDogYmFuZFNpemU7CiAgfQogIHJldHVybiBpc0JhciA/IHZvaWQgMCA6IDA7Cn07CmZ1bmN0aW9uIGdldFRvb2x0aXBFbnRyeShfcmVmNCkgewogIHZhciB7CiAgICB0b29sdGlwRW50cnlTZXR0aW5ncywKICAgIGRhdGFLZXksCiAgICBwYXlsb2FkLAogICAgdmFsdWUsCiAgICBuYW1lCiAgfSA9IF9yZWY0OwogIHJldHVybiBfb2JqZWN0U3ByZWFkMihfb2JqZWN0U3ByZWFkMih7fSwgdG9vbHRpcEVudHJ5U2V0dGluZ3MpLCB7fSwgewogICAgZGF0YUtleSwKICAgIHBheWxvYWQsCiAgICB2YWx1ZSwKICAgIG5hbWUKICB9KTsKfQpmdW5jdGlvbiBnZXRUb29sdGlwTmFtZVByb3AobmFtZUZyb21JdGVtLCBkYXRhS2V5KSB7CiAgaWYgKG5hbWVGcm9tSXRlbSkgewogICAgcmV0dXJuIFN0cmluZyhuYW1lRnJvbUl0ZW0pOwogIH0KICBpZiAodHlwZW9mIGRhdGFLZXkgPT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gZGF0YUtleTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQp2YXIgY2FsY3VsYXRlQ2FydGVzaWFuVG9vbHRpcFBvcyA9IChjb29yZGluYXRlLCBsYXlvdXQpID0+IHsKICBpZiAobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIpIHsKICAgIHJldHVybiBjb29yZGluYXRlLmNoYXJ0WDsKICB9CiAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgcmV0dXJuIGNvb3JkaW5hdGUuY2hhcnRZOwogIH0KICByZXR1cm4gdm9pZCAwOwp9Owp2YXIgY2FsY3VsYXRlUG9sYXJUb29sdGlwUG9zID0gKHJhbmdlT2JqLCBsYXlvdXQpID0+IHsKICBpZiAobGF5b3V0ID09PSAiY2VudHJpYyIpIHsKICAgIHJldHVybiByYW5nZU9iai5hbmdsZTsKICB9CiAgcmV0dXJuIHJhbmdlT2JqLnJhZGl1czsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbnRhaW5lclNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0Q2hhcnRXaWR0aCA9IChzdGF0ZSkgPT4gc3RhdGUubGF5b3V0LndpZHRoOwp2YXIgc2VsZWN0Q2hhcnRIZWlnaHQgPSAoc3RhdGUpID0+IHN0YXRlLmxheW91dC5oZWlnaHQ7CnZhciBzZWxlY3RDb250YWluZXJTY2FsZSA9IChzdGF0ZSkgPT4gc3RhdGUubGF5b3V0LnNjYWxlOwp2YXIgc2VsZWN0TWFyZ2luID0gKHN0YXRlKSA9PiBzdGF0ZS5sYXlvdXQubWFyZ2luOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0QWxsQXhlcy5qcwp2YXIgc2VsZWN0QWxsWEF4ZXMgPSBjcmVhdGVTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLmNhcnRlc2lhbkF4aXMueEF4aXMsICh4QXhpc01hcCkgPT4gewogIHJldHVybiBPYmplY3QudmFsdWVzKHhBeGlzTWFwKTsKfSk7CnZhciBzZWxlY3RBbGxZQXhlcyA9IGNyZWF0ZVNlbGVjdG9yKChzdGF0ZSkgPT4gc3RhdGUuY2FydGVzaWFuQXhpcy55QXhpcywgKHlBeGlzTWFwKSA9PiB7CiAgcmV0dXJuIE9iamVjdC52YWx1ZXMoeUF4aXNNYXApOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9Db25zdGFudHMuanMKdmFyIERBVEFfSVRFTV9JTkRFWF9BVFRSSUJVVEVfTkFNRSA9ICJkYXRhLXJlY2hhcnRzLWl0ZW0taW5kZXgiOwp2YXIgREFUQV9JVEVNX0RBVEFLRVlfQVRUUklCVVRFX05BTUUgPSAiZGF0YS1yZWNoYXJ0cy1pdGVtLWRhdGEta2V5IjsKdmFyIERFRkFVTFRfWV9BWElTX1dJRFRIID0gNjA7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RDaGFydE9mZnNldEludGVybmFsLmpzCmZ1bmN0aW9uIG93bktleXMzKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMyhlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czMoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTMoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTMocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5Myh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUzKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTModCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBzZWxlY3RCcnVzaEhlaWdodCA9IChzdGF0ZSkgPT4gc3RhdGUuYnJ1c2guaGVpZ2h0OwpmdW5jdGlvbiBzZWxlY3RMZWZ0QXhlc09mZnNldChzdGF0ZSkgewogIHZhciB5QXhlcyA9IHNlbGVjdEFsbFlBeGVzKHN0YXRlKTsKICByZXR1cm4geUF4ZXMucmVkdWNlKChyZXN1bHQsIGVudHJ5KSA9PiB7CiAgICBpZiAoZW50cnkub3JpZW50YXRpb24gPT09ICJsZWZ0IiAmJiAhZW50cnkubWlycm9yICYmICFlbnRyeS5oaWRlKSB7CiAgICAgIHZhciB3aWR0aCA9IHR5cGVvZiBlbnRyeS53aWR0aCA9PT0gIm51bWJlciIgPyBlbnRyeS53aWR0aCA6IERFRkFVTFRfWV9BWElTX1dJRFRIOwogICAgICByZXR1cm4gcmVzdWx0ICsgd2lkdGg7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0sIDApOwp9CmZ1bmN0aW9uIHNlbGVjdFJpZ2h0QXhlc09mZnNldChzdGF0ZSkgewogIHZhciB5QXhlcyA9IHNlbGVjdEFsbFlBeGVzKHN0YXRlKTsKICByZXR1cm4geUF4ZXMucmVkdWNlKChyZXN1bHQsIGVudHJ5KSA9PiB7CiAgICBpZiAoZW50cnkub3JpZW50YXRpb24gPT09ICJyaWdodCIgJiYgIWVudHJ5Lm1pcnJvciAmJiAhZW50cnkuaGlkZSkgewogICAgICB2YXIgd2lkdGggPSB0eXBlb2YgZW50cnkud2lkdGggPT09ICJudW1iZXIiID8gZW50cnkud2lkdGggOiBERUZBVUxUX1lfQVhJU19XSURUSDsKICAgICAgcmV0dXJuIHJlc3VsdCArIHdpZHRoOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9LCAwKTsKfQpmdW5jdGlvbiBzZWxlY3RUb3BBeGVzT2Zmc2V0KHN0YXRlKSB7CiAgdmFyIHhBeGVzID0gc2VsZWN0QWxsWEF4ZXMoc3RhdGUpOwogIHJldHVybiB4QXhlcy5yZWR1Y2UoKHJlc3VsdCwgZW50cnkpID0+IHsKICAgIGlmIChlbnRyeS5vcmllbnRhdGlvbiA9PT0gInRvcCIgJiYgIWVudHJ5Lm1pcnJvciAmJiAhZW50cnkuaGlkZSkgewogICAgICByZXR1cm4gcmVzdWx0ICsgZW50cnkuaGVpZ2h0OwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9LCAwKTsKfQpmdW5jdGlvbiBzZWxlY3RCb3R0b21BeGVzT2Zmc2V0KHN0YXRlKSB7CiAgdmFyIHhBeGVzID0gc2VsZWN0QWxsWEF4ZXMoc3RhdGUpOwogIHJldHVybiB4QXhlcy5yZWR1Y2UoKHJlc3VsdCwgZW50cnkpID0+IHsKICAgIGlmIChlbnRyeS5vcmllbnRhdGlvbiA9PT0gImJvdHRvbSIgJiYgIWVudHJ5Lm1pcnJvciAmJiAhZW50cnkuaGlkZSkgewogICAgICByZXR1cm4gcmVzdWx0ICsgZW50cnkuaGVpZ2h0OwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9LCAwKTsKfQp2YXIgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodCwgc2VsZWN0TWFyZ2luLCBzZWxlY3RCcnVzaEhlaWdodCwgc2VsZWN0TGVmdEF4ZXNPZmZzZXQsIHNlbGVjdFJpZ2h0QXhlc09mZnNldCwgc2VsZWN0VG9wQXhlc09mZnNldCwgc2VsZWN0Qm90dG9tQXhlc09mZnNldCwgc2VsZWN0TGVnZW5kU2V0dGluZ3MsIHNlbGVjdExlZ2VuZFNpemVdLCAoY2hhcnRXaWR0aCwgY2hhcnRIZWlnaHQsIG1hcmdpbiwgYnJ1c2hIZWlnaHQsIGxlZnRBeGVzT2Zmc2V0LCByaWdodEF4ZXNPZmZzZXQsIHRvcEF4ZXNPZmZzZXQsIGJvdHRvbUF4ZXNPZmZzZXQsIGxlZ2VuZFNldHRpbmdzLCBsZWdlbmRTaXplKSA9PiB7CiAgdmFyIG9mZnNldEggPSB7CiAgICBsZWZ0OiAobWFyZ2luLmxlZnQgfHwgMCkgKyBsZWZ0QXhlc09mZnNldCwKICAgIHJpZ2h0OiAobWFyZ2luLnJpZ2h0IHx8IDApICsgcmlnaHRBeGVzT2Zmc2V0CiAgfTsKICB2YXIgb2Zmc2V0ViA9IHsKICAgIHRvcDogKG1hcmdpbi50b3AgfHwgMCkgKyB0b3BBeGVzT2Zmc2V0LAogICAgYm90dG9tOiAobWFyZ2luLmJvdHRvbSB8fCAwKSArIGJvdHRvbUF4ZXNPZmZzZXQKICB9OwogIHZhciBvZmZzZXQgPSBfb2JqZWN0U3ByZWFkMyhfb2JqZWN0U3ByZWFkMyh7fSwgb2Zmc2V0ViksIG9mZnNldEgpOwogIHZhciBicnVzaEJvdHRvbSA9IG9mZnNldC5ib3R0b207CiAgb2Zmc2V0LmJvdHRvbSArPSBicnVzaEhlaWdodDsKICBvZmZzZXQgPSBhcHBlbmRPZmZzZXRPZkxlZ2VuZChvZmZzZXQsIGxlZ2VuZFNldHRpbmdzLCBsZWdlbmRTaXplKTsKICB2YXIgb2Zmc2V0V2lkdGggPSBjaGFydFdpZHRoIC0gb2Zmc2V0LmxlZnQgLSBvZmZzZXQucmlnaHQ7CiAgdmFyIG9mZnNldEhlaWdodCA9IGNoYXJ0SGVpZ2h0IC0gb2Zmc2V0LnRvcCAtIG9mZnNldC5ib3R0b207CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQzKF9vYmplY3RTcHJlYWQzKHsKICAgIGJydXNoQm90dG9tCiAgfSwgb2Zmc2V0KSwge30sIHsKICAgIC8vIG5ldmVyIHJldHVybiBuZWdhdGl2ZSB2YWx1ZXMgZm9yIGhlaWdodCBhbmQgd2lkdGgKICAgIHdpZHRoOiBNYXRoLm1heChvZmZzZXRXaWR0aCwgMCksCiAgICBoZWlnaHQ6IE1hdGgubWF4KG9mZnNldEhlaWdodCwgMCkKICB9KTsKfSk7CnZhciBzZWxlY3RDaGFydFZpZXdCb3ggPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCAob2Zmc2V0KSA9PiAoewogIHg6IG9mZnNldC5sZWZ0LAogIHk6IG9mZnNldC50b3AsCiAgd2lkdGg6IG9mZnNldC53aWR0aCwKICBoZWlnaHQ6IG9mZnNldC5oZWlnaHQKfSkpOwp2YXIgc2VsZWN0QXhpc1ZpZXdCb3ggPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodCwgKHdpZHRoLCBoZWlnaHQpID0+ICh7CiAgeDogMCwKICB5OiAwLAogIHdpZHRoLAogIGhlaWdodAp9KSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvUGFub3JhbWFDb250ZXh0LmpzCnZhciBSZWFjdDMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QxMSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIFBhbm9yYW1hQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MTEuY3JlYXRlQ29udGV4dCkobnVsbCk7CnZhciB1c2VJc1Bhbm9yYW1hID0gKCkgPT4gKDAsIGltcG9ydF9yZWFjdDExLnVzZUNvbnRleHQpKFBhbm9yYW1hQ29udGV4dCkgIT0gbnVsbDsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2JydXNoU2VsZWN0b3JzLmpzCnZhciBzZWxlY3RCcnVzaFNldHRpbmdzID0gKHN0YXRlKSA9PiBzdGF0ZS5icnVzaDsKdmFyIHNlbGVjdEJydXNoRGltZW5zaW9ucyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCcnVzaFNldHRpbmdzLCBzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RNYXJnaW5dLCAoYnJ1c2hTZXR0aW5ncywgb2Zmc2V0LCBtYXJnaW4pID0+ICh7CiAgaGVpZ2h0OiBicnVzaFNldHRpbmdzLmhlaWdodCwKICB4OiBpc051bWJlcihicnVzaFNldHRpbmdzLngpID8gYnJ1c2hTZXR0aW5ncy54IDogb2Zmc2V0LmxlZnQsCiAgeTogaXNOdW1iZXIoYnJ1c2hTZXR0aW5ncy55KSA/IGJydXNoU2V0dGluZ3MueSA6IG9mZnNldC50b3AgKyBvZmZzZXQuaGVpZ2h0ICsgb2Zmc2V0LmJydXNoQm90dG9tIC0gKChtYXJnaW4gPT09IG51bGwgfHwgbWFyZ2luID09PSB2b2lkIDAgPyB2b2lkIDAgOiBtYXJnaW4uYm90dG9tKSB8fCAwKSwKICB3aWR0aDogaXNOdW1iZXIoYnJ1c2hTZXR0aW5ncy53aWR0aCkgPyBicnVzaFNldHRpbmdzLndpZHRoIDogb2Zmc2V0LndpZHRoCn0pKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1Jlc3BvbnNpdmVDb250YWluZXIuanMKdmFyIFJlYWN0NCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDEyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3Rocm90dGxlID0gX190b0VTTShyZXF1aXJlX3Rocm90dGxlMigpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9Mb2dVdGlscy5qcwp2YXIgaXNEZXYgPSB0cnVlOwp2YXIgd2FybiA9IGZ1bmN0aW9uIHdhcm4yKGNvbmRpdGlvbiwgZm9ybWF0MikgewogIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4gPiAyID8gX2xlbiAtIDIgOiAwKSwgX2tleSA9IDI7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgIGFyZ3NbX2tleSAtIDJdID0gYXJndW1lbnRzW19rZXldOwogIH0KICBpZiAoaXNEZXYgJiYgdHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUud2FybikgewogICAgaWYgKGZvcm1hdDIgPT09IHZvaWQgMCkgewogICAgICBjb25zb2xlLndhcm4oIkxvZ1V0aWxzIHJlcXVpcmVzIGFuIGVycm9yIG1lc3NhZ2UgYXJndW1lbnQiKTsKICAgIH0KICAgIGlmICghY29uZGl0aW9uKSB7CiAgICAgIGlmIChmb3JtYXQyID09PSB2b2lkIDApIHsKICAgICAgICBjb25zb2xlLndhcm4oIk1pbmlmaWVkIGV4Y2VwdGlvbiBvY2N1cnJlZDsgdXNlIHRoZSBub24tbWluaWZpZWQgZGV2IGVudmlyb25tZW50IGZvciB0aGUgZnVsbCBlcnJvciBtZXNzYWdlIGFuZCBhZGRpdGlvbmFsIGhlbHBmdWwgd2FybmluZ3MuIik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGFyZ0luZGV4ID0gMDsKICAgICAgICBjb25zb2xlLndhcm4oZm9ybWF0Mi5yZXBsYWNlKC8lcy9nLCAoKSA9PiBhcmdzW2FyZ0luZGV4KytdKSk7CiAgICAgIH0KICAgIH0KICB9Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9yZXNwb25zaXZlQ29udGFpbmVyVXRpbHMuanMKdmFyIGNhbGN1bGF0ZUNoYXJ0RGltZW5zaW9ucyA9IChjb250YWluZXJXaWR0aCwgY29udGFpbmVySGVpZ2h0LCBwcm9wcykgPT4gewogIHZhciB7CiAgICB3aWR0aCA9ICIxMDAlIiwKICAgIGhlaWdodCA9ICIxMDAlIiwKICAgIGFzcGVjdCwKICAgIG1heEhlaWdodAogIH0gPSBwcm9wczsKICB2YXIgY2FsY3VsYXRlZFdpZHRoID0gaXNQZXJjZW50KHdpZHRoKSA/IGNvbnRhaW5lcldpZHRoIDogTnVtYmVyKHdpZHRoKTsKICB2YXIgY2FsY3VsYXRlZEhlaWdodCA9IGlzUGVyY2VudChoZWlnaHQpID8gY29udGFpbmVySGVpZ2h0IDogTnVtYmVyKGhlaWdodCk7CiAgaWYgKGFzcGVjdCAmJiBhc3BlY3QgPiAwKSB7CiAgICBpZiAoY2FsY3VsYXRlZFdpZHRoKSB7CiAgICAgIGNhbGN1bGF0ZWRIZWlnaHQgPSBjYWxjdWxhdGVkV2lkdGggLyBhc3BlY3Q7CiAgICB9IGVsc2UgaWYgKGNhbGN1bGF0ZWRIZWlnaHQpIHsKICAgICAgY2FsY3VsYXRlZFdpZHRoID0gY2FsY3VsYXRlZEhlaWdodCAqIGFzcGVjdDsKICAgIH0KICAgIGlmIChtYXhIZWlnaHQgJiYgY2FsY3VsYXRlZEhlaWdodCAhPSBudWxsICYmIGNhbGN1bGF0ZWRIZWlnaHQgPiBtYXhIZWlnaHQpIHsKICAgICAgY2FsY3VsYXRlZEhlaWdodCA9IG1heEhlaWdodDsKICAgIH0KICB9CiAgcmV0dXJuIHsKICAgIGNhbGN1bGF0ZWRXaWR0aCwKICAgIGNhbGN1bGF0ZWRIZWlnaHQKICB9Owp9Owp2YXIgYm90aE92ZXJmbG93ID0gewogIHdpZHRoOiAwLAogIGhlaWdodDogMCwKICBvdmVyZmxvdzogInZpc2libGUiCn07CnZhciBvdmVyZmxvd1ggPSB7CiAgd2lkdGg6IDAsCiAgb3ZlcmZsb3dYOiAidmlzaWJsZSIKfTsKdmFyIG92ZXJmbG93WSA9IHsKICBoZWlnaHQ6IDAsCiAgb3ZlcmZsb3dZOiAidmlzaWJsZSIKfTsKdmFyIG5vU3R5bGUgPSB7fTsKdmFyIGdldElubmVyRGl2U3R5bGUgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gcHJvcHM7CiAgdmFyIGlzV2lkdGhQZXJjZW50ID0gaXNQZXJjZW50KHdpZHRoKTsKICB2YXIgaXNIZWlnaHRQZXJjZW50ID0gaXNQZXJjZW50KGhlaWdodCk7CiAgaWYgKGlzV2lkdGhQZXJjZW50ICYmIGlzSGVpZ2h0UGVyY2VudCkgewogICAgcmV0dXJuIGJvdGhPdmVyZmxvdzsKICB9CiAgaWYgKGlzV2lkdGhQZXJjZW50KSB7CiAgICByZXR1cm4gb3ZlcmZsb3dYOwogIH0KICBpZiAoaXNIZWlnaHRQZXJjZW50KSB7CiAgICByZXR1cm4gb3ZlcmZsb3dZOwogIH0KICByZXR1cm4gbm9TdHlsZTsKfTsKZnVuY3Rpb24gZ2V0RGVmYXVsdFdpZHRoQW5kSGVpZ2h0KF9yZWYyKSB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgYXNwZWN0CiAgfSA9IF9yZWYyOwogIHZhciBjYWxjdWxhdGVkV2lkdGggPSB3aWR0aDsKICB2YXIgY2FsY3VsYXRlZEhlaWdodCA9IGhlaWdodDsKICBpZiAoY2FsY3VsYXRlZFdpZHRoID09PSB2b2lkIDAgJiYgY2FsY3VsYXRlZEhlaWdodCA9PT0gdm9pZCAwKSB7CiAgICBjYWxjdWxhdGVkV2lkdGggPSAiMTAwJSI7CiAgICBjYWxjdWxhdGVkSGVpZ2h0ID0gIjEwMCUiOwogIH0gZWxzZSBpZiAoY2FsY3VsYXRlZFdpZHRoID09PSB2b2lkIDApIHsKICAgIGNhbGN1bGF0ZWRXaWR0aCA9IGFzcGVjdCAmJiBhc3BlY3QgPiAwID8gdm9pZCAwIDogIjEwMCUiOwogIH0gZWxzZSBpZiAoY2FsY3VsYXRlZEhlaWdodCA9PT0gdm9pZCAwKSB7CiAgICBjYWxjdWxhdGVkSGVpZ2h0ID0gYXNwZWN0ICYmIGFzcGVjdCA+IDAgPyB2b2lkIDAgOiAiMTAwJSI7CiAgfQogIHJldHVybiB7CiAgICB3aWR0aDogY2FsY3VsYXRlZFdpZHRoLAogICAgaGVpZ2h0OiBjYWxjdWxhdGVkSGVpZ2h0CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2lzV2VsbEJlaGF2ZWROdW1iZXIuanMKZnVuY3Rpb24gaXNXZWxsQmVoYXZlZE51bWJlcihuKSB7CiAgcmV0dXJuIE51bWJlci5pc0Zpbml0ZShuKTsKfQpmdW5jdGlvbiBpc1Bvc2l0aXZlTnVtYmVyKG4pIHsKICByZXR1cm4gdHlwZW9mIG4gPT09ICJudW1iZXIiICYmIG4gPiAwICYmIE51bWJlci5pc0Zpbml0ZShuKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvUmVzcG9uc2l2ZUNvbnRhaW5lci5qcwpmdW5jdGlvbiBfZXh0ZW5kczMoKSB7CiAgcmV0dXJuIF9leHRlbmRzMyA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMy5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIG93bktleXM0KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkNChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czQoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTQoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzNChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5NChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTQocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5NCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU0KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTQodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MTIuY3JlYXRlQ29udGV4dCkoewogIHdpZHRoOiAtMSwKICBoZWlnaHQ6IC0xCn0pOwpmdW5jdGlvbiBpc0FjY2VwdGFibGVTaXplKHNpemUpIHsKICByZXR1cm4gaXNQb3NpdGl2ZU51bWJlcihzaXplLndpZHRoKSAmJiBpc1Bvc2l0aXZlTnVtYmVyKHNpemUuaGVpZ2h0KTsKfQpmdW5jdGlvbiBSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dFByb3ZpZGVyKF9yZWYyKSB7CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gX3JlZjI7CiAgdmFyIHNpemUgPSAoMCwgaW1wb3J0X3JlYWN0MTIudXNlTWVtbykoKCkgPT4gKHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSksIFt3aWR0aCwgaGVpZ2h0XSk7CiAgaWYgKCFpc0FjY2VwdGFibGVTaXplKHNpemUpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudChSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dC5Qcm92aWRlciwgewogICAgdmFsdWU6IHNpemUKICB9LCBjaGlsZHJlbik7Cn0KdmFyIHVzZVJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0ID0gKCkgPT4gKDAsIGltcG9ydF9yZWFjdDEyLnVzZUNvbnRleHQpKFJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0KTsKdmFyIFNpemVEZXRlY3RvckNvbnRhaW5lciA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MTIuZm9yd2FyZFJlZikoKF9yZWYyLCByZWYpID0+IHsKICB2YXIgewogICAgYXNwZWN0LAogICAgaW5pdGlhbERpbWVuc2lvbiA9IHsKICAgICAgd2lkdGg6IC0xLAogICAgICBoZWlnaHQ6IC0xCiAgICB9LAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICAvKgogICAgICogZGVmYXVsdCBtaW4td2lkdGggdG8gMCBpZiBub3Qgc3BlY2lmaWVkIC0gJ2F1dG8nIGNhdXNlcyBpc3N1ZXMgd2l0aCBmbGV4Ym94CiAgICAgKiBodHRwczovL2dpdGh1Yi5jb20vcmVjaGFydHMvcmVjaGFydHMvaXNzdWVzLzE3MgogICAgICovCiAgICBtaW5XaWR0aCA9IDAsCiAgICBtaW5IZWlnaHQsCiAgICBtYXhIZWlnaHQsCiAgICBjaGlsZHJlbiwKICAgIGRlYm91bmNlID0gMCwKICAgIGlkLAogICAgY2xhc3NOYW1lLAogICAgb25SZXNpemUsCiAgICBzdHlsZSA9IHt9CiAgfSA9IF9yZWYyOwogIHZhciBjb250YWluZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTIudXNlUmVmKShudWxsKTsKICB2YXIgb25SZXNpemVSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTIudXNlUmVmKSgpOwogIG9uUmVzaXplUmVmLmN1cnJlbnQgPSBvblJlc2l6ZTsKICAoMCwgaW1wb3J0X3JlYWN0MTIudXNlSW1wZXJhdGl2ZUhhbmRsZSkocmVmLCAoKSA9PiBjb250YWluZXJSZWYuY3VycmVudCk7CiAgdmFyIFtzaXplcywgc2V0U2l6ZXNdID0gKDAsIGltcG9ydF9yZWFjdDEyLnVzZVN0YXRlKSh7CiAgICBjb250YWluZXJXaWR0aDogaW5pdGlhbERpbWVuc2lvbi53aWR0aCwKICAgIGNvbnRhaW5lckhlaWdodDogaW5pdGlhbERpbWVuc2lvbi5oZWlnaHQKICB9KTsKICB2YXIgc2V0Q29udGFpbmVyU2l6ZSA9ICgwLCBpbXBvcnRfcmVhY3QxMi51c2VDYWxsYmFjaykoKG5ld1dpZHRoLCBuZXdIZWlnaHQpID0+IHsKICAgIHNldFNpemVzKChwcmV2U3RhdGUpID0+IHsKICAgICAgdmFyIHJvdW5kZWRXaWR0aCA9IE1hdGgucm91bmQobmV3V2lkdGgpOwogICAgICB2YXIgcm91bmRlZEhlaWdodCA9IE1hdGgucm91bmQobmV3SGVpZ2h0KTsKICAgICAgaWYgKHByZXZTdGF0ZS5jb250YWluZXJXaWR0aCA9PT0gcm91bmRlZFdpZHRoICYmIHByZXZTdGF0ZS5jb250YWluZXJIZWlnaHQgPT09IHJvdW5kZWRIZWlnaHQpIHsKICAgICAgICByZXR1cm4gcHJldlN0YXRlOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgY29udGFpbmVyV2lkdGg6IHJvdW5kZWRXaWR0aCwKICAgICAgICBjb250YWluZXJIZWlnaHQ6IHJvdW5kZWRIZWlnaHQKICAgICAgfTsKICAgIH0pOwogIH0sIFtdKTsKICAoMCwgaW1wb3J0X3JlYWN0MTIudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoY29udGFpbmVyUmVmLmN1cnJlbnQgPT0gbnVsbCB8fCB0eXBlb2YgUmVzaXplT2JzZXJ2ZXIgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHJldHVybiBub29wOwogICAgfQogICAgdmFyIGNhbGxiYWNrID0gKGVudHJpZXMpID0+IHsKICAgICAgdmFyIF9vblJlc2l6ZVJlZiRjdXJyZW50OwogICAgICB2YXIgewogICAgICAgIHdpZHRoOiBjb250YWluZXJXaWR0aDMsCiAgICAgICAgaGVpZ2h0OiBjb250YWluZXJIZWlnaHQzCiAgICAgIH0gPSBlbnRyaWVzWzBdLmNvbnRlbnRSZWN0OwogICAgICBzZXRDb250YWluZXJTaXplKGNvbnRhaW5lcldpZHRoMywgY29udGFpbmVySGVpZ2h0Myk7CiAgICAgIChfb25SZXNpemVSZWYkY3VycmVudCA9IG9uUmVzaXplUmVmLmN1cnJlbnQpID09PSBudWxsIHx8IF9vblJlc2l6ZVJlZiRjdXJyZW50ID09PSB2b2lkIDAgfHwgX29uUmVzaXplUmVmJGN1cnJlbnQuY2FsbChvblJlc2l6ZVJlZiwgY29udGFpbmVyV2lkdGgzLCBjb250YWluZXJIZWlnaHQzKTsKICAgIH07CiAgICBpZiAoZGVib3VuY2UgPiAwKSB7CiAgICAgIGNhbGxiYWNrID0gKDAsIGltcG9ydF90aHJvdHRsZS5kZWZhdWx0KShjYWxsYmFjaywgZGVib3VuY2UsIHsKICAgICAgICB0cmFpbGluZzogdHJ1ZSwKICAgICAgICBsZWFkaW5nOiBmYWxzZQogICAgICB9KTsKICAgIH0KICAgIHZhciBvYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcihjYWxsYmFjayk7CiAgICB2YXIgewogICAgICB3aWR0aDogY29udGFpbmVyV2lkdGgyLAogICAgICBoZWlnaHQ6IGNvbnRhaW5lckhlaWdodDIKICAgIH0gPSBjb250YWluZXJSZWYuY3VycmVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIHNldENvbnRhaW5lclNpemUoY29udGFpbmVyV2lkdGgyLCBjb250YWluZXJIZWlnaHQyKTsKICAgIG9ic2VydmVyLm9ic2VydmUoY29udGFpbmVyUmVmLmN1cnJlbnQpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgb2JzZXJ2ZXIuZGlzY29ubmVjdCgpOwogICAgfTsKICB9LCBbc2V0Q29udGFpbmVyU2l6ZSwgZGVib3VuY2VdKTsKICB2YXIgewogICAgY29udGFpbmVyV2lkdGgsCiAgICBjb250YWluZXJIZWlnaHQKICB9ID0gc2l6ZXM7CiAgd2FybighYXNwZWN0IHx8IGFzcGVjdCA+IDAsICJUaGUgYXNwZWN0KCVzKSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiB6ZXJvLiIsIGFzcGVjdCk7CiAgdmFyIHsKICAgIGNhbGN1bGF0ZWRXaWR0aCwKICAgIGNhbGN1bGF0ZWRIZWlnaHQKICB9ID0gY2FsY3VsYXRlQ2hhcnREaW1lbnNpb25zKGNvbnRhaW5lcldpZHRoLCBjb250YWluZXJIZWlnaHQsIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgYXNwZWN0LAogICAgbWF4SGVpZ2h0CiAgfSk7CiAgd2FybihjYWxjdWxhdGVkV2lkdGggIT0gbnVsbCAmJiBjYWxjdWxhdGVkV2lkdGggPiAwIHx8IGNhbGN1bGF0ZWRIZWlnaHQgIT0gbnVsbCAmJiBjYWxjdWxhdGVkSGVpZ2h0ID4gMCwgIlRoZSB3aWR0aCglcykgYW5kIGhlaWdodCglcykgb2YgY2hhcnQgc2hvdWxkIGJlIGdyZWF0ZXIgdGhhbiAwLFxuICAgICAgIHBsZWFzZSBjaGVjayB0aGUgc3R5bGUgb2YgY29udGFpbmVyLCBvciB0aGUgcHJvcHMgd2lkdGgoJXMpIGFuZCBoZWlnaHQoJXMpLFxuICAgICAgIG9yIGFkZCBhIG1pbldpZHRoKCVzKSBvciBtaW5IZWlnaHQoJXMpIG9yIHVzZSBhc3BlY3QoJXMpIHRvIGNvbnRyb2wgdGhlXG4gICAgICAgaGVpZ2h0IGFuZCB3aWR0aC4iLCBjYWxjdWxhdGVkV2lkdGgsIGNhbGN1bGF0ZWRIZWlnaHQsIHdpZHRoLCBoZWlnaHQsIG1pbldpZHRoLCBtaW5IZWlnaHQsIGFzcGVjdCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudCgiZGl2IiwgewogICAgaWQ6IGlkID8gIiIuY29uY2F0KGlkKSA6IHZvaWQgMCwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtcmVzcG9uc2l2ZS1jb250YWluZXIiLCBjbGFzc05hbWUpLAogICAgc3R5bGU6IF9vYmplY3RTcHJlYWQ0KF9vYmplY3RTcHJlYWQ0KHt9LCBzdHlsZSksIHt9LCB7CiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQsCiAgICAgIG1pbldpZHRoLAogICAgICBtaW5IZWlnaHQsCiAgICAgIG1heEhlaWdodAogICAgfSksCiAgICByZWY6IGNvbnRhaW5lclJlZgogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudCgiZGl2IiwgewogICAgc3R5bGU6IGdldElubmVyRGl2U3R5bGUoewogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9KQogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudChSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dFByb3ZpZGVyLCB7CiAgICB3aWR0aDogY2FsY3VsYXRlZFdpZHRoLAogICAgaGVpZ2h0OiBjYWxjdWxhdGVkSGVpZ2h0CiAgfSwgY2hpbGRyZW4pKSk7Cn0pOwp2YXIgUmVzcG9uc2l2ZUNvbnRhaW5lciA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MTIuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgcmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQgPSB1c2VSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCgpOwogIGlmIChpc1Bvc2l0aXZlTnVtYmVyKHJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0LndpZHRoKSAmJiBpc1Bvc2l0aXZlTnVtYmVyKHJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0LmhlaWdodCkpIHsKICAgIHJldHVybiBwcm9wcy5jaGlsZHJlbjsKICB9CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IGdldERlZmF1bHRXaWR0aEFuZEhlaWdodCh7CiAgICB3aWR0aDogcHJvcHMud2lkdGgsCiAgICBoZWlnaHQ6IHByb3BzLmhlaWdodCwKICAgIGFzcGVjdDogcHJvcHMuYXNwZWN0CiAgfSk7CiAgdmFyIHsKICAgIGNhbGN1bGF0ZWRXaWR0aCwKICAgIGNhbGN1bGF0ZWRIZWlnaHQKICB9ID0gY2FsY3VsYXRlQ2hhcnREaW1lbnNpb25zKHZvaWQgMCwgdm9pZCAwLCB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGFzcGVjdDogcHJvcHMuYXNwZWN0LAogICAgbWF4SGVpZ2h0OiBwcm9wcy5tYXhIZWlnaHQKICB9KTsKICBpZiAoaXNOdW1iZXIoY2FsY3VsYXRlZFdpZHRoKSAmJiBpc051bWJlcihjYWxjdWxhdGVkSGVpZ2h0KSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudChSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dFByb3ZpZGVyLCB7CiAgICAgIHdpZHRoOiBjYWxjdWxhdGVkV2lkdGgsCiAgICAgIGhlaWdodDogY2FsY3VsYXRlZEhlaWdodAogICAgfSwgcHJvcHMuY2hpbGRyZW4pOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0NC5jcmVhdGVFbGVtZW50KFNpemVEZXRlY3RvckNvbnRhaW5lciwgX2V4dGVuZHMzKHt9LCBwcm9wcywgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByZWYKICB9KSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L2NoYXJ0TGF5b3V0Q29udGV4dC5qcwpmdW5jdGlvbiBjYXJ0ZXNpYW5WaWV3Qm94VG9UcmFwZXpvaWQoYm94KSB7CiAgaWYgKCFib3gpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiB7CiAgICB4OiBib3gueCwKICAgIHk6IGJveC55LAogICAgdXBwZXJXaWR0aDogInVwcGVyV2lkdGgiIGluIGJveCA/IGJveC51cHBlcldpZHRoIDogYm94LndpZHRoLAogICAgbG93ZXJXaWR0aDogImxvd2VyV2lkdGgiIGluIGJveCA/IGJveC5sb3dlcldpZHRoIDogYm94LndpZHRoLAogICAgd2lkdGg6IGJveC53aWR0aCwKICAgIGhlaWdodDogYm94LmhlaWdodAogIH07Cn0KdmFyIHVzZVZpZXdCb3ggPSAoKSA9PiB7CiAgdmFyIF91c2VBcHBTZWxlY3RvcjsKICB2YXIgcGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHJvb3RWaWV3Qm94ID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0Q2hhcnRWaWV3Qm94KTsKICB2YXIgYnJ1c2hEaW1lbnNpb25zID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0QnJ1c2hEaW1lbnNpb25zKTsKICB2YXIgYnJ1c2hQYWRkaW5nID0gKF91c2VBcHBTZWxlY3RvciA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEJydXNoU2V0dGluZ3MpKSA9PT0gbnVsbCB8fCBfdXNlQXBwU2VsZWN0b3IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF91c2VBcHBTZWxlY3Rvci5wYWRkaW5nOwogIGlmICghcGFub3JhbWEgfHwgIWJydXNoRGltZW5zaW9ucyB8fCAhYnJ1c2hQYWRkaW5nKSB7CiAgICByZXR1cm4gcm9vdFZpZXdCb3g7CiAgfQogIHJldHVybiB7CiAgICB3aWR0aDogYnJ1c2hEaW1lbnNpb25zLndpZHRoIC0gYnJ1c2hQYWRkaW5nLmxlZnQgLSBicnVzaFBhZGRpbmcucmlnaHQsCiAgICBoZWlnaHQ6IGJydXNoRGltZW5zaW9ucy5oZWlnaHQgLSBicnVzaFBhZGRpbmcudG9wIC0gYnJ1c2hQYWRkaW5nLmJvdHRvbSwKICAgIHg6IGJydXNoUGFkZGluZy5sZWZ0LAogICAgeTogYnJ1c2hQYWRkaW5nLnRvcAogIH07Cn07CnZhciBtYW55Q29tcG9uZW50c1Rocm93RXJyb3JzSWZPZmZzZXRJc1VuZGVmaW5lZCA9IHsKICB0b3A6IDAsCiAgYm90dG9tOiAwLAogIGxlZnQ6IDAsCiAgcmlnaHQ6IDAsCiAgd2lkdGg6IDAsCiAgaGVpZ2h0OiAwLAogIGJydXNoQm90dG9tOiAwCn07CnZhciB1c2VPZmZzZXRJbnRlcm5hbCA9ICgpID0+IHsKICB2YXIgX3VzZUFwcFNlbGVjdG9yMjsKICByZXR1cm4gKF91c2VBcHBTZWxlY3RvcjIgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RDaGFydE9mZnNldEludGVybmFsKSkgIT09IG51bGwgJiYgX3VzZUFwcFNlbGVjdG9yMiAhPT0gdm9pZCAwID8gX3VzZUFwcFNlbGVjdG9yMiA6IG1hbnlDb21wb25lbnRzVGhyb3dFcnJvcnNJZk9mZnNldElzVW5kZWZpbmVkOwp9Owp2YXIgdXNlQ2hhcnRXaWR0aCA9ICgpID0+IHsKICByZXR1cm4gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0Q2hhcnRXaWR0aCk7Cn07CnZhciB1c2VDaGFydEhlaWdodCA9ICgpID0+IHsKICByZXR1cm4gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0Q2hhcnRIZWlnaHQpOwp9Owp2YXIgc2VsZWN0Q2hhcnRMYXlvdXQgPSAoc3RhdGUpID0+IHN0YXRlLmxheW91dC5sYXlvdXRUeXBlOwp2YXIgdXNlQ2hhcnRMYXlvdXQgPSAoKSA9PiB1c2VBcHBTZWxlY3RvcihzZWxlY3RDaGFydExheW91dCk7CnZhciB1c2VDYXJ0ZXNpYW5DaGFydExheW91dCA9ICgpID0+IHsKICB2YXIgbGF5b3V0ID0gdXNlQ2hhcnRMYXlvdXQoKTsKICBpZiAobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgfHwgbGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICByZXR1cm4gbGF5b3V0OwogIH0KICByZXR1cm4gdm9pZCAwOwp9Owp2YXIgdXNlSXNJbkNoYXJ0Q29udGV4dCA9ICgpID0+IHsKICB2YXIgbGF5b3V0ID0gdXNlQ2hhcnRMYXlvdXQoKTsKICByZXR1cm4gbGF5b3V0ICE9PSB2b2lkIDA7Cn07CnZhciBSZXBvcnRDaGFydFNpemUgPSAocHJvcHMpID0+IHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciB7CiAgICB3aWR0aDogd2lkdGhGcm9tUHJvcHMsCiAgICBoZWlnaHQ6IGhlaWdodEZyb21Qcm9wcwogIH0gPSBwcm9wczsKICB2YXIgcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucyA9IHVzZVJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0KCk7CiAgdmFyIHdpZHRoID0gd2lkdGhGcm9tUHJvcHM7CiAgdmFyIGhlaWdodCA9IGhlaWdodEZyb21Qcm9wczsKICBpZiAocmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucykgewogICAgd2lkdGggPSByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLndpZHRoID4gMCA/IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMud2lkdGggOiB3aWR0aEZyb21Qcm9wczsKICAgIGhlaWdodCA9IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMuaGVpZ2h0ID4gMCA/IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMuaGVpZ2h0IDogaGVpZ2h0RnJvbVByb3BzOwogIH0KICAoMCwgaW1wb3J0X3JlYWN0MTMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoIWlzUGFub3JhbWEgJiYgaXNQb3NpdGl2ZU51bWJlcih3aWR0aCkgJiYgaXNQb3NpdGl2ZU51bWJlcihoZWlnaHQpKSB7CiAgICAgIGRpc3BhdGNoKHNldENoYXJ0U2l6ZSh7CiAgICAgICAgd2lkdGgsCiAgICAgICAgaGVpZ2h0CiAgICAgIH0pKTsKICAgIH0KICB9LCBbZGlzcGF0Y2gsIGlzUGFub3JhbWEsIHdpZHRoLCBoZWlnaHRdKTsKICByZXR1cm4gbnVsbDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9pbW1lci9kaXN0L2ltbWVyLm1qcwp2YXIgTk9USElORzIgPSBTeW1ib2wuZm9yKCJpbW1lci1ub3RoaW5nIik7CnZhciBEUkFGVEFCTEUyID0gU3ltYm9sLmZvcigiaW1tZXItZHJhZnRhYmxlIik7CnZhciBEUkFGVF9TVEFURTIgPSBTeW1ib2wuZm9yKCJpbW1lci1zdGF0ZSIpOwp2YXIgZXJyb3JzMiA9IHRydWUgPyBbCiAgLy8gQWxsIGVycm9yIGNvZGVzLCBzdGFydGluZyBieSAwOgogIGZ1bmN0aW9uKHBsdWdpbikgewogICAgcmV0dXJuIGBUaGUgcGx1Z2luIGZvciAnJHtwbHVnaW59JyBoYXMgbm90IGJlZW4gbG9hZGVkIGludG8gSW1tZXIuIFRvIGVuYWJsZSB0aGUgcGx1Z2luLCBpbXBvcnQgYW5kIGNhbGwgXGBlbmFibGUke3BsdWdpbn0oKVxgIHdoZW4gaW5pdGlhbGl6aW5nIHlvdXIgYXBwbGljYXRpb24uYDsKICB9LAogIGZ1bmN0aW9uKHRoaW5nKSB7CiAgICByZXR1cm4gYHByb2R1Y2UgY2FuIG9ubHkgYmUgY2FsbGVkIG9uIHRoaW5ncyB0aGF0IGFyZSBkcmFmdGFibGU6IHBsYWluIG9iamVjdHMsIGFycmF5cywgTWFwLCBTZXQgb3IgY2xhc3NlcyB0aGF0IGFyZSBtYXJrZWQgd2l0aCAnW2ltbWVyYWJsZV06IHRydWUnLiBHb3QgJyR7dGhpbmd9J2A7CiAgfSwKICAiVGhpcyBvYmplY3QgaGFzIGJlZW4gZnJvemVuIGFuZCBzaG91bGQgbm90IGJlIG11dGF0ZWQiLAogIGZ1bmN0aW9uKGRhdGEpIHsKICAgIHJldHVybiAiQ2Fubm90IHVzZSBhIHByb3h5IHRoYXQgaGFzIGJlZW4gcmV2b2tlZC4gRGlkIHlvdSBwYXNzIGFuIG9iamVjdCBmcm9tIGluc2lkZSBhbiBpbW1lciBmdW5jdGlvbiB0byBhbiBhc3luYyBwcm9jZXNzPyAiICsgZGF0YTsKICB9LAogICJBbiBpbW1lciBwcm9kdWNlciByZXR1cm5lZCBhIG5ldyB2YWx1ZSAqYW5kKiBtb2RpZmllZCBpdHMgZHJhZnQuIEVpdGhlciByZXR1cm4gYSBuZXcgdmFsdWUgKm9yKiBtb2RpZnkgdGhlIGRyYWZ0LiIsCiAgIkltbWVyIGZvcmJpZHMgY2lyY3VsYXIgcmVmZXJlbmNlcyIsCiAgIlRoZSBmaXJzdCBvciBzZWNvbmQgYXJndW1lbnQgdG8gYHByb2R1Y2VgIG11c3QgYmUgYSBmdW5jdGlvbiIsCiAgIlRoZSB0aGlyZCBhcmd1bWVudCB0byBgcHJvZHVjZWAgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIHVuZGVmaW5lZCIsCiAgIkZpcnN0IGFyZ3VtZW50IHRvIGBjcmVhdGVEcmFmdGAgbXVzdCBiZSBhIHBsYWluIG9iamVjdCwgYW4gYXJyYXksIG9yIGFuIGltbWVyYWJsZSBvYmplY3QiLAogICJGaXJzdCBhcmd1bWVudCB0byBgZmluaXNoRHJhZnRgIG11c3QgYmUgYSBkcmFmdCByZXR1cm5lZCBieSBgY3JlYXRlRHJhZnRgIiwKICBmdW5jdGlvbih0aGluZykgewogICAgcmV0dXJuIGAnY3VycmVudCcgZXhwZWN0cyBhIGRyYWZ0LCBnb3Q6ICR7dGhpbmd9YDsKICB9LAogICJPYmplY3QuZGVmaW5lUHJvcGVydHkoKSBjYW5ub3QgYmUgdXNlZCBvbiBhbiBJbW1lciBkcmFmdCIsCiAgIk9iamVjdC5zZXRQcm90b3R5cGVPZigpIGNhbm5vdCBiZSB1c2VkIG9uIGFuIEltbWVyIGRyYWZ0IiwKICAiSW1tZXIgb25seSBzdXBwb3J0cyBkZWxldGluZyBhcnJheSBpbmRpY2VzIiwKICAiSW1tZXIgb25seSBzdXBwb3J0cyBzZXR0aW5nIGFycmF5IGluZGljZXMgYW5kIHRoZSAnbGVuZ3RoJyBwcm9wZXJ0eSIsCiAgZnVuY3Rpb24odGhpbmcpIHsKICAgIHJldHVybiBgJ29yaWdpbmFsJyBleHBlY3RzIGEgZHJhZnQsIGdvdDogJHt0aGluZ31gOwogIH0KICAvLyBOb3RlOiBpZiBtb3JlIGVycm9ycyBhcmUgYWRkZWQsIHRoZSBlcnJvck9mZnNldCBpbiBQYXRjaGVzLnRzIHNob3VsZCBiZSBpbmNyZWFzZWQKICAvLyBTZWUgUGF0Y2hlcy50cyBmb3IgYWRkaXRpb25hbCBlcnJvcnMKXSA6IFtdOwpmdW5jdGlvbiBkaWUyKGVycm9yLCAuLi5hcmdzKSB7CiAgaWYgKHRydWUpIHsKICAgIGNvbnN0IGUgPSBlcnJvcnMyW2Vycm9yXTsKICAgIGNvbnN0IG1zZyA9IHR5cGVvZiBlID09PSAiZnVuY3Rpb24iID8gZS5hcHBseShudWxsLCBhcmdzKSA6IGU7CiAgICB0aHJvdyBuZXcgRXJyb3IoYFtJbW1lcl0gJHttc2d9YCk7CiAgfQogIHRocm93IG5ldyBFcnJvcigKICAgIGBbSW1tZXJdIG1pbmlmaWVkIGVycm9yIG5yOiAke2Vycm9yfS4gRnVsbCBlcnJvciBhdDogaHR0cHM6Ly9iaXQubHkvM2NYRUtXZmAKICApOwp9CnZhciBnZXRQcm90b3R5cGVPZjIgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Y7CmZ1bmN0aW9uIGlzRHJhZnQyKHZhbHVlKSB7CiAgcmV0dXJuICEhdmFsdWUgJiYgISF2YWx1ZVtEUkFGVF9TVEFURTJdOwp9CmZ1bmN0aW9uIGlzRHJhZnRhYmxlMih2YWx1ZSkgewogIGlmICghdmFsdWUpCiAgICByZXR1cm4gZmFsc2U7CiAgcmV0dXJuIGlzUGxhaW5PYmplY3QzKHZhbHVlKSB8fCBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCAhIXZhbHVlW0RSQUZUQUJMRTJdIHx8ICEhdmFsdWUuY29uc3RydWN0b3I/LltEUkFGVEFCTEUyXSB8fCBpc01hcDIodmFsdWUpIHx8IGlzU2V0Mih2YWx1ZSk7Cn0KdmFyIG9iamVjdEN0b3JTdHJpbmcyID0gT2JqZWN0LnByb3RvdHlwZS5jb25zdHJ1Y3Rvci50b1N0cmluZygpOwp2YXIgY2FjaGVkQ3RvclN0cmluZ3MyID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CmZ1bmN0aW9uIGlzUGxhaW5PYmplY3QzKHZhbHVlKSB7CiAgaWYgKCF2YWx1ZSB8fCB0eXBlb2YgdmFsdWUgIT09ICJvYmplY3QiKQogICAgcmV0dXJuIGZhbHNlOwogIGNvbnN0IHByb3RvMiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih2YWx1ZSk7CiAgaWYgKHByb3RvMiA9PT0gbnVsbCB8fCBwcm90bzIgPT09IE9iamVjdC5wcm90b3R5cGUpCiAgICByZXR1cm4gdHJ1ZTsKICBjb25zdCBDdG9yID0gT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwocHJvdG8yLCAiY29uc3RydWN0b3IiKSAmJiBwcm90bzIuY29uc3RydWN0b3I7CiAgaWYgKEN0b3IgPT09IE9iamVjdCkKICAgIHJldHVybiB0cnVlOwogIGlmICh0eXBlb2YgQ3RvciAhPT0gImZ1bmN0aW9uIikKICAgIHJldHVybiBmYWxzZTsKICBsZXQgY3RvclN0cmluZyA9IGNhY2hlZEN0b3JTdHJpbmdzMi5nZXQoQ3Rvcik7CiAgaWYgKGN0b3JTdHJpbmcgPT09IHZvaWQgMCkgewogICAgY3RvclN0cmluZyA9IEZ1bmN0aW9uLnRvU3RyaW5nLmNhbGwoQ3Rvcik7CiAgICBjYWNoZWRDdG9yU3RyaW5nczIuc2V0KEN0b3IsIGN0b3JTdHJpbmcpOwogIH0KICByZXR1cm4gY3RvclN0cmluZyA9PT0gb2JqZWN0Q3RvclN0cmluZzI7Cn0KZnVuY3Rpb24gZWFjaDIob2JqLCBpdGVyLCBzdHJpY3QgPSB0cnVlKSB7CiAgaWYgKGdldEFyY2h0eXBlMihvYmopID09PSAwKSB7CiAgICBjb25zdCBrZXlzID0gc3RyaWN0ID8gUmVmbGVjdC5vd25LZXlzKG9iaikgOiBPYmplY3Qua2V5cyhvYmopOwogICAga2V5cy5mb3JFYWNoKChrZXkpID0+IHsKICAgICAgaXRlcihrZXksIG9ialtrZXldLCBvYmopOwogICAgfSk7CiAgfSBlbHNlIHsKICAgIG9iai5mb3JFYWNoKChlbnRyeSwgaW5kZXgpID0+IGl0ZXIoaW5kZXgsIGVudHJ5LCBvYmopKTsKICB9Cn0KZnVuY3Rpb24gZ2V0QXJjaHR5cGUyKHRoaW5nKSB7CiAgY29uc3Qgc3RhdGUgPSB0aGluZ1tEUkFGVF9TVEFURTJdOwogIHJldHVybiBzdGF0ZSA/IHN0YXRlLnR5cGVfIDogQXJyYXkuaXNBcnJheSh0aGluZykgPyAxIDogaXNNYXAyKHRoaW5nKSA/IDIgOiBpc1NldDIodGhpbmcpID8gMyA6IDA7Cn0KZnVuY3Rpb24gaGFzMih0aGluZywgcHJvcCkgewogIHJldHVybiBnZXRBcmNodHlwZTIodGhpbmcpID09PSAyID8gdGhpbmcuaGFzKHByb3ApIDogT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaW5nLCBwcm9wKTsKfQpmdW5jdGlvbiBzZXQyKHRoaW5nLCBwcm9wT3JPbGRWYWx1ZSwgdmFsdWUpIHsKICBjb25zdCB0ID0gZ2V0QXJjaHR5cGUyKHRoaW5nKTsKICBpZiAodCA9PT0gMikKICAgIHRoaW5nLnNldChwcm9wT3JPbGRWYWx1ZSwgdmFsdWUpOwogIGVsc2UgaWYgKHQgPT09IDMpIHsKICAgIHRoaW5nLmFkZCh2YWx1ZSk7CiAgfSBlbHNlCiAgICB0aGluZ1twcm9wT3JPbGRWYWx1ZV0gPSB2YWx1ZTsKfQpmdW5jdGlvbiBpczIoeDIsIHkyKSB7CiAgaWYgKHgyID09PSB5MikgewogICAgcmV0dXJuIHgyICE9PSAwIHx8IDEgLyB4MiA9PT0gMSAvIHkyOwogIH0gZWxzZSB7CiAgICByZXR1cm4geDIgIT09IHgyICYmIHkyICE9PSB5MjsKICB9Cn0KZnVuY3Rpb24gaXNNYXAyKHRhcmdldCkgewogIHJldHVybiB0YXJnZXQgaW5zdGFuY2VvZiBNYXA7Cn0KZnVuY3Rpb24gaXNTZXQyKHRhcmdldCkgewogIHJldHVybiB0YXJnZXQgaW5zdGFuY2VvZiBTZXQ7Cn0KZnVuY3Rpb24gbGF0ZXN0MihzdGF0ZSkgewogIHJldHVybiBzdGF0ZS5jb3B5XyB8fCBzdGF0ZS5iYXNlXzsKfQpmdW5jdGlvbiBzaGFsbG93Q29weTIoYmFzZSwgc3RyaWN0KSB7CiAgaWYgKGlzTWFwMihiYXNlKSkgewogICAgcmV0dXJuIG5ldyBNYXAoYmFzZSk7CiAgfQogIGlmIChpc1NldDIoYmFzZSkpIHsKICAgIHJldHVybiBuZXcgU2V0KGJhc2UpOwogIH0KICBpZiAoQXJyYXkuaXNBcnJheShiYXNlKSkKICAgIHJldHVybiBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChiYXNlKTsKICBjb25zdCBpc1BsYWluMiA9IGlzUGxhaW5PYmplY3QzKGJhc2UpOwogIGlmIChzdHJpY3QgPT09IHRydWUgfHwgc3RyaWN0ID09PSAiY2xhc3Nfb25seSIgJiYgIWlzUGxhaW4yKSB7CiAgICBjb25zdCBkZXNjcmlwdG9ycyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKGJhc2UpOwogICAgZGVsZXRlIGRlc2NyaXB0b3JzW0RSQUZUX1NUQVRFMl07CiAgICBsZXQga2V5cyA9IFJlZmxlY3Qub3duS2V5cyhkZXNjcmlwdG9ycyk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgY29uc3Qga2V5ID0ga2V5c1tpXTsKICAgICAgY29uc3QgZGVzYyA9IGRlc2NyaXB0b3JzW2tleV07CiAgICAgIGlmIChkZXNjLndyaXRhYmxlID09PSBmYWxzZSkgewogICAgICAgIGRlc2Mud3JpdGFibGUgPSB0cnVlOwogICAgICAgIGRlc2MuY29uZmlndXJhYmxlID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoZGVzYy5nZXQgfHwgZGVzYy5zZXQpCiAgICAgICAgZGVzY3JpcHRvcnNba2V5XSA9IHsKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgLy8gY291bGQgbGl2ZSB3aXRoICEhZGVzYy5zZXQgYXMgd2VsbCBoZXJlLi4uCiAgICAgICAgICBlbnVtZXJhYmxlOiBkZXNjLmVudW1lcmFibGUsCiAgICAgICAgICB2YWx1ZTogYmFzZVtrZXldCiAgICAgICAgfTsKICAgIH0KICAgIHJldHVybiBPYmplY3QuY3JlYXRlKGdldFByb3RvdHlwZU9mMihiYXNlKSwgZGVzY3JpcHRvcnMpOwogIH0gZWxzZSB7CiAgICBjb25zdCBwcm90bzIgPSBnZXRQcm90b3R5cGVPZjIoYmFzZSk7CiAgICBpZiAocHJvdG8yICE9PSBudWxsICYmIGlzUGxhaW4yKSB7CiAgICAgIHJldHVybiB7IC4uLmJhc2UgfTsKICAgIH0KICAgIGNvbnN0IG9iaiA9IE9iamVjdC5jcmVhdGUocHJvdG8yKTsKICAgIHJldHVybiBPYmplY3QuYXNzaWduKG9iaiwgYmFzZSk7CiAgfQp9CmZ1bmN0aW9uIGZyZWV6ZTIob2JqLCBkZWVwID0gZmFsc2UpIHsKICBpZiAoaXNGcm96ZW4yKG9iaikgfHwgaXNEcmFmdDIob2JqKSB8fCAhaXNEcmFmdGFibGUyKG9iaikpCiAgICByZXR1cm4gb2JqOwogIGlmIChnZXRBcmNodHlwZTIob2JqKSA+IDEpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKG9iaiwgewogICAgICBzZXQ6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZTIsCiAgICAgIGFkZDogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlMiwKICAgICAgY2xlYXI6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZTIsCiAgICAgIGRlbGV0ZTogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlMgogICAgfSk7CiAgfQogIE9iamVjdC5mcmVlemUob2JqKTsKICBpZiAoZGVlcCkKICAgIE9iamVjdC52YWx1ZXMob2JqKS5mb3JFYWNoKCh2YWx1ZSkgPT4gZnJlZXplMih2YWx1ZSwgdHJ1ZSkpOwogIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gZG9udE11dGF0ZUZyb3plbkNvbGxlY3Rpb25zMigpIHsKICBkaWUyKDIpOwp9CnZhciBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUyID0gewogIHZhbHVlOiBkb250TXV0YXRlRnJvemVuQ29sbGVjdGlvbnMyCn07CmZ1bmN0aW9uIGlzRnJvemVuMihvYmopIHsKICBpZiAob2JqID09PSBudWxsIHx8IHR5cGVvZiBvYmogIT09ICJvYmplY3QiKQogICAgcmV0dXJuIHRydWU7CiAgcmV0dXJuIE9iamVjdC5pc0Zyb3plbihvYmopOwp9CnZhciBwbHVnaW5zMiA9IHt9OwpmdW5jdGlvbiBnZXRQbHVnaW4yKHBsdWdpbktleSkgewogIGNvbnN0IHBsdWdpbiA9IHBsdWdpbnMyW3BsdWdpbktleV07CiAgaWYgKCFwbHVnaW4pIHsKICAgIGRpZTIoMCwgcGx1Z2luS2V5KTsKICB9CiAgcmV0dXJuIHBsdWdpbjsKfQp2YXIgY3VycmVudFNjb3BlMjsKZnVuY3Rpb24gZ2V0Q3VycmVudFNjb3BlMigpIHsKICByZXR1cm4gY3VycmVudFNjb3BlMjsKfQpmdW5jdGlvbiBjcmVhdGVTY29wZTIocGFyZW50XywgaW1tZXJfKSB7CiAgcmV0dXJuIHsKICAgIGRyYWZ0c186IFtdLAogICAgcGFyZW50XywKICAgIGltbWVyXywKICAgIC8vIFdoZW5ldmVyIHRoZSBtb2RpZmllZCBkcmFmdCBjb250YWlucyBhIGRyYWZ0IGZyb20gYW5vdGhlciBzY29wZSwgd2UKICAgIC8vIG5lZWQgdG8gcHJldmVudCBhdXRvLWZyZWV6aW5nIHNvIHRoZSB1bm93bmVkIGRyYWZ0IGNhbiBiZSBmaW5hbGl6ZWQuCiAgICBjYW5BdXRvRnJlZXplXzogdHJ1ZSwKICAgIHVuZmluYWxpemVkRHJhZnRzXzogMAogIH07Cn0KZnVuY3Rpb24gdXNlUGF0Y2hlc0luU2NvcGUyKHNjb3BlLCBwYXRjaExpc3RlbmVyKSB7CiAgaWYgKHBhdGNoTGlzdGVuZXIpIHsKICAgIGdldFBsdWdpbjIoIlBhdGNoZXMiKTsKICAgIHNjb3BlLnBhdGNoZXNfID0gW107CiAgICBzY29wZS5pbnZlcnNlUGF0Y2hlc18gPSBbXTsKICAgIHNjb3BlLnBhdGNoTGlzdGVuZXJfID0gcGF0Y2hMaXN0ZW5lcjsKICB9Cn0KZnVuY3Rpb24gcmV2b2tlU2NvcGUyKHNjb3BlKSB7CiAgbGVhdmVTY29wZTIoc2NvcGUpOwogIHNjb3BlLmRyYWZ0c18uZm9yRWFjaChyZXZva2VEcmFmdDIpOwogIHNjb3BlLmRyYWZ0c18gPSBudWxsOwp9CmZ1bmN0aW9uIGxlYXZlU2NvcGUyKHNjb3BlKSB7CiAgaWYgKHNjb3BlID09PSBjdXJyZW50U2NvcGUyKSB7CiAgICBjdXJyZW50U2NvcGUyID0gc2NvcGUucGFyZW50XzsKICB9Cn0KZnVuY3Rpb24gZW50ZXJTY29wZTIoaW1tZXIyMikgewogIHJldHVybiBjdXJyZW50U2NvcGUyID0gY3JlYXRlU2NvcGUyKGN1cnJlbnRTY29wZTIsIGltbWVyMjIpOwp9CmZ1bmN0aW9uIHJldm9rZURyYWZ0MihkcmFmdCkgewogIGNvbnN0IHN0YXRlID0gZHJhZnRbRFJBRlRfU1RBVEUyXTsKICBpZiAoc3RhdGUudHlwZV8gPT09IDAgfHwgc3RhdGUudHlwZV8gPT09IDEpCiAgICBzdGF0ZS5yZXZva2VfKCk7CiAgZWxzZQogICAgc3RhdGUucmV2b2tlZF8gPSB0cnVlOwp9CmZ1bmN0aW9uIHByb2Nlc3NSZXN1bHQyKHJlc3VsdCwgc2NvcGUpIHsKICBzY29wZS51bmZpbmFsaXplZERyYWZ0c18gPSBzY29wZS5kcmFmdHNfLmxlbmd0aDsKICBjb25zdCBiYXNlRHJhZnQgPSBzY29wZS5kcmFmdHNfWzBdOwogIGNvbnN0IGlzUmVwbGFjZWQgPSByZXN1bHQgIT09IHZvaWQgMCAmJiByZXN1bHQgIT09IGJhc2VEcmFmdDsKICBpZiAoaXNSZXBsYWNlZCkgewogICAgaWYgKGJhc2VEcmFmdFtEUkFGVF9TVEFURTJdLm1vZGlmaWVkXykgewogICAgICByZXZva2VTY29wZTIoc2NvcGUpOwogICAgICBkaWUyKDQpOwogICAgfQogICAgaWYgKGlzRHJhZnRhYmxlMihyZXN1bHQpKSB7CiAgICAgIHJlc3VsdCA9IGZpbmFsaXplMihzY29wZSwgcmVzdWx0KTsKICAgICAgaWYgKCFzY29wZS5wYXJlbnRfKQogICAgICAgIG1heWJlRnJlZXplMihzY29wZSwgcmVzdWx0KTsKICAgIH0KICAgIGlmIChzY29wZS5wYXRjaGVzXykgewogICAgICBnZXRQbHVnaW4yKCJQYXRjaGVzIikuZ2VuZXJhdGVSZXBsYWNlbWVudFBhdGNoZXNfKAogICAgICAgIGJhc2VEcmFmdFtEUkFGVF9TVEFURTJdLmJhc2VfLAogICAgICAgIHJlc3VsdCwKICAgICAgICBzY29wZS5wYXRjaGVzXywKICAgICAgICBzY29wZS5pbnZlcnNlUGF0Y2hlc18KICAgICAgKTsKICAgIH0KICB9IGVsc2UgewogICAgcmVzdWx0ID0gZmluYWxpemUyKHNjb3BlLCBiYXNlRHJhZnQsIFtdKTsKICB9CiAgcmV2b2tlU2NvcGUyKHNjb3BlKTsKICBpZiAoc2NvcGUucGF0Y2hlc18pIHsKICAgIHNjb3BlLnBhdGNoTGlzdGVuZXJfKHNjb3BlLnBhdGNoZXNfLCBzY29wZS5pbnZlcnNlUGF0Y2hlc18pOwogIH0KICByZXR1cm4gcmVzdWx0ICE9PSBOT1RISU5HMiA/IHJlc3VsdCA6IHZvaWQgMDsKfQpmdW5jdGlvbiBmaW5hbGl6ZTIocm9vdFNjb3BlLCB2YWx1ZSwgcGF0aDIpIHsKICBpZiAoaXNGcm96ZW4yKHZhbHVlKSkKICAgIHJldHVybiB2YWx1ZTsKICBjb25zdCB1c2VTdHJpY3RJdGVyYXRpb24gPSByb290U2NvcGUuaW1tZXJfLnNob3VsZFVzZVN0cmljdEl0ZXJhdGlvbigpOwogIGNvbnN0IHN0YXRlID0gdmFsdWVbRFJBRlRfU1RBVEUyXTsKICBpZiAoIXN0YXRlKSB7CiAgICBlYWNoMigKICAgICAgdmFsdWUsCiAgICAgIChrZXksIGNoaWxkVmFsdWUpID0+IGZpbmFsaXplUHJvcGVydHkocm9vdFNjb3BlLCBzdGF0ZSwgdmFsdWUsIGtleSwgY2hpbGRWYWx1ZSwgcGF0aDIpLAogICAgICB1c2VTdHJpY3RJdGVyYXRpb24KICAgICk7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGlmIChzdGF0ZS5zY29wZV8gIT09IHJvb3RTY29wZSkKICAgIHJldHVybiB2YWx1ZTsKICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgbWF5YmVGcmVlemUyKHJvb3RTY29wZSwgc3RhdGUuYmFzZV8sIHRydWUpOwogICAgcmV0dXJuIHN0YXRlLmJhc2VfOwogIH0KICBpZiAoIXN0YXRlLmZpbmFsaXplZF8pIHsKICAgIHN0YXRlLmZpbmFsaXplZF8gPSB0cnVlOwogICAgc3RhdGUuc2NvcGVfLnVuZmluYWxpemVkRHJhZnRzXy0tOwogICAgY29uc3QgcmVzdWx0ID0gc3RhdGUuY29weV87CiAgICBsZXQgcmVzdWx0RWFjaCA9IHJlc3VsdDsKICAgIGxldCBpc1NldDIyID0gZmFsc2U7CiAgICBpZiAoc3RhdGUudHlwZV8gPT09IDMpIHsKICAgICAgcmVzdWx0RWFjaCA9IG5ldyBTZXQocmVzdWx0KTsKICAgICAgcmVzdWx0LmNsZWFyKCk7CiAgICAgIGlzU2V0MjIgPSB0cnVlOwogICAgfQogICAgZWFjaDIoCiAgICAgIHJlc3VsdEVhY2gsCiAgICAgIChrZXksIGNoaWxkVmFsdWUpID0+IGZpbmFsaXplUHJvcGVydHkoCiAgICAgICAgcm9vdFNjb3BlLAogICAgICAgIHN0YXRlLAogICAgICAgIHJlc3VsdCwKICAgICAgICBrZXksCiAgICAgICAgY2hpbGRWYWx1ZSwKICAgICAgICBwYXRoMiwKICAgICAgICBpc1NldDIyCiAgICAgICksCiAgICAgIHVzZVN0cmljdEl0ZXJhdGlvbgogICAgKTsKICAgIG1heWJlRnJlZXplMihyb290U2NvcGUsIHJlc3VsdCwgZmFsc2UpOwogICAgaWYgKHBhdGgyICYmIHJvb3RTY29wZS5wYXRjaGVzXykgewogICAgICBnZXRQbHVnaW4yKCJQYXRjaGVzIikuZ2VuZXJhdGVQYXRjaGVzXygKICAgICAgICBzdGF0ZSwKICAgICAgICBwYXRoMiwKICAgICAgICByb290U2NvcGUucGF0Y2hlc18sCiAgICAgICAgcm9vdFNjb3BlLmludmVyc2VQYXRjaGVzXwogICAgICApOwogICAgfQogIH0KICByZXR1cm4gc3RhdGUuY29weV87Cn0KZnVuY3Rpb24gZmluYWxpemVQcm9wZXJ0eShyb290U2NvcGUsIHBhcmVudFN0YXRlLCB0YXJnZXRPYmplY3QsIHByb3AsIGNoaWxkVmFsdWUsIHJvb3RQYXRoLCB0YXJnZXRJc1NldCkgewogIGlmIChjaGlsZFZhbHVlID09IG51bGwpIHsKICAgIHJldHVybjsKICB9CiAgaWYgKHR5cGVvZiBjaGlsZFZhbHVlICE9PSAib2JqZWN0IiAmJiAhdGFyZ2V0SXNTZXQpIHsKICAgIHJldHVybjsKICB9CiAgY29uc3QgY2hpbGRJc0Zyb3plbiA9IGlzRnJvemVuMihjaGlsZFZhbHVlKTsKICBpZiAoY2hpbGRJc0Zyb3plbiAmJiAhdGFyZ2V0SXNTZXQpIHsKICAgIHJldHVybjsKICB9CiAgaWYgKGNoaWxkVmFsdWUgPT09IHRhcmdldE9iamVjdCkKICAgIGRpZTIoNSk7CiAgaWYgKGlzRHJhZnQyKGNoaWxkVmFsdWUpKSB7CiAgICBjb25zdCBwYXRoMiA9IHJvb3RQYXRoICYmIHBhcmVudFN0YXRlICYmIHBhcmVudFN0YXRlLnR5cGVfICE9PSAzICYmIC8vIFNldCBvYmplY3RzIGFyZSBhdG9taWMgc2luY2UgdGhleSBoYXZlIG5vIGtleXMuCiAgICAhaGFzMihwYXJlbnRTdGF0ZS5hc3NpZ25lZF8sIHByb3ApID8gcm9vdFBhdGguY29uY2F0KHByb3ApIDogdm9pZCAwOwogICAgY29uc3QgcmVzID0gZmluYWxpemUyKHJvb3RTY29wZSwgY2hpbGRWYWx1ZSwgcGF0aDIpOwogICAgc2V0Mih0YXJnZXRPYmplY3QsIHByb3AsIHJlcyk7CiAgICBpZiAoaXNEcmFmdDIocmVzKSkgewogICAgICByb290U2NvcGUuY2FuQXV0b0ZyZWV6ZV8gPSBmYWxzZTsKICAgIH0gZWxzZQogICAgICByZXR1cm47CiAgfSBlbHNlIGlmICh0YXJnZXRJc1NldCkgewogICAgdGFyZ2V0T2JqZWN0LmFkZChjaGlsZFZhbHVlKTsKICB9CiAgaWYgKGlzRHJhZnRhYmxlMihjaGlsZFZhbHVlKSAmJiAhY2hpbGRJc0Zyb3plbikgewogICAgaWYgKCFyb290U2NvcGUuaW1tZXJfLmF1dG9GcmVlemVfICYmIHJvb3RTY29wZS51bmZpbmFsaXplZERyYWZ0c18gPCAxKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChwYXJlbnRTdGF0ZSAmJiBwYXJlbnRTdGF0ZS5iYXNlXyAmJiBwYXJlbnRTdGF0ZS5iYXNlX1twcm9wXSA9PT0gY2hpbGRWYWx1ZSAmJiBjaGlsZElzRnJvemVuKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGZpbmFsaXplMihyb290U2NvcGUsIGNoaWxkVmFsdWUpOwogICAgaWYgKCghcGFyZW50U3RhdGUgfHwgIXBhcmVudFN0YXRlLnNjb3BlXy5wYXJlbnRfKSAmJiB0eXBlb2YgcHJvcCAhPT0gInN5bWJvbCIgJiYgKGlzTWFwMih0YXJnZXRPYmplY3QpID8gdGFyZ2V0T2JqZWN0Lmhhcyhwcm9wKSA6IE9iamVjdC5wcm90b3R5cGUucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbCh0YXJnZXRPYmplY3QsIHByb3ApKSkKICAgICAgbWF5YmVGcmVlemUyKHJvb3RTY29wZSwgY2hpbGRWYWx1ZSk7CiAgfQp9CmZ1bmN0aW9uIG1heWJlRnJlZXplMihzY29wZSwgdmFsdWUsIGRlZXAgPSBmYWxzZSkgewogIGlmICghc2NvcGUucGFyZW50XyAmJiBzY29wZS5pbW1lcl8uYXV0b0ZyZWV6ZV8gJiYgc2NvcGUuY2FuQXV0b0ZyZWV6ZV8pIHsKICAgIGZyZWV6ZTIodmFsdWUsIGRlZXApOwogIH0KfQpmdW5jdGlvbiBjcmVhdGVQcm94eVByb3h5MihiYXNlLCBwYXJlbnQpIHsKICBjb25zdCBpc0FycmF5MiA9IEFycmF5LmlzQXJyYXkoYmFzZSk7CiAgY29uc3Qgc3RhdGUgPSB7CiAgICB0eXBlXzogaXNBcnJheTIgPyAxIDogMCwKICAgIC8vIFRyYWNrIHdoaWNoIHByb2R1Y2UgY2FsbCB0aGlzIGlzIGFzc29jaWF0ZWQgd2l0aC4KICAgIHNjb3BlXzogcGFyZW50ID8gcGFyZW50LnNjb3BlXyA6IGdldEN1cnJlbnRTY29wZTIoKSwKICAgIC8vIFRydWUgZm9yIGJvdGggc2hhbGxvdyBhbmQgZGVlcCBjaGFuZ2VzLgogICAgbW9kaWZpZWRfOiBmYWxzZSwKICAgIC8vIFVzZWQgZHVyaW5nIGZpbmFsaXphdGlvbi4KICAgIGZpbmFsaXplZF86IGZhbHNlLAogICAgLy8gVHJhY2sgd2hpY2ggcHJvcGVydGllcyBoYXZlIGJlZW4gYXNzaWduZWQgKHRydWUpIG9yIGRlbGV0ZWQgKGZhbHNlKS4KICAgIGFzc2lnbmVkXzoge30sCiAgICAvLyBUaGUgcGFyZW50IGRyYWZ0IHN0YXRlLgogICAgcGFyZW50XzogcGFyZW50LAogICAgLy8gVGhlIGJhc2Ugc3RhdGUuCiAgICBiYXNlXzogYmFzZSwKICAgIC8vIFRoZSBiYXNlIHByb3h5LgogICAgZHJhZnRfOiBudWxsLAogICAgLy8gc2V0IGJlbG93CiAgICAvLyBUaGUgYmFzZSBjb3B5IHdpdGggYW55IHVwZGF0ZWQgdmFsdWVzLgogICAgY29weV86IG51bGwsCiAgICAvLyBDYWxsZWQgYnkgdGhlIGBwcm9kdWNlYCBmdW5jdGlvbi4KICAgIHJldm9rZV86IG51bGwsCiAgICBpc01hbnVhbF86IGZhbHNlCiAgfTsKICBsZXQgdGFyZ2V0ID0gc3RhdGU7CiAgbGV0IHRyYXBzID0gb2JqZWN0VHJhcHMyOwogIGlmIChpc0FycmF5MikgewogICAgdGFyZ2V0ID0gW3N0YXRlXTsKICAgIHRyYXBzID0gYXJyYXlUcmFwczI7CiAgfQogIGNvbnN0IHsgcmV2b2tlLCBwcm94eSB9ID0gUHJveHkucmV2b2NhYmxlKHRhcmdldCwgdHJhcHMpOwogIHN0YXRlLmRyYWZ0XyA9IHByb3h5OwogIHN0YXRlLnJldm9rZV8gPSByZXZva2U7CiAgcmV0dXJuIHByb3h5Owp9CnZhciBvYmplY3RUcmFwczIgPSB7CiAgZ2V0KHN0YXRlLCBwcm9wKSB7CiAgICBpZiAocHJvcCA9PT0gRFJBRlRfU1RBVEUyKQogICAgICByZXR1cm4gc3RhdGU7CiAgICBjb25zdCBzb3VyY2UgPSBsYXRlc3QyKHN0YXRlKTsKICAgIGlmICghaGFzMihzb3VyY2UsIHByb3ApKSB7CiAgICAgIHJldHVybiByZWFkUHJvcEZyb21Qcm90bzIoc3RhdGUsIHNvdXJjZSwgcHJvcCk7CiAgICB9CiAgICBjb25zdCB2YWx1ZSA9IHNvdXJjZVtwcm9wXTsKICAgIGlmIChzdGF0ZS5maW5hbGl6ZWRfIHx8ICFpc0RyYWZ0YWJsZTIodmFsdWUpKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIGlmICh2YWx1ZSA9PT0gcGVlazIoc3RhdGUuYmFzZV8sIHByb3ApKSB7CiAgICAgIHByZXBhcmVDb3B5MihzdGF0ZSk7CiAgICAgIHJldHVybiBzdGF0ZS5jb3B5X1twcm9wXSA9IGNyZWF0ZVByb3h5Mih2YWx1ZSwgc3RhdGUpOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0sCiAgaGFzKHN0YXRlLCBwcm9wKSB7CiAgICByZXR1cm4gcHJvcCBpbiBsYXRlc3QyKHN0YXRlKTsKICB9LAogIG93bktleXMoc3RhdGUpIHsKICAgIHJldHVybiBSZWZsZWN0Lm93bktleXMobGF0ZXN0MihzdGF0ZSkpOwogIH0sCiAgc2V0KHN0YXRlLCBwcm9wLCB2YWx1ZSkgewogICAgY29uc3QgZGVzYyA9IGdldERlc2NyaXB0b3JGcm9tUHJvdG8yKGxhdGVzdDIoc3RhdGUpLCBwcm9wKTsKICAgIGlmIChkZXNjPy5zZXQpIHsKICAgICAgZGVzYy5zZXQuY2FsbChzdGF0ZS5kcmFmdF8sIHZhbHVlKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgICBjb25zdCBjdXJyZW50MjIgPSBwZWVrMihsYXRlc3QyKHN0YXRlKSwgcHJvcCk7CiAgICAgIGNvbnN0IGN1cnJlbnRTdGF0ZSA9IGN1cnJlbnQyMj8uW0RSQUZUX1NUQVRFMl07CiAgICAgIGlmIChjdXJyZW50U3RhdGUgJiYgY3VycmVudFN0YXRlLmJhc2VfID09PSB2YWx1ZSkgewogICAgICAgIHN0YXRlLmNvcHlfW3Byb3BdID0gdmFsdWU7CiAgICAgICAgc3RhdGUuYXNzaWduZWRfW3Byb3BdID0gZmFsc2U7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKGlzMih2YWx1ZSwgY3VycmVudDIyKSAmJiAodmFsdWUgIT09IHZvaWQgMCB8fCBoYXMyKHN0YXRlLmJhc2VfLCBwcm9wKSkpCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIHByZXBhcmVDb3B5MihzdGF0ZSk7CiAgICAgIG1hcmtDaGFuZ2VkMihzdGF0ZSk7CiAgICB9CiAgICBpZiAoc3RhdGUuY29weV9bcHJvcF0gPT09IHZhbHVlICYmIC8vIHNwZWNpYWwgY2FzZTogaGFuZGxlIG5ldyBwcm9wcyB3aXRoIHZhbHVlICd1bmRlZmluZWQnCiAgICAodmFsdWUgIT09IHZvaWQgMCB8fCBwcm9wIGluIHN0YXRlLmNvcHlfKSB8fCAvLyBzcGVjaWFsIGNhc2U6IE5hTgogICAgTnVtYmVyLmlzTmFOKHZhbHVlKSAmJiBOdW1iZXIuaXNOYU4oc3RhdGUuY29weV9bcHJvcF0pKQogICAgICByZXR1cm4gdHJ1ZTsKICAgIHN0YXRlLmNvcHlfW3Byb3BdID0gdmFsdWU7CiAgICBzdGF0ZS5hc3NpZ25lZF9bcHJvcF0gPSB0cnVlOwogICAgcmV0dXJuIHRydWU7CiAgfSwKICBkZWxldGVQcm9wZXJ0eShzdGF0ZSwgcHJvcCkgewogICAgaWYgKHBlZWsyKHN0YXRlLmJhc2VfLCBwcm9wKSAhPT0gdm9pZCAwIHx8IHByb3AgaW4gc3RhdGUuYmFzZV8pIHsKICAgICAgc3RhdGUuYXNzaWduZWRfW3Byb3BdID0gZmFsc2U7CiAgICAgIHByZXBhcmVDb3B5MihzdGF0ZSk7CiAgICAgIG1hcmtDaGFuZ2VkMihzdGF0ZSk7CiAgICB9IGVsc2UgewogICAgICBkZWxldGUgc3RhdGUuYXNzaWduZWRfW3Byb3BdOwogICAgfQogICAgaWYgKHN0YXRlLmNvcHlfKSB7CiAgICAgIGRlbGV0ZSBzdGF0ZS5jb3B5X1twcm9wXTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0sCiAgLy8gTm90ZTogV2UgbmV2ZXIgY29lcmNlIGBkZXNjLnZhbHVlYCBpbnRvIGFuIEltbWVyIGRyYWZ0LCBiZWNhdXNlIHdlIGNhbid0IG1ha2UKICAvLyB0aGUgc2FtZSBndWFyYW50ZWUgaW4gRVM1IG1vZGUuCiAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHN0YXRlLCBwcm9wKSB7CiAgICBjb25zdCBvd25lciA9IGxhdGVzdDIoc3RhdGUpOwogICAgY29uc3QgZGVzYyA9IFJlZmxlY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG93bmVyLCBwcm9wKTsKICAgIGlmICghZGVzYykKICAgICAgcmV0dXJuIGRlc2M7CiAgICByZXR1cm4gewogICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgY29uZmlndXJhYmxlOiBzdGF0ZS50eXBlXyAhPT0gMSB8fCBwcm9wICE9PSAibGVuZ3RoIiwKICAgICAgZW51bWVyYWJsZTogZGVzYy5lbnVtZXJhYmxlLAogICAgICB2YWx1ZTogb3duZXJbcHJvcF0KICAgIH07CiAgfSwKICBkZWZpbmVQcm9wZXJ0eSgpIHsKICAgIGRpZTIoMTEpOwogIH0sCiAgZ2V0UHJvdG90eXBlT2Yoc3RhdGUpIHsKICAgIHJldHVybiBnZXRQcm90b3R5cGVPZjIoc3RhdGUuYmFzZV8pOwogIH0sCiAgc2V0UHJvdG90eXBlT2YoKSB7CiAgICBkaWUyKDEyKTsKICB9Cn07CnZhciBhcnJheVRyYXBzMiA9IHt9OwplYWNoMihvYmplY3RUcmFwczIsIChrZXksIGZuKSA9PiB7CiAgYXJyYXlUcmFwczJba2V5XSA9IGZ1bmN0aW9uKCkgewogICAgYXJndW1lbnRzWzBdID0gYXJndW1lbnRzWzBdWzBdOwogICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKfSk7CmFycmF5VHJhcHMyLmRlbGV0ZVByb3BlcnR5ID0gZnVuY3Rpb24oc3RhdGUsIHByb3ApIHsKICBpZiAoaXNOYU4ocGFyc2VJbnQocHJvcCkpKQogICAgZGllMigxMyk7CiAgcmV0dXJuIGFycmF5VHJhcHMyLnNldC5jYWxsKHRoaXMsIHN0YXRlLCBwcm9wLCB2b2lkIDApOwp9OwphcnJheVRyYXBzMi5zZXQgPSBmdW5jdGlvbihzdGF0ZSwgcHJvcCwgdmFsdWUpIHsKICBpZiAocHJvcCAhPT0gImxlbmd0aCIgJiYgaXNOYU4ocGFyc2VJbnQocHJvcCkpKQogICAgZGllMigxNCk7CiAgcmV0dXJuIG9iamVjdFRyYXBzMi5zZXQuY2FsbCh0aGlzLCBzdGF0ZVswXSwgcHJvcCwgdmFsdWUsIHN0YXRlWzBdKTsKfTsKZnVuY3Rpb24gcGVlazIoZHJhZnQsIHByb3ApIHsKICBjb25zdCBzdGF0ZSA9IGRyYWZ0W0RSQUZUX1NUQVRFMl07CiAgY29uc3Qgc291cmNlID0gc3RhdGUgPyBsYXRlc3QyKHN0YXRlKSA6IGRyYWZ0OwogIHJldHVybiBzb3VyY2VbcHJvcF07Cn0KZnVuY3Rpb24gcmVhZFByb3BGcm9tUHJvdG8yKHN0YXRlLCBzb3VyY2UsIHByb3ApIHsKICBjb25zdCBkZXNjID0gZ2V0RGVzY3JpcHRvckZyb21Qcm90bzIoc291cmNlLCBwcm9wKTsKICByZXR1cm4gZGVzYyA/IGB2YWx1ZWAgaW4gZGVzYyA/IGRlc2MudmFsdWUgOiAoCiAgICAvLyBUaGlzIGlzIGEgdmVyeSBzcGVjaWFsIGNhc2UsIGlmIHRoZSBwcm9wIGlzIGEgZ2V0dGVyIGRlZmluZWQgYnkgdGhlCiAgICAvLyBwcm90b3R5cGUsIHdlIHNob3VsZCBpbnZva2UgaXQgd2l0aCB0aGUgZHJhZnQgYXMgY29udGV4dCEKICAgIGRlc2MuZ2V0Py5jYWxsKHN0YXRlLmRyYWZ0XykKICApIDogdm9pZCAwOwp9CmZ1bmN0aW9uIGdldERlc2NyaXB0b3JGcm9tUHJvdG8yKHNvdXJjZSwgcHJvcCkgewogIGlmICghKHByb3AgaW4gc291cmNlKSkKICAgIHJldHVybiB2b2lkIDA7CiAgbGV0IHByb3RvMiA9IGdldFByb3RvdHlwZU9mMihzb3VyY2UpOwogIHdoaWxlIChwcm90bzIpIHsKICAgIGNvbnN0IGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHByb3RvMiwgcHJvcCk7CiAgICBpZiAoZGVzYykKICAgICAgcmV0dXJuIGRlc2M7CiAgICBwcm90bzIgPSBnZXRQcm90b3R5cGVPZjIocHJvdG8yKTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQpmdW5jdGlvbiBtYXJrQ2hhbmdlZDIoc3RhdGUpIHsKICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgc3RhdGUubW9kaWZpZWRfID0gdHJ1ZTsKICAgIGlmIChzdGF0ZS5wYXJlbnRfKSB7CiAgICAgIG1hcmtDaGFuZ2VkMihzdGF0ZS5wYXJlbnRfKTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gcHJlcGFyZUNvcHkyKHN0YXRlKSB7CiAgaWYgKCFzdGF0ZS5jb3B5XykgewogICAgc3RhdGUuY29weV8gPSBzaGFsbG93Q29weTIoCiAgICAgIHN0YXRlLmJhc2VfLAogICAgICBzdGF0ZS5zY29wZV8uaW1tZXJfLnVzZVN0cmljdFNoYWxsb3dDb3B5XwogICAgKTsKICB9Cn0KdmFyIEltbWVyMjIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY29uZmlnKSB7CiAgICB0aGlzLmF1dG9GcmVlemVfID0gdHJ1ZTsKICAgIHRoaXMudXNlU3RyaWN0U2hhbGxvd0NvcHlfID0gZmFsc2U7CiAgICB0aGlzLnVzZVN0cmljdEl0ZXJhdGlvbl8gPSB0cnVlOwogICAgdGhpcy5wcm9kdWNlID0gKGJhc2UsIHJlY2lwZSwgcGF0Y2hMaXN0ZW5lcikgPT4gewogICAgICBpZiAodHlwZW9mIGJhc2UgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIHJlY2lwZSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIGNvbnN0IGRlZmF1bHRCYXNlID0gcmVjaXBlOwogICAgICAgIHJlY2lwZSA9IGJhc2U7CiAgICAgICAgY29uc3Qgc2VsZjIgPSB0aGlzOwogICAgICAgIHJldHVybiBmdW5jdGlvbiBjdXJyaWVkUHJvZHVjZShiYXNlMiA9IGRlZmF1bHRCYXNlLCAuLi5hcmdzKSB7CiAgICAgICAgICByZXR1cm4gc2VsZjIucHJvZHVjZShiYXNlMiwgKGRyYWZ0KSA9PiByZWNpcGUuY2FsbCh0aGlzLCBkcmFmdCwgLi4uYXJncykpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiByZWNpcGUgIT09ICJmdW5jdGlvbiIpCiAgICAgICAgZGllMig2KTsKICAgICAgaWYgKHBhdGNoTGlzdGVuZXIgIT09IHZvaWQgMCAmJiB0eXBlb2YgcGF0Y2hMaXN0ZW5lciAhPT0gImZ1bmN0aW9uIikKICAgICAgICBkaWUyKDcpOwogICAgICBsZXQgcmVzdWx0OwogICAgICBpZiAoaXNEcmFmdGFibGUyKGJhc2UpKSB7CiAgICAgICAgY29uc3Qgc2NvcGUgPSBlbnRlclNjb3BlMih0aGlzKTsKICAgICAgICBjb25zdCBwcm94eSA9IGNyZWF0ZVByb3h5MihiYXNlLCB2b2lkIDApOwogICAgICAgIGxldCBoYXNFcnJvciA9IHRydWU7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJlc3VsdCA9IHJlY2lwZShwcm94eSk7CiAgICAgICAgICBoYXNFcnJvciA9IGZhbHNlOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAoaGFzRXJyb3IpCiAgICAgICAgICAgIHJldm9rZVNjb3BlMihzY29wZSk7CiAgICAgICAgICBlbHNlCiAgICAgICAgICAgIGxlYXZlU2NvcGUyKHNjb3BlKTsKICAgICAgICB9CiAgICAgICAgdXNlUGF0Y2hlc0luU2NvcGUyKHNjb3BlLCBwYXRjaExpc3RlbmVyKTsKICAgICAgICByZXR1cm4gcHJvY2Vzc1Jlc3VsdDIocmVzdWx0LCBzY29wZSk7CiAgICAgIH0gZWxzZSBpZiAoIWJhc2UgfHwgdHlwZW9mIGJhc2UgIT09ICJvYmplY3QiKSB7CiAgICAgICAgcmVzdWx0ID0gcmVjaXBlKGJhc2UpOwogICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkKICAgICAgICAgIHJlc3VsdCA9IGJhc2U7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gTk9USElORzIpCiAgICAgICAgICByZXN1bHQgPSB2b2lkIDA7CiAgICAgICAgaWYgKHRoaXMuYXV0b0ZyZWV6ZV8pCiAgICAgICAgICBmcmVlemUyKHJlc3VsdCwgdHJ1ZSk7CiAgICAgICAgaWYgKHBhdGNoTGlzdGVuZXIpIHsKICAgICAgICAgIGNvbnN0IHAgPSBbXTsKICAgICAgICAgIGNvbnN0IGlwID0gW107CiAgICAgICAgICBnZXRQbHVnaW4yKCJQYXRjaGVzIikuZ2VuZXJhdGVSZXBsYWNlbWVudFBhdGNoZXNfKGJhc2UsIHJlc3VsdCwgcCwgaXApOwogICAgICAgICAgcGF0Y2hMaXN0ZW5lcihwLCBpcCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0gZWxzZQogICAgICAgIGRpZTIoMSwgYmFzZSk7CiAgICB9OwogICAgdGhpcy5wcm9kdWNlV2l0aFBhdGNoZXMgPSAoYmFzZSwgcmVjaXBlKSA9PiB7CiAgICAgIGlmICh0eXBlb2YgYmFzZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHJldHVybiAoc3RhdGUsIC4uLmFyZ3MpID0+IHRoaXMucHJvZHVjZVdpdGhQYXRjaGVzKHN0YXRlLCAoZHJhZnQpID0+IGJhc2UoZHJhZnQsIC4uLmFyZ3MpKTsKICAgICAgfQogICAgICBsZXQgcGF0Y2hlcywgaW52ZXJzZVBhdGNoZXM7CiAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMucHJvZHVjZShiYXNlLCByZWNpcGUsIChwLCBpcCkgPT4gewogICAgICAgIHBhdGNoZXMgPSBwOwogICAgICAgIGludmVyc2VQYXRjaGVzID0gaXA7CiAgICAgIH0pOwogICAgICByZXR1cm4gW3Jlc3VsdCwgcGF0Y2hlcywgaW52ZXJzZVBhdGNoZXNdOwogICAgfTsKICAgIGlmICh0eXBlb2YgY29uZmlnPy5hdXRvRnJlZXplID09PSAiYm9vbGVhbiIpCiAgICAgIHRoaXMuc2V0QXV0b0ZyZWV6ZShjb25maWcuYXV0b0ZyZWV6ZSk7CiAgICBpZiAodHlwZW9mIGNvbmZpZz8udXNlU3RyaWN0U2hhbGxvd0NvcHkgPT09ICJib29sZWFuIikKICAgICAgdGhpcy5zZXRVc2VTdHJpY3RTaGFsbG93Q29weShjb25maWcudXNlU3RyaWN0U2hhbGxvd0NvcHkpOwogICAgaWYgKHR5cGVvZiBjb25maWc/LnVzZVN0cmljdEl0ZXJhdGlvbiA9PT0gImJvb2xlYW4iKQogICAgICB0aGlzLnNldFVzZVN0cmljdEl0ZXJhdGlvbihjb25maWcudXNlU3RyaWN0SXRlcmF0aW9uKTsKICB9CiAgY3JlYXRlRHJhZnQoYmFzZSkgewogICAgaWYgKCFpc0RyYWZ0YWJsZTIoYmFzZSkpCiAgICAgIGRpZTIoOCk7CiAgICBpZiAoaXNEcmFmdDIoYmFzZSkpCiAgICAgIGJhc2UgPSBjdXJyZW50MihiYXNlKTsKICAgIGNvbnN0IHNjb3BlID0gZW50ZXJTY29wZTIodGhpcyk7CiAgICBjb25zdCBwcm94eSA9IGNyZWF0ZVByb3h5MihiYXNlLCB2b2lkIDApOwogICAgcHJveHlbRFJBRlRfU1RBVEUyXS5pc01hbnVhbF8gPSB0cnVlOwogICAgbGVhdmVTY29wZTIoc2NvcGUpOwogICAgcmV0dXJuIHByb3h5OwogIH0KICBmaW5pc2hEcmFmdChkcmFmdCwgcGF0Y2hMaXN0ZW5lcikgewogICAgY29uc3Qgc3RhdGUgPSBkcmFmdCAmJiBkcmFmdFtEUkFGVF9TVEFURTJdOwogICAgaWYgKCFzdGF0ZSB8fCAhc3RhdGUuaXNNYW51YWxfKQogICAgICBkaWUyKDkpOwogICAgY29uc3QgeyBzY29wZV86IHNjb3BlIH0gPSBzdGF0ZTsKICAgIHVzZVBhdGNoZXNJblNjb3BlMihzY29wZSwgcGF0Y2hMaXN0ZW5lcik7CiAgICByZXR1cm4gcHJvY2Vzc1Jlc3VsdDIodm9pZCAwLCBzY29wZSk7CiAgfQogIC8qKgogICAqIFBhc3MgdHJ1ZSB0byBhdXRvbWF0aWNhbGx5IGZyZWV6ZSBhbGwgY29waWVzIGNyZWF0ZWQgYnkgSW1tZXIuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBhdXRvLWZyZWV6aW5nIGlzIGVuYWJsZWQuCiAgICovCiAgc2V0QXV0b0ZyZWV6ZSh2YWx1ZSkgewogICAgdGhpcy5hdXRvRnJlZXplXyA9IHZhbHVlOwogIH0KICAvKioKICAgKiBQYXNzIHRydWUgdG8gZW5hYmxlIHN0cmljdCBzaGFsbG93IGNvcHkuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBpbW1lciBkb2VzIG5vdCBjb3B5IHRoZSBvYmplY3QgZGVzY3JpcHRvcnMgc3VjaCBhcyBnZXR0ZXIsIHNldHRlciBhbmQgbm9uLWVudW1yYWJsZSBwcm9wZXJ0aWVzLgogICAqLwogIHNldFVzZVN0cmljdFNoYWxsb3dDb3B5KHZhbHVlKSB7CiAgICB0aGlzLnVzZVN0cmljdFNoYWxsb3dDb3B5XyA9IHZhbHVlOwogIH0KICAvKioKICAgKiBQYXNzIGZhbHNlIHRvIHVzZSBmYXN0ZXIgaXRlcmF0aW9uIHRoYXQgc2tpcHMgbm9uLWVudW1lcmFibGUgcHJvcGVydGllcwogICAqIGJ1dCBzdGlsbCBoYW5kbGVzIHN5bWJvbHMgZm9yIGNvbXBhdGliaWxpdHkuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBzdHJpY3QgaXRlcmF0aW9uIGlzIGVuYWJsZWQgKGluY2x1ZGVzIGFsbCBvd24gcHJvcGVydGllcykuCiAgICovCiAgc2V0VXNlU3RyaWN0SXRlcmF0aW9uKHZhbHVlKSB7CiAgICB0aGlzLnVzZVN0cmljdEl0ZXJhdGlvbl8gPSB2YWx1ZTsKICB9CiAgc2hvdWxkVXNlU3RyaWN0SXRlcmF0aW9uKCkgewogICAgcmV0dXJuIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXzsKICB9CiAgYXBwbHlQYXRjaGVzKGJhc2UsIHBhdGNoZXMpIHsKICAgIGxldCBpOwogICAgZm9yIChpID0gcGF0Y2hlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBwYXRjaCA9IHBhdGNoZXNbaV07CiAgICAgIGlmIChwYXRjaC5wYXRoLmxlbmd0aCA9PT0gMCAmJiBwYXRjaC5vcCA9PT0gInJlcGxhY2UiKSB7CiAgICAgICAgYmFzZSA9IHBhdGNoLnZhbHVlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBpZiAoaSA+IC0xKSB7CiAgICAgIHBhdGNoZXMgPSBwYXRjaGVzLnNsaWNlKGkgKyAxKTsKICAgIH0KICAgIGNvbnN0IGFwcGx5UGF0Y2hlc0ltcGwgPSBnZXRQbHVnaW4yKCJQYXRjaGVzIikuYXBwbHlQYXRjaGVzXzsKICAgIGlmIChpc0RyYWZ0MihiYXNlKSkgewogICAgICByZXR1cm4gYXBwbHlQYXRjaGVzSW1wbChiYXNlLCBwYXRjaGVzKTsKICAgIH0KICAgIHJldHVybiB0aGlzLnByb2R1Y2UoCiAgICAgIGJhc2UsCiAgICAgIChkcmFmdCkgPT4gYXBwbHlQYXRjaGVzSW1wbChkcmFmdCwgcGF0Y2hlcykKICAgICk7CiAgfQp9OwpmdW5jdGlvbiBjcmVhdGVQcm94eTIodmFsdWUsIHBhcmVudCkgewogIGNvbnN0IGRyYWZ0ID0gaXNNYXAyKHZhbHVlKSA/IGdldFBsdWdpbjIoIk1hcFNldCIpLnByb3h5TWFwXyh2YWx1ZSwgcGFyZW50KSA6IGlzU2V0Mih2YWx1ZSkgPyBnZXRQbHVnaW4yKCJNYXBTZXQiKS5wcm94eVNldF8odmFsdWUsIHBhcmVudCkgOiBjcmVhdGVQcm94eVByb3h5Mih2YWx1ZSwgcGFyZW50KTsKICBjb25zdCBzY29wZSA9IHBhcmVudCA/IHBhcmVudC5zY29wZV8gOiBnZXRDdXJyZW50U2NvcGUyKCk7CiAgc2NvcGUuZHJhZnRzXy5wdXNoKGRyYWZ0KTsKICByZXR1cm4gZHJhZnQ7Cn0KZnVuY3Rpb24gY3VycmVudDIodmFsdWUpIHsKICBpZiAoIWlzRHJhZnQyKHZhbHVlKSkKICAgIGRpZTIoMTAsIHZhbHVlKTsKICByZXR1cm4gY3VycmVudEltcGwyKHZhbHVlKTsKfQpmdW5jdGlvbiBjdXJyZW50SW1wbDIodmFsdWUpIHsKICBpZiAoIWlzRHJhZnRhYmxlMih2YWx1ZSkgfHwgaXNGcm96ZW4yKHZhbHVlKSkKICAgIHJldHVybiB2YWx1ZTsKICBjb25zdCBzdGF0ZSA9IHZhbHVlW0RSQUZUX1NUQVRFMl07CiAgbGV0IGNvcHkzOwogIGxldCBzdHJpY3QgPSB0cnVlOwogIGlmIChzdGF0ZSkgewogICAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pCiAgICAgIHJldHVybiBzdGF0ZS5iYXNlXzsKICAgIHN0YXRlLmZpbmFsaXplZF8gPSB0cnVlOwogICAgY29weTMgPSBzaGFsbG93Q29weTIodmFsdWUsIHN0YXRlLnNjb3BlXy5pbW1lcl8udXNlU3RyaWN0U2hhbGxvd0NvcHlfKTsKICAgIHN0cmljdCA9IHN0YXRlLnNjb3BlXy5pbW1lcl8uc2hvdWxkVXNlU3RyaWN0SXRlcmF0aW9uKCk7CiAgfSBlbHNlIHsKICAgIGNvcHkzID0gc2hhbGxvd0NvcHkyKHZhbHVlLCB0cnVlKTsKICB9CiAgZWFjaDIoCiAgICBjb3B5MywKICAgIChrZXksIGNoaWxkVmFsdWUpID0+IHsKICAgICAgc2V0Mihjb3B5Mywga2V5LCBjdXJyZW50SW1wbDIoY2hpbGRWYWx1ZSkpOwogICAgfSwKICAgIHN0cmljdAogICk7CiAgaWYgKHN0YXRlKSB7CiAgICBzdGF0ZS5maW5hbGl6ZWRfID0gZmFsc2U7CiAgfQogIHJldHVybiBjb3B5MzsKfQp2YXIgaW1tZXIyID0gbmV3IEltbWVyMjIoKTsKdmFyIHByb2R1Y2UyID0gaW1tZXIyLnByb2R1Y2U7CmZ1bmN0aW9uIGNhc3REcmFmdCh2YWx1ZSkgewogIHJldHVybiB2YWx1ZTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9sZWdlbmRTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlMiA9IHsKICBzZXR0aW5nczogewogICAgbGF5b3V0OiAiaG9yaXpvbnRhbCIsCiAgICBhbGlnbjogImNlbnRlciIsCiAgICB2ZXJ0aWNhbEFsaWduOiAibWlkZGxlIiwKICAgIGl0ZW1Tb3J0ZXI6ICJ2YWx1ZSIKICB9LAogIHNpemU6IHsKICAgIHdpZHRoOiAwLAogICAgaGVpZ2h0OiAwCiAgfSwKICBwYXlsb2FkOiBbXQp9Owp2YXIgbGVnZW5kU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImxlZ2VuZCIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGUyLAogIHJlZHVjZXJzOiB7CiAgICBzZXRMZWdlbmRTaXplKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc2l6ZS53aWR0aCA9IGFjdGlvbi5wYXlsb2FkLndpZHRoOwogICAgICBzdGF0ZS5zaXplLmhlaWdodCA9IGFjdGlvbi5wYXlsb2FkLmhlaWdodDsKICAgIH0sCiAgICBzZXRMZWdlbmRTZXR0aW5ncyhzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnNldHRpbmdzLmFsaWduID0gYWN0aW9uLnBheWxvYWQuYWxpZ247CiAgICAgIHN0YXRlLnNldHRpbmdzLmxheW91dCA9IGFjdGlvbi5wYXlsb2FkLmxheW91dDsKICAgICAgc3RhdGUuc2V0dGluZ3MudmVydGljYWxBbGlnbiA9IGFjdGlvbi5wYXlsb2FkLnZlcnRpY2FsQWxpZ247CiAgICAgIHN0YXRlLnNldHRpbmdzLml0ZW1Tb3J0ZXIgPSBhY3Rpb24ucGF5bG9hZC5pdGVtU29ydGVyOwogICAgfSwKICAgIGFkZExlZ2VuZFBheWxvYWQ6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUucGF5bG9hZC5wdXNoKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlcGxhY2VMZWdlbmRQYXlsb2FkOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciB7CiAgICAgICAgICBwcmV2LAogICAgICAgICAgbmV4dAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5wYXlsb2FkLmluZGV4T2YoY2FzdERyYWZ0KHByZXYpKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgc3RhdGUucGF5bG9hZFtpbmRleF0gPSBjYXN0RHJhZnQobmV4dCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZUxlZ2VuZFBheWxvYWQ6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkucGF5bG9hZC5pbmRleE9mKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS5wYXlsb2FkLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfQogIH0KfSk7CnZhciB7CiAgc2V0TGVnZW5kU2l6ZSwKICBzZXRMZWdlbmRTZXR0aW5ncywKICBhZGRMZWdlbmRQYXlsb2FkLAogIHJlcGxhY2VMZWdlbmRQYXlsb2FkLAogIHJlbW92ZUxlZ2VuZFBheWxvYWQKfSA9IGxlZ2VuZFNsaWNlLmFjdGlvbnM7CnZhciBsZWdlbmRSZWR1Y2VyID0gbGVnZW5kU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1Rvb2x0aXAuanMKdmFyIFJlYWN0MTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QyNCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdF9kb20yID0gX190b0VTTShyZXF1aXJlX3JlYWN0X2RvbSgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0RlZmF1bHRUb29sdGlwQ29udGVudC5qcwp2YXIgUmVhY3Q1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3NvcnRCeTMgPSBfX3RvRVNNKHJlcXVpcmVfc29ydEJ5MigpKTsKZnVuY3Rpb24gX2V4dGVuZHM0KCkgewogIHJldHVybiBfZXh0ZW5kczQgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczQuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzNShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDUoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXM1KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHk1KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czUoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTUoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXk1KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTUodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlNSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmU1KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBkZWZhdWx0Rm9ybWF0dGVyKHZhbHVlKSB7CiAgcmV0dXJuIEFycmF5LmlzQXJyYXkodmFsdWUpICYmIGlzTnVtT3JTdHIodmFsdWVbMF0pICYmIGlzTnVtT3JTdHIodmFsdWVbMV0pID8gdmFsdWUuam9pbigiIH4gIikgOiB2YWx1ZTsKfQp2YXIgRGVmYXVsdFRvb2x0aXBDb250ZW50ID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIHNlcGFyYXRvciA9ICIgOiAiLAogICAgY29udGVudFN0eWxlID0ge30sCiAgICBpdGVtU3R5bGUgPSB7fSwKICAgIGxhYmVsU3R5bGUgPSB7fSwKICAgIHBheWxvYWQsCiAgICBmb3JtYXR0ZXIsCiAgICBpdGVtU29ydGVyLAogICAgd3JhcHBlckNsYXNzTmFtZSwKICAgIGxhYmVsQ2xhc3NOYW1lLAogICAgbGFiZWwsCiAgICBsYWJlbEZvcm1hdHRlciwKICAgIGFjY2Vzc2liaWxpdHlMYXllciA9IGZhbHNlCiAgfSA9IHByb3BzOwogIHZhciByZW5kZXJDb250ZW50MiA9ICgpID0+IHsKICAgIGlmIChwYXlsb2FkICYmIHBheWxvYWQubGVuZ3RoKSB7CiAgICAgIHZhciBsaXN0U3R5bGUgPSB7CiAgICAgICAgcGFkZGluZzogMCwKICAgICAgICBtYXJnaW46IDAKICAgICAgfTsKICAgICAgdmFyIGl0ZW1zID0gKGl0ZW1Tb3J0ZXIgPyAoMCwgaW1wb3J0X3NvcnRCeTMuZGVmYXVsdCkocGF5bG9hZCwgaXRlbVNvcnRlcikgOiBwYXlsb2FkKS5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICAgICAgaWYgKGVudHJ5LnR5cGUgPT09ICJub25lIikgewogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBmaW5hbEZvcm1hdHRlciA9IGVudHJ5LmZvcm1hdHRlciB8fCBmb3JtYXR0ZXIgfHwgZGVmYXVsdEZvcm1hdHRlcjsKICAgICAgICB2YXIgewogICAgICAgICAgdmFsdWUsCiAgICAgICAgICBuYW1lCiAgICAgICAgfSA9IGVudHJ5OwogICAgICAgIHZhciBmaW5hbFZhbHVlID0gdmFsdWU7CiAgICAgICAgdmFyIGZpbmFsTmFtZSA9IG5hbWU7CiAgICAgICAgaWYgKGZpbmFsRm9ybWF0dGVyKSB7CiAgICAgICAgICB2YXIgZm9ybWF0dGVkID0gZmluYWxGb3JtYXR0ZXIodmFsdWUsIG5hbWUsIGVudHJ5LCBpLCBwYXlsb2FkKTsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGZvcm1hdHRlZCkpIHsKICAgICAgICAgICAgW2ZpbmFsVmFsdWUsIGZpbmFsTmFtZV0gPSBmb3JtYXR0ZWQ7CiAgICAgICAgICB9IGVsc2UgaWYgKGZvcm1hdHRlZCAhPSBudWxsKSB7CiAgICAgICAgICAgIGZpbmFsVmFsdWUgPSBmb3JtYXR0ZWQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGZpbmFsSXRlbVN0eWxlID0gX29iamVjdFNwcmVhZDUoewogICAgICAgICAgZGlzcGxheTogImJsb2NrIiwKICAgICAgICAgIHBhZGRpbmdUb3A6IDQsCiAgICAgICAgICBwYWRkaW5nQm90dG9tOiA0LAogICAgICAgICAgY29sb3I6IGVudHJ5LmNvbG9yIHx8ICIjMDAwIgogICAgICAgIH0sIGl0ZW1TdHlsZSk7CiAgICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgibGkiLCB7CiAgICAgICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy10b29sdGlwLWl0ZW0iLAogICAgICAgICAga2V5OiAidG9vbHRpcC1pdGVtLSIuY29uY2F0KGkpLAogICAgICAgICAgc3R5bGU6IGZpbmFsSXRlbVN0eWxlCiAgICAgICAgfSwgaXNOdW1PclN0cihmaW5hbE5hbWUpID8gLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJzcGFuIiwgewogICAgICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtdG9vbHRpcC1pdGVtLW5hbWUiCiAgICAgICAgfSwgZmluYWxOYW1lKSA6IG51bGwsIGlzTnVtT3JTdHIoZmluYWxOYW1lKSA/IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgic3BhbiIsIHsKICAgICAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXRvb2x0aXAtaXRlbS1zZXBhcmF0b3IiCiAgICAgICAgfSwgc2VwYXJhdG9yKSA6IG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgic3BhbiIsIHsKICAgICAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXRvb2x0aXAtaXRlbS12YWx1ZSIKICAgICAgICB9LCBmaW5hbFZhbHVlKSwgLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJzcGFuIiwgewogICAgICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtdG9vbHRpcC1pdGVtLXVuaXQiCiAgICAgICAgfSwgZW50cnkudW5pdCB8fCAiIikpOwogICAgICB9KTsKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgidWwiLCB7CiAgICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtdG9vbHRpcC1pdGVtLWxpc3QiLAogICAgICAgIHN0eWxlOiBsaXN0U3R5bGUKICAgICAgfSwgaXRlbXMpOwogICAgfQogICAgcmV0dXJuIG51bGw7CiAgfTsKICB2YXIgZmluYWxTdHlsZSA9IF9vYmplY3RTcHJlYWQ1KHsKICAgIG1hcmdpbjogMCwKICAgIHBhZGRpbmc6IDEwLAogICAgYmFja2dyb3VuZENvbG9yOiAiI2ZmZiIsCiAgICBib3JkZXI6ICIxcHggc29saWQgI2NjYyIsCiAgICB3aGl0ZVNwYWNlOiAibm93cmFwIgogIH0sIGNvbnRlbnRTdHlsZSk7CiAgdmFyIGZpbmFsTGFiZWxTdHlsZSA9IF9vYmplY3RTcHJlYWQ1KHsKICAgIG1hcmdpbjogMAogIH0sIGxhYmVsU3R5bGUpOwogIHZhciBoYXNMYWJlbCA9ICFpc051bGxpc2gobGFiZWwpOwogIHZhciBmaW5hbExhYmVsID0gaGFzTGFiZWwgPyBsYWJlbCA6ICIiOwogIHZhciB3cmFwcGVyQ04gPSBjbHN4KCJyZWNoYXJ0cy1kZWZhdWx0LXRvb2x0aXAiLCB3cmFwcGVyQ2xhc3NOYW1lKTsKICB2YXIgbGFiZWxDTiA9IGNsc3goInJlY2hhcnRzLXRvb2x0aXAtbGFiZWwiLCBsYWJlbENsYXNzTmFtZSk7CiAgaWYgKGhhc0xhYmVsICYmIGxhYmVsRm9ybWF0dGVyICYmIHBheWxvYWQgIT09IHZvaWQgMCAmJiBwYXlsb2FkICE9PSBudWxsKSB7CiAgICBmaW5hbExhYmVsID0gbGFiZWxGb3JtYXR0ZXIobGFiZWwsIHBheWxvYWQpOwogIH0KICB2YXIgYWNjZXNzaWJpbGl0eUF0dHJpYnV0ZXMgPSBhY2Nlc3NpYmlsaXR5TGF5ZXIgPyB7CiAgICByb2xlOiAic3RhdHVzIiwKICAgICJhcmlhLWxpdmUiOiAiYXNzZXJ0aXZlIgogIH0gOiB7fTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJkaXYiLCBfZXh0ZW5kczQoewogICAgY2xhc3NOYW1lOiB3cmFwcGVyQ04sCiAgICBzdHlsZTogZmluYWxTdHlsZQogIH0sIGFjY2Vzc2liaWxpdHlBdHRyaWJ1dGVzKSwgLyogQF9fUFVSRV9fICovIFJlYWN0NS5jcmVhdGVFbGVtZW50KCJwIiwgewogICAgY2xhc3NOYW1lOiBsYWJlbENOLAogICAgc3R5bGU6IGZpbmFsTGFiZWxTdHlsZQogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuaXNWYWxpZEVsZW1lbnQoZmluYWxMYWJlbCkgPyBmaW5hbExhYmVsIDogIiIuY29uY2F0KGZpbmFsTGFiZWwpKSwgcmVuZGVyQ29udGVudDIoKSk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9Ub29sdGlwQm91bmRpbmdCb3guanMKdmFyIFJlYWN0NiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDE0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3Rvb2x0aXAvdHJhbnNsYXRlLmpzCnZhciBDU1NfQ0xBU1NfUFJFRklYID0gInJlY2hhcnRzLXRvb2x0aXAtd3JhcHBlciI7CnZhciBUT09MVElQX0hJRERFTiA9IHsKICB2aXNpYmlsaXR5OiAiaGlkZGVuIgp9OwpmdW5jdGlvbiBnZXRUb29sdGlwQ1NTQ2xhc3NOYW1lKF9yZWYyKSB7CiAgdmFyIHsKICAgIGNvb3JkaW5hdGUsCiAgICB0cmFuc2xhdGVYLAogICAgdHJhbnNsYXRlWQogIH0gPSBfcmVmMjsKICByZXR1cm4gY2xzeChDU1NfQ0xBU1NfUFJFRklYLCB7CiAgICBbIiIuY29uY2F0KENTU19DTEFTU19QUkVGSVgsICItcmlnaHQiKV06IGlzTnVtYmVyKHRyYW5zbGF0ZVgpICYmIGNvb3JkaW5hdGUgJiYgaXNOdW1iZXIoY29vcmRpbmF0ZS54KSAmJiB0cmFuc2xhdGVYID49IGNvb3JkaW5hdGUueCwKICAgIFsiIi5jb25jYXQoQ1NTX0NMQVNTX1BSRUZJWCwgIi1sZWZ0IildOiBpc051bWJlcih0cmFuc2xhdGVYKSAmJiBjb29yZGluYXRlICYmIGlzTnVtYmVyKGNvb3JkaW5hdGUueCkgJiYgdHJhbnNsYXRlWCA8IGNvb3JkaW5hdGUueCwKICAgIFsiIi5jb25jYXQoQ1NTX0NMQVNTX1BSRUZJWCwgIi1ib3R0b20iKV06IGlzTnVtYmVyKHRyYW5zbGF0ZVkpICYmIGNvb3JkaW5hdGUgJiYgaXNOdW1iZXIoY29vcmRpbmF0ZS55KSAmJiB0cmFuc2xhdGVZID49IGNvb3JkaW5hdGUueSwKICAgIFsiIi5jb25jYXQoQ1NTX0NMQVNTX1BSRUZJWCwgIi10b3AiKV06IGlzTnVtYmVyKHRyYW5zbGF0ZVkpICYmIGNvb3JkaW5hdGUgJiYgaXNOdW1iZXIoY29vcmRpbmF0ZS55KSAmJiB0cmFuc2xhdGVZIDwgY29vcmRpbmF0ZS55CiAgfSk7Cn0KZnVuY3Rpb24gZ2V0VG9vbHRpcFRyYW5zbGF0ZVhZKF9yZWYyKSB7CiAgdmFyIHsKICAgIGFsbG93RXNjYXBlVmlld0JveCwKICAgIGNvb3JkaW5hdGUsCiAgICBrZXksCiAgICBvZmZzZXRUb3BMZWZ0LAogICAgcG9zaXRpb24sCiAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgdG9vbHRpcERpbWVuc2lvbiwKICAgIHZpZXdCb3gsCiAgICB2aWV3Qm94RGltZW5zaW9uCiAgfSA9IF9yZWYyOwogIGlmIChwb3NpdGlvbiAmJiBpc051bWJlcihwb3NpdGlvbltrZXldKSkgewogICAgcmV0dXJuIHBvc2l0aW9uW2tleV07CiAgfQogIHZhciBuZWdhdGl2ZSA9IGNvb3JkaW5hdGVba2V5XSAtIHRvb2x0aXBEaW1lbnNpb24gLSAob2Zmc2V0VG9wTGVmdCA+IDAgPyBvZmZzZXRUb3BMZWZ0IDogMCk7CiAgdmFyIHBvc2l0aXZlID0gY29vcmRpbmF0ZVtrZXldICsgb2Zmc2V0VG9wTGVmdDsKICBpZiAoYWxsb3dFc2NhcGVWaWV3Qm94W2tleV0pIHsKICAgIHJldHVybiByZXZlcnNlRGlyZWN0aW9uW2tleV0gPyBuZWdhdGl2ZSA6IHBvc2l0aXZlOwogIH0KICB2YXIgdmlld0JveEtleSA9IHZpZXdCb3hba2V5XTsKICBpZiAodmlld0JveEtleSA9PSBudWxsKSB7CiAgICByZXR1cm4gMDsKICB9CiAgaWYgKHJldmVyc2VEaXJlY3Rpb25ba2V5XSkgewogICAgdmFyIF90b29sdGlwQm91bmRhcnkgPSBuZWdhdGl2ZTsKICAgIHZhciBfdmlld0JveEJvdW5kYXJ5ID0gdmlld0JveEtleTsKICAgIGlmIChfdG9vbHRpcEJvdW5kYXJ5IDwgX3ZpZXdCb3hCb3VuZGFyeSkgewogICAgICByZXR1cm4gTWF0aC5tYXgocG9zaXRpdmUsIHZpZXdCb3hLZXkpOwogICAgfQogICAgcmV0dXJuIE1hdGgubWF4KG5lZ2F0aXZlLCB2aWV3Qm94S2V5KTsKICB9CiAgaWYgKHZpZXdCb3hEaW1lbnNpb24gPT0gbnVsbCkgewogICAgcmV0dXJuIDA7CiAgfQogIHZhciB0b29sdGlwQm91bmRhcnkgPSBwb3NpdGl2ZSArIHRvb2x0aXBEaW1lbnNpb247CiAgdmFyIHZpZXdCb3hCb3VuZGFyeSA9IHZpZXdCb3hLZXkgKyB2aWV3Qm94RGltZW5zaW9uOwogIGlmICh0b29sdGlwQm91bmRhcnkgPiB2aWV3Qm94Qm91bmRhcnkpIHsKICAgIHJldHVybiBNYXRoLm1heChuZWdhdGl2ZSwgdmlld0JveEtleSk7CiAgfQogIHJldHVybiBNYXRoLm1heChwb3NpdGl2ZSwgdmlld0JveEtleSk7Cn0KZnVuY3Rpb24gZ2V0VHJhbnNmb3JtU3R5bGUoX3JlZjMpIHsKICB2YXIgewogICAgdHJhbnNsYXRlWCwKICAgIHRyYW5zbGF0ZVksCiAgICB1c2VUcmFuc2xhdGUzZAogIH0gPSBfcmVmMzsKICByZXR1cm4gewogICAgdHJhbnNmb3JtOiB1c2VUcmFuc2xhdGUzZCA/ICJ0cmFuc2xhdGUzZCgiLmNvbmNhdCh0cmFuc2xhdGVYLCAicHgsICIpLmNvbmNhdCh0cmFuc2xhdGVZLCAicHgsIDApIikgOiAidHJhbnNsYXRlKCIuY29uY2F0KHRyYW5zbGF0ZVgsICJweCwgIikuY29uY2F0KHRyYW5zbGF0ZVksICJweCkiKQogIH07Cn0KZnVuY3Rpb24gZ2V0VG9vbHRpcFRyYW5zbGF0ZShfcmVmNCkgewogIHZhciB7CiAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICBjb29yZGluYXRlLAogICAgb2Zmc2V0VG9wTGVmdCwKICAgIHBvc2l0aW9uLAogICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgIHRvb2x0aXBCb3gsCiAgICB1c2VUcmFuc2xhdGUzZCwKICAgIHZpZXdCb3gKICB9ID0gX3JlZjQ7CiAgdmFyIGNzc1Byb3BlcnRpZXMsIHRyYW5zbGF0ZVgsIHRyYW5zbGF0ZVk7CiAgaWYgKHRvb2x0aXBCb3guaGVpZ2h0ID4gMCAmJiB0b29sdGlwQm94LndpZHRoID4gMCAmJiBjb29yZGluYXRlKSB7CiAgICB0cmFuc2xhdGVYID0gZ2V0VG9vbHRpcFRyYW5zbGF0ZVhZKHsKICAgICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgICBjb29yZGluYXRlLAogICAgICBrZXk6ICJ4IiwKICAgICAgb2Zmc2V0VG9wTGVmdCwKICAgICAgcG9zaXRpb24sCiAgICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICAgIHRvb2x0aXBEaW1lbnNpb246IHRvb2x0aXBCb3gud2lkdGgsCiAgICAgIHZpZXdCb3gsCiAgICAgIHZpZXdCb3hEaW1lbnNpb246IHZpZXdCb3gud2lkdGgKICAgIH0pOwogICAgdHJhbnNsYXRlWSA9IGdldFRvb2x0aXBUcmFuc2xhdGVYWSh7CiAgICAgIGFsbG93RXNjYXBlVmlld0JveCwKICAgICAgY29vcmRpbmF0ZSwKICAgICAga2V5OiAieSIsCiAgICAgIG9mZnNldFRvcExlZnQsCiAgICAgIHBvc2l0aW9uLAogICAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgICB0b29sdGlwRGltZW5zaW9uOiB0b29sdGlwQm94LmhlaWdodCwKICAgICAgdmlld0JveCwKICAgICAgdmlld0JveERpbWVuc2lvbjogdmlld0JveC5oZWlnaHQKICAgIH0pOwogICAgY3NzUHJvcGVydGllcyA9IGdldFRyYW5zZm9ybVN0eWxlKHsKICAgICAgdHJhbnNsYXRlWCwKICAgICAgdHJhbnNsYXRlWSwKICAgICAgdXNlVHJhbnNsYXRlM2QKICAgIH0pOwogIH0gZWxzZSB7CiAgICBjc3NQcm9wZXJ0aWVzID0gVE9PTFRJUF9ISURERU47CiAgfQogIHJldHVybiB7CiAgICBjc3NQcm9wZXJ0aWVzLAogICAgY3NzQ2xhc3NlczogZ2V0VG9vbHRpcENTU0NsYXNzTmFtZSh7CiAgICAgIHRyYW5zbGF0ZVgsCiAgICAgIHRyYW5zbGF0ZVksCiAgICAgIGNvb3JkaW5hdGUKICAgIH0pCiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVG9vbHRpcEJvdW5kaW5nQm94LmpzCmZ1bmN0aW9uIG93bktleXM2KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkNihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czYoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTYoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzNihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5NihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTYocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5Nih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU2KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTYodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBUb29sdGlwQm91bmRpbmdCb3ggPSBjbGFzcyBleHRlbmRzIGltcG9ydF9yZWFjdDE0LlB1cmVDb21wb25lbnQgewogIGNvbnN0cnVjdG9yKCkgewogICAgc3VwZXIoLi4uYXJndW1lbnRzKTsKICAgIF9kZWZpbmVQcm9wZXJ0eTYodGhpcywgInN0YXRlIiwgewogICAgICBkaXNtaXNzZWQ6IGZhbHNlLAogICAgICBkaXNtaXNzZWRBdENvb3JkaW5hdGU6IHsKICAgICAgICB4OiAwLAogICAgICAgIHk6IDAKICAgICAgfQogICAgfSk7CiAgICBfZGVmaW5lUHJvcGVydHk2KHRoaXMsICJoYW5kbGVLZXlEb3duIiwgKGV2ZW50KSA9PiB7CiAgICAgIGlmIChldmVudC5rZXkgPT09ICJFc2NhcGUiKSB7CiAgICAgICAgdmFyIF90aGlzJHByb3BzJGNvb3JkaW5hdCwgX3RoaXMkcHJvcHMkY29vcmRpbmF0MiwgX3RoaXMkcHJvcHMkY29vcmRpbmF0MywgX3RoaXMkcHJvcHMkY29vcmRpbmF0NDsKICAgICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICAgIGRpc21pc3NlZDogdHJ1ZSwKICAgICAgICAgIGRpc21pc3NlZEF0Q29vcmRpbmF0ZTogewogICAgICAgICAgICB4OiAoX3RoaXMkcHJvcHMkY29vcmRpbmF0ID0gKF90aGlzJHByb3BzJGNvb3JkaW5hdDIgPSB0aGlzLnByb3BzLmNvb3JkaW5hdGUpID09PSBudWxsIHx8IF90aGlzJHByb3BzJGNvb3JkaW5hdDIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJHByb3BzJGNvb3JkaW5hdDIueCkgIT09IG51bGwgJiYgX3RoaXMkcHJvcHMkY29vcmRpbmF0ICE9PSB2b2lkIDAgPyBfdGhpcyRwcm9wcyRjb29yZGluYXQgOiAwLAogICAgICAgICAgICB5OiAoX3RoaXMkcHJvcHMkY29vcmRpbmF0MyA9IChfdGhpcyRwcm9wcyRjb29yZGluYXQ0ID0gdGhpcy5wcm9wcy5jb29yZGluYXRlKSA9PT0gbnVsbCB8fCBfdGhpcyRwcm9wcyRjb29yZGluYXQ0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdGhpcyRwcm9wcyRjb29yZGluYXQ0LnkpICE9PSBudWxsICYmIF90aGlzJHByb3BzJGNvb3JkaW5hdDMgIT09IHZvaWQgMCA/IF90aGlzJHByb3BzJGNvb3JkaW5hdDMgOiAwCiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogIH0KICBjb21wb25lbnREaWRNb3VudCgpIHsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLmhhbmRsZUtleURvd24pOwogIH0KICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHsKICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoImtleWRvd24iLCB0aGlzLmhhbmRsZUtleURvd24pOwogIH0KICBjb21wb25lbnREaWRVcGRhdGUoKSB7CiAgICB2YXIgX3RoaXMkcHJvcHMkY29vcmRpbmF0NSwgX3RoaXMkcHJvcHMkY29vcmRpbmF0NjsKICAgIGlmICghdGhpcy5zdGF0ZS5kaXNtaXNzZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKCgoX3RoaXMkcHJvcHMkY29vcmRpbmF0NSA9IHRoaXMucHJvcHMuY29vcmRpbmF0ZSkgPT09IG51bGwgfHwgX3RoaXMkcHJvcHMkY29vcmRpbmF0NSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RoaXMkcHJvcHMkY29vcmRpbmF0NS54KSAhPT0gdGhpcy5zdGF0ZS5kaXNtaXNzZWRBdENvb3JkaW5hdGUueCB8fCAoKF90aGlzJHByb3BzJGNvb3JkaW5hdDYgPSB0aGlzLnByb3BzLmNvb3JkaW5hdGUpID09PSBudWxsIHx8IF90aGlzJHByb3BzJGNvb3JkaW5hdDYgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJHByb3BzJGNvb3JkaW5hdDYueSkgIT09IHRoaXMuc3RhdGUuZGlzbWlzc2VkQXRDb29yZGluYXRlLnkpIHsKICAgICAgdGhpcy5zdGF0ZS5kaXNtaXNzZWQgPSBmYWxzZTsKICAgIH0KICB9CiAgcmVuZGVyKCkgewogICAgdmFyIHsKICAgICAgYWN0aXZlLAogICAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICAgIGFuaW1hdGlvbkR1cmF0aW9uLAogICAgICBhbmltYXRpb25FYXNpbmcsCiAgICAgIGNoaWxkcmVuLAogICAgICBjb29yZGluYXRlLAogICAgICBoYXNQYXlsb2FkLAogICAgICBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgICAgb2Zmc2V0LAogICAgICBwb3NpdGlvbiwKICAgICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgICAgdXNlVHJhbnNsYXRlM2QsCiAgICAgIHZpZXdCb3gsCiAgICAgIHdyYXBwZXJTdHlsZSwKICAgICAgbGFzdEJvdW5kaW5nQm94LAogICAgICBpbm5lclJlZiwKICAgICAgaGFzUG9ydGFsRnJvbVByb3BzCiAgICB9ID0gdGhpcy5wcm9wczsKICAgIHZhciB7CiAgICAgIGNzc0NsYXNzZXMsCiAgICAgIGNzc1Byb3BlcnRpZXMKICAgIH0gPSBnZXRUb29sdGlwVHJhbnNsYXRlKHsKICAgICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgICBjb29yZGluYXRlLAogICAgICBvZmZzZXRUb3BMZWZ0OiBvZmZzZXQsCiAgICAgIHBvc2l0aW9uLAogICAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgICB0b29sdGlwQm94OiB7CiAgICAgICAgaGVpZ2h0OiBsYXN0Qm91bmRpbmdCb3guaGVpZ2h0LAogICAgICAgIHdpZHRoOiBsYXN0Qm91bmRpbmdCb3gud2lkdGgKICAgICAgfSwKICAgICAgdXNlVHJhbnNsYXRlM2QsCiAgICAgIHZpZXdCb3gKICAgIH0pOwogICAgdmFyIHBvc2l0aW9uU3R5bGVzID0gaGFzUG9ydGFsRnJvbVByb3BzID8ge30gOiBfb2JqZWN0U3ByZWFkNihfb2JqZWN0U3ByZWFkNih7CiAgICAgIHRyYW5zaXRpb246IGlzQW5pbWF0aW9uQWN0aXZlICYmIGFjdGl2ZSA/ICJ0cmFuc2Zvcm0gIi5jb25jYXQoYW5pbWF0aW9uRHVyYXRpb24sICJtcyAiKS5jb25jYXQoYW5pbWF0aW9uRWFzaW5nKSA6IHZvaWQgMAogICAgfSwgY3NzUHJvcGVydGllcyksIHt9LCB7CiAgICAgIHBvaW50ZXJFdmVudHM6ICJub25lIiwKICAgICAgdmlzaWJpbGl0eTogIXRoaXMuc3RhdGUuZGlzbWlzc2VkICYmIGFjdGl2ZSAmJiBoYXNQYXlsb2FkID8gInZpc2libGUiIDogImhpZGRlbiIsCiAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICB0b3A6IDAsCiAgICAgIGxlZnQ6IDAKICAgIH0pOwogICAgdmFyIG91dGVyU3R5bGUgPSBfb2JqZWN0U3ByZWFkNihfb2JqZWN0U3ByZWFkNih7fSwgcG9zaXRpb25TdHlsZXMpLCB7fSwgewogICAgICB2aXNpYmlsaXR5OiAhdGhpcy5zdGF0ZS5kaXNtaXNzZWQgJiYgYWN0aXZlICYmIGhhc1BheWxvYWQgPyAidmlzaWJsZSIgOiAiaGlkZGVuIgogICAgfSwgd3JhcHBlclN0eWxlKTsKICAgIHJldHVybiAoCiAgICAgIC8vIFRoaXMgZWxlbWVudCBhbGxvdyBsaXN0ZW5pbmcgdG8gdGhlIGBFc2NhcGVgIGtleS4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9yZWNoYXJ0cy9yZWNoYXJ0cy9wdWxsLzI5MjUKICAgICAgLyogQF9fUFVSRV9fICovIFJlYWN0Ni5jcmVhdGVFbGVtZW50KCJkaXYiLCB7CiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciB0eXBlc2NyaXB0IGxpYnJhcnkgZG9lcyBub3QgcmVjb2duaXplIHhtbG5zIGF0dHJpYnV0ZSwgYnV0IGl0J3MgcmVxdWlyZWQgZm9yIGFuIEhUTUwgY2h1bmsgaW5zaWRlIFNWRy4KICAgICAgICB4bWxuczogImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiLAogICAgICAgIHRhYkluZGV4OiAtMSwKICAgICAgICBjbGFzc05hbWU6IGNzc0NsYXNzZXMsCiAgICAgICAgc3R5bGU6IG91dGVyU3R5bGUsCiAgICAgICAgcmVmOiBpbm5lclJlZgogICAgICB9LCBjaGlsZHJlbikKICAgICk7CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L2FjY2Vzc2liaWxpdHlDb250ZXh0LmpzCnZhciB1c2VBY2Nlc3NpYmlsaXR5TGF5ZXIgPSAoKSA9PiB7CiAgdmFyIF91c2VBcHBTZWxlY3RvcjsKICByZXR1cm4gKF91c2VBcHBTZWxlY3RvciA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLmFjY2Vzc2liaWxpdHlMYXllcikpICE9PSBudWxsICYmIF91c2VBcHBTZWxlY3RvciAhPT0gdm9pZCAwID8gX3VzZUFwcFNlbGVjdG9yIDogdHJ1ZTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0N1cnNvci5qcwp2YXIgUmVhY3QxMSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDIxID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zaGFwZS9DdXJ2ZS5qcwp2YXIgUmVhY3Q3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBfZXh0ZW5kczUoKSB7CiAgcmV0dXJuIF9leHRlbmRzNSA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzNS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIG93bktleXM3KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkNyhlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czcoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTcoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzNyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5NyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTcocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5Nyh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU3KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTcodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBDVVJWRV9GQUNUT1JJRVMgPSB7CiAgY3VydmVCYXNpc0Nsb3NlZDogYmFzaXNDbG9zZWRfZGVmYXVsdCwKICBjdXJ2ZUJhc2lzT3BlbjogYmFzaXNPcGVuX2RlZmF1bHQsCiAgY3VydmVCYXNpczogYmFzaXNfZGVmYXVsdCwKICBjdXJ2ZUJ1bXBYOiBidW1wWCwKICBjdXJ2ZUJ1bXBZOiBidW1wWSwKICBjdXJ2ZUxpbmVhckNsb3NlZDogbGluZWFyQ2xvc2VkX2RlZmF1bHQsCiAgY3VydmVMaW5lYXI6IGxpbmVhcl9kZWZhdWx0LAogIGN1cnZlTW9ub3RvbmVYOiBtb25vdG9uZVgsCiAgY3VydmVNb25vdG9uZVk6IG1vbm90b25lWSwKICBjdXJ2ZU5hdHVyYWw6IG5hdHVyYWxfZGVmYXVsdCwKICBjdXJ2ZVN0ZXA6IHN0ZXBfZGVmYXVsdCwKICBjdXJ2ZVN0ZXBBZnRlcjogc3RlcEFmdGVyLAogIGN1cnZlU3RlcEJlZm9yZTogc3RlcEJlZm9yZQp9Owp2YXIgZGVmaW5lZCA9IChwKSA9PiBpc1dlbGxCZWhhdmVkTnVtYmVyKHAueCkgJiYgaXNXZWxsQmVoYXZlZE51bWJlcihwLnkpOwp2YXIgYXJlYURlZmluZWQgPSAoZCkgPT4gZC5iYXNlICE9IG51bGwgJiYgZGVmaW5lZChkLmJhc2UpICYmIGRlZmluZWQoZCk7CnZhciBnZXRYID0gKHApID0+IHAueDsKdmFyIGdldFkgPSAocCkgPT4gcC55Owp2YXIgZ2V0Q3VydmVGYWN0b3J5ID0gKHR5cGUsIGxheW91dCkgPT4gewogIGlmICh0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIHR5cGU7CiAgfQogIHZhciBuYW1lID0gImN1cnZlIi5jb25jYXQodXBwZXJGaXJzdCh0eXBlKSk7CiAgaWYgKChuYW1lID09PSAiY3VydmVNb25vdG9uZSIgfHwgbmFtZSA9PT0gImN1cnZlQnVtcCIpICYmIGxheW91dCkgewogICAgcmV0dXJuIENVUlZFX0ZBQ1RPUklFU1siIi5jb25jYXQobmFtZSkuY29uY2F0KGxheW91dCA9PT0gInZlcnRpY2FsIiA/ICJZIiA6ICJYIildOwogIH0KICByZXR1cm4gQ1VSVkVfRkFDVE9SSUVTW25hbWVdIHx8IGxpbmVhcl9kZWZhdWx0Owp9Owp2YXIgZ2V0UGF0aCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICB0eXBlID0gImxpbmVhciIsCiAgICBwb2ludHMgPSBbXSwKICAgIGJhc2VMaW5lLAogICAgbGF5b3V0LAogICAgY29ubmVjdE51bGxzID0gZmFsc2UKICB9ID0gX3JlZjI7CiAgdmFyIGN1cnZlRmFjdG9yeSA9IGdldEN1cnZlRmFjdG9yeSh0eXBlLCBsYXlvdXQpOwogIHZhciBmb3JtYXRQb2ludHMgPSBjb25uZWN0TnVsbHMgPyBwb2ludHMuZmlsdGVyKGRlZmluZWQpIDogcG9pbnRzOwogIHZhciBsaW5lRnVuY3Rpb247CiAgaWYgKEFycmF5LmlzQXJyYXkoYmFzZUxpbmUpKSB7CiAgICB2YXIgYXJlYVBvaW50cyA9IHBvaW50cy5tYXAoKGVudHJ5LCBpbmRleCkgPT4gX29iamVjdFNwcmVhZDcoX29iamVjdFNwcmVhZDcoe30sIGVudHJ5KSwge30sIHsKICAgICAgYmFzZTogYmFzZUxpbmVbaW5kZXhdCiAgICB9KSk7CiAgICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICAgIGxpbmVGdW5jdGlvbiA9IGFyZWFfZGVmYXVsdCgpLnkoZ2V0WSkueDEoZ2V0WCkueDAoKGQpID0+IGQuYmFzZS54KTsKICAgIH0gZWxzZSB7CiAgICAgIGxpbmVGdW5jdGlvbiA9IGFyZWFfZGVmYXVsdCgpLngoZ2V0WCkueTEoZ2V0WSkueTAoKGQpID0+IGQuYmFzZS55KTsKICAgIH0KICAgIHZhciBfbnVsbGFibGVMaW5lRnVuY3Rpb24gPSBsaW5lRnVuY3Rpb24uZGVmaW5lZChhcmVhRGVmaW5lZCkuY3VydmUoY3VydmVGYWN0b3J5KTsKICAgIHZhciBmaW5hbFBvaW50cyA9IGNvbm5lY3ROdWxscyA/IGFyZWFQb2ludHMuZmlsdGVyKGFyZWFEZWZpbmVkKSA6IGFyZWFQb2ludHM7CiAgICByZXR1cm4gX251bGxhYmxlTGluZUZ1bmN0aW9uKGZpbmFsUG9pbnRzKTsKICB9CiAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIiAmJiBpc051bWJlcihiYXNlTGluZSkpIHsKICAgIGxpbmVGdW5jdGlvbiA9IGFyZWFfZGVmYXVsdCgpLnkoZ2V0WSkueDEoZ2V0WCkueDAoYmFzZUxpbmUpOwogIH0gZWxzZSBpZiAoaXNOdW1iZXIoYmFzZUxpbmUpKSB7CiAgICBsaW5lRnVuY3Rpb24gPSBhcmVhX2RlZmF1bHQoKS54KGdldFgpLnkxKGdldFkpLnkwKGJhc2VMaW5lKTsKICB9IGVsc2UgewogICAgbGluZUZ1bmN0aW9uID0gbGluZV9kZWZhdWx0KCkueChnZXRYKS55KGdldFkpOwogIH0KICB2YXIgbnVsbGFibGVMaW5lRnVuY3Rpb24gPSBsaW5lRnVuY3Rpb24uZGVmaW5lZChkZWZpbmVkKS5jdXJ2ZShjdXJ2ZUZhY3RvcnkpOwogIHJldHVybiBudWxsYWJsZUxpbmVGdW5jdGlvbihmb3JtYXRQb2ludHMpOwp9Owp2YXIgQ3VydmUgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgY2xhc3NOYW1lLAogICAgcG9pbnRzLAogICAgcGF0aDogcGF0aDIsCiAgICBwYXRoUmVmCiAgfSA9IHByb3BzOwogIGlmICgoIXBvaW50cyB8fCAhcG9pbnRzLmxlbmd0aCkgJiYgIXBhdGgyKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHJlYWxQYXRoID0gcG9pbnRzICYmIHBvaW50cy5sZW5ndGggPyBnZXRQYXRoKHByb3BzKSA6IHBhdGgyOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q3LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCBfZXh0ZW5kczUoe30sIHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhwcm9wcyksIGFkYXB0RXZlbnRIYW5kbGVycyhwcm9wcyksIHsKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtY3VydmUiLCBjbGFzc05hbWUpLAogICAgZDogcmVhbFBhdGggPT09IG51bGwgPyB2b2lkIDAgOiByZWFsUGF0aCwKICAgIHJlZjogcGF0aFJlZgogIH0pKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvQ3Jvc3MuanMKdmFyIFJlYWN0OCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIF9leGNsdWRlZDMgPSBbIngiLCAieSIsICJ0b3AiLCAibGVmdCIsICJ3aWR0aCIsICJoZWlnaHQiLCAiY2xhc3NOYW1lIl07CmZ1bmN0aW9uIF9leHRlbmRzNigpIHsKICByZXR1cm4gX2V4dGVuZHM2ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHM2LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gb3duS2V5czgoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQ4KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzOChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5OChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXM4KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHk4KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5OChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXk4KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTgodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlOCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMyhlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMyhlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMyhyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIGdldFBhdGgyID0gKHgyLCB5Miwgd2lkdGgsIGhlaWdodCwgdG9wLCBsZWZ0KSA9PiB7CiAgcmV0dXJuICJNIi5jb25jYXQoeDIsICIsIikuY29uY2F0KHRvcCwgInYiKS5jb25jYXQoaGVpZ2h0LCAiTSIpLmNvbmNhdChsZWZ0LCAiLCIpLmNvbmNhdCh5MiwgImgiKS5jb25jYXQod2lkdGgpOwp9Owp2YXIgQ3Jvc3MgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgeDogeDIgPSAwLAogICAgeTogeTIgPSAwLAogICAgdG9wID0gMCwKICAgIGxlZnQgPSAwLAogICAgd2lkdGggPSAwLAogICAgaGVpZ2h0ID0gMCwKICAgIGNsYXNzTmFtZQogIH0gPSBfcmVmMiwgcmVzdCA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczMoX3JlZjIsIF9leGNsdWRlZDMpOwogIHZhciBwcm9wcyA9IF9vYmplY3RTcHJlYWQ4KHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB0b3AsCiAgICBsZWZ0LAogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9LCByZXN0KTsKICBpZiAoIWlzTnVtYmVyKHgyKSB8fCAhaXNOdW1iZXIoeTIpIHx8ICFpc051bWJlcih3aWR0aCkgfHwgIWlzTnVtYmVyKGhlaWdodCkgfHwgIWlzTnVtYmVyKHRvcCkgfHwgIWlzTnVtYmVyKGxlZnQpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDguY3JlYXRlRWxlbWVudCgicGF0aCIsIF9leHRlbmRzNih7fSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhwcm9wcyksIHsKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtY3Jvc3MiLCBjbGFzc05hbWUpLAogICAgZDogZ2V0UGF0aDIoeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCB0b3AsIGxlZnQpCiAgfSkpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2N1cnNvci9nZXRDdXJzb3JSZWN0YW5nbGUuanMKZnVuY3Rpb24gZ2V0Q3Vyc29yUmVjdGFuZ2xlKGxheW91dCwgYWN0aXZlQ29vcmRpbmF0ZSwgb2Zmc2V0LCB0b29sdGlwQXhpc0JhbmRTaXplKSB7CiAgdmFyIGhhbGZTaXplID0gdG9vbHRpcEF4aXNCYW5kU2l6ZSAvIDI7CiAgcmV0dXJuIHsKICAgIHN0cm9rZTogIm5vbmUiLAogICAgZmlsbDogIiNjY2MiLAogICAgeDogbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgPyBhY3RpdmVDb29yZGluYXRlLnggLSBoYWxmU2l6ZSA6IG9mZnNldC5sZWZ0ICsgMC41LAogICAgeTogbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgPyBvZmZzZXQudG9wICsgMC41IDogYWN0aXZlQ29vcmRpbmF0ZS55IC0gaGFsZlNpemUsCiAgICB3aWR0aDogbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgPyB0b29sdGlwQXhpc0JhbmRTaXplIDogb2Zmc2V0LndpZHRoIC0gMSwKICAgIGhlaWdodDogbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgPyBvZmZzZXQuaGVpZ2h0IC0gMSA6IHRvb2x0aXBBeGlzQmFuZFNpemUKICB9Owp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL1JlY3RhbmdsZS5qcwp2YXIgUmVhY3Q5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MTggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi9KYXZhc2NyaXB0QW5pbWF0ZS5qcwp2YXIgaW1wb3J0X3JlYWN0MTYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi91dGlsLmpzCmZ1bmN0aW9uIG93bktleXM5KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkOShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czkoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTkoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzOShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5OShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTkocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5OSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU5KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTkodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBnZXREYXNoQ2FzZSA9IChuYW1lKSA9PiBuYW1lLnJlcGxhY2UoLyhbQS1aXSkvZywgKHYpID0+ICItIi5jb25jYXQodi50b0xvd2VyQ2FzZSgpKSk7CnZhciBnZXRUcmFuc2l0aW9uVmFsID0gKHByb3BzLCBkdXJhdGlvbiwgZWFzaW5nKSA9PiBwcm9wcy5tYXAoKHByb3ApID0+ICIiLmNvbmNhdChnZXREYXNoQ2FzZShwcm9wKSwgIiAiKS5jb25jYXQoZHVyYXRpb24sICJtcyAiKS5jb25jYXQoZWFzaW5nKSkuam9pbigiLCIpOwp2YXIgZ2V0SW50ZXJzZWN0aW9uS2V5cyA9IChwcmVPYmosIG5leHRPYmopID0+IFtPYmplY3Qua2V5cyhwcmVPYmopLCBPYmplY3Qua2V5cyhuZXh0T2JqKV0ucmVkdWNlKChhLCBiKSA9PiBhLmZpbHRlcigoYykgPT4gYi5pbmNsdWRlcyhjKSkpOwp2YXIgbWFwT2JqZWN0ID0gKGZuLCBvYmopID0+IE9iamVjdC5rZXlzKG9iaikucmVkdWNlKChyZXMsIGtleSkgPT4gX29iamVjdFNwcmVhZDkoX29iamVjdFNwcmVhZDkoe30sIHJlcyksIHt9LCB7CiAgW2tleV06IGZuKGtleSwgb2JqW2tleV0pCn0pLCB7fSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi9jb25maWdVcGRhdGUuanMKZnVuY3Rpb24gb3duS2V5czEwKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTAoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxMChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTAoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTAoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTEwKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTAocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTAodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTAodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTAodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBhbHBoYSA9IChiZWdpbiwgZW5kLCBrKSA9PiBiZWdpbiArIChlbmQgLSBiZWdpbikgKiBrOwp2YXIgbmVlZENvbnRpbnVlID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGZyb206IGZyb20yLAogICAgdG86IHRvMgogIH0gPSBfcmVmMjsKICByZXR1cm4gZnJvbTIgIT09IHRvMjsKfTsKdmFyIGNhbFN0ZXBwZXJWYWxzID0gKGVhc2luZywgcHJlVmFscywgc3RlcHMpID0+IHsKICB2YXIgbmV4dFN0ZXBWYWxzID0gbWFwT2JqZWN0KChrZXksIHZhbCkgPT4gewogICAgaWYgKG5lZWRDb250aW51ZSh2YWwpKSB7CiAgICAgIHZhciBbbmV3WCwgbmV3Vl0gPSBlYXNpbmcodmFsLmZyb20sIHZhbC50bywgdmFsLnZlbG9jaXR5KTsKICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIHZhbCksIHt9LCB7CiAgICAgICAgZnJvbTogbmV3WCwKICAgICAgICB2ZWxvY2l0eTogbmV3VgogICAgICB9KTsKICAgIH0KICAgIHJldHVybiB2YWw7CiAgfSwgcHJlVmFscyk7CiAgaWYgKHN0ZXBzIDwgMSkgewogICAgcmV0dXJuIG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IHsKICAgICAgaWYgKG5lZWRDb250aW51ZSh2YWwpKSB7CiAgICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIHZhbCksIHt9LCB7CiAgICAgICAgICB2ZWxvY2l0eTogYWxwaGEodmFsLnZlbG9jaXR5LCBuZXh0U3RlcFZhbHNba2V5XS52ZWxvY2l0eSwgc3RlcHMpLAogICAgICAgICAgZnJvbTogYWxwaGEodmFsLmZyb20sIG5leHRTdGVwVmFsc1trZXldLmZyb20sIHN0ZXBzKQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB2YWw7CiAgICB9LCBwcmVWYWxzKTsKICB9CiAgcmV0dXJuIGNhbFN0ZXBwZXJWYWxzKGVhc2luZywgbmV4dFN0ZXBWYWxzLCBzdGVwcyAtIDEpOwp9OwpmdW5jdGlvbiBjcmVhdGVTdGVwcGVyVXBkYXRlKGZyb20yLCB0bzIsIGVhc2luZywgaW50ZXJLZXlzLCByZW5kZXIsIHRpbWVvdXRDb250cm9sbGVyKSB7CiAgdmFyIHByZVRpbWU7CiAgdmFyIHN0ZXBwZXJTdHlsZSA9IGludGVyS2V5cy5yZWR1Y2UoKHJlcywga2V5KSA9PiBfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCByZXMpLCB7fSwgewogICAgW2tleV06IHsKICAgICAgZnJvbTogZnJvbTJba2V5XSwKICAgICAgdmVsb2NpdHk6IDAsCiAgICAgIHRvOiB0bzJba2V5XQogICAgfQogIH0pLCB7fSk7CiAgdmFyIGdldEN1cnJTdHlsZSA9ICgpID0+IG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IHZhbC5mcm9tLCBzdGVwcGVyU3R5bGUpOwogIHZhciBzaG91bGRTdG9wQW5pbWF0aW9uID0gKCkgPT4gIU9iamVjdC52YWx1ZXMoc3RlcHBlclN0eWxlKS5maWx0ZXIobmVlZENvbnRpbnVlKS5sZW5ndGg7CiAgdmFyIHN0b3BBbmltYXRpb24gPSBudWxsOwogIHZhciBzdGVwcGVyVXBkYXRlID0gKG5vdykgPT4gewogICAgaWYgKCFwcmVUaW1lKSB7CiAgICAgIHByZVRpbWUgPSBub3c7CiAgICB9CiAgICB2YXIgZGVsdGFUaW1lID0gbm93IC0gcHJlVGltZTsKICAgIHZhciBzdGVwcyA9IGRlbHRhVGltZSAvIGVhc2luZy5kdDsKICAgIHN0ZXBwZXJTdHlsZSA9IGNhbFN0ZXBwZXJWYWxzKGVhc2luZywgc3RlcHBlclN0eWxlLCBzdGVwcyk7CiAgICByZW5kZXIoX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIGZyb20yKSwgdG8yKSwgZ2V0Q3VyclN0eWxlKCkpKTsKICAgIHByZVRpbWUgPSBub3c7CiAgICBpZiAoIXNob3VsZFN0b3BBbmltYXRpb24oKSkgewogICAgICBzdG9wQW5pbWF0aW9uID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dChzdGVwcGVyVXBkYXRlKTsKICAgIH0KICB9OwogIHJldHVybiAoKSA9PiB7CiAgICBzdG9wQW5pbWF0aW9uID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dChzdGVwcGVyVXBkYXRlKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHZhciBfc3RvcEFuaW1hdGlvbjsKICAgICAgKF9zdG9wQW5pbWF0aW9uID0gc3RvcEFuaW1hdGlvbikgPT09IG51bGwgfHwgX3N0b3BBbmltYXRpb24gPT09IHZvaWQgMCB8fCBfc3RvcEFuaW1hdGlvbigpOwogICAgfTsKICB9Owp9CmZ1bmN0aW9uIGNyZWF0ZVRpbWluZ1VwZGF0ZShmcm9tMiwgdG8yLCBlYXNpbmcsIGR1cmF0aW9uLCBpbnRlcktleXMsIHJlbmRlciwgdGltZW91dENvbnRyb2xsZXIpIHsKICB2YXIgc3RvcEFuaW1hdGlvbiA9IG51bGw7CiAgdmFyIHRpbWluZ1N0eWxlID0gaW50ZXJLZXlzLnJlZHVjZSgocmVzLCBrZXkpID0+IF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIHJlcyksIHt9LCB7CiAgICBba2V5XTogW2Zyb20yW2tleV0sIHRvMltrZXldXQogIH0pLCB7fSk7CiAgdmFyIGJlZ2luVGltZTsKICB2YXIgdGltaW5nVXBkYXRlID0gKG5vdykgPT4gewogICAgaWYgKCFiZWdpblRpbWUpIHsKICAgICAgYmVnaW5UaW1lID0gbm93OwogICAgfQogICAgdmFyIHQgPSAobm93IC0gYmVnaW5UaW1lKSAvIGR1cmF0aW9uOwogICAgdmFyIGN1cnJTdHlsZSA9IG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IGFscGhhKC4uLnZhbCwgZWFzaW5nKHQpKSwgdGltaW5nU3R5bGUpOwogICAgcmVuZGVyKF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCBmcm9tMiksIHRvMiksIGN1cnJTdHlsZSkpOwogICAgaWYgKHQgPCAxKSB7CiAgICAgIHN0b3BBbmltYXRpb24gPSB0aW1lb3V0Q29udHJvbGxlci5zZXRUaW1lb3V0KHRpbWluZ1VwZGF0ZSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgZmluYWxTdHlsZSA9IG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IGFscGhhKC4uLnZhbCwgZWFzaW5nKDEpKSwgdGltaW5nU3R5bGUpOwogICAgICByZW5kZXIoX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoe30sIGZyb20yKSwgdG8yKSwgZmluYWxTdHlsZSkpOwogICAgfQogIH07CiAgcmV0dXJuICgpID0+IHsKICAgIHN0b3BBbmltYXRpb24gPSB0aW1lb3V0Q29udHJvbGxlci5zZXRUaW1lb3V0KHRpbWluZ1VwZGF0ZSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICB2YXIgX3N0b3BBbmltYXRpb24yOwogICAgICAoX3N0b3BBbmltYXRpb24yID0gc3RvcEFuaW1hdGlvbikgPT09IG51bGwgfHwgX3N0b3BBbmltYXRpb24yID09PSB2b2lkIDAgfHwgX3N0b3BBbmltYXRpb24yKCk7CiAgICB9OwogIH07Cn0KdmFyIGNvbmZpZ1VwZGF0ZV9kZWZhdWx0ID0gKGZyb20yLCB0bzIsIGVhc2luZywgZHVyYXRpb24sIHJlbmRlciwgdGltZW91dENvbnRyb2xsZXIpID0+IHsKICB2YXIgaW50ZXJLZXlzID0gZ2V0SW50ZXJzZWN0aW9uS2V5cyhmcm9tMiwgdG8yKTsKICBpZiAoZWFzaW5nID09IG51bGwpIHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHJlbmRlcihfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCBmcm9tMiksIHRvMikpOwogICAgICByZXR1cm4gKCkgPT4gewogICAgICB9OwogICAgfTsKICB9CiAgcmV0dXJuIGVhc2luZy5pc1N0ZXBwZXIgPT09IHRydWUgPyBjcmVhdGVTdGVwcGVyVXBkYXRlKGZyb20yLCB0bzIsIGVhc2luZywgaW50ZXJLZXlzLCByZW5kZXIsIHRpbWVvdXRDb250cm9sbGVyKSA6IGNyZWF0ZVRpbWluZ1VwZGF0ZShmcm9tMiwgdG8yLCBlYXNpbmcsIGR1cmF0aW9uLCBpbnRlcktleXMsIHJlbmRlciwgdGltZW91dENvbnRyb2xsZXIpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vZWFzaW5nLmpzCnZhciBBQ0NVUkFDWSA9IDFlLTQ7CnZhciBjdWJpY0JlemllckZhY3RvciA9IChjMSwgYzIpID0+IFswLCAzICogYzEsIDMgKiBjMiAtIDYgKiBjMSwgMyAqIGMxIC0gMyAqIGMyICsgMV07CnZhciBldmFsdWF0ZVBvbHlub21pYWwgPSAocGFyYW1zLCB0KSA9PiBwYXJhbXMubWFwKChwYXJhbSwgaSkgPT4gcGFyYW0gKiB0ICoqIGkpLnJlZHVjZSgocHJlLCBjdXJyKSA9PiBwcmUgKyBjdXJyKTsKdmFyIGN1YmljQmV6aWVyID0gKGMxLCBjMikgPT4gKHQpID0+IHsKICB2YXIgcGFyYW1zID0gY3ViaWNCZXppZXJGYWN0b3IoYzEsIGMyKTsKICByZXR1cm4gZXZhbHVhdGVQb2x5bm9taWFsKHBhcmFtcywgdCk7Cn07CnZhciBkZXJpdmF0aXZlQ3ViaWNCZXppZXIgPSAoYzEsIGMyKSA9PiAodCkgPT4gewogIHZhciBwYXJhbXMgPSBjdWJpY0JlemllckZhY3RvcihjMSwgYzIpOwogIHZhciBuZXdQYXJhbXMgPSBbLi4ucGFyYW1zLm1hcCgocGFyYW0sIGkpID0+IHBhcmFtICogaSkuc2xpY2UoMSksIDBdOwogIHJldHVybiBldmFsdWF0ZVBvbHlub21pYWwobmV3UGFyYW1zLCB0KTsKfTsKdmFyIGdldEJlemllckNvb3JkaW5hdGVzID0gZnVuY3Rpb24gZ2V0QmV6aWVyQ29vcmRpbmF0ZXMyKCkgewogIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgYXJnc1tfa2V5XSA9IGFyZ3VtZW50c1tfa2V5XTsKICB9CiAgaWYgKGFyZ3MubGVuZ3RoID09PSAxKSB7CiAgICBzd2l0Y2ggKGFyZ3NbMF0pIHsKICAgICAgY2FzZSAibGluZWFyIjoKICAgICAgICByZXR1cm4gWzAsIDAsIDEsIDFdOwogICAgICBjYXNlICJlYXNlIjoKICAgICAgICByZXR1cm4gWzAuMjUsIDAuMSwgMC4yNSwgMV07CiAgICAgIGNhc2UgImVhc2UtaW4iOgogICAgICAgIHJldHVybiBbMC40MiwgMCwgMSwgMV07CiAgICAgIGNhc2UgImVhc2Utb3V0IjoKICAgICAgICByZXR1cm4gWzAuNDIsIDAsIDAuNTgsIDFdOwogICAgICBjYXNlICJlYXNlLWluLW91dCI6CiAgICAgICAgcmV0dXJuIFswLCAwLCAwLjU4LCAxXTsKICAgICAgZGVmYXVsdDogewogICAgICAgIHZhciBfZWFzaW5nJDsKICAgICAgICB2YXIgZWFzaW5nID0gYXJnc1swXS5zcGxpdCgiKCIpOwogICAgICAgIGlmIChlYXNpbmdbMF0gPT09ICJjdWJpYy1iZXppZXIiICYmICgoX2Vhc2luZyQgPSBlYXNpbmdbMV0pID09PSBudWxsIHx8IF9lYXNpbmckID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZWFzaW5nJC5zcGxpdCgiKSIpWzBdLnNwbGl0KCIsIikubGVuZ3RoKSA9PT0gNCkgewogICAgICAgICAgdmFyIGNvb3JkcyA9IGVhc2luZ1sxXS5zcGxpdCgiKSIpWzBdLnNwbGl0KCIsIikubWFwKCh4MikgPT4gcGFyc2VGbG9hdCh4MikpOwogICAgICAgICAgcmV0dXJuIFtjb29yZHNbMF0sIGNvb3Jkc1sxXSwgY29vcmRzWzJdLCBjb29yZHNbM11dOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICBpZiAoYXJncy5sZW5ndGggPT09IDQpIHsKICAgIHJldHVybiBhcmdzOwogIH0KICByZXR1cm4gWzAsIDAsIDEsIDFdOwp9Owp2YXIgY3JlYXRlQmV6aWVyRWFzaW5nID0gKHgxLCB5MSwgeDIsIHkyKSA9PiB7CiAgdmFyIGN1cnZlWCA9IGN1YmljQmV6aWVyKHgxLCB4Mik7CiAgdmFyIGN1cnZlWSA9IGN1YmljQmV6aWVyKHkxLCB5Mik7CiAgdmFyIGRlckN1cnZlWCA9IGRlcml2YXRpdmVDdWJpY0Jlemllcih4MSwgeDIpOwogIHZhciByYW5nZVZhbHVlID0gKHZhbHVlKSA9PiB7CiAgICBpZiAodmFsdWUgPiAxKSB7CiAgICAgIHJldHVybiAxOwogICAgfQogICAgaWYgKHZhbHVlIDwgMCkgewogICAgICByZXR1cm4gMDsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKICB9OwogIHZhciBiZXppZXIgPSAoX3QpID0+IHsKICAgIHZhciB0ID0gX3QgPiAxID8gMSA6IF90OwogICAgdmFyIHgzID0gdDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgODsgKytpKSB7CiAgICAgIHZhciBldmFsVCA9IGN1cnZlWCh4MykgLSB0OwogICAgICB2YXIgZGVyVmFsID0gZGVyQ3VydmVYKHgzKTsKICAgICAgaWYgKE1hdGguYWJzKGV2YWxUIC0gdCkgPCBBQ0NVUkFDWSB8fCBkZXJWYWwgPCBBQ0NVUkFDWSkgewogICAgICAgIHJldHVybiBjdXJ2ZVkoeDMpOwogICAgICB9CiAgICAgIHgzID0gcmFuZ2VWYWx1ZSh4MyAtIGV2YWxUIC8gZGVyVmFsKTsKICAgIH0KICAgIHJldHVybiBjdXJ2ZVkoeDMpOwogIH07CiAgYmV6aWVyLmlzU3RlcHBlciA9IGZhbHNlOwogIHJldHVybiBiZXppZXI7Cn07CnZhciBjb25maWdCZXppZXIgPSBmdW5jdGlvbiBjb25maWdCZXppZXIyKCkgewogIHJldHVybiBjcmVhdGVCZXppZXJFYXNpbmcoLi4uZ2V0QmV6aWVyQ29vcmRpbmF0ZXMoLi4uYXJndW1lbnRzKSk7Cn07CnZhciBjb25maWdTcHJpbmcgPSBmdW5jdGlvbiBjb25maWdTcHJpbmcyKCkgewogIHZhciBjb25maWcgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1swXSA6IHt9OwogIHZhciB7CiAgICBzdGlmZiA9IDEwMCwKICAgIGRhbXBpbmcgPSA4LAogICAgZHQgPSAxNwogIH0gPSBjb25maWc7CiAgdmFyIHN0ZXBwZXIgPSAoY3VyclgsIGRlc3RYLCBjdXJyVikgPT4gewogICAgdmFyIEZTcHJpbmcgPSAtKGN1cnJYIC0gZGVzdFgpICogc3RpZmY7CiAgICB2YXIgRkRhbXBpbmcgPSBjdXJyViAqIGRhbXBpbmc7CiAgICB2YXIgbmV3ViA9IGN1cnJWICsgKEZTcHJpbmcgLSBGRGFtcGluZykgKiBkdCAvIDFlMzsKICAgIHZhciBuZXdYID0gY3VyclYgKiBkdCAvIDFlMyArIGN1cnJYOwogICAgaWYgKE1hdGguYWJzKG5ld1ggLSBkZXN0WCkgPCBBQ0NVUkFDWSAmJiBNYXRoLmFicyhuZXdWKSA8IEFDQ1VSQUNZKSB7CiAgICAgIHJldHVybiBbZGVzdFgsIDBdOwogICAgfQogICAgcmV0dXJuIFtuZXdYLCBuZXdWXTsKICB9OwogIHN0ZXBwZXIuaXNTdGVwcGVyID0gdHJ1ZTsKICBzdGVwcGVyLmR0ID0gZHQ7CiAgcmV0dXJuIHN0ZXBwZXI7Cn07CnZhciBjb25maWdFYXNpbmcgPSAoZWFzaW5nKSA9PiB7CiAgaWYgKHR5cGVvZiBlYXNpbmcgPT09ICJzdHJpbmciKSB7CiAgICBzd2l0Y2ggKGVhc2luZykgewogICAgICBjYXNlICJlYXNlIjoKICAgICAgY2FzZSAiZWFzZS1pbi1vdXQiOgogICAgICBjYXNlICJlYXNlLW91dCI6CiAgICAgIGNhc2UgImVhc2UtaW4iOgogICAgICBjYXNlICJsaW5lYXIiOgogICAgICAgIHJldHVybiBjb25maWdCZXppZXIoZWFzaW5nKTsKICAgICAgY2FzZSAic3ByaW5nIjoKICAgICAgICByZXR1cm4gY29uZmlnU3ByaW5nKCk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgaWYgKGVhc2luZy5zcGxpdCgiKCIpWzBdID09PSAiY3ViaWMtYmV6aWVyIikgewogICAgICAgICAgcmV0dXJuIGNvbmZpZ0JlemllcihlYXNpbmcpOwogICAgICAgIH0KICAgIH0KICB9CiAgaWYgKHR5cGVvZiBlYXNpbmcgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBlYXNpbmc7CiAgfQogIHJldHVybiBudWxsOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vdXNlQW5pbWF0aW9uTWFuYWdlci5qcwp2YXIgaW1wb3J0X3JlYWN0MTUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi9BbmltYXRpb25NYW5hZ2VyLmpzCmZ1bmN0aW9uIGNyZWF0ZUFuaW1hdGVNYW5hZ2VyKHRpbWVvdXRDb250cm9sbGVyKSB7CiAgdmFyIGN1cnJTdHlsZTsKICB2YXIgaGFuZGxlQ2hhbmdlID0gKCkgPT4gbnVsbDsKICB2YXIgc2hvdWxkU3RvcCA9IGZhbHNlOwogIHZhciBjYW5jZWxUaW1lb3V0ID0gbnVsbDsKICB2YXIgc2V0U3R5bGUgPSAoX3N0eWxlKSA9PiB7CiAgICBpZiAoc2hvdWxkU3RvcCkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoQXJyYXkuaXNBcnJheShfc3R5bGUpKSB7CiAgICAgIGlmICghX3N0eWxlLmxlbmd0aCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgc3R5bGVzID0gX3N0eWxlOwogICAgICB2YXIgW2N1cnIsIC4uLnJlc3RTdHlsZXNdID0gc3R5bGVzOwogICAgICBpZiAodHlwZW9mIGN1cnIgPT09ICJudW1iZXIiKSB7CiAgICAgICAgY2FuY2VsVGltZW91dCA9IHRpbWVvdXRDb250cm9sbGVyLnNldFRpbWVvdXQoc2V0U3R5bGUuYmluZChudWxsLCByZXN0U3R5bGVzKSwgY3Vycik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHNldFN0eWxlKGN1cnIpOwogICAgICBjYW5jZWxUaW1lb3V0ID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dChzZXRTdHlsZS5iaW5kKG51bGwsIHJlc3RTdHlsZXMpKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHR5cGVvZiBfc3R5bGUgPT09ICJzdHJpbmciKSB7CiAgICAgIGN1cnJTdHlsZSA9IF9zdHlsZTsKICAgICAgaGFuZGxlQ2hhbmdlKGN1cnJTdHlsZSk7CiAgICB9CiAgICBpZiAodHlwZW9mIF9zdHlsZSA9PT0gIm9iamVjdCIpIHsKICAgICAgY3VyclN0eWxlID0gX3N0eWxlOwogICAgICBoYW5kbGVDaGFuZ2UoY3VyclN0eWxlKTsKICAgIH0KICAgIGlmICh0eXBlb2YgX3N0eWxlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIF9zdHlsZSgpOwogICAgfQogIH07CiAgcmV0dXJuIHsKICAgIHN0b3A6ICgpID0+IHsKICAgICAgc2hvdWxkU3RvcCA9IHRydWU7CiAgICB9LAogICAgc3RhcnQ6IChzdHlsZSkgPT4gewogICAgICBzaG91bGRTdG9wID0gZmFsc2U7CiAgICAgIGlmIChjYW5jZWxUaW1lb3V0KSB7CiAgICAgICAgY2FuY2VsVGltZW91dCgpOwogICAgICAgIGNhbmNlbFRpbWVvdXQgPSBudWxsOwogICAgICB9CiAgICAgIHNldFN0eWxlKHN0eWxlKTsKICAgIH0sCiAgICBzdWJzY3JpYmU6IChfaGFuZGxlQ2hhbmdlKSA9PiB7CiAgICAgIGhhbmRsZUNoYW5nZSA9IF9oYW5kbGVDaGFuZ2U7CiAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgaGFuZGxlQ2hhbmdlID0gKCkgPT4gbnVsbDsKICAgICAgfTsKICAgIH0sCiAgICBnZXRUaW1lb3V0Q29udHJvbGxlcjogKCkgPT4gdGltZW91dENvbnRyb2xsZXIKICB9Owp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi90aW1lb3V0Q29udHJvbGxlci5qcwp2YXIgUmVxdWVzdEFuaW1hdGlvbkZyYW1lVGltZW91dENvbnRyb2xsZXIgPSBjbGFzcyB7CiAgc2V0VGltZW91dChjYWxsYmFjaykgewogICAgdmFyIGRlbGF5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiAwOwogICAgdmFyIHN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpOwogICAgdmFyIHJlcXVlc3RJZCA9IG51bGw7CiAgICB2YXIgZXhlY3V0ZUNhbGxiYWNrID0gKG5vdykgPT4gewogICAgICBpZiAobm93IC0gc3RhcnRUaW1lID49IGRlbGF5KSB7CiAgICAgICAgY2FsbGJhY2sobm93KTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcmVxdWVzdEFuaW1hdGlvbkZyYW1lID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgcmVxdWVzdElkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGV4ZWN1dGVDYWxsYmFjayk7CiAgICAgIH0KICAgIH07CiAgICByZXF1ZXN0SWQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZXhlY3V0ZUNhbGxiYWNrKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChyZXF1ZXN0SWQgIT0gbnVsbCkgewogICAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHJlcXVlc3RJZCk7CiAgICAgIH0KICAgIH07CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vY3JlYXRlRGVmYXVsdEFuaW1hdGlvbk1hbmFnZXIuanMKZnVuY3Rpb24gY3JlYXRlRGVmYXVsdEFuaW1hdGlvbk1hbmFnZXIoKSB7CiAgcmV0dXJuIGNyZWF0ZUFuaW1hdGVNYW5hZ2VyKG5ldyBSZXF1ZXN0QW5pbWF0aW9uRnJhbWVUaW1lb3V0Q29udHJvbGxlcigpKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vdXNlQW5pbWF0aW9uTWFuYWdlci5qcwp2YXIgQW5pbWF0aW9uTWFuYWdlckNvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDE1LmNyZWF0ZUNvbnRleHQpKGNyZWF0ZURlZmF1bHRBbmltYXRpb25NYW5hZ2VyKTsKZnVuY3Rpb24gdXNlQW5pbWF0aW9uTWFuYWdlcihhbmltYXRpb25JZCwgYW5pbWF0aW9uTWFuYWdlckZyb21Qcm9wcykgewogIHZhciBjb250ZXh0QW5pbWF0aW9uTWFuYWdlciA9ICgwLCBpbXBvcnRfcmVhY3QxNS51c2VDb250ZXh0KShBbmltYXRpb25NYW5hZ2VyQ29udGV4dCk7CiAgcmV0dXJuICgwLCBpbXBvcnRfcmVhY3QxNS51c2VNZW1vKSgoKSA9PiBhbmltYXRpb25NYW5hZ2VyRnJvbVByb3BzICE9PSBudWxsICYmIGFuaW1hdGlvbk1hbmFnZXJGcm9tUHJvcHMgIT09IHZvaWQgMCA/IGFuaW1hdGlvbk1hbmFnZXJGcm9tUHJvcHMgOiBjb250ZXh0QW5pbWF0aW9uTWFuYWdlcihhbmltYXRpb25JZCksIFthbmltYXRpb25JZCwgYW5pbWF0aW9uTWFuYWdlckZyb21Qcm9wcywgY29udGV4dEFuaW1hdGlvbk1hbmFnZXJdKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0dsb2JhbC5qcwp2YXIgcGFyc2VJc1NzckJ5RGVmYXVsdCA9ICgpID0+ICEodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LmRvY3VtZW50ICYmIEJvb2xlYW4od2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQpICYmIHdpbmRvdy5zZXRUaW1lb3V0KTsKdmFyIEdsb2JhbCA9IHsKICBkZXZUb29sc0VuYWJsZWQ6IGZhbHNlLAogIGlzU3NyOiBwYXJzZUlzU3NyQnlEZWZhdWx0KCkKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL0phdmFzY3JpcHRBbmltYXRlLmpzCnZhciBkZWZhdWx0SmF2YXNjcmlwdEFuaW1hdGVQcm9wcyA9IHsKICBiZWdpbjogMCwKICBkdXJhdGlvbjogMWUzLAogIGVhc2luZzogImVhc2UiLAogIGlzQWN0aXZlOiB0cnVlLAogIGNhbkJlZ2luOiB0cnVlLAogIG9uQW5pbWF0aW9uRW5kOiAoKSA9PiB7CiAgfSwKICBvbkFuaW1hdGlvblN0YXJ0OiAoKSA9PiB7CiAgfQp9Owp2YXIgZnJvbSA9IHsKICB0OiAwCn07CnZhciB0byA9IHsKICB0OiAxCn07CmZ1bmN0aW9uIEphdmFzY3JpcHRBbmltYXRlKG91dHNpZGVQcm9wcykgewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCBkZWZhdWx0SmF2YXNjcmlwdEFuaW1hdGVQcm9wcyk7CiAgdmFyIHsKICAgIGlzQWN0aXZlOiBpc0FjdGl2ZVByb3AsCiAgICBjYW5CZWdpbiwKICAgIGR1cmF0aW9uLAogICAgZWFzaW5nLAogICAgYmVnaW4sCiAgICBvbkFuaW1hdGlvbkVuZCwKICAgIG9uQW5pbWF0aW9uU3RhcnQsCiAgICBjaGlsZHJlbgogIH0gPSBwcm9wczsKICB2YXIgaXNBY3RpdmUgPSBpc0FjdGl2ZVByb3AgPT09ICJhdXRvIiA/ICFHbG9iYWwuaXNTc3IgOiBpc0FjdGl2ZVByb3A7CiAgdmFyIGFuaW1hdGlvbk1hbmFnZXIgPSB1c2VBbmltYXRpb25NYW5hZ2VyKHByb3BzLmFuaW1hdGlvbklkLCBwcm9wcy5hbmltYXRpb25NYW5hZ2VyKTsKICB2YXIgW3N0eWxlLCBzZXRTdHlsZV0gPSAoMCwgaW1wb3J0X3JlYWN0MTYudXNlU3RhdGUpKGlzQWN0aXZlID8gZnJvbSA6IHRvKTsKICB2YXIgc3RvcEpTQW5pbWF0aW9uID0gKDAsIGltcG9ydF9yZWFjdDE2LnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDE2LnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFpc0FjdGl2ZSkgewogICAgICBzZXRTdHlsZSh0byk7CiAgICB9CiAgfSwgW2lzQWN0aXZlXSk7CiAgKDAsIGltcG9ydF9yZWFjdDE2LnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFpc0FjdGl2ZSB8fCAhY2FuQmVnaW4pIHsKICAgICAgcmV0dXJuIG5vb3A7CiAgICB9CiAgICB2YXIgc3RhcnRBbmltYXRpb24gPSBjb25maWdVcGRhdGVfZGVmYXVsdChmcm9tLCB0bywgY29uZmlnRWFzaW5nKGVhc2luZyksIGR1cmF0aW9uLCBzZXRTdHlsZSwgYW5pbWF0aW9uTWFuYWdlci5nZXRUaW1lb3V0Q29udHJvbGxlcigpKTsKICAgIHZhciBvbkFuaW1hdGlvbkFjdGl2ZSA9ICgpID0+IHsKICAgICAgc3RvcEpTQW5pbWF0aW9uLmN1cnJlbnQgPSBzdGFydEFuaW1hdGlvbigpOwogICAgfTsKICAgIGFuaW1hdGlvbk1hbmFnZXIuc3RhcnQoW29uQW5pbWF0aW9uU3RhcnQsIGJlZ2luLCBvbkFuaW1hdGlvbkFjdGl2ZSwgZHVyYXRpb24sIG9uQW5pbWF0aW9uRW5kXSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBhbmltYXRpb25NYW5hZ2VyLnN0b3AoKTsKICAgICAgaWYgKHN0b3BKU0FuaW1hdGlvbi5jdXJyZW50KSB7CiAgICAgICAgc3RvcEpTQW5pbWF0aW9uLmN1cnJlbnQoKTsKICAgICAgfQogICAgICBvbkFuaW1hdGlvbkVuZCgpOwogICAgfTsKICB9LCBbaXNBY3RpdmUsIGNhbkJlZ2luLCBkdXJhdGlvbiwgZWFzaW5nLCBiZWdpbiwgb25BbmltYXRpb25TdGFydCwgb25BbmltYXRpb25FbmQsIGFuaW1hdGlvbk1hbmFnZXJdKTsKICByZXR1cm4gY2hpbGRyZW4oc3R5bGUudCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VBbmltYXRpb25JZC5qcwp2YXIgaW1wb3J0X3JlYWN0MTcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIHVzZUFuaW1hdGlvbklkKGlucHV0KSB7CiAgdmFyIHByZWZpeCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDogImFuaW1hdGlvbi0iOwogIHZhciBhbmltYXRpb25JZCA9ICgwLCBpbXBvcnRfcmVhY3QxNy51c2VSZWYpKHVuaXF1ZUlkKHByZWZpeCkpOwogIHZhciBwcmV2UHJvcHMgPSAoMCwgaW1wb3J0X3JlYWN0MTcudXNlUmVmKShpbnB1dCk7CiAgaWYgKHByZXZQcm9wcy5jdXJyZW50ICE9PSBpbnB1dCkgewogICAgYW5pbWF0aW9uSWQuY3VycmVudCA9IHVuaXF1ZUlkKHByZWZpeCk7CiAgICBwcmV2UHJvcHMuY3VycmVudCA9IGlucHV0OwogIH0KICByZXR1cm4gYW5pbWF0aW9uSWQuY3VycmVudDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zaGFwZS9SZWN0YW5nbGUuanMKdmFyIF9leGNsdWRlZDQgPSBbInJhZGl1cyJdOwp2YXIgX2V4Y2x1ZGVkMjIgPSBbInJhZGl1cyJdOwpmdW5jdGlvbiBvd25LZXlzMTEoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxMShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czExKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxMShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxMShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTEoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxMShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxMSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxMSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxMSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gX2V4dGVuZHM3KCkgewogIHJldHVybiBfZXh0ZW5kczcgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczcuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM0KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U0KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U0KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgZ2V0UmVjdGFuZ2xlUGF0aCA9ICh4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIHJhZGl1cykgPT4gewogIHZhciBtYXhSYWRpdXMgPSBNYXRoLm1pbihNYXRoLmFicyh3aWR0aCkgLyAyLCBNYXRoLmFicyhoZWlnaHQpIC8gMik7CiAgdmFyIHlTaWduID0gaGVpZ2h0ID49IDAgPyAxIDogLTE7CiAgdmFyIHhTaWduID0gd2lkdGggPj0gMCA/IDEgOiAtMTsKICB2YXIgY2xvY2tXaXNlID0gaGVpZ2h0ID49IDAgJiYgd2lkdGggPj0gMCB8fCBoZWlnaHQgPCAwICYmIHdpZHRoIDwgMCA/IDEgOiAwOwogIHZhciBwYXRoMjsKICBpZiAobWF4UmFkaXVzID4gMCAmJiByYWRpdXMgaW5zdGFuY2VvZiBBcnJheSkgewogICAgdmFyIG5ld1JhZGl1cyA9IFswLCAwLCAwLCAwXTsKICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSA0OyBpIDwgbGVuOyBpKyspIHsKICAgICAgbmV3UmFkaXVzW2ldID0gcmFkaXVzW2ldID4gbWF4UmFkaXVzID8gbWF4UmFkaXVzIDogcmFkaXVzW2ldOwogICAgfQogICAgcGF0aDIgPSAiTSIuY29uY2F0KHgyLCAiLCIpLmNvbmNhdCh5MiArIHlTaWduICogbmV3UmFkaXVzWzBdKTsKICAgIGlmIChuZXdSYWRpdXNbMF0gPiAwKSB7CiAgICAgIHBhdGgyICs9ICJBICIuY29uY2F0KG5ld1JhZGl1c1swXSwgIiwiKS5jb25jYXQobmV3UmFkaXVzWzBdLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLCIpLmNvbmNhdCh4MiArIHhTaWduICogbmV3UmFkaXVzWzBdLCAiLCIpLmNvbmNhdCh5Mik7CiAgICB9CiAgICBwYXRoMiArPSAiTCAiLmNvbmNhdCh4MiArIHdpZHRoIC0geFNpZ24gKiBuZXdSYWRpdXNbMV0sICIsIikuY29uY2F0KHkyKTsKICAgIGlmIChuZXdSYWRpdXNbMV0gPiAwKSB7CiAgICAgIHBhdGgyICs9ICJBICIuY29uY2F0KG5ld1JhZGl1c1sxXSwgIiwiKS5jb25jYXQobmV3UmFkaXVzWzFdLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLFxuICAgICAgICAiKS5jb25jYXQoeDIgKyB3aWR0aCwgIiwiKS5jb25jYXQoeTIgKyB5U2lnbiAqIG5ld1JhZGl1c1sxXSk7CiAgICB9CiAgICBwYXRoMiArPSAiTCAiLmNvbmNhdCh4MiArIHdpZHRoLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCAtIHlTaWduICogbmV3UmFkaXVzWzJdKTsKICAgIGlmIChuZXdSYWRpdXNbMl0gPiAwKSB7CiAgICAgIHBhdGgyICs9ICJBICIuY29uY2F0KG5ld1JhZGl1c1syXSwgIiwiKS5jb25jYXQobmV3UmFkaXVzWzJdLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLFxuICAgICAgICAiKS5jb25jYXQoeDIgKyB3aWR0aCAtIHhTaWduICogbmV3UmFkaXVzWzJdLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCk7CiAgICB9CiAgICBwYXRoMiArPSAiTCAiLmNvbmNhdCh4MiArIHhTaWduICogbmV3UmFkaXVzWzNdLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCk7CiAgICBpZiAobmV3UmFkaXVzWzNdID4gMCkgewogICAgICBwYXRoMiArPSAiQSAiLmNvbmNhdChuZXdSYWRpdXNbM10sICIsIikuY29uY2F0KG5ld1JhZGl1c1szXSwgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIixcbiAgICAgICAgIikuY29uY2F0KHgyLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCAtIHlTaWduICogbmV3UmFkaXVzWzNdKTsKICAgIH0KICAgIHBhdGgyICs9ICJaIjsKICB9IGVsc2UgaWYgKG1heFJhZGl1cyA+IDAgJiYgcmFkaXVzID09PSArcmFkaXVzICYmIHJhZGl1cyA+IDApIHsKICAgIHZhciBfbmV3UmFkaXVzID0gTWF0aC5taW4obWF4UmFkaXVzLCByYWRpdXMpOwogICAgcGF0aDIgPSAiTSAiLmNvbmNhdCh4MiwgIiwiKS5jb25jYXQoeTIgKyB5U2lnbiAqIF9uZXdSYWRpdXMsICJcbiAgICAgICAgICAgIEEgIikuY29uY2F0KF9uZXdSYWRpdXMsICIsIikuY29uY2F0KF9uZXdSYWRpdXMsICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsIikuY29uY2F0KHgyICsgeFNpZ24gKiBfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdCh5MiwgIlxuICAgICAgICAgICAgTCAiKS5jb25jYXQoeDIgKyB3aWR0aCAtIHhTaWduICogX25ld1JhZGl1cywgIiwiKS5jb25jYXQoeTIsICJcbiAgICAgICAgICAgIEEgIikuY29uY2F0KF9uZXdSYWRpdXMsICIsIikuY29uY2F0KF9uZXdSYWRpdXMsICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsIikuY29uY2F0KHgyICsgd2lkdGgsICIsIikuY29uY2F0KHkyICsgeVNpZ24gKiBfbmV3UmFkaXVzLCAiXG4gICAgICAgICAgICBMICIpLmNvbmNhdCh4MiArIHdpZHRoLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCAtIHlTaWduICogX25ld1JhZGl1cywgIlxuICAgICAgICAgICAgQSAiKS5jb25jYXQoX25ld1JhZGl1cywgIiwiKS5jb25jYXQoX25ld1JhZGl1cywgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIiwiKS5jb25jYXQoeDIgKyB3aWR0aCAtIHhTaWduICogX25ld1JhZGl1cywgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQsICJcbiAgICAgICAgICAgIEwgIikuY29uY2F0KHgyICsgeFNpZ24gKiBfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCwgIlxuICAgICAgICAgICAgQSAiKS5jb25jYXQoX25ld1JhZGl1cywgIiwiKS5jb25jYXQoX25ld1JhZGl1cywgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIiwiKS5jb25jYXQoeDIsICIsIikuY29uY2F0KHkyICsgaGVpZ2h0IC0geVNpZ24gKiBfbmV3UmFkaXVzLCAiIFoiKTsKICB9IGVsc2UgewogICAgcGF0aDIgPSAiTSAiLmNvbmNhdCh4MiwgIiwiKS5jb25jYXQoeTIsICIgaCAiKS5jb25jYXQod2lkdGgsICIgdiAiKS5jb25jYXQoaGVpZ2h0LCAiIGggIikuY29uY2F0KC13aWR0aCwgIiBaIik7CiAgfQogIHJldHVybiBwYXRoMjsKfTsKdmFyIGRlZmF1bHRSZWN0YW5nbGVQcm9wcyA9IHsKICB4OiAwLAogIHk6IDAsCiAgd2lkdGg6IDAsCiAgaGVpZ2h0OiAwLAogIC8vIFRoZSByYWRpdXMgb2YgYm9yZGVyCiAgLy8gVGhlIHJhZGl1cyBvZiBmb3VyIGNvcm5lcnMgd2hlbiByYWRpdXMgaXMgYSBudW1iZXIKICAvLyBUaGUgcmFkaXVzIG9mIGxlZnQtdG9wLCByaWdodC10b3AsIHJpZ2h0LWJvdHRvbSwgbGVmdC1ib3R0b20gd2hlbiByYWRpdXMgaXMgYW4gYXJyYXkKICByYWRpdXM6IDAsCiAgaXNBbmltYXRpb25BY3RpdmU6IGZhbHNlLAogIGlzVXBkYXRlQW5pbWF0aW9uQWN0aXZlOiBmYWxzZSwKICBhbmltYXRpb25CZWdpbjogMCwKICBhbmltYXRpb25EdXJhdGlvbjogMTUwMCwKICBhbmltYXRpb25FYXNpbmc6ICJlYXNlIgp9Owp2YXIgUmVjdGFuZ2xlID0gKHJlY3RhbmdsZVByb3BzKSA9PiB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhyZWN0YW5nbGVQcm9wcywgZGVmYXVsdFJlY3RhbmdsZVByb3BzKTsKICB2YXIgcGF0aFJlZiA9ICgwLCBpbXBvcnRfcmVhY3QxOC51c2VSZWYpKG51bGwpOwogIHZhciBbdG90YWxMZW5ndGgsIHNldFRvdGFsTGVuZ3RoXSA9ICgwLCBpbXBvcnRfcmVhY3QxOC51c2VTdGF0ZSkoLTEpOwogICgwLCBpbXBvcnRfcmVhY3QxOC51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChwYXRoUmVmLmN1cnJlbnQgJiYgcGF0aFJlZi5jdXJyZW50LmdldFRvdGFsTGVuZ3RoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHBhdGhUb3RhbExlbmd0aCA9IHBhdGhSZWYuY3VycmVudC5nZXRUb3RhbExlbmd0aCgpOwogICAgICAgIGlmIChwYXRoVG90YWxMZW5ndGgpIHsKICAgICAgICAgIHNldFRvdGFsTGVuZ3RoKHBhdGhUb3RhbExlbmd0aCk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChfdW51c2VkKSB7CiAgICAgIH0KICAgIH0KICB9LCBbXSk7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHJhZGl1cywKICAgIGNsYXNzTmFtZQogIH0gPSBwcm9wczsKICB2YXIgewogICAgYW5pbWF0aW9uRWFzaW5nLAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25CZWdpbiwKICAgIGlzQW5pbWF0aW9uQWN0aXZlLAogICAgaXNVcGRhdGVBbmltYXRpb25BY3RpdmUKICB9ID0gcHJvcHM7CiAgdmFyIHByZXZXaWR0aFJlZiA9ICgwLCBpbXBvcnRfcmVhY3QxOC51c2VSZWYpKHdpZHRoKTsKICB2YXIgcHJldkhlaWdodFJlZiA9ICgwLCBpbXBvcnRfcmVhY3QxOC51c2VSZWYpKGhlaWdodCk7CiAgdmFyIHByZXZYUmVmID0gKDAsIGltcG9ydF9yZWFjdDE4LnVzZVJlZikoeDIpOwogIHZhciBwcmV2WVJlZiA9ICgwLCBpbXBvcnRfcmVhY3QxOC51c2VSZWYpKHkyKTsKICB2YXIgYW5pbWF0aW9uSWRJbnB1dCA9ICgwLCBpbXBvcnRfcmVhY3QxOC51c2VNZW1vKSgoKSA9PiAoewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgcmFkaXVzCiAgfSksIFt4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIHJhZGl1c10pOwogIHZhciBhbmltYXRpb25JZCA9IHVzZUFuaW1hdGlvbklkKGFuaW1hdGlvbklkSW5wdXQsICJyZWN0YW5nbGUtIik7CiAgaWYgKHgyICE9PSAreDIgfHwgeTIgIT09ICt5MiB8fCB3aWR0aCAhPT0gK3dpZHRoIHx8IGhlaWdodCAhPT0gK2hlaWdodCB8fCB3aWR0aCA9PT0gMCB8fCBoZWlnaHQgPT09IDApIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgbGF5ZXJDbGFzcyA9IGNsc3goInJlY2hhcnRzLXJlY3RhbmdsZSIsIGNsYXNzTmFtZSk7CiAgaWYgKCFpc1VwZGF0ZUFuaW1hdGlvbkFjdGl2ZSkgewogICAgdmFyIF9zdmdQcm9wZXJ0aWVzQW5kRXZlbiA9IHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMocHJvcHMpLCB7CiAgICAgIHJhZGl1czogXwogICAgfSA9IF9zdmdQcm9wZXJ0aWVzQW5kRXZlbiwgb3RoZXJQYXRoUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM0KF9zdmdQcm9wZXJ0aWVzQW5kRXZlbiwgX2V4Y2x1ZGVkNCk7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0OS5jcmVhdGVFbGVtZW50KCJwYXRoIiwgX2V4dGVuZHM3KHt9LCBvdGhlclBhdGhQcm9wcywgewogICAgICByYWRpdXM6IHR5cGVvZiByYWRpdXMgPT09ICJudW1iZXIiID8gcmFkaXVzIDogdm9pZCAwLAogICAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MsCiAgICAgIGQ6IGdldFJlY3RhbmdsZVBhdGgoeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCByYWRpdXMpCiAgICB9KSk7CiAgfQogIHZhciBwcmV2V2lkdGggPSBwcmV2V2lkdGhSZWYuY3VycmVudDsKICB2YXIgcHJldkhlaWdodCA9IHByZXZIZWlnaHRSZWYuY3VycmVudDsKICB2YXIgcHJldlggPSBwcmV2WFJlZi5jdXJyZW50OwogIHZhciBwcmV2WSA9IHByZXZZUmVmLmN1cnJlbnQ7CiAgdmFyIGZyb20yID0gIjBweCAiLmNvbmNhdCh0b3RhbExlbmd0aCA9PT0gLTEgPyAxIDogdG90YWxMZW5ndGgsICJweCIpOwogIHZhciB0bzIgPSAiIi5jb25jYXQodG90YWxMZW5ndGgsICJweCAwcHgiKTsKICB2YXIgdHJhbnNpdGlvbiA9IGdldFRyYW5zaXRpb25WYWwoWyJzdHJva2VEYXNoYXJyYXkiXSwgYW5pbWF0aW9uRHVyYXRpb24sIHR5cGVvZiBhbmltYXRpb25FYXNpbmcgPT09ICJzdHJpbmciID8gYW5pbWF0aW9uRWFzaW5nIDogZGVmYXVsdFJlY3RhbmdsZVByb3BzLmFuaW1hdGlvbkVhc2luZyk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDkuY3JlYXRlRWxlbWVudChKYXZhc2NyaXB0QW5pbWF0ZSwgewogICAgYW5pbWF0aW9uSWQsCiAgICBrZXk6IGFuaW1hdGlvbklkLAogICAgY2FuQmVnaW46IHRvdGFsTGVuZ3RoID4gMCwKICAgIGR1cmF0aW9uOiBhbmltYXRpb25EdXJhdGlvbiwKICAgIGVhc2luZzogYW5pbWF0aW9uRWFzaW5nLAogICAgaXNBY3RpdmU6IGlzVXBkYXRlQW5pbWF0aW9uQWN0aXZlLAogICAgYmVnaW46IGFuaW1hdGlvbkJlZ2luCiAgfSwgKHQpID0+IHsKICAgIHZhciBjdXJyV2lkdGggPSBpbnRlcnBvbGF0ZShwcmV2V2lkdGgsIHdpZHRoLCB0KTsKICAgIHZhciBjdXJySGVpZ2h0ID0gaW50ZXJwb2xhdGUocHJldkhlaWdodCwgaGVpZ2h0LCB0KTsKICAgIHZhciBjdXJyWCA9IGludGVycG9sYXRlKHByZXZYLCB4MiwgdCk7CiAgICB2YXIgY3VyclkgPSBpbnRlcnBvbGF0ZShwcmV2WSwgeTIsIHQpOwogICAgaWYgKHBhdGhSZWYuY3VycmVudCkgewogICAgICBwcmV2V2lkdGhSZWYuY3VycmVudCA9IGN1cnJXaWR0aDsKICAgICAgcHJldkhlaWdodFJlZi5jdXJyZW50ID0gY3VyckhlaWdodDsKICAgICAgcHJldlhSZWYuY3VycmVudCA9IGN1cnJYOwogICAgICBwcmV2WVJlZi5jdXJyZW50ID0gY3Vyclk7CiAgICB9CiAgICB2YXIgYW5pbWF0aW9uU3R5bGU7CiAgICBpZiAoIWlzQW5pbWF0aW9uQWN0aXZlKSB7CiAgICAgIGFuaW1hdGlvblN0eWxlID0gewogICAgICAgIHN0cm9rZURhc2hhcnJheTogdG8yCiAgICAgIH07CiAgICB9IGVsc2UgaWYgKHQgPiAwKSB7CiAgICAgIGFuaW1hdGlvblN0eWxlID0gewogICAgICAgIHRyYW5zaXRpb24sCiAgICAgICAgc3Ryb2tlRGFzaGFycmF5OiB0bzIKICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgIGFuaW1hdGlvblN0eWxlID0gewogICAgICAgIHN0cm9rZURhc2hhcnJheTogZnJvbTIKICAgICAgfTsKICAgIH0KICAgIHZhciBfc3ZnUHJvcGVydGllc0FuZEV2ZW4yID0gc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhwcm9wcyksIHsKICAgICAgcmFkaXVzOiBfMgogICAgfSA9IF9zdmdQcm9wZXJ0aWVzQW5kRXZlbjIsIG90aGVyUGF0aFByb3BzMiA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczQoX3N2Z1Byb3BlcnRpZXNBbmRFdmVuMiwgX2V4Y2x1ZGVkMjIpOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDkuY3JlYXRlRWxlbWVudCgicGF0aCIsIF9leHRlbmRzNyh7fSwgb3RoZXJQYXRoUHJvcHMyLCB7CiAgICAgIHJhZGl1czogdHlwZW9mIHJhZGl1cyA9PT0gIm51bWJlciIgPyByYWRpdXMgOiB2b2lkIDAsCiAgICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcywKICAgICAgZDogZ2V0UmVjdGFuZ2xlUGF0aChjdXJyWCwgY3VyclksIGN1cnJXaWR0aCwgY3VyckhlaWdodCwgcmFkaXVzKSwKICAgICAgcmVmOiBwYXRoUmVmLAogICAgICBzdHlsZTogX29iamVjdFNwcmVhZDExKF9vYmplY3RTcHJlYWQxMSh7fSwgYW5pbWF0aW9uU3R5bGUpLCBwcm9wcy5zdHlsZSkKICAgIH0pKTsKICB9KTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9Qb2xhclV0aWxzLmpzCnZhciBpbXBvcnRfcmVhY3QxOSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gb3duS2V5czEyKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTIoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxMihPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTIoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTIoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTEyKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTIocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTIodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTIodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTIodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBSQURJQU4gPSBNYXRoLlBJIC8gMTgwOwp2YXIgcmFkaWFuVG9EZWdyZWUgPSAoYW5nbGVJblJhZGlhbikgPT4gYW5nbGVJblJhZGlhbiAqIDE4MCAvIE1hdGguUEk7CnZhciBwb2xhclRvQ2FydGVzaWFuID0gKGN4LCBjeSwgcmFkaXVzLCBhbmdsZSkgPT4gKHsKICB4OiBjeCArIE1hdGguY29zKC1SQURJQU4gKiBhbmdsZSkgKiByYWRpdXMsCiAgeTogY3kgKyBNYXRoLnNpbigtUkFESUFOICogYW5nbGUpICogcmFkaXVzCn0pOwp2YXIgZ2V0TWF4UmFkaXVzID0gZnVuY3Rpb24gZ2V0TWF4UmFkaXVzMih3aWR0aCwgaGVpZ2h0KSB7CiAgdmFyIG9mZnNldCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzJdIDogewogICAgdG9wOiAwLAogICAgcmlnaHQ6IDAsCiAgICBib3R0b206IDAsCiAgICBsZWZ0OiAwLAogICAgd2lkdGg6IDAsCiAgICBoZWlnaHQ6IDAsCiAgICBicnVzaEJvdHRvbTogMAogIH07CiAgcmV0dXJuIE1hdGgubWluKE1hdGguYWJzKHdpZHRoIC0gKG9mZnNldC5sZWZ0IHx8IDApIC0gKG9mZnNldC5yaWdodCB8fCAwKSksIE1hdGguYWJzKGhlaWdodCAtIChvZmZzZXQudG9wIHx8IDApIC0gKG9mZnNldC5ib3R0b20gfHwgMCkpKSAvIDI7Cn07CnZhciBkaXN0YW5jZUJldHdlZW5Qb2ludHMgPSAocG9pbnQ0LCBhbm90aGVyUG9pbnQpID0+IHsKICB2YXIgewogICAgeDogeDEsCiAgICB5OiB5MQogIH0gPSBwb2ludDQ7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIKICB9ID0gYW5vdGhlclBvaW50OwogIHJldHVybiBNYXRoLnNxcnQoKHgxIC0geDIpICoqIDIgKyAoeTEgLSB5MikgKiogMik7Cn07CnZhciBnZXRBbmdsZU9mUG9pbnQgPSAoX3JlZjIsIF9yZWYyMikgPT4gewogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyCiAgfSA9IF9yZWYyOwogIHZhciB7CiAgICBjeCwKICAgIGN5CiAgfSA9IF9yZWYyMjsKICB2YXIgcmFkaXVzID0gZGlzdGFuY2VCZXR3ZWVuUG9pbnRzKHsKICAgIHg6IHgyLAogICAgeTogeTIKICB9LCB7CiAgICB4OiBjeCwKICAgIHk6IGN5CiAgfSk7CiAgaWYgKHJhZGl1cyA8PSAwKSB7CiAgICByZXR1cm4gewogICAgICByYWRpdXMsCiAgICAgIGFuZ2xlOiAwCiAgICB9OwogIH0KICB2YXIgY29zID0gKHgyIC0gY3gpIC8gcmFkaXVzOwogIHZhciBhbmdsZUluUmFkaWFuID0gTWF0aC5hY29zKGNvcyk7CiAgaWYgKHkyID4gY3kpIHsKICAgIGFuZ2xlSW5SYWRpYW4gPSAyICogTWF0aC5QSSAtIGFuZ2xlSW5SYWRpYW47CiAgfQogIHJldHVybiB7CiAgICByYWRpdXMsCiAgICBhbmdsZTogcmFkaWFuVG9EZWdyZWUoYW5nbGVJblJhZGlhbiksCiAgICBhbmdsZUluUmFkaWFuCiAgfTsKfTsKdmFyIGZvcm1hdEFuZ2xlT2ZTZWN0b3IgPSAoX3JlZjMpID0+IHsKICB2YXIgewogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IF9yZWYzOwogIHZhciBzdGFydENudCA9IE1hdGguZmxvb3Ioc3RhcnRBbmdsZSAvIDM2MCk7CiAgdmFyIGVuZENudCA9IE1hdGguZmxvb3IoZW5kQW5nbGUgLyAzNjApOwogIHZhciBtaW4yID0gTWF0aC5taW4oc3RhcnRDbnQsIGVuZENudCk7CiAgcmV0dXJuIHsKICAgIHN0YXJ0QW5nbGU6IHN0YXJ0QW5nbGUgLSBtaW4yICogMzYwLAogICAgZW5kQW5nbGU6IGVuZEFuZ2xlIC0gbWluMiAqIDM2MAogIH07Cn07CnZhciByZXZlcnNlRm9ybWF0QW5nbGVPZlNlY3RvciA9IChhbmdsZSwgX3JlZjQpID0+IHsKICB2YXIgewogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IF9yZWY0OwogIHZhciBzdGFydENudCA9IE1hdGguZmxvb3Ioc3RhcnRBbmdsZSAvIDM2MCk7CiAgdmFyIGVuZENudCA9IE1hdGguZmxvb3IoZW5kQW5nbGUgLyAzNjApOwogIHZhciBtaW4yID0gTWF0aC5taW4oc3RhcnRDbnQsIGVuZENudCk7CiAgcmV0dXJuIGFuZ2xlICsgbWluMiAqIDM2MDsKfTsKdmFyIGluUmFuZ2VPZlNlY3RvciA9IChfcmVmNSwgdmlld0JveCkgPT4gewogIHZhciB7CiAgICBjaGFydFg6IHgyLAogICAgY2hhcnRZOiB5MgogIH0gPSBfcmVmNTsKICB2YXIgewogICAgcmFkaXVzLAogICAgYW5nbGUKICB9ID0gZ2V0QW5nbGVPZlBvaW50KHsKICAgIHg6IHgyLAogICAgeTogeTIKICB9LCB2aWV3Qm94KTsKICB2YXIgewogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cwogIH0gPSB2aWV3Qm94OwogIGlmIChyYWRpdXMgPCBpbm5lclJhZGl1cyB8fCByYWRpdXMgPiBvdXRlclJhZGl1cykgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmIChyYWRpdXMgPT09IDApIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IGZvcm1hdEFuZ2xlT2ZTZWN0b3Iodmlld0JveCk7CiAgdmFyIGZvcm1hdEFuZ2xlID0gYW5nbGU7CiAgdmFyIGluUmFuZ2U7CiAgaWYgKHN0YXJ0QW5nbGUgPD0gZW5kQW5nbGUpIHsKICAgIHdoaWxlIChmb3JtYXRBbmdsZSA+IGVuZEFuZ2xlKSB7CiAgICAgIGZvcm1hdEFuZ2xlIC09IDM2MDsKICAgIH0KICAgIHdoaWxlIChmb3JtYXRBbmdsZSA8IHN0YXJ0QW5nbGUpIHsKICAgICAgZm9ybWF0QW5nbGUgKz0gMzYwOwogICAgfQogICAgaW5SYW5nZSA9IGZvcm1hdEFuZ2xlID49IHN0YXJ0QW5nbGUgJiYgZm9ybWF0QW5nbGUgPD0gZW5kQW5nbGU7CiAgfSBlbHNlIHsKICAgIHdoaWxlIChmb3JtYXRBbmdsZSA+IHN0YXJ0QW5nbGUpIHsKICAgICAgZm9ybWF0QW5nbGUgLT0gMzYwOwogICAgfQogICAgd2hpbGUgKGZvcm1hdEFuZ2xlIDwgZW5kQW5nbGUpIHsKICAgICAgZm9ybWF0QW5nbGUgKz0gMzYwOwogICAgfQogICAgaW5SYW5nZSA9IGZvcm1hdEFuZ2xlID49IGVuZEFuZ2xlICYmIGZvcm1hdEFuZ2xlIDw9IHN0YXJ0QW5nbGU7CiAgfQogIGlmIChpblJhbmdlKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDEyKF9vYmplY3RTcHJlYWQxMih7fSwgdmlld0JveCksIHt9LCB7CiAgICAgIHJhZGl1cywKICAgICAgYW5nbGU6IHJldmVyc2VGb3JtYXRBbmdsZU9mU2VjdG9yKGZvcm1hdEFuZ2xlLCB2aWV3Qm94KQogICAgfSk7CiAgfQogIHJldHVybiBudWxsOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2N1cnNvci9nZXRSYWRpYWxDdXJzb3JQb2ludHMuanMKZnVuY3Rpb24gZ2V0UmFkaWFsQ3Vyc29yUG9pbnRzKGFjdGl2ZUNvb3JkaW5hdGUpIHsKICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIHJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBhY3RpdmVDb29yZGluYXRlOwogIHZhciBzdGFydFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgc3RhcnRBbmdsZSk7CiAgdmFyIGVuZFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgZW5kQW5nbGUpOwogIHJldHVybiB7CiAgICBwb2ludHM6IFtzdGFydFBvaW50LCBlbmRQb2ludF0sCiAgICBjeCwKICAgIGN5LAogICAgcmFkaXVzLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zaGFwZS9TZWN0b3IuanMKdmFyIFJlYWN0MTAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIF9leHRlbmRzOCgpIHsKICByZXR1cm4gX2V4dGVuZHM4ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHM4LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KdmFyIGdldERlbHRhQW5nbGUgPSAoc3RhcnRBbmdsZSwgZW5kQW5nbGUpID0+IHsKICB2YXIgc2lnbjIgPSBtYXRoU2lnbihlbmRBbmdsZSAtIHN0YXJ0QW5nbGUpOwogIHZhciBkZWx0YUFuZ2xlID0gTWF0aC5taW4oTWF0aC5hYnMoZW5kQW5nbGUgLSBzdGFydEFuZ2xlKSwgMzU5Ljk5OSk7CiAgcmV0dXJuIHNpZ24yICogZGVsdGFBbmdsZTsKfTsKdmFyIGdldFRhbmdlbnRDaXJjbGUgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIHJhZGl1cywKICAgIGFuZ2xlLAogICAgc2lnbjogc2lnbjIsCiAgICBpc0V4dGVybmFsLAogICAgY29ybmVyUmFkaXVzLAogICAgY29ybmVySXNFeHRlcm5hbAogIH0gPSBfcmVmMjsKICB2YXIgY2VudGVyUmFkaXVzID0gY29ybmVyUmFkaXVzICogKGlzRXh0ZXJuYWwgPyAxIDogLTEpICsgcmFkaXVzOwogIHZhciB0aGV0YSA9IE1hdGguYXNpbihjb3JuZXJSYWRpdXMgLyBjZW50ZXJSYWRpdXMpIC8gUkFESUFOOwogIHZhciBjZW50ZXJBbmdsZSA9IGNvcm5lcklzRXh0ZXJuYWwgPyBhbmdsZSA6IGFuZ2xlICsgc2lnbjIgKiB0aGV0YTsKICB2YXIgY2VudGVyID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIGNlbnRlclJhZGl1cywgY2VudGVyQW5nbGUpOwogIHZhciBjaXJjbGVUYW5nZW5jeSA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCByYWRpdXMsIGNlbnRlckFuZ2xlKTsKICB2YXIgbGluZVRhbmdlbmN5QW5nbGUgPSBjb3JuZXJJc0V4dGVybmFsID8gYW5nbGUgLSBzaWduMiAqIHRoZXRhIDogYW5nbGU7CiAgdmFyIGxpbmVUYW5nZW5jeSA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBjZW50ZXJSYWRpdXMgKiBNYXRoLmNvcyh0aGV0YSAqIFJBRElBTiksIGxpbmVUYW5nZW5jeUFuZ2xlKTsKICByZXR1cm4gewogICAgY2VudGVyLAogICAgY2lyY2xlVGFuZ2VuY3ksCiAgICBsaW5lVGFuZ2VuY3ksCiAgICB0aGV0YQogIH07Cn07CnZhciBnZXRTZWN0b3JQYXRoID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IF9yZWYyOwogIHZhciBhbmdsZSA9IGdldERlbHRhQW5nbGUoc3RhcnRBbmdsZSwgZW5kQW5nbGUpOwogIHZhciB0ZW1wRW5kQW5nbGUgPSBzdGFydEFuZ2xlICsgYW5nbGU7CiAgdmFyIG91dGVyU3RhcnRQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBvdXRlclJhZGl1cywgc3RhcnRBbmdsZSk7CiAgdmFyIG91dGVyRW5kUG9pbnQgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgb3V0ZXJSYWRpdXMsIHRlbXBFbmRBbmdsZSk7CiAgdmFyIHBhdGgyID0gIk0gIi5jb25jYXQob3V0ZXJTdGFydFBvaW50LngsICIsIikuY29uY2F0KG91dGVyU3RhcnRQb2ludC55LCAiXG4gICAgQSAiKS5jb25jYXQob3V0ZXJSYWRpdXMsICIsIikuY29uY2F0KG91dGVyUmFkaXVzLCAiLDAsXG4gICAgIikuY29uY2F0KCsoTWF0aC5hYnMoYW5nbGUpID4gMTgwKSwgIiwiKS5jb25jYXQoKyhzdGFydEFuZ2xlID4gdGVtcEVuZEFuZ2xlKSwgIixcbiAgICAiKS5jb25jYXQob3V0ZXJFbmRQb2ludC54LCAiLCIpLmNvbmNhdChvdXRlckVuZFBvaW50LnksICJcbiAgIik7CiAgaWYgKGlubmVyUmFkaXVzID4gMCkgewogICAgdmFyIGlubmVyU3RhcnRQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBpbm5lclJhZGl1cywgc3RhcnRBbmdsZSk7CiAgICB2YXIgaW5uZXJFbmRQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBpbm5lclJhZGl1cywgdGVtcEVuZEFuZ2xlKTsKICAgIHBhdGgyICs9ICJMICIuY29uY2F0KGlubmVyRW5kUG9pbnQueCwgIiwiKS5jb25jYXQoaW5uZXJFbmRQb2ludC55LCAiXG4gICAgICAgICAgICBBICIpLmNvbmNhdChpbm5lclJhZGl1cywgIiwiKS5jb25jYXQoaW5uZXJSYWRpdXMsICIsMCxcbiAgICAgICAgICAgICIpLmNvbmNhdCgrKE1hdGguYWJzKGFuZ2xlKSA+IDE4MCksICIsIikuY29uY2F0KCsoc3RhcnRBbmdsZSA8PSB0ZW1wRW5kQW5nbGUpLCAiLFxuICAgICAgICAgICAgIikuY29uY2F0KGlubmVyU3RhcnRQb2ludC54LCAiLCIpLmNvbmNhdChpbm5lclN0YXJ0UG9pbnQueSwgIiBaIik7CiAgfSBlbHNlIHsKICAgIHBhdGgyICs9ICJMICIuY29uY2F0KGN4LCAiLCIpLmNvbmNhdChjeSwgIiBaIik7CiAgfQogIHJldHVybiBwYXRoMjsKfTsKdmFyIGdldFNlY3RvcldpdGhDb3JuZXIgPSAoX3JlZjMpID0+IHsKICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIGlubmVyUmFkaXVzLAogICAgb3V0ZXJSYWRpdXMsCiAgICBjb3JuZXJSYWRpdXMsCiAgICBmb3JjZUNvcm5lclJhZGl1cywKICAgIGNvcm5lcklzRXh0ZXJuYWwsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gX3JlZjM7CiAgdmFyIHNpZ24yID0gbWF0aFNpZ24oZW5kQW5nbGUgLSBzdGFydEFuZ2xlKTsKICB2YXIgewogICAgY2lyY2xlVGFuZ2VuY3k6IHNvY3QsCiAgICBsaW5lVGFuZ2VuY3k6IHNvbHQsCiAgICB0aGV0YTogc290CiAgfSA9IGdldFRhbmdlbnRDaXJjbGUoewogICAgY3gsCiAgICBjeSwKICAgIHJhZGl1czogb3V0ZXJSYWRpdXMsCiAgICBhbmdsZTogc3RhcnRBbmdsZSwKICAgIHNpZ246IHNpZ24yLAogICAgY29ybmVyUmFkaXVzLAogICAgY29ybmVySXNFeHRlcm5hbAogIH0pOwogIHZhciB7CiAgICBjaXJjbGVUYW5nZW5jeTogZW9jdCwKICAgIGxpbmVUYW5nZW5jeTogZW9sdCwKICAgIHRoZXRhOiBlb3QKICB9ID0gZ2V0VGFuZ2VudENpcmNsZSh7CiAgICBjeCwKICAgIGN5LAogICAgcmFkaXVzOiBvdXRlclJhZGl1cywKICAgIGFuZ2xlOiBlbmRBbmdsZSwKICAgIHNpZ246IC1zaWduMiwKICAgIGNvcm5lclJhZGl1cywKICAgIGNvcm5lcklzRXh0ZXJuYWwKICB9KTsKICB2YXIgb3V0ZXJBcmNBbmdsZSA9IGNvcm5lcklzRXh0ZXJuYWwgPyBNYXRoLmFicyhzdGFydEFuZ2xlIC0gZW5kQW5nbGUpIDogTWF0aC5hYnMoc3RhcnRBbmdsZSAtIGVuZEFuZ2xlKSAtIHNvdCAtIGVvdDsKICBpZiAob3V0ZXJBcmNBbmdsZSA8IDApIHsKICAgIGlmIChmb3JjZUNvcm5lclJhZGl1cykgewogICAgICByZXR1cm4gIk0gIi5jb25jYXQoc29sdC54LCAiLCIpLmNvbmNhdChzb2x0LnksICJcbiAgICAgICAgYSIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwwLDAsMSwiKS5jb25jYXQoY29ybmVyUmFkaXVzICogMiwgIiwwXG4gICAgICAgIGEiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLCIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsMCwwLDEsIikuY29uY2F0KC1jb3JuZXJSYWRpdXMgKiAyLCAiLDBcbiAgICAgICIpOwogICAgfQogICAgcmV0dXJuIGdldFNlY3RvclBhdGgoewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIGlubmVyUmFkaXVzLAogICAgICBvdXRlclJhZGl1cywKICAgICAgc3RhcnRBbmdsZSwKICAgICAgZW5kQW5nbGUKICAgIH0pOwogIH0KICB2YXIgcGF0aDIgPSAiTSAiLmNvbmNhdChzb2x0LngsICIsIikuY29uY2F0KHNvbHQueSwgIlxuICAgIEEiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLCIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsMCwwLCIpLmNvbmNhdCgrKHNpZ24yIDwgMCksICIsIikuY29uY2F0KHNvY3QueCwgIiwiKS5jb25jYXQoc29jdC55LCAiXG4gICAgQSIpLmNvbmNhdChvdXRlclJhZGl1cywgIiwiKS5jb25jYXQob3V0ZXJSYWRpdXMsICIsMCwiKS5jb25jYXQoKyhvdXRlckFyY0FuZ2xlID4gMTgwKSwgIiwiKS5jb25jYXQoKyhzaWduMiA8IDApLCAiLCIpLmNvbmNhdChlb2N0LngsICIsIikuY29uY2F0KGVvY3QueSwgIlxuICAgIEEiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLCIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsMCwwLCIpLmNvbmNhdCgrKHNpZ24yIDwgMCksICIsIikuY29uY2F0KGVvbHQueCwgIiwiKS5jb25jYXQoZW9sdC55LCAiXG4gICIpOwogIGlmIChpbm5lclJhZGl1cyA+IDApIHsKICAgIHZhciB7CiAgICAgIGNpcmNsZVRhbmdlbmN5OiBzaWN0LAogICAgICBsaW5lVGFuZ2VuY3k6IHNpbHQsCiAgICAgIHRoZXRhOiBzaXQKICAgIH0gPSBnZXRUYW5nZW50Q2lyY2xlKHsKICAgICAgY3gsCiAgICAgIGN5LAogICAgICByYWRpdXM6IGlubmVyUmFkaXVzLAogICAgICBhbmdsZTogc3RhcnRBbmdsZSwKICAgICAgc2lnbjogc2lnbjIsCiAgICAgIGlzRXh0ZXJuYWw6IHRydWUsCiAgICAgIGNvcm5lclJhZGl1cywKICAgICAgY29ybmVySXNFeHRlcm5hbAogICAgfSk7CiAgICB2YXIgewogICAgICBjaXJjbGVUYW5nZW5jeTogZWljdCwKICAgICAgbGluZVRhbmdlbmN5OiBlaWx0LAogICAgICB0aGV0YTogZWl0CiAgICB9ID0gZ2V0VGFuZ2VudENpcmNsZSh7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgcmFkaXVzOiBpbm5lclJhZGl1cywKICAgICAgYW5nbGU6IGVuZEFuZ2xlLAogICAgICBzaWduOiAtc2lnbjIsCiAgICAgIGlzRXh0ZXJuYWw6IHRydWUsCiAgICAgIGNvcm5lclJhZGl1cywKICAgICAgY29ybmVySXNFeHRlcm5hbAogICAgfSk7CiAgICB2YXIgaW5uZXJBcmNBbmdsZSA9IGNvcm5lcklzRXh0ZXJuYWwgPyBNYXRoLmFicyhzdGFydEFuZ2xlIC0gZW5kQW5nbGUpIDogTWF0aC5hYnMoc3RhcnRBbmdsZSAtIGVuZEFuZ2xlKSAtIHNpdCAtIGVpdDsKICAgIGlmIChpbm5lckFyY0FuZ2xlIDwgMCAmJiBjb3JuZXJSYWRpdXMgPT09IDApIHsKICAgICAgcmV0dXJuICIiLmNvbmNhdChwYXRoMiwgIkwiKS5jb25jYXQoY3gsICIsIikuY29uY2F0KGN5LCAiWiIpOwogICAgfQogICAgcGF0aDIgKz0gIkwiLmNvbmNhdChlaWx0LngsICIsIikuY29uY2F0KGVpbHQueSwgIlxuICAgICAgQSIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwwLDAsIikuY29uY2F0KCsoc2lnbjIgPCAwKSwgIiwiKS5jb25jYXQoZWljdC54LCAiLCIpLmNvbmNhdChlaWN0LnksICJcbiAgICAgIEEiKS5jb25jYXQoaW5uZXJSYWRpdXMsICIsIikuY29uY2F0KGlubmVyUmFkaXVzLCAiLDAsIikuY29uY2F0KCsoaW5uZXJBcmNBbmdsZSA+IDE4MCksICIsIikuY29uY2F0KCsoc2lnbjIgPiAwKSwgIiwiKS5jb25jYXQoc2ljdC54LCAiLCIpLmNvbmNhdChzaWN0LnksICJcbiAgICAgIEEiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLCIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsMCwwLCIpLmNvbmNhdCgrKHNpZ24yIDwgMCksICIsIikuY29uY2F0KHNpbHQueCwgIiwiKS5jb25jYXQoc2lsdC55LCAiWiIpOwogIH0gZWxzZSB7CiAgICBwYXRoMiArPSAiTCIuY29uY2F0KGN4LCAiLCIpLmNvbmNhdChjeSwgIloiKTsKICB9CiAgcmV0dXJuIHBhdGgyOwp9Owp2YXIgZGVmYXVsdFNlY3RvclByb3BzID0gewogIGN4OiAwLAogIGN5OiAwLAogIGlubmVyUmFkaXVzOiAwLAogIG91dGVyUmFkaXVzOiAwLAogIHN0YXJ0QW5nbGU6IDAsCiAgZW5kQW5nbGU6IDAsCiAgY29ybmVyUmFkaXVzOiAwLAogIGZvcmNlQ29ybmVyUmFkaXVzOiBmYWxzZSwKICBjb3JuZXJJc0V4dGVybmFsOiBmYWxzZQp9Owp2YXIgU2VjdG9yID0gKHNlY3RvclByb3BzKSA9PiB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhzZWN0b3JQcm9wcywgZGVmYXVsdFNlY3RvclByb3BzKTsKICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIGlubmVyUmFkaXVzLAogICAgb3V0ZXJSYWRpdXMsCiAgICBjb3JuZXJSYWRpdXMsCiAgICBmb3JjZUNvcm5lclJhZGl1cywKICAgIGNvcm5lcklzRXh0ZXJuYWwsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUsCiAgICBjbGFzc05hbWUKICB9ID0gcHJvcHM7CiAgaWYgKG91dGVyUmFkaXVzIDwgaW5uZXJSYWRpdXMgfHwgc3RhcnRBbmdsZSA9PT0gZW5kQW5nbGUpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgbGF5ZXJDbGFzcyA9IGNsc3goInJlY2hhcnRzLXNlY3RvciIsIGNsYXNzTmFtZSk7CiAgdmFyIGRlbHRhUmFkaXVzID0gb3V0ZXJSYWRpdXMgLSBpbm5lclJhZGl1czsKICB2YXIgY3IgPSBnZXRQZXJjZW50VmFsdWUoY29ybmVyUmFkaXVzLCBkZWx0YVJhZGl1cywgMCwgdHJ1ZSk7CiAgdmFyIHBhdGgyOwogIGlmIChjciA+IDAgJiYgTWF0aC5hYnMoc3RhcnRBbmdsZSAtIGVuZEFuZ2xlKSA8IDM2MCkgewogICAgcGF0aDIgPSBnZXRTZWN0b3JXaXRoQ29ybmVyKHsKICAgICAgY3gsCiAgICAgIGN5LAogICAgICBpbm5lclJhZGl1cywKICAgICAgb3V0ZXJSYWRpdXMsCiAgICAgIGNvcm5lclJhZGl1czogTWF0aC5taW4oY3IsIGRlbHRhUmFkaXVzIC8gMiksCiAgICAgIGZvcmNlQ29ybmVyUmFkaXVzLAogICAgICBjb3JuZXJJc0V4dGVybmFsLAogICAgICBzdGFydEFuZ2xlLAogICAgICBlbmRBbmdsZQogICAgfSk7CiAgfSBlbHNlIHsKICAgIHBhdGgyID0gZ2V0U2VjdG9yUGF0aCh7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgaW5uZXJSYWRpdXMsCiAgICAgIG91dGVyUmFkaXVzLAogICAgICBzdGFydEFuZ2xlLAogICAgICBlbmRBbmdsZQogICAgfSk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMC5jcmVhdGVFbGVtZW50KCJwYXRoIiwgX2V4dGVuZHM4KHt9LCBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzKSwgewogICAgY2xhc3NOYW1lOiBsYXllckNsYXNzLAogICAgZDogcGF0aDIKICB9KSk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvY3Vyc29yL2dldEN1cnNvclBvaW50cy5qcwpmdW5jdGlvbiBnZXRDdXJzb3JQb2ludHMobGF5b3V0LCBhY3RpdmVDb29yZGluYXRlLCBvZmZzZXQpIHsKICBpZiAobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIpIHsKICAgIHJldHVybiBbewogICAgICB4OiBhY3RpdmVDb29yZGluYXRlLngsCiAgICAgIHk6IG9mZnNldC50b3AKICAgIH0sIHsKICAgICAgeDogYWN0aXZlQ29vcmRpbmF0ZS54LAogICAgICB5OiBvZmZzZXQudG9wICsgb2Zmc2V0LmhlaWdodAogICAgfV07CiAgfQogIGlmIChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgIHJldHVybiBbewogICAgICB4OiBvZmZzZXQubGVmdCwKICAgICAgeTogYWN0aXZlQ29vcmRpbmF0ZS55CiAgICB9LCB7CiAgICAgIHg6IG9mZnNldC5sZWZ0ICsgb2Zmc2V0LndpZHRoLAogICAgICB5OiBhY3RpdmVDb29yZGluYXRlLnkKICAgIH1dOwogIH0KICBpZiAoaXNQb2xhckNvb3JkaW5hdGUoYWN0aXZlQ29vcmRpbmF0ZSkpIHsKICAgIGlmIChsYXlvdXQgPT09ICJjZW50cmljIikgewogICAgICB2YXIgewogICAgICAgIGN4LAogICAgICAgIGN5LAogICAgICAgIGlubmVyUmFkaXVzLAogICAgICAgIG91dGVyUmFkaXVzLAogICAgICAgIGFuZ2xlCiAgICAgIH0gPSBhY3RpdmVDb29yZGluYXRlOwogICAgICB2YXIgaW5uZXJQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBpbm5lclJhZGl1cywgYW5nbGUpOwogICAgICB2YXIgb3V0ZXJQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBvdXRlclJhZGl1cywgYW5nbGUpOwogICAgICByZXR1cm4gW3sKICAgICAgICB4OiBpbm5lclBvaW50LngsCiAgICAgICAgeTogaW5uZXJQb2ludC55CiAgICAgIH0sIHsKICAgICAgICB4OiBvdXRlclBvaW50LngsCiAgICAgICAgeTogb3V0ZXJQb2ludC55CiAgICAgIH1dOwogICAgfQogICAgcmV0dXJuIGdldFJhZGlhbEN1cnNvclBvaW50cyhhY3RpdmVDb29yZGluYXRlKTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvYXhpc1NlbGVjdG9ycy5qcwp2YXIgaW1wb3J0X3JhbmdlMiA9IF9fdG9FU00ocmVxdWlyZV9yYW5nZTIoKSk7CgovLyBub2RlX21vZHVsZXMvdmljdG9yeS12ZW5kb3IvZXMvZDMtc2NhbGUuanMKdmFyIGQzX3NjYWxlX2V4cG9ydHMgPSB7fTsKX19leHBvcnQoZDNfc2NhbGVfZXhwb3J0cywgewogIHNjYWxlQmFuZDogKCkgPT4gYmFuZCwKICBzY2FsZURpdmVyZ2luZzogKCkgPT4gZGl2ZXJnaW5nLAogIHNjYWxlRGl2ZXJnaW5nTG9nOiAoKSA9PiBkaXZlcmdpbmdMb2csCiAgc2NhbGVEaXZlcmdpbmdQb3c6ICgpID0+IGRpdmVyZ2luZ1BvdywKICBzY2FsZURpdmVyZ2luZ1NxcnQ6ICgpID0+IGRpdmVyZ2luZ1NxcnQsCiAgc2NhbGVEaXZlcmdpbmdTeW1sb2c6ICgpID0+IGRpdmVyZ2luZ1N5bWxvZywKICBzY2FsZUlkZW50aXR5OiAoKSA9PiBpZGVudGl0eTIsCiAgc2NhbGVJbXBsaWNpdDogKCkgPT4gaW1wbGljaXQsCiAgc2NhbGVMaW5lYXI6ICgpID0+IGxpbmVhcjIsCiAgc2NhbGVMb2c6ICgpID0+IGxvZywKICBzY2FsZU9yZGluYWw6ICgpID0+IG9yZGluYWwsCiAgc2NhbGVQb2ludDogKCkgPT4gcG9pbnQzLAogIHNjYWxlUG93OiAoKSA9PiBwb3csCiAgc2NhbGVRdWFudGlsZTogKCkgPT4gcXVhbnRpbGUyLAogIHNjYWxlUXVhbnRpemU6ICgpID0+IHF1YW50aXplLAogIHNjYWxlUmFkaWFsOiAoKSA9PiByYWRpYWwsCiAgc2NhbGVTZXF1ZW50aWFsOiAoKSA9PiBzZXF1ZW50aWFsLAogIHNjYWxlU2VxdWVudGlhbExvZzogKCkgPT4gc2VxdWVudGlhbExvZywKICBzY2FsZVNlcXVlbnRpYWxQb3c6ICgpID0+IHNlcXVlbnRpYWxQb3csCiAgc2NhbGVTZXF1ZW50aWFsUXVhbnRpbGU6ICgpID0+IHNlcXVlbnRpYWxRdWFudGlsZSwKICBzY2FsZVNlcXVlbnRpYWxTcXJ0OiAoKSA9PiBzZXF1ZW50aWFsU3FydCwKICBzY2FsZVNlcXVlbnRpYWxTeW1sb2c6ICgpID0+IHNlcXVlbnRpYWxTeW1sb2csCiAgc2NhbGVTcXJ0OiAoKSA9PiBzcXJ0LAogIHNjYWxlU3ltbG9nOiAoKSA9PiBzeW1sb2csCiAgc2NhbGVUaHJlc2hvbGQ6ICgpID0+IHRocmVzaG9sZCwKICBzY2FsZVRpbWU6ICgpID0+IHRpbWUsCiAgc2NhbGVVdGM6ICgpID0+IHV0Y1RpbWUsCiAgdGlja0Zvcm1hdDogKCkgPT4gdGlja0Zvcm1hdAp9KTsKCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvYXNjZW5kaW5nLmpzCmZ1bmN0aW9uIGFzY2VuZGluZyhhLCBiKSB7CiAgcmV0dXJuIGEgPT0gbnVsbCB8fCBiID09IG51bGwgPyBOYU4gOiBhIDwgYiA/IC0xIDogYSA+IGIgPyAxIDogYSA+PSBiID8gMCA6IE5hTjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9kZXNjZW5kaW5nLmpzCmZ1bmN0aW9uIGRlc2NlbmRpbmcoYSwgYikgewogIHJldHVybiBhID09IG51bGwgfHwgYiA9PSBudWxsID8gTmFOIDogYiA8IGEgPyAtMSA6IGIgPiBhID8gMSA6IGIgPj0gYSA/IDAgOiBOYU47Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvYmlzZWN0b3IuanMKZnVuY3Rpb24gYmlzZWN0b3IoZikgewogIGxldCBjb21wYXJlMSwgY29tcGFyZTIsIGRlbHRhOwogIGlmIChmLmxlbmd0aCAhPT0gMikgewogICAgY29tcGFyZTEgPSBhc2NlbmRpbmc7CiAgICBjb21wYXJlMiA9IChkLCB4MikgPT4gYXNjZW5kaW5nKGYoZCksIHgyKTsKICAgIGRlbHRhID0gKGQsIHgyKSA9PiBmKGQpIC0geDI7CiAgfSBlbHNlIHsKICAgIGNvbXBhcmUxID0gZiA9PT0gYXNjZW5kaW5nIHx8IGYgPT09IGRlc2NlbmRpbmcgPyBmIDogemVybzsKICAgIGNvbXBhcmUyID0gZjsKICAgIGRlbHRhID0gZjsKICB9CiAgZnVuY3Rpb24gbGVmdChhLCB4MiwgbG8gPSAwLCBoaSA9IGEubGVuZ3RoKSB7CiAgICBpZiAobG8gPCBoaSkgewogICAgICBpZiAoY29tcGFyZTEoeDIsIHgyKSAhPT0gMCkgcmV0dXJuIGhpOwogICAgICBkbyB7CiAgICAgICAgY29uc3QgbWlkID0gbG8gKyBoaSA+Pj4gMTsKICAgICAgICBpZiAoY29tcGFyZTIoYVttaWRdLCB4MikgPCAwKSBsbyA9IG1pZCArIDE7CiAgICAgICAgZWxzZSBoaSA9IG1pZDsKICAgICAgfSB3aGlsZSAobG8gPCBoaSk7CiAgICB9CiAgICByZXR1cm4gbG87CiAgfQogIGZ1bmN0aW9uIHJpZ2h0KGEsIHgyLCBsbyA9IDAsIGhpID0gYS5sZW5ndGgpIHsKICAgIGlmIChsbyA8IGhpKSB7CiAgICAgIGlmIChjb21wYXJlMSh4MiwgeDIpICE9PSAwKSByZXR1cm4gaGk7CiAgICAgIGRvIHsKICAgICAgICBjb25zdCBtaWQgPSBsbyArIGhpID4+PiAxOwogICAgICAgIGlmIChjb21wYXJlMihhW21pZF0sIHgyKSA8PSAwKSBsbyA9IG1pZCArIDE7CiAgICAgICAgZWxzZSBoaSA9IG1pZDsKICAgICAgfSB3aGlsZSAobG8gPCBoaSk7CiAgICB9CiAgICByZXR1cm4gbG87CiAgfQogIGZ1bmN0aW9uIGNlbnRlcihhLCB4MiwgbG8gPSAwLCBoaSA9IGEubGVuZ3RoKSB7CiAgICBjb25zdCBpID0gbGVmdChhLCB4MiwgbG8sIGhpIC0gMSk7CiAgICByZXR1cm4gaSA+IGxvICYmIGRlbHRhKGFbaSAtIDFdLCB4MikgPiAtZGVsdGEoYVtpXSwgeDIpID8gaSAtIDEgOiBpOwogIH0KICByZXR1cm4geyBsZWZ0LCBjZW50ZXIsIHJpZ2h0IH07Cn0KZnVuY3Rpb24gemVybygpIHsKICByZXR1cm4gMDsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9udW1iZXIuanMKZnVuY3Rpb24gbnVtYmVyKHgyKSB7CiAgcmV0dXJuIHgyID09PSBudWxsID8gTmFOIDogK3gyOwp9CmZ1bmN0aW9uKiBudW1iZXJzKHZhbHVlcywgdmFsdWVvZikgewogIGlmICh2YWx1ZW9mID09PSB2b2lkIDApIHsKICAgIGZvciAobGV0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAodmFsdWUgIT0gbnVsbCAmJiAodmFsdWUgPSArdmFsdWUpID49IHZhbHVlKSB7CiAgICAgICAgeWllbGQgdmFsdWU7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgbGV0IGluZGV4ID0gLTE7CiAgICBmb3IgKGxldCB2YWx1ZSBvZiB2YWx1ZXMpIHsKICAgICAgaWYgKCh2YWx1ZSA9IHZhbHVlb2YodmFsdWUsICsraW5kZXgsIHZhbHVlcykpICE9IG51bGwgJiYgKHZhbHVlID0gK3ZhbHVlKSA+PSB2YWx1ZSkgewogICAgICAgIHlpZWxkIHZhbHVlOwogICAgICB9CiAgICB9CiAgfQp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL2Jpc2VjdC5qcwp2YXIgYXNjZW5kaW5nQmlzZWN0ID0gYmlzZWN0b3IoYXNjZW5kaW5nKTsKdmFyIGJpc2VjdFJpZ2h0ID0gYXNjZW5kaW5nQmlzZWN0LnJpZ2h0Owp2YXIgYmlzZWN0TGVmdCA9IGFzY2VuZGluZ0Jpc2VjdC5sZWZ0Owp2YXIgYmlzZWN0Q2VudGVyID0gYmlzZWN0b3IobnVtYmVyKS5jZW50ZXI7CnZhciBiaXNlY3RfZGVmYXVsdCA9IGJpc2VjdFJpZ2h0OwoKLy8gbm9kZV9tb2R1bGVzL2ludGVybm1hcC9zcmMvaW5kZXguanMKdmFyIEludGVybk1hcCA9IGNsYXNzIGV4dGVuZHMgTWFwIHsKICBjb25zdHJ1Y3RvcihlbnRyaWVzLCBrZXkgPSBrZXlvZikgewogICAgc3VwZXIoKTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKHRoaXMsIHsgX2ludGVybjogeyB2YWx1ZTogLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSB9LCBfa2V5OiB7IHZhbHVlOiBrZXkgfSB9KTsKICAgIGlmIChlbnRyaWVzICE9IG51bGwpIGZvciAoY29uc3QgW2tleTIsIHZhbHVlXSBvZiBlbnRyaWVzKSB0aGlzLnNldChrZXkyLCB2YWx1ZSk7CiAgfQogIGdldChrZXkpIHsKICAgIHJldHVybiBzdXBlci5nZXQoaW50ZXJuX2dldCh0aGlzLCBrZXkpKTsKICB9CiAgaGFzKGtleSkgewogICAgcmV0dXJuIHN1cGVyLmhhcyhpbnRlcm5fZ2V0KHRoaXMsIGtleSkpOwogIH0KICBzZXQoa2V5LCB2YWx1ZSkgewogICAgcmV0dXJuIHN1cGVyLnNldChpbnRlcm5fc2V0KHRoaXMsIGtleSksIHZhbHVlKTsKICB9CiAgZGVsZXRlKGtleSkgewogICAgcmV0dXJuIHN1cGVyLmRlbGV0ZShpbnRlcm5fZGVsZXRlKHRoaXMsIGtleSkpOwogIH0KfTsKZnVuY3Rpb24gaW50ZXJuX2dldCh7IF9pbnRlcm4sIF9rZXkgfSwgdmFsdWUpIHsKICBjb25zdCBrZXkgPSBfa2V5KHZhbHVlKTsKICByZXR1cm4gX2ludGVybi5oYXMoa2V5KSA/IF9pbnRlcm4uZ2V0KGtleSkgOiB2YWx1ZTsKfQpmdW5jdGlvbiBpbnRlcm5fc2V0KHsgX2ludGVybiwgX2tleSB9LCB2YWx1ZSkgewogIGNvbnN0IGtleSA9IF9rZXkodmFsdWUpOwogIGlmIChfaW50ZXJuLmhhcyhrZXkpKSByZXR1cm4gX2ludGVybi5nZXQoa2V5KTsKICBfaW50ZXJuLnNldChrZXksIHZhbHVlKTsKICByZXR1cm4gdmFsdWU7Cn0KZnVuY3Rpb24gaW50ZXJuX2RlbGV0ZSh7IF9pbnRlcm4sIF9rZXkgfSwgdmFsdWUpIHsKICBjb25zdCBrZXkgPSBfa2V5KHZhbHVlKTsKICBpZiAoX2ludGVybi5oYXMoa2V5KSkgewogICAgdmFsdWUgPSBfaW50ZXJuLmdldChrZXkpOwogICAgX2ludGVybi5kZWxldGUoa2V5KTsKICB9CiAgcmV0dXJuIHZhbHVlOwp9CmZ1bmN0aW9uIGtleW9mKHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgPyB2YWx1ZS52YWx1ZU9mKCkgOiB2YWx1ZTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9zb3J0LmpzCmZ1bmN0aW9uIGNvbXBhcmVEZWZpbmVkKGNvbXBhcmUgPSBhc2NlbmRpbmcpIHsKICBpZiAoY29tcGFyZSA9PT0gYXNjZW5kaW5nKSByZXR1cm4gYXNjZW5kaW5nRGVmaW5lZDsKICBpZiAodHlwZW9mIGNvbXBhcmUgIT09ICJmdW5jdGlvbiIpIHRocm93IG5ldyBUeXBlRXJyb3IoImNvbXBhcmUgaXMgbm90IGEgZnVuY3Rpb24iKTsKICByZXR1cm4gKGEsIGIpID0+IHsKICAgIGNvbnN0IHgyID0gY29tcGFyZShhLCBiKTsKICAgIGlmICh4MiB8fCB4MiA9PT0gMCkgcmV0dXJuIHgyOwogICAgcmV0dXJuIChjb21wYXJlKGIsIGIpID09PSAwKSAtIChjb21wYXJlKGEsIGEpID09PSAwKTsKICB9Owp9CmZ1bmN0aW9uIGFzY2VuZGluZ0RlZmluZWQoYSwgYikgewogIHJldHVybiAoYSA9PSBudWxsIHx8ICEoYSA+PSBhKSkgLSAoYiA9PSBudWxsIHx8ICEoYiA+PSBiKSkgfHwgKGEgPCBiID8gLTEgOiBhID4gYiA/IDEgOiAwKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy90aWNrcy5qcwp2YXIgZTEwID0gTWF0aC5zcXJ0KDUwKTsKdmFyIGU1ID0gTWF0aC5zcXJ0KDEwKTsKdmFyIGUyID0gTWF0aC5zcXJ0KDIpOwpmdW5jdGlvbiB0aWNrU3BlYyhzdGFydCwgc3RvcCwgY291bnQpIHsKICBjb25zdCBzdGVwID0gKHN0b3AgLSBzdGFydCkgLyBNYXRoLm1heCgwLCBjb3VudCksIHBvd2VyID0gTWF0aC5mbG9vcihNYXRoLmxvZzEwKHN0ZXApKSwgZXJyb3IgPSBzdGVwIC8gTWF0aC5wb3coMTAsIHBvd2VyKSwgZmFjdG9yID0gZXJyb3IgPj0gZTEwID8gMTAgOiBlcnJvciA+PSBlNSA/IDUgOiBlcnJvciA+PSBlMiA/IDIgOiAxOwogIGxldCBpMSwgaTIsIGluYzsKICBpZiAocG93ZXIgPCAwKSB7CiAgICBpbmMgPSBNYXRoLnBvdygxMCwgLXBvd2VyKSAvIGZhY3RvcjsKICAgIGkxID0gTWF0aC5yb3VuZChzdGFydCAqIGluYyk7CiAgICBpMiA9IE1hdGgucm91bmQoc3RvcCAqIGluYyk7CiAgICBpZiAoaTEgLyBpbmMgPCBzdGFydCkgKytpMTsKICAgIGlmIChpMiAvIGluYyA+IHN0b3ApIC0taTI7CiAgICBpbmMgPSAtaW5jOwogIH0gZWxzZSB7CiAgICBpbmMgPSBNYXRoLnBvdygxMCwgcG93ZXIpICogZmFjdG9yOwogICAgaTEgPSBNYXRoLnJvdW5kKHN0YXJ0IC8gaW5jKTsKICAgIGkyID0gTWF0aC5yb3VuZChzdG9wIC8gaW5jKTsKICAgIGlmIChpMSAqIGluYyA8IHN0YXJ0KSArK2kxOwogICAgaWYgKGkyICogaW5jID4gc3RvcCkgLS1pMjsKICB9CiAgaWYgKGkyIDwgaTEgJiYgMC41IDw9IGNvdW50ICYmIGNvdW50IDwgMikgcmV0dXJuIHRpY2tTcGVjKHN0YXJ0LCBzdG9wLCBjb3VudCAqIDIpOwogIHJldHVybiBbaTEsIGkyLCBpbmNdOwp9CmZ1bmN0aW9uIHRpY2tzKHN0YXJ0LCBzdG9wLCBjb3VudCkgewogIHN0b3AgPSArc3RvcCwgc3RhcnQgPSArc3RhcnQsIGNvdW50ID0gK2NvdW50OwogIGlmICghKGNvdW50ID4gMCkpIHJldHVybiBbXTsKICBpZiAoc3RhcnQgPT09IHN0b3ApIHJldHVybiBbc3RhcnRdOwogIGNvbnN0IHJldmVyc2UyID0gc3RvcCA8IHN0YXJ0LCBbaTEsIGkyLCBpbmNdID0gcmV2ZXJzZTIgPyB0aWNrU3BlYyhzdG9wLCBzdGFydCwgY291bnQpIDogdGlja1NwZWMoc3RhcnQsIHN0b3AsIGNvdW50KTsKICBpZiAoIShpMiA+PSBpMSkpIHJldHVybiBbXTsKICBjb25zdCBuID0gaTIgLSBpMSArIDEsIHRpY2tzMiA9IG5ldyBBcnJheShuKTsKICBpZiAocmV2ZXJzZTIpIHsKICAgIGlmIChpbmMgPCAwKSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkyIC0gaSkgLyAtaW5jOwogICAgZWxzZSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkyIC0gaSkgKiBpbmM7CiAgfSBlbHNlIHsKICAgIGlmIChpbmMgPCAwKSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkxICsgaSkgLyAtaW5jOwogICAgZWxzZSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkxICsgaSkgKiBpbmM7CiAgfQogIHJldHVybiB0aWNrczI7Cn0KZnVuY3Rpb24gdGlja0luY3JlbWVudChzdGFydCwgc3RvcCwgY291bnQpIHsKICBzdG9wID0gK3N0b3AsIHN0YXJ0ID0gK3N0YXJ0LCBjb3VudCA9ICtjb3VudDsKICByZXR1cm4gdGlja1NwZWMoc3RhcnQsIHN0b3AsIGNvdW50KVsyXTsKfQpmdW5jdGlvbiB0aWNrU3RlcChzdGFydCwgc3RvcCwgY291bnQpIHsKICBzdG9wID0gK3N0b3AsIHN0YXJ0ID0gK3N0YXJ0LCBjb3VudCA9ICtjb3VudDsKICBjb25zdCByZXZlcnNlMiA9IHN0b3AgPCBzdGFydCwgaW5jID0gcmV2ZXJzZTIgPyB0aWNrSW5jcmVtZW50KHN0b3AsIHN0YXJ0LCBjb3VudCkgOiB0aWNrSW5jcmVtZW50KHN0YXJ0LCBzdG9wLCBjb3VudCk7CiAgcmV0dXJuIChyZXZlcnNlMiA/IC0xIDogMSkgKiAoaW5jIDwgMCA/IDEgLyAtaW5jIDogaW5jKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9tYXguanMKZnVuY3Rpb24gbWF4KHZhbHVlcywgdmFsdWVvZikgewogIGxldCBtYXgyOwogIGlmICh2YWx1ZW9mID09PSB2b2lkIDApIHsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIGlmICh2YWx1ZSAhPSBudWxsICYmIChtYXgyIDwgdmFsdWUgfHwgbWF4MiA9PT0gdm9pZCAwICYmIHZhbHVlID49IHZhbHVlKSkgewogICAgICAgIG1heDIgPSB2YWx1ZTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBsZXQgaW5kZXggPSAtMTsKICAgIGZvciAobGV0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAoKHZhbHVlID0gdmFsdWVvZih2YWx1ZSwgKytpbmRleCwgdmFsdWVzKSkgIT0gbnVsbCAmJiAobWF4MiA8IHZhbHVlIHx8IG1heDIgPT09IHZvaWQgMCAmJiB2YWx1ZSA+PSB2YWx1ZSkpIHsKICAgICAgICBtYXgyID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIG1heDI7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvbWluLmpzCmZ1bmN0aW9uIG1pbih2YWx1ZXMsIHZhbHVlb2YpIHsKICBsZXQgbWluMjsKICBpZiAodmFsdWVvZiA9PT0gdm9pZCAwKSB7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAodmFsdWUgIT0gbnVsbCAmJiAobWluMiA+IHZhbHVlIHx8IG1pbjIgPT09IHZvaWQgMCAmJiB2YWx1ZSA+PSB2YWx1ZSkpIHsKICAgICAgICBtaW4yID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgbGV0IGluZGV4ID0gLTE7CiAgICBmb3IgKGxldCB2YWx1ZSBvZiB2YWx1ZXMpIHsKICAgICAgaWYgKCh2YWx1ZSA9IHZhbHVlb2YodmFsdWUsICsraW5kZXgsIHZhbHVlcykpICE9IG51bGwgJiYgKG1pbjIgPiB2YWx1ZSB8fCBtaW4yID09PSB2b2lkIDAgJiYgdmFsdWUgPj0gdmFsdWUpKSB7CiAgICAgICAgbWluMiA9IHZhbHVlOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBtaW4yOwp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL3F1aWNrc2VsZWN0LmpzCmZ1bmN0aW9uIHF1aWNrc2VsZWN0KGFycmF5LCBrLCBsZWZ0ID0gMCwgcmlnaHQgPSBJbmZpbml0eSwgY29tcGFyZSkgewogIGsgPSBNYXRoLmZsb29yKGspOwogIGxlZnQgPSBNYXRoLmZsb29yKE1hdGgubWF4KDAsIGxlZnQpKTsKICByaWdodCA9IE1hdGguZmxvb3IoTWF0aC5taW4oYXJyYXkubGVuZ3RoIC0gMSwgcmlnaHQpKTsKICBpZiAoIShsZWZ0IDw9IGsgJiYgayA8PSByaWdodCkpIHJldHVybiBhcnJheTsKICBjb21wYXJlID0gY29tcGFyZSA9PT0gdm9pZCAwID8gYXNjZW5kaW5nRGVmaW5lZCA6IGNvbXBhcmVEZWZpbmVkKGNvbXBhcmUpOwogIHdoaWxlIChyaWdodCA+IGxlZnQpIHsKICAgIGlmIChyaWdodCAtIGxlZnQgPiA2MDApIHsKICAgICAgY29uc3QgbiA9IHJpZ2h0IC0gbGVmdCArIDE7CiAgICAgIGNvbnN0IG0gPSBrIC0gbGVmdCArIDE7CiAgICAgIGNvbnN0IHogPSBNYXRoLmxvZyhuKTsKICAgICAgY29uc3QgcyA9IDAuNSAqIE1hdGguZXhwKDIgKiB6IC8gMyk7CiAgICAgIGNvbnN0IHNkID0gMC41ICogTWF0aC5zcXJ0KHogKiBzICogKG4gLSBzKSAvIG4pICogKG0gLSBuIC8gMiA8IDAgPyAtMSA6IDEpOwogICAgICBjb25zdCBuZXdMZWZ0ID0gTWF0aC5tYXgobGVmdCwgTWF0aC5mbG9vcihrIC0gbSAqIHMgLyBuICsgc2QpKTsKICAgICAgY29uc3QgbmV3UmlnaHQgPSBNYXRoLm1pbihyaWdodCwgTWF0aC5mbG9vcihrICsgKG4gLSBtKSAqIHMgLyBuICsgc2QpKTsKICAgICAgcXVpY2tzZWxlY3QoYXJyYXksIGssIG5ld0xlZnQsIG5ld1JpZ2h0LCBjb21wYXJlKTsKICAgIH0KICAgIGNvbnN0IHQgPSBhcnJheVtrXTsKICAgIGxldCBpID0gbGVmdDsKICAgIGxldCBqID0gcmlnaHQ7CiAgICBzd2FwKGFycmF5LCBsZWZ0LCBrKTsKICAgIGlmIChjb21wYXJlKGFycmF5W3JpZ2h0XSwgdCkgPiAwKSBzd2FwKGFycmF5LCBsZWZ0LCByaWdodCk7CiAgICB3aGlsZSAoaSA8IGopIHsKICAgICAgc3dhcChhcnJheSwgaSwgaiksICsraSwgLS1qOwogICAgICB3aGlsZSAoY29tcGFyZShhcnJheVtpXSwgdCkgPCAwKSArK2k7CiAgICAgIHdoaWxlIChjb21wYXJlKGFycmF5W2pdLCB0KSA+IDApIC0tajsKICAgIH0KICAgIGlmIChjb21wYXJlKGFycmF5W2xlZnRdLCB0KSA9PT0gMCkgc3dhcChhcnJheSwgbGVmdCwgaik7CiAgICBlbHNlICsraiwgc3dhcChhcnJheSwgaiwgcmlnaHQpOwogICAgaWYgKGogPD0gaykgbGVmdCA9IGogKyAxOwogICAgaWYgKGsgPD0gaikgcmlnaHQgPSBqIC0gMTsKICB9CiAgcmV0dXJuIGFycmF5Owp9CmZ1bmN0aW9uIHN3YXAoYXJyYXksIGksIGopIHsKICBjb25zdCB0ID0gYXJyYXlbaV07CiAgYXJyYXlbaV0gPSBhcnJheVtqXTsKICBhcnJheVtqXSA9IHQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvcXVhbnRpbGUuanMKZnVuY3Rpb24gcXVhbnRpbGUodmFsdWVzLCBwLCB2YWx1ZW9mKSB7CiAgdmFsdWVzID0gRmxvYXQ2NEFycmF5LmZyb20obnVtYmVycyh2YWx1ZXMsIHZhbHVlb2YpKTsKICBpZiAoIShuID0gdmFsdWVzLmxlbmd0aCkgfHwgaXNOYU4ocCA9ICtwKSkgcmV0dXJuOwogIGlmIChwIDw9IDAgfHwgbiA8IDIpIHJldHVybiBtaW4odmFsdWVzKTsKICBpZiAocCA+PSAxKSByZXR1cm4gbWF4KHZhbHVlcyk7CiAgdmFyIG4sIGkgPSAobiAtIDEpICogcCwgaTAgPSBNYXRoLmZsb29yKGkpLCB2YWx1ZTAgPSBtYXgocXVpY2tzZWxlY3QodmFsdWVzLCBpMCkuc3ViYXJyYXkoMCwgaTAgKyAxKSksIHZhbHVlMSA9IG1pbih2YWx1ZXMuc3ViYXJyYXkoaTAgKyAxKSk7CiAgcmV0dXJuIHZhbHVlMCArICh2YWx1ZTEgLSB2YWx1ZTApICogKGkgLSBpMCk7Cn0KZnVuY3Rpb24gcXVhbnRpbGVTb3J0ZWQodmFsdWVzLCBwLCB2YWx1ZW9mID0gbnVtYmVyKSB7CiAgaWYgKCEobiA9IHZhbHVlcy5sZW5ndGgpIHx8IGlzTmFOKHAgPSArcCkpIHJldHVybjsKICBpZiAocCA8PSAwIHx8IG4gPCAyKSByZXR1cm4gK3ZhbHVlb2YodmFsdWVzWzBdLCAwLCB2YWx1ZXMpOwogIGlmIChwID49IDEpIHJldHVybiArdmFsdWVvZih2YWx1ZXNbbiAtIDFdLCBuIC0gMSwgdmFsdWVzKTsKICB2YXIgbiwgaSA9IChuIC0gMSkgKiBwLCBpMCA9IE1hdGguZmxvb3IoaSksIHZhbHVlMCA9ICt2YWx1ZW9mKHZhbHVlc1tpMF0sIGkwLCB2YWx1ZXMpLCB2YWx1ZTEgPSArdmFsdWVvZih2YWx1ZXNbaTAgKyAxXSwgaTAgKyAxLCB2YWx1ZXMpOwogIHJldHVybiB2YWx1ZTAgKyAodmFsdWUxIC0gdmFsdWUwKSAqIChpIC0gaTApOwp9CgovLyBub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL3JhbmdlLmpzCmZ1bmN0aW9uIHJhbmdlKHN0YXJ0LCBzdG9wLCBzdGVwKSB7CiAgc3RhcnQgPSArc3RhcnQsIHN0b3AgPSArc3RvcCwgc3RlcCA9IChuID0gYXJndW1lbnRzLmxlbmd0aCkgPCAyID8gKHN0b3AgPSBzdGFydCwgc3RhcnQgPSAwLCAxKSA6IG4gPCAzID8gMSA6ICtzdGVwOwogIHZhciBpID0gLTEsIG4gPSBNYXRoLm1heCgwLCBNYXRoLmNlaWwoKHN0b3AgLSBzdGFydCkgLyBzdGVwKSkgfCAwLCByYW5nZTQgPSBuZXcgQXJyYXkobik7CiAgd2hpbGUgKCsraSA8IG4pIHsKICAgIHJhbmdlNFtpXSA9IHN0YXJ0ICsgaSAqIHN0ZXA7CiAgfQogIHJldHVybiByYW5nZTQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvaW5pdC5qcwpmdW5jdGlvbiBpbml0UmFuZ2UoZG9tYWluLCByYW5nZTQpIHsKICBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgIGNhc2UgMDoKICAgICAgYnJlYWs7CiAgICBjYXNlIDE6CiAgICAgIHRoaXMucmFuZ2UoZG9tYWluKTsKICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICB0aGlzLnJhbmdlKHJhbmdlNCkuZG9tYWluKGRvbWFpbik7CiAgICAgIGJyZWFrOwogIH0KICByZXR1cm4gdGhpczsKfQpmdW5jdGlvbiBpbml0SW50ZXJwb2xhdG9yKGRvbWFpbiwgaW50ZXJwb2xhdG9yKSB7CiAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICBjYXNlIDA6CiAgICAgIGJyZWFrOwogICAgY2FzZSAxOiB7CiAgICAgIGlmICh0eXBlb2YgZG9tYWluID09PSAiZnVuY3Rpb24iKSB0aGlzLmludGVycG9sYXRvcihkb21haW4pOwogICAgICBlbHNlIHRoaXMucmFuZ2UoZG9tYWluKTsKICAgICAgYnJlYWs7CiAgICB9CiAgICBkZWZhdWx0OiB7CiAgICAgIHRoaXMuZG9tYWluKGRvbWFpbik7CiAgICAgIGlmICh0eXBlb2YgaW50ZXJwb2xhdG9yID09PSAiZnVuY3Rpb24iKSB0aGlzLmludGVycG9sYXRvcihpbnRlcnBvbGF0b3IpOwogICAgICBlbHNlIHRoaXMucmFuZ2UoaW50ZXJwb2xhdG9yKTsKICAgICAgYnJlYWs7CiAgICB9CiAgfQogIHJldHVybiB0aGlzOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL29yZGluYWwuanMKdmFyIGltcGxpY2l0ID0gU3ltYm9sKCJpbXBsaWNpdCIpOwpmdW5jdGlvbiBvcmRpbmFsKCkgewogIHZhciBpbmRleCA9IG5ldyBJbnRlcm5NYXAoKSwgZG9tYWluID0gW10sIHJhbmdlNCA9IFtdLCB1bmtub3duID0gaW1wbGljaXQ7CiAgZnVuY3Rpb24gc2NhbGUoZCkgewogICAgbGV0IGkgPSBpbmRleC5nZXQoZCk7CiAgICBpZiAoaSA9PT0gdm9pZCAwKSB7CiAgICAgIGlmICh1bmtub3duICE9PSBpbXBsaWNpdCkgcmV0dXJuIHVua25vd247CiAgICAgIGluZGV4LnNldChkLCBpID0gZG9tYWluLnB1c2goZCkgLSAxKTsKICAgIH0KICAgIHJldHVybiByYW5nZTRbaSAlIHJhbmdlNC5sZW5ndGhdOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBkb21haW4uc2xpY2UoKTsKICAgIGRvbWFpbiA9IFtdLCBpbmRleCA9IG5ldyBJbnRlcm5NYXAoKTsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgXykgewogICAgICBpZiAoaW5kZXguaGFzKHZhbHVlKSkgY29udGludWU7CiAgICAgIGluZGV4LnNldCh2YWx1ZSwgZG9tYWluLnB1c2godmFsdWUpIC0gMSk7CiAgICB9CiAgICByZXR1cm4gc2NhbGU7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJhbmdlNCA9IEFycmF5LmZyb20oXyksIHNjYWxlKSA6IHJhbmdlNC5zbGljZSgpOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIG9yZGluYWwoZG9tYWluLCByYW5nZTQpLnVua25vd24odW5rbm93bik7CiAgfTsKICBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7CiAgcmV0dXJuIHNjYWxlOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2JhbmQuanMKZnVuY3Rpb24gYmFuZCgpIHsKICB2YXIgc2NhbGUgPSBvcmRpbmFsKCkudW5rbm93bih2b2lkIDApLCBkb21haW4gPSBzY2FsZS5kb21haW4sIG9yZGluYWxSYW5nZSA9IHNjYWxlLnJhbmdlLCByMCA9IDAsIHIxID0gMSwgc3RlcCwgYmFuZHdpZHRoLCByb3VuZCA9IGZhbHNlLCBwYWRkaW5nSW5uZXIgPSAwLCBwYWRkaW5nT3V0ZXIgPSAwLCBhbGlnbiA9IDAuNTsKICBkZWxldGUgc2NhbGUudW5rbm93bjsKICBmdW5jdGlvbiByZXNjYWxlKCkgewogICAgdmFyIG4gPSBkb21haW4oKS5sZW5ndGgsIHJldmVyc2UyID0gcjEgPCByMCwgc3RhcnQgPSByZXZlcnNlMiA/IHIxIDogcjAsIHN0b3AgPSByZXZlcnNlMiA/IHIwIDogcjE7CiAgICBzdGVwID0gKHN0b3AgLSBzdGFydCkgLyBNYXRoLm1heCgxLCBuIC0gcGFkZGluZ0lubmVyICsgcGFkZGluZ091dGVyICogMik7CiAgICBpZiAocm91bmQpIHN0ZXAgPSBNYXRoLmZsb29yKHN0ZXApOwogICAgc3RhcnQgKz0gKHN0b3AgLSBzdGFydCAtIHN0ZXAgKiAobiAtIHBhZGRpbmdJbm5lcikpICogYWxpZ247CiAgICBiYW5kd2lkdGggPSBzdGVwICogKDEgLSBwYWRkaW5nSW5uZXIpOwogICAgaWYgKHJvdW5kKSBzdGFydCA9IE1hdGgucm91bmQoc3RhcnQpLCBiYW5kd2lkdGggPSBNYXRoLnJvdW5kKGJhbmR3aWR0aCk7CiAgICB2YXIgdmFsdWVzID0gcmFuZ2UobikubWFwKGZ1bmN0aW9uKGkpIHsKICAgICAgcmV0dXJuIHN0YXJ0ICsgc3RlcCAqIGk7CiAgICB9KTsKICAgIHJldHVybiBvcmRpbmFsUmFuZ2UocmV2ZXJzZTIgPyB2YWx1ZXMucmV2ZXJzZSgpIDogdmFsdWVzKTsKICB9CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZG9tYWluKF8pLCByZXNjYWxlKCkpIDogZG9tYWluKCk7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKFtyMCwgcjFdID0gXywgcjAgPSArcjAsIHIxID0gK3IxLCByZXNjYWxlKCkpIDogW3IwLCByMV07CiAgfTsKICBzY2FsZS5yYW5nZVJvdW5kID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIFtyMCwgcjFdID0gXywgcjAgPSArcjAsIHIxID0gK3IxLCByb3VuZCA9IHRydWUsIHJlc2NhbGUoKTsKICB9OwogIHNjYWxlLmJhbmR3aWR0aCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGJhbmR3aWR0aDsKICB9OwogIHNjYWxlLnN0ZXAgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBzdGVwOwogIH07CiAgc2NhbGUucm91bmQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyb3VuZCA9ICEhXywgcmVzY2FsZSgpKSA6IHJvdW5kOwogIH07CiAgc2NhbGUucGFkZGluZyA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHBhZGRpbmdJbm5lciA9IE1hdGgubWluKDEsIHBhZGRpbmdPdXRlciA9ICtfKSwgcmVzY2FsZSgpKSA6IHBhZGRpbmdJbm5lcjsKICB9OwogIHNjYWxlLnBhZGRpbmdJbm5lciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHBhZGRpbmdJbm5lciA9IE1hdGgubWluKDEsIF8pLCByZXNjYWxlKCkpIDogcGFkZGluZ0lubmVyOwogIH07CiAgc2NhbGUucGFkZGluZ091dGVyID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocGFkZGluZ091dGVyID0gK18sIHJlc2NhbGUoKSkgOiBwYWRkaW5nT3V0ZXI7CiAgfTsKICBzY2FsZS5hbGlnbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGFsaWduID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgXykpLCByZXNjYWxlKCkpIDogYWxpZ247CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gYmFuZChkb21haW4oKSwgW3IwLCByMV0pLnJvdW5kKHJvdW5kKS5wYWRkaW5nSW5uZXIocGFkZGluZ0lubmVyKS5wYWRkaW5nT3V0ZXIocGFkZGluZ091dGVyKS5hbGlnbihhbGlnbik7CiAgfTsKICByZXR1cm4gaW5pdFJhbmdlLmFwcGx5KHJlc2NhbGUoKSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBwb2ludGlzaChzY2FsZSkgewogIHZhciBjb3B5MyA9IHNjYWxlLmNvcHk7CiAgc2NhbGUucGFkZGluZyA9IHNjYWxlLnBhZGRpbmdPdXRlcjsKICBkZWxldGUgc2NhbGUucGFkZGluZ0lubmVyOwogIGRlbGV0ZSBzY2FsZS5wYWRkaW5nT3V0ZXI7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHBvaW50aXNoKGNvcHkzKCkpOwogIH07CiAgcmV0dXJuIHNjYWxlOwp9CmZ1bmN0aW9uIHBvaW50MygpIHsKICByZXR1cm4gcG9pbnRpc2goYmFuZC5hcHBseShudWxsLCBhcmd1bWVudHMpLnBhZGRpbmdJbm5lcigxKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1jb2xvci9zcmMvZGVmaW5lLmpzCmZ1bmN0aW9uIGRlZmluZV9kZWZhdWx0KGNvbnN0cnVjdG9yLCBmYWN0b3J5LCBwcm90b3R5cGUpIHsKICBjb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSBmYWN0b3J5LnByb3RvdHlwZSA9IHByb3RvdHlwZTsKICBwcm90b3R5cGUuY29uc3RydWN0b3IgPSBjb25zdHJ1Y3RvcjsKfQpmdW5jdGlvbiBleHRlbmQocGFyZW50LCBkZWZpbml0aW9uKSB7CiAgdmFyIHByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUocGFyZW50LnByb3RvdHlwZSk7CiAgZm9yICh2YXIga2V5IGluIGRlZmluaXRpb24pIHByb3RvdHlwZVtrZXldID0gZGVmaW5pdGlvbltrZXldOwogIHJldHVybiBwcm90b3R5cGU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1jb2xvci9zcmMvY29sb3IuanMKZnVuY3Rpb24gQ29sb3IoKSB7Cn0KdmFyIGRhcmtlciA9IDAuNzsKdmFyIGJyaWdodGVyID0gMSAvIGRhcmtlcjsKdmFyIHJlSSA9ICJcXHMqKFsrLV0/XFxkKylcXHMqIjsKdmFyIHJlTiA9ICJcXHMqKFsrLV0/KD86XFxkKlxcLik/XFxkKyg/OltlRV1bKy1dP1xcZCspPylcXHMqIjsKdmFyIHJlUCA9ICJcXHMqKFsrLV0/KD86XFxkKlxcLik/XFxkKyg/OltlRV1bKy1dP1xcZCspPyklXFxzKiI7CnZhciByZUhleCA9IC9eIyhbMC05YS1mXXszLDh9KSQvOwp2YXIgcmVSZ2JJbnRlZ2VyID0gbmV3IFJlZ0V4cChgXnJnYlxcKCR7cmVJfSwke3JlSX0sJHtyZUl9XFwpJGApOwp2YXIgcmVSZ2JQZXJjZW50ID0gbmV3IFJlZ0V4cChgXnJnYlxcKCR7cmVQfSwke3JlUH0sJHtyZVB9XFwpJGApOwp2YXIgcmVSZ2JhSW50ZWdlciA9IG5ldyBSZWdFeHAoYF5yZ2JhXFwoJHtyZUl9LCR7cmVJfSwke3JlSX0sJHtyZU59XFwpJGApOwp2YXIgcmVSZ2JhUGVyY2VudCA9IG5ldyBSZWdFeHAoYF5yZ2JhXFwoJHtyZVB9LCR7cmVQfSwke3JlUH0sJHtyZU59XFwpJGApOwp2YXIgcmVIc2xQZXJjZW50ID0gbmV3IFJlZ0V4cChgXmhzbFxcKCR7cmVOfSwke3JlUH0sJHtyZVB9XFwpJGApOwp2YXIgcmVIc2xhUGVyY2VudCA9IG5ldyBSZWdFeHAoYF5oc2xhXFwoJHtyZU59LCR7cmVQfSwke3JlUH0sJHtyZU59XFwpJGApOwp2YXIgbmFtZWQgPSB7CiAgYWxpY2VibHVlOiAxNTc5MjM4MywKICBhbnRpcXVld2hpdGU6IDE2NDQ0Mzc1LAogIGFxdWE6IDY1NTM1LAogIGFxdWFtYXJpbmU6IDgzODg1NjQsCiAgYXp1cmU6IDE1Nzk0MTc1LAogIGJlaWdlOiAxNjExOTI2MCwKICBiaXNxdWU6IDE2NzcwMjQ0LAogIGJsYWNrOiAwLAogIGJsYW5jaGVkYWxtb25kOiAxNjc3MjA0NSwKICBibHVlOiAyNTUsCiAgYmx1ZXZpb2xldDogOTA1NTIwMiwKICBicm93bjogMTA4MjQyMzQsCiAgYnVybHl3b29kOiAxNDU5NjIzMSwKICBjYWRldGJsdWU6IDYyNjY1MjgsCiAgY2hhcnRyZXVzZTogODM4ODM1MiwKICBjaG9jb2xhdGU6IDEzNzg5NDcwLAogIGNvcmFsOiAxNjc0NDI3MiwKICBjb3JuZmxvd2VyYmx1ZTogNjU5MTk4MSwKICBjb3Juc2lsazogMTY3NzUzODgsCiAgY3JpbXNvbjogMTQ0MjMxMDAsCiAgY3lhbjogNjU1MzUsCiAgZGFya2JsdWU6IDEzOSwKICBkYXJrY3lhbjogMzU3MjMsCiAgZGFya2dvbGRlbnJvZDogMTIwOTI5MzksCiAgZGFya2dyYXk6IDExMTE5MDE3LAogIGRhcmtncmVlbjogMjU2MDAsCiAgZGFya2dyZXk6IDExMTE5MDE3LAogIGRhcmtraGFraTogMTI0MzMyNTksCiAgZGFya21hZ2VudGE6IDkxMDk2NDMsCiAgZGFya29saXZlZ3JlZW46IDU1OTc5OTksCiAgZGFya29yYW5nZTogMTY3NDc1MjAsCiAgZGFya29yY2hpZDogMTAwNDAwMTIsCiAgZGFya3JlZDogOTEwOTUwNCwKICBkYXJrc2FsbW9uOiAxNTMwODQxMCwKICBkYXJrc2VhZ3JlZW46IDk0MTk5MTksCiAgZGFya3NsYXRlYmx1ZTogNDczNDM0NywKICBkYXJrc2xhdGVncmF5OiAzMTAwNDk1LAogIGRhcmtzbGF0ZWdyZXk6IDMxMDA0OTUsCiAgZGFya3R1cnF1b2lzZTogNTI5NDUsCiAgZGFya3Zpb2xldDogOTY5OTUzOSwKICBkZWVwcGluazogMTY3MTY5NDcsCiAgZGVlcHNreWJsdWU6IDQ5MTUxLAogIGRpbWdyYXk6IDY5MDgyNjUsCiAgZGltZ3JleTogNjkwODI2NSwKICBkb2RnZXJibHVlOiAyMDAzMTk5LAogIGZpcmVicmljazogMTE2NzQxNDYsCiAgZmxvcmFsd2hpdGU6IDE2Nzc1OTIwLAogIGZvcmVzdGdyZWVuOiAyMjYzODQyLAogIGZ1Y2hzaWE6IDE2NzExOTM1LAogIGdhaW5zYm9ybzogMTQ0NzQ0NjAsCiAgZ2hvc3R3aGl0ZTogMTYzMTY2NzEsCiAgZ29sZDogMTY3NjY3MjAsCiAgZ29sZGVucm9kOiAxNDMyOTEyMCwKICBncmF5OiA4NDIxNTA0LAogIGdyZWVuOiAzMjc2OCwKICBncmVlbnllbGxvdzogMTE0MDMwNTUsCiAgZ3JleTogODQyMTUwNCwKICBob25leWRldzogMTU3OTQxNjAsCiAgaG90cGluazogMTY3Mzg3NDAsCiAgaW5kaWFucmVkOiAxMzQ1ODUyNCwKICBpbmRpZ286IDQ5MTUzMzAsCiAgaXZvcnk6IDE2Nzc3MjAwLAogIGtoYWtpOiAxNTc4NzY2MCwKICBsYXZlbmRlcjogMTUxMzI0MTAsCiAgbGF2ZW5kZXJibHVzaDogMTY3NzMzNjUsCiAgbGF3bmdyZWVuOiA4MTkwOTc2LAogIGxlbW9uY2hpZmZvbjogMTY3NzU4ODUsCiAgbGlnaHRibHVlOiAxMTM5MzI1NCwKICBsaWdodGNvcmFsOiAxNTc2MTUzNiwKICBsaWdodGN5YW46IDE0NzQ1NTk5LAogIGxpZ2h0Z29sZGVucm9keWVsbG93OiAxNjQ0ODIxMCwKICBsaWdodGdyYXk6IDEzODgyMzIzLAogIGxpZ2h0Z3JlZW46IDk0OTgyNTYsCiAgbGlnaHRncmV5OiAxMzg4MjMyMywKICBsaWdodHBpbms6IDE2NzU4NDY1LAogIGxpZ2h0c2FsbW9uOiAxNjc1Mjc2MiwKICBsaWdodHNlYWdyZWVuOiAyMTQyODkwLAogIGxpZ2h0c2t5Ymx1ZTogODkwMDM0NiwKICBsaWdodHNsYXRlZ3JheTogNzgzMzc1MywKICBsaWdodHNsYXRlZ3JleTogNzgzMzc1MywKICBsaWdodHN0ZWVsYmx1ZTogMTE1ODQ3MzQsCiAgbGlnaHR5ZWxsb3c6IDE2Nzc3MTg0LAogIGxpbWU6IDY1MjgwLAogIGxpbWVncmVlbjogMzMyOTMzMCwKICBsaW5lbjogMTY0NDU2NzAsCiAgbWFnZW50YTogMTY3MTE5MzUsCiAgbWFyb29uOiA4Mzg4NjA4LAogIG1lZGl1bWFxdWFtYXJpbmU6IDY3MzczMjIsCiAgbWVkaXVtYmx1ZTogMjA1LAogIG1lZGl1bW9yY2hpZDogMTIyMTE2NjcsCiAgbWVkaXVtcHVycGxlOiA5NjYyNjgzLAogIG1lZGl1bXNlYWdyZWVuOiAzOTc4MDk3LAogIG1lZGl1bXNsYXRlYmx1ZTogODA4Nzc5MCwKICBtZWRpdW1zcHJpbmdncmVlbjogNjQxNTQsCiAgbWVkaXVtdHVycXVvaXNlOiA0NzcyMzAwLAogIG1lZGl1bXZpb2xldHJlZDogMTMwNDcxNzMsCiAgbWlkbmlnaHRibHVlOiAxNjQ0OTEyLAogIG1pbnRjcmVhbTogMTYxMjE4NTAsCiAgbWlzdHlyb3NlOiAxNjc3MDI3MywKICBtb2NjYXNpbjogMTY3NzAyMjksCiAgbmF2YWpvd2hpdGU6IDE2NzY4Njg1LAogIG5hdnk6IDEyOCwKICBvbGRsYWNlOiAxNjY0MzU1OCwKICBvbGl2ZTogODQyMTM3NiwKICBvbGl2ZWRyYWI6IDcwNDg3MzksCiAgb3JhbmdlOiAxNjc1MzkyMCwKICBvcmFuZ2VyZWQ6IDE2NzI5MzQ0LAogIG9yY2hpZDogMTQzMTU3MzQsCiAgcGFsZWdvbGRlbnJvZDogMTU2NTcxMzAsCiAgcGFsZWdyZWVuOiAxMDAyNTg4MCwKICBwYWxldHVycXVvaXNlOiAxMTUyOTk2NiwKICBwYWxldmlvbGV0cmVkOiAxNDM4MTIwMywKICBwYXBheWF3aGlwOiAxNjc3MzA3NywKICBwZWFjaHB1ZmY6IDE2NzY3NjczLAogIHBlcnU6IDEzNDY4OTkxLAogIHBpbms6IDE2NzYxMDM1LAogIHBsdW06IDE0NTI0NjM3LAogIHBvd2RlcmJsdWU6IDExNTkxOTEwLAogIHB1cnBsZTogODM4ODczNiwKICByZWJlY2NhcHVycGxlOiA2Njk3ODgxLAogIHJlZDogMTY3MTE2ODAsCiAgcm9zeWJyb3duOiAxMjM1NzUxOSwKICByb3lhbGJsdWU6IDQyODY5NDUsCiAgc2FkZGxlYnJvd246IDkxMjcxODcsCiAgc2FsbW9uOiAxNjQxNjg4MiwKICBzYW5keWJyb3duOiAxNjAzMjg2NCwKICBzZWFncmVlbjogMzA1MDMyNywKICBzZWFzaGVsbDogMTY3NzQ2MzgsCiAgc2llbm5hOiAxMDUwNjc5NywKICBzaWx2ZXI6IDEyNjMyMjU2LAogIHNreWJsdWU6IDg5MDAzMzEsCiAgc2xhdGVibHVlOiA2OTcwMDYxLAogIHNsYXRlZ3JheTogNzM3Mjk0NCwKICBzbGF0ZWdyZXk6IDczNzI5NDQsCiAgc25vdzogMTY3NzU5MzAsCiAgc3ByaW5nZ3JlZW46IDY1NDA3LAogIHN0ZWVsYmx1ZTogNDYyMDk4MCwKICB0YW46IDEzODA4NzgwLAogIHRlYWw6IDMyODk2LAogIHRoaXN0bGU6IDE0MjA0ODg4LAogIHRvbWF0bzogMTY3MzcwOTUsCiAgdHVycXVvaXNlOiA0MjUxODU2LAogIHZpb2xldDogMTU2MzEwODYsCiAgd2hlYXQ6IDE2MTEzMzMxLAogIHdoaXRlOiAxNjc3NzIxNSwKICB3aGl0ZXNtb2tlOiAxNjExOTI4NSwKICB5ZWxsb3c6IDE2Nzc2OTYwLAogIHllbGxvd2dyZWVuOiAxMDE0NTA3NAp9OwpkZWZpbmVfZGVmYXVsdChDb2xvciwgY29sb3IsIHsKICBjb3B5KGNoYW5uZWxzKSB7CiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgdGhpcy5jb25zdHJ1Y3RvcigpLCB0aGlzLCBjaGFubmVscyk7CiAgfSwKICBkaXNwbGF5YWJsZSgpIHsKICAgIHJldHVybiB0aGlzLnJnYigpLmRpc3BsYXlhYmxlKCk7CiAgfSwKICBoZXg6IGNvbG9yX2Zvcm1hdEhleCwKICAvLyBEZXByZWNhdGVkISBVc2UgY29sb3IuZm9ybWF0SGV4LgogIGZvcm1hdEhleDogY29sb3JfZm9ybWF0SGV4LAogIGZvcm1hdEhleDg6IGNvbG9yX2Zvcm1hdEhleDgsCiAgZm9ybWF0SHNsOiBjb2xvcl9mb3JtYXRIc2wsCiAgZm9ybWF0UmdiOiBjb2xvcl9mb3JtYXRSZ2IsCiAgdG9TdHJpbmc6IGNvbG9yX2Zvcm1hdFJnYgp9KTsKZnVuY3Rpb24gY29sb3JfZm9ybWF0SGV4KCkgewogIHJldHVybiB0aGlzLnJnYigpLmZvcm1hdEhleCgpOwp9CmZ1bmN0aW9uIGNvbG9yX2Zvcm1hdEhleDgoKSB7CiAgcmV0dXJuIHRoaXMucmdiKCkuZm9ybWF0SGV4OCgpOwp9CmZ1bmN0aW9uIGNvbG9yX2Zvcm1hdEhzbCgpIHsKICByZXR1cm4gaHNsQ29udmVydCh0aGlzKS5mb3JtYXRIc2woKTsKfQpmdW5jdGlvbiBjb2xvcl9mb3JtYXRSZ2IoKSB7CiAgcmV0dXJuIHRoaXMucmdiKCkuZm9ybWF0UmdiKCk7Cn0KZnVuY3Rpb24gY29sb3IoZm9ybWF0MikgewogIHZhciBtLCBsOwogIGZvcm1hdDIgPSAoZm9ybWF0MiArICIiKS50cmltKCkudG9Mb3dlckNhc2UoKTsKICByZXR1cm4gKG0gPSByZUhleC5leGVjKGZvcm1hdDIpKSA/IChsID0gbVsxXS5sZW5ndGgsIG0gPSBwYXJzZUludChtWzFdLCAxNiksIGwgPT09IDYgPyByZ2JuKG0pIDogbCA9PT0gMyA/IG5ldyBSZ2IobSA+PiA4ICYgMTUgfCBtID4+IDQgJiAyNDAsIG0gPj4gNCAmIDE1IHwgbSAmIDI0MCwgKG0gJiAxNSkgPDwgNCB8IG0gJiAxNSwgMSkgOiBsID09PSA4ID8gcmdiYShtID4+IDI0ICYgMjU1LCBtID4+IDE2ICYgMjU1LCBtID4+IDggJiAyNTUsIChtICYgMjU1KSAvIDI1NSkgOiBsID09PSA0ID8gcmdiYShtID4+IDEyICYgMTUgfCBtID4+IDggJiAyNDAsIG0gPj4gOCAmIDE1IHwgbSA+PiA0ICYgMjQwLCBtID4+IDQgJiAxNSB8IG0gJiAyNDAsICgobSAmIDE1KSA8PCA0IHwgbSAmIDE1KSAvIDI1NSkgOiBudWxsKSA6IChtID0gcmVSZ2JJbnRlZ2VyLmV4ZWMoZm9ybWF0MikpID8gbmV3IFJnYihtWzFdLCBtWzJdLCBtWzNdLCAxKSA6IChtID0gcmVSZ2JQZXJjZW50LmV4ZWMoZm9ybWF0MikpID8gbmV3IFJnYihtWzFdICogMjU1IC8gMTAwLCBtWzJdICogMjU1IC8gMTAwLCBtWzNdICogMjU1IC8gMTAwLCAxKSA6IChtID0gcmVSZ2JhSW50ZWdlci5leGVjKGZvcm1hdDIpKSA/IHJnYmEobVsxXSwgbVsyXSwgbVszXSwgbVs0XSkgOiAobSA9IHJlUmdiYVBlcmNlbnQuZXhlYyhmb3JtYXQyKSkgPyByZ2JhKG1bMV0gKiAyNTUgLyAxMDAsIG1bMl0gKiAyNTUgLyAxMDAsIG1bM10gKiAyNTUgLyAxMDAsIG1bNF0pIDogKG0gPSByZUhzbFBlcmNlbnQuZXhlYyhmb3JtYXQyKSkgPyBoc2xhKG1bMV0sIG1bMl0gLyAxMDAsIG1bM10gLyAxMDAsIDEpIDogKG0gPSByZUhzbGFQZXJjZW50LmV4ZWMoZm9ybWF0MikpID8gaHNsYShtWzFdLCBtWzJdIC8gMTAwLCBtWzNdIC8gMTAwLCBtWzRdKSA6IG5hbWVkLmhhc093blByb3BlcnR5KGZvcm1hdDIpID8gcmdibihuYW1lZFtmb3JtYXQyXSkgOiBmb3JtYXQyID09PSAidHJhbnNwYXJlbnQiID8gbmV3IFJnYihOYU4sIE5hTiwgTmFOLCAwKSA6IG51bGw7Cn0KZnVuY3Rpb24gcmdibihuKSB7CiAgcmV0dXJuIG5ldyBSZ2IobiA+PiAxNiAmIDI1NSwgbiA+PiA4ICYgMjU1LCBuICYgMjU1LCAxKTsKfQpmdW5jdGlvbiByZ2JhKHIyLCBnLCBiLCBhKSB7CiAgaWYgKGEgPD0gMCkgcjIgPSBnID0gYiA9IE5hTjsKICByZXR1cm4gbmV3IFJnYihyMiwgZywgYiwgYSk7Cn0KZnVuY3Rpb24gcmdiQ29udmVydChvKSB7CiAgaWYgKCEobyBpbnN0YW5jZW9mIENvbG9yKSkgbyA9IGNvbG9yKG8pOwogIGlmICghbykgcmV0dXJuIG5ldyBSZ2IoKTsKICBvID0gby5yZ2IoKTsKICByZXR1cm4gbmV3IFJnYihvLnIsIG8uZywgby5iLCBvLm9wYWNpdHkpOwp9CmZ1bmN0aW9uIHJnYihyMiwgZywgYiwgb3BhY2l0eSkgewogIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID09PSAxID8gcmdiQ29udmVydChyMikgOiBuZXcgUmdiKHIyLCBnLCBiLCBvcGFjaXR5ID09IG51bGwgPyAxIDogb3BhY2l0eSk7Cn0KZnVuY3Rpb24gUmdiKHIyLCBnLCBiLCBvcGFjaXR5KSB7CiAgdGhpcy5yID0gK3IyOwogIHRoaXMuZyA9ICtnOwogIHRoaXMuYiA9ICtiOwogIHRoaXMub3BhY2l0eSA9ICtvcGFjaXR5Owp9CmRlZmluZV9kZWZhdWx0KFJnYiwgcmdiLCBleHRlbmQoQ29sb3IsIHsKICBicmlnaHRlcihrKSB7CiAgICBrID0gayA9PSBudWxsID8gYnJpZ2h0ZXIgOiBNYXRoLnBvdyhicmlnaHRlciwgayk7CiAgICByZXR1cm4gbmV3IFJnYih0aGlzLnIgKiBrLCB0aGlzLmcgKiBrLCB0aGlzLmIgKiBrLCB0aGlzLm9wYWNpdHkpOwogIH0sCiAgZGFya2VyKGspIHsKICAgIGsgPSBrID09IG51bGwgPyBkYXJrZXIgOiBNYXRoLnBvdyhkYXJrZXIsIGspOwogICAgcmV0dXJuIG5ldyBSZ2IodGhpcy5yICogaywgdGhpcy5nICogaywgdGhpcy5iICogaywgdGhpcy5vcGFjaXR5KTsKICB9LAogIHJnYigpIHsKICAgIHJldHVybiB0aGlzOwogIH0sCiAgY2xhbXAoKSB7CiAgICByZXR1cm4gbmV3IFJnYihjbGFtcGkodGhpcy5yKSwgY2xhbXBpKHRoaXMuZyksIGNsYW1waSh0aGlzLmIpLCBjbGFtcGEodGhpcy5vcGFjaXR5KSk7CiAgfSwKICBkaXNwbGF5YWJsZSgpIHsKICAgIHJldHVybiAtMC41IDw9IHRoaXMuciAmJiB0aGlzLnIgPCAyNTUuNSAmJiAoLTAuNSA8PSB0aGlzLmcgJiYgdGhpcy5nIDwgMjU1LjUpICYmICgtMC41IDw9IHRoaXMuYiAmJiB0aGlzLmIgPCAyNTUuNSkgJiYgKDAgPD0gdGhpcy5vcGFjaXR5ICYmIHRoaXMub3BhY2l0eSA8PSAxKTsKICB9LAogIGhleDogcmdiX2Zvcm1hdEhleCwKICAvLyBEZXByZWNhdGVkISBVc2UgY29sb3IuZm9ybWF0SGV4LgogIGZvcm1hdEhleDogcmdiX2Zvcm1hdEhleCwKICBmb3JtYXRIZXg4OiByZ2JfZm9ybWF0SGV4OCwKICBmb3JtYXRSZ2I6IHJnYl9mb3JtYXRSZ2IsCiAgdG9TdHJpbmc6IHJnYl9mb3JtYXRSZ2IKfSkpOwpmdW5jdGlvbiByZ2JfZm9ybWF0SGV4KCkgewogIHJldHVybiBgIyR7aGV4KHRoaXMucil9JHtoZXgodGhpcy5nKX0ke2hleCh0aGlzLmIpfWA7Cn0KZnVuY3Rpb24gcmdiX2Zvcm1hdEhleDgoKSB7CiAgcmV0dXJuIGAjJHtoZXgodGhpcy5yKX0ke2hleCh0aGlzLmcpfSR7aGV4KHRoaXMuYil9JHtoZXgoKGlzTmFOKHRoaXMub3BhY2l0eSkgPyAxIDogdGhpcy5vcGFjaXR5KSAqIDI1NSl9YDsKfQpmdW5jdGlvbiByZ2JfZm9ybWF0UmdiKCkgewogIGNvbnN0IGEgPSBjbGFtcGEodGhpcy5vcGFjaXR5KTsKICByZXR1cm4gYCR7YSA9PT0gMSA/ICJyZ2IoIiA6ICJyZ2JhKCJ9JHtjbGFtcGkodGhpcy5yKX0sICR7Y2xhbXBpKHRoaXMuZyl9LCAke2NsYW1waSh0aGlzLmIpfSR7YSA9PT0gMSA/ICIpIiA6IGAsICR7YX0pYH1gOwp9CmZ1bmN0aW9uIGNsYW1wYShvcGFjaXR5KSB7CiAgcmV0dXJuIGlzTmFOKG9wYWNpdHkpID8gMSA6IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIG9wYWNpdHkpKTsKfQpmdW5jdGlvbiBjbGFtcGkodmFsdWUpIHsKICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oMjU1LCBNYXRoLnJvdW5kKHZhbHVlKSB8fCAwKSk7Cn0KZnVuY3Rpb24gaGV4KHZhbHVlKSB7CiAgdmFsdWUgPSBjbGFtcGkodmFsdWUpOwogIHJldHVybiAodmFsdWUgPCAxNiA/ICIwIiA6ICIiKSArIHZhbHVlLnRvU3RyaW5nKDE2KTsKfQpmdW5jdGlvbiBoc2xhKGgsIHMsIGwsIGEpIHsKICBpZiAoYSA8PSAwKSBoID0gcyA9IGwgPSBOYU47CiAgZWxzZSBpZiAobCA8PSAwIHx8IGwgPj0gMSkgaCA9IHMgPSBOYU47CiAgZWxzZSBpZiAocyA8PSAwKSBoID0gTmFOOwogIHJldHVybiBuZXcgSHNsKGgsIHMsIGwsIGEpOwp9CmZ1bmN0aW9uIGhzbENvbnZlcnQobykgewogIGlmIChvIGluc3RhbmNlb2YgSHNsKSByZXR1cm4gbmV3IEhzbChvLmgsIG8ucywgby5sLCBvLm9wYWNpdHkpOwogIGlmICghKG8gaW5zdGFuY2VvZiBDb2xvcikpIG8gPSBjb2xvcihvKTsKICBpZiAoIW8pIHJldHVybiBuZXcgSHNsKCk7CiAgaWYgKG8gaW5zdGFuY2VvZiBIc2wpIHJldHVybiBvOwogIG8gPSBvLnJnYigpOwogIHZhciByMiA9IG8uciAvIDI1NSwgZyA9IG8uZyAvIDI1NSwgYiA9IG8uYiAvIDI1NSwgbWluMiA9IE1hdGgubWluKHIyLCBnLCBiKSwgbWF4MiA9IE1hdGgubWF4KHIyLCBnLCBiKSwgaCA9IE5hTiwgcyA9IG1heDIgLSBtaW4yLCBsID0gKG1heDIgKyBtaW4yKSAvIDI7CiAgaWYgKHMpIHsKICAgIGlmIChyMiA9PT0gbWF4MikgaCA9IChnIC0gYikgLyBzICsgKGcgPCBiKSAqIDY7CiAgICBlbHNlIGlmIChnID09PSBtYXgyKSBoID0gKGIgLSByMikgLyBzICsgMjsKICAgIGVsc2UgaCA9IChyMiAtIGcpIC8gcyArIDQ7CiAgICBzIC89IGwgPCAwLjUgPyBtYXgyICsgbWluMiA6IDIgLSBtYXgyIC0gbWluMjsKICAgIGggKj0gNjA7CiAgfSBlbHNlIHsKICAgIHMgPSBsID4gMCAmJiBsIDwgMSA/IDAgOiBoOwogIH0KICByZXR1cm4gbmV3IEhzbChoLCBzLCBsLCBvLm9wYWNpdHkpOwp9CmZ1bmN0aW9uIGhzbChoLCBzLCBsLCBvcGFjaXR5KSB7CiAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyBoc2xDb252ZXJ0KGgpIDogbmV3IEhzbChoLCBzLCBsLCBvcGFjaXR5ID09IG51bGwgPyAxIDogb3BhY2l0eSk7Cn0KZnVuY3Rpb24gSHNsKGgsIHMsIGwsIG9wYWNpdHkpIHsKICB0aGlzLmggPSAraDsKICB0aGlzLnMgPSArczsKICB0aGlzLmwgPSArbDsKICB0aGlzLm9wYWNpdHkgPSArb3BhY2l0eTsKfQpkZWZpbmVfZGVmYXVsdChIc2wsIGhzbCwgZXh0ZW5kKENvbG9yLCB7CiAgYnJpZ2h0ZXIoaykgewogICAgayA9IGsgPT0gbnVsbCA/IGJyaWdodGVyIDogTWF0aC5wb3coYnJpZ2h0ZXIsIGspOwogICAgcmV0dXJuIG5ldyBIc2wodGhpcy5oLCB0aGlzLnMsIHRoaXMubCAqIGssIHRoaXMub3BhY2l0eSk7CiAgfSwKICBkYXJrZXIoaykgewogICAgayA9IGsgPT0gbnVsbCA/IGRhcmtlciA6IE1hdGgucG93KGRhcmtlciwgayk7CiAgICByZXR1cm4gbmV3IEhzbCh0aGlzLmgsIHRoaXMucywgdGhpcy5sICogaywgdGhpcy5vcGFjaXR5KTsKICB9LAogIHJnYigpIHsKICAgIHZhciBoID0gdGhpcy5oICUgMzYwICsgKHRoaXMuaCA8IDApICogMzYwLCBzID0gaXNOYU4oaCkgfHwgaXNOYU4odGhpcy5zKSA/IDAgOiB0aGlzLnMsIGwgPSB0aGlzLmwsIG0yID0gbCArIChsIDwgMC41ID8gbCA6IDEgLSBsKSAqIHMsIG0xID0gMiAqIGwgLSBtMjsKICAgIHJldHVybiBuZXcgUmdiKAogICAgICBoc2wycmdiKGggPj0gMjQwID8gaCAtIDI0MCA6IGggKyAxMjAsIG0xLCBtMiksCiAgICAgIGhzbDJyZ2IoaCwgbTEsIG0yKSwKICAgICAgaHNsMnJnYihoIDwgMTIwID8gaCArIDI0MCA6IGggLSAxMjAsIG0xLCBtMiksCiAgICAgIHRoaXMub3BhY2l0eQogICAgKTsKICB9LAogIGNsYW1wKCkgewogICAgcmV0dXJuIG5ldyBIc2woY2xhbXBoKHRoaXMuaCksIGNsYW1wdCh0aGlzLnMpLCBjbGFtcHQodGhpcy5sKSwgY2xhbXBhKHRoaXMub3BhY2l0eSkpOwogIH0sCiAgZGlzcGxheWFibGUoKSB7CiAgICByZXR1cm4gKDAgPD0gdGhpcy5zICYmIHRoaXMucyA8PSAxIHx8IGlzTmFOKHRoaXMucykpICYmICgwIDw9IHRoaXMubCAmJiB0aGlzLmwgPD0gMSkgJiYgKDAgPD0gdGhpcy5vcGFjaXR5ICYmIHRoaXMub3BhY2l0eSA8PSAxKTsKICB9LAogIGZvcm1hdEhzbCgpIHsKICAgIGNvbnN0IGEgPSBjbGFtcGEodGhpcy5vcGFjaXR5KTsKICAgIHJldHVybiBgJHthID09PSAxID8gImhzbCgiIDogImhzbGEoIn0ke2NsYW1waCh0aGlzLmgpfSwgJHtjbGFtcHQodGhpcy5zKSAqIDEwMH0lLCAke2NsYW1wdCh0aGlzLmwpICogMTAwfSUke2EgPT09IDEgPyAiKSIgOiBgLCAke2F9KWB9YDsKICB9Cn0pKTsKZnVuY3Rpb24gY2xhbXBoKHZhbHVlKSB7CiAgdmFsdWUgPSAodmFsdWUgfHwgMCkgJSAzNjA7CiAgcmV0dXJuIHZhbHVlIDwgMCA/IHZhbHVlICsgMzYwIDogdmFsdWU7Cn0KZnVuY3Rpb24gY2xhbXB0KHZhbHVlKSB7CiAgcmV0dXJuIE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHZhbHVlIHx8IDApKTsKfQpmdW5jdGlvbiBoc2wycmdiKGgsIG0xLCBtMikgewogIHJldHVybiAoaCA8IDYwID8gbTEgKyAobTIgLSBtMSkgKiBoIC8gNjAgOiBoIDwgMTgwID8gbTIgOiBoIDwgMjQwID8gbTEgKyAobTIgLSBtMSkgKiAoMjQwIC0gaCkgLyA2MCA6IG0xKSAqIDI1NTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9iYXNpcy5qcwpmdW5jdGlvbiBiYXNpcyh0MTIsIHYwLCB2MSwgdjIsIHYzKSB7CiAgdmFyIHQyID0gdDEyICogdDEyLCB0MyA9IHQyICogdDEyOwogIHJldHVybiAoKDEgLSAzICogdDEyICsgMyAqIHQyIC0gdDMpICogdjAgKyAoNCAtIDYgKiB0MiArIDMgKiB0MykgKiB2MSArICgxICsgMyAqIHQxMiArIDMgKiB0MiAtIDMgKiB0MykgKiB2MiArIHQzICogdjMpIC8gNjsKfQpmdW5jdGlvbiBiYXNpc19kZWZhdWx0Mih2YWx1ZXMpIHsKICB2YXIgbiA9IHZhbHVlcy5sZW5ndGggLSAxOwogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICB2YXIgaSA9IHQgPD0gMCA/IHQgPSAwIDogdCA+PSAxID8gKHQgPSAxLCBuIC0gMSkgOiBNYXRoLmZsb29yKHQgKiBuKSwgdjEgPSB2YWx1ZXNbaV0sIHYyID0gdmFsdWVzW2kgKyAxXSwgdjAgPSBpID4gMCA/IHZhbHVlc1tpIC0gMV0gOiAyICogdjEgLSB2MiwgdjMgPSBpIDwgbiAtIDEgPyB2YWx1ZXNbaSArIDJdIDogMiAqIHYyIC0gdjE7CiAgICByZXR1cm4gYmFzaXMoKHQgLSBpIC8gbikgKiBuLCB2MCwgdjEsIHYyLCB2Myk7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9iYXNpc0Nsb3NlZC5qcwpmdW5jdGlvbiBiYXNpc0Nsb3NlZF9kZWZhdWx0Mih2YWx1ZXMpIHsKICB2YXIgbiA9IHZhbHVlcy5sZW5ndGg7CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHZhciBpID0gTWF0aC5mbG9vcigoKHQgJT0gMSkgPCAwID8gKyt0IDogdCkgKiBuKSwgdjAgPSB2YWx1ZXNbKGkgKyBuIC0gMSkgJSBuXSwgdjEgPSB2YWx1ZXNbaSAlIG5dLCB2MiA9IHZhbHVlc1soaSArIDEpICUgbl0sIHYzID0gdmFsdWVzWyhpICsgMikgJSBuXTsKICAgIHJldHVybiBiYXNpcygodCAtIGkgLyBuKSAqIG4sIHYwLCB2MSwgdjIsIHYzKTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2NvbnN0YW50LmpzCnZhciBjb25zdGFudF9kZWZhdWx0MiA9ICh4MikgPT4gKCkgPT4geDI7CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2NvbG9yLmpzCmZ1bmN0aW9uIGxpbmVhcihhLCBkKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiBhICsgdCAqIGQ7CiAgfTsKfQpmdW5jdGlvbiBleHBvbmVudGlhbChhLCBiLCB5MikgewogIHJldHVybiBhID0gTWF0aC5wb3coYSwgeTIpLCBiID0gTWF0aC5wb3coYiwgeTIpIC0gYSwgeTIgPSAxIC8geTIsIGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiBNYXRoLnBvdyhhICsgdCAqIGIsIHkyKTsKICB9Owp9CmZ1bmN0aW9uIGdhbW1hKHkyKSB7CiAgcmV0dXJuICh5MiA9ICt5MikgPT09IDEgPyBub2dhbW1hIDogZnVuY3Rpb24oYSwgYikgewogICAgcmV0dXJuIGIgLSBhID8gZXhwb25lbnRpYWwoYSwgYiwgeTIpIDogY29uc3RhbnRfZGVmYXVsdDIoaXNOYU4oYSkgPyBiIDogYSk7CiAgfTsKfQpmdW5jdGlvbiBub2dhbW1hKGEsIGIpIHsKICB2YXIgZCA9IGIgLSBhOwogIHJldHVybiBkID8gbGluZWFyKGEsIGQpIDogY29uc3RhbnRfZGVmYXVsdDIoaXNOYU4oYSkgPyBiIDogYSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvcmdiLmpzCnZhciByZ2JfZGVmYXVsdCA9IGZ1bmN0aW9uIHJnYkdhbW1hKHkyKSB7CiAgdmFyIGNvbG9yMiA9IGdhbW1hKHkyKTsKICBmdW5jdGlvbiByZ2IyKHN0YXJ0LCBlbmQpIHsKICAgIHZhciByMiA9IGNvbG9yMigoc3RhcnQgPSByZ2Ioc3RhcnQpKS5yLCAoZW5kID0gcmdiKGVuZCkpLnIpLCBnID0gY29sb3IyKHN0YXJ0LmcsIGVuZC5nKSwgYiA9IGNvbG9yMihzdGFydC5iLCBlbmQuYiksIG9wYWNpdHkgPSBub2dhbW1hKHN0YXJ0Lm9wYWNpdHksIGVuZC5vcGFjaXR5KTsKICAgIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICAgIHN0YXJ0LnIgPSByMih0KTsKICAgICAgc3RhcnQuZyA9IGcodCk7CiAgICAgIHN0YXJ0LmIgPSBiKHQpOwogICAgICBzdGFydC5vcGFjaXR5ID0gb3BhY2l0eSh0KTsKICAgICAgcmV0dXJuIHN0YXJ0ICsgIiI7CiAgICB9OwogIH0KICByZ2IyLmdhbW1hID0gcmdiR2FtbWE7CiAgcmV0dXJuIHJnYjI7Cn0oMSk7CmZ1bmN0aW9uIHJnYlNwbGluZShzcGxpbmUpIHsKICByZXR1cm4gZnVuY3Rpb24oY29sb3JzKSB7CiAgICB2YXIgbiA9IGNvbG9ycy5sZW5ndGgsIHIyID0gbmV3IEFycmF5KG4pLCBnID0gbmV3IEFycmF5KG4pLCBiID0gbmV3IEFycmF5KG4pLCBpLCBjb2xvcjI7CiAgICBmb3IgKGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgIGNvbG9yMiA9IHJnYihjb2xvcnNbaV0pOwogICAgICByMltpXSA9IGNvbG9yMi5yIHx8IDA7CiAgICAgIGdbaV0gPSBjb2xvcjIuZyB8fCAwOwogICAgICBiW2ldID0gY29sb3IyLmIgfHwgMDsKICAgIH0KICAgIHIyID0gc3BsaW5lKHIyKTsKICAgIGcgPSBzcGxpbmUoZyk7CiAgICBiID0gc3BsaW5lKGIpOwogICAgY29sb3IyLm9wYWNpdHkgPSAxOwogICAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgY29sb3IyLnIgPSByMih0KTsKICAgICAgY29sb3IyLmcgPSBnKHQpOwogICAgICBjb2xvcjIuYiA9IGIodCk7CiAgICAgIHJldHVybiBjb2xvcjIgKyAiIjsKICAgIH07CiAgfTsKfQp2YXIgcmdiQmFzaXMgPSByZ2JTcGxpbmUoYmFzaXNfZGVmYXVsdDIpOwp2YXIgcmdiQmFzaXNDbG9zZWQgPSByZ2JTcGxpbmUoYmFzaXNDbG9zZWRfZGVmYXVsdDIpOwoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9udW1iZXJBcnJheS5qcwpmdW5jdGlvbiBudW1iZXJBcnJheV9kZWZhdWx0KGEsIGIpIHsKICBpZiAoIWIpIGIgPSBbXTsKICB2YXIgbiA9IGEgPyBNYXRoLm1pbihiLmxlbmd0aCwgYS5sZW5ndGgpIDogMCwgYyA9IGIuc2xpY2UoKSwgaTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgZm9yIChpID0gMDsgaSA8IG47ICsraSkgY1tpXSA9IGFbaV0gKiAoMSAtIHQpICsgYltpXSAqIHQ7CiAgICByZXR1cm4gYzsKICB9Owp9CmZ1bmN0aW9uIGlzTnVtYmVyQXJyYXkoeDIpIHsKICByZXR1cm4gQXJyYXlCdWZmZXIuaXNWaWV3KHgyKSAmJiAhKHgyIGluc3RhbmNlb2YgRGF0YVZpZXcpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2FycmF5LmpzCmZ1bmN0aW9uIGdlbmVyaWNBcnJheShhLCBiKSB7CiAgdmFyIG5iID0gYiA/IGIubGVuZ3RoIDogMCwgbmEgPSBhID8gTWF0aC5taW4obmIsIGEubGVuZ3RoKSA6IDAsIHgyID0gbmV3IEFycmF5KG5hKSwgYyA9IG5ldyBBcnJheShuYiksIGk7CiAgZm9yIChpID0gMDsgaSA8IG5hOyArK2kpIHgyW2ldID0gdmFsdWVfZGVmYXVsdChhW2ldLCBiW2ldKTsKICBmb3IgKDsgaSA8IG5iOyArK2kpIGNbaV0gPSBiW2ldOwogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICBmb3IgKGkgPSAwOyBpIDwgbmE7ICsraSkgY1tpXSA9IHgyW2ldKHQpOwogICAgcmV0dXJuIGM7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9kYXRlLmpzCmZ1bmN0aW9uIGRhdGVfZGVmYXVsdChhLCBiKSB7CiAgdmFyIGQgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKTsKICByZXR1cm4gYSA9ICthLCBiID0gK2IsIGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiBkLnNldFRpbWUoYSAqICgxIC0gdCkgKyBiICogdCksIGQ7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9udW1iZXIuanMKZnVuY3Rpb24gbnVtYmVyX2RlZmF1bHQoYSwgYikgewogIHJldHVybiBhID0gK2EsIGIgPSArYiwgZnVuY3Rpb24odCkgewogICAgcmV0dXJuIGEgKiAoMSAtIHQpICsgYiAqIHQ7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9vYmplY3QuanMKZnVuY3Rpb24gb2JqZWN0X2RlZmF1bHQoYSwgYikgewogIHZhciBpID0ge30sIGMgPSB7fSwgazsKICBpZiAoYSA9PT0gbnVsbCB8fCB0eXBlb2YgYSAhPT0gIm9iamVjdCIpIGEgPSB7fTsKICBpZiAoYiA9PT0gbnVsbCB8fCB0eXBlb2YgYiAhPT0gIm9iamVjdCIpIGIgPSB7fTsKICBmb3IgKGsgaW4gYikgewogICAgaWYgKGsgaW4gYSkgewogICAgICBpW2tdID0gdmFsdWVfZGVmYXVsdChhW2tdLCBiW2tdKTsKICAgIH0gZWxzZSB7CiAgICAgIGNba10gPSBiW2tdOwogICAgfQogIH0KICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgZm9yIChrIGluIGkpIGNba10gPSBpW2tdKHQpOwogICAgcmV0dXJuIGM7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9zdHJpbmcuanMKdmFyIHJlQSA9IC9bLStdPyg/OlxkK1wuP1xkKnxcLj9cZCspKD86W2VFXVstK10/XGQrKT8vZzsKdmFyIHJlQiA9IG5ldyBSZWdFeHAocmVBLnNvdXJjZSwgImciKTsKZnVuY3Rpb24gemVybzIoYikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBiOwogIH07Cn0KZnVuY3Rpb24gb25lKGIpIHsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgcmV0dXJuIGIodCkgKyAiIjsKICB9Owp9CmZ1bmN0aW9uIHN0cmluZ19kZWZhdWx0KGEsIGIpIHsKICB2YXIgYmkgPSByZUEubGFzdEluZGV4ID0gcmVCLmxhc3RJbmRleCA9IDAsIGFtLCBibSwgYnMsIGkgPSAtMSwgcyA9IFtdLCBxID0gW107CiAgYSA9IGEgKyAiIiwgYiA9IGIgKyAiIjsKICB3aGlsZSAoKGFtID0gcmVBLmV4ZWMoYSkpICYmIChibSA9IHJlQi5leGVjKGIpKSkgewogICAgaWYgKChicyA9IGJtLmluZGV4KSA+IGJpKSB7CiAgICAgIGJzID0gYi5zbGljZShiaSwgYnMpOwogICAgICBpZiAoc1tpXSkgc1tpXSArPSBiczsKICAgICAgZWxzZSBzWysraV0gPSBiczsKICAgIH0KICAgIGlmICgoYW0gPSBhbVswXSkgPT09IChibSA9IGJtWzBdKSkgewogICAgICBpZiAoc1tpXSkgc1tpXSArPSBibTsKICAgICAgZWxzZSBzWysraV0gPSBibTsKICAgIH0gZWxzZSB7CiAgICAgIHNbKytpXSA9IG51bGw7CiAgICAgIHEucHVzaCh7IGksIHg6IG51bWJlcl9kZWZhdWx0KGFtLCBibSkgfSk7CiAgICB9CiAgICBiaSA9IHJlQi5sYXN0SW5kZXg7CiAgfQogIGlmIChiaSA8IGIubGVuZ3RoKSB7CiAgICBicyA9IGIuc2xpY2UoYmkpOwogICAgaWYgKHNbaV0pIHNbaV0gKz0gYnM7CiAgICBlbHNlIHNbKytpXSA9IGJzOwogIH0KICByZXR1cm4gcy5sZW5ndGggPCAyID8gcVswXSA/IG9uZShxWzBdLngpIDogemVybzIoYikgOiAoYiA9IHEubGVuZ3RoLCBmdW5jdGlvbih0KSB7CiAgICBmb3IgKHZhciBpMiA9IDAsIG87IGkyIDwgYjsgKytpMikgc1sobyA9IHFbaTJdKS5pXSA9IG8ueCh0KTsKICAgIHJldHVybiBzLmpvaW4oIiIpOwogIH0pOwp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL3ZhbHVlLmpzCmZ1bmN0aW9uIHZhbHVlX2RlZmF1bHQoYSwgYikgewogIHZhciB0ID0gdHlwZW9mIGIsIGM7CiAgcmV0dXJuIGIgPT0gbnVsbCB8fCB0ID09PSAiYm9vbGVhbiIgPyBjb25zdGFudF9kZWZhdWx0MihiKSA6ICh0ID09PSAibnVtYmVyIiA/IG51bWJlcl9kZWZhdWx0IDogdCA9PT0gInN0cmluZyIgPyAoYyA9IGNvbG9yKGIpKSA/IChiID0gYywgcmdiX2RlZmF1bHQpIDogc3RyaW5nX2RlZmF1bHQgOiBiIGluc3RhbmNlb2YgY29sb3IgPyByZ2JfZGVmYXVsdCA6IGIgaW5zdGFuY2VvZiBEYXRlID8gZGF0ZV9kZWZhdWx0IDogaXNOdW1iZXJBcnJheShiKSA/IG51bWJlckFycmF5X2RlZmF1bHQgOiBBcnJheS5pc0FycmF5KGIpID8gZ2VuZXJpY0FycmF5IDogdHlwZW9mIGIudmFsdWVPZiAhPT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgYi50b1N0cmluZyAhPT0gImZ1bmN0aW9uIiB8fCBpc05hTihiKSA/IG9iamVjdF9kZWZhdWx0IDogbnVtYmVyX2RlZmF1bHQpKGEsIGIpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL3JvdW5kLmpzCmZ1bmN0aW9uIHJvdW5kX2RlZmF1bHQoYSwgYikgewogIHJldHVybiBhID0gK2EsIGIgPSArYiwgZnVuY3Rpb24odCkgewogICAgcmV0dXJuIE1hdGgucm91bmQoYSAqICgxIC0gdCkgKyBiICogdCk7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9waWVjZXdpc2UuanMKZnVuY3Rpb24gcGllY2V3aXNlKGludGVycG9sYXRlMiwgdmFsdWVzKSB7CiAgaWYgKHZhbHVlcyA9PT0gdm9pZCAwKSB2YWx1ZXMgPSBpbnRlcnBvbGF0ZTIsIGludGVycG9sYXRlMiA9IHZhbHVlX2RlZmF1bHQ7CiAgdmFyIGkgPSAwLCBuID0gdmFsdWVzLmxlbmd0aCAtIDEsIHYgPSB2YWx1ZXNbMF0sIEkgPSBuZXcgQXJyYXkobiA8IDAgPyAwIDogbik7CiAgd2hpbGUgKGkgPCBuKSBJW2ldID0gaW50ZXJwb2xhdGUyKHYsIHYgPSB2YWx1ZXNbKytpXSk7CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHZhciBpMiA9IE1hdGgubWF4KDAsIE1hdGgubWluKG4gLSAxLCBNYXRoLmZsb29yKHQgKj0gbikpKTsKICAgIHJldHVybiBJW2kyXSh0IC0gaTIpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvY29uc3RhbnQuanMKZnVuY3Rpb24gY29uc3RhbnRzKHgyKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHgyOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvbnVtYmVyLmpzCmZ1bmN0aW9uIG51bWJlcjIoeDIpIHsKICByZXR1cm4gK3gyOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2NvbnRpbnVvdXMuanMKdmFyIHVuaXQgPSBbMCwgMV07CmZ1bmN0aW9uIGlkZW50aXR5KHgyKSB7CiAgcmV0dXJuIHgyOwp9CmZ1bmN0aW9uIG5vcm1hbGl6ZShhLCBiKSB7CiAgcmV0dXJuIChiIC09IGEgPSArYSkgPyBmdW5jdGlvbih4MikgewogICAgcmV0dXJuICh4MiAtIGEpIC8gYjsKICB9IDogY29uc3RhbnRzKGlzTmFOKGIpID8gTmFOIDogMC41KTsKfQpmdW5jdGlvbiBjbGFtcGVyKGEsIGIpIHsKICB2YXIgdDsKICBpZiAoYSA+IGIpIHQgPSBhLCBhID0gYiwgYiA9IHQ7CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4gTWF0aC5tYXgoYSwgTWF0aC5taW4oYiwgeDIpKTsKICB9Owp9CmZ1bmN0aW9uIGJpbWFwKGRvbWFpbiwgcmFuZ2U0LCBpbnRlcnBvbGF0ZTIpIHsKICB2YXIgZDAgPSBkb21haW5bMF0sIGQxID0gZG9tYWluWzFdLCByMCA9IHJhbmdlNFswXSwgcjEgPSByYW5nZTRbMV07CiAgaWYgKGQxIDwgZDApIGQwID0gbm9ybWFsaXplKGQxLCBkMCksIHIwID0gaW50ZXJwb2xhdGUyKHIxLCByMCk7CiAgZWxzZSBkMCA9IG5vcm1hbGl6ZShkMCwgZDEpLCByMCA9IGludGVycG9sYXRlMihyMCwgcjEpOwogIHJldHVybiBmdW5jdGlvbih4MikgewogICAgcmV0dXJuIHIwKGQwKHgyKSk7CiAgfTsKfQpmdW5jdGlvbiBwb2x5bWFwKGRvbWFpbiwgcmFuZ2U0LCBpbnRlcnBvbGF0ZTIpIHsKICB2YXIgaiA9IE1hdGgubWluKGRvbWFpbi5sZW5ndGgsIHJhbmdlNC5sZW5ndGgpIC0gMSwgZCA9IG5ldyBBcnJheShqKSwgcjIgPSBuZXcgQXJyYXkoaiksIGkgPSAtMTsKICBpZiAoZG9tYWluW2pdIDwgZG9tYWluWzBdKSB7CiAgICBkb21haW4gPSBkb21haW4uc2xpY2UoKS5yZXZlcnNlKCk7CiAgICByYW5nZTQgPSByYW5nZTQuc2xpY2UoKS5yZXZlcnNlKCk7CiAgfQogIHdoaWxlICgrK2kgPCBqKSB7CiAgICBkW2ldID0gbm9ybWFsaXplKGRvbWFpbltpXSwgZG9tYWluW2kgKyAxXSk7CiAgICByMltpXSA9IGludGVycG9sYXRlMihyYW5nZTRbaV0sIHJhbmdlNFtpICsgMV0pOwogIH0KICByZXR1cm4gZnVuY3Rpb24oeDIpIHsKICAgIHZhciBpMiA9IGJpc2VjdF9kZWZhdWx0KGRvbWFpbiwgeDIsIDEsIGopIC0gMTsKICAgIHJldHVybiByMltpMl0oZFtpMl0oeDIpKTsKICB9Owp9CmZ1bmN0aW9uIGNvcHkoc291cmNlLCB0YXJnZXQpIHsKICByZXR1cm4gdGFyZ2V0LmRvbWFpbihzb3VyY2UuZG9tYWluKCkpLnJhbmdlKHNvdXJjZS5yYW5nZSgpKS5pbnRlcnBvbGF0ZShzb3VyY2UuaW50ZXJwb2xhdGUoKSkuY2xhbXAoc291cmNlLmNsYW1wKCkpLnVua25vd24oc291cmNlLnVua25vd24oKSk7Cn0KZnVuY3Rpb24gdHJhbnNmb3JtZXIoKSB7CiAgdmFyIGRvbWFpbiA9IHVuaXQsIHJhbmdlNCA9IHVuaXQsIGludGVycG9sYXRlMiA9IHZhbHVlX2RlZmF1bHQsIHRyYW5zZm9ybSwgdW50cmFuc2Zvcm0sIHVua25vd24sIGNsYW1wID0gaWRlbnRpdHksIHBpZWNld2lzZTIsIG91dHB1dCwgaW5wdXQ7CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIHZhciBuID0gTWF0aC5taW4oZG9tYWluLmxlbmd0aCwgcmFuZ2U0Lmxlbmd0aCk7CiAgICBpZiAoY2xhbXAgIT09IGlkZW50aXR5KSBjbGFtcCA9IGNsYW1wZXIoZG9tYWluWzBdLCBkb21haW5bbiAtIDFdKTsKICAgIHBpZWNld2lzZTIgPSBuID4gMiA/IHBvbHltYXAgOiBiaW1hcDsKICAgIG91dHB1dCA9IGlucHV0ID0gbnVsbDsKICAgIHJldHVybiBzY2FsZTsKICB9CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiA9PSBudWxsIHx8IGlzTmFOKHgyID0gK3gyKSA/IHVua25vd24gOiAob3V0cHV0IHx8IChvdXRwdXQgPSBwaWVjZXdpc2UyKGRvbWFpbi5tYXAodHJhbnNmb3JtKSwgcmFuZ2U0LCBpbnRlcnBvbGF0ZTIpKSkodHJhbnNmb3JtKGNsYW1wKHgyKSkpOwogIH0KICBzY2FsZS5pbnZlcnQgPSBmdW5jdGlvbih5MikgewogICAgcmV0dXJuIGNsYW1wKHVudHJhbnNmb3JtKChpbnB1dCB8fCAoaW5wdXQgPSBwaWVjZXdpc2UyKHJhbmdlNCwgZG9tYWluLm1hcCh0cmFuc2Zvcm0pLCBudW1iZXJfZGVmYXVsdCkpKSh5MikpKTsKICB9OwogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRvbWFpbiA9IEFycmF5LmZyb20oXywgbnVtYmVyMiksIHJlc2NhbGUoKSkgOiBkb21haW4uc2xpY2UoKTsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocmFuZ2U0ID0gQXJyYXkuZnJvbShfKSwgcmVzY2FsZSgpKSA6IHJhbmdlNC5zbGljZSgpOwogIH07CiAgc2NhbGUucmFuZ2VSb3VuZCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiByYW5nZTQgPSBBcnJheS5mcm9tKF8pLCBpbnRlcnBvbGF0ZTIgPSByb3VuZF9kZWZhdWx0LCByZXNjYWxlKCk7CiAgfTsKICBzY2FsZS5jbGFtcCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGNsYW1wID0gXyA/IHRydWUgOiBpZGVudGl0eSwgcmVzY2FsZSgpKSA6IGNsYW1wICE9PSBpZGVudGl0eTsKICB9OwogIHNjYWxlLmludGVycG9sYXRlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoaW50ZXJwb2xhdGUyID0gXywgcmVzY2FsZSgpKSA6IGludGVycG9sYXRlMjsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHJldHVybiBmdW5jdGlvbih0LCB1KSB7CiAgICB0cmFuc2Zvcm0gPSB0LCB1bnRyYW5zZm9ybSA9IHU7CiAgICByZXR1cm4gcmVzY2FsZSgpOwogIH07Cn0KZnVuY3Rpb24gY29udGludW91cygpIHsKICByZXR1cm4gdHJhbnNmb3JtZXIoKShpZGVudGl0eSwgaWRlbnRpdHkpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXREZWNpbWFsLmpzCmZ1bmN0aW9uIGZvcm1hdERlY2ltYWxfZGVmYXVsdCh4MikgewogIHJldHVybiBNYXRoLmFicyh4MiA9IE1hdGgucm91bmQoeDIpKSA+PSAxZTIxID8geDIudG9Mb2NhbGVTdHJpbmcoImVuIikucmVwbGFjZSgvLC9nLCAiIikgOiB4Mi50b1N0cmluZygxMCk7Cn0KZnVuY3Rpb24gZm9ybWF0RGVjaW1hbFBhcnRzKHgyLCBwKSB7CiAgaWYgKChpID0gKHgyID0gcCA/IHgyLnRvRXhwb25lbnRpYWwocCAtIDEpIDogeDIudG9FeHBvbmVudGlhbCgpKS5pbmRleE9mKCJlIikpIDwgMCkgcmV0dXJuIG51bGw7CiAgdmFyIGksIGNvZWZmaWNpZW50ID0geDIuc2xpY2UoMCwgaSk7CiAgcmV0dXJuIFsKICAgIGNvZWZmaWNpZW50Lmxlbmd0aCA+IDEgPyBjb2VmZmljaWVudFswXSArIGNvZWZmaWNpZW50LnNsaWNlKDIpIDogY29lZmZpY2llbnQsCiAgICAreDIuc2xpY2UoaSArIDEpCiAgXTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZXhwb25lbnQuanMKZnVuY3Rpb24gZXhwb25lbnRfZGVmYXVsdCh4MikgewogIHJldHVybiB4MiA9IGZvcm1hdERlY2ltYWxQYXJ0cyhNYXRoLmFicyh4MikpLCB4MiA/IHgyWzFdIDogTmFOOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXRHcm91cC5qcwpmdW5jdGlvbiBmb3JtYXRHcm91cF9kZWZhdWx0KGdyb3VwaW5nLCB0aG91c2FuZHMpIHsKICByZXR1cm4gZnVuY3Rpb24odmFsdWUsIHdpZHRoKSB7CiAgICB2YXIgaSA9IHZhbHVlLmxlbmd0aCwgdCA9IFtdLCBqID0gMCwgZyA9IGdyb3VwaW5nWzBdLCBsZW5ndGggPSAwOwogICAgd2hpbGUgKGkgPiAwICYmIGcgPiAwKSB7CiAgICAgIGlmIChsZW5ndGggKyBnICsgMSA+IHdpZHRoKSBnID0gTWF0aC5tYXgoMSwgd2lkdGggLSBsZW5ndGgpOwogICAgICB0LnB1c2godmFsdWUuc3Vic3RyaW5nKGkgLT0gZywgaSArIGcpKTsKICAgICAgaWYgKChsZW5ndGggKz0gZyArIDEpID4gd2lkdGgpIGJyZWFrOwogICAgICBnID0gZ3JvdXBpbmdbaiA9IChqICsgMSkgJSBncm91cGluZy5sZW5ndGhdOwogICAgfQogICAgcmV0dXJuIHQucmV2ZXJzZSgpLmpvaW4odGhvdXNhbmRzKTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXROdW1lcmFscy5qcwpmdW5jdGlvbiBmb3JtYXROdW1lcmFsc19kZWZhdWx0KG51bWVyYWxzKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWUucmVwbGFjZSgvWzAtOV0vZywgZnVuY3Rpb24oaSkgewogICAgICByZXR1cm4gbnVtZXJhbHNbK2ldOwogICAgfSk7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0U3BlY2lmaWVyLmpzCnZhciByZSA9IC9eKD86KC4pPyhbPD49Xl0pKT8oWytcLSggXSk/KFskI10pPygwKT8oXGQrKT8oLCk/KFwuXGQrKT8ofik/KFthLXolXSk/JC9pOwpmdW5jdGlvbiBmb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKSB7CiAgaWYgKCEobWF0Y2ggPSByZS5leGVjKHNwZWNpZmllcikpKSB0aHJvdyBuZXcgRXJyb3IoImludmFsaWQgZm9ybWF0OiAiICsgc3BlY2lmaWVyKTsKICB2YXIgbWF0Y2g7CiAgcmV0dXJuIG5ldyBGb3JtYXRTcGVjaWZpZXIoewogICAgZmlsbDogbWF0Y2hbMV0sCiAgICBhbGlnbjogbWF0Y2hbMl0sCiAgICBzaWduOiBtYXRjaFszXSwKICAgIHN5bWJvbDogbWF0Y2hbNF0sCiAgICB6ZXJvOiBtYXRjaFs1XSwKICAgIHdpZHRoOiBtYXRjaFs2XSwKICAgIGNvbW1hOiBtYXRjaFs3XSwKICAgIHByZWNpc2lvbjogbWF0Y2hbOF0gJiYgbWF0Y2hbOF0uc2xpY2UoMSksCiAgICB0cmltOiBtYXRjaFs5XSwKICAgIHR5cGU6IG1hdGNoWzEwXQogIH0pOwp9CmZvcm1hdFNwZWNpZmllci5wcm90b3R5cGUgPSBGb3JtYXRTcGVjaWZpZXIucHJvdG90eXBlOwpmdW5jdGlvbiBGb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKSB7CiAgdGhpcy5maWxsID0gc3BlY2lmaWVyLmZpbGwgPT09IHZvaWQgMCA/ICIgIiA6IHNwZWNpZmllci5maWxsICsgIiI7CiAgdGhpcy5hbGlnbiA9IHNwZWNpZmllci5hbGlnbiA9PT0gdm9pZCAwID8gIj4iIDogc3BlY2lmaWVyLmFsaWduICsgIiI7CiAgdGhpcy5zaWduID0gc3BlY2lmaWVyLnNpZ24gPT09IHZvaWQgMCA/ICItIiA6IHNwZWNpZmllci5zaWduICsgIiI7CiAgdGhpcy5zeW1ib2wgPSBzcGVjaWZpZXIuc3ltYm9sID09PSB2b2lkIDAgPyAiIiA6IHNwZWNpZmllci5zeW1ib2wgKyAiIjsKICB0aGlzLnplcm8gPSAhIXNwZWNpZmllci56ZXJvOwogIHRoaXMud2lkdGggPSBzcGVjaWZpZXIud2lkdGggPT09IHZvaWQgMCA/IHZvaWQgMCA6ICtzcGVjaWZpZXIud2lkdGg7CiAgdGhpcy5jb21tYSA9ICEhc3BlY2lmaWVyLmNvbW1hOwogIHRoaXMucHJlY2lzaW9uID0gc3BlY2lmaWVyLnByZWNpc2lvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogK3NwZWNpZmllci5wcmVjaXNpb247CiAgdGhpcy50cmltID0gISFzcGVjaWZpZXIudHJpbTsKICB0aGlzLnR5cGUgPSBzcGVjaWZpZXIudHlwZSA9PT0gdm9pZCAwID8gIiIgOiBzcGVjaWZpZXIudHlwZSArICIiOwp9CkZvcm1hdFNwZWNpZmllci5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5maWxsICsgdGhpcy5hbGlnbiArIHRoaXMuc2lnbiArIHRoaXMuc3ltYm9sICsgKHRoaXMuemVybyA/ICIwIiA6ICIiKSArICh0aGlzLndpZHRoID09PSB2b2lkIDAgPyAiIiA6IE1hdGgubWF4KDEsIHRoaXMud2lkdGggfCAwKSkgKyAodGhpcy5jb21tYSA/ICIsIiA6ICIiKSArICh0aGlzLnByZWNpc2lvbiA9PT0gdm9pZCAwID8gIiIgOiAiLiIgKyBNYXRoLm1heCgwLCB0aGlzLnByZWNpc2lvbiB8IDApKSArICh0aGlzLnRyaW0gPyAifiIgOiAiIikgKyB0aGlzLnR5cGU7Cn07CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXRUcmltLmpzCmZ1bmN0aW9uIGZvcm1hdFRyaW1fZGVmYXVsdChzKSB7CiAgb3V0OiBmb3IgKHZhciBuID0gcy5sZW5ndGgsIGkgPSAxLCBpMCA9IC0xLCBpMTsgaSA8IG47ICsraSkgewogICAgc3dpdGNoIChzW2ldKSB7CiAgICAgIGNhc2UgIi4iOgogICAgICAgIGkwID0gaTEgPSBpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICIwIjoKICAgICAgICBpZiAoaTAgPT09IDApIGkwID0gaTsKICAgICAgICBpMSA9IGk7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgaWYgKCErc1tpXSkgYnJlYWsgb3V0OwogICAgICAgIGlmIChpMCA+IDApIGkwID0gMDsKICAgICAgICBicmVhazsKICAgIH0KICB9CiAgcmV0dXJuIGkwID4gMCA/IHMuc2xpY2UoMCwgaTApICsgcy5zbGljZShpMSArIDEpIDogczsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0UHJlZml4QXV0by5qcwp2YXIgcHJlZml4RXhwb25lbnQ7CmZ1bmN0aW9uIGZvcm1hdFByZWZpeEF1dG9fZGVmYXVsdCh4MiwgcCkgewogIHZhciBkID0gZm9ybWF0RGVjaW1hbFBhcnRzKHgyLCBwKTsKICBpZiAoIWQpIHJldHVybiB4MiArICIiOwogIHZhciBjb2VmZmljaWVudCA9IGRbMF0sIGV4cG9uZW50ID0gZFsxXSwgaSA9IGV4cG9uZW50IC0gKHByZWZpeEV4cG9uZW50ID0gTWF0aC5tYXgoLTgsIE1hdGgubWluKDgsIE1hdGguZmxvb3IoZXhwb25lbnQgLyAzKSkpICogMykgKyAxLCBuID0gY29lZmZpY2llbnQubGVuZ3RoOwogIHJldHVybiBpID09PSBuID8gY29lZmZpY2llbnQgOiBpID4gbiA/IGNvZWZmaWNpZW50ICsgbmV3IEFycmF5KGkgLSBuICsgMSkuam9pbigiMCIpIDogaSA+IDAgPyBjb2VmZmljaWVudC5zbGljZSgwLCBpKSArICIuIiArIGNvZWZmaWNpZW50LnNsaWNlKGkpIDogIjAuIiArIG5ldyBBcnJheSgxIC0gaSkuam9pbigiMCIpICsgZm9ybWF0RGVjaW1hbFBhcnRzKHgyLCBNYXRoLm1heCgwLCBwICsgaSAtIDEpKVswXTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvZm9ybWF0Um91bmRlZC5qcwpmdW5jdGlvbiBmb3JtYXRSb3VuZGVkX2RlZmF1bHQoeDIsIHApIHsKICB2YXIgZCA9IGZvcm1hdERlY2ltYWxQYXJ0cyh4MiwgcCk7CiAgaWYgKCFkKSByZXR1cm4geDIgKyAiIjsKICB2YXIgY29lZmZpY2llbnQgPSBkWzBdLCBleHBvbmVudCA9IGRbMV07CiAgcmV0dXJuIGV4cG9uZW50IDwgMCA/ICIwLiIgKyBuZXcgQXJyYXkoLWV4cG9uZW50KS5qb2luKCIwIikgKyBjb2VmZmljaWVudCA6IGNvZWZmaWNpZW50Lmxlbmd0aCA+IGV4cG9uZW50ICsgMSA/IGNvZWZmaWNpZW50LnNsaWNlKDAsIGV4cG9uZW50ICsgMSkgKyAiLiIgKyBjb2VmZmljaWVudC5zbGljZShleHBvbmVudCArIDEpIDogY29lZmZpY2llbnQgKyBuZXcgQXJyYXkoZXhwb25lbnQgLSBjb2VmZmljaWVudC5sZW5ndGggKyAyKS5qb2luKCIwIik7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdFR5cGVzLmpzCnZhciBmb3JtYXRUeXBlc19kZWZhdWx0ID0gewogICIlIjogKHgyLCBwKSA9PiAoeDIgKiAxMDApLnRvRml4ZWQocCksCiAgImIiOiAoeDIpID0+IE1hdGgucm91bmQoeDIpLnRvU3RyaW5nKDIpLAogICJjIjogKHgyKSA9PiB4MiArICIiLAogICJkIjogZm9ybWF0RGVjaW1hbF9kZWZhdWx0LAogICJlIjogKHgyLCBwKSA9PiB4Mi50b0V4cG9uZW50aWFsKHApLAogICJmIjogKHgyLCBwKSA9PiB4Mi50b0ZpeGVkKHApLAogICJnIjogKHgyLCBwKSA9PiB4Mi50b1ByZWNpc2lvbihwKSwKICAibyI6ICh4MikgPT4gTWF0aC5yb3VuZCh4MikudG9TdHJpbmcoOCksCiAgInAiOiAoeDIsIHApID0+IGZvcm1hdFJvdW5kZWRfZGVmYXVsdCh4MiAqIDEwMCwgcCksCiAgInIiOiBmb3JtYXRSb3VuZGVkX2RlZmF1bHQsCiAgInMiOiBmb3JtYXRQcmVmaXhBdXRvX2RlZmF1bHQsCiAgIlgiOiAoeDIpID0+IE1hdGgucm91bmQoeDIpLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpLAogICJ4IjogKHgyKSA9PiBNYXRoLnJvdW5kKHgyKS50b1N0cmluZygxNikKfTsKCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2lkZW50aXR5LmpzCmZ1bmN0aW9uIGlkZW50aXR5X2RlZmF1bHQoeDIpIHsKICByZXR1cm4geDI7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2xvY2FsZS5qcwp2YXIgbWFwID0gQXJyYXkucHJvdG90eXBlLm1hcDsKdmFyIHByZWZpeGVzID0gWyJ5IiwgInoiLCAiYSIsICJmIiwgInAiLCAibiIsICJceEI1IiwgIm0iLCAiIiwgImsiLCAiTSIsICJHIiwgIlQiLCAiUCIsICJFIiwgIloiLCAiWSJdOwpmdW5jdGlvbiBsb2NhbGVfZGVmYXVsdChsb2NhbGUzKSB7CiAgdmFyIGdyb3VwID0gbG9jYWxlMy5ncm91cGluZyA9PT0gdm9pZCAwIHx8IGxvY2FsZTMudGhvdXNhbmRzID09PSB2b2lkIDAgPyBpZGVudGl0eV9kZWZhdWx0IDogZm9ybWF0R3JvdXBfZGVmYXVsdChtYXAuY2FsbChsb2NhbGUzLmdyb3VwaW5nLCBOdW1iZXIpLCBsb2NhbGUzLnRob3VzYW5kcyArICIiKSwgY3VycmVuY3lQcmVmaXggPSBsb2NhbGUzLmN1cnJlbmN5ID09PSB2b2lkIDAgPyAiIiA6IGxvY2FsZTMuY3VycmVuY3lbMF0gKyAiIiwgY3VycmVuY3lTdWZmaXggPSBsb2NhbGUzLmN1cnJlbmN5ID09PSB2b2lkIDAgPyAiIiA6IGxvY2FsZTMuY3VycmVuY3lbMV0gKyAiIiwgZGVjaW1hbCA9IGxvY2FsZTMuZGVjaW1hbCA9PT0gdm9pZCAwID8gIi4iIDogbG9jYWxlMy5kZWNpbWFsICsgIiIsIG51bWVyYWxzID0gbG9jYWxlMy5udW1lcmFscyA9PT0gdm9pZCAwID8gaWRlbnRpdHlfZGVmYXVsdCA6IGZvcm1hdE51bWVyYWxzX2RlZmF1bHQobWFwLmNhbGwobG9jYWxlMy5udW1lcmFscywgU3RyaW5nKSksIHBlcmNlbnQgPSBsb2NhbGUzLnBlcmNlbnQgPT09IHZvaWQgMCA/ICIlIiA6IGxvY2FsZTMucGVyY2VudCArICIiLCBtaW51cyA9IGxvY2FsZTMubWludXMgPT09IHZvaWQgMCA/ICJcdTIyMTIiIDogbG9jYWxlMy5taW51cyArICIiLCBuYW4gPSBsb2NhbGUzLm5hbiA9PT0gdm9pZCAwID8gIk5hTiIgOiBsb2NhbGUzLm5hbiArICIiOwogIGZ1bmN0aW9uIG5ld0Zvcm1hdChzcGVjaWZpZXIpIHsKICAgIHNwZWNpZmllciA9IGZvcm1hdFNwZWNpZmllcihzcGVjaWZpZXIpOwogICAgdmFyIGZpbGwgPSBzcGVjaWZpZXIuZmlsbCwgYWxpZ24gPSBzcGVjaWZpZXIuYWxpZ24sIHNpZ24yID0gc3BlY2lmaWVyLnNpZ24sIHN5bWJvbCA9IHNwZWNpZmllci5zeW1ib2wsIHplcm8zID0gc3BlY2lmaWVyLnplcm8sIHdpZHRoID0gc3BlY2lmaWVyLndpZHRoLCBjb21tYSA9IHNwZWNpZmllci5jb21tYSwgcHJlY2lzaW9uID0gc3BlY2lmaWVyLnByZWNpc2lvbiwgdHJpbSA9IHNwZWNpZmllci50cmltLCB0eXBlID0gc3BlY2lmaWVyLnR5cGU7CiAgICBpZiAodHlwZSA9PT0gIm4iKSBjb21tYSA9IHRydWUsIHR5cGUgPSAiZyI7CiAgICBlbHNlIGlmICghZm9ybWF0VHlwZXNfZGVmYXVsdFt0eXBlXSkgcHJlY2lzaW9uID09PSB2b2lkIDAgJiYgKHByZWNpc2lvbiA9IDEyKSwgdHJpbSA9IHRydWUsIHR5cGUgPSAiZyI7CiAgICBpZiAoemVybzMgfHwgZmlsbCA9PT0gIjAiICYmIGFsaWduID09PSAiPSIpIHplcm8zID0gdHJ1ZSwgZmlsbCA9ICIwIiwgYWxpZ24gPSAiPSI7CiAgICB2YXIgcHJlZml4ID0gc3ltYm9sID09PSAiJCIgPyBjdXJyZW5jeVByZWZpeCA6IHN5bWJvbCA9PT0gIiMiICYmIC9bYm94WF0vLnRlc3QodHlwZSkgPyAiMCIgKyB0eXBlLnRvTG93ZXJDYXNlKCkgOiAiIiwgc3VmZml4MiA9IHN5bWJvbCA9PT0gIiQiID8gY3VycmVuY3lTdWZmaXggOiAvWyVwXS8udGVzdCh0eXBlKSA/IHBlcmNlbnQgOiAiIjsKICAgIHZhciBmb3JtYXRUeXBlID0gZm9ybWF0VHlwZXNfZGVmYXVsdFt0eXBlXSwgbWF5YmVTdWZmaXggPSAvW2RlZmdwcnMlXS8udGVzdCh0eXBlKTsKICAgIHByZWNpc2lvbiA9IHByZWNpc2lvbiA9PT0gdm9pZCAwID8gNiA6IC9bZ3Byc10vLnRlc3QodHlwZSkgPyBNYXRoLm1heCgxLCBNYXRoLm1pbigyMSwgcHJlY2lzaW9uKSkgOiBNYXRoLm1heCgwLCBNYXRoLm1pbigyMCwgcHJlY2lzaW9uKSk7CiAgICBmdW5jdGlvbiBmb3JtYXQyKHZhbHVlKSB7CiAgICAgIHZhciB2YWx1ZVByZWZpeCA9IHByZWZpeCwgdmFsdWVTdWZmaXggPSBzdWZmaXgyLCBpLCBuLCBjOwogICAgICBpZiAodHlwZSA9PT0gImMiKSB7CiAgICAgICAgdmFsdWVTdWZmaXggPSBmb3JtYXRUeXBlKHZhbHVlKSArIHZhbHVlU3VmZml4OwogICAgICAgIHZhbHVlID0gIiI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFsdWUgPSArdmFsdWU7CiAgICAgICAgdmFyIHZhbHVlTmVnYXRpdmUgPSB2YWx1ZSA8IDAgfHwgMSAvIHZhbHVlIDwgMDsKICAgICAgICB2YWx1ZSA9IGlzTmFOKHZhbHVlKSA/IG5hbiA6IGZvcm1hdFR5cGUoTWF0aC5hYnModmFsdWUpLCBwcmVjaXNpb24pOwogICAgICAgIGlmICh0cmltKSB2YWx1ZSA9IGZvcm1hdFRyaW1fZGVmYXVsdCh2YWx1ZSk7CiAgICAgICAgaWYgKHZhbHVlTmVnYXRpdmUgJiYgK3ZhbHVlID09PSAwICYmIHNpZ24yICE9PSAiKyIpIHZhbHVlTmVnYXRpdmUgPSBmYWxzZTsKICAgICAgICB2YWx1ZVByZWZpeCA9ICh2YWx1ZU5lZ2F0aXZlID8gc2lnbjIgPT09ICIoIiA/IHNpZ24yIDogbWludXMgOiBzaWduMiA9PT0gIi0iIHx8IHNpZ24yID09PSAiKCIgPyAiIiA6IHNpZ24yKSArIHZhbHVlUHJlZml4OwogICAgICAgIHZhbHVlU3VmZml4ID0gKHR5cGUgPT09ICJzIiA/IHByZWZpeGVzWzggKyBwcmVmaXhFeHBvbmVudCAvIDNdIDogIiIpICsgdmFsdWVTdWZmaXggKyAodmFsdWVOZWdhdGl2ZSAmJiBzaWduMiA9PT0gIigiID8gIikiIDogIiIpOwogICAgICAgIGlmIChtYXliZVN1ZmZpeCkgewogICAgICAgICAgaSA9IC0xLCBuID0gdmFsdWUubGVuZ3RoOwogICAgICAgICAgd2hpbGUgKCsraSA8IG4pIHsKICAgICAgICAgICAgaWYgKGMgPSB2YWx1ZS5jaGFyQ29kZUF0KGkpLCA0OCA+IGMgfHwgYyA+IDU3KSB7CiAgICAgICAgICAgICAgdmFsdWVTdWZmaXggPSAoYyA9PT0gNDYgPyBkZWNpbWFsICsgdmFsdWUuc2xpY2UoaSArIDEpIDogdmFsdWUuc2xpY2UoaSkpICsgdmFsdWVTdWZmaXg7CiAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5zbGljZSgwLCBpKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoY29tbWEgJiYgIXplcm8zKSB2YWx1ZSA9IGdyb3VwKHZhbHVlLCBJbmZpbml0eSk7CiAgICAgIHZhciBsZW5ndGggPSB2YWx1ZVByZWZpeC5sZW5ndGggKyB2YWx1ZS5sZW5ndGggKyB2YWx1ZVN1ZmZpeC5sZW5ndGgsIHBhZGRpbmcgPSBsZW5ndGggPCB3aWR0aCA/IG5ldyBBcnJheSh3aWR0aCAtIGxlbmd0aCArIDEpLmpvaW4oZmlsbCkgOiAiIjsKICAgICAgaWYgKGNvbW1hICYmIHplcm8zKSB2YWx1ZSA9IGdyb3VwKHBhZGRpbmcgKyB2YWx1ZSwgcGFkZGluZy5sZW5ndGggPyB3aWR0aCAtIHZhbHVlU3VmZml4Lmxlbmd0aCA6IEluZmluaXR5KSwgcGFkZGluZyA9ICIiOwogICAgICBzd2l0Y2ggKGFsaWduKSB7CiAgICAgICAgY2FzZSAiPCI6CiAgICAgICAgICB2YWx1ZSA9IHZhbHVlUHJlZml4ICsgdmFsdWUgKyB2YWx1ZVN1ZmZpeCArIHBhZGRpbmc7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICI9IjoKICAgICAgICAgIHZhbHVlID0gdmFsdWVQcmVmaXggKyBwYWRkaW5nICsgdmFsdWUgKyB2YWx1ZVN1ZmZpeDsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIl4iOgogICAgICAgICAgdmFsdWUgPSBwYWRkaW5nLnNsaWNlKDAsIGxlbmd0aCA9IHBhZGRpbmcubGVuZ3RoID4+IDEpICsgdmFsdWVQcmVmaXggKyB2YWx1ZSArIHZhbHVlU3VmZml4ICsgcGFkZGluZy5zbGljZShsZW5ndGgpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHZhbHVlID0gcGFkZGluZyArIHZhbHVlUHJlZml4ICsgdmFsdWUgKyB2YWx1ZVN1ZmZpeDsKICAgICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHJldHVybiBudW1lcmFscyh2YWx1ZSk7CiAgICB9CiAgICBmb3JtYXQyLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBzcGVjaWZpZXIgKyAiIjsKICAgIH07CiAgICByZXR1cm4gZm9ybWF0MjsKICB9CiAgZnVuY3Rpb24gZm9ybWF0UHJlZml4MihzcGVjaWZpZXIsIHZhbHVlKSB7CiAgICB2YXIgZiA9IG5ld0Zvcm1hdCgoc3BlY2lmaWVyID0gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllciksIHNwZWNpZmllci50eXBlID0gImYiLCBzcGVjaWZpZXIpKSwgZSA9IE1hdGgubWF4KC04LCBNYXRoLm1pbig4LCBNYXRoLmZsb29yKGV4cG9uZW50X2RlZmF1bHQodmFsdWUpIC8gMykpKSAqIDMsIGsgPSBNYXRoLnBvdygxMCwgLWUpLCBwcmVmaXggPSBwcmVmaXhlc1s4ICsgZSAvIDNdOwogICAgcmV0dXJuIGZ1bmN0aW9uKHZhbHVlMikgewogICAgICByZXR1cm4gZihrICogdmFsdWUyKSArIHByZWZpeDsKICAgIH07CiAgfQogIHJldHVybiB7CiAgICBmb3JtYXQ6IG5ld0Zvcm1hdCwKICAgIGZvcm1hdFByZWZpeDogZm9ybWF0UHJlZml4MgogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2RlZmF1bHRMb2NhbGUuanMKdmFyIGxvY2FsZTsKdmFyIGZvcm1hdDsKdmFyIGZvcm1hdFByZWZpeDsKZGVmYXVsdExvY2FsZSh7CiAgdGhvdXNhbmRzOiAiLCIsCiAgZ3JvdXBpbmc6IFszXSwKICBjdXJyZW5jeTogWyIkIiwgIiJdCn0pOwpmdW5jdGlvbiBkZWZhdWx0TG9jYWxlKGRlZmluaXRpb24pIHsKICBsb2NhbGUgPSBsb2NhbGVfZGVmYXVsdChkZWZpbml0aW9uKTsKICBmb3JtYXQgPSBsb2NhbGUuZm9ybWF0OwogIGZvcm1hdFByZWZpeCA9IGxvY2FsZS5mb3JtYXRQcmVmaXg7CiAgcmV0dXJuIGxvY2FsZTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvcHJlY2lzaW9uRml4ZWQuanMKZnVuY3Rpb24gcHJlY2lzaW9uRml4ZWRfZGVmYXVsdChzdGVwKSB7CiAgcmV0dXJuIE1hdGgubWF4KDAsIC1leHBvbmVudF9kZWZhdWx0KE1hdGguYWJzKHN0ZXApKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL3ByZWNpc2lvblByZWZpeC5qcwpmdW5jdGlvbiBwcmVjaXNpb25QcmVmaXhfZGVmYXVsdChzdGVwLCB2YWx1ZSkgewogIHJldHVybiBNYXRoLm1heCgwLCBNYXRoLm1heCgtOCwgTWF0aC5taW4oOCwgTWF0aC5mbG9vcihleHBvbmVudF9kZWZhdWx0KHZhbHVlKSAvIDMpKSkgKiAzIC0gZXhwb25lbnRfZGVmYXVsdChNYXRoLmFicyhzdGVwKSkpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9wcmVjaXNpb25Sb3VuZC5qcwpmdW5jdGlvbiBwcmVjaXNpb25Sb3VuZF9kZWZhdWx0KHN0ZXAsIG1heDIpIHsKICBzdGVwID0gTWF0aC5hYnMoc3RlcCksIG1heDIgPSBNYXRoLmFicyhtYXgyKSAtIHN0ZXA7CiAgcmV0dXJuIE1hdGgubWF4KDAsIGV4cG9uZW50X2RlZmF1bHQobWF4MikgLSBleHBvbmVudF9kZWZhdWx0KHN0ZXApKSArIDE7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvdGlja0Zvcm1hdC5qcwpmdW5jdGlvbiB0aWNrRm9ybWF0KHN0YXJ0LCBzdG9wLCBjb3VudCwgc3BlY2lmaWVyKSB7CiAgdmFyIHN0ZXAgPSB0aWNrU3RlcChzdGFydCwgc3RvcCwgY291bnQpLCBwcmVjaXNpb247CiAgc3BlY2lmaWVyID0gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllciA9PSBudWxsID8gIixmIiA6IHNwZWNpZmllcik7CiAgc3dpdGNoIChzcGVjaWZpZXIudHlwZSkgewogICAgY2FzZSAicyI6IHsKICAgICAgdmFyIHZhbHVlID0gTWF0aC5tYXgoTWF0aC5hYnMoc3RhcnQpLCBNYXRoLmFicyhzdG9wKSk7CiAgICAgIGlmIChzcGVjaWZpZXIucHJlY2lzaW9uID09IG51bGwgJiYgIWlzTmFOKHByZWNpc2lvbiA9IHByZWNpc2lvblByZWZpeF9kZWZhdWx0KHN0ZXAsIHZhbHVlKSkpIHNwZWNpZmllci5wcmVjaXNpb24gPSBwcmVjaXNpb247CiAgICAgIHJldHVybiBmb3JtYXRQcmVmaXgoc3BlY2lmaWVyLCB2YWx1ZSk7CiAgICB9CiAgICBjYXNlICIiOgogICAgY2FzZSAiZSI6CiAgICBjYXNlICJnIjoKICAgIGNhc2UgInAiOgogICAgY2FzZSAiciI6IHsKICAgICAgaWYgKHNwZWNpZmllci5wcmVjaXNpb24gPT0gbnVsbCAmJiAhaXNOYU4ocHJlY2lzaW9uID0gcHJlY2lzaW9uUm91bmRfZGVmYXVsdChzdGVwLCBNYXRoLm1heChNYXRoLmFicyhzdGFydCksIE1hdGguYWJzKHN0b3ApKSkpKSBzcGVjaWZpZXIucHJlY2lzaW9uID0gcHJlY2lzaW9uIC0gKHNwZWNpZmllci50eXBlID09PSAiZSIpOwogICAgICBicmVhazsKICAgIH0KICAgIGNhc2UgImYiOgogICAgY2FzZSAiJSI6IHsKICAgICAgaWYgKHNwZWNpZmllci5wcmVjaXNpb24gPT0gbnVsbCAmJiAhaXNOYU4ocHJlY2lzaW9uID0gcHJlY2lzaW9uRml4ZWRfZGVmYXVsdChzdGVwKSkpIHNwZWNpZmllci5wcmVjaXNpb24gPSBwcmVjaXNpb24gLSAoc3BlY2lmaWVyLnR5cGUgPT09ICIlIikgKiAyOwogICAgICBicmVhazsKICAgIH0KICB9CiAgcmV0dXJuIGZvcm1hdChzcGVjaWZpZXIpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2xpbmVhci5qcwpmdW5jdGlvbiBsaW5lYXJpc2goc2NhbGUpIHsKICB2YXIgZG9tYWluID0gc2NhbGUuZG9tYWluOwogIHNjYWxlLnRpY2tzID0gZnVuY3Rpb24oY291bnQpIHsKICAgIHZhciBkID0gZG9tYWluKCk7CiAgICByZXR1cm4gdGlja3MoZFswXSwgZFtkLmxlbmd0aCAtIDFdLCBjb3VudCA9PSBudWxsID8gMTAgOiBjb3VudCk7CiAgfTsKICBzY2FsZS50aWNrRm9ybWF0ID0gZnVuY3Rpb24oY291bnQsIHNwZWNpZmllcikgewogICAgdmFyIGQgPSBkb21haW4oKTsKICAgIHJldHVybiB0aWNrRm9ybWF0KGRbMF0sIGRbZC5sZW5ndGggLSAxXSwgY291bnQgPT0gbnVsbCA/IDEwIDogY291bnQsIHNwZWNpZmllcik7CiAgfTsKICBzY2FsZS5uaWNlID0gZnVuY3Rpb24oY291bnQpIHsKICAgIGlmIChjb3VudCA9PSBudWxsKSBjb3VudCA9IDEwOwogICAgdmFyIGQgPSBkb21haW4oKTsKICAgIHZhciBpMCA9IDA7CiAgICB2YXIgaTEgPSBkLmxlbmd0aCAtIDE7CiAgICB2YXIgc3RhcnQgPSBkW2kwXTsKICAgIHZhciBzdG9wID0gZFtpMV07CiAgICB2YXIgcHJlc3RlcDsKICAgIHZhciBzdGVwOwogICAgdmFyIG1heEl0ZXIgPSAxMDsKICAgIGlmIChzdG9wIDwgc3RhcnQpIHsKICAgICAgc3RlcCA9IHN0YXJ0LCBzdGFydCA9IHN0b3AsIHN0b3AgPSBzdGVwOwogICAgICBzdGVwID0gaTAsIGkwID0gaTEsIGkxID0gc3RlcDsKICAgIH0KICAgIHdoaWxlIChtYXhJdGVyLS0gPiAwKSB7CiAgICAgIHN0ZXAgPSB0aWNrSW5jcmVtZW50KHN0YXJ0LCBzdG9wLCBjb3VudCk7CiAgICAgIGlmIChzdGVwID09PSBwcmVzdGVwKSB7CiAgICAgICAgZFtpMF0gPSBzdGFydDsKICAgICAgICBkW2kxXSA9IHN0b3A7CiAgICAgICAgcmV0dXJuIGRvbWFpbihkKTsKICAgICAgfSBlbHNlIGlmIChzdGVwID4gMCkgewogICAgICAgIHN0YXJ0ID0gTWF0aC5mbG9vcihzdGFydCAvIHN0ZXApICogc3RlcDsKICAgICAgICBzdG9wID0gTWF0aC5jZWlsKHN0b3AgLyBzdGVwKSAqIHN0ZXA7CiAgICAgIH0gZWxzZSBpZiAoc3RlcCA8IDApIHsKICAgICAgICBzdGFydCA9IE1hdGguY2VpbChzdGFydCAqIHN0ZXApIC8gc3RlcDsKICAgICAgICBzdG9wID0gTWF0aC5mbG9vcihzdG9wICogc3RlcCkgLyBzdGVwOwogICAgICB9IGVsc2UgewogICAgICAgIGJyZWFrOwogICAgICB9CiAgICAgIHByZXN0ZXAgPSBzdGVwOwogICAgfQogICAgcmV0dXJuIHNjYWxlOwogIH07CiAgcmV0dXJuIHNjYWxlOwp9CmZ1bmN0aW9uIGxpbmVhcjIoKSB7CiAgdmFyIHNjYWxlID0gY29udGludW91cygpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5KHNjYWxlLCBsaW5lYXIyKCkpOwogIH07CiAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwogIHJldHVybiBsaW5lYXJpc2goc2NhbGUpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2lkZW50aXR5LmpzCmZ1bmN0aW9uIGlkZW50aXR5Mihkb21haW4pIHsKICB2YXIgdW5rbm93bjsKICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgcmV0dXJuIHgyID09IG51bGwgfHwgaXNOYU4oeDIgPSAreDIpID8gdW5rbm93biA6IHgyOwogIH0KICBzY2FsZS5pbnZlcnQgPSBzY2FsZTsKICBzY2FsZS5kb21haW4gPSBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRvbWFpbiA9IEFycmF5LmZyb20oXywgbnVtYmVyMiksIHNjYWxlKSA6IGRvbWFpbi5zbGljZSgpOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGlkZW50aXR5Mihkb21haW4pLnVua25vd24odW5rbm93bik7CiAgfTsKICBkb21haW4gPSBhcmd1bWVudHMubGVuZ3RoID8gQXJyYXkuZnJvbShkb21haW4sIG51bWJlcjIpIDogWzAsIDFdOwogIHJldHVybiBsaW5lYXJpc2goc2NhbGUpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL25pY2UuanMKZnVuY3Rpb24gbmljZShkb21haW4sIGludGVydmFsKSB7CiAgZG9tYWluID0gZG9tYWluLnNsaWNlKCk7CiAgdmFyIGkwID0gMCwgaTEgPSBkb21haW4ubGVuZ3RoIC0gMSwgeDAgPSBkb21haW5baTBdLCB4MSA9IGRvbWFpbltpMV0sIHQ7CiAgaWYgKHgxIDwgeDApIHsKICAgIHQgPSBpMCwgaTAgPSBpMSwgaTEgPSB0OwogICAgdCA9IHgwLCB4MCA9IHgxLCB4MSA9IHQ7CiAgfQogIGRvbWFpbltpMF0gPSBpbnRlcnZhbC5mbG9vcih4MCk7CiAgZG9tYWluW2kxXSA9IGludGVydmFsLmNlaWwoeDEpOwogIHJldHVybiBkb21haW47Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvbG9nLmpzCmZ1bmN0aW9uIHRyYW5zZm9ybUxvZyh4MikgewogIHJldHVybiBNYXRoLmxvZyh4Mik7Cn0KZnVuY3Rpb24gdHJhbnNmb3JtRXhwKHgyKSB7CiAgcmV0dXJuIE1hdGguZXhwKHgyKTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1Mb2duKHgyKSB7CiAgcmV0dXJuIC1NYXRoLmxvZygteDIpOwp9CmZ1bmN0aW9uIHRyYW5zZm9ybUV4cG4oeDIpIHsKICByZXR1cm4gLU1hdGguZXhwKC14Mik7Cn0KZnVuY3Rpb24gcG93MTAoeDIpIHsKICByZXR1cm4gaXNGaW5pdGUoeDIpID8gKygiMWUiICsgeDIpIDogeDIgPCAwID8gMCA6IHgyOwp9CmZ1bmN0aW9uIHBvd3AoYmFzZSkgewogIHJldHVybiBiYXNlID09PSAxMCA/IHBvdzEwIDogYmFzZSA9PT0gTWF0aC5FID8gTWF0aC5leHAgOiAoeDIpID0+IE1hdGgucG93KGJhc2UsIHgyKTsKfQpmdW5jdGlvbiBsb2dwKGJhc2UpIHsKICByZXR1cm4gYmFzZSA9PT0gTWF0aC5FID8gTWF0aC5sb2cgOiBiYXNlID09PSAxMCAmJiBNYXRoLmxvZzEwIHx8IGJhc2UgPT09IDIgJiYgTWF0aC5sb2cyIHx8IChiYXNlID0gTWF0aC5sb2coYmFzZSksICh4MikgPT4gTWF0aC5sb2coeDIpIC8gYmFzZSk7Cn0KZnVuY3Rpb24gcmVmbGVjdChmKSB7CiAgcmV0dXJuICh4MiwgaykgPT4gLWYoLXgyLCBrKTsKfQpmdW5jdGlvbiBsb2dnaXNoKHRyYW5zZm9ybSkgewogIGNvbnN0IHNjYWxlID0gdHJhbnNmb3JtKHRyYW5zZm9ybUxvZywgdHJhbnNmb3JtRXhwKTsKICBjb25zdCBkb21haW4gPSBzY2FsZS5kb21haW47CiAgbGV0IGJhc2UgPSAxMDsKICBsZXQgbG9nczsKICBsZXQgcG93czsKICBmdW5jdGlvbiByZXNjYWxlKCkgewogICAgbG9ncyA9IGxvZ3AoYmFzZSksIHBvd3MgPSBwb3dwKGJhc2UpOwogICAgaWYgKGRvbWFpbigpWzBdIDwgMCkgewogICAgICBsb2dzID0gcmVmbGVjdChsb2dzKSwgcG93cyA9IHJlZmxlY3QocG93cyk7CiAgICAgIHRyYW5zZm9ybSh0cmFuc2Zvcm1Mb2duLCB0cmFuc2Zvcm1FeHBuKTsKICAgIH0gZWxzZSB7CiAgICAgIHRyYW5zZm9ybSh0cmFuc2Zvcm1Mb2csIHRyYW5zZm9ybUV4cCk7CiAgICB9CiAgICByZXR1cm4gc2NhbGU7CiAgfQogIHNjYWxlLmJhc2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChiYXNlID0gK18sIHJlc2NhbGUoKSkgOiBiYXNlOwogIH07CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZG9tYWluKF8pLCByZXNjYWxlKCkpIDogZG9tYWluKCk7CiAgfTsKICBzY2FsZS50aWNrcyA9IChjb3VudCkgPT4gewogICAgY29uc3QgZCA9IGRvbWFpbigpOwogICAgbGV0IHUgPSBkWzBdOwogICAgbGV0IHYgPSBkW2QubGVuZ3RoIC0gMV07CiAgICBjb25zdCByMiA9IHYgPCB1OwogICAgaWYgKHIyKSBbdSwgdl0gPSBbdiwgdV07CiAgICBsZXQgaSA9IGxvZ3ModSk7CiAgICBsZXQgaiA9IGxvZ3Modik7CiAgICBsZXQgazsKICAgIGxldCB0OwogICAgY29uc3QgbiA9IGNvdW50ID09IG51bGwgPyAxMCA6ICtjb3VudDsKICAgIGxldCB6ID0gW107CiAgICBpZiAoIShiYXNlICUgMSkgJiYgaiAtIGkgPCBuKSB7CiAgICAgIGkgPSBNYXRoLmZsb29yKGkpLCBqID0gTWF0aC5jZWlsKGopOwogICAgICBpZiAodSA+IDApIGZvciAoOyBpIDw9IGo7ICsraSkgewogICAgICAgIGZvciAoayA9IDE7IGsgPCBiYXNlOyArK2spIHsKICAgICAgICAgIHQgPSBpIDwgMCA/IGsgLyBwb3dzKC1pKSA6IGsgKiBwb3dzKGkpOwogICAgICAgICAgaWYgKHQgPCB1KSBjb250aW51ZTsKICAgICAgICAgIGlmICh0ID4gdikgYnJlYWs7CiAgICAgICAgICB6LnB1c2godCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGVsc2UgZm9yICg7IGkgPD0gajsgKytpKSB7CiAgICAgICAgZm9yIChrID0gYmFzZSAtIDE7IGsgPj0gMTsgLS1rKSB7CiAgICAgICAgICB0ID0gaSA+IDAgPyBrIC8gcG93cygtaSkgOiBrICogcG93cyhpKTsKICAgICAgICAgIGlmICh0IDwgdSkgY29udGludWU7CiAgICAgICAgICBpZiAodCA+IHYpIGJyZWFrOwogICAgICAgICAgei5wdXNoKHQpOwogICAgICAgIH0KICAgICAgfQogICAgICBpZiAoei5sZW5ndGggKiAyIDwgbikgeiA9IHRpY2tzKHUsIHYsIG4pOwogICAgfSBlbHNlIHsKICAgICAgeiA9IHRpY2tzKGksIGosIE1hdGgubWluKGogLSBpLCBuKSkubWFwKHBvd3MpOwogICAgfQogICAgcmV0dXJuIHIyID8gei5yZXZlcnNlKCkgOiB6OwogIH07CiAgc2NhbGUudGlja0Zvcm1hdCA9IChjb3VudCwgc3BlY2lmaWVyKSA9PiB7CiAgICBpZiAoY291bnQgPT0gbnVsbCkgY291bnQgPSAxMDsKICAgIGlmIChzcGVjaWZpZXIgPT0gbnVsbCkgc3BlY2lmaWVyID0gYmFzZSA9PT0gMTAgPyAicyIgOiAiLCI7CiAgICBpZiAodHlwZW9mIHNwZWNpZmllciAhPT0gImZ1bmN0aW9uIikgewogICAgICBpZiAoIShiYXNlICUgMSkgJiYgKHNwZWNpZmllciA9IGZvcm1hdFNwZWNpZmllcihzcGVjaWZpZXIpKS5wcmVjaXNpb24gPT0gbnVsbCkgc3BlY2lmaWVyLnRyaW0gPSB0cnVlOwogICAgICBzcGVjaWZpZXIgPSBmb3JtYXQoc3BlY2lmaWVyKTsKICAgIH0KICAgIGlmIChjb3VudCA9PT0gSW5maW5pdHkpIHJldHVybiBzcGVjaWZpZXI7CiAgICBjb25zdCBrID0gTWF0aC5tYXgoMSwgYmFzZSAqIGNvdW50IC8gc2NhbGUudGlja3MoKS5sZW5ndGgpOwogICAgcmV0dXJuIChkKSA9PiB7CiAgICAgIGxldCBpID0gZCAvIHBvd3MoTWF0aC5yb3VuZChsb2dzKGQpKSk7CiAgICAgIGlmIChpICogYmFzZSA8IGJhc2UgLSAwLjUpIGkgKj0gYmFzZTsKICAgICAgcmV0dXJuIGkgPD0gayA/IHNwZWNpZmllcihkKSA6ICIiOwogICAgfTsKICB9OwogIHNjYWxlLm5pY2UgPSAoKSA9PiB7CiAgICByZXR1cm4gZG9tYWluKG5pY2UoZG9tYWluKCksIHsKICAgICAgZmxvb3I6ICh4MikgPT4gcG93cyhNYXRoLmZsb29yKGxvZ3MoeDIpKSksCiAgICAgIGNlaWw6ICh4MikgPT4gcG93cyhNYXRoLmNlaWwobG9ncyh4MikpKQogICAgfSkpOwogIH07CiAgcmV0dXJuIHNjYWxlOwp9CmZ1bmN0aW9uIGxvZygpIHsKICBjb25zdCBzY2FsZSA9IGxvZ2dpc2godHJhbnNmb3JtZXIoKSkuZG9tYWluKFsxLCAxMF0pOwogIHNjYWxlLmNvcHkgPSAoKSA9PiBjb3B5KHNjYWxlLCBsb2coKSkuYmFzZShzY2FsZS5iYXNlKCkpOwogIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKICByZXR1cm4gc2NhbGU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvc3ltbG9nLmpzCmZ1bmN0aW9uIHRyYW5zZm9ybVN5bWxvZyhjKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4gTWF0aC5zaWduKHgyKSAqIE1hdGgubG9nMXAoTWF0aC5hYnMoeDIgLyBjKSk7CiAgfTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1TeW1leHAoYykgewogIHJldHVybiBmdW5jdGlvbih4MikgewogICAgcmV0dXJuIE1hdGguc2lnbih4MikgKiBNYXRoLmV4cG0xKE1hdGguYWJzKHgyKSkgKiBjOwogIH07Cn0KZnVuY3Rpb24gc3ltbG9naXNoKHRyYW5zZm9ybSkgewogIHZhciBjID0gMSwgc2NhbGUgPSB0cmFuc2Zvcm0odHJhbnNmb3JtU3ltbG9nKGMpLCB0cmFuc2Zvcm1TeW1leHAoYykpOwogIHNjYWxlLmNvbnN0YW50ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyB0cmFuc2Zvcm0odHJhbnNmb3JtU3ltbG9nKGMgPSArXyksIHRyYW5zZm9ybVN5bWV4cChjKSkgOiBjOwogIH07CiAgcmV0dXJuIGxpbmVhcmlzaChzY2FsZSk7Cn0KZnVuY3Rpb24gc3ltbG9nKCkgewogIHZhciBzY2FsZSA9IHN5bWxvZ2lzaCh0cmFuc2Zvcm1lcigpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weShzY2FsZSwgc3ltbG9nKCkpLmNvbnN0YW50KHNjYWxlLmNvbnN0YW50KCkpOwogIH07CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9wb3cuanMKZnVuY3Rpb24gdHJhbnNmb3JtUG93KGV4cG9uZW50KSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4geDIgPCAwID8gLU1hdGgucG93KC14MiwgZXhwb25lbnQpIDogTWF0aC5wb3coeDIsIGV4cG9uZW50KTsKICB9Owp9CmZ1bmN0aW9uIHRyYW5zZm9ybVNxcnQoeDIpIHsKICByZXR1cm4geDIgPCAwID8gLU1hdGguc3FydCgteDIpIDogTWF0aC5zcXJ0KHgyKTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1TcXVhcmUoeDIpIHsKICByZXR1cm4geDIgPCAwID8gLXgyICogeDIgOiB4MiAqIHgyOwp9CmZ1bmN0aW9uIHBvd2lzaCh0cmFuc2Zvcm0pIHsKICB2YXIgc2NhbGUgPSB0cmFuc2Zvcm0oaWRlbnRpdHksIGlkZW50aXR5KSwgZXhwb25lbnQgPSAxOwogIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICByZXR1cm4gZXhwb25lbnQgPT09IDEgPyB0cmFuc2Zvcm0oaWRlbnRpdHksIGlkZW50aXR5KSA6IGV4cG9uZW50ID09PSAwLjUgPyB0cmFuc2Zvcm0odHJhbnNmb3JtU3FydCwgdHJhbnNmb3JtU3F1YXJlKSA6IHRyYW5zZm9ybSh0cmFuc2Zvcm1Qb3coZXhwb25lbnQpLCB0cmFuc2Zvcm1Qb3coMSAvIGV4cG9uZW50KSk7CiAgfQogIHNjYWxlLmV4cG9uZW50ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZXhwb25lbnQgPSArXywgcmVzY2FsZSgpKSA6IGV4cG9uZW50OwogIH07CiAgcmV0dXJuIGxpbmVhcmlzaChzY2FsZSk7Cn0KZnVuY3Rpb24gcG93KCkgewogIHZhciBzY2FsZSA9IHBvd2lzaCh0cmFuc2Zvcm1lcigpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weShzY2FsZSwgcG93KCkpLmV4cG9uZW50KHNjYWxlLmV4cG9uZW50KCkpOwogIH07CiAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwogIHJldHVybiBzY2FsZTsKfQpmdW5jdGlvbiBzcXJ0KCkgewogIHJldHVybiBwb3cuYXBwbHkobnVsbCwgYXJndW1lbnRzKS5leHBvbmVudCgwLjUpOwp9CgovLyBub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3JhZGlhbC5qcwpmdW5jdGlvbiBzcXVhcmUoeDIpIHsKICByZXR1cm4gTWF0aC5zaWduKHgyKSAqIHgyICogeDI7Cn0KZnVuY3Rpb24gdW5zcXVhcmUoeDIpIHsKICByZXR1cm4gTWF0aC5zaWduKHgyKSAqIE1hdGguc3FydChNYXRoLmFicyh4MikpOwp9CmZ1bmN0aW9uIHJhZGlhbCgpIHsKICB2YXIgc3F1YXJlZCA9IGNvbnRpbnVvdXMoKSwgcmFuZ2U0ID0gWzAsIDFdLCByb3VuZCA9IGZhbHNlLCB1bmtub3duOwogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICB2YXIgeTIgPSB1bnNxdWFyZShzcXVhcmVkKHgyKSk7CiAgICByZXR1cm4gaXNOYU4oeTIpID8gdW5rbm93biA6IHJvdW5kID8gTWF0aC5yb3VuZCh5MikgOiB5MjsKICB9CiAgc2NhbGUuaW52ZXJ0ID0gZnVuY3Rpb24oeTIpIHsKICAgIHJldHVybiBzcXVhcmVkLmludmVydChzcXVhcmUoeTIpKTsKICB9OwogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHNxdWFyZWQuZG9tYWluKF8pLCBzY2FsZSkgOiBzcXVhcmVkLmRvbWFpbigpOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChzcXVhcmVkLnJhbmdlKChyYW5nZTQgPSBBcnJheS5mcm9tKF8sIG51bWJlcjIpKS5tYXAoc3F1YXJlKSksIHNjYWxlKSA6IHJhbmdlNC5zbGljZSgpOwogIH07CiAgc2NhbGUucmFuZ2VSb3VuZCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBzY2FsZS5yYW5nZShfKS5yb3VuZCh0cnVlKTsKICB9OwogIHNjYWxlLnJvdW5kID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocm91bmQgPSAhIV8sIHNjYWxlKSA6IHJvdW5kOwogIH07CiAgc2NhbGUuY2xhbXAgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChzcXVhcmVkLmNsYW1wKF8pLCBzY2FsZSkgOiBzcXVhcmVkLmNsYW1wKCk7CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gcmFkaWFsKHNxdWFyZWQuZG9tYWluKCksIHJhbmdlNCkucm91bmQocm91bmQpLmNsYW1wKHNxdWFyZWQuY2xhbXAoKSkudW5rbm93bih1bmtub3duKTsKICB9OwogIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKICByZXR1cm4gbGluZWFyaXNoKHNjYWxlKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9xdWFudGlsZS5qcwpmdW5jdGlvbiBxdWFudGlsZTIoKSB7CiAgdmFyIGRvbWFpbiA9IFtdLCByYW5nZTQgPSBbXSwgdGhyZXNob2xkcyA9IFtdLCB1bmtub3duOwogIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICB2YXIgaSA9IDAsIG4gPSBNYXRoLm1heCgxLCByYW5nZTQubGVuZ3RoKTsKICAgIHRocmVzaG9sZHMgPSBuZXcgQXJyYXkobiAtIDEpOwogICAgd2hpbGUgKCsraSA8IG4pIHRocmVzaG9sZHNbaSAtIDFdID0gcXVhbnRpbGVTb3J0ZWQoZG9tYWluLCBpIC8gbik7CiAgICByZXR1cm4gc2NhbGU7CiAgfQogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICByZXR1cm4geDIgPT0gbnVsbCB8fCBpc05hTih4MiA9ICt4MikgPyB1bmtub3duIDogcmFuZ2U0W2Jpc2VjdF9kZWZhdWx0KHRocmVzaG9sZHMsIHgyKV07CiAgfQogIHNjYWxlLmludmVydEV4dGVudCA9IGZ1bmN0aW9uKHkyKSB7CiAgICB2YXIgaSA9IHJhbmdlNC5pbmRleE9mKHkyKTsKICAgIHJldHVybiBpIDwgMCA/IFtOYU4sIE5hTl0gOiBbCiAgICAgIGkgPiAwID8gdGhyZXNob2xkc1tpIC0gMV0gOiBkb21haW5bMF0sCiAgICAgIGkgPCB0aHJlc2hvbGRzLmxlbmd0aCA/IHRocmVzaG9sZHNbaV0gOiBkb21haW5bZG9tYWluLmxlbmd0aCAtIDFdCiAgICBdOwogIH07CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gZG9tYWluLnNsaWNlKCk7CiAgICBkb21haW4gPSBbXTsKICAgIGZvciAobGV0IGQgb2YgXykgaWYgKGQgIT0gbnVsbCAmJiAhaXNOYU4oZCA9ICtkKSkgZG9tYWluLnB1c2goZCk7CiAgICBkb21haW4uc29ydChhc2NlbmRpbmcpOwogICAgcmV0dXJuIHJlc2NhbGUoKTsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocmFuZ2U0ID0gQXJyYXkuZnJvbShfKSwgcmVzY2FsZSgpKSA6IHJhbmdlNC5zbGljZSgpOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgc2NhbGUucXVhbnRpbGVzID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhyZXNob2xkcy5zbGljZSgpOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHF1YW50aWxlMigpLmRvbWFpbihkb21haW4pLnJhbmdlKHJhbmdlNCkudW5rbm93bih1bmtub3duKTsKICB9OwogIHJldHVybiBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvcXVhbnRpemUuanMKZnVuY3Rpb24gcXVhbnRpemUoKSB7CiAgdmFyIHgwID0gMCwgeDEgPSAxLCBuID0gMSwgZG9tYWluID0gWzAuNV0sIHJhbmdlNCA9IFswLCAxXSwgdW5rbm93bjsKICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgcmV0dXJuIHgyICE9IG51bGwgJiYgeDIgPD0geDIgPyByYW5nZTRbYmlzZWN0X2RlZmF1bHQoZG9tYWluLCB4MiwgMCwgbildIDogdW5rbm93bjsKICB9CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIHZhciBpID0gLTE7CiAgICBkb21haW4gPSBuZXcgQXJyYXkobik7CiAgICB3aGlsZSAoKytpIDwgbikgZG9tYWluW2ldID0gKChpICsgMSkgKiB4MSAtIChpIC0gbikgKiB4MCkgLyAobiArIDEpOwogICAgcmV0dXJuIHNjYWxlOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbeDAsIHgxXSA9IF8sIHgwID0gK3gwLCB4MSA9ICt4MSwgcmVzY2FsZSgpKSA6IFt4MCwgeDFdOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChuID0gKHJhbmdlNCA9IEFycmF5LmZyb20oXykpLmxlbmd0aCAtIDEsIHJlc2NhbGUoKSkgOiByYW5nZTQuc2xpY2UoKTsKICB9OwogIHNjYWxlLmludmVydEV4dGVudCA9IGZ1bmN0aW9uKHkyKSB7CiAgICB2YXIgaSA9IHJhbmdlNC5pbmRleE9mKHkyKTsKICAgIHJldHVybiBpIDwgMCA/IFtOYU4sIE5hTl0gOiBpIDwgMSA/IFt4MCwgZG9tYWluWzBdXSA6IGkgPj0gbiA/IFtkb21haW5bbiAtIDFdLCB4MV0gOiBbZG9tYWluW2kgLSAxXSwgZG9tYWluW2ldXTsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogc2NhbGU7CiAgfTsKICBzY2FsZS50aHJlc2hvbGRzID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gZG9tYWluLnNsaWNlKCk7CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gcXVhbnRpemUoKS5kb21haW4oW3gwLCB4MV0pLnJhbmdlKHJhbmdlNCkudW5rbm93bih1bmtub3duKTsKICB9OwogIHJldHVybiBpbml0UmFuZ2UuYXBwbHkobGluZWFyaXNoKHNjYWxlKSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy90aHJlc2hvbGQuanMKZnVuY3Rpb24gdGhyZXNob2xkKCkgewogIHZhciBkb21haW4gPSBbMC41XSwgcmFuZ2U0ID0gWzAsIDFdLCB1bmtub3duLCBuID0gMTsKICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgcmV0dXJuIHgyICE9IG51bGwgJiYgeDIgPD0geDIgPyByYW5nZTRbYmlzZWN0X2RlZmF1bHQoZG9tYWluLCB4MiwgMCwgbildIDogdW5rbm93bjsKICB9CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZG9tYWluID0gQXJyYXkuZnJvbShfKSwgbiA9IE1hdGgubWluKGRvbWFpbi5sZW5ndGgsIHJhbmdlNC5sZW5ndGggLSAxKSwgc2NhbGUpIDogZG9tYWluLnNsaWNlKCk7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJhbmdlNCA9IEFycmF5LmZyb20oXyksIG4gPSBNYXRoLm1pbihkb21haW4ubGVuZ3RoLCByYW5nZTQubGVuZ3RoIC0gMSksIHNjYWxlKSA6IHJhbmdlNC5zbGljZSgpOwogIH07CiAgc2NhbGUuaW52ZXJ0RXh0ZW50ID0gZnVuY3Rpb24oeTIpIHsKICAgIHZhciBpID0gcmFuZ2U0LmluZGV4T2YoeTIpOwogICAgcmV0dXJuIFtkb21haW5baSAtIDFdLCBkb21haW5baV1dOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRocmVzaG9sZCgpLmRvbWFpbihkb21haW4pLnJhbmdlKHJhbmdlNCkudW5rbm93bih1bmtub3duKTsKICB9OwogIHJldHVybiBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9pbnRlcnZhbC5qcwp2YXIgdDAgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKTsKdmFyIHQxID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCk7CmZ1bmN0aW9uIHRpbWVJbnRlcnZhbChmbG9vcmksIG9mZnNldGksIGNvdW50LCBmaWVsZCkgewogIGZ1bmN0aW9uIGludGVydmFsKGRhdGUyKSB7CiAgICByZXR1cm4gZmxvb3JpKGRhdGUyID0gYXJndW1lbnRzLmxlbmd0aCA9PT0gMCA/IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpIDogLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCtkYXRlMikpLCBkYXRlMjsKICB9CiAgaW50ZXJ2YWwuZmxvb3IgPSAoZGF0ZTIpID0+IHsKICAgIHJldHVybiBmbG9vcmkoZGF0ZTIgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK2RhdGUyKSksIGRhdGUyOwogIH07CiAgaW50ZXJ2YWwuY2VpbCA9IChkYXRlMikgPT4gewogICAgcmV0dXJuIGZsb29yaShkYXRlMiA9IG5ldyBEYXRlKGRhdGUyIC0gMSkpLCBvZmZzZXRpKGRhdGUyLCAxKSwgZmxvb3JpKGRhdGUyKSwgZGF0ZTI7CiAgfTsKICBpbnRlcnZhbC5yb3VuZCA9IChkYXRlMikgPT4gewogICAgY29uc3QgZDAgPSBpbnRlcnZhbChkYXRlMiksIGQxID0gaW50ZXJ2YWwuY2VpbChkYXRlMik7CiAgICByZXR1cm4gZGF0ZTIgLSBkMCA8IGQxIC0gZGF0ZTIgPyBkMCA6IGQxOwogIH07CiAgaW50ZXJ2YWwub2Zmc2V0ID0gKGRhdGUyLCBzdGVwKSA9PiB7CiAgICByZXR1cm4gb2Zmc2V0aShkYXRlMiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgrZGF0ZTIpLCBzdGVwID09IG51bGwgPyAxIDogTWF0aC5mbG9vcihzdGVwKSksIGRhdGUyOwogIH07CiAgaW50ZXJ2YWwucmFuZ2UgPSAoc3RhcnQsIHN0b3AsIHN0ZXApID0+IHsKICAgIGNvbnN0IHJhbmdlNCA9IFtdOwogICAgc3RhcnQgPSBpbnRlcnZhbC5jZWlsKHN0YXJ0KTsKICAgIHN0ZXAgPSBzdGVwID09IG51bGwgPyAxIDogTWF0aC5mbG9vcihzdGVwKTsKICAgIGlmICghKHN0YXJ0IDwgc3RvcCkgfHwgIShzdGVwID4gMCkpIHJldHVybiByYW5nZTQ7CiAgICBsZXQgcHJldmlvdXM7CiAgICBkbwogICAgICByYW5nZTQucHVzaChwcmV2aW91cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgrc3RhcnQpKSwgb2Zmc2V0aShzdGFydCwgc3RlcCksIGZsb29yaShzdGFydCk7CiAgICB3aGlsZSAocHJldmlvdXMgPCBzdGFydCAmJiBzdGFydCA8IHN0b3ApOwogICAgcmV0dXJuIHJhbmdlNDsKICB9OwogIGludGVydmFsLmZpbHRlciA9ICh0ZXN0KSA9PiB7CiAgICByZXR1cm4gdGltZUludGVydmFsKChkYXRlMikgPT4gewogICAgICBpZiAoZGF0ZTIgPj0gZGF0ZTIpIHdoaWxlIChmbG9vcmkoZGF0ZTIpLCAhdGVzdChkYXRlMikpIGRhdGUyLnNldFRpbWUoZGF0ZTIgLSAxKTsKICAgIH0sIChkYXRlMiwgc3RlcCkgPT4gewogICAgICBpZiAoZGF0ZTIgPj0gZGF0ZTIpIHsKICAgICAgICBpZiAoc3RlcCA8IDApIHdoaWxlICgrK3N0ZXAgPD0gMCkgewogICAgICAgICAgd2hpbGUgKG9mZnNldGkoZGF0ZTIsIC0xKSwgIXRlc3QoZGF0ZTIpKSB7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2Ugd2hpbGUgKC0tc3RlcCA+PSAwKSB7CiAgICAgICAgICB3aGlsZSAob2Zmc2V0aShkYXRlMiwgMSksICF0ZXN0KGRhdGUyKSkgewogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfTsKICBpZiAoY291bnQpIHsKICAgIGludGVydmFsLmNvdW50ID0gKHN0YXJ0LCBlbmQpID0+IHsKICAgICAgdDAuc2V0VGltZSgrc3RhcnQpLCB0MS5zZXRUaW1lKCtlbmQpOwogICAgICBmbG9vcmkodDApLCBmbG9vcmkodDEpOwogICAgICByZXR1cm4gTWF0aC5mbG9vcihjb3VudCh0MCwgdDEpKTsKICAgIH07CiAgICBpbnRlcnZhbC5ldmVyeSA9IChzdGVwKSA9PiB7CiAgICAgIHN0ZXAgPSBNYXRoLmZsb29yKHN0ZXApOwogICAgICByZXR1cm4gIWlzRmluaXRlKHN0ZXApIHx8ICEoc3RlcCA+IDApID8gbnVsbCA6ICEoc3RlcCA+IDEpID8gaW50ZXJ2YWwgOiBpbnRlcnZhbC5maWx0ZXIoZmllbGQgPyAoZCkgPT4gZmllbGQoZCkgJSBzdGVwID09PSAwIDogKGQpID0+IGludGVydmFsLmNvdW50KDAsIGQpICUgc3RlcCA9PT0gMCk7CiAgICB9OwogIH0KICByZXR1cm4gaW50ZXJ2YWw7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9taWxsaXNlY29uZC5qcwp2YXIgbWlsbGlzZWNvbmQgPSB0aW1lSW50ZXJ2YWwoKCkgPT4gewp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXApOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiBlbmQgLSBzdGFydDsKfSk7Cm1pbGxpc2Vjb25kLmV2ZXJ5ID0gKGspID0+IHsKICBrID0gTWF0aC5mbG9vcihrKTsKICBpZiAoIWlzRmluaXRlKGspIHx8ICEoayA+IDApKSByZXR1cm4gbnVsbDsKICBpZiAoIShrID4gMSkpIHJldHVybiBtaWxsaXNlY29uZDsKICByZXR1cm4gdGltZUludGVydmFsKChkYXRlMikgPT4gewogICAgZGF0ZTIuc2V0VGltZShNYXRoLmZsb29yKGRhdGUyIC8gaykgKiBrKTsKICB9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICAgIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCAqIGspOwogIH0sIChzdGFydCwgZW5kKSA9PiB7CiAgICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGs7CiAgfSk7Cn07CnZhciBtaWxsaXNlY29uZHMgPSBtaWxsaXNlY29uZC5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9kdXJhdGlvbi5qcwp2YXIgZHVyYXRpb25TZWNvbmQgPSAxZTM7CnZhciBkdXJhdGlvbk1pbnV0ZSA9IGR1cmF0aW9uU2Vjb25kICogNjA7CnZhciBkdXJhdGlvbkhvdXIgPSBkdXJhdGlvbk1pbnV0ZSAqIDYwOwp2YXIgZHVyYXRpb25EYXkgPSBkdXJhdGlvbkhvdXIgKiAyNDsKdmFyIGR1cmF0aW9uV2VlayA9IGR1cmF0aW9uRGF5ICogNzsKdmFyIGR1cmF0aW9uTW9udGggPSBkdXJhdGlvbkRheSAqIDMwOwp2YXIgZHVyYXRpb25ZZWFyID0gZHVyYXRpb25EYXkgKiAzNjU7CgovLyBub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvc2Vjb25kLmpzCnZhciBzZWNvbmQgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VGltZShkYXRlMiAtIGRhdGUyLmdldE1pbGxpc2Vjb25kcygpKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwICogZHVyYXRpb25TZWNvbmQpOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25TZWNvbmQ7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRVVENTZWNvbmRzKCk7Cn0pOwp2YXIgc2Vjb25kcyA9IHNlY29uZC5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9taW51dGUuanMKdmFyIHRpbWVNaW51dGUgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VGltZShkYXRlMiAtIGRhdGUyLmdldE1pbGxpc2Vjb25kcygpIC0gZGF0ZTIuZ2V0U2Vjb25kcygpICogZHVyYXRpb25TZWNvbmQpOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXAgKiBkdXJhdGlvbk1pbnV0ZSk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbk1pbnV0ZTsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldE1pbnV0ZXMoKTsKfSk7CnZhciB0aW1lTWludXRlcyA9IHRpbWVNaW51dGUucmFuZ2U7CnZhciB1dGNNaW51dGUgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VVRDU2Vjb25kcygwLCAwKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwICogZHVyYXRpb25NaW51dGUpOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25NaW51dGU7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRVVENNaW51dGVzKCk7Cn0pOwp2YXIgdXRjTWludXRlcyA9IHV0Y01pbnV0ZS5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9ob3VyLmpzCnZhciB0aW1lSG91ciA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRUaW1lKGRhdGUyIC0gZGF0ZTIuZ2V0TWlsbGlzZWNvbmRzKCkgLSBkYXRlMi5nZXRTZWNvbmRzKCkgKiBkdXJhdGlvblNlY29uZCAtIGRhdGUyLmdldE1pbnV0ZXMoKSAqIGR1cmF0aW9uTWludXRlKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwICogZHVyYXRpb25Ib3VyKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uSG91cjsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldEhvdXJzKCk7Cn0pOwp2YXIgdGltZUhvdXJzID0gdGltZUhvdXIucmFuZ2U7CnZhciB1dGNIb3VyID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ01pbnV0ZXMoMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCAqIGR1cmF0aW9uSG91cik7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbkhvdXI7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRVVENIb3VycygpOwp9KTsKdmFyIHV0Y0hvdXJzID0gdXRjSG91ci5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9kYXkuanMKdmFyIHRpbWVEYXkgPSB0aW1lSW50ZXJ2YWwoCiAgKGRhdGUyKSA9PiBkYXRlMi5zZXRIb3VycygwLCAwLCAwLCAwKSwKICAoZGF0ZTIsIHN0ZXApID0+IGRhdGUyLnNldERhdGUoZGF0ZTIuZ2V0RGF0ZSgpICsgc3RlcCksCiAgKHN0YXJ0LCBlbmQpID0+IChlbmQgLSBzdGFydCAtIChlbmQuZ2V0VGltZXpvbmVPZmZzZXQoKSAtIHN0YXJ0LmdldFRpbWV6b25lT2Zmc2V0KCkpICogZHVyYXRpb25NaW51dGUpIC8gZHVyYXRpb25EYXksCiAgKGRhdGUyKSA9PiBkYXRlMi5nZXREYXRlKCkgLSAxCik7CnZhciB0aW1lRGF5cyA9IHRpbWVEYXkucmFuZ2U7CnZhciB1dGNEYXkgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VVRDSG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFVUQ0RhdGUoZGF0ZTIuZ2V0VVRDRGF0ZSgpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbkRheTsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldFVUQ0RhdGUoKSAtIDE7Cn0pOwp2YXIgdXRjRGF5cyA9IHV0Y0RheS5yYW5nZTsKdmFyIHVuaXhEYXkgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VVRDSG91cnMoMCwgMCwgMCwgMCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFVUQ0RhdGUoZGF0ZTIuZ2V0VVRDRGF0ZSgpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbkRheTsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIE1hdGguZmxvb3IoZGF0ZTIgLyBkdXJhdGlvbkRheSk7Cn0pOwp2YXIgdW5peERheXMgPSB1bml4RGF5LnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL3dlZWsuanMKZnVuY3Rpb24gdGltZVdlZWtkYXkoaSkgewogIHJldHVybiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICBkYXRlMi5zZXREYXRlKGRhdGUyLmdldERhdGUoKSAtIChkYXRlMi5nZXREYXkoKSArIDcgLSBpKSAlIDcpOwogICAgZGF0ZTIuc2V0SG91cnMoMCwgMCwgMCwgMCk7CiAgfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgICBkYXRlMi5zZXREYXRlKGRhdGUyLmdldERhdGUoKSArIHN0ZXAgKiA3KTsKICB9LCAoc3RhcnQsIGVuZCkgPT4gewogICAgcmV0dXJuIChlbmQgLSBzdGFydCAtIChlbmQuZ2V0VGltZXpvbmVPZmZzZXQoKSAtIHN0YXJ0LmdldFRpbWV6b25lT2Zmc2V0KCkpICogZHVyYXRpb25NaW51dGUpIC8gZHVyYXRpb25XZWVrOwogIH0pOwp9CnZhciB0aW1lU3VuZGF5ID0gdGltZVdlZWtkYXkoMCk7CnZhciB0aW1lTW9uZGF5ID0gdGltZVdlZWtkYXkoMSk7CnZhciB0aW1lVHVlc2RheSA9IHRpbWVXZWVrZGF5KDIpOwp2YXIgdGltZVdlZG5lc2RheSA9IHRpbWVXZWVrZGF5KDMpOwp2YXIgdGltZVRodXJzZGF5ID0gdGltZVdlZWtkYXkoNCk7CnZhciB0aW1lRnJpZGF5ID0gdGltZVdlZWtkYXkoNSk7CnZhciB0aW1lU2F0dXJkYXkgPSB0aW1lV2Vla2RheSg2KTsKdmFyIHRpbWVTdW5kYXlzID0gdGltZVN1bmRheS5yYW5nZTsKdmFyIHRpbWVNb25kYXlzID0gdGltZU1vbmRheS5yYW5nZTsKdmFyIHRpbWVUdWVzZGF5cyA9IHRpbWVUdWVzZGF5LnJhbmdlOwp2YXIgdGltZVdlZG5lc2RheXMgPSB0aW1lV2VkbmVzZGF5LnJhbmdlOwp2YXIgdGltZVRodXJzZGF5cyA9IHRpbWVUaHVyc2RheS5yYW5nZTsKdmFyIHRpbWVGcmlkYXlzID0gdGltZUZyaWRheS5yYW5nZTsKdmFyIHRpbWVTYXR1cmRheXMgPSB0aW1lU2F0dXJkYXkucmFuZ2U7CmZ1bmN0aW9uIHV0Y1dlZWtkYXkoaSkgewogIHJldHVybiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICBkYXRlMi5zZXRVVENEYXRlKGRhdGUyLmdldFVUQ0RhdGUoKSAtIChkYXRlMi5nZXRVVENEYXkoKSArIDcgLSBpKSAlIDcpOwogICAgZGF0ZTIuc2V0VVRDSG91cnMoMCwgMCwgMCwgMCk7CiAgfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgICBkYXRlMi5zZXRVVENEYXRlKGRhdGUyLmdldFVUQ0RhdGUoKSArIHN0ZXAgKiA3KTsKICB9LCAoc3RhcnQsIGVuZCkgPT4gewogICAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbldlZWs7CiAgfSk7Cn0KdmFyIHV0Y1N1bmRheSA9IHV0Y1dlZWtkYXkoMCk7CnZhciB1dGNNb25kYXkgPSB1dGNXZWVrZGF5KDEpOwp2YXIgdXRjVHVlc2RheSA9IHV0Y1dlZWtkYXkoMik7CnZhciB1dGNXZWRuZXNkYXkgPSB1dGNXZWVrZGF5KDMpOwp2YXIgdXRjVGh1cnNkYXkgPSB1dGNXZWVrZGF5KDQpOwp2YXIgdXRjRnJpZGF5ID0gdXRjV2Vla2RheSg1KTsKdmFyIHV0Y1NhdHVyZGF5ID0gdXRjV2Vla2RheSg2KTsKdmFyIHV0Y1N1bmRheXMgPSB1dGNTdW5kYXkucmFuZ2U7CnZhciB1dGNNb25kYXlzID0gdXRjTW9uZGF5LnJhbmdlOwp2YXIgdXRjVHVlc2RheXMgPSB1dGNUdWVzZGF5LnJhbmdlOwp2YXIgdXRjV2VkbmVzZGF5cyA9IHV0Y1dlZG5lc2RheS5yYW5nZTsKdmFyIHV0Y1RodXJzZGF5cyA9IHV0Y1RodXJzZGF5LnJhbmdlOwp2YXIgdXRjRnJpZGF5cyA9IHV0Y0ZyaWRheS5yYW5nZTsKdmFyIHV0Y1NhdHVyZGF5cyA9IHV0Y1NhdHVyZGF5LnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL21vbnRoLmpzCnZhciB0aW1lTW9udGggPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0RGF0ZSgxKTsKICBkYXRlMi5zZXRIb3VycygwLCAwLCAwLCAwKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0TW9udGgoZGF0ZTIuZ2V0TW9udGgoKSArIHN0ZXApOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiBlbmQuZ2V0TW9udGgoKSAtIHN0YXJ0LmdldE1vbnRoKCkgKyAoZW5kLmdldEZ1bGxZZWFyKCkgLSBzdGFydC5nZXRGdWxsWWVhcigpKSAqIDEyOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0TW9udGgoKTsKfSk7CnZhciB0aW1lTW9udGhzID0gdGltZU1vbnRoLnJhbmdlOwp2YXIgdXRjTW9udGggPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VVRDRGF0ZSgxKTsKICBkYXRlMi5zZXRVVENIb3VycygwLCAwLCAwLCAwKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VVRDTW9udGgoZGF0ZTIuZ2V0VVRDTW9udGgoKSArIHN0ZXApOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiBlbmQuZ2V0VVRDTW9udGgoKSAtIHN0YXJ0LmdldFVUQ01vbnRoKCkgKyAoZW5kLmdldFVUQ0Z1bGxZZWFyKCkgLSBzdGFydC5nZXRVVENGdWxsWWVhcigpKSAqIDEyOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDTW9udGgoKTsKfSk7CnZhciB1dGNNb250aHMgPSB1dGNNb250aC5yYW5nZTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy95ZWFyLmpzCnZhciB0aW1lWWVhciA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRNb250aCgwLCAxKTsKICBkYXRlMi5zZXRIb3VycygwLCAwLCAwLCAwKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0RnVsbFllYXIoZGF0ZTIuZ2V0RnVsbFllYXIoKSArIHN0ZXApOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiBlbmQuZ2V0RnVsbFllYXIoKSAtIHN0YXJ0LmdldEZ1bGxZZWFyKCk7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRGdWxsWWVhcigpOwp9KTsKdGltZVllYXIuZXZlcnkgPSAoaykgPT4gewogIHJldHVybiAhaXNGaW5pdGUoayA9IE1hdGguZmxvb3IoaykpIHx8ICEoayA+IDApID8gbnVsbCA6IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICAgIGRhdGUyLnNldEZ1bGxZZWFyKE1hdGguZmxvb3IoZGF0ZTIuZ2V0RnVsbFllYXIoKSAvIGspICogayk7CiAgICBkYXRlMi5zZXRNb250aCgwLCAxKTsKICAgIGRhdGUyLnNldEhvdXJzKDAsIDAsIDAsIDApOwogIH0sIChkYXRlMiwgc3RlcCkgPT4gewogICAgZGF0ZTIuc2V0RnVsbFllYXIoZGF0ZTIuZ2V0RnVsbFllYXIoKSArIHN0ZXAgKiBrKTsKICB9KTsKfTsKdmFyIHRpbWVZZWFycyA9IHRpbWVZZWFyLnJhbmdlOwp2YXIgdXRjWWVhciA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRVVENNb250aCgwLCAxKTsKICBkYXRlMi5zZXRVVENIb3VycygwLCAwLCAwLCAwKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VVRDRnVsbFllYXIoZGF0ZTIuZ2V0VVRDRnVsbFllYXIoKSArIHN0ZXApOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiBlbmQuZ2V0VVRDRnVsbFllYXIoKSAtIHN0YXJ0LmdldFVUQ0Z1bGxZZWFyKCk7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRVVENGdWxsWWVhcigpOwp9KTsKdXRjWWVhci5ldmVyeSA9IChrKSA9PiB7CiAgcmV0dXJuICFpc0Zpbml0ZShrID0gTWF0aC5mbG9vcihrKSkgfHwgIShrID4gMCkgPyBudWxsIDogdGltZUludGVydmFsKChkYXRlMikgPT4gewogICAgZGF0ZTIuc2V0VVRDRnVsbFllYXIoTWF0aC5mbG9vcihkYXRlMi5nZXRVVENGdWxsWWVhcigpIC8gaykgKiBrKTsKICAgIGRhdGUyLnNldFVUQ01vbnRoKDAsIDEpOwogICAgZGF0ZTIuc2V0VVRDSG91cnMoMCwgMCwgMCwgMCk7CiAgfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgICBkYXRlMi5zZXRVVENGdWxsWWVhcihkYXRlMi5nZXRVVENGdWxsWWVhcigpICsgc3RlcCAqIGspOwogIH0pOwp9Owp2YXIgdXRjWWVhcnMgPSB1dGNZZWFyLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL3RpY2tzLmpzCmZ1bmN0aW9uIHRpY2tlcih5ZWFyLCBtb250aCwgd2VlaywgZGF5LCBob3VyLCBtaW51dGUpIHsKICBjb25zdCB0aWNrSW50ZXJ2YWxzID0gWwogICAgW3NlY29uZCwgMSwgZHVyYXRpb25TZWNvbmRdLAogICAgW3NlY29uZCwgNSwgNSAqIGR1cmF0aW9uU2Vjb25kXSwKICAgIFtzZWNvbmQsIDE1LCAxNSAqIGR1cmF0aW9uU2Vjb25kXSwKICAgIFtzZWNvbmQsIDMwLCAzMCAqIGR1cmF0aW9uU2Vjb25kXSwKICAgIFttaW51dGUsIDEsIGR1cmF0aW9uTWludXRlXSwKICAgIFttaW51dGUsIDUsIDUgKiBkdXJhdGlvbk1pbnV0ZV0sCiAgICBbbWludXRlLCAxNSwgMTUgKiBkdXJhdGlvbk1pbnV0ZV0sCiAgICBbbWludXRlLCAzMCwgMzAgKiBkdXJhdGlvbk1pbnV0ZV0sCiAgICBbaG91ciwgMSwgZHVyYXRpb25Ib3VyXSwKICAgIFtob3VyLCAzLCAzICogZHVyYXRpb25Ib3VyXSwKICAgIFtob3VyLCA2LCA2ICogZHVyYXRpb25Ib3VyXSwKICAgIFtob3VyLCAxMiwgMTIgKiBkdXJhdGlvbkhvdXJdLAogICAgW2RheSwgMSwgZHVyYXRpb25EYXldLAogICAgW2RheSwgMiwgMiAqIGR1cmF0aW9uRGF5XSwKICAgIFt3ZWVrLCAxLCBkdXJhdGlvbldlZWtdLAogICAgW21vbnRoLCAxLCBkdXJhdGlvbk1vbnRoXSwKICAgIFttb250aCwgMywgMyAqIGR1cmF0aW9uTW9udGhdLAogICAgW3llYXIsIDEsIGR1cmF0aW9uWWVhcl0KICBdOwogIGZ1bmN0aW9uIHRpY2tzMihzdGFydCwgc3RvcCwgY291bnQpIHsKICAgIGNvbnN0IHJldmVyc2UyID0gc3RvcCA8IHN0YXJ0OwogICAgaWYgKHJldmVyc2UyKSBbc3RhcnQsIHN0b3BdID0gW3N0b3AsIHN0YXJ0XTsKICAgIGNvbnN0IGludGVydmFsID0gY291bnQgJiYgdHlwZW9mIGNvdW50LnJhbmdlID09PSAiZnVuY3Rpb24iID8gY291bnQgOiB0aWNrSW50ZXJ2YWwoc3RhcnQsIHN0b3AsIGNvdW50KTsKICAgIGNvbnN0IHRpY2tzMyA9IGludGVydmFsID8gaW50ZXJ2YWwucmFuZ2Uoc3RhcnQsICtzdG9wICsgMSkgOiBbXTsKICAgIHJldHVybiByZXZlcnNlMiA/IHRpY2tzMy5yZXZlcnNlKCkgOiB0aWNrczM7CiAgfQogIGZ1bmN0aW9uIHRpY2tJbnRlcnZhbChzdGFydCwgc3RvcCwgY291bnQpIHsKICAgIGNvbnN0IHRhcmdldCA9IE1hdGguYWJzKHN0b3AgLSBzdGFydCkgLyBjb3VudDsKICAgIGNvbnN0IGkgPSBiaXNlY3RvcigoWywgLCBzdGVwMl0pID0+IHN0ZXAyKS5yaWdodCh0aWNrSW50ZXJ2YWxzLCB0YXJnZXQpOwogICAgaWYgKGkgPT09IHRpY2tJbnRlcnZhbHMubGVuZ3RoKSByZXR1cm4geWVhci5ldmVyeSh0aWNrU3RlcChzdGFydCAvIGR1cmF0aW9uWWVhciwgc3RvcCAvIGR1cmF0aW9uWWVhciwgY291bnQpKTsKICAgIGlmIChpID09PSAwKSByZXR1cm4gbWlsbGlzZWNvbmQuZXZlcnkoTWF0aC5tYXgodGlja1N0ZXAoc3RhcnQsIHN0b3AsIGNvdW50KSwgMSkpOwogICAgY29uc3QgW3QsIHN0ZXBdID0gdGlja0ludGVydmFsc1t0YXJnZXQgLyB0aWNrSW50ZXJ2YWxzW2kgLSAxXVsyXSA8IHRpY2tJbnRlcnZhbHNbaV1bMl0gLyB0YXJnZXQgPyBpIC0gMSA6IGldOwogICAgcmV0dXJuIHQuZXZlcnkoc3RlcCk7CiAgfQogIHJldHVybiBbdGlja3MyLCB0aWNrSW50ZXJ2YWxdOwp9CnZhciBbdXRjVGlja3MsIHV0Y1RpY2tJbnRlcnZhbF0gPSB0aWNrZXIodXRjWWVhciwgdXRjTW9udGgsIHV0Y1N1bmRheSwgdW5peERheSwgdXRjSG91ciwgdXRjTWludXRlKTsKdmFyIFt0aW1lVGlja3MsIHRpbWVUaWNrSW50ZXJ2YWxdID0gdGlja2VyKHRpbWVZZWFyLCB0aW1lTW9udGgsIHRpbWVTdW5kYXksIHRpbWVEYXksIHRpbWVIb3VyLCB0aW1lTWludXRlKTsKCi8vIG5vZGVfbW9kdWxlcy9kMy10aW1lLWZvcm1hdC9zcmMvbG9jYWxlLmpzCmZ1bmN0aW9uIGxvY2FsRGF0ZShkKSB7CiAgaWYgKDAgPD0gZC55ICYmIGQueSA8IDEwMCkgewogICAgdmFyIGRhdGUyID0gbmV3IERhdGUoLTEsIGQubSwgZC5kLCBkLkgsIGQuTSwgZC5TLCBkLkwpOwogICAgZGF0ZTIuc2V0RnVsbFllYXIoZC55KTsKICAgIHJldHVybiBkYXRlMjsKICB9CiAgcmV0dXJuIG5ldyBEYXRlKGQueSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCk7Cn0KZnVuY3Rpb24gdXRjRGF0ZShkKSB7CiAgaWYgKDAgPD0gZC55ICYmIGQueSA8IDEwMCkgewogICAgdmFyIGRhdGUyID0gbmV3IERhdGUoRGF0ZS5VVEMoLTEsIGQubSwgZC5kLCBkLkgsIGQuTSwgZC5TLCBkLkwpKTsKICAgIGRhdGUyLnNldFVUQ0Z1bGxZZWFyKGQueSk7CiAgICByZXR1cm4gZGF0ZTI7CiAgfQogIHJldHVybiBuZXcgRGF0ZShEYXRlLlVUQyhkLnksIGQubSwgZC5kLCBkLkgsIGQuTSwgZC5TLCBkLkwpKTsKfQpmdW5jdGlvbiBuZXdEYXRlKHkyLCBtLCBkKSB7CiAgcmV0dXJuIHsgeTogeTIsIG0sIGQsIEg6IDAsIE06IDAsIFM6IDAsIEw6IDAgfTsKfQpmdW5jdGlvbiBmb3JtYXRMb2NhbGUobG9jYWxlMykgewogIHZhciBsb2NhbGVfZGF0ZVRpbWUgPSBsb2NhbGUzLmRhdGVUaW1lLCBsb2NhbGVfZGF0ZSA9IGxvY2FsZTMuZGF0ZSwgbG9jYWxlX3RpbWUgPSBsb2NhbGUzLnRpbWUsIGxvY2FsZV9wZXJpb2RzID0gbG9jYWxlMy5wZXJpb2RzLCBsb2NhbGVfd2Vla2RheXMgPSBsb2NhbGUzLmRheXMsIGxvY2FsZV9zaG9ydFdlZWtkYXlzID0gbG9jYWxlMy5zaG9ydERheXMsIGxvY2FsZV9tb250aHMgPSBsb2NhbGUzLm1vbnRocywgbG9jYWxlX3Nob3J0TW9udGhzID0gbG9jYWxlMy5zaG9ydE1vbnRoczsKICB2YXIgcGVyaW9kUmUgPSBmb3JtYXRSZShsb2NhbGVfcGVyaW9kcyksIHBlcmlvZExvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfcGVyaW9kcyksIHdlZWtkYXlSZSA9IGZvcm1hdFJlKGxvY2FsZV93ZWVrZGF5cyksIHdlZWtkYXlMb29rdXAgPSBmb3JtYXRMb29rdXAobG9jYWxlX3dlZWtkYXlzKSwgc2hvcnRXZWVrZGF5UmUgPSBmb3JtYXRSZShsb2NhbGVfc2hvcnRXZWVrZGF5cyksIHNob3J0V2Vla2RheUxvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfc2hvcnRXZWVrZGF5cyksIG1vbnRoUmUgPSBmb3JtYXRSZShsb2NhbGVfbW9udGhzKSwgbW9udGhMb29rdXAgPSBmb3JtYXRMb29rdXAobG9jYWxlX21vbnRocyksIHNob3J0TW9udGhSZSA9IGZvcm1hdFJlKGxvY2FsZV9zaG9ydE1vbnRocyksIHNob3J0TW9udGhMb29rdXAgPSBmb3JtYXRMb29rdXAobG9jYWxlX3Nob3J0TW9udGhzKTsKICB2YXIgZm9ybWF0cyA9IHsKICAgICJhIjogZm9ybWF0U2hvcnRXZWVrZGF5LAogICAgIkEiOiBmb3JtYXRXZWVrZGF5LAogICAgImIiOiBmb3JtYXRTaG9ydE1vbnRoLAogICAgIkIiOiBmb3JtYXRNb250aCwKICAgICJjIjogbnVsbCwKICAgICJkIjogZm9ybWF0RGF5T2ZNb250aCwKICAgICJlIjogZm9ybWF0RGF5T2ZNb250aCwKICAgICJmIjogZm9ybWF0TWljcm9zZWNvbmRzLAogICAgImciOiBmb3JtYXRZZWFySVNPLAogICAgIkciOiBmb3JtYXRGdWxsWWVhcklTTywKICAgICJIIjogZm9ybWF0SG91cjI0LAogICAgIkkiOiBmb3JtYXRIb3VyMTIsCiAgICAiaiI6IGZvcm1hdERheU9mWWVhciwKICAgICJMIjogZm9ybWF0TWlsbGlzZWNvbmRzLAogICAgIm0iOiBmb3JtYXRNb250aE51bWJlciwKICAgICJNIjogZm9ybWF0TWludXRlcywKICAgICJwIjogZm9ybWF0UGVyaW9kLAogICAgInEiOiBmb3JtYXRRdWFydGVyLAogICAgIlEiOiBmb3JtYXRVbml4VGltZXN0YW1wLAogICAgInMiOiBmb3JtYXRVbml4VGltZXN0YW1wU2Vjb25kcywKICAgICJTIjogZm9ybWF0U2Vjb25kcywKICAgICJ1IjogZm9ybWF0V2Vla2RheU51bWJlck1vbmRheSwKICAgICJVIjogZm9ybWF0V2Vla051bWJlclN1bmRheSwKICAgICJWIjogZm9ybWF0V2Vla051bWJlcklTTywKICAgICJ3IjogZm9ybWF0V2Vla2RheU51bWJlclN1bmRheSwKICAgICJXIjogZm9ybWF0V2Vla051bWJlck1vbmRheSwKICAgICJ4IjogbnVsbCwKICAgICJYIjogbnVsbCwKICAgICJ5IjogZm9ybWF0WWVhciwKICAgICJZIjogZm9ybWF0RnVsbFllYXIsCiAgICAiWiI6IGZvcm1hdFpvbmUsCiAgICAiJSI6IGZvcm1hdExpdGVyYWxQZXJjZW50CiAgfTsKICB2YXIgdXRjRm9ybWF0cyA9IHsKICAgICJhIjogZm9ybWF0VVRDU2hvcnRXZWVrZGF5LAogICAgIkEiOiBmb3JtYXRVVENXZWVrZGF5LAogICAgImIiOiBmb3JtYXRVVENTaG9ydE1vbnRoLAogICAgIkIiOiBmb3JtYXRVVENNb250aCwKICAgICJjIjogbnVsbCwKICAgICJkIjogZm9ybWF0VVRDRGF5T2ZNb250aCwKICAgICJlIjogZm9ybWF0VVRDRGF5T2ZNb250aCwKICAgICJmIjogZm9ybWF0VVRDTWljcm9zZWNvbmRzLAogICAgImciOiBmb3JtYXRVVENZZWFySVNPLAogICAgIkciOiBmb3JtYXRVVENGdWxsWWVhcklTTywKICAgICJIIjogZm9ybWF0VVRDSG91cjI0LAogICAgIkkiOiBmb3JtYXRVVENIb3VyMTIsCiAgICAiaiI6IGZvcm1hdFVUQ0RheU9mWWVhciwKICAgICJMIjogZm9ybWF0VVRDTWlsbGlzZWNvbmRzLAogICAgIm0iOiBmb3JtYXRVVENNb250aE51bWJlciwKICAgICJNIjogZm9ybWF0VVRDTWludXRlcywKICAgICJwIjogZm9ybWF0VVRDUGVyaW9kLAogICAgInEiOiBmb3JtYXRVVENRdWFydGVyLAogICAgIlEiOiBmb3JtYXRVbml4VGltZXN0YW1wLAogICAgInMiOiBmb3JtYXRVbml4VGltZXN0YW1wU2Vjb25kcywKICAgICJTIjogZm9ybWF0VVRDU2Vjb25kcywKICAgICJ1IjogZm9ybWF0VVRDV2Vla2RheU51bWJlck1vbmRheSwKICAgICJVIjogZm9ybWF0VVRDV2Vla051bWJlclN1bmRheSwKICAgICJWIjogZm9ybWF0VVRDV2Vla051bWJlcklTTywKICAgICJ3IjogZm9ybWF0VVRDV2Vla2RheU51bWJlclN1bmRheSwKICAgICJXIjogZm9ybWF0VVRDV2Vla051bWJlck1vbmRheSwKICAgICJ4IjogbnVsbCwKICAgICJYIjogbnVsbCwKICAgICJ5IjogZm9ybWF0VVRDWWVhciwKICAgICJZIjogZm9ybWF0VVRDRnVsbFllYXIsCiAgICAiWiI6IGZvcm1hdFVUQ1pvbmUsCiAgICAiJSI6IGZvcm1hdExpdGVyYWxQZXJjZW50CiAgfTsKICB2YXIgcGFyc2VzID0gewogICAgImEiOiBwYXJzZVNob3J0V2Vla2RheSwKICAgICJBIjogcGFyc2VXZWVrZGF5LAogICAgImIiOiBwYXJzZVNob3J0TW9udGgsCiAgICAiQiI6IHBhcnNlTW9udGgsCiAgICAiYyI6IHBhcnNlTG9jYWxlRGF0ZVRpbWUsCiAgICAiZCI6IHBhcnNlRGF5T2ZNb250aCwKICAgICJlIjogcGFyc2VEYXlPZk1vbnRoLAogICAgImYiOiBwYXJzZU1pY3Jvc2Vjb25kcywKICAgICJnIjogcGFyc2VZZWFyLAogICAgIkciOiBwYXJzZUZ1bGxZZWFyLAogICAgIkgiOiBwYXJzZUhvdXIyNCwKICAgICJJIjogcGFyc2VIb3VyMjQsCiAgICAiaiI6IHBhcnNlRGF5T2ZZZWFyLAogICAgIkwiOiBwYXJzZU1pbGxpc2Vjb25kcywKICAgICJtIjogcGFyc2VNb250aE51bWJlciwKICAgICJNIjogcGFyc2VNaW51dGVzLAogICAgInAiOiBwYXJzZVBlcmlvZCwKICAgICJxIjogcGFyc2VRdWFydGVyLAogICAgIlEiOiBwYXJzZVVuaXhUaW1lc3RhbXAsCiAgICAicyI6IHBhcnNlVW5peFRpbWVzdGFtcFNlY29uZHMsCiAgICAiUyI6IHBhcnNlU2Vjb25kcywKICAgICJ1IjogcGFyc2VXZWVrZGF5TnVtYmVyTW9uZGF5LAogICAgIlUiOiBwYXJzZVdlZWtOdW1iZXJTdW5kYXksCiAgICAiViI6IHBhcnNlV2Vla051bWJlcklTTywKICAgICJ3IjogcGFyc2VXZWVrZGF5TnVtYmVyU3VuZGF5LAogICAgIlciOiBwYXJzZVdlZWtOdW1iZXJNb25kYXksCiAgICAieCI6IHBhcnNlTG9jYWxlRGF0ZSwKICAgICJYIjogcGFyc2VMb2NhbGVUaW1lLAogICAgInkiOiBwYXJzZVllYXIsCiAgICAiWSI6IHBhcnNlRnVsbFllYXIsCiAgICAiWiI6IHBhcnNlWm9uZSwKICAgICIlIjogcGFyc2VMaXRlcmFsUGVyY2VudAogIH07CiAgZm9ybWF0cy54ID0gbmV3Rm9ybWF0KGxvY2FsZV9kYXRlLCBmb3JtYXRzKTsKICBmb3JtYXRzLlggPSBuZXdGb3JtYXQobG9jYWxlX3RpbWUsIGZvcm1hdHMpOwogIGZvcm1hdHMuYyA9IG5ld0Zvcm1hdChsb2NhbGVfZGF0ZVRpbWUsIGZvcm1hdHMpOwogIHV0Y0Zvcm1hdHMueCA9IG5ld0Zvcm1hdChsb2NhbGVfZGF0ZSwgdXRjRm9ybWF0cyk7CiAgdXRjRm9ybWF0cy5YID0gbmV3Rm9ybWF0KGxvY2FsZV90aW1lLCB1dGNGb3JtYXRzKTsKICB1dGNGb3JtYXRzLmMgPSBuZXdGb3JtYXQobG9jYWxlX2RhdGVUaW1lLCB1dGNGb3JtYXRzKTsKICBmdW5jdGlvbiBuZXdGb3JtYXQoc3BlY2lmaWVyLCBmb3JtYXRzMikgewogICAgcmV0dXJuIGZ1bmN0aW9uKGRhdGUyKSB7CiAgICAgIHZhciBzdHJpbmcgPSBbXSwgaSA9IC0xLCBqID0gMCwgbiA9IHNwZWNpZmllci5sZW5ndGgsIGMsIHBhZDIsIGZvcm1hdDI7CiAgICAgIGlmICghKGRhdGUyIGluc3RhbmNlb2YgRGF0ZSkpIGRhdGUyID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCtkYXRlMik7CiAgICAgIHdoaWxlICgrK2kgPCBuKSB7CiAgICAgICAgaWYgKHNwZWNpZmllci5jaGFyQ29kZUF0KGkpID09PSAzNykgewogICAgICAgICAgc3RyaW5nLnB1c2goc3BlY2lmaWVyLnNsaWNlKGosIGkpKTsKICAgICAgICAgIGlmICgocGFkMiA9IHBhZHNbYyA9IHNwZWNpZmllci5jaGFyQXQoKytpKV0pICE9IG51bGwpIGMgPSBzcGVjaWZpZXIuY2hhckF0KCsraSk7CiAgICAgICAgICBlbHNlIHBhZDIgPSBjID09PSAiZSIgPyAiICIgOiAiMCI7CiAgICAgICAgICBpZiAoZm9ybWF0MiA9IGZvcm1hdHMyW2NdKSBjID0gZm9ybWF0MihkYXRlMiwgcGFkMik7CiAgICAgICAgICBzdHJpbmcucHVzaChjKTsKICAgICAgICAgIGogPSBpICsgMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgc3RyaW5nLnB1c2goc3BlY2lmaWVyLnNsaWNlKGosIGkpKTsKICAgICAgcmV0dXJuIHN0cmluZy5qb2luKCIiKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIG5ld1BhcnNlKHNwZWNpZmllciwgWikgewogICAgcmV0dXJuIGZ1bmN0aW9uKHN0cmluZykgewogICAgICB2YXIgZCA9IG5ld0RhdGUoMTkwMCwgdm9pZCAwLCAxKSwgaSA9IHBhcnNlU3BlY2lmaWVyKGQsIHNwZWNpZmllciwgc3RyaW5nICs9ICIiLCAwKSwgd2VlaywgZGF5OwogICAgICBpZiAoaSAhPSBzdHJpbmcubGVuZ3RoKSByZXR1cm4gbnVsbDsKICAgICAgaWYgKCJRIiBpbiBkKSByZXR1cm4gbmV3IERhdGUoZC5RKTsKICAgICAgaWYgKCJzIiBpbiBkKSByZXR1cm4gbmV3IERhdGUoZC5zICogMWUzICsgKCJMIiBpbiBkID8gZC5MIDogMCkpOwogICAgICBpZiAoWiAmJiAhKCJaIiBpbiBkKSkgZC5aID0gMDsKICAgICAgaWYgKCJwIiBpbiBkKSBkLkggPSBkLkggJSAxMiArIGQucCAqIDEyOwogICAgICBpZiAoZC5tID09PSB2b2lkIDApIGQubSA9ICJxIiBpbiBkID8gZC5xIDogMDsKICAgICAgaWYgKCJWIiBpbiBkKSB7CiAgICAgICAgaWYgKGQuViA8IDEgfHwgZC5WID4gNTMpIHJldHVybiBudWxsOwogICAgICAgIGlmICghKCJ3IiBpbiBkKSkgZC53ID0gMTsKICAgICAgICBpZiAoIloiIGluIGQpIHsKICAgICAgICAgIHdlZWsgPSB1dGNEYXRlKG5ld0RhdGUoZC55LCAwLCAxKSksIGRheSA9IHdlZWsuZ2V0VVRDRGF5KCk7CiAgICAgICAgICB3ZWVrID0gZGF5ID4gNCB8fCBkYXkgPT09IDAgPyB1dGNNb25kYXkuY2VpbCh3ZWVrKSA6IHV0Y01vbmRheSh3ZWVrKTsKICAgICAgICAgIHdlZWsgPSB1dGNEYXkub2Zmc2V0KHdlZWssIChkLlYgLSAxKSAqIDcpOwogICAgICAgICAgZC55ID0gd2Vlay5nZXRVVENGdWxsWWVhcigpOwogICAgICAgICAgZC5tID0gd2Vlay5nZXRVVENNb250aCgpOwogICAgICAgICAgZC5kID0gd2Vlay5nZXRVVENEYXRlKCkgKyAoZC53ICsgNikgJSA3OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3ZWVrID0gbG9jYWxEYXRlKG5ld0RhdGUoZC55LCAwLCAxKSksIGRheSA9IHdlZWsuZ2V0RGF5KCk7CiAgICAgICAgICB3ZWVrID0gZGF5ID4gNCB8fCBkYXkgPT09IDAgPyB0aW1lTW9uZGF5LmNlaWwod2VlaykgOiB0aW1lTW9uZGF5KHdlZWspOwogICAgICAgICAgd2VlayA9IHRpbWVEYXkub2Zmc2V0KHdlZWssIChkLlYgLSAxKSAqIDcpOwogICAgICAgICAgZC55ID0gd2Vlay5nZXRGdWxsWWVhcigpOwogICAgICAgICAgZC5tID0gd2Vlay5nZXRNb250aCgpOwogICAgICAgICAgZC5kID0gd2Vlay5nZXREYXRlKCkgKyAoZC53ICsgNikgJSA3OwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICgiVyIgaW4gZCB8fCAiVSIgaW4gZCkgewogICAgICAgIGlmICghKCJ3IiBpbiBkKSkgZC53ID0gInUiIGluIGQgPyBkLnUgJSA3IDogIlciIGluIGQgPyAxIDogMDsKICAgICAgICBkYXkgPSAiWiIgaW4gZCA/IHV0Y0RhdGUobmV3RGF0ZShkLnksIDAsIDEpKS5nZXRVVENEYXkoKSA6IGxvY2FsRGF0ZShuZXdEYXRlKGQueSwgMCwgMSkpLmdldERheSgpOwogICAgICAgIGQubSA9IDA7CiAgICAgICAgZC5kID0gIlciIGluIGQgPyAoZC53ICsgNikgJSA3ICsgZC5XICogNyAtIChkYXkgKyA1KSAlIDcgOiBkLncgKyBkLlUgKiA3IC0gKGRheSArIDYpICUgNzsKICAgICAgfQogICAgICBpZiAoIloiIGluIGQpIHsKICAgICAgICBkLkggKz0gZC5aIC8gMTAwIHwgMDsKICAgICAgICBkLk0gKz0gZC5aICUgMTAwOwogICAgICAgIHJldHVybiB1dGNEYXRlKGQpOwogICAgICB9CiAgICAgIHJldHVybiBsb2NhbERhdGUoZCk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBwYXJzZVNwZWNpZmllcihkLCBzcGVjaWZpZXIsIHN0cmluZywgaikgewogICAgdmFyIGkgPSAwLCBuID0gc3BlY2lmaWVyLmxlbmd0aCwgbSA9IHN0cmluZy5sZW5ndGgsIGMsIHBhcnNlOwogICAgd2hpbGUgKGkgPCBuKSB7CiAgICAgIGlmIChqID49IG0pIHJldHVybiAtMTsKICAgICAgYyA9IHNwZWNpZmllci5jaGFyQ29kZUF0KGkrKyk7CiAgICAgIGlmIChjID09PSAzNykgewogICAgICAgIGMgPSBzcGVjaWZpZXIuY2hhckF0KGkrKyk7CiAgICAgICAgcGFyc2UgPSBwYXJzZXNbYyBpbiBwYWRzID8gc3BlY2lmaWVyLmNoYXJBdChpKyspIDogY107CiAgICAgICAgaWYgKCFwYXJzZSB8fCAoaiA9IHBhcnNlKGQsIHN0cmluZywgaikpIDwgMCkgcmV0dXJuIC0xOwogICAgICB9IGVsc2UgaWYgKGMgIT0gc3RyaW5nLmNoYXJDb2RlQXQoaisrKSkgewogICAgICAgIHJldHVybiAtMTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGo7CiAgfQogIGZ1bmN0aW9uIHBhcnNlUGVyaW9kKGQsIHN0cmluZywgaSkgewogICAgdmFyIG4gPSBwZXJpb2RSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgICByZXR1cm4gbiA/IChkLnAgPSBwZXJpb2RMb29rdXAuZ2V0KG5bMF0udG9Mb3dlckNhc2UoKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKICB9CiAgZnVuY3Rpb24gcGFyc2VTaG9ydFdlZWtkYXkoZCwgc3RyaW5nLCBpKSB7CiAgICB2YXIgbiA9IHNob3J0V2Vla2RheVJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICAgIHJldHVybiBuID8gKGQudyA9IHNob3J0V2Vla2RheUxvb2t1cC5nZXQoblswXS50b0xvd2VyQ2FzZSgpKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwogIH0KICBmdW5jdGlvbiBwYXJzZVdlZWtkYXkoZCwgc3RyaW5nLCBpKSB7CiAgICB2YXIgbiA9IHdlZWtkYXlSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgICByZXR1cm4gbiA/IChkLncgPSB3ZWVrZGF5TG9va3VwLmdldChuWzBdLnRvTG93ZXJDYXNlKCkpLCBpICsgblswXS5sZW5ndGgpIDogLTE7CiAgfQogIGZ1bmN0aW9uIHBhcnNlU2hvcnRNb250aChkLCBzdHJpbmcsIGkpIHsKICAgIHZhciBuID0gc2hvcnRNb250aFJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICAgIHJldHVybiBuID8gKGQubSA9IHNob3J0TW9udGhMb29rdXAuZ2V0KG5bMF0udG9Mb3dlckNhc2UoKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKICB9CiAgZnVuY3Rpb24gcGFyc2VNb250aChkLCBzdHJpbmcsIGkpIHsKICAgIHZhciBuID0gbW9udGhSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgICByZXR1cm4gbiA/IChkLm0gPSBtb250aExvb2t1cC5nZXQoblswXS50b0xvd2VyQ2FzZSgpKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwogIH0KICBmdW5jdGlvbiBwYXJzZUxvY2FsZURhdGVUaW1lKGQsIHN0cmluZywgaSkgewogICAgcmV0dXJuIHBhcnNlU3BlY2lmaWVyKGQsIGxvY2FsZV9kYXRlVGltZSwgc3RyaW5nLCBpKTsKICB9CiAgZnVuY3Rpb24gcGFyc2VMb2NhbGVEYXRlKGQsIHN0cmluZywgaSkgewogICAgcmV0dXJuIHBhcnNlU3BlY2lmaWVyKGQsIGxvY2FsZV9kYXRlLCBzdHJpbmcsIGkpOwogIH0KICBmdW5jdGlvbiBwYXJzZUxvY2FsZVRpbWUoZCwgc3RyaW5nLCBpKSB7CiAgICByZXR1cm4gcGFyc2VTcGVjaWZpZXIoZCwgbG9jYWxlX3RpbWUsIHN0cmluZywgaSk7CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFNob3J0V2Vla2RheShkKSB7CiAgICByZXR1cm4gbG9jYWxlX3Nob3J0V2Vla2RheXNbZC5nZXREYXkoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFdlZWtkYXkoZCkgewogICAgcmV0dXJuIGxvY2FsZV93ZWVrZGF5c1tkLmdldERheSgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0U2hvcnRNb250aChkKSB7CiAgICByZXR1cm4gbG9jYWxlX3Nob3J0TW9udGhzW2QuZ2V0TW9udGgoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdE1vbnRoKGQpIHsKICAgIHJldHVybiBsb2NhbGVfbW9udGhzW2QuZ2V0TW9udGgoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFBlcmlvZChkKSB7CiAgICByZXR1cm4gbG9jYWxlX3BlcmlvZHNbKyhkLmdldEhvdXJzKCkgPj0gMTIpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0UXVhcnRlcihkKSB7CiAgICByZXR1cm4gMSArIH5+KGQuZ2V0TW9udGgoKSAvIDMpOwogIH0KICBmdW5jdGlvbiBmb3JtYXRVVENTaG9ydFdlZWtkYXkoZCkgewogICAgcmV0dXJuIGxvY2FsZV9zaG9ydFdlZWtkYXlzW2QuZ2V0VVRDRGF5KCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRVVENXZWVrZGF5KGQpIHsKICAgIHJldHVybiBsb2NhbGVfd2Vla2RheXNbZC5nZXRVVENEYXkoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1Nob3J0TW9udGgoZCkgewogICAgcmV0dXJuIGxvY2FsZV9zaG9ydE1vbnRoc1tkLmdldFVUQ01vbnRoKCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRVVENNb250aChkKSB7CiAgICByZXR1cm4gbG9jYWxlX21vbnRoc1tkLmdldFVUQ01vbnRoKCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRVVENQZXJpb2QoZCkgewogICAgcmV0dXJuIGxvY2FsZV9wZXJpb2RzWysoZC5nZXRVVENIb3VycygpID49IDEyKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1F1YXJ0ZXIoZCkgewogICAgcmV0dXJuIDEgKyB+fihkLmdldFVUQ01vbnRoKCkgLyAzKTsKICB9CiAgcmV0dXJuIHsKICAgIGZvcm1hdDogZnVuY3Rpb24oc3BlY2lmaWVyKSB7CiAgICAgIHZhciBmID0gbmV3Rm9ybWF0KHNwZWNpZmllciArPSAiIiwgZm9ybWF0cyk7CiAgICAgIGYudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc3BlY2lmaWVyOwogICAgICB9OwogICAgICByZXR1cm4gZjsKICAgIH0sCiAgICBwYXJzZTogZnVuY3Rpb24oc3BlY2lmaWVyKSB7CiAgICAgIHZhciBwID0gbmV3UGFyc2Uoc3BlY2lmaWVyICs9ICIiLCBmYWxzZSk7CiAgICAgIHAudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc3BlY2lmaWVyOwogICAgICB9OwogICAgICByZXR1cm4gcDsKICAgIH0sCiAgICB1dGNGb3JtYXQ6IGZ1bmN0aW9uKHNwZWNpZmllcikgewogICAgICB2YXIgZiA9IG5ld0Zvcm1hdChzcGVjaWZpZXIgKz0gIiIsIHV0Y0Zvcm1hdHMpOwogICAgICBmLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHNwZWNpZmllcjsKICAgICAgfTsKICAgICAgcmV0dXJuIGY7CiAgICB9LAogICAgdXRjUGFyc2U6IGZ1bmN0aW9uKHNwZWNpZmllcikgewogICAgICB2YXIgcCA9IG5ld1BhcnNlKHNwZWNpZmllciArPSAiIiwgdHJ1ZSk7CiAgICAgIHAudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc3BlY2lmaWVyOwogICAgICB9OwogICAgICByZXR1cm4gcDsKICAgIH0KICB9Owp9CnZhciBwYWRzID0geyAiLSI6ICIiLCAiXyI6ICIgIiwgIjAiOiAiMCIgfTsKdmFyIG51bWJlclJlID0gL15ccypcZCsvOwp2YXIgcGVyY2VudFJlID0gL14lLzsKdmFyIHJlcXVvdGVSZSA9IC9bXFxeJCorP3xbXF0oKS57fV0vZzsKZnVuY3Rpb24gcGFkKHZhbHVlLCBmaWxsLCB3aWR0aCkgewogIHZhciBzaWduMiA9IHZhbHVlIDwgMCA/ICItIiA6ICIiLCBzdHJpbmcgPSAoc2lnbjIgPyAtdmFsdWUgOiB2YWx1ZSkgKyAiIiwgbGVuZ3RoID0gc3RyaW5nLmxlbmd0aDsKICByZXR1cm4gc2lnbjIgKyAobGVuZ3RoIDwgd2lkdGggPyBuZXcgQXJyYXkod2lkdGggLSBsZW5ndGggKyAxKS5qb2luKGZpbGwpICsgc3RyaW5nIDogc3RyaW5nKTsKfQpmdW5jdGlvbiByZXF1b3RlKHMpIHsKICByZXR1cm4gcy5yZXBsYWNlKHJlcXVvdGVSZSwgIlxcJCYiKTsKfQpmdW5jdGlvbiBmb3JtYXRSZShuYW1lcykgewogIHJldHVybiBuZXcgUmVnRXhwKCJeKD86IiArIG5hbWVzLm1hcChyZXF1b3RlKS5qb2luKCJ8IikgKyAiKSIsICJpIik7Cn0KZnVuY3Rpb24gZm9ybWF0TG9va3VwKG5hbWVzKSB7CiAgcmV0dXJuIG5ldyBNYXAobmFtZXMubWFwKChuYW1lLCBpKSA9PiBbbmFtZS50b0xvd2VyQ2FzZSgpLCBpXSkpOwp9CmZ1bmN0aW9uIHBhcnNlV2Vla2RheU51bWJlclN1bmRheShkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAxKSk7CiAgcmV0dXJuIG4gPyAoZC53ID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVdlZWtkYXlOdW1iZXJNb25kYXkoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMSkpOwogIHJldHVybiBuID8gKGQudSA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VXZWVrTnVtYmVyU3VuZGF5KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLlUgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlV2Vla051bWJlcklTTyhkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5WID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVdlZWtOdW1iZXJNb25kYXkoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuVyA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VGdWxsWWVhcihkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyA0KSk7CiAgcmV0dXJuIG4gPyAoZC55ID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVllYXIoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQueSA9ICtuWzBdICsgKCtuWzBdID4gNjggPyAxOTAwIDogMmUzKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlWm9uZShkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IC9eKFopfChbKy1dXGRcZCkoPzo6PyhcZFxkKSk/Ly5leGVjKHN0cmluZy5zbGljZShpLCBpICsgNikpOwogIHJldHVybiBuID8gKGQuWiA9IG5bMV0gPyAwIDogLShuWzJdICsgKG5bM10gfHwgIjAwIikpLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VRdWFydGVyKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDEpKTsKICByZXR1cm4gbiA/IChkLnEgPSBuWzBdICogMyAtIDMsIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZU1vbnRoTnVtYmVyKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLm0gPSBuWzBdIC0gMSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlRGF5T2ZNb250aChkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5kID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZURheU9mWWVhcihkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAzKSk7CiAgcmV0dXJuIG4gPyAoZC5tID0gMCwgZC5kID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZUhvdXIyNChkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5IID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZU1pbnV0ZXMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuTSA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VTZWNvbmRzKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLlMgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlTWlsbGlzZWNvbmRzKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDMpKTsKICByZXR1cm4gbiA/IChkLkwgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlTWljcm9zZWNvbmRzKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDYpKTsKICByZXR1cm4gbiA/IChkLkwgPSBNYXRoLmZsb29yKG5bMF0gLyAxZTMpLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VMaXRlcmFsUGVyY2VudChkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IHBlcmNlbnRSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMSkpOwogIHJldHVybiBuID8gaSArIG5bMF0ubGVuZ3RoIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VVbml4VGltZXN0YW1wKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogIHJldHVybiBuID8gKGQuUSA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VVbml4VGltZXN0YW1wU2Vjb25kcyhkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICByZXR1cm4gbiA/IChkLnMgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIGZvcm1hdERheU9mTW9udGgoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXREYXRlKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdEhvdXIyNChkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldEhvdXJzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdEhvdXIxMihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldEhvdXJzKCkgJSAxMiB8fCAxMiwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0RGF5T2ZZZWFyKGQsIHApIHsKICByZXR1cm4gcGFkKDEgKyB0aW1lRGF5LmNvdW50KHRpbWVZZWFyKGQpLCBkKSwgcCwgMyk7Cn0KZnVuY3Rpb24gZm9ybWF0TWlsbGlzZWNvbmRzKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0TWlsbGlzZWNvbmRzKCksIHAsIDMpOwp9CmZ1bmN0aW9uIGZvcm1hdE1pY3Jvc2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIGZvcm1hdE1pbGxpc2Vjb25kcyhkLCBwKSArICIwMDAiOwp9CmZ1bmN0aW9uIGZvcm1hdE1vbnRoTnVtYmVyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0TW9udGgoKSArIDEsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdE1pbnV0ZXMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRNaW51dGVzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFNlY29uZHMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRTZWNvbmRzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFdlZWtkYXlOdW1iZXJNb25kYXkoZCkgewogIHZhciBkYXkgPSBkLmdldERheSgpOwogIHJldHVybiBkYXkgPT09IDAgPyA3IDogZGF5Owp9CmZ1bmN0aW9uIGZvcm1hdFdlZWtOdW1iZXJTdW5kYXkoZCwgcCkgewogIHJldHVybiBwYWQodGltZVN1bmRheS5jb3VudCh0aW1lWWVhcihkKSAtIDEsIGQpLCBwLCAyKTsKfQpmdW5jdGlvbiBkSVNPKGQpIHsKICB2YXIgZGF5ID0gZC5nZXREYXkoKTsKICByZXR1cm4gZGF5ID49IDQgfHwgZGF5ID09PSAwID8gdGltZVRodXJzZGF5KGQpIDogdGltZVRodXJzZGF5LmNlaWwoZCk7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla051bWJlcklTTyhkLCBwKSB7CiAgZCA9IGRJU08oZCk7CiAgcmV0dXJuIHBhZCh0aW1lVGh1cnNkYXkuY291bnQodGltZVllYXIoZCksIGQpICsgKHRpbWVZZWFyKGQpLmdldERheSgpID09PSA0KSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla2RheU51bWJlclN1bmRheShkKSB7CiAgcmV0dXJuIGQuZ2V0RGF5KCk7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla051bWJlck1vbmRheShkLCBwKSB7CiAgcmV0dXJuIHBhZCh0aW1lTW9uZGF5LmNvdW50KHRpbWVZZWFyKGQpIC0gMSwgZCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFllYXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRGdWxsWWVhcigpICUgMTAwLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRZZWFySVNPKGQsIHApIHsKICBkID0gZElTTyhkKTsKICByZXR1cm4gcGFkKGQuZ2V0RnVsbFllYXIoKSAlIDEwMCwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0RnVsbFllYXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRGdWxsWWVhcigpICUgMWU0LCBwLCA0KTsKfQpmdW5jdGlvbiBmb3JtYXRGdWxsWWVhcklTTyhkLCBwKSB7CiAgdmFyIGRheSA9IGQuZ2V0RGF5KCk7CiAgZCA9IGRheSA+PSA0IHx8IGRheSA9PT0gMCA/IHRpbWVUaHVyc2RheShkKSA6IHRpbWVUaHVyc2RheS5jZWlsKGQpOwogIHJldHVybiBwYWQoZC5nZXRGdWxsWWVhcigpICUgMWU0LCBwLCA0KTsKfQpmdW5jdGlvbiBmb3JtYXRab25lKGQpIHsKICB2YXIgeiA9IGQuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICByZXR1cm4gKHogPiAwID8gIi0iIDogKHogKj0gLTEsICIrIikpICsgcGFkKHogLyA2MCB8IDAsICIwIiwgMikgKyBwYWQoeiAlIDYwLCAiMCIsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ0RheU9mTW9udGgoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENEYXRlKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ0hvdXIyNChkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0hvdXJzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ0hvdXIxMihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0hvdXJzKCkgJSAxMiB8fCAxMiwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDRGF5T2ZZZWFyKGQsIHApIHsKICByZXR1cm4gcGFkKDEgKyB1dGNEYXkuY291bnQodXRjWWVhcihkKSwgZCksIHAsIDMpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ01pbGxpc2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ01pbGxpc2Vjb25kcygpLCBwLCAzKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENNaWNyb3NlY29uZHMoZCwgcCkgewogIHJldHVybiBmb3JtYXRVVENNaWxsaXNlY29uZHMoZCwgcCkgKyAiMDAwIjsKfQpmdW5jdGlvbiBmb3JtYXRVVENNb250aE51bWJlcihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ01vbnRoKCkgKyAxLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENNaW51dGVzKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDTWludXRlcygpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENTZWNvbmRzKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDU2Vjb25kcygpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrZGF5TnVtYmVyTW9uZGF5KGQpIHsKICB2YXIgZG93ID0gZC5nZXRVVENEYXkoKTsKICByZXR1cm4gZG93ID09PSAwID8gNyA6IGRvdzsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrTnVtYmVyU3VuZGF5KGQsIHApIHsKICByZXR1cm4gcGFkKHV0Y1N1bmRheS5jb3VudCh1dGNZZWFyKGQpIC0gMSwgZCksIHAsIDIpOwp9CmZ1bmN0aW9uIFVUQ2RJU08oZCkgewogIHZhciBkYXkgPSBkLmdldFVUQ0RheSgpOwogIHJldHVybiBkYXkgPj0gNCB8fCBkYXkgPT09IDAgPyB1dGNUaHVyc2RheShkKSA6IHV0Y1RodXJzZGF5LmNlaWwoZCk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDV2Vla051bWJlcklTTyhkLCBwKSB7CiAgZCA9IFVUQ2RJU08oZCk7CiAgcmV0dXJuIHBhZCh1dGNUaHVyc2RheS5jb3VudCh1dGNZZWFyKGQpLCBkKSArICh1dGNZZWFyKGQpLmdldFVUQ0RheSgpID09PSA0KSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDV2Vla2RheU51bWJlclN1bmRheShkKSB7CiAgcmV0dXJuIGQuZ2V0VVRDRGF5KCk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDV2Vla051bWJlck1vbmRheShkLCBwKSB7CiAgcmV0dXJuIHBhZCh1dGNNb25kYXkuY291bnQodXRjWWVhcihkKSAtIDEsIGQpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENZZWFyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDRnVsbFllYXIoKSAlIDEwMCwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDWWVhcklTTyhkLCBwKSB7CiAgZCA9IFVUQ2RJU08oZCk7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0Z1bGxZZWFyKCkgJSAxMDAsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ0Z1bGxZZWFyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDRnVsbFllYXIoKSAlIDFlNCwgcCwgNCk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDRnVsbFllYXJJU08oZCwgcCkgewogIHZhciBkYXkgPSBkLmdldFVUQ0RheSgpOwogIGQgPSBkYXkgPj0gNCB8fCBkYXkgPT09IDAgPyB1dGNUaHVyc2RheShkKSA6IHV0Y1RodXJzZGF5LmNlaWwoZCk7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0Z1bGxZZWFyKCkgJSAxZTQsIHAsIDQpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1pvbmUoKSB7CiAgcmV0dXJuICIrMDAwMCI7Cn0KZnVuY3Rpb24gZm9ybWF0TGl0ZXJhbFBlcmNlbnQoKSB7CiAgcmV0dXJuICIlIjsKfQpmdW5jdGlvbiBmb3JtYXRVbml4VGltZXN0YW1wKGQpIHsKICByZXR1cm4gK2Q7Cn0KZnVuY3Rpb24gZm9ybWF0VW5peFRpbWVzdGFtcFNlY29uZHMoZCkgewogIHJldHVybiBNYXRoLmZsb29yKCtkIC8gMWUzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXRpbWUtZm9ybWF0L3NyYy9kZWZhdWx0TG9jYWxlLmpzCnZhciBsb2NhbGUyOwp2YXIgdGltZUZvcm1hdDsKdmFyIHRpbWVQYXJzZTsKdmFyIHV0Y0Zvcm1hdDsKdmFyIHV0Y1BhcnNlOwpkZWZhdWx0TG9jYWxlMih7CiAgZGF0ZVRpbWU6ICIleCwgJVgiLAogIGRhdGU6ICIlLW0vJS1kLyVZIiwKICB0aW1lOiAiJS1JOiVNOiVTICVwIiwKICBwZXJpb2RzOiBbIkFNIiwgIlBNIl0sCiAgZGF5czogWyJTdW5kYXkiLCAiTW9uZGF5IiwgIlR1ZXNkYXkiLCAiV2VkbmVzZGF5IiwgIlRodXJzZGF5IiwgIkZyaWRheSIsICJTYXR1cmRheSJdLAogIHNob3J0RGF5czogWyJTdW4iLCAiTW9uIiwgIlR1ZSIsICJXZWQiLCAiVGh1IiwgIkZyaSIsICJTYXQiXSwKICBtb250aHM6IFsiSmFudWFyeSIsICJGZWJydWFyeSIsICJNYXJjaCIsICJBcHJpbCIsICJNYXkiLCAiSnVuZSIsICJKdWx5IiwgIkF1Z3VzdCIsICJTZXB0ZW1iZXIiLCAiT2N0b2JlciIsICJOb3ZlbWJlciIsICJEZWNlbWJlciJdLAogIHNob3J0TW9udGhzOiBbIkphbiIsICJGZWIiLCAiTWFyIiwgIkFwciIsICJNYXkiLCAiSnVuIiwgIkp1bCIsICJBdWciLCAiU2VwIiwgIk9jdCIsICJOb3YiLCAiRGVjIl0KfSk7CmZ1bmN0aW9uIGRlZmF1bHRMb2NhbGUyKGRlZmluaXRpb24pIHsKICBsb2NhbGUyID0gZm9ybWF0TG9jYWxlKGRlZmluaXRpb24pOwogIHRpbWVGb3JtYXQgPSBsb2NhbGUyLmZvcm1hdDsKICB0aW1lUGFyc2UgPSBsb2NhbGUyLnBhcnNlOwogIHV0Y0Zvcm1hdCA9IGxvY2FsZTIudXRjRm9ybWF0OwogIHV0Y1BhcnNlID0gbG9jYWxlMi51dGNQYXJzZTsKICByZXR1cm4gbG9jYWxlMjsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy90aW1lLmpzCmZ1bmN0aW9uIGRhdGUodCkgewogIHJldHVybiBuZXcgRGF0ZSh0KTsKfQpmdW5jdGlvbiBudW1iZXIzKHQpIHsKICByZXR1cm4gdCBpbnN0YW5jZW9mIERhdGUgPyArdCA6ICsvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK3QpOwp9CmZ1bmN0aW9uIGNhbGVuZGFyKHRpY2tzMiwgdGlja0ludGVydmFsLCB5ZWFyLCBtb250aCwgd2VlaywgZGF5LCBob3VyLCBtaW51dGUsIHNlY29uZDIsIGZvcm1hdDIpIHsKICB2YXIgc2NhbGUgPSBjb250aW51b3VzKCksIGludmVydCA9IHNjYWxlLmludmVydCwgZG9tYWluID0gc2NhbGUuZG9tYWluOwogIHZhciBmb3JtYXRNaWxsaXNlY29uZCA9IGZvcm1hdDIoIi4lTCIpLCBmb3JtYXRTZWNvbmQgPSBmb3JtYXQyKCI6JVMiKSwgZm9ybWF0TWludXRlID0gZm9ybWF0MigiJUk6JU0iKSwgZm9ybWF0SG91ciA9IGZvcm1hdDIoIiVJICVwIiksIGZvcm1hdERheSA9IGZvcm1hdDIoIiVhICVkIiksIGZvcm1hdFdlZWsgPSBmb3JtYXQyKCIlYiAlZCIpLCBmb3JtYXRNb250aCA9IGZvcm1hdDIoIiVCIiksIGZvcm1hdFllYXIyID0gZm9ybWF0MigiJVkiKTsKICBmdW5jdGlvbiB0aWNrRm9ybWF0MihkYXRlMikgewogICAgcmV0dXJuIChzZWNvbmQyKGRhdGUyKSA8IGRhdGUyID8gZm9ybWF0TWlsbGlzZWNvbmQgOiBtaW51dGUoZGF0ZTIpIDwgZGF0ZTIgPyBmb3JtYXRTZWNvbmQgOiBob3VyKGRhdGUyKSA8IGRhdGUyID8gZm9ybWF0TWludXRlIDogZGF5KGRhdGUyKSA8IGRhdGUyID8gZm9ybWF0SG91ciA6IG1vbnRoKGRhdGUyKSA8IGRhdGUyID8gd2VlayhkYXRlMikgPCBkYXRlMiA/IGZvcm1hdERheSA6IGZvcm1hdFdlZWsgOiB5ZWFyKGRhdGUyKSA8IGRhdGUyID8gZm9ybWF0TW9udGggOiBmb3JtYXRZZWFyMikoZGF0ZTIpOwogIH0KICBzY2FsZS5pbnZlcnQgPSBmdW5jdGlvbih5MikgewogICAgcmV0dXJuIG5ldyBEYXRlKGludmVydCh5MikpOwogIH07CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyBkb21haW4oQXJyYXkuZnJvbShfLCBudW1iZXIzKSkgOiBkb21haW4oKS5tYXAoZGF0ZSk7CiAgfTsKICBzY2FsZS50aWNrcyA9IGZ1bmN0aW9uKGludGVydmFsKSB7CiAgICB2YXIgZCA9IGRvbWFpbigpOwogICAgcmV0dXJuIHRpY2tzMihkWzBdLCBkW2QubGVuZ3RoIC0gMV0sIGludGVydmFsID09IG51bGwgPyAxMCA6IGludGVydmFsKTsKICB9OwogIHNjYWxlLnRpY2tGb3JtYXQgPSBmdW5jdGlvbihjb3VudCwgc3BlY2lmaWVyKSB7CiAgICByZXR1cm4gc3BlY2lmaWVyID09IG51bGwgPyB0aWNrRm9ybWF0MiA6IGZvcm1hdDIoc3BlY2lmaWVyKTsKICB9OwogIHNjYWxlLm5pY2UgPSBmdW5jdGlvbihpbnRlcnZhbCkgewogICAgdmFyIGQgPSBkb21haW4oKTsKICAgIGlmICghaW50ZXJ2YWwgfHwgdHlwZW9mIGludGVydmFsLnJhbmdlICE9PSAiZnVuY3Rpb24iKSBpbnRlcnZhbCA9IHRpY2tJbnRlcnZhbChkWzBdLCBkW2QubGVuZ3RoIC0gMV0sIGludGVydmFsID09IG51bGwgPyAxMCA6IGludGVydmFsKTsKICAgIHJldHVybiBpbnRlcnZhbCA/IGRvbWFpbihuaWNlKGQsIGludGVydmFsKSkgOiBzY2FsZTsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5KHNjYWxlLCBjYWxlbmRhcih0aWNrczIsIHRpY2tJbnRlcnZhbCwgeWVhciwgbW9udGgsIHdlZWssIGRheSwgaG91ciwgbWludXRlLCBzZWNvbmQyLCBmb3JtYXQyKSk7CiAgfTsKICByZXR1cm4gc2NhbGU7Cn0KZnVuY3Rpb24gdGltZSgpIHsKICByZXR1cm4gaW5pdFJhbmdlLmFwcGx5KGNhbGVuZGFyKHRpbWVUaWNrcywgdGltZVRpY2tJbnRlcnZhbCwgdGltZVllYXIsIHRpbWVNb250aCwgdGltZVN1bmRheSwgdGltZURheSwgdGltZUhvdXIsIHRpbWVNaW51dGUsIHNlY29uZCwgdGltZUZvcm1hdCkuZG9tYWluKFtuZXcgRGF0ZSgyZTMsIDAsIDEpLCBuZXcgRGF0ZSgyZTMsIDAsIDIpXSksIGFyZ3VtZW50cyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvdXRjVGltZS5qcwpmdW5jdGlvbiB1dGNUaW1lKCkgewogIHJldHVybiBpbml0UmFuZ2UuYXBwbHkoY2FsZW5kYXIodXRjVGlja3MsIHV0Y1RpY2tJbnRlcnZhbCwgdXRjWWVhciwgdXRjTW9udGgsIHV0Y1N1bmRheSwgdXRjRGF5LCB1dGNIb3VyLCB1dGNNaW51dGUsIHNlY29uZCwgdXRjRm9ybWF0KS5kb21haW4oW0RhdGUuVVRDKDJlMywgMCwgMSksIERhdGUuVVRDKDJlMywgMCwgMildKSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9zZXF1ZW50aWFsLmpzCmZ1bmN0aW9uIHRyYW5zZm9ybWVyMigpIHsKICB2YXIgeDAgPSAwLCB4MSA9IDEsIHQwMiwgdDEyLCBrMTAsIHRyYW5zZm9ybSwgaW50ZXJwb2xhdG9yID0gaWRlbnRpdHksIGNsYW1wID0gZmFsc2UsIHVua25vd247CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiA9PSBudWxsIHx8IGlzTmFOKHgyID0gK3gyKSA/IHVua25vd24gOiBpbnRlcnBvbGF0b3IoazEwID09PSAwID8gMC41IDogKHgyID0gKHRyYW5zZm9ybSh4MikgLSB0MDIpICogazEwLCBjbGFtcCA/IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHgyKSkgOiB4MikpOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbeDAsIHgxXSA9IF8sIHQwMiA9IHRyYW5zZm9ybSh4MCA9ICt4MCksIHQxMiA9IHRyYW5zZm9ybSh4MSA9ICt4MSksIGsxMCA9IHQwMiA9PT0gdDEyID8gMCA6IDEgLyAodDEyIC0gdDAyKSwgc2NhbGUpIDogW3gwLCB4MV07CiAgfTsKICBzY2FsZS5jbGFtcCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGNsYW1wID0gISFfLCBzY2FsZSkgOiBjbGFtcDsKICB9OwogIHNjYWxlLmludGVycG9sYXRvciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGludGVycG9sYXRvciA9IF8sIHNjYWxlKSA6IGludGVycG9sYXRvcjsKICB9OwogIGZ1bmN0aW9uIHJhbmdlNChpbnRlcnBvbGF0ZTIpIHsKICAgIHJldHVybiBmdW5jdGlvbihfKSB7CiAgICAgIHZhciByMCwgcjE7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKFtyMCwgcjFdID0gXywgaW50ZXJwb2xhdG9yID0gaW50ZXJwb2xhdGUyKHIwLCByMSksIHNjYWxlKSA6IFtpbnRlcnBvbGF0b3IoMCksIGludGVycG9sYXRvcigxKV07CiAgICB9OwogIH0KICBzY2FsZS5yYW5nZSA9IHJhbmdlNCh2YWx1ZV9kZWZhdWx0KTsKICBzY2FsZS5yYW5nZVJvdW5kID0gcmFuZ2U0KHJvdW5kX2RlZmF1bHQpOwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICB0cmFuc2Zvcm0gPSB0LCB0MDIgPSB0KHgwKSwgdDEyID0gdCh4MSksIGsxMCA9IHQwMiA9PT0gdDEyID8gMCA6IDEgLyAodDEyIC0gdDAyKTsKICAgIHJldHVybiBzY2FsZTsKICB9Owp9CmZ1bmN0aW9uIGNvcHkyKHNvdXJjZSwgdGFyZ2V0KSB7CiAgcmV0dXJuIHRhcmdldC5kb21haW4oc291cmNlLmRvbWFpbigpKS5pbnRlcnBvbGF0b3Ioc291cmNlLmludGVycG9sYXRvcigpKS5jbGFtcChzb3VyY2UuY2xhbXAoKSkudW5rbm93bihzb3VyY2UudW5rbm93bigpKTsKfQpmdW5jdGlvbiBzZXF1ZW50aWFsKCkgewogIHZhciBzY2FsZSA9IGxpbmVhcmlzaCh0cmFuc2Zvcm1lcjIoKShpZGVudGl0eSkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgc2VxdWVudGlhbCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIHNlcXVlbnRpYWxMb2coKSB7CiAgdmFyIHNjYWxlID0gbG9nZ2lzaCh0cmFuc2Zvcm1lcjIoKSkuZG9tYWluKFsxLCAxMF0pOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgc2VxdWVudGlhbExvZygpKS5iYXNlKHNjYWxlLmJhc2UoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBzZXF1ZW50aWFsU3ltbG9nKCkgewogIHZhciBzY2FsZSA9IHN5bWxvZ2lzaCh0cmFuc2Zvcm1lcjIoKSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkyKHNjYWxlLCBzZXF1ZW50aWFsU3ltbG9nKCkpLmNvbnN0YW50KHNjYWxlLmNvbnN0YW50KCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gc2VxdWVudGlhbFBvdygpIHsKICB2YXIgc2NhbGUgPSBwb3dpc2godHJhbnNmb3JtZXIyKCkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgc2VxdWVudGlhbFBvdygpKS5leHBvbmVudChzY2FsZS5leHBvbmVudCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIHNlcXVlbnRpYWxTcXJ0KCkgewogIHJldHVybiBzZXF1ZW50aWFsUG93LmFwcGx5KG51bGwsIGFyZ3VtZW50cykuZXhwb25lbnQoMC41KTsKfQoKLy8gbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9zZXF1ZW50aWFsUXVhbnRpbGUuanMKZnVuY3Rpb24gc2VxdWVudGlhbFF1YW50aWxlKCkgewogIHZhciBkb21haW4gPSBbXSwgaW50ZXJwb2xhdG9yID0gaWRlbnRpdHk7CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIGlmICh4MiAhPSBudWxsICYmICFpc05hTih4MiA9ICt4MikpIHJldHVybiBpbnRlcnBvbGF0b3IoKGJpc2VjdF9kZWZhdWx0KGRvbWFpbiwgeDIsIDEpIC0gMSkgLyAoZG9tYWluLmxlbmd0aCAtIDEpKTsKICB9CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gZG9tYWluLnNsaWNlKCk7CiAgICBkb21haW4gPSBbXTsKICAgIGZvciAobGV0IGQgb2YgXykgaWYgKGQgIT0gbnVsbCAmJiAhaXNOYU4oZCA9ICtkKSkgZG9tYWluLnB1c2goZCk7CiAgICBkb21haW4uc29ydChhc2NlbmRpbmcpOwogICAgcmV0dXJuIHNjYWxlOwogIH07CiAgc2NhbGUuaW50ZXJwb2xhdG9yID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoaW50ZXJwb2xhdG9yID0gXywgc2NhbGUpIDogaW50ZXJwb2xhdG9yOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBkb21haW4ubWFwKChkLCBpKSA9PiBpbnRlcnBvbGF0b3IoaSAvIChkb21haW4ubGVuZ3RoIC0gMSkpKTsKICB9OwogIHNjYWxlLnF1YW50aWxlcyA9IGZ1bmN0aW9uKG4pIHsKICAgIHJldHVybiBBcnJheS5mcm9tKHsgbGVuZ3RoOiBuICsgMSB9LCAoXywgaSkgPT4gcXVhbnRpbGUoZG9tYWluLCBpIC8gbikpOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHNlcXVlbnRpYWxRdWFudGlsZShpbnRlcnBvbGF0b3IpLmRvbWFpbihkb21haW4pOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvZGl2ZXJnaW5nLmpzCmZ1bmN0aW9uIHRyYW5zZm9ybWVyMygpIHsKICB2YXIgeDAgPSAwLCB4MSA9IDAuNSwgeDIgPSAxLCBzID0gMSwgdDAyLCB0MTIsIHQyLCBrMTAsIGsyMSwgaW50ZXJwb2xhdG9yID0gaWRlbnRpdHksIHRyYW5zZm9ybSwgY2xhbXAgPSBmYWxzZSwgdW5rbm93bjsKICBmdW5jdGlvbiBzY2FsZSh4MykgewogICAgcmV0dXJuIGlzTmFOKHgzID0gK3gzKSA/IHVua25vd24gOiAoeDMgPSAwLjUgKyAoKHgzID0gK3RyYW5zZm9ybSh4MykpIC0gdDEyKSAqIChzICogeDMgPCBzICogdDEyID8gazEwIDogazIxKSwgaW50ZXJwb2xhdG9yKGNsYW1wID8gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgeDMpKSA6IHgzKSk7CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKFt4MCwgeDEsIHgyXSA9IF8sIHQwMiA9IHRyYW5zZm9ybSh4MCA9ICt4MCksIHQxMiA9IHRyYW5zZm9ybSh4MSA9ICt4MSksIHQyID0gdHJhbnNmb3JtKHgyID0gK3gyKSwgazEwID0gdDAyID09PSB0MTIgPyAwIDogMC41IC8gKHQxMiAtIHQwMiksIGsyMSA9IHQxMiA9PT0gdDIgPyAwIDogMC41IC8gKHQyIC0gdDEyKSwgcyA9IHQxMiA8IHQwMiA/IC0xIDogMSwgc2NhbGUpIDogW3gwLCB4MSwgeDJdOwogIH07CiAgc2NhbGUuY2xhbXAgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChjbGFtcCA9ICEhXywgc2NhbGUpIDogY2xhbXA7CiAgfTsKICBzY2FsZS5pbnRlcnBvbGF0b3IgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChpbnRlcnBvbGF0b3IgPSBfLCBzY2FsZSkgOiBpbnRlcnBvbGF0b3I7CiAgfTsKICBmdW5jdGlvbiByYW5nZTQoaW50ZXJwb2xhdGUyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oXykgewogICAgICB2YXIgcjAsIHIxLCByMjsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoW3IwLCByMSwgcjJdID0gXywgaW50ZXJwb2xhdG9yID0gcGllY2V3aXNlKGludGVycG9sYXRlMiwgW3IwLCByMSwgcjJdKSwgc2NhbGUpIDogW2ludGVycG9sYXRvcigwKSwgaW50ZXJwb2xhdG9yKDAuNSksIGludGVycG9sYXRvcigxKV07CiAgICB9OwogIH0KICBzY2FsZS5yYW5nZSA9IHJhbmdlNCh2YWx1ZV9kZWZhdWx0KTsKICBzY2FsZS5yYW5nZVJvdW5kID0gcmFuZ2U0KHJvdW5kX2RlZmF1bHQpOwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICB0cmFuc2Zvcm0gPSB0LCB0MDIgPSB0KHgwKSwgdDEyID0gdCh4MSksIHQyID0gdCh4MiksIGsxMCA9IHQwMiA9PT0gdDEyID8gMCA6IDAuNSAvICh0MTIgLSB0MDIpLCBrMjEgPSB0MTIgPT09IHQyID8gMCA6IDAuNSAvICh0MiAtIHQxMiksIHMgPSB0MTIgPCB0MDIgPyAtMSA6IDE7CiAgICByZXR1cm4gc2NhbGU7CiAgfTsKfQpmdW5jdGlvbiBkaXZlcmdpbmcoKSB7CiAgdmFyIHNjYWxlID0gbGluZWFyaXNoKHRyYW5zZm9ybWVyMygpKGlkZW50aXR5KSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkyKHNjYWxlLCBkaXZlcmdpbmcoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBkaXZlcmdpbmdMb2coKSB7CiAgdmFyIHNjYWxlID0gbG9nZ2lzaCh0cmFuc2Zvcm1lcjMoKSkuZG9tYWluKFswLjEsIDEsIDEwXSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkyKHNjYWxlLCBkaXZlcmdpbmdMb2coKSkuYmFzZShzY2FsZS5iYXNlKCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gZGl2ZXJnaW5nU3ltbG9nKCkgewogIHZhciBzY2FsZSA9IHN5bWxvZ2lzaCh0cmFuc2Zvcm1lcjMoKSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkyKHNjYWxlLCBkaXZlcmdpbmdTeW1sb2coKSkuY29uc3RhbnQoc2NhbGUuY29uc3RhbnQoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBkaXZlcmdpbmdQb3coKSB7CiAgdmFyIHNjYWxlID0gcG93aXNoKHRyYW5zZm9ybWVyMygpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIGRpdmVyZ2luZ1BvdygpKS5leHBvbmVudChzY2FsZS5leHBvbmVudCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIGRpdmVyZ2luZ1NxcnQoKSB7CiAgcmV0dXJuIGRpdmVyZ2luZ1Bvdy5hcHBseShudWxsLCBhcmd1bWVudHMpLmV4cG9uZW50KDAuNSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2RhdGFTZWxlY3RvcnMuanMKdmFyIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzID0gKHN0YXRlKSA9PiBzdGF0ZS5jaGFydERhdGE7CnZhciBzZWxlY3RDaGFydERhdGFBbmRBbHdheXNJZ25vcmVJbmRleGVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzXSwgKGRhdGFTdGF0ZSkgPT4gewogIHZhciBkYXRhRW5kSW5kZXggPSBkYXRhU3RhdGUuY2hhcnREYXRhICE9IG51bGwgPyBkYXRhU3RhdGUuY2hhcnREYXRhLmxlbmd0aCAtIDEgOiAwOwogIHJldHVybiB7CiAgICBjaGFydERhdGE6IGRhdGFTdGF0ZS5jaGFydERhdGEsCiAgICBjb21wdXRlZERhdGE6IGRhdGFTdGF0ZS5jb21wdXRlZERhdGEsCiAgICBkYXRhRW5kSW5kZXgsCiAgICBkYXRhU3RhcnRJbmRleDogMAogIH07Cn0pOwp2YXIgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXNJZk5vdEluUGFub3JhbWEgPSAoc3RhdGUsIF91bnVzZWQxLCBfdW51c2VkMiwgaXNQYW5vcmFtYSkgPT4gewogIGlmIChpc1Bhbm9yYW1hKSB7CiAgICByZXR1cm4gc2VsZWN0Q2hhcnREYXRhQW5kQWx3YXlzSWdub3JlSW5kZXhlcyhzdGF0ZSk7CiAgfQogIHJldHVybiBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlcyhzdGF0ZSk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvaXNEb21haW5TcGVjaWZpZWRCeVVzZXIuanMKZnVuY3Rpb24gaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKHYpIHsKICBpZiAoQXJyYXkuaXNBcnJheSh2KSAmJiB2Lmxlbmd0aCA9PT0gMikgewogICAgdmFyIFttaW4yLCBtYXgyXSA9IHY7CiAgICBpZiAoaXNXZWxsQmVoYXZlZE51bWJlcihtaW4yKSAmJiBpc1dlbGxCZWhhdmVkTnVtYmVyKG1heDIpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn0KZnVuY3Rpb24gZXh0ZW5kRG9tYWluKHByb3ZpZGVkRG9tYWluLCBib3VuZGFyeURvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpIHsKICBpZiAoYWxsb3dEYXRhT3ZlcmZsb3cpIHsKICAgIHJldHVybiBwcm92aWRlZERvbWFpbjsKICB9CiAgcmV0dXJuIFtNYXRoLm1pbihwcm92aWRlZERvbWFpblswXSwgYm91bmRhcnlEb21haW5bMF0pLCBNYXRoLm1heChwcm92aWRlZERvbWFpblsxXSwgYm91bmRhcnlEb21haW5bMV0pXTsKfQpmdW5jdGlvbiBudW1lcmljYWxEb21haW5TcGVjaWZpZWRXaXRob3V0UmVxdWlyaW5nRGF0YSh1c2VyRG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdykgewogIGlmICghYWxsb3dEYXRhT3ZlcmZsb3cpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmICh0eXBlb2YgdXNlckRvbWFpbiA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKEFycmF5LmlzQXJyYXkodXNlckRvbWFpbikgJiYgdXNlckRvbWFpbi5sZW5ndGggPT09IDIpIHsKICAgIHZhciBbcHJvdmlkZWRNaW4sIHByb3ZpZGVkTWF4XSA9IHVzZXJEb21haW47CiAgICB2YXIgZmluYWxNaW4sIGZpbmFsTWF4OwogICAgaWYgKGlzV2VsbEJlaGF2ZWROdW1iZXIocHJvdmlkZWRNaW4pKSB7CiAgICAgIGZpbmFsTWluID0gcHJvdmlkZWRNaW47CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm92aWRlZE1pbiA9PT0gImZ1bmN0aW9uIikgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgaWYgKGlzV2VsbEJlaGF2ZWROdW1iZXIocHJvdmlkZWRNYXgpKSB7CiAgICAgIGZpbmFsTWF4ID0gcHJvdmlkZWRNYXg7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm92aWRlZE1heCA9PT0gImZ1bmN0aW9uIikgewogICAgICByZXR1cm4gdm9pZCAwOwogICAgfQogICAgdmFyIGNhbmRpZGF0ZSA9IFtmaW5hbE1pbiwgZmluYWxNYXhdOwogICAgaWYgKGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbihjYW5kaWRhdGUpKSB7CiAgICAgIHJldHVybiBjYW5kaWRhdGU7CiAgICB9CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KZnVuY3Rpb24gcGFyc2VOdW1lcmljYWxVc2VyRG9tYWluKHVzZXJEb21haW4sIGRhdGFEb21haW4sIGFsbG93RGF0YU92ZXJmbG93KSB7CiAgaWYgKCFhbGxvd0RhdGFPdmVyZmxvdyAmJiBkYXRhRG9tYWluID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmICh0eXBlb2YgdXNlckRvbWFpbiA9PT0gImZ1bmN0aW9uIiAmJiBkYXRhRG9tYWluICE9IG51bGwpIHsKICAgIHRyeSB7CiAgICAgIHZhciByZXN1bHQgPSB1c2VyRG9tYWluKGRhdGFEb21haW4sIGFsbG93RGF0YU92ZXJmbG93KTsKICAgICAgaWYgKGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbihyZXN1bHQpKSB7CiAgICAgICAgcmV0dXJuIGV4dGVuZERvbWFpbihyZXN1bHQsIGRhdGFEb21haW4sIGFsbG93RGF0YU92ZXJmbG93KTsKICAgICAgfQogICAgfSBjYXRjaCAoX3VudXNlZCkgewogICAgfQogIH0KICBpZiAoQXJyYXkuaXNBcnJheSh1c2VyRG9tYWluKSAmJiB1c2VyRG9tYWluLmxlbmd0aCA9PT0gMikgewogICAgdmFyIFtwcm92aWRlZE1pbiwgcHJvdmlkZWRNYXhdID0gdXNlckRvbWFpbjsKICAgIHZhciBmaW5hbE1pbiwgZmluYWxNYXg7CiAgICBpZiAocHJvdmlkZWRNaW4gPT09ICJhdXRvIikgewogICAgICBpZiAoZGF0YURvbWFpbiAhPSBudWxsKSB7CiAgICAgICAgZmluYWxNaW4gPSBNYXRoLm1pbiguLi5kYXRhRG9tYWluKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc051bWJlcihwcm92aWRlZE1pbikpIHsKICAgICAgZmluYWxNaW4gPSBwcm92aWRlZE1pbjsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWluID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHRyeSB7CiAgICAgICAgaWYgKGRhdGFEb21haW4gIT0gbnVsbCkgewogICAgICAgICAgZmluYWxNaW4gPSBwcm92aWRlZE1pbihkYXRhRG9tYWluID09PSBudWxsIHx8IGRhdGFEb21haW4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGFEb21haW5bMF0pOwogICAgICAgIH0KICAgICAgfSBjYXRjaCAoX3VudXNlZDIpIHsKICAgICAgfQogICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvdmlkZWRNaW4gPT09ICJzdHJpbmciICYmIE1JTl9WQUxVRV9SRUcudGVzdChwcm92aWRlZE1pbikpIHsKICAgICAgdmFyIG1hdGNoID0gTUlOX1ZBTFVFX1JFRy5leGVjKHByb3ZpZGVkTWluKTsKICAgICAgaWYgKG1hdGNoID09IG51bGwgfHwgZGF0YURvbWFpbiA9PSBudWxsKSB7CiAgICAgICAgZmluYWxNaW4gPSB2b2lkIDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHZhbHVlID0gK21hdGNoWzFdOwogICAgICAgIGZpbmFsTWluID0gZGF0YURvbWFpblswXSAtIHZhbHVlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmaW5hbE1pbiA9IGRhdGFEb21haW4gPT09IG51bGwgfHwgZGF0YURvbWFpbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YURvbWFpblswXTsKICAgIH0KICAgIGlmIChwcm92aWRlZE1heCA9PT0gImF1dG8iKSB7CiAgICAgIGlmIChkYXRhRG9tYWluICE9IG51bGwpIHsKICAgICAgICBmaW5hbE1heCA9IE1hdGgubWF4KC4uLmRhdGFEb21haW4pOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzTnVtYmVyKHByb3ZpZGVkTWF4KSkgewogICAgICBmaW5hbE1heCA9IHByb3ZpZGVkTWF4OwogICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvdmlkZWRNYXggPT09ICJmdW5jdGlvbiIpIHsKICAgICAgdHJ5IHsKICAgICAgICBpZiAoZGF0YURvbWFpbiAhPSBudWxsKSB7CiAgICAgICAgICBmaW5hbE1heCA9IHByb3ZpZGVkTWF4KGRhdGFEb21haW4gPT09IG51bGwgfHwgZGF0YURvbWFpbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YURvbWFpblsxXSk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChfdW51c2VkMykgewogICAgICB9CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm92aWRlZE1heCA9PT0gInN0cmluZyIgJiYgTUFYX1ZBTFVFX1JFRy50ZXN0KHByb3ZpZGVkTWF4KSkgewogICAgICB2YXIgX21hdGNoID0gTUFYX1ZBTFVFX1JFRy5leGVjKHByb3ZpZGVkTWF4KTsKICAgICAgaWYgKF9tYXRjaCA9PSBudWxsIHx8IGRhdGFEb21haW4gPT0gbnVsbCkgewogICAgICAgIGZpbmFsTWF4ID0gdm9pZCAwOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBfdmFsdWUgPSArX21hdGNoWzFdOwogICAgICAgIGZpbmFsTWF4ID0gZGF0YURvbWFpblsxXSArIF92YWx1ZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZmluYWxNYXggPSBkYXRhRG9tYWluID09PSBudWxsIHx8IGRhdGFEb21haW4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGFEb21haW5bMV07CiAgICB9CiAgICB2YXIgY2FuZGlkYXRlID0gW2ZpbmFsTWluLCBmaW5hbE1heF07CiAgICBpZiAoaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKGNhbmRpZGF0ZSkpIHsKICAgICAgaWYgKGRhdGFEb21haW4gPT0gbnVsbCkgewogICAgICAgIHJldHVybiBjYW5kaWRhdGU7CiAgICAgIH0KICAgICAgcmV0dXJuIGV4dGVuZERvbWFpbihjYW5kaWRhdGUsIGRhdGFEb21haW4sIGFsbG93RGF0YU92ZXJmbG93KTsKICAgIH0KICB9CiAgcmV0dXJuIHZvaWQgMDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3NjYWxlL2dldE5pY2VUaWNrVmFsdWVzLmpzCnZhciBpbXBvcnRfZGVjaW1hbDIgPSBfX3RvRVNNKHJlcXVpcmVfZGVjaW1hbCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zY2FsZS91dGlsL3V0aWxzLmpzCnZhciBpZGVudGl0eTMgPSAoaSkgPT4gaTsKdmFyIFBMQUNFX0hPTERFUiA9IHsKICAiQEBmdW5jdGlvbmFsL3BsYWNlaG9sZGVyIjogdHJ1ZQp9Owp2YXIgaXNQbGFjZUhvbGRlciA9ICh2YWwpID0+IHZhbCA9PT0gUExBQ0VfSE9MREVSOwp2YXIgY3VycnkwID0gKGZuKSA9PiBmdW5jdGlvbiBfY3VycmllZCgpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCB8fCBhcmd1bWVudHMubGVuZ3RoID09PSAxICYmIGlzUGxhY2VIb2xkZXIoYXJndW1lbnRzLmxlbmd0aCA8PSAwID8gdm9pZCAwIDogYXJndW1lbnRzWzBdKSkgewogICAgcmV0dXJuIF9jdXJyaWVkOwogIH0KICByZXR1cm4gZm4oLi4uYXJndW1lbnRzKTsKfTsKdmFyIGN1cnJ5TiA9IChuLCBmbikgPT4gewogIGlmIChuID09PSAxKSB7CiAgICByZXR1cm4gZm47CiAgfQogIHJldHVybiBjdXJyeTAoZnVuY3Rpb24oKSB7CiAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgYXJnc1tfa2V5XSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgIH0KICAgIHZhciBhcmdzTGVuZ3RoID0gYXJncy5maWx0ZXIoKGFyZykgPT4gYXJnICE9PSBQTEFDRV9IT0xERVIpLmxlbmd0aDsKICAgIGlmIChhcmdzTGVuZ3RoID49IG4pIHsKICAgICAgcmV0dXJuIGZuKC4uLmFyZ3MpOwogICAgfQogICAgcmV0dXJuIGN1cnJ5TihuIC0gYXJnc0xlbmd0aCwgY3VycnkwKGZ1bmN0aW9uKCkgewogICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIHJlc3RBcmdzID0gbmV3IEFycmF5KF9sZW4yKSwgX2tleTIgPSAwOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgcmVzdEFyZ3NbX2tleTJdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgfQogICAgICB2YXIgbmV3QXJncyA9IGFyZ3MubWFwKChhcmcpID0+IGlzUGxhY2VIb2xkZXIoYXJnKSA/IHJlc3RBcmdzLnNoaWZ0KCkgOiBhcmcpOwogICAgICByZXR1cm4gZm4oLi4ubmV3QXJncywgLi4ucmVzdEFyZ3MpOwogICAgfSkpOwogIH0pOwp9Owp2YXIgY3VycnkgPSAoZm4pID0+IGN1cnJ5Tihmbi5sZW5ndGgsIGZuKTsKdmFyIHJhbmdlMiA9IChiZWdpbiwgZW5kKSA9PiB7CiAgdmFyIGFyciA9IFtdOwogIGZvciAodmFyIGkgPSBiZWdpbjsgaSA8IGVuZDsgKytpKSB7CiAgICBhcnJbaSAtIGJlZ2luXSA9IGk7CiAgfQogIHJldHVybiBhcnI7Cn07CnZhciBtYXAyID0gY3VycnkoKGZuLCBhcnIpID0+IHsKICBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSB7CiAgICByZXR1cm4gYXJyLm1hcChmbik7CiAgfQogIHJldHVybiBPYmplY3Qua2V5cyhhcnIpLm1hcCgoa2V5KSA9PiBhcnJba2V5XSkubWFwKGZuKTsKfSk7CnZhciBjb21wb3NlMiA9IGZ1bmN0aW9uIGNvbXBvc2UzKCkgewogIGZvciAodmFyIF9sZW4zID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMyksIF9rZXkzID0gMDsgX2tleTMgPCBfbGVuMzsgX2tleTMrKykgewogICAgYXJnc1tfa2V5M10gPSBhcmd1bWVudHNbX2tleTNdOwogIH0KICBpZiAoIWFyZ3MubGVuZ3RoKSB7CiAgICByZXR1cm4gaWRlbnRpdHkzOwogIH0KICB2YXIgZm5zID0gYXJncy5yZXZlcnNlKCk7CiAgdmFyIGZpcnN0Rm4gPSBmbnNbMF07CiAgdmFyIHRhaWxzRm4gPSBmbnMuc2xpY2UoMSk7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHRhaWxzRm4ucmVkdWNlKChyZXMsIGZuKSA9PiBmbihyZXMpLCBmaXJzdEZuKC4uLmFyZ3VtZW50cykpOwogIH07Cn07CnZhciByZXZlcnNlID0gKGFycikgPT4gewogIGlmIChBcnJheS5pc0FycmF5KGFycikpIHsKICAgIHJldHVybiBhcnIucmV2ZXJzZSgpOwogIH0KICByZXR1cm4gYXJyLnNwbGl0KCIiKS5yZXZlcnNlKCkuam9pbigiIik7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc2NhbGUvdXRpbC9hcml0aG1ldGljLmpzCnZhciBpbXBvcnRfZGVjaW1hbCA9IF9fdG9FU00ocmVxdWlyZV9kZWNpbWFsKCkpOwpmdW5jdGlvbiBnZXREaWdpdENvdW50KHZhbHVlKSB7CiAgdmFyIHJlc3VsdDsKICBpZiAodmFsdWUgPT09IDApIHsKICAgIHJlc3VsdCA9IDE7CiAgfSBlbHNlIHsKICAgIHJlc3VsdCA9IE1hdGguZmxvb3IobmV3IGltcG9ydF9kZWNpbWFsLmRlZmF1bHQodmFsdWUpLmFicygpLmxvZygxMCkudG9OdW1iZXIoKSkgKyAxOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIHJhbmdlU3RlcChzdGFydCwgZW5kLCBzdGVwKSB7CiAgdmFyIG51bSA9IG5ldyBpbXBvcnRfZGVjaW1hbC5kZWZhdWx0KHN0YXJ0KTsKICB2YXIgaSA9IDA7CiAgdmFyIHJlc3VsdCA9IFtdOwogIHdoaWxlIChudW0ubHQoZW5kKSAmJiBpIDwgMWU1KSB7CiAgICByZXN1bHQucHVzaChudW0udG9OdW1iZXIoKSk7CiAgICBudW0gPSBudW0uYWRkKHN0ZXApOwogICAgaSsrOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc2NhbGUvZ2V0TmljZVRpY2tWYWx1ZXMuanMKdmFyIGdldFZhbGlkSW50ZXJ2YWwgPSAoX3JlZjIpID0+IHsKICB2YXIgW21pbjIsIG1heDJdID0gX3JlZjI7CiAgdmFyIFt2YWxpZE1pbiwgdmFsaWRNYXhdID0gW21pbjIsIG1heDJdOwogIGlmIChtaW4yID4gbWF4MikgewogICAgW3ZhbGlkTWluLCB2YWxpZE1heF0gPSBbbWF4MiwgbWluMl07CiAgfQogIHJldHVybiBbdmFsaWRNaW4sIHZhbGlkTWF4XTsKfTsKdmFyIGdldEZvcm1hdFN0ZXAgPSAocm91Z2hTdGVwLCBhbGxvd0RlY2ltYWxzLCBjb3JyZWN0aW9uRmFjdG9yKSA9PiB7CiAgaWYgKHJvdWdoU3RlcC5sdGUoMCkpIHsKICAgIHJldHVybiBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMCk7CiAgfQogIHZhciBkaWdpdENvdW50ID0gZ2V0RGlnaXRDb3VudChyb3VnaFN0ZXAudG9OdW1iZXIoKSk7CiAgdmFyIGRpZ2l0Q291bnRWYWx1ZSA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgxMCkucG93KGRpZ2l0Q291bnQpOwogIHZhciBzdGVwUmF0aW8gPSByb3VnaFN0ZXAuZGl2KGRpZ2l0Q291bnRWYWx1ZSk7CiAgdmFyIHN0ZXBSYXRpb1NjYWxlID0gZGlnaXRDb3VudCAhPT0gMSA/IDAuMDUgOiAwLjE7CiAgdmFyIGFtZW5kU3RlcFJhdGlvID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguY2VpbChzdGVwUmF0aW8uZGl2KHN0ZXBSYXRpb1NjYWxlKS50b051bWJlcigpKSkuYWRkKGNvcnJlY3Rpb25GYWN0b3IpLm11bChzdGVwUmF0aW9TY2FsZSk7CiAgdmFyIGZvcm1hdFN0ZXAgPSBhbWVuZFN0ZXBSYXRpby5tdWwoZGlnaXRDb3VudFZhbHVlKTsKICByZXR1cm4gYWxsb3dEZWNpbWFscyA/IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChmb3JtYXRTdGVwLnRvTnVtYmVyKCkpIDogbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguY2VpbChmb3JtYXRTdGVwLnRvTnVtYmVyKCkpKTsKfTsKdmFyIGdldFRpY2tPZlNpbmdsZVZhbHVlID0gKHZhbHVlLCB0aWNrQ291bnQsIGFsbG93RGVjaW1hbHMpID0+IHsKICB2YXIgc3RlcCA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgxKTsKICB2YXIgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KHZhbHVlKTsKICBpZiAoIW1pZGRsZS5pc2ludCgpICYmIGFsbG93RGVjaW1hbHMpIHsKICAgIHZhciBhYnNWYWwgPSBNYXRoLmFicyh2YWx1ZSk7CiAgICBpZiAoYWJzVmFsIDwgMSkgewogICAgICBzdGVwID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDEwKS5wb3coZ2V0RGlnaXRDb3VudCh2YWx1ZSkgLSAxKTsKICAgICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguZmxvb3IobWlkZGxlLmRpdihzdGVwKS50b051bWJlcigpKSkubXVsKHN0ZXApOwogICAgfSBlbHNlIGlmIChhYnNWYWwgPiAxKSB7CiAgICAgIG1pZGRsZSA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChNYXRoLmZsb29yKHZhbHVlKSk7CiAgICB9CiAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gMCkgewogICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguZmxvb3IoKHRpY2tDb3VudCAtIDEpIC8gMikpOwogIH0gZWxzZSBpZiAoIWFsbG93RGVjaW1hbHMpIHsKICAgIG1pZGRsZSA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChNYXRoLmZsb29yKHZhbHVlKSk7CiAgfQogIHZhciBtaWRkbGVJbmRleCA9IE1hdGguZmxvb3IoKHRpY2tDb3VudCAtIDEpIC8gMik7CiAgdmFyIGZuID0gY29tcG9zZTIobWFwMigobikgPT4gbWlkZGxlLmFkZChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQobiAtIG1pZGRsZUluZGV4KS5tdWwoc3RlcCkpLnRvTnVtYmVyKCkpLCByYW5nZTIpOwogIHJldHVybiBmbigwLCB0aWNrQ291bnQpOwp9Owp2YXIgX2NhbGN1bGF0ZVN0ZXAgPSBmdW5jdGlvbiBjYWxjdWxhdGVTdGVwKG1pbjIsIG1heDIsIHRpY2tDb3VudCwgYWxsb3dEZWNpbWFscykgewogIHZhciBjb3JyZWN0aW9uRmFjdG9yID0gYXJndW1lbnRzLmxlbmd0aCA+IDQgJiYgYXJndW1lbnRzWzRdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbNF0gOiAwOwogIGlmICghTnVtYmVyLmlzRmluaXRlKChtYXgyIC0gbWluMikgLyAodGlja0NvdW50IC0gMSkpKSB7CiAgICByZXR1cm4gewogICAgICBzdGVwOiBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMCksCiAgICAgIHRpY2tNaW46IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgwKSwKICAgICAgdGlja01heDogbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDApCiAgICB9OwogIH0KICB2YXIgc3RlcCA9IGdldEZvcm1hdFN0ZXAobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KG1heDIpLnN1YihtaW4yKS5kaXYodGlja0NvdW50IC0gMSksIGFsbG93RGVjaW1hbHMsIGNvcnJlY3Rpb25GYWN0b3IpOwogIHZhciBtaWRkbGU7CiAgaWYgKG1pbjIgPD0gMCAmJiBtYXgyID49IDApIHsKICAgIG1pZGRsZSA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgwKTsKICB9IGVsc2UgewogICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KG1pbjIpLmFkZChtYXgyKS5kaXYoMik7CiAgICBtaWRkbGUgPSBtaWRkbGUuc3ViKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChtaWRkbGUpLm1vZChzdGVwKSk7CiAgfQogIHZhciBiZWxvd0NvdW50ID0gTWF0aC5jZWlsKG1pZGRsZS5zdWIobWluMikuZGl2KHN0ZXApLnRvTnVtYmVyKCkpOwogIHZhciB1cENvdW50ID0gTWF0aC5jZWlsKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChtYXgyKS5zdWIobWlkZGxlKS5kaXYoc3RlcCkudG9OdW1iZXIoKSk7CiAgdmFyIHNjYWxlQ291bnQgPSBiZWxvd0NvdW50ICsgdXBDb3VudCArIDE7CiAgaWYgKHNjYWxlQ291bnQgPiB0aWNrQ291bnQpIHsKICAgIHJldHVybiBfY2FsY3VsYXRlU3RlcChtaW4yLCBtYXgyLCB0aWNrQ291bnQsIGFsbG93RGVjaW1hbHMsIGNvcnJlY3Rpb25GYWN0b3IgKyAxKTsKICB9CiAgaWYgKHNjYWxlQ291bnQgPCB0aWNrQ291bnQpIHsKICAgIHVwQ291bnQgPSBtYXgyID4gMCA/IHVwQ291bnQgKyAodGlja0NvdW50IC0gc2NhbGVDb3VudCkgOiB1cENvdW50OwogICAgYmVsb3dDb3VudCA9IG1heDIgPiAwID8gYmVsb3dDb3VudCA6IGJlbG93Q291bnQgKyAodGlja0NvdW50IC0gc2NhbGVDb3VudCk7CiAgfQogIHJldHVybiB7CiAgICBzdGVwLAogICAgdGlja01pbjogbWlkZGxlLnN1YihuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoYmVsb3dDb3VudCkubXVsKHN0ZXApKSwKICAgIHRpY2tNYXg6IG1pZGRsZS5hZGQobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KHVwQ291bnQpLm11bChzdGVwKSkKICB9Owp9Owp2YXIgZ2V0TmljZVRpY2tWYWx1ZXMgPSBmdW5jdGlvbiBnZXROaWNlVGlja1ZhbHVlczIoX3JlZjIpIHsKICB2YXIgW21pbjIsIG1heDJdID0gX3JlZjI7CiAgdmFyIHRpY2tDb3VudCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDogNjsKICB2YXIgYWxsb3dEZWNpbWFscyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzJdIDogdHJ1ZTsKICB2YXIgY291bnQgPSBNYXRoLm1heCh0aWNrQ291bnQsIDIpOwogIHZhciBbY29ybWluLCBjb3JtYXhdID0gZ2V0VmFsaWRJbnRlcnZhbChbbWluMiwgbWF4Ml0pOwogIGlmIChjb3JtaW4gPT09IC1JbmZpbml0eSB8fCBjb3JtYXggPT09IEluZmluaXR5KSB7CiAgICB2YXIgX3ZhbHVlcyA9IGNvcm1heCA9PT0gSW5maW5pdHkgPyBbY29ybWluLCAuLi5yYW5nZTIoMCwgdGlja0NvdW50IC0gMSkubWFwKCgpID0+IEluZmluaXR5KV0gOiBbLi4ucmFuZ2UyKDAsIHRpY2tDb3VudCAtIDEpLm1hcCgoKSA9PiAtSW5maW5pdHkpLCBjb3JtYXhdOwogICAgcmV0dXJuIG1pbjIgPiBtYXgyID8gcmV2ZXJzZShfdmFsdWVzKSA6IF92YWx1ZXM7CiAgfQogIGlmIChjb3JtaW4gPT09IGNvcm1heCkgewogICAgcmV0dXJuIGdldFRpY2tPZlNpbmdsZVZhbHVlKGNvcm1pbiwgdGlja0NvdW50LCBhbGxvd0RlY2ltYWxzKTsKICB9CiAgdmFyIHsKICAgIHN0ZXAsCiAgICB0aWNrTWluLAogICAgdGlja01heAogIH0gPSBfY2FsY3VsYXRlU3RlcChjb3JtaW4sIGNvcm1heCwgY291bnQsIGFsbG93RGVjaW1hbHMsIDApOwogIHZhciB2YWx1ZXMgPSByYW5nZVN0ZXAodGlja01pbiwgdGlja01heC5hZGQobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDAuMSkubXVsKHN0ZXApKSwgc3RlcCk7CiAgcmV0dXJuIG1pbjIgPiBtYXgyID8gcmV2ZXJzZSh2YWx1ZXMpIDogdmFsdWVzOwp9Owp2YXIgZ2V0VGlja1ZhbHVlc0ZpeGVkRG9tYWluID0gZnVuY3Rpb24gZ2V0VGlja1ZhbHVlc0ZpeGVkRG9tYWluMihfcmVmMywgdGlja0NvdW50KSB7CiAgdmFyIFttaW4yLCBtYXgyXSA9IF9yZWYzOwogIHZhciBhbGxvd0RlY2ltYWxzID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiB0cnVlOwogIHZhciBbY29ybWluLCBjb3JtYXhdID0gZ2V0VmFsaWRJbnRlcnZhbChbbWluMiwgbWF4Ml0pOwogIGlmIChjb3JtaW4gPT09IC1JbmZpbml0eSB8fCBjb3JtYXggPT09IEluZmluaXR5KSB7CiAgICByZXR1cm4gW21pbjIsIG1heDJdOwogIH0KICBpZiAoY29ybWluID09PSBjb3JtYXgpIHsKICAgIHJldHVybiBbY29ybWluXTsKICB9CiAgdmFyIGNvdW50ID0gTWF0aC5tYXgodGlja0NvdW50LCAyKTsKICB2YXIgc3RlcCA9IGdldEZvcm1hdFN0ZXAobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KGNvcm1heCkuc3ViKGNvcm1pbikuZGl2KGNvdW50IC0gMSksIGFsbG93RGVjaW1hbHMsIDApOwogIHZhciB2YWx1ZXMgPSBbLi4ucmFuZ2VTdGVwKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChjb3JtaW4pLCBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoY29ybWF4KSwgc3RlcCksIGNvcm1heF07CiAgaWYgKGFsbG93RGVjaW1hbHMgPT09IGZhbHNlKSB7CiAgICB2YWx1ZXMgPSB2YWx1ZXMubWFwKCh2YWx1ZSkgPT4gTWF0aC5yb3VuZCh2YWx1ZSkpOwogIH0KICByZXR1cm4gbWluMiA+IG1heDIgPyByZXZlcnNlKHZhbHVlcykgOiB2YWx1ZXM7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9yb290UHJvcHNTZWxlY3RvcnMuanMKdmFyIHNlbGVjdEJhckNhdGVnb3J5R2FwID0gKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuYmFyQ2F0ZWdvcnlHYXA7CnZhciBzZWxlY3RTdGFja09mZnNldFR5cGUgPSAoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5zdGFja09mZnNldDsKdmFyIHNlbGVjdFJldmVyc2VTdGFja09yZGVyID0gKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMucmV2ZXJzZVN0YWNrT3JkZXI7CnZhciBzZWxlY3RDaGFydE5hbWUgPSAoc3RhdGUpID0+IHN0YXRlLm9wdGlvbnMuY2hhcnROYW1lOwp2YXIgc2VsZWN0U3luY0lkID0gKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuc3luY0lkOwp2YXIgc2VsZWN0U3luY01ldGhvZCA9IChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLnN5bmNNZXRob2Q7CnZhciBzZWxlY3RFdmVudEVtaXR0ZXIgPSAoc3RhdGUpID0+IHN0YXRlLm9wdGlvbnMuZXZlbnRFbWl0dGVyOwp2YXIgc2VsZWN0Q2hhcnRCYXNlVmFsdWUgPSAoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5iYXNlVmFsdWU7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3pJbmRleC9EZWZhdWx0WkluZGV4ZXMuanMKdmFyIERlZmF1bHRaSW5kZXhlcyA9IHsKICAvKioKICAgKiBDYXJ0ZXNpYW5HcmlkIGFuZCBQb2xhckdyaWQKICAgKi8KICBncmlkOiAtMTAwLAogIC8qKgogICAqIEJhY2tncm91bmQgb2YgQmFyIGFuZCBSYWRpYWxCYXIuCiAgICogVGhpcyBpcyBub3QgdmlzaWJsZSBieSBkZWZhdWx0IGJ1dCBjYW4gYmUgZW5hYmxlZCBieSBzZXR0aW5nIGJhY2tncm91bmQ9e3RydWV9IG9uIEJhciBvciBSYWRpYWxCYXIuCiAgICovCiAgYmFyQmFja2dyb3VuZDogLTUwLAogIC8qCiAgICogb3RoZXIgY2hhcnQgZWxlbWVudHMgb3IgY3VzdG9tIGVsZW1lbnRzIHdpdGhvdXQgc3BlY2lmaWMgekluZGV4CiAgICogcmVuZGVyIGluIGhlcmUsIGF0IHpJbmRleCAwCiAgICovCiAgLyoqCiAgICogQXJlYSwgUGllLCBSYWRhciwgYW5kIFJlZmVyZW5jZUFyZWEKICAgKi8KICBhcmVhOiAxMDAsCiAgLyoqCiAgICogQ3Vyc29yIGlzIGVtYmVkZGVkIGluc2lkZSBUb29sdGlwIGFuZCBjb250cm9sbGVkIGJ5IGl0LgogICAqIFRoZSBUb29sdGlwIGl0c2VsZiBoYXMgYSBzZXBhcmF0ZSBwb3J0YWwgYW5kIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgekluZGV4IHN5c3RlbTsKICAgKiBDdXJzb3IgaXMgdGhlIGRlY29yYXRpb24gaW5zaWRlIHRoZSBjaGFydCBhcmVhLiBDdXJzb3JSZWN0YW5nbGUgaXMgYSByZWN0YW5nbGUgYm94LgogICAqIEl0IHJlbmRlcnMgYmVsb3cgYmFyIHNvIHRoYXQgaW4gYSBzdGFja2VkIGJhciBjaGFydCB0aGUgY3Vyc29yIHJlY3RhbmdsZSBkb2VzIG5vdCBoaWRlIHRoZSBvdGhlciBiYXJzLgogICAqLwogIGN1cnNvclJlY3RhbmdsZTogMjAwLAogIC8qKgogICAqIEJhciBhbmQgUmFkaWFsQmFyCiAgICovCiAgYmFyOiAzMDAsCiAgLyoqCiAgICogTGluZSBhbmQgUmVmZXJlbmNlTGluZSwgYW5kIEVycm9yQm9yCiAgICovCiAgbGluZTogNDAwLAogIC8qKgogICAqIFhBeGlzIGFuZCBZQXhpcyBhbmQgUG9sYXJBbmdsZUF4aXMgYW5kIFBvbGFyUmFkaXVzQXhpcyB0aWNrcyBhbmQgbGluZXMgYW5kIGNoaWxkcmVuCiAgICovCiAgYXhpczogNTAwLAogIC8qKgogICAqIFNjYXR0ZXIgYW5kIFJlZmVyZW5jZURvdCwKICAgKiBhbmQgRG90cyBvZiBMaW5lIGFuZCBBcmVhIGFuZCBSYWRhciBpZiB0aGV5IGhhdmUgZG90PXRydWUKICAgKi8KICBzY2F0dGVyOiA2MDAsCiAgLyoqCiAgICogSG92ZXJpbmcgb3ZlciBhIEJhciBvciBSYWRpYWxCYXIgcmVuZGVycyBhIGhpZ2hsaWdodCByZWN0YW5nbGUKICAgKi8KICBhY3RpdmVCYXI6IDFlMywKICAvKioKICAgKiBDdXJzb3IgaXMgZW1iZWRkZWQgaW5zaWRlIFRvb2x0aXAgYW5kIGNvbnRyb2xsZWQgYnkgaXQuCiAgICogVGhlIFRvb2x0aXAgaXRzZWxmIGhhcyBhIHNlcGFyYXRlIHBvcnRhbCBhbmQgaXMgbm90IGluY2x1ZGVkIGluIHRoZSB6SW5kZXggc3lzdGVtOwogICAqIEN1cnNvciBpcyB0aGUgZGVjb3JhdGlvbiBpbnNpZGUgdGhlIGNoYXJ0IGFyZWEsIHVzdWFsbHkgYSBjcm9zcyBvciBhIGJveC4KICAgKiBDdXJzb3JMaW5lIGlzIGEgbGluZSBjdXJzb3IgcmVuZGVyZWQgaW4gTGluZSwgQXJlYSwgU2NhdHRlciwgUmFkYXIgY2hhcnRzLgogICAqIEl0IHJlbmRlcnMgYWJvdmUgdGhlIExpbmUgYW5kIFNjYXR0ZXIgc28gdGhhdCBpdCBpcyBhbHdheXMgdmlzaWJsZS4KICAgKiBJdCByZW5kZXJzIGJlbG93IGFjdGl2ZSBkb3Qgc28gdGhhdCB0aGUgZG90IGlzIGFsd2F5cyB2aXNpYmxlIGFuZCBzaG93cyB0aGUgY3VycmVudCBwb2ludC4KICAgKiBXZSdyZSBhbHNvIGFzc3VtaW5nIHRoYXQgdGhlIGFjdGl2ZSBkb3QgaXMgc21hbGwgZW5vdWdoIHRoYXQgaXQgZG9lcyBub3QgZnVsbHkgY292ZXIgdGhlIGN1cnNvciBsaW5lLgogICAqCiAgICogVGhpcyBhbHNvIGFwcGxpZXMgdG8gdGhlIHJhZGlhbCBjdXJzb3IgaW4gUmFkaWFsQmFyQ2hhcnQuCiAgICovCiAgY3Vyc29yTGluZTogMTEwMCwKICAvKioKICAgKiBIb3ZlcmluZyBvdmVyIGEgUG9pbnQgaW4gTGluZSwgQXJlYSwgU2NhdHRlciwgUmFkYXIgcmVuZGVycyBhIGhpZ2hsaWdodCBkb3QKICAgKi8KICBhY3RpdmVEb3Q6IDEyMDAsCiAgLyoqCiAgICogTGFiZWxMaXN0IGFuZCBMYWJlbCwgaW5jbHVkaW5nIEF4aXMgbGFiZWxzCiAgICovCiAgbGFiZWw6IDJlMwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9wb2xhci9kZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5qcwp2YXIgZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMgPSB7CiAgYWxsb3dEZWNpbWFsczogZmFsc2UsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IHRydWUsCiAgLy8gaWYgSSBzZXQgdGhpcyB0byBmYWxzZSB0aGVuIFRvb2x0aXAgc3luY2hyb25pc2F0aW9uIHN0b3BzIHdvcmtpbmcgaW4gUmFkYXIsIHd0ZgogIGFuZ2xlQXhpc0lkOiAwLAogIGF4aXNMaW5lOiB0cnVlLAogIGF4aXNMaW5lVHlwZTogInBvbHlnb24iLAogIGN4OiAwLAogIGN5OiAwLAogIG9yaWVudGF0aW9uOiAib3V0ZXIiLAogIHJldmVyc2VkOiBmYWxzZSwKICBzY2FsZTogImF1dG8iLAogIHRpY2s6IHRydWUsCiAgdGlja0xpbmU6IHRydWUsCiAgdGlja1NpemU6IDgsCiAgdHlwZTogImNhdGVnb3J5IiwKICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5heGlzCn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3BvbGFyL2RlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5qcwp2YXIgZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBmYWxzZSwKICBhbGxvd0RlY2ltYWxzOiBmYWxzZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogdHJ1ZSwKICBhbmdsZTogMCwKICBheGlzTGluZTogdHJ1ZSwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICBsYWJlbDogZmFsc2UsCiAgb3JpZW50YXRpb246ICJyaWdodCIsCiAgcmFkaXVzQXhpc0lkOiAwLAogIHJldmVyc2VkOiBmYWxzZSwKICBzY2FsZTogImF1dG8iLAogIHN0cm9rZTogIiNjY2MiLAogIHRpY2s6IHRydWUsCiAgdGlja0NvdW50OiA1LAogIHR5cGU6ICJudW1iZXIiLAogIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmF4aXMKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UuanMKdmFyIGNvbWJpbmVBeGlzUmFuZ2VXaXRoUmV2ZXJzZSA9IChheGlzU2V0dGluZ3MsIGF4aXNSYW5nZSkgPT4gewogIGlmICghYXhpc1NldHRpbmdzIHx8ICFheGlzUmFuZ2UpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChheGlzU2V0dGluZ3MgIT09IG51bGwgJiYgYXhpc1NldHRpbmdzICE9PSB2b2lkIDAgJiYgYXhpc1NldHRpbmdzLnJldmVyc2VkKSB7CiAgICByZXR1cm4gW2F4aXNSYW5nZVsxXSwgYXhpc1JhbmdlWzBdXTsKICB9CiAgcmV0dXJuIGF4aXNSYW5nZTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3BvbGFyQXhpc1NlbGVjdG9ycy5qcwp2YXIgaW1wbGljaXRBbmdsZUF4aXMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGZhbHNlLAogIGFsbG93RGVjaW1hbHM6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBmYWxzZSwKICAvLyBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSBoYXMgaXQgc2V0IHRvIHRydWUgYnV0IHRoZSBhY3R1YWwgYXhpcyByZW5kZXJpbmcgaWdub3JlcyB0aGUgcHJvcCBiZWNhdXNlIHJlYXNvbnMsCiAgZGF0YUtleTogdm9pZCAwLAogIGRvbWFpbjogdm9pZCAwLAogIGlkOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5hbmdsZUF4aXNJZCwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICBuYW1lOiB2b2lkIDAsCiAgcmV2ZXJzZWQ6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnJldmVyc2VkLAogIHNjYWxlOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5zY2FsZSwKICB0aWNrOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy50aWNrLAogIHRpY2tDb3VudDogdm9pZCAwLAogIHRpY2tzOiB2b2lkIDAsCiAgdHlwZTogZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMudHlwZSwKICB1bml0OiB2b2lkIDAKfTsKdmFyIGltcGxpY2l0UmFkaXVzQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLmFsbG93RGF0YU92ZXJmbG93LAogIGFsbG93RGVjaW1hbHM6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgZGF0YUtleTogdm9pZCAwLAogIGRvbWFpbjogdm9pZCAwLAogIGlkOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMucmFkaXVzQXhpc0lkLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICByZXZlcnNlZDogZmFsc2UsCiAgc2NhbGU6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5zY2FsZSwKICB0aWNrOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMudGljaywKICB0aWNrQ291bnQ6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy50aWNrQ291bnQsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMudHlwZSwKICB1bml0OiB2b2lkIDAKfTsKdmFyIGltcGxpY2l0UmFkaWFsQmFyQW5nbGVBeGlzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBmYWxzZSwKICBhbGxvd0RlY2ltYWxzOiBmYWxzZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgZGF0YUtleTogdm9pZCAwLAogIGRvbWFpbjogdm9pZCAwLAogIGlkOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5hbmdsZUF4aXNJZCwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICBuYW1lOiB2b2lkIDAsCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5zY2FsZSwKICB0aWNrOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy50aWNrLAogIHRpY2tDb3VudDogdm9pZCAwLAogIHRpY2tzOiB2b2lkIDAsCiAgdHlwZTogIm51bWJlciIsCiAgdW5pdDogdm9pZCAwCn07CnZhciBpbXBsaWNpdFJhZGlhbEJhclJhZGl1c0F4aXMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5hbGxvd0RhdGFPdmVyZmxvdywKICBhbGxvd0RlY2ltYWxzOiBmYWxzZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogIGRhdGFLZXk6IHZvaWQgMCwKICBkb21haW46IHZvaWQgMCwKICBpZDogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnJhZGl1c0F4aXNJZCwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICBuYW1lOiB2b2lkIDAsCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuc2NhbGUsCiAgdGljazogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnRpY2ssCiAgdGlja0NvdW50OiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMudGlja0NvdW50LAogIHRpY2tzOiB2b2lkIDAsCiAgdHlwZTogImNhdGVnb3J5IiwKICB1bml0OiB2b2lkIDAKfTsKdmFyIHNlbGVjdEFuZ2xlQXhpcyA9IChzdGF0ZSwgYW5nbGVBeGlzSWQpID0+IHsKICBpZiAoc3RhdGUucG9sYXJBeGlzLmFuZ2xlQXhpc1thbmdsZUF4aXNJZF0gIT0gbnVsbCkgewogICAgcmV0dXJuIHN0YXRlLnBvbGFyQXhpcy5hbmdsZUF4aXNbYW5nbGVBeGlzSWRdOwogIH0KICBpZiAoc3RhdGUubGF5b3V0LmxheW91dFR5cGUgPT09ICJyYWRpYWwiKSB7CiAgICByZXR1cm4gaW1wbGljaXRSYWRpYWxCYXJBbmdsZUF4aXM7CiAgfQogIHJldHVybiBpbXBsaWNpdEFuZ2xlQXhpczsKfTsKdmFyIHNlbGVjdFJhZGl1c0F4aXMgPSAoc3RhdGUsIHJhZGl1c0F4aXNJZCkgPT4gewogIGlmIChzdGF0ZS5wb2xhckF4aXMucmFkaXVzQXhpc1tyYWRpdXNBeGlzSWRdICE9IG51bGwpIHsKICAgIHJldHVybiBzdGF0ZS5wb2xhckF4aXMucmFkaXVzQXhpc1tyYWRpdXNBeGlzSWRdOwogIH0KICBpZiAoc3RhdGUubGF5b3V0LmxheW91dFR5cGUgPT09ICJyYWRpYWwiKSB7CiAgICByZXR1cm4gaW1wbGljaXRSYWRpYWxCYXJSYWRpdXNBeGlzOwogIH0KICByZXR1cm4gaW1wbGljaXRSYWRpdXNBeGlzOwp9Owp2YXIgc2VsZWN0UG9sYXJPcHRpb25zID0gKHN0YXRlKSA9PiBzdGF0ZS5wb2xhck9wdGlvbnM7CnZhciBzZWxlY3RNYXhSYWRpdXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRXaWR0aCwgc2VsZWN0Q2hhcnRIZWlnaHQsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWxdLCBnZXRNYXhSYWRpdXMpOwp2YXIgc2VsZWN0SW5uZXJSYWRpdXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UG9sYXJPcHRpb25zLCBzZWxlY3RNYXhSYWRpdXNdLCAocG9sYXJDaGFydE9wdGlvbnMsIG1heFJhZGl1cykgPT4gewogIGlmIChwb2xhckNoYXJ0T3B0aW9ucyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZ2V0UGVyY2VudFZhbHVlKHBvbGFyQ2hhcnRPcHRpb25zLmlubmVyUmFkaXVzLCBtYXhSYWRpdXMsIDApOwp9KTsKdmFyIHNlbGVjdE91dGVyUmFkaXVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFBvbGFyT3B0aW9ucywgc2VsZWN0TWF4UmFkaXVzXSwgKHBvbGFyQ2hhcnRPcHRpb25zLCBtYXhSYWRpdXMpID0+IHsKICBpZiAocG9sYXJDaGFydE9wdGlvbnMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGdldFBlcmNlbnRWYWx1ZShwb2xhckNoYXJ0T3B0aW9ucy5vdXRlclJhZGl1cywgbWF4UmFkaXVzLCBtYXhSYWRpdXMgKiAwLjgpOwp9KTsKdmFyIGNvbWJpbmVBbmdsZUF4aXNSYW5nZSA9IChwb2xhck9wdGlvbnMpID0+IHsKICBpZiAocG9sYXJPcHRpb25zID09IG51bGwpIHsKICAgIHJldHVybiBbMCwgMF07CiAgfQogIHZhciB7CiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gcG9sYXJPcHRpb25zOwogIHJldHVybiBbc3RhcnRBbmdsZSwgZW5kQW5nbGVdOwp9Owp2YXIgc2VsZWN0QW5nbGVBeGlzUmFuZ2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UG9sYXJPcHRpb25zXSwgY29tYmluZUFuZ2xlQXhpc1JhbmdlKTsKdmFyIHNlbGVjdEFuZ2xlQXhpc1JhbmdlV2l0aFJldmVyc2VkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFuZ2xlQXhpcywgc2VsZWN0QW5nbGVBeGlzUmFuZ2VdLCBjb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UpOwp2YXIgc2VsZWN0UmFkaXVzQXhpc1JhbmdlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdE1heFJhZGl1cywgc2VsZWN0SW5uZXJSYWRpdXMsIHNlbGVjdE91dGVyUmFkaXVzXSwgKG1heFJhZGl1cywgaW5uZXJSYWRpdXMsIG91dGVyUmFkaXVzKSA9PiB7CiAgaWYgKG1heFJhZGl1cyA9PSBudWxsIHx8IGlubmVyUmFkaXVzID09IG51bGwgfHwgb3V0ZXJSYWRpdXMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtpbm5lclJhZGl1cywgb3V0ZXJSYWRpdXNdOwp9KTsKdmFyIHNlbGVjdFJhZGl1c0F4aXNSYW5nZVdpdGhSZXZlcnNlZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSYWRpdXNBeGlzLCBzZWxlY3RSYWRpdXNBeGlzUmFuZ2VdLCBjb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UpOwp2YXIgc2VsZWN0UG9sYXJWaWV3Qm94ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RQb2xhck9wdGlvbnMsIHNlbGVjdElubmVyUmFkaXVzLCBzZWxlY3RPdXRlclJhZGl1cywgc2VsZWN0Q2hhcnRXaWR0aCwgc2VsZWN0Q2hhcnRIZWlnaHRdLCAobGF5b3V0LCBwb2xhck9wdGlvbnMsIGlubmVyUmFkaXVzLCBvdXRlclJhZGl1cywgd2lkdGgsIGhlaWdodCkgPT4gewogIGlmIChsYXlvdXQgIT09ICJjZW50cmljIiAmJiBsYXlvdXQgIT09ICJyYWRpYWwiIHx8IHBvbGFyT3B0aW9ucyA9PSBudWxsIHx8IGlubmVyUmFkaXVzID09IG51bGwgfHwgb3V0ZXJSYWRpdXMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gcG9sYXJPcHRpb25zOwogIHJldHVybiB7CiAgICBjeDogZ2V0UGVyY2VudFZhbHVlKGN4LCB3aWR0aCwgd2lkdGggLyAyKSwKICAgIGN5OiBnZXRQZXJjZW50VmFsdWUoY3ksIGhlaWdodCwgaGVpZ2h0IC8gMiksCiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlLAogICAgY2xvY2tXaXNlOiBmYWxzZQogICAgLy8gdGhpcyBwcm9wZXJ0eSBsb29rIHVzZWZ1bCwgd2h5IG5vdCB1c2UgaXQ/CiAgfTsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9waWNrQXhpc1R5cGUuanMKdmFyIHBpY2tBeGlzVHlwZSA9IChfc3RhdGUsIGF4aXNUeXBlKSA9PiBheGlzVHlwZTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3BpY2tBeGlzSWQuanMKdmFyIHBpY2tBeGlzSWQgPSAoX3N0YXRlLCBfYXhpc1R5cGUsIGF4aXNJZCkgPT4gYXhpc0lkOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3N0YWNrcy9nZXRTdGFja1Nlcmllc0lkZW50aWZpZXIuanMKZnVuY3Rpb24gZ2V0U3RhY2tTZXJpZXNJZGVudGlmaWVyKGdyYXBoaWNhbEl0ZW0pIHsKICByZXR1cm4gZ3JhcGhpY2FsSXRlbSA9PT0gbnVsbCB8fCBncmFwaGljYWxJdGVtID09PSB2b2lkIDAgPyB2b2lkIDAgOiBncmFwaGljYWxJdGVtLmlkOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZURpc3BsYXllZFN0YWNrZWREYXRhLmpzCmZ1bmN0aW9uIGNvbWJpbmVEaXNwbGF5ZWRTdGFja2VkRGF0YShzdGFja2VkR3JhcGhpY2FsSXRlbXMsIF9yZWYyLCB0b29sdGlwQXhpc1NldHRpbmdzKSB7CiAgdmFyIHsKICAgIGNoYXJ0RGF0YSA9IFtdCiAgfSA9IF9yZWYyOwogIHZhciB7CiAgICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICAgIGRhdGFLZXk6IHRvb2x0aXBEYXRhS2V5CiAgfSA9IHRvb2x0aXBBeGlzU2V0dGluZ3M7CiAgdmFyIGtub3duSXRlbXNCeURhdGFLZXkgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIHN0YWNrZWRHcmFwaGljYWxJdGVtcy5mb3JFYWNoKChpdGVtKSA9PiB7CiAgICB2YXIgX2l0ZW0kZGF0YTsKICAgIHZhciByZXNvbHZlZERhdGEgPSAoX2l0ZW0kZGF0YSA9IGl0ZW0uZGF0YSkgIT09IG51bGwgJiYgX2l0ZW0kZGF0YSAhPT0gdm9pZCAwID8gX2l0ZW0kZGF0YSA6IGNoYXJ0RGF0YTsKICAgIGlmIChyZXNvbHZlZERhdGEgPT0gbnVsbCB8fCByZXNvbHZlZERhdGEubGVuZ3RoID09PSAwKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBzdGFja0lkZW50aWZpZXIgPSBnZXRTdGFja1Nlcmllc0lkZW50aWZpZXIoaXRlbSk7CiAgICByZXNvbHZlZERhdGEuZm9yRWFjaCgoZW50cnksIGluZGV4KSA9PiB7CiAgICAgIHZhciB0b29sdGlwVmFsdWUgPSB0b29sdGlwRGF0YUtleSA9PSBudWxsIHx8IGFsbG93RHVwbGljYXRlZENhdGVnb3J5ID8gaW5kZXggOiBTdHJpbmcoZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIHRvb2x0aXBEYXRhS2V5LCBudWxsKSk7CiAgICAgIHZhciBudW1lcmljVmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgaXRlbS5kYXRhS2V5LCAwKTsKICAgICAgdmFyIGN1cnI7CiAgICAgIGlmIChrbm93bkl0ZW1zQnlEYXRhS2V5Lmhhcyh0b29sdGlwVmFsdWUpKSB7CiAgICAgICAgY3VyciA9IGtub3duSXRlbXNCeURhdGFLZXkuZ2V0KHRvb2x0aXBWYWx1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY3VyciA9IHt9OwogICAgICB9CiAgICAgIE9iamVjdC5hc3NpZ24oY3VyciwgewogICAgICAgIFtzdGFja0lkZW50aWZpZXJdOiBudW1lcmljVmFsdWUKICAgICAgfSk7CiAgICAgIGtub3duSXRlbXNCeURhdGFLZXkuc2V0KHRvb2x0aXBWYWx1ZSwgY3Vycik7CiAgICB9KTsKICB9KTsKICByZXR1cm4gQXJyYXkuZnJvbShrbm93bkl0ZW1zQnlEYXRhS2V5LnZhbHVlcygpKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS90eXBlcy9TdGFja2VkR3JhcGhpY2FsSXRlbS5qcwpmdW5jdGlvbiBpc1N0YWNrZWQoZ3JhcGhpY2FsSXRlbSkgewogIHJldHVybiBncmFwaGljYWxJdGVtLnN0YWNrSWQgIT0gbnVsbCAmJiBncmFwaGljYWxJdGVtLmRhdGFLZXkgIT0gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjay5qcwp2YXIgbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjayA9IChhLCBiKSA9PiB7CiAgaWYgKGEgPT09IGIpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBpZiAoYSA9PSBudWxsIHx8IGIgPT0gbnVsbCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gYVswXSA9PT0gYlswXSAmJiBhWzFdID09PSBiWzFdOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvYXJyYXlFcXVhbGl0eUNoZWNrLmpzCmZ1bmN0aW9uIGVtcHR5QXJyYXlzQXJlRXF1YWxDaGVjayhhLCBiKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkoYSkgJiYgQXJyYXkuaXNBcnJheShiKSAmJiBhLmxlbmd0aCA9PT0gMCAmJiBiLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBhID09PSBiOwp9CmZ1bmN0aW9uIGFycmF5Q29udGVudHNBcmVFcXVhbENoZWNrKGEsIGIpIHsKICBpZiAoYS5sZW5ndGggPT09IGIubGVuZ3RoKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKGFbaV0gIT09IGJbaV0pIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gZmFsc2U7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBBeGlzVHlwZS5qcwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNUeXBlID0gKHN0YXRlKSA9PiB7CiAgdmFyIGxheW91dCA9IHNlbGVjdENoYXJ0TGF5b3V0KHN0YXRlKTsKICBpZiAobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIpIHsKICAgIHJldHVybiAieEF4aXMiOwogIH0KICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICByZXR1cm4gInlBeGlzIjsKICB9CiAgaWYgKGxheW91dCA9PT0gImNlbnRyaWMiKSB7CiAgICByZXR1cm4gImFuZ2xlQXhpcyI7CiAgfQogIHJldHVybiAicmFkaXVzQXhpcyI7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RUb29sdGlwQXhpc0lkLmpzCnZhciBzZWxlY3RUb29sdGlwQXhpc0lkID0gKHN0YXRlKSA9PiBzdGF0ZS50b29sdGlwLnNldHRpbmdzLmF4aXNJZDsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2F4aXNTZWxlY3RvcnMuanMKZnVuY3Rpb24gb3duS2V5czEzKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTMoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxMyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTMoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTMoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTEzKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTMocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTModCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTModCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTModCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBkZWZhdWx0TnVtZXJpY0RvbWFpbiA9IFswLCAiYXV0byJdOwp2YXIgaW1wbGljaXRYQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZmFsc2UsCiAgYWxsb3dEZWNpbWFsczogdHJ1ZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogdHJ1ZSwKICBhbmdsZTogMCwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiB2b2lkIDAsCiAgaGVpZ2h0OiAzMCwKICBoaWRlOiB0cnVlLAogIGlkOiAwLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIGludGVydmFsOiAicHJlc2VydmVFbmQiLAogIG1pblRpY2tHYXA6IDUsCiAgbWlycm9yOiBmYWxzZSwKICBuYW1lOiB2b2lkIDAsCiAgb3JpZW50YXRpb246ICJib3R0b20iLAogIHBhZGRpbmc6IHsKICAgIGxlZnQ6IDAsCiAgICByaWdodDogMAogIH0sCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiAiYXV0byIsCiAgdGljazogdHJ1ZSwKICB0aWNrQ291bnQ6IDUsCiAgdGlja0Zvcm1hdHRlcjogdm9pZCAwLAogIHRpY2tzOiB2b2lkIDAsCiAgdHlwZTogImNhdGVnb3J5IiwKICB1bml0OiB2b2lkIDAKfTsKdmFyIHNlbGVjdFhBeGlzU2V0dGluZ3NOb0RlZmF1bHRzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICByZXR1cm4gc3RhdGUuY2FydGVzaWFuQXhpcy54QXhpc1theGlzSWRdOwp9Owp2YXIgc2VsZWN0WEF4aXNTZXR0aW5ncyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIGF4aXMgPSBzZWxlY3RYQXhpc1NldHRpbmdzTm9EZWZhdWx0cyhzdGF0ZSwgYXhpc0lkKTsKICBpZiAoYXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gaW1wbGljaXRYQXhpczsKICB9CiAgcmV0dXJuIGF4aXM7Cn07CnZhciBpbXBsaWNpdFlBeGlzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBmYWxzZSwKICBhbGxvd0RlY2ltYWxzOiB0cnVlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiB0cnVlLAogIGFuZ2xlOiAwLAogIGRhdGFLZXk6IHZvaWQgMCwKICBkb21haW46IGRlZmF1bHROdW1lcmljRG9tYWluLAogIGhpZGU6IHRydWUsCiAgaWQ6IDAsCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgaW50ZXJ2YWw6ICJwcmVzZXJ2ZUVuZCIsCiAgbWluVGlja0dhcDogNSwKICBtaXJyb3I6IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICBvcmllbnRhdGlvbjogImxlZnQiLAogIHBhZGRpbmc6IHsKICAgIHRvcDogMCwKICAgIGJvdHRvbTogMAogIH0sCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiAiYXV0byIsCiAgdGljazogdHJ1ZSwKICB0aWNrQ291bnQ6IDUsCiAgdGlja0Zvcm1hdHRlcjogdm9pZCAwLAogIHRpY2tzOiB2b2lkIDAsCiAgdHlwZTogIm51bWJlciIsCiAgdW5pdDogdm9pZCAwLAogIHdpZHRoOiBERUZBVUxUX1lfQVhJU19XSURUSAp9Owp2YXIgc2VsZWN0WUF4aXNTZXR0aW5nc05vRGVmYXVsdHMgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHJldHVybiBzdGF0ZS5jYXJ0ZXNpYW5BeGlzLnlBeGlzW2F4aXNJZF07Cn07CnZhciBzZWxlY3RZQXhpc1NldHRpbmdzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICB2YXIgYXhpcyA9IHNlbGVjdFlBeGlzU2V0dGluZ3NOb0RlZmF1bHRzKHN0YXRlLCBheGlzSWQpOwogIGlmIChheGlzID09IG51bGwpIHsKICAgIHJldHVybiBpbXBsaWNpdFlBeGlzOwogIH0KICByZXR1cm4gYXhpczsKfTsKdmFyIGltcGxpY2l0WkF4aXMgPSB7CiAgZG9tYWluOiBbMCwgImF1dG8iXSwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICByZXZlcnNlZDogZmFsc2UsCiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBmYWxzZSwKICBkYXRhS2V5OiB2b2lkIDAsCiAgaWQ6IDAsCiAgbmFtZTogIiIsCiAgcmFuZ2U6IFs2NCwgNjRdLAogIHNjYWxlOiAiYXV0byIsCiAgdHlwZTogIm51bWJlciIsCiAgdW5pdDogIiIKfTsKdmFyIHNlbGVjdFpBeGlzU2V0dGluZ3MgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciBheGlzID0gc3RhdGUuY2FydGVzaWFuQXhpcy56QXhpc1theGlzSWRdOwogIGlmIChheGlzID09IG51bGwpIHsKICAgIHJldHVybiBpbXBsaWNpdFpBeGlzOwogIH0KICByZXR1cm4gYXhpczsKfTsKdmFyIHNlbGVjdEJhc2VBeGlzID0gKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkKSA9PiB7CiAgc3dpdGNoIChheGlzVHlwZSkgewogICAgY2FzZSAieEF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAieUF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAiekF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RaQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAiYW5nbGVBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0QW5nbGVBeGlzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAicmFkaXVzQXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFJhZGl1c0F4aXMoc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgYXhpcyB0eXBlOiAiLmNvbmNhdChheGlzVHlwZSkpOwogIH0KfTsKdmFyIHNlbGVjdENhcnRlc2lhbkF4aXNTZXR0aW5ncyA9IChzdGF0ZSwgYXhpc1R5cGUsIGF4aXNJZCkgPT4gewogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WEF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgInlBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WUF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5leHBlY3RlZCBheGlzIHR5cGU6ICIuY29uY2F0KGF4aXNUeXBlKSk7CiAgfQp9Owp2YXIgc2VsZWN0QXhpc1NldHRpbmdzID0gKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkKSA9PiB7CiAgc3dpdGNoIChheGlzVHlwZSkgewogICAgY2FzZSAieEF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAieUF4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAiYW5nbGVBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0QW5nbGVBeGlzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgY2FzZSAicmFkaXVzQXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFJhZGl1c0F4aXMoc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgYXhpcyB0eXBlOiAiLmNvbmNhdChheGlzVHlwZSkpOwogIH0KfTsKdmFyIHNlbGVjdEhhc0JhciA9IChzdGF0ZSkgPT4gc3RhdGUuZ3JhcGhpY2FsSXRlbXMuY2FydGVzaWFuSXRlbXMuc29tZSgoaXRlbSkgPT4gaXRlbS50eXBlID09PSAiYmFyIikgfHwgc3RhdGUuZ3JhcGhpY2FsSXRlbXMucG9sYXJJdGVtcy5zb21lKChpdGVtKSA9PiBpdGVtLnR5cGUgPT09ICJyYWRpYWxCYXIiKTsKZnVuY3Rpb24gaXRlbUF4aXNQcmVkaWNhdGUoYXhpc1R5cGUsIGF4aXNJZCkgewogIHJldHVybiAoaXRlbSkgPT4gewogICAgc3dpdGNoIChheGlzVHlwZSkgewogICAgICBjYXNlICJ4QXhpcyI6CiAgICAgICAgcmV0dXJuICJ4QXhpc0lkIiBpbiBpdGVtICYmIGl0ZW0ueEF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJ5QXhpcyI6CiAgICAgICAgcmV0dXJuICJ5QXhpc0lkIiBpbiBpdGVtICYmIGl0ZW0ueUF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJ6QXhpcyI6CiAgICAgICAgcmV0dXJuICJ6QXhpc0lkIiBpbiBpdGVtICYmIGl0ZW0uekF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJhbmdsZUF4aXMiOgogICAgICAgIHJldHVybiAiYW5nbGVBeGlzSWQiIGluIGl0ZW0gJiYgaXRlbS5hbmdsZUF4aXNJZCA9PT0gYXhpc0lkOwogICAgICBjYXNlICJyYWRpdXNBeGlzIjoKICAgICAgICByZXR1cm4gInJhZGl1c0F4aXNJZCIgaW4gaXRlbSAmJiBpdGVtLnJhZGl1c0F4aXNJZCA9PT0gYXhpc0lkOwogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9Owp9CnZhciBzZWxlY3RVbmZpbHRlcmVkQ2FydGVzaWFuSXRlbXMgPSAoc3RhdGUpID0+IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLmNhcnRlc2lhbkl0ZW1zOwp2YXIgc2VsZWN0QXhpc1ByZWRpY2F0ZSA9IGNyZWF0ZVNlbGVjdG9yKFtwaWNrQXhpc1R5cGUsIHBpY2tBeGlzSWRdLCBpdGVtQXhpc1ByZWRpY2F0ZSk7CnZhciBjb21iaW5lR3JhcGhpY2FsSXRlbXNTZXR0aW5ncyA9IChncmFwaGljYWxJdGVtcywgYXhpc1NldHRpbmdzLCBheGlzUHJlZGljYXRlKSA9PiBncmFwaGljYWxJdGVtcy5maWx0ZXIoYXhpc1ByZWRpY2F0ZSkuZmlsdGVyKChpdGVtKSA9PiB7CiAgaWYgKChheGlzU2V0dGluZ3MgPT09IG51bGwgfHwgYXhpc1NldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzU2V0dGluZ3MuaW5jbHVkZUhpZGRlbikgPT09IHRydWUpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gIWl0ZW0uaGlkZTsKfSk7CnZhciBzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFVuZmlsdGVyZWRDYXJ0ZXNpYW5JdGVtcywgc2VsZWN0QmFzZUF4aXMsIHNlbGVjdEF4aXNQcmVkaWNhdGVdLCBjb21iaW5lR3JhcGhpY2FsSXRlbXNTZXR0aW5ncywgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBlbXB0eUFycmF5c0FyZUVxdWFsQ2hlY2sKICB9Cn0pOwp2YXIgc2VsZWN0U3RhY2tlZENhcnRlc2lhbkl0ZW1zU2V0dGluZ3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2FydGVzaWFuSXRlbXNTZXR0aW5nc10sIChjYXJ0ZXNpYW5JdGVtcykgPT4gewogIHJldHVybiBjYXJ0ZXNpYW5JdGVtcy5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0udHlwZSA9PT0gImFyZWEiIHx8IGl0ZW0udHlwZSA9PT0gImJhciIpLmZpbHRlcihpc1N0YWNrZWQpOwp9KTsKdmFyIGZpbHRlckdyYXBoaWNhbE5vdFN0YWNrZWRJdGVtcyA9IChjYXJ0ZXNpYW5JdGVtcykgPT4gY2FydGVzaWFuSXRlbXMuZmlsdGVyKChpdGVtKSA9PiAhKCJzdGFja0lkIiBpbiBpdGVtKSB8fCBpdGVtLnN0YWNrSWQgPT09IHZvaWQgMCk7CnZhciBzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzRXhjZXB0U3RhY2tlZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzXSwgZmlsdGVyR3JhcGhpY2FsTm90U3RhY2tlZEl0ZW1zKTsKdmFyIGNvbWJpbmVHcmFwaGljYWxJdGVtc0RhdGEgPSAoY2FydGVzaWFuSXRlbXMpID0+IGNhcnRlc2lhbkl0ZW1zLm1hcCgoaXRlbSkgPT4gaXRlbS5kYXRhKS5maWx0ZXIoQm9vbGVhbikuZmxhdCgxKTsKdmFyIHNlbGVjdENhcnRlc2lhbkdyYXBoaWNhbEl0ZW1zRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzXSwgY29tYmluZUdyYXBoaWNhbEl0ZW1zRGF0YSwgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBlbXB0eUFycmF5c0FyZUVxdWFsQ2hlY2sKICB9Cn0pOwp2YXIgY29tYmluZURpc3BsYXllZERhdGEgPSAoZ3JhcGhpY2FsSXRlbXNEYXRhLCBfcmVmMikgPT4gewogIHZhciB7CiAgICBjaGFydERhdGEgPSBbXSwKICAgIGRhdGFTdGFydEluZGV4LAogICAgZGF0YUVuZEluZGV4CiAgfSA9IF9yZWYyOwogIGlmIChncmFwaGljYWxJdGVtc0RhdGEubGVuZ3RoID4gMCkgewogICAgcmV0dXJuIGdyYXBoaWNhbEl0ZW1zRGF0YTsKICB9CiAgcmV0dXJuIGNoYXJ0RGF0YS5zbGljZShkYXRhU3RhcnRJbmRleCwgZGF0YUVuZEluZGV4ICsgMSk7Cn07CnZhciBzZWxlY3REaXNwbGF5ZWREYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENhcnRlc2lhbkdyYXBoaWNhbEl0ZW1zRGF0YSwgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXNJZk5vdEluUGFub3JhbWFdLCBjb21iaW5lRGlzcGxheWVkRGF0YSk7CnZhciBjb21iaW5lQXBwbGllZFZhbHVlcyA9IChkYXRhLCBheGlzU2V0dGluZ3MsIGl0ZW1zKSA9PiB7CiAgaWYgKChheGlzU2V0dGluZ3MgPT09IG51bGwgfHwgYXhpc1NldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzU2V0dGluZ3MuZGF0YUtleSkgIT0gbnVsbCkgewogICAgcmV0dXJuIGRhdGEubWFwKChpdGVtKSA9PiAoewogICAgICB2YWx1ZTogZ2V0VmFsdWVCeURhdGFLZXkoaXRlbSwgYXhpc1NldHRpbmdzLmRhdGFLZXkpCiAgICB9KSk7CiAgfQogIGlmIChpdGVtcy5sZW5ndGggPiAwKSB7CiAgICByZXR1cm4gaXRlbXMubWFwKChpdGVtKSA9PiBpdGVtLmRhdGFLZXkpLmZsYXRNYXAoKGRhdGFLZXkpID0+IGRhdGEubWFwKChlbnRyeSkgPT4gKHsKICAgICAgdmFsdWU6IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCBkYXRhS2V5KQogICAgfSkpKTsKICB9CiAgcmV0dXJuIGRhdGEubWFwKChlbnRyeSkgPT4gKHsKICAgIHZhbHVlOiBlbnRyeQogIH0pKTsKfTsKdmFyIHNlbGVjdEFsbEFwcGxpZWRWYWx1ZXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RGlzcGxheWVkRGF0YSwgc2VsZWN0QmFzZUF4aXMsIHNlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3NdLCBjb21iaW5lQXBwbGllZFZhbHVlcyk7CmZ1bmN0aW9uIGlzRXJyb3JCYXJSZWxldmFudEZvckF4aXNUeXBlKGF4aXNUeXBlLCBlcnJvckJhcikgewogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjoKICAgICAgcmV0dXJuIGVycm9yQmFyLmRpcmVjdGlvbiA9PT0gIngiOwogICAgY2FzZSAieUF4aXMiOgogICAgICByZXR1cm4gZXJyb3JCYXIuZGlyZWN0aW9uID09PSAieSI7CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gZmFsc2U7CiAgfQp9CmZ1bmN0aW9uIG1ha2VOdW1iZXIodmFsKSB7CiAgaWYgKGlzTnVtT3JTdHIodmFsKSB8fCB2YWwgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICB2YXIgbiA9IE51bWJlcih2YWwpOwogICAgaWYgKGlzV2VsbEJlaGF2ZWROdW1iZXIobikpIHsKICAgICAgcmV0dXJuIG47CiAgICB9CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KZnVuY3Rpb24gbWFrZURvbWFpbih2YWwpIHsKICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7CiAgICB2YXIgYXR0ZW1wdCA9IFttYWtlTnVtYmVyKHZhbFswXSksIG1ha2VOdW1iZXIodmFsWzFdKV07CiAgICBpZiAoaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKGF0dGVtcHQpKSB7CiAgICAgIHJldHVybiBhdHRlbXB0OwogICAgfQogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIG4gPSBtYWtlTnVtYmVyKHZhbCk7CiAgaWYgKG4gPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtuLCBuXTsKfQpmdW5jdGlvbiBvbmx5QWxsb3dOdW1iZXJzKGRhdGEpIHsKICByZXR1cm4gZGF0YS5tYXAobWFrZU51bWJlcikuZmlsdGVyKGlzTm90TmlsKTsKfQpmdW5jdGlvbiBnZXRFcnJvckRvbWFpbkJ5RGF0YUtleShlbnRyeSwgYXBwbGllZFZhbHVlLCByZWxldmFudEVycm9yQmFycykgewogIGlmICghcmVsZXZhbnRFcnJvckJhcnMgfHwgdHlwZW9mIGFwcGxpZWRWYWx1ZSAhPT0gIm51bWJlciIgfHwgaXNOYW4oYXBwbGllZFZhbHVlKSkgewogICAgcmV0dXJuIFtdOwogIH0KICBpZiAoIXJlbGV2YW50RXJyb3JCYXJzLmxlbmd0aCkgewogICAgcmV0dXJuIFtdOwogIH0KICByZXR1cm4gb25seUFsbG93TnVtYmVycyhyZWxldmFudEVycm9yQmFycy5mbGF0TWFwKChlYikgPT4gewogICAgdmFyIGVycm9yVmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZWIuZGF0YUtleSk7CiAgICB2YXIgbG93Qm91bmQsIGhpZ2hCb3VuZDsKICAgIGlmIChBcnJheS5pc0FycmF5KGVycm9yVmFsdWUpKSB7CiAgICAgIFtsb3dCb3VuZCwgaGlnaEJvdW5kXSA9IGVycm9yVmFsdWU7CiAgICB9IGVsc2UgewogICAgICBsb3dCb3VuZCA9IGhpZ2hCb3VuZCA9IGVycm9yVmFsdWU7CiAgICB9CiAgICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIobG93Qm91bmQpIHx8ICFpc1dlbGxCZWhhdmVkTnVtYmVyKGhpZ2hCb3VuZCkpIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIHJldHVybiBbYXBwbGllZFZhbHVlIC0gbG93Qm91bmQsIGFwcGxpZWRWYWx1ZSArIGhpZ2hCb3VuZF07CiAgfSkpOwp9CnZhciBzZWxlY3RUb29sdGlwQXhpcyA9IChzdGF0ZSkgPT4gewogIHZhciBheGlzVHlwZSA9IHNlbGVjdFRvb2x0aXBBeGlzVHlwZShzdGF0ZSk7CiAgdmFyIGF4aXNJZCA9IHNlbGVjdFRvb2x0aXBBeGlzSWQoc3RhdGUpOwogIHJldHVybiBzZWxlY3RBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNUeXBlLCBheGlzSWQpOwp9Owp2YXIgc2VsZWN0VG9vbHRpcEF4aXNEYXRhS2V5ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzXSwgKGF4aXMpID0+IGF4aXMgPT09IG51bGwgfHwgYXhpcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpcy5kYXRhS2V5KTsKdmFyIHNlbGVjdERpc3BsYXllZFN0YWNrZWREYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFN0YWNrZWRDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzLCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlc0lmTm90SW5QYW5vcmFtYSwgc2VsZWN0VG9vbHRpcEF4aXNdLCBjb21iaW5lRGlzcGxheWVkU3RhY2tlZERhdGEpOwp2YXIgY29tYmluZVN0YWNrR3JvdXBzID0gKGRpc3BsYXllZERhdGEsIGl0ZW1zLCBzdGFja09mZnNldFR5cGUsIHJldmVyc2VTdGFja09yZGVyKSA9PiB7CiAgdmFyIGluaXRpYWxJdGVtc0dyb3VwcyA9IHt9OwogIHZhciBpdGVtc0dyb3VwID0gaXRlbXMucmVkdWNlKChhY2MsIGl0ZW0pID0+IHsKICAgIGlmIChpdGVtLnN0YWNrSWQgPT0gbnVsbCkgewogICAgICByZXR1cm4gYWNjOwogICAgfQogICAgaWYgKGFjY1tpdGVtLnN0YWNrSWRdID09IG51bGwpIHsKICAgICAgYWNjW2l0ZW0uc3RhY2tJZF0gPSBbXTsKICAgIH0KICAgIGFjY1tpdGVtLnN0YWNrSWRdLnB1c2goaXRlbSk7CiAgICByZXR1cm4gYWNjOwogIH0sIGluaXRpYWxJdGVtc0dyb3Vwcyk7CiAgcmV0dXJuIE9iamVjdC5mcm9tRW50cmllcyhPYmplY3QuZW50cmllcyhpdGVtc0dyb3VwKS5tYXAoKF9yZWYyKSA9PiB7CiAgICB2YXIgW3N0YWNrSWQsIGdyYXBoaWNhbEl0ZW1zXSA9IF9yZWYyOwogICAgdmFyIG9yZGVyZWRHcmFwaGljYWxJdGVtcyA9IHJldmVyc2VTdGFja09yZGVyID8gWy4uLmdyYXBoaWNhbEl0ZW1zXS5yZXZlcnNlKCkgOiBncmFwaGljYWxJdGVtczsKICAgIHZhciBkYXRhS2V5cyA9IG9yZGVyZWRHcmFwaGljYWxJdGVtcy5tYXAoZ2V0U3RhY2tTZXJpZXNJZGVudGlmaWVyKTsKICAgIHJldHVybiBbc3RhY2tJZCwgewogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGdldFN0YWNrZWREYXRhIHJlcXVpcmVzIHRoYXQgdGhlIGlucHV0IGlzIGFycmF5IG9mIG9iamVjdHMsIFJlY2hhcnRzIGRvZXMgbm90IHRlc3QgZm9yIHRoYXQKICAgICAgc3RhY2tlZERhdGE6IGdldFN0YWNrZWREYXRhKGRpc3BsYXllZERhdGEsIGRhdGFLZXlzLCBzdGFja09mZnNldFR5cGUpLAogICAgICBncmFwaGljYWxJdGVtczogb3JkZXJlZEdyYXBoaWNhbEl0ZW1zCiAgICB9XTsKICB9KSk7Cn07CnZhciBzZWxlY3RTdGFja0dyb3VwcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3REaXNwbGF5ZWRTdGFja2VkRGF0YSwgc2VsZWN0U3RhY2tlZENhcnRlc2lhbkl0ZW1zU2V0dGluZ3MsIHNlbGVjdFN0YWNrT2Zmc2V0VHlwZSwgc2VsZWN0UmV2ZXJzZVN0YWNrT3JkZXJdLCBjb21iaW5lU3RhY2tHcm91cHMpOwp2YXIgY29tYmluZURvbWFpbk9mU3RhY2tHcm91cHMgPSAoc3RhY2tHcm91cHMsIF9yZWYzLCBheGlzVHlwZSwgZG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlKSA9PiB7CiAgdmFyIHsKICAgIGRhdGFTdGFydEluZGV4LAogICAgZGF0YUVuZEluZGV4CiAgfSA9IF9yZWYzOwogIGlmIChkb21haW5Gcm9tVXNlclByZWZlcmVuY2UgIT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKGF4aXNUeXBlID09PSAiekF4aXMiKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgZG9tYWluT2ZTdGFja0dyb3VwcyA9IGdldERvbWFpbk9mU3RhY2tHcm91cHMoc3RhY2tHcm91cHMsIGRhdGFTdGFydEluZGV4LCBkYXRhRW5kSW5kZXgpOwogIGlmIChkb21haW5PZlN0YWNrR3JvdXBzICE9IG51bGwgJiYgZG9tYWluT2ZTdGFja0dyb3Vwc1swXSA9PT0gMCAmJiBkb21haW5PZlN0YWNrR3JvdXBzWzFdID09PSAwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZG9tYWluT2ZTdGFja0dyb3VwczsKfTsKdmFyIHNlbGVjdEFsbG93c0RhdGFPdmVyZmxvdyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpc10sIChheGlzU2V0dGluZ3MpID0+IGF4aXNTZXR0aW5ncy5hbGxvd0RhdGFPdmVyZmxvdyk7CnZhciBnZXREb21haW5EZWZpbml0aW9uID0gKGF4aXNTZXR0aW5ncykgPT4gewogIHZhciBfYXhpc1NldHRpbmdzJGRvbWFpbjsKICBpZiAoYXhpc1NldHRpbmdzID09IG51bGwgfHwgISgiZG9tYWluIiBpbiBheGlzU2V0dGluZ3MpKSB7CiAgICByZXR1cm4gZGVmYXVsdE51bWVyaWNEb21haW47CiAgfQogIGlmIChheGlzU2V0dGluZ3MuZG9tYWluICE9IG51bGwpIHsKICAgIHJldHVybiBheGlzU2V0dGluZ3MuZG9tYWluOwogIH0KICBpZiAoYXhpc1NldHRpbmdzLnRpY2tzICE9IG51bGwpIHsKICAgIGlmIChheGlzU2V0dGluZ3MudHlwZSA9PT0gIm51bWJlciIpIHsKICAgICAgdmFyIGFsbFZhbHVlcyA9IG9ubHlBbGxvd051bWJlcnMoYXhpc1NldHRpbmdzLnRpY2tzKTsKICAgICAgcmV0dXJuIFtNYXRoLm1pbiguLi5hbGxWYWx1ZXMpLCBNYXRoLm1heCguLi5hbGxWYWx1ZXMpXTsKICAgIH0KICAgIGlmIChheGlzU2V0dGluZ3MudHlwZSA9PT0gImNhdGVnb3J5IikgewogICAgICByZXR1cm4gYXhpc1NldHRpbmdzLnRpY2tzLm1hcChTdHJpbmcpOwogICAgfQogIH0KICByZXR1cm4gKF9heGlzU2V0dGluZ3MkZG9tYWluID0gYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLmRvbWFpbikgIT09IG51bGwgJiYgX2F4aXNTZXR0aW5ncyRkb21haW4gIT09IHZvaWQgMCA/IF9heGlzU2V0dGluZ3MkZG9tYWluIDogZGVmYXVsdE51bWVyaWNEb21haW47Cn07CnZhciBzZWxlY3REb21haW5EZWZpbml0aW9uID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzXSwgZ2V0RG9tYWluRGVmaW5pdGlvbik7CnZhciBzZWxlY3REb21haW5Gcm9tVXNlclByZWZlcmVuY2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RG9tYWluRGVmaW5pdGlvbiwgc2VsZWN0QWxsb3dzRGF0YU92ZXJmbG93XSwgbnVtZXJpY2FsRG9tYWluU3BlY2lmaWVkV2l0aG91dFJlcXVpcmluZ0RhdGEpOwp2YXIgc2VsZWN0RG9tYWluT2ZTdGFja0dyb3VwcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RTdGFja0dyb3Vwcywgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHBpY2tBeGlzVHlwZSwgc2VsZWN0RG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlXSwgY29tYmluZURvbWFpbk9mU3RhY2tHcm91cHMsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjawogIH0KfSk7CnZhciBzZWxlY3RBbGxFcnJvckJhclNldHRpbmdzID0gKHN0YXRlKSA9PiBzdGF0ZS5lcnJvckJhcnM7CnZhciBjb21iaW5lUmVsZXZhbnRFcnJvckJhclNldHRpbmdzID0gKGNhcnRlc2lhbkl0ZW1zU2V0dGluZ3MsIGFsbEVycm9yQmFyU2V0dGluZ3MsIGF4aXNUeXBlKSA9PiB7CiAgcmV0dXJuIGNhcnRlc2lhbkl0ZW1zU2V0dGluZ3MuZmxhdE1hcCgoaXRlbSkgPT4gewogICAgcmV0dXJuIGFsbEVycm9yQmFyU2V0dGluZ3NbaXRlbS5pZF07CiAgfSkuZmlsdGVyKEJvb2xlYW4pLmZpbHRlcigoZSkgPT4gewogICAgcmV0dXJuIGlzRXJyb3JCYXJSZWxldmFudEZvckF4aXNUeXBlKGF4aXNUeXBlLCBlKTsKICB9KTsKfTsKdmFyIG1lcmdlRG9tYWlucyA9IGZ1bmN0aW9uIG1lcmdlRG9tYWluczIoKSB7CiAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGRvbWFpbnMgPSBuZXcgQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICBkb21haW5zW19rZXldID0gYXJndW1lbnRzW19rZXldOwogIH0KICB2YXIgYWxsRG9tYWlucyA9IGRvbWFpbnMuZmlsdGVyKEJvb2xlYW4pOwogIGlmIChhbGxEb21haW5zLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGFsbFZhbHVlcyA9IGFsbERvbWFpbnMuZmxhdCgpOwogIHZhciBtaW4yID0gTWF0aC5taW4oLi4uYWxsVmFsdWVzKTsKICB2YXIgbWF4MiA9IE1hdGgubWF4KC4uLmFsbFZhbHVlcyk7CiAgcmV0dXJuIFttaW4yLCBtYXgyXTsKfTsKdmFyIGNvbWJpbmVEb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlcyA9IChkYXRhLCBheGlzU2V0dGluZ3MsIGl0ZW1zLCBlcnJvckJhcnMsIGF4aXNUeXBlKSA9PiB7CiAgdmFyIGxvd2VyRW5kLCB1cHBlckVuZDsKICBpZiAoaXRlbXMubGVuZ3RoID4gMCkgewogICAgZGF0YS5mb3JFYWNoKChlbnRyeSkgPT4gewogICAgICBpdGVtcy5mb3JFYWNoKChpdGVtKSA9PiB7CiAgICAgICAgdmFyIF9lcnJvckJhcnMkaXRlbSRpZCwgX2F4aXNTZXR0aW5ncyRkYXRhS2V5OwogICAgICAgIHZhciByZWxldmFudEVycm9yQmFycyA9IChfZXJyb3JCYXJzJGl0ZW0kaWQgPSBlcnJvckJhcnNbaXRlbS5pZF0pID09PSBudWxsIHx8IF9lcnJvckJhcnMkaXRlbSRpZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Vycm9yQmFycyRpdGVtJGlkLmZpbHRlcigoZXJyb3JCYXIpID0+IGlzRXJyb3JCYXJSZWxldmFudEZvckF4aXNUeXBlKGF4aXNUeXBlLCBlcnJvckJhcikpOwogICAgICAgIHZhciB2YWx1ZUJ5RGF0YUtleSA9IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCAoX2F4aXNTZXR0aW5ncyRkYXRhS2V5ID0gYXhpc1NldHRpbmdzLmRhdGFLZXkpICE9PSBudWxsICYmIF9heGlzU2V0dGluZ3MkZGF0YUtleSAhPT0gdm9pZCAwID8gX2F4aXNTZXR0aW5ncyRkYXRhS2V5IDogaXRlbS5kYXRhS2V5KTsKICAgICAgICB2YXIgZXJyb3JEb21haW4gPSBnZXRFcnJvckRvbWFpbkJ5RGF0YUtleShlbnRyeSwgdmFsdWVCeURhdGFLZXksIHJlbGV2YW50RXJyb3JCYXJzKTsKICAgICAgICBpZiAoZXJyb3JEb21haW4ubGVuZ3RoID49IDIpIHsKICAgICAgICAgIHZhciBsb2NhbExvd2VyID0gTWF0aC5taW4oLi4uZXJyb3JEb21haW4pOwogICAgICAgICAgdmFyIGxvY2FsVXBwZXIgPSBNYXRoLm1heCguLi5lcnJvckRvbWFpbik7CiAgICAgICAgICBpZiAobG93ZXJFbmQgPT0gbnVsbCB8fCBsb2NhbExvd2VyIDwgbG93ZXJFbmQpIHsKICAgICAgICAgICAgbG93ZXJFbmQgPSBsb2NhbExvd2VyOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHVwcGVyRW5kID09IG51bGwgfHwgbG9jYWxVcHBlciA+IHVwcGVyRW5kKSB7CiAgICAgICAgICAgIHVwcGVyRW5kID0gbG9jYWxVcHBlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRhdGFWYWx1ZURvbWFpbiA9IG1ha2VEb21haW4odmFsdWVCeURhdGFLZXkpOwogICAgICAgIGlmIChkYXRhVmFsdWVEb21haW4gIT0gbnVsbCkgewogICAgICAgICAgbG93ZXJFbmQgPSBsb3dlckVuZCA9PSBudWxsID8gZGF0YVZhbHVlRG9tYWluWzBdIDogTWF0aC5taW4obG93ZXJFbmQsIGRhdGFWYWx1ZURvbWFpblswXSk7CiAgICAgICAgICB1cHBlckVuZCA9IHVwcGVyRW5kID09IG51bGwgPyBkYXRhVmFsdWVEb21haW5bMV0gOiBNYXRoLm1heCh1cHBlckVuZCwgZGF0YVZhbHVlRG9tYWluWzFdKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSk7CiAgfQogIGlmICgoYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLmRhdGFLZXkpICE9IG51bGwpIHsKICAgIGRhdGEuZm9yRWFjaCgoaXRlbSkgPT4gewogICAgICB2YXIgZGF0YVZhbHVlRG9tYWluID0gbWFrZURvbWFpbihnZXRWYWx1ZUJ5RGF0YUtleShpdGVtLCBheGlzU2V0dGluZ3MuZGF0YUtleSkpOwogICAgICBpZiAoZGF0YVZhbHVlRG9tYWluICE9IG51bGwpIHsKICAgICAgICBsb3dlckVuZCA9IGxvd2VyRW5kID09IG51bGwgPyBkYXRhVmFsdWVEb21haW5bMF0gOiBNYXRoLm1pbihsb3dlckVuZCwgZGF0YVZhbHVlRG9tYWluWzBdKTsKICAgICAgICB1cHBlckVuZCA9IHVwcGVyRW5kID09IG51bGwgPyBkYXRhVmFsdWVEb21haW5bMV0gOiBNYXRoLm1heCh1cHBlckVuZCwgZGF0YVZhbHVlRG9tYWluWzFdKTsKICAgICAgfQogICAgfSk7CiAgfQogIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKGxvd2VyRW5kKSAmJiBpc1dlbGxCZWhhdmVkTnVtYmVyKHVwcGVyRW5kKSkgewogICAgcmV0dXJuIFtsb3dlckVuZCwgdXBwZXJFbmRdOwogIH0KICByZXR1cm4gdm9pZCAwOwp9Owp2YXIgc2VsZWN0RG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RGlzcGxheWVkRGF0YSwgc2VsZWN0QmFzZUF4aXMsIHNlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3NFeGNlcHRTdGFja2VkLCBzZWxlY3RBbGxFcnJvckJhclNldHRpbmdzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lRG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjawogIH0KfSk7CmZ1bmN0aW9uIG9ubHlBbGxvd051bWJlcnNBbmRTdHJpbmdzQW5kRGF0ZXMoaXRlbSkgewogIHZhciB7CiAgICB2YWx1ZQogIH0gPSBpdGVtOwogIGlmIChpc051bU9yU3RyKHZhbHVlKSB8fCB2YWx1ZSBpbnN0YW5jZW9mIERhdGUpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQp2YXIgY29tcHV0ZURvbWFpbk9mVHlwZUNhdGVnb3J5ID0gKGFsbERhdGFTcXVpc2hlZCwgYXhpc1NldHRpbmdzLCBpc0NhdGVnb3JpY2FsKSA9PiB7CiAgdmFyIGNhdGVnb3JpY2FsRG9tYWluID0gYWxsRGF0YVNxdWlzaGVkLm1hcChvbmx5QWxsb3dOdW1iZXJzQW5kU3RyaW5nc0FuZERhdGVzKS5maWx0ZXIoKHYpID0+IHYgIT0gbnVsbCk7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgKGF4aXNTZXR0aW5ncy5kYXRhS2V5ID09IG51bGwgfHwgYXhpc1NldHRpbmdzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5ICYmIGhhc0R1cGxpY2F0ZShjYXRlZ29yaWNhbERvbWFpbikpKSB7CiAgICByZXR1cm4gKDAsIGltcG9ydF9yYW5nZTIuZGVmYXVsdCkoMCwgYWxsRGF0YVNxdWlzaGVkLmxlbmd0aCk7CiAgfQogIGlmIChheGlzU2V0dGluZ3MuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkpIHsKICAgIHJldHVybiBjYXRlZ29yaWNhbERvbWFpbjsKICB9CiAgcmV0dXJuIEFycmF5LmZyb20obmV3IFNldChjYXRlZ29yaWNhbERvbWFpbikpOwp9Owp2YXIgc2VsZWN0UmVmZXJlbmNlRG90cyA9IChzdGF0ZSkgPT4gc3RhdGUucmVmZXJlbmNlRWxlbWVudHMuZG90czsKdmFyIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzID0gKGVsZW1lbnRzLCBheGlzVHlwZSwgYXhpc0lkKSA9PiB7CiAgcmV0dXJuIGVsZW1lbnRzLmZpbHRlcigoZWwpID0+IGVsLmlmT3ZlcmZsb3cgPT09ICJleHRlbmREb21haW4iKS5maWx0ZXIoKGVsKSA9PiB7CiAgICBpZiAoYXhpc1R5cGUgPT09ICJ4QXhpcyIpIHsKICAgICAgcmV0dXJuIGVsLnhBeGlzSWQgPT09IGF4aXNJZDsKICAgIH0KICAgIHJldHVybiBlbC55QXhpc0lkID09PSBheGlzSWQ7CiAgfSk7Cn07CnZhciBzZWxlY3RSZWZlcmVuY2VEb3RzQnlBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZURvdHMsIHBpY2tBeGlzVHlwZSwgcGlja0F4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFJlZmVyZW5jZUFyZWFzID0gKHN0YXRlKSA9PiBzdGF0ZS5yZWZlcmVuY2VFbGVtZW50cy5hcmVhczsKdmFyIHNlbGVjdFJlZmVyZW5jZUFyZWFzQnlBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUFyZWFzLCBwaWNrQXhpc1R5cGUsIHBpY2tBeGlzSWRdLCBmaWx0ZXJSZWZlcmVuY2VFbGVtZW50cyk7CnZhciBzZWxlY3RSZWZlcmVuY2VMaW5lcyA9IChzdGF0ZSkgPT4gc3RhdGUucmVmZXJlbmNlRWxlbWVudHMubGluZXM7CnZhciBzZWxlY3RSZWZlcmVuY2VMaW5lc0J5QXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VMaW5lcywgcGlja0F4aXNUeXBlLCBwaWNrQXhpc0lkXSwgZmlsdGVyUmVmZXJlbmNlRWxlbWVudHMpOwp2YXIgY29tYmluZURvdHNEb21haW4gPSAoZG90cywgYXhpc1R5cGUpID0+IHsKICB2YXIgYWxsQ29vcmRzID0gb25seUFsbG93TnVtYmVycyhkb3RzLm1hcCgoZG90KSA9PiBheGlzVHlwZSA9PT0gInhBeGlzIiA/IGRvdC54IDogZG90LnkpKTsKICBpZiAoYWxsQ29vcmRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtNYXRoLm1pbiguLi5hbGxDb29yZHMpLCBNYXRoLm1heCguLi5hbGxDb29yZHMpXTsKfTsKdmFyIHNlbGVjdFJlZmVyZW5jZURvdHNEb21haW4gPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RSZWZlcmVuY2VEb3RzQnlBeGlzLCBwaWNrQXhpc1R5cGUsIGNvbWJpbmVEb3RzRG9tYWluKTsKdmFyIGNvbWJpbmVBcmVhc0RvbWFpbiA9IChhcmVhcywgYXhpc1R5cGUpID0+IHsKICB2YXIgYWxsQ29vcmRzID0gb25seUFsbG93TnVtYmVycyhhcmVhcy5mbGF0TWFwKChhcmVhKSA9PiBbYXhpc1R5cGUgPT09ICJ4QXhpcyIgPyBhcmVhLngxIDogYXJlYS55MSwgYXhpc1R5cGUgPT09ICJ4QXhpcyIgPyBhcmVhLngyIDogYXJlYS55Ml0pKTsKICBpZiAoYWxsQ29vcmRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtNYXRoLm1pbiguLi5hbGxDb29yZHMpLCBNYXRoLm1heCguLi5hbGxDb29yZHMpXTsKfTsKdmFyIHNlbGVjdFJlZmVyZW5jZUFyZWFzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUFyZWFzQnlBeGlzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQXJlYXNEb21haW4pOwpmdW5jdGlvbiBleHRyYWN0WENvb3JkaW5hdGVzKGxpbmUpIHsKICB2YXIgX2xpbmUkc2VnbWVudDsKICBpZiAobGluZS54ICE9IG51bGwpIHsKICAgIHJldHVybiBvbmx5QWxsb3dOdW1iZXJzKFtsaW5lLnhdKTsKICB9CiAgdmFyIHNlZ21lbnRDb29yZGluYXRlcyA9IChfbGluZSRzZWdtZW50ID0gbGluZS5zZWdtZW50KSA9PT0gbnVsbCB8fCBfbGluZSRzZWdtZW50ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfbGluZSRzZWdtZW50Lm1hcCgocykgPT4gcy54KTsKICBpZiAoc2VnbWVudENvb3JkaW5hdGVzID09IG51bGwgfHwgc2VnbWVudENvb3JkaW5hdGVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIFtdOwogIH0KICByZXR1cm4gb25seUFsbG93TnVtYmVycyhzZWdtZW50Q29vcmRpbmF0ZXMpOwp9CmZ1bmN0aW9uIGV4dHJhY3RZQ29vcmRpbmF0ZXMobGluZSkgewogIHZhciBfbGluZSRzZWdtZW50MjsKICBpZiAobGluZS55ICE9IG51bGwpIHsKICAgIHJldHVybiBvbmx5QWxsb3dOdW1iZXJzKFtsaW5lLnldKTsKICB9CiAgdmFyIHNlZ21lbnRDb29yZGluYXRlcyA9IChfbGluZSRzZWdtZW50MiA9IGxpbmUuc2VnbWVudCkgPT09IG51bGwgfHwgX2xpbmUkc2VnbWVudDIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9saW5lJHNlZ21lbnQyLm1hcCgocykgPT4gcy55KTsKICBpZiAoc2VnbWVudENvb3JkaW5hdGVzID09IG51bGwgfHwgc2VnbWVudENvb3JkaW5hdGVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIFtdOwogIH0KICByZXR1cm4gb25seUFsbG93TnVtYmVycyhzZWdtZW50Q29vcmRpbmF0ZXMpOwp9CnZhciBjb21iaW5lTGluZXNEb21haW4gPSAobGluZXMsIGF4aXNUeXBlKSA9PiB7CiAgdmFyIGFsbENvb3JkcyA9IGxpbmVzLmZsYXRNYXAoKGxpbmUpID0+IGF4aXNUeXBlID09PSAieEF4aXMiID8gZXh0cmFjdFhDb29yZGluYXRlcyhsaW5lKSA6IGV4dHJhY3RZQ29vcmRpbmF0ZXMobGluZSkpOwogIGlmIChhbGxDb29yZHMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gW01hdGgubWluKC4uLmFsbENvb3JkcyksIE1hdGgubWF4KC4uLmFsbENvb3JkcyldOwp9Owp2YXIgc2VsZWN0UmVmZXJlbmNlTGluZXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlTGluZXNCeUF4aXMsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVMaW5lc0RvbWFpbik7CnZhciBzZWxlY3RSZWZlcmVuY2VFbGVtZW50c0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFJlZmVyZW5jZURvdHNEb21haW4sIHNlbGVjdFJlZmVyZW5jZUxpbmVzRG9tYWluLCBzZWxlY3RSZWZlcmVuY2VBcmVhc0RvbWFpbiwgKGRvdHNEb21haW4sIGxpbmVzRG9tYWluLCBhcmVhc0RvbWFpbikgPT4gewogIHJldHVybiBtZXJnZURvbWFpbnMoZG90c0RvbWFpbiwgYXJlYXNEb21haW4sIGxpbmVzRG9tYWluKTsKfSk7CnZhciBjb21iaW5lTnVtZXJpY2FsRG9tYWluID0gKGF4aXNTZXR0aW5ncywgZG9tYWluRGVmaW5pdGlvbiwgZG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlLCBkb21haW5PZlN0YWNrR3JvdXBzLCBkYXRhQW5kRXJyb3JCYXJzRG9tYWluLCByZWZlcmVuY2VFbGVtZW50c0RvbWFpbiwgbGF5b3V0LCBheGlzVHlwZSkgPT4gewogIGlmIChkb21haW5Gcm9tVXNlclByZWZlcmVuY2UgIT0gbnVsbCkgewogICAgcmV0dXJuIGRvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZTsKICB9CiAgdmFyIHNob3VsZEluY2x1ZGVEb21haW5PZlN0YWNrR3JvdXBzID0gbGF5b3V0ID09PSAidmVydGljYWwiICYmIGF4aXNUeXBlID09PSAieEF4aXMiIHx8IGxheW91dCA9PT0gImhvcml6b250YWwiICYmIGF4aXNUeXBlID09PSAieUF4aXMiOwogIHZhciBtZXJnZWREb21haW5zID0gc2hvdWxkSW5jbHVkZURvbWFpbk9mU3RhY2tHcm91cHMgPyBtZXJnZURvbWFpbnMoZG9tYWluT2ZTdGFja0dyb3VwcywgcmVmZXJlbmNlRWxlbWVudHNEb21haW4sIGRhdGFBbmRFcnJvckJhcnNEb21haW4pIDogbWVyZ2VEb21haW5zKHJlZmVyZW5jZUVsZW1lbnRzRG9tYWluLCBkYXRhQW5kRXJyb3JCYXJzRG9tYWluKTsKICByZXR1cm4gcGFyc2VOdW1lcmljYWxVc2VyRG9tYWluKGRvbWFpbkRlZmluaXRpb24sIG1lcmdlZERvbWFpbnMsIGF4aXNTZXR0aW5ncy5hbGxvd0RhdGFPdmVyZmxvdyk7Cn07CnZhciBzZWxlY3ROdW1lcmljYWxEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdERvbWFpbkRlZmluaXRpb24sIHNlbGVjdERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZSwgc2VsZWN0RG9tYWluT2ZTdGFja0dyb3Vwcywgc2VsZWN0RG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMsIHNlbGVjdFJlZmVyZW5jZUVsZW1lbnRzRG9tYWluLCBzZWxlY3RDaGFydExheW91dCwgcGlja0F4aXNUeXBlXSwgY29tYmluZU51bWVyaWNhbERvbWFpbiwgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBudW1iZXJEb21haW5FcXVhbGl0eUNoZWNrCiAgfQp9KTsKdmFyIGV4cGFuZERvbWFpbiA9IFswLCAxXTsKdmFyIGNvbWJpbmVBeGlzRG9tYWluID0gKGF4aXNTZXR0aW5ncywgbGF5b3V0LCBkaXNwbGF5ZWREYXRhLCBhbGxBcHBsaWVkVmFsdWVzLCBzdGFja09mZnNldFR5cGUsIGF4aXNUeXBlLCBudW1lcmljYWxEb21haW4pID0+IHsKICBpZiAoKGF4aXNTZXR0aW5ncyA9PSBudWxsIHx8IGRpc3BsYXllZERhdGEgPT0gbnVsbCB8fCBkaXNwbGF5ZWREYXRhLmxlbmd0aCA9PT0gMCkgJiYgbnVtZXJpY2FsRG9tYWluID09PSB2b2lkIDApIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBkYXRhS2V5LAogICAgdHlwZQogIH0gPSBheGlzU2V0dGluZ3M7CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICBpZiAoaXNDYXRlZ29yaWNhbCAmJiBkYXRhS2V5ID09IG51bGwpIHsKICAgIHZhciBfZGlzcGxheWVkRGF0YSRsZW5ndGg7CiAgICByZXR1cm4gKDAsIGltcG9ydF9yYW5nZTIuZGVmYXVsdCkoMCwgKF9kaXNwbGF5ZWREYXRhJGxlbmd0aCA9IGRpc3BsYXllZERhdGEgPT09IG51bGwgfHwgZGlzcGxheWVkRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGlzcGxheWVkRGF0YS5sZW5ndGgpICE9PSBudWxsICYmIF9kaXNwbGF5ZWREYXRhJGxlbmd0aCAhPT0gdm9pZCAwID8gX2Rpc3BsYXllZERhdGEkbGVuZ3RoIDogMCk7CiAgfQogIGlmICh0eXBlID09PSAiY2F0ZWdvcnkiKSB7CiAgICByZXR1cm4gY29tcHV0ZURvbWFpbk9mVHlwZUNhdGVnb3J5KGFsbEFwcGxpZWRWYWx1ZXMsIGF4aXNTZXR0aW5ncywgaXNDYXRlZ29yaWNhbCk7CiAgfQogIGlmIChzdGFja09mZnNldFR5cGUgPT09ICJleHBhbmQiKSB7CiAgICByZXR1cm4gZXhwYW5kRG9tYWluOwogIH0KICByZXR1cm4gbnVtZXJpY2FsRG9tYWluOwp9Owp2YXIgc2VsZWN0QXhpc0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdERpc3BsYXllZERhdGEsIHNlbGVjdEFsbEFwcGxpZWRWYWx1ZXMsIHNlbGVjdFN0YWNrT2Zmc2V0VHlwZSwgcGlja0F4aXNUeXBlLCBzZWxlY3ROdW1lcmljYWxEb21haW5dLCBjb21iaW5lQXhpc0RvbWFpbik7CnZhciBjb21iaW5lUmVhbFNjYWxlVHlwZSA9IChheGlzQ29uZmlnLCBsYXlvdXQsIGhhc0JhciwgY2hhcnRUeXBlLCBheGlzVHlwZSkgPT4gewogIGlmIChheGlzQ29uZmlnID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBzY2FsZSwKICAgIHR5cGUKICB9ID0gYXhpc0NvbmZpZzsKICBpZiAoc2NhbGUgPT09ICJhdXRvIikgewogICAgaWYgKGxheW91dCA9PT0gInJhZGlhbCIgJiYgYXhpc1R5cGUgPT09ICJyYWRpdXNBeGlzIikgewogICAgICByZXR1cm4gImJhbmQiOwogICAgfQogICAgaWYgKGxheW91dCA9PT0gInJhZGlhbCIgJiYgYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiKSB7CiAgICAgIHJldHVybiAibGluZWFyIjsKICAgIH0KICAgIGlmICh0eXBlID09PSAiY2F0ZWdvcnkiICYmIGNoYXJ0VHlwZSAmJiAoY2hhcnRUeXBlLmluZGV4T2YoIkxpbmVDaGFydCIpID49IDAgfHwgY2hhcnRUeXBlLmluZGV4T2YoIkFyZWFDaGFydCIpID49IDAgfHwgY2hhcnRUeXBlLmluZGV4T2YoIkNvbXBvc2VkQ2hhcnQiKSA+PSAwICYmICFoYXNCYXIpKSB7CiAgICAgIHJldHVybiAicG9pbnQiOwogICAgfQogICAgaWYgKHR5cGUgPT09ICJjYXRlZ29yeSIpIHsKICAgICAgcmV0dXJuICJiYW5kIjsKICAgIH0KICAgIHJldHVybiAibGluZWFyIjsKICB9CiAgaWYgKHR5cGVvZiBzY2FsZSA9PT0gInN0cmluZyIpIHsKICAgIHZhciBuYW1lID0gInNjYWxlIi5jb25jYXQodXBwZXJGaXJzdChzY2FsZSkpOwogICAgcmV0dXJuIG5hbWUgaW4gZDNfc2NhbGVfZXhwb3J0cyA/IG5hbWUgOiAicG9pbnQiOwogIH0KICByZXR1cm4gdm9pZCAwOwp9Owp2YXIgc2VsZWN0UmVhbFNjYWxlVHlwZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEhhc0Jhciwgc2VsZWN0Q2hhcnROYW1lLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lUmVhbFNjYWxlVHlwZSk7CmZ1bmN0aW9uIGdldEQzU2NhbGVGcm9tVHlwZShyZWFsU2NhbGVUeXBlKSB7CiAgaWYgKHJlYWxTY2FsZVR5cGUgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKHJlYWxTY2FsZVR5cGUgaW4gZDNfc2NhbGVfZXhwb3J0cykgewogICAgcmV0dXJuIGQzX3NjYWxlX2V4cG9ydHNbcmVhbFNjYWxlVHlwZV0oKTsKICB9CiAgdmFyIG5hbWUgPSAic2NhbGUiLmNvbmNhdCh1cHBlckZpcnN0KHJlYWxTY2FsZVR5cGUpKTsKICBpZiAobmFtZSBpbiBkM19zY2FsZV9leHBvcnRzKSB7CiAgICByZXR1cm4gZDNfc2NhbGVfZXhwb3J0c1tuYW1lXSgpOwogIH0KICByZXR1cm4gdm9pZCAwOwp9CmZ1bmN0aW9uIGNvbWJpbmVTY2FsZUZ1bmN0aW9uKGF4aXMsIHJlYWxTY2FsZVR5cGUsIGF4aXNEb21haW4sIGF4aXNSYW5nZSkgewogIGlmIChheGlzRG9tYWluID09IG51bGwgfHwgYXhpc1JhbmdlID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmICh0eXBlb2YgYXhpcy5zY2FsZSA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIGF4aXMuc2NhbGUuY29weSgpLmRvbWFpbihheGlzRG9tYWluKS5yYW5nZShheGlzUmFuZ2UpOwogIH0KICB2YXIgZDNTY2FsZUZ1bmN0aW9uID0gZ2V0RDNTY2FsZUZyb21UeXBlKHJlYWxTY2FsZVR5cGUpOwogIGlmIChkM1NjYWxlRnVuY3Rpb24gPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHNjYWxlID0gZDNTY2FsZUZ1bmN0aW9uLmRvbWFpbihheGlzRG9tYWluKS5yYW5nZShheGlzUmFuZ2UpOwogIGNoZWNrRG9tYWluT2ZTY2FsZShzY2FsZSk7CiAgcmV0dXJuIHNjYWxlOwp9CnZhciBjb21iaW5lTmljZVRpY2tzID0gKGF4aXNEb21haW4sIGF4aXNTZXR0aW5ncywgcmVhbFNjYWxlVHlwZSkgPT4gewogIHZhciBkb21haW5EZWZpbml0aW9uID0gZ2V0RG9tYWluRGVmaW5pdGlvbihheGlzU2V0dGluZ3MpOwogIGlmIChyZWFsU2NhbGVUeXBlICE9PSAiYXV0byIgJiYgcmVhbFNjYWxlVHlwZSAhPT0gImxpbmVhciIpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChheGlzU2V0dGluZ3MgIT0gbnVsbCAmJiBheGlzU2V0dGluZ3MudGlja0NvdW50ICYmIEFycmF5LmlzQXJyYXkoZG9tYWluRGVmaW5pdGlvbikgJiYgKGRvbWFpbkRlZmluaXRpb25bMF0gPT09ICJhdXRvIiB8fCBkb21haW5EZWZpbml0aW9uWzFdID09PSAiYXV0byIpICYmIGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbihheGlzRG9tYWluKSkgewogICAgcmV0dXJuIGdldE5pY2VUaWNrVmFsdWVzKGF4aXNEb21haW4sIGF4aXNTZXR0aW5ncy50aWNrQ291bnQsIGF4aXNTZXR0aW5ncy5hbGxvd0RlY2ltYWxzKTsKICB9CiAgaWYgKGF4aXNTZXR0aW5ncyAhPSBudWxsICYmIGF4aXNTZXR0aW5ncy50aWNrQ291bnQgJiYgYXhpc1NldHRpbmdzLnR5cGUgPT09ICJudW1iZXIiICYmIGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbihheGlzRG9tYWluKSkgewogICAgcmV0dXJuIGdldFRpY2tWYWx1ZXNGaXhlZERvbWFpbihheGlzRG9tYWluLCBheGlzU2V0dGluZ3MudGlja0NvdW50LCBheGlzU2V0dGluZ3MuYWxsb3dEZWNpbWFscyk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciBzZWxlY3ROaWNlVGlja3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QXhpc0RvbWFpbiwgc2VsZWN0QXhpc1NldHRpbmdzLCBzZWxlY3RSZWFsU2NhbGVUeXBlXSwgY29tYmluZU5pY2VUaWNrcyk7CnZhciBjb21iaW5lQXhpc0RvbWFpbldpdGhOaWNlVGlja3MgPSAoYXhpc1NldHRpbmdzLCBkb21haW4sIG5pY2VUaWNrcywgYXhpc1R5cGUpID0+IHsKICBpZiAoCiAgICAvKgogICAgICogQW5nbGUgYXhpcyBmb3Igc29tZSByZWFzb24gdXNlcyBuaWNlIHRpY2tzIHdoZW4gcmVuZGVyaW5nIGF4aXMgdGljayBsYWJlbHMsCiAgICAgKiBidXQgZG9lc24ndCB1c2UgbmljZSB0aWNrcyBmb3IgZXh0ZW5kaW5nIGRvbWFpbiBsaWtlIGFsbCB0aGUgb3RoZXIgYXhlcyBkby4KICAgICAqIE5vdCByZWFsbHkgc3VyZSB3aHk/IElzIHRoZXJlIGEgZ29vZCByZWFzb24sCiAgICAgKiBvciBpcyBpdCBqdXN0IGJlY2F1c2Ugc29tZW9uZSBhZGRlZCBzdXBwb3J0IGZvciBuaWNlIHRpY2tzIHRvIHRoZSBvdGhlciBheGVzIGFuZCBmb3Jnb3QgdGhpcyBvbmU/CiAgICAgKi8KICAgIGF4aXNUeXBlICE9PSAiYW5nbGVBeGlzIiAmJiAoYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLnR5cGUpID09PSAibnVtYmVyIiAmJiBpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oZG9tYWluKSAmJiBBcnJheS5pc0FycmF5KG5pY2VUaWNrcykgJiYgbmljZVRpY2tzLmxlbmd0aCA+IDAKICApIHsKICAgIHZhciBtaW5Gcm9tRG9tYWluID0gZG9tYWluWzBdOwogICAgdmFyIG1pbkZyb21UaWNrcyA9IG5pY2VUaWNrc1swXTsKICAgIHZhciBtYXhGcm9tRG9tYWluID0gZG9tYWluWzFdOwogICAgdmFyIG1heEZyb21UaWNrcyA9IG5pY2VUaWNrc1tuaWNlVGlja3MubGVuZ3RoIC0gMV07CiAgICByZXR1cm4gW01hdGgubWluKG1pbkZyb21Eb21haW4sIG1pbkZyb21UaWNrcyksIE1hdGgubWF4KG1heEZyb21Eb21haW4sIG1heEZyb21UaWNrcyldOwogIH0KICByZXR1cm4gZG9tYWluOwp9Owp2YXIgc2VsZWN0QXhpc0RvbWFpbkluY2x1ZGluZ05pY2VUaWNrcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0QXhpc0RvbWFpbiwgc2VsZWN0TmljZVRpY2tzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQXhpc0RvbWFpbldpdGhOaWNlVGlja3MpOwp2YXIgc2VsZWN0U21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RBbGxBcHBsaWVkVmFsdWVzLCBzZWxlY3RCYXNlQXhpcywgKGFsbERhdGFTcXVpc2hlZCwgYXhpc1NldHRpbmdzKSA9PiB7CiAgaWYgKCFheGlzU2V0dGluZ3MgfHwgYXhpc1NldHRpbmdzLnR5cGUgIT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgc21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMgPSBJbmZpbml0eTsKICB2YXIgc29ydGVkVmFsdWVzID0gQXJyYXkuZnJvbShvbmx5QWxsb3dOdW1iZXJzKGFsbERhdGFTcXVpc2hlZC5tYXAoKGQpID0+IGQudmFsdWUpKSkuc29ydCgoYSwgYikgPT4gYSAtIGIpOwogIGlmIChzb3J0ZWRWYWx1ZXMubGVuZ3RoIDwgMikgewogICAgcmV0dXJuIEluZmluaXR5OwogIH0KICB2YXIgZGlmZiA9IHNvcnRlZFZhbHVlc1tzb3J0ZWRWYWx1ZXMubGVuZ3RoIC0gMV0gLSBzb3J0ZWRWYWx1ZXNbMF07CiAgaWYgKGRpZmYgPT09IDApIHsKICAgIHJldHVybiBJbmZpbml0eTsKICB9CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0ZWRWYWx1ZXMubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICB2YXIgZGlzdGFuY2UgPSBzb3J0ZWRWYWx1ZXNbaSArIDFdIC0gc29ydGVkVmFsdWVzW2ldOwogICAgc21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMgPSBNYXRoLm1pbihzbWFsbGVzdERpc3RhbmNlQmV0d2VlblZhbHVlcywgZGlzdGFuY2UpOwogIH0KICByZXR1cm4gc21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMgLyBkaWZmOwp9KTsKdmFyIHNlbGVjdENhbGN1bGF0ZWRQYWRkaW5nID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0U21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RCYXJDYXRlZ29yeUdhcCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgKF8xLCBfMiwgXzMsIHBhZGRpbmcpID0+IHBhZGRpbmcsIChzbWFsbGVzdERpc3RhbmNlSW5QZXJjZW50LCBsYXlvdXQsIGJhckNhdGVnb3J5R2FwLCBvZmZzZXQsIHBhZGRpbmcpID0+IHsKICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIoc21hbGxlc3REaXN0YW5jZUluUGVyY2VudCkpIHsKICAgIHJldHVybiAwOwogIH0KICB2YXIgcmFuZ2VXaWR0aCA9IGxheW91dCA9PT0gInZlcnRpY2FsIiA/IG9mZnNldC5oZWlnaHQgOiBvZmZzZXQud2lkdGg7CiAgaWYgKHBhZGRpbmcgPT09ICJnYXAiKSB7CiAgICByZXR1cm4gc21hbGxlc3REaXN0YW5jZUluUGVyY2VudCAqIHJhbmdlV2lkdGggLyAyOwogIH0KICBpZiAocGFkZGluZyA9PT0gIm5vLWdhcCIpIHsKICAgIHZhciBnYXAgPSBnZXRQZXJjZW50VmFsdWUoYmFyQ2F0ZWdvcnlHYXAsIHNtYWxsZXN0RGlzdGFuY2VJblBlcmNlbnQgKiByYW5nZVdpZHRoKTsKICAgIHZhciBoYWxmQmFuZCA9IHNtYWxsZXN0RGlzdGFuY2VJblBlcmNlbnQgKiByYW5nZVdpZHRoIC8gMjsKICAgIHJldHVybiBoYWxmQmFuZCAtIGdhcCAtIChoYWxmQmFuZCAtIGdhcCkgLyByYW5nZVdpZHRoICogZ2FwOwogIH0KICByZXR1cm4gMDsKfSk7CnZhciBzZWxlY3RDYWxjdWxhdGVkWEF4aXNQYWRkaW5nID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICB2YXIgeEF4aXNTZXR0aW5ncyA9IHNlbGVjdFhBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgaWYgKHhBeGlzU2V0dGluZ3MgPT0gbnVsbCB8fCB0eXBlb2YgeEF4aXNTZXR0aW5ncy5wYWRkaW5nICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIDA7CiAgfQogIHJldHVybiBzZWxlY3RDYWxjdWxhdGVkUGFkZGluZyhzdGF0ZSwgInhBeGlzIiwgYXhpc0lkLCB4QXhpc1NldHRpbmdzLnBhZGRpbmcpOwp9Owp2YXIgc2VsZWN0Q2FsY3VsYXRlZFlBeGlzUGFkZGluZyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIHlBeGlzU2V0dGluZ3MgPSBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogIGlmICh5QXhpc1NldHRpbmdzID09IG51bGwgfHwgdHlwZW9mIHlBeGlzU2V0dGluZ3MucGFkZGluZyAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiAwOwogIH0KICByZXR1cm4gc2VsZWN0Q2FsY3VsYXRlZFBhZGRpbmcoc3RhdGUsICJ5QXhpcyIsIGF4aXNJZCwgeUF4aXNTZXR0aW5ncy5wYWRkaW5nKTsKfTsKdmFyIHNlbGVjdFhBeGlzUGFkZGluZyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFhBeGlzU2V0dGluZ3MsIHNlbGVjdENhbGN1bGF0ZWRYQXhpc1BhZGRpbmcsICh4QXhpc1NldHRpbmdzLCBjYWxjdWxhdGVkKSA9PiB7CiAgdmFyIF9wYWRkaW5nJGxlZnQsIF9wYWRkaW5nJHJpZ2h0OwogIGlmICh4QXhpc1NldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB7CiAgICAgIGxlZnQ6IDAsCiAgICAgIHJpZ2h0OiAwCiAgICB9OwogIH0KICB2YXIgewogICAgcGFkZGluZwogIH0gPSB4QXhpc1NldHRpbmdzOwogIGlmICh0eXBlb2YgcGFkZGluZyA9PT0gInN0cmluZyIpIHsKICAgIHJldHVybiB7CiAgICAgIGxlZnQ6IGNhbGN1bGF0ZWQsCiAgICAgIHJpZ2h0OiBjYWxjdWxhdGVkCiAgICB9OwogIH0KICByZXR1cm4gewogICAgbGVmdDogKChfcGFkZGluZyRsZWZ0ID0gcGFkZGluZy5sZWZ0KSAhPT0gbnVsbCAmJiBfcGFkZGluZyRsZWZ0ICE9PSB2b2lkIDAgPyBfcGFkZGluZyRsZWZ0IDogMCkgKyBjYWxjdWxhdGVkLAogICAgcmlnaHQ6ICgoX3BhZGRpbmckcmlnaHQgPSBwYWRkaW5nLnJpZ2h0KSAhPT0gbnVsbCAmJiBfcGFkZGluZyRyaWdodCAhPT0gdm9pZCAwID8gX3BhZGRpbmckcmlnaHQgOiAwKSArIGNhbGN1bGF0ZWQKICB9Owp9KTsKdmFyIHNlbGVjdFlBeGlzUGFkZGluZyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFlBeGlzU2V0dGluZ3MsIHNlbGVjdENhbGN1bGF0ZWRZQXhpc1BhZGRpbmcsICh5QXhpc1NldHRpbmdzLCBjYWxjdWxhdGVkKSA9PiB7CiAgdmFyIF9wYWRkaW5nJHRvcCwgX3BhZGRpbmckYm90dG9tOwogIGlmICh5QXhpc1NldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB7CiAgICAgIHRvcDogMCwKICAgICAgYm90dG9tOiAwCiAgICB9OwogIH0KICB2YXIgewogICAgcGFkZGluZwogIH0gPSB5QXhpc1NldHRpbmdzOwogIGlmICh0eXBlb2YgcGFkZGluZyA9PT0gInN0cmluZyIpIHsKICAgIHJldHVybiB7CiAgICAgIHRvcDogY2FsY3VsYXRlZCwKICAgICAgYm90dG9tOiBjYWxjdWxhdGVkCiAgICB9OwogIH0KICByZXR1cm4gewogICAgdG9wOiAoKF9wYWRkaW5nJHRvcCA9IHBhZGRpbmcudG9wKSAhPT0gbnVsbCAmJiBfcGFkZGluZyR0b3AgIT09IHZvaWQgMCA/IF9wYWRkaW5nJHRvcCA6IDApICsgY2FsY3VsYXRlZCwKICAgIGJvdHRvbTogKChfcGFkZGluZyRib3R0b20gPSBwYWRkaW5nLmJvdHRvbSkgIT09IG51bGwgJiYgX3BhZGRpbmckYm90dG9tICE9PSB2b2lkIDAgPyBfcGFkZGluZyRib3R0b20gOiAwKSArIGNhbGN1bGF0ZWQKICB9Owp9KTsKdmFyIGNvbWJpbmVYQXhpc1JhbmdlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFhBeGlzUGFkZGluZywgc2VsZWN0QnJ1c2hEaW1lbnNpb25zLCBzZWxlY3RCcnVzaFNldHRpbmdzLCAoX3N0YXRlLCBfYXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBpc1Bhbm9yYW1hXSwgKG9mZnNldCwgcGFkZGluZywgYnJ1c2hEaW1lbnNpb25zLCBfcmVmNCwgaXNQYW5vcmFtYSkgPT4gewogIHZhciB7CiAgICBwYWRkaW5nOiBicnVzaFBhZGRpbmcKICB9ID0gX3JlZjQ7CiAgaWYgKGlzUGFub3JhbWEpIHsKICAgIHJldHVybiBbYnJ1c2hQYWRkaW5nLmxlZnQsIGJydXNoRGltZW5zaW9ucy53aWR0aCAtIGJydXNoUGFkZGluZy5yaWdodF07CiAgfQogIHJldHVybiBbb2Zmc2V0LmxlZnQgKyBwYWRkaW5nLmxlZnQsIG9mZnNldC5sZWZ0ICsgb2Zmc2V0LndpZHRoIC0gcGFkZGluZy5yaWdodF07Cn0pOwp2YXIgY29tYmluZVlBeGlzUmFuZ2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFlBeGlzUGFkZGluZywgc2VsZWN0QnJ1c2hEaW1lbnNpb25zLCBzZWxlY3RCcnVzaFNldHRpbmdzLCAoX3N0YXRlLCBfYXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBpc1Bhbm9yYW1hXSwgKG9mZnNldCwgbGF5b3V0LCBwYWRkaW5nLCBicnVzaERpbWVuc2lvbnMsIF9yZWY1LCBpc1Bhbm9yYW1hKSA9PiB7CiAgdmFyIHsKICAgIHBhZGRpbmc6IGJydXNoUGFkZGluZwogIH0gPSBfcmVmNTsKICBpZiAoaXNQYW5vcmFtYSkgewogICAgcmV0dXJuIFticnVzaERpbWVuc2lvbnMuaGVpZ2h0IC0gYnJ1c2hQYWRkaW5nLmJvdHRvbSwgYnJ1c2hQYWRkaW5nLnRvcF07CiAgfQogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIikgewogICAgcmV0dXJuIFtvZmZzZXQudG9wICsgb2Zmc2V0LmhlaWdodCAtIHBhZGRpbmcuYm90dG9tLCBvZmZzZXQudG9wICsgcGFkZGluZy50b3BdOwogIH0KICByZXR1cm4gW29mZnNldC50b3AgKyBwYWRkaW5nLnRvcCwgb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQgLSBwYWRkaW5nLmJvdHRvbV07Cn0pOwp2YXIgc2VsZWN0QXhpc1JhbmdlID0gKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiB7CiAgdmFyIF9zZWxlY3RaQXhpc1NldHRpbmdzOwogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjoKICAgICAgcmV0dXJuIGNvbWJpbmVYQXhpc1JhbmdlKHN0YXRlLCBheGlzSWQsIGlzUGFub3JhbWEpOwogICAgY2FzZSAieUF4aXMiOgogICAgICByZXR1cm4gY29tYmluZVlBeGlzUmFuZ2Uoc3RhdGUsIGF4aXNJZCwgaXNQYW5vcmFtYSk7CiAgICBjYXNlICJ6QXhpcyI6CiAgICAgIHJldHVybiAoX3NlbGVjdFpBeGlzU2V0dGluZ3MgPSBzZWxlY3RaQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpKSA9PT0gbnVsbCB8fCBfc2VsZWN0WkF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3NlbGVjdFpBeGlzU2V0dGluZ3MucmFuZ2U7CiAgICBjYXNlICJhbmdsZUF4aXMiOgogICAgICByZXR1cm4gc2VsZWN0QW5nbGVBeGlzUmFuZ2Uoc3RhdGUpOwogICAgY2FzZSAicmFkaXVzQXhpcyI6CiAgICAgIHJldHVybiBzZWxlY3RSYWRpdXNBeGlzUmFuZ2Uoc3RhdGUsIGF4aXNJZCk7CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gdm9pZCAwOwogIH0KfTsKdmFyIHNlbGVjdEF4aXNSYW5nZVdpdGhSZXZlcnNlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3RBeGlzUmFuZ2VdLCBjb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UpOwp2YXIgc2VsZWN0QXhpc1NjYWxlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3RSZWFsU2NhbGVUeXBlLCBzZWxlY3RBeGlzRG9tYWluSW5jbHVkaW5nTmljZVRpY2tzLCBzZWxlY3RBeGlzUmFuZ2VXaXRoUmV2ZXJzZV0sIGNvbWJpbmVTY2FsZUZ1bmN0aW9uKTsKdmFyIHNlbGVjdEVycm9yQmFyc1NldHRpbmdzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3MsIHNlbGVjdEFsbEVycm9yQmFyU2V0dGluZ3MsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVSZWxldmFudEVycm9yQmFyU2V0dGluZ3MpOwpmdW5jdGlvbiBjb21wYXJlSWRzKGEsIGIpIHsKICBpZiAoYS5pZCA8IGIuaWQpIHsKICAgIHJldHVybiAtMTsKICB9CiAgaWYgKGEuaWQgPiBiLmlkKSB7CiAgICByZXR1cm4gMTsKICB9CiAgcmV0dXJuIDA7Cn0KdmFyIHBpY2tBeGlzT3JpZW50YXRpb24gPSAoX3N0YXRlLCBvcmllbnRhdGlvbikgPT4gb3JpZW50YXRpb247CnZhciBwaWNrTWlycm9yID0gKF9zdGF0ZSwgX29yaWVudGF0aW9uLCBtaXJyb3IpID0+IG1pcnJvcjsKdmFyIHNlbGVjdEFsbFhBeGVzV2l0aE9mZnNldFR5cGUgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RBbGxYQXhlcywgcGlja0F4aXNPcmllbnRhdGlvbiwgcGlja01pcnJvciwgKGFsbEF4ZXMsIG9yaWVudGF0aW9uLCBtaXJyb3IpID0+IGFsbEF4ZXMuZmlsdGVyKChheGlzKSA9PiBheGlzLm9yaWVudGF0aW9uID09PSBvcmllbnRhdGlvbikuZmlsdGVyKChheGlzKSA9PiBheGlzLm1pcnJvciA9PT0gbWlycm9yKS5zb3J0KGNvbXBhcmVJZHMpKTsKdmFyIHNlbGVjdEFsbFlBeGVzV2l0aE9mZnNldFR5cGUgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RBbGxZQXhlcywgcGlja0F4aXNPcmllbnRhdGlvbiwgcGlja01pcnJvciwgKGFsbEF4ZXMsIG9yaWVudGF0aW9uLCBtaXJyb3IpID0+IGFsbEF4ZXMuZmlsdGVyKChheGlzKSA9PiBheGlzLm9yaWVudGF0aW9uID09PSBvcmllbnRhdGlvbikuZmlsdGVyKChheGlzKSA9PiBheGlzLm1pcnJvciA9PT0gbWlycm9yKS5zb3J0KGNvbXBhcmVJZHMpKTsKdmFyIGdldFhBeGlzU2l6ZSA9IChvZmZzZXQsIGF4aXNTZXR0aW5ncykgPT4gewogIHJldHVybiB7CiAgICB3aWR0aDogb2Zmc2V0LndpZHRoLAogICAgaGVpZ2h0OiBheGlzU2V0dGluZ3MuaGVpZ2h0CiAgfTsKfTsKdmFyIGdldFlBeGlzU2l6ZSA9IChvZmZzZXQsIGF4aXNTZXR0aW5ncykgPT4gewogIHZhciB3aWR0aCA9IHR5cGVvZiBheGlzU2V0dGluZ3Mud2lkdGggPT09ICJudW1iZXIiID8gYXhpc1NldHRpbmdzLndpZHRoIDogREVGQVVMVF9ZX0FYSVNfV0lEVEg7CiAgcmV0dXJuIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0OiBvZmZzZXQuaGVpZ2h0CiAgfTsKfTsKdmFyIHNlbGVjdFhBeGlzU2l6ZSA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFhBeGlzU2V0dGluZ3MsIGdldFhBeGlzU2l6ZSk7CnZhciBjb21iaW5lWEF4aXNQb3NpdGlvblN0YXJ0aW5nUG9pbnQgPSAob2Zmc2V0LCBvcmllbnRhdGlvbiwgY2hhcnRIZWlnaHQpID0+IHsKICBzd2l0Y2ggKG9yaWVudGF0aW9uKSB7CiAgICBjYXNlICJ0b3AiOgogICAgICByZXR1cm4gb2Zmc2V0LnRvcDsKICAgIGNhc2UgImJvdHRvbSI6CiAgICAgIHJldHVybiBjaGFydEhlaWdodCAtIG9mZnNldC5ib3R0b207CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gMDsKICB9Cn07CnZhciBjb21iaW5lWUF4aXNQb3NpdGlvblN0YXJ0aW5nUG9pbnQgPSAob2Zmc2V0LCBvcmllbnRhdGlvbiwgY2hhcnRXaWR0aCkgPT4gewogIHN3aXRjaCAob3JpZW50YXRpb24pIHsKICAgIGNhc2UgImxlZnQiOgogICAgICByZXR1cm4gb2Zmc2V0LmxlZnQ7CiAgICBjYXNlICJyaWdodCI6CiAgICAgIHJldHVybiBjaGFydFdpZHRoIC0gb2Zmc2V0LnJpZ2h0OwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIDA7CiAgfQp9Owp2YXIgc2VsZWN0QWxsWEF4ZXNPZmZzZXRTdGVwcyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RBbGxYQXhlc1dpdGhPZmZzZXRUeXBlLCBwaWNrQXhpc09yaWVudGF0aW9uLCBwaWNrTWlycm9yLCAoY2hhcnRIZWlnaHQsIG9mZnNldCwgYWxsQXhlc1dpdGhTYW1lT2Zmc2V0VHlwZSwgb3JpZW50YXRpb24sIG1pcnJvcikgPT4gewogIHZhciBzdGVwcyA9IHt9OwogIHZhciBwb3NpdGlvbjsKICBhbGxBeGVzV2l0aFNhbWVPZmZzZXRUeXBlLmZvckVhY2goKGF4aXMpID0+IHsKICAgIHZhciBheGlzU2l6ZSA9IGdldFhBeGlzU2l6ZShvZmZzZXQsIGF4aXMpOwogICAgaWYgKHBvc2l0aW9uID09IG51bGwpIHsKICAgICAgcG9zaXRpb24gPSBjb21iaW5lWEF4aXNQb3NpdGlvblN0YXJ0aW5nUG9pbnQob2Zmc2V0LCBvcmllbnRhdGlvbiwgY2hhcnRIZWlnaHQpOwogICAgfQogICAgdmFyIG5lZWRTcGFjZSA9IG9yaWVudGF0aW9uID09PSAidG9wIiAmJiAhbWlycm9yIHx8IG9yaWVudGF0aW9uID09PSAiYm90dG9tIiAmJiBtaXJyb3I7CiAgICBzdGVwc1theGlzLmlkXSA9IHBvc2l0aW9uIC0gTnVtYmVyKG5lZWRTcGFjZSkgKiBheGlzU2l6ZS5oZWlnaHQ7CiAgICBwb3NpdGlvbiArPSAobmVlZFNwYWNlID8gLTEgOiAxKSAqIGF4aXNTaXplLmhlaWdodDsKICB9KTsKICByZXR1cm4gc3RlcHM7Cn0pOwp2YXIgc2VsZWN0QWxsWUF4ZXNPZmZzZXRTdGVwcyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdEFsbFlBeGVzV2l0aE9mZnNldFR5cGUsIHBpY2tBeGlzT3JpZW50YXRpb24sIHBpY2tNaXJyb3IsIChjaGFydFdpZHRoLCBvZmZzZXQsIGFsbEF4ZXNXaXRoU2FtZU9mZnNldFR5cGUsIG9yaWVudGF0aW9uLCBtaXJyb3IpID0+IHsKICB2YXIgc3RlcHMgPSB7fTsKICB2YXIgcG9zaXRpb247CiAgYWxsQXhlc1dpdGhTYW1lT2Zmc2V0VHlwZS5mb3JFYWNoKChheGlzKSA9PiB7CiAgICB2YXIgYXhpc1NpemUgPSBnZXRZQXhpc1NpemUob2Zmc2V0LCBheGlzKTsKICAgIGlmIChwb3NpdGlvbiA9PSBudWxsKSB7CiAgICAgIHBvc2l0aW9uID0gY29tYmluZVlBeGlzUG9zaXRpb25TdGFydGluZ1BvaW50KG9mZnNldCwgb3JpZW50YXRpb24sIGNoYXJ0V2lkdGgpOwogICAgfQogICAgdmFyIG5lZWRTcGFjZSA9IG9yaWVudGF0aW9uID09PSAibGVmdCIgJiYgIW1pcnJvciB8fCBvcmllbnRhdGlvbiA9PT0gInJpZ2h0IiAmJiBtaXJyb3I7CiAgICBzdGVwc1theGlzLmlkXSA9IHBvc2l0aW9uIC0gTnVtYmVyKG5lZWRTcGFjZSkgKiBheGlzU2l6ZS53aWR0aDsKICAgIHBvc2l0aW9uICs9IChuZWVkU3BhY2UgPyAtMSA6IDEpICogYXhpc1NpemUud2lkdGg7CiAgfSk7CiAgcmV0dXJuIHN0ZXBzOwp9KTsKdmFyIHNlbGVjdFhBeGlzT2Zmc2V0U3RlcHMgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciBheGlzU2V0dGluZ3MgPSBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogIGlmIChheGlzU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIHNlbGVjdEFsbFhBeGVzT2Zmc2V0U3RlcHMoc3RhdGUsIGF4aXNTZXR0aW5ncy5vcmllbnRhdGlvbiwgYXhpc1NldHRpbmdzLm1pcnJvcik7Cn07CnZhciBzZWxlY3RYQXhpc1Bvc2l0aW9uID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFhBeGlzU2V0dGluZ3MsIHNlbGVjdFhBeGlzT2Zmc2V0U3RlcHMsIChfLCBheGlzSWQpID0+IGF4aXNJZF0sIChvZmZzZXQsIGF4aXNTZXR0aW5ncywgYWxsU3RlcHMsIGF4aXNJZCkgPT4gewogIGlmIChheGlzU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHN0ZXBPZlRoaXNBeGlzID0gYWxsU3RlcHMgPT09IG51bGwgfHwgYWxsU3RlcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFsbFN0ZXBzW2F4aXNJZF07CiAgaWYgKHN0ZXBPZlRoaXNBeGlzID09IG51bGwpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IG9mZnNldC5sZWZ0LAogICAgICB5OiAwCiAgICB9OwogIH0KICByZXR1cm4gewogICAgeDogb2Zmc2V0LmxlZnQsCiAgICB5OiBzdGVwT2ZUaGlzQXhpcwogIH07Cn0pOwp2YXIgc2VsZWN0WUF4aXNPZmZzZXRTdGVwcyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIGF4aXNTZXR0aW5ncyA9IHNlbGVjdFlBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgaWYgKGF4aXNTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gc2VsZWN0QWxsWUF4ZXNPZmZzZXRTdGVwcyhzdGF0ZSwgYXhpc1NldHRpbmdzLm9yaWVudGF0aW9uLCBheGlzU2V0dGluZ3MubWlycm9yKTsKfTsKdmFyIHNlbGVjdFlBeGlzUG9zaXRpb24gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0WUF4aXNTZXR0aW5ncywgc2VsZWN0WUF4aXNPZmZzZXRTdGVwcywgKF8sIGF4aXNJZCkgPT4gYXhpc0lkXSwgKG9mZnNldCwgYXhpc1NldHRpbmdzLCBhbGxTdGVwcywgYXhpc0lkKSA9PiB7CiAgaWYgKGF4aXNTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgc3RlcE9mVGhpc0F4aXMgPSBhbGxTdGVwcyA9PT0gbnVsbCB8fCBhbGxTdGVwcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWxsU3RlcHNbYXhpc0lkXTsKICBpZiAoc3RlcE9mVGhpc0F4aXMgPT0gbnVsbCkgewogICAgcmV0dXJuIHsKICAgICAgeDogMCwKICAgICAgeTogb2Zmc2V0LnRvcAogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIHg6IHN0ZXBPZlRoaXNBeGlzLAogICAgeTogb2Zmc2V0LnRvcAogIH07Cn0pOwp2YXIgc2VsZWN0WUF4aXNTaXplID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0WUF4aXNTZXR0aW5ncywgKG9mZnNldCwgYXhpc1NldHRpbmdzKSA9PiB7CiAgdmFyIHdpZHRoID0gdHlwZW9mIGF4aXNTZXR0aW5ncy53aWR0aCA9PT0gIm51bWJlciIgPyBheGlzU2V0dGluZ3Mud2lkdGggOiBERUZBVUxUX1lfQVhJU19XSURUSDsKICByZXR1cm4gewogICAgd2lkdGgsCiAgICBoZWlnaHQ6IG9mZnNldC5oZWlnaHQKICB9Owp9KTsKdmFyIGNvbWJpbmVEdXBsaWNhdGVEb21haW4gPSAoY2hhcnRMYXlvdXQsIGFwcGxpZWRWYWx1ZXMsIGF4aXMsIGF4aXNUeXBlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIGFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogICAgdHlwZSwKICAgIGRhdGFLZXkKICB9ID0gYXhpczsKICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGNoYXJ0TGF5b3V0LCBheGlzVHlwZSk7CiAgdmFyIGFsbERhdGEgPSBhcHBsaWVkVmFsdWVzLm1hcCgoYXYpID0+IGF2LnZhbHVlKTsKICBpZiAoZGF0YUtleSAmJiBpc0NhdGVnb3JpY2FsICYmIHR5cGUgPT09ICJjYXRlZ29yeSIgJiYgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnkgJiYgaGFzRHVwbGljYXRlKGFsbERhdGEpKSB7CiAgICByZXR1cm4gYWxsRGF0YTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIHNlbGVjdER1cGxpY2F0ZURvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsQXBwbGllZFZhbHVlcywgc2VsZWN0QmFzZUF4aXMsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVEdXBsaWNhdGVEb21haW4pOwp2YXIgY29tYmluZUNhdGVnb3JpY2FsRG9tYWluID0gKGxheW91dCwgYXBwbGllZFZhbHVlcywgYXhpcywgYXhpc1R5cGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsIHx8IGF4aXMuZGF0YUtleSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgdHlwZSwKICAgIHNjYWxlCiAgfSA9IGF4aXM7CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICBpZiAoaXNDYXRlZ29yaWNhbCAmJiAodHlwZSA9PT0gIm51bWJlciIgfHwgc2NhbGUgIT09ICJhdXRvIikpIHsKICAgIHJldHVybiBhcHBsaWVkVmFsdWVzLm1hcCgoZCkgPT4gZC52YWx1ZSk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciBzZWxlY3RDYXRlZ29yaWNhbERvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsQXBwbGllZFZhbHVlcywgc2VsZWN0QXhpc1NldHRpbmdzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQ2F0ZWdvcmljYWxEb21haW4pOwp2YXIgc2VsZWN0QXhpc1Byb3BzTmVlZGVkRm9yQ2FydGVzaWFuR3JpZFRpY2tzR2VuZXJhdG9yID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RDYXJ0ZXNpYW5BeGlzU2V0dGluZ3MsIHNlbGVjdFJlYWxTY2FsZVR5cGUsIHNlbGVjdEF4aXNTY2FsZSwgc2VsZWN0RHVwbGljYXRlRG9tYWluLCBzZWxlY3RDYXRlZ29yaWNhbERvbWFpbiwgc2VsZWN0QXhpc1JhbmdlLCBzZWxlY3ROaWNlVGlja3MsIHBpY2tBeGlzVHlwZV0sIChsYXlvdXQsIGF4aXMsIHJlYWxTY2FsZVR5cGUsIHNjYWxlLCBkdXBsaWNhdGVEb21haW4sIGNhdGVnb3JpY2FsRG9tYWluLCBheGlzUmFuZ2UsIG5pY2VUaWNrcywgYXhpc1R5cGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGxheW91dCwgYXhpc1R5cGUpOwogIHJldHVybiB7CiAgICBhbmdsZTogYXhpcy5hbmdsZSwKICAgIGludGVydmFsOiBheGlzLmludGVydmFsLAogICAgbWluVGlja0dhcDogYXhpcy5taW5UaWNrR2FwLAogICAgb3JpZW50YXRpb246IGF4aXMub3JpZW50YXRpb24sCiAgICB0aWNrOiBheGlzLnRpY2ssCiAgICB0aWNrQ291bnQ6IGF4aXMudGlja0NvdW50LAogICAgdGlja0Zvcm1hdHRlcjogYXhpcy50aWNrRm9ybWF0dGVyLAogICAgdGlja3M6IGF4aXMudGlja3MsCiAgICB0eXBlOiBheGlzLnR5cGUsCiAgICB1bml0OiBheGlzLnVuaXQsCiAgICBheGlzVHlwZSwKICAgIGNhdGVnb3JpY2FsRG9tYWluLAogICAgZHVwbGljYXRlRG9tYWluLAogICAgaXNDYXRlZ29yaWNhbCwKICAgIG5pY2VUaWNrcywKICAgIHJhbmdlOiBheGlzUmFuZ2UsCiAgICByZWFsU2NhbGVUeXBlLAogICAgc2NhbGUKICB9Owp9KTsKdmFyIGNvbWJpbmVBeGlzVGlja3MgPSAobGF5b3V0LCBheGlzLCByZWFsU2NhbGVUeXBlLCBzY2FsZSwgbmljZVRpY2tzLCBheGlzUmFuZ2UsIGR1cGxpY2F0ZURvbWFpbiwgY2F0ZWdvcmljYWxEb21haW4sIGF4aXNUeXBlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCB8fCBzY2FsZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGxheW91dCwgYXhpc1R5cGUpOwogIHZhciB7CiAgICB0eXBlLAogICAgdGlja3M6IHRpY2tzMiwKICAgIHRpY2tDb3VudAogIH0gPSBheGlzOwogIHZhciBvZmZzZXRGb3JCYW5kID0gcmVhbFNjYWxlVHlwZSA9PT0gInNjYWxlQmFuZCIgJiYgdHlwZW9mIHNjYWxlLmJhbmR3aWR0aCA9PT0gImZ1bmN0aW9uIiA/IHNjYWxlLmJhbmR3aWR0aCgpIC8gMiA6IDI7CiAgdmFyIG9mZnNldCA9IHR5cGUgPT09ICJjYXRlZ29yeSIgJiYgc2NhbGUuYmFuZHdpZHRoID8gc2NhbGUuYmFuZHdpZHRoKCkgLyBvZmZzZXRGb3JCYW5kIDogMDsKICBvZmZzZXQgPSBheGlzVHlwZSA9PT0gImFuZ2xlQXhpcyIgJiYgYXhpc1JhbmdlICE9IG51bGwgJiYgYXhpc1JhbmdlLmxlbmd0aCA+PSAyID8gbWF0aFNpZ24oYXhpc1JhbmdlWzBdIC0gYXhpc1JhbmdlWzFdKSAqIDIgKiBvZmZzZXQgOiBvZmZzZXQ7CiAgdmFyIHRpY2tzT3JOaWNlVGlja3MgPSB0aWNrczIgfHwgbmljZVRpY2tzOwogIGlmICh0aWNrc09yTmljZVRpY2tzKSB7CiAgICB2YXIgcmVzdWx0ID0gdGlja3NPck5pY2VUaWNrcy5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgICB2YXIgc2NhbGVDb250ZW50ID0gZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluLmluZGV4T2YoZW50cnkpIDogZW50cnk7CiAgICAgIHJldHVybiB7CiAgICAgICAgaW5kZXgsCiAgICAgICAgLy8gSWYgdGhlIHNjYWxlQ29udGVudCBpcyBub3QgYSBudW1iZXIsIHRoZSBjb29yZGluYXRlIHdpbGwgYmUgTmFOLgogICAgICAgIC8vIFRoYXQgY291bGQgYmUgdGhlIGNhc2UgZm9yIGV4YW1wbGUgd2l0aCBhIFBvaW50U2NhbGUgYW5kIGEgc3RyaW5nIGFzIGRvbWFpbi4KICAgICAgICBjb29yZGluYXRlOiBzY2FsZShzY2FsZUNvbnRlbnQpICsgb2Zmc2V0LAogICAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgICBvZmZzZXQKICAgICAgfTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdC5maWx0ZXIoKHJvdykgPT4gaXNXZWxsQmVoYXZlZE51bWJlcihyb3cuY29vcmRpbmF0ZSkpOwogIH0KICBpZiAoaXNDYXRlZ29yaWNhbCAmJiBjYXRlZ29yaWNhbERvbWFpbikgewogICAgcmV0dXJuIGNhdGVnb3JpY2FsRG9tYWluLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgaW5kZXgsCiAgICAgIG9mZnNldAogICAgfSkpLmZpbHRlcigocm93KSA9PiBpc1dlbGxCZWhhdmVkTnVtYmVyKHJvdy5jb29yZGluYXRlKSk7CiAgfQogIGlmIChzY2FsZS50aWNrcykgewogICAgcmV0dXJuIHNjYWxlLnRpY2tzKHRpY2tDb3VudCkubWFwKChlbnRyeSkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIG9mZnNldAogICAgfSkpOwogIH0KICByZXR1cm4gc2NhbGUuZG9tYWluKCkubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICB2YWx1ZTogZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluW2VudHJ5XSA6IGVudHJ5LAogICAgaW5kZXgsCiAgICBvZmZzZXQKICB9KSk7Cn07CnZhciBzZWxlY3RUaWNrc09mQXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QXhpc1NldHRpbmdzLCBzZWxlY3RSZWFsU2NhbGVUeXBlLCBzZWxlY3RBeGlzU2NhbGUsIHNlbGVjdE5pY2VUaWNrcywgc2VsZWN0QXhpc1JhbmdlLCBzZWxlY3REdXBsaWNhdGVEb21haW4sIHNlbGVjdENhdGVnb3JpY2FsRG9tYWluLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lQXhpc1RpY2tzKTsKdmFyIGNvbWJpbmVHcmFwaGljYWxJdGVtVGlja3MgPSAobGF5b3V0LCBheGlzLCBzY2FsZSwgYXhpc1JhbmdlLCBkdXBsaWNhdGVEb21haW4sIGNhdGVnb3JpY2FsRG9tYWluLCBheGlzVHlwZSkgPT4gewogIGlmIChheGlzID09IG51bGwgfHwgc2NhbGUgPT0gbnVsbCB8fCBheGlzUmFuZ2UgPT0gbnVsbCB8fCBheGlzUmFuZ2VbMF0gPT09IGF4aXNSYW5nZVsxXSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICB2YXIgewogICAgdGlja0NvdW50CiAgfSA9IGF4aXM7CiAgdmFyIG9mZnNldCA9IDA7CiAgb2Zmc2V0ID0gYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiICYmIChheGlzUmFuZ2UgPT09IG51bGwgfHwgYXhpc1JhbmdlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBheGlzUmFuZ2UubGVuZ3RoKSA+PSAyID8gbWF0aFNpZ24oYXhpc1JhbmdlWzBdIC0gYXhpc1JhbmdlWzFdKSAqIDIgKiBvZmZzZXQgOiBvZmZzZXQ7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgY2F0ZWdvcmljYWxEb21haW4pIHsKICAgIHJldHVybiBjYXRlZ29yaWNhbERvbWFpbi5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIGluZGV4LAogICAgICBvZmZzZXQKICAgIH0pKTsKICB9CiAgaWYgKHNjYWxlLnRpY2tzKSB7CiAgICByZXR1cm4gc2NhbGUudGlja3ModGlja0NvdW50KS5tYXAoKGVudHJ5KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgb2Zmc2V0CiAgICB9KSk7CiAgfQogIHJldHVybiBzY2FsZS5kb21haW4oKS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgIHZhbHVlOiBkdXBsaWNhdGVEb21haW4gPyBkdXBsaWNhdGVEb21haW5bZW50cnldIDogZW50cnksCiAgICBpbmRleCwKICAgIG9mZnNldAogIH0pKTsKfTsKdmFyIHNlbGVjdFRpY2tzT2ZHcmFwaGljYWxJdGVtID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RBeGlzU2V0dGluZ3MsIHNlbGVjdEF4aXNTY2FsZSwgc2VsZWN0QXhpc1JhbmdlLCBzZWxlY3REdXBsaWNhdGVEb21haW4sIHNlbGVjdENhdGVnb3JpY2FsRG9tYWluLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lR3JhcGhpY2FsSXRlbVRpY2tzKTsKdmFyIHNlbGVjdEF4aXNXaXRoU2NhbGUgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RCYXNlQXhpcywgc2VsZWN0QXhpc1NjYWxlLCAoYXhpcywgc2NhbGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsIHx8IHNjYWxlID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBfb2JqZWN0U3ByZWFkMTMoX29iamVjdFNwcmVhZDEzKHt9LCBheGlzKSwge30sIHsKICAgIHNjYWxlCiAgfSk7Cn0pOwp2YXIgc2VsZWN0WkF4aXNTY2FsZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0UmVhbFNjYWxlVHlwZSwgc2VsZWN0QXhpc0RvbWFpbiwgc2VsZWN0QXhpc1JhbmdlV2l0aFJldmVyc2VdLCBjb21iaW5lU2NhbGVGdW5jdGlvbik7CnZhciBzZWxlY3RaQXhpc1dpdGhTY2FsZSA9IGNyZWF0ZVNlbGVjdG9yKChzdGF0ZSwgX2F4aXNUeXBlLCBheGlzSWQpID0+IHNlbGVjdFpBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCksIHNlbGVjdFpBeGlzU2NhbGUsIChheGlzLCBzY2FsZSkgPT4gewogIGlmIChheGlzID09IG51bGwgfHwgc2NhbGUgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQxMyhfb2JqZWN0U3ByZWFkMTMoe30sIGF4aXMpLCB7fSwgewogICAgc2NhbGUKICB9KTsKfSk7CnZhciBzZWxlY3RDaGFydERpcmVjdGlvbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsWEF4ZXMsIHNlbGVjdEFsbFlBeGVzXSwgKGxheW91dCwgYWxsWEF4ZXMsIGFsbFlBeGVzKSA9PiB7CiAgc3dpdGNoIChsYXlvdXQpIHsKICAgIGNhc2UgImhvcml6b250YWwiOiB7CiAgICAgIHJldHVybiBhbGxYQXhlcy5zb21lKChheGlzKSA9PiBheGlzLnJldmVyc2VkKSA/ICJyaWdodC10by1sZWZ0IiA6ICJsZWZ0LXRvLXJpZ2h0IjsKICAgIH0KICAgIGNhc2UgInZlcnRpY2FsIjogewogICAgICByZXR1cm4gYWxsWUF4ZXMuc29tZSgoYXhpcykgPT4gYXhpcy5yZXZlcnNlZCkgPyAiYm90dG9tLXRvLXRvcCIgOiAidG9wLXRvLWJvdHRvbSI7CiAgICB9CiAgICBjYXNlICJjZW50cmljIjoKICAgIGNhc2UgInJhZGlhbCI6IHsKICAgICAgcmV0dXJuICJsZWZ0LXRvLXJpZ2h0IjsKICAgIH0KICAgIGRlZmF1bHQ6IHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0VG9vbHRpcEV2ZW50VHlwZS5qcwp2YXIgc2VsZWN0RGVmYXVsdFRvb2x0aXBFdmVudFR5cGUgPSAoc3RhdGUpID0+IHN0YXRlLm9wdGlvbnMuZGVmYXVsdFRvb2x0aXBFdmVudFR5cGU7CnZhciBzZWxlY3RWYWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzID0gKHN0YXRlKSA9PiBzdGF0ZS5vcHRpb25zLnZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXM7CmZ1bmN0aW9uIGNvbWJpbmVUb29sdGlwRXZlbnRUeXBlKHNoYXJlZCwgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMpIHsKICBpZiAoc2hhcmVkID09IG51bGwpIHsKICAgIHJldHVybiBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZTsKICB9CiAgdmFyIGV2ZW50VHlwZSA9IHNoYXJlZCA/ICJheGlzIiA6ICJpdGVtIjsKICBpZiAodmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcyA9PSBudWxsKSB7CiAgICByZXR1cm4gZGVmYXVsdFRvb2x0aXBFdmVudFR5cGU7CiAgfQogIHJldHVybiB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzLmluY2x1ZGVzKGV2ZW50VHlwZSkgPyBldmVudFR5cGUgOiBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZTsKfQpmdW5jdGlvbiBzZWxlY3RUb29sdGlwRXZlbnRUeXBlKHN0YXRlLCBzaGFyZWQpIHsKICB2YXIgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUgPSBzZWxlY3REZWZhdWx0VG9vbHRpcEV2ZW50VHlwZShzdGF0ZSk7CiAgdmFyIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMgPSBzZWxlY3RWYWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzKHN0YXRlKTsKICByZXR1cm4gY29tYmluZVRvb2x0aXBFdmVudFR5cGUoc2hhcmVkLCBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSwgdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcyk7Cn0KZnVuY3Rpb24gdXNlVG9vbHRpcEV2ZW50VHlwZShzaGFyZWQpIHsKICByZXR1cm4gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RUb29sdGlwRXZlbnRUeXBlKHN0YXRlLCBzaGFyZWQpKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29tYmluZXJzL2NvbWJpbmVBY3RpdmVMYWJlbC5qcwp2YXIgY29tYmluZUFjdGl2ZUxhYmVsID0gKHRvb2x0aXBUaWNrcywgYWN0aXZlSW5kZXgpID0+IHsKICB2YXIgX3Rvb2x0aXBUaWNrcyRuOwogIHZhciBuID0gTnVtYmVyKGFjdGl2ZUluZGV4KTsKICBpZiAoaXNOYW4obikgfHwgYWN0aXZlSW5kZXggPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIG4gPj0gMCA/IHRvb2x0aXBUaWNrcyA9PT0gbnVsbCB8fCB0b29sdGlwVGlja3MgPT09IHZvaWQgMCB8fCAoX3Rvb2x0aXBUaWNrcyRuID0gdG9vbHRpcFRpY2tzW25dKSA9PT0gbnVsbCB8fCBfdG9vbHRpcFRpY2tzJG4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90b29sdGlwVGlja3Mkbi52YWx1ZSA6IHZvaWQgMDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBTZXR0aW5ncy5qcwp2YXIgc2VsZWN0VG9vbHRpcFNldHRpbmdzID0gKHN0YXRlKSA9PiBzdGF0ZS50b29sdGlwLnNldHRpbmdzOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS90b29sdGlwU2xpY2UuanMKdmFyIG5vSW50ZXJhY3Rpb24gPSB7CiAgYWN0aXZlOiBmYWxzZSwKICBpbmRleDogbnVsbCwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZ3JhcGhpY2FsSXRlbUlkOiB2b2lkIDAsCiAgY29vcmRpbmF0ZTogdm9pZCAwCn07CnZhciBpbml0aWFsU3RhdGUzID0gewogIGl0ZW1JbnRlcmFjdGlvbjogewogICAgY2xpY2s6IG5vSW50ZXJhY3Rpb24sCiAgICBob3Zlcjogbm9JbnRlcmFjdGlvbgogIH0sCiAgYXhpc0ludGVyYWN0aW9uOiB7CiAgICBjbGljazogbm9JbnRlcmFjdGlvbiwKICAgIGhvdmVyOiBub0ludGVyYWN0aW9uCiAgfSwKICBrZXlib2FyZEludGVyYWN0aW9uOiBub0ludGVyYWN0aW9uLAogIHN5bmNJbnRlcmFjdGlvbjogewogICAgYWN0aXZlOiBmYWxzZSwKICAgIGluZGV4OiBudWxsLAogICAgZGF0YUtleTogdm9pZCAwLAogICAgbGFiZWw6IHZvaWQgMCwKICAgIGNvb3JkaW5hdGU6IHZvaWQgMCwKICAgIHNvdXJjZVZpZXdCb3g6IHZvaWQgMCwKICAgIGdyYXBoaWNhbEl0ZW1JZDogdm9pZCAwCiAgfSwKICB0b29sdGlwSXRlbVBheWxvYWRzOiBbXSwKICBzZXR0aW5nczogewogICAgc2hhcmVkOiB2b2lkIDAsCiAgICB0cmlnZ2VyOiAiaG92ZXIiLAogICAgYXhpc0lkOiAwLAogICAgYWN0aXZlOiBmYWxzZSwKICAgIGRlZmF1bHRJbmRleDogdm9pZCAwCiAgfQp9Owp2YXIgdG9vbHRpcFNsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJ0b29sdGlwIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTMsCiAgcmVkdWNlcnM6IHsKICAgIGFkZFRvb2x0aXBFbnRyeVNldHRpbmdzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHMucHVzaChjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZXBsYWNlVG9vbHRpcEVudHJ5U2V0dGluZ3M6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHByZXYsCiAgICAgICAgICBuZXh0CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLnRvb2x0aXBJdGVtUGF5bG9hZHMuaW5kZXhPZihjYXN0RHJhZnQocHJldikpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzW2luZGV4XSA9IGNhc3REcmFmdChuZXh0KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlVG9vbHRpcEVudHJ5U2V0dGluZ3M6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkudG9vbHRpcEl0ZW1QYXlsb2Fkcy5pbmRleE9mKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHNldFRvb2x0aXBTZXR0aW5nc1N0YXRlKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc2V0dGluZ3MgPSBhY3Rpb24ucGF5bG9hZDsKICAgIH0sCiAgICBzZXRBY3RpdmVNb3VzZU92ZXJJdGVtSW5kZXgoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zeW5jSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5hY3RpdmUgPSB0cnVlOwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuaW5kZXggPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVJbmRleDsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmRhdGFLZXkgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVEYXRhS2V5OwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuZ3JhcGhpY2FsSXRlbUlkID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlR3JhcGhpY2FsSXRlbUlkOwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuY29vcmRpbmF0ZSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUNvb3JkaW5hdGU7CiAgICB9LAogICAgbW91c2VMZWF2ZUNoYXJ0KHN0YXRlKSB7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgfSwKICAgIG1vdXNlTGVhdmVJdGVtKHN0YXRlKSB7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5hY3RpdmUgPSBmYWxzZTsKICAgIH0sCiAgICBzZXRBY3RpdmVDbGlja0l0ZW1JbmRleChzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnN5bmNJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmFjdGl2ZSA9IHRydWU7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5pbmRleCA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUluZGV4OwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suZGF0YUtleSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZURhdGFLZXk7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5ncmFwaGljYWxJdGVtSWQgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVHcmFwaGljYWxJdGVtSWQ7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5jb29yZGluYXRlID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlQ29vcmRpbmF0ZTsKICAgIH0sCiAgICBzZXRNb3VzZU92ZXJBeGlzSW5kZXgoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zeW5jSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3Zlci5hY3RpdmUgPSB0cnVlOwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uaG92ZXIuaW5kZXggPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVJbmRleDsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyLmRhdGFLZXkgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVEYXRhS2V5OwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uaG92ZXIuY29vcmRpbmF0ZSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUNvb3JkaW5hdGU7CiAgICB9LAogICAgc2V0TW91c2VDbGlja0F4aXNJbmRleChzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnN5bmNJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmNsaWNrLmFjdGl2ZSA9IHRydWU7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5jbGljay5pbmRleCA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUluZGV4OwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uY2xpY2suZGF0YUtleSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZURhdGFLZXk7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5jbGljay5jb29yZGluYXRlID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlQ29vcmRpbmF0ZTsKICAgIH0sCiAgICBzZXRTeW5jSW50ZXJhY3Rpb24oc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zeW5jSW50ZXJhY3Rpb24gPSBhY3Rpb24ucGF5bG9hZDsKICAgIH0sCiAgICBzZXRLZXlib2FyZEludGVyYWN0aW9uKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmU7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uaW5kZXggPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVJbmRleDsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5jb29yZGluYXRlID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlQ29vcmRpbmF0ZTsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5kYXRhS2V5ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlRGF0YUtleTsKICAgIH0KICB9Cn0pOwp2YXIgewogIGFkZFRvb2x0aXBFbnRyeVNldHRpbmdzLAogIHJlcGxhY2VUb29sdGlwRW50cnlTZXR0aW5ncywKICByZW1vdmVUb29sdGlwRW50cnlTZXR0aW5ncywKICBzZXRUb29sdGlwU2V0dGluZ3NTdGF0ZSwKICBzZXRBY3RpdmVNb3VzZU92ZXJJdGVtSW5kZXgsCiAgbW91c2VMZWF2ZUl0ZW0sCiAgbW91c2VMZWF2ZUNoYXJ0LAogIHNldEFjdGl2ZUNsaWNrSXRlbUluZGV4LAogIHNldE1vdXNlT3ZlckF4aXNJbmRleCwKICBzZXRNb3VzZUNsaWNrQXhpc0luZGV4LAogIHNldFN5bmNJbnRlcmFjdGlvbiwKICBzZXRLZXlib2FyZEludGVyYWN0aW9uCn0gPSB0b29sdGlwU2xpY2UuYWN0aW9uczsKdmFyIHRvb2x0aXBSZWR1Y2VyID0gdG9vbHRpcFNsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZVRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmpzCmZ1bmN0aW9uIG93bktleXMxNChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDE0KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTQoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTE0KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czE0KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxNChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTE0KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTE0KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTE0KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTE0KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBjaG9vc2VBcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24odG9vbHRpcFN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyKSB7CiAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgaWYgKHRyaWdnZXIgPT09ICJjbGljayIpIHsKICAgICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5heGlzSW50ZXJhY3Rpb24uY2xpY2s7CiAgICB9CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3ZlcjsKICB9CiAgaWYgKHRyaWdnZXIgPT09ICJjbGljayIpIHsKICAgIHJldHVybiB0b29sdGlwU3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrOwogIH0KICByZXR1cm4gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3ZlcjsKfQpmdW5jdGlvbiBoYXNCZWVuQWN0aXZlUHJldmlvdXNseSh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSkgewogIHJldHVybiB0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZS5pbmRleCAhPSBudWxsOwp9CnZhciBjb21iaW5lVG9vbHRpcEludGVyYWN0aW9uU3RhdGUgPSAodG9vbHRpcFN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBkZWZhdWx0SW5kZXgpID0+IHsKICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PSBudWxsKSB7CiAgICByZXR1cm4gbm9JbnRlcmFjdGlvbjsKICB9CiAgdmFyIGFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbiA9IGNob29zZUFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbih0b29sdGlwU3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIpOwogIGlmIChhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24gPT0gbnVsbCkgewogICAgcmV0dXJuIG5vSW50ZXJhY3Rpb247CiAgfQogIGlmIChhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24uYWN0aXZlKSB7CiAgICByZXR1cm4gYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uOwogIH0KICBpZiAodG9vbHRpcFN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlKSB7CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb247CiAgfQogIGlmICh0b29sdGlwU3RhdGUuc3luY0ludGVyYWN0aW9uLmFjdGl2ZSAmJiB0b29sdGlwU3RhdGUuc3luY0ludGVyYWN0aW9uLmluZGV4ICE9IG51bGwpIHsKICAgIHJldHVybiB0b29sdGlwU3RhdGUuc3luY0ludGVyYWN0aW9uOwogIH0KICB2YXIgYWN0aXZlRnJvbVByb3BzID0gdG9vbHRpcFN0YXRlLnNldHRpbmdzLmFjdGl2ZSA9PT0gdHJ1ZTsKICBpZiAoaGFzQmVlbkFjdGl2ZVByZXZpb3VzbHkoYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uKSkgewogICAgaWYgKGFjdGl2ZUZyb21Qcm9wcykgewogICAgICByZXR1cm4gX29iamVjdFNwcmVhZDE0KF9vYmplY3RTcHJlYWQxNCh7fSwgYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uKSwge30sIHsKICAgICAgICBhY3RpdmU6IHRydWUKICAgICAgfSk7CiAgICB9CiAgfSBlbHNlIGlmIChkZWZhdWx0SW5kZXggIT0gbnVsbCkgewogICAgcmV0dXJuIHsKICAgICAgYWN0aXZlOiB0cnVlLAogICAgICBjb29yZGluYXRlOiB2b2lkIDAsCiAgICAgIGRhdGFLZXk6IHZvaWQgMCwKICAgICAgaW5kZXg6IGRlZmF1bHRJbmRleCwKICAgICAgZ3JhcGhpY2FsSXRlbUlkOiB2b2lkIDAKICAgIH07CiAgfQogIHJldHVybiBfb2JqZWN0U3ByZWFkMTQoX29iamVjdFNwcmVhZDE0KHt9LCBub0ludGVyYWN0aW9uKSwge30sIHsKICAgIGNvb3JkaW5hdGU6IGFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbi5jb29yZGluYXRlCiAgfSk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZUFjdGl2ZVRvb2x0aXBJbmRleC5qcwpmdW5jdGlvbiB0b0Zpbml0ZU51bWJlcih2YWx1ZSkgewogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKHZhbHVlKSA/IHZhbHVlIDogdm9pZCAwOwogIH0KICBpZiAodmFsdWUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICB2YXIgbnVtZXJpY1ZhbHVlID0gdmFsdWUudmFsdWVPZigpOwogICAgcmV0dXJuIE51bWJlci5pc0Zpbml0ZShudW1lcmljVmFsdWUpID8gbnVtZXJpY1ZhbHVlIDogdm9pZCAwOwogIH0KICB2YXIgcGFyc2VkID0gTnVtYmVyKHZhbHVlKTsKICByZXR1cm4gTnVtYmVyLmlzRmluaXRlKHBhcnNlZCkgPyBwYXJzZWQgOiB2b2lkIDA7Cn0KZnVuY3Rpb24gaXNWYWx1ZVdpdGhpbk51bWJlckRvbWFpbih2YWx1ZSwgZG9tYWluKSB7CiAgdmFyIG51bWVyaWNWYWx1ZSA9IHRvRmluaXRlTnVtYmVyKHZhbHVlKTsKICB2YXIgbG93ZXJCb3VuZCA9IGRvbWFpblswXTsKICB2YXIgdXBwZXJCb3VuZCA9IGRvbWFpblsxXTsKICBpZiAobnVtZXJpY1ZhbHVlID09PSB2b2lkIDApIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgdmFyIG1pbjIgPSBNYXRoLm1pbihsb3dlckJvdW5kLCB1cHBlckJvdW5kKTsKICB2YXIgbWF4MiA9IE1hdGgubWF4KGxvd2VyQm91bmQsIHVwcGVyQm91bmQpOwogIHJldHVybiBudW1lcmljVmFsdWUgPj0gbWluMiAmJiBudW1lcmljVmFsdWUgPD0gbWF4MjsKfQpmdW5jdGlvbiBpc1ZhbHVlV2l0aGluRG9tYWluKGVudHJ5LCBheGlzRGF0YUtleSwgZG9tYWluKSB7CiAgaWYgKGRvbWFpbiA9PSBudWxsIHx8IGF4aXNEYXRhS2V5ID09IG51bGwpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICB2YXIgdmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgYXhpc0RhdGFLZXkpOwogIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgaWYgKCFpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oZG9tYWluKSkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIHJldHVybiBpc1ZhbHVlV2l0aGluTnVtYmVyRG9tYWluKHZhbHVlLCBkb21haW4pOwp9CnZhciBjb21iaW5lQWN0aXZlVG9vbHRpcEluZGV4ID0gKHRvb2x0aXBJbnRlcmFjdGlvbiwgY2hhcnREYXRhLCBheGlzRGF0YUtleSwgZG9tYWluKSA9PiB7CiAgdmFyIGRlc2lyZWRJbmRleCA9IHRvb2x0aXBJbnRlcmFjdGlvbiA9PT0gbnVsbCB8fCB0b29sdGlwSW50ZXJhY3Rpb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRvb2x0aXBJbnRlcmFjdGlvbi5pbmRleDsKICBpZiAoZGVzaXJlZEluZGV4ID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgaW5kZXhBc051bWJlciA9IE51bWJlcihkZXNpcmVkSW5kZXgpOwogIGlmICghaXNXZWxsQmVoYXZlZE51bWJlcihpbmRleEFzTnVtYmVyKSkgewogICAgcmV0dXJuIGRlc2lyZWRJbmRleDsKICB9CiAgdmFyIGxvd2VyTGltaXQgPSAwOwogIHZhciB1cHBlckxpbWl0ID0gSW5maW5pdHk7CiAgaWYgKGNoYXJ0RGF0YS5sZW5ndGggPiAwKSB7CiAgICB1cHBlckxpbWl0ID0gY2hhcnREYXRhLmxlbmd0aCAtIDE7CiAgfQogIHZhciBjbGFtcGVkSW5kZXggPSBNYXRoLm1heChsb3dlckxpbWl0LCBNYXRoLm1pbihpbmRleEFzTnVtYmVyLCB1cHBlckxpbWl0KSk7CiAgdmFyIGVudHJ5ID0gY2hhcnREYXRhW2NsYW1wZWRJbmRleF07CiAgaWYgKGVudHJ5ID09IG51bGwpIHsKICAgIHJldHVybiBTdHJpbmcoY2xhbXBlZEluZGV4KTsKICB9CiAgaWYgKCFpc1ZhbHVlV2l0aGluRG9tYWluKGVudHJ5LCBheGlzRGF0YUtleSwgZG9tYWluKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiBTdHJpbmcoY2xhbXBlZEluZGV4KTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbWJpbmVycy9jb21iaW5lQ29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleC5qcwp2YXIgY29tYmluZUNvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXggPSAod2lkdGgsIGhlaWdodCwgbGF5b3V0LCBvZmZzZXQsIHRvb2x0aXBUaWNrcywgZGVmYXVsdEluZGV4LCB0b29sdGlwQ29uZmlndXJhdGlvbnMsIHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIpID0+IHsKICBpZiAoZGVmYXVsdEluZGV4ID09IG51bGwgfHwgdG9vbHRpcFBheWxvYWRTZWFyY2hlciA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgZmlyc3RDb25maWd1cmF0aW9uID0gdG9vbHRpcENvbmZpZ3VyYXRpb25zWzBdOwogIHZhciBtYXliZVBvc2l0aW9uID0gZmlyc3RDb25maWd1cmF0aW9uID09IG51bGwgPyB2b2lkIDAgOiB0b29sdGlwUGF5bG9hZFNlYXJjaGVyKGZpcnN0Q29uZmlndXJhdGlvbi5wb3NpdGlvbnMsIGRlZmF1bHRJbmRleCk7CiAgaWYgKG1heWJlUG9zaXRpb24gIT0gbnVsbCkgewogICAgcmV0dXJuIG1heWJlUG9zaXRpb247CiAgfQogIHZhciB0aWNrID0gdG9vbHRpcFRpY2tzID09PSBudWxsIHx8IHRvb2x0aXBUaWNrcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogdG9vbHRpcFRpY2tzW051bWJlcihkZWZhdWx0SW5kZXgpXTsKICBpZiAoIXRpY2spIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHN3aXRjaCAobGF5b3V0KSB7CiAgICBjYXNlICJob3Jpem9udGFsIjogewogICAgICByZXR1cm4gewogICAgICAgIHg6IHRpY2suY29vcmRpbmF0ZSwKICAgICAgICB5OiAob2Zmc2V0LnRvcCArIGhlaWdodCkgLyAyCiAgICAgIH07CiAgICB9CiAgICBkZWZhdWx0OiB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogKG9mZnNldC5sZWZ0ICsgd2lkdGgpIC8gMiwKICAgICAgICB5OiB0aWNrLmNvb3JkaW5hdGUKICAgICAgfTsKICAgIH0KICB9Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZVRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMuanMKdmFyIGNvbWJpbmVUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zID0gKHRvb2x0aXBTdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4KSA9PiB7CiAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzOwogIH0KICBpZiAodG9vbHRpcFN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gW107CiAgfQogIHZhciBmaWx0ZXJCeURhdGFLZXk7CiAgaWYgKHRyaWdnZXIgPT09ICJob3ZlciIpIHsKICAgIGZpbHRlckJ5RGF0YUtleSA9IHRvb2x0aXBTdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuZGF0YUtleTsKICB9IGVsc2UgewogICAgZmlsdGVyQnlEYXRhS2V5ID0gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5kYXRhS2V5OwogIH0KICBpZiAoZmlsdGVyQnlEYXRhS2V5ID09IG51bGwgJiYgZGVmYXVsdEluZGV4ICE9IG51bGwpIHsKICAgIHJldHVybiBbdG9vbHRpcFN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHNbMF1dOwogIH0KICByZXR1cm4gdG9vbHRpcFN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHMuZmlsdGVyKCh0cGMpID0+IHsKICAgIHZhciBfdHBjJHNldHRpbmdzOwogICAgcmV0dXJuICgoX3RwYyRzZXR0aW5ncyA9IHRwYy5zZXR0aW5ncykgPT09IG51bGwgfHwgX3RwYyRzZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RwYyRzZXR0aW5ncy5kYXRhS2V5KSA9PT0gZmlsdGVyQnlEYXRhS2V5OwogIH0pOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlci5qcwp2YXIgc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlciA9IChzdGF0ZSkgPT4gc3RhdGUub3B0aW9ucy50b29sdGlwUGF5bG9hZFNlYXJjaGVyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0VG9vbHRpcFN0YXRlLmpzCnZhciBzZWxlY3RUb29sdGlwU3RhdGUgPSAoc3RhdGUpID0+IHN0YXRlLnRvb2x0aXA7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZVRvb2x0aXBQYXlsb2FkLmpzCmZ1bmN0aW9uIG93bktleXMxNShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDE1KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTUoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTE1KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czE1KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxNShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTE1KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTE1KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTE1KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTE1KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBzZWxlY3RGaW5hbERhdGEoZGF0YURlZmluZWRPbkl0ZW0sIGRhdGFEZWZpbmVkT25DaGFydCkgewogIGlmIChkYXRhRGVmaW5lZE9uSXRlbSAhPSBudWxsKSB7CiAgICByZXR1cm4gZGF0YURlZmluZWRPbkl0ZW07CiAgfQogIHJldHVybiBkYXRhRGVmaW5lZE9uQ2hhcnQ7Cn0KdmFyIGNvbWJpbmVUb29sdGlwUGF5bG9hZCA9ICh0b29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zLCBhY3RpdmVJbmRleCwgY2hhcnREYXRhU3RhdGUsIHRvb2x0aXBBeGlzRGF0YUtleSwgYWN0aXZlTGFiZWwsIHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsIHRvb2x0aXBFdmVudFR5cGUpID0+IHsKICBpZiAoYWN0aXZlSW5kZXggPT0gbnVsbCB8fCB0b29sdGlwUGF5bG9hZFNlYXJjaGVyID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBjaGFydERhdGEsCiAgICBjb21wdXRlZERhdGEsCiAgICBkYXRhU3RhcnRJbmRleCwKICAgIGRhdGFFbmRJbmRleAogIH0gPSBjaGFydERhdGFTdGF0ZTsKICB2YXIgaW5pdCA9IFtdOwogIHJldHVybiB0b29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zLnJlZHVjZSgoYWdnLCBfcmVmMikgPT4gewogICAgdmFyIF9zZXR0aW5ncyRkYXRhS2V5OwogICAgdmFyIHsKICAgICAgZGF0YURlZmluZWRPbkl0ZW0sCiAgICAgIHNldHRpbmdzCiAgICB9ID0gX3JlZjI7CiAgICB2YXIgZmluYWxEYXRhID0gc2VsZWN0RmluYWxEYXRhKGRhdGFEZWZpbmVkT25JdGVtLCBjaGFydERhdGEpOwogICAgdmFyIHNsaWNlZCA9IEFycmF5LmlzQXJyYXkoZmluYWxEYXRhKSA/IGdldFNsaWNlZChmaW5hbERhdGEsIGRhdGFTdGFydEluZGV4LCBkYXRhRW5kSW5kZXgpIDogZmluYWxEYXRhOwogICAgdmFyIGZpbmFsRGF0YUtleSA9IChfc2V0dGluZ3MkZGF0YUtleSA9IHNldHRpbmdzID09PSBudWxsIHx8IHNldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXR0aW5ncy5kYXRhS2V5KSAhPT0gbnVsbCAmJiBfc2V0dGluZ3MkZGF0YUtleSAhPT0gdm9pZCAwID8gX3NldHRpbmdzJGRhdGFLZXkgOiB0b29sdGlwQXhpc0RhdGFLZXk7CiAgICB2YXIgZmluYWxOYW1lS2V5ID0gc2V0dGluZ3MgPT09IG51bGwgfHwgc2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNldHRpbmdzLm5hbWVLZXk7CiAgICB2YXIgdG9vbHRpcFBheWxvYWQ7CiAgICBpZiAodG9vbHRpcEF4aXNEYXRhS2V5ICYmIEFycmF5LmlzQXJyYXkoc2xpY2VkKSAmJiAvKgogICAgICogZmluZEVudHJ5SW5BcnJheSB3b24ndCB3b3JrIGZvciBTY2F0dGVyIGJlY2F1c2UgU2NhdHRlciBwcm92aWRlcyBhbiBhcnJheSBvZiBhcnJheXMKICAgICAqIGFzIHRvb2x0aXAgcGF5bG9hZHMgYW5kIGZpbmRFbnRyeUluQXJyYXkgaXMgbm90IHByZXBhcmVkIHRvIGhhbmRsZSB0aGF0LgogICAgICogU2FkIGJ1dCBhbHNvIFNjYXR0ZXJDaGFydCBvbmx5IGFsbG93cyAnaXRlbScgdG9vbHRpcEV2ZW50VHlwZQogICAgICogYW5kIGFsc28gdGhpcyBpcyBvbmx5IGEgcHJvYmxlbSBpZiB0aGVyZSBhcmUgbXVsdGlwbGUgU2NhdHRlcnMgYW5kIGVhY2ggaGFzIGl0cyBvd24gZGF0YSBhcnJheQogICAgICogc28gbGV0J3MgZml4IHRoYXQgc29tZSBvdGhlciB0aW1lLgogICAgICovCiAgICAhQXJyYXkuaXNBcnJheShzbGljZWRbMF0pICYmIC8qCiAgICAgKiBJZiB0aGUgdG9vbHRpcEV2ZW50VHlwZSBpcyAnYXhpcycsIHdlIHNob3VsZCBzZWFyY2ggZm9yIHRoZSBkYXRhS2V5IGluIHRoZSBzbGljZWQgZGF0YQogICAgICogYmVjYXVzZSB0aGFua3MgdG8gYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk9ZmFsc2UsIHRoZSBvcmRlciBvZiBlbGVtZW50cyBpbiB0aGUgYXJyYXkKICAgICAqIG5vIGxvbmdlciBtYXRjaGVzIHRoZSBvcmRlciBvZiBlbGVtZW50cyBpbiB0aGUgb3JpZ2luYWwgZGF0YQogICAgICogYW5kIHNvIHdlIG5lZWQgdG8gc2VhcmNoIGJ5IHRoZSBhY3RpdmUgZGF0YUtleSArIGxhYmVsIHJhdGhlciB0aGFuIGJ5IGluZGV4LgogICAgICoKICAgICAqIFRoZSBzYW1lIGhhcHBlbnMgaWYgbXVsdGlwbGUgZ3JhcGhpY2FsIGl0ZW1zIGFyZSBwcmVzZW50IGluIHRoZSBjaGFydAogICAgICogYW5kIGVhY2ggb2YgdGhlbSBoYXMgaXRzIG93biBkYXRhIGFycmF5LiBUaG9zZSBhcnJheXMgZ2V0IGNvbmNhdGVuYXRlZAogICAgICogYW5kIGFnYWluIHRoZSB0b29sdGlwIGluZGV4IG5vIGxvbmdlciBtYXRjaGVzIHRoZSBvcmlnaW5hbCBkYXRhLgogICAgICoKICAgICAqIE9uIHRoZSBvdGhlciBoYW5kIHRoZSB0b29sdGlwRXZlbnRUeXBlICdpdGVtJyBzaG91bGQgYWx3YXlzIHNlYXJjaCBieSBpbmRleAogICAgICogYmVjYXVzZSB3ZSBnZXQgdGhlIGluZGV4IGZyb20gaW50ZXJhY3Rpbmcgb3ZlciB0aGUgaW5kaXZpZHVhbCBlbGVtZW50cwogICAgICogd2hpY2ggaXMgYWx3YXlzIGFjY3VyYXRlLCBpcnJlc3BlY3RpdmUgb2YgdGhlIGFsbG93RHVwbGljYXRlZENhdGVnb3J5IHNldHRpbmcuCiAgICAgKi8KICAgIHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgICB0b29sdGlwUGF5bG9hZCA9IGZpbmRFbnRyeUluQXJyYXkoc2xpY2VkLCB0b29sdGlwQXhpc0RhdGFLZXksIGFjdGl2ZUxhYmVsKTsKICAgIH0gZWxzZSB7CiAgICAgIHRvb2x0aXBQYXlsb2FkID0gdG9vbHRpcFBheWxvYWRTZWFyY2hlcihzbGljZWQsIGFjdGl2ZUluZGV4LCBjb21wdXRlZERhdGEsIGZpbmFsTmFtZUtleSk7CiAgICB9CiAgICBpZiAoQXJyYXkuaXNBcnJheSh0b29sdGlwUGF5bG9hZCkpIHsKICAgICAgdG9vbHRpcFBheWxvYWQuZm9yRWFjaCgoaXRlbSkgPT4gewogICAgICAgIHZhciBuZXdTZXR0aW5ncyA9IF9vYmplY3RTcHJlYWQxNShfb2JqZWN0U3ByZWFkMTUoe30sIHNldHRpbmdzKSwge30sIHsKICAgICAgICAgIG5hbWU6IGl0ZW0ubmFtZSwKICAgICAgICAgIHVuaXQ6IGl0ZW0udW5pdCwKICAgICAgICAgIC8vIGNvbG9yIGFuZCBmaWxsIGFyZSBlcmFzZWQgdG8ga2VlcCAxMDAlIHRoZSBpZGVudGljYWwgYmVoYXZpb3VyIHRvIHJlY2hhcnRzIDIueCAtIGJ1dCB0aGVyZSdzIG5vdGhpbmcgc3RvcHBpbmcgdXMgZnJvbSByZXR1cm5pbmcgdGhlbSBoZXJlLiBJdCdzIHRlY2huaWNhbGx5IGEgYnJlYWtpbmcgY2hhbmdlLgogICAgICAgICAgY29sb3I6IHZvaWQgMCwKICAgICAgICAgIC8vIGNvbG9yIGFuZCBmaWxsIGFyZSBlcmFzZWQgdG8ga2VlcCAxMDAlIHRoZSBpZGVudGljYWwgYmVoYXZpb3VyIHRvIHJlY2hhcnRzIDIueCAtIGJ1dCB0aGVyZSdzIG5vdGhpbmcgc3RvcHBpbmcgdXMgZnJvbSByZXR1cm5pbmcgdGhlbSBoZXJlLiBJdCdzIHRlY2huaWNhbGx5IGEgYnJlYWtpbmcgY2hhbmdlLgogICAgICAgICAgZmlsbDogdm9pZCAwCiAgICAgICAgfSk7CiAgICAgICAgYWdnLnB1c2goZ2V0VG9vbHRpcEVudHJ5KHsKICAgICAgICAgIHRvb2x0aXBFbnRyeVNldHRpbmdzOiBuZXdTZXR0aW5ncywKICAgICAgICAgIGRhdGFLZXk6IGl0ZW0uZGF0YUtleSwKICAgICAgICAgIHBheWxvYWQ6IGl0ZW0ucGF5bG9hZCwKICAgICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgZ2V0VmFsdWVCeURhdGFLZXkgZG9lcyBub3QgdmFsaWRhdGUgdGhlIG91dHB1dCB0eXBlCiAgICAgICAgICB2YWx1ZTogZ2V0VmFsdWVCeURhdGFLZXkoaXRlbS5wYXlsb2FkLCBpdGVtLmRhdGFLZXkpLAogICAgICAgICAgbmFtZTogaXRlbS5uYW1lCiAgICAgICAgfSkpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBfZ2V0VmFsdWVCeURhdGFLZXk7CiAgICAgIGFnZy5wdXNoKGdldFRvb2x0aXBFbnRyeSh7CiAgICAgICAgdG9vbHRpcEVudHJ5U2V0dGluZ3M6IHNldHRpbmdzLAogICAgICAgIGRhdGFLZXk6IGZpbmFsRGF0YUtleSwKICAgICAgICBwYXlsb2FkOiB0b29sdGlwUGF5bG9hZCwKICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGdldFZhbHVlQnlEYXRhS2V5IGRvZXMgbm90IHZhbGlkYXRlIHRoZSBvdXRwdXQgdHlwZQogICAgICAgIHZhbHVlOiBnZXRWYWx1ZUJ5RGF0YUtleSh0b29sdGlwUGF5bG9hZCwgZmluYWxEYXRhS2V5KSwKICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGdldFZhbHVlQnlEYXRhS2V5IGRvZXMgbm90IHZhbGlkYXRlIHRoZSBvdXRwdXQgdHlwZQogICAgICAgIG5hbWU6IChfZ2V0VmFsdWVCeURhdGFLZXkgPSBnZXRWYWx1ZUJ5RGF0YUtleSh0b29sdGlwUGF5bG9hZCwgZmluYWxOYW1lS2V5KSkgIT09IG51bGwgJiYgX2dldFZhbHVlQnlEYXRhS2V5ICE9PSB2b2lkIDAgPyBfZ2V0VmFsdWVCeURhdGFLZXkgOiBzZXR0aW5ncyA9PT0gbnVsbCB8fCBzZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2V0dGluZ3MubmFtZQogICAgICB9KSk7CiAgICB9CiAgICByZXR1cm4gYWdnOwogIH0sIGluaXQpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvdG9vbHRpcFNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNSZWFsU2NhbGVUeXBlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0SGFzQmFyLCBzZWxlY3RDaGFydE5hbWUsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVSZWFsU2NhbGVUeXBlKTsKdmFyIHNlbGVjdEFsbFVuZmlsdGVyZWRHcmFwaGljYWxJdGVtcyA9IGNyZWF0ZVNlbGVjdG9yKFsoc3RhdGUpID0+IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLmNhcnRlc2lhbkl0ZW1zLCAoc3RhdGUpID0+IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLnBvbGFySXRlbXNdLCAoY2FydGVzaWFuSXRlbXMsIHBvbGFySXRlbXMpID0+IFsuLi5jYXJ0ZXNpYW5JdGVtcywgLi4ucG9sYXJJdGVtc10pOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNQcmVkaWNhdGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNUeXBlLCBzZWxlY3RUb29sdGlwQXhpc0lkXSwgaXRlbUF4aXNQcmVkaWNhdGUpOwp2YXIgc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5ncyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxVbmZpbHRlcmVkR3JhcGhpY2FsSXRlbXMsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1ByZWRpY2F0ZV0sIGNvbWJpbmVHcmFwaGljYWxJdGVtc1NldHRpbmdzLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IGVtcHR5QXJyYXlzQXJlRXF1YWxDaGVjawogIH0KfSk7CnZhciBzZWxlY3RBbGxTdGFja2VkR3JhcGhpY2FsSXRlbXNTZXR0aW5ncyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxHcmFwaGljYWxJdGVtc1NldHRpbmdzXSwgKGdyYXBoaWNhbEl0ZW1zKSA9PiBncmFwaGljYWxJdGVtcy5maWx0ZXIoaXNTdGFja2VkKSk7CnZhciBzZWxlY3RUb29sdGlwR3JhcGhpY2FsSXRlbXNEYXRhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3NdLCBjb21iaW5lR3JhcGhpY2FsSXRlbXNEYXRhLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IGVtcHR5QXJyYXlzQXJlRXF1YWxDaGVjawogIH0KfSk7CnZhciBzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwR3JhcGhpY2FsSXRlbXNEYXRhLCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlc10sIGNvbWJpbmVEaXNwbGF5ZWREYXRhKTsKdmFyIHNlbGVjdFRvb2x0aXBTdGFja2VkRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxTdGFja2VkR3JhcGhpY2FsSXRlbXNTZXR0aW5ncywgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHNlbGVjdFRvb2x0aXBBeGlzXSwgY29tYmluZURpc3BsYXllZFN0YWNrZWREYXRhKTsKdmFyIHNlbGVjdEFsbFRvb2x0aXBBcHBsaWVkVmFsdWVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBEaXNwbGF5ZWREYXRhLCBzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5nc10sIGNvbWJpbmVBcHBsaWVkVmFsdWVzKTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluRGVmaW5pdGlvbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc10sIGdldERvbWFpbkRlZmluaXRpb24pOwp2YXIgc2VsZWN0VG9vbHRpcERhdGFPdmVyZmxvdyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc10sIChheGlzU2V0dGluZ3MpID0+IGF4aXNTZXR0aW5ncy5hbGxvd0RhdGFPdmVyZmxvdyk7CnZhciBzZWxlY3RUb29sdGlwRG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc0RvbWFpbkRlZmluaXRpb24sIHNlbGVjdFRvb2x0aXBEYXRhT3ZlcmZsb3ddLCBudW1lcmljYWxEb21haW5TcGVjaWZpZWRXaXRob3V0UmVxdWlyaW5nRGF0YSk7CnZhciBzZWxlY3RBbGxTdGFja2VkR3JhcGhpY2FsSXRlbXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5nc10sIChncmFwaGljYWxJdGVtcykgPT4gZ3JhcGhpY2FsSXRlbXMuZmlsdGVyKGlzU3RhY2tlZCkpOwp2YXIgc2VsZWN0VG9vbHRpcFN0YWNrR3JvdXBzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGFja2VkRGF0YSwgc2VsZWN0QWxsU3RhY2tlZEdyYXBoaWNhbEl0ZW1zLCBzZWxlY3RTdGFja09mZnNldFR5cGUsIHNlbGVjdFJldmVyc2VTdGFja09yZGVyXSwgY29tYmluZVN0YWNrR3JvdXBzKTsKdmFyIHNlbGVjdFRvb2x0aXBEb21haW5PZlN0YWNrR3JvdXBzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGFja0dyb3Vwcywgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZXNdLCBjb21iaW5lRG9tYWluT2ZTdGFja0dyb3Vwcyk7CnZhciBzZWxlY3RUb29sdGlwSXRlbXNTZXR0aW5nc0V4Y2VwdFN0YWNrZWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5nc10sIGZpbHRlckdyYXBoaWNhbE5vdFN0YWNrZWRJdGVtcyk7CnZhciBzZWxlY3REb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlczIgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwSXRlbXNTZXR0aW5nc0V4Y2VwdFN0YWNrZWQsIHNlbGVjdEFsbEVycm9yQmFyU2V0dGluZ3MsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVEb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlcywgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBudW1iZXJEb21haW5FcXVhbGl0eUNoZWNrCiAgfQp9KTsKdmFyIHNlbGVjdFJlZmVyZW5jZURvdHNCeVRvb2x0aXBBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZURvdHMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VEb3RzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZURvdHNCeVRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lRG90c0RvbWFpbik7CnZhciBzZWxlY3RSZWZlcmVuY2VBcmVhc0J5VG9vbHRpcEF4aXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlQXJlYXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VBcmVhc0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VBcmVhc0J5VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVBcmVhc0RvbWFpbik7CnZhciBzZWxlY3RSZWZlcmVuY2VMaW5lc0J5VG9vbHRpcEF4aXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlTGluZXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VMaW5lc0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VMaW5lc0J5VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVMaW5lc0RvbWFpbik7CnZhciBzZWxlY3RUb29sdGlwUmVmZXJlbmNlRWxlbWVudHNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFJlZmVyZW5jZURvdHNEb21haW4sIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VMaW5lc0RvbWFpbiwgc2VsZWN0VG9vbHRpcFJlZmVyZW5jZUFyZWFzRG9tYWluXSwgbWVyZ2VEb21haW5zKTsKdmFyIHNlbGVjdFRvb2x0aXBOdW1lcmljYWxEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluRGVmaW5pdGlvbiwgc2VsZWN0VG9vbHRpcERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZXMsIHNlbGVjdFRvb2x0aXBEb21haW5PZlN0YWNrR3JvdXBzLCBzZWxlY3REb21haW5PZkFsbEFwcGxpZWROdW1lcmljYWxWYWx1ZXNJbmNsdWRpbmdFcnJvclZhbHVlczIsIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VFbGVtZW50c0RvbWFpbiwgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZV0sIGNvbWJpbmVOdW1lcmljYWxEb21haW4pOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YSwgc2VsZWN0QWxsVG9vbHRpcEFwcGxpZWRWYWx1ZXMsIHNlbGVjdFN0YWNrT2Zmc2V0VHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNUeXBlLCBzZWxlY3RUb29sdGlwTnVtZXJpY2FsRG9tYWluXSwgY29tYmluZUF4aXNEb21haW4pOwp2YXIgc2VsZWN0VG9vbHRpcE5pY2VUaWNrcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc0RvbWFpbiwgc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzUmVhbFNjYWxlVHlwZV0sIGNvbWJpbmVOaWNlVGlja3MpOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNEb21haW5JbmNsdWRpbmdOaWNlVGlja3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluLCBzZWxlY3RUb29sdGlwTmljZVRpY2tzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lQXhpc0RvbWFpbldpdGhOaWNlVGlja3MpOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZSA9IChzdGF0ZSkgPT4gewogIHZhciBheGlzVHlwZSA9IHNlbGVjdFRvb2x0aXBBeGlzVHlwZShzdGF0ZSk7CiAgdmFyIGF4aXNJZCA9IHNlbGVjdFRvb2x0aXBBeGlzSWQoc3RhdGUpOwogIHZhciBpc1Bhbm9yYW1hID0gZmFsc2U7CiAgcmV0dXJuIHNlbGVjdEF4aXNSYW5nZShzdGF0ZSwgYXhpc1R5cGUsIGF4aXNJZCwgaXNQYW5vcmFtYSk7Cn07CnZhciBzZWxlY3RUb29sdGlwQXhpc1JhbmdlV2l0aFJldmVyc2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzUmFuZ2VdLCBjb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UpOwp2YXIgc2VsZWN0VG9vbHRpcEF4aXNTY2FsZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNSZWFsU2NhbGVUeXBlLCBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbkluY2x1ZGluZ05pY2VUaWNrcywgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZVdpdGhSZXZlcnNlXSwgY29tYmluZVNjYWxlRnVuY3Rpb24pOwp2YXIgc2VsZWN0VG9vbHRpcER1cGxpY2F0ZURvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsVG9vbHRpcEFwcGxpZWRWYWx1ZXMsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lRHVwbGljYXRlRG9tYWluKTsKdmFyIHNlbGVjdFRvb2x0aXBDYXRlZ29yaWNhbERvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QWxsVG9vbHRpcEFwcGxpZWRWYWx1ZXMsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lQ2F0ZWdvcmljYWxEb21haW4pOwp2YXIgY29tYmluZVRpY2tzT2ZUb29sdGlwQXhpcyA9IChsYXlvdXQsIGF4aXMsIHJlYWxTY2FsZVR5cGUsIHNjYWxlLCByYW5nZTQsIGR1cGxpY2F0ZURvbWFpbiwgY2F0ZWdvcmljYWxEb21haW4sIGF4aXNUeXBlKSA9PiB7CiAgaWYgKCFheGlzKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgdHlwZQogIH0gPSBheGlzOwogIHZhciBpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCBheGlzVHlwZSk7CiAgaWYgKCFzY2FsZSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIG9mZnNldEZvckJhbmQgPSByZWFsU2NhbGVUeXBlID09PSAic2NhbGVCYW5kIiAmJiBzY2FsZS5iYW5kd2lkdGggPyBzY2FsZS5iYW5kd2lkdGgoKSAvIDIgOiAyOwogIHZhciBvZmZzZXQgPSB0eXBlID09PSAiY2F0ZWdvcnkiICYmIHNjYWxlLmJhbmR3aWR0aCA/IHNjYWxlLmJhbmR3aWR0aCgpIC8gb2Zmc2V0Rm9yQmFuZCA6IDA7CiAgb2Zmc2V0ID0gYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiICYmIHJhbmdlNCAhPSBudWxsICYmIChyYW5nZTQgPT09IG51bGwgfHwgcmFuZ2U0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiByYW5nZTQubGVuZ3RoKSA+PSAyID8gbWF0aFNpZ24ocmFuZ2U0WzBdIC0gcmFuZ2U0WzFdKSAqIDIgKiBvZmZzZXQgOiBvZmZzZXQ7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgY2F0ZWdvcmljYWxEb21haW4pIHsKICAgIHJldHVybiBjYXRlZ29yaWNhbERvbWFpbi5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIGluZGV4LAogICAgICBvZmZzZXQKICAgIH0pKTsKICB9CiAgcmV0dXJuIHNjYWxlLmRvbWFpbigpLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgdmFsdWU6IGR1cGxpY2F0ZURvbWFpbiA/IGR1cGxpY2F0ZURvbWFpbltlbnRyeV0gOiBlbnRyeSwKICAgIGluZGV4LAogICAgb2Zmc2V0CiAgfSkpOwp9Owp2YXIgc2VsZWN0VG9vbHRpcEF4aXNUaWNrcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzUmVhbFNjYWxlVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNTY2FsZSwgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZSwgc2VsZWN0VG9vbHRpcER1cGxpY2F0ZURvbWFpbiwgc2VsZWN0VG9vbHRpcENhdGVnb3JpY2FsRG9tYWluLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lVGlja3NPZlRvb2x0aXBBeGlzKTsKdmFyIHNlbGVjdFRvb2x0aXBFdmVudFR5cGUyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdERlZmF1bHRUb29sdGlwRXZlbnRUeXBlLCBzZWxlY3RWYWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzLCBzZWxlY3RUb29sdGlwU2V0dGluZ3NdLCAoZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZSwgc2V0dGluZ3MpID0+IGNvbWJpbmVUb29sdGlwRXZlbnRUeXBlKHNldHRpbmdzLnNoYXJlZCwgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZSkpOwp2YXIgc2VsZWN0VG9vbHRpcFRyaWdnZXIgPSAoc3RhdGUpID0+IHN0YXRlLnRvb2x0aXAuc2V0dGluZ3MudHJpZ2dlcjsKdmFyIHNlbGVjdERlZmF1bHRJbmRleCA9IChzdGF0ZSkgPT4gc3RhdGUudG9vbHRpcC5zZXR0aW5ncy5kZWZhdWx0SW5kZXg7CnZhciBzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwU3RhdGUsIHNlbGVjdFRvb2x0aXBFdmVudFR5cGUyLCBzZWxlY3RUb29sdGlwVHJpZ2dlciwgc2VsZWN0RGVmYXVsdEluZGV4XSwgY29tYmluZVRvb2x0aXBJbnRlcmFjdGlvblN0YXRlKTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSwgc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEsIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSwgc2VsZWN0VG9vbHRpcEF4aXNEb21haW5dLCBjb21iaW5lQWN0aXZlVG9vbHRpcEluZGV4KTsKdmFyIHNlbGVjdEFjdGl2ZUxhYmVsID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzVGlja3MsIHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleF0sIGNvbWJpbmVBY3RpdmVMYWJlbCk7CnZhciBzZWxlY3RBY3RpdmVUb29sdGlwRGF0YUtleSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZV0sICh0b29sdGlwSW50ZXJhY3Rpb24pID0+IHsKICBpZiAoIXRvb2x0aXBJbnRlcmFjdGlvbikgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIHRvb2x0aXBJbnRlcmFjdGlvbi5kYXRhS2V5Owp9KTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBHcmFwaGljYWxJdGVtSWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGVdLCAodG9vbHRpcEludGVyYWN0aW9uKSA9PiB7CiAgaWYgKCF0b29sdGlwSW50ZXJhY3Rpb24pIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiB0b29sdGlwSW50ZXJhY3Rpb24uZ3JhcGhpY2FsSXRlbUlkOwp9KTsKdmFyIHNlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFN0YXRlLCBzZWxlY3RUb29sdGlwRXZlbnRUeXBlMiwgc2VsZWN0VG9vbHRpcFRyaWdnZXIsIHNlbGVjdERlZmF1bHRJbmRleF0sIGNvbWJpbmVUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zKTsKdmFyIHNlbGVjdFRvb2x0aXBDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0V2lkdGgsIHNlbGVjdENoYXJ0SGVpZ2h0LCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgc2VsZWN0RGVmYXVsdEluZGV4LCBzZWxlY3RUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zLCBzZWxlY3RUb29sdGlwUGF5bG9hZFNlYXJjaGVyXSwgY29tYmluZUNvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXgpOwp2YXIgc2VsZWN0QWN0aXZlVG9vbHRpcENvb3JkaW5hdGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUsIHNlbGVjdFRvb2x0aXBDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4XSwgKHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLCBkZWZhdWx0SW5kZXhDb29yZGluYXRlKSA9PiB7CiAgaWYgKHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlICE9PSBudWxsICYmIHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlICE9PSB2b2lkIDAgJiYgdG9vbHRpcEludGVyYWN0aW9uU3RhdGUuY29vcmRpbmF0ZSkgewogICAgcmV0dXJuIHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmNvb3JkaW5hdGU7CiAgfQogIHJldHVybiBkZWZhdWx0SW5kZXhDb29yZGluYXRlOwp9KTsKdmFyIHNlbGVjdElzVG9vbHRpcEFjdGl2ZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZV0sICh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSkgPT4gdG9vbHRpcEludGVyYWN0aW9uU3RhdGUuYWN0aXZlKTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBQYXlsb2FkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMsIHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleCwgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMsIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSwgc2VsZWN0QWN0aXZlTGFiZWwsIHNlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsIHNlbGVjdFRvb2x0aXBFdmVudFR5cGUyXSwgY29tYmluZVRvb2x0aXBQYXlsb2FkKTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBEYXRhUG9pbnRzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFjdGl2ZVRvb2x0aXBQYXlsb2FkXSwgKHBheWxvYWQpID0+IHsKICBpZiAocGF5bG9hZCA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgZGF0YVBvaW50cyA9IHBheWxvYWQubWFwKChwKSA9PiBwLnBheWxvYWQpLmZpbHRlcigocCkgPT4gcCAhPSBudWxsKTsKICByZXR1cm4gQXJyYXkuZnJvbShuZXcgU2V0KGRhdGFQb2ludHMpKTsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvdXNlVG9vbHRpcEF4aXMuanMKZnVuY3Rpb24gb3duS2V5czE2KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTYoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxNihPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTYoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTYoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTE2KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTYocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTYodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTYodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTYodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciB1c2VUb29sdGlwQXhpcyA9ICgpID0+IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFRvb2x0aXBBeGlzKTsKdmFyIHVzZVRvb2x0aXBBeGlzQmFuZFNpemUgPSAoKSA9PiB7CiAgdmFyIHRvb2x0aXBBeGlzID0gdXNlVG9vbHRpcEF4aXMoKTsKICB2YXIgdG9vbHRpcFRpY2tzID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0VG9vbHRpcEF4aXNUaWNrcyk7CiAgdmFyIHRvb2x0aXBBeGlzU2NhbGUgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RUb29sdGlwQXhpc1NjYWxlKTsKICBpZiAoIXRvb2x0aXBBeGlzIHx8ICF0b29sdGlwQXhpc1NjYWxlKSB7CiAgICByZXR1cm4gZ2V0QmFuZFNpemVPZkF4aXModm9pZCAwLCB0b29sdGlwVGlja3MpOwogIH0KICByZXR1cm4gZ2V0QmFuZFNpemVPZkF4aXMoX29iamVjdFNwcmVhZDE2KF9vYmplY3RTcHJlYWQxNih7fSwgdG9vbHRpcEF4aXMpLCB7fSwgewogICAgc2NhbGU6IHRvb2x0aXBBeGlzU2NhbGUKICB9KSwgdG9vbHRpcFRpY2tzKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdG9ycy5qcwp2YXIgaW1wb3J0X3NvcnRCeTQgPSBfX3RvRVNNKHJlcXVpcmVfc29ydEJ5MigpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9nZXRBY3RpdmVDb29yZGluYXRlLmpzCmZ1bmN0aW9uIG93bktleXMxNyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDE3KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTcoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTE3KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czE3KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxNyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTE3KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTE3KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTE3KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTE3KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgZ2V0QWN0aXZlQ2FydGVzaWFuQ29vcmRpbmF0ZSA9IChsYXlvdXQsIHRvb2x0aXBUaWNrcywgYWN0aXZlSW5kZXgsIHBvaW50ZXIpID0+IHsKICB2YXIgZW50cnkgPSB0b29sdGlwVGlja3MuZmluZCgodGljaykgPT4gdGljayAmJiB0aWNrLmluZGV4ID09PSBhY3RpdmVJbmRleCk7CiAgaWYgKGVudHJ5KSB7CiAgICBpZiAobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiBlbnRyeS5jb29yZGluYXRlLAogICAgICAgIHk6IHBvaW50ZXIuY2hhcnRZCiAgICAgIH07CiAgICB9CiAgICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogcG9pbnRlci5jaGFydFgsCiAgICAgICAgeTogZW50cnkuY29vcmRpbmF0ZQogICAgICB9OwogICAgfQogIH0KICByZXR1cm4gewogICAgeDogMCwKICAgIHk6IDAKICB9Owp9Owp2YXIgZ2V0QWN0aXZlUG9sYXJDb29yZGluYXRlID0gKGxheW91dCwgdG9vbHRpcFRpY2tzLCBhY3RpdmVJbmRleCwgcmFuZ2VPYmopID0+IHsKICB2YXIgZW50cnkgPSB0b29sdGlwVGlja3MuZmluZCgodGljaykgPT4gdGljayAmJiB0aWNrLmluZGV4ID09PSBhY3RpdmVJbmRleCk7CiAgaWYgKGVudHJ5KSB7CiAgICBpZiAobGF5b3V0ID09PSAiY2VudHJpYyIpIHsKICAgICAgdmFyIF9hbmdsZSA9IGVudHJ5LmNvb3JkaW5hdGU7CiAgICAgIHZhciB7CiAgICAgICAgcmFkaXVzOiBfcmFkaXVzCiAgICAgIH0gPSByYW5nZU9iajsKICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQxNyhfb2JqZWN0U3ByZWFkMTcoX29iamVjdFNwcmVhZDE3KHt9LCByYW5nZU9iaiksIHBvbGFyVG9DYXJ0ZXNpYW4ocmFuZ2VPYmouY3gsIHJhbmdlT2JqLmN5LCBfcmFkaXVzLCBfYW5nbGUpKSwge30sIHsKICAgICAgICBhbmdsZTogX2FuZ2xlLAogICAgICAgIHJhZGl1czogX3JhZGl1cwogICAgICB9KTsKICAgIH0KICAgIHZhciByYWRpdXMgPSBlbnRyeS5jb29yZGluYXRlOwogICAgdmFyIHsKICAgICAgYW5nbGUKICAgIH0gPSByYW5nZU9iajsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTcoX29iamVjdFNwcmVhZDE3KF9vYmplY3RTcHJlYWQxNyh7fSwgcmFuZ2VPYmopLCBwb2xhclRvQ2FydGVzaWFuKHJhbmdlT2JqLmN4LCByYW5nZU9iai5jeSwgcmFkaXVzLCBhbmdsZSkpLCB7fSwgewogICAgICBhbmdsZSwKICAgICAgcmFkaXVzCiAgICB9KTsKICB9CiAgcmV0dXJuIHsKICAgIGFuZ2xlOiAwLAogICAgY2xvY2tXaXNlOiBmYWxzZSwKICAgIGN4OiAwLAogICAgY3k6IDAsCiAgICBlbmRBbmdsZTogMCwKICAgIGlubmVyUmFkaXVzOiAwLAogICAgb3V0ZXJSYWRpdXM6IDAsCiAgICByYWRpdXM6IDAsCiAgICBzdGFydEFuZ2xlOiAwLAogICAgeDogMCwKICAgIHk6IDAKICB9Owp9OwpmdW5jdGlvbiBpc0luQ2FydGVzaWFuUmFuZ2UocG9pbnRlciwgb2Zmc2V0KSB7CiAgdmFyIHsKICAgIGNoYXJ0WDogeDIsCiAgICBjaGFydFk6IHkyCiAgfSA9IHBvaW50ZXI7CiAgcmV0dXJuIHgyID49IG9mZnNldC5sZWZ0ICYmIHgyIDw9IG9mZnNldC5sZWZ0ICsgb2Zmc2V0LndpZHRoICYmIHkyID49IG9mZnNldC50b3AgJiYgeTIgPD0gb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQ7Cn0KdmFyIGNhbGN1bGF0ZUFjdGl2ZVRpY2tJbmRleCA9IChjb29yZGluYXRlLCB0aWNrczIsIHVuc29ydGVkVGlja3MsIGF4aXNUeXBlLCByYW5nZTQpID0+IHsKICB2YXIgX3RpY2tzJGxlbmd0aDsKICB2YXIgaW5kZXggPSAtMTsKICB2YXIgbGVuID0gKF90aWNrcyRsZW5ndGggPSB0aWNrczIgPT09IG51bGwgfHwgdGlja3MyID09PSB2b2lkIDAgPyB2b2lkIDAgOiB0aWNrczIubGVuZ3RoKSAhPT0gbnVsbCAmJiBfdGlja3MkbGVuZ3RoICE9PSB2b2lkIDAgPyBfdGlja3MkbGVuZ3RoIDogMDsKICBpZiAobGVuIDw9IDEgfHwgY29vcmRpbmF0ZSA9PSBudWxsKSB7CiAgICByZXR1cm4gMDsKICB9CiAgaWYgKGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIiAmJiByYW5nZTQgIT0gbnVsbCAmJiBNYXRoLmFicyhNYXRoLmFicyhyYW5nZTRbMV0gLSByYW5nZTRbMF0pIC0gMzYwKSA8PSAxZS02KSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHZhciBiZWZvcmUgPSBpID4gMCA/IHVuc29ydGVkVGlja3NbaSAtIDFdLmNvb3JkaW5hdGUgOiB1bnNvcnRlZFRpY2tzW2xlbiAtIDFdLmNvb3JkaW5hdGU7CiAgICAgIHZhciBjdXIgPSB1bnNvcnRlZFRpY2tzW2ldLmNvb3JkaW5hdGU7CiAgICAgIHZhciBhZnRlciA9IGkgPj0gbGVuIC0gMSA/IHVuc29ydGVkVGlja3NbMF0uY29vcmRpbmF0ZSA6IHVuc29ydGVkVGlja3NbaSArIDFdLmNvb3JkaW5hdGU7CiAgICAgIHZhciBzYW1lRGlyZWN0aW9uQ29vcmQgPSB2b2lkIDA7CiAgICAgIGlmIChtYXRoU2lnbihjdXIgLSBiZWZvcmUpICE9PSBtYXRoU2lnbihhZnRlciAtIGN1cikpIHsKICAgICAgICB2YXIgZGlmZkludGVydmFsID0gW107CiAgICAgICAgaWYgKG1hdGhTaWduKGFmdGVyIC0gY3VyKSA9PT0gbWF0aFNpZ24ocmFuZ2U0WzFdIC0gcmFuZ2U0WzBdKSkgewogICAgICAgICAgc2FtZURpcmVjdGlvbkNvb3JkID0gYWZ0ZXI7CiAgICAgICAgICB2YXIgY3VySW5SYW5nZSA9IGN1ciArIHJhbmdlNFsxXSAtIHJhbmdlNFswXTsKICAgICAgICAgIGRpZmZJbnRlcnZhbFswXSA9IE1hdGgubWluKGN1ckluUmFuZ2UsIChjdXJJblJhbmdlICsgYmVmb3JlKSAvIDIpOwogICAgICAgICAgZGlmZkludGVydmFsWzFdID0gTWF0aC5tYXgoY3VySW5SYW5nZSwgKGN1ckluUmFuZ2UgKyBiZWZvcmUpIC8gMik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNhbWVEaXJlY3Rpb25Db29yZCA9IGJlZm9yZTsKICAgICAgICAgIHZhciBhZnRlckluUmFuZ2UgPSBhZnRlciArIHJhbmdlNFsxXSAtIHJhbmdlNFswXTsKICAgICAgICAgIGRpZmZJbnRlcnZhbFswXSA9IE1hdGgubWluKGN1ciwgKGFmdGVySW5SYW5nZSArIGN1cikgLyAyKTsKICAgICAgICAgIGRpZmZJbnRlcnZhbFsxXSA9IE1hdGgubWF4KGN1ciwgKGFmdGVySW5SYW5nZSArIGN1cikgLyAyKTsKICAgICAgICB9CiAgICAgICAgdmFyIHNhbWVJbnRlcnZhbCA9IFtNYXRoLm1pbihjdXIsIChzYW1lRGlyZWN0aW9uQ29vcmQgKyBjdXIpIC8gMiksIE1hdGgubWF4KGN1ciwgKHNhbWVEaXJlY3Rpb25Db29yZCArIGN1cikgLyAyKV07CiAgICAgICAgaWYgKGNvb3JkaW5hdGUgPiBzYW1lSW50ZXJ2YWxbMF0gJiYgY29vcmRpbmF0ZSA8PSBzYW1lSW50ZXJ2YWxbMV0gfHwgY29vcmRpbmF0ZSA+PSBkaWZmSW50ZXJ2YWxbMF0gJiYgY29vcmRpbmF0ZSA8PSBkaWZmSW50ZXJ2YWxbMV0pIHsKICAgICAgICAgICh7CiAgICAgICAgICAgIGluZGV4CiAgICAgICAgICB9ID0gdW5zb3J0ZWRUaWNrc1tpXSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIG1pblZhbHVlID0gTWF0aC5taW4oYmVmb3JlLCBhZnRlcik7CiAgICAgICAgdmFyIG1heFZhbHVlID0gTWF0aC5tYXgoYmVmb3JlLCBhZnRlcik7CiAgICAgICAgaWYgKGNvb3JkaW5hdGUgPiAobWluVmFsdWUgKyBjdXIpIC8gMiAmJiBjb29yZGluYXRlIDw9IChtYXhWYWx1ZSArIGN1cikgLyAyKSB7CiAgICAgICAgICAoewogICAgICAgICAgICBpbmRleAogICAgICAgICAgfSA9IHVuc29ydGVkVGlja3NbaV0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSBlbHNlIGlmICh0aWNrczIpIHsKICAgIGZvciAodmFyIF9pID0gMDsgX2kgPCBsZW47IF9pKyspIHsKICAgICAgaWYgKF9pID09PSAwICYmIGNvb3JkaW5hdGUgPD0gKHRpY2tzMltfaV0uY29vcmRpbmF0ZSArIHRpY2tzMltfaSArIDFdLmNvb3JkaW5hdGUpIC8gMiB8fCBfaSA+IDAgJiYgX2kgPCBsZW4gLSAxICYmIGNvb3JkaW5hdGUgPiAodGlja3MyW19pXS5jb29yZGluYXRlICsgdGlja3MyW19pIC0gMV0uY29vcmRpbmF0ZSkgLyAyICYmIGNvb3JkaW5hdGUgPD0gKHRpY2tzMltfaV0uY29vcmRpbmF0ZSArIHRpY2tzMltfaSArIDFdLmNvb3JkaW5hdGUpIC8gMiB8fCBfaSA9PT0gbGVuIC0gMSAmJiBjb29yZGluYXRlID4gKHRpY2tzMltfaV0uY29vcmRpbmF0ZSArIHRpY2tzMltfaSAtIDFdLmNvb3JkaW5hdGUpIC8gMikgewogICAgICAgICh7CiAgICAgICAgICBpbmRleAogICAgICAgIH0gPSB0aWNrczJbX2ldKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gaW5kZXg7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RvcnMuanMKdmFyIHVzZUNoYXJ0TmFtZSA9ICgpID0+IHsKICByZXR1cm4gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0Q2hhcnROYW1lKTsKfTsKdmFyIHBpY2tUb29sdGlwRXZlbnRUeXBlID0gKF9zdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSkgPT4gdG9vbHRpcEV2ZW50VHlwZTsKdmFyIHBpY2tUcmlnZ2VyID0gKF9zdGF0ZSwgX3Rvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIpID0+IHRyaWdnZXI7CnZhciBwaWNrRGVmYXVsdEluZGV4ID0gKF9zdGF0ZSwgX3Rvb2x0aXBFdmVudFR5cGUsIF90cmlnZ2VyLCBkZWZhdWx0SW5kZXgpID0+IGRlZmF1bHRJbmRleDsKdmFyIHNlbGVjdE9yZGVyZWRUb29sdGlwVGlja3MgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RUb29sdGlwQXhpc1RpY2tzLCAodGlja3MyKSA9PiAoMCwgaW1wb3J0X3NvcnRCeTQuZGVmYXVsdCkodGlja3MyLCAobykgPT4gby5jb29yZGluYXRlKSk7CnZhciBzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZTIgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFN0YXRlLCBwaWNrVG9vbHRpcEV2ZW50VHlwZSwgcGlja1RyaWdnZXIsIHBpY2tEZWZhdWx0SW5kZXhdLCBjb21iaW5lVG9vbHRpcEludGVyYWN0aW9uU3RhdGUpOwp2YXIgc2VsZWN0QWN0aXZlSW5kZXggPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUyLCBzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YSwgc2VsZWN0VG9vbHRpcEF4aXNEYXRhS2V5LCBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbl0sIGNvbWJpbmVBY3RpdmVUb29sdGlwSW5kZXgpOwp2YXIgc2VsZWN0VG9vbHRpcERhdGFLZXkgPSAoc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIpID0+IHsKICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgdG9vbHRpcFN0YXRlID0gc2VsZWN0VG9vbHRpcFN0YXRlKHN0YXRlKTsKICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICBpZiAodHJpZ2dlciA9PT0gImhvdmVyIikgewogICAgICByZXR1cm4gdG9vbHRpcFN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3Zlci5kYXRhS2V5OwogICAgfQogICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5heGlzSW50ZXJhY3Rpb24uY2xpY2suZGF0YUtleTsKICB9CiAgaWYgKHRyaWdnZXIgPT09ICJob3ZlciIpIHsKICAgIHJldHVybiB0b29sdGlwU3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmRhdGFLZXk7CiAgfQogIHJldHVybiB0b29sdGlwU3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmRhdGFLZXk7Cn07CnZhciBzZWxlY3RUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zMiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwU3RhdGUsIHBpY2tUb29sdGlwRXZlbnRUeXBlLCBwaWNrVHJpZ2dlciwgcGlja0RlZmF1bHRJbmRleF0sIGNvbWJpbmVUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zKTsKdmFyIHNlbGVjdENvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXggPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRXaWR0aCwgc2VsZWN0Q2hhcnRIZWlnaHQsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RUb29sdGlwQXhpc1RpY2tzLCBwaWNrRGVmYXVsdEluZGV4LCBzZWxlY3RUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zMiwgc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlcl0sIGNvbWJpbmVDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4KTsKdmFyIHNlbGVjdEFjdGl2ZUNvb3JkaW5hdGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUyLCBzZWxlY3RDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4XSwgKHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLCBkZWZhdWx0SW5kZXhDb29yZGluYXRlKSA9PiB7CiAgdmFyIF90b29sdGlwSW50ZXJhY3Rpb25TdDsKICByZXR1cm4gKF90b29sdGlwSW50ZXJhY3Rpb25TdCA9IHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmNvb3JkaW5hdGUpICE9PSBudWxsICYmIF90b29sdGlwSW50ZXJhY3Rpb25TdCAhPT0gdm9pZCAwID8gX3Rvb2x0aXBJbnRlcmFjdGlvblN0IDogZGVmYXVsdEluZGV4Q29vcmRpbmF0ZTsKfSk7CnZhciBzZWxlY3RBY3RpdmVMYWJlbDIgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgc2VsZWN0QWN0aXZlSW5kZXhdLCBjb21iaW5lQWN0aXZlTGFiZWwpOwp2YXIgc2VsZWN0VG9vbHRpcFBheWxvYWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9uczIsIHNlbGVjdEFjdGl2ZUluZGV4LCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlcywgc2VsZWN0VG9vbHRpcEF4aXNEYXRhS2V5LCBzZWxlY3RBY3RpdmVMYWJlbDIsIHNlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsIHBpY2tUb29sdGlwRXZlbnRUeXBlXSwgY29tYmluZVRvb2x0aXBQYXlsb2FkKTsKdmFyIHNlbGVjdElzVG9vbHRpcEFjdGl2ZTIgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUyLCBzZWxlY3RBY3RpdmVJbmRleF0sICh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSwgYWN0aXZlSW5kZXgpID0+IHsKICByZXR1cm4gewogICAgaXNBY3RpdmU6IHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmFjdGl2ZSAmJiBhY3RpdmVJbmRleCAhPSBudWxsLAogICAgYWN0aXZlSW5kZXgKICB9Owp9KTsKdmFyIGNvbWJpbmVBY3RpdmVDYXJ0ZXNpYW5Qcm9wcyA9IChjaGFydEV2ZW50LCBsYXlvdXQsIHRvb2x0aXBBeGlzVHlwZSwgdG9vbHRpcEF4aXNSYW5nZSwgdG9vbHRpcFRpY2tzLCBvcmRlcmVkVG9vbHRpcFRpY2tzLCBvZmZzZXQpID0+IHsKICBpZiAoIWNoYXJ0RXZlbnQgfHwgIXRvb2x0aXBBeGlzVHlwZSB8fCAhdG9vbHRpcEF4aXNSYW5nZSB8fCAhdG9vbHRpcFRpY2tzKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoIWlzSW5DYXJ0ZXNpYW5SYW5nZShjaGFydEV2ZW50LCBvZmZzZXQpKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgcG9zID0gY2FsY3VsYXRlQ2FydGVzaWFuVG9vbHRpcFBvcyhjaGFydEV2ZW50LCBsYXlvdXQpOwogIHZhciBhY3RpdmVJbmRleCA9IGNhbGN1bGF0ZUFjdGl2ZVRpY2tJbmRleChwb3MsIG9yZGVyZWRUb29sdGlwVGlja3MsIHRvb2x0aXBUaWNrcywgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlKTsKICB2YXIgYWN0aXZlQ29vcmRpbmF0ZSA9IGdldEFjdGl2ZUNhcnRlc2lhbkNvb3JkaW5hdGUobGF5b3V0LCB0b29sdGlwVGlja3MsIGFjdGl2ZUluZGV4LCBjaGFydEV2ZW50KTsKICByZXR1cm4gewogICAgYWN0aXZlSW5kZXg6IFN0cmluZyhhY3RpdmVJbmRleCksCiAgICBhY3RpdmVDb29yZGluYXRlCiAgfTsKfTsKdmFyIGNvbWJpbmVBY3RpdmVQb2xhclByb3BzID0gKGNoYXJ0RXZlbnQsIGxheW91dCwgcG9sYXJWaWV3Qm94LCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UsIHRvb2x0aXBUaWNrcywgb3JkZXJlZFRvb2x0aXBUaWNrcykgPT4gewogIGlmICghY2hhcnRFdmVudCB8fCAhdG9vbHRpcEF4aXNUeXBlIHx8ICF0b29sdGlwQXhpc1JhbmdlIHx8ICF0b29sdGlwVGlja3MgfHwgIXBvbGFyVmlld0JveCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHJhbmdlT2JqID0gaW5SYW5nZU9mU2VjdG9yKGNoYXJ0RXZlbnQsIHBvbGFyVmlld0JveCk7CiAgaWYgKCFyYW5nZU9iaikgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHBvcyA9IGNhbGN1bGF0ZVBvbGFyVG9vbHRpcFBvcyhyYW5nZU9iaiwgbGF5b3V0KTsKICB2YXIgYWN0aXZlSW5kZXggPSBjYWxjdWxhdGVBY3RpdmVUaWNrSW5kZXgocG9zLCBvcmRlcmVkVG9vbHRpcFRpY2tzLCB0b29sdGlwVGlja3MsIHRvb2x0aXBBeGlzVHlwZSwgdG9vbHRpcEF4aXNSYW5nZSk7CiAgdmFyIGFjdGl2ZUNvb3JkaW5hdGUgPSBnZXRBY3RpdmVQb2xhckNvb3JkaW5hdGUobGF5b3V0LCB0b29sdGlwVGlja3MsIGFjdGl2ZUluZGV4LCByYW5nZU9iaik7CiAgcmV0dXJuIHsKICAgIGFjdGl2ZUluZGV4OiBTdHJpbmcoYWN0aXZlSW5kZXgpLAogICAgYWN0aXZlQ29vcmRpbmF0ZQogIH07Cn07CnZhciBjb21iaW5lQWN0aXZlUHJvcHMgPSAoY2hhcnRFdmVudCwgbGF5b3V0LCBwb2xhclZpZXdCb3gsIHRvb2x0aXBBeGlzVHlwZSwgdG9vbHRpcEF4aXNSYW5nZSwgdG9vbHRpcFRpY2tzLCBvcmRlcmVkVG9vbHRpcFRpY2tzLCBvZmZzZXQpID0+IHsKICBpZiAoIWNoYXJ0RXZlbnQgfHwgIWxheW91dCB8fCAhdG9vbHRpcEF4aXNUeXBlIHx8ICF0b29sdGlwQXhpc1JhbmdlIHx8ICF0b29sdGlwVGlja3MpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIiB8fCBsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgIHJldHVybiBjb21iaW5lQWN0aXZlQ2FydGVzaWFuUHJvcHMoY2hhcnRFdmVudCwgbGF5b3V0LCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UsIHRvb2x0aXBUaWNrcywgb3JkZXJlZFRvb2x0aXBUaWNrcywgb2Zmc2V0KTsKICB9CiAgcmV0dXJuIGNvbWJpbmVBY3RpdmVQb2xhclByb3BzKGNoYXJ0RXZlbnQsIGxheW91dCwgcG9sYXJWaWV3Qm94LCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UsIHRvb2x0aXBUaWNrcywgb3JkZXJlZFRvb2x0aXBUaWNrcyk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3pJbmRleC9aSW5kZXhMYXllci5qcwp2YXIgaW1wb3J0X3JlYWN0MjAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3RfZG9tID0gX190b0VTTShyZXF1aXJlX3JlYWN0X2RvbSgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvekluZGV4L3pJbmRleFNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0WkluZGV4UG9ydGFsSWQgPSBjcmVhdGVTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLnpJbmRleC56SW5kZXhNYXAsIChfLCB6SW5kZXgpID0+IHpJbmRleCwgKF8sIF96SW5kZXgsIGlzUGFub3JhbWEpID0+IGlzUGFub3JhbWEsICh6SW5kZXhNYXAsIHpJbmRleCwgaXNQYW5vcmFtYSkgPT4gewogIGlmICh6SW5kZXggPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGVudHJ5ID0gekluZGV4TWFwW3pJbmRleF07CiAgaWYgKGVudHJ5ID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChpc1Bhbm9yYW1hKSB7CiAgICByZXR1cm4gZW50cnkucGFub3JhbWFFbGVtZW50SWQ7CiAgfQogIHJldHVybiBlbnRyeS5lbGVtZW50SWQ7Cn0pOwp2YXIgc2VsZWN0QWxsUmVnaXN0ZXJlZFpJbmRleGVzID0gY3JlYXRlU2VsZWN0b3IoKHN0YXRlKSA9PiBzdGF0ZS56SW5kZXguekluZGV4TWFwLCAoekluZGV4TWFwKSA9PiB7CiAgdmFyIGFsbE51bWJlcnMgPSBPYmplY3Qua2V5cyh6SW5kZXhNYXApLm1hcCgoekluZGV4U3RyKSA9PiBwYXJzZUludCh6SW5kZXhTdHIsIDEwKSkuY29uY2F0KE9iamVjdC52YWx1ZXMoRGVmYXVsdFpJbmRleGVzKSk7CiAgdmFyIHVuaXF1ZU51bWJlcnMgPSBBcnJheS5mcm9tKG5ldyBTZXQoYWxsTnVtYmVycykpOwogIHJldHVybiB1bmlxdWVOdW1iZXJzLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKfSwgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBhcnJheUNvbnRlbnRzQXJlRXF1YWxDaGVjawogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3pJbmRleFNsaWNlLmpzCmZ1bmN0aW9uIG93bktleXMxOChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDE4KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTgoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTE4KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czE4KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxOChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTE4KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTE4KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTE4KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTE4KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgc2VlZCA9IHt9Owp2YXIgaW5pdGlhbFN0YXRlNCA9IHsKICB6SW5kZXhNYXA6IE9iamVjdC52YWx1ZXMoRGVmYXVsdFpJbmRleGVzKS5yZWR1Y2UoKGFjYywgY3VycmVudDMpID0+IF9vYmplY3RTcHJlYWQxOChfb2JqZWN0U3ByZWFkMTgoe30sIGFjYyksIHt9LCB7CiAgICBbY3VycmVudDNdOiB7CiAgICAgIGVsZW1lbnRJZDogdm9pZCAwLAogICAgICBwYW5vcmFtYUVsZW1lbnRJZDogdm9pZCAwLAogICAgICBjb25zdW1lcnM6IDAKICAgIH0KICB9KSwgc2VlZCkKfTsKdmFyIGRlZmF1bHRaSW5kZXhTZXQgPSBuZXcgU2V0KE9iamVjdC52YWx1ZXMoRGVmYXVsdFpJbmRleGVzKSk7CmZ1bmN0aW9uIGlzRGVmYXVsdFpJbmRleCh6SW5kZXgpIHsKICByZXR1cm4gZGVmYXVsdFpJbmRleFNldC5oYXMoekluZGV4KTsKfQp2YXIgekluZGV4U2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogInpJbmRleCIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGU0LAogIHJlZHVjZXJzOiB7CiAgICByZWdpc3RlclpJbmRleFBvcnRhbDogewogICAgICByZWR1Y2VyOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICAgIHZhciB7CiAgICAgICAgICB6SW5kZXgKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgaWYgKHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdKSB7CiAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XS5jb25zdW1lcnMgKz0gMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0gPSB7CiAgICAgICAgICAgIGNvbnN1bWVyczogMSwKICAgICAgICAgICAgZWxlbWVudElkOiB2b2lkIDAsCiAgICAgICAgICAgIHBhbm9yYW1hRWxlbWVudElkOiB2b2lkIDAKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHVucmVnaXN0ZXJaSW5kZXhQb3J0YWw6IHsKICAgICAgcmVkdWNlcjogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgICB2YXIgewogICAgICAgICAgekluZGV4CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIGlmIChzdGF0ZS56SW5kZXhNYXBbekluZGV4XSkgewogICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0uY29uc3VtZXJzIC09IDE7CiAgICAgICAgICBpZiAoc3RhdGUuekluZGV4TWFwW3pJbmRleF0uY29uc3VtZXJzIDw9IDAgJiYgIWlzRGVmYXVsdFpJbmRleCh6SW5kZXgpKSB7CiAgICAgICAgICAgIGRlbGV0ZSBzdGF0ZS56SW5kZXhNYXBbekluZGV4XTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVnaXN0ZXJaSW5kZXhQb3J0YWxJZDogewogICAgICByZWR1Y2VyOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICAgIHZhciB7CiAgICAgICAgICB6SW5kZXgsCiAgICAgICAgICBlbGVtZW50SWQsCiAgICAgICAgICBpc1Bhbm9yYW1hCiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIGlmIChzdGF0ZS56SW5kZXhNYXBbekluZGV4XSkgewogICAgICAgICAgaWYgKGlzUGFub3JhbWEpIHsKICAgICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0ucGFub3JhbWFFbGVtZW50SWQgPSBlbGVtZW50SWQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XS5lbGVtZW50SWQgPSBlbGVtZW50SWQ7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdID0gewogICAgICAgICAgICBjb25zdW1lcnM6IDAsCiAgICAgICAgICAgIGVsZW1lbnRJZDogaXNQYW5vcmFtYSA/IHZvaWQgMCA6IGVsZW1lbnRJZCwKICAgICAgICAgICAgcGFub3JhbWFFbGVtZW50SWQ6IGlzUGFub3JhbWEgPyBlbGVtZW50SWQgOiB2b2lkIDAKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHVucmVnaXN0ZXJaSW5kZXhQb3J0YWxJZDogewogICAgICByZWR1Y2VyOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICAgIHZhciB7CiAgICAgICAgICB6SW5kZXgKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgaWYgKHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdKSB7CiAgICAgICAgICBpZiAoYWN0aW9uLnBheWxvYWQuaXNQYW5vcmFtYSkgewogICAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XS5wYW5vcmFtYUVsZW1lbnRJZCA9IHZvaWQgMDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLmVsZW1lbnRJZCA9IHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9CiAgfQp9KTsKdmFyIHsKICByZWdpc3RlclpJbmRleFBvcnRhbCwKICB1bnJlZ2lzdGVyWkluZGV4UG9ydGFsLAogIHJlZ2lzdGVyWkluZGV4UG9ydGFsSWQsCiAgdW5yZWdpc3RlclpJbmRleFBvcnRhbElkCn0gPSB6SW5kZXhTbGljZS5hY3Rpb25zOwp2YXIgekluZGV4UmVkdWNlciA9IHpJbmRleFNsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3pJbmRleC9aSW5kZXhMYXllci5qcwpmdW5jdGlvbiBaSW5kZXhMYXllcihfcmVmMikgewogIHZhciB7CiAgICB6SW5kZXgsCiAgICBjaGlsZHJlbgogIH0gPSBfcmVmMjsKICB2YXIgaXNJbkNoYXJ0Q29udGV4dCA9IHVzZUlzSW5DaGFydENvbnRleHQoKTsKICB2YXIgc2hvdWxkUmVuZGVySW5Qb3J0YWwgPSBpc0luQ2hhcnRDb250ZXh0ICYmIHpJbmRleCAhPT0gdm9pZCAwICYmIHpJbmRleCAhPT0gMDsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogICgwLCBpbXBvcnRfcmVhY3QyMC51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIGlmICghc2hvdWxkUmVuZGVySW5Qb3J0YWwpIHsKICAgICAgcmV0dXJuIG5vb3A7CiAgICB9CiAgICBkaXNwYXRjaChyZWdpc3RlclpJbmRleFBvcnRhbCh7CiAgICAgIHpJbmRleAogICAgfSkpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgZGlzcGF0Y2godW5yZWdpc3RlclpJbmRleFBvcnRhbCh7CiAgICAgICAgekluZGV4CiAgICAgIH0pKTsKICAgIH07CiAgfSwgW2Rpc3BhdGNoLCB6SW5kZXgsIHNob3VsZFJlbmRlckluUG9ydGFsXSk7CiAgdmFyIHBvcnRhbElkID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RaSW5kZXhQb3J0YWxJZChzdGF0ZSwgekluZGV4LCBpc1Bhbm9yYW1hKSk7CiAgaWYgKCFzaG91bGRSZW5kZXJJblBvcnRhbCkgewogICAgcmV0dXJuIGNoaWxkcmVuOwogIH0KICBpZiAoIXBvcnRhbElkKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHpJbmRleFBvcnRhbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHBvcnRhbElkKTsKICBpZiAoekluZGV4UG9ydGFsKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3RfZG9tLmNyZWF0ZVBvcnRhbCkoY2hpbGRyZW4sIHpJbmRleFBvcnRhbCk7CiAgfQogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9DdXJzb3IuanMKZnVuY3Rpb24gX2V4dGVuZHM5KCkgewogIHJldHVybiBfZXh0ZW5kczkgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzMTkoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxOShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czE5KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxOShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxOShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTkoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxOShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxOSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxOSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxOSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gUmVuZGVyQ3Vyc29yKF9yZWYyKSB7CiAgdmFyIHsKICAgIGN1cnNvciwKICAgIGN1cnNvckNvbXAsCiAgICBjdXJzb3JQcm9wcwogIH0gPSBfcmVmMjsKICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyMS5pc1ZhbGlkRWxlbWVudCkoY3Vyc29yKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjEuY2xvbmVFbGVtZW50KShjdXJzb3IsIGN1cnNvclByb3BzKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjEuY3JlYXRlRWxlbWVudCkoY3Vyc29yQ29tcCwgY3Vyc29yUHJvcHMpOwp9CmZ1bmN0aW9uIEN1cnNvckludGVybmFsKHByb3BzKSB7CiAgdmFyIF9wcm9wcyR6SW5kZXg7CiAgdmFyIHsKICAgIGNvb3JkaW5hdGUsCiAgICBwYXlsb2FkLAogICAgaW5kZXgsCiAgICBvZmZzZXQsCiAgICB0b29sdGlwQXhpc0JhbmRTaXplLAogICAgbGF5b3V0LAogICAgY3Vyc29yLAogICAgdG9vbHRpcEV2ZW50VHlwZSwKICAgIGNoYXJ0TmFtZQogIH0gPSBwcm9wczsKICB2YXIgYWN0aXZlQ29vcmRpbmF0ZSA9IGNvb3JkaW5hdGU7CiAgdmFyIGFjdGl2ZVBheWxvYWQgPSBwYXlsb2FkOwogIHZhciBhY3RpdmVUb29sdGlwSW5kZXggPSBpbmRleDsKICBpZiAoIWN1cnNvciB8fCAhYWN0aXZlQ29vcmRpbmF0ZSB8fCBjaGFydE5hbWUgIT09ICJTY2F0dGVyQ2hhcnQiICYmIHRvb2x0aXBFdmVudFR5cGUgIT09ICJheGlzIikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciByZXN0UHJvcHMsIGN1cnNvckNvbXAsIHByZWZlcnJlZFpJbmRleDsKICBpZiAoY2hhcnROYW1lID09PSAiU2NhdHRlckNoYXJ0IikgewogICAgcmVzdFByb3BzID0gYWN0aXZlQ29vcmRpbmF0ZTsKICAgIGN1cnNvckNvbXAgPSBDcm9zczsKICAgIHByZWZlcnJlZFpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5jdXJzb3JMaW5lOwogIH0gZWxzZSBpZiAoY2hhcnROYW1lID09PSAiQmFyQ2hhcnQiKSB7CiAgICByZXN0UHJvcHMgPSBnZXRDdXJzb3JSZWN0YW5nbGUobGF5b3V0LCBhY3RpdmVDb29yZGluYXRlLCBvZmZzZXQsIHRvb2x0aXBBeGlzQmFuZFNpemUpOwogICAgY3Vyc29yQ29tcCA9IFJlY3RhbmdsZTsKICAgIHByZWZlcnJlZFpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5jdXJzb3JSZWN0YW5nbGU7CiAgfSBlbHNlIGlmIChsYXlvdXQgPT09ICJyYWRpYWwiICYmIGlzUG9sYXJDb29yZGluYXRlKGFjdGl2ZUNvb3JkaW5hdGUpKSB7CiAgICB2YXIgewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIHJhZGl1cywKICAgICAgc3RhcnRBbmdsZSwKICAgICAgZW5kQW5nbGUKICAgIH0gPSBnZXRSYWRpYWxDdXJzb3JQb2ludHMoYWN0aXZlQ29vcmRpbmF0ZSk7CiAgICByZXN0UHJvcHMgPSB7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgc3RhcnRBbmdsZSwKICAgICAgZW5kQW5nbGUsCiAgICAgIGlubmVyUmFkaXVzOiByYWRpdXMsCiAgICAgIG91dGVyUmFkaXVzOiByYWRpdXMKICAgIH07CiAgICBjdXJzb3JDb21wID0gU2VjdG9yOwogICAgcHJlZmVycmVkWkluZGV4ID0gRGVmYXVsdFpJbmRleGVzLmN1cnNvckxpbmU7CiAgfSBlbHNlIHsKICAgIHJlc3RQcm9wcyA9IHsKICAgICAgcG9pbnRzOiBnZXRDdXJzb3JQb2ludHMobGF5b3V0LCBhY3RpdmVDb29yZGluYXRlLCBvZmZzZXQpCiAgICB9OwogICAgY3Vyc29yQ29tcCA9IEN1cnZlOwogICAgcHJlZmVycmVkWkluZGV4ID0gRGVmYXVsdFpJbmRleGVzLmN1cnNvckxpbmU7CiAgfQogIHZhciBleHRyYUNsYXNzTmFtZSA9IHR5cGVvZiBjdXJzb3IgPT09ICJvYmplY3QiICYmICJjbGFzc05hbWUiIGluIGN1cnNvciA/IGN1cnNvci5jbGFzc05hbWUgOiB2b2lkIDA7CiAgdmFyIGN1cnNvclByb3BzID0gX29iamVjdFNwcmVhZDE5KF9vYmplY3RTcHJlYWQxOShfb2JqZWN0U3ByZWFkMTkoX29iamVjdFNwcmVhZDE5KHsKICAgIHN0cm9rZTogIiNjY2MiLAogICAgcG9pbnRlckV2ZW50czogIm5vbmUiCiAgfSwgb2Zmc2V0KSwgcmVzdFByb3BzKSwgc3ZnUHJvcGVydGllc05vRXZlbnRzRnJvbVVua25vd24oY3Vyc29yKSksIHt9LCB7CiAgICBwYXlsb2FkOiBhY3RpdmVQYXlsb2FkLAogICAgcGF5bG9hZEluZGV4OiBhY3RpdmVUb29sdGlwSW5kZXgsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLXRvb2x0aXAtY3Vyc29yIiwgZXh0cmFDbGFzc05hbWUpCiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDExLmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleDogKF9wcm9wcyR6SW5kZXggPSBwcm9wcy56SW5kZXgpICE9PSBudWxsICYmIF9wcm9wcyR6SW5kZXggIT09IHZvaWQgMCA/IF9wcm9wcyR6SW5kZXggOiBwcmVmZXJyZWRaSW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QxMS5jcmVhdGVFbGVtZW50KFJlbmRlckN1cnNvciwgewogICAgY3Vyc29yLAogICAgY3Vyc29yQ29tcCwKICAgIGN1cnNvclByb3BzCiAgfSkpOwp9CmZ1bmN0aW9uIEN1cnNvcihwcm9wcykgewogIHZhciB0b29sdGlwQXhpc0JhbmRTaXplID0gdXNlVG9vbHRpcEF4aXNCYW5kU2l6ZSgpOwogIHZhciBvZmZzZXQgPSB1c2VPZmZzZXRJbnRlcm5hbCgpOwogIHZhciBsYXlvdXQgPSB1c2VDaGFydExheW91dCgpOwogIHZhciBjaGFydE5hbWUgPSB1c2VDaGFydE5hbWUoKTsKICBpZiAodG9vbHRpcEF4aXNCYW5kU2l6ZSA9PSBudWxsIHx8IG9mZnNldCA9PSBudWxsIHx8IGxheW91dCA9PSBudWxsIHx8IGNoYXJ0TmFtZSA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDExLmNyZWF0ZUVsZW1lbnQoQ3Vyc29ySW50ZXJuYWwsIF9leHRlbmRzOSh7fSwgcHJvcHMsIHsKICAgIG9mZnNldCwKICAgIGxheW91dCwKICAgIHRvb2x0aXBBeGlzQmFuZFNpemUsCiAgICBjaGFydE5hbWUKICB9KSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC90b29sdGlwUG9ydGFsQ29udGV4dC5qcwp2YXIgaW1wb3J0X3JlYWN0MjIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBUb29sdGlwUG9ydGFsQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjIuY3JlYXRlQ29udGV4dCkobnVsbCk7CnZhciB1c2VUb29sdGlwUG9ydGFsID0gKCkgPT4gKDAsIGltcG9ydF9yZWFjdDIyLnVzZUNvbnRleHQpKFRvb2x0aXBQb3J0YWxDb250ZXh0KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3luY2hyb25pc2F0aW9uL3VzZUNoYXJ0U3luY2hyb25pc2F0aW9uLmpzCnZhciBpbXBvcnRfcmVhY3QyMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9ldmVudGVtaXR0ZXIzL2luZGV4Lm1qcwp2YXIgaW1wb3J0X2luZGV4ID0gX190b0VTTShyZXF1aXJlX2V2ZW50ZW1pdHRlcjMoKSwgMSk7CnZhciBldmVudGVtaXR0ZXIzX2RlZmF1bHQgPSBpbXBvcnRfaW5kZXguZGVmYXVsdDsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9FdmVudHMuanMKdmFyIGV2ZW50Q2VudGVyID0gbmV3IGV2ZW50ZW1pdHRlcjNfZGVmYXVsdCgpOwp2YXIgVE9PTFRJUF9TWU5DX0VWRU5UID0gInJlY2hhcnRzLnN5bmNFdmVudC50b29sdGlwIjsKdmFyIEJSVVNIX1NZTkNfRVZFTlQgPSAicmVjaGFydHMuc3luY0V2ZW50LmJydXNoIjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvb3B0aW9uc1NsaWNlLmpzCmZ1bmN0aW9uIGFycmF5VG9vbHRpcFNlYXJjaGVyKGRhdGEsIHN0ckluZGV4KSB7CiAgaWYgKCFzdHJJbmRleCkgcmV0dXJuIHZvaWQgMDsKICB2YXIgbnVtSW5kZXggPSBOdW1iZXIucGFyc2VJbnQoc3RySW5kZXgsIDEwKTsKICBpZiAoaXNOYW4obnVtSW5kZXgpKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZGF0YSA9PT0gbnVsbCB8fCBkYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhW251bUluZGV4XTsKfQp2YXIgaW5pdGlhbFN0YXRlNSA9IHsKICBjaGFydE5hbWU6ICIiLAogIHRvb2x0aXBQYXlsb2FkU2VhcmNoZXI6IHZvaWQgMCwKICBldmVudEVtaXR0ZXI6IHZvaWQgMCwKICBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZTogImF4aXMiCn07CnZhciBvcHRpb25zU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogIm9wdGlvbnMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlNSwKICByZWR1Y2VyczogewogICAgY3JlYXRlRXZlbnRFbWl0dGVyOiAoc3RhdGUpID0+IHsKICAgICAgaWYgKHN0YXRlLmV2ZW50RW1pdHRlciA9PSBudWxsKSB7CiAgICAgICAgc3RhdGUuZXZlbnRFbWl0dGVyID0gU3ltYm9sKCJyZWNoYXJ0c0V2ZW50RW1pdHRlciIpOwogICAgICB9CiAgICB9CiAgfQp9KTsKdmFyIG9wdGlvbnNSZWR1Y2VyID0gb3B0aW9uc1NsaWNlLnJlZHVjZXI7CnZhciB7CiAgY3JlYXRlRXZlbnRFbWl0dGVyCn0gPSBvcHRpb25zU2xpY2UuYWN0aW9uczsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3luY2hyb25pc2F0aW9uL3N5bmNTZWxlY3RvcnMuanMKZnVuY3Rpb24gc2VsZWN0U3luY2hyb25pc2VkVG9vbHRpcFN0YXRlKHN0YXRlKSB7CiAgcmV0dXJuIHN0YXRlLnRvb2x0aXAuc3luY0ludGVyYWN0aW9uOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2NoYXJ0RGF0YVNsaWNlLmpzCnZhciBpbml0aWFsQ2hhcnREYXRhU3RhdGUgPSB7CiAgY2hhcnREYXRhOiB2b2lkIDAsCiAgY29tcHV0ZWREYXRhOiB2b2lkIDAsCiAgZGF0YVN0YXJ0SW5kZXg6IDAsCiAgZGF0YUVuZEluZGV4OiAwCn07CnZhciBjaGFydERhdGFTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiY2hhcnREYXRhIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxDaGFydERhdGFTdGF0ZSwKICByZWR1Y2VyczogewogICAgc2V0Q2hhcnREYXRhKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuY2hhcnREYXRhID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIGlmIChhY3Rpb24ucGF5bG9hZCA9PSBudWxsKSB7CiAgICAgICAgc3RhdGUuZGF0YVN0YXJ0SW5kZXggPSAwOwogICAgICAgIHN0YXRlLmRhdGFFbmRJbmRleCA9IDA7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChhY3Rpb24ucGF5bG9hZC5sZW5ndGggPiAwICYmIHN0YXRlLmRhdGFFbmRJbmRleCAhPT0gYWN0aW9uLnBheWxvYWQubGVuZ3RoIC0gMSkgewogICAgICAgIHN0YXRlLmRhdGFFbmRJbmRleCA9IGFjdGlvbi5wYXlsb2FkLmxlbmd0aCAtIDE7CiAgICAgIH0KICAgIH0sCiAgICBzZXRDb21wdXRlZERhdGEoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5jb21wdXRlZERhdGEgPSBhY3Rpb24ucGF5bG9hZDsKICAgIH0sCiAgICBzZXREYXRhU3RhcnRFbmRJbmRleGVzKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgdmFyIHsKICAgICAgICBzdGFydEluZGV4LAogICAgICAgIGVuZEluZGV4CiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgaWYgKHN0YXJ0SW5kZXggIT0gbnVsbCkgewogICAgICAgIHN0YXRlLmRhdGFTdGFydEluZGV4ID0gc3RhcnRJbmRleDsKICAgICAgfQogICAgICBpZiAoZW5kSW5kZXggIT0gbnVsbCkgewogICAgICAgIHN0YXRlLmRhdGFFbmRJbmRleCA9IGVuZEluZGV4OwogICAgICB9CiAgICB9CiAgfQp9KTsKdmFyIHsKICBzZXRDaGFydERhdGEsCiAgc2V0RGF0YVN0YXJ0RW5kSW5kZXhlcywKICBzZXRDb21wdXRlZERhdGEKfSA9IGNoYXJ0RGF0YVNsaWNlLmFjdGlvbnM7CnZhciBjaGFydERhdGFSZWR1Y2VyID0gY2hhcnREYXRhU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3luY2hyb25pc2F0aW9uL3VzZUNoYXJ0U3luY2hyb25pc2F0aW9uLmpzCnZhciBfZXhjbHVkZWQ1ID0gWyJ4IiwgInkiXTsKZnVuY3Rpb24gb3duS2V5czIwKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjAoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyMChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjAoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjAoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTIwKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjAocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjAodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjAodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjAodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczUoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTUoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTUocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIHVzZVRvb2x0aXBTeW5jRXZlbnRzTGlzdGVuZXIoKSB7CiAgdmFyIG15U3luY0lkID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0U3luY0lkKTsKICB2YXIgbXlFdmVudEVtaXR0ZXIgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RFdmVudEVtaXR0ZXIpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIHN5bmNNZXRob2QgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RTeW5jTWV0aG9kKTsKICB2YXIgdG9vbHRpcFRpY2tzID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0VG9vbHRpcEF4aXNUaWNrcyk7CiAgdmFyIGxheW91dCA9IHVzZUNoYXJ0TGF5b3V0KCk7CiAgdmFyIHZpZXdCb3ggPSB1c2VWaWV3Qm94KCk7CiAgdmFyIGNsYXNzTmFtZSA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLmNsYXNzTmFtZSk7CiAgKDAsIGltcG9ydF9yZWFjdDIzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKG15U3luY0lkID09IG51bGwpIHsKICAgICAgcmV0dXJuIG5vb3A7CiAgICB9CiAgICB2YXIgbGlzdGVuZXIyID0gKGluY29taW5nU3luY0lkLCBhY3Rpb24sIGVtaXR0ZXIpID0+IHsKICAgICAgaWYgKG15RXZlbnRFbWl0dGVyID09PSBlbWl0dGVyKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmIChteVN5bmNJZCAhPT0gaW5jb21pbmdTeW5jSWQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKHN5bmNNZXRob2QgPT09ICJpbmRleCIpIHsKICAgICAgICB2YXIgX2FjdGlvbiRwYXlsb2FkOwogICAgICAgIGlmICh2aWV3Qm94ICYmIGFjdGlvbiAhPT0gbnVsbCAmJiBhY3Rpb24gIT09IHZvaWQgMCAmJiAoX2FjdGlvbiRwYXlsb2FkID0gYWN0aW9uLnBheWxvYWQpICE9PSBudWxsICYmIF9hY3Rpb24kcGF5bG9hZCAhPT0gdm9pZCAwICYmIF9hY3Rpb24kcGF5bG9hZC5jb29yZGluYXRlICYmIGFjdGlvbi5wYXlsb2FkLnNvdXJjZVZpZXdCb3gpIHsKICAgICAgICAgIHZhciBfYWN0aW9uJHBheWxvYWQkY29vcmQgPSBhY3Rpb24ucGF5bG9hZC5jb29yZGluYXRlLCB7CiAgICAgICAgICAgIHg6IF94LAogICAgICAgICAgICB5OiBfeQogICAgICAgICAgfSA9IF9hY3Rpb24kcGF5bG9hZCRjb29yZCwgb3RoZXJDb29yZGluYXRlUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM1KF9hY3Rpb24kcGF5bG9hZCRjb29yZCwgX2V4Y2x1ZGVkNSk7CiAgICAgICAgICB2YXIgewogICAgICAgICAgICB4OiBzb3VyY2VYLAogICAgICAgICAgICB5OiBzb3VyY2VZLAogICAgICAgICAgICB3aWR0aDogc291cmNlV2lkdGgsCiAgICAgICAgICAgIGhlaWdodDogc291cmNlSGVpZ2h0CiAgICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQuc291cmNlVmlld0JveDsKICAgICAgICAgIHZhciBzY2FsZWRDb29yZGluYXRlID0gX29iamVjdFNwcmVhZDIwKF9vYmplY3RTcHJlYWQyMCh7fSwgb3RoZXJDb29yZGluYXRlUHJvcHMpLCB7fSwgewogICAgICAgICAgICB4OiB2aWV3Qm94LnggKyAoc291cmNlV2lkdGggPyAoX3ggLSBzb3VyY2VYKSAvIHNvdXJjZVdpZHRoIDogMCkgKiB2aWV3Qm94LndpZHRoLAogICAgICAgICAgICB5OiB2aWV3Qm94LnkgKyAoc291cmNlSGVpZ2h0ID8gKF95IC0gc291cmNlWSkgLyBzb3VyY2VIZWlnaHQgOiAwKSAqIHZpZXdCb3guaGVpZ2h0CiAgICAgICAgICB9KTsKICAgICAgICAgIGRpc3BhdGNoKF9vYmplY3RTcHJlYWQyMChfb2JqZWN0U3ByZWFkMjAoe30sIGFjdGlvbiksIHt9LCB7CiAgICAgICAgICAgIHBheWxvYWQ6IF9vYmplY3RTcHJlYWQyMChfb2JqZWN0U3ByZWFkMjAoe30sIGFjdGlvbi5wYXlsb2FkKSwge30sIHsKICAgICAgICAgICAgICBjb29yZGluYXRlOiBzY2FsZWRDb29yZGluYXRlCiAgICAgICAgICAgIH0pCiAgICAgICAgICB9KSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGRpc3BhdGNoKGFjdGlvbik7CiAgICAgICAgfQogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAodG9vbHRpcFRpY2tzID09IG51bGwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIGFjdGl2ZVRpY2s7CiAgICAgIGlmICh0eXBlb2Ygc3luY01ldGhvZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIHZhciBzeW5jTWV0aG9kUGFyYW0gPSB7CiAgICAgICAgICBhY3RpdmVUb29sdGlwSW5kZXg6IGFjdGlvbi5wYXlsb2FkLmluZGV4ID09IG51bGwgPyB2b2lkIDAgOiBOdW1iZXIoYWN0aW9uLnBheWxvYWQuaW5kZXgpLAogICAgICAgICAgaXNUb29sdGlwQWN0aXZlOiBhY3Rpb24ucGF5bG9hZC5hY3RpdmUsCiAgICAgICAgICBhY3RpdmVJbmRleDogYWN0aW9uLnBheWxvYWQuaW5kZXggPT0gbnVsbCA/IHZvaWQgMCA6IE51bWJlcihhY3Rpb24ucGF5bG9hZC5pbmRleCksCiAgICAgICAgICBhY3RpdmVMYWJlbDogYWN0aW9uLnBheWxvYWQubGFiZWwsCiAgICAgICAgICBhY3RpdmVEYXRhS2V5OiBhY3Rpb24ucGF5bG9hZC5kYXRhS2V5LAogICAgICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogYWN0aW9uLnBheWxvYWQuY29vcmRpbmF0ZQogICAgICAgIH07CiAgICAgICAgdmFyIGFjdGl2ZVRvb2x0aXBJbmRleCA9IHN5bmNNZXRob2QodG9vbHRpcFRpY2tzLCBzeW5jTWV0aG9kUGFyYW0pOwogICAgICAgIGFjdGl2ZVRpY2sgPSB0b29sdGlwVGlja3NbYWN0aXZlVG9vbHRpcEluZGV4XTsKICAgICAgfSBlbHNlIGlmIChzeW5jTWV0aG9kID09PSAidmFsdWUiKSB7CiAgICAgICAgYWN0aXZlVGljayA9IHRvb2x0aXBUaWNrcy5maW5kKCh0aWNrKSA9PiBTdHJpbmcodGljay52YWx1ZSkgPT09IGFjdGlvbi5wYXlsb2FkLmxhYmVsKTsKICAgICAgfQogICAgICB2YXIgewogICAgICAgIGNvb3JkaW5hdGUKICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICBpZiAoYWN0aXZlVGljayA9PSBudWxsIHx8IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZSA9PT0gZmFsc2UgfHwgY29vcmRpbmF0ZSA9PSBudWxsIHx8IHZpZXdCb3ggPT0gbnVsbCkgewogICAgICAgIGRpc3BhdGNoKHNldFN5bmNJbnRlcmFjdGlvbih7CiAgICAgICAgICBhY3RpdmU6IGZhbHNlLAogICAgICAgICAgY29vcmRpbmF0ZTogdm9pZCAwLAogICAgICAgICAgZGF0YUtleTogdm9pZCAwLAogICAgICAgICAgaW5kZXg6IG51bGwsCiAgICAgICAgICBsYWJlbDogdm9pZCAwLAogICAgICAgICAgc291cmNlVmlld0JveDogdm9pZCAwLAogICAgICAgICAgZ3JhcGhpY2FsSXRlbUlkOiB2b2lkIDAKICAgICAgICB9KSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciB7CiAgICAgICAgeDogeDIsCiAgICAgICAgeTogeTIKICAgICAgfSA9IGNvb3JkaW5hdGU7CiAgICAgIHZhciB2YWxpZGF0ZUNoYXJ0WCA9IE1hdGgubWluKHgyLCB2aWV3Qm94LnggKyB2aWV3Qm94LndpZHRoKTsKICAgICAgdmFyIHZhbGlkYXRlQ2hhcnRZID0gTWF0aC5taW4oeTIsIHZpZXdCb3gueSArIHZpZXdCb3guaGVpZ2h0KTsKICAgICAgdmFyIGFjdGl2ZUNvb3JkaW5hdGUgPSB7CiAgICAgICAgeDogbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgPyBhY3RpdmVUaWNrLmNvb3JkaW5hdGUgOiB2YWxpZGF0ZUNoYXJ0WCwKICAgICAgICB5OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IHZhbGlkYXRlQ2hhcnRZIDogYWN0aXZlVGljay5jb29yZGluYXRlCiAgICAgIH07CiAgICAgIHZhciBzeW5jQWN0aW9uID0gc2V0U3luY0ludGVyYWN0aW9uKHsKICAgICAgICBhY3RpdmU6IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZSwKICAgICAgICBjb29yZGluYXRlOiBhY3RpdmVDb29yZGluYXRlLAogICAgICAgIGRhdGFLZXk6IGFjdGlvbi5wYXlsb2FkLmRhdGFLZXksCiAgICAgICAgaW5kZXg6IFN0cmluZyhhY3RpdmVUaWNrLmluZGV4KSwKICAgICAgICBsYWJlbDogYWN0aW9uLnBheWxvYWQubGFiZWwsCiAgICAgICAgc291cmNlVmlld0JveDogYWN0aW9uLnBheWxvYWQuc291cmNlVmlld0JveCwKICAgICAgICBncmFwaGljYWxJdGVtSWQ6IGFjdGlvbi5wYXlsb2FkLmdyYXBoaWNhbEl0ZW1JZAogICAgICB9KTsKICAgICAgZGlzcGF0Y2goc3luY0FjdGlvbik7CiAgICB9OwogICAgZXZlbnRDZW50ZXIub24oVE9PTFRJUF9TWU5DX0VWRU5ULCBsaXN0ZW5lcjIpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgZXZlbnRDZW50ZXIub2ZmKFRPT0xUSVBfU1lOQ19FVkVOVCwgbGlzdGVuZXIyKTsKICAgIH07CiAgfSwgW2NsYXNzTmFtZSwgZGlzcGF0Y2gsIG15RXZlbnRFbWl0dGVyLCBteVN5bmNJZCwgc3luY01ldGhvZCwgdG9vbHRpcFRpY2tzLCBsYXlvdXQsIHZpZXdCb3hdKTsKfQpmdW5jdGlvbiB1c2VCcnVzaFN5bmNFdmVudHNMaXN0ZW5lcigpIHsKICB2YXIgbXlTeW5jSWQgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RTeW5jSWQpOwogIHZhciBteUV2ZW50RW1pdHRlciA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEV2ZW50RW1pdHRlcik7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICAoMCwgaW1wb3J0X3JlYWN0MjMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAobXlTeW5jSWQgPT0gbnVsbCkgewogICAgICByZXR1cm4gbm9vcDsKICAgIH0KICAgIHZhciBsaXN0ZW5lcjIgPSAoaW5jb21pbmdTeW5jSWQsIGFjdGlvbiwgZW1pdHRlcikgPT4gewogICAgICBpZiAobXlFdmVudEVtaXR0ZXIgPT09IGVtaXR0ZXIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKG15U3luY0lkID09PSBpbmNvbWluZ1N5bmNJZCkgewogICAgICAgIGRpc3BhdGNoKHNldERhdGFTdGFydEVuZEluZGV4ZXMoYWN0aW9uKSk7CiAgICAgIH0KICAgIH07CiAgICBldmVudENlbnRlci5vbihCUlVTSF9TWU5DX0VWRU5ULCBsaXN0ZW5lcjIpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgZXZlbnRDZW50ZXIub2ZmKEJSVVNIX1NZTkNfRVZFTlQsIGxpc3RlbmVyMik7CiAgICB9OwogIH0sIFtkaXNwYXRjaCwgbXlFdmVudEVtaXR0ZXIsIG15U3luY0lkXSk7Cn0KZnVuY3Rpb24gdXNlU3luY2hyb25pc2VkRXZlbnRzRnJvbU90aGVyQ2hhcnRzKCkgewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDIzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgZGlzcGF0Y2goY3JlYXRlRXZlbnRFbWl0dGVyKCkpOwogIH0sIFtkaXNwYXRjaF0pOwogIHVzZVRvb2x0aXBTeW5jRXZlbnRzTGlzdGVuZXIoKTsKICB1c2VCcnVzaFN5bmNFdmVudHNMaXN0ZW5lcigpOwp9CmZ1bmN0aW9uIHVzZVRvb2x0aXBDaGFydFN5bmNocm9uaXNhdGlvbih0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBhY3RpdmVDb29yZGluYXRlLCBhY3RpdmVMYWJlbCwgYWN0aXZlSW5kZXgsIGlzVG9vbHRpcEFjdGl2ZSkgewogIHZhciBhY3RpdmVEYXRhS2V5ID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RUb29sdGlwRGF0YUtleShzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlcikpOwogIHZhciBldmVudEVtaXR0ZXJTeW1ib2wgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RFdmVudEVtaXR0ZXIpOwogIHZhciBzeW5jSWQgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RTeW5jSWQpOwogIHZhciBzeW5jTWV0aG9kID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0U3luY01ldGhvZCk7CiAgdmFyIHRvb2x0aXBTdGF0ZSA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFN5bmNocm9uaXNlZFRvb2x0aXBTdGF0ZSk7CiAgdmFyIGlzUmVjZWl2aW5nU3luY2hyb25pc2F0aW9uID0gdG9vbHRpcFN0YXRlID09PSBudWxsIHx8IHRvb2x0aXBTdGF0ZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogdG9vbHRpcFN0YXRlLmFjdGl2ZTsKICB2YXIgdmlld0JveCA9IHVzZVZpZXdCb3goKTsKICAoMCwgaW1wb3J0X3JlYWN0MjMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoaXNSZWNlaXZpbmdTeW5jaHJvbmlzYXRpb24pIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHN5bmNJZCA9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChldmVudEVtaXR0ZXJTeW1ib2wgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgc3luY0FjdGlvbiA9IHNldFN5bmNJbnRlcmFjdGlvbih7CiAgICAgIGFjdGl2ZTogaXNUb29sdGlwQWN0aXZlLAogICAgICBjb29yZGluYXRlOiBhY3RpdmVDb29yZGluYXRlLAogICAgICBkYXRhS2V5OiBhY3RpdmVEYXRhS2V5LAogICAgICBpbmRleDogYWN0aXZlSW5kZXgsCiAgICAgIGxhYmVsOiB0eXBlb2YgYWN0aXZlTGFiZWwgPT09ICJudW1iZXIiID8gU3RyaW5nKGFjdGl2ZUxhYmVsKSA6IGFjdGl2ZUxhYmVsLAogICAgICBzb3VyY2VWaWV3Qm94OiB2aWV3Qm94LAogICAgICBncmFwaGljYWxJdGVtSWQ6IHZvaWQgMAogICAgfSk7CiAgICBldmVudENlbnRlci5lbWl0KFRPT0xUSVBfU1lOQ19FVkVOVCwgc3luY0lkLCBzeW5jQWN0aW9uLCBldmVudEVtaXR0ZXJTeW1ib2wpOwogIH0sIFtpc1JlY2VpdmluZ1N5bmNocm9uaXNhdGlvbiwgYWN0aXZlQ29vcmRpbmF0ZSwgYWN0aXZlRGF0YUtleSwgYWN0aXZlSW5kZXgsIGFjdGl2ZUxhYmVsLCBldmVudEVtaXR0ZXJTeW1ib2wsIHN5bmNJZCwgc3luY01ldGhvZCwgaXNUb29sdGlwQWN0aXZlLCB2aWV3Qm94XSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1Rvb2x0aXAuanMKZnVuY3Rpb24gb3duS2V5czIxKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjEoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyMShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjEoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjEoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTIxKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjEocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjEodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjEodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjEodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIGRlZmF1bHRVbmlxQnkoZW50cnkpIHsKICByZXR1cm4gZW50cnkuZGF0YUtleTsKfQpmdW5jdGlvbiByZW5kZXJDb250ZW50KGNvbnRlbnQsIHByb3BzKSB7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEyLmlzVmFsaWRFbGVtZW50KGNvbnRlbnQpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTIuY2xvbmVFbGVtZW50KGNvbnRlbnQsIHByb3BzKTsKICB9CiAgaWYgKHR5cGVvZiBjb250ZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTIuY3JlYXRlRWxlbWVudChjb250ZW50LCBwcm9wcyk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMi5jcmVhdGVFbGVtZW50KERlZmF1bHRUb29sdGlwQ29udGVudCwgcHJvcHMpOwp9CnZhciBlbXB0eVBheWxvYWQgPSBbXTsKdmFyIGRlZmF1bHRUb29sdGlwUHJvcHMgPSB7CiAgYWxsb3dFc2NhcGVWaWV3Qm94OiB7CiAgICB4OiBmYWxzZSwKICAgIHk6IGZhbHNlCiAgfSwKICBhbmltYXRpb25EdXJhdGlvbjogNDAwLAogIGFuaW1hdGlvbkVhc2luZzogImVhc2UiLAogIGF4aXNJZDogMCwKICBjb250ZW50U3R5bGU6IHt9LAogIGN1cnNvcjogdHJ1ZSwKICBmaWx0ZXJOdWxsOiB0cnVlLAogIGlzQW5pbWF0aW9uQWN0aXZlOiAiYXV0byIsCiAgaXRlbVNvcnRlcjogIm5hbWUiLAogIGl0ZW1TdHlsZToge30sCiAgbGFiZWxTdHlsZToge30sCiAgb2Zmc2V0OiAxMCwKICByZXZlcnNlRGlyZWN0aW9uOiB7CiAgICB4OiBmYWxzZSwKICAgIHk6IGZhbHNlCiAgfSwKICBzZXBhcmF0b3I6ICIgOiAiLAogIHRyaWdnZXI6ICJob3ZlciIsCiAgdXNlVHJhbnNsYXRlM2Q6IGZhbHNlLAogIHdyYXBwZXJTdHlsZToge30KfTsKZnVuY3Rpb24gVG9vbHRpcChvdXRzaWRlUHJvcHMpIHsKICB2YXIgX3VzZUFwcFNlbGVjdG9yLCBfcmVmMjsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgZGVmYXVsdFRvb2x0aXBQcm9wcyk7CiAgdmFyIHsKICAgIGFjdGl2ZTogYWN0aXZlRnJvbVByb3BzLAogICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25FYXNpbmcsCiAgICBjb250ZW50LAogICAgZmlsdGVyTnVsbCwKICAgIGlzQW5pbWF0aW9uQWN0aXZlLAogICAgb2Zmc2V0LAogICAgcGF5bG9hZFVuaXFCeSwKICAgIHBvc2l0aW9uLAogICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgIHVzZVRyYW5zbGF0ZTNkLAogICAgd3JhcHBlclN0eWxlLAogICAgY3Vyc29yLAogICAgc2hhcmVkLAogICAgdHJpZ2dlciwKICAgIGRlZmF1bHRJbmRleCwKICAgIHBvcnRhbDogcG9ydGFsRnJvbVByb3BzLAogICAgYXhpc0lkCiAgfSA9IHByb3BzOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGRlZmF1bHRJbmRleEFzU3RyaW5nID0gdHlwZW9mIGRlZmF1bHRJbmRleCA9PT0gIm51bWJlciIgPyBTdHJpbmcoZGVmYXVsdEluZGV4KSA6IGRlZmF1bHRJbmRleDsKICAoMCwgaW1wb3J0X3JlYWN0MjQudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBkaXNwYXRjaChzZXRUb29sdGlwU2V0dGluZ3NTdGF0ZSh7CiAgICAgIHNoYXJlZCwKICAgICAgdHJpZ2dlciwKICAgICAgYXhpc0lkLAogICAgICBhY3RpdmU6IGFjdGl2ZUZyb21Qcm9wcywKICAgICAgZGVmYXVsdEluZGV4OiBkZWZhdWx0SW5kZXhBc1N0cmluZwogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgc2hhcmVkLCB0cmlnZ2VyLCBheGlzSWQsIGFjdGl2ZUZyb21Qcm9wcywgZGVmYXVsdEluZGV4QXNTdHJpbmddKTsKICB2YXIgdmlld0JveCA9IHVzZVZpZXdCb3goKTsKICB2YXIgYWNjZXNzaWJpbGl0eUxheWVyID0gdXNlQWNjZXNzaWJpbGl0eUxheWVyKCk7CiAgdmFyIHRvb2x0aXBFdmVudFR5cGUgPSB1c2VUb29sdGlwRXZlbnRUeXBlKHNoYXJlZCk7CiAgdmFyIHsKICAgIGFjdGl2ZUluZGV4LAogICAgaXNBY3RpdmUKICB9ID0gKF91c2VBcHBTZWxlY3RvciA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0SXNUb29sdGlwQWN0aXZlMihzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4QXNTdHJpbmcpKSkgIT09IG51bGwgJiYgX3VzZUFwcFNlbGVjdG9yICE9PSB2b2lkIDAgPyBfdXNlQXBwU2VsZWN0b3IgOiB7fTsKICB2YXIgcGF5bG9hZEZyb21SZWR1eCA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0VG9vbHRpcFBheWxvYWQoc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGRlZmF1bHRJbmRleEFzU3RyaW5nKSk7CiAgdmFyIGxhYmVsRnJvbVJlZHV4ID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBY3RpdmVMYWJlbDIoc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGRlZmF1bHRJbmRleEFzU3RyaW5nKSk7CiAgdmFyIGNvb3JkaW5hdGUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEFjdGl2ZUNvb3JkaW5hdGUoc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGRlZmF1bHRJbmRleEFzU3RyaW5nKSk7CiAgdmFyIHBheWxvYWQgPSBwYXlsb2FkRnJvbVJlZHV4OwogIHZhciB0b29sdGlwUG9ydGFsRnJvbUNvbnRleHQgPSB1c2VUb29sdGlwUG9ydGFsKCk7CiAgdmFyIGZpbmFsSXNBY3RpdmUgPSAoX3JlZjIgPSBhY3RpdmVGcm9tUHJvcHMgIT09IG51bGwgJiYgYWN0aXZlRnJvbVByb3BzICE9PSB2b2lkIDAgPyBhY3RpdmVGcm9tUHJvcHMgOiBpc0FjdGl2ZSkgIT09IG51bGwgJiYgX3JlZjIgIT09IHZvaWQgMCA/IF9yZWYyIDogZmFsc2U7CiAgdmFyIFtsYXN0Qm91bmRpbmdCb3gsIHVwZGF0ZUJvdW5kaW5nQm94XSA9IHVzZUVsZW1lbnRPZmZzZXQoW3BheWxvYWQsIGZpbmFsSXNBY3RpdmVdKTsKICB2YXIgZmluYWxMYWJlbCA9IHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIiA/IGxhYmVsRnJvbVJlZHV4IDogdm9pZCAwOwogIHVzZVRvb2x0aXBDaGFydFN5bmNocm9uaXNhdGlvbih0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBjb29yZGluYXRlLCBmaW5hbExhYmVsLCBhY3RpdmVJbmRleCwgZmluYWxJc0FjdGl2ZSk7CiAgdmFyIHRvb2x0aXBQb3J0YWwgPSBwb3J0YWxGcm9tUHJvcHMgIT09IG51bGwgJiYgcG9ydGFsRnJvbVByb3BzICE9PSB2b2lkIDAgPyBwb3J0YWxGcm9tUHJvcHMgOiB0b29sdGlwUG9ydGFsRnJvbUNvbnRleHQ7CiAgaWYgKHRvb2x0aXBQb3J0YWwgPT0gbnVsbCB8fCB2aWV3Qm94ID09IG51bGwgfHwgdG9vbHRpcEV2ZW50VHlwZSA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGZpbmFsUGF5bG9hZCA9IHBheWxvYWQgIT09IG51bGwgJiYgcGF5bG9hZCAhPT0gdm9pZCAwID8gcGF5bG9hZCA6IGVtcHR5UGF5bG9hZDsKICBpZiAoIWZpbmFsSXNBY3RpdmUpIHsKICAgIGZpbmFsUGF5bG9hZCA9IGVtcHR5UGF5bG9hZDsKICB9CiAgaWYgKGZpbHRlck51bGwgJiYgZmluYWxQYXlsb2FkLmxlbmd0aCkgewogICAgZmluYWxQYXlsb2FkID0gZ2V0VW5pcVBheWxvYWQoZmluYWxQYXlsb2FkLmZpbHRlcigoZW50cnkpID0+IGVudHJ5LnZhbHVlICE9IG51bGwgJiYgKGVudHJ5LmhpZGUgIT09IHRydWUgfHwgcHJvcHMuaW5jbHVkZUhpZGRlbikpLCBwYXlsb2FkVW5pcUJ5LCBkZWZhdWx0VW5pcUJ5KTsKICB9CiAgdmFyIGhhc1BheWxvYWQgPSBmaW5hbFBheWxvYWQubGVuZ3RoID4gMDsKICB2YXIgdG9vbHRpcEVsZW1lbnQgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QxMi5jcmVhdGVFbGVtZW50KFRvb2x0aXBCb3VuZGluZ0JveCwgewogICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25FYXNpbmcsCiAgICBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgIGFjdGl2ZTogZmluYWxJc0FjdGl2ZSwKICAgIGNvb3JkaW5hdGUsCiAgICBoYXNQYXlsb2FkLAogICAgb2Zmc2V0LAogICAgcG9zaXRpb24sCiAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgdXNlVHJhbnNsYXRlM2QsCiAgICB2aWV3Qm94LAogICAgd3JhcHBlclN0eWxlLAogICAgbGFzdEJvdW5kaW5nQm94LAogICAgaW5uZXJSZWY6IHVwZGF0ZUJvdW5kaW5nQm94LAogICAgaGFzUG9ydGFsRnJvbVByb3BzOiBCb29sZWFuKHBvcnRhbEZyb21Qcm9wcykKICB9LCByZW5kZXJDb250ZW50KGNvbnRlbnQsIF9vYmplY3RTcHJlYWQyMShfb2JqZWN0U3ByZWFkMjEoe30sIHByb3BzKSwge30sIHsKICAgIHBheWxvYWQ6IGZpbmFsUGF5bG9hZCwKICAgIGxhYmVsOiBmaW5hbExhYmVsLAogICAgYWN0aXZlOiBmaW5hbElzQWN0aXZlLAogICAgYWN0aXZlSW5kZXgsCiAgICBjb29yZGluYXRlLAogICAgYWNjZXNzaWJpbGl0eUxheWVyCiAgfSkpKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTIuY3JlYXRlRWxlbWVudChSZWFjdDEyLkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdF9kb20yLmNyZWF0ZVBvcnRhbCkodG9vbHRpcEVsZW1lbnQsIHRvb2x0aXBQb3J0YWwpLCBmaW5hbElzQWN0aXZlICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEyLmNyZWF0ZUVsZW1lbnQoQ3Vyc29yLCB7CiAgICBjdXJzb3IsCiAgICB0b29sdGlwRXZlbnRUeXBlLAogICAgY29vcmRpbmF0ZSwKICAgIHBheWxvYWQ6IGZpbmFsUGF5bG9hZCwKICAgIGluZGV4OiBhY3RpdmVJbmRleAogIH0pKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVGV4dC5qcwp2YXIgUmVhY3QxMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDI1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0xSVUNhY2hlLmpzCmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTIyKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjIocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjIodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjIodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjIodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBMUlVDYWNoZSA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihtYXhTaXplKSB7CiAgICBfZGVmaW5lUHJvcGVydHkyMih0aGlzLCAiY2FjaGUiLCAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpKTsKICAgIHRoaXMubWF4U2l6ZSA9IG1heFNpemU7CiAgfQogIGdldChrZXkpIHsKICAgIHZhciB2YWx1ZSA9IHRoaXMuY2FjaGUuZ2V0KGtleSk7CiAgICBpZiAodmFsdWUgIT09IHZvaWQgMCkgewogICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpOwogICAgICB0aGlzLmNhY2hlLnNldChrZXksIHZhbHVlKTsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKICB9CiAgc2V0KGtleSwgdmFsdWUpIHsKICAgIGlmICh0aGlzLmNhY2hlLmhhcyhrZXkpKSB7CiAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKGtleSk7CiAgICB9IGVsc2UgaWYgKHRoaXMuY2FjaGUuc2l6ZSA+PSB0aGlzLm1heFNpemUpIHsKICAgICAgdmFyIGZpcnN0S2V5ID0gdGhpcy5jYWNoZS5rZXlzKCkubmV4dCgpLnZhbHVlOwogICAgICBpZiAoZmlyc3RLZXkgIT0gbnVsbCkgewogICAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKGZpcnN0S2V5KTsKICAgICAgfQogICAgfQogICAgdGhpcy5jYWNoZS5zZXQoa2V5LCB2YWx1ZSk7CiAgfQogIGNsZWFyKCkgewogICAgdGhpcy5jYWNoZS5jbGVhcigpOwogIH0KICBzaXplKCkgewogICAgcmV0dXJuIHRoaXMuY2FjaGUuc2l6ZTsKICB9Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvRE9NVXRpbHMuanMKZnVuY3Rpb24gb3duS2V5czIyKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjIoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyMihPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjMoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjIoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTIzKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjMocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjModCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjModCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjModCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBkZWZhdWx0Q29uZmlnID0gewogIGNhY2hlU2l6ZTogMmUzLAogIGVuYWJsZUNhY2hlOiB0cnVlCn07CnZhciBjdXJyZW50Q29uZmlnID0gX29iamVjdFNwcmVhZDIyKHt9LCBkZWZhdWx0Q29uZmlnKTsKdmFyIHN0cmluZ0NhY2hlID0gbmV3IExSVUNhY2hlKGN1cnJlbnRDb25maWcuY2FjaGVTaXplKTsKdmFyIFNQQU5fU1RZTEUgPSB7CiAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgdG9wOiAiLTIwMDAwcHgiLAogIGxlZnQ6IDAsCiAgcGFkZGluZzogMCwKICBtYXJnaW46IDAsCiAgYm9yZGVyOiAibm9uZSIsCiAgd2hpdGVTcGFjZTogInByZSIKfTsKdmFyIE1FQVNVUkVNRU5UX1NQQU5fSUQgPSAicmVjaGFydHNfbWVhc3VyZW1lbnRfc3BhbiI7CmZ1bmN0aW9uIGNyZWF0ZUNhY2hlS2V5KHRleHQsIHN0eWxlKSB7CiAgdmFyIGZvbnRTaXplID0gc3R5bGUuZm9udFNpemUgfHwgIiI7CiAgdmFyIGZvbnRGYW1pbHkgPSBzdHlsZS5mb250RmFtaWx5IHx8ICIiOwogIHZhciBmb250V2VpZ2h0ID0gc3R5bGUuZm9udFdlaWdodCB8fCAiIjsKICB2YXIgZm9udFN0eWxlID0gc3R5bGUuZm9udFN0eWxlIHx8ICIiOwogIHZhciBsZXR0ZXJTcGFjaW5nID0gc3R5bGUubGV0dGVyU3BhY2luZyB8fCAiIjsKICB2YXIgdGV4dFRyYW5zZm9ybSA9IHN0eWxlLnRleHRUcmFuc2Zvcm0gfHwgIiI7CiAgcmV0dXJuICIiLmNvbmNhdCh0ZXh0LCAifCIpLmNvbmNhdChmb250U2l6ZSwgInwiKS5jb25jYXQoZm9udEZhbWlseSwgInwiKS5jb25jYXQoZm9udFdlaWdodCwgInwiKS5jb25jYXQoZm9udFN0eWxlLCAifCIpLmNvbmNhdChsZXR0ZXJTcGFjaW5nLCAifCIpLmNvbmNhdCh0ZXh0VHJhbnNmb3JtKTsKfQp2YXIgbWVhc3VyZVRleHRXaXRoRE9NID0gKHRleHQsIHN0eWxlKSA9PiB7CiAgdHJ5IHsKICAgIHZhciBtZWFzdXJlbWVudFNwYW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChNRUFTVVJFTUVOVF9TUEFOX0lEKTsKICAgIGlmICghbWVhc3VyZW1lbnRTcGFuKSB7CiAgICAgIG1lYXN1cmVtZW50U3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgICAgbWVhc3VyZW1lbnRTcGFuLnNldEF0dHJpYnV0ZSgiaWQiLCBNRUFTVVJFTUVOVF9TUEFOX0lEKTsKICAgICAgbWVhc3VyZW1lbnRTcGFuLnNldEF0dHJpYnV0ZSgiYXJpYS1oaWRkZW4iLCAidHJ1ZSIpOwogICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG1lYXN1cmVtZW50U3Bhbik7CiAgICB9CiAgICBPYmplY3QuYXNzaWduKG1lYXN1cmVtZW50U3Bhbi5zdHlsZSwgU1BBTl9TVFlMRSwgc3R5bGUpOwogICAgbWVhc3VyZW1lbnRTcGFuLnRleHRDb250ZW50ID0gIiIuY29uY2F0KHRleHQpOwogICAgdmFyIHJlY3QgPSBtZWFzdXJlbWVudFNwYW4uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICByZXR1cm4gewogICAgICB3aWR0aDogcmVjdC53aWR0aCwKICAgICAgaGVpZ2h0OiByZWN0LmhlaWdodAogICAgfTsKICB9IGNhdGNoIChfdW51c2VkKSB7CiAgICByZXR1cm4gewogICAgICB3aWR0aDogMCwKICAgICAgaGVpZ2h0OiAwCiAgICB9OwogIH0KfTsKdmFyIGdldFN0cmluZ1NpemUgPSBmdW5jdGlvbiBnZXRTdHJpbmdTaXplMih0ZXh0KSB7CiAgdmFyIHN0eWxlID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiB7fTsKICBpZiAodGV4dCA9PT0gdm9pZCAwIHx8IHRleHQgPT09IG51bGwgfHwgR2xvYmFsLmlzU3NyKSB7CiAgICByZXR1cm4gewogICAgICB3aWR0aDogMCwKICAgICAgaGVpZ2h0OiAwCiAgICB9OwogIH0KICBpZiAoIWN1cnJlbnRDb25maWcuZW5hYmxlQ2FjaGUpIHsKICAgIHJldHVybiBtZWFzdXJlVGV4dFdpdGhET00odGV4dCwgc3R5bGUpOwogIH0KICB2YXIgY2FjaGVLZXkgPSBjcmVhdGVDYWNoZUtleSh0ZXh0LCBzdHlsZSk7CiAgdmFyIGNhY2hlZFJlc3VsdCA9IHN0cmluZ0NhY2hlLmdldChjYWNoZUtleSk7CiAgaWYgKGNhY2hlZFJlc3VsdCkgewogICAgcmV0dXJuIGNhY2hlZFJlc3VsdDsKICB9CiAgdmFyIHJlc3VsdCA9IG1lYXN1cmVUZXh0V2l0aERPTSh0ZXh0LCBzdHlsZSk7CiAgc3RyaW5nQ2FjaGUuc2V0KGNhY2hlS2V5LCByZXN1bHQpOwogIHJldHVybiByZXN1bHQ7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvUmVkdWNlQ1NTQ2FsYy5qcwp2YXIgTVVMVElQTFlfT1JfRElWSURFX1JFR0VYID0gLygtP1xkKyg/OlwuXGQrKT9bYS16QS1aJV0qKShbKi9dKSgtP1xkKyg/OlwuXGQrKT9bYS16QS1aJV0qKS87CnZhciBBRERfT1JfU1VCVFJBQ1RfUkVHRVggPSAvKC0/XGQrKD86XC5cZCspP1thLXpBLVolXSopKFsrLV0pKC0/XGQrKD86XC5cZCspP1thLXpBLVolXSopLzsKdmFyIENTU19MRU5HVEhfVU5JVF9SRUdFWCA9IC9ecHh8Y218dmh8dnd8ZW18cmVtfCV8bW18aW58cHR8cGN8ZXh8Y2h8dm1pbnx2bWF4fFEkLzsKdmFyIE5VTV9TUExJVF9SRUdFWCA9IC8oLT9cZCsoPzpcLlxkKyk/KShbYS16QS1aJV0rKT8vOwp2YXIgQ09OVkVSU0lPTl9SQVRFUyA9IHsKICBjbTogOTYgLyAyLjU0LAogIG1tOiA5NiAvIDI1LjQsCiAgcHQ6IDk2IC8gNzIsCiAgcGM6IDk2IC8gNiwKICBpbjogOTYsCiAgUTogOTYgLyAoMi41NCAqIDQwKSwKICBweDogMQp9Owp2YXIgRklYRURfQ1NTX0xFTkdUSF9VTklUUyA9IE9iamVjdC5rZXlzKENPTlZFUlNJT05fUkFURVMpOwp2YXIgU1RSX05BTiA9ICJOYU4iOwpmdW5jdGlvbiBjb252ZXJ0VG9QeCh2YWx1ZSwgdW5pdDIpIHsKICByZXR1cm4gdmFsdWUgKiBDT05WRVJTSU9OX1JBVEVTW3VuaXQyXTsKfQp2YXIgRGVjaW1hbENTUyA9IGNsYXNzIF9EZWNpbWFsQ1NTIHsKICBzdGF0aWMgcGFyc2Uoc3RyKSB7CiAgICB2YXIgX05VTV9TUExJVF9SRUdFWCRleGVjOwogICAgdmFyIFssIG51bVN0ciwgdW5pdDJdID0gKF9OVU1fU1BMSVRfUkVHRVgkZXhlYyA9IE5VTV9TUExJVF9SRUdFWC5leGVjKHN0cikpICE9PSBudWxsICYmIF9OVU1fU1BMSVRfUkVHRVgkZXhlYyAhPT0gdm9pZCAwID8gX05VTV9TUExJVF9SRUdFWCRleGVjIDogW107CiAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKHBhcnNlRmxvYXQobnVtU3RyKSwgdW5pdDIgIT09IG51bGwgJiYgdW5pdDIgIT09IHZvaWQgMCA/IHVuaXQyIDogIiIpOwogIH0KICBjb25zdHJ1Y3RvcihudW0sIHVuaXQyKSB7CiAgICB0aGlzLm51bSA9IG51bTsKICAgIHRoaXMudW5pdCA9IHVuaXQyOwogICAgdGhpcy5udW0gPSBudW07CiAgICB0aGlzLnVuaXQgPSB1bml0MjsKICAgIGlmIChpc05hbihudW0pKSB7CiAgICAgIHRoaXMudW5pdCA9ICIiOwogICAgfQogICAgaWYgKHVuaXQyICE9PSAiIiAmJiAhQ1NTX0xFTkdUSF9VTklUX1JFR0VYLnRlc3QodW5pdDIpKSB7CiAgICAgIHRoaXMubnVtID0gTmFOOwogICAgICB0aGlzLnVuaXQgPSAiIjsKICAgIH0KICAgIGlmIChGSVhFRF9DU1NfTEVOR1RIX1VOSVRTLmluY2x1ZGVzKHVuaXQyKSkgewogICAgICB0aGlzLm51bSA9IGNvbnZlcnRUb1B4KG51bSwgdW5pdDIpOwogICAgICB0aGlzLnVuaXQgPSAicHgiOwogICAgfQogIH0KICBhZGQob3RoZXIpIHsKICAgIGlmICh0aGlzLnVuaXQgIT09IG90aGVyLnVuaXQpIHsKICAgICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyhOYU4sICIiKTsKICAgIH0KICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1ModGhpcy5udW0gKyBvdGhlci5udW0sIHRoaXMudW5pdCk7CiAgfQogIHN1YnRyYWN0KG90aGVyKSB7CiAgICBpZiAodGhpcy51bml0ICE9PSBvdGhlci51bml0KSB7CiAgICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1MoTmFOLCAiIik7CiAgICB9CiAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKHRoaXMubnVtIC0gb3RoZXIubnVtLCB0aGlzLnVuaXQpOwogIH0KICBtdWx0aXBseShvdGhlcikgewogICAgaWYgKHRoaXMudW5pdCAhPT0gIiIgJiYgb3RoZXIudW5pdCAhPT0gIiIgJiYgdGhpcy51bml0ICE9PSBvdGhlci51bml0KSB7CiAgICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1MoTmFOLCAiIik7CiAgICB9CiAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKHRoaXMubnVtICogb3RoZXIubnVtLCB0aGlzLnVuaXQgfHwgb3RoZXIudW5pdCk7CiAgfQogIGRpdmlkZShvdGhlcikgewogICAgaWYgKHRoaXMudW5pdCAhPT0gIiIgJiYgb3RoZXIudW5pdCAhPT0gIiIgJiYgdGhpcy51bml0ICE9PSBvdGhlci51bml0KSB7CiAgICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1MoTmFOLCAiIik7CiAgICB9CiAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKHRoaXMubnVtIC8gb3RoZXIubnVtLCB0aGlzLnVuaXQgfHwgb3RoZXIudW5pdCk7CiAgfQogIHRvU3RyaW5nKCkgewogICAgcmV0dXJuICIiLmNvbmNhdCh0aGlzLm51bSkuY29uY2F0KHRoaXMudW5pdCk7CiAgfQogIGlzTmFOKCkgewogICAgcmV0dXJuIGlzTmFuKHRoaXMubnVtKTsKICB9Cn07CmZ1bmN0aW9uIGNhbGN1bGF0ZUFyaXRobWV0aWMoZXhwcikgewogIGlmIChleHByLmluY2x1ZGVzKFNUUl9OQU4pKSB7CiAgICByZXR1cm4gU1RSX05BTjsKICB9CiAgdmFyIG5ld0V4cHIgPSBleHByOwogIHdoaWxlIChuZXdFeHByLmluY2x1ZGVzKCIqIikgfHwgbmV3RXhwci5pbmNsdWRlcygiLyIpKSB7CiAgICB2YXIgX01VTFRJUExZX09SX0RJVklERV9SOwogICAgdmFyIFssIGxlZnRPcGVyYW5kLCBvcGVyYXRvciwgcmlnaHRPcGVyYW5kXSA9IChfTVVMVElQTFlfT1JfRElWSURFX1IgPSBNVUxUSVBMWV9PUl9ESVZJREVfUkVHRVguZXhlYyhuZXdFeHByKSkgIT09IG51bGwgJiYgX01VTFRJUExZX09SX0RJVklERV9SICE9PSB2b2lkIDAgPyBfTVVMVElQTFlfT1JfRElWSURFX1IgOiBbXTsKICAgIHZhciBsVHMgPSBEZWNpbWFsQ1NTLnBhcnNlKGxlZnRPcGVyYW5kICE9PSBudWxsICYmIGxlZnRPcGVyYW5kICE9PSB2b2lkIDAgPyBsZWZ0T3BlcmFuZCA6ICIiKTsKICAgIHZhciByVHMgPSBEZWNpbWFsQ1NTLnBhcnNlKHJpZ2h0T3BlcmFuZCAhPT0gbnVsbCAmJiByaWdodE9wZXJhbmQgIT09IHZvaWQgMCA/IHJpZ2h0T3BlcmFuZCA6ICIiKTsKICAgIHZhciByZXN1bHQgPSBvcGVyYXRvciA9PT0gIioiID8gbFRzLm11bHRpcGx5KHJUcykgOiBsVHMuZGl2aWRlKHJUcyk7CiAgICBpZiAocmVzdWx0LmlzTmFOKCkpIHsKICAgICAgcmV0dXJuIFNUUl9OQU47CiAgICB9CiAgICBuZXdFeHByID0gbmV3RXhwci5yZXBsYWNlKE1VTFRJUExZX09SX0RJVklERV9SRUdFWCwgcmVzdWx0LnRvU3RyaW5nKCkpOwogIH0KICB3aGlsZSAobmV3RXhwci5pbmNsdWRlcygiKyIpIHx8IC8uLVxkKyg/OlwuXGQrKT8vLnRlc3QobmV3RXhwcikpIHsKICAgIHZhciBfQUREX09SX1NVQlRSQUNUX1JFR0U7CiAgICB2YXIgWywgX2xlZnRPcGVyYW5kLCBfb3BlcmF0b3IsIF9yaWdodE9wZXJhbmRdID0gKF9BRERfT1JfU1VCVFJBQ1RfUkVHRSA9IEFERF9PUl9TVUJUUkFDVF9SRUdFWC5leGVjKG5ld0V4cHIpKSAhPT0gbnVsbCAmJiBfQUREX09SX1NVQlRSQUNUX1JFR0UgIT09IHZvaWQgMCA/IF9BRERfT1JfU1VCVFJBQ1RfUkVHRSA6IFtdOwogICAgdmFyIF9sVHMgPSBEZWNpbWFsQ1NTLnBhcnNlKF9sZWZ0T3BlcmFuZCAhPT0gbnVsbCAmJiBfbGVmdE9wZXJhbmQgIT09IHZvaWQgMCA/IF9sZWZ0T3BlcmFuZCA6ICIiKTsKICAgIHZhciBfclRzID0gRGVjaW1hbENTUy5wYXJzZShfcmlnaHRPcGVyYW5kICE9PSBudWxsICYmIF9yaWdodE9wZXJhbmQgIT09IHZvaWQgMCA/IF9yaWdodE9wZXJhbmQgOiAiIik7CiAgICB2YXIgX3Jlc3VsdCA9IF9vcGVyYXRvciA9PT0gIisiID8gX2xUcy5hZGQoX3JUcykgOiBfbFRzLnN1YnRyYWN0KF9yVHMpOwogICAgaWYgKF9yZXN1bHQuaXNOYU4oKSkgewogICAgICByZXR1cm4gU1RSX05BTjsKICAgIH0KICAgIG5ld0V4cHIgPSBuZXdFeHByLnJlcGxhY2UoQUREX09SX1NVQlRSQUNUX1JFR0VYLCBfcmVzdWx0LnRvU3RyaW5nKCkpOwogIH0KICByZXR1cm4gbmV3RXhwcjsKfQp2YXIgUEFSRU5USEVTRVNfUkVHRVggPSAvXCgoW14oKV0qKVwpLzsKZnVuY3Rpb24gY2FsY3VsYXRlUGFyZW50aGVzZXMoZXhwcikgewogIHZhciBuZXdFeHByID0gZXhwcjsKICB2YXIgbWF0Y2g7CiAgd2hpbGUgKChtYXRjaCA9IFBBUkVOVEhFU0VTX1JFR0VYLmV4ZWMobmV3RXhwcikpICE9IG51bGwpIHsKICAgIHZhciBbLCBwYXJlbnRoZXRpY2FsRXhwcmVzc2lvbl0gPSBtYXRjaDsKICAgIG5ld0V4cHIgPSBuZXdFeHByLnJlcGxhY2UoUEFSRU5USEVTRVNfUkVHRVgsIGNhbGN1bGF0ZUFyaXRobWV0aWMocGFyZW50aGV0aWNhbEV4cHJlc3Npb24pKTsKICB9CiAgcmV0dXJuIG5ld0V4cHI7Cn0KZnVuY3Rpb24gZXZhbHVhdGVFeHByZXNzaW9uKGV4cHJlc3Npb24pIHsKICB2YXIgbmV3RXhwciA9IGV4cHJlc3Npb24ucmVwbGFjZSgvXHMrL2csICIiKTsKICBuZXdFeHByID0gY2FsY3VsYXRlUGFyZW50aGVzZXMobmV3RXhwcik7CiAgbmV3RXhwciA9IGNhbGN1bGF0ZUFyaXRobWV0aWMobmV3RXhwcik7CiAgcmV0dXJuIG5ld0V4cHI7Cn0KZnVuY3Rpb24gc2FmZUV2YWx1YXRlRXhwcmVzc2lvbihleHByZXNzaW9uKSB7CiAgdHJ5IHsKICAgIHJldHVybiBldmFsdWF0ZUV4cHJlc3Npb24oZXhwcmVzc2lvbik7CiAgfSBjYXRjaCAoX3VudXNlZCkgewogICAgcmV0dXJuIFNUUl9OQU47CiAgfQp9CmZ1bmN0aW9uIHJlZHVjZUNTU0NhbGMoZXhwcmVzc2lvbikgewogIHZhciByZXN1bHQgPSBzYWZlRXZhbHVhdGVFeHByZXNzaW9uKGV4cHJlc3Npb24uc2xpY2UoNSwgLTEpKTsKICBpZiAocmVzdWx0ID09PSBTVFJfTkFOKSB7CiAgICByZXR1cm4gIiI7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1RleHQuanMKdmFyIF9leGNsdWRlZDYgPSBbIngiLCAieSIsICJsaW5lSGVpZ2h0IiwgImNhcEhlaWdodCIsICJmaWxsIiwgInNjYWxlVG9GaXQiLCAidGV4dEFuY2hvciIsICJ2ZXJ0aWNhbEFuY2hvciJdOwp2YXIgX2V4Y2x1ZGVkMjMgPSBbImR4IiwgImR5IiwgImFuZ2xlIiwgImNsYXNzTmFtZSIsICJicmVha0FsbCJdOwpmdW5jdGlvbiBfZXh0ZW5kczEwKCkgewogIHJldHVybiBfZXh0ZW5kczEwID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxMC5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczYoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTYoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTYocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBCUkVBS0lOR19TUEFDRVMgPSAvWyBcZlxuXHJcdFx2XHUyMDI4XHUyMDI5XSsvOwp2YXIgY2FsY3VsYXRlV29yZFdpZHRocyA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBjaGlsZHJlbiwKICAgIGJyZWFrQWxsLAogICAgc3R5bGUKICB9ID0gX3JlZjI7CiAgdHJ5IHsKICAgIHZhciB3b3JkcyA9IFtdOwogICAgaWYgKCFpc051bGxpc2goY2hpbGRyZW4pKSB7CiAgICAgIGlmIChicmVha0FsbCkgewogICAgICAgIHdvcmRzID0gY2hpbGRyZW4udG9TdHJpbmcoKS5zcGxpdCgiIik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd29yZHMgPSBjaGlsZHJlbi50b1N0cmluZygpLnNwbGl0KEJSRUFLSU5HX1NQQUNFUyk7CiAgICAgIH0KICAgIH0KICAgIHZhciB3b3Jkc1dpdGhDb21wdXRlZFdpZHRoID0gd29yZHMubWFwKCh3b3JkKSA9PiAoewogICAgICB3b3JkLAogICAgICB3aWR0aDogZ2V0U3RyaW5nU2l6ZSh3b3JkLCBzdHlsZSkud2lkdGgKICAgIH0pKTsKICAgIHZhciBzcGFjZVdpZHRoID0gYnJlYWtBbGwgPyAwIDogZ2V0U3RyaW5nU2l6ZSgiXHhBMCIsIHN0eWxlKS53aWR0aDsKICAgIHJldHVybiB7CiAgICAgIHdvcmRzV2l0aENvbXB1dGVkV2lkdGgsCiAgICAgIHNwYWNlV2lkdGgKICAgIH07CiAgfSBjYXRjaCAoX3VudXNlZCkgewogICAgcmV0dXJuIG51bGw7CiAgfQp9OwpmdW5jdGlvbiBpc1ZhbGlkVGV4dEFuY2hvcih2YWx1ZSkgewogIHJldHVybiB2YWx1ZSA9PT0gInN0YXJ0IiB8fCB2YWx1ZSA9PT0gIm1pZGRsZSIgfHwgdmFsdWUgPT09ICJlbmQiIHx8IHZhbHVlID09PSAiaW5oZXJpdCI7Cn0KdmFyIGNhbGN1bGF0ZSA9ICh3b3JkcywgbGluZVdpZHRoLCBzcGFjZVdpZHRoLCBzY2FsZVRvRml0KSA9PiB3b3Jkcy5yZWR1Y2UoKHJlc3VsdCwgX3JlZjIpID0+IHsKICB2YXIgewogICAgd29yZCwKICAgIHdpZHRoCiAgfSA9IF9yZWYyOwogIHZhciBjdXJyZW50TGluZSA9IHJlc3VsdFtyZXN1bHQubGVuZ3RoIC0gMV07CiAgaWYgKGN1cnJlbnRMaW5lICYmIHdpZHRoICE9IG51bGwgJiYgKGxpbmVXaWR0aCA9PSBudWxsIHx8IHNjYWxlVG9GaXQgfHwgY3VycmVudExpbmUud2lkdGggKyB3aWR0aCArIHNwYWNlV2lkdGggPCBOdW1iZXIobGluZVdpZHRoKSkpIHsKICAgIGN1cnJlbnRMaW5lLndvcmRzLnB1c2god29yZCk7CiAgICBjdXJyZW50TGluZS53aWR0aCArPSB3aWR0aCArIHNwYWNlV2lkdGg7CiAgfSBlbHNlIHsKICAgIHZhciBuZXdMaW5lID0gewogICAgICB3b3JkczogW3dvcmRdLAogICAgICB3aWR0aAogICAgfTsKICAgIHJlc3VsdC5wdXNoKG5ld0xpbmUpOwogIH0KICByZXR1cm4gcmVzdWx0Owp9LCBbXSk7CnZhciBmaW5kTG9uZ2VzdExpbmUgPSAod29yZHMpID0+IHdvcmRzLnJlZHVjZSgoYSwgYikgPT4gYS53aWR0aCA+IGIud2lkdGggPyBhIDogYik7CnZhciBzdWZmaXggPSAiXHUyMDI2IjsKdmFyIGNoZWNrT3ZlcmZsb3cgPSAodGV4dCwgaW5kZXgsIGJyZWFrQWxsLCBzdHlsZSwgbWF4TGluZXMsIGxpbmVXaWR0aCwgc3BhY2VXaWR0aCwgc2NhbGVUb0ZpdCkgPT4gewogIHZhciB0ZW1wVGV4dCA9IHRleHQuc2xpY2UoMCwgaW5kZXgpOwogIHZhciB3b3JkcyA9IGNhbGN1bGF0ZVdvcmRXaWR0aHMoewogICAgYnJlYWtBbGwsCiAgICBzdHlsZSwKICAgIGNoaWxkcmVuOiB0ZW1wVGV4dCArIHN1ZmZpeAogIH0pOwogIGlmICghd29yZHMpIHsKICAgIHJldHVybiBbZmFsc2UsIFtdXTsKICB9CiAgdmFyIHJlc3VsdCA9IGNhbGN1bGF0ZSh3b3Jkcy53b3Jkc1dpdGhDb21wdXRlZFdpZHRoLCBsaW5lV2lkdGgsIHNwYWNlV2lkdGgsIHNjYWxlVG9GaXQpOwogIHZhciBkb2VzT3ZlcmZsb3cgPSByZXN1bHQubGVuZ3RoID4gbWF4TGluZXMgfHwgZmluZExvbmdlc3RMaW5lKHJlc3VsdCkud2lkdGggPiBOdW1iZXIobGluZVdpZHRoKTsKICByZXR1cm4gW2RvZXNPdmVyZmxvdywgcmVzdWx0XTsKfTsKdmFyIGNhbGN1bGF0ZVdvcmRzQnlMaW5lcyA9IChfcmVmMywgaW5pdGlhbFdvcmRzV2l0aENvbXB1dGVkV2l0aCwgc3BhY2VXaWR0aCwgbGluZVdpZHRoLCBzY2FsZVRvRml0KSA9PiB7CiAgdmFyIHsKICAgIG1heExpbmVzLAogICAgY2hpbGRyZW4sCiAgICBzdHlsZSwKICAgIGJyZWFrQWxsCiAgfSA9IF9yZWYzOwogIHZhciBzaG91bGRMaW1pdExpbmVzID0gaXNOdW1iZXIobWF4TGluZXMpOwogIHZhciB0ZXh0ID0gU3RyaW5nKGNoaWxkcmVuKTsKICB2YXIgb3JpZ2luYWxSZXN1bHQgPSBjYWxjdWxhdGUoaW5pdGlhbFdvcmRzV2l0aENvbXB1dGVkV2l0aCwgbGluZVdpZHRoLCBzcGFjZVdpZHRoLCBzY2FsZVRvRml0KTsKICBpZiAoIXNob3VsZExpbWl0TGluZXMgfHwgc2NhbGVUb0ZpdCkgewogICAgcmV0dXJuIG9yaWdpbmFsUmVzdWx0OwogIH0KICB2YXIgb3ZlcmZsb3dzID0gb3JpZ2luYWxSZXN1bHQubGVuZ3RoID4gbWF4TGluZXMgfHwgZmluZExvbmdlc3RMaW5lKG9yaWdpbmFsUmVzdWx0KS53aWR0aCA+IE51bWJlcihsaW5lV2lkdGgpOwogIGlmICghb3ZlcmZsb3dzKSB7CiAgICByZXR1cm4gb3JpZ2luYWxSZXN1bHQ7CiAgfQogIHZhciBzdGFydCA9IDA7CiAgdmFyIGVuZCA9IHRleHQubGVuZ3RoIC0gMTsKICB2YXIgaXRlcmF0aW9ucyA9IDA7CiAgdmFyIHRyaW1tZWRSZXN1bHQ7CiAgd2hpbGUgKHN0YXJ0IDw9IGVuZCAmJiBpdGVyYXRpb25zIDw9IHRleHQubGVuZ3RoIC0gMSkgewogICAgdmFyIG1pZGRsZSA9IE1hdGguZmxvb3IoKHN0YXJ0ICsgZW5kKSAvIDIpOwogICAgdmFyIHByZXYgPSBtaWRkbGUgLSAxOwogICAgdmFyIFtkb2VzUHJldk92ZXJmbG93LCByZXN1bHRdID0gY2hlY2tPdmVyZmxvdyh0ZXh0LCBwcmV2LCBicmVha0FsbCwgc3R5bGUsIG1heExpbmVzLCBsaW5lV2lkdGgsIHNwYWNlV2lkdGgsIHNjYWxlVG9GaXQpOwogICAgdmFyIFtkb2VzTWlkZGxlT3ZlcmZsb3ddID0gY2hlY2tPdmVyZmxvdyh0ZXh0LCBtaWRkbGUsIGJyZWFrQWxsLCBzdHlsZSwgbWF4TGluZXMsIGxpbmVXaWR0aCwgc3BhY2VXaWR0aCwgc2NhbGVUb0ZpdCk7CiAgICBpZiAoIWRvZXNQcmV2T3ZlcmZsb3cgJiYgIWRvZXNNaWRkbGVPdmVyZmxvdykgewogICAgICBzdGFydCA9IG1pZGRsZSArIDE7CiAgICB9CiAgICBpZiAoZG9lc1ByZXZPdmVyZmxvdyAmJiBkb2VzTWlkZGxlT3ZlcmZsb3cpIHsKICAgICAgZW5kID0gbWlkZGxlIC0gMTsKICAgIH0KICAgIGlmICghZG9lc1ByZXZPdmVyZmxvdyAmJiBkb2VzTWlkZGxlT3ZlcmZsb3cpIHsKICAgICAgdHJpbW1lZFJlc3VsdCA9IHJlc3VsdDsKICAgICAgYnJlYWs7CiAgICB9CiAgICBpdGVyYXRpb25zKys7CiAgfQogIHJldHVybiB0cmltbWVkUmVzdWx0IHx8IG9yaWdpbmFsUmVzdWx0Owp9Owp2YXIgZ2V0V29yZHNXaXRob3V0Q2FsY3VsYXRlID0gKGNoaWxkcmVuKSA9PiB7CiAgdmFyIHdvcmRzID0gIWlzTnVsbGlzaChjaGlsZHJlbikgPyBjaGlsZHJlbi50b1N0cmluZygpLnNwbGl0KEJSRUFLSU5HX1NQQUNFUykgOiBbXTsKICByZXR1cm4gW3sKICAgIHdvcmRzLAogICAgd2lkdGg6IHZvaWQgMAogIH1dOwp9Owp2YXIgZ2V0V29yZHNCeUxpbmVzID0gKF9yZWY0KSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgc2NhbGVUb0ZpdCwKICAgIGNoaWxkcmVuLAogICAgc3R5bGUsCiAgICBicmVha0FsbCwKICAgIG1heExpbmVzCiAgfSA9IF9yZWY0OwogIGlmICgod2lkdGggfHwgc2NhbGVUb0ZpdCkgJiYgIUdsb2JhbC5pc1NzcikgewogICAgdmFyIHdvcmRzV2l0aENvbXB1dGVkV2lkdGgsIHNwYWNlV2lkdGg7CiAgICB2YXIgd29yZFdpZHRocyA9IGNhbGN1bGF0ZVdvcmRXaWR0aHMoewogICAgICBicmVha0FsbCwKICAgICAgY2hpbGRyZW4sCiAgICAgIHN0eWxlCiAgICB9KTsKICAgIGlmICh3b3JkV2lkdGhzKSB7CiAgICAgIHZhciB7CiAgICAgICAgd29yZHNXaXRoQ29tcHV0ZWRXaWR0aDogd2N3LAogICAgICAgIHNwYWNlV2lkdGg6IHN3CiAgICAgIH0gPSB3b3JkV2lkdGhzOwogICAgICB3b3Jkc1dpdGhDb21wdXRlZFdpZHRoID0gd2N3OwogICAgICBzcGFjZVdpZHRoID0gc3c7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gZ2V0V29yZHNXaXRob3V0Q2FsY3VsYXRlKGNoaWxkcmVuKTsKICAgIH0KICAgIHJldHVybiBjYWxjdWxhdGVXb3Jkc0J5TGluZXMoewogICAgICBicmVha0FsbCwKICAgICAgY2hpbGRyZW4sCiAgICAgIG1heExpbmVzLAogICAgICBzdHlsZQogICAgfSwgd29yZHNXaXRoQ29tcHV0ZWRXaWR0aCwgc3BhY2VXaWR0aCwgd2lkdGgsIEJvb2xlYW4oc2NhbGVUb0ZpdCkpOwogIH0KICByZXR1cm4gZ2V0V29yZHNXaXRob3V0Q2FsY3VsYXRlKGNoaWxkcmVuKTsKfTsKdmFyIERFRkFVTFRfRklMTCA9ICIjODA4MDgwIjsKdmFyIHRleHREZWZhdWx0UHJvcHMgPSB7CiAgYW5nbGU6IDAsCiAgYnJlYWtBbGw6IGZhbHNlLAogIC8vIE1hZ2ljIG51bWJlciBmcm9tIGQzCiAgY2FwSGVpZ2h0OiAiMC43MWVtIiwKICBmaWxsOiBERUZBVUxUX0ZJTEwsCiAgbGluZUhlaWdodDogIjFlbSIsCiAgc2NhbGVUb0ZpdDogZmFsc2UsCiAgdGV4dEFuY2hvcjogInN0YXJ0IiwKICAvLyBNYWludGFpbiBjb21wYXQgd2l0aCBleGlzdGluZyBjaGFydHMgLyBkZWZhdWx0IFNWRyBiZWhhdmlvcgogIHZlcnRpY2FsQW5jaG9yOiAiZW5kIiwKICB4OiAwLAogIHk6IDAKfTsKdmFyIFRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI1LmZvcndhcmRSZWYpKChvdXRzaWRlUHJvcHMsIHJlZikgPT4gewogIHZhciBfcmVzb2x2ZURlZmF1bHRQcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCB0ZXh0RGVmYXVsdFByb3BzKSwgewogICAgeDogcHJvcHNYLAogICAgeTogcHJvcHNZLAogICAgbGluZUhlaWdodCwKICAgIGNhcEhlaWdodCwKICAgIGZpbGwsCiAgICBzY2FsZVRvRml0LAogICAgdGV4dEFuY2hvciwKICAgIHZlcnRpY2FsQW5jaG9yCiAgfSA9IF9yZXNvbHZlRGVmYXVsdFByb3BzLCBwcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczYoX3Jlc29sdmVEZWZhdWx0UHJvcHMsIF9leGNsdWRlZDYpOwogIHZhciB3b3Jkc0J5TGluZXMgPSAoMCwgaW1wb3J0X3JlYWN0MjUudXNlTWVtbykoKCkgPT4gewogICAgcmV0dXJuIGdldFdvcmRzQnlMaW5lcyh7CiAgICAgIGJyZWFrQWxsOiBwcm9wcy5icmVha0FsbCwKICAgICAgY2hpbGRyZW46IHByb3BzLmNoaWxkcmVuLAogICAgICBtYXhMaW5lczogcHJvcHMubWF4TGluZXMsCiAgICAgIHNjYWxlVG9GaXQsCiAgICAgIHN0eWxlOiBwcm9wcy5zdHlsZSwKICAgICAgd2lkdGg6IHByb3BzLndpZHRoCiAgICB9KTsKICB9LCBbcHJvcHMuYnJlYWtBbGwsIHByb3BzLmNoaWxkcmVuLCBwcm9wcy5tYXhMaW5lcywgc2NhbGVUb0ZpdCwgcHJvcHMuc3R5bGUsIHByb3BzLndpZHRoXSk7CiAgdmFyIHsKICAgIGR4LAogICAgZHksCiAgICBhbmdsZSwKICAgIGNsYXNzTmFtZSwKICAgIGJyZWFrQWxsCiAgfSA9IHByb3BzLCB0ZXh0UHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM2KHByb3BzLCBfZXhjbHVkZWQyMyk7CiAgaWYgKCFpc051bU9yU3RyKHByb3BzWCkgfHwgIWlzTnVtT3JTdHIocHJvcHNZKSB8fCB3b3Jkc0J5TGluZXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHgyID0gTnVtYmVyKHByb3BzWCkgKyAoaXNOdW1iZXIoZHgpID8gZHggOiAwKTsKICB2YXIgeTIgPSBOdW1iZXIocHJvcHNZKSArIChpc051bWJlcihkeSkgPyBkeSA6IDApOwogIGlmICghaXNXZWxsQmVoYXZlZE51bWJlcih4MikgfHwgIWlzV2VsbEJlaGF2ZWROdW1iZXIoeTIpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHN0YXJ0RHk7CiAgc3dpdGNoICh2ZXJ0aWNhbEFuY2hvcikgewogICAgY2FzZSAic3RhcnQiOgogICAgICBzdGFydER5ID0gcmVkdWNlQ1NTQ2FsYygiY2FsYygiLmNvbmNhdChjYXBIZWlnaHQsICIpIikpOwogICAgICBicmVhazsKICAgIGNhc2UgIm1pZGRsZSI6CiAgICAgIHN0YXJ0RHkgPSByZWR1Y2VDU1NDYWxjKCJjYWxjKCIuY29uY2F0KCh3b3Jkc0J5TGluZXMubGVuZ3RoIC0gMSkgLyAyLCAiICogLSIpLmNvbmNhdChsaW5lSGVpZ2h0LCAiICsgKCIpLmNvbmNhdChjYXBIZWlnaHQsICIgLyAyKSkiKSk7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgc3RhcnREeSA9IHJlZHVjZUNTU0NhbGMoImNhbGMoIi5jb25jYXQod29yZHNCeUxpbmVzLmxlbmd0aCAtIDEsICIgKiAtIikuY29uY2F0KGxpbmVIZWlnaHQsICIpIikpOwogICAgICBicmVhazsKICB9CiAgdmFyIHRyYW5zZm9ybXMgPSBbXTsKICBpZiAoc2NhbGVUb0ZpdCkgewogICAgdmFyIGxpbmVXaWR0aCA9IHdvcmRzQnlMaW5lc1swXS53aWR0aDsKICAgIHZhciB7CiAgICAgIHdpZHRoCiAgICB9ID0gcHJvcHM7CiAgICB0cmFuc2Zvcm1zLnB1c2goInNjYWxlKCIuY29uY2F0KGlzTnVtYmVyKHdpZHRoKSAmJiBpc051bWJlcihsaW5lV2lkdGgpID8gd2lkdGggLyBsaW5lV2lkdGggOiAxLCAiKSIpKTsKICB9CiAgaWYgKGFuZ2xlKSB7CiAgICB0cmFuc2Zvcm1zLnB1c2goInJvdGF0ZSgiLmNvbmNhdChhbmdsZSwgIiwgIikuY29uY2F0KHgyLCAiLCAiKS5jb25jYXQoeTIsICIpIikpOwogIH0KICBpZiAodHJhbnNmb3Jtcy5sZW5ndGgpIHsKICAgIHRleHRQcm9wcy50cmFuc2Zvcm0gPSB0cmFuc2Zvcm1zLmpvaW4oIiAiKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEzLmNyZWF0ZUVsZW1lbnQoInRleHQiLCBfZXh0ZW5kczEwKHt9LCBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHRleHRQcm9wcyksIHsKICAgIHJlZiwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLXRleHQiLCBjbGFzc05hbWUpLAogICAgdGV4dEFuY2hvciwKICAgIGZpbGw6IGZpbGwuaW5jbHVkZXMoInVybCIpID8gREVGQVVMVF9GSUxMIDogZmlsbAogIH0pLCB3b3Jkc0J5TGluZXMubWFwKChsaW5lLCBpbmRleCkgPT4gewogICAgdmFyIHdvcmRzID0gbGluZS53b3Jkcy5qb2luKGJyZWFrQWxsID8gIiIgOiAiICIpOwogICAgcmV0dXJuICgKICAgICAgLy8gZHVwbGljYXRlIHdvcmRzIHdpbGwgY2F1c2UgZHVwbGljYXRlIGtleXMgd2hpY2ggaXMgd2h5IHdlIGFkZCB0aGUgYXJyYXkgaW5kZXggaGVyZQogICAgICAvKiBAX19QVVJFX18gKi8gUmVhY3QxMy5jcmVhdGVFbGVtZW50KCJ0c3BhbiIsIHsKICAgICAgICB4OiB4MiwKICAgICAgICBkeTogaW5kZXggPT09IDAgPyBzdGFydER5IDogbGluZUhlaWdodCwKICAgICAgICBrZXk6ICIiLmNvbmNhdCh3b3JkcywgIi0iKS5jb25jYXQoaW5kZXgpCiAgICAgIH0sIHdvcmRzKQogICAgKTsKICB9KSk7Cn0pOwpUZXh0LmRpc3BsYXlOYW1lID0gIlRleHQiOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvTGFiZWwuanMKdmFyIFJlYWN0MTQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QyNiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIF9leGNsdWRlZDcgPSBbImxhYmVsUmVmIl07CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczcoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTcoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTcocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIG93bktleXMyMyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDIzKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjMoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI0KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czIzKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyNChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI0KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI0KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI0KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI0KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfZXh0ZW5kczExKCkgewogIHJldHVybiBfZXh0ZW5kczExID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxMS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciBDYXJ0ZXNpYW5MYWJlbENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmNyZWF0ZUNvbnRleHQpKG51bGwpOwp2YXIgQ2FydGVzaWFuTGFiZWxDb250ZXh0UHJvdmlkZXIgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHVwcGVyV2lkdGgsCiAgICBsb3dlcldpZHRoLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBjaGlsZHJlbgogIH0gPSBfcmVmMjsKICB2YXIgdmlld0JveCA9ICgwLCBpbXBvcnRfcmVhY3QyNi51c2VNZW1vKSgoKSA9PiAoewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHVwcGVyV2lkdGgsCiAgICBsb3dlcldpZHRoLAogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9KSwgW3gyLCB5MiwgdXBwZXJXaWR0aCwgbG93ZXJXaWR0aCwgd2lkdGgsIGhlaWdodF0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkxhYmVsQ29udGV4dC5Qcm92aWRlciwgewogICAgdmFsdWU6IHZpZXdCb3gKICB9LCBjaGlsZHJlbik7Cn07CnZhciB1c2VDYXJ0ZXNpYW5MYWJlbENvbnRleHQgPSAoKSA9PiB7CiAgdmFyIGxhYmVsQ2hpbGRDb250ZXh0ID0gKDAsIGltcG9ydF9yZWFjdDI2LnVzZUNvbnRleHQpKENhcnRlc2lhbkxhYmVsQ29udGV4dCk7CiAgdmFyIGNoYXJ0Q29udGV4dCA9IHVzZVZpZXdCb3goKTsKICByZXR1cm4gbGFiZWxDaGlsZENvbnRleHQgfHwgY2FydGVzaWFuVmlld0JveFRvVHJhcGV6b2lkKGNoYXJ0Q29udGV4dCk7Cn07CnZhciBQb2xhckxhYmVsQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuY3JlYXRlQ29udGV4dCkobnVsbCk7CnZhciB1c2VQb2xhckxhYmVsQ29udGV4dCA9ICgpID0+IHsKICB2YXIgbGFiZWxDaGlsZENvbnRleHQgPSAoMCwgaW1wb3J0X3JlYWN0MjYudXNlQ29udGV4dCkoUG9sYXJMYWJlbENvbnRleHQpOwogIHZhciBjaGFydENvbnRleHQgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RQb2xhclZpZXdCb3gpOwogIHJldHVybiBsYWJlbENoaWxkQ29udGV4dCB8fCBjaGFydENvbnRleHQ7Cn07CnZhciBnZXRMYWJlbCA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICB2YWx1ZSwKICAgIGZvcm1hdHRlcgogIH0gPSBwcm9wczsKICB2YXIgbGFiZWwgPSBpc051bGxpc2gocHJvcHMuY2hpbGRyZW4pID8gdmFsdWUgOiBwcm9wcy5jaGlsZHJlbjsKICBpZiAodHlwZW9mIGZvcm1hdHRlciA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIGZvcm1hdHRlcihsYWJlbCk7CiAgfQogIHJldHVybiBsYWJlbDsKfTsKdmFyIGlzTGFiZWxDb250ZW50QUZ1bmN0aW9uID0gKGNvbnRlbnQpID0+IHsKICByZXR1cm4gY29udGVudCAhPSBudWxsICYmIHR5cGVvZiBjb250ZW50ID09PSAiZnVuY3Rpb24iOwp9Owp2YXIgZ2V0RGVsdGFBbmdsZTIgPSAoc3RhcnRBbmdsZSwgZW5kQW5nbGUpID0+IHsKICB2YXIgc2lnbjIgPSBtYXRoU2lnbihlbmRBbmdsZSAtIHN0YXJ0QW5nbGUpOwogIHZhciBkZWx0YUFuZ2xlID0gTWF0aC5taW4oTWF0aC5hYnMoZW5kQW5nbGUgLSBzdGFydEFuZ2xlKSwgMzYwKTsKICByZXR1cm4gc2lnbjIgKiBkZWx0YUFuZ2xlOwp9Owp2YXIgcmVuZGVyUmFkaWFsTGFiZWwgPSAobGFiZWxQcm9wcywgcG9zaXRpb24sIGxhYmVsLCBhdHRycywgdmlld0JveCkgPT4gewogIHZhciB7CiAgICBvZmZzZXQsCiAgICBjbGFzc05hbWUKICB9ID0gbGFiZWxQcm9wczsKICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIGlubmVyUmFkaXVzLAogICAgb3V0ZXJSYWRpdXMsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUsCiAgICBjbG9ja1dpc2UKICB9ID0gdmlld0JveDsKICB2YXIgcmFkaXVzID0gKGlubmVyUmFkaXVzICsgb3V0ZXJSYWRpdXMpIC8gMjsKICB2YXIgZGVsdGFBbmdsZSA9IGdldERlbHRhQW5nbGUyKHN0YXJ0QW5nbGUsIGVuZEFuZ2xlKTsKICB2YXIgc2lnbjIgPSBkZWx0YUFuZ2xlID49IDAgPyAxIDogLTE7CiAgdmFyIGxhYmVsQW5nbGUsIGRpcmVjdGlvbjsKICBzd2l0Y2ggKHBvc2l0aW9uKSB7CiAgICBjYXNlICJpbnNpZGVTdGFydCI6CiAgICAgIGxhYmVsQW5nbGUgPSBzdGFydEFuZ2xlICsgc2lnbjIgKiBvZmZzZXQ7CiAgICAgIGRpcmVjdGlvbiA9IGNsb2NrV2lzZTsKICAgICAgYnJlYWs7CiAgICBjYXNlICJpbnNpZGVFbmQiOgogICAgICBsYWJlbEFuZ2xlID0gZW5kQW5nbGUgLSBzaWduMiAqIG9mZnNldDsKICAgICAgZGlyZWN0aW9uID0gIWNsb2NrV2lzZTsKICAgICAgYnJlYWs7CiAgICBjYXNlICJlbmQiOgogICAgICBsYWJlbEFuZ2xlID0gZW5kQW5nbGUgKyBzaWduMiAqIG9mZnNldDsKICAgICAgZGlyZWN0aW9uID0gY2xvY2tXaXNlOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5zdXBwb3J0ZWQgcG9zaXRpb24gIi5jb25jYXQocG9zaXRpb24pKTsKICB9CiAgZGlyZWN0aW9uID0gZGVsdGFBbmdsZSA8PSAwID8gZGlyZWN0aW9uIDogIWRpcmVjdGlvbjsKICB2YXIgc3RhcnRQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCByYWRpdXMsIGxhYmVsQW5nbGUpOwogIHZhciBlbmRQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCByYWRpdXMsIGxhYmVsQW5nbGUgKyAoZGlyZWN0aW9uID8gMSA6IC0xKSAqIDM1OSk7CiAgdmFyIHBhdGgyID0gIk0iLmNvbmNhdChzdGFydFBvaW50LngsICIsIikuY29uY2F0KHN0YXJ0UG9pbnQueSwgIlxuICAgIEEiKS5jb25jYXQocmFkaXVzLCAiLCIpLmNvbmNhdChyYWRpdXMsICIsMCwxLCIpLmNvbmNhdChkaXJlY3Rpb24gPyAwIDogMSwgIixcbiAgICAiKS5jb25jYXQoZW5kUG9pbnQueCwgIiwiKS5jb25jYXQoZW5kUG9pbnQueSk7CiAgdmFyIGlkID0gaXNOdWxsaXNoKGxhYmVsUHJvcHMuaWQpID8gdW5pcXVlSWQoInJlY2hhcnRzLXJhZGlhbC1saW5lLSIpIDogbGFiZWxQcm9wcy5pZDsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudCgidGV4dCIsIF9leHRlbmRzMTEoe30sIGF0dHJzLCB7CiAgICBkb21pbmFudEJhc2VsaW5lOiAiY2VudHJhbCIsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLXJhZGlhbC1iYXItbGFiZWwiLCBjbGFzc05hbWUpCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoImRlZnMiLCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KCJwYXRoIiwgewogICAgaWQsCiAgICBkOiBwYXRoMgogIH0pKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudCgidGV4dFBhdGgiLCB7CiAgICB4bGlua0hyZWY6ICIjIi5jb25jYXQoaWQpCiAgfSwgbGFiZWwpKTsKfTsKdmFyIGdldEF0dHJzT2ZQb2xhckxhYmVsID0gKHZpZXdCb3gsIG9mZnNldCwgcG9zaXRpb24pID0+IHsKICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIGlubmVyUmFkaXVzLAogICAgb3V0ZXJSYWRpdXMsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gdmlld0JveDsKICB2YXIgbWlkQW5nbGUgPSAoc3RhcnRBbmdsZSArIGVuZEFuZ2xlKSAvIDI7CiAgaWYgKHBvc2l0aW9uID09PSAib3V0c2lkZSIpIHsKICAgIHZhciB7CiAgICAgIHg6IF94LAogICAgICB5OiBfeQogICAgfSA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBvdXRlclJhZGl1cyArIG9mZnNldCwgbWlkQW5nbGUpOwogICAgcmV0dXJuIHsKICAgICAgeDogX3gsCiAgICAgIHk6IF95LAogICAgICB0ZXh0QW5jaG9yOiBfeCA+PSBjeCA/ICJzdGFydCIgOiAiZW5kIiwKICAgICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgICB9OwogIH0KICBpZiAocG9zaXRpb24gPT09ICJjZW50ZXIiKSB7CiAgICByZXR1cm4gewogICAgICB4OiBjeCwKICAgICAgeTogY3ksCiAgICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICAgIH07CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImNlbnRlclRvcCIpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IGN4LAogICAgICB5OiBjeSwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAic3RhcnQiCiAgICB9OwogIH0KICBpZiAocG9zaXRpb24gPT09ICJjZW50ZXJCb3R0b20iKSB7CiAgICByZXR1cm4gewogICAgICB4OiBjeCwKICAgICAgeTogY3ksCiAgICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogImVuZCIKICAgIH07CiAgfQogIHZhciByMiA9IChpbm5lclJhZGl1cyArIG91dGVyUmFkaXVzKSAvIDI7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIKICB9ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHIyLCBtaWRBbmdsZSk7CiAgcmV0dXJuIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogIH07Cn07CnZhciBpc1BvbGFyID0gKHZpZXdCb3gpID0+ICJjeCIgaW4gdmlld0JveCAmJiBpc051bWJlcih2aWV3Qm94LmN4KTsKdmFyIGdldEF0dHJzT2ZDYXJ0ZXNpYW5MYWJlbCA9IChwcm9wcywgdmlld0JveCkgPT4gewogIHZhciB7CiAgICBwYXJlbnRWaWV3Qm94OiBwYXJlbnRWaWV3Qm94RnJvbVByb3BzLAogICAgb2Zmc2V0LAogICAgcG9zaXRpb24KICB9ID0gcHJvcHM7CiAgdmFyIHBhcmVudFZpZXdCb3g7CiAgaWYgKHBhcmVudFZpZXdCb3hGcm9tUHJvcHMgIT0gbnVsbCAmJiAhaXNQb2xhcihwYXJlbnRWaWV3Qm94RnJvbVByb3BzKSkgewogICAgcGFyZW50Vmlld0JveCA9IHBhcmVudFZpZXdCb3hGcm9tUHJvcHM7CiAgfQogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgdXBwZXJXaWR0aCwKICAgIGxvd2VyV2lkdGgsCiAgICBoZWlnaHQKICB9ID0gdmlld0JveDsKICB2YXIgdXBwZXJYID0geDI7CiAgdmFyIGxvd2VyWCA9IHgyICsgKHVwcGVyV2lkdGggLSBsb3dlcldpZHRoKSAvIDI7CiAgdmFyIG1pZGRsZVggPSAodXBwZXJYICsgbG93ZXJYKSAvIDI7CiAgdmFyIG1pZEhlaWdodFdpZHRoID0gKHVwcGVyV2lkdGggKyBsb3dlcldpZHRoKSAvIDI7CiAgdmFyIGNlbnRlclggPSB1cHBlclggKyB1cHBlcldpZHRoIC8gMjsKICB2YXIgdmVydGljYWxTaWduID0gaGVpZ2h0ID49IDAgPyAxIDogLTE7CiAgdmFyIHZlcnRpY2FsT2Zmc2V0ID0gdmVydGljYWxTaWduICogb2Zmc2V0OwogIHZhciB2ZXJ0aWNhbEVuZCA9IHZlcnRpY2FsU2lnbiA+IDAgPyAiZW5kIiA6ICJzdGFydCI7CiAgdmFyIHZlcnRpY2FsU3RhcnQgPSB2ZXJ0aWNhbFNpZ24gPiAwID8gInN0YXJ0IiA6ICJlbmQiOwogIHZhciBob3Jpem9udGFsU2lnbiA9IHVwcGVyV2lkdGggPj0gMCA/IDEgOiAtMTsKICB2YXIgaG9yaXpvbnRhbE9mZnNldCA9IGhvcml6b250YWxTaWduICogb2Zmc2V0OwogIHZhciBob3Jpem9udGFsRW5kID0gaG9yaXpvbnRhbFNpZ24gPiAwID8gImVuZCIgOiAic3RhcnQiOwogIHZhciBob3Jpem9udGFsU3RhcnQgPSBob3Jpem9udGFsU2lnbiA+IDAgPyAic3RhcnQiIDogImVuZCI7CiAgaWYgKHBvc2l0aW9uID09PSAidG9wIikgewogICAgdmFyIGF0dHJzID0gewogICAgICB4OiB1cHBlclggKyB1cHBlcldpZHRoIC8gMiwKICAgICAgeTogeTIgLSB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbEVuZAogICAgfTsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoX29iamVjdFNwcmVhZDIzKHt9LCBhdHRycyksIHBhcmVudFZpZXdCb3ggPyB7CiAgICAgIGhlaWdodDogTWF0aC5tYXgoeTIgLSBwYXJlbnRWaWV3Qm94LnksIDApLAogICAgICB3aWR0aDogdXBwZXJXaWR0aAogICAgfSA6IHt9KTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiYm90dG9tIikgewogICAgdmFyIF9hdHRycyA9IHsKICAgICAgeDogbG93ZXJYICsgbG93ZXJXaWR0aCAvIDIsCiAgICAgIHk6IHkyICsgaGVpZ2h0ICsgdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxTdGFydAogICAgfTsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoX29iamVjdFNwcmVhZDIzKHt9LCBfYXR0cnMpLCBwYXJlbnRWaWV3Qm94ID8gewogICAgICBoZWlnaHQ6IE1hdGgubWF4KHBhcmVudFZpZXdCb3gueSArIHBhcmVudFZpZXdCb3guaGVpZ2h0IC0gKHkyICsgaGVpZ2h0KSwgMCksCiAgICAgIHdpZHRoOiBsb3dlcldpZHRoCiAgICB9IDoge30pOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJsZWZ0IikgewogICAgdmFyIF9hdHRyczIgPSB7CiAgICAgIHg6IG1pZGRsZVggLSBob3Jpem9udGFsT2Zmc2V0LAogICAgICB5OiB5MiArIGhlaWdodCAvIDIsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxFbmQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogICAgfTsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoX29iamVjdFNwcmVhZDIzKHt9LCBfYXR0cnMyKSwgcGFyZW50Vmlld0JveCA/IHsKICAgICAgd2lkdGg6IE1hdGgubWF4KF9hdHRyczIueCAtIHBhcmVudFZpZXdCb3gueCwgMCksCiAgICAgIGhlaWdodAogICAgfSA6IHt9KTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAicmlnaHQiKSB7CiAgICB2YXIgX2F0dHJzMyA9IHsKICAgICAgeDogbWlkZGxlWCArIG1pZEhlaWdodFdpZHRoICsgaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLyAyLAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsU3RhcnQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogICAgfTsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoX29iamVjdFNwcmVhZDIzKHt9LCBfYXR0cnMzKSwgcGFyZW50Vmlld0JveCA/IHsKICAgICAgd2lkdGg6IE1hdGgubWF4KHBhcmVudFZpZXdCb3gueCArIHBhcmVudFZpZXdCb3gud2lkdGggLSBfYXR0cnMzLngsIDApLAogICAgICBoZWlnaHQKICAgIH0gOiB7fSk7CiAgfQogIHZhciBzaXplQXR0cnMgPSBwYXJlbnRWaWV3Qm94ID8gewogICAgd2lkdGg6IG1pZEhlaWdodFdpZHRoLAogICAgaGVpZ2h0CiAgfSA6IHt9OwogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZUxlZnQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogbWlkZGxlWCArIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC8gMiwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbFN0YXJ0LAogICAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZVJpZ2h0IikgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IG1pZGRsZVggKyBtaWRIZWlnaHRXaWR0aCAtIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC8gMiwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbEVuZCwKICAgICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVUb3AiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogdXBwZXJYICsgdXBwZXJXaWR0aCAvIDIsCiAgICAgIHk6IHkyICsgdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxTdGFydAogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlQm90dG9tIikgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IGxvd2VyWCArIGxvd2VyV2lkdGggLyAyLAogICAgICB5OiB5MiArIGhlaWdodCAtIHZlcnRpY2FsT2Zmc2V0LAogICAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsRW5kCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVUb3BMZWZ0IikgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IHVwcGVyWCArIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxTdGFydCwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsU3RhcnQKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZVRvcFJpZ2h0IikgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IHVwcGVyWCArIHVwcGVyV2lkdGggLSBob3Jpem9udGFsT2Zmc2V0LAogICAgICB5OiB5MiArIHZlcnRpY2FsT2Zmc2V0LAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsRW5kLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxTdGFydAogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlQm90dG9tTGVmdCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiBsb3dlclggKyBob3Jpem9udGFsT2Zmc2V0LAogICAgICB5OiB5MiArIGhlaWdodCAtIHZlcnRpY2FsT2Zmc2V0LAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsU3RhcnQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbEVuZAogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlQm90dG9tUmlnaHQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogbG93ZXJYICsgbG93ZXJXaWR0aCAtIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC0gdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxFbmQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbEVuZAogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKCEhcG9zaXRpb24gJiYgdHlwZW9mIHBvc2l0aW9uID09PSAib2JqZWN0IiAmJiAoaXNOdW1iZXIocG9zaXRpb24ueCkgfHwgaXNQZXJjZW50KHBvc2l0aW9uLngpKSAmJiAoaXNOdW1iZXIocG9zaXRpb24ueSkgfHwgaXNQZXJjZW50KHBvc2l0aW9uLnkpKSkgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IHgyICsgZ2V0UGVyY2VudFZhbHVlKHBvc2l0aW9uLngsIG1pZEhlaWdodFdpZHRoKSwKICAgICAgeTogeTIgKyBnZXRQZXJjZW50VmFsdWUocG9zaXRpb24ueSwgaGVpZ2h0KSwKICAgICAgdGV4dEFuY2hvcjogImVuZCIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAiZW5kIgogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICB4OiBjZW50ZXJYLAogICAgeTogeTIgKyBoZWlnaHQgLyAyLAogICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICB9LCBzaXplQXR0cnMpOwp9Owp2YXIgZGVmYXVsdExhYmVsUHJvcHMgPSB7CiAgYW5nbGU6IDAsCiAgb2Zmc2V0OiA1LAogIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmxhYmVsLAogIHBvc2l0aW9uOiAibWlkZGxlIiwKICB0ZXh0QnJlYWtBbGw6IGZhbHNlCn07CmZ1bmN0aW9uIExhYmVsKG91dGVyUHJvcHMpIHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dGVyUHJvcHMsIGRlZmF1bHRMYWJlbFByb3BzKTsKICB2YXIgewogICAgdmlld0JveDogdmlld0JveEZyb21Qcm9wcywKICAgIHBvc2l0aW9uLAogICAgdmFsdWUsCiAgICBjaGlsZHJlbiwKICAgIGNvbnRlbnQsCiAgICBjbGFzc05hbWUgPSAiIiwKICAgIHRleHRCcmVha0FsbCwKICAgIGxhYmVsUmVmCiAgfSA9IHByb3BzOwogIHZhciBwb2xhclZpZXdCb3ggPSB1c2VQb2xhckxhYmVsQ29udGV4dCgpOwogIHZhciBjYXJ0ZXNpYW5WaWV3Qm94ID0gdXNlQ2FydGVzaWFuTGFiZWxDb250ZXh0KCk7CiAgdmFyIHJlc29sdmVkVmlld0JveCA9IHBvc2l0aW9uID09PSAiY2VudGVyIiA/IGNhcnRlc2lhblZpZXdCb3ggOiBwb2xhclZpZXdCb3ggIT09IG51bGwgJiYgcG9sYXJWaWV3Qm94ICE9PSB2b2lkIDAgPyBwb2xhclZpZXdCb3ggOiBjYXJ0ZXNpYW5WaWV3Qm94OwogIHZhciB2aWV3Qm94LCBsYWJlbCwgcG9zaXRpb25BdHRyczsKICBpZiAodmlld0JveEZyb21Qcm9wcyA9PSBudWxsKSB7CiAgICB2aWV3Qm94ID0gcmVzb2x2ZWRWaWV3Qm94OwogIH0gZWxzZSBpZiAoaXNQb2xhcih2aWV3Qm94RnJvbVByb3BzKSkgewogICAgdmlld0JveCA9IHZpZXdCb3hGcm9tUHJvcHM7CiAgfSBlbHNlIHsKICAgIHZpZXdCb3ggPSBjYXJ0ZXNpYW5WaWV3Qm94VG9UcmFwZXpvaWQodmlld0JveEZyb21Qcm9wcyk7CiAgfQogIGlmICghdmlld0JveCB8fCBpc051bGxpc2godmFsdWUpICYmIGlzTnVsbGlzaChjaGlsZHJlbikgJiYgIS8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuaXNWYWxpZEVsZW1lbnQpKGNvbnRlbnQpICYmIHR5cGVvZiBjb250ZW50ICE9PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHByb3BzV2l0aFZpZXdCb3ggPSBfb2JqZWN0U3ByZWFkMjMoX29iamVjdFNwcmVhZDIzKHt9LCBwcm9wcyksIHt9LCB7CiAgICB2aWV3Qm94CiAgfSk7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuaXNWYWxpZEVsZW1lbnQpKGNvbnRlbnQpKSB7CiAgICB2YXIgewogICAgICBsYWJlbFJlZjogXwogICAgfSA9IHByb3BzV2l0aFZpZXdCb3gsIHByb3BzV2l0aG91dExhYmVsUmVmID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNyhwcm9wc1dpdGhWaWV3Qm94LCBfZXhjbHVkZWQ3KTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmNsb25lRWxlbWVudCkoY29udGVudCwgcHJvcHNXaXRob3V0TGFiZWxSZWYpOwogIH0KICBpZiAodHlwZW9mIGNvbnRlbnQgPT09ICJmdW5jdGlvbiIpIHsKICAgIGxhYmVsID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5jcmVhdGVFbGVtZW50KShjb250ZW50LCBwcm9wc1dpdGhWaWV3Qm94KTsKICAgIGlmICgvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmlzVmFsaWRFbGVtZW50KShsYWJlbCkpIHsKICAgICAgcmV0dXJuIGxhYmVsOwogICAgfQogIH0gZWxzZSB7CiAgICBsYWJlbCA9IGdldExhYmVsKHByb3BzKTsKICB9CiAgdmFyIGF0dHJzID0gc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhwcm9wcyk7CiAgaWYgKGlzUG9sYXIodmlld0JveCkpIHsKICAgIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZVN0YXJ0IiB8fCBwb3NpdGlvbiA9PT0gImluc2lkZUVuZCIgfHwgcG9zaXRpb24gPT09ICJlbmQiKSB7CiAgICAgIHJldHVybiByZW5kZXJSYWRpYWxMYWJlbChwcm9wcywgcG9zaXRpb24sIGxhYmVsLCBhdHRycywgdmlld0JveCk7CiAgICB9CiAgICBwb3NpdGlvbkF0dHJzID0gZ2V0QXR0cnNPZlBvbGFyTGFiZWwodmlld0JveCwgcHJvcHMub2Zmc2V0LCBwcm9wcy5wb3NpdGlvbik7CiAgfSBlbHNlIHsKICAgIHBvc2l0aW9uQXR0cnMgPSBnZXRBdHRyc09mQ2FydGVzaWFuTGFiZWwocHJvcHMsIHZpZXdCb3gpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4OiBwcm9wcy56SW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KFRleHQsIF9leHRlbmRzMTEoewogICAgcmVmOiBsYWJlbFJlZiwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtbGFiZWwiLCBjbGFzc05hbWUpCiAgfSwgYXR0cnMsIHBvc2l0aW9uQXR0cnMsIHsKICAgIC8qCiAgICAgKiB0ZXh0QW5jaG9yIGlzIGRlY2lkZWQgYnkgZGVmYXVsdCBiYXNlZCBvbiB0aGUgYHBvc2l0aW9uYAogICAgICogYnV0IHdlIGFsbG93IG92ZXJyaWRpbmcgdmlhIHByb3BzIGZvciBwcmVjaXNlIGNvbnRyb2wuCiAgICAgKi8KICAgIHRleHRBbmNob3I6IGlzVmFsaWRUZXh0QW5jaG9yKGF0dHJzLnRleHRBbmNob3IpID8gYXR0cnMudGV4dEFuY2hvciA6IHBvc2l0aW9uQXR0cnMudGV4dEFuY2hvciwKICAgIGJyZWFrQWxsOiB0ZXh0QnJlYWtBbGwKICB9KSwgbGFiZWwpKTsKfQpMYWJlbC5kaXNwbGF5TmFtZSA9ICJMYWJlbCI7CnZhciBwYXJzZUxhYmVsID0gKGxhYmVsLCB2aWV3Qm94LCBsYWJlbFJlZikgPT4gewogIGlmICghbGFiZWwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgY29tbW9uUHJvcHMgPSB7CiAgICB2aWV3Qm94LAogICAgbGFiZWxSZWYKICB9OwogIGlmIChsYWJlbCA9PT0gdHJ1ZSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoTGFiZWwsIF9leHRlbmRzMTEoewogICAgICBrZXk6ICJsYWJlbC1pbXBsaWNpdCIKICAgIH0sIGNvbW1vblByb3BzKSk7CiAgfQogIGlmIChpc051bU9yU3RyKGxhYmVsKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoTGFiZWwsIF9leHRlbmRzMTEoewogICAgICBrZXk6ICJsYWJlbC1pbXBsaWNpdCIsCiAgICAgIHZhbHVlOiBsYWJlbAogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuaXNWYWxpZEVsZW1lbnQpKGxhYmVsKSkgewogICAgaWYgKGxhYmVsLnR5cGUgPT09IExhYmVsKSB7CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmNsb25lRWxlbWVudCkobGFiZWwsIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgICAga2V5OiAibGFiZWwtaW1wbGljaXQiCiAgICAgIH0sIGNvbW1vblByb3BzKSk7CiAgICB9CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudChMYWJlbCwgX2V4dGVuZHMxMSh7CiAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IiwKICAgICAgY29udGVudDogbGFiZWwKICAgIH0sIGNvbW1vblByb3BzKSk7CiAgfQogIGlmIChpc0xhYmVsQ29udGVudEFGdW5jdGlvbihsYWJlbCkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KExhYmVsLCBfZXh0ZW5kczExKHsKICAgICAga2V5OiAibGFiZWwtaW1wbGljaXQiLAogICAgICBjb250ZW50OiBsYWJlbAogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgaWYgKGxhYmVsICYmIHR5cGVvZiBsYWJlbCA9PT0gIm9iamVjdCIpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KExhYmVsLCBfZXh0ZW5kczExKHt9LCBsYWJlbCwgewogICAgICBrZXk6ICJsYWJlbC1pbXBsaWNpdCIKICAgIH0sIGNvbW1vblByb3BzKSk7CiAgfQogIHJldHVybiBudWxsOwp9OwpmdW5jdGlvbiBDYXJ0ZXNpYW5MYWJlbEZyb21MYWJlbFByb3AoX3JlZjMpIHsKICB2YXIgewogICAgbGFiZWwsCiAgICBsYWJlbFJlZgogIH0gPSBfcmVmMzsKICB2YXIgdmlld0JveCA9IHVzZUNhcnRlc2lhbkxhYmVsQ29udGV4dCgpOwogIHJldHVybiBwYXJzZUxhYmVsKGxhYmVsLCB2aWV3Qm94LCBsYWJlbFJlZikgfHwgbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvTGFiZWxMaXN0LmpzCnZhciBSZWFjdDE1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MjcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfbGFzdCA9IF9fdG9FU00ocmVxdWlyZV9sYXN0MygpKTsKdmFyIF9leGNsdWRlZDggPSBbInZhbHVlQWNjZXNzb3IiXTsKdmFyIF9leGNsdWRlZDI0ID0gWyJkYXRhS2V5IiwgImNsb2NrV2lzZSIsICJpZCIsICJ0ZXh0QnJlYWtBbGwiLCAiekluZGV4Il07CmZ1bmN0aW9uIF9leHRlbmRzMTIoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTIgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczEyLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzOChlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlOChlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlOChyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIGRlZmF1bHRBY2Nlc3NvciA9IChlbnRyeSkgPT4gQXJyYXkuaXNBcnJheShlbnRyeS52YWx1ZSkgPyAoMCwgaW1wb3J0X2xhc3QuZGVmYXVsdCkoZW50cnkudmFsdWUpIDogZW50cnkudmFsdWU7CnZhciBDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNy5jcmVhdGVDb250ZXh0KSh2b2lkIDApOwp2YXIgQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dFByb3ZpZGVyID0gQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dC5Qcm92aWRlcjsKdmFyIFBvbGFyTGFiZWxMaXN0Q29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjcuY3JlYXRlQ29udGV4dCkodm9pZCAwKTsKdmFyIFBvbGFyTGFiZWxMaXN0Q29udGV4dFByb3ZpZGVyID0gUG9sYXJMYWJlbExpc3RDb250ZXh0LlByb3ZpZGVyOwpmdW5jdGlvbiB1c2VDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0KCkgewogIHJldHVybiAoMCwgaW1wb3J0X3JlYWN0MjcudXNlQ29udGV4dCkoQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dCk7Cn0KZnVuY3Rpb24gdXNlUG9sYXJMYWJlbExpc3RDb250ZXh0KCkgewogIHJldHVybiAoMCwgaW1wb3J0X3JlYWN0MjcudXNlQ29udGV4dCkoUG9sYXJMYWJlbExpc3RDb250ZXh0KTsKfQpmdW5jdGlvbiBMYWJlbExpc3QoX3JlZjIpIHsKICB2YXIgewogICAgdmFsdWVBY2Nlc3NvciA9IGRlZmF1bHRBY2Nlc3NvcgogIH0gPSBfcmVmMiwgcmVzdFByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzOChfcmVmMiwgX2V4Y2x1ZGVkOCk7CiAgdmFyIHsKICAgIGRhdGFLZXksCiAgICBjbG9ja1dpc2UsCiAgICBpZCwKICAgIHRleHRCcmVha0FsbCwKICAgIHpJbmRleAogIH0gPSByZXN0UHJvcHMsIG90aGVycyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczgocmVzdFByb3BzLCBfZXhjbHVkZWQyNCk7CiAgdmFyIGNhcnRlc2lhbkRhdGEgPSB1c2VDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0KCk7CiAgdmFyIHBvbGFyRGF0YSA9IHVzZVBvbGFyTGFiZWxMaXN0Q29udGV4dCgpOwogIHZhciBkYXRhID0gY2FydGVzaWFuRGF0YSB8fCBwb2xhckRhdGE7CiAgaWYgKCFkYXRhIHx8ICFkYXRhLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IHpJbmRleCAhPT0gbnVsbCAmJiB6SW5kZXggIT09IHZvaWQgMCA/IHpJbmRleCA6IERlZmF1bHRaSW5kZXhlcy5sYWJlbAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWxhYmVsLWxpc3QiCiAgfSwgZGF0YS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gewogICAgdmFyIF9yZXN0UHJvcHMkZmlsbDsKICAgIHZhciB2YWx1ZSA9IGlzTnVsbGlzaChkYXRhS2V5KSA/IHZhbHVlQWNjZXNzb3IoZW50cnksIGluZGV4KSA6IGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5ICYmIGVudHJ5LnBheWxvYWQsIGRhdGFLZXkpOwogICAgdmFyIGlkUHJvcHMgPSBpc051bGxpc2goaWQpID8ge30gOiB7CiAgICAgIGlkOiAiIi5jb25jYXQoaWQsICItIikuY29uY2F0KGluZGV4KQogICAgfTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KExhYmVsLCBfZXh0ZW5kczEyKHsKICAgICAga2V5OiAibGFiZWwtIi5jb25jYXQoaW5kZXgpCiAgICB9LCBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKGVudHJ5KSwgb3RoZXJzLCBpZFByb3BzLCB7CiAgICAgIC8qCiAgICAgICAqIFByZWZlciB0byB1c2UgdGhlIGV4cGxpY2l0IGZpbGwgZnJvbSBMYWJlbExpc3QgcHJvcHMuCiAgICAgICAqIE9ubHkgaW4gYW4gYWJzZW5jZSBvZiB0aGF0LCBmYWxsIGJhY2sgdG8gdGhlIGZpbGwgb2YgdGhlIGVudHJ5LgogICAgICAgKiBUaGUgZW50cnkgZmlsbCBjYW4gYmUgcXVpdGUgZGlmZmljdWx0IHRvIHNlZSBlc3BlY2lhbGx5IGluIEJhciwgUGllLCBSYWRpYWxCYXIgaW4gaW5zaWRlIHBvc2l0aW9ucy4KICAgICAgICogT24gdGhlIG90aGVyIGhhbmQgaXQncyBxdWl0ZSBjb252ZW5pZW50IGluIFNjYXR0ZXIsIExpbmUsIG9yIHdoZW4gdGhlIHBvc2l0aW9uIGlzIG91dHNpZGUgdGhlIEJhciwgUGllIGZpbGxlZCBzaGFwZXMuCiAgICAgICAqLwogICAgICBmaWxsOiAoX3Jlc3RQcm9wcyRmaWxsID0gcmVzdFByb3BzLmZpbGwpICE9PSBudWxsICYmIF9yZXN0UHJvcHMkZmlsbCAhPT0gdm9pZCAwID8gX3Jlc3RQcm9wcyRmaWxsIDogZW50cnkuZmlsbCwKICAgICAgcGFyZW50Vmlld0JveDogZW50cnkucGFyZW50Vmlld0JveCwKICAgICAgdmFsdWUsCiAgICAgIHRleHRCcmVha0FsbCwKICAgICAgdmlld0JveDogZW50cnkudmlld0JveCwKICAgICAgaW5kZXgsCiAgICAgIHpJbmRleDogMAogICAgfSkpOwogIH0pKSk7Cn0KTGFiZWxMaXN0LmRpc3BsYXlOYW1lID0gIkxhYmVsTGlzdCI7CmZ1bmN0aW9uIExhYmVsTGlzdEZyb21MYWJlbFByb3AoX3JlZjIpIHsKICB2YXIgewogICAgbGFiZWwKICB9ID0gX3JlZjI7CiAgaWYgKCFsYWJlbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmIChsYWJlbCA9PT0gdHJ1ZSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoTGFiZWxMaXN0LCB7CiAgICAgIGtleTogImxhYmVsTGlzdC1pbXBsaWNpdCIKICAgIH0pOwogIH0KICBpZiAoLyogQF9fUFVSRV9fICovIFJlYWN0MTUuaXNWYWxpZEVsZW1lbnQobGFiZWwpIHx8IGlzTGFiZWxDb250ZW50QUZ1bmN0aW9uKGxhYmVsKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmNyZWF0ZUVsZW1lbnQoTGFiZWxMaXN0LCB7CiAgICAgIGtleTogImxhYmVsTGlzdC1pbXBsaWNpdCIsCiAgICAgIGNvbnRlbnQ6IGxhYmVsCiAgICB9KTsKICB9CiAgaWYgKHR5cGVvZiBsYWJlbCA9PT0gIm9iamVjdCIpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KExhYmVsTGlzdCwgX2V4dGVuZHMxMih7CiAgICAgIGtleTogImxhYmVsTGlzdC1pbXBsaWNpdCIKICAgIH0sIGxhYmVsLCB7CiAgICAgIHR5cGU6IFN0cmluZyhsYWJlbC50eXBlKQogICAgfSkpOwogIH0KICByZXR1cm4gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zaGFwZS9Eb3QuanMKdmFyIFJlYWN0MTYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIF9leHRlbmRzMTMoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTMgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczEzLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KdmFyIERvdCA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgcjogcjIsCiAgICBjbGFzc05hbWUKICB9ID0gcHJvcHM7CiAgdmFyIGxheWVyQ2xhc3MgPSBjbHN4KCJyZWNoYXJ0cy1kb3QiLCBjbGFzc05hbWUpOwogIGlmIChpc051bWJlcihjeCkgJiYgaXNOdW1iZXIoY3kpICYmIGlzTnVtYmVyKHIyKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE2LmNyZWF0ZUVsZW1lbnQoImNpcmNsZSIsIF9leHRlbmRzMTMoe30sIHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhwcm9wcyksIGFkYXB0RXZlbnRIYW5kbGVycyhwcm9wcyksIHsKICAgICAgY2xhc3NOYW1lOiBsYXllckNsYXNzLAogICAgICBjeCwKICAgICAgY3ksCiAgICAgIHI6IHIyCiAgICB9KSk7CiAgfQogIHJldHVybiBudWxsOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9wb2xhckF4aXNTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlNiA9IHsKICByYWRpdXNBeGlzOiB7fSwKICBhbmdsZUF4aXM6IHt9Cn07CnZhciBwb2xhckF4aXNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAicG9sYXJBeGlzIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTYsCiAgcmVkdWNlcnM6IHsKICAgIGFkZFJhZGl1c0F4aXMoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5yYWRpdXNBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXSA9IGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCk7CiAgICB9LAogICAgcmVtb3ZlUmFkaXVzQXhpcyhzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIGRlbGV0ZSBzdGF0ZS5yYWRpdXNBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXTsKICAgIH0sCiAgICBhZGRBbmdsZUF4aXMoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5hbmdsZUF4aXNbYWN0aW9uLnBheWxvYWQuaWRdID0gY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKTsKICAgIH0sCiAgICByZW1vdmVBbmdsZUF4aXMoc3RhdGUsIGFjdGlvbikgewogICAgICBkZWxldGUgc3RhdGUuYW5nbGVBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXTsKICAgIH0KICB9Cn0pOwp2YXIgewogIGFkZFJhZGl1c0F4aXMsCiAgcmVtb3ZlUmFkaXVzQXhpcywKICBhZGRBbmdsZUF4aXMsCiAgcmVtb3ZlQW5nbGVBeGlzCn0gPSBwb2xhckF4aXNTbGljZS5hY3Rpb25zOwp2YXIgcG9sYXJBeGlzUmVkdWNlciA9IHBvbGFyQXhpc1NsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvUmVhY3RVdGlscy5qcwp2YXIgaW1wb3J0X3JlYWN0MjggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpc0NsaXBEb3QgPSAoZG90KSA9PiB7CiAgaWYgKGRvdCAmJiB0eXBlb2YgZG90ID09PSAib2JqZWN0IiAmJiAiY2xpcERvdCIgaW4gZG90KSB7CiAgICByZXR1cm4gQm9vbGVhbihkb3QuY2xpcERvdCk7CiAgfQogIHJldHVybiB0cnVlOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9TZXRUb29sdGlwRW50cnlTZXR0aW5ncy5qcwp2YXIgaW1wb3J0X3JlYWN0MjkgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIFNldFRvb2x0aXBFbnRyeVNldHRpbmdzKF9yZWYyKSB7CiAgdmFyIHsKICAgIHRvb2x0aXBFbnRyeVNldHRpbmdzCiAgfSA9IF9yZWYyOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHByZXZTZXR0aW5nc1JlZiA9ICgwLCBpbXBvcnRfcmVhY3QyOS51c2VSZWYpKG51bGwpOwogICgwLCBpbXBvcnRfcmVhY3QyOS51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIGlmIChpc1Bhbm9yYW1hKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCA9PT0gbnVsbCkgewogICAgICBkaXNwYXRjaChhZGRUb29sdGlwRW50cnlTZXR0aW5ncyh0b29sdGlwRW50cnlTZXR0aW5ncykpOwogICAgfSBlbHNlIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCAhPT0gdG9vbHRpcEVudHJ5U2V0dGluZ3MpIHsKICAgICAgZGlzcGF0Y2gocmVwbGFjZVRvb2x0aXBFbnRyeVNldHRpbmdzKHsKICAgICAgICBwcmV2OiBwcmV2U2V0dGluZ3NSZWYuY3VycmVudCwKICAgICAgICBuZXh0OiB0b29sdGlwRW50cnlTZXR0aW5ncwogICAgICB9KSk7CiAgICB9CiAgICBwcmV2U2V0dGluZ3NSZWYuY3VycmVudCA9IHRvb2x0aXBFbnRyeVNldHRpbmdzOwogIH0sIFt0b29sdGlwRW50cnlTZXR0aW5ncywgZGlzcGF0Y2gsIGlzUGFub3JhbWFdKTsKICAoMCwgaW1wb3J0X3JlYWN0MjkudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQpIHsKICAgICAgICBkaXNwYXRjaChyZW1vdmVUb29sdGlwRW50cnlTZXR0aW5ncyhwcmV2U2V0dGluZ3NSZWYuY3VycmVudCkpOwogICAgICAgIHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID0gbnVsbDsKICAgICAgfQogICAgfTsKICB9LCBbZGlzcGF0Y2hdKTsKICByZXR1cm4gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9TZXRMZWdlbmRQYXlsb2FkLmpzCnZhciBpbXBvcnRfcmVhY3QzMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gU2V0TGVnZW5kUGF5bG9hZChfcmVmMikgewogIHZhciB7CiAgICBsZWdlbmRQYXlsb2FkCiAgfSA9IF9yZWYyOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHByZXZQYXlsb2FkUmVmID0gKDAsIGltcG9ydF9yZWFjdDMwLnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDMwLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKGlzUGFub3JhbWEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHByZXZQYXlsb2FkUmVmLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgZGlzcGF0Y2goYWRkTGVnZW5kUGF5bG9hZChsZWdlbmRQYXlsb2FkKSk7CiAgICB9IGVsc2UgaWYgKHByZXZQYXlsb2FkUmVmLmN1cnJlbnQgIT09IGxlZ2VuZFBheWxvYWQpIHsKICAgICAgZGlzcGF0Y2gocmVwbGFjZUxlZ2VuZFBheWxvYWQoewogICAgICAgIHByZXY6IHByZXZQYXlsb2FkUmVmLmN1cnJlbnQsCiAgICAgICAgbmV4dDogbGVnZW5kUGF5bG9hZAogICAgICB9KSk7CiAgICB9CiAgICBwcmV2UGF5bG9hZFJlZi5jdXJyZW50ID0gbGVnZW5kUGF5bG9hZDsKICB9LCBbZGlzcGF0Y2gsIGlzUGFub3JhbWEsIGxlZ2VuZFBheWxvYWRdKTsKICAoMCwgaW1wb3J0X3JlYWN0MzAudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAocHJldlBheWxvYWRSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZUxlZ2VuZFBheWxvYWQocHJldlBheWxvYWRSZWYuY3VycmVudCkpOwogICAgICAgIHByZXZQYXlsb2FkUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0sIFtkaXNwYXRjaF0pOwogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvUmVnaXN0ZXJHcmFwaGljYWxJdGVtSWQuanMKdmFyIFJlYWN0MTggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QzMSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VJZC5qcwp2YXIgUmVhY3QxNyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIF9yZWY7CnZhciB1c2VJZEZhbGxiYWNrID0gKCkgPT4gewogIHZhciBbaWRdID0gUmVhY3QxNy51c2VTdGF0ZSgoKSA9PiB1bmlxdWVJZCgidWlkLSIpKTsKICByZXR1cm4gaWQ7Cn07CnZhciB1c2VJZCA9IChfcmVmID0gUmVhY3QxN1sidXNlSWQiLnRvU3RyaW5nKCldKSAhPT0gbnVsbCAmJiBfcmVmICE9PSB2b2lkIDAgPyBfcmVmIDogdXNlSWRGYWxsYmFjazsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VVbmlxdWVJZC5qcwpmdW5jdGlvbiB1c2VVbmlxdWVJZChwcmVmaXgsIGN1c3RvbUlkKSB7CiAgdmFyIGdlbmVyYXRlZElkID0gdXNlSWQoKTsKICBpZiAoY3VzdG9tSWQpIHsKICAgIHJldHVybiBjdXN0b21JZDsKICB9CiAgcmV0dXJuIHByZWZpeCA/ICIiLmNvbmNhdChwcmVmaXgsICItIikuY29uY2F0KGdlbmVyYXRlZElkKSA6IGdlbmVyYXRlZElkOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvUmVnaXN0ZXJHcmFwaGljYWxJdGVtSWQuanMKdmFyIEdyYXBoaWNhbEl0ZW1JZENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDMxLmNyZWF0ZUNvbnRleHQpKHZvaWQgMCk7CnZhciBSZWdpc3RlckdyYXBoaWNhbEl0ZW1JZCA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBpZCwKICAgIHR5cGUsCiAgICBjaGlsZHJlbgogIH0gPSBfcmVmMjsKICB2YXIgcmVzb2x2ZWRJZCA9IHVzZVVuaXF1ZUlkKCJyZWNoYXJ0cy0iLmNvbmNhdCh0eXBlKSwgaWQpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxOC5jcmVhdGVFbGVtZW50KEdyYXBoaWNhbEl0ZW1JZENvbnRleHQuUHJvdmlkZXIsIHsKICAgIHZhbHVlOiByZXNvbHZlZElkCiAgfSwgY2hpbGRyZW4ocmVzb2x2ZWRJZCkpOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9TZXRHcmFwaGljYWxJdGVtLmpzCnZhciBpbXBvcnRfcmVhY3QzMiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvZ3JhcGhpY2FsSXRlbXNTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlNyA9IHsKICBjYXJ0ZXNpYW5JdGVtczogW10sCiAgcG9sYXJJdGVtczogW10KfTsKdmFyIGdyYXBoaWNhbEl0ZW1zU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImdyYXBoaWNhbEl0ZW1zIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTcsCiAgcmVkdWNlcnM6IHsKICAgIGFkZENhcnRlc2lhbkdyYXBoaWNhbEl0ZW06IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUuY2FydGVzaWFuSXRlbXMucHVzaChjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZXBsYWNlQ2FydGVzaWFuR3JhcGhpY2FsSXRlbTogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgewogICAgICAgICAgcHJldiwKICAgICAgICAgIG5leHQKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkuY2FydGVzaWFuSXRlbXMuaW5kZXhPZihjYXN0RHJhZnQocHJldikpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS5jYXJ0ZXNpYW5JdGVtc1tpbmRleF0gPSBjYXN0RHJhZnQobmV4dCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW06IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkuY2FydGVzaWFuSXRlbXMuaW5kZXhPZihjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgc3RhdGUuY2FydGVzaWFuSXRlbXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgYWRkUG9sYXJHcmFwaGljYWxJdGVtOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLnBvbGFySXRlbXMucHVzaChjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVQb2xhckdyYXBoaWNhbEl0ZW06IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkucG9sYXJJdGVtcy5pbmRleE9mKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS5wb2xhckl0ZW1zLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkQ2FydGVzaWFuR3JhcGhpY2FsSXRlbSwKICByZXBsYWNlQ2FydGVzaWFuR3JhcGhpY2FsSXRlbSwKICByZW1vdmVDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtLAogIGFkZFBvbGFyR3JhcGhpY2FsSXRlbSwKICByZW1vdmVQb2xhckdyYXBoaWNhbEl0ZW0KfSA9IGdyYXBoaWNhbEl0ZW1zU2xpY2UuYWN0aW9uczsKdmFyIGdyYXBoaWNhbEl0ZW1zUmVkdWNlciA9IGdyYXBoaWNhbEl0ZW1zU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvU2V0R3JhcGhpY2FsSXRlbS5qcwp2YXIgU2V0Q2FydGVzaWFuR3JhcGhpY2FsSXRlbUltcGwgPSAocHJvcHMpID0+IHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBwcmV2UHJvcHNSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MzIudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0MzIudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocHJldlByb3BzUmVmLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgZGlzcGF0Y2goYWRkQ2FydGVzaWFuR3JhcGhpY2FsSXRlbShwcm9wcykpOwogICAgfSBlbHNlIGlmIChwcmV2UHJvcHNSZWYuY3VycmVudCAhPT0gcHJvcHMpIHsKICAgICAgZGlzcGF0Y2gocmVwbGFjZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW0oewogICAgICAgIHByZXY6IHByZXZQcm9wc1JlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IHByb3BzCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZQcm9wc1JlZi5jdXJyZW50ID0gcHJvcHM7CiAgfSwgW2Rpc3BhdGNoLCBwcm9wc10pOwogICgwLCBpbXBvcnRfcmVhY3QzMi51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2UHJvcHNSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW0ocHJldlByb3BzUmVmLmN1cnJlbnQpKTsKICAgICAgICBwcmV2UHJvcHNSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn07CnZhciBTZXRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzMi5tZW1vKShTZXRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtSW1wbCk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9Eb3RzLmpzCnZhciBSZWFjdDE5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MzMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQ5ID0gWyJwb2ludHMiXTsKZnVuY3Rpb24gb3duS2V5czI0KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjQoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyNChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjUoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjQoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTI1KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjUocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjUodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjUodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjUodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9leHRlbmRzMTQoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTQgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczE0LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzOShlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlOShlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlOShyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gRG90SXRlbShfcmVmMikgewogIHZhciB7CiAgICBvcHRpb24sCiAgICBkb3RQcm9wcywKICAgIGNsYXNzTmFtZQogIH0gPSBfcmVmMjsKICBpZiAoLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzMy5pc1ZhbGlkRWxlbWVudCkob3B0aW9uKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzMuY2xvbmVFbGVtZW50KShvcHRpb24sIGRvdFByb3BzKTsKICB9CiAgaWYgKHR5cGVvZiBvcHRpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBvcHRpb24oZG90UHJvcHMpOwogIH0KICB2YXIgZmluYWxDbGFzc05hbWUgPSBjbHN4KGNsYXNzTmFtZSwgdHlwZW9mIG9wdGlvbiAhPT0gImJvb2xlYW4iID8gb3B0aW9uLmNsYXNzTmFtZSA6ICIiKTsKICB2YXIgX3JlZjIyID0gZG90UHJvcHMgIT09IG51bGwgJiYgZG90UHJvcHMgIT09IHZvaWQgMCA/IGRvdFByb3BzIDoge30sIHsKICAgIHBvaW50cwogIH0gPSBfcmVmMjIsIHByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzOShfcmVmMjIsIF9leGNsdWRlZDkpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxOS5jcmVhdGVFbGVtZW50KERvdCwgX2V4dGVuZHMxNCh7fSwgcHJvcHMsIHsKICAgIGNsYXNzTmFtZTogZmluYWxDbGFzc05hbWUKICB9KSk7Cn0KZnVuY3Rpb24gc2hvdWxkUmVuZGVyRG90cyhwb2ludHMsIGRvdCkgewogIGlmIChwb2ludHMgPT0gbnVsbCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBpZiAoZG90KSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIHBvaW50cy5sZW5ndGggPT09IDE7Cn0KZnVuY3Rpb24gRG90cyhfcmVmMykgewogIHZhciB7CiAgICBwb2ludHMsCiAgICBkb3QsCiAgICBjbGFzc05hbWUsCiAgICBkb3RDbGFzc05hbWUsCiAgICBkYXRhS2V5LAogICAgYmFzZVByb3BzLAogICAgbmVlZENsaXAsCiAgICBjbGlwUGF0aElkLAogICAgekluZGV4ID0gRGVmYXVsdFpJbmRleGVzLnNjYXR0ZXIKICB9ID0gX3JlZjM7CiAgaWYgKCFzaG91bGRSZW5kZXJEb3RzKHBvaW50cywgZG90KSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBjbGlwRG90ID0gaXNDbGlwRG90KGRvdCk7CiAgdmFyIGN1c3RvbURvdFByb3BzID0gc3ZnUHJvcGVydGllc0FuZEV2ZW50c0Zyb21Vbmtub3duKGRvdCk7CiAgdmFyIGRvdHMgPSBwb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIF9lbnRyeSR4LCBfZW50cnkkeTsKICAgIHZhciBkb3RQcm9wcyA9IF9vYmplY3RTcHJlYWQyNChfb2JqZWN0U3ByZWFkMjQoX29iamVjdFNwcmVhZDI0KHsKICAgICAgcjogMwogICAgfSwgYmFzZVByb3BzKSwgY3VzdG9tRG90UHJvcHMpLCB7fSwgewogICAgICBpbmRleDogaSwKICAgICAgY3g6IChfZW50cnkkeCA9IGVudHJ5LngpICE9PSBudWxsICYmIF9lbnRyeSR4ICE9PSB2b2lkIDAgPyBfZW50cnkkeCA6IHZvaWQgMCwKICAgICAgY3k6IChfZW50cnkkeSA9IGVudHJ5LnkpICE9PSBudWxsICYmIF9lbnRyeSR5ICE9PSB2b2lkIDAgPyBfZW50cnkkeSA6IHZvaWQgMCwKICAgICAgZGF0YUtleSwKICAgICAgdmFsdWU6IGVudHJ5LnZhbHVlLAogICAgICBwYXlsb2FkOiBlbnRyeS5wYXlsb2FkLAogICAgICBwb2ludHMKICAgIH0pOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE5LmNyZWF0ZUVsZW1lbnQoRG90SXRlbSwgewogICAgICBrZXk6ICJkb3QtIi5jb25jYXQoaSksCiAgICAgIG9wdGlvbjogZG90LAogICAgICBkb3RQcm9wcywKICAgICAgY2xhc3NOYW1lOiBkb3RDbGFzc05hbWUKICAgIH0pOwogIH0pOwogIHZhciBsYXllclByb3BzID0ge307CiAgaWYgKG5lZWRDbGlwICYmIGNsaXBQYXRoSWQgIT0gbnVsbCkgewogICAgbGF5ZXJQcm9wcy5jbGlwUGF0aCA9ICJ1cmwoI2NsaXBQYXRoLSIuY29uY2F0KGNsaXBEb3QgPyAiIiA6ICJkb3RzLSIpLmNvbmNhdChjbGlwUGF0aElkLCAiKSIpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTkuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4CiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MTkuY3JlYXRlRWxlbWVudChMYXllciwgX2V4dGVuZHMxNCh7CiAgICBjbGFzc05hbWUKICB9LCBsYXllclByb3BzKSwgZG90cykpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9BY3RpdmVQb2ludHMuanMKdmFyIFJlYWN0MjAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QzNCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvY2FydGVzaWFuQXhpc1NsaWNlLmpzCmZ1bmN0aW9uIG93bktleXMyNShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI1KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjUoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI2KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI1KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyNihlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI2KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI2KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI2KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI2KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgaW5pdGlhbFN0YXRlOCA9IHsKICB4QXhpczoge30sCiAgeUF4aXM6IHt9LAogIHpBeGlzOiB7fQp9Owp2YXIgY2FydGVzaWFuQXhpc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJjYXJ0ZXNpYW5BeGlzIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTgsCiAgcmVkdWNlcnM6IHsKICAgIGFkZFhBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLnhBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXSA9IGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCk7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVwbGFjZVhBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciB7CiAgICAgICAgICBwcmV2LAogICAgICAgICAgbmV4dAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUueEF4aXNbcHJldi5pZF0gIT09IHZvaWQgMCkgewogICAgICAgICAgaWYgKHByZXYuaWQgIT09IG5leHQuaWQpIHsKICAgICAgICAgICAgZGVsZXRlIHN0YXRlLnhBeGlzW3ByZXYuaWRdOwogICAgICAgICAgfQogICAgICAgICAgc3RhdGUueEF4aXNbbmV4dC5pZF0gPSBjYXN0RHJhZnQobmV4dCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZVhBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIGRlbGV0ZSBzdGF0ZS54QXhpc1thY3Rpb24ucGF5bG9hZC5pZF07CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgYWRkWUF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUueUF4aXNbYWN0aW9uLnBheWxvYWQuaWRdID0gY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZXBsYWNlWUF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHByZXYsCiAgICAgICAgICBuZXh0CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIGlmIChzdGF0ZS55QXhpc1twcmV2LmlkXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBpZiAocHJldi5pZCAhPT0gbmV4dC5pZCkgewogICAgICAgICAgICBkZWxldGUgc3RhdGUueUF4aXNbcHJldi5pZF07CiAgICAgICAgICB9CiAgICAgICAgICBzdGF0ZS55QXhpc1tuZXh0LmlkXSA9IGNhc3REcmFmdChuZXh0KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlWUF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgZGVsZXRlIHN0YXRlLnlBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICBhZGRaQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS56QXhpc1thY3Rpb24ucGF5bG9hZC5pZF0gPSBjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlcGxhY2VaQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgewogICAgICAgICAgcHJldiwKICAgICAgICAgIG5leHQKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgaWYgKHN0YXRlLnpBeGlzW3ByZXYuaWRdICE9PSB2b2lkIDApIHsKICAgICAgICAgIGlmIChwcmV2LmlkICE9PSBuZXh0LmlkKSB7CiAgICAgICAgICAgIGRlbGV0ZSBzdGF0ZS56QXhpc1twcmV2LmlkXTsKICAgICAgICAgIH0KICAgICAgICAgIHN0YXRlLnpBeGlzW25leHQuaWRdID0gY2FzdERyYWZ0KG5leHQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVaQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBkZWxldGUgc3RhdGUuekF4aXNbYWN0aW9uLnBheWxvYWQuaWRdOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHVwZGF0ZVlBeGlzV2lkdGgoc3RhdGUsIGFjdGlvbikgewogICAgICB2YXIgewogICAgICAgIGlkLAogICAgICAgIHdpZHRoCiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgdmFyIGF4aXMgPSBzdGF0ZS55QXhpc1tpZF07CiAgICAgIGlmIChheGlzKSB7CiAgICAgICAgdmFyIGhpc3RvcnkgPSBheGlzLndpZHRoSGlzdG9yeSB8fCBbXTsKICAgICAgICBpZiAoaGlzdG9yeS5sZW5ndGggPT09IDMgJiYgaGlzdG9yeVswXSA9PT0gaGlzdG9yeVsyXSAmJiB3aWR0aCA9PT0gaGlzdG9yeVsxXSAmJiB3aWR0aCAhPT0gYXhpcy53aWR0aCAmJiBNYXRoLmFicyh3aWR0aCAtIGhpc3RvcnlbMF0pIDw9IDEpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdmFyIG5ld0hpc3RvcnkgPSBbLi4uaGlzdG9yeSwgd2lkdGhdLnNsaWNlKC0zKTsKICAgICAgICBzdGF0ZS55QXhpc1tpZF0gPSBfb2JqZWN0U3ByZWFkMjUoX29iamVjdFNwcmVhZDI1KHt9LCBzdGF0ZS55QXhpc1tpZF0pLCB7fSwgewogICAgICAgICAgd2lkdGgsCiAgICAgICAgICB3aWR0aEhpc3Rvcnk6IG5ld0hpc3RvcnkKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkWEF4aXMsCiAgcmVwbGFjZVhBeGlzLAogIHJlbW92ZVhBeGlzLAogIGFkZFlBeGlzLAogIHJlcGxhY2VZQXhpcywKICByZW1vdmVZQXhpcywKICBhZGRaQXhpcywKICByZXBsYWNlWkF4aXMsCiAgcmVtb3ZlWkF4aXMsCiAgdXBkYXRlWUF4aXNXaWR0aAp9ID0gY2FydGVzaWFuQXhpc1NsaWNlLmFjdGlvbnM7CnZhciBjYXJ0ZXNpYW5BeGlzUmVkdWNlciA9IGNhcnRlc2lhbkF4aXNTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0Q2hhcnRPZmZzZXQuanMKdmFyIHNlbGVjdENoYXJ0T2Zmc2V0ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWxdLCAob2Zmc2V0SW50ZXJuYWwpID0+IHsKICByZXR1cm4gewogICAgdG9wOiBvZmZzZXRJbnRlcm5hbC50b3AsCiAgICBib3R0b206IG9mZnNldEludGVybmFsLmJvdHRvbSwKICAgIGxlZnQ6IG9mZnNldEludGVybmFsLmxlZnQsCiAgICByaWdodDogb2Zmc2V0SW50ZXJuYWwucmlnaHQKICB9Owp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFBsb3RBcmVhLmpzCnZhciBzZWxlY3RQbG90QXJlYSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydE9mZnNldCwgc2VsZWN0Q2hhcnRXaWR0aCwgc2VsZWN0Q2hhcnRIZWlnaHRdLCAob2Zmc2V0LCBjaGFydFdpZHRoLCBjaGFydEhlaWdodCkgPT4gewogIGlmICghb2Zmc2V0IHx8IGNoYXJ0V2lkdGggPT0gbnVsbCB8fCBjaGFydEhlaWdodCA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gewogICAgeDogb2Zmc2V0LmxlZnQsCiAgICB5OiBvZmZzZXQudG9wLAogICAgd2lkdGg6IE1hdGgubWF4KDAsIGNoYXJ0V2lkdGggLSBvZmZzZXQubGVmdCAtIG9mZnNldC5yaWdodCksCiAgICBoZWlnaHQ6IE1hdGgubWF4KDAsIGNoYXJ0SGVpZ2h0IC0gb2Zmc2V0LnRvcCAtIG9mZnNldC5ib3R0b20pCiAgfTsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2hvb2tzLmpzCnZhciB1c2VQbG90QXJlYSA9ICgpID0+IHsKICByZXR1cm4gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0UGxvdEFyZWEpOwp9Owp2YXIgdXNlQWN0aXZlVG9vbHRpcERhdGFQb2ludHMgPSAoKSA9PiB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKHNlbGVjdEFjdGl2ZVRvb2x0aXBEYXRhUG9pbnRzKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0FjdGl2ZVBvaW50cy5qcwpmdW5jdGlvbiBvd25LZXlzMjYoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyNihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czI2KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyNyhlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyNihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjcoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyNyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyNyh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyNyh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyNyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIEFjdGl2ZVBvaW50ID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIHBvaW50OiBwb2ludDQsCiAgICBjaGlsZEluZGV4LAogICAgbWFpbkNvbG9yLAogICAgYWN0aXZlRG90LAogICAgZGF0YUtleSwKICAgIGNsaXBQYXRoCiAgfSA9IF9yZWYyOwogIGlmIChhY3RpdmVEb3QgPT09IGZhbHNlIHx8IHBvaW50NC54ID09IG51bGwgfHwgcG9pbnQ0LnkgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBkb3RQcm9wc1R5cGVkID0gewogICAgaW5kZXg6IGNoaWxkSW5kZXgsCiAgICBkYXRhS2V5LAogICAgY3g6IHBvaW50NC54LAogICAgY3k6IHBvaW50NC55LAogICAgcjogNCwKICAgIGZpbGw6IG1haW5Db2xvciAhPT0gbnVsbCAmJiBtYWluQ29sb3IgIT09IHZvaWQgMCA/IG1haW5Db2xvciA6ICJub25lIiwKICAgIHN0cm9rZVdpZHRoOiAyLAogICAgc3Ryb2tlOiAiI2ZmZiIsCiAgICBwYXlsb2FkOiBwb2ludDQucGF5bG9hZCwKICAgIHZhbHVlOiBwb2ludDQudmFsdWUKICB9OwogIHZhciBkb3RQcm9wcyA9IF9vYmplY3RTcHJlYWQyNihfb2JqZWN0U3ByZWFkMjYoX29iamVjdFNwcmVhZDI2KHt9LCBkb3RQcm9wc1R5cGVkKSwgc3ZnUHJvcGVydGllc05vRXZlbnRzRnJvbVVua25vd24oYWN0aXZlRG90KSksIGFkYXB0RXZlbnRIYW5kbGVycyhhY3RpdmVEb3QpKTsKICB2YXIgZG90OwogIGlmICgvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDM0LmlzVmFsaWRFbGVtZW50KShhY3RpdmVEb3QpKSB7CiAgICBkb3QgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDM0LmNsb25lRWxlbWVudCkoYWN0aXZlRG90LCBkb3RQcm9wcyk7CiAgfSBlbHNlIGlmICh0eXBlb2YgYWN0aXZlRG90ID09PSAiZnVuY3Rpb24iKSB7CiAgICBkb3QgPSBhY3RpdmVEb3QoZG90UHJvcHMpOwogIH0gZWxzZSB7CiAgICBkb3QgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyMC5jcmVhdGVFbGVtZW50KERvdCwgZG90UHJvcHMpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjAuY3JlYXRlRWxlbWVudChMYXllciwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtYWN0aXZlLWRvdCIsCiAgICBjbGlwUGF0aAogIH0sIGRvdCk7Cn07CmZ1bmN0aW9uIEFjdGl2ZVBvaW50cyhfcmVmMikgewogIHZhciB7CiAgICBwb2ludHMsCiAgICBtYWluQ29sb3IsCiAgICBhY3RpdmVEb3QsCiAgICBpdGVtRGF0YUtleSwKICAgIGNsaXBQYXRoLAogICAgekluZGV4ID0gRGVmYXVsdFpJbmRleGVzLmFjdGl2ZURvdAogIH0gPSBfcmVmMjsKICB2YXIgYWN0aXZlVG9vbHRpcEluZGV4ID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0QWN0aXZlVG9vbHRpcEluZGV4KTsKICB2YXIgYWN0aXZlRGF0YVBvaW50cyA9IHVzZUFjdGl2ZVRvb2x0aXBEYXRhUG9pbnRzKCk7CiAgaWYgKHBvaW50cyA9PSBudWxsIHx8IGFjdGl2ZURhdGFQb2ludHMgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBhY3RpdmVQb2ludCA9IHBvaW50cy5maW5kKChwKSA9PiBhY3RpdmVEYXRhUG9pbnRzLmluY2x1ZGVzKHAucGF5bG9hZCkpOwogIGlmIChpc051bGxpc2goYWN0aXZlUG9pbnQpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIwLmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIwLmNyZWF0ZUVsZW1lbnQoQWN0aXZlUG9pbnQsIHsKICAgIHBvaW50OiBhY3RpdmVQb2ludCwKICAgIGNoaWxkSW5kZXg6IE51bWJlcihhY3RpdmVUb29sdGlwSW5kZXgpLAogICAgbWFpbkNvbG9yLAogICAgZGF0YUtleTogaXRlbURhdGFLZXksCiAgICBhY3RpdmVEb3QsCiAgICBjbGlwUGF0aAogIH0pKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9lcnJvckJhclNsaWNlLmpzCnZhciBpbml0aWFsU3RhdGU5ID0ge307CnZhciBlcnJvckJhclNsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJlcnJvckJhcnMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlOSwKICByZWR1Y2VyczogewogICAgYWRkRXJyb3JCYXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciB7CiAgICAgICAgaXRlbUlkLAogICAgICAgIGVycm9yQmFyCiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgaWYgKCFzdGF0ZVtpdGVtSWRdKSB7CiAgICAgICAgc3RhdGVbaXRlbUlkXSA9IFtdOwogICAgICB9CiAgICAgIHN0YXRlW2l0ZW1JZF0ucHVzaChlcnJvckJhcik7CiAgICB9LAogICAgcmVwbGFjZUVycm9yQmFyOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICB2YXIgewogICAgICAgIGl0ZW1JZCwKICAgICAgICBwcmV2LAogICAgICAgIG5leHQKICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICBpZiAoc3RhdGVbaXRlbUlkXSkgewogICAgICAgIHN0YXRlW2l0ZW1JZF0gPSBzdGF0ZVtpdGVtSWRdLm1hcCgoZSkgPT4gZS5kYXRhS2V5ID09PSBwcmV2LmRhdGFLZXkgJiYgZS5kaXJlY3Rpb24gPT09IHByZXYuZGlyZWN0aW9uID8gbmV4dCA6IGUpOwogICAgICB9CiAgICB9LAogICAgcmVtb3ZlRXJyb3JCYXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciB7CiAgICAgICAgaXRlbUlkLAogICAgICAgIGVycm9yQmFyCiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgaWYgKHN0YXRlW2l0ZW1JZF0pIHsKICAgICAgICBzdGF0ZVtpdGVtSWRdID0gc3RhdGVbaXRlbUlkXS5maWx0ZXIoKGUpID0+IGUuZGF0YUtleSAhPT0gZXJyb3JCYXIuZGF0YUtleSB8fCBlLmRpcmVjdGlvbiAhPT0gZXJyb3JCYXIuZGlyZWN0aW9uKTsKICAgICAgfQogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkRXJyb3JCYXIsCiAgcmVwbGFjZUVycm9yQmFyLAogIHJlbW92ZUVycm9yQmFyCn0gPSBlcnJvckJhclNsaWNlLmFjdGlvbnM7CnZhciBlcnJvckJhclJlZHVjZXIgPSBlcnJvckJhclNsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9HcmFwaGljYWxJdGVtQ2xpcFBhdGguanMKdmFyIFJlYWN0MjEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIHVzZU5lZWRzQ2xpcCh4QXhpc0lkLCB5QXhpc0lkKSB7CiAgdmFyIF94QXhpcyRhbGxvd0RhdGFPdmVyZiwgX3lBeGlzJGFsbG93RGF0YU92ZXJmOwogIHZhciB4QXhpcyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WEF4aXNTZXR0aW5ncyhzdGF0ZSwgeEF4aXNJZCkpOwogIHZhciB5QXhpcyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WUF4aXNTZXR0aW5ncyhzdGF0ZSwgeUF4aXNJZCkpOwogIHZhciBuZWVkQ2xpcFggPSAoX3hBeGlzJGFsbG93RGF0YU92ZXJmID0geEF4aXMgPT09IG51bGwgfHwgeEF4aXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHhBeGlzLmFsbG93RGF0YU92ZXJmbG93KSAhPT0gbnVsbCAmJiBfeEF4aXMkYWxsb3dEYXRhT3ZlcmYgIT09IHZvaWQgMCA/IF94QXhpcyRhbGxvd0RhdGFPdmVyZiA6IGltcGxpY2l0WEF4aXMuYWxsb3dEYXRhT3ZlcmZsb3c7CiAgdmFyIG5lZWRDbGlwWSA9IChfeUF4aXMkYWxsb3dEYXRhT3ZlcmYgPSB5QXhpcyA9PT0gbnVsbCB8fCB5QXhpcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogeUF4aXMuYWxsb3dEYXRhT3ZlcmZsb3cpICE9PSBudWxsICYmIF95QXhpcyRhbGxvd0RhdGFPdmVyZiAhPT0gdm9pZCAwID8gX3lBeGlzJGFsbG93RGF0YU92ZXJmIDogaW1wbGljaXRZQXhpcy5hbGxvd0RhdGFPdmVyZmxvdzsKICB2YXIgbmVlZENsaXAgPSBuZWVkQ2xpcFggfHwgbmVlZENsaXBZOwogIHJldHVybiB7CiAgICBuZWVkQ2xpcCwKICAgIG5lZWRDbGlwWCwKICAgIG5lZWRDbGlwWQogIH07Cn0KZnVuY3Rpb24gR3JhcGhpY2FsSXRlbUNsaXBQYXRoKF9yZWYyKSB7CiAgdmFyIHsKICAgIHhBeGlzSWQsCiAgICB5QXhpc0lkLAogICAgY2xpcFBhdGhJZAogIH0gPSBfcmVmMjsKICB2YXIgcGxvdEFyZWEgPSB1c2VQbG90QXJlYSgpOwogIHZhciB7CiAgICBuZWVkQ2xpcFgsCiAgICBuZWVkQ2xpcFksCiAgICBuZWVkQ2xpcAogIH0gPSB1c2VOZWVkc0NsaXAoeEF4aXNJZCwgeUF4aXNJZCk7CiAgaWYgKCFuZWVkQ2xpcCB8fCAhcGxvdEFyZWEpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHBsb3RBcmVhOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMS5jcmVhdGVFbGVtZW50KCJjbGlwUGF0aCIsIHsKICAgIGlkOiAiY2xpcFBhdGgtIi5jb25jYXQoY2xpcFBhdGhJZCkKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMS5jcmVhdGVFbGVtZW50KCJyZWN0IiwgewogICAgeDogbmVlZENsaXBYID8geDIgOiB4MiAtIHdpZHRoIC8gMiwKICAgIHk6IG5lZWRDbGlwWSA/IHkyIDogeTIgLSBoZWlnaHQgLyAyLAogICAgd2lkdGg6IG5lZWRDbGlwWCA/IHdpZHRoIDogd2lkdGggKiAyLAogICAgaGVpZ2h0OiBuZWVkQ2xpcFkgPyBoZWlnaHQgOiBoZWlnaHQgKiAyCiAgfSkpOwp9CgovLyBub2RlX21vZHVsZXMvcmVhY3QtcmVkdXgvZGlzdC9yZWFjdC1yZWR1eC5tanMKdmFyIFJlYWN0MjIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSwgMSk7CnZhciBpbXBvcnRfd2l0aF9zZWxlY3RvcjIgPSBfX3RvRVNNKHJlcXVpcmVfd2l0aF9zZWxlY3RvcjIoKSwgMSk7CnZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFID0gLyogQF9fUFVSRV9fICovIFN5bWJvbC5mb3IoInJlYWN0LmZvcndhcmRfcmVmIik7CnZhciBSRUFDVF9NRU1PX1RZUEUgPSAvKiBAX19QVVJFX18gKi8gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwp2YXIgRm9yd2FyZFJlZiA9IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU7CnZhciBNZW1vID0gUkVBQ1RfTUVNT19UWVBFOwpmdW5jdGlvbiBkZWZhdWx0Tm9vcEJhdGNoKGNhbGxiYWNrKSB7CiAgY2FsbGJhY2soKTsKfQpmdW5jdGlvbiBjcmVhdGVMaXN0ZW5lckNvbGxlY3Rpb24oKSB7CiAgbGV0IGZpcnN0ID0gbnVsbDsKICBsZXQgbGFzdDIgPSBudWxsOwogIHJldHVybiB7CiAgICBjbGVhcigpIHsKICAgICAgZmlyc3QgPSBudWxsOwogICAgICBsYXN0MiA9IG51bGw7CiAgICB9LAogICAgbm90aWZ5KCkgewogICAgICBkZWZhdWx0Tm9vcEJhdGNoKCgpID0+IHsKICAgICAgICBsZXQgbGlzdGVuZXIyID0gZmlyc3Q7CiAgICAgICAgd2hpbGUgKGxpc3RlbmVyMikgewogICAgICAgICAgbGlzdGVuZXIyLmNhbGxiYWNrKCk7CiAgICAgICAgICBsaXN0ZW5lcjIgPSBsaXN0ZW5lcjIubmV4dDsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGdldCgpIHsKICAgICAgY29uc3QgbGlzdGVuZXJzID0gW107CiAgICAgIGxldCBsaXN0ZW5lcjIgPSBmaXJzdDsKICAgICAgd2hpbGUgKGxpc3RlbmVyMikgewogICAgICAgIGxpc3RlbmVycy5wdXNoKGxpc3RlbmVyMik7CiAgICAgICAgbGlzdGVuZXIyID0gbGlzdGVuZXIyLm5leHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGxpc3RlbmVyczsKICAgIH0sCiAgICBzdWJzY3JpYmUoY2FsbGJhY2spIHsKICAgICAgbGV0IGlzU3Vic2NyaWJlZCA9IHRydWU7CiAgICAgIGNvbnN0IGxpc3RlbmVyMiA9IGxhc3QyID0gewogICAgICAgIGNhbGxiYWNrLAogICAgICAgIG5leHQ6IG51bGwsCiAgICAgICAgcHJldjogbGFzdDIKICAgICAgfTsKICAgICAgaWYgKGxpc3RlbmVyMi5wcmV2KSB7CiAgICAgICAgbGlzdGVuZXIyLnByZXYubmV4dCA9IGxpc3RlbmVyMjsKICAgICAgfSBlbHNlIHsKICAgICAgICBmaXJzdCA9IGxpc3RlbmVyMjsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24gdW5zdWJzY3JpYmUoKSB7CiAgICAgICAgaWYgKCFpc1N1YnNjcmliZWQgfHwgZmlyc3QgPT09IG51bGwpIHJldHVybjsKICAgICAgICBpc1N1YnNjcmliZWQgPSBmYWxzZTsKICAgICAgICBpZiAobGlzdGVuZXIyLm5leHQpIHsKICAgICAgICAgIGxpc3RlbmVyMi5uZXh0LnByZXYgPSBsaXN0ZW5lcjIucHJldjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbGFzdDIgPSBsaXN0ZW5lcjIucHJldjsKICAgICAgICB9CiAgICAgICAgaWYgKGxpc3RlbmVyMi5wcmV2KSB7CiAgICAgICAgICBsaXN0ZW5lcjIucHJldi5uZXh0ID0gbGlzdGVuZXIyLm5leHQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZpcnN0ID0gbGlzdGVuZXIyLm5leHQ7CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH07Cn0KdmFyIG51bGxMaXN0ZW5lcnMgPSB7CiAgbm90aWZ5KCkgewogIH0sCiAgZ2V0OiAoKSA9PiBbXQp9OwpmdW5jdGlvbiBjcmVhdGVTdWJzY3JpcHRpb24oc3RvcmUsIHBhcmVudFN1YikgewogIGxldCB1bnN1YnNjcmliZTsKICBsZXQgbGlzdGVuZXJzID0gbnVsbExpc3RlbmVyczsKICBsZXQgc3Vic2NyaXB0aW9uc0Ftb3VudCA9IDA7CiAgbGV0IHNlbGZTdWJzY3JpYmVkID0gZmFsc2U7CiAgZnVuY3Rpb24gYWRkTmVzdGVkU3ViKGxpc3RlbmVyMikgewogICAgdHJ5U3Vic2NyaWJlKCk7CiAgICBjb25zdCBjbGVhbnVwTGlzdGVuZXIgPSBsaXN0ZW5lcnMuc3Vic2NyaWJlKGxpc3RlbmVyMik7CiAgICBsZXQgcmVtb3ZlZCA9IGZhbHNlOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKCFyZW1vdmVkKSB7CiAgICAgICAgcmVtb3ZlZCA9IHRydWU7CiAgICAgICAgY2xlYW51cExpc3RlbmVyKCk7CiAgICAgICAgdHJ5VW5zdWJzY3JpYmUoKTsKICAgICAgfQogICAgfTsKICB9CiAgZnVuY3Rpb24gbm90aWZ5TmVzdGVkU3VicygpIHsKICAgIGxpc3RlbmVycy5ub3RpZnkoKTsKICB9CiAgZnVuY3Rpb24gaGFuZGxlQ2hhbmdlV3JhcHBlcigpIHsKICAgIGlmIChzdWJzY3JpcHRpb24ub25TdGF0ZUNoYW5nZSkgewogICAgICBzdWJzY3JpcHRpb24ub25TdGF0ZUNoYW5nZSgpOwogICAgfQogIH0KICBmdW5jdGlvbiBpc1N1YnNjcmliZWQoKSB7CiAgICByZXR1cm4gc2VsZlN1YnNjcmliZWQ7CiAgfQogIGZ1bmN0aW9uIHRyeVN1YnNjcmliZSgpIHsKICAgIHN1YnNjcmlwdGlvbnNBbW91bnQrKzsKICAgIGlmICghdW5zdWJzY3JpYmUpIHsKICAgICAgdW5zdWJzY3JpYmUgPSBwYXJlbnRTdWIgPyBwYXJlbnRTdWIuYWRkTmVzdGVkU3ViKGhhbmRsZUNoYW5nZVdyYXBwZXIpIDogc3RvcmUuc3Vic2NyaWJlKGhhbmRsZUNoYW5nZVdyYXBwZXIpOwogICAgICBsaXN0ZW5lcnMgPSBjcmVhdGVMaXN0ZW5lckNvbGxlY3Rpb24oKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gdHJ5VW5zdWJzY3JpYmUoKSB7CiAgICBzdWJzY3JpcHRpb25zQW1vdW50LS07CiAgICBpZiAodW5zdWJzY3JpYmUgJiYgc3Vic2NyaXB0aW9uc0Ftb3VudCA9PT0gMCkgewogICAgICB1bnN1YnNjcmliZSgpOwogICAgICB1bnN1YnNjcmliZSA9IHZvaWQgMDsKICAgICAgbGlzdGVuZXJzLmNsZWFyKCk7CiAgICAgIGxpc3RlbmVycyA9IG51bGxMaXN0ZW5lcnM7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyeVN1YnNjcmliZVNlbGYoKSB7CiAgICBpZiAoIXNlbGZTdWJzY3JpYmVkKSB7CiAgICAgIHNlbGZTdWJzY3JpYmVkID0gdHJ1ZTsKICAgICAgdHJ5U3Vic2NyaWJlKCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyeVVuc3Vic2NyaWJlU2VsZigpIHsKICAgIGlmIChzZWxmU3Vic2NyaWJlZCkgewogICAgICBzZWxmU3Vic2NyaWJlZCA9IGZhbHNlOwogICAgICB0cnlVbnN1YnNjcmliZSgpOwogICAgfQogIH0KICBjb25zdCBzdWJzY3JpcHRpb24gPSB7CiAgICBhZGROZXN0ZWRTdWIsCiAgICBub3RpZnlOZXN0ZWRTdWJzLAogICAgaGFuZGxlQ2hhbmdlV3JhcHBlciwKICAgIGlzU3Vic2NyaWJlZCwKICAgIHRyeVN1YnNjcmliZTogdHJ5U3Vic2NyaWJlU2VsZiwKICAgIHRyeVVuc3Vic2NyaWJlOiB0cnlVbnN1YnNjcmliZVNlbGYsCiAgICBnZXRMaXN0ZW5lcnM6ICgpID0+IGxpc3RlbmVycwogIH07CiAgcmV0dXJuIHN1YnNjcmlwdGlvbjsKfQp2YXIgY2FuVXNlRE9NID0gKCkgPT4gISEodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50ICE9PSAidW5kZWZpbmVkIik7CnZhciBpc0RPTSA9IC8qIEBfX1BVUkVfXyAqLyBjYW5Vc2VET00oKTsKdmFyIGlzUnVubmluZ0luUmVhY3ROYXRpdmUgPSAoKSA9PiB0eXBlb2YgbmF2aWdhdG9yICE9PSAidW5kZWZpbmVkIiAmJiBuYXZpZ2F0b3IucHJvZHVjdCA9PT0gIlJlYWN0TmF0aXZlIjsKdmFyIGlzUmVhY3ROYXRpdmUgPSAvKiBAX19QVVJFX18gKi8gaXNSdW5uaW5nSW5SZWFjdE5hdGl2ZSgpOwp2YXIgZ2V0VXNlSXNvbW9ycGhpY0xheW91dEVmZmVjdCA9ICgpID0+IGlzRE9NIHx8IGlzUmVhY3ROYXRpdmUgPyBSZWFjdDIyLnVzZUxheW91dEVmZmVjdCA6IFJlYWN0MjIudXNlRWZmZWN0Owp2YXIgdXNlSXNvbW9ycGhpY0xheW91dEVmZmVjdCA9IC8qIEBfX1BVUkVfXyAqLyBnZXRVc2VJc29tb3JwaGljTGF5b3V0RWZmZWN0KCk7CmZ1bmN0aW9uIGlzMyh4MiwgeTIpIHsKICBpZiAoeDIgPT09IHkyKSB7CiAgICByZXR1cm4geDIgIT09IDAgfHwgeTIgIT09IDAgfHwgMSAvIHgyID09PSAxIC8geTI7CiAgfSBlbHNlIHsKICAgIHJldHVybiB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogIH0KfQpmdW5jdGlvbiBzaGFsbG93RXF1YWwob2JqQSwgb2JqQikgewogIGlmIChpczMob2JqQSwgb2JqQikpIHJldHVybiB0cnVlOwogIGlmICh0eXBlb2Ygb2JqQSAhPT0gIm9iamVjdCIgfHwgb2JqQSA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqQiAhPT0gIm9iamVjdCIgfHwgb2JqQiA9PT0gbnVsbCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBjb25zdCBrZXlzQSA9IE9iamVjdC5rZXlzKG9iakEpOwogIGNvbnN0IGtleXNCID0gT2JqZWN0LmtleXMob2JqQik7CiAgaWYgKGtleXNBLmxlbmd0aCAhPT0ga2V5c0IubGVuZ3RoKSByZXR1cm4gZmFsc2U7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzQS5sZW5ndGg7IGkrKykgewogICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqQiwga2V5c0FbaV0pIHx8ICFpczMob2JqQVtrZXlzQVtpXV0sIG9iakJba2V5c0FbaV1dKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQogIHJldHVybiB0cnVlOwp9CnZhciBGT1JXQVJEX1JFRl9TVEFUSUNTID0gewogICQkdHlwZW9mOiB0cnVlLAogIHJlbmRlcjogdHJ1ZSwKICBkZWZhdWx0UHJvcHM6IHRydWUsCiAgZGlzcGxheU5hbWU6IHRydWUsCiAgcHJvcFR5cGVzOiB0cnVlCn07CnZhciBNRU1PX1NUQVRJQ1MgPSB7CiAgJCR0eXBlb2Y6IHRydWUsCiAgY29tcGFyZTogdHJ1ZSwKICBkZWZhdWx0UHJvcHM6IHRydWUsCiAgZGlzcGxheU5hbWU6IHRydWUsCiAgcHJvcFR5cGVzOiB0cnVlLAogIHR5cGU6IHRydWUKfTsKdmFyIFRZUEVfU1RBVElDUyA9IHsKICBbRm9yd2FyZFJlZl06IEZPUldBUkRfUkVGX1NUQVRJQ1MsCiAgW01lbW9dOiBNRU1PX1NUQVRJQ1MKfTsKdmFyIG9iamVjdFByb3RvdHlwZSA9IE9iamVjdC5wcm90b3R5cGU7CnZhciBDb250ZXh0S2V5ID0gLyogQF9fUFVSRV9fICovIFN5bWJvbC5mb3IoYHJlYWN0LXJlZHV4LWNvbnRleHRgKTsKdmFyIGdUID0gdHlwZW9mIGdsb2JhbFRoaXMgIT09ICJ1bmRlZmluZWQiID8gZ2xvYmFsVGhpcyA6ICgKICAvKiBmYWxsIGJhY2sgdG8gYSBwZXItbW9kdWxlIHNjb3BlIChwcmUtOC4xIGJlaGF2aW91cikgaWYgYGdsb2JhbFRoaXNgIGlzIG5vdCBhdmFpbGFibGUgKi8KICB7fQopOwpmdW5jdGlvbiBnZXRDb250ZXh0KCkgewogIGlmICghUmVhY3QyMi5jcmVhdGVDb250ZXh0KSByZXR1cm4ge307CiAgY29uc3QgY29udGV4dE1hcCA9IGdUW0NvbnRleHRLZXldID8/PSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGxldCByZWFsQ29udGV4dCA9IGNvbnRleHRNYXAuZ2V0KFJlYWN0MjIuY3JlYXRlQ29udGV4dCk7CiAgaWYgKCFyZWFsQ29udGV4dCkgewogICAgcmVhbENvbnRleHQgPSBSZWFjdDIyLmNyZWF0ZUNvbnRleHQoCiAgICAgIG51bGwKICAgICk7CiAgICBpZiAodHJ1ZSkgewogICAgICByZWFsQ29udGV4dC5kaXNwbGF5TmFtZSA9ICJSZWFjdFJlZHV4IjsKICAgIH0KICAgIGNvbnRleHRNYXAuc2V0KFJlYWN0MjIuY3JlYXRlQ29udGV4dCwgcmVhbENvbnRleHQpOwogIH0KICByZXR1cm4gcmVhbENvbnRleHQ7Cn0KdmFyIFJlYWN0UmVkdXhDb250ZXh0ID0gLyogQF9fUFVSRV9fICovIGdldENvbnRleHQoKTsKZnVuY3Rpb24gUHJvdmlkZXIocHJvdmlkZXJQcm9wcykgewogIGNvbnN0IHsgY2hpbGRyZW4sIGNvbnRleHQsIHNlcnZlclN0YXRlLCBzdG9yZSB9ID0gcHJvdmlkZXJQcm9wczsKICBjb25zdCBjb250ZXh0VmFsdWUgPSBSZWFjdDIyLnVzZU1lbW8oKCkgPT4gewogICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gY3JlYXRlU3Vic2NyaXB0aW9uKHN0b3JlKTsKICAgIGNvbnN0IGJhc2VDb250ZXh0VmFsdWUgPSB7CiAgICAgIHN0b3JlLAogICAgICBzdWJzY3JpcHRpb24sCiAgICAgIGdldFNlcnZlclN0YXRlOiBzZXJ2ZXJTdGF0ZSA/ICgpID0+IHNlcnZlclN0YXRlIDogdm9pZCAwCiAgICB9OwogICAgaWYgKGZhbHNlKSB7CiAgICAgIHJldHVybiBiYXNlQ29udGV4dFZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgeyBpZGVudGl0eUZ1bmN0aW9uQ2hlY2sgPSAib25jZSIsIHN0YWJpbGl0eUNoZWNrID0gIm9uY2UiIH0gPSBwcm92aWRlclByb3BzOwogICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIE9iamVjdC5hc3NpZ24oYmFzZUNvbnRleHRWYWx1ZSwgewogICAgICAgIHN0YWJpbGl0eUNoZWNrLAogICAgICAgIGlkZW50aXR5RnVuY3Rpb25DaGVjawogICAgICB9KTsKICAgIH0KICB9LCBbc3RvcmUsIHNlcnZlclN0YXRlXSk7CiAgY29uc3QgcHJldmlvdXNTdGF0ZSA9IFJlYWN0MjIudXNlTWVtbygoKSA9PiBzdG9yZS5nZXRTdGF0ZSgpLCBbc3RvcmVdKTsKICB1c2VJc29tb3JwaGljTGF5b3V0RWZmZWN0KCgpID0+IHsKICAgIGNvbnN0IHsgc3Vic2NyaXB0aW9uIH0gPSBjb250ZXh0VmFsdWU7CiAgICBzdWJzY3JpcHRpb24ub25TdGF0ZUNoYW5nZSA9IHN1YnNjcmlwdGlvbi5ub3RpZnlOZXN0ZWRTdWJzOwogICAgc3Vic2NyaXB0aW9uLnRyeVN1YnNjcmliZSgpOwogICAgaWYgKHByZXZpb3VzU3RhdGUgIT09IHN0b3JlLmdldFN0YXRlKCkpIHsKICAgICAgc3Vic2NyaXB0aW9uLm5vdGlmeU5lc3RlZFN1YnMoKTsKICAgIH0KICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHN1YnNjcmlwdGlvbi50cnlVbnN1YnNjcmliZSgpOwogICAgICBzdWJzY3JpcHRpb24ub25TdGF0ZUNoYW5nZSA9IHZvaWQgMDsKICAgIH07CiAgfSwgW2NvbnRleHRWYWx1ZSwgcHJldmlvdXNTdGF0ZV0pOwogIGNvbnN0IENvbnRleHQgPSBjb250ZXh0IHx8IFJlYWN0UmVkdXhDb250ZXh0OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMi5jcmVhdGVFbGVtZW50KENvbnRleHQuUHJvdmlkZXIsIHsgdmFsdWU6IGNvbnRleHRWYWx1ZSB9LCBjaGlsZHJlbik7Cn0KdmFyIFByb3ZpZGVyX2RlZmF1bHQgPSBQcm92aWRlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9wcm9wc0FyZUVxdWFsLmpzCnZhciBwcm9wc1RvU2hhbGxvd0NvbXBhcmUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldChbImF4aXNMaW5lIiwgInRpY2tMaW5lIiwgImFjdGl2ZUJhciIsICJhY3RpdmVEb3QiLCAiYWN0aXZlTGFiZWwiLCAiYWN0aXZlU2hhcGUiLCAiYWxsb3dFc2NhcGVWaWV3Qm94IiwgImJhY2tncm91bmQiLCAiY3Vyc29yIiwgImRvdCIsICJsYWJlbCIsICJsaW5lIiwgIm1hcmdpbiIsICJwYWRkaW5nIiwgInBvc2l0aW9uIiwgInNoYXBlIiwgInN0eWxlIiwgInRpY2siLCAid3JhcHBlclN0eWxlIl0pOwpmdW5jdGlvbiBzYW1lVmFsdWVaZXJvKHgyLCB5MikgewogIGlmICh4MiA9PSBudWxsICYmIHkyID09IG51bGwpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBpZiAodHlwZW9mIHgyID09PSAibnVtYmVyIiAmJiB0eXBlb2YgeTIgPT09ICJudW1iZXIiKSB7CiAgICByZXR1cm4geDIgPT09IHkyIHx8IHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgfQogIHJldHVybiB4MiA9PT0geTI7Cn0KZnVuY3Rpb24gcHJvcHNBcmVFcXVhbChwcmV2UHJvcHMsIG5leHRQcm9wcykgewogIHZhciBhbGxLZXlzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWy4uLk9iamVjdC5rZXlzKHByZXZQcm9wcyksIC4uLk9iamVjdC5rZXlzKG5leHRQcm9wcyldKTsKICBmb3IgKHZhciBrZXkgb2YgYWxsS2V5cykgewogICAgaWYgKHByb3BzVG9TaGFsbG93Q29tcGFyZS5oYXMoa2V5KSkgewogICAgICBpZiAocHJldlByb3BzW2tleV0gPT0gbnVsbCAmJiBuZXh0UHJvcHNba2V5XSA9PSBudWxsKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgaWYgKCFzaGFsbG93RXF1YWwocHJldlByb3BzW2tleV0sIG5leHRQcm9wc1trZXldKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSBlbHNlIGlmICghc2FtZVZhbHVlWmVybyhwcmV2UHJvcHNba2V5XSwgbmV4dFByb3BzW2tleV0pKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9CiAgcmV0dXJuIHRydWU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC9jaGFydERhdGFDb250ZXh0LmpzCnZhciBpbXBvcnRfcmVhY3QzNSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIENoYXJ0RGF0YUNvbnRleHRQcm92aWRlciA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICBjaGFydERhdGEKICB9ID0gcHJvcHM7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICAoMCwgaW1wb3J0X3JlYWN0MzUudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoaXNQYW5vcmFtYSkgewogICAgICByZXR1cm4gKCkgPT4gewogICAgICB9OwogICAgfQogICAgZGlzcGF0Y2goc2V0Q2hhcnREYXRhKGNoYXJ0RGF0YSkpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgZGlzcGF0Y2goc2V0Q2hhcnREYXRhKHZvaWQgMCkpOwogICAgfTsKICB9LCBbY2hhcnREYXRhLCBkaXNwYXRjaCwgaXNQYW5vcmFtYV0pOwogIHJldHVybiBudWxsOwp9OwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9icnVzaFNsaWNlLmpzCnZhciBpbml0aWFsU3RhdGUxMCA9IHsKICB4OiAwLAogIHk6IDAsCiAgd2lkdGg6IDAsCiAgaGVpZ2h0OiAwLAogIHBhZGRpbmc6IHsKICAgIHRvcDogMCwKICAgIHJpZ2h0OiAwLAogICAgYm90dG9tOiAwLAogICAgbGVmdDogMAogIH0KfTsKdmFyIGJydXNoU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImJydXNoIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTEwLAogIHJlZHVjZXJzOiB7CiAgICBzZXRCcnVzaFNldHRpbmdzKF9zdGF0ZSwgYWN0aW9uKSB7CiAgICAgIGlmIChhY3Rpb24ucGF5bG9hZCA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGluaXRpYWxTdGF0ZTEwOwogICAgICB9CiAgICAgIHJldHVybiBhY3Rpb24ucGF5bG9hZDsKICAgIH0KICB9Cn0pOwp2YXIgewogIHNldEJydXNoU2V0dGluZ3MKfSA9IGJydXNoU2xpY2UuYWN0aW9uczsKdmFyIGJydXNoUmVkdWNlciA9IGJydXNoU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9DYXJ0ZXNpYW5VdGlscy5qcwpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyOChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI4KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI4KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI4KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI4KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgU2NhbGVIZWxwZXIgPSBjbGFzcyBfU2NhbGVIZWxwZXIgewogIHN0YXRpYyBjcmVhdGUob2JqKSB7CiAgICByZXR1cm4gbmV3IF9TY2FsZUhlbHBlcihvYmopOwogIH0KICBjb25zdHJ1Y3RvcihzY2FsZSkgewogICAgdGhpcy5zY2FsZSA9IHNjYWxlOwogIH0KICBnZXQgZG9tYWluKCkgewogICAgcmV0dXJuIHRoaXMuc2NhbGUuZG9tYWluOwogIH0KICBnZXQgcmFuZ2UoKSB7CiAgICByZXR1cm4gdGhpcy5zY2FsZS5yYW5nZTsKICB9CiAgZ2V0IHJhbmdlTWluKCkgewogICAgcmV0dXJuIHRoaXMucmFuZ2UoKVswXTsKICB9CiAgZ2V0IHJhbmdlTWF4KCkgewogICAgcmV0dXJuIHRoaXMucmFuZ2UoKVsxXTsKICB9CiAgZ2V0IGJhbmR3aWR0aCgpIHsKICAgIHJldHVybiB0aGlzLnNjYWxlLmJhbmR3aWR0aDsKICB9CiAgYXBwbHkodmFsdWUpIHsKICAgIHZhciB7CiAgICAgIGJhbmRBd2FyZSwKICAgICAgcG9zaXRpb24KICAgIH0gPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6IHt9OwogICAgaWYgKHZhbHVlID09PSB2b2lkIDApIHsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0KICAgIGlmIChwb3NpdGlvbikgewogICAgICBzd2l0Y2ggKHBvc2l0aW9uKSB7CiAgICAgICAgY2FzZSAic3RhcnQiOiB7CiAgICAgICAgICByZXR1cm4gdGhpcy5zY2FsZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGNhc2UgIm1pZGRsZSI6IHsKICAgICAgICAgIHZhciBvZmZzZXQgPSB0aGlzLmJhbmR3aWR0aCA/IHRoaXMuYmFuZHdpZHRoKCkgLyAyIDogMDsKICAgICAgICAgIHJldHVybiB0aGlzLnNjYWxlKHZhbHVlKSArIG9mZnNldDsKICAgICAgICB9CiAgICAgICAgY2FzZSAiZW5kIjogewogICAgICAgICAgdmFyIF9vZmZzZXQgPSB0aGlzLmJhbmR3aWR0aCA/IHRoaXMuYmFuZHdpZHRoKCkgOiAwOwogICAgICAgICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpICsgX29mZnNldDsKICAgICAgICB9CiAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKGJhbmRBd2FyZSkgewogICAgICB2YXIgX29mZnNldDIgPSB0aGlzLmJhbmR3aWR0aCA/IHRoaXMuYmFuZHdpZHRoKCkgLyAyIDogMDsKICAgICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpICsgX29mZnNldDI7CiAgICB9CiAgICByZXR1cm4gdGhpcy5zY2FsZSh2YWx1ZSk7CiAgfQogIGlzSW5SYW5nZSh2YWx1ZSkgewogICAgdmFyIHJhbmdlNCA9IHRoaXMucmFuZ2UoKTsKICAgIHZhciBmaXJzdCA9IHJhbmdlNFswXTsKICAgIHZhciBsYXN0MiA9IHJhbmdlNFtyYW5nZTQubGVuZ3RoIC0gMV07CiAgICByZXR1cm4gZmlyc3QgPD0gbGFzdDIgPyB2YWx1ZSA+PSBmaXJzdCAmJiB2YWx1ZSA8PSBsYXN0MiA6IHZhbHVlID49IGxhc3QyICYmIHZhbHVlIDw9IGZpcnN0OwogIH0KfTsKX2RlZmluZVByb3BlcnR5MjgoU2NhbGVIZWxwZXIsICJFUFMiLCAxZS00KTsKZnVuY3Rpb24gbm9ybWFsaXplQW5nbGUoYW5nbGUpIHsKICByZXR1cm4gKGFuZ2xlICUgMTgwICsgMTgwKSAlIDE4MDsKfQp2YXIgZ2V0QW5nbGVkUmVjdGFuZ2xlV2lkdGggPSBmdW5jdGlvbiBnZXRBbmdsZWRSZWN0YW5nbGVXaWR0aDIoX3JlZjUpIHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gX3JlZjU7CiAgdmFyIGFuZ2xlID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiAwOwogIHZhciBub3JtYWxpemVkQW5nbGUgPSBub3JtYWxpemVBbmdsZShhbmdsZSk7CiAgdmFyIGFuZ2xlUmFkaWFucyA9IG5vcm1hbGl6ZWRBbmdsZSAqIE1hdGguUEkgLyAxODA7CiAgdmFyIGFuZ2xlVGhyZXNob2xkID0gTWF0aC5hdGFuKGhlaWdodCAvIHdpZHRoKTsKICB2YXIgYW5nbGVkV2lkdGggPSBhbmdsZVJhZGlhbnMgPiBhbmdsZVRocmVzaG9sZCAmJiBhbmdsZVJhZGlhbnMgPCBNYXRoLlBJIC0gYW5nbGVUaHJlc2hvbGQgPyBoZWlnaHQgLyBNYXRoLnNpbihhbmdsZVJhZGlhbnMpIDogd2lkdGggLyBNYXRoLmNvcyhhbmdsZVJhZGlhbnMpOwogIHJldHVybiBNYXRoLmFicyhhbmdsZWRXaWR0aCk7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3JlZmVyZW5jZUVsZW1lbnRzU2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZTExID0gewogIGRvdHM6IFtdLAogIGFyZWFzOiBbXSwKICBsaW5lczogW10KfTsKdmFyIHJlZmVyZW5jZUVsZW1lbnRzU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogInJlZmVyZW5jZUVsZW1lbnRzIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTExLAogIHJlZHVjZXJzOiB7CiAgICBhZGREb3Q6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHN0YXRlLmRvdHMucHVzaChhY3Rpb24ucGF5bG9hZCk7CiAgICB9LAogICAgcmVtb3ZlRG90OiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5kb3RzLmZpbmRJbmRleCgoZG90KSA9PiBkb3QgPT09IGFjdGlvbi5wYXlsb2FkKTsKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgIHN0YXRlLmRvdHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgfQogICAgfSwKICAgIGFkZEFyZWE6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHN0YXRlLmFyZWFzLnB1c2goYWN0aW9uLnBheWxvYWQpOwogICAgfSwKICAgIHJlbW92ZUFyZWE6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLmFyZWFzLmZpbmRJbmRleCgoYXJlYSkgPT4gYXJlYSA9PT0gYWN0aW9uLnBheWxvYWQpOwogICAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgICAgc3RhdGUuYXJlYXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgfQogICAgfSwKICAgIGFkZExpbmU6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHN0YXRlLmxpbmVzLnB1c2goY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICB9LAogICAgcmVtb3ZlTGluZTogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkubGluZXMuZmluZEluZGV4KChsaW5lKSA9PiBsaW5lID09PSBhY3Rpb24ucGF5bG9hZCk7CiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICBzdGF0ZS5saW5lcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CiAgICB9CiAgfQp9KTsKdmFyIHsKICBhZGREb3QsCiAgcmVtb3ZlRG90LAogIGFkZEFyZWEsCiAgcmVtb3ZlQXJlYSwKICBhZGRMaW5lLAogIHJlbW92ZUxpbmUKfSA9IHJlZmVyZW5jZUVsZW1lbnRzU2xpY2UuYWN0aW9uczsKdmFyIHJlZmVyZW5jZUVsZW1lbnRzUmVkdWNlciA9IHJlZmVyZW5jZUVsZW1lbnRzU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL0NsaXBQYXRoUHJvdmlkZXIuanMKdmFyIFJlYWN0MjMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QzNiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIENsaXBQYXRoSWRDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzNi5jcmVhdGVDb250ZXh0KSh2b2lkIDApOwp2YXIgQ2xpcFBhdGhQcm92aWRlciA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBjaGlsZHJlbgogIH0gPSBfcmVmMjsKICB2YXIgW2NsaXBQYXRoSWRdID0gKDAsIGltcG9ydF9yZWFjdDM2LnVzZVN0YXRlKSgiIi5jb25jYXQodW5pcXVlSWQoInJlY2hhcnRzIiksICItY2xpcCIpKTsKICB2YXIgcGxvdEFyZWEgPSB1c2VQbG90QXJlYSgpOwogIGlmIChwbG90QXJlYSA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBwbG90QXJlYTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjMuY3JlYXRlRWxlbWVudChDbGlwUGF0aElkQ29udGV4dC5Qcm92aWRlciwgewogICAgdmFsdWU6IGNsaXBQYXRoSWQKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMy5jcmVhdGVFbGVtZW50KCJkZWZzIiwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MjMuY3JlYXRlRWxlbWVudCgiY2xpcFBhdGgiLCB7CiAgICBpZDogY2xpcFBhdGhJZAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIzLmNyZWF0ZUVsZW1lbnQoInJlY3QiLCB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgaGVpZ2h0LAogICAgd2lkdGgKICB9KSkpLCBjaGlsZHJlbik7Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9DYXJ0ZXNpYW5BeGlzLmpzCnZhciBSZWFjdDI0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MzcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfZ2V0MyA9IF9fdG9FU00ocmVxdWlyZV9nZXQyKCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2dldEV2ZXJ5TnRoV2l0aENvbmRpdGlvbi5qcwpmdW5jdGlvbiBnZXRFdmVyeU50aFdpdGhDb25kaXRpb24oYXJyYXksIG4pIHsKICBpZiAobiA8IDEpIHsKICAgIHJldHVybiBbXTsKICB9CiAgaWYgKG4gPT09IDEpIHsKICAgIHJldHVybiBhcnJheTsKICB9CiAgdmFyIHJlc3VsdCA9IFtdOwogIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpICs9IG4pIHsKICAgIHJlc3VsdC5wdXNoKGFycmF5W2ldKTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL1RpY2tVdGlscy5qcwpmdW5jdGlvbiBnZXRBbmdsZWRUaWNrV2lkdGgoY29udGVudFNpemUsIHVuaXRTaXplLCBhbmdsZSkgewogIHZhciBzaXplID0gewogICAgd2lkdGg6IGNvbnRlbnRTaXplLndpZHRoICsgdW5pdFNpemUud2lkdGgsCiAgICBoZWlnaHQ6IGNvbnRlbnRTaXplLmhlaWdodCArIHVuaXRTaXplLmhlaWdodAogIH07CiAgcmV0dXJuIGdldEFuZ2xlZFJlY3RhbmdsZVdpZHRoKHNpemUsIGFuZ2xlKTsKfQpmdW5jdGlvbiBnZXRUaWNrQm91bmRhcmllcyh2aWV3Qm94LCBzaWduMiwgc2l6ZUtleSkgewogIHZhciBpc1dpZHRoID0gc2l6ZUtleSA9PT0gIndpZHRoIjsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHZpZXdCb3g7CiAgaWYgKHNpZ24yID09PSAxKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogaXNXaWR0aCA/IHgyIDogeTIsCiAgICAgIGVuZDogaXNXaWR0aCA/IHgyICsgd2lkdGggOiB5MiArIGhlaWdodAogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIHN0YXJ0OiBpc1dpZHRoID8geDIgKyB3aWR0aCA6IHkyICsgaGVpZ2h0LAogICAgZW5kOiBpc1dpZHRoID8geDIgOiB5MgogIH07Cn0KZnVuY3Rpb24gaXNWaXNpYmxlKHNpZ24yLCB0aWNrUG9zaXRpb24sIGdldFNpemUsIHN0YXJ0LCBlbmQpIHsKICBpZiAoc2lnbjIgKiB0aWNrUG9zaXRpb24gPCBzaWduMiAqIHN0YXJ0IHx8IHNpZ24yICogdGlja1Bvc2l0aW9uID4gc2lnbjIgKiBlbmQpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgdmFyIHNpemUgPSBnZXRTaXplKCk7CiAgcmV0dXJuIHNpZ24yICogKHRpY2tQb3NpdGlvbiAtIHNpZ24yICogc2l6ZSAvIDIgLSBzdGFydCkgPj0gMCAmJiBzaWduMiAqICh0aWNrUG9zaXRpb24gKyBzaWduMiAqIHNpemUgLyAyIC0gZW5kKSA8PSAwOwp9CmZ1bmN0aW9uIGdldE51bWJlckludGVydmFsVGlja3ModGlja3MyLCBpbnRlcnZhbCkgewogIHJldHVybiBnZXRFdmVyeU50aFdpdGhDb25kaXRpb24odGlja3MyLCBpbnRlcnZhbCArIDEpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9nZXRFcXVpZGlzdGFudFRpY2tzLmpzCmZ1bmN0aW9uIGdldEVxdWlkaXN0YW50VGlja3Moc2lnbjIsIGJvdW5kYXJpZXMsIGdldFRpY2tTaXplLCB0aWNrczIsIG1pblRpY2tHYXApIHsKICB2YXIgcmVzdWx0ID0gKHRpY2tzMiB8fCBbXSkuc2xpY2UoKTsKICB2YXIgewogICAgc3RhcnQ6IGluaXRpYWxTdGFydCwKICAgIGVuZAogIH0gPSBib3VuZGFyaWVzOwogIHZhciBpbmRleCA9IDA7CiAgdmFyIHN0ZXBzaXplID0gMTsKICB2YXIgc3RhcnQgPSBpbml0aWFsU3RhcnQ7CiAgdmFyIF9sb29wID0gZnVuY3Rpb24gX2xvb3AyKCkgewogICAgdmFyIGVudHJ5ID0gdGlja3MyID09PSBudWxsIHx8IHRpY2tzMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogdGlja3MyW2luZGV4XTsKICAgIGlmIChlbnRyeSA9PT0gdm9pZCAwKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdjogZ2V0RXZlcnlOdGhXaXRoQ29uZGl0aW9uKHRpY2tzMiwgc3RlcHNpemUpCiAgICAgIH07CiAgICB9CiAgICB2YXIgaSA9IGluZGV4OwogICAgdmFyIHNpemU7CiAgICB2YXIgZ2V0U2l6ZSA9ICgpID0+IHsKICAgICAgaWYgKHNpemUgPT09IHZvaWQgMCkgewogICAgICAgIHNpemUgPSBnZXRUaWNrU2l6ZShlbnRyeSwgaSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpemU7CiAgICB9OwogICAgdmFyIHRpY2tDb29yZCA9IGVudHJ5LmNvb3JkaW5hdGU7CiAgICB2YXIgaXNTaG93ID0gaW5kZXggPT09IDAgfHwgaXNWaXNpYmxlKHNpZ24yLCB0aWNrQ29vcmQsIGdldFNpemUsIHN0YXJ0LCBlbmQpOwogICAgaWYgKCFpc1Nob3cpIHsKICAgICAgaW5kZXggPSAwOwogICAgICBzdGFydCA9IGluaXRpYWxTdGFydDsKICAgICAgc3RlcHNpemUgKz0gMTsKICAgIH0KICAgIGlmIChpc1Nob3cpIHsKICAgICAgc3RhcnQgPSB0aWNrQ29vcmQgKyBzaWduMiAqIChnZXRTaXplKCkgLyAyICsgbWluVGlja0dhcCk7CiAgICAgIGluZGV4ICs9IHN0ZXBzaXplOwogICAgfQogIH0sIF9yZXQ7CiAgd2hpbGUgKHN0ZXBzaXplIDw9IHJlc3VsdC5sZW5ndGgpIHsKICAgIF9yZXQgPSBfbG9vcCgpOwogICAgaWYgKF9yZXQpIHJldHVybiBfcmV0LnY7CiAgfQogIHJldHVybiBbXTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vZ2V0VGlja3MuanMKZnVuY3Rpb24gb3duS2V5czI3KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjcoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyNyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjkoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjcoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTI5KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjkocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjkodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjkodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjkodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIGdldFRpY2tzRW5kKHNpZ24yLCBib3VuZGFyaWVzLCBnZXRUaWNrU2l6ZSwgdGlja3MyLCBtaW5UaWNrR2FwKSB7CiAgdmFyIHJlc3VsdCA9ICh0aWNrczIgfHwgW10pLnNsaWNlKCk7CiAgdmFyIGxlbiA9IHJlc3VsdC5sZW5ndGg7CiAgdmFyIHsKICAgIHN0YXJ0CiAgfSA9IGJvdW5kYXJpZXM7CiAgdmFyIHsKICAgIGVuZAogIH0gPSBib3VuZGFyaWVzOwogIHZhciBfbG9vcCA9IGZ1bmN0aW9uIF9sb29wMihpMikgewogICAgdmFyIGVudHJ5ID0gcmVzdWx0W2kyXTsKICAgIHZhciBzaXplOwogICAgdmFyIGdldFNpemUgPSAoKSA9PiB7CiAgICAgIGlmIChzaXplID09PSB2b2lkIDApIHsKICAgICAgICBzaXplID0gZ2V0VGlja1NpemUoZW50cnksIGkyKTsKICAgICAgfQogICAgICByZXR1cm4gc2l6ZTsKICAgIH07CiAgICBpZiAoaTIgPT09IGxlbiAtIDEpIHsKICAgICAgdmFyIGdhcCA9IHNpZ24yICogKGVudHJ5LmNvb3JkaW5hdGUgKyBzaWduMiAqIGdldFNpemUoKSAvIDIgLSBlbmQpOwogICAgICByZXN1bHRbaTJdID0gZW50cnkgPSBfb2JqZWN0U3ByZWFkMjcoX29iamVjdFNwcmVhZDI3KHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgdGlja0Nvb3JkOiBnYXAgPiAwID8gZW50cnkuY29vcmRpbmF0ZSAtIGdhcCAqIHNpZ24yIDogZW50cnkuY29vcmRpbmF0ZQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdFtpMl0gPSBlbnRyeSA9IF9vYmplY3RTcHJlYWQyNyhfb2JqZWN0U3ByZWFkMjcoe30sIGVudHJ5KSwge30sIHsKICAgICAgICB0aWNrQ29vcmQ6IGVudHJ5LmNvb3JkaW5hdGUKICAgICAgfSk7CiAgICB9CiAgICBpZiAoZW50cnkudGlja0Nvb3JkICE9IG51bGwpIHsKICAgICAgdmFyIGlzU2hvdyA9IGlzVmlzaWJsZShzaWduMiwgZW50cnkudGlja0Nvb3JkLCBnZXRTaXplLCBzdGFydCwgZW5kKTsKICAgICAgaWYgKGlzU2hvdykgewogICAgICAgIGVuZCA9IGVudHJ5LnRpY2tDb29yZCAtIHNpZ24yICogKGdldFNpemUoKSAvIDIgKyBtaW5UaWNrR2FwKTsKICAgICAgICByZXN1bHRbaTJdID0gX29iamVjdFNwcmVhZDI3KF9vYmplY3RTcHJlYWQyNyh7fSwgZW50cnkpLCB7fSwgewogICAgICAgICAgaXNTaG93OiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9OwogIGZvciAodmFyIGkgPSBsZW4gLSAxOyBpID49IDA7IGktLSkgewogICAgX2xvb3AoaSk7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gZ2V0VGlja3NTdGFydChzaWduMiwgYm91bmRhcmllcywgZ2V0VGlja1NpemUsIHRpY2tzMiwgbWluVGlja0dhcCwgcHJlc2VydmVFbmQpIHsKICB2YXIgcmVzdWx0ID0gKHRpY2tzMiB8fCBbXSkuc2xpY2UoKTsKICB2YXIgbGVuID0gcmVzdWx0Lmxlbmd0aDsKICB2YXIgewogICAgc3RhcnQsCiAgICBlbmQKICB9ID0gYm91bmRhcmllczsKICBpZiAocHJlc2VydmVFbmQpIHsKICAgIHZhciB0YWlsID0gdGlja3MyW2xlbiAtIDFdOwogICAgdmFyIHRhaWxTaXplID0gZ2V0VGlja1NpemUodGFpbCwgbGVuIC0gMSk7CiAgICB2YXIgdGFpbEdhcCA9IHNpZ24yICogKHRhaWwuY29vcmRpbmF0ZSArIHNpZ24yICogdGFpbFNpemUgLyAyIC0gZW5kKTsKICAgIHJlc3VsdFtsZW4gLSAxXSA9IHRhaWwgPSBfb2JqZWN0U3ByZWFkMjcoX29iamVjdFNwcmVhZDI3KHt9LCB0YWlsKSwge30sIHsKICAgICAgdGlja0Nvb3JkOiB0YWlsR2FwID4gMCA/IHRhaWwuY29vcmRpbmF0ZSAtIHRhaWxHYXAgKiBzaWduMiA6IHRhaWwuY29vcmRpbmF0ZQogICAgfSk7CiAgICBpZiAodGFpbC50aWNrQ29vcmQgIT0gbnVsbCkgewogICAgICB2YXIgaXNUYWlsU2hvdyA9IGlzVmlzaWJsZShzaWduMiwgdGFpbC50aWNrQ29vcmQsICgpID0+IHRhaWxTaXplLCBzdGFydCwgZW5kKTsKICAgICAgaWYgKGlzVGFpbFNob3cpIHsKICAgICAgICBlbmQgPSB0YWlsLnRpY2tDb29yZCAtIHNpZ24yICogKHRhaWxTaXplIC8gMiArIG1pblRpY2tHYXApOwogICAgICAgIHJlc3VsdFtsZW4gLSAxXSA9IF9vYmplY3RTcHJlYWQyNyhfb2JqZWN0U3ByZWFkMjcoe30sIHRhaWwpLCB7fSwgewogICAgICAgICAgaXNTaG93OiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9CiAgdmFyIGNvdW50ID0gcHJlc2VydmVFbmQgPyBsZW4gLSAxIDogbGVuOwogIHZhciBfbG9vcDIgPSBmdW5jdGlvbiBfbG9vcDIyKGkyKSB7CiAgICB2YXIgZW50cnkgPSByZXN1bHRbaTJdOwogICAgdmFyIHNpemU7CiAgICB2YXIgZ2V0U2l6ZSA9ICgpID0+IHsKICAgICAgaWYgKHNpemUgPT09IHZvaWQgMCkgewogICAgICAgIHNpemUgPSBnZXRUaWNrU2l6ZShlbnRyeSwgaTIpOwogICAgICB9CiAgICAgIHJldHVybiBzaXplOwogICAgfTsKICAgIGlmIChpMiA9PT0gMCkgewogICAgICB2YXIgZ2FwID0gc2lnbjIgKiAoZW50cnkuY29vcmRpbmF0ZSAtIHNpZ24yICogZ2V0U2l6ZSgpIC8gMiAtIHN0YXJ0KTsKICAgICAgcmVzdWx0W2kyXSA9IGVudHJ5ID0gX29iamVjdFNwcmVhZDI3KF9vYmplY3RTcHJlYWQyNyh7fSwgZW50cnkpLCB7fSwgewogICAgICAgIHRpY2tDb29yZDogZ2FwIDwgMCA/IGVudHJ5LmNvb3JkaW5hdGUgLSBnYXAgKiBzaWduMiA6IGVudHJ5LmNvb3JkaW5hdGUKICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICByZXN1bHRbaTJdID0gZW50cnkgPSBfb2JqZWN0U3ByZWFkMjcoX29iamVjdFNwcmVhZDI3KHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgdGlja0Nvb3JkOiBlbnRyeS5jb29yZGluYXRlCiAgICAgIH0pOwogICAgfQogICAgaWYgKGVudHJ5LnRpY2tDb29yZCAhPSBudWxsKSB7CiAgICAgIHZhciBpc1Nob3cgPSBpc1Zpc2libGUoc2lnbjIsIGVudHJ5LnRpY2tDb29yZCwgZ2V0U2l6ZSwgc3RhcnQsIGVuZCk7CiAgICAgIGlmIChpc1Nob3cpIHsKICAgICAgICBzdGFydCA9IGVudHJ5LnRpY2tDb29yZCArIHNpZ24yICogKGdldFNpemUoKSAvIDIgKyBtaW5UaWNrR2FwKTsKICAgICAgICByZXN1bHRbaTJdID0gX29iamVjdFNwcmVhZDI3KF9vYmplY3RTcHJlYWQyNyh7fSwgZW50cnkpLCB7fSwgewogICAgICAgICAgaXNTaG93OiB0cnVlCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9OwogIGZvciAodmFyIGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgX2xvb3AyKGkpOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIGdldFRpY2tzKHByb3BzLCBmb250U2l6ZSwgbGV0dGVyU3BhY2luZykgewogIHZhciB7CiAgICB0aWNrLAogICAgdGlja3M6IHRpY2tzMiwKICAgIHZpZXdCb3gsCiAgICBtaW5UaWNrR2FwLAogICAgb3JpZW50YXRpb24sCiAgICBpbnRlcnZhbCwKICAgIHRpY2tGb3JtYXR0ZXIsCiAgICB1bml0OiB1bml0MiwKICAgIGFuZ2xlCiAgfSA9IHByb3BzOwogIGlmICghdGlja3MyIHx8ICF0aWNrczIubGVuZ3RoIHx8ICF0aWNrKSB7CiAgICByZXR1cm4gW107CiAgfQogIGlmIChpc051bWJlcihpbnRlcnZhbCkgfHwgR2xvYmFsLmlzU3NyKSB7CiAgICB2YXIgX2dldE51bWJlckludGVydmFsVGljOwogICAgcmV0dXJuIChfZ2V0TnVtYmVySW50ZXJ2YWxUaWMgPSBnZXROdW1iZXJJbnRlcnZhbFRpY2tzKHRpY2tzMiwgaXNOdW1iZXIoaW50ZXJ2YWwpID8gaW50ZXJ2YWwgOiAwKSkgIT09IG51bGwgJiYgX2dldE51bWJlckludGVydmFsVGljICE9PSB2b2lkIDAgPyBfZ2V0TnVtYmVySW50ZXJ2YWxUaWMgOiBbXTsKICB9CiAgdmFyIGNhbmRpZGF0ZXMgPSBbXTsKICB2YXIgc2l6ZUtleSA9IG9yaWVudGF0aW9uID09PSAidG9wIiB8fCBvcmllbnRhdGlvbiA9PT0gImJvdHRvbSIgPyAid2lkdGgiIDogImhlaWdodCI7CiAgdmFyIHVuaXRTaXplID0gdW5pdDIgJiYgc2l6ZUtleSA9PT0gIndpZHRoIiA/IGdldFN0cmluZ1NpemUodW5pdDIsIHsKICAgIGZvbnRTaXplLAogICAgbGV0dGVyU3BhY2luZwogIH0pIDogewogICAgd2lkdGg6IDAsCiAgICBoZWlnaHQ6IDAKICB9OwogIHZhciBnZXRUaWNrU2l6ZSA9IChjb250ZW50LCBpbmRleCkgPT4gewogICAgdmFyIHZhbHVlID0gdHlwZW9mIHRpY2tGb3JtYXR0ZXIgPT09ICJmdW5jdGlvbiIgPyB0aWNrRm9ybWF0dGVyKGNvbnRlbnQudmFsdWUsIGluZGV4KSA6IGNvbnRlbnQudmFsdWU7CiAgICByZXR1cm4gc2l6ZUtleSA9PT0gIndpZHRoIiA/IGdldEFuZ2xlZFRpY2tXaWR0aChnZXRTdHJpbmdTaXplKHZhbHVlLCB7CiAgICAgIGZvbnRTaXplLAogICAgICBsZXR0ZXJTcGFjaW5nCiAgICB9KSwgdW5pdFNpemUsIGFuZ2xlKSA6IGdldFN0cmluZ1NpemUodmFsdWUsIHsKICAgICAgZm9udFNpemUsCiAgICAgIGxldHRlclNwYWNpbmcKICAgIH0pW3NpemVLZXldOwogIH07CiAgdmFyIHNpZ24yID0gdGlja3MyLmxlbmd0aCA+PSAyID8gbWF0aFNpZ24odGlja3MyWzFdLmNvb3JkaW5hdGUgLSB0aWNrczJbMF0uY29vcmRpbmF0ZSkgOiAxOwogIHZhciBib3VuZGFyaWVzID0gZ2V0VGlja0JvdW5kYXJpZXModmlld0JveCwgc2lnbjIsIHNpemVLZXkpOwogIGlmIChpbnRlcnZhbCA9PT0gImVxdWlkaXN0YW50UHJlc2VydmVTdGFydCIpIHsKICAgIHJldHVybiBnZXRFcXVpZGlzdGFudFRpY2tzKHNpZ24yLCBib3VuZGFyaWVzLCBnZXRUaWNrU2l6ZSwgdGlja3MyLCBtaW5UaWNrR2FwKTsKICB9CiAgaWYgKGludGVydmFsID09PSAicHJlc2VydmVTdGFydCIgfHwgaW50ZXJ2YWwgPT09ICJwcmVzZXJ2ZVN0YXJ0RW5kIikgewogICAgY2FuZGlkYXRlcyA9IGdldFRpY2tzU3RhcnQoc2lnbjIsIGJvdW5kYXJpZXMsIGdldFRpY2tTaXplLCB0aWNrczIsIG1pblRpY2tHYXAsIGludGVydmFsID09PSAicHJlc2VydmVTdGFydEVuZCIpOwogIH0gZWxzZSB7CiAgICBjYW5kaWRhdGVzID0gZ2V0VGlja3NFbmQoc2lnbjIsIGJvdW5kYXJpZXMsIGdldFRpY2tTaXplLCB0aWNrczIsIG1pblRpY2tHYXApOwogIH0KICByZXR1cm4gY2FuZGlkYXRlcy5maWx0ZXIoKGVudHJ5KSA9PiBlbnRyeS5pc1Nob3cpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvWUF4aXNVdGlscy5qcwp2YXIgZ2V0Q2FsY3VsYXRlZFlBeGlzV2lkdGggPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgdGlja3M6IHRpY2tzMiwKICAgIGxhYmVsLAogICAgbGFiZWxHYXBXaXRoVGljayA9IDUsCiAgICAvLyBEZWZhdWx0IGdhcCBiZXR3ZWVuIGxhYmVsIGFuZCB0aWNrCiAgICB0aWNrU2l6ZSA9IDAsCiAgICB0aWNrTWFyZ2luID0gMAogIH0gPSBfcmVmMjsKICB2YXIgbWF4VGlja1dpZHRoID0gMDsKICBpZiAodGlja3MyKSB7CiAgICBBcnJheS5mcm9tKHRpY2tzMikuZm9yRWFjaCgodGlja05vZGUpID0+IHsKICAgICAgaWYgKHRpY2tOb2RlKSB7CiAgICAgICAgdmFyIGJib3ggPSB0aWNrTm9kZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICBpZiAoYmJveC53aWR0aCA+IG1heFRpY2tXaWR0aCkgewogICAgICAgICAgbWF4VGlja1dpZHRoID0gYmJveC53aWR0aDsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdmFyIGxhYmVsV2lkdGggPSBsYWJlbCA/IGxhYmVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoIDogMDsKICAgIHZhciB0aWNrV2lkdGggPSB0aWNrU2l6ZSArIHRpY2tNYXJnaW47CiAgICB2YXIgdXBkYXRlZFlBeGlzV2lkdGggPSBtYXhUaWNrV2lkdGggKyB0aWNrV2lkdGggKyBsYWJlbFdpZHRoICsgKGxhYmVsID8gbGFiZWxHYXBXaXRoVGljayA6IDApOwogICAgcmV0dXJuIE1hdGgucm91bmQodXBkYXRlZFlBeGlzV2lkdGgpOwogIH0KICByZXR1cm4gMDsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL0NhcnRlc2lhbkF4aXMuanMKdmFyIF9leGNsdWRlZDEwID0gWyJheGlzTGluZSIsICJ3aWR0aCIsICJoZWlnaHQiLCAiY2xhc3NOYW1lIiwgImhpZGUiLCAidGlja3MiLCAiYXhpc1R5cGUiXTsKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTAoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTEwKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMChyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX2V4dGVuZHMxNSgpIHsKICByZXR1cm4gX2V4dGVuZHMxNSA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTUuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzMjgoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyOChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czI4KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkzMChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyOChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MzAoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkzMChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzMCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUzMCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUzMCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMgPSB7CiAgeDogMCwKICB5OiAwLAogIHdpZHRoOiAwLAogIGhlaWdodDogMCwKICB2aWV3Qm94OiB7CiAgICB4OiAwLAogICAgeTogMCwKICAgIHdpZHRoOiAwLAogICAgaGVpZ2h0OiAwCiAgfSwKICAvLyBUaGUgb3JpZW50YXRpb24gb2YgYXhpcwogIG9yaWVudGF0aW9uOiAiYm90dG9tIiwKICAvLyBUaGUgdGlja3MKICB0aWNrczogW10sCiAgc3Ryb2tlOiAiIzY2NiIsCiAgdGlja0xpbmU6IHRydWUsCiAgYXhpc0xpbmU6IHRydWUsCiAgdGljazogdHJ1ZSwKICBtaXJyb3I6IGZhbHNlLAogIG1pblRpY2tHYXA6IDUsCiAgLy8gVGhlIHdpZHRoIG9yIGhlaWdodCBvZiB0aWNrCiAgdGlja1NpemU6IDYsCiAgdGlja01hcmdpbjogMiwKICBpbnRlcnZhbDogInByZXNlcnZlRW5kIiwKICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5heGlzCn07CmZ1bmN0aW9uIEF4aXNMaW5lKGF4aXNMaW5lUHJvcHMpIHsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgb3JpZW50YXRpb24sCiAgICBtaXJyb3IsCiAgICBheGlzTGluZSwKICAgIG90aGVyU3ZnUHJvcHMKICB9ID0gYXhpc0xpbmVQcm9wczsKICBpZiAoIWF4aXNMaW5lKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHByb3BzID0gX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoe30sIG90aGVyU3ZnUHJvcHMpLCBzdmdQcm9wZXJ0aWVzTm9FdmVudHMoYXhpc0xpbmUpKSwge30sIHsKICAgIGZpbGw6ICJub25lIgogIH0pOwogIGlmIChvcmllbnRhdGlvbiA9PT0gInRvcCIgfHwgb3JpZW50YXRpb24gPT09ICJib3R0b20iKSB7CiAgICB2YXIgbmVlZEhlaWdodCA9ICsob3JpZW50YXRpb24gPT09ICJ0b3AiICYmICFtaXJyb3IgfHwgb3JpZW50YXRpb24gPT09ICJib3R0b20iICYmIG1pcnJvcik7CiAgICBwcm9wcyA9IF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoe30sIHByb3BzKSwge30sIHsKICAgICAgeDE6IHgyLAogICAgICB5MTogeTIgKyBuZWVkSGVpZ2h0ICogaGVpZ2h0LAogICAgICB4MjogeDIgKyB3aWR0aCwKICAgICAgeTI6IHkyICsgbmVlZEhlaWdodCAqIGhlaWdodAogICAgfSk7CiAgfSBlbHNlIHsKICAgIHZhciBuZWVkV2lkdGggPSArKG9yaWVudGF0aW9uID09PSAibGVmdCIgJiYgIW1pcnJvciB8fCBvcmllbnRhdGlvbiA9PT0gInJpZ2h0IiAmJiBtaXJyb3IpOwogICAgcHJvcHMgPSBfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KHt9LCBwcm9wcyksIHt9LCB7CiAgICAgIHgxOiB4MiArIG5lZWRXaWR0aCAqIHdpZHRoLAogICAgICB5MTogeTIsCiAgICAgIHgyOiB4MiArIG5lZWRXaWR0aCAqIHdpZHRoLAogICAgICB5MjogeTIgKyBoZWlnaHQKICAgIH0pOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudCgibGluZSIsIF9leHRlbmRzMTUoe30sIHByb3BzLCB7CiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLWxpbmUiLCAoMCwgaW1wb3J0X2dldDMuZGVmYXVsdCkoYXhpc0xpbmUsICJjbGFzc05hbWUiKSkKICB9KSk7Cn0KZnVuY3Rpb24gZ2V0VGlja0xpbmVDb29yZChkYXRhLCB4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIG9yaWVudGF0aW9uLCB0aWNrU2l6ZSwgbWlycm9yLCB0aWNrTWFyZ2luKSB7CiAgdmFyIHgxLCB4MjIsIHkxLCB5MjIsIHR4LCB0eTsKICB2YXIgc2lnbjIgPSBtaXJyb3IgPyAtMSA6IDE7CiAgdmFyIGZpbmFsVGlja1NpemUgPSBkYXRhLnRpY2tTaXplIHx8IHRpY2tTaXplOwogIHZhciB0aWNrQ29vcmQgPSBpc051bWJlcihkYXRhLnRpY2tDb29yZCkgPyBkYXRhLnRpY2tDb29yZCA6IGRhdGEuY29vcmRpbmF0ZTsKICBzd2l0Y2ggKG9yaWVudGF0aW9uKSB7CiAgICBjYXNlICJ0b3AiOgogICAgICB4MSA9IHgyMiA9IGRhdGEuY29vcmRpbmF0ZTsKICAgICAgeTIyID0geTIgKyArIW1pcnJvciAqIGhlaWdodDsKICAgICAgeTEgPSB5MjIgLSBzaWduMiAqIGZpbmFsVGlja1NpemU7CiAgICAgIHR5ID0geTEgLSBzaWduMiAqIHRpY2tNYXJnaW47CiAgICAgIHR4ID0gdGlja0Nvb3JkOwogICAgICBicmVhazsKICAgIGNhc2UgImxlZnQiOgogICAgICB5MSA9IHkyMiA9IGRhdGEuY29vcmRpbmF0ZTsKICAgICAgeDIyID0geDIgKyArIW1pcnJvciAqIHdpZHRoOwogICAgICB4MSA9IHgyMiAtIHNpZ24yICogZmluYWxUaWNrU2l6ZTsKICAgICAgdHggPSB4MSAtIHNpZ24yICogdGlja01hcmdpbjsKICAgICAgdHkgPSB0aWNrQ29vcmQ7CiAgICAgIGJyZWFrOwogICAgY2FzZSAicmlnaHQiOgogICAgICB5MSA9IHkyMiA9IGRhdGEuY29vcmRpbmF0ZTsKICAgICAgeDIyID0geDIgKyArbWlycm9yICogd2lkdGg7CiAgICAgIHgxID0geDIyICsgc2lnbjIgKiBmaW5hbFRpY2tTaXplOwogICAgICB0eCA9IHgxICsgc2lnbjIgKiB0aWNrTWFyZ2luOwogICAgICB0eSA9IHRpY2tDb29yZDsKICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICB4MSA9IHgyMiA9IGRhdGEuY29vcmRpbmF0ZTsKICAgICAgeTIyID0geTIgKyArbWlycm9yICogaGVpZ2h0OwogICAgICB5MSA9IHkyMiArIHNpZ24yICogZmluYWxUaWNrU2l6ZTsKICAgICAgdHkgPSB5MSArIHNpZ24yICogdGlja01hcmdpbjsKICAgICAgdHggPSB0aWNrQ29vcmQ7CiAgICAgIGJyZWFrOwogIH0KICByZXR1cm4gewogICAgbGluZTogewogICAgICB4MSwKICAgICAgeTEsCiAgICAgIHgyOiB4MjIsCiAgICAgIHkyOiB5MjIKICAgIH0sCiAgICB0aWNrOiB7CiAgICAgIHg6IHR4LAogICAgICB5OiB0eQogICAgfQogIH07Cn0KZnVuY3Rpb24gZ2V0VGlja1RleHRBbmNob3Iob3JpZW50YXRpb24sIG1pcnJvcikgewogIHN3aXRjaCAob3JpZW50YXRpb24pIHsKICAgIGNhc2UgImxlZnQiOgogICAgICByZXR1cm4gbWlycm9yID8gInN0YXJ0IiA6ICJlbmQiOwogICAgY2FzZSAicmlnaHQiOgogICAgICByZXR1cm4gbWlycm9yID8gImVuZCIgOiAic3RhcnQiOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuICJtaWRkbGUiOwogIH0KfQpmdW5jdGlvbiBnZXRUaWNrVmVydGljYWxBbmNob3Iob3JpZW50YXRpb24sIG1pcnJvcikgewogIHN3aXRjaCAob3JpZW50YXRpb24pIHsKICAgIGNhc2UgImxlZnQiOgogICAgY2FzZSAicmlnaHQiOgogICAgICByZXR1cm4gIm1pZGRsZSI7CiAgICBjYXNlICJ0b3AiOgogICAgICByZXR1cm4gbWlycm9yID8gInN0YXJ0IiA6ICJlbmQiOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIG1pcnJvciA/ICJlbmQiIDogInN0YXJ0IjsKICB9Cn0KZnVuY3Rpb24gVGlja0l0ZW0ocHJvcHMpIHsKICB2YXIgewogICAgb3B0aW9uLAogICAgdGlja1Byb3BzLAogICAgdmFsdWUKICB9ID0gcHJvcHM7CiAgdmFyIHRpY2tJdGVtOwogIHZhciBjb21iaW5lZENsYXNzTmFtZSA9IGNsc3godGlja1Byb3BzLmNsYXNzTmFtZSwgInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stdmFsdWUiKTsKICBpZiAoLyogQF9fUFVSRV9fICovIFJlYWN0MjQuaXNWYWxpZEVsZW1lbnQob3B0aW9uKSkgewogICAgdGlja0l0ZW0gPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jbG9uZUVsZW1lbnQob3B0aW9uLCBfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KHt9LCB0aWNrUHJvcHMpLCB7fSwgewogICAgICBjbGFzc05hbWU6IGNvbWJpbmVkQ2xhc3NOYW1lCiAgICB9KSk7CiAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICB0aWNrSXRlbSA9IG9wdGlvbihfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KHt9LCB0aWNrUHJvcHMpLCB7fSwgewogICAgICBjbGFzc05hbWU6IGNvbWJpbmVkQ2xhc3NOYW1lCiAgICB9KSk7CiAgfSBlbHNlIHsKICAgIHZhciBjbGFzc05hbWUgPSAicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljay12YWx1ZSI7CiAgICBpZiAodHlwZW9mIG9wdGlvbiAhPT0gImJvb2xlYW4iKSB7CiAgICAgIGNsYXNzTmFtZSA9IGNsc3goY2xhc3NOYW1lLCBvcHRpb24gPT09IG51bGwgfHwgb3B0aW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb24uY2xhc3NOYW1lKTsKICAgIH0KICAgIHRpY2tJdGVtID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChUZXh0LCBfZXh0ZW5kczE1KHt9LCB0aWNrUHJvcHMsIHsKICAgICAgY2xhc3NOYW1lCiAgICB9KSwgdmFsdWUpOwogIH0KICByZXR1cm4gdGlja0l0ZW07Cn0KdmFyIFRpY2tzID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzNy5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICB0aWNrczogdGlja3MyID0gW10sCiAgICB0aWNrLAogICAgdGlja0xpbmUsCiAgICBzdHJva2UsCiAgICB0aWNrRm9ybWF0dGVyLAogICAgdW5pdDogdW5pdDIsCiAgICBwYWRkaW5nLAogICAgdGlja1RleHRQcm9wcywKICAgIG9yaWVudGF0aW9uLAogICAgbWlycm9yLAogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgdGlja1NpemUsCiAgICB0aWNrTWFyZ2luLAogICAgZm9udFNpemUsCiAgICBsZXR0ZXJTcGFjaW5nLAogICAgZ2V0VGlja3NDb25maWcsCiAgICBldmVudHMsCiAgICBheGlzVHlwZQogIH0gPSBwcm9wczsKICB2YXIgZmluYWxUaWNrcyA9IGdldFRpY2tzKF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoe30sIGdldFRpY2tzQ29uZmlnKSwge30sIHsKICAgIHRpY2tzOiB0aWNrczIKICB9KSwgZm9udFNpemUsIGxldHRlclNwYWNpbmcpOwogIHZhciB0ZXh0QW5jaG9yID0gZ2V0VGlja1RleHRBbmNob3Iob3JpZW50YXRpb24sIG1pcnJvcik7CiAgdmFyIHZlcnRpY2FsQW5jaG9yID0gZ2V0VGlja1ZlcnRpY2FsQW5jaG9yKG9yaWVudGF0aW9uLCBtaXJyb3IpOwogIHZhciBheGlzUHJvcHMgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHMoZ2V0VGlja3NDb25maWcpOwogIHZhciBjdXN0b21UaWNrUHJvcHMgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHNGcm9tVW5rbm93bih0aWNrKTsKICB2YXIgdGlja0xpbmVQcm9wc09iamVjdCA9IHt9OwogIGlmICh0eXBlb2YgdGlja0xpbmUgPT09ICJvYmplY3QiKSB7CiAgICB0aWNrTGluZVByb3BzT2JqZWN0ID0gdGlja0xpbmU7CiAgfQogIHZhciB0aWNrTGluZVByb3BzID0gX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7fSwgYXhpc1Byb3BzKSwge30sIHsKICAgIGZpbGw6ICJub25lIgogIH0sIHRpY2tMaW5lUHJvcHNPYmplY3QpOwogIHZhciB0aWNrTGluZUNvb3JkcyA9IGZpbmFsVGlja3MubWFwKChlbnRyeSkgPT4gX29iamVjdFNwcmVhZDI4KHsKICAgIGVudHJ5CiAgfSwgZ2V0VGlja0xpbmVDb29yZChlbnRyeSwgeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCBvcmllbnRhdGlvbiwgdGlja1NpemUsIG1pcnJvciwgdGlja01hcmdpbikpKTsKICB2YXIgdGlja0xpbmVzID0gdGlja0xpbmVDb29yZHMubWFwKChfcmVmMikgPT4gewogICAgdmFyIHsKICAgICAgZW50cnksCiAgICAgIGxpbmU6IGxpbmVDb29yZAogICAgfSA9IF9yZWYyOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljayIsCiAgICAgIGtleTogInRpY2stIi5jb25jYXQoZW50cnkudmFsdWUsICItIikuY29uY2F0KGVudHJ5LmNvb3JkaW5hdGUsICItIikuY29uY2F0KGVudHJ5LnRpY2tDb29yZCkKICAgIH0sIHRpY2tMaW5lICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoImxpbmUiLCBfZXh0ZW5kczE1KHt9LCB0aWNrTGluZVByb3BzLCBsaW5lQ29vcmQsIHsKICAgICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLWxpbmUiLCAoMCwgaW1wb3J0X2dldDMuZGVmYXVsdCkodGlja0xpbmUsICJjbGFzc05hbWUiKSkKICAgIH0pKSk7CiAgfSk7CiAgdmFyIHRpY2tMYWJlbHMgPSB0aWNrTGluZUNvb3Jkcy5tYXAoKF9yZWYyLCBpKSA9PiB7CiAgICB2YXIgewogICAgICBlbnRyeSwKICAgICAgdGljazogdGlja0Nvb3JkCiAgICB9ID0gX3JlZjI7CiAgICB2YXIgdGlja1Byb3BzID0gX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KHsKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciB0ZXh0QW5jaG9yIGZyb20gYXhpc1Byb3BzIGlzIHR5cGVkIGFzIGBzdHJpbmdgIGJ1dCBUZXh0IHdhbnRzIHR5cGUgYFRleHRBbmNob3JgCiAgICAgIHRleHRBbmNob3IsCiAgICAgIHZlcnRpY2FsQW5jaG9yCiAgICB9LCBheGlzUHJvcHMpLCB7fSwgewogICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGN1c3RvbVRpY2tQcm9wcyBpcyBjb250cmlidXRpbmcgdW5rbm93biBwcm9wcwogICAgICBzdHJva2U6ICJub25lIiwKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBjdXN0b21UaWNrUHJvcHMgaXMgY29udHJpYnV0aW5nIHVua25vd24gcHJvcHMKICAgICAgZmlsbDogc3Ryb2tlCiAgICB9LCBjdXN0b21UaWNrUHJvcHMpLCB0aWNrQ29vcmQpLCB7fSwgewogICAgICBpbmRleDogaSwKICAgICAgcGF5bG9hZDogZW50cnksCiAgICAgIHZpc2libGVUaWNrc0NvdW50OiBmaW5hbFRpY2tzLmxlbmd0aCwKICAgICAgdGlja0Zvcm1hdHRlciwKICAgICAgcGFkZGluZwogICAgfSwgdGlja1RleHRQcm9wcyk7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChMYXllciwgX2V4dGVuZHMxNSh7CiAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stbGFiZWwiLAogICAgICBrZXk6ICJ0aWNrLWxhYmVsLSIuY29uY2F0KGVudHJ5LnZhbHVlLCAiLSIpLmNvbmNhdChlbnRyeS5jb29yZGluYXRlLCAiLSIpLmNvbmNhdChlbnRyeS50aWNrQ29vcmQpCiAgICB9LCBhZGFwdEV2ZW50c09mQ2hpbGQoZXZlbnRzLCBlbnRyeSwgaSkpLCB0aWNrICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoVGlja0l0ZW0sIHsKICAgICAgb3B0aW9uOiB0aWNrLAogICAgICB0aWNrUHJvcHMsCiAgICAgIHZhbHVlOiAiIi5jb25jYXQodHlwZW9mIHRpY2tGb3JtYXR0ZXIgPT09ICJmdW5jdGlvbiIgPyB0aWNrRm9ybWF0dGVyKGVudHJ5LnZhbHVlLCBpKSA6IGVudHJ5LnZhbHVlKS5jb25jYXQodW5pdDIgfHwgIiIpCiAgICB9KSk7CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrcyByZWNoYXJ0cy0iLmNvbmNhdChheGlzVHlwZSwgIi10aWNrcyIpCiAgfSwgdGlja0xhYmVscy5sZW5ndGggPiAwICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoWkluZGV4TGF5ZXIsIHsKICAgIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmxhYmVsCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudCgiZyIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stbGFiZWxzIHJlY2hhcnRzLSIuY29uY2F0KGF4aXNUeXBlLCAiLXRpY2stbGFiZWxzIiksCiAgICByZWYKICB9LCB0aWNrTGFiZWxzKSksIHRpY2tMaW5lcy5sZW5ndGggPiAwICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLWxpbmVzIHJlY2hhcnRzLSIuY29uY2F0KGF4aXNUeXBlLCAiLXRpY2stbGluZXMiKQogIH0sIHRpY2tMaW5lcykpOwp9KTsKdmFyIENhcnRlc2lhbkF4aXNDb21wb25lbnQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDM3LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIGF4aXNMaW5lLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBjbGFzc05hbWUsCiAgICBoaWRlLAogICAgdGlja3M6IHRpY2tzMiwKICAgIGF4aXNUeXBlCiAgfSA9IHByb3BzLCByZXN0ID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTAocHJvcHMsIF9leGNsdWRlZDEwKTsKICB2YXIgW2ZvbnRTaXplLCBzZXRGb250U2l6ZV0gPSAoMCwgaW1wb3J0X3JlYWN0MzcudXNlU3RhdGUpKCIiKTsKICB2YXIgW2xldHRlclNwYWNpbmcsIHNldExldHRlclNwYWNpbmddID0gKDAsIGltcG9ydF9yZWFjdDM3LnVzZVN0YXRlKSgiIik7CiAgdmFyIHRpY2tSZWZzID0gKDAsIGltcG9ydF9yZWFjdDM3LnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDM3LnVzZUltcGVyYXRpdmVIYW5kbGUpKHJlZiwgKCkgPT4gKHsKICAgIGdldENhbGN1bGF0ZWRXaWR0aDogKCkgPT4gewogICAgICB2YXIgX3Byb3BzJGxhYmVsUmVmOwogICAgICByZXR1cm4gZ2V0Q2FsY3VsYXRlZFlBeGlzV2lkdGgoewogICAgICAgIHRpY2tzOiB0aWNrUmVmcy5jdXJyZW50LAogICAgICAgIGxhYmVsOiAoX3Byb3BzJGxhYmVsUmVmID0gcHJvcHMubGFiZWxSZWYpID09PSBudWxsIHx8IF9wcm9wcyRsYWJlbFJlZiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3Byb3BzJGxhYmVsUmVmLmN1cnJlbnQsCiAgICAgICAgbGFiZWxHYXBXaXRoVGljazogNSwKICAgICAgICB0aWNrU2l6ZTogcHJvcHMudGlja1NpemUsCiAgICAgICAgdGlja01hcmdpbjogcHJvcHMudGlja01hcmdpbgogICAgICB9KTsKICAgIH0KICB9KSk7CiAgdmFyIGxheWVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDM3LnVzZUNhbGxiYWNrKSgoZWwpID0+IHsKICAgIGlmIChlbCkgewogICAgICB2YXIgdGlja05vZGVzID0gZWwuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljay12YWx1ZSIpOwogICAgICB0aWNrUmVmcy5jdXJyZW50ID0gdGlja05vZGVzOwogICAgICB2YXIgdGljayA9IHRpY2tOb2Rlc1swXTsKICAgICAgaWYgKHRpY2spIHsKICAgICAgICB2YXIgY29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKHRpY2spOwogICAgICAgIHZhciBjYWxjdWxhdGVkRm9udFNpemUgPSBjb21wdXRlZFN0eWxlLmZvbnRTaXplOwogICAgICAgIHZhciBjYWxjdWxhdGVkTGV0dGVyU3BhY2luZyA9IGNvbXB1dGVkU3R5bGUubGV0dGVyU3BhY2luZzsKICAgICAgICBpZiAoY2FsY3VsYXRlZEZvbnRTaXplICE9PSBmb250U2l6ZSB8fCBjYWxjdWxhdGVkTGV0dGVyU3BhY2luZyAhPT0gbGV0dGVyU3BhY2luZykgewogICAgICAgICAgc2V0Rm9udFNpemUoY2FsY3VsYXRlZEZvbnRTaXplKTsKICAgICAgICAgIHNldExldHRlclNwYWNpbmcoY2FsY3VsYXRlZExldHRlclNwYWNpbmcpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0sIFtmb250U2l6ZSwgbGV0dGVyU3BhY2luZ10pOwogIGlmIChoaWRlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgaWYgKHdpZHRoICE9IG51bGwgJiYgd2lkdGggPD0gMCB8fCBoZWlnaHQgIT0gbnVsbCAmJiBoZWlnaHQgPD0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IHByb3BzLnpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIHsKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtY2FydGVzaWFuLWF4aXMiLCBjbGFzc05hbWUpCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChBeGlzTGluZSwgewogICAgeDogcHJvcHMueCwKICAgIHk6IHByb3BzLnksCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIG9yaWVudGF0aW9uOiBwcm9wcy5vcmllbnRhdGlvbiwKICAgIG1pcnJvcjogcHJvcHMubWlycm9yLAogICAgYXhpc0xpbmUsCiAgICBvdGhlclN2Z1Byb3BzOiBzdmdQcm9wZXJ0aWVzTm9FdmVudHMocHJvcHMpCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoVGlja3MsIHsKICAgIHJlZjogbGF5ZXJSZWYsCiAgICBheGlzVHlwZSwKICAgIGV2ZW50czogcmVzdCwKICAgIGZvbnRTaXplLAogICAgZ2V0VGlja3NDb25maWc6IHByb3BzLAogICAgaGVpZ2h0OiBwcm9wcy5oZWlnaHQsCiAgICBsZXR0ZXJTcGFjaW5nLAogICAgbWlycm9yOiBwcm9wcy5taXJyb3IsCiAgICBvcmllbnRhdGlvbjogcHJvcHMub3JpZW50YXRpb24sCiAgICBwYWRkaW5nOiBwcm9wcy5wYWRkaW5nLAogICAgc3Ryb2tlOiBwcm9wcy5zdHJva2UsCiAgICB0aWNrOiBwcm9wcy50aWNrLAogICAgdGlja0Zvcm1hdHRlcjogcHJvcHMudGlja0Zvcm1hdHRlciwKICAgIHRpY2tMaW5lOiBwcm9wcy50aWNrTGluZSwKICAgIHRpY2tNYXJnaW46IHByb3BzLnRpY2tNYXJnaW4sCiAgICB0aWNrU2l6ZTogcHJvcHMudGlja1NpemUsCiAgICB0aWNrVGV4dFByb3BzOiBwcm9wcy50aWNrVGV4dFByb3BzLAogICAgdGlja3M6IHRpY2tzMiwKICAgIHVuaXQ6IHByb3BzLnVuaXQsCiAgICB3aWR0aDogcHJvcHMud2lkdGgsCiAgICB4OiBwcm9wcy54LAogICAgeTogcHJvcHMueQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkxhYmVsQ29udGV4dFByb3ZpZGVyLCB7CiAgICB4OiBwcm9wcy54LAogICAgeTogcHJvcHMueSwKICAgIHdpZHRoOiBwcm9wcy53aWR0aCwKICAgIGhlaWdodDogcHJvcHMuaGVpZ2h0LAogICAgbG93ZXJXaWR0aDogcHJvcHMud2lkdGgsCiAgICB1cHBlcldpZHRoOiBwcm9wcy53aWR0aAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoQ2FydGVzaWFuTGFiZWxGcm9tTGFiZWxQcm9wLCB7CiAgICBsYWJlbDogcHJvcHMubGFiZWwsCiAgICBsYWJlbFJlZjogcHJvcHMubGFiZWxSZWYKICB9KSwgcHJvcHMuY2hpbGRyZW4pKSk7Cn0pOwp2YXIgQ2FydGVzaWFuQXhpcyA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmZvcndhcmRSZWYoKG91dHNpZGVQcm9wcywgcmVmKSA9PiB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkF4aXNDb21wb25lbnQsIF9leHRlbmRzMTUoe30sIHByb3BzLCB7CiAgICByZWYKICB9KSk7Cn0pOwpDYXJ0ZXNpYW5BeGlzLmRpc3BsYXlOYW1lID0gIkNhcnRlc2lhbkF4aXMiOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vQ2FydGVzaWFuR3JpZC5qcwp2YXIgUmVhY3QyNSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIF9leGNsdWRlZDExID0gWyJ4MSIsICJ5MSIsICJ4MiIsICJ5MiIsICJrZXkiXTsKdmFyIF9leGNsdWRlZDI1ID0gWyJvZmZzZXQiXTsKdmFyIF9leGNsdWRlZDMyID0gWyJ4QXhpc0lkIiwgInlBeGlzSWQiXTsKdmFyIF9leGNsdWRlZDQyID0gWyJ4QXhpc0lkIiwgInlBeGlzSWQiXTsKZnVuY3Rpb24gb3duS2V5czI5KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjkoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyOShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MzEoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjkoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTMxKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MzEocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MzEodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMzEodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMzEodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9leHRlbmRzMTYoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTYgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczE2LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTEoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTExKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMShyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIEJhY2tncm91bmQgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgZmlsbAogIH0gPSBwcm9wczsKICBpZiAoIWZpbGwgfHwgZmlsbCA9PT0gIm5vbmUiKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIGZpbGxPcGFjaXR5LAogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgcnkKICB9ID0gcHJvcHM7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoInJlY3QiLCB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgcnksCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHN0cm9rZTogIm5vbmUiLAogICAgZmlsbCwKICAgIGZpbGxPcGFjaXR5LAogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWQtYmciCiAgfSk7Cn07CmZ1bmN0aW9uIExpbmVJdGVtKF9yZWYyKSB7CiAgdmFyIHsKICAgIG9wdGlvbiwKICAgIGxpbmVJdGVtUHJvcHMKICB9ID0gX3JlZjI7CiAgdmFyIGxpbmVJdGVtOwogIGlmICgvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5pc1ZhbGlkRWxlbWVudChvcHRpb24pKSB7CiAgICBsaW5lSXRlbSA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNsb25lRWxlbWVudChvcHRpb24sIGxpbmVJdGVtUHJvcHMpOwogIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgbGluZUl0ZW0gPSBvcHRpb24obGluZUl0ZW1Qcm9wcyk7CiAgfSBlbHNlIHsKICAgIHZhciBfc3ZnUHJvcGVydGllc05vRXZlbnQ7CiAgICB2YXIgewogICAgICB4MSwKICAgICAgeTEsCiAgICAgIHgyLAogICAgICB5MiwKICAgICAga2V5CiAgICB9ID0gbGluZUl0ZW1Qcm9wcywgb3RoZXJzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTEobGluZUl0ZW1Qcm9wcywgX2V4Y2x1ZGVkMTEpOwogICAgdmFyIF9yZWYyMiA9IChfc3ZnUHJvcGVydGllc05vRXZlbnQgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHMob3RoZXJzKSkgIT09IG51bGwgJiYgX3N2Z1Byb3BlcnRpZXNOb0V2ZW50ICE9PSB2b2lkIDAgPyBfc3ZnUHJvcGVydGllc05vRXZlbnQgOiB7fSwgewogICAgICBvZmZzZXQ6IF9fCiAgICB9ID0gX3JlZjIyLCByZXN0T2ZGaWx0ZXJlZFByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTEoX3JlZjIyLCBfZXhjbHVkZWQyNSk7CiAgICBsaW5lSXRlbSA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoImxpbmUiLCBfZXh0ZW5kczE2KHt9LCByZXN0T2ZGaWx0ZXJlZFByb3BzLCB7CiAgICAgIHgxLAogICAgICB5MSwKICAgICAgeDIsCiAgICAgIHkyLAogICAgICBmaWxsOiAibm9uZSIsCiAgICAgIGtleQogICAgfSkpOwogIH0KICByZXR1cm4gbGluZUl0ZW07Cn0KZnVuY3Rpb24gSG9yaXpvbnRhbEdyaWRMaW5lcyhwcm9wcykgewogIHZhciB7CiAgICB4OiB4MiwKICAgIHdpZHRoLAogICAgaG9yaXpvbnRhbCA9IHRydWUsCiAgICBob3Jpem9udGFsUG9pbnRzCiAgfSA9IHByb3BzOwogIGlmICghaG9yaXpvbnRhbCB8fCAhaG9yaXpvbnRhbFBvaW50cyB8fCAhaG9yaXpvbnRhbFBvaW50cy5sZW5ndGgpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgeEF4aXNJZCwKICAgIHlBeGlzSWQKICB9ID0gcHJvcHMsIG90aGVyTGluZUl0ZW1Qcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKHByb3BzLCBfZXhjbHVkZWQzMik7CiAgdmFyIGl0ZW1zID0gaG9yaXpvbnRhbFBvaW50cy5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICB2YXIgbGluZUl0ZW1Qcm9wcyA9IF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIG90aGVyTGluZUl0ZW1Qcm9wcyksIHt9LCB7CiAgICAgIHgxOiB4MiwKICAgICAgeTE6IGVudHJ5LAogICAgICB4MjogeDIgKyB3aWR0aCwKICAgICAgeTI6IGVudHJ5LAogICAgICBrZXk6ICJsaW5lLSIuY29uY2F0KGkpLAogICAgICBpbmRleDogaQogICAgfSk7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChMaW5lSXRlbSwgewogICAgICBrZXk6ICJsaW5lLSIuY29uY2F0KGkpLAogICAgICBvcHRpb246IGhvcml6b250YWwsCiAgICAgIGxpbmVJdGVtUHJvcHMKICAgIH0pOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWQtaG9yaXpvbnRhbCIKICB9LCBpdGVtcyk7Cn0KZnVuY3Rpb24gVmVydGljYWxHcmlkTGluZXMocHJvcHMpIHsKICB2YXIgewogICAgeTogeTIsCiAgICBoZWlnaHQsCiAgICB2ZXJ0aWNhbCA9IHRydWUsCiAgICB2ZXJ0aWNhbFBvaW50cwogIH0gPSBwcm9wczsKICBpZiAoIXZlcnRpY2FsIHx8ICF2ZXJ0aWNhbFBvaW50cyB8fCAhdmVydGljYWxQb2ludHMubGVuZ3RoKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIHhBeGlzSWQsCiAgICB5QXhpc0lkCiAgfSA9IHByb3BzLCBvdGhlckxpbmVJdGVtUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMShwcm9wcywgX2V4Y2x1ZGVkNDIpOwogIHZhciBpdGVtcyA9IHZlcnRpY2FsUG9pbnRzLm1hcCgoZW50cnksIGkpID0+IHsKICAgIHZhciBsaW5lSXRlbVByb3BzID0gX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOSh7fSwgb3RoZXJMaW5lSXRlbVByb3BzKSwge30sIHsKICAgICAgeDE6IGVudHJ5LAogICAgICB5MTogeTIsCiAgICAgIHgyOiBlbnRyeSwKICAgICAgeTI6IHkyICsgaGVpZ2h0LAogICAgICBrZXk6ICJsaW5lLSIuY29uY2F0KGkpLAogICAgICBpbmRleDogaQogICAgfSk7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChMaW5lSXRlbSwgewogICAgICBvcHRpb246IHZlcnRpY2FsLAogICAgICBsaW5lSXRlbVByb3BzLAogICAgICBrZXk6ICJsaW5lLSIuY29uY2F0KGkpCiAgICB9KTsKICB9KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudCgiZyIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1ncmlkLXZlcnRpY2FsIgogIH0sIGl0ZW1zKTsKfQpmdW5jdGlvbiBIb3Jpem9udGFsU3RyaXBlcyhwcm9wcykgewogIHZhciB7CiAgICBob3Jpem9udGFsRmlsbCwKICAgIGZpbGxPcGFjaXR5LAogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgaG9yaXpvbnRhbFBvaW50cywKICAgIGhvcml6b250YWwgPSB0cnVlCiAgfSA9IHByb3BzOwogIGlmICghaG9yaXpvbnRhbCB8fCAhaG9yaXpvbnRhbEZpbGwgfHwgIWhvcml6b250YWxGaWxsLmxlbmd0aCB8fCBob3Jpem9udGFsUG9pbnRzID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHMgPSBob3Jpem9udGFsUG9pbnRzLm1hcCgoZSkgPT4gTWF0aC5yb3VuZChlICsgeTIgLSB5MikpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKICBpZiAoeTIgIT09IHJvdW5kZWRTb3J0ZWRIb3Jpem9udGFsUG9pbnRzWzBdKSB7CiAgICByb3VuZGVkU29ydGVkSG9yaXpvbnRhbFBvaW50cy51bnNoaWZ0KDApOwogIH0KICB2YXIgaXRlbXMgPSByb3VuZGVkU29ydGVkSG9yaXpvbnRhbFBvaW50cy5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICB2YXIgbGFzdFN0cmlwZSA9ICFyb3VuZGVkU29ydGVkSG9yaXpvbnRhbFBvaW50c1tpICsgMV07CiAgICB2YXIgbGluZUhlaWdodCA9IGxhc3RTdHJpcGUgPyB5MiArIGhlaWdodCAtIGVudHJ5IDogcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHNbaSArIDFdIC0gZW50cnk7CiAgICBpZiAobGluZUhlaWdodCA8PSAwKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdmFyIGNvbG9ySW5kZXggPSBpICUgaG9yaXpvbnRhbEZpbGwubGVuZ3RoOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoInJlY3QiLCB7CiAgICAgIGtleTogInJlYWN0LSIuY29uY2F0KGkpLAogICAgICB5OiBlbnRyeSwKICAgICAgeDogeDIsCiAgICAgIGhlaWdodDogbGluZUhlaWdodCwKICAgICAgd2lkdGgsCiAgICAgIHN0cm9rZTogIm5vbmUiLAogICAgICBmaWxsOiBob3Jpem9udGFsRmlsbFtjb2xvckluZGV4XSwKICAgICAgZmlsbE9wYWNpdHksCiAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1ncmlkLWJnIgogICAgfSk7CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZHN0cmlwZXMtaG9yaXpvbnRhbCIKICB9LCBpdGVtcyk7Cn0KZnVuY3Rpb24gVmVydGljYWxTdHJpcGVzKHByb3BzKSB7CiAgdmFyIHsKICAgIHZlcnRpY2FsID0gdHJ1ZSwKICAgIHZlcnRpY2FsRmlsbCwKICAgIGZpbGxPcGFjaXR5LAogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgdmVydGljYWxQb2ludHMKICB9ID0gcHJvcHM7CiAgaWYgKCF2ZXJ0aWNhbCB8fCAhdmVydGljYWxGaWxsIHx8ICF2ZXJ0aWNhbEZpbGwubGVuZ3RoKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHJvdW5kZWRTb3J0ZWRWZXJ0aWNhbFBvaW50cyA9IHZlcnRpY2FsUG9pbnRzLm1hcCgoZSkgPT4gTWF0aC5yb3VuZChlICsgeDIgLSB4MikpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKICBpZiAoeDIgIT09IHJvdW5kZWRTb3J0ZWRWZXJ0aWNhbFBvaW50c1swXSkgewogICAgcm91bmRlZFNvcnRlZFZlcnRpY2FsUG9pbnRzLnVuc2hpZnQoMCk7CiAgfQogIHZhciBpdGVtcyA9IHJvdW5kZWRTb3J0ZWRWZXJ0aWNhbFBvaW50cy5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICB2YXIgbGFzdFN0cmlwZSA9ICFyb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHNbaSArIDFdOwogICAgdmFyIGxpbmVXaWR0aCA9IGxhc3RTdHJpcGUgPyB4MiArIHdpZHRoIC0gZW50cnkgOiByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHNbaSArIDFdIC0gZW50cnk7CiAgICBpZiAobGluZVdpZHRoIDw9IDApIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICB2YXIgY29sb3JJbmRleCA9IGkgJSB2ZXJ0aWNhbEZpbGwubGVuZ3RoOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoInJlY3QiLCB7CiAgICAgIGtleTogInJlYWN0LSIuY29uY2F0KGkpLAogICAgICB4OiBlbnRyeSwKICAgICAgeTogeTIsCiAgICAgIHdpZHRoOiBsaW5lV2lkdGgsCiAgICAgIGhlaWdodCwKICAgICAgc3Ryb2tlOiAibm9uZSIsCiAgICAgIGZpbGw6IHZlcnRpY2FsRmlsbFtjb2xvckluZGV4XSwKICAgICAgZmlsbE9wYWNpdHksCiAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1ncmlkLWJnIgogICAgfSk7CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZHN0cmlwZXMtdmVydGljYWwiCiAgfSwgaXRlbXMpOwp9CnZhciBkZWZhdWx0VmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvciA9IChfcmVmMywgc3luY1dpdGhUaWNrcykgPT4gewogIHZhciB7CiAgICB4QXhpcywKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgb2Zmc2V0CiAgfSA9IF9yZWYzOwogIHJldHVybiBnZXRDb29yZGluYXRlc09mR3JpZChnZXRUaWNrcyhfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOSh7fSwgZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcyksIHhBeGlzKSwge30sIHsKICAgIHRpY2tzOiBnZXRUaWNrc09mQXhpcyh4QXhpcywgdHJ1ZSksCiAgICB2aWV3Qm94OiB7CiAgICAgIHg6IDAsCiAgICAgIHk6IDAsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0KICB9KSksIG9mZnNldC5sZWZ0LCBvZmZzZXQubGVmdCArIG9mZnNldC53aWR0aCwgc3luY1dpdGhUaWNrcyk7Cn07CnZhciBkZWZhdWx0SG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yID0gKF9yZWY0LCBzeW5jV2l0aFRpY2tzKSA9PiB7CiAgdmFyIHsKICAgIHlBeGlzLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBvZmZzZXQKICB9ID0gX3JlZjQ7CiAgcmV0dXJuIGdldENvb3JkaW5hdGVzT2ZHcmlkKGdldFRpY2tzKF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KHt9LCBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzKSwgeUF4aXMpLCB7fSwgewogICAgdGlja3M6IGdldFRpY2tzT2ZBeGlzKHlBeGlzLCB0cnVlKSwKICAgIHZpZXdCb3g6IHsKICAgICAgeDogMCwKICAgICAgeTogMCwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfQogIH0pKSwgb2Zmc2V0LnRvcCwgb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQsIHN5bmNXaXRoVGlja3MpOwp9Owp2YXIgZGVmYXVsdENhcnRlc2lhbkdyaWRQcm9wcyA9IHsKICBob3Jpem9udGFsOiB0cnVlLAogIHZlcnRpY2FsOiB0cnVlLAogIC8vIFRoZSBvcmRpbmF0ZXMgb2YgaG9yaXpvbnRhbCBncmlkIGxpbmVzCiAgaG9yaXpvbnRhbFBvaW50czogW10sCiAgLy8gVGhlIGFic2Npc3NhcyBvZiB2ZXJ0aWNhbCBncmlkIGxpbmVzCiAgdmVydGljYWxQb2ludHM6IFtdLAogIHN0cm9rZTogIiNjY2MiLAogIGZpbGw6ICJub25lIiwKICAvLyBUaGUgZmlsbCBvZiBjb2xvcnMgb2YgZ3JpZCBsaW5lcwogIHZlcnRpY2FsRmlsbDogW10sCiAgaG9yaXpvbnRhbEZpbGw6IFtdLAogIHhBeGlzSWQ6IDAsCiAgeUF4aXNJZDogMCwKICBzeW5jV2l0aFRpY2tzOiBmYWxzZSwKICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5ncmlkCn07CmZ1bmN0aW9uIENhcnRlc2lhbkdyaWQocHJvcHMpIHsKICB2YXIgY2hhcnRXaWR0aCA9IHVzZUNoYXJ0V2lkdGgoKTsKICB2YXIgY2hhcnRIZWlnaHQgPSB1c2VDaGFydEhlaWdodCgpOwogIHZhciBvZmZzZXQgPSB1c2VPZmZzZXRJbnRlcm5hbCgpOwogIHZhciBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzID0gX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOSh7fSwgcmVzb2x2ZURlZmF1bHRQcm9wcyhwcm9wcywgZGVmYXVsdENhcnRlc2lhbkdyaWRQcm9wcykpLCB7fSwgewogICAgeDogaXNOdW1iZXIocHJvcHMueCkgPyBwcm9wcy54IDogb2Zmc2V0LmxlZnQsCiAgICB5OiBpc051bWJlcihwcm9wcy55KSA/IHByb3BzLnkgOiBvZmZzZXQudG9wLAogICAgd2lkdGg6IGlzTnVtYmVyKHByb3BzLndpZHRoKSA/IHByb3BzLndpZHRoIDogb2Zmc2V0LndpZHRoLAogICAgaGVpZ2h0OiBpc051bWJlcihwcm9wcy5oZWlnaHQpID8gcHJvcHMuaGVpZ2h0IDogb2Zmc2V0LmhlaWdodAogIH0pOwogIHZhciB7CiAgICB4QXhpc0lkLAogICAgeUF4aXNJZCwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHN5bmNXaXRoVGlja3MsCiAgICBob3Jpem9udGFsVmFsdWVzLAogICAgdmVydGljYWxWYWx1ZXMKICB9ID0gcHJvcHNJbmNsdWRpbmdEZWZhdWx0czsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgeEF4aXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEF4aXNQcm9wc05lZWRlZEZvckNhcnRlc2lhbkdyaWRUaWNrc0dlbmVyYXRvcihzdGF0ZSwgInhBeGlzIiwgeEF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIHZhciB5QXhpcyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0QXhpc1Byb3BzTmVlZGVkRm9yQ2FydGVzaWFuR3JpZFRpY2tzR2VuZXJhdG9yKHN0YXRlLCAieUF4aXMiLCB5QXhpc0lkLCBpc1Bhbm9yYW1hKSk7CiAgaWYgKCFpc1Bvc2l0aXZlTnVtYmVyKHdpZHRoKSB8fCAhaXNQb3NpdGl2ZU51bWJlcihoZWlnaHQpIHx8ICFpc051bWJlcih4MikgfHwgIWlzTnVtYmVyKHkyKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB2ZXJ0aWNhbENvb3JkaW5hdGVzR2VuZXJhdG9yID0gcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy52ZXJ0aWNhbENvb3JkaW5hdGVzR2VuZXJhdG9yIHx8IGRlZmF1bHRWZXJ0aWNhbENvb3JkaW5hdGVzR2VuZXJhdG9yOwogIHZhciBob3Jpem9udGFsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgPSBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLmhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvciB8fCBkZWZhdWx0SG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yOwogIHZhciB7CiAgICBob3Jpem9udGFsUG9pbnRzLAogICAgdmVydGljYWxQb2ludHMKICB9ID0gcHJvcHNJbmNsdWRpbmdEZWZhdWx0czsKICBpZiAoKCFob3Jpem9udGFsUG9pbnRzIHx8ICFob3Jpem9udGFsUG9pbnRzLmxlbmd0aCkgJiYgdHlwZW9mIGhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgdmFyIGlzSG9yaXpvbnRhbFZhbHVlcyA9IGhvcml6b250YWxWYWx1ZXMgJiYgaG9yaXpvbnRhbFZhbHVlcy5sZW5ndGg7CiAgICB2YXIgZ2VuZXJhdG9yUmVzdWx0ID0gaG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yKHsKICAgICAgeUF4aXM6IHlBeGlzID8gX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOSh7fSwgeUF4aXMpLCB7fSwgewogICAgICAgIHRpY2tzOiBpc0hvcml6b250YWxWYWx1ZXMgPyBob3Jpem9udGFsVmFsdWVzIDogeUF4aXMudGlja3MKICAgICAgfSkgOiB2b2lkIDAsCiAgICAgIHdpZHRoOiBjaGFydFdpZHRoICE9PSBudWxsICYmIGNoYXJ0V2lkdGggIT09IHZvaWQgMCA/IGNoYXJ0V2lkdGggOiB3aWR0aCwKICAgICAgaGVpZ2h0OiBjaGFydEhlaWdodCAhPT0gbnVsbCAmJiBjaGFydEhlaWdodCAhPT0gdm9pZCAwID8gY2hhcnRIZWlnaHQgOiBoZWlnaHQsCiAgICAgIG9mZnNldAogICAgfSwgaXNIb3Jpem9udGFsVmFsdWVzID8gdHJ1ZSA6IHN5bmNXaXRoVGlja3MpOwogICAgd2FybihBcnJheS5pc0FycmF5KGdlbmVyYXRvclJlc3VsdCksICJob3Jpem9udGFsQ29vcmRpbmF0ZXNHZW5lcmF0b3Igc2hvdWxkIHJldHVybiBBcnJheSBidXQgaW5zdGVhZCBpdCByZXR1cm5lZCBbIi5jb25jYXQodHlwZW9mIGdlbmVyYXRvclJlc3VsdCwgIl0iKSk7CiAgICBpZiAoQXJyYXkuaXNBcnJheShnZW5lcmF0b3JSZXN1bHQpKSB7CiAgICAgIGhvcml6b250YWxQb2ludHMgPSBnZW5lcmF0b3JSZXN1bHQ7CiAgICB9CiAgfQogIGlmICgoIXZlcnRpY2FsUG9pbnRzIHx8ICF2ZXJ0aWNhbFBvaW50cy5sZW5ndGgpICYmIHR5cGVvZiB2ZXJ0aWNhbENvb3JkaW5hdGVzR2VuZXJhdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICB2YXIgaXNWZXJ0aWNhbFZhbHVlcyA9IHZlcnRpY2FsVmFsdWVzICYmIHZlcnRpY2FsVmFsdWVzLmxlbmd0aDsKICAgIHZhciBfZ2VuZXJhdG9yUmVzdWx0ID0gdmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvcih7CiAgICAgIHhBeGlzOiB4QXhpcyA/IF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIHhBeGlzKSwge30sIHsKICAgICAgICB0aWNrczogaXNWZXJ0aWNhbFZhbHVlcyA/IHZlcnRpY2FsVmFsdWVzIDogeEF4aXMudGlja3MKICAgICAgfSkgOiB2b2lkIDAsCiAgICAgIHdpZHRoOiBjaGFydFdpZHRoICE9PSBudWxsICYmIGNoYXJ0V2lkdGggIT09IHZvaWQgMCA/IGNoYXJ0V2lkdGggOiB3aWR0aCwKICAgICAgaGVpZ2h0OiBjaGFydEhlaWdodCAhPT0gbnVsbCAmJiBjaGFydEhlaWdodCAhPT0gdm9pZCAwID8gY2hhcnRIZWlnaHQgOiBoZWlnaHQsCiAgICAgIG9mZnNldAogICAgfSwgaXNWZXJ0aWNhbFZhbHVlcyA/IHRydWUgOiBzeW5jV2l0aFRpY2tzKTsKICAgIHdhcm4oQXJyYXkuaXNBcnJheShfZ2VuZXJhdG9yUmVzdWx0KSwgInZlcnRpY2FsQ29vcmRpbmF0ZXNHZW5lcmF0b3Igc2hvdWxkIHJldHVybiBBcnJheSBidXQgaW5zdGVhZCBpdCByZXR1cm5lZCBbIi5jb25jYXQodHlwZW9mIF9nZW5lcmF0b3JSZXN1bHQsICJdIikpOwogICAgaWYgKEFycmF5LmlzQXJyYXkoX2dlbmVyYXRvclJlc3VsdCkpIHsKICAgICAgdmVydGljYWxQb2ludHMgPSBfZ2VuZXJhdG9yUmVzdWx0OwogICAgfQogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4OiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLnpJbmRleAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZCIKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KEJhY2tncm91bmQsIHsKICAgIGZpbGw6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMuZmlsbCwKICAgIGZpbGxPcGFjaXR5OiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLmZpbGxPcGFjaXR5LAogICAgeDogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy54LAogICAgeTogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy55LAogICAgd2lkdGg6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMud2lkdGgsCiAgICBoZWlnaHQ6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMuaGVpZ2h0LAogICAgcnk6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMucnkKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChIb3Jpem9udGFsU3RyaXBlcywgX2V4dGVuZHMxNih7fSwgcHJvcHNJbmNsdWRpbmdEZWZhdWx0cywgewogICAgaG9yaXpvbnRhbFBvaW50cwogIH0pKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudChWZXJ0aWNhbFN0cmlwZXMsIF9leHRlbmRzMTYoe30sIHByb3BzSW5jbHVkaW5nRGVmYXVsdHMsIHsKICAgIHZlcnRpY2FsUG9pbnRzCiAgfSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KEhvcml6b250YWxHcmlkTGluZXMsIF9leHRlbmRzMTYoe30sIHByb3BzSW5jbHVkaW5nRGVmYXVsdHMsIHsKICAgIG9mZnNldCwKICAgIGhvcml6b250YWxQb2ludHMsCiAgICB4QXhpcywKICAgIHlBeGlzCiAgfSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KFZlcnRpY2FsR3JpZExpbmVzLCBfZXh0ZW5kczE2KHt9LCBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLCB7CiAgICBvZmZzZXQsCiAgICB2ZXJ0aWNhbFBvaW50cywKICAgIHhBeGlzLAogICAgeUF4aXMKICB9KSkpKTsKfQpDYXJ0ZXNpYW5HcmlkLmRpc3BsYXlOYW1lID0gIkNhcnRlc2lhbkdyaWQiOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2dldFJhZGl1c0FuZFN0cm9rZVdpZHRoRnJvbURvdC5qcwpmdW5jdGlvbiBnZXRSYWRpdXNBbmRTdHJva2VXaWR0aEZyb21Eb3QoZG90KSB7CiAgdmFyIHByb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzRnJvbVVua25vd24oZG90KTsKICB2YXIgZGVmYXVsdFIgPSAzOwogIHZhciBkZWZhdWx0U3Ryb2tlV2lkdGggPSAyOwogIGlmIChwcm9wcyAhPSBudWxsKSB7CiAgICB2YXIgewogICAgICByOiByMiwKICAgICAgc3Ryb2tlV2lkdGgKICAgIH0gPSBwcm9wczsKICAgIHZhciByZWFsUiA9IE51bWJlcihyMik7CiAgICB2YXIgcmVhbFN0cm9rZVdpZHRoID0gTnVtYmVyKHN0cm9rZVdpZHRoKTsKICAgIGlmIChOdW1iZXIuaXNOYU4ocmVhbFIpIHx8IHJlYWxSIDwgMCkgewogICAgICByZWFsUiA9IGRlZmF1bHRSOwogICAgfQogICAgaWYgKE51bWJlci5pc05hTihyZWFsU3Ryb2tlV2lkdGgpIHx8IHJlYWxTdHJva2VXaWR0aCA8IDApIHsKICAgICAgcmVhbFN0cm9rZVdpZHRoID0gZGVmYXVsdFN0cm9rZVdpZHRoOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgcjogcmVhbFIsCiAgICAgIHN0cm9rZVdpZHRoOiByZWFsU3Ryb2tlV2lkdGgKICAgIH07CiAgfQogIHJldHVybiB7CiAgICByOiBkZWZhdWx0UiwKICAgIHN0cm9rZVdpZHRoOiBkZWZhdWx0U3Ryb2tlV2lkdGgKICB9Owp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9BcmVhLmpzCnZhciBSZWFjdDI2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MzggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9hcmVhU2VsZWN0b3JzLmpzCnZhciBzZWxlY3RYQXhpc1dpdGhTY2FsZSA9IChzdGF0ZSwgeEF4aXNJZCwgX3lBeGlzSWQsIGlzUGFub3JhbWEpID0+IHNlbGVjdEF4aXNXaXRoU2NhbGUoc3RhdGUsICJ4QXhpcyIsIHhBeGlzSWQsIGlzUGFub3JhbWEpOwp2YXIgc2VsZWN0WEF4aXNUaWNrcyA9IChzdGF0ZSwgeEF4aXNJZCwgX3lBeGlzSWQsIGlzUGFub3JhbWEpID0+IHNlbGVjdFRpY2tzT2ZHcmFwaGljYWxJdGVtKHN0YXRlLCAieEF4aXMiLCB4QXhpc0lkLCBpc1Bhbm9yYW1hKTsKdmFyIHNlbGVjdFlBeGlzV2l0aFNjYWxlID0gKHN0YXRlLCBfeEF4aXNJZCwgeUF4aXNJZCwgaXNQYW5vcmFtYSkgPT4gc2VsZWN0QXhpc1dpdGhTY2FsZShzdGF0ZSwgInlBeGlzIiwgeUF4aXNJZCwgaXNQYW5vcmFtYSk7CnZhciBzZWxlY3RZQXhpc1RpY2tzID0gKHN0YXRlLCBfeEF4aXNJZCwgeUF4aXNJZCwgaXNQYW5vcmFtYSkgPT4gc2VsZWN0VGlja3NPZkdyYXBoaWNhbEl0ZW0oc3RhdGUsICJ5QXhpcyIsIHlBeGlzSWQsIGlzUGFub3JhbWEpOwp2YXIgc2VsZWN0QmFuZFNpemUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFhBeGlzV2l0aFNjYWxlLCBzZWxlY3RZQXhpc1dpdGhTY2FsZSwgc2VsZWN0WEF4aXNUaWNrcywgc2VsZWN0WUF4aXNUaWNrc10sIChsYXlvdXQsIHhBeGlzLCB5QXhpcywgeEF4aXNUaWNrcywgeUF4aXNUaWNrcykgPT4gewogIGlmIChpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsICJ4QXhpcyIpKSB7CiAgICByZXR1cm4gZ2V0QmFuZFNpemVPZkF4aXMoeEF4aXMsIHhBeGlzVGlja3MsIGZhbHNlKTsKICB9CiAgcmV0dXJuIGdldEJhbmRTaXplT2ZBeGlzKHlBeGlzLCB5QXhpc1RpY2tzLCBmYWxzZSk7Cn0pOwp2YXIgcGlja0FyZWFJZCA9IChfc3RhdGUsIF94QXhpc0lkLCBfeUF4aXNJZCwgX2lzUGFub3JhbWEsIGlkKSA9PiBpZDsKdmFyIHNlbGVjdFN5bmNocm9uaXNlZEFyZWFTZXR0aW5ncyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RVbmZpbHRlcmVkQ2FydGVzaWFuSXRlbXMsIHBpY2tBcmVhSWRdLCAoZ3JhcGhpY2FsSXRlbXMsIGlkKSA9PiBncmFwaGljYWxJdGVtcy5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0udHlwZSA9PT0gImFyZWEiKS5maW5kKChpdGVtKSA9PiBpdGVtLmlkID09PSBpZCkpOwp2YXIgc2VsZWN0R3JhcGhpY2FsSXRlbVN0YWNrZWREYXRhID0gKHN0YXRlLCB4QXhpc0lkLCB5QXhpc0lkLCBpc1Bhbm9yYW1hLCBpZCkgPT4gewogIHZhciBfc3RhY2tHcm91cHMkc3RhY2tJZDsKICB2YXIgYXJlYVNldHRpbmdzID0gc2VsZWN0U3luY2hyb25pc2VkQXJlYVNldHRpbmdzKHN0YXRlLCB4QXhpc0lkLCB5QXhpc0lkLCBpc1Bhbm9yYW1hLCBpZCk7CiAgaWYgKGFyZWFTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgbGF5b3V0ID0gc2VsZWN0Q2hhcnRMYXlvdXQoc3RhdGUpOwogIHZhciBpc1hBeGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsICJ4QXhpcyIpOwogIHZhciBzdGFja0dyb3VwczsKICBpZiAoaXNYQXhpc0NhdGVnb3JpY2FsKSB7CiAgICBzdGFja0dyb3VwcyA9IHNlbGVjdFN0YWNrR3JvdXBzKHN0YXRlLCAieUF4aXMiLCB5QXhpc0lkLCBpc1Bhbm9yYW1hKTsKICB9IGVsc2UgewogICAgc3RhY2tHcm91cHMgPSBzZWxlY3RTdGFja0dyb3VwcyhzdGF0ZSwgInhBeGlzIiwgeEF4aXNJZCwgaXNQYW5vcmFtYSk7CiAgfQogIGlmIChzdGFja0dyb3VwcyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgc3RhY2tJZAogIH0gPSBhcmVhU2V0dGluZ3M7CiAgdmFyIHN0YWNrU2VyaWVzSWRlbnRpZmllciA9IGdldFN0YWNrU2VyaWVzSWRlbnRpZmllcihhcmVhU2V0dGluZ3MpOwogIGlmIChzdGFja0lkID09IG51bGwgfHwgc3RhY2tTZXJpZXNJZGVudGlmaWVyID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBncm91cHMgPSAoX3N0YWNrR3JvdXBzJHN0YWNrSWQgPSBzdGFja0dyb3Vwc1tzdGFja0lkXSkgPT09IG51bGwgfHwgX3N0YWNrR3JvdXBzJHN0YWNrSWQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9zdGFja0dyb3VwcyRzdGFja0lkLnN0YWNrZWREYXRhOwogIHJldHVybiBncm91cHMgPT09IG51bGwgfHwgZ3JvdXBzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBncm91cHMuZmluZCgodikgPT4gdi5rZXkgPT09IHN0YWNrU2VyaWVzSWRlbnRpZmllcik7Cn07CnZhciBzZWxlY3RBcmVhID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RYQXhpc1dpdGhTY2FsZSwgc2VsZWN0WUF4aXNXaXRoU2NhbGUsIHNlbGVjdFhBeGlzVGlja3MsIHNlbGVjdFlBeGlzVGlja3MsIHNlbGVjdEdyYXBoaWNhbEl0ZW1TdGFja2VkRGF0YSwgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXNJZk5vdEluUGFub3JhbWEsIHNlbGVjdEJhbmRTaXplLCBzZWxlY3RTeW5jaHJvbmlzZWRBcmVhU2V0dGluZ3MsIHNlbGVjdENoYXJ0QmFzZVZhbHVlXSwgKGxheW91dCwgeEF4aXMsIHlBeGlzLCB4QXhpc1RpY2tzLCB5QXhpc1RpY2tzLCBzdGFja2VkRGF0YSwgX3JlZjIsIGJhbmRTaXplLCBhcmVhU2V0dGluZ3MsIGNoYXJ0QmFzZVZhbHVlKSA9PiB7CiAgdmFyIHsKICAgIGNoYXJ0RGF0YSwKICAgIGRhdGFTdGFydEluZGV4LAogICAgZGF0YUVuZEluZGV4CiAgfSA9IF9yZWYyOwogIGlmIChhcmVhU2V0dGluZ3MgPT0gbnVsbCB8fCBsYXlvdXQgIT09ICJob3Jpem9udGFsIiAmJiBsYXlvdXQgIT09ICJ2ZXJ0aWNhbCIgfHwgeEF4aXMgPT0gbnVsbCB8fCB5QXhpcyA9PSBudWxsIHx8IHhBeGlzVGlja3MgPT0gbnVsbCB8fCB5QXhpc1RpY2tzID09IG51bGwgfHwgeEF4aXNUaWNrcy5sZW5ndGggPT09IDAgfHwgeUF4aXNUaWNrcy5sZW5ndGggPT09IDAgfHwgYmFuZFNpemUgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIGRhdGEKICB9ID0gYXJlYVNldHRpbmdzOwogIHZhciBkaXNwbGF5ZWREYXRhOwogIGlmIChkYXRhICYmIGRhdGEubGVuZ3RoID4gMCkgewogICAgZGlzcGxheWVkRGF0YSA9IGRhdGE7CiAgfSBlbHNlIHsKICAgIGRpc3BsYXllZERhdGEgPSBjaGFydERhdGEgPT09IG51bGwgfHwgY2hhcnREYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjaGFydERhdGEuc2xpY2UoZGF0YVN0YXJ0SW5kZXgsIGRhdGFFbmRJbmRleCArIDEpOwogIH0KICBpZiAoZGlzcGxheWVkRGF0YSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gY29tcHV0ZUFyZWEoewogICAgbGF5b3V0LAogICAgeEF4aXMsCiAgICB5QXhpcywKICAgIHhBeGlzVGlja3MsCiAgICB5QXhpc1RpY2tzLAogICAgZGF0YVN0YXJ0SW5kZXgsCiAgICBhcmVhU2V0dGluZ3MsCiAgICBzdGFja2VkRGF0YSwKICAgIGRpc3BsYXllZERhdGEsCiAgICBjaGFydEJhc2VWYWx1ZSwKICAgIGJhbmRTaXplCiAgfSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vQXJlYS5qcwp2YXIgX2V4Y2x1ZGVkMTIgPSBbImlkIl07CnZhciBfZXhjbHVkZWQyNiA9IFsiYWN0aXZlRG90IiwgImFuaW1hdGlvbkJlZ2luIiwgImFuaW1hdGlvbkR1cmF0aW9uIiwgImFuaW1hdGlvbkVhc2luZyIsICJjb25uZWN0TnVsbHMiLCAiZG90IiwgImZpbGwiLCAiZmlsbE9wYWNpdHkiLCAiaGlkZSIsICJpc0FuaW1hdGlvbkFjdGl2ZSIsICJsZWdlbmRUeXBlIiwgInN0cm9rZSIsICJ4QXhpc0lkIiwgInlBeGlzSWQiXTsKZnVuY3Rpb24gX2V4dGVuZHMxNygpIHsKICByZXR1cm4gX2V4dGVuZHMxNyA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTcuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMihlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTIoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTEyKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBvd25LZXlzMzAoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQzMChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czMwKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkzMihlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzMChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MzIoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkzMihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzMih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUzMih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUzMih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gZ2V0TGVnZW5kSXRlbUNvbG9yKHN0cm9rZSwgZmlsbCkgewogIHJldHVybiBzdHJva2UgJiYgc3Ryb2tlICE9PSAibm9uZSIgPyBzdHJva2UgOiBmaWxsOwp9CnZhciBjb21wdXRlTGVnZW5kUGF5bG9hZEZyb21BcmVhRGF0YSA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICBkYXRhS2V5LAogICAgbmFtZSwKICAgIHN0cm9rZSwKICAgIGZpbGwsCiAgICBsZWdlbmRUeXBlLAogICAgaGlkZQogIH0gPSBwcm9wczsKICByZXR1cm4gW3sKICAgIGluYWN0aXZlOiBoaWRlLAogICAgZGF0YUtleSwKICAgIHR5cGU6IGxlZ2VuZFR5cGUsCiAgICBjb2xvcjogZ2V0TGVnZW5kSXRlbUNvbG9yKHN0cm9rZSwgZmlsbCksCiAgICB2YWx1ZTogZ2V0VG9vbHRpcE5hbWVQcm9wKG5hbWUsIGRhdGFLZXkpLAogICAgcGF5bG9hZDogcHJvcHMKICB9XTsKfTsKdmFyIFNldEFyZWFUb29sdGlwRW50cnlTZXR0aW5ncyA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2Lm1lbW8oKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGRhdGFLZXksCiAgICBkYXRhLAogICAgc3Ryb2tlLAogICAgc3Ryb2tlV2lkdGgsCiAgICBmaWxsLAogICAgbmFtZSwKICAgIGhpZGUsCiAgICB1bml0OiB1bml0MiwKICAgIHRvb2x0aXBUeXBlCiAgfSA9IF9yZWYyOwogIHZhciB0b29sdGlwRW50cnlTZXR0aW5ncyA9IHsKICAgIGRhdGFEZWZpbmVkT25JdGVtOiBkYXRhLAogICAgcG9zaXRpb25zOiB2b2lkIDAsCiAgICBzZXR0aW5nczogewogICAgICBzdHJva2UsCiAgICAgIHN0cm9rZVdpZHRoLAogICAgICBmaWxsLAogICAgICBkYXRhS2V5LAogICAgICBuYW1lS2V5OiB2b2lkIDAsCiAgICAgIG5hbWU6IGdldFRvb2x0aXBOYW1lUHJvcChuYW1lLCBkYXRhS2V5KSwKICAgICAgaGlkZSwKICAgICAgdHlwZTogdG9vbHRpcFR5cGUsCiAgICAgIGNvbG9yOiBnZXRMZWdlbmRJdGVtQ29sb3Ioc3Ryb2tlLCBmaWxsKSwKICAgICAgdW5pdDogdW5pdDIKICAgIH0KICB9OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFNldFRvb2x0aXBFbnRyeVNldHRpbmdzLCB7CiAgICB0b29sdGlwRW50cnlTZXR0aW5ncwogIH0pOwp9KTsKZnVuY3Rpb24gQXJlYURvdHNXcmFwcGVyKF9yZWYyKSB7CiAgdmFyIHsKICAgIGNsaXBQYXRoSWQsCiAgICBwb2ludHMsCiAgICBwcm9wcwogIH0gPSBfcmVmMjsKICB2YXIgewogICAgbmVlZENsaXAsCiAgICBkb3QsCiAgICBkYXRhS2V5CiAgfSA9IHByb3BzOwogIHZhciBhcmVhUHJvcHMgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHMocHJvcHMpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KERvdHMsIHsKICAgIHBvaW50cywKICAgIGRvdCwKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWFyZWEtZG90cyIsCiAgICBkb3RDbGFzc05hbWU6ICJyZWNoYXJ0cy1hcmVhLWRvdCIsCiAgICBkYXRhS2V5LAogICAgYmFzZVByb3BzOiBhcmVhUHJvcHMsCiAgICBuZWVkQ2xpcCwKICAgIGNsaXBQYXRoSWQKICB9KTsKfQpmdW5jdGlvbiBBcmVhTGFiZWxMaXN0UHJvdmlkZXIoX3JlZjMpIHsKICB2YXIgewogICAgc2hvd0xhYmVscywKICAgIGNoaWxkcmVuLAogICAgcG9pbnRzCiAgfSA9IF9yZWYzOwogIHZhciBsYWJlbExpc3RFbnRyaWVzID0gcG9pbnRzLm1hcCgocG9pbnQ0KSA9PiB7CiAgICB2YXIgX3BvaW50JHgsIF9wb2ludCR5OwogICAgdmFyIHZpZXdCb3ggPSB7CiAgICAgIHg6IChfcG9pbnQkeCA9IHBvaW50NC54KSAhPT0gbnVsbCAmJiBfcG9pbnQkeCAhPT0gdm9pZCAwID8gX3BvaW50JHggOiAwLAogICAgICB5OiAoX3BvaW50JHkgPSBwb2ludDQueSkgIT09IG51bGwgJiYgX3BvaW50JHkgIT09IHZvaWQgMCA/IF9wb2ludCR5IDogMCwKICAgICAgd2lkdGg6IDAsCiAgICAgIGxvd2VyV2lkdGg6IDAsCiAgICAgIHVwcGVyV2lkdGg6IDAsCiAgICAgIGhlaWdodDogMAogICAgfTsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMzAoX29iamVjdFNwcmVhZDMwKHt9LCB2aWV3Qm94KSwge30sIHsKICAgICAgdmFsdWU6IHBvaW50NC52YWx1ZSwKICAgICAgcGF5bG9hZDogcG9pbnQ0LnBheWxvYWQsCiAgICAgIHBhcmVudFZpZXdCb3g6IHZvaWQgMCwKICAgICAgdmlld0JveCwKICAgICAgZmlsbDogdm9pZCAwCiAgICB9KTsKICB9KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0UHJvdmlkZXIsIHsKICAgIHZhbHVlOiBzaG93TGFiZWxzID8gbGFiZWxMaXN0RW50cmllcyA6IHZvaWQgMAogIH0sIGNoaWxkcmVuKTsKfQpmdW5jdGlvbiBTdGF0aWNBcmVhKF9yZWY0KSB7CiAgdmFyIHsKICAgIHBvaW50cywKICAgIGJhc2VMaW5lLAogICAgbmVlZENsaXAsCiAgICBjbGlwUGF0aElkLAogICAgcHJvcHMKICB9ID0gX3JlZjQ7CiAgdmFyIHsKICAgIGxheW91dCwKICAgIHR5cGUsCiAgICBzdHJva2UsCiAgICBjb25uZWN0TnVsbHMsCiAgICBpc1JhbmdlCiAgfSA9IHByb3BzOwogIHZhciB7CiAgICBpZAogIH0gPSBwcm9wcywgcHJvcHNXaXRob3V0SWQgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMihwcm9wcywgX2V4Y2x1ZGVkMTIpOwogIHZhciBhbGxPdGhlclByb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKHByb3BzV2l0aG91dElkKTsKICB2YXIgcHJvcHNXaXRoRXZlbnRzID0gc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhwcm9wc1dpdGhvdXRJZCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoUmVhY3QyNi5GcmFnbWVudCwgbnVsbCwgKHBvaW50cyA9PT0gbnVsbCB8fCBwb2ludHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBvaW50cy5sZW5ndGgpID4gMSAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICBjbGlwUGF0aDogbmVlZENsaXAgPyAidXJsKCNjbGlwUGF0aC0iLmNvbmNhdChjbGlwUGF0aElkLCAiKSIpIDogdm9pZCAwCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChDdXJ2ZSwgX2V4dGVuZHMxNyh7fSwgcHJvcHNXaXRoRXZlbnRzLCB7CiAgICBpZCwKICAgIHBvaW50cywKICAgIGNvbm5lY3ROdWxscywKICAgIHR5cGUsCiAgICBiYXNlTGluZSwKICAgIGxheW91dCwKICAgIHN0cm9rZTogIm5vbmUiLAogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtYXJlYS1hcmVhIgogIH0pKSwgc3Ryb2tlICE9PSAibm9uZSIgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChDdXJ2ZSwgX2V4dGVuZHMxNyh7fSwgYWxsT3RoZXJQcm9wcywgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtYXJlYS1jdXJ2ZSIsCiAgICBsYXlvdXQsCiAgICB0eXBlLAogICAgY29ubmVjdE51bGxzLAogICAgZmlsbDogIm5vbmUiLAogICAgcG9pbnRzCiAgfSkpLCBzdHJva2UgIT09ICJub25lIiAmJiBpc1JhbmdlICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQ3VydmUsIF9leHRlbmRzMTcoe30sIGFsbE90aGVyUHJvcHMsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWFyZWEtY3VydmUiLAogICAgbGF5b3V0LAogICAgdHlwZSwKICAgIGNvbm5lY3ROdWxscywKICAgIGZpbGw6ICJub25lIiwKICAgIHBvaW50czogYmFzZUxpbmUKICB9KSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEFyZWFEb3RzV3JhcHBlciwgewogICAgcG9pbnRzLAogICAgcHJvcHM6IHByb3BzV2l0aG91dElkLAogICAgY2xpcFBhdGhJZAogIH0pKTsKfQpmdW5jdGlvbiBWZXJ0aWNhbFJlY3QoX3JlZjUpIHsKICB2YXIgewogICAgYWxwaGE6IGFscGhhMiwKICAgIGJhc2VMaW5lLAogICAgcG9pbnRzLAogICAgc3Ryb2tlV2lkdGgKICB9ID0gX3JlZjU7CiAgdmFyIHN0YXJ0WSA9IHBvaW50c1swXS55OwogIHZhciBlbmRZID0gcG9pbnRzW3BvaW50cy5sZW5ndGggLSAxXS55OwogIGlmICghaXNXZWxsQmVoYXZlZE51bWJlcihzdGFydFkpIHx8ICFpc1dlbGxCZWhhdmVkTnVtYmVyKGVuZFkpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGhlaWdodCA9IGFscGhhMiAqIE1hdGguYWJzKHN0YXJ0WSAtIGVuZFkpOwogIHZhciBtYXhYID0gTWF0aC5tYXgoLi4ucG9pbnRzLm1hcCgoZW50cnkpID0+IGVudHJ5LnggfHwgMCkpOwogIGlmIChpc051bWJlcihiYXNlTGluZSkpIHsKICAgIG1heFggPSBNYXRoLm1heChiYXNlTGluZSwgbWF4WCk7CiAgfSBlbHNlIGlmIChiYXNlTGluZSAmJiBBcnJheS5pc0FycmF5KGJhc2VMaW5lKSAmJiBiYXNlTGluZS5sZW5ndGgpIHsKICAgIG1heFggPSBNYXRoLm1heCguLi5iYXNlTGluZS5tYXAoKGVudHJ5KSA9PiBlbnRyeS54IHx8IDApLCBtYXhYKTsKICB9CiAgaWYgKGlzTnVtYmVyKG1heFgpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgICAgeDogMCwKICAgICAgeTogc3RhcnRZIDwgZW5kWSA/IHN0YXJ0WSA6IHN0YXJ0WSAtIGhlaWdodCwKICAgICAgd2lkdGg6IG1heFggKyAoc3Ryb2tlV2lkdGggPyBwYXJzZUludCgiIi5jb25jYXQoc3Ryb2tlV2lkdGgpLCAxMCkgOiAxKSwKICAgICAgaGVpZ2h0OiBNYXRoLmZsb29yKGhlaWdodCkKICAgIH0pOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBIb3Jpem9udGFsUmVjdChfcmVmNikgewogIHZhciB7CiAgICBhbHBoYTogYWxwaGEyLAogICAgYmFzZUxpbmUsCiAgICBwb2ludHMsCiAgICBzdHJva2VXaWR0aAogIH0gPSBfcmVmNjsKICB2YXIgc3RhcnRYID0gcG9pbnRzWzBdLng7CiAgdmFyIGVuZFggPSBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdLng7CiAgaWYgKCFpc1dlbGxCZWhhdmVkTnVtYmVyKHN0YXJ0WCkgfHwgIWlzV2VsbEJlaGF2ZWROdW1iZXIoZW5kWCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgd2lkdGggPSBhbHBoYTIgKiBNYXRoLmFicyhzdGFydFggLSBlbmRYKTsKICB2YXIgbWF4WSA9IE1hdGgubWF4KC4uLnBvaW50cy5tYXAoKGVudHJ5KSA9PiBlbnRyeS55IHx8IDApKTsKICBpZiAoaXNOdW1iZXIoYmFzZUxpbmUpKSB7CiAgICBtYXhZID0gTWF0aC5tYXgoYmFzZUxpbmUsIG1heFkpOwogIH0gZWxzZSBpZiAoYmFzZUxpbmUgJiYgQXJyYXkuaXNBcnJheShiYXNlTGluZSkgJiYgYmFzZUxpbmUubGVuZ3RoKSB7CiAgICBtYXhZID0gTWF0aC5tYXgoLi4uYmFzZUxpbmUubWFwKChlbnRyeSkgPT4gZW50cnkueSB8fCAwKSwgbWF4WSk7CiAgfQogIGlmIChpc051bWJlcihtYXhZKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoInJlY3QiLCB7CiAgICAgIHg6IHN0YXJ0WCA8IGVuZFggPyBzdGFydFggOiBzdGFydFggLSB3aWR0aCwKICAgICAgeTogMCwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodDogTWF0aC5mbG9vcihtYXhZICsgKHN0cm9rZVdpZHRoID8gcGFyc2VJbnQoIiIuY29uY2F0KHN0cm9rZVdpZHRoKSwgMTApIDogMSkpCiAgICB9KTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gQ2xpcFJlY3QoX3JlZjcpIHsKICB2YXIgewogICAgYWxwaGE6IGFscGhhMiwKICAgIGxheW91dCwKICAgIHBvaW50cywKICAgIGJhc2VMaW5lLAogICAgc3Ryb2tlV2lkdGgKICB9ID0gX3JlZjc7CiAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoVmVydGljYWxSZWN0LCB7CiAgICAgIGFscGhhOiBhbHBoYTIsCiAgICAgIHBvaW50cywKICAgICAgYmFzZUxpbmUsCiAgICAgIHN0cm9rZVdpZHRoCiAgICB9KTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoSG9yaXpvbnRhbFJlY3QsIHsKICAgIGFscGhhOiBhbHBoYTIsCiAgICBwb2ludHMsCiAgICBiYXNlTGluZSwKICAgIHN0cm9rZVdpZHRoCiAgfSk7Cn0KZnVuY3Rpb24gQXJlYVdpdGhBbmltYXRpb24oX3JlZjgpIHsKICB2YXIgewogICAgbmVlZENsaXAsCiAgICBjbGlwUGF0aElkLAogICAgcHJvcHMsCiAgICBwcmV2aW91c1BvaW50c1JlZiwKICAgIHByZXZpb3VzQmFzZWxpbmVSZWYKICB9ID0gX3JlZjg7CiAgdmFyIHsKICAgIHBvaW50cywKICAgIGJhc2VMaW5lLAogICAgaXNBbmltYXRpb25BY3RpdmUsCiAgICBhbmltYXRpb25CZWdpbiwKICAgIGFuaW1hdGlvbkR1cmF0aW9uLAogICAgYW5pbWF0aW9uRWFzaW5nLAogICAgb25BbmltYXRpb25TdGFydCwKICAgIG9uQW5pbWF0aW9uRW5kCiAgfSA9IHByb3BzOwogIHZhciBhbmltYXRpb25JbnB1dCA9ICgwLCBpbXBvcnRfcmVhY3QzOC51c2VNZW1vKSgoKSA9PiAoewogICAgcG9pbnRzLAogICAgYmFzZUxpbmUKICB9KSwgW3BvaW50cywgYmFzZUxpbmVdKTsKICB2YXIgYW5pbWF0aW9uSWQgPSB1c2VBbmltYXRpb25JZChhbmltYXRpb25JbnB1dCwgInJlY2hhcnRzLWFyZWEtIik7CiAgdmFyIGxheW91dCA9IHVzZUNhcnRlc2lhbkNoYXJ0TGF5b3V0KCk7CiAgdmFyIFtpc0FuaW1hdGluZywgc2V0SXNBbmltYXRpbmddID0gKDAsIGltcG9ydF9yZWFjdDM4LnVzZVN0YXRlKShmYWxzZSk7CiAgdmFyIHNob3dMYWJlbHMgPSAhaXNBbmltYXRpbmc7CiAgdmFyIGhhbmRsZUFuaW1hdGlvbkVuZCA9ICgwLCBpbXBvcnRfcmVhY3QzOC51c2VDYWxsYmFjaykoKCkgPT4gewogICAgaWYgKHR5cGVvZiBvbkFuaW1hdGlvbkVuZCA9PT0gImZ1bmN0aW9uIikgewogICAgICBvbkFuaW1hdGlvbkVuZCgpOwogICAgfQogICAgc2V0SXNBbmltYXRpbmcoZmFsc2UpOwogIH0sIFtvbkFuaW1hdGlvbkVuZF0pOwogIHZhciBoYW5kbGVBbmltYXRpb25TdGFydCA9ICgwLCBpbXBvcnRfcmVhY3QzOC51c2VDYWxsYmFjaykoKCkgPT4gewogICAgaWYgKHR5cGVvZiBvbkFuaW1hdGlvblN0YXJ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIG9uQW5pbWF0aW9uU3RhcnQoKTsKICAgIH0KICAgIHNldElzQW5pbWF0aW5nKHRydWUpOwogIH0sIFtvbkFuaW1hdGlvblN0YXJ0XSk7CiAgaWYgKGxheW91dCA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHByZXZQb2ludHMgPSBwcmV2aW91c1BvaW50c1JlZi5jdXJyZW50OwogIHZhciBwcmV2QmFzZUxpbmUgPSBwcmV2aW91c0Jhc2VsaW5lUmVmLmN1cnJlbnQ7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQXJlYUxhYmVsTGlzdFByb3ZpZGVyLCB7CiAgICBzaG93TGFiZWxzLAogICAgcG9pbnRzCiAgfSwgcHJvcHMuY2hpbGRyZW4sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoSmF2YXNjcmlwdEFuaW1hdGUsIHsKICAgIGFuaW1hdGlvbklkLAogICAgYmVnaW46IGFuaW1hdGlvbkJlZ2luLAogICAgZHVyYXRpb246IGFuaW1hdGlvbkR1cmF0aW9uLAogICAgaXNBY3RpdmU6IGlzQW5pbWF0aW9uQWN0aXZlLAogICAgZWFzaW5nOiBhbmltYXRpb25FYXNpbmcsCiAgICBvbkFuaW1hdGlvbkVuZDogaGFuZGxlQW5pbWF0aW9uRW5kLAogICAgb25BbmltYXRpb25TdGFydDogaGFuZGxlQW5pbWF0aW9uU3RhcnQsCiAgICBrZXk6IGFuaW1hdGlvbklkCiAgfSwgKHQpID0+IHsKICAgIGlmIChwcmV2UG9pbnRzKSB7CiAgICAgIHZhciBwcmV2UG9pbnRzRGlmZkZhY3RvciA9IHByZXZQb2ludHMubGVuZ3RoIC8gcG9pbnRzLmxlbmd0aDsKICAgICAgdmFyIHN0ZXBQb2ludHMgPSAoCiAgICAgICAgLyoKICAgICAgICAgKiBIZXJlIGl0IGlzIGltcG9ydGFudCB0aGF0IGF0IHRoZSB2ZXJ5IGVuZCBvZiB0aGUgYW5pbWF0aW9uLCBvbiB0aGUgbGFzdCBmcmFtZSwKICAgICAgICAgKiB3ZSByZW5kZXIgdGhlIG9yaWdpbmFsIHBvaW50cyB3aXRob3V0IGFueSBpbnRlcnBvbGF0aW9uLgogICAgICAgICAqIFRoaXMgaXMgbmVlZGVkIGJlY2F1c2UgdGhlIGNvZGUgYWJvdmUgaXMgY2hlY2tpbmcgZm9yIHJlZmVyZW5jZSBlcXVhbGl0eSB0byBkZWNpZGUgaWYgdGhlIGFuaW1hdGlvbiBzaG91bGQgcnVuCiAgICAgICAgICogYW5kIGlmIHdlIGNyZWF0ZSBhIG5ldyBhcnJheSBpbnN0YW5jZSAoZXZlbiBpZiB0aGUgbnVtYmVycyB3ZXJlIHRoZSBzYW1lKQogICAgICAgICAqIHRoZW4gd2Ugd291bGQgYnJlYWsgYW5pbWF0aW9ucy4KICAgICAgICAgKi8KICAgICAgICB0ID09PSAxID8gcG9pbnRzIDogcG9pbnRzLm1hcCgoZW50cnksIGluZGV4KSA9PiB7CiAgICAgICAgICB2YXIgcHJldlBvaW50SW5kZXggPSBNYXRoLmZsb29yKGluZGV4ICogcHJldlBvaW50c0RpZmZGYWN0b3IpOwogICAgICAgICAgaWYgKHByZXZQb2ludHNbcHJldlBvaW50SW5kZXhdKSB7CiAgICAgICAgICAgIHZhciBwcmV2ID0gcHJldlBvaW50c1twcmV2UG9pbnRJbmRleF07CiAgICAgICAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMzAoX29iamVjdFNwcmVhZDMwKHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgICAgICAgeDogaW50ZXJwb2xhdGUocHJldi54LCBlbnRyeS54LCB0KSwKICAgICAgICAgICAgICB5OiBpbnRlcnBvbGF0ZShwcmV2LnksIGVudHJ5LnksIHQpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVudHJ5OwogICAgICAgIH0pCiAgICAgICk7CiAgICAgIHZhciBzdGVwQmFzZUxpbmU7CiAgICAgIGlmIChpc051bWJlcihiYXNlTGluZSkpIHsKICAgICAgICBzdGVwQmFzZUxpbmUgPSBpbnRlcnBvbGF0ZShwcmV2QmFzZUxpbmUsIGJhc2VMaW5lLCB0KTsKICAgICAgfSBlbHNlIGlmIChpc051bGxpc2goYmFzZUxpbmUpIHx8IGlzTmFuKGJhc2VMaW5lKSkgewogICAgICAgIHN0ZXBCYXNlTGluZSA9IGludGVycG9sYXRlKHByZXZCYXNlTGluZSwgMCwgdCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RlcEJhc2VMaW5lID0gYmFzZUxpbmUubWFwKChlbnRyeSwgaW5kZXgpID0+IHsKICAgICAgICAgIHZhciBwcmV2UG9pbnRJbmRleCA9IE1hdGguZmxvb3IoaW5kZXggKiBwcmV2UG9pbnRzRGlmZkZhY3Rvcik7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShwcmV2QmFzZUxpbmUpICYmIHByZXZCYXNlTGluZVtwcmV2UG9pbnRJbmRleF0pIHsKICAgICAgICAgICAgdmFyIHByZXYgPSBwcmV2QmFzZUxpbmVbcHJldlBvaW50SW5kZXhdOwogICAgICAgICAgICByZXR1cm4gX29iamVjdFNwcmVhZDMwKF9vYmplY3RTcHJlYWQzMCh7fSwgZW50cnkpLCB7fSwgewogICAgICAgICAgICAgIHg6IGludGVycG9sYXRlKHByZXYueCwgZW50cnkueCwgdCksCiAgICAgICAgICAgICAgeTogaW50ZXJwb2xhdGUocHJldi55LCBlbnRyeS55LCB0KQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbnRyeTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAodCA+IDApIHsKICAgICAgICBwcmV2aW91c1BvaW50c1JlZi5jdXJyZW50ID0gc3RlcFBvaW50czsKICAgICAgICBwcmV2aW91c0Jhc2VsaW5lUmVmLmN1cnJlbnQgPSBzdGVwQmFzZUxpbmU7CiAgICAgIH0KICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoU3RhdGljQXJlYSwgewogICAgICAgIHBvaW50czogc3RlcFBvaW50cywKICAgICAgICBiYXNlTGluZTogc3RlcEJhc2VMaW5lLAogICAgICAgIG5lZWRDbGlwLAogICAgICAgIGNsaXBQYXRoSWQsCiAgICAgICAgcHJvcHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodCA+IDApIHsKICAgICAgcHJldmlvdXNQb2ludHNSZWYuY3VycmVudCA9IHBvaW50czsKICAgICAgcHJldmlvdXNCYXNlbGluZVJlZi5jdXJyZW50ID0gYmFzZUxpbmU7CiAgICB9CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChMYXllciwgbnVsbCwgaXNBbmltYXRpb25BY3RpdmUgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudCgiZGVmcyIsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoImNsaXBQYXRoIiwgewogICAgICBpZDogImFuaW1hdGlvbkNsaXBQYXRoLSIuY29uY2F0KGNsaXBQYXRoSWQpCiAgICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KENsaXBSZWN0LCB7CiAgICAgIGFscGhhOiB0LAogICAgICBwb2ludHMsCiAgICAgIGJhc2VMaW5lLAogICAgICBsYXlvdXQsCiAgICAgIHN0cm9rZVdpZHRoOiBwcm9wcy5zdHJva2VXaWR0aAogICAgfSkpKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChMYXllciwgewogICAgICBjbGlwUGF0aDogInVybCgjYW5pbWF0aW9uQ2xpcFBhdGgtIi5jb25jYXQoY2xpcFBhdGhJZCwgIikiKQogICAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChTdGF0aWNBcmVhLCB7CiAgICAgIHBvaW50cywKICAgICAgYmFzZUxpbmUsCiAgICAgIG5lZWRDbGlwLAogICAgICBjbGlwUGF0aElkLAogICAgICBwcm9wcwogICAgfSkpKTsKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChMYWJlbExpc3RGcm9tTGFiZWxQcm9wLCB7CiAgICBsYWJlbDogcHJvcHMubGFiZWwKICB9KSk7Cn0KZnVuY3Rpb24gUmVuZGVyQXJlYShfcmVmOSkgewogIHZhciB7CiAgICBuZWVkQ2xpcCwKICAgIGNsaXBQYXRoSWQsCiAgICBwcm9wcwogIH0gPSBfcmVmOTsKICB2YXIgcHJldmlvdXNQb2ludHNSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MzgudXNlUmVmKShudWxsKTsKICB2YXIgcHJldmlvdXNCYXNlbGluZVJlZiA9ICgwLCBpbXBvcnRfcmVhY3QzOC51c2VSZWYpKCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQXJlYVdpdGhBbmltYXRpb24sIHsKICAgIG5lZWRDbGlwLAogICAgY2xpcFBhdGhJZCwKICAgIHByb3BzLAogICAgcHJldmlvdXNQb2ludHNSZWYsCiAgICBwcmV2aW91c0Jhc2VsaW5lUmVmCiAgfSk7Cn0KdmFyIEFyZWFXaXRoU3RhdGUgPSBjbGFzcyBleHRlbmRzIGltcG9ydF9yZWFjdDM4LlB1cmVDb21wb25lbnQgewogIHJlbmRlcigpIHsKICAgIHZhciB7CiAgICAgIGhpZGUsCiAgICAgIGRvdCwKICAgICAgcG9pbnRzLAogICAgICBjbGFzc05hbWUsCiAgICAgIHRvcCwKICAgICAgbGVmdCwKICAgICAgbmVlZENsaXAsCiAgICAgIHhBeGlzSWQsCiAgICAgIHlBeGlzSWQsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQsCiAgICAgIGlkLAogICAgICBiYXNlTGluZSwKICAgICAgekluZGV4CiAgICB9ID0gdGhpcy5wcm9wczsKICAgIGlmIChoaWRlKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdmFyIGxheWVyQ2xhc3MgPSBjbHN4KCJyZWNoYXJ0cy1hcmVhIiwgY2xhc3NOYW1lKTsKICAgIHZhciBjbGlwUGF0aElkID0gaWQ7CiAgICB2YXIgewogICAgICByOiByMiwKICAgICAgc3Ryb2tlV2lkdGgKICAgIH0gPSBnZXRSYWRpdXNBbmRTdHJva2VXaWR0aEZyb21Eb3QoZG90KTsKICAgIHZhciBjbGlwRG90ID0gaXNDbGlwRG90KGRvdCk7CiAgICB2YXIgZG90U2l6ZSA9IHIyICogMiArIHN0cm9rZVdpZHRoOwogICAgdmFyIGFjdGl2ZVBvaW50c0NsaXBQYXRoID0gbmVlZENsaXAgPyAidXJsKCNjbGlwUGF0aC0iLmNvbmNhdChjbGlwRG90ID8gIiIgOiAiZG90cy0iKS5jb25jYXQoY2xpcFBhdGhJZCwgIikiKSA6IHZvaWQgMDsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICAgIHpJbmRleAogICAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChMYXllciwgewogICAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MKICAgIH0sIG5lZWRDbGlwICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoImRlZnMiLCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEdyYXBoaWNhbEl0ZW1DbGlwUGF0aCwgewogICAgICBjbGlwUGF0aElkLAogICAgICB4QXhpc0lkLAogICAgICB5QXhpc0lkCiAgICB9KSwgIWNsaXBEb3QgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudCgiY2xpcFBhdGgiLCB7CiAgICAgIGlkOiAiY2xpcFBhdGgtZG90cy0iLmNvbmNhdChjbGlwUGF0aElkKQogICAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgICAgeDogbGVmdCAtIGRvdFNpemUgLyAyLAogICAgICB5OiB0b3AgLSBkb3RTaXplIC8gMiwKICAgICAgd2lkdGg6IHdpZHRoICsgZG90U2l6ZSwKICAgICAgaGVpZ2h0OiBoZWlnaHQgKyBkb3RTaXplCiAgICB9KSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFJlbmRlckFyZWEsIHsKICAgICAgbmVlZENsaXAsCiAgICAgIGNsaXBQYXRoSWQsCiAgICAgIHByb3BzOiB0aGlzLnByb3BzCiAgICB9KSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQWN0aXZlUG9pbnRzLCB7CiAgICAgIHBvaW50cywKICAgICAgbWFpbkNvbG9yOiBnZXRMZWdlbmRJdGVtQ29sb3IodGhpcy5wcm9wcy5zdHJva2UsIHRoaXMucHJvcHMuZmlsbCksCiAgICAgIGl0ZW1EYXRhS2V5OiB0aGlzLnByb3BzLmRhdGFLZXksCiAgICAgIGFjdGl2ZURvdDogdGhpcy5wcm9wcy5hY3RpdmVEb3QsCiAgICAgIGNsaXBQYXRoOiBhY3RpdmVQb2ludHNDbGlwUGF0aAogICAgfSksIHRoaXMucHJvcHMuaXNSYW5nZSAmJiBBcnJheS5pc0FycmF5KGJhc2VMaW5lKSAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEFjdGl2ZVBvaW50cywgewogICAgICBwb2ludHM6IGJhc2VMaW5lLAogICAgICBtYWluQ29sb3I6IGdldExlZ2VuZEl0ZW1Db2xvcih0aGlzLnByb3BzLnN0cm9rZSwgdGhpcy5wcm9wcy5maWxsKSwKICAgICAgaXRlbURhdGFLZXk6IHRoaXMucHJvcHMuZGF0YUtleSwKICAgICAgYWN0aXZlRG90OiB0aGlzLnByb3BzLmFjdGl2ZURvdCwKICAgICAgY2xpcFBhdGg6IGFjdGl2ZVBvaW50c0NsaXBQYXRoCiAgICB9KSk7CiAgfQp9Owp2YXIgZGVmYXVsdEFyZWFQcm9wcyA9IHsKICBhY3RpdmVEb3Q6IHRydWUsCiAgYW5pbWF0aW9uQmVnaW46IDAsCiAgYW5pbWF0aW9uRHVyYXRpb246IDE1MDAsCiAgYW5pbWF0aW9uRWFzaW5nOiAiZWFzZSIsCiAgY29ubmVjdE51bGxzOiBmYWxzZSwKICBkb3Q6IGZhbHNlLAogIGZpbGw6ICIjMzE4MmJkIiwKICBmaWxsT3BhY2l0eTogMC42LAogIGhpZGU6IGZhbHNlLAogIGlzQW5pbWF0aW9uQWN0aXZlOiAiYXV0byIsCiAgbGVnZW5kVHlwZTogImxpbmUiLAogIHN0cm9rZTogIiMzMTgyYmQiLAogIHN0cm9rZVdpZHRoOiAxLAogIHR5cGU6ICJsaW5lYXIiLAogIGxhYmVsOiBmYWxzZSwKICB4QXhpc0lkOiAwLAogIHlBeGlzSWQ6IDAsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMuYXJlYQp9OwpmdW5jdGlvbiBBcmVhSW1wbChwcm9wcykgewogIHZhciBfdXNlQXBwU2VsZWN0b3I7CiAgdmFyIF9yZXNvbHZlRGVmYXVsdFByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhwcm9wcywgZGVmYXVsdEFyZWFQcm9wcyksIHsKICAgIGFjdGl2ZURvdCwKICAgIGFuaW1hdGlvbkJlZ2luLAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25FYXNpbmcsCiAgICBjb25uZWN0TnVsbHMsCiAgICBkb3QsCiAgICBmaWxsLAogICAgZmlsbE9wYWNpdHksCiAgICBoaWRlLAogICAgaXNBbmltYXRpb25BY3RpdmUsCiAgICBsZWdlbmRUeXBlLAogICAgc3Ryb2tlLAogICAgeEF4aXNJZCwKICAgIHlBeGlzSWQKICB9ID0gX3Jlc29sdmVEZWZhdWx0UHJvcHMsIGV2ZXJ5dGhpbmdFbHNlID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTIoX3Jlc29sdmVEZWZhdWx0UHJvcHMsIF9leGNsdWRlZDI2KTsKICB2YXIgbGF5b3V0ID0gdXNlQ2hhcnRMYXlvdXQoKTsKICB2YXIgY2hhcnROYW1lID0gdXNlQ2hhcnROYW1lKCk7CiAgdmFyIHsKICAgIG5lZWRDbGlwCiAgfSA9IHVzZU5lZWRzQ2xpcCh4QXhpc0lkLCB5QXhpc0lkKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgewogICAgcG9pbnRzLAogICAgaXNSYW5nZSwKICAgIGJhc2VMaW5lCiAgfSA9IChfdXNlQXBwU2VsZWN0b3IgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEFyZWEoc3RhdGUsIHhBeGlzSWQsIHlBeGlzSWQsIGlzUGFub3JhbWEsIHByb3BzLmlkKSkpICE9PSBudWxsICYmIF91c2VBcHBTZWxlY3RvciAhPT0gdm9pZCAwID8gX3VzZUFwcFNlbGVjdG9yIDoge307CiAgdmFyIHBsb3RBcmVhID0gdXNlUGxvdEFyZWEoKTsKICBpZiAobGF5b3V0ICE9PSAiaG9yaXpvbnRhbCIgJiYgbGF5b3V0ICE9PSAidmVydGljYWwiIHx8IHBsb3RBcmVhID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBpZiAoY2hhcnROYW1lICE9PSAiQXJlYUNoYXJ0IiAmJiBjaGFydE5hbWUgIT09ICJDb21wb3NlZENoYXJ0IikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBoZWlnaHQsCiAgICB3aWR0aCwKICAgIHg6IGxlZnQsCiAgICB5OiB0b3AKICB9ID0gcGxvdEFyZWE7CiAgaWYgKCFwb2ludHMgfHwgIXBvaW50cy5sZW5ndGgpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChBcmVhV2l0aFN0YXRlLCBfZXh0ZW5kczE3KHt9LCBldmVyeXRoaW5nRWxzZSwgewogICAgYWN0aXZlRG90LAogICAgYW5pbWF0aW9uQmVnaW4sCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIGJhc2VMaW5lLAogICAgY29ubmVjdE51bGxzLAogICAgZG90LAogICAgZmlsbCwKICAgIGZpbGxPcGFjaXR5LAogICAgaGVpZ2h0LAogICAgaGlkZSwKICAgIGxheW91dCwKICAgIGlzQW5pbWF0aW9uQWN0aXZlOiBpc0FuaW1hdGlvbkFjdGl2ZSA9PT0gImF1dG8iID8gIUdsb2JhbC5pc1NzciA6IGlzQW5pbWF0aW9uQWN0aXZlLAogICAgaXNSYW5nZSwKICAgIGxlZ2VuZFR5cGUsCiAgICBuZWVkQ2xpcCwKICAgIHBvaW50cywKICAgIHN0cm9rZSwKICAgIHdpZHRoLAogICAgbGVmdCwKICAgIHRvcCwKICAgIHhBeGlzSWQsCiAgICB5QXhpc0lkCiAgfSkpOwp9CnZhciBnZXRCYXNlVmFsdWUgPSAobGF5b3V0LCBjaGFydEJhc2VWYWx1ZSwgaXRlbUJhc2VWYWx1ZSwgeEF4aXMsIHlBeGlzKSA9PiB7CiAgdmFyIGJhc2VWYWx1ZSA9IGl0ZW1CYXNlVmFsdWUgIT09IG51bGwgJiYgaXRlbUJhc2VWYWx1ZSAhPT0gdm9pZCAwID8gaXRlbUJhc2VWYWx1ZSA6IGNoYXJ0QmFzZVZhbHVlOwogIGlmIChpc051bWJlcihiYXNlVmFsdWUpKSB7CiAgICByZXR1cm4gYmFzZVZhbHVlOwogIH0KICB2YXIgbnVtZXJpY0F4aXMgPSBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IHlBeGlzIDogeEF4aXM7CiAgdmFyIGRvbWFpbiA9IG51bWVyaWNBeGlzLnNjYWxlLmRvbWFpbigpOwogIGlmIChudW1lcmljQXhpcy50eXBlID09PSAibnVtYmVyIikgewogICAgdmFyIGRvbWFpbk1heCA9IE1hdGgubWF4KGRvbWFpblswXSwgZG9tYWluWzFdKTsKICAgIHZhciBkb21haW5NaW4gPSBNYXRoLm1pbihkb21haW5bMF0sIGRvbWFpblsxXSk7CiAgICBpZiAoYmFzZVZhbHVlID09PSAiZGF0YU1pbiIpIHsKICAgICAgcmV0dXJuIGRvbWFpbk1pbjsKICAgIH0KICAgIGlmIChiYXNlVmFsdWUgPT09ICJkYXRhTWF4IikgewogICAgICByZXR1cm4gZG9tYWluTWF4OwogICAgfQogICAgcmV0dXJuIGRvbWFpbk1heCA8IDAgPyBkb21haW5NYXggOiBNYXRoLm1heChNYXRoLm1pbihkb21haW5bMF0sIGRvbWFpblsxXSksIDApOwogIH0KICBpZiAoYmFzZVZhbHVlID09PSAiZGF0YU1pbiIpIHsKICAgIHJldHVybiBkb21haW5bMF07CiAgfQogIGlmIChiYXNlVmFsdWUgPT09ICJkYXRhTWF4IikgewogICAgcmV0dXJuIGRvbWFpblsxXTsKICB9CiAgcmV0dXJuIGRvbWFpblswXTsKfTsKZnVuY3Rpb24gY29tcHV0ZUFyZWEoX3JlZjApIHsKICB2YXIgewogICAgYXJlYVNldHRpbmdzOiB7CiAgICAgIGNvbm5lY3ROdWxscywKICAgICAgYmFzZVZhbHVlOiBpdGVtQmFzZVZhbHVlLAogICAgICBkYXRhS2V5CiAgICB9LAogICAgc3RhY2tlZERhdGEsCiAgICBsYXlvdXQsCiAgICBjaGFydEJhc2VWYWx1ZSwKICAgIHhBeGlzLAogICAgeUF4aXMsCiAgICBkaXNwbGF5ZWREYXRhLAogICAgZGF0YVN0YXJ0SW5kZXgsCiAgICB4QXhpc1RpY2tzLAogICAgeUF4aXNUaWNrcywKICAgIGJhbmRTaXplCiAgfSA9IF9yZWYwOwogIHZhciBoYXNTdGFjayA9IHN0YWNrZWREYXRhICYmIHN0YWNrZWREYXRhLmxlbmd0aDsKICB2YXIgYmFzZVZhbHVlID0gZ2V0QmFzZVZhbHVlKGxheW91dCwgY2hhcnRCYXNlVmFsdWUsIGl0ZW1CYXNlVmFsdWUsIHhBeGlzLCB5QXhpcyk7CiAgdmFyIGlzSG9yaXpvbnRhbExheW91dCA9IGxheW91dCA9PT0gImhvcml6b250YWwiOwogIHZhciBpc1JhbmdlID0gZmFsc2U7CiAgdmFyIHBvaW50cyA9IGRpc3BsYXllZERhdGEubWFwKChlbnRyeSwgaW5kZXgpID0+IHsKICAgIHZhciB2YWx1ZTsKICAgIGlmIChoYXNTdGFjaykgewogICAgICB2YWx1ZSA9IHN0YWNrZWREYXRhW2RhdGFTdGFydEluZGV4ICsgaW5kZXhdOwogICAgfSBlbHNlIHsKICAgICAgdmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZGF0YUtleSk7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICB2YWx1ZSA9IFtiYXNlVmFsdWUsIHZhbHVlXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpc1JhbmdlID0gdHJ1ZTsKICAgICAgfQogICAgfQogICAgdmFyIGlzQnJlYWtQb2ludCA9IHZhbHVlWzFdID09IG51bGwgfHwgaGFzU3RhY2sgJiYgIWNvbm5lY3ROdWxscyAmJiBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZGF0YUtleSkgPT0gbnVsbDsKICAgIGlmIChpc0hvcml6b250YWxMYXlvdXQpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiBnZXRDYXRlQ29vcmRpbmF0ZU9mTGluZSh7CiAgICAgICAgICBheGlzOiB4QXhpcywKICAgICAgICAgIHRpY2tzOiB4QXhpc1RpY2tzLAogICAgICAgICAgYmFuZFNpemUsCiAgICAgICAgICBlbnRyeSwKICAgICAgICAgIGluZGV4CiAgICAgICAgfSksCiAgICAgICAgeTogaXNCcmVha1BvaW50ID8gbnVsbCA6IHlBeGlzLnNjYWxlKHZhbHVlWzFdKSwKICAgICAgICB2YWx1ZSwKICAgICAgICBwYXlsb2FkOiBlbnRyeQogICAgICB9OwogICAgfQogICAgcmV0dXJuIHsKICAgICAgeDogaXNCcmVha1BvaW50ID8gbnVsbCA6IHhBeGlzLnNjYWxlKHZhbHVlWzFdKSwKICAgICAgeTogZ2V0Q2F0ZUNvb3JkaW5hdGVPZkxpbmUoewogICAgICAgIGF4aXM6IHlBeGlzLAogICAgICAgIHRpY2tzOiB5QXhpc1RpY2tzLAogICAgICAgIGJhbmRTaXplLAogICAgICAgIGVudHJ5LAogICAgICAgIGluZGV4CiAgICAgIH0pLAogICAgICB2YWx1ZSwKICAgICAgcGF5bG9hZDogZW50cnkKICAgIH07CiAgfSk7CiAgdmFyIGJhc2VMaW5lOwogIGlmIChoYXNTdGFjayB8fCBpc1JhbmdlKSB7CiAgICBiYXNlTGluZSA9IHBvaW50cy5tYXAoKGVudHJ5KSA9PiB7CiAgICAgIHZhciB4MiA9IEFycmF5LmlzQXJyYXkoZW50cnkudmFsdWUpID8gZW50cnkudmFsdWVbMF0gOiBudWxsOwogICAgICBpZiAoaXNIb3Jpem9udGFsTGF5b3V0KSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHg6IGVudHJ5LngsCiAgICAgICAgICB5OiB4MiAhPSBudWxsICYmIGVudHJ5LnkgIT0gbnVsbCA/IHlBeGlzLnNjYWxlKHgyKSA6IG51bGwsCiAgICAgICAgICBwYXlsb2FkOiBlbnRyeS5wYXlsb2FkCiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHg6IHgyICE9IG51bGwgPyB4QXhpcy5zY2FsZSh4MikgOiBudWxsLAogICAgICAgIHk6IGVudHJ5LnksCiAgICAgICAgcGF5bG9hZDogZW50cnkucGF5bG9hZAogICAgICB9OwogICAgfSk7CiAgfSBlbHNlIHsKICAgIGJhc2VMaW5lID0gaXNIb3Jpem9udGFsTGF5b3V0ID8geUF4aXMuc2NhbGUoYmFzZVZhbHVlKSA6IHhBeGlzLnNjYWxlKGJhc2VWYWx1ZSk7CiAgfQogIHJldHVybiB7CiAgICBwb2ludHMsCiAgICBiYXNlTGluZSwKICAgIGlzUmFuZ2UKICB9Owp9CmZ1bmN0aW9uIEFyZWFGbihvdXRzaWRlUHJvcHMpIHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgZGVmYXVsdEFyZWFQcm9wcyk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoUmVnaXN0ZXJHcmFwaGljYWxJdGVtSWQsIHsKICAgIGlkOiBwcm9wcy5pZCwKICAgIHR5cGU6ICJhcmVhIgogIH0sIChpZCkgPT4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChSZWFjdDI2LkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFNldExlZ2VuZFBheWxvYWQsIHsKICAgIGxlZ2VuZFBheWxvYWQ6IGNvbXB1dGVMZWdlbmRQYXlsb2FkRnJvbUFyZWFEYXRhKHByb3BzKQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFNldEFyZWFUb29sdGlwRW50cnlTZXR0aW5ncywgewogICAgZGF0YUtleTogcHJvcHMuZGF0YUtleSwKICAgIGRhdGE6IHByb3BzLmRhdGEsCiAgICBzdHJva2U6IHByb3BzLnN0cm9rZSwKICAgIHN0cm9rZVdpZHRoOiBwcm9wcy5zdHJva2VXaWR0aCwKICAgIGZpbGw6IHByb3BzLmZpbGwsCiAgICBuYW1lOiBwcm9wcy5uYW1lLAogICAgaGlkZTogcHJvcHMuaGlkZSwKICAgIHVuaXQ6IHByb3BzLnVuaXQsCiAgICB0b29sdGlwVHlwZTogcHJvcHMudG9vbHRpcFR5cGUKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChTZXRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtLCB7CiAgICB0eXBlOiAiYXJlYSIsCiAgICBpZCwKICAgIGRhdGE6IHByb3BzLmRhdGEsCiAgICBkYXRhS2V5OiBwcm9wcy5kYXRhS2V5LAogICAgeEF4aXNJZDogcHJvcHMueEF4aXNJZCwKICAgIHlBeGlzSWQ6IHByb3BzLnlBeGlzSWQsCiAgICB6QXhpc0lkOiAwLAogICAgc3RhY2tJZDogZ2V0Tm9ybWFsaXplZFN0YWNrSWQocHJvcHMuc3RhY2tJZCksCiAgICBoaWRlOiBwcm9wcy5oaWRlLAogICAgYmFyU2l6ZTogdm9pZCAwLAogICAgYmFzZVZhbHVlOiBwcm9wcy5iYXNlVmFsdWUsCiAgICBpc1Bhbm9yYW1hLAogICAgY29ubmVjdE51bGxzOiBwcm9wcy5jb25uZWN0TnVsbHMKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChBcmVhSW1wbCwgX2V4dGVuZHMxNyh7fSwgcHJvcHMsIHsKICAgIGlkCiAgfSkpKSk7Cn0KdmFyIEFyZWEgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5tZW1vKEFyZWFGbiwgcHJvcHNBcmVFcXVhbCk7CkFyZWEuZGlzcGxheU5hbWUgPSAiQXJlYSI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9YQXhpcy5qcwp2YXIgUmVhY3QyNyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2F4aXNQcm9wc0FyZUVxdWFsLmpzCnZhciBfZXhjbHVkZWQxMyA9IFsiZG9tYWluIiwgInJhbmdlIl07CnZhciBfZXhjbHVkZWQyNyA9IFsiZG9tYWluIiwgInJhbmdlIl07CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczEzKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMyhlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTMocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIHNob3J0QXJyYXlzQXJlRXF1YWwoYXJyMSwgYXJyMikgewogIGlmIChhcnIxID09PSBhcnIyKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgaWYgKEFycmF5LmlzQXJyYXkoYXJyMSkgJiYgYXJyMS5sZW5ndGggPT09IDIgJiYgQXJyYXkuaXNBcnJheShhcnIyKSAmJiBhcnIyLmxlbmd0aCA9PT0gMikgewogICAgcmV0dXJuIGFycjFbMF0gPT09IGFycjJbMF0gJiYgYXJyMVsxXSA9PT0gYXJyMlsxXTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9CmZ1bmN0aW9uIGF4aXNQcm9wc0FyZUVxdWFsKHByZXZQcm9wcywgbmV4dFByb3BzKSB7CiAgaWYgKHByZXZQcm9wcyA9PT0gbmV4dFByb3BzKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgdmFyIHsKICAgIGRvbWFpbjogcHJldkRvbWFpbiwKICAgIHJhbmdlOiBwcmV2UmFuZ2UKICB9ID0gcHJldlByb3BzLCBwcmV2UmVzdCA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczEzKHByZXZQcm9wcywgX2V4Y2x1ZGVkMTMpOwogIHZhciB7CiAgICBkb21haW46IG5leHREb21haW4sCiAgICByYW5nZTogbmV4dFJhbmdlCiAgfSA9IG5leHRQcm9wcywgbmV4dFJlc3QgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMyhuZXh0UHJvcHMsIF9leGNsdWRlZDI3KTsKICBpZiAoIXNob3J0QXJyYXlzQXJlRXF1YWwocHJldkRvbWFpbiwgbmV4dERvbWFpbikpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgaWYgKCFzaG9ydEFycmF5c0FyZUVxdWFsKHByZXZSYW5nZSwgbmV4dFJhbmdlKSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gcHJvcHNBcmVFcXVhbChwcmV2UmVzdCwgbmV4dFJlc3QpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9YQXhpcy5qcwp2YXIgX2V4Y2x1ZGVkMTQgPSBbImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwgInRpY2tzIl07CnZhciBfZXhjbHVkZWQyOCA9IFsiaWQiXTsKZnVuY3Rpb24gX2V4dGVuZHMxOCgpIHsKICByZXR1cm4gX2V4dGVuZHMxOCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTguYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNChlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTQoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE0KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBTZXRYQXhpc1NldHRpbmdzKHNldHRpbmdzKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgcHJldlNldHRpbmdzUmVmID0gKDAsIGltcG9ydF9yZWFjdDM5LnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDM5LnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgIGRpc3BhdGNoKGFkZFhBeGlzKHNldHRpbmdzKSk7CiAgICB9IGVsc2UgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ICE9PSBzZXR0aW5ncykgewogICAgICBkaXNwYXRjaChyZXBsYWNlWEF4aXMoewogICAgICAgIHByZXY6IHByZXZTZXR0aW5nc1JlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IHNldHRpbmdzCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID0gc2V0dGluZ3M7CiAgfSwgW3NldHRpbmdzLCBkaXNwYXRjaF0pOwogICgwLCBpbXBvcnRfcmVhY3QzOS51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZVhBeGlzKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0sIFtkaXNwYXRjaF0pOwogIHJldHVybiBudWxsOwp9CnZhciBYQXhpc0ltcGwgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgeEF4aXNJZCwKICAgIGNsYXNzTmFtZQogIH0gPSBwcm9wczsKICB2YXIgdmlld0JveCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEF4aXNWaWV3Qm94KTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgYXhpc1R5cGUgPSAieEF4aXMiOwogIHZhciBzY2FsZSA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0QXhpc1NjYWxlKHN0YXRlLCBheGlzVHlwZSwgeEF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIHZhciBjYXJ0ZXNpYW5UaWNrSXRlbXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFRpY2tzT2ZBeGlzKHN0YXRlLCBheGlzVHlwZSwgeEF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIHZhciBheGlzU2l6ZSA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WEF4aXNTaXplKHN0YXRlLCB4QXhpc0lkKSk7CiAgdmFyIHBvc2l0aW9uID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RYQXhpc1Bvc2l0aW9uKHN0YXRlLCB4QXhpc0lkKSk7CiAgdmFyIHN5bmNocm9uaXplZFNldHRpbmdzID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RYQXhpc1NldHRpbmdzTm9EZWZhdWx0cyhzdGF0ZSwgeEF4aXNJZCkpOwogIGlmIChheGlzU2l6ZSA9PSBudWxsIHx8IHBvc2l0aW9uID09IG51bGwgfHwgc3luY2hyb25pemVkU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBkYW5nZXJvdXNseVNldElubmVySFRNTCwKICAgIHRpY2tzOiB0aWNrczIKICB9ID0gcHJvcHMsIGFsbE90aGVyUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNChwcm9wcywgX2V4Y2x1ZGVkMTQpOwogIHZhciB7CiAgICBpZAogIH0gPSBzeW5jaHJvbml6ZWRTZXR0aW5ncywgcmVzdFN5bmNocm9uaXplZFNldHRpbmdzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTQoc3luY2hyb25pemVkU2V0dGluZ3MsIF9leGNsdWRlZDI4KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5BeGlzLCBfZXh0ZW5kczE4KHt9LCBhbGxPdGhlclByb3BzLCByZXN0U3luY2hyb25pemVkU2V0dGluZ3MsIHsKICAgIHNjYWxlLAogICAgeDogcG9zaXRpb24ueCwKICAgIHk6IHBvc2l0aW9uLnksCiAgICB3aWR0aDogYXhpc1NpemUud2lkdGgsCiAgICBoZWlnaHQ6IGF4aXNTaXplLmhlaWdodCwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtIi5jb25jYXQoYXhpc1R5cGUsICIgIikuY29uY2F0KGF4aXNUeXBlKSwgY2xhc3NOYW1lKSwKICAgIHZpZXdCb3gsCiAgICB0aWNrczogY2FydGVzaWFuVGlja0l0ZW1zLAogICAgYXhpc1R5cGUKICB9KSk7Cn07CnZhciB4QXhpc0RlZmF1bHRQcm9wcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogaW1wbGljaXRYQXhpcy5hbGxvd0RhdGFPdmVyZmxvdywKICBhbGxvd0RlY2ltYWxzOiBpbXBsaWNpdFhBeGlzLmFsbG93RGVjaW1hbHMsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGltcGxpY2l0WEF4aXMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgYW5nbGU6IGltcGxpY2l0WEF4aXMuYW5nbGUsCiAgYXhpc0xpbmU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMuYXhpc0xpbmUsCiAgaGVpZ2h0OiBpbXBsaWNpdFhBeGlzLmhlaWdodCwKICBoaWRlOiBmYWxzZSwKICBpbmNsdWRlSGlkZGVuOiBpbXBsaWNpdFhBeGlzLmluY2x1ZGVIaWRkZW4sCiAgaW50ZXJ2YWw6IGltcGxpY2l0WEF4aXMuaW50ZXJ2YWwsCiAgbWluVGlja0dhcDogaW1wbGljaXRYQXhpcy5taW5UaWNrR2FwLAogIG1pcnJvcjogaW1wbGljaXRYQXhpcy5taXJyb3IsCiAgb3JpZW50YXRpb246IGltcGxpY2l0WEF4aXMub3JpZW50YXRpb24sCiAgcGFkZGluZzogaW1wbGljaXRYQXhpcy5wYWRkaW5nLAogIHJldmVyc2VkOiBpbXBsaWNpdFhBeGlzLnJldmVyc2VkLAogIHNjYWxlOiBpbXBsaWNpdFhBeGlzLnNjYWxlLAogIHRpY2s6IGltcGxpY2l0WEF4aXMudGljaywKICB0aWNrQ291bnQ6IGltcGxpY2l0WEF4aXMudGlja0NvdW50LAogIHRpY2tMaW5lOiBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzLnRpY2tMaW5lLAogIHRpY2tTaXplOiBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzLnRpY2tTaXplLAogIHR5cGU6IGltcGxpY2l0WEF4aXMudHlwZSwKICB4QXhpc0lkOiAwCn07CnZhciBYQXhpc1NldHRpbmdzRGlzcGF0Y2hlciA9IChvdXRzaWRlUHJvcHMpID0+IHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgeEF4aXNEZWZhdWx0UHJvcHMpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KFJlYWN0MjcuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoU2V0WEF4aXNTZXR0aW5ncywgewogICAgYWxsb3dEYXRhT3ZlcmZsb3c6IHByb3BzLmFsbG93RGF0YU92ZXJmbG93LAogICAgYWxsb3dEZWNpbWFsczogcHJvcHMuYWxsb3dEZWNpbWFscywKICAgIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBwcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICAgIGFuZ2xlOiBwcm9wcy5hbmdsZSwKICAgIGRhdGFLZXk6IHByb3BzLmRhdGFLZXksCiAgICBkb21haW46IHByb3BzLmRvbWFpbiwKICAgIGhlaWdodDogcHJvcHMuaGVpZ2h0LAogICAgaGlkZTogcHJvcHMuaGlkZSwKICAgIGlkOiBwcm9wcy54QXhpc0lkLAogICAgaW5jbHVkZUhpZGRlbjogcHJvcHMuaW5jbHVkZUhpZGRlbiwKICAgIGludGVydmFsOiBwcm9wcy5pbnRlcnZhbCwKICAgIG1pblRpY2tHYXA6IHByb3BzLm1pblRpY2tHYXAsCiAgICBtaXJyb3I6IHByb3BzLm1pcnJvciwKICAgIG5hbWU6IHByb3BzLm5hbWUsCiAgICBvcmllbnRhdGlvbjogcHJvcHMub3JpZW50YXRpb24sCiAgICBwYWRkaW5nOiBwcm9wcy5wYWRkaW5nLAogICAgcmV2ZXJzZWQ6IHByb3BzLnJldmVyc2VkLAogICAgc2NhbGU6IHByb3BzLnNjYWxlLAogICAgdGljazogcHJvcHMudGljaywKICAgIHRpY2tDb3VudDogcHJvcHMudGlja0NvdW50LAogICAgdGlja0Zvcm1hdHRlcjogcHJvcHMudGlja0Zvcm1hdHRlciwKICAgIHRpY2tzOiBwcm9wcy50aWNrcywKICAgIHR5cGU6IHByb3BzLnR5cGUsCiAgICB1bml0OiBwcm9wcy51bml0CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoWEF4aXNJbXBsLCBwcm9wcykpOwp9Owp2YXIgWEF4aXMgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5tZW1vKFhBeGlzU2V0dGluZ3NEaXNwYXRjaGVyLCBheGlzUHJvcHNBcmVFcXVhbCk7ClhBeGlzLmRpc3BsYXlOYW1lID0gIlhBeGlzIjsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2FydGVzaWFuL1lBeGlzLmpzCnZhciBSZWFjdDI4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NDAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBfZXhjbHVkZWQxNSA9IFsiZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwiLCAidGlja3MiXTsKdmFyIF9leGNsdWRlZDI5ID0gWyJpZCJdOwpmdW5jdGlvbiBfZXh0ZW5kczE5KCkgewogIHJldHVybiBfZXh0ZW5kczE5ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxOS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczE1KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxNShlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTUocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIFNldFlBeGlzU2V0dGluZ3Moc2V0dGluZ3MpIHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBwcmV2U2V0dGluZ3NSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDAudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0NDAudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgZGlzcGF0Y2goYWRkWUF4aXMoc2V0dGluZ3MpKTsKICAgIH0gZWxzZSBpZiAocHJldlNldHRpbmdzUmVmLmN1cnJlbnQgIT09IHNldHRpbmdzKSB7CiAgICAgIGRpc3BhdGNoKHJlcGxhY2VZQXhpcyh7CiAgICAgICAgcHJldjogcHJldlNldHRpbmdzUmVmLmN1cnJlbnQsCiAgICAgICAgbmV4dDogc2V0dGluZ3MKICAgICAgfSkpOwogICAgfQogICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSBzZXR0aW5nczsKICB9LCBbc2V0dGluZ3MsIGRpc3BhdGNoXSk7CiAgKDAsIGltcG9ydF9yZWFjdDQwLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSB7CiAgICAgICAgZGlzcGF0Y2gocmVtb3ZlWUF4aXMocHJldlNldHRpbmdzUmVmLmN1cnJlbnQpKTsKICAgICAgICBwcmV2U2V0dGluZ3NSZWYuY3VycmVudCA9IG51bGw7CiAgICAgIH0KICAgIH07CiAgfSwgW2Rpc3BhdGNoXSk7CiAgcmV0dXJuIG51bGw7Cn0KdmFyIFlBeGlzSW1wbCA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICB5QXhpc0lkLAogICAgY2xhc3NOYW1lLAogICAgd2lkdGgsCiAgICBsYWJlbAogIH0gPSBwcm9wczsKICB2YXIgY2FydGVzaWFuQXhpc1JlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0MC51c2VSZWYpKG51bGwpOwogIHZhciBsYWJlbFJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0MC51c2VSZWYpKG51bGwpOwogIHZhciB2aWV3Qm94ID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0QXhpc1ZpZXdCb3gpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGF4aXNUeXBlID0gInlBeGlzIjsKICB2YXIgc2NhbGUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEF4aXNTY2FsZShzdGF0ZSwgYXhpc1R5cGUsIHlBeGlzSWQsIGlzUGFub3JhbWEpKTsKICB2YXIgYXhpc1NpemUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFlBeGlzU2l6ZShzdGF0ZSwgeUF4aXNJZCkpOwogIHZhciBwb3NpdGlvbiA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WUF4aXNQb3NpdGlvbihzdGF0ZSwgeUF4aXNJZCkpOwogIHZhciBjYXJ0ZXNpYW5UaWNrSXRlbXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFRpY2tzT2ZBeGlzKHN0YXRlLCBheGlzVHlwZSwgeUF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIHZhciBzeW5jaHJvbml6ZWRTZXR0aW5ncyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WUF4aXNTZXR0aW5nc05vRGVmYXVsdHMoc3RhdGUsIHlBeGlzSWQpKTsKICAoMCwgaW1wb3J0X3JlYWN0NDAudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBpZiAod2lkdGggIT09ICJhdXRvIiB8fCAhYXhpc1NpemUgfHwgaXNMYWJlbENvbnRlbnRBRnVuY3Rpb24obGFiZWwpIHx8IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDAuaXNWYWxpZEVsZW1lbnQpKGxhYmVsKSB8fCBzeW5jaHJvbml6ZWRTZXR0aW5ncyA9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBheGlzQ29tcG9uZW50ID0gY2FydGVzaWFuQXhpc1JlZi5jdXJyZW50OwogICAgaWYgKCFheGlzQ29tcG9uZW50KSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciB1cGRhdGVkWUF4aXNXaWR0aCA9IGF4aXNDb21wb25lbnQuZ2V0Q2FsY3VsYXRlZFdpZHRoKCk7CiAgICBpZiAoTWF0aC5yb3VuZChheGlzU2l6ZS53aWR0aCkgIT09IE1hdGgucm91bmQodXBkYXRlZFlBeGlzV2lkdGgpKSB7CiAgICAgIGRpc3BhdGNoKHVwZGF0ZVlBeGlzV2lkdGgoewogICAgICAgIGlkOiB5QXhpc0lkLAogICAgICAgIHdpZHRoOiB1cGRhdGVkWUF4aXNXaWR0aAogICAgICB9KSk7CiAgICB9CiAgfSwgWwogICAgLy8gVGhlIGRlcGVuZGVuY3kgb24gY2FydGVzaWFuQXhpc1JlZi5jdXJyZW50IGlzIG5vdCBuZWVkZWQgYmVjYXVzZSB1c2VMYXlvdXRFZmZlY3Qgd2lsbCBydW4gYWZ0ZXIgZXZlcnkgcmVuZGVyLgogICAgLy8gVGhlIHJlZiB3aWxsIGJlIHBvcHVsYXRlZCBieSB0aGVuLgogICAgLy8gVG8gcmUtcnVuIHRoaXMgZWZmZWN0IHdoZW4gdGlja3MgY2hhbmdlLCB3ZSBjYW4gZGVwZW5kIG9uIHRoZSB0aWNrcyBhcnJheSBmcm9tIHRoZSBzdG9yZS4KICAgIGNhcnRlc2lhblRpY2tJdGVtcywKICAgIGF4aXNTaXplLAogICAgZGlzcGF0Y2gsCiAgICBsYWJlbCwKICAgIHlBeGlzSWQsCiAgICB3aWR0aCwKICAgIHN5bmNocm9uaXplZFNldHRpbmdzCiAgXSk7CiAgaWYgKGF4aXNTaXplID09IG51bGwgfHwgcG9zaXRpb24gPT0gbnVsbCB8fCBzeW5jaHJvbml6ZWRTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MLAogICAgdGlja3M6IHRpY2tzMgogIH0gPSBwcm9wcywgYWxsT3RoZXJQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczE1KHByb3BzLCBfZXhjbHVkZWQxNSk7CiAgdmFyIHsKICAgIGlkCiAgfSA9IHN5bmNocm9uaXplZFNldHRpbmdzLCByZXN0U3luY2hyb25pemVkU2V0dGluZ3MgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNShzeW5jaHJvbml6ZWRTZXR0aW5ncywgX2V4Y2x1ZGVkMjkpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyOC5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkF4aXMsIF9leHRlbmRzMTkoe30sIGFsbE90aGVyUHJvcHMsIHJlc3RTeW5jaHJvbml6ZWRTZXR0aW5ncywgewogICAgcmVmOiBjYXJ0ZXNpYW5BeGlzUmVmLAogICAgbGFiZWxSZWYsCiAgICBzY2FsZSwKICAgIHg6IHBvc2l0aW9uLngsCiAgICB5OiBwb3NpdGlvbi55LAogICAgdGlja1RleHRQcm9wczogd2lkdGggPT09ICJhdXRvIiA/IHsKICAgICAgd2lkdGg6IHZvaWQgMAogICAgfSA6IHsKICAgICAgd2lkdGgKICAgIH0sCiAgICB3aWR0aDogYXhpc1NpemUud2lkdGgsCiAgICBoZWlnaHQ6IGF4aXNTaXplLmhlaWdodCwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtIi5jb25jYXQoYXhpc1R5cGUsICIgIikuY29uY2F0KGF4aXNUeXBlKSwgY2xhc3NOYW1lKSwKICAgIHZpZXdCb3gsCiAgICB0aWNrczogY2FydGVzaWFuVGlja0l0ZW1zLAogICAgYXhpc1R5cGUKICB9KSk7Cn07CnZhciB5QXhpc0RlZmF1bHRQcm9wcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogaW1wbGljaXRZQXhpcy5hbGxvd0RhdGFPdmVyZmxvdywKICBhbGxvd0RlY2ltYWxzOiBpbXBsaWNpdFlBeGlzLmFsbG93RGVjaW1hbHMsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGltcGxpY2l0WUF4aXMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgYW5nbGU6IGltcGxpY2l0WUF4aXMuYW5nbGUsCiAgYXhpc0xpbmU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMuYXhpc0xpbmUsCiAgaGlkZTogZmFsc2UsCiAgaW5jbHVkZUhpZGRlbjogaW1wbGljaXRZQXhpcy5pbmNsdWRlSGlkZGVuLAogIGludGVydmFsOiBpbXBsaWNpdFlBeGlzLmludGVydmFsLAogIG1pblRpY2tHYXA6IGltcGxpY2l0WUF4aXMubWluVGlja0dhcCwKICBtaXJyb3I6IGltcGxpY2l0WUF4aXMubWlycm9yLAogIG9yaWVudGF0aW9uOiBpbXBsaWNpdFlBeGlzLm9yaWVudGF0aW9uLAogIHBhZGRpbmc6IGltcGxpY2l0WUF4aXMucGFkZGluZywKICByZXZlcnNlZDogaW1wbGljaXRZQXhpcy5yZXZlcnNlZCwKICBzY2FsZTogaW1wbGljaXRZQXhpcy5zY2FsZSwKICB0aWNrOiBpbXBsaWNpdFlBeGlzLnRpY2ssCiAgdGlja0NvdW50OiBpbXBsaWNpdFlBeGlzLnRpY2tDb3VudCwKICB0aWNrTGluZTogZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcy50aWNrTGluZSwKICB0aWNrU2l6ZTogZGVmYXVsdENhcnRlc2lhbkF4aXNQcm9wcy50aWNrU2l6ZSwKICB0eXBlOiBpbXBsaWNpdFlBeGlzLnR5cGUsCiAgd2lkdGg6IGltcGxpY2l0WUF4aXMud2lkdGgsCiAgeUF4aXNJZDogMAp9Owp2YXIgWUF4aXNTZXR0aW5nc0Rpc3BhdGNoZXIgPSAob3V0c2lkZVByb3BzKSA9PiB7CiAgdmFyIHByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIHlBeGlzRGVmYXVsdFByb3BzKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChSZWFjdDI4LkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyOC5jcmVhdGVFbGVtZW50KFNldFlBeGlzU2V0dGluZ3MsIHsKICAgIGludGVydmFsOiBwcm9wcy5pbnRlcnZhbCwKICAgIGlkOiBwcm9wcy55QXhpc0lkLAogICAgc2NhbGU6IHByb3BzLnNjYWxlLAogICAgdHlwZTogcHJvcHMudHlwZSwKICAgIGRvbWFpbjogcHJvcHMuZG9tYWluLAogICAgYWxsb3dEYXRhT3ZlcmZsb3c6IHByb3BzLmFsbG93RGF0YU92ZXJmbG93LAogICAgZGF0YUtleTogcHJvcHMuZGF0YUtleSwKICAgIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBwcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICAgIGFsbG93RGVjaW1hbHM6IHByb3BzLmFsbG93RGVjaW1hbHMsCiAgICB0aWNrQ291bnQ6IHByb3BzLnRpY2tDb3VudCwKICAgIHBhZGRpbmc6IHByb3BzLnBhZGRpbmcsCiAgICBpbmNsdWRlSGlkZGVuOiBwcm9wcy5pbmNsdWRlSGlkZGVuLAogICAgcmV2ZXJzZWQ6IHByb3BzLnJldmVyc2VkLAogICAgdGlja3M6IHByb3BzLnRpY2tzLAogICAgd2lkdGg6IHByb3BzLndpZHRoLAogICAgb3JpZW50YXRpb246IHByb3BzLm9yaWVudGF0aW9uLAogICAgbWlycm9yOiBwcm9wcy5taXJyb3IsCiAgICBoaWRlOiBwcm9wcy5oaWRlLAogICAgdW5pdDogcHJvcHMudW5pdCwKICAgIG5hbWU6IHByb3BzLm5hbWUsCiAgICBhbmdsZTogcHJvcHMuYW5nbGUsCiAgICBtaW5UaWNrR2FwOiBwcm9wcy5taW5UaWNrR2FwLAogICAgdGljazogcHJvcHMudGljaywKICAgIHRpY2tGb3JtYXR0ZXI6IHByb3BzLnRpY2tGb3JtYXR0ZXIKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChZQXhpc0ltcGwsIHByb3BzKSk7Cn07CnZhciBZQXhpcyA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI4Lm1lbW8oWUF4aXNTZXR0aW5nc0Rpc3BhdGNoZXIsIGF4aXNQcm9wc0FyZUVxdWFsKTsKWUF4aXMuZGlzcGxheU5hbWUgPSAiWUF4aXMiOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9DYXJ0ZXNpYW5DaGFydC5qcwp2YXIgUmVhY3QzNCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQ5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9SZWNoYXJ0c1N0b3JlUHJvdmlkZXIuanMKdmFyIFJlYWN0MjkgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0MSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdEFjdGl2ZVByb3BzRnJvbUNoYXJ0UG9pbnRlci5qcwp2YXIgcGlja0NoYXJ0UG9pbnRlciA9IChfc3RhdGUsIGNoYXJ0UG9pbnRlcikgPT4gY2hhcnRQb2ludGVyOwp2YXIgc2VsZWN0QWN0aXZlUHJvcHNGcm9tQ2hhcnRQb2ludGVyID0gY3JlYXRlU2VsZWN0b3IoW3BpY2tDaGFydFBvaW50ZXIsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RQb2xhclZpZXdCb3gsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZVdpdGhSZXZlcnNlLCBzZWxlY3RUb29sdGlwQXhpc1RpY2tzLCBzZWxlY3RPcmRlcmVkVG9vbHRpcFRpY2tzLCBzZWxlY3RDaGFydE9mZnNldEludGVybmFsXSwgY29tYmluZUFjdGl2ZVByb3BzKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9nZXRDaGFydFBvaW50ZXIuanMKdmFyIGdldENoYXJ0UG9pbnRlciA9IChldmVudCkgPT4gewogIHZhciByZWN0ID0gZXZlbnQuY3VycmVudFRhcmdldC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICB2YXIgc2NhbGVYID0gcmVjdC53aWR0aCAvIGV2ZW50LmN1cnJlbnRUYXJnZXQub2Zmc2V0V2lkdGg7CiAgdmFyIHNjYWxlWSA9IHJlY3QuaGVpZ2h0IC8gZXZlbnQuY3VycmVudFRhcmdldC5vZmZzZXRIZWlnaHQ7CiAgcmV0dXJuIHsKICAgIC8qCiAgICAgKiBIZXJlIGl0J3MgaW1wb3J0YW50IHRvIHVzZToKICAgICAqIC0gZXZlbnQuY2xpZW50WCBhbmQgZXZlbnQuY2xpZW50WSB0byBnZXQgdGhlIG1vdXNlIHBvc2l0aW9uIHJlbGF0aXZlIHRvIHRoZSB2aWV3cG9ydCwgaW5jbHVkaW5nIHNjcm9sbC4KICAgICAqIC0gcGFnZVggYW5kIHBhZ2VZIGFyZSBub3QgdXNlZCBiZWNhdXNlIHRoZXkgYXJlIHJlbGF0aXZlIHRvIHRoZSB3aG9sZSBkb2N1bWVudCwgYW5kIGlnbm9yZSBzY3JvbGwuCiAgICAgKiAtIHJlY3QubGVmdCBhbmQgcmVjdC50b3AgYXJlIHVzZWQgdG8gZ2V0IHRoZSBwb3NpdGlvbiBvZiB0aGUgY2hhcnQgcmVsYXRpdmUgdG8gdGhlIHZpZXdwb3J0LgogICAgICogLSBvZmZzZXRYIGFuZCBvZmZzZXRZIGFyZSBub3QgdXNlZCBiZWNhdXNlIHRoZXkgYXJlIHJlbGF0aXZlIHRvIHRoZSBvZmZzZXQgcGFyZW50CiAgICAgKiAgd2hpY2ggbWF5IG9yIG1heSBub3QgYmUgdGhlIHNhbWUgYXMgdGhlIGNsaWVudFggYW5kIGNsaWVudFksIGRlcGVuZGluZyBvbiB0aGUgcG9zaXRpb24gb2YgdGhlIGNoYXJ0IGluIHRoZSBET00KICAgICAqICBhbmQgc3Vycm91bmRpbmcgZWxlbWVudCBzdHlsZXMuIENTUyBwb3NpdGlvbjogcmVsYXRpdmUsIGFic29sdXRlLCBmaXhlZCwgd2lsbCBjaGFuZ2UgdGhlIG9mZnNldCBwYXJlbnQuCiAgICAgKiAtIHNjYWxlWCBhbmQgc2NhbGVZIGFyZSBuZWNlc3NhcnkgZm9yIHdoZW4gdGhlIGNoYXJ0IGVsZW1lbnQgaXMgc2NhbGVkIHVzaW5nIENTUyBgdHJhbnNmb3JtOiBzY2FsZShOKWAuCiAgICAgKi8KICAgIGNoYXJ0WDogTWF0aC5yb3VuZCgoZXZlbnQuY2xpZW50WCAtIHJlY3QubGVmdCkgLyBzY2FsZVgpLAogICAgY2hhcnRZOiBNYXRoLnJvdW5kKChldmVudC5jbGllbnRZIC0gcmVjdC50b3ApIC8gc2NhbGVZKQogIH07Cn07CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL21vdXNlRXZlbnRzTWlkZGxld2FyZS5qcwp2YXIgbW91c2VDbGlja0FjdGlvbiA9IGNyZWF0ZUFjdGlvbigibW91c2VDbGljayIpOwp2YXIgbW91c2VDbGlja01pZGRsZXdhcmUgPSBjcmVhdGVMaXN0ZW5lck1pZGRsZXdhcmUoKTsKbW91c2VDbGlja01pZGRsZXdhcmUuc3RhcnRMaXN0ZW5pbmcoewogIGFjdGlvbkNyZWF0b3I6IG1vdXNlQ2xpY2tBY3Rpb24sCiAgZWZmZWN0OiAoYWN0aW9uLCBsaXN0ZW5lckFwaSkgPT4gewogICAgdmFyIG1vdXNlUG9pbnRlciA9IGFjdGlvbi5wYXlsb2FkOwogICAgdmFyIGFjdGl2ZVByb3BzID0gc2VsZWN0QWN0aXZlUHJvcHNGcm9tQ2hhcnRQb2ludGVyKGxpc3RlbmVyQXBpLmdldFN0YXRlKCksIGdldENoYXJ0UG9pbnRlcihtb3VzZVBvaW50ZXIpKTsKICAgIGlmICgoYWN0aXZlUHJvcHMgPT09IG51bGwgfHwgYWN0aXZlUHJvcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFjdGl2ZVByb3BzLmFjdGl2ZUluZGV4KSAhPSBudWxsKSB7CiAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldE1vdXNlQ2xpY2tBeGlzSW5kZXgoewogICAgICAgIGFjdGl2ZUluZGV4OiBhY3RpdmVQcm9wcy5hY3RpdmVJbmRleCwKICAgICAgICBhY3RpdmVEYXRhS2V5OiB2b2lkIDAsCiAgICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogYWN0aXZlUHJvcHMuYWN0aXZlQ29vcmRpbmF0ZQogICAgICB9KSk7CiAgICB9CiAgfQp9KTsKdmFyIG1vdXNlTW92ZUFjdGlvbiA9IGNyZWF0ZUFjdGlvbigibW91c2VNb3ZlIik7CnZhciBtb3VzZU1vdmVNaWRkbGV3YXJlID0gY3JlYXRlTGlzdGVuZXJNaWRkbGV3YXJlKCk7CnZhciByYWZJZCA9IG51bGw7Cm1vdXNlTW92ZU1pZGRsZXdhcmUuc3RhcnRMaXN0ZW5pbmcoewogIGFjdGlvbkNyZWF0b3I6IG1vdXNlTW92ZUFjdGlvbiwKICBlZmZlY3Q6IChhY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICB2YXIgbW91c2VQb2ludGVyID0gYWN0aW9uLnBheWxvYWQ7CiAgICBpZiAocmFmSWQgIT09IG51bGwpIHsKICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUocmFmSWQpOwogICAgfQogICAgdmFyIGNoYXJ0UG9pbnRlciA9IGdldENoYXJ0UG9pbnRlcihtb3VzZVBvaW50ZXIpOwogICAgcmFmSWQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gewogICAgICB2YXIgc3RhdGUgPSBsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpOwogICAgICB2YXIgdG9vbHRpcEV2ZW50VHlwZSA9IHNlbGVjdFRvb2x0aXBFdmVudFR5cGUoc3RhdGUsIHN0YXRlLnRvb2x0aXAuc2V0dGluZ3Muc2hhcmVkKTsKICAgICAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgICAgIHZhciBhY3RpdmVQcm9wcyA9IHNlbGVjdEFjdGl2ZVByb3BzRnJvbUNoYXJ0UG9pbnRlcihzdGF0ZSwgY2hhcnRQb2ludGVyKTsKICAgICAgICBpZiAoKGFjdGl2ZVByb3BzID09PSBudWxsIHx8IGFjdGl2ZVByb3BzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhY3RpdmVQcm9wcy5hY3RpdmVJbmRleCkgIT0gbnVsbCkgewogICAgICAgICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0TW91c2VPdmVyQXhpc0luZGV4KHsKICAgICAgICAgICAgYWN0aXZlSW5kZXg6IGFjdGl2ZVByb3BzLmFjdGl2ZUluZGV4LAogICAgICAgICAgICBhY3RpdmVEYXRhS2V5OiB2b2lkIDAsCiAgICAgICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGFjdGl2ZVByb3BzLmFjdGl2ZUNvb3JkaW5hdGUKICAgICAgICAgIH0pKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2gobW91c2VMZWF2ZUNoYXJ0KCkpOwogICAgICAgIH0KICAgICAgfQogICAgICByYWZJZCA9IG51bGw7CiAgICB9KTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9yZWR1eERldnRvb2xzSnNvblN0cmluZ2lmeVJlcGxhY2VyLmpzCmZ1bmN0aW9uIHJlZHV4RGV2dG9vbHNKc29uU3RyaW5naWZ5UmVwbGFjZXIoa2V5LCB2YWx1ZSkgewogIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7CiAgICByZXR1cm4gIkhUTUxFbGVtZW50IDwiLmNvbmNhdCh2YWx1ZS50YWdOYW1lLCAnIGNsYXNzPSInKS5jb25jYXQodmFsdWUuY2xhc3NOYW1lLCAnIj4nKTsKICB9CiAgaWYgKHZhbHVlID09PSB3aW5kb3cpIHsKICAgIHJldHVybiAiZ2xvYmFsLndpbmRvdyI7CiAgfQogIGlmIChrZXkgPT09ICJjaGlsZHJlbiIgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbCkgewogICAgcmV0dXJuICI8PENISUxEUkVOPj4iOwogIH0KICByZXR1cm4gdmFsdWU7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvcm9vdFByb3BzU2xpY2UuanMKdmFyIGluaXRpYWxTdGF0ZTEyID0gewogIGFjY2Vzc2liaWxpdHlMYXllcjogdHJ1ZSwKICBiYXJDYXRlZ29yeUdhcDogIjEwJSIsCiAgYmFyR2FwOiA0LAogIGJhclNpemU6IHZvaWQgMCwKICBjbGFzc05hbWU6IHZvaWQgMCwKICBtYXhCYXJTaXplOiB2b2lkIDAsCiAgc3RhY2tPZmZzZXQ6ICJub25lIiwKICBzeW5jSWQ6IHZvaWQgMCwKICBzeW5jTWV0aG9kOiAiaW5kZXgiLAogIGJhc2VWYWx1ZTogdm9pZCAwLAogIHJldmVyc2VTdGFja09yZGVyOiBmYWxzZQp9Owp2YXIgcm9vdFByb3BzU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogInJvb3RQcm9wcyIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGUxMiwKICByZWR1Y2VyczogewogICAgdXBkYXRlT3B0aW9uczogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIF9hY3Rpb24kcGF5bG9hZCRiYXJHYTsKICAgICAgc3RhdGUuYWNjZXNzaWJpbGl0eUxheWVyID0gYWN0aW9uLnBheWxvYWQuYWNjZXNzaWJpbGl0eUxheWVyOwogICAgICBzdGF0ZS5iYXJDYXRlZ29yeUdhcCA9IGFjdGlvbi5wYXlsb2FkLmJhckNhdGVnb3J5R2FwOwogICAgICBzdGF0ZS5iYXJHYXAgPSAoX2FjdGlvbiRwYXlsb2FkJGJhckdhID0gYWN0aW9uLnBheWxvYWQuYmFyR2FwKSAhPT0gbnVsbCAmJiBfYWN0aW9uJHBheWxvYWQkYmFyR2EgIT09IHZvaWQgMCA/IF9hY3Rpb24kcGF5bG9hZCRiYXJHYSA6IGluaXRpYWxTdGF0ZTEyLmJhckdhcDsKICAgICAgc3RhdGUuYmFyU2l6ZSA9IGFjdGlvbi5wYXlsb2FkLmJhclNpemU7CiAgICAgIHN0YXRlLm1heEJhclNpemUgPSBhY3Rpb24ucGF5bG9hZC5tYXhCYXJTaXplOwogICAgICBzdGF0ZS5zdGFja09mZnNldCA9IGFjdGlvbi5wYXlsb2FkLnN0YWNrT2Zmc2V0OwogICAgICBzdGF0ZS5zeW5jSWQgPSBhY3Rpb24ucGF5bG9hZC5zeW5jSWQ7CiAgICAgIHN0YXRlLnN5bmNNZXRob2QgPSBhY3Rpb24ucGF5bG9hZC5zeW5jTWV0aG9kOwogICAgICBzdGF0ZS5jbGFzc05hbWUgPSBhY3Rpb24ucGF5bG9hZC5jbGFzc05hbWU7CiAgICAgIHN0YXRlLmJhc2VWYWx1ZSA9IGFjdGlvbi5wYXlsb2FkLmJhc2VWYWx1ZTsKICAgICAgc3RhdGUucmV2ZXJzZVN0YWNrT3JkZXIgPSBhY3Rpb24ucGF5bG9hZC5yZXZlcnNlU3RhY2tPcmRlcjsKICAgIH0KICB9Cn0pOwp2YXIgcm9vdFByb3BzUmVkdWNlciA9IHJvb3RQcm9wc1NsaWNlLnJlZHVjZXI7CnZhciB7CiAgdXBkYXRlT3B0aW9ucwp9ID0gcm9vdFByb3BzU2xpY2UuYWN0aW9uczsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvcG9sYXJPcHRpb25zU2xpY2UuanMKdmFyIHBvbGFyT3B0aW9uc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJwb2xhck9wdGlvbnMiLAogIGluaXRpYWxTdGF0ZTogbnVsbCwKICByZWR1Y2VyczogewogICAgdXBkYXRlUG9sYXJPcHRpb25zOiAoX3N0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgcmV0dXJuIGFjdGlvbi5wYXlsb2FkOwogICAgfQogIH0KfSk7CnZhciB7CiAgdXBkYXRlUG9sYXJPcHRpb25zCn0gPSBwb2xhck9wdGlvbnNTbGljZS5hY3Rpb25zOwp2YXIgcG9sYXJPcHRpb25zUmVkdWNlciA9IHBvbGFyT3B0aW9uc1NsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2tleWJvYXJkRXZlbnRzTWlkZGxld2FyZS5qcwp2YXIga2V5RG93bkFjdGlvbiA9IGNyZWF0ZUFjdGlvbigia2V5RG93biIpOwp2YXIgZm9jdXNBY3Rpb24gPSBjcmVhdGVBY3Rpb24oImZvY3VzIik7CnZhciBrZXlib2FyZEV2ZW50c01pZGRsZXdhcmUgPSBjcmVhdGVMaXN0ZW5lck1pZGRsZXdhcmUoKTsKa2V5Ym9hcmRFdmVudHNNaWRkbGV3YXJlLnN0YXJ0TGlzdGVuaW5nKHsKICBhY3Rpb25DcmVhdG9yOiBrZXlEb3duQWN0aW9uLAogIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgIHZhciBzdGF0ZSA9IGxpc3RlbmVyQXBpLmdldFN0YXRlKCk7CiAgICB2YXIgYWNjZXNzaWJpbGl0eUxheWVySXNBY3RpdmUgPSBzdGF0ZS5yb290UHJvcHMuYWNjZXNzaWJpbGl0eUxheWVyICE9PSBmYWxzZTsKICAgIGlmICghYWNjZXNzaWJpbGl0eUxheWVySXNBY3RpdmUpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHsKICAgICAga2V5Ym9hcmRJbnRlcmFjdGlvbgogICAgfSA9IHN0YXRlLnRvb2x0aXA7CiAgICB2YXIga2V5ID0gYWN0aW9uLnBheWxvYWQ7CiAgICBpZiAoa2V5ICE9PSAiQXJyb3dSaWdodCIgJiYga2V5ICE9PSAiQXJyb3dMZWZ0IiAmJiBrZXkgIT09ICJFbnRlciIpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHJlc29sdmVkSW5kZXggPSBjb21iaW5lQWN0aXZlVG9vbHRpcEluZGV4KGtleWJvYXJkSW50ZXJhY3Rpb24sIHNlbGVjdFRvb2x0aXBEaXNwbGF5ZWREYXRhKHN0YXRlKSwgc2VsZWN0VG9vbHRpcEF4aXNEYXRhS2V5KHN0YXRlKSwgc2VsZWN0VG9vbHRpcEF4aXNEb21haW4oc3RhdGUpKTsKICAgIHZhciBjdXJyZW50SW5kZXggPSByZXNvbHZlZEluZGV4ID09IG51bGwgPyAtMSA6IE51bWJlcihyZXNvbHZlZEluZGV4KTsKICAgIGlmICghTnVtYmVyLmlzRmluaXRlKGN1cnJlbnRJbmRleCkgfHwgY3VycmVudEluZGV4IDwgMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgdG9vbHRpcFRpY2tzID0gc2VsZWN0VG9vbHRpcEF4aXNUaWNrcyhzdGF0ZSk7CiAgICBpZiAoa2V5ID09PSAiRW50ZXIiKSB7CiAgICAgIHZhciBfY29vcmRpbmF0ZSA9IHNlbGVjdENvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXgoc3RhdGUsICJheGlzIiwgImhvdmVyIiwgU3RyaW5nKGtleWJvYXJkSW50ZXJhY3Rpb24uaW5kZXgpKTsKICAgICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0S2V5Ym9hcmRJbnRlcmFjdGlvbih7CiAgICAgICAgYWN0aXZlOiAha2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUsCiAgICAgICAgYWN0aXZlSW5kZXg6IGtleWJvYXJkSW50ZXJhY3Rpb24uaW5kZXgsCiAgICAgICAgYWN0aXZlRGF0YUtleToga2V5Ym9hcmRJbnRlcmFjdGlvbi5kYXRhS2V5LAogICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IF9jb29yZGluYXRlCiAgICAgIH0pKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGRpcmVjdGlvbiA9IHNlbGVjdENoYXJ0RGlyZWN0aW9uKHN0YXRlKTsKICAgIHZhciBkaXJlY3Rpb25NdWx0aXBsaWVyID0gZGlyZWN0aW9uID09PSAibGVmdC10by1yaWdodCIgPyAxIDogLTE7CiAgICB2YXIgbW92ZW1lbnQgPSBrZXkgPT09ICJBcnJvd1JpZ2h0IiA/IDEgOiAtMTsKICAgIHZhciBuZXh0SW5kZXggPSBjdXJyZW50SW5kZXggKyBtb3ZlbWVudCAqIGRpcmVjdGlvbk11bHRpcGxpZXI7CiAgICBpZiAodG9vbHRpcFRpY2tzID09IG51bGwgfHwgbmV4dEluZGV4ID49IHRvb2x0aXBUaWNrcy5sZW5ndGggfHwgbmV4dEluZGV4IDwgMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgY29vcmRpbmF0ZSA9IHNlbGVjdENvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXgoc3RhdGUsICJheGlzIiwgImhvdmVyIiwgU3RyaW5nKG5leHRJbmRleCkpOwogICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0S2V5Ym9hcmRJbnRlcmFjdGlvbih7CiAgICAgIGFjdGl2ZTogdHJ1ZSwKICAgICAgYWN0aXZlSW5kZXg6IG5leHRJbmRleC50b1N0cmluZygpLAogICAgICBhY3RpdmVEYXRhS2V5OiB2b2lkIDAsCiAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGNvb3JkaW5hdGUKICAgIH0pKTsKICB9Cn0pOwprZXlib2FyZEV2ZW50c01pZGRsZXdhcmUuc3RhcnRMaXN0ZW5pbmcoewogIGFjdGlvbkNyZWF0b3I6IGZvY3VzQWN0aW9uLAogIGVmZmVjdDogKF9hY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICB2YXIgc3RhdGUgPSBsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpOwogICAgdmFyIGFjY2Vzc2liaWxpdHlMYXllcklzQWN0aXZlID0gc3RhdGUucm9vdFByb3BzLmFjY2Vzc2liaWxpdHlMYXllciAhPT0gZmFsc2U7CiAgICBpZiAoIWFjY2Vzc2liaWxpdHlMYXllcklzQWN0aXZlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciB7CiAgICAgIGtleWJvYXJkSW50ZXJhY3Rpb24KICAgIH0gPSBzdGF0ZS50b29sdGlwOwogICAgaWYgKGtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmIChrZXlib2FyZEludGVyYWN0aW9uLmluZGV4ID09IG51bGwpIHsKICAgICAgdmFyIG5leHRJbmRleCA9ICIwIjsKICAgICAgdmFyIGNvb3JkaW5hdGUgPSBzZWxlY3RDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4KHN0YXRlLCAiYXhpcyIsICJob3ZlciIsIFN0cmluZyhuZXh0SW5kZXgpKTsKICAgICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0S2V5Ym9hcmRJbnRlcmFjdGlvbih7CiAgICAgICAgYWN0aXZlRGF0YUtleTogdm9pZCAwLAogICAgICAgIGFjdGl2ZTogdHJ1ZSwKICAgICAgICBhY3RpdmVJbmRleDogbmV4dEluZGV4LAogICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGNvb3JkaW5hdGUKICAgICAgfSkpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2V4dGVybmFsRXZlbnRzTWlkZGxld2FyZS5qcwp2YXIgZXh0ZXJuYWxFdmVudEFjdGlvbiA9IGNyZWF0ZUFjdGlvbigiZXh0ZXJuYWxFdmVudCIpOwp2YXIgZXh0ZXJuYWxFdmVudHNNaWRkbGV3YXJlID0gY3JlYXRlTGlzdGVuZXJNaWRkbGV3YXJlKCk7CnZhciByYWZJZE1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CmV4dGVybmFsRXZlbnRzTWlkZGxld2FyZS5zdGFydExpc3RlbmluZyh7CiAgYWN0aW9uQ3JlYXRvcjogZXh0ZXJuYWxFdmVudEFjdGlvbiwKICBlZmZlY3Q6IChhY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICB2YXIgewogICAgICBoYW5kbGVyLAogICAgICByZWFjdEV2ZW50CiAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICBpZiAoaGFuZGxlciA9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHJlYWN0RXZlbnQucGVyc2lzdCgpOwogICAgdmFyIGV2ZW50VHlwZSA9IHJlYWN0RXZlbnQudHlwZTsKICAgIHZhciBleGlzdGluZ1JhZklkID0gcmFmSWRNYXAuZ2V0KGV2ZW50VHlwZSk7CiAgICBpZiAoZXhpc3RpbmdSYWZJZCAhPT0gdm9pZCAwKSB7CiAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKGV4aXN0aW5nUmFmSWQpOwogICAgfQogICAgdmFyIHJhZklkMiA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7CiAgICAgIHRyeSB7CiAgICAgICAgdmFyIHN0YXRlID0gbGlzdGVuZXJBcGkuZ2V0U3RhdGUoKTsKICAgICAgICB2YXIgbmV4dFN0YXRlID0gewogICAgICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogc2VsZWN0QWN0aXZlVG9vbHRpcENvb3JkaW5hdGUoc3RhdGUpLAogICAgICAgICAgYWN0aXZlRGF0YUtleTogc2VsZWN0QWN0aXZlVG9vbHRpcERhdGFLZXkoc3RhdGUpLAogICAgICAgICAgYWN0aXZlSW5kZXg6IHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleChzdGF0ZSksCiAgICAgICAgICBhY3RpdmVMYWJlbDogc2VsZWN0QWN0aXZlTGFiZWwoc3RhdGUpLAogICAgICAgICAgYWN0aXZlVG9vbHRpcEluZGV4OiBzZWxlY3RBY3RpdmVUb29sdGlwSW5kZXgoc3RhdGUpLAogICAgICAgICAgaXNUb29sdGlwQWN0aXZlOiBzZWxlY3RJc1Rvb2x0aXBBY3RpdmUoc3RhdGUpCiAgICAgICAgfTsKICAgICAgICBoYW5kbGVyKG5leHRTdGF0ZSwgcmVhY3RFdmVudCk7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgcmFmSWRNYXAuZGVsZXRlKGV2ZW50VHlwZSk7CiAgICAgIH0KICAgIH0pOwogICAgcmFmSWRNYXAuc2V0KGV2ZW50VHlwZSwgcmFmSWQyKTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvdG91Y2hTZWxlY3RvcnMuanMKdmFyIHNlbGVjdEFsbFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwU3RhdGVdLCAodG9vbHRpcFN0YXRlKSA9PiB0b29sdGlwU3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkcyk7CnZhciBzZWxlY3RUb29sdGlwQ29vcmRpbmF0ZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb24sIHNlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsIChfc3RhdGUsIHRvb2x0aXBJbmRleCwgX2RhdGFLZXkpID0+IHRvb2x0aXBJbmRleCwgKF9zdGF0ZSwgX3Rvb2x0aXBJbmRleCwgZGF0YUtleSkgPT4gZGF0YUtleV0sIChhbGxUb29sdGlwQ29uZmlndXJhdGlvbnMsIHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsIHRvb2x0aXBJbmRleCwgZGF0YUtleSkgPT4gewogIHZhciBtb3N0UmVsZXZhbnRUb29sdGlwQ29uZmlndXJhdGlvbiA9IGFsbFRvb2x0aXBDb25maWd1cmF0aW9ucy5maW5kKCh0b29sdGlwQ29uZmlndXJhdGlvbikgPT4gewogICAgcmV0dXJuIHRvb2x0aXBDb25maWd1cmF0aW9uLnNldHRpbmdzLmRhdGFLZXkgPT09IGRhdGFLZXk7CiAgfSk7CiAgaWYgKG1vc3RSZWxldmFudFRvb2x0aXBDb25maWd1cmF0aW9uID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBwb3NpdGlvbnMKICB9ID0gbW9zdFJlbGV2YW50VG9vbHRpcENvbmZpZ3VyYXRpb247CiAgaWYgKHBvc2l0aW9ucyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgbWF5YmVQb3NpdGlvbiA9IHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIocG9zaXRpb25zLCB0b29sdGlwSW5kZXgpOwogIHJldHVybiBtYXliZVBvc2l0aW9uOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvdG91Y2hFdmVudHNNaWRkbGV3YXJlLmpzCnZhciB0b3VjaEV2ZW50QWN0aW9uID0gY3JlYXRlQWN0aW9uKCJ0b3VjaE1vdmUiKTsKdmFyIHRvdWNoRXZlbnRNaWRkbGV3YXJlID0gY3JlYXRlTGlzdGVuZXJNaWRkbGV3YXJlKCk7CnRvdWNoRXZlbnRNaWRkbGV3YXJlLnN0YXJ0TGlzdGVuaW5nKHsKICBhY3Rpb25DcmVhdG9yOiB0b3VjaEV2ZW50QWN0aW9uLAogIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgIHZhciB0b3VjaEV2ZW50ID0gYWN0aW9uLnBheWxvYWQ7CiAgICBpZiAodG91Y2hFdmVudC50b3VjaGVzID09IG51bGwgfHwgdG91Y2hFdmVudC50b3VjaGVzLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgc3RhdGUgPSBsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpOwogICAgdmFyIHRvb2x0aXBFdmVudFR5cGUgPSBzZWxlY3RUb29sdGlwRXZlbnRUeXBlKHN0YXRlLCBzdGF0ZS50b29sdGlwLnNldHRpbmdzLnNoYXJlZCk7CiAgICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PT0gImF4aXMiKSB7CiAgICAgIHZhciBhY3RpdmVQcm9wcyA9IHNlbGVjdEFjdGl2ZVByb3BzRnJvbUNoYXJ0UG9pbnRlcihzdGF0ZSwgZ2V0Q2hhcnRQb2ludGVyKHsKICAgICAgICBjbGllbnRYOiB0b3VjaEV2ZW50LnRvdWNoZXNbMF0uY2xpZW50WCwKICAgICAgICBjbGllbnRZOiB0b3VjaEV2ZW50LnRvdWNoZXNbMF0uY2xpZW50WSwKICAgICAgICBjdXJyZW50VGFyZ2V0OiB0b3VjaEV2ZW50LmN1cnJlbnRUYXJnZXQKICAgICAgfSkpOwogICAgICBpZiAoKGFjdGl2ZVByb3BzID09PSBudWxsIHx8IGFjdGl2ZVByb3BzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhY3RpdmVQcm9wcy5hY3RpdmVJbmRleCkgIT0gbnVsbCkgewogICAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldE1vdXNlT3ZlckF4aXNJbmRleCh7CiAgICAgICAgICBhY3RpdmVJbmRleDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgsCiAgICAgICAgICBhY3RpdmVEYXRhS2V5OiB2b2lkIDAsCiAgICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBhY3RpdmVQcm9wcy5hY3RpdmVDb29yZGluYXRlCiAgICAgICAgfSkpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJpdGVtIikgewogICAgICB2YXIgX3RhcmdldCRnZXRBdHRyaWJ1dGU7CiAgICAgIHZhciB0b3VjaCA9IHRvdWNoRXZlbnQudG91Y2hlc1swXTsKICAgICAgaWYgKGRvY3VtZW50LmVsZW1lbnRGcm9tUG9pbnQgPT0gbnVsbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgdGFyZ2V0ID0gZG9jdW1lbnQuZWxlbWVudEZyb21Qb2ludCh0b3VjaC5jbGllbnRYLCB0b3VjaC5jbGllbnRZKTsKICAgICAgaWYgKCF0YXJnZXQgfHwgIXRhcmdldC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIGl0ZW1JbmRleCA9IHRhcmdldC5nZXRBdHRyaWJ1dGUoREFUQV9JVEVNX0lOREVYX0FUVFJJQlVURV9OQU1FKTsKICAgICAgdmFyIGRhdGFLZXkgPSAoX3RhcmdldCRnZXRBdHRyaWJ1dGUgPSB0YXJnZXQuZ2V0QXR0cmlidXRlKERBVEFfSVRFTV9EQVRBS0VZX0FUVFJJQlVURV9OQU1FKSkgIT09IG51bGwgJiYgX3RhcmdldCRnZXRBdHRyaWJ1dGUgIT09IHZvaWQgMCA/IF90YXJnZXQkZ2V0QXR0cmlidXRlIDogdm9pZCAwOwogICAgICB2YXIgY29vcmRpbmF0ZSA9IHNlbGVjdFRvb2x0aXBDb29yZGluYXRlKGxpc3RlbmVyQXBpLmdldFN0YXRlKCksIGl0ZW1JbmRleCwgZGF0YUtleSk7CiAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldEFjdGl2ZU1vdXNlT3Zlckl0ZW1JbmRleCh7CiAgICAgICAgYWN0aXZlRGF0YUtleTogZGF0YUtleSwKICAgICAgICBhY3RpdmVJbmRleDogaXRlbUluZGV4LAogICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGNvb3JkaW5hdGUKICAgICAgfSkpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3N0b3JlLmpzCnZhciByb290UmVkdWNlciA9IGNvbWJpbmVSZWR1Y2Vycyh7CiAgYnJ1c2g6IGJydXNoUmVkdWNlciwKICBjYXJ0ZXNpYW5BeGlzOiBjYXJ0ZXNpYW5BeGlzUmVkdWNlciwKICBjaGFydERhdGE6IGNoYXJ0RGF0YVJlZHVjZXIsCiAgZXJyb3JCYXJzOiBlcnJvckJhclJlZHVjZXIsCiAgZ3JhcGhpY2FsSXRlbXM6IGdyYXBoaWNhbEl0ZW1zUmVkdWNlciwKICBsYXlvdXQ6IGNoYXJ0TGF5b3V0UmVkdWNlciwKICBsZWdlbmQ6IGxlZ2VuZFJlZHVjZXIsCiAgb3B0aW9uczogb3B0aW9uc1JlZHVjZXIsCiAgcG9sYXJBeGlzOiBwb2xhckF4aXNSZWR1Y2VyLAogIHBvbGFyT3B0aW9uczogcG9sYXJPcHRpb25zUmVkdWNlciwKICByZWZlcmVuY2VFbGVtZW50czogcmVmZXJlbmNlRWxlbWVudHNSZWR1Y2VyLAogIHJvb3RQcm9wczogcm9vdFByb3BzUmVkdWNlciwKICB0b29sdGlwOiB0b29sdGlwUmVkdWNlciwKICB6SW5kZXg6IHpJbmRleFJlZHVjZXIKfSk7CnZhciBjcmVhdGVSZWNoYXJ0c1N0b3JlID0gZnVuY3Rpb24gY3JlYXRlUmVjaGFydHNTdG9yZTIocHJlbG9hZGVkU3RhdGUpIHsKICB2YXIgY2hhcnROYW1lID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiAiQ2hhcnQiOwogIHJldHVybiBjb25maWd1cmVTdG9yZSh7CiAgICByZWR1Y2VyOiByb290UmVkdWNlciwKICAgIC8vIHJlZHV4LXRvb2xraXQgdjEgdHlwZXMgYXJlIHVuaGFwcHkgd2l0aCB0aGUgcHJlbG9hZGVkU3RhdGUgdHlwZS4gUmVtb3ZlIHRoZSBgYXMgYW55YCB3aGVuIGJ1bXBpbmcgdG8gdjIKICAgIHByZWxvYWRlZFN0YXRlLAogICAgLy8gQHRzLWV4cGVjdC1lcnJvciByZWR1eC10b29sa2l0IHYxIHR5cGVzIGFyZSB1bmhhcHB5IHdpdGggdGhlIG1pZGRsZXdhcmUgYXJyYXkuIFJlbW92ZSB0aGlzIGNvbW1lbnQgd2hlbiBidW1waW5nIHRvIHYyCiAgICBtaWRkbGV3YXJlOiAoZ2V0RGVmYXVsdE1pZGRsZXdhcmUpID0+IHsKICAgICAgdmFyIF9wcm9jZXNzJGVudiROT0RFX0VOVjsKICAgICAgcmV0dXJuIGdldERlZmF1bHRNaWRkbGV3YXJlKHsKICAgICAgICBzZXJpYWxpemFibGVDaGVjazogZmFsc2UsCiAgICAgICAgaW1tdXRhYmxlQ2hlY2s6ICFbImNvbW1vbmpzIiwgImVzNiIsICJwcm9kdWN0aW9uIl0uaW5jbHVkZXMoKF9wcm9jZXNzJGVudiROT0RFX0VOViA9ICJlczYiKSAhPT0gbnVsbCAmJiBfcHJvY2VzcyRlbnYkTk9ERV9FTlYgIT09IHZvaWQgMCA/IF9wcm9jZXNzJGVudiROT0RFX0VOViA6ICIiKQogICAgICB9KS5jb25jYXQoW21vdXNlQ2xpY2tNaWRkbGV3YXJlLm1pZGRsZXdhcmUsIG1vdXNlTW92ZU1pZGRsZXdhcmUubWlkZGxld2FyZSwga2V5Ym9hcmRFdmVudHNNaWRkbGV3YXJlLm1pZGRsZXdhcmUsIGV4dGVybmFsRXZlbnRzTWlkZGxld2FyZS5taWRkbGV3YXJlLCB0b3VjaEV2ZW50TWlkZGxld2FyZS5taWRkbGV3YXJlXSk7CiAgICB9LAogICAgLyoKICAgICAqIEkgY2FuJ3QgZmluZCBvdXQgaG93IHRvIHNhdGlzZnkgdHlwZXNjcmlwdCBoZXJlLgogICAgICogV2UgcmV0dXJuIGBFbmhhbmNlckFycmF5PFtTdG9yZUVuaGFuY2VyPHt9LCB7fT4sIFN0b3JlRW5oYW5jZXJdPmAgZnJvbSB0aGlzIGZ1bmN0aW9uLAogICAgICogYnV0IHRoZSB0eXBlcyBzYXkgd2Ugc2hvdWxkIHJldHVybiBgRW5oYW5jZXJBcnJheTxTdG9yZUVuaGFuY2VyPHt9LCB7fT5gLgogICAgICogTG9va3MgbGlrZSBpdCdzIGJhZGx5IGluZmVycmVkIGdlbmVyaWNzLCBidXQgaXQgd29uJ3QgYWxsb3cgbWUgdG8gcHJvdmlkZSB0aGUgY29ycmVjdCB0eXBlIG1hbnVhbGx5IGVpdGhlci4KICAgICAqIFNvIGxldCdzIGp1c3QgaWdub3JlIHRoZSBlcnJvciBmb3Igbm93LgogICAgICovCiAgICAvLyBAdHMtZXhwZWN0LWVycm9yIG1pc21hdGNoZWQgZ2VuZXJpY3MKICAgIGVuaGFuY2VyczogKGdldERlZmF1bHRFbmhhbmNlcnMpID0+IHsKICAgICAgdmFyIGVuaGFuY2VycyA9IGdldERlZmF1bHRFbmhhbmNlcnM7CiAgICAgIGlmICh0eXBlb2YgZ2V0RGVmYXVsdEVuaGFuY2VycyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGVuaGFuY2VycyA9IGdldERlZmF1bHRFbmhhbmNlcnMoKTsKICAgICAgfQogICAgICByZXR1cm4gZW5oYW5jZXJzLmNvbmNhdChhdXRvQmF0Y2hFbmhhbmNlcih7CiAgICAgICAgdHlwZTogInJhZiIKICAgICAgfSkpOwogICAgfSwKICAgIGRldlRvb2xzOiBHbG9iYWwuZGV2VG9vbHNFbmFibGVkICYmIHsKICAgICAgc2VyaWFsaXplOiB7CiAgICAgICAgcmVwbGFjZXI6IHJlZHV4RGV2dG9vbHNKc29uU3RyaW5naWZ5UmVwbGFjZXIKICAgICAgfSwKICAgICAgbmFtZTogInJlY2hhcnRzLSIuY29uY2F0KGNoYXJ0TmFtZSkKICAgIH0KICB9KTsKfTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvUmVjaGFydHNTdG9yZVByb3ZpZGVyLmpzCmZ1bmN0aW9uIFJlY2hhcnRzU3RvcmVQcm92aWRlcihfcmVmMikgewogIHZhciB7CiAgICBwcmVsb2FkZWRTdGF0ZSwKICAgIGNoaWxkcmVuLAogICAgcmVkdXhTdG9yZU5hbWUKICB9ID0gX3JlZjI7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHN0b3JlUmVmID0gKDAsIGltcG9ydF9yZWFjdDQxLnVzZVJlZikobnVsbCk7CiAgaWYgKGlzUGFub3JhbWEpIHsKICAgIHJldHVybiBjaGlsZHJlbjsKICB9CiAgaWYgKHN0b3JlUmVmLmN1cnJlbnQgPT0gbnVsbCkgewogICAgc3RvcmVSZWYuY3VycmVudCA9IGNyZWF0ZVJlY2hhcnRzU3RvcmUocHJlbG9hZGVkU3RhdGUsIHJlZHV4U3RvcmVOYW1lKTsKICB9CiAgdmFyIG5vbk51bGxDb250ZXh0ID0gUmVjaGFydHNSZWR1eENvbnRleHQ7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI5LmNyZWF0ZUVsZW1lbnQoUHJvdmlkZXJfZGVmYXVsdCwgewogICAgY29udGV4dDogbm9uTnVsbENvbnRleHQsCiAgICBzdG9yZTogc3RvcmVSZWYuY3VycmVudAogIH0sIGNoaWxkcmVuKTsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9SZXBvcnRNYWluQ2hhcnRQcm9wcy5qcwp2YXIgaW1wb3J0X3JlYWN0NDIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIFJlcG9ydE1haW5DaGFydFByb3BzSW1wbChfcmVmMikgewogIHZhciB7CiAgICBsYXlvdXQsCiAgICBtYXJnaW4KICB9ID0gX3JlZjI7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICAoMCwgaW1wb3J0X3JlYWN0NDIudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoIWlzUGFub3JhbWEpIHsKICAgICAgZGlzcGF0Y2goc2V0TGF5b3V0KGxheW91dCkpOwogICAgICBkaXNwYXRjaChzZXRNYXJnaW4obWFyZ2luKSk7CiAgICB9CiAgfSwgW2Rpc3BhdGNoLCBpc1Bhbm9yYW1hLCBsYXlvdXQsIG1hcmdpbl0pOwogIHJldHVybiBudWxsOwp9CnZhciBSZXBvcnRNYWluQ2hhcnRQcm9wcyA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDIubWVtbykoUmVwb3J0TWFpbkNoYXJ0UHJvcHNJbXBsLCBwcm9wc0FyZUVxdWFsKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvUmVwb3J0Q2hhcnRQcm9wcy5qcwp2YXIgaW1wb3J0X3JlYWN0NDMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIFJlcG9ydENoYXJ0UHJvcHMocHJvcHMpIHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogICgwLCBpbXBvcnRfcmVhY3Q0My51c2VFZmZlY3QpKCgpID0+IHsKICAgIGRpc3BhdGNoKHVwZGF0ZU9wdGlvbnMocHJvcHMpKTsKICB9LCBbZGlzcGF0Y2gsIHByb3BzXSk7CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvQ2F0ZWdvcmljYWxDaGFydC5qcwp2YXIgUmVhY3QzMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQ4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250YWluZXIvUm9vdFN1cmZhY2UuanMKdmFyIFJlYWN0MzEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0NSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvekluZGV4L1pJbmRleFBvcnRhbC5qcwp2YXIgUmVhY3QzMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQ0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBaSW5kZXhTdmdQb3J0YWwoX3JlZjIpIHsKICB2YXIgewogICAgekluZGV4LAogICAgaXNQYW5vcmFtYQogIH0gPSBfcmVmMjsKICB2YXIgcHJlZml4ID0gaXNQYW5vcmFtYSA/ICJyZWNoYXJ0cy16aW5kZXgtcGFub3JhbWEtIiA6ICJyZWNoYXJ0cy16aW5kZXgtIjsKICB2YXIgcG9ydGFsSWQgPSB1c2VVbmlxdWVJZCgiIi5jb25jYXQocHJlZml4KS5jb25jYXQoekluZGV4KSk7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICAoMCwgaW1wb3J0X3JlYWN0NDQudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICBkaXNwYXRjaChyZWdpc3RlclpJbmRleFBvcnRhbElkKHsKICAgICAgekluZGV4LAogICAgICBlbGVtZW50SWQ6IHBvcnRhbElkLAogICAgICBpc1Bhbm9yYW1hCiAgICB9KSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBkaXNwYXRjaCh1bnJlZ2lzdGVyWkluZGV4UG9ydGFsSWQoewogICAgICAgIHpJbmRleCwKICAgICAgICBpc1Bhbm9yYW1hCiAgICAgIH0pKTsKICAgIH07CiAgfSwgW2Rpc3BhdGNoLCB6SW5kZXgsIHBvcnRhbElkLCBpc1Bhbm9yYW1hXSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICB0YWJJbmRleDogLTEsCiAgICBpZDogcG9ydGFsSWQKICB9KTsKfQpmdW5jdGlvbiBBbGxaSW5kZXhQb3J0YWxzKF9yZWYyKSB7CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgaXNQYW5vcmFtYQogIH0gPSBfcmVmMjsKICB2YXIgYWxsUmVnaXN0ZXJlZFpJbmRleGVzID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0QWxsUmVnaXN0ZXJlZFpJbmRleGVzKTsKICBpZiAoIWFsbFJlZ2lzdGVyZWRaSW5kZXhlcyB8fCBhbGxSZWdpc3RlcmVkWkluZGV4ZXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gY2hpbGRyZW47CiAgfQogIHZhciBhbGxOZWdhdGl2ZVpJbmRleGVzID0gYWxsUmVnaXN0ZXJlZFpJbmRleGVzLmZpbHRlcigoekluZGV4KSA9PiB6SW5kZXggPCAwKTsKICB2YXIgYWxsUG9zaXRpdmVaSW5kZXhlcyA9IGFsbFJlZ2lzdGVyZWRaSW5kZXhlcy5maWx0ZXIoKHpJbmRleCkgPT4gekluZGV4ID4gMCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoUmVhY3QzMC5GcmFnbWVudCwgbnVsbCwgYWxsTmVnYXRpdmVaSW5kZXhlcy5tYXAoKHpJbmRleCkgPT4gLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChaSW5kZXhTdmdQb3J0YWwsIHsKICAgIGtleTogekluZGV4LAogICAgekluZGV4LAogICAgaXNQYW5vcmFtYQogIH0pKSwgY2hpbGRyZW4sIGFsbFBvc2l0aXZlWkluZGV4ZXMubWFwKCh6SW5kZXgpID0+IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMwLmNyZWF0ZUVsZW1lbnQoWkluZGV4U3ZnUG9ydGFsLCB7CiAgICBrZXk6IHpJbmRleCwKICAgIHpJbmRleCwKICAgIGlzUGFub3JhbWEKICB9KSkpOwp9CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRhaW5lci9Sb290U3VyZmFjZS5qcwp2YXIgX2V4Y2x1ZGVkMTYgPSBbImNoaWxkcmVuIl07CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczE2KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxNihlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTYocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9leHRlbmRzMjAoKSB7CiAgcmV0dXJuIF9leHRlbmRzMjAgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczIwLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KdmFyIEZVTExfV0lEVEhfQU5EX0hFSUdIVCA9IHsKICB3aWR0aDogIjEwMCUiLAogIGhlaWdodDogIjEwMCUiLAogIC8qCiAgICogZGlzcGxheTogYmxvY2sgaXMgbmVjZXNzYXJ5IGhlcmUgYmVjYXVzZSB0aGUgZGVmYXVsdCBmb3IgYW4gU1ZHIGlzIGRpc3BsYXk6IGlubGluZSwKICAgKiB3aGljaCBpbiBzb21lIGJyb3dzZXJzIChDaHJvbWUpIGFkZHMgYSBsaXR0bGUgYml0IG9mIGV4dHJhIHNwYWNlIGFib3ZlIGFuZCBiZWxvdyB0aGUgU1ZHCiAgICogdG8gbWFrZSBzcGFjZSBmb3IgdGhlIGRlc2NlbmRlciBvZiBsZXR0ZXJzIGxpa2UgImciIGFuZCAieSIuIFRoaXMgdGhyb3dzIG9mZiB0aGUgaGVpZ2h0IGNhbGN1bGF0aW9uCiAgICogYW5kIGNhdXNlcyB0aGUgY29udGFpbmVyIHRvIGdyb3cgaW5kZWZpbml0ZWx5IG9uIGVhY2ggcmVuZGVyIHdpdGggcmVzcG9uc2l2ZT10cnVlLgogICAqIERpc3BsYXk6IGJsb2NrIHJlbW92ZXMgdGhhdCBleHRyYSBzcGFjZS4KICAgKgogICAqIEludGVyZXN0aW5nbHksIEZpcmVmb3ggZG9lcyBub3QgaGF2ZSB0aGlzIHByb2JsZW0sIGJ1dCBpdCBkb2Vzbid0IGh1cnQgdG8gYWRkIHRoZSBzdHlsZSBhbnl3YXkuCiAgICovCiAgZGlzcGxheTogImJsb2NrIgp9Owp2YXIgTWFpbkNoYXJ0U3VyZmFjZSA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDUuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgd2lkdGggPSB1c2VDaGFydFdpZHRoKCk7CiAgdmFyIGhlaWdodCA9IHVzZUNoYXJ0SGVpZ2h0KCk7CiAgdmFyIGhhc0FjY2Vzc2liaWxpdHlMYXllciA9IHVzZUFjY2Vzc2liaWxpdHlMYXllcigpOwogIGlmICghaXNQb3NpdGl2ZU51bWJlcih3aWR0aCkgfHwgIWlzUG9zaXRpdmVOdW1iZXIoaGVpZ2h0KSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBjaGlsZHJlbiwKICAgIG90aGVyQXR0cmlidXRlcywKICAgIHRpdGxlLAogICAgZGVzYwogIH0gPSBwcm9wczsKICB2YXIgdGFiSW5kZXgsIHJvbGU7CiAgaWYgKG90aGVyQXR0cmlidXRlcyAhPSBudWxsKSB7CiAgICBpZiAodHlwZW9mIG90aGVyQXR0cmlidXRlcy50YWJJbmRleCA9PT0gIm51bWJlciIpIHsKICAgICAgdGFiSW5kZXggPSBvdGhlckF0dHJpYnV0ZXMudGFiSW5kZXg7CiAgICB9IGVsc2UgewogICAgICB0YWJJbmRleCA9IGhhc0FjY2Vzc2liaWxpdHlMYXllciA/IDAgOiB2b2lkIDA7CiAgICB9CiAgICBpZiAodHlwZW9mIG90aGVyQXR0cmlidXRlcy5yb2xlID09PSAic3RyaW5nIikgewogICAgICByb2xlID0gb3RoZXJBdHRyaWJ1dGVzLnJvbGU7CiAgICB9IGVsc2UgewogICAgICByb2xlID0gaGFzQWNjZXNzaWJpbGl0eUxheWVyID8gImFwcGxpY2F0aW9uIiA6IHZvaWQgMDsKICAgIH0KICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMxLmNyZWF0ZUVsZW1lbnQoU3VyZmFjZSwgX2V4dGVuZHMyMCh7fSwgb3RoZXJBdHRyaWJ1dGVzLCB7CiAgICB0aXRsZSwKICAgIGRlc2MsCiAgICByb2xlLAogICAgdGFiSW5kZXgsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHN0eWxlOiBGVUxMX1dJRFRIX0FORF9IRUlHSFQsCiAgICByZWYKICB9KSwgY2hpbGRyZW4pOwp9KTsKdmFyIEJydXNoUGFub3JhbWFTdXJmYWNlID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyOwogIHZhciBicnVzaERpbWVuc2lvbnMgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RCcnVzaERpbWVuc2lvbnMpOwogIGlmICghYnJ1c2hEaW1lbnNpb25zKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgeTogeTIsCiAgICB4OiB4MgogIH0gPSBicnVzaERpbWVuc2lvbnM7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMxLmNyZWF0ZUVsZW1lbnQoU3VyZmFjZSwgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICB4OiB4MiwKICAgIHk6IHkyCiAgfSwgY2hpbGRyZW4pOwp9Owp2YXIgUm9vdFN1cmZhY2UgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ1LmZvcndhcmRSZWYpKChfcmVmMiwgcmVmKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyLCByZXN0ID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTYoX3JlZjIsIF9leGNsdWRlZDE2KTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICBpZiAoaXNQYW5vcmFtYSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMxLmNyZWF0ZUVsZW1lbnQoQnJ1c2hQYW5vcmFtYVN1cmZhY2UsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMxLmNyZWF0ZUVsZW1lbnQoQWxsWkluZGV4UG9ydGFscywgewogICAgICBpc1Bhbm9yYW1hOiB0cnVlCiAgICB9LCBjaGlsZHJlbikpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzEuY3JlYXRlRWxlbWVudChNYWluQ2hhcnRTdXJmYWNlLCBfZXh0ZW5kczIwKHsKICAgIHJlZgogIH0sIHJlc3QpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMS5jcmVhdGVFbGVtZW50KEFsbFpJbmRleFBvcnRhbHMsIHsKICAgIGlzUGFub3JhbWE6IGZhbHNlCiAgfSwgY2hpbGRyZW4pKTsKfSk7CgovLyBub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L1JlY2hhcnRzV3JhcHBlci5qcwp2YXIgUmVhY3QzMiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQ3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3VzZVJlcG9ydFNjYWxlLmpzCnZhciBpbXBvcnRfcmVhY3Q0NiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gdXNlUmVwb3J0U2NhbGUoKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgW3JlZiwgc2V0UmVmXSA9ICgwLCBpbXBvcnRfcmVhY3Q0Ni51c2VTdGF0ZSkobnVsbCk7CiAgdmFyIHNjYWxlID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0Q29udGFpbmVyU2NhbGUpOwogICgwLCBpbXBvcnRfcmVhY3Q0Ni51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChyZWYgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgcmVjdCA9IHJlZi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIHZhciBuZXdTY2FsZSA9IHJlY3Qud2lkdGggLyByZWYub2Zmc2V0V2lkdGg7CiAgICBpZiAoaXNXZWxsQmVoYXZlZE51bWJlcihuZXdTY2FsZSkgJiYgbmV3U2NhbGUgIT09IHNjYWxlKSB7CiAgICAgIGRpc3BhdGNoKHNldFNjYWxlKG5ld1NjYWxlKSk7CiAgICB9CiAgfSwgW3JlZiwgZGlzcGF0Y2gsIHNjYWxlXSk7CiAgcmV0dXJuIHNldFJlZjsKfQoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9SZWNoYXJ0c1dyYXBwZXIuanMKZnVuY3Rpb24gb3duS2V5czMxKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMzEoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMzMShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MzMoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMzEoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTMzKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MzMocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MzModCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMzModCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMzModCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9leHRlbmRzMjEoKSB7CiAgcmV0dXJuIF9leHRlbmRzMjEgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczIxLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KdmFyIEV2ZW50U3luY2hyb25pemVyID0gKCkgPT4gewogIHVzZVN5bmNocm9uaXNlZEV2ZW50c0Zyb21PdGhlckNoYXJ0cygpOwogIHJldHVybiBudWxsOwp9OwpmdW5jdGlvbiBnZXROdW1iZXJPclplcm8odmFsdWUpIHsKICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIikgewogICAgcmV0dXJuIHZhbHVlOwogIH0KICBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewogICAgdmFyIHBhcnNlZCA9IHBhcnNlRmxvYXQodmFsdWUpOwogICAgaWYgKCFOdW1iZXIuaXNOYU4ocGFyc2VkKSkgewogICAgICByZXR1cm4gcGFyc2VkOwogICAgfQogIH0KICByZXR1cm4gMDsKfQp2YXIgUmVzcG9uc2l2ZURpdiA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDcuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgX3Byb3BzJHN0eWxlLCBfcHJvcHMkc3R5bGUyOwogIHZhciBvYnNlcnZlclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VSZWYpKG51bGwpOwogIHZhciBbc2l6ZXMsIHNldFNpemVzXSA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VTdGF0ZSkoewogICAgY29udGFpbmVyV2lkdGg6IGdldE51bWJlck9yWmVybygoX3Byb3BzJHN0eWxlID0gcHJvcHMuc3R5bGUpID09PSBudWxsIHx8IF9wcm9wcyRzdHlsZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3Byb3BzJHN0eWxlLndpZHRoKSwKICAgIGNvbnRhaW5lckhlaWdodDogZ2V0TnVtYmVyT3JaZXJvKChfcHJvcHMkc3R5bGUyID0gcHJvcHMuc3R5bGUpID09PSBudWxsIHx8IF9wcm9wcyRzdHlsZTIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9wcm9wcyRzdHlsZTIuaGVpZ2h0KQogIH0pOwogIHZhciBzZXRDb250YWluZXJTaXplID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgobmV3V2lkdGgsIG5ld0hlaWdodCkgPT4gewogICAgc2V0U2l6ZXMoKHByZXZTdGF0ZSkgPT4gewogICAgICB2YXIgcm91bmRlZFdpZHRoID0gTWF0aC5yb3VuZChuZXdXaWR0aCk7CiAgICAgIHZhciByb3VuZGVkSGVpZ2h0ID0gTWF0aC5yb3VuZChuZXdIZWlnaHQpOwogICAgICBpZiAocHJldlN0YXRlLmNvbnRhaW5lcldpZHRoID09PSByb3VuZGVkV2lkdGggJiYgcHJldlN0YXRlLmNvbnRhaW5lckhlaWdodCA9PT0gcm91bmRlZEhlaWdodCkgewogICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBjb250YWluZXJXaWR0aDogcm91bmRlZFdpZHRoLAogICAgICAgIGNvbnRhaW5lckhlaWdodDogcm91bmRlZEhlaWdodAogICAgICB9OwogICAgfSk7CiAgfSwgW10pOwogIHZhciBpbm5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKG5vZGUpID0+IHsKICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJlZihub2RlKTsKICAgIH0KICAgIGlmIChub2RlICE9IG51bGwgJiYgdHlwZW9mIFJlc2l6ZU9ic2VydmVyICE9PSAidW5kZWZpbmVkIikgewogICAgICB2YXIgewogICAgICAgIHdpZHRoOiBjb250YWluZXJXaWR0aCwKICAgICAgICBoZWlnaHQ6IGNvbnRhaW5lckhlaWdodAogICAgICB9ID0gbm9kZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgc2V0Q29udGFpbmVyU2l6ZShjb250YWluZXJXaWR0aCwgY29udGFpbmVySGVpZ2h0KTsKICAgICAgdmFyIGNhbGxiYWNrID0gKGVudHJpZXMpID0+IHsKICAgICAgICB2YXIgewogICAgICAgICAgd2lkdGgsCiAgICAgICAgICBoZWlnaHQKICAgICAgICB9ID0gZW50cmllc1swXS5jb250ZW50UmVjdDsKICAgICAgICBzZXRDb250YWluZXJTaXplKHdpZHRoLCBoZWlnaHQpOwogICAgICB9OwogICAgICB2YXIgb2JzZXJ2ZXIgPSBuZXcgUmVzaXplT2JzZXJ2ZXIoY2FsbGJhY2spOwogICAgICBvYnNlcnZlci5vYnNlcnZlKG5vZGUpOwogICAgICBvYnNlcnZlclJlZi5jdXJyZW50ID0gb2JzZXJ2ZXI7CiAgICB9CiAgfSwgW3JlZiwgc2V0Q29udGFpbmVyU2l6ZV0pOwogICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHZhciBvYnNlcnZlciA9IG9ic2VydmVyUmVmLmN1cnJlbnQ7CiAgICAgIGlmIChvYnNlcnZlciAhPSBudWxsKSB7CiAgICAgICAgb2JzZXJ2ZXIuZGlzY29ubmVjdCgpOwogICAgICB9CiAgICB9OwogIH0sIFtzZXRDb250YWluZXJTaXplXSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoUmVhY3QzMi5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChSZXBvcnRDaGFydFNpemUsIHsKICAgIHdpZHRoOiBzaXplcy5jb250YWluZXJXaWR0aCwKICAgIGhlaWdodDogc2l6ZXMuY29udGFpbmVySGVpZ2h0CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoImRpdiIsIF9leHRlbmRzMjEoewogICAgcmVmOiBpbm5lclJlZgogIH0sIHByb3BzKSkpOwp9KTsKdmFyIFJlYWRTaXplT25jZURpdiA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDcuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gcHJvcHM7CiAgdmFyIFtzaXplcywgc2V0U2l6ZXNdID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZVN0YXRlKSh7CiAgICBjb250YWluZXJXaWR0aDogZ2V0TnVtYmVyT3JaZXJvKHdpZHRoKSwKICAgIGNvbnRhaW5lckhlaWdodDogZ2V0TnVtYmVyT3JaZXJvKGhlaWdodCkKICB9KTsKICB2YXIgc2V0Q29udGFpbmVyU2l6ZSA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKG5ld1dpZHRoLCBuZXdIZWlnaHQpID0+IHsKICAgIHNldFNpemVzKChwcmV2U3RhdGUpID0+IHsKICAgICAgdmFyIHJvdW5kZWRXaWR0aCA9IE1hdGgucm91bmQobmV3V2lkdGgpOwogICAgICB2YXIgcm91bmRlZEhlaWdodCA9IE1hdGgucm91bmQobmV3SGVpZ2h0KTsKICAgICAgaWYgKHByZXZTdGF0ZS5jb250YWluZXJXaWR0aCA9PT0gcm91bmRlZFdpZHRoICYmIHByZXZTdGF0ZS5jb250YWluZXJIZWlnaHQgPT09IHJvdW5kZWRIZWlnaHQpIHsKICAgICAgICByZXR1cm4gcHJldlN0YXRlOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgY29udGFpbmVyV2lkdGg6IHJvdW5kZWRXaWR0aCwKICAgICAgICBjb250YWluZXJIZWlnaHQ6IHJvdW5kZWRIZWlnaHQKICAgICAgfTsKICAgIH0pOwogIH0sIFtdKTsKICB2YXIgaW5uZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChub2RlKSA9PiB7CiAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICByZWYobm9kZSk7CiAgICB9CiAgICBpZiAobm9kZSAhPSBudWxsKSB7CiAgICAgIHZhciB7CiAgICAgICAgd2lkdGg6IGNvbnRhaW5lcldpZHRoLAogICAgICAgIGhlaWdodDogY29udGFpbmVySGVpZ2h0CiAgICAgIH0gPSBub2RlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICBzZXRDb250YWluZXJTaXplKGNvbnRhaW5lcldpZHRoLCBjb250YWluZXJIZWlnaHQpOwogICAgfQogIH0sIFtyZWYsIHNldENvbnRhaW5lclNpemVdKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChSZWFjdDMyLkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFJlcG9ydENoYXJ0U2l6ZSwgewogICAgd2lkdGg6IHNpemVzLmNvbnRhaW5lcldpZHRoLAogICAgaGVpZ2h0OiBzaXplcy5jb250YWluZXJIZWlnaHQKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudCgiZGl2IiwgX2V4dGVuZHMyMSh7CiAgICByZWY6IGlubmVyUmVmCiAgfSwgcHJvcHMpKSk7Cn0pOwp2YXIgU3RhdGljRGl2ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0Ny5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBwcm9wczsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChSZWFjdDMyLkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFJlcG9ydENoYXJ0U2l6ZSwgewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudCgiZGl2IiwgX2V4dGVuZHMyMSh7CiAgICByZWYKICB9LCBwcm9wcykpKTsKfSk7CnZhciBOb25SZXNwb25zaXZlRGl2ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0Ny5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBwcm9wczsKICBpZiAoaXNQZXJjZW50KHdpZHRoKSB8fCBpc1BlcmNlbnQoaGVpZ2h0KSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoUmVhZFNpemVPbmNlRGl2LCBfZXh0ZW5kczIxKHt9LCBwcm9wcywgewogICAgICByZWYKICAgIH0pKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoU3RhdGljRGl2LCBfZXh0ZW5kczIxKHt9LCBwcm9wcywgewogICAgcmVmCiAgfSkpOwp9KTsKZnVuY3Rpb24gZ2V0V3JhcHBlckRpdkNvbXBvbmVudChyZXNwb25zaXZlKSB7CiAgcmV0dXJuIHJlc3BvbnNpdmUgPT09IHRydWUgPyBSZXNwb25zaXZlRGl2IDogTm9uUmVzcG9uc2l2ZURpdjsKfQp2YXIgUmVjaGFydHNXcmFwcGVyID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0Ny5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICBjaGlsZHJlbiwKICAgIGNsYXNzTmFtZSwKICAgIGhlaWdodDogaGVpZ2h0RnJvbVByb3BzLAogICAgb25DbGljaywKICAgIG9uQ29udGV4dE1lbnUsCiAgICBvbkRvdWJsZUNsaWNrLAogICAgb25Nb3VzZURvd24sCiAgICBvbk1vdXNlRW50ZXIsCiAgICBvbk1vdXNlTGVhdmUsCiAgICBvbk1vdXNlTW92ZSwKICAgIG9uTW91c2VVcCwKICAgIG9uVG91Y2hFbmQsCiAgICBvblRvdWNoTW92ZSwKICAgIG9uVG91Y2hTdGFydCwKICAgIHN0eWxlLAogICAgd2lkdGg6IHdpZHRoRnJvbVByb3BzLAogICAgcmVzcG9uc2l2ZSwKICAgIGRpc3BhdGNoVG91Y2hFdmVudHMgPSB0cnVlCiAgfSA9IHByb3BzOwogIHZhciBjb250YWluZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlUmVmKShudWxsKTsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBbdG9vbHRpcFBvcnRhbCwgc2V0VG9vbHRpcFBvcnRhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlU3RhdGUpKG51bGwpOwogIHZhciBbbGVnZW5kUG9ydGFsLCBzZXRMZWdlbmRQb3J0YWxdID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZVN0YXRlKShudWxsKTsKICB2YXIgc2V0U2NhbGVSZWYgPSB1c2VSZXBvcnRTY2FsZSgpOwogIHZhciByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zID0gdXNlUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQoKTsKICB2YXIgd2lkdGggPSAocmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucyA9PT0gbnVsbCB8fCByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLndpZHRoKSA+IDAgPyByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLndpZHRoIDogd2lkdGhGcm9tUHJvcHM7CiAgdmFyIGhlaWdodCA9IChyZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zID09PSBudWxsIHx8IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMuaGVpZ2h0KSA+IDAgPyByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLmhlaWdodCA6IGhlaWdodEZyb21Qcm9wczsKICB2YXIgaW5uZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChub2RlKSA9PiB7CiAgICBzZXRTY2FsZVJlZihub2RlKTsKICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJlZihub2RlKTsKICAgIH0KICAgIHNldFRvb2x0aXBQb3J0YWwobm9kZSk7CiAgICBzZXRMZWdlbmRQb3J0YWwobm9kZSk7CiAgICBpZiAobm9kZSAhPSBudWxsKSB7CiAgICAgIGNvbnRhaW5lclJlZi5jdXJyZW50ID0gbm9kZTsKICAgIH0KICB9LCBbc2V0U2NhbGVSZWYsIHJlZiwgc2V0VG9vbHRpcFBvcnRhbCwgc2V0TGVnZW5kUG9ydGFsXSk7CiAgdmFyIG15T25DbGljayA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKG1vdXNlQ2xpY2tBY3Rpb24oZSkpOwogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uQ2xpY2ssCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uQ2xpY2tdKTsKICB2YXIgbXlPbk1vdXNlRW50ZXIgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChtb3VzZU1vdmVBY3Rpb24oZSkpOwogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uTW91c2VFbnRlciwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Nb3VzZUVudGVyXSk7CiAgdmFyIG15T25Nb3VzZUxlYXZlID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2gobW91c2VMZWF2ZUNoYXJ0KCkpOwogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uTW91c2VMZWF2ZSwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Nb3VzZUxlYXZlXSk7CiAgdmFyIG15T25Nb3VzZU1vdmUgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChtb3VzZU1vdmVBY3Rpb24oZSkpOwogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uTW91c2VNb3ZlLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbk1vdXNlTW92ZV0pOwogIHZhciBvbkZvY3VzID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoKSA9PiB7CiAgICBkaXNwYXRjaChmb2N1c0FjdGlvbigpKTsKICB9LCBbZGlzcGF0Y2hdKTsKICB2YXIgb25LZXlEb3duID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goa2V5RG93bkFjdGlvbihlLmtleSkpOwogIH0sIFtkaXNwYXRjaF0pOwogIHZhciBteU9uQ29udGV4dE1lbnUgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Db250ZXh0TWVudSwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Db250ZXh0TWVudV0pOwogIHZhciBteU9uRG91YmxlQ2xpY2sgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Eb3VibGVDbGljaywKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Eb3VibGVDbGlja10pOwogIHZhciBteU9uTW91c2VEb3duID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uTW91c2VEb3duLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbk1vdXNlRG93bl0pOwogIHZhciBteU9uTW91c2VVcCA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbk1vdXNlVXAsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uTW91c2VVcF0pOwogIHZhciBteU9uVG91Y2hTdGFydCA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvblRvdWNoU3RhcnQsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uVG91Y2hTdGFydF0pOwogIHZhciBteU9uVG91Y2hNb3ZlID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgaWYgKGRpc3BhdGNoVG91Y2hFdmVudHMpIHsKICAgICAgZGlzcGF0Y2godG91Y2hFdmVudEFjdGlvbihlKSk7CiAgICB9CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Ub3VjaE1vdmUsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIGRpc3BhdGNoVG91Y2hFdmVudHMsIG9uVG91Y2hNb3ZlXSk7CiAgdmFyIG15T25Ub3VjaEVuZCA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvblRvdWNoRW5kLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvblRvdWNoRW5kXSk7CiAgdmFyIFdyYXBwZXJEaXYgPSBnZXRXcmFwcGVyRGl2Q29tcG9uZW50KHJlc3BvbnNpdmUpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFRvb2x0aXBQb3J0YWxDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogdG9vbHRpcFBvcnRhbAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoTGVnZW5kUG9ydGFsQ29udGV4dC5Qcm92aWRlciwgewogICAgdmFsdWU6IGxlZ2VuZFBvcnRhbAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoV3JhcHBlckRpdiwgewogICAgd2lkdGg6IHdpZHRoICE9PSBudWxsICYmIHdpZHRoICE9PSB2b2lkIDAgPyB3aWR0aCA6IHN0eWxlID09PSBudWxsIHx8IHN0eWxlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzdHlsZS53aWR0aCwKICAgIGhlaWdodDogaGVpZ2h0ICE9PSBudWxsICYmIGhlaWdodCAhPT0gdm9pZCAwID8gaGVpZ2h0IDogc3R5bGUgPT09IG51bGwgfHwgc3R5bGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHN0eWxlLmhlaWdodCwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtd3JhcHBlciIsIGNsYXNzTmFtZSksCiAgICBzdHlsZTogX29iamVjdFNwcmVhZDMxKHsKICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIsCiAgICAgIGN1cnNvcjogImRlZmF1bHQiLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9LCBzdHlsZSksCiAgICBvbkNsaWNrOiBteU9uQ2xpY2ssCiAgICBvbkNvbnRleHRNZW51OiBteU9uQ29udGV4dE1lbnUsCiAgICBvbkRvdWJsZUNsaWNrOiBteU9uRG91YmxlQ2xpY2ssCiAgICBvbkZvY3VzLAogICAgb25LZXlEb3duLAogICAgb25Nb3VzZURvd246IG15T25Nb3VzZURvd24sCiAgICBvbk1vdXNlRW50ZXI6IG15T25Nb3VzZUVudGVyLAogICAgb25Nb3VzZUxlYXZlOiBteU9uTW91c2VMZWF2ZSwKICAgIG9uTW91c2VNb3ZlOiBteU9uTW91c2VNb3ZlLAogICAgb25Nb3VzZVVwOiBteU9uTW91c2VVcCwKICAgIG9uVG91Y2hFbmQ6IG15T25Ub3VjaEVuZCwKICAgIG9uVG91Y2hNb3ZlOiBteU9uVG91Y2hNb3ZlLAogICAgb25Ub3VjaFN0YXJ0OiBteU9uVG91Y2hTdGFydCwKICAgIHJlZjogaW5uZXJSZWYKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KEV2ZW50U3luY2hyb25pemVyLCBudWxsKSwgY2hpbGRyZW4pKSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9DYXRlZ29yaWNhbENoYXJ0LmpzCnZhciBfZXhjbHVkZWQxNyA9IFsid2lkdGgiLCAiaGVpZ2h0IiwgInJlc3BvbnNpdmUiLCAiY2hpbGRyZW4iLCAiY2xhc3NOYW1lIiwgInN0eWxlIiwgImNvbXBhY3QiLCAidGl0bGUiLCAiZGVzYyJdOwpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNyhlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTcoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE3KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgQ2F0ZWdvcmljYWxDaGFydCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDguZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByZXNwb25zaXZlLAogICAgY2hpbGRyZW4sCiAgICBjbGFzc05hbWUsCiAgICBzdHlsZSwKICAgIGNvbXBhY3QsCiAgICB0aXRsZSwKICAgIGRlc2MKICB9ID0gcHJvcHMsIG90aGVycyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczE3KHByb3BzLCBfZXhjbHVkZWQxNyk7CiAgdmFyIGF0dHJzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKG90aGVycyk7CiAgaWYgKGNvbXBhY3QpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KFJlYWN0MzMuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMzLmNyZWF0ZUVsZW1lbnQoUmVwb3J0Q2hhcnRTaXplLCB7CiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQKICAgIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KFJvb3RTdXJmYWNlLCB7CiAgICAgIG90aGVyQXR0cmlidXRlczogYXR0cnMsCiAgICAgIHRpdGxlLAogICAgICBkZXNjCiAgICB9LCBjaGlsZHJlbikpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChSZWNoYXJ0c1dyYXBwZXIsIHsKICAgIGNsYXNzTmFtZSwKICAgIHN0eWxlLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByZXNwb25zaXZlOiByZXNwb25zaXZlICE9PSBudWxsICYmIHJlc3BvbnNpdmUgIT09IHZvaWQgMCA/IHJlc3BvbnNpdmUgOiBmYWxzZSwKICAgIG9uQ2xpY2s6IHByb3BzLm9uQ2xpY2ssCiAgICBvbk1vdXNlTGVhdmU6IHByb3BzLm9uTW91c2VMZWF2ZSwKICAgIG9uTW91c2VFbnRlcjogcHJvcHMub25Nb3VzZUVudGVyLAogICAgb25Nb3VzZU1vdmU6IHByb3BzLm9uTW91c2VNb3ZlLAogICAgb25Nb3VzZURvd246IHByb3BzLm9uTW91c2VEb3duLAogICAgb25Nb3VzZVVwOiBwcm9wcy5vbk1vdXNlVXAsCiAgICBvbkNvbnRleHRNZW51OiBwcm9wcy5vbkNvbnRleHRNZW51LAogICAgb25Eb3VibGVDbGljazogcHJvcHMub25Eb3VibGVDbGljaywKICAgIG9uVG91Y2hTdGFydDogcHJvcHMub25Ub3VjaFN0YXJ0LAogICAgb25Ub3VjaE1vdmU6IHByb3BzLm9uVG91Y2hNb3ZlLAogICAgb25Ub3VjaEVuZDogcHJvcHMub25Ub3VjaEVuZAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMzLmNyZWF0ZUVsZW1lbnQoUm9vdFN1cmZhY2UsIHsKICAgIG90aGVyQXR0cmlidXRlczogYXR0cnMsCiAgICB0aXRsZSwKICAgIGRlc2MsCiAgICByZWYKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KENsaXBQYXRoUHJvdmlkZXIsIG51bGwsIGNoaWxkcmVuKSkpOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvQ2FydGVzaWFuQ2hhcnQuanMKZnVuY3Rpb24gX2V4dGVuZHMyMigpIHsKICByZXR1cm4gX2V4dGVuZHMyMiA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMjIuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQp2YXIgZGVmYXVsdE1hcmdpbiA9IHsKICB0b3A6IDUsCiAgcmlnaHQ6IDUsCiAgYm90dG9tOiA1LAogIGxlZnQ6IDUKfTsKdmFyIGRlZmF1bHRDYXJ0ZXNpYW5DaGFydFByb3BzID0gewogIGFjY2Vzc2liaWxpdHlMYXllcjogdHJ1ZSwKICBiYXJDYXRlZ29yeUdhcDogIjEwJSIsCiAgYmFyR2FwOiA0LAogIGxheW91dDogImhvcml6b250YWwiLAogIG1hcmdpbjogZGVmYXVsdE1hcmdpbiwKICByZXNwb25zaXZlOiBmYWxzZSwKICByZXZlcnNlU3RhY2tPcmRlcjogZmFsc2UsCiAgc3RhY2tPZmZzZXQ6ICJub25lIiwKICBzeW5jTWV0aG9kOiAiaW5kZXgiCn07CnZhciBDYXJ0ZXNpYW5DaGFydCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDkuZm9yd2FyZFJlZikoZnVuY3Rpb24gQ2FydGVzaWFuQ2hhcnQyKHByb3BzLCByZWYpIHsKICB2YXIgX2NhdGVnb3JpY2FsQ2hhcnRQcm9wOwogIHZhciByb290Q2hhcnRQcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMocHJvcHMuY2F0ZWdvcmljYWxDaGFydFByb3BzLCBkZWZhdWx0Q2FydGVzaWFuQ2hhcnRQcm9wcyk7CiAgdmFyIHsKICAgIGNoYXJ0TmFtZSwKICAgIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlLAogICAgdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcywKICAgIHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsCiAgICBjYXRlZ29yaWNhbENoYXJ0UHJvcHMKICB9ID0gcHJvcHM7CiAgdmFyIG9wdGlvbnMgPSB7CiAgICBjaGFydE5hbWUsCiAgICBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSwKICAgIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMsCiAgICB0b29sdGlwUGF5bG9hZFNlYXJjaGVyLAogICAgZXZlbnRFbWl0dGVyOiB2b2lkIDAKICB9OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzNC5jcmVhdGVFbGVtZW50KFJlY2hhcnRzU3RvcmVQcm92aWRlciwgewogICAgcHJlbG9hZGVkU3RhdGU6IHsKICAgICAgb3B0aW9ucwogICAgfSwKICAgIHJlZHV4U3RvcmVOYW1lOiAoX2NhdGVnb3JpY2FsQ2hhcnRQcm9wID0gY2F0ZWdvcmljYWxDaGFydFByb3BzLmlkKSAhPT0gbnVsbCAmJiBfY2F0ZWdvcmljYWxDaGFydFByb3AgIT09IHZvaWQgMCA/IF9jYXRlZ29yaWNhbENoYXJ0UHJvcCA6IGNoYXJ0TmFtZQogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM0LmNyZWF0ZUVsZW1lbnQoQ2hhcnREYXRhQ29udGV4dFByb3ZpZGVyLCB7CiAgICBjaGFydERhdGE6IGNhdGVnb3JpY2FsQ2hhcnRQcm9wcy5kYXRhCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM0LmNyZWF0ZUVsZW1lbnQoUmVwb3J0TWFpbkNoYXJ0UHJvcHMsIHsKICAgIGxheW91dDogcm9vdENoYXJ0UHJvcHMubGF5b3V0LAogICAgbWFyZ2luOiByb290Q2hhcnRQcm9wcy5tYXJnaW4KICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzQuY3JlYXRlRWxlbWVudChSZXBvcnRDaGFydFByb3BzLCB7CiAgICBiYXNlVmFsdWU6IHJvb3RDaGFydFByb3BzLmJhc2VWYWx1ZSwKICAgIGFjY2Vzc2liaWxpdHlMYXllcjogcm9vdENoYXJ0UHJvcHMuYWNjZXNzaWJpbGl0eUxheWVyLAogICAgYmFyQ2F0ZWdvcnlHYXA6IHJvb3RDaGFydFByb3BzLmJhckNhdGVnb3J5R2FwLAogICAgbWF4QmFyU2l6ZTogcm9vdENoYXJ0UHJvcHMubWF4QmFyU2l6ZSwKICAgIHN0YWNrT2Zmc2V0OiByb290Q2hhcnRQcm9wcy5zdGFja09mZnNldCwKICAgIGJhckdhcDogcm9vdENoYXJ0UHJvcHMuYmFyR2FwLAogICAgYmFyU2l6ZTogcm9vdENoYXJ0UHJvcHMuYmFyU2l6ZSwKICAgIHN5bmNJZDogcm9vdENoYXJ0UHJvcHMuc3luY0lkLAogICAgc3luY01ldGhvZDogcm9vdENoYXJ0UHJvcHMuc3luY01ldGhvZCwKICAgIGNsYXNzTmFtZTogcm9vdENoYXJ0UHJvcHMuY2xhc3NOYW1lLAogICAgcmV2ZXJzZVN0YWNrT3JkZXI6IHJvb3RDaGFydFByb3BzLnJldmVyc2VTdGFja09yZGVyCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM0LmNyZWF0ZUVsZW1lbnQoQ2F0ZWdvcmljYWxDaGFydCwgX2V4dGVuZHMyMih7fSwgcm9vdENoYXJ0UHJvcHMsIHsKICAgIHJlZgogIH0pKSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9BcmVhQ2hhcnQuanMKdmFyIFJlYWN0MzUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q1MCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGFsbG93ZWRUb29sdGlwVHlwZXMgPSBbImF4aXMiXTsKdmFyIEFyZWFDaGFydCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NTAuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzUuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5DaGFydCwgewogICAgY2hhcnROYW1lOiAiQXJlYUNoYXJ0IiwKICAgIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlOiAiYXhpcyIsCiAgICB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzOiBhbGxvd2VkVG9vbHRpcFR5cGVzLAogICAgdG9vbHRpcFBheWxvYWRTZWFyY2hlcjogYXJyYXlUb29sdGlwU2VhcmNoZXIsCiAgICBjYXRlZ29yaWNhbENoYXJ0UHJvcHM6IHByb3BzLAogICAgcmVmCiAgfSk7Cn0pOwoKLy8gc3JjL015QnVkZ2V0LnRzeAp2YXIgaW1wb3J0X2pzeF9ydW50aW1lID0gX190b0VTTShyZXF1aXJlX2pzeF9ydW50aW1lKCksIDEpOwp2YXIgU1RPUkFHRV9LRVkgPSAiTVlfQlVER0VUX0RBVEEiOwp2YXIgQlVER0VUU19MSVNUX0tFWSA9ICJNWV9CVURHRVRfTElTVCI7CnZhciBnZW5lcmF0ZUlkID0gKCkgPT4gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpOwp2YXIgQ09MT1JTID0gewogIHByaW1hcnk6ICIjMUI0MzMyIiwKICBwcmltYXJ5RGFyazogIiMwRjJCMUYiLAogIHByaW1hcnlMaWdodDogIiMyRDZBNEYiLAogIGFjY2VudDogIiM0MDkxNkMiLAogIGFjY2VudExpZ2h0OiAiI0U4RjVFOSIsCiAgYmc6ICIjRjVGNUYwIiwKICBjYXJkOiAiI0ZGRkZGRiIsCiAgYm9yZGVyOiAiI0U1RTdFQiIsCiAgYm9yZGVyTGlnaHQ6ICIjRjBGMEYwIiwKICB0ZXh0TWFpbjogIiMxQTFBMUEiLAogIHRleHRTZWNvbmRhcnk6ICIjNkI3MjgwIiwKICB0ZXh0TXV0ZWQ6ICIjOUNBM0FGIiwKICBpbmNvbWU6ICIjMDU5NjY5IiwKICBpbmNvbWVCZzogIiNFQ0ZERjUiLAogIGV4cGVuc2U6ICIjREMyNjI2IiwKICBleHBlbnNlQmc6ICIjRkVGMkYyIiwKICBhc3NldDogIiMyNTYzRUIiLAogIGFzc2V0Qmc6ICIjRUZGNkZGIiwKICBub25MaXF1aWQ6ICIjN0MzQUVEIiwKICBub25MaXF1aWRCZzogIiNGNUYzRkYiLAogIHJldGlyZW1lbnQ6ICIjMDg5MUIyIiwKICByZXRpcmVtZW50Qmc6ICIjRUNGRUZGIiwKICBsaWFiaWxpdHk6ICIjRUE1ODBDIiwKICBsaWFiaWxpdHlCZzogIiNGRkY3RUQiLAogIHBvc2l0aXZlOiAiIzA1OTY2OSIsCiAgbmVnYXRpdmU6ICIjREMyNjI2IiwKICB3YXJuaW5nOiAiI0Q5NzcwNiIKfTsKdmFyIGZtdCA9IChuKSA9PiB7CiAgaWYgKE1hdGguYWJzKG4pID49IDFlNikgcmV0dXJuIGAkJHsobiAvIDFlNikudG9GaXhlZCgyKX1NYDsKICByZXR1cm4gbi50b0xvY2FsZVN0cmluZygiZW4tVVMiLCB7IHN0eWxlOiAiY3VycmVuY3kiLCBjdXJyZW5jeTogIlVTRCIsIG1pbmltdW1GcmFjdGlvbkRpZ2l0czogMCwgbWF4aW11bUZyYWN0aW9uRGlnaXRzOiAwIH0pOwp9Owp2YXIgZm10RXhhY3QgPSAobikgPT4gbi50b0xvY2FsZVN0cmluZygiZW4tVVMiLCB7IHN0eWxlOiAiY3VycmVuY3kiLCBjdXJyZW5jeTogIlVTRCIsIG1pbmltdW1GcmFjdGlvbkRpZ2l0czogMCwgbWF4aW11bUZyYWN0aW9uRGlnaXRzOiAwIH0pOwp2YXIgZm10UHJpY2UgPSAobikgPT4gbi50b0xvY2FsZVN0cmluZygiZW4tVVMiLCB7IHN0eWxlOiAiY3VycmVuY3kiLCBjdXJyZW5jeTogIlVTRCIsIG1pbmltdW1GcmFjdGlvbkRpZ2l0czogMiwgbWF4aW11bUZyYWN0aW9uRGlnaXRzOiAyIH0pOwp2YXIgZW1wdHlCdWRnZXQgPSAoKSA9PiAoewogIGlkOiBnZW5lcmF0ZUlkKCksCiAgbmFtZTogIk15IEJ1ZGdldCIsCiAgaW5jb21lOiBbXSwKICBleHBlbnNlczogW10sCiAgYXNzZXRzOiBbXSwKICBub25MaXF1aWRBc3NldHM6IFtdLAogIHJldGlyZW1lbnQ6IFtdLAogIGxpYWJpbGl0aWVzOiBbXSwKICBub25MaXF1aWREaXNjb3VudDogMjUsCiAgY3JlYXRlZEF0OiBEYXRlLm5vdygpLAogIHVwZGF0ZWRBdDogRGF0ZS5ub3coKQp9KTsKdmFyIGVtcHR5SXRlbSA9IChmcmVxID0gIm1vbnRobHkiKSA9PiAoewogIGlkOiBnZW5lcmF0ZUlkKCksCiAgbmFtZTogIiIsCiAgYW1vdW50OiAwLAogIGZyZXF1ZW5jeTogZnJlcSwKICB0b3RhbFZhbHVlOiAwLAogIG1vbnRobHlWYWx1ZTogMAp9KTsKdmFyIGNvbXB1dGVWYWx1ZXMgPSAoYW1vdW50LCBmcmVxdWVuY3kpID0+IHsKICBzd2l0Y2ggKGZyZXF1ZW5jeSkgewogICAgY2FzZSAibW9udGhseSI6CiAgICAgIHJldHVybiB7IHRvdGFsVmFsdWU6IGFtb3VudCAqIDEyLCBtb250aGx5VmFsdWU6IGFtb3VudCB9OwogICAgY2FzZSAieWVhcmx5IjoKICAgICAgcmV0dXJuIHsgdG90YWxWYWx1ZTogYW1vdW50LCBtb250aGx5VmFsdWU6IE1hdGgucm91bmQoYW1vdW50IC8gMTIgKiAxMDApIC8gMTAwIH07CiAgICBjYXNlICJvbmVfdGltZSI6CiAgICAgIHJldHVybiB7IHRvdGFsVmFsdWU6IGFtb3VudCwgbW9udGhseVZhbHVlOiAwIH07CiAgfQp9Owp2YXIgdHJhY2tFdmVudCA9IChldmVudCwgZGF0YSkgPT4gewogIGZldGNoKCIvYXBpL3RyYWNrIiwgewogICAgbWV0aG9kOiAiUE9TVCIsCiAgICBoZWFkZXJzOiB7ICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIgfSwKICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXZlbnQsIGRhdGE6IGRhdGEgfHwge30gfSkKICB9KS5jYXRjaCgoKSA9PiB7CiAgfSk7Cn07CnZhciBDT0lOR0VDS09fQkFTRSA9ICJodHRwczovL2FwaS5jb2luZ2Vja28uY29tL2FwaS92MyI7CnZhciBzZWFyY2hDb2lucyA9IGFzeW5jIChxdWVyeSkgPT4gewogIGlmICghcXVlcnkgfHwgcXVlcnkubGVuZ3RoIDwgMikgcmV0dXJuIFtdOwogIHRyeSB7CiAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaChgJHtDT0lOR0VDS09fQkFTRX0vc2VhcmNoP3F1ZXJ5PSR7ZW5jb2RlVVJJQ29tcG9uZW50KHF1ZXJ5KX1gKTsKICAgIGlmICghcmVzLm9rKSByZXR1cm4gW107CiAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmpzb24oKTsKICAgIHJldHVybiAoZGF0YS5jb2lucyB8fCBbXSkuc2xpY2UoMCwgOCkubWFwKChjKSA9PiAoewogICAgICBpZDogYy5pZCwKICAgICAgbmFtZTogYy5uYW1lLAogICAgICBzeW1ib2w6IGMuc3ltYm9sLAogICAgICB0aHVtYjogYy50aHVtYgogICAgfSkpOwogIH0gY2F0Y2ggewogICAgcmV0dXJuIFtdOwogIH0KfTsKdmFyIGZldGNoQ3J5cHRvUHJpY2VzID0gYXN5bmMgKGlkcykgPT4gewogIGlmIChpZHMubGVuZ3RoID09PSAwKSByZXR1cm4ge307CiAgdHJ5IHsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKGAke0NPSU5HRUNLT19CQVNFfS9zaW1wbGUvcHJpY2U/aWRzPSR7aWRzLmpvaW4oIiwiKX0mdnNfY3VycmVuY2llcz11c2RgKTsKICAgIGlmICghcmVzLm9rKSByZXR1cm4ge307CiAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmpzb24oKTsKICAgIGNvbnN0IHByaWNlcyA9IHt9OwogICAgZm9yIChjb25zdCBpZCBvZiBpZHMpIHsKICAgICAgaWYgKGRhdGFbaWRdPy51c2QpIHByaWNlc1tpZF0gPSBkYXRhW2lkXS51c2Q7CiAgICB9CiAgICByZXR1cm4gcHJpY2VzOwogIH0gY2F0Y2ggewogICAgcmV0dXJuIHt9OwogIH0KfTsKdmFyIERFTU9fQlVER0VUID0gewogIGlkOiAiZGVtb19idWRnZXQiLAogIG5hbWU6ICJNeSBCdWRnZXQiLAogIGluY29tZTogWwogICAgeyBpZDogImluYzEiLCBuYW1lOiAicmVudGFsIGluY29tZSAoaG91c2UpIiwgYW1vdW50OiAxZTMsIGZyZXF1ZW5jeTogIm1vbnRobHkiLCB0b3RhbFZhbHVlOiAxMmUzLCBtb250aGx5VmFsdWU6IDFlMyB9LAogICAgeyBpZDogImluYzIiLCBuYW1lOiAicmVudGFsIGluY29tZSAocHJvcGVydGllcykiLCBhbW91bnQ6IDI1MDAsIGZyZXF1ZW5jeTogIm1vbnRobHkiLCB0b3RhbFZhbHVlOiAzZTQsIG1vbnRobHlWYWx1ZTogMjUwMCB9LAogICAgeyBpZDogImluYzMiLCBuYW1lOiAiVkEgcGF5bWVudHMiLCBhbW91bnQ6IDE0NTAsIGZyZXF1ZW5jeTogIm1vbnRobHkiLCB0b3RhbFZhbHVlOiAxNzQwMCwgbW9udGhseVZhbHVlOiAxNDUwIH0KICBdLAogIGV4cGVuc2VzOiBbCiAgICB7IGlkOiAiZXhwMSIsIG5hbWU6ICJmaW5jYSIsIGFtb3VudDogMWUzLCBmcmVxdWVuY3k6ICJtb250aGx5IiwgdG90YWxWYWx1ZTogMTJlMywgbW9udGhseVZhbHVlOiAxZTMgfSwKICAgIHsgaWQ6ICJleHAyIiwgbmFtZTogInBhcm1hIHJlbnQiLCBhbW91bnQ6IDFlMywgZnJlcXVlbmN5OiAibW9udGhseSIsIHRvdGFsVmFsdWU6IDEyZTMsIG1vbnRobHlWYWx1ZTogMWUzIH0KICBdLAogIGFzc2V0czogWwogICAgeyBpZDogImFzdDEiLCBuYW1lOiAiQml0Y29pbiIsIGFtb3VudDogMTRlNCwgZnJlcXVlbmN5OiAib25lX3RpbWUiLCB0b3RhbFZhbHVlOiAxNGU0LCBtb250aGx5VmFsdWU6IDAsIHF1YW50aXR5OiAyLCBhc3NldFR5cGU6ICJjcnlwdG8iLCB0aWNrZXI6ICJiaXRjb2luIiwgbGl2ZVByaWNlOiA3ZTQgfSwKICAgIHsgaWQ6ICJhc3QyIiwgbmFtZTogIk5FQVIgUHJvdG9jb2wiLCBhbW91bnQ6IDdlMywgZnJlcXVlbmN5OiAib25lX3RpbWUiLCB0b3RhbFZhbHVlOiA3ZTMsIG1vbnRobHlWYWx1ZTogMCwgcXVhbnRpdHk6IDdlMywgYXNzZXRUeXBlOiAiY3J5cHRvIiwgdGlja2VyOiAibmVhciIsIGxpdmVQcmljZTogMSB9LAogICAgeyBpZDogImFzdDMiLCBuYW1lOiAiRXRoZXJldW0iLCBhbW91bnQ6IDEwMTQ2LCBmcmVxdWVuY3k6ICJvbmVfdGltZSIsIHRvdGFsVmFsdWU6IDEwMTQ2LCBtb250aGx5VmFsdWU6IDAsIHF1YW50aXR5OiA1LjM0LCBhc3NldFR5cGU6ICJjcnlwdG8iLCB0aWNrZXI6ICJldGhlcmV1bSIsIGxpdmVQcmljZTogMTkwMCB9LAogICAgeyBpZDogImFzdDQiLCBuYW1lOiAiVVNEIENvaW4iLCBhbW91bnQ6IDM1MDAsIGZyZXF1ZW5jeTogIm9uZV90aW1lIiwgdG90YWxWYWx1ZTogMzUwMCwgbW9udGhseVZhbHVlOiAwLCBhc3NldFR5cGU6ICJjcnlwdG8iLCB0aWNrZXI6ICJ1c2QtY29pbiIsIGxpdmVQcmljZTogMSB9LAogICAgeyBpZDogImFzdDUiLCBuYW1lOiAiY29pbmJhc2UgYWNjb3VudCIsIGFtb3VudDogNzM1MDAsIGZyZXF1ZW5jeTogIm9uZV90aW1lIiwgdG90YWxWYWx1ZTogNzM1MDAsIG1vbnRobHlWYWx1ZTogMCB9LAogICAgeyBpZDogImFzdDYiLCBuYW1lOiAibG9hbiBmcm9tIEFsZXggKDEwLDAwMCkiLCBhbW91bnQ6IDAsIGZyZXF1ZW5jeTogIm9uZV90aW1lIiwgdG90YWxWYWx1ZTogMCwgbW9udGhseVZhbHVlOiAwIH0sCiAgICB7IGlkOiAiYXN0NyIsIG5hbWU6ICJzdG9jayBtYXJrZXQgKGJldHRlcm1lbnQpIiwgYW1vdW50OiAxNDU3MSwgZnJlcXVlbmN5OiAib25lX3RpbWUiLCB0b3RhbFZhbHVlOiAxNDU3MSwgbW9udGhseVZhbHVlOiAwIH0sCiAgICB7IGlkOiAiYXN0OCIsIG5hbWU6ICJORUFSLldBTExFVCIsIGFtb3VudDogMmUzLCBmcmVxdWVuY3k6ICJvbmVfdGltZSIsIHRvdGFsVmFsdWU6IDJlMywgbW9udGhseVZhbHVlOiAwLCBxdWFudGl0eTogMmUzIH0sCiAgICB7IGlkOiAiYXN0OSIsIG5hbWU6ICJTb0ZpIEludmVzdG1lbnQiLCBhbW91bnQ6IDFlMywgZnJlcXVlbmN5OiAib25lX3RpbWUiLCB0b3RhbFZhbHVlOiAxZTMsIG1vbnRobHlWYWx1ZTogMCB9LAogICAgeyBpZDogImFzdDEwIiwgbmFtZTogIkFtYXpvbiBTdG9jayIsIGFtb3VudDogMTc1MjAsIGZyZXF1ZW5jeTogIm9uZV90aW1lIiwgdG90YWxWYWx1ZTogMTc1MjAsIG1vbnRobHlWYWx1ZTogMCwgcXVhbnRpdHk6IDIxOSB9LAogICAgeyBpZDogImFzdDEyIiwgbmFtZTogIlNldHRsZW1lbnQ/IiwgYW1vdW50OiAwLCBmcmVxdWVuY3k6ICJvbmVfdGltZSIsIHRvdGFsVmFsdWU6IDAsIG1vbnRobHlWYWx1ZTogMCB9CiAgXSwKICBub25MaXF1aWRBc3NldHM6IFsKICAgIHsgaWQ6ICJubGExIiwgbmFtZTogIkJyZWl0bGluZyBHb2xkIiwgYW1vdW50OiAxOWUzLCBmcmVxdWVuY3k6ICJvbmVfdGltZSIsIHRvdGFsVmFsdWU6IDE5ZTMsIG1vbnRobHlWYWx1ZTogMCB9LAogICAgeyBpZDogIm5sYTIiLCBuYW1lOiAiQnJlZ3VldCBUcmFkaXRpb24iLCBhbW91bnQ6IDE1ZTMsIGZyZXF1ZW5jeTogIm9uZV90aW1lIiwgdG90YWxWYWx1ZTogMTVlMywgbW9udGhseVZhbHVlOiAwIH0sCiAgICB7IGlkOiAibmxhMyIsIG5hbWU6ICJCcmVndWV0IEJsdWUiLCBhbW91bnQ6IDI1ZTMsIGZyZXF1ZW5jeTogIm9uZV90aW1lIiwgdG90YWxWYWx1ZTogMjVlMywgbW9udGhseVZhbHVlOiAwIH0sCiAgICB7IGlkOiAibmxhNCIsIG5hbWU6ICJKTEMiLCBhbW91bnQ6IDI1ZTMsIGZyZXF1ZW5jeTogIm9uZV90aW1lIiwgdG90YWxWYWx1ZTogMjVlMywgbW9udGhseVZhbHVlOiAwIH0sCiAgICB7IGlkOiAibmxhNSIsIG5hbWU6ICJBbGwgb3RoZXIgd2F0Y2hlcyIsIGFtb3VudDogMWU0LCBmcmVxdWVuY3k6ICJvbmVfdGltZSIsIHRvdGFsVmFsdWU6IDFlNCwgbW9udGhseVZhbHVlOiAwIH0sCiAgICB7IGlkOiAibmxhNiIsIG5hbWU6ICJDYXIiLCBhbW91bnQ6IDE1ZTMsIGZyZXF1ZW5jeTogIm9uZV90aW1lIiwgdG90YWxWYWx1ZTogMTVlMywgbW9udGhseVZhbHVlOiAwIH0sCiAgICB7IGlkOiAibmxhNyIsIG5hbWU6ICJNb250QmxhbmMgUGVucyIsIGFtb3VudDogNWUzLCBmcmVxdWVuY3k6ICJvbmVfdGltZSIsIHRvdGFsVmFsdWU6IDVlMywgbW9udGhseVZhbHVlOiAwIH0KICBdLAogIHJldGlyZW1lbnQ6IFsKICAgIHsgaWQ6ICJyZXQxIiwgbmFtZTogIjQwMWsgKENoYXJsZXMgU2Nod2FiKSAoQWNjdCA5NTg2LTM0NjcpIiwgYW1vdW50OiAyMjUwMCwgZnJlcXVlbmN5OiAib25lX3RpbWUiLCB0b3RhbFZhbHVlOiAyMjUwMCwgbW9udGhseVZhbHVlOiAwIH0KICBdLAogIGxpYWJpbGl0aWVzOiBbCiAgICB7IGlkOiAibGlhMSIsIG5hbWU6ICJsYXMgcGFsbWFzIGFwdCIsIGFtb3VudDogNWU0LCBmcmVxdWVuY3k6ICJvbmVfdGltZSIsIHRvdGFsVmFsdWU6IDVlNCwgbW9udGhseVZhbHVlOiAwIH0sCiAgICB7IGlkOiAibGlhMiIsIG5hbWU6ICJyZXBheW1lbnQgb2YgdGFtbXkiLCBhbW91bnQ6IDJlNCwgZnJlcXVlbmN5OiAib25lX3RpbWUiLCB0b3RhbFZhbHVlOiAyZTQsIG1vbnRobHlWYWx1ZTogMCB9LAogICAgeyBpZDogImxpYTMiLCBuYW1lOiAicGVyc29uYWwgbW9udGhseSBleHBlbnNlcyIsIGFtb3VudDogN2UzLCBmcmVxdWVuY3k6ICJtb250aGx5IiwgdG90YWxWYWx1ZTogODRlMywgbW9udGhseVZhbHVlOiA3ZTMgfSwKICAgIHsgaWQ6ICJsaWE0IiwgbmFtZTogInJlbW9kZWwgbGFzIHBhbG1hcyIsIGFtb3VudDogMWU0LCBmcmVxdWVuY3k6ICJvbmVfdGltZSIsIHRvdGFsVmFsdWU6IDFlNCwgbW9udGhseVZhbHVlOiAwIH0KICBdLAogIG5vbkxpcXVpZERpc2NvdW50OiAyNSwKICBjcmVhdGVkQXQ6IERhdGUubm93KCksCiAgdXBkYXRlZEF0OiBEYXRlLm5vdygpCn07CnZhciBtaWdyYXRlSXRlbSA9IChpdGVtKSA9PiB7CiAgaWYgKGl0ZW0uYW1vdW50ICE9PSB2b2lkIDAgJiYgaXRlbS5mcmVxdWVuY3kgIT09IHZvaWQgMCkgcmV0dXJuIGl0ZW07CiAgaWYgKGl0ZW0ubW9udGhseVZhbHVlICYmIGl0ZW0ubW9udGhseVZhbHVlID4gMCkgewogICAgcmV0dXJuIHsgLi4uaXRlbSwgYW1vdW50OiBpdGVtLm1vbnRobHlWYWx1ZSwgZnJlcXVlbmN5OiAibW9udGhseSIgfTsKICB9CiAgcmV0dXJuIHsgLi4uaXRlbSwgYW1vdW50OiBpdGVtLnRvdGFsVmFsdWUgfHwgMCwgZnJlcXVlbmN5OiAib25lX3RpbWUiIH07Cn07CnZhciBtaWdyYXRlQnVkZ2V0ID0gKGIpID0+ICh7CiAgLi4uYiwKICBpbmNvbWU6IChiLmluY29tZSB8fCBbXSkubWFwKG1pZ3JhdGVJdGVtKSwKICBleHBlbnNlczogKGIuZXhwZW5zZXMgfHwgW10pLm1hcChtaWdyYXRlSXRlbSksCiAgYXNzZXRzOiAoYi5hc3NldHMgfHwgW10pLm1hcChtaWdyYXRlSXRlbSksCiAgbm9uTGlxdWlkQXNzZXRzOiAoYi5ub25MaXF1aWRBc3NldHMgfHwgW10pLm1hcChtaWdyYXRlSXRlbSksCiAgcmV0aXJlbWVudDogKGIucmV0aXJlbWVudCB8fCBbXSkubWFwKG1pZ3JhdGVJdGVtKSwKICBsaWFiaWxpdGllczogKGIubGlhYmlsaXRpZXMgfHwgW10pLm1hcChtaWdyYXRlSXRlbSkKfSk7CnZhciBsb2FkQnVkZ2V0cyA9ICgpID0+IHsKICB0cnkgewogICAgY29uc3QgZGF0YSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKEJVREdFVFNfTElTVF9LRVkpOwogICAgaWYgKGRhdGEpIHJldHVybiBKU09OLnBhcnNlKGRhdGEpLm1hcChtaWdyYXRlQnVkZ2V0KTsKICB9IGNhdGNoIHsKICB9CiAgcmV0dXJuIFtdOwp9Owp2YXIgc2F2ZUJ1ZGdldHMgPSAoYnVkZ2V0cykgPT4gewogIHRyeSB7CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShCVURHRVRTX0xJU1RfS0VZLCBKU09OLnN0cmluZ2lmeShidWRnZXRzKSk7CiAgfSBjYXRjaCB7CiAgfQp9Owp2YXIgbG9hZEN1cnJlbnRCdWRnZXQgPSAoKSA9PiB7CiAgdHJ5IHsKICAgIGNvbnN0IGRhdGEgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShTVE9SQUdFX0tFWSk7CiAgICBpZiAoZGF0YSkgcmV0dXJuIG1pZ3JhdGVCdWRnZXQoSlNPTi5wYXJzZShkYXRhKSk7CiAgfSBjYXRjaCB7CiAgfQogIHJldHVybiBudWxsOwp9Owp2YXIgc2F2ZUN1cnJlbnRCdWRnZXQgPSAoYnVkZ2V0KSA9PiB7CiAgdHJ5IHsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFNUT1JBR0VfS0VZLCBKU09OLnN0cmluZ2lmeShidWRnZXQpKTsKICB9IGNhdGNoIHsKICB9Cn07CnZhciBQUkVTRVRTID0gewogIGluY29tZTogWwogICAgeyBuYW1lOiAiV29yayBTYWxhcnkiLCBlbW9qaTogIlx1ezFGNEJDfSIgfSwKICAgIHsgbmFtZTogIkZyZWVsYW5jZSBJbmNvbWUiLCBlbW9qaTogIlx1ezFGNEJCfSIgfSwKICAgIHsgbmFtZTogIlJlbnRhbCBJbmNvbWUiLCBlbW9qaTogIlx1ezFGM0UwfSIgfSwKICAgIHsgbmFtZTogIkludmVzdG1lbnQgRGl2aWRlbmRzIiwgZW1vamk6ICJcdXsxRjRDOH0iIH0sCiAgICB7IG5hbWU6ICJHb3Zlcm5tZW50IEJlbmVmaXRzIiwgZW1vamk6ICJcdXsxRjNEQn1cdUZFMEYiIH0sCiAgICB7IG5hbWU6ICJTaWRlIEJ1c2luZXNzIiwgZW1vamk6ICJcdXsxRjNFQX0iIH0sCiAgICB7IG5hbWU6ICJQZW5zaW9uIiwgZW1vamk6ICJcdXsxRjlEM30iIH0KICBdLAogIGV4cGVuc2VzOiBbCiAgICB7IG5hbWU6ICJSZW50IiwgZW1vamk6ICJcdXsxRjNFMH0iIH0sCiAgICB7IG5hbWU6ICJNb3J0Z2FnZSBQYXltZW50IiwgZW1vamk6ICJcdXsxRjNFNn0iIH0sCiAgICB7IG5hbWU6ICJVdGlsaXRpZXMiLCBlbW9qaTogIlx1ezFGNEExfSIgfSwKICAgIHsgbmFtZTogIkdyb2NlcmllcyIsIGVtb2ppOiAiXHV7MUY2RDJ9IiB9LAogICAgeyBuYW1lOiAiQ2FyIFBheW1lbnQiLCBlbW9qaTogIlx1ezFGNjk3fSIgfSwKICAgIHsgbmFtZTogIkluc3VyYW5jZSIsIGVtb2ppOiAiXHV7MUY2RTF9XHVGRTBGIiB9LAogICAgeyBuYW1lOiAiU3Vic2NyaXB0aW9ucyIsIGVtb2ppOiAiXHV7MUY0RkF9IiB9LAogICAgeyBuYW1lOiAiUGhvbmUgQmlsbCIsIGVtb2ppOiAiXHV7MUY0RjF9IiB9LAogICAgeyBuYW1lOiAiSW50ZXJuZXQiLCBlbW9qaTogIlx1ezFGMzEwfSIgfSwKICAgIHsgbmFtZTogIkdhcy9UcmFuc3BvcnRhdGlvbiIsIGVtb2ppOiAiXHUyNkZEIiB9CiAgXSwKICBhc3NldHM6IFsKICAgIHsgbmFtZTogIkNoZWNraW5nIEFjY291bnQiLCBlbW9qaTogIlx1ezFGM0U2fSIgfSwKICAgIHsgbmFtZTogIlNhdmluZ3MgQWNjb3VudCIsIGVtb2ppOiAiXHV7MUY0QjB9IiB9LAogICAgeyBuYW1lOiAiU3RvY2tzL0Jyb2tlcmFnZSIsIGVtb2ppOiAiXHV7MUY0Q0F9IiB9LAogICAgeyBuYW1lOiAiQ3J5cHRvIiwgZW1vamk6ICJcdTIwQkYiIH0sCiAgICB7IG5hbWU6ICI0MDFrL1JldGlyZW1lbnQiLCBlbW9qaTogIlx1ezFGOUQzfSIgfSwKICAgIHsgbmFtZTogIkVtZXJnZW5jeSBGdW5kIiwgZW1vamk6ICJcdXsxRjE5OH0iIH0sCiAgICB7IG5hbWU6ICJDRC9Cb25kcyIsIGVtb2ppOiAiXHV7MUY0REN9IiB9CiAgXSwKICBub25MaXF1aWRBc3NldHM6IFsKICAgIHsgbmFtZTogIkhvbWUgVmFsdWUiLCBlbW9qaTogIlx1ezFGM0UxfSIgfSwKICAgIHsgbmFtZTogIkNhciBWYWx1ZSIsIGVtb2ppOiAiXHV7MUY2OTd9IiB9LAogICAgeyBuYW1lOiAiSmV3ZWxyeS9XYXRjaGVzIiwgZW1vamk6ICJcdXsxRjQ4RX0iIH0sCiAgICB7IG5hbWU6ICJBcnQvQ29sbGVjdGlibGVzIiwgZW1vamk6ICJcdXsxRjNBOH0iIH0sCiAgICB7IG5hbWU6ICJCdXNpbmVzcyBFcXVpdHkiLCBlbW9qaTogIlx1ezFGM0UyfSIgfSwKICAgIHsgbmFtZTogIkZ1cm5pdHVyZS9FbGVjdHJvbmljcyIsIGVtb2ppOiAiXHV7MUZBOTF9IiB9CiAgXSwKICByZXRpcmVtZW50OiBbCiAgICB7IG5hbWU6ICI0MDFrIiwgZW1vamk6ICJcdXsxRjNFNn0iIH0sCiAgICB7IG5hbWU6ICJSb3RoIElSQSIsIGVtb2ppOiAiXHV7MUY0Q0F9IiB9LAogICAgeyBuYW1lOiAiVHJhZGl0aW9uYWwgSVJBIiwgZW1vamk6ICJcdXsxRjRDOH0iIH0sCiAgICB7IG5hbWU6ICJQZW5zaW9uIEZ1bmQiLCBlbW9qaTogIlx1ezFGOUQzfSIgfSwKICAgIHsgbmFtZTogIlNFUCBJUkEiLCBlbW9qaTogIlx1ezFGNEJDfSIgfSwKICAgIHsgbmFtZTogIjQwM2IiLCBlbW9qaTogIlx1ezFGM0VCfSIgfQogIF0sCiAgbGlhYmlsaXRpZXM6IFsKICAgIHsgbmFtZTogIk1vcnRnYWdlIiwgZW1vamk6ICJcdXsxRjNFNn0iIH0sCiAgICB7IG5hbWU6ICJDYXIgTG9hbiIsIGVtb2ppOiAiXHV7MUY2OTd9IiB9LAogICAgeyBuYW1lOiAiU3R1ZGVudCBMb2FucyIsIGVtb2ppOiAiXHV7MUYzOTN9IiB9LAogICAgeyBuYW1lOiAiQ3JlZGl0IENhcmQgRGVidCIsIGVtb2ppOiAiXHV7MUY0QjN9IiB9LAogICAgeyBuYW1lOiAiUGVyc29uYWwgTG9hbiIsIGVtb2ppOiAiXHV7MUY5MUR9IiB9LAogICAgeyBuYW1lOiAiTWVkaWNhbCBEZWJ0IiwgZW1vamk6ICJcdXsxRjNFNX0iIH0sCiAgICB7IG5hbWU6ICJQZXJzb25hbCBFeHBlbnNlcyIsIGVtb2ppOiAiXHV7MUY2Q0R9XHVGRTBGIiB9CiAgXQp9Owp2YXIgU2VjdGlvbkhlYWRlciA9ICh7IHRpdGxlLCBpY29uLCBjb2xvcjogY29sb3IyLCBiZ0NvbG9yLCB0b3RhbCwgbW9udGhseVRvdGFsLCBjb3VudCwgaXNPcGVuLCBvblRvZ2dsZSB9KSA9PiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBvblRvZ2dsZSwgc3R5bGU6IHsKICB3aWR0aDogIjEwMCUiLAogIGRpc3BsYXk6ICJmbGV4IiwKICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLAogIHBhZGRpbmc6ICIxNHB4IDE2cHgiLAogIGJvcmRlcjogIm5vbmUiLAogIGJvcmRlclJhZGl1czogMTIsCiAgY3Vyc29yOiAicG9pbnRlciIsCiAgYmFja2dyb3VuZENvbG9yOiBiZ0NvbG9yLAogIHRyYW5zaXRpb246ICJhbGwgMC4ycyIKfSwgY2hpbGRyZW46IFsKICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDEwIH0sIGNoaWxkcmVuOiBbCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiAzNiwgaGVpZ2h0OiAzNiwgYm9yZGVyUmFkaXVzOiAxMCwgYmFja2dyb3VuZENvbG9yOiBjb2xvcjIsIGNvbG9yOiAid2hpdGUiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIgfSwgY2hpbGRyZW46IGljb24gfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyB0ZXh0QWxpZ246ICJsZWZ0IiB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNSwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiB0aXRsZSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46IFsKICAgICAgICBjb3VudCwKICAgICAgICAiIGl0ZW0iLAogICAgICAgIGNvdW50ICE9PSAxID8gInMiIDogIiIKICAgICAgXSB9KQogICAgXSB9KQogIF0gfSksCiAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAxMiB9LCBjaGlsZHJlbjogWwogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgdGV4dEFsaWduOiAicmlnaHQiIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE2LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBjb2xvcjIgfSwgY2hpbGRyZW46IGZtdCh0b3RhbCkgfSksCiAgICAgIG1vbnRobHlUb3RhbCAhPT0gdm9pZCAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgZm10KG1vbnRobHlUb3RhbCksCiAgICAgICAgIi9tbyIKICAgICAgXSB9KQogICAgXSB9KSwKICAgIGlzT3BlbiA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2hldnJvblVwLCB7IHNpemU6IDE4LCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSkgOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKENoZXZyb25Eb3duLCB7IHNpemU6IDE4LCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSkKICBdIH0pCl0gfSk7CnZhciBDb2luU2VhcmNoRHJvcGRvd24gPSAoeyBvblNlbGVjdCwgaW5wdXRTdHlsZSB9KSA9PiB7CiAgY29uc3QgW3F1ZXJ5LCBzZXRRdWVyeV0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKCIiKTsKICBjb25zdCBbcmVzdWx0cywgc2V0UmVzdWx0c10gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKFtdKTsKICBjb25zdCBbbG9hZGluZywgc2V0TG9hZGluZ10gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbc2hvd0Ryb3Bkb3duLCBzZXRTaG93RHJvcGRvd25dID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgdGltZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlUmVmKShudWxsKTsKICBjb25zdCBjb250YWluZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0NTEudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBjb25zdCBoYW5kbGVDbGlja091dHNpZGUgPSAoZSkgPT4gewogICAgICBpZiAoY29udGFpbmVyUmVmLmN1cnJlbnQgJiYgIWNvbnRhaW5lclJlZi5jdXJyZW50LmNvbnRhaW5zKGUudGFyZ2V0KSkgc2V0U2hvd0Ryb3Bkb3duKGZhbHNlKTsKICAgIH07CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWRvd24iLCBoYW5kbGVDbGlja091dHNpZGUpOwogICAgcmV0dXJuICgpID0+IGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIGhhbmRsZUNsaWNrT3V0c2lkZSk7CiAgfSwgW10pOwogIGNvbnN0IGhhbmRsZVNlYXJjaCA9ICh2YWwpID0+IHsKICAgIHNldFF1ZXJ5KHZhbCk7CiAgICBpZiAodGltZXJSZWYuY3VycmVudCkgY2xlYXJUaW1lb3V0KHRpbWVyUmVmLmN1cnJlbnQpOwogICAgaWYgKHZhbC5sZW5ndGggPCAyKSB7CiAgICAgIHNldFJlc3VsdHMoW10pOwogICAgICBzZXRTaG93RHJvcGRvd24oZmFsc2UpOwogICAgICByZXR1cm47CiAgICB9CiAgICBzZXRMb2FkaW5nKHRydWUpOwogICAgdGltZXJSZWYuY3VycmVudCA9IHNldFRpbWVvdXQoYXN5bmMgKCkgPT4gewogICAgICBjb25zdCBjb2lucyA9IGF3YWl0IHNlYXJjaENvaW5zKHZhbCk7CiAgICAgIHNldFJlc3VsdHMoY29pbnMpOwogICAgICBzZXRTaG93RHJvcGRvd24oY29pbnMubGVuZ3RoID4gMCk7CiAgICAgIHNldExvYWRpbmcoZmFsc2UpOwogICAgfSwgMzAwKTsKICB9OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyByZWY6IGNvbnRhaW5lclJlZiwgc3R5bGU6IHsgcG9zaXRpb246ICJyZWxhdGl2ZSIgfSwgY2hpbGRyZW46IFsKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBvc2l0aW9uOiAicmVsYXRpdmUiIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoU2VhcmNoLCB7IHNpemU6IDE0LCBzdHlsZTogeyBwb3NpdGlvbjogImFic29sdXRlIiwgbGVmdDogOCwgdG9wOiAiNTAlIiwgdHJhbnNmb3JtOiAidHJhbnNsYXRlWSgtNTAlKSIsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkIH0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgImlucHV0IiwKICAgICAgICB7CiAgICAgICAgICBzdHlsZTogeyAuLi5pbnB1dFN0eWxlLCBwYWRkaW5nTGVmdDogMjggfSwKICAgICAgICAgIHZhbHVlOiBxdWVyeSwKICAgICAgICAgIG9uQ2hhbmdlOiAoZSkgPT4gaGFuZGxlU2VhcmNoKGUudGFyZ2V0LnZhbHVlKSwKICAgICAgICAgIG9uRm9jdXM6ICgpID0+IHsKICAgICAgICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID4gMCkgc2V0U2hvd0Ryb3Bkb3duKHRydWUpOwogICAgICAgICAgfSwKICAgICAgICAgIHBsYWNlaG9sZGVyOiAiU2VhcmNoIGNyeXB0byAoZS5nLiBiaXRjb2luKSIKICAgICAgICB9CiAgICAgICksCiAgICAgIGxvYWRpbmcgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShMb2FkZXJDaXJjbGUsIHsgc2l6ZTogMTQsIHN0eWxlOiB7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCByaWdodDogOCwgdG9wOiAiNTAlIiwgdHJhbnNmb3JtOiAidHJhbnNsYXRlWSgtNTAlKSIsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBhbmltYXRpb246ICJzcGluIDFzIGxpbmVhciBpbmZpbml0ZSIgfSB9KQogICAgXSB9KSwKICAgIHNob3dEcm9wZG93biAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICB0b3A6ICIxMDAlIiwKICAgICAgbGVmdDogMCwKICAgICAgcmlnaHQ6IDAsCiAgICAgIHpJbmRleDogNTAsCiAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsCiAgICAgIGJvcmRlclJhZGl1czogOCwKICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICBib3hTaGFkb3c6ICIwIDRweCAxMnB4IHJnYmEoMCwwLDAsMC4xKSIsCiAgICAgIG1heEhlaWdodDogMjAwLAogICAgICBvdmVyZmxvd1k6ICJhdXRvIiwKICAgICAgbWFyZ2luVG9wOiAyCiAgICB9LCBjaGlsZHJlbjogcmVzdWx0cy5tYXAoKGNvaW4pID0+IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAiYnV0dG9uIiwKICAgICAgewogICAgICAgIG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgIG9uU2VsZWN0KGNvaW4pOwogICAgICAgICAgc2V0UXVlcnkoIiIpOwogICAgICAgICAgc2V0U2hvd0Ryb3Bkb3duKGZhbHNlKTsKICAgICAgICAgIHNldFJlc3VsdHMoW10pOwogICAgICAgIH0sCiAgICAgICAgc3R5bGU6IHsKICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgIGdhcDogOCwKICAgICAgICAgIHBhZGRpbmc6ICI4cHggMTBweCIsCiAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogInRyYW5zcGFyZW50IiwKICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgdGV4dEFsaWduOiAibGVmdCIsCiAgICAgICAgICBmb250U2l6ZTogMTMsCiAgICAgICAgICBjb2xvcjogQ09MT1JTLnRleHRNYWluLAogICAgICAgICAgYm9yZGVyQm90dG9tOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlckxpZ2h0fWAKICAgICAgICB9LAogICAgICAgIG9uTW91c2VFbnRlcjogKGUpID0+IHsKICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBDT0xPUlMuYXNzZXRCZzsKICAgICAgICB9LAogICAgICAgIG9uTW91c2VMZWF2ZTogKGUpID0+IHsKICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAidHJhbnNwYXJlbnQiOwogICAgICAgIH0sCiAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImltZyIsIHsgc3JjOiBjb2luLnRodW1iLCBhbHQ6ICIiLCBzdHlsZTogeyB3aWR0aDogMjAsIGhlaWdodDogMjAsIGJvcmRlclJhZGl1czogMTAgfSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDYwMCB9LCBjaGlsZHJlbjogY29pbi5uYW1lIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIGZvbnRTaXplOiAxMSwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIgfSwgY2hpbGRyZW46IGNvaW4uc3ltYm9sIH0pCiAgICAgICAgXQogICAgICB9LAogICAgICBjb2luLmlkCiAgICApKSB9KQogIF0gfSk7Cn07CnZhciBJdGVtUm93ID0gKHsgaXRlbSwgb25VcGRhdGUsIG9uRGVsZXRlLCBpbnB1dE1vZGUsIGNvbG9yOiBjb2xvcjIgfSkgPT4gewogIGNvbnN0IGlzTmV3ID0gIWl0ZW0uYW1vdW50OwogIGNvbnN0IFtlZGl0aW5nLCBzZXRFZGl0aW5nXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoaXNOZXcpOwogIGNvbnN0IFtkcmFmdCwgc2V0RHJhZnRdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKShpdGVtKTsKICAoMCwgaW1wb3J0X3JlYWN0NTEudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBzZXREcmFmdChpdGVtKTsKICB9LCBbaXRlbV0pOwogIGNvbnN0IHNhdmUgPSAoKSA9PiB7CiAgICBjb25zdCBmcmVxID0gZHJhZnQuZnJlcXVlbmN5IHx8IChpbnB1dE1vZGUgPT09ICJyZWN1cnJpbmciID8gIm1vbnRobHkiIDogIm9uZV90aW1lIik7CiAgICBsZXQgYW1vdW50ID0gZHJhZnQuYW1vdW50OwogICAgaWYgKGRyYWZ0LmFzc2V0VHlwZSA9PT0gImNyeXB0byIgJiYgZHJhZnQudGlja2VyICYmIGRyYWZ0LmxpdmVQcmljZSAmJiBkcmFmdC5xdWFudGl0eSkgewogICAgICBhbW91bnQgPSBNYXRoLnJvdW5kKGRyYWZ0LmxpdmVQcmljZSAqIGRyYWZ0LnF1YW50aXR5ICogMTAwKSAvIDEwMDsKICAgIH0KICAgIGNvbnN0IGNvbXB1dGVkID0gY29tcHV0ZVZhbHVlcyhhbW91bnQsIGZyZXEpOwogICAgb25VcGRhdGUoeyAuLi5kcmFmdCwgYW1vdW50LCBmcmVxdWVuY3k6IGZyZXEsIC4uLmNvbXB1dGVkIH0pOwogICAgc2V0RWRpdGluZyhmYWxzZSk7CiAgfTsKICBjb25zdCBpbnB1dFN0eWxlID0gewogICAgcGFkZGluZzogIjhweCAxMHB4IiwKICAgIGJvcmRlclJhZGl1czogOCwKICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgIGZvbnRTaXplOiAxMywKICAgIHdpZHRoOiAiMTAwJSIsCiAgICBib3hTaXppbmc6ICJib3JkZXItYm94IiwKICAgIGZvbnRGYW1pbHk6ICJpbmhlcml0IiwKICAgIG91dGxpbmU6ICJub25lIgogIH07CiAgY29uc3Qgc2VsZWN0U3R5bGUgPSB7CiAgICAuLi5pbnB1dFN0eWxlLAogICAgYXBwZWFyYW5jZTogIm5vbmUiLAogICAgYmFja2dyb3VuZEltYWdlOiBgdXJsKCJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgd2lkdGg9JzEyJyBoZWlnaHQ9JzEyJyB2aWV3Qm94PScwIDAgMjQgMjQnIGZpbGw9J25vbmUnIHN0cm9rZT0nJTIzOUNBM0FGJyBzdHJva2Utd2lkdGg9JzInJTNFJTNDcGF0aCBkPSdNNiA5bDYgNiA2LTYnLyUzRSUzQy9zdmclM0UiKWAsCiAgICBiYWNrZ3JvdW5kUmVwZWF0OiAibm8tcmVwZWF0IiwKICAgIGJhY2tncm91bmRQb3NpdGlvbjogInJpZ2h0IDhweCBjZW50ZXIiLAogICAgcGFkZGluZ1JpZ2h0OiAyNAogIH07CiAgY29uc3QgZnJlcUxhYmVsID0gKGYpID0+IGYgPT09ICJtb250aGx5IiA/ICIvbW8iIDogZiA9PT0gInllYXJseSIgPyAiL3lyIiA6ICIiOwogIGNvbnN0IGhhbmRsZUNvaW5TZWxlY3QgPSBhc3luYyAoY29pbikgPT4gewogICAgc2V0RHJhZnQoKGQpID0+ICh7IC4uLmQsIG5hbWU6IGNvaW4ubmFtZSwgYXNzZXRUeXBlOiAiY3J5cHRvIiwgdGlja2VyOiBjb2luLmlkIH0pKTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHByaWNlcyA9IGF3YWl0IGZldGNoQ3J5cHRvUHJpY2VzKFtjb2luLmlkXSk7CiAgICAgIGlmIChwcmljZXNbY29pbi5pZF0pIHsKICAgICAgICBzZXREcmFmdCgoZCkgPT4gewogICAgICAgICAgY29uc3QgcHJpY2UgPSBwcmljZXNbY29pbi5pZF07CiAgICAgICAgICBjb25zdCBuZXdBbW91bnQgPSBkLnF1YW50aXR5ID8gTWF0aC5yb3VuZChwcmljZSAqIGQucXVhbnRpdHkgKiAxMDApIC8gMTAwIDogZC5hbW91bnQ7CiAgICAgICAgICByZXR1cm4geyAuLi5kLCBsaXZlUHJpY2U6IHByaWNlLCBhbW91bnQ6IG5ld0Ftb3VudCB9OwogICAgICAgIH0pOwogICAgICB9CiAgICB9IGNhdGNoIHsKICAgIH0KICB9OwogIGlmIChlZGl0aW5nKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogIjEwcHggMTJweCIsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsIGJvcmRlclJhZGl1czogMTAsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgbWFyZ2luQm90dG9tOiA2IH0sIGNoaWxkcmVuOiBbCiAgICAgIGlucHV0TW9kZSA9PT0gImFzc2V0IiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogNiwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXREcmFmdCgoZCkgPT4gKHsgLi4uZCwgYXNzZXRUeXBlOiAiY3J5cHRvIiB9KSksCiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgcGFkZGluZzogIjRweCAxMHB4IiwKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDYsCiAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7ZHJhZnQuYXNzZXRUeXBlID09PSAiY3J5cHRvIiA/ICIjRjc5MzFBIiA6IENPTE9SUy5ib3JkZXJ9YCwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGRyYWZ0LmFzc2V0VHlwZSA9PT0gImNyeXB0byIgPyAiI0Y3OTMxQTE1IiA6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICAgICAgY29sb3I6IGRyYWZ0LmFzc2V0VHlwZSA9PT0gImNyeXB0byIgPyAiI0Y3OTMxQSIgOiBDT0xPUlMudGV4dFNlY29uZGFyeSwKICAgICAgICAgICAgICBmb250U2l6ZTogMTEsCiAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiAiXHUyMEJGIENyeXB0byIKICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgb25DbGljazogKCkgPT4gc2V0RHJhZnQoKGQpID0+ICh7IC4uLmQsIGFzc2V0VHlwZTogdm9pZCAwLCB0aWNrZXI6IHZvaWQgMCwgbGl2ZVByaWNlOiB2b2lkIDAgfSkpLAogICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgIHBhZGRpbmc6ICI0cHggMTBweCIsCiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA2LAogICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAkeyFkcmFmdC5hc3NldFR5cGUgfHwgZHJhZnQuYXNzZXRUeXBlID09PSAibWFudWFsIiA/IGNvbG9yMiA6IENPTE9SUy5ib3JkZXJ9YCwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICFkcmFmdC5hc3NldFR5cGUgfHwgZHJhZnQuYXNzZXRUeXBlID09PSAibWFudWFsIiA/IGAke2NvbG9yMn0xNWAgOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgIGNvbG9yOiAhZHJhZnQuYXNzZXRUeXBlIHx8IGRyYWZ0LmFzc2V0VHlwZSA9PT0gIm1hbnVhbCIgPyBjb2xvcjIgOiBDT0xPUlMudGV4dFNlY29uZGFyeSwKICAgICAgICAgICAgICBmb250U2l6ZTogMTEsCiAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiAiTWFudWFsIgogICAgICAgICAgfQogICAgICAgICkKICAgICAgXSB9KSwKICAgICAgaW5wdXRNb2RlID09PSAiYXNzZXQiICYmIGRyYWZ0LmFzc2V0VHlwZSA9PT0gImNyeXB0byIgJiYgIWRyYWZ0LnRpY2tlciAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBtYXJnaW5Cb3R0b206IDIsIGRpc3BsYXk6ICJibG9jayIgfSwgY2hpbGRyZW46ICJTZWFyY2ggQ3J5cHRvY3VycmVuY3kiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ29pblNlYXJjaERyb3Bkb3duLCB7IG9uU2VsZWN0OiBoYW5kbGVDb2luU2VsZWN0LCBpbnB1dFN0eWxlIH0pCiAgICAgIF0gfSksCiAgICAgIGlucHV0TW9kZSA9PT0gImFzc2V0IiAmJiBkcmFmdC5hc3NldFR5cGUgPT09ICJjcnlwdG8iICYmIGRyYWZ0LnRpY2tlciAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDYsIHBhZGRpbmc6ICI2cHggMTBweCIsIGJhY2tncm91bmRDb2xvcjogIiNGNzkzMUExMCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiAiMXB4IHNvbGlkICNGNzkzMUEzMCIsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNjAwLCBjb2xvcjogIiNGNzkzMUEiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJcdTIwQkYgIiwKICAgICAgICAgICAgZHJhZnQubmFtZQogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICIoIiwKICAgICAgICAgICAgZHJhZnQudGlja2VyLAogICAgICAgICAgICAiKSIKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHNldERyYWZ0KChkKSA9PiAoeyAuLi5kLCB0aWNrZXI6IHZvaWQgMCwgbmFtZTogIiIsIGxpdmVQcmljZTogdm9pZCAwIH0pKSwgc3R5bGU6IHsgbWFyZ2luTGVmdDogImF1dG8iLCBwYWRkaW5nOiAyLCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZDogIm5vbmUiLCBjdXJzb3I6ICJwb2ludGVyIiwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIGRpc3BsYXk6ICJmbGV4IiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShYLCB7IHNpemU6IDE0IH0pIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMiwgZGlzcGxheTogImJsb2NrIiB9LCBjaGlsZHJlbjogIlF1YW50aXR5IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImlucHV0IiwgeyBzdHlsZTogaW5wdXRTdHlsZSwgdHlwZTogIm51bWJlciIsIHN0ZXA6ICJhbnkiLCB2YWx1ZTogZHJhZnQucXVhbnRpdHkgfHwgIiIsIG9uQ2hhbmdlOiAoZSkgPT4gewogICAgICAgICAgICBjb25zdCBxdHkgPSBwYXJzZUZsb2F0KGUudGFyZ2V0LnZhbHVlKSB8fCAwOwogICAgICAgICAgICBjb25zdCBuZXdBbW91bnQgPSBkcmFmdC5saXZlUHJpY2UgPyBNYXRoLnJvdW5kKGRyYWZ0LmxpdmVQcmljZSAqIHF0eSAqIDEwMCkgLyAxMDAgOiBkcmFmdC5hbW91bnQ7CiAgICAgICAgICAgIHNldERyYWZ0KChkKSA9PiAoeyAuLi5kLCBxdWFudGl0eTogcXR5IHx8IHZvaWQgMCwgYW1vdW50OiBuZXdBbW91bnQgfSkpOwogICAgICAgICAgfSwgcGxhY2Vob2xkZXI6ICJIb3cgbWFueT8iLCBhdXRvRm9jdXM6IHRydWUgfSkKICAgICAgICBdIH0pLAogICAgICAgIGRyYWZ0LmxpdmVQcmljZSA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBtYXJnaW5Ub3A6IDQsIGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJQcmljZTogIiwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3Ryb25nIiwgeyBjaGlsZHJlbjogZm10UHJpY2UoZHJhZnQubGl2ZVByaWNlKSB9KSwKICAgICAgICAgICAgIi91bml0IgogICAgICAgICAgXSB9KSwKICAgICAgICAgIGRyYWZ0LnF1YW50aXR5ID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJUb3RhbDogIiwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3Ryb25nIiwgeyBzdHlsZTogeyBjb2xvcjogY29sb3IyIH0sIGNoaWxkcmVuOiBmbXQoZHJhZnQubGl2ZVByaWNlICogZHJhZnQucXVhbnRpdHkpIH0pCiAgICAgICAgICBdIH0pIDogbnVsbAogICAgICAgIF0gfSkgOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIG1hcmdpblRvcDogNCB9LCBjaGlsZHJlbjogIkZldGNoaW5nIHByaWNlLi4uIiB9KQogICAgICBdIH0pLAogICAgICAoaW5wdXRNb2RlICE9PSAiYXNzZXQiIHx8ICFkcmFmdC5hc3NldFR5cGUgfHwgZHJhZnQuYXNzZXRUeXBlID09PSAibWFudWFsIikgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiTmFtZSIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaW5wdXQiLCB7IGF1dG9Gb2N1czogIWRyYWZ0Lm5hbWUsIHN0eWxlOiBpbnB1dFN0eWxlLCB2YWx1ZTogZHJhZnQubmFtZSwgb25DaGFuZ2U6IChlKSA9PiBzZXREcmFmdCh7IC4uLmRyYWZ0LCBuYW1lOiBlLnRhcmdldC52YWx1ZSB9KSwgcGxhY2Vob2xkZXI6ICJEZXNjcmlwdGlvbiIgfSkKICAgICAgXSB9KSwKICAgICAgaW5wdXRNb2RlID09PSAicmVjdXJyaW5nIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZ3JpZCIsIGdyaWRUZW1wbGF0ZUNvbHVtbnM6ICIxZnIgMWZyIiwgZ2FwOiA4LCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiQW1vdW50IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImlucHV0IiwgeyBhdXRvRm9jdXM6ICEhZHJhZnQubmFtZSwgc3R5bGU6IGlucHV0U3R5bGUsIHR5cGU6ICJudW1iZXIiLCB2YWx1ZTogZHJhZnQuYW1vdW50IHx8ICIiLCBvbkNoYW5nZTogKGUpID0+IHNldERyYWZ0KHsgLi4uZHJhZnQsIGFtb3VudDogcGFyc2VGbG9hdChlLnRhcmdldC52YWx1ZSkgfHwgMCB9KSwgcGxhY2Vob2xkZXI6ICIkMCIgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBtYXJnaW5Cb3R0b206IDIsIGRpc3BsYXk6ICJibG9jayIgfSwgY2hpbGRyZW46ICJGcmVxdWVuY3kiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNlbGVjdCIsIHsgc3R5bGU6IHNlbGVjdFN0eWxlLCB2YWx1ZTogZHJhZnQuZnJlcXVlbmN5IHx8ICJtb250aGx5Iiwgb25DaGFuZ2U6IChlKSA9PiBzZXREcmFmdCh7IC4uLmRyYWZ0LCBmcmVxdWVuY3k6IGUudGFyZ2V0LnZhbHVlIH0pLCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJvcHRpb24iLCB7IHZhbHVlOiAibW9udGhseSIsIGNoaWxkcmVuOiAiTW9udGhseSIgfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoIm9wdGlvbiIsIHsgdmFsdWU6ICJ5ZWFybHkiLCBjaGlsZHJlbjogIlllYXJseSIgfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoIm9wdGlvbiIsIHsgdmFsdWU6ICJvbmVfdGltZSIsIGNoaWxkcmVuOiAiT25lLXRpbWUiIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICBpbnB1dE1vZGUgPT09ICJhc3NldCIgJiYgKCFkcmFmdC5hc3NldFR5cGUgfHwgZHJhZnQuYXNzZXRUeXBlID09PSAibWFudWFsIikgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImdyaWQiLCBncmlkVGVtcGxhdGVDb2x1bW5zOiAiMWZyIDFmciIsIGdhcDogOCwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMiwgZGlzcGxheTogImJsb2NrIiB9LCBjaGlsZHJlbjogIlZhbHVlIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImlucHV0IiwgeyBhdXRvRm9jdXM6ICEhZHJhZnQubmFtZSwgc3R5bGU6IGlucHV0U3R5bGUsIHR5cGU6ICJudW1iZXIiLCB2YWx1ZTogZHJhZnQuYW1vdW50IHx8ICIiLCBvbkNoYW5nZTogKGUpID0+IHNldERyYWZ0KHsgLi4uZHJhZnQsIGFtb3VudDogcGFyc2VGbG9hdChlLnRhcmdldC52YWx1ZSkgfHwgMCB9KSwgcGxhY2Vob2xkZXI6ICIkMCIgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBtYXJnaW5Cb3R0b206IDIsIGRpc3BsYXk6ICJibG9jayIgfSwgY2hpbGRyZW46ICJRdWFudGl0eSAob3B0aW9uYWwpIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImlucHV0IiwgeyBzdHlsZTogaW5wdXRTdHlsZSwgdHlwZTogIm51bWJlciIsIHN0ZXA6ICJhbnkiLCB2YWx1ZTogZHJhZnQucXVhbnRpdHkgfHwgIiIsIG9uQ2hhbmdlOiAoZSkgPT4gc2V0RHJhZnQoeyAuLi5kcmFmdCwgcXVhbnRpdHk6IHBhcnNlRmxvYXQoZS50YXJnZXQudmFsdWUpIHx8IHZvaWQgMCB9KSwgcGxhY2Vob2xkZXI6ICJRdHkiIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICBpbnB1dE1vZGUgPT09ICJ2YWx1ZV9vbmx5IiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBtYXJnaW5Cb3R0b206IDIsIGRpc3BsYXk6ICJibG9jayIgfSwgY2hpbGRyZW46ICJWYWx1ZSIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaW5wdXQiLCB7IGF1dG9Gb2N1czogISFkcmFmdC5uYW1lLCBzdHlsZTogaW5wdXRTdHlsZSwgdHlwZTogIm51bWJlciIsIHZhbHVlOiBkcmFmdC5hbW91bnQgfHwgIiIsIG9uQ2hhbmdlOiAoZSkgPT4gc2V0RHJhZnQoeyAuLi5kcmFmdCwgYW1vdW50OiBwYXJzZUZsb2F0KGUudGFyZ2V0LnZhbHVlKSB8fCAwIH0pLCBwbGFjZWhvbGRlcjogIiQwIiB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogNiwganVzdGlmeUNvbnRlbnQ6ICJmbGV4LWVuZCIgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgIGlmICghaXRlbS5uYW1lICYmICFpdGVtLmFtb3VudCkgewogICAgICAgICAgICBvbkRlbGV0ZSgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2V0RHJhZnQoaXRlbSk7CiAgICAgICAgICAgIHNldEVkaXRpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0sIHN0eWxlOiB7IHBhZGRpbmc6ICI2cHggMTJweCIsIGJvcmRlclJhZGl1czogNiwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIGZvbnRTaXplOiAxMiwgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIkNhbmNlbCIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBzYXZlLCBzdHlsZTogeyBwYWRkaW5nOiAiNnB4IDEycHgiLCBib3JkZXJSYWRpdXM6IDYsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kQ29sb3I6IGNvbG9yMiwgY29sb3I6ICJ3aGl0ZSIsIGZvbnRTaXplOiAxMiwgZm9udFdlaWdodDogNjAwLCBjdXJzb3I6ICJwb2ludGVyIiB9LCBjaGlsZHJlbjogIlNhdmUiIH0pCiAgICAgIF0gfSkKICAgIF0gfSk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgZGlzcGxheTogImZsZXgiLAogICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLAogICAgcGFkZGluZzogIjEwcHggNnB4IDEwcHggNHB4IiwKICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsCiAgICBib3JkZXJSYWRpdXM6IDEwLAogICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlckxpZ2h0fWAsCiAgICBtYXJnaW5Cb3R0b206IDQsCiAgICB0cmFuc2l0aW9uOiAiYWxsIDAuMTVzIgogIH0sIGNoaWxkcmVuOiBbCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IGNsYXNzTmFtZTogImRyYWctaGFuZGxlIiwgc3R5bGU6IHsgcGFkZGluZzogIjRweCA0cHgiLCBjdXJzb3I6ICJncmFiIiwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIGRpc3BsYXk6ICJmbGV4IiwgZmxleFNocmluazogMCB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShHcmlwVmVydGljYWwsIHsgc2l6ZTogMTYgfSkgfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmbGV4OiAxLCBtaW5XaWR0aDogMCwgcGFkZGluZ0xlZnQ6IDQgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBmb250V2VpZ2h0OiA1MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sIG92ZXJmbG93OiAiaGlkZGVuIiwgdGV4dE92ZXJmbG93OiAiZWxsaXBzaXMiLCB3aGl0ZVNwYWNlOiAibm93cmFwIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgaXRlbS5hc3NldFR5cGUgPT09ICJjcnlwdG8iICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgY29sb3I6ICIjRjc5MzFBIiwgZm9udFdlaWdodDogNzAwIH0sIGNoaWxkcmVuOiAiXHUyMEJGIiB9KSwKICAgICAgICBpdGVtLm5hbWUgfHwgIlVubmFtZWQiCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBkaXNwbGF5OiAiZmxleCIsIGdhcDogOCwgbWFyZ2luVG9wOiAyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgaXRlbS5xdWFudGl0eSAhPT0gdm9pZCAwICYmIGl0ZW0ucXVhbnRpdHkgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgIlF0eTogIiwKICAgICAgICAgIGl0ZW0ucXVhbnRpdHkKICAgICAgICBdIH0pLAogICAgICAgIGl0ZW0uYXNzZXRUeXBlID09PSAiY3J5cHRvIiAmJiBpdGVtLmxpdmVQcmljZSAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICJAICIsCiAgICAgICAgICBmbXRQcmljZShpdGVtLmxpdmVQcmljZSkKICAgICAgICBdIH0pLAogICAgICAgIGlucHV0TW9kZSA9PT0gInJlY3VycmluZyIgJiYgaXRlbS5mcmVxdWVuY3kgIT09ICJvbmVfdGltZSIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICBmbXQoaXRlbS5hbW91bnQpLAogICAgICAgICAgZnJlcUxhYmVsKGl0ZW0uZnJlcXVlbmN5KQogICAgICAgIF0gfSksCiAgICAgICAgaW5wdXRNb2RlID09PSAicmVjdXJyaW5nIiAmJiBpdGVtLmZyZXF1ZW5jeSA9PT0gInllYXJseSIgJiYgaXRlbS5tb250aGx5VmFsdWUgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgIigiLAogICAgICAgICAgZm10KGl0ZW0ubW9udGhseVZhbHVlKSwKICAgICAgICAgICIvbW8pIgogICAgICAgIF0gfSksCiAgICAgICAgaW5wdXRNb2RlID09PSAicmVjdXJyaW5nIiAmJiBpdGVtLmZyZXF1ZW5jeSA9PT0gIm1vbnRobHkiICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgIigiLAogICAgICAgICAgZm10KGl0ZW0udG90YWxWYWx1ZSksCiAgICAgICAgICAiL3lyKSIKICAgICAgICBdIH0pCiAgICAgIF0gfSkKICAgIF0gfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDggfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTUsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IGNvbG9yMiwgd2hpdGVTcGFjZTogIm5vd3JhcCIgfSwgY2hpbGRyZW46IGZtdEV4YWN0KGl0ZW0udG90YWxWYWx1ZSkgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gc2V0RWRpdGluZyh0cnVlKSwgc3R5bGU6IHsgcGFkZGluZzogNCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmQ6ICJub25lIiwgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBkaXNwbGF5OiAiZmxleCIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUGVuLCB7IHNpemU6IDE0IH0pIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6IG9uRGVsZXRlLCBzdHlsZTogeyBwYWRkaW5nOiA0LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZDogIm5vbmUiLCBjdXJzb3I6ICJwb2ludGVyIiwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIGRpc3BsYXk6ICJmbGV4IiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShUcmFzaDIsIHsgc2l6ZTogMTQgfSkgfSkKICAgIF0gfSkKICBdIH0pOwp9Owp2YXIgQnVkZ2V0U2VjdGlvbiA9ICh7IHRpdGxlLCBpY29uLCBjb2xvcjogY29sb3IyLCBiZ0NvbG9yLCBpdGVtcywgb25VcGRhdGUsIG9uQWRkLCBvbkFkZFByZXNldCwgb25EZWxldGUsIG9uUmVvcmRlciwgaW5wdXRNb2RlLCBwcmVzZXRzLCBmb290ZXIgfSkgPT4gewogIGNvbnN0IFtpc09wZW4sIHNldElzT3Blbl0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbZHJhZ0lkeCwgc2V0RHJhZ0lkeF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKG51bGwpOwogIGNvbnN0IFtvdmVySWR4LCBzZXRPdmVySWR4XSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkobnVsbCk7CiAgY29uc3QgdG90YWwgPSBpdGVtcy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLnRvdGFsVmFsdWUsIDApOwogIGNvbnN0IHNob3dNb250aGx5ID0gaW5wdXRNb2RlID09PSAicmVjdXJyaW5nIjsKICBjb25zdCBtb250aGx5VG90YWwgPSBzaG93TW9udGhseSA/IGl0ZW1zLnJlZHVjZSgocywgaSkgPT4gcyArIGkubW9udGhseVZhbHVlLCAwKSA6IHZvaWQgMDsKICBjb25zdCBleGlzdGluZ05hbWVzID0gbmV3IFNldChpdGVtcy5tYXAoKGkpID0+IGkubmFtZS50b0xvd2VyQ2FzZSgpKSk7CiAgY29uc3QgYXZhaWxhYmxlUHJlc2V0cyA9IChwcmVzZXRzIHx8IFtdKS5maWx0ZXIoKHApID0+ICFleGlzdGluZ05hbWVzLmhhcyhwLm5hbWUudG9Mb3dlckNhc2UoKSkpOwogIGNvbnN0IGhhbmRsZURyYWdTdGFydCA9IChlLCBpZHgpID0+IHsKICAgIHNldERyYWdJZHgoaWR4KTsKICAgIGUuZGF0YVRyYW5zZmVyLmVmZmVjdEFsbG93ZWQgPSAibW92ZSI7CiAgfTsKICBjb25zdCBoYW5kbGVEcmFnT3ZlciA9IChlLCBpZHgpID0+IHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIGUuZGF0YVRyYW5zZmVyLmRyb3BFZmZlY3QgPSAibW92ZSI7CiAgICBzZXRPdmVySWR4KGlkeCk7CiAgfTsKICBjb25zdCBoYW5kbGVEcm9wID0gKGUsIGlkeCkgPT4gewogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgaWYgKGRyYWdJZHggIT09IG51bGwgJiYgZHJhZ0lkeCAhPT0gaWR4KSBvblJlb3JkZXIoZHJhZ0lkeCwgaWR4KTsKICAgIHNldERyYWdJZHgobnVsbCk7CiAgICBzZXRPdmVySWR4KG51bGwpOwogIH07CiAgY29uc3QgaGFuZGxlRHJhZ0VuZCA9ICgpID0+IHsKICAgIHNldERyYWdJZHgobnVsbCk7CiAgICBzZXRPdmVySWR4KG51bGwpOwogIH07CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogMTIgfSwgY2hpbGRyZW46IFsKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgIFNlY3Rpb25IZWFkZXIsCiAgICAgIHsKICAgICAgICB0aXRsZSwKICAgICAgICBpY29uLAogICAgICAgIGNvbG9yOiBjb2xvcjIsCiAgICAgICAgYmdDb2xvciwKICAgICAgICB0b3RhbCwKICAgICAgICBtb250aGx5VG90YWwsCiAgICAgICAgY291bnQ6IGl0ZW1zLmxlbmd0aCwKICAgICAgICBpc09wZW4sCiAgICAgICAgb25Ub2dnbGU6ICgpID0+IHNldElzT3BlbighaXNPcGVuKQogICAgICB9CiAgICApLAogICAgaXNPcGVuICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBhZGRpbmc6ICIxMHB4IDEycHggMTJweCIsIGJvcmRlcjogYDFweCBzb2xpZCAke2NvbG9yMn0yMGAsIGJvcmRlclJhZGl1czogIjAgMCAxMnB4IDEycHgiLCBtYXJnaW5Ub3A6IC0yIH0sIGNoaWxkcmVuOiBbCiAgICAgIGl0ZW1zLm1hcCgoaXRlbSwgaWR4KSA9PiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICJkaXYiLAogICAgICAgIHsKICAgICAgICAgIGRyYWdnYWJsZTogdHJ1ZSwKICAgICAgICAgIG9uRHJhZ1N0YXJ0OiAoZSkgPT4gaGFuZGxlRHJhZ1N0YXJ0KGUsIGlkeCksCiAgICAgICAgICBvbkRyYWdPdmVyOiAoZSkgPT4gaGFuZGxlRHJhZ092ZXIoZSwgaWR4KSwKICAgICAgICAgIG9uRHJvcDogKGUpID0+IGhhbmRsZURyb3AoZSwgaWR4KSwKICAgICAgICAgIG9uRHJhZ0VuZDogaGFuZGxlRHJhZ0VuZCwKICAgICAgICAgIHN0eWxlOiB7IG9wYWNpdHk6IGRyYWdJZHggPT09IGlkeCA/IDAuNCA6IDEsIGJvcmRlclRvcDogb3ZlcklkeCA9PT0gaWR4ICYmIGRyYWdJZHggIT09IG51bGwgJiYgZHJhZ0lkeCAhPT0gaWR4ID8gYDJweCBzb2xpZCAke2NvbG9yMn1gIDogIjJweCBzb2xpZCB0cmFuc3BhcmVudCIsIHRyYW5zaXRpb246ICJvcGFjaXR5IDAuMTVzIiB9LAogICAgICAgICAgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgIEl0ZW1Sb3csCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpdGVtLAogICAgICAgICAgICAgIGNvbG9yOiBjb2xvcjIsCiAgICAgICAgICAgICAgb25VcGRhdGU6ICh1KSA9PiBvblVwZGF0ZShpdGVtLmlkLCB1KSwKICAgICAgICAgICAgICBvbkRlbGV0ZTogKCkgPT4gb25EZWxldGUoaXRlbS5pZCksCiAgICAgICAgICAgICAgaW5wdXRNb2RlCiAgICAgICAgICAgIH0KICAgICAgICAgICkKICAgICAgICB9LAogICAgICAgIGl0ZW0uaWQKICAgICAgKSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogMTIsIG1hcmdpbkJvdHRvbTogNiB9LCBjaGlsZHJlbjogWwogICAgICAgIGF2YWlsYWJsZVByZXNldHMubGVuZ3RoID4gMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiA2LCBwYWRkaW5nTGVmdDogMiB9LCBjaGlsZHJlbjogIlF1aWNrIGFkZDoiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZmxleFdyYXA6ICJ3cmFwIiwgZ2FwOiA2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICBhdmFpbGFibGVQcmVzZXRzLm1hcCgocCkgPT4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgb25DbGljazogKCkgPT4gb25BZGRQcmVzZXQocC5uYW1lKSwKICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgcGFkZGluZzogIjZweCAxMnB4IiwKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMjAsCiAgICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtjb2xvcjJ9MzBgLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBgJHtiZ0NvbG9yfWAsCiAgICAgICAgICAgICAgICBjb2xvcjogY29sb3IyLAogICAgICAgICAgICAgICAgZm9udFNpemU6IDEyLAogICAgICAgICAgICAgICAgZm9udFdlaWdodDogNTAwLAogICAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgIGdhcDogNCwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb246ICJhbGwgMC4xNXMiCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBvbk1vdXNlRW50ZXI6IChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnRhcmdldC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBgJHtjb2xvcjJ9MTVgOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgb25Nb3VzZUxlYXZlOiAoZSkgPT4gewogICAgICAgICAgICAgICAgZS50YXJnZXQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gYmdDb2xvcjsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBjaGlsZHJlbjogcC5lbW9qaSB9KSwKICAgICAgICAgICAgICAgICIgIiwKICAgICAgICAgICAgICAgIHAubmFtZQogICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgcC5uYW1lCiAgICAgICAgICApKSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgewogICAgICAgICAgICAgIG9uQ2xpY2s6IG9uQWRkLAogICAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgICBwYWRkaW5nOiAiNnB4IDEycHgiLAogICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAyMCwKICAgICAgICAgICAgICAgIGJvcmRlcjogYDFweCBkYXNoZWQgJHtjb2xvcjJ9NTBgLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgICAgY29sb3I6IGNvbG9yMiwKICAgICAgICAgICAgICAgIGZvbnRTaXplOiAxMiwKICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDUwMCwKICAgICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgICBnYXA6IDQsCiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uOiAiYWxsIDAuMTVzIgogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgb25Nb3VzZUVudGVyOiAoZSkgPT4gewogICAgICAgICAgICAgICAgZS50YXJnZXQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gYCR7Y29sb3IyfTEwYDsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG9uTW91c2VMZWF2ZTogKGUpID0+IHsKICAgICAgICAgICAgICAgIGUudGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICJ0cmFuc3BhcmVudCI7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShQbHVzLCB7IHNpemU6IDE0IH0pLAogICAgICAgICAgICAgICAgIiBDdXN0b20iCiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICBmb290ZXIKICAgIF0gfSkKICBdIH0pOwp9Owp2YXIgU3VtbWFyeVNlY3Rpb24gPSAoeyBidWRnZXQgfSkgPT4gewogIGNvbnN0IHRvdGFsTW9udGhseUluY29tZSA9IGJ1ZGdldC5pbmNvbWUucmVkdWNlKChzLCBpKSA9PiBzICsgaS5tb250aGx5VmFsdWUsIDApOwogIGNvbnN0IHRvdGFsTW9udGhseUV4cGVuc2VzID0gYnVkZ2V0LmV4cGVuc2VzLnJlZHVjZSgocywgaSkgPT4gcyArIGkubW9udGhseVZhbHVlLCAwKTsKICBjb25zdCB0b3RhbE1vbnRobHlMaWFiaWxpdHlQYXltZW50cyA9IGJ1ZGdldC5saWFiaWxpdGllcy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLm1vbnRobHlWYWx1ZSwgMCk7CiAgY29uc3QgbW9udGhseU5ldCA9IHRvdGFsTW9udGhseUluY29tZSAtIHRvdGFsTW9udGhseUV4cGVuc2VzIC0gdG90YWxNb250aGx5TGlhYmlsaXR5UGF5bWVudHM7CiAgY29uc3QgYW5udWFsTmV0ID0gbW9udGhseU5ldCAqIDEyOwogIGNvbnN0IHRvdGFsTGlxdWlkQXNzZXRzID0gYnVkZ2V0LmFzc2V0cy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLnRvdGFsVmFsdWUsIDApOwogIGNvbnN0IHRvdGFsTm9uTGlxdWlkQXNzZXRzID0gYnVkZ2V0Lm5vbkxpcXVpZEFzc2V0cy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLnRvdGFsVmFsdWUsIDApOwogIGNvbnN0IHRvdGFsUmV0aXJlbWVudCA9IGJ1ZGdldC5yZXRpcmVtZW50LnJlZHVjZSgocywgaSkgPT4gcyArIGkudG90YWxWYWx1ZSwgMCk7CiAgY29uc3Qgbm9uTGlxdWlkQXREaXNjb3VudCA9IHRvdGFsTm9uTGlxdWlkQXNzZXRzICogKDEgLSBidWRnZXQubm9uTGlxdWlkRGlzY291bnQgLyAxMDApOwogIGNvbnN0IG9uZVRpbWVMaWFiaWxpdGllcyA9IGJ1ZGdldC5saWFiaWxpdGllcy5maWx0ZXIoKGkpID0+IGkuZnJlcXVlbmN5ID09PSAib25lX3RpbWUiKS5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLnRvdGFsVmFsdWUsIDApOwogIGNvbnN0IHRvdGFsTGlhYmlsaXRpZXMgPSBidWRnZXQubGlhYmlsaXRpZXMucmVkdWNlKChzLCBpKSA9PiBzICsgaS50b3RhbFZhbHVlLCAwKTsKICBjb25zdCBsaXF1aWRBZnRlckxpYWJpbGl0aWVzID0gdG90YWxMaXF1aWRBc3NldHMgLSBvbmVUaW1lTGlhYmlsaXRpZXM7CiAgY29uc3QgbmV0V29ydGggPSBsaXF1aWRBZnRlckxpYWJpbGl0aWVzICsgbm9uTGlxdWlkQXREaXNjb3VudCArIHRvdGFsUmV0aXJlbWVudDsKICBjb25zdCBtb250aGx5QnVybiA9IHRvdGFsTW9udGhseUV4cGVuc2VzICsgdG90YWxNb250aGx5TGlhYmlsaXR5UGF5bWVudHMgLSB0b3RhbE1vbnRobHlJbmNvbWU7CiAgY29uc3QgbGlxdWlkRm9yUnVud2F5ID0gTWF0aC5tYXgoMCwgbGlxdWlkQWZ0ZXJMaWFiaWxpdGllcyk7CiAgY29uc3QgcnVud2F5TW9udGhzID0gbW9udGhseUJ1cm4gPiAwICYmIGxpcXVpZEZvclJ1bndheSA+IDAgPyBsaXF1aWRGb3JSdW53YXkgLyBtb250aGx5QnVybiA6IG51bGw7CiAgY29uc3QgcnVud2F5WWVhcnMgPSBydW53YXlNb250aHMgPyBydW53YXlNb250aHMgLyAxMiA6IG51bGw7CiAgY29uc3QgZXh0ZW5kZWRGb3JSdW53YXkgPSBsaXF1aWRGb3JSdW53YXkgKyBub25MaXF1aWRBdERpc2NvdW50OwogIGNvbnN0IGV4dFJ1bndheU1vbnRocyA9IG1vbnRobHlCdXJuID4gMCAmJiBleHRlbmRlZEZvclJ1bndheSA+IDAgPyBleHRlbmRlZEZvclJ1bndheSAvIG1vbnRobHlCdXJuIDogbnVsbDsKICBjb25zdCBleHRSdW53YXlZZWFycyA9IGV4dFJ1bndheU1vbnRocyA/IGV4dFJ1bndheU1vbnRocyAvIDEyIDogbnVsbDsKICBjb25zdCBzYXZpbmdzUmF0ZSA9IHRvdGFsTW9udGhseUluY29tZSA+IDAgPyBtb250aGx5TmV0IC8gdG90YWxNb250aGx5SW5jb21lICogMTAwIDogMDsKICBjb25zdCBpc1Bvc2l0aXZlID0gbW9udGhseU5ldCA+PSAwOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgIGJhY2tncm91bmRDb2xvcjogaXNQb3NpdGl2ZSA/IENPTE9SUy5pbmNvbWVCZyA6IENPTE9SUy5leHBlbnNlQmcsCiAgICAgIGJvcmRlclJhZGl1czogMTYsCiAgICAgIHBhZGRpbmc6ICIyMHB4IDE2cHgiLAogICAgICBtYXJnaW5Cb3R0b206IDEyLAogICAgICBib3JkZXI6IGAxcHggc29saWQgJHtpc1Bvc2l0aXZlID8gQ09MT1JTLmluY29tZSA6IENPTE9SUy5leHBlbnNlfTIwYAogICAgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiAxNiwgYWxpZ25JdGVtczogImZsZXgtc3RhcnQiIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZsZXg6IDEgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIHRleHRUcmFuc2Zvcm06ICJ1cHBlcmNhc2UiLCBsZXR0ZXJTcGFjaW5nOiAwLjUsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogIk1vbnRobHkgQ2FzaCBGbG93IiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJiYXNlbGluZSIsIGdhcDogNiwgbWFyZ2luQm90dG9tOiAyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDI4LCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBpc1Bvc2l0aXZlID8gQ09MT1JTLnBvc2l0aXZlIDogQ09MT1JTLm5lZ2F0aXZlIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIG1vbnRobHlOZXQgPj0gMCA/ICIrIiA6ICIiLAogICAgICAgICAgICBmbXQobW9udGhseU5ldCkKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIi9tbyIgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBtYXJnaW5Cb3R0b206IDEwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICBhbm51YWxOZXQgPj0gMCA/ICIrIiA6ICIiLAogICAgICAgICAgZm10KGFubnVhbE5ldCksCiAgICAgICAgICAiIC95ZWFyIgogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDEyLCBmbGV4V3JhcDogIndyYXAiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQgfSwgY2hpbGRyZW46ICJJbmNvbWUiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy5pbmNvbWUgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICBmbXQodG90YWxNb250aGx5SW5jb21lKSwKICAgICAgICAgICAgICAiL21vIgogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkIH0sIGNoaWxkcmVuOiAiRXhwZW5zZXMiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy5leHBlbnNlIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgZm10KHRvdGFsTW9udGhseUV4cGVuc2VzKSwKICAgICAgICAgICAgICAiL21vIgogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgdG90YWxNb250aGx5TGlhYmlsaXR5UGF5bWVudHMgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCB9LCBjaGlsZHJlbjogIkxpYWJpbGl0aWVzIiB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMubGlhYmlsaXR5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgZm10KHRvdGFsTW9udGhseUxpYWJpbGl0eVBheW1lbnRzKSwKICAgICAgICAgICAgICAiL21vIgogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICBydW53YXlNb250aHMgIT09IG51bGwgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBib3JkZXJMZWZ0OiBgMXB4IHNvbGlkICR7aXNQb3NpdGl2ZSA/IENPTE9SUy5pbmNvbWUgOiBDT0xPUlMuZXhwZW5zZX0yMGAsIHBhZGRpbmdMZWZ0OiAxNiwgbWluV2lkdGg6IDEyMCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKENsb2NrLCB7IHNpemU6IDE0LCBjb2xvcjogQ09MT1JTLmV4cGVuc2UgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy5leHBlbnNlLCB0ZXh0VHJhbnNmb3JtOiAidXBwZXJjYXNlIiB9LCBjaGlsZHJlbjogIlJ1bndheSIgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMSB9LCBjaGlsZHJlbjogIkxpcXVpZCBvbmx5IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDIwLCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBDT0xPUlMuZXhwZW5zZSB9LCBjaGlsZHJlbjogcnVud2F5WWVhcnMgPj0gMSA/IGAke3J1bndheVllYXJzLnRvRml4ZWQoMSl9IHlyc2AgOiBgJHtNYXRoLnJvdW5kKHJ1bndheU1vbnRocyl9IG1vYCB9KQogICAgICAgIF0gfSksCiAgICAgICAgZXh0UnVud2F5TW9udGhzICE9PSBudWxsICYmIG5vbkxpcXVpZEF0RGlzY291bnQgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkLCBtYXJnaW5Cb3R0b206IDEgfSwgY2hpbGRyZW46ICIrIE5vbi1saXF1aWQgc29sZCIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAyMCwgZm9udFdlaWdodDogODAwLCBjb2xvcjogQ09MT1JTLm5vbkxpcXVpZCB9LCBjaGlsZHJlbjogZXh0UnVud2F5WWVhcnMgPj0gMSA/IGAke2V4dFJ1bndheVllYXJzLnRvRml4ZWQoMSl9IHlyc2AgOiBgJHtNYXRoLnJvdW5kKGV4dFJ1bndheU1vbnRocyl9IG1vYCB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KSA6IGlzUG9zaXRpdmUgJiYgbW9udGhseU5ldCA+IDAgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBib3JkZXJMZWZ0OiBgMXB4IHNvbGlkICR7Q09MT1JTLmluY29tZX0yMGAsIHBhZGRpbmdMZWZ0OiAxNiwgbWluV2lkdGg6IDEyMCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEFycm93VXBSaWdodCwgeyBzaXplOiAxNCwgY29sb3I6IENPTE9SUy5pbmNvbWUgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy5pbmNvbWUsIHRleHRUcmFuc2Zvcm06ICJ1cHBlcmNhc2UiIH0sIGNoaWxkcmVuOiAiR3Jvd3RoIiB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdHJvbmciLCB7IGNoaWxkcmVuOiBmbXQoYW5udWFsTmV0KSB9KSwKICAgICAgICAgICIveXIiCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbWFyZ2luVG9wOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAiMnlyOiArIiwKICAgICAgICAgIGZtdChhbm51YWxOZXQgKiAyKSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJyIiwge30pLAogICAgICAgICAgIjV5cjogKyIsCiAgICAgICAgICBmbXQoYW5udWFsTmV0ICogNSkKICAgICAgICBdIH0pCiAgICAgIF0gfSkgOiBudWxsCiAgICBdIH0pIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwKICAgICAgYm9yZGVyUmFkaXVzOiAxMiwKICAgICAgcGFkZGluZzogIjE2cHgiLAogICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsCiAgICAgIG1hcmdpbkJvdHRvbTogMTIKICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIsIGxldHRlclNwYWNpbmc6IDAuNSwgbWFyZ2luQm90dG9tOiAxMiB9LCBjaGlsZHJlbjogIkFzc2V0IEJyZWFrZG93biIgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZmxleERpcmVjdGlvbjogImNvbHVtbiIsIGdhcDogNiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgYWxpZ25JdGVtczogImNlbnRlciIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiTGlxdWlkIGFzc2V0cyIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy5hc3NldCB9LCBjaGlsZHJlbjogZm10RXhhY3QodG90YWxMaXF1aWRBc3NldHMpIH0pCiAgICAgICAgXSB9KSwKICAgICAgICBvbmVUaW1lTGlhYmlsaXRpZXMgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgYWxpZ25JdGVtczogImNlbnRlciIsIHBhZGRpbmdMZWZ0OiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCB9LCBjaGlsZHJlbjogIlx1MjIxMiBPbmUtdGltZSBkZWJ0cyIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMubGlhYmlsaXR5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJcdTIyMTIiLAogICAgICAgICAgICBmbXRFeGFjdChvbmVUaW1lTGlhYmlsaXRpZXMpCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBwYWRkaW5nTGVmdDogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICI9IExpcXVpZCBhdmFpbGFibGUiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBsaXF1aWRBZnRlckxpYWJpbGl0aWVzID49IDAgPyBDT0xPUlMucG9zaXRpdmUgOiBDT0xPUlMubmVnYXRpdmUgfSwgY2hpbGRyZW46IGZtdEV4YWN0KGxpcXVpZEFmdGVyTGlhYmlsaXRpZXMpIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBib3JkZXJUb3A6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyTGlnaHR9YCwgbWFyZ2luVG9wOiA0LCBwYWRkaW5nVG9wOiA2LCBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgIk5vbi1saXF1aWQgKGF0ICIsCiAgICAgICAgICAgIGJ1ZGdldC5ub25MaXF1aWREaXNjb3VudCwKICAgICAgICAgICAgIiUgZGlzY291bnQpIgogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLm5vbkxpcXVpZCB9LCBjaGlsZHJlbjogZm10RXhhY3Qobm9uTGlxdWlkQXREaXNjb3VudCkgfSkKICAgICAgICBdIH0pLAogICAgICAgIHRvdGFsUmV0aXJlbWVudCA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICI0MDFrIC8gUmV0aXJlbWVudCIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy5yZXRpcmVtZW50IH0sIGNoaWxkcmVuOiBmbXRFeGFjdCh0b3RhbFJldGlyZW1lbnQpIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBib3JkZXJUb3A6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIG1hcmdpblRvcDogNCwgcGFkZGluZ1RvcDogOCwgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46ICJOZXQgV29ydGgiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE4LCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBuZXRXb3J0aCA+PSAwID8gQ09MT1JTLnBvc2l0aXZlIDogQ09MT1JTLm5lZ2F0aXZlIH0sIGNoaWxkcmVuOiBmbXRFeGFjdChuZXRXb3J0aCkgfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSkKICAgIF0gfSksCiAgICAoKCkgPT4gewogICAgICBjb25zdCBwcm9qZWN0aW9uWWVhcnMgPSAyMDsKICAgICAgY29uc3Qgc3RhcnRMaXF1aWQgPSBNYXRoLm1heCgwLCBsaXF1aWRBZnRlckxpYWJpbGl0aWVzKTsKICAgICAgY29uc3Qgc3RhcnRFeHQgPSBNYXRoLm1heCgwLCBuZXRXb3J0aCk7CiAgICAgIGNvbnN0IGRhdGEgPSBbXTsKICAgICAgY29uc3QgYW5udWFsQnVybiA9IG1vbnRobHlCdXJuICogMTI7CiAgICAgIGxldCBiYWxMaXF1aWQgPSBzdGFydExpcXVpZDsKICAgICAgbGV0IGJhbEV4dGVuZGVkID0gc3RhcnRFeHQ7CiAgICAgIGxldCBsaXF1aWRIaXRaZXJvID0gZmFsc2U7CiAgICAgIGxldCBleHRIaXRaZXJvID0gZmFsc2U7CiAgICAgIGZvciAobGV0IHlyID0gMDsgeXIgPD0gcHJvamVjdGlvblllYXJzOyB5cisrKSB7CiAgICAgICAgZGF0YS5wdXNoKHsKICAgICAgICAgIHllYXI6IHlyLAogICAgICAgICAgbGlxdWlkOiBNYXRoLnJvdW5kKE1hdGgubWF4KDAsIGJhbExpcXVpZCkpLAogICAgICAgICAgZXh0ZW5kZWQ6IG5vbkxpcXVpZEF0RGlzY291bnQgPiAwIHx8IHRvdGFsUmV0aXJlbWVudCA+IDAgPyBNYXRoLnJvdW5kKE1hdGgubWF4KDAsIGJhbEV4dGVuZGVkKSkgOiAwCiAgICAgICAgfSk7CiAgICAgICAgaWYgKG1vbnRobHlCdXJuID4gMCkgewogICAgICAgICAgYmFsTGlxdWlkIC09IGFubnVhbEJ1cm47CiAgICAgICAgICBiYWxFeHRlbmRlZCAtPSBhbm51YWxCdXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBiYWxMaXF1aWQgKz0gYW5udWFsTmV0OwogICAgICAgICAgYmFsRXh0ZW5kZWQgKz0gYW5udWFsTmV0OwogICAgICAgIH0KICAgICAgICBpZiAoYmFsTGlxdWlkIDw9IDApIGxpcXVpZEhpdFplcm8gPSB0cnVlOwogICAgICAgIGlmIChiYWxFeHRlbmRlZCA8PSAwKSBleHRIaXRaZXJvID0gdHJ1ZTsKICAgICAgICBpZiAobGlxdWlkSGl0WmVybyAmJiBleHRIaXRaZXJvKSBicmVhazsKICAgICAgfQogICAgICBjb25zdCBsaXF1aWRaZXJvWWVhciA9IG1vbnRobHlCdXJuID4gMCA/IGRhdGEuZmluZCgoZCwgaSkgPT4gaSA+IDAgJiYgZC5saXF1aWQgPT09IDApPy55ZWFyIDogbnVsbDsKICAgICAgY29uc3QgZXh0WmVyb1llYXIgPSBtb250aGx5QnVybiA+IDAgPyBkYXRhLmZpbmQoKGQsIGkpID0+IGkgPiAwICYmIGQuZXh0ZW5kZWQgPT09IDApPy55ZWFyIDogbnVsbDsKICAgICAgY29uc3QgbWF4VmFsID0gTWF0aC5tYXgoLi4uZGF0YS5tYXAoKGQpID0+IE1hdGgubWF4KGQubGlxdWlkLCBkLmV4dGVuZGVkKSkpOwogICAgICBjb25zdCBtaW5WYWwgPSBNYXRoLm1pbiguLi5kYXRhLm1hcCgoZCkgPT4gTWF0aC5taW4oZC5saXF1aWQsIGQuZXh0ZW5kZWQpKSk7CiAgICAgIGNvbnN0IGZvcm1hdFlBeGlzID0gKHZhbCkgPT4gewogICAgICAgIGlmIChNYXRoLmFicyh2YWwpID49IDFlNikgcmV0dXJuIGAkJHsodmFsIC8gMWU2KS50b0ZpeGVkKDEpfU1gOwogICAgICAgIGlmIChNYXRoLmFicyh2YWwpID49IDFlMykgcmV0dXJuIGAkJHsodmFsIC8gMWUzKS50b0ZpeGVkKDApfUtgOwogICAgICAgIHJldHVybiBgJCR7dmFsfWA7CiAgICAgIH07CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsCiAgICAgICAgYm9yZGVyUmFkaXVzOiAxMiwKICAgICAgICBwYWRkaW5nOiAiMTZweCIsCiAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICAgIG1hcmdpbkJvdHRvbTogMTIKICAgICAgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCB0ZXh0VHJhbnNmb3JtOiAidXBwZXJjYXNlIiwgbGV0dGVyU3BhY2luZzogMC41LCBtYXJnaW5Cb3R0b206IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICBtb250aGx5QnVybiA+IDAgPyAiUnVud2F5IFByb2plY3Rpb24iIDogIldlYWx0aCBQcm9qZWN0aW9uIiwKICAgICAgICAgICIgXHUyMDE0ICIsCiAgICAgICAgICBwcm9qZWN0aW9uWWVhcnMsCiAgICAgICAgICAiIFllYXJzIgogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBoZWlnaHQ6IDI0MCwgd2lkdGg6ICIxMDAlIiwgZm9udFNpemU6IDExIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFJlc3BvbnNpdmVDb250YWluZXIsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKEFyZWFDaGFydCwgeyBkYXRhLCBtYXJnaW46IHsgdG9wOiAxMCwgcmlnaHQ6IDEwLCBsZWZ0OiAtMTAsIGJvdHRvbTogMCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRlZnMiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJsaW5lYXJHcmFkaWVudCIsIHsgaWQ6ICJncmFkTGlxdWlkIiwgeDE6ICIwIiwgeTE6ICIwIiwgeDI6ICIwIiwgeTI6ICIxIiwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdG9wIiwgeyBvZmZzZXQ6ICI1JSIsIHN0b3BDb2xvcjogbW9udGhseUJ1cm4gPiAwID8gQ09MT1JTLmV4cGVuc2UgOiBDT0xPUlMuaW5jb21lLCBzdG9wT3BhY2l0eTogMC4xNSB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzdG9wIiwgeyBvZmZzZXQ6ICI5NSUiLCBzdG9wQ29sb3I6IG1vbnRobHlCdXJuID4gMCA/IENPTE9SUy5leHBlbnNlIDogQ09MT1JTLmluY29tZSwgc3RvcE9wYWNpdHk6IDAgfSkKICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImxpbmVhckdyYWRpZW50IiwgeyBpZDogImdyYWRFeHRlbmRlZCIsIHgxOiAiMCIsIHkxOiAiMCIsIHgyOiAiMCIsIHkyOiAiMSIsIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3RvcCIsIHsgb2Zmc2V0OiAiNSUiLCBzdG9wQ29sb3I6IENPTE9SUy5ub25MaXF1aWQsIHN0b3BPcGFjaXR5OiAwLjEgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3RvcCIsIHsgb2Zmc2V0OiAiOTUlIiwgc3RvcENvbG9yOiBDT0xPUlMubm9uTGlxdWlkLCBzdG9wT3BhY2l0eTogMCB9KQogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDYXJ0ZXNpYW5HcmlkLCB7IHN0cm9rZURhc2hhcnJheTogIjMgMyIsIHZlcnRpY2FsOiBmYWxzZSwgc3Ryb2tlOiBDT0xPUlMuYm9yZGVyTGlnaHQgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICBYQXhpcywKICAgICAgICAgICAgewogICAgICAgICAgICAgIGRhdGFLZXk6ICJ5ZWFyIiwKICAgICAgICAgICAgICB0aWNrOiB7IGZpbGw6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTEgfSwKICAgICAgICAgICAgICB0aWNrTGluZTogZmFsc2UsCiAgICAgICAgICAgICAgYXhpc0xpbmU6IHsgc3Ryb2tlOiBDT0xPUlMuYm9yZGVyIH0sCiAgICAgICAgICAgICAgdGlja0Zvcm1hdHRlcjogKHYpID0+IGBZciAke3Z9YAogICAgICAgICAgICB9CiAgICAgICAgICApLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgWUF4aXMsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB0aWNrOiB7IGZpbGw6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTEgfSwKICAgICAgICAgICAgICB0aWNrRm9ybWF0dGVyOiBmb3JtYXRZQXhpcywKICAgICAgICAgICAgICB0aWNrTGluZTogZmFsc2UsCiAgICAgICAgICAgICAgYXhpc0xpbmU6IGZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICAgICksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICBUb29sdGlwLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY29udGVudDogKHsgYWN0aXZlLCBwYXlsb2FkLCBsYWJlbCB9KSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoYWN0aXZlICYmIHBheWxvYWQgJiYgcGF5bG9hZC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgY29uc3QgbGlxID0gcGF5bG9hZC5maW5kKChwKSA9PiBwLmRhdGFLZXkgPT09ICJsaXF1aWQiKT8udmFsdWU7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGV4dCA9IHBheWxvYWQuZmluZCgocCkgPT4gcC5kYXRhS2V5ID09PSAiZXh0ZW5kZWQiKT8udmFsdWU7CiAgICAgICAgICAgICAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIHBhZGRpbmc6IDEyLCBib3JkZXJSYWRpdXM6IDgsIGJveFNoYWRvdzogIjAgNHB4IDEycHggcmdiYSgwLDAsMCwwLjEpIiwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBmb250U2l6ZTogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250V2VpZ2h0OiA3MDAsIG1hcmdpbkJvdHRvbTogNiwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgIlllYXIgIiwKICAgICAgICAgICAgICAgICAgICAgIGxhYmVsCiAgICAgICAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGdhcDogMTYsIG1hcmdpbkJvdHRvbTogMyB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgY29sb3I6IG1vbnRobHlCdXJuID4gMCA/IENPTE9SUy5leHBlbnNlIDogQ09MT1JTLmluY29tZSwgZm9udFdlaWdodDogNjAwIH0sIGNoaWxkcmVuOiAiTGlxdWlkIiB9KSwKICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IGxpcSA+PSAwID8gQ09MT1JTLnBvc2l0aXZlIDogQ09MT1JTLm5lZ2F0aXZlIH0sIGNoaWxkcmVuOiBmbXQobGlxKSB9KQogICAgICAgICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgICAgICAgbm9uTGlxdWlkQXREaXNjb3VudCA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBnYXA6IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLm5vbkxpcXVpZCwgZm9udFdlaWdodDogNjAwIH0sIGNoaWxkcmVuOiAiKyBOb24tbGlxdWlkIiB9KSwKICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IGV4dCA+PSAwID8gQ09MT1JTLnBvc2l0aXZlIDogQ09MT1JTLm5lZ2F0aXZlIH0sIGNoaWxkcmVuOiBmbXQoZXh0KSB9KQogICAgICAgICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgICAgICAgXSB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgKSwKICAgICAgICAgIG5vbkxpcXVpZEF0RGlzY291bnQgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQXJlYSwgeyB0eXBlOiAibW9ub3RvbmUiLCBkYXRhS2V5OiAiZXh0ZW5kZWQiLCBzdHJva2U6IENPTE9SUy5ub25MaXF1aWQsIGZpbGw6ICJ1cmwoI2dyYWRFeHRlbmRlZCkiLCBzdHJva2VXaWR0aDogMiwgc3Ryb2tlRGFzaGFycmF5OiAiNSA1IiwgbmFtZTogIkV4dGVuZGVkIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQXJlYSwgeyB0eXBlOiAibW9ub3RvbmUiLCBkYXRhS2V5OiAibGlxdWlkIiwgc3Ryb2tlOiBtb250aGx5QnVybiA+IDAgPyBDT0xPUlMuZXhwZW5zZSA6IENPTE9SUy5pbmNvbWUsIGZpbGw6ICJ1cmwoI2dyYWRMaXF1aWQpIiwgc3Ryb2tlV2lkdGg6IDIsIG5hbWU6ICJMaXF1aWQiIH0pCiAgICAgICAgXSB9KSB9KSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgZ2FwOiAxNiwgbWFyZ2luVG9wOiA4LCBmb250U2l6ZTogMTEgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiAxNiwgaGVpZ2h0OiAzLCBiYWNrZ3JvdW5kQ29sb3I6IG1vbnRobHlCdXJuID4gMCA/IENPTE9SUy5leHBlbnNlIDogQ09MT1JTLmluY29tZSwgYm9yZGVyUmFkaXVzOiAyIH0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIkxpcXVpZCBhc3NldHMiIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgbm9uTGlxdWlkQXREaXNjb3VudCA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6IDE2LCBoZWlnaHQ6IDMsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLm5vbkxpcXVpZCwgYm9yZGVyUmFkaXVzOiAyLCBib3JkZXJUb3A6ICIxcHggZGFzaGVkIiB9IH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICIrIE5vbi1saXF1aWQgc29sZCIgfSkKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pLAogICAgICAgIG1vbnRobHlCdXJuID4gMCAmJiAobGlxdWlkWmVyb1llYXIgfHwgZXh0WmVyb1llYXIpICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogOCwgcGFkZGluZzogIjhweCAxMnB4IiwgYm9yZGVyUmFkaXVzOiA4LCBiYWNrZ3JvdW5kQ29sb3I6IGAke0NPTE9SUy5leHBlbnNlfTA4YCwgZm9udFNpemU6IDExLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIGxpcXVpZFplcm9ZZWFyICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJMaXF1aWQgYXNzZXRzIGRlcGxldGVkIGF0ICIsCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzdHJvbmciLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMuZXhwZW5zZSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICJ5ZWFyICIsCiAgICAgICAgICAgICAgbGlxdWlkWmVyb1llYXIKICAgICAgICAgICAgXSB9KQogICAgICAgICAgXSB9KSwKICAgICAgICAgIGV4dFplcm9ZZWFyICYmIG5vbkxpcXVpZEF0RGlzY291bnQgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJBbGwgYXNzZXRzIGRlcGxldGVkIGF0ICIsCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzdHJvbmciLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMubm9uTGlxdWlkIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgInllYXIgIiwKICAgICAgICAgICAgICBleHRaZXJvWWVhcgogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pOwogICAgfSkoKQogIF0gfSk7Cn07CmZ1bmN0aW9uIE15QnVkZ2V0KHsgaW5pdGlhbERhdGE6IGluaXRpYWxEYXRhMiB9KSB7CiAgY29uc3QgW3NhdmVkQnVkZ2V0cywgc2V0U2F2ZWRCdWRnZXRzXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoKCkgPT4gbG9hZEJ1ZGdldHMoKSk7CiAgY29uc3QgW2N1cnJlbnRWaWV3LCBzZXRDdXJyZW50Vmlld10gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKCgpID0+IHsKICAgIGNvbnN0IGN1cnJlbnQzID0gbG9hZEN1cnJlbnRCdWRnZXQoKTsKICAgIGlmIChjdXJyZW50MyAmJiAoY3VycmVudDMuaW5jb21lLmxlbmd0aCA+IDAgfHwgY3VycmVudDMuZXhwZW5zZXMubGVuZ3RoID4gMCB8fCBjdXJyZW50My5hc3NldHMubGVuZ3RoID4gMCkpIHJldHVybiAiYnVkZ2V0IjsKICAgIHJldHVybiBzYXZlZEJ1ZGdldHMubGVuZ3RoID4gMCA/ICJob21lIiA6ICJidWRnZXQiOwogIH0pOwogIGNvbnN0IFtidWRnZXQsIHNldEJ1ZGdldF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKCgpID0+IGxvYWRDdXJyZW50QnVkZ2V0KCkgfHwgZW1wdHlCdWRnZXQoKSk7CiAgY29uc3QgW2VkaXRpbmdOYW1lLCBzZXRFZGl0aW5nTmFtZV0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbbmFtZUlucHV0LCBzZXROYW1lSW5wdXRdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKShidWRnZXQubmFtZSk7CiAgY29uc3QgW3JlZnJlc2hpbmcsIHNldFJlZnJlc2hpbmddID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW3Nob3dTdWJzY3JpYmVNb2RhbCwgc2V0U2hvd1N1YnNjcmliZU1vZGFsXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoZmFsc2UpOwogIGNvbnN0IFtzdWJzY3JpYmVFbWFpbCwgc2V0U3Vic2NyaWJlRW1haWxdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKSgiIik7CiAgY29uc3QgW3N1YnNjcmliZVN0YXR1cywgc2V0U3Vic2NyaWJlU3RhdHVzXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoImlkbGUiKTsKICBjb25zdCBbc3Vic2NyaWJlTWVzc2FnZSwgc2V0U3Vic2NyaWJlTWVzc2FnZV0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKCIiKTsKICBjb25zdCBbc2hvd0ZlZWRiYWNrTW9kYWwsIHNldFNob3dGZWVkYmFja01vZGFsXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoZmFsc2UpOwogIGNvbnN0IFtmZWVkYmFja1RleHQsIHNldEZlZWRiYWNrVGV4dF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKCIiKTsKICBjb25zdCBbZmVlZGJhY2tTdGF0dXMsIHNldEZlZWRiYWNrU3RhdHVzXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoImlkbGUiKTsKICBjb25zdCBbY29uZmlybURpYWxvZywgc2V0Q29uZmlybURpYWxvZ10gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKG51bGwpOwogIGNvbnN0IFtlbmpveVZvdGUsIHNldEVuam95Vm90ZV0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKG51bGwpOwogIGNvbnN0IGNvbnRhaW5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VSZWYpKG51bGwpOwogIGNvbnN0IFtwaWxsUmlnaHQsIHNldFBpbGxSaWdodF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKDE2KTsKICAoMCwgaW1wb3J0X3JlYWN0NTEudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBzYXZlQ3VycmVudEJ1ZGdldChidWRnZXQpOwogIH0sIFtidWRnZXRdKTsKICAoMCwgaW1wb3J0X3JlYWN0NTEudXNlRWZmZWN0KSgoKSA9PiB7CiAgICB0cnkgewogICAgICBjb25zdCB2ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oImVuam95Vm90ZV9idWRnZXQiKTsKICAgICAgaWYgKHYgPT09ICJ1cCIgfHwgdiA9PT0gImRvd24iKSBzZXRFbmpveVZvdGUodik7CiAgICB9IGNhdGNoIHsKICAgIH0KICB9LCBbXSk7CiAgKDAsIGltcG9ydF9yZWFjdDUxLnVzZUVmZmVjdCkoKCkgPT4gewogICAgY29uc3QgdXBkYXRlID0gKCkgPT4gewogICAgICBpZiAoY29udGFpbmVyUmVmLmN1cnJlbnQpIHsKICAgICAgICBjb25zdCByZWN0ID0gY29udGFpbmVyUmVmLmN1cnJlbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgc2V0UGlsbFJpZ2h0KE1hdGgubWF4KDE2LCB3aW5kb3cuaW5uZXJXaWR0aCAtIHJlY3QucmlnaHQgKyAxNikpOwogICAgICB9CiAgICB9OwogICAgdXBkYXRlKCk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicmVzaXplIiwgdXBkYXRlKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJzY3JvbGwiLCB1cGRhdGUpOwogICAgY29uc3Qgcm8gPSB0eXBlb2YgUmVzaXplT2JzZXJ2ZXIgIT09ICJ1bmRlZmluZWQiID8gbmV3IFJlc2l6ZU9ic2VydmVyKHVwZGF0ZSkgOiBudWxsOwogICAgaWYgKHJvICYmIGNvbnRhaW5lclJlZi5jdXJyZW50KSByby5vYnNlcnZlKGNvbnRhaW5lclJlZi5jdXJyZW50KTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJyZXNpemUiLCB1cGRhdGUpOwogICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigic2Nyb2xsIiwgdXBkYXRlKTsKICAgICAgcm8/LmRpc2Nvbm5lY3QoKTsKICAgIH07CiAgfSwgW10pOwogIGNvbnN0IGhhbmRsZUVuam95Vm90ZSA9ICh2b3RlKSA9PiB7CiAgICBpZiAoZW5qb3lWb3RlKSByZXR1cm47CiAgICBzZXRFbmpveVZvdGUodm90ZSk7CiAgICB0cnkgewogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiZW5qb3lWb3RlX2J1ZGdldCIsIHZvdGUpOwogICAgfSBjYXRjaCB7CiAgICB9CiAgICB0cmFja0V2ZW50KCJlbmpveV92b3RlIiwgeyB2b3RlLCBidWRnZXROYW1lOiBidWRnZXQubmFtZSB8fCBudWxsIH0pOwogICAgc2V0U2hvd0ZlZWRiYWNrTW9kYWwodHJ1ZSk7CiAgfTsKICBjb25zdCByZWZyZXNoUHJpY2VzID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZUNhbGxiYWNrKShhc3luYyAoKSA9PiB7CiAgICB0cmFja0V2ZW50KCJyZWZyZXNoX2NyeXB0byIsIHsgYnVkZ2V0TmFtZTogYnVkZ2V0Lm5hbWUgfHwgbnVsbCB9KTsKICAgIGNvbnN0IGFsbEl0ZW1zID0gWy4uLmJ1ZGdldC5hc3NldHMsIC4uLmJ1ZGdldC5ub25MaXF1aWRBc3NldHMsIC4uLmJ1ZGdldC5yZXRpcmVtZW50XTsKICAgIGNvbnN0IGNyeXB0b0l0ZW1zID0gYWxsSXRlbXMuZmlsdGVyKChpKSA9PiBpLmFzc2V0VHlwZSA9PT0gImNyeXB0byIgJiYgaS50aWNrZXIpOwogICAgaWYgKGNyeXB0b0l0ZW1zLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwogICAgc2V0UmVmcmVzaGluZyh0cnVlKTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHVuaXF1ZUlkcyA9IFsuLi5uZXcgU2V0KGNyeXB0b0l0ZW1zLm1hcCgoaSkgPT4gaS50aWNrZXIpKV07CiAgICAgIGNvbnN0IHByaWNlcyA9IGF3YWl0IGZldGNoQ3J5cHRvUHJpY2VzKHVuaXF1ZUlkcyk7CiAgICAgIHNldEJ1ZGdldCgoYikgPT4gewogICAgICAgIGNvbnN0IHVwZGF0ZVNlY3Rpb24gPSAoaXRlbXMpID0+IGl0ZW1zLm1hcCgoaXRlbSkgPT4gewogICAgICAgICAgaWYgKGl0ZW0uYXNzZXRUeXBlICE9PSAiY3J5cHRvIiB8fCAhaXRlbS50aWNrZXIgfHwgIXByaWNlc1tpdGVtLnRpY2tlcl0pIHJldHVybiBpdGVtOwogICAgICAgICAgY29uc3QgbmV3UHJpY2UgPSBwcmljZXNbaXRlbS50aWNrZXJdOwogICAgICAgICAgY29uc3QgbmV3QW1vdW50ID0gaXRlbS5xdWFudGl0eSA/IE1hdGgucm91bmQobmV3UHJpY2UgKiBpdGVtLnF1YW50aXR5ICogMTAwKSAvIDEwMCA6IGl0ZW0uYW1vdW50OwogICAgICAgICAgY29uc3QgY29tcHV0ZWQgPSBjb21wdXRlVmFsdWVzKG5ld0Ftb3VudCwgaXRlbS5mcmVxdWVuY3kpOwogICAgICAgICAgcmV0dXJuIHsgLi4uaXRlbSwgbGl2ZVByaWNlOiBuZXdQcmljZSwgYW1vdW50OiBuZXdBbW91bnQsIC4uLmNvbXB1dGVkIH07CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIC4uLmIsCiAgICAgICAgICBhc3NldHM6IHVwZGF0ZVNlY3Rpb24oYi5hc3NldHMpLAogICAgICAgICAgbm9uTGlxdWlkQXNzZXRzOiB1cGRhdGVTZWN0aW9uKGIubm9uTGlxdWlkQXNzZXRzKSwKICAgICAgICAgIHJldGlyZW1lbnQ6IHVwZGF0ZVNlY3Rpb24oYi5yZXRpcmVtZW50KSwKICAgICAgICAgIGxhc3RQcmljZVJlZnJlc2g6IERhdGUubm93KCksCiAgICAgICAgICB1cGRhdGVkQXQ6IERhdGUubm93KCkKICAgICAgICB9OwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIHJlZnJlc2ggcHJpY2VzIiwgZSk7CiAgICB9IGZpbmFsbHkgewogICAgICBzZXRSZWZyZXNoaW5nKGZhbHNlKTsKICAgIH0KICB9LCBbYnVkZ2V0LmFzc2V0cywgYnVkZ2V0Lm5vbkxpcXVpZEFzc2V0cywgYnVkZ2V0LnJldGlyZW1lbnRdKTsKICBjb25zdCB1cGRhdGVJdGVtID0gKHNlY3Rpb24sIGlkLCB1cGRhdGVzKSA9PiB7CiAgICBzZXRCdWRnZXQoKGIpID0+ICh7CiAgICAgIC4uLmIsCiAgICAgIFtzZWN0aW9uXTogYltzZWN0aW9uXS5tYXAoKGl0ZW0pID0+IGl0ZW0uaWQgPT09IGlkID8geyAuLi5pdGVtLCAuLi51cGRhdGVzIH0gOiBpdGVtKSwKICAgICAgdXBkYXRlZEF0OiBEYXRlLm5vdygpCiAgICB9KSk7CiAgfTsKICBjb25zdCBhZGRJdGVtID0gKHNlY3Rpb24sIGZyZXEgPSAibW9udGhseSIpID0+IHsKICAgIHRyYWNrRXZlbnQoImFkZF9pdGVtIiwgeyBzZWN0aW9uLCBmcmVxdWVuY3k6IGZyZXEsIGJ1ZGdldE5hbWU6IGJ1ZGdldC5uYW1lIHx8IG51bGwgfSk7CiAgICBzZXRCdWRnZXQoKGIpID0+ICh7CiAgICAgIC4uLmIsCiAgICAgIFtzZWN0aW9uXTogWy4uLmJbc2VjdGlvbl0sIGVtcHR5SXRlbShmcmVxKV0sCiAgICAgIHVwZGF0ZWRBdDogRGF0ZS5ub3coKQogICAgfSkpOwogIH07CiAgY29uc3QgYWRkUHJlc2V0SXRlbSA9IChzZWN0aW9uLCBuYW1lLCBmcmVxID0gIm1vbnRobHkiKSA9PiB7CiAgICB0cmFja0V2ZW50KCJhZGRfcHJlc2V0X2l0ZW0iLCB7IHNlY3Rpb24sIHByZXNldE5hbWU6IG5hbWUsIGZyZXF1ZW5jeTogZnJlcSB9KTsKICAgIHNldEJ1ZGdldCgoYikgPT4gKHsKICAgICAgLi4uYiwKICAgICAgW3NlY3Rpb25dOiBbLi4uYltzZWN0aW9uXSwgeyAuLi5lbXB0eUl0ZW0oZnJlcSksIG5hbWUgfV0sCiAgICAgIHVwZGF0ZWRBdDogRGF0ZS5ub3coKQogICAgfSkpOwogIH07CiAgY29uc3QgcmVvcmRlckl0ZW1zID0gKHNlY3Rpb24sIGZyb21JbmRleCwgdG9JbmRleCkgPT4gewogICAgc2V0QnVkZ2V0KChiKSA9PiB7CiAgICAgIGNvbnN0IGFyciA9IFsuLi5iW3NlY3Rpb25dXTsKICAgICAgY29uc3QgW21vdmVkXSA9IGFyci5zcGxpY2UoZnJvbUluZGV4LCAxKTsKICAgICAgYXJyLnNwbGljZSh0b0luZGV4LCAwLCBtb3ZlZCk7CiAgICAgIHJldHVybiB7IC4uLmIsIFtzZWN0aW9uXTogYXJyLCB1cGRhdGVkQXQ6IERhdGUubm93KCkgfTsKICAgIH0pOwogIH07CiAgY29uc3QgZGVsZXRlSXRlbSA9IChzZWN0aW9uLCBpZCkgPT4gewogICAgdHJhY2tFdmVudCgiZGVsZXRlX2l0ZW0iLCB7IHNlY3Rpb24sIGJ1ZGdldE5hbWU6IGJ1ZGdldC5uYW1lIHx8IG51bGwgfSk7CiAgICBzZXRCdWRnZXQoKGIpID0+ICh7CiAgICAgIC4uLmIsCiAgICAgIFtzZWN0aW9uXTogYltzZWN0aW9uXS5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0uaWQgIT09IGlkKSwKICAgICAgdXBkYXRlZEF0OiBEYXRlLm5vdygpCiAgICB9KSk7CiAgfTsKICBjb25zdCBzYXZlQnVkZ2V0VG9MaXN0ID0gKCkgPT4gewogICAgY29uc3QgZXhpc3RpbmcgPSBsb2FkQnVkZ2V0cygpOwogICAgY29uc3QgaWR4ID0gZXhpc3RpbmcuZmluZEluZGV4KChiKSA9PiBiLmlkID09PSBidWRnZXQuaWQpOwogICAgaWYgKGlkeCA+PSAwKSB7CiAgICAgIGV4aXN0aW5nW2lkeF0gPSB7IC4uLmJ1ZGdldCwgdXBkYXRlZEF0OiBEYXRlLm5vdygpIH07CiAgICB9IGVsc2UgewogICAgICBleGlzdGluZy5wdXNoKHsgLi4uYnVkZ2V0LCB1cGRhdGVkQXQ6IERhdGUubm93KCkgfSk7CiAgICB9CiAgICBzYXZlQnVkZ2V0cyhleGlzdGluZyk7CiAgICBzZXRTYXZlZEJ1ZGdldHMoZXhpc3RpbmcpOwogIH07CiAgY29uc3QgaGFuZGxlTmV3QnVkZ2V0ID0gKCkgPT4gewogICAgdHJhY2tFdmVudCgibmV3X2J1ZGdldCIpOwogICAgaWYgKGJ1ZGdldC5pbmNvbWUubGVuZ3RoID4gMCB8fCBidWRnZXQuZXhwZW5zZXMubGVuZ3RoID4gMCB8fCBidWRnZXQuYXNzZXRzLmxlbmd0aCA+IDApIHsKICAgICAgc2F2ZUJ1ZGdldFRvTGlzdCgpOwogICAgfQogICAgY29uc3QgbmV3QiA9IGVtcHR5QnVkZ2V0KCk7CiAgICBzZXRCdWRnZXQobmV3Qik7CiAgICBzZXROYW1lSW5wdXQobmV3Qi5uYW1lKTsKICAgIHNldEN1cnJlbnRWaWV3KCJidWRnZXQiKTsKICB9OwogIGNvbnN0IGhhbmRsZU9wZW5CdWRnZXQgPSAoYikgPT4gewogICAgdHJhY2tFdmVudCgib3Blbl9idWRnZXQiLCB7IGJ1ZGdldE5hbWU6IGIubmFtZSB8fCBudWxsIH0pOwogICAgaWYgKGJ1ZGdldC5pbmNvbWUubGVuZ3RoID4gMCB8fCBidWRnZXQuZXhwZW5zZXMubGVuZ3RoID4gMCB8fCBidWRnZXQuYXNzZXRzLmxlbmd0aCA+IDApIHsKICAgICAgc2F2ZUJ1ZGdldFRvTGlzdCgpOwogICAgfQogICAgc2V0QnVkZ2V0KGIpOwogICAgc2V0TmFtZUlucHV0KGIubmFtZSk7CiAgICBzYXZlQ3VycmVudEJ1ZGdldChiKTsKICAgIHNldEN1cnJlbnRWaWV3KCJidWRnZXQiKTsKICB9OwogIGNvbnN0IGhhbmRsZURlbGV0ZUJ1ZGdldCA9IChpZCkgPT4gewogICAgdHJhY2tFdmVudCgiZGVsZXRlX2J1ZGdldCIsIHsgYnVkZ2V0SWQ6IGlkIH0pOwogICAgY29uc3QgdXBkYXRlZCA9IHNhdmVkQnVkZ2V0cy5maWx0ZXIoKGIpID0+IGIuaWQgIT09IGlkKTsKICAgIHNhdmVCdWRnZXRzKHVwZGF0ZWQpOwogICAgc2V0U2F2ZWRCdWRnZXRzKHVwZGF0ZWQpOwogIH07CiAgY29uc3QgaGFuZGxlUmVzZXQgPSAoKSA9PiB7CiAgICBzZXRDb25maXJtRGlhbG9nKHsKICAgICAgbWVzc2FnZTogIkNsZWFyIGFsbCBidWRnZXQgZGF0YSBvbiB0aGUgY3VycmVudCBzY3JlZW4/IiwKICAgICAgb25Db25maXJtOiAoKSA9PiB7CiAgICAgICAgdHJhY2tFdmVudCgicmVzZXQiLCB7IGJ1ZGdldE5hbWU6IGJ1ZGdldC5uYW1lLCBpdGVtQ291bnQ6IGJ1ZGdldC5pbmNvbWUubGVuZ3RoICsgYnVkZ2V0LmV4cGVuc2VzLmxlbmd0aCArIGJ1ZGdldC5hc3NldHMubGVuZ3RoIH0pOwogICAgICAgIGNvbnN0IG5ld0IgPSBlbXB0eUJ1ZGdldCgpOwogICAgICAgIHNldEJ1ZGdldChuZXdCKTsKICAgICAgICBzZXROYW1lSW5wdXQobmV3Qi5uYW1lKTsKICAgICAgfQogICAgfSk7CiAgfTsKICBjb25zdCBoYW5kbGVTdWJzY3JpYmUgPSBhc3luYyAoKSA9PiB7CiAgICBpZiAoIXN1YnNjcmliZUVtYWlsIHx8ICFzdWJzY3JpYmVFbWFpbC5pbmNsdWRlcygiQCIpKSB7CiAgICAgIHNldFN1YnNjcmliZU1lc3NhZ2UoIlBsZWFzZSBlbnRlciBhIHZhbGlkIGVtYWlsLiIpOwogICAgICBzZXRTdWJzY3JpYmVTdGF0dXMoImVycm9yIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHNldFN1YnNjcmliZVN0YXR1cygibG9hZGluZyIpOwogICAgdHJ5IHsKICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgiL2FwaS9zdWJzY3JpYmUiLCB7CiAgICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlbWFpbDogc3Vic2NyaWJlRW1haWwsIHRvcGljSWQ6ICJidWRnZXQtcGxhbm5lci1uZXdzIiwgdG9waWNOYW1lOiAiQnVkZ2V0IFBsYW5uZXIgVXBkYXRlcyIgfSkKICAgICAgfSk7CiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7CiAgICAgIGlmIChyZXNwb25zZS5vayAmJiBkYXRhLnN1Y2Nlc3MpIHsKICAgICAgICBzZXRTdWJzY3JpYmVTdGF0dXMoInN1Y2Nlc3MiKTsKICAgICAgICBzZXRTdWJzY3JpYmVNZXNzYWdlKGRhdGEubWVzc2FnZSk7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBzZXRTaG93U3Vic2NyaWJlTW9kYWwoZmFsc2UpOwogICAgICAgICAgc2V0U3Vic2NyaWJlRW1haWwoIiIpOwogICAgICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJpZGxlIik7CiAgICAgICAgICBzZXRTdWJzY3JpYmVNZXNzYWdlKCIiKTsKICAgICAgICB9LCAzZTMpOwogICAgICB9IGVsc2UgewogICAgICAgIHNldFN1YnNjcmliZVN0YXR1cygiZXJyb3IiKTsKICAgICAgICBzZXRTdWJzY3JpYmVNZXNzYWdlKGRhdGEuZXJyb3IgfHwgIkZhaWxlZCB0byBzdWJzY3JpYmUuIik7CiAgICAgIH0KICAgIH0gY2F0Y2ggewogICAgICBzZXRTdWJzY3JpYmVTdGF0dXMoImVycm9yIik7CiAgICAgIHNldFN1YnNjcmliZU1lc3NhZ2UoIk5ldHdvcmsgZXJyb3IuIFBsZWFzZSB0cnkgYWdhaW4uIik7CiAgICB9CiAgfTsKICBjb25zdCBoYW5kbGVGZWVkYmFja1N1Ym1pdCA9IGFzeW5jICgpID0+IHsKICAgIGlmICghZmVlZGJhY2tUZXh0LnRyaW0oKSkgcmV0dXJuOwogICAgc2V0RmVlZGJhY2tTdGF0dXMoInN1Ym1pdHRpbmciKTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goIi9hcGkvdHJhY2siLCB7CiAgICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgICAgaGVhZGVyczogeyAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iIH0sCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBldmVudDogInVzZXJfZmVlZGJhY2siLCBkYXRhOiB7IGZlZWRiYWNrOiBmZWVkYmFja1RleHQsIHRvb2w6ICJidWRnZXQtcGxhbm5lciIsIGJ1ZGdldE5hbWU6IGJ1ZGdldC5uYW1lIHx8IG51bGwgfSB9KQogICAgICB9KTsKICAgICAgaWYgKHJlc3BvbnNlLm9rKSB7CiAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoInN1Y2Nlc3MiKTsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHNldFNob3dGZWVkYmFja01vZGFsKGZhbHNlKTsKICAgICAgICAgIHNldEZlZWRiYWNrVGV4dCgiIik7CiAgICAgICAgICBzZXRGZWVkYmFja1N0YXR1cygiaWRsZSIpOwogICAgICAgIH0sIDJlMyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoImVycm9yIik7CiAgICAgIH0KICAgIH0gY2F0Y2ggewogICAgICBzZXRGZWVkYmFja1N0YXR1cygiZXJyb3IiKTsKICAgIH0KICB9OwogIGNvbnN0IGhhbmRsZUJhY2tUb0hvbWUgPSAoKSA9PiB7CiAgICB0cmFja0V2ZW50KCJiYWNrX3RvX2hvbWUiKTsKICAgIHNhdmVCdWRnZXRUb0xpc3QoKTsKICAgIHNldEN1cnJlbnRWaWV3KCJob21lIik7CiAgfTsKICBjb25zdCBoYW5kbGVQcmludCA9ICgpID0+IHsKICAgIHdpbmRvdy5wcmludCgpOwogIH07CiAgaWYgKGN1cnJlbnRWaWV3ID09PSAiaG9tZSIpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyByZWY6IGNvbnRhaW5lclJlZiwgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuYmcsIGZvbnRGYW1pbHk6ICInSW50ZXInLCAtYXBwbGUtc3lzdGVtLCBCbGlua01hY1N5c3RlbUZvbnQsICdTZWdvZSBVSScsIFJvYm90bywgc2Fucy1zZXJpZiIsIG1heFdpZHRoOiA2MDAsIG1hcmdpbjogIjAgYXV0byIsIG92ZXJmbG93OiAiaGlkZGVuIiwgYm94U2l6aW5nOiAiYm9yZGVyLWJveCIsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgYm9yZGVyUmFkaXVzOiAxNiB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5LCBwYWRkaW5nOiAiMjRweCAyMHB4IiwgY29sb3I6ICJ3aGl0ZSIgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiaDEiLCB7IHN0eWxlOiB7IG1hcmdpbjogMCwgZm9udFNpemU6IDI0LCBmb250V2VpZ2h0OiA3MDAsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogMTAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoRG9sbGFyU2lnbiwgeyBzaXplOiAyOCB9KSwKICAgICAgICAgICIgTXkgQnVkZ2V0IgogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgbWFyZ2luOiAiNHB4IDAgMCIsIGZvbnRTaXplOiAxNCwgb3BhY2l0eTogMC45IH0sIGNoaWxkcmVuOiAiWW91ciBzYXZlZCBidWRnZXRzIiB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAyMCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJidXR0b24iLCB7IG9uQ2xpY2s6IGhhbmRsZU5ld0J1ZGdldCwgc3R5bGU6IHsKICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICBwYWRkaW5nOiAxNiwKICAgICAgICAgIGJvcmRlclJhZGl1czogMTIsCiAgICAgICAgICBib3JkZXI6IGAycHggZGFzaGVkICR7Q09MT1JTLnByaW1hcnl9YCwKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmFjY2VudExpZ2h0LAogICAgICAgICAgY29sb3I6IENPTE9SUy5wcmltYXJ5RGFyaywKICAgICAgICAgIGZvbnRTaXplOiAxNSwKICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgICBnYXA6IDgsCiAgICAgICAgICBtYXJnaW5Cb3R0b206IDIwCiAgICAgICAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUGx1cywgeyBzaXplOiAyMCB9KSwKICAgICAgICAgICIgQ3JlYXRlIE5ldyBCdWRnZXQiCiAgICAgICAgXSB9KSwKICAgICAgICBzYXZlZEJ1ZGdldHMubGVuZ3RoID09PSAwID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgdGV4dEFsaWduOiAiY2VudGVyIiwgcGFkZGluZzogNDAsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShQaWdneUJhbmssIHsgc2l6ZTogNDgsIHN0eWxlOiB7IG9wYWNpdHk6IDAuMywgbWFyZ2luQm90dG9tOiAxNiB9IH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgbWFyZ2luOiAwIH0sIGNoaWxkcmVuOiAiTm8gc2F2ZWQgYnVkZ2V0cyB5ZXQiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgbWFyZ2luOiAiNHB4IDAgMCIsIGZvbnRTaXplOiAxMyB9LCBjaGlsZHJlbjogIkNyZWF0ZSB5b3VyIGZpcnN0IGJ1ZGdldCB0byBnZXQgc3RhcnRlZCIgfSkKICAgICAgICBdIH0pIDogc2F2ZWRCdWRnZXRzLm1hcCgoYikgPT4gewogICAgICAgICAgY29uc3QgdG90YWxJbmNvbWUgPSBiLmluY29tZS5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLm1vbnRobHlWYWx1ZSwgMCk7CiAgICAgICAgICBjb25zdCB0b3RhbEV4cGVuc2VzID0gYi5leHBlbnNlcy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLm1vbnRobHlWYWx1ZSwgMCk7CiAgICAgICAgICBjb25zdCBuZXQgPSB0b3RhbEluY29tZSAtIHRvdGFsRXhwZW5zZXM7CiAgICAgICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwKICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMiwKICAgICAgICAgICAgcGFkZGluZzogIjE0cHggMTZweCIsCiAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgICAgICAgbWFyZ2luQm90dG9tOiA4LAogICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIgogICAgICAgICAgfSwgb25DbGljazogKCkgPT4gaGFuZGxlT3BlbkJ1ZGdldChiKSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluIH0sIGNoaWxkcmVuOiBiLm5hbWUgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgYi5pbmNvbWUubGVuZ3RoICsgYi5leHBlbnNlcy5sZW5ndGggKyBiLmFzc2V0cy5sZW5ndGggKyBiLm5vbkxpcXVpZEFzc2V0cy5sZW5ndGggKyAoYi5yZXRpcmVtZW50IHx8IFtdKS5sZW5ndGggKyBiLmxpYWJpbGl0aWVzLmxlbmd0aCwKICAgICAgICAgICAgICAgICIgaXRlbXMgXHhCNyBVcGRhdGVkICIsCiAgICAgICAgICAgICAgICBuZXcgRGF0ZShiLnVwZGF0ZWRBdCkudG9Mb2NhbGVEYXRlU3RyaW5nKCkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgdGV4dEFsaWduOiAicmlnaHQiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTUsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IG5ldCA+PSAwID8gQ09MT1JTLnBvc2l0aXZlIDogQ09MT1JTLm5lZ2F0aXZlIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgbmV0ID49IDAgPyAiKyIgOiAiIiwKICAgICAgICAgICAgICBmbXQobmV0KSwKICAgICAgICAgICAgICAiL21vIgogICAgICAgICAgICBdIH0pIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6IChlKSA9PiB7CiAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICBoYW5kbGVEZWxldGVCdWRnZXQoYi5pZCk7CiAgICAgICAgICAgIH0sIHN0eWxlOiB7CiAgICAgICAgICAgICAgcGFkZGluZzogNiwKICAgICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiAibm9uZSIsCiAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsCiAgICAgICAgICAgICAgbWFyZ2luTGVmdDogOAogICAgICAgICAgICB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShUcmFzaDIsIHsgc2l6ZTogMTYgfSkgfSkKICAgICAgICAgIF0gfSwgYi5pZCk7CiAgICAgICAgfSkKICAgICAgXSB9KQogICAgXSB9KTsKICB9CiAgY29uc3QgaGFzQ3J5cHRvID0gWy4uLmJ1ZGdldC5hc3NldHMsIC4uLmJ1ZGdldC5ub25MaXF1aWRBc3NldHMsIC4uLmJ1ZGdldC5yZXRpcmVtZW50XS5zb21lKChpKSA9PiBpLmFzc2V0VHlwZSA9PT0gImNyeXB0byIgJiYgaS50aWNrZXIpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyByZWY6IGNvbnRhaW5lclJlZiwgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuYmcsIGZvbnRGYW1pbHk6ICInSW50ZXInLCAtYXBwbGUtc3lzdGVtLCBCbGlua01hY1N5c3RlbUZvbnQsICdTZWdvZSBVSScsIFJvYm90bywgc2Fucy1zZXJpZiIsIG1heFdpZHRoOiA2MDAsIG1hcmdpbjogIjAgYXV0byIsIGJveFNpemluZzogImJvcmRlci1ib3giLCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIGJvcmRlclJhZGl1czogMTYsIG92ZXJmbG93OiAiaGlkZGVuIiB9LCBjaGlsZHJlbjogWwogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3R5bGUiLCB7IGNoaWxkcmVuOiBgQGtleWZyYW1lcyBzcGluIHsgZnJvbSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTAlKSByb3RhdGUoMGRlZyk7IH0gdG8geyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTUwJSkgcm90YXRlKDM2MGRlZyk7IH0gfSBAa2V5ZnJhbWVzIHNwaW5CdG4geyBmcm9tIHsgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7IH0gdG8geyB0cmFuc2Zvcm06IHJvdGF0ZSgzNjBkZWcpOyB9IH1gIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMucHJpbWFyeSwgcGFkZGluZzogIjIwcHggMTZweCIsIGNvbG9yOiAid2hpdGUiIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShEb2xsYXJTaWduLCB7IHNpemU6IDI0IH0pLAogICAgICAgICAgZWRpdGluZ05hbWUgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaW5wdXQiLCB7IHZhbHVlOiBuYW1lSW5wdXQsIG9uQ2hhbmdlOiAoZSkgPT4gc2V0TmFtZUlucHV0KGUudGFyZ2V0LnZhbHVlKSwgc3R5bGU6IHsKICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiAicmdiYSgyNTUsMjU1LDI1NSwwLjIpIiwKICAgICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgICBjb2xvcjogIndoaXRlIiwKICAgICAgICAgICAgICBmb250U2l6ZTogMjAsCiAgICAgICAgICAgICAgZm9udFdlaWdodDogNzAwLAogICAgICAgICAgICAgIHBhZGRpbmc6ICIycHggOHB4IiwKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDYsCiAgICAgICAgICAgICAgb3V0bGluZTogIm5vbmUiLAogICAgICAgICAgICAgIHdpZHRoOiAxODAsCiAgICAgICAgICAgICAgZm9udEZhbWlseTogImluaGVyaXQiCiAgICAgICAgICAgIH0sIGF1dG9Gb2N1czogdHJ1ZSwgb25LZXlEb3duOiAoZSkgPT4gewogICAgICAgICAgICAgIGlmIChlLmtleSA9PT0gIkVudGVyIikgewogICAgICAgICAgICAgICAgc2V0QnVkZ2V0KChiKSA9PiAoeyAuLi5iLCBuYW1lOiBuYW1lSW5wdXQgfSkpOwogICAgICAgICAgICAgICAgc2V0RWRpdGluZ05hbWUoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgc2V0QnVkZ2V0KChiKSA9PiAoeyAuLi5iLCBuYW1lOiBuYW1lSW5wdXQgfSkpOwogICAgICAgICAgICAgIHNldEVkaXRpbmdOYW1lKGZhbHNlKTsKICAgICAgICAgICAgfSwgc3R5bGU6IHsgcGFkZGluZzogNCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmQ6ICJub25lIiwgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiAid2hpdGUiLCBkaXNwbGF5OiAiZmxleCIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2hlY2ssIHsgc2l6ZTogMTggfSkgfSkKICAgICAgICAgIF0gfSkgOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJoMSIsIHsgb25DbGljazogKCkgPT4gc2V0RWRpdGluZ05hbWUodHJ1ZSksIHN0eWxlOiB7IG1hcmdpbjogMCwgZm9udFNpemU6IDIwLCBmb250V2VpZ2h0OiA3MDAsIGN1cnNvcjogInBvaW50ZXIiIH0sIGNoaWxkcmVuOiBidWRnZXQubmFtZSB9KQogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICBoYXNDcnlwdG8gJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImJ1dHRvbiIsIHsgb25DbGljazogcmVmcmVzaFByaWNlcywgZGlzYWJsZWQ6IHJlZnJlc2hpbmcsIHN0eWxlOiB7CiAgICAgICAgICAgIHBhZGRpbmc6ICI2cHggMTBweCIsCiAgICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogcmVmcmVzaGluZyA/ICJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIDogInJnYmEoMjU1LDI1NSwyNTUsMC4yKSIsCiAgICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgICBjdXJzb3I6IHJlZnJlc2hpbmcgPyAiZGVmYXVsdCIgOiAicG9pbnRlciIsCiAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgIGdhcDogNCwKICAgICAgICAgICAgZm9udFNpemU6IDExLAogICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgIG9wYWNpdHk6IHJlZnJlc2hpbmcgPyAwLjcgOiAxCiAgICAgICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFJlZnJlc2hDdywgeyBzaXplOiAxNCwgc3R5bGU6IHJlZnJlc2hpbmcgPyB7IGFuaW1hdGlvbjogInNwaW5CdG4gMXMgbGluZWFyIGluZmluaXRlIiB9IDogdm9pZCAwIH0pLAogICAgICAgICAgICByZWZyZXNoaW5nID8gIlVwZGF0aW5nLi4uIiA6ICJSZWZyZXNoIFx1MjBCRiIKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6IGhhbmRsZUJhY2tUb0hvbWUsIHN0eWxlOiB7IHBhZGRpbmc6IDYsIGJvcmRlclJhZGl1czogNiwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmRDb2xvcjogInJnYmEoMjU1LDI1NSwyNTUsMC4yKSIsIGNvbG9yOiAid2hpdGUiLCBjdXJzb3I6ICJwb2ludGVyIiwgZGlzcGxheTogImZsZXgiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEhvdXNlLCB7IHNpemU6IDE2IH0pIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgIHRyYWNrRXZlbnQoInNhdmVfYnVkZ2V0IiwgeyBidWRnZXROYW1lOiBidWRnZXQubmFtZSB8fCBudWxsIH0pOwogICAgICAgICAgICBzYXZlQnVkZ2V0VG9MaXN0KCk7CiAgICAgICAgICB9LCBzdHlsZTogeyBwYWRkaW5nOiA2LCBib3JkZXJSYWRpdXM6IDYsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kQ29sb3I6ICJyZ2JhKDI1NSwyNTUsMjU1LDAuMikiLCBjb2xvcjogIndoaXRlIiwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShTYXZlLCB7IHNpemU6IDE2IH0pIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBoYW5kbGVQcmludCwgc3R5bGU6IHsgcGFkZGluZzogNiwgYm9yZGVyUmFkaXVzOiA2LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiAicmdiYSgyNTUsMjU1LDI1NSwwLjIpIiwgY29sb3I6ICJ3aGl0ZSIsIGN1cnNvcjogInBvaW50ZXIiLCBkaXNwbGF5OiAiZmxleCIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUHJpbnRlciwgeyBzaXplOiAxNiB9KSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJidXR0b24iLCB7IG9uQ2xpY2s6IGhhbmRsZU5ld0J1ZGdldCwgc3R5bGU6IHsgcGFkZGluZzogIjZweCAxMHB4IiwgYm9yZGVyUmFkaXVzOiA2LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBjb2xvcjogQ09MT1JTLnByaW1hcnksIGZvbnRTaXplOiAxMiwgZm9udFdlaWdodDogNjAwLCBjdXJzb3I6ICJwb2ludGVyIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoUGx1cywgeyBzaXplOiAxNCB9KSwKICAgICAgICAgICAgIiBOZXciCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgbWFyZ2luOiAwLCBmb250U2l6ZTogMTMsIG9wYWNpdHk6IDAuOCB9LCBjaGlsZHJlbjogIlRyYWNrIHlvdXIgaW5jb21lLCBleHBlbnNlcywgYXNzZXRzICYgbGlhYmlsaXRpZXMiIH0pLAogICAgICAgIGJ1ZGdldC5sYXN0UHJpY2VSZWZyZXNoICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIG9wYWNpdHk6IDAuNiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgIlByaWNlczogIiwKICAgICAgICAgIG5ldyBEYXRlKGJ1ZGdldC5sYXN0UHJpY2VSZWZyZXNoKS50b0xvY2FsZVRpbWVTdHJpbmcoKQogICAgICAgIF0gfSkKICAgICAgXSB9KQogICAgXSB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBhZGRpbmc6ICIxNnB4IDE2cHggNDBweCIgfSwgY2hpbGRyZW46IFsKICAgICAgYnVkZ2V0LmluY29tZS5sZW5ndGggPT09IDAgJiYgYnVkZ2V0LmV4cGVuc2VzLmxlbmd0aCA9PT0gMCAmJiBidWRnZXQuYXNzZXRzLmxlbmd0aCA9PT0gMCAmJiBidWRnZXQubm9uTGlxdWlkQXNzZXRzLmxlbmd0aCA9PT0gMCAmJiBidWRnZXQucmV0aXJlbWVudC5sZW5ndGggPT09IDAgJiYgYnVkZ2V0LmxpYWJpbGl0aWVzLmxlbmd0aCA9PT0gMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgc2V0QnVkZ2V0KHsgLi4uREVNT19CVURHRVQsIGlkOiBidWRnZXQuaWQsIGNyZWF0ZWRBdDogRGF0ZS5ub3coKSwgdXBkYXRlZEF0OiBEYXRlLm5vdygpIH0pOwogICAgICAgIHNldE5hbWVJbnB1dChERU1PX0JVREdFVC5uYW1lKTsKICAgICAgfSwgc3R5bGU6IHsKICAgICAgICB3aWR0aDogIjEwMCUiLAogICAgICAgIHBhZGRpbmc6IDE0LAogICAgICAgIGJvcmRlclJhZGl1czogMTIsCiAgICAgICAgYm9yZGVyOiBgMnB4IGRhc2hlZCAke0NPTE9SUy5hY2NlbnR9YCwKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5hY2NlbnRMaWdodCwKICAgICAgICBjb2xvcjogQ09MT1JTLnByaW1hcnlEYXJrLAogICAgICAgIGZvbnRTaXplOiAxNCwKICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwKICAgICAgICBnYXA6IDgsCiAgICAgICAgbWFyZ2luQm90dG9tOiAxNgogICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2hhcnRDb2x1bW4sIHsgc2l6ZTogMTggfSksCiAgICAgICAgIiBMb2FkIERlbW8gRGF0YSIKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICBCdWRnZXRTZWN0aW9uLAogICAgICAgIHsKICAgICAgICAgIHRpdGxlOiAiSW5jb21lIiwKICAgICAgICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoVHJlbmRpbmdVcCwgeyBzaXplOiAxOCB9KSwKICAgICAgICAgIGNvbG9yOiBDT0xPUlMuaW5jb21lLAogICAgICAgICAgYmdDb2xvcjogQ09MT1JTLmluY29tZUJnLAogICAgICAgICAgaXRlbXM6IGJ1ZGdldC5pbmNvbWUsCiAgICAgICAgICBpbnB1dE1vZGU6ICJyZWN1cnJpbmciLAogICAgICAgICAgcHJlc2V0czogUFJFU0VUUy5pbmNvbWUsCiAgICAgICAgICBvblVwZGF0ZTogKGlkLCB1KSA9PiB1cGRhdGVJdGVtKCJpbmNvbWUiLCBpZCwgdSksCiAgICAgICAgICBvbkFkZDogKCkgPT4gYWRkSXRlbSgiaW5jb21lIiwgIm1vbnRobHkiKSwKICAgICAgICAgIG9uQWRkUHJlc2V0OiAobmFtZSkgPT4gYWRkUHJlc2V0SXRlbSgiaW5jb21lIiwgbmFtZSwgIm1vbnRobHkiKSwKICAgICAgICAgIG9uRGVsZXRlOiAoaWQpID0+IGRlbGV0ZUl0ZW0oImluY29tZSIsIGlkKSwKICAgICAgICAgIG9uUmVvcmRlcjogKGZyb20yLCB0bzIpID0+IHJlb3JkZXJJdGVtcygiaW5jb21lIiwgZnJvbTIsIHRvMikKICAgICAgICB9CiAgICAgICksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgQnVkZ2V0U2VjdGlvbiwKICAgICAgICB7CiAgICAgICAgICB0aXRsZTogIkV4cGVuc2VzIiwKICAgICAgICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoVHJlbmRpbmdEb3duLCB7IHNpemU6IDE4IH0pLAogICAgICAgICAgY29sb3I6IENPTE9SUy5leHBlbnNlLAogICAgICAgICAgYmdDb2xvcjogQ09MT1JTLmV4cGVuc2VCZywKICAgICAgICAgIGl0ZW1zOiBidWRnZXQuZXhwZW5zZXMsCiAgICAgICAgICBpbnB1dE1vZGU6ICJyZWN1cnJpbmciLAogICAgICAgICAgcHJlc2V0czogUFJFU0VUUy5leHBlbnNlcywKICAgICAgICAgIG9uVXBkYXRlOiAoaWQsIHUpID0+IHVwZGF0ZUl0ZW0oImV4cGVuc2VzIiwgaWQsIHUpLAogICAgICAgICAgb25BZGQ6ICgpID0+IGFkZEl0ZW0oImV4cGVuc2VzIiwgIm1vbnRobHkiKSwKICAgICAgICAgIG9uQWRkUHJlc2V0OiAobmFtZSkgPT4gYWRkUHJlc2V0SXRlbSgiZXhwZW5zZXMiLCBuYW1lLCAibW9udGhseSIpLAogICAgICAgICAgb25EZWxldGU6IChpZCkgPT4gZGVsZXRlSXRlbSgiZXhwZW5zZXMiLCBpZCksCiAgICAgICAgICBvblJlb3JkZXI6IChmcm9tMiwgdG8yKSA9PiByZW9yZGVySXRlbXMoImV4cGVuc2VzIiwgZnJvbTIsIHRvMikKICAgICAgICB9CiAgICAgICksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgQnVkZ2V0U2VjdGlvbiwKICAgICAgICB7CiAgICAgICAgICB0aXRsZTogIkFzc2V0cyIsCiAgICAgICAgICBpY29uOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFdhbGxldCwgeyBzaXplOiAxOCB9KSwKICAgICAgICAgIGNvbG9yOiBDT0xPUlMuYXNzZXQsCiAgICAgICAgICBiZ0NvbG9yOiBDT0xPUlMuYXNzZXRCZywKICAgICAgICAgIGl0ZW1zOiBidWRnZXQuYXNzZXRzLAogICAgICAgICAgaW5wdXRNb2RlOiAiYXNzZXQiLAogICAgICAgICAgcHJlc2V0czogUFJFU0VUUy5hc3NldHMsCiAgICAgICAgICBvblVwZGF0ZTogKGlkLCB1KSA9PiB1cGRhdGVJdGVtKCJhc3NldHMiLCBpZCwgdSksCiAgICAgICAgICBvbkFkZDogKCkgPT4gYWRkSXRlbSgiYXNzZXRzIiwgIm9uZV90aW1lIiksCiAgICAgICAgICBvbkFkZFByZXNldDogKG5hbWUpID0+IGFkZFByZXNldEl0ZW0oImFzc2V0cyIsIG5hbWUsICJvbmVfdGltZSIpLAogICAgICAgICAgb25EZWxldGU6IChpZCkgPT4gZGVsZXRlSXRlbSgiYXNzZXRzIiwgaWQpLAogICAgICAgICAgb25SZW9yZGVyOiAoZnJvbTIsIHRvMikgPT4gcmVvcmRlckl0ZW1zKCJhc3NldHMiLCBmcm9tMiwgdG8yKQogICAgICAgIH0KICAgICAgKSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICBCdWRnZXRTZWN0aW9uLAogICAgICAgIHsKICAgICAgICAgIHRpdGxlOiAiTm9uLUxpcXVpZCBBc3NldHMiLAogICAgICAgICAgaWNvbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShCdWlsZGluZzIsIHsgc2l6ZTogMTggfSksCiAgICAgICAgICBjb2xvcjogQ09MT1JTLm5vbkxpcXVpZCwKICAgICAgICAgIGJnQ29sb3I6IENPTE9SUy5ub25MaXF1aWRCZywKICAgICAgICAgIGl0ZW1zOiBidWRnZXQubm9uTGlxdWlkQXNzZXRzLAogICAgICAgICAgaW5wdXRNb2RlOiAidmFsdWVfb25seSIsCiAgICAgICAgICBwcmVzZXRzOiBQUkVTRVRTLm5vbkxpcXVpZEFzc2V0cywKICAgICAgICAgIG9uVXBkYXRlOiAoaWQsIHUpID0+IHVwZGF0ZUl0ZW0oIm5vbkxpcXVpZEFzc2V0cyIsIGlkLCB1KSwKICAgICAgICAgIG9uQWRkOiAoKSA9PiBhZGRJdGVtKCJub25MaXF1aWRBc3NldHMiLCAib25lX3RpbWUiKSwKICAgICAgICAgIG9uQWRkUHJlc2V0OiAobmFtZSkgPT4gYWRkUHJlc2V0SXRlbSgibm9uTGlxdWlkQXNzZXRzIiwgbmFtZSwgIm9uZV90aW1lIiksCiAgICAgICAgICBvbkRlbGV0ZTogKGlkKSA9PiBkZWxldGVJdGVtKCJub25MaXF1aWRBc3NldHMiLCBpZCksCiAgICAgICAgICBvblJlb3JkZXI6IChmcm9tMiwgdG8yKSA9PiByZW9yZGVySXRlbXMoIm5vbkxpcXVpZEFzc2V0cyIsIGZyb20yLCB0bzIpLAogICAgICAgICAgZm9vdGVyOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLCBib3JkZXJSYWRpdXM6IDEwLCBwYWRkaW5nOiAiMTBweCAxMnB4IiwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlckxpZ2h0fWAsIG1hcmdpblRvcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBtYXJnaW5Cb3R0b206IDYgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiRGlzY291bnQgUmF0ZSIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTLm5vbkxpcXVpZCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgYnVkZ2V0Lm5vbkxpcXVpZERpc2NvdW50LAogICAgICAgICAgICAgICAgIiUiCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdHlwZTogInJhbmdlIiwKICAgICAgICAgICAgICAgIG1pbjogMCwKICAgICAgICAgICAgICAgIG1heDogNzUsCiAgICAgICAgICAgICAgICB2YWx1ZTogYnVkZ2V0Lm5vbkxpcXVpZERpc2NvdW50LAogICAgICAgICAgICAgICAgb25DaGFuZ2U6IChlKSA9PiBzZXRCdWRnZXQoKGIpID0+ICh7IC4uLmIsIG5vbkxpcXVpZERpc2NvdW50OiBwYXJzZUludChlLnRhcmdldC52YWx1ZSkgfSkpLAogICAgICAgICAgICAgICAgc3R5bGU6IHsgd2lkdGg6ICIxMDAlIiwgYWNjZW50Q29sb3I6IENPTE9SUy5ub25MaXF1aWQgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBmb250U2l6ZTogMTAsIGNvbG9yOiBDT0xPUlMudGV4dE11dGVkIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgY2hpbGRyZW46ICIwJSIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgic3BhbiIsIHsgY2hpbGRyZW46ICIyNSUiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInNwYW4iLCB7IGNoaWxkcmVuOiAiNTAlIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBjaGlsZHJlbjogIjc1JSIgfSkKICAgICAgICAgICAgXSB9KQogICAgICAgICAgXSB9KQogICAgICAgIH0KICAgICAgKSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICBCdWRnZXRTZWN0aW9uLAogICAgICAgIHsKICAgICAgICAgIHRpdGxlOiAiNDAxayAvIFJldGlyZW1lbnQiLAogICAgICAgICAgaWNvbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShMYW5kbWFyaywgeyBzaXplOiAxOCB9KSwKICAgICAgICAgIGNvbG9yOiBDT0xPUlMucmV0aXJlbWVudCwKICAgICAgICAgIGJnQ29sb3I6IENPTE9SUy5yZXRpcmVtZW50QmcsCiAgICAgICAgICBpdGVtczogYnVkZ2V0LnJldGlyZW1lbnQsCiAgICAgICAgICBpbnB1dE1vZGU6ICJ2YWx1ZV9vbmx5IiwKICAgICAgICAgIHByZXNldHM6IFBSRVNFVFMucmV0aXJlbWVudCwKICAgICAgICAgIG9uVXBkYXRlOiAoaWQsIHUpID0+IHVwZGF0ZUl0ZW0oInJldGlyZW1lbnQiLCBpZCwgdSksCiAgICAgICAgICBvbkFkZDogKCkgPT4gYWRkSXRlbSgicmV0aXJlbWVudCIsICJvbmVfdGltZSIpLAogICAgICAgICAgb25BZGRQcmVzZXQ6IChuYW1lKSA9PiBhZGRQcmVzZXRJdGVtKCJyZXRpcmVtZW50IiwgbmFtZSwgIm9uZV90aW1lIiksCiAgICAgICAgICBvbkRlbGV0ZTogKGlkKSA9PiBkZWxldGVJdGVtKCJyZXRpcmVtZW50IiwgaWQpLAogICAgICAgICAgb25SZW9yZGVyOiAoZnJvbTIsIHRvMikgPT4gcmVvcmRlckl0ZW1zKCJyZXRpcmVtZW50IiwgZnJvbTIsIHRvMikKICAgICAgICB9CiAgICAgICksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgQnVkZ2V0U2VjdGlvbiwKICAgICAgICB7CiAgICAgICAgICB0aXRsZTogIkxpYWJpbGl0aWVzIiwKICAgICAgICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoVHJpYW5nbGVBbGVydCwgeyBzaXplOiAxOCB9KSwKICAgICAgICAgIGNvbG9yOiBDT0xPUlMubGlhYmlsaXR5LAogICAgICAgICAgYmdDb2xvcjogQ09MT1JTLmxpYWJpbGl0eUJnLAogICAgICAgICAgaXRlbXM6IGJ1ZGdldC5saWFiaWxpdGllcywKICAgICAgICAgIGlucHV0TW9kZTogInJlY3VycmluZyIsCiAgICAgICAgICBwcmVzZXRzOiBQUkVTRVRTLmxpYWJpbGl0aWVzLAogICAgICAgICAgb25VcGRhdGU6IChpZCwgdSkgPT4gdXBkYXRlSXRlbSgibGlhYmlsaXRpZXMiLCBpZCwgdSksCiAgICAgICAgICBvbkFkZDogKCkgPT4gYWRkSXRlbSgibGlhYmlsaXRpZXMiLCAib25lX3RpbWUiKSwKICAgICAgICAgIG9uQWRkUHJlc2V0OiAobmFtZSkgPT4gYWRkUHJlc2V0SXRlbSgibGlhYmlsaXRpZXMiLCBuYW1lLCAib25lX3RpbWUiKSwKICAgICAgICAgIG9uRGVsZXRlOiAoaWQpID0+IGRlbGV0ZUl0ZW0oImxpYWJpbGl0aWVzIiwgaWQpLAogICAgICAgICAgb25SZW9yZGVyOiAoZnJvbTIsIHRvMikgPT4gcmVvcmRlckl0ZW1zKCJsaWFiaWxpdGllcyIsIGZyb20yLCB0bzIpCiAgICAgICAgfQogICAgICApLAogICAgICAoYnVkZ2V0LmluY29tZS5sZW5ndGggPiAwIHx8IGJ1ZGdldC5leHBlbnNlcy5sZW5ndGggPiAwIHx8IGJ1ZGdldC5hc3NldHMubGVuZ3RoID4gMCB8fCBidWRnZXQubGlhYmlsaXRpZXMubGVuZ3RoID4gMCkgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShTdW1tYXJ5U2VjdGlvbiwgeyBidWRnZXQgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBhZGRpbmc6ICIxNnB4IDAiLCBib3JkZXJUb3A6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyTGlnaHR9YCB9LCBjbGFzc05hbWU6ICJuby1wcmludCIsIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIHRleHRUcmFuc2Zvcm06ICJ1cHBlcmNhc2UiLCBsZXR0ZXJTcGFjaW5nOiAwLjUsIG1hcmdpbkJvdHRvbTogMTAgfSwgY2hpbGRyZW46ICJSZWxhdGVkIEFwcHMiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDEwLCBmbGV4V3JhcDogIndyYXAiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICB7IGVtb2ppOiAiXHUyNzAyXHVGRTBGIiwgYWNjZW50OiAiI0VGNDQ0NCIsIGFjY2VudEJnOiAiI0ZFRjJGMiIsIGxhYmVsOiAiSnVzdCBDYW5jZWwgSXQiLCBkZXNjOiAiQ2FuY2VsIHlvdXIgc3Vic2NyaXB0aW9ucyBmb3IgZnJlZSIgfSwKICAgICAgICAgIHsgZW1vamk6ICJcdXsxRjNENn1cdUZFMEYiLCBhY2NlbnQ6ICIjRjU5RTBCIiwgYWNjZW50Qmc6ICIjRkZGQkVCIiwgbGFiZWw6ICJSZXRpcmVtZW50IENhbGN1bGF0b3IiLCBkZXNjOiAiUGxhbiB5b3VyIHJldGlyZW1lbnQgd2l0aCBjb25maWRlbmNlIiB9LAogICAgICAgICAgeyBlbW9qaTogIlx1ezFGNENBfSIsIGFjY2VudDogIiM2MzY2RjEiLCBhY2NlbnRCZzogIiNFRUYyRkYiLCBsYWJlbDogIlBvcnRmb2xpbyBPcHRpbWl6ZXIiLCBkZXNjOiAiT3B0aW1pemUgeW91ciBpbnZlc3RtZW50IHBvcnRmb2xpbyIgfQogICAgICAgIF0ubWFwKChhcHAsIGkpID0+IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHRyYWNrRXZlbnQoInJlbGF0ZWRfYXBwX2NsaWNrIiwgeyBhcHA6IGFwcC5sYWJlbCB9KSwKICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICBmbGV4OiAiMSAxIDAiLAogICAgICAgICAgICAgIG1pbldpZHRoOiAxNDAsCiAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgIGZsZXhEaXJlY3Rpb246ICJjb2x1bW4iLAogICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgIGdhcDogOCwKICAgICAgICAgICAgICBwYWRkaW5nOiAiMTZweCAxMnB4IiwKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDE0LAogICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke2FwcC5hY2NlbnR9MjBgLAogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogYXBwLmFjY2VudEJnLAogICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgIHRleHRBbGlnbjogImNlbnRlciIsCiAgICAgICAgICAgICAgdHJhbnNpdGlvbjogInRyYW5zZm9ybSAwLjE1cywgYm94LXNoYWRvdyAwLjE1cyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb25Nb3VzZUVudGVyOiAoZSkgPT4gewogICAgICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS50cmFuc2Zvcm0gPSAidHJhbnNsYXRlWSgtMnB4KSI7CiAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJveFNoYWRvdyA9IGAwIDRweCAxMnB4ICR7YXBwLmFjY2VudH0yMGA7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uTW91c2VMZWF2ZTogKGUpID0+IHsKICAgICAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQuc3R5bGUudHJhbnNmb3JtID0gIiI7CiAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJveFNoYWRvdyA9ICIiOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6IDQ0LCBoZWlnaHQ6IDQ0LCBib3JkZXJSYWRpdXM6IDEyLCBiYWNrZ3JvdW5kOiBgbGluZWFyLWdyYWRpZW50KDEzNWRlZywgJHthcHAuYWNjZW50fTIwLCAke2FwcC5hY2NlbnR9MDgpYCwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLCBmb250U2l6ZTogMjIgfSwgY2hpbGRyZW46IGFwcC5lbW9qaSB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogYXBwLmxhYmVsIH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgbWFyZ2luVG9wOiAyIH0sIGNoaWxkcmVuOiBhcHAuZGVzYyB9KQogICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgXQogICAgICAgICAgfSwKICAgICAgICAgIGkKICAgICAgICApKSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgICAgIG1hcmdpblRvcDogMTYsCiAgICAgICAgcGFkZGluZzogIjE2cHggMCIsCiAgICAgICAgYm9yZGVyVG9wOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgZ2FwOiA4LAogICAgICAgIGZsZXhXcmFwOiAid3JhcCIKICAgICAgfSwgY2xhc3NOYW1lOiAibm8tcHJpbnQiLCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTRweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNjAwLCBjdXJzb3I6ICJwb2ludGVyIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA2IH0sCiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgICAgICB0cmFja0V2ZW50KCJzdWJzY3JpYmVfY2xpY2siKTsKICAgICAgICAgICAgICBzZXRTaG93U3Vic2NyaWJlTW9kYWwodHJ1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShNYWlsLCB7IHNpemU6IDE1IH0pLAogICAgICAgICAgICAgICIgU3Vic2NyaWJlIgogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogeyBwYWRkaW5nOiAiOHB4IDE0cHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNiB9LAogICAgICAgICAgICBvbkNsaWNrOiBoYW5kbGVSZXNldCwKICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFJvdGF0ZUNjdywgeyBzaXplOiAxNSB9KSwKICAgICAgICAgICAgICAiIFJlc2V0IgogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogeyBwYWRkaW5nOiAiOHB4IDE0cHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNiB9LAogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB0cmFja0V2ZW50KCJkb25hdGVfY2xpY2siKSwKICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKEhlYXJ0LCB7IHNpemU6IDE1IH0pLAogICAgICAgICAgICAgICIgRG9uYXRlIgogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogeyBwYWRkaW5nOiAiOHB4IDE0cHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNiB9LAogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgdHJhY2tFdmVudCgiZmVlZGJhY2tfY2xpY2siKTsKICAgICAgICAgICAgICBzZXRTaG93RmVlZGJhY2tNb2RhbCh0cnVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKE1lc3NhZ2VTcXVhcmUsIHsgc2l6ZTogMTUgfSksCiAgICAgICAgICAgICAgIiBGZWVkYmFjayIKICAgICAgICAgICAgXQogICAgICAgICAgfQogICAgICAgICksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNHB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSwgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIGN1cnNvcjogInBvaW50ZXIiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDYgfSwKICAgICAgICAgICAgb25DbGljazogKCkgPT4gewogICAgICAgICAgICAgIHRyYWNrRXZlbnQoInByaW50X2NsaWNrIik7CiAgICAgICAgICAgICAgd2luZG93LnByaW50KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShQcmludGVyLCB7IHNpemU6IDE1IH0pLAogICAgICAgICAgICAgICIgUHJpbnQiCiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICApCiAgICAgIF0gfSkKICAgIF0gfSksCiAgICBjb25maXJtRGlhbG9nICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICJkaXYiLAogICAgICB7CiAgICAgICAgc3R5bGU6IHsgcG9zaXRpb246ICJmaXhlZCIsIGluc2V0OiAwLCBiYWNrZ3JvdW5kQ29sb3I6ICJyZ2JhKDAsMCwwLDAuNCkiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIHpJbmRleDogMWUzIH0sCiAgICAgICAgb25DbGljazogKCkgPT4gc2V0Q29uZmlybURpYWxvZyhudWxsKSwKICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoCiAgICAgICAgICAiZGl2IiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuY2FyZCwgYm9yZGVyUmFkaXVzOiAxNiwgcGFkZGluZzogMjQsIG1heFdpZHRoOiAzNDAsIHdpZHRoOiAiOTAlIiwgYm94U2hhZG93OiAiMCA4cHggMzBweCByZ2JhKDAsMCwwLDAuMTUpIiB9LAogICAgICAgICAgICBvbkNsaWNrOiAoZSkgPT4gZS5zdG9wUHJvcGFnYXRpb24oKSwKICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTLnRleHRNYWluLCBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiBjb25maXJtRGlhbG9nLm1lc3NhZ2UgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDgsIGp1c3RpZnlDb250ZW50OiAiZmxleC1lbmQiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHNldENvbmZpcm1EaWFsb2cobnVsbCksIHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTZweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLCBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIGZvbnRTaXplOiAxMywgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIkNhbmNlbCIgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgY29uZmlybURpYWxvZy5vbkNvbmZpcm0oKTsKICAgICAgICAgICAgICAgICAgc2V0Q29uZmlybURpYWxvZyhudWxsKTsKICAgICAgICAgICAgICAgIH0sIHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTZweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmV4cGVuc2UsIGNvbG9yOiAid2hpdGUiLCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIgfSwgY2hpbGRyZW46ICJDb25maXJtIiB9KQogICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgXQogICAgICAgICAgfQogICAgICAgICkKICAgICAgfQogICAgKSwKICAgIHNob3dTdWJzY3JpYmVNb2RhbCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAiZGl2IiwKICAgICAgewogICAgICAgIHN0eWxlOiB7IHBvc2l0aW9uOiAiZml4ZWQiLCBpbnNldDogMCwgYmFja2dyb3VuZENvbG9yOiAicmdiYSgwLDAsMCwwLjQpIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLCB6SW5kZXg6IDFlMyB9LAogICAgICAgIG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgIHNldFNob3dTdWJzY3JpYmVNb2RhbChmYWxzZSk7CiAgICAgICAgICBzZXRTdWJzY3JpYmVFbWFpbCgiIik7CiAgICAgICAgICBzZXRTdWJzY3JpYmVTdGF0dXMoImlkbGUiKTsKICAgICAgICAgIHNldFN1YnNjcmliZU1lc3NhZ2UoIiIpOwogICAgICAgIH0sCiAgICAgICAgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgImRpdiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsIGJvcmRlclJhZGl1czogMTYsIHBhZGRpbmc6IDI0LCBtYXhXaWR0aDogMzgwLCB3aWR0aDogIjkwJSIsIGJveFNoYWRvdzogIjAgOHB4IDMwcHggcmdiYSgwLDAsMCwwLjE1KSIgfSwKICAgICAgICAgICAgb25DbGljazogKGUpID0+IGUuc3RvcFByb3BhZ2F0aW9uKCksCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgbWFyZ2luQm90dG9tOiAxNiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaDMiLCB7IHN0eWxlOiB7IG1hcmdpbjogMCwgZm9udFNpemU6IDE3LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46ICJTdWJzY3JpYmUgdG8gVXBkYXRlcyIgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgc2V0U2hvd1N1YnNjcmliZU1vZGFsKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgc2V0U3Vic2NyaWJlRW1haWwoIiIpOwogICAgICAgICAgICAgICAgICBzZXRTdWJzY3JpYmVTdGF0dXMoImlkbGUiKTsKICAgICAgICAgICAgICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZSgiIik7CiAgICAgICAgICAgICAgICB9LCBzdHlsZTogeyBwYWRkaW5nOiA0LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZDogIm5vbmUiLCBjdXJzb3I6ICJwb2ludGVyIiwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoWCwgeyBzaXplOiAxOCB9KSB9KQogICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgicCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnRleHRTZWNvbmRhcnksIG1hcmdpbjogIjAgMCAxMnB4IiB9LCBjaGlsZHJlbjogIkdldCBub3RpZmllZCBhYm91dCBuZXcgZmVhdHVyZXMgYW5kIHVwZGF0ZXMuIiB9KSwKICAgICAgICAgICAgICBzdWJzY3JpYmVTdGF0dXMgPT09ICJzdWNjZXNzIiA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogMTIsIGJvcmRlclJhZGl1czogOCwgYmFja2dyb3VuZENvbG9yOiBgJHtDT0xPUlMuaW5jb21lfTEwYCwgY29sb3I6IENPTE9SUy5pbmNvbWUsIGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNjAwLCB0ZXh0QWxpZ246ICJjZW50ZXIiIH0sIGNoaWxkcmVuOiBzdWJzY3JpYmVNZXNzYWdlIHx8ICJTdWJzY3JpYmVkISIgfSkgOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKShpbXBvcnRfanN4X3J1bnRpbWUuRnJhZ21lbnQsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoCiAgICAgICAgICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogc3Vic2NyaWJlRW1haWwsCiAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U6IChlKSA9PiBzZXRTdWJzY3JpYmVFbWFpbChlLnRhcmdldC52YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgb25LZXlEb3duOiAoZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgaWYgKGUua2V5ID09PSAiRW50ZXIiKSBoYW5kbGVTdWJzY3JpYmUoKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAieW91ckBlbWFpbC5jb20iLAogICAgICAgICAgICAgICAgICAgIGF1dG9Gb2N1czogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBzdHlsZTogeyB3aWR0aDogIjEwMCUiLCBwYWRkaW5nOiAiMTBweCAxMnB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIGZvbnRTaXplOiAxNCwgZm9udEZhbWlseTogImluaGVyaXQiLCBvdXRsaW5lOiAibm9uZSIsIGJveFNpemluZzogImJvcmRlci1ib3giLCBtYXJnaW5Cb3R0b206IDggfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgc3Vic2NyaWJlTWVzc2FnZSAmJiBzdWJzY3JpYmVTdGF0dXMgPT09ICJlcnJvciIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMuZXhwZW5zZSwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBzdWJzY3JpYmVNZXNzYWdlIH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBoYW5kbGVTdWJzY3JpYmUsIGRpc2FibGVkOiBzdWJzY3JpYmVTdGF0dXMgPT09ICJsb2FkaW5nIiwgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgd2lkdGg6ICIxMDAlIiwKICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjEwcHggMTZweCIsCiAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogOCwKICAgICAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTLnByaW1hcnksCiAgICAgICAgICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgICAgICAgICBmb250U2l6ZTogMTQsCiAgICAgICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgICAgICAgICAgICAgY3Vyc29yOiBzdWJzY3JpYmVTdGF0dXMgPT09ICJsb2FkaW5nIiA/ICJkZWZhdWx0IiA6ICJwb2ludGVyIiwKICAgICAgICAgICAgICAgICAgb3BhY2l0eTogc3Vic2NyaWJlU3RhdHVzID09PSAibG9hZGluZyIgPyAwLjcgOiAxCiAgICAgICAgICAgICAgICB9LCBjaGlsZHJlbjogc3Vic2NyaWJlU3RhdHVzID09PSAibG9hZGluZyIgPyAiU3Vic2NyaWJpbmcuLi4iIDogIlN1YnNjcmliZSIgfSkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICApCiAgICAgIH0KICAgICksCiAgICBzaG93RmVlZGJhY2tNb2RhbCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAiZGl2IiwKICAgICAgewogICAgICAgIHN0eWxlOiB7IHBvc2l0aW9uOiAiZml4ZWQiLCBpbnNldDogMCwgYmFja2dyb3VuZENvbG9yOiAicmdiYSgwLDAsMCwwLjQpIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLCB6SW5kZXg6IDFlMyB9LAogICAgICAgIG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgIHNldFNob3dGZWVkYmFja01vZGFsKGZhbHNlKTsKICAgICAgICAgIHNldEZlZWRiYWNrVGV4dCgiIik7CiAgICAgICAgICBzZXRGZWVkYmFja1N0YXR1cygiaWRsZSIpOwogICAgICAgIH0sCiAgICAgICAgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKAogICAgICAgICAgImRpdiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IGJhY2tncm91bmRDb2xvcjogQ09MT1JTLmNhcmQsIGJvcmRlclJhZGl1czogMTYsIHBhZGRpbmc6IDI0LCBtYXhXaWR0aDogMzgwLCB3aWR0aDogIjkwJSIsIGJveFNoYWRvdzogIjAgOHB4IDMwcHggcmdiYSgwLDAsMCwwLjE1KSIgfSwKICAgICAgICAgICAgb25DbGljazogKGUpID0+IGUuc3RvcFByb3BhZ2F0aW9uKCksCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgbWFyZ2luQm90dG9tOiAxMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiaDMiLCB7IHN0eWxlOiB7IG1hcmdpbjogMCwgZm9udFNpemU6IDE3LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMudGV4dE1haW4gfSwgY2hpbGRyZW46ICJTZW5kIEZlZWRiYWNrIiB9KSwKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gewogICAgICAgICAgICAgICAgICBzZXRTaG93RmVlZGJhY2tNb2RhbChmYWxzZSk7CiAgICAgICAgICAgICAgICAgIHNldEZlZWRiYWNrVGV4dCgiIik7CiAgICAgICAgICAgICAgICAgIHNldEZlZWRiYWNrU3RhdHVzKCJpZGxlIik7CiAgICAgICAgICAgICAgICB9LCBzdHlsZTogeyBwYWRkaW5nOiA0LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZDogIm5vbmUiLCBjdXJzb3I6ICJwb2ludGVyIiwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoWCwgeyBzaXplOiAxOCB9KSB9KQogICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgZW5qb3lWb3RlICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgICAgICAgICAgICBwYWRkaW5nOiAiOHB4IDEycHgiLAogICAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA4LAogICAgICAgICAgICAgICAgbWFyZ2luQm90dG9tOiAxMiwKICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogZW5qb3lWb3RlID09PSAidXAiID8gYCR7Q09MT1JTLmluY29tZX0xMGAgOiBgJHtDT0xPUlMuZXhwZW5zZX0xMGAsCiAgICAgICAgICAgICAgICBjb2xvcjogZW5qb3lWb3RlID09PSAidXAiID8gQ09MT1JTLmluY29tZSA6IENPTE9SUy5leHBlbnNlLAogICAgICAgICAgICAgICAgZm9udFNpemU6IDEzLAogICAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgICBnYXA6IDYKICAgICAgICAgICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgZW5qb3lWb3RlID09PSAidXAiID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShUaHVtYnNVcCwgeyBzaXplOiAxNCB9KSA6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoVGh1bWJzRG93biwgeyBzaXplOiAxNCB9KSwKICAgICAgICAgICAgICAgIGVuam95Vm90ZSA9PT0gInVwIiA/ICJHbGFkIHlvdSdyZSBlbmpveWluZyBpdCEiIDogIlNvcnJ5IHRvIGhlYXIgdGhhdC4iCiAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICBmZWVkYmFja1N0YXR1cyA9PT0gInN1Y2Nlc3MiID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAxMiwgYm9yZGVyUmFkaXVzOiA4LCBiYWNrZ3JvdW5kQ29sb3I6IGAke0NPTE9SUy5pbmNvbWV9MTBgLCBjb2xvcjogQ09MT1JTLmluY29tZSwgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIHRleHRBbGlnbjogImNlbnRlciIgfSwgY2hpbGRyZW46ICJUaGFuayB5b3UgZm9yIHlvdXIgZmVlZGJhY2shIiB9KSA6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKGltcG9ydF9qc3hfcnVudGltZS5GcmFnbWVudCwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAgICAgInRleHRhcmVhIiwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmZWVkYmFja1RleHQsCiAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U6IChlKSA9PiBzZXRGZWVkYmFja1RleHQoZS50YXJnZXQudmFsdWUpLAogICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiBlbmpveVZvdGUgPT09ICJ1cCIgPyAiV2hhdCBkbyB5b3UgbGlrZSBtb3N0PyBBbnkgZmVhdHVyZXMgeW91J2QgbG92ZSB0byBzZWU/IiA6IGVuam95Vm90ZSA9PT0gImRvd24iID8gIldoYXQgd2VudCB3cm9uZz8gSG93IGNhbiB3ZSBpbXByb3ZlPyIgOiAiV2hhdCBjYW4gd2UgaW1wcm92ZT8gQnVnIHJlcG9ydHMsIGZlYXR1cmUgcmVxdWVzdHMsIGFueXRoaW5nLi4uIiwKICAgICAgICAgICAgICAgICAgICBhdXRvRm9jdXM6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgcm93czogNCwKICAgICAgICAgICAgICAgICAgICBzdHlsZTogeyB3aWR0aDogIjEwMCUiLCBwYWRkaW5nOiAiMTBweCAxMnB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuYm9yZGVyfWAsIGZvbnRTaXplOiAxNCwgZm9udEZhbWlseTogImluaGVyaXQiLCBvdXRsaW5lOiAibm9uZSIsIGJveFNpemluZzogImJvcmRlci1ib3giLCBtYXJnaW5Cb3R0b206IDgsIHJlc2l6ZTogInZlcnRpY2FsIiB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICBmZWVkYmFja1N0YXR1cyA9PT0gImVycm9yIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgY29sb3I6IENPTE9SUy5leHBlbnNlLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46ICJGYWlsZWQgdG8gc2VuZC4gUGxlYXNlIHRyeSBhZ2Fpbi4iIH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBoYW5kbGVGZWVkYmFja1N1Ym1pdCwgZGlzYWJsZWQ6IGZlZWRiYWNrU3RhdHVzID09PSAic3VibWl0dGluZyIgfHwgIWZlZWRiYWNrVGV4dC50cmltKCksIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICIxMHB4IDE2cHgiLAogICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDgsCiAgICAgICAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5LAogICAgICAgICAgICAgICAgICBjb2xvcjogIndoaXRlIiwKICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDE0LAogICAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgICAgICAgIGN1cnNvcjogZmVlZGJhY2tTdGF0dXMgPT09ICJzdWJtaXR0aW5nIiB8fCAhZmVlZGJhY2tUZXh0LnRyaW0oKSA/ICJkZWZhdWx0IiA6ICJwb2ludGVyIiwKICAgICAgICAgICAgICAgICAgb3BhY2l0eTogZmVlZGJhY2tTdGF0dXMgPT09ICJzdWJtaXR0aW5nIiB8fCAhZmVlZGJhY2tUZXh0LnRyaW0oKSA/IDAuNyA6IDEKICAgICAgICAgICAgICAgIH0sIGNoaWxkcmVuOiBmZWVkYmFja1N0YXR1cyA9PT0gInN1Ym1pdHRpbmciID8gIlNlbmRpbmcuLi4iIDogIlN1Ym1pdCBGZWVkYmFjayIgfSkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICApCiAgICAgIH0KICAgICksCiAgICAhZW5qb3lWb3RlICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgcG9zaXRpb246ICJmaXhlZCIsIGJvdHRvbTogMjAsIHJpZ2h0OiBwaWxsUmlnaHQsIHpJbmRleDogOTAwLCBwb2ludGVyRXZlbnRzOiAibm9uZSIgfSwgY2xhc3NOYW1lOiAibm8tcHJpbnQiLCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgcG9pbnRlckV2ZW50czogImF1dG8iLAogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLAogICAgICBib3JkZXJSYWRpdXM6IDI0LAogICAgICBwYWRkaW5nOiAiMTBweCAxNnB4IiwKICAgICAgYm94U2hhZG93OiAiMCA0cHggMjBweCByZ2JhKDAsMCwwLDAuMTIpIiwKICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTLmJvcmRlcn1gLAogICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICBnYXA6IDEwCiAgICB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiB9LCBjaGlsZHJlbjogIkVuam95aW5nIHRoaXMgYXBwPyIgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gaGFuZGxlRW5qb3lWb3RlKCJ1cCIpLCBzdHlsZTogewogICAgICAgIHBhZGRpbmc6IDYsCiAgICAgICAgYm9yZGVyUmFkaXVzOiA4LAogICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgIGNvbG9yOiBDT0xPUlMuaW5jb21lCiAgICAgIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFRodW1ic1VwLCB7IHNpemU6IDE2IH0pIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IGhhbmRsZUVuam95Vm90ZSgiZG93biIpLCBzdHlsZTogewogICAgICAgIHBhZGRpbmc6IDYsCiAgICAgICAgYm9yZGVyUmFkaXVzOiA4LAogICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUy5ib3JkZXJ9YCwKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgIGNvbG9yOiBDT0xPUlMuZXhwZW5zZQogICAgICB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShUaHVtYnNEb3duLCB7IHNpemU6IDE2IH0pIH0pCiAgICBdIH0pIH0pCiAgXSB9KTsKfQoKLy8gc3JjL21haW4udHN4CnZhciBpbXBvcnRfanN4X3J1bnRpbWUyID0gX190b0VTTShyZXF1aXJlX2pzeF9ydW50aW1lKCksIDEpOwp2YXIgRXJyb3JCb3VuZGFyeSA9IGNsYXNzIGV4dGVuZHMgaW1wb3J0X3JlYWN0NTIuZGVmYXVsdC5Db21wb25lbnQgewogIGNvbnN0cnVjdG9yKHByb3BzKSB7CiAgICBzdXBlcihwcm9wcyk7CiAgICB0aGlzLnN0YXRlID0geyBoYXNFcnJvcjogZmFsc2UgfTsKICB9CiAgc3RhdGljIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcihlcnJvcikgewogICAgcmV0dXJuIHsgaGFzRXJyb3I6IHRydWUsIGVycm9yIH07CiAgfQogIGNvbXBvbmVudERpZENhdGNoKGVycm9yLCBlcnJvckluZm8pIHsKICAgIGNvbnNvbGUuZXJyb3IoIldpZGdldCBFcnJvciBCb3VuZGFyeSBjYXVnaHQgZXJyb3I6IiwgZXJyb3IsIGVycm9ySW5mbyk7CiAgICB0cnkgewogICAgICBmZXRjaCgiL2FwaS90cmFjayIsIHsKICAgICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgICBoZWFkZXJzOiB7ICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIgfSwKICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICBldmVudDogImNyYXNoIiwKICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgZXJyb3I6IGVycm9yPy5tZXNzYWdlIHx8ICJVbmtub3duIGVycm9yIiwKICAgICAgICAgICAgc3RhY2s6IGVycm9yPy5zdGFjaywKICAgICAgICAgICAgY29tcG9uZW50U3RhY2s6IGVycm9ySW5mbz8uY29tcG9uZW50U3RhY2sKICAgICAgICAgIH0KICAgICAgICB9KQogICAgICB9KS5jYXRjaCgoZSkgPT4gY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIHJlcG9ydCBjcmFzaCIsIGUpKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgIH0KICB9CiAgcmVuZGVyKCkgewogICAgaWYgKHRoaXMuc3RhdGUuaGFzRXJyb3IpIHsKICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAyMCwgdGV4dEFsaWduOiAiY2VudGVyIiwgZm9udEZhbWlseTogInNhbnMtc2VyaWYiLCBjb2xvcjogIiNEQzI2MjYiLCB3b3JkQnJlYWs6ICJicmVhay13b3JkIiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJoMyIsIHsgY2hpbGRyZW46ICJTb21ldGhpbmcgd2VudCB3cm9uZy4iIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJwIiwgeyBjaGlsZHJlbjogIlBsZWFzZSB0cnkgcmVmcmVzaGluZyB0aGUgcGFnZS4iIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGV0YWlscyIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiAxMCwgdGV4dEFsaWduOiAibGVmdCIsIGZvbnRTaXplOiAiMTJweCIsIGNvbG9yOiAiIzY2NiIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzdW1tYXJ5IiwgeyBjaGlsZHJlbjogIkRlYnVnIEVycm9yIERldGFpbHMiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJwcmUiLCB7IHN0eWxlOiB7IHdoaXRlU3BhY2U6ICJwcmUtd3JhcCIsIGJhY2tncm91bmQ6ICIjZjVmNWY1IiwgcGFkZGluZzogMTAsIGJvcmRlclJhZGl1czogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICB0aGlzLnN0YXRlLmVycm9yPy50b1N0cmluZygpLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnIiLCB7fSksCiAgICAgICAgICAgIHRoaXMuc3RhdGUuZXJyb3I/LnN0YWNrCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pOwogICAgfQogICAgcmV0dXJuIHRoaXMucHJvcHMuY2hpbGRyZW47CiAgfQp9Owp2YXIgZ2V0SHlkcmF0aW9uRGF0YSA9ICgpID0+IHsKICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gU3RhcnRpbmcgaHlkcmF0aW9uIGNoZWNrLi4uIik7CiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICJ1bmRlZmluZWQiKSB7CiAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gV2luZG93IGlzIHVuZGVmaW5lZCIpOwogICAgcmV0dXJuIHt9OwogIH0KICBjb25zdCBvYSA9IHdpbmRvdy5vcGVuYWk7CiAgaWYgKCFvYSkgewogICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIHdpbmRvdy5vcGVuYWkgbm90IGZvdW5kLCByZW5kZXJpbmcgd2l0aCBkZWZhdWx0cyIpOwogICAgcmV0dXJuIHt9OwogIH0KICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gd2luZG93Lm9wZW5haSBmb3VuZDoiLCBPYmplY3Qua2V5cyhvYSkpOwogIGNvbnN0IGNhbmRpZGF0ZXMgPSBbCiAgICBvYS50b29sT3V0cHV0LAogICAgb2Euc3RydWN0dXJlZENvbnRlbnQsCiAgICBvYS5yZXN1bHQ/LnN0cnVjdHVyZWRDb250ZW50LAogICAgb2EudG9vbElucHV0CiAgXTsKICBmb3IgKGNvbnN0IGNhbmRpZGF0ZSBvZiBjYW5kaWRhdGVzKSB7CiAgICBpZiAoY2FuZGlkYXRlICYmIHR5cGVvZiBjYW5kaWRhdGUgPT09ICJvYmplY3QiICYmIE9iamVjdC5rZXlzKGNhbmRpZGF0ZSkubGVuZ3RoID4gMCkgewogICAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gRm91bmQgZGF0YToiLCBjYW5kaWRhdGUpOwogICAgICByZXR1cm4gY2FuZGlkYXRlOwogICAgfQogIH0KICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gTm8gZGF0YSBmb3VuZCBpbiBhbnkgY2FuZGlkYXRlIHNvdXJjZSIpOwogIHJldHVybiB7fTsKfTsKY29uc29sZS5sb2coIltNYWluXSBNeSBCdWRnZXQgbWFpbi50c3ggbG9hZGluZy4uLiIpOwpmdW5jdGlvbiBBcHAoeyBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyIH0pIHsKICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoTXlCdWRnZXQsIHsgaW5pdGlhbERhdGE6IGluaXRpYWxEYXRhMiB9KTsKfQp2YXIgY29udGFpbmVyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm15LWJ1ZGdldC1yb290Iik7CmlmICghY29udGFpbmVyKSB7CiAgdGhyb3cgbmV3IEVycm9yKCJteS1idWRnZXQtcm9vdCBlbGVtZW50IG5vdCBmb3VuZCIpOwp9CnZhciByb290ID0gKDAsIGltcG9ydF9jbGllbnQuY3JlYXRlUm9vdCkoY29udGFpbmVyKTsKdmFyIHJlbmRlckFwcCA9IChkYXRhKSA9PiB7CiAgcm9vdC5yZW5kZXIoCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShpbXBvcnRfcmVhY3Q1Mi5kZWZhdWx0LlN0cmljdE1vZGUsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKEVycm9yQm91bmRhcnksIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKEFwcCwgeyBpbml0aWFsRGF0YTogZGF0YSB9LCBEYXRlLm5vdygpKSB9KSB9KQogICk7Cn07CnZhciBpbml0aWFsRGF0YSA9IGdldEh5ZHJhdGlvbkRhdGEoKTsKcmVuZGVyQXBwKGluaXRpYWxEYXRhKTsKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIm9wZW5haTpzZXRfZ2xvYmFscyIsIChldikgPT4gewogIGNvbnN0IGdsb2JhbHMgPSBldj8uZGV0YWlsPy5nbG9iYWxzOwogIGlmIChnbG9iYWxzKSB7CiAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gTGF0ZSBldmVudCByZWNlaXZlZDoiLCBnbG9iYWxzKTsKICAgIGNvbnN0IGNhbmRpZGF0ZXMgPSBbCiAgICAgIGdsb2JhbHMudG9vbE91dHB1dCwKICAgICAgZ2xvYmFscy5zdHJ1Y3R1cmVkQ29udGVudCwKICAgICAgZ2xvYmFscy5yZXN1bHQ/LnN0cnVjdHVyZWRDb250ZW50LAogICAgICBnbG9iYWxzLnRvb2xJbnB1dAogICAgXTsKICAgIGZvciAoY29uc3QgY2FuZGlkYXRlIG9mIGNhbmRpZGF0ZXMpIHsKICAgICAgaWYgKGNhbmRpZGF0ZSAmJiB0eXBlb2YgY2FuZGlkYXRlID09PSAib2JqZWN0IiAmJiBPYmplY3Qua2V5cyhjYW5kaWRhdGUpLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gUmUtcmVuZGVyaW5nIHdpdGggbGF0ZSBkYXRhOiIsIGNhbmRpZGF0ZSk7CiAgICAgICAgcmVuZGVyQXBwKGNhbmRpZGF0ZSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgfQp9KTsKd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoCiAgIm1lc3NhZ2UiLAogIChldmVudCkgPT4gewogICAgaWYgKGV2ZW50LnNvdXJjZSAhPT0gd2luZG93LnBhcmVudCkgcmV0dXJuOwogICAgY29uc3QgbWVzc2FnZSA9IGV2ZW50LmRhdGE7CiAgICBpZiAoIW1lc3NhZ2UgfHwgbWVzc2FnZS5qc29ucnBjICE9PSAiMi4wIikgcmV0dXJuOwogICAgaWYgKG1lc3NhZ2UubWV0aG9kICE9PSAidWkvbm90aWZpY2F0aW9ucy90b29sLXJlc3VsdCIpIHJldHVybjsKICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBNQ1AgQXBwcyBicmlkZ2UgdG9vbC1yZXN1bHQgcmVjZWl2ZWQ6IiwgbWVzc2FnZS5wYXJhbXMpOwogICAgY29uc3QgdG9vbFJlc3VsdCA9IG1lc3NhZ2UucGFyYW1zOwogICAgY29uc3QgZGF0YSA9IHRvb2xSZXN1bHQ/LnN0cnVjdHVyZWRDb250ZW50ID8/IHRvb2xSZXN1bHQ/LnJlc3VsdD8uc3RydWN0dXJlZENvbnRlbnQgPz8ge307CiAgICBpZiAoZGF0YSAmJiB0eXBlb2YgZGF0YSA9PT0gIm9iamVjdCIgJiYgT2JqZWN0LmtleXMoZGF0YSkubGVuZ3RoID4gMCkgewogICAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gUmUtcmVuZGVyaW5nIHdpdGggTUNQIEFwcHMgYnJpZGdlIGRhdGE6IiwgZGF0YSk7CiAgICAgIHJlbmRlckFwcChkYXRhKTsKICAgIH0KICB9LAogIHsgcGFzc2l2ZTogdHJ1ZSB9Cik7Ci8qISBCdW5kbGVkIGxpY2Vuc2UgaW5mb3JtYXRpb246CgpyZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiByZWFjdC5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpzY2hlZHVsZXIvY2pzL3NjaGVkdWxlci5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHNjaGVkdWxlci5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpyZWFjdC1kb20vY2pzL3JlYWN0LWRvbS5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LWRvbS5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCiAgKCoqCiAgICogQ2hlY2tzIGlmIGFuIGV2ZW50IGlzIHN1cHBvcnRlZCBpbiB0aGUgY3VycmVudCBleGVjdXRpb24gZW52aXJvbm1lbnQuCiAgICoKICAgKiBOT1RFOiBUaGlzIHdpbGwgbm90IHdvcmsgY29ycmVjdGx5IGZvciBub24tZ2VuZXJpYyBldmVudHMgc3VjaCBhcyBgY2hhbmdlYCwKICAgKiBgcmVzZXRgLCBgbG9hZGAsIGBlcnJvcmAsIGFuZCBgc2VsZWN0YC4KICAgKgogICAqIEJvcnJvd3MgZnJvbSBNb2Rlcm5penIuCiAgICoKICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnROYW1lU3VmZml4IEV2ZW50IG5hbWUsIGUuZy4gImNsaWNrIi4KICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBldmVudCBpcyBzdXBwb3J0ZWQuCiAgICogQGludGVybmFsCiAgICogQGxpY2Vuc2UgTW9kZXJuaXpyIDMuMC4wcHJlIChDdXN0b20gQnVpbGQpIHwgTUlUCiAgICopCgp1c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHVzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0uZGV2ZWxvcG1lbnQuanMKICAgKgogICAqIENvcHlyaWdodCAoYykgTWV0YSBQbGF0Zm9ybXMsIEluYy4gYW5kIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgp1c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS93aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS93aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIE1ldGEgUGxhdGZvcm1zLCBJbmMuIGFuZCBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKZGVjaW1hbC5qcy1saWdodC9kZWNpbWFsLmpzOgogICgqISBkZWNpbWFsLmpzLWxpZ2h0IHYyLjUuMSBodHRwczovL2dpdGh1Yi5jb20vTWlrZU1jbC9kZWNpbWFsLmpzLWxpZ2h0L0xJQ0VOQ0UgKikKCnVzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS13aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBNZXRhIFBsYXRmb3JtcywgSW5jLiBhbmQgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnJlYWN0L2Nqcy9yZWFjdC1qc3gtcnVudGltZS5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9zaGFyZWQvc3JjL3V0aWxzLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vZGVmYXVsdEF0dHJpYnV0ZXMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9JY29uLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2Fycm93LXVwLXJpZ2h0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYnVpbGRpbmctMi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2NoYXJ0LWNvbHVtbi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2NoZWNrLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hldnJvbi1kb3duLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hldnJvbi11cC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2Nsb2NrLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvZG9sbGFyLXNpZ24uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9ncmlwLXZlcnRpY2FsLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvaGVhcnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9ob3VzZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2xhbmRtYXJrLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbG9hZGVyLWNpcmNsZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL21haWwuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9tZXNzYWdlLXNxdWFyZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3Blbi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3BpZ2d5LWJhbmsuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wbHVzLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcHJpbnRlci5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3JlZnJlc2gtY3cuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9yb3RhdGUtY2N3LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvc2F2ZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3NlYXJjaC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RodW1icy1kb3duLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdGh1bWJzLXVwLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdHJhc2gtMi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RyZW5kaW5nLWRvd24uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90cmVuZGluZy11cC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RyaWFuZ2xlLWFsZXJ0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvd2FsbGV0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMveC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2x1Y2lkZS1yZWFjdC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoqLwo=";
      const decodedScript = atob(encodedScript);
      const blob = new Blob([decodedScript], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      import(url)
        .catch(err => {
          console.error('[My Budget] Failed to load:', err);
          const root = document.getElementById('my-budget-root');
          if (root) {
            root.innerHTML = '<div style="padding:20px;text-align:center;font-family:sans-serif;color:#DC2626"><h3>Failed to load budget</h3><p>Please refresh the page.</p></div>';
          }
        });
    </script>
  </body>
</html>
