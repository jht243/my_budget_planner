<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Budget â€” Personal Budget Tool</title>
    <meta name="description" content="An interactive personal budget tool. Track income, expenses, and savings goals." />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #FAFAFA;
        color: #1A1A1A;
        -webkit-font-smoothing: antialiased;
      }
      #my-budget-root {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        box-sizing: border-box;
      }
      #my-budget-root > * {
        width: 100%;
        max-width: 100%;
      }
      @media print {
        .no-print { display: none !important; }
        body { background: white; }
      }
    </style>
  </head>
  <body>
    <div id="my-budget-root"></div>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <script type="module">
      // Decode and execute the base64-encoded React bundle
      const encodedScript = "dmFyIF9fY3JlYXRlID0gT2JqZWN0LmNyZWF0ZTsKdmFyIF9fZGVmUHJvcCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKdmFyIF9fZ2V0T3duUHJvcERlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOwp2YXIgX19nZXRPd25Qcm9wTmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lczsKdmFyIF9fZ2V0UHJvdG9PZiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZjsKdmFyIF9faGFzT3duUHJvcCA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CnZhciBfX2NvbW1vbkpTID0gKGNiLCBtb2QpID0+IGZ1bmN0aW9uIF9fcmVxdWlyZSgpIHsKICByZXR1cm4gbW9kIHx8ICgwLCBjYltfX2dldE93blByb3BOYW1lcyhjYilbMF1dKSgobW9kID0geyBleHBvcnRzOiB7fSB9KS5leHBvcnRzLCBtb2QpLCBtb2QuZXhwb3J0czsKfTsKdmFyIF9fZXhwb3J0ID0gKHRhcmdldCwgYWxsKSA9PiB7CiAgZm9yICh2YXIgbmFtZSBpbiBhbGwpCiAgICBfX2RlZlByb3AodGFyZ2V0LCBuYW1lLCB7IGdldDogYWxsW25hbWVdLCBlbnVtZXJhYmxlOiB0cnVlIH0pOwp9Owp2YXIgX19jb3B5UHJvcHMgPSAodG8yLCBmcm9tMiwgZXhjZXB0LCBkZXNjKSA9PiB7CiAgaWYgKGZyb20yICYmIHR5cGVvZiBmcm9tMiA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIGZyb20yID09PSAiZnVuY3Rpb24iKSB7CiAgICBmb3IgKGxldCBrZXkgb2YgX19nZXRPd25Qcm9wTmFtZXMoZnJvbTIpKQogICAgICBpZiAoIV9faGFzT3duUHJvcC5jYWxsKHRvMiwga2V5KSAmJiBrZXkgIT09IGV4Y2VwdCkKICAgICAgICBfX2RlZlByb3AodG8yLCBrZXksIHsgZ2V0OiAoKSA9PiBmcm9tMltrZXldLCBlbnVtZXJhYmxlOiAhKGRlc2MgPSBfX2dldE93blByb3BEZXNjKGZyb20yLCBrZXkpKSB8fCBkZXNjLmVudW1lcmFibGUgfSk7CiAgfQogIHJldHVybiB0bzI7Cn07CnZhciBfX3RvRVNNID0gKG1vZCwgaXNOb2RlTW9kZSwgdGFyZ2V0KSA9PiAodGFyZ2V0ID0gbW9kICE9IG51bGwgPyBfX2NyZWF0ZShfX2dldFByb3RvT2YobW9kKSkgOiB7fSwgX19jb3B5UHJvcHMoCiAgLy8gSWYgdGhlIGltcG9ydGVyIGlzIGluIG5vZGUgY29tcGF0aWJpbGl0eSBtb2RlIG9yIHRoaXMgaXMgbm90IGFuIEVTTQogIC8vIGZpbGUgdGhhdCBoYXMgYmVlbiBjb252ZXJ0ZWQgdG8gYSBDb21tb25KUyBmaWxlIHVzaW5nIGEgQmFiZWwtCiAgLy8gY29tcGF0aWJsZSB0cmFuc2Zvcm0gKGkuZS4gIl9fZXNNb2R1bGUiIGhhcyBub3QgYmVlbiBzZXQpLCB0aGVuIHNldAogIC8vICJkZWZhdWx0IiB0byB0aGUgQ29tbW9uSlMgIm1vZHVsZS5leHBvcnRzIiBmb3Igbm9kZSBjb21wYXRpYmlsaXR5LgogIGlzTm9kZU1vZGUgfHwgIW1vZCB8fCAhbW9kLl9fZXNNb2R1bGUgPyBfX2RlZlByb3AodGFyZ2V0LCAiZGVmYXVsdCIsIHsgdmFsdWU6IG1vZCwgZW51bWVyYWJsZTogdHJ1ZSB9KSA6IHRhcmdldCwKICBtb2QKKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9yZWFjdC9janMvcmVhY3QuZGV2ZWxvcG1lbnQuanMKdmFyIHJlcXVpcmVfcmVhY3RfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LmRldmVsb3BtZW50LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmICh0cnVlKSB7CiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0KG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0VmVyc2lvbiA9ICIxOC4zLjEiOwogICAgICAgIHZhciBSRUFDVF9FTEVNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5lbGVtZW50Iik7CiAgICAgICAgdmFyIFJFQUNUX1BPUlRBTF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucG9ydGFsIik7CiAgICAgICAgdmFyIFJFQUNUX0ZSQUdNRU5UX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5mcmFnbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9TVFJJQ1RfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3Quc3RyaWN0X21vZGUiKTsKICAgICAgICB2YXIgUkVBQ1RfUFJPRklMRVJfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnByb2ZpbGVyIik7CiAgICAgICAgdmFyIFJFQUNUX1BST1ZJREVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm92aWRlciIpOwogICAgICAgIHZhciBSRUFDVF9DT05URVhUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jb250ZXh0Iik7CiAgICAgICAgdmFyIFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyID0gU3ltYm9sLmZvcigicmVhY3QuZm9yd2FyZF9yZWYiKTsKICAgICAgICB2YXIgUkVBQ1RfU1VTUEVOU0VfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN1c3BlbnNlX2xpc3QiKTsKICAgICAgICB2YXIgUkVBQ1RfTUVNT19UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0Lm1lbW8iKTsKICAgICAgICB2YXIgUkVBQ1RfTEFaWV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QubGF6eSIpOwogICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgIHZhciBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgPSBTeW1ib2wuaXRlcmF0b3I7CiAgICAgICAgdmFyIEZBVVhfSVRFUkFUT1JfU1lNQk9MID0gIkBAaXRlcmF0b3IiOwogICAgICAgIGZ1bmN0aW9uIGdldEl0ZXJhdG9yRm4obWF5YmVJdGVyYWJsZSkgewogICAgICAgICAgaWYgKG1heWJlSXRlcmFibGUgPT09IG51bGwgfHwgdHlwZW9mIG1heWJlSXRlcmFibGUgIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1heWJlSXRlcmF0b3IgPSBNQVlCRV9JVEVSQVRPUl9TWU1CT0wgJiYgbWF5YmVJdGVyYWJsZVtNQVlCRV9JVEVSQVRPUl9TWU1CT0xdIHx8IG1heWJlSXRlcmFibGVbRkFVWF9JVEVSQVRPUl9TWU1CT0xdOwogICAgICAgICAgaWYgKHR5cGVvZiBtYXliZUl0ZXJhdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiBtYXliZUl0ZXJhdG9yOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyID0gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqIEB0eXBlIHtSZWFjdENvbXBvbmVudH0KICAgICAgICAgICAqLwogICAgICAgICAgY3VycmVudDogbnVsbAogICAgICAgIH07CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnID0gewogICAgICAgICAgdHJhbnNpdGlvbjogbnVsbAogICAgICAgIH07CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEFjdFF1ZXVlID0gewogICAgICAgICAgY3VycmVudDogbnVsbCwKICAgICAgICAgIC8vIFVzZWQgdG8gcmVwcm9kdWNlIGJlaGF2aW9yIG9mIGBiYXRjaGVkVXBkYXRlc2AgaW4gbGVnYWN5IG1vZGUuCiAgICAgICAgICBpc0JhdGNoaW5nTGVnYWN5OiBmYWxzZSwKICAgICAgICAgIGRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlOiBmYWxzZQogICAgICAgIH07CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyID0gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqIEB0eXBlIHtSZWFjdENvbXBvbmVudH0KICAgICAgICAgICAqLwogICAgICAgICAgY3VycmVudDogbnVsbAogICAgICAgIH07CiAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUgPSB7fTsKICAgICAgICB2YXIgY3VycmVudEV4dHJhU3RhY2tGcmFtZSA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRFeHRyYVN0YWNrRnJhbWUgPSBzdGFjazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgewogICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5zZXRFeHRyYVN0YWNrRnJhbWUgPSBmdW5jdGlvbihzdGFjaykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgY3VycmVudEV4dHJhU3RhY2tGcmFtZSA9IHN0YWNrOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5nZXRDdXJyZW50U3RhY2sgPSBudWxsOwogICAgICAgICAgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZS5nZXRTdGFja0FkZGVuZHVtID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBzdGFjayA9ICIiOwogICAgICAgICAgICBpZiAoY3VycmVudEV4dHJhU3RhY2tGcmFtZSkgewogICAgICAgICAgICAgIHN0YWNrICs9IGN1cnJlbnRFeHRyYVN0YWNrRnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGltcGwgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjazsKICAgICAgICAgICAgaWYgKGltcGwpIHsKICAgICAgICAgICAgICBzdGFjayArPSBpbXBsKCkgfHwgIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0YWNrOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIGVuYWJsZVNjb3BlQVBJID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUNhY2hlRWxlbWVudCA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVUcmFuc2l0aW9uVHJhY2luZyA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMZWdhY3lIaWRkZW4gPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlRGVidWdUcmFjaW5nID0gZmFsc2U7CiAgICAgICAgdmFyIFJlYWN0U2hhcmVkSW50ZXJuYWxzID0gewogICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciwKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLAogICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIKICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWUgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgICAgUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QWN0UXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybjMoZm9ybWF0MikgewogICAgICAgICAgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygid2FybiIsIGZvcm1hdDIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiA+IDEgPyBfbGVuMiAtIDEgOiAwKSwgX2tleTIgPSAxOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoImVycm9yIiwgZm9ybWF0MiwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJpbnRXYXJuaW5nKGxldmVsLCBmb3JtYXQyLCBhcmdzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICAgIHZhciBzdGFjayA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUyLmdldFN0YWNrQWRkZW5kdW0oKTsKICAgICAgICAgICAgaWYgKHN0YWNrICE9PSAiIikgewogICAgICAgICAgICAgIGZvcm1hdDIgKz0gIiVzIjsKICAgICAgICAgICAgICBhcmdzID0gYXJncy5jb25jYXQoW3N0YWNrXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3NXaXRoRm9ybWF0ID0gYXJncy5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgIHJldHVybiBTdHJpbmcoaXRlbSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhcmdzV2l0aEZvcm1hdC51bnNoaWZ0KCJXYXJuaW5nOiAiICsgZm9ybWF0Mik7CiAgICAgICAgICAgIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKGNvbnNvbGVbbGV2ZWxdLCBjb25zb2xlLCBhcmdzV2l0aEZvcm1hdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuU3RhdGVVcGRhdGVGb3JVbm1vdW50ZWRDb21wb25lbnQgPSB7fTsKICAgICAgICBmdW5jdGlvbiB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgY2FsbGVyTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgX2NvbnN0cnVjdG9yID0gcHVibGljSW5zdGFuY2UuY29uc3RydWN0b3I7CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gX2NvbnN0cnVjdG9yICYmIChfY29uc3RydWN0b3IuZGlzcGxheU5hbWUgfHwgX2NvbnN0cnVjdG9yLm5hbWUpIHx8ICJSZWFjdENsYXNzIjsKICAgICAgICAgICAgdmFyIHdhcm5pbmdLZXkgPSBjb21wb25lbnROYW1lICsgIi4iICsgY2FsbGVyTmFtZTsKICAgICAgICAgICAgaWYgKGRpZFdhcm5TdGF0ZVVwZGF0ZUZvclVubW91bnRlZENvbXBvbmVudFt3YXJuaW5nS2V5XSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlcnJvcigiQ2FuJ3QgY2FsbCAlcyBvbiBhIGNvbXBvbmVudCB0aGF0IGlzIG5vdCB5ZXQgbW91bnRlZC4gVGhpcyBpcyBhIG5vLW9wLCBidXQgaXQgbWlnaHQgaW5kaWNhdGUgYSBidWcgaW4geW91ciBhcHBsaWNhdGlvbi4gSW5zdGVhZCwgYXNzaWduIHRvIGB0aGlzLnN0YXRlYCBkaXJlY3RseSBvciBkZWZpbmUgYSBgc3RhdGUgPSB7fTtgIGNsYXNzIHByb3BlcnR5IHdpdGggdGhlIGRlc2lyZWQgc3RhdGUgaW4gdGhlICVzIGNvbXBvbmVudC4iLCBjYWxsZXJOYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yVW5tb3VudGVkQ29tcG9uZW50W3dhcm5pbmdLZXldID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Tm9vcFVwZGF0ZVF1ZXVlID0gewogICAgICAgICAgLyoqCiAgICAgICAgICAgKiBDaGVja3Mgd2hldGhlciBvciBub3QgdGhpcyBjb21wb3NpdGUgY29tcG9uZW50IGlzIG1vdW50ZWQuCiAgICAgICAgICAgKiBAcGFyYW0ge1JlYWN0Q2xhc3N9IHB1YmxpY0luc3RhbmNlIFRoZSBpbnN0YW5jZSB3ZSB3YW50IHRvIHRlc3QuCiAgICAgICAgICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIG1vdW50ZWQsIGZhbHNlIG90aGVyd2lzZS4KICAgICAgICAgICAqIEBwcm90ZWN0ZWQKICAgICAgICAgICAqIEBmaW5hbAogICAgICAgICAgICovCiAgICAgICAgICBpc01vdW50ZWQ6IGZ1bmN0aW9uKHB1YmxpY0luc3RhbmNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0sCiAgICAgICAgICAvKioKICAgICAgICAgICAqIEZvcmNlcyBhbiB1cGRhdGUuIFRoaXMgc2hvdWxkIG9ubHkgYmUgaW52b2tlZCB3aGVuIGl0IGlzIGtub3duIHdpdGgKICAgICAgICAgICAqIGNlcnRhaW50eSB0aGF0IHdlIGFyZSAqKm5vdCoqIGluIGEgRE9NIHRyYW5zYWN0aW9uLgogICAgICAgICAgICoKICAgICAgICAgICAqIFlvdSBtYXkgd2FudCB0byBjYWxsIHRoaXMgd2hlbiB5b3Uga25vdyB0aGF0IHNvbWUgZGVlcGVyIGFzcGVjdCBvZiB0aGUKICAgICAgICAgICAqIGNvbXBvbmVudCdzIHN0YXRlIGhhcyBjaGFuZ2VkIGJ1dCBgc2V0U3RhdGVgIHdhcyBub3QgY2FsbGVkLgogICAgICAgICAgICoKICAgICAgICAgICAqIFRoaXMgd2lsbCBub3QgaW52b2tlIGBzaG91bGRDb21wb25lbnRVcGRhdGVgLCBidXQgaXQgd2lsbCBpbnZva2UKICAgICAgICAgICAqIGBjb21wb25lbnRXaWxsVXBkYXRlYCBhbmQgYGNvbXBvbmVudERpZFVwZGF0ZWAuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2UgdGhhdCBzaG91bGQgcmVyZW5kZXIuCiAgICAgICAgICAgKiBAcGFyYW0gez9mdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGVkIGFmdGVyIGNvbXBvbmVudCBpcyB1cGRhdGVkLgogICAgICAgICAgICogQHBhcmFtIHs/c3RyaW5nfSBjYWxsZXJOYW1lIG5hbWUgb2YgdGhlIGNhbGxpbmcgZnVuY3Rpb24gaW4gdGhlIHB1YmxpYyBBUEkuCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqLwogICAgICAgICAgZW5xdWV1ZUZvcmNlVXBkYXRlOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSwgY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgICAgd2Fybk5vb3AocHVibGljSW5zdGFuY2UsICJmb3JjZVVwZGF0ZSIpOwogICAgICAgICAgfSwKICAgICAgICAgIC8qKgogICAgICAgICAgICogUmVwbGFjZXMgYWxsIG9mIHRoZSBzdGF0ZS4gQWx3YXlzIHVzZSB0aGlzIG9yIGBzZXRTdGF0ZWAgdG8gbXV0YXRlIHN0YXRlLgogICAgICAgICAgICogWW91IHNob3VsZCB0cmVhdCBgdGhpcy5zdGF0ZWAgYXMgaW1tdXRhYmxlLgogICAgICAgICAgICoKICAgICAgICAgICAqIFRoZXJlIGlzIG5vIGd1YXJhbnRlZSB0aGF0IGB0aGlzLnN0YXRlYCB3aWxsIGJlIGltbWVkaWF0ZWx5IHVwZGF0ZWQsIHNvCiAgICAgICAgICAgKiBhY2Nlc3NpbmcgYHRoaXMuc3RhdGVgIGFmdGVyIGNhbGxpbmcgdGhpcyBtZXRob2QgbWF5IHJldHVybiB0aGUgb2xkIHZhbHVlLgogICAgICAgICAgICoKICAgICAgICAgICAqIEBwYXJhbSB7UmVhY3RDbGFzc30gcHVibGljSW5zdGFuY2UgVGhlIGluc3RhbmNlIHRoYXQgc2hvdWxkIHJlcmVuZGVyLgogICAgICAgICAgICogQHBhcmFtIHtvYmplY3R9IGNvbXBsZXRlU3RhdGUgTmV4dCBzdGF0ZS4KICAgICAgICAgICAqIEBwYXJhbSB7P2Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsZWQgYWZ0ZXIgY29tcG9uZW50IGlzIHVwZGF0ZWQuCiAgICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IGNhbGxlck5hbWUgbmFtZSBvZiB0aGUgY2FsbGluZyBmdW5jdGlvbiBpbiB0aGUgcHVibGljIEFQSS4KICAgICAgICAgICAqIEBpbnRlcm5hbAogICAgICAgICAgICovCiAgICAgICAgICBlbnF1ZXVlUmVwbGFjZVN0YXRlOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSwgY29tcGxldGVTdGF0ZSwgY2FsbGJhY2ssIGNhbGxlck5hbWUpIHsKICAgICAgICAgICAgd2Fybk5vb3AocHVibGljSW5zdGFuY2UsICJyZXBsYWNlU3RhdGUiKTsKICAgICAgICAgIH0sCiAgICAgICAgICAvKioKICAgICAgICAgICAqIFNldHMgYSBzdWJzZXQgb2YgdGhlIHN0YXRlLiBUaGlzIG9ubHkgZXhpc3RzIGJlY2F1c2UgX3BlbmRpbmdTdGF0ZSBpcwogICAgICAgICAgICogaW50ZXJuYWwuIFRoaXMgcHJvdmlkZXMgYSBtZXJnaW5nIHN0cmF0ZWd5IHRoYXQgaXMgbm90IGF2YWlsYWJsZSB0byBkZWVwCiAgICAgICAgICAgKiBwcm9wZXJ0aWVzIHdoaWNoIGlzIGNvbmZ1c2luZy4gVE9ETzogRXhwb3NlIHBlbmRpbmdTdGF0ZSBvciBkb24ndCB1c2UgaXQKICAgICAgICAgICAqIGR1cmluZyB0aGUgbWVyZ2UuCiAgICAgICAgICAgKgogICAgICAgICAgICogQHBhcmFtIHtSZWFjdENsYXNzfSBwdWJsaWNJbnN0YW5jZSBUaGUgaW5zdGFuY2UgdGhhdCBzaG91bGQgcmVyZW5kZXIuCiAgICAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gcGFydGlhbFN0YXRlIE5leHQgcGFydGlhbCBzdGF0ZSB0byBiZSBtZXJnZWQgd2l0aCBzdGF0ZS4KICAgICAgICAgICAqIEBwYXJhbSB7P2Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsZWQgYWZ0ZXIgY29tcG9uZW50IGlzIHVwZGF0ZWQuCiAgICAgICAgICAgKiBAcGFyYW0gez9zdHJpbmd9IE5hbWUgb2YgdGhlIGNhbGxpbmcgZnVuY3Rpb24gaW4gdGhlIHB1YmxpYyBBUEkuCiAgICAgICAgICAgKiBAaW50ZXJuYWwKICAgICAgICAgICAqLwogICAgICAgICAgZW5xdWV1ZVNldFN0YXRlOiBmdW5jdGlvbihwdWJsaWNJbnN0YW5jZSwgcGFydGlhbFN0YXRlLCBjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgICB3YXJuTm9vcChwdWJsaWNJbnN0YW5jZSwgInNldFN0YXRlIik7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB2YXIgYXNzaWduMiA9IE9iamVjdC5hc3NpZ247CiAgICAgICAgdmFyIGVtcHR5T2JqZWN0ID0ge307CiAgICAgICAgewogICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbXB0eU9iamVjdCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIENvbXBvbmVudChwcm9wcywgY29udGV4dCwgdXBkYXRlcikgewogICAgICAgICAgdGhpcy5wcm9wcyA9IHByb3BzOwogICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIHRoaXMucmVmcyA9IGVtcHR5T2JqZWN0OwogICAgICAgICAgdGhpcy51cGRhdGVyID0gdXBkYXRlciB8fCBSZWFjdE5vb3BVcGRhdGVRdWV1ZTsKICAgICAgICB9CiAgICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50ID0ge307CiAgICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5zZXRTdGF0ZSA9IGZ1bmN0aW9uKHBhcnRpYWxTdGF0ZSwgY2FsbGJhY2spIHsKICAgICAgICAgIGlmICh0eXBlb2YgcGFydGlhbFN0YXRlICE9PSAib2JqZWN0IiAmJiB0eXBlb2YgcGFydGlhbFN0YXRlICE9PSAiZnVuY3Rpb24iICYmIHBhcnRpYWxTdGF0ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2V0U3RhdGUoLi4uKTogdGFrZXMgYW4gb2JqZWN0IG9mIHN0YXRlIHZhcmlhYmxlcyB0byB1cGRhdGUgb3IgYSBmdW5jdGlvbiB3aGljaCByZXR1cm5zIGFuIG9iamVjdCBvZiBzdGF0ZSB2YXJpYWJsZXMuIik7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLnVwZGF0ZXIuZW5xdWV1ZVNldFN0YXRlKHRoaXMsIHBhcnRpYWxTdGF0ZSwgY2FsbGJhY2ssICJzZXRTdGF0ZSIpOwogICAgICAgIH07CiAgICAgICAgQ29tcG9uZW50LnByb3RvdHlwZS5mb3JjZVVwZGF0ZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICB0aGlzLnVwZGF0ZXIuZW5xdWV1ZUZvcmNlVXBkYXRlKHRoaXMsIGNhbGxiYWNrLCAiZm9yY2VVcGRhdGUiKTsKICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHZhciBkZXByZWNhdGVkQVBJcyA9IHsKICAgICAgICAgICAgaXNNb3VudGVkOiBbImlzTW91bnRlZCIsICJJbnN0ZWFkLCBtYWtlIHN1cmUgdG8gY2xlYW4gdXAgc3Vic2NyaXB0aW9ucyBhbmQgcGVuZGluZyByZXF1ZXN0cyBpbiBjb21wb25lbnRXaWxsVW5tb3VudCB0byBwcmV2ZW50IG1lbW9yeSBsZWFrcy4iXSwKICAgICAgICAgICAgcmVwbGFjZVN0YXRlOiBbInJlcGxhY2VTdGF0ZSIsICJSZWZhY3RvciB5b3VyIGNvZGUgdG8gdXNlIHNldFN0YXRlIGluc3RlYWQgKHNlZSBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svcmVhY3QvaXNzdWVzLzMyMzYpLiJdCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGRlZmluZURlcHJlY2F0aW9uV2FybmluZyA9IGZ1bmN0aW9uKG1ldGhvZE5hbWUsIGluZm8pIHsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KENvbXBvbmVudC5wcm90b3R5cGUsIG1ldGhvZE5hbWUsIHsKICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgd2FybjMoIiVzKC4uLikgaXMgZGVwcmVjYXRlZCBpbiBwbGFpbiBKYXZhU2NyaXB0IFJlYWN0IGNsYXNzZXMuICVzIiwgaW5mb1swXSwgaW5mb1sxXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgICAgZm9yICh2YXIgZm5OYW1lIGluIGRlcHJlY2F0ZWRBUElzKSB7CiAgICAgICAgICAgIGlmIChkZXByZWNhdGVkQVBJcy5oYXNPd25Qcm9wZXJ0eShmbk5hbWUpKSB7CiAgICAgICAgICAgICAgZGVmaW5lRGVwcmVjYXRpb25XYXJuaW5nKGZuTmFtZSwgZGVwcmVjYXRlZEFQSXNbZm5OYW1lXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gQ29tcG9uZW50RHVtbXkoKSB7CiAgICAgICAgfQogICAgICAgIENvbXBvbmVudER1bW15LnByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgZnVuY3Rpb24gUHVyZUNvbXBvbmVudDMocHJvcHMsIGNvbnRleHQsIHVwZGF0ZXIpIHsKICAgICAgICAgIHRoaXMucHJvcHMgPSBwcm9wczsKICAgICAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICB0aGlzLnJlZnMgPSBlbXB0eU9iamVjdDsKICAgICAgICAgIHRoaXMudXBkYXRlciA9IHVwZGF0ZXIgfHwgUmVhY3ROb29wVXBkYXRlUXVldWU7CiAgICAgICAgfQogICAgICAgIHZhciBwdXJlQ29tcG9uZW50UHJvdG90eXBlID0gUHVyZUNvbXBvbmVudDMucHJvdG90eXBlID0gbmV3IENvbXBvbmVudER1bW15KCk7CiAgICAgICAgcHVyZUNvbXBvbmVudFByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFB1cmVDb21wb25lbnQzOwogICAgICAgIGFzc2lnbjIocHVyZUNvbXBvbmVudFByb3RvdHlwZSwgQ29tcG9uZW50LnByb3RvdHlwZSk7CiAgICAgICAgcHVyZUNvbXBvbmVudFByb3RvdHlwZS5pc1B1cmVSZWFjdENvbXBvbmVudCA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUmVmKCkgewogICAgICAgICAgdmFyIHJlZk9iamVjdCA9IHsKICAgICAgICAgICAgY3VycmVudDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgT2JqZWN0LnNlYWwocmVmT2JqZWN0KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZWZPYmplY3Q7CiAgICAgICAgfQogICAgICAgIHZhciBpc0FycmF5SW1wbCA9IEFycmF5LmlzQXJyYXk7CiAgICAgICAgZnVuY3Rpb24gaXNBcnJheTIoYSkgewogICAgICAgICAgcmV0dXJuIGlzQXJyYXlJbXBsKGEpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0eXBlTmFtZSh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzVG9TdHJpbmdUYWcgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC50b1N0cmluZ1RhZzsKICAgICAgICAgICAgdmFyIHR5cGUgPSBoYXNUb1N0cmluZ1RhZyAmJiB2YWx1ZVtTeW1ib2wudG9TdHJpbmdUYWddIHx8IHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUgfHwgIk9iamVjdCI7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tLZXlTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBrZXkgaXMgYW4gdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUob3V0ZXJUeXBlLCBpbm5lclR5cGUsIHdyYXBwZXJOYW1lKSB7CiAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSBvdXRlclR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICBpZiAoZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlLnRhZyA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgYW4gdW5leHBlY3RlZCBvYmplY3QgaW4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKCkuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQb3J0YWwiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQcm9maWxlciI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN0cmljdE1vZGUiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2VMaXN0IjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05URVhUX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUoY29udGV4dCkgKyAiLkNvbnN1bWVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwogICAgICAgIHZhciBSRVNFUlZFRF9QUk9QUyA9IHsKICAgICAgICAgIGtleTogdHJ1ZSwKICAgICAgICAgIHJlZjogdHJ1ZSwKICAgICAgICAgIF9fc2VsZjogdHJ1ZSwKICAgICAgICAgIF9fc291cmNlOiB0cnVlCiAgICAgICAgfTsKICAgICAgICB2YXIgc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24sIHNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duLCBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnMgPSB7fTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRSZWYoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgInJlZiIpKSB7CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAicmVmIikuZ2V0OwogICAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29uZmlnLnJlZiAhPT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNWYWxpZEtleShjb25maWcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoY29uZmlnLCAia2V5IikpIHsKICAgICAgICAgICAgICB2YXIgZ2V0dGVyID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihjb25maWcsICJrZXkiKS5nZXQ7CiAgICAgICAgICAgICAgaWYgKGdldHRlciAmJiBnZXR0ZXIuaXNSZWFjdFdhcm5pbmcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb25maWcua2V5ICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSkgewogICAgICAgICAgdmFyIHdhcm5BYm91dEFjY2Vzc2luZ0tleSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93bikgewogICAgICAgICAgICAgICAgc3BlY2lhbFByb3BLZXlXYXJuaW5nU2hvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBga2V5YCBpcyBub3QgYSBwcm9wLiBUcnlpbmcgdG8gYWNjZXNzIGl0IHdpbGwgcmVzdWx0IGluIGB1bmRlZmluZWRgIGJlaW5nIHJldHVybmVkLiBJZiB5b3UgbmVlZCB0byBhY2Nlc3MgdGhlIHNhbWUgdmFsdWUgd2l0aGluIHRoZSBjaGlsZCBjb21wb25lbnQsIHlvdSBzaG91bGQgcGFzcyBpdCBhcyBhIGRpZmZlcmVudCBwcm9wLiAoaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3NwZWNpYWwtcHJvcHMpIiwgZGlzcGxheU5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5BYm91dEFjY2Vzc2luZ0tleS5pc1JlYWN0V2FybmluZyA9IHRydWU7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICJrZXkiLCB7CiAgICAgICAgICAgIGdldDogd2FybkFib3V0QWNjZXNzaW5nS2V5LAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWZpbmVSZWZQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpIHsKICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICAgIHNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogYHJlZmAgaXMgbm90IGEgcHJvcC4gVHJ5aW5nIHRvIGFjY2VzcyBpdCB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBiZWluZyByZXR1cm5lZC4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzYW1lIHZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgcHJvcC4gKGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zcGVjaWFsLXByb3BzKSIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdSZWYuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHByb3BzLCAicmVmIiwgewogICAgICAgICAgICBnZXQ6IHdhcm5BYm91dEFjY2Vzc2luZ1JlZiwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmU3RyaW5nUmVmQ2Fubm90QmVBdXRvQ29udmVydGVkKGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5yZWYgPT09ICJzdHJpbmciICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQgJiYgY29uZmlnLl9fc2VsZiAmJiBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50LnN0YXRlTm9kZSAhPT0gY29uZmlnLl9fc2VsZikgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSk7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcignQ29tcG9uZW50ICIlcyIgY29udGFpbnMgdGhlIHN0cmluZyByZWYgIiVzIi4gU3VwcG9ydCBmb3Igc3RyaW5nIHJlZnMgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFRoaXMgY2FzZSBjYW5ub3QgYmUgYXV0b21hdGljYWxseSBjb252ZXJ0ZWQgdG8gYW4gYXJyb3cgZnVuY3Rpb24uIFdlIGFzayB5b3UgdG8gbWFudWFsbHkgZml4IHRoaXMgY2FzZSBieSB1c2luZyB1c2VSZWYoKSBvciBjcmVhdGVSZWYoKSBpbnN0ZWFkLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1zdHJpbmctcmVmJywgY29tcG9uZW50TmFtZSwgY29uZmlnLnJlZik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0RWxlbWVudCA9IGZ1bmN0aW9uKHR5cGUsIGtleSwgcmVmLCBzZWxmMiwgc291cmNlLCBvd25lciwgcHJvcHMpIHsKICAgICAgICAgIHZhciBlbGVtZW50ID0gewogICAgICAgICAgICAvLyBUaGlzIHRhZyBhbGxvd3MgdXMgdG8gdW5pcXVlbHkgaWRlbnRpZnkgdGhpcyBhcyBhIFJlYWN0IEVsZW1lbnQKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0VMRU1FTlRfVFlQRSwKICAgICAgICAgICAgLy8gQnVpbHQtaW4gcHJvcGVydGllcyB0aGF0IGJlbG9uZyBvbiB0aGUgZWxlbWVudAogICAgICAgICAgICB0eXBlLAogICAgICAgICAgICBrZXksCiAgICAgICAgICAgIHJlZiwKICAgICAgICAgICAgcHJvcHMsCiAgICAgICAgICAgIC8vIFJlY29yZCB0aGUgY29tcG9uZW50IHJlc3BvbnNpYmxlIGZvciBjcmVhdGluZyB0aGlzIGVsZW1lbnQuCiAgICAgICAgICAgIF9vd25lcjogb3duZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIGVsZW1lbnQuX3N0b3JlID0ge307CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50Ll9zdG9yZSwgInZhbGlkYXRlZCIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgICAgICAgIHZhbHVlOiBmYWxzZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsZW1lbnQsICJfc2VsZiIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc2VsZjIKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NvdXJjZSIsIHsKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIHdyaXRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB2YWx1ZTogc291cmNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudC5wcm9wcyk7CiAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVFbGVtZW50MzkodHlwZSwgY29uZmlnLCBjaGlsZHJlbikgewogICAgICAgICAgdmFyIHByb3BOYW1lOwogICAgICAgICAgdmFyIHByb3BzID0ge307CiAgICAgICAgICB2YXIga2V5ID0gbnVsbDsKICAgICAgICAgIHZhciByZWYgPSBudWxsOwogICAgICAgICAgdmFyIHNlbGYyID0gbnVsbDsKICAgICAgICAgIHZhciBzb3VyY2UgPSBudWxsOwogICAgICAgICAgaWYgKGNvbmZpZyAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGhhc1ZhbGlkS2V5KGNvbmZpZykpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGNvbmZpZy5rZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIGNvbmZpZy5rZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZjIgPSBjb25maWcuX19zZWxmID09PSB2b2lkIDAgPyBudWxsIDogY29uZmlnLl9fc2VsZjsKICAgICAgICAgICAgc291cmNlID0gY29uZmlnLl9fc291cmNlID09PSB2b2lkIDAgPyBudWxsIDogY29uZmlnLl9fc291cmNlOwogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGNvbmZpZykgewogICAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgcHJvcE5hbWUpICYmICFSRVNFUlZFRF9QUk9QUy5oYXNPd25Qcm9wZXJ0eShwcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGNvbmZpZ1twcm9wTmFtZV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGRyZW5MZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoIC0gMjsKICAgICAgICAgIGlmIChjaGlsZHJlbkxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogICAgICAgICAgfSBlbHNlIGlmIChjaGlsZHJlbkxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgdmFyIGNoaWxkQXJyYXkgPSBBcnJheShjaGlsZHJlbkxlbmd0aCk7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW5MZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGNoaWxkQXJyYXlbaV0gPSBhcmd1bWVudHNbaSArIDJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoT2JqZWN0LmZyZWV6ZSkgewogICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShjaGlsZEFycmF5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZEFycmF5OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgJiYgdHlwZS5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IHR5cGUuZGVmYXVsdFByb3BzOwogICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGtleSB8fCByZWYpIHsKICAgICAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIiA/IHR5cGUuZGlzcGxheU5hbWUgfHwgdHlwZS5uYW1lIHx8ICJVbmtub3duIiA6IHR5cGU7CiAgICAgICAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICAgICAgZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJlZikgewogICAgICAgICAgICAgICAgZGVmaW5lUmVmUHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQodHlwZSwga2V5LCByZWYsIHNlbGYyLCBzb3VyY2UsIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xvbmVBbmRSZXBsYWNlS2V5KG9sZEVsZW1lbnQsIG5ld0tleSkgewogICAgICAgICAgdmFyIG5ld0VsZW1lbnQgPSBSZWFjdEVsZW1lbnQob2xkRWxlbWVudC50eXBlLCBuZXdLZXksIG9sZEVsZW1lbnQucmVmLCBvbGRFbGVtZW50Ll9zZWxmLCBvbGRFbGVtZW50Ll9zb3VyY2UsIG9sZEVsZW1lbnQuX293bmVyLCBvbGRFbGVtZW50LnByb3BzKTsKICAgICAgICAgIHJldHVybiBuZXdFbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbG9uZUVsZW1lbnQ4KGVsZW1lbnQsIGNvbmZpZywgY2hpbGRyZW4pIHsKICAgICAgICAgIGlmIChlbGVtZW50ID09PSBudWxsIHx8IGVsZW1lbnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlYWN0LmNsb25lRWxlbWVudCguLi4pOiBUaGUgYXJndW1lbnQgbXVzdCBiZSBhIFJlYWN0IGVsZW1lbnQsIGJ1dCB5b3UgcGFzc2VkICIgKyBlbGVtZW50ICsgIi4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wTmFtZTsKICAgICAgICAgIHZhciBwcm9wcyA9IGFzc2lnbjIoe30sIGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgdmFyIGtleSA9IGVsZW1lbnQua2V5OwogICAgICAgICAgdmFyIHJlZiA9IGVsZW1lbnQucmVmOwogICAgICAgICAgdmFyIHNlbGYyID0gZWxlbWVudC5fc2VsZjsKICAgICAgICAgIHZhciBzb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgIGlmIChjb25maWcgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaGFzVmFsaWRSZWYoY29uZmlnKSkgewogICAgICAgICAgICAgIHJlZiA9IGNvbmZpZy5yZWY7CiAgICAgICAgICAgICAgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNWYWxpZEtleShjb25maWcpKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihjb25maWcua2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAga2V5ID0gIiIgKyBjb25maWcua2V5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGlmIChlbGVtZW50LnR5cGUgJiYgZWxlbWVudC50eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGRlZmF1bHRQcm9wcyA9IGVsZW1lbnQudHlwZS5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChwcm9wTmFtZSBpbiBjb25maWcpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsIHByb3BOYW1lKSAmJiAhUkVTRVJWRURfUFJPUFMuaGFzT3duUHJvcGVydHkocHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBpZiAoY29uZmlnW3Byb3BOYW1lXSA9PT0gdm9pZCAwICYmIGRlZmF1bHRQcm9wcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGRlZmF1bHRQcm9wc1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBjb25maWdbcHJvcE5hbWVdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkcmVuTGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCAtIDI7CiAgICAgICAgICBpZiAoY2hpbGRyZW5MZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgcHJvcHMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgICAgICAgIH0gZWxzZSBpZiAoY2hpbGRyZW5MZW5ndGggPiAxKSB7CiAgICAgICAgICAgIHZhciBjaGlsZEFycmF5ID0gQXJyYXkoY2hpbGRyZW5MZW5ndGgpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuTGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjaGlsZEFycmF5W2ldID0gYXJndW1lbnRzW2kgKyAyXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwcm9wcy5jaGlsZHJlbiA9IGNoaWxkQXJyYXk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gUmVhY3RFbGVtZW50KGVsZW1lbnQudHlwZSwga2V5LCByZWYsIHNlbGYyLCBzb3VyY2UsIG93bmVyLCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50MTUob2JqZWN0KSB7CiAgICAgICAgICByZXR1cm4gdHlwZW9mIG9iamVjdCA9PT0gIm9iamVjdCIgJiYgb2JqZWN0ICE9PSBudWxsICYmIG9iamVjdC4kJHR5cGVvZiA9PT0gUkVBQ1RfRUxFTUVOVF9UWVBFOwogICAgICAgIH0KICAgICAgICB2YXIgU0VQQVJBVE9SID0gIi4iOwogICAgICAgIHZhciBTVUJTRVBBUkFUT1IgPSAiOiI7CiAgICAgICAgZnVuY3Rpb24gZXNjYXBlKGtleSkgewogICAgICAgICAgdmFyIGVzY2FwZVJlZ2V4ID0gL1s9Ol0vZzsKICAgICAgICAgIHZhciBlc2NhcGVyTG9va3VwID0gewogICAgICAgICAgICAiPSI6ICI9MCIsCiAgICAgICAgICAgICI6IjogIj0yIgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBlc2NhcGVkU3RyaW5nID0ga2V5LnJlcGxhY2UoZXNjYXBlUmVnZXgsIGZ1bmN0aW9uKG1hdGNoKSB7CiAgICAgICAgICAgIHJldHVybiBlc2NhcGVyTG9va3VwW21hdGNoXTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuICIkIiArIGVzY2FwZWRTdHJpbmc7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNYXBzID0gZmFsc2U7CiAgICAgICAgdmFyIHVzZXJQcm92aWRlZEtleUVzY2FwZVJlZ2V4ID0gL1wvKy9nOwogICAgICAgIGZ1bmN0aW9uIGVzY2FwZVVzZXJQcm92aWRlZEtleSh0ZXh0KSB7CiAgICAgICAgICByZXR1cm4gdGV4dC5yZXBsYWNlKHVzZXJQcm92aWRlZEtleUVzY2FwZVJlZ2V4LCAiJCYvIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEVsZW1lbnRLZXkoZWxlbWVudCwgaW5kZXgpIHsKICAgICAgICAgIGlmICh0eXBlb2YgZWxlbWVudCA9PT0gIm9iamVjdCIgJiYgZWxlbWVudCAhPT0gbnVsbCAmJiBlbGVtZW50LmtleSAhPSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGVsZW1lbnQua2V5KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZXNjYXBlKCIiICsgZWxlbWVudC5rZXkpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluZGV4LnRvU3RyaW5nKDM2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFwSW50b0FycmF5KGNoaWxkcmVuLCBhcnJheSwgZXNjYXBlZFByZWZpeCwgbmFtZVNvRmFyLCBjYWxsYmFjaykgewogICAgICAgICAgdmFyIHR5cGUgPSB0eXBlb2YgY2hpbGRyZW47CiAgICAgICAgICBpZiAodHlwZSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZSA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgIGNoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnZva2VDYWxsYmFjayA9IGZhbHNlOwogICAgICAgICAgaWYgKGNoaWxkcmVuID09PSBudWxsKSB7CiAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgICBzd2l0Y2ggKGNoaWxkcmVuLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICAgIGludm9rZUNhbGxiYWNrID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGludm9rZUNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBfY2hpbGQgPSBjaGlsZHJlbjsKICAgICAgICAgICAgdmFyIG1hcHBlZENoaWxkID0gY2FsbGJhY2soX2NoaWxkKTsKICAgICAgICAgICAgdmFyIGNoaWxkS2V5ID0gbmFtZVNvRmFyID09PSAiIiA/IFNFUEFSQVRPUiArIGdldEVsZW1lbnRLZXkoX2NoaWxkLCAwKSA6IG5hbWVTb0ZhcjsKICAgICAgICAgICAgaWYgKGlzQXJyYXkyKG1hcHBlZENoaWxkKSkgewogICAgICAgICAgICAgIHZhciBlc2NhcGVkQ2hpbGRLZXkgPSAiIjsKICAgICAgICAgICAgICBpZiAoY2hpbGRLZXkgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZXNjYXBlZENoaWxkS2V5ID0gZXNjYXBlVXNlclByb3ZpZGVkS2V5KGNoaWxkS2V5KSArICIvIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbWFwSW50b0FycmF5KG1hcHBlZENoaWxkLCBhcnJheSwgZXNjYXBlZENoaWxkS2V5LCAiIiwgZnVuY3Rpb24oYykgewogICAgICAgICAgICAgICAgcmV0dXJuIGM7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobWFwcGVkQ2hpbGQgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChpc1ZhbGlkRWxlbWVudDE1KG1hcHBlZENoaWxkKSkgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAobWFwcGVkQ2hpbGQua2V5ICYmICghX2NoaWxkIHx8IF9jaGlsZC5rZXkgIT09IG1hcHBlZENoaWxkLmtleSkpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKG1hcHBlZENoaWxkLmtleSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1hcHBlZENoaWxkID0gY2xvbmVBbmRSZXBsYWNlS2V5KAogICAgICAgICAgICAgICAgICBtYXBwZWRDaGlsZCwKICAgICAgICAgICAgICAgICAgLy8gS2VlcCBib3RoIHRoZSAobWFwcGVkKSBhbmQgb2xkIGtleXMgaWYgdGhleSBkaWZmZXIsIGp1c3QgYXMKICAgICAgICAgICAgICAgICAgLy8gdHJhdmVyc2VBbGxDaGlsZHJlbiB1c2VkIHRvIGRvIGZvciBvYmplY3RzIGFzIGNoaWxkcmVuCiAgICAgICAgICAgICAgICAgIGVzY2FwZWRQcmVmaXggKyAvLyAkRmxvd0ZpeE1lIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIFJlYWN0LlBvcnRhbCBkb2Vzbid0IGhhdmUgYSBrZXkKICAgICAgICAgICAgICAgICAgKG1hcHBlZENoaWxkLmtleSAmJiAoIV9jaGlsZCB8fCBfY2hpbGQua2V5ICE9PSBtYXBwZWRDaGlsZC5rZXkpID8gKAogICAgICAgICAgICAgICAgICAgIC8vICRGbG93Rml4TWUgRmxvdyBpbmNvcnJlY3RseSB0aGlua3MgZXhpc3RpbmcgZWxlbWVudCdzIGtleSBjYW4gYmUgYSBudW1iZXIKICAgICAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaW50ZXJuYWwvc2FmZS1zdHJpbmctY29lcmNpb24KICAgICAgICAgICAgICAgICAgICBlc2NhcGVVc2VyUHJvdmlkZWRLZXkoIiIgKyBtYXBwZWRDaGlsZC5rZXkpICsgIi8iCiAgICAgICAgICAgICAgICAgICkgOiAiIikgKyBjaGlsZEtleQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYXJyYXkucHVzaChtYXBwZWRDaGlsZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY2hpbGQ7CiAgICAgICAgICB2YXIgbmV4dE5hbWU7CiAgICAgICAgICB2YXIgc3VidHJlZUNvdW50ID0gMDsKICAgICAgICAgIHZhciBuZXh0TmFtZVByZWZpeCA9IG5hbWVTb0ZhciA9PT0gIiIgPyBTRVBBUkFUT1IgOiBuYW1lU29GYXIgKyBTVUJTRVBBUkFUT1I7CiAgICAgICAgICBpZiAoaXNBcnJheTIoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkcmVuW2ldOwogICAgICAgICAgICAgIG5leHROYW1lID0gbmV4dE5hbWVQcmVmaXggKyBnZXRFbGVtZW50S2V5KGNoaWxkLCBpKTsKICAgICAgICAgICAgICBzdWJ0cmVlQ291bnQgKz0gbWFwSW50b0FycmF5KGNoaWxkLCBhcnJheSwgZXNjYXBlZFByZWZpeCwgbmV4dE5hbWUsIGNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKGNoaWxkcmVuKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGl0ZXJhYmxlQ2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaXRlcmF0b3JGbiA9PT0gaXRlcmFibGVDaGlsZHJlbi5lbnRyaWVzKSB7CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TWFwcykgewogICAgICAgICAgICAgICAgICAgIHdhcm4zKCJVc2luZyBNYXBzIGFzIGNoaWxkcmVuIGlzIG5vdCBzdXBwb3J0ZWQuIFVzZSBhbiBhcnJheSBvZiBrZXllZCBSZWFjdEVsZW1lbnRzIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0TWFwcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBpdGVyYXRvciA9IGl0ZXJhdG9yRm4uY2FsbChpdGVyYWJsZUNoaWxkcmVuKTsKICAgICAgICAgICAgICB2YXIgc3RlcDsKICAgICAgICAgICAgICB2YXIgaWkgPSAwOwogICAgICAgICAgICAgIHdoaWxlICghKHN0ZXAgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgICAgIGNoaWxkID0gc3RlcC52YWx1ZTsKICAgICAgICAgICAgICAgIG5leHROYW1lID0gbmV4dE5hbWVQcmVmaXggKyBnZXRFbGVtZW50S2V5KGNoaWxkLCBpaSsrKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVDb3VudCArPSBtYXBJbnRvQXJyYXkoY2hpbGQsIGFycmF5LCBlc2NhcGVkUHJlZml4LCBuZXh0TmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHZhciBjaGlsZHJlblN0cmluZyA9IFN0cmluZyhjaGlsZHJlbik7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPYmplY3RzIGFyZSBub3QgdmFsaWQgYXMgYSBSZWFjdCBjaGlsZCAoZm91bmQ6ICIgKyAoY2hpbGRyZW5TdHJpbmcgPT09ICJbb2JqZWN0IE9iamVjdF0iID8gIm9iamVjdCB3aXRoIGtleXMgeyIgKyBPYmplY3Qua2V5cyhjaGlsZHJlbikuam9pbigiLCAiKSArICJ9IiA6IGNoaWxkcmVuU3RyaW5nKSArICIpLiBJZiB5b3UgbWVhbnQgdG8gcmVuZGVyIGEgY29sbGVjdGlvbiBvZiBjaGlsZHJlbiwgdXNlIGFuIGFycmF5IGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzdWJ0cmVlQ291bnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcENoaWxkcmVuKGNoaWxkcmVuLCBmdW5jLCBjb250ZXh0KSB7CiAgICAgICAgICBpZiAoY2hpbGRyZW4gPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gY2hpbGRyZW47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcmVzdWx0ID0gW107CiAgICAgICAgICB2YXIgY291bnQgPSAwOwogICAgICAgICAgbWFwSW50b0FycmF5KGNoaWxkcmVuLCByZXN1bHQsICIiLCAiIiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICAgICAgcmV0dXJuIGZ1bmMuY2FsbChjb250ZXh0LCBjaGlsZCwgY291bnQrKyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvdW50Q2hpbGRyZW4oY2hpbGRyZW4pIHsKICAgICAgICAgIHZhciBuID0gMDsKICAgICAgICAgIG1hcENoaWxkcmVuKGNoaWxkcmVuLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgbisrOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yRWFjaENoaWxkcmVuKGNoaWxkcmVuLCBmb3JFYWNoRnVuYywgZm9yRWFjaENvbnRleHQpIHsKICAgICAgICAgIG1hcENoaWxkcmVuKGNoaWxkcmVuLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgZm9yRWFjaEZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIH0sIGZvckVhY2hDb250ZXh0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG9BcnJheTIoY2hpbGRyZW4pIHsKICAgICAgICAgIHJldHVybiBtYXBDaGlsZHJlbihjaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgfSkgfHwgW107CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9ubHlDaGlsZChjaGlsZHJlbikgewogICAgICAgICAgaWYgKCFpc1ZhbGlkRWxlbWVudDE1KGNoaWxkcmVuKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlYWN0LkNoaWxkcmVuLm9ubHkgZXhwZWN0ZWQgdG8gcmVjZWl2ZSBhIHNpbmdsZSBSZWFjdCBlbGVtZW50IGNoaWxkLiIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNoaWxkcmVuOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVDb250ZXh0MTIoZGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICB2YXIgY29udGV4dCA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0NPTlRFWFRfVFlQRSwKICAgICAgICAgICAgLy8gQXMgYSB3b3JrYXJvdW5kIHRvIHN1cHBvcnQgbXVsdGlwbGUgY29uY3VycmVudCByZW5kZXJlcnMsIHdlIGNhdGVnb3JpemUKICAgICAgICAgICAgLy8gc29tZSByZW5kZXJlcnMgYXMgcHJpbWFyeSBhbmQgb3RoZXJzIGFzIHNlY29uZGFyeS4gV2Ugb25seSBleHBlY3QKICAgICAgICAgICAgLy8gdGhlcmUgdG8gYmUgdHdvIGNvbmN1cnJlbnQgcmVuZGVyZXJzIGF0IG1vc3Q6IFJlYWN0IE5hdGl2ZSAocHJpbWFyeSkgYW5kCiAgICAgICAgICAgIC8vIEZhYnJpYyAoc2Vjb25kYXJ5KTsgUmVhY3QgRE9NIChwcmltYXJ5KSBhbmQgUmVhY3QgQVJUIChzZWNvbmRhcnkpLgogICAgICAgICAgICAvLyBTZWNvbmRhcnkgcmVuZGVyZXJzIHN0b3JlIHRoZWlyIGNvbnRleHQgdmFsdWVzIG9uIHNlcGFyYXRlIGZpZWxkcy4KICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTogZGVmYXVsdFZhbHVlLAogICAgICAgICAgICBfY3VycmVudFZhbHVlMjogZGVmYXVsdFZhbHVlLAogICAgICAgICAgICAvLyBVc2VkIHRvIHRyYWNrIGhvdyBtYW55IGNvbmN1cnJlbnQgcmVuZGVyZXJzIHRoaXMgY29udGV4dCBjdXJyZW50bHkKICAgICAgICAgICAgLy8gc3VwcG9ydHMgd2l0aGluIGluIGEgc2luZ2xlIHJlbmRlcmVyLiBTdWNoIGFzIHBhcmFsbGVsIHNlcnZlciByZW5kZXJpbmcuCiAgICAgICAgICAgIF90aHJlYWRDb3VudDogMCwKICAgICAgICAgICAgLy8gVGhlc2UgYXJlIGNpcmN1bGFyCiAgICAgICAgICAgIFByb3ZpZGVyOiBudWxsLAogICAgICAgICAgICBDb25zdW1lcjogbnVsbCwKICAgICAgICAgICAgLy8gQWRkIHRoZXNlIHRvIHVzZSBzYW1lIGhpZGRlbiBjbGFzcyBpbiBWTSBhcyBTZXJ2ZXJDb250ZXh0CiAgICAgICAgICAgIF9kZWZhdWx0VmFsdWU6IG51bGwsCiAgICAgICAgICAgIF9nbG9iYWxOYW1lOiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgY29udGV4dC5Qcm92aWRlciA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX1BST1ZJREVSX1RZUEUsCiAgICAgICAgICAgIF9jb250ZXh0OiBjb250ZXh0CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGhhc1dhcm5lZEFib3V0VXNpbmdOZXN0ZWRDb250ZXh0Q29uc3VtZXJzID0gZmFsc2U7CiAgICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnN1bWVyUHJvdmlkZXIgPSBmYWxzZTsKICAgICAgICAgIHZhciBoYXNXYXJuZWRBYm91dERpc3BsYXlOYW1lT25Db25zdW1lciA9IGZhbHNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgQ29uc3VtZXIgPSB7CiAgICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0NPTlRFWFRfVFlQRSwKICAgICAgICAgICAgICBfY29udGV4dDogY29udGV4dAogICAgICAgICAgICB9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhDb25zdW1lciwgewogICAgICAgICAgICAgIFByb3ZpZGVyOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdDb25zdW1lclByb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnN1bWVyUHJvdmlkZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJSZW5kZXJpbmcgPENvbnRleHQuQ29uc3VtZXIuUHJvdmlkZXI+IGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gcmVuZGVyIDxDb250ZXh0LlByb3ZpZGVyPiBpbnN0ZWFkPyIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0LlByb3ZpZGVyOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX1Byb3ZpZGVyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRleHQuUHJvdmlkZXIgPSBfUHJvdmlkZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBfY3VycmVudFZhbHVlOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5fY3VycmVudFZhbHVlOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX2N1cnJlbnRWYWx1ZSkgewogICAgICAgICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50VmFsdWUgPSBfY3VycmVudFZhbHVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX2N1cnJlbnRWYWx1ZTI6IHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0Ll9jdXJyZW50VmFsdWUyOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oX2N1cnJlbnRWYWx1ZTIpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5fY3VycmVudFZhbHVlMiA9IF9jdXJyZW50VmFsdWUyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX3RocmVhZENvdW50OiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5fdGhyZWFkQ291bnQ7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihfdGhyZWFkQ291bnQpIHsKICAgICAgICAgICAgICAgICAgY29udGV4dC5fdGhyZWFkQ291bnQgPSBfdGhyZWFkQ291bnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBDb25zdW1lcjogewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nTmVzdGVkQ29udGV4dENvbnN1bWVycykgewogICAgICAgICAgICAgICAgICAgIGhhc1dhcm5lZEFib3V0VXNpbmdOZXN0ZWRDb250ZXh0Q29uc3VtZXJzID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyaW5nIDxDb250ZXh0LkNvbnN1bWVyLkNvbnN1bWVyPiBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIHJlbmRlciA8Q29udGV4dC5Db25zdW1lcj4gaW5zdGVhZD8iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5Db25zdW1lcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGRpc3BsYXlOYW1lOiB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5kaXNwbGF5TmFtZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICAgICAgICAgIGlmICghaGFzV2FybmVkQWJvdXREaXNwbGF5TmFtZU9uQ29uc3VtZXIpIHsKICAgICAgICAgICAgICAgICAgICB3YXJuMygiU2V0dGluZyBgZGlzcGxheU5hbWVgIG9uIENvbnRleHQuQ29uc3VtZXIgaGFzIG5vIGVmZmVjdC4gWW91IHNob3VsZCBzZXQgaXQgZGlyZWN0bHkgb24gdGhlIGNvbnRleHQgd2l0aCBDb250ZXh0LmRpc3BsYXlOYW1lID0gJyVzJy4iLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXREaXNwbGF5TmFtZU9uQ29uc3VtZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29udGV4dC5Db25zdW1lciA9IENvbnN1bWVyOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgPSBudWxsOwogICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIyID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjb250ZXh0OwogICAgICAgIH0KICAgICAgICB2YXIgVW5pbml0aWFsaXplZCA9IC0xOwogICAgICAgIHZhciBQZW5kaW5nID0gMDsKICAgICAgICB2YXIgUmVzb2x2ZWQgPSAxOwogICAgICAgIHZhciBSZWplY3RlZCA9IDI7CiAgICAgICAgZnVuY3Rpb24gbGF6eUluaXRpYWxpemVyKHBheWxvYWQpIHsKICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFVuaW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgdmFyIGN0b3IgPSBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICAgIHZhciB0aGVuYWJsZSA9IGN0b3IoKTsKICAgICAgICAgICAgdGhlbmFibGUudGhlbihmdW5jdGlvbihtb2R1bGVPYmplY3QyKSB7CiAgICAgICAgICAgICAgaWYgKHBheWxvYWQuX3N0YXR1cyA9PT0gUGVuZGluZyB8fCBwYXlsb2FkLl9zdGF0dXMgPT09IFVuaW5pdGlhbGl6ZWQpIHsKICAgICAgICAgICAgICAgIHZhciByZXNvbHZlZCA9IHBheWxvYWQ7CiAgICAgICAgICAgICAgICByZXNvbHZlZC5fc3RhdHVzID0gUmVzb2x2ZWQ7CiAgICAgICAgICAgICAgICByZXNvbHZlZC5fcmVzdWx0ID0gbW9kdWxlT2JqZWN0MjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIGZ1bmN0aW9uKGVycm9yMikgewogICAgICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFBlbmRpbmcgfHwgcGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgICAgICB2YXIgcmVqZWN0ZWQgPSBwYXlsb2FkOwogICAgICAgICAgICAgICAgcmVqZWN0ZWQuX3N0YXR1cyA9IFJlamVjdGVkOwogICAgICAgICAgICAgICAgcmVqZWN0ZWQuX3Jlc3VsdCA9IGVycm9yMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAocGF5bG9hZC5fc3RhdHVzID09PSBVbmluaXRpYWxpemVkKSB7CiAgICAgICAgICAgICAgdmFyIHBlbmRpbmcgPSBwYXlsb2FkOwogICAgICAgICAgICAgIHBlbmRpbmcuX3N0YXR1cyA9IFBlbmRpbmc7CiAgICAgICAgICAgICAgcGVuZGluZy5fcmVzdWx0ID0gdGhlbmFibGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwYXlsb2FkLl9zdGF0dXMgPT09IFJlc29sdmVkKSB7CiAgICAgICAgICAgIHZhciBtb2R1bGVPYmplY3QgPSBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAobW9kdWxlT2JqZWN0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGVycm9yKCJsYXp5OiBFeHBlY3RlZCB0aGUgcmVzdWx0IG9mIGEgZHluYW1pYyBpbXBvcnQoKSBjYWxsLiBJbnN0ZWFkIHJlY2VpdmVkOiAlc1xuXG5Zb3VyIGNvZGUgc2hvdWxkIGxvb2sgbGlrZTogXG4gIGNvbnN0IE15Q29tcG9uZW50ID0gbGF6eSgoKSA9PiBpbXBvcnQoJy4vTXlDb21wb25lbnQnKSlcblxuRGlkIHlvdSBhY2NpZGVudGFsbHkgcHV0IGN1cmx5IGJyYWNlcyBhcm91bmQgdGhlIGltcG9ydD8iLCBtb2R1bGVPYmplY3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCEoImRlZmF1bHQiIGluIG1vZHVsZU9iamVjdCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJsYXp5OiBFeHBlY3RlZCB0aGUgcmVzdWx0IG9mIGEgZHluYW1pYyBpbXBvcnQoKSBjYWxsLiBJbnN0ZWFkIHJlY2VpdmVkOiAlc1xuXG5Zb3VyIGNvZGUgc2hvdWxkIGxvb2sgbGlrZTogXG4gIGNvbnN0IE15Q29tcG9uZW50ID0gbGF6eSgoKSA9PiBpbXBvcnQoJy4vTXlDb21wb25lbnQnKSkiLCBtb2R1bGVPYmplY3QpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbW9kdWxlT2JqZWN0LmRlZmF1bHQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBwYXlsb2FkLl9yZXN1bHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhenkoY3RvcikgewogICAgICAgICAgdmFyIHBheWxvYWQgPSB7CiAgICAgICAgICAgIC8vIFdlIHVzZSB0aGVzZSBmaWVsZHMgdG8gc3RvcmUgdGhlIHJlc3VsdC4KICAgICAgICAgICAgX3N0YXR1czogVW5pbml0aWFsaXplZCwKICAgICAgICAgICAgX3Jlc3VsdDogY3RvcgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBsYXp5VHlwZSA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0xBWllfVFlQRSwKICAgICAgICAgICAgX3BheWxvYWQ6IHBheWxvYWQsCiAgICAgICAgICAgIF9pbml0OiBsYXp5SW5pdGlhbGl6ZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIHZhciBwcm9wVHlwZXM7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGxhenlUeXBlLCB7CiAgICAgICAgICAgICAgZGVmYXVsdFByb3BzOiB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdFByb3BzOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24obmV3RGVmYXVsdFByb3BzKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5sYXp5KC4uLik6IEl0IGlzIG5vdCBzdXBwb3J0ZWQgdG8gYXNzaWduIGBkZWZhdWx0UHJvcHNgIHRvIGEgbGF6eSBjb21wb25lbnQgaW1wb3J0LiBFaXRoZXIgc3BlY2lmeSB0aGVtIHdoZXJlIHRoZSBjb21wb25lbnQgaXMgZGVmaW5lZCwgb3IgY3JlYXRlIGEgd3JhcHBpbmcgY29tcG9uZW50IGFyb3VuZCBpdC4iKTsKICAgICAgICAgICAgICAgICAgZGVmYXVsdFByb3BzID0gbmV3RGVmYXVsdFByb3BzOwogICAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobGF6eVR5cGUsICJkZWZhdWx0UHJvcHMiLCB7CiAgICAgICAgICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIHByb3BUeXBlczogewogICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHByb3BUeXBlczsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5ld1Byb3BUeXBlcykgewogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QubGF6eSguLi4pOiBJdCBpcyBub3Qgc3VwcG9ydGVkIHRvIGFzc2lnbiBgcHJvcFR5cGVzYCB0byBhIGxhenkgY29tcG9uZW50IGltcG9ydC4gRWl0aGVyIHNwZWNpZnkgdGhlbSB3aGVyZSB0aGUgY29tcG9uZW50IGlzIGRlZmluZWQsIG9yIGNyZWF0ZSBhIHdyYXBwaW5nIGNvbXBvbmVudCBhcm91bmQgaXQuIik7CiAgICAgICAgICAgICAgICAgIHByb3BUeXBlcyA9IG5ld1Byb3BUeXBlczsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGxhenlUeXBlLCAicHJvcFR5cGVzIiwgewogICAgICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYXp5VHlwZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yd2FyZFJlZjE1KHJlbmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVuZGVyICE9IG51bGwgJiYgcmVuZGVyLiQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyKSB7CiAgICAgICAgICAgICAgZXJyb3IoImZvcndhcmRSZWYgcmVxdWlyZXMgYSByZW5kZXIgZnVuY3Rpb24gYnV0IHJlY2VpdmVkIGEgYG1lbW9gIGNvbXBvbmVudC4gSW5zdGVhZCBvZiBmb3J3YXJkUmVmKG1lbW8oLi4uKSksIHVzZSBtZW1vKGZvcndhcmRSZWYoLi4uKSkuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlbmRlciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlcXVpcmVzIGEgcmVuZGVyIGZ1bmN0aW9uIGJ1dCB3YXMgZ2l2ZW4gJXMuIiwgcmVuZGVyID09PSBudWxsID8gIm51bGwiIDogdHlwZW9mIHJlbmRlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKHJlbmRlci5sZW5ndGggIT09IDAgJiYgcmVuZGVyLmxlbmd0aCAhPT0gMikgewogICAgICAgICAgICAgICAgZXJyb3IoImZvcndhcmRSZWYgcmVuZGVyIGZ1bmN0aW9ucyBhY2NlcHQgZXhhY3RseSB0d28gcGFyYW1ldGVyczogcHJvcHMgYW5kIHJlZi4gJXMiLCByZW5kZXIubGVuZ3RoID09PSAxID8gIkRpZCB5b3UgZm9yZ2V0IHRvIHVzZSB0aGUgcmVmIHBhcmFtZXRlcj8iIDogIkFueSBhZGRpdGlvbmFsIHBhcmFtZXRlciB3aWxsIGJlIHVuZGVmaW5lZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlbmRlciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHJlbmRlci5kZWZhdWx0UHJvcHMgIT0gbnVsbCB8fCByZW5kZXIucHJvcFR5cGVzICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJmb3J3YXJkUmVmIHJlbmRlciBmdW5jdGlvbnMgZG8gbm90IHN1cHBvcnQgcHJvcFR5cGVzIG9yIGRlZmF1bHRQcm9wcy4gRGlkIHlvdSBhY2NpZGVudGFsbHkgcGFzcyBhIFJlYWN0IGNvbXBvbmVudD8iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IHsKICAgICAgICAgICAgJCR0eXBlb2Y6IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyLAogICAgICAgICAgICByZW5kZXIKICAgICAgICAgIH07CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25OYW1lOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudFR5cGUsICJkaXNwbGF5TmFtZSIsIHsKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBvd25OYW1lOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgICAgICBvd25OYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIGlmICghcmVuZGVyLm5hbWUgJiYgIXJlbmRlci5kaXNwbGF5TmFtZSkgewogICAgICAgICAgICAgICAgICByZW5kZXIuZGlzcGxheU5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbWVudFR5cGU7CiAgICAgICAgfQogICAgICAgIHZhciBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFOwogICAgICAgIHsKICAgICAgICAgIFJFQUNUX01PRFVMRV9SRUZFUkVOQ0UgPSBTeW1ib2wuZm9yKCJyZWFjdC5tb2R1bGUucmVmZXJlbmNlIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciIHx8IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfUFJPRklMRVJfVFlQRSB8fCBlbmFibGVEZWJ1Z1RyYWNpbmcgfHwgdHlwZSA9PT0gUkVBQ1RfU1RSSUNUX01PREVfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSB8fCBlbmFibGVMZWdhY3lIaWRkZW4gfHwgdHlwZSA9PT0gUkVBQ1RfT0ZGU0NSRUVOX1RZUEUgfHwgZW5hYmxlU2NvcGVBUEkgfHwgZW5hYmxlQ2FjaGVFbGVtZW50IHx8IGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFMiB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9QUk9WSURFUl9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0NPTlRFWFRfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiB8fCAvLyBUaGlzIG5lZWRzIHRvIGluY2x1ZGUgYWxsIHBvc3NpYmxlIG1vZHVsZSByZWZlcmVuY2Ugb2JqZWN0CiAgICAgICAgICAgIC8vIHR5cGVzIHN1cHBvcnRlZCBieSBhbnkgRmxpZ2h0IGNvbmZpZ3VyYXRpb24gYW55d2hlcmUgc2luY2UKICAgICAgICAgICAgLy8gd2UgZG9uJ3Qga25vdyB3aGljaCBGbGlnaHQgYnVpbGQgdGhpcyB3aWxsIGVuZCB1cCBiZWluZyB1c2VkCiAgICAgICAgICAgIC8vIHdpdGguCiAgICAgICAgICAgIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01PRFVMRV9SRUZFUkVOQ0UgfHwgdHlwZS5nZXRNb2R1bGVJZCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWVtbzcodHlwZSwgY29tcGFyZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKSkgewogICAgICAgICAgICAgIGVycm9yKCJtZW1vOiBUaGUgZmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIGNvbXBvbmVudC4gSW5zdGVhZCByZWNlaXZlZDogJXMiLCB0eXBlID09PSBudWxsID8gIm51bGwiIDogdHlwZW9mIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSB7CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9NRU1PX1RZUEUyLAogICAgICAgICAgICB0eXBlLAogICAgICAgICAgICBjb21wYXJlOiBjb21wYXJlID09PSB2b2lkIDAgPyBudWxsIDogY29tcGFyZQogICAgICAgICAgfTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIG93bk5hbWU7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50VHlwZSwgImRpc3BsYXlOYW1lIiwgewogICAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG93bk5hbWU7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgICAgIG93bk5hbWUgPSBuYW1lOwogICAgICAgICAgICAgICAgaWYgKCF0eXBlLm5hbWUgJiYgIXR5cGUuZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgICAgICAgdHlwZS5kaXNwbGF5TmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50VHlwZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZURpc3BhdGNoZXIoKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpc3BhdGNoZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBob29rIGNhbGwuIEhvb2tzIGNhbiBvbmx5IGJlIGNhbGxlZCBpbnNpZGUgb2YgdGhlIGJvZHkgb2YgYSBmdW5jdGlvbiBjb21wb25lbnQuIFRoaXMgY291bGQgaGFwcGVuIGZvciBvbmUgb2YgdGhlIGZvbGxvd2luZyByZWFzb25zOlxuMS4gWW91IG1pZ2h0IGhhdmUgbWlzbWF0Y2hpbmcgdmVyc2lvbnMgb2YgUmVhY3QgYW5kIHRoZSByZW5kZXJlciAoc3VjaCBhcyBSZWFjdCBET00pXG4yLiBZb3UgbWlnaHQgYmUgYnJlYWtpbmcgdGhlIFJ1bGVzIG9mIEhvb2tzXG4zLiBZb3UgbWlnaHQgaGF2ZSBtb3JlIHRoYW4gb25lIGNvcHkgb2YgUmVhY3QgaW4gdGhlIHNhbWUgYXBwXG5TZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2ludmFsaWQtaG9vay1jYWxsIGZvciB0aXBzIGFib3V0IGhvdyB0byBkZWJ1ZyBhbmQgZml4IHRoaXMgcHJvYmxlbS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUNvbnRleHQxMihDb250ZXh0KSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChDb250ZXh0Ll9jb250ZXh0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgcmVhbENvbnRleHQgPSBDb250ZXh0Ll9jb250ZXh0OwogICAgICAgICAgICAgIGlmIChyZWFsQ29udGV4dC5Db25zdW1lciA9PT0gQ29udGV4dCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkNhbGxpbmcgdXNlQ29udGV4dChDb250ZXh0LkNvbnN1bWVyKSBpcyBub3Qgc3VwcG9ydGVkLCBtYXkgY2F1c2UgYnVncywgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBEaWQgeW91IG1lYW4gdG8gY2FsbCB1c2VDb250ZXh0KENvbnRleHQpIGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZWFsQ29udGV4dC5Qcm92aWRlciA9PT0gQ29udGV4dCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkNhbGxpbmcgdXNlQ29udGV4dChDb250ZXh0LlByb3ZpZGVyKSBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCB1c2VDb250ZXh0KENvbnRleHQpIGluc3RlYWQ/Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VDb250ZXh0KENvbnRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VTdGF0ZTEzKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlUmVmMTYoaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VSZWYoaW5pdGlhbFZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlRWZmZWN0MTQoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUxheW91dEVmZmVjdDkoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlQ2FsbGJhY2s4KGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hlci51c2VDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZU1lbW85KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlTWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1c2VJbXBlcmF0aXZlSGFuZGxlMyhyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZURlYnVnVmFsdWUyKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgZGlzcGF0Y2hlciA9IHJlc29sdmVEaXNwYXRjaGVyKCk7CiAgICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZURlYnVnVmFsdWUodmFsdWUsIGZvcm1hdHRlckZuKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlVHJhbnNpdGlvbigpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZVRyYW5zaXRpb24oKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXNlRGVmZXJyZWRWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZUlkMigpIHsKICAgICAgICAgIHZhciBkaXNwYXRjaGVyID0gcmVzb2x2ZURpc3BhdGNoZXIoKTsKICAgICAgICAgIHJldHVybiBkaXNwYXRjaGVyLnVzZUlkKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVzZVN5bmNFeHRlcm5hbFN0b3JlMihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgdmFyIGRpc3BhdGNoZXIgPSByZXNvbHZlRGlzcGF0Y2hlcigpOwogICAgICAgICAgcmV0dXJuIGRpc3BhdGNoZXIudXNlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgIH0KICAgICAgICB2YXIgZGlzYWJsZWREZXB0aCA9IDA7CiAgICAgICAgdmFyIHByZXZMb2c7CiAgICAgICAgdmFyIHByZXZJbmZvOwogICAgICAgIHZhciBwcmV2V2FybjsKICAgICAgICB2YXIgcHJldkVycm9yOwogICAgICAgIHZhciBwcmV2R3JvdXA7CiAgICAgICAgdmFyIHByZXZHcm91cENvbGxhcHNlZDsKICAgICAgICB2YXIgcHJldkdyb3VwRW5kOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVkTG9nKCkgewogICAgICAgIH0KICAgICAgICBkaXNhYmxlZExvZy5fX3JlYWN0RGlzYWJsZWRMb2cgPSB0cnVlOwogICAgICAgIGZ1bmN0aW9uIGRpc2FibGVMb2dzKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHByZXZMb2cgPSBjb25zb2xlLmxvZzsKICAgICAgICAgICAgICBwcmV2SW5mbyA9IGNvbnNvbGUuaW5mbzsKICAgICAgICAgICAgICBwcmV2V2FybiA9IGNvbnNvbGUud2FybjsKICAgICAgICAgICAgICBwcmV2RXJyb3IgPSBjb25zb2xlLmVycm9yOwogICAgICAgICAgICAgIHByZXZHcm91cCA9IGNvbnNvbGUuZ3JvdXA7CiAgICAgICAgICAgICAgcHJldkdyb3VwQ29sbGFwc2VkID0gY29uc29sZS5ncm91cENvbGxhcHNlZDsKICAgICAgICAgICAgICBwcmV2R3JvdXBFbmQgPSBjb25zb2xlLmdyb3VwRW5kOwogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB2YWx1ZTogZGlzYWJsZWRMb2csCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgaW5mbzogcHJvcHMsCiAgICAgICAgICAgICAgICBsb2c6IHByb3BzLAogICAgICAgICAgICAgICAgd2FybjogcHJvcHMsCiAgICAgICAgICAgICAgICBlcnJvcjogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogcHJvcHMsCiAgICAgICAgICAgICAgICBncm91cEVuZDogcHJvcHMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaXNhYmxlZERlcHRoKys7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZW5hYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZGlzYWJsZWREZXB0aC0tOwogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA9PT0gMCkgewogICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsKICAgICAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoY29uc29sZSwgewogICAgICAgICAgICAgICAgbG9nOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkxvZwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBpbmZvOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkluZm8KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgd2FybjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZXYXJuCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGVycm9yOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkVycm9yCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwQ29sbGFwc2VkOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwQ29sbGFwc2VkCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGdyb3VwRW5kOiBhc3NpZ24yKHt9LCBwcm9wcywgewogICAgICAgICAgICAgICAgICB2YWx1ZTogcHJldkdyb3VwRW5kCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaXNhYmxlZERlcHRoIDwgMCkgewogICAgICAgICAgICAgIGVycm9yKCJkaXNhYmxlZERlcHRoIGZlbGwgYmVsb3cgemVyby4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgdmFyIHByZWZpeDsKICAgICAgICBmdW5jdGlvbiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZShuYW1lLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByZWZpeCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCk7CiAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIHZhciBtYXRjaCA9IHgyLnN0YWNrLnRyaW0oKS5tYXRjaCgvXG4oICooYXQgKT8pLyk7CiAgICAgICAgICAgICAgICBwcmVmaXggPSBtYXRjaCAmJiBtYXRjaFsxXSB8fCAiIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICJcbiIgKyBwcmVmaXggKyBuYW1lOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgIHZhciBjb21wb25lbnRGcmFtZUNhY2hlOwogICAgICAgIHsKICAgICAgICAgIHZhciBQb3NzaWJseVdlYWtNYXAgPSB0eXBlb2YgV2Vha01hcCA9PT0gImZ1bmN0aW9uIiA/IFdlYWtNYXAgOiBNYXA7CiAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlID0gbmV3IFBvc3NpYmx5V2Vha01hcCgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBjb25zdHJ1Y3QpIHsKICAgICAgICAgIGlmICghZm4gfHwgcmVlbnRyeSkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBmcmFtZSA9IGNvbXBvbmVudEZyYW1lQ2FjaGUuZ2V0KGZuKTsKICAgICAgICAgICAgaWYgKGZyYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICByZXR1cm4gZnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjb250cm9sOwogICAgICAgICAgcmVlbnRyeSA9IHRydWU7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZSA9IEVycm9yLnByZXBhcmVTdGFja1RyYWNlOwogICAgICAgICAgRXJyb3IucHJlcGFyZVN0YWNrVHJhY2UgPSB2b2lkIDA7CiAgICAgICAgICB2YXIgcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgewogICAgICAgICAgICBwcmV2aW91c0Rpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICBkaXNhYmxlTG9ncygpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGNvbnN0cnVjdCkgewogICAgICAgICAgICAgIHZhciBGYWtlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEZha2UucHJvdG90eXBlLCAicHJvcHMiLCB7CiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gIm9iamVjdCIgJiYgUmVmbGVjdC5jb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KEZha2UsIFtdKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFJlZmxlY3QuY29uc3RydWN0KGZuLCBbXSwgRmFrZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIEZha2UuY2FsbCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm4uY2FsbChGYWtlLnByb3RvdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKHNhbXBsZSkgewogICAgICAgICAgICBpZiAoc2FtcGxlICYmIGNvbnRyb2wgJiYgdHlwZW9mIHNhbXBsZS5zdGFjayA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICB2YXIgc2FtcGxlTGluZXMgPSBzYW1wbGUuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIGNvbnRyb2xMaW5lcyA9IGNvbnRyb2wuc3RhY2suc3BsaXQoIlxuIik7CiAgICAgICAgICAgICAgdmFyIHMgPSBzYW1wbGVMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHZhciBjID0gY29udHJvbExpbmVzLmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgd2hpbGUgKHMgPj0gMSAmJiBjID49IDAgJiYgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmb3IgKDsgcyA+PSAxICYmIGMgPj0gMDsgcy0tLCBjLS0pIHsKICAgICAgICAgICAgICAgIGlmIChzYW1wbGVMaW5lc1tzXSAhPT0gY29udHJvbExpbmVzW2NdKSB7CiAgICAgICAgICAgICAgICAgIGlmIChzICE9PSAxIHx8IGMgIT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICBzLS07CiAgICAgICAgICAgICAgICAgICAgICBjLS07CiAgICAgICAgICAgICAgICAgICAgICBpZiAoYyA8IDAgfHwgc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgX2ZyYW1lID0gIlxuIiArIHNhbXBsZUxpbmVzW3NdLnJlcGxhY2UoIiBhdCBuZXcgIiwgIiBhdCAiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuLmRpc3BsYXlOYW1lICYmIF9mcmFtZS5pbmNsdWRlcygiPGFub255bW91cz4iKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIF9mcmFtZSA9IF9mcmFtZS5yZXBsYWNlKCI8YW5vbnltb3VzPiIsIGZuLmRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcG9uZW50RnJhbWVDYWNoZS5zZXQoZm4sIF9mcmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfZnJhbWU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSB3aGlsZSAocyA+PSAxICYmIGMgPj0gMCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZpb3VzRGlzcGF0Y2hlcjsKICAgICAgICAgICAgICByZWVuYWJsZUxvZ3MoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHByZXZpb3VzUHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmFtZSA9IGZuID8gZm4uZGlzcGxheU5hbWUgfHwgZm4ubmFtZSA6ICIiOwogICAgICAgICAgdmFyIHN5bnRoZXRpY0ZyYW1lID0gbmFtZSA/IGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUpIDogIiI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBjb21wb25lbnRGcmFtZUNhY2hlLnNldChmbiwgc3ludGhldGljRnJhbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc3ludGhldGljRnJhbWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlRnVuY3Rpb25Db21wb25lbnRGcmFtZShmbiwgc291cmNlLCBvd25lckZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKGZuLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZENvbnN0cnVjdChDb21wb25lbnQyKSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50Mi5wcm90b3R5cGU7CiAgICAgICAgICByZXR1cm4gISEocHJvdG90eXBlICYmIHByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKHR5cGUsIHNob3VsZENvbnN0cnVjdCh0eXBlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKHR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIGxvZ2dlZFR5cGVGYWlsdXJlcyA9IHt9OwogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tQcm9wVHlwZXModHlwZVNwZWNzLCB2YWx1ZXMsIGxvY2F0aW9uLCBjb21wb25lbnROYW1lLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXMzID0gRnVuY3Rpb24uY2FsbC5iaW5kKGhhc093blByb3BlcnR5KTsKICAgICAgICAgICAgZm9yICh2YXIgdHlwZVNwZWNOYW1lIGluIHR5cGVTcGVjcykgewogICAgICAgICAgICAgIGlmIChoYXMzKHR5cGVTcGVjcywgdHlwZVNwZWNOYW1lKSkgewogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSB2b2lkIDA7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IEVycm9yKChjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIpICsgIjogIiArIGxvY2F0aW9uICsgIiB0eXBlIGAiICsgdHlwZVNwZWNOYW1lICsgImAgaXMgaW52YWxpZDsgaXQgbXVzdCBiZSBhIGZ1bmN0aW9uLCB1c3VhbGx5IGZyb20gdGhlIGBwcm9wLXR5cGVzYCBwYWNrYWdlLCBidXQgcmVjZWl2ZWQgYCIgKyB0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gKyAiYC5UaGlzIG9mdGVuIGhhcHBlbnMgYmVjYXVzZSBvZiB0eXBvcyBzdWNoIGFzIGBQcm9wVHlwZXMuZnVuY3Rpb25gIGluc3RlYWQgb2YgYFByb3BUeXBlcy5mdW5jYC4iKTsKICAgICAgICAgICAgICAgICAgICBlcnIubmFtZSA9ICJJbnZhcmlhbnQgVmlvbGF0aW9uIjsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdKHZhbHVlcywgdHlwZVNwZWNOYW1lLCBjb21wb25lbnROYW1lLCBsb2NhdGlvbiwgbnVsbCwgIlNFQ1JFVF9ET19OT1RfUEFTU19USElTX09SX1lPVV9XSUxMX0JFX0ZJUkVEIik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChleCkgewogICAgICAgICAgICAgICAgICBlcnJvciQxID0gZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSAmJiAhKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvcikpIHsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogdHlwZSBzcGVjaWZpY2F0aW9uIG9mICVzIGAlc2AgaXMgaW52YWxpZDsgdGhlIHR5cGUgY2hlY2tlciBmdW5jdGlvbiBtdXN0IHJldHVybiBgbnVsbGAgb3IgYW4gYEVycm9yYCBidXQgcmV0dXJuZWQgYSAlcy4gWW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBwYXNzIGFuIGFyZ3VtZW50IHRvIHRoZSB0eXBlIGNoZWNrZXIgY3JlYXRvciAoYXJyYXlPZiwgaW5zdGFuY2VPZiwgb2JqZWN0T2YsIG9uZU9mLCBvbmVPZlR5cGUsIGFuZCBzaGFwZSBhbGwgcmVxdWlyZSBhbiBhcmd1bWVudCkuIiwgY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiLCBsb2NhdGlvbiwgdHlwZVNwZWNOYW1lLCB0eXBlb2YgZXJyb3IkMSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgaW5zdGFuY2VvZiBFcnJvciAmJiAhKGVycm9yJDEubWVzc2FnZSBpbiBsb2dnZWRUeXBlRmFpbHVyZXMpKSB7CiAgICAgICAgICAgICAgICAgIGxvZ2dlZFR5cGVGYWlsdXJlc1tlcnJvciQxLm1lc3NhZ2VdID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQoZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJGYWlsZWQgJXMgdHlwZTogJXMiLCBsb2NhdGlvbiwgZXJyb3IkMS5tZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgICAgIHZhciBvd25lciA9IGVsZW1lbnQuX293bmVyOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihlbGVtZW50LnR5cGUsIGVsZW1lbnQuX3NvdXJjZSwgb3duZXIgPyBvd25lci50eXBlIDogbnVsbCk7CiAgICAgICAgICAgICAgc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duOwogICAgICAgIHsKICAgICAgICAgIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpIHsKICAgICAgICAgIGlmIChSZWFjdEN1cnJlbnRPd25lci5jdXJyZW50KSB7CiAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQudHlwZSk7CiAgICAgICAgICAgIGlmIChuYW1lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBuYW1lICsgImAuIjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpIHsKICAgICAgICAgIGlmIChzb3VyY2UgIT09IHZvaWQgMCkgewogICAgICAgICAgICB2YXIgZmlsZU5hbWUgPSBzb3VyY2UuZmlsZU5hbWUucmVwbGFjZSgvXi4qW1xcXC9dLywgIiIpOwogICAgICAgICAgICB2YXIgbGluZU51bWJlciA9IHNvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICByZXR1cm4gIlxuXG5DaGVjayB5b3VyIGNvZGUgYXQgIiArIGZpbGVOYW1lICsgIjoiICsgbGluZU51bWJlciArICIuIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW1Gb3JQcm9wcyhlbGVtZW50UHJvcHMpIHsKICAgICAgICAgIGlmIChlbGVtZW50UHJvcHMgIT09IG51bGwgJiYgZWxlbWVudFByb3BzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIGdldFNvdXJjZUluZm9FcnJvckFkZGVuZHVtKGVsZW1lbnRQcm9wcy5fX3NvdXJjZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHZhciBvd25lckhhc0tleVVzZVdhcm5pbmcgPSB7fTsKICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpIHsKICAgICAgICAgIHZhciBpbmZvID0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICBpZiAoIWluZm8pIHsKICAgICAgICAgICAgdmFyIHBhcmVudE5hbWUgPSB0eXBlb2YgcGFyZW50VHlwZSA9PT0gInN0cmluZyIgPyBwYXJlbnRUeXBlIDogcGFyZW50VHlwZS5kaXNwbGF5TmFtZSB8fCBwYXJlbnRUeXBlLm5hbWU7CiAgICAgICAgICAgIGlmIChwYXJlbnROYW1lKSB7CiAgICAgICAgICAgICAgaW5mbyA9ICJcblxuQ2hlY2sgdGhlIHRvcC1sZXZlbCByZW5kZXIgY2FsbCB1c2luZyA8IiArIHBhcmVudE5hbWUgKyAiPi4iOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVFeHBsaWNpdEtleShlbGVtZW50LCBwYXJlbnRUeXBlKSB7CiAgICAgICAgICBpZiAoIWVsZW1lbnQuX3N0b3JlIHx8IGVsZW1lbnQuX3N0b3JlLnZhbGlkYXRlZCB8fCBlbGVtZW50LmtleSAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGVsZW1lbnQuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICB2YXIgY3VycmVudENvbXBvbmVudEVycm9ySW5mbyA9IGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSk7CiAgICAgICAgICBpZiAob3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSA9IHRydWU7CiAgICAgICAgICB2YXIgY2hpbGRPd25lciA9ICIiOwogICAgICAgICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5fb3duZXIgJiYgZWxlbWVudC5fb3duZXIgIT09IFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQpIHsKICAgICAgICAgICAgY2hpbGRPd25lciA9ICIgSXQgd2FzIHBhc3NlZCBhIGNoaWxkIGZyb20gIiArIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShlbGVtZW50Ll9vd25lci50eXBlKSArICIuIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShlbGVtZW50KTsKICAgICAgICAgICAgZXJyb3IoJ0VhY2ggY2hpbGQgaW4gYSBsaXN0IHNob3VsZCBoYXZlIGEgdW5pcXVlICJrZXkiIHByb3AuJXMlcyBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dhcm5pbmcta2V5cyBmb3IgbW9yZSBpbmZvcm1hdGlvbi4nLCBjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvLCBjaGlsZE93bmVyKTsKICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQkMShudWxsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVDaGlsZEtleXMobm9kZSwgcGFyZW50VHlwZSkgewogICAgICAgICAgaWYgKHR5cGVvZiBub2RlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNBcnJheTIobm9kZSkpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2RlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZVtpXTsKICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQxNShjaGlsZCkpIHsKICAgICAgICAgICAgICAgIHZhbGlkYXRlRXhwbGljaXRLZXkoY2hpbGQsIHBhcmVudFR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChpc1ZhbGlkRWxlbWVudDE1KG5vZGUpKSB7CiAgICAgICAgICAgIGlmIChub2RlLl9zdG9yZSkgewogICAgICAgICAgICAgIG5vZGUuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAobm9kZSkgewogICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4obm9kZSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmIChpdGVyYXRvckZuICE9PSBub2RlLmVudHJpZXMpIHsKICAgICAgICAgICAgICAgIHZhciBpdGVyYXRvciA9IGl0ZXJhdG9yRm4uY2FsbChub2RlKTsKICAgICAgICAgICAgICAgIHZhciBzdGVwOwogICAgICAgICAgICAgICAgd2hpbGUgKCEoc3RlcCA9IGl0ZXJhdG9yLm5leHQoKSkuZG9uZSkgewogICAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQxNShzdGVwLnZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRXhwbGljaXRLZXkoc3RlcC52YWx1ZSwgcGFyZW50VHlwZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwgfHwgdHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyIHx8IC8vIE5vdGU6IE1lbW8gb25seSBjaGVja3Mgb3V0ZXIgcHJvcHMgaGVyZS4KICAgICAgICAgICAgLy8gSW5uZXIgcHJvcHMgYXJlIGNoZWNrZWQgaW4gdGhlIHJlY29uY2lsZXIuCiAgICAgICAgICAgIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRTIpKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzID0gdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wVHlwZXMpIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhwcm9wVHlwZXMsIGVsZW1lbnQucHJvcHMsICJwcm9wIiwgbmFtZSwgZWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZS5Qcm9wVHlwZXMgIT09IHZvaWQgMCAmJiAhcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIF9uYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgIGVycm9yKCJDb21wb25lbnQgJXMgZGVjbGFyZWQgYFByb3BUeXBlc2AgaW5zdGVhZCBvZiBgcHJvcFR5cGVzYC4gRGlkIHlvdSBtaXNzcGVsbCB0aGUgcHJvcGVydHkgYXNzaWdubWVudD8iLCBfbmFtZSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS5nZXREZWZhdWx0UHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgIXR5cGUuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyBpcyBvbmx5IHVzZWQgb24gY2xhc3NpYyBSZWFjdC5jcmVhdGVDbGFzcyBkZWZpbml0aW9ucy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IG5hbWVkIGBkZWZhdWx0UHJvcHNgIGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGcmFnbWVudFByb3BzKGZyYWdtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZnJhZ21lbnQucHJvcHMpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICBpZiAoa2V5ICE9PSAiY2hpbGRyZW4iICYmIGtleSAhPT0gImtleSIpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgcHJvcCBgJXNgIHN1cHBsaWVkIHRvIGBSZWFjdC5GcmFnbWVudGAuIFJlYWN0LkZyYWdtZW50IGNhbiBvbmx5IGhhdmUgYGtleWAgYW5kIGBjaGlsZHJlbmAgcHJvcHMuIiwga2V5KTsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZyYWdtZW50LnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBgcmVmYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiIpOwogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRWxlbWVudFdpdGhWYWxpZGF0aW9uKHR5cGUsIHByb3BzLCBjaGlsZHJlbikgewogICAgICAgICAgdmFyIHZhbGlkVHlwZSA9IGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKTsKICAgICAgICAgIGlmICghdmFsaWRUeXBlKSB7CiAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgIGlmICh0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwgJiYgT2JqZWN0LmtleXModHlwZSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgaW5mbyArPSAiIFlvdSBsaWtlbHkgZm9yZ290IHRvIGV4cG9ydCB5b3VyIGNvbXBvbmVudCBmcm9tIHRoZSBmaWxlIGl0J3MgZGVmaW5lZCBpbiwgb3IgeW91IG1pZ2h0IGhhdmUgbWl4ZWQgdXAgZGVmYXVsdCBhbmQgbmFtZWQgaW1wb3J0cy4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzb3VyY2VJbmZvID0gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW1Gb3JQcm9wcyhwcm9wcyk7CiAgICAgICAgICAgIGlmIChzb3VyY2VJbmZvKSB7CiAgICAgICAgICAgICAgaW5mbyArPSBzb3VyY2VJbmZvOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGluZm8gKz0gZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHR5cGVTdHJpbmc7CiAgICAgICAgICAgIGlmICh0eXBlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICJudWxsIjsKICAgICAgICAgICAgfSBlbHNlIGlmIChpc0FycmF5Mih0eXBlKSkgewogICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAiYXJyYXkiOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgIT09IHZvaWQgMCAmJiB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gIjwiICsgKGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlLnR5cGUpIHx8ICJVbmtub3duIikgKyAiIC8+IjsKICAgICAgICAgICAgICBpbmZvID0gIiBEaWQgeW91IGFjY2lkZW50YWxseSBleHBvcnQgYSBKU1ggbGl0ZXJhbCBpbnN0ZWFkIG9mIGEgY29tcG9uZW50PyI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdHlwZVN0cmluZyA9IHR5cGVvZiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiUmVhY3QuY3JlYXRlRWxlbWVudDogdHlwZSBpcyBpbnZhbGlkIC0tIGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgYnVpbHQtaW4gY29tcG9uZW50cykgb3IgYSBjbGFzcy9mdW5jdGlvbiAoZm9yIGNvbXBvc2l0ZSBjb21wb25lbnRzKSBidXQgZ290OiAlcy4lcyIsIHR5cGVTdHJpbmcsIGluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQzOS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgaWYgKGVsZW1lbnQgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gZWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh2YWxpZFR5cGUpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YWxpZGF0ZUNoaWxkS2V5cyhhcmd1bWVudHNbaV0sIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICB2YWxpZGF0ZUZyYWdtZW50UHJvcHMoZWxlbWVudCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YWxpZGF0ZVByb3BUeXBlcyhlbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0RGVwcmVjYXRlZENyZWF0ZUZhY3RvcnkgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVGYWN0b3J5V2l0aFZhbGlkYXRpb24odHlwZSkgewogICAgICAgICAgdmFyIHZhbGlkYXRlZEZhY3RvcnkgPSBjcmVhdGVFbGVtZW50V2l0aFZhbGlkYXRpb24uYmluZChudWxsLCB0eXBlKTsKICAgICAgICAgIHZhbGlkYXRlZEZhY3RvcnkudHlwZSA9IHR5cGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RGVwcmVjYXRlZENyZWF0ZUZhY3RvcnkpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXREZXByZWNhdGVkQ3JlYXRlRmFjdG9yeSA9IHRydWU7CiAgICAgICAgICAgICAgd2FybjMoIlJlYWN0LmNyZWF0ZUZhY3RvcnkoKSBpcyBkZXByZWNhdGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gQ29uc2lkZXIgdXNpbmcgSlNYIG9yIHVzZSBSZWFjdC5jcmVhdGVFbGVtZW50KCkgZGlyZWN0bHkgaW5zdGVhZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodmFsaWRhdGVkRmFjdG9yeSwgInR5cGUiLCB7CiAgICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHdhcm4zKCJGYWN0b3J5LnR5cGUgaXMgZGVwcmVjYXRlZC4gQWNjZXNzIHRoZSBjbGFzcyBkaXJlY3RseSBiZWZvcmUgcGFzc2luZyBpdCB0byBjcmVhdGVGYWN0b3J5LiIpOwogICAgICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICJ0eXBlIiwgewogICAgICAgICAgICAgICAgICB2YWx1ZTogdHlwZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbGlkYXRlZEZhY3Rvcnk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNsb25lRWxlbWVudFdpdGhWYWxpZGF0aW9uKGVsZW1lbnQsIHByb3BzLCBjaGlsZHJlbikgewogICAgICAgICAgdmFyIG5ld0VsZW1lbnQgPSBjbG9uZUVsZW1lbnQ4LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICBmb3IgKHZhciBpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YWxpZGF0ZUNoaWxkS2V5cyhhcmd1bWVudHNbaV0sIG5ld0VsZW1lbnQudHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YWxpZGF0ZVByb3BUeXBlcyhuZXdFbGVtZW50KTsKICAgICAgICAgIHJldHVybiBuZXdFbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFRyYW5zaXRpb24oc2NvcGUsIG9wdGlvbnMpIHsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb247CiAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0ge307CiAgICAgICAgICB2YXIgY3VycmVudFRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNjb3BlKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAocHJldlRyYW5zaXRpb24gPT09IG51bGwgJiYgY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMpIHsKICAgICAgICAgICAgICAgIHZhciB1cGRhdGVkRmliZXJzQ291bnQgPSBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5zaXplOwogICAgICAgICAgICAgICAgaWYgKHVwZGF0ZWRGaWJlcnNDb3VudCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgIHdhcm4zKCJEZXRlY3RlZCBhIGxhcmdlIG51bWJlciBvZiB1cGRhdGVzIGluc2lkZSBzdGFydFRyYW5zaXRpb24uIElmIHRoaXMgaXMgZHVlIHRvIGEgc3Vic2NyaXB0aW9uIHBsZWFzZSByZS13cml0ZSBpdCB0byB1c2UgUmVhY3QgcHJvdmlkZWQgaG9va3MuIE90aGVyd2lzZSBjb25jdXJyZW50IG1vZGUgZ3VhcmFudGVlcyBhcmUgb2ZmIHRoZSB0YWJsZS4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzLmNsZWFyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNZXNzYWdlQ2hhbm5lbCA9IGZhbHNlOwogICAgICAgIHZhciBlbnF1ZXVlVGFza0ltcGwgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIGVucXVldWVUYXNrKHRhc2syKSB7CiAgICAgICAgICBpZiAoZW5xdWV1ZVRhc2tJbXBsID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIHJlcXVpcmVTdHJpbmcgPSAoInJlcXVpcmUiICsgTWF0aC5yYW5kb20oKSkuc2xpY2UoMCwgNyk7CiAgICAgICAgICAgICAgdmFyIG5vZGVSZXF1aXJlID0gbW9kdWxlICYmIG1vZHVsZVtyZXF1aXJlU3RyaW5nXTsKICAgICAgICAgICAgICBlbnF1ZXVlVGFza0ltcGwgPSBub2RlUmVxdWlyZS5jYWxsKG1vZHVsZSwgInRpbWVycyIpLnNldEltbWVkaWF0ZTsKICAgICAgICAgICAgfSBjYXRjaCAoX2VycikgewogICAgICAgICAgICAgIGVucXVldWVUYXNrSW1wbCA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChkaWRXYXJuQWJvdXRNZXNzYWdlQ2hhbm5lbCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRNZXNzYWdlQ2hhbm5lbCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBNZXNzYWdlQ2hhbm5lbCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGlzIGJyb3dzZXIgZG9lcyBub3QgaGF2ZSBhIE1lc3NhZ2VDaGFubmVsIGltcGxlbWVudGF0aW9uLCBzbyBlbnF1ZXVpbmcgdGFza3MgdmlhIGF3YWl0IGFjdChhc3luYyAoKSA9PiAuLi4pIHdpbGwgZmFpbC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUgYXQgaHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL3JlYWN0L2lzc3VlcyBpZiB5b3UgZW5jb3VudGVyIHRoaXMgd2FybmluZy4iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjaGFubmVsID0gbmV3IE1lc3NhZ2VDaGFubmVsKCk7CiAgICAgICAgICAgICAgICBjaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IGNhbGxiYWNrOwogICAgICAgICAgICAgICAgY2hhbm5lbC5wb3J0Mi5wb3N0TWVzc2FnZSh2b2lkIDApOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbnF1ZXVlVGFza0ltcGwodGFzazIpOwogICAgICAgIH0KICAgICAgICB2YXIgYWN0U2NvcGVEZXB0aCA9IDA7CiAgICAgICAgdmFyIGRpZFdhcm5Ob0F3YWl0QWN0ID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gYWN0KGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwcmV2QWN0U2NvcGVEZXB0aCA9IGFjdFNjb3BlRGVwdGg7CiAgICAgICAgICAgIGFjdFNjb3BlRGVwdGgrKzsKICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByZXZJc0JhdGNoaW5nTGVnYWN5ID0gUmVhY3RDdXJyZW50QWN0UXVldWUuaXNCYXRjaGluZ0xlZ2FjeTsKICAgICAgICAgICAgdmFyIHJlc3VsdDsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5pc0JhdGNoaW5nTGVnYWN5ID0gdHJ1ZTsKICAgICAgICAgICAgICByZXN1bHQgPSBjYWxsYmFjaygpOwogICAgICAgICAgICAgIGlmICghcHJldklzQmF0Y2hpbmdMZWdhY3kgJiYgUmVhY3RDdXJyZW50QWN0UXVldWUuZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHZhciBxdWV1ZSA9IFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICBpZiAocXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QWN0UXVldWUuZGlkU2NoZWR1bGVMZWdhY3lVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgZmx1c2hBY3RRdWV1ZShxdWV1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBwb3BBY3RTY29wZShwcmV2QWN0U2NvcGVEZXB0aCk7CiAgICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmlzQmF0Y2hpbmdMZWdhY3kgPSBwcmV2SXNCYXRjaGluZ0xlZ2FjeTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVzdWx0ICE9PSBudWxsICYmIHR5cGVvZiByZXN1bHQgPT09ICJvYmplY3QiICYmIHR5cGVvZiByZXN1bHQudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciB0aGVuYWJsZVJlc3VsdCA9IHJlc3VsdDsKICAgICAgICAgICAgICB2YXIgd2FzQXdhaXRlZCA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciB0aGVuYWJsZSA9IHsKICAgICAgICAgICAgICAgIHRoZW46IGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgICAgICAgICAgICB3YXNBd2FpdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdGhlbmFibGVSZXN1bHQudGhlbihmdW5jdGlvbihyZXR1cm5WYWx1ZTIpIHsKICAgICAgICAgICAgICAgICAgICBwb3BBY3RTY29wZShwcmV2QWN0U2NvcGVEZXB0aCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdFNjb3BlRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUyLCByZXNvbHZlLCByZWplY3QpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJldHVyblZhbHVlMik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbihlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBwb3BBY3RTY29wZShwcmV2QWN0U2NvcGVEZXB0aCk7CiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuTm9Bd2FpdEFjdCAmJiB0eXBlb2YgUHJvbWlzZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXdhc0F3YWl0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgIGRpZFdhcm5Ob0F3YWl0QWN0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJZb3UgY2FsbGVkIGFjdChhc3luYyAoKSA9PiAuLi4pIHdpdGhvdXQgYXdhaXQuIFRoaXMgY291bGQgbGVhZCB0byB1bmV4cGVjdGVkIHRlc3RpbmcgYmVoYXZpb3VyLCBpbnRlcmxlYXZpbmcgbXVsdGlwbGUgYWN0IGNhbGxzIGFuZCBtaXhpbmcgdGhlaXIgc2NvcGVzLiBZb3Ugc2hvdWxkIC0gYXdhaXQgYWN0KGFzeW5jICgpID0+IC4uLik7Iik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHRoZW5hYmxlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByZXR1cm5WYWx1ZSA9IHJlc3VsdDsKICAgICAgICAgICAgICBwb3BBY3RTY29wZShwcmV2QWN0U2NvcGVEZXB0aCk7CiAgICAgICAgICAgICAgaWYgKGFjdFNjb3BlRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgIHZhciBfcXVldWUgPSBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKF9xdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmbHVzaEFjdFF1ZXVlKF9xdWV1ZSk7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIF90aGVuYWJsZSA9IHsKICAgICAgICAgICAgICAgICAgdGhlbjogZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudEFjdFF1ZXVlLmN1cnJlbnQgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5Rmx1c2hBc3luY0FjdFdvcmsocmV0dXJuVmFsdWUsIHJlc29sdmUsIHJlamVjdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dXJuVmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhlbmFibGU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBfdGhlbmFibGUyID0gewogICAgICAgICAgICAgICAgICB0aGVuOiBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJldHVyblZhbHVlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhlbmFibGUyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BBY3RTY29wZShwcmV2QWN0U2NvcGVEZXB0aCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJldkFjdFNjb3BlRGVwdGggIT09IGFjdFNjb3BlRGVwdGggLSAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBzZWVtIHRvIGhhdmUgb3ZlcmxhcHBpbmcgYWN0KCkgY2FsbHMsIHRoaXMgaXMgbm90IHN1cHBvcnRlZC4gQmUgc3VyZSB0byBhd2FpdCBwcmV2aW91cyBhY3QoKSBjYWxscyBiZWZvcmUgbWFraW5nIGEgbmV3IG9uZS4gIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYWN0U2NvcGVEZXB0aCA9IHByZXZBY3RTY29wZURlcHRoOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWN1cnNpdmVseUZsdXNoQXN5bmNBY3RXb3JrKHJldHVyblZhbHVlLCByZXNvbHZlLCByZWplY3QpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHF1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUuY3VycmVudDsKICAgICAgICAgICAgaWYgKHF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZsdXNoQWN0UXVldWUocXVldWUpOwogICAgICAgICAgICAgICAgZW5xdWV1ZVRhc2soZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIGlmIChxdWV1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJldHVyblZhbHVlKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZWN1cnNpdmVseUZsdXNoQXN5bmNBY3RXb3JrKHJldHVyblZhbHVlLCByZXNvbHZlLCByZWplY3QpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXNvbHZlKHJldHVyblZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaXNGbHVzaGluZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGZsdXNoQWN0UXVldWUocXVldWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFpc0ZsdXNoaW5nKSB7CiAgICAgICAgICAgICAgaXNGbHVzaGluZyA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBmb3IgKDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHF1ZXVlW2ldOwogICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBjYWxsYmFjayh0cnVlKTsKICAgICAgICAgICAgICAgICAgfSB3aGlsZSAoY2FsbGJhY2sgIT09IG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcXVldWUubGVuZ3RoID0gMDsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIHF1ZXVlID0gcXVldWUuc2xpY2UoaSArIDEpOwogICAgICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBpc0ZsdXNoaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjcmVhdGVFbGVtZW50JDEgPSBjcmVhdGVFbGVtZW50V2l0aFZhbGlkYXRpb247CiAgICAgICAgdmFyIGNsb25lRWxlbWVudCQxID0gY2xvbmVFbGVtZW50V2l0aFZhbGlkYXRpb247CiAgICAgICAgdmFyIGNyZWF0ZUZhY3RvcnkgPSBjcmVhdGVGYWN0b3J5V2l0aFZhbGlkYXRpb247CiAgICAgICAgdmFyIENoaWxkcmVuMiA9IHsKICAgICAgICAgIG1hcDogbWFwQ2hpbGRyZW4sCiAgICAgICAgICBmb3JFYWNoOiBmb3JFYWNoQ2hpbGRyZW4sCiAgICAgICAgICBjb3VudDogY291bnRDaGlsZHJlbiwKICAgICAgICAgIHRvQXJyYXk6IHRvQXJyYXkyLAogICAgICAgICAgb25seTogb25seUNoaWxkCiAgICAgICAgfTsKICAgICAgICBleHBvcnRzLkNoaWxkcmVuID0gQ2hpbGRyZW4yOwogICAgICAgIGV4cG9ydHMuQ29tcG9uZW50ID0gQ29tcG9uZW50OwogICAgICAgIGV4cG9ydHMuRnJhZ21lbnQgPSBSRUFDVF9GUkFHTUVOVF9UWVBFOwogICAgICAgIGV4cG9ydHMuUHJvZmlsZXIgPSBSRUFDVF9QUk9GSUxFUl9UWVBFOwogICAgICAgIGV4cG9ydHMuUHVyZUNvbXBvbmVudCA9IFB1cmVDb21wb25lbnQzOwogICAgICAgIGV4cG9ydHMuU3RyaWN0TW9kZSA9IFJFQUNUX1NUUklDVF9NT0RFX1RZUEU7CiAgICAgICAgZXhwb3J0cy5TdXNwZW5zZSA9IFJFQUNUX1NVU1BFTlNFX1RZUEU7CiAgICAgICAgZXhwb3J0cy5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzOwogICAgICAgIGV4cG9ydHMuYWN0ID0gYWN0OwogICAgICAgIGV4cG9ydHMuY2xvbmVFbGVtZW50ID0gY2xvbmVFbGVtZW50JDE7CiAgICAgICAgZXhwb3J0cy5jcmVhdGVDb250ZXh0ID0gY3JlYXRlQ29udGV4dDEyOwogICAgICAgIGV4cG9ydHMuY3JlYXRlRWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQkMTsKICAgICAgICBleHBvcnRzLmNyZWF0ZUZhY3RvcnkgPSBjcmVhdGVGYWN0b3J5OwogICAgICAgIGV4cG9ydHMuY3JlYXRlUmVmID0gY3JlYXRlUmVmOwogICAgICAgIGV4cG9ydHMuZm9yd2FyZFJlZiA9IGZvcndhcmRSZWYxNTsKICAgICAgICBleHBvcnRzLmlzVmFsaWRFbGVtZW50ID0gaXNWYWxpZEVsZW1lbnQxNTsKICAgICAgICBleHBvcnRzLmxhenkgPSBsYXp5OwogICAgICAgIGV4cG9ydHMubWVtbyA9IG1lbW83OwogICAgICAgIGV4cG9ydHMuc3RhcnRUcmFuc2l0aW9uID0gc3RhcnRUcmFuc2l0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfYWN0ID0gYWN0OwogICAgICAgIGV4cG9ydHMudXNlQ2FsbGJhY2sgPSB1c2VDYWxsYmFjazg7CiAgICAgICAgZXhwb3J0cy51c2VDb250ZXh0ID0gdXNlQ29udGV4dDEyOwogICAgICAgIGV4cG9ydHMudXNlRGVidWdWYWx1ZSA9IHVzZURlYnVnVmFsdWUyOwogICAgICAgIGV4cG9ydHMudXNlRGVmZXJyZWRWYWx1ZSA9IHVzZURlZmVycmVkVmFsdWU7CiAgICAgICAgZXhwb3J0cy51c2VFZmZlY3QgPSB1c2VFZmZlY3QxNDsKICAgICAgICBleHBvcnRzLnVzZUlkID0gdXNlSWQyOwogICAgICAgIGV4cG9ydHMudXNlSW1wZXJhdGl2ZUhhbmRsZSA9IHVzZUltcGVyYXRpdmVIYW5kbGUzOwogICAgICAgIGV4cG9ydHMudXNlSW5zZXJ0aW9uRWZmZWN0ID0gdXNlSW5zZXJ0aW9uRWZmZWN0OwogICAgICAgIGV4cG9ydHMudXNlTGF5b3V0RWZmZWN0ID0gdXNlTGF5b3V0RWZmZWN0OTsKICAgICAgICBleHBvcnRzLnVzZU1lbW8gPSB1c2VNZW1vOTsKICAgICAgICBleHBvcnRzLnVzZVJlZHVjZXIgPSB1c2VSZWR1Y2VyOwogICAgICAgIGV4cG9ydHMudXNlUmVmID0gdXNlUmVmMTY7CiAgICAgICAgZXhwb3J0cy51c2VTdGF0ZSA9IHVzZVN0YXRlMTM7CiAgICAgICAgZXhwb3J0cy51c2VTeW5jRXh0ZXJuYWxTdG9yZSA9IHVzZVN5bmNFeHRlcm5hbFN0b3JlMjsKICAgICAgICBleHBvcnRzLnVzZVRyYW5zaXRpb24gPSB1c2VUcmFuc2l0aW9uOwogICAgICAgIGV4cG9ydHMudmVyc2lvbiA9IFJlYWN0VmVyc2lvbjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0L2luZGV4LmpzCnZhciByZXF1aXJlX3JlYWN0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0L2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfcmVhY3RfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3NjaGVkdWxlckAwLjIzLjIvbm9kZV9tb2R1bGVzL3NjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3NjaGVkdWxlcl9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vc2NoZWR1bGVyQDAuMjMuMi9ub2RlX21vZHVsZXMvc2NoZWR1bGVyL2Nqcy9zY2hlZHVsZXIuZGV2ZWxvcG1lbnQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmICh0cnVlKSB7CiAgICAgIChmdW5jdGlvbigpIHsKICAgICAgICAidXNlIHN0cmljdCI7CiAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0KG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgICAgdmFyIGVuYWJsZVNjaGVkdWxlckRlYnVnZ2luZyA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVQcm9maWxpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZnJhbWVZaWVsZE1zID0gNTsKICAgICAgICBmdW5jdGlvbiBwdXNoKGhlYXAsIG5vZGUpIHsKICAgICAgICAgIHZhciBpbmRleCA9IGhlYXAubGVuZ3RoOwogICAgICAgICAgaGVhcC5wdXNoKG5vZGUpOwogICAgICAgICAgc2lmdFVwKGhlYXAsIG5vZGUsIGluZGV4KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGVlazMoaGVhcCkgewogICAgICAgICAgcmV0dXJuIGhlYXAubGVuZ3RoID09PSAwID8gbnVsbCA6IGhlYXBbMF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcChoZWFwKSB7CiAgICAgICAgICBpZiAoaGVhcC5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmlyc3QgPSBoZWFwWzBdOwogICAgICAgICAgdmFyIGxhc3QyID0gaGVhcC5wb3AoKTsKICAgICAgICAgIGlmIChsYXN0MiAhPT0gZmlyc3QpIHsKICAgICAgICAgICAgaGVhcFswXSA9IGxhc3QyOwogICAgICAgICAgICBzaWZ0RG93bihoZWFwLCBsYXN0MiwgMCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmlyc3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNpZnRVcChoZWFwLCBub2RlLCBpKSB7CiAgICAgICAgICB2YXIgaW5kZXggPSBpOwogICAgICAgICAgd2hpbGUgKGluZGV4ID4gMCkgewogICAgICAgICAgICB2YXIgcGFyZW50SW5kZXggPSBpbmRleCAtIDEgPj4+IDE7CiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBoZWFwW3BhcmVudEluZGV4XTsKICAgICAgICAgICAgaWYgKGNvbXBhcmUocGFyZW50LCBub2RlKSA+IDApIHsKICAgICAgICAgICAgICBoZWFwW3BhcmVudEluZGV4XSA9IG5vZGU7CiAgICAgICAgICAgICAgaGVhcFtpbmRleF0gPSBwYXJlbnQ7CiAgICAgICAgICAgICAgaW5kZXggPSBwYXJlbnRJbmRleDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2lmdERvd24oaGVhcCwgbm9kZSwgaSkgewogICAgICAgICAgdmFyIGluZGV4ID0gaTsKICAgICAgICAgIHZhciBsZW5ndGggPSBoZWFwLmxlbmd0aDsKICAgICAgICAgIHZhciBoYWxmTGVuZ3RoID0gbGVuZ3RoID4+PiAxOwogICAgICAgICAgd2hpbGUgKGluZGV4IDwgaGFsZkxlbmd0aCkgewogICAgICAgICAgICB2YXIgbGVmdEluZGV4ID0gKGluZGV4ICsgMSkgKiAyIC0gMTsKICAgICAgICAgICAgdmFyIGxlZnQgPSBoZWFwW2xlZnRJbmRleF07CiAgICAgICAgICAgIHZhciByaWdodEluZGV4ID0gbGVmdEluZGV4ICsgMTsKICAgICAgICAgICAgdmFyIHJpZ2h0ID0gaGVhcFtyaWdodEluZGV4XTsKICAgICAgICAgICAgaWYgKGNvbXBhcmUobGVmdCwgbm9kZSkgPCAwKSB7CiAgICAgICAgICAgICAgaWYgKHJpZ2h0SW5kZXggPCBsZW5ndGggJiYgY29tcGFyZShyaWdodCwgbGVmdCkgPCAwKSB7CiAgICAgICAgICAgICAgICBoZWFwW2luZGV4XSA9IHJpZ2h0OwogICAgICAgICAgICAgICAgaGVhcFtyaWdodEluZGV4XSA9IG5vZGU7CiAgICAgICAgICAgICAgICBpbmRleCA9IHJpZ2h0SW5kZXg7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGhlYXBbaW5kZXhdID0gbGVmdDsKICAgICAgICAgICAgICAgIGhlYXBbbGVmdEluZGV4XSA9IG5vZGU7CiAgICAgICAgICAgICAgICBpbmRleCA9IGxlZnRJbmRleDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmlnaHRJbmRleCA8IGxlbmd0aCAmJiBjb21wYXJlKHJpZ2h0LCBub2RlKSA8IDApIHsKICAgICAgICAgICAgICBoZWFwW2luZGV4XSA9IHJpZ2h0OwogICAgICAgICAgICAgIGhlYXBbcmlnaHRJbmRleF0gPSBub2RlOwogICAgICAgICAgICAgIGluZGV4ID0gcmlnaHRJbmRleDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGFyZShhLCBiKSB7CiAgICAgICAgICB2YXIgZGlmZiA9IGEuc29ydEluZGV4IC0gYi5zb3J0SW5kZXg7CiAgICAgICAgICByZXR1cm4gZGlmZiAhPT0gMCA/IGRpZmYgOiBhLmlkIC0gYi5pZDsKICAgICAgICB9CiAgICAgICAgdmFyIEltbWVkaWF0ZVByaW9yaXR5ID0gMTsKICAgICAgICB2YXIgVXNlckJsb2NraW5nUHJpb3JpdHkgPSAyOwogICAgICAgIHZhciBOb3JtYWxQcmlvcml0eSA9IDM7CiAgICAgICAgdmFyIExvd1ByaW9yaXR5ID0gNDsKICAgICAgICB2YXIgSWRsZVByaW9yaXR5ID0gNTsKICAgICAgICBmdW5jdGlvbiBtYXJrVGFza0Vycm9yZWQodGFzazIsIG1zKSB7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNQZXJmb3JtYW5jZU5vdyA9IHR5cGVvZiBwZXJmb3JtYW5jZSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHBlcmZvcm1hbmNlLm5vdyA9PT0gImZ1bmN0aW9uIjsKICAgICAgICBpZiAoaGFzUGVyZm9ybWFuY2VOb3cpIHsKICAgICAgICAgIHZhciBsb2NhbFBlcmZvcm1hbmNlID0gcGVyZm9ybWFuY2U7CiAgICAgICAgICBleHBvcnRzLnVuc3RhYmxlX25vdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gbG9jYWxQZXJmb3JtYW5jZS5ub3coKTsKICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBsb2NhbERhdGUyID0gRGF0ZTsKICAgICAgICAgIHZhciBpbml0aWFsVGltZSA9IGxvY2FsRGF0ZTIubm93KCk7CiAgICAgICAgICBleHBvcnRzLnVuc3RhYmxlX25vdyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gbG9jYWxEYXRlMi5ub3coKSAtIGluaXRpYWxUaW1lOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIG1heFNpZ25lZDMxQml0SW50ID0gMTA3Mzc0MTgyMzsKICAgICAgICB2YXIgSU1NRURJQVRFX1BSSU9SSVRZX1RJTUVPVVQgPSAtMTsKICAgICAgICB2YXIgVVNFUl9CTE9DS0lOR19QUklPUklUWV9USU1FT1VUID0gMjUwOwogICAgICAgIHZhciBOT1JNQUxfUFJJT1JJVFlfVElNRU9VVCA9IDVlMzsKICAgICAgICB2YXIgTE9XX1BSSU9SSVRZX1RJTUVPVVQgPSAxZTQ7CiAgICAgICAgdmFyIElETEVfUFJJT1JJVFlfVElNRU9VVCA9IG1heFNpZ25lZDMxQml0SW50OwogICAgICAgIHZhciB0YXNrUXVldWUgPSBbXTsKICAgICAgICB2YXIgdGltZXJRdWV1ZSA9IFtdOwogICAgICAgIHZhciB0YXNrSWRDb3VudGVyID0gMTsKICAgICAgICB2YXIgY3VycmVudFRhc2sgPSBudWxsOwogICAgICAgIHZhciBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgIHZhciBpc1BlcmZvcm1pbmdXb3JrID0gZmFsc2U7CiAgICAgICAgdmFyIGlzSG9zdENhbGxiYWNrU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgdmFyIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICB2YXIgbG9jYWxTZXRUaW1lb3V0ID0gdHlwZW9mIHNldFRpbWVvdXQgPT09ICJmdW5jdGlvbiIgPyBzZXRUaW1lb3V0IDogbnVsbDsKICAgICAgICB2YXIgbG9jYWxDbGVhclRpbWVvdXQgPSB0eXBlb2YgY2xlYXJUaW1lb3V0ID09PSAiZnVuY3Rpb24iID8gY2xlYXJUaW1lb3V0IDogbnVsbDsKICAgICAgICB2YXIgbG9jYWxTZXRJbW1lZGlhdGUgPSB0eXBlb2Ygc2V0SW1tZWRpYXRlICE9PSAidW5kZWZpbmVkIiA/IHNldEltbWVkaWF0ZSA6IG51bGw7CiAgICAgICAgdmFyIGlzSW5wdXRQZW5kaW5nID0gdHlwZW9mIG5hdmlnYXRvciAhPT0gInVuZGVmaW5lZCIgJiYgbmF2aWdhdG9yLnNjaGVkdWxpbmcgIT09IHZvaWQgMCAmJiBuYXZpZ2F0b3Iuc2NoZWR1bGluZy5pc0lucHV0UGVuZGluZyAhPT0gdm9pZCAwID8gbmF2aWdhdG9yLnNjaGVkdWxpbmcuaXNJbnB1dFBlbmRpbmcuYmluZChuYXZpZ2F0b3Iuc2NoZWR1bGluZykgOiBudWxsOwogICAgICAgIGZ1bmN0aW9uIGFkdmFuY2VUaW1lcnMoY3VycmVudFRpbWUpIHsKICAgICAgICAgIHZhciB0aW1lciA9IHBlZWszKHRpbWVyUXVldWUpOwogICAgICAgICAgd2hpbGUgKHRpbWVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0aW1lci5jYWxsYmFjayA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHBvcCh0aW1lclF1ZXVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aW1lci5zdGFydFRpbWUgPD0gY3VycmVudFRpbWUpIHsKICAgICAgICAgICAgICBwb3AodGltZXJRdWV1ZSk7CiAgICAgICAgICAgICAgdGltZXIuc29ydEluZGV4ID0gdGltZXIuZXhwaXJhdGlvblRpbWU7CiAgICAgICAgICAgICAgcHVzaCh0YXNrUXVldWUsIHRpbWVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGltZXIgPSBwZWVrMyh0aW1lclF1ZXVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlVGltZW91dChjdXJyZW50VGltZSkgewogICAgICAgICAgaXNIb3N0VGltZW91dFNjaGVkdWxlZCA9IGZhbHNlOwogICAgICAgICAgYWR2YW5jZVRpbWVycyhjdXJyZW50VGltZSk7CiAgICAgICAgICBpZiAoIWlzSG9zdENhbGxiYWNrU2NoZWR1bGVkKSB7CiAgICAgICAgICAgIGlmIChwZWVrMyh0YXNrUXVldWUpICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICAgIHJlcXVlc3RIb3N0Q2FsbGJhY2soZmx1c2hXb3JrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZmlyc3RUaW1lciA9IHBlZWszKHRpbWVyUXVldWUpOwogICAgICAgICAgICAgIGlmIChmaXJzdFRpbWVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXF1ZXN0SG9zdFRpbWVvdXQoaGFuZGxlVGltZW91dCwgZmlyc3RUaW1lci5zdGFydFRpbWUgLSBjdXJyZW50VGltZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoV29yayhoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpIHsKICAgICAgICAgIGlzSG9zdENhbGxiYWNrU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICBpZiAoaXNIb3N0VGltZW91dFNjaGVkdWxlZCkgewogICAgICAgICAgICBpc0hvc3RUaW1lb3V0U2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICAgIGNhbmNlbEhvc3RUaW1lb3V0KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpc1BlcmZvcm1pbmdXb3JrID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxpbmcpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtMb29wKGhhc1RpbWVSZW1haW5pbmcsIGluaXRpYWxUaW1lMik7CiAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VGFzayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgICAgICAgICBtYXJrVGFza0Vycm9yZWQoY3VycmVudFRhc2ssIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgICAgICAgY3VycmVudFRhc2suaXNRdWV1ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gd29ya0xvb3AoaGFzVGltZVJlbWFpbmluZywgaW5pdGlhbFRpbWUyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY3VycmVudFRhc2sgPSBudWxsOwogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHByZXZpb3VzUHJpb3JpdHlMZXZlbDsKICAgICAgICAgICAgaXNQZXJmb3JtaW5nV29yayA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3b3JrTG9vcChoYXNUaW1lUmVtYWluaW5nLCBpbml0aWFsVGltZTIpIHsKICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGluaXRpYWxUaW1lMjsKICAgICAgICAgIGFkdmFuY2VUaW1lcnMoY3VycmVudFRpbWUpOwogICAgICAgICAgY3VycmVudFRhc2sgPSBwZWVrMyh0YXNrUXVldWUpOwogICAgICAgICAgd2hpbGUgKGN1cnJlbnRUYXNrICE9PSBudWxsICYmICFlbmFibGVTY2hlZHVsZXJEZWJ1Z2dpbmcpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrLmV4cGlyYXRpb25UaW1lID4gY3VycmVudFRpbWUgJiYgKCFoYXNUaW1lUmVtYWluaW5nIHx8IHNob3VsZFlpZWxkVG9Ib3N0KCkpKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gY3VycmVudFRhc2suY2FsbGJhY2s7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBjdXJyZW50VGFzay5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBjdXJyZW50VGFzay5wcmlvcml0eUxldmVsOwogICAgICAgICAgICAgIHZhciBkaWRVc2VyQ2FsbGJhY2tUaW1lb3V0ID0gY3VycmVudFRhc2suZXhwaXJhdGlvblRpbWUgPD0gY3VycmVudFRpbWU7CiAgICAgICAgICAgICAgdmFyIGNvbnRpbnVhdGlvbkNhbGxiYWNrID0gY2FsbGJhY2soZGlkVXNlckNhbGxiYWNrVGltZW91dCk7CiAgICAgICAgICAgICAgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgY29udGludWF0aW9uQ2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRUYXNrLmNhbGxiYWNrID0gY29udGludWF0aW9uQ2FsbGJhY2s7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VGFzayA9PT0gcGVlazModGFza1F1ZXVlKSkgewogICAgICAgICAgICAgICAgICBwb3AodGFza1F1ZXVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYWR2YW5jZVRpbWVycyhjdXJyZW50VGltZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcG9wKHRhc2tRdWV1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudFRhc2sgPSBwZWVrMyh0YXNrUXVldWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnRUYXNrICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGZpcnN0VGltZXIgPSBwZWVrMyh0aW1lclF1ZXVlKTsKICAgICAgICAgICAgaWYgKGZpcnN0VGltZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXF1ZXN0SG9zdFRpbWVvdXQoaGFuZGxlVGltZW91dCwgZmlyc3RUaW1lci5zdGFydFRpbWUgLSBjdXJyZW50VGltZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9ydW5XaXRoUHJpb3JpdHkocHJpb3JpdHlMZXZlbCwgZXZlbnRIYW5kbGVyKSB7CiAgICAgICAgICBzd2l0Y2ggKHByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgICAgY2FzZSBJbW1lZGlhdGVQcmlvcml0eToKICAgICAgICAgICAgY2FzZSBVc2VyQmxvY2tpbmdQcmlvcml0eToKICAgICAgICAgICAgY2FzZSBOb3JtYWxQcmlvcml0eToKICAgICAgICAgICAgY2FzZSBMb3dQcmlvcml0eToKICAgICAgICAgICAgY2FzZSBJZGxlUHJpb3JpdHk6CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwcmlvcml0eUxldmVsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50SGFuZGxlcigpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwcmV2aW91c1ByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX25leHQoZXZlbnRIYW5kbGVyKSB7CiAgICAgICAgICB2YXIgcHJpb3JpdHlMZXZlbDsKICAgICAgICAgIHN3aXRjaCAoY3VycmVudFByaW9yaXR5TGV2ZWwpIHsKICAgICAgICAgICAgY2FzZSBJbW1lZGlhdGVQcmlvcml0eToKICAgICAgICAgICAgY2FzZSBVc2VyQmxvY2tpbmdQcmlvcml0eToKICAgICAgICAgICAgY2FzZSBOb3JtYWxQcmlvcml0eToKICAgICAgICAgICAgICBwcmlvcml0eUxldmVsID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwcmlvcml0eUxldmVsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGV2ZW50SGFuZGxlcigpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwcmV2aW91c1ByaW9yaXR5TGV2ZWw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3dyYXBDYWxsYmFjayhjYWxsYmFjaykgewogICAgICAgICAgdmFyIHBhcmVudFByaW9yaXR5TGV2ZWwgPSBjdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHByZXZpb3VzUHJpb3JpdHlMZXZlbCA9IGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgICAgICBjdXJyZW50UHJpb3JpdHlMZXZlbCA9IHBhcmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgY3VycmVudFByaW9yaXR5TGV2ZWwgPSBwcmV2aW91c1ByaW9yaXR5TGV2ZWw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3NjaGVkdWxlQ2FsbGJhY2socHJpb3JpdHlMZXZlbCwgY2FsbGJhY2ssIG9wdGlvbnMpIHsKICAgICAgICAgIHZhciBjdXJyZW50VGltZSA9IGV4cG9ydHMudW5zdGFibGVfbm93KCk7CiAgICAgICAgICB2YXIgc3RhcnRUaW1lMjsKICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gIm9iamVjdCIgJiYgb3B0aW9ucyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZGVsYXkgPSBvcHRpb25zLmRlbGF5OwogICAgICAgICAgICBpZiAodHlwZW9mIGRlbGF5ID09PSAibnVtYmVyIiAmJiBkZWxheSA+IDApIHsKICAgICAgICAgICAgICBzdGFydFRpbWUyID0gY3VycmVudFRpbWUgKyBkZWxheTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdGFydFRpbWUyID0gY3VycmVudFRpbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXJ0VGltZTIgPSBjdXJyZW50VGltZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0aW1lb3V0OwogICAgICAgICAgc3dpdGNoIChwcmlvcml0eUxldmVsKSB7CiAgICAgICAgICAgIGNhc2UgSW1tZWRpYXRlUHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IElNTUVESUFURV9QUklPUklUWV9USU1FT1VUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFVzZXJCbG9ja2luZ1ByaW9yaXR5OgogICAgICAgICAgICAgIHRpbWVvdXQgPSBVU0VSX0JMT0NLSU5HX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgSWRsZVByaW9yaXR5OgogICAgICAgICAgICAgIHRpbWVvdXQgPSBJRExFX1BSSU9SSVRZX1RJTUVPVVQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgTG93UHJpb3JpdHk6CiAgICAgICAgICAgICAgdGltZW91dCA9IExPV19QUklPUklUWV9USU1FT1VUOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIE5vcm1hbFByaW9yaXR5OgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHRpbWVvdXQgPSBOT1JNQUxfUFJJT1JJVFlfVElNRU9VVDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZSA9IHN0YXJ0VGltZTIgKyB0aW1lb3V0OwogICAgICAgICAgdmFyIG5ld1Rhc2sgPSB7CiAgICAgICAgICAgIGlkOiB0YXNrSWRDb3VudGVyKyssCiAgICAgICAgICAgIGNhbGxiYWNrLAogICAgICAgICAgICBwcmlvcml0eUxldmVsLAogICAgICAgICAgICBzdGFydFRpbWU6IHN0YXJ0VGltZTIsCiAgICAgICAgICAgIGV4cGlyYXRpb25UaW1lLAogICAgICAgICAgICBzb3J0SW5kZXg6IC0xCiAgICAgICAgICB9OwogICAgICAgICAgaWYgKHN0YXJ0VGltZTIgPiBjdXJyZW50VGltZSkgewogICAgICAgICAgICBuZXdUYXNrLnNvcnRJbmRleCA9IHN0YXJ0VGltZTI7CiAgICAgICAgICAgIHB1c2godGltZXJRdWV1ZSwgbmV3VGFzayk7CiAgICAgICAgICAgIGlmIChwZWVrMyh0YXNrUXVldWUpID09PSBudWxsICYmIG5ld1Rhc2sgPT09IHBlZWszKHRpbWVyUXVldWUpKSB7CiAgICAgICAgICAgICAgaWYgKGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQpIHsKICAgICAgICAgICAgICAgIGNhbmNlbEhvc3RUaW1lb3V0KCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlzSG9zdFRpbWVvdXRTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXF1ZXN0SG9zdFRpbWVvdXQoaGFuZGxlVGltZW91dCwgc3RhcnRUaW1lMiAtIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV3VGFzay5zb3J0SW5kZXggPSBleHBpcmF0aW9uVGltZTsKICAgICAgICAgICAgcHVzaCh0YXNrUXVldWUsIG5ld1Rhc2spOwogICAgICAgICAgICBpZiAoIWlzSG9zdENhbGxiYWNrU2NoZWR1bGVkICYmICFpc1BlcmZvcm1pbmdXb3JrKSB7CiAgICAgICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICAgIHJlcXVlc3RIb3N0Q2FsbGJhY2soZmx1c2hXb3JrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG5ld1Rhc2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uKCkgewogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bnN0YWJsZV9jb250aW51ZUV4ZWN1dGlvbigpIHsKICAgICAgICAgIGlmICghaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgJiYgIWlzUGVyZm9ybWluZ1dvcmspIHsKICAgICAgICAgICAgaXNIb3N0Q2FsbGJhY2tTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgICByZXF1ZXN0SG9zdENhbGxiYWNrKGZsdXNoV29yayk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2dldEZpcnN0Q2FsbGJhY2tOb2RlKCkgewogICAgICAgICAgcmV0dXJuIHBlZWszKHRhc2tRdWV1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2NhbmNlbENhbGxiYWNrKHRhc2syKSB7CiAgICAgICAgICB0YXNrMi5jYWxsYmFjayA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX2dldEN1cnJlbnRQcmlvcml0eUxldmVsKCkgewogICAgICAgICAgcmV0dXJuIGN1cnJlbnRQcmlvcml0eUxldmVsOwogICAgICAgIH0KICAgICAgICB2YXIgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICB2YXIgc2NoZWR1bGVkSG9zdENhbGxiYWNrID0gbnVsbDsKICAgICAgICB2YXIgdGFza1RpbWVvdXRJRCA9IC0xOwogICAgICAgIHZhciBmcmFtZUludGVydmFsID0gZnJhbWVZaWVsZE1zOwogICAgICAgIHZhciBzdGFydFRpbWUgPSAtMTsKICAgICAgICBmdW5jdGlvbiBzaG91bGRZaWVsZFRvSG9zdCgpIHsKICAgICAgICAgIHZhciB0aW1lRWxhcHNlZCA9IGV4cG9ydHMudW5zdGFibGVfbm93KCkgLSBzdGFydFRpbWU7CiAgICAgICAgICBpZiAodGltZUVsYXBzZWQgPCBmcmFtZUludGVydmFsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0UGFpbnQoKSB7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcmNlRnJhbWVSYXRlKGZwcykgewogICAgICAgICAgaWYgKGZwcyA8IDAgfHwgZnBzID4gMTI1KSB7CiAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oImZvcmNlRnJhbWVSYXRlIHRha2VzIGEgcG9zaXRpdmUgaW50IGJldHdlZW4gMCBhbmQgMTI1LCBmb3JjaW5nIGZyYW1lIHJhdGVzIGhpZ2hlciB0aGFuIDEyNSBmcHMgaXMgbm90IHN1cHBvcnRlZCIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZnBzID4gMCkgewogICAgICAgICAgICBmcmFtZUludGVydmFsID0gTWF0aC5mbG9vcigxZTMgLyBmcHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZnJhbWVJbnRlcnZhbCA9IGZyYW1lWWllbGRNczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgaWYgKHNjaGVkdWxlZEhvc3RDYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudFRpbWUgPSBleHBvcnRzLnVuc3RhYmxlX25vdygpOwogICAgICAgICAgICBzdGFydFRpbWUgPSBjdXJyZW50VGltZTsKICAgICAgICAgICAgdmFyIGhhc1RpbWVSZW1haW5pbmcgPSB0cnVlOwogICAgICAgICAgICB2YXIgaGFzTW9yZVdvcmsgPSB0cnVlOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGhhc01vcmVXb3JrID0gc2NoZWR1bGVkSG9zdENhbGxiYWNrKGhhc1RpbWVSZW1haW5pbmcsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBpZiAoaGFzTW9yZVdvcmspIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lKCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlzTWVzc2FnZUxvb3BSdW5uaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICBzY2hlZHVsZWRIb3N0Q2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaXNNZXNzYWdlTG9vcFJ1bm5pbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZTsKICAgICAgICBpZiAodHlwZW9mIGxvY2FsU2V0SW1tZWRpYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBsb2NhbFNldEltbWVkaWF0ZShwZXJmb3JtV29ya1VudGlsRGVhZGxpbmUpOwogICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBNZXNzYWdlQ2hhbm5lbCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgIHZhciBjaGFubmVsID0gbmV3IE1lc3NhZ2VDaGFubmVsKCk7CiAgICAgICAgICB2YXIgcG9ydCA9IGNoYW5uZWwucG9ydDI7CiAgICAgICAgICBjaGFubmVsLnBvcnQxLm9ubWVzc2FnZSA9IHBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZTsKICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHBvcnQucG9zdE1lc3NhZ2UobnVsbCk7CiAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzY2hlZHVsZVBlcmZvcm1Xb3JrVW50aWxEZWFkbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBsb2NhbFNldFRpbWVvdXQocGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lLCAwKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RIb3N0Q2FsbGJhY2soY2FsbGJhY2spIHsKICAgICAgICAgIHNjaGVkdWxlZEhvc3RDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgaWYgKCFpc01lc3NhZ2VMb29wUnVubmluZykgewogICAgICAgICAgICBpc01lc3NhZ2VMb29wUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHNjaGVkdWxlUGVyZm9ybVdvcmtVbnRpbERlYWRsaW5lKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RIb3N0VGltZW91dChjYWxsYmFjaywgbXMpIHsKICAgICAgICAgIHRhc2tUaW1lb3V0SUQgPSBsb2NhbFNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGNhbGxiYWNrKGV4cG9ydHMudW5zdGFibGVfbm93KCkpOwogICAgICAgICAgfSwgbXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5jZWxIb3N0VGltZW91dCgpIHsKICAgICAgICAgIGxvY2FsQ2xlYXJUaW1lb3V0KHRhc2tUaW1lb3V0SUQpOwogICAgICAgICAgdGFza1RpbWVvdXRJRCA9IC0xOwogICAgICAgIH0KICAgICAgICB2YXIgdW5zdGFibGVfcmVxdWVzdFBhaW50ID0gcmVxdWVzdFBhaW50OwogICAgICAgIHZhciB1bnN0YWJsZV9Qcm9maWxpbmcgPSBudWxsOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfSWRsZVByaW9yaXR5ID0gSWRsZVByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfSW1tZWRpYXRlUHJpb3JpdHkgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX0xvd1ByaW9yaXR5ID0gTG93UHJpb3JpdHk7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eSA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfUHJvZmlsaW5nID0gdW5zdGFibGVfUHJvZmlsaW5nOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfVXNlckJsb2NraW5nUHJpb3JpdHkgPSBVc2VyQmxvY2tpbmdQcmlvcml0eTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2NhbmNlbENhbGxiYWNrID0gdW5zdGFibGVfY2FuY2VsQ2FsbGJhY2s7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9jb250aW51ZUV4ZWN1dGlvbiA9IHVuc3RhYmxlX2NvbnRpbnVlRXhlY3V0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfZm9yY2VGcmFtZVJhdGUgPSBmb3JjZUZyYW1lUmF0ZTsKICAgICAgICBleHBvcnRzLnVuc3RhYmxlX2dldEN1cnJlbnRQcmlvcml0eUxldmVsID0gdW5zdGFibGVfZ2V0Q3VycmVudFByaW9yaXR5TGV2ZWw7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9nZXRGaXJzdENhbGxiYWNrTm9kZSA9IHVuc3RhYmxlX2dldEZpcnN0Q2FsbGJhY2tOb2RlOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfbmV4dCA9IHVuc3RhYmxlX25leHQ7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9wYXVzZUV4ZWN1dGlvbiA9IHVuc3RhYmxlX3BhdXNlRXhlY3V0aW9uOwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfcmVxdWVzdFBhaW50ID0gdW5zdGFibGVfcmVxdWVzdFBhaW50OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfcnVuV2l0aFByaW9yaXR5ID0gdW5zdGFibGVfcnVuV2l0aFByaW9yaXR5OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayA9IHVuc3RhYmxlX3NjaGVkdWxlQ2FsbGJhY2s7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9zaG91bGRZaWVsZCA9IHNob3VsZFlpZWxkVG9Ib3N0OwogICAgICAgIGV4cG9ydHMudW5zdGFibGVfd3JhcENhbGxiYWNrID0gdW5zdGFibGVfd3JhcENhbGxiYWNrOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0b3AobmV3IEVycm9yKCkpOwogICAgICAgIH0KICAgICAgfSkoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3NjaGVkdWxlckAwLjIzLjIvbm9kZV9tb2R1bGVzL3NjaGVkdWxlci9pbmRleC5qcwp2YXIgcmVxdWlyZV9zY2hlZHVsZXIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3NjaGVkdWxlckAwLjIzLjIvbm9kZV9tb2R1bGVzL3NjaGVkdWxlci9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3NjaGVkdWxlcl9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9janMvcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3JlYWN0X2RvbV9kZXZlbG9wbWVudCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9janMvcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAodHJ1ZSkgewogICAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgInVzZSBzdHJpY3QiOwogICAgICAgIGlmICh0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChuZXcgRXJyb3IoKSk7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdDM5ID0gcmVxdWlyZV9yZWFjdCgpOwogICAgICAgIHZhciBTY2hlZHVsZXIgPSByZXF1aXJlX3NjaGVkdWxlcigpOwogICAgICAgIHZhciBSZWFjdFNoYXJlZEludGVybmFscyA9IFJlYWN0MzkuX19TRUNSRVRfSU5URVJOQUxTX0RPX05PVF9VU0VfT1JfWU9VX1dJTExfQkVfRklSRUQ7CiAgICAgICAgdmFyIHN1cHByZXNzV2FybmluZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHNldFN1cHByZXNzV2FybmluZyhuZXdTdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3VwcHJlc3NXYXJuaW5nID0gbmV3U3VwcHJlc3NXYXJuaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuMyhmb3JtYXQyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghc3VwcHJlc3NXYXJuaW5nKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiA+IDEgPyBfbGVuIC0gMSA6IDApLCBfa2V5ID0gMTsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5IC0gMV0gPSBhcmd1bWVudHNbX2tleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByaW50V2FybmluZygid2FybiIsIGZvcm1hdDIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFzdXBwcmVzc1dhcm5pbmcpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBfbGVuMiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjIgPiAxID8gX2xlbjIgLSAxIDogMCksIF9rZXkyID0gMTsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgICAgICAgICAgYXJnc1tfa2V5MiAtIDFdID0gYXJndW1lbnRzW19rZXkyXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJpbnRXYXJuaW5nKCJlcnJvciIsIGZvcm1hdDIsIGFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByaW50V2FybmluZyhsZXZlbCwgZm9ybWF0MiwgYXJncykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgICAgICB2YXIgc3RhY2sgPSBSZWFjdERlYnVnQ3VycmVudEZyYW1lMi5nZXRTdGFja0FkZGVuZHVtKCk7CiAgICAgICAgICAgIGlmIChzdGFjayAhPT0gIiIpIHsKICAgICAgICAgICAgICBmb3JtYXQyICs9ICIlcyI7CiAgICAgICAgICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KFtzdGFja10pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhcmdzV2l0aEZvcm1hdCA9IGFyZ3MubWFwKGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKGl0ZW0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgYXJnc1dpdGhGb3JtYXQudW5zaGlmdCgiV2FybmluZzogIiArIGZvcm1hdDIpOwogICAgICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlW2xldmVsXSwgY29uc29sZSwgYXJnc1dpdGhGb3JtYXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgRnVuY3Rpb25Db21wb25lbnQgPSAwOwogICAgICAgIHZhciBDbGFzc0NvbXBvbmVudCA9IDE7CiAgICAgICAgdmFyIEluZGV0ZXJtaW5hdGVDb21wb25lbnQgPSAyOwogICAgICAgIHZhciBIb3N0Um9vdCA9IDM7CiAgICAgICAgdmFyIEhvc3RQb3J0YWwgPSA0OwogICAgICAgIHZhciBIb3N0Q29tcG9uZW50ID0gNTsKICAgICAgICB2YXIgSG9zdFRleHQgPSA2OwogICAgICAgIHZhciBGcmFnbWVudDkgPSA3OwogICAgICAgIHZhciBNb2RlID0gODsKICAgICAgICB2YXIgQ29udGV4dENvbnN1bWVyID0gOTsKICAgICAgICB2YXIgQ29udGV4dFByb3ZpZGVyID0gMTA7CiAgICAgICAgdmFyIEZvcndhcmRSZWYyID0gMTE7CiAgICAgICAgdmFyIFByb2ZpbGVyID0gMTI7CiAgICAgICAgdmFyIFN1c3BlbnNlQ29tcG9uZW50ID0gMTM7CiAgICAgICAgdmFyIE1lbW9Db21wb25lbnQgPSAxNDsKICAgICAgICB2YXIgU2ltcGxlTWVtb0NvbXBvbmVudCA9IDE1OwogICAgICAgIHZhciBMYXp5Q29tcG9uZW50ID0gMTY7CiAgICAgICAgdmFyIEluY29tcGxldGVDbGFzc0NvbXBvbmVudCA9IDE3OwogICAgICAgIHZhciBEZWh5ZHJhdGVkRnJhZ21lbnQgPSAxODsKICAgICAgICB2YXIgU3VzcGVuc2VMaXN0Q29tcG9uZW50ID0gMTk7CiAgICAgICAgdmFyIFNjb3BlQ29tcG9uZW50ID0gMjE7CiAgICAgICAgdmFyIE9mZnNjcmVlbkNvbXBvbmVudCA9IDIyOwogICAgICAgIHZhciBMZWdhY3lIaWRkZW5Db21wb25lbnQgPSAyMzsKICAgICAgICB2YXIgQ2FjaGVDb21wb25lbnQgPSAyNDsKICAgICAgICB2YXIgVHJhY2luZ01hcmtlckNvbXBvbmVudCA9IDI1OwogICAgICAgIHZhciBlbmFibGVDbGllbnRSZW5kZXJGYWxsYmFja09uVGV4dE1pc21hdGNoID0gdHJ1ZTsKICAgICAgICB2YXIgZW5hYmxlTmV3UmVjb25jaWxlciA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVMYXp5Q29udGV4dFByb3BhZ2F0aW9uID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZUxlZ2FjeUhpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVTdXNwZW5zZUF2b2lkVGhpc0ZhbGxiYWNrID0gZmFsc2U7CiAgICAgICAgdmFyIGRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQgPSBmYWxzZTsKICAgICAgICB2YXIgd2FybkFib3V0U3RyaW5nUmVmcyA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVNjaGVkdWxpbmdQcm9maWxlciA9IHRydWU7CiAgICAgICAgdmFyIGVuYWJsZVByb2ZpbGVyVGltZXIgPSB0cnVlOwogICAgICAgIHZhciBlbmFibGVQcm9maWxlckNvbW1pdEhvb2tzID0gdHJ1ZTsKICAgICAgICB2YXIgYWxsTmF0aXZlRXZlbnRzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB2YXIgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcyA9IHt9OwogICAgICAgIHZhciBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzID0ge307CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJUd29QaGFzZUV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lLCBkZXBlbmRlbmNpZXMpOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudChyZWdpc3RyYXRpb25OYW1lICsgIkNhcHR1cmUiLCBkZXBlbmRlbmNpZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWdpc3RlckRpcmVjdEV2ZW50KHJlZ2lzdHJhdGlvbk5hbWUsIGRlcGVuZGVuY2llcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSkgewogICAgICAgICAgICAgIGVycm9yKCJFdmVudFJlZ2lzdHJ5OiBNb3JlIHRoYW4gb25lIHBsdWdpbiBhdHRlbXB0ZWQgdG8gcHVibGlzaCB0aGUgc2FtZSByZWdpc3RyYXRpb24gbmFtZSwgYCVzYC4iLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llc1tyZWdpc3RyYXRpb25OYW1lXSA9IGRlcGVuZGVuY2llczsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gcmVnaXN0cmF0aW9uTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzW2xvd2VyQ2FzZWROYW1lXSA9IHJlZ2lzdHJhdGlvbk5hbWU7CiAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lID09PSAib25Eb3VibGVDbGljayIpIHsKICAgICAgICAgICAgICBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzLm9uZGJsY2xpY2sgPSByZWdpc3RyYXRpb25OYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlcGVuZGVuY2llcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhbGxOYXRpdmVFdmVudHMuYWRkKGRlcGVuZGVuY2llc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjYW5Vc2VET00yID0gISEodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50ICE9PSAidW5kZWZpbmVkIik7CiAgICAgICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgICAgICBmdW5jdGlvbiB0eXBlTmFtZSh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzVG9TdHJpbmdUYWcgPSB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIFN5bWJvbC50b1N0cmluZ1RhZzsKICAgICAgICAgICAgdmFyIHR5cGUgPSBoYXNUb1N0cmluZ1RhZyAmJiB2YWx1ZVtTeW1ib2wudG9TdHJpbmdUYWddIHx8IHZhbHVlLmNvbnN0cnVjdG9yLm5hbWUgfHwgIk9iamVjdCI7CiAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gIiIgKyB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tBdHRyaWJ1dGVTdHJpbmdDb2VyY2lvbih2YWx1ZSwgYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBgJXNgIGF0dHJpYnV0ZSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgYXR0cmlidXRlTmFtZSwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0tleVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGtleSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1Byb3BTdHJpbmdDb2VyY2lvbih2YWx1ZSwgcHJvcE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSkgewogICAgICAgICAgICAgIGVycm9yKCJUaGUgcHJvdmlkZWQgYCVzYCBwcm9wIGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCBwcm9wTmFtZSwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0NTU1Byb3BlcnR5U3RyaW5nQ29lcmNpb24odmFsdWUsIHByb3BOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGAlc2AgQ1NTIHByb3BlcnR5IGlzIGFuIHVuc3VwcG9ydGVkIHR5cGUgJXMuIFRoaXMgdmFsdWUgbXVzdCBiZSBjb2VyY2VkIHRvIGEgc3RyaW5nIGJlZm9yZSBiZWZvcmUgdXNpbmcgaXQgaGVyZS4iLCBwcm9wTmFtZSwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0h0bWxTdHJpbmdDb2VyY2lvbih2YWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod2lsbENvZXJjaW9uVGhyb3codmFsdWUpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBwcm92aWRlZCBIVE1MIG1hcmt1cCB1c2VzIGEgdmFsdWUgb2YgdW5zdXBwb3J0ZWQgdHlwZSAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiRm9ybSBmaWVsZCB2YWx1ZXMgKHZhbHVlLCBjaGVja2VkLCBkZWZhdWx0VmFsdWUsIG9yIGRlZmF1bHRDaGVja2VkIHByb3BzKSBtdXN0IGJlIHN0cmluZ3MsIG5vdCAlcy4gVGhpcyB2YWx1ZSBtdXN0IGJlIGNvZXJjZWQgdG8gYSBzdHJpbmcgYmVmb3JlIGJlZm9yZSB1c2luZyBpdCBoZXJlLiIsIHR5cGVOYW1lKHZhbHVlKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHRlc3RTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJFU0VSVkVEID0gMDsKICAgICAgICB2YXIgU1RSSU5HID0gMTsKICAgICAgICB2YXIgQk9PTEVBTklTSF9TVFJJTkcgPSAyOwogICAgICAgIHZhciBCT09MRUFOID0gMzsKICAgICAgICB2YXIgT1ZFUkxPQURFRF9CT09MRUFOID0gNDsKICAgICAgICB2YXIgTlVNRVJJQyA9IDU7CiAgICAgICAgdmFyIFBPU0lUSVZFX05VTUVSSUMgPSA2OwogICAgICAgIHZhciBBVFRSSUJVVEVfTkFNRV9TVEFSVF9DSEFSID0gIjpBLVpfYS16XFx1MDBDMC1cXHUwMEQ2XFx1MDBEOC1cXHUwMEY2XFx1MDBGOC1cXHUwMkZGXFx1MDM3MC1cXHUwMzdEXFx1MDM3Ri1cXHUxRkZGXFx1MjAwQy1cXHUyMDBEXFx1MjA3MC1cXHUyMThGXFx1MkMwMC1cXHUyRkVGXFx1MzAwMS1cXHVEN0ZGXFx1RjkwMC1cXHVGRENGXFx1RkRGMC1cXHVGRkZEIjsKICAgICAgICB2YXIgQVRUUklCVVRFX05BTUVfQ0hBUiA9IEFUVFJJQlVURV9OQU1FX1NUQVJUX0NIQVIgKyAiXFwtLjAtOVxcdTAwQjdcXHUwMzAwLVxcdTAzNkZcXHUyMDNGLVxcdTIwNDAiOwogICAgICAgIHZhciBWQUxJRF9BVFRSSUJVVEVfTkFNRV9SRUdFWCA9IG5ldyBSZWdFeHAoIl5bIiArIEFUVFJJQlVURV9OQU1FX1NUQVJUX0NIQVIgKyAiXVsiICsgQVRUUklCVVRFX05BTUVfQ0hBUiArICJdKiQiKTsKICAgICAgICB2YXIgaWxsZWdhbEF0dHJpYnV0ZU5hbWVDYWNoZSA9IHt9OwogICAgICAgIHZhciB2YWxpZGF0ZWRBdHRyaWJ1dGVOYW1lQ2FjaGUgPSB7fTsKICAgICAgICBmdW5jdGlvbiBpc0F0dHJpYnV0ZU5hbWVTYWZlKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbGlkYXRlZEF0dHJpYnV0ZU5hbWVDYWNoZSwgYXR0cmlidXRlTmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChpbGxlZ2FsQXR0cmlidXRlTmFtZUNhY2hlLCBhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoVkFMSURfQVRUUklCVVRFX05BTUVfUkVHRVgudGVzdChhdHRyaWJ1dGVOYW1lKSkgewogICAgICAgICAgICB2YWxpZGF0ZWRBdHRyaWJ1dGVOYW1lQ2FjaGVbYXR0cmlidXRlTmFtZV0gPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlsbGVnYWxBdHRyaWJ1dGVOYW1lQ2FjaGVbYXR0cmlidXRlTmFtZV0gPSB0cnVlOwogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiSW52YWxpZCBhdHRyaWJ1dGUgbmFtZTogYCVzYCIsIGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRJZ25vcmVBdHRyaWJ1dGUobmFtZSwgcHJvcGVydHlJbmZvLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChuYW1lLmxlbmd0aCA+IDIgJiYgKG5hbWVbMF0gPT09ICJvIiB8fCBuYW1lWzBdID09PSAiTyIpICYmIChuYW1lWzFdID09PSAibiIgfHwgbmFtZVsxXSA9PT0gIk4iKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgIGNhc2UgImZ1bmN0aW9uIjoKICAgICAgICAgICAgY2FzZSAic3ltYm9sIjoKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgY2FzZSAiYm9vbGVhbiI6IHsKICAgICAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuICFwcm9wZXJ0eUluZm8uYWNjZXB0c0Jvb2xlYW5zOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgcHJlZml4MiA9IG5hbWUudG9Mb3dlckNhc2UoKS5zbGljZSgwLCA1KTsKICAgICAgICAgICAgICAgIHJldHVybiBwcmVmaXgyICE9PSAiZGF0YS0iICYmIHByZWZpeDIgIT09ICJhcmlhLSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRSZW1vdmVBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZVdpdGhXYXJuaW5nKG5hbWUsIHZhbHVlLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJvcGVydHlJbmZvICE9PSBudWxsKSB7CiAgICAgICAgICAgIHN3aXRjaCAocHJvcGVydHlJbmZvLnR5cGUpIHsKICAgICAgICAgICAgICBjYXNlIEJPT0xFQU46CiAgICAgICAgICAgICAgICByZXR1cm4gIXZhbHVlOwogICAgICAgICAgICAgIGNhc2UgT1ZFUkxPQURFRF9CT09MRUFOOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09PSBmYWxzZTsKICAgICAgICAgICAgICBjYXNlIE5VTUVSSUM6CiAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4odmFsdWUpOwogICAgICAgICAgICAgIGNhc2UgUE9TSVRJVkVfTlVNRVJJQzoKICAgICAgICAgICAgICAgIHJldHVybiBpc05hTih2YWx1ZSkgfHwgdmFsdWUgPCAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFByb3BlcnR5SW5mbyhuYW1lKSB7CiAgICAgICAgICByZXR1cm4gcHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSA/IHByb3BlcnRpZXNbbmFtZV0gOiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBQcm9wZXJ0eUluZm9SZWNvcmQobmFtZSwgdHlwZSwgbXVzdFVzZVByb3BlcnR5LCBhdHRyaWJ1dGVOYW1lLCBhdHRyaWJ1dGVOYW1lc3BhY2UsIHNhbml0aXplVVJMMiwgcmVtb3ZlRW1wdHlTdHJpbmcpIHsKICAgICAgICAgIHRoaXMuYWNjZXB0c0Jvb2xlYW5zID0gdHlwZSA9PT0gQk9PTEVBTklTSF9TVFJJTkcgfHwgdHlwZSA9PT0gQk9PTEVBTiB8fCB0eXBlID09PSBPVkVSTE9BREVEX0JPT0xFQU47CiAgICAgICAgICB0aGlzLmF0dHJpYnV0ZU5hbWUgPSBhdHRyaWJ1dGVOYW1lOwogICAgICAgICAgdGhpcy5hdHRyaWJ1dGVOYW1lc3BhY2UgPSBhdHRyaWJ1dGVOYW1lc3BhY2U7CiAgICAgICAgICB0aGlzLm11c3RVc2VQcm9wZXJ0eSA9IG11c3RVc2VQcm9wZXJ0eTsKICAgICAgICAgIHRoaXMucHJvcGVydHlOYW1lID0gbmFtZTsKICAgICAgICAgIHRoaXMudHlwZSA9IHR5cGU7CiAgICAgICAgICB0aGlzLnNhbml0aXplVVJMID0gc2FuaXRpemVVUkwyOwogICAgICAgICAgdGhpcy5yZW1vdmVFbXB0eVN0cmluZyA9IHJlbW92ZUVtcHR5U3RyaW5nOwogICAgICAgIH0KICAgICAgICB2YXIgcHJvcGVydGllcyA9IHt9OwogICAgICAgIHZhciByZXNlcnZlZFByb3BzID0gWwogICAgICAgICAgImNoaWxkcmVuIiwKICAgICAgICAgICJkYW5nZXJvdXNseVNldElubmVySFRNTCIsCiAgICAgICAgICAvLyBUT0RPOiBUaGlzIHByZXZlbnRzIHRoZSBhc3NpZ25tZW50IG9mIGRlZmF1bHRWYWx1ZSB0byByZWd1bGFyCiAgICAgICAgICAvLyBlbGVtZW50cyAobm90IGp1c3QgaW5wdXRzKS4gTm93IHRoYXQgUmVhY3RET01JbnB1dCBhc3NpZ25zIHRvIHRoZQogICAgICAgICAgLy8gZGVmYXVsdFZhbHVlIHByb3BlcnR5IC0tIGRvIHdlIG5lZWQgdGhpcz8KICAgICAgICAgICJkZWZhdWx0VmFsdWUiLAogICAgICAgICAgImRlZmF1bHRDaGVja2VkIiwKICAgICAgICAgICJpbm5lckhUTUwiLAogICAgICAgICAgInN1cHByZXNzQ29udGVudEVkaXRhYmxlV2FybmluZyIsCiAgICAgICAgICAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIiwKICAgICAgICAgICJzdHlsZSIKICAgICAgICBdOwogICAgICAgIHJlc2VydmVkUHJvcHMuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgUkVTRVJWRUQsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFtbImFjY2VwdENoYXJzZXQiLCAiYWNjZXB0LWNoYXJzZXQiXSwgWyJjbGFzc05hbWUiLCAiY2xhc3MiXSwgWyJodG1sRm9yIiwgImZvciJdLCBbImh0dHBFcXVpdiIsICJodHRwLWVxdWl2Il1dLmZvckVhY2goZnVuY3Rpb24oX3JlZjIpIHsKICAgICAgICAgIHZhciBuYW1lID0gX3JlZjJbMF0sIGF0dHJpYnV0ZU5hbWUgPSBfcmVmMlsxXTsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsiY29udGVudEVkaXRhYmxlIiwgImRyYWdnYWJsZSIsICJzcGVsbENoZWNrIiwgInZhbHVlIl0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTklTSF9TVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWyJhdXRvUmV2ZXJzZSIsICJleHRlcm5hbFJlc291cmNlc1JlcXVpcmVkIiwgImZvY3VzYWJsZSIsICJwcmVzZXJ2ZUFscGhhIl0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTklTSF9TVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJhbGxvd0Z1bGxTY3JlZW4iLAogICAgICAgICAgImFzeW5jIiwKICAgICAgICAgIC8vIE5vdGU6IHRoZXJlIGlzIGEgc3BlY2lhbCBjYXNlIHRoYXQgcHJldmVudHMgaXQgZnJvbSBiZWluZyB3cml0dGVuIHRvIHRoZSBET00KICAgICAgICAgIC8vIG9uIHRoZSBjbGllbnQgc2lkZSBiZWNhdXNlIHRoZSBicm93c2VycyBhcmUgaW5jb25zaXN0ZW50LiBJbnN0ZWFkIHdlIGNhbGwgZm9jdXMoKS4KICAgICAgICAgICJhdXRvRm9jdXMiLAogICAgICAgICAgImF1dG9QbGF5IiwKICAgICAgICAgICJjb250cm9scyIsCiAgICAgICAgICAiZGVmYXVsdCIsCiAgICAgICAgICAiZGVmZXIiLAogICAgICAgICAgImRpc2FibGVkIiwKICAgICAgICAgICJkaXNhYmxlUGljdHVyZUluUGljdHVyZSIsCiAgICAgICAgICAiZGlzYWJsZVJlbW90ZVBsYXliYWNrIiwKICAgICAgICAgICJmb3JtTm9WYWxpZGF0ZSIsCiAgICAgICAgICAiaGlkZGVuIiwKICAgICAgICAgICJsb29wIiwKICAgICAgICAgICJub01vZHVsZSIsCiAgICAgICAgICAibm9WYWxpZGF0ZSIsCiAgICAgICAgICAib3BlbiIsCiAgICAgICAgICAicGxheXNJbmxpbmUiLAogICAgICAgICAgInJlYWRPbmx5IiwKICAgICAgICAgICJyZXF1aXJlZCIsCiAgICAgICAgICAicmV2ZXJzZWQiLAogICAgICAgICAgInNjb3BlZCIsCiAgICAgICAgICAic2VhbWxlc3MiLAogICAgICAgICAgLy8gTWljcm9kYXRhCiAgICAgICAgICAiaXRlbVNjb3BlIgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgQk9PTEVBTiwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbCiAgICAgICAgICAiY2hlY2tlZCIsCiAgICAgICAgICAvLyBOb3RlOiBgb3B0aW9uLnNlbGVjdGVkYCBpcyBub3QgdXBkYXRlZCBpZiBgc2VsZWN0Lm11bHRpcGxlYCBpcwogICAgICAgICAgLy8gZGlzYWJsZWQgd2l0aCBgcmVtb3ZlQXR0cmlidXRlYC4gV2UgaGF2ZSBzcGVjaWFsIGxvZ2ljIGZvciBoYW5kbGluZyB0aGlzLgogICAgICAgICAgIm11bHRpcGxlIiwKICAgICAgICAgICJtdXRlZCIsCiAgICAgICAgICAic2VsZWN0ZWQiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIEJPT0xFQU4sCiAgICAgICAgICAgIHRydWUsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWwogICAgICAgICAgImNhcHR1cmUiLAogICAgICAgICAgImRvd25sb2FkIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBPVkVSTE9BREVEX0JPT0xFQU4sCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJjb2xzIiwKICAgICAgICAgICJyb3dzIiwKICAgICAgICAgICJzaXplIiwKICAgICAgICAgICJzcGFuIgogICAgICAgICAgLy8gTk9URTogaWYgeW91IGFkZCBhIGNhbWVsQ2FzZWQgcHJvcCB0byB0aGlzIGxpc3QsCiAgICAgICAgICAvLyB5b3UnbGwgbmVlZCB0byBzZXQgYXR0cmlidXRlTmFtZSB0byBuYW1lLnRvTG93ZXJDYXNlKCkKICAgICAgICAgIC8vIGluc3RlYWQgaW4gdGhlIGFzc2lnbm1lbnQgYmVsb3cuCiAgICAgICAgXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBQT1NJVElWRV9OVU1FUklDLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICBbInJvd1NwYW4iLCAic3RhcnQiXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbbmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBOVU1FUklDLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIG5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZQogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIHZhciBDQU1FTElaRSA9IC9bXC1cOl0oW2Etel0pL2c7CiAgICAgICAgdmFyIGNhcGl0YWxpemUgPSBmdW5jdGlvbih0b2tlbikgewogICAgICAgICAgcmV0dXJuIHRva2VuWzFdLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgfTsKICAgICAgICBbCiAgICAgICAgICAiYWNjZW50LWhlaWdodCIsCiAgICAgICAgICAiYWxpZ25tZW50LWJhc2VsaW5lIiwKICAgICAgICAgICJhcmFiaWMtZm9ybSIsCiAgICAgICAgICAiYmFzZWxpbmUtc2hpZnQiLAogICAgICAgICAgImNhcC1oZWlnaHQiLAogICAgICAgICAgImNsaXAtcGF0aCIsCiAgICAgICAgICAiY2xpcC1ydWxlIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uLWZpbHRlcnMiLAogICAgICAgICAgImNvbG9yLXByb2ZpbGUiLAogICAgICAgICAgImNvbG9yLXJlbmRlcmluZyIsCiAgICAgICAgICAiZG9taW5hbnQtYmFzZWxpbmUiLAogICAgICAgICAgImVuYWJsZS1iYWNrZ3JvdW5kIiwKICAgICAgICAgICJmaWxsLW9wYWNpdHkiLAogICAgICAgICAgImZpbGwtcnVsZSIsCiAgICAgICAgICAiZmxvb2QtY29sb3IiLAogICAgICAgICAgImZsb29kLW9wYWNpdHkiLAogICAgICAgICAgImZvbnQtZmFtaWx5IiwKICAgICAgICAgICJmb250LXNpemUiLAogICAgICAgICAgImZvbnQtc2l6ZS1hZGp1c3QiLAogICAgICAgICAgImZvbnQtc3RyZXRjaCIsCiAgICAgICAgICAiZm9udC1zdHlsZSIsCiAgICAgICAgICAiZm9udC12YXJpYW50IiwKICAgICAgICAgICJmb250LXdlaWdodCIsCiAgICAgICAgICAiZ2x5cGgtbmFtZSIsCiAgICAgICAgICAiZ2x5cGgtb3JpZW50YXRpb24taG9yaXpvbnRhbCIsCiAgICAgICAgICAiZ2x5cGgtb3JpZW50YXRpb24tdmVydGljYWwiLAogICAgICAgICAgImhvcml6LWFkdi14IiwKICAgICAgICAgICJob3Jpei1vcmlnaW4teCIsCiAgICAgICAgICAiaW1hZ2UtcmVuZGVyaW5nIiwKICAgICAgICAgICJsZXR0ZXItc3BhY2luZyIsCiAgICAgICAgICAibGlnaHRpbmctY29sb3IiLAogICAgICAgICAgIm1hcmtlci1lbmQiLAogICAgICAgICAgIm1hcmtlci1taWQiLAogICAgICAgICAgIm1hcmtlci1zdGFydCIsCiAgICAgICAgICAib3ZlcmxpbmUtcG9zaXRpb24iLAogICAgICAgICAgIm92ZXJsaW5lLXRoaWNrbmVzcyIsCiAgICAgICAgICAicGFpbnQtb3JkZXIiLAogICAgICAgICAgInBhbm9zZS0xIiwKICAgICAgICAgICJwb2ludGVyLWV2ZW50cyIsCiAgICAgICAgICAicmVuZGVyaW5nLWludGVudCIsCiAgICAgICAgICAic2hhcGUtcmVuZGVyaW5nIiwKICAgICAgICAgICJzdG9wLWNvbG9yIiwKICAgICAgICAgICJzdG9wLW9wYWNpdHkiLAogICAgICAgICAgInN0cmlrZXRocm91Z2gtcG9zaXRpb24iLAogICAgICAgICAgInN0cmlrZXRocm91Z2gtdGhpY2tuZXNzIiwKICAgICAgICAgICJzdHJva2UtZGFzaGFycmF5IiwKICAgICAgICAgICJzdHJva2UtZGFzaG9mZnNldCIsCiAgICAgICAgICAic3Ryb2tlLWxpbmVjYXAiLAogICAgICAgICAgInN0cm9rZS1saW5lam9pbiIsCiAgICAgICAgICAic3Ryb2tlLW1pdGVybGltaXQiLAogICAgICAgICAgInN0cm9rZS1vcGFjaXR5IiwKICAgICAgICAgICJzdHJva2Utd2lkdGgiLAogICAgICAgICAgInRleHQtYW5jaG9yIiwKICAgICAgICAgICJ0ZXh0LWRlY29yYXRpb24iLAogICAgICAgICAgInRleHQtcmVuZGVyaW5nIiwKICAgICAgICAgICJ1bmRlcmxpbmUtcG9zaXRpb24iLAogICAgICAgICAgInVuZGVybGluZS10aGlja25lc3MiLAogICAgICAgICAgInVuaWNvZGUtYmlkaSIsCiAgICAgICAgICAidW5pY29kZS1yYW5nZSIsCiAgICAgICAgICAidW5pdHMtcGVyLWVtIiwKICAgICAgICAgICJ2LWFscGhhYmV0aWMiLAogICAgICAgICAgInYtaGFuZ2luZyIsCiAgICAgICAgICAidi1pZGVvZ3JhcGhpYyIsCiAgICAgICAgICAidi1tYXRoZW1hdGljYWwiLAogICAgICAgICAgInZlY3Rvci1lZmZlY3QiLAogICAgICAgICAgInZlcnQtYWR2LXkiLAogICAgICAgICAgInZlcnQtb3JpZ2luLXgiLAogICAgICAgICAgInZlcnQtb3JpZ2luLXkiLAogICAgICAgICAgIndvcmQtc3BhY2luZyIsCiAgICAgICAgICAid3JpdGluZy1tb2RlIiwKICAgICAgICAgICJ4bWxuczp4bGluayIsCiAgICAgICAgICAieC1oZWlnaHQiCiAgICAgICAgICAvLyBOT1RFOiBpZiB5b3UgYWRkIGEgY2FtZWxDYXNlZCBwcm9wIHRvIHRoaXMgbGlzdCwKICAgICAgICAgIC8vIHlvdSdsbCBuZWVkIHRvIHNldCBhdHRyaWJ1dGVOYW1lIHRvIG5hbWUudG9Mb3dlckNhc2UoKQogICAgICAgICAgLy8gaW5zdGVhZCBpbiB0aGUgYXNzaWdubWVudCBiZWxvdy4KICAgICAgICBdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgdmFyIG5hbWUgPSBhdHRyaWJ1dGVOYW1lLnJlcGxhY2UoQ0FNRUxJWkUsIGNhcGl0YWxpemUpOwogICAgICAgICAgcHJvcGVydGllc1tuYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICBudWxsLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lc3BhY2UKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJ4bGluazphY3R1YXRlIiwKICAgICAgICAgICJ4bGluazphcmNyb2xlIiwKICAgICAgICAgICJ4bGluazpyb2xlIiwKICAgICAgICAgICJ4bGluazpzaG93IiwKICAgICAgICAgICJ4bGluazp0aXRsZSIsCiAgICAgICAgICAieGxpbms6dHlwZSIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZU5hbWUucmVwbGFjZShDQU1FTElaRSwgY2FwaXRhbGl6ZSk7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiwKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIHNhbml0aXplVVJMCiAgICAgICAgICAgIGZhbHNlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIFsKICAgICAgICAgICJ4bWw6YmFzZSIsCiAgICAgICAgICAieG1sOmxhbmciLAogICAgICAgICAgInhtbDpzcGFjZSIKICAgICAgICAgIC8vIE5PVEU6IGlmIHlvdSBhZGQgYSBjYW1lbENhc2VkIHByb3AgdG8gdGhpcyBsaXN0LAogICAgICAgICAgLy8geW91J2xsIG5lZWQgdG8gc2V0IGF0dHJpYnV0ZU5hbWUgdG8gbmFtZS50b0xvd2VyQ2FzZSgpCiAgICAgICAgICAvLyBpbnN0ZWFkIGluIHRoZSBhc3NpZ25tZW50IGJlbG93LgogICAgICAgIF0uZm9yRWFjaChmdW5jdGlvbihhdHRyaWJ1dGVOYW1lKSB7CiAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZU5hbWUucmVwbGFjZShDQU1FTElaRSwgY2FwaXRhbGl6ZSk7CiAgICAgICAgICBwcm9wZXJ0aWVzW25hbWVdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgU1RSSU5HLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gbXVzdFVzZVByb3BlcnR5CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgICJodHRwOi8vd3d3LnczLm9yZy9YTUwvMTk5OC9uYW1lc3BhY2UiLAogICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgLy8gc2FuaXRpemVVUkwKICAgICAgICAgICAgZmFsc2UKICAgICAgICAgICk7CiAgICAgICAgfSk7CiAgICAgICAgWyJ0YWJJbmRleCIsICJjcm9zc09yaWdpbiJdLmZvckVhY2goZnVuY3Rpb24oYXR0cmlidXRlTmFtZSkgewogICAgICAgICAgcHJvcGVydGllc1thdHRyaWJ1dGVOYW1lXSA9IG5ldyBQcm9wZXJ0eUluZm9SZWNvcmQoCiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWUsCiAgICAgICAgICAgIFNUUklORywKICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgIC8vIG11c3RVc2VQcm9wZXJ0eQogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWUKICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgLy8gYXR0cmlidXRlTmFtZXNwYWNlCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICBmYWxzZQogICAgICAgICAgKTsKICAgICAgICB9KTsKICAgICAgICB2YXIgeGxpbmtIcmVmID0gInhsaW5rSHJlZiI7CiAgICAgICAgcHJvcGVydGllc1t4bGlua0hyZWZdID0gbmV3IFByb3BlcnR5SW5mb1JlY29yZCgKICAgICAgICAgICJ4bGlua0hyZWYiLAogICAgICAgICAgU1RSSU5HLAogICAgICAgICAgZmFsc2UsCiAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICJ4bGluazpocmVmIiwKICAgICAgICAgICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiwKICAgICAgICAgIHRydWUsCiAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgZmFsc2UKICAgICAgICApOwogICAgICAgIFsic3JjIiwgImhyZWYiLCAiYWN0aW9uIiwgImZvcm1BY3Rpb24iXS5mb3JFYWNoKGZ1bmN0aW9uKGF0dHJpYnV0ZU5hbWUpIHsKICAgICAgICAgIHByb3BlcnRpZXNbYXR0cmlidXRlTmFtZV0gPSBuZXcgUHJvcGVydHlJbmZvUmVjb3JkKAogICAgICAgICAgICBhdHRyaWJ1dGVOYW1lLAogICAgICAgICAgICBTVFJJTkcsCiAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAvLyBtdXN0VXNlUHJvcGVydHkKICAgICAgICAgICAgYXR0cmlidXRlTmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAvLyBhdHRyaWJ1dGVOYW1lCiAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgIC8vIGF0dHJpYnV0ZU5hbWVzcGFjZQogICAgICAgICAgICB0cnVlLAogICAgICAgICAgICAvLyBzYW5pdGl6ZVVSTAogICAgICAgICAgICB0cnVlCiAgICAgICAgICApOwogICAgICAgIH0pOwogICAgICAgIHZhciBpc0phdmFTY3JpcHRQcm90b2NvbCA9IC9eW1x1MDAwMC1cdTAwMUYgXSpqW1xyXG5cdF0qYVtcclxuXHRdKnZbXHJcblx0XSphW1xyXG5cdF0qc1tcclxuXHRdKmNbXHJcblx0XSpyW1xyXG5cdF0qaVtcclxuXHRdKnBbXHJcblx0XSp0W1xyXG5cdF0qXDovaTsKICAgICAgICB2YXIgZGlkV2FybiA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHNhbml0aXplVVJMKHVybCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm4gJiYgaXNKYXZhU2NyaXB0UHJvdG9jb2wudGVzdCh1cmwpKSB7CiAgICAgICAgICAgICAgZGlkV2FybiA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoIkEgZnV0dXJlIHZlcnNpb24gb2YgUmVhY3Qgd2lsbCBibG9jayBqYXZhc2NyaXB0OiBVUkxzIGFzIGEgc2VjdXJpdHkgcHJlY2F1dGlvbi4gVXNlIGV2ZW50IGhhbmRsZXJzIGluc3RlYWQgaWYgeW91IGNhbi4gSWYgeW91IG5lZWQgdG8gZ2VuZXJhdGUgdW5zYWZlIEhUTUwgdHJ5IHVzaW5nIGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIGluc3RlYWQuIFJlYWN0IHdhcyBwYXNzZWQgJXMuIiwgSlNPTi5zdHJpbmdpZnkodXJsKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmFsdWVGb3JQcm9wZXJ0eShub2RlLCBuYW1lLCBleHBlY3RlZCwgcHJvcGVydHlJbmZvKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChwcm9wZXJ0eUluZm8ubXVzdFVzZVByb3BlcnR5KSB7CiAgICAgICAgICAgICAgdmFyIHByb3BlcnR5TmFtZSA9IHByb3BlcnR5SW5mby5wcm9wZXJ0eU5hbWU7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGVbcHJvcGVydHlOYW1lXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKGV4cGVjdGVkLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby5zYW5pdGl6ZVVSTCkgewogICAgICAgICAgICAgICAgc2FuaXRpemVVUkwoIiIgKyBleHBlY3RlZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVOYW1lID0gcHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWU7CiAgICAgICAgICAgICAgdmFyIHN0cmluZ1ZhbHVlID0gbnVsbDsKICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnR5cGUgPT09IE9WRVJMT0FERURfQk9PTEVBTikgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpOwogICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCBleHBlY3RlZCwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlID09PSAiIiArIGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUpKSB7CiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIGV4cGVjdGVkLCBwcm9wZXJ0eUluZm8sIGZhbHNlKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocHJvcGVydHlJbmZvLnR5cGUgPT09IEJPT0xFQU4pIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RyaW5nVmFsdWUgPSBub2RlLmdldEF0dHJpYnV0ZShhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFJlbW92ZUF0dHJpYnV0ZShuYW1lLCBleHBlY3RlZCwgcHJvcGVydHlJbmZvLCBmYWxzZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBzdHJpbmdWYWx1ZSA9PT0gbnVsbCA/IGV4cGVjdGVkIDogc3RyaW5nVmFsdWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdHJpbmdWYWx1ZSA9PT0gIiIgKyBleHBlY3RlZCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gc3RyaW5nVmFsdWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFZhbHVlRm9yQXR0cmlidXRlKG5vZGUsIG5hbWUsIGV4cGVjdGVkLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWlzQXR0cmlidXRlTmFtZVNhZmUobmFtZSkpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFub2RlLmhhc0F0dHJpYnV0ZShuYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdmFsdWUgPSBub2RlLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24oZXhwZWN0ZWQsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gIiIgKyBleHBlY3RlZCkgewogICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgbmFtZSwgdmFsdWUsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSB7CiAgICAgICAgICB2YXIgcHJvcGVydHlJbmZvID0gZ2V0UHJvcGVydHlJbmZvKG5hbWUpOwogICAgICAgICAgaWYgKHNob3VsZElnbm9yZUF0dHJpYnV0ZShuYW1lLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSkgewogICAgICAgICAgICB2YWx1ZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDdXN0b21Db21wb25lbnRUYWcgfHwgcHJvcGVydHlJbmZvID09PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChpc0F0dHJpYnV0ZU5hbWVTYWZlKG5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIF9hdHRyaWJ1dGVOYW1lID0gbmFtZTsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKF9hdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBuYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKF9hdHRyaWJ1dGVOYW1lLCAiIiArIHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG11c3RVc2VQcm9wZXJ0eSA9IHByb3BlcnR5SW5mby5tdXN0VXNlUHJvcGVydHk7CiAgICAgICAgICBpZiAobXVzdFVzZVByb3BlcnR5KSB7CiAgICAgICAgICAgIHZhciBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eUluZm8ucHJvcGVydHlOYW1lOwogICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgdHlwZSA9IHByb3BlcnR5SW5mby50eXBlOwogICAgICAgICAgICAgIG5vZGVbcHJvcGVydHlOYW1lXSA9IHR5cGUgPT09IEJPT0xFQU4gPyBmYWxzZSA6ICIiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5vZGVbcHJvcGVydHlOYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhdHRyaWJ1dGVOYW1lID0gcHJvcGVydHlJbmZvLmF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZU5hbWVzcGFjZSA9IHByb3BlcnR5SW5mby5hdHRyaWJ1dGVOYW1lc3BhY2U7CiAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgX3R5cGUgPSBwcm9wZXJ0eUluZm8udHlwZTsKICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZVZhbHVlOwogICAgICAgICAgICBpZiAoX3R5cGUgPT09IEJPT0xFQU4gfHwgX3R5cGUgPT09IE9WRVJMT0FERURfQk9PTEVBTiAmJiB2YWx1ZSA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIGF0dHJpYnV0ZVZhbHVlID0gIiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBjaGVja0F0dHJpYnV0ZVN0cmluZ0NvZXJjaW9uKHZhbHVlLCBhdHRyaWJ1dGVOYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGF0dHJpYnV0ZVZhbHVlID0gIiIgKyB2YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mby5zYW5pdGl6ZVVSTCkgewogICAgICAgICAgICAgICAgc2FuaXRpemVVUkwoYXR0cmlidXRlVmFsdWUudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVOYW1lc3BhY2UpIHsKICAgICAgICAgICAgICBub2RlLnNldEF0dHJpYnV0ZU5TKGF0dHJpYnV0ZU5hbWVzcGFjZSwgYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5vZGUuc2V0QXR0cmlidXRlKGF0dHJpYnV0ZU5hbWUsIGF0dHJpYnV0ZVZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZWxlbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9QT1JUQUxfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnBvcnRhbCIpOwogICAgICAgIHZhciBSRUFDVF9GUkFHTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZnJhZ21lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfU1RSSUNUX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN0cmljdF9tb2RlIik7CiAgICAgICAgdmFyIFJFQUNUX1BST0ZJTEVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm9maWxlciIpOwogICAgICAgIHZhciBSRUFDVF9QUk9WSURFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvdmlkZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfQ09OVEVYVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY29udGV4dCIpOwogICAgICAgIHZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0LmZvcndhcmRfcmVmIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZSIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZV9saXN0Iik7CiAgICAgICAgdmFyIFJFQUNUX01FTU9fVFlQRTIgPSBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CiAgICAgICAgdmFyIFJFQUNUX0xBWllfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmxhenkiKTsKICAgICAgICB2YXIgUkVBQ1RfU0NPUEVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnNjb3BlIik7CiAgICAgICAgdmFyIFJFQUNUX0RFQlVHX1RSQUNJTkdfTU9ERV9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZGVidWdfdHJhY2VfbW9kZSIpOwogICAgICAgIHZhciBSRUFDVF9PRkZTQ1JFRU5fVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0Lm9mZnNjcmVlbiIpOwogICAgICAgIHZhciBSRUFDVF9MRUdBQ1lfSElEREVOX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5sZWdhY3lfaGlkZGVuIik7CiAgICAgICAgdmFyIFJFQUNUX0NBQ0hFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5jYWNoZSIpOwogICAgICAgIHZhciBSRUFDVF9UUkFDSU5HX01BUktFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QudHJhY2luZ19tYXJrZXIiKTsKICAgICAgICB2YXIgTUFZQkVfSVRFUkFUT1JfU1lNQk9MID0gU3ltYm9sLml0ZXJhdG9yOwogICAgICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICJAQGl0ZXJhdG9yIjsKICAgICAgICBmdW5jdGlvbiBnZXRJdGVyYXRvckZuKG1heWJlSXRlcmFibGUpIHsKICAgICAgICAgIGlmIChtYXliZUl0ZXJhYmxlID09PSBudWxsIHx8IHR5cGVvZiBtYXliZUl0ZXJhYmxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXliZUl0ZXJhdG9yID0gTUFZQkVfSVRFUkFUT1JfU1lNQk9MICYmIG1heWJlSXRlcmFibGVbTUFZQkVfSVRFUkFUT1JfU1lNQk9MXSB8fCBtYXliZUl0ZXJhYmxlW0ZBVVhfSVRFUkFUT1JfU1lNQk9MXTsKICAgICAgICAgIGlmICh0eXBlb2YgbWF5YmVJdGVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gbWF5YmVJdGVyYXRvcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgYXNzaWduMiA9IE9iamVjdC5hc3NpZ247CiAgICAgICAgdmFyIGRpc2FibGVkRGVwdGggPSAwOwogICAgICAgIHZhciBwcmV2TG9nOwogICAgICAgIHZhciBwcmV2SW5mbzsKICAgICAgICB2YXIgcHJldldhcm47CiAgICAgICAgdmFyIHByZXZFcnJvcjsKICAgICAgICB2YXIgcHJldkdyb3VwOwogICAgICAgIHZhciBwcmV2R3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgdmFyIHByZXZHcm91cEVuZDsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlZExvZygpIHsKICAgICAgICB9CiAgICAgICAgZGlzYWJsZWRMb2cuX19yZWFjdERpc2FibGVkTG9nID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICBwcmV2TG9nID0gY29uc29sZS5sb2c7CiAgICAgICAgICAgICAgcHJldkluZm8gPSBjb25zb2xlLmluZm87CiAgICAgICAgICAgICAgcHJldldhcm4gPSBjb25zb2xlLndhcm47CiAgICAgICAgICAgICAgcHJldkVycm9yID0gY29uc29sZS5lcnJvcjsKICAgICAgICAgICAgICBwcmV2R3JvdXAgPSBjb25zb2xlLmdyb3VwOwogICAgICAgICAgICAgIHByZXZHcm91cENvbGxhcHNlZCA9IGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgICAgICAgcHJldkdyb3VwRW5kID0gY29uc29sZS5ncm91cEVuZDsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IGRpc2FibGVkTG9nLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGluZm86IHByb3BzLAogICAgICAgICAgICAgICAgbG9nOiBwcm9wcywKICAgICAgICAgICAgICAgIHdhcm46IHByb3BzLAogICAgICAgICAgICAgICAgZXJyb3I6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXA6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IHByb3BzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlzYWJsZWREZXB0aCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVuYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgtLTsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGxvZzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHdhcm46IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2V2FybgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBlcnJvcjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cENvbGxhcHNlZAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cEVuZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICB2YXIgcHJlZml4OwogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0geDIuc3RhY2sudHJpbSgpLm1hdGNoKC9cbiggKihhdCApPykvKTsKICAgICAgICAgICAgICAgIHByZWZpeCA9IG1hdGNoICYmIG1hdGNoWzFdIHx8ICIiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIlxuIiArIHByZWZpeCArIG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbXBvbmVudEZyYW1lQ2FjaGU7CiAgICAgICAgewogICAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCA9IHR5cGVvZiBXZWFrTWFwID09PSAiZnVuY3Rpb24iID8gV2Vha01hcCA6IE1hcDsKICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGNvbnN0cnVjdCkgewogICAgICAgICAgaWYgKCFmbiB8fCByZWVudHJ5KSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZyYW1lID0gY29tcG9uZW50RnJhbWVDYWNoZS5nZXQoZm4pOwogICAgICAgICAgICBpZiAoZnJhbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiBmcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRyb2w7CiAgICAgICAgICByZWVudHJ5ID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlID0gRXJyb3IucHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHZvaWQgMDsKICAgICAgICAgIHZhciBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByZXZpb3VzRGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudDsKICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgZGlzYWJsZUxvZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChjb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICB2YXIgRmFrZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShGYWtlLnByb3RvdHlwZSwgInByb3BzIiwgewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09ICJvYmplY3QiICYmIFJlZmxlY3QuY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChGYWtlLCBbXSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChmbiwgW10sIEZha2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBGYWtlLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChzYW1wbGUpIHsKICAgICAgICAgICAgaWYgKHNhbXBsZSAmJiBjb250cm9sICYmIHR5cGVvZiBzYW1wbGUuc3RhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgdmFyIHNhbXBsZUxpbmVzID0gc2FtcGxlLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBjb250cm9sTGluZXMgPSBjb250cm9sLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBzID0gc2FtcGxlTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB2YXIgYyA9IGNvbnRyb2xMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHdoaWxlIChzID49IDEgJiYgYyA+PSAwICYmIHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICg7IHMgPj0gMSAmJiBjID49IDA7IHMtLSwgYy0tKSB7CiAgICAgICAgICAgICAgICBpZiAoc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICBpZiAocyAhPT0gMSB8fCBjICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgcy0tOwogICAgICAgICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGMgPCAwIHx8IHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9mcmFtZSA9ICJcbiIgKyBzYW1wbGVMaW5lc1tzXS5yZXBsYWNlKCIgYXQgbmV3ICIsICIgYXQgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbi5kaXNwbGF5TmFtZSAmJiBfZnJhbWUuaW5jbHVkZXMoIjxhbm9ueW1vdXM+IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBfZnJhbWUgPSBfZnJhbWUucmVwbGFjZSgiPGFub255bW91cz4iLCBmbi5kaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBfZnJhbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2ZyYW1lOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKHMgPj0gMSAmJiBjID49IDApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50ID0gcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgICAgIHJlZW5hYmxlTG9ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lID0gZm4gPyBmbi5kaXNwbGF5TmFtZSB8fCBmbi5uYW1lIDogIiI7CiAgICAgICAgICB2YXIgc3ludGhldGljRnJhbWUgPSBuYW1lID8gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSkgOiAiIjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBzeW50aGV0aWNGcmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzeW50aGV0aWNGcmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVDbGFzc0NvbXBvbmVudEZyYW1lKGN0b3IsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVOYXRpdmVDb21wb25lbnRGcmFtZShjdG9yLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZuLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0KENvbXBvbmVudCkgewogICAgICAgICAgdmFyIHByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgICByZXR1cm4gISEocHJvdG90eXBlICYmIHByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKHR5cGUsIHNob3VsZENvbnN0cnVjdCh0eXBlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKHR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGaWJlcihmaWJlcikgewogICAgICAgICAgdmFyIG93bmVyID0gZmliZXIuX2RlYnVnT3duZXIgPyBmaWJlci5fZGVidWdPd25lci50eXBlIDogbnVsbDsKICAgICAgICAgIHZhciBzb3VyY2UgPSBmaWJlci5fZGVidWdTb3VyY2U7CiAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUpOwogICAgICAgICAgICBjYXNlIExhenlDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJMYXp5Iik7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKCJTdXNwZW5zZSIpOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlTGlzdCIpOwogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZpYmVyLnR5cGUpOwogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUZ1bmN0aW9uQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZS5yZW5kZXIpOwogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUNsYXNzQ29tcG9uZW50RnJhbWUoZmliZXIudHlwZSk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdGFja0J5RmliZXJJbkRldkFuZFByb2Qod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICB2YXIgbm9kZSA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGluZm8gKz0gZGVzY3JpYmVGaWJlcihub2RlKTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0gd2hpbGUgKG5vZGUpOwogICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgIHJldHVybiAiXG5FcnJvciBnZW5lcmF0aW5nIHN0YWNrOiAiICsgeDIubWVzc2FnZSArICJcbiIgKyB4Mi5zdGFjazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUob3V0ZXJUeXBlLCBpbm5lclR5cGUsIHdyYXBwZXJOYW1lKSB7CiAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSBvdXRlclR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICBpZiAoZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlLnRhZyA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgYW4gdW5leHBlY3RlZCBvYmplY3QgaW4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKCkuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQb3J0YWwiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQcm9maWxlciI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN0cmljdE1vZGUiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2VMaXN0IjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05URVhUX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUoY29udGV4dCkgKyAiLkNvbnN1bWVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRXcmFwcGVkTmFtZSQxKG91dGVyVHlwZSwgaW5uZXJUeXBlLCB3cmFwcGVyTmFtZSkgewogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBvdXRlclR5cGUuZGlzcGxheU5hbWUgfHwgKGZ1bmN0aW9uTmFtZSAhPT0gIiIgPyB3cmFwcGVyTmFtZSArICIoIiArIGZ1bmN0aW9uTmFtZSArICIpIiA6IHdyYXBwZXJOYW1lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUkMSh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCAiQ29udGV4dCI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciB0YWcgPSBmaWJlci50YWcsIHR5cGUgPSBmaWJlci50eXBlOwogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSBDYWNoZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIkNhY2hlIjsKICAgICAgICAgICAgY2FzZSBDb250ZXh0Q29uc3VtZXI6CiAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSB0eXBlOwogICAgICAgICAgICAgIHJldHVybiBnZXRDb250ZXh0TmFtZSQxKGNvbnRleHQpICsgIi5Db25zdW1lciI7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBwcm92aWRlciA9IHR5cGU7CiAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lJDEocHJvdmlkZXIuX2NvbnRleHQpICsgIi5Qcm92aWRlciI7CiAgICAgICAgICAgIGNhc2UgRGVoeWRyYXRlZEZyYWdtZW50OgogICAgICAgICAgICAgIHJldHVybiAiRGVoeWRyYXRlZEZyYWdtZW50IjsKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUkMSh0eXBlLCB0eXBlLnJlbmRlciwgIkZvcndhcmRSZWYiKTsKICAgICAgICAgICAgY2FzZSBGcmFnbWVudDk6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiAiUG9ydGFsIjsKICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICByZXR1cm4gIlJvb3QiOwogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHJldHVybiAiVGV4dCI7CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX1NUUklDVF9NT0RFX1RZUEUpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiU3RyaWN0TW9kZSI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiAiTW9kZSI7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHVybiAiT2Zmc2NyZWVuIjsKICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICByZXR1cm4gIlByb2ZpbGVyIjsKICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlNjb3BlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gIlN1c3BlbnNlIjsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZUxpc3QiOwogICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuICJUcmFjaW5nTWFya2VyIjsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZS5kaXNwbGF5TmFtZSB8fCB0eXBlLm5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICB2YXIgY3VycmVudDMgPSBudWxsOwogICAgICAgIHZhciBpc1JlbmRlcmluZyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb3duZXIgPSBjdXJyZW50My5fZGVidWdPd25lcjsKICAgICAgICAgICAgaWYgKG93bmVyICE9PSBudWxsICYmIHR5cGVvZiBvd25lciAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihvd25lcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXJTdGFja0luRGV2KCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGdldFN0YWNrQnlGaWJlckluRGV2QW5kUHJvZChjdXJyZW50Myk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0Q3VycmVudEZpYmVyKCkgewogICAgICAgICAgewogICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLmdldEN1cnJlbnRTdGFjayA9IG51bGw7CiAgICAgICAgICAgIGN1cnJlbnQzID0gbnVsbDsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0Q3VycmVudEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuZ2V0Q3VycmVudFN0YWNrID0gZmliZXIgPT09IG51bGwgPyBudWxsIDogZ2V0Q3VycmVudEZpYmVyU3RhY2tJbkRldjsKICAgICAgICAgICAgY3VycmVudDMgPSBmaWJlcjsKICAgICAgICAgICAgaXNSZW5kZXJpbmcgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q3VycmVudEZpYmVyKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gY3VycmVudDM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldElzUmVuZGVyaW5nKHJlbmRlcmluZykgewogICAgICAgICAgewogICAgICAgICAgICBpc1JlbmRlcmluZyA9IHJlbmRlcmluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdG9TdHJpbmcodmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUb1N0cmluZ1ZhbHVlKHZhbHVlKSB7CiAgICAgICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgICAgICBjYXNlICJib29sZWFuIjoKICAgICAgICAgICAgY2FzZSAibnVtYmVyIjoKICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgY2FzZSAidW5kZWZpbmVkIjoKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIGNhc2UgIm9iamVjdCI6CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGhhc1JlYWRPbmx5VmFsdWUgPSB7CiAgICAgICAgICBidXR0b246IHRydWUsCiAgICAgICAgICBjaGVja2JveDogdHJ1ZSwKICAgICAgICAgIGltYWdlOiB0cnVlLAogICAgICAgICAgaGlkZGVuOiB0cnVlLAogICAgICAgICAgcmFkaW86IHRydWUsCiAgICAgICAgICByZXNldDogdHJ1ZSwKICAgICAgICAgIHN1Ym1pdDogdHJ1ZQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY2hlY2tDb250cm9sbGVkVmFsdWVQcm9wcyh0YWdOYW1lLCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIShoYXNSZWFkT25seVZhbHVlW3Byb3BzLnR5cGVdIHx8IHByb3BzLm9uQ2hhbmdlIHx8IHByb3BzLm9uSW5wdXQgfHwgcHJvcHMucmVhZE9ubHkgfHwgcHJvcHMuZGlzYWJsZWQgfHwgcHJvcHMudmFsdWUgPT0gbnVsbCkpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHByb3ZpZGVkIGEgYHZhbHVlYCBwcm9wIHRvIGEgZm9ybSBmaWVsZCB3aXRob3V0IGFuIGBvbkNoYW5nZWAgaGFuZGxlci4gVGhpcyB3aWxsIHJlbmRlciBhIHJlYWQtb25seSBmaWVsZC4gSWYgdGhlIGZpZWxkIHNob3VsZCBiZSBtdXRhYmxlIHVzZSBgZGVmYXVsdFZhbHVlYC4gT3RoZXJ3aXNlLCBzZXQgZWl0aGVyIGBvbkNoYW5nZWAgb3IgYHJlYWRPbmx5YC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIShwcm9wcy5vbkNoYW5nZSB8fCBwcm9wcy5yZWFkT25seSB8fCBwcm9wcy5kaXNhYmxlZCB8fCBwcm9wcy5jaGVja2VkID09IG51bGwpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwcm92aWRlZCBhIGBjaGVja2VkYCBwcm9wIHRvIGEgZm9ybSBmaWVsZCB3aXRob3V0IGFuIGBvbkNoYW5nZWAgaGFuZGxlci4gVGhpcyB3aWxsIHJlbmRlciBhIHJlYWQtb25seSBmaWVsZC4gSWYgdGhlIGZpZWxkIHNob3VsZCBiZSBtdXRhYmxlIHVzZSBgZGVmYXVsdENoZWNrZWRgLiBPdGhlcndpc2UsIHNldCBlaXRoZXIgYG9uQ2hhbmdlYCBvciBgcmVhZE9ubHlgLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ2hlY2thYmxlKGVsZW0pIHsKICAgICAgICAgIHZhciB0eXBlID0gZWxlbS50eXBlOwogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZSAmJiBub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmICh0eXBlID09PSAiY2hlY2tib3giIHx8IHR5cGUgPT09ICJyYWRpbyIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUcmFja2VyKG5vZGUpIHsKICAgICAgICAgIHJldHVybiBub2RlLl92YWx1ZVRyYWNrZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaFRyYWNrZXIobm9kZSkgewogICAgICAgICAgbm9kZS5fdmFsdWVUcmFja2VyID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmFsdWVGcm9tTm9kZShub2RlKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSAiIjsKICAgICAgICAgIGlmICghbm9kZSkgewogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNDaGVja2FibGUobm9kZSkpIHsKICAgICAgICAgICAgdmFsdWUgPSBub2RlLmNoZWNrZWQgPyAidHJ1ZSIgOiAiZmFsc2UiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFsdWUgPSBub2RlLnZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFja1ZhbHVlT25Ob2RlKG5vZGUpIHsKICAgICAgICAgIHZhciB2YWx1ZUZpZWxkID0gaXNDaGVja2FibGUobm9kZSkgPyAiY2hlY2tlZCIgOiAidmFsdWUiOwogICAgICAgICAgdmFyIGRlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG5vZGUuY29uc3RydWN0b3IucHJvdG90eXBlLCB2YWx1ZUZpZWxkKTsKICAgICAgICAgIHsKICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKG5vZGVbdmFsdWVGaWVsZF0pOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRWYWx1ZSA9ICIiICsgbm9kZVt2YWx1ZUZpZWxkXTsKICAgICAgICAgIGlmIChub2RlLmhhc093blByb3BlcnR5KHZhbHVlRmllbGQpIHx8IHR5cGVvZiBkZXNjcmlwdG9yID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgZGVzY3JpcHRvci5nZXQgIT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGRlc2NyaXB0b3Iuc2V0ICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBnZXQ3ID0gZGVzY3JpcHRvci5nZXQsIHNldDQgPSBkZXNjcmlwdG9yLnNldDsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShub2RlLCB2YWx1ZUZpZWxkLCB7CiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0Ny5jYWxsKHRoaXMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tGb3JtRmllbGRWYWx1ZVN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudFZhbHVlID0gIiIgKyB2YWx1ZTsKICAgICAgICAgICAgICBzZXQ0LmNhbGwodGhpcywgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShub2RlLCB2YWx1ZUZpZWxkLCB7CiAgICAgICAgICAgIGVudW1lcmFibGU6IGRlc2NyaXB0b3IuZW51bWVyYWJsZQogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgdHJhY2tlciA9IHsKICAgICAgICAgICAgZ2V0VmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBjdXJyZW50VmFsdWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrRm9ybUZpZWxkVmFsdWVTdHJpbmdDb2VyY2lvbih2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9ICIiICsgdmFsdWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHN0b3BUcmFja2luZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgZGV0YWNoVHJhY2tlcihub2RlKTsKICAgICAgICAgICAgICBkZWxldGUgbm9kZVt2YWx1ZUZpZWxkXTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB0cmFja2VyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cmFjayhub2RlKSB7CiAgICAgICAgICBpZiAoZ2V0VHJhY2tlcihub2RlKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl92YWx1ZVRyYWNrZXIgPSB0cmFja1ZhbHVlT25Ob2RlKG5vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVWYWx1ZUlmQ2hhbmdlZChub2RlKSB7CiAgICAgICAgICBpZiAoIW5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHRyYWNrZXIgPSBnZXRUcmFja2VyKG5vZGUpOwogICAgICAgICAgaWYgKCF0cmFja2VyKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhc3RWYWx1ZSA9IHRyYWNrZXIuZ2V0VmFsdWUoKTsKICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBnZXRWYWx1ZUZyb21Ob2RlKG5vZGUpOwogICAgICAgICAgaWYgKG5leHRWYWx1ZSAhPT0gbGFzdFZhbHVlKSB7CiAgICAgICAgICAgIHRyYWNrZXIuc2V0VmFsdWUobmV4dFZhbHVlKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEFjdGl2ZUVsZW1lbnQoZG9jKSB7CiAgICAgICAgICBkb2MgPSBkb2MgfHwgKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgPyBkb2N1bWVudCA6IHZvaWQgMCk7CiAgICAgICAgICBpZiAodHlwZW9mIGRvYyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZG9jLmFjdGl2ZUVsZW1lbnQgfHwgZG9jLmJvZHk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHJldHVybiBkb2MuYm9keTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5WYWx1ZURlZmF1bHRWYWx1ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFdhcm5Db250cm9sbGVkVG9VbmNvbnRyb2xsZWQgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGlzQ29udHJvbGxlZChwcm9wcykgewogICAgICAgICAgdmFyIHVzZXNDaGVja2VkID0gcHJvcHMudHlwZSA9PT0gImNoZWNrYm94IiB8fCBwcm9wcy50eXBlID09PSAicmFkaW8iOwogICAgICAgICAgcmV0dXJuIHVzZXNDaGVja2VkID8gcHJvcHMuY2hlY2tlZCAhPSBudWxsIDogcHJvcHMudmFsdWUgIT0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFByb3BzKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgY2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CiAgICAgICAgICB2YXIgaG9zdFByb3BzID0gYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgZGVmYXVsdENoZWNrZWQ6IHZvaWQgMCwKICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGNoZWNrZWQ6IGNoZWNrZWQgIT0gbnVsbCA/IGNoZWNrZWQgOiBub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbENoZWNrZWQKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0NvbnRyb2xsZWRWYWx1ZVByb3BzKCJpbnB1dCIsIHByb3BzKTsKICAgICAgICAgICAgaWYgKHByb3BzLmNoZWNrZWQgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0Q2hlY2tlZCAhPT0gdm9pZCAwICYmICFkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIGNoZWNrZWQgYW5kIGRlZmF1bHRDaGVja2VkIHByb3BzLiBJbnB1dCBlbGVtZW50cyBtdXN0IGJlIGVpdGhlciBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCAoc3BlY2lmeSBlaXRoZXIgdGhlIGNoZWNrZWQgcHJvcCwgb3IgdGhlIGRlZmF1bHRDaGVja2VkIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgaW5wdXQgZWxlbWVudCBhbmQgcmVtb3ZlIG9uZSBvZiB0aGVzZSBwcm9wcy4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIiwgZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKSB8fCAiQSBjb21wb25lbnQiLCBwcm9wcy50eXBlKTsKICAgICAgICAgICAgICBkaWRXYXJuQ2hlY2tlZERlZmF1bHRDaGVja2VkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGNvbnRhaW5zIGFuIGlucHV0IG9mIHR5cGUgJXMgd2l0aCBib3RoIHZhbHVlIGFuZCBkZWZhdWx0VmFsdWUgcHJvcHMuIElucHV0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgdmFsdWUgcHJvcCwgb3IgdGhlIGRlZmF1bHRWYWx1ZSBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIGlucHV0IGVsZW1lbnQgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50IiwgcHJvcHMudHlwZSk7CiAgICAgICAgICAgICAgZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZSA9PSBudWxsID8gIiIgOiBwcm9wcy5kZWZhdWx0VmFsdWU7CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIGluaXRpYWxDaGVja2VkOiBwcm9wcy5jaGVja2VkICE9IG51bGwgPyBwcm9wcy5jaGVja2VkIDogcHJvcHMuZGVmYXVsdENoZWNrZWQsCiAgICAgICAgICAgIGluaXRpYWxWYWx1ZTogZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSAhPSBudWxsID8gcHJvcHMudmFsdWUgOiBkZWZhdWx0VmFsdWUpLAogICAgICAgICAgICBjb250cm9sbGVkOiBpc0NvbnRyb2xsZWQocHJvcHMpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDaGVja2VkKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgY2hlY2tlZCA9IHByb3BzLmNoZWNrZWQ7CiAgICAgICAgICBpZiAoY2hlY2tlZCAhPSBudWxsKSB7CiAgICAgICAgICAgIHNldFZhbHVlRm9yUHJvcGVydHkobm9kZSwgImNoZWNrZWQiLCBjaGVja2VkLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdyYXBwZXIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNvbnRyb2xsZWQgPSBpc0NvbnRyb2xsZWQocHJvcHMpOwogICAgICAgICAgICBpZiAoIW5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmIGNvbnRyb2xsZWQgJiYgIWRpZFdhcm5VbmNvbnRyb2xsZWRUb0NvbnRyb2xsZWQpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb21wb25lbnQgaXMgY2hhbmdpbmcgYW4gdW5jb250cm9sbGVkIGlucHV0IHRvIGJlIGNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSB1bmRlZmluZWQgdG8gYSBkZWZpbmVkIHZhbHVlLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FyblVuY29udHJvbGxlZFRvQ29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5vZGUuX3dyYXBwZXJTdGF0ZS5jb250cm9sbGVkICYmICFjb250cm9sbGVkICYmICFkaWRXYXJuQ29udHJvbGxlZFRvVW5jb250cm9sbGVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGNoYW5naW5nIGEgY29udHJvbGxlZCBpbnB1dCB0byBiZSB1bmNvbnRyb2xsZWQuIFRoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSB0aGUgdmFsdWUgY2hhbmdpbmcgZnJvbSBhIGRlZmluZWQgdG8gdW5kZWZpbmVkLCB3aGljaCBzaG91bGQgbm90IGhhcHBlbi4gRGVjaWRlIGJldHdlZW4gdXNpbmcgYSBjb250cm9sbGVkIG9yIHVuY29udHJvbGxlZCBpbnB1dCBlbGVtZW50IGZvciB0aGUgbGlmZXRpbWUgb2YgdGhlIGNvbXBvbmVudC4gTW9yZSBpbmZvOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvY29udHJvbGxlZC1jb21wb25lbnRzIik7CiAgICAgICAgICAgICAgZGlkV2FybkNvbnRyb2xsZWRUb1VuY29udHJvbGxlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZUNoZWNrZWQoZWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgdmFyIHZhbHVlID0gZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSk7CiAgICAgICAgICB2YXIgdHlwZSA9IHByb3BzLnR5cGU7CiAgICAgICAgICBpZiAodmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IDAgJiYgbm9kZS52YWx1ZSA9PT0gIiIgfHwgLy8gV2UgZXhwbGljaXRseSB3YW50IHRvIGNvZXJjZSB0byBudW1iZXIgaGVyZSBpZiBwb3NzaWJsZS4KICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUKICAgICAgICAgICAgICBub2RlLnZhbHVlICE9IHZhbHVlKSB7CiAgICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLnZhbHVlID0gdG9TdHJpbmcodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICJzdWJtaXQiIHx8IHR5cGUgPT09ICJyZXNldCIpIHsKICAgICAgICAgICAgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoInZhbHVlIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLmhhc093blByb3BlcnR5KCJ2YWx1ZSIpKSB7CiAgICAgICAgICAgICAgc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHByb3BzLnR5cGUsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgICBzZXREZWZhdWx0VmFsdWUobm9kZSwgcHJvcHMudHlwZSwgZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy5kZWZhdWx0VmFsdWUpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMuY2hlY2tlZCA9PSBudWxsICYmIHByb3BzLmRlZmF1bHRDaGVja2VkICE9IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRDaGVja2VkID0gISFwcm9wcy5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyKGVsZW1lbnQsIHByb3BzLCBpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIGlmIChwcm9wcy5oYXNPd25Qcm9wZXJ0eSgidmFsdWUiKSB8fCBwcm9wcy5oYXNPd25Qcm9wZXJ0eSgiZGVmYXVsdFZhbHVlIikpIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSBwcm9wcy50eXBlOwogICAgICAgICAgICB2YXIgaXNCdXR0b24gPSB0eXBlID09PSAic3VibWl0IiB8fCB0eXBlID09PSAicmVzZXQiOwogICAgICAgICAgICBpZiAoaXNCdXR0b24gJiYgKHByb3BzLnZhbHVlID09PSB2b2lkIDAgfHwgcHJvcHMudmFsdWUgPT09IG51bGwpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpbml0aWFsVmFsdWUgPSB0b1N0cmluZyhub2RlLl93cmFwcGVyU3RhdGUuaW5pdGlhbFZhbHVlKTsKICAgICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlICE9PSBub2RlLnZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUudmFsdWUgPSBpbml0aWFsVmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IGluaXRpYWxWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5hbWUgPSBub2RlLm5hbWU7CiAgICAgICAgICBpZiAobmFtZSAhPT0gIiIpIHsKICAgICAgICAgICAgbm9kZS5uYW1lID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG5vZGUuZGVmYXVsdENoZWNrZWQgPSAhbm9kZS5kZWZhdWx0Q2hlY2tlZDsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0Q2hlY2tlZCA9ICEhbm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxDaGVja2VkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hbWUgIT09ICIiKSB7CiAgICAgICAgICAgIG5vZGUubmFtZSA9IG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVDb250cm9sbGVkU3RhdGUoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHVwZGF0ZVdyYXBwZXIobm9kZSwgcHJvcHMpOwogICAgICAgICAgdXBkYXRlTmFtZWRDb3VzaW5zKG5vZGUsIHByb3BzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTmFtZWRDb3VzaW5zKHJvb3ROb2RlLCBwcm9wcykgewogICAgICAgICAgdmFyIG5hbWUgPSBwcm9wcy5uYW1lOwogICAgICAgICAgaWYgKHByb3BzLnR5cGUgPT09ICJyYWRpbyIgJiYgbmFtZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciBxdWVyeVJvb3QgPSByb290Tm9kZTsKICAgICAgICAgICAgd2hpbGUgKHF1ZXJ5Um9vdC5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgICAgcXVlcnlSb290ID0gcXVlcnlSb290LnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGNoZWNrQXR0cmlidXRlU3RyaW5nQ29lcmNpb24obmFtZSwgIm5hbWUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZ3JvdXAgPSBxdWVyeVJvb3QucXVlcnlTZWxlY3RvckFsbCgiaW5wdXRbbmFtZT0iICsgSlNPTi5zdHJpbmdpZnkoIiIgKyBuYW1lKSArICddW3R5cGU9InJhZGlvIl0nKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBncm91cC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBvdGhlck5vZGUgPSBncm91cFtpXTsKICAgICAgICAgICAgICBpZiAob3RoZXJOb2RlID09PSByb290Tm9kZSB8fCBvdGhlck5vZGUuZm9ybSAhPT0gcm9vdE5vZGUuZm9ybSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBvdGhlclByb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShvdGhlck5vZGUpOwogICAgICAgICAgICAgIGlmICghb3RoZXJQcm9wcykgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZWFjdERPTUlucHV0OiBNaXhpbmcgUmVhY3QgYW5kIG5vbi1SZWFjdCByYWRpbyBpbnB1dHMgd2l0aCB0aGUgc2FtZSBgbmFtZWAgaXMgbm90IHN1cHBvcnRlZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlVmFsdWVJZkNoYW5nZWQob3RoZXJOb2RlKTsKICAgICAgICAgICAgICB1cGRhdGVXcmFwcGVyKG90aGVyTm9kZSwgb3RoZXJQcm9wcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RGVmYXVsdFZhbHVlKG5vZGUsIHR5cGUsIHZhbHVlKSB7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIEZvY3VzZWQgbnVtYmVyIGlucHV0cyBzeW5jaHJvbml6ZSBvbiBibHVyLiBTZWUgQ2hhbmdlRXZlbnRQbHVnaW4uanMKICAgICAgICAgICAgdHlwZSAhPT0gIm51bWJlciIgfHwgZ2V0QWN0aXZlRWxlbWVudChub2RlLm93bmVyRG9jdW1lbnQpICE9PSBub2RlCiAgICAgICAgICApIHsKICAgICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUuZGVmYXVsdFZhbHVlICE9PSB0b1N0cmluZyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24gPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkludmFsaWRDaGlsZCA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuSW52YWxpZElubmVySFRNTCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcHMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHByb3BzLnZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAib2JqZWN0IiAmJiBwcm9wcy5jaGlsZHJlbiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgUmVhY3QzOS5DaGlsZHJlbi5mb3JFYWNoKHByb3BzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkID09PSAic3RyaW5nIiB8fCB0eXBlb2YgY2hpbGQgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkludmFsaWRDaGlsZCkgewogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgaW5mZXIgdGhlIG9wdGlvbiB2YWx1ZSBvZiBjb21wbGV4IGNoaWxkcmVuLiBQYXNzIGEgYHZhbHVlYCBwcm9wIG9yIHVzZSBhIHBsYWluIHN0cmluZyBhcyBjaGlsZHJlbiB0byA8b3B0aW9uPi4iKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5JbnZhbGlkSW5uZXJIVE1MKSB7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSW5uZXJIVE1MID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlBhc3MgYSBgdmFsdWVgIHByb3AgaWYgeW91IHNldCBkYW5nZXJvdXNseUlubmVySFRNTCBzbyBSZWFjdCBrbm93cyB3aGljaCB2YWx1ZSBzaG91bGQgYmUgc2VsZWN0ZWQuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcy5zZWxlY3RlZCAhPSBudWxsICYmICFkaWRXYXJuU2VsZWN0ZWRTZXRPbk9wdGlvbikgewogICAgICAgICAgICAgIGVycm9yKCJVc2UgdGhlIGBkZWZhdWx0VmFsdWVgIG9yIGB2YWx1ZWAgcHJvcHMgb24gPHNlbGVjdD4gaW5zdGVhZCBvZiBzZXR0aW5nIGBzZWxlY3RlZGAgb24gPG9wdGlvbj4uIik7CiAgICAgICAgICAgICAgZGlkV2FyblNlbGVjdGVkU2V0T25PcHRpb24gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvc3RNb3VudFdyYXBwZXIkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgaWYgKHByb3BzLnZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoInZhbHVlIiwgdG9TdHJpbmcoZ2V0VG9TdHJpbmdWYWx1ZShwcm9wcy52YWx1ZSkpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzQXJyYXlJbXBsID0gQXJyYXkuaXNBcnJheTsKICAgICAgICBmdW5jdGlvbiBpc0FycmF5MihhKSB7CiAgICAgICAgICByZXR1cm4gaXNBcnJheUltcGwoYSk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMTsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSB7CiAgICAgICAgICB2YXIgb3duZXJOYW1lID0gZ2V0Q3VycmVudEZpYmVyT3duZXJOYW1lSW5EZXZPck51bGwoKTsKICAgICAgICAgIGlmIChvd25lck5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBvd25lck5hbWUgKyAiYC4iOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgdmFsdWVQcm9wTmFtZXMgPSBbInZhbHVlIiwgImRlZmF1bHRWYWx1ZSJdOwogICAgICAgIGZ1bmN0aW9uIGNoZWNrU2VsZWN0UHJvcFR5cGVzKHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInNlbGVjdCIsIHByb3BzKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2YWx1ZVByb3BOYW1lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBwcm9wTmFtZSA9IHZhbHVlUHJvcE5hbWVzW2ldOwogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBwcm9wTmFtZUlzQXJyYXkgPSBpc0FycmF5Mihwcm9wc1twcm9wTmFtZV0pOwogICAgICAgICAgICAgIGlmIChwcm9wcy5tdWx0aXBsZSAmJiAhcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGFuIGFycmF5IGlmIGBtdWx0aXBsZWAgaXMgdHJ1ZS4lcyIsIHByb3BOYW1lLCBnZXREZWNsYXJhdGlvbkVycm9yQWRkZW5kdW0oKSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICghcHJvcHMubXVsdGlwbGUgJiYgcHJvcE5hbWVJc0FycmF5KSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIGAlc2AgcHJvcCBzdXBwbGllZCB0byA8c2VsZWN0PiBtdXN0IGJlIGEgc2NhbGFyIHZhbHVlIGlmIGBtdWx0aXBsZWAgaXMgZmFsc2UuJXMiLCBwcm9wTmFtZSwgZ2V0RGVjbGFyYXRpb25FcnJvckFkZGVuZHVtKCkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVPcHRpb25zMihub2RlLCBtdWx0aXBsZSwgcHJvcFZhbHVlLCBzZXREZWZhdWx0U2VsZWN0ZWQpIHsKICAgICAgICAgIHZhciBvcHRpb25zMiA9IG5vZGUub3B0aW9uczsKICAgICAgICAgIGlmIChtdWx0aXBsZSkgewogICAgICAgICAgICB2YXIgc2VsZWN0ZWRWYWx1ZXMgPSBwcm9wVmFsdWU7CiAgICAgICAgICAgIHZhciBzZWxlY3RlZFZhbHVlID0ge307CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VsZWN0ZWRWYWx1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBzZWxlY3RlZFZhbHVlWyIkIiArIHNlbGVjdGVkVmFsdWVzW2ldXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IG9wdGlvbnMyLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgIHZhciBzZWxlY3RlZCA9IHNlbGVjdGVkVmFsdWUuaGFzT3duUHJvcGVydHkoIiQiICsgb3B0aW9uczJbX2ldLnZhbHVlKTsKICAgICAgICAgICAgICBpZiAob3B0aW9uczJbX2ldLnNlbGVjdGVkICE9PSBzZWxlY3RlZCkgewogICAgICAgICAgICAgICAgb3B0aW9uczJbX2ldLnNlbGVjdGVkID0gc2VsZWN0ZWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChzZWxlY3RlZCAmJiBzZXREZWZhdWx0U2VsZWN0ZWQpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pXS5kZWZhdWx0U2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIF9zZWxlY3RlZFZhbHVlID0gdG9TdHJpbmcoZ2V0VG9TdHJpbmdWYWx1ZShwcm9wVmFsdWUpKTsKICAgICAgICAgICAgdmFyIGRlZmF1bHRTZWxlY3RlZCA9IG51bGw7CiAgICAgICAgICAgIGZvciAodmFyIF9pMiA9IDA7IF9pMiA8IG9wdGlvbnMyLmxlbmd0aDsgX2kyKyspIHsKICAgICAgICAgICAgICBpZiAob3B0aW9uczJbX2kyXS52YWx1ZSA9PT0gX3NlbGVjdGVkVmFsdWUpIHsKICAgICAgICAgICAgICAgIG9wdGlvbnMyW19pMl0uc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHNldERlZmF1bHRTZWxlY3RlZCkgewogICAgICAgICAgICAgICAgICBvcHRpb25zMltfaTJdLmRlZmF1bHRTZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChkZWZhdWx0U2VsZWN0ZWQgPT09IG51bGwgJiYgIW9wdGlvbnMyW19pMl0uZGlzYWJsZWQpIHsKICAgICAgICAgICAgICAgIGRlZmF1bHRTZWxlY3RlZCA9IG9wdGlvbnMyW19pMl07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkZWZhdWx0U2VsZWN0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBkZWZhdWx0U2VsZWN0ZWQuc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICByZXR1cm4gYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgdmFsdWU6IHZvaWQgMAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluaXRXcmFwcGVyU3RhdGUkMShlbGVtZW50LCBwcm9wcykgewogICAgICAgICAgdmFyIG5vZGUgPSBlbGVtZW50OwogICAgICAgICAgewogICAgICAgICAgICBjaGVja1NlbGVjdFByb3BUeXBlcyhwcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIHdhc011bHRpcGxlOiAhIXByb3BzLm11bHRpcGxlCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbHVlRGVmYXVsdFZhbHVlJDEpIHsKICAgICAgICAgICAgICBlcnJvcigiU2VsZWN0IGVsZW1lbnRzIG11c3QgYmUgZWl0aGVyIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIChzcGVjaWZ5IGVpdGhlciB0aGUgdmFsdWUgcHJvcCwgb3IgdGhlIGRlZmF1bHRWYWx1ZSBwcm9wLCBidXQgbm90IGJvdGgpLiBEZWNpZGUgYmV0d2VlbiB1c2luZyBhIGNvbnRyb2xsZWQgb3IgdW5jb250cm9sbGVkIHNlbGVjdCBlbGVtZW50IGFuZCByZW1vdmUgb25lIG9mIHRoZXNlIHByb3BzLiBNb3JlIGluZm86IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9jb250cm9sbGVkLWNvbXBvbmVudHMiKTsKICAgICAgICAgICAgICBkaWRXYXJuVmFsdWVEZWZhdWx0VmFsdWUkMSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdE1vdW50V3JhcHBlciQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICBub2RlLm11bHRpcGxlID0gISFwcm9wcy5tdWx0aXBsZTsKICAgICAgICAgIHZhciB2YWx1ZSA9IHByb3BzLnZhbHVlOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgdmFsdWUsIGZhbHNlKTsKICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMuZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgcHJvcHMuZGVmYXVsdFZhbHVlLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9zdFVwZGF0ZVdyYXBwZXIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB3YXNNdWx0aXBsZSA9IG5vZGUuX3dyYXBwZXJTdGF0ZS53YXNNdWx0aXBsZTsKICAgICAgICAgIG5vZGUuX3dyYXBwZXJTdGF0ZS53YXNNdWx0aXBsZSA9ICEhcHJvcHMubXVsdGlwbGU7CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHdhc011bHRpcGxlICE9PSAhIXByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgIGlmIChwcm9wcy5kZWZhdWx0VmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHByb3BzLmRlZmF1bHRWYWx1ZSwgdHJ1ZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdXBkYXRlT3B0aW9uczIobm9kZSwgISFwcm9wcy5tdWx0aXBsZSwgcHJvcHMubXVsdGlwbGUgPyBbXSA6ICIiLCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQxKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB2YXIgdmFsdWUgPSBwcm9wcy52YWx1ZTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZU9wdGlvbnMyKG5vZGUsICEhcHJvcHMubXVsdGlwbGUsIHZhbHVlLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsRGVmYXVsdFZhbCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RQcm9wcyQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICBpZiAocHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImBkYW5nZXJvdXNseVNldElubmVySFRNTGAgZG9lcyBub3QgbWFrZSBzZW5zZSBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGhvc3RQcm9wcyA9IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgIHZhbHVlOiB2b2lkIDAsCiAgICAgICAgICAgIGRlZmF1bHRWYWx1ZTogdm9pZCAwLAogICAgICAgICAgICBjaGlsZHJlbjogdG9TdHJpbmcobm9kZS5fd3JhcHBlclN0YXRlLmluaXRpYWxWYWx1ZSkKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGhvc3RQcm9wczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFdyYXBwZXJTdGF0ZSQyKGVsZW1lbnQsIHByb3BzKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGVsZW1lbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ29udHJvbGxlZFZhbHVlUHJvcHMoInRleHRhcmVhIiwgcHJvcHMpOwogICAgICAgICAgICBpZiAocHJvcHMudmFsdWUgIT09IHZvaWQgMCAmJiBwcm9wcy5kZWZhdWx0VmFsdWUgIT09IHZvaWQgMCAmJiAhZGlkV2FyblZhbERlZmF1bHRWYWwpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgY29udGFpbnMgYSB0ZXh0YXJlYSB3aXRoIGJvdGggdmFsdWUgYW5kIGRlZmF1bHRWYWx1ZSBwcm9wcy4gVGV4dGFyZWEgZWxlbWVudHMgbXVzdCBiZSBlaXRoZXIgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgKHNwZWNpZnkgZWl0aGVyIHRoZSB2YWx1ZSBwcm9wLCBvciB0aGUgZGVmYXVsdFZhbHVlIHByb3AsIGJ1dCBub3QgYm90aCkuIERlY2lkZSBiZXR3ZWVuIHVzaW5nIGEgY29udHJvbGxlZCBvciB1bmNvbnRyb2xsZWQgdGV4dGFyZWEgYW5kIHJlbW92ZSBvbmUgb2YgdGhlc2UgcHJvcHMuIE1vcmUgaW5mbzogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2NvbnRyb2xsZWQtY29tcG9uZW50cyIsIGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgZGlkV2FyblZhbERlZmF1bHRWYWwgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaW5pdGlhbFZhbHVlID0gcHJvcHMudmFsdWU7CiAgICAgICAgICBpZiAoaW5pdGlhbFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gcHJvcHMuY2hpbGRyZW4sIGRlZmF1bHRWYWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZTsKICAgICAgICAgICAgaWYgKGNoaWxkcmVuICE9IG51bGwpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiVXNlIHRoZSBgZGVmYXVsdFZhbHVlYCBvciBgdmFsdWVgIHByb3BzIGluc3RlYWQgb2Ygc2V0dGluZyBjaGlsZHJlbiBvbiA8dGV4dGFyZWE+LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJZiB5b3Ugc3VwcGx5IGBkZWZhdWx0VmFsdWVgIG9uIGEgPHRleHRhcmVhPiwgZG8gbm90IHBhc3MgY2hpbGRyZW4uIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaXNBcnJheTIoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCI8dGV4dGFyZWE+IGNhbiBvbmx5IGhhdmUgYXQgbW9zdCBvbmUgY2hpbGQuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2hpbGRyZW4gPSBjaGlsZHJlblswXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlZmF1bHRWYWx1ZSA9IGNoaWxkcmVuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICBkZWZhdWx0VmFsdWUgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbml0aWFsVmFsdWUgPSBkZWZhdWx0VmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgICBub2RlLl93cmFwcGVyU3RhdGUgPSB7CiAgICAgICAgICAgIGluaXRpYWxWYWx1ZTogZ2V0VG9TdHJpbmdWYWx1ZShpbml0aWFsVmFsdWUpCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVXcmFwcGVyJDEoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB2YWx1ZSA9IGdldFRvU3RyaW5nVmFsdWUocHJvcHMudmFsdWUpOwogICAgICAgICAgdmFyIGRlZmF1bHRWYWx1ZSA9IGdldFRvU3RyaW5nVmFsdWUocHJvcHMuZGVmYXVsdFZhbHVlKTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHRvU3RyaW5nKHZhbHVlKTsKICAgICAgICAgICAgaWYgKG5ld1ZhbHVlICE9PSBub2RlLnZhbHVlKSB7CiAgICAgICAgICAgICAgbm9kZS52YWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wcy5kZWZhdWx0VmFsdWUgPT0gbnVsbCAmJiBub2RlLmRlZmF1bHRWYWx1ZSAhPT0gbmV3VmFsdWUpIHsKICAgICAgICAgICAgICBub2RlLmRlZmF1bHRWYWx1ZSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgbm9kZS5kZWZhdWx0VmFsdWUgPSB0b1N0cmluZyhkZWZhdWx0VmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3N0TW91bnRXcmFwcGVyJDMoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHZhciBub2RlID0gZWxlbWVudDsKICAgICAgICAgIHZhciB0ZXh0Q29udGVudCA9IG5vZGUudGV4dENvbnRlbnQ7CiAgICAgICAgICBpZiAodGV4dENvbnRlbnQgPT09IG5vZGUuX3dyYXBwZXJTdGF0ZS5pbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgaWYgKHRleHRDb250ZW50ICE9PSAiIiAmJiB0ZXh0Q29udGVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUudmFsdWUgPSB0ZXh0Q29udGVudDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDIoZWxlbWVudCwgcHJvcHMpIHsKICAgICAgICAgIHVwZGF0ZVdyYXBwZXIkMShlbGVtZW50LCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIHZhciBIVE1MX05BTUVTUEFDRSA9ICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIjsKICAgICAgICB2YXIgTUFUSF9OQU1FU1BBQ0UgPSAiaHR0cDovL3d3dy53My5vcmcvMTk5OC9NYXRoL01hdGhNTCI7CiAgICAgICAgdmFyIFNWR19OQU1FU1BBQ0UgPSAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciOwogICAgICAgIGZ1bmN0aW9uIGdldEludHJpbnNpY05hbWVzcGFjZSh0eXBlKSB7CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSAic3ZnIjoKICAgICAgICAgICAgICByZXR1cm4gU1ZHX05BTUVTUEFDRTsKICAgICAgICAgICAgY2FzZSAibWF0aCI6CiAgICAgICAgICAgICAgcmV0dXJuIE1BVEhfTkFNRVNQQUNFOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBIVE1MX05BTUVTUEFDRTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q2hpbGROYW1lc3BhY2UocGFyZW50TmFtZXNwYWNlLCB0eXBlKSB7CiAgICAgICAgICBpZiAocGFyZW50TmFtZXNwYWNlID09IG51bGwgfHwgcGFyZW50TmFtZXNwYWNlID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICByZXR1cm4gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcmVudE5hbWVzcGFjZSA9PT0gU1ZHX05BTUVTUEFDRSAmJiB0eXBlID09PSAiZm9yZWlnbk9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuIEhUTUxfTkFNRVNQQUNFOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhcmVudE5hbWVzcGFjZTsKICAgICAgICB9CiAgICAgICAgdmFyIGNyZWF0ZU1pY3Jvc29mdFVuc2FmZUxvY2FsRnVuY3Rpb24gPSBmdW5jdGlvbihmdW5jKSB7CiAgICAgICAgICBpZiAodHlwZW9mIE1TQXBwICE9PSAidW5kZWZpbmVkIiAmJiBNU0FwcC5leGVjVW5zYWZlTG9jYWxGdW5jdGlvbikgewogICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJnMCwgYXJnMSwgYXJnMiwgYXJnMykgewogICAgICAgICAgICAgIE1TQXBwLmV4ZWNVbnNhZmVMb2NhbEZ1bmN0aW9uKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmMoYXJnMCwgYXJnMSwgYXJnMiwgYXJnMyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZnVuYzsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciByZXVzYWJsZVNWR0NvbnRhaW5lcjsKICAgICAgICB2YXIgc2V0SW5uZXJIVE1MID0gY3JlYXRlTWljcm9zb2Z0VW5zYWZlTG9jYWxGdW5jdGlvbihmdW5jdGlvbihub2RlLCBodG1sKSB7CiAgICAgICAgICBpZiAobm9kZS5uYW1lc3BhY2VVUkkgPT09IFNWR19OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgaWYgKCEoImlubmVySFRNTCIgaW4gbm9kZSkpIHsKICAgICAgICAgICAgICByZXVzYWJsZVNWR0NvbnRhaW5lciA9IHJldXNhYmxlU1ZHQ29udGFpbmVyIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICAgIHJldXNhYmxlU1ZHQ29udGFpbmVyLmlubmVySFRNTCA9ICI8c3ZnPiIgKyBodG1sLnZhbHVlT2YoKS50b1N0cmluZygpICsgIjwvc3ZnPiI7CiAgICAgICAgICAgICAgdmFyIHN2Z05vZGUgPSByZXVzYWJsZVNWR0NvbnRhaW5lci5maXJzdENoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChub2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQ2hpbGQobm9kZS5maXJzdENoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKHN2Z05vZGUuZmlyc3RDaGlsZCkgewogICAgICAgICAgICAgICAgbm9kZS5hcHBlbmRDaGlsZChzdmdOb2RlLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG5vZGUuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICB9KTsKICAgICAgICB2YXIgRUxFTUVOVF9OT0RFID0gMTsKICAgICAgICB2YXIgVEVYVF9OT0RFID0gMzsKICAgICAgICB2YXIgQ09NTUVOVF9OT0RFID0gODsKICAgICAgICB2YXIgRE9DVU1FTlRfTk9ERSA9IDk7CiAgICAgICAgdmFyIERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgPSAxMTsKICAgICAgICB2YXIgc2V0VGV4dENvbnRlbnQgPSBmdW5jdGlvbihub2RlLCB0ZXh0KSB7CiAgICAgICAgICBpZiAodGV4dCkgewogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IG5vZGUuZmlyc3RDaGlsZDsKICAgICAgICAgICAgaWYgKGZpcnN0Q2hpbGQgJiYgZmlyc3RDaGlsZCA9PT0gbm9kZS5sYXN0Q2hpbGQgJiYgZmlyc3RDaGlsZC5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5ub2RlVmFsdWUgPSB0ZXh0OwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgbm9kZS50ZXh0Q29udGVudCA9IHRleHQ7CiAgICAgICAgfTsKICAgICAgICB2YXIgc2hvcnRoYW5kVG9Mb25naGFuZCA9IHsKICAgICAgICAgIGFuaW1hdGlvbjogWyJhbmltYXRpb25EZWxheSIsICJhbmltYXRpb25EaXJlY3Rpb24iLCAiYW5pbWF0aW9uRHVyYXRpb24iLCAiYW5pbWF0aW9uRmlsbE1vZGUiLCAiYW5pbWF0aW9uSXRlcmF0aW9uQ291bnQiLCAiYW5pbWF0aW9uTmFtZSIsICJhbmltYXRpb25QbGF5U3RhdGUiLCAiYW5pbWF0aW9uVGltaW5nRnVuY3Rpb24iXSwKICAgICAgICAgIGJhY2tncm91bmQ6IFsiYmFja2dyb3VuZEF0dGFjaG1lbnQiLCAiYmFja2dyb3VuZENsaXAiLCAiYmFja2dyb3VuZENvbG9yIiwgImJhY2tncm91bmRJbWFnZSIsICJiYWNrZ3JvdW5kT3JpZ2luIiwgImJhY2tncm91bmRQb3NpdGlvblgiLCAiYmFja2dyb3VuZFBvc2l0aW9uWSIsICJiYWNrZ3JvdW5kUmVwZWF0IiwgImJhY2tncm91bmRTaXplIl0sCiAgICAgICAgICBiYWNrZ3JvdW5kUG9zaXRpb246IFsiYmFja2dyb3VuZFBvc2l0aW9uWCIsICJiYWNrZ3JvdW5kUG9zaXRpb25ZIl0sCiAgICAgICAgICBib3JkZXI6IFsiYm9yZGVyQm90dG9tQ29sb3IiLCAiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyQm90dG9tV2lkdGgiLCAiYm9yZGVySW1hZ2VPdXRzZXQiLCAiYm9yZGVySW1hZ2VSZXBlYXQiLCAiYm9yZGVySW1hZ2VTbGljZSIsICJib3JkZXJJbWFnZVNvdXJjZSIsICJib3JkZXJJbWFnZVdpZHRoIiwgImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0Q29sb3IiLCAiYm9yZGVyUmlnaHRTdHlsZSIsICJib3JkZXJSaWdodFdpZHRoIiwgImJvcmRlclRvcENvbG9yIiwgImJvcmRlclRvcFN0eWxlIiwgImJvcmRlclRvcFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJCbG9ja0VuZDogWyJib3JkZXJCbG9ja0VuZENvbG9yIiwgImJvcmRlckJsb2NrRW5kU3R5bGUiLCAiYm9yZGVyQmxvY2tFbmRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyQmxvY2tTdGFydDogWyJib3JkZXJCbG9ja1N0YXJ0Q29sb3IiLCAiYm9yZGVyQmxvY2tTdGFydFN0eWxlIiwgImJvcmRlckJsb2NrU3RhcnRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyQm90dG9tOiBbImJvcmRlckJvdHRvbUNvbG9yIiwgImJvcmRlckJvdHRvbVN0eWxlIiwgImJvcmRlckJvdHRvbVdpZHRoIl0sCiAgICAgICAgICBib3JkZXJDb2xvcjogWyJib3JkZXJCb3R0b21Db2xvciIsICJib3JkZXJMZWZ0Q29sb3IiLCAiYm9yZGVyUmlnaHRDb2xvciIsICJib3JkZXJUb3BDb2xvciJdLAogICAgICAgICAgYm9yZGVySW1hZ2U6IFsiYm9yZGVySW1hZ2VPdXRzZXQiLCAiYm9yZGVySW1hZ2VSZXBlYXQiLCAiYm9yZGVySW1hZ2VTbGljZSIsICJib3JkZXJJbWFnZVNvdXJjZSIsICJib3JkZXJJbWFnZVdpZHRoIl0sCiAgICAgICAgICBib3JkZXJJbmxpbmVFbmQ6IFsiYm9yZGVySW5saW5lRW5kQ29sb3IiLCAiYm9yZGVySW5saW5lRW5kU3R5bGUiLCAiYm9yZGVySW5saW5lRW5kV2lkdGgiXSwKICAgICAgICAgIGJvcmRlcklubGluZVN0YXJ0OiBbImJvcmRlcklubGluZVN0YXJ0Q29sb3IiLCAiYm9yZGVySW5saW5lU3RhcnRTdHlsZSIsICJib3JkZXJJbmxpbmVTdGFydFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJMZWZ0OiBbImJvcmRlckxlZnRDb2xvciIsICJib3JkZXJMZWZ0U3R5bGUiLCAiYm9yZGVyTGVmdFdpZHRoIl0sCiAgICAgICAgICBib3JkZXJSYWRpdXM6IFsiYm9yZGVyQm90dG9tTGVmdFJhZGl1cyIsICJib3JkZXJCb3R0b21SaWdodFJhZGl1cyIsICJib3JkZXJUb3BMZWZ0UmFkaXVzIiwgImJvcmRlclRvcFJpZ2h0UmFkaXVzIl0sCiAgICAgICAgICBib3JkZXJSaWdodDogWyJib3JkZXJSaWdodENvbG9yIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyUmlnaHRXaWR0aCJdLAogICAgICAgICAgYm9yZGVyU3R5bGU6IFsiYm9yZGVyQm90dG9tU3R5bGUiLCAiYm9yZGVyTGVmdFN0eWxlIiwgImJvcmRlclJpZ2h0U3R5bGUiLCAiYm9yZGVyVG9wU3R5bGUiXSwKICAgICAgICAgIGJvcmRlclRvcDogWyJib3JkZXJUb3BDb2xvciIsICJib3JkZXJUb3BTdHlsZSIsICJib3JkZXJUb3BXaWR0aCJdLAogICAgICAgICAgYm9yZGVyV2lkdGg6IFsiYm9yZGVyQm90dG9tV2lkdGgiLCAiYm9yZGVyTGVmdFdpZHRoIiwgImJvcmRlclJpZ2h0V2lkdGgiLCAiYm9yZGVyVG9wV2lkdGgiXSwKICAgICAgICAgIGNvbHVtblJ1bGU6IFsiY29sdW1uUnVsZUNvbG9yIiwgImNvbHVtblJ1bGVTdHlsZSIsICJjb2x1bW5SdWxlV2lkdGgiXSwKICAgICAgICAgIGNvbHVtbnM6IFsiY29sdW1uQ291bnQiLCAiY29sdW1uV2lkdGgiXSwKICAgICAgICAgIGZsZXg6IFsiZmxleEJhc2lzIiwgImZsZXhHcm93IiwgImZsZXhTaHJpbmsiXSwKICAgICAgICAgIGZsZXhGbG93OiBbImZsZXhEaXJlY3Rpb24iLCAiZmxleFdyYXAiXSwKICAgICAgICAgIGZvbnQ6IFsiZm9udEZhbWlseSIsICJmb250RmVhdHVyZVNldHRpbmdzIiwgImZvbnRLZXJuaW5nIiwgImZvbnRMYW5ndWFnZU92ZXJyaWRlIiwgImZvbnRTaXplIiwgImZvbnRTaXplQWRqdXN0IiwgImZvbnRTdHJldGNoIiwgImZvbnRTdHlsZSIsICJmb250VmFyaWFudCIsICJmb250VmFyaWFudEFsdGVybmF0ZXMiLCAiZm9udFZhcmlhbnRDYXBzIiwgImZvbnRWYXJpYW50RWFzdEFzaWFuIiwgImZvbnRWYXJpYW50TGlnYXR1cmVzIiwgImZvbnRWYXJpYW50TnVtZXJpYyIsICJmb250VmFyaWFudFBvc2l0aW9uIiwgImZvbnRXZWlnaHQiLCAibGluZUhlaWdodCJdLAogICAgICAgICAgZm9udFZhcmlhbnQ6IFsiZm9udFZhcmlhbnRBbHRlcm5hdGVzIiwgImZvbnRWYXJpYW50Q2FwcyIsICJmb250VmFyaWFudEVhc3RBc2lhbiIsICJmb250VmFyaWFudExpZ2F0dXJlcyIsICJmb250VmFyaWFudE51bWVyaWMiLCAiZm9udFZhcmlhbnRQb3NpdGlvbiJdLAogICAgICAgICAgZ2FwOiBbImNvbHVtbkdhcCIsICJyb3dHYXAiXSwKICAgICAgICAgIGdyaWQ6IFsiZ3JpZEF1dG9Db2x1bW5zIiwgImdyaWRBdXRvRmxvdyIsICJncmlkQXV0b1Jvd3MiLCAiZ3JpZFRlbXBsYXRlQXJlYXMiLCAiZ3JpZFRlbXBsYXRlQ29sdW1ucyIsICJncmlkVGVtcGxhdGVSb3dzIl0sCiAgICAgICAgICBncmlkQXJlYTogWyJncmlkQ29sdW1uRW5kIiwgImdyaWRDb2x1bW5TdGFydCIsICJncmlkUm93RW5kIiwgImdyaWRSb3dTdGFydCJdLAogICAgICAgICAgZ3JpZENvbHVtbjogWyJncmlkQ29sdW1uRW5kIiwgImdyaWRDb2x1bW5TdGFydCJdLAogICAgICAgICAgZ3JpZENvbHVtbkdhcDogWyJjb2x1bW5HYXAiXSwKICAgICAgICAgIGdyaWRHYXA6IFsiY29sdW1uR2FwIiwgInJvd0dhcCJdLAogICAgICAgICAgZ3JpZFJvdzogWyJncmlkUm93RW5kIiwgImdyaWRSb3dTdGFydCJdLAogICAgICAgICAgZ3JpZFJvd0dhcDogWyJyb3dHYXAiXSwKICAgICAgICAgIGdyaWRUZW1wbGF0ZTogWyJncmlkVGVtcGxhdGVBcmVhcyIsICJncmlkVGVtcGxhdGVDb2x1bW5zIiwgImdyaWRUZW1wbGF0ZVJvd3MiXSwKICAgICAgICAgIGxpc3RTdHlsZTogWyJsaXN0U3R5bGVJbWFnZSIsICJsaXN0U3R5bGVQb3NpdGlvbiIsICJsaXN0U3R5bGVUeXBlIl0sCiAgICAgICAgICBtYXJnaW46IFsibWFyZ2luQm90dG9tIiwgIm1hcmdpbkxlZnQiLCAibWFyZ2luUmlnaHQiLCAibWFyZ2luVG9wIl0sCiAgICAgICAgICBtYXJrZXI6IFsibWFya2VyRW5kIiwgIm1hcmtlck1pZCIsICJtYXJrZXJTdGFydCJdLAogICAgICAgICAgbWFzazogWyJtYXNrQ2xpcCIsICJtYXNrQ29tcG9zaXRlIiwgIm1hc2tJbWFnZSIsICJtYXNrTW9kZSIsICJtYXNrT3JpZ2luIiwgIm1hc2tQb3NpdGlvblgiLCAibWFza1Bvc2l0aW9uWSIsICJtYXNrUmVwZWF0IiwgIm1hc2tTaXplIl0sCiAgICAgICAgICBtYXNrUG9zaXRpb246IFsibWFza1Bvc2l0aW9uWCIsICJtYXNrUG9zaXRpb25ZIl0sCiAgICAgICAgICBvdXRsaW5lOiBbIm91dGxpbmVDb2xvciIsICJvdXRsaW5lU3R5bGUiLCAib3V0bGluZVdpZHRoIl0sCiAgICAgICAgICBvdmVyZmxvdzogWyJvdmVyZmxvd1giLCAib3ZlcmZsb3dZIl0sCiAgICAgICAgICBwYWRkaW5nOiBbInBhZGRpbmdCb3R0b20iLCAicGFkZGluZ0xlZnQiLCAicGFkZGluZ1JpZ2h0IiwgInBhZGRpbmdUb3AiXSwKICAgICAgICAgIHBsYWNlQ29udGVudDogWyJhbGlnbkNvbnRlbnQiLCAianVzdGlmeUNvbnRlbnQiXSwKICAgICAgICAgIHBsYWNlSXRlbXM6IFsiYWxpZ25JdGVtcyIsICJqdXN0aWZ5SXRlbXMiXSwKICAgICAgICAgIHBsYWNlU2VsZjogWyJhbGlnblNlbGYiLCAianVzdGlmeVNlbGYiXSwKICAgICAgICAgIHRleHREZWNvcmF0aW9uOiBbInRleHREZWNvcmF0aW9uQ29sb3IiLCAidGV4dERlY29yYXRpb25MaW5lIiwgInRleHREZWNvcmF0aW9uU3R5bGUiXSwKICAgICAgICAgIHRleHRFbXBoYXNpczogWyJ0ZXh0RW1waGFzaXNDb2xvciIsICJ0ZXh0RW1waGFzaXNTdHlsZSJdLAogICAgICAgICAgdHJhbnNpdGlvbjogWyJ0cmFuc2l0aW9uRGVsYXkiLCAidHJhbnNpdGlvbkR1cmF0aW9uIiwgInRyYW5zaXRpb25Qcm9wZXJ0eSIsICJ0cmFuc2l0aW9uVGltaW5nRnVuY3Rpb24iXSwKICAgICAgICAgIHdvcmRXcmFwOiBbIm92ZXJmbG93V3JhcCJdCiAgICAgICAgfTsKICAgICAgICB2YXIgaXNVbml0bGVzc051bWJlciA9IHsKICAgICAgICAgIGFuaW1hdGlvbkl0ZXJhdGlvbkNvdW50OiB0cnVlLAogICAgICAgICAgYXNwZWN0UmF0aW86IHRydWUsCiAgICAgICAgICBib3JkZXJJbWFnZU91dHNldDogdHJ1ZSwKICAgICAgICAgIGJvcmRlckltYWdlU2xpY2U6IHRydWUsCiAgICAgICAgICBib3JkZXJJbWFnZVdpZHRoOiB0cnVlLAogICAgICAgICAgYm94RmxleDogdHJ1ZSwKICAgICAgICAgIGJveEZsZXhHcm91cDogdHJ1ZSwKICAgICAgICAgIGJveE9yZGluYWxHcm91cDogdHJ1ZSwKICAgICAgICAgIGNvbHVtbkNvdW50OiB0cnVlLAogICAgICAgICAgY29sdW1uczogdHJ1ZSwKICAgICAgICAgIGZsZXg6IHRydWUsCiAgICAgICAgICBmbGV4R3JvdzogdHJ1ZSwKICAgICAgICAgIGZsZXhQb3NpdGl2ZTogdHJ1ZSwKICAgICAgICAgIGZsZXhTaHJpbms6IHRydWUsCiAgICAgICAgICBmbGV4TmVnYXRpdmU6IHRydWUsCiAgICAgICAgICBmbGV4T3JkZXI6IHRydWUsCiAgICAgICAgICBncmlkQXJlYTogdHJ1ZSwKICAgICAgICAgIGdyaWRSb3c6IHRydWUsCiAgICAgICAgICBncmlkUm93RW5kOiB0cnVlLAogICAgICAgICAgZ3JpZFJvd1NwYW46IHRydWUsCiAgICAgICAgICBncmlkUm93U3RhcnQ6IHRydWUsCiAgICAgICAgICBncmlkQ29sdW1uOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtbkVuZDogdHJ1ZSwKICAgICAgICAgIGdyaWRDb2x1bW5TcGFuOiB0cnVlLAogICAgICAgICAgZ3JpZENvbHVtblN0YXJ0OiB0cnVlLAogICAgICAgICAgZm9udFdlaWdodDogdHJ1ZSwKICAgICAgICAgIGxpbmVDbGFtcDogdHJ1ZSwKICAgICAgICAgIGxpbmVIZWlnaHQ6IHRydWUsCiAgICAgICAgICBvcGFjaXR5OiB0cnVlLAogICAgICAgICAgb3JkZXI6IHRydWUsCiAgICAgICAgICBvcnBoYW5zOiB0cnVlLAogICAgICAgICAgdGFiU2l6ZTogdHJ1ZSwKICAgICAgICAgIHdpZG93czogdHJ1ZSwKICAgICAgICAgIHpJbmRleDogdHJ1ZSwKICAgICAgICAgIHpvb206IHRydWUsCiAgICAgICAgICAvLyBTVkctcmVsYXRlZCBwcm9wZXJ0aWVzCiAgICAgICAgICBmaWxsT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgIGZsb29kT3BhY2l0eTogdHJ1ZSwKICAgICAgICAgIHN0b3BPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlRGFzaGFycmF5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlRGFzaG9mZnNldDogdHJ1ZSwKICAgICAgICAgIHN0cm9rZU1pdGVybGltaXQ6IHRydWUsCiAgICAgICAgICBzdHJva2VPcGFjaXR5OiB0cnVlLAogICAgICAgICAgc3Ryb2tlV2lkdGg6IHRydWUKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHByZWZpeEtleShwcmVmaXgyLCBrZXkpIHsKICAgICAgICAgIHJldHVybiBwcmVmaXgyICsga2V5LmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsga2V5LnN1YnN0cmluZygxKTsKICAgICAgICB9CiAgICAgICAgdmFyIHByZWZpeGVzMiA9IFsiV2Via2l0IiwgIm1zIiwgIk1veiIsICJPIl07CiAgICAgICAgT2JqZWN0LmtleXMoaXNVbml0bGVzc051bWJlcikuZm9yRWFjaChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICBwcmVmaXhlczIuZm9yRWFjaChmdW5jdGlvbihwcmVmaXgyKSB7CiAgICAgICAgICAgIGlzVW5pdGxlc3NOdW1iZXJbcHJlZml4S2V5KHByZWZpeDIsIHByb3ApXSA9IGlzVW5pdGxlc3NOdW1iZXJbcHJvcF07CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgICBmdW5jdGlvbiBkYW5nZXJvdXNTdHlsZVZhbHVlKG5hbWUsIHZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KSB7CiAgICAgICAgICB2YXIgaXNFbXB0eSA9IHZhbHVlID09IG51bGwgfHwgdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgfHwgdmFsdWUgPT09ICIiOwogICAgICAgICAgaWYgKGlzRW1wdHkpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc0N1c3RvbVByb3BlcnR5ICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgJiYgdmFsdWUgIT09IDAgJiYgIShpc1VuaXRsZXNzTnVtYmVyLmhhc093blByb3BlcnR5KG5hbWUpICYmIGlzVW5pdGxlc3NOdW1iZXJbbmFtZV0pKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSArICJweCI7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ1NTUHJvcGVydHlTdHJpbmdDb2VyY2lvbih2YWx1ZSwgbmFtZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gKCIiICsgdmFsdWUpLnRyaW0oKTsKICAgICAgICB9CiAgICAgICAgdmFyIHVwcGVyY2FzZVBhdHRlcm4gPSAvKFtBLVpdKS9nOwogICAgICAgIHZhciBtc1BhdHRlcm4gPSAvXm1zLS87CiAgICAgICAgZnVuY3Rpb24gaHlwaGVuYXRlU3R5bGVOYW1lKG5hbWUpIHsKICAgICAgICAgIHJldHVybiBuYW1lLnJlcGxhY2UodXBwZXJjYXNlUGF0dGVybiwgIi0kMSIpLnRvTG93ZXJDYXNlKCkucmVwbGFjZShtc1BhdHRlcm4sICItbXMtIik7CiAgICAgICAgfQogICAgICAgIHZhciB3YXJuVmFsaWRTdHlsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybiA9IC9eKD86d2Via2l0fG1venxvKVtBLVpdLzsKICAgICAgICAgIHZhciBtc1BhdHRlcm4kMSA9IC9eLW1zLS87CiAgICAgICAgICB2YXIgaHlwaGVuUGF0dGVybiA9IC8tKC4pL2c7CiAgICAgICAgICB2YXIgYmFkU3R5bGVWYWx1ZVdpdGhTZW1pY29sb25QYXR0ZXJuID0gLztccyokLzsKICAgICAgICAgIHZhciB3YXJuZWRTdHlsZU5hbWVzID0ge307CiAgICAgICAgICB2YXIgd2FybmVkU3R5bGVWYWx1ZXMgPSB7fTsKICAgICAgICAgIHZhciB3YXJuZWRGb3JOYU5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgdmFyIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSBmYWxzZTsKICAgICAgICAgIHZhciBjYW1lbGl6ZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgICAgICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoaHlwaGVuUGF0dGVybiwgZnVuY3Rpb24oXywgY2hhcmFjdGVyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJhY3Rlci50b1VwcGVyQ2FzZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2Fybkh5cGhlbmF0ZWRTdHlsZU5hbWUgPSBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRTdHlsZU5hbWVzLmhhc093blByb3BlcnR5KG5hbWUpICYmIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2FybmVkU3R5bGVOYW1lc1tuYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKAogICAgICAgICAgICAgICJVbnN1cHBvcnRlZCBzdHlsZSBwcm9wZXJ0eSAlcy4gRGlkIHlvdSBtZWFuICVzPyIsCiAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICAvLyBBcyBBbmRpIFNtaXRoIHN1Z2dlc3RzCiAgICAgICAgICAgICAgLy8gKGh0dHA6Ly93d3cuYW5kaXNtaXRoLmNvbS9ibG9nLzIwMTIvMDIvbW9kZXJuaXpyLXByZWZpeGVkLyksIGFuIGAtbXNgIHByZWZpeAogICAgICAgICAgICAgIC8vIGlzIGNvbnZlcnRlZCB0byBsb3dlcmNhc2UgYG1zYC4KICAgICAgICAgICAgICBjYW1lbGl6ZShuYW1lLnJlcGxhY2UobXNQYXR0ZXJuJDEsICJtcy0iKSkKICAgICAgICAgICAgKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lID0gZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVOYW1lcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSAmJiB3YXJuZWRTdHlsZU5hbWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZFN0eWxlTmFtZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiVW5zdXBwb3J0ZWQgdmVuZG9yLXByZWZpeGVkIHN0eWxlIHByb3BlcnR5ICVzLiBEaWQgeW91IG1lYW4gJXM/IiwgbmFtZSwgbmFtZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIG5hbWUuc2xpY2UoMSkpOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciB3YXJuU3R5bGVWYWx1ZVdpdGhTZW1pY29sb24gPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAod2FybmVkU3R5bGVWYWx1ZXMuaGFzT3duUHJvcGVydHkodmFsdWUpICYmIHdhcm5lZFN0eWxlVmFsdWVzW3ZhbHVlXSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRTdHlsZVZhbHVlc1t2YWx1ZV0gPSB0cnVlOwogICAgICAgICAgICBlcnJvcihgU3R5bGUgcHJvcGVydHkgdmFsdWVzIHNob3VsZG4ndCBjb250YWluIGEgc2VtaWNvbG9uLiBUcnkgIiVzOiAlcyIgaW5zdGVhZC5gLCBuYW1lLCB2YWx1ZS5yZXBsYWNlKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybiwgIiIpKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FyblN0eWxlVmFsdWVJc05hTiA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JOYU5WYWx1ZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuZWRGb3JOYU5WYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJgTmFOYCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eSA9IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh3YXJuZWRGb3JJbmZpbml0eVZhbHVlKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhcm5lZEZvckluZmluaXR5VmFsdWUgPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiYEluZmluaXR5YCBpcyBhbiBpbnZhbGlkIHZhbHVlIGZvciB0aGUgYCVzYCBjc3Mgc3R5bGUgcHJvcGVydHkuIiwgbmFtZSk7CiAgICAgICAgICB9OwogICAgICAgICAgd2FyblZhbGlkU3R5bGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCItIikgPiAtMSkgewogICAgICAgICAgICAgIHdhcm5IeXBoZW5hdGVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFZlbmRvcmVkU3R5bGVOYW1lUGF0dGVybi50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgd2FybkJhZFZlbmRvcmVkU3R5bGVOYW1lKG5hbWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGJhZFN0eWxlVmFsdWVXaXRoU2VtaWNvbG9uUGF0dGVybi50ZXN0KHZhbHVlKSkgewogICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlV2l0aFNlbWljb2xvbihuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAoaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICAgICAgICB3YXJuU3R5bGVWYWx1ZUlzTmFOKG5hbWUsIHZhbHVlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFpc0Zpbml0ZSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIHdhcm5TdHlsZVZhbHVlSXNJbmZpbml0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgd2FyblZhbGlkU3R5bGUkMSA9IHdhcm5WYWxpZFN0eWxlOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZURhbmdlcm91c1N0cmluZ0ZvclN0eWxlcyhzdHlsZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHNlcmlhbGl6ZWQgPSAiIjsKICAgICAgICAgICAgdmFyIGRlbGltaXRlciA9ICIiOwogICAgICAgICAgICBmb3IgKHZhciBzdHlsZU5hbWUgaW4gc3R5bGVzKSB7CiAgICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gc3R5bGVzW3N0eWxlTmFtZV07CiAgICAgICAgICAgICAgaWYgKHN0eWxlVmFsdWUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGlzQ3VzdG9tUHJvcGVydHkgPSBzdHlsZU5hbWUuaW5kZXhPZigiLS0iKSA9PT0gMDsKICAgICAgICAgICAgICAgIHNlcmlhbGl6ZWQgKz0gZGVsaW1pdGVyICsgKGlzQ3VzdG9tUHJvcGVydHkgPyBzdHlsZU5hbWUgOiBoeXBoZW5hdGVTdHlsZU5hbWUoc3R5bGVOYW1lKSkgKyAiOiI7CiAgICAgICAgICAgICAgICBzZXJpYWxpemVkICs9IGRhbmdlcm91c1N0eWxlVmFsdWUoc3R5bGVOYW1lLCBzdHlsZVZhbHVlLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgICAgIGRlbGltaXRlciA9ICI7IjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZWQgfHwgbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0VmFsdWVGb3JTdHlsZXMobm9kZSwgc3R5bGVzKSB7CiAgICAgICAgICB2YXIgc3R5bGUyID0gbm9kZS5zdHlsZTsKICAgICAgICAgIGZvciAodmFyIHN0eWxlTmFtZSBpbiBzdHlsZXMpIHsKICAgICAgICAgICAgaWYgKCFzdHlsZXMuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc0N1c3RvbVByb3BlcnR5ID0gc3R5bGVOYW1lLmluZGV4T2YoIi0tIikgPT09IDA7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICAgIHdhcm5WYWxpZFN0eWxlJDEoc3R5bGVOYW1lLCBzdHlsZXNbc3R5bGVOYW1lXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzdHlsZVZhbHVlID0gZGFuZ2Vyb3VzU3R5bGVWYWx1ZShzdHlsZU5hbWUsIHN0eWxlc1tzdHlsZU5hbWVdLCBpc0N1c3RvbVByb3BlcnR5KTsKICAgICAgICAgICAgaWYgKHN0eWxlTmFtZSA9PT0gImZsb2F0IikgewogICAgICAgICAgICAgIHN0eWxlTmFtZSA9ICJjc3NGbG9hdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzQ3VzdG9tUHJvcGVydHkpIHsKICAgICAgICAgICAgICBzdHlsZTIuc2V0UHJvcGVydHkoc3R5bGVOYW1lLCBzdHlsZVZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdHlsZTJbc3R5bGVOYW1lXSA9IHN0eWxlVmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNWYWx1ZUVtcHR5KHZhbHVlKSB7CiAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09ICJib29sZWFuIiB8fCB2YWx1ZSA9PT0gIiI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZXMpIHsKICAgICAgICAgIHZhciBleHBhbmRlZCA9IHt9OwogICAgICAgICAgZm9yICh2YXIga2V5IGluIHN0eWxlcykgewogICAgICAgICAgICB2YXIgbG9uZ2hhbmRzID0gc2hvcnRoYW5kVG9Mb25naGFuZFtrZXldIHx8IFtrZXldOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxvbmdoYW5kcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIGV4cGFuZGVkW2xvbmdoYW5kc1tpXV0gPSBrZXk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleHBhbmRlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVTaG9ydGhhbmRQcm9wZXJ0eUNvbGxpc2lvbkluRGV2KHN0eWxlVXBkYXRlcywgbmV4dFN0eWxlcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIW5leHRTdHlsZXMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGV4cGFuZGVkVXBkYXRlcyA9IGV4cGFuZFNob3J0aGFuZE1hcChzdHlsZVVwZGF0ZXMpOwogICAgICAgICAgICB2YXIgZXhwYW5kZWRTdHlsZXMgPSBleHBhbmRTaG9ydGhhbmRNYXAobmV4dFN0eWxlcyk7CiAgICAgICAgICAgIHZhciB3YXJuZWRBYm91dCA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gZXhwYW5kZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsS2V5ID0gZXhwYW5kZWRVcGRhdGVzW2tleV07CiAgICAgICAgICAgICAgdmFyIGNvcnJlY3RPcmlnaW5hbEtleSA9IGV4cGFuZGVkU3R5bGVzW2tleV07CiAgICAgICAgICAgICAgaWYgKGNvcnJlY3RPcmlnaW5hbEtleSAmJiBvcmlnaW5hbEtleSAhPT0gY29ycmVjdE9yaWdpbmFsS2V5KSB7CiAgICAgICAgICAgICAgICB2YXIgd2FybmluZ0tleSA9IG9yaWdpbmFsS2V5ICsgIiwiICsgY29ycmVjdE9yaWdpbmFsS2V5OwogICAgICAgICAgICAgICAgaWYgKHdhcm5lZEFib3V0W3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2FybmVkQWJvdXRbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGEgc3R5bGUgcHJvcGVydHkgZHVyaW5nIHJlcmVuZGVyICglcykgd2hlbiBhIGNvbmZsaWN0aW5nIHByb3BlcnR5IGlzIHNldCAoJXMpIGNhbiBsZWFkIHRvIHN0eWxpbmcgYnVncy4gVG8gYXZvaWQgdGhpcywgZG9uJ3QgbWl4IHNob3J0aGFuZCBhbmQgbm9uLXNob3J0aGFuZCBwcm9wZXJ0aWVzIGZvciB0aGUgc2FtZSB2YWx1ZTsgaW5zdGVhZCwgcmVwbGFjZSB0aGUgc2hvcnRoYW5kIHdpdGggc2VwYXJhdGUgdmFsdWVzLiIsIGlzVmFsdWVFbXB0eShzdHlsZVVwZGF0ZXNbb3JpZ2luYWxLZXldKSA/ICJSZW1vdmluZyIgOiAiVXBkYXRpbmciLCBvcmlnaW5hbEtleSwgY29ycmVjdE9yaWdpbmFsS2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG9taXR0ZWRDbG9zZVRhZ3MgPSB7CiAgICAgICAgICBhcmVhOiB0cnVlLAogICAgICAgICAgYmFzZTogdHJ1ZSwKICAgICAgICAgIGJyOiB0cnVlLAogICAgICAgICAgY29sOiB0cnVlLAogICAgICAgICAgZW1iZWQ6IHRydWUsCiAgICAgICAgICBocjogdHJ1ZSwKICAgICAgICAgIGltZzogdHJ1ZSwKICAgICAgICAgIGlucHV0OiB0cnVlLAogICAgICAgICAga2V5Z2VuOiB0cnVlLAogICAgICAgICAgbGluazogdHJ1ZSwKICAgICAgICAgIG1ldGE6IHRydWUsCiAgICAgICAgICBwYXJhbTogdHJ1ZSwKICAgICAgICAgIHNvdXJjZTogdHJ1ZSwKICAgICAgICAgIHRyYWNrOiB0cnVlLAogICAgICAgICAgd2JyOiB0cnVlCiAgICAgICAgICAvLyBOT1RFOiBtZW51aXRlbSdzIGNsb3NlIHRhZyBzaG91bGQgYmUgb21pdHRlZCwgYnV0IHRoYXQgY2F1c2VzIHByb2JsZW1zLgogICAgICAgIH07CiAgICAgICAgdmFyIHZvaWRFbGVtZW50VGFncyA9IGFzc2lnbjIoewogICAgICAgICAgbWVudWl0ZW06IHRydWUKICAgICAgICB9LCBvbWl0dGVkQ2xvc2VUYWdzKTsKICAgICAgICB2YXIgSFRNTCA9ICJfX2h0bWwiOwogICAgICAgIGZ1bmN0aW9uIGFzc2VydFZhbGlkUHJvcHModGFnLCBwcm9wcykgewogICAgICAgICAgaWYgKCFwcm9wcykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodm9pZEVsZW1lbnRUYWdzW3RhZ10pIHsKICAgICAgICAgICAgaWYgKHByb3BzLmNoaWxkcmVuICE9IG51bGwgfHwgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgIT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcih0YWcgKyAiIGlzIGEgdm9pZCBlbGVtZW50IHRhZyBhbmQgbXVzdCBuZWl0aGVyIGhhdmUgYGNoaWxkcmVuYCBub3IgdXNlIGBkYW5nZXJvdXNseVNldElubmVySFRNTGAuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmIChwcm9wcy5jaGlsZHJlbiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW4gb25seSBzZXQgb25lIG9mIGBjaGlsZHJlbmAgb3IgYHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9PSAib2JqZWN0IiB8fCAhKEhUTUwgaW4gcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwpKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUxgIG11c3QgYmUgaW4gdGhlIGZvcm0gYHtfX2h0bWw6IC4uLn1gLiBQbGVhc2UgdmlzaXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Rhbmdlcm91c2x5LXNldC1pbm5lci1odG1sIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghcHJvcHMuc3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nICYmIHByb3BzLmNvbnRlbnRFZGl0YWJsZSAmJiBwcm9wcy5jaGlsZHJlbiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkEgY29tcG9uZW50IGlzIGBjb250ZW50RWRpdGFibGVgIGFuZCBjb250YWlucyBgY2hpbGRyZW5gIG1hbmFnZWQgYnkgUmVhY3QuIEl0IGlzIG5vdyB5b3VyIHJlc3BvbnNpYmlsaXR5IHRvIGd1YXJhbnRlZSB0aGF0IG5vbmUgb2YgdGhvc2Ugbm9kZXMgYXJlIHVuZXhwZWN0ZWRseSBtb2RpZmllZCBvciBkdXBsaWNhdGVkLiBUaGlzIGlzIHByb2JhYmx5IG5vdCBpbnRlbnRpb25hbC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3BzLnN0eWxlICE9IG51bGwgJiYgdHlwZW9mIHByb3BzLnN0eWxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBgc3R5bGVgIHByb3AgZXhwZWN0cyBhIG1hcHBpbmcgZnJvbSBzdHlsZSBwcm9wZXJ0aWVzIHRvIHZhbHVlcywgbm90IGEgc3RyaW5nLiBGb3IgZXhhbXBsZSwgc3R5bGU9e3ttYXJnaW5SaWdodDogc3BhY2luZyArICdlbSd9fSB3aGVuIHVzaW5nIEpTWC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNDdXN0b21Db21wb25lbnQodGFnTmFtZSwgcHJvcHMpIHsKICAgICAgICAgIGlmICh0YWdOYW1lLmluZGV4T2YoIi0iKSA9PT0gLTEpIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBwcm9wcy5pcyA9PT0gInN0cmluZyI7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHRhZ05hbWUpIHsKICAgICAgICAgICAgY2FzZSAiYW5ub3RhdGlvbi14bWwiOgogICAgICAgICAgICBjYXNlICJjb2xvci1wcm9maWxlIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlIjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLXNyYyI6CiAgICAgICAgICAgIGNhc2UgImZvbnQtZmFjZS11cmkiOgogICAgICAgICAgICBjYXNlICJmb250LWZhY2UtZm9ybWF0IjoKICAgICAgICAgICAgY2FzZSAiZm9udC1mYWNlLW5hbWUiOgogICAgICAgICAgICBjYXNlICJtaXNzaW5nLWdseXBoIjoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBwb3NzaWJsZVN0YW5kYXJkTmFtZXMgPSB7CiAgICAgICAgICAvLyBIVE1MCiAgICAgICAgICBhY2NlcHQ6ICJhY2NlcHQiLAogICAgICAgICAgYWNjZXB0Y2hhcnNldDogImFjY2VwdENoYXJzZXQiLAogICAgICAgICAgImFjY2VwdC1jaGFyc2V0IjogImFjY2VwdENoYXJzZXQiLAogICAgICAgICAgYWNjZXNza2V5OiAiYWNjZXNzS2V5IiwKICAgICAgICAgIGFjdGlvbjogImFjdGlvbiIsCiAgICAgICAgICBhbGxvd2Z1bGxzY3JlZW46ICJhbGxvd0Z1bGxTY3JlZW4iLAogICAgICAgICAgYWx0OiAiYWx0IiwKICAgICAgICAgIGFzOiAiYXMiLAogICAgICAgICAgYXN5bmM6ICJhc3luYyIsCiAgICAgICAgICBhdXRvY2FwaXRhbGl6ZTogImF1dG9DYXBpdGFsaXplIiwKICAgICAgICAgIGF1dG9jb21wbGV0ZTogImF1dG9Db21wbGV0ZSIsCiAgICAgICAgICBhdXRvY29ycmVjdDogImF1dG9Db3JyZWN0IiwKICAgICAgICAgIGF1dG9mb2N1czogImF1dG9Gb2N1cyIsCiAgICAgICAgICBhdXRvcGxheTogImF1dG9QbGF5IiwKICAgICAgICAgIGF1dG9zYXZlOiAiYXV0b1NhdmUiLAogICAgICAgICAgY2FwdHVyZTogImNhcHR1cmUiLAogICAgICAgICAgY2VsbHBhZGRpbmc6ICJjZWxsUGFkZGluZyIsCiAgICAgICAgICBjZWxsc3BhY2luZzogImNlbGxTcGFjaW5nIiwKICAgICAgICAgIGNoYWxsZW5nZTogImNoYWxsZW5nZSIsCiAgICAgICAgICBjaGFyc2V0OiAiY2hhclNldCIsCiAgICAgICAgICBjaGVja2VkOiAiY2hlY2tlZCIsCiAgICAgICAgICBjaGlsZHJlbjogImNoaWxkcmVuIiwKICAgICAgICAgIGNpdGU6ICJjaXRlIiwKICAgICAgICAgIGNsYXNzOiAiY2xhc3NOYW1lIiwKICAgICAgICAgIGNsYXNzaWQ6ICJjbGFzc0lEIiwKICAgICAgICAgIGNsYXNzbmFtZTogImNsYXNzTmFtZSIsCiAgICAgICAgICBjb2xzOiAiY29scyIsCiAgICAgICAgICBjb2xzcGFuOiAiY29sU3BhbiIsCiAgICAgICAgICBjb250ZW50OiAiY29udGVudCIsCiAgICAgICAgICBjb250ZW50ZWRpdGFibGU6ICJjb250ZW50RWRpdGFibGUiLAogICAgICAgICAgY29udGV4dG1lbnU6ICJjb250ZXh0TWVudSIsCiAgICAgICAgICBjb250cm9sczogImNvbnRyb2xzIiwKICAgICAgICAgIGNvbnRyb2xzbGlzdDogImNvbnRyb2xzTGlzdCIsCiAgICAgICAgICBjb29yZHM6ICJjb29yZHMiLAogICAgICAgICAgY3Jvc3NvcmlnaW46ICJjcm9zc09yaWdpbiIsCiAgICAgICAgICBkYW5nZXJvdXNseXNldGlubmVyaHRtbDogImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwKICAgICAgICAgIGRhdGE6ICJkYXRhIiwKICAgICAgICAgIGRhdGV0aW1lOiAiZGF0ZVRpbWUiLAogICAgICAgICAgZGVmYXVsdDogImRlZmF1bHQiLAogICAgICAgICAgZGVmYXVsdGNoZWNrZWQ6ICJkZWZhdWx0Q2hlY2tlZCIsCiAgICAgICAgICBkZWZhdWx0dmFsdWU6ICJkZWZhdWx0VmFsdWUiLAogICAgICAgICAgZGVmZXI6ICJkZWZlciIsCiAgICAgICAgICBkaXI6ICJkaXIiLAogICAgICAgICAgZGlzYWJsZWQ6ICJkaXNhYmxlZCIsCiAgICAgICAgICBkaXNhYmxlcGljdHVyZWlucGljdHVyZTogImRpc2FibGVQaWN0dXJlSW5QaWN0dXJlIiwKICAgICAgICAgIGRpc2FibGVyZW1vdGVwbGF5YmFjazogImRpc2FibGVSZW1vdGVQbGF5YmFjayIsCiAgICAgICAgICBkb3dubG9hZDogImRvd25sb2FkIiwKICAgICAgICAgIGRyYWdnYWJsZTogImRyYWdnYWJsZSIsCiAgICAgICAgICBlbmN0eXBlOiAiZW5jVHlwZSIsCiAgICAgICAgICBlbnRlcmtleWhpbnQ6ICJlbnRlcktleUhpbnQiLAogICAgICAgICAgZm9yOiAiaHRtbEZvciIsCiAgICAgICAgICBmb3JtOiAiZm9ybSIsCiAgICAgICAgICBmb3JtbWV0aG9kOiAiZm9ybU1ldGhvZCIsCiAgICAgICAgICBmb3JtYWN0aW9uOiAiZm9ybUFjdGlvbiIsCiAgICAgICAgICBmb3JtZW5jdHlwZTogImZvcm1FbmNUeXBlIiwKICAgICAgICAgIGZvcm1ub3ZhbGlkYXRlOiAiZm9ybU5vVmFsaWRhdGUiLAogICAgICAgICAgZm9ybXRhcmdldDogImZvcm1UYXJnZXQiLAogICAgICAgICAgZnJhbWVib3JkZXI6ICJmcmFtZUJvcmRlciIsCiAgICAgICAgICBoZWFkZXJzOiAiaGVhZGVycyIsCiAgICAgICAgICBoZWlnaHQ6ICJoZWlnaHQiLAogICAgICAgICAgaGlkZGVuOiAiaGlkZGVuIiwKICAgICAgICAgIGhpZ2g6ICJoaWdoIiwKICAgICAgICAgIGhyZWY6ICJocmVmIiwKICAgICAgICAgIGhyZWZsYW5nOiAiaHJlZkxhbmciLAogICAgICAgICAgaHRtbGZvcjogImh0bWxGb3IiLAogICAgICAgICAgaHR0cGVxdWl2OiAiaHR0cEVxdWl2IiwKICAgICAgICAgICJodHRwLWVxdWl2IjogImh0dHBFcXVpdiIsCiAgICAgICAgICBpY29uOiAiaWNvbiIsCiAgICAgICAgICBpZDogImlkIiwKICAgICAgICAgIGltYWdlc2l6ZXM6ICJpbWFnZVNpemVzIiwKICAgICAgICAgIGltYWdlc3Jjc2V0OiAiaW1hZ2VTcmNTZXQiLAogICAgICAgICAgaW5uZXJodG1sOiAiaW5uZXJIVE1MIiwKICAgICAgICAgIGlucHV0bW9kZTogImlucHV0TW9kZSIsCiAgICAgICAgICBpbnRlZ3JpdHk6ICJpbnRlZ3JpdHkiLAogICAgICAgICAgaXM6ICJpcyIsCiAgICAgICAgICBpdGVtaWQ6ICJpdGVtSUQiLAogICAgICAgICAgaXRlbXByb3A6ICJpdGVtUHJvcCIsCiAgICAgICAgICBpdGVtcmVmOiAiaXRlbVJlZiIsCiAgICAgICAgICBpdGVtc2NvcGU6ICJpdGVtU2NvcGUiLAogICAgICAgICAgaXRlbXR5cGU6ICJpdGVtVHlwZSIsCiAgICAgICAgICBrZXlwYXJhbXM6ICJrZXlQYXJhbXMiLAogICAgICAgICAga2V5dHlwZTogImtleVR5cGUiLAogICAgICAgICAga2luZDogImtpbmQiLAogICAgICAgICAgbGFiZWw6ICJsYWJlbCIsCiAgICAgICAgICBsYW5nOiAibGFuZyIsCiAgICAgICAgICBsaXN0OiAibGlzdCIsCiAgICAgICAgICBsb29wOiAibG9vcCIsCiAgICAgICAgICBsb3c6ICJsb3ciLAogICAgICAgICAgbWFuaWZlc3Q6ICJtYW5pZmVzdCIsCiAgICAgICAgICBtYXJnaW53aWR0aDogIm1hcmdpbldpZHRoIiwKICAgICAgICAgIG1hcmdpbmhlaWdodDogIm1hcmdpbkhlaWdodCIsCiAgICAgICAgICBtYXg6ICJtYXgiLAogICAgICAgICAgbWF4bGVuZ3RoOiAibWF4TGVuZ3RoIiwKICAgICAgICAgIG1lZGlhOiAibWVkaWEiLAogICAgICAgICAgbWVkaWFncm91cDogIm1lZGlhR3JvdXAiLAogICAgICAgICAgbWV0aG9kOiAibWV0aG9kIiwKICAgICAgICAgIG1pbjogIm1pbiIsCiAgICAgICAgICBtaW5sZW5ndGg6ICJtaW5MZW5ndGgiLAogICAgICAgICAgbXVsdGlwbGU6ICJtdWx0aXBsZSIsCiAgICAgICAgICBtdXRlZDogIm11dGVkIiwKICAgICAgICAgIG5hbWU6ICJuYW1lIiwKICAgICAgICAgIG5vbW9kdWxlOiAibm9Nb2R1bGUiLAogICAgICAgICAgbm9uY2U6ICJub25jZSIsCiAgICAgICAgICBub3ZhbGlkYXRlOiAibm9WYWxpZGF0ZSIsCiAgICAgICAgICBvcGVuOiAib3BlbiIsCiAgICAgICAgICBvcHRpbXVtOiAib3B0aW11bSIsCiAgICAgICAgICBwYXR0ZXJuOiAicGF0dGVybiIsCiAgICAgICAgICBwbGFjZWhvbGRlcjogInBsYWNlaG9sZGVyIiwKICAgICAgICAgIHBsYXlzaW5saW5lOiAicGxheXNJbmxpbmUiLAogICAgICAgICAgcG9zdGVyOiAicG9zdGVyIiwKICAgICAgICAgIHByZWxvYWQ6ICJwcmVsb2FkIiwKICAgICAgICAgIHByb2ZpbGU6ICJwcm9maWxlIiwKICAgICAgICAgIHJhZGlvZ3JvdXA6ICJyYWRpb0dyb3VwIiwKICAgICAgICAgIHJlYWRvbmx5OiAicmVhZE9ubHkiLAogICAgICAgICAgcmVmZXJyZXJwb2xpY3k6ICJyZWZlcnJlclBvbGljeSIsCiAgICAgICAgICByZWw6ICJyZWwiLAogICAgICAgICAgcmVxdWlyZWQ6ICJyZXF1aXJlZCIsCiAgICAgICAgICByZXZlcnNlZDogInJldmVyc2VkIiwKICAgICAgICAgIHJvbGU6ICJyb2xlIiwKICAgICAgICAgIHJvd3M6ICJyb3dzIiwKICAgICAgICAgIHJvd3NwYW46ICJyb3dTcGFuIiwKICAgICAgICAgIHNhbmRib3g6ICJzYW5kYm94IiwKICAgICAgICAgIHNjb3BlOiAic2NvcGUiLAogICAgICAgICAgc2NvcGVkOiAic2NvcGVkIiwKICAgICAgICAgIHNjcm9sbGluZzogInNjcm9sbGluZyIsCiAgICAgICAgICBzZWFtbGVzczogInNlYW1sZXNzIiwKICAgICAgICAgIHNlbGVjdGVkOiAic2VsZWN0ZWQiLAogICAgICAgICAgc2hhcGU6ICJzaGFwZSIsCiAgICAgICAgICBzaXplOiAic2l6ZSIsCiAgICAgICAgICBzaXplczogInNpemVzIiwKICAgICAgICAgIHNwYW46ICJzcGFuIiwKICAgICAgICAgIHNwZWxsY2hlY2s6ICJzcGVsbENoZWNrIiwKICAgICAgICAgIHNyYzogInNyYyIsCiAgICAgICAgICBzcmNkb2M6ICJzcmNEb2MiLAogICAgICAgICAgc3JjbGFuZzogInNyY0xhbmciLAogICAgICAgICAgc3Jjc2V0OiAic3JjU2V0IiwKICAgICAgICAgIHN0YXJ0OiAic3RhcnQiLAogICAgICAgICAgc3RlcDogInN0ZXAiLAogICAgICAgICAgc3R5bGU6ICJzdHlsZSIsCiAgICAgICAgICBzdW1tYXJ5OiAic3VtbWFyeSIsCiAgICAgICAgICB0YWJpbmRleDogInRhYkluZGV4IiwKICAgICAgICAgIHRhcmdldDogInRhcmdldCIsCiAgICAgICAgICB0aXRsZTogInRpdGxlIiwKICAgICAgICAgIHR5cGU6ICJ0eXBlIiwKICAgICAgICAgIHVzZW1hcDogInVzZU1hcCIsCiAgICAgICAgICB2YWx1ZTogInZhbHVlIiwKICAgICAgICAgIHdpZHRoOiAid2lkdGgiLAogICAgICAgICAgd21vZGU6ICJ3bW9kZSIsCiAgICAgICAgICB3cmFwOiAid3JhcCIsCiAgICAgICAgICAvLyBTVkcKICAgICAgICAgIGFib3V0OiAiYWJvdXQiLAogICAgICAgICAgYWNjZW50aGVpZ2h0OiAiYWNjZW50SGVpZ2h0IiwKICAgICAgICAgICJhY2NlbnQtaGVpZ2h0IjogImFjY2VudEhlaWdodCIsCiAgICAgICAgICBhY2N1bXVsYXRlOiAiYWNjdW11bGF0ZSIsCiAgICAgICAgICBhZGRpdGl2ZTogImFkZGl0aXZlIiwKICAgICAgICAgIGFsaWdubWVudGJhc2VsaW5lOiAiYWxpZ25tZW50QmFzZWxpbmUiLAogICAgICAgICAgImFsaWdubWVudC1iYXNlbGluZSI6ICJhbGlnbm1lbnRCYXNlbGluZSIsCiAgICAgICAgICBhbGxvd3Jlb3JkZXI6ICJhbGxvd1Jlb3JkZXIiLAogICAgICAgICAgYWxwaGFiZXRpYzogImFscGhhYmV0aWMiLAogICAgICAgICAgYW1wbGl0dWRlOiAiYW1wbGl0dWRlIiwKICAgICAgICAgIGFyYWJpY2Zvcm06ICJhcmFiaWNGb3JtIiwKICAgICAgICAgICJhcmFiaWMtZm9ybSI6ICJhcmFiaWNGb3JtIiwKICAgICAgICAgIGFzY2VudDogImFzY2VudCIsCiAgICAgICAgICBhdHRyaWJ1dGVuYW1lOiAiYXR0cmlidXRlTmFtZSIsCiAgICAgICAgICBhdHRyaWJ1dGV0eXBlOiAiYXR0cmlidXRlVHlwZSIsCiAgICAgICAgICBhdXRvcmV2ZXJzZTogImF1dG9SZXZlcnNlIiwKICAgICAgICAgIGF6aW11dGg6ICJhemltdXRoIiwKICAgICAgICAgIGJhc2VmcmVxdWVuY3k6ICJiYXNlRnJlcXVlbmN5IiwKICAgICAgICAgIGJhc2VsaW5lc2hpZnQ6ICJiYXNlbGluZVNoaWZ0IiwKICAgICAgICAgICJiYXNlbGluZS1zaGlmdCI6ICJiYXNlbGluZVNoaWZ0IiwKICAgICAgICAgIGJhc2Vwcm9maWxlOiAiYmFzZVByb2ZpbGUiLAogICAgICAgICAgYmJveDogImJib3giLAogICAgICAgICAgYmVnaW46ICJiZWdpbiIsCiAgICAgICAgICBiaWFzOiAiYmlhcyIsCiAgICAgICAgICBieTogImJ5IiwKICAgICAgICAgIGNhbGNtb2RlOiAiY2FsY01vZGUiLAogICAgICAgICAgY2FwaGVpZ2h0OiAiY2FwSGVpZ2h0IiwKICAgICAgICAgICJjYXAtaGVpZ2h0IjogImNhcEhlaWdodCIsCiAgICAgICAgICBjbGlwOiAiY2xpcCIsCiAgICAgICAgICBjbGlwcGF0aDogImNsaXBQYXRoIiwKICAgICAgICAgICJjbGlwLXBhdGgiOiAiY2xpcFBhdGgiLAogICAgICAgICAgY2xpcHBhdGh1bml0czogImNsaXBQYXRoVW5pdHMiLAogICAgICAgICAgY2xpcHJ1bGU6ICJjbGlwUnVsZSIsCiAgICAgICAgICAiY2xpcC1ydWxlIjogImNsaXBSdWxlIiwKICAgICAgICAgIGNvbG9yOiAiY29sb3IiLAogICAgICAgICAgY29sb3JpbnRlcnBvbGF0aW9uOiAiY29sb3JJbnRlcnBvbGF0aW9uIiwKICAgICAgICAgICJjb2xvci1pbnRlcnBvbGF0aW9uIjogImNvbG9ySW50ZXJwb2xhdGlvbiIsCiAgICAgICAgICBjb2xvcmludGVycG9sYXRpb25maWx0ZXJzOiAiY29sb3JJbnRlcnBvbGF0aW9uRmlsdGVycyIsCiAgICAgICAgICAiY29sb3ItaW50ZXJwb2xhdGlvbi1maWx0ZXJzIjogImNvbG9ySW50ZXJwb2xhdGlvbkZpbHRlcnMiLAogICAgICAgICAgY29sb3Jwcm9maWxlOiAiY29sb3JQcm9maWxlIiwKICAgICAgICAgICJjb2xvci1wcm9maWxlIjogImNvbG9yUHJvZmlsZSIsCiAgICAgICAgICBjb2xvcnJlbmRlcmluZzogImNvbG9yUmVuZGVyaW5nIiwKICAgICAgICAgICJjb2xvci1yZW5kZXJpbmciOiAiY29sb3JSZW5kZXJpbmciLAogICAgICAgICAgY29udGVudHNjcmlwdHR5cGU6ICJjb250ZW50U2NyaXB0VHlwZSIsCiAgICAgICAgICBjb250ZW50c3R5bGV0eXBlOiAiY29udGVudFN0eWxlVHlwZSIsCiAgICAgICAgICBjdXJzb3I6ICJjdXJzb3IiLAogICAgICAgICAgY3g6ICJjeCIsCiAgICAgICAgICBjeTogImN5IiwKICAgICAgICAgIGQ6ICJkIiwKICAgICAgICAgIGRhdGF0eXBlOiAiZGF0YXR5cGUiLAogICAgICAgICAgZGVjZWxlcmF0ZTogImRlY2VsZXJhdGUiLAogICAgICAgICAgZGVzY2VudDogImRlc2NlbnQiLAogICAgICAgICAgZGlmZnVzZWNvbnN0YW50OiAiZGlmZnVzZUNvbnN0YW50IiwKICAgICAgICAgIGRpcmVjdGlvbjogImRpcmVjdGlvbiIsCiAgICAgICAgICBkaXNwbGF5OiAiZGlzcGxheSIsCiAgICAgICAgICBkaXZpc29yOiAiZGl2aXNvciIsCiAgICAgICAgICBkb21pbmFudGJhc2VsaW5lOiAiZG9taW5hbnRCYXNlbGluZSIsCiAgICAgICAgICAiZG9taW5hbnQtYmFzZWxpbmUiOiAiZG9taW5hbnRCYXNlbGluZSIsCiAgICAgICAgICBkdXI6ICJkdXIiLAogICAgICAgICAgZHg6ICJkeCIsCiAgICAgICAgICBkeTogImR5IiwKICAgICAgICAgIGVkZ2Vtb2RlOiAiZWRnZU1vZGUiLAogICAgICAgICAgZWxldmF0aW9uOiAiZWxldmF0aW9uIiwKICAgICAgICAgIGVuYWJsZWJhY2tncm91bmQ6ICJlbmFibGVCYWNrZ3JvdW5kIiwKICAgICAgICAgICJlbmFibGUtYmFja2dyb3VuZCI6ICJlbmFibGVCYWNrZ3JvdW5kIiwKICAgICAgICAgIGVuZDogImVuZCIsCiAgICAgICAgICBleHBvbmVudDogImV4cG9uZW50IiwKICAgICAgICAgIGV4dGVybmFscmVzb3VyY2VzcmVxdWlyZWQ6ICJleHRlcm5hbFJlc291cmNlc1JlcXVpcmVkIiwKICAgICAgICAgIGZpbGw6ICJmaWxsIiwKICAgICAgICAgIGZpbGxvcGFjaXR5OiAiZmlsbE9wYWNpdHkiLAogICAgICAgICAgImZpbGwtb3BhY2l0eSI6ICJmaWxsT3BhY2l0eSIsCiAgICAgICAgICBmaWxscnVsZTogImZpbGxSdWxlIiwKICAgICAgICAgICJmaWxsLXJ1bGUiOiAiZmlsbFJ1bGUiLAogICAgICAgICAgZmlsdGVyOiAiZmlsdGVyIiwKICAgICAgICAgIGZpbHRlcnJlczogImZpbHRlclJlcyIsCiAgICAgICAgICBmaWx0ZXJ1bml0czogImZpbHRlclVuaXRzIiwKICAgICAgICAgIGZsb29kb3BhY2l0eTogImZsb29kT3BhY2l0eSIsCiAgICAgICAgICAiZmxvb2Qtb3BhY2l0eSI6ICJmbG9vZE9wYWNpdHkiLAogICAgICAgICAgZmxvb2Rjb2xvcjogImZsb29kQ29sb3IiLAogICAgICAgICAgImZsb29kLWNvbG9yIjogImZsb29kQ29sb3IiLAogICAgICAgICAgZm9jdXNhYmxlOiAiZm9jdXNhYmxlIiwKICAgICAgICAgIGZvbnRmYW1pbHk6ICJmb250RmFtaWx5IiwKICAgICAgICAgICJmb250LWZhbWlseSI6ICJmb250RmFtaWx5IiwKICAgICAgICAgIGZvbnRzaXplOiAiZm9udFNpemUiLAogICAgICAgICAgImZvbnQtc2l6ZSI6ICJmb250U2l6ZSIsCiAgICAgICAgICBmb250c2l6ZWFkanVzdDogImZvbnRTaXplQWRqdXN0IiwKICAgICAgICAgICJmb250LXNpemUtYWRqdXN0IjogImZvbnRTaXplQWRqdXN0IiwKICAgICAgICAgIGZvbnRzdHJldGNoOiAiZm9udFN0cmV0Y2giLAogICAgICAgICAgImZvbnQtc3RyZXRjaCI6ICJmb250U3RyZXRjaCIsCiAgICAgICAgICBmb250c3R5bGU6ICJmb250U3R5bGUiLAogICAgICAgICAgImZvbnQtc3R5bGUiOiAiZm9udFN0eWxlIiwKICAgICAgICAgIGZvbnR2YXJpYW50OiAiZm9udFZhcmlhbnQiLAogICAgICAgICAgImZvbnQtdmFyaWFudCI6ICJmb250VmFyaWFudCIsCiAgICAgICAgICBmb250d2VpZ2h0OiAiZm9udFdlaWdodCIsCiAgICAgICAgICAiZm9udC13ZWlnaHQiOiAiZm9udFdlaWdodCIsCiAgICAgICAgICBmb3JtYXQ6ICJmb3JtYXQiLAogICAgICAgICAgZnJvbTogImZyb20iLAogICAgICAgICAgZng6ICJmeCIsCiAgICAgICAgICBmeTogImZ5IiwKICAgICAgICAgIGcxOiAiZzEiLAogICAgICAgICAgZzI6ICJnMiIsCiAgICAgICAgICBnbHlwaG5hbWU6ICJnbHlwaE5hbWUiLAogICAgICAgICAgImdseXBoLW5hbWUiOiAiZ2x5cGhOYW1lIiwKICAgICAgICAgIGdseXBob3JpZW50YXRpb25ob3Jpem9udGFsOiAiZ2x5cGhPcmllbnRhdGlvbkhvcml6b250YWwiLAogICAgICAgICAgImdseXBoLW9yaWVudGF0aW9uLWhvcml6b250YWwiOiAiZ2x5cGhPcmllbnRhdGlvbkhvcml6b250YWwiLAogICAgICAgICAgZ2x5cGhvcmllbnRhdGlvbnZlcnRpY2FsOiAiZ2x5cGhPcmllbnRhdGlvblZlcnRpY2FsIiwKICAgICAgICAgICJnbHlwaC1vcmllbnRhdGlvbi12ZXJ0aWNhbCI6ICJnbHlwaE9yaWVudGF0aW9uVmVydGljYWwiLAogICAgICAgICAgZ2x5cGhyZWY6ICJnbHlwaFJlZiIsCiAgICAgICAgICBncmFkaWVudHRyYW5zZm9ybTogImdyYWRpZW50VHJhbnNmb3JtIiwKICAgICAgICAgIGdyYWRpZW50dW5pdHM6ICJncmFkaWVudFVuaXRzIiwKICAgICAgICAgIGhhbmdpbmc6ICJoYW5naW5nIiwKICAgICAgICAgIGhvcml6YWR2eDogImhvcml6QWR2WCIsCiAgICAgICAgICAiaG9yaXotYWR2LXgiOiAiaG9yaXpBZHZYIiwKICAgICAgICAgIGhvcml6b3JpZ2lueDogImhvcml6T3JpZ2luWCIsCiAgICAgICAgICAiaG9yaXotb3JpZ2luLXgiOiAiaG9yaXpPcmlnaW5YIiwKICAgICAgICAgIGlkZW9ncmFwaGljOiAiaWRlb2dyYXBoaWMiLAogICAgICAgICAgaW1hZ2VyZW5kZXJpbmc6ICJpbWFnZVJlbmRlcmluZyIsCiAgICAgICAgICAiaW1hZ2UtcmVuZGVyaW5nIjogImltYWdlUmVuZGVyaW5nIiwKICAgICAgICAgIGluMjogImluMiIsCiAgICAgICAgICBpbjogImluIiwKICAgICAgICAgIGlubGlzdDogImlubGlzdCIsCiAgICAgICAgICBpbnRlcmNlcHQ6ICJpbnRlcmNlcHQiLAogICAgICAgICAgazE6ICJrMSIsCiAgICAgICAgICBrMjogImsyIiwKICAgICAgICAgIGszOiAiazMiLAogICAgICAgICAgazQ6ICJrNCIsCiAgICAgICAgICBrOiAiayIsCiAgICAgICAgICBrZXJuZWxtYXRyaXg6ICJrZXJuZWxNYXRyaXgiLAogICAgICAgICAga2VybmVsdW5pdGxlbmd0aDogImtlcm5lbFVuaXRMZW5ndGgiLAogICAgICAgICAga2VybmluZzogImtlcm5pbmciLAogICAgICAgICAga2V5cG9pbnRzOiAia2V5UG9pbnRzIiwKICAgICAgICAgIGtleXNwbGluZXM6ICJrZXlTcGxpbmVzIiwKICAgICAgICAgIGtleXRpbWVzOiAia2V5VGltZXMiLAogICAgICAgICAgbGVuZ3RoYWRqdXN0OiAibGVuZ3RoQWRqdXN0IiwKICAgICAgICAgIGxldHRlcnNwYWNpbmc6ICJsZXR0ZXJTcGFjaW5nIiwKICAgICAgICAgICJsZXR0ZXItc3BhY2luZyI6ICJsZXR0ZXJTcGFjaW5nIiwKICAgICAgICAgIGxpZ2h0aW5nY29sb3I6ICJsaWdodGluZ0NvbG9yIiwKICAgICAgICAgICJsaWdodGluZy1jb2xvciI6ICJsaWdodGluZ0NvbG9yIiwKICAgICAgICAgIGxpbWl0aW5nY29uZWFuZ2xlOiAibGltaXRpbmdDb25lQW5nbGUiLAogICAgICAgICAgbG9jYWw6ICJsb2NhbCIsCiAgICAgICAgICBtYXJrZXJlbmQ6ICJtYXJrZXJFbmQiLAogICAgICAgICAgIm1hcmtlci1lbmQiOiAibWFya2VyRW5kIiwKICAgICAgICAgIG1hcmtlcmhlaWdodDogIm1hcmtlckhlaWdodCIsCiAgICAgICAgICBtYXJrZXJtaWQ6ICJtYXJrZXJNaWQiLAogICAgICAgICAgIm1hcmtlci1taWQiOiAibWFya2VyTWlkIiwKICAgICAgICAgIG1hcmtlcnN0YXJ0OiAibWFya2VyU3RhcnQiLAogICAgICAgICAgIm1hcmtlci1zdGFydCI6ICJtYXJrZXJTdGFydCIsCiAgICAgICAgICBtYXJrZXJ1bml0czogIm1hcmtlclVuaXRzIiwKICAgICAgICAgIG1hcmtlcndpZHRoOiAibWFya2VyV2lkdGgiLAogICAgICAgICAgbWFzazogIm1hc2siLAogICAgICAgICAgbWFza2NvbnRlbnR1bml0czogIm1hc2tDb250ZW50VW5pdHMiLAogICAgICAgICAgbWFza3VuaXRzOiAibWFza1VuaXRzIiwKICAgICAgICAgIG1hdGhlbWF0aWNhbDogIm1hdGhlbWF0aWNhbCIsCiAgICAgICAgICBtb2RlOiAibW9kZSIsCiAgICAgICAgICBudW1vY3RhdmVzOiAibnVtT2N0YXZlcyIsCiAgICAgICAgICBvZmZzZXQ6ICJvZmZzZXQiLAogICAgICAgICAgb3BhY2l0eTogIm9wYWNpdHkiLAogICAgICAgICAgb3BlcmF0b3I6ICJvcGVyYXRvciIsCiAgICAgICAgICBvcmRlcjogIm9yZGVyIiwKICAgICAgICAgIG9yaWVudDogIm9yaWVudCIsCiAgICAgICAgICBvcmllbnRhdGlvbjogIm9yaWVudGF0aW9uIiwKICAgICAgICAgIG9yaWdpbjogIm9yaWdpbiIsCiAgICAgICAgICBvdmVyZmxvdzogIm92ZXJmbG93IiwKICAgICAgICAgIG92ZXJsaW5lcG9zaXRpb246ICJvdmVybGluZVBvc2l0aW9uIiwKICAgICAgICAgICJvdmVybGluZS1wb3NpdGlvbiI6ICJvdmVybGluZVBvc2l0aW9uIiwKICAgICAgICAgIG92ZXJsaW5ldGhpY2tuZXNzOiAib3ZlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgIm92ZXJsaW5lLXRoaWNrbmVzcyI6ICJvdmVybGluZVRoaWNrbmVzcyIsCiAgICAgICAgICBwYWludG9yZGVyOiAicGFpbnRPcmRlciIsCiAgICAgICAgICAicGFpbnQtb3JkZXIiOiAicGFpbnRPcmRlciIsCiAgICAgICAgICBwYW5vc2UxOiAicGFub3NlMSIsCiAgICAgICAgICAicGFub3NlLTEiOiAicGFub3NlMSIsCiAgICAgICAgICBwYXRobGVuZ3RoOiAicGF0aExlbmd0aCIsCiAgICAgICAgICBwYXR0ZXJuY29udGVudHVuaXRzOiAicGF0dGVybkNvbnRlbnRVbml0cyIsCiAgICAgICAgICBwYXR0ZXJudHJhbnNmb3JtOiAicGF0dGVyblRyYW5zZm9ybSIsCiAgICAgICAgICBwYXR0ZXJudW5pdHM6ICJwYXR0ZXJuVW5pdHMiLAogICAgICAgICAgcG9pbnRlcmV2ZW50czogInBvaW50ZXJFdmVudHMiLAogICAgICAgICAgInBvaW50ZXItZXZlbnRzIjogInBvaW50ZXJFdmVudHMiLAogICAgICAgICAgcG9pbnRzOiAicG9pbnRzIiwKICAgICAgICAgIHBvaW50c2F0eDogInBvaW50c0F0WCIsCiAgICAgICAgICBwb2ludHNhdHk6ICJwb2ludHNBdFkiLAogICAgICAgICAgcG9pbnRzYXR6OiAicG9pbnRzQXRaIiwKICAgICAgICAgIHByZWZpeDogInByZWZpeCIsCiAgICAgICAgICBwcmVzZXJ2ZWFscGhhOiAicHJlc2VydmVBbHBoYSIsCiAgICAgICAgICBwcmVzZXJ2ZWFzcGVjdHJhdGlvOiAicHJlc2VydmVBc3BlY3RSYXRpbyIsCiAgICAgICAgICBwcmltaXRpdmV1bml0czogInByaW1pdGl2ZVVuaXRzIiwKICAgICAgICAgIHByb3BlcnR5OiAicHJvcGVydHkiLAogICAgICAgICAgcjogInIiLAogICAgICAgICAgcmFkaXVzOiAicmFkaXVzIiwKICAgICAgICAgIHJlZng6ICJyZWZYIiwKICAgICAgICAgIHJlZnk6ICJyZWZZIiwKICAgICAgICAgIHJlbmRlcmluZ2ludGVudDogInJlbmRlcmluZ0ludGVudCIsCiAgICAgICAgICAicmVuZGVyaW5nLWludGVudCI6ICJyZW5kZXJpbmdJbnRlbnQiLAogICAgICAgICAgcmVwZWF0Y291bnQ6ICJyZXBlYXRDb3VudCIsCiAgICAgICAgICByZXBlYXRkdXI6ICJyZXBlYXREdXIiLAogICAgICAgICAgcmVxdWlyZWRleHRlbnNpb25zOiAicmVxdWlyZWRFeHRlbnNpb25zIiwKICAgICAgICAgIHJlcXVpcmVkZmVhdHVyZXM6ICJyZXF1aXJlZEZlYXR1cmVzIiwKICAgICAgICAgIHJlc291cmNlOiAicmVzb3VyY2UiLAogICAgICAgICAgcmVzdGFydDogInJlc3RhcnQiLAogICAgICAgICAgcmVzdWx0OiAicmVzdWx0IiwKICAgICAgICAgIHJlc3VsdHM6ICJyZXN1bHRzIiwKICAgICAgICAgIHJvdGF0ZTogInJvdGF0ZSIsCiAgICAgICAgICByeDogInJ4IiwKICAgICAgICAgIHJ5OiAicnkiLAogICAgICAgICAgc2NhbGU6ICJzY2FsZSIsCiAgICAgICAgICBzZWN1cml0eTogInNlY3VyaXR5IiwKICAgICAgICAgIHNlZWQ6ICJzZWVkIiwKICAgICAgICAgIHNoYXBlcmVuZGVyaW5nOiAic2hhcGVSZW5kZXJpbmciLAogICAgICAgICAgInNoYXBlLXJlbmRlcmluZyI6ICJzaGFwZVJlbmRlcmluZyIsCiAgICAgICAgICBzbG9wZTogInNsb3BlIiwKICAgICAgICAgIHNwYWNpbmc6ICJzcGFjaW5nIiwKICAgICAgICAgIHNwZWN1bGFyY29uc3RhbnQ6ICJzcGVjdWxhckNvbnN0YW50IiwKICAgICAgICAgIHNwZWN1bGFyZXhwb25lbnQ6ICJzcGVjdWxhckV4cG9uZW50IiwKICAgICAgICAgIHNwZWVkOiAic3BlZWQiLAogICAgICAgICAgc3ByZWFkbWV0aG9kOiAic3ByZWFkTWV0aG9kIiwKICAgICAgICAgIHN0YXJ0b2Zmc2V0OiAic3RhcnRPZmZzZXQiLAogICAgICAgICAgc3RkZGV2aWF0aW9uOiAic3RkRGV2aWF0aW9uIiwKICAgICAgICAgIHN0ZW1oOiAic3RlbWgiLAogICAgICAgICAgc3RlbXY6ICJzdGVtdiIsCiAgICAgICAgICBzdGl0Y2h0aWxlczogInN0aXRjaFRpbGVzIiwKICAgICAgICAgIHN0b3Bjb2xvcjogInN0b3BDb2xvciIsCiAgICAgICAgICAic3RvcC1jb2xvciI6ICJzdG9wQ29sb3IiLAogICAgICAgICAgc3RvcG9wYWNpdHk6ICJzdG9wT3BhY2l0eSIsCiAgICAgICAgICAic3RvcC1vcGFjaXR5IjogInN0b3BPcGFjaXR5IiwKICAgICAgICAgIHN0cmlrZXRocm91Z2hwb3NpdGlvbjogInN0cmlrZXRocm91Z2hQb3NpdGlvbiIsCiAgICAgICAgICAic3RyaWtldGhyb3VnaC1wb3NpdGlvbiI6ICJzdHJpa2V0aHJvdWdoUG9zaXRpb24iLAogICAgICAgICAgc3RyaWtldGhyb3VnaHRoaWNrbmVzczogInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICAgICAgICAgInN0cmlrZXRocm91Z2gtdGhpY2tuZXNzIjogInN0cmlrZXRocm91Z2hUaGlja25lc3MiLAogICAgICAgICAgc3RyaW5nOiAic3RyaW5nIiwKICAgICAgICAgIHN0cm9rZTogInN0cm9rZSIsCiAgICAgICAgICBzdHJva2VkYXNoYXJyYXk6ICJzdHJva2VEYXNoYXJyYXkiLAogICAgICAgICAgInN0cm9rZS1kYXNoYXJyYXkiOiAic3Ryb2tlRGFzaGFycmF5IiwKICAgICAgICAgIHN0cm9rZWRhc2hvZmZzZXQ6ICJzdHJva2VEYXNob2Zmc2V0IiwKICAgICAgICAgICJzdHJva2UtZGFzaG9mZnNldCI6ICJzdHJva2VEYXNob2Zmc2V0IiwKICAgICAgICAgIHN0cm9rZWxpbmVjYXA6ICJzdHJva2VMaW5lY2FwIiwKICAgICAgICAgICJzdHJva2UtbGluZWNhcCI6ICJzdHJva2VMaW5lY2FwIiwKICAgICAgICAgIHN0cm9rZWxpbmVqb2luOiAic3Ryb2tlTGluZWpvaW4iLAogICAgICAgICAgInN0cm9rZS1saW5lam9pbiI6ICJzdHJva2VMaW5lam9pbiIsCiAgICAgICAgICBzdHJva2VtaXRlcmxpbWl0OiAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgICAgICAgICAic3Ryb2tlLW1pdGVybGltaXQiOiAic3Ryb2tlTWl0ZXJsaW1pdCIsCiAgICAgICAgICBzdHJva2V3aWR0aDogInN0cm9rZVdpZHRoIiwKICAgICAgICAgICJzdHJva2Utd2lkdGgiOiAic3Ryb2tlV2lkdGgiLAogICAgICAgICAgc3Ryb2tlb3BhY2l0eTogInN0cm9rZU9wYWNpdHkiLAogICAgICAgICAgInN0cm9rZS1vcGFjaXR5IjogInN0cm9rZU9wYWNpdHkiLAogICAgICAgICAgc3VwcHJlc3Njb250ZW50ZWRpdGFibGV3YXJuaW5nOiAic3VwcHJlc3NDb250ZW50RWRpdGFibGVXYXJuaW5nIiwKICAgICAgICAgIHN1cHByZXNzaHlkcmF0aW9ud2FybmluZzogInN1cHByZXNzSHlkcmF0aW9uV2FybmluZyIsCiAgICAgICAgICBzdXJmYWNlc2NhbGU6ICJzdXJmYWNlU2NhbGUiLAogICAgICAgICAgc3lzdGVtbGFuZ3VhZ2U6ICJzeXN0ZW1MYW5ndWFnZSIsCiAgICAgICAgICB0YWJsZXZhbHVlczogInRhYmxlVmFsdWVzIiwKICAgICAgICAgIHRhcmdldHg6ICJ0YXJnZXRYIiwKICAgICAgICAgIHRhcmdldHk6ICJ0YXJnZXRZIiwKICAgICAgICAgIHRleHRhbmNob3I6ICJ0ZXh0QW5jaG9yIiwKICAgICAgICAgICJ0ZXh0LWFuY2hvciI6ICJ0ZXh0QW5jaG9yIiwKICAgICAgICAgIHRleHRkZWNvcmF0aW9uOiAidGV4dERlY29yYXRpb24iLAogICAgICAgICAgInRleHQtZGVjb3JhdGlvbiI6ICJ0ZXh0RGVjb3JhdGlvbiIsCiAgICAgICAgICB0ZXh0bGVuZ3RoOiAidGV4dExlbmd0aCIsCiAgICAgICAgICB0ZXh0cmVuZGVyaW5nOiAidGV4dFJlbmRlcmluZyIsCiAgICAgICAgICAidGV4dC1yZW5kZXJpbmciOiAidGV4dFJlbmRlcmluZyIsCiAgICAgICAgICB0bzogInRvIiwKICAgICAgICAgIHRyYW5zZm9ybTogInRyYW5zZm9ybSIsCiAgICAgICAgICB0eXBlb2Y6ICJ0eXBlb2YiLAogICAgICAgICAgdTE6ICJ1MSIsCiAgICAgICAgICB1MjogInUyIiwKICAgICAgICAgIHVuZGVybGluZXBvc2l0aW9uOiAidW5kZXJsaW5lUG9zaXRpb24iLAogICAgICAgICAgInVuZGVybGluZS1wb3NpdGlvbiI6ICJ1bmRlcmxpbmVQb3NpdGlvbiIsCiAgICAgICAgICB1bmRlcmxpbmV0aGlja25lc3M6ICJ1bmRlcmxpbmVUaGlja25lc3MiLAogICAgICAgICAgInVuZGVybGluZS10aGlja25lc3MiOiAidW5kZXJsaW5lVGhpY2tuZXNzIiwKICAgICAgICAgIHVuaWNvZGU6ICJ1bmljb2RlIiwKICAgICAgICAgIHVuaWNvZGViaWRpOiAidW5pY29kZUJpZGkiLAogICAgICAgICAgInVuaWNvZGUtYmlkaSI6ICJ1bmljb2RlQmlkaSIsCiAgICAgICAgICB1bmljb2RlcmFuZ2U6ICJ1bmljb2RlUmFuZ2UiLAogICAgICAgICAgInVuaWNvZGUtcmFuZ2UiOiAidW5pY29kZVJhbmdlIiwKICAgICAgICAgIHVuaXRzcGVyZW06ICJ1bml0c1BlckVtIiwKICAgICAgICAgICJ1bml0cy1wZXItZW0iOiAidW5pdHNQZXJFbSIsCiAgICAgICAgICB1bnNlbGVjdGFibGU6ICJ1bnNlbGVjdGFibGUiLAogICAgICAgICAgdmFscGhhYmV0aWM6ICJ2QWxwaGFiZXRpYyIsCiAgICAgICAgICAidi1hbHBoYWJldGljIjogInZBbHBoYWJldGljIiwKICAgICAgICAgIHZhbHVlczogInZhbHVlcyIsCiAgICAgICAgICB2ZWN0b3JlZmZlY3Q6ICJ2ZWN0b3JFZmZlY3QiLAogICAgICAgICAgInZlY3Rvci1lZmZlY3QiOiAidmVjdG9yRWZmZWN0IiwKICAgICAgICAgIHZlcnNpb246ICJ2ZXJzaW9uIiwKICAgICAgICAgIHZlcnRhZHZ5OiAidmVydEFkdlkiLAogICAgICAgICAgInZlcnQtYWR2LXkiOiAidmVydEFkdlkiLAogICAgICAgICAgdmVydG9yaWdpbng6ICJ2ZXJ0T3JpZ2luWCIsCiAgICAgICAgICAidmVydC1vcmlnaW4teCI6ICJ2ZXJ0T3JpZ2luWCIsCiAgICAgICAgICB2ZXJ0b3JpZ2lueTogInZlcnRPcmlnaW5ZIiwKICAgICAgICAgICJ2ZXJ0LW9yaWdpbi15IjogInZlcnRPcmlnaW5ZIiwKICAgICAgICAgIHZoYW5naW5nOiAidkhhbmdpbmciLAogICAgICAgICAgInYtaGFuZ2luZyI6ICJ2SGFuZ2luZyIsCiAgICAgICAgICB2aWRlb2dyYXBoaWM6ICJ2SWRlb2dyYXBoaWMiLAogICAgICAgICAgInYtaWRlb2dyYXBoaWMiOiAidklkZW9ncmFwaGljIiwKICAgICAgICAgIHZpZXdib3g6ICJ2aWV3Qm94IiwKICAgICAgICAgIHZpZXd0YXJnZXQ6ICJ2aWV3VGFyZ2V0IiwKICAgICAgICAgIHZpc2liaWxpdHk6ICJ2aXNpYmlsaXR5IiwKICAgICAgICAgIHZtYXRoZW1hdGljYWw6ICJ2TWF0aGVtYXRpY2FsIiwKICAgICAgICAgICJ2LW1hdGhlbWF0aWNhbCI6ICJ2TWF0aGVtYXRpY2FsIiwKICAgICAgICAgIHZvY2FiOiAidm9jYWIiLAogICAgICAgICAgd2lkdGhzOiAid2lkdGhzIiwKICAgICAgICAgIHdvcmRzcGFjaW5nOiAid29yZFNwYWNpbmciLAogICAgICAgICAgIndvcmQtc3BhY2luZyI6ICJ3b3JkU3BhY2luZyIsCiAgICAgICAgICB3cml0aW5nbW9kZTogIndyaXRpbmdNb2RlIiwKICAgICAgICAgICJ3cml0aW5nLW1vZGUiOiAid3JpdGluZ01vZGUiLAogICAgICAgICAgeDE6ICJ4MSIsCiAgICAgICAgICB4MjogIngyIiwKICAgICAgICAgIHg6ICJ4IiwKICAgICAgICAgIHhjaGFubmVsc2VsZWN0b3I6ICJ4Q2hhbm5lbFNlbGVjdG9yIiwKICAgICAgICAgIHhoZWlnaHQ6ICJ4SGVpZ2h0IiwKICAgICAgICAgICJ4LWhlaWdodCI6ICJ4SGVpZ2h0IiwKICAgICAgICAgIHhsaW5rYWN0dWF0ZTogInhsaW5rQWN0dWF0ZSIsCiAgICAgICAgICAieGxpbms6YWN0dWF0ZSI6ICJ4bGlua0FjdHVhdGUiLAogICAgICAgICAgeGxpbmthcmNyb2xlOiAieGxpbmtBcmNyb2xlIiwKICAgICAgICAgICJ4bGluazphcmNyb2xlIjogInhsaW5rQXJjcm9sZSIsCiAgICAgICAgICB4bGlua2hyZWY6ICJ4bGlua0hyZWYiLAogICAgICAgICAgInhsaW5rOmhyZWYiOiAieGxpbmtIcmVmIiwKICAgICAgICAgIHhsaW5rcm9sZTogInhsaW5rUm9sZSIsCiAgICAgICAgICAieGxpbms6cm9sZSI6ICJ4bGlua1JvbGUiLAogICAgICAgICAgeGxpbmtzaG93OiAieGxpbmtTaG93IiwKICAgICAgICAgICJ4bGluazpzaG93IjogInhsaW5rU2hvdyIsCiAgICAgICAgICB4bGlua3RpdGxlOiAieGxpbmtUaXRsZSIsCiAgICAgICAgICAieGxpbms6dGl0bGUiOiAieGxpbmtUaXRsZSIsCiAgICAgICAgICB4bGlua3R5cGU6ICJ4bGlua1R5cGUiLAogICAgICAgICAgInhsaW5rOnR5cGUiOiAieGxpbmtUeXBlIiwKICAgICAgICAgIHhtbGJhc2U6ICJ4bWxCYXNlIiwKICAgICAgICAgICJ4bWw6YmFzZSI6ICJ4bWxCYXNlIiwKICAgICAgICAgIHhtbGxhbmc6ICJ4bWxMYW5nIiwKICAgICAgICAgICJ4bWw6bGFuZyI6ICJ4bWxMYW5nIiwKICAgICAgICAgIHhtbG5zOiAieG1sbnMiLAogICAgICAgICAgInhtbDpzcGFjZSI6ICJ4bWxTcGFjZSIsCiAgICAgICAgICB4bWxuc3hsaW5rOiAieG1sbnNYbGluayIsCiAgICAgICAgICAieG1sbnM6eGxpbmsiOiAieG1sbnNYbGluayIsCiAgICAgICAgICB4bWxzcGFjZTogInhtbFNwYWNlIiwKICAgICAgICAgIHkxOiAieTEiLAogICAgICAgICAgeTI6ICJ5MiIsCiAgICAgICAgICB5OiAieSIsCiAgICAgICAgICB5Y2hhbm5lbHNlbGVjdG9yOiAieUNoYW5uZWxTZWxlY3RvciIsCiAgICAgICAgICB6OiAieiIsCiAgICAgICAgICB6b29tYW5kcGFuOiAiem9vbUFuZFBhbiIKICAgICAgICB9OwogICAgICAgIHZhciBhcmlhUHJvcGVydGllcyA9IHsKICAgICAgICAgICJhcmlhLWN1cnJlbnQiOiAwLAogICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICJhcmlhLWRlc2NyaXB0aW9uIjogMCwKICAgICAgICAgICJhcmlhLWRldGFpbHMiOiAwLAogICAgICAgICAgImFyaWEtZGlzYWJsZWQiOiAwLAogICAgICAgICAgLy8gc3RhdGUKICAgICAgICAgICJhcmlhLWhpZGRlbiI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEtaW52YWxpZCI6IDAsCiAgICAgICAgICAvLyBzdGF0ZQogICAgICAgICAgImFyaWEta2V5c2hvcnRjdXRzIjogMCwKICAgICAgICAgICJhcmlhLWxhYmVsIjogMCwKICAgICAgICAgICJhcmlhLXJvbGVkZXNjcmlwdGlvbiI6IDAsCiAgICAgICAgICAvLyBXaWRnZXQgQXR0cmlidXRlcwogICAgICAgICAgImFyaWEtYXV0b2NvbXBsZXRlIjogMCwKICAgICAgICAgICJhcmlhLWNoZWNrZWQiOiAwLAogICAgICAgICAgImFyaWEtZXhwYW5kZWQiOiAwLAogICAgICAgICAgImFyaWEtaGFzcG9wdXAiOiAwLAogICAgICAgICAgImFyaWEtbGV2ZWwiOiAwLAogICAgICAgICAgImFyaWEtbW9kYWwiOiAwLAogICAgICAgICAgImFyaWEtbXVsdGlsaW5lIjogMCwKICAgICAgICAgICJhcmlhLW11bHRpc2VsZWN0YWJsZSI6IDAsCiAgICAgICAgICAiYXJpYS1vcmllbnRhdGlvbiI6IDAsCiAgICAgICAgICAiYXJpYS1wbGFjZWhvbGRlciI6IDAsCiAgICAgICAgICAiYXJpYS1wcmVzc2VkIjogMCwKICAgICAgICAgICJhcmlhLXJlYWRvbmx5IjogMCwKICAgICAgICAgICJhcmlhLXJlcXVpcmVkIjogMCwKICAgICAgICAgICJhcmlhLXNlbGVjdGVkIjogMCwKICAgICAgICAgICJhcmlhLXNvcnQiOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVtYXgiOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVtaW4iOiAwLAogICAgICAgICAgImFyaWEtdmFsdWVub3ciOiAwLAogICAgICAgICAgImFyaWEtdmFsdWV0ZXh0IjogMCwKICAgICAgICAgIC8vIExpdmUgUmVnaW9uIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWF0b21pYyI6IDAsCiAgICAgICAgICAiYXJpYS1idXN5IjogMCwKICAgICAgICAgICJhcmlhLWxpdmUiOiAwLAogICAgICAgICAgImFyaWEtcmVsZXZhbnQiOiAwLAogICAgICAgICAgLy8gRHJhZy1hbmQtRHJvcCBBdHRyaWJ1dGVzCiAgICAgICAgICAiYXJpYS1kcm9wZWZmZWN0IjogMCwKICAgICAgICAgICJhcmlhLWdyYWJiZWQiOiAwLAogICAgICAgICAgLy8gUmVsYXRpb25zaGlwIEF0dHJpYnV0ZXMKICAgICAgICAgICJhcmlhLWFjdGl2ZWRlc2NlbmRhbnQiOiAwLAogICAgICAgICAgImFyaWEtY29sY291bnQiOiAwLAogICAgICAgICAgImFyaWEtY29saW5kZXgiOiAwLAogICAgICAgICAgImFyaWEtY29sc3BhbiI6IDAsCiAgICAgICAgICAiYXJpYS1jb250cm9scyI6IDAsCiAgICAgICAgICAiYXJpYS1kZXNjcmliZWRieSI6IDAsCiAgICAgICAgICAiYXJpYS1lcnJvcm1lc3NhZ2UiOiAwLAogICAgICAgICAgImFyaWEtZmxvd3RvIjogMCwKICAgICAgICAgICJhcmlhLWxhYmVsbGVkYnkiOiAwLAogICAgICAgICAgImFyaWEtb3ducyI6IDAsCiAgICAgICAgICAiYXJpYS1wb3NpbnNldCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3djb3VudCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3dpbmRleCI6IDAsCiAgICAgICAgICAiYXJpYS1yb3dzcGFuIjogMCwKICAgICAgICAgICJhcmlhLXNldHNpemUiOiAwCiAgICAgICAgfTsKICAgICAgICB2YXIgd2FybmVkUHJvcGVydGllcyA9IHt9OwogICAgICAgIHZhciByQVJJQSA9IG5ldyBSZWdFeHAoIl4oYXJpYSktWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIHZhciByQVJJQUNhbWVsID0gbmV3IFJlZ0V4cCgiXihhcmlhKVtBLVpdWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydHkodGFnTmFtZSwgbmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbCh3YXJuZWRQcm9wZXJ0aWVzLCBuYW1lKSAmJiB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBQ2FtZWwudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIHZhciBhcmlhTmFtZSA9ICJhcmlhLSIgKyBuYW1lLnNsaWNlKDQpLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgICAgdmFyIGNvcnJlY3ROYW1lID0gYXJpYVByb3BlcnRpZXMuaGFzT3duUHJvcGVydHkoYXJpYU5hbWUpID8gYXJpYU5hbWUgOiBudWxsOwogICAgICAgICAgICAgIGlmIChjb3JyZWN0TmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiSW52YWxpZCBBUklBIGF0dHJpYnV0ZSBgJXNgLiBBUklBIGF0dHJpYnV0ZXMgZm9sbG93IHRoZSBwYXR0ZXJuIGFyaWEtKiBhbmQgbXVzdCBiZSBsb3dlcmNhc2UuIiwgbmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmFtZSAhPT0gY29ycmVjdE5hbWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIEFSSUEgYXR0cmlidXRlIGAlc2AuIERpZCB5b3UgbWVhbiBgJXNgPyIsIG5hbWUsIGNvcnJlY3ROYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyQVJJQS50ZXN0KG5hbWUpKSB7CiAgICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgIHZhciBzdGFuZGFyZE5hbWUgPSBhcmlhUHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkgPyBsb3dlckNhc2VkTmFtZSA6IG51bGw7CiAgICAgICAgICAgICAgaWYgKHN0YW5kYXJkTmFtZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5hbWUgIT09IHN0YW5kYXJkTmFtZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIlVua25vd24gQVJJQSBhdHRyaWJ1dGUgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgc3RhbmRhcmROYW1lKTsKICAgICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXNbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkludmFsaWRBUklBUHJvcHModHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGludmFsaWRQcm9wcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9IHZhbGlkYXRlUHJvcGVydHkodHlwZSwga2V5KTsKICAgICAgICAgICAgICBpZiAoIWlzVmFsaWQpIHsKICAgICAgICAgICAgICAgIGludmFsaWRQcm9wcy5wdXNoKGtleSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB1bmtub3duUHJvcFN0cmluZyA9IGludmFsaWRQcm9wcy5tYXAoZnVuY3Rpb24ocHJvcCkgewogICAgICAgICAgICAgIHJldHVybiAiYCIgKyBwcm9wICsgImAiOwogICAgICAgICAgICB9KS5qb2luKCIsICIpOwogICAgICAgICAgICBpZiAoaW52YWxpZFByb3BzLmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGFyaWEgcHJvcCAlcyBvbiA8JXM+IHRhZy4gRm9yIGRldGFpbHMsIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1hcmlhLXByb3BzIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGludmFsaWRQcm9wcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgYXJpYSBwcm9wcyAlcyBvbiA8JXM+IHRhZy4gRm9yIGRldGFpbHMsIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1hcmlhLXByb3BzIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlUHJvcGVydGllcyh0eXBlLCBwcm9wcykgewogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuSW52YWxpZEFSSUFQcm9wcyh0eXBlLCBwcm9wcyk7CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuVmFsdWVOdWxsID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wZXJ0aWVzJDEodHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGUgIT09ICJpbnB1dCIgJiYgdHlwZSAhPT0gInRleHRhcmVhIiAmJiB0eXBlICE9PSAic2VsZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocHJvcHMgIT0gbnVsbCAmJiBwcm9wcy52YWx1ZSA9PT0gbnVsbCAmJiAhZGlkV2FyblZhbHVlTnVsbCkgewogICAgICAgICAgICAgIGRpZFdhcm5WYWx1ZU51bGwgPSB0cnVlOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSAic2VsZWN0IiAmJiBwcm9wcy5tdWx0aXBsZSkgewogICAgICAgICAgICAgICAgZXJyb3IoImB2YWx1ZWAgcHJvcCBvbiBgJXNgIHNob3VsZCBub3QgYmUgbnVsbC4gQ29uc2lkZXIgdXNpbmcgYW4gZW1wdHkgYXJyYXkgd2hlbiBgbXVsdGlwbGVgIGlzIHNldCB0byBgdHJ1ZWAgdG8gY2xlYXIgdGhlIGNvbXBvbmVudCBvciBgdW5kZWZpbmVkYCBmb3IgdW5jb250cm9sbGVkIGNvbXBvbmVudHMuIiwgdHlwZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCJgdmFsdWVgIHByb3Agb24gYCVzYCBzaG91bGQgbm90IGJlIG51bGwuIENvbnNpZGVyIHVzaW5nIGFuIGVtcHR5IHN0cmluZyB0byBjbGVhciB0aGUgY29tcG9uZW50IG9yIGB1bmRlZmluZWRgIGZvciB1bmNvbnRyb2xsZWQgY29tcG9uZW50cy4iLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHZhbGlkYXRlUHJvcGVydHkkMSA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgewogICAgICAgICAgdmFyIHdhcm5lZFByb3BlcnRpZXMkMSA9IHt9OwogICAgICAgICAgdmFyIEVWRU5UX05BTUVfUkVHRVggPSAvXm9uLi87CiAgICAgICAgICB2YXIgSU5WQUxJRF9FVkVOVF9OQU1FX1JFR0VYID0gL15vblteQS1aXS87CiAgICAgICAgICB2YXIgckFSSUEkMSA9IG5ldyBSZWdFeHAoIl4oYXJpYSktWyIgKyBBVFRSSUJVVEVfTkFNRV9DSEFSICsgIl0qJCIpOwogICAgICAgICAgdmFyIHJBUklBQ2FtZWwkMSA9IG5ldyBSZWdFeHAoIl4oYXJpYSlbQS1aXVsiICsgQVRUUklCVVRFX05BTUVfQ0hBUiArICJdKiQiKTsKICAgICAgICAgIHZhbGlkYXRlUHJvcGVydHkkMSA9IGZ1bmN0aW9uKHRhZ05hbWUsIG5hbWUsIHZhbHVlLCBldmVudFJlZ2lzdHJ5KSB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHdhcm5lZFByb3BlcnRpZXMkMSwgbmFtZSkgJiYgd2FybmVkUHJvcGVydGllcyQxW25hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGxvd2VyQ2FzZWROYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBpZiAobG93ZXJDYXNlZE5hbWUgPT09ICJvbmZvY3VzaW4iIHx8IGxvd2VyQ2FzZWROYW1lID09PSAib25mb2N1c291dCIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgdXNlcyBvbkZvY3VzIGFuZCBvbkJsdXIgaW5zdGVhZCBvZiBvbkZvY3VzSW4gYW5kIG9uRm9jdXNPdXQuIEFsbCBSZWFjdCBldmVudHMgYXJlIG5vcm1hbGl6ZWQgdG8gYnViYmxlLCBzbyBvbkZvY3VzSW4gYW5kIG9uRm9jdXNPdXQgYXJlIG5vdCBuZWVkZWQvc3VwcG9ydGVkIGJ5IFJlYWN0LiIpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGV2ZW50UmVnaXN0cnkgIT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciByZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzMiA9IGV2ZW50UmVnaXN0cnkucmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcywgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lczIgPSBldmVudFJlZ2lzdHJ5LnBvc3NpYmxlUmVnaXN0cmF0aW9uTmFtZXM7CiAgICAgICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMyLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWUgPSBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMi5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkgPyBwb3NzaWJsZVJlZ2lzdHJhdGlvbk5hbWVzMltsb3dlckNhc2VkTmFtZV0gOiBudWxsOwogICAgICAgICAgICAgIGlmIChyZWdpc3RyYXRpb25OYW1lICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gRGlkIHlvdSBtZWFuIGAlc2A/IiwgbmFtZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChFVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJVbmtub3duIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gSXQgd2lsbCBiZSBpZ25vcmVkLiIsIG5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChFVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICBpZiAoSU5WQUxJRF9FVkVOVF9OQU1FX1JFR0VYLnRlc3QobmFtZSkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGV2ZW50IGhhbmRsZXIgcHJvcGVydHkgYCVzYC4gUmVhY3QgZXZlbnRzIHVzZSB0aGUgY2FtZWxDYXNlIG5hbWluZyBjb252ZW50aW9uLCBmb3IgZXhhbXBsZSBgb25DbGlja2AuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJBUklBJDEudGVzdChuYW1lKSB8fCByQVJJQUNhbWVsJDEudGVzdChuYW1lKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImlubmVyaHRtbCIpIHsKICAgICAgICAgICAgICBlcnJvcigiRGlyZWN0bHkgc2V0dGluZyBwcm9wZXJ0eSBgaW5uZXJIVE1MYCBpcyBub3QgcGVybWl0dGVkLiBGb3IgbW9yZSBpbmZvcm1hdGlvbiwgbG9va3VwIGRvY3VtZW50YXRpb24gb24gYGRhbmdlcm91c2x5U2V0SW5uZXJIVE1MYC4iKTsKICAgICAgICAgICAgICB3YXJuZWRQcm9wZXJ0aWVzJDFbbmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsb3dlckNhc2VkTmFtZSA9PT0gImFyaWEiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBgYXJpYWAgYXR0cmlidXRlIGlzIHJlc2VydmVkIGZvciBmdXR1cmUgdXNlIGluIFJlYWN0LiBQYXNzIGluZGl2aWR1YWwgYGFyaWEtYCBhdHRyaWJ1dGVzIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobG93ZXJDYXNlZE5hbWUgPT09ICJpcyIgJiYgdmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHZvaWQgMCAmJiB0eXBlb2YgdmFsdWUgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlJlY2VpdmVkIGEgYCVzYCBmb3IgYSBzdHJpbmcgYXR0cmlidXRlIGBpc2AuIElmIHRoaXMgaXMgZXhwZWN0ZWQsIGNhc3QgdGhlIHZhbHVlIHRvIGEgc3RyaW5nLiIsIHR5cGVvZiB2YWx1ZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIiAmJiBpc05hTih2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgTmFOIGZvciB0aGUgYCVzYCBhdHRyaWJ1dGUuIElmIHRoaXMgaXMgZXhwZWN0ZWQsIGNhc3QgdGhlIHZhbHVlIHRvIGEgc3RyaW5nLiIsIG5hbWUpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb3BlcnR5SW5mbyA9IGdldFByb3BlcnR5SW5mbyhuYW1lKTsKICAgICAgICAgICAgdmFyIGlzUmVzZXJ2ZWQgPSBwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IFJFU0VSVkVEOwogICAgICAgICAgICBpZiAocG9zc2libGVTdGFuZGFyZE5hbWVzLmhhc093blByb3BlcnR5KGxvd2VyQ2FzZWROYW1lKSkgewogICAgICAgICAgICAgIHZhciBzdGFuZGFyZE5hbWUgPSBwb3NzaWJsZVN0YW5kYXJkTmFtZXNbbG93ZXJDYXNlZE5hbWVdOwogICAgICAgICAgICAgIGlmIChzdGFuZGFyZE5hbWUgIT09IG5hbWUpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIERPTSBwcm9wZXJ0eSBgJXNgLiBEaWQgeW91IG1lYW4gYCVzYD8iLCBuYW1lLCBzdGFuZGFyZE5hbWUpOwogICAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICghaXNSZXNlcnZlZCAmJiBuYW1lICE9PSBsb3dlckNhc2VkTmFtZSkgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBkb2VzIG5vdCByZWNvZ25pemUgdGhlIGAlc2AgcHJvcCBvbiBhIERPTSBlbGVtZW50LiBJZiB5b3UgaW50ZW50aW9uYWxseSB3YW50IGl0IHRvIGFwcGVhciBpbiB0aGUgRE9NIGFzIGEgY3VzdG9tIGF0dHJpYnV0ZSwgc3BlbGwgaXQgYXMgbG93ZXJjYXNlIGAlc2AgaW5zdGVhZC4gSWYgeW91IGFjY2lkZW50YWxseSBwYXNzZWQgaXQgZnJvbSBhIHBhcmVudCBjb21wb25lbnQsIHJlbW92ZSBpdCBmcm9tIHRoZSBET00gZWxlbWVudC4iLCBuYW1lLCBsb3dlckNhc2VkTmFtZSk7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgJiYgc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBlcnJvcignUmVjZWl2ZWQgYCVzYCBmb3IgYSBub24tYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC5cblxuSWYgeW91IHdhbnQgdG8gd3JpdGUgaXQgdG8gdGhlIERPTSwgcGFzcyBhIHN0cmluZyBpbnN0ZWFkOiAlcz0iJXMiIG9yICVzPXt2YWx1ZS50b1N0cmluZygpfS4nLCB2YWx1ZSwgbmFtZSwgbmFtZSwgdmFsdWUsIG5hbWUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcignUmVjZWl2ZWQgYCVzYCBmb3IgYSBub24tYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC5cblxuSWYgeW91IHdhbnQgdG8gd3JpdGUgaXQgdG8gdGhlIERPTSwgcGFzcyBhIHN0cmluZyBpbnN0ZWFkOiAlcz0iJXMiIG9yICVzPXt2YWx1ZS50b1N0cmluZygpfS5cblxuSWYgeW91IHVzZWQgdG8gY29uZGl0aW9uYWxseSBvbWl0IGl0IHdpdGggJXM9e2NvbmRpdGlvbiAmJiB2YWx1ZX0sIHBhc3MgJXM9e2NvbmRpdGlvbiA/IHZhbHVlIDogdW5kZWZpbmVkfSBpbnN0ZWFkLicsIHZhbHVlLCBuYW1lLCBuYW1lLCB2YWx1ZSwgbmFtZSwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzUmVzZXJ2ZWQpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlQXR0cmlidXRlV2l0aFdhcm5pbmcobmFtZSwgdmFsdWUsIHByb3BlcnR5SW5mbywgZmFsc2UpKSB7CiAgICAgICAgICAgICAgd2FybmVkUHJvcGVydGllcyQxW25hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCh2YWx1ZSA9PT0gImZhbHNlIiB8fCB2YWx1ZSA9PT0gInRydWUiKSAmJiBwcm9wZXJ0eUluZm8gIT09IG51bGwgJiYgcHJvcGVydHlJbmZvLnR5cGUgPT09IEJPT0xFQU4pIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgdGhlIHN0cmluZyBgJXNgIGZvciB0aGUgYm9vbGVhbiBhdHRyaWJ1dGUgYCVzYC4gJXMgRGlkIHlvdSBtZWFuICVzPXslc30/IiwgdmFsdWUsIG5hbWUsIHZhbHVlID09PSAiZmFsc2UiID8gIlRoZSBicm93c2VyIHdpbGwgaW50ZXJwcmV0IGl0IGFzIGEgdHJ1dGh5IHZhbHVlLiIgOiAnQWx0aG91Z2ggdGhpcyB3b3JrcywgaXQgd2lsbCBub3Qgd29yayBhcyBleHBlY3RlZCBpZiB5b3UgcGFzcyB0aGUgc3RyaW5nICJmYWxzZSIuJywgbmFtZSwgdmFsdWUpOwogICAgICAgICAgICAgIHdhcm5lZFByb3BlcnRpZXMkMVtuYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgd2FyblVua25vd25Qcm9wZXJ0aWVzID0gZnVuY3Rpb24odHlwZSwgcHJvcHMsIGV2ZW50UmVnaXN0cnkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wcyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9IHZhbGlkYXRlUHJvcGVydHkkMSh0eXBlLCBrZXksIHByb3BzW2tleV0sIGV2ZW50UmVnaXN0cnkpOwogICAgICAgICAgICAgIGlmICghaXNWYWxpZCkgewogICAgICAgICAgICAgICAgdW5rbm93blByb3BzLnB1c2goa2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHVua25vd25Qcm9wU3RyaW5nID0gdW5rbm93blByb3BzLm1hcChmdW5jdGlvbihwcm9wKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJgIiArIHByb3AgKyAiYCI7CiAgICAgICAgICAgIH0pLmpvaW4oIiwgIik7CiAgICAgICAgICAgIGlmICh1bmtub3duUHJvcHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgdmFsdWUgZm9yIHByb3AgJXMgb24gPCVzPiB0YWcuIEVpdGhlciByZW1vdmUgaXQgZnJvbSB0aGUgZWxlbWVudCwgb3IgcGFzcyBhIHN0cmluZyBvciBudW1iZXIgdmFsdWUgdG8ga2VlcCBpdCBpbiB0aGUgRE9NLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9hdHRyaWJ1dGUtYmVoYXZpb3IgIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHVua25vd25Qcm9wcy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgdmFsdWVzIGZvciBwcm9wcyAlcyBvbiA8JXM+IHRhZy4gRWl0aGVyIHJlbW92ZSB0aGVtIGZyb20gdGhlIGVsZW1lbnQsIG9yIHBhc3MgYSBzdHJpbmcgb3IgbnVtYmVyIHZhbHVlIHRvIGtlZXAgdGhlbSBpbiB0aGUgRE9NLiBGb3IgZGV0YWlscywgc2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9hdHRyaWJ1dGUtYmVoYXZpb3IgIiwgdW5rbm93blByb3BTdHJpbmcsIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVByb3BlcnRpZXMkMih0eXBlLCBwcm9wcywgZXZlbnRSZWdpc3RyeSkgewogICAgICAgICAgaWYgKGlzQ3VzdG9tQ29tcG9uZW50KHR5cGUsIHByb3BzKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuVW5rbm93blByb3BlcnRpZXModHlwZSwgcHJvcHMsIGV2ZW50UmVnaXN0cnkpOwogICAgICAgIH0KICAgICAgICB2YXIgSVNfRVZFTlRfSEFORExFX05PTl9NQU5BR0VEX05PREUgPSAxOwogICAgICAgIHZhciBJU19OT05fREVMRUdBVEVEID0gMSA8PCAxOwogICAgICAgIHZhciBJU19DQVBUVVJFX1BIQVNFID0gMSA8PCAyOwogICAgICAgIHZhciBTSE9VTERfTk9UX1BST0NFU1NfUE9MWUZJTExfRVZFTlRfUExVR0lOUyA9IElTX0VWRU5UX0hBTkRMRV9OT05fTUFOQUdFRF9OT0RFIHwgSVNfTk9OX0RFTEVHQVRFRCB8IElTX0NBUFRVUkVfUEhBU0U7CiAgICAgICAgdmFyIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gc2V0UmVwbGF5aW5nRXZlbnQoZXZlbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRSZXBsYXlpbmdFdmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBjdXJyZW50bHkgcmVwbGF5aW5nIGV2ZW50IHRvIGJlIG51bGwuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IGV2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFJlcGxheWluZ0V2ZW50KCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudFJlcGxheWluZ0V2ZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIGN1cnJlbnRseSByZXBsYXlpbmcgZXZlbnQgdG8gbm90IGJlIG51bGwuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRSZXBsYXlpbmdFdmVudCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVwbGF5aW5nRXZlbnQoZXZlbnQpIHsKICAgICAgICAgIHJldHVybiBldmVudCA9PT0gY3VycmVudFJlcGxheWluZ0V2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIHRhcmdldCA9IG5hdGl2ZUV2ZW50LnRhcmdldCB8fCBuYXRpdmVFdmVudC5zcmNFbGVtZW50IHx8IHdpbmRvdzsKICAgICAgICAgIGlmICh0YXJnZXQuY29ycmVzcG9uZGluZ1VzZUVsZW1lbnQpIHsKICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LmNvcnJlc3BvbmRpbmdVc2VFbGVtZW50OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRhcmdldC5ub2RlVHlwZSA9PT0gVEVYVF9OT0RFID8gdGFyZ2V0LnBhcmVudE5vZGUgOiB0YXJnZXQ7CiAgICAgICAgfQogICAgICAgIHZhciByZXN0b3JlSW1wbCA9IG51bGw7CiAgICAgICAgdmFyIHJlc3RvcmVUYXJnZXQgPSBudWxsOwogICAgICAgIHZhciByZXN0b3JlUXVldWUgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KHRhcmdldCkgewogICAgICAgICAgdmFyIGludGVybmFsSW5zdGFuY2UgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKHRhcmdldCk7CiAgICAgICAgICBpZiAoIWludGVybmFsSW5zdGFuY2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiByZXN0b3JlSW1wbCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNldFJlc3RvcmVJbXBsZW1lbnRhdGlvbigpIG5lZWRzIHRvIGJlIGNhbGxlZCB0byBoYW5kbGUgYSB0YXJnZXQgZm9yIGNvbnRyb2xsZWQgZXZlbnRzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IGludGVybmFsSW5zdGFuY2Uuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKHN0YXRlTm9kZSkgewogICAgICAgICAgICB2YXIgX3Byb3BzID0gZ2V0RmliZXJDdXJyZW50UHJvcHNGcm9tTm9kZShzdGF0ZU5vZGUpOwogICAgICAgICAgICByZXN0b3JlSW1wbChpbnRlcm5hbEluc3RhbmNlLnN0YXRlTm9kZSwgaW50ZXJuYWxJbnN0YW5jZS50eXBlLCBfcHJvcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRSZXN0b3JlSW1wbGVtZW50YXRpb24oaW1wbCkgewogICAgICAgICAgcmVzdG9yZUltcGwgPSBpbXBsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlU3RhdGVSZXN0b3JlKHRhcmdldCkgewogICAgICAgICAgaWYgKHJlc3RvcmVUYXJnZXQpIHsKICAgICAgICAgICAgaWYgKHJlc3RvcmVRdWV1ZSkgewogICAgICAgICAgICAgIHJlc3RvcmVRdWV1ZS5wdXNoKHRhcmdldCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVzdG9yZVF1ZXVlID0gW3RhcmdldF07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc3RvcmVUYXJnZXQgPSB0YXJnZXQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG5lZWRzU3RhdGVSZXN0b3JlKCkgewogICAgICAgICAgcmV0dXJuIHJlc3RvcmVUYXJnZXQgIT09IG51bGwgfHwgcmVzdG9yZVF1ZXVlICE9PSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlU3RhdGVJZk5lZWRlZCgpIHsKICAgICAgICAgIGlmICghcmVzdG9yZVRhcmdldCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gcmVzdG9yZVRhcmdldDsKICAgICAgICAgIHZhciBxdWV1ZWRUYXJnZXRzID0gcmVzdG9yZVF1ZXVlOwogICAgICAgICAgcmVzdG9yZVRhcmdldCA9IG51bGw7CiAgICAgICAgICByZXN0b3JlUXVldWUgPSBudWxsOwogICAgICAgICAgcmVzdG9yZVN0YXRlT2ZUYXJnZXQodGFyZ2V0KTsKICAgICAgICAgIGlmIChxdWV1ZWRUYXJnZXRzKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVldWVkVGFyZ2V0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHJlc3RvcmVTdGF0ZU9mVGFyZ2V0KHF1ZXVlZFRhcmdldHNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBiYXRjaGVkVXBkYXRlc0ltcGwgPSBmdW5jdGlvbihmbiwgYm9va2tlZXBpbmcpIHsKICAgICAgICAgIHJldHVybiBmbihib29ra2VlcGluZyk7CiAgICAgICAgfTsKICAgICAgICB2YXIgZmx1c2hTeW5jSW1wbCA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgdmFyIGlzSW5zaWRlRXZlbnRIYW5kbGVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmluaXNoRXZlbnRIYW5kbGVyKCkgewogICAgICAgICAgdmFyIGNvbnRyb2xsZWRDb21wb25lbnRzSGF2ZVBlbmRpbmdVcGRhdGVzID0gbmVlZHNTdGF0ZVJlc3RvcmUoKTsKICAgICAgICAgIGlmIChjb250cm9sbGVkQ29tcG9uZW50c0hhdmVQZW5kaW5nVXBkYXRlcykgewogICAgICAgICAgICBmbHVzaFN5bmNJbXBsKCk7CiAgICAgICAgICAgIHJlc3RvcmVTdGF0ZUlmTmVlZGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhdGNoZWRVcGRhdGVzKGZuLCBhLCBiKSB7CiAgICAgICAgICBpZiAoaXNJbnNpZGVFdmVudEhhbmRsZXIpIHsKICAgICAgICAgICAgcmV0dXJuIGZuKGEsIGIpOwogICAgICAgICAgfQogICAgICAgICAgaXNJbnNpZGVFdmVudEhhbmRsZXIgPSB0cnVlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGJhdGNoZWRVcGRhdGVzSW1wbChmbiwgYSwgYik7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBpc0luc2lkZUV2ZW50SGFuZGxlciA9IGZhbHNlOwogICAgICAgICAgICBmaW5pc2hFdmVudEhhbmRsZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0QmF0Y2hpbmdJbXBsZW1lbnRhdGlvbihfYmF0Y2hlZFVwZGF0ZXNJbXBsLCBfZGlzY3JldGVVcGRhdGVzSW1wbCwgX2ZsdXNoU3luY0ltcGwpIHsKICAgICAgICAgIGJhdGNoZWRVcGRhdGVzSW1wbCA9IF9iYXRjaGVkVXBkYXRlc0ltcGw7CiAgICAgICAgICBmbHVzaFN5bmNJbXBsID0gX2ZsdXNoU3luY0ltcGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzSW50ZXJhY3RpdmUodGFnKSB7CiAgICAgICAgICByZXR1cm4gdGFnID09PSAiYnV0dG9uIiB8fCB0YWcgPT09ICJpbnB1dCIgfHwgdGFnID09PSAic2VsZWN0IiB8fCB0YWcgPT09ICJ0ZXh0YXJlYSI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFByZXZlbnRNb3VzZUV2ZW50KG5hbWUsIHR5cGUsIHByb3BzKSB7CiAgICAgICAgICBzd2l0Y2ggKG5hbWUpIHsKICAgICAgICAgICAgY2FzZSAib25DbGljayI6CiAgICAgICAgICAgIGNhc2UgIm9uQ2xpY2tDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Eb3VibGVDbGljayI6CiAgICAgICAgICAgIGNhc2UgIm9uRG91YmxlQ2xpY2tDYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAib25Nb3VzZURvd24iOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRG93bkNhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlTW92ZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VNb3ZlQ2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VVcCI6CiAgICAgICAgICAgIGNhc2UgIm9uTW91c2VVcENhcHR1cmUiOgogICAgICAgICAgICBjYXNlICJvbk1vdXNlRW50ZXIiOgogICAgICAgICAgICAgIHJldHVybiAhIShwcm9wcy5kaXNhYmxlZCAmJiBpc0ludGVyYWN0aXZlKHR5cGUpKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExpc3RlbmVyKGluc3QsIHJlZ2lzdHJhdGlvbk5hbWUpIHsKICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSBpbnN0LnN0YXRlTm9kZTsKICAgICAgICAgIGlmIChzdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJvcHMgPSBnZXRGaWJlckN1cnJlbnRQcm9wc0Zyb21Ob2RlKHN0YXRlTm9kZSk7CiAgICAgICAgICBpZiAocHJvcHMgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGlzdGVuZXIyID0gcHJvcHNbcmVnaXN0cmF0aW9uTmFtZV07CiAgICAgICAgICBpZiAoc2hvdWxkUHJldmVudE1vdXNlRXZlbnQocmVnaXN0cmF0aW9uTmFtZSwgaW5zdC50eXBlLCBwcm9wcykpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobGlzdGVuZXIyICYmIHR5cGVvZiBsaXN0ZW5lcjIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBgIiArIHJlZ2lzdHJhdGlvbk5hbWUgKyAiYCBsaXN0ZW5lciB0byBiZSBhIGZ1bmN0aW9uLCBpbnN0ZWFkIGdvdCBhIHZhbHVlIG9mIGAiICsgdHlwZW9mIGxpc3RlbmVyMiArICJgIHR5cGUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICB2YXIgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICBpZiAoY2FuVXNlRE9NMikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB7fTsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9wdGlvbnMsICJwYXNzaXZlIiwgewogICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBwYXNzaXZlQnJvd3NlckV2ZW50c1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgcGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZChuYW1lLCBmdW5jLCBjb250ZXh0LCBhLCBiLCBjLCBkLCBlLCBmKSB7CiAgICAgICAgICB2YXIgZnVuY0FyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDMpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZnVuYy5hcHBseShjb250ZXh0LCBmdW5jQXJncyk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgdGhpcy5vbkVycm9yKGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpbnZva2VHdWFyZGVkQ2FsbGJhY2tJbXBsID0gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZDsKICAgICAgICB7CiAgICAgICAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kaXNwYXRjaEV2ZW50ID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIGRvY3VtZW50LmNyZWF0ZUV2ZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBmYWtlTm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInJlYWN0Iik7CiAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwgPSBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2tEZXYobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8IGRvY3VtZW50ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoZSBgZG9jdW1lbnRgIGdsb2JhbCB3YXMgZGVmaW5lZCB3aGVuIFJlYWN0IHdhcyBpbml0aWFsaXplZCwgYnV0IGlzIG5vdCBkZWZpbmVkIGFueW1vcmUuIFRoaXMgY2FuIGhhcHBlbiBpbiBhIHRlc3QgZW52aXJvbm1lbnQgaWYgYSBjb21wb25lbnQgc2NoZWR1bGVzIGFuIHVwZGF0ZSBmcm9tIGFuIGFzeW5jaHJvbm91cyBjYWxsYmFjaywgYnV0IHRoZSB0ZXN0IGhhcyBhbHJlYWR5IGZpbmlzaGVkIHJ1bm5pbmcuIFRvIHNvbHZlIHRoaXMsIHlvdSBjYW4gZWl0aGVyIHVubW91bnQgdGhlIGNvbXBvbmVudCBhdCB0aGUgZW5kIG9mIHlvdXIgdGVzdCAoYW5kIGVuc3VyZSB0aGF0IGFueSBhc3luY2hyb25vdXMgb3BlcmF0aW9ucyBnZXQgY2FuY2VsZWQgaW4gYGNvbXBvbmVudFdpbGxVbm1vdW50YCksIG9yIHlvdSBjYW4gY2hhbmdlIHRoZSB0ZXN0IGl0c2VsZiB0byBiZSBhc3luY2hyb25vdXMuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBldnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiRXZlbnQiKTsKICAgICAgICAgICAgICB2YXIgZGlkQ2FsbCA9IGZhbHNlOwogICAgICAgICAgICAgIHZhciBkaWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIHdpbmRvd0V2ZW50ID0gd2luZG93LmV2ZW50OwogICAgICAgICAgICAgIHZhciB3aW5kb3dFdmVudERlc2NyaXB0b3IgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHdpbmRvdywgImV2ZW50Iik7CiAgICAgICAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUFmdGVyRGlzcGF0Y2goKSB7CiAgICAgICAgICAgICAgICBmYWtlTm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKGV2dFR5cGUsIGNhbGxDYWxsYmFjazIsIGZhbHNlKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygd2luZG93LmV2ZW50ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuaGFzT3duUHJvcGVydHkoImV2ZW50IikpIHsKICAgICAgICAgICAgICAgICAgd2luZG93LmV2ZW50ID0gd2luZG93RXZlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBmdW5jQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMyk7CiAgICAgICAgICAgICAgZnVuY3Rpb24gY2FsbENhbGxiYWNrMigpIHsKICAgICAgICAgICAgICAgIGRpZENhbGwgPSB0cnVlOwogICAgICAgICAgICAgICAgcmVzdG9yZUFmdGVyRGlzcGF0Y2goKTsKICAgICAgICAgICAgICAgIGZ1bmMuYXBwbHkoY29udGV4dCwgZnVuY0FyZ3MpOwogICAgICAgICAgICAgICAgZGlkRXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGVycm9yMjsKICAgICAgICAgICAgICB2YXIgZGlkU2V0RXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgaXNDcm9zc09yaWdpbkVycm9yID0gZmFsc2U7CiAgICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlV2luZG93RXJyb3IoZXZlbnQpIHsKICAgICAgICAgICAgICAgIGVycm9yMiA9IGV2ZW50LmVycm9yOwogICAgICAgICAgICAgICAgZGlkU2V0RXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKGVycm9yMiA9PT0gbnVsbCAmJiBldmVudC5jb2xubyA9PT0gMCAmJiBldmVudC5saW5lbm8gPT09IDApIHsKICAgICAgICAgICAgICAgICAgaXNDcm9zc09yaWdpbkVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChldmVudC5kZWZhdWx0UHJldmVudGVkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChlcnJvcjIgIT0gbnVsbCAmJiB0eXBlb2YgZXJyb3IyID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBlcnJvcjIuX3N1cHByZXNzTG9nZ2luZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoaW5uZXIpIHsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGV2dFR5cGUgPSAicmVhY3QtIiArIChuYW1lID8gbmFtZSA6ICJpbnZva2VndWFyZGVkY2FsbGJhY2siKTsKICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigiZXJyb3IiLCBoYW5kbGVXaW5kb3dFcnJvcik7CiAgICAgICAgICAgICAgZmFrZU5vZGUuYWRkRXZlbnRMaXN0ZW5lcihldnRUeXBlLCBjYWxsQ2FsbGJhY2syLCBmYWxzZSk7CiAgICAgICAgICAgICAgZXZ0LmluaXRFdmVudChldnRUeXBlLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICAgIGZha2VOb2RlLmRpc3BhdGNoRXZlbnQoZXZ0KTsKICAgICAgICAgICAgICBpZiAod2luZG93RXZlbnREZXNjcmlwdG9yKSB7CiAgICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luZG93LCAiZXZlbnQiLCB3aW5kb3dFdmVudERlc2NyaXB0b3IpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZGlkQ2FsbCAmJiBkaWRFcnJvcikgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTZXRFcnJvcikgewogICAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IoYEFuIGVycm9yIHdhcyB0aHJvd24gaW5zaWRlIG9uZSBvZiB5b3VyIGNvbXBvbmVudHMsIGJ1dCBSZWFjdCBkb2Vzbid0IGtub3cgd2hhdCBpdCB3YXMuIFRoaXMgaXMgbGlrZWx5IGR1ZSB0byBicm93c2VyIGZsYWtpbmVzcy4gUmVhY3QgZG9lcyBpdHMgYmVzdCB0byBwcmVzZXJ2ZSB0aGUgIlBhdXNlIG9uIGV4Y2VwdGlvbnMiIGJlaGF2aW9yIG9mIHRoZSBEZXZUb29scywgd2hpY2ggcmVxdWlyZXMgc29tZSBERVYtbW9kZSBvbmx5IHRyaWNrcy4gSXQncyBwb3NzaWJsZSB0aGF0IHRoZXNlIGRvbid0IHdvcmsgaW4geW91ciBicm93c2VyLiBUcnkgdHJpZ2dlcmluZyB0aGUgZXJyb3IgaW4gcHJvZHVjdGlvbiBtb2RlLCBvciBzd2l0Y2hpbmcgdG8gYSBtb2Rlcm4gYnJvd3Nlci4gSWYgeW91IHN1c3BlY3QgdGhhdCB0aGlzIGlzIGFjdHVhbGx5IGFuIGlzc3VlIHdpdGggUmVhY3QsIHBsZWFzZSBmaWxlIGFuIGlzc3VlLmApOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChpc0Nyb3NzT3JpZ2luRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IyID0gbmV3IEVycm9yKCJBIGNyb3NzLW9yaWdpbiBlcnJvciB3YXMgdGhyb3duLiBSZWFjdCBkb2Vzbid0IGhhdmUgYWNjZXNzIHRvIHRoZSBhY3R1YWwgZXJyb3Igb2JqZWN0IGluIGRldmVsb3BtZW50LiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Nyb3Nzb3JpZ2luLWVycm9yIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5vbkVycm9yKGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJlcnJvciIsIGhhbmRsZVdpbmRvd0Vycm9yKTsKICAgICAgICAgICAgICBpZiAoIWRpZENhbGwpIHsKICAgICAgICAgICAgICAgIHJlc3RvcmVBZnRlckRpc3BhdGNoKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gaW52b2tlR3VhcmRlZENhbGxiYWNrUHJvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwkMSA9IGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGw7CiAgICAgICAgdmFyIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgdmFyIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICB2YXIgaGFzUmV0aHJvd0Vycm9yID0gZmFsc2U7CiAgICAgICAgdmFyIHJldGhyb3dFcnJvciA9IG51bGw7CiAgICAgICAgdmFyIHJlcG9ydGVyID0gewogICAgICAgICAgb25FcnJvcjogZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICAgIGhhc0Vycm9yID0gdHJ1ZTsKICAgICAgICAgICAgY2F1Z2h0RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBpbnZva2VHdWFyZGVkQ2FsbGJhY2sobmFtZSwgZnVuYywgY29udGV4dCwgYSwgYiwgYywgZCwgZSwgZikgewogICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICAgIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0ltcGwkMS5hcHBseShyZXBvcnRlciwgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlR3VhcmRlZENhbGxiYWNrQW5kQ2F0Y2hGaXJzdEVycm9yKG5hbWUsIGZ1bmMsIGNvbnRleHQsIGEsIGIsIGMsIGQsIGUsIGYpIHsKICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgaWYgKGhhc0Vycm9yKSB7CiAgICAgICAgICAgIHZhciBlcnJvcjIgPSBjbGVhckNhdWdodEVycm9yKCk7CiAgICAgICAgICAgIGlmICghaGFzUmV0aHJvd0Vycm9yKSB7CiAgICAgICAgICAgICAgaGFzUmV0aHJvd0Vycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICByZXRocm93RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0aHJvd0NhdWdodEVycm9yKCkgewogICAgICAgICAgaWYgKGhhc1JldGhyb3dFcnJvcikgewogICAgICAgICAgICB2YXIgZXJyb3IyID0gcmV0aHJvd0Vycm9yOwogICAgICAgICAgICBoYXNSZXRocm93RXJyb3IgPSBmYWxzZTsKICAgICAgICAgICAgcmV0aHJvd0Vycm9yID0gbnVsbDsKICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNDYXVnaHRFcnJvcigpIHsKICAgICAgICAgIHJldHVybiBoYXNFcnJvcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xlYXJDYXVnaHRFcnJvcigpIHsKICAgICAgICAgIGlmIChoYXNFcnJvcikgewogICAgICAgICAgICB2YXIgZXJyb3IyID0gY2F1Z2h0RXJyb3I7CiAgICAgICAgICAgIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgICAgIGNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIGVycm9yMjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2xlYXJDYXVnaHRFcnJvciB3YXMgY2FsbGVkIGJ1dCBubyBlcnJvciB3YXMgY2FwdHVyZWQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldDYoa2V5KSB7CiAgICAgICAgICByZXR1cm4ga2V5Ll9yZWFjdEludGVybmFsczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzMyhrZXkpIHsKICAgICAgICAgIHJldHVybiBrZXkuX3JlYWN0SW50ZXJuYWxzICE9PSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldDMoa2V5LCB2YWx1ZSkgewogICAgICAgICAga2V5Ll9yZWFjdEludGVybmFscyA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICB2YXIgTm9GbGFncyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgUGVyZm9ybWVkV29yayA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgUGxhY2VtZW50ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgVXBkYXRlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgQ2hpbGREZWxldGlvbiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNgogICAgICAgICk7CiAgICAgICAgdmFyIENvbnRlbnRSZXNldCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzIKICAgICAgICApOwogICAgICAgIHZhciBDYWxsYmFjayA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY0CiAgICAgICAgKTsKICAgICAgICB2YXIgRGlkQ2FwdHVyZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMjgKICAgICAgICApOwogICAgICAgIHZhciBGb3JjZUNsaWVudFJlbmRlciA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgKi8KICAgICAgICAgIDI1NgogICAgICAgICk7CiAgICAgICAgdmFyIFJlZjIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDUxMgogICAgICAgICk7CiAgICAgICAgdmFyIFNuYXBzaG90ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTAyNAogICAgICAgICk7CiAgICAgICAgdmFyIFBhc3NpdmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA0OAogICAgICAgICk7CiAgICAgICAgdmFyIEh5ZHJhdGluZyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNDA5NgogICAgICAgICk7CiAgICAgICAgdmFyIFZpc2liaWxpdHkgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgODE5MgogICAgICAgICk7CiAgICAgICAgdmFyIFN0b3JlQ29uc2lzdGVuY3kgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgMTYzODQKICAgICAgICApOwogICAgICAgIHZhciBMaWZlY3ljbGVFZmZlY3RNYXNrID0gUGFzc2l2ZSB8IFVwZGF0ZSB8IENhbGxiYWNrIHwgUmVmMiB8IFNuYXBzaG90IHwgU3RvcmVDb25zaXN0ZW5jeTsKICAgICAgICB2YXIgSG9zdEVmZmVjdE1hc2sgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2NwogICAgICAgICk7CiAgICAgICAgdmFyIEluY29tcGxldGUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMzI3NjgKICAgICAgICApOwogICAgICAgIHZhciBTaG91bGRDYXB0dXJlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY1NTM2CiAgICAgICAgKTsKICAgICAgICB2YXIgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSA9ICgKICAgICAgICAgIC8qICovCiAgICAgICAgICAxMzEwNzIKICAgICAgICApOwogICAgICAgIHZhciBGb3JrZWQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEwNDg1NzYKICAgICAgICApOwogICAgICAgIHZhciBSZWZTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwOTcxNTIKICAgICAgICApOwogICAgICAgIHZhciBMYXlvdXRTdGF0aWMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQzMDQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlU3RhdGljID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgzODg2MDgKICAgICAgICApOwogICAgICAgIHZhciBNb3VudExheW91dERldiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDE2Nzc3MjE2CiAgICAgICAgKTsKICAgICAgICB2YXIgTW91bnRQYXNzaXZlRGV2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICovCiAgICAgICAgICAzMzU1NDQzMgogICAgICAgICk7CiAgICAgICAgdmFyIEJlZm9yZU11dGF0aW9uTWFzayA9ICgKICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSBVcGRhdGUgZmxhZyBmcm9tIGJlZm9yZSBtdXRhdGlvbiBwaGFzZSBieSByZS1sYW5kaW5nIFZpc2liaWxpdHkKICAgICAgICAgIC8vIGZsYWcgbG9naWMgKHNlZSAjMjAwNDMpCiAgICAgICAgICBVcGRhdGUgfCBTbmFwc2hvdCB8IDAKICAgICAgICApOwogICAgICAgIHZhciBNdXRhdGlvbk1hc2sgPSBQbGFjZW1lbnQgfCBVcGRhdGUgfCBDaGlsZERlbGV0aW9uIHwgQ29udGVudFJlc2V0IHwgUmVmMiB8IEh5ZHJhdGluZyB8IFZpc2liaWxpdHk7CiAgICAgICAgdmFyIExheW91dE1hc2sgPSBVcGRhdGUgfCBDYWxsYmFjayB8IFJlZjIgfCBWaXNpYmlsaXR5OwogICAgICAgIHZhciBQYXNzaXZlTWFzayA9IFBhc3NpdmUgfCBDaGlsZERlbGV0aW9uOwogICAgICAgIHZhciBTdGF0aWNNYXNrID0gTGF5b3V0U3RhdGljIHwgUGFzc2l2ZVN0YXRpYyB8IFJlZlN0YXRpYzsKICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICBmdW5jdGlvbiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgdmFyIG5lYXJlc3RNb3VudGVkID0gZmliZXI7CiAgICAgICAgICBpZiAoIWZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICB2YXIgbmV4dE5vZGUgPSBub2RlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgbm9kZSA9IG5leHROb2RlOwogICAgICAgICAgICAgIGlmICgobm9kZS5mbGFncyAmIChQbGFjZW1lbnQgfCBIeWRyYXRpbmcpKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgbmVhcmVzdE1vdW50ZWQgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbmV4dE5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgfSB3aGlsZSAobmV4dE5vZGUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd2hpbGUgKG5vZGUucmV0dXJuKSB7CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHJldHVybiBuZWFyZXN0TW91bnRlZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5zZUluc3RhbmNlRnJvbUZpYmVyKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc3VzcGVuc2VTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbnRhaW5lckZyb21GaWJlcihmaWJlcikgewogICAgICAgICAgcmV0dXJuIGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QgPyBmaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRmliZXJNb3VudGVkKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcihmaWJlcikgPT09IGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc01vdW50ZWQoY29tcG9uZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBvd25lciA9IFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyRmliZXIgPSBvd25lcjsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBvd25lckZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoIWluc3RhbmNlLl93YXJuZWRBYm91dFJlZnNJblJlbmRlcikgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzIGlzIGFjY2Vzc2luZyBpc01vdW50ZWQgaW5zaWRlIGl0cyByZW5kZXIoKSBmdW5jdGlvbi4gcmVuZGVyKCkgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIEl0IHNob3VsZCBuZXZlciBhY2Nlc3Mgc29tZXRoaW5nIHRoYXQgcmVxdWlyZXMgc3RhbGUgZGF0YSBmcm9tIHRoZSBwcmV2aW91cyByZW5kZXIsIHN1Y2ggYXMgcmVmcy4gTW92ZSB0aGlzIGxvZ2ljIHRvIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnREaWRVcGRhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKG93bmVyRmliZXIpIHx8ICJBIGNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpbnN0YW5jZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ2KGNvbXBvbmVudCk7CiAgICAgICAgICBpZiAoIWZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKSA9PT0gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFzc2VydElzTW91bnRlZChmaWJlcikgewogICAgICAgICAgaWYgKGdldE5lYXJlc3RNb3VudGVkRmliZXIoZmliZXIpICE9PSBmaWJlcikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuYWJsZSB0byBmaW5kIG5vZGUgb24gYW4gdW5tb3VudGVkIGNvbXBvbmVudC4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoIWFsdGVybmF0ZSkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkICE9PSBmaWJlcikgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhID0gZmliZXI7CiAgICAgICAgICB2YXIgYiA9IGFsdGVybmF0ZTsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHZhciBwYXJlbnRBID0gYS5yZXR1cm47CiAgICAgICAgICAgIGlmIChwYXJlbnRBID09PSBudWxsKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHBhcmVudEIgPSBwYXJlbnRBLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKHBhcmVudEIgPT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmV4dFBhcmVudCA9IHBhcmVudEEucmV0dXJuOwogICAgICAgICAgICAgIGlmIChuZXh0UGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhID0gYiA9IG5leHRQYXJlbnQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhcmVudEEuY2hpbGQgPT09IHBhcmVudEIuY2hpbGQpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGQgPSBwYXJlbnRBLmNoaWxkOwogICAgICAgICAgICAgIHdoaWxlIChjaGlsZCkgewogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGFzc2VydElzTW91bnRlZChwYXJlbnRBKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGEucmV0dXJuICE9PSBiLnJldHVybikgewogICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBkaWRGaW5kQ2hpbGQgPSBmYWxzZTsKICAgICAgICAgICAgICB2YXIgX2NoaWxkID0gcGFyZW50QS5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBhKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBiID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoX2NoaWxkID09PSBiKSB7CiAgICAgICAgICAgICAgICAgIGRpZEZpbmRDaGlsZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICBhID0gcGFyZW50QjsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfY2hpbGQgPSBfY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgIF9jaGlsZCA9IHBhcmVudEIuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGEpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChfY2hpbGQgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgICBkaWRGaW5kQ2hpbGQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGIgPSBwYXJlbnRCOwogICAgICAgICAgICAgICAgICAgIGEgPSBwYXJlbnRBOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFkaWRGaW5kQ2hpbGQpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDaGlsZCB3YXMgbm90IGZvdW5kIGluIGVpdGhlciBwYXJlbnQgc2V0LiBUaGlzIGluZGljYXRlcyBhIGJ1ZyBpbiBSZWFjdCByZWxhdGVkIHRvIHRoZSByZXR1cm4gcG9pbnRlci4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChhLmFsdGVybmF0ZSAhPT0gYikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmV0dXJuIGZpYmVycyBzaG91bGQgYWx3YXlzIGJlIGVhY2ggb3RoZXJzJyBhbHRlcm5hdGVzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYS50YWcgIT09IEhvc3RSb290KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5hYmxlIHRvIGZpbmQgbm9kZSBvbiBhbiB1bm1vdW50ZWQgY29tcG9uZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGEuc3RhdGVOb2RlLmN1cnJlbnQgPT09IGEpIHsKICAgICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGFsdGVybmF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRIb3N0RmliZXIocGFyZW50KSB7CiAgICAgICAgICB2YXIgY3VycmVudFBhcmVudCA9IGZpbmRDdXJyZW50RmliZXJVc2luZ1Nsb3dQYXRoKHBhcmVudCk7CiAgICAgICAgICByZXR1cm4gY3VycmVudFBhcmVudCAhPT0gbnVsbCA/IGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVySW1wbChub2RlKSB7CiAgICAgICAgICBpZiAobm9kZS50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgbm9kZS50YWcgPT09IEhvc3RUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbWF0Y2ggPSBmaW5kQ3VycmVudEhvc3RGaWJlckltcGwoY2hpbGQpOwogICAgICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFscyhwYXJlbnQpIHsKICAgICAgICAgIHZhciBjdXJyZW50UGFyZW50ID0gZmluZEN1cnJlbnRGaWJlclVzaW5nU2xvd1BhdGgocGFyZW50KTsKICAgICAgICAgIHJldHVybiBjdXJyZW50UGFyZW50ICE9PSBudWxsID8gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzSW1wbChjdXJyZW50UGFyZW50KSA6IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwobm9kZSkgewogICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGNoaWxkLnRhZyAhPT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgIHZhciBtYXRjaCA9IGZpbmRDdXJyZW50SG9zdEZpYmVyV2l0aE5vUG9ydGFsc0ltcGwoY2hpbGQpOwogICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIHNjaGVkdWxlQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjazsKICAgICAgICB2YXIgY2FuY2VsQ2FsbGJhY2sgPSBTY2hlZHVsZXIudW5zdGFibGVfY2FuY2VsQ2FsbGJhY2s7CiAgICAgICAgdmFyIHNob3VsZFlpZWxkID0gU2NoZWR1bGVyLnVuc3RhYmxlX3Nob3VsZFlpZWxkOwogICAgICAgIHZhciByZXF1ZXN0UGFpbnQgPSBTY2hlZHVsZXIudW5zdGFibGVfcmVxdWVzdFBhaW50OwogICAgICAgIHZhciBub3cgPSBTY2hlZHVsZXIudW5zdGFibGVfbm93OwogICAgICAgIHZhciBnZXRDdXJyZW50UHJpb3JpdHlMZXZlbCA9IFNjaGVkdWxlci51bnN0YWJsZV9nZXRDdXJyZW50UHJpb3JpdHlMZXZlbDsKICAgICAgICB2YXIgSW1tZWRpYXRlUHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfSW1tZWRpYXRlUHJpb3JpdHk7CiAgICAgICAgdmFyIFVzZXJCbG9ja2luZ1ByaW9yaXR5ID0gU2NoZWR1bGVyLnVuc3RhYmxlX1VzZXJCbG9ja2luZ1ByaW9yaXR5OwogICAgICAgIHZhciBOb3JtYWxQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9Ob3JtYWxQcmlvcml0eTsKICAgICAgICB2YXIgTG93UHJpb3JpdHkgPSBTY2hlZHVsZXIudW5zdGFibGVfTG93UHJpb3JpdHk7CiAgICAgICAgdmFyIElkbGVQcmlvcml0eSA9IFNjaGVkdWxlci51bnN0YWJsZV9JZGxlUHJpb3JpdHk7CiAgICAgICAgdmFyIHVuc3RhYmxlX3lpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfeWllbGRWYWx1ZTsKICAgICAgICB2YXIgdW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWUgPSBTY2hlZHVsZXIudW5zdGFibGVfc2V0RGlzYWJsZVlpZWxkVmFsdWU7CiAgICAgICAgdmFyIHJlbmRlcmVySUQgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZEhvb2sgPSBudWxsOwogICAgICAgIHZhciBpbmplY3RlZFByb2ZpbGluZ0hvb2tzID0gbnVsbDsKICAgICAgICB2YXIgaGFzTG9nZ2VkRXJyb3IgPSBmYWxzZTsKICAgICAgICB2YXIgaXNEZXZUb29sc1ByZXNlbnQgPSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fICE9PSAidW5kZWZpbmVkIjsKICAgICAgICBmdW5jdGlvbiBpbmplY3RJbnRlcm5hbHMoaW50ZXJuYWxzMikgewogICAgICAgICAgaWYgKHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBob29rID0gX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fOwogICAgICAgICAgaWYgKGhvb2suaXNEaXNhYmxlZCkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaG9vay5zdXBwb3J0c0ZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIGluc3RhbGxlZCB2ZXJzaW9uIG9mIFJlYWN0IERldlRvb2xzIGlzIHRvbyBvbGQgYW5kIHdpbGwgbm90IHdvcmsgd2l0aCB0aGUgY3VycmVudCB2ZXJzaW9uIG9mIFJlYWN0LiBQbGVhc2UgdXBkYXRlIFJlYWN0IERldlRvb2xzLiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtZGV2dG9vbHMiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChlbmFibGVTY2hlZHVsaW5nUHJvZmlsZXIpIHsKICAgICAgICAgICAgICBpbnRlcm5hbHMyID0gYXNzaWduMih7fSwgaW50ZXJuYWxzMiwgewogICAgICAgICAgICAgICAgZ2V0TGFuZUxhYmVsTWFwLAogICAgICAgICAgICAgICAgaW5qZWN0UHJvZmlsaW5nSG9va3MKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZW5kZXJlcklEID0gaG9vay5pbmplY3QoaW50ZXJuYWxzMik7CiAgICAgICAgICAgIGluamVjdGVkSG9vayA9IGhvb2s7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzLiIsIGVycik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChob29rLmNoZWNrRENFKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvblNjaGVkdWxlUm9vdChyb290MywgY2hpbGRyZW4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uU2NoZWR1bGVGaWJlclJvb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uU2NoZWR1bGVGaWJlclJvb3QocmVuZGVyZXJJRCwgcm9vdDMsIGNoaWxkcmVuKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uQ29tbWl0Um9vdChyb290MywgZXZlbnRQcmlvcml0eSkgewogICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJSb290ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdmFyIGRpZEVycm9yID0gKHJvb3QzLmN1cnJlbnQuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICBpZiAoZW5hYmxlUHJvZmlsZXJUaW1lcikgewogICAgICAgICAgICAgICAgdmFyIHNjaGVkdWxlclByaW9yaXR5OwogICAgICAgICAgICAgICAgc3dpdGNoIChldmVudFByaW9yaXR5KSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgRGlzY3JldGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gSW1tZWRpYXRlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgQ29udGludW91c0V2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHkgPSBVc2VyQmxvY2tpbmdQcmlvcml0eTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBEZWZhdWx0RXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eSA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIElkbGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gSWRsZVByaW9yaXR5OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5ID0gTm9ybWFsUHJpb3JpdHk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpbmplY3RlZEhvb2sub25Db21taXRGaWJlclJvb3QocmVuZGVyZXJJRCwgcm9vdDMsIHNjaGVkdWxlclByaW9yaXR5LCBkaWRFcnJvcik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGluamVjdGVkSG9vay5vbkNvbW1pdEZpYmVyUm9vdChyZW5kZXJlcklELCByb290Mywgdm9pZCAwLCBkaWRFcnJvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc0xvZ2dlZEVycm9yKSB7CiAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlJlYWN0IGluc3RydW1lbnRhdGlvbiBlbmNvdW50ZXJlZCBhbiBlcnJvcjogJXMiLCBlcnIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBvblBvc3RDb21taXRSb290KHJvb3QzKSB7CiAgICAgICAgICBpZiAoaW5qZWN0ZWRIb29rICYmIHR5cGVvZiBpbmplY3RlZEhvb2sub25Qb3N0Q29tbWl0RmliZXJSb290ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uUG9zdENvbW1pdEZpYmVyUm9vdChyZW5kZXJlcklELCByb290Myk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghaGFzTG9nZ2VkRXJyb3IpIHsKICAgICAgICAgICAgICAgICAgaGFzTG9nZ2VkRXJyb3IgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9uQ29tbWl0VW5tb3VudChmaWJlcikgewogICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLm9uQ29tbWl0RmliZXJVbm1vdW50KHJlbmRlcmVySUQsIGZpYmVyKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICBoYXNMb2dnZWRFcnJvciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBpbnN0cnVtZW50YXRpb24gZW5jb3VudGVyZWQgYW4gZXJyb3I6ICVzIiwgZXJyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMobmV3SXNTdHJpY3RNb2RlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdW5zdGFibGVfeWllbGRWYWx1ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHVuc3RhYmxlX3NldERpc2FibGVZaWVsZFZhbHVlKG5ld0lzU3RyaWN0TW9kZSk7CiAgICAgICAgICAgICAgc2V0U3VwcHJlc3NXYXJuaW5nKG5ld0lzU3RyaWN0TW9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluamVjdGVkSG9vayAmJiB0eXBlb2YgaW5qZWN0ZWRIb29rLnNldFN0cmljdE1vZGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgaW5qZWN0ZWRIb29rLnNldFN0cmljdE1vZGUocmVuZGVyZXJJRCwgbmV3SXNTdHJpY3RNb2RlKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKCFoYXNMb2dnZWRFcnJvcikgewogICAgICAgICAgICAgICAgICAgIGhhc0xvZ2dlZEVycm9yID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QgaW5zdHJ1bWVudGF0aW9uIGVuY291bnRlcmVkIGFuIGVycm9yOiAlcyIsIGVycik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5qZWN0UHJvZmlsaW5nSG9va3MocHJvZmlsaW5nSG9va3MpIHsKICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MgPSBwcm9maWxpbmdIb29rczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TGFuZUxhYmVsTWFwKCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgbWFwMyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMTsKICAgICAgICAgICAgZm9yICh2YXIgaW5kZXgyID0gMDsgaW5kZXgyIDwgVG90YWxMYW5lczsgaW5kZXgyKyspIHsKICAgICAgICAgICAgICB2YXIgbGFiZWwgPSBnZXRMYWJlbEZvckxhbmUobGFuZSk7CiAgICAgICAgICAgICAgbWFwMy5zZXQobGFuZSwgbGFiZWwpOwogICAgICAgICAgICAgIGxhbmUgKj0gMjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWFwMzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbW1pdFN0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tbWl0U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbW1pdFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21taXRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFJlbmRlclN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdE1vdW50U3RvcHBlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50UGFzc2l2ZUVmZmVjdFVubW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudExheW91dEVmZmVjdE1vdW50U3RhcnRlZChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRMYXlvdXRFZmZlY3RVbm1vdW50U3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudEVycm9yZWQoZmliZXIsIHRocm93blZhbHVlLCBsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrQ29tcG9uZW50RXJyb3JlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0NvbXBvbmVudEVycm9yZWQoZmliZXIsIHRocm93blZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbXBvbmVudFN1c3BlbmRlZChmaWJlciwgd2FrZWFibGUsIGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRTdXNwZW5kZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtDb21wb25lbnRTdXNwZW5kZWQoZmliZXIsIHdha2VhYmxlLCBsYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0xheW91dEVmZmVjdHNTdGFydGVkKGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtMYXlvdXRFZmZlY3RzU3RhcnRlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrTGF5b3V0RWZmZWN0c1N0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtMYXlvdXRFZmZlY3RzU3RvcHBlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Bhc3NpdmVFZmZlY3RzU3RhcnRlZChsYW5lcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUGFzc2l2ZUVmZmVjdHNTdG9wcGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUGFzc2l2ZUVmZmVjdHNTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUGFzc2l2ZUVmZmVjdHNTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlbmRlclN0YXJ0ZWQobGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlclN0YXJ0ZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmVuZGVyWWllbGRlZCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluamVjdGVkUHJvZmlsaW5nSG9va3MgIT09IG51bGwgJiYgdHlwZW9mIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1JlbmRlcllpZWxkZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJZaWVsZGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlbmRlclN0b3BwZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtSZW5kZXJTdG9wcGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZW5kZXJTY2hlZHVsZWQobGFuZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU2NoZWR1bGVkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrUmVuZGVyU2NoZWR1bGVkKGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtGb3JjZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5qZWN0ZWRQcm9maWxpbmdIb29rcyAhPT0gbnVsbCAmJiB0eXBlb2YgaW5qZWN0ZWRQcm9maWxpbmdIb29rcy5tYXJrRm9yY2VVcGRhdGVTY2hlZHVsZWQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtGb3JjZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpbmplY3RlZFByb2ZpbGluZ0hvb2tzICE9PSBudWxsICYmIHR5cGVvZiBpbmplY3RlZFByb2ZpbGluZ0hvb2tzLm1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGluamVjdGVkUHJvZmlsaW5nSG9va3MubWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTm9Nb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDAKICAgICAgICApOwogICAgICAgIHZhciBDb25jdXJyZW50TW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIFByb2ZpbGVNb2RlID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgU3RyaWN0TGVnYWN5TW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDgKICAgICAgICApOwogICAgICAgIHZhciBTdHJpY3RFZmZlY3RzTW9kZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAqLwogICAgICAgICAgMTYKICAgICAgICApOwogICAgICAgIHZhciBjbHozMiA9IE1hdGguY2x6MzIgPyBNYXRoLmNsejMyIDogY2x6MzJGYWxsYmFjazsKICAgICAgICB2YXIgbG9nMiA9IE1hdGgubG9nOwogICAgICAgIHZhciBMTjIgPSBNYXRoLkxOMjsKICAgICAgICBmdW5jdGlvbiBjbHozMkZhbGxiYWNrKHgyKSB7CiAgICAgICAgICB2YXIgYXNVaW50ID0geDIgPj4+IDA7CiAgICAgICAgICBpZiAoYXNVaW50ID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiAzMjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAzMSAtIChsb2cyKGFzVWludCkgLyBMTjIgfCAwKSB8IDA7CiAgICAgICAgfQogICAgICAgIHZhciBUb3RhbExhbmVzID0gMzE7CiAgICAgICAgdmFyIE5vTGFuZXMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgTm9MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAwCiAgICAgICAgKTsKICAgICAgICB2YXIgU3luY0xhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgSW5wdXRDb250aW51b3VzTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICovCiAgICAgICAgICA0CiAgICAgICAgKTsKICAgICAgICB2YXIgRGVmYXVsdEh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICovCiAgICAgICAgICA4CiAgICAgICAgKTsKICAgICAgICB2YXIgRGVmYXVsdExhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxNgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDMyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA0MTk0MjQwCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNjQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTIgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMjgKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTMgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNTYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA1MTIKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDI0CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU2ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjA0OAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lNyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQwOTYKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTggPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA4MTkyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmU5ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTYzODQKICAgICAgICApOwogICAgICAgIHZhciBUcmFuc2l0aW9uTGFuZTEwID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMjc2OAogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTEgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY1NTM2CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMiA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTMxMDcyCiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxMyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMjYyMTQ0CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxNCA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNTI0Mjg4CiAgICAgICAgKTsKICAgICAgICB2YXIgVHJhbnNpdGlvbkxhbmUxNSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTA0ODU3NgogICAgICAgICk7CiAgICAgICAgdmFyIFRyYW5zaXRpb25MYW5lMTYgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDIwOTcxNTIKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDEzMDAyMzQyNAogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTEgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDQxOTQzMDQKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmUyID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICA4Mzg4NjA4CiAgICAgICAgKTsKICAgICAgICB2YXIgUmV0cnlMYW5lMyA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMTY3NzcyMTYKICAgICAgICApOwogICAgICAgIHZhciBSZXRyeUxhbmU0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAzMzU1NDQzMgogICAgICAgICk7CiAgICAgICAgdmFyIFJldHJ5TGFuZTUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDY3MTA4ODY0CiAgICAgICAgKTsKICAgICAgICB2YXIgU29tZVJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgdmFyIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmUgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAqLwogICAgICAgICAgMTM0MjE3NzI4CiAgICAgICAgKTsKICAgICAgICB2YXIgTm9uSWRsZUxhbmVzID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAyNjg0MzU0NTUKICAgICAgICApOwogICAgICAgIHZhciBJZGxlSHlkcmF0aW9uTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgKi8KICAgICAgICAgIDI2ODQzNTQ1NgogICAgICAgICk7CiAgICAgICAgdmFyIElkbGVMYW5lID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNTM2ODcwOTEyCiAgICAgICAgKTsKICAgICAgICB2YXIgT2Zmc2NyZWVuTGFuZSA9ICgKICAgICAgICAgIC8qICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAxMDczNzQxODI0CiAgICAgICAgKTsKICAgICAgICBmdW5jdGlvbiBnZXRMYWJlbEZvckxhbmUobGFuZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAobGFuZSAmIFN5bmNMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJTeW5jIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIklucHV0Q29udGludW91c0h5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJbnB1dENvbnRpbnVvdXNMYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJJbnB1dENvbnRpbnVvdXMiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgRGVmYXVsdEh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIkRlZmF1bHRIeWRyYXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgRGVmYXVsdExhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIkRlZmF1bHQiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlRyYW5zaXRpb25IeWRyYXRpb24iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChsYW5lICYgVHJhbnNpdGlvbkxhbmVzKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJUcmFuc2l0aW9uIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIFJldHJ5TGFuZXMpIHsKICAgICAgICAgICAgICByZXR1cm4gIlJldHJ5IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGFuZSAmIFNlbGVjdGl2ZUh5ZHJhdGlvbkxhbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIlNlbGVjdGl2ZUh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJZGxlSHlkcmF0aW9uTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSWRsZUh5ZHJhdGlvbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBJZGxlTGFuZSkgewogICAgICAgICAgICAgIHJldHVybiAiSWRsZSI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxhbmUgJiBPZmZzY3JlZW5MYW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICJPZmZzY3JlZW4iOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBOb1RpbWVzdGFtcCA9IC0xOwogICAgICAgIHZhciBuZXh0VHJhbnNpdGlvbkxhbmUgPSBUcmFuc2l0aW9uTGFuZTE7CiAgICAgICAgdmFyIG5leHRSZXRyeUxhbmUgPSBSZXRyeUxhbmUxOwogICAgICAgIGZ1bmN0aW9uIGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKGxhbmVzKSB7CiAgICAgICAgICBzd2l0Y2ggKGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpKSB7CiAgICAgICAgICAgIGNhc2UgU3luY0xhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIFN5bmNMYW5lOwogICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSW5wdXRDb250aW51b3VzTGFuZTsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0SHlkcmF0aW9uTGFuZToKICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdExhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRMYW5lOwogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBUcmFuc2l0aW9uSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUyOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU1OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTc6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU4OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lOToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEwOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTE6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTEzOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTQ6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE2OgogICAgICAgICAgICAgIHJldHVybiBsYW5lcyAmIFRyYW5zaXRpb25MYW5lczsKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgcmV0dXJuIGxhbmVzICYgUmV0cnlMYW5lczsKICAgICAgICAgICAgY2FzZSBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOwogICAgICAgICAgICBjYXNlIElkbGVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICAgIHJldHVybiBJZGxlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgY2FzZSBJZGxlTGFuZToKICAgICAgICAgICAgICByZXR1cm4gSWRsZUxhbmU7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuTGFuZToKICAgICAgICAgICAgICByZXR1cm4gT2Zmc2NyZWVuTGFuZTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBlcnJvcigiU2hvdWxkIGhhdmUgZm91bmQgbWF0Y2hpbmcgbGFuZXMuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBsYW5lczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dExhbmVzKHJvb3QzLCB3aXBMYW5lcykgewogICAgICAgICAgdmFyIHBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIGlmIChwZW5kaW5nTGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgdmFyIHBpbmdlZExhbmVzID0gcm9vdDMucGluZ2VkTGFuZXM7CiAgICAgICAgICB2YXIgbm9uSWRsZVBlbmRpbmdMYW5lcyA9IHBlbmRpbmdMYW5lcyAmIE5vbklkbGVMYW5lczsKICAgICAgICAgIGlmIChub25JZGxlUGVuZGluZ0xhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHZhciBub25JZGxlVW5ibG9ja2VkTGFuZXMgPSBub25JZGxlUGVuZGluZ0xhbmVzICYgfnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICBpZiAobm9uSWRsZVVuYmxvY2tlZExhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgbmV4dExhbmVzID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZXMobm9uSWRsZVVuYmxvY2tlZExhbmVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgbm9uSWRsZVBpbmdlZExhbmVzID0gbm9uSWRsZVBlbmRpbmdMYW5lcyAmIHBpbmdlZExhbmVzOwogICAgICAgICAgICAgIGlmIChub25JZGxlUGluZ2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKG5vbklkbGVQaW5nZWRMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdW5ibG9ja2VkTGFuZXMgPSBwZW5kaW5nTGFuZXMgJiB+c3VzcGVuZGVkTGFuZXM7CiAgICAgICAgICAgIGlmICh1bmJsb2NrZWRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKHVuYmxvY2tlZExhbmVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAocGluZ2VkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICAgIG5leHRMYW5lcyA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKHBpbmdlZExhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChuZXh0TGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIE5vTGFuZXM7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod2lwTGFuZXMgIT09IE5vTGFuZXMgJiYgd2lwTGFuZXMgIT09IG5leHRMYW5lcyAmJiAvLyBJZiB3ZSBhbHJlYWR5IHN1c3BlbmRlZCB3aXRoIGEgZGVsYXksIHRoZW4gaW50ZXJydXB0aW5nIGlzIGZpbmUuIERvbid0CiAgICAgICAgICAvLyBib3RoZXIgd2FpdGluZyB1bnRpbCB0aGUgcm9vdCBpcyBjb21wbGV0ZS4KICAgICAgICAgICh3aXBMYW5lcyAmIHN1c3BlbmRlZExhbmVzKSA9PT0gTm9MYW5lcykgewogICAgICAgICAgICB2YXIgbmV4dExhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKG5leHRMYW5lcyk7CiAgICAgICAgICAgIHZhciB3aXBMYW5lID0gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZSh3aXBMYW5lcyk7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAvLyBUZXN0cyB3aGV0aGVyIHRoZSBuZXh0IGxhbmUgaXMgZXF1YWwgb3IgbG93ZXIgcHJpb3JpdHkgdGhhbiB0aGUgd2lwCiAgICAgICAgICAgICAgLy8gb25lLiBUaGlzIHdvcmtzIGJlY2F1c2UgdGhlIGJpdHMgZGVjcmVhc2UgaW4gcHJpb3JpdHkgYXMgeW91IGdvIGxlZnQuCiAgICAgICAgICAgICAgbmV4dExhbmUgPj0gd2lwTGFuZSB8fCAvLyBEZWZhdWx0IHByaW9yaXR5IHVwZGF0ZXMgc2hvdWxkIG5vdCBpbnRlcnJ1cHQgdHJhbnNpdGlvbiB1cGRhdGVzLiBUaGUKICAgICAgICAgICAgICAvLyBvbmx5IGRpZmZlcmVuY2UgYmV0d2VlbiBkZWZhdWx0IHVwZGF0ZXMgYW5kIHRyYW5zaXRpb24gdXBkYXRlcyBpcyB0aGF0CiAgICAgICAgICAgICAgLy8gZGVmYXVsdCB1cGRhdGVzIGRvIG5vdCBzdXBwb3J0IHJlZnJlc2ggdHJhbnNpdGlvbnMuCiAgICAgICAgICAgICAgbmV4dExhbmUgPT09IERlZmF1bHRMYW5lICYmICh3aXBMYW5lICYgVHJhbnNpdGlvbkxhbmVzKSAhPT0gTm9MYW5lcwogICAgICAgICAgICApIHsKICAgICAgICAgICAgICByZXR1cm4gd2lwTGFuZXM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICgobmV4dExhbmVzICYgSW5wdXRDb250aW51b3VzTGFuZSkgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgbmV4dExhbmVzIHw9IHBlbmRpbmdMYW5lcyAmIERlZmF1bHRMYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGVudGFuZ2xlZExhbmVzID0gcm9vdDMuZW50YW5nbGVkTGFuZXM7CiAgICAgICAgICBpZiAoZW50YW5nbGVkTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgdmFyIGVudGFuZ2xlbWVudHMgPSByb290My5lbnRhbmdsZW1lbnRzOwogICAgICAgICAgICB2YXIgbGFuZXMgPSBuZXh0TGFuZXMgJiBlbnRhbmdsZWRMYW5lczsKICAgICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICAgIG5leHRMYW5lcyB8PSBlbnRhbmdsZW1lbnRzW2luZGV4Ml07CiAgICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXh0TGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE1vc3RSZWNlbnRFdmVudFRpbWUocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lcyA9IHJvb3QzLmV2ZW50VGltZXM7CiAgICAgICAgICB2YXIgbW9zdFJlY2VudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSBldmVudFRpbWVzW2luZGV4Ml07CiAgICAgICAgICAgIGlmIChldmVudFRpbWUgPiBtb3N0UmVjZW50RXZlbnRUaW1lKSB7CiAgICAgICAgICAgICAgbW9zdFJlY2VudEV2ZW50VGltZSA9IGV2ZW50VGltZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtb3N0UmVjZW50RXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wdXRlRXhwaXJhdGlvblRpbWUobGFuZSwgY3VycmVudFRpbWUpIHsKICAgICAgICAgIHN3aXRjaCAobGFuZSkgewogICAgICAgICAgICBjYXNlIFN5bmNMYW5lOgogICAgICAgICAgICBjYXNlIElucHV0Q29udGludW91c0h5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFRpbWUgKyAyNTA7CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdEh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgRGVmYXVsdExhbmU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkh5ZHJhdGlvbkxhbmU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTY6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU3OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lODoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTk6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTExOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNjoKICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFRpbWUgKyA1ZTM7CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMToKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUyOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTM6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lNDoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU1OgogICAgICAgICAgICAgIHJldHVybiBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgY2FzZSBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICBjYXNlIElkbGVIeWRyYXRpb25MYW5lOgogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkxhbmU6CiAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGVycm9yKCJTaG91bGQgaGF2ZSBmb3VuZCBtYXRjaGluZyBsYW5lcy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIE5vVGltZXN0YW1wOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrU3RhcnZlZExhbmVzQXNFeHBpcmVkKHJvb3QzLCBjdXJyZW50VGltZSkgewogICAgICAgICAgdmFyIHBlbmRpbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgdmFyIHBpbmdlZExhbmVzID0gcm9vdDMucGluZ2VkTGFuZXM7CiAgICAgICAgICB2YXIgZXhwaXJhdGlvblRpbWVzID0gcm9vdDMuZXhwaXJhdGlvblRpbWVzOwogICAgICAgICAgdmFyIGxhbmVzID0gcGVuZGluZ0xhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzID4gMCkgewogICAgICAgICAgICB2YXIgaW5kZXgyID0gcGlja0FyYml0cmFyeUxhbmVJbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZSA9IGV4cGlyYXRpb25UaW1lc1tpbmRleDJdOwogICAgICAgICAgICBpZiAoZXhwaXJhdGlvblRpbWUgPT09IE5vVGltZXN0YW1wKSB7CiAgICAgICAgICAgICAgaWYgKChsYW5lICYgc3VzcGVuZGVkTGFuZXMpID09PSBOb0xhbmVzIHx8IChsYW5lICYgcGluZ2VkTGFuZXMpICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBleHBpcmF0aW9uVGltZXNbaW5kZXgyXSA9IGNvbXB1dGVFeHBpcmF0aW9uVGltZShsYW5lLCBjdXJyZW50VGltZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGV4cGlyYXRpb25UaW1lIDw9IGN1cnJlbnRUaW1lKSB7CiAgICAgICAgICAgICAgcm9vdDMuZXhwaXJlZExhbmVzIHw9IGxhbmU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhpZ2hlc3RQcmlvcml0eVBlbmRpbmdMYW5lcyhyb290MykgewogICAgICAgICAgcmV0dXJuIGdldEhpZ2hlc3RQcmlvcml0eUxhbmVzKHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExhbmVzVG9SZXRyeVN5bmNocm9ub3VzbHlPbkVycm9yKHJvb3QzKSB7CiAgICAgICAgICB2YXIgZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiA9IHJvb3QzLnBlbmRpbmdMYW5lcyAmIH5PZmZzY3JlZW5MYW5lOwogICAgICAgICAgaWYgKGV2ZXJ5dGhpbmdCdXRPZmZzY3JlZW4gIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIGV2ZXJ5dGhpbmdCdXRPZmZzY3JlZW47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZXZlcnl0aGluZ0J1dE9mZnNjcmVlbiAmIE9mZnNjcmVlbkxhbmUpIHsKICAgICAgICAgICAgcmV0dXJuIE9mZnNjcmVlbkxhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNTeW5jTGFuZShsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIFN5bmNMYW5lKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5jbHVkZXNOb25JZGxlV29yayhsYW5lcykgewogICAgICAgICAgcmV0dXJuIChsYW5lcyAmIE5vbklkbGVMYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seVJldHJpZXMobGFuZXMpIHsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBSZXRyeUxhbmVzKSA9PT0gbGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seU5vblVyZ2VudExhbmVzKGxhbmVzKSB7CiAgICAgICAgICB2YXIgVXJnZW50TGFuZXMgPSBTeW5jTGFuZSB8IElucHV0Q29udGludW91c0xhbmUgfCBEZWZhdWx0TGFuZTsKICAgICAgICAgIHJldHVybiAobGFuZXMgJiBVcmdlbnRMYW5lcykgPT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzT25seVRyYW5zaXRpb25zKGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgVHJhbnNpdGlvbkxhbmVzKSA9PT0gbGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIFN5bmNEZWZhdWx0TGFuZXMgPSBJbnB1dENvbnRpbnVvdXNIeWRyYXRpb25MYW5lIHwgSW5wdXRDb250aW51b3VzTGFuZSB8IERlZmF1bHRIeWRyYXRpb25MYW5lIHwgRGVmYXVsdExhbmU7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgU3luY0RlZmF1bHRMYW5lcykgIT09IE5vTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluY2x1ZGVzRXhwaXJlZExhbmUocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmVzICYgcm9vdDMuZXhwaXJlZExhbmVzKSAhPT0gTm9MYW5lczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNUcmFuc2l0aW9uTGFuZShsYW5lKSB7CiAgICAgICAgICByZXR1cm4gKGxhbmUgJiBUcmFuc2l0aW9uTGFuZXMpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpIHsKICAgICAgICAgIHZhciBsYW5lID0gbmV4dFRyYW5zaXRpb25MYW5lOwogICAgICAgICAgbmV4dFRyYW5zaXRpb25MYW5lIDw8PSAxOwogICAgICAgICAgaWYgKChuZXh0VHJhbnNpdGlvbkxhbmUgJiBUcmFuc2l0aW9uTGFuZXMpID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIG5leHRUcmFuc2l0aW9uTGFuZSA9IFRyYW5zaXRpb25MYW5lMTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGFpbU5leHRSZXRyeUxhbmUoKSB7CiAgICAgICAgICB2YXIgbGFuZSA9IG5leHRSZXRyeUxhbmU7CiAgICAgICAgICBuZXh0UmV0cnlMYW5lIDw8PSAxOwogICAgICAgICAgaWYgKChuZXh0UmV0cnlMYW5lICYgUmV0cnlMYW5lcykgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgbmV4dFJldHJ5TGFuZSA9IFJldHJ5TGFuZTE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SGlnaGVzdFByaW9yaXR5TGFuZShsYW5lcykgewogICAgICAgICAgcmV0dXJuIGxhbmVzICYgLWxhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwaWNrQXJiaXRyYXJ5TGFuZShsYW5lcykgewogICAgICAgICAgcmV0dXJuIGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKSB7CiAgICAgICAgICByZXR1cm4gMzEgLSBjbHozMihsYW5lcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxhbmVUb0luZGV4KGxhbmUpIHsKICAgICAgICAgIHJldHVybiBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbmNsdWRlc1NvbWVMYW5lKGEsIGIpIHsKICAgICAgICAgIHJldHVybiAoYSAmIGIpICE9PSBOb0xhbmVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1N1YnNldE9mTGFuZXMoc2V0NCwgc3Vic2V0KSB7CiAgICAgICAgICByZXR1cm4gKHNldDQgJiBzdWJzZXQpID09PSBzdWJzZXQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1lcmdlTGFuZXMoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgfCBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVMYW5lcyhzZXQ0LCBzdWJzZXQpIHsKICAgICAgICAgIHJldHVybiBzZXQ0ICYgfnN1YnNldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW50ZXJzZWN0TGFuZXMoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgJiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsYW5lVG9MYW5lcyhsYW5lKSB7CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlnaGVyUHJpb3JpdHlMYW5lKGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhICE9PSBOb0xhbmUgJiYgYSA8IGIgPyBhIDogYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlTGFuZU1hcChpbml0aWFsKSB7CiAgICAgICAgICB2YXIgbGFuZU1hcCA9IFtdOwogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBUb3RhbExhbmVzOyBpKyspIHsKICAgICAgICAgICAgbGFuZU1hcC5wdXNoKGluaXRpYWwpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmVNYXA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290VXBkYXRlZChyb290MywgdXBkYXRlTGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICByb290My5wZW5kaW5nTGFuZXMgfD0gdXBkYXRlTGFuZTsKICAgICAgICAgIGlmICh1cGRhdGVMYW5lICE9PSBJZGxlTGFuZSkgewogICAgICAgICAgICByb290My5zdXNwZW5kZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBpbmRleDIgPSBsYW5lVG9JbmRleCh1cGRhdGVMYW5lKTsKICAgICAgICAgIGV2ZW50VGltZXNbaW5kZXgyXSA9IGV2ZW50VGltZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RTdXNwZW5kZWQocm9vdDMsIHN1c3BlbmRlZExhbmVzKSB7CiAgICAgICAgICByb290My5zdXNwZW5kZWRMYW5lcyB8PSBzdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzICY9IH5zdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBzdXNwZW5kZWRMYW5lczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBleHBpcmF0aW9uVGltZXNbaW5kZXgyXSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1Jvb3RQaW5nZWQocm9vdDMsIHBpbmdlZExhbmVzLCBldmVudFRpbWUpIHsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzIHw9IHJvb3QzLnN1c3BlbmRlZExhbmVzICYgcGluZ2VkTGFuZXM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290RmluaXNoZWQocm9vdDMsIHJlbWFpbmluZ0xhbmVzKSB7CiAgICAgICAgICB2YXIgbm9Mb25nZXJQZW5kaW5nTGFuZXMgPSByb290My5wZW5kaW5nTGFuZXMgJiB+cmVtYWluaW5nTGFuZXM7CiAgICAgICAgICByb290My5wZW5kaW5nTGFuZXMgPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLnN1c3BlbmRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHJvb3QzLnBpbmdlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHJvb3QzLmV4cGlyZWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHJvb3QzLm11dGFibGVSZWFkTGFuZXMgJj0gcmVtYWluaW5nTGFuZXM7CiAgICAgICAgICByb290My5lbnRhbmdsZWRMYW5lcyAmPSByZW1haW5pbmdMYW5lczsKICAgICAgICAgIHZhciBlbnRhbmdsZW1lbnRzID0gcm9vdDMuZW50YW5nbGVtZW50czsKICAgICAgICAgIHZhciBldmVudFRpbWVzID0gcm9vdDMuZXZlbnRUaW1lczsKICAgICAgICAgIHZhciBleHBpcmF0aW9uVGltZXMgPSByb290My5leHBpcmF0aW9uVGltZXM7CiAgICAgICAgICB2YXIgbGFuZXMgPSBub0xvbmdlclBlbmRpbmdMYW5lczsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IHBpY2tBcmJpdHJhcnlMYW5lSW5kZXgobGFuZXMpOwogICAgICAgICAgICB2YXIgbGFuZSA9IDEgPDwgaW5kZXgyOwogICAgICAgICAgICBlbnRhbmdsZW1lbnRzW2luZGV4Ml0gPSBOb0xhbmVzOwogICAgICAgICAgICBldmVudFRpbWVzW2luZGV4Ml0gPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgZXhwaXJhdGlvblRpbWVzW2luZGV4Ml0gPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBlbnRhbmdsZWRMYW5lcykgewogICAgICAgICAgdmFyIHJvb3RFbnRhbmdsZWRMYW5lcyA9IHJvb3QzLmVudGFuZ2xlZExhbmVzIHw9IGVudGFuZ2xlZExhbmVzOwogICAgICAgICAgdmFyIGVudGFuZ2xlbWVudHMgPSByb290My5lbnRhbmdsZW1lbnRzOwogICAgICAgICAgdmFyIGxhbmVzID0gcm9vdEVudGFuZ2xlZExhbmVzOwogICAgICAgICAgd2hpbGUgKGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBwaWNrQXJiaXRyYXJ5TGFuZUluZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgIC8vIElzIHRoaXMgb25lIG9mIHRoZSBuZXdseSBlbnRhbmdsZWQgbGFuZXM/CiAgICAgICAgICAgICAgbGFuZSAmIGVudGFuZ2xlZExhbmVzIHwgLy8gSXMgdGhpcyBsYW5lIHRyYW5zaXRpdmVseSBlbnRhbmdsZWQgd2l0aCB0aGUgbmV3bHkgZW50YW5nbGVkIGxhbmVzPwogICAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSAmIGVudGFuZ2xlZExhbmVzCiAgICAgICAgICAgICkgewogICAgICAgICAgICAgIGVudGFuZ2xlbWVudHNbaW5kZXgyXSB8PSBlbnRhbmdsZWRMYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0QnVtcGVkTGFuZUZvckh5ZHJhdGlvbihyb290MywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgcmVuZGVyTGFuZSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBsYW5lOwogICAgICAgICAgc3dpdGNoIChyZW5kZXJMYW5lKSB7CiAgICAgICAgICAgIGNhc2UgSW5wdXRDb250aW51b3VzTGFuZToKICAgICAgICAgICAgICBsYW5lID0gSW5wdXRDb250aW51b3VzSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0TGFuZToKICAgICAgICAgICAgICBsYW5lID0gRGVmYXVsdEh5ZHJhdGlvbkxhbmU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMjoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTM6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lNToKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTY6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmU3OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lODoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTk6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMDoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTExOgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTI6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxMzoKICAgICAgICAgICAgY2FzZSBUcmFuc2l0aW9uTGFuZTE0OgogICAgICAgICAgICBjYXNlIFRyYW5zaXRpb25MYW5lMTU6CiAgICAgICAgICAgIGNhc2UgVHJhbnNpdGlvbkxhbmUxNjoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmUxOgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTI6CiAgICAgICAgICAgIGNhc2UgUmV0cnlMYW5lMzoKICAgICAgICAgICAgY2FzZSBSZXRyeUxhbmU0OgogICAgICAgICAgICBjYXNlIFJldHJ5TGFuZTU6CiAgICAgICAgICAgICAgbGFuZSA9IFRyYW5zaXRpb25IeWRyYXRpb25MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIElkbGVMYW5lOgogICAgICAgICAgICAgIGxhbmUgPSBJZGxlSHlkcmF0aW9uTGFuZTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBsYW5lID0gTm9MYW5lOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChsYW5lICYgKHJvb3QzLnN1c3BlbmRlZExhbmVzIHwgcmVuZGVyTGFuZXMyKSkgIT09IE5vTGFuZSkgewogICAgICAgICAgICByZXR1cm4gTm9MYW5lOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhbmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZEZpYmVyVG9MYW5lc01hcChyb290MywgZmliZXIsIGxhbmVzKSB7CiAgICAgICAgICBpZiAoIWlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwID0gcm9vdDMucGVuZGluZ1VwZGF0ZXJzTGFuZU1hcDsKICAgICAgICAgIHdoaWxlIChsYW5lcyA+IDApIHsKICAgICAgICAgICAgdmFyIGluZGV4MiA9IGxhbmVUb0luZGV4KGxhbmVzKTsKICAgICAgICAgICAgdmFyIGxhbmUgPSAxIDw8IGluZGV4MjsKICAgICAgICAgICAgdmFyIHVwZGF0ZXJzID0gcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcFtpbmRleDJdOwogICAgICAgICAgICB1cGRhdGVycy5hZGQoZmliZXIpOwogICAgICAgICAgICBsYW5lcyAmPSB+bGFuZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW92ZVBlbmRpbmdGaWJlcnNUb01lbW9pemVkKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgaWYgKCFpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcGVuZGluZ1VwZGF0ZXJzTGFuZU1hcCA9IHJvb3QzLnBlbmRpbmdVcGRhdGVyc0xhbmVNYXA7CiAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICB3aGlsZSAobGFuZXMgPiAwKSB7CiAgICAgICAgICAgIHZhciBpbmRleDIgPSBsYW5lVG9JbmRleChsYW5lcyk7CiAgICAgICAgICAgIHZhciBsYW5lID0gMSA8PCBpbmRleDI7CiAgICAgICAgICAgIHZhciB1cGRhdGVycyA9IHBlbmRpbmdVcGRhdGVyc0xhbmVNYXBbaW5kZXgyXTsKICAgICAgICAgICAgaWYgKHVwZGF0ZXJzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdXBkYXRlcnMuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgPT09IG51bGwgfHwgIW1lbW9pemVkVXBkYXRlcnMuaGFzKGFsdGVybmF0ZSkpIHsKICAgICAgICAgICAgICAgICAgbWVtb2l6ZWRVcGRhdGVycy5hZGQoZmliZXIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFuZXMgJj0gfmxhbmU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRyYW5zaXRpb25zRm9yTGFuZXMocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgRGlzY3JldGVFdmVudFByaW9yaXR5ID0gU3luY0xhbmU7CiAgICAgICAgdmFyIENvbnRpbnVvdXNFdmVudFByaW9yaXR5ID0gSW5wdXRDb250aW51b3VzTGFuZTsKICAgICAgICB2YXIgRGVmYXVsdEV2ZW50UHJpb3JpdHkgPSBEZWZhdWx0TGFuZTsKICAgICAgICB2YXIgSWRsZUV2ZW50UHJpb3JpdHkgPSBJZGxlTGFuZTsKICAgICAgICB2YXIgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50VXBkYXRlUHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShuZXdQcmlvcml0eSkgewogICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gbmV3UHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJ1bldpdGhQcmlvcml0eShwcmlvcml0eSwgZm4pIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gY3VycmVudFVwZGF0ZVByaW9yaXR5OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gcHJpb3JpdHk7CiAgICAgICAgICAgIHJldHVybiBmbigpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY3VycmVudFVwZGF0ZVByaW9yaXR5ID0gcHJldmlvdXNQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlnaGVyRXZlbnRQcmlvcml0eShhLCBiKSB7CiAgICAgICAgICByZXR1cm4gYSAhPT0gMCAmJiBhIDwgYiA/IGEgOiBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsb3dlckV2ZW50UHJpb3JpdHkoYSwgYikgewogICAgICAgICAgcmV0dXJuIGEgPT09IDAgfHwgYSA+IGIgPyBhIDogYjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNIaWdoZXJFdmVudFByaW9yaXR5KGEsIGIpIHsKICAgICAgICAgIHJldHVybiBhICE9PSAwICYmIGEgPCBiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsYW5lc1RvRXZlbnRQcmlvcml0eShsYW5lcykgewogICAgICAgICAgdmFyIGxhbmUgPSBnZXRIaWdoZXN0UHJpb3JpdHlMYW5lKGxhbmVzKTsKICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSwgbGFuZSkpIHsKICAgICAgICAgICAgcmV0dXJuIERpc2NyZXRlRXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KENvbnRpbnVvdXNFdmVudFByaW9yaXR5LCBsYW5lKSkgewogICAgICAgICAgICByZXR1cm4gQ29udGludW91c0V2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaW5jbHVkZXNOb25JZGxlV29yayhsYW5lKSkgewogICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gSWRsZUV2ZW50UHJpb3JpdHk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpIHsKICAgICAgICAgIHZhciBjdXJyZW50U3RhdGUgPSByb290My5jdXJyZW50Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gY3VycmVudFN0YXRlLmlzRGVoeWRyYXRlZDsKICAgICAgICB9CiAgICAgICAgdmFyIF9hdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb247CiAgICAgICAgZnVuY3Rpb24gc2V0QXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGZuKSB7CiAgICAgICAgICBfYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uID0gZm47CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmaWJlcikgewogICAgICAgICAgX2F0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbihmaWJlcik7CiAgICAgICAgfQogICAgICAgIHZhciBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihmbikgewogICAgICAgICAgYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24gPSBmbjsKICAgICAgICB9CiAgICAgICAgdmFyIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eTsKICAgICAgICBmdW5jdGlvbiBzZXRBdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkoZm4pIHsKICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdEN1cnJlbnRQcmlvcml0eSA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5JDE7CiAgICAgICAgZnVuY3Rpb24gc2V0R2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KGZuKSB7CiAgICAgICAgICBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkkMSA9IGZuOwogICAgICAgIH0KICAgICAgICB2YXIgYXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHk7CiAgICAgICAgZnVuY3Rpb24gc2V0QXR0ZW1wdEh5ZHJhdGlvbkF0UHJpb3JpdHkoZm4pIHsKICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdFByaW9yaXR5ID0gZm47CiAgICAgICAgfQogICAgICAgIHZhciBoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0ID0gZmFsc2U7CiAgICAgICAgdmFyIHF1ZXVlZERpc2NyZXRlRXZlbnRzID0gW107CiAgICAgICAgdmFyIHF1ZXVlZEZvY3VzID0gbnVsbDsKICAgICAgICB2YXIgcXVldWVkRHJhZyA9IG51bGw7CiAgICAgICAgdmFyIHF1ZXVlZE1vdXNlID0gbnVsbDsKICAgICAgICB2YXIgcXVldWVkUG9pbnRlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHZhciBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHZhciBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHMgPSBbXTsKICAgICAgICB2YXIgZGlzY3JldGVSZXBsYXlhYmxlRXZlbnRzID0gWwogICAgICAgICAgIm1vdXNlZG93biIsCiAgICAgICAgICAibW91c2V1cCIsCiAgICAgICAgICAidG91Y2hjYW5jZWwiLAogICAgICAgICAgInRvdWNoZW5kIiwKICAgICAgICAgICJ0b3VjaHN0YXJ0IiwKICAgICAgICAgICJhdXhjbGljayIsCiAgICAgICAgICAiZGJsY2xpY2siLAogICAgICAgICAgInBvaW50ZXJjYW5jZWwiLAogICAgICAgICAgInBvaW50ZXJkb3duIiwKICAgICAgICAgICJwb2ludGVydXAiLAogICAgICAgICAgImRyYWdlbmQiLAogICAgICAgICAgImRyYWdzdGFydCIsCiAgICAgICAgICAiZHJvcCIsCiAgICAgICAgICAiY29tcG9zaXRpb25lbmQiLAogICAgICAgICAgImNvbXBvc2l0aW9uc3RhcnQiLAogICAgICAgICAgImtleWRvd24iLAogICAgICAgICAgImtleXByZXNzIiwKICAgICAgICAgICJrZXl1cCIsCiAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgInRleHRJbnB1dCIsCiAgICAgICAgICAvLyBJbnRlbnRpb25hbGx5IGNhbWVsQ2FzZQogICAgICAgICAgImNvcHkiLAogICAgICAgICAgImN1dCIsCiAgICAgICAgICAicGFzdGUiLAogICAgICAgICAgImNsaWNrIiwKICAgICAgICAgICJjaGFuZ2UiLAogICAgICAgICAgImNvbnRleHRtZW51IiwKICAgICAgICAgICJyZXNldCIsCiAgICAgICAgICAic3VibWl0IgogICAgICAgIF07CiAgICAgICAgZnVuY3Rpb24gaXNEaXNjcmV0ZUV2ZW50VGhhdFJlcXVpcmVzSHlkcmF0aW9uKGV2ZW50VHlwZSkgewogICAgICAgICAgcmV0dXJuIGRpc2NyZXRlUmVwbGF5YWJsZUV2ZW50cy5pbmRleE9mKGV2ZW50VHlwZSkgPiAtMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUXVldWVkUmVwbGF5YWJsZUV2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBibG9ja2VkT24sCiAgICAgICAgICAgIGRvbUV2ZW50TmFtZSwKICAgICAgICAgICAgZXZlbnRTeXN0ZW1GbGFncywKICAgICAgICAgICAgbmF0aXZlRXZlbnQsCiAgICAgICAgICAgIHRhcmdldENvbnRhaW5lcnM6IFt0YXJnZXRDb250YWluZXJdCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhcklmQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHN3aXRjaCAoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgICAgcXVldWVkRm9jdXMgPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOgogICAgICAgICAgICBjYXNlICJkcmFnbGVhdmUiOgogICAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJtb3VzZW92ZXIiOgogICAgICAgICAgICBjYXNlICJtb3VzZW91dCI6CiAgICAgICAgICAgICAgcXVldWVkTW91c2UgPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdXQiOiB7CiAgICAgICAgICAgICAgdmFyIHBvaW50ZXJJZCA9IG5hdGl2ZUV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVycy5kZWxldGUocG9pbnRlcklkKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJnb3Rwb2ludGVyY2FwdHVyZSI6CiAgICAgICAgICAgIGNhc2UgImxvc3Rwb2ludGVyY2FwdHVyZSI6IHsKICAgICAgICAgICAgICB2YXIgX3BvaW50ZXJJZCA9IG5hdGl2ZUV2ZW50LnBvaW50ZXJJZDsKICAgICAgICAgICAgICBxdWV1ZWRQb2ludGVyQ2FwdHVyZXMuZGVsZXRlKF9wb2ludGVySWQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQoZXhpc3RpbmdRdWV1ZWRFdmVudCwgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChleGlzdGluZ1F1ZXVlZEV2ZW50ID09PSBudWxsIHx8IGV4aXN0aW5nUXVldWVkRXZlbnQubmF0aXZlRXZlbnQgIT09IG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICAgIHZhciBxdWV1ZWRFdmVudCA9IGNyZWF0ZVF1ZXVlZFJlcGxheWFibGVFdmVudChibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIGlmIChibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgX2ZpYmVyMiA9IGdldEluc3RhbmNlRnJvbU5vZGUoYmxvY2tlZE9uKTsKICAgICAgICAgICAgICBpZiAoX2ZpYmVyMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24oX2ZpYmVyMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBxdWV1ZWRFdmVudDsKICAgICAgICAgIH0KICAgICAgICAgIGV4aXN0aW5nUXVldWVkRXZlbnQuZXZlbnRTeXN0ZW1GbGFncyB8PSBldmVudFN5c3RlbUZsYWdzOwogICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lcnMgPSBleGlzdGluZ1F1ZXVlZEV2ZW50LnRhcmdldENvbnRhaW5lcnM7CiAgICAgICAgICBpZiAodGFyZ2V0Q29udGFpbmVyICE9PSBudWxsICYmIHRhcmdldENvbnRhaW5lcnMuaW5kZXhPZih0YXJnZXRDb250YWluZXIpID09PSAtMSkgewogICAgICAgICAgICB0YXJnZXRDb250YWluZXJzLnB1c2godGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleGlzdGluZ1F1ZXVlZEV2ZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZUlmQ29udGludW91c0V2ZW50KGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJmb2N1c2luIjogewogICAgICAgICAgICAgIHZhciBmb2N1c0V2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgcXVldWVkRm9jdXMgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZEZvY3VzLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBmb2N1c0V2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJkcmFnZW50ZXIiOiB7CiAgICAgICAgICAgICAgdmFyIGRyYWdFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIHF1ZXVlZERyYWcgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZERyYWcsIGJsb2NrZWRPbiwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIGRyYWdFdmVudCk7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjogewogICAgICAgICAgICAgIHZhciBtb3VzZUV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgcXVldWVkTW91c2UgPSBhY2N1bXVsYXRlT3JDcmVhdGVDb250aW51b3VzUXVldWVkUmVwbGF5YWJsZUV2ZW50KHF1ZXVlZE1vdXNlLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBtb3VzZUV2ZW50KTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJwb2ludGVyb3ZlciI6IHsKICAgICAgICAgICAgICB2YXIgcG9pbnRlckV2ZW50ID0gbmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgdmFyIHBvaW50ZXJJZCA9IHBvaW50ZXJFdmVudC5wb2ludGVySWQ7CiAgICAgICAgICAgICAgcXVldWVkUG9pbnRlcnMuc2V0KHBvaW50ZXJJZCwgYWNjdW11bGF0ZU9yQ3JlYXRlQ29udGludW91c1F1ZXVlZFJlcGxheWFibGVFdmVudChxdWV1ZWRQb2ludGVycy5nZXQocG9pbnRlcklkKSB8fCBudWxsLCBibG9ja2VkT24sIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBwb2ludGVyRXZlbnQpKTsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJnb3Rwb2ludGVyY2FwdHVyZSI6IHsKICAgICAgICAgICAgICB2YXIgX3BvaW50ZXJFdmVudCA9IG5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgIHZhciBfcG9pbnRlcklkMiA9IF9wb2ludGVyRXZlbnQucG9pbnRlcklkOwogICAgICAgICAgICAgIHF1ZXVlZFBvaW50ZXJDYXB0dXJlcy5zZXQoX3BvaW50ZXJJZDIsIGFjY3VtdWxhdGVPckNyZWF0ZUNvbnRpbnVvdXNRdWV1ZWRSZXBsYXlhYmxlRXZlbnQocXVldWVkUG9pbnRlckNhcHR1cmVzLmdldChfcG9pbnRlcklkMikgfHwgbnVsbCwgYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgX3BvaW50ZXJFdmVudCkpOwogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldChxdWV1ZWRUYXJnZXQpIHsKICAgICAgICAgIHZhciB0YXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUocXVldWVkVGFyZ2V0LnRhcmdldCk7CiAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKHRhcmdldEluc3QpOwogICAgICAgICAgICBpZiAobmVhcmVzdE1vdW50ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgdGFnID0gbmVhcmVzdE1vdW50ZWQudGFnOwogICAgICAgICAgICAgIGlmICh0YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRTdXNwZW5zZUluc3RhbmNlRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gaW5zdGFuY2U7CiAgICAgICAgICAgICAgICAgIGF0dGVtcHRIeWRyYXRpb25BdFByaW9yaXR5KHF1ZXVlZFRhcmdldC5wcmlvcml0eSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5KG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIHZhciByb290MyA9IG5lYXJlc3RNb3VudGVkLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChpc1Jvb3REZWh5ZHJhdGVkKHJvb3QzKSkgewogICAgICAgICAgICAgICAgICBxdWV1ZWRUYXJnZXQuYmxvY2tlZE9uID0gZ2V0Q29udGFpbmVyRnJvbUZpYmVyKG5lYXJlc3RNb3VudGVkKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcXVldWVkVGFyZ2V0LmJsb2NrZWRPbiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHF1ZXVlRXhwbGljaXRIeWRyYXRpb25UYXJnZXQodGFyZ2V0KSB7CiAgICAgICAgICB2YXIgdXBkYXRlUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkkMSgpOwogICAgICAgICAgdmFyIHF1ZXVlZFRhcmdldCA9IHsKICAgICAgICAgICAgYmxvY2tlZE9uOiBudWxsLAogICAgICAgICAgICB0YXJnZXQsCiAgICAgICAgICAgIHByaW9yaXR5OiB1cGRhdGVQcmlvcml0eQogICAgICAgICAgfTsKICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgIGZvciAoOyBpIDwgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGlmICghaXNIaWdoZXJFdmVudFByaW9yaXR5KHVwZGF0ZVByaW9yaXR5LCBxdWV1ZWRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldHNbaV0ucHJpb3JpdHkpKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0cy5zcGxpY2UoaSwgMCwgcXVldWVkVGFyZ2V0KTsKICAgICAgICAgIGlmIChpID09PSAwKSB7CiAgICAgICAgICAgIGF0dGVtcHRFeHBsaWNpdEh5ZHJhdGlvblRhcmdldChxdWV1ZWRUYXJnZXQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50KHF1ZXVlZEV2ZW50KSB7CiAgICAgICAgICBpZiAocXVldWVkRXZlbnQuYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0YXJnZXRDb250YWluZXJzID0gcXVldWVkRXZlbnQudGFyZ2V0Q29udGFpbmVyczsKICAgICAgICAgIHdoaWxlICh0YXJnZXRDb250YWluZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIHRhcmdldENvbnRhaW5lciA9IHRhcmdldENvbnRhaW5lcnNbMF07CiAgICAgICAgICAgIHZhciBuZXh0QmxvY2tlZE9uID0gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChxdWV1ZWRFdmVudC5kb21FdmVudE5hbWUsIHF1ZXVlZEV2ZW50LmV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgcXVldWVkRXZlbnQubmF0aXZlRXZlbnQpOwogICAgICAgICAgICBpZiAobmV4dEJsb2NrZWRPbiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBuYXRpdmVFdmVudCA9IHF1ZXVlZEV2ZW50Lm5hdGl2ZUV2ZW50OwogICAgICAgICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50Q2xvbmUgPSBuZXcgbmF0aXZlRXZlbnQuY29uc3RydWN0b3IobmF0aXZlRXZlbnQudHlwZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgICAgc2V0UmVwbGF5aW5nRXZlbnQobmF0aXZlRXZlbnRDbG9uZSk7CiAgICAgICAgICAgICAgICBuYXRpdmVFdmVudC50YXJnZXQuZGlzcGF0Y2hFdmVudChuYXRpdmVFdmVudENsb25lKTsKICAgICAgICAgICAgICAgIHJlc2V0UmVwbGF5aW5nRXZlbnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlcjMgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKG5leHRCbG9ja2VkT24pOwogICAgICAgICAgICAgIGlmIChfZmliZXIzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihfZmliZXIzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcXVldWVkRXZlbnQuYmxvY2tlZE9uID0gbmV4dEJsb2NrZWRPbjsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGFyZ2V0Q29udGFpbmVycy5zaGlmdCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnRJbk1hcChxdWV1ZWRFdmVudCwga2V5LCBtYXAzKSB7CiAgICAgICAgICBpZiAoYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWRFdmVudCkpIHsKICAgICAgICAgICAgbWFwMy5kZWxldGUoa2V5KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVwbGF5VW5ibG9ja2VkRXZlbnRzKCkgewogICAgICAgICAgaGFzU2NoZWR1bGVkUmVwbGF5QXR0ZW1wdCA9IGZhbHNlOwogICAgICAgICAgaWYgKHF1ZXVlZEZvY3VzICE9PSBudWxsICYmIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkRm9jdXMpKSB7CiAgICAgICAgICAgIHF1ZXVlZEZvY3VzID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWREcmFnICE9PSBudWxsICYmIGF0dGVtcHRSZXBsYXlDb250aW51b3VzUXVldWVkRXZlbnQocXVldWVkRHJhZykpIHsKICAgICAgICAgICAgcXVldWVkRHJhZyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkTW91c2UgIT09IG51bGwgJiYgYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudChxdWV1ZWRNb3VzZSkpIHsKICAgICAgICAgICAgcXVldWVkTW91c2UgPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcXVldWVkUG9pbnRlcnMuZm9yRWFjaChhdHRlbXB0UmVwbGF5Q29udGludW91c1F1ZXVlZEV2ZW50SW5NYXApOwogICAgICAgICAgcXVldWVkUG9pbnRlckNhcHR1cmVzLmZvckVhY2goYXR0ZW1wdFJlcGxheUNvbnRpbnVvdXNRdWV1ZWRFdmVudEluTWFwKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZEV2ZW50LCB1bmJsb2NrZWQpIHsKICAgICAgICAgIGlmIChxdWV1ZWRFdmVudC5ibG9ja2VkT24gPT09IHVuYmxvY2tlZCkgewogICAgICAgICAgICBxdWV1ZWRFdmVudC5ibG9ja2VkT24gPSBudWxsOwogICAgICAgICAgICBpZiAoIWhhc1NjaGVkdWxlZFJlcGxheUF0dGVtcHQpIHsKICAgICAgICAgICAgICBoYXNTY2hlZHVsZWRSZXBsYXlBdHRlbXB0ID0gdHJ1ZTsKICAgICAgICAgICAgICBTY2hlZHVsZXIudW5zdGFibGVfc2NoZWR1bGVDYWxsYmFjayhTY2hlZHVsZXIudW5zdGFibGVfTm9ybWFsUHJpb3JpdHksIHJlcGxheVVuYmxvY2tlZEV2ZW50cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlJZkJsb2NrZWRPbih1bmJsb2NrZWQpIHsKICAgICAgICAgIGlmIChxdWV1ZWREaXNjcmV0ZUV2ZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2tJZlVuYmxvY2tlZChxdWV1ZWREaXNjcmV0ZUV2ZW50c1swXSwgdW5ibG9ja2VkKTsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBxdWV1ZWREaXNjcmV0ZUV2ZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBxdWV1ZWRFdmVudCA9IHF1ZXVlZERpc2NyZXRlRXZlbnRzW2ldOwogICAgICAgICAgICAgIGlmIChxdWV1ZWRFdmVudC5ibG9ja2VkT24gPT09IHVuYmxvY2tlZCkgewogICAgICAgICAgICAgICAgcXVldWVkRXZlbnQuYmxvY2tlZE9uID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWRGb2N1cyAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRm9jdXMsIHVuYmxvY2tlZCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocXVldWVkRHJhZyAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkRHJhZywgdW5ibG9ja2VkKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChxdWV1ZWRNb3VzZSAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrSWZVbmJsb2NrZWQocXVldWVkTW91c2UsIHVuYmxvY2tlZCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdW5ibG9jayA9IGZ1bmN0aW9uKHF1ZXVlZEV2ZW50MikgewogICAgICAgICAgICByZXR1cm4gc2NoZWR1bGVDYWxsYmFja0lmVW5ibG9ja2VkKHF1ZXVlZEV2ZW50MiwgdW5ibG9ja2VkKTsKICAgICAgICAgIH07CiAgICAgICAgICBxdWV1ZWRQb2ludGVycy5mb3JFYWNoKHVuYmxvY2spOwogICAgICAgICAgcXVldWVkUG9pbnRlckNhcHR1cmVzLmZvckVhY2godW5ibG9jayk7CiAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICB2YXIgcXVldWVkVGFyZ2V0ID0gcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzW19pXTsKICAgICAgICAgICAgaWYgKHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPT09IHVuYmxvY2tlZCkgewogICAgICAgICAgICAgIHF1ZXVlZFRhcmdldC5ibG9ja2VkT24gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAocXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIG5leHRFeHBsaWNpdFRhcmdldCA9IHF1ZXVlZEV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0c1swXTsKICAgICAgICAgICAgaWYgKG5leHRFeHBsaWNpdFRhcmdldC5ibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBhdHRlbXB0RXhwbGljaXRIeWRyYXRpb25UYXJnZXQobmV4dEV4cGxpY2l0VGFyZ2V0KTsKICAgICAgICAgICAgICBpZiAobmV4dEV4cGxpY2l0VGFyZ2V0LmJsb2NrZWRPbiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcXVldWVkRXhwbGljaXRIeWRyYXRpb25UYXJnZXRzLnNoaWZ0KCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEJhdGNoQ29uZmlnOwogICAgICAgIHZhciBfZW5hYmxlZCA9IHRydWU7CiAgICAgICAgZnVuY3Rpb24gc2V0RW5hYmxlZChlbmFibGVkKSB7CiAgICAgICAgICBfZW5hYmxlZCA9ICEhZW5hYmxlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNFbmFibGVkKCkgewogICAgICAgICAgcmV0dXJuIF9lbmFibGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVFdmVudExpc3RlbmVyV3JhcHBlcldpdGhQcmlvcml0eSh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncykgewogICAgICAgICAgdmFyIGV2ZW50UHJpb3JpdHkgPSBnZXRFdmVudFByaW9yaXR5KGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICB2YXIgbGlzdGVuZXJXcmFwcGVyOwogICAgICAgICAgc3dpdGNoIChldmVudFByaW9yaXR5KSB7CiAgICAgICAgICAgIGNhc2UgRGlzY3JldGVFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgIGxpc3RlbmVyV3JhcHBlciA9IGRpc3BhdGNoRGlzY3JldGVFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDb250aW51b3VzRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICBsaXN0ZW5lcldyYXBwZXIgPSBkaXNwYXRjaENvbnRpbnVvdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBEZWZhdWx0RXZlbnRQcmlvcml0eToKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBsaXN0ZW5lcldyYXBwZXIgPSBkaXNwYXRjaEV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyV3JhcHBlci5iaW5kKG51bGwsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hEaXNjcmV0ZUV2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgY29udGFpbmVyMiwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZy50cmFuc2l0aW9uOwogICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgZGlzcGF0Y2hFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGNvbnRhaW5lcjIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaENvbnRpbnVvdXNFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGNvbnRhaW5lcjIsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbjsKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KENvbnRpbnVvdXNFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgZGlzcGF0Y2hFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGNvbnRhaW5lcjIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWcudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgaWYgKCFfZW5hYmxlZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnRXaXRoRW5hYmxlQ2FwdHVyZVBoYXNlU2VsZWN0aXZlSHlkcmF0aW9uV2l0aG91dERpc2NyZXRlRXZlbnRSZXBsYXkoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hFdmVudFdpdGhFbmFibGVDYXB0dXJlUGhhc2VTZWxlY3RpdmVIeWRyYXRpb25XaXRob3V0RGlzY3JldGVFdmVudFJlcGxheShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHZhciBibG9ja2VkT24gPSBmaW5kSW5zdGFuY2VCbG9ja2luZ0V2ZW50KGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICBpZiAoYmxvY2tlZE9uID09PSBudWxsKSB7CiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnRGb3JQbHVnaW5FdmVudFN5c3RlbShkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIG5hdGl2ZUV2ZW50LCByZXR1cm5fdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKTsKICAgICAgICAgICAgY2xlYXJJZkNvbnRpbnVvdXNFdmVudChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHF1ZXVlSWZDb250aW51b3VzRXZlbnQoYmxvY2tlZE9uLCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIG5hdGl2ZUV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBjbGVhcklmQ29udGludW91c0V2ZW50KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpOwogICAgICAgICAgaWYgKGV2ZW50U3lzdGVtRmxhZ3MgJiBJU19DQVBUVVJFX1BIQVNFICYmIGlzRGlzY3JldGVFdmVudFRoYXRSZXF1aXJlc0h5ZHJhdGlvbihkb21FdmVudE5hbWUpKSB7CiAgICAgICAgICAgIHdoaWxlIChibG9ja2VkT24gIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZmliZXIgPSBnZXRJbnN0YW5jZUZyb21Ob2RlKGJsb2NrZWRPbik7CiAgICAgICAgICAgICAgaWYgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhdHRlbXB0U3luY2hyb25vdXNIeWRyYXRpb24oZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbmV4dEJsb2NrZWRPbiA9IGZpbmRJbnN0YW5jZUJsb2NraW5nRXZlbnQoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgICBpZiAobmV4dEJsb2NrZWRPbiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgZGlzcGF0Y2hFdmVudEZvclBsdWdpbkV2ZW50U3lzdGVtKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIHJldHVybl90YXJnZXRJbnN0LCB0YXJnZXRDb250YWluZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmV4dEJsb2NrZWRPbiA9PT0gYmxvY2tlZE9uKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYmxvY2tlZE9uID0gbmV4dEJsb2NrZWRPbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYmxvY2tlZE9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmF0aXZlRXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgZGlzcGF0Y2hFdmVudEZvclBsdWdpbkV2ZW50U3lzdGVtKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIG51bGwsIHRhcmdldENvbnRhaW5lcik7CiAgICAgICAgfQogICAgICAgIHZhciByZXR1cm5fdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gZmluZEluc3RhbmNlQmxvY2tpbmdFdmVudChkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIHRhcmdldENvbnRhaW5lciwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybl90YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgIHZhciBuYXRpdmVFdmVudFRhcmdldCA9IGdldEV2ZW50VGFyZ2V0KG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIHZhciB0YXJnZXRJbnN0ID0gZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgaWYgKHRhcmdldEluc3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIG5lYXJlc3RNb3VudGVkID0gZ2V0TmVhcmVzdE1vdW50ZWRGaWJlcih0YXJnZXRJbnN0KTsKICAgICAgICAgICAgaWYgKG5lYXJlc3RNb3VudGVkID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIHRhZyA9IG5lYXJlc3RNb3VudGVkLnRhZzsKICAgICAgICAgICAgICBpZiAodGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0U3VzcGVuc2VJbnN0YW5jZUZyb21GaWJlcihuZWFyZXN0TW91bnRlZCk7CiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFyZ2V0SW5zdCA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBuZWFyZXN0TW91bnRlZC5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAoaXNSb290RGVoeWRyYXRlZChyb290MykpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRhaW5lckZyb21GaWJlcihuZWFyZXN0TW91bnRlZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5lYXJlc3RNb3VudGVkICE9PSB0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgICAgICB0YXJnZXRJbnN0ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybl90YXJnZXRJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudFByaW9yaXR5KGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiY2FuY2VsIjoKICAgICAgICAgICAgY2FzZSAiY2xpY2siOgogICAgICAgICAgICBjYXNlICJjbG9zZSI6CiAgICAgICAgICAgIGNhc2UgImNvbnRleHRtZW51IjoKICAgICAgICAgICAgY2FzZSAiY29weSI6CiAgICAgICAgICAgIGNhc2UgImN1dCI6CiAgICAgICAgICAgIGNhc2UgImF1eGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAiZGJsY2xpY2siOgogICAgICAgICAgICBjYXNlICJkcmFnZW5kIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ3N0YXJ0IjoKICAgICAgICAgICAgY2FzZSAiZHJvcCI6CiAgICAgICAgICAgIGNhc2UgImZvY3VzaW4iOgogICAgICAgICAgICBjYXNlICJmb2N1c291dCI6CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgY2FzZSAiaW52YWxpZCI6CiAgICAgICAgICAgIGNhc2UgImtleWRvd24iOgogICAgICAgICAgICBjYXNlICJrZXlwcmVzcyI6CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgY2FzZSAibW91c2V1cCI6CiAgICAgICAgICAgIGNhc2UgInBhc3RlIjoKICAgICAgICAgICAgY2FzZSAicGF1c2UiOgogICAgICAgICAgICBjYXNlICJwbGF5IjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJkb3duIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcnVwIjoKICAgICAgICAgICAgY2FzZSAicmF0ZWNoYW5nZSI6CiAgICAgICAgICAgIGNhc2UgInJlc2V0IjoKICAgICAgICAgICAgY2FzZSAicmVzaXplIjoKICAgICAgICAgICAgY2FzZSAic2Vla2VkIjoKICAgICAgICAgICAgY2FzZSAic3VibWl0IjoKICAgICAgICAgICAgY2FzZSAidG91Y2hjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJ0b3VjaGVuZCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoc3RhcnQiOgogICAgICAgICAgICBjYXNlICJ2b2x1bWVjaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJjaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJzZWxlY3Rpb25jaGFuZ2UiOgogICAgICAgICAgICBjYXNlICJ0ZXh0SW5wdXQiOgogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbnN0YXJ0IjoKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25lbmQiOgogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbnVwZGF0ZSI6CiAgICAgICAgICAgIGNhc2UgImJlZm9yZWJsdXIiOgogICAgICAgICAgICBjYXNlICJhZnRlcmJsdXIiOgogICAgICAgICAgICBjYXNlICJiZWZvcmVpbnB1dCI6CiAgICAgICAgICAgIGNhc2UgImJsdXIiOgogICAgICAgICAgICBjYXNlICJmdWxsc2NyZWVuY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAiZm9jdXMiOgogICAgICAgICAgICBjYXNlICJoYXNoY2hhbmdlIjoKICAgICAgICAgICAgY2FzZSAicG9wc3RhdGUiOgogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICBjYXNlICJzZWxlY3RzdGFydCI6CiAgICAgICAgICAgICAgcmV0dXJuIERpc2NyZXRlRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgY2FzZSAiZHJhZyI6CiAgICAgICAgICAgIGNhc2UgImRyYWdlbnRlciI6CiAgICAgICAgICAgIGNhc2UgImRyYWdleGl0IjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2xlYXZlIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ292ZXIiOgogICAgICAgICAgICBjYXNlICJtb3VzZW1vdmUiOgogICAgICAgICAgICBjYXNlICJtb3VzZW91dCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3ZlciI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJtb3ZlIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm91dCI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJvdmVyIjoKICAgICAgICAgICAgY2FzZSAic2Nyb2xsIjoKICAgICAgICAgICAgY2FzZSAidG9nZ2xlIjoKICAgICAgICAgICAgY2FzZSAidG91Y2htb3ZlIjoKICAgICAgICAgICAgY2FzZSAid2hlZWwiOgogICAgICAgICAgICBjYXNlICJtb3VzZWVudGVyIjoKICAgICAgICAgICAgY2FzZSAibW91c2VsZWF2ZSI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJlbnRlciI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJsZWF2ZSI6CiAgICAgICAgICAgICAgcmV0dXJuIENvbnRpbnVvdXNFdmVudFByaW9yaXR5OwogICAgICAgICAgICBjYXNlICJtZXNzYWdlIjogewogICAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eSA9IGdldEN1cnJlbnRQcmlvcml0eUxldmVsKCk7CiAgICAgICAgICAgICAgc3dpdGNoIChzY2hlZHVsZXJQcmlvcml0eSkgewogICAgICAgICAgICAgICAgY2FzZSBJbW1lZGlhdGVQcmlvcml0eToKICAgICAgICAgICAgICAgICAgcmV0dXJuIERpc2NyZXRlRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICAgIGNhc2UgVXNlckJsb2NraW5nUHJpb3JpdHk6CiAgICAgICAgICAgICAgICAgIHJldHVybiBDb250aW51b3VzRXZlbnRQcmlvcml0eTsKICAgICAgICAgICAgICAgIGNhc2UgTm9ybWFsUHJpb3JpdHk6CiAgICAgICAgICAgICAgICBjYXNlIExvd1ByaW9yaXR5OgogICAgICAgICAgICAgICAgICByZXR1cm4gRGVmYXVsdEV2ZW50UHJpb3JpdHk7CiAgICAgICAgICAgICAgICBjYXNlIElkbGVQcmlvcml0eToKICAgICAgICAgICAgICAgICAgcmV0dXJuIElkbGVFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBEZWZhdWx0RXZlbnRQcmlvcml0eTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRXZlbnRCdWJibGVMaXN0ZW5lcih0YXJnZXQsIGV2ZW50VHlwZSwgbGlzdGVuZXIyKSB7CiAgICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGUsIGxpc3RlbmVyMiwgZmFsc2UpOwogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXIodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyMikgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lcjIsIHRydWUpOwogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0LCBldmVudFR5cGUsIGxpc3RlbmVyMiwgcGFzc2l2ZSkgewogICAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlLCBsaXN0ZW5lcjIsIHsKICAgICAgICAgICAgY2FwdHVyZTogdHJ1ZSwKICAgICAgICAgICAgcGFzc2l2ZQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gbGlzdGVuZXIyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRFdmVudEJ1YmJsZUxpc3RlbmVyV2l0aFBhc3NpdmVGbGFnKHRhcmdldCwgZXZlbnRUeXBlLCBsaXN0ZW5lcjIsIHBhc3NpdmUpIHsKICAgICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKGV2ZW50VHlwZSwgbGlzdGVuZXIyLCB7CiAgICAgICAgICAgIHBhc3NpdmUKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyMjsKICAgICAgICB9CiAgICAgICAgdmFyIHJvb3QyID0gbnVsbDsKICAgICAgICB2YXIgc3RhcnRUZXh0ID0gbnVsbDsKICAgICAgICB2YXIgZmFsbGJhY2tUZXh0ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBpbml0aWFsaXplKG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICByb290MiA9IG5hdGl2ZUV2ZW50VGFyZ2V0OwogICAgICAgICAgc3RhcnRUZXh0ID0gZ2V0VGV4dCgpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICAgICAgcm9vdDIgPSBudWxsOwogICAgICAgICAgc3RhcnRUZXh0ID0gbnVsbDsKICAgICAgICAgIGZhbGxiYWNrVGV4dCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERhdGEoKSB7CiAgICAgICAgICBpZiAoZmFsbGJhY2tUZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBmYWxsYmFja1RleHQ7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhcnQ7CiAgICAgICAgICB2YXIgc3RhcnRWYWx1ZSA9IHN0YXJ0VGV4dDsKICAgICAgICAgIHZhciBzdGFydExlbmd0aCA9IHN0YXJ0VmFsdWUubGVuZ3RoOwogICAgICAgICAgdmFyIGVuZDsKICAgICAgICAgIHZhciBlbmRWYWx1ZSA9IGdldFRleHQoKTsKICAgICAgICAgIHZhciBlbmRMZW5ndGggPSBlbmRWYWx1ZS5sZW5ndGg7CiAgICAgICAgICBmb3IgKHN0YXJ0ID0gMDsgc3RhcnQgPCBzdGFydExlbmd0aDsgc3RhcnQrKykgewogICAgICAgICAgICBpZiAoc3RhcnRWYWx1ZVtzdGFydF0gIT09IGVuZFZhbHVlW3N0YXJ0XSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWluRW5kID0gc3RhcnRMZW5ndGggLSBzdGFydDsKICAgICAgICAgIGZvciAoZW5kID0gMTsgZW5kIDw9IG1pbkVuZDsgZW5kKyspIHsKICAgICAgICAgICAgaWYgKHN0YXJ0VmFsdWVbc3RhcnRMZW5ndGggLSBlbmRdICE9PSBlbmRWYWx1ZVtlbmRMZW5ndGggLSBlbmRdKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBzbGljZVRhaWwgPSBlbmQgPiAxID8gMSAtIGVuZCA6IHZvaWQgMDsKICAgICAgICAgIGZhbGxiYWNrVGV4dCA9IGVuZFZhbHVlLnNsaWNlKHN0YXJ0LCBzbGljZVRhaWwpOwogICAgICAgICAgcmV0dXJuIGZhbGxiYWNrVGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGV4dCgpIHsKICAgICAgICAgIGlmICgidmFsdWUiIGluIHJvb3QyKSB7CiAgICAgICAgICAgIHJldHVybiByb290Mi52YWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByb290Mi50ZXh0Q29udGVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRDaGFyQ29kZShuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGNoYXJDb2RlOwogICAgICAgICAgdmFyIGtleUNvZGUgPSBuYXRpdmVFdmVudC5rZXlDb2RlOwogICAgICAgICAgaWYgKCJjaGFyQ29kZSIgaW4gbmF0aXZlRXZlbnQpIHsKICAgICAgICAgICAgY2hhckNvZGUgPSBuYXRpdmVFdmVudC5jaGFyQ29kZTsKICAgICAgICAgICAgaWYgKGNoYXJDb2RlID09PSAwICYmIGtleUNvZGUgPT09IDEzKSB7CiAgICAgICAgICAgICAgY2hhckNvZGUgPSAxMzsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY2hhckNvZGUgPSBrZXlDb2RlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNoYXJDb2RlID09PSAxMCkgewogICAgICAgICAgICBjaGFyQ29kZSA9IDEzOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNoYXJDb2RlID49IDMyIHx8IGNoYXJDb2RlID09PSAxMykgewogICAgICAgICAgICByZXR1cm4gY2hhckNvZGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWUoKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZnVuY3Rpb25UaGF0UmV0dXJuc0ZhbHNlKCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVTeW50aGV0aWNFdmVudChJbnRlcmZhY2UpIHsKICAgICAgICAgIGZ1bmN0aW9uIFN5bnRoZXRpY0Jhc2VFdmVudChyZWFjdE5hbWUsIHJlYWN0RXZlbnRUeXBlLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgICAgdGhpcy5fcmVhY3ROYW1lID0gcmVhY3ROYW1lOwogICAgICAgICAgICB0aGlzLl90YXJnZXRJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgdGhpcy50eXBlID0gcmVhY3RFdmVudFR5cGU7CiAgICAgICAgICAgIHRoaXMubmF0aXZlRXZlbnQgPSBuYXRpdmVFdmVudDsKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSBuYXRpdmVFdmVudFRhcmdldDsKICAgICAgICAgICAgdGhpcy5jdXJyZW50VGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgZm9yICh2YXIgX3Byb3BOYW1lIGluIEludGVyZmFjZSkgewogICAgICAgICAgICAgIGlmICghSW50ZXJmYWNlLmhhc093blByb3BlcnR5KF9wcm9wTmFtZSkpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgbm9ybWFsaXplMiA9IEludGVyZmFjZVtfcHJvcE5hbWVdOwogICAgICAgICAgICAgIGlmIChub3JtYWxpemUyKSB7CiAgICAgICAgICAgICAgICB0aGlzW19wcm9wTmFtZV0gPSBub3JtYWxpemUyKG5hdGl2ZUV2ZW50KTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpc1tfcHJvcE5hbWVdID0gbmF0aXZlRXZlbnRbX3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRlZmF1bHRQcmV2ZW50ZWQgPSBuYXRpdmVFdmVudC5kZWZhdWx0UHJldmVudGVkICE9IG51bGwgPyBuYXRpdmVFdmVudC5kZWZhdWx0UHJldmVudGVkIDogbmF0aXZlRXZlbnQucmV0dXJuVmFsdWUgPT09IGZhbHNlOwogICAgICAgICAgICBpZiAoZGVmYXVsdFByZXZlbnRlZCkgewogICAgICAgICAgICAgIHRoaXMuaXNEZWZhdWx0UHJldmVudGVkID0gZnVuY3Rpb25UaGF0UmV0dXJuc1RydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBmdW5jdGlvblRoYXRSZXR1cm5zRmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNGYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgICBhc3NpZ24yKFN5bnRoZXRpY0Jhc2VFdmVudC5wcm90b3R5cGUsIHsKICAgICAgICAgICAgcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRoaXMuZGVmYXVsdFByZXZlbnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIGV2ZW50ID0gdGhpcy5uYXRpdmVFdmVudDsKICAgICAgICAgICAgICBpZiAoIWV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChldmVudC5wcmV2ZW50RGVmYXVsdCkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBldmVudC5yZXR1cm5WYWx1ZSAhPT0gInVua25vd24iKSB7CiAgICAgICAgICAgICAgICBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aGlzLmlzRGVmYXVsdFByZXZlbnRlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHZhciBldmVudCA9IHRoaXMubmF0aXZlRXZlbnQ7CiAgICAgICAgICAgICAgaWYgKCFldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSB7CiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBldmVudC5jYW5jZWxCdWJibGUgIT09ICJ1bmtub3duIikgewogICAgICAgICAgICAgICAgZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IGZ1bmN0aW9uVGhhdFJldHVybnNUcnVlOwogICAgICAgICAgICB9LAogICAgICAgICAgICAvKioKICAgICAgICAgICAgICogV2UgcmVsZWFzZSBhbGwgZGlzcGF0Y2hlZCBgU3ludGhldGljRXZlbnRgcyBhZnRlciBlYWNoIGV2ZW50IGxvb3AsIGFkZGluZwogICAgICAgICAgICAgKiB0aGVtIGJhY2sgaW50byB0aGUgcG9vbC4gVGhpcyBhbGxvd3MgYSB3YXkgdG8gaG9sZCBvbnRvIGEgcmVmZXJlbmNlIHRoYXQKICAgICAgICAgICAgICogd29uJ3QgYmUgYWRkZWQgYmFjayBpbnRvIHRoZSBwb29sLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgcGVyc2lzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8qKgogICAgICAgICAgICAgKiBDaGVja3MgaWYgdGhpcyBldmVudCBzaG91bGQgYmUgcmVsZWFzZWQgYmFjayBpbnRvIHRoZSBwb29sLgogICAgICAgICAgICAgKgogICAgICAgICAgICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoaXMgc2hvdWxkIG5vdCBiZSByZWxlYXNlZCwgZmFsc2Ugb3RoZXJ3aXNlLgogICAgICAgICAgICAgKi8KICAgICAgICAgICAgaXNQZXJzaXN0ZW50OiBmdW5jdGlvblRoYXRSZXR1cm5zVHJ1ZQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gU3ludGhldGljQmFzZUV2ZW50OwogICAgICAgIH0KICAgICAgICB2YXIgRXZlbnRJbnRlcmZhY2UgPSB7CiAgICAgICAgICBldmVudFBoYXNlOiAwLAogICAgICAgICAgYnViYmxlczogMCwKICAgICAgICAgIGNhbmNlbGFibGU6IDAsCiAgICAgICAgICB0aW1lU3RhbXA6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBldmVudC50aW1lU3RhbXAgfHwgRGF0ZS5ub3coKTsKICAgICAgICAgIH0sCiAgICAgICAgICBkZWZhdWx0UHJldmVudGVkOiAwLAogICAgICAgICAgaXNUcnVzdGVkOiAwCiAgICAgICAgfTsKICAgICAgICB2YXIgU3ludGhldGljRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFVJRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBFdmVudEludGVyZmFjZSwgewogICAgICAgICAgdmlldzogMCwKICAgICAgICAgIGRldGFpbDogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNVSUV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoVUlFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIGxhc3RNb3ZlbWVudFg7CiAgICAgICAgdmFyIGxhc3RNb3ZlbWVudFk7CiAgICAgICAgdmFyIGxhc3RNb3VzZUV2ZW50OwogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1vdXNlTW92ZW1lbnRQb2x5ZmlsbFN0YXRlKGV2ZW50KSB7CiAgICAgICAgICBpZiAoZXZlbnQgIT09IGxhc3RNb3VzZUV2ZW50KSB7CiAgICAgICAgICAgIGlmIChsYXN0TW91c2VFdmVudCAmJiBldmVudC50eXBlID09PSAibW91c2Vtb3ZlIikgewogICAgICAgICAgICAgIGxhc3RNb3ZlbWVudFggPSBldmVudC5zY3JlZW5YIC0gbGFzdE1vdXNlRXZlbnQuc2NyZWVuWDsKICAgICAgICAgICAgICBsYXN0TW92ZW1lbnRZID0gZXZlbnQuc2NyZWVuWSAtIGxhc3RNb3VzZUV2ZW50LnNjcmVlblk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbGFzdE1vdmVtZW50WCA9IDA7CiAgICAgICAgICAgICAgbGFzdE1vdmVtZW50WSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdE1vdXNlRXZlbnQgPSBldmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIE1vdXNlRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBVSUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBzY3JlZW5YOiAwLAogICAgICAgICAgc2NyZWVuWTogMCwKICAgICAgICAgIGNsaWVudFg6IDAsCiAgICAgICAgICBjbGllbnRZOiAwLAogICAgICAgICAgcGFnZVg6IDAsCiAgICAgICAgICBwYWdlWTogMCwKICAgICAgICAgIGN0cmxLZXk6IDAsCiAgICAgICAgICBzaGlmdEtleTogMCwKICAgICAgICAgIGFsdEtleTogMCwKICAgICAgICAgIG1ldGFLZXk6IDAsCiAgICAgICAgICBnZXRNb2RpZmllclN0YXRlOiBnZXRFdmVudE1vZGlmaWVyU3RhdGUsCiAgICAgICAgICBidXR0b246IDAsCiAgICAgICAgICBidXR0b25zOiAwLAogICAgICAgICAgcmVsYXRlZFRhcmdldDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnJlbGF0ZWRUYXJnZXQgPT09IHZvaWQgMCkgcmV0dXJuIGV2ZW50LmZyb21FbGVtZW50ID09PSBldmVudC5zcmNFbGVtZW50ID8gZXZlbnQudG9FbGVtZW50IDogZXZlbnQuZnJvbUVsZW1lbnQ7CiAgICAgICAgICAgIHJldHVybiBldmVudC5yZWxhdGVkVGFyZ2V0OwogICAgICAgICAgfSwKICAgICAgICAgIG1vdmVtZW50WDogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKCJtb3ZlbWVudFgiIGluIGV2ZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50Lm1vdmVtZW50WDsKICAgICAgICAgICAgfQogICAgICAgICAgICB1cGRhdGVNb3VzZU1vdmVtZW50UG9seWZpbGxTdGF0ZShldmVudCk7CiAgICAgICAgICAgIHJldHVybiBsYXN0TW92ZW1lbnRYOwogICAgICAgICAgfSwKICAgICAgICAgIG1vdmVtZW50WTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKCJtb3ZlbWVudFkiIGluIGV2ZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50Lm1vdmVtZW50WTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbGFzdE1vdmVtZW50WTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljTW91c2VFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KE1vdXNlRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBEcmFnRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBNb3VzZUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBkYXRhVHJhbnNmZXI6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljRHJhZ0V2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoRHJhZ0V2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgRm9jdXNFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIFVJRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHJlbGF0ZWRUYXJnZXQ6IDAKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljRm9jdXNFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KEZvY3VzRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBBbmltYXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBhbmltYXRpb25OYW1lOiAwLAogICAgICAgICAgZWxhcHNlZFRpbWU6IDAsCiAgICAgICAgICBwc2V1ZG9FbGVtZW50OiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0FuaW1hdGlvbkV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoQW5pbWF0aW9uRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBDbGlwYm9hcmRFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBjbGlwYm9hcmREYXRhOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gImNsaXBib2FyZERhdGEiIGluIGV2ZW50ID8gZXZlbnQuY2xpcGJvYXJkRGF0YSA6IHdpbmRvdy5jbGlwYm9hcmREYXRhOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNDbGlwYm9hcmRFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KENsaXBib2FyZEV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgQ29tcG9zaXRpb25FdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIEV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBkYXRhOiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY0NvbXBvc2l0aW9uRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChDb21wb3NpdGlvbkV2ZW50SW50ZXJmYWNlKTsKICAgICAgICB2YXIgU3ludGhldGljSW5wdXRFdmVudCA9IFN5bnRoZXRpY0NvbXBvc2l0aW9uRXZlbnQ7CiAgICAgICAgdmFyIG5vcm1hbGl6ZUtleSA9IHsKICAgICAgICAgIEVzYzogIkVzY2FwZSIsCiAgICAgICAgICBTcGFjZWJhcjogIiAiLAogICAgICAgICAgTGVmdDogIkFycm93TGVmdCIsCiAgICAgICAgICBVcDogIkFycm93VXAiLAogICAgICAgICAgUmlnaHQ6ICJBcnJvd1JpZ2h0IiwKICAgICAgICAgIERvd246ICJBcnJvd0Rvd24iLAogICAgICAgICAgRGVsOiAiRGVsZXRlIiwKICAgICAgICAgIFdpbjogIk9TIiwKICAgICAgICAgIE1lbnU6ICJDb250ZXh0TWVudSIsCiAgICAgICAgICBBcHBzOiAiQ29udGV4dE1lbnUiLAogICAgICAgICAgU2Nyb2xsOiAiU2Nyb2xsTG9jayIsCiAgICAgICAgICBNb3pQcmludGFibGVLZXk6ICJVbmlkZW50aWZpZWQiCiAgICAgICAgfTsKICAgICAgICB2YXIgdHJhbnNsYXRlVG9LZXkgPSB7CiAgICAgICAgICAiOCI6ICJCYWNrc3BhY2UiLAogICAgICAgICAgIjkiOiAiVGFiIiwKICAgICAgICAgICIxMiI6ICJDbGVhciIsCiAgICAgICAgICAiMTMiOiAiRW50ZXIiLAogICAgICAgICAgIjE2IjogIlNoaWZ0IiwKICAgICAgICAgICIxNyI6ICJDb250cm9sIiwKICAgICAgICAgICIxOCI6ICJBbHQiLAogICAgICAgICAgIjE5IjogIlBhdXNlIiwKICAgICAgICAgICIyMCI6ICJDYXBzTG9jayIsCiAgICAgICAgICAiMjciOiAiRXNjYXBlIiwKICAgICAgICAgICIzMiI6ICIgIiwKICAgICAgICAgICIzMyI6ICJQYWdlVXAiLAogICAgICAgICAgIjM0IjogIlBhZ2VEb3duIiwKICAgICAgICAgICIzNSI6ICJFbmQiLAogICAgICAgICAgIjM2IjogIkhvbWUiLAogICAgICAgICAgIjM3IjogIkFycm93TGVmdCIsCiAgICAgICAgICAiMzgiOiAiQXJyb3dVcCIsCiAgICAgICAgICAiMzkiOiAiQXJyb3dSaWdodCIsCiAgICAgICAgICAiNDAiOiAiQXJyb3dEb3duIiwKICAgICAgICAgICI0NSI6ICJJbnNlcnQiLAogICAgICAgICAgIjQ2IjogIkRlbGV0ZSIsCiAgICAgICAgICAiMTEyIjogIkYxIiwKICAgICAgICAgICIxMTMiOiAiRjIiLAogICAgICAgICAgIjExNCI6ICJGMyIsCiAgICAgICAgICAiMTE1IjogIkY0IiwKICAgICAgICAgICIxMTYiOiAiRjUiLAogICAgICAgICAgIjExNyI6ICJGNiIsCiAgICAgICAgICAiMTE4IjogIkY3IiwKICAgICAgICAgICIxMTkiOiAiRjgiLAogICAgICAgICAgIjEyMCI6ICJGOSIsCiAgICAgICAgICAiMTIxIjogIkYxMCIsCiAgICAgICAgICAiMTIyIjogIkYxMSIsCiAgICAgICAgICAiMTIzIjogIkYxMiIsCiAgICAgICAgICAiMTQ0IjogIk51bUxvY2siLAogICAgICAgICAgIjE0NSI6ICJTY3JvbGxMb2NrIiwKICAgICAgICAgICIyMjQiOiAiTWV0YSIKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50S2V5KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBpZiAobmF0aXZlRXZlbnQua2V5KSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBub3JtYWxpemVLZXlbbmF0aXZlRXZlbnQua2V5XSB8fCBuYXRpdmVFdmVudC5rZXk7CiAgICAgICAgICAgIGlmIChrZXkgIT09ICJVbmlkZW50aWZpZWQiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKG5hdGl2ZUV2ZW50LnR5cGUgPT09ICJrZXlwcmVzcyIpIHsKICAgICAgICAgICAgdmFyIGNoYXJDb2RlID0gZ2V0RXZlbnRDaGFyQ29kZShuYXRpdmVFdmVudCk7CiAgICAgICAgICAgIHJldHVybiBjaGFyQ29kZSA9PT0gMTMgPyAiRW50ZXIiIDogU3RyaW5nLmZyb21DaGFyQ29kZShjaGFyQ29kZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmF0aXZlRXZlbnQudHlwZSA9PT0gImtleWRvd24iIHx8IG5hdGl2ZUV2ZW50LnR5cGUgPT09ICJrZXl1cCIpIHsKICAgICAgICAgICAgcmV0dXJuIHRyYW5zbGF0ZVRvS2V5W25hdGl2ZUV2ZW50LmtleUNvZGVdIHx8ICJVbmlkZW50aWZpZWQiOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICB2YXIgbW9kaWZpZXJLZXlUb1Byb3AgPSB7CiAgICAgICAgICBBbHQ6ICJhbHRLZXkiLAogICAgICAgICAgQ29udHJvbDogImN0cmxLZXkiLAogICAgICAgICAgTWV0YTogIm1ldGFLZXkiLAogICAgICAgICAgU2hpZnQ6ICJzaGlmdEtleSIKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIG1vZGlmaWVyU3RhdGVHZXR0ZXIoa2V5QXJnKSB7CiAgICAgICAgICB2YXIgc3ludGhldGljRXZlbnQgPSB0aGlzOwogICAgICAgICAgdmFyIG5hdGl2ZUV2ZW50ID0gc3ludGhldGljRXZlbnQubmF0aXZlRXZlbnQ7CiAgICAgICAgICBpZiAobmF0aXZlRXZlbnQuZ2V0TW9kaWZpZXJTdGF0ZSkgewogICAgICAgICAgICByZXR1cm4gbmF0aXZlRXZlbnQuZ2V0TW9kaWZpZXJTdGF0ZShrZXlBcmcpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGtleVByb3AgPSBtb2RpZmllcktleVRvUHJvcFtrZXlBcmddOwogICAgICAgICAgcmV0dXJuIGtleVByb3AgPyAhIW5hdGl2ZUV2ZW50W2tleVByb3BdIDogZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEV2ZW50TW9kaWZpZXJTdGF0ZShuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuIG1vZGlmaWVyU3RhdGVHZXR0ZXI7CiAgICAgICAgfQogICAgICAgIHZhciBLZXlib2FyZEV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAga2V5OiBnZXRFdmVudEtleSwKICAgICAgICAgIGNvZGU6IDAsCiAgICAgICAgICBsb2NhdGlvbjogMCwKICAgICAgICAgIGN0cmxLZXk6IDAsCiAgICAgICAgICBzaGlmdEtleTogMCwKICAgICAgICAgIGFsdEtleTogMCwKICAgICAgICAgIG1ldGFLZXk6IDAsCiAgICAgICAgICByZXBlYXQ6IDAsCiAgICAgICAgICBsb2NhbGU6IDAsCiAgICAgICAgICBnZXRNb2RpZmllclN0YXRlOiBnZXRFdmVudE1vZGlmaWVyU3RhdGUsCiAgICAgICAgICAvLyBMZWdhY3kgSW50ZXJmYWNlCiAgICAgICAgICBjaGFyQ29kZTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlwcmVzcyIpIHsKICAgICAgICAgICAgICByZXR1cm4gZ2V0RXZlbnRDaGFyQ29kZShldmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9LAogICAgICAgICAga2V5Q29kZTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICJrZXlkb3duIiB8fCBldmVudC50eXBlID09PSAia2V5dXAiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmtleUNvZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9LAogICAgICAgICAgd2hpY2g6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAia2V5cHJlc3MiKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldEV2ZW50Q2hhckNvZGUoZXZlbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAia2V5ZG93biIgfHwgZXZlbnQudHlwZSA9PT0gImtleXVwIikgewogICAgICAgICAgICAgIHJldHVybiBldmVudC5rZXlDb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNLZXlib2FyZEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoS2V5Ym9hcmRFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFBvaW50ZXJFdmVudEludGVyZmFjZSA9IGFzc2lnbjIoe30sIE1vdXNlRXZlbnRJbnRlcmZhY2UsIHsKICAgICAgICAgIHBvaW50ZXJJZDogMCwKICAgICAgICAgIHdpZHRoOiAwLAogICAgICAgICAgaGVpZ2h0OiAwLAogICAgICAgICAgcHJlc3N1cmU6IDAsCiAgICAgICAgICB0YW5nZW50aWFsUHJlc3N1cmU6IDAsCiAgICAgICAgICB0aWx0WDogMCwKICAgICAgICAgIHRpbHRZOiAwLAogICAgICAgICAgdHdpc3Q6IDAsCiAgICAgICAgICBwb2ludGVyVHlwZTogMCwKICAgICAgICAgIGlzUHJpbWFyeTogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNQb2ludGVyRXZlbnQgPSBjcmVhdGVTeW50aGV0aWNFdmVudChQb2ludGVyRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBUb3VjaEV2ZW50SW50ZXJmYWNlID0gYXNzaWduMih7fSwgVUlFdmVudEludGVyZmFjZSwgewogICAgICAgICAgdG91Y2hlczogMCwKICAgICAgICAgIHRhcmdldFRvdWNoZXM6IDAsCiAgICAgICAgICBjaGFuZ2VkVG91Y2hlczogMCwKICAgICAgICAgIGFsdEtleTogMCwKICAgICAgICAgIG1ldGFLZXk6IDAsCiAgICAgICAgICBjdHJsS2V5OiAwLAogICAgICAgICAgc2hpZnRLZXk6IDAsCiAgICAgICAgICBnZXRNb2RpZmllclN0YXRlOiBnZXRFdmVudE1vZGlmaWVyU3RhdGUKICAgICAgICB9KTsKICAgICAgICB2YXIgU3ludGhldGljVG91Y2hFdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFRvdWNoRXZlbnRJbnRlcmZhY2UpOwogICAgICAgIHZhciBUcmFuc2l0aW9uRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBFdmVudEludGVyZmFjZSwgewogICAgICAgICAgcHJvcGVydHlOYW1lOiAwLAogICAgICAgICAgZWxhcHNlZFRpbWU6IDAsCiAgICAgICAgICBwc2V1ZG9FbGVtZW50OiAwCiAgICAgICAgfSk7CiAgICAgICAgdmFyIFN5bnRoZXRpY1RyYW5zaXRpb25FdmVudCA9IGNyZWF0ZVN5bnRoZXRpY0V2ZW50KFRyYW5zaXRpb25FdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIFdoZWVsRXZlbnRJbnRlcmZhY2UgPSBhc3NpZ24yKHt9LCBNb3VzZUV2ZW50SW50ZXJmYWNlLCB7CiAgICAgICAgICBkZWx0YVg6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiAiZGVsdGFYIiBpbiBldmVudCA/IGV2ZW50LmRlbHRhWCA6ICgKICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YVhgIGZvciBXZWJraXQgYW5kIG5vcm1hbGl6ZSAocmlnaHQgaXMgcG9zaXRpdmUpLgogICAgICAgICAgICAgICJ3aGVlbERlbHRhWCIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YVggOiAwCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVsdGFZOiBmdW5jdGlvbihldmVudCkgewogICAgICAgICAgICByZXR1cm4gImRlbHRhWSIgaW4gZXZlbnQgPyBldmVudC5kZWx0YVkgOiAoCiAgICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gYHdoZWVsRGVsdGFZYCBmb3IgV2Via2l0IGFuZCBub3JtYWxpemUgKGRvd24gaXMgcG9zaXRpdmUpLgogICAgICAgICAgICAgICJ3aGVlbERlbHRhWSIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YVkgOiAoCiAgICAgICAgICAgICAgICAvLyBGYWxsYmFjayB0byBgd2hlZWxEZWx0YWAgZm9yIElFPDkgYW5kIG5vcm1hbGl6ZSAoZG93biBpcyBwb3NpdGl2ZSkuCiAgICAgICAgICAgICAgICAid2hlZWxEZWx0YSIgaW4gZXZlbnQgPyAtZXZlbnQud2hlZWxEZWx0YSA6IDAKICAgICAgICAgICAgICApCiAgICAgICAgICAgICk7CiAgICAgICAgICB9LAogICAgICAgICAgZGVsdGFaOiAwLAogICAgICAgICAgLy8gQnJvd3NlcnMgd2l0aG91dCAiZGVsdGFNb2RlIiBpcyByZXBvcnRpbmcgaW4gcmF3IHdoZWVsIGRlbHRhIHdoZXJlIG9uZQogICAgICAgICAgLy8gbm90Y2ggb24gdGhlIHNjcm9sbCBpcyBhbHdheXMgKy8tIDEyMCwgcm91Z2hseSBlcXVpdmFsZW50IHRvIHBpeGVscy4KICAgICAgICAgIC8vIEEgZ29vZCBhcHByb3hpbWF0aW9uIG9mIERPTV9ERUxUQV9MSU5FICgxKSBpcyA1JSBvZiB2aWV3cG9ydCBzaXplIG9yCiAgICAgICAgICAvLyB+NDAgcGl4ZWxzLCBmb3IgRE9NX0RFTFRBX1NDUkVFTiAoMikgaXQgaXMgODcuNSUgb2Ygdmlld3BvcnQgc2l6ZS4KICAgICAgICAgIGRlbHRhTW9kZTogMAogICAgICAgIH0pOwogICAgICAgIHZhciBTeW50aGV0aWNXaGVlbEV2ZW50ID0gY3JlYXRlU3ludGhldGljRXZlbnQoV2hlZWxFdmVudEludGVyZmFjZSk7CiAgICAgICAgdmFyIEVORF9LRVlDT0RFUyA9IFs5LCAxMywgMjcsIDMyXTsKICAgICAgICB2YXIgU1RBUlRfS0VZQ09ERSA9IDIyOTsKICAgICAgICB2YXIgY2FuVXNlQ29tcG9zaXRpb25FdmVudCA9IGNhblVzZURPTTIgJiYgIkNvbXBvc2l0aW9uRXZlbnQiIGluIHdpbmRvdzsKICAgICAgICB2YXIgZG9jdW1lbnRNb2RlID0gbnVsbDsKICAgICAgICBpZiAoY2FuVXNlRE9NMiAmJiAiZG9jdW1lbnRNb2RlIiBpbiBkb2N1bWVudCkgewogICAgICAgICAgZG9jdW1lbnRNb2RlID0gZG9jdW1lbnQuZG9jdW1lbnRNb2RlOwogICAgICAgIH0KICAgICAgICB2YXIgY2FuVXNlVGV4dElucHV0RXZlbnQgPSBjYW5Vc2VET00yICYmICJUZXh0RXZlbnQiIGluIHdpbmRvdyAmJiAhZG9jdW1lbnRNb2RlOwogICAgICAgIHZhciB1c2VGYWxsYmFja0NvbXBvc2l0aW9uRGF0YSA9IGNhblVzZURPTTIgJiYgKCFjYW5Vc2VDb21wb3NpdGlvbkV2ZW50IHx8IGRvY3VtZW50TW9kZSAmJiBkb2N1bWVudE1vZGUgPiA4ICYmIGRvY3VtZW50TW9kZSA8PSAxMSk7CiAgICAgICAgdmFyIFNQQUNFQkFSX0NPREUgPSAzMjsKICAgICAgICB2YXIgU1BBQ0VCQVJfQ0hBUiA9IFN0cmluZy5mcm9tQ2hhckNvZGUoU1BBQ0VCQVJfQ09ERSk7CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMoKSB7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uQmVmb3JlSW5wdXQiLCBbImNvbXBvc2l0aW9uZW5kIiwgImtleXByZXNzIiwgInRleHRJbnB1dCIsICJwYXN0ZSJdKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25Db21wb3NpdGlvbkVuZCIsIFsiY29tcG9zaXRpb25lbmQiLCAiZm9jdXNvdXQiLCAia2V5ZG93biIsICJrZXlwcmVzcyIsICJrZXl1cCIsICJtb3VzZWRvd24iXSk7CiAgICAgICAgICByZWdpc3RlclR3b1BoYXNlRXZlbnQoIm9uQ29tcG9zaXRpb25TdGFydCIsIFsiY29tcG9zaXRpb25zdGFydCIsICJmb2N1c291dCIsICJrZXlkb3duIiwgImtleXByZXNzIiwgImtleXVwIiwgIm1vdXNlZG93biJdKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25Db21wb3NpdGlvblVwZGF0ZSIsIFsiY29tcG9zaXRpb251cGRhdGUiLCAiZm9jdXNvdXQiLCAia2V5ZG93biIsICJrZXlwcmVzcyIsICJrZXl1cCIsICJtb3VzZWRvd24iXSk7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNTcGFjZUtleXByZXNzID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gaXNLZXlwcmVzc0NvbW1hbmQobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIHJldHVybiAobmF0aXZlRXZlbnQuY3RybEtleSB8fCBuYXRpdmVFdmVudC5hbHRLZXkgfHwgbmF0aXZlRXZlbnQubWV0YUtleSkgJiYgLy8gY3RybEtleSAmJiBhbHRLZXkgaXMgZXF1aXZhbGVudCB0byBBbHRHciwgYW5kIGlzIG5vdCBhIGNvbW1hbmQuCiAgICAgICAgICAhKG5hdGl2ZUV2ZW50LmN0cmxLZXkgJiYgbmF0aXZlRXZlbnQuYWx0S2V5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcG9zaXRpb25FdmVudFR5cGUoZG9tRXZlbnROYW1lKSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbnN0YXJ0IjoKICAgICAgICAgICAgICByZXR1cm4gIm9uQ29tcG9zaXRpb25TdGFydCI7CiAgICAgICAgICAgIGNhc2UgImNvbXBvc2l0aW9uZW5kIjoKICAgICAgICAgICAgICByZXR1cm4gIm9uQ29tcG9zaXRpb25FbmQiOwogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbnVwZGF0ZSI6CiAgICAgICAgICAgICAgcmV0dXJuICJvbkNvbXBvc2l0aW9uVXBkYXRlIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNGYWxsYmFja0NvbXBvc2l0aW9uU3RhcnQoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCkgewogICAgICAgICAgcmV0dXJuIGRvbUV2ZW50TmFtZSA9PT0gImtleWRvd24iICYmIG5hdGl2ZUV2ZW50LmtleUNvZGUgPT09IFNUQVJUX0tFWUNPREU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzRmFsbGJhY2tDb21wb3NpdGlvbkVuZChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJrZXl1cCI6CiAgICAgICAgICAgICAgcmV0dXJuIEVORF9LRVlDT0RFUy5pbmRleE9mKG5hdGl2ZUV2ZW50LmtleUNvZGUpICE9PSAtMTsKICAgICAgICAgICAgY2FzZSAia2V5ZG93biI6CiAgICAgICAgICAgICAgcmV0dXJuIG5hdGl2ZUV2ZW50LmtleUNvZGUgIT09IFNUQVJUX0tFWUNPREU7CiAgICAgICAgICAgIGNhc2UgImtleXByZXNzIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RGF0YUZyb21DdXN0b21FdmVudChuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGRldGFpbCA9IG5hdGl2ZUV2ZW50LmRldGFpbDsKICAgICAgICAgIGlmICh0eXBlb2YgZGV0YWlsID09PSAib2JqZWN0IiAmJiAiZGF0YSIgaW4gZGV0YWlsKSB7CiAgICAgICAgICAgIHJldHVybiBkZXRhaWwuZGF0YTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1VzaW5nS29yZWFuSU1FKG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gbmF0aXZlRXZlbnQubG9jYWxlID09PSAia28iOwogICAgICAgIH0KICAgICAgICB2YXIgaXNDb21wb3NpbmcgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBleHRyYWN0Q29tcG9zaXRpb25FdmVudChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCkgewogICAgICAgICAgdmFyIGV2ZW50VHlwZTsKICAgICAgICAgIHZhciBmYWxsYmFja0RhdGE7CiAgICAgICAgICBpZiAoY2FuVXNlQ29tcG9zaXRpb25FdmVudCkgewogICAgICAgICAgICBldmVudFR5cGUgPSBnZXRDb21wb3NpdGlvbkV2ZW50VHlwZShkb21FdmVudE5hbWUpOwogICAgICAgICAgfSBlbHNlIGlmICghaXNDb21wb3NpbmcpIHsKICAgICAgICAgICAgaWYgKGlzRmFsbGJhY2tDb21wb3NpdGlvblN0YXJ0KGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgICAgZXZlbnRUeXBlID0gIm9uQ29tcG9zaXRpb25TdGFydCI7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoaXNGYWxsYmFja0NvbXBvc2l0aW9uRW5kKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIGV2ZW50VHlwZSA9ICJvbkNvbXBvc2l0aW9uRW5kIjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghZXZlbnRUeXBlKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHVzZUZhbGxiYWNrQ29tcG9zaXRpb25EYXRhICYmICFpc1VzaW5nS29yZWFuSU1FKG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICBpZiAoIWlzQ29tcG9zaW5nICYmIGV2ZW50VHlwZSA9PT0gIm9uQ29tcG9zaXRpb25TdGFydCIpIHsKICAgICAgICAgICAgICBpc0NvbXBvc2luZyA9IGluaXRpYWxpemUobmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGV2ZW50VHlwZSA9PT0gIm9uQ29tcG9zaXRpb25FbmQiKSB7CiAgICAgICAgICAgICAgaWYgKGlzQ29tcG9zaW5nKSB7CiAgICAgICAgICAgICAgICBmYWxsYmFja0RhdGEgPSBnZXREYXRhKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gYWNjdW11bGF0ZVR3b1BoYXNlTGlzdGVuZXJzKHRhcmdldEluc3QsIGV2ZW50VHlwZSk7CiAgICAgICAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IFN5bnRoZXRpY0NvbXBvc2l0aW9uRXZlbnQoZXZlbnRUeXBlLCBkb21FdmVudE5hbWUsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoZmFsbGJhY2tEYXRhKSB7CiAgICAgICAgICAgICAgZXZlbnQuZGF0YSA9IGZhbGxiYWNrRGF0YTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgY3VzdG9tRGF0YSA9IGdldERhdGFGcm9tQ3VzdG9tRXZlbnQobmF0aXZlRXZlbnQpOwogICAgICAgICAgICAgIGlmIChjdXN0b21EYXRhICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBldmVudC5kYXRhID0gY3VzdG9tRGF0YTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmF0aXZlQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICBzd2l0Y2ggKGRvbUV2ZW50TmFtZSkgewogICAgICAgICAgICBjYXNlICJjb21wb3NpdGlvbmVuZCI6CiAgICAgICAgICAgICAgcmV0dXJuIGdldERhdGFGcm9tQ3VzdG9tRXZlbnQobmF0aXZlRXZlbnQpOwogICAgICAgICAgICBjYXNlICJrZXlwcmVzcyI6CiAgICAgICAgICAgICAgdmFyIHdoaWNoID0gbmF0aXZlRXZlbnQud2hpY2g7CiAgICAgICAgICAgICAgaWYgKHdoaWNoICE9PSBTUEFDRUJBUl9DT0RFKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaGFzU3BhY2VLZXlwcmVzcyA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIFNQQUNFQkFSX0NIQVI7CiAgICAgICAgICAgIGNhc2UgInRleHRJbnB1dCI6CiAgICAgICAgICAgICAgdmFyIGNoYXJzID0gbmF0aXZlRXZlbnQuZGF0YTsKICAgICAgICAgICAgICBpZiAoY2hhcnMgPT09IFNQQUNFQkFSX0NIQVIgJiYgaGFzU3BhY2VLZXlwcmVzcykgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBjaGFyczsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RmFsbGJhY2tCZWZvcmVJbnB1dENoYXJzKGRvbUV2ZW50TmFtZSwgbmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChpc0NvbXBvc2luZykgewogICAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiY29tcG9zaXRpb25lbmQiIHx8ICFjYW5Vc2VDb21wb3NpdGlvbkV2ZW50ICYmIGlzRmFsbGJhY2tDb21wb3NpdGlvbkVuZChkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KSkgewogICAgICAgICAgICAgIHZhciBjaGFycyA9IGdldERhdGEoKTsKICAgICAgICAgICAgICByZXNldCgpOwogICAgICAgICAgICAgIGlzQ29tcG9zaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgcmV0dXJuIGNoYXJzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAicGFzdGUiOgogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlICJrZXlwcmVzcyI6CiAgICAgICAgICAgICAgaWYgKCFpc0tleXByZXNzQ29tbWFuZChuYXRpdmVFdmVudCkpIHsKICAgICAgICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5jaGFyICYmIG5hdGl2ZUV2ZW50LmNoYXIubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbmF0aXZlRXZlbnQuY2hhcjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobmF0aXZlRXZlbnQud2hpY2gpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUobmF0aXZlRXZlbnQud2hpY2gpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSAiY29tcG9zaXRpb25lbmQiOgogICAgICAgICAgICAgIHJldHVybiB1c2VGYWxsYmFja0NvbXBvc2l0aW9uRGF0YSAmJiAhaXNVc2luZ0tvcmVhbklNRShuYXRpdmVFdmVudCkgPyBudWxsIDogbmF0aXZlRXZlbnQuZGF0YTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEJlZm9yZUlucHV0RXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0LCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgIHZhciBjaGFyczsKICAgICAgICAgIGlmIChjYW5Vc2VUZXh0SW5wdXRFdmVudCkgewogICAgICAgICAgICBjaGFycyA9IGdldE5hdGl2ZUJlZm9yZUlucHV0Q2hhcnMoZG9tRXZlbnROYW1lLCBuYXRpdmVFdmVudCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjaGFycyA9IGdldEZhbGxiYWNrQmVmb3JlSW5wdXRDaGFycyhkb21FdmVudE5hbWUsIG5hdGl2ZUV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghY2hhcnMpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gYWNjdW11bGF0ZVR3b1BoYXNlTGlzdGVuZXJzKHRhcmdldEluc3QsICJvbkJlZm9yZUlucHV0Iik7CiAgICAgICAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIGV2ZW50ID0gbmV3IFN5bnRoZXRpY0lucHV0RXZlbnQoIm9uQmVmb3JlSW5wdXQiLCAiYmVmb3JlaW5wdXQiLCBudWxsLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAgIGxpc3RlbmVycwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgZXZlbnQuZGF0YSA9IGNoYXJzOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleHRyYWN0RXZlbnRzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIGV4dHJhY3RDb21wb3NpdGlvbkV2ZW50KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIGV4dHJhY3RCZWZvcmVJbnB1dEV2ZW50KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICB9CiAgICAgICAgdmFyIHN1cHBvcnRlZElucHV0VHlwZXMgPSB7CiAgICAgICAgICBjb2xvcjogdHJ1ZSwKICAgICAgICAgIGRhdGU6IHRydWUsCiAgICAgICAgICBkYXRldGltZTogdHJ1ZSwKICAgICAgICAgICJkYXRldGltZS1sb2NhbCI6IHRydWUsCiAgICAgICAgICBlbWFpbDogdHJ1ZSwKICAgICAgICAgIG1vbnRoOiB0cnVlLAogICAgICAgICAgbnVtYmVyOiB0cnVlLAogICAgICAgICAgcGFzc3dvcmQ6IHRydWUsCiAgICAgICAgICByYW5nZTogdHJ1ZSwKICAgICAgICAgIHNlYXJjaDogdHJ1ZSwKICAgICAgICAgIHRlbDogdHJ1ZSwKICAgICAgICAgIHRleHQ6IHRydWUsCiAgICAgICAgICB0aW1lOiB0cnVlLAogICAgICAgICAgdXJsOiB0cnVlLAogICAgICAgICAgd2VlazogdHJ1ZQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gaXNUZXh0SW5wdXRFbGVtZW50KGVsZW0pIHsKICAgICAgICAgIHZhciBub2RlTmFtZSA9IGVsZW0gJiYgZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICBpZiAobm9kZU5hbWUgPT09ICJpbnB1dCIpIHsKICAgICAgICAgICAgcmV0dXJuICEhc3VwcG9ydGVkSW5wdXRUeXBlc1tlbGVtLnR5cGVdOwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5vZGVOYW1lID09PSAidGV4dGFyZWEiKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0V2ZW50U3VwcG9ydGVkKGV2ZW50TmFtZVN1ZmZpeCkgewogICAgICAgICAgaWYgKCFjYW5Vc2VET00yKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBldmVudE5hbWUgPSAib24iICsgZXZlbnROYW1lU3VmZml4OwogICAgICAgICAgdmFyIGlzU3VwcG9ydGVkID0gZXZlbnROYW1lIGluIGRvY3VtZW50OwogICAgICAgICAgaWYgKCFpc1N1cHBvcnRlZCkgewogICAgICAgICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwogICAgICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZShldmVudE5hbWUsICJyZXR1cm47Iik7CiAgICAgICAgICAgIGlzU3VwcG9ydGVkID0gdHlwZW9mIGVsZW1lbnRbZXZlbnROYW1lXSA9PT0gImZ1bmN0aW9uIjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpc1N1cHBvcnRlZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJFdmVudHMkMSgpIHsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudCgib25DaGFuZ2UiLCBbImNoYW5nZSIsICJjbGljayIsICJmb2N1c2luIiwgImZvY3Vzb3V0IiwgImlucHV0IiwgImtleWRvd24iLCAia2V5dXAiLCAic2VsZWN0aW9uY2hhbmdlIl0pOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVBbmRBY2N1bXVsYXRlQ2hhbmdlRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgaW5zdCwgbmF0aXZlRXZlbnQsIHRhcmdldCkgewogICAgICAgICAgZW5xdWV1ZVN0YXRlUmVzdG9yZSh0YXJnZXQpOwogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyhpbnN0LCAib25DaGFuZ2UiKTsKICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnQoIm9uQ2hhbmdlIiwgImNoYW5nZSIsIG51bGwsIG5hdGl2ZUV2ZW50LCB0YXJnZXQpOwogICAgICAgICAgICBkaXNwYXRjaFF1ZXVlLnB1c2goewogICAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAgIGxpc3RlbmVycwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGFjdGl2ZUVsZW1lbnQgPSBudWxsOwogICAgICAgIHZhciBhY3RpdmVFbGVtZW50SW5zdCA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkVXNlQ2hhbmdlRXZlbnQoZWxlbSkgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgPT09ICJzZWxlY3QiIHx8IG5vZGVOYW1lID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gImZpbGUiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYW51YWxEaXNwYXRjaENoYW5nZUV2ZW50KG5hdGl2ZUV2ZW50KSB7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hRdWV1ZSA9IFtdOwogICAgICAgICAgY3JlYXRlQW5kQWNjdW11bGF0ZUNoYW5nZUV2ZW50KGRpc3BhdGNoUXVldWUsIGFjdGl2ZUVsZW1lbnRJbnN0LCBuYXRpdmVFdmVudCwgZ2V0RXZlbnRUYXJnZXQobmF0aXZlRXZlbnQpKTsKICAgICAgICAgIGJhdGNoZWRVcGRhdGVzKHJ1bkV2ZW50SW5CYXRjaCwgZGlzcGF0Y2hRdWV1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJ1bkV2ZW50SW5CYXRjaChkaXNwYXRjaFF1ZXVlKSB7CiAgICAgICAgICBwcm9jZXNzRGlzcGF0Y2hRdWV1ZShkaXNwYXRjaFF1ZXVlLCAwKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKHRhcmdldEluc3QpIHsKICAgICAgICAgIHZhciB0YXJnZXROb2RlID0gZ2V0Tm9kZUZyb21JbnN0YW5jZSh0YXJnZXRJbnN0KTsKICAgICAgICAgIGlmICh1cGRhdGVWYWx1ZUlmQ2hhbmdlZCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICByZXR1cm4gdGFyZ2V0SW5zdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGFyZ2V0SW5zdEZvckNoYW5nZUV2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImNoYW5nZSIpIHsKICAgICAgICAgICAgcmV0dXJuIHRhcmdldEluc3Q7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBpc0lucHV0RXZlbnRTdXBwb3J0ZWQgPSBmYWxzZTsKICAgICAgICBpZiAoY2FuVXNlRE9NMikgewogICAgICAgICAgaXNJbnB1dEV2ZW50U3VwcG9ydGVkID0gaXNFdmVudFN1cHBvcnRlZCgiaW5wdXQiKSAmJiAoIWRvY3VtZW50LmRvY3VtZW50TW9kZSB8fCBkb2N1bWVudC5kb2N1bWVudE1vZGUgPiA5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKHRhcmdldCwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgYWN0aXZlRWxlbWVudCA9IHRhcmdldDsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnQuYXR0YWNoRXZlbnQoIm9ucHJvcGVydHljaGFuZ2UiLCBoYW5kbGVQcm9wZXJ0eUNoYW5nZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0b3BXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKCkgewogICAgICAgICAgaWYgKCFhY3RpdmVFbGVtZW50KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGFjdGl2ZUVsZW1lbnQuZGV0YWNoRXZlbnQoIm9ucHJvcGVydHljaGFuZ2UiLCBoYW5kbGVQcm9wZXJ0eUNoYW5nZSk7CiAgICAgICAgICBhY3RpdmVFbGVtZW50ID0gbnVsbDsKICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlUHJvcGVydHlDaGFuZ2UobmF0aXZlRXZlbnQpIHsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudC5wcm9wZXJ0eU5hbWUgIT09ICJ2YWx1ZSIpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldEluc3RJZlZhbHVlQ2hhbmdlZChhY3RpdmVFbGVtZW50SW5zdCkpIHsKICAgICAgICAgICAgbWFudWFsRGlzcGF0Y2hDaGFuZ2VFdmVudChuYXRpdmVFdmVudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUV2ZW50c0ZvcklucHV0RXZlbnRQb2x5ZmlsbChkb21FdmVudE5hbWUsIHRhcmdldCwgdGFyZ2V0SW5zdCkgewogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gImZvY3VzaW4iKSB7CiAgICAgICAgICAgIHN0b3BXYXRjaGluZ0ZvclZhbHVlQ2hhbmdlKCk7CiAgICAgICAgICAgIHN0YXJ0V2F0Y2hpbmdGb3JWYWx1ZUNoYW5nZSh0YXJnZXQsIHRhcmdldEluc3QpOwogICAgICAgICAgfSBlbHNlIGlmIChkb21FdmVudE5hbWUgPT09ICJmb2N1c291dCIpIHsKICAgICAgICAgICAgc3RvcFdhdGNoaW5nRm9yVmFsdWVDaGFuZ2UoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGFyZ2V0SW5zdEZvcklucHV0RXZlbnRQb2x5ZmlsbChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJzZWxlY3Rpb25jaGFuZ2UiIHx8IGRvbUV2ZW50TmFtZSA9PT0gImtleXVwIiB8fCBkb21FdmVudE5hbWUgPT09ICJrZXlkb3duIikgewogICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKGFjdGl2ZUVsZW1lbnRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkVXNlQ2xpY2tFdmVudChlbGVtKSB7CiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lICYmIG5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJpbnB1dCIgJiYgKGVsZW0udHlwZSA9PT0gImNoZWNrYm94IiB8fCBlbGVtLnR5cGUgPT09ICJyYWRpbyIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRUYXJnZXRJbnN0Rm9yQ2xpY2tFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJjbGljayIpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEluc3RJZlZhbHVlQ2hhbmdlZCh0YXJnZXRJbnN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VGFyZ2V0SW5zdEZvcklucHV0T3JDaGFuZ2VFdmVudChkb21FdmVudE5hbWUsIHRhcmdldEluc3QpIHsKICAgICAgICAgIGlmIChkb21FdmVudE5hbWUgPT09ICJpbnB1dCIgfHwgZG9tRXZlbnROYW1lID09PSAiY2hhbmdlIikgewogICAgICAgICAgICByZXR1cm4gZ2V0SW5zdElmVmFsdWVDaGFuZ2VkKHRhcmdldEluc3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVDb250cm9sbGVkSW5wdXRCbHVyKG5vZGUpIHsKICAgICAgICAgIHZhciBzdGF0ZSA9IG5vZGUuX3dyYXBwZXJTdGF0ZTsKICAgICAgICAgIGlmICghc3RhdGUgfHwgIXN0YXRlLmNvbnRyb2xsZWQgfHwgbm9kZS50eXBlICE9PSAibnVtYmVyIikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHNldERlZmF1bHRWYWx1ZShub2RlLCAibnVtYmVyIiwgbm9kZS52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMkMShkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IHRhcmdldEluc3QgPyBnZXROb2RlRnJvbUluc3RhbmNlKHRhcmdldEluc3QpIDogd2luZG93OwogICAgICAgICAgdmFyIGdldFRhcmdldEluc3RGdW5jLCBoYW5kbGVFdmVudEZ1bmM7CiAgICAgICAgICBpZiAoc2hvdWxkVXNlQ2hhbmdlRXZlbnQodGFyZ2V0Tm9kZSkpIHsKICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9yQ2hhbmdlRXZlbnQ7CiAgICAgICAgICB9IGVsc2UgaWYgKGlzVGV4dElucHV0RWxlbWVudCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICBpZiAoaXNJbnB1dEV2ZW50U3VwcG9ydGVkKSB7CiAgICAgICAgICAgICAgZ2V0VGFyZ2V0SW5zdEZ1bmMgPSBnZXRUYXJnZXRJbnN0Rm9ySW5wdXRPckNoYW5nZUV2ZW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGdldFRhcmdldEluc3RGdW5jID0gZ2V0VGFyZ2V0SW5zdEZvcklucHV0RXZlbnRQb2x5ZmlsbDsKICAgICAgICAgICAgICBoYW5kbGVFdmVudEZ1bmMgPSBoYW5kbGVFdmVudHNGb3JJbnB1dEV2ZW50UG9seWZpbGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoc2hvdWxkVXNlQ2xpY2tFdmVudCh0YXJnZXROb2RlKSkgewogICAgICAgICAgICBnZXRUYXJnZXRJbnN0RnVuYyA9IGdldFRhcmdldEluc3RGb3JDbGlja0V2ZW50OwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldFRhcmdldEluc3RGdW5jKSB7CiAgICAgICAgICAgIHZhciBpbnN0ID0gZ2V0VGFyZ2V0SW5zdEZ1bmMoZG9tRXZlbnROYW1lLCB0YXJnZXRJbnN0KTsKICAgICAgICAgICAgaWYgKGluc3QpIHsKICAgICAgICAgICAgICBjcmVhdGVBbmRBY2N1bXVsYXRlQ2hhbmdlRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgaW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChoYW5kbGVFdmVudEZ1bmMpIHsKICAgICAgICAgICAgaGFuZGxlRXZlbnRGdW5jKGRvbUV2ZW50TmFtZSwgdGFyZ2V0Tm9kZSwgdGFyZ2V0SW5zdCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lID09PSAiZm9jdXNvdXQiKSB7CiAgICAgICAgICAgIGhhbmRsZUNvbnRyb2xsZWRJbnB1dEJsdXIodGFyZ2V0Tm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyRXZlbnRzJDIoKSB7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvbk1vdXNlRW50ZXIiLCBbIm1vdXNlb3V0IiwgIm1vdXNlb3ZlciJdKTsKICAgICAgICAgIHJlZ2lzdGVyRGlyZWN0RXZlbnQoIm9uTW91c2VMZWF2ZSIsIFsibW91c2VvdXQiLCAibW91c2VvdmVyIl0pOwogICAgICAgICAgcmVnaXN0ZXJEaXJlY3RFdmVudCgib25Qb2ludGVyRW50ZXIiLCBbInBvaW50ZXJvdXQiLCAicG9pbnRlcm92ZXIiXSk7CiAgICAgICAgICByZWdpc3RlckRpcmVjdEV2ZW50KCJvblBvaW50ZXJMZWF2ZSIsIFsicG9pbnRlcm91dCIsICJwb2ludGVyb3ZlciJdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQyKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHZhciBpc092ZXJFdmVudCA9IGRvbUV2ZW50TmFtZSA9PT0gIm1vdXNlb3ZlciIgfHwgZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm92ZXIiOwogICAgICAgICAgdmFyIGlzT3V0RXZlbnQgPSBkb21FdmVudE5hbWUgPT09ICJtb3VzZW91dCIgfHwgZG9tRXZlbnROYW1lID09PSAicG9pbnRlcm91dCI7CiAgICAgICAgICBpZiAoaXNPdmVyRXZlbnQgJiYgIWlzUmVwbGF5aW5nRXZlbnQobmF0aXZlRXZlbnQpKSB7CiAgICAgICAgICAgIHZhciByZWxhdGVkID0gbmF0aXZlRXZlbnQucmVsYXRlZFRhcmdldCB8fCBuYXRpdmVFdmVudC5mcm9tRWxlbWVudDsKICAgICAgICAgICAgaWYgKHJlbGF0ZWQpIHsKICAgICAgICAgICAgICBpZiAoZ2V0Q2xvc2VzdEluc3RhbmNlRnJvbU5vZGUocmVsYXRlZCkgfHwgaXNDb250YWluZXJNYXJrZWRBc1Jvb3QocmVsYXRlZCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNPdXRFdmVudCAmJiAhaXNPdmVyRXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHdpbjsKICAgICAgICAgIGlmIChuYXRpdmVFdmVudFRhcmdldC53aW5kb3cgPT09IG5hdGl2ZUV2ZW50VGFyZ2V0KSB7CiAgICAgICAgICAgIHdpbiA9IG5hdGl2ZUV2ZW50VGFyZ2V0OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGRvYyA9IG5hdGl2ZUV2ZW50VGFyZ2V0Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICAgIGlmIChkb2MpIHsKICAgICAgICAgICAgICB3aW4gPSBkb2MuZGVmYXVsdFZpZXcgfHwgZG9jLnBhcmVudFdpbmRvdzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3aW4gPSB3aW5kb3c7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBmcm9tMjsKICAgICAgICAgIHZhciB0bzI7CiAgICAgICAgICBpZiAoaXNPdXRFdmVudCkgewogICAgICAgICAgICB2YXIgX3JlbGF0ZWQgPSBuYXRpdmVFdmVudC5yZWxhdGVkVGFyZ2V0IHx8IG5hdGl2ZUV2ZW50LnRvRWxlbWVudDsKICAgICAgICAgICAgZnJvbTIgPSB0YXJnZXRJbnN0OwogICAgICAgICAgICB0bzIgPSBfcmVsYXRlZCA/IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKF9yZWxhdGVkKSA6IG51bGw7CiAgICAgICAgICAgIGlmICh0bzIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgbmVhcmVzdE1vdW50ZWQgPSBnZXROZWFyZXN0TW91bnRlZEZpYmVyKHRvMik7CiAgICAgICAgICAgICAgaWYgKHRvMiAhPT0gbmVhcmVzdE1vdW50ZWQgfHwgdG8yLnRhZyAhPT0gSG9zdENvbXBvbmVudCAmJiB0bzIudGFnICE9PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgdG8yID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZyb20yID0gbnVsbDsKICAgICAgICAgICAgdG8yID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmcm9tMiA9PT0gdG8yKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNNb3VzZUV2ZW50OwogICAgICAgICAgdmFyIGxlYXZlRXZlbnRUeXBlID0gIm9uTW91c2VMZWF2ZSI7CiAgICAgICAgICB2YXIgZW50ZXJFdmVudFR5cGUgPSAib25Nb3VzZUVudGVyIjsKICAgICAgICAgIHZhciBldmVudFR5cGVQcmVmaXggPSAibW91c2UiOwogICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gInBvaW50ZXJvdXQiIHx8IGRvbUV2ZW50TmFtZSA9PT0gInBvaW50ZXJvdmVyIikgewogICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNQb2ludGVyRXZlbnQ7CiAgICAgICAgICAgIGxlYXZlRXZlbnRUeXBlID0gIm9uUG9pbnRlckxlYXZlIjsKICAgICAgICAgICAgZW50ZXJFdmVudFR5cGUgPSAib25Qb2ludGVyRW50ZXIiOwogICAgICAgICAgICBldmVudFR5cGVQcmVmaXggPSAicG9pbnRlciI7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZnJvbU5vZGUgPSBmcm9tMiA9PSBudWxsID8gd2luIDogZ2V0Tm9kZUZyb21JbnN0YW5jZShmcm9tMik7CiAgICAgICAgICB2YXIgdG9Ob2RlID0gdG8yID09IG51bGwgPyB3aW4gOiBnZXROb2RlRnJvbUluc3RhbmNlKHRvMik7CiAgICAgICAgICB2YXIgbGVhdmUgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKGxlYXZlRXZlbnRUeXBlLCBldmVudFR5cGVQcmVmaXggKyAibGVhdmUiLCBmcm9tMiwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIGxlYXZlLnRhcmdldCA9IGZyb21Ob2RlOwogICAgICAgICAgbGVhdmUucmVsYXRlZFRhcmdldCA9IHRvTm9kZTsKICAgICAgICAgIHZhciBlbnRlciA9IG51bGw7CiAgICAgICAgICB2YXIgbmF0aXZlVGFyZ2V0SW5zdCA9IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIGlmIChuYXRpdmVUYXJnZXRJbnN0ID09PSB0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgIHZhciBlbnRlckV2ZW50ID0gbmV3IFN5bnRoZXRpY0V2ZW50Q3RvcihlbnRlckV2ZW50VHlwZSwgZXZlbnRUeXBlUHJlZml4ICsgImVudGVyIiwgdG8yLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpOwogICAgICAgICAgICBlbnRlckV2ZW50LnRhcmdldCA9IHRvTm9kZTsKICAgICAgICAgICAgZW50ZXJFdmVudC5yZWxhdGVkVGFyZ2V0ID0gZnJvbU5vZGU7CiAgICAgICAgICAgIGVudGVyID0gZW50ZXJFdmVudDsKICAgICAgICAgIH0KICAgICAgICAgIGFjY3VtdWxhdGVFbnRlckxlYXZlVHdvUGhhc2VMaXN0ZW5lcnMoZGlzcGF0Y2hRdWV1ZSwgbGVhdmUsIGVudGVyLCBmcm9tMiwgdG8yKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXM0KHgyLCB5MikgewogICAgICAgICAgcmV0dXJuIHgyID09PSB5MiAmJiAoeDIgIT09IDAgfHwgMSAvIHgyID09PSAxIC8geTIpIHx8IHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgICAgICAgfQogICAgICAgIHZhciBvYmplY3RJcyA9IHR5cGVvZiBPYmplY3QuaXMgPT09ICJmdW5jdGlvbiIgPyBPYmplY3QuaXMgOiBpczQ7CiAgICAgICAgZnVuY3Rpb24gc2hhbGxvd0VxdWFsMihvYmpBLCBvYmpCKSB7CiAgICAgICAgICBpZiAob2JqZWN0SXMob2JqQSwgb2JqQikpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIG9iakEgIT09ICJvYmplY3QiIHx8IG9iakEgPT09IG51bGwgfHwgdHlwZW9mIG9iakIgIT09ICJvYmplY3QiIHx8IG9iakIgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGtleXNBID0gT2JqZWN0LmtleXMob2JqQSk7CiAgICAgICAgICB2YXIga2V5c0IgPSBPYmplY3Qua2V5cyhvYmpCKTsKICAgICAgICAgIGlmIChrZXlzQS5sZW5ndGggIT09IGtleXNCLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXNBLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBjdXJyZW50S2V5ID0ga2V5c0FbaV07CiAgICAgICAgICAgIGlmICghaGFzT3duUHJvcGVydHkuY2FsbChvYmpCLCBjdXJyZW50S2V5KSB8fCAhb2JqZWN0SXMob2JqQVtjdXJyZW50S2V5XSwgb2JqQltjdXJyZW50S2V5XSkpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRMZWFmTm9kZShub2RlKSB7CiAgICAgICAgICB3aGlsZSAobm9kZSAmJiBub2RlLmZpcnN0Q2hpbGQpIHsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuZmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTaWJsaW5nTm9kZShub2RlKSB7CiAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZykgewogICAgICAgICAgICAgIHJldHVybiBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5vZGVGb3JDaGFyYWN0ZXJPZmZzZXQocm9vdDMsIG9mZnNldCkgewogICAgICAgICAgdmFyIG5vZGUgPSBnZXRMZWFmTm9kZShyb290Myk7CiAgICAgICAgICB2YXIgbm9kZVN0YXJ0ID0gMDsKICAgICAgICAgIHZhciBub2RlRW5kID0gMDsKICAgICAgICAgIHdoaWxlIChub2RlKSB7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSBURVhUX05PREUpIHsKICAgICAgICAgICAgICBub2RlRW5kID0gbm9kZVN0YXJ0ICsgbm9kZS50ZXh0Q29udGVudC5sZW5ndGg7CiAgICAgICAgICAgICAgaWYgKG5vZGVTdGFydCA8PSBvZmZzZXQgJiYgbm9kZUVuZCA+PSBvZmZzZXQpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgIG5vZGUsCiAgICAgICAgICAgICAgICAgIG9mZnNldDogb2Zmc2V0IC0gbm9kZVN0YXJ0CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlU3RhcnQgPSBub2RlRW5kOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBnZXRMZWFmTm9kZShnZXRTaWJsaW5nTm9kZShub2RlKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE9mZnNldHMob3V0ZXJOb2RlKSB7CiAgICAgICAgICB2YXIgb3duZXJEb2N1bWVudCA9IG91dGVyTm9kZS5vd25lckRvY3VtZW50OwogICAgICAgICAgdmFyIHdpbiA9IG93bmVyRG9jdW1lbnQgJiYgb3duZXJEb2N1bWVudC5kZWZhdWx0VmlldyB8fCB3aW5kb3c7CiAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luLmdldFNlbGVjdGlvbiAmJiB3aW4uZ2V0U2VsZWN0aW9uKCk7CiAgICAgICAgICBpZiAoIXNlbGVjdGlvbiB8fCBzZWxlY3Rpb24ucmFuZ2VDb3VudCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBhbmNob3JOb2RlID0gc2VsZWN0aW9uLmFuY2hvck5vZGUsIGFuY2hvck9mZnNldCA9IHNlbGVjdGlvbi5hbmNob3JPZmZzZXQsIGZvY3VzTm9kZSA9IHNlbGVjdGlvbi5mb2N1c05vZGUsIGZvY3VzT2Zmc2V0ID0gc2VsZWN0aW9uLmZvY3VzT2Zmc2V0OwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYW5jaG9yTm9kZS5ub2RlVHlwZTsKICAgICAgICAgICAgZm9jdXNOb2RlLm5vZGVUeXBlOwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBnZXRNb2Rlcm5PZmZzZXRzRnJvbVBvaW50cyhvdXRlck5vZGUsIGFuY2hvck5vZGUsIGFuY2hvck9mZnNldCwgZm9jdXNOb2RlLCBmb2N1c09mZnNldCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE1vZGVybk9mZnNldHNGcm9tUG9pbnRzKG91dGVyTm9kZSwgYW5jaG9yTm9kZSwgYW5jaG9yT2Zmc2V0LCBmb2N1c05vZGUsIGZvY3VzT2Zmc2V0KSB7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gMDsKICAgICAgICAgIHZhciBzdGFydCA9IC0xOwogICAgICAgICAgdmFyIGVuZCA9IC0xOwogICAgICAgICAgdmFyIGluZGV4V2l0aGluQW5jaG9yID0gMDsKICAgICAgICAgIHZhciBpbmRleFdpdGhpbkZvY3VzID0gMDsKICAgICAgICAgIHZhciBub2RlID0gb3V0ZXJOb2RlOwogICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSBudWxsOwogICAgICAgICAgb3V0ZXI6IHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIHZhciBuZXh0ID0gbnVsbDsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gYW5jaG9yTm9kZSAmJiAoYW5jaG9yT2Zmc2V0ID09PSAwIHx8IG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkpIHsKICAgICAgICAgICAgICAgIHN0YXJ0ID0gbGVuZ3RoICsgYW5jaG9yT2Zmc2V0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZm9jdXNOb2RlICYmIChmb2N1c09mZnNldCA9PT0gMCB8fCBub2RlLm5vZGVUeXBlID09PSBURVhUX05PREUpKSB7CiAgICAgICAgICAgICAgICBlbmQgPSBsZW5ndGggKyBmb2N1c09mZnNldDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IFRFWFRfTk9ERSkgewogICAgICAgICAgICAgICAgbGVuZ3RoICs9IG5vZGUubm9kZVZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKChuZXh0ID0gbm9kZS5maXJzdENoaWxkKSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBhcmVudE5vZGUgPSBub2RlOwogICAgICAgICAgICAgIG5vZGUgPSBuZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IG91dGVyTm9kZSkgewogICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBhbmNob3JOb2RlICYmICsraW5kZXhXaXRoaW5BbmNob3IgPT09IGFuY2hvck9mZnNldCkgewogICAgICAgICAgICAgICAgc3RhcnQgPSBsZW5ndGg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBmb2N1c05vZGUgJiYgKytpbmRleFdpdGhpbkZvY3VzID09PSBmb2N1c09mZnNldCkgewogICAgICAgICAgICAgICAgZW5kID0gbGVuZ3RoOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKG5leHQgPSBub2RlLm5leHRTaWJsaW5nKSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUgPSBwYXJlbnROb2RlOwogICAgICAgICAgICAgIHBhcmVudE5vZGUgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5leHQ7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc3RhcnQgPT09IC0xIHx8IGVuZCA9PT0gLTEpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBzdGFydCwKICAgICAgICAgICAgZW5kCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzZXRPZmZzZXRzKG5vZGUsIG9mZnNldHMpIHsKICAgICAgICAgIHZhciBkb2MgPSBub2RlLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQ7CiAgICAgICAgICB2YXIgd2luID0gZG9jICYmIGRvYy5kZWZhdWx0VmlldyB8fCB3aW5kb3c7CiAgICAgICAgICBpZiAoIXdpbi5nZXRTZWxlY3Rpb24pIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNlbGVjdGlvbiA9IHdpbi5nZXRTZWxlY3Rpb24oKTsKICAgICAgICAgIHZhciBsZW5ndGggPSBub2RlLnRleHRDb250ZW50Lmxlbmd0aDsKICAgICAgICAgIHZhciBzdGFydCA9IE1hdGgubWluKG9mZnNldHMuc3RhcnQsIGxlbmd0aCk7CiAgICAgICAgICB2YXIgZW5kID0gb2Zmc2V0cy5lbmQgPT09IHZvaWQgMCA/IHN0YXJ0IDogTWF0aC5taW4ob2Zmc2V0cy5lbmQsIGxlbmd0aCk7CiAgICAgICAgICBpZiAoIXNlbGVjdGlvbi5leHRlbmQgJiYgc3RhcnQgPiBlbmQpIHsKICAgICAgICAgICAgdmFyIHRlbXAgPSBlbmQ7CiAgICAgICAgICAgIGVuZCA9IHN0YXJ0OwogICAgICAgICAgICBzdGFydCA9IHRlbXA7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc3RhcnRNYXJrZXIgPSBnZXROb2RlRm9yQ2hhcmFjdGVyT2Zmc2V0KG5vZGUsIHN0YXJ0KTsKICAgICAgICAgIHZhciBlbmRNYXJrZXIgPSBnZXROb2RlRm9yQ2hhcmFjdGVyT2Zmc2V0KG5vZGUsIGVuZCk7CiAgICAgICAgICBpZiAoc3RhcnRNYXJrZXIgJiYgZW5kTWFya2VyKSB7CiAgICAgICAgICAgIGlmIChzZWxlY3Rpb24ucmFuZ2VDb3VudCA9PT0gMSAmJiBzZWxlY3Rpb24uYW5jaG9yTm9kZSA9PT0gc3RhcnRNYXJrZXIubm9kZSAmJiBzZWxlY3Rpb24uYW5jaG9yT2Zmc2V0ID09PSBzdGFydE1hcmtlci5vZmZzZXQgJiYgc2VsZWN0aW9uLmZvY3VzTm9kZSA9PT0gZW5kTWFya2VyLm5vZGUgJiYgc2VsZWN0aW9uLmZvY3VzT2Zmc2V0ID09PSBlbmRNYXJrZXIub2Zmc2V0KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByYW5nZTQgPSBkb2MuY3JlYXRlUmFuZ2UoKTsKICAgICAgICAgICAgcmFuZ2U0LnNldFN0YXJ0KHN0YXJ0TWFya2VyLm5vZGUsIHN0YXJ0TWFya2VyLm9mZnNldCk7CiAgICAgICAgICAgIHNlbGVjdGlvbi5yZW1vdmVBbGxSYW5nZXMoKTsKICAgICAgICAgICAgaWYgKHN0YXJ0ID4gZW5kKSB7CiAgICAgICAgICAgICAgc2VsZWN0aW9uLmFkZFJhbmdlKHJhbmdlNCk7CiAgICAgICAgICAgICAgc2VsZWN0aW9uLmV4dGVuZChlbmRNYXJrZXIubm9kZSwgZW5kTWFya2VyLm9mZnNldCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmFuZ2U0LnNldEVuZChlbmRNYXJrZXIubm9kZSwgZW5kTWFya2VyLm9mZnNldCk7CiAgICAgICAgICAgICAgc2VsZWN0aW9uLmFkZFJhbmdlKHJhbmdlNCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNUZXh0Tm9kZShub2RlKSB7CiAgICAgICAgICByZXR1cm4gbm9kZSAmJiBub2RlLm5vZGVUeXBlID09PSBURVhUX05PREU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbnRhaW5zTm9kZShvdXRlck5vZGUsIGlubmVyTm9kZSkgewogICAgICAgICAgaWYgKCFvdXRlck5vZGUgfHwgIWlubmVyTm9kZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgaWYgKG91dGVyTm9kZSA9PT0gaW5uZXJOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIGlmIChpc1RleHROb2RlKG91dGVyTm9kZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSBlbHNlIGlmIChpc1RleHROb2RlKGlubmVyTm9kZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5zTm9kZShvdXRlck5vZGUsIGlubmVyTm9kZS5wYXJlbnROb2RlKTsKICAgICAgICAgIH0gZWxzZSBpZiAoImNvbnRhaW5zIiBpbiBvdXRlck5vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIG91dGVyTm9kZS5jb250YWlucyhpbm5lck5vZGUpOwogICAgICAgICAgfSBlbHNlIGlmIChvdXRlck5vZGUuY29tcGFyZURvY3VtZW50UG9zaXRpb24pIHsKICAgICAgICAgICAgcmV0dXJuICEhKG91dGVyTm9kZS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihpbm5lck5vZGUpICYgMTYpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0luRG9jdW1lbnQobm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGUgJiYgbm9kZS5vd25lckRvY3VtZW50ICYmIGNvbnRhaW5zTm9kZShub2RlLm93bmVyRG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBub2RlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNTYW1lT3JpZ2luRnJhbWUoaWZyYW1lKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gdHlwZW9mIGlmcmFtZS5jb250ZW50V2luZG93LmxvY2F0aW9uLmhyZWYgPT09ICJzdHJpbmciOwogICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0QWN0aXZlRWxlbWVudERlZXAoKSB7CiAgICAgICAgICB2YXIgd2luID0gd2luZG93OwogICAgICAgICAgdmFyIGVsZW1lbnQgPSBnZXRBY3RpdmVFbGVtZW50KCk7CiAgICAgICAgICB3aGlsZSAoZWxlbWVudCBpbnN0YW5jZW9mIHdpbi5IVE1MSUZyYW1lRWxlbWVudCkgewogICAgICAgICAgICBpZiAoaXNTYW1lT3JpZ2luRnJhbWUoZWxlbWVudCkpIHsKICAgICAgICAgICAgICB3aW4gPSBlbGVtZW50LmNvbnRlbnRXaW5kb3c7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudCA9IGdldEFjdGl2ZUVsZW1lbnQod2luLmRvY3VtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNTZWxlY3Rpb25DYXBhYmlsaXRpZXMoZWxlbSkgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gZWxlbSAmJiBlbGVtLm5vZGVOYW1lICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBub2RlTmFtZSAmJiAobm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgKGVsZW0udHlwZSA9PT0gInRleHQiIHx8IGVsZW0udHlwZSA9PT0gInNlYXJjaCIgfHwgZWxlbS50eXBlID09PSAidGVsIiB8fCBlbGVtLnR5cGUgPT09ICJ1cmwiIHx8IGVsZW0udHlwZSA9PT0gInBhc3N3b3JkIikgfHwgbm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIgfHwgZWxlbS5jb250ZW50RWRpdGFibGUgPT09ICJ0cnVlIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFNlbGVjdGlvbkluZm9ybWF0aW9uKCkgewogICAgICAgICAgdmFyIGZvY3VzZWRFbGVtID0gZ2V0QWN0aXZlRWxlbWVudERlZXAoKTsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGZvY3VzZWRFbGVtLAogICAgICAgICAgICBzZWxlY3Rpb25SYW5nZTogaGFzU2VsZWN0aW9uQ2FwYWJpbGl0aWVzKGZvY3VzZWRFbGVtKSA/IGdldFNlbGVjdGlvbihmb2N1c2VkRWxlbSkgOiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXN0b3JlU2VsZWN0aW9uKHByaW9yU2VsZWN0aW9uSW5mb3JtYXRpb24pIHsKICAgICAgICAgIHZhciBjdXJGb2N1c2VkRWxlbSA9IGdldEFjdGl2ZUVsZW1lbnREZWVwKCk7CiAgICAgICAgICB2YXIgcHJpb3JGb2N1c2VkRWxlbSA9IHByaW9yU2VsZWN0aW9uSW5mb3JtYXRpb24uZm9jdXNlZEVsZW07CiAgICAgICAgICB2YXIgcHJpb3JTZWxlY3Rpb25SYW5nZSA9IHByaW9yU2VsZWN0aW9uSW5mb3JtYXRpb24uc2VsZWN0aW9uUmFuZ2U7CiAgICAgICAgICBpZiAoY3VyRm9jdXNlZEVsZW0gIT09IHByaW9yRm9jdXNlZEVsZW0gJiYgaXNJbkRvY3VtZW50KHByaW9yRm9jdXNlZEVsZW0pKSB7CiAgICAgICAgICAgIGlmIChwcmlvclNlbGVjdGlvblJhbmdlICE9PSBudWxsICYmIGhhc1NlbGVjdGlvbkNhcGFiaWxpdGllcyhwcmlvckZvY3VzZWRFbGVtKSkgewogICAgICAgICAgICAgIHNldFNlbGVjdGlvbihwcmlvckZvY3VzZWRFbGVtLCBwcmlvclNlbGVjdGlvblJhbmdlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYW5jZXN0b3JzID0gW107CiAgICAgICAgICAgIHZhciBhbmNlc3RvciA9IHByaW9yRm9jdXNlZEVsZW07CiAgICAgICAgICAgIHdoaWxlIChhbmNlc3RvciA9IGFuY2VzdG9yLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgICBpZiAoYW5jZXN0b3Iubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgICAgYW5jZXN0b3JzLnB1c2goewogICAgICAgICAgICAgICAgICBlbGVtZW50OiBhbmNlc3RvciwKICAgICAgICAgICAgICAgICAgbGVmdDogYW5jZXN0b3Iuc2Nyb2xsTGVmdCwKICAgICAgICAgICAgICAgICAgdG9wOiBhbmNlc3Rvci5zY3JvbGxUb3AKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHByaW9yRm9jdXNlZEVsZW0uZm9jdXMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwcmlvckZvY3VzZWRFbGVtLmZvY3VzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhbmNlc3RvcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgaW5mbyA9IGFuY2VzdG9yc1tpXTsKICAgICAgICAgICAgICBpbmZvLmVsZW1lbnQuc2Nyb2xsTGVmdCA9IGluZm8ubGVmdDsKICAgICAgICAgICAgICBpbmZvLmVsZW1lbnQuc2Nyb2xsVG9wID0gaW5mby50b3A7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U2VsZWN0aW9uKGlucHV0KSB7CiAgICAgICAgICB2YXIgc2VsZWN0aW9uOwogICAgICAgICAgaWYgKCJzZWxlY3Rpb25TdGFydCIgaW4gaW5wdXQpIHsKICAgICAgICAgICAgc2VsZWN0aW9uID0gewogICAgICAgICAgICAgIHN0YXJ0OiBpbnB1dC5zZWxlY3Rpb25TdGFydCwKICAgICAgICAgICAgICBlbmQ6IGlucHV0LnNlbGVjdGlvbkVuZAogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2VsZWN0aW9uID0gZ2V0T2Zmc2V0cyhpbnB1dCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc2VsZWN0aW9uIHx8IHsKICAgICAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgICAgIGVuZDogMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0U2VsZWN0aW9uKGlucHV0LCBvZmZzZXRzKSB7CiAgICAgICAgICB2YXIgc3RhcnQgPSBvZmZzZXRzLnN0YXJ0OwogICAgICAgICAgdmFyIGVuZCA9IG9mZnNldHMuZW5kOwogICAgICAgICAgaWYgKGVuZCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGVuZCA9IHN0YXJ0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKCJzZWxlY3Rpb25TdGFydCIgaW4gaW5wdXQpIHsKICAgICAgICAgICAgaW5wdXQuc2VsZWN0aW9uU3RhcnQgPSBzdGFydDsKICAgICAgICAgICAgaW5wdXQuc2VsZWN0aW9uRW5kID0gTWF0aC5taW4oZW5kLCBpbnB1dC52YWx1ZS5sZW5ndGgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2V0T2Zmc2V0cyhpbnB1dCwgb2Zmc2V0cyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBza2lwU2VsZWN0aW9uQ2hhbmdlRXZlbnQgPSBjYW5Vc2VET00yICYmICJkb2N1bWVudE1vZGUiIGluIGRvY3VtZW50ICYmIGRvY3VtZW50LmRvY3VtZW50TW9kZSA8PSAxMTsKICAgICAgICBmdW5jdGlvbiByZWdpc3RlckV2ZW50cyQzKCkgewogICAgICAgICAgcmVnaXN0ZXJUd29QaGFzZUV2ZW50KCJvblNlbGVjdCIsIFsiZm9jdXNvdXQiLCAiY29udGV4dG1lbnUiLCAiZHJhZ2VuZCIsICJmb2N1c2luIiwgImtleWRvd24iLCAia2V5dXAiLCAibW91c2Vkb3duIiwgIm1vdXNldXAiLCAic2VsZWN0aW9uY2hhbmdlIl0pOwogICAgICAgIH0KICAgICAgICB2YXIgYWN0aXZlRWxlbWVudCQxID0gbnVsbDsKICAgICAgICB2YXIgYWN0aXZlRWxlbWVudEluc3QkMSA9IG51bGw7CiAgICAgICAgdmFyIGxhc3RTZWxlY3Rpb24gPSBudWxsOwogICAgICAgIHZhciBtb3VzZURvd24gPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBnZXRTZWxlY3Rpb24kMShub2RlKSB7CiAgICAgICAgICBpZiAoInNlbGVjdGlvblN0YXJ0IiBpbiBub2RlICYmIGhhc1NlbGVjdGlvbkNhcGFiaWxpdGllcyhub2RlKSkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIHN0YXJ0OiBub2RlLnNlbGVjdGlvblN0YXJ0LAogICAgICAgICAgICAgIGVuZDogbm9kZS5zZWxlY3Rpb25FbmQKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciB3aW4gPSBub2RlLm93bmVyRG9jdW1lbnQgJiYgbm9kZS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3IHx8IHdpbmRvdzsKICAgICAgICAgICAgdmFyIHNlbGVjdGlvbiA9IHdpbi5nZXRTZWxlY3Rpb24oKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBhbmNob3JOb2RlOiBzZWxlY3Rpb24uYW5jaG9yTm9kZSwKICAgICAgICAgICAgICBhbmNob3JPZmZzZXQ6IHNlbGVjdGlvbi5hbmNob3JPZmZzZXQsCiAgICAgICAgICAgICAgZm9jdXNOb2RlOiBzZWxlY3Rpb24uZm9jdXNOb2RlLAogICAgICAgICAgICAgIGZvY3VzT2Zmc2V0OiBzZWxlY3Rpb24uZm9jdXNPZmZzZXQKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0RXZlbnRUYXJnZXREb2N1bWVudChldmVudFRhcmdldCkgewogICAgICAgICAgcmV0dXJuIGV2ZW50VGFyZ2V0LndpbmRvdyA9PT0gZXZlbnRUYXJnZXQgPyBldmVudFRhcmdldC5kb2N1bWVudCA6IGV2ZW50VGFyZ2V0Lm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFID8gZXZlbnRUYXJnZXQgOiBldmVudFRhcmdldC5vd25lckRvY3VtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb25zdHJ1Y3RTZWxlY3RFdmVudChkaXNwYXRjaFF1ZXVlLCBuYXRpdmVFdmVudCwgbmF0aXZlRXZlbnRUYXJnZXQpIHsKICAgICAgICAgIHZhciBkb2MgPSBnZXRFdmVudFRhcmdldERvY3VtZW50KG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgIGlmIChtb3VzZURvd24gfHwgYWN0aXZlRWxlbWVudCQxID09IG51bGwgfHwgYWN0aXZlRWxlbWVudCQxICE9PSBnZXRBY3RpdmVFbGVtZW50KGRvYykpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnRTZWxlY3Rpb24gPSBnZXRTZWxlY3Rpb24kMShhY3RpdmVFbGVtZW50JDEpOwogICAgICAgICAgaWYgKCFsYXN0U2VsZWN0aW9uIHx8ICFzaGFsbG93RXF1YWwyKGxhc3RTZWxlY3Rpb24sIGN1cnJlbnRTZWxlY3Rpb24pKSB7CiAgICAgICAgICAgIGxhc3RTZWxlY3Rpb24gPSBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gYWNjdW11bGF0ZVR3b1BoYXNlTGlzdGVuZXJzKGFjdGl2ZUVsZW1lbnRJbnN0JDEsICJvblNlbGVjdCIpOwogICAgICAgICAgICBpZiAobGlzdGVuZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICB2YXIgZXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnQoIm9uU2VsZWN0IiwgInNlbGVjdCIsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgZXZlbnQudGFyZ2V0ID0gYWN0aXZlRWxlbWVudCQxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMkMyhkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgdGFyZ2V0Tm9kZSA9IHRhcmdldEluc3QgPyBnZXROb2RlRnJvbUluc3RhbmNlKHRhcmdldEluc3QpIDogd2luZG93OwogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAiZm9jdXNpbiI6CiAgICAgICAgICAgICAgaWYgKGlzVGV4dElucHV0RWxlbWVudCh0YXJnZXROb2RlKSB8fCB0YXJnZXROb2RlLmNvbnRlbnRFZGl0YWJsZSA9PT0gInRydWUiKSB7CiAgICAgICAgICAgICAgICBhY3RpdmVFbGVtZW50JDEgPSB0YXJnZXROb2RlOwogICAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudEluc3QkMSA9IHRhcmdldEluc3Q7CiAgICAgICAgICAgICAgICBsYXN0U2VsZWN0aW9uID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImZvY3Vzb3V0IjoKICAgICAgICAgICAgICBhY3RpdmVFbGVtZW50JDEgPSBudWxsOwogICAgICAgICAgICAgIGFjdGl2ZUVsZW1lbnRJbnN0JDEgPSBudWxsOwogICAgICAgICAgICAgIGxhc3RTZWxlY3Rpb24gPSBudWxsOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJtb3VzZWRvd24iOgogICAgICAgICAgICAgIG1vdXNlRG93biA9IHRydWU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImNvbnRleHRtZW51IjoKICAgICAgICAgICAgY2FzZSAibW91c2V1cCI6CiAgICAgICAgICAgIGNhc2UgImRyYWdlbmQiOgogICAgICAgICAgICAgIG1vdXNlRG93biA9IGZhbHNlOwogICAgICAgICAgICAgIGNvbnN0cnVjdFNlbGVjdEV2ZW50KGRpc3BhdGNoUXVldWUsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdGlvbmNoYW5nZSI6CiAgICAgICAgICAgICAgaWYgKHNraXBTZWxlY3Rpb25DaGFuZ2VFdmVudCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJrZXlkb3duIjoKICAgICAgICAgICAgY2FzZSAia2V5dXAiOgogICAgICAgICAgICAgIGNvbnN0cnVjdFNlbGVjdEV2ZW50KGRpc3BhdGNoUXVldWUsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1ha2VQcmVmaXhNYXAoc3R5bGVQcm9wLCBldmVudE5hbWUpIHsKICAgICAgICAgIHZhciBwcmVmaXhlczMgPSB7fTsKICAgICAgICAgIHByZWZpeGVzM1tzdHlsZVByb3AudG9Mb3dlckNhc2UoKV0gPSBldmVudE5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHByZWZpeGVzM1siV2Via2l0IiArIHN0eWxlUHJvcF0gPSAid2Via2l0IiArIGV2ZW50TmFtZTsKICAgICAgICAgIHByZWZpeGVzM1siTW96IiArIHN0eWxlUHJvcF0gPSAibW96IiArIGV2ZW50TmFtZTsKICAgICAgICAgIHJldHVybiBwcmVmaXhlczM7CiAgICAgICAgfQogICAgICAgIHZhciB2ZW5kb3JQcmVmaXhlcyA9IHsKICAgICAgICAgIGFuaW1hdGlvbmVuZDogbWFrZVByZWZpeE1hcCgiQW5pbWF0aW9uIiwgIkFuaW1hdGlvbkVuZCIpLAogICAgICAgICAgYW5pbWF0aW9uaXRlcmF0aW9uOiBtYWtlUHJlZml4TWFwKCJBbmltYXRpb24iLCAiQW5pbWF0aW9uSXRlcmF0aW9uIiksCiAgICAgICAgICBhbmltYXRpb25zdGFydDogbWFrZVByZWZpeE1hcCgiQW5pbWF0aW9uIiwgIkFuaW1hdGlvblN0YXJ0IiksCiAgICAgICAgICB0cmFuc2l0aW9uZW5kOiBtYWtlUHJlZml4TWFwKCJUcmFuc2l0aW9uIiwgIlRyYW5zaXRpb25FbmQiKQogICAgICAgIH07CiAgICAgICAgdmFyIHByZWZpeGVkRXZlbnROYW1lcyA9IHt9OwogICAgICAgIHZhciBzdHlsZSA9IHt9OwogICAgICAgIGlmIChjYW5Vc2VET00yKSB7CiAgICAgICAgICBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLnN0eWxlOwogICAgICAgICAgaWYgKCEoIkFuaW1hdGlvbkV2ZW50IiBpbiB3aW5kb3cpKSB7CiAgICAgICAgICAgIGRlbGV0ZSB2ZW5kb3JQcmVmaXhlcy5hbmltYXRpb25lbmQuYW5pbWF0aW9uOwogICAgICAgICAgICBkZWxldGUgdmVuZG9yUHJlZml4ZXMuYW5pbWF0aW9uaXRlcmF0aW9uLmFuaW1hdGlvbjsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLmFuaW1hdGlvbnN0YXJ0LmFuaW1hdGlvbjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghKCJUcmFuc2l0aW9uRXZlbnQiIGluIHdpbmRvdykpIHsKICAgICAgICAgICAgZGVsZXRlIHZlbmRvclByZWZpeGVzLnRyYW5zaXRpb25lbmQudHJhbnNpdGlvbjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0VmVuZG9yUHJlZml4ZWRFdmVudE5hbWUoZXZlbnROYW1lKSB7CiAgICAgICAgICBpZiAocHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV0pIHsKICAgICAgICAgICAgcmV0dXJuIHByZWZpeGVkRXZlbnROYW1lc1tldmVudE5hbWVdOwogICAgICAgICAgfSBlbHNlIGlmICghdmVuZG9yUHJlZml4ZXNbZXZlbnROYW1lXSkgewogICAgICAgICAgICByZXR1cm4gZXZlbnROYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZWZpeE1hcCA9IHZlbmRvclByZWZpeGVzW2V2ZW50TmFtZV07CiAgICAgICAgICBmb3IgKHZhciBzdHlsZVByb3AgaW4gcHJlZml4TWFwKSB7CiAgICAgICAgICAgIGlmIChwcmVmaXhNYXAuaGFzT3duUHJvcGVydHkoc3R5bGVQcm9wKSAmJiBzdHlsZVByb3AgaW4gc3R5bGUpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJlZml4ZWRFdmVudE5hbWVzW2V2ZW50TmFtZV0gPSBwcmVmaXhNYXBbc3R5bGVQcm9wXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGV2ZW50TmFtZTsKICAgICAgICB9CiAgICAgICAgdmFyIEFOSU1BVElPTl9FTkQgPSBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZSgiYW5pbWF0aW9uZW5kIik7CiAgICAgICAgdmFyIEFOSU1BVElPTl9JVEVSQVRJT04gPSBnZXRWZW5kb3JQcmVmaXhlZEV2ZW50TmFtZSgiYW5pbWF0aW9uaXRlcmF0aW9uIik7CiAgICAgICAgdmFyIEFOSU1BVElPTl9TVEFSVCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJhbmltYXRpb25zdGFydCIpOwogICAgICAgIHZhciBUUkFOU0lUSU9OX0VORCA9IGdldFZlbmRvclByZWZpeGVkRXZlbnROYW1lKCJ0cmFuc2l0aW9uZW5kIik7CiAgICAgICAgdmFyIHRvcExldmVsRXZlbnRzVG9SZWFjdE5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICB2YXIgc2ltcGxlRXZlbnRQbHVnaW5FdmVudHMgPSBbImFib3J0IiwgImF1eENsaWNrIiwgImNhbmNlbCIsICJjYW5QbGF5IiwgImNhblBsYXlUaHJvdWdoIiwgImNsaWNrIiwgImNsb3NlIiwgImNvbnRleHRNZW51IiwgImNvcHkiLCAiY3V0IiwgImRyYWciLCAiZHJhZ0VuZCIsICJkcmFnRW50ZXIiLCAiZHJhZ0V4aXQiLCAiZHJhZ0xlYXZlIiwgImRyYWdPdmVyIiwgImRyYWdTdGFydCIsICJkcm9wIiwgImR1cmF0aW9uQ2hhbmdlIiwgImVtcHRpZWQiLCAiZW5jcnlwdGVkIiwgImVuZGVkIiwgImVycm9yIiwgImdvdFBvaW50ZXJDYXB0dXJlIiwgImlucHV0IiwgImludmFsaWQiLCAia2V5RG93biIsICJrZXlQcmVzcyIsICJrZXlVcCIsICJsb2FkIiwgImxvYWRlZERhdGEiLCAibG9hZGVkTWV0YWRhdGEiLCAibG9hZFN0YXJ0IiwgImxvc3RQb2ludGVyQ2FwdHVyZSIsICJtb3VzZURvd24iLCAibW91c2VNb3ZlIiwgIm1vdXNlT3V0IiwgIm1vdXNlT3ZlciIsICJtb3VzZVVwIiwgInBhc3RlIiwgInBhdXNlIiwgInBsYXkiLCAicGxheWluZyIsICJwb2ludGVyQ2FuY2VsIiwgInBvaW50ZXJEb3duIiwgInBvaW50ZXJNb3ZlIiwgInBvaW50ZXJPdXQiLCAicG9pbnRlck92ZXIiLCAicG9pbnRlclVwIiwgInByb2dyZXNzIiwgInJhdGVDaGFuZ2UiLCAicmVzZXQiLCAicmVzaXplIiwgInNlZWtlZCIsICJzZWVraW5nIiwgInN0YWxsZWQiLCAic3VibWl0IiwgInN1c3BlbmQiLCAidGltZVVwZGF0ZSIsICJ0b3VjaENhbmNlbCIsICJ0b3VjaEVuZCIsICJ0b3VjaFN0YXJ0IiwgInZvbHVtZUNoYW5nZSIsICJzY3JvbGwiLCAidG9nZ2xlIiwgInRvdWNoTW92ZSIsICJ3YWl0aW5nIiwgIndoZWVsIl07CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTaW1wbGVFdmVudChkb21FdmVudE5hbWUsIHJlYWN0TmFtZSkgewogICAgICAgICAgdG9wTGV2ZWxFdmVudHNUb1JlYWN0TmFtZXMuc2V0KGRvbUV2ZW50TmFtZSwgcmVhY3ROYW1lKTsKICAgICAgICAgIHJlZ2lzdGVyVHdvUGhhc2VFdmVudChyZWFjdE5hbWUsIFtkb21FdmVudE5hbWVdKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVnaXN0ZXJTaW1wbGVFdmVudHMoKSB7CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNpbXBsZUV2ZW50UGx1Z2luRXZlbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHZhciBldmVudE5hbWUgPSBzaW1wbGVFdmVudFBsdWdpbkV2ZW50c1tpXTsKICAgICAgICAgICAgdmFyIGRvbUV2ZW50TmFtZSA9IGV2ZW50TmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB2YXIgY2FwaXRhbGl6ZWRFdmVudCA9IGV2ZW50TmFtZVswXS50b1VwcGVyQ2FzZSgpICsgZXZlbnROYW1lLnNsaWNlKDEpOwogICAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KGRvbUV2ZW50TmFtZSwgIm9uIiArIGNhcGl0YWxpemVkRXZlbnQpOwogICAgICAgICAgfQogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudChBTklNQVRJT05fRU5ELCAib25BbmltYXRpb25FbmQiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoQU5JTUFUSU9OX0lURVJBVElPTiwgIm9uQW5pbWF0aW9uSXRlcmF0aW9uIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KEFOSU1BVElPTl9TVEFSVCwgIm9uQW5pbWF0aW9uU3RhcnQiKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoImRibGNsaWNrIiwgIm9uRG91YmxlQ2xpY2siKTsKICAgICAgICAgIHJlZ2lzdGVyU2ltcGxlRXZlbnQoImZvY3VzaW4iLCAib25Gb2N1cyIpOwogICAgICAgICAgcmVnaXN0ZXJTaW1wbGVFdmVudCgiZm9jdXNvdXQiLCAib25CbHVyIik7CiAgICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50KFRSQU5TSVRJT05fRU5ELCAib25UcmFuc2l0aW9uRW5kIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGV4dHJhY3RFdmVudHMkNChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncywgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgcmVhY3ROYW1lID0gdG9wTGV2ZWxFdmVudHNUb1JlYWN0TmFtZXMuZ2V0KGRvbUV2ZW50TmFtZSk7CiAgICAgICAgICBpZiAocmVhY3ROYW1lID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0V2ZW50OwogICAgICAgICAgdmFyIHJlYWN0RXZlbnRUeXBlID0gZG9tRXZlbnROYW1lOwogICAgICAgICAgc3dpdGNoIChkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAia2V5cHJlc3MiOgogICAgICAgICAgICAgIGlmIChnZXRFdmVudENoYXJDb2RlKG5hdGl2ZUV2ZW50KSA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAia2V5ZG93biI6CiAgICAgICAgICAgIGNhc2UgImtleXVwIjoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNLZXlib2FyZEV2ZW50OwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJmb2N1c2luIjoKICAgICAgICAgICAgICByZWFjdEV2ZW50VHlwZSA9ICJmb2N1cyI7CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljRm9jdXNFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZm9jdXNvdXQiOgogICAgICAgICAgICAgIHJlYWN0RXZlbnRUeXBlID0gImJsdXIiOwogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0ZvY3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImJlZm9yZWJsdXIiOgogICAgICAgICAgICBjYXNlICJhZnRlcmJsdXIiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0ZvY3VzRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImNsaWNrIjoKICAgICAgICAgICAgICBpZiAobmF0aXZlRXZlbnQuYnV0dG9uID09PSAyKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJhdXhjbGljayI6CiAgICAgICAgICAgIGNhc2UgImRibGNsaWNrIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vkb3duIjoKICAgICAgICAgICAgY2FzZSAibW91c2Vtb3ZlIjoKICAgICAgICAgICAgY2FzZSAibW91c2V1cCI6CiAgICAgICAgICAgIGNhc2UgIm1vdXNlb3V0IjoKICAgICAgICAgICAgY2FzZSAibW91c2VvdmVyIjoKICAgICAgICAgICAgY2FzZSAiY29udGV4dG1lbnUiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY01vdXNlRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRyYWciOgogICAgICAgICAgICBjYXNlICJkcmFnZW5kIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2VudGVyIjoKICAgICAgICAgICAgY2FzZSAiZHJhZ2V4aXQiOgogICAgICAgICAgICBjYXNlICJkcmFnbGVhdmUiOgogICAgICAgICAgICBjYXNlICJkcmFnb3ZlciI6CiAgICAgICAgICAgIGNhc2UgImRyYWdzdGFydCI6CiAgICAgICAgICAgIGNhc2UgImRyb3AiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY0RyYWdFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidG91Y2hjYW5jZWwiOgogICAgICAgICAgICBjYXNlICJ0b3VjaGVuZCI6CiAgICAgICAgICAgIGNhc2UgInRvdWNobW92ZSI6CiAgICAgICAgICAgIGNhc2UgInRvdWNoc3RhcnQiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1RvdWNoRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQU5JTUFUSU9OX0VORDoKICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fSVRFUkFUSU9OOgogICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9TVEFSVDoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNBbmltYXRpb25FdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBUUkFOU0lUSU9OX0VORDoKICAgICAgICAgICAgICBTeW50aGV0aWNFdmVudEN0b3IgPSBTeW50aGV0aWNUcmFuc2l0aW9uRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNjcm9sbCI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljVUlFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAid2hlZWwiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1doZWVsRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImNvcHkiOgogICAgICAgICAgICBjYXNlICJjdXQiOgogICAgICAgICAgICBjYXNlICJwYXN0ZSI6CiAgICAgICAgICAgICAgU3ludGhldGljRXZlbnRDdG9yID0gU3ludGhldGljQ2xpcGJvYXJkRXZlbnQ7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImdvdHBvaW50ZXJjYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAibG9zdHBvaW50ZXJjYXB0dXJlIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcmNhbmNlbCI6CiAgICAgICAgICAgIGNhc2UgInBvaW50ZXJkb3duIjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm1vdmUiOgogICAgICAgICAgICBjYXNlICJwb2ludGVyb3V0IjoKICAgICAgICAgICAgY2FzZSAicG9pbnRlcm92ZXIiOgogICAgICAgICAgICBjYXNlICJwb2ludGVydXAiOgogICAgICAgICAgICAgIFN5bnRoZXRpY0V2ZW50Q3RvciA9IFN5bnRoZXRpY1BvaW50ZXJFdmVudDsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbkNhcHR1cmVQaGFzZSA9IChldmVudFN5c3RlbUZsYWdzICYgSVNfQ0FQVFVSRV9QSEFTRSkgIT09IDA7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBhY2N1bXVsYXRlVGFyZ2V0T25seSA9ICFpbkNhcHR1cmVQaGFzZSAmJiAvLyBUT0RPOiBpZGVhbGx5LCB3ZSdkIGV2ZW50dWFsbHkgYWRkIGFsbCBldmVudHMgZnJvbQogICAgICAgICAgICAvLyBub25EZWxlZ2F0ZWRFdmVudHMgbGlzdCBpbiBET01QbHVnaW5FdmVudFN5c3RlbS4KICAgICAgICAgICAgLy8gVGhlbiB3ZSBjYW4gcmVtb3ZlIHRoaXMgc3BlY2lhbCBsaXN0LgogICAgICAgICAgICAvLyBUaGlzIGlzIGEgYnJlYWtpbmcgY2hhbmdlIHRoYXQgY2FuIHdhaXQgdW50aWwgUmVhY3QgMTguCiAgICAgICAgICAgIGRvbUV2ZW50TmFtZSA9PT0gInNjcm9sbCI7CiAgICAgICAgICAgIHZhciBfbGlzdGVuZXJzID0gYWNjdW11bGF0ZVNpbmdsZVBoYXNlTGlzdGVuZXJzKHRhcmdldEluc3QsIHJlYWN0TmFtZSwgbmF0aXZlRXZlbnQudHlwZSwgaW5DYXB0dXJlUGhhc2UsIGFjY3VtdWxhdGVUYXJnZXRPbmx5KTsKICAgICAgICAgICAgaWYgKF9saXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHZhciBfZXZlbnQgPSBuZXcgU3ludGhldGljRXZlbnRDdG9yKHJlYWN0TmFtZSwgcmVhY3RFdmVudFR5cGUsIG51bGwsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICAgICAgZGlzcGF0Y2hRdWV1ZS5wdXNoKHsKICAgICAgICAgICAgICAgIGV2ZW50OiBfZXZlbnQsCiAgICAgICAgICAgICAgICBsaXN0ZW5lcnM6IF9saXN0ZW5lcnMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZWdpc3RlclNpbXBsZUV2ZW50cygpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzJDIoKTsKICAgICAgICByZWdpc3RlckV2ZW50cyQxKCk7CiAgICAgICAgcmVnaXN0ZXJFdmVudHMkMygpOwogICAgICAgIHJlZ2lzdGVyRXZlbnRzKCk7CiAgICAgICAgZnVuY3Rpb24gZXh0cmFjdEV2ZW50cyQ1KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIGV4dHJhY3RFdmVudHMkNChkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgICB2YXIgc2hvdWxkUHJvY2Vzc1BvbHlmaWxsUGx1Z2lucyA9IChldmVudFN5c3RlbUZsYWdzICYgU0hPVUxEX05PVF9QUk9DRVNTX1BPTFlGSUxMX0VWRU5UX1BMVUdJTlMpID09PSAwOwogICAgICAgICAgaWYgKHNob3VsZFByb2Nlc3NQb2x5ZmlsbFBsdWdpbnMpIHsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQyKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQxKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyQzKGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0KTsKICAgICAgICAgICAgZXh0cmFjdEV2ZW50cyhkaXNwYXRjaFF1ZXVlLCBkb21FdmVudE5hbWUsIHRhcmdldEluc3QsIG5hdGl2ZUV2ZW50LCBuYXRpdmVFdmVudFRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBtZWRpYUV2ZW50VHlwZXMgPSBbImFib3J0IiwgImNhbnBsYXkiLCAiY2FucGxheXRocm91Z2giLCAiZHVyYXRpb25jaGFuZ2UiLCAiZW1wdGllZCIsICJlbmNyeXB0ZWQiLCAiZW5kZWQiLCAiZXJyb3IiLCAibG9hZGVkZGF0YSIsICJsb2FkZWRtZXRhZGF0YSIsICJsb2Fkc3RhcnQiLCAicGF1c2UiLCAicGxheSIsICJwbGF5aW5nIiwgInByb2dyZXNzIiwgInJhdGVjaGFuZ2UiLCAicmVzaXplIiwgInNlZWtlZCIsICJzZWVraW5nIiwgInN0YWxsZWQiLCAic3VzcGVuZCIsICJ0aW1ldXBkYXRlIiwgInZvbHVtZWNoYW5nZSIsICJ3YWl0aW5nIl07CiAgICAgICAgdmFyIG5vbkRlbGVnYXRlZEV2ZW50cyA9IG5ldyBTZXQoWyJjYW5jZWwiLCAiY2xvc2UiLCAiaW52YWxpZCIsICJsb2FkIiwgInNjcm9sbCIsICJ0b2dnbGUiXS5jb25jYXQobWVkaWFFdmVudFR5cGVzKSk7CiAgICAgICAgZnVuY3Rpb24gZXhlY3V0ZURpc3BhdGNoKGV2ZW50LCBsaXN0ZW5lcjIsIGN1cnJlbnRUYXJnZXQpIHsKICAgICAgICAgIHZhciB0eXBlID0gZXZlbnQudHlwZSB8fCAidW5rbm93bi1ldmVudCI7CiAgICAgICAgICBldmVudC5jdXJyZW50VGFyZ2V0ID0gY3VycmVudFRhcmdldDsKICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFja0FuZENhdGNoRmlyc3RFcnJvcih0eXBlLCBsaXN0ZW5lcjIsIHZvaWQgMCwgZXZlbnQpOwogICAgICAgICAgZXZlbnQuY3VycmVudFRhcmdldCA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb2Nlc3NEaXNwYXRjaFF1ZXVlSXRlbXNJbk9yZGVyKGV2ZW50LCBkaXNwYXRjaExpc3RlbmVycywgaW5DYXB0dXJlUGhhc2UpIHsKICAgICAgICAgIHZhciBwcmV2aW91c0luc3RhbmNlOwogICAgICAgICAgaWYgKGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBkaXNwYXRjaExpc3RlbmVycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICAgIHZhciBfZGlzcGF0Y2hMaXN0ZW5lcnMkaSA9IGRpc3BhdGNoTGlzdGVuZXJzW2ldLCBpbnN0YW5jZSA9IF9kaXNwYXRjaExpc3RlbmVycyRpLmluc3RhbmNlLCBjdXJyZW50VGFyZ2V0ID0gX2Rpc3BhdGNoTGlzdGVuZXJzJGkuY3VycmVudFRhcmdldCwgbGlzdGVuZXIyID0gX2Rpc3BhdGNoTGlzdGVuZXJzJGkubGlzdGVuZXI7CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBwcmV2aW91c0luc3RhbmNlICYmIGV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZXhlY3V0ZURpc3BhdGNoKGV2ZW50LCBsaXN0ZW5lcjIsIGN1cnJlbnRUYXJnZXQpOwogICAgICAgICAgICAgIHByZXZpb3VzSW5zdGFuY2UgPSBpbnN0YW5jZTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IGRpc3BhdGNoTGlzdGVuZXJzLmxlbmd0aDsgX2krKykgewogICAgICAgICAgICAgIHZhciBfZGlzcGF0Y2hMaXN0ZW5lcnMkX2kgPSBkaXNwYXRjaExpc3RlbmVyc1tfaV0sIF9pbnN0YW5jZSA9IF9kaXNwYXRjaExpc3RlbmVycyRfaS5pbnN0YW5jZSwgX2N1cnJlbnRUYXJnZXQgPSBfZGlzcGF0Y2hMaXN0ZW5lcnMkX2kuY3VycmVudFRhcmdldCwgX2xpc3RlbmVyID0gX2Rpc3BhdGNoTGlzdGVuZXJzJF9pLmxpc3RlbmVyOwogICAgICAgICAgICAgIGlmIChfaW5zdGFuY2UgIT09IHByZXZpb3VzSW5zdGFuY2UgJiYgZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBleGVjdXRlRGlzcGF0Y2goZXZlbnQsIF9saXN0ZW5lciwgX2N1cnJlbnRUYXJnZXQpOwogICAgICAgICAgICAgIHByZXZpb3VzSW5zdGFuY2UgPSBfaW5zdGFuY2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc0Rpc3BhdGNoUXVldWUoZGlzcGF0Y2hRdWV1ZSwgZXZlbnRTeXN0ZW1GbGFncykgewogICAgICAgICAgdmFyIGluQ2FwdHVyZVBoYXNlID0gKGV2ZW50U3lzdGVtRmxhZ3MgJiBJU19DQVBUVVJFX1BIQVNFKSAhPT0gMDsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGlzcGF0Y2hRdWV1ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB2YXIgX2Rpc3BhdGNoUXVldWUkaSA9IGRpc3BhdGNoUXVldWVbaV0sIGV2ZW50ID0gX2Rpc3BhdGNoUXVldWUkaS5ldmVudCwgbGlzdGVuZXJzID0gX2Rpc3BhdGNoUXVldWUkaS5saXN0ZW5lcnM7CiAgICAgICAgICAgIHByb2Nlc3NEaXNwYXRjaFF1ZXVlSXRlbXNJbk9yZGVyKGV2ZW50LCBsaXN0ZW5lcnMsIGluQ2FwdHVyZVBoYXNlKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldGhyb3dDYXVnaHRFcnJvcigpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50c0ZvclBsdWdpbnMoZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgbmF0aXZlRXZlbnRUYXJnZXQgPSBnZXRFdmVudFRhcmdldChuYXRpdmVFdmVudCk7CiAgICAgICAgICB2YXIgZGlzcGF0Y2hRdWV1ZSA9IFtdOwogICAgICAgICAgZXh0cmFjdEV2ZW50cyQ1KGRpc3BhdGNoUXVldWUsIGRvbUV2ZW50TmFtZSwgdGFyZ2V0SW5zdCwgbmF0aXZlRXZlbnQsIG5hdGl2ZUV2ZW50VGFyZ2V0LCBldmVudFN5c3RlbUZsYWdzKTsKICAgICAgICAgIHByb2Nlc3NEaXNwYXRjaFF1ZXVlKGRpc3BhdGNoUXVldWUsIGV2ZW50U3lzdGVtRmxhZ3MpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KGRvbUV2ZW50TmFtZSwgdGFyZ2V0RWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoIW5vbkRlbGVnYXRlZEV2ZW50cy5oYXMoZG9tRXZlbnROYW1lKSkgewogICAgICAgICAgICAgIGVycm9yKCdEaWQgbm90IGV4cGVjdCBhIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoKSBjYWxsIGZvciAiJXMiLiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4nLCBkb21FdmVudE5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lciA9IGZhbHNlOwogICAgICAgICAgdmFyIGxpc3RlbmVyU2V0ID0gZ2V0RXZlbnRMaXN0ZW5lclNldCh0YXJnZXRFbGVtZW50KTsKICAgICAgICAgIHZhciBsaXN0ZW5lclNldEtleSA9IGdldExpc3RlbmVyU2V0S2V5KGRvbUV2ZW50TmFtZSwgaXNDYXB0dXJlUGhhc2VMaXN0ZW5lcik7CiAgICAgICAgICBpZiAoIWxpc3RlbmVyU2V0LmhhcyhsaXN0ZW5lclNldEtleSkpIHsKICAgICAgICAgICAgYWRkVHJhcHBlZEV2ZW50TGlzdGVuZXIodGFyZ2V0RWxlbWVudCwgZG9tRXZlbnROYW1lLCBJU19OT05fREVMRUdBVEVELCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKTsKICAgICAgICAgICAgbGlzdGVuZXJTZXQuYWRkKGxpc3RlbmVyU2V0S2V5KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGlzdGVuVG9OYXRpdmVFdmVudChkb21FdmVudE5hbWUsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIsIHRhcmdldCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAobm9uRGVsZWdhdGVkRXZlbnRzLmhhcyhkb21FdmVudE5hbWUpICYmICFpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ0RpZCBub3QgZXhwZWN0IGEgbGlzdGVuVG9OYXRpdmVFdmVudCgpIGNhbGwgZm9yICIlcyIgaW4gdGhlIGJ1YmJsZSBwaGFzZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuJywgZG9tRXZlbnROYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50U3lzdGVtRmxhZ3MgPSAwOwogICAgICAgICAgaWYgKGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpIHsKICAgICAgICAgICAgZXZlbnRTeXN0ZW1GbGFncyB8PSBJU19DQVBUVVJFX1BIQVNFOwogICAgICAgICAgfQogICAgICAgICAgYWRkVHJhcHBlZEV2ZW50TGlzdGVuZXIodGFyZ2V0LCBkb21FdmVudE5hbWUsIGV2ZW50U3lzdGVtRmxhZ3MsIGlzQ2FwdHVyZVBoYXNlTGlzdGVuZXIpOwogICAgICAgIH0KICAgICAgICB2YXIgbGlzdGVuaW5nTWFya2VyID0gIl9yZWFjdExpc3RlbmluZyIgKyBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zbGljZSgyKTsKICAgICAgICBmdW5jdGlvbiBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhyb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgaWYgKCFyb290Q29udGFpbmVyRWxlbWVudFtsaXN0ZW5pbmdNYXJrZXJdKSB7CiAgICAgICAgICAgIHJvb3RDb250YWluZXJFbGVtZW50W2xpc3RlbmluZ01hcmtlcl0gPSB0cnVlOwogICAgICAgICAgICBhbGxOYXRpdmVFdmVudHMuZm9yRWFjaChmdW5jdGlvbihkb21FdmVudE5hbWUpIHsKICAgICAgICAgICAgICBpZiAoZG9tRXZlbnROYW1lICE9PSAic2VsZWN0aW9uY2hhbmdlIikgewogICAgICAgICAgICAgICAgaWYgKCFub25EZWxlZ2F0ZWRFdmVudHMuaGFzKGRvbUV2ZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuVG9OYXRpdmVFdmVudChkb21FdmVudE5hbWUsIGZhbHNlLCByb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05hdGl2ZUV2ZW50KGRvbUV2ZW50TmFtZSwgdHJ1ZSwgcm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHZhciBvd25lckRvY3VtZW50ID0gcm9vdENvbnRhaW5lckVsZW1lbnQubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUgPyByb290Q29udGFpbmVyRWxlbWVudCA6IHJvb3RDb250YWluZXJFbGVtZW50Lm93bmVyRG9jdW1lbnQ7CiAgICAgICAgICAgIGlmIChvd25lckRvY3VtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKCFvd25lckRvY3VtZW50W2xpc3RlbmluZ01hcmtlcl0pIHsKICAgICAgICAgICAgICAgIG93bmVyRG9jdW1lbnRbbGlzdGVuaW5nTWFya2VyXSA9IHRydWU7CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05hdGl2ZUV2ZW50KCJzZWxlY3Rpb25jaGFuZ2UiLCBmYWxzZSwgb3duZXJEb2N1bWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFkZFRyYXBwZWRFdmVudExpc3RlbmVyKHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBpc0NhcHR1cmVQaGFzZUxpc3RlbmVyLCBpc0RlZmVycmVkTGlzdGVuZXJGb3JMZWdhY3lGQlN1cHBvcnQpIHsKICAgICAgICAgIHZhciBsaXN0ZW5lcjIgPSBjcmVhdGVFdmVudExpc3RlbmVyV3JhcHBlcldpdGhQcmlvcml0eSh0YXJnZXRDb250YWluZXIsIGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncyk7CiAgICAgICAgICB2YXIgaXNQYXNzaXZlTGlzdGVuZXIgPSB2b2lkIDA7CiAgICAgICAgICBpZiAocGFzc2l2ZUJyb3dzZXJFdmVudHNTdXBwb3J0ZWQpIHsKICAgICAgICAgICAgaWYgKGRvbUV2ZW50TmFtZSA9PT0gInRvdWNoc3RhcnQiIHx8IGRvbUV2ZW50TmFtZSA9PT0gInRvdWNobW92ZSIgfHwgZG9tRXZlbnROYW1lID09PSAid2hlZWwiKSB7CiAgICAgICAgICAgICAgaXNQYXNzaXZlTGlzdGVuZXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0YXJnZXRDb250YWluZXIgPSB0YXJnZXRDb250YWluZXI7CiAgICAgICAgICB2YXIgdW5zdWJzY3JpYmVMaXN0ZW5lcjsKICAgICAgICAgIGlmIChpc0NhcHR1cmVQaGFzZUxpc3RlbmVyKSB7CiAgICAgICAgICAgIGlmIChpc1Bhc3NpdmVMaXN0ZW5lciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdW5zdWJzY3JpYmVMaXN0ZW5lciA9IGFkZEV2ZW50Q2FwdHVyZUxpc3RlbmVyV2l0aFBhc3NpdmVGbGFnKHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBsaXN0ZW5lcjIsIGlzUGFzc2l2ZUxpc3RlbmVyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1bnN1YnNjcmliZUxpc3RlbmVyID0gYWRkRXZlbnRDYXB0dXJlTGlzdGVuZXIodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChpc1Bhc3NpdmVMaXN0ZW5lciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdW5zdWJzY3JpYmVMaXN0ZW5lciA9IGFkZEV2ZW50QnViYmxlTGlzdGVuZXJXaXRoUGFzc2l2ZUZsYWcodGFyZ2V0Q29udGFpbmVyLCBkb21FdmVudE5hbWUsIGxpc3RlbmVyMiwgaXNQYXNzaXZlTGlzdGVuZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVuc3Vic2NyaWJlTGlzdGVuZXIgPSBhZGRFdmVudEJ1YmJsZUxpc3RlbmVyKHRhcmdldENvbnRhaW5lciwgZG9tRXZlbnROYW1lLCBsaXN0ZW5lcjIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzTWF0Y2hpbmdSb290Q29udGFpbmVyKGdyYW5kQ29udGFpbmVyLCB0YXJnZXRDb250YWluZXIpIHsKICAgICAgICAgIHJldHVybiBncmFuZENvbnRhaW5lciA9PT0gdGFyZ2V0Q29udGFpbmVyIHx8IGdyYW5kQ29udGFpbmVyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgJiYgZ3JhbmRDb250YWluZXIucGFyZW50Tm9kZSA9PT0gdGFyZ2V0Q29udGFpbmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNwYXRjaEV2ZW50Rm9yUGx1Z2luRXZlbnRTeXN0ZW0oZG9tRXZlbnROYW1lLCBldmVudFN5c3RlbUZsYWdzLCBuYXRpdmVFdmVudCwgdGFyZ2V0SW5zdCwgdGFyZ2V0Q29udGFpbmVyKSB7CiAgICAgICAgICB2YXIgYW5jZXN0b3JJbnN0ID0gdGFyZ2V0SW5zdDsKICAgICAgICAgIGlmICgoZXZlbnRTeXN0ZW1GbGFncyAmIElTX0VWRU5UX0hBTkRMRV9OT05fTUFOQUdFRF9OT0RFKSA9PT0gMCAmJiAoZXZlbnRTeXN0ZW1GbGFncyAmIElTX05PTl9ERUxFR0FURUQpID09PSAwKSB7CiAgICAgICAgICAgIHZhciB0YXJnZXRDb250YWluZXJOb2RlID0gdGFyZ2V0Q29udGFpbmVyOwogICAgICAgICAgICBpZiAodGFyZ2V0SW5zdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBub2RlID0gdGFyZ2V0SW5zdDsKICAgICAgICAgICAgICBtYWluTG9vcDogd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBub2RlVGFnID0gbm9kZS50YWc7CiAgICAgICAgICAgICAgICBpZiAobm9kZVRhZyA9PT0gSG9zdFJvb3QgfHwgbm9kZVRhZyA9PT0gSG9zdFBvcnRhbCkgewogICAgICAgICAgICAgICAgICB2YXIgY29udGFpbmVyMiA9IG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICAgIGlmIChpc01hdGNoaW5nUm9vdENvbnRhaW5lcihjb250YWluZXIyLCB0YXJnZXRDb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmIChub2RlVGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGdyYW5kTm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgICAgICAgIHdoaWxlIChncmFuZE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBncmFuZFRhZyA9IGdyYW5kTm9kZS50YWc7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZ3JhbmRUYWcgPT09IEhvc3RSb290IHx8IGdyYW5kVGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBncmFuZENvbnRhaW5lciA9IGdyYW5kTm9kZS5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzTWF0Y2hpbmdSb290Q29udGFpbmVyKGdyYW5kQ29udGFpbmVyLCB0YXJnZXRDb250YWluZXJOb2RlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgZ3JhbmROb2RlID0gZ3JhbmROb2RlLnJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgd2hpbGUgKGNvbnRhaW5lcjIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnROb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRUYWcgPSBwYXJlbnROb2RlLnRhZzsKICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50VGFnID09PSBIb3N0Q29tcG9uZW50IHx8IHBhcmVudFRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICAgICAgICAgIG5vZGUgPSBhbmNlc3Rvckluc3QgPSBwYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgICAgY29udGludWUgbWFpbkxvb3A7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lcjIgPSBjb250YWluZXIyLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGJhdGNoZWRVcGRhdGVzKGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZGlzcGF0Y2hFdmVudHNGb3JQbHVnaW5zKGRvbUV2ZW50TmFtZSwgZXZlbnRTeXN0ZW1GbGFncywgbmF0aXZlRXZlbnQsIGFuY2VzdG9ySW5zdCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgbGlzdGVuZXIyLCBjdXJyZW50VGFyZ2V0KSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBpbnN0YW5jZSwKICAgICAgICAgICAgbGlzdGVuZXI6IGxpc3RlbmVyMiwKICAgICAgICAgICAgY3VycmVudFRhcmdldAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYWNjdW11bGF0ZVNpbmdsZVBoYXNlTGlzdGVuZXJzKHRhcmdldEZpYmVyLCByZWFjdE5hbWUsIG5hdGl2ZUV2ZW50VHlwZSwgaW5DYXB0dXJlUGhhc2UsIGFjY3VtdWxhdGVUYXJnZXRPbmx5LCBuYXRpdmVFdmVudCkgewogICAgICAgICAgdmFyIGNhcHR1cmVOYW1lID0gcmVhY3ROYW1lICE9PSBudWxsID8gcmVhY3ROYW1lICsgIkNhcHR1cmUiIDogbnVsbDsKICAgICAgICAgIHZhciByZWFjdEV2ZW50TmFtZSA9IGluQ2FwdHVyZVBoYXNlID8gY2FwdHVyZU5hbWUgOiByZWFjdE5hbWU7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXRGaWJlcjsKICAgICAgICAgIHZhciBsYXN0SG9zdENvbXBvbmVudCA9IG51bGw7CiAgICAgICAgICB3aGlsZSAoaW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTIgPSBpbnN0YW5jZSwgc3RhdGVOb2RlID0gX2luc3RhbmNlMi5zdGF0ZU5vZGUsIHRhZyA9IF9pbnN0YW5jZTIudGFnOwogICAgICAgICAgICBpZiAodGFnID09PSBIb3N0Q29tcG9uZW50ICYmIHN0YXRlTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGxhc3RIb3N0Q29tcG9uZW50ID0gc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmIChyZWFjdEV2ZW50TmFtZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGxpc3RlbmVyMiA9IGdldExpc3RlbmVyKGluc3RhbmNlLCByZWFjdEV2ZW50TmFtZSk7CiAgICAgICAgICAgICAgICBpZiAobGlzdGVuZXIyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzLnB1c2goY3JlYXRlRGlzcGF0Y2hMaXN0ZW5lcihpbnN0YW5jZSwgbGlzdGVuZXIyLCBsYXN0SG9zdENvbXBvbmVudCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYWNjdW11bGF0ZVRhcmdldE9ubHkpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsaXN0ZW5lcnM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVUd29QaGFzZUxpc3RlbmVycyh0YXJnZXRGaWJlciwgcmVhY3ROYW1lKSB7CiAgICAgICAgICB2YXIgY2FwdHVyZU5hbWUgPSByZWFjdE5hbWUgKyAiQ2FwdHVyZSI7CiAgICAgICAgICB2YXIgbGlzdGVuZXJzID0gW107CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB0YXJnZXRGaWJlcjsKICAgICAgICAgIHdoaWxlIChpbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgX2luc3RhbmNlMyA9IGluc3RhbmNlLCBzdGF0ZU5vZGUgPSBfaW5zdGFuY2UzLnN0YXRlTm9kZSwgdGFnID0gX2luc3RhbmNlMy50YWc7CiAgICAgICAgICAgIGlmICh0YWcgPT09IEhvc3RDb21wb25lbnQgJiYgc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRUYXJnZXQgPSBzdGF0ZU5vZGU7CiAgICAgICAgICAgICAgdmFyIGNhcHR1cmVMaXN0ZW5lciA9IGdldExpc3RlbmVyKGluc3RhbmNlLCBjYXB0dXJlTmFtZSk7CiAgICAgICAgICAgICAgaWYgKGNhcHR1cmVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5lcnMudW5zaGlmdChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBjYXB0dXJlTGlzdGVuZXIsIGN1cnJlbnRUYXJnZXQpKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGJ1YmJsZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlYWN0TmFtZSk7CiAgICAgICAgICAgICAgaWYgKGJ1YmJsZUxpc3RlbmVyICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGxpc3RlbmVycy5wdXNoKGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGJ1YmJsZUxpc3RlbmVyLCBjdXJyZW50VGFyZ2V0KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2UucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxpc3RlbmVyczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UGFyZW50KGluc3QpIHsKICAgICAgICAgIGlmIChpbnN0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZG8gewogICAgICAgICAgICBpbnN0ID0gaW5zdC5yZXR1cm47CiAgICAgICAgICB9IHdoaWxlIChpbnN0ICYmIGluc3QudGFnICE9PSBIb3N0Q29tcG9uZW50KTsKICAgICAgICAgIGlmIChpbnN0KSB7CiAgICAgICAgICAgIHJldHVybiBpbnN0OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExvd2VzdENvbW1vbkFuY2VzdG9yKGluc3RBLCBpbnN0QikgewogICAgICAgICAgdmFyIG5vZGVBID0gaW5zdEE7CiAgICAgICAgICB2YXIgbm9kZUIgPSBpbnN0QjsKICAgICAgICAgIHZhciBkZXB0aEEgPSAwOwogICAgICAgICAgZm9yICh2YXIgdGVtcEEgPSBub2RlQTsgdGVtcEE7IHRlbXBBID0gZ2V0UGFyZW50KHRlbXBBKSkgewogICAgICAgICAgICBkZXB0aEErKzsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkZXB0aEIgPSAwOwogICAgICAgICAgZm9yICh2YXIgdGVtcEIgPSBub2RlQjsgdGVtcEI7IHRlbXBCID0gZ2V0UGFyZW50KHRlbXBCKSkgewogICAgICAgICAgICBkZXB0aEIrKzsKICAgICAgICAgIH0KICAgICAgICAgIHdoaWxlIChkZXB0aEEgLSBkZXB0aEIgPiAwKSB7CiAgICAgICAgICAgIG5vZGVBID0gZ2V0UGFyZW50KG5vZGVBKTsKICAgICAgICAgICAgZGVwdGhBLS07CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoZGVwdGhCIC0gZGVwdGhBID4gMCkgewogICAgICAgICAgICBub2RlQiA9IGdldFBhcmVudChub2RlQik7CiAgICAgICAgICAgIGRlcHRoQi0tOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRlcHRoID0gZGVwdGhBOwogICAgICAgICAgd2hpbGUgKGRlcHRoLS0pIHsKICAgICAgICAgICAgaWYgKG5vZGVBID09PSBub2RlQiB8fCBub2RlQiAhPT0gbnVsbCAmJiBub2RlQSA9PT0gbm9kZUIuYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGVBOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGVBID0gZ2V0UGFyZW50KG5vZGVBKTsKICAgICAgICAgICAgbm9kZUIgPSBnZXRQYXJlbnQobm9kZUIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFjY3VtdWxhdGVFbnRlckxlYXZlTGlzdGVuZXJzRm9yRXZlbnQoZGlzcGF0Y2hRdWV1ZSwgZXZlbnQsIHRhcmdldCwgY29tbW9uLCBpbkNhcHR1cmVQaGFzZSkgewogICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbk5hbWUgPSBldmVudC5fcmVhY3ROYW1lOwogICAgICAgICAgdmFyIGxpc3RlbmVycyA9IFtdOwogICAgICAgICAgdmFyIGluc3RhbmNlID0gdGFyZ2V0OwogICAgICAgICAgd2hpbGUgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChpbnN0YW5jZSA9PT0gY29tbW9uKSB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9pbnN0YW5jZTQgPSBpbnN0YW5jZSwgYWx0ZXJuYXRlID0gX2luc3RhbmNlNC5hbHRlcm5hdGUsIHN0YXRlTm9kZSA9IF9pbnN0YW5jZTQuc3RhdGVOb2RlLCB0YWcgPSBfaW5zdGFuY2U0LnRhZzsKICAgICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCAmJiBhbHRlcm5hdGUgPT09IGNvbW1vbikgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09IEhvc3RDb21wb25lbnQgJiYgc3RhdGVOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRUYXJnZXQgPSBzdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKGluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FwdHVyZUxpc3RlbmVyID0gZ2V0TGlzdGVuZXIoaW5zdGFuY2UsIHJlZ2lzdHJhdGlvbk5hbWUpOwogICAgICAgICAgICAgICAgaWYgKGNhcHR1cmVMaXN0ZW5lciAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlbmVycy51bnNoaWZ0KGNyZWF0ZURpc3BhdGNoTGlzdGVuZXIoaW5zdGFuY2UsIGNhcHR1cmVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWluQ2FwdHVyZVBoYXNlKSB7CiAgICAgICAgICAgICAgICB2YXIgYnViYmxlTGlzdGVuZXIgPSBnZXRMaXN0ZW5lcihpbnN0YW5jZSwgcmVnaXN0cmF0aW9uTmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoYnViYmxlTGlzdGVuZXIgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsaXN0ZW5lcnMucHVzaChjcmVhdGVEaXNwYXRjaExpc3RlbmVyKGluc3RhbmNlLCBidWJibGVMaXN0ZW5lciwgY3VycmVudFRhcmdldCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0YW5jZSA9IGluc3RhbmNlLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoICE9PSAwKSB7CiAgICAgICAgICAgIGRpc3BhdGNoUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgbGlzdGVuZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhY2N1bXVsYXRlRW50ZXJMZWF2ZVR3b1BoYXNlTGlzdGVuZXJzKGRpc3BhdGNoUXVldWUsIGxlYXZlRXZlbnQsIGVudGVyRXZlbnQsIGZyb20yLCB0bzIpIHsKICAgICAgICAgIHZhciBjb21tb24gPSBmcm9tMiAmJiB0bzIgPyBnZXRMb3dlc3RDb21tb25BbmNlc3Rvcihmcm9tMiwgdG8yKSA6IG51bGw7CiAgICAgICAgICBpZiAoZnJvbTIgIT09IG51bGwpIHsKICAgICAgICAgICAgYWNjdW11bGF0ZUVudGVyTGVhdmVMaXN0ZW5lcnNGb3JFdmVudChkaXNwYXRjaFF1ZXVlLCBsZWF2ZUV2ZW50LCBmcm9tMiwgY29tbW9uLCBmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodG8yICE9PSBudWxsICYmIGVudGVyRXZlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgYWNjdW11bGF0ZUVudGVyTGVhdmVMaXN0ZW5lcnNGb3JFdmVudChkaXNwYXRjaFF1ZXVlLCBlbnRlckV2ZW50LCB0bzIsIGNvbW1vbiwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExpc3RlbmVyU2V0S2V5KGRvbUV2ZW50TmFtZSwgY2FwdHVyZSkgewogICAgICAgICAgcmV0dXJuIGRvbUV2ZW50TmFtZSArICJfXyIgKyAoY2FwdHVyZSA/ICJjYXB0dXJlIiA6ICJidWJibGUiKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gZmFsc2U7CiAgICAgICAgdmFyIERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MID0gImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIjsKICAgICAgICB2YXIgU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HID0gInN1cHByZXNzQ29udGVudEVkaXRhYmxlV2FybmluZyI7CiAgICAgICAgdmFyIFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HID0gInN1cHByZXNzSHlkcmF0aW9uV2FybmluZyI7CiAgICAgICAgdmFyIEFVVE9GT0NVUyA9ICJhdXRvRm9jdXMiOwogICAgICAgIHZhciBDSElMRFJFTiA9ICJjaGlsZHJlbiI7CiAgICAgICAgdmFyIFNUWUxFID0gInN0eWxlIjsKICAgICAgICB2YXIgSFRNTCQxID0gIl9faHRtbCI7CiAgICAgICAgdmFyIHdhcm5lZFVua25vd25UYWdzOwogICAgICAgIHZhciB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50OwogICAgICAgIHZhciB3YXJuRm9yUHJvcERpZmZlcmVuY2U7CiAgICAgICAgdmFyIHdhcm5Gb3JFeHRyYUF0dHJpYnV0ZXM7CiAgICAgICAgdmFyIHdhcm5Gb3JJbnZhbGlkRXZlbnRMaXN0ZW5lcjsKICAgICAgICB2YXIgY2FuRGlmZlN0eWxlRm9ySHlkcmF0aW9uV2FybmluZzsKICAgICAgICB2YXIgbm9ybWFsaXplSFRNTDsKICAgICAgICB7CiAgICAgICAgICB3YXJuZWRVbmtub3duVGFncyA9IHsKICAgICAgICAgICAgLy8gVGhlcmUgYXJlIHdvcmtpbmcgcG9seWZpbGxzIGZvciA8ZGlhbG9nPi4gTGV0IHBlb3BsZSB1c2UgaXQuCiAgICAgICAgICAgIGRpYWxvZzogdHJ1ZSwKICAgICAgICAgICAgLy8gRWxlY3Ryb24gc2hpcHMgYSBjdXN0b20gPHdlYnZpZXc+IHRhZyB0byBkaXNwbGF5IGV4dGVybmFsIHdlYiBjb250ZW50IGluCiAgICAgICAgICAgIC8vIGFuIGlzb2xhdGVkIGZyYW1lIGFuZCBwcm9jZXNzLgogICAgICAgICAgICAvLyBUaGlzIHRhZyBpcyBub3QgcHJlc2VudCBpbiBub24gRWxlY3Ryb24gZW52aXJvbm1lbnRzIHN1Y2ggYXMgSlNEb20gd2hpY2gKICAgICAgICAgICAgLy8gaXMgb2Z0ZW4gdXNlZCBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KICAgICAgICAgICAgLy8gQHNlZSBodHRwczovL2VsZWN0cm9uanMub3JnL2RvY3MvYXBpL3dlYnZpZXctdGFnCiAgICAgICAgICAgIHdlYnZpZXc6IHRydWUKICAgICAgICAgIH07CiAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50ID0gZnVuY3Rpb24odHlwZSwgcHJvcHMpIHsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzKHR5cGUsIHByb3BzKTsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzJDEodHlwZSwgcHJvcHMpOwogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXMkMih0eXBlLCBwcm9wcywgewogICAgICAgICAgICAgIHJlZ2lzdHJhdGlvbk5hbWVEZXBlbmRlbmNpZXMsCiAgICAgICAgICAgICAgcG9zc2libGVSZWdpc3RyYXRpb25OYW1lcwogICAgICAgICAgICB9KTsKICAgICAgICAgIH07CiAgICAgICAgICBjYW5EaWZmU3R5bGVGb3JIeWRyYXRpb25XYXJuaW5nID0gY2FuVXNlRE9NMiAmJiAhZG9jdW1lbnQuZG9jdW1lbnRNb2RlOwogICAgICAgICAgd2FybkZvclByb3BEaWZmZXJlbmNlID0gZnVuY3Rpb24ocHJvcE5hbWUsIHNlcnZlclZhbHVlLCBjbGllbnRWYWx1ZSkgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZWRDbGllbnRWYWx1ZSA9IG5vcm1hbGl6ZU1hcmt1cEZvclRleHRPckF0dHJpYnV0ZShjbGllbnRWYWx1ZSk7CiAgICAgICAgICAgIHZhciBub3JtYWxpemVkU2VydmVyVmFsdWUgPSBub3JtYWxpemVNYXJrdXBGb3JUZXh0T3JBdHRyaWJ1dGUoc2VydmVyVmFsdWUpOwogICAgICAgICAgICBpZiAobm9ybWFsaXplZFNlcnZlclZhbHVlID09PSBub3JtYWxpemVkQ2xpZW50VmFsdWUpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcigiUHJvcCBgJXNgIGRpZCBub3QgbWF0Y2guIFNlcnZlcjogJXMgQ2xpZW50OiAlcyIsIHByb3BOYW1lLCBKU09OLnN0cmluZ2lmeShub3JtYWxpemVkU2VydmVyVmFsdWUpLCBKU09OLnN0cmluZ2lmeShub3JtYWxpemVkQ2xpZW50VmFsdWUpKTsKICAgICAgICAgIH07CiAgICAgICAgICB3YXJuRm9yRXh0cmFBdHRyaWJ1dGVzID0gZnVuY3Rpb24oYXR0cmlidXRlTmFtZXMpIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIG5hbWVzID0gW107CiAgICAgICAgICAgIGF0dHJpYnV0ZU5hbWVzLmZvckVhY2goZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICAgIG5hbWVzLnB1c2gobmFtZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBlcnJvcigiRXh0cmEgYXR0cmlidXRlcyBmcm9tIHRoZSBzZXJ2ZXI6ICVzIiwgbmFtZXMpOwogICAgICAgICAgfTsKICAgICAgICAgIHdhcm5Gb3JJbnZhbGlkRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uKHJlZ2lzdHJhdGlvbk5hbWUsIGxpc3RlbmVyMikgewogICAgICAgICAgICBpZiAobGlzdGVuZXIyID09PSBmYWxzZSkgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBgJXNgIGxpc3RlbmVyIHRvIGJlIGEgZnVuY3Rpb24sIGluc3RlYWQgZ290IGBmYWxzZWAuXG5cbklmIHlvdSB1c2VkIHRvIGNvbmRpdGlvbmFsbHkgb21pdCBpdCB3aXRoICVzPXtjb25kaXRpb24gJiYgdmFsdWV9LCBwYXNzICVzPXtjb25kaXRpb24gPyB2YWx1ZSA6IHVuZGVmaW5lZH0gaW5zdGVhZC4iLCByZWdpc3RyYXRpb25OYW1lLCByZWdpc3RyYXRpb25OYW1lLCByZWdpc3RyYXRpb25OYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgYCVzYCBsaXN0ZW5lciB0byBiZSBhIGZ1bmN0aW9uLCBpbnN0ZWFkIGdvdCBhIHZhbHVlIG9mIGAlc2AgdHlwZS4iLCByZWdpc3RyYXRpb25OYW1lLCB0eXBlb2YgbGlzdGVuZXIyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG5vcm1hbGl6ZUhUTUwgPSBmdW5jdGlvbihwYXJlbnQsIGh0bWwpIHsKICAgICAgICAgICAgdmFyIHRlc3RFbGVtZW50ID0gcGFyZW50Lm5hbWVzcGFjZVVSSSA9PT0gSFRNTF9OQU1FU1BBQ0UgPyBwYXJlbnQub3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KHBhcmVudC50YWdOYW1lKSA6IHBhcmVudC5vd25lckRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhwYXJlbnQubmFtZXNwYWNlVVJJLCBwYXJlbnQudGFnTmFtZSk7CiAgICAgICAgICAgIHRlc3RFbGVtZW50LmlubmVySFRNTCA9IGh0bWw7CiAgICAgICAgICAgIHJldHVybiB0ZXN0RWxlbWVudC5pbm5lckhUTUw7CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgTk9STUFMSVpFX05FV0xJTkVTX1JFR0VYID0gL1xyXG4/L2c7CiAgICAgICAgdmFyIE5PUk1BTElaRV9OVUxMX0FORF9SRVBMQUNFTUVOVF9SRUdFWCA9IC9cdTAwMDB8XHVGRkZEL2c7CiAgICAgICAgZnVuY3Rpb24gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKG1hcmt1cCkgewogICAgICAgICAgewogICAgICAgICAgICBjaGVja0h0bWxTdHJpbmdDb2VyY2lvbihtYXJrdXApOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1hcmt1cFN0cmluZyA9IHR5cGVvZiBtYXJrdXAgPT09ICJzdHJpbmciID8gbWFya3VwIDogIiIgKyBtYXJrdXA7CiAgICAgICAgICByZXR1cm4gbWFya3VwU3RyaW5nLnJlcGxhY2UoTk9STUFMSVpFX05FV0xJTkVTX1JFR0VYLCAiXG4iKS5yZXBsYWNlKE5PUk1BTElaRV9OVUxMX0FORF9SRVBMQUNFTUVOVF9SRUdFWCwgIiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0ZvclVubWF0Y2hlZFRleHQoc2VydmVyVGV4dCwgY2xpZW50VGV4dCwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldikgewogICAgICAgICAgdmFyIG5vcm1hbGl6ZWRDbGllbnRUZXh0ID0gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKGNsaWVudFRleHQpOwogICAgICAgICAgdmFyIG5vcm1hbGl6ZWRTZXJ2ZXJUZXh0ID0gbm9ybWFsaXplTWFya3VwRm9yVGV4dE9yQXR0cmlidXRlKHNlcnZlclRleHQpOwogICAgICAgICAgaWYgKG5vcm1hbGl6ZWRTZXJ2ZXJUZXh0ID09PSBub3JtYWxpemVkQ2xpZW50VGV4dCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2hvdWxkV2FybkRldikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoJ1RleHQgY29udGVudCBkaWQgbm90IG1hdGNoLiBTZXJ2ZXI6ICIlcyIgQ2xpZW50OiAiJXMiJywgbm9ybWFsaXplZFNlcnZlclRleHQsIG5vcm1hbGl6ZWRDbGllbnRUZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChpc0NvbmN1cnJlbnRNb2RlICYmIGVuYWJsZUNsaWVudFJlbmRlckZhbGxiYWNrT25UZXh0TWlzbWF0Y2gpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUZXh0IGNvbnRlbnQgZG9lcyBub3QgbWF0Y2ggc2VydmVyLXJlbmRlcmVkIEhUTUwuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE93bmVyRG9jdW1lbnRGcm9tUm9vdENvbnRhaW5lcihyb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgcmV0dXJuIHJvb3RDb250YWluZXJFbGVtZW50Lm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFID8gcm9vdENvbnRhaW5lckVsZW1lbnQgOiByb290Q29udGFpbmVyRWxlbWVudC5vd25lckRvY3VtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBub29wNigpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQobm9kZSkgewogICAgICAgICAgbm9kZS5vbmNsaWNrID0gbm9vcDY7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEluaXRpYWxET01Qcm9wZXJ0aWVzKHRhZywgZG9tRWxlbWVudCwgcm9vdENvbnRhaW5lckVsZW1lbnQsIG5leHRQcm9wcywgaXNDdXN0b21Db21wb25lbnRUYWcpIHsKICAgICAgICAgIGZvciAodmFyIHByb3BLZXkgaW4gbmV4dFByb3BzKSB7CiAgICAgICAgICAgIGlmICghbmV4dFByb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRQcm9wID0gbmV4dFByb3BzW3Byb3BLZXldOwogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAobmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgT2JqZWN0LmZyZWV6ZShuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNldFZhbHVlRm9yU3R5bGVzKGRvbUVsZW1lbnQsIG5leHRQcm9wKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCkgewogICAgICAgICAgICAgIHZhciBuZXh0SHRtbCA9IG5leHRQcm9wID8gbmV4dFByb3BbSFRNTCQxXSA6IHZvaWQgMDsKICAgICAgICAgICAgICBpZiAobmV4dEh0bWwgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2V0SW5uZXJIVE1MKGRvbUVsZW1lbnQsIG5leHRIdG1sKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gQ0hJTERSRU4pIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdmFyIGNhblNldFRleHRDb250ZW50ID0gdGFnICE9PSAidGV4dGFyZWEiIHx8IG5leHRQcm9wICE9PSAiIjsKICAgICAgICAgICAgICAgIGlmIChjYW5TZXRUZXh0Q29udGVudCkgewogICAgICAgICAgICAgICAgICBzZXRUZXh0Q29udGVudChkb21FbGVtZW50LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICBzZXRUZXh0Q29udGVudChkb21FbGVtZW50LCAiIiArIG5leHRQcm9wKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IEFVVE9GT0NVUykgOwogICAgICAgICAgICBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSAib25TY3JvbGwiKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInNjcm9sbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChuZXh0UHJvcCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgc2V0VmFsdWVGb3JQcm9wZXJ0eShkb21FbGVtZW50LCBwcm9wS2V5LCBuZXh0UHJvcCwgaXNDdXN0b21Db21wb25lbnRUYWcpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZURPTVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgd2FzQ3VzdG9tQ29tcG9uZW50VGFnLCBpc0N1c3RvbUNvbXBvbmVudFRhZykgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB1cGRhdGVQYXlsb2FkLmxlbmd0aDsgaSArPSAyKSB7CiAgICAgICAgICAgIHZhciBwcm9wS2V5ID0gdXBkYXRlUGF5bG9hZFtpXTsKICAgICAgICAgICAgdmFyIHByb3BWYWx1ZSA9IHVwZGF0ZVBheWxvYWRbaSArIDFdOwogICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gU1RZTEUpIHsKICAgICAgICAgICAgICBzZXRWYWx1ZUZvclN0eWxlcyhkb21FbGVtZW50LCBwcm9wVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MKSB7CiAgICAgICAgICAgICAgc2V0SW5uZXJIVE1MKGRvbUVsZW1lbnQsIHByb3BWYWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gQ0hJTERSRU4pIHsKICAgICAgICAgICAgICBzZXRUZXh0Q29udGVudChkb21FbGVtZW50LCBwcm9wVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHNldFZhbHVlRm9yUHJvcGVydHkoZG9tRWxlbWVudCwgcHJvcEtleSwgcHJvcFZhbHVlLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRWxlbWVudDM5KHR5cGUsIHByb3BzLCByb290Q29udGFpbmVyRWxlbWVudCwgcGFyZW50TmFtZXNwYWNlKSB7CiAgICAgICAgICB2YXIgaXNDdXN0b21Db21wb25lbnRUYWc7CiAgICAgICAgICB2YXIgb3duZXJEb2N1bWVudCA9IGdldE93bmVyRG9jdW1lbnRGcm9tUm9vdENvbnRhaW5lcihyb290Q29udGFpbmVyRWxlbWVudCk7CiAgICAgICAgICB2YXIgZG9tRWxlbWVudDsKICAgICAgICAgIHZhciBuYW1lc3BhY2VVUkkgPSBwYXJlbnROYW1lc3BhY2U7CiAgICAgICAgICBpZiAobmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICBuYW1lc3BhY2VVUkkgPSBnZXRJbnRyaW5zaWNOYW1lc3BhY2UodHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobmFtZXNwYWNlVVJJID09PSBIVE1MX05BTUVTUEFDRSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0eXBlLCBwcm9wcyk7CiAgICAgICAgICAgICAgaWYgKCFpc0N1c3RvbUNvbXBvbmVudFRhZyAmJiB0eXBlICE9PSB0eXBlLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAgICAgICAgIGVycm9yKCI8JXMgLz4gaXMgdXNpbmcgaW5jb3JyZWN0IGNhc2luZy4gVXNlIFBhc2NhbENhc2UgZm9yIFJlYWN0IGNvbXBvbmVudHMsIG9yIGxvd2VyY2FzZSBmb3IgSFRNTCBlbGVtZW50cy4iLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGUgPT09ICJzY3JpcHQiKSB7CiAgICAgICAgICAgICAgdmFyIGRpdiA9IG93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgICAgZGl2LmlubmVySFRNTCA9ICI8c2NyaXB0PjxcL3NjcmlwdD4iOwogICAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZGl2LmZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgZG9tRWxlbWVudCA9IGRpdi5yZW1vdmVDaGlsZChmaXJzdENoaWxkKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvcHMuaXMgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgZG9tRWxlbWVudCA9IG93bmVyRG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0eXBlLCB7CiAgICAgICAgICAgICAgICBpczogcHJvcHMuaXMKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkb21FbGVtZW50ID0gb3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50KHR5cGUpOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSAic2VsZWN0IikgewogICAgICAgICAgICAgICAgdmFyIG5vZGUgPSBkb21FbGVtZW50OwogICAgICAgICAgICAgICAgaWYgKHByb3BzLm11bHRpcGxlKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUubXVsdGlwbGUgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wcy5zaXplKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUuc2l6ZSA9IHByb3BzLnNpemU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkb21FbGVtZW50ID0gb3duZXJEb2N1bWVudC5jcmVhdGVFbGVtZW50TlMobmFtZXNwYWNlVVJJLCB0eXBlKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5hbWVzcGFjZVVSSSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgICBpZiAoIWlzQ3VzdG9tQ29tcG9uZW50VGFnICYmIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChkb21FbGVtZW50KSA9PT0gIltvYmplY3QgSFRNTFVua25vd25FbGVtZW50XSIgJiYgIWhhc093blByb3BlcnR5LmNhbGwod2FybmVkVW5rbm93blRhZ3MsIHR5cGUpKSB7CiAgICAgICAgICAgICAgICB3YXJuZWRVbmtub3duVGFnc1t0eXBlXSA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIHRhZyA8JXM+IGlzIHVucmVjb2duaXplZCBpbiB0aGlzIGJyb3dzZXIuIElmIHlvdSBtZWFudCB0byByZW5kZXIgYSBSZWFjdCBjb21wb25lbnQsIHN0YXJ0IGl0cyBuYW1lIHdpdGggYW4gdXBwZXJjYXNlIGxldHRlci4iLCB0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBkb21FbGVtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVUZXh0Tm9kZSh0ZXh0LCByb290Q29udGFpbmVyRWxlbWVudCkgewogICAgICAgICAgcmV0dXJuIGdldE93bmVyRG9jdW1lbnRGcm9tUm9vdENvbnRhaW5lcihyb290Q29udGFpbmVyRWxlbWVudCkuY3JlYXRlVGV4dE5vZGUodGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNldEluaXRpYWxQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHRhZywgcmF3UHJvcHMsIHJvb3RDb250YWluZXJFbGVtZW50KSB7CiAgICAgICAgICB2YXIgaXNDdXN0b21Db21wb25lbnRUYWcgPSBpc0N1c3RvbUNvbXBvbmVudCh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzSW5EZXZlbG9wbWVudCh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcm9wczsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImRpYWxvZyI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiY2FuY2VsIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiY2xvc2UiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpZnJhbWUiOgogICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICBjYXNlICJlbWJlZCI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgibG9hZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInZpZGVvIjoKICAgICAgICAgICAgY2FzZSAiYXVkaW8iOgogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWVkaWFFdmVudFR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KG1lZGlhRXZlbnRUeXBlc1tpXSwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNvdXJjZSI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiZXJyb3IiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpbWciOgogICAgICAgICAgICBjYXNlICJpbWFnZSI6CiAgICAgICAgICAgIGNhc2UgImxpbmsiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImVycm9yIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgibG9hZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImRldGFpbHMiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInRvZ2dsZSIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBwcm9wcyA9IGdldEhvc3RQcm9wcyhkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgIHZhbGlkYXRlUHJvcHMoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIHByb3BzID0gcmF3UHJvcHM7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgaW5pdFdyYXBwZXJTdGF0ZSQxKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBwcm9wcyA9IGdldEhvc3RQcm9wcyQxKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJpbnZhbGlkIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlJDIoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIHByb3BzID0gZ2V0SG9zdFByb3BzJDIoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBwcm9wcyA9IHJhd1Byb3BzOwogICAgICAgICAgfQogICAgICAgICAgYXNzZXJ0VmFsaWRQcm9wcyh0YWcsIHByb3BzKTsKICAgICAgICAgIHNldEluaXRpYWxET01Qcm9wZXJ0aWVzKHRhZywgZG9tRWxlbWVudCwgcm9vdENvbnRhaW5lckVsZW1lbnQsIHByb3BzLCBpc0N1c3RvbUNvbXBvbmVudFRhZyk7CiAgICAgICAgICBzd2l0Y2ggKHRhZykgewogICAgICAgICAgICBjYXNlICJpbnB1dCI6CiAgICAgICAgICAgICAgdHJhY2soZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlcihkb21FbGVtZW50LCByYXdQcm9wcywgZmFsc2UpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgdHJhY2soZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQzKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJvcHRpb24iOgogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIkMShkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgcG9zdE1vdW50V3JhcHBlciQyKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb3BzLm9uQ2xpY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRyYXBDbGlja09uTm9uSW50ZXJhY3RpdmVFbGVtZW50KGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlmZlByb3BlcnRpZXMoZG9tRWxlbWVudCwgdGFnLCBsYXN0UmF3UHJvcHMsIG5leHRSYXdQcm9wcywgcm9vdENvbnRhaW5lckVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFsaWRhdGVQcm9wZXJ0aWVzSW5EZXZlbG9wbWVudCh0YWcsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IG51bGw7CiAgICAgICAgICB2YXIgbGFzdFByb3BzOwogICAgICAgICAgdmFyIG5leHRQcm9wczsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICBsYXN0UHJvcHMgPSBnZXRIb3N0UHJvcHMoZG9tRWxlbWVudCwgbGFzdFJhd1Byb3BzKTsKICAgICAgICAgICAgICBuZXh0UHJvcHMgPSBnZXRIb3N0UHJvcHMoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInNlbGVjdCI6CiAgICAgICAgICAgICAgbGFzdFByb3BzID0gZ2V0SG9zdFByb3BzJDEoZG9tRWxlbWVudCwgbGFzdFJhd1Byb3BzKTsKICAgICAgICAgICAgICBuZXh0UHJvcHMgPSBnZXRIb3N0UHJvcHMkMShkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIGxhc3RQcm9wcyA9IGdldEhvc3RQcm9wcyQyKGRvbUVsZW1lbnQsIGxhc3RSYXdQcm9wcyk7CiAgICAgICAgICAgICAgbmV4dFByb3BzID0gZ2V0SG9zdFByb3BzJDIoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgbGFzdFByb3BzID0gbGFzdFJhd1Byb3BzOwogICAgICAgICAgICAgIG5leHRQcm9wcyA9IG5leHRSYXdQcm9wczsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGxhc3RQcm9wcy5vbkNsaWNrICE9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBuZXh0UHJvcHMub25DbGljayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdHJhcENsaWNrT25Ob25JbnRlcmFjdGl2ZUVsZW1lbnQoZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgYXNzZXJ0VmFsaWRQcm9wcyh0YWcsIG5leHRQcm9wcyk7CiAgICAgICAgICB2YXIgcHJvcEtleTsKICAgICAgICAgIHZhciBzdHlsZU5hbWU7CiAgICAgICAgICB2YXIgc3R5bGVVcGRhdGVzID0gbnVsbDsKICAgICAgICAgIGZvciAocHJvcEtleSBpbiBsYXN0UHJvcHMpIHsKICAgICAgICAgICAgaWYgKG5leHRQcm9wcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSB8fCAhbGFzdFByb3BzLmhhc093blByb3BlcnR5KHByb3BLZXkpIHx8IGxhc3RQcm9wc1twcm9wS2V5XSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09IFNUWUxFKSB7CiAgICAgICAgICAgICAgdmFyIGxhc3RTdHlsZSA9IGxhc3RQcm9wc1twcm9wS2V5XTsKICAgICAgICAgICAgICBmb3IgKHN0eWxlTmFtZSBpbiBsYXN0U3R5bGUpIHsKICAgICAgICAgICAgICAgIGlmIChsYXN0U3R5bGUuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSkgewogICAgICAgICAgICAgICAgICBpZiAoIXN0eWxlVXBkYXRlcykgewogICAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IHt9OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlc1tzdHlsZU5hbWVdID0gIiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IERBTkdFUk9VU0xZX1NFVF9JTk5FUl9IVE1MIHx8IHByb3BLZXkgPT09IENISUxEUkVOKSA7CiAgICAgICAgICAgIGVsc2UgaWYgKHByb3BLZXkgPT09IFNVUFBSRVNTX0NPTlRFTlRfRURJVEFCTEVfV0FSTklORyB8fCBwcm9wS2V5ID09PSBTVVBQUkVTU19IWURSQVRJT05fV0FSTklORykgOwogICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBBVVRPRk9DVVMpIDsKICAgICAgICAgICAgZWxzZSBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgIGlmICghdXBkYXRlUGF5bG9hZCkgewogICAgICAgICAgICAgICAgdXBkYXRlUGF5bG9hZCA9IFtdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgbnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZvciAocHJvcEtleSBpbiBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgdmFyIG5leHRQcm9wID0gbmV4dFByb3BzW3Byb3BLZXldOwogICAgICAgICAgICB2YXIgbGFzdFByb3AgPSBsYXN0UHJvcHMgIT0gbnVsbCA/IGxhc3RQcm9wc1twcm9wS2V5XSA6IHZvaWQgMDsKICAgICAgICAgICAgaWYgKCFuZXh0UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkgfHwgbmV4dFByb3AgPT09IGxhc3RQcm9wIHx8IG5leHRQcm9wID09IG51bGwgJiYgbGFzdFByb3AgPT0gbnVsbCkgewogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGxhc3RQcm9wKSB7CiAgICAgICAgICAgICAgICBmb3IgKHN0eWxlTmFtZSBpbiBsYXN0UHJvcCkgewogICAgICAgICAgICAgICAgICBpZiAobGFzdFByb3AuaGFzT3duUHJvcGVydHkoc3R5bGVOYW1lKSAmJiAoIW5leHRQcm9wIHx8ICFuZXh0UHJvcC5oYXNPd25Qcm9wZXJ0eShzdHlsZU5hbWUpKSkgewogICAgICAgICAgICAgICAgICAgIGlmICghc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzW3N0eWxlTmFtZV0gPSAiIjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yIChzdHlsZU5hbWUgaW4gbmV4dFByb3ApIHsKICAgICAgICAgICAgICAgICAgaWYgKG5leHRQcm9wLmhhc093blByb3BlcnR5KHN0eWxlTmFtZSkgJiYgbGFzdFByb3Bbc3R5bGVOYW1lXSAhPT0gbmV4dFByb3Bbc3R5bGVOYW1lXSkgewogICAgICAgICAgICAgICAgICAgIGlmICghc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICBzdHlsZVVwZGF0ZXMgPSB7fTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc3R5bGVVcGRhdGVzW3N0eWxlTmFtZV0gPSBuZXh0UHJvcFtzdHlsZU5hbWVdOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghc3R5bGVVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICAgIGlmICghdXBkYXRlUGF5bG9hZCkgewogICAgICAgICAgICAgICAgICAgIHVwZGF0ZVBheWxvYWQgPSBbXTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkLnB1c2gocHJvcEtleSwgc3R5bGVVcGRhdGVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0eWxlVXBkYXRlcyA9IG5leHRQcm9wOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCkgewogICAgICAgICAgICAgIHZhciBuZXh0SHRtbCA9IG5leHRQcm9wID8gbmV4dFByb3BbSFRNTCQxXSA6IHZvaWQgMDsKICAgICAgICAgICAgICB2YXIgbGFzdEh0bWwgPSBsYXN0UHJvcCA/IGxhc3RQcm9wW0hUTUwkMV0gOiB2b2lkIDA7CiAgICAgICAgICAgICAgaWYgKG5leHRIdG1sICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChsYXN0SHRtbCAhPT0gbmV4dEh0bWwpIHsKICAgICAgICAgICAgICAgICAgKHVwZGF0ZVBheWxvYWQgPSB1cGRhdGVQYXlsb2FkIHx8IFtdKS5wdXNoKHByb3BLZXksIG5leHRIdG1sKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcEtleSA9PT0gQ0hJTERSRU4pIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wID09PSAic3RyaW5nIiB8fCB0eXBlb2YgbmV4dFByb3AgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAodXBkYXRlUGF5bG9hZCA9IHVwZGF0ZVBheWxvYWQgfHwgW10pLnB1c2gocHJvcEtleSwgIiIgKyBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHByb3BLZXkgPT09IFNVUFBSRVNTX0NPTlRFTlRfRURJVEFCTEVfV0FSTklORyB8fCBwcm9wS2V5ID09PSBTVVBQUkVTU19IWURSQVRJT05fV0FSTklORykgOwogICAgICAgICAgICBlbHNlIGlmIChyZWdpc3RyYXRpb25OYW1lRGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KHByb3BLZXkpKSB7CiAgICAgICAgICAgICAgaWYgKG5leHRQcm9wICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFByb3AgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgd2FybkZvckludmFsaWRFdmVudExpc3RlbmVyKHByb3BLZXksIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwcm9wS2V5ID09PSAib25TY3JvbGwiKSB7CiAgICAgICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoInNjcm9sbCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIXVwZGF0ZVBheWxvYWQgJiYgbGFzdFByb3AgIT09IG5leHRQcm9wKSB7CiAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW107CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChzdHlsZVVwZGF0ZXMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhbGlkYXRlU2hvcnRoYW5kUHJvcGVydHlDb2xsaXNpb25JbkRldihzdHlsZVVwZGF0ZXMsIG5leHRQcm9wc1tTVFlMRV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgICh1cGRhdGVQYXlsb2FkID0gdXBkYXRlUGF5bG9hZCB8fCBbXSkucHVzaChTVFlMRSwgc3R5bGVVcGRhdGVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cGRhdGVQYXlsb2FkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHVwZGF0ZVBheWxvYWQsIHRhZywgbGFzdFJhd1Byb3BzLCBuZXh0UmF3UHJvcHMpIHsKICAgICAgICAgIGlmICh0YWcgPT09ICJpbnB1dCIgJiYgbmV4dFJhd1Byb3BzLnR5cGUgPT09ICJyYWRpbyIgJiYgbmV4dFJhd1Byb3BzLm5hbWUgIT0gbnVsbCkgewogICAgICAgICAgICB1cGRhdGVDaGVja2VkKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2FzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCBsYXN0UmF3UHJvcHMpOwogICAgICAgICAgdmFyIGlzQ3VzdG9tQ29tcG9uZW50VGFnID0gaXNDdXN0b21Db21wb25lbnQodGFnLCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgdXBkYXRlRE9NUHJvcGVydGllcyhkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB3YXNDdXN0b21Db21wb25lbnRUYWcsIGlzQ3VzdG9tQ29tcG9uZW50VGFnKTsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICB1cGRhdGVXcmFwcGVyKGRvbUVsZW1lbnQsIG5leHRSYXdQcm9wcyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICB1cGRhdGVXcmFwcGVyJDEoZG9tRWxlbWVudCwgbmV4dFJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBwb3N0VXBkYXRlV3JhcHBlcihkb21FbGVtZW50LCBuZXh0UmF3UHJvcHMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRQb3NzaWJsZVN0YW5kYXJkTmFtZShwcm9wTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgbG93ZXJDYXNlZE5hbWUgPSBwcm9wTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICBpZiAoIXBvc3NpYmxlU3RhbmRhcmROYW1lcy5oYXNPd25Qcm9wZXJ0eShsb3dlckNhc2VkTmFtZSkpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcG9zc2libGVTdGFuZGFyZE5hbWVzW2xvd2VyQ2FzZWROYW1lXSB8fCBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWZmSHlkcmF0ZWRQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHRhZywgcmF3UHJvcHMsIHBhcmVudE5hbWVzcGFjZSwgcm9vdENvbnRhaW5lckVsZW1lbnQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgIHZhciBpc0N1c3RvbUNvbXBvbmVudFRhZzsKICAgICAgICAgIHZhciBleHRyYUF0dHJpYnV0ZU5hbWVzOwogICAgICAgICAgewogICAgICAgICAgICBpc0N1c3RvbUNvbXBvbmVudFRhZyA9IGlzQ3VzdG9tQ29tcG9uZW50KHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgICB2YWxpZGF0ZVByb3BlcnRpZXNJbkRldmVsb3BtZW50KHRhZywgcmF3UHJvcHMpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgY2FzZSAiZGlhbG9nIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjYW5jZWwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJjbG9zZSIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpZnJhbWUiOgogICAgICAgICAgICBjYXNlICJvYmplY3QiOgogICAgICAgICAgICBjYXNlICJlbWJlZCI6CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgibG9hZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJ2aWRlbyI6CiAgICAgICAgICAgIGNhc2UgImF1ZGlvIjoKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1lZGlhRXZlbnRUeXBlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudChtZWRpYUV2ZW50VHlwZXNbaV0sIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic291cmNlIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJlcnJvciIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJpbWciOgogICAgICAgICAgICBjYXNlICJpbWFnZSI6CiAgICAgICAgICAgIGNhc2UgImxpbmsiOgogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImVycm9yIiwgZG9tRWxlbWVudCk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgibG9hZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICJkZXRhaWxzIjoKICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJ0b2dnbGUiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICB2YWxpZGF0ZVByb3BzKGRvbUVsZW1lbnQsIHJhd1Byb3BzKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICBpbml0V3JhcHBlclN0YXRlJDEoZG9tRWxlbWVudCwgcmF3UHJvcHMpOwogICAgICAgICAgICAgIGxpc3RlblRvTm9uRGVsZWdhdGVkRXZlbnQoImludmFsaWQiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIGluaXRXcmFwcGVyU3RhdGUkMihkb21FbGVtZW50LCByYXdQcm9wcyk7CiAgICAgICAgICAgICAgbGlzdGVuVG9Ob25EZWxlZ2F0ZWRFdmVudCgiaW52YWxpZCIsIGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgICAgYXNzZXJ0VmFsaWRQcm9wcyh0YWcsIHJhd1Byb3BzKTsKICAgICAgICAgIHsKICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIHZhciBhdHRyaWJ1dGVzID0gZG9tRWxlbWVudC5hdHRyaWJ1dGVzOwogICAgICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgYXR0cmlidXRlcy5sZW5ndGg7IF9pKyspIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGF0dHJpYnV0ZXNbX2ldLm5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICBzd2l0Y2ggKG5hbWUpIHsKICAgICAgICAgICAgICAgIGNhc2UgInZhbHVlIjoKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJjaGVja2VkIjoKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJzZWxlY3RlZCI6CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5hZGQoYXR0cmlidXRlc1tfaV0ubmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IG51bGw7CiAgICAgICAgICBmb3IgKHZhciBwcm9wS2V5IGluIHJhd1Byb3BzKSB7CiAgICAgICAgICAgIGlmICghcmF3UHJvcHMuaGFzT3duUHJvcGVydHkocHJvcEtleSkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV4dFByb3AgPSByYXdQcm9wc1twcm9wS2V5XTsKICAgICAgICAgICAgaWYgKHByb3BLZXkgPT09IENISUxEUkVOKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXh0UHJvcCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGlmIChkb21FbGVtZW50LnRleHRDb250ZW50ICE9PSBuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBpZiAocmF3UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkddICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tGb3JVbm1hdGNoZWRUZXh0KGRvbUVsZW1lbnQudGV4dENvbnRlbnQsIG5leHRQcm9wLCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW0NISUxEUkVOLCBuZXh0UHJvcF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbmV4dFByb3AgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICBpZiAoZG9tRWxlbWVudC50ZXh0Q29udGVudCAhPT0gIiIgKyBuZXh0UHJvcCkgewogICAgICAgICAgICAgICAgICBpZiAocmF3UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkddICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgY2hlY2tGb3JVbm1hdGNoZWRUZXh0KGRvbUVsZW1lbnQudGV4dENvbnRlbnQsIG5leHRQcm9wLCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB1cGRhdGVQYXlsb2FkID0gW0NISUxEUkVOLCAiIiArIG5leHRQcm9wXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVnaXN0cmF0aW9uTmFtZURlcGVuZGVuY2llcy5oYXNPd25Qcm9wZXJ0eShwcm9wS2V5KSkgewogICAgICAgICAgICAgIGlmIChuZXh0UHJvcCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5leHRQcm9wICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JJbnZhbGlkRXZlbnRMaXN0ZW5lcihwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocHJvcEtleSA9PT0gIm9uU2Nyb2xsIikgewogICAgICAgICAgICAgICAgICBsaXN0ZW5Ub05vbkRlbGVnYXRlZEV2ZW50KCJzY3JvbGwiLCBkb21FbGVtZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc2hvdWxkV2FybkRldiAmJiB0cnVlICYmIC8vIENvbnZpbmNlIEZsb3cgd2UndmUgY2FsY3VsYXRlZCBpdCAoaXQncyBERVYtb25seSBpbiB0aGlzIG1ldGhvZC4pCiAgICAgICAgICAgIHR5cGVvZiBpc0N1c3RvbUNvbXBvbmVudFRhZyA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgICAgICAgdmFyIHNlcnZlclZhbHVlID0gdm9pZCAwOwogICAgICAgICAgICAgIHZhciBwcm9wZXJ0eUluZm8gPSBpc0N1c3RvbUNvbXBvbmVudFRhZyAmJiBlbmFibGVDdXN0b21FbGVtZW50UHJvcGVydHlTdXBwb3J0ID8gbnVsbCA6IGdldFByb3BlcnR5SW5mbyhwcm9wS2V5KTsKICAgICAgICAgICAgICBpZiAocmF3UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkddID09PSB0cnVlKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAocHJvcEtleSA9PT0gU1VQUFJFU1NfQ09OVEVOVF9FRElUQUJMRV9XQVJOSU5HIHx8IHByb3BLZXkgPT09IFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HIHx8IC8vIENvbnRyb2xsZWQgYXR0cmlidXRlcyBhcmUgbm90IHZhbGlkYXRlZAogICAgICAgICAgICAgIC8vIFRPRE86IE9ubHkgaWdub3JlIHRoZW0gb24gY29udHJvbGxlZCB0YWdzLgogICAgICAgICAgICAgIHByb3BLZXkgPT09ICJ2YWx1ZSIgfHwgcHJvcEtleSA9PT0gImNoZWNrZWQiIHx8IHByb3BLZXkgPT09ICJzZWxlY3RlZCIpIDsKICAgICAgICAgICAgICBlbHNlIGlmIChwcm9wS2V5ID09PSBEQU5HRVJPVVNMWV9TRVRfSU5ORVJfSFRNTCkgewogICAgICAgICAgICAgICAgdmFyIHNlcnZlckhUTUwgPSBkb21FbGVtZW50LmlubmVySFRNTDsKICAgICAgICAgICAgICAgIHZhciBuZXh0SHRtbCA9IG5leHRQcm9wID8gbmV4dFByb3BbSFRNTCQxXSA6IHZvaWQgMDsKICAgICAgICAgICAgICAgIGlmIChuZXh0SHRtbCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBleHBlY3RlZEhUTUwgPSBub3JtYWxpemVIVE1MKGRvbUVsZW1lbnQsIG5leHRIdG1sKTsKICAgICAgICAgICAgICAgICAgaWYgKGV4cGVjdGVkSFRNTCAhPT0gc2VydmVySFRNTCkgewogICAgICAgICAgICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZShwcm9wS2V5LCBzZXJ2ZXJIVE1MLCBleHBlY3RlZEhUTUwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wS2V5ID09PSBTVFlMRSkgewogICAgICAgICAgICAgICAgZXh0cmFBdHRyaWJ1dGVOYW1lcy5kZWxldGUocHJvcEtleSk7CiAgICAgICAgICAgICAgICBpZiAoY2FuRGlmZlN0eWxlRm9ySHlkcmF0aW9uV2FybmluZykgewogICAgICAgICAgICAgICAgICB2YXIgZXhwZWN0ZWRTdHlsZSA9IGNyZWF0ZURhbmdlcm91c1N0cmluZ0ZvclN0eWxlcyhuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICAgIHNlcnZlclZhbHVlID0gZG9tRWxlbWVudC5nZXRBdHRyaWJ1dGUoInN0eWxlIik7CiAgICAgICAgICAgICAgICAgIGlmIChleHBlY3RlZFN0eWxlICE9PSBzZXJ2ZXJWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZShwcm9wS2V5LCBzZXJ2ZXJWYWx1ZSwgZXhwZWN0ZWRTdHlsZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQ3VzdG9tQ29tcG9uZW50VGFnICYmICFlbmFibGVDdXN0b21FbGVtZW50UHJvcGVydHlTdXBwb3J0KSB7CiAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wS2V5LnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgc2VydmVyVmFsdWUgPSBnZXRWYWx1ZUZvckF0dHJpYnV0ZShkb21FbGVtZW50LCBwcm9wS2V5LCBuZXh0UHJvcCk7CiAgICAgICAgICAgICAgICBpZiAobmV4dFByb3AgIT09IHNlcnZlclZhbHVlKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5Gb3JQcm9wRGlmZmVyZW5jZShwcm9wS2V5LCBzZXJ2ZXJWYWx1ZSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoIXNob3VsZElnbm9yZUF0dHJpYnV0ZShwcm9wS2V5LCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSAmJiAhc2hvdWxkUmVtb3ZlQXR0cmlidXRlKHByb3BLZXksIG5leHRQcm9wLCBwcm9wZXJ0eUluZm8sIGlzQ3VzdG9tQ29tcG9uZW50VGFnKSkgewogICAgICAgICAgICAgICAgdmFyIGlzTWlzbWF0Y2hEdWVUb0JhZENhc2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKHByb3BlcnR5SW5mbyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wZXJ0eUluZm8uYXR0cmlidXRlTmFtZSk7CiAgICAgICAgICAgICAgICAgIHNlcnZlclZhbHVlID0gZ2V0VmFsdWVGb3JQcm9wZXJ0eShkb21FbGVtZW50LCBwcm9wS2V5LCBuZXh0UHJvcCwgcHJvcGVydHlJbmZvKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHZhciBvd25OYW1lc3BhY2UgPSBwYXJlbnROYW1lc3BhY2U7CiAgICAgICAgICAgICAgICAgIGlmIChvd25OYW1lc3BhY2UgPT09IEhUTUxfTkFNRVNQQUNFKSB7CiAgICAgICAgICAgICAgICAgICAgb3duTmFtZXNwYWNlID0gZ2V0SW50cmluc2ljTmFtZXNwYWNlKHRhZyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKG93bk5hbWVzcGFjZSA9PT0gSFRNTF9OQU1FU1BBQ0UpIHsKICAgICAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLmRlbGV0ZShwcm9wS2V5LnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciBzdGFuZGFyZE5hbWUgPSBnZXRQb3NzaWJsZVN0YW5kYXJkTmFtZShwcm9wS2V5KTsKICAgICAgICAgICAgICAgICAgICBpZiAoc3RhbmRhcmROYW1lICE9PSBudWxsICYmIHN0YW5kYXJkTmFtZSAhPT0gcHJvcEtleSkgewogICAgICAgICAgICAgICAgICAgICAgaXNNaXNtYXRjaER1ZVRvQmFkQ2FzaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHN0YW5kYXJkTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGV4dHJhQXR0cmlidXRlTmFtZXMuZGVsZXRlKHByb3BLZXkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNlcnZlclZhbHVlID0gZ2V0VmFsdWVGb3JBdHRyaWJ1dGUoZG9tRWxlbWVudCwgcHJvcEtleSwgbmV4dFByb3ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIGRvbnRXYXJuQ3VzdG9tRWxlbWVudCA9IGVuYWJsZUN1c3RvbUVsZW1lbnRQcm9wZXJ0eVN1cHBvcnQ7CiAgICAgICAgICAgICAgICBpZiAoIWRvbnRXYXJuQ3VzdG9tRWxlbWVudCAmJiBuZXh0UHJvcCAhPT0gc2VydmVyVmFsdWUgJiYgIWlzTWlzbWF0Y2hEdWVUb0JhZENhc2luZykgewogICAgICAgICAgICAgICAgICB3YXJuRm9yUHJvcERpZmZlcmVuY2UocHJvcEtleSwgc2VydmVyVmFsdWUsIG5leHRQcm9wKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHNob3VsZFdhcm5EZXYpIHsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAvLyAkRmxvd0ZpeE1lIC0gU2hvdWxkIGJlIGluZmVycmVkIGFzIG5vdCB1bmRlZmluZWQuCiAgICAgICAgICAgICAgICBleHRyYUF0dHJpYnV0ZU5hbWVzLnNpemUgPiAwICYmIHJhd1Byb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HXSAhPT0gdHJ1ZQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgd2FybkZvckV4dHJhQXR0cmlidXRlcyhleHRyYUF0dHJpYnV0ZU5hbWVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICB0cmFjayhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBwb3N0TW91bnRXcmFwcGVyKGRvbUVsZW1lbnQsIHJhd1Byb3BzLCB0cnVlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAidGV4dGFyZWEiOgogICAgICAgICAgICAgIHRyYWNrKGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIHBvc3RNb3VudFdyYXBwZXIkMyhkb21FbGVtZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgY2FzZSAib3B0aW9uIjoKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICBpZiAodHlwZW9mIHJhd1Byb3BzLm9uQ2xpY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRyYXBDbGlja09uTm9uSW50ZXJhY3RpdmVFbGVtZW50KGRvbUVsZW1lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cGRhdGVQYXlsb2FkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWZmSHlkcmF0ZWRUZXh0KHRleHROb2RlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICB2YXIgaXNEaWZmZXJlbnQgPSB0ZXh0Tm9kZS5ub2RlVmFsdWUgIT09IHRleHQ7CiAgICAgICAgICByZXR1cm4gaXNEaWZmZXJlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZUVsZW1lbnQocGFyZW50Tm9kZSwgY2hpbGQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm5JbnZhbGlkSHlkcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZXJyb3IoIkRpZCBub3QgZXhwZWN0IHNlcnZlciBIVE1MIHRvIGNvbnRhaW4gYSA8JXM+IGluIDwlcz4uIiwgY2hpbGQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwgcGFyZW50Tm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlVGV4dChwYXJlbnROb2RlLCBjaGlsZCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZGlkV2FybkludmFsaWRIeWRyYXRpb24pIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlkV2FybkludmFsaWRIeWRyYXRpb24gPSB0cnVlOwogICAgICAgICAgICBlcnJvcignRGlkIG5vdCBleHBlY3Qgc2VydmVyIEhUTUwgdG8gY29udGFpbiB0aGUgdGV4dCBub2RlICIlcyIgaW4gPCVzPi4nLCBjaGlsZC5ub2RlVmFsdWUsIHBhcmVudE5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkRWxlbWVudChwYXJlbnROb2RlLCB0YWcsIHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCBzZXJ2ZXIgSFRNTCB0byBjb250YWluIGEgbWF0Y2hpbmcgPCVzPiBpbiA8JXM+LiIsIHRhZywgcGFyZW50Tm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybkZvckluc2VydGVkSHlkcmF0ZWRUZXh0KHBhcmVudE5vZGUsIHRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHRleHQgPT09ICIiKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRXYXJuSW52YWxpZEh5ZHJhdGlvbiA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCdFeHBlY3RlZCBzZXJ2ZXIgSFRNTCB0byBjb250YWluIGEgbWF0Y2hpbmcgdGV4dCBub2RlIGZvciAiJXMiIGluIDwlcz4uJywgdGV4dCwgcGFyZW50Tm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQzKGRvbUVsZW1lbnQsIHRhZywgcHJvcHMpIHsKICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgIGNhc2UgImlucHV0IjoKICAgICAgICAgICAgICByZXN0b3JlQ29udHJvbGxlZFN0YXRlKGRvbUVsZW1lbnQsIHByb3BzKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGNhc2UgInRleHRhcmVhIjoKICAgICAgICAgICAgICByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDIoZG9tRWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICByZXN0b3JlQ29udHJvbGxlZFN0YXRlJDEoZG9tRWxlbWVudCwgcHJvcHMpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHZhbGlkYXRlRE9NTmVzdGluZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIH07CiAgICAgICAgdmFyIHVwZGF0ZWRBbmNlc3RvckluZm8gPSBmdW5jdGlvbigpIHsKICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIHZhciBzcGVjaWFsVGFncyA9IFsiYWRkcmVzcyIsICJhcHBsZXQiLCAiYXJlYSIsICJhcnRpY2xlIiwgImFzaWRlIiwgImJhc2UiLCAiYmFzZWZvbnQiLCAiYmdzb3VuZCIsICJibG9ja3F1b3RlIiwgImJvZHkiLCAiYnIiLCAiYnV0dG9uIiwgImNhcHRpb24iLCAiY2VudGVyIiwgImNvbCIsICJjb2xncm91cCIsICJkZCIsICJkZXRhaWxzIiwgImRpciIsICJkaXYiLCAiZGwiLCAiZHQiLCAiZW1iZWQiLCAiZmllbGRzZXQiLCAiZmlnY2FwdGlvbiIsICJmaWd1cmUiLCAiZm9vdGVyIiwgImZvcm0iLCAiZnJhbWUiLCAiZnJhbWVzZXQiLCAiaDEiLCAiaDIiLCAiaDMiLCAiaDQiLCAiaDUiLCAiaDYiLCAiaGVhZCIsICJoZWFkZXIiLCAiaGdyb3VwIiwgImhyIiwgImh0bWwiLCAiaWZyYW1lIiwgImltZyIsICJpbnB1dCIsICJpc2luZGV4IiwgImxpIiwgImxpbmsiLCAibGlzdGluZyIsICJtYWluIiwgIm1hcnF1ZWUiLCAibWVudSIsICJtZW51aXRlbSIsICJtZXRhIiwgIm5hdiIsICJub2VtYmVkIiwgIm5vZnJhbWVzIiwgIm5vc2NyaXB0IiwgIm9iamVjdCIsICJvbCIsICJwIiwgInBhcmFtIiwgInBsYWludGV4dCIsICJwcmUiLCAic2NyaXB0IiwgInNlY3Rpb24iLCAic2VsZWN0IiwgInNvdXJjZSIsICJzdHlsZSIsICJzdW1tYXJ5IiwgInRhYmxlIiwgInRib2R5IiwgInRkIiwgInRlbXBsYXRlIiwgInRleHRhcmVhIiwgInRmb290IiwgInRoIiwgInRoZWFkIiwgInRpdGxlIiwgInRyIiwgInRyYWNrIiwgInVsIiwgIndiciIsICJ4bXAiXTsKICAgICAgICAgIHZhciBpblNjb3BlVGFncyA9IFsKICAgICAgICAgICAgImFwcGxldCIsCiAgICAgICAgICAgICJjYXB0aW9uIiwKICAgICAgICAgICAgImh0bWwiLAogICAgICAgICAgICAidGFibGUiLAogICAgICAgICAgICAidGQiLAogICAgICAgICAgICAidGgiLAogICAgICAgICAgICAibWFycXVlZSIsCiAgICAgICAgICAgICJvYmplY3QiLAogICAgICAgICAgICAidGVtcGxhdGUiLAogICAgICAgICAgICAvLyBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9zeW50YXguaHRtbCNodG1sLWludGVncmF0aW9uLXBvaW50CiAgICAgICAgICAgIC8vIFRPRE86IERpc3Rpbmd1aXNoIGJ5IG5hbWVzcGFjZSBoZXJlIC0tIGZvciA8dGl0bGU+LCBpbmNsdWRpbmcgaXQgaGVyZQogICAgICAgICAgICAvLyBlcnJzIG9uIHRoZSBzaWRlIG9mIGZld2VyIHdhcm5pbmdzCiAgICAgICAgICAgICJmb3JlaWduT2JqZWN0IiwKICAgICAgICAgICAgImRlc2MiLAogICAgICAgICAgICAidGl0bGUiCiAgICAgICAgICBdOwogICAgICAgICAgdmFyIGJ1dHRvblNjb3BlVGFncyA9IGluU2NvcGVUYWdzLmNvbmNhdChbImJ1dHRvbiJdKTsKICAgICAgICAgIHZhciBpbXBsaWVkRW5kVGFncyA9IFsiZGQiLCAiZHQiLCAibGkiLCAib3B0aW9uIiwgIm9wdGdyb3VwIiwgInAiLCAicnAiLCAicnQiXTsKICAgICAgICAgIHZhciBlbXB0eUFuY2VzdG9ySW5mbyA9IHsKICAgICAgICAgICAgY3VycmVudDogbnVsbCwKICAgICAgICAgICAgZm9ybVRhZzogbnVsbCwKICAgICAgICAgICAgYVRhZ0luU2NvcGU6IG51bGwsCiAgICAgICAgICAgIGJ1dHRvblRhZ0luU2NvcGU6IG51bGwsCiAgICAgICAgICAgIG5vYnJUYWdJblNjb3BlOiBudWxsLAogICAgICAgICAgICBwVGFnSW5CdXR0b25TY29wZTogbnVsbCwKICAgICAgICAgICAgbGlzdEl0ZW1UYWdBdXRvY2xvc2luZzogbnVsbCwKICAgICAgICAgICAgZGxJdGVtVGFnQXV0b2Nsb3Npbmc6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVkQW5jZXN0b3JJbmZvID0gZnVuY3Rpb24ob2xkSW5mbywgdGFnKSB7CiAgICAgICAgICAgIHZhciBhbmNlc3RvckluZm8gPSBhc3NpZ24yKHt9LCBvbGRJbmZvIHx8IGVtcHR5QW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgdmFyIGluZm8gPSB7CiAgICAgICAgICAgICAgdGFnCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChpblNjb3BlVGFncy5pbmRleE9mKHRhZykgIT09IC0xKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmFUYWdJblNjb3BlID0gbnVsbDsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYnV0dG9uVGFnSW5TY29wZSA9IG51bGw7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLm5vYnJUYWdJblNjb3BlID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYnV0dG9uU2NvcGVUYWdzLmluZGV4T2YodGFnKSAhPT0gLTEpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzcGVjaWFsVGFncy5pbmRleE9mKHRhZykgIT09IC0xICYmIHRhZyAhPT0gImFkZHJlc3MiICYmIHRhZyAhPT0gImRpdiIgJiYgdGFnICE9PSAicCIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8ubGlzdEl0ZW1UYWdBdXRvY2xvc2luZyA9IG51bGw7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmRsSXRlbVRhZ0F1dG9jbG9zaW5nID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBhbmNlc3RvckluZm8uY3VycmVudCA9IGluZm87CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJmb3JtIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5mb3JtVGFnID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAiYSIpIHsKICAgICAgICAgICAgICBhbmNlc3RvckluZm8uYVRhZ0luU2NvcGUgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJidXR0b24iKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmJ1dHRvblRhZ0luU2NvcGUgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJub2JyIikgewogICAgICAgICAgICAgIGFuY2VzdG9ySW5mby5ub2JyVGFnSW5TY29wZSA9IGluZm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZyA9PT0gInAiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFnID09PSAibGkiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmxpc3RJdGVtVGFnQXV0b2Nsb3NpbmcgPSBpbmZvOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0YWcgPT09ICJkZCIgfHwgdGFnID09PSAiZHQiKSB7CiAgICAgICAgICAgICAgYW5jZXN0b3JJbmZvLmRsSXRlbVRhZ0F1dG9jbG9zaW5nID0gaW5mbzsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBpc1RhZ1ZhbGlkV2l0aFBhcmVudCA9IGZ1bmN0aW9uKHRhZywgcGFyZW50VGFnKSB7CiAgICAgICAgICAgIHN3aXRjaCAocGFyZW50VGFnKSB7CiAgICAgICAgICAgICAgY2FzZSAic2VsZWN0IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJvcHRpb24iIHx8IHRhZyA9PT0gIm9wdGdyb3VwIiB8fCB0YWcgPT09ICIjdGV4dCI7CiAgICAgICAgICAgICAgY2FzZSAib3B0Z3JvdXAiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gIm9wdGlvbiIgfHwgdGFnID09PSAiI3RleHQiOwogICAgICAgICAgICAgIGNhc2UgIm9wdGlvbiI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiI3RleHQiOwogICAgICAgICAgICAgIGNhc2UgInRyIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJ0aCIgfHwgdGFnID09PSAidGQiIHx8IHRhZyA9PT0gInN0eWxlIiB8fCB0YWcgPT09ICJzY3JpcHQiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJ0Ym9keSI6CiAgICAgICAgICAgICAgY2FzZSAidGhlYWQiOgogICAgICAgICAgICAgIGNhc2UgInRmb290IjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJ0ciIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgImNvbGdyb3VwIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJjb2wiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJ0YWJsZSI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiY2FwdGlvbiIgfHwgdGFnID09PSAiY29sZ3JvdXAiIHx8IHRhZyA9PT0gInRib2R5IiB8fCB0YWcgPT09ICJ0Zm9vdCIgfHwgdGFnID09PSAidGhlYWQiIHx8IHRhZyA9PT0gInN0eWxlIiB8fCB0YWcgPT09ICJzY3JpcHQiIHx8IHRhZyA9PT0gInRlbXBsYXRlIjsKICAgICAgICAgICAgICBjYXNlICJoZWFkIjoKICAgICAgICAgICAgICAgIHJldHVybiB0YWcgPT09ICJiYXNlIiB8fCB0YWcgPT09ICJiYXNlZm9udCIgfHwgdGFnID09PSAiYmdzb3VuZCIgfHwgdGFnID09PSAibGluayIgfHwgdGFnID09PSAibWV0YSIgfHwgdGFnID09PSAidGl0bGUiIHx8IHRhZyA9PT0gIm5vc2NyaXB0IiB8fCB0YWcgPT09ICJub2ZyYW1lcyIgfHwgdGFnID09PSAic3R5bGUiIHx8IHRhZyA9PT0gInNjcmlwdCIgfHwgdGFnID09PSAidGVtcGxhdGUiOwogICAgICAgICAgICAgIGNhc2UgImh0bWwiOgogICAgICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gImhlYWQiIHx8IHRhZyA9PT0gImJvZHkiIHx8IHRhZyA9PT0gImZyYW1lc2V0IjsKICAgICAgICAgICAgICBjYXNlICJmcmFtZXNldCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiZnJhbWUiOwogICAgICAgICAgICAgIGNhc2UgIiNkb2N1bWVudCI6CiAgICAgICAgICAgICAgICByZXR1cm4gdGFnID09PSAiaHRtbCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlICJoMSI6CiAgICAgICAgICAgICAgY2FzZSAiaDIiOgogICAgICAgICAgICAgIGNhc2UgImgzIjoKICAgICAgICAgICAgICBjYXNlICJoNCI6CiAgICAgICAgICAgICAgY2FzZSAiaDUiOgogICAgICAgICAgICAgIGNhc2UgImg2IjoKICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRUYWcgIT09ICJoMSIgJiYgcGFyZW50VGFnICE9PSAiaDIiICYmIHBhcmVudFRhZyAhPT0gImgzIiAmJiBwYXJlbnRUYWcgIT09ICJoNCIgJiYgcGFyZW50VGFnICE9PSAiaDUiICYmIHBhcmVudFRhZyAhPT0gImg2IjsKICAgICAgICAgICAgICBjYXNlICJycCI6CiAgICAgICAgICAgICAgY2FzZSAicnQiOgogICAgICAgICAgICAgICAgcmV0dXJuIGltcGxpZWRFbmRUYWdzLmluZGV4T2YocGFyZW50VGFnKSA9PT0gLTE7CiAgICAgICAgICAgICAgY2FzZSAiYm9keSI6CiAgICAgICAgICAgICAgY2FzZSAiY2FwdGlvbiI6CiAgICAgICAgICAgICAgY2FzZSAiY29sIjoKICAgICAgICAgICAgICBjYXNlICJjb2xncm91cCI6CiAgICAgICAgICAgICAgY2FzZSAiZnJhbWVzZXQiOgogICAgICAgICAgICAgIGNhc2UgImZyYW1lIjoKICAgICAgICAgICAgICBjYXNlICJoZWFkIjoKICAgICAgICAgICAgICBjYXNlICJodG1sIjoKICAgICAgICAgICAgICBjYXNlICJ0Ym9keSI6CiAgICAgICAgICAgICAgY2FzZSAidGQiOgogICAgICAgICAgICAgIGNhc2UgInRmb290IjoKICAgICAgICAgICAgICBjYXNlICJ0aCI6CiAgICAgICAgICAgICAgY2FzZSAidGhlYWQiOgogICAgICAgICAgICAgIGNhc2UgInRyIjoKICAgICAgICAgICAgICAgIHJldHVybiBwYXJlbnRUYWcgPT0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZmluZEludmFsaWRBbmNlc3RvckZvclRhZyA9IGZ1bmN0aW9uKHRhZywgYW5jZXN0b3JJbmZvKSB7CiAgICAgICAgICAgIHN3aXRjaCAodGFnKSB7CiAgICAgICAgICAgICAgY2FzZSAiYWRkcmVzcyI6CiAgICAgICAgICAgICAgY2FzZSAiYXJ0aWNsZSI6CiAgICAgICAgICAgICAgY2FzZSAiYXNpZGUiOgogICAgICAgICAgICAgIGNhc2UgImJsb2NrcXVvdGUiOgogICAgICAgICAgICAgIGNhc2UgImNlbnRlciI6CiAgICAgICAgICAgICAgY2FzZSAiZGV0YWlscyI6CiAgICAgICAgICAgICAgY2FzZSAiZGlhbG9nIjoKICAgICAgICAgICAgICBjYXNlICJkaXIiOgogICAgICAgICAgICAgIGNhc2UgImRpdiI6CiAgICAgICAgICAgICAgY2FzZSAiZGwiOgogICAgICAgICAgICAgIGNhc2UgImZpZWxkc2V0IjoKICAgICAgICAgICAgICBjYXNlICJmaWdjYXB0aW9uIjoKICAgICAgICAgICAgICBjYXNlICJmaWd1cmUiOgogICAgICAgICAgICAgIGNhc2UgImZvb3RlciI6CiAgICAgICAgICAgICAgY2FzZSAiaGVhZGVyIjoKICAgICAgICAgICAgICBjYXNlICJoZ3JvdXAiOgogICAgICAgICAgICAgIGNhc2UgIm1haW4iOgogICAgICAgICAgICAgIGNhc2UgIm1lbnUiOgogICAgICAgICAgICAgIGNhc2UgIm5hdiI6CiAgICAgICAgICAgICAgY2FzZSAib2wiOgogICAgICAgICAgICAgIGNhc2UgInAiOgogICAgICAgICAgICAgIGNhc2UgInNlY3Rpb24iOgogICAgICAgICAgICAgIGNhc2UgInN1bW1hcnkiOgogICAgICAgICAgICAgIGNhc2UgInVsIjoKICAgICAgICAgICAgICBjYXNlICJwcmUiOgogICAgICAgICAgICAgIGNhc2UgImxpc3RpbmciOgogICAgICAgICAgICAgIGNhc2UgInRhYmxlIjoKICAgICAgICAgICAgICBjYXNlICJociI6CiAgICAgICAgICAgICAgY2FzZSAieG1wIjoKICAgICAgICAgICAgICBjYXNlICJoMSI6CiAgICAgICAgICAgICAgY2FzZSAiaDIiOgogICAgICAgICAgICAgIGNhc2UgImgzIjoKICAgICAgICAgICAgICBjYXNlICJoNCI6CiAgICAgICAgICAgICAgY2FzZSAiaDUiOgogICAgICAgICAgICAgIGNhc2UgImg2IjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ucFRhZ0luQnV0dG9uU2NvcGU7CiAgICAgICAgICAgICAgY2FzZSAiZm9ybSI6CiAgICAgICAgICAgICAgICByZXR1cm4gYW5jZXN0b3JJbmZvLmZvcm1UYWcgfHwgYW5jZXN0b3JJbmZvLnBUYWdJbkJ1dHRvblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgImxpIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ubGlzdEl0ZW1UYWdBdXRvY2xvc2luZzsKICAgICAgICAgICAgICBjYXNlICJkZCI6CiAgICAgICAgICAgICAgY2FzZSAiZHQiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5kbEl0ZW1UYWdBdXRvY2xvc2luZzsKICAgICAgICAgICAgICBjYXNlICJidXR0b24iOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5idXR0b25UYWdJblNjb3BlOwogICAgICAgICAgICAgIGNhc2UgImEiOgogICAgICAgICAgICAgICAgcmV0dXJuIGFuY2VzdG9ySW5mby5hVGFnSW5TY29wZTsKICAgICAgICAgICAgICBjYXNlICJub2JyIjoKICAgICAgICAgICAgICAgIHJldHVybiBhbmNlc3RvckluZm8ubm9iclRhZ0luU2NvcGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGRpZFdhcm4kMSA9IHt9OwogICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nID0gZnVuY3Rpb24oY2hpbGRUYWcsIGNoaWxkVGV4dCwgYW5jZXN0b3JJbmZvKSB7CiAgICAgICAgICAgIGFuY2VzdG9ySW5mbyA9IGFuY2VzdG9ySW5mbyB8fCBlbXB0eUFuY2VzdG9ySW5mbzsKICAgICAgICAgICAgdmFyIHBhcmVudEluZm8gPSBhbmNlc3RvckluZm8uY3VycmVudDsKICAgICAgICAgICAgdmFyIHBhcmVudFRhZyA9IHBhcmVudEluZm8gJiYgcGFyZW50SW5mby50YWc7CiAgICAgICAgICAgIGlmIChjaGlsZFRleHQgIT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjaGlsZFRhZyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcigidmFsaWRhdGVET01OZXN0aW5nOiB3aGVuIGNoaWxkVGV4dCBpcyBwYXNzZWQsIGNoaWxkVGFnIHNob3VsZCBiZSBudWxsIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkVGFnID0gIiN0ZXh0IjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaW52YWxpZFBhcmVudCA9IGlzVGFnVmFsaWRXaXRoUGFyZW50KGNoaWxkVGFnLCBwYXJlbnRUYWcpID8gbnVsbCA6IHBhcmVudEluZm87CiAgICAgICAgICAgIHZhciBpbnZhbGlkQW5jZXN0b3IgPSBpbnZhbGlkUGFyZW50ID8gbnVsbCA6IGZpbmRJbnZhbGlkQW5jZXN0b3JGb3JUYWcoY2hpbGRUYWcsIGFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIHZhciBpbnZhbGlkUGFyZW50T3JBbmNlc3RvciA9IGludmFsaWRQYXJlbnQgfHwgaW52YWxpZEFuY2VzdG9yOwogICAgICAgICAgICBpZiAoIWludmFsaWRQYXJlbnRPckFuY2VzdG9yKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhbmNlc3RvclRhZyA9IGludmFsaWRQYXJlbnRPckFuY2VzdG9yLnRhZzsKICAgICAgICAgICAgdmFyIHdhcm5LZXkgPSAhIWludmFsaWRQYXJlbnQgKyAifCIgKyBjaGlsZFRhZyArICJ8IiArIGFuY2VzdG9yVGFnOwogICAgICAgICAgICBpZiAoZGlkV2FybiQxW3dhcm5LZXldKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRpZFdhcm4kMVt3YXJuS2V5XSA9IHRydWU7CiAgICAgICAgICAgIHZhciB0YWdEaXNwbGF5TmFtZSA9IGNoaWxkVGFnOwogICAgICAgICAgICB2YXIgd2hpdGVzcGFjZUluZm8gPSAiIjsKICAgICAgICAgICAgaWYgKGNoaWxkVGFnID09PSAiI3RleHQiKSB7CiAgICAgICAgICAgICAgaWYgKC9cUy8udGVzdChjaGlsZFRleHQpKSB7CiAgICAgICAgICAgICAgICB0YWdEaXNwbGF5TmFtZSA9ICJUZXh0IG5vZGVzIjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFnRGlzcGxheU5hbWUgPSAiV2hpdGVzcGFjZSB0ZXh0IG5vZGVzIjsKICAgICAgICAgICAgICAgIHdoaXRlc3BhY2VJbmZvID0gIiBNYWtlIHN1cmUgeW91IGRvbid0IGhhdmUgYW55IGV4dHJhIHdoaXRlc3BhY2UgYmV0d2VlbiB0YWdzIG9uIGVhY2ggbGluZSBvZiB5b3VyIHNvdXJjZSBjb2RlLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRhZ0Rpc3BsYXlOYW1lID0gIjwiICsgY2hpbGRUYWcgKyAiPiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGludmFsaWRQYXJlbnQpIHsKICAgICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICAgIGlmIChhbmNlc3RvclRhZyA9PT0gInRhYmxlIiAmJiBjaGlsZFRhZyA9PT0gInRyIikgewogICAgICAgICAgICAgICAgaW5mbyArPSAiIEFkZCBhIDx0Ym9keT4sIDx0aGVhZD4gb3IgPHRmb290PiB0byB5b3VyIGNvZGUgdG8gbWF0Y2ggdGhlIERPTSB0cmVlIGdlbmVyYXRlZCBieSB0aGUgYnJvd3Nlci4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBlcnJvcigidmFsaWRhdGVET01OZXN0aW5nKC4uLik6ICVzIGNhbm5vdCBhcHBlYXIgYXMgYSBjaGlsZCBvZiA8JXM+LiVzJXMiLCB0YWdEaXNwbGF5TmFtZSwgYW5jZXN0b3JUYWcsIHdoaXRlc3BhY2VJbmZvLCBpbmZvKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBlcnJvcigidmFsaWRhdGVET01OZXN0aW5nKC4uLik6ICVzIGNhbm5vdCBhcHBlYXIgYXMgYSBkZXNjZW5kYW50IG9mIDwlcz4uIiwgdGFnRGlzcGxheU5hbWUsIGFuY2VzdG9yVGFnKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIFNVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDEgPSAic3VwcHJlc3NIeWRyYXRpb25XYXJuaW5nIjsKICAgICAgICB2YXIgU1VTUEVOU0VfU1RBUlRfREFUQSA9ICIkIjsKICAgICAgICB2YXIgU1VTUEVOU0VfRU5EX0RBVEEgPSAiLyQiOwogICAgICAgIHZhciBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEgPSAiJD8iOwogICAgICAgIHZhciBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBID0gIiQhIjsKICAgICAgICB2YXIgU1RZTEUkMSA9ICJzdHlsZSI7CiAgICAgICAgdmFyIGV2ZW50c0VuYWJsZWQgPSBudWxsOwogICAgICAgIHZhciBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gZ2V0Um9vdEhvc3RDb250ZXh0KHJvb3RDb250YWluZXJJbnN0YW5jZSkgewogICAgICAgICAgdmFyIHR5cGU7CiAgICAgICAgICB2YXIgbmFtZXNwYWNlOwogICAgICAgICAgdmFyIG5vZGVUeXBlID0gcm9vdENvbnRhaW5lckluc3RhbmNlLm5vZGVUeXBlOwogICAgICAgICAgc3dpdGNoIChub2RlVHlwZSkgewogICAgICAgICAgICBjYXNlIERPQ1VNRU5UX05PREU6CiAgICAgICAgICAgIGNhc2UgRE9DVU1FTlRfRlJBR01FTlRfTk9ERTogewogICAgICAgICAgICAgIHR5cGUgPSBub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSA/ICIjZG9jdW1lbnQiIDogIiNmcmFnbWVudCI7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcm9vdENvbnRhaW5lckluc3RhbmNlLmRvY3VtZW50RWxlbWVudDsKICAgICAgICAgICAgICBuYW1lc3BhY2UgPSByb290MyA/IHJvb3QzLm5hbWVzcGFjZVVSSSA6IGdldENoaWxkTmFtZXNwYWNlKG51bGwsICIiKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lcjIgPSBub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gcm9vdENvbnRhaW5lckluc3RhbmNlLnBhcmVudE5vZGUgOiByb290Q29udGFpbmVySW5zdGFuY2U7CiAgICAgICAgICAgICAgdmFyIG93bk5hbWVzcGFjZSA9IGNvbnRhaW5lcjIubmFtZXNwYWNlVVJJIHx8IG51bGw7CiAgICAgICAgICAgICAgdHlwZSA9IGNvbnRhaW5lcjIudGFnTmFtZTsKICAgICAgICAgICAgICBuYW1lc3BhY2UgPSBnZXRDaGlsZE5hbWVzcGFjZShvd25OYW1lc3BhY2UsIHR5cGUpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB2YWxpZGF0ZWRUYWcgPSB0eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIHZhciBhbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKG51bGwsIHZhbGlkYXRlZFRhZyk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbmFtZXNwYWNlLAogICAgICAgICAgICAgIGFuY2VzdG9ySW5mbwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDaGlsZEhvc3RDb250ZXh0KHBhcmVudEhvc3RDb250ZXh0LCB0eXBlLCByb290Q29udGFpbmVySW5zdGFuY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHBhcmVudEhvc3RDb250ZXh0RGV2ID0gcGFyZW50SG9zdENvbnRleHQ7CiAgICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSBnZXRDaGlsZE5hbWVzcGFjZShwYXJlbnRIb3N0Q29udGV4dERldi5uYW1lc3BhY2UsIHR5cGUpOwogICAgICAgICAgICB2YXIgYW5jZXN0b3JJbmZvID0gdXBkYXRlZEFuY2VzdG9ySW5mbyhwYXJlbnRIb3N0Q29udGV4dERldi5hbmNlc3RvckluZm8sIHR5cGUpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIG5hbWVzcGFjZSwKICAgICAgICAgICAgICBhbmNlc3RvckluZm8KICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UHVibGljSW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZUZvckNvbW1pdChjb250YWluZXJJbmZvKSB7CiAgICAgICAgICBldmVudHNFbmFibGVkID0gaXNFbmFibGVkKCk7CiAgICAgICAgICBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IGdldFNlbGVjdGlvbkluZm9ybWF0aW9uKCk7CiAgICAgICAgICB2YXIgYWN0aXZlSW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgc2V0RW5hYmxlZChmYWxzZSk7CiAgICAgICAgICByZXR1cm4gYWN0aXZlSW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0QWZ0ZXJDb21taXQoY29udGFpbmVySW5mbykgewogICAgICAgICAgcmVzdG9yZVNlbGVjdGlvbihzZWxlY3Rpb25JbmZvcm1hdGlvbik7CiAgICAgICAgICBzZXRFbmFibGVkKGV2ZW50c0VuYWJsZWQpOwogICAgICAgICAgZXZlbnRzRW5hYmxlZCA9IG51bGw7CiAgICAgICAgICBzZWxlY3Rpb25JbmZvcm1hdGlvbiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUluc3RhbmNlKHR5cGUsIHByb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICB2YXIgcGFyZW50TmFtZXNwYWNlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKHR5cGUsIG51bGwsIGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMuY2hpbGRyZW4gPT09ICJzdHJpbmciIHx8IHR5cGVvZiBwcm9wcy5jaGlsZHJlbiA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICB2YXIgc3RyaW5nID0gIiIgKyBwcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgb3duQW5jZXN0b3JJbmZvID0gdXBkYXRlZEFuY2VzdG9ySW5mbyhob3N0Q29udGV4dERldi5hbmNlc3RvckluZm8sIHR5cGUpOwogICAgICAgICAgICAgIHZhbGlkYXRlRE9NTmVzdGluZyhudWxsLCBzdHJpbmcsIG93bkFuY2VzdG9ySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFyZW50TmFtZXNwYWNlID0gaG9zdENvbnRleHREZXYubmFtZXNwYWNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGRvbUVsZW1lbnQgPSBjcmVhdGVFbGVtZW50MzkodHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgcGFyZW50TmFtZXNwYWNlKTsKICAgICAgICAgIHByZWNhY2hlRmliZXJOb2RlKGludGVybmFsSW5zdGFuY2VIYW5kbGUsIGRvbUVsZW1lbnQpOwogICAgICAgICAgdXBkYXRlRmliZXJQcm9wcyhkb21FbGVtZW50LCBwcm9wcyk7CiAgICAgICAgICByZXR1cm4gZG9tRWxlbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXBwZW5kSW5pdGlhbENoaWxkKHBhcmVudEluc3RhbmNlLCBjaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UuYXBwZW5kQ2hpbGQoY2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5hbGl6ZUluaXRpYWxDaGlsZHJlbihkb21FbGVtZW50LCB0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCkgewogICAgICAgICAgc2V0SW5pdGlhbFByb3BlcnRpZXMoZG9tRWxlbWVudCwgdHlwZSwgcHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSk7CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSAiYnV0dG9uIjoKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgcmV0dXJuICEhcHJvcHMuYXV0b0ZvY3VzOwogICAgICAgICAgICBjYXNlICJpbWciOgogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVVwZGF0ZShkb21FbGVtZW50LCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaG9zdENvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvc3RDb250ZXh0RGV2ID0gaG9zdENvbnRleHQ7CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3UHJvcHMuY2hpbGRyZW4gIT09IHR5cGVvZiBvbGRQcm9wcy5jaGlsZHJlbiAmJiAodHlwZW9mIG5ld1Byb3BzLmNoaWxkcmVuID09PSAic3RyaW5nIiB8fCB0eXBlb2YgbmV3UHJvcHMuY2hpbGRyZW4gPT09ICJudW1iZXIiKSkgewogICAgICAgICAgICAgIHZhciBzdHJpbmcgPSAiIiArIG5ld1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBvd25BbmNlc3RvckluZm8gPSB1cGRhdGVkQW5jZXN0b3JJbmZvKGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbywgdHlwZSk7CiAgICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKG51bGwsIHN0cmluZywgb3duQW5jZXN0b3JJbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGRpZmZQcm9wZXJ0aWVzKGRvbUVsZW1lbnQsIHR5cGUsIG9sZFByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFNldFRleHRDb250ZW50KHR5cGUsIHByb3BzKSB7CiAgICAgICAgICByZXR1cm4gdHlwZSA9PT0gInRleHRhcmVhIiB8fCB0eXBlID09PSAibm9zY3JpcHQiIHx8IHR5cGVvZiBwcm9wcy5jaGlsZHJlbiA9PT0gInN0cmluZyIgfHwgdHlwZW9mIHByb3BzLmNoaWxkcmVuID09PSAibnVtYmVyIiB8fCB0eXBlb2YgcHJvcHMuZGFuZ2Vyb3VzbHlTZXRJbm5lckhUTUwgPT09ICJvYmplY3QiICYmIHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MICE9PSBudWxsICYmIHByb3BzLmRhbmdlcm91c2x5U2V0SW5uZXJIVE1MLl9faHRtbCAhPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVUZXh0SW5zdGFuY2UodGV4dCwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9zdENvbnRleHREZXYgPSBob3N0Q29udGV4dDsKICAgICAgICAgICAgdmFsaWRhdGVET01OZXN0aW5nKG51bGwsIHRleHQsIGhvc3RDb250ZXh0RGV2LmFuY2VzdG9ySW5mbyk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdGV4dE5vZGUgPSBjcmVhdGVUZXh0Tm9kZSh0ZXh0LCByb290Q29udGFpbmVySW5zdGFuY2UpOwogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgdGV4dE5vZGUpOwogICAgICAgICAgcmV0dXJuIHRleHROb2RlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RXZlbnRQcmlvcml0eSgpIHsKICAgICAgICAgIHZhciBjdXJyZW50RXZlbnQgPSB3aW5kb3cuZXZlbnQ7CiAgICAgICAgICBpZiAoY3VycmVudEV2ZW50ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIERlZmF1bHRFdmVudFByaW9yaXR5OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldEV2ZW50UHJpb3JpdHkoY3VycmVudEV2ZW50LnR5cGUpOwogICAgICAgIH0KICAgICAgICB2YXIgc2NoZWR1bGVUaW1lb3V0ID0gdHlwZW9mIHNldFRpbWVvdXQgPT09ICJmdW5jdGlvbiIgPyBzZXRUaW1lb3V0IDogdm9pZCAwOwogICAgICAgIHZhciBjYW5jZWxUaW1lb3V0ID0gdHlwZW9mIGNsZWFyVGltZW91dCA9PT0gImZ1bmN0aW9uIiA/IGNsZWFyVGltZW91dCA6IHZvaWQgMDsKICAgICAgICB2YXIgbm9UaW1lb3V0ID0gLTE7CiAgICAgICAgdmFyIGxvY2FsUHJvbWlzZSA9IHR5cGVvZiBQcm9taXNlID09PSAiZnVuY3Rpb24iID8gUHJvbWlzZSA6IHZvaWQgMDsKICAgICAgICB2YXIgc2NoZWR1bGVNaWNyb3Rhc2sgPSB0eXBlb2YgcXVldWVNaWNyb3Rhc2sgPT09ICJmdW5jdGlvbiIgPyBxdWV1ZU1pY3JvdGFzayA6IHR5cGVvZiBsb2NhbFByb21pc2UgIT09ICJ1bmRlZmluZWQiID8gZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgIHJldHVybiBsb2NhbFByb21pc2UucmVzb2x2ZShudWxsKS50aGVuKGNhbGxiYWNrKS5jYXRjaChoYW5kbGVFcnJvckluTmV4dFRpY2spOwogICAgICAgIH0gOiBzY2hlZHVsZVRpbWVvdXQ7CiAgICAgICAgZnVuY3Rpb24gaGFuZGxlRXJyb3JJbk5leHRUaWNrKGVycm9yMikgewogICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdE1vdW50KGRvbUVsZW1lbnQsIHR5cGUsIG5ld1Byb3BzLCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgY2FzZSAiYnV0dG9uIjoKICAgICAgICAgICAgY2FzZSAiaW5wdXQiOgogICAgICAgICAgICBjYXNlICJzZWxlY3QiOgogICAgICAgICAgICBjYXNlICJ0ZXh0YXJlYSI6CiAgICAgICAgICAgICAgaWYgKG5ld1Byb3BzLmF1dG9Gb2N1cykgewogICAgICAgICAgICAgICAgZG9tRWxlbWVudC5mb2N1cygpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGNhc2UgImltZyI6IHsKICAgICAgICAgICAgICBpZiAobmV3UHJvcHMuc3JjKSB7CiAgICAgICAgICAgICAgICBkb21FbGVtZW50LnNyYyA9IG5ld1Byb3BzLnNyYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFVwZGF0ZShkb21FbGVtZW50LCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIGludGVybmFsSW5zdGFuY2VIYW5kbGUpIHsKICAgICAgICAgIHVwZGF0ZVByb3BlcnRpZXMoZG9tRWxlbWVudCwgdXBkYXRlUGF5bG9hZCwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICAgIHVwZGF0ZUZpYmVyUHJvcHMoZG9tRWxlbWVudCwgbmV3UHJvcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldFRleHRDb250ZW50KGRvbUVsZW1lbnQpIHsKICAgICAgICAgIHNldFRleHRDb250ZW50KGRvbUVsZW1lbnQsICIiKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0VGV4dFVwZGF0ZSh0ZXh0SW5zdGFuY2UsIG9sZFRleHQsIG5ld1RleHQpIHsKICAgICAgICAgIHRleHRJbnN0YW5jZS5ub2RlVmFsdWUgPSBuZXdUZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcHBlbmRDaGlsZChwYXJlbnRJbnN0YW5jZSwgY2hpbGQpIHsKICAgICAgICAgIHBhcmVudEluc3RhbmNlLmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXBwZW5kQ2hpbGRUb0NvbnRhaW5lcihjb250YWluZXIyLCBjaGlsZCkgewogICAgICAgICAgdmFyIHBhcmVudE5vZGU7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIHBhcmVudE5vZGUgPSBjb250YWluZXIyLnBhcmVudE5vZGU7CiAgICAgICAgICAgIHBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkLCBjb250YWluZXIyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhcmVudE5vZGUgPSBjb250YWluZXIyOwogICAgICAgICAgICBwYXJlbnROb2RlLmFwcGVuZENoaWxkKGNoaWxkKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciByZWFjdFJvb3RDb250YWluZXIgPSBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICBpZiAoKHJlYWN0Um9vdENvbnRhaW5lciA9PT0gbnVsbCB8fCByZWFjdFJvb3RDb250YWluZXIgPT09IHZvaWQgMCkgJiYgcGFyZW50Tm9kZS5vbmNsaWNrID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyYXBDbGlja09uTm9uSW50ZXJhY3RpdmVFbGVtZW50KHBhcmVudE5vZGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnNlcnRCZWZvcmUocGFyZW50SW5zdGFuY2UsIGNoaWxkLCBiZWZvcmVDaGlsZCkgewogICAgICAgICAgcGFyZW50SW5zdGFuY2UuaW5zZXJ0QmVmb3JlKGNoaWxkLCBiZWZvcmVDaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydEluQ29udGFpbmVyQmVmb3JlKGNvbnRhaW5lcjIsIGNoaWxkLCBiZWZvcmVDaGlsZCkgewogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICBjb250YWluZXIyLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGNoaWxkLCBiZWZvcmVDaGlsZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250YWluZXIyLmluc2VydEJlZm9yZShjaGlsZCwgYmVmb3JlQ2hpbGQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdmVDaGlsZChwYXJlbnRJbnN0YW5jZSwgY2hpbGQpIHsKICAgICAgICAgIHBhcmVudEluc3RhbmNlLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVtb3ZlQ2hpbGRGcm9tQ29udGFpbmVyKGNvbnRhaW5lcjIsIGNoaWxkKSB7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250YWluZXIyLnJlbW92ZUNoaWxkKGNoaWxkKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xlYXJTdXNwZW5zZUJvdW5kYXJ5KHBhcmVudEluc3RhbmNlLCBzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHN1c3BlbnNlSW5zdGFuY2U7CiAgICAgICAgICB2YXIgZGVwdGggPSAwOwogICAgICAgICAgZG8gewogICAgICAgICAgICB2YXIgbmV4dE5vZGUgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICBwYXJlbnRJbnN0YW5jZS5yZW1vdmVDaGlsZChub2RlKTsKICAgICAgICAgICAgaWYgKG5leHROb2RlICYmIG5leHROb2RlLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgICB2YXIgZGF0YSA9IG5leHROb2RlLmRhdGE7CiAgICAgICAgICAgICAgaWYgKGRhdGEgPT09IFNVU1BFTlNFX0VORF9EQVRBKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UucmVtb3ZlQ2hpbGQobmV4dE5vZGUpOwogICAgICAgICAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZXB0aC0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSkgewogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5leHROb2RlOwogICAgICAgICAgfSB3aGlsZSAobm9kZSk7CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhclN1c3BlbnNlQm91bmRhcnlGcm9tQ29udGFpbmVyKGNvbnRhaW5lcjIsIHN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgIGlmIChjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgY2xlYXJTdXNwZW5zZUJvdW5kYXJ5KGNvbnRhaW5lcjIucGFyZW50Tm9kZSwgc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICBjbGVhclN1c3BlbnNlQm91bmRhcnkoY29udGFpbmVyMiwgc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKGNvbnRhaW5lcjIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWRlSW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2U7CiAgICAgICAgICB2YXIgc3R5bGUyID0gaW5zdGFuY2Uuc3R5bGU7CiAgICAgICAgICBpZiAodHlwZW9mIHN0eWxlMi5zZXRQcm9wZXJ0eSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBzdHlsZTIuc2V0UHJvcGVydHkoImRpc3BsYXkiLCAibm9uZSIsICJpbXBvcnRhbnQiKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0eWxlMi5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoaWRlVGV4dEluc3RhbmNlKHRleHRJbnN0YW5jZSkgewogICAgICAgICAgdGV4dEluc3RhbmNlLm5vZGVWYWx1ZSA9ICIiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bmhpZGVJbnN0YW5jZShpbnN0YW5jZSwgcHJvcHMpIHsKICAgICAgICAgIGluc3RhbmNlID0gaW5zdGFuY2U7CiAgICAgICAgICB2YXIgc3R5bGVQcm9wID0gcHJvcHNbU1RZTEUkMV07CiAgICAgICAgICB2YXIgZGlzcGxheSA9IHN0eWxlUHJvcCAhPT0gdm9pZCAwICYmIHN0eWxlUHJvcCAhPT0gbnVsbCAmJiBzdHlsZVByb3AuaGFzT3duUHJvcGVydHkoImRpc3BsYXkiKSA/IHN0eWxlUHJvcC5kaXNwbGF5IDogbnVsbDsKICAgICAgICAgIGluc3RhbmNlLnN0eWxlLmRpc3BsYXkgPSBkYW5nZXJvdXNTdHlsZVZhbHVlKCJkaXNwbGF5IiwgZGlzcGxheSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuaGlkZVRleHRJbnN0YW5jZSh0ZXh0SW5zdGFuY2UsIHRleHQpIHsKICAgICAgICAgIHRleHRJbnN0YW5jZS5ub2RlVmFsdWUgPSB0ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjbGVhckNvbnRhaW5lcihjb250YWluZXIyKSB7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIudGV4dENvbnRlbnQgPSAiIjsKICAgICAgICAgIH0gZWxzZSBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSkgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5kb2N1bWVudEVsZW1lbnQpIHsKICAgICAgICAgICAgICBjb250YWluZXIyLnJlbW92ZUNoaWxkKGNvbnRhaW5lcjIuZG9jdW1lbnRFbGVtZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5IeWRyYXRlSW5zdGFuY2UoaW5zdGFuY2UsIHR5cGUsIHByb3BzKSB7CiAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgIT09IEVMRU1FTlRfTk9ERSB8fCB0eXBlLnRvTG93ZXJDYXNlKCkgIT09IGluc3RhbmNlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbkh5ZHJhdGVUZXh0SW5zdGFuY2UoaW5zdGFuY2UsIHRleHQpIHsKICAgICAgICAgIGlmICh0ZXh0ID09PSAiIiB8fCBpbnN0YW5jZS5ub2RlVHlwZSAhPT0gVEVYVF9OT0RFKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYW5IeWRyYXRlU3VzcGVuc2VJbnN0YW5jZShpbnN0YW5jZSkgewogICAgICAgICAgaWYgKGluc3RhbmNlLm5vZGVUeXBlICE9PSBDT01NRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU3VzcGVuc2VJbnN0YW5jZVBlbmRpbmcoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBpbnN0YW5jZS5kYXRhID09PSBTVVNQRU5TRV9QRU5ESU5HX1NUQVJUX0RBVEE7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gaW5zdGFuY2UuZGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0U3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrRXJyb3JEZXRhaWxzKGluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgZGF0YXNldCA9IGluc3RhbmNlLm5leHRTaWJsaW5nICYmIGluc3RhbmNlLm5leHRTaWJsaW5nLmRhdGFzZXQ7CiAgICAgICAgICB2YXIgZGlnZXN0LCBtZXNzYWdlLCBzdGFjazsKICAgICAgICAgIGlmIChkYXRhc2V0KSB7CiAgICAgICAgICAgIGRpZ2VzdCA9IGRhdGFzZXQuZGdzdDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1lc3NhZ2UgPSBkYXRhc2V0Lm1zZzsKICAgICAgICAgICAgICBzdGFjayA9IGRhdGFzZXQuc3RjazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIG1lc3NhZ2UsCiAgICAgICAgICAgICAgZGlnZXN0LAogICAgICAgICAgICAgIHN0YWNrCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyU3VzcGVuc2VJbnN0YW5jZVJldHJ5KGluc3RhbmNlLCBjYWxsYmFjaykgewogICAgICAgICAgaW5zdGFuY2UuX3JlYWN0UmV0cnkgPSBjYWxsYmFjazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dEh5ZHJhdGFibGUobm9kZSkgewogICAgICAgICAgZm9yICg7IG5vZGUgIT0gbnVsbDsgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgdmFyIG5vZGVUeXBlID0gbm9kZS5ub2RlVHlwZTsKICAgICAgICAgICAgaWYgKG5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgfHwgbm9kZVR5cGUgPT09IFRFWFRfTk9ERSkgewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSB7CiAgICAgICAgICAgICAgdmFyIG5vZGVEYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgIGlmIChub2RlRGF0YSA9PT0gU1VTUEVOU0VfU1RBUlRfREFUQSB8fCBub2RlRGF0YSA9PT0gU1VTUEVOU0VfRkFMTEJBQ0tfU1RBUlRfREFUQSB8fCBub2RlRGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGVEYXRhID09PSBTVVNQRU5TRV9FTkRfREFUQSkgewogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKGluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGUoaW5zdGFuY2UubmV4dFNpYmxpbmcpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZChwYXJlbnRJbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKHBhcmVudEluc3RhbmNlLmZpcnN0Q2hpbGQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZFdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIpIHsKICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZShwYXJlbnRDb250YWluZXIuZmlyc3RDaGlsZCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluU3VzcGVuc2VJbnN0YW5jZShwYXJlbnRJbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGdldE5leHRIeWRyYXRhYmxlKHBhcmVudEluc3RhbmNlLm5leHRTaWJsaW5nKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaHlkcmF0ZUluc3RhbmNlKGluc3RhbmNlLCB0eXBlLCBwcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgc2hvdWxkV2FybkRldikgewogICAgICAgICAgcHJlY2FjaGVGaWJlck5vZGUoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZSwgaW5zdGFuY2UpOwogICAgICAgICAgdXBkYXRlRmliZXJQcm9wcyhpbnN0YW5jZSwgcHJvcHMpOwogICAgICAgICAgdmFyIHBhcmVudE5hbWVzcGFjZTsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvc3RDb250ZXh0RGV2ID0gaG9zdENvbnRleHQ7CiAgICAgICAgICAgIHBhcmVudE5hbWVzcGFjZSA9IGhvc3RDb250ZXh0RGV2Lm5hbWVzcGFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKGludGVybmFsSW5zdGFuY2VIYW5kbGUubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgcmV0dXJuIGRpZmZIeWRyYXRlZFByb3BlcnRpZXMoaW5zdGFuY2UsIHR5cGUsIHByb3BzLCBwYXJlbnROYW1lc3BhY2UsIHJvb3RDb250YWluZXJJbnN0YW5jZSwgaXNDb25jdXJyZW50TW9kZSwgc2hvdWxkV2FybkRldik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGh5ZHJhdGVUZXh0SW5zdGFuY2UodGV4dEluc3RhbmNlLCB0ZXh0LCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBzaG91bGRXYXJuRGV2KSB7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCB0ZXh0SW5zdGFuY2UpOwogICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAoaW50ZXJuYWxJbnN0YW5jZUhhbmRsZS5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICByZXR1cm4gZGlmZkh5ZHJhdGVkVGV4dCh0ZXh0SW5zdGFuY2UsIHRleHQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlLCBpbnRlcm5hbEluc3RhbmNlSGFuZGxlKSB7CiAgICAgICAgICBwcmVjYWNoZUZpYmVyTm9kZShpbnRlcm5hbEluc3RhbmNlSGFuZGxlLCBzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0TmV4dEh5ZHJhdGFibGVJbnN0YW5jZUFmdGVyU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHN1c3BlbnNlSW5zdGFuY2UubmV4dFNpYmxpbmc7CiAgICAgICAgICB2YXIgZGVwdGggPSAwOwogICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgIGlmIChkYXRhID09PSBTVVNQRU5TRV9FTkRfREFUQSkgewogICAgICAgICAgICAgICAgaWYgKGRlcHRoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcobm9kZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZXB0aC0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfU1RBUlRfREFUQSB8fCBkYXRhID09PSBTVVNQRU5TRV9GQUxMQkFDS19TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX1BFTkRJTkdfU1RBUlRfREFUQSkgewogICAgICAgICAgICAgICAgZGVwdGgrKzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UGFyZW50U3VzcGVuc2VJbnN0YW5jZSh0YXJnZXRJbnN0YW5jZSkgewogICAgICAgICAgdmFyIG5vZGUgPSB0YXJnZXRJbnN0YW5jZS5wcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICB2YXIgZGVwdGggPSAwOwogICAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgIGlmIChkYXRhID09PSBTVVNQRU5TRV9TVEFSVF9EQVRBIHx8IGRhdGEgPT09IFNVU1BFTlNFX0ZBTExCQUNLX1NUQVJUX0RBVEEgfHwgZGF0YSA9PT0gU1VTUEVOU0VfUEVORElOR19TVEFSVF9EQVRBKSB7CiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZXB0aC0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YSA9PT0gU1VTUEVOU0VfRU5EX0RBVEEpIHsKICAgICAgICAgICAgICAgIGRlcHRoKys7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRIeWRyYXRlZENvbnRhaW5lcihjb250YWluZXIyKSB7CiAgICAgICAgICByZXRyeUlmQmxvY2tlZE9uKGNvbnRhaW5lcjIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRIeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSkgewogICAgICAgICAgcmV0cnlJZkJsb2NrZWRPbihzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkRGVsZXRlVW5oeWRyYXRlZFRhaWxJbnN0YW5jZXMocGFyZW50VHlwZSkgewogICAgICAgICAgcmV0dXJuIHBhcmVudFR5cGUgIT09ICJoZWFkIiAmJiBwYXJlbnRUeXBlICE9PSAiYm9keSI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdE1hdGNoSHlkcmF0ZWRDb250YWluZXJUZXh0SW5zdGFuY2UocGFyZW50Q29udGFpbmVyLCB0ZXh0SW5zdGFuY2UsIHRleHQsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHZhciBzaG91bGRXYXJuRGV2ID0gdHJ1ZTsKICAgICAgICAgIGNoZWNrRm9yVW5tYXRjaGVkVGV4dCh0ZXh0SW5zdGFuY2Uubm9kZVZhbHVlLCB0ZXh0LCBpc0NvbmN1cnJlbnRNb2RlLCBzaG91bGRXYXJuRGV2KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90TWF0Y2hIeWRyYXRlZFRleHRJbnN0YW5jZShwYXJlbnRUeXBlLCBwYXJlbnRQcm9wcywgcGFyZW50SW5zdGFuY2UsIHRleHRJbnN0YW5jZSwgdGV4dCwgaXNDb25jdXJyZW50TW9kZSkgewogICAgICAgICAgaWYgKHBhcmVudFByb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDFdICE9PSB0cnVlKSB7CiAgICAgICAgICAgIHZhciBzaG91bGRXYXJuRGV2ID0gdHJ1ZTsKICAgICAgICAgICAgY2hlY2tGb3JVbm1hdGNoZWRUZXh0KHRleHRJbnN0YW5jZS5ub2RlVmFsdWUsIHRleHQsIGlzQ29uY3VycmVudE1vZGUsIHNob3VsZFdhcm5EZXYpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RIeWRyYXRlSW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHdhcm5Gb3JEZWxldGVkSHlkcmF0YWJsZUVsZW1lbnQocGFyZW50Q29udGFpbmVyLCBpbnN0YW5jZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudENvbnRhaW5lciwgaW5zdGFuY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UocGFyZW50SW5zdGFuY2UsIGluc3RhbmNlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gcGFyZW50SW5zdGFuY2UucGFyZW50Tm9kZTsKICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnROb2RlLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChpbnN0YW5jZS5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFKSA7CiAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB3YXJuRm9yRGVsZXRlZEh5ZHJhdGFibGVUZXh0KHBhcmVudE5vZGUsIGluc3RhbmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90SHlkcmF0ZUluc3RhbmNlKHBhcmVudFR5cGUsIHBhcmVudFByb3BzLCBwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgfHwgcGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgICBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSkgewogICAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlRWxlbWVudChwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5zdGFuY2Uubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSkgOwogICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgd2FybkZvckRlbGV0ZWRIeWRyYXRhYmxlVGV4dChwYXJlbnRJbnN0YW5jZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZUluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdHlwZSwgcHJvcHMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudENvbnRhaW5lciwgdHlwZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluQ29udGFpbmVyKHBhcmVudENvbnRhaW5lciwgdGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZFRleHQocGFyZW50Q29udGFpbmVyLCB0ZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2UocGFyZW50SW5zdGFuY2UsIHR5cGUsIHByb3BzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gcGFyZW50SW5zdGFuY2UucGFyZW50Tm9kZTsKICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgIT09IG51bGwpIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkRWxlbWVudChwYXJlbnROb2RlLCB0eXBlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVUZXh0SW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKHBhcmVudEluc3RhbmNlLCB0ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBwYXJlbnROb2RlID0gcGFyZW50SW5zdGFuY2UucGFyZW50Tm9kZTsKICAgICAgICAgICAgaWYgKHBhcmVudE5vZGUgIT09IG51bGwpIHdhcm5Gb3JJbnNlcnRlZEh5ZHJhdGVkVGV4dChwYXJlbnROb2RlLCB0ZXh0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZShwYXJlbnRUeXBlLCBwYXJlbnRQcm9wcywgcGFyZW50SW5zdGFuY2UsIHR5cGUsIHByb3BzLCBpc0NvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0NvbmN1cnJlbnRNb2RlIHx8IHBhcmVudFByb3BzW1NVUFBSRVNTX0hZRFJBVElPTl9XQVJOSU5HJDFdICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgd2FybkZvckluc2VydGVkSHlkcmF0ZWRFbGVtZW50KHBhcmVudEluc3RhbmNlLCB0eXBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZShwYXJlbnRUeXBlLCBwYXJlbnRQcm9wcywgcGFyZW50SW5zdGFuY2UsIHRleHQsIGlzQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzQ29uY3VycmVudE1vZGUgfHwgcGFyZW50UHJvcHNbU1VQUFJFU1NfSFlEUkFUSU9OX1dBUk5JTkckMV0gIT09IHRydWUpIHsKICAgICAgICAgICAgICB3YXJuRm9ySW5zZXJ0ZWRIeWRyYXRlZFRleHQocGFyZW50SW5zdGFuY2UsIHRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVycm9ySHlkcmF0aW5nQ29udGFpbmVyKHBhcmVudENvbnRhaW5lcikgewogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiQW4gZXJyb3Igb2NjdXJyZWQgZHVyaW5nIGh5ZHJhdGlvbi4gVGhlIHNlcnZlciBIVE1MIHdhcyByZXBsYWNlZCB3aXRoIGNsaWVudCBjb250ZW50IGluIDwlcz4uIiwgcGFyZW50Q29udGFpbmVyLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlUG9ydGFsTW91bnQocG9ydGFsSW5zdGFuY2UpIHsKICAgICAgICAgIGxpc3RlblRvQWxsU3VwcG9ydGVkRXZlbnRzKHBvcnRhbEluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgdmFyIHJhbmRvbUtleSA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnNsaWNlKDIpOwogICAgICAgIHZhciBpbnRlcm5hbEluc3RhbmNlS2V5ID0gIl9fcmVhY3RGaWJlciQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbFByb3BzS2V5ID0gIl9fcmVhY3RQcm9wcyQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5ID0gIl9fcmVhY3RDb250YWluZXIkIiArIHJhbmRvbUtleTsKICAgICAgICB2YXIgaW50ZXJuYWxFdmVudEhhbmRsZXJzS2V5ID0gIl9fcmVhY3RFdmVudHMkIiArIHJhbmRvbUtleTsKICAgICAgICB2YXIgaW50ZXJuYWxFdmVudEhhbmRsZXJMaXN0ZW5lcnNLZXkgPSAiX19yZWFjdExpc3RlbmVycyQiICsgcmFuZG9tS2V5OwogICAgICAgIHZhciBpbnRlcm5hbEV2ZW50SGFuZGxlc1NldEtleSA9ICJfX3JlYWN0SGFuZGxlcyQiICsgcmFuZG9tS2V5OwogICAgICAgIGZ1bmN0aW9uIGRldGFjaERlbGV0ZWRJbnN0YW5jZShub2RlKSB7CiAgICAgICAgICBkZWxldGUgbm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XTsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsUHJvcHNLZXldOwogICAgICAgICAgZGVsZXRlIG5vZGVbaW50ZXJuYWxFdmVudEhhbmRsZXJzS2V5XTsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVyTGlzdGVuZXJzS2V5XTsKICAgICAgICAgIGRlbGV0ZSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVzU2V0S2V5XTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlY2FjaGVGaWJlck5vZGUoaG9zdEluc3QsIG5vZGUpIHsKICAgICAgICAgIG5vZGVbaW50ZXJuYWxJbnN0YW5jZUtleV0gPSBob3N0SW5zdDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbnRhaW5lckFzUm9vdChob3N0Um9vdCwgbm9kZSkgewogICAgICAgICAgbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XSA9IGhvc3RSb290OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1bm1hcmtDb250YWluZXJBc1Jvb3Qobm9kZSkgewogICAgICAgICAgbm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XSA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29udGFpbmVyTWFya2VkQXNSb290KG5vZGUpIHsKICAgICAgICAgIHJldHVybiAhIW5vZGVbaW50ZXJuYWxDb250YWluZXJJbnN0YW5jZUtleV07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENsb3Nlc3RJbnN0YW5jZUZyb21Ob2RlKHRhcmdldE5vZGUpIHsKICAgICAgICAgIHZhciB0YXJnZXRJbnN0ID0gdGFyZ2V0Tm9kZVtpbnRlcm5hbEluc3RhbmNlS2V5XTsKICAgICAgICAgIGlmICh0YXJnZXRJbnN0KSB7CiAgICAgICAgICAgIHJldHVybiB0YXJnZXRJbnN0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIHBhcmVudE5vZGUgPSB0YXJnZXROb2RlLnBhcmVudE5vZGU7CiAgICAgICAgICB3aGlsZSAocGFyZW50Tm9kZSkgewogICAgICAgICAgICB0YXJnZXRJbnN0ID0gcGFyZW50Tm9kZVtpbnRlcm5hbENvbnRhaW5lckluc3RhbmNlS2V5XSB8fCBwYXJlbnROb2RlW2ludGVybmFsSW5zdGFuY2VLZXldOwogICAgICAgICAgICBpZiAodGFyZ2V0SW5zdCkgewogICAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSB0YXJnZXRJbnN0LmFsdGVybmF0ZTsKICAgICAgICAgICAgICBpZiAodGFyZ2V0SW5zdC5jaGlsZCAhPT0gbnVsbCB8fCBhbHRlcm5hdGUgIT09IG51bGwgJiYgYWx0ZXJuYXRlLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VJbnN0YW5jZSA9IGdldFBhcmVudFN1c3BlbnNlSW5zdGFuY2UodGFyZ2V0Tm9kZSk7CiAgICAgICAgICAgICAgICB3aGlsZSAoc3VzcGVuc2VJbnN0YW5jZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0U3VzcGVuc2VJbnN0ID0gc3VzcGVuc2VJbnN0YW5jZVtpbnRlcm5hbEluc3RhbmNlS2V5XTsKICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldFN1c3BlbnNlSW5zdCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXRTdXNwZW5zZUluc3Q7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgc3VzcGVuc2VJbnN0YW5jZSA9IGdldFBhcmVudFN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB0YXJnZXRJbnN0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRhcmdldE5vZGUgPSBwYXJlbnROb2RlOwogICAgICAgICAgICBwYXJlbnROb2RlID0gdGFyZ2V0Tm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEluc3RhbmNlRnJvbU5vZGUobm9kZSkgewogICAgICAgICAgdmFyIGluc3QgPSBub2RlW2ludGVybmFsSW5zdGFuY2VLZXldIHx8IG5vZGVbaW50ZXJuYWxDb250YWluZXJJbnN0YW5jZUtleV07CiAgICAgICAgICBpZiAoaW5zdCkgewogICAgICAgICAgICBpZiAoaW5zdC50YWcgPT09IEhvc3RDb21wb25lbnQgfHwgaW5zdC50YWcgPT09IEhvc3RUZXh0IHx8IGluc3QudGFnID09PSBTdXNwZW5zZUNvbXBvbmVudCB8fCBpbnN0LnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICByZXR1cm4gaW5zdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5vZGVGcm9tSW5zdGFuY2UoaW5zdCkgewogICAgICAgICAgaWYgKGluc3QudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IGluc3QudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICByZXR1cm4gaW5zdC5zdGF0ZU5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImdldE5vZGVGcm9tSW5zdGFuY2U6IEludmFsaWQgYXJndW1lbnQuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUobm9kZSkgewogICAgICAgICAgcmV0dXJuIG5vZGVbaW50ZXJuYWxQcm9wc0tleV0gfHwgbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRmliZXJQcm9wcyhub2RlLCBwcm9wcykgewogICAgICAgICAgbm9kZVtpbnRlcm5hbFByb3BzS2V5XSA9IHByb3BzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRFdmVudExpc3RlbmVyU2V0KG5vZGUpIHsKICAgICAgICAgIHZhciBlbGVtZW50TGlzdGVuZXJTZXQgPSBub2RlW2ludGVybmFsRXZlbnRIYW5kbGVyc0tleV07CiAgICAgICAgICBpZiAoZWxlbWVudExpc3RlbmVyU2V0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgZWxlbWVudExpc3RlbmVyU2V0ID0gbm9kZVtpbnRlcm5hbEV2ZW50SGFuZGxlcnNLZXldID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50TGlzdGVuZXJTZXQ7CiAgICAgICAgfQogICAgICAgIHZhciBsb2dnZWRUeXBlRmFpbHVyZXMgPSB7fTsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChlbGVtZW50KSB7CiAgICAgICAgICAgICAgdmFyIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKGVsZW1lbnQudHlwZSwgZWxlbWVudC5fc291cmNlLCBvd25lciA/IG93bmVyLnR5cGUgOiBudWxsKTsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lJDEuc2V0RXh0cmFTdGFja0ZyYW1lKG51bGwpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrUHJvcFR5cGVzKHR5cGVTcGVjcywgdmFsdWVzLCBsb2NhdGlvbiwgY29tcG9uZW50TmFtZSwgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaGFzNCA9IEZ1bmN0aW9uLmNhbGwuYmluZChoYXNPd25Qcm9wZXJ0eSk7CiAgICAgICAgICAgIGZvciAodmFyIHR5cGVTcGVjTmFtZSBpbiB0eXBlU3BlY3MpIHsKICAgICAgICAgICAgICBpZiAoaGFzNCh0eXBlU3BlY3MsIHR5cGVTcGVjTmFtZSkpIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvciQxID0gdm9pZCAwOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBFcnJvcigoY29tcG9uZW50TmFtZSB8fCAiUmVhY3QgY2xhc3MiKSArICI6ICIgKyBsb2NhdGlvbiArICIgdHlwZSBgIiArIHR5cGVTcGVjTmFtZSArICJgIGlzIGludmFsaWQ7IGl0IG11c3QgYmUgYSBmdW5jdGlvbiwgdXN1YWxseSBmcm9tIHRoZSBgcHJvcC10eXBlc2AgcGFja2FnZSwgYnV0IHJlY2VpdmVkIGAiICsgdHlwZW9mIHR5cGVTcGVjc1t0eXBlU3BlY05hbWVdICsgImAuVGhpcyBvZnRlbiBoYXBwZW5zIGJlY2F1c2Ugb2YgdHlwb3Mgc3VjaCBhcyBgUHJvcFR5cGVzLmZ1bmN0aW9uYCBpbnN0ZWFkIG9mIGBQcm9wVHlwZXMuZnVuY2AuIik7CiAgICAgICAgICAgICAgICAgICAgZXJyLm5hbWUgPSAiSW52YXJpYW50IFZpb2xhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSh2YWx1ZXMsIHR5cGVTcGVjTmFtZSwgY29tcG9uZW50TmFtZSwgbG9jYXRpb24sIG51bGwsICJTRUNSRVRfRE9fTk9UX1BBU1NfVEhJU19PUl9ZT1VfV0lMTF9CRV9GSVJFRCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXgpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IkMSA9IGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVycm9yJDEgJiYgIShlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IpKSB7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiJXM6IHR5cGUgc3BlY2lmaWNhdGlvbiBvZiAlcyBgJXNgIGlzIGludmFsaWQ7IHRoZSB0eXBlIGNoZWNrZXIgZnVuY3Rpb24gbXVzdCByZXR1cm4gYG51bGxgIG9yIGFuIGBFcnJvcmAgYnV0IHJldHVybmVkIGEgJXMuIFlvdSBtYXkgaGF2ZSBmb3Jnb3R0ZW4gdG8gcGFzcyBhbiBhcmd1bWVudCB0byB0aGUgdHlwZSBjaGVja2VyIGNyZWF0b3IgKGFycmF5T2YsIGluc3RhbmNlT2YsIG9iamVjdE9mLCBvbmVPZiwgb25lT2ZUeXBlLCBhbmQgc2hhcGUgYWxsIHJlcXVpcmUgYW4gYXJndW1lbnQpLiIsIGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIiwgbG9jYXRpb24sIHR5cGVTcGVjTmFtZSwgdHlwZW9mIGVycm9yJDEpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxIGluc3RhbmNlb2YgRXJyb3IgJiYgIShlcnJvciQxLm1lc3NhZ2UgaW4gbG9nZ2VkVHlwZUZhaWx1cmVzKSkgewogICAgICAgICAgICAgICAgICBsb2dnZWRUeXBlRmFpbHVyZXNbZXJyb3IkMS5tZXNzYWdlXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpOwogICAgICAgICAgICAgICAgICBlcnJvcigiRmFpbGVkICVzIHR5cGU6ICVzIiwgbG9jYXRpb24sIGVycm9yJDEubWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KG51bGwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgdmFsdWVTdGFjayA9IFtdOwogICAgICAgIHZhciBmaWJlclN0YWNrOwogICAgICAgIHsKICAgICAgICAgIGZpYmVyU3RhY2sgPSBbXTsKICAgICAgICB9CiAgICAgICAgdmFyIGluZGV4ID0gLTE7CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ3Vyc29yKGRlZmF1bHRWYWx1ZSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgY3VycmVudDogZGVmYXVsdFZhbHVlCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3AoY3Vyc29yLCBmaWJlcikgewogICAgICAgICAgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgcG9wLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGZpYmVyICE9PSBmaWJlclN0YWNrW2luZGV4XSkgewogICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIEZpYmVyIHBvcHBlZC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3Vyc29yLmN1cnJlbnQgPSB2YWx1ZVN0YWNrW2luZGV4XTsKICAgICAgICAgIHZhbHVlU3RhY2tbaW5kZXhdID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXJTdGFja1tpbmRleF0gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaW5kZXgtLTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaChjdXJzb3IsIHZhbHVlLCBmaWJlcikgewogICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgIHZhbHVlU3RhY2tbaW5kZXhdID0gY3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyU3RhY2tbaW5kZXhdID0gZmliZXI7CiAgICAgICAgICB9CiAgICAgICAgICBjdXJzb3IuY3VycmVudCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICB2YXIgd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0OwogICAgICAgIHsKICAgICAgICAgIHdhcm5lZEFib3V0TWlzc2luZ0dldENoaWxkQ29udGV4dCA9IHt9OwogICAgICAgIH0KICAgICAgICB2YXIgZW1wdHlDb250ZXh0T2JqZWN0ID0ge307CiAgICAgICAgewogICAgICAgICAgT2JqZWN0LmZyZWV6ZShlbXB0eUNvbnRleHRPYmplY3QpOwogICAgICAgIH0KICAgICAgICB2YXIgY29udGV4dFN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKGVtcHR5Q29udGV4dE9iamVjdCk7CiAgICAgICAgdmFyIGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoZmFsc2UpOwogICAgICAgIHZhciBwcmV2aW91c0NvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgZnVuY3Rpb24gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBkaWRQdXNoT3duQ29udGV4dElmUHJvdmlkZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpZFB1c2hPd25Db250ZXh0SWZQcm92aWRlciAmJiBpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHByZXZpb3VzQ29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29udGV4dFN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhY2hlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHVubWFza2VkQ29udGV4dCwgbWFza2VkQ29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZFVubWFza2VkQ2hpbGRDb250ZXh0ID0gdW5tYXNrZWRDb250ZXh0OwogICAgICAgICAgICBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1hc2tlZENoaWxkQ29udGV4dCA9IG1hc2tlZENvbnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHR5cGUgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgdmFyIGNvbnRleHRUeXBlcyA9IHR5cGUuY29udGV4dFR5cGVzOwogICAgICAgICAgICBpZiAoIWNvbnRleHRUeXBlcykgewogICAgICAgICAgICAgIHJldHVybiBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgaWYgKGluc3RhbmNlICYmIGluc3RhbmNlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkVW5tYXNrZWRDaGlsZENvbnRleHQgPT09IHVubWFza2VkQ29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1hc2tlZENoaWxkQ29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29udGV4dCA9IHt9OwogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gY29udGV4dFR5cGVzKSB7CiAgICAgICAgICAgICAgY29udGV4dFtrZXldID0gdW5tYXNrZWRDb250ZXh0W2tleV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhjb250ZXh0VHlwZXMsIGNvbnRleHQsICJjb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlKSB7CiAgICAgICAgICAgICAgY2FjaGVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0LCBjb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzQ29udGV4dENoYW5nZWQoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29udGV4dFByb3ZpZGVyKHR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dFR5cGVzID0gdHlwZS5jaGlsZENvbnRleHRUeXBlczsKICAgICAgICAgICAgcmV0dXJuIGNoaWxkQ29udGV4dFR5cGVzICE9PSBudWxsICYmIGNoaWxkQ29udGV4dFR5cGVzICE9PSB2b2lkIDA7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcENvbnRleHQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BUb3BMZXZlbENvbnRleHRPYmplY3QoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGZpYmVyKTsKICAgICAgICAgICAgcG9wKGNvbnRleHRTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoVG9wTGV2ZWxDb250ZXh0T2JqZWN0KGZpYmVyLCBjb250ZXh0LCBkaWRDaGFuZ2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGNvbnRleHRTdGFja0N1cnNvci5jdXJyZW50ICE9PSBlbXB0eUNvbnRleHRPYmplY3QpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgY29udGV4dCBmb3VuZCBvbiBzdGFjay4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciwgY29udGV4dCwgZmliZXIpOwogICAgICAgICAgICBwdXNoKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIGRpZENoYW5nZSwgZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcm9jZXNzQ2hpbGRDb250ZXh0KGZpYmVyLCB0eXBlLCBwYXJlbnRDb250ZXh0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dFR5cGVzID0gdHlwZS5jaGlsZENvbnRleHRUeXBlczsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRDaGlsZENvbnRleHQgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICAgIGlmICghd2FybmVkQWJvdXRNaXNzaW5nR2V0Q2hpbGRDb250ZXh0W2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICAgIHdhcm5lZEFib3V0TWlzc2luZ0dldENoaWxkQ29udGV4dFtjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlcy5jaGlsZENvbnRleHRUeXBlcyBpcyBzcGVjaWZpZWQgYnV0IHRoZXJlIGlzIG5vIGdldENoaWxkQ29udGV4dCgpIG1ldGhvZCBvbiB0aGUgaW5zdGFuY2UuIFlvdSBjYW4gZWl0aGVyIGRlZmluZSBnZXRDaGlsZENvbnRleHQoKSBvbiAlcyBvciByZW1vdmUgY2hpbGRDb250ZXh0VHlwZXMgZnJvbSBpdC4iLCBjb21wb25lbnROYW1lLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkQ29udGV4dCA9IGluc3RhbmNlLmdldENoaWxkQ29udGV4dCgpOwogICAgICAgICAgICBmb3IgKHZhciBjb250ZXh0S2V5IGluIGNoaWxkQ29udGV4dCkgewogICAgICAgICAgICAgIGlmICghKGNvbnRleHRLZXkgaW4gY2hpbGRDb250ZXh0VHlwZXMpKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJVbmtub3duIikgKyAnLmdldENoaWxkQ29udGV4dCgpOiBrZXkgIicgKyBjb250ZXh0S2V5ICsgJyIgaXMgbm90IGRlZmluZWQgaW4gY2hpbGRDb250ZXh0VHlwZXMuJyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhjaGlsZENvbnRleHRUeXBlcywgY2hpbGRDb250ZXh0LCAiY2hpbGQgY29udGV4dCIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBhc3NpZ24yKHt9LCBwYXJlbnRDb250ZXh0LCBjaGlsZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICB2YXIgbWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQgPSBpbnN0YW5jZSAmJiBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxNZW1vaXplZE1lcmdlZENoaWxkQ29udGV4dCB8fCBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICAgIHByZXZpb3VzQ29udGV4dCA9IGNvbnRleHRTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciwgbWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHB1c2goZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvciwgZGlkUGVyZm9ybVdvcmtTdGFja0N1cnNvci5jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52YWxpZGF0ZUNvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIGRpZENoYW5nZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoIWluc3RhbmNlKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBoYXZlIGFuIGluc3RhbmNlIGJ5IHRoaXMgcG9pbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpZENoYW5nZSkgewogICAgICAgICAgICAgIHZhciBtZXJnZWRDb250ZXh0ID0gcHJvY2Vzc0NoaWxkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHR5cGUsIHByZXZpb3VzQ29udGV4dCk7CiAgICAgICAgICAgICAgaW5zdGFuY2UuX19yZWFjdEludGVybmFsTWVtb2l6ZWRNZXJnZWRDaGlsZENvbnRleHQgPSBtZXJnZWRDb250ZXh0OwogICAgICAgICAgICAgIHBvcChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcHVzaChjb250ZXh0U3RhY2tDdXJzb3IsIG1lcmdlZENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcHVzaChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBkaWRDaGFuZ2UsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcG9wKGRpZFBlcmZvcm1Xb3JrU3RhY2tDdXJzb3IsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcHVzaChkaWRQZXJmb3JtV29ya1N0YWNrQ3Vyc29yLCBkaWRDaGFuZ2UsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEN1cnJlbnRVbm1hc2tlZENvbnRleHQoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFpc0ZpYmVyTW91bnRlZChmaWJlcikgfHwgZmliZXIudGFnICE9PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgc3VidHJlZSBwYXJlbnQgdG8gYmUgYSBtb3VudGVkIGNsYXNzIGNvbXBvbmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgc3dpdGNoIChub2RlLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuc3RhdGVOb2RlLmNvbnRleHQ7CiAgICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSBub2RlLnR5cGU7CiAgICAgICAgICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuc3RhdGVOb2RlLl9fcmVhY3RJbnRlcm5hbE1lbW9pemVkTWVyZ2VkQ2hpbGRDb250ZXh0OwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0gd2hpbGUgKG5vZGUgIT09IG51bGwpOwogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkZvdW5kIHVuZXhwZWN0ZWQgZGV0YWNoZWQgc3VidHJlZSBwYXJlbnQuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBMZWdhY3lSb290ID0gMDsKICAgICAgICB2YXIgQ29uY3VycmVudFJvb3QgPSAxOwogICAgICAgIHZhciBzeW5jUXVldWUgPSBudWxsOwogICAgICAgIHZhciBpbmNsdWRlc0xlZ2FjeVN5bmNDYWxsYmFja3MgPSBmYWxzZTsKICAgICAgICB2YXIgaXNGbHVzaGluZ1N5bmNRdWV1ZSA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlU3luY0NhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICAgICAgICBpZiAoc3luY1F1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHN5bmNRdWV1ZSA9IFtjYWxsYmFja107CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzeW5jUXVldWUucHVzaChjYWxsYmFjayk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlTGVnYWN5U3luY0NhbGxiYWNrKGNhbGxiYWNrKSB7CiAgICAgICAgICBpbmNsdWRlc0xlZ2FjeVN5bmNDYWxsYmFja3MgPSB0cnVlOwogICAgICAgICAgc2NoZWR1bGVTeW5jQ2FsbGJhY2soY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFN5bmNDYWxsYmFja3NPbmx5SW5MZWdhY3lNb2RlKCkgewogICAgICAgICAgaWYgKGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcykgewogICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3MoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jQ2FsbGJhY2tzKCkgewogICAgICAgICAgaWYgKCFpc0ZsdXNoaW5nU3luY1F1ZXVlICYmIHN5bmNRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpc0ZsdXNoaW5nU3luY1F1ZXVlID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGkgPSAwOwogICAgICAgICAgICB2YXIgcHJldmlvdXNVcGRhdGVQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHZhciBpc1N5bmMgPSB0cnVlOwogICAgICAgICAgICAgIHZhciBxdWV1ZSA9IHN5bmNRdWV1ZTsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgICBmb3IgKDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2sgPSBxdWV1ZVtpXTsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBjYWxsYmFjayhpc1N5bmMpOwogICAgICAgICAgICAgICAgfSB3aGlsZSAoY2FsbGJhY2sgIT09IG51bGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzeW5jUXVldWUgPSBudWxsOwogICAgICAgICAgICAgIGluY2x1ZGVzTGVnYWN5U3luY0NhbGxiYWNrcyA9IGZhbHNlOwogICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICBpZiAoc3luY1F1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzeW5jUXVldWUgPSBzeW5jUXVldWUuc2xpY2UoaSArIDEpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzY2hlZHVsZUNhbGxiYWNrKEltbWVkaWF0ZVByaW9yaXR5LCBmbHVzaFN5bmNDYWxsYmFja3MpOwogICAgICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNVcGRhdGVQcmlvcml0eSk7CiAgICAgICAgICAgICAgaXNGbHVzaGluZ1N5bmNRdWV1ZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgdmFyIGZvcmtTdGFjayA9IFtdOwogICAgICAgIHZhciBmb3JrU3RhY2tJbmRleCA9IDA7CiAgICAgICAgdmFyIHRyZWVGb3JrUHJvdmlkZXIgPSBudWxsOwogICAgICAgIHZhciB0cmVlRm9ya0NvdW50ID0gMDsKICAgICAgICB2YXIgaWRTdGFjayA9IFtdOwogICAgICAgIHZhciBpZFN0YWNrSW5kZXggPSAwOwogICAgICAgIHZhciB0cmVlQ29udGV4dFByb3ZpZGVyID0gbnVsbDsKICAgICAgICB2YXIgdHJlZUNvbnRleHRJZCA9IDE7CiAgICAgICAgdmFyIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSAiIjsKICAgICAgICBmdW5jdGlvbiBpc0ZvcmtlZENoaWxkKHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgd2FybklmTm90SHlkcmF0aW5nKCk7CiAgICAgICAgICByZXR1cm4gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmtlZCkgIT09IE5vRmxhZ3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEZvcmtzQXRMZXZlbCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgcmV0dXJuIHRyZWVGb3JrQ291bnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFRyZWVJZCgpIHsKICAgICAgICAgIHZhciBvdmVyZmxvdyA9IHRyZWVDb250ZXh0T3ZlcmZsb3c7CiAgICAgICAgICB2YXIgaWRXaXRoTGVhZGluZ0JpdCA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICB2YXIgaWQgPSBpZFdpdGhMZWFkaW5nQml0ICYgfmdldExlYWRpbmdCaXQoaWRXaXRoTGVhZGluZ0JpdCk7CiAgICAgICAgICByZXR1cm4gaWQudG9TdHJpbmcoMzIpICsgb3ZlcmZsb3c7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hUcmVlRm9yayh3b3JrSW5Qcm9ncmVzczIsIHRvdGFsQ2hpbGRyZW4pIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4KytdID0gdHJlZUZvcmtDb3VudDsKICAgICAgICAgIGZvcmtTdGFja1tmb3JrU3RhY2tJbmRleCsrXSA9IHRyZWVGb3JrUHJvdmlkZXI7CiAgICAgICAgICB0cmVlRm9ya1Byb3ZpZGVyID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgdHJlZUZvcmtDb3VudCA9IHRvdGFsQ2hpbGRyZW47CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hUcmVlSWQod29ya0luUHJvZ3Jlc3MyLCB0b3RhbENoaWxkcmVuLCBpbmRleDIpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dElkOwogICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dE92ZXJmbG93OwogICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dFByb3ZpZGVyOwogICAgICAgICAgdHJlZUNvbnRleHRQcm92aWRlciA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHZhciBiYXNlSWRXaXRoTGVhZGluZ0JpdCA9IHRyZWVDb250ZXh0SWQ7CiAgICAgICAgICB2YXIgYmFzZU92ZXJmbG93ID0gdHJlZUNvbnRleHRPdmVyZmxvdzsKICAgICAgICAgIHZhciBiYXNlTGVuZ3RoID0gZ2V0Qml0TGVuZ3RoKGJhc2VJZFdpdGhMZWFkaW5nQml0KSAtIDE7CiAgICAgICAgICB2YXIgYmFzZUlkID0gYmFzZUlkV2l0aExlYWRpbmdCaXQgJiB+KDEgPDwgYmFzZUxlbmd0aCk7CiAgICAgICAgICB2YXIgc2xvdCA9IGluZGV4MiArIDE7CiAgICAgICAgICB2YXIgbGVuZ3RoID0gZ2V0Qml0TGVuZ3RoKHRvdGFsQ2hpbGRyZW4pICsgYmFzZUxlbmd0aDsKICAgICAgICAgIGlmIChsZW5ndGggPiAzMCkgewogICAgICAgICAgICB2YXIgbnVtYmVyT2ZPdmVyZmxvd0JpdHMgPSBiYXNlTGVuZ3RoIC0gYmFzZUxlbmd0aCAlIDU7CiAgICAgICAgICAgIHZhciBuZXdPdmVyZmxvd0JpdHMgPSAoMSA8PCBudW1iZXJPZk92ZXJmbG93Qml0cykgLSAxOwogICAgICAgICAgICB2YXIgbmV3T3ZlcmZsb3cgPSAoYmFzZUlkICYgbmV3T3ZlcmZsb3dCaXRzKS50b1N0cmluZygzMik7CiAgICAgICAgICAgIHZhciByZXN0T2ZCYXNlSWQgPSBiYXNlSWQgPj4gbnVtYmVyT2ZPdmVyZmxvd0JpdHM7CiAgICAgICAgICAgIHZhciByZXN0T2ZCYXNlTGVuZ3RoID0gYmFzZUxlbmd0aCAtIG51bWJlck9mT3ZlcmZsb3dCaXRzOwogICAgICAgICAgICB2YXIgcmVzdE9mTGVuZ3RoID0gZ2V0Qml0TGVuZ3RoKHRvdGFsQ2hpbGRyZW4pICsgcmVzdE9mQmFzZUxlbmd0aDsKICAgICAgICAgICAgdmFyIHJlc3RPZk5ld0JpdHMgPSBzbG90IDw8IHJlc3RPZkJhc2VMZW5ndGg7CiAgICAgICAgICAgIHZhciBpZCA9IHJlc3RPZk5ld0JpdHMgfCByZXN0T2ZCYXNlSWQ7CiAgICAgICAgICAgIHZhciBvdmVyZmxvdyA9IG5ld092ZXJmbG93ICsgYmFzZU92ZXJmbG93OwogICAgICAgICAgICB0cmVlQ29udGV4dElkID0gMSA8PCByZXN0T2ZMZW5ndGggfCBpZDsKICAgICAgICAgICAgdHJlZUNvbnRleHRPdmVyZmxvdyA9IG92ZXJmbG93OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG5ld0JpdHMgPSBzbG90IDw8IGJhc2VMZW5ndGg7CiAgICAgICAgICAgIHZhciBfaWQgPSBuZXdCaXRzIHwgYmFzZUlkOwogICAgICAgICAgICB2YXIgX292ZXJmbG93ID0gYmFzZU92ZXJmbG93OwogICAgICAgICAgICB0cmVlQ29udGV4dElkID0gMSA8PCBsZW5ndGggfCBfaWQ7CiAgICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBfb3ZlcmZsb3c7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hNYXRlcmlhbGl6ZWRUcmVlSWQod29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB3YXJuSWZOb3RIeWRyYXRpbmcoKTsKICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IHdvcmtJblByb2dyZXNzMi5yZXR1cm47CiAgICAgICAgICBpZiAocmV0dXJuRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSAxOwogICAgICAgICAgICB2YXIgc2xvdEluZGV4ID0gMDsKICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHdvcmtJblByb2dyZXNzMiwgbnVtYmVyT2ZGb3Jrcyk7CiAgICAgICAgICAgIHB1c2hUcmVlSWQod29ya0luUHJvZ3Jlc3MyLCBudW1iZXJPZkZvcmtzLCBzbG90SW5kZXgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRCaXRMZW5ndGgobnVtYmVyNCkgewogICAgICAgICAgcmV0dXJuIDMyIC0gY2x6MzIobnVtYmVyNCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldExlYWRpbmdCaXQoaWQpIHsKICAgICAgICAgIHJldHVybiAxIDw8IGdldEJpdExlbmd0aChpZCkgLSAxOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzczIgPT09IHRyZWVGb3JrUHJvdmlkZXIpIHsKICAgICAgICAgICAgdHJlZUZvcmtQcm92aWRlciA9IGZvcmtTdGFja1stLWZvcmtTdGFja0luZGV4XTsKICAgICAgICAgICAgZm9ya1N0YWNrW2ZvcmtTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICAgIHRyZWVGb3JrQ291bnQgPSBmb3JrU3RhY2tbLS1mb3JrU3RhY2tJbmRleF07CiAgICAgICAgICAgIGZvcmtTdGFja1tmb3JrU3RhY2tJbmRleF0gPSBudWxsOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzMiA9PT0gdHJlZUNvbnRleHRQcm92aWRlcikgewogICAgICAgICAgICB0cmVlQ29udGV4dFByb3ZpZGVyID0gaWRTdGFja1stLWlkU3RhY2tJbmRleF07CiAgICAgICAgICAgIGlkU3RhY2tbaWRTdGFja0luZGV4XSA9IG51bGw7CiAgICAgICAgICAgIHRyZWVDb250ZXh0T3ZlcmZsb3cgPSBpZFN0YWNrWy0taWRTdGFja0luZGV4XTsKICAgICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXhdID0gbnVsbDsKICAgICAgICAgICAgdHJlZUNvbnRleHRJZCA9IGlkU3RhY2tbLS1pZFN0YWNrSW5kZXhdOwogICAgICAgICAgICBpZFN0YWNrW2lkU3RhY2tJbmRleF0gPSBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdXNwZW5kZWRUcmVlQ29udGV4dCgpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgaWYgKHRyZWVDb250ZXh0UHJvdmlkZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICBpZDogdHJlZUNvbnRleHRJZCwKICAgICAgICAgICAgICBvdmVyZmxvdzogdHJlZUNvbnRleHRPdmVyZmxvdwogICAgICAgICAgICB9OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3RvcmVTdXNwZW5kZWRUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbmRlZENvbnRleHQpIHsKICAgICAgICAgIHdhcm5JZk5vdEh5ZHJhdGluZygpOwogICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dElkOwogICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dE92ZXJmbG93OwogICAgICAgICAgaWRTdGFja1tpZFN0YWNrSW5kZXgrK10gPSB0cmVlQ29udGV4dFByb3ZpZGVyOwogICAgICAgICAgdHJlZUNvbnRleHRJZCA9IHN1c3BlbmRlZENvbnRleHQuaWQ7CiAgICAgICAgICB0cmVlQ29udGV4dE92ZXJmbG93ID0gc3VzcGVuZGVkQ29udGV4dC5vdmVyZmxvdzsKICAgICAgICAgIHRyZWVDb250ZXh0UHJvdmlkZXIgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZk5vdEh5ZHJhdGluZygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHRvIGJlIGh5ZHJhdGluZy4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gbnVsbDsKICAgICAgICB2YXIgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgdmFyIGlzSHlkcmF0aW5nID0gZmFsc2U7CiAgICAgICAgdmFyIGRpZFN1c3BlbmRPckVycm9yREVWID0gZmFsc2U7CiAgICAgICAgdmFyIGh5ZHJhdGlvbkVycm9ycyA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gd2FybklmSHlkcmF0aW5nKCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNIeWRyYXRpbmcpIHsKICAgICAgICAgICAgICBlcnJvcigiV2Ugc2hvdWxkIG5vdCBiZSBoeWRyYXRpbmcgaGVyZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYSBidWcuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0RpZFRocm93V2hpbGVIeWRyYXRpbmdERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpZFN1c3BlbmRPckVycm9yREVWID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlkU3VzcGVuZE9yRXJyb3JXaGlsZUh5ZHJhdGluZ0RFVigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRpZFN1c3BlbmRPckVycm9yREVWOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnRlckh5ZHJhdGlvblN0YXRlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50SW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBnZXRGaXJzdEh5ZHJhdGFibGVDaGlsZFdpdGhpbkNvbnRhaW5lcihwYXJlbnRJbnN0YW5jZSk7CiAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgaXNIeWRyYXRpbmcgPSB0cnVlOwogICAgICAgICAgaHlkcmF0aW9uRXJyb3JzID0gbnVsbDsKICAgICAgICAgIGRpZFN1c3BlbmRPckVycm9yREVWID0gZmFsc2U7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVlbnRlckh5ZHJhdGlvblN0YXRlRnJvbURlaHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKGZpYmVyLCBzdXNwZW5zZUluc3RhbmNlLCB0cmVlQ29udGV4dCkgewogICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IGdldEZpcnN0SHlkcmF0YWJsZUNoaWxkV2l0aGluU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICBpc0h5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBudWxsOwogICAgICAgICAgZGlkU3VzcGVuZE9yRXJyb3JERVYgPSBmYWxzZTsKICAgICAgICAgIGlmICh0cmVlQ29udGV4dCAhPT0gbnVsbCkgewogICAgICAgICAgICByZXN0b3JlU3VzcGVuZGVkVHJlZUNvbnRleHQoZmliZXIsIHRyZWVDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuVW5oeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKHJldHVybkZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihyZXR1cm5GaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbywgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIGlzQ29uY3VycmVudE1vZGUgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgZGlkTm90SHlkcmF0ZUluc3RhbmNlKAogICAgICAgICAgICAgICAgICByZXR1cm5GaWJlci50eXBlLAogICAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5tZW1vaXplZFByb3BzLAogICAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5zdGF0ZU5vZGUsCiAgICAgICAgICAgICAgICAgIGluc3RhbmNlLAogICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICBpc0NvbmN1cnJlbnRNb2RlCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gcmV0dXJuRmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIGRpZE5vdEh5ZHJhdGVJbnN0YW5jZVdpdGhpblN1c3BlbnNlSW5zdGFuY2Uoc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVsZXRlSHlkcmF0YWJsZUluc3RhbmNlKHJldHVybkZpYmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgd2FyblVuaHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgaW5zdGFuY2UpOwogICAgICAgICAgdmFyIGNoaWxkVG9EZWxldGUgPSBjcmVhdGVGaWJlckZyb21Ib3N0SW5zdGFuY2VGb3JEZWxldGlvbigpOwogICAgICAgICAgY2hpbGRUb0RlbGV0ZS5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgIGNoaWxkVG9EZWxldGUucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcmV0dXJuRmliZXIuZGVsZXRpb25zOwogICAgICAgICAgaWYgKGRlbGV0aW9ucyA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm5GaWJlci5kZWxldGlvbnMgPSBbY2hpbGRUb0RlbGV0ZV07CiAgICAgICAgICAgIHJldHVybkZpYmVyLmZsYWdzIHw9IENoaWxkRGVsZXRpb247CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkZWxldGlvbnMucHVzaChjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2Fybk5vbmh5ZHJhdGVkSW5zdGFuY2UocmV0dXJuRmliZXIsIGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kT3JFcnJvckRFVikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBzd2l0Y2ggKHJldHVybkZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHZhciBwYXJlbnRDb250YWluZXIgPSByZXR1cm5GaWJlci5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2VXaXRoaW5Db250YWluZXIocGFyZW50Q29udGFpbmVyLCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICAgICAgICB2YXIgdGV4dCA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgICAgICBkaWROb3RGaW5kSHlkcmF0YWJsZVRleHRJbnN0YW5jZVdpdGhpbkNvbnRhaW5lcihwYXJlbnRDb250YWluZXIsIHRleHQpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIHBhcmVudFR5cGUgPSByZXR1cm5GaWJlci50eXBlOwogICAgICAgICAgICAgICAgdmFyIHBhcmVudFByb3BzID0gcmV0dXJuRmliZXIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgIHZhciBwYXJlbnRJbnN0YW5jZSA9IHJldHVybkZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgICAgIHZhciBfdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9wcm9wcyA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgaXNDb25jdXJyZW50TW9kZSA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgICAgZGlkTm90RmluZEh5ZHJhdGFibGVJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFR5cGUsCiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRQcm9wcywKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgICAgX3R5cGUsCiAgICAgICAgICAgICAgICAgICAgICBfcHJvcHMsCiAgICAgICAgICAgICAgICAgICAgICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhcmd1bWVudCB3aGVuIHdlIHJlbW92ZSB0aGUgbGVnYWN5IHJvb3QgQVBJLgogICAgICAgICAgICAgICAgICAgICAgaXNDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgICAgICAgIHZhciBfdGV4dCA9IGZpYmVyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgX2lzQ29uY3VycmVudE1vZGUgPSAocmV0dXJuRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlKAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50VHlwZSwKICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFByb3BzLAogICAgICAgICAgICAgICAgICAgICAgcGFyZW50SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgICBfdGV4dCwKICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgICBfaXNDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHJldHVybkZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgX3BhcmVudEluc3RhbmNlID0gc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkOwogICAgICAgICAgICAgICAgaWYgKF9wYXJlbnRJbnN0YW5jZSAhPT0gbnVsbCkgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OgogICAgICAgICAgICAgICAgICAgIHZhciBfdHlwZTIgPSBmaWJlci50eXBlOwogICAgICAgICAgICAgICAgICAgIHZhciBfcHJvcHMyID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlSW5zdGFuY2VXaXRoaW5TdXNwZW5zZUluc3RhbmNlKF9wYXJlbnRJbnN0YW5jZSwgX3R5cGUyKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDoKICAgICAgICAgICAgICAgICAgICB2YXIgX3RleHQyID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgICAgICAgIGRpZE5vdEZpbmRIeWRyYXRhYmxlVGV4dEluc3RhbmNlV2l0aGluU3VzcGVuc2VJbnN0YW5jZShfcGFyZW50SW5zdGFuY2UsIF90ZXh0Mik7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnNlcnROb25IeWRyYXRlZEluc3RhbmNlKHJldHVybkZpYmVyLCBmaWJlcikgewogICAgICAgICAgZmliZXIuZmxhZ3MgPSBmaWJlci5mbGFncyAmIH5IeWRyYXRpbmcgfCBQbGFjZW1lbnQ7CiAgICAgICAgICB3YXJuTm9uaHlkcmF0ZWRJbnN0YW5jZShyZXR1cm5GaWJlciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cnlIeWRyYXRlKGZpYmVyLCBuZXh0SW5zdGFuY2UpIHsKICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciB0eXBlID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gY2FuSHlkcmF0ZUluc3RhbmNlKG5leHRJbnN0YW5jZSwgdHlwZSk7CiAgICAgICAgICAgICAgaWYgKGluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgICBuZXh0SHlkcmF0YWJsZUluc3RhbmNlID0gZ2V0Rmlyc3RIeWRyYXRhYmxlQ2hpbGQoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgdmFyIHRleHQgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIHRleHRJbnN0YW5jZSA9IGNhbkh5ZHJhdGVUZXh0SW5zdGFuY2UobmV4dEluc3RhbmNlLCB0ZXh0KTsKICAgICAgICAgICAgICBpZiAodGV4dEluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSB0ZXh0SW5zdGFuY2U7CiAgICAgICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VJbnN0YW5jZSA9IGNhbkh5ZHJhdGVTdXNwZW5zZUluc3RhbmNlKG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgICAgaWYgKHN1c3BlbnNlSW5zdGFuY2UgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gewogICAgICAgICAgICAgICAgICBkZWh5ZHJhdGVkOiBzdXNwZW5zZUluc3RhbmNlLAogICAgICAgICAgICAgICAgICB0cmVlQ29udGV4dDogZ2V0U3VzcGVuZGVkVHJlZUNvbnRleHQoKSwKICAgICAgICAgICAgICAgICAgcmV0cnlMYW5lOiBPZmZzY3JlZW5MYW5lCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgZmliZXIubWVtb2l6ZWRTdGF0ZSA9IHN1c3BlbnNlU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgZGVoeWRyYXRlZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRGVoeWRyYXRlZEZyYWdtZW50KHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgZGVoeWRyYXRlZEZyYWdtZW50LnJldHVybiA9IGZpYmVyOwogICAgICAgICAgICAgICAgZmliZXIuY2hpbGQgPSBkZWh5ZHJhdGVkRnJhZ21lbnQ7CiAgICAgICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICAgICAgbmV4dEh5ZHJhdGFibGVJbnN0YW5jZSA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDbGllbnRSZW5kZXJPbk1pc21hdGNoKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gKGZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSAmJiAoZmliZXIuZmxhZ3MgJiBEaWRDYXB0dXJlKSA9PT0gTm9GbGFnczsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKGZpYmVyKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkh5ZHJhdGlvbiBmYWlsZWQgYmVjYXVzZSB0aGUgaW5pdGlhbCBVSSBkb2VzIG5vdCBtYXRjaCB3aGF0IHdhcyByZW5kZXJlZCBvbiB0aGUgc2VydmVyLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgaWYgKCFpc0h5ZHJhdGluZykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dEluc3RhbmNlID0gbmV4dEh5ZHJhdGFibGVJbnN0YW5jZTsKICAgICAgICAgIGlmICghbmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDbGllbnRSZW5kZXJPbk1pc21hdGNoKGZpYmVyKSkgewogICAgICAgICAgICAgIHdhcm5Ob25oeWRyYXRlZEluc3RhbmNlKGh5ZHJhdGlvblBhcmVudEZpYmVyLCBmaWJlcik7CiAgICAgICAgICAgICAgdGhyb3dPbkh5ZHJhdGlvbk1pc21hdGNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5zZXJ0Tm9uSHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgICBoeWRyYXRpb25QYXJlbnRGaWJlciA9IGZpYmVyOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmlyc3RBdHRlbXB0ZWRJbnN0YW5jZSA9IG5leHRJbnN0YW5jZTsKICAgICAgICAgIGlmICghdHJ5SHlkcmF0ZShmaWJlciwgbmV4dEluc3RhbmNlKSkgewogICAgICAgICAgICBpZiAoc2hvdWxkQ2xpZW50UmVuZGVyT25NaXNtYXRjaChmaWJlcikpIHsKICAgICAgICAgICAgICB3YXJuTm9uaHlkcmF0ZWRJbnN0YW5jZShoeWRyYXRpb25QYXJlbnRGaWJlciwgZmliZXIpOwogICAgICAgICAgICAgIHRocm93T25IeWRyYXRpb25NaXNtYXRjaCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRJbnN0YW5jZSA9IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhmaXJzdEF0dGVtcHRlZEluc3RhbmNlKTsKICAgICAgICAgICAgdmFyIHByZXZIeWRyYXRpb25QYXJlbnRGaWJlciA9IGh5ZHJhdGlvblBhcmVudEZpYmVyOwogICAgICAgICAgICBpZiAoIW5leHRJbnN0YW5jZSB8fCAhdHJ5SHlkcmF0ZShmaWJlciwgbmV4dEluc3RhbmNlKSkgewogICAgICAgICAgICAgIGluc2VydE5vbkh5ZHJhdGVkSW5zdGFuY2UoaHlkcmF0aW9uUGFyZW50RmliZXIsIGZpYmVyKTsKICAgICAgICAgICAgICBpc0h5ZHJhdGluZyA9IGZhbHNlOwogICAgICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gZmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlbGV0ZUh5ZHJhdGFibGVJbnN0YW5jZShwcmV2SHlkcmF0aW9uUGFyZW50RmliZXIsIGZpcnN0QXR0ZW1wdGVkSW5zdGFuY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlKGZpYmVyLCByb290Q29udGFpbmVySW5zdGFuY2UsIGhvc3RDb250ZXh0KSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICB2YXIgc2hvdWxkV2FybklmTWlzbWF0Y2hEZXYgPSAhZGlkU3VzcGVuZE9yRXJyb3JERVY7CiAgICAgICAgICB2YXIgdXBkYXRlUGF5bG9hZCA9IGh5ZHJhdGVJbnN0YW5jZShpbnN0YW5jZSwgZmliZXIudHlwZSwgZmliZXIubWVtb2l6ZWRQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBob3N0Q29udGV4dCwgZmliZXIsIHNob3VsZFdhcm5JZk1pc21hdGNoRGV2KTsKICAgICAgICAgIGZpYmVyLnVwZGF0ZVF1ZXVlID0gdXBkYXRlUGF5bG9hZDsKICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9IeWRyYXRlSG9zdFRleHRJbnN0YW5jZShmaWJlcikgewogICAgICAgICAgdmFyIHRleHRJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgIHZhciB0ZXh0Q29udGVudCA9IGZpYmVyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gaHlkcmF0ZVRleHRJbnN0YW5jZSh0ZXh0SW5zdGFuY2UsIHRleHRDb250ZW50LCBmaWJlcik7CiAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGh5ZHJhdGlvblBhcmVudEZpYmVyOwogICAgICAgICAgICBpZiAocmV0dXJuRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHJldHVybkZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50Q29udGFpbmVyID0gcmV0dXJuRmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICAgIHZhciBpc0NvbmN1cnJlbnRNb2RlID0gKHJldHVybkZpYmVyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgICAgICAgICAgZGlkTm90TWF0Y2hIeWRyYXRlZENvbnRhaW5lclRleHRJbnN0YW5jZSgKICAgICAgICAgICAgICAgICAgICBwYXJlbnRDb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgdGV4dEluc3RhbmNlLAogICAgICAgICAgICAgICAgICAgIHRleHRDb250ZW50LAogICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IERlbGV0ZSB0aGlzIGFyZ3VtZW50IHdoZW4gd2UgcmVtb3ZlIHRoZSBsZWdhY3kgcm9vdCBBUEkuCiAgICAgICAgICAgICAgICAgICAgaXNDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50VHlwZSA9IHJldHVybkZpYmVyLnR5cGU7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRQcm9wcyA9IHJldHVybkZpYmVyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRJbnN0YW5jZSA9IHJldHVybkZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgdmFyIF9pc0NvbmN1cnJlbnRNb2RlMiA9IChyZXR1cm5GaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpICE9PSBOb01vZGU7CiAgICAgICAgICAgICAgICAgIGRpZE5vdE1hdGNoSHlkcmF0ZWRUZXh0SW5zdGFuY2UoCiAgICAgICAgICAgICAgICAgICAgcGFyZW50VHlwZSwKICAgICAgICAgICAgICAgICAgICBwYXJlbnRQcm9wcywKICAgICAgICAgICAgICAgICAgICBwYXJlbnRJbnN0YW5jZSwKICAgICAgICAgICAgICAgICAgICB0ZXh0SW5zdGFuY2UsCiAgICAgICAgICAgICAgICAgICAgdGV4dENvbnRlbnQsCiAgICAgICAgICAgICAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgYXJndW1lbnQgd2hlbiB3ZSByZW1vdmUgdGhlIGxlZ2FjeSByb290IEFQSS4KICAgICAgICAgICAgICAgICAgICBfaXNDb25jdXJyZW50TW9kZTIKICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gc2hvdWxkVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9IeWRyYXRlSG9zdFN1c3BlbnNlSW5zdGFuY2UoZmliZXIpIHsKICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gZmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCA/IHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCA6IG51bGw7CiAgICAgICAgICBpZiAoIXN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBoYXZlIGEgaHlkcmF0ZWQgc3VzcGVuc2UgaW5zdGFuY2UuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICBoeWRyYXRlU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNraXBQYXN0RGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2UoZmliZXIpIHsKICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gZmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBzdXNwZW5zZUluc3RhbmNlID0gc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCA/IHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCA6IG51bGw7CiAgICAgICAgICBpZiAoIXN1c3BlbnNlSW5zdGFuY2UpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBoYXZlIGEgaHlkcmF0ZWQgc3VzcGVuc2UgaW5zdGFuY2UuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0TmV4dEh5ZHJhdGFibGVJbnN0YW5jZUFmdGVyU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wVG9OZXh0SG9zdFBhcmVudChmaWJlcikgewogICAgICAgICAgdmFyIHBhcmVudCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIHdoaWxlIChwYXJlbnQgIT09IG51bGwgJiYgcGFyZW50LnRhZyAhPT0gSG9zdENvbXBvbmVudCAmJiBwYXJlbnQudGFnICE9PSBIb3N0Um9vdCAmJiBwYXJlbnQudGFnICE9PSBTdXNwZW5zZUNvbXBvbmVudCkgewogICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaHlkcmF0aW9uUGFyZW50RmliZXIgPSBwYXJlbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcEh5ZHJhdGlvblN0YXRlKGZpYmVyKSB7CiAgICAgICAgICBpZiAoZmliZXIgIT09IGh5ZHJhdGlvblBhcmVudEZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghaXNIeWRyYXRpbmcpIHsKICAgICAgICAgICAgcG9wVG9OZXh0SG9zdFBhcmVudChmaWJlcik7CiAgICAgICAgICAgIGlzSHlkcmF0aW5nID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gSG9zdFJvb3QgJiYgKGZpYmVyLnRhZyAhPT0gSG9zdENvbXBvbmVudCB8fCBzaG91bGREZWxldGVVbmh5ZHJhdGVkVGFpbEluc3RhbmNlcyhmaWJlci50eXBlKSAmJiAhc2hvdWxkU2V0VGV4dENvbnRlbnQoZmliZXIudHlwZSwgZmliZXIubWVtb2l6ZWRQcm9wcykpKSB7CiAgICAgICAgICAgIHZhciBuZXh0SW5zdGFuY2UgPSBuZXh0SHlkcmF0YWJsZUluc3RhbmNlOwogICAgICAgICAgICBpZiAobmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgaWYgKHNob3VsZENsaWVudFJlbmRlck9uTWlzbWF0Y2goZmliZXIpKSB7CiAgICAgICAgICAgICAgICB3YXJuSWZVbmh5ZHJhdGVkVGFpbE5vZGVzKGZpYmVyKTsKICAgICAgICAgICAgICAgIHRocm93T25IeWRyYXRpb25NaXNtYXRjaCgpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB3aGlsZSAobmV4dEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZUh5ZHJhdGFibGVJbnN0YW5jZShmaWJlciwgbmV4dEluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgbmV4dEluc3RhbmNlID0gZ2V0TmV4dEh5ZHJhdGFibGVTaWJsaW5nKG5leHRJbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBwb3BUb05leHRIb3N0UGFyZW50KGZpYmVyKTsKICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBza2lwUGFzdERlaHlkcmF0ZWRTdXNwZW5zZUluc3RhbmNlKGZpYmVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBoeWRyYXRpb25QYXJlbnRGaWJlciA/IGdldE5leHRIeWRyYXRhYmxlU2libGluZyhmaWJlci5zdGF0ZU5vZGUpIDogbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoYXNVbmh5ZHJhdGVkVGFpbE5vZGVzKCkgewogICAgICAgICAgcmV0dXJuIGlzSHlkcmF0aW5nICYmIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgIT09IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlVuaHlkcmF0ZWRUYWlsTm9kZXMoZmliZXIpIHsKICAgICAgICAgIHZhciBuZXh0SW5zdGFuY2UgPSBuZXh0SHlkcmF0YWJsZUluc3RhbmNlOwogICAgICAgICAgd2hpbGUgKG5leHRJbnN0YW5jZSkgewogICAgICAgICAgICB3YXJuVW5oeWRyYXRlZEluc3RhbmNlKGZpYmVyLCBuZXh0SW5zdGFuY2UpOwogICAgICAgICAgICBuZXh0SW5zdGFuY2UgPSBnZXROZXh0SHlkcmF0YWJsZVNpYmxpbmcobmV4dEluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRIeWRyYXRpb25TdGF0ZSgpIHsKICAgICAgICAgIGh5ZHJhdGlvblBhcmVudEZpYmVyID0gbnVsbDsKICAgICAgICAgIG5leHRIeWRyYXRhYmxlSW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgaXNIeWRyYXRpbmcgPSBmYWxzZTsKICAgICAgICAgIGRpZFN1c3BlbmRPckVycm9yREVWID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZ3JhZGVIeWRyYXRpb25FcnJvcnNUb1JlY292ZXJhYmxlKCkgewogICAgICAgICAgaWYgKGh5ZHJhdGlvbkVycm9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZVJlY292ZXJhYmxlRXJyb3JzKGh5ZHJhdGlvbkVycm9ycyk7CiAgICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldElzSHlkcmF0aW5nKCkgewogICAgICAgICAgcmV0dXJuIGlzSHlkcmF0aW5nOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZUh5ZHJhdGlvbkVycm9yKGVycm9yMikgewogICAgICAgICAgaWYgKGh5ZHJhdGlvbkVycm9ycyA9PT0gbnVsbCkgewogICAgICAgICAgICBoeWRyYXRpb25FcnJvcnMgPSBbZXJyb3IyXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGh5ZHJhdGlvbkVycm9ycy5wdXNoKGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QmF0Y2hDb25maWc7CiAgICAgICAgdmFyIE5vVHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgZnVuY3Rpb24gcmVxdWVzdEN1cnJlbnRUcmFuc2l0aW9uKCkgewogICAgICAgICAgcmV0dXJuIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDEudHJhbnNpdGlvbjsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzID0gewogICAgICAgICAgcmVjb3JkVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3M6IGZ1bmN0aW9uKGZpYmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgfSwKICAgICAgICAgIGZsdXNoUGVuZGluZ1Vuc2FmZUxpZmVjeWNsZVdhcm5pbmdzOiBmdW5jdGlvbigpIHsKICAgICAgICAgIH0sCiAgICAgICAgICByZWNvcmRMZWdhY3lDb250ZXh0V2FybmluZzogZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICB9LAogICAgICAgICAgZmx1c2hMZWdhY3lDb250ZXh0V2FybmluZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICB9LAogICAgICAgICAgZGlzY2FyZFBlbmRpbmdXYXJuaW5nczogZnVuY3Rpb24oKSB7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB7CiAgICAgICAgICB2YXIgZmluZFN0cmljdFJvb3QgPSBmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICB2YXIgbWF5YmVTdHJpY3RSb290ID0gbnVsbDsKICAgICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgbWF5YmVTdHJpY3RSb290ID0gbm9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXliZVN0cmljdFJvb3Q7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHNldFRvU29ydGVkU3RyaW5nID0gZnVuY3Rpb24oc2V0NCkgewogICAgICAgICAgICB2YXIgYXJyYXkgPSBbXTsKICAgICAgICAgICAgc2V0NC5mb3JFYWNoKGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgYXJyYXkucHVzaCh2YWx1ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gYXJyYXkuc29ydCgpLmpvaW4oIiwgIik7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgdmFyIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBwZW5kaW5nQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzID0gW107CiAgICAgICAgICB2YXIgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgIHZhciBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZFVuc2FmZUxpZmVjeWNsZVdhcm5pbmdzID0gZnVuY3Rpb24oZmliZXIsIGluc3RhbmNlKSB7CiAgICAgICAgICAgIGlmIChkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmhhcyhmaWJlci50eXBlKSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIiAmJiAvLyBEb24ndCB3YXJuIGFib3V0IHJlYWN0LWxpZmVjeWNsZXMtY29tcGF0IHBvbHlmaWxsZWQgY29tcG9uZW50cy4KICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50Ll9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlICYmIHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcy5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgJiYgdHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsUmVjZWl2ZVByb3BzV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUuX19zdXBwcmVzc0RlcHJlY2F0aW9uV2FybmluZyAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MucHVzaChmaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlICYmIHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFVwZGF0ZVdhcm5pbmdzLnB1c2goZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZmx1c2hQZW5kaW5nVW5zYWZlTGlmZWN5Y2xlV2FybmluZ3MgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdDb21wb25lbnRXaWxsTW91bnRXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxNb3VudFdhcm5pbmdzID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgaWYgKHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbnNhZmVMaWZlY3ljbGVzLmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICBpZiAocGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5mb3JFYWNoKGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgICAgICBjb21wb25lbnRXaWxsVXBkYXRlVW5pcXVlTmFtZXMuYWRkKGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVuc2FmZUxpZmVjeWNsZXMuYWRkKGZpYmVyLnR5cGUpOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICAgIGlmIChwZW5kaW5nVU5TQUZFX0NvbXBvbmVudFdpbGxVcGRhdGVXYXJuaW5ncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MuZm9yRWFjaChmdW5jdGlvbihmaWJlcikgewogICAgICAgICAgICAgICAgVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcy5hZGQoZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5zYWZlTGlmZWN5Y2xlcy5hZGQoZmliZXIudHlwZSk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIHNvcnRlZE5hbWVzID0gc2V0VG9Tb3J0ZWRTdHJpbmcoVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudFVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCBpbiBzdHJpY3QgbW9kZSBpcyBub3QgcmVjb21tZW5kZWQgYW5kIG1heSBpbmRpY2F0ZSBidWdzIGluIHlvdXIgY29kZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBjb2RlIHdpdGggc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZE1vdW50LCBhbmQgc2V0IGluaXRpYWwgc3RhdGUgaW4gdGhlIGNvbnN0cnVjdG9yLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBzb3J0ZWROYW1lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICB2YXIgX3NvcnRlZE5hbWVzID0gc2V0VG9Tb3J0ZWRTdHJpbmcoVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHNVbmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgZXJyb3IoIlVzaW5nIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIGluIHN0cmljdCBtb2RlIGlzIG5vdCByZWNvbW1lbmRlZCBhbmQgbWF5IGluZGljYXRlIGJ1Z3MgaW4geW91ciBjb2RlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGRhdGEgZmV0Y2hpbmcgY29kZSBvciBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkVXBkYXRlLlxuKiBJZiB5b3UncmUgdXBkYXRpbmcgc3RhdGUgd2hlbmV2ZXIgcHJvcHMgY2hhbmdlLCByZWZhY3RvciB5b3VyIGNvZGUgdG8gdXNlIG1lbW9pemF0aW9uIHRlY2huaXF1ZXMgb3IgbW92ZSBpdCB0byBzdGF0aWMgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBMZWFybiBtb3JlIGF0OiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvZGVyaXZlZC1zdGF0ZVxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBfc29ydGVkTmFtZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczIgPSBzZXRUb1NvcnRlZFN0cmluZyhVTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgaW4gc3RyaWN0IG1vZGUgaXMgbm90IHJlY29tbWVuZGVkIGFuZCBtYXkgaW5kaWNhdGUgYnVncyBpbiB5b3VyIGNvZGUuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjb21wb25lbnRXaWxsTW91bnRVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXMzID0gc2V0VG9Tb3J0ZWRTdHJpbmcoY29tcG9uZW50V2lsbE1vdW50VW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIHdhcm4zKCJjb21wb25lbnRXaWxsTW91bnQgaGFzIGJlZW4gcmVuYW1lZCwgYW5kIGlzIG5vdCByZWNvbW1lbmRlZCBmb3IgdXNlLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyBmb3IgZGV0YWlscy5cblxuKiBNb3ZlIGNvZGUgd2l0aCBzaWRlIGVmZmVjdHMgdG8gY29tcG9uZW50RGlkTW91bnQsIGFuZCBzZXQgaW5pdGlhbCBzdGF0ZSBpbiB0aGUgY29uc3RydWN0b3IuXG4qIFJlbmFtZSBjb21wb25lbnRXaWxsTW91bnQgdG8gVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCB0byBzdXBwcmVzcyB0aGlzIHdhcm5pbmcgaW4gbm9uLXN0cmljdCBtb2RlLiBJbiBSZWFjdCAxOC54LCBvbmx5IHRoZSBVTlNBRkVfIG5hbWUgd2lsbCB3b3JrLiBUbyByZW5hbWUgYWxsIGRlcHJlY2F0ZWQgbGlmZWN5Y2xlcyB0byB0aGVpciBuZXcgbmFtZXMsIHlvdSBjYW4gcnVuIGBucHggcmVhY3QtY29kZW1vZCByZW5hbWUtdW5zYWZlLWxpZmVjeWNsZXNgIGluIHlvdXIgcHJvamVjdCBzb3VyY2UgZm9sZGVyLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXMiLCBfc29ydGVkTmFtZXMzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1VuaXF1ZU5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgdmFyIF9zb3J0ZWROYW1lczQgPSBzZXRUb1NvcnRlZFN0cmluZyhjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzVW5pcXVlTmFtZXMpOwogICAgICAgICAgICAgIHdhcm4zKCJjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIGhhcyBiZWVuIHJlbmFtZWQsIGFuZCBpcyBub3QgcmVjb21tZW5kZWQgZm9yIHVzZS4gU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay91bnNhZmUtY29tcG9uZW50LWxpZmVjeWNsZXMgZm9yIGRldGFpbHMuXG5cbiogTW92ZSBkYXRhIGZldGNoaW5nIGNvZGUgb3Igc2lkZSBlZmZlY3RzIHRvIGNvbXBvbmVudERpZFVwZGF0ZS5cbiogSWYgeW91J3JlIHVwZGF0aW5nIHN0YXRlIHdoZW5ldmVyIHByb3BzIGNoYW5nZSwgcmVmYWN0b3IgeW91ciBjb2RlIHRvIHVzZSBtZW1vaXphdGlvbiB0ZWNobmlxdWVzIG9yIG1vdmUgaXQgdG8gc3RhdGljIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4gTGVhcm4gbW9yZSBhdDogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Rlcml2ZWQtc3RhdGVcbiogUmVuYW1lIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgdG8gVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgdG8gc3VwcHJlc3MgdGhpcyB3YXJuaW5nIGluIG5vbi1zdHJpY3QgbW9kZS4gSW4gUmVhY3QgMTgueCwgb25seSB0aGUgVU5TQUZFXyBuYW1lIHdpbGwgd29yay4gVG8gcmVuYW1lIGFsbCBkZXByZWNhdGVkIGxpZmVjeWNsZXMgdG8gdGhlaXIgbmV3IG5hbWVzLCB5b3UgY2FuIHJ1biBgbnB4IHJlYWN0LWNvZGVtb2QgcmVuYW1lLXVuc2FmZS1saWZlY3ljbGVzYCBpbiB5b3VyIHByb2plY3Qgc291cmNlIGZvbGRlci5cblxuUGxlYXNlIHVwZGF0ZSB0aGUgZm9sbG93aW5nIGNvbXBvbmVudHM6ICVzIiwgX3NvcnRlZE5hbWVzNCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNvbXBvbmVudFdpbGxVcGRhdGVVbmlxdWVOYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgIHZhciBfc29ydGVkTmFtZXM1ID0gc2V0VG9Tb3J0ZWRTdHJpbmcoY29tcG9uZW50V2lsbFVwZGF0ZVVuaXF1ZU5hbWVzKTsKICAgICAgICAgICAgICB3YXJuMygiY29tcG9uZW50V2lsbFVwZGF0ZSBoYXMgYmVlbiByZW5hbWVkLCBhbmQgaXMgbm90IHJlY29tbWVuZGVkIGZvciB1c2UuIFNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvdW5zYWZlLWNvbXBvbmVudC1saWZlY3ljbGVzIGZvciBkZXRhaWxzLlxuXG4qIE1vdmUgZGF0YSBmZXRjaGluZyBjb2RlIG9yIHNpZGUgZWZmZWN0cyB0byBjb21wb25lbnREaWRVcGRhdGUuXG4qIFJlbmFtZSBjb21wb25lbnRXaWxsVXBkYXRlIHRvIFVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlIHRvIHN1cHByZXNzIHRoaXMgd2FybmluZyBpbiBub24tc3RyaWN0IG1vZGUuIEluIFJlYWN0IDE4LngsIG9ubHkgdGhlIFVOU0FGRV8gbmFtZSB3aWxsIHdvcmsuIFRvIHJlbmFtZSBhbGwgZGVwcmVjYXRlZCBsaWZlY3ljbGVzIHRvIHRoZWlyIG5ldyBuYW1lcywgeW91IGNhbiBydW4gYG5weCByZWFjdC1jb2RlbW9kIHJlbmFtZS11bnNhZmUtbGlmZWN5Y2xlc2AgaW4geW91ciBwcm9qZWN0IHNvdXJjZSBmb2xkZXIuXG5cblBsZWFzZSB1cGRhdGUgdGhlIGZvbGxvd2luZyBjb21wb25lbnRzOiAlcyIsIF9zb3J0ZWROYW1lczUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHBlbmRpbmdMZWdhY3lDb250ZXh0V2FybmluZyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgICB2YXIgZGlkV2FybkFib3V0TGVnYWN5Q29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRMZWdhY3lDb250ZXh0V2FybmluZyA9IGZ1bmN0aW9uKGZpYmVyLCBpbnN0YW5jZSkgewogICAgICAgICAgICB2YXIgc3RyaWN0Um9vdCA9IGZpbmRTdHJpY3RSb290KGZpYmVyKTsKICAgICAgICAgICAgaWYgKHN0cmljdFJvb3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdG8gZmluZCBhIFN0cmljdE1vZGUgY29tcG9uZW50IGluIGEgc3RyaWN0IG1vZGUgdHJlZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQuaGFzKGZpYmVyLnR5cGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB3YXJuaW5nc0ZvclJvb3QgPSBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcuZ2V0KHN0cmljdFJvb3QpOwogICAgICAgICAgICBpZiAoZmliZXIudHlwZS5jb250ZXh0VHlwZXMgIT0gbnVsbCB8fCBmaWJlci50eXBlLmNoaWxkQ29udGV4dFR5cGVzICE9IG51bGwgfHwgaW5zdGFuY2UgIT09IG51bGwgJiYgdHlwZW9mIGluc3RhbmNlLmdldENoaWxkQ29udGV4dCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh3YXJuaW5nc0ZvclJvb3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgd2FybmluZ3NGb3JSb290ID0gW107CiAgICAgICAgICAgICAgICBwZW5kaW5nTGVnYWN5Q29udGV4dFdhcm5pbmcuc2V0KHN0cmljdFJvb3QsIHdhcm5pbmdzRm9yUm9vdCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdhcm5pbmdzRm9yUm9vdC5wdXNoKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmZsdXNoTGVnYWN5Q29udGV4dFdhcm5pbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nLmZvckVhY2goZnVuY3Rpb24oZmliZXJBcnJheSwgc3RyaWN0Um9vdCkgewogICAgICAgICAgICAgIGlmIChmaWJlckFycmF5Lmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZmlyc3RGaWJlciA9IGZpYmVyQXJyYXlbMF07CiAgICAgICAgICAgICAgdmFyIHVuaXF1ZU5hbWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICBmaWJlckFycmF5LmZvckVhY2goZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgICAgICAgIHVuaXF1ZU5hbWVzLmFkZChnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiQ29tcG9uZW50Iik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0LmFkZChmaWJlci50eXBlKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB2YXIgc29ydGVkTmFtZXMgPSBzZXRUb1NvcnRlZFN0cmluZyh1bmlxdWVOYW1lcyk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaXJzdEZpYmVyKTsKICAgICAgICAgICAgICAgIGVycm9yKCJMZWdhY3kgY29udGV4dCBBUEkgaGFzIGJlZW4gZGV0ZWN0ZWQgd2l0aGluIGEgc3RyaWN0LW1vZGUgdHJlZS5cblxuVGhlIG9sZCBBUEkgd2lsbCBiZSBzdXBwb3J0ZWQgaW4gYWxsIDE2LnggcmVsZWFzZXMsIGJ1dCBhcHBsaWNhdGlvbnMgdXNpbmcgaXQgc2hvdWxkIG1pZ3JhdGUgdG8gdGhlIG5ldyB2ZXJzaW9uLlxuXG5QbGVhc2UgdXBkYXRlIHRoZSBmb2xsb3dpbmcgY29tcG9uZW50czogJXNcblxuTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2xlZ2FjeS1jb250ZXh0Iiwgc29ydGVkTmFtZXMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICB9OwogICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MuZGlzY2FyZFBlbmRpbmdXYXJuaW5ncyA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbE1vdW50V2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsTW91bnRXYXJuaW5ncyA9IFtdOwogICAgICAgICAgICBwZW5kaW5nQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdVTlNBRkVfQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wc1dhcm5pbmdzID0gW107CiAgICAgICAgICAgIHBlbmRpbmdDb21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ1VOU0FGRV9Db21wb25lbnRXaWxsVXBkYXRlV2FybmluZ3MgPSBbXTsKICAgICAgICAgICAgcGVuZGluZ0xlZ2FjeUNvbnRleHRXYXJuaW5nID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHZhciBkaWRXYXJuQWJvdXRNYXBzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRHZW5lcmF0b3JzOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzOwogICAgICAgIHZhciBvd25lckhhc0tleVVzZVdhcm5pbmc7CiAgICAgICAgdmFyIG93bmVySGFzRnVuY3Rpb25UeXBlV2FybmluZzsKICAgICAgICB2YXIgd2FybkZvck1pc3NpbmdLZXkgPSBmdW5jdGlvbihjaGlsZCwgcmV0dXJuRmliZXIpIHsKICAgICAgICB9OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dE1hcHMgPSBmYWxzZTsKICAgICAgICAgIGRpZFdhcm5BYm91dEdlbmVyYXRvcnMgPSBmYWxzZTsKICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnMgPSB7fTsKICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZyA9IHt9OwogICAgICAgICAgb3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nID0ge307CiAgICAgICAgICB3YXJuRm9yTWlzc2luZ0tleSA9IGZ1bmN0aW9uKGNoaWxkLCByZXR1cm5GaWJlcikgewogICAgICAgICAgICBpZiAoY2hpbGQgPT09IG51bGwgfHwgdHlwZW9mIGNoaWxkICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWNoaWxkLl9zdG9yZSB8fCBjaGlsZC5fc3RvcmUudmFsaWRhdGVkIHx8IGNoaWxkLmtleSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2hpbGQuX3N0b3JlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVhY3QgQ29tcG9uZW50IGluIHdhcm5Gb3JNaXNzaW5nS2V5IHNob3VsZCBoYXZlIGEgX3N0b3JlLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNoaWxkLl9zdG9yZS52YWxpZGF0ZWQgPSB0cnVlOwogICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIocmV0dXJuRmliZXIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICBpZiAob3duZXJIYXNLZXlVc2VXYXJuaW5nW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZ1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiBTZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3dhcm5pbmcta2V5cyBmb3IgbW9yZSBpbmZvcm1hdGlvbi4nKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVhY3RDbGFzcyh0eXBlKSB7CiAgICAgICAgICByZXR1cm4gdHlwZS5wcm90b3R5cGUgJiYgdHlwZS5wcm90b3R5cGUuaXNSZWFjdENvbXBvbmVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50NCwgZWxlbWVudCkgewogICAgICAgICAgdmFyIG1peGVkUmVmID0gZWxlbWVudC5yZWY7CiAgICAgICAgICBpZiAobWl4ZWRSZWYgIT09IG51bGwgJiYgdHlwZW9mIG1peGVkUmVmICE9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBtaXhlZFJlZiAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICgocmV0dXJuRmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUgfHwgd2FybkFib3V0U3RyaW5nUmVmcykgJiYgLy8gV2Ugd2FybiBpbiBSZWFjdEVsZW1lbnQuanMgaWYgb3duZXIgYW5kIHNlbGYgYXJlIGVxdWFsIGZvciBzdHJpbmcgcmVmcwogICAgICAgICAgICAgIC8vIGJlY2F1c2UgdGhlc2UgY2Fubm90IGJlIGF1dG9tYXRpY2FsbHkgY29udmVydGVkIHRvIGFuIGFycm93IGZ1bmN0aW9uCiAgICAgICAgICAgICAgLy8gdXNpbmcgYSBjb2RlbW9kLiBUaGVyZWZvcmUsIHdlIGRvbid0IGhhdmUgdG8gd2FybiBhYm91dCBzdHJpbmcgcmVmcyBhZ2Fpbi4KICAgICAgICAgICAgICAhKGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX3NlbGYgJiYgZWxlbWVudC5fb3duZXIuc3RhdGVOb2RlICE9PSBlbGVtZW50Ll9zZWxmKSAmJiAvLyBXaWxsIGFscmVhZHkgdGhyb3cgd2l0aCAiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgaGF2ZSBzdHJpbmcgcmVmcyIKICAgICAgICAgICAgICAhKGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyLnRhZyAhPT0gQ2xhc3NDb21wb25lbnQpICYmIC8vIFdpbGwgYWxyZWFkeSB3YXJuIHdpdGggIkZ1bmN0aW9uIGNvbXBvbmVudHMgY2Fubm90IGJlIGdpdmVuIHJlZnMiCiAgICAgICAgICAgICAgISh0eXBlb2YgZWxlbWVudC50eXBlID09PSAiZnVuY3Rpb24iICYmICFpc1JlYWN0Q2xhc3MoZWxlbWVudC50eXBlKSkgJiYgLy8gV2lsbCBhbHJlYWR5IHRocm93IHdpdGggIkVsZW1lbnQgcmVmIHdhcyBzcGVjaWZpZWQgYXMgYSBzdHJpbmcgKHNvbWVTdHJpbmdSZWYpIGJ1dCBubyBvd25lciB3YXMgc2V0IgogICAgICAgICAgICAgIGVsZW1lbnQuX293bmVyKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIocmV0dXJuRmliZXIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcignQ29tcG9uZW50ICIlcyIgY29udGFpbnMgdGhlIHN0cmluZyByZWYgIiVzIi4gU3VwcG9ydCBmb3Igc3RyaW5nIHJlZnMgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIG1ham9yIHJlbGVhc2UuIFdlIHJlY29tbWVuZCB1c2luZyB1c2VSZWYoKSBvciBjcmVhdGVSZWYoKSBpbnN0ZWFkLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1zdHJpbmctcmVmJywgY29tcG9uZW50TmFtZSwgbWl4ZWRSZWYpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWxlbWVudC5fb3duZXIpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgaW5zdDsKICAgICAgICAgICAgICBpZiAob3duZXIpIHsKICAgICAgICAgICAgICAgIHZhciBvd25lckZpYmVyID0gb3duZXI7CiAgICAgICAgICAgICAgICBpZiAob3duZXJGaWJlci50YWcgIT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRnVuY3Rpb24gY29tcG9uZW50cyBjYW5ub3QgaGF2ZSBzdHJpbmcgcmVmcy4gV2UgcmVjb21tZW5kIHVzaW5nIHVzZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluc3QgPSBvd25lckZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCFpbnN0KSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1pc3Npbmcgb3duZXIgZm9yIHN0cmluZyByZWYgIiArIG1peGVkUmVmICsgIi4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHJlc29sdmVkSW5zdCA9IGluc3Q7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wU3RyaW5nQ29lcmNpb24obWl4ZWRSZWYsICJyZWYiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHN0cmluZ1JlZiA9ICIiICsgbWl4ZWRSZWY7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0LnJlZiAhPT0gbnVsbCAmJiB0eXBlb2YgY3VycmVudDQucmVmID09PSAiZnVuY3Rpb24iICYmIGN1cnJlbnQ0LnJlZi5fc3RyaW5nUmVmID09PSBzdHJpbmdSZWYpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50NC5yZWY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciByZWYgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgICAgdmFyIHJlZnMgPSByZXNvbHZlZEluc3QucmVmczsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBkZWxldGUgcmVmc1tzdHJpbmdSZWZdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmVmc1tzdHJpbmdSZWZdID0gdmFsdWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICByZWYuX3N0cmluZ1JlZiA9IHN0cmluZ1JlZjsKICAgICAgICAgICAgICByZXR1cm4gcmVmOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgbWl4ZWRSZWYgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHJlZiB0byBiZSBhIGZ1bmN0aW9uLCBhIHN0cmluZywgYW4gb2JqZWN0IHJldHVybmVkIGJ5IFJlYWN0LmNyZWF0ZVJlZigpLCBvciBudWxsLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoIWVsZW1lbnQuX293bmVyKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkVsZW1lbnQgcmVmIHdhcyBzcGVjaWZpZWQgYXMgYSBzdHJpbmcgKCIgKyBtaXhlZFJlZiArICIpIGJ1dCBubyBvd25lciB3YXMgc2V0LiBUaGlzIGNvdWxkIGhhcHBlbiBmb3Igb25lIG9mIHRoZSBmb2xsb3dpbmcgcmVhc29uczpcbjEuIFlvdSBtYXkgYmUgYWRkaW5nIGEgcmVmIHRvIGEgZnVuY3Rpb24gY29tcG9uZW50XG4yLiBZb3UgbWF5IGJlIGFkZGluZyBhIHJlZiB0byBhIGNvbXBvbmVudCB0aGF0IHdhcyBub3QgY3JlYXRlZCBpbnNpZGUgYSBjb21wb25lbnQncyByZW5kZXIgbWV0aG9kXG4zLiBZb3UgaGF2ZSBtdWx0aXBsZSBjb3BpZXMgb2YgUmVhY3QgbG9hZGVkXG5TZWUgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlZnMtbXVzdC1oYXZlLW93bmVyIGZvciBtb3JlIGluZm9ybWF0aW9uLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1peGVkUmVmOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKSB7CiAgICAgICAgICB2YXIgY2hpbGRTdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwobmV3Q2hpbGQpOwogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJPYmplY3RzIGFyZSBub3QgdmFsaWQgYXMgYSBSZWFjdCBjaGlsZCAoZm91bmQ6ICIgKyAoY2hpbGRTdHJpbmcgPT09ICJbb2JqZWN0IE9iamVjdF0iID8gIm9iamVjdCB3aXRoIGtleXMgeyIgKyBPYmplY3Qua2V5cyhuZXdDaGlsZCkuam9pbigiLCAiKSArICJ9IiA6IGNoaWxkU3RyaW5nKSArICIpLiBJZiB5b3UgbWVhbnQgdG8gcmVuZGVyIGEgY29sbGVjdGlvbiBvZiBjaGlsZHJlbiwgdXNlIGFuIGFycmF5IGluc3RlYWQuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5PbkZ1bmN0aW9uVHlwZShyZXR1cm5GaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIocmV0dXJuRmliZXIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICBpZiAob3duZXJIYXNGdW5jdGlvblR5cGVXYXJuaW5nW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG93bmVySGFzRnVuY3Rpb25UeXBlV2FybmluZ1tjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgIGVycm9yKCJGdW5jdGlvbnMgYXJlIG5vdCB2YWxpZCBhcyBhIFJlYWN0IGNoaWxkLiBUaGlzIG1heSBoYXBwZW4gaWYgeW91IHJldHVybiBhIENvbXBvbmVudCBpbnN0ZWFkIG9mIDxDb21wb25lbnQgLz4gZnJvbSByZW5kZXIuIE9yIG1heWJlIHlvdSBtZWFudCB0byBjYWxsIHRoaXMgZnVuY3Rpb24gcmF0aGVyIHRoYW4gcmV0dXJuIGl0LiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlTGF6eShsYXp5VHlwZSkgewogICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5VHlwZS5fcGF5bG9hZDsKICAgICAgICAgIHZhciBpbml0ID0gbGF6eVR5cGUuX2luaXQ7CiAgICAgICAgICByZXR1cm4gaW5pdChwYXlsb2FkKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gQ2hpbGRSZWNvbmNpbGVyKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgIGZ1bmN0aW9uIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZFRvRGVsZXRlKSB7CiAgICAgICAgICAgIGlmICghc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcmV0dXJuRmliZXIuZGVsZXRpb25zOwogICAgICAgICAgICBpZiAoZGVsZXRpb25zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZGVsZXRpb25zID0gW2NoaWxkVG9EZWxldGVdOwogICAgICAgICAgICAgIHJldHVybkZpYmVyLmZsYWdzIHw9IENoaWxkRGVsZXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGVsZXRpb25zLnB1c2goY2hpbGRUb0RlbGV0ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCkgewogICAgICAgICAgICBpZiAoIXNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY2hpbGRUb0RlbGV0ZSA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoY2hpbGRUb0RlbGV0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGRlbGV0ZUNoaWxkKHJldHVybkZpYmVyLCBjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgICBjaGlsZFRvRGVsZXRlID0gY2hpbGRUb0RlbGV0ZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKSB7CiAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgICAgICAgdmFyIGV4aXN0aW5nQ2hpbGQgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgd2hpbGUgKGV4aXN0aW5nQ2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdDaGlsZC5rZXkgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uc2V0KGV4aXN0aW5nQ2hpbGQua2V5LCBleGlzdGluZ0NoaWxkKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZXhpc3RpbmdDaGlsZHJlbi5zZXQoZXhpc3RpbmdDaGlsZC5pbmRleCwgZXhpc3RpbmdDaGlsZCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGQgPSBleGlzdGluZ0NoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nQ2hpbGRyZW47CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1c2VGaWJlcihmaWJlciwgcGVuZGluZ1Byb3BzKSB7CiAgICAgICAgICAgIHZhciBjbG9uZSA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGZpYmVyLCBwZW5kaW5nUHJvcHMpOwogICAgICAgICAgICBjbG9uZS5pbmRleCA9IDA7CiAgICAgICAgICAgIGNsb25lLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICByZXR1cm4gY2xvbmU7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwbGFjZUNoaWxkKG5ld0ZpYmVyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0luZGV4KSB7CiAgICAgICAgICAgIG5ld0ZpYmVyLmluZGV4ID0gbmV3SW5kZXg7CiAgICAgICAgICAgIGlmICghc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IEZvcmtlZDsKICAgICAgICAgICAgICByZXR1cm4gbGFzdFBsYWNlZEluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IG5ld0ZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG9sZEluZGV4ID0gY3VycmVudDQuaW5kZXg7CiAgICAgICAgICAgICAgaWYgKG9sZEluZGV4IDwgbGFzdFBsYWNlZEluZGV4KSB7CiAgICAgICAgICAgICAgICBuZXdGaWJlci5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICAgICAgICByZXR1cm4gbGFzdFBsYWNlZEluZGV4OwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gb2xkSW5kZXg7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgICByZXR1cm4gbGFzdFBsYWNlZEluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiBwbGFjZVNpbmdsZUNoaWxkKG5ld0ZpYmVyKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzICYmIG5ld0ZpYmVyLmFsdGVybmF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIG5ld0ZpYmVyLmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3RmliZXI7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVUZXh0Tm9kZShyZXR1cm5GaWJlciwgY3VycmVudDQsIHRleHRDb250ZW50LCBsYW5lcykgewogICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwgfHwgY3VycmVudDQudGFnICE9PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tVGV4dCh0ZXh0Q29udGVudCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDQsIHRleHRDb250ZW50KTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUVsZW1lbnQocmV0dXJuRmliZXIsIGN1cnJlbnQ0LCBlbGVtZW50LCBsYW5lcykgewogICAgICAgICAgICB2YXIgZWxlbWVudFR5cGUgPSBlbGVtZW50LnR5cGU7CiAgICAgICAgICAgIGlmIChlbGVtZW50VHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudDIocmV0dXJuRmliZXIsIGN1cnJlbnQ0LCBlbGVtZW50LnByb3BzLmNoaWxkcmVuLCBsYW5lcywgZWxlbWVudC5rZXkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjdXJyZW50NC5lbGVtZW50VHlwZSA9PT0gZWxlbWVudFR5cGUgfHwgLy8gS2VlcCB0aGlzIGNoZWNrIGlubGluZSBzbyBpdCBvbmx5IHJ1bnMgb24gdGhlIGZhbHNlIHBhdGg6CiAgICAgICAgICAgICAgaXNDb21wYXRpYmxlRmFtaWx5Rm9ySG90UmVsb2FkaW5nKGN1cnJlbnQ0LCBlbGVtZW50KSB8fCAvLyBMYXp5IHR5cGVzIHNob3VsZCByZWNvbmNpbGUgdGhlaXIgcmVzb2x2ZWQgdHlwZS4KICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIGRvIHRoaXMgYWZ0ZXIgdGhlIEhvdCBSZWxvYWRpbmcgY2hlY2sgYWJvdmUsCiAgICAgICAgICAgICAgLy8gYmVjYXVzZSBob3QgcmVsb2FkaW5nIGhhcyBkaWZmZXJlbnQgc2VtYW50aWNzIHRoYW4gcHJvZCBiZWNhdXNlCiAgICAgICAgICAgICAgLy8gaXQgZG9lc24ndCByZXN1c3BlbmQuIFNvIHdlIGNhbid0IGxldCB0aGUgY2FsbCBiZWxvdyBzdXNwZW5kLgogICAgICAgICAgICAgIHR5cGVvZiBlbGVtZW50VHlwZSA9PT0gIm9iamVjdCIgJiYgZWxlbWVudFR5cGUgIT09IG51bGwgJiYgZWxlbWVudFR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSAmJiByZXNvbHZlTGF6eShlbGVtZW50VHlwZSkgPT09IGN1cnJlbnQ0LnR5cGUpIHsKICAgICAgICAgICAgICAgIHZhciBleGlzdGluZyA9IHVzZUZpYmVyKGN1cnJlbnQ0LCBlbGVtZW50LnByb3BzKTsKICAgICAgICAgICAgICAgIGV4aXN0aW5nLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgY3VycmVudDQsIGVsZW1lbnQpOwogICAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLl9kZWJ1Z1NvdXJjZSA9IGVsZW1lbnQuX3NvdXJjZTsKICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBleGlzdGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KGVsZW1lbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgY3JlYXRlZC5yZWYgPSBjb2VyY2VSZWYocmV0dXJuRmliZXIsIGN1cnJlbnQ0LCBlbGVtZW50KTsKICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVQb3J0YWwocmV0dXJuRmliZXIsIGN1cnJlbnQ0LCBwb3J0YWwsIGxhbmVzKSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC50YWcgIT09IEhvc3RQb3J0YWwgfHwgY3VycmVudDQuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8gIT09IHBvcnRhbC5jb250YWluZXJJbmZvIHx8IGN1cnJlbnQ0LnN0YXRlTm9kZS5pbXBsZW1lbnRhdGlvbiAhPT0gcG9ydGFsLmltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21Qb3J0YWwocG9ydGFsLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjdXJyZW50NCwgcG9ydGFsLmNoaWxkcmVuIHx8IFtdKTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZyYWdtZW50MihyZXR1cm5GaWJlciwgY3VycmVudDQsIGZyYWdtZW50LCBsYW5lcywga2V5KSB7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC50YWcgIT09IEZyYWdtZW50OSkgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZnJhZ21lbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzLCBrZXkpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudDQsIGZyYWdtZW50KTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICB2YXIgY3JlYXRlZCA9IGNyZWF0ZUZpYmVyRnJvbVRleHQoIiIgKyBuZXdDaGlsZCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKG5ld0NoaWxkLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0VMRU1FTlRfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkLnJlZiA9IGNvZXJjZVJlZihyZXR1cm5GaWJlciwgbnVsbCwgbmV3Q2hpbGQpOwogICAgICAgICAgICAgICAgICBfY3JlYXRlZC5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QT1JUQUxfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQyID0gY3JlYXRlRmliZXJGcm9tUG9ydGFsKG5ld0NoaWxkLCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICAgIF9jcmVhdGVkMi5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgICAgcmV0dXJuIF9jcmVhdGVkMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbmV3Q2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbmV3Q2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVDaGlsZChyZXR1cm5GaWJlciwgaW5pdChwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNBcnJheTIobmV3Q2hpbGQpIHx8IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICB2YXIgX2NyZWF0ZWQzID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQobmV3Q2hpbGQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzLCBudWxsKTsKICAgICAgICAgICAgICAgIF9jcmVhdGVkMy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRocm93T25JbnZhbGlkT2JqZWN0VHlwZShyZXR1cm5GaWJlciwgbmV3Q2hpbGQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB3YXJuT25GdW5jdGlvblR5cGUocmV0dXJuRmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGtleSA9IG9sZEZpYmVyICE9PSBudWxsID8gb2xkRmliZXIua2V5IDogbnVsbDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gInN0cmluZyIgJiYgbmV3Q2hpbGQgIT09ICIiIHx8IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBpZiAoa2V5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBvbGRGaWJlciwgIiIgKyBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICJvYmplY3QiICYmIG5ld0NoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChuZXdDaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgaWYgKG5ld0NoaWxkLmtleSA9PT0ga2V5KSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVsZW1lbnQocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIGlmIChuZXdDaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWwocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU2xvdChyZXR1cm5GaWJlciwgb2xkRmliZXIsIGluaXQocGF5bG9hZCksIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKG5ld0NoaWxkKSB8fCBnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgaWYgKGtleSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudDIocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZCwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVGcm9tTWFwKGV4aXN0aW5nQ2hpbGRyZW4sIHJldHVybkZpYmVyLCBuZXdJZHgsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHZhciBtYXRjaGVkRmliZXIgPSBleGlzdGluZ0NoaWxkcmVuLmdldChuZXdJZHgpIHx8IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVRleHROb2RlKHJldHVybkZpYmVyLCBtYXRjaGVkRmliZXIsICIiICsgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOiB7CiAgICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3Q2hpbGQua2V5ID09PSBudWxsID8gbmV3SWR4IDogbmV3Q2hpbGQua2V5KSB8fCBudWxsOwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRWxlbWVudChyZXR1cm5GaWJlciwgX21hdGNoZWRGaWJlciwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6IHsKICAgICAgICAgICAgICAgICAgdmFyIF9tYXRjaGVkRmliZXIyID0gZXhpc3RpbmdDaGlsZHJlbi5nZXQobmV3Q2hpbGQua2V5ID09PSBudWxsID8gbmV3SWR4IDogbmV3Q2hpbGQua2V5KSB8fCBudWxsOwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUG9ydGFsKHJldHVybkZpYmVyLCBfbWF0Y2hlZEZpYmVyMiwgbmV3Q2hpbGQsIGxhbmVzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBpbml0KHBheWxvYWQpLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpc0FycmF5MihuZXdDaGlsZCkgfHwgZ2V0SXRlcmF0b3JGbihuZXdDaGlsZCkpIHsKICAgICAgICAgICAgICAgIHZhciBfbWF0Y2hlZEZpYmVyMyA9IGV4aXN0aW5nQ2hpbGRyZW4uZ2V0KG5ld0lkeCkgfHwgbnVsbDsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudDIocmV0dXJuRmliZXIsIF9tYXRjaGVkRmliZXIzLCBuZXdDaGlsZCwgbGFuZXMsIG51bGwpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBmdW5jdGlvbiB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAodHlwZW9mIGNoaWxkICE9PSAib2JqZWN0IiB8fCBjaGlsZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGtub3duS2V5czsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3dpdGNoIChjaGlsZC4kJHR5cGVvZikgewogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9FTEVNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICB3YXJuRm9yTWlzc2luZ0tleShjaGlsZCwgcmV0dXJuRmliZXIpOwogICAgICAgICAgICAgICAgICB2YXIga2V5ID0gY2hpbGQua2V5OwogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGtleSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAoa25vd25LZXlzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAga25vd25LZXlzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICBrbm93bktleXMuYWRkKGtleSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFrbm93bktleXMuaGFzKGtleSkpIHsKICAgICAgICAgICAgICAgICAgICBrbm93bktleXMuYWRkKGtleSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXJyb3IoIkVuY291bnRlcmVkIHR3byBjaGlsZHJlbiB3aXRoIHRoZSBzYW1lIGtleSwgYCVzYC4gS2V5cyBzaG91bGQgYmUgdW5pcXVlIHNvIHRoYXQgY29tcG9uZW50cyBtYWludGFpbiB0aGVpciBpZGVudGl0eSBhY3Jvc3MgdXBkYXRlcy4gTm9uLXVuaXF1ZSBrZXlzIG1heSBjYXVzZSBjaGlsZHJlbiB0byBiZSBkdXBsaWNhdGVkIGFuZC9vciBvbWl0dGVkIFx1MjAxNCB0aGUgYmVoYXZpb3IgaXMgdW5zdXBwb3J0ZWQgYW5kIGNvdWxkIGNoYW5nZSBpbiBhIGZ1dHVyZSB2ZXJzaW9uLiIsIGtleSk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6CiAgICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gY2hpbGQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICAgIHZhciBpbml0ID0gY2hpbGQuX2luaXQ7CiAgICAgICAgICAgICAgICAgIHdhcm5PbkludmFsaWRLZXkoaW5pdChwYXlsb2FkKSwga25vd25LZXlzLCByZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4ga25vd25LZXlzOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlQ2hpbGRyZW5BcnJheShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkcmVuLCBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGtub3duS2V5cyA9IG51bGw7CiAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXdDaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gbmV3Q2hpbGRyZW5baV07CiAgICAgICAgICAgICAgICBrbm93bktleXMgPSB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBudWxsOwogICAgICAgICAgICB2YXIgcHJldmlvdXNOZXdGaWJlciA9IG51bGw7CiAgICAgICAgICAgIHZhciBvbGRGaWJlciA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB2YXIgbGFzdFBsYWNlZEluZGV4ID0gMDsKICAgICAgICAgICAgdmFyIG5ld0lkeCA9IDA7CiAgICAgICAgICAgIHZhciBuZXh0T2xkRmliZXIgPSBudWxsOwogICAgICAgICAgICBmb3IgKDsgb2xkRmliZXIgIT09IG51bGwgJiYgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgIGlmIChvbGRGaWJlci5pbmRleCA+IG5ld0lkeCkgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXI7CiAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRPbGRGaWJlciA9IG9sZEZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBuZXdGaWJlciA9IHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKG5ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciAmJiBuZXdGaWJlci5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChuZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IG5ld0ZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5ld0lkeCA9PT0gbmV3Q2hpbGRyZW4ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSBuZXdJZHg7CiAgICAgICAgICAgICAgICBwdXNoVHJlZUZvcmsocmV0dXJuRmliZXIsIG51bWJlck9mRm9ya3MpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmb3IgKDsgbmV3SWR4IDwgbmV3Q2hpbGRyZW4ubGVuZ3RoOyBuZXdJZHgrKykgewogICAgICAgICAgICAgICAgdmFyIF9uZXdGaWJlciA9IGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBuZXdDaGlsZHJlbltuZXdJZHhdLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgdmFyIF9udW1iZXJPZkZvcmtzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3Jrcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBleGlzdGluZ0NoaWxkcmVuID0gbWFwUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgZm9yICg7IG5ld0lkeCA8IG5ld0NoaWxkcmVuLmxlbmd0aDsgbmV3SWR4KyspIHsKICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyMiA9IHVwZGF0ZUZyb21NYXAoZXhpc3RpbmdDaGlsZHJlbiwgcmV0dXJuRmliZXIsIG5ld0lkeCwgbmV3Q2hpbGRyZW5bbmV3SWR4XSwgbGFuZXMpOwogICAgICAgICAgICAgIGlmIChfbmV3RmliZXIyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyMi5hbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLmRlbGV0ZShfbmV3RmliZXIyLmtleSA9PT0gbnVsbCA/IG5ld0lkeCA6IF9uZXdGaWJlcjIua2V5KTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChfbmV3RmliZXIyLCBsYXN0UGxhY2VkSW5kZXgsIG5ld0lkeCk7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOZXdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gX25ld0ZpYmVyMjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IF9uZXdGaWJlcjI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gX25ld0ZpYmVyMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBleGlzdGluZ0NoaWxkcmVuLmZvckVhY2goZnVuY3Rpb24oY2hpbGQyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkMik7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3MyID0gbmV3SWR4OwogICAgICAgICAgICAgIHB1c2hUcmVlRm9yayhyZXR1cm5GaWJlciwgX251bWJlck9mRm9ya3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkcmVuSXRlcmF0b3IocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZHJlbkl0ZXJhYmxlLCBsYW5lcykgewogICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4obmV3Q2hpbGRyZW5JdGVyYWJsZSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQW4gb2JqZWN0IGlzIG5vdCBhbiBpdGVyYWJsZS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgLy8gJEZsb3dGaXhNZSBGbG93IGRvZXNuJ3Qga25vdyBhYm91dCB0b1N0cmluZ1RhZwogICAgICAgICAgICAgIG5ld0NoaWxkcmVuSXRlcmFibGVbU3ltYm9sLnRvU3RyaW5nVGFnXSA9PT0gIkdlbmVyYXRvciIpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0R2VuZXJhdG9ycykgewogICAgICAgICAgICAgICAgICBlcnJvcigiVXNpbmcgR2VuZXJhdG9ycyBhcyBjaGlsZHJlbiBpcyB1bnN1cHBvcnRlZCBhbmQgd2lsbCBsaWtlbHkgeWllbGQgdW5leHBlY3RlZCByZXN1bHRzIGJlY2F1c2UgZW51bWVyYXRpbmcgYSBnZW5lcmF0b3IgbXV0YXRlcyBpdC4gWW91IG1heSBjb252ZXJ0IGl0IHRvIGFuIGFycmF5IHdpdGggYEFycmF5LmZyb20oKWAgb3IgdGhlIGBbLi4uc3ByZWFkXWAgb3BlcmF0b3IgYmVmb3JlIHJlbmRlcmluZy4gS2VlcCBpbiBtaW5kIHlvdSBtaWdodCBuZWVkIHRvIHBvbHlmaWxsIHRoZXNlIGZlYXR1cmVzIGZvciBvbGRlciBicm93c2Vycy4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEdlbmVyYXRvcnMgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobmV3Q2hpbGRyZW5JdGVyYWJsZS5lbnRyaWVzID09PSBpdGVyYXRvckZuKSB7CiAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1hcHMpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVzaW5nIE1hcHMgYXMgY2hpbGRyZW4gaXMgbm90IHN1cHBvcnRlZC4gVXNlIGFuIGFycmF5IG9mIGtleWVkIFJlYWN0RWxlbWVudHMgaW5zdGVhZC4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1hcHMgPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgX25ld0NoaWxkcmVuID0gaXRlcmF0b3JGbi5jYWxsKG5ld0NoaWxkcmVuSXRlcmFibGUpOwogICAgICAgICAgICAgIGlmIChfbmV3Q2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgIHZhciBrbm93bktleXMgPSBudWxsOwogICAgICAgICAgICAgICAgdmFyIF9zdGVwID0gX25ld0NoaWxkcmVuLm5leHQoKTsKICAgICAgICAgICAgICAgIGZvciAoOyAhX3N0ZXAuZG9uZTsgX3N0ZXAgPSBfbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IF9zdGVwLnZhbHVlOwogICAgICAgICAgICAgICAgICBrbm93bktleXMgPSB3YXJuT25JbnZhbGlkS2V5KGNoaWxkLCBrbm93bktleXMsIHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gaXRlcmF0b3JGbi5jYWxsKG5ld0NoaWxkcmVuSXRlcmFibGUpOwogICAgICAgICAgICBpZiAobmV3Q2hpbGRyZW4gPT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQW4gaXRlcmFibGUgb2JqZWN0IHByb3ZpZGVkIG5vIGl0ZXJhdG9yLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByZXN1bHRpbmdGaXJzdENoaWxkID0gbnVsbDsKICAgICAgICAgICAgdmFyIHByZXZpb3VzTmV3RmliZXIgPSBudWxsOwogICAgICAgICAgICB2YXIgb2xkRmliZXIgPSBjdXJyZW50Rmlyc3RDaGlsZDsKICAgICAgICAgICAgdmFyIGxhc3RQbGFjZWRJbmRleCA9IDA7CiAgICAgICAgICAgIHZhciBuZXdJZHggPSAwOwogICAgICAgICAgICB2YXIgbmV4dE9sZEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgdmFyIHN0ZXAgPSBuZXdDaGlsZHJlbi5uZXh0KCk7CiAgICAgICAgICAgIGZvciAoOyBvbGRGaWJlciAhPT0gbnVsbCAmJiAhc3RlcC5kb25lOyBuZXdJZHgrKywgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKSkgewogICAgICAgICAgICAgIGlmIChvbGRGaWJlci5pbmRleCA+IG5ld0lkeCkgewogICAgICAgICAgICAgICAgbmV4dE9sZEZpYmVyID0gb2xkRmliZXI7CiAgICAgICAgICAgICAgICBvbGRGaWJlciA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5leHRPbGRGaWJlciA9IG9sZEZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBuZXdGaWJlciA9IHVwZGF0ZVNsb3QocmV0dXJuRmliZXIsIG9sZEZpYmVyLCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKG5ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAob2xkRmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHNob3VsZFRyYWNrU2lkZUVmZmVjdHMpIHsKICAgICAgICAgICAgICAgIGlmIChvbGRGaWJlciAmJiBuZXdGaWJlci5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIG9sZEZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdFBsYWNlZEluZGV4ID0gcGxhY2VDaGlsZChuZXdGaWJlciwgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXN1bHRpbmdGaXJzdENoaWxkID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIuc2libGluZyA9IG5ld0ZpYmVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyID0gbmV3RmliZXI7CiAgICAgICAgICAgICAgb2xkRmliZXIgPSBuZXh0T2xkRmliZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHN0ZXAuZG9uZSkgewogICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgICAgIHZhciBudW1iZXJPZkZvcmtzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBudW1iZXJPZkZvcmtzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdGluZ0ZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9sZEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZm9yICg7ICFzdGVwLmRvbmU7IG5ld0lkeCsrLCBzdGVwID0gbmV3Q2hpbGRyZW4ubmV4dCgpKSB7CiAgICAgICAgICAgICAgICB2YXIgX25ld0ZpYmVyMyA9IGNyZWF0ZUNoaWxkKHJldHVybkZpYmVyLCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoX25ld0ZpYmVyMyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxhc3RQbGFjZWRJbmRleCA9IHBsYWNlQ2hpbGQoX25ld0ZpYmVyMywgbGFzdFBsYWNlZEluZGV4LCBuZXdJZHgpOwogICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmV3RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nRmlyc3RDaGlsZCA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBwcmV2aW91c05ld0ZpYmVyLnNpYmxpbmcgPSBfbmV3RmliZXIzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlciA9IF9uZXdGaWJlcjM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpKSB7CiAgICAgICAgICAgICAgICB2YXIgX251bWJlck9mRm9ya3MzID0gbmV3SWR4OwogICAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0aW5nRmlyc3RDaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXhpc3RpbmdDaGlsZHJlbiA9IG1hcFJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBvbGRGaWJlcik7CiAgICAgICAgICAgIGZvciAoOyAhc3RlcC5kb25lOyBuZXdJZHgrKywgc3RlcCA9IG5ld0NoaWxkcmVuLm5leHQoKSkgewogICAgICAgICAgICAgIHZhciBfbmV3RmliZXI0ID0gdXBkYXRlRnJvbU1hcChleGlzdGluZ0NoaWxkcmVuLCByZXR1cm5GaWJlciwgbmV3SWR4LCBzdGVwLnZhbHVlLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKF9uZXdGaWJlcjQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChzaG91bGRUcmFja1NpZGVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgICAgIGlmIChfbmV3RmliZXI0LmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZGVsZXRlKF9uZXdGaWJlcjQua2V5ID09PSBudWxsID8gbmV3SWR4IDogX25ld0ZpYmVyNC5rZXkpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsYXN0UGxhY2VkSW5kZXggPSBwbGFjZUNoaWxkKF9uZXdGaWJlcjQsIGxhc3RQbGFjZWRJbmRleCwgbmV3SWR4KTsKICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05ld0ZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdGluZ0ZpcnN0Q2hpbGQgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcHJldmlvdXNOZXdGaWJlci5zaWJsaW5nID0gX25ld0ZpYmVyNDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHByZXZpb3VzTmV3RmliZXIgPSBfbmV3RmliZXI0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2hvdWxkVHJhY2tTaWRlRWZmZWN0cykgewogICAgICAgICAgICAgIGV4aXN0aW5nQ2hpbGRyZW4uZm9yRWFjaChmdW5jdGlvbihjaGlsZDIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgIHZhciBfbnVtYmVyT2ZGb3JrczQgPSBuZXdJZHg7CiAgICAgICAgICAgICAgcHVzaFRyZWVGb3JrKHJldHVybkZpYmVyLCBfbnVtYmVyT2ZGb3JrczQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiByZXN1bHRpbmdGaXJzdENoaWxkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlVGV4dE5vZGUocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCB0ZXh0Q29udGVudCwgbGFuZXMpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnRGaXJzdENoaWxkICE9PSBudWxsICYmIGN1cnJlbnRGaXJzdENoaWxkLnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY3VycmVudEZpcnN0Q2hpbGQsIHRleHRDb250ZW50KTsKICAgICAgICAgICAgICBleGlzdGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkKTsKICAgICAgICAgICAgdmFyIGNyZWF0ZWQgPSBjcmVhdGVGaWJlckZyb21UZXh0KHRleHRDb250ZW50LCByZXR1cm5GaWJlci5tb2RlLCBsYW5lcyk7CiAgICAgICAgICAgIGNyZWF0ZWQucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgfQogICAgICAgICAgZnVuY3Rpb24gcmVjb25jaWxlU2luZ2xlRWxlbWVudChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIGVsZW1lbnQsIGxhbmVzKSB7CiAgICAgICAgICAgIHZhciBrZXkgPSBlbGVtZW50LmtleTsKICAgICAgICAgICAgdmFyIGNoaWxkID0gY3VycmVudEZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjaGlsZC5rZXkgPT09IGtleSkgewogICAgICAgICAgICAgICAgdmFyIGVsZW1lbnRUeXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICAgICAgaWYgKGVsZW1lbnRUeXBlID09PSBSRUFDVF9GUkFHTUVOVF9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC50YWcgPT09IEZyYWdtZW50OSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgICB2YXIgZXhpc3RpbmcgPSB1c2VGaWJlcihjaGlsZCwgZWxlbWVudC5wcm9wcy5jaGlsZHJlbik7CiAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcucmV0dXJuID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnU291cmNlID0gZWxlbWVudC5fc291cmNlOwogICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmcuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV4aXN0aW5nOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQuZWxlbWVudFR5cGUgPT09IGVsZW1lbnRUeXBlIHx8IC8vIEtlZXAgdGhpcyBjaGVjayBpbmxpbmUgc28gaXQgb25seSBydW5zIG9uIHRoZSBmYWxzZSBwYXRoOgogICAgICAgICAgICAgICAgICBpc0NvbXBhdGlibGVGYW1pbHlGb3JIb3RSZWxvYWRpbmcoY2hpbGQsIGVsZW1lbnQpIHx8IC8vIExhenkgdHlwZXMgc2hvdWxkIHJlY29uY2lsZSB0aGVpciByZXNvbHZlZCB0eXBlLgogICAgICAgICAgICAgICAgICAvLyBXZSBuZWVkIHRvIGRvIHRoaXMgYWZ0ZXIgdGhlIEhvdCBSZWxvYWRpbmcgY2hlY2sgYWJvdmUsCiAgICAgICAgICAgICAgICAgIC8vIGJlY2F1c2UgaG90IHJlbG9hZGluZyBoYXMgZGlmZmVyZW50IHNlbWFudGljcyB0aGFuIHByb2QgYmVjYXVzZQogICAgICAgICAgICAgICAgICAvLyBpdCBkb2Vzbid0IHJlc3VzcGVuZC4gU28gd2UgY2FuJ3QgbGV0IHRoZSBjYWxsIGJlbG93IHN1c3BlbmQuCiAgICAgICAgICAgICAgICAgIHR5cGVvZiBlbGVtZW50VHlwZSA9PT0gIm9iamVjdCIgJiYgZWxlbWVudFR5cGUgIT09IG51bGwgJiYgZWxlbWVudFR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSAmJiByZXNvbHZlTGF6eShlbGVtZW50VHlwZSkgPT09IGNoaWxkLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQuc2libGluZyk7CiAgICAgICAgICAgICAgICAgICAgdmFyIF9leGlzdGluZyA9IHVzZUZpYmVyKGNoaWxkLCBlbGVtZW50LnByb3BzKTsKICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjaGlsZCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgICAgICAgX2V4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgIF9leGlzdGluZy5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICBfZXhpc3RpbmcuX2RlYnVnT3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9leGlzdGluZzsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZGVsZXRlUmVtYWluaW5nQ2hpbGRyZW4ocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkZWxldGVDaGlsZChyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVsZW1lbnQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSkgewogICAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZWxlbWVudC5wcm9wcy5jaGlsZHJlbiwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMsIGVsZW1lbnQua2V5KTsKICAgICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBjcmVhdGVkOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfY3JlYXRlZDQgPSBjcmVhdGVGaWJlckZyb21FbGVtZW50KGVsZW1lbnQsIHJldHVybkZpYmVyLm1vZGUsIGxhbmVzKTsKICAgICAgICAgICAgICBfY3JlYXRlZDQucmVmID0gY29lcmNlUmVmKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgZWxlbWVudCk7CiAgICAgICAgICAgICAgX2NyZWF0ZWQ0LnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgIHJldHVybiBfY3JlYXRlZDQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZVNpbmdsZVBvcnRhbChyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIHBvcnRhbCwgbGFuZXMpIHsKICAgICAgICAgICAgdmFyIGtleSA9IHBvcnRhbC5rZXk7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGN1cnJlbnRGaXJzdENoaWxkOwogICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoY2hpbGQua2V5ID09PSBrZXkpIHsKICAgICAgICAgICAgICAgIGlmIChjaGlsZC50YWcgPT09IEhvc3RQb3J0YWwgJiYgY2hpbGQuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8gPT09IHBvcnRhbC5jb250YWluZXJJbmZvICYmIGNoaWxkLnN0YXRlTm9kZS5pbXBsZW1lbnRhdGlvbiA9PT0gcG9ydGFsLmltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgICAgICAgICAgIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjaGlsZC5zaWJsaW5nKTsKICAgICAgICAgICAgICAgICAgdmFyIGV4aXN0aW5nID0gdXNlRmliZXIoY2hpbGQsIHBvcnRhbC5jaGlsZHJlbiB8fCBbXSk7CiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICAgICAgICByZXR1cm4gZXhpc3Rpbmc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBkZWxldGVSZW1haW5pbmdDaGlsZHJlbihyZXR1cm5GaWJlciwgY2hpbGQpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlQ2hpbGQocmV0dXJuRmliZXIsIGNoaWxkKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2hpbGQgPSBjaGlsZC5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjcmVhdGVkID0gY3JlYXRlRmliZXJGcm9tUG9ydGFsKHBvcnRhbCwgcmV0dXJuRmliZXIubW9kZSwgbGFuZXMpOwogICAgICAgICAgICBjcmVhdGVkLnJldHVybiA9IHJldHVybkZpYmVyOwogICAgICAgICAgICByZXR1cm4gY3JlYXRlZDsKICAgICAgICAgIH0KICAgICAgICAgIGZ1bmN0aW9uIHJlY29uY2lsZUNoaWxkRmliZXJzMihyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcykgewogICAgICAgICAgICB2YXIgaXNVbmtleWVkVG9wTGV2ZWxGcmFnbWVudCA9IHR5cGVvZiBuZXdDaGlsZCA9PT0gIm9iamVjdCIgJiYgbmV3Q2hpbGQgIT09IG51bGwgJiYgbmV3Q2hpbGQudHlwZSA9PT0gUkVBQ1RfRlJBR01FTlRfVFlQRSAmJiBuZXdDaGlsZC5rZXkgPT09IG51bGw7CiAgICAgICAgICAgIGlmIChpc1Vua2V5ZWRUb3BMZXZlbEZyYWdtZW50KSB7CiAgICAgICAgICAgICAgbmV3Q2hpbGQgPSBuZXdDaGlsZC5wcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAib2JqZWN0IiAmJiBuZXdDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAobmV3Q2hpbGQuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRUxFTUVOVF9UWVBFOgogICAgICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVFbGVtZW50KHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgbmV3Q2hpbGQsIGxhbmVzKSk7CiAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BPUlRBTF9UWVBFOgogICAgICAgICAgICAgICAgICByZXR1cm4gcGxhY2VTaW5nbGVDaGlsZChyZWNvbmNpbGVTaW5nbGVQb3J0YWwocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpKTsKICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTEFaWV9UWVBFOgogICAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IG5ld0NoaWxkLl9wYXlsb2FkOwogICAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IG5ld0NoaWxkLl9pbml0OwogICAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRGaWJlcnMyKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgaW5pdChwYXlsb2FkKSwgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaXNBcnJheTIobmV3Q2hpbGQpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRyZW5BcnJheShyZXR1cm5GaWJlciwgY3VycmVudEZpcnN0Q2hpbGQsIG5ld0NoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChnZXRJdGVyYXRvckZuKG5ld0NoaWxkKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlY29uY2lsZUNoaWxkcmVuSXRlcmF0b3IocmV0dXJuRmliZXIsIGN1cnJlbnRGaXJzdENoaWxkLCBuZXdDaGlsZCwgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd09uSW52YWxpZE9iamVjdFR5cGUocmV0dXJuRmliZXIsIG5ld0NoaWxkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAic3RyaW5nIiAmJiBuZXdDaGlsZCAhPT0gIiIgfHwgdHlwZW9mIG5ld0NoaWxkID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgIHJldHVybiBwbGFjZVNpbmdsZUNoaWxkKHJlY29uY2lsZVNpbmdsZVRleHROb2RlKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCwgIiIgKyBuZXdDaGlsZCwgbGFuZXMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgd2Fybk9uRnVuY3Rpb25UeXBlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGRlbGV0ZVJlbWFpbmluZ0NoaWxkcmVuKHJldHVybkZpYmVyLCBjdXJyZW50Rmlyc3RDaGlsZCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVjb25jaWxlQ2hpbGRGaWJlcnMyOwogICAgICAgIH0KICAgICAgICB2YXIgcmVjb25jaWxlQ2hpbGRGaWJlcnMgPSBDaGlsZFJlY29uY2lsZXIodHJ1ZSk7CiAgICAgICAgdmFyIG1vdW50Q2hpbGRGaWJlcnMgPSBDaGlsZFJlY29uY2lsZXIoZmFsc2UpOwogICAgICAgIGZ1bmN0aW9uIGNsb25lQ2hpbGRGaWJlcnMoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmIHdvcmtJblByb2dyZXNzMi5jaGlsZCAhPT0gY3VycmVudDQuY2hpbGQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJSZXN1bWluZyB3b3JrIG5vdCB5ZXQgaW1wbGVtZW50ZWQuIik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmNoaWxkID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50Q2hpbGQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB2YXIgbmV3Q2hpbGQgPSBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50Q2hpbGQsIGN1cnJlbnRDaGlsZC5wZW5kaW5nUHJvcHMpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gbmV3Q2hpbGQ7CiAgICAgICAgICBuZXdDaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB3aGlsZSAoY3VycmVudENoaWxkLnNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgY3VycmVudENoaWxkID0gY3VycmVudENoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIG5ld0NoaWxkID0gbmV3Q2hpbGQuc2libGluZyA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRDaGlsZCwgY3VycmVudENoaWxkLnBlbmRpbmdQcm9wcyk7CiAgICAgICAgICAgIG5ld0NoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIH0KICAgICAgICAgIG5ld0NoaWxkLnNpYmxpbmcgPSBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgbGFuZXMpIHsKICAgICAgICAgIHZhciBjaGlsZCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzKGNoaWxkLCBsYW5lcyk7CiAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHZhbHVlQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKG51bGwpOwogICAgICAgIHZhciByZW5kZXJlclNpZ2lsOwogICAgICAgIHsKICAgICAgICAgIHJlbmRlcmVyU2lnaWwgPSB7fTsKICAgICAgICB9CiAgICAgICAgdmFyIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID0gbnVsbDsKICAgICAgICB2YXIgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gbnVsbDsKICAgICAgICB2YXIgbGFzdEZ1bGx5T2JzZXJ2ZWRDb250ZXh0ID0gbnVsbDsKICAgICAgICB2YXIgaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFViA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpIHsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyID0gbnVsbDsKICAgICAgICAgIGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9IG51bGw7CiAgICAgICAgICBsYXN0RnVsbHlPYnNlcnZlZENvbnRleHQgPSBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBpc0Rpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVudGVyRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBleGl0RGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlzRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFByb3ZpZGVyKHByb3ZpZGVyRmliZXIsIGNvbnRleHQsIG5leHRWYWx1ZSkgewogICAgICAgICAgewogICAgICAgICAgICBwdXNoKHZhbHVlQ3Vyc29yLCBjb250ZXh0Ll9jdXJyZW50VmFsdWUsIHByb3ZpZGVyRmliZXIpOwogICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50VmFsdWUgPSBuZXh0VmFsdWU7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoY29udGV4dC5fY3VycmVudFJlbmRlcmVyICE9PSB2b2lkIDAgJiYgY29udGV4dC5fY3VycmVudFJlbmRlcmVyICE9PSBudWxsICYmIGNvbnRleHQuX2N1cnJlbnRSZW5kZXJlciAhPT0gcmVuZGVyZXJTaWdpbCkgewogICAgICAgICAgICAgICAgZXJyb3IoIkRldGVjdGVkIG11bHRpcGxlIHJlbmRlcmVycyBjb25jdXJyZW50bHkgcmVuZGVyaW5nIHRoZSBzYW1lIGNvbnRleHQgcHJvdmlkZXIuIFRoaXMgaXMgY3VycmVudGx5IHVuc3VwcG9ydGVkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb250ZXh0Ll9jdXJyZW50UmVuZGVyZXIgPSByZW5kZXJlclNpZ2lsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBvcFByb3ZpZGVyKGNvbnRleHQsIHByb3ZpZGVyRmliZXIpIHsKICAgICAgICAgIHZhciBjdXJyZW50VmFsdWUgPSB2YWx1ZUN1cnNvci5jdXJyZW50OwogICAgICAgICAgcG9wKHZhbHVlQ3Vyc29yLCBwcm92aWRlckZpYmVyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGNvbnRleHQuX2N1cnJlbnRWYWx1ZSA9IGN1cnJlbnRWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUNvbnRleHRXb3JrT25QYXJlbnRQYXRoKHBhcmVudCwgcmVuZGVyTGFuZXMyLCBwcm9wYWdhdGlvblJvb3QpIHsKICAgICAgICAgIHZhciBub2RlID0gcGFyZW50OwogICAgICAgICAgd2hpbGUgKG5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IG5vZGUuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhub2RlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICBub2RlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5vZGUuY2hpbGRMYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBhbHRlcm5hdGUuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCAmJiAhaXNTdWJzZXRPZkxhbmVzKGFsdGVybmF0ZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgICAgYWx0ZXJuYXRlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5jaGlsZExhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlID09PSBwcm9wYWdhdGlvblJvb3QpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChub2RlICE9PSBwcm9wYWdhdGlvblJvb3QpIHsKICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdG8gZmluZCB0aGUgcHJvcGFnYXRpb24gcm9vdCB3aGVuIHNjaGVkdWxpbmcgY29udGV4dCB3b3JrLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2Uod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcHJvcGFnYXRlQ29udGV4dENoYW5nZV9lYWdlcih3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHByb3BhZ2F0ZUNvbnRleHRDaGFuZ2VfZWFnZXIod29ya0luUHJvZ3Jlc3MyLCBjb250ZXh0LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBmaWJlciA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgIGlmIChmaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICBmaWJlci5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB9CiAgICAgICAgICB3aGlsZSAoZmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIG5leHRGaWJlciA9IHZvaWQgMDsKICAgICAgICAgICAgdmFyIGxpc3QgPSBmaWJlci5kZXBlbmRlbmNpZXM7CiAgICAgICAgICAgIGlmIChsaXN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIGRlcGVuZGVuY3kgPSBsaXN0LmZpcnN0Q29udGV4dDsKICAgICAgICAgICAgICB3aGlsZSAoZGVwZW5kZW5jeSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGRlcGVuZGVuY3kuY29udGV4dCA9PT0gY29udGV4dCkgewogICAgICAgICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICAgIHZhciBsYW5lID0gcGlja0FyYml0cmFyeUxhbmUocmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKE5vVGltZXN0YW1wLCBsYW5lKTsKICAgICAgICAgICAgICAgICAgICB1cGRhdGUudGFnID0gRm9yY2VVcGRhdGU7CiAgICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlID09PSBudWxsKSA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgc2hhcmVkUXVldWUgPSB1cGRhdGVRdWV1ZS5zaGFyZWQ7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgcGVuZGluZyA9IHNoYXJlZFF1ZXVlLnBlbmRpbmc7CiAgICAgICAgICAgICAgICAgICAgICBpZiAocGVuZGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gcGVuZGluZy5uZXh0OwogICAgICAgICAgICAgICAgICAgICAgICBwZW5kaW5nLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBzaGFyZWRRdWV1ZS5wZW5kaW5nID0gdXBkYXRlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBmaWJlci5sYW5lcyA9IG1lcmdlTGFuZXMoZmliZXIubGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBhbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBzY2hlZHVsZUNvbnRleHRXb3JrT25QYXJlbnRQYXRoKGZpYmVyLnJldHVybiwgcmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICBsaXN0LmxhbmVzID0gbWVyZ2VMYW5lcyhsaXN0LmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlcGVuZGVuY3kgPSBkZXBlbmRlbmN5Lm5leHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGZpYmVyLnRhZyA9PT0gQ29udGV4dFByb3ZpZGVyKSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXIudHlwZSA9PT0gd29ya0luUHJvZ3Jlc3MyLnR5cGUgPyBudWxsIDogZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmliZXIudGFnID09PSBEZWh5ZHJhdGVkRnJhZ21lbnQpIHsKICAgICAgICAgICAgICB2YXIgcGFyZW50U3VzcGVuc2UgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgaWYgKHBhcmVudFN1c3BlbnNlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlIGp1c3QgY2FtZSBmcm9tIGEgcGFyZW50IHNvIHdlIG11c3QgaGF2ZSBoYWQgYSBwYXJlbnQuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBhcmVudFN1c3BlbnNlLmxhbmVzID0gbWVyZ2VMYW5lcyhwYXJlbnRTdXNwZW5zZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgX2FsdGVybmF0ZSA9IHBhcmVudFN1c3BlbnNlLmFsdGVybmF0ZTsKICAgICAgICAgICAgICBpZiAoX2FsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgX2FsdGVybmF0ZS5sYW5lcyA9IG1lcmdlTGFuZXMoX2FsdGVybmF0ZS5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChwYXJlbnRTdXNwZW5zZSwgcmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIG5leHRGaWJlciA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dEZpYmVyID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5leHRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5leHRGaWJlci5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXh0RmliZXIgPSBmaWJlcjsKICAgICAgICAgICAgICB3aGlsZSAobmV4dEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobmV4dEZpYmVyID09PSB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgICAgICAgICAgbmV4dEZpYmVyID0gbnVsbDsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgc2libGluZyA9IG5leHRGaWJlci5zaWJsaW5nOwogICAgICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBuZXh0RmliZXIucmV0dXJuOwogICAgICAgICAgICAgICAgICBuZXh0RmliZXIgPSBzaWJsaW5nOwogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5leHRGaWJlciA9IG5leHRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGZpYmVyID0gbmV4dEZpYmVyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBudWxsOwogICAgICAgICAgbGFzdEZ1bGx5T2JzZXJ2ZWRDb250ZXh0ID0gbnVsbDsKICAgICAgICAgIHZhciBkZXBlbmRlbmNpZXMgPSB3b3JrSW5Qcm9ncmVzczIuZGVwZW5kZW5jaWVzOwogICAgICAgICAgaWYgKGRlcGVuZGVuY2llcyAhPT0gbnVsbCkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0Q29udGV4dCA9IGRlcGVuZGVuY2llcy5maXJzdENvbnRleHQ7CiAgICAgICAgICAgICAgaWYgKGZpcnN0Q29udGV4dCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUoZGVwZW5kZW5jaWVzLmxhbmVzLCByZW5kZXJMYW5lczIpKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtXb3JrSW5Qcm9ncmVzc1JlY2VpdmVkVXBkYXRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZXBlbmRlbmNpZXMuZmlyc3RDb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVhZENvbnRleHQoY29udGV4dCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNEaXNhbGxvd2VkQ29udGV4dFJlYWRJbkRFVikgewogICAgICAgICAgICAgIGVycm9yKCJDb250ZXh0IGNhbiBvbmx5IGJlIHJlYWQgd2hpbGUgUmVhY3QgaXMgcmVuZGVyaW5nLiBJbiBjbGFzc2VzLCB5b3UgY2FuIHJlYWQgaXQgaW4gdGhlIHJlbmRlciBtZXRob2Qgb3IgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBJbiBmdW5jdGlvbiBjb21wb25lbnRzLCB5b3UgY2FuIHJlYWQgaXQgZGlyZWN0bHkgaW4gdGhlIGZ1bmN0aW9uIGJvZHksIGJ1dCBub3QgaW5zaWRlIEhvb2tzIGxpa2UgdXNlUmVkdWNlcigpIG9yIHVzZU1lbW8oKS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHZhbHVlID0gY29udGV4dC5fY3VycmVudFZhbHVlOwogICAgICAgICAgaWYgKGxhc3RGdWxseU9ic2VydmVkQ29udGV4dCA9PT0gY29udGV4dCkgOwogICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHZhciBjb250ZXh0SXRlbSA9IHsKICAgICAgICAgICAgICBjb250ZXh0LAogICAgICAgICAgICAgIG1lbW9pemVkVmFsdWU6IHZhbHVlLAogICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGxhc3RDb250ZXh0RGVwZW5kZW5jeSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChjdXJyZW50bHlSZW5kZXJpbmdGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDb250ZXh0IGNhbiBvbmx5IGJlIHJlYWQgd2hpbGUgUmVhY3QgaXMgcmVuZGVyaW5nLiBJbiBjbGFzc2VzLCB5b3UgY2FuIHJlYWQgaXQgaW4gdGhlIHJlbmRlciBtZXRob2Qgb3IgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBJbiBmdW5jdGlvbiBjb21wb25lbnRzLCB5b3UgY2FuIHJlYWQgaXQgZGlyZWN0bHkgaW4gdGhlIGZ1bmN0aW9uIGJvZHksIGJ1dCBub3QgaW5zaWRlIEhvb2tzIGxpa2UgdXNlUmVkdWNlcigpIG9yIHVzZU1lbW8oKS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGFzdENvbnRleHREZXBlbmRlbmN5ID0gY29udGV4dEl0ZW07CiAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIuZGVwZW5kZW5jaWVzID0gewogICAgICAgICAgICAgICAgbGFuZXM6IE5vTGFuZXMsCiAgICAgICAgICAgICAgICBmaXJzdENvbnRleHQ6IGNvbnRleHRJdGVtCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsYXN0Q29udGV4dERlcGVuZGVuY3kgPSBsYXN0Q29udGV4dERlcGVuZGVuY3kubmV4dCA9IGNvbnRleHRJdGVtOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHZhciBjb25jdXJyZW50UXVldWVzID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKSB7CiAgICAgICAgICBpZiAoY29uY3VycmVudFF1ZXVlcyA9PT0gbnVsbCkgewogICAgICAgICAgICBjb25jdXJyZW50UXVldWVzID0gW3F1ZXVlXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbmN1cnJlbnRRdWV1ZXMucHVzaChxdWV1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmlzaFF1ZXVlaW5nQ29uY3VycmVudFVwZGF0ZXMoKSB7CiAgICAgICAgICBpZiAoY29uY3VycmVudFF1ZXVlcyAhPT0gbnVsbCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbmN1cnJlbnRRdWV1ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIgcXVldWUgPSBjb25jdXJyZW50UXVldWVzW2ldOwogICAgICAgICAgICAgIHZhciBsYXN0SW50ZXJsZWF2ZWRVcGRhdGUgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgICAgICBpZiAobGFzdEludGVybGVhdmVkVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBxdWV1ZS5pbnRlcmxlYXZlZCA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgZmlyc3RJbnRlcmxlYXZlZFVwZGF0ZSA9IGxhc3RJbnRlcmxlYXZlZFVwZGF0ZS5uZXh0OwogICAgICAgICAgICAgICAgdmFyIGxhc3RQZW5kaW5nVXBkYXRlID0gcXVldWUucGVuZGluZzsKICAgICAgICAgICAgICAgIGlmIChsYXN0UGVuZGluZ1VwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgZmlyc3RQZW5kaW5nVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGUubmV4dDsKICAgICAgICAgICAgICAgICAgbGFzdFBlbmRpbmdVcGRhdGUubmV4dCA9IGZpcnN0SW50ZXJsZWF2ZWRVcGRhdGU7CiAgICAgICAgICAgICAgICAgIGxhc3RJbnRlcmxlYXZlZFVwZGF0ZS5uZXh0ID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcXVldWUucGVuZGluZyA9IGxhc3RJbnRlcmxlYXZlZFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uY3VycmVudFF1ZXVlcyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZShmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSkgewogICAgICAgICAgdmFyIGludGVybGVhdmVkID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICBpZiAoaW50ZXJsZWF2ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICBpbnRlcmxlYXZlZC5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUuaW50ZXJsZWF2ZWQgPSB1cGRhdGU7CiAgICAgICAgICByZXR1cm4gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGVBbmRFYWdlcmx5QmFpbG91dChmaWJlciwgcXVldWUsIHVwZGF0ZSwgbGFuZSkgewogICAgICAgICAgdmFyIGludGVybGVhdmVkID0gcXVldWUuaW50ZXJsZWF2ZWQ7CiAgICAgICAgICBpZiAoaW50ZXJsZWF2ZWQgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIHB1c2hDb25jdXJyZW50VXBkYXRlUXVldWUocXVldWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICBpbnRlcmxlYXZlZC5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUuaW50ZXJsZWF2ZWQgPSB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVDb25jdXJyZW50Q2xhc3NVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpIHsKICAgICAgICAgIHZhciBpbnRlcmxlYXZlZCA9IHF1ZXVlLmludGVybGVhdmVkOwogICAgICAgICAgaWYgKGludGVybGVhdmVkID09PSBudWxsKSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgICBwdXNoQ29uY3VycmVudFVwZGF0ZVF1ZXVlKHF1ZXVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZGF0ZS5uZXh0ID0gaW50ZXJsZWF2ZWQubmV4dDsKICAgICAgICAgICAgaW50ZXJsZWF2ZWQubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHF1ZXVlLmludGVybGVhdmVkID0gdXBkYXRlOwogICAgICAgICAgcmV0dXJuIG1hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290KGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBsYW5lKSB7CiAgICAgICAgICByZXR1cm4gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3QoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICB2YXIgdW5zYWZlX21hcmtVcGRhdGVMYW5lRnJvbUZpYmVyVG9Sb290ID0gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3Q7CiAgICAgICAgZnVuY3Rpb24gbWFya1VwZGF0ZUxhbmVGcm9tRmliZXJUb1Jvb3Qoc291cmNlRmliZXIsIGxhbmUpIHsKICAgICAgICAgIHNvdXJjZUZpYmVyLmxhbmVzID0gbWVyZ2VMYW5lcyhzb3VyY2VGaWJlci5sYW5lcywgbGFuZSk7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gc291cmNlRmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBhbHRlcm5hdGUubGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5sYW5lcywgbGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChhbHRlcm5hdGUgPT09IG51bGwgJiYgKHNvdXJjZUZpYmVyLmZsYWdzICYgKFBsYWNlbWVudCB8IEh5ZHJhdGluZykpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgd2FybkFib3V0VXBkYXRlT25Ob3RZZXRNb3VudGVkRmliZXJJbkRFVihzb3VyY2VGaWJlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBub2RlID0gc291cmNlRmliZXI7CiAgICAgICAgICB2YXIgcGFyZW50ID0gc291cmNlRmliZXIucmV0dXJuOwogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBwYXJlbnQuY2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMocGFyZW50LmNoaWxkTGFuZXMsIGxhbmUpOwogICAgICAgICAgICBhbHRlcm5hdGUgPSBwYXJlbnQuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgYWx0ZXJuYXRlLmNoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKGFsdGVybmF0ZS5jaGlsZExhbmVzLCBsYW5lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoKHBhcmVudC5mbGFncyAmIChQbGFjZW1lbnQgfCBIeWRyYXRpbmcpKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgICAgICB3YXJuQWJvdXRVcGRhdGVPbk5vdFlldE1vdW50ZWRGaWJlckluREVWKHNvdXJjZUZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZSA9IHBhcmVudDsKICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgdmFyIHJvb3QzID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgIHJldHVybiByb290MzsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgVXBkYXRlU3RhdGUgPSAwOwogICAgICAgIHZhciBSZXBsYWNlU3RhdGUgPSAxOwogICAgICAgIHZhciBGb3JjZVVwZGF0ZSA9IDI7CiAgICAgICAgdmFyIENhcHR1cmVVcGRhdGUgPSAzOwogICAgICAgIHZhciBoYXNGb3JjZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuVXBkYXRlSW5zaWRlVXBkYXRlOwogICAgICAgIHZhciBjdXJyZW50bHlQcm9jZXNzaW5nUXVldWU7CiAgICAgICAgewogICAgICAgICAgZGlkV2FyblVwZGF0ZUluc2lkZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgY3VycmVudGx5UHJvY2Vzc2luZ1F1ZXVlID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdGlhbGl6ZVVwZGF0ZVF1ZXVlKGZpYmVyKSB7CiAgICAgICAgICB2YXIgcXVldWUgPSB7CiAgICAgICAgICAgIGJhc2VTdGF0ZTogZmliZXIubWVtb2l6ZWRTdGF0ZSwKICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlOiBudWxsLAogICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZTogbnVsbCwKICAgICAgICAgICAgc2hhcmVkOiB7CiAgICAgICAgICAgICAgcGVuZGluZzogbnVsbCwKICAgICAgICAgICAgICBpbnRlcmxlYXZlZDogbnVsbCwKICAgICAgICAgICAgICBsYW5lczogTm9MYW5lcwogICAgICAgICAgICB9LAogICAgICAgICAgICBlZmZlY3RzOiBudWxsCiAgICAgICAgICB9OwogICAgICAgICAgZmliZXIudXBkYXRlUXVldWUgPSBxdWV1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2xvbmVVcGRhdGVRdWV1ZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB2YXIgcXVldWUgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgY3VycmVudFF1ZXVlID0gY3VycmVudDQudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAocXVldWUgPT09IGN1cnJlbnRRdWV1ZSkgewogICAgICAgICAgICB2YXIgY2xvbmUgPSB7CiAgICAgICAgICAgICAgYmFzZVN0YXRlOiBjdXJyZW50UXVldWUuYmFzZVN0YXRlLAogICAgICAgICAgICAgIGZpcnN0QmFzZVVwZGF0ZTogY3VycmVudFF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSwKICAgICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZTogY3VycmVudFF1ZXVlLmxhc3RCYXNlVXBkYXRlLAogICAgICAgICAgICAgIHNoYXJlZDogY3VycmVudFF1ZXVlLnNoYXJlZCwKICAgICAgICAgICAgICBlZmZlY3RzOiBjdXJyZW50UXVldWUuZWZmZWN0cwogICAgICAgICAgICB9OwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjbG9uZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlVXBkYXRlKGV2ZW50VGltZSwgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgZXZlbnRUaW1lLAogICAgICAgICAgICBsYW5lLAogICAgICAgICAgICB0YWc6IFVwZGF0ZVN0YXRlLAogICAgICAgICAgICBwYXlsb2FkOiBudWxsLAogICAgICAgICAgICBjYWxsYmFjazogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZmliZXIudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAodXBkYXRlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hhcmVkUXVldWUgPSB1cGRhdGVRdWV1ZS5zaGFyZWQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50bHlQcm9jZXNzaW5nUXVldWUgPT09IHNoYXJlZFF1ZXVlICYmICFkaWRXYXJuVXBkYXRlSW5zaWRlVXBkYXRlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkFuIHVwZGF0ZSAoc2V0U3RhdGUsIHJlcGxhY2VTdGF0ZSwgb3IgZm9yY2VVcGRhdGUpIHdhcyBzY2hlZHVsZWQgZnJvbSBpbnNpZGUgYW4gdXBkYXRlIGZ1bmN0aW9uLiBVcGRhdGUgZnVuY3Rpb25zIHNob3VsZCBiZSBwdXJlLCB3aXRoIHplcm8gc2lkZS1lZmZlY3RzLiBDb25zaWRlciB1c2luZyBjb21wb25lbnREaWRVcGRhdGUgb3IgYSBjYWxsYmFjay4iKTsKICAgICAgICAgICAgICBkaWRXYXJuVXBkYXRlSW5zaWRlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzVW5zYWZlQ2xhc3NSZW5kZXJQaGFzZVVwZGF0ZSgpKSB7CiAgICAgICAgICAgIHZhciBwZW5kaW5nID0gc2hhcmVkUXVldWUucGVuZGluZzsKICAgICAgICAgICAgaWYgKHBlbmRpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHVwZGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB1cGRhdGUubmV4dCA9IHBlbmRpbmcubmV4dDsKICAgICAgICAgICAgICBwZW5kaW5nLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2hhcmVkUXVldWUucGVuZGluZyA9IHVwZGF0ZTsKICAgICAgICAgICAgcmV0dXJuIHVuc2FmZV9tYXJrVXBkYXRlTGFuZUZyb21GaWJlclRvUm9vdChmaWJlciwgbGFuZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZW5xdWV1ZUNvbmN1cnJlbnRDbGFzc1VwZGF0ZShmaWJlciwgc2hhcmVkUXVldWUsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGZpYmVyLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaWJlci51cGRhdGVRdWV1ZTsKICAgICAgICAgIGlmICh1cGRhdGVRdWV1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hhcmVkUXVldWUgPSB1cGRhdGVRdWV1ZS5zaGFyZWQ7CiAgICAgICAgICBpZiAoaXNUcmFuc2l0aW9uTGFuZShsYW5lKSkgewogICAgICAgICAgICB2YXIgcXVldWVMYW5lcyA9IHNoYXJlZFF1ZXVlLmxhbmVzOwogICAgICAgICAgICBxdWV1ZUxhbmVzID0gaW50ZXJzZWN0TGFuZXMocXVldWVMYW5lcywgcm9vdDMucGVuZGluZ0xhbmVzKTsKICAgICAgICAgICAgdmFyIG5ld1F1ZXVlTGFuZXMgPSBtZXJnZUxhbmVzKHF1ZXVlTGFuZXMsIGxhbmUpOwogICAgICAgICAgICBzaGFyZWRRdWV1ZS5sYW5lcyA9IG5ld1F1ZXVlTGFuZXM7CiAgICAgICAgICAgIG1hcmtSb290RW50YW5nbGVkKHJvb3QzLCBuZXdRdWV1ZUxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZUNhcHR1cmVkVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY2FwdHVyZWRVcGRhdGUpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICBpZiAocXVldWUgPT09IGN1cnJlbnRRdWV1ZSkgewogICAgICAgICAgICAgIHZhciBuZXdGaXJzdCA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIG5ld0xhc3QgPSBudWxsOwogICAgICAgICAgICAgIHZhciBmaXJzdEJhc2VVcGRhdGUgPSBxdWV1ZS5maXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgICAgaWYgKGZpcnN0QmFzZVVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGZpcnN0QmFzZVVwZGF0ZTsKICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgdmFyIGNsb25lID0gewogICAgICAgICAgICAgICAgICAgIGV2ZW50VGltZTogdXBkYXRlLmV2ZW50VGltZSwKICAgICAgICAgICAgICAgICAgICBsYW5lOiB1cGRhdGUubGFuZSwKICAgICAgICAgICAgICAgICAgICB0YWc6IHVwZGF0ZS50YWcsCiAgICAgICAgICAgICAgICAgICAgcGF5bG9hZDogdXBkYXRlLnBheWxvYWQsCiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2s6IHVwZGF0ZS5jYWxsYmFjaywKICAgICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIGlmIChuZXdMYXN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbmV3Rmlyc3QgPSBuZXdMYXN0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmV3TGFzdC5uZXh0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgICAgbmV3TGFzdCA9IGNsb25lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHVwZGF0ZSA9IHVwZGF0ZS5uZXh0OwogICAgICAgICAgICAgICAgfSB3aGlsZSAodXBkYXRlICE9PSBudWxsKTsKICAgICAgICAgICAgICAgIGlmIChuZXdMYXN0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5ld0ZpcnN0ID0gbmV3TGFzdCA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbmV3TGFzdC5uZXh0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICAgICAgICAgIG5ld0xhc3QgPSBjYXB0dXJlZFVwZGF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV3Rmlyc3QgPSBuZXdMYXN0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHF1ZXVlID0gewogICAgICAgICAgICAgICAgYmFzZVN0YXRlOiBjdXJyZW50UXVldWUuYmFzZVN0YXRlLAogICAgICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlOiBuZXdGaXJzdCwKICAgICAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlOiBuZXdMYXN0LAogICAgICAgICAgICAgICAgc2hhcmVkOiBjdXJyZW50UXVldWUuc2hhcmVkLAogICAgICAgICAgICAgICAgZWZmZWN0czogY3VycmVudFF1ZXVlLmVmZmVjdHMKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IHF1ZXVlOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhc3RCYXNlVXBkYXRlID0gcXVldWUubGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICBpZiAobGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUuZmlyc3RCYXNlVXBkYXRlID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsYXN0QmFzZVVwZGF0ZS5uZXh0ID0gY2FwdHVyZWRVcGRhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBxdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IGNhcHR1cmVkVXBkYXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTdGF0ZUZyb21VcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBxdWV1ZSwgdXBkYXRlLCBwcmV2U3RhdGUsIG5leHRQcm9wcywgaW5zdGFuY2UpIHsKICAgICAgICAgIHN3aXRjaCAodXBkYXRlLnRhZykgewogICAgICAgICAgICBjYXNlIFJlcGxhY2VTdGF0ZTogewogICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gdXBkYXRlLnBheWxvYWQ7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXlsb2FkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGVudGVyRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSBwYXlsb2FkLmNhbGwoaW5zdGFuY2UsIHByZXZTdGF0ZSwgbmV4dFByb3BzKTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBwYXlsb2FkLmNhbGwoaW5zdGFuY2UsIHByZXZTdGF0ZSwgbmV4dFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBleGl0RGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBuZXh0U3RhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBwYXlsb2FkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2FwdHVyZVVwZGF0ZTogewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IHdvcmtJblByb2dyZXNzMi5mbGFncyAmIH5TaG91bGRDYXB0dXJlIHwgRGlkQ2FwdHVyZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFVwZGF0ZVN0YXRlOiB7CiAgICAgICAgICAgICAgdmFyIF9wYXlsb2FkID0gdXBkYXRlLnBheWxvYWQ7CiAgICAgICAgICAgICAgdmFyIHBhcnRpYWxTdGF0ZTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIF9wYXlsb2FkID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGVudGVyRGlzYWxsb3dlZENvbnRleHRSZWFkSW5ERVYoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBhcnRpYWxTdGF0ZSA9IF9wYXlsb2FkLmNhbGwoaW5zdGFuY2UsIHByZXZTdGF0ZSwgbmV4dFByb3BzKTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBfcGF5bG9hZC5jYWxsKGluc3RhbmNlLCBwcmV2U3RhdGUsIG5leHRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgZXhpdERpc2FsbG93ZWRDb250ZXh0UmVhZEluREVWKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBhcnRpYWxTdGF0ZSA9IF9wYXlsb2FkOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocGFydGlhbFN0YXRlID09PSBudWxsIHx8IHBhcnRpYWxTdGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJldlN0YXRlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gYXNzaWduMih7fSwgcHJldlN0YXRlLCBwYXJ0aWFsU3RhdGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRm9yY2VVcGRhdGU6IHsKICAgICAgICAgICAgICBoYXNGb3JjZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgcHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBxdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgIGhhc0ZvcmNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9IHF1ZXVlLnNoYXJlZDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaXJzdEJhc2VVcGRhdGUgPSBxdWV1ZS5maXJzdEJhc2VVcGRhdGU7CiAgICAgICAgICB2YXIgbGFzdEJhc2VVcGRhdGUgPSBxdWV1ZS5sYXN0QmFzZVVwZGF0ZTsKICAgICAgICAgIHZhciBwZW5kaW5nUXVldWUgPSBxdWV1ZS5zaGFyZWQucGVuZGluZzsKICAgICAgICAgIGlmIChwZW5kaW5nUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgcXVldWUuc2hhcmVkLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICB2YXIgbGFzdFBlbmRpbmdVcGRhdGUgPSBwZW5kaW5nUXVldWU7CiAgICAgICAgICAgIHZhciBmaXJzdFBlbmRpbmdVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0OwogICAgICAgICAgICBsYXN0UGVuZGluZ1VwZGF0ZS5uZXh0ID0gbnVsbDsKICAgICAgICAgICAgaWYgKGxhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RCYXNlVXBkYXRlID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGxhc3RCYXNlVXBkYXRlLm5leHQgPSBmaXJzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGFzdEJhc2VVcGRhdGUgPSBsYXN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gd29ya0luUHJvZ3Jlc3MyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnRRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgIHZhciBjdXJyZW50TGFzdEJhc2VVcGRhdGUgPSBjdXJyZW50UXVldWUubGFzdEJhc2VVcGRhdGU7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRMYXN0QmFzZVVwZGF0ZSAhPT0gbGFzdEJhc2VVcGRhdGUpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50TGFzdEJhc2VVcGRhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudFF1ZXVlLmZpcnN0QmFzZVVwZGF0ZSA9IGZpcnN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGN1cnJlbnRMYXN0QmFzZVVwZGF0ZS5uZXh0ID0gZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudFF1ZXVlLmxhc3RCYXNlVXBkYXRlID0gbGFzdFBlbmRpbmdVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmlyc3RCYXNlVXBkYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IHF1ZXVlLmJhc2VTdGF0ZTsKICAgICAgICAgICAgdmFyIG5ld0xhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgdmFyIG5ld0Jhc2VTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciBuZXdGaXJzdEJhc2VVcGRhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgbmV3TGFzdEJhc2VVcGRhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgdXBkYXRlID0gZmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIHVwZGF0ZUxhbmUgPSB1cGRhdGUubGFuZTsKICAgICAgICAgICAgICB2YXIgdXBkYXRlRXZlbnRUaW1lID0gdXBkYXRlLmV2ZW50VGltZTsKICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhyZW5kZXJMYW5lczIsIHVwZGF0ZUxhbmUpKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgIGV2ZW50VGltZTogdXBkYXRlRXZlbnRUaW1lLAogICAgICAgICAgICAgICAgICBsYW5lOiB1cGRhdGVMYW5lLAogICAgICAgICAgICAgICAgICB0YWc6IHVwZGF0ZS50YWcsCiAgICAgICAgICAgICAgICAgIHBheWxvYWQ6IHVwZGF0ZS5wYXlsb2FkLAogICAgICAgICAgICAgICAgICBjYWxsYmFjazogdXBkYXRlLmNhbGxiYWNrLAogICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaWYgKG5ld0xhc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG5ld0ZpcnN0QmFzZVVwZGF0ZSA9IG5ld0xhc3RCYXNlVXBkYXRlID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbmV3TGFzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZS5uZXh0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBuZXdMYW5lcyA9IG1lcmdlTGFuZXMobmV3TGFuZXMsIHVwZGF0ZUxhbmUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAobmV3TGFzdEJhc2VVcGRhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9jbG9uZSA9IHsKICAgICAgICAgICAgICAgICAgICBldmVudFRpbWU6IHVwZGF0ZUV2ZW50VGltZSwKICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIHVwZGF0ZSBpcyBnb2luZyB0byBiZSBjb21taXR0ZWQgc28gd2UgbmV2ZXIgd2FudCB1bmNvbW1pdAogICAgICAgICAgICAgICAgICAgIC8vIGl0LiBVc2luZyBOb0xhbmUgd29ya3MgYmVjYXVzZSAwIGlzIGEgc3Vic2V0IG9mIGFsbCBiaXRtYXNrcywgc28KICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHdpbGwgbmV2ZXIgYmUgc2tpcHBlZCBieSB0aGUgY2hlY2sgYWJvdmUuCiAgICAgICAgICAgICAgICAgICAgbGFuZTogTm9MYW5lLAogICAgICAgICAgICAgICAgICAgIHRhZzogdXBkYXRlLnRhZywKICAgICAgICAgICAgICAgICAgICBwYXlsb2FkOiB1cGRhdGUucGF5bG9hZCwKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjazogdXBkYXRlLmNhbGxiYWNrLAogICAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgbmV3TGFzdEJhc2VVcGRhdGUgPSBuZXdMYXN0QmFzZVVwZGF0ZS5uZXh0ID0gX2Nsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbmV3U3RhdGUgPSBnZXRTdGF0ZUZyb21VcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBxdWV1ZSwgdXBkYXRlLCBuZXdTdGF0ZSwgcHJvcHMsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHVwZGF0ZS5jYWxsYmFjazsKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCAmJiAvLyBJZiB0aGUgdXBkYXRlIHdhcyBhbHJlYWR5IGNvbW1pdHRlZCwgd2Ugc2hvdWxkIG5vdCBxdWV1ZSBpdHMKICAgICAgICAgICAgICAgIC8vIGNhbGxiYWNrIGFnYWluLgogICAgICAgICAgICAgICAgdXBkYXRlLmxhbmUgIT09IE5vTGFuZSkgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ2FsbGJhY2s7CiAgICAgICAgICAgICAgICAgIHZhciBlZmZlY3RzID0gcXVldWUuZWZmZWN0czsKICAgICAgICAgICAgICAgICAgaWYgKGVmZmVjdHMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBxdWV1ZS5lZmZlY3RzID0gW3VwZGF0ZV07CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0cy5wdXNoKHVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgICAgaWYgKHVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcGVuZGluZ1F1ZXVlID0gcXVldWUuc2hhcmVkLnBlbmRpbmc7CiAgICAgICAgICAgICAgICBpZiAocGVuZGluZ1F1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIF9sYXN0UGVuZGluZ1VwZGF0ZSA9IHBlbmRpbmdRdWV1ZTsKICAgICAgICAgICAgICAgICAgdmFyIF9maXJzdFBlbmRpbmdVcGRhdGUgPSBfbGFzdFBlbmRpbmdVcGRhdGUubmV4dDsKICAgICAgICAgICAgICAgICAgX2xhc3RQZW5kaW5nVXBkYXRlLm5leHQgPSBudWxsOwogICAgICAgICAgICAgICAgICB1cGRhdGUgPSBfZmlyc3RQZW5kaW5nVXBkYXRlOwogICAgICAgICAgICAgICAgICBxdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IF9sYXN0UGVuZGluZ1VwZGF0ZTsKICAgICAgICAgICAgICAgICAgcXVldWUuc2hhcmVkLnBlbmRpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICAgIGlmIChuZXdMYXN0QmFzZVVwZGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHF1ZXVlLmJhc2VTdGF0ZSA9IG5ld0Jhc2VTdGF0ZTsKICAgICAgICAgICAgcXVldWUuZmlyc3RCYXNlVXBkYXRlID0gbmV3Rmlyc3RCYXNlVXBkYXRlOwogICAgICAgICAgICBxdWV1ZS5sYXN0QmFzZVVwZGF0ZSA9IG5ld0xhc3RCYXNlVXBkYXRlOwogICAgICAgICAgICB2YXIgbGFzdEludGVybGVhdmVkID0gcXVldWUuc2hhcmVkLmludGVybGVhdmVkOwogICAgICAgICAgICBpZiAobGFzdEludGVybGVhdmVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGludGVybGVhdmVkID0gbGFzdEludGVybGVhdmVkOwogICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIG5ld0xhbmVzID0gbWVyZ2VMYW5lcyhuZXdMYW5lcywgaW50ZXJsZWF2ZWQubGFuZSk7CiAgICAgICAgICAgICAgICBpbnRlcmxlYXZlZCA9IGludGVybGVhdmVkLm5leHQ7CiAgICAgICAgICAgICAgfSB3aGlsZSAoaW50ZXJsZWF2ZWQgIT09IGxhc3RJbnRlcmxlYXZlZCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmlyc3RCYXNlVXBkYXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcXVldWUuc2hhcmVkLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKG5ld0xhbmVzKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbmV3TGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRseVByb2Nlc3NpbmdRdWV1ZSA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNhbGxDYWxsYmFjayhjYWxsYmFjaywgY29udGV4dCkgewogICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgYXJndW1lbnQgcGFzc2VkIGFzIGNhbGxiYWNrLiBFeHBlY3RlZCBhIGZ1bmN0aW9uLiBJbnN0ZWFkICIgKyAoInJlY2VpdmVkOiAiICsgY2FsbGJhY2spKTsKICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrLmNhbGwoY29udGV4dCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc2V0SGFzRm9yY2VVcGRhdGVCZWZvcmVQcm9jZXNzaW5nKCkgewogICAgICAgICAgaGFzRm9yY2VVcGRhdGUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHsKICAgICAgICAgIHJldHVybiBoYXNGb3JjZVVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0VXBkYXRlUXVldWUoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFF1ZXVlLCBpbnN0YW5jZSkgewogICAgICAgICAgdmFyIGVmZmVjdHMgPSBmaW5pc2hlZFF1ZXVlLmVmZmVjdHM7CiAgICAgICAgICBmaW5pc2hlZFF1ZXVlLmVmZmVjdHMgPSBudWxsOwogICAgICAgICAgaWYgKGVmZmVjdHMgIT09IG51bGwpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlZmZlY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGVmZmVjdHNbaV07CiAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gZWZmZWN0LmNhbGxiYWNrOwogICAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZWZmZWN0LmNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgICAgIGNhbGxDYWxsYmFjayhjYWxsYmFjaywgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgTk9fQ09OVEVYVCA9IHt9OwogICAgICAgIHZhciBjb250ZXh0U3RhY2tDdXJzb3IkMSA9IGNyZWF0ZUN1cnNvcihOT19DT05URVhUKTsKICAgICAgICB2YXIgY29udGV4dEZpYmVyU3RhY2tDdXJzb3IgPSBjcmVhdGVDdXJzb3IoTk9fQ09OVEVYVCk7CiAgICAgICAgdmFyIHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKE5PX0NPTlRFWFQpOwogICAgICAgIGZ1bmN0aW9uIHJlcXVpcmVkQ29udGV4dChjKSB7CiAgICAgICAgICBpZiAoYyA9PT0gTk9fQ09OVEVYVCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGhvc3QgY29udGV4dCB0byBleGlzdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSb290SG9zdENvbnRhaW5lcigpIHsKICAgICAgICAgIHZhciByb290SW5zdGFuY2UgPSByZXF1aXJlZENvbnRleHQocm9vdEluc3RhbmNlU3RhY2tDdXJzb3IuY3VycmVudCk7CiAgICAgICAgICByZXR1cm4gcm9vdEluc3RhbmNlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoSG9zdENvbnRhaW5lcihmaWJlciwgbmV4dFJvb3RJbnN0YW5jZSkgewogICAgICAgICAgcHVzaChyb290SW5zdGFuY2VTdGFja0N1cnNvciwgbmV4dFJvb3RJbnN0YW5jZSwgZmliZXIpOwogICAgICAgICAgcHVzaChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yJDEsIE5PX0NPTlRFWFQsIGZpYmVyKTsKICAgICAgICAgIHZhciBuZXh0Um9vdENvbnRleHQgPSBnZXRSb290SG9zdENvbnRleHQobmV4dFJvb3RJbnN0YW5jZSk7CiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yJDEsIGZpYmVyKTsKICAgICAgICAgIHB1c2goY29udGV4dFN0YWNrQ3Vyc29yJDEsIG5leHRSb290Q29udGV4dCwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BIb3N0Q29udGFpbmVyKGZpYmVyKSB7CiAgICAgICAgICBwb3AoY29udGV4dFN0YWNrQ3Vyc29yJDEsIGZpYmVyKTsKICAgICAgICAgIHBvcChjb250ZXh0RmliZXJTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgICAgcG9wKHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldEhvc3RDb250ZXh0KCkgewogICAgICAgICAgdmFyIGNvbnRleHQgPSByZXF1aXJlZENvbnRleHQoY29udGV4dFN0YWNrQ3Vyc29yJDEuY3VycmVudCk7CiAgICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEhvc3RDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICB2YXIgcm9vdEluc3RhbmNlID0gcmVxdWlyZWRDb250ZXh0KHJvb3RJbnN0YW5jZVN0YWNrQ3Vyc29yLmN1cnJlbnQpOwogICAgICAgICAgdmFyIGNvbnRleHQgPSByZXF1aXJlZENvbnRleHQoY29udGV4dFN0YWNrQ3Vyc29yJDEuY3VycmVudCk7CiAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBnZXRDaGlsZEhvc3RDb250ZXh0KGNvbnRleHQsIGZpYmVyLnR5cGUpOwogICAgICAgICAgaWYgKGNvbnRleHQgPT09IG5leHRDb250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHB1c2goY29udGV4dEZpYmVyU3RhY2tDdXJzb3IsIGZpYmVyLCBmaWJlcik7CiAgICAgICAgICBwdXNoKGNvbnRleHRTdGFja0N1cnNvciQxLCBuZXh0Q29udGV4dCwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwb3BIb3N0Q29udGV4dChmaWJlcikgewogICAgICAgICAgaWYgKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLmN1cnJlbnQgIT09IGZpYmVyKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIHBvcChjb250ZXh0U3RhY2tDdXJzb3IkMSwgZmliZXIpOwogICAgICAgICAgcG9wKGNvbnRleHRGaWJlclN0YWNrQ3Vyc29yLCBmaWJlcik7CiAgICAgICAgfQogICAgICAgIHZhciBEZWZhdWx0U3VzcGVuc2VDb250ZXh0ID0gMDsKICAgICAgICB2YXIgU3VidHJlZVN1c3BlbnNlQ29udGV4dE1hc2sgPSAxOwogICAgICAgIHZhciBJbnZpc2libGVQYXJlbnRTdXNwZW5zZUNvbnRleHQgPSAxOwogICAgICAgIHZhciBGb3JjZVN1c3BlbnNlRmFsbGJhY2sgPSAyOwogICAgICAgIHZhciBzdXNwZW5zZVN0YWNrQ3Vyc29yID0gY3JlYXRlQ3Vyc29yKERlZmF1bHRTdXNwZW5zZUNvbnRleHQpOwogICAgICAgIGZ1bmN0aW9uIGhhc1N1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0LCBmbGFnKSB7CiAgICAgICAgICByZXR1cm4gKHBhcmVudENvbnRleHQgJiBmbGFnKSAhPT0gMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQocGFyZW50Q29udGV4dCkgewogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgJiBTdWJ0cmVlU3VzcGVuc2VDb250ZXh0TWFzazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChwYXJlbnRDb250ZXh0LCBzaGFsbG93Q29udGV4dCkgewogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQgJiBTdWJ0cmVlU3VzcGVuc2VDb250ZXh0TWFzayB8IHNoYWxsb3dDb250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZGRTdWJ0cmVlU3VzcGVuc2VDb250ZXh0KHBhcmVudENvbnRleHQsIHN1YnRyZWVDb250ZXh0KSB7CiAgICAgICAgICByZXR1cm4gcGFyZW50Q29udGV4dCB8IHN1YnRyZWVDb250ZXh0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoU3VzcGVuc2VDb250ZXh0KGZpYmVyLCBuZXdDb250ZXh0KSB7CiAgICAgICAgICBwdXNoKHN1c3BlbnNlU3RhY2tDdXJzb3IsIG5ld0NvbnRleHQsIGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wU3VzcGVuc2VDb250ZXh0KGZpYmVyKSB7CiAgICAgICAgICBwb3Aoc3VzcGVuc2VTdGFja0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzaG91bGRDYXB0dXJlU3VzcGVuc2Uod29ya0luUHJvZ3Jlc3MyLCBoYXNJbnZpc2libGVQYXJlbnQpIHsKICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChuZXh0U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5leHRTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kRmlyc3RTdXNwZW5kZWQocm93KSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHJvdzsKICAgICAgICAgIHdoaWxlIChub2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgc3RhdGUgPSBub2RlLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgZGVoeWRyYXRlZCA9IHN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgICBpZiAoZGVoeWRyYXRlZCA9PT0gbnVsbCB8fCBpc1N1c3BlbnNlSW5zdGFuY2VQZW5kaW5nKGRlaHlkcmF0ZWQpIHx8IGlzU3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrKGRlaHlkcmF0ZWQpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLnRhZyA9PT0gU3VzcGVuc2VMaXN0Q29tcG9uZW50ICYmIC8vIHJldmVhbE9yZGVyIHVuZGVmaW5lZCBjYW4ndCBiZSB0cnVzdGVkIGJlY2F1c2UgaXQgZG9uJ3QKICAgICAgICAgICAgLy8ga2VlcCB0cmFjayBvZiB3aGV0aGVyIGl0IHN1c3BlbmRlZCBvciBub3QuCiAgICAgICAgICAgIG5vZGUubWVtb2l6ZWRQcm9wcy5yZXZlYWxPcmRlciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmQgPSAobm9kZS5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICAgIGlmIChkaWRTdXNwZW5kKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZSA9PT0gcm93KSB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLnJldHVybiA9PT0gbnVsbCB8fCBub2RlLnJldHVybiA9PT0gcm93KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgTm9GbGFncyQxID0gKAogICAgICAgICAgLyogICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIEhhc0VmZmVjdCA9ICgKICAgICAgICAgIC8qICovCiAgICAgICAgICAxCiAgICAgICAgKTsKICAgICAgICB2YXIgSW5zZXJ0aW9uID0gKAogICAgICAgICAgLyogICovCiAgICAgICAgICAyCiAgICAgICAgKTsKICAgICAgICB2YXIgTGF5b3V0ID0gKAogICAgICAgICAgLyogICAgKi8KICAgICAgICAgIDQKICAgICAgICApOwogICAgICAgIHZhciBQYXNzaXZlJDEgPSAoCiAgICAgICAgICAvKiAgICovCiAgICAgICAgICA4CiAgICAgICAgKTsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NTb3VyY2VzID0gW107CiAgICAgICAgZnVuY3Rpb24gcmVzZXRXb3JrSW5Qcm9ncmVzc1ZlcnNpb25zKCkgewogICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB3b3JrSW5Qcm9ncmVzc1NvdXJjZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdmFyIG11dGFibGVTb3VyY2UgPSB3b3JrSW5Qcm9ncmVzc1NvdXJjZXNbaV07CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtdXRhYmxlU291cmNlLl93b3JrSW5Qcm9ncmVzc1ZlcnNpb25QcmltYXJ5ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3NTb3VyY2VzLmxlbmd0aCA9IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlZ2lzdGVyTXV0YWJsZVNvdXJjZUZvckh5ZHJhdGlvbihyb290MywgbXV0YWJsZVNvdXJjZSkgewogICAgICAgICAgdmFyIGdldFZlcnNpb24gPSBtdXRhYmxlU291cmNlLl9nZXRWZXJzaW9uOwogICAgICAgICAgdmFyIHZlcnNpb242ID0gZ2V0VmVyc2lvbihtdXRhYmxlU291cmNlLl9zb3VyY2UpOwogICAgICAgICAgaWYgKHJvb3QzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEgPT0gbnVsbCkgewogICAgICAgICAgICByb290My5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhID0gW211dGFibGVTb3VyY2UsIHZlcnNpb242XTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJvb3QzLm11dGFibGVTb3VyY2VFYWdlckh5ZHJhdGlvbkRhdGEucHVzaChtdXRhYmxlU291cmNlLCB2ZXJzaW9uNik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyLCBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QmF0Y2hDb25maWc7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3Q7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgdmFyIHJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSA9IG51bGw7CiAgICAgICAgdmFyIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NIb29rID0gbnVsbDsKICAgICAgICB2YXIgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MgPSBmYWxzZTsKICAgICAgICB2YXIgbG9jYWxJZENvdW50ZXIgPSAwOwogICAgICAgIHZhciBnbG9iYWxDbGllbnRJZENvdW50ZXIgPSAwOwogICAgICAgIHZhciBSRV9SRU5ERVJfTElNSVQgPSAyNTsKICAgICAgICB2YXIgY3VycmVudEhvb2tOYW1lSW5EZXYgPSBudWxsOwogICAgICAgIHZhciBob29rVHlwZXNEZXYgPSBudWxsOwogICAgICAgIHZhciBob29rVHlwZXNVcGRhdGVJbmRleERldiA9IC0xOwogICAgICAgIHZhciBpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcyA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIG1vdW50SG9va1R5cGVzRGV2KCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaG9va05hbWUgPSBjdXJyZW50SG9va05hbWVJbkRldjsKICAgICAgICAgICAgaWYgKGhvb2tUeXBlc0RldiA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IFtob29rTmFtZV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaG9va1R5cGVzRGV2LnB1c2goaG9va05hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvb2tUeXBlc0RldigpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhvb2tOYW1lID0gY3VycmVudEhvb2tOYW1lSW5EZXY7CiAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBob29rVHlwZXNVcGRhdGVJbmRleERldisrOwogICAgICAgICAgICAgIGlmIChob29rVHlwZXNEZXZbaG9va1R5cGVzVXBkYXRlSW5kZXhEZXZdICE9PSBob29rTmFtZSkgewogICAgICAgICAgICAgICAgd2Fybk9uSG9va01pc21hdGNoSW5EZXYoaG9va05hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkZXBzICE9PSB2b2lkIDAgJiYgZGVwcyAhPT0gbnVsbCAmJiAhaXNBcnJheTIoZGVwcykpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgcmVjZWl2ZWQgYSBmaW5hbCBhcmd1bWVudCB0aGF0IGlzIG5vdCBhbiBhcnJheSAoaW5zdGVhZCwgcmVjZWl2ZWQgYCVzYCkuIFdoZW4gc3BlY2lmaWVkLCB0aGUgZmluYWwgYXJndW1lbnQgbXVzdCBiZSBhbiBhcnJheS4iLCBjdXJyZW50SG9va05hbWVJbkRldiwgdHlwZW9mIGRlcHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5Pbkhvb2tNaXNtYXRjaEluRGV2KGN1cnJlbnRIb29rTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMSk7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TWlzbWF0Y2hlZEhvb2tzRm9yQ29tcG9uZW50Lmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1pc21hdGNoZWRIb29rc0ZvckNvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgaWYgKGhvb2tUeXBlc0RldiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHRhYmxlID0gIiI7CiAgICAgICAgICAgICAgICB2YXIgc2Vjb25kQ29sdW1uU3RhcnQgPSAzMDsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2OyBpKyspIHsKICAgICAgICAgICAgICAgICAgdmFyIG9sZEhvb2tOYW1lID0gaG9va1R5cGVzRGV2W2ldOwogICAgICAgICAgICAgICAgICB2YXIgbmV3SG9va05hbWUgPSBpID09PSBob29rVHlwZXNVcGRhdGVJbmRleERldiA/IGN1cnJlbnRIb29rTmFtZSA6IG9sZEhvb2tOYW1lOwogICAgICAgICAgICAgICAgICB2YXIgcm93ID0gaSArIDEgKyAiLiAiICsgb2xkSG9va05hbWU7CiAgICAgICAgICAgICAgICAgIHdoaWxlIChyb3cubGVuZ3RoIDwgc2Vjb25kQ29sdW1uU3RhcnQpIHsKICAgICAgICAgICAgICAgICAgICByb3cgKz0gIiAiOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJvdyArPSBuZXdIb29rTmFtZSArICJcbiI7CiAgICAgICAgICAgICAgICAgIHRhYmxlICs9IHJvdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVycm9yKCJSZWFjdCBoYXMgZGV0ZWN0ZWQgYSBjaGFuZ2UgaW4gdGhlIG9yZGVyIG9mIEhvb2tzIGNhbGxlZCBieSAlcy4gVGhpcyB3aWxsIGxlYWQgdG8gYnVncyBhbmQgZXJyb3JzIGlmIG5vdCBmaXhlZC4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHJlYWQgdGhlIFJ1bGVzIG9mIEhvb2tzOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcnVsZXMtb2YtaG9va3NcblxuICAgUHJldmlvdXMgcmVuZGVyICAgICAgICAgICAgTmV4dCByZW5kZXJcbiAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuJXMgICBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5cbiIsIGNvbXBvbmVudE5hbWUsIHRhYmxlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdGhyb3dJbnZhbGlkSG9va0Vycm9yKCkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGhvb2sgY2FsbC4gSG9va3MgY2FuIG9ubHkgYmUgY2FsbGVkIGluc2lkZSBvZiB0aGUgYm9keSBvZiBhIGZ1bmN0aW9uIGNvbXBvbmVudC4gVGhpcyBjb3VsZCBoYXBwZW4gZm9yIG9uZSBvZiB0aGUgZm9sbG93aW5nIHJlYXNvbnM6XG4xLiBZb3UgbWlnaHQgaGF2ZSBtaXNtYXRjaGluZyB2ZXJzaW9ucyBvZiBSZWFjdCBhbmQgdGhlIHJlbmRlcmVyIChzdWNoIGFzIFJlYWN0IERPTSlcbjIuIFlvdSBtaWdodCBiZSBicmVha2luZyB0aGUgUnVsZXMgb2YgSG9va3NcbjMuIFlvdSBtaWdodCBoYXZlIG1vcmUgdGhhbiBvbmUgY29weSBvZiBSZWFjdCBpbiB0aGUgc2FtZSBhcHBcblNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaW52YWxpZC1ob29rLWNhbGwgZm9yIHRpcHMgYWJvdXQgaG93IHRvIGRlYnVnIGFuZCBmaXggdGhpcyBwcm9ibGVtLiIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpZ25vcmVQcmV2aW91c0RlcGVuZGVuY2llcykgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByZXZEZXBzID09PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgcmVjZWl2ZWQgYSBmaW5hbCBhcmd1bWVudCBkdXJpbmcgdGhpcyByZW5kZXIsIGJ1dCBub3QgZHVyaW5nIHRoZSBwcmV2aW91cyByZW5kZXIuIEV2ZW4gdGhvdWdoIHRoZSBmaW5hbCBhcmd1bWVudCBpcyBvcHRpb25hbCwgaXRzIHR5cGUgY2Fubm90IGNoYW5nZSBiZXR3ZWVuIHJlbmRlcnMuIiwgY3VycmVudEhvb2tOYW1lSW5EZXYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5leHREZXBzLmxlbmd0aCAhPT0gcHJldkRlcHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBmaW5hbCBhcmd1bWVudCBwYXNzZWQgdG8gJXMgY2hhbmdlZCBzaXplIGJldHdlZW4gcmVuZGVycy4gVGhlIG9yZGVyIGFuZCBzaXplIG9mIHRoaXMgYXJyYXkgbXVzdCByZW1haW4gY29uc3RhbnQuXG5cblByZXZpb3VzOiAlc1xuSW5jb21pbmc6ICVzIiwgY3VycmVudEhvb2tOYW1lSW5EZXYsICJbIiArIHByZXZEZXBzLmpvaW4oIiwgIikgKyAiXSIsICJbIiArIG5leHREZXBzLmpvaW4oIiwgIikgKyAiXSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHByZXZEZXBzLmxlbmd0aCAmJiBpIDwgbmV4dERlcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgaWYgKG9iamVjdElzKG5leHREZXBzW2ldLCBwcmV2RGVwc1tpXSkpIHsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyV2l0aEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIHNlY29uZEFyZywgbmV4dFJlbmRlckxhbmVzKSB7CiAgICAgICAgICByZW5kZXJMYW5lcyA9IG5leHRSZW5kZXJMYW5lczsKICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICB7CiAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQuX2RlYnVnSG9va1R5cGVzIDogbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgaWdub3JlUHJldmlvdXNEZXBlbmRlbmNpZXMgPSBjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgY3VycmVudDQubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgfSBlbHNlIGlmIChob29rVHlwZXNEZXYgIT09IG51bGwpIHsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEhvb2tzRGlzcGF0Y2hlck9uTW91bnRXaXRoSG9va1R5cGVzSW5ERVY7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVY7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjaGlsZHJlbiA9IENvbXBvbmVudChwcm9wcywgc2Vjb25kQXJnKTsKICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlRHVyaW5nVGhpc1Bhc3MpIHsKICAgICAgICAgICAgdmFyIG51bWJlck9mUmVSZW5kZXJzID0gMDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGZhbHNlOwogICAgICAgICAgICAgIGxvY2FsSWRDb3VudGVyID0gMDsKICAgICAgICAgICAgICBpZiAobnVtYmVyT2ZSZVJlbmRlcnMgPj0gUkVfUkVOREVSX0xJTUlUKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRvbyBtYW55IHJlLXJlbmRlcnMuIFJlYWN0IGxpbWl0cyB0aGUgbnVtYmVyIG9mIHJlbmRlcnMgdG8gcHJldmVudCBhbiBpbmZpbml0ZSBsb29wLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBudW1iZXJPZlJlUmVuZGVycyArPSAxOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlnbm9yZVByZXZpb3VzRGVwZW5kZW5jaWVzID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSBudWxsOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgY2hpbGRyZW4gPSBDb21wb25lbnQocHJvcHMsIHNlY29uZEFyZyk7CiAgICAgICAgICAgIH0gd2hpbGUgKGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyk7CiAgICAgICAgICB9CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z0hvb2tUeXBlcyA9IGhvb2tUeXBlc0RldjsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkaWRSZW5kZXJUb29GZXdIb29rcyA9IGN1cnJlbnRIb29rICE9PSBudWxsICYmIGN1cnJlbnRIb29rLm5leHQgIT09IG51bGw7CiAgICAgICAgICByZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxID0gbnVsbDsKICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzRGV2ID0gbnVsbDsKICAgICAgICAgICAgaG9va1R5cGVzVXBkYXRlSW5kZXhEZXYgPSAtMTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmIChjdXJyZW50NC5mbGFncyAmIFN0YXRpY01hc2spICE9PSAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgU3RhdGljTWFzaykgJiYgLy8gRGlzYWJsZSB0aGlzIHdhcm5pbmcgaW4gbGVnYWN5IG1vZGUsIGJlY2F1c2UgbGVnYWN5IFN1c3BlbnNlIGlzIHdlaXJkCiAgICAgICAgICAgIC8vIGFuZCBjcmVhdGVzIGZhbHNlIHBvc2l0aXZlcy4gVG8gbWFrZSB0aGlzIHdvcmsgaW4gbGVnYWN5IG1vZGUsIHdlJ2QKICAgICAgICAgICAgLy8gbmVlZCB0byBtYXJrIGZpYmVycyB0aGF0IGNvbW1pdCBpbiBhbiBpbmNvbXBsZXRlIHN0YXRlLCBzb21laG93LiBGb3IKICAgICAgICAgICAgLy8gbm93IEknbGwgZGlzYWJsZSB0aGUgd2FybmluZyB0aGF0IG1vc3Qgb2YgdGhlIGJ1Z3MgdGhhdCB3b3VsZCB0cmlnZ2VyCiAgICAgICAgICAgIC8vIGl0IGFyZSBlaXRoZXIgZXhjbHVzaXZlIHRvIGNvbmN1cnJlbnQgbW9kZSBvciBleGlzdCBpbiBib3RoLgogICAgICAgICAgICAoY3VycmVudDQubW9kZSAmIENvbmN1cnJlbnRNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkludGVybmFsIFJlYWN0IGVycm9yOiBFeHBlY3RlZCBzdGF0aWMgZmxhZyB3YXMgbWlzc2luZy4gUGxlYXNlIG5vdGlmeSB0aGUgUmVhY3QgdGVhbS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgaWYgKGRpZFJlbmRlclRvb0Zld0hvb2tzKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUmVuZGVyZWQgZmV3ZXIgaG9va3MgdGhhbiBleHBlY3RlZC4gVGhpcyBtYXkgYmUgY2F1c2VkIGJ5IGFuIGFjY2lkZW50YWwgZWFybHkgcmV0dXJuIHN0YXRlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjaGlsZHJlbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2hlY2tEaWRSZW5kZXJJZEhvb2soKSB7CiAgICAgICAgICB2YXIgZGlkUmVuZGVySWRIb29rID0gbG9jYWxJZENvdW50ZXIgIT09IDA7CiAgICAgICAgICBsb2NhbElkQ291bnRlciA9IDA7CiAgICAgICAgICByZXR1cm4gZGlkUmVuZGVySWRIb29rOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBiYWlsb3V0SG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbGFuZXMpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IGN1cnJlbnQ0LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+KE1vdW50UGFzc2l2ZURldiB8IE1vdW50TGF5b3V0RGV2IHwgUGFzc2l2ZSB8IFVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfihQYXNzaXZlIHwgVXBkYXRlKTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnQ0LmxhbmVzID0gcmVtb3ZlTGFuZXMoY3VycmVudDQubGFuZXMsIGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRIb29rc0FmdGVyVGhyb3coKSB7CiAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlKSB7CiAgICAgICAgICAgIHZhciBob29rID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB3aGlsZSAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBxdWV1ZSA9IGhvb2sucXVldWU7CiAgICAgICAgICAgICAgaWYgKHF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaG9vayA9IGhvb2submV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBkaWRTY2hlZHVsZVJlbmRlclBoYXNlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICByZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxID0gbnVsbDsKICAgICAgICAgIGN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIGhvb2tUeXBlc0RldiA9IG51bGw7CiAgICAgICAgICAgIGhvb2tUeXBlc1VwZGF0ZUluZGV4RGV2ID0gLTE7CiAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gbnVsbDsKICAgICAgICAgICAgaXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZSA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgZGlkU2NoZWR1bGVSZW5kZXJQaGFzZVVwZGF0ZUR1cmluZ1RoaXNQYXNzID0gZmFsc2U7CiAgICAgICAgICBsb2NhbElkQ291bnRlciA9IDA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCkgewogICAgICAgICAgdmFyIGhvb2sgPSB7CiAgICAgICAgICAgIG1lbW9pemVkU3RhdGU6IG51bGwsCiAgICAgICAgICAgIGJhc2VTdGF0ZTogbnVsbCwKICAgICAgICAgICAgYmFzZVF1ZXVlOiBudWxsLAogICAgICAgICAgICBxdWV1ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc0hvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlID0gd29ya0luUHJvZ3Jlc3NIb29rID0gaG9vazsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0ID0gaG9vazsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpIHsKICAgICAgICAgIHZhciBuZXh0Q3VycmVudEhvb2s7CiAgICAgICAgICBpZiAoY3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5leHRDdXJyZW50SG9vayA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmV4dEN1cnJlbnRIb29rID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dEN1cnJlbnRIb29rID0gY3VycmVudEhvb2submV4dDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0V29ya0luUHJvZ3Jlc3NIb29rOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzSG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICBuZXh0V29ya0luUHJvZ3Jlc3NIb29rID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dFdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0OwogICAgICAgICAgfQogICAgICAgICAgaWYgKG5leHRXb3JrSW5Qcm9ncmVzc0hvb2sgIT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NIb29rID0gbmV4dFdvcmtJblByb2dyZXNzSG9vazsKICAgICAgICAgICAgbmV4dFdvcmtJblByb2dyZXNzSG9vayA9IHdvcmtJblByb2dyZXNzSG9vay5uZXh0OwogICAgICAgICAgICBjdXJyZW50SG9vayA9IG5leHRDdXJyZW50SG9vazsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChuZXh0Q3VycmVudEhvb2sgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJlbmRlcmVkIG1vcmUgaG9va3MgdGhhbiBkdXJpbmcgdGhlIHByZXZpb3VzIHJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjdXJyZW50SG9vayA9IG5leHRDdXJyZW50SG9vazsKICAgICAgICAgICAgdmFyIG5ld0hvb2sgPSB7CiAgICAgICAgICAgICAgbWVtb2l6ZWRTdGF0ZTogY3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZSwKICAgICAgICAgICAgICBiYXNlU3RhdGU6IGN1cnJlbnRIb29rLmJhc2VTdGF0ZSwKICAgICAgICAgICAgICBiYXNlUXVldWU6IGN1cnJlbnRIb29rLmJhc2VRdWV1ZSwKICAgICAgICAgICAgICBxdWV1ZTogY3VycmVudEhvb2sucXVldWUsCiAgICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NIb29rID09PSBudWxsKSB7CiAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tZW1vaXplZFN0YXRlID0gd29ya0luUHJvZ3Jlc3NIb29rID0gbmV3SG9vazsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgPSB3b3JrSW5Qcm9ncmVzc0hvb2submV4dCA9IG5ld0hvb2s7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc0hvb2s7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZ1bmN0aW9uQ29tcG9uZW50VXBkYXRlUXVldWUoKSB7CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICBsYXN0RWZmZWN0OiBudWxsLAogICAgICAgICAgICBzdG9yZXM6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhc2ljU3RhdGVSZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICAgIHJldHVybiB0eXBlb2YgYWN0aW9uID09PSAiZnVuY3Rpb24iID8gYWN0aW9uKHN0YXRlKSA6IGFjdGlvbjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBpbml0aWFsU3RhdGUxMzsKICAgICAgICAgIGlmIChpbml0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaW5pdGlhbFN0YXRlMTMgPSBpbml0KGluaXRpYWxBcmcpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5pdGlhbFN0YXRlMTMgPSBpbml0aWFsQXJnOwogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gaG9vay5iYXNlU3RhdGUgPSBpbml0aWFsU3RhdGUxMzsKICAgICAgICAgIHZhciBxdWV1ZSA9IHsKICAgICAgICAgICAgcGVuZGluZzogbnVsbCwKICAgICAgICAgICAgaW50ZXJsZWF2ZWQ6IG51bGwsCiAgICAgICAgICAgIGxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICBkaXNwYXRjaDogbnVsbCwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkUmVkdWNlcjogcmVkdWNlciwKICAgICAgICAgICAgbGFzdFJlbmRlcmVkU3RhdGU6IGluaXRpYWxTdGF0ZTEzCiAgICAgICAgICB9OwogICAgICAgICAgaG9vay5xdWV1ZSA9IHF1ZXVlOwogICAgICAgICAgdmFyIGRpc3BhdGNoID0gcXVldWUuZGlzcGF0Y2ggPSBkaXNwYXRjaFJlZHVjZXJBY3Rpb24uYmluZChudWxsLCBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLCBxdWV1ZSk7CiAgICAgICAgICByZXR1cm4gW2hvb2subWVtb2l6ZWRTdGF0ZSwgZGlzcGF0Y2hdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgcXVldWUgPSBob29rLnF1ZXVlOwogICAgICAgICAgaWYgKHF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIGhhdmUgYSBxdWV1ZS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUubGFzdFJlbmRlcmVkUmVkdWNlciA9IHJlZHVjZXI7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSBjdXJyZW50SG9vazsKICAgICAgICAgIHZhciBiYXNlUXVldWUgPSBjdXJyZW50NC5iYXNlUXVldWU7CiAgICAgICAgICB2YXIgcGVuZGluZ1F1ZXVlID0gcXVldWUucGVuZGluZzsKICAgICAgICAgIGlmIChwZW5kaW5nUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKGJhc2VRdWV1ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBiYXNlRmlyc3QgPSBiYXNlUXVldWUubmV4dDsKICAgICAgICAgICAgICB2YXIgcGVuZGluZ0ZpcnN0ID0gcGVuZGluZ1F1ZXVlLm5leHQ7CiAgICAgICAgICAgICAgYmFzZVF1ZXVlLm5leHQgPSBwZW5kaW5nRmlyc3Q7CiAgICAgICAgICAgICAgcGVuZGluZ1F1ZXVlLm5leHQgPSBiYXNlRmlyc3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjdXJyZW50NC5iYXNlUXVldWUgIT09IGJhc2VRdWV1ZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkludGVybmFsIGVycm9yOiBFeHBlY3RlZCB3b3JrLWluLXByb2dyZXNzIHF1ZXVlIHRvIGJlIGEgY2xvbmUuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGN1cnJlbnQ0LmJhc2VRdWV1ZSA9IGJhc2VRdWV1ZSA9IHBlbmRpbmdRdWV1ZTsKICAgICAgICAgICAgcXVldWUucGVuZGluZyA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoYmFzZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaXJzdCA9IGJhc2VRdWV1ZS5uZXh0OwogICAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBjdXJyZW50NC5iYXNlU3RhdGU7CiAgICAgICAgICAgIHZhciBuZXdCYXNlU3RhdGUgPSBudWxsOwogICAgICAgICAgICB2YXIgbmV3QmFzZVF1ZXVlRmlyc3QgPSBudWxsOwogICAgICAgICAgICB2YXIgbmV3QmFzZVF1ZXVlTGFzdCA9IG51bGw7CiAgICAgICAgICAgIHZhciB1cGRhdGUgPSBmaXJzdDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIHZhciB1cGRhdGVMYW5lID0gdXBkYXRlLmxhbmU7CiAgICAgICAgICAgICAgaWYgKCFpc1N1YnNldE9mTGFuZXMocmVuZGVyTGFuZXMsIHVwZGF0ZUxhbmUpKSB7CiAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSB7CiAgICAgICAgICAgICAgICAgIGxhbmU6IHVwZGF0ZUxhbmUsCiAgICAgICAgICAgICAgICAgIGFjdGlvbjogdXBkYXRlLmFjdGlvbiwKICAgICAgICAgICAgICAgICAgaGFzRWFnZXJTdGF0ZTogdXBkYXRlLmhhc0VhZ2VyU3RhdGUsCiAgICAgICAgICAgICAgICAgIGVhZ2VyU3RhdGU6IHVwZGF0ZS5lYWdlclN0YXRlLAogICAgICAgICAgICAgICAgICBuZXh0OiBudWxsCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgaWYgKG5ld0Jhc2VRdWV1ZUxhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbmV3QmFzZVF1ZXVlRmlyc3QgPSBuZXdCYXNlUXVldWVMYXN0ID0gY2xvbmU7CiAgICAgICAgICAgICAgICAgIG5ld0Jhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgbmV3QmFzZVF1ZXVlTGFzdCA9IG5ld0Jhc2VRdWV1ZUxhc3QubmV4dCA9IGNsb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcyA9IG1lcmdlTGFuZXMoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcywgdXBkYXRlTGFuZSk7CiAgICAgICAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKHVwZGF0ZUxhbmUpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAobmV3QmFzZVF1ZXVlTGFzdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgX2Nsb25lID0gewogICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgdXBkYXRlIGlzIGdvaW5nIHRvIGJlIGNvbW1pdHRlZCBzbyB3ZSBuZXZlciB3YW50IHVuY29tbWl0CiAgICAgICAgICAgICAgICAgICAgLy8gaXQuIFVzaW5nIE5vTGFuZSB3b3JrcyBiZWNhdXNlIDAgaXMgYSBzdWJzZXQgb2YgYWxsIGJpdG1hc2tzLCBzbwogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgd2lsbCBuZXZlciBiZSBza2lwcGVkIGJ5IHRoZSBjaGVjayBhYm92ZS4KICAgICAgICAgICAgICAgICAgICBsYW5lOiBOb0xhbmUsCiAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiB1cGRhdGUuYWN0aW9uLAogICAgICAgICAgICAgICAgICAgIGhhc0VhZ2VyU3RhdGU6IHVwZGF0ZS5oYXNFYWdlclN0YXRlLAogICAgICAgICAgICAgICAgICAgIGVhZ2VyU3RhdGU6IHVwZGF0ZS5lYWdlclN0YXRlLAogICAgICAgICAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgbmV3QmFzZVF1ZXVlTGFzdCA9IG5ld0Jhc2VRdWV1ZUxhc3QubmV4dCA9IF9jbG9uZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1cGRhdGUuaGFzRWFnZXJTdGF0ZSkgewogICAgICAgICAgICAgICAgICBuZXdTdGF0ZSA9IHVwZGF0ZS5lYWdlclN0YXRlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IHVwZGF0ZS5hY3Rpb247CiAgICAgICAgICAgICAgICAgIG5ld1N0YXRlID0gcmVkdWNlcihuZXdTdGF0ZSwgYWN0aW9uKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKHVwZGF0ZSAhPT0gbnVsbCAmJiB1cGRhdGUgIT09IGZpcnN0KTsKICAgICAgICAgICAgaWYgKG5ld0Jhc2VRdWV1ZUxhc3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICBuZXdCYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXdCYXNlUXVldWVMYXN0Lm5leHQgPSBuZXdCYXNlUXVldWVGaXJzdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIW9iamVjdElzKG5ld1N0YXRlLCBob29rLm1lbW9pemVkU3RhdGUpKSB7CiAgICAgICAgICAgICAgbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdCYXNlU3RhdGU7CiAgICAgICAgICAgIGhvb2suYmFzZVF1ZXVlID0gbmV3QmFzZVF1ZXVlTGFzdDsKICAgICAgICAgICAgcXVldWUubGFzdFJlbmRlcmVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYXN0SW50ZXJsZWF2ZWQgPSBxdWV1ZS5pbnRlcmxlYXZlZDsKICAgICAgICAgIGlmIChsYXN0SW50ZXJsZWF2ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGludGVybGVhdmVkID0gbGFzdEludGVybGVhdmVkOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgdmFyIGludGVybGVhdmVkTGFuZSA9IGludGVybGVhdmVkLmxhbmU7CiAgICAgICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcyA9IG1lcmdlTGFuZXMoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5sYW5lcywgaW50ZXJsZWF2ZWRMYW5lKTsKICAgICAgICAgICAgICBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKGludGVybGVhdmVkTGFuZSk7CiAgICAgICAgICAgICAgaW50ZXJsZWF2ZWQgPSBpbnRlcmxlYXZlZC5uZXh0OwogICAgICAgICAgICB9IHdoaWxlIChpbnRlcmxlYXZlZCAhPT0gbGFzdEludGVybGVhdmVkKTsKICAgICAgICAgIH0gZWxzZSBpZiAoYmFzZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBkaXNwYXRjaCA9IHF1ZXVlLmRpc3BhdGNoOwogICAgICAgICAgcmV0dXJuIFtob29rLm1lbW9pemVkU3RhdGUsIGRpc3BhdGNoXTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVyZW5kZXJSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgcXVldWUgPSBob29rLnF1ZXVlOwogICAgICAgICAgaWYgKHF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiU2hvdWxkIGhhdmUgYSBxdWV1ZS4gVGhpcyBpcyBsaWtlbHkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUubGFzdFJlbmRlcmVkUmVkdWNlciA9IHJlZHVjZXI7CiAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSBxdWV1ZS5kaXNwYXRjaDsKICAgICAgICAgIHZhciBsYXN0UmVuZGVyUGhhc2VVcGRhdGUgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgdmFyIG5ld1N0YXRlID0gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKGxhc3RSZW5kZXJQaGFzZVVwZGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBxdWV1ZS5wZW5kaW5nID0gbnVsbDsKICAgICAgICAgICAgdmFyIGZpcnN0UmVuZGVyUGhhc2VVcGRhdGUgPSBsYXN0UmVuZGVyUGhhc2VVcGRhdGUubmV4dDsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGZpcnN0UmVuZGVyUGhhc2VVcGRhdGU7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gdXBkYXRlLmFjdGlvbjsKICAgICAgICAgICAgICBuZXdTdGF0ZSA9IHJlZHVjZXIobmV3U3RhdGUsIGFjdGlvbik7CiAgICAgICAgICAgICAgdXBkYXRlID0gdXBkYXRlLm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKHVwZGF0ZSAhPT0gZmlyc3RSZW5kZXJQaGFzZVVwZGF0ZSk7CiAgICAgICAgICAgIGlmICghb2JqZWN0SXMobmV3U3RhdGUsIGhvb2subWVtb2l6ZWRTdGF0ZSkpIHsKICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICBpZiAoaG9vay5iYXNlUXVldWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHF1ZXVlLmxhc3RSZW5kZXJlZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gW25ld1N0YXRlLCBkaXNwYXRjaF07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50TXV0YWJsZVNvdXJjZShzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTXV0YWJsZVNvdXJjZShzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMTsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0U25hcHNob3Q7CiAgICAgICAgICB2YXIgaXNIeWRyYXRpbmcyID0gZ2V0SXNIeWRyYXRpbmcoKTsKICAgICAgICAgIGlmIChpc0h5ZHJhdGluZzIpIHsKICAgICAgICAgICAgaWYgKGdldFNlcnZlclNuYXBzaG90ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1pc3NpbmcgZ2V0U2VydmVyU25hcHNob3QsIHdoaWNoIGlzIHJlcXVpcmVkIGZvciBzZXJ2ZXItcmVuZGVyZWQgY29udGVudC4gV2lsbCByZXZlcnQgdG8gY2xpZW50IHJlbmRlcmluZy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0U25hcHNob3QgPSBnZXRTZXJ2ZXJTbmFwc2hvdCgpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCkgewogICAgICAgICAgICAgICAgaWYgKG5leHRTbmFwc2hvdCAhPT0gZ2V0U2VydmVyU25hcHNob3QoKSkgewogICAgICAgICAgICAgICAgICBlcnJvcigiVGhlIHJlc3VsdCBvZiBnZXRTZXJ2ZXJTbmFwc2hvdCBzaG91bGQgYmUgY2FjaGVkIHRvIGF2b2lkIGFuIGluZmluaXRlIGxvb3AiKTsKICAgICAgICAgICAgICAgICAgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgICAgICAgIHZhciBjYWNoZWRTbmFwc2hvdCA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICAgICAgICBpZiAoIW9iamVjdElzKG5leHRTbmFwc2hvdCwgY2FjaGVkU25hcHNob3QpKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJUaGUgcmVzdWx0IG9mIGdldFNuYXBzaG90IHNob3VsZCBiZSBjYWNoZWQgdG8gYXZvaWQgYW4gaW5maW5pdGUgbG9vcCIpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgICBpZiAocm9vdDMgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIGEgd29yay1pbi1wcm9ncmVzcyByb290LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCByZW5kZXJMYW5lcykpIHsKICAgICAgICAgICAgICBwdXNoU3RvcmVDb25zaXN0ZW5jeUNoZWNrKGZpYmVyLCBnZXRTbmFwc2hvdCwgbmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgdmFyIGluc3QgPSB7CiAgICAgICAgICAgIHZhbHVlOiBuZXh0U25hcHNob3QsCiAgICAgICAgICAgIGdldFNuYXBzaG90CiAgICAgICAgICB9OwogICAgICAgICAgaG9vay5xdWV1ZSA9IGluc3Q7CiAgICAgICAgICBtb3VudEVmZmVjdChzdWJzY3JpYmVUb1N0b3JlLmJpbmQobnVsbCwgZmliZXIsIGluc3QsIHN1YnNjcmliZSksIFtzdWJzY3JpYmVdKTsKICAgICAgICAgIGZpYmVyLmZsYWdzIHw9IFBhc3NpdmU7CiAgICAgICAgICBwdXNoRWZmZWN0KEhhc0VmZmVjdCB8IFBhc3NpdmUkMSwgdXBkYXRlU3RvcmVJbnN0YW5jZS5iaW5kKG51bGwsIGZpYmVyLCBpbnN0LCBuZXh0U25hcHNob3QsIGdldFNuYXBzaG90KSwgdm9pZCAwLCBudWxsKTsKICAgICAgICAgIHJldHVybiBuZXh0U25hcHNob3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QsIGdldFNlcnZlclNuYXBzaG90KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxOwogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0U25hcHNob3QgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoIWRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90KSB7CiAgICAgICAgICAgICAgdmFyIGNhY2hlZFNuYXBzaG90ID0gZ2V0U25hcHNob3QoKTsKICAgICAgICAgICAgICBpZiAoIW9iamVjdElzKG5leHRTbmFwc2hvdCwgY2FjaGVkU25hcHNob3QpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIHJlc3VsdCBvZiBnZXRTbmFwc2hvdCBzaG91bGQgYmUgY2FjaGVkIHRvIGF2b2lkIGFuIGluZmluaXRlIGxvb3AiKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5VbmNhY2hlZEdldFNuYXBzaG90ID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2U25hcHNob3QgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgc25hcHNob3RDaGFuZ2VkID0gIW9iamVjdElzKHByZXZTbmFwc2hvdCwgbmV4dFNuYXBzaG90KTsKICAgICAgICAgIGlmIChzbmFwc2hvdENoYW5nZWQpIHsKICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluc3QgPSBob29rLnF1ZXVlOwogICAgICAgICAgdXBkYXRlRWZmZWN0KHN1YnNjcmliZVRvU3RvcmUuYmluZChudWxsLCBmaWJlciwgaW5zdCwgc3Vic2NyaWJlKSwgW3N1YnNjcmliZV0pOwogICAgICAgICAgaWYgKGluc3QuZ2V0U25hcHNob3QgIT09IGdldFNuYXBzaG90IHx8IHNuYXBzaG90Q2hhbmdlZCB8fCAvLyBDaGVjayBpZiB0aGUgc3VzYmNyaWJlIGZ1bmN0aW9uIGNoYW5nZWQuIFdlIGNhbiBzYXZlIHNvbWUgbWVtb3J5IGJ5CiAgICAgICAgICAvLyBjaGVja2luZyB3aGV0aGVyIHdlIHNjaGVkdWxlZCBhIHN1YnNjcmlwdGlvbiBlZmZlY3QgYWJvdmUuCiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc0hvb2sgIT09IG51bGwgJiYgd29ya0luUHJvZ3Jlc3NIb29rLm1lbW9pemVkU3RhdGUudGFnICYgSGFzRWZmZWN0KSB7CiAgICAgICAgICAgIGZpYmVyLmZsYWdzIHw9IFBhc3NpdmU7CiAgICAgICAgICAgIHB1c2hFZmZlY3QoSGFzRWZmZWN0IHwgUGFzc2l2ZSQxLCB1cGRhdGVTdG9yZUluc3RhbmNlLmJpbmQobnVsbCwgZmliZXIsIGluc3QsIG5leHRTbmFwc2hvdCwgZ2V0U25hcHNob3QpLCB2b2lkIDAsIG51bGwpOwogICAgICAgICAgICB2YXIgcm9vdDMgPSBnZXRXb3JrSW5Qcm9ncmVzc1Jvb3QoKTsKICAgICAgICAgICAgaWYgKHJvb3QzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCBhIHdvcmstaW4tcHJvZ3Jlc3Mgcm9vdC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgcmVuZGVyTGFuZXMpKSB7CiAgICAgICAgICAgICAgcHVzaFN0b3JlQ29uc2lzdGVuY3lDaGVjayhmaWJlciwgZ2V0U25hcHNob3QsIG5leHRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBuZXh0U25hcHNob3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHB1c2hTdG9yZUNvbnNpc3RlbmN5Q2hlY2soZmliZXIsIGdldFNuYXBzaG90LCByZW5kZXJlZFNuYXBzaG90KSB7CiAgICAgICAgICBmaWJlci5mbGFncyB8PSBTdG9yZUNvbnNpc3RlbmN5OwogICAgICAgICAgdmFyIGNoZWNrID0gewogICAgICAgICAgICBnZXRTbmFwc2hvdCwKICAgICAgICAgICAgdmFsdWU6IHJlbmRlcmVkU25hcHNob3QKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29tcG9uZW50VXBkYXRlUXVldWUgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKGNvbXBvbmVudFVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3JlYXRlRnVuY3Rpb25Db21wb25lbnRVcGRhdGVRdWV1ZSgpOwogICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlID0gY29tcG9uZW50VXBkYXRlUXVldWU7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLnN0b3JlcyA9IFtjaGVja107CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgc3RvcmVzID0gY29tcG9uZW50VXBkYXRlUXVldWUuc3RvcmVzOwogICAgICAgICAgICBpZiAoc3RvcmVzID09PSBudWxsKSB7CiAgICAgICAgICAgICAgY29tcG9uZW50VXBkYXRlUXVldWUuc3RvcmVzID0gW2NoZWNrXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdG9yZXMucHVzaChjaGVjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3RvcmVJbnN0YW5jZShmaWJlciwgaW5zdCwgbmV4dFNuYXBzaG90LCBnZXRTbmFwc2hvdCkgewogICAgICAgICAgaW5zdC52YWx1ZSA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgIGluc3QuZ2V0U25hcHNob3QgPSBnZXRTbmFwc2hvdDsKICAgICAgICAgIGlmIChjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpKSB7CiAgICAgICAgICAgIGZvcmNlU3RvcmVSZXJlbmRlcihmaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN1YnNjcmliZVRvU3RvcmUoZmliZXIsIGluc3QsIHN1YnNjcmliZSkgewogICAgICAgICAgdmFyIGhhbmRsZVN0b3JlQ2hhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmIChjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpKSB7CiAgICAgICAgICAgICAgZm9yY2VTdG9yZVJlcmVuZGVyKGZpYmVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiBzdWJzY3JpYmUoaGFuZGxlU3RvcmVDaGFuZ2UpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpIHsKICAgICAgICAgIHZhciBsYXRlc3RHZXRTbmFwc2hvdCA9IGluc3QuZ2V0U25hcHNob3Q7CiAgICAgICAgICB2YXIgcHJldlZhbHVlID0gaW5zdC52YWx1ZTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBsYXRlc3RHZXRTbmFwc2hvdCgpOwogICAgICAgICAgICByZXR1cm4gIW9iamVjdElzKHByZXZWYWx1ZSwgbmV4dFZhbHVlKTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZm9yY2VTdG9yZVJlcmVuZGVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN0YXRlKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICB2YXIgaG9vayA9IG1vdW50V29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICBpZiAodHlwZW9mIGluaXRpYWxTdGF0ZTEzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluaXRpYWxTdGF0ZTEzID0gaW5pdGlhbFN0YXRlMTMoKTsKICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IGhvb2suYmFzZVN0YXRlID0gaW5pdGlhbFN0YXRlMTM7CiAgICAgICAgICB2YXIgcXVldWUgPSB7CiAgICAgICAgICAgIHBlbmRpbmc6IG51bGwsCiAgICAgICAgICAgIGludGVybGVhdmVkOiBudWxsLAogICAgICAgICAgICBsYW5lczogTm9MYW5lcywKICAgICAgICAgICAgZGlzcGF0Y2g6IG51bGwsCiAgICAgICAgICAgIGxhc3RSZW5kZXJlZFJlZHVjZXI6IGJhc2ljU3RhdGVSZWR1Y2VyLAogICAgICAgICAgICBsYXN0UmVuZGVyZWRTdGF0ZTogaW5pdGlhbFN0YXRlMTMKICAgICAgICAgIH07CiAgICAgICAgICBob29rLnF1ZXVlID0gcXVldWU7CiAgICAgICAgICB2YXIgZGlzcGF0Y2ggPSBxdWV1ZS5kaXNwYXRjaCA9IGRpc3BhdGNoU2V0U3RhdGUuYmluZChudWxsLCBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLCBxdWV1ZSk7CiAgICAgICAgICByZXR1cm4gW2hvb2subWVtb2l6ZWRTdGF0ZSwgZGlzcGF0Y2hdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdGF0ZShpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIoYmFzaWNTdGF0ZVJlZHVjZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclN0YXRlKGluaXRpYWxTdGF0ZTEzKSB7CiAgICAgICAgICByZXR1cm4gcmVyZW5kZXJSZWR1Y2VyKGJhc2ljU3RhdGVSZWR1Y2VyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaEVmZmVjdCh0YWcsIGNyZWF0ZSwgZGVzdHJveSwgZGVwcykgewogICAgICAgICAgdmFyIGVmZmVjdCA9IHsKICAgICAgICAgICAgdGFnLAogICAgICAgICAgICBjcmVhdGUsCiAgICAgICAgICAgIGRlc3Ryb3ksCiAgICAgICAgICAgIGRlcHMsCiAgICAgICAgICAgIC8vIENpcmN1bGFyCiAgICAgICAgICAgIG5leHQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29tcG9uZW50VXBkYXRlUXVldWUgPSBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKGNvbXBvbmVudFVwZGF0ZVF1ZXVlID09PSBudWxsKSB7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlID0gY3JlYXRlRnVuY3Rpb25Db21wb25lbnRVcGRhdGVRdWV1ZSgpOwogICAgICAgICAgICBjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLnVwZGF0ZVF1ZXVlID0gY29tcG9uZW50VXBkYXRlUXVldWU7CiAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgPSBlZmZlY3QubmV4dCA9IGVmZmVjdDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gY29tcG9uZW50VXBkYXRlUXVldWUubGFzdEVmZmVjdDsKICAgICAgICAgICAgaWYgKGxhc3RFZmZlY3QgPT09IG51bGwpIHsKICAgICAgICAgICAgICBjb21wb25lbnRVcGRhdGVRdWV1ZS5sYXN0RWZmZWN0ID0gZWZmZWN0Lm5leHQgPSBlZmZlY3Q7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIGZpcnN0RWZmZWN0ID0gbGFzdEVmZmVjdC5uZXh0OwogICAgICAgICAgICAgIGxhc3RFZmZlY3QubmV4dCA9IGVmZmVjdDsKICAgICAgICAgICAgICBlZmZlY3QubmV4dCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICAgIGNvbXBvbmVudFVwZGF0ZVF1ZXVlLmxhc3RFZmZlY3QgPSBlZmZlY3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlZmZlY3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50UmVmKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgX3JlZjIgPSB7CiAgICAgICAgICAgICAgY3VycmVudDogaW5pdGlhbFZhbHVlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IF9yZWYyOwogICAgICAgICAgICByZXR1cm4gX3JlZjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVJlZihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICByZXR1cm4gaG9vay5tZW1vaXplZFN0YXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEVmZmVjdEltcGwoZmliZXJGbGFncywgaG9va0ZsYWdzLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBob29rRmxhZ3MsIGNyZWF0ZSwgdm9pZCAwLCBuZXh0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUVmZmVjdEltcGwoZmliZXJGbGFncywgaG9va0ZsYWdzLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBkZXN0cm95ID0gdm9pZCAwOwogICAgICAgICAgaWYgKGN1cnJlbnRIb29rICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBwcmV2RWZmZWN0ID0gY3VycmVudEhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgZGVzdHJveSA9IHByZXZFZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgaWYgKG5leHREZXBzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZEZXBzID0gcHJldkVmZmVjdC5kZXBzOwogICAgICAgICAgICAgIGlmIChhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSkgewogICAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChob29rRmxhZ3MsIGNyZWF0ZSwgZGVzdHJveSwgbmV4dERlcHMpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5mbGFncyB8PSBmaWJlckZsYWdzOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gcHVzaEVmZmVjdChIYXNFZmZlY3QgfCBob29rRmxhZ3MsIGNyZWF0ZSwgZGVzdHJveSwgbmV4dERlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIGlmICgoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChNb3VudFBhc3NpdmVEZXYgfCBQYXNzaXZlIHwgUGFzc2l2ZVN0YXRpYywgUGFzc2l2ZSQxLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChQYXNzaXZlIHwgUGFzc2l2ZVN0YXRpYywgUGFzc2l2ZSQxLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChQYXNzaXZlLCBQYXNzaXZlJDEsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChVcGRhdGUsIEluc2VydGlvbiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdEltcGwoVXBkYXRlLCBJbnNlcnRpb24sIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50TGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgfQogICAgICAgICAgaWYgKChjdXJyZW50bHlSZW5kZXJpbmdGaWJlciQxLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IE1vdW50TGF5b3V0RGV2OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0SW1wbChmaWJlckZsYWdzLCBMYXlvdXQsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUxheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3RJbXBsKFVwZGF0ZSwgTGF5b3V0LCBjcmVhdGUsIGRlcHMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbXBlcmF0aXZlSGFuZGxlRWZmZWN0KGNyZWF0ZSwgcmVmKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgcmVmQ2FsbGJhY2sgPSByZWY7CiAgICAgICAgICAgIHZhciBfaW5zdCA9IGNyZWF0ZSgpOwogICAgICAgICAgICByZWZDYWxsYmFjayhfaW5zdCk7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICByZWZDYWxsYmFjayhudWxsKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0gZWxzZSBpZiAocmVmICE9PSBudWxsICYmIHJlZiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhciByZWZPYmplY3QgPSByZWY7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoIXJlZk9iamVjdC5oYXNPd25Qcm9wZXJ0eSgiY3VycmVudCIpKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgdXNlSW1wZXJhdGl2ZUhhbmRsZSgpIGZpcnN0IGFyZ3VtZW50IHRvIGVpdGhlciBiZSBhIHJlZiBjYWxsYmFjayBvciBSZWFjdC5jcmVhdGVSZWYoKSBvYmplY3QuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsICJhbiBvYmplY3Qgd2l0aCBrZXlzIHsiICsgT2JqZWN0LmtleXMocmVmT2JqZWN0KS5qb2luKCIsICIpICsgIn0iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9pbnN0MiA9IGNyZWF0ZSgpOwogICAgICAgICAgICByZWZPYmplY3QuY3VycmVudCA9IF9pbnN0MjsKICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJlZk9iamVjdC5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3JlYXRlICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHVzZUltcGVyYXRpdmVIYW5kbGUoKSBzZWNvbmQgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbiB0aGF0IGNyZWF0ZXMgYSBoYW5kbGUuIEluc3RlYWQgcmVjZWl2ZWQ6ICVzLiIsIGNyZWF0ZSAhPT0gbnVsbCA/IHR5cGVvZiBjcmVhdGUgOiAibnVsbCIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZWZmZWN0RGVwcyA9IGRlcHMgIT09IG51bGwgJiYgZGVwcyAhPT0gdm9pZCAwID8gZGVwcy5jb25jYXQoW3JlZl0pIDogbnVsbDsKICAgICAgICAgIHZhciBmaWJlckZsYWdzID0gVXBkYXRlOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlckZsYWdzIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMS5tb2RlICYgU3RyaWN0RWZmZWN0c01vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdEltcGwoZmliZXJGbGFncywgTGF5b3V0LCBpbXBlcmF0aXZlSGFuZGxlRWZmZWN0LmJpbmQobnVsbCwgY3JlYXRlLCByZWYpLCBlZmZlY3REZXBzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNyZWF0ZSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCB1c2VJbXBlcmF0aXZlSGFuZGxlKCkgc2Vjb25kIGFyZ3VtZW50IHRvIGJlIGEgZnVuY3Rpb24gdGhhdCBjcmVhdGVzIGEgaGFuZGxlLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjcmVhdGUgIT09IG51bGwgPyB0eXBlb2YgY3JlYXRlIDogIm51bGwiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGVmZmVjdERlcHMgPSBkZXBzICE9PSBudWxsICYmIGRlcHMgIT09IHZvaWQgMCA/IGRlcHMuY29uY2F0KFtyZWZdKSA6IG51bGw7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRWZmZWN0SW1wbChVcGRhdGUsIExheW91dCwgaW1wZXJhdGl2ZUhhbmRsZUVmZmVjdC5iaW5kKG51bGwsIGNyZWF0ZSwgcmVmKSwgZWZmZWN0RGVwcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50RGVidWdWYWx1ZSh2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICB9CiAgICAgICAgdmFyIHVwZGF0ZURlYnVnVmFsdWUgPSBtb3VudERlYnVnVmFsdWU7CiAgICAgICAgZnVuY3Rpb24gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIG5leHREZXBzID0gZGVwcyA9PT0gdm9pZCAwID8gbnVsbCA6IGRlcHM7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbY2FsbGJhY2ssIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBjYWxsYmFjazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgbmV4dERlcHMgPSBkZXBzID09PSB2b2lkIDAgPyBudWxsIDogZGVwczsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChuZXh0RGVwcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2RGVwcyA9IHByZXZTdGF0ZVsxXTsKICAgICAgICAgICAgICBpZiAoYXJlSG9va0lucHV0c0VxdWFsKG5leHREZXBzLCBwcmV2RGVwcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwcmV2U3RhdGVbMF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbY2FsbGJhY2ssIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBjYWxsYmFjazsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRNZW1vKG5leHRDcmVhdGUsIGRlcHMpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IG5leHRDcmVhdGUoKTsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IFtuZXh0VmFsdWUsIG5leHREZXBzXTsKICAgICAgICAgIHJldHVybiBuZXh0VmFsdWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1lbW8obmV4dENyZWF0ZSwgZGVwcykgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBuZXh0RGVwcyA9IGRlcHMgPT09IHZvaWQgMCA/IG51bGwgOiBkZXBzOwogICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgaWYgKG5leHREZXBzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZEZXBzID0gcHJldlN0YXRlWzFdOwogICAgICAgICAgICAgIGlmIChhcmVIb29rSW5wdXRzRXF1YWwobmV4dERlcHMsIHByZXZEZXBzKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHByZXZTdGF0ZVswXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0VmFsdWUgPSBuZXh0Q3JlYXRlKCk7CiAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBbbmV4dFZhbHVlLCBuZXh0RGVwc107CiAgICAgICAgICByZXR1cm4gbmV4dFZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudERlZmVycmVkVmFsdWUodmFsdWUpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHZhbHVlOwogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVEZWZlcnJlZFZhbHVlKHZhbHVlKSB7CiAgICAgICAgICB2YXIgaG9vayA9IHVwZGF0ZVdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgdmFyIHJlc29sdmVkQ3VycmVudEhvb2sgPSBjdXJyZW50SG9vazsKICAgICAgICAgIHZhciBwcmV2VmFsdWUgPSByZXNvbHZlZEN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZUltcGwoaG9vaywgcHJldlZhbHVlLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcmVuZGVyRGVmZXJyZWRWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIGlmIChjdXJyZW50SG9vayA9PT0gbnVsbCkgewogICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSB2YWx1ZTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHByZXZWYWx1ZSA9IGN1cnJlbnRIb29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWZlcnJlZFZhbHVlSW1wbChob29rLCBwcmV2VmFsdWUsIHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRGVmZXJyZWRWYWx1ZUltcGwoaG9vaywgcHJldlZhbHVlLCB2YWx1ZSkgewogICAgICAgICAgdmFyIHNob3VsZERlZmVyVmFsdWUgPSAhaW5jbHVkZXNPbmx5Tm9uVXJnZW50TGFuZXMocmVuZGVyTGFuZXMpOwogICAgICAgICAgaWYgKHNob3VsZERlZmVyVmFsdWUpIHsKICAgICAgICAgICAgaWYgKCFvYmplY3RJcyh2YWx1ZSwgcHJldlZhbHVlKSkgewogICAgICAgICAgICAgIHZhciBkZWZlcnJlZExhbmUgPSBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpOwogICAgICAgICAgICAgIGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMgPSBtZXJnZUxhbmVzKGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEubGFuZXMsIGRlZmVycmVkTGFuZSk7CiAgICAgICAgICAgICAgbWFya1NraXBwZWRVcGRhdGVMYW5lcyhkZWZlcnJlZExhbmUpOwogICAgICAgICAgICAgIGhvb2suYmFzZVN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcHJldlZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGhvb2suYmFzZVN0YXRlKSB7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICBtYXJrV29ya0luUHJvZ3Jlc3NSZWNlaXZlZFVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IHZhbHVlOwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0VHJhbnNpdGlvbihzZXRQZW5kaW5nLCBjYWxsYmFjaywgb3B0aW9uczIpIHsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoaGlnaGVyRXZlbnRQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5LCBDb250aW51b3VzRXZlbnRQcmlvcml0eSkpOwogICAgICAgICAgc2V0UGVuZGluZyh0cnVlKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbjsKICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbiA9IHt9OwogICAgICAgICAgdmFyIGN1cnJlbnRUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMi50cmFuc2l0aW9uOwogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQyLnRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgfQogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2V0UGVuZGluZyhmYWxzZSk7CiAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDIudHJhbnNpdGlvbiA9IHByZXZUcmFuc2l0aW9uOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKHByZXZUcmFuc2l0aW9uID09PSBudWxsICYmIGN1cnJlbnRUcmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlZEZpYmVyc0NvdW50ID0gY3VycmVudFRyYW5zaXRpb24uX3VwZGF0ZWRGaWJlcnMuc2l6ZTsKICAgICAgICAgICAgICAgIGlmICh1cGRhdGVkRmliZXJzQ291bnQgPiAxMCkgewogICAgICAgICAgICAgICAgICB3YXJuMygiRGV0ZWN0ZWQgYSBsYXJnZSBudW1iZXIgb2YgdXBkYXRlcyBpbnNpZGUgc3RhcnRUcmFuc2l0aW9uLiBJZiB0aGlzIGlzIGR1ZSB0byBhIHN1YnNjcmlwdGlvbiBwbGVhc2UgcmUtd3JpdGUgaXQgdG8gdXNlIFJlYWN0IHByb3ZpZGVkIGhvb2tzLiBPdGhlcndpc2UgY29uY3VycmVudCBtb2RlIGd1YXJhbnRlZXMgYXJlIG9mZiB0aGUgdGFibGUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5jbGVhcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX21vdW50U3RhdGUgPSBtb3VudFN0YXRlKGZhbHNlKSwgaXNQZW5kaW5nID0gX21vdW50U3RhdGVbMF0sIHNldFBlbmRpbmcgPSBfbW91bnRTdGF0ZVsxXTsKICAgICAgICAgIHZhciBzdGFydCA9IHN0YXJ0VHJhbnNpdGlvbi5iaW5kKG51bGwsIHNldFBlbmRpbmcpOwogICAgICAgICAgdmFyIGhvb2sgPSBtb3VudFdvcmtJblByb2dyZXNzSG9vaygpOwogICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gc3RhcnQ7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVUcmFuc2l0aW9uKCkgewogICAgICAgICAgdmFyIF91cGRhdGVTdGF0ZSA9IHVwZGF0ZVN0YXRlKCksIGlzUGVuZGluZyA9IF91cGRhdGVTdGF0ZVswXTsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgc3RhcnQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gW2lzUGVuZGluZywgc3RhcnRdOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXJlbmRlclRyYW5zaXRpb24oKSB7CiAgICAgICAgICB2YXIgX3JlcmVuZGVyU3RhdGUgPSByZXJlbmRlclN0YXRlKCksIGlzUGVuZGluZyA9IF9yZXJlbmRlclN0YXRlWzBdOwogICAgICAgICAgdmFyIGhvb2sgPSB1cGRhdGVXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciBzdGFydCA9IGhvb2subWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHJldHVybiBbaXNQZW5kaW5nLCBzdGFydF07CiAgICAgICAgfQogICAgICAgIHZhciBpc1VwZGF0aW5nT3BhcXVlVmFsdWVJblJlbmRlclBoYXNlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZ2V0SXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZUluREVWKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gaXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRJZCgpIHsKICAgICAgICAgIHZhciBob29rID0gbW91bnRXb3JrSW5Qcm9ncmVzc0hvb2soKTsKICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSByb290My5pZGVudGlmaWVyUHJlZml4OwogICAgICAgICAgdmFyIGlkOwogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkpIHsKICAgICAgICAgICAgdmFyIHRyZWVJZCA9IGdldFRyZWVJZCgpOwogICAgICAgICAgICBpZCA9ICI6IiArIGlkZW50aWZpZXJQcmVmaXggKyAiUiIgKyB0cmVlSWQ7CiAgICAgICAgICAgIHZhciBsb2NhbElkID0gbG9jYWxJZENvdW50ZXIrKzsKICAgICAgICAgICAgaWYgKGxvY2FsSWQgPiAwKSB7CiAgICAgICAgICAgICAgaWQgKz0gIkgiICsgbG9jYWxJZC50b1N0cmluZygzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWQgKz0gIjoiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGdsb2JhbENsaWVudElkID0gZ2xvYmFsQ2xpZW50SWRDb3VudGVyKys7CiAgICAgICAgICAgIGlkID0gIjoiICsgaWRlbnRpZmllclByZWZpeCArICJyIiArIGdsb2JhbENsaWVudElkLnRvU3RyaW5nKDMyKSArICI6IjsKICAgICAgICAgIH0KICAgICAgICAgIGhvb2subWVtb2l6ZWRTdGF0ZSA9IGlkOwogICAgICAgICAgcmV0dXJuIGlkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVJZCgpIHsKICAgICAgICAgIHZhciBob29rID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NIb29rKCk7CiAgICAgICAgICB2YXIgaWQgPSBob29rLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICByZXR1cm4gaWQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc3BhdGNoUmVkdWNlckFjdGlvbihmaWJlciwgcXVldWUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJTdGF0ZSB1cGRhdGVzIGZyb20gdGhlIHVzZVN0YXRlKCkgYW5kIHVzZVJlZHVjZXIoKSBIb29rcyBkb24ndCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gdGhlIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgYWN0aW9uLAogICAgICAgICAgICBoYXNFYWdlclN0YXRlOiBmYWxzZSwKICAgICAgICAgICAgZWFnZXJTdGF0ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSkgewogICAgICAgICAgICBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudEhvb2tVcGRhdGUoZmliZXIsIHF1ZXVlLCB1cGRhdGUsIGxhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzcGF0Y2hTZXRTdGF0ZShmaWJlciwgcXVldWUsIGFjdGlvbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCJTdGF0ZSB1cGRhdGVzIGZyb20gdGhlIHVzZVN0YXRlKCkgYW5kIHVzZVJlZHVjZXIoKSBIb29rcyBkb24ndCBzdXBwb3J0IHRoZSBzZWNvbmQgY2FsbGJhY2sgYXJndW1lbnQuIFRvIGV4ZWN1dGUgYSBzaWRlIGVmZmVjdCBhZnRlciByZW5kZXJpbmcsIGRlY2xhcmUgaXQgaW4gdGhlIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoZmliZXIpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IHsKICAgICAgICAgICAgbGFuZSwKICAgICAgICAgICAgYWN0aW9uLAogICAgICAgICAgICBoYXNFYWdlclN0YXRlOiBmYWxzZSwKICAgICAgICAgICAgZWFnZXJTdGF0ZTogbnVsbCwKICAgICAgICAgICAgbmV4dDogbnVsbAogICAgICAgICAgfTsKICAgICAgICAgIGlmIChpc1JlbmRlclBoYXNlVXBkYXRlKGZpYmVyKSkgewogICAgICAgICAgICBlbnF1ZXVlUmVuZGVyUGhhc2VVcGRhdGUocXVldWUsIHVwZGF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICBpZiAoZmliZXIubGFuZXMgPT09IE5vTGFuZXMgJiYgKGFsdGVybmF0ZSA9PT0gbnVsbCB8fCBhbHRlcm5hdGUubGFuZXMgPT09IE5vTGFuZXMpKSB7CiAgICAgICAgICAgICAgdmFyIGxhc3RSZW5kZXJlZFJlZHVjZXIgPSBxdWV1ZS5sYXN0UmVuZGVyZWRSZWR1Y2VyOwogICAgICAgICAgICAgIGlmIChsYXN0UmVuZGVyZWRSZWR1Y2VyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFN0YXRlID0gcXVldWUubGFzdFJlbmRlcmVkU3RhdGU7CiAgICAgICAgICAgICAgICAgIHZhciBlYWdlclN0YXRlID0gbGFzdFJlbmRlcmVkUmVkdWNlcihjdXJyZW50U3RhdGUsIGFjdGlvbik7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZS5oYXNFYWdlclN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgdXBkYXRlLmVhZ2VyU3RhdGUgPSBlYWdlclN0YXRlOwogICAgICAgICAgICAgICAgICBpZiAob2JqZWN0SXMoZWFnZXJTdGF0ZSwgY3VycmVudFN0YXRlKSkgewogICAgICAgICAgICAgICAgICAgIGVucXVldWVDb25jdXJyZW50SG9va1VwZGF0ZUFuZEVhZ2VybHlCYWlsb3V0KGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRIb29rVXBkYXRlKGZpYmVyLCBxdWV1ZSwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvblVwZGF0ZShyb290MywgcXVldWUsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrVXBkYXRlSW5EZXZUb29scyhmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpIHsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICByZXR1cm4gZmliZXIgPT09IGN1cnJlbnRseVJlbmRlcmluZ0ZpYmVyJDEgfHwgYWx0ZXJuYXRlICE9PSBudWxsICYmIGFsdGVybmF0ZSA9PT0gY3VycmVudGx5UmVuZGVyaW5nRmliZXIkMTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVJlbmRlclBoYXNlVXBkYXRlKHF1ZXVlLCB1cGRhdGUpIHsKICAgICAgICAgIGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGVEdXJpbmdUaGlzUGFzcyA9IGRpZFNjaGVkdWxlUmVuZGVyUGhhc2VVcGRhdGUgPSB0cnVlOwogICAgICAgICAgdmFyIHBlbmRpbmcgPSBxdWV1ZS5wZW5kaW5nOwogICAgICAgICAgaWYgKHBlbmRpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgdXBkYXRlLm5leHQgPSB1cGRhdGU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB1cGRhdGUubmV4dCA9IHBlbmRpbmcubmV4dDsKICAgICAgICAgICAgcGVuZGluZy5uZXh0ID0gdXBkYXRlOwogICAgICAgICAgfQogICAgICAgICAgcXVldWUucGVuZGluZyA9IHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW50YW5nbGVUcmFuc2l0aW9uVXBkYXRlKHJvb3QzLCBxdWV1ZSwgbGFuZSkgewogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbkxhbmUobGFuZSkpIHsKICAgICAgICAgICAgdmFyIHF1ZXVlTGFuZXMgPSBxdWV1ZS5sYW5lczsKICAgICAgICAgICAgcXVldWVMYW5lcyA9IGludGVyc2VjdExhbmVzKHF1ZXVlTGFuZXMsIHJvb3QzLnBlbmRpbmdMYW5lcyk7CiAgICAgICAgICAgIHZhciBuZXdRdWV1ZUxhbmVzID0gbWVyZ2VMYW5lcyhxdWV1ZUxhbmVzLCBsYW5lKTsKICAgICAgICAgICAgcXVldWUubGFuZXMgPSBuZXdRdWV1ZUxhbmVzOwogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbmV3UXVldWVMYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtVcGRhdGVJbkRldlRvb2xzKGZpYmVyLCBsYW5lLCBhY3Rpb24pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1N0YXRlVXBkYXRlU2NoZWR1bGVkKGZpYmVyLCBsYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIENvbnRleHRPbmx5RGlzcGF0Y2hlciA9IHsKICAgICAgICAgIHJlYWRDb250ZXh0LAogICAgICAgICAgdXNlQ2FsbGJhY2s6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUNvbnRleHQ6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZUVmZmVjdDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VMYXlvdXRFZmZlY3Q6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZU1lbW86IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVJlZHVjZXI6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVJlZjogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdXNlU3RhdGU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZURlYnVnVmFsdWU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVRyYW5zaXRpb246IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IHRocm93SW52YWxpZEhvb2tFcnJvciwKICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiB0aHJvd0ludmFsaWRIb29rRXJyb3IsCiAgICAgICAgICB1c2VJZDogdGhyb3dJbnZhbGlkSG9va0Vycm9yLAogICAgICAgICAgdW5zdGFibGVfaXNOZXdSZWNvbmNpbGVyOiBlbmFibGVOZXdSZWNvbmNpbGVyCiAgICAgICAgfTsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gbnVsbDsKICAgICAgICB2YXIgSG9va3NEaXNwYXRjaGVyT25Nb3VudFdpdGhIb29rVHlwZXNJbkRFViA9IG51bGw7CiAgICAgICAgdmFyIEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWID0gbnVsbDsKICAgICAgICB2YXIgSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSBudWxsOwogICAgICAgIHZhciBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWID0gbnVsbDsKICAgICAgICB7CiAgICAgICAgICB2YXIgd2FybkludmFsaWRDb250ZXh0QWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVycm9yKCJDb250ZXh0IGNhbiBvbmx5IGJlIHJlYWQgd2hpbGUgUmVhY3QgaXMgcmVuZGVyaW5nLiBJbiBjbGFzc2VzLCB5b3UgY2FuIHJlYWQgaXQgaW4gdGhlIHJlbmRlciBtZXRob2Qgb3IgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLiBJbiBmdW5jdGlvbiBjb21wb25lbnRzLCB5b3UgY2FuIHJlYWQgaXQgZGlyZWN0bHkgaW4gdGhlIGZ1bmN0aW9uIGJvZHksIGJ1dCBub3QgaW5zaWRlIEhvb2tzIGxpa2UgdXNlUmVkdWNlcigpIG9yIHVzZU1lbW8oKS4iKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgd2FybkludmFsaWRIb29rQWNjZXNzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGVycm9yKCJEbyBub3QgY2FsbCBIb29rcyBpbnNpZGUgdXNlRWZmZWN0KC4uLiksIHVzZU1lbW8oLi4uKSwgb3Igb3RoZXIgYnVpbHQtaW4gSG9va3MuIFlvdSBjYW4gb25seSBjYWxsIEhvb2tzIGF0IHRoZSB0b3AgbGV2ZWwgb2YgeW91ciBSZWFjdCBmdW5jdGlvbi4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZSBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcnVsZXMtb2YtaG9va3MiKTsKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICBjaGVja0RlcHNBcmVBcnJheURldihkZXBzKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgY2hlY2tEZXBzQXJlQXJyYXlEZXYoZGVwcyk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIGNoZWNrRGVwc0FyZUFycmF5RGV2KGRlcHMpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPbk1vdW50V2l0aEhvb2tUeXBlc0luREVWID0gewogICAgICAgICAgICByZWFkQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ2FsbGJhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ2FsbGJhY2siOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudENhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudEltcGVyYXRpdmVIYW5kbGUocmVmLCBjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbnNlcnRpb25FZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUluc2VydGlvbkVmZmVjdCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFJlZihpbml0aWFsVmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudFRyYW5zaXRpb24oKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTXV0YWJsZVNvdXJjZTogZnVuY3Rpb24oc291cmNlLCBnZXRTbmFwc2hvdCwgc3Vic2NyaWJlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTXV0YWJsZVNvdXJjZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudElkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN0YXRlKGluaXRpYWxTdGF0ZTEzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlYnVnVmFsdWU6IGZ1bmN0aW9uKHZhbHVlLCBmb3JtYXR0ZXJGbikgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlYnVnVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVEZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlVHJhbnNpdGlvbigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNdXRhYmxlU291cmNlOiBmdW5jdGlvbihzb3VyY2UsIGdldFNuYXBzaG90LCBzdWJzY3JpYmUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNdXRhYmxlU291cmNlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVN5bmNFeHRlcm5hbFN0b3JlKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSWQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uUmVyZW5kZXJJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiByZXJlbmRlclJlZHVjZXIocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWY6IGZ1bmN0aW9uKGluaXRpYWxWYWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZiI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZVJlZigpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTdGF0ZTogZnVuY3Rpb24oaW5pdGlhbFN0YXRlMTMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTdGF0ZSI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25SZXJlbmRlckluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlckRlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPbk1vdW50SW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRDYWxsYmFjayhjYWxsYmFjaywgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDb250ZXh0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUltcGVyYXRpdmVIYW5kbGU6IGZ1bmN0aW9uKHJlZiwgY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW1wZXJhdGl2ZUhhbmRsZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiBtb3VudExheW91dEVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VNZW1vOiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VNZW1vIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TWVtbyhjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVkdWNlcjogZnVuY3Rpb24ocmVkdWNlciwgaW5pdGlhbEFyZywgaW5pdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVJlZHVjZXIiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25Nb3VudEluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbW91bnRSZWR1Y2VyKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlUmVmOiBmdW5jdGlvbihpbml0aWFsVmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWYiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50UmVmKGluaXRpYWxWYWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICBtb3VudEhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uTW91bnRJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIG1vdW50U3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWJ1Z1ZhbHVlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZURlZmVycmVkVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVmZXJyZWRWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnREZWZlcnJlZFZhbHVlKHZhbHVlKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlVHJhbnNpdGlvbjogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlVHJhbnNpdGlvbiI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIG1vdW50SG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50TXV0YWJsZVNvdXJjZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VTeW5jRXh0ZXJuYWxTdG9yZTogZnVuY3Rpb24oc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VTeW5jRXh0ZXJuYWxTdG9yZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRTeW5jRXh0ZXJuYWxTdG9yZShzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgbW91bnRIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJZCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1bnN0YWJsZV9pc05ld1JlY29uY2lsZXI6IGVuYWJsZU5ld1JlY29uY2lsZXIKICAgICAgICAgIH07CiAgICAgICAgICBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFViA9IHsKICAgICAgICAgICAgcmVhZENvbnRleHQ6IGZ1bmN0aW9uKGNvbnRleHQpIHsKICAgICAgICAgICAgICB3YXJuSW52YWxpZENvbnRleHRBY2Nlc3MoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVhZENvbnRleHQoY29udGV4dCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUNhbGxiYWNrOiBmdW5jdGlvbihjYWxsYmFjaywgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNhbGxiYWNrIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ2FsbGJhY2soY2FsbGJhY2ssIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlQ29udGV4dCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VFZmZlY3Q6IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUVmZmVjdCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUVmZmVjdChjcmVhdGUsIGRlcHMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VJbXBlcmF0aXZlSGFuZGxlOiBmdW5jdGlvbihyZWYsIGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUltcGVyYXRpdmVIYW5kbGUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbXBlcmF0aXZlSGFuZGxlKHJlZiwgY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW5zZXJ0aW9uRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVJbnNlcnRpb25FZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTGF5b3V0RWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYXlvdXRFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlTWVtbzogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTWVtbyI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1lbW8oY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZHVjZXI6IGZ1bmN0aW9uKHJlZHVjZXIsIGluaXRpYWxBcmcsIGluaXQpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VSZWR1Y2VyIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3RhdGUoaW5pdGlhbFN0YXRlMTMpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IHByZXZEaXNwYXRjaGVyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVidWdWYWx1ZTogZnVuY3Rpb24odmFsdWUsIGZvcm1hdHRlckZuKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlRGVidWdWYWx1ZSI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZURlYnVnVmFsdWUoKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRGVmZXJyZWRWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWZlcnJlZFZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVmZXJyZWRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVRyYW5zaXRpb24iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICAgIEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblJlcmVuZGVySW5ERVYgPSB7CiAgICAgICAgICAgIHJlYWRDb250ZXh0OiBmdW5jdGlvbihjb250ZXh0KSB7CiAgICAgICAgICAgICAgd2FybkludmFsaWRDb250ZXh0QWNjZXNzKCk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VDYWxsYmFjazogZnVuY3Rpb24oY2FsbGJhY2ssIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VDYWxsYmFjayI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNhbGxiYWNrKGNhbGxiYWNrLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlQ29udGV4dDogZnVuY3Rpb24oY29udGV4dCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZUNvbnRleHQiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZWFkQ29udGV4dChjb250ZXh0KTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlRWZmZWN0OiBmdW5jdGlvbihjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVFZmZlY3QoY3JlYXRlLCBkZXBzKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXNlSW1wZXJhdGl2ZUhhbmRsZTogZnVuY3Rpb24ocmVmLCBjcmVhdGUsIGRlcHMpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJbXBlcmF0aXZlSGFuZGxlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW1wZXJhdGl2ZUhhbmRsZShyZWYsIGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUluc2VydGlvbkVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlSW5zZXJ0aW9uRWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSW5zZXJ0aW9uRWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUxheW91dEVmZmVjdDogZnVuY3Rpb24oY3JlYXRlLCBkZXBzKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlTGF5b3V0RWZmZWN0IjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTGF5b3V0RWZmZWN0KGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU1lbW86IGZ1bmN0aW9uKGNyZWF0ZSwgZGVwcykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU1lbW8iOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50OwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gSW52YWxpZE5lc3RlZEhvb2tzRGlzcGF0Y2hlck9uVXBkYXRlSW5ERVY7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNZW1vKGNyZWF0ZSwgZGVwcyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VSZWR1Y2VyOiBmdW5jdGlvbihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVkdWNlciI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQ7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBJbnZhbGlkTmVzdGVkSG9va3NEaXNwYXRjaGVyT25VcGRhdGVJbkRFVjsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgcmV0dXJuIHJlcmVuZGVyUmVkdWNlcihyZWR1Y2VyLCBpbml0aWFsQXJnLCBpbml0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQxLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVJlZjogZnVuY3Rpb24oaW5pdGlhbFZhbHVlKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2tOYW1lSW5EZXYgPSAidXNlUmVmIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUmVmKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN0YXRlOiBmdW5jdGlvbihpbml0aWFsU3RhdGUxMykgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN0YXRlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICB2YXIgcHJldkRpc3BhdGNoZXIgPSBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudDsKICAgICAgICAgICAgICBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDEuY3VycmVudCA9IEludmFsaWROZXN0ZWRIb29rc0Rpc3BhdGNoZXJPblVwZGF0ZUluREVWOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJTdGF0ZShpbml0aWFsU3RhdGUxMyk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMS5jdXJyZW50ID0gcHJldkRpc3BhdGNoZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWJ1Z1ZhbHVlOiBmdW5jdGlvbih2YWx1ZSwgZm9ybWF0dGVyRm4pIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VEZWJ1Z1ZhbHVlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVidWdWYWx1ZSgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VEZWZlcnJlZFZhbHVlOiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZURlZmVycmVkVmFsdWUiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiByZXJlbmRlckRlZmVycmVkVmFsdWUodmFsdWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICB1c2VUcmFuc2l0aW9uOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VUcmFuc2l0aW9uIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gcmVyZW5kZXJUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZU11dGFibGVTb3VyY2U6IGZ1bmN0aW9uKHNvdXJjZSwgZ2V0U25hcHNob3QsIHN1YnNjcmliZSkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZU11dGFibGVTb3VyY2UiOwogICAgICAgICAgICAgIHdhcm5JbnZhbGlkSG9va0FjY2VzcygpOwogICAgICAgICAgICAgIHVwZGF0ZUhvb2tUeXBlc0RldigpOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVNdXRhYmxlU291cmNlKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZVN5bmNFeHRlcm5hbFN0b3JlOiBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCkgewogICAgICAgICAgICAgIGN1cnJlbnRIb29rTmFtZUluRGV2ID0gInVzZVN5bmNFeHRlcm5hbFN0b3JlIjsKICAgICAgICAgICAgICB3YXJuSW52YWxpZEhvb2tBY2Nlc3MoKTsKICAgICAgICAgICAgICB1cGRhdGVIb29rVHlwZXNEZXYoKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3luY0V4dGVybmFsU3RvcmUoc3Vic2NyaWJlLCBnZXRTbmFwc2hvdCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVzZUlkOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjdXJyZW50SG9va05hbWVJbkRldiA9ICJ1c2VJZCI7CiAgICAgICAgICAgICAgd2FybkludmFsaWRIb29rQWNjZXNzKCk7CiAgICAgICAgICAgICAgdXBkYXRlSG9va1R5cGVzRGV2KCk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUlkKCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVuc3RhYmxlX2lzTmV3UmVjb25jaWxlcjogZW5hYmxlTmV3UmVjb25jaWxlcgogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgdmFyIG5vdyQxID0gU2NoZWR1bGVyLnVuc3RhYmxlX25vdzsKICAgICAgICB2YXIgY29tbWl0VGltZSA9IDA7CiAgICAgICAgdmFyIGxheW91dEVmZmVjdFN0YXJ0VGltZSA9IC0xOwogICAgICAgIHZhciBwcm9maWxlclN0YXJ0VGltZSA9IC0xOwogICAgICAgIHZhciBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgdmFyIGN1cnJlbnRVcGRhdGVJc05lc3RlZCA9IGZhbHNlOwogICAgICAgIHZhciBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiBpc0N1cnJlbnRVcGRhdGVOZXN0ZWQoKSB7CiAgICAgICAgICByZXR1cm4gY3VycmVudFVwZGF0ZUlzTmVzdGVkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrTmVzdGVkVXBkYXRlU2NoZWR1bGVkKCkgewogICAgICAgICAgewogICAgICAgICAgICBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNldE5lc3RlZFVwZGF0ZUZsYWcoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRVcGRhdGVJc05lc3RlZCA9IGZhbHNlOwogICAgICAgICAgICBuZXN0ZWRVcGRhdGVTY2hlZHVsZWQgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3luY05lc3RlZFVwZGF0ZUZsYWcoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGN1cnJlbnRVcGRhdGVJc05lc3RlZCA9IG5lc3RlZFVwZGF0ZVNjaGVkdWxlZDsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlU2NoZWR1bGVkID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldENvbW1pdFRpbWUoKSB7CiAgICAgICAgICByZXR1cm4gY29tbWl0VGltZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb3JkQ29tbWl0VGltZSgpIHsKICAgICAgICAgIGNvbW1pdFRpbWUgPSBub3ckMSgpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdGFydFByb2ZpbGVyVGltZXIoZmliZXIpIHsKICAgICAgICAgIHByb2ZpbGVyU3RhcnRUaW1lID0gbm93JDEoKTsKICAgICAgICAgIGlmIChmaWJlci5hY3R1YWxTdGFydFRpbWUgPCAwKSB7CiAgICAgICAgICAgIGZpYmVyLmFjdHVhbFN0YXJ0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nKGZpYmVyKSB7CiAgICAgICAgICBwcm9maWxlclN0YXJ0VGltZSA9IC0xOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKGZpYmVyLCBvdmVycmlkZUJhc2VUaW1lKSB7CiAgICAgICAgICBpZiAocHJvZmlsZXJTdGFydFRpbWUgPj0gMCkgewogICAgICAgICAgICB2YXIgZWxhcHNlZFRpbWUgPSBub3ckMSgpIC0gcHJvZmlsZXJTdGFydFRpbWU7CiAgICAgICAgICAgIGZpYmVyLmFjdHVhbER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICBpZiAob3ZlcnJpZGVCYXNlVGltZSkgewogICAgICAgICAgICAgIGZpYmVyLnNlbGZCYXNlRHVyYXRpb24gPSBlbGFwc2VkVGltZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwcm9maWxlclN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaWJlcikgewogICAgICAgICAgaWYgKGxheW91dEVmZmVjdFN0YXJ0VGltZSA+PSAwKSB7CiAgICAgICAgICAgIHZhciBlbGFwc2VkVGltZSA9IG5vdyQxKCkgLSBsYXlvdXRFZmZlY3RTdGFydFRpbWU7CiAgICAgICAgICAgIGxheW91dEVmZmVjdFN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgICB2YXIgcGFyZW50RmliZXIgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgIHdoaWxlIChwYXJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHN3aXRjaCAocGFyZW50RmliZXIudGFnKSB7CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHJvb3QzLmVmZmVjdER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgICAgICB2YXIgcGFyZW50U3RhdGVOb2RlID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICBwYXJlbnRTdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gKz0gZWxhcHNlZFRpbWU7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb3JkUGFzc2l2ZUVmZmVjdER1cmF0aW9uKGZpYmVyKSB7CiAgICAgICAgICBpZiAocGFzc2l2ZUVmZmVjdFN0YXJ0VGltZSA+PSAwKSB7CiAgICAgICAgICAgIHZhciBlbGFwc2VkVGltZSA9IG5vdyQxKCkgLSBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lOwogICAgICAgICAgICBwYXNzaXZlRWZmZWN0U3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgd2hpbGUgKHBhcmVudEZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgcm9vdDMucGFzc2l2ZUVmZmVjdER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGlmIChwYXJlbnRTdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBwYXJlbnRTdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uICs9IGVsYXBzZWRUaW1lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpIHsKICAgICAgICAgIGxheW91dEVmZmVjdFN0YXJ0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCkgewogICAgICAgICAgcGFzc2l2ZUVmZmVjdFN0YXJ0VGltZSA9IG5vdyQxKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24oZmliZXIpIHsKICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgd2hpbGUgKGNoaWxkKSB7CiAgICAgICAgICAgIGZpYmVyLmFjdHVhbER1cmF0aW9uICs9IGNoaWxkLmFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVEZWZhdWx0UHJvcHMyKENvbXBvbmVudCwgYmFzZVByb3BzKSB7CiAgICAgICAgICBpZiAoQ29tcG9uZW50ICYmIENvbXBvbmVudC5kZWZhdWx0UHJvcHMpIHsKICAgICAgICAgICAgdmFyIHByb3BzID0gYXNzaWduMih7fSwgYmFzZVByb3BzKTsKICAgICAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IENvbXBvbmVudC5kZWZhdWx0UHJvcHM7CiAgICAgICAgICAgIGZvciAodmFyIHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGlmIChwcm9wc1twcm9wTmFtZV0gPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcHJvcHNbcHJvcE5hbWVdID0gZGVmYXVsdFByb3BzW3Byb3BOYW1lXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHByb3BzOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJhc2VQcm9wczsKICAgICAgICB9CiAgICAgICAgdmFyIGZha2VJbnRlcm5hbEluc3RhbmNlID0ge307CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFN0YXRlQXNzaWdubWVudEZvckNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5pbml0aWFsaXplZFN0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGU7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVuZGVmaW5lZERlcml2ZWRTdGF0ZTsKICAgICAgICB2YXIgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlOwogICAgICAgIHZhciB3YXJuT25JbnZhbGlkQ2FsbGJhY2s7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dERpcmVjdGx5QXNzaWduaW5nUHJvcHNUb1N0YXRlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDE7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dFVuaW5pdGlhbGl6ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0TGVnYWN5TGlmZWN5Y2xlc0FuZERlcml2ZWRTdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXREaXJlY3RseUFzc2lnbmluZ1Byb3BzVG9TdGF0ZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICBkaWRXYXJuQWJvdXRVbmRlZmluZWREZXJpdmVkU3RhdGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVBbmRDb250ZXh0VHlwZXMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgZGlkV2FybkFib3V0SW52YWxpZGF0ZUNvbnRleHRUeXBlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgICB2YXIgZGlkV2Fybk9uSW52YWxpZENhbGxiYWNrID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgIHdhcm5PbkludmFsaWRDYWxsYmFjayA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBjYWxsZXJOYW1lKSB7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayA9PT0gbnVsbCB8fCB0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGtleSA9IGNhbGxlck5hbWUgKyAiXyIgKyBjYWxsYmFjazsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2suaGFzKGtleSkpIHsKICAgICAgICAgICAgICBkaWRXYXJuT25JbnZhbGlkQ2FsbGJhY2suYWRkKGtleSk7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGVyTmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlID0gZnVuY3Rpb24odHlwZSwgcGFydGlhbFN0YXRlKSB7CiAgICAgICAgICAgIGlmIChwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlLmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5kZWZpbmVkRGVyaXZlZFN0YXRlLmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMoKTogQSB2YWxpZCBzdGF0ZSBvYmplY3QgKG9yIG51bGwpIG11c3QgYmUgcmV0dXJuZWQuIFlvdSBoYXZlIHJldHVybmVkIHVuZGVmaW5lZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZmFrZUludGVybmFsSW5zdGFuY2UsICJfcHJvY2Vzc0NoaWxkQ29udGV4dCIsIHsKICAgICAgICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIl9wcm9jZXNzQ2hpbGRDb250ZXh0IGlzIG5vdCBhdmFpbGFibGUgaW4gUmVhY3QgMTYrLiBUaGlzIGxpa2VseSBtZWFucyB5b3UgaGF2ZSBtdWx0aXBsZSBjb3BpZXMgb2YgUmVhY3QgYW5kIGFyZSBhdHRlbXB0aW5nIHRvIG5lc3QgYSBSZWFjdCAxNSB0cmVlIGluc2lkZSBhIFJlYWN0IDE2IHRyZWUgdXNpbmcgdW5zdGFibGVfcmVuZGVyU3VidHJlZUludG9Db250YWluZXIsIHdoaWNoIGlzbid0IHN1cHBvcnRlZC4gVHJ5IHRvIG1ha2Ugc3VyZSB5b3UgaGF2ZSBvbmx5IG9uZSBjb3B5IG9mIFJlYWN0IChhbmQgaWRlYWxseSwgc3dpdGNoIHRvIFJlYWN0RE9NLmNyZWF0ZVBvcnRhbCkuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgICAgT2JqZWN0LmZyZWV6ZShmYWtlSW50ZXJuYWxJbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXh0UHJvcHMpIHsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBwYXJ0aWFsU3RhdGUgPSBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMobmV4dFByb3BzLCBwcmV2U3RhdGUpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHBhcnRpYWxTdGF0ZSA9IGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyhuZXh0UHJvcHMsIHByZXZTdGF0ZSk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2Fybk9uVW5kZWZpbmVkRGVyaXZlZFN0YXRlKGN0b3IsIHBhcnRpYWxTdGF0ZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbWVtb2l6ZWRTdGF0ZSA9IHBhcnRpYWxTdGF0ZSA9PT0gbnVsbCB8fCBwYXJ0aWFsU3RhdGUgPT09IHZvaWQgMCA/IHByZXZTdGF0ZSA6IGFzc2lnbjIoe30sIHByZXZTdGF0ZSwgcGFydGlhbFN0YXRlKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubGFuZXMgPT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gd29ya0luUHJvZ3Jlc3MyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICB1cGRhdGVRdWV1ZS5iYXNlU3RhdGUgPSBtZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgY2xhc3NDb21wb25lbnRVcGRhdGVyID0gewogICAgICAgICAgaXNNb3VudGVkLAogICAgICAgICAgZW5xdWV1ZVNldFN0YXRlOiBmdW5jdGlvbihpbnN0LCBwYXlsb2FkLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ2KGluc3QpOwogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHBheWxvYWQ7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrKGNhbGxiYWNrLCAic2V0U3RhdGUiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtTdGF0ZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBlbnF1ZXVlUmVwbGFjZVN0YXRlOiBmdW5jdGlvbihpbnN0LCBwYXlsb2FkLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ2KGluc3QpOwogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgICB1cGRhdGUudGFnID0gUmVwbGFjZVN0YXRlOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IHBheWxvYWQ7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrKGNhbGxiYWNrLCAicmVwbGFjZVN0YXRlIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVVcGRhdGUoZmliZXIsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgZW50YW5nbGVUcmFuc2l0aW9ucyhyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrU3RhdGVVcGRhdGVTY2hlZHVsZWQoZmliZXIsIGxhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9LAogICAgICAgICAgZW5xdWV1ZUZvcmNlVXBkYXRlOiBmdW5jdGlvbihpbnN0LCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgZmliZXIgPSBnZXQ2KGluc3QpOwogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGZpYmVyKTsKICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgICB1cGRhdGUudGFnID0gRm9yY2VVcGRhdGU7CiAgICAgICAgICAgIGlmIChjYWxsYmFjayAhPT0gdm9pZCAwICYmIGNhbGxiYWNrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrKGNhbGxiYWNrLCAiZm9yY2VVcGRhdGUiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBsYW5lKTsKICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBmaWJlciwgbGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICBlbnRhbmdsZVRyYW5zaXRpb25zKHJvb3QzLCBmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtGb3JjZVVwZGF0ZVNjaGVkdWxlZChmaWJlciwgbGFuZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZSA9IGluc3RhbmNlLnNob3VsZENvbXBvbmVudFVwZGF0ZShuZXdQcm9wcywgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gaW5zdGFuY2Uuc2hvdWxkQ29tcG9uZW50VXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoc2hvdWxkVXBkYXRlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcy5zaG91bGRDb21wb25lbnRVcGRhdGUoKTogUmV0dXJuZWQgdW5kZWZpbmVkIGluc3RlYWQgb2YgYSBib29sZWFuIHZhbHVlLiBNYWtlIHN1cmUgdG8gcmV0dXJuIHRydWUgb3IgZmFsc2UuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNob3VsZFVwZGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdG9yLnByb3RvdHlwZSAmJiBjdG9yLnByb3RvdHlwZS5pc1B1cmVSZWFjdENvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm4gIXNoYWxsb3dFcXVhbDIob2xkUHJvcHMsIG5ld1Byb3BzKSB8fCAhc2hhbGxvd0VxdWFsMihvbGRTdGF0ZSwgbmV3U3RhdGUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrQ2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgdmFyIHJlbmRlclByZXNlbnQgPSBpbnN0YW5jZS5yZW5kZXI7CiAgICAgICAgICAgIGlmICghcmVuZGVyUHJlc2VudCkgewogICAgICAgICAgICAgIGlmIChjdG9yLnByb3RvdHlwZSAmJiB0eXBlb2YgY3Rvci5wcm90b3R5cGUucmVuZGVyID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogTm8gYHJlbmRlcmAgbWV0aG9kIGZvdW5kIG9uIHRoZSByZXR1cm5lZCBjb21wb25lbnQgaW5zdGFuY2U6IGRpZCB5b3UgYWNjaWRlbnRhbGx5IHJldHVybiBhbiBvYmplY3QgZnJvbSB0aGUgY29uc3RydWN0b3I/IiwgbmFtZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBObyBgcmVuZGVyYCBtZXRob2QgZm91bmQgb24gdGhlIHJldHVybmVkIGNvbXBvbmVudCBpbnN0YW5jZTogeW91IG1heSBoYXZlIGZvcmdvdHRlbiB0byBkZWZpbmUgYHJlbmRlcmAuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0YW5jZS5nZXRJbml0aWFsU3RhdGUgJiYgIWluc3RhbmNlLmdldEluaXRpYWxTdGF0ZS5pc1JlYWN0Q2xhc3NBcHByb3ZlZCAmJiAhaW5zdGFuY2Uuc3RhdGUpIHsKICAgICAgICAgICAgICBlcnJvcigiZ2V0SW5pdGlhbFN0YXRlIHdhcyBkZWZpbmVkIG9uICVzLCBhIHBsYWluIEphdmFTY3JpcHQgY2xhc3MuIFRoaXMgaXMgb25seSBzdXBwb3J0ZWQgZm9yIGNsYXNzZXMgY3JlYXRlZCB1c2luZyBSZWFjdC5jcmVhdGVDbGFzcy4gRGlkIHlvdSBtZWFuIHRvIGRlZmluZSBhIHN0YXRlIHByb3BlcnR5IGluc3RlYWQ/IiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmdldERlZmF1bHRQcm9wcyAmJiAhaW5zdGFuY2UuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyB3YXMgZGVmaW5lZCBvbiAlcywgYSBwbGFpbiBKYXZhU2NyaXB0IGNsYXNzLiBUaGlzIGlzIG9ubHkgc3VwcG9ydGVkIGZvciBjbGFzc2VzIGNyZWF0ZWQgdXNpbmcgUmVhY3QuY3JlYXRlQ2xhc3MuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgZGVmYXVsdFByb3BzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BUeXBlcykgewogICAgICAgICAgICAgIGVycm9yKCJwcm9wVHlwZXMgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgcHJvcFR5cGVzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmNvbnRleHRUeXBlKSB7CiAgICAgICAgICAgICAgZXJyb3IoImNvbnRleHRUeXBlIHdhcyBkZWZpbmVkIGFzIGFuIGluc3RhbmNlIHByb3BlcnR5IG9uICVzLiBVc2UgYSBzdGF0aWMgcHJvcGVydHkgdG8gZGVmaW5lIGNvbnRleHRUeXBlIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChjdG9yLmNoaWxkQ29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuaGFzKGN0b3IpICYmIC8vIFN0cmljdCBNb2RlIGhhcyBpdHMgb3duIHdhcm5pbmcgZm9yIGxlZ2FjeSBjb250ZXh0LCBzbyB3ZSBjYW4gc2tpcAogICAgICAgICAgICAgIC8vIHRoaXMgb25lLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgdXNlcyB0aGUgbGVnYWN5IGNoaWxkQ29udGV4dFR5cGVzIEFQSSB3aGljaCBpcyBubyBsb25nZXIgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gdGhlIG5leHQgbWFqb3IgcmVsZWFzZS4gVXNlIFJlYWN0LmNyZWF0ZUNvbnRleHQoKSBpbnN0ZWFkXG5cbi5MZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvbGVnYWN5LWNvbnRleHQiLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGN0b3IuY29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRMZWdhY3lDb250ZXh0JDEuaGFzKGN0b3IpICYmIC8vIFN0cmljdCBNb2RlIGhhcyBpdHMgb3duIHdhcm5pbmcgZm9yIGxlZ2FjeSBjb250ZXh0LCBzbyB3ZSBjYW4gc2tpcAogICAgICAgICAgICAgIC8vIHRoaXMgb25lLgogICAgICAgICAgICAgICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUNvbnRleHQkMS5hZGQoY3Rvcik7CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgdXNlcyB0aGUgbGVnYWN5IGNvbnRleHRUeXBlcyBBUEkgd2hpY2ggaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IG1ham9yIHJlbGVhc2UuIFVzZSBSZWFjdC5jcmVhdGVDb250ZXh0KCkgd2l0aCBzdGF0aWMgY29udGV4dFR5cGUgaW5zdGVhZC5cblxuTGVhcm4gbW9yZSBhYm91dCB0aGlzIHdhcm5pbmcgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2xlZ2FjeS1jb250ZXh0IiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5jb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJjb250ZXh0VHlwZXMgd2FzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgcHJvcGVydHkgb24gJXMuIFVzZSBhIHN0YXRpYyBwcm9wZXJ0eSB0byBkZWZpbmUgY29udGV4dFR5cGVzIGluc3RlYWQuIiwgbmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdG9yLmNvbnRleHRUeXBlICYmIGN0b3IuY29udGV4dFR5cGVzICYmICFkaWRXYXJuQWJvdXRDb250ZXh0VHlwZUFuZENvbnRleHRUeXBlcy5oYXMoY3RvcikpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dENvbnRleHRUeXBlQW5kQ29udGV4dFR5cGVzLmFkZChjdG9yKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBkZWNsYXJlcyBib3RoIGNvbnRleHRUeXBlcyBhbmQgY29udGV4dFR5cGUgc3RhdGljIHByb3BlcnRpZXMuIFRoZSBsZWdhY3kgY29udGV4dFR5cGVzIHByb3BlcnR5IHdpbGwgYmUgaWdub3JlZC4iLCBuYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRTaG91bGRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBjb21wb25lbnRTaG91bGRVcGRhdGUoKS4gRGlkIHlvdSBtZWFuIHNob3VsZENvbXBvbmVudFVwZGF0ZSgpPyBUaGUgbmFtZSBpcyBwaHJhc2VkIGFzIGEgcXVlc3Rpb24gYmVjYXVzZSB0aGUgZnVuY3Rpb24gaXMgZXhwZWN0ZWQgdG8gcmV0dXJuIGEgdmFsdWUuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGN0b3IucHJvdG90eXBlICYmIGN0b3IucHJvdG90eXBlLmlzUHVyZVJlYWN0Q29tcG9uZW50ICYmIHR5cGVvZiBpbnN0YW5jZS5zaG91bGRDb21wb25lbnRVcGRhdGUgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgc2hvdWxkQ29tcG9uZW50VXBkYXRlKCkuIHNob3VsZENvbXBvbmVudFVwZGF0ZSBzaG91bGQgbm90IGJlIHVzZWQgd2hlbiBleHRlbmRpbmcgUmVhY3QuUHVyZUNvbXBvbmVudC4gUGxlYXNlIGV4dGVuZCBSZWFjdC5Db21wb25lbnQgaWYgc2hvdWxkQ29tcG9uZW50VXBkYXRlIGlzIHVzZWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJBIHB1cmUgY29tcG9uZW50Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50RGlkVW5tb3VudCgpLiBCdXQgdGhlcmUgaXMgbm8gc3VjaCBsaWZlY3ljbGUgbWV0aG9kLiBEaWQgeW91IG1lYW4gY29tcG9uZW50V2lsbFVubW91bnQoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlcyBoYXMgYSBtZXRob2QgY2FsbGVkIGNvbXBvbmVudERpZFJlY2VpdmVQcm9wcygpLiBCdXQgdGhlcmUgaXMgbm8gc3VjaCBsaWZlY3ljbGUgbWV0aG9kLiBJZiB5b3UgbWVhbnQgdG8gdXBkYXRlIHRoZSBzdGF0ZSBpbiByZXNwb25zZSB0byBjaGFuZ2luZyBwcm9wcywgdXNlIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKS4gSWYgeW91IG1lYW50IHRvIGZldGNoIGRhdGEgb3IgcnVuIHNpZGUtZWZmZWN0cyBvciBtdXRhdGlvbnMgYWZ0ZXIgUmVhY3QgaGFzIHVwZGF0ZWQgdGhlIFVJLCB1c2UgY29tcG9uZW50RGlkVXBkYXRlKCkuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjaWV2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzIGhhcyBhIG1ldGhvZCBjYWxsZWQgY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcygpLiBEaWQgeW91IG1lYW4gY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcygpPyIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNpZXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMgaGFzIGEgbWV0aG9kIGNhbGxlZCBVTlNBRkVfY29tcG9uZW50V2lsbFJlY2lldmVQcm9wcygpLiBEaWQgeW91IG1lYW4gVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMoKT8iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzTXV0YXRlZFByb3BzID0gaW5zdGFuY2UucHJvcHMgIT09IG5ld1Byb3BzOwogICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IHZvaWQgMCAmJiBoYXNNdXRhdGVkUHJvcHMpIHsKICAgICAgICAgICAgICBlcnJvcigiJXMoLi4uKTogV2hlbiBjYWxsaW5nIHN1cGVyKCkgaW4gYCVzYCwgbWFrZSBzdXJlIHRvIHBhc3MgdXAgdGhlIHNhbWUgcHJvcHMgdGhhdCB5b3VyIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yIHdhcyBwYXNzZWQuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RhbmNlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIGVycm9yKCJTZXR0aW5nIGRlZmF1bHRQcm9wcyBhcyBhbiBpbnN0YW5jZSBwcm9wZXJ0eSBvbiAlcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlZmluZSBkZWZhdWx0UHJvcHMgYXMgYSBzdGF0aWMgcHJvcGVydHkgb24gJXMuIiwgbmFtZSwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlICE9PSAiZnVuY3Rpb24iICYmICFkaWRXYXJuQWJvdXRHZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZVdpdGhvdXREaWRVcGRhdGUuaGFzKGN0b3IpKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2V0U25hcHNob3RCZWZvcmVVcGRhdGVXaXRob3V0RGlkVXBkYXRlLmFkZChjdG9yKTsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldFNuYXBzaG90QmVmb3JlVXBkYXRlKCkgc2hvdWxkIGJlIHVzZWQgd2l0aCBjb21wb25lbnREaWRVcGRhdGUoKS4gVGhpcyBjb21wb25lbnQgZGVmaW5lcyBnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIG9ubHkuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKCkgaXMgZGVmaW5lZCBhcyBhbiBpbnN0YW5jZSBtZXRob2QgYW5kIHdpbGwgYmUgaWdub3JlZC4gSW5zdGVhZCwgZGVjbGFyZSBpdCBhcyBhIHN0YXRpYyBtZXRob2QuIiwgbmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiJXM6IGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcigpIGlzIGRlZmluZWQgYXMgYW4gaW5zdGFuY2UgbWV0aG9kIGFuZCB3aWxsIGJlIGlnbm9yZWQuIEluc3RlYWQsIGRlY2xhcmUgaXQgYXMgYSBzdGF0aWMgbWV0aG9kLiIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY3Rvci5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGVycm9yKCIlczogZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUoKSBpcyBkZWZpbmVkIGFzIGEgc3RhdGljIG1ldGhvZCBhbmQgd2lsbCBiZSBpZ25vcmVkLiBJbnN0ZWFkLCBkZWNsYXJlIGl0IGFzIGFuIGluc3RhbmNlIG1ldGhvZC4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgX3N0YXRlID0gaW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICAgIGlmIChfc3RhdGUgJiYgKHR5cGVvZiBfc3RhdGUgIT09ICJvYmplY3QiIHx8IGlzQXJyYXkyKF9zdGF0ZSkpKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzLnN0YXRlOiBtdXN0IGJlIHNldCB0byBhbiBvYmplY3Qgb3IgbnVsbCIsIG5hbWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0Q2hpbGRDb250ZXh0ID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBjdG9yLmNoaWxkQ29udGV4dFR5cGVzICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIGVycm9yKCIlcy5nZXRDaGlsZENvbnRleHQoKTogY2hpbGRDb250ZXh0VHlwZXMgbXVzdCBiZSBkZWZpbmVkIGluIG9yZGVyIHRvIHVzZSBnZXRDaGlsZENvbnRleHQoKS4iLCBuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhZG9wdENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBpbnN0YW5jZSkgewogICAgICAgICAgaW5zdGFuY2UudXBkYXRlciA9IGNsYXNzQ29tcG9uZW50VXBkYXRlcjsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgIHNldDMoaW5zdGFuY2UsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIGluc3RhbmNlLl9yZWFjdEludGVybmFsSW5zdGFuY2UgPSBmYWtlSW50ZXJuYWxJbnN0YW5jZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHByb3BzKSB7CiAgICAgICAgICB2YXIgaXNMZWdhY3lDb250ZXh0Q29uc3VtZXIgPSBmYWxzZTsKICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICB2YXIgY29udGV4dCA9IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICgiY29udGV4dFR5cGUiIGluIGN0b3IpIHsKICAgICAgICAgICAgICB2YXIgaXNWYWxpZCA9ICgKICAgICAgICAgICAgICAgIC8vIEFsbG93IG51bGwgZm9yIGNvbmRpdGlvbmFsIGRlY2xhcmF0aW9uCiAgICAgICAgICAgICAgICBjb250ZXh0VHlwZSA9PT0gbnVsbCB8fCBjb250ZXh0VHlwZSAhPT0gdm9pZCAwICYmIGNvbnRleHRUeXBlLiQkdHlwZW9mID09PSBSRUFDVF9DT05URVhUX1RZUEUgJiYgY29udGV4dFR5cGUuX2NvbnRleHQgPT09IHZvaWQgMAogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgaWYgKCFpc1ZhbGlkICYmICFkaWRXYXJuQWJvdXRJbnZhbGlkYXRlQ29udGV4dFR5cGUuaGFzKGN0b3IpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRJbnZhbGlkYXRlQ29udGV4dFR5cGUuYWRkKGN0b3IpOwogICAgICAgICAgICAgICAgdmFyIGFkZGVuZHVtID0gIiI7CiAgICAgICAgICAgICAgICBpZiAoY29udGV4dFR5cGUgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgSG93ZXZlciwgaXQgaXMgc2V0IHRvIHVuZGVmaW5lZC4gVGhpcyBjYW4gYmUgY2F1c2VkIGJ5IGEgdHlwbyBvciBieSBtaXhpbmcgdXAgbmFtZWQgYW5kIGRlZmF1bHQgaW1wb3J0cy4gVGhpcyBjYW4gYWxzbyBoYXBwZW4gZHVlIHRvIGEgY2lyY3VsYXIgZGVwZW5kZW5jeSwgc28gdHJ5IG1vdmluZyB0aGUgY3JlYXRlQ29udGV4dCgpIGNhbGwgdG8gYSBzZXBhcmF0ZSBmaWxlLiI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBjb250ZXh0VHlwZSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgICAgYWRkZW5kdW0gPSAiIEhvd2V2ZXIsIGl0IGlzIHNldCB0byBhICIgKyB0eXBlb2YgY29udGV4dFR5cGUgKyAiLiI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRleHRUeXBlLiQkdHlwZW9mID09PSBSRUFDVF9QUk9WSURFUl9UWVBFKSB7CiAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBEaWQgeW91IGFjY2lkZW50YWxseSBwYXNzIHRoZSBDb250ZXh0LlByb3ZpZGVyIGluc3RlYWQ/IjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29udGV4dFR5cGUuX2NvbnRleHQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgcGFzcyB0aGUgQ29udGV4dC5Db25zdW1lciBpbnN0ZWFkPyI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBhZGRlbmR1bSA9ICIgSG93ZXZlciwgaXQgaXMgc2V0IHRvIGFuIG9iamVjdCB3aXRoIGtleXMgeyIgKyBPYmplY3Qua2V5cyhjb250ZXh0VHlwZSkuam9pbigiLCAiKSArICJ9LiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlcnJvcigiJXMgZGVmaW5lcyBhbiBpbnZhbGlkIGNvbnRleHRUeXBlLiBjb250ZXh0VHlwZSBzaG91bGQgcG9pbnQgdG8gdGhlIENvbnRleHQgb2JqZWN0IHJldHVybmVkIGJ5IFJlYWN0LmNyZWF0ZUNvbnRleHQoKS4lcyIsIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IiwgYWRkZW5kdW0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgY29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHRydWUpOwogICAgICAgICAgICB2YXIgY29udGV4dFR5cGVzID0gY3Rvci5jb250ZXh0VHlwZXM7CiAgICAgICAgICAgIGlzTGVnYWN5Q29udGV4dENvbnN1bWVyID0gY29udGV4dFR5cGVzICE9PSBudWxsICYmIGNvbnRleHRUeXBlcyAhPT0gdm9pZCAwOwogICAgICAgICAgICBjb250ZXh0ID0gaXNMZWdhY3lDb250ZXh0Q29uc3VtZXIgPyBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KSA6IGVtcHR5Q29udGV4dE9iamVjdDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG5ldyBjdG9yKHByb3BzLCBjb250ZXh0KTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZSA9IG5ldyBjdG9yKHByb3BzLCBjb250ZXh0KTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSAhPT0gbnVsbCAmJiBpbnN0YW5jZS5zdGF0ZSAhPT0gdm9pZCAwID8gaW5zdGFuY2Uuc3RhdGUgOiBudWxsOwogICAgICAgICAgYWRvcHRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iICYmIHN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoY3RvcikgfHwgIkNvbXBvbmVudCI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVbmluaXRpYWxpemVkU3RhdGUuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRVbmluaXRpYWxpemVkU3RhdGUuYWRkKGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZXJyb3IoImAlc2AgdXNlcyBgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzYCBidXQgaXRzIGluaXRpYWwgc3RhdGUgaXMgJXMuIFRoaXMgaXMgbm90IHJlY29tbWVuZGVkLiBJbnN0ZWFkLCBkZWZpbmUgdGhlIGluaXRpYWwgc3RhdGUgYnkgYXNzaWduaW5nIGFuIG9iamVjdCB0byBgdGhpcy5zdGF0ZWAgaW4gdGhlIGNvbnN0cnVjdG9yIG9mIGAlc2AuIFRoaXMgZW5zdXJlcyB0aGF0IGBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHNgIGFyZ3VtZW50cyBoYXZlIGEgY29uc2lzdGVudCBzaGFwZS4iLCBjb21wb25lbnROYW1lLCBpbnN0YW5jZS5zdGF0ZSA9PT0gbnVsbCA/ICJudWxsIiA6ICJ1bmRlZmluZWQiLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgZm91bmRXaWxsTW91bnROYW1lID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSA9IG51bGw7CiAgICAgICAgICAgICAgdmFyIGZvdW5kV2lsbFVwZGF0ZU5hbWUgPSBudWxsOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iICYmIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudC5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxNb3VudE5hbWUgPSAiY29tcG9uZW50V2lsbE1vdW50IjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxNb3VudE5hbWUgPSAiVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiAmJiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzLl9fc3VwcHJlc3NEZXByZWNhdGlvbldhcm5pbmcgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgPSAiY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyI7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgPSAiVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgJiYgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVwZGF0ZS5fX3N1cHByZXNzRGVwcmVjYXRpb25XYXJuaW5nICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxVcGRhdGVOYW1lID0gImNvbXBvbmVudFdpbGxVcGRhdGUiOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBmb3VuZFdpbGxVcGRhdGVOYW1lID0gIlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZvdW5kV2lsbE1vdW50TmFtZSAhPT0gbnVsbCB8fCBmb3VuZFdpbGxSZWNlaXZlUHJvcHNOYW1lICE9PSBudWxsIHx8IGZvdW5kV2lsbFVwZGF0ZU5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShjdG9yKSB8fCAiQ29tcG9uZW50IjsKICAgICAgICAgICAgICAgIHZhciBuZXdBcGlOYW1lID0gdHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iID8gImdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcygpIiA6ICJnZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpIjsKICAgICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TGVnYWN5TGlmZWN5Y2xlc0FuZERlcml2ZWRTdGF0ZS5oYXMoX2NvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dExlZ2FjeUxpZmVjeWNsZXNBbmREZXJpdmVkU3RhdGUuYWRkKF9jb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVuc2FmZSBsZWdhY3kgbGlmZWN5Y2xlcyB3aWxsIG5vdCBiZSBjYWxsZWQgZm9yIGNvbXBvbmVudHMgdXNpbmcgbmV3IGNvbXBvbmVudCBBUElzLlxuXG4lcyB1c2VzICVzIGJ1dCBhbHNvIGNvbnRhaW5zIHRoZSBmb2xsb3dpbmcgbGVnYWN5IGxpZmVjeWNsZXM6JXMlcyVzXG5cblRoZSBhYm92ZSBsaWZlY3ljbGVzIHNob3VsZCBiZSByZW1vdmVkLiBMZWFybiBtb3JlIGFib3V0IHRoaXMgd2FybmluZyBoZXJlOlxuaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3Vuc2FmZS1jb21wb25lbnQtbGlmZWN5Y2xlcyIsIF9jb21wb25lbnROYW1lLCBuZXdBcGlOYW1lLCBmb3VuZFdpbGxNb3VudE5hbWUgIT09IG51bGwgPyAiXG4gICIgKyBmb3VuZFdpbGxNb3VudE5hbWUgOiAiIiwgZm91bmRXaWxsUmVjZWl2ZVByb3BzTmFtZSAhPT0gbnVsbCA/ICJcbiAgIiArIGZvdW5kV2lsbFJlY2VpdmVQcm9wc05hbWUgOiAiIiwgZm91bmRXaWxsVXBkYXRlTmFtZSAhPT0gbnVsbCA/ICJcbiAgIiArIGZvdW5kV2lsbFVwZGF0ZU5hbWUgOiAiIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoaXNMZWdhY3lDb250ZXh0Q29uc3VtZXIpIHsKICAgICAgICAgICAgY2FjaGVDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0LCBjb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBpbnN0YW5jZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FsbENvbXBvbmVudFdpbGxNb3VudCh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKSB7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSBpbnN0YW5jZS5zdGF0ZTsKICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChvbGRTdGF0ZSAhPT0gaW5zdGFuY2Uuc3RhdGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGVycm9yKCIlcy5jb21wb25lbnRXaWxsTW91bnQoKTogQXNzaWduaW5nIGRpcmVjdGx5IHRvIHRoaXMuc3RhdGUgaXMgZGVwcmVjYXRlZCAoZXhjZXB0IGluc2lkZSBhIGNvbXBvbmVudCdzIGNvbnN0cnVjdG9yKS4gVXNlIHNldFN0YXRlIGluc3RlYWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJDb21wb25lbnQiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjbGFzc0NvbXBvbmVudFVwZGF0ZXIuZW5xdWV1ZVJlcGxhY2VTdGF0ZShpbnN0YW5jZSwgaW5zdGFuY2Uuc3RhdGUsIG51bGwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpIHsKICAgICAgICAgIHZhciBvbGRTdGF0ZSA9IGluc3RhbmNlLnN0YXRlOwogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV3UHJvcHMsIG5leHRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV3UHJvcHMsIG5leHRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSAhPT0gb2xkU3RhdGUpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcih3b3JrSW5Qcm9ncmVzczIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50Lmhhcyhjb21wb25lbnROYW1lKSkgewogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0U3RhdGVBc3NpZ25tZW50Rm9yQ29tcG9uZW50LmFkZChjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGVycm9yKCIlcy5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKCk6IEFzc2lnbmluZyBkaXJlY3RseSB0byB0aGlzLnN0YXRlIGlzIGRlcHJlY2F0ZWQgKGV4Y2VwdCBpbnNpZGUgYSBjb21wb25lbnQncyBjb25zdHJ1Y3RvcikuIFVzZSBzZXRTdGF0ZSBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjbGFzc0NvbXBvbmVudFVwZGF0ZXIuZW5xdWV1ZVJlcGxhY2VTdGF0ZShpbnN0YW5jZSwgaW5zdGFuY2Uuc3RhdGUsIG51bGwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGNoZWNrQ2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICBpbnN0YW5jZS5wcm9wcyA9IG5ld1Byb3BzOwogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGluc3RhbmNlLnJlZnMgPSB7fTsKICAgICAgICAgIGluaXRpYWxpemVVcGRhdGVRdWV1ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIGNvbnRleHRUeXBlID0gY3Rvci5jb250ZXh0VHlwZTsKICAgICAgICAgIGlmICh0eXBlb2YgY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIGNvbnRleHRUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbnRleHQgPSByZWFkQ29udGV4dChjb250ZXh0VHlwZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgdW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlID09PSBuZXdQcm9wcykgewogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGN0b3IpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RGlyZWN0bHlBc3NpZ25pbmdQcm9wc1RvU3RhdGUuaGFzKGNvbXBvbmVudE5hbWUpKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXREaXJlY3RseUFzc2lnbmluZ1Byb3BzVG9TdGF0ZS5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IEl0IGlzIG5vdCByZWNvbW1lbmRlZCB0byBhc3NpZ24gcHJvcHMgZGlyZWN0bHkgdG8gc3RhdGUgYmVjYXVzZSB1cGRhdGVzIHRvIHByb3BzIHdvbid0IGJlIHJlZmxlY3RlZCBpbiBzdGF0ZS4gSW4gbW9zdCBjYXNlcywgaXQgaXMgYmV0dGVyIHRvIHVzZSBwcm9wcyBkaXJlY3RseS4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLnJlY29yZExlZ2FjeUNvbnRleHRXYXJuaW5nKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBSZWFjdFN0cmljdE1vZGVXYXJuaW5ncy5yZWNvcmRVbnNhZmVMaWZlY3ljbGVXYXJuaW5ncyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaW5zdGFuY2Uuc3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPSBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wczsKICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzICE9PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSAhPT0gImZ1bmN0aW9uIiAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCA9PT0gImZ1bmN0aW9uIikpIHsKICAgICAgICAgICAgY2FsbENvbXBvbmVudFdpbGxNb3VudCh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlKTsKICAgICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTGF5b3V0U3RhdGljOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgIGZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IGZpYmVyRmxhZ3M7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc3VtZU1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIG5ld1Byb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICB2YXIgb2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gb2xkUHJvcHM7CiAgICAgICAgICB2YXIgb2xkQ29udGV4dCA9IGluc3RhbmNlLmNvbnRleHQ7CiAgICAgICAgICB2YXIgY29udGV4dFR5cGUgPSBjdG9yLmNvbnRleHRUeXBlOwogICAgICAgICAgdmFyIG5leHRDb250ZXh0ID0gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0VHlwZSA9PT0gIm9iamVjdCIgJiYgY29udGV4dFR5cGUgIT09IG51bGwpIHsKICAgICAgICAgICAgbmV4dENvbnRleHQgPSByZWFkQ29udGV4dChjb250ZXh0VHlwZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgbmV4dExlZ2FjeVVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIGN0b3IsIHRydWUpOwogICAgICAgICAgICBuZXh0Q29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBuZXh0TGVnYWN5VW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPSBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wczsKICAgICAgICAgIHZhciBoYXNOZXdMaWZlY3ljbGVzID0gdHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICBpZiAoIWhhc05ld0xpZmVjeWNsZXMgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyA9PT0gImZ1bmN0aW9uIikpIHsKICAgICAgICAgICAgaWYgKG9sZFByb3BzICE9PSBuZXdQcm9wcyB8fCBvbGRDb250ZXh0ICE9PSBuZXh0Q29udGV4dCkgewogICAgICAgICAgICAgIGNhbGxDb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKHdvcmtJblByb2dyZXNzMiwgaW5zdGFuY2UsIG5ld1Byb3BzLCBuZXh0Q29udGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJlc2V0SGFzRm9yY2VVcGRhdGVCZWZvcmVQcm9jZXNzaW5nKCk7CiAgICAgICAgICB2YXIgb2xkU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGluc3RhbmNlLnN0YXRlID0gb2xkU3RhdGU7CiAgICAgICAgICBwcm9jZXNzVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyLCBuZXdQcm9wcywgaW5zdGFuY2UsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICBuZXdTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKG9sZFByb3BzID09PSBuZXdQcm9wcyAmJiBvbGRTdGF0ZSA9PT0gbmV3U3RhdGUgJiYgIWhhc0NvbnRleHRDaGFuZ2VkKCkgJiYgIWNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSkgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIGZpYmVyRmxhZ3MgPSBVcGRhdGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgZmliZXJGbGFncyB8PSBNb3VudExheW91dERldjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IGZpYmVyRmxhZ3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgYXBwbHlEZXJpdmVkU3RhdGVGcm9tUHJvcHMod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBnZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMsIG5ld1Byb3BzKTsKICAgICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBzaG91bGRVcGRhdGUgPSBjaGVja0hhc0ZvcmNlVXBkYXRlQWZ0ZXJQcm9jZXNzaW5nKCkgfHwgY2hlY2tTaG91bGRDb21wb25lbnRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBvbGRQcm9wcywgbmV3UHJvcHMsIG9sZFN0YXRlLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICBpZiAoIWhhc05ld0xpZmVjeWNsZXMgJiYgKHR5cGVvZiBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbE1vdW50ID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxNb3VudCgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBfZmliZXJGbGFncyA9IFVwZGF0ZTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBfZmliZXJGbGFncyB8PSBMYXlvdXRTdGF0aWM7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RFZmZlY3RzTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBfZmliZXJGbGFnczsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBfZmliZXJGbGFnczIgPSBVcGRhdGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgX2ZpYmVyRmxhZ3MyIHw9IExheW91dFN0YXRpYzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFN0cmljdEVmZmVjdHNNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBfZmliZXJGbGFnczIgfD0gTW91bnRMYXlvdXREZXY7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBfZmliZXJGbGFnczI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IG5leHRDb250ZXh0OwogICAgICAgICAgcmV0dXJuIHNob3VsZFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ2xhc3NJbnN0YW5jZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBjdG9yLCBuZXdQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgY2xvbmVVcGRhdGVRdWV1ZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHZhciB1bnJlc29sdmVkT2xkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHZhciBvbGRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi50eXBlID09PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPyB1bnJlc29sdmVkT2xkUHJvcHMgOiByZXNvbHZlRGVmYXVsdFByb3BzMih3b3JrSW5Qcm9ncmVzczIudHlwZSwgdW5yZXNvbHZlZE9sZFByb3BzKTsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gb2xkUHJvcHM7CiAgICAgICAgICB2YXIgdW5yZXNvbHZlZE5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBvbGRDb250ZXh0ID0gaW5zdGFuY2UuY29udGV4dDsKICAgICAgICAgIHZhciBjb250ZXh0VHlwZSA9IGN0b3IuY29udGV4dFR5cGU7CiAgICAgICAgICB2YXIgbmV4dENvbnRleHQgPSBlbXB0eUNvbnRleHRPYmplY3Q7CiAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHRUeXBlID09PSAib2JqZWN0IiAmJiBjb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICBuZXh0Q29udGV4dCA9IHJlYWRDb250ZXh0KGNvbnRleHRUeXBlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBuZXh0VW5tYXNrZWRDb250ZXh0ID0gZ2V0VW5tYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgY3RvciwgdHJ1ZSk7CiAgICAgICAgICAgIG5leHRDb250ZXh0ID0gZ2V0TWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIG5leHRVbm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcyA9IGN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzOwogICAgICAgICAgdmFyIGhhc05ld0xpZmVjeWNsZXMgPSB0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIjsKICAgICAgICAgIGlmICghaGFzTmV3TGlmZWN5Y2xlcyAmJiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iIHx8IHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzID09PSAiZnVuY3Rpb24iKSkgewogICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSB1bnJlc29sdmVkTmV3UHJvcHMgfHwgb2xkQ29udGV4dCAhPT0gbmV4dENvbnRleHQpIHsKICAgICAgICAgICAgICBjYWxsQ29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyh3b3JrSW5Qcm9ncmVzczIsIGluc3RhbmNlLCBuZXdQcm9wcywgbmV4dENvbnRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXNldEhhc0ZvcmNlVXBkYXRlQmVmb3JlUHJvY2Vzc2luZygpOwogICAgICAgICAgdmFyIG9sZFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgbmV3U3RhdGUgPSBpbnN0YW5jZS5zdGF0ZSA9IG9sZFN0YXRlOwogICAgICAgICAgcHJvY2Vzc1VwZGF0ZVF1ZXVlKHdvcmtJblByb2dyZXNzMiwgbmV3UHJvcHMsIGluc3RhbmNlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgbmV3U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgPT09IHVucmVzb2x2ZWROZXdQcm9wcyAmJiBvbGRTdGF0ZSA9PT0gbmV3U3RhdGUgJiYgIWhhc0NvbnRleHRDaGFuZ2VkKCkgJiYgIWNoZWNrSGFzRm9yY2VVcGRhdGVBZnRlclByb2Nlc3NpbmcoKSAmJiAhZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbikgewogICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZFVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBpZiAodW5yZXNvbHZlZE9sZFByb3BzICE9PSBjdXJyZW50NC5tZW1vaXplZFByb3BzIHx8IG9sZFN0YXRlICE9PSBjdXJyZW50NC5tZW1vaXplZFN0YXRlKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGFwcGx5RGVyaXZlZFN0YXRlRnJvbVByb3BzKHdvcmtJblByb2dyZXNzMiwgY3RvciwgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzLCBuZXdQcm9wcyk7CiAgICAgICAgICAgIG5ld1N0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgc2hvdWxkVXBkYXRlID0gY2hlY2tIYXNGb3JjZVVwZGF0ZUFmdGVyUHJvY2Vzc2luZygpIHx8IGNoZWNrU2hvdWxkQ29tcG9uZW50VXBkYXRlKHdvcmtJblByb2dyZXNzMiwgY3Rvciwgb2xkUHJvcHMsIG5ld1Byb3BzLCBvbGRTdGF0ZSwgbmV3U3RhdGUsIG5leHRDb250ZXh0KSB8fCAvLyBUT0RPOiBJbiBzb21lIGNhc2VzLCB3ZSdsbCBlbmQgdXAgY2hlY2tpbmcgaWYgY29udGV4dCBoYXMgY2hhbmdlZCB0d2ljZSwKICAgICAgICAgIC8vIGJvdGggYmVmb3JlIGFuZCBhZnRlciBgc2hvdWxkQ29tcG9uZW50VXBkYXRlYCBoYXMgYmVlbiBjYWxsZWQuIE5vdCBpZGVhbCwKICAgICAgICAgIC8vIGJ1dCBJJ20gbG9hdGggdG8gcmVmYWN0b3IgdGhpcyBmdW5jdGlvbi4gVGhpcyBvbmx5IGhhcHBlbnMgZm9yIG1lbW9pemVkCiAgICAgICAgICAvLyBjb21wb25lbnRzIHNvIGl0J3Mgbm90IHRoYXQgY29tbW9uLgogICAgICAgICAgZW5hYmxlTGF6eUNvbnRleHRQcm9wYWdhdGlvbjsKICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCFoYXNOZXdMaWZlY3ljbGVzICYmICh0eXBlb2YgaW5zdGFuY2UuVU5TQUZFX2NvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVcGRhdGUgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnRXaWxsVXBkYXRlKG5ld1Byb3BzLCBuZXdTdGF0ZSwgbmV4dENvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLlVOU0FGRV9jb21wb25lbnRXaWxsVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpbnN0YW5jZS5VTlNBRkVfY29tcG9uZW50V2lsbFVwZGF0ZShuZXdQcm9wcywgbmV3U3RhdGUsIG5leHRDb250ZXh0KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5jb21wb25lbnREaWRVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gU25hcHNob3Q7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgaWYgKHVucmVzb2x2ZWRPbGRQcm9wcyAhPT0gY3VycmVudDQubWVtb2l6ZWRQcm9wcyB8fCBvbGRTdGF0ZSAhPT0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGlmICh1bnJlc29sdmVkT2xkUHJvcHMgIT09IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgfHwgb2xkU3RhdGUgIT09IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTbmFwc2hvdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBuZXdQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gbmV3UHJvcHM7CiAgICAgICAgICBpbnN0YW5jZS5zdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgaW5zdGFuY2UuY29udGV4dCA9IG5leHRDb250ZXh0OwogICAgICAgICAgcmV0dXJuIHNob3VsZFVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIodmFsdWUsIHNvdXJjZSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdmFsdWUsCiAgICAgICAgICAgIHNvdXJjZSwKICAgICAgICAgICAgc3RhY2s6IGdldFN0YWNrQnlGaWJlckluRGV2QW5kUHJvZChzb3VyY2UpLAogICAgICAgICAgICBkaWdlc3Q6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNhcHR1cmVkVmFsdWUodmFsdWUsIGRpZ2VzdCwgc3RhY2spIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICBzb3VyY2U6IG51bGwsCiAgICAgICAgICAgIHN0YWNrOiBzdGFjayAhPSBudWxsID8gc3RhY2sgOiBudWxsLAogICAgICAgICAgICBkaWdlc3Q6IGRpZ2VzdCAhPSBudWxsID8gZGlnZXN0IDogbnVsbAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvd0Vycm9yRGlhbG9nKGJvdW5kYXJ5LCBlcnJvckluZm8pIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBsb2dDYXB0dXJlZEVycm9yKGJvdW5kYXJ5LCBlcnJvckluZm8pIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHZhciBsb2dFcnJvciA9IHNob3dFcnJvckRpYWxvZyhib3VuZGFyeSwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgaWYgKGxvZ0Vycm9yID09PSBmYWxzZSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZXJyb3IyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICBpZiAodHJ1ZSkgewogICAgICAgICAgICAgIHZhciBzb3VyY2UgPSBlcnJvckluZm8uc291cmNlOwogICAgICAgICAgICAgIHZhciBzdGFjayA9IGVycm9ySW5mby5zdGFjazsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSBzdGFjayAhPT0gbnVsbCA/IHN0YWNrIDogIiI7CiAgICAgICAgICAgICAgaWYgKGVycm9yMiAhPSBudWxsICYmIGVycm9yMi5fc3VwcHJlc3NMb2dnaW5nKSB7CiAgICAgICAgICAgICAgICBpZiAoYm91bmRhcnkudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gc291cmNlID8gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihzb3VyY2UpIDogbnVsbDsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZU1lc3NhZ2UgPSBjb21wb25lbnROYW1lID8gIlRoZSBhYm92ZSBlcnJvciBvY2N1cnJlZCBpbiB0aGUgPCIgKyBjb21wb25lbnROYW1lICsgIj4gY29tcG9uZW50OiIgOiAiVGhlIGFib3ZlIGVycm9yIG9jY3VycmVkIGluIG9uZSBvZiB5b3VyIFJlYWN0IGNvbXBvbmVudHM6IjsKICAgICAgICAgICAgICB2YXIgZXJyb3JCb3VuZGFyeU1lc3NhZ2U7CiAgICAgICAgICAgICAgaWYgKGJvdW5kYXJ5LnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgICAgIGVycm9yQm91bmRhcnlNZXNzYWdlID0gIkNvbnNpZGVyIGFkZGluZyBhbiBlcnJvciBib3VuZGFyeSB0byB5b3VyIHRyZWUgdG8gY3VzdG9taXplIGVycm9yIGhhbmRsaW5nIGJlaGF2aW9yLlxuVmlzaXQgaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL2Vycm9yLWJvdW5kYXJpZXMgdG8gbGVhcm4gbW9yZSBhYm91dCBlcnJvciBib3VuZGFyaWVzLiI7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBlcnJvckJvdW5kYXJ5TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoYm91bmRhcnkpIHx8ICJBbm9ueW1vdXMiOwogICAgICAgICAgICAgICAgZXJyb3JCb3VuZGFyeU1lc3NhZ2UgPSAiUmVhY3Qgd2lsbCB0cnkgdG8gcmVjcmVhdGUgdGhpcyBjb21wb25lbnQgdHJlZSBmcm9tIHNjcmF0Y2ggIiArICgidXNpbmcgdGhlIGVycm9yIGJvdW5kYXJ5IHlvdSBwcm92aWRlZCwgIiArIGVycm9yQm91bmRhcnlOYW1lICsgIi4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGNvbWJpbmVkTWVzc2FnZSA9IGNvbXBvbmVudE5hbWVNZXNzYWdlICsgIlxuIiArIGNvbXBvbmVudFN0YWNrICsgIlxuXG4iICsgKCIiICsgZXJyb3JCb3VuZGFyeU1lc3NhZ2UpOwogICAgICAgICAgICAgIGNvbnNvbGVbImVycm9yIl0oY29tYmluZWRNZXNzYWdlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBlOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCQxID0gdHlwZW9mIFdlYWtNYXAgPT09ICJmdW5jdGlvbiIgPyBXZWFrTWFwIDogTWFwOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3RFcnJvclVwZGF0ZShmaWJlciwgZXJyb3JJbmZvLCBsYW5lKSB7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKE5vVGltZXN0YW1wLCBsYW5lKTsKICAgICAgICAgIHVwZGF0ZS50YWcgPSBDYXB0dXJlVXBkYXRlOwogICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSB7CiAgICAgICAgICAgIGVsZW1lbnQ6IG51bGwKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZXJyb3IyID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIG9uVW5jYXVnaHRFcnJvcihlcnJvcjIpOwogICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiB1cGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgbGFuZSkgewogICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShOb1RpbWVzdGFtcCwgbGFuZSk7CiAgICAgICAgICB1cGRhdGUudGFnID0gQ2FwdHVyZVVwZGF0ZTsKICAgICAgICAgIHZhciBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPSBmaWJlci50eXBlLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvcjsKICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHZhciBlcnJvciQxID0gZXJyb3JJbmZvLnZhbHVlOwogICAgICAgICAgICB1cGRhdGUucGF5bG9hZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHJldHVybiBnZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IoZXJyb3IkMSk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hcmtGYWlsZWRFcnJvckJvdW5kYXJ5Rm9ySG90UmVsb2FkaW5nKGZpYmVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbG9nQ2FwdHVyZWRFcnJvcihmaWJlciwgZXJyb3JJbmZvKTsKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpbnN0ID0gZmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgaWYgKGluc3QgIT09IG51bGwgJiYgdHlwZW9mIGluc3QuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gZnVuY3Rpb24gY2FsbGJhY2soKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFya0ZhaWxlZEVycm9yQm91bmRhcnlGb3JIb3RSZWxvYWRpbmcoZmliZXIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBsb2dDYXB0dXJlZEVycm9yKGZpYmVyLCBlcnJvckluZm8pOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBtYXJrTGVnYWN5RXJyb3JCb3VuZGFyeUFzRmFpbGVkKHRoaXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXJyb3IkMTIgPSBlcnJvckluZm8udmFsdWU7CiAgICAgICAgICAgICAgdmFyIHN0YWNrID0gZXJyb3JJbmZvLnN0YWNrOwogICAgICAgICAgICAgIHRoaXMuY29tcG9uZW50RGlkQ2F0Y2goZXJyb3IkMTIsIHsKICAgICAgICAgICAgICAgIGNvbXBvbmVudFN0YWNrOiBzdGFjayAhPT0gbnVsbCA/IHN0YWNrIDogIiIKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGdldERlcml2ZWRTdGF0ZUZyb21FcnJvciAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUoZmliZXIubGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogRXJyb3IgYm91bmRhcmllcyBzaG91bGQgaW1wbGVtZW50IGdldERlcml2ZWRTdGF0ZUZyb21FcnJvcigpLiBJbiB0aGF0IG1ldGhvZCwgcmV0dXJuIGEgc3RhdGUgdXBkYXRlIHRvIGRpc3BsYXkgYW4gZXJyb3IgbWVzc2FnZSBvciBmYWxsYmFjayBVSS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpYmVyKSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHVwZGF0ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0YWNoUGluZ0xpc3RlbmVyKHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBwaW5nQ2FjaGUgPSByb290My5waW5nQ2FjaGU7CiAgICAgICAgICB2YXIgdGhyZWFkSURzOwogICAgICAgICAgaWYgKHBpbmdDYWNoZSA9PT0gbnVsbCkgewogICAgICAgICAgICBwaW5nQ2FjaGUgPSByb290My5waW5nQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwJDEoKTsKICAgICAgICAgICAgdGhyZWFkSURzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgcGluZ0NhY2hlLnNldCh3YWtlYWJsZSwgdGhyZWFkSURzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocmVhZElEcyA9IHBpbmdDYWNoZS5nZXQod2FrZWFibGUpOwogICAgICAgICAgICBpZiAodGhyZWFkSURzID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0aHJlYWRJRHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICAgIHBpbmdDYWNoZS5zZXQod2FrZWFibGUsIHRocmVhZElEcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICghdGhyZWFkSURzLmhhcyhsYW5lcykpIHsKICAgICAgICAgICAgdGhyZWFkSURzLmFkZChsYW5lcyk7CiAgICAgICAgICAgIHZhciBwaW5nID0gcGluZ1N1c3BlbmRlZFJvb3QuYmluZChudWxsLCByb290Mywgd2FrZWFibGUsIGxhbmVzKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YWtlYWJsZS50aGVuKHBpbmcsIHBpbmcpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRhY2hSZXRyeUxpc3RlbmVyKHN1c3BlbnNlQm91bmRhcnksIHJvb3QzLCB3YWtlYWJsZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSBzdXNwZW5zZUJvdW5kYXJ5LnVwZGF0ZVF1ZXVlOwogICAgICAgICAgaWYgKHdha2VhYmxlcyA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogICAgICAgICAgICB1cGRhdGVRdWV1ZS5hZGQod2FrZWFibGUpOwogICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LnVwZGF0ZVF1ZXVlID0gdXBkYXRlUXVldWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3YWtlYWJsZXMuYWRkKHdha2VhYmxlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRTdXNwZW5kZWRDb21wb25lbnQoc291cmNlRmliZXIsIHJvb3RSZW5kZXJMYW5lcykgewogICAgICAgICAgdmFyIHRhZyA9IHNvdXJjZUZpYmVyLnRhZzsKICAgICAgICAgIGlmICgoc291cmNlRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmICh0YWcgPT09IEZ1bmN0aW9uQ29tcG9uZW50IHx8IHRhZyA9PT0gRm9yd2FyZFJlZjIgfHwgdGFnID09PSBTaW1wbGVNZW1vQ29tcG9uZW50KSkgewogICAgICAgICAgICB2YXIgY3VycmVudFNvdXJjZSA9IHNvdXJjZUZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnRTb3VyY2UpIHsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci51cGRhdGVRdWV1ZSA9IGN1cnJlbnRTb3VyY2UudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgc291cmNlRmliZXIubWVtb2l6ZWRTdGF0ZSA9IGN1cnJlbnRTb3VyY2UubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5sYW5lcyA9IGN1cnJlbnRTb3VyY2UubGFuZXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgc291cmNlRmliZXIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldE5lYXJlc3RTdXNwZW5zZUJvdW5kYXJ5VG9DYXB0dXJlKHJldHVybkZpYmVyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IHJldHVybkZpYmVyOwogICAgICAgICAgZG8gewogICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50ICYmIHNob3VsZENhcHR1cmVTdXNwZW5zZShub2RlKSkgewogICAgICAgICAgICAgIHJldHVybiBub2RlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5vZGUgPSBub2RlLnJldHVybjsKICAgICAgICAgIH0gd2hpbGUgKG5vZGUgIT09IG51bGwpOwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtTdXNwZW5zZUJvdW5kYXJ5U2hvdWxkQ2FwdHVyZShzdXNwZW5zZUJvdW5kYXJ5LCByZXR1cm5GaWJlciwgc291cmNlRmliZXIsIHJvb3QzLCByb290UmVuZGVyTGFuZXMpIHsKICAgICAgICAgIGlmICgoc3VzcGVuc2VCb3VuZGFyeS5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgaWYgKHN1c3BlbnNlQm91bmRhcnkgPT09IHJldHVybkZpYmVyKSB7CiAgICAgICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBTaG91bGRDYXB0dXJlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHN1c3BlbnNlQm91bmRhcnkuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICBzb3VyY2VGaWJlci5mbGFncyB8PSBGb3JjZVVwZGF0ZUZvckxlZ2FjeVN1c3BlbnNlOwogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmZsYWdzICY9IH4oTGlmZWN5Y2xlRWZmZWN0TWFzayB8IEluY29tcGxldGUpOwogICAgICAgICAgICAgIGlmIChzb3VyY2VGaWJlci50YWcgPT09IENsYXNzQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFNvdXJjZUZpYmVyID0gc291cmNlRmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRTb3VyY2VGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzb3VyY2VGaWJlci50YWcgPSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlVXBkYXRlKE5vVGltZXN0YW1wLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZS50YWcgPSBGb3JjZVVwZGF0ZTsKICAgICAgICAgICAgICAgICAgZW5xdWV1ZVVwZGF0ZShzb3VyY2VGaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHNvdXJjZUZpYmVyLmxhbmVzID0gbWVyZ2VMYW5lcyhzb3VyY2VGaWJlci5sYW5lcywgU3luY0xhbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzdXNwZW5zZUJvdW5kYXJ5OwogICAgICAgICAgfQogICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5mbGFncyB8PSBTaG91bGRDYXB0dXJlOwogICAgICAgICAgc3VzcGVuc2VCb3VuZGFyeS5sYW5lcyA9IHJvb3RSZW5kZXJMYW5lczsKICAgICAgICAgIHJldHVybiBzdXNwZW5zZUJvdW5kYXJ5OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0aHJvd0V4Y2VwdGlvbihyb290MywgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCB2YWx1ZSwgcm9vdFJlbmRlckxhbmVzKSB7CiAgICAgICAgICBzb3VyY2VGaWJlci5mbGFncyB8PSBJbmNvbXBsZXRlOwogICAgICAgICAgewogICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCByb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB0eXBlb2YgdmFsdWUudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB2YXIgd2FrZWFibGUgPSB2YWx1ZTsKICAgICAgICAgICAgcmVzZXRTdXNwZW5kZWRDb21wb25lbnQoc291cmNlRmliZXIpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgc291cmNlRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICAgICAgICBtYXJrRGlkVGhyb3dXaGlsZUh5ZHJhdGluZ0RFVigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc3VzcGVuc2VCb3VuZGFyeSA9IGdldE5lYXJlc3RTdXNwZW5zZUJvdW5kYXJ5VG9DYXB0dXJlKHJldHVybkZpYmVyKTsKICAgICAgICAgICAgaWYgKHN1c3BlbnNlQm91bmRhcnkgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzdXNwZW5zZUJvdW5kYXJ5LmZsYWdzICY9IH5Gb3JjZUNsaWVudFJlbmRlcjsKICAgICAgICAgICAgICBtYXJrU3VzcGVuc2VCb3VuZGFyeVNob3VsZENhcHR1cmUoc3VzcGVuc2VCb3VuZGFyeSwgcmV0dXJuRmliZXIsIHNvdXJjZUZpYmVyLCByb290Mywgcm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VCb3VuZGFyeS5tb2RlICYgQ29uY3VycmVudE1vZGUpIHsKICAgICAgICAgICAgICAgIGF0dGFjaFBpbmdMaXN0ZW5lcihyb290Mywgd2FrZWFibGUsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGF0dGFjaFJldHJ5TGlzdGVuZXIoc3VzcGVuc2VCb3VuZGFyeSwgcm9vdDMsIHdha2VhYmxlKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgaWYgKCFpbmNsdWRlc1N5bmNMYW5lKHJvb3RSZW5kZXJMYW5lcykpIHsKICAgICAgICAgICAgICAgIGF0dGFjaFBpbmdMaXN0ZW5lcihyb290Mywgd2FrZWFibGUsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB1bmNhdWdodFN1c3BlbnNlRXJyb3IgPSBuZXcgRXJyb3IoIkEgY29tcG9uZW50IHN1c3BlbmRlZCB3aGlsZSByZXNwb25kaW5nIHRvIHN5bmNocm9ub3VzIGlucHV0LiBUaGlzIHdpbGwgY2F1c2UgdGhlIFVJIHRvIGJlIHJlcGxhY2VkIHdpdGggYSBsb2FkaW5nIGluZGljYXRvci4gVG8gZml4LCB1cGRhdGVzIHRoYXQgc3VzcGVuZCBzaG91bGQgYmUgd3JhcHBlZCB3aXRoIHN0YXJ0VHJhbnNpdGlvbi4iKTsKICAgICAgICAgICAgICB2YWx1ZSA9IHVuY2F1Z2h0U3VzcGVuc2VFcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgc291cmNlRmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICAgICAgbWFya0RpZFRocm93V2hpbGVIeWRyYXRpbmdERVYoKTsKICAgICAgICAgICAgICB2YXIgX3N1c3BlbnNlQm91bmRhcnkgPSBnZXROZWFyZXN0U3VzcGVuc2VCb3VuZGFyeVRvQ2FwdHVyZShyZXR1cm5GaWJlcik7CiAgICAgICAgICAgICAgaWYgKF9zdXNwZW5zZUJvdW5kYXJ5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoKF9zdXNwZW5zZUJvdW5kYXJ5LmZsYWdzICYgU2hvdWxkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgX3N1c3BlbnNlQm91bmRhcnkuZmxhZ3MgfD0gRm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtYXJrU3VzcGVuc2VCb3VuZGFyeVNob3VsZENhcHR1cmUoX3N1c3BlbnNlQm91bmRhcnksIHJldHVybkZpYmVyLCBzb3VyY2VGaWJlciwgcm9vdDMsIHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICBxdWV1ZUh5ZHJhdGlvbkVycm9yKGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKHZhbHVlLCBzb3VyY2VGaWJlcikpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFsdWUgPSBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcih2YWx1ZSwgc291cmNlRmliZXIpOwogICAgICAgICAgcmVuZGVyRGlkRXJyb3IodmFsdWUpOwogICAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzMiA9IHJldHVybkZpYmVyOwogICAgICAgICAgZG8gewogICAgICAgICAgICBzd2l0Y2ggKHdvcmtJblByb2dyZXNzMi50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB2YXIgX2Vycm9ySW5mbyA9IHZhbHVlOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgICAgICB2YXIgbGFuZSA9IHBpY2tBcmJpdHJhcnlMYW5lKHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzMi5sYW5lcywgbGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlUm9vdEVycm9yVXBkYXRlKHdvcmtJblByb2dyZXNzMiwgX2Vycm9ySW5mbywgbGFuZSk7CiAgICAgICAgICAgICAgICBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCB1cGRhdGUpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgdmFyIGVycm9ySW5mbyA9IHZhbHVlOwogICAgICAgICAgICAgICAgdmFyIGN0b3IgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzICYmICh0eXBlb2YgY3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tRXJyb3IgPT09ICJmdW5jdGlvbiIgfHwgaW5zdGFuY2UgIT09IG51bGwgJiYgdHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudERpZENhdGNoID09PSAiZnVuY3Rpb24iICYmICFpc0FscmVhZHlGYWlsZWRMZWdhY3lFcnJvckJvdW5kYXJ5KGluc3RhbmNlKSkpIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNob3VsZENhcHR1cmU7CiAgICAgICAgICAgICAgICAgIHZhciBfbGFuZSA9IHBpY2tBcmJpdHJhcnlMYW5lKHJvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IG1lcmdlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzLCBfbGFuZSk7CiAgICAgICAgICAgICAgICAgIHZhciBfdXBkYXRlID0gY3JlYXRlQ2xhc3NFcnJvclVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIGVycm9ySW5mbywgX2xhbmUpOwogICAgICAgICAgICAgICAgICBlbnF1ZXVlQ2FwdHVyZWRVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBfdXBkYXRlKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyID0gd29ya0luUHJvZ3Jlc3MyLnJldHVybjsKICAgICAgICAgIH0gd2hpbGUgKHdvcmtJblByb2dyZXNzMiAhPT0gbnVsbCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldFN1c3BlbmRlZENhY2hlKCkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgZGlkUmVjZWl2ZVVwZGF0ZSA9IGZhbHNlOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRCYWRDbGFzczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0TW9kdWxlUGF0dGVybkNvbXBvbmVudDsKICAgICAgICB2YXIgZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50OwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRGdW5jdGlvblJlZnM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHM7CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFJldmVhbE9yZGVyOwogICAgICAgIHZhciBkaWRXYXJuQWJvdXRUYWlsT3B0aW9uczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudDsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRCYWRDbGFzcyA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0TW9kdWxlUGF0dGVybkNvbXBvbmVudCA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0Q29udGV4dFR5cGVPbkZ1bmN0aW9uQ29tcG9uZW50ID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRHZXREZXJpdmVkU3RhdGVPbkZ1bmN0aW9uQ29tcG9uZW50ID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRGdW5jdGlvblJlZnMgPSB7fTsKICAgICAgICAgIGRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMgPSBmYWxzZTsKICAgICAgICAgIGRpZFdhcm5BYm91dFJldmVhbE9yZGVyID0ge307CiAgICAgICAgICBkaWRXYXJuQWJvdXRUYWlsT3B0aW9ucyA9IHt9OwogICAgICAgICAgZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudCA9IHt9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG1vdW50Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBudWxsLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGN1cnJlbnQ0LmNoaWxkLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZvcmNlVW5tb3VudEN1cnJlbnRBbmRSZWNvbmNpbGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlY29uY2lsZUNoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgY3VycmVudDQuY2hpbGQsIG51bGwsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIG51bGwsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRm9yd2FyZFJlZihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgdmFyIGlubmVyUHJvcFR5cGVzID0gQ29tcG9uZW50LnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJlbmRlcjIgPSBDb21wb25lbnQucmVuZGVyOwogICAgICAgICAgdmFyIHJlZiA9IHdvcmtJblByb2dyZXNzMi5yZWY7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuOwogICAgICAgICAgdmFyIGhhc0lkOwogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyMiwgbmV4dFByb3BzLCByZWYsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKHRydWUpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSByZW5kZXJXaXRoSG9va3MoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyMiwgbmV4dFByb3BzLCByZWYsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgICBoYXNJZCA9IGNoZWNrRGlkUmVuZGVySWRIb29rKCk7CiAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsICYmICFkaWRSZWNlaXZlVXBkYXRlKSB7CiAgICAgICAgICAgIGJhaWxvdXRIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGdldElzSHlkcmF0aW5nKCkgJiYgaGFzSWQpIHsKICAgICAgICAgICAgcHVzaE1hdGVyaWFsaXplZFRyZWVJZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB2YXIgdHlwZSA9IENvbXBvbmVudC50eXBlOwogICAgICAgICAgICBpZiAoaXNTaW1wbGVGdW5jdGlvbkNvbXBvbmVudCh0eXBlKSAmJiBDb21wb25lbnQuY29tcGFyZSA9PT0gbnVsbCAmJiAvLyBTaW1wbGVNZW1vQ29tcG9uZW50IGNvZGVwYXRoIGRvZXNuJ3QgcmVzb2x2ZSBvdXRlciBwcm9wcyBlaXRoZXIuCiAgICAgICAgICAgIENvbXBvbmVudC5kZWZhdWx0UHJvcHMgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciByZXNvbHZlZFR5cGUgPSB0eXBlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRhZyA9IFNpbXBsZU1lbW9Db21wb25lbnQ7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSByZXNvbHZlZFR5cGU7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgdHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTaW1wbGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlc29sdmVkVHlwZSwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgICBpZiAoaW5uZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICBpbm5lclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgbmV4dFByb3BzLAogICAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKENvbXBvbmVudC5kZWZhdWx0UHJvcHMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCIlczogU3VwcG9ydCBmb3IgZGVmYXVsdFByb3BzIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIG1lbW8gY29tcG9uZW50cyBpbiBhIGZ1dHVyZSBtYWpvciByZWxlYXNlLiBVc2UgSmF2YVNjcmlwdCBkZWZhdWx0IHBhcmFtZXRlcnMgaW5zdGVhZC4iLCBjb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgZGlkV2FybkFib3V0RGVmYXVsdFByb3BzT25GdW5jdGlvbkNvbXBvbmVudFtjb21wb25lbnROYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGNyZWF0ZUZpYmVyRnJvbVR5cGVBbmRQcm9wcyhDb21wb25lbnQudHlwZSwgbnVsbCwgbmV4dFByb3BzLCB3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi5tb2RlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjaGlsZC5yZWYgPSB3b3JrSW5Qcm9ncmVzczIucmVmOwogICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGNoaWxkOwogICAgICAgICAgICByZXR1cm4gY2hpbGQ7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBfdHlwZSA9IENvbXBvbmVudC50eXBlOwogICAgICAgICAgICB2YXIgX2lubmVyUHJvcFR5cGVzID0gX3R5cGUucHJvcFR5cGVzOwogICAgICAgICAgICBpZiAoX2lubmVyUHJvcFR5cGVzKSB7CiAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICBfaW5uZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAvLyBSZXNvbHZlZCBwcm9wcwogICAgICAgICAgICAgICAgInByb3AiLAogICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKF90eXBlKQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBjdXJyZW50Q2hpbGQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgIHZhciBoYXNTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQgPSBjaGVja1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dChjdXJyZW50NCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIGlmICghaGFzU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KSB7CiAgICAgICAgICAgIHZhciBwcmV2UHJvcHMgPSBjdXJyZW50Q2hpbGQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgdmFyIGNvbXBhcmUgPSBDb21wb25lbnQuY29tcGFyZTsKICAgICAgICAgICAgY29tcGFyZSA9IGNvbXBhcmUgIT09IG51bGwgPyBjb21wYXJlIDogc2hhbGxvd0VxdWFsMjsKICAgICAgICAgICAgaWYgKGNvbXBhcmUocHJldlByb3BzLCBuZXh0UHJvcHMpICYmIGN1cnJlbnQ0LnJlZiA9PT0gd29ya0luUHJvZ3Jlc3MyLnJlZikgewogICAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBQZXJmb3JtZWRXb3JrOwogICAgICAgICAgdmFyIG5ld0NoaWxkID0gY3JlYXRlV29ya0luUHJvZ3Jlc3MoY3VycmVudENoaWxkLCBuZXh0UHJvcHMpOwogICAgICAgICAgbmV3Q2hpbGQucmVmID0gd29ya0luUHJvZ3Jlc3MyLnJlZjsKICAgICAgICAgIG5ld0NoaWxkLnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IG5ld0NoaWxkOwogICAgICAgICAgcmV0dXJuIG5ld0NoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTaW1wbGVNZW1vQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgb3V0ZXJNZW1vVHlwZSA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZTsKICAgICAgICAgICAgICBpZiAob3V0ZXJNZW1vVHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTEFaWV9UWVBFKSB7CiAgICAgICAgICAgICAgICB2YXIgbGF6eUNvbXBvbmVudCA9IG91dGVyTWVtb1R5cGU7CiAgICAgICAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBvdXRlck1lbW9UeXBlID0gaW5pdChwYXlsb2FkKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIG91dGVyTWVtb1R5cGUgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIG91dGVyUHJvcFR5cGVzID0gb3V0ZXJNZW1vVHlwZSAmJiBvdXRlck1lbW9UeXBlLnByb3BUeXBlczsKICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICBvdXRlclByb3BUeXBlcywKICAgICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgKFNpbXBsZU1lbW9Db21wb25lbnQgaGFzIG5vIGRlZmF1bHRQcm9wcykKICAgICAgICAgICAgICAgICAgICAicHJvcCIsCiAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKG91dGVyTWVtb1R5cGUpCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIGlmIChzaGFsbG93RXF1YWwyKHByZXZQcm9wcywgbmV4dFByb3BzKSAmJiBjdXJyZW50NC5yZWYgPT09IHdvcmtJblByb2dyZXNzMi5yZWYgJiYgLy8gUHJldmVudCBiYWlsb3V0IGlmIHRoZSBpbXBsZW1lbnRhdGlvbiBjaGFuZ2VkIGR1ZSB0byBob3QgcmVsb2FkLgogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9PT0gY3VycmVudDQudHlwZSkgewogICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzID0gbmV4dFByb3BzID0gcHJldlByb3BzOwogICAgICAgICAgICAgIGlmICghY2hlY2tTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQoY3VycmVudDQsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGN1cnJlbnQ0LmxhbmVzOwogICAgICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKChjdXJyZW50NC5mbGFncyAmIEZvcmNlVXBkYXRlRm9yTGVnYWN5U3VzcGVuc2UpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1cGRhdGVGdW5jdGlvbkNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlT2Zmc2NyZWVuQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQubWVtb2l6ZWRTdGF0ZSA6IG51bGw7CiAgICAgICAgICBpZiAobmV4dFByb3BzLm1vZGUgPT09ICJoaWRkZW4iIHx8IGVuYWJsZUxlZ2FjeUhpZGRlbikgewogICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgICB2YXIgbmV4dFN0YXRlID0gewogICAgICAgICAgICAgICAgYmFzZUxhbmVzOiBOb0xhbmVzLAogICAgICAgICAgICAgICAgY2FjaGVQb29sOiBudWxsLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbmV4dFN0YXRlOwogICAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCBPZmZzY3JlZW5MYW5lKSkgewogICAgICAgICAgICAgIHZhciBzcGF3bmVkQ2FjaGVQb29sID0gbnVsbDsKICAgICAgICAgICAgICB2YXIgbmV4dEJhc2VMYW5lczsKICAgICAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkJhc2VMYW5lcyA9IHByZXZTdGF0ZS5iYXNlTGFuZXM7CiAgICAgICAgICAgICAgICBuZXh0QmFzZUxhbmVzID0gbWVyZ2VMYW5lcyhwcmV2QmFzZUxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXh0QmFzZUxhbmVzID0gcmVuZGVyTGFuZXMyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyA9IGxhbmVUb0xhbmVzKE9mZnNjcmVlbkxhbmUpOwogICAgICAgICAgICAgIHZhciBfbmV4dFN0YXRlID0gewogICAgICAgICAgICAgICAgYmFzZUxhbmVzOiBuZXh0QmFzZUxhbmVzLAogICAgICAgICAgICAgICAgY2FjaGVQb29sOiBzcGF3bmVkQ2FjaGVQb29sLAogICAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gX25leHRTdGF0ZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIG5leHRCYXNlTGFuZXMpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfbmV4dFN0YXRlMiA9IHsKICAgICAgICAgICAgICAgIGJhc2VMYW5lczogTm9MYW5lcywKICAgICAgICAgICAgICAgIGNhY2hlUG9vbDogbnVsbCwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25zOiBudWxsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IF9uZXh0U3RhdGUyOwogICAgICAgICAgICAgIHZhciBzdWJ0cmVlUmVuZGVyTGFuZXMyID0gcHJldlN0YXRlICE9PSBudWxsID8gcHJldlN0YXRlLmJhc2VMYW5lcyA6IHJlbmRlckxhbmVzMjsKICAgICAgICAgICAgICBwdXNoUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyLCBzdWJ0cmVlUmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIF9zdWJ0cmVlUmVuZGVyTGFuZXM7CiAgICAgICAgICAgIGlmIChwcmV2U3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBfc3VidHJlZVJlbmRlckxhbmVzID0gbWVyZ2VMYW5lcyhwcmV2U3RhdGUuYmFzZUxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBfc3VidHJlZVJlbmRlckxhbmVzID0gcmVuZGVyTGFuZXMyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHB1c2hSZW5kZXJMYW5lcyh3b3JrSW5Qcm9ncmVzczIsIF9zdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRnJhZ21lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZU1vZGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVByb2ZpbGVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICBzdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JlZihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICB2YXIgcmVmID0gd29ya0luUHJvZ3Jlc3MyLnJlZjsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCAmJiByZWYgIT09IG51bGwgfHwgY3VycmVudDQgIT09IG51bGwgJiYgY3VycmVudDQucmVmICE9PSByZWYpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFJlZjI7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmU3RhdGljOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUZ1bmN0aW9uQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udGV4dDsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHVubWFza2VkQ29udGV4dCA9IGdldFVubWFza2VkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSk7CiAgICAgICAgICAgIGNvbnRleHQgPSBnZXRNYXNrZWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgdW5tYXNrZWRDb250ZXh0KTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW47CiAgICAgICAgICB2YXIgaGFzSWQ7CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdGFydGVkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IHJlbmRlcldpdGhIb29rcyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwgJiYgIWRpZFJlY2VpdmVVcGRhdGUpIHsKICAgICAgICAgICAgYmFpbG91dEhvb2tzKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIHJldHVybiBiYWlsb3V0T25BbHJlYWR5RmluaXNoZWRXb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBoYXNJZCkgewogICAgICAgICAgICBwdXNoTWF0ZXJpYWxpemVkVHJlZUlkKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNsYXNzQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChzaG91bGRFcnJvcih3b3JrSW5Qcm9ncmVzczIpKSB7CiAgICAgICAgICAgICAgY2FzZSBmYWxzZTogewogICAgICAgICAgICAgICAgdmFyIF9pbnN0YW5jZSA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB2YXIgY3RvciA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgICAgdmFyIHRlbXBJbnN0YW5jZSA9IG5ldyBjdG9yKHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzLCBfaW5zdGFuY2UuY29udGV4dCk7CiAgICAgICAgICAgICAgICB2YXIgc3RhdGUgPSB0ZW1wSW5zdGFuY2Uuc3RhdGU7CiAgICAgICAgICAgICAgICBfaW5zdGFuY2UudXBkYXRlci5lbnF1ZXVlU2V0U3RhdGUoX2luc3RhbmNlLCBzdGF0ZSwgbnVsbCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSB0cnVlOiB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBTaG91bGRDYXB0dXJlOwogICAgICAgICAgICAgICAgdmFyIGVycm9yJDEgPSBuZXcgRXJyb3IoIlNpbXVsYXRlZCBlcnJvciBjb21pbmcgZnJvbSBEZXZUb29scyIpOwogICAgICAgICAgICAgICAgdmFyIGxhbmUgPSBwaWNrQXJiaXRyYXJ5TGFuZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzczIubGFuZXMsIGxhbmUpOwogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUod29ya0luUHJvZ3Jlc3MyLCBjcmVhdGVDYXB0dXJlZFZhbHVlQXRGaWJlcihlcnJvciQxLCB3b3JrSW5Qcm9ncmVzczIpLCBsYW5lKTsKICAgICAgICAgICAgICAgIGVucXVldWVDYXB0dXJlZFVwZGF0ZSh3b3JrSW5Qcm9ncmVzczIsIHVwZGF0ZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi50eXBlICE9PSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5uZXJQcm9wVHlwZXMgPSBDb21wb25lbnQucHJvcFR5cGVzOwogICAgICAgICAgICAgIGlmIChpbm5lclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgY2hlY2tQcm9wVHlwZXMoCiAgICAgICAgICAgICAgICAgIGlubmVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICBuZXh0UHJvcHMsCiAgICAgICAgICAgICAgICAgIC8vIFJlc29sdmVkIHByb3BzCiAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaGFzQ29udGV4dDsKICAgICAgICAgIGlmIChpc0NvbnRleHRQcm92aWRlcihDb21wb25lbnQpKSB7CiAgICAgICAgICAgIGhhc0NvbnRleHQgPSB0cnVlOwogICAgICAgICAgICBwdXNoQ29udGV4dFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBoYXNDb250ZXh0ID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBwcmVwYXJlVG9SZWFkQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgaW5zdGFuY2UgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIHNob3VsZFVwZGF0ZTsKICAgICAgICAgIGlmIChpbnN0YW5jZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICBjb25zdHJ1Y3RDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMpOwogICAgICAgICAgICBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gcmVzdW1lTW91bnRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBuZXh0UHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzaG91bGRVcGRhdGUgPSB1cGRhdGVDbGFzc0luc3RhbmNlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5leHRVbml0T2ZXb3JrID0gZmluaXNoQ2xhc3NDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBzaG91bGRVcGRhdGUsIGhhc0NvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpbnN0ID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSAmJiBpbnN0LnByb3BzICE9PSBuZXh0UHJvcHMpIHsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJJdCBsb29rcyBsaWtlICVzIGlzIHJlYXNzaWduaW5nIGl0cyBvd24gYHRoaXMucHJvcHNgIHdoaWxlIHJlbmRlcmluZy4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkIGFuZCBjYW4gbGVhZCB0byBjb25mdXNpbmcgYnVncy4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzMikgfHwgImEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRpZFdhcm5BYm91dFJlYXNzaWduaW5nUHJvcHMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV4dFVuaXRPZldvcms7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmlzaENsYXNzQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgc2hvdWxkVXBkYXRlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIG1hcmtSZWYoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgZGlkQ2FwdHVyZUVycm9yID0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgaWYgKCFzaG91bGRVcGRhdGUgJiYgIWRpZENhcHR1cmVFcnJvcikgewogICAgICAgICAgICBpZiAoaGFzQ29udGV4dCkgewogICAgICAgICAgICAgIGludmFsaWRhdGVDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIGZhbHNlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHZhciBuZXh0Q2hpbGRyZW47CiAgICAgICAgICBpZiAoZGlkQ2FwdHVyZUVycm9yICYmIHR5cGVvZiBDb21wb25lbnQuZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIG5leHRDaGlsZHJlbiA9IG51bGw7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZygpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFJlbmRlclN0YXJ0ZWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcodHJ1ZSk7CiAgICAgICAgICAgICAgbmV4dENoaWxkcmVuID0gaW5zdGFuY2UucmVuZGVyKCk7CiAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5tb2RlICYgU3RyaWN0TGVnYWN5TW9kZSkgewogICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHModHJ1ZSk7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5yZW5kZXIoKTsKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgIHNldElzU3RyaWN0TW9kZUZvckRldnRvb2xzKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiBkaWRDYXB0dXJlRXJyb3IpIHsKICAgICAgICAgICAgZm9yY2VVbm1vdW50Q3VycmVudEFuZFJlY29uY2lsZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IGluc3RhbmNlLnN0YXRlOwogICAgICAgICAgaWYgKGhhc0NvbnRleHQpIHsKICAgICAgICAgICAgaW52YWxpZGF0ZUNvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoSG9zdFJvb3RDb250ZXh0KHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgdmFyIHJvb3QzID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgIGlmIChyb290My5wZW5kaW5nQ29udGV4dCkgewogICAgICAgICAgICBwdXNoVG9wTGV2ZWxDb250ZXh0T2JqZWN0KHdvcmtJblByb2dyZXNzMiwgcm9vdDMucGVuZGluZ0NvbnRleHQsIHJvb3QzLnBlbmRpbmdDb250ZXh0ICE9PSByb290My5jb250ZXh0KTsKICAgICAgICAgIH0gZWxzZSBpZiAocm9vdDMuY29udGV4dCkgewogICAgICAgICAgICBwdXNoVG9wTGV2ZWxDb250ZXh0T2JqZWN0KHdvcmtJblByb2dyZXNzMiwgcm9vdDMuY29udGV4dCwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgcHVzaEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyLCByb290My5jb250YWluZXJJbmZvKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlSG9zdFJvb3QoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBwdXNoSG9zdFJvb3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgaGF2ZSBhIGN1cnJlbnQgZmliZXIuIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciBwcmV2Q2hpbGRyZW4gPSBwcmV2U3RhdGUuZWxlbWVudDsKICAgICAgICAgIGNsb25lVXBkYXRlUXVldWUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICBwcm9jZXNzVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyLCBuZXh0UHJvcHMsIG51bGwsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB2YXIgbmV4dFN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB2YXIgcm9vdDMgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgdmFyIG5leHRDaGlsZHJlbiA9IG5leHRTdGF0ZS5lbGVtZW50OwogICAgICAgICAgaWYgKHByZXZTdGF0ZS5pc0RlaHlkcmF0ZWQpIHsKICAgICAgICAgICAgdmFyIG92ZXJyaWRlU3RhdGUgPSB7CiAgICAgICAgICAgICAgZWxlbWVudDogbmV4dENoaWxkcmVuLAogICAgICAgICAgICAgIGlzRGVoeWRyYXRlZDogZmFsc2UsCiAgICAgICAgICAgICAgY2FjaGU6IG5leHRTdGF0ZS5jYWNoZSwKICAgICAgICAgICAgICBwZW5kaW5nU3VzcGVuc2VCb3VuZGFyaWVzOiBuZXh0U3RhdGUucGVuZGluZ1N1c3BlbnNlQm91bmRhcmllcywKICAgICAgICAgICAgICB0cmFuc2l0aW9uczogbmV4dFN0YXRlLnRyYW5zaXRpb25zCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgdXBkYXRlUXVldWUuYmFzZVN0YXRlID0gb3ZlcnJpZGVTdGF0ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBvdmVycmlkZVN0YXRlOwogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRm9yY2VDbGllbnRSZW5kZXIpIHsKICAgICAgICAgICAgICB2YXIgcmVjb3ZlcmFibGVFcnJvciA9IGNyZWF0ZUNhcHR1cmVkVmFsdWVBdEZpYmVyKG5ldyBFcnJvcigiVGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGh5ZHJhdGluZy4gQmVjYXVzZSB0aGUgZXJyb3IgaGFwcGVuZWQgb3V0c2lkZSBvZiBhIFN1c3BlbnNlIGJvdW5kYXJ5LCB0aGUgZW50aXJlIHJvb3Qgd2lsbCBzd2l0Y2ggdG8gY2xpZW50IHJlbmRlcmluZy4iKSwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRIb3N0Um9vdFdpdGhvdXRIeWRyYXRpbmcoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV4dENoaWxkcmVuLCByZW5kZXJMYW5lczIsIHJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgICB9IGVsc2UgaWYgKG5leHRDaGlsZHJlbiAhPT0gcHJldkNoaWxkcmVuKSB7CiAgICAgICAgICAgICAgdmFyIF9yZWNvdmVyYWJsZUVycm9yID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIobmV3IEVycm9yKCJUaGlzIHJvb3QgcmVjZWl2ZWQgYW4gZWFybHkgdXBkYXRlLCBiZWZvcmUgYW55dGhpbmcgd2FzIGFibGUgaHlkcmF0ZS4gU3dpdGNoZWQgdGhlIGVudGlyZSByb290IHRvIGNsaWVudCByZW5kZXJpbmcuIiksIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SG9zdFJvb3RXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyLCBfcmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZW50ZXJIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBjaGlsZCA9IG1vdW50Q2hpbGRGaWJlcnMod29ya0luUHJvZ3Jlc3MyLCBudWxsLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgICAgdmFyIG5vZGUgPSBjaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAobm9kZSkgewogICAgICAgICAgICAgICAgbm9kZS5mbGFncyA9IG5vZGUuZmxhZ3MgJiB+UGxhY2VtZW50IHwgSHlkcmF0aW5nOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgaWYgKG5leHRDaGlsZHJlbiA9PT0gcHJldkNoaWxkcmVuKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEhvc3RSb290V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0Q2hpbGRyZW4sIHJlbmRlckxhbmVzMiwgcmVjb3ZlcmFibGVFcnJvcikgewogICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZSgpOwogICAgICAgICAgcXVldWVIeWRyYXRpb25FcnJvcihyZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBGb3JjZUNsaWVudFJlbmRlcjsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvc3RDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBwdXNoSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHR5cGUgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgIHZhciBuZXh0UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQubWVtb2l6ZWRQcm9wcyA6IG51bGw7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgdmFyIGlzRGlyZWN0VGV4dENoaWxkID0gc2hvdWxkU2V0VGV4dENvbnRlbnQodHlwZSwgbmV4dFByb3BzKTsKICAgICAgICAgIGlmIChpc0RpcmVjdFRleHRDaGlsZCkgewogICAgICAgICAgICBuZXh0Q2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgfSBlbHNlIGlmIChwcmV2UHJvcHMgIT09IG51bGwgJiYgc2hvdWxkU2V0VGV4dENvbnRlbnQodHlwZSwgcHJldlByb3BzKSkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gQ29udGVudFJlc2V0OwogICAgICAgICAgfQogICAgICAgICAgbWFya1JlZihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUhvc3RUZXh0KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB0cnlUb0NsYWltTmV4dEh5ZHJhdGFibGVJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50TGF6eUNvbXBvbmVudChfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyLCBlbGVtZW50VHlwZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgdmFyIHByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gZWxlbWVudFR5cGU7CiAgICAgICAgICB2YXIgcGF5bG9hZCA9IGxhenlDb21wb25lbnQuX3BheWxvYWQ7CiAgICAgICAgICB2YXIgaW5pdCA9IGxhenlDb21wb25lbnQuX2luaXQ7CiAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gaW5pdChwYXlsb2FkKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50OwogICAgICAgICAgdmFyIHJlc29sdmVkVGFnID0gd29ya0luUHJvZ3Jlc3MyLnRhZyA9IHJlc29sdmVMYXp5Q29tcG9uZW50VGFnKENvbXBvbmVudCk7CiAgICAgICAgICB2YXIgcmVzb2x2ZWRQcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMyKENvbXBvbmVudCwgcHJvcHMpOwogICAgICAgICAgdmFyIGNoaWxkOwogICAgICAgICAgc3dpdGNoIChyZXNvbHZlZFRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KTsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gQ29tcG9uZW50ID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKENvbXBvbmVudCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNoaWxkID0gdXBkYXRlRnVuY3Rpb25Db21wb25lbnQobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSA9IENvbXBvbmVudCA9IHJlc29sdmVDbGFzc0ZvckhvdFJlbG9hZGluZyhDb21wb25lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZUNsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBDb21wb25lbnQgPSByZXNvbHZlRm9yd2FyZFJlZkZvckhvdFJlbG9hZGluZyhDb21wb25lbnQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZUZvcndhcmRSZWYobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHJlc29sdmVkUHJvcHMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgcmV0dXJuIGNoaWxkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgICAgIHZhciBvdXRlclByb3BUeXBlcyA9IENvbXBvbmVudC5wcm9wVHlwZXM7CiAgICAgICAgICAgICAgICAgIGlmIChvdXRlclByb3BUeXBlcykgewogICAgICAgICAgICAgICAgICAgIGNoZWNrUHJvcFR5cGVzKAogICAgICAgICAgICAgICAgICAgICAgb3V0ZXJQcm9wVHlwZXMsCiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZFByb3BzLAogICAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgZm9yIG91dGVyIG9ubHkKICAgICAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjaGlsZCA9IHVwZGF0ZU1lbW9Db21wb25lbnQoCiAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLAogICAgICAgICAgICAgICAgQ29tcG9uZW50LAogICAgICAgICAgICAgICAgcmVzb2x2ZURlZmF1bHRQcm9wczIoQ29tcG9uZW50LnR5cGUsIHJlc29sdmVkUHJvcHMpLAogICAgICAgICAgICAgICAgLy8gVGhlIGlubmVyIHR5cGUgY2FuIGhhdmUgZGVmYXVsdHMgdG9vCiAgICAgICAgICAgICAgICByZW5kZXJMYW5lczIKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGhpbnQgPSAiIjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKENvbXBvbmVudCAhPT0gbnVsbCAmJiB0eXBlb2YgQ29tcG9uZW50ID09PSAib2JqZWN0IiAmJiBDb21wb25lbnQuJCR0eXBlb2YgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgIGhpbnQgPSAiIERpZCB5b3Ugd3JhcCBhIGNvbXBvbmVudCBpbiBSZWFjdC5sYXp5KCkgbW9yZSB0aGFuIG9uY2U/IjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFbGVtZW50IHR5cGUgaXMgaW52YWxpZC4gUmVjZWl2ZWQgYSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG86ICIgKyBDb21wb25lbnQgKyAiLiAiICsgKCJMYXp5IGVsZW1lbnQgdHlwZSBtdXN0IHJlc29sdmUgdG8gYSBjbGFzcyBvciBmdW5jdGlvbi4iICsgaGludCkpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEluY29tcGxldGVDbGFzc0NvbXBvbmVudChfY3VycmVudCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIG5leHRQcm9wcywgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICByZXNldFN1c3BlbmRlZEN1cnJlbnRPbk1vdW50SW5MZWdhY3lNb2RlKF9jdXJyZW50LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRhZyA9IENsYXNzQ29tcG9uZW50OwogICAgICAgICAgdmFyIGhhc0NvbnRleHQ7CiAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICBoYXNDb250ZXh0ID0gdHJ1ZTsKICAgICAgICAgICAgcHVzaENvbnRleHRQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgY29uc3RydWN0Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzKTsKICAgICAgICAgIG1vdW50Q2xhc3NJbnN0YW5jZSh3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgbmV4dFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIGZpbmlzaENsYXNzQ29tcG9uZW50KG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCB0cnVlLCBoYXNDb250ZXh0LCByZW5kZXJMYW5lczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudEluZGV0ZXJtaW5hdGVDb21wb25lbnQoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJlc2V0U3VzcGVuZGVkQ3VycmVudE9uTW91bnRJbkxlZ2FjeU1vZGUoX2N1cnJlbnQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICB2YXIgcHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgdmFyIGNvbnRleHQ7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB1bm1hc2tlZENvbnRleHQgPSBnZXRVbm1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIGZhbHNlKTsKICAgICAgICAgICAgY29udGV4dCA9IGdldE1hc2tlZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCB1bm1hc2tlZENvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcHJlcGFyZVRvUmVhZENvbnRleHQod29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIHZhbHVlOwogICAgICAgICAgdmFyIGhhc0lkOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBpZiAoQ29tcG9uZW50LnByb3RvdHlwZSAmJiB0eXBlb2YgQ29tcG9uZW50LnByb3RvdHlwZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEJhZENsYXNzW2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIDwlcyAvPiBjb21wb25lbnQgYXBwZWFycyB0byBoYXZlIGEgcmVuZGVyIG1ldGhvZCwgYnV0IGRvZXNuJ3QgZXh0ZW5kIFJlYWN0LkNvbXBvbmVudC4gVGhpcyBpcyBsaWtlbHkgdG8gY2F1c2UgZXJyb3JzLiBDaGFuZ2UgJXMgdG8gZXh0ZW5kIFJlYWN0LkNvbXBvbmVudCBpbnN0ZWFkLiIsIGNvbXBvbmVudE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0QmFkQ2xhc3NbY29tcG9uZW50TmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgUmVhY3RTdHJpY3RNb2RlV2FybmluZ3MucmVjb3JkTGVnYWN5Q29udGV4dFdhcm5pbmcod29ya0luUHJvZ3Jlc3MyLCBudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyh0cnVlKTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMS5jdXJyZW50ID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICB2YWx1ZSA9IHJlbmRlcldpdGhIb29rcyhudWxsLCB3b3JrSW5Qcm9ncmVzczIsIENvbXBvbmVudCwgcHJvcHMsIGNvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGhhc0lkID0gY2hlY2tEaWRSZW5kZXJJZEhvb2soKTsKICAgICAgICAgICAgc2V0SXNSZW5kZXJpbmcoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFBlcmZvcm1lZFdvcms7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIgJiYgdmFsdWUuJCR0eXBlb2YgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWVdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIDwlcyAvPiBjb21wb25lbnQgYXBwZWFycyB0byBiZSBhIGZ1bmN0aW9uIGNvbXBvbmVudCB0aGF0IHJldHVybnMgYSBjbGFzcyBpbnN0YW5jZS4gQ2hhbmdlICVzIHRvIGEgY2xhc3MgdGhhdCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCBpbnN0ZWFkLiBJZiB5b3UgY2FuJ3QgdXNlIGEgY2xhc3MgdHJ5IGFzc2lnbmluZyB0aGUgcHJvdG90eXBlIG9uIHRoZSBmdW5jdGlvbiBhcyBhIHdvcmthcm91bmQuIGAlcy5wcm90b3R5cGUgPSBSZWFjdC5Db21wb25lbnQucHJvdG90eXBlYC4gRG9uJ3QgdXNlIGFuIGFycm93IGZ1bmN0aW9uIHNpbmNlIGl0IGNhbm5vdCBiZSBjYWxsZWQgd2l0aCBgbmV3YCBieSBSZWFjdC4iLCBfY29tcG9uZW50TmFtZSwgX2NvbXBvbmVudE5hbWUsIF9jb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICgKICAgICAgICAgICAgLy8gUnVuIHRoZXNlIGNoZWNrcyBpbiBwcm9kdWN0aW9uIG9ubHkgaWYgdGhlIGZsYWcgaXMgb2ZmLgogICAgICAgICAgICAvLyBFdmVudHVhbGx5IHdlJ2xsIGRlbGV0ZSB0aGlzIGJyYW5jaCBhbHRvZ2V0aGVyLgogICAgICAgICAgICB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIHZhbHVlICE9PSBudWxsICYmIHR5cGVvZiB2YWx1ZS5yZW5kZXIgPT09ICJmdW5jdGlvbiIgJiYgdmFsdWUuJCR0eXBlb2YgPT09IHZvaWQgMAogICAgICAgICAgKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB2YXIgX2NvbXBvbmVudE5hbWUyID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKENvbXBvbmVudCkgfHwgIlVua25vd24iOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0TW9kdWxlUGF0dGVybkNvbXBvbmVudFtfY29tcG9uZW50TmFtZTJdKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiVGhlIDwlcyAvPiBjb21wb25lbnQgYXBwZWFycyB0byBiZSBhIGZ1bmN0aW9uIGNvbXBvbmVudCB0aGF0IHJldHVybnMgYSBjbGFzcyBpbnN0YW5jZS4gQ2hhbmdlICVzIHRvIGEgY2xhc3MgdGhhdCBleHRlbmRzIFJlYWN0LkNvbXBvbmVudCBpbnN0ZWFkLiBJZiB5b3UgY2FuJ3QgdXNlIGEgY2xhc3MgdHJ5IGFzc2lnbmluZyB0aGUgcHJvdG90eXBlIG9uIHRoZSBmdW5jdGlvbiBhcyBhIHdvcmthcm91bmQuIGAlcy5wcm90b3R5cGUgPSBSZWFjdC5Db21wb25lbnQucHJvdG90eXBlYC4gRG9uJ3QgdXNlIGFuIGFycm93IGZ1bmN0aW9uIHNpbmNlIGl0IGNhbm5vdCBiZSBjYWxsZWQgd2l0aCBgbmV3YCBieSBSZWFjdC4iLCBfY29tcG9uZW50TmFtZTIsIF9jb21wb25lbnROYW1lMiwgX2NvbXBvbmVudE5hbWUyKTsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dE1vZHVsZVBhdHRlcm5Db21wb25lbnRbX2NvbXBvbmVudE5hbWUyXSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50YWcgPSBDbGFzc0NvbXBvbmVudDsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgICB2YXIgaGFzQ29udGV4dCA9IGZhbHNlOwogICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgIGhhc0NvbnRleHQgPSB0cnVlOwogICAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBoYXNDb250ZXh0ID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSB2YWx1ZS5zdGF0ZSAhPT0gbnVsbCAmJiB2YWx1ZS5zdGF0ZSAhPT0gdm9pZCAwID8gdmFsdWUuc3RhdGUgOiBudWxsOwogICAgICAgICAgICBpbml0aWFsaXplVXBkYXRlUXVldWUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgYWRvcHRDbGFzc0luc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgdmFsdWUpOwogICAgICAgICAgICBtb3VudENsYXNzSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICByZXR1cm4gZmluaXNoQ2xhc3NDb21wb25lbnQobnVsbCwgd29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQsIHRydWUsIGhhc0NvbnRleHQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudGFnID0gRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICBzZXRJc1N0cmljdE1vZGVGb3JEZXZ0b29scyh0cnVlKTsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHZhbHVlID0gcmVuZGVyV2l0aEhvb2tzKG51bGwsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCBwcm9wcywgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgaGFzSWQgPSBjaGVja0RpZFJlbmRlcklkSG9vaygpOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgc2V0SXNTdHJpY3RNb2RlRm9yRGV2dG9vbHMoZmFsc2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSAmJiBoYXNJZCkgewogICAgICAgICAgICAgIHB1c2hNYXRlcmlhbGl6ZWRUcmVlSWQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihudWxsLCB3b3JrSW5Qcm9ncmVzczIsIHZhbHVlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFsaWRhdGVGdW5jdGlvbkNvbXBvbmVudEluRGV2KHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZUZ1bmN0aW9uQ29tcG9uZW50SW5EZXYod29ya0luUHJvZ3Jlc3MyLCBDb21wb25lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKENvbXBvbmVudCkgewogICAgICAgICAgICAgIGlmIChDb21wb25lbnQuY2hpbGRDb250ZXh0VHlwZXMpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyguLi4pOiBjaGlsZENvbnRleHRUeXBlcyBjYW5ub3QgYmUgZGVmaW5lZCBvbiBhIGZ1bmN0aW9uIGNvbXBvbmVudC4iLCBDb21wb25lbnQuZGlzcGxheU5hbWUgfHwgQ29tcG9uZW50Lm5hbWUgfHwgIkNvbXBvbmVudCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgdmFyIG93bmVyTmFtZSA9IGdldEN1cnJlbnRGaWJlck93bmVyTmFtZUluRGV2T3JOdWxsKCk7CiAgICAgICAgICAgICAgaWYgKG93bmVyTmFtZSkgewogICAgICAgICAgICAgICAgaW5mbyArPSAiXG5cbkNoZWNrIHRoZSByZW5kZXIgbWV0aG9kIG9mIGAiICsgb3duZXJOYW1lICsgImAuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIHdhcm5pbmdLZXkgPSBvd25lck5hbWUgfHwgIiI7CiAgICAgICAgICAgICAgdmFyIGRlYnVnU291cmNlID0gd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z1NvdXJjZTsKICAgICAgICAgICAgICBpZiAoZGVidWdTb3VyY2UpIHsKICAgICAgICAgICAgICAgIHdhcm5pbmdLZXkgPSBkZWJ1Z1NvdXJjZS5maWxlTmFtZSArICI6IiArIGRlYnVnU291cmNlLmxpbmVOdW1iZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RnVuY3Rpb25SZWZzW3dhcm5pbmdLZXldKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRGdW5jdGlvblJlZnNbd2FybmluZ0tleV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIkZ1bmN0aW9uIGNvbXBvbmVudHMgY2Fubm90IGJlIGdpdmVuIHJlZnMuIEF0dGVtcHRzIHRvIGFjY2VzcyB0aGlzIHJlZiB3aWxsIGZhaWwuIERpZCB5b3UgbWVhbiB0byB1c2UgUmVhY3QuZm9yd2FyZFJlZigpPyVzIiwgaW5mbyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChDb21wb25lbnQuZGVmYXVsdFByb3BzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dERlZmF1bHRQcm9wc09uRnVuY3Rpb25Db21wb25lbnRbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogU3VwcG9ydCBmb3IgZGVmYXVsdFByb3BzIHdpbGwgYmUgcmVtb3ZlZCBmcm9tIGZ1bmN0aW9uIGNvbXBvbmVudHMgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gVXNlIEphdmFTY3JpcHQgZGVmYXVsdCBwYXJhbWV0ZXJzIGluc3RlYWQuIiwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXREZWZhdWx0UHJvcHNPbkZ1bmN0aW9uQ29tcG9uZW50W2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBDb21wb25lbnQuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIF9jb21wb25lbnROYW1lMyA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShDb21wb25lbnQpIHx8ICJVbmtub3duIjsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dEdldERlcml2ZWRTdGF0ZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWUzXSkgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBGdW5jdGlvbiBjb21wb25lbnRzIGRvIG5vdCBzdXBwb3J0IGdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcy4iLCBfY29tcG9uZW50TmFtZTMpOwogICAgICAgICAgICAgICAgZGlkV2FybkFib3V0R2V0RGVyaXZlZFN0YXRlT25GdW5jdGlvbkNvbXBvbmVudFtfY29tcG9uZW50TmFtZTNdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBDb21wb25lbnQuY29udGV4dFR5cGUgPT09ICJvYmplY3QiICYmIENvbXBvbmVudC5jb250ZXh0VHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBfY29tcG9uZW50TmFtZTQgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoQ29tcG9uZW50KSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWU0XSkgewogICAgICAgICAgICAgICAgZXJyb3IoIiVzOiBGdW5jdGlvbiBjb21wb25lbnRzIGRvIG5vdCBzdXBwb3J0IGNvbnRleHRUeXBlLiIsIF9jb21wb25lbnROYW1lNCk7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRDb250ZXh0VHlwZU9uRnVuY3Rpb25Db21wb25lbnRbX2NvbXBvbmVudE5hbWU0XSA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBTVVNQRU5ERURfTUFSS0VSID0gewogICAgICAgICAgZGVoeWRyYXRlZDogbnVsbCwKICAgICAgICAgIHRyZWVDb250ZXh0OiBudWxsLAogICAgICAgICAgcmV0cnlMYW5lOiBOb0xhbmUKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGJhc2VMYW5lczogcmVuZGVyTGFuZXMyLAogICAgICAgICAgICBjYWNoZVBvb2w6IGdldFN1c3BlbmRlZENhY2hlKCksCiAgICAgICAgICAgIHRyYW5zaXRpb25zOiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHByZXZPZmZzY3JlZW5TdGF0ZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgY2FjaGVQb29sID0gbnVsbDsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGJhc2VMYW5lczogbWVyZ2VMYW5lcyhwcmV2T2Zmc2NyZWVuU3RhdGUuYmFzZUxhbmVzLCByZW5kZXJMYW5lczIpLAogICAgICAgICAgICBjYWNoZVBvb2wsCiAgICAgICAgICAgIHRyYW5zaXRpb25zOiBwcmV2T2Zmc2NyZWVuU3RhdGUudHJhbnNpdGlvbnMKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZFJlbWFpbk9uRmFsbGJhY2soc3VzcGVuc2VDb250ZXh0LCBjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaGFzU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgRm9yY2VTdXNwZW5zZUZhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UmVtYWluaW5nV29ya0luUHJpbWFyeVRyZWUoY3VycmVudDQsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgcmV0dXJuIHJlbW92ZUxhbmVzKGN1cnJlbnQ0LmNoaWxkTGFuZXMsIHJlbmRlckxhbmVzMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChzaG91bGRTdXNwZW5kKHdvcmtJblByb2dyZXNzMikpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHN1c3BlbnNlQ29udGV4dCA9IHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudDsKICAgICAgICAgIHZhciBzaG93RmFsbGJhY2sgPSBmYWxzZTsKICAgICAgICAgIHZhciBkaWRTdXNwZW5kID0gKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgaWYgKGRpZFN1c3BlbmQgfHwgc2hvdWxkUmVtYWluT25GYWxsYmFjayhzdXNwZW5zZUNvbnRleHQsIGN1cnJlbnQ0KSkgewogICAgICAgICAgICBzaG93RmFsbGJhY2sgPSB0cnVlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJj0gfkRpZENhcHR1cmU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwgfHwgY3VycmVudDQubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IGFkZFN1YnRyZWVTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBJbnZpc2libGVQYXJlbnRTdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHRyeVRvQ2xhaW1OZXh0SHlkcmF0YWJsZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIHZhciBzdXNwZW5zZVN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGRlaHlkcmF0ZWQgPSBzdXNwZW5zZVN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgaWYgKGRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtb3VudERlaHlkcmF0ZWRTdXNwZW5zZUNvbXBvbmVudCh3b3JrSW5Qcm9ncmVzczIsIGRlaHlkcmF0ZWQpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbmV4dFByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgdmFyIG5leHRGYWxsYmFja0NoaWxkcmVuID0gbmV4dFByb3BzLmZhbGxiYWNrOwogICAgICAgICAgICBpZiAoc2hvd0ZhbGxiYWNrKSB7CiAgICAgICAgICAgICAgdmFyIGZhbGxiYWNrRnJhZ21lbnQgPSBtb3VudFN1c3BlbnNlRmFsbGJhY2tDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIG5leHRQcmltYXJ5Q2hpbGRyZW4sIG5leHRGYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5tZW1vaXplZFN0YXRlID0gbW91bnRTdXNwZW5zZU9mZnNjcmVlblN0YXRlKHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBTVVNQRU5ERURfTUFSS0VSOwogICAgICAgICAgICAgIHJldHVybiBmYWxsYmFja0ZyYWdtZW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJldHVybiBtb3VudFN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKHdvcmtJblByb2dyZXNzMiwgbmV4dFByaW1hcnlDaGlsZHJlbik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBwcmV2U3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICBpZiAocHJldlN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIF9kZWh5ZHJhdGVkID0gcHJldlN0YXRlLmRlaHlkcmF0ZWQ7CiAgICAgICAgICAgICAgaWYgKF9kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRGVoeWRyYXRlZFN1c3BlbnNlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIGRpZFN1c3BlbmQsIG5leHRQcm9wcywgX2RlaHlkcmF0ZWQsIHByZXZTdGF0ZSwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNob3dGYWxsYmFjaykgewogICAgICAgICAgICAgIHZhciBfbmV4dEZhbGxiYWNrQ2hpbGRyZW4gPSBuZXh0UHJvcHMuZmFsbGJhY2s7CiAgICAgICAgICAgICAgdmFyIF9uZXh0UHJpbWFyeUNoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSB1cGRhdGVTdXNwZW5zZUZhbGxiYWNrQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgX25leHRQcmltYXJ5Q2hpbGRyZW4sIF9uZXh0RmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50MiA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICB2YXIgcHJldk9mZnNjcmVlblN0YXRlID0gY3VycmVudDQuY2hpbGQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBfcHJpbWFyeUNoaWxkRnJhZ21lbnQyLm1lbW9pemVkU3RhdGUgPSBwcmV2T2Zmc2NyZWVuU3RhdGUgPT09IG51bGwgPyBtb3VudFN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocmVuZGVyTGFuZXMyKSA6IHVwZGF0ZVN1c3BlbnNlT2Zmc2NyZWVuU3RhdGUocHJldk9mZnNjcmVlblN0YXRlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDIuY2hpbGRMYW5lcyA9IGdldFJlbWFpbmluZ1dvcmtJblByaW1hcnlUcmVlKGN1cnJlbnQ0LCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gU1VTUEVOREVEX01BUktFUjsKICAgICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBfbmV4dFByaW1hcnlDaGlsZHJlbjIgPSBuZXh0UHJvcHMuY2hpbGRyZW47CiAgICAgICAgICAgICAgdmFyIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDMgPSB1cGRhdGVTdXNwZW5zZVByaW1hcnlDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBfbmV4dFByaW1hcnlDaGlsZHJlbjIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybiBfcHJpbWFyeUNoaWxkRnJhZ21lbnQzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4sIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIG1vZGUgPSB3b3JrSW5Qcm9ncmVzczIubW9kZTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRQcm9wcyA9IHsKICAgICAgICAgICAgbW9kZTogInZpc2libGUiLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gbW91bnRXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKHByaW1hcnlDaGlsZFByb3BzLCBtb2RlKTsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgcmV0dXJuIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtb3VudFN1c3BlbnNlRmFsbGJhY2tDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbiwgZmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IHdvcmtJblByb2dyZXNzMi5tb2RlOwogICAgICAgICAgdmFyIHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJoaWRkZW4iLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9OwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgdmFyIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIGlmICgobW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmIHByb2dyZXNzZWRQcmltYXJ5RnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50OwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucGVuZGluZ1Byb3BzID0gcHJpbWFyeUNoaWxkUHJvcHM7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuYWN0dWFsRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbFN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNlbGZCYXNlRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb24gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGZhbGxiYWNrQ2hpbGRyZW4sIG1vZGUsIHJlbmRlckxhbmVzMiwgbnVsbCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihwcmltYXJ5Q2hpbGRQcm9wcywgbW9kZSk7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGZhbGxiYWNrQ2hpbGRyZW4sIG1vZGUsIHJlbmRlckxhbmVzMiwgbnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZyA9IGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHByaW1hcnlDaGlsZEZyYWdtZW50OwogICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnRXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKG9mZnNjcmVlblByb3BzLCBtb2RlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21PZmZzY3JlZW4ob2Zmc2NyZWVuUHJvcHMsIG1vZGUsIE5vTGFuZXMsIG51bGwpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVXb3JrSW5Qcm9ncmVzc09mZnNjcmVlbkZpYmVyKGN1cnJlbnQ0LCBvZmZzY3JlZW5Qcm9wcykgewogICAgICAgICAgcmV0dXJuIGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnQ0LCBvZmZzY3JlZW5Qcm9wcyk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVN1c3BlbnNlUHJpbWFyeUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50ID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICB2YXIgY3VycmVudEZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gdXBkYXRlV29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQsIHsKICAgICAgICAgICAgbW9kZTogInZpc2libGUiLAogICAgICAgICAgICBjaGlsZHJlbjogcHJpbWFyeUNoaWxkcmVuCiAgICAgICAgICB9KTsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5sYW5lcyA9IHJlbmRlckxhbmVzMjsKICAgICAgICAgIH0KICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgaWYgKGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGRlbGV0aW9ucyA9IHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnM7CiAgICAgICAgICAgIGlmIChkZWxldGlvbnMgPT09IG51bGwpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZGVsZXRpb25zID0gW2N1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnRdOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBDaGlsZERlbGV0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGRlbGV0aW9ucy5wdXNoKGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIHJldHVybiBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlU3VzcGVuc2VGYWxsYmFja0NoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbiwgZmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IHdvcmtJblByb2dyZXNzMi5tb2RlOwogICAgICAgICAgdmFyIGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgdmFyIGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc2libGluZzsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRQcm9wcyA9IHsKICAgICAgICAgICAgbW9kZTogImhpZGRlbiIsCiAgICAgICAgICAgIGNoaWxkcmVuOiBwcmltYXJ5Q2hpbGRyZW4KICAgICAgICAgIH07CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICBpZiAoCiAgICAgICAgICAgIC8vIEluIGxlZ2FjeSBtb2RlLCB3ZSBjb21taXQgdGhlIHByaW1hcnkgdHJlZSBhcyBpZiBpdCBzdWNjZXNzZnVsbHkKICAgICAgICAgICAgLy8gY29tcGxldGVkLCBldmVuIHRob3VnaCBpdCdzIGluIGFuIGluY29uc2lzdGVudCBzdGF0ZS4KICAgICAgICAgICAgKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSAmJiAvLyBNYWtlIHN1cmUgd2UncmUgb24gdGhlIHNlY29uZCBwYXNzLCBpLmUuIHRoZSBwcmltYXJ5IGNoaWxkIGZyYWdtZW50IHdhcwogICAgICAgICAgICAvLyBhbHJlYWR5IGNsb25lZC4gSW4gbGVnYWN5IG1vZGUsIHRoZSBvbmx5IGNhc2Ugd2hlcmUgdGhpcyBpc24ndCB0cnVlIGlzCiAgICAgICAgICAgIC8vIHdoZW4gRGV2VG9vbHMgZm9yY2VzIHVzIHRvIGRpc3BsYXkgYSBmYWxsYmFjazsgd2Ugc2tpcCB0aGUgZmlyc3QgcmVuZGVyCiAgICAgICAgICAgIC8vIHBhc3MgZW50aXJlbHkgYW5kIGdvIHN0cmFpZ2h0IHRvIHJlbmRlcmluZyB0aGUgZmFsbGJhY2suIChJbiBDb25jdXJyZW50CiAgICAgICAgICAgIC8vIE1vZGUsIFN1c3BlbnNlTGlzdCBjYW4gYWxzbyB0cmlnZ2VyIHRoaXMgc2NlbmFyaW8sIGJ1dCB0aGlzIGlzIGEgbGVnYWN5LQogICAgICAgICAgICAvLyBvbmx5IGNvZGVwYXRoLikKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkICE9PSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQKICAgICAgICAgICkgewogICAgICAgICAgICB2YXIgcHJvZ3Jlc3NlZFByaW1hcnlGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSBwcm9ncmVzc2VkUHJpbWFyeUZyYWdtZW50OwogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucGVuZGluZ1Byb3BzID0gcHJpbWFyeUNoaWxkUHJvcHM7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQuYWN0dWFsRHVyYXRpb24gPSAwOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmFjdHVhbFN0YXJ0VGltZSA9IC0xOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNlbGZCYXNlRHVyYXRpb24gPSBjdXJyZW50UHJpbWFyeUNoaWxkRnJhZ21lbnQuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uID0gY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHVwZGF0ZVdvcmtJblByb2dyZXNzT2Zmc2NyZWVuRmliZXIoY3VycmVudFByaW1hcnlDaGlsZEZyYWdtZW50LCBwcmltYXJ5Q2hpbGRQcm9wcyk7CiAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnN1YnRyZWVGbGFncyA9IGN1cnJlbnRQcmltYXJ5Q2hpbGRGcmFnbWVudC5zdWJ0cmVlRmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICAgIGlmIChjdXJyZW50RmFsbGJhY2tDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IGNyZWF0ZVdvcmtJblByb2dyZXNzKGN1cnJlbnRGYWxsYmFja0NoaWxkRnJhZ21lbnQsIGZhbGxiYWNrQ2hpbGRyZW4pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50ID0gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQoZmFsbGJhY2tDaGlsZHJlbiwgbW9kZSwgcmVuZGVyTGFuZXMyLCBudWxsKTsKICAgICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LmZsYWdzIHw9IFBsYWNlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGZhbGxiYWNrQ2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5yZXR1cm4gPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5zaWJsaW5nID0gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICByZXR1cm4gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIHJlY292ZXJhYmxlRXJyb3IpIHsKICAgICAgICAgIGlmIChyZWNvdmVyYWJsZUVycm9yICE9PSBudWxsKSB7CiAgICAgICAgICAgIHF1ZXVlSHlkcmF0aW9uRXJyb3IocmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICB9CiAgICAgICAgICByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGN1cnJlbnQ0LmNoaWxkLCBudWxsLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgdmFyIG5leHRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gbW91bnRTdXNwZW5zZVByaW1hcnlDaGlsZHJlbih3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbik7CiAgICAgICAgICBwcmltYXJ5Q2hpbGRGcmFnbWVudC5mbGFncyB8PSBQbGFjZW1lbnQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1vdW50U3VzcGVuc2VGYWxsYmFja0FmdGVyUmV0cnlXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHByaW1hcnlDaGlsZHJlbiwgZmFsbGJhY2tDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgZmliZXJNb2RlID0gd29ya0luUHJvZ3Jlc3MyLm1vZGU7CiAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkUHJvcHMgPSB7CiAgICAgICAgICAgIG1vZGU6ICJ2aXNpYmxlIiwKICAgICAgICAgICAgY2hpbGRyZW46IHByaW1hcnlDaGlsZHJlbgogICAgICAgICAgfTsKICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50V29ya0luUHJvZ3Jlc3NPZmZzY3JlZW5GaWJlcihwcmltYXJ5Q2hpbGRQcm9wcywgZmliZXJNb2RlKTsKICAgICAgICAgIHZhciBmYWxsYmFja0NoaWxkRnJhZ21lbnQgPSBjcmVhdGVGaWJlckZyb21GcmFnbWVudChmYWxsYmFja0NoaWxkcmVuLCBmaWJlck1vZGUsIHJlbmRlckxhbmVzMiwgbnVsbCk7CiAgICAgICAgICBmYWxsYmFja0NoaWxkRnJhZ21lbnQuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgcHJpbWFyeUNoaWxkRnJhZ21lbnQucmV0dXJuID0gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgZmFsbGJhY2tDaGlsZEZyYWdtZW50LnJldHVybiA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LnNpYmxpbmcgPSBmYWxsYmFja0NoaWxkRnJhZ21lbnQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBwcmltYXJ5Q2hpbGRGcmFnbWVudDsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIGN1cnJlbnQ0LmNoaWxkLCBudWxsLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZhbGxiYWNrQ2hpbGRGcmFnbWVudDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbW91bnREZWh5ZHJhdGVkU3VzcGVuc2VDb21wb25lbnQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUluc3RhbmNlLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3IoIkNhbm5vdCBoeWRyYXRlIFN1c3BlbnNlIGluIGxlZ2FjeSBtb2RlLiBTd2l0Y2ggZnJvbSBSZWFjdERPTS5oeWRyYXRlKGVsZW1lbnQsIGNvbnRhaW5lcikgdG8gUmVhY3RET01DbGllbnQuaHlkcmF0ZVJvb3QoY29udGFpbmVyLCA8QXBwIC8+KS5yZW5kZXIoZWxlbWVudCkgb3IgcmVtb3ZlIHRoZSBTdXNwZW5zZSBjb21wb25lbnRzIGZyb20gdGhlIHNlcnZlciByZW5kZXJlZCBjb21wb25lbnRzLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGxhbmVUb0xhbmVzKFN5bmNMYW5lKTsKICAgICAgICAgIH0gZWxzZSBpZiAoaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soc3VzcGVuc2VJbnN0YW5jZSkpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbGFuZVRvTGFuZXMoRGVmYXVsdEh5ZHJhdGlvbkxhbmUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gbGFuZVRvTGFuZXMoT2Zmc2NyZWVuTGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlRGVoeWRyYXRlZFN1c3BlbnNlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIGRpZFN1c3BlbmQsIG5leHRQcm9wcywgc3VzcGVuc2VJbnN0YW5jZSwgc3VzcGVuc2VTdGF0ZSwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoIWRpZFN1c3BlbmQpIHsKICAgICAgICAgICAgd2FybklmSHlkcmF0aW5nKCk7CiAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZygKICAgICAgICAgICAgICAgIGN1cnJlbnQ0LAogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLAogICAgICAgICAgICAgICAgcmVuZGVyTGFuZXMyLAogICAgICAgICAgICAgICAgLy8gVE9ETzogV2hlbiB3ZSBkZWxldGUgbGVnYWN5IG1vZGUsIHdlIHNob3VsZCBtYWtlIHRoaXMgZXJyb3IgYXJndW1lbnQKICAgICAgICAgICAgICAgIC8vIHJlcXVpcmVkIOKAlCBldmVyeSBjb25jdXJyZW50IG1vZGUgcGF0aCB0aGF0IGNhdXNlcyBoeWRyYXRpb24gdG8KICAgICAgICAgICAgICAgIC8vIGRlLW9wdCB0byBjbGllbnQgcmVuZGVyaW5nIHNob3VsZCBoYXZlIGFuIGVycm9yIG1lc3NhZ2UuCiAgICAgICAgICAgICAgICBudWxsCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNTdXNwZW5zZUluc3RhbmNlRmFsbGJhY2soc3VzcGVuc2VJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICB2YXIgZGlnZXN0LCBtZXNzYWdlLCBzdGFjazsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgX2dldFN1c3BlbnNlSW5zdGFuY2VGID0gZ2V0U3VzcGVuc2VJbnN0YW5jZUZhbGxiYWNrRXJyb3JEZXRhaWxzKHN1c3BlbnNlSW5zdGFuY2UpOwogICAgICAgICAgICAgICAgZGlnZXN0ID0gX2dldFN1c3BlbnNlSW5zdGFuY2VGLmRpZ2VzdDsKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBfZ2V0U3VzcGVuc2VJbnN0YW5jZUYubWVzc2FnZTsKICAgICAgICAgICAgICAgIHN0YWNrID0gX2dldFN1c3BlbnNlSW5zdGFuY2VGLnN0YWNrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgZXJyb3IyOwogICAgICAgICAgICAgIGlmIChtZXNzYWdlKSB7CiAgICAgICAgICAgICAgICBlcnJvcjIgPSBuZXcgRXJyb3IobWVzc2FnZSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yMiA9IG5ldyBFcnJvcigiVGhlIHNlcnZlciBjb3VsZCBub3QgZmluaXNoIHRoaXMgU3VzcGVuc2UgYm91bmRhcnksIGxpa2VseSBkdWUgdG8gYW4gZXJyb3IgZHVyaW5nIHNlcnZlciByZW5kZXJpbmcuIFN3aXRjaGVkIHRvIGNsaWVudCByZW5kZXJpbmcuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBjYXB0dXJlZFZhbHVlID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZShlcnJvcjIsIGRpZ2VzdCwgc3RhY2spOwogICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIGNhcHR1cmVkVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBoYXNDb250ZXh0Q2hhbmdlZDIgPSBpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgY3VycmVudDQuY2hpbGRMYW5lcyk7CiAgICAgICAgICAgIGlmIChkaWRSZWNlaXZlVXBkYXRlIHx8IGhhc0NvbnRleHRDaGFuZ2VkMikgewogICAgICAgICAgICAgIHZhciByb290MyA9IGdldFdvcmtJblByb2dyZXNzUm9vdCgpOwogICAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIGF0dGVtcHRIeWRyYXRpb25BdExhbmUgPSBnZXRCdW1wZWRMYW5lRm9ySHlkcmF0aW9uKHJvb3QzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgaWYgKGF0dGVtcHRIeWRyYXRpb25BdExhbmUgIT09IE5vTGFuZSAmJiBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lICE9PSBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZSkgewogICAgICAgICAgICAgICAgICBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZSA9IGF0dGVtcHRIeWRyYXRpb25BdExhbmU7CiAgICAgICAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSBOb1RpbWVzdGFtcDsKICAgICAgICAgICAgICAgICAgZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGN1cnJlbnQ0LCBhdHRlbXB0SHlkcmF0aW9uQXRMYW5lKTsKICAgICAgICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBjdXJyZW50NCwgYXR0ZW1wdEh5ZHJhdGlvbkF0TGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVuZGVyRGlkU3VzcGVuZERlbGF5SWZQb3NzaWJsZSgpOwogICAgICAgICAgICAgIHZhciBfY2FwdHVyZWRWYWx1ZSA9IGNyZWF0ZUNhcHR1cmVkVmFsdWUobmV3IEVycm9yKCJUaGlzIFN1c3BlbnNlIGJvdW5kYXJ5IHJlY2VpdmVkIGFuIHVwZGF0ZSBiZWZvcmUgaXQgZmluaXNoZWQgaHlkcmF0aW5nLiBUaGlzIGNhdXNlZCB0aGUgYm91bmRhcnkgdG8gc3dpdGNoIHRvIGNsaWVudCByZW5kZXJpbmcuIFRoZSB1c3VhbCB3YXkgdG8gZml4IHRoaXMgaXMgdG8gd3JhcCB0aGUgb3JpZ2luYWwgdXBkYXRlIGluIHN0YXJ0VHJhbnNpdGlvbi4iKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJldHJ5U3VzcGVuc2VDb21wb25lbnRXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMiwgX2NhcHR1cmVkVmFsdWUpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGlzU3VzcGVuc2VJbnN0YW5jZVBlbmRpbmcoc3VzcGVuc2VJbnN0YW5jZSkpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgICAgICB2YXIgcmV0cnkgPSByZXRyeURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5LmJpbmQobnVsbCwgY3VycmVudDQpOwogICAgICAgICAgICAgIHJlZ2lzdGVyU3VzcGVuc2VJbnN0YW5jZVJldHJ5KHN1c3BlbnNlSW5zdGFuY2UsIHJldHJ5KTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZWVudGVySHlkcmF0aW9uU3RhdGVGcm9tRGVoeWRyYXRlZFN1c3BlbnNlSW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUluc3RhbmNlLCBzdXNwZW5zZVN0YXRlLnRyZWVDb250ZXh0KTsKICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VQcmltYXJ5Q2hpbGRyZW4od29ya0luUHJvZ3Jlc3MyLCBwcmltYXJ5Q2hpbGRyZW4pOwogICAgICAgICAgICAgIHByaW1hcnlDaGlsZEZyYWdtZW50LmZsYWdzIHw9IEh5ZHJhdGluZzsKICAgICAgICAgICAgICByZXR1cm4gcHJpbWFyeUNoaWxkRnJhZ21lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBGb3JjZUNsaWVudFJlbmRlcikgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyAmPSB+Rm9yY2VDbGllbnRSZW5kZXI7CiAgICAgICAgICAgICAgdmFyIF9jYXB0dXJlZFZhbHVlMiA9IGNyZWF0ZUNhcHR1cmVkVmFsdWUobmV3IEVycm9yKCJUaGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgaHlkcmF0aW5nIHRoaXMgU3VzcGVuc2UgYm91bmRhcnkuIFN3aXRjaGVkIHRvIGNsaWVudCByZW5kZXJpbmcuIikpOwogICAgICAgICAgICAgIHJldHVybiByZXRyeVN1c3BlbnNlQ29tcG9uZW50V2l0aG91dEh5ZHJhdGluZyhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIsIF9jYXB0dXJlZFZhbHVlMik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAod29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBjdXJyZW50NC5jaGlsZDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgbmV4dFByaW1hcnlDaGlsZHJlbiA9IG5leHRQcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICB2YXIgbmV4dEZhbGxiYWNrQ2hpbGRyZW4gPSBuZXh0UHJvcHMuZmFsbGJhY2s7CiAgICAgICAgICAgICAgdmFyIGZhbGxiYWNrQ2hpbGRGcmFnbWVudCA9IG1vdW50U3VzcGVuc2VGYWxsYmFja0FmdGVyUmV0cnlXaXRob3V0SHlkcmF0aW5nKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRQcmltYXJ5Q2hpbGRyZW4sIG5leHRGYWxsYmFja0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHZhciBfcHJpbWFyeUNoaWxkRnJhZ21lbnQ0ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgIF9wcmltYXJ5Q2hpbGRGcmFnbWVudDQubWVtb2l6ZWRTdGF0ZSA9IG1vdW50U3VzcGVuc2VPZmZzY3JlZW5TdGF0ZShyZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlID0gU1VTUEVOREVEX01BUktFUjsKICAgICAgICAgICAgICByZXR1cm4gZmFsbGJhY2tDaGlsZEZyYWdtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlU3VzcGVuc2VXb3JrT25GaWJlcihmaWJlciwgcmVuZGVyTGFuZXMyLCBwcm9wYWdhdGlvblJvb3QpIHsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbWVyZ2VMYW5lcyhmaWJlci5sYW5lcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGFsdGVybmF0ZS5sYW5lcyA9IG1lcmdlTGFuZXMoYWx0ZXJuYXRlLmxhbmVzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgfQogICAgICAgICAgc2NoZWR1bGVDb250ZXh0V29ya09uUGFyZW50UGF0aChmaWJlci5yZXR1cm4sIHJlbmRlckxhbmVzMiwgcHJvcGFnYXRpb25Sb290KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJvcGFnYXRlU3VzcGVuc2VDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgZmlyc3RDaGlsZCwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIHN0YXRlID0gbm9kZS5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2NoZWR1bGVTdXNwZW5zZVdvcmtPbkZpYmVyKG5vZGUsIHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS50YWcgPT09IFN1c3BlbnNlTGlzdENvbXBvbmVudCkgewogICAgICAgICAgICAgIHNjaGVkdWxlU3VzcGVuc2VXb3JrT25GaWJlcihub2RlLCByZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobm9kZSA9PT0gd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChub2RlLnNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmaW5kTGFzdENvbnRlbnRSb3coZmlyc3RDaGlsZCkgewogICAgICAgICAgdmFyIHJvdyA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICB2YXIgbGFzdENvbnRlbnRSb3cgPSBudWxsOwogICAgICAgICAgd2hpbGUgKHJvdyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgY3VycmVudFJvdyA9IHJvdy5hbHRlcm5hdGU7CiAgICAgICAgICAgIGlmIChjdXJyZW50Um93ICE9PSBudWxsICYmIGZpbmRGaXJzdFN1c3BlbmRlZChjdXJyZW50Um93KSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGxhc3RDb250ZW50Um93ID0gcm93OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJvdyA9IHJvdy5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxhc3RDb250ZW50Um93OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVJldmVhbE9yZGVyKHJldmVhbE9yZGVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXZlYWxPcmRlciAhPT0gdm9pZCAwICYmIHJldmVhbE9yZGVyICE9PSAiZm9yd2FyZHMiICYmIHJldmVhbE9yZGVyICE9PSAiYmFja3dhcmRzIiAmJiByZXZlYWxPcmRlciAhPT0gInRvZ2V0aGVyIiAmJiAhZGlkV2FybkFib3V0UmV2ZWFsT3JkZXJbcmV2ZWFsT3JkZXJdKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0UmV2ZWFsT3JkZXJbcmV2ZWFsT3JkZXJdID0gdHJ1ZTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHJldmVhbE9yZGVyID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgc3dpdGNoIChyZXZlYWxPcmRlci50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgInRvZ2V0aGVyIjoKICAgICAgICAgICAgICAgICAgY2FzZSAiZm9yd2FyZHMiOgogICAgICAgICAgICAgICAgICBjYXNlICJiYWNrd2FyZHMiOiB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoJyIlcyIgaXMgbm90IGEgdmFsaWQgdmFsdWUgZm9yIHJldmVhbE9yZGVyIG9uIDxTdXNwZW5zZUxpc3QgLz4uIFVzZSBsb3dlcmNhc2UgIiVzIiBpbnN0ZWFkLicsIHJldmVhbE9yZGVyLCByZXZlYWxPcmRlci50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjYXNlICJmb3J3YXJkIjoKICAgICAgICAgICAgICAgICAgY2FzZSAiYmFja3dhcmQiOiB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoJyIlcyIgaXMgbm90IGEgdmFsaWQgdmFsdWUgZm9yIHJldmVhbE9yZGVyIG9uIDxTdXNwZW5zZUxpc3QgLz4uIFJlYWN0IHVzZXMgdGhlIC1zIHN1ZmZpeCBpbiB0aGUgc3BlbGxpbmcuIFVzZSAiJXNzIiBpbnN0ZWFkLicsIHJldmVhbE9yZGVyLCByZXZlYWxPcmRlci50b0xvd2VyQ2FzZSgpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIGVycm9yKCciJXMiIGlzIG5vdCBhIHN1cHBvcnRlZCByZXZlYWxPcmRlciBvbiA8U3VzcGVuc2VMaXN0IC8+LiBEaWQgeW91IG1lYW4gInRvZ2V0aGVyIiwgImZvcndhcmRzIiBvciAiYmFja3dhcmRzIj8nLCByZXZlYWxPcmRlcik7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yKCclcyBpcyBub3QgYSBzdXBwb3J0ZWQgdmFsdWUgZm9yIHJldmVhbE9yZGVyIG9uIDxTdXNwZW5zZUxpc3QgLz4uIERpZCB5b3UgbWVhbiAidG9nZXRoZXIiLCAiZm9yd2FyZHMiIG9yICJiYWNrd2FyZHMiPycsIHJldmVhbE9yZGVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVUYWlsT3B0aW9ucyh0YWlsTW9kZSwgcmV2ZWFsT3JkZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHRhaWxNb2RlICE9PSB2b2lkIDAgJiYgIWRpZFdhcm5BYm91dFRhaWxPcHRpb25zW3RhaWxNb2RlXSkgewogICAgICAgICAgICAgIGlmICh0YWlsTW9kZSAhPT0gImNvbGxhcHNlZCIgJiYgdGFpbE1vZGUgIT09ICJoaWRkZW4iKSB7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRUYWlsT3B0aW9uc1t0YWlsTW9kZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoJyIlcyIgaXMgbm90IGEgc3VwcG9ydGVkIHZhbHVlIGZvciB0YWlsIG9uIDxTdXNwZW5zZUxpc3QgLz4uIERpZCB5b3UgbWVhbiAiY29sbGFwc2VkIiBvciAiaGlkZGVuIj8nLCB0YWlsTW9kZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChyZXZlYWxPcmRlciAhPT0gImZvcndhcmRzIiAmJiByZXZlYWxPcmRlciAhPT0gImJhY2t3YXJkcyIpIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFRhaWxPcHRpb25zW3RhaWxNb2RlXSA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcignPFN1c3BlbnNlTGlzdCB0YWlsPSIlcyIgLz4gaXMgb25seSB2YWxpZCBpZiByZXZlYWxPcmRlciBpcyAiZm9yd2FyZHMiIG9yICJiYWNrd2FyZHMiLiBEaWQgeW91IG1lYW4gdG8gc3BlY2lmeSByZXZlYWxPcmRlcj0iZm9yd2FyZHMiPycsIHRhaWxNb2RlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVTdXNwZW5zZUxpc3ROZXN0ZWRDaGlsZChjaGlsZFNsb3QsIGluZGV4MikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNBbkFycmF5ID0gaXNBcnJheTIoY2hpbGRTbG90KTsKICAgICAgICAgICAgdmFyIGlzSXRlcmFibGUgPSAhaXNBbkFycmF5ICYmIHR5cGVvZiBnZXRJdGVyYXRvckZuKGNoaWxkU2xvdCkgPT09ICJmdW5jdGlvbiI7CiAgICAgICAgICAgIGlmIChpc0FuQXJyYXkgfHwgaXNJdGVyYWJsZSkgewogICAgICAgICAgICAgIHZhciB0eXBlID0gaXNBbkFycmF5ID8gImFycmF5IiA6ICJpdGVyYWJsZSI7CiAgICAgICAgICAgICAgZXJyb3IoIkEgbmVzdGVkICVzIHdhcyBwYXNzZWQgdG8gcm93ICMlcyBpbiA8U3VzcGVuc2VMaXN0IC8+LiBXcmFwIGl0IGluIGFuIGFkZGl0aW9uYWwgU3VzcGVuc2VMaXN0IHRvIGNvbmZpZ3VyZSBpdHMgcmV2ZWFsT3JkZXI6IDxTdXNwZW5zZUxpc3QgcmV2ZWFsT3JkZXI9Li4uPiAuLi4gPFN1c3BlbnNlTGlzdCByZXZlYWxPcmRlcj0uLi4+eyVzfTwvU3VzcGVuc2VMaXN0PiAuLi4gPC9TdXNwZW5zZUxpc3Q+IiwgdHlwZSwgaW5kZXgyLCB0eXBlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB2YWxpZGF0ZVN1c3BlbnNlTGlzdENoaWxkcmVuKGNoaWxkcmVuLCByZXZlYWxPcmRlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKHJldmVhbE9yZGVyID09PSAiZm9yd2FyZHMiIHx8IHJldmVhbE9yZGVyID09PSAiYmFja3dhcmRzIikgJiYgY2hpbGRyZW4gIT09IHZvaWQgMCAmJiBjaGlsZHJlbiAhPT0gbnVsbCAmJiBjaGlsZHJlbiAhPT0gZmFsc2UpIHsKICAgICAgICAgICAgICBpZiAoaXNBcnJheTIoY2hpbGRyZW4pKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIGlmICghdmFsaWRhdGVTdXNwZW5zZUxpc3ROZXN0ZWRDaGlsZChjaGlsZHJlbltpXSwgaSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIGl0ZXJhdG9yRm4gPSBnZXRJdGVyYXRvckZuKGNoaWxkcmVuKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlcmF0b3JGbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB2YXIgY2hpbGRyZW5JdGVyYXRvciA9IGl0ZXJhdG9yRm4uY2FsbChjaGlsZHJlbik7CiAgICAgICAgICAgICAgICAgIGlmIChjaGlsZHJlbkl0ZXJhdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHN0ZXAgPSBjaGlsZHJlbkl0ZXJhdG9yLm5leHQoKTsKICAgICAgICAgICAgICAgICAgICB2YXIgX2kgPSAwOwogICAgICAgICAgICAgICAgICAgIGZvciAoOyAhc3RlcC5kb25lOyBzdGVwID0gY2hpbGRyZW5JdGVyYXRvci5uZXh0KCkpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmICghdmFsaWRhdGVTdXNwZW5zZUxpc3ROZXN0ZWRDaGlsZChzdGVwLnZhbHVlLCBfaSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgX2krKzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCdBIHNpbmdsZSByb3cgd2FzIHBhc3NlZCB0byBhIDxTdXNwZW5zZUxpc3QgcmV2ZWFsT3JkZXI9IiVzIiAvPi4gVGhpcyBpcyBub3QgdXNlZnVsIHNpbmNlIGl0IG5lZWRzIG11bHRpcGxlIHJvd3MuIERpZCB5b3UgbWVhbiB0byBwYXNzIG11bHRpcGxlIGNoaWxkcmVuIG9yIGFuIGFycmF5PycsIHJldmVhbE9yZGVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKHdvcmtJblByb2dyZXNzMiwgaXNCYWNrd2FyZHMsIHRhaWwsIGxhc3RDb250ZW50Um93LCB0YWlsTW9kZSkgewogICAgICAgICAgdmFyIHJlbmRlclN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAocmVuZGVyU3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSB7CiAgICAgICAgICAgICAgaXNCYWNrd2FyZHMsCiAgICAgICAgICAgICAgcmVuZGVyaW5nOiBudWxsLAogICAgICAgICAgICAgIHJlbmRlcmluZ1N0YXJ0VGltZTogMCwKICAgICAgICAgICAgICBsYXN0OiBsYXN0Q29udGVudFJvdywKICAgICAgICAgICAgICB0YWlsLAogICAgICAgICAgICAgIHRhaWxNb2RlCiAgICAgICAgICAgIH07CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZW5kZXJTdGF0ZS5pc0JhY2t3YXJkcyA9IGlzQmFja3dhcmRzOwogICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmcgPSBudWxsOwogICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmdTdGFydFRpbWUgPSAwOwogICAgICAgICAgICByZW5kZXJTdGF0ZS5sYXN0ID0gbGFzdENvbnRlbnRSb3c7CiAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSB0YWlsOwogICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsTW9kZSA9IHRhaWxNb2RlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVTdXNwZW5zZUxpc3RDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV4dFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciByZXZlYWxPcmRlciA9IG5leHRQcm9wcy5yZXZlYWxPcmRlcjsKICAgICAgICAgIHZhciB0YWlsTW9kZSA9IG5leHRQcm9wcy50YWlsOwogICAgICAgICAgdmFyIG5ld0NoaWxkcmVuID0gbmV4dFByb3BzLmNoaWxkcmVuOwogICAgICAgICAgdmFsaWRhdGVSZXZlYWxPcmRlcihyZXZlYWxPcmRlcik7CiAgICAgICAgICB2YWxpZGF0ZVRhaWxPcHRpb25zKHRhaWxNb2RlLCByZXZlYWxPcmRlcik7CiAgICAgICAgICB2YWxpZGF0ZVN1c3BlbnNlTGlzdENoaWxkcmVuKG5ld0NoaWxkcmVuLCByZXZlYWxPcmRlcik7CiAgICAgICAgICByZWNvbmNpbGVDaGlsZHJlbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXdDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBzdXNwZW5zZUNvbnRleHQgPSBzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQ7CiAgICAgICAgICB2YXIgc2hvdWxkRm9yY2VGYWxsYmFjayA9IGhhc1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQsIEZvcmNlU3VzcGVuc2VGYWxsYmFjayk7CiAgICAgICAgICBpZiAoc2hvdWxkRm9yY2VGYWxsYmFjaykgewogICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBzZXRTaGFsbG93U3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlQ29udGV4dCwgRm9yY2VTdXNwZW5zZUZhbGxiYWNrKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IERpZENhcHR1cmU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZGlkU3VzcGVuZEJlZm9yZSA9IGN1cnJlbnQ0ICE9PSBudWxsICYmIChjdXJyZW50NC5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzOwogICAgICAgICAgICBpZiAoZGlkU3VzcGVuZEJlZm9yZSkgewogICAgICAgICAgICAgIHByb3BhZ2F0ZVN1c3BlbnNlQ29udGV4dENoYW5nZSh3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi5jaGlsZCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzdXNwZW5zZUNvbnRleHQgPSBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgfQogICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHN1c3BlbnNlQ29udGV4dCk7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3dpdGNoIChyZXZlYWxPcmRlcikgewogICAgICAgICAgICAgIGNhc2UgImZvcndhcmRzIjogewogICAgICAgICAgICAgICAgdmFyIGxhc3RDb250ZW50Um93ID0gZmluZExhc3RDb250ZW50Um93KHdvcmtJblByb2dyZXNzMi5jaGlsZCk7CiAgICAgICAgICAgICAgICB2YXIgdGFpbDsKICAgICAgICAgICAgICAgIGlmIChsYXN0Q29udGVudFJvdyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0YWlsID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgdGFpbCA9IGxhc3RDb250ZW50Um93LnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgIGxhc3RDb250ZW50Um93LnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5pdFN1c3BlbnNlTGlzdFJlbmRlclN0YXRlKAogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIsCiAgICAgICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgICAgICAvLyBpc0JhY2t3YXJkcwogICAgICAgICAgICAgICAgICB0YWlsLAogICAgICAgICAgICAgICAgICBsYXN0Q29udGVudFJvdywKICAgICAgICAgICAgICAgICAgdGFpbE1vZGUKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSAiYmFja3dhcmRzIjogewogICAgICAgICAgICAgICAgdmFyIF90YWlsID0gbnVsbDsKICAgICAgICAgICAgICAgIHZhciByb3cgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICAgICAgd2hpbGUgKHJvdyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFJvdyA9IHJvdy5hbHRlcm5hdGU7CiAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Um93ICE9PSBudWxsICYmIGZpbmRGaXJzdFN1c3BlbmRlZChjdXJyZW50Um93KSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJvdzsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgbmV4dFJvdyA9IHJvdy5zaWJsaW5nOwogICAgICAgICAgICAgICAgICByb3cuc2libGluZyA9IF90YWlsOwogICAgICAgICAgICAgICAgICBfdGFpbCA9IHJvdzsKICAgICAgICAgICAgICAgICAgcm93ID0gbmV4dFJvdzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGluaXRTdXNwZW5zZUxpc3RSZW5kZXJTdGF0ZSgKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLAogICAgICAgICAgICAgICAgICB0cnVlLAogICAgICAgICAgICAgICAgICAvLyBpc0JhY2t3YXJkcwogICAgICAgICAgICAgICAgICBfdGFpbCwKICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgICAgLy8gbGFzdAogICAgICAgICAgICAgICAgICB0YWlsTW9kZQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlICJ0b2dldGhlciI6IHsKICAgICAgICAgICAgICAgIGluaXRTdXNwZW5zZUxpc3RSZW5kZXJTdGF0ZSgKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLAogICAgICAgICAgICAgICAgICBmYWxzZSwKICAgICAgICAgICAgICAgICAgLy8gaXNCYWNrd2FyZHMKICAgICAgICAgICAgICAgICAgbnVsbCwKICAgICAgICAgICAgICAgICAgLy8gdGFpbAogICAgICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgICAgICAvLyBsYXN0CiAgICAgICAgICAgICAgICAgIHZvaWQgMAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVQb3J0YWxDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBwdXNoSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUuY29udGFpbmVySW5mbyk7CiAgICAgICAgICB2YXIgbmV4dENoaWxkcmVuID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZWNvbmNpbGVDaGlsZEZpYmVycyh3b3JrSW5Qcm9ncmVzczIsIG51bGwsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRDaGlsZHJlbiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNXYXJuZWRBYm91dFVzaW5nTm9WYWx1ZVByb3BPbkNvbnRleHRQcm92aWRlciA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNvbnRleHRQcm92aWRlcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciBwcm92aWRlclR5cGUgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgIHZhciBjb250ZXh0ID0gcHJvdmlkZXJUeXBlLl9jb250ZXh0OwogICAgICAgICAgdmFyIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgIHZhciBvbGRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzOwogICAgICAgICAgdmFyIG5ld1ZhbHVlID0gbmV3UHJvcHMudmFsdWU7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghKCJ2YWx1ZSIgaW4gbmV3UHJvcHMpKSB7CiAgICAgICAgICAgICAgaWYgKCFoYXNXYXJuZWRBYm91dFVzaW5nTm9WYWx1ZVByb3BPbkNvbnRleHRQcm92aWRlcikgewogICAgICAgICAgICAgICAgaGFzV2FybmVkQWJvdXRVc2luZ05vVmFsdWVQcm9wT25Db250ZXh0UHJvdmlkZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgZXJyb3IoIlRoZSBgdmFsdWVgIHByb3AgaXMgcmVxdWlyZWQgZm9yIHRoZSBgPENvbnRleHQuUHJvdmlkZXI+YC4gRGlkIHlvdSBtaXNzcGVsbCBpdCBvciBmb3JnZXQgdG8gcGFzcyBpdD8iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByb3ZpZGVyUHJvcFR5cGVzID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUucHJvcFR5cGVzOwogICAgICAgICAgICBpZiAocHJvdmlkZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhwcm92aWRlclByb3BUeXBlcywgbmV3UHJvcHMsICJwcm9wIiwgIkNvbnRleHQuUHJvdmlkZXIiKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcHVzaFByb3ZpZGVyKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgbmV3VmFsdWUpOwogICAgICAgICAgewogICAgICAgICAgICBpZiAob2xkUHJvcHMgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgb2xkVmFsdWUgPSBvbGRQcm9wcy52YWx1ZTsKICAgICAgICAgICAgICBpZiAob2JqZWN0SXMob2xkVmFsdWUsIG5ld1ZhbHVlKSkgewogICAgICAgICAgICAgICAgaWYgKG9sZFByb3BzLmNoaWxkcmVuID09PSBuZXdQcm9wcy5jaGlsZHJlbiAmJiAhaGFzQ29udGV4dENoYW5nZWQoKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwcm9wYWdhdGVDb250ZXh0Q2hhbmdlKHdvcmtJblByb2dyZXNzMiwgY29udGV4dCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdDaGlsZHJlbiA9IG5ld1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgcmVjb25jaWxlQ2hpbGRyZW4oY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgbmV3Q2hpbGRyZW4sIHJlbmRlckxhbmVzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzV2FybmVkQWJvdXRVc2luZ0NvbnRleHRBc0NvbnN1bWVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ29udGV4dENvbnN1bWVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgdmFyIGNvbnRleHQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGNvbnRleHQuX2NvbnRleHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGlmIChjb250ZXh0ICE9PSBjb250ZXh0LkNvbnN1bWVyKSB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc1dhcm5lZEFib3V0VXNpbmdDb250ZXh0QXNDb25zdW1lcikgewogICAgICAgICAgICAgICAgICBoYXNXYXJuZWRBYm91dFVzaW5nQ29udGV4dEFzQ29uc3VtZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICBlcnJvcigiUmVuZGVyaW5nIDxDb250ZXh0PiBkaXJlY3RseSBpcyBub3Qgc3VwcG9ydGVkIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gRGlkIHlvdSBtZWFuIHRvIHJlbmRlciA8Q29udGV4dC5Db25zdW1lcj4gaW5zdGVhZD8iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQuX2NvbnRleHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBuZXdQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICB2YXIgcmVuZGVyMiA9IG5ld1Byb3BzLmNoaWxkcmVuOwogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHJlbmRlcjIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigiQSBjb250ZXh0IGNvbnN1bWVyIHdhcyByZW5kZXJlZCB3aXRoIG11bHRpcGxlIGNoaWxkcmVuLCBvciBhIGNoaWxkIHRoYXQgaXNuJ3QgYSBmdW5jdGlvbi4gQSBjb250ZXh0IGNvbnN1bWVyIGV4cGVjdHMgYSBzaW5nbGUgY2hpbGQgdGhhdCBpcyBhIGZ1bmN0aW9uLiBJZiB5b3UgZGlkIHBhc3MgYSBmdW5jdGlvbiwgbWFrZSBzdXJlIHRoZXJlIGlzIG5vIHRyYWlsaW5nIG9yIGxlYWRpbmcgd2hpdGVzcGFjZSBhcm91bmQgaXQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHByZXBhcmVUb1JlYWRDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IHJlYWRDb250ZXh0KGNvbnRleHQpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tcG9uZW50UmVuZGVyU3RhcnRlZCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG5ld0NoaWxkcmVuOwogICAgICAgICAgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQgPSB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgIHNldElzUmVuZGVyaW5nKHRydWUpOwogICAgICAgICAgICBuZXdDaGlsZHJlbiA9IHJlbmRlcjIobmV3VmFsdWUpOwogICAgICAgICAgICBzZXRJc1JlbmRlcmluZyhmYWxzZSk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICB9CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGVyZm9ybWVkV29yazsKICAgICAgICAgIHJlY29uY2lsZUNoaWxkcmVuKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5ld0NoaWxkcmVuLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1dvcmtJblByb2dyZXNzUmVjZWl2ZWRVcGRhdGUoKSB7CiAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRTdXNwZW5kZWRDdXJyZW50T25Nb3VudEluTGVnYWN5TW9kZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKSB7CiAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgY3VycmVudDQuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IGN1cnJlbnQ0LmRlcGVuZGVuY2llczsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmcoKTsKICAgICAgICAgIH0KICAgICAgICAgIG1hcmtTa2lwcGVkVXBkYXRlTGFuZXMod29ya0luUHJvZ3Jlc3MyLmxhbmVzKTsKICAgICAgICAgIGlmICghaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNsb25lQ2hpbGRGaWJlcnMoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW1vdW50RmliZXIoY3VycmVudDQsIG9sZFdvcmtJblByb2dyZXNzLCBuZXdXb3JrSW5Qcm9ncmVzcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcmV0dXJuRmliZXIgPSBvbGRXb3JrSW5Qcm9ncmVzcy5yZXR1cm47CiAgICAgICAgICAgIGlmIChyZXR1cm5GaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHN3YXAgdGhlIHJvb3QgZmliZXIuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3VycmVudDQuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgICAgb2xkV29ya0luUHJvZ3Jlc3MuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MuaW5kZXggPSBvbGRXb3JrSW5Qcm9ncmVzcy5pbmRleDsKICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3Muc2libGluZyA9IG9sZFdvcmtJblByb2dyZXNzLnNpYmxpbmc7CiAgICAgICAgICAgIG5ld1dvcmtJblByb2dyZXNzLnJldHVybiA9IG9sZFdvcmtJblByb2dyZXNzLnJldHVybjsKICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MucmVmID0gb2xkV29ya0luUHJvZ3Jlc3MucmVmOwogICAgICAgICAgICBpZiAob2xkV29ya0luUHJvZ3Jlc3MgPT09IHJldHVybkZpYmVyLmNoaWxkKSB7CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuY2hpbGQgPSBuZXdXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgcHJldlNpYmxpbmcgPSByZXR1cm5GaWJlci5jaGlsZDsKICAgICAgICAgICAgICBpZiAocHJldlNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgcGFyZW50IHRvIGhhdmUgYSBjaGlsZC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKHByZXZTaWJsaW5nLnNpYmxpbmcgIT09IG9sZFdvcmtJblByb2dyZXNzKSB7CiAgICAgICAgICAgICAgICBwcmV2U2libGluZyA9IHByZXZTaWJsaW5nLnNpYmxpbmc7CiAgICAgICAgICAgICAgICBpZiAocHJldlNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFeHBlY3RlZCB0byBmaW5kIHRoZSBwcmV2aW91cyBzaWJsaW5nLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmV2U2libGluZy5zaWJsaW5nID0gbmV3V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRlbGV0aW9ucyA9IHJldHVybkZpYmVyLmRlbGV0aW9uczsKICAgICAgICAgICAgaWYgKGRlbGV0aW9ucyA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IFtjdXJyZW50NF07CiAgICAgICAgICAgICAgcmV0dXJuRmliZXIuZmxhZ3MgfD0gQ2hpbGREZWxldGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkZWxldGlvbnMucHVzaChjdXJyZW50NCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3V29ya0luUHJvZ3Jlc3MuZmxhZ3MgfD0gUGxhY2VtZW50OwogICAgICAgICAgICByZXR1cm4gbmV3V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrU2NoZWR1bGVkVXBkYXRlT3JDb250ZXh0KGN1cnJlbnQ0LCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHZhciB1cGRhdGVMYW5lcyA9IGN1cnJlbnQ0LmxhbmVzOwogICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUodXBkYXRlTGFuZXMsIHJlbmRlckxhbmVzMikpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGF0dGVtcHRFYXJseUJhaWxvdXRJZk5vU2NoZWR1bGVkVXBkYXRlKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgcHVzaEhvc3RSb290Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciByb290MyA9IHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgcmVzZXRIeWRyYXRpb25TdGF0ZSgpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcHVzaEhvc3RDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgIHB1c2hDb250ZXh0UHJvdmlkZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHB1c2hIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMiwgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBDb250ZXh0UHJvdmlkZXI6IHsKICAgICAgICAgICAgICB2YXIgbmV3VmFsdWUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcy52YWx1ZTsKICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlLl9jb250ZXh0OwogICAgICAgICAgICAgIHB1c2hQcm92aWRlcih3b3JrSW5Qcm9ncmVzczIsIGNvbnRleHQsIG5ld1ZhbHVlKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciBoYXNDaGlsZFdvcmsgPSBpbmNsdWRlc1NvbWVMYW5lKHJlbmRlckxhbmVzMiwgd29ya0luUHJvZ3Jlc3MyLmNoaWxkTGFuZXMpOwogICAgICAgICAgICAgICAgaWYgKGhhc0NoaWxkV29yaykgewogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YXIgc3RhdGVOb2RlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICAgICAgc3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHN0YXRlID0gd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHN0YXRlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50KSk7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRGcmFnbWVudCA9IHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgIHZhciBwcmltYXJ5Q2hpbGRMYW5lcyA9IHByaW1hcnlDaGlsZEZyYWdtZW50LmNoaWxkTGFuZXM7CiAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNTb21lTGFuZShyZW5kZXJMYW5lczIsIHByaW1hcnlDaGlsZExhbmVzKSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzZXREZWZhdWx0U2hhbGxvd1N1c3BlbnNlQ29udGV4dChzdXNwZW5zZVN0YWNrQ3Vyc29yLmN1cnJlbnQpKTsKICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gYmFpbG91dE9uQWxyZWFkeUZpbmlzaGVkV29yayhjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50KSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIGRpZFN1c3BlbmRCZWZvcmUgPSAoY3VycmVudDQuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgICB2YXIgX2hhc0NoaWxkV29yayA9IGluY2x1ZGVzU29tZUxhbmUocmVuZGVyTGFuZXMyLCB3b3JrSW5Qcm9ncmVzczIuY2hpbGRMYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRCZWZvcmUpIHsKICAgICAgICAgICAgICAgIGlmIChfaGFzQ2hpbGRXb3JrKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVTdXNwZW5zZUxpc3RDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgcmVuZGVyU3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnJlbmRlcmluZyA9IG51bGw7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsID0gbnVsbDsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLmxhc3RFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwdXNoU3VzcGVuc2VDb250ZXh0KHdvcmtJblByb2dyZXNzMiwgc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50KTsKICAgICAgICAgICAgICBpZiAoX2hhc0NoaWxkV29yaykgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBMZWdhY3lIaWRkZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVPZmZzY3JlZW5Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGJhaWxvdXRPbkFscmVhZHlGaW5pc2hlZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmVnaW5Xb3JrKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z05lZWRzUmVtb3VudCAmJiBjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiByZW1vdW50RmliZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKHdvcmtJblByb2dyZXNzMi50eXBlLCB3b3JrSW5Qcm9ncmVzczIua2V5LCB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzLCB3b3JrSW5Qcm9ncmVzczIuX2RlYnVnT3duZXIgfHwgbnVsbCwgd29ya0luUHJvZ3Jlc3MyLm1vZGUsIHdvcmtJblByb2dyZXNzMi5sYW5lcykpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIG9sZFByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgdmFyIG5ld1Byb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgaWYgKG9sZFByb3BzICE9PSBuZXdQcm9wcyB8fCBoYXNDb250ZXh0Q2hhbmdlZCgpIHx8IC8vIEZvcmNlIGEgcmUtcmVuZGVyIGlmIHRoZSBpbXBsZW1lbnRhdGlvbiBjaGFuZ2VkIGR1ZSB0byBob3QgcmVsb2FkOgogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHlwZSAhPT0gY3VycmVudDQudHlwZSkgewogICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciBoYXNTY2hlZHVsZWRVcGRhdGVPckNvbnRleHQgPSBjaGVja1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dChjdXJyZW50NCwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICBpZiAoIWhhc1NjaGVkdWxlZFVwZGF0ZU9yQ29udGV4dCAmJiAvLyBJZiB0aGlzIGlzIHRoZSBzZWNvbmQgcGFzcyBvZiBhbiBlcnJvciBvciBzdXNwZW5zZSBib3VuZGFyeSwgdGhlcmUKICAgICAgICAgICAgICAvLyBtYXkgbm90IGJlIHdvcmsgc2NoZWR1bGVkIG9uIGBjdXJyZW50YCwgc28gd2UgY2hlY2sgZm9yIHRoaXMgZmxhZy4KICAgICAgICAgICAgICAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybiBhdHRlbXB0RWFybHlCYWlsb3V0SWZOb1NjaGVkdWxlZFVwZGF0ZShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKGN1cnJlbnQ0LmZsYWdzICYgRm9yY2VVcGRhdGVGb3JMZWdhY3lTdXNwZW5zZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgIGRpZFJlY2VpdmVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkaWRSZWNlaXZlVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChnZXRJc0h5ZHJhdGluZygpICYmIGlzRm9ya2VkQ2hpbGQod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgIHZhciBzbG90SW5kZXggPSB3b3JrSW5Qcm9ncmVzczIuaW5kZXg7CiAgICAgICAgICAgICAgdmFyIG51bWJlck9mRm9ya3MgPSBnZXRGb3Jrc0F0TGV2ZWwoKTsKICAgICAgICAgICAgICBwdXNoVHJlZUlkKHdvcmtJblByb2dyZXNzMiwgbnVtYmVyT2ZGb3Jrcywgc2xvdEluZGV4KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRJbmRldGVybWluYXRlQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHdvcmtJblByb2dyZXNzMi50eXBlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBlbGVtZW50VHlwZSA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZTsKICAgICAgICAgICAgICByZXR1cm4gbW91bnRMYXp5Q29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIGVsZW1lbnRUeXBlLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIHVucmVzb2x2ZWRQcm9wcyA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIHJlc29sdmVkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPT09IENvbXBvbmVudCA/IHVucmVzb2x2ZWRQcm9wcyA6IHJlc29sdmVEZWZhdWx0UHJvcHMyKENvbXBvbmVudCwgdW5yZXNvbHZlZFByb3BzKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlRnVuY3Rpb25Db21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgQ29tcG9uZW50LCByZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgX0NvbXBvbmVudCA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIHZhciBfdW5yZXNvbHZlZFByb3BzID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIuZWxlbWVudFR5cGUgPT09IF9Db21wb25lbnQgPyBfdW5yZXNvbHZlZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wczIoX0NvbXBvbmVudCwgX3VucmVzb2x2ZWRQcm9wcyk7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNsYXNzQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIF9Db21wb25lbnQsIF9yZXNvbHZlZFByb3BzLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUhvc3RSb290KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlSG9zdENvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVIb3N0VGV4dChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVQb3J0YWxDb21wb25lbnQoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjogewogICAgICAgICAgICAgIHZhciB0eXBlID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgdmFyIF91bnJlc29sdmVkUHJvcHMyID0gd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wczsKICAgICAgICAgICAgICB2YXIgX3Jlc29sdmVkUHJvcHMyID0gd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID09PSB0eXBlID8gX3VucmVzb2x2ZWRQcm9wczIgOiByZXNvbHZlRGVmYXVsdFByb3BzMih0eXBlLCBfdW5yZXNvbHZlZFByb3BzMik7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUZvcndhcmRSZWYoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgdHlwZSwgX3Jlc29sdmVkUHJvcHMyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRnJhZ21lbnQ5OgogICAgICAgICAgICAgIHJldHVybiB1cGRhdGVGcmFnbWVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIE1vZGU6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU1vZGUoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBQcm9maWxlcjoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlUHJvZmlsZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgY2FzZSBDb250ZXh0UHJvdmlkZXI6CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZUNvbnRleHRQcm92aWRlcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICBjYXNlIENvbnRleHRDb25zdW1lcjoKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlQ29udGV4dENvbnN1bWVyKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBfdHlwZTIgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICB2YXIgX3VucmVzb2x2ZWRQcm9wczMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICAgIHZhciBfcmVzb2x2ZWRQcm9wczMgPSByZXNvbHZlRGVmYXVsdFByb3BzMihfdHlwZTIsIF91bnJlc29sdmVkUHJvcHMzKTsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MyLnR5cGUgIT09IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSkgewogICAgICAgICAgICAgICAgICB2YXIgb3V0ZXJQcm9wVHlwZXMgPSBfdHlwZTIucHJvcFR5cGVzOwogICAgICAgICAgICAgICAgICBpZiAob3V0ZXJQcm9wVHlwZXMpIHsKICAgICAgICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcygKICAgICAgICAgICAgICAgICAgICAgIG91dGVyUHJvcFR5cGVzLAogICAgICAgICAgICAgICAgICAgICAgX3Jlc29sdmVkUHJvcHMzLAogICAgICAgICAgICAgICAgICAgICAgLy8gUmVzb2x2ZWQgZm9yIG91dGVyIG9ubHkKICAgICAgICAgICAgICAgICAgICAgICJwcm9wIiwKICAgICAgICAgICAgICAgICAgICAgIGdldENvbXBvbmVudE5hbWVGcm9tVHlwZShfdHlwZTIpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBfcmVzb2x2ZWRQcm9wczMgPSByZXNvbHZlRGVmYXVsdFByb3BzMihfdHlwZTIudHlwZSwgX3Jlc29sdmVkUHJvcHMzKTsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlTWVtb0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBfdHlwZTIsIF9yZXNvbHZlZFByb3BzMywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU2ltcGxlTWVtb0NvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCB3b3JrSW5Qcm9ncmVzczIudHlwZSwgd29ya0luUHJvZ3Jlc3MyLnBlbmRpbmdQcm9wcywgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBfQ29tcG9uZW50MiA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIHZhciBfdW5yZXNvbHZlZFByb3BzNCA9IHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgICAgdmFyIF9yZXNvbHZlZFByb3BzNCA9IHdvcmtJblByb2dyZXNzMi5lbGVtZW50VHlwZSA9PT0gX0NvbXBvbmVudDIgPyBfdW5yZXNvbHZlZFByb3BzNCA6IHJlc29sdmVEZWZhdWx0UHJvcHMyKF9Db21wb25lbnQyLCBfdW5yZXNvbHZlZFByb3BzNCk7CiAgICAgICAgICAgICAgcmV0dXJuIG1vdW50SW5jb21wbGV0ZUNsYXNzQ29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIF9Db21wb25lbnQyLCBfcmVzb2x2ZWRQcm9wczQsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlU3VzcGVuc2VMaXN0Q29tcG9uZW50KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDogewogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZU9mZnNjcmVlbkNvbXBvbmVudChjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCByZW5kZXJMYW5lczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gdW5pdCBvZiB3b3JrIHRhZyAoIiArIHdvcmtJblByb2dyZXNzMi50YWcgKyAiKS4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSZWYkMSh3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBSZWYyOwogICAgICAgICAgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gUmVmU3RhdGljOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgYXBwZW5kQWxsQ2hpbGRyZW47CiAgICAgICAgdmFyIHVwZGF0ZUhvc3RDb250YWluZXI7CiAgICAgICAgdmFyIHVwZGF0ZUhvc3RDb21wb25lbnQkMTsKICAgICAgICB2YXIgdXBkYXRlSG9zdFRleHQkMTsKICAgICAgICB7CiAgICAgICAgICBhcHBlbmRBbGxDaGlsZHJlbiA9IGZ1bmN0aW9uKHBhcmVudCwgd29ya0luUHJvZ3Jlc3MyLCBuZWVkc1Zpc2liaWxpdHlUb2dnbGUsIGlzSGlkZGVuKSB7CiAgICAgICAgICAgIHZhciBub2RlID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICB3aGlsZSAobm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCB8fCBub2RlLnRhZyA9PT0gSG9zdFRleHQpIHsKICAgICAgICAgICAgICAgIGFwcGVuZEluaXRpYWxDaGlsZChwYXJlbnQsIG5vZGUuc3RhdGVOb2RlKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBIb3N0UG9ydGFsKSA7CiAgICAgICAgICAgICAgZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IHdvcmtJblByb2dyZXNzMikgewogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lciA9IGZ1bmN0aW9uKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIpIHsKICAgICAgICAgIH07CiAgICAgICAgICB1cGRhdGVIb3N0Q29tcG9uZW50JDEgPSBmdW5jdGlvbihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKSB7CiAgICAgICAgICAgIHZhciBvbGRQcm9wcyA9IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgIGlmIChvbGRQcm9wcyA9PT0gbmV3UHJvcHMpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gcHJlcGFyZVVwZGF0ZShpbnN0YW5jZSwgdHlwZSwgb2xkUHJvcHMsIG5ld1Byb3BzLCByb290Q29udGFpbmVySW5zdGFuY2UsIGN1cnJlbnRIb3N0Q29udGV4dCk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IHVwZGF0ZVBheWxvYWQ7CiAgICAgICAgICAgIGlmICh1cGRhdGVQYXlsb2FkKSB7CiAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdXBkYXRlSG9zdFRleHQkMSA9IGZ1bmN0aW9uKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG9sZFRleHQsIG5ld1RleHQpIHsKICAgICAgICAgICAgaWYgKG9sZFRleHQgIT09IG5ld1RleHQpIHsKICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGN1dE9mZlRhaWxJZk5lZWRlZChyZW5kZXJTdGF0ZSwgaGFzUmVuZGVyZWRBVGFpbEZhbGxiYWNrKSB7CiAgICAgICAgICBpZiAoZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKHJlbmRlclN0YXRlLnRhaWxNb2RlKSB7CiAgICAgICAgICAgIGNhc2UgImhpZGRlbiI6IHsKICAgICAgICAgICAgICB2YXIgdGFpbE5vZGUgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgIHZhciBsYXN0VGFpbE5vZGUgPSBudWxsOwogICAgICAgICAgICAgIHdoaWxlICh0YWlsTm9kZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHRhaWxOb2RlLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBsYXN0VGFpbE5vZGUgPSB0YWlsTm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhaWxOb2RlID0gdGFpbE5vZGUuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGxhc3RUYWlsTm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUudGFpbCA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxhc3RUYWlsTm9kZS5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAiY29sbGFwc2VkIjogewogICAgICAgICAgICAgIHZhciBfdGFpbE5vZGUgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgIHZhciBfbGFzdFRhaWxOb2RlID0gbnVsbDsKICAgICAgICAgICAgICB3aGlsZSAoX3RhaWxOb2RlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoX3RhaWxOb2RlLmFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBfbGFzdFRhaWxOb2RlID0gX3RhaWxOb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgX3RhaWxOb2RlID0gX3RhaWxOb2RlLnNpYmxpbmc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChfbGFzdFRhaWxOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoIWhhc1JlbmRlcmVkQVRhaWxGYWxsYmFjayAmJiByZW5kZXJTdGF0ZS50YWlsICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS50YWlsID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX2xhc3RUYWlsTm9kZS5zaWJsaW5nID0gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYnViYmxlUHJvcGVydGllcyhjb21wbGV0ZWRXb3JrKSB7CiAgICAgICAgICB2YXIgZGlkQmFpbG91dCA9IGNvbXBsZXRlZFdvcmsuYWx0ZXJuYXRlICE9PSBudWxsICYmIGNvbXBsZXRlZFdvcmsuYWx0ZXJuYXRlLmNoaWxkID09PSBjb21wbGV0ZWRXb3JrLmNoaWxkOwogICAgICAgICAgdmFyIG5ld0NoaWxkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdmFyIHN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoIWRpZEJhaWxvdXQpIHsKICAgICAgICAgICAgaWYgKChjb21wbGV0ZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgIHZhciBhY3R1YWxEdXJhdGlvbiA9IGNvbXBsZXRlZFdvcmsuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgdmFyIHRyZWVCYXNlRHVyYXRpb24gPSBjb21wbGV0ZWRXb3JrLnNlbGZCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgdmFyIGNoaWxkID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5ld0NoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5ld0NoaWxkTGFuZXMsIG1lcmdlTGFuZXMoY2hpbGQubGFuZXMsIGNoaWxkLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBjaGlsZC5zdWJ0cmVlRmxhZ3M7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gY2hpbGQuZmxhZ3M7CiAgICAgICAgICAgICAgICBhY3R1YWxEdXJhdGlvbiArPSBjaGlsZC5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgIHRyZWVCYXNlRHVyYXRpb24gKz0gY2hpbGQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbiA9IGFjdHVhbER1cmF0aW9uOwogICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsudHJlZUJhc2VEdXJhdGlvbiA9IHRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9jaGlsZCA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKF9jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQubGFuZXMsIF9jaGlsZC5jaGlsZExhbmVzKSk7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkLnN1YnRyZWVGbGFnczsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQuZmxhZ3M7CiAgICAgICAgICAgICAgICBfY2hpbGQucmV0dXJuID0gY29tcGxldGVkV29yazsKICAgICAgICAgICAgICAgIF9jaGlsZCA9IF9jaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnN1YnRyZWVGbGFncyB8PSBzdWJ0cmVlRmxhZ3M7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgdmFyIF90cmVlQmFzZUR1cmF0aW9uID0gY29tcGxldGVkV29yay5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgIHZhciBfY2hpbGQyID0gY29tcGxldGVkV29yay5jaGlsZDsKICAgICAgICAgICAgICB3aGlsZSAoX2NoaWxkMiAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbmV3Q2hpbGRMYW5lcyA9IG1lcmdlTGFuZXMobmV3Q2hpbGRMYW5lcywgbWVyZ2VMYW5lcyhfY2hpbGQyLmxhbmVzLCBfY2hpbGQyLmNoaWxkTGFuZXMpKTsKICAgICAgICAgICAgICAgIHN1YnRyZWVGbGFncyB8PSBfY2hpbGQyLnN1YnRyZWVGbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMi5mbGFncyAmIFN0YXRpY01hc2s7CiAgICAgICAgICAgICAgICBfdHJlZUJhc2VEdXJhdGlvbiArPSBfY2hpbGQyLnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgICAgICBfY2hpbGQyID0gX2NoaWxkMi5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21wbGV0ZWRXb3JrLnRyZWVCYXNlRHVyYXRpb24gPSBfdHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB2YXIgX2NoaWxkMyA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgd2hpbGUgKF9jaGlsZDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5ld0NoaWxkTGFuZXMgPSBtZXJnZUxhbmVzKG5ld0NoaWxkTGFuZXMsIG1lcmdlTGFuZXMoX2NoaWxkMy5sYW5lcywgX2NoaWxkMy5jaGlsZExhbmVzKSk7CiAgICAgICAgICAgICAgICBzdWJ0cmVlRmxhZ3MgfD0gX2NoaWxkMy5zdWJ0cmVlRmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgICAgICAgc3VidHJlZUZsYWdzIHw9IF9jaGlsZDMuZmxhZ3MgJiBTdGF0aWNNYXNrOwogICAgICAgICAgICAgICAgX2NoaWxkMy5yZXR1cm4gPSBjb21wbGV0ZWRXb3JrOwogICAgICAgICAgICAgICAgX2NoaWxkMyA9IF9jaGlsZDMuc2libGluZzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGxldGVkV29yay5zdWJ0cmVlRmxhZ3MgfD0gc3VidHJlZUZsYWdzOwogICAgICAgICAgfQogICAgICAgICAgY29tcGxldGVkV29yay5jaGlsZExhbmVzID0gbmV3Q2hpbGRMYW5lczsKICAgICAgICAgIHJldHVybiBkaWRCYWlsb3V0OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZURlaHlkcmF0ZWRTdXNwZW5zZUJvdW5kYXJ5KGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG5leHRTdGF0ZSkgewogICAgICAgICAgaWYgKGhhc1VuaHlkcmF0ZWRUYWlsTm9kZXMoKSAmJiAod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSAmJiAod29ya0luUHJvZ3Jlc3MyLmZsYWdzICYgRGlkQ2FwdHVyZSkgPT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgd2FybklmVW5oeWRyYXRlZFRhaWxOb2Rlcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBGb3JjZUNsaWVudFJlbmRlciB8IEluY29tcGxldGUgfCBTaG91bGRDYXB0dXJlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgd2FzSHlkcmF0ZWQgPSBwb3BIeWRyYXRpb25TdGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgaWYgKG5leHRTdGF0ZSAhPT0gbnVsbCAmJiBuZXh0U3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoIXdhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkEgZGVoeWRyYXRlZCBzdXNwZW5zZSBjb21wb25lbnQgd2FzIGNvbXBsZXRlZCB3aXRob3V0IGEgaHlkcmF0ZWQgbm9kZS4gVGhpcyBpcyBwcm9iYWJseSBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcHJlcGFyZVRvSHlkcmF0ZUhvc3RTdXNwZW5zZUluc3RhbmNlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB2YXIgaXNUaW1lZE91dFN1c3BlbnNlID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoaXNUaW1lZE91dFN1c3BlbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChwcmltYXJ5Q2hpbGRGcmFnbWVudCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnRyZWVCYXNlRHVyYXRpb24gLT0gcHJpbWFyeUNoaWxkRnJhZ21lbnQudHJlZUJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc2V0SHlkcmF0aW9uU3RhdGUoKTsKICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBVcGRhdGU7CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB2YXIgX2lzVGltZWRPdXRTdXNwZW5zZSA9IG5leHRTdGF0ZSAhPT0gbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKF9pc1RpbWVkT3V0U3VzcGVuc2UpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgX3ByaW1hcnlDaGlsZEZyYWdtZW50ID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICAgIGlmIChfcHJpbWFyeUNoaWxkRnJhZ21lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50cmVlQmFzZUR1cmF0aW9uIC09IF9wcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHVwZ3JhZGVIeWRyYXRpb25FcnJvcnNUb1JlY292ZXJhYmxlKCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21wbGV0ZVdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICB2YXIgbmV3UHJvcHMgPSB3b3JrSW5Qcm9ncmVzczIucGVuZGluZ1Byb3BzOwogICAgICAgICAgcG9wVHJlZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICBjYXNlIEluZGV0ZXJtaW5hdGVDb21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGF6eUNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIEZyYWdtZW50OToKICAgICAgICAgICAgY2FzZSBNb2RlOgogICAgICAgICAgICBjYXNlIFByb2ZpbGVyOgogICAgICAgICAgICBjYXNlIENvbnRleHRDb25zdW1lcjoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBDb21wb25lbnQgPSB3b3JrSW5Qcm9ncmVzczIudHlwZTsKICAgICAgICAgICAgICBpZiAoaXNDb250ZXh0UHJvdmlkZXIoQ29tcG9uZW50KSkgewogICAgICAgICAgICAgICAgcG9wQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDogewogICAgICAgICAgICAgIHZhciBmaWJlclJvb3QgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwb3BUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICBpZiAoZmliZXJSb290LnBlbmRpbmdDb250ZXh0KSB7CiAgICAgICAgICAgICAgICBmaWJlclJvb3QuY29udGV4dCA9IGZpYmVyUm9vdC5wZW5kaW5nQ29udGV4dDsKICAgICAgICAgICAgICAgIGZpYmVyUm9vdC5wZW5kaW5nQ29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCB8fCBjdXJyZW50NC5jaGlsZCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHdhc0h5ZHJhdGVkID0gcG9wSHlkcmF0aW9uU3RhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIGlmICh3YXNIeWRyYXRlZCkgewogICAgICAgICAgICAgICAgICBtYXJrVXBkYXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGlzIGlzIGEgY2xpZW50IHJvb3QKICAgICAgICAgICAgICAgICAgICAgICFwcmV2U3RhdGUuaXNEZWh5ZHJhdGVkIHx8IC8vIENoZWNrIGlmIHdlIHJldmVydGVkIHRvIGNsaWVudCByZW5kZXJpbmcgKGUuZy4gZHVlIHRvIGFuIGVycm9yKQogICAgICAgICAgICAgICAgICAgICAgKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIEZvcmNlQ2xpZW50UmVuZGVyKSAhPT0gTm9GbGFncwogICAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFNuYXBzaG90OwogICAgICAgICAgICAgICAgICAgICAgdXBncmFkZUh5ZHJhdGlvbkVycm9yc1RvUmVjb3ZlcmFibGUoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdXBkYXRlSG9zdENvbnRhaW5lcihjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgcm9vdENvbnRhaW5lckluc3RhbmNlID0gZ2V0Um9vdEhvc3RDb250YWluZXIoKTsKICAgICAgICAgICAgICB2YXIgdHlwZSA9IHdvcmtJblByb2dyZXNzMi50eXBlOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCAmJiB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZUhvc3RDb21wb25lbnQkMShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCB0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NC5yZWYgIT09IHdvcmtJblByb2dyZXNzMi5yZWYpIHsKICAgICAgICAgICAgICAgICAgbWFya1JlZiQxKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICghbmV3UHJvcHMpIHsKICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlIG11c3QgaGF2ZSBuZXcgcHJvcHMgZm9yIG5ldyBtb3VudHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjdXJyZW50SG9zdENvbnRleHQgPSBnZXRIb3N0Q29udGV4dCgpOwogICAgICAgICAgICAgICAgdmFyIF93YXNIeWRyYXRlZCA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICBpZiAoX3dhc0h5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgIGlmIChwcmVwYXJlVG9IeWRyYXRlSG9zdEluc3RhbmNlKHdvcmtJblByb2dyZXNzMiwgcm9vdENvbnRhaW5lckluc3RhbmNlLCBjdXJyZW50SG9zdENvbnRleHQpKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya1VwZGF0ZSh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBjcmVhdGVJbnN0YW5jZSh0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlLCBjdXJyZW50SG9zdENvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICAgIGFwcGVuZEFsbENoaWxkcmVuKGluc3RhbmNlLCB3b3JrSW5Qcm9ncmVzczIsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdGF0ZU5vZGUgPSBpbnN0YW5jZTsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmFsaXplSW5pdGlhbENoaWxkcmVuKGluc3RhbmNlLCB0eXBlLCBuZXdQcm9wcywgcm9vdENvbnRhaW5lckluc3RhbmNlKSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5yZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbWFya1JlZiQxKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgdmFyIG5ld1RleHQgPSBuZXdQcm9wczsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQgJiYgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgb2xkVGV4dCA9IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICB1cGRhdGVIb3N0VGV4dCQxKGN1cnJlbnQ0LCB3b3JrSW5Qcm9ncmVzczIsIG9sZFRleHQsIG5ld1RleHQpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld1RleHQgIT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXZSBtdXN0IGhhdmUgbmV3IHByb3BzIGZvciBuZXcgbW91bnRzLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgX3Jvb3RDb250YWluZXJJbnN0YW5jZSA9IGdldFJvb3RIb3N0Q29udGFpbmVyKCk7CiAgICAgICAgICAgICAgICB2YXIgX2N1cnJlbnRIb3N0Q29udGV4dCA9IGdldEhvc3RDb250ZXh0KCk7CiAgICAgICAgICAgICAgICB2YXIgX3dhc0h5ZHJhdGVkMiA9IHBvcEh5ZHJhdGlvblN0YXRlKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICBpZiAoX3dhc0h5ZHJhdGVkMikgewogICAgICAgICAgICAgICAgICBpZiAocHJlcGFyZVRvSHlkcmF0ZUhvc3RUZXh0SW5zdGFuY2Uod29ya0luUHJvZ3Jlc3MyKSkgewogICAgICAgICAgICAgICAgICAgIG1hcmtVcGRhdGUod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGNyZWF0ZVRleHRJbnN0YW5jZShuZXdUZXh0LCBfcm9vdENvbnRhaW5lckluc3RhbmNlLCBfY3VycmVudEhvc3RDb250ZXh0LCB3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciBuZXh0U3RhdGUgPSB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoY3VycmVudDQgPT09IG51bGwgfHwgY3VycmVudDQubWVtb2l6ZWRTdGF0ZSAhPT0gbnVsbCAmJiBjdXJyZW50NC5tZW1vaXplZFN0YXRlLmRlaHlkcmF0ZWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHZhciBmYWxsdGhyb3VnaFRvTm9ybWFsU3VzcGVuc2VQYXRoID0gY29tcGxldGVEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeShjdXJyZW50NCwgd29ya0luUHJvZ3Jlc3MyLCBuZXh0U3RhdGUpOwogICAgICAgICAgICAgICAgaWYgKCFmYWxsdGhyb3VnaFRvTm9ybWFsU3VzcGVuc2VQYXRoKSB7CiAgICAgICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBTaG91bGRDYXB0dXJlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5mbGFncyAmIERpZENhcHR1cmUpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSByZW5kZXJMYW5lczI7CiAgICAgICAgICAgICAgICBpZiAoKHdvcmtJblByb2dyZXNzMi5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJhbnNmZXJBY3R1YWxEdXJhdGlvbih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIG5leHREaWRUaW1lb3V0ID0gbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIHZhciBwcmV2RGlkVGltZW91dCA9IGN1cnJlbnQ0ICE9PSBudWxsICYmIGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgaWYgKG5leHREaWRUaW1lb3V0ICE9PSBwcmV2RGlkVGltZW91dCkgewogICAgICAgICAgICAgICAgaWYgKG5leHREaWRUaW1lb3V0KSB7CiAgICAgICAgICAgICAgICAgIHZhciBfb2Zmc2NyZWVuRmliZXIyID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICBfb2Zmc2NyZWVuRmliZXIyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICAgIHZhciBoYXNJbnZpc2libGVDaGlsZENvbnRleHQgPSBjdXJyZW50NCA9PT0gbnVsbCAmJiAod29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMudW5zdGFibGVfYXZvaWRUaGlzRmFsbGJhY2sgIT09IHRydWUgfHwgIWVuYWJsZVN1c3BlbnNlQXZvaWRUaGlzRmFsbGJhY2spOwogICAgICAgICAgICAgICAgICAgIGlmIChoYXNJbnZpc2libGVDaGlsZENvbnRleHQgfHwgaGFzU3VzcGVuc2VDb250ZXh0KHN1c3BlbnNlU3RhY2tDdXJzb3IuY3VycmVudCwgSW52aXNpYmxlUGFyZW50U3VzcGVuc2VDb250ZXh0KSkgewogICAgICAgICAgICAgICAgICAgICAgcmVuZGVyRGlkU3VzcGVuZCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICByZW5kZXJEaWRTdXNwZW5kRGVsYXlJZlBvc3NpYmxlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgaWYgKHdha2VhYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFVwZGF0ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICBpZiAobmV4dERpZFRpbWVvdXQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJpbWFyeUNoaWxkRnJhZ21lbnQgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByaW1hcnlDaGlsZEZyYWdtZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiAtPSBwcmltYXJ5Q2hpbGRGcmFnbWVudC50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgcG9wSG9zdENvbnRhaW5lcih3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHVwZGF0ZUhvc3RDb250YWluZXIoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBwcmVwYXJlUG9ydGFsTW91bnQod29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHdvcmtJblByb2dyZXNzMi50eXBlLl9jb250ZXh0OwogICAgICAgICAgICAgIHBvcFByb3ZpZGVyKGNvbnRleHQsIHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBfQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKF9Db21wb25lbnQpKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHZhciByZW5kZXJTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBkaWRTdXNwZW5kQWxyZWFkeSA9ICh3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgJiBEaWRDYXB0dXJlKSAhPT0gTm9GbGFnczsKICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRUYWlsID0gcmVuZGVyU3RhdGUucmVuZGVyaW5nOwogICAgICAgICAgICAgIGlmIChyZW5kZXJlZFRhaWwgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICghZGlkU3VzcGVuZEFscmVhZHkpIHsKICAgICAgICAgICAgICAgICAgdmFyIGNhbm5vdEJlU3VzcGVuZGVkID0gcmVuZGVySGFzTm90U3VzcGVuZGVkWWV0KCkgJiYgKGN1cnJlbnQ0ID09PSBudWxsIHx8IChjdXJyZW50NC5mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKTsKICAgICAgICAgICAgICAgICAgaWYgKCFjYW5ub3RCZVN1c3BlbmRlZCkgewogICAgICAgICAgICAgICAgICAgIHZhciByb3cgPSB3b3JrSW5Qcm9ncmVzczIuY2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHJvdyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHN1c3BlbmRlZCA9IGZpbmRGaXJzdFN1c3BlbmRlZChyb3cpOwogICAgICAgICAgICAgICAgICAgICAgaWYgKHN1c3BlbmRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBkaWRTdXNwZW5kQWxyZWFkeSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1RoZW5hYmxlcyA9IHN1c3BlbmRlZC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1RoZW5hYmxlcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG5ld1RoZW5hYmxlczsKICAgICAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgPSBOb0ZsYWdzOwogICAgICAgICAgICAgICAgICAgICAgICByZXNldENoaWxkRmliZXJzKHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKTsKICAgICAgICAgICAgICAgICAgICAgICAgcHVzaFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIsIHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMi5jaGlsZDsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIHJvdyA9IHJvdy5zaWJsaW5nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUudGFpbCAhPT0gbnVsbCAmJiBub3coKSA+IGdldFJlbmRlclRhcmdldFRpbWUoKSkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubGFuZXMgPSBTb21lUmV0cnlMYW5lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKCFkaWRTdXNwZW5kQWxyZWFkeSkgewogICAgICAgICAgICAgICAgICB2YXIgX3N1c3BlbmRlZCA9IGZpbmRGaXJzdFN1c3BlbmRlZChyZW5kZXJlZFRhaWwpOwogICAgICAgICAgICAgICAgICBpZiAoX3N1c3BlbmRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyB8PSBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgICAgIGRpZFN1c3BlbmRBbHJlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB2YXIgX25ld1RoZW5hYmxlcyA9IF9zdXNwZW5kZWQudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKF9uZXdUaGVuYWJsZXMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IF9uZXdUaGVuYWJsZXM7CiAgICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdXRPZmZUYWlsSWZOZWVkZWQocmVuZGVyU3RhdGUsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIGlmIChyZW5kZXJTdGF0ZS50YWlsID09PSBudWxsICYmIHJlbmRlclN0YXRlLnRhaWxNb2RlID09PSAiaGlkZGVuIiAmJiAhcmVuZGVyZWRUYWlsLmFsdGVybmF0ZSAmJiAhZ2V0SXNIeWRyYXRpbmcoKSkgewogICAgICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKAogICAgICAgICAgICAgICAgICAgIC8vIFRoZSB0aW1lIGl0IHRvb2sgdG8gcmVuZGVyIGxhc3Qgcm93IGlzIGdyZWF0ZXIgdGhhbiB0aGUgcmVtYWluaW5nCiAgICAgICAgICAgICAgICAgICAgLy8gdGltZSB3ZSBoYXZlIHRvIHJlbmRlci4gU28gcmVuZGVyaW5nIG9uZSBtb3JlIHJvdyB3b3VsZCBsaWtlbHkKICAgICAgICAgICAgICAgICAgICAvLyBleGNlZWQgaXQuCiAgICAgICAgICAgICAgICAgICAgbm93KCkgKiAyIC0gcmVuZGVyU3RhdGUucmVuZGVyaW5nU3RhcnRUaW1lID4gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpICYmIHJlbmRlckxhbmVzMiAhPT0gT2Zmc2NyZWVuTGFuZQogICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgfD0gRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgICAgICBkaWRTdXNwZW5kQWxyZWFkeSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgY3V0T2ZmVGFpbElmTmVlZGVkKHJlbmRlclN0YXRlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gU29tZVJldHJ5TGFuZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHJlbmRlclN0YXRlLmlzQmFja3dhcmRzKSB7CiAgICAgICAgICAgICAgICAgIHJlbmRlcmVkVGFpbC5zaWJsaW5nID0gd29ya0luUHJvZ3Jlc3MyLmNoaWxkOwogICAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSByZW5kZXJlZFRhaWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNTaWJsaW5nID0gcmVuZGVyU3RhdGUubGFzdDsKICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzU2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHByZXZpb3VzU2libGluZy5zaWJsaW5nID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IHJlbmRlcmVkVGFpbDsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5sYXN0ID0gcmVuZGVyZWRUYWlsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAocmVuZGVyU3RhdGUudGFpbCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIG5leHQgPSByZW5kZXJTdGF0ZS50YWlsOwogICAgICAgICAgICAgICAgcmVuZGVyU3RhdGUucmVuZGVyaW5nID0gbmV4dDsKICAgICAgICAgICAgICAgIHJlbmRlclN0YXRlLnRhaWwgPSBuZXh0LnNpYmxpbmc7CiAgICAgICAgICAgICAgICByZW5kZXJTdGF0ZS5yZW5kZXJpbmdTdGFydFRpbWUgPSBub3coKTsKICAgICAgICAgICAgICAgIG5leHQuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VDb250ZXh0ID0gc3VzcGVuc2VTdGFja0N1cnNvci5jdXJyZW50OwogICAgICAgICAgICAgICAgaWYgKGRpZFN1c3BlbmRBbHJlYWR5KSB7CiAgICAgICAgICAgICAgICAgIHN1c3BlbnNlQ29udGV4dCA9IHNldFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0LCBGb3JjZVN1c3BlbnNlRmFsbGJhY2spOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgc3VzcGVuc2VDb250ZXh0ID0gc2V0RGVmYXVsdFNoYWxsb3dTdXNwZW5zZUNvbnRleHQoc3VzcGVuc2VDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHB1c2hTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyLCBzdXNwZW5zZUNvbnRleHQpOwogICAgICAgICAgICAgICAgcmV0dXJuIG5leHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJ1YmJsZVByb3BlcnRpZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFNjb3BlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcG9wUmVuZGVyTGFuZXMod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgX25leHRTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIHZhciBuZXh0SXNIaWRkZW4gPSBfbmV4dFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIF9wcmV2U3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgICAgdmFyIHByZXZJc0hpZGRlbiA9IF9wcmV2U3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBpZiAocHJldklzSGlkZGVuICE9PSBuZXh0SXNIaWRkZW4gJiYgLy8gTGVnYWN5SGlkZGVuIGRvZXNuJ3QgZG8gYW55IGhpZGluZyDigJQgaXQgb25seSBwcmUtcmVuZGVycy4KICAgICAgICAgICAgICAgICFlbmFibGVMZWdhY3lIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghbmV4dElzSGlkZGVuIHx8ICh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBidWJibGVQcm9wZXJ0aWVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHN1YnRyZWVSZW5kZXJMYW5lcywgT2Zmc2NyZWVuTGFuZSkpIHsKICAgICAgICAgICAgICAgICAgYnViYmxlUHJvcGVydGllcyh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5zdWJ0cmVlRmxhZ3MgJiAoUGxhY2VtZW50IHwgVXBkYXRlKSkgewogICAgICAgICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzIHw9IFZpc2liaWxpdHk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgQ2FjaGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIHVuaXQgb2Ygd29yayB0YWcgKCIgKyB3b3JrSW5Qcm9ncmVzczIudGFnICsgIikuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVud2luZFdvcmsoY3VycmVudDQsIHdvcmtJblByb2dyZXNzMiwgcmVuZGVyTGFuZXMyKSB7CiAgICAgICAgICBwb3BUcmVlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgc3dpdGNoICh3b3JrSW5Qcm9ncmVzczIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGU7CiAgICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICAgIHBvcENvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdmFyIGZsYWdzID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFNob3VsZENhcHR1cmUpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IGZsYWdzICYgflNob3VsZENhcHR1cmUgfCBEaWRDYXB0dXJlOwogICAgICAgICAgICAgICAgaWYgKCh3b3JrSW5Qcm9ncmVzczIubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyYW5zZmVyQWN0dWFsRHVyYXRpb24od29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICBwb3BUb3BMZXZlbENvbnRleHRPYmplY3Qod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICB2YXIgX2ZsYWdzID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgIGlmICgoX2ZsYWdzICYgU2hvdWxkQ2FwdHVyZSkgIT09IE5vRmxhZ3MgJiYgKF9mbGFncyAmIERpZENhcHR1cmUpID09PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuZmxhZ3MgPSBfZmxhZ3MgJiB+U2hvdWxkQ2FwdHVyZSB8IERpZENhcHR1cmU7CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BTdXNwZW5zZUNvbnRleHQod29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICAgIGlmIChzdXNwZW5zZVN0YXRlICE9PSBudWxsICYmIHN1c3BlbnNlU3RhdGUuZGVoeWRyYXRlZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMi5hbHRlcm5hdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaHJldyBpbiBuZXdseSBtb3VudGVkIGRlaHlkcmF0ZWQgY29tcG9uZW50LiBUaGlzIGlzIGxpa2VseSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXNldEh5ZHJhdGlvblN0YXRlKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBfZmxhZ3MyID0gd29ya0luUHJvZ3Jlc3MyLmZsYWdzOwogICAgICAgICAgICAgIGlmIChfZmxhZ3MyICYgU2hvdWxkQ2FwdHVyZSkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gX2ZsYWdzMiAmIH5TaG91bGRDYXB0dXJlIHwgRGlkQ2FwdHVyZTsKICAgICAgICAgICAgICAgIGlmICgod29ya0luUHJvZ3Jlc3MyLm1vZGUgJiBQcm9maWxlTW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICB0cmFuc2ZlckFjdHVhbER1cmF0aW9uKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3MyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDogewogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dCh3b3JrSW5Qcm9ncmVzczIpOwogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ29udGV4dFByb3ZpZGVyOgogICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gd29ya0luUHJvZ3Jlc3MyLnR5cGUuX2NvbnRleHQ7CiAgICAgICAgICAgICAgcG9wUHJvdmlkZXIoY29udGV4dCwgd29ya0luUHJvZ3Jlc3MyKTsKICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgTGVnYWN5SGlkZGVuQ29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFJlbmRlckxhbmVzKHdvcmtJblByb2dyZXNzMik7CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNhc2UgQ2FjaGVDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVud2luZEludGVycnVwdGVkV29yayhjdXJyZW50NCwgaW50ZXJydXB0ZWRXb3JrLCByZW5kZXJMYW5lczIpIHsKICAgICAgICAgIHBvcFRyZWVDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICBzd2l0Y2ggKGludGVycnVwdGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBjaGlsZENvbnRleHRUeXBlcyA9IGludGVycnVwdGVkV29yay50eXBlLmNoaWxkQ29udGV4dFR5cGVzOwogICAgICAgICAgICAgIGlmIChjaGlsZENvbnRleHRUeXBlcyAhPT0gbnVsbCAmJiBjaGlsZENvbnRleHRUeXBlcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwb3BDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBpbnRlcnJ1cHRlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgIHBvcEhvc3RDb250YWluZXIoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICBwb3BUb3BMZXZlbENvbnRleHRPYmplY3QoaW50ZXJydXB0ZWRXb3JrKTsKICAgICAgICAgICAgICByZXNldFdvcmtJblByb2dyZXNzVmVyc2lvbnMoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBwb3BIb3N0Q29udGV4dChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBwb3BIb3N0Q29udGFpbmVyKGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6CiAgICAgICAgICAgICAgcG9wU3VzcGVuc2VDb250ZXh0KGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VMaXN0Q29tcG9uZW50OgogICAgICAgICAgICAgIHBvcFN1c3BlbnNlQ29udGV4dChpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIENvbnRleHRQcm92aWRlcjoKICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IGludGVycnVwdGVkV29yay50eXBlLl9jb250ZXh0OwogICAgICAgICAgICAgIHBvcFByb3ZpZGVyKGNvbnRleHQsIGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDoKICAgICAgICAgICAgICBwb3BSZW5kZXJMYW5lcyhpbnRlcnJ1cHRlZFdvcmspOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VW5kZWZpbmVkU25hcHNob3RCZWZvcmVVcGRhdGUgPSBudWxsOwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFVuZGVmaW5lZFNuYXBzaG90QmVmb3JlVXBkYXRlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICB9CiAgICAgICAgdmFyIG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IGZhbHNlOwogICAgICAgIHZhciBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIFBvc3NpYmx5V2Vha1NldCA9IHR5cGVvZiBXZWFrU2V0ID09PSAiZnVuY3Rpb24iID8gV2Vha1NldCA6IFNldDsKICAgICAgICB2YXIgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgdmFyIGluUHJvZ3Jlc3NMYW5lcyA9IG51bGw7CiAgICAgICAgdmFyIGluUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICBmdW5jdGlvbiByZXBvcnRVbmNhdWdodEVycm9ySW5ERVYoZXJyb3IyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjayhudWxsLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICB0aHJvdyBlcnJvcjI7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjbGVhckNhdWdodEVycm9yKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjYWxsQ29tcG9uZW50V2lsbFVubW91bnRXaXRoVGltZXIgPSBmdW5jdGlvbihjdXJyZW50NCwgaW5zdGFuY2UpIHsKICAgICAgICAgIGluc3RhbmNlLnByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIGluc3RhbmNlLnN0YXRlID0gY3VycmVudDQubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIGlmIChjdXJyZW50NC5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50V2lsbFVubW91bnQoKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihjdXJyZW50NCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50KCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsQ29tbWl0SG9va0xheW91dEVmZmVjdExpc3RNb3VudChjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQsIGN1cnJlbnQ0KTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5Q2FsbENvbXBvbmVudFdpbGxVbm1vdW50KGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBpbnN0YW5jZSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY2FsbENvbXBvbmVudFdpbGxVbm1vdW50V2l0aFRpbWVyKGN1cnJlbnQ0LCBpbnN0YW5jZSk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUNhbGxDb21wb25lbnREaWRNb3VudChjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgaW5zdGFuY2UpIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoY3VycmVudDQsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yMik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNhZmVseUF0dGFjaFJlZihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29tbWl0QXR0YWNoUmVmKGN1cnJlbnQ0KTsKICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZXJyb3IyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2FmZWx5RGV0YWNoUmVmKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB2YXIgcmVmID0gY3VycmVudDQucmVmOwogICAgICAgICAgaWYgKHJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciByZXRWYWw7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxlclRpbWVyICYmIGVuYWJsZVByb2ZpbGVyQ29tbWl0SG9va3MgJiYgY3VycmVudDQubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihudWxsKTsKICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihjdXJyZW50NCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldFZhbCA9IHJlZihudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJldFZhbCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICBlcnJvcigiVW5leHBlY3RlZCByZXR1cm4gdmFsdWUgZnJvbSBhIGNhbGxiYWNrIHJlZiBpbiAlcy4gQSBjYWxsYmFjayByZWYgc2hvdWxkIG5vdCByZXR1cm4gYSBmdW5jdGlvbi4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGN1cnJlbnQ0KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlZi5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBzYWZlbHlDYWxsRGVzdHJveShjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgZGVzdHJveSgpOwogICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZm9jdXNlZEluc3RhbmNlSGFuZGxlID0gbnVsbDsKICAgICAgICB2YXIgc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaXJzdENoaWxkKSB7CiAgICAgICAgICBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBwcmVwYXJlRm9yQ29tbWl0KHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNfYmVnaW4oKTsKICAgICAgICAgIHZhciBzaG91bGRGaXJlID0gc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyOwogICAgICAgICAgc2hvdWxkRmlyZUFmdGVyQWN0aXZlSW5zdGFuY2VCbHVyID0gZmFsc2U7CiAgICAgICAgICBmb2N1c2VkSW5zdGFuY2VIYW5kbGUgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHNob3VsZEZpcmU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c19iZWdpbigpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIEJlZm9yZU11dGF0aW9uTWFzaykgIT09IE5vRmxhZ3MgJiYgY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2NvbXBsZXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzX2NvbXBsZXRlKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBjb21taXRCZWZvcmVNdXRhdGlvbkVmZmVjdHNPbkZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEJlZm9yZU11dGF0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSBmaW5pc2hlZFdvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgdmFyIGZsYWdzID0gZmluaXNoZWRXb3JrLmZsYWdzOwogICAgICAgICAgaWYgKChmbGFncyAmIFNuYXBzaG90KSAhPT0gTm9GbGFncykgewogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgcHJldlByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLnR5cGUgPT09IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSAmJiAhZGlkV2FybkFib3V0UmVhc3NpZ25pbmdQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgcHJvcHMgdG8gbWF0Y2ggbWVtb2l6ZWQgcHJvcHMgYmVmb3JlIGdldFNuYXBzaG90QmVmb3JlVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIGdldFNuYXBzaG90QmVmb3JlVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB2YXIgc25hcHNob3QgPSBpbnN0YW5jZS5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZShmaW5pc2hlZFdvcmsuZWxlbWVudFR5cGUgPT09IGZpbmlzaGVkV29yay50eXBlID8gcHJldlByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wczIoZmluaXNoZWRXb3JrLnR5cGUsIHByZXZQcm9wcyksIHByZXZTdGF0ZSk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZGlkV2FyblNldCA9IGRpZFdhcm5BYm91dFVuZGVmaW5lZFNuYXBzaG90QmVmb3JlVXBkYXRlOwogICAgICAgICAgICAgICAgICAgIGlmIChzbmFwc2hvdCA9PT0gdm9pZCAwICYmICFkaWRXYXJuU2V0LmhhcyhmaW5pc2hlZFdvcmsudHlwZSkpIHsKICAgICAgICAgICAgICAgICAgICAgIGRpZFdhcm5TZXQuYWRkKGZpbmlzaGVkV29yay50eXBlKTsKICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCIlcy5nZXRTbmFwc2hvdEJlZm9yZVVwZGF0ZSgpOiBBIHNuYXBzaG90IHZhbHVlIChvciBudWxsKSBtdXN0IGJlIHJldHVybmVkLiBZb3UgaGF2ZSByZXR1cm5lZCB1bmRlZmluZWQuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuX19yZWFjdEludGVybmFsU25hcHNob3RCZWZvcmVVcGRhdGUgPSBzbmFwc2hvdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciByb290MyA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGNsZWFyQ29udGFpbmVyKHJvb3QzLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OgogICAgICAgICAgICAgIGNhc2UgSG9zdFBvcnRhbDoKICAgICAgICAgICAgICBjYXNlIEluY29tcGxldGVDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGhpcyB1bml0IG9mIHdvcmsgdGFnIHNob3VsZCBub3QgaGF2ZSBzaWRlLWVmZmVjdHMuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChmbGFncywgZmluaXNoZWRXb3JrLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICB2YXIgbGFzdEVmZmVjdCA9IHVwZGF0ZVF1ZXVlICE9PSBudWxsID8gdXBkYXRlUXVldWUubGFzdEVmZmVjdCA6IG51bGw7CiAgICAgICAgICBpZiAobGFzdEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmlyc3RFZmZlY3QgPSBsYXN0RWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIHZhciBlZmZlY3QgPSBmaXJzdEVmZmVjdDsKICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgIGlmICgoZWZmZWN0LnRhZyAmIGZsYWdzKSA9PT0gZmxhZ3MpIHsKICAgICAgICAgICAgICAgIHZhciBkZXN0cm95ID0gZWZmZWN0LmRlc3Ryb3k7CiAgICAgICAgICAgICAgICBlZmZlY3QuZGVzdHJveSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIGlmIChkZXN0cm95ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICgoZmxhZ3MgJiBQYXNzaXZlJDEpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRQYXNzaXZlRWZmZWN0VW5tb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKChmbGFncyAmIExheW91dCkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudExheW91dEVmZmVjdFVubW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGZpbmlzaGVkV29yaywgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChmbGFncyAmIFBhc3NpdmUkMSkgIT09IE5vRmxhZ3MkMSkgewogICAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RVbm1vdW50U3RvcHBlZCgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGZsYWdzICYgTGF5b3V0KSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZWZmZWN0ID0gZWZmZWN0Lm5leHQ7CiAgICAgICAgICAgIH0gd2hpbGUgKGVmZmVjdCAhPT0gZmlyc3RFZmZlY3QpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KGZsYWdzLCBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUgIT09IG51bGwgPyB1cGRhdGVRdWV1ZS5sYXN0RWZmZWN0IDogbnVsbDsKICAgICAgICAgIGlmIChsYXN0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaXJzdEVmZmVjdCA9IGxhc3RFZmZlY3QubmV4dDsKICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgaWYgKChlZmZlY3QudGFnICYgZmxhZ3MpID09PSBmbGFncykgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0YXJ0ZWQoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdGFydGVkKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjcmVhdGUgPSBlZmZlY3QuY3JlYXRlOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KHRydWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlZmZlY3QuZGVzdHJveSA9IGNyZWF0ZSgpOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgSW5zZXJ0aW9uKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KGZhbHNlKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoKGZsYWdzICYgUGFzc2l2ZSQxKSAhPT0gTm9GbGFncyQxKSB7CiAgICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFBhc3NpdmVFZmZlY3RNb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICgoZmxhZ3MgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0TW91bnRTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgdmFyIGRlc3Ryb3kgPSBlZmZlY3QuZGVzdHJveTsKICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgIT09IHZvaWQgMCAmJiB0eXBlb2YgZGVzdHJveSAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHZhciBob29rTmFtZSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgICBpZiAoKGVmZmVjdC50YWcgJiBMYXlvdXQpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VMYXlvdXRFZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoKGVmZmVjdC50YWcgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VJbnNlcnRpb25FZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICBob29rTmFtZSA9ICJ1c2VFZmZlY3QiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIgYWRkZW5kdW0gPSB2b2lkIDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlc3Ryb3kgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBZb3UgcmV0dXJuZWQgbnVsbC4gSWYgeW91ciBlZmZlY3QgZG9lcyBub3QgcmVxdWlyZSBjbGVhbiB1cCwgcmV0dXJuIHVuZGVmaW5lZCAob3Igbm90aGluZykuIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZXN0cm95LnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIlxuXG5JdCBsb29rcyBsaWtlIHlvdSB3cm90ZSAiICsgaG9va05hbWUgKyAiKGFzeW5jICgpID0+IC4uLikgb3IgcmV0dXJuZWQgYSBQcm9taXNlLiBJbnN0ZWFkLCB3cml0ZSB0aGUgYXN5bmMgZnVuY3Rpb24gaW5zaWRlIHlvdXIgZWZmZWN0IGFuZCBjYWxsIGl0IGltbWVkaWF0ZWx5OlxuXG4iICsgaG9va05hbWUgKyAiKCgpID0+IHtcbiAgYXN5bmMgZnVuY3Rpb24gZmV0Y2hEYXRhKCkge1xuICAgIC8vIFlvdSBjYW4gYXdhaXQgaGVyZVxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgTXlBUEkuZ2V0RGF0YShzb21lSWQpO1xuICAgIC8vIC4uLlxuICB9XG4gIGZldGNoRGF0YSgpO1xufSwgW3NvbWVJZF0pOyAvLyBPciBbXSBpZiBlZmZlY3QgZG9lc24ndCBuZWVkIHByb3BzIG9yIHN0YXRlXG5cbkxlYXJuIG1vcmUgYWJvdXQgZGF0YSBmZXRjaGluZyB3aXRoIEhvb2tzOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvaG9va3MtZGF0YS1mZXRjaGluZyI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIGFkZGVuZHVtID0gIiBZb3UgcmV0dXJuZWQ6ICIgKyBkZXN0cm95OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlcnJvcigiJXMgbXVzdCBub3QgcmV0dXJuIGFueXRoaW5nIGJlc2lkZXMgYSBmdW5jdGlvbiwgd2hpY2ggaXMgdXNlZCBmb3IgY2xlYW4tdXAuJXMiLCBob29rTmFtZSwgYWRkZW5kdW0pOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVmZmVjdCA9IGVmZmVjdC5uZXh0OwogICAgICAgICAgICB9IHdoaWxlIChlZmZlY3QgIT09IGZpcnN0RWZmZWN0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZUVmZmVjdER1cmF0aW9ucyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoKGZpbmlzaGVkV29yay5mbGFncyAmIFVwZGF0ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6IHsKICAgICAgICAgICAgICAgICAgdmFyIHBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGUucGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICB2YXIgX2ZpbmlzaGVkV29yayRtZW1vaXplID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMsIGlkID0gX2ZpbmlzaGVkV29yayRtZW1vaXplLmlkLCBvblBvc3RDb21taXQgPSBfZmluaXNoZWRXb3JrJG1lbW9pemUub25Qb3N0Q29tbWl0OwogICAgICAgICAgICAgICAgICB2YXIgY29tbWl0VGltZTIgPSBnZXRDb21taXRUaW1lKCk7CiAgICAgICAgICAgICAgICAgIHZhciBwaGFzZSA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGUgPT09IG51bGwgPyAibW91bnQiIDogInVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNDdXJyZW50VXBkYXRlTmVzdGVkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHBoYXNlID0gIm5lc3RlZC11cGRhdGUiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9uUG9zdENvbW1pdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIG9uUG9zdENvbW1pdChpZCwgcGhhc2UsIHBhc3NpdmVFZmZlY3REdXJhdGlvbiwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpbmlzaGVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICAgIG91dGVyOiB3aGlsZSAocGFyZW50RmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudEZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gcGFyZW50RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgICAgICByb290My5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gcGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRTdGF0ZU5vZGUgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFN0YXRlTm9kZS5wYXNzaXZlRWZmZWN0RHVyYXRpb24gKz0gcGFzc2l2ZUVmZmVjdER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhayBvdXRlcjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcGFyZW50RmliZXIgPSBwYXJlbnRGaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdExheW91dEVmZmVjdE9uRmliZXIoZmluaXNoZWRSb290LCBjdXJyZW50NCwgZmluaXNoZWRXb3JrLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgaWYgKChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBMYXlvdXRNYXNrKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBpZiAoIW9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBjb21wb25lbnREaWRNb3VudC4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5wcm9wc2AuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHN0YXRlIHRvIG1hdGNoIG1lbW9pemVkIHN0YXRlIGJlZm9yZSBjb21wb25lbnREaWRNb3VudC4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlLmNvbXBvbmVudERpZE1vdW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQoKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZQcm9wcyA9IGZpbmlzaGVkV29yay5lbGVtZW50VHlwZSA9PT0gZmluaXNoZWRXb3JrLnR5cGUgPyBjdXJyZW50NC5tZW1vaXplZFByb3BzIDogcmVzb2x2ZURlZmF1bHRQcm9wczIoZmluaXNoZWRXb3JrLnR5cGUsIGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMpOwogICAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnByb3BzICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkICVzIHByb3BzIHRvIG1hdGNoIG1lbW9pemVkIHByb3BzIGJlZm9yZSBjb21wb25lbnREaWRVcGRhdGUuIFRoaXMgbWlnaHQgZWl0aGVyIGJlIGJlY2F1c2Ugb2YgYSBidWcgaW4gUmVhY3QsIG9yIGJlY2F1c2UgYSBjb21wb25lbnQgcmVhc3NpZ25zIGl0cyBvd24gYHRoaXMucHJvcHNgLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iLCBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKGZpbmlzaGVkV29yaykgfHwgImluc3RhbmNlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZS5zdGF0ZSAhPT0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBzdGF0ZSB0byBtYXRjaCBtZW1vaXplZCBzdGF0ZSBiZWZvcmUgY29tcG9uZW50RGlkVXBkYXRlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnN0YXRlYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlKHByZXZQcm9wcywgcHJldlN0YXRlLCBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxTbmFwc2hvdEJlZm9yZVVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2UuY29tcG9uZW50RGlkVXBkYXRlKHByZXZQcm9wcywgcHJldlN0YXRlLCBpbnN0YW5jZS5fX3JlYWN0SW50ZXJuYWxTbmFwc2hvdEJlZm9yZVVwZGF0ZSk7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICBpZiAodXBkYXRlUXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsudHlwZSA9PT0gZmluaXNoZWRXb3JrLmVsZW1lbnRUeXBlICYmICFkaWRXYXJuQWJvdXRSZWFzc2lnbmluZ1Byb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2UucHJvcHMgIT09IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yKCJFeHBlY3RlZCAlcyBwcm9wcyB0byBtYXRjaCBtZW1vaXplZCBwcm9wcyBiZWZvcmUgcHJvY2Vzc2luZyB0aGUgdXBkYXRlIHF1ZXVlLiBUaGlzIG1pZ2h0IGVpdGhlciBiZSBiZWNhdXNlIG9mIGEgYnVnIGluIFJlYWN0LCBvciBiZWNhdXNlIGEgY29tcG9uZW50IHJlYXNzaWducyBpdHMgb3duIGB0aGlzLnByb3BzYC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaW5pc2hlZFdvcmspIHx8ICJpbnN0YW5jZSIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlLnN0YXRlICE9PSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcigiRXhwZWN0ZWQgJXMgc3RhdGUgdG8gbWF0Y2ggbWVtb2l6ZWQgc3RhdGUgYmVmb3JlIHByb2Nlc3NpbmcgdGhlIHVwZGF0ZSBxdWV1ZS4gVGhpcyBtaWdodCBlaXRoZXIgYmUgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBSZWFjdCwgb3IgYmVjYXVzZSBhIGNvbXBvbmVudCByZWFzc2lnbnMgaXRzIG93biBgdGhpcy5zdGF0ZWAuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSB8fCAiaW5zdGFuY2UiKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgY29tbWl0VXBkYXRlUXVldWUoZmluaXNoZWRXb3JrLCB1cGRhdGVRdWV1ZSwgaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICAgIHZhciBfdXBkYXRlUXVldWUgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgICBpZiAoX3VwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UgPSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLmNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsuY2hpbGQudGFnKSB7CiAgICAgICAgICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIF9pbnN0YW5jZSA9IGdldFB1YmxpY0luc3RhbmNlKGZpbmlzaGVkV29yay5jaGlsZC5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIF9pbnN0YW5jZSA9IGZpbmlzaGVkV29yay5jaGlsZC5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjb21taXRVcGRhdGVRdWV1ZShmaW5pc2hlZFdvcmssIF91cGRhdGVRdWV1ZSwgX2luc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UyID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50NCA9PT0gbnVsbCAmJiBmaW5pc2hlZFdvcmsuZmxhZ3MgJiBVcGRhdGUpIHsKICAgICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBmaW5pc2hlZFdvcmsudHlwZTsKICAgICAgICAgICAgICAgICAgdmFyIHByb3BzID0gZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHM7CiAgICAgICAgICAgICAgICAgIGNvbW1pdE1vdW50KF9pbnN0YW5jZTIsIHR5cGUsIHByb3BzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIEhvc3RUZXh0OiB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0UG9ydGFsOiB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBQcm9maWxlcjogewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YXIgX2ZpbmlzaGVkV29yayRtZW1vaXplMiA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzLCBvbkNvbW1pdCA9IF9maW5pc2hlZFdvcmskbWVtb2l6ZTIub25Db21taXQsIG9uUmVuZGVyID0gX2ZpbmlzaGVkV29yayRtZW1vaXplMi5vblJlbmRlcjsKICAgICAgICAgICAgICAgICAgdmFyIGVmZmVjdER1cmF0aW9uID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZS5lZmZlY3REdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgdmFyIGNvbW1pdFRpbWUyID0gZ2V0Q29tbWl0VGltZSgpOwogICAgICAgICAgICAgICAgICB2YXIgcGhhc2UgPSBjdXJyZW50NCA9PT0gbnVsbCA/ICJtb3VudCIgOiAidXBkYXRlIjsKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChpc0N1cnJlbnRVcGRhdGVOZXN0ZWQoKSkgewogICAgICAgICAgICAgICAgICAgICAgcGhhc2UgPSAibmVzdGVkLXVwZGF0ZSI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb25SZW5kZXIgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICBvblJlbmRlcihmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wcy5pZCwgcGhhc2UsIGZpbmlzaGVkV29yay5hY3R1YWxEdXJhdGlvbiwgZmluaXNoZWRXb3JrLnRyZWVCYXNlRHVyYXRpb24sIGZpbmlzaGVkV29yay5hY3R1YWxTdGFydFRpbWUsIGNvbW1pdFRpbWUyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvbkNvbW1pdCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgb25Db21taXQoZmluaXNoZWRXb3JrLm1lbW9pemVkUHJvcHMuaWQsIHBoYXNlLCBlZmZlY3REdXJhdGlvbiwgY29tbWl0VGltZTIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbnF1ZXVlUGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdChmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGZpbmlzaGVkV29yay5yZXR1cm47CiAgICAgICAgICAgICAgICAgICAgb3V0ZXI6IHdoaWxlIChwYXJlbnRGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBIb3N0Um9vdDoKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBwYXJlbnRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgcm9vdDMuZWZmZWN0RHVyYXRpb24gKz0gZWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgUHJvZmlsZXI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudFN0YXRlTm9kZSA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRTdGF0ZU5vZGUuZWZmZWN0RHVyYXRpb24gKz0gZWZmZWN0RHVyYXRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsgb3V0ZXI7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRGaWJlciA9IHBhcmVudEZpYmVyLnJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBjb21taXRTdXNwZW5zZUh5ZHJhdGlvbkNhbGxiYWNrcyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBJbmNvbXBsZXRlQ2xhc3NDb21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIE9mZnNjcmVlbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIExlZ2FjeUhpZGRlbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFRyYWNpbmdNYXJrZXJDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHVuaXQgb2Ygd29yayB0YWcgc2hvdWxkIG5vdCBoYXZlIHNpZGUtZWZmZWN0cy4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLmZsYWdzICYgUmVmMikgewogICAgICAgICAgICAgICAgY29tbWl0QXR0YWNoUmVmKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlYXBwZWFyTGF5b3V0RWZmZWN0c09uRmliZXIobm9kZSkgewogICAgICAgICAgc3dpdGNoIChub2RlLnRhZykgewogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAobm9kZS5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgc2FmZWx5Q2FsbENvbW1pdEhvb2tMYXlvdXRFZmZlY3RMaXN0TW91bnQobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24obm9kZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21taXRIb29rTGF5b3V0RWZmZWN0TGlzdE1vdW50KG5vZGUsIG5vZGUucmV0dXJuKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkTW91bnQgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnREaWRNb3VudChub2RlLCBub2RlLnJldHVybiwgaW5zdGFuY2UpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBzYWZlbHlBdHRhY2hSZWYobm9kZSwgbm9kZS5yZXR1cm4pOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHNhZmVseUF0dGFjaFJlZihub2RlLCBub2RlLnJldHVybik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGlkZU9yVW5oaWRlQWxsQ2hpbGRyZW4oZmluaXNoZWRXb3JrLCBpc0hpZGRlbikgewogICAgICAgICAgdmFyIGhvc3RTdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBub2RlID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIGlmIChub2RlLnRhZyA9PT0gSG9zdENvbXBvbmVudCkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RTdWJ0cmVlUm9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBub2RlOwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgICAgaGlkZUluc3RhbmNlKGluc3RhbmNlKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdW5oaWRlSW5zdGFuY2Uobm9kZS5zdGF0ZU5vZGUsIG5vZGUubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUudGFnID09PSBIb3N0VGV4dCkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RTdWJ0cmVlUm9vdCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciBfaW5zdGFuY2UzID0gbm9kZS5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBoaWRlVGV4dEluc3RhbmNlKF9pbnN0YW5jZTMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICB1bmhpZGVUZXh0SW5zdGFuY2UoX2luc3RhbmNlMywgbm9kZS5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSBpZiAoKG5vZGUudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQgfHwgbm9kZS50YWcgPT09IExlZ2FjeUhpZGRlbkNvbXBvbmVudCkgJiYgbm9kZS5tZW1vaXplZFN0YXRlICE9PSBudWxsICYmIG5vZGUgIT09IGZpbmlzaGVkV29yaykgOwogICAgICAgICAgICAgIGVsc2UgaWYgKG5vZGUuY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5vZGUuY2hpbGQucmV0dXJuID0gbm9kZTsKICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlLmNoaWxkOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgd2hpbGUgKG5vZGUuc2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGhvc3RTdWJ0cmVlUm9vdCA9PT0gbm9kZSkgewogICAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAoaG9zdFN1YnRyZWVSb290ID09PSBub2RlKSB7CiAgICAgICAgICAgICAgICBob3N0U3VidHJlZVJvb3QgPSBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlLnNpYmxpbmcucmV0dXJuID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuc2libGluZzsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRBdHRhY2hSZWYoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgcmVmID0gZmluaXNoZWRXb3JrLnJlZjsKICAgICAgICAgIGlmIChyZWYgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgdmFyIGluc3RhbmNlVG9Vc2U7CiAgICAgICAgICAgIHN3aXRjaCAoZmluaXNoZWRXb3JrLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgIGluc3RhbmNlVG9Vc2UgPSBnZXRQdWJsaWNJbnN0YW5jZShpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgaW5zdGFuY2VUb1VzZSA9IGluc3RhbmNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgdmFyIHJldFZhbDsKICAgICAgICAgICAgICBpZiAoZmluaXNoZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgc3RhcnRMYXlvdXRFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgICByZXRWYWwgPSByZWYoaW5zdGFuY2VUb1VzZSk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXRWYWwgPSByZWYoaW5zdGFuY2VUb1VzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmV0VmFsID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJVbmV4cGVjdGVkIHJldHVybiB2YWx1ZSBmcm9tIGEgY2FsbGJhY2sgcmVmIGluICVzLiBBIGNhbGxiYWNrIHJlZiBzaG91bGQgbm90IHJldHVybiBhIGZ1bmN0aW9uLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICghcmVmLmhhc093blByb3BlcnR5KCJjdXJyZW50IikpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIlVuZXhwZWN0ZWQgcmVmIG9iamVjdCBwcm92aWRlZCBmb3IgJXMuIFVzZSBlaXRoZXIgYSByZWYtc2V0dGVyIGZ1bmN0aW9uIG9yIFJlYWN0LmNyZWF0ZVJlZigpLiIsIGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmluaXNoZWRXb3JrKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlZi5jdXJyZW50ID0gaW5zdGFuY2VUb1VzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZXRhY2hGaWJlck11dGF0aW9uKGZpYmVyKSB7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBhbHRlcm5hdGUucmV0dXJuID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIGZpYmVyLnJldHVybiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRldGFjaEZpYmVyQWZ0ZXJFZmZlY3RzKGZpYmVyKSB7CiAgICAgICAgICB2YXIgYWx0ZXJuYXRlID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGFsdGVybmF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUgPSBudWxsOwogICAgICAgICAgICBkZXRhY2hGaWJlckFmdGVyRWZmZWN0cyhhbHRlcm5hdGUpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBmaWJlci5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgIGZpYmVyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIGZpYmVyLnNpYmxpbmcgPSBudWxsOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgdmFyIGhvc3RJbnN0YW5jZSA9IGZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBkZXRhY2hEZWxldGVkSW5zdGFuY2UoaG9zdEluc3RhbmNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZmliZXIucmV0dXJuID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci5kZXBlbmRlbmNpZXMgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkU3RhdGUgPSBudWxsOwogICAgICAgICAgICAgIGZpYmVyLnBlbmRpbmdQcm9wcyA9IG51bGw7CiAgICAgICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgICBmaWJlci51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0SG9zdFBhcmVudEZpYmVyKGZpYmVyKSB7CiAgICAgICAgICB2YXIgcGFyZW50ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgd2hpbGUgKHBhcmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICBpZiAoaXNIb3N0UGFyZW50KHBhcmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcGFyZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBhcmVudCA9IHBhcmVudC5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHRvIGZpbmQgYSBob3N0IHBhcmVudC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNIb3N0UGFyZW50KGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gZmliZXIudGFnID09PSBIb3N0Q29tcG9uZW50IHx8IGZpYmVyLnRhZyA9PT0gSG9zdFJvb3QgfHwgZmliZXIudGFnID09PSBIb3N0UG9ydGFsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRIb3N0U2libGluZyhmaWJlcikgewogICAgICAgICAgdmFyIG5vZGUgPSBmaWJlcjsKICAgICAgICAgIHNpYmxpbmdzOiB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IGlzSG9zdFBhcmVudChub2RlLnJldHVybikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB3aGlsZSAobm9kZS50YWcgIT09IEhvc3RDb21wb25lbnQgJiYgbm9kZS50YWcgIT09IEhvc3RUZXh0ICYmIG5vZGUudGFnICE9PSBEZWh5ZHJhdGVkRnJhZ21lbnQpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5mbGFncyAmIFBsYWNlbWVudCkgewogICAgICAgICAgICAgICAgY29udGludWUgc2libGluZ3M7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChub2RlLmNoaWxkID09PSBudWxsIHx8IG5vZGUudGFnID09PSBIb3N0UG9ydGFsKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZSBzaWJsaW5nczsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghKG5vZGUuZmxhZ3MgJiBQbGFjZW1lbnQpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBsYWNlbWVudChmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBwYXJlbnRGaWJlciA9IGdldEhvc3RQYXJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgc3dpdGNoIChwYXJlbnRGaWJlci50YWcpIHsKICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICBpZiAocGFyZW50RmliZXIuZmxhZ3MgJiBDb250ZW50UmVzZXQpIHsKICAgICAgICAgICAgICAgIHJlc2V0VGV4dENvbnRlbnQocGFyZW50KTsKICAgICAgICAgICAgICAgIHBhcmVudEZpYmVyLmZsYWdzICY9IH5Db250ZW50UmVzZXQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBiZWZvcmUgPSBnZXRIb3N0U2libGluZyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShmaW5pc2hlZFdvcmssIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICB2YXIgX3BhcmVudCA9IHBhcmVudEZpYmVyLnN0YXRlTm9kZS5jb250YWluZXJJbmZvOwogICAgICAgICAgICAgIHZhciBfYmVmb3JlID0gZ2V0SG9zdFNpYmxpbmcoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGVJbnRvQ29udGFpbmVyKGZpbmlzaGVkV29yaywgX2JlZm9yZSwgX3BhcmVudCk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgaG9zdCBwYXJlbnQgZmliZXIuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZUludG9Db250YWluZXIobm9kZSwgYmVmb3JlLCBwYXJlbnQpIHsKICAgICAgICAgIHZhciB0YWcgPSBub2RlLnRhZzsKICAgICAgICAgIHZhciBpc0hvc3QgPSB0YWcgPT09IEhvc3RDb21wb25lbnQgfHwgdGFnID09PSBIb3N0VGV4dDsKICAgICAgICAgIGlmIChpc0hvc3QpIHsKICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoYmVmb3JlKSB7CiAgICAgICAgICAgICAgaW5zZXJ0SW5Db250YWluZXJCZWZvcmUocGFyZW50LCBzdGF0ZU5vZGUsIGJlZm9yZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXBwZW5kQ2hpbGRUb0NvbnRhaW5lcihwYXJlbnQsIHN0YXRlTm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAodGFnID09PSBIb3N0UG9ydGFsKSA7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgaWYgKGNoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihjaGlsZCwgYmVmb3JlLCBwYXJlbnQpOwogICAgICAgICAgICAgIHZhciBzaWJsaW5nID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICB3aGlsZSAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaW5zZXJ0T3JBcHBlbmRQbGFjZW1lbnROb2RlSW50b0NvbnRhaW5lcihzaWJsaW5nLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgICBzaWJsaW5nID0gc2libGluZy5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGUobm9kZSwgYmVmb3JlLCBwYXJlbnQpIHsKICAgICAgICAgIHZhciB0YWcgPSBub2RlLnRhZzsKICAgICAgICAgIHZhciBpc0hvc3QgPSB0YWcgPT09IEhvc3RDb21wb25lbnQgfHwgdGFnID09PSBIb3N0VGV4dDsKICAgICAgICAgIGlmIChpc0hvc3QpIHsKICAgICAgICAgICAgdmFyIHN0YXRlTm9kZSA9IG5vZGUuc3RhdGVOb2RlOwogICAgICAgICAgICBpZiAoYmVmb3JlKSB7CiAgICAgICAgICAgICAgaW5zZXJ0QmVmb3JlKHBhcmVudCwgc3RhdGVOb2RlLCBiZWZvcmUpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGFwcGVuZENoaWxkKHBhcmVudCwgc3RhdGVOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0YWcgPT09IEhvc3RQb3J0YWwpIDsKICAgICAgICAgIGVsc2UgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBub2RlLmNoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpbnNlcnRPckFwcGVuZFBsYWNlbWVudE5vZGUoY2hpbGQsIGJlZm9yZSwgcGFyZW50KTsKICAgICAgICAgICAgICB2YXIgc2libGluZyA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgd2hpbGUgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGluc2VydE9yQXBwZW5kUGxhY2VtZW50Tm9kZShzaWJsaW5nLCBiZWZvcmUsIHBhcmVudCk7CiAgICAgICAgICAgICAgICBzaWJsaW5nID0gc2libGluZy5zaWJsaW5nOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgaG9zdFBhcmVudCA9IG51bGw7CiAgICAgICAgdmFyIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGNvbW1pdERlbGV0aW9uRWZmZWN0cyhyb290MywgcmV0dXJuRmliZXIsIGRlbGV0ZWRGaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgcGFyZW50ID0gcmV0dXJuRmliZXI7CiAgICAgICAgICAgIGZpbmRQYXJlbnQ6IHdoaWxlIChwYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKHBhcmVudC50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gcGFyZW50LnN0YXRlTm9kZTsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGZpbmRQYXJlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OiB7CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBwYXJlbnQuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICAgIGhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IHRydWU7CiAgICAgICAgICAgICAgICAgIGJyZWFrIGZpbmRQYXJlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHBhcmVudC5zdGF0ZU5vZGUuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgYnJlYWsgZmluZFBhcmVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaG9zdFBhcmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gZmluZCBhIGhvc3QgcGFyZW50LiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIocm9vdDMsIHJldHVybkZpYmVyLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBkZXRhY2hGaWJlck11dGF0aW9uKGRlbGV0ZWRGaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBwYXJlbnQpIHsKICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudC5jaGlsZDsKICAgICAgICAgIHdoaWxlIChjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICBjb21taXREZWxldGlvbkVmZmVjdHNPbkZpYmVyKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgY2hpbGQpOwogICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdERlbGV0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpIHsKICAgICAgICAgIG9uQ29tbWl0VW5tb3VudChkZWxldGVkRmliZXIpOwogICAgICAgICAgc3dpdGNoIChkZWxldGVkRmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgc2FmZWx5RGV0YWNoUmVmKGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFRleHQ6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcHJldkhvc3RQYXJlbnQgPSBob3N0UGFyZW50OwogICAgICAgICAgICAgICAgdmFyIHByZXZIb3N0UGFyZW50SXNDb250YWluZXIgPSBob3N0UGFyZW50SXNDb250YWluZXI7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgaG9zdFBhcmVudCA9IHByZXZIb3N0UGFyZW50OwogICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGlmIChob3N0UGFyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGlmIChob3N0UGFyZW50SXNDb250YWluZXIpIHsKICAgICAgICAgICAgICAgICAgICByZW1vdmVDaGlsZEZyb21Db250YWluZXIoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQ2hpbGQoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgRGVoeWRyYXRlZEZyYWdtZW50OiB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgaWYgKGhvc3RQYXJlbnRJc0NvbnRhaW5lcikgewogICAgICAgICAgICAgICAgICAgIGNsZWFyU3VzcGVuc2VCb3VuZGFyeUZyb21Db250YWluZXIoaG9zdFBhcmVudCwgZGVsZXRlZEZpYmVyLnN0YXRlTm9kZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY2xlYXJTdXNwZW5zZUJvdW5kYXJ5KGhvc3RQYXJlbnQsIGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgX3ByZXZIb3N0UGFyZW50ID0gaG9zdFBhcmVudDsKICAgICAgICAgICAgICAgIHZhciBfcHJldkhvc3RQYXJlbnRJc0NvbnRhaW5lciA9IGhvc3RQYXJlbnRJc0NvbnRhaW5lcjsKICAgICAgICAgICAgICAgIGhvc3RQYXJlbnQgPSBkZWxldGVkRmliZXIuc3RhdGVOb2RlLmNvbnRhaW5lckluZm87CiAgICAgICAgICAgICAgICBob3N0UGFyZW50SXNDb250YWluZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgICBob3N0UGFyZW50ID0gX3ByZXZIb3N0UGFyZW50OwogICAgICAgICAgICAgICAgaG9zdFBhcmVudElzQ29udGFpbmVyID0gX3ByZXZIb3N0UGFyZW50SXNDb250YWluZXI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICBjYXNlIE1lbW9Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmICghb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVF1ZXVlID0gZGVsZXRlZEZpYmVyLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHZhciBsYXN0RWZmZWN0ID0gdXBkYXRlUXVldWUubGFzdEVmZmVjdDsKICAgICAgICAgICAgICAgICAgaWYgKGxhc3RFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZmlyc3RFZmZlY3QgPSBsYXN0RWZmZWN0Lm5leHQ7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVmZmVjdCA9IGZpcnN0RWZmZWN0OwogICAgICAgICAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgICAgICAgIHZhciBfZWZmZWN0ID0gZWZmZWN0LCBkZXN0cm95ID0gX2VmZmVjdC5kZXN0cm95LCB0YWcgPSBfZWZmZWN0LnRhZzsKICAgICAgICAgICAgICAgICAgICAgIGlmIChkZXN0cm95ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCh0YWcgJiBJbnNlcnRpb24pICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsRGVzdHJveShkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlc3Ryb3kpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCh0YWcgJiBMYXlvdXQpICE9PSBOb0ZsYWdzJDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0YXJ0ZWQoZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRlbGV0ZWRGaWJlci5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0TGF5b3V0RWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxEZXN0cm95KGRlbGV0ZWRGaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVzdHJveSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvcmRMYXlvdXRFZmZlY3REdXJhdGlvbihkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYWZlbHlDYWxsRGVzdHJveShkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlc3Ryb3kpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXJrQ29tcG9uZW50TGF5b3V0RWZmZWN0VW5tb3VudFN0b3BwZWQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGVmZmVjdCA9IGVmZmVjdC5uZXh0OwogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKGVmZmVjdCAhPT0gZmlyc3RFZmZlY3QpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VEZWxldGlvbkVmZmVjdHMoZmluaXNoZWRSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yLCBkZWxldGVkRmliZXIpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKCFvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZGVsZXRlZEZpYmVyLCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGRlbGV0ZWRGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChkZWxldGVkRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU2NvcGVDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAvLyBUT0RPOiBSZW1vdmUgdGhpcyBkZWFkIGZsYWcKICAgICAgICAgICAgICAgIGRlbGV0ZWRGaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUKICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiA9IG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gfHwgZGVsZXRlZEZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZURlbGV0aW9uRWZmZWN0cyhmaW5pc2hlZFJvb3QsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGRlbGV0ZWRGaWJlcik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlRGVsZXRpb25FZmZlY3RzKGZpbmlzaGVkUm9vdCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvciwgZGVsZXRlZEZpYmVyKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0U3VzcGVuc2VDYWxsYmFjayhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGZpbmlzaGVkV29yay5tZW1vaXplZFN0YXRlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRTdXNwZW5zZUh5ZHJhdGlvbkNhbGxiYWNrcyhmaW5pc2hlZFJvb3QsIGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIG5ld1N0YXRlID0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICBpZiAobmV3U3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gZmluaXNoZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgaWYgKHByZXZTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdmFyIHN1c3BlbnNlSW5zdGFuY2UgPSBwcmV2U3RhdGUuZGVoeWRyYXRlZDsKICAgICAgICAgICAgICAgIGlmIChzdXNwZW5zZUluc3RhbmNlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEh5ZHJhdGVkU3VzcGVuc2VJbnN0YW5jZShzdXNwZW5zZUluc3RhbmNlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0YWNoU3VzcGVuc2VSZXRyeUxpc3RlbmVycyhmaW5pc2hlZFdvcmspIHsKICAgICAgICAgIHZhciB3YWtlYWJsZXMgPSBmaW5pc2hlZFdvcmsudXBkYXRlUXVldWU7CiAgICAgICAgICBpZiAod2FrZWFibGVzICE9PSBudWxsKSB7CiAgICAgICAgICAgIGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIHZhciByZXRyeUNhY2hlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZTsKICAgICAgICAgICAgaWYgKHJldHJ5Q2FjaGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXRyeUNhY2hlID0gZmluaXNoZWRXb3JrLnN0YXRlTm9kZSA9IG5ldyBQb3NzaWJseVdlYWtTZXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3YWtlYWJsZXMuZm9yRWFjaChmdW5jdGlvbih3YWtlYWJsZSkgewogICAgICAgICAgICAgIHZhciByZXRyeSA9IHJlc29sdmVSZXRyeVdha2VhYmxlLmJpbmQobnVsbCwgZmluaXNoZWRXb3JrLCB3YWtlYWJsZSk7CiAgICAgICAgICAgICAgaWYgKCFyZXRyeUNhY2hlLmhhcyh3YWtlYWJsZSkpIHsKICAgICAgICAgICAgICAgIHJldHJ5Q2FjaGUuYWRkKHdha2VhYmxlKTsKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluUHJvZ3Jlc3NMYW5lcyAhPT0gbnVsbCAmJiBpblByb2dyZXNzUm9vdCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhpblByb2dyZXNzUm9vdCwgaW5Qcm9ncmVzc0xhbmVzKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoIkV4cGVjdGVkIGZpbmlzaGVkIHJvb3QgYW5kIGxhbmVzIHRvIGJlIHNldC4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdha2VhYmxlLnRoZW4ocmV0cnksIHJldHJ5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yaywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIGluUHJvZ3Jlc3NMYW5lcyA9IGNvbW1pdHRlZExhbmVzOwogICAgICAgICAgaW5Qcm9ncmVzc1Jvb3QgPSByb290MzsKICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgY29tbWl0TXV0YXRpb25FZmZlY3RzT25GaWJlcihmaW5pc2hlZFdvcmssIHJvb3QzKTsKICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaW5pc2hlZFdvcmspOwogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICAgIGluUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgcGFyZW50RmliZXIsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgZGVsZXRpb25zID0gcGFyZW50RmliZXIuZGVsZXRpb25zOwogICAgICAgICAgaWYgKGRlbGV0aW9ucyAhPT0gbnVsbCkgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRlbGV0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgIHZhciBjaGlsZFRvRGVsZXRlID0gZGVsZXRpb25zW2ldOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXREZWxldGlvbkVmZmVjdHMocm9vdDMsIHBhcmVudEZpYmVyLCBjaGlsZFRvRGVsZXRlKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGNoaWxkVG9EZWxldGUsIHBhcmVudEZpYmVyLCBlcnJvcjIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZEZWJ1Z0ZpYmVyID0gZ2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICBpZiAocGFyZW50RmliZXIuc3VidHJlZUZsYWdzICYgTXV0YXRpb25NYXNrKSB7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IHBhcmVudEZpYmVyLmNoaWxkOwogICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoY2hpbGQpOwogICAgICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0c09uRmliZXIoY2hpbGQsIHJvb3QzKTsKICAgICAgICAgICAgICBjaGlsZCA9IGNoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihwcmV2RGVidWdGaWJlcik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdE11dGF0aW9uRWZmZWN0c09uRmliZXIoZmluaXNoZWRXb3JrLCByb290MywgbGFuZXMpIHsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpbmlzaGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICB2YXIgZmxhZ3MgPSBmaW5pc2hlZFdvcmsuZmxhZ3M7CiAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KEluc2VydGlvbiB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChJbnNlcnRpb24gfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuKTsKICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJlY29yZExheW91dEVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChMYXlvdXQgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgUmVmMikgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihjdXJyZW50NCwgY3VycmVudDQucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgUmVmMikgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseURldGFjaFJlZihjdXJyZW50NCwgY3VycmVudDQucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5mbGFncyAmIENvbnRlbnRSZXNldCkgewogICAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHJlc2V0VGV4dENvbnRlbnQoaW5zdGFuY2UpOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgICB2YXIgX2luc3RhbmNlNCA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICAgIGlmIChfaW5zdGFuY2U0ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgbmV3UHJvcHMgPSBmaW5pc2hlZFdvcmsubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgb2xkUHJvcHMgPSBjdXJyZW50NCAhPT0gbnVsbCA/IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHMgOiBuZXdQcm9wczsKICAgICAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGZpbmlzaGVkV29yay50eXBlOwogICAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGVQYXlsb2FkID0gZmluaXNoZWRXb3JrLnVwZGF0ZVF1ZXVlOwogICAgICAgICAgICAgICAgICAgIGZpbmlzaGVkV29yay51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVwZGF0ZVBheWxvYWQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1pdFVwZGF0ZShfaW5zdGFuY2U0LCB1cGRhdGVQYXlsb2FkLCB0eXBlLCBvbGRQcm9wcywgbmV3UHJvcHMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmluaXNoZWRXb3JrLCBmaW5pc2hlZFdvcmsucmV0dXJuLCBlcnJvcjIpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBIb3N0VGV4dDogewogICAgICAgICAgICAgIHJlY3Vyc2l2ZWx5VHJhdmVyc2VNdXRhdGlvbkVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVXBkYXRlKSB7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsuc3RhdGVOb2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIHNob3VsZCBoYXZlIGEgdGV4dCBub2RlIGluaXRpYWxpemVkLiBUaGlzIGVycm9yIGlzIGxpa2VseSBjYXVzZWQgYnkgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciB0ZXh0SW5zdGFuY2UgPSBmaW5pc2hlZFdvcmsuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgICB2YXIgbmV3VGV4dCA9IGZpbmlzaGVkV29yay5tZW1vaXplZFByb3BzOwogICAgICAgICAgICAgICAgICB2YXIgb2xkVGV4dCA9IGN1cnJlbnQ0ICE9PSBudWxsID8gY3VycmVudDQubWVtb2l6ZWRQcm9wcyA6IG5ld1RleHQ7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0VGV4dFVwZGF0ZSh0ZXh0SW5zdGFuY2UsIG9sZFRleHQsIG5ld1RleHQpOwogICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoY3VycmVudDQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgcHJldlJvb3RTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZSb290U3RhdGUuaXNEZWh5ZHJhdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBjb21taXRIeWRyYXRlZENvbnRhaW5lcihyb290My5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlQ29tbWl0UGhhc2VFcnJvcihmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB2YXIgb2Zmc2NyZWVuRmliZXIgPSBmaW5pc2hlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgaWYgKG9mZnNjcmVlbkZpYmVyLmZsYWdzICYgVmlzaWJpbGl0eSkgewogICAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkluc3RhbmNlID0gb2Zmc2NyZWVuRmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gb2Zmc2NyZWVuRmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IG5ld1N0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgb2Zmc2NyZWVuSW5zdGFuY2UuaXNIaWRkZW4gPSBpc0hpZGRlbjsKICAgICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgICB2YXIgd2FzSGlkZGVuID0gb2Zmc2NyZWVuRmliZXIuYWx0ZXJuYXRlICE9PSBudWxsICYmIG9mZnNjcmVlbkZpYmVyLmFsdGVybmF0ZS5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgICBpZiAoIXdhc0hpZGRlbikgewogICAgICAgICAgICAgICAgICAgIG1hcmtDb21taXRUaW1lT2ZGYWxsYmFjaygpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0U3VzcGVuc2VDYWxsYmFjayhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGF0dGFjaFN1c3BlbnNlUmV0cnlMaXN0ZW5lcnMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgT2Zmc2NyZWVuQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgdmFyIF93YXNIaWRkZW4gPSBjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSB0aGlzIGRlYWQgZmxhZwogICAgICAgICAgICAgICAgZmluaXNoZWRXb3JrLm1vZGUgJiBDb25jdXJyZW50TW9kZQogICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbiB8fCBfd2FzSGlkZGVuOwogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBwcmV2T2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKGZsYWdzICYgVmlzaWJpbGl0eSkgewogICAgICAgICAgICAgICAgdmFyIF9vZmZzY3JlZW5JbnN0YW5jZSA9IGZpbmlzaGVkV29yay5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB2YXIgX25ld1N0YXRlID0gZmluaXNoZWRXb3JrLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgICAgICB2YXIgX2lzSGlkZGVuID0gX25ld1N0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgdmFyIG9mZnNjcmVlbkJvdW5kYXJ5ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgICAgICAgX29mZnNjcmVlbkluc3RhbmNlLmlzSGlkZGVuID0gX2lzSGlkZGVuOwogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICBpZiAoX2lzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFfd2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoKG9mZnNjcmVlbkJvdW5kYXJ5Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gb2Zmc2NyZWVuQm91bmRhcnk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvZmZzY3JlZW5DaGlsZCA9IG9mZnNjcmVlbkJvdW5kYXJ5LmNoaWxkOwogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAob2Zmc2NyZWVuQ2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gb2Zmc2NyZWVuQ2hpbGQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19iZWdpbihvZmZzY3JlZW5DaGlsZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2NyZWVuQ2hpbGQgPSBvZmZzY3JlZW5DaGlsZC5zaWJsaW5nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGhpZGVPclVuaGlkZUFsbENoaWxkcmVuKG9mZnNjcmVlbkJvdW5kYXJ5LCBfaXNIaWRkZW4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTdXNwZW5zZUxpc3RDb21wb25lbnQ6IHsKICAgICAgICAgICAgICByZWN1cnNpdmVseVRyYXZlcnNlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGNvbW1pdFJlY29uY2lsaWF0aW9uRWZmZWN0cyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIGlmIChmbGFncyAmIFVwZGF0ZSkgewogICAgICAgICAgICAgICAgYXR0YWNoU3VzcGVuc2VSZXRyeUxpc3RlbmVycyhmaW5pc2hlZFdvcmspOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBTY29wZUNvbXBvbmVudDogewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICBjb21taXRSZWNvbmNpbGlhdGlvbkVmZmVjdHMoZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UmVjb25jaWxpYXRpb25FZmZlY3RzKGZpbmlzaGVkV29yaykgewogICAgICAgICAgdmFyIGZsYWdzID0gZmluaXNoZWRXb3JrLmZsYWdzOwogICAgICAgICAgaWYgKGZsYWdzICYgUGxhY2VtZW50KSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgY29tbWl0UGxhY2VtZW50KGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmaW5pc2hlZFdvcmsuZmxhZ3MgJj0gflBsYWNlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmbGFncyAmIEh5ZHJhdGluZykgewogICAgICAgICAgICBmaW5pc2hlZFdvcmsuZmxhZ3MgJj0gfkh5ZHJhdGluZzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0RWZmZWN0cyhmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcykgewogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gY29tbWl0dGVkTGFuZXM7CiAgICAgICAgICBpblByb2dyZXNzUm9vdCA9IHJvb3QzOwogICAgICAgICAgbmV4dEVmZmVjdCA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdHNfYmVnaW4oZmluaXNoZWRXb3JrLCByb290MywgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgaW5Qcm9ncmVzc0xhbmVzID0gbnVsbDsKICAgICAgICAgIGluUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0RWZmZWN0c19iZWdpbihzdWJ0cmVlUm9vdCwgcm9vdDMsIGNvbW1pdHRlZExhbmVzKSB7CiAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gKHN1YnRyZWVSb290Lm1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZTsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IE9mZnNjcmVlbkNvbXBvbmVudCAmJiBpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBmaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIHZhciBuZXdPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW4gPSBpc0hpZGRlbiB8fCBvZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgaWYgKG5ld09mZnNjcmVlblN1YnRyZWVJc0hpZGRlbikgewogICAgICAgICAgICAgICAgY29tbWl0TGF5b3V0TW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICAgIHZhciB3YXNIaWRkZW4gPSBjdXJyZW50NCAhPT0gbnVsbCAmJiBjdXJyZW50NC5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgICAgdmFyIG5ld09mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSB3YXNIaWRkZW4gfHwgb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIHZhciBwcmV2T2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZUlzSGlkZGVuOwogICAgICAgICAgICAgICAgdmFyIHByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gb2Zmc2NyZWVuU3VidHJlZVdhc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IG5ld09mZnNjcmVlblN1YnRyZWVJc0hpZGRlbjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gPSBuZXdPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuOwogICAgICAgICAgICAgICAgaWYgKG9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW4gJiYgIXByZXZPZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuKSB7CiAgICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlcjsKICAgICAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKGZpYmVyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGNoaWxkOwogICAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRFZmZlY3RzX2JlZ2luKAogICAgICAgICAgICAgICAgICAgIGNoaWxkLAogICAgICAgICAgICAgICAgICAgIC8vIE5ldyByb290OyBidWJibGUgYmFjayB1cCB0byBoZXJlIGFuZCBzdG9wLgogICAgICAgICAgICAgICAgICAgIHJvb3QzLAogICAgICAgICAgICAgICAgICAgIGNvbW1pdHRlZExhbmVzCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlcjsKICAgICAgICAgICAgICAgIG9mZnNjcmVlblN1YnRyZWVJc0hpZGRlbiA9IHByZXZPZmZzY3JlZW5TdWJ0cmVlSXNIaWRkZW47CiAgICAgICAgICAgICAgICBvZmZzY3JlZW5TdWJ0cmVlV2FzSGlkZGVuID0gcHJldk9mZnNjcmVlblN1YnRyZWVXYXNIaWRkZW47CiAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChmaWJlci5zdWJ0cmVlRmxhZ3MgJiBMYXlvdXRNYXNrKSAhPT0gTm9GbGFncyAmJiBmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRMYXlvdXRNb3VudEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QsIHJvb3QzLCBjb21taXR0ZWRMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0TGF5b3V0TW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIGlmICgoZmliZXIuZmxhZ3MgJiBMYXlvdXRNYXNrKSAhPT0gTm9GbGFncykgewogICAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpYmVyLmFsdGVybmF0ZTsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXRMYXlvdXRFZmZlY3RPbkZpYmVyKHJvb3QzLCBjdXJyZW50NCwgZmliZXIsIGNvbW1pdHRlZExhbmVzKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRpc2FwcGVhckxheW91dEVmZmVjdHNfYmVnaW4oc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHZhciBmaXJzdENoaWxkID0gZmliZXIuY2hpbGQ7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmIChmaWJlci5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBzdGFydExheW91dEVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkTGF5b3V0RWZmZWN0RHVyYXRpb24oZmliZXIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoTGF5b3V0LCBmaWJlciwgZmliZXIucmV0dXJuKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChmaWJlciwgZmliZXIucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBIb3N0Q29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICBzYWZlbHlEZXRhY2hSZWYoZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBPZmZzY3JlZW5Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHZhciBpc0hpZGRlbiA9IGZpYmVyLm1lbW9pemVkU3RhdGUgIT09IG51bGw7CiAgICAgICAgICAgICAgICBpZiAoaXNIaWRkZW4pIHsKICAgICAgICAgICAgICAgICAgZGlzYXBwZWFyTGF5b3V0RWZmZWN0c19jb21wbGV0ZShzdWJ0cmVlUm9vdCk7CiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkaXNhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoZmliZXIgPT09IHN1YnRyZWVSb290KSB7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nID0gZmliZXIuc2libGluZzsKICAgICAgICAgICAgaWYgKHNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzaWJsaW5nLnJldHVybiA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpYmVyLnJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBPZmZzY3JlZW5Db21wb25lbnQpIHsKICAgICAgICAgICAgICB2YXIgaXNIaWRkZW4gPSBmaWJlci5tZW1vaXplZFN0YXRlICE9PSBudWxsOwogICAgICAgICAgICAgIGlmIChpc0hpZGRlbikgewogICAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmlyc3RDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpcnN0Q2hpbGQucmV0dXJuID0gZmliZXI7CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWFwcGVhckxheW91dEVmZmVjdHNfY29tcGxldGUoc3VidHJlZVJvb3QpIHsKICAgICAgICAgIHdoaWxlIChuZXh0RWZmZWN0ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBmaWJlciA9IG5leHRFZmZlY3Q7CiAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmVhcHBlYXJMYXlvdXRFZmZlY3RzT25GaWJlcihmaWJlcik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yMikgewogICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudEVmZmVjdHMocm9vdDMsIGZpbmlzaGVkV29yaywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmluaXNoZWRXb3JrOwogICAgICAgICAgY29tbWl0UGFzc2l2ZU1vdW50RWZmZWN0c19iZWdpbihmaW5pc2hlZFdvcmssIHJvb3QzLCBjb21taXR0ZWRMYW5lcywgY29tbWl0dGVkVHJhbnNpdGlvbnMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2JlZ2luKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgZmlyc3RDaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoKGZpYmVyLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyAmJiBmaXJzdENoaWxkICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZmlyc3RDaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzX2NvbXBsZXRlKHN1YnRyZWVSb290LCByb290MywgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBpZiAoKGZpYmVyLmZsYWdzICYgUGFzc2l2ZSkgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRPbkZpYmVyKHJvb3QzLCBmaWJlciwgY29tbWl0dGVkTGFuZXMsIGNvbW1pdHRlZFRyYW5zaXRpb25zKTsKICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZpYmVyID09PSBzdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBudWxsOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSBmaWJlci5yZXR1cm47CiAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHNpYmxpbmc7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVNb3VudE9uRmliZXIoZmluaXNoZWRSb290LCBmaW5pc2hlZFdvcmssIGNvbW1pdHRlZExhbmVzLCBjb21taXR0ZWRUcmFuc2l0aW9ucykgewogICAgICAgICAgc3dpdGNoIChmaW5pc2hlZFdvcmsudGFnKSB7CiAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFBhc3NpdmVFZmZlY3RUaW1lcigpOwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICByZWNvcmRQYXNzaXZlRWZmZWN0RHVyYXRpb24oZmluaXNoZWRXb3JrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RNb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0cyhmaXJzdENoaWxkKSB7CiAgICAgICAgICBuZXh0RWZmZWN0ID0gZmlyc3RDaGlsZDsKICAgICAgICAgIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c19iZWdpbigpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHNfYmVnaW4oKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZDsKICAgICAgICAgICAgaWYgKChuZXh0RWZmZWN0LmZsYWdzICYgQ2hpbGREZWxldGlvbikgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICB2YXIgZGVsZXRpb25zID0gZmliZXIuZGVsZXRpb25zOwogICAgICAgICAgICAgIGlmIChkZWxldGlvbnMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGVsZXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHZhciBmaWJlclRvRGVsZXRlID0gZGVsZXRpb25zW2ldOwogICAgICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXJUb0RlbGV0ZTsKICAgICAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9iZWdpbihmaWJlclRvRGVsZXRlLCBmaWJlcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gZmliZXIuYWx0ZXJuYXRlOwogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlciAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBkZXRhY2hlZENoaWxkID0gcHJldmlvdXNGaWJlci5jaGlsZDsKICAgICAgICAgICAgICAgICAgICBpZiAoZGV0YWNoZWRDaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNGaWJlci5jaGlsZCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkZXRhY2hlZFNpYmxpbmcgPSBkZXRhY2hlZENoaWxkLnNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICAgIGRldGFjaGVkQ2hpbGQuc2libGluZyA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgIGRldGFjaGVkQ2hpbGQgPSBkZXRhY2hlZFNpYmxpbmc7CiAgICAgICAgICAgICAgICAgICAgICB9IHdoaWxlIChkZXRhY2hlZENoaWxkICE9PSBudWxsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBmaWJlcjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKChmaWJlci5zdWJ0cmVlRmxhZ3MgJiBQYXNzaXZlTWFzaykgIT09IE5vRmxhZ3MgJiYgY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2NvbXBsZXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzX2NvbXBsZXRlKCkgewogICAgICAgICAgd2hpbGUgKG5leHRFZmZlY3QgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gbmV4dEVmZmVjdDsKICAgICAgICAgICAgaWYgKChmaWJlci5mbGFncyAmIFBhc3NpdmUpICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgc2V0Q3VycmVudEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudE9uRmliZXIoZmliZXIpOwogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHNpYmxpbmcgPSBmaWJlci5zaWJsaW5nOwogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNpYmxpbmcucmV0dXJuID0gZmliZXIucmV0dXJuOwogICAgICAgICAgICAgIG5leHRFZmZlY3QgPSBzaWJsaW5nOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBuZXh0RWZmZWN0ID0gZmliZXIucmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudE9uRmliZXIoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICBzd2l0Y2ggKGZpbmlzaGVkV29yay50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGZpbmlzaGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpIHsKICAgICAgICAgICAgICAgIHN0YXJ0UGFzc2l2ZUVmZmVjdFRpbWVyKCk7CiAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdFVubW91bnQoUGFzc2l2ZSQxIHwgSGFzRWZmZWN0LCBmaW5pc2hlZFdvcmssIGZpbmlzaGVkV29yay5yZXR1cm4pOwogICAgICAgICAgICAgICAgcmVjb3JkUGFzc2l2ZUVmZmVjdER1cmF0aW9uKGZpbmlzaGVkV29yayk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpbmlzaGVkV29yaywgZmluaXNoZWRXb3JrLnJldHVybik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c0luc2lkZU9mRGVsZXRlZFRyZWVfYmVnaW4oZGVsZXRlZFN1YnRyZWVSb290LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEluc2lkZURlbGV0ZWRUcmVlT25GaWJlcihmaWJlciwgbmVhcmVzdE1vdW50ZWRBbmNlc3Rvcik7CiAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgIHZhciBjaGlsZCA9IGZpYmVyLmNoaWxkOwogICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjaGlsZC5yZXR1cm4gPSBmaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY29tbWl0UGFzc2l2ZVVubW91bnRFZmZlY3RzSW5zaWRlT2ZEZWxldGVkVHJlZV9jb21wbGV0ZShkZWxldGVkU3VidHJlZVJvb3QpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbW1pdFBhc3NpdmVVbm1vdW50RWZmZWN0c0luc2lkZU9mRGVsZXRlZFRyZWVfY29tcGxldGUoZGVsZXRlZFN1YnRyZWVSb290KSB7CiAgICAgICAgICB3aGlsZSAobmV4dEVmZmVjdCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZmliZXIgPSBuZXh0RWZmZWN0OwogICAgICAgICAgICB2YXIgc2libGluZyA9IGZpYmVyLnNpYmxpbmc7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGZpYmVyLnJldHVybjsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGRldGFjaEZpYmVyQWZ0ZXJFZmZlY3RzKGZpYmVyKTsKICAgICAgICAgICAgICBpZiAoZmliZXIgPT09IGRlbGV0ZWRTdWJ0cmVlUm9vdCkgewogICAgICAgICAgICAgICAgbmV4dEVmZmVjdCA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzaWJsaW5nICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgc2libGluZy5yZXR1cm4gPSByZXR1cm5GaWJlcjsKICAgICAgICAgICAgICBuZXh0RWZmZWN0ID0gc2libGluZzsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV4dEVmZmVjdCA9IHJldHVybkZpYmVyOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRQYXNzaXZlVW5tb3VudEluc2lkZURlbGV0ZWRUcmVlT25GaWJlcihjdXJyZW50NCwgbmVhcmVzdE1vdW50ZWRBbmNlc3RvcikgewogICAgICAgICAgc3dpdGNoIChjdXJyZW50NC50YWcpIHsKICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0Lm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgc3RhcnRQYXNzaXZlRWZmZWN0VGltZXIoKTsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICAgIHJlY29yZFBhc3NpdmVFZmZlY3REdXJhdGlvbihjdXJyZW50NCk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEsIGN1cnJlbnQ0LCBuZWFyZXN0TW91bnRlZEFuY2VzdG9yKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF5b3V0RWZmZWN0TW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0TW91bnQoTGF5b3V0IHwgSGFzRWZmZWN0LCBmaWJlcik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBpbnN0YW5jZS5jb21wb25lbnREaWRNb3VudCgpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlUGFzc2l2ZUVmZmVjdE1vdW50SW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoIChmaWJlci50YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgY2FzZSBTaW1wbGVNZW1vQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBjb21taXRIb29rRWZmZWN0TGlzdE1vdW50KFBhc3NpdmUkMSB8IEhhc0VmZmVjdCwgZmliZXIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlTGF5b3V0RWZmZWN0VW5tb3VudEluREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgY29tbWl0SG9va0VmZmVjdExpc3RVbm1vdW50KExheW91dCB8IEhhc0VmZmVjdCwgZmliZXIsIGZpYmVyLnJldHVybik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3IoZmliZXIsIGZpYmVyLnJldHVybiwgZXJyb3IyKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OiB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluc3RhbmNlLmNvbXBvbmVudFdpbGxVbm1vdW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgIHNhZmVseUNhbGxDb21wb25lbnRXaWxsVW5tb3VudChmaWJlciwgZmliZXIucmV0dXJuLCBpbnN0YW5jZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlUGFzc2l2ZUVmZmVjdFVubW91bnRJbkRFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGNvbW1pdEhvb2tFZmZlY3RMaXN0VW5tb3VudChQYXNzaXZlJDEgfCBIYXNFZmZlY3QsIGZpYmVyLCBmaWJlci5yZXR1cm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IyKSB7CiAgICAgICAgICAgICAgICAgIGNhcHR1cmVDb21taXRQaGFzZUVycm9yKGZpYmVyLCBmaWJlci5yZXR1cm4sIGVycm9yMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBDT01QT05FTlRfVFlQRSA9IDA7CiAgICAgICAgdmFyIEhBU19QU0VVRE9fQ0xBU1NfVFlQRSA9IDE7CiAgICAgICAgdmFyIFJPTEVfVFlQRSA9IDI7CiAgICAgICAgdmFyIFRFU1RfTkFNRV9UWVBFID0gMzsKICAgICAgICB2YXIgVEVYVF9UWVBFID0gNDsKICAgICAgICBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wuZm9yKSB7CiAgICAgICAgICB2YXIgc3ltYm9sRm9yID0gU3ltYm9sLmZvcjsKICAgICAgICAgIENPTVBPTkVOVF9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5jb21wb25lbnQiKTsKICAgICAgICAgIEhBU19QU0VVRE9fQ0xBU1NfVFlQRSA9IHN5bWJvbEZvcigic2VsZWN0b3IuaGFzX3BzZXVkb19jbGFzcyIpOwogICAgICAgICAgUk9MRV9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci5yb2xlIik7CiAgICAgICAgICBURVNUX05BTUVfVFlQRSA9IHN5bWJvbEZvcigic2VsZWN0b3IudGVzdF9pZCIpOwogICAgICAgICAgVEVYVF9UWVBFID0gc3ltYm9sRm9yKCJzZWxlY3Rvci50ZXh0Iik7CiAgICAgICAgfQogICAgICAgIHZhciBjb21taXRIb29rcyA9IFtdOwogICAgICAgIGZ1bmN0aW9uIG9uQ29tbWl0Um9vdCQxKCkgewogICAgICAgICAgewogICAgICAgICAgICBjb21taXRIb29rcy5mb3JFYWNoKGZ1bmN0aW9uKGNvbW1pdEhvb2spIHsKICAgICAgICAgICAgICByZXR1cm4gY29tbWl0SG9vaygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudEFjdFF1ZXVlID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50QWN0UXVldWU7CiAgICAgICAgZnVuY3Rpb24gaXNMZWdhY3lBY3RFbnZpcm9ubWVudChmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNSZWFjdEFjdEVudmlyb25tZW50R2xvYmFsID0gKAogICAgICAgICAgICAgIC8vICRGbG93RXhwZWN0ZWRFcnJvciDigJMgRmxvdyBkb2Vzbid0IGtub3cgYWJvdXQgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIGdsb2JhbAogICAgICAgICAgICAgIHR5cGVvZiBJU19SRUFDVF9BQ1RfRU5WSVJPTk1FTlQgIT09ICJ1bmRlZmluZWQiID8gSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UIDogdm9pZCAwCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHZhciBqZXN0SXNEZWZpbmVkID0gdHlwZW9mIGplc3QgIT09ICJ1bmRlZmluZWQiOwogICAgICAgICAgICByZXR1cm4gamVzdElzRGVmaW5lZCAmJiBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWwgIT09IGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc0NvbmN1cnJlbnRBY3RFbnZpcm9ubWVudCgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCA9ICgKICAgICAgICAgICAgICAvLyAkRmxvd0V4cGVjdGVkRXJyb3Ig4oCTIEZsb3cgZG9lc24ndCBrbm93IGFib3V0IElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCBnbG9iYWwKICAgICAgICAgICAgICB0eXBlb2YgSVNfUkVBQ1RfQUNUX0VOVklST05NRU5UICE9PSAidW5kZWZpbmVkIiA/IElTX1JFQUNUX0FDVF9FTlZJUk9OTUVOVCA6IHZvaWQgMAogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoIWlzUmVhY3RBY3RFbnZpcm9ubWVudEdsb2JhbCAmJiBSZWFjdEN1cnJlbnRBY3RRdWV1ZS5jdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgZXJyb3IoIlRoZSBjdXJyZW50IHRlc3RpbmcgZW52aXJvbm1lbnQgaXMgbm90IGNvbmZpZ3VyZWQgdG8gc3VwcG9ydCBhY3QoLi4uKSIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBpc1JlYWN0QWN0RW52aXJvbm1lbnRHbG9iYWw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjZWlsID0gTWF0aC5jZWlsOwogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyJDIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnREaXNwYXRjaGVyLCBSZWFjdEN1cnJlbnRPd25lciQyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50T3duZXIsIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRCYXRjaENvbmZpZywgUmVhY3RDdXJyZW50QWN0UXVldWUkMSA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudEFjdFF1ZXVlOwogICAgICAgIHZhciBOb0NvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAqLwogICAgICAgICAgMAogICAgICAgICk7CiAgICAgICAgdmFyIEJhdGNoZWRDb250ZXh0ID0gKAogICAgICAgICAgLyogICAgICAgICAgICAgICAqLwogICAgICAgICAgMQogICAgICAgICk7CiAgICAgICAgdmFyIFJlbmRlckNvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgMgogICAgICAgICk7CiAgICAgICAgdmFyIENvbW1pdENvbnRleHQgPSAoCiAgICAgICAgICAvKiAgICAgICAgICAgICAgICAqLwogICAgICAgICAgNAogICAgICAgICk7CiAgICAgICAgdmFyIFJvb3RJblByb2dyZXNzID0gMDsKICAgICAgICB2YXIgUm9vdEZhdGFsRXJyb3JlZCA9IDE7CiAgICAgICAgdmFyIFJvb3RFcnJvcmVkID0gMjsKICAgICAgICB2YXIgUm9vdFN1c3BlbmRlZCA9IDM7CiAgICAgICAgdmFyIFJvb3RTdXNwZW5kZWRXaXRoRGVsYXkgPSA0OwogICAgICAgIHZhciBSb290Q29tcGxldGVkID0gNTsKICAgICAgICB2YXIgUm9vdERpZE5vdENvbXBsZXRlID0gNjsKICAgICAgICB2YXIgZXhlY3V0aW9uQ29udGV4dCA9IE5vQ29udGV4dDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290ID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MgPSBudWxsOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciA9IGNyZWF0ZUN1cnNvcihOb0xhbmVzKTsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RJblByb2dyZXNzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gTm9MYW5lczsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID0gbnVsbDsKICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMgPSBudWxsOwogICAgICAgIHZhciBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lID0gMDsKICAgICAgICB2YXIgRkFMTEJBQ0tfVEhST1RUTEVfTVMgPSA1MDA7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlclRhcmdldFRpbWUgPSBJbmZpbml0eTsKICAgICAgICB2YXIgUkVOREVSX1RJTUVPVVRfTVMgPSA1MDA7CiAgICAgICAgdmFyIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHJlc2V0UmVuZGVyVGltZXIoKSB7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJUYXJnZXRUaW1lID0gbm93KCkgKyBSRU5ERVJfVElNRU9VVF9NUzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UmVuZGVyVGFyZ2V0VGltZSgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJUYXJnZXRUaW1lOwogICAgICAgIH0KICAgICAgICB2YXIgaGFzVW5jYXVnaHRFcnJvciA9IGZhbHNlOwogICAgICAgIHZhciBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBudWxsOwogICAgICAgIHZhciBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IG51bGw7CiAgICAgICAgdmFyIHJvb3REb2VzSGF2ZVBhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID0gbnVsbDsKICAgICAgICB2YXIgcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMgPSBOb0xhbmVzOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZVByb2ZpbGVyRWZmZWN0cyA9IFtdOwogICAgICAgIHZhciBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICB2YXIgTkVTVEVEX1VQREFURV9MSU1JVCA9IDUwOwogICAgICAgIHZhciBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgdmFyIHJvb3RXaXRoTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgdmFyIGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgIHZhciBkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzID0gZmFsc2U7CiAgICAgICAgdmFyIE5FU1RFRF9QQVNTSVZFX1VQREFURV9MSU1JVCA9IDUwOwogICAgICAgIHZhciBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgIHZhciByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzID0gbnVsbDsKICAgICAgICB2YXIgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgIHZhciBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9IE5vTGFuZXM7CiAgICAgICAgdmFyIGlzUnVubmluZ0luc2VydGlvbkVmZmVjdCA9IGZhbHNlOwogICAgICAgIGZ1bmN0aW9uIGdldFdvcmtJblByb2dyZXNzUm9vdCgpIHsKICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzc1Jvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlcXVlc3RFdmVudFRpbWUoKSB7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHJldHVybiBub3coKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjdXJyZW50RXZlbnRUaW1lICE9PSBOb1RpbWVzdGFtcCkgewogICAgICAgICAgICByZXR1cm4gY3VycmVudEV2ZW50VGltZTsKICAgICAgICAgIH0KICAgICAgICAgIGN1cnJlbnRFdmVudFRpbWUgPSBub3coKTsKICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUaW1lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcikgewogICAgICAgICAgdmFyIG1vZGUgPSBmaWJlci5tb2RlOwogICAgICAgICAgaWYgKChtb2RlICYgQ29uY3VycmVudE1vZGUpID09PSBOb01vZGUpIHsKICAgICAgICAgICAgcmV0dXJuIFN5bmNMYW5lOwogICAgICAgICAgfSBlbHNlIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQgJiYgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgcmV0dXJuIHBpY2tBcmJpdHJhcnlMYW5lKHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBpc1RyYW5zaXRpb24gPSByZXF1ZXN0Q3VycmVudFRyYW5zaXRpb24oKSAhPT0gTm9UcmFuc2l0aW9uOwogICAgICAgICAgaWYgKGlzVHJhbnNpdGlvbikgewogICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgICAgaWYgKCF0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzKSB7CiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uLl91cGRhdGVkRmliZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgdHJhbnNpdGlvbi5fdXBkYXRlZEZpYmVycy5hZGQoZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZSA9PT0gTm9MYW5lKSB7CiAgICAgICAgICAgICAgY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPSBjbGFpbU5leHRUcmFuc2l0aW9uTGFuZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBjdXJyZW50RXZlbnRUcmFuc2l0aW9uTGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB1cGRhdGVMYW5lID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICBpZiAodXBkYXRlTGFuZSAhPT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVMYW5lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGV2ZW50TGFuZSA9IGdldEN1cnJlbnRFdmVudFByaW9yaXR5KCk7CiAgICAgICAgICByZXR1cm4gZXZlbnRMYW5lOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXF1ZXN0UmV0cnlMYW5lKGZpYmVyKSB7CiAgICAgICAgICB2YXIgbW9kZSA9IGZpYmVyLm1vZGU7CiAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgPT09IE5vTW9kZSkgewogICAgICAgICAgICByZXR1cm4gU3luY0xhbmU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY2xhaW1OZXh0UmV0cnlMYW5lKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSkgewogICAgICAgICAgY2hlY2tGb3JOZXN0ZWRVcGRhdGVzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QpIHsKICAgICAgICAgICAgICBlcnJvcigidXNlSW5zZXJ0aW9uRWZmZWN0IG11c3Qgbm90IHNjaGVkdWxlIHVwZGF0ZXMuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRmx1c2hpbmdQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGRpZFNjaGVkdWxlVXBkYXRlRHVyaW5nUGFzc2l2ZUVmZmVjdHMgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUm9vdFVwZGF0ZWQocm9vdDMsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiBSZW5kZXJDb250ZXh0KSAhPT0gTm9MYW5lcyAmJiByb290MyA9PT0gd29ya0luUHJvZ3Jlc3NSb290KSB7CiAgICAgICAgICAgIHdhcm5BYm91dFJlbmRlclBoYXNlVXBkYXRlc0luREVWKGZpYmVyKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaXNEZXZUb29sc1ByZXNlbnQpIHsKICAgICAgICAgICAgICAgIGFkZEZpYmVyVG9MYW5lc01hcChyb290MywgZmliZXIsIGxhbmUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3YXJuSWZVcGRhdGVzTm90V3JhcHBlZFdpdGhBY3RERVYoZmliZXIpOwogICAgICAgICAgICBpZiAocm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCkgewogICAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEludGVybGVhdmVkVXBkYXRlZExhbmVzID0gbWVyZ2VMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcywgbGFuZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkV2l0aERlbGF5KSB7CiAgICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgICAgaWYgKGxhbmUgPT09IFN5bmNMYW5lICYmIGV4ZWN1dGlvbkNvbnRleHQgPT09IE5vQ29udGV4dCAmJiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSA9PT0gTm9Nb2RlICYmIC8vIFRyZWF0IGBhY3RgIGFzIGlmIGl0J3MgaW5zaWRlIGBiYXRjaGVkVXBkYXRlc2AsIGV2ZW4gaW4gbGVnYWN5IG1vZGUuCiAgICAgICAgICAgICFSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmlzQmF0Y2hpbmdMZWdhY3kpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzT25seUluTGVnYWN5TW9kZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlSW5pdGlhbEh5ZHJhdGlvbk9uUm9vdChyb290MywgbGFuZSwgZXZlbnRUaW1lKSB7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSByb290My5jdXJyZW50OwogICAgICAgICAgY3VycmVudDQubGFuZXMgPSBsYW5lOwogICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBldmVudFRpbWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1Vuc2FmZUNsYXNzUmVuZGVyUGhhc2VVcGRhdGUoZmliZXIpIHsKICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgIC8vIFRPRE86IFJlbW92ZSBvdXRkYXRlZCBkZWZlclJlbmRlclBoYXNlVXBkYXRlVG9OZXh0QmF0Y2ggZXhwZXJpbWVudC4gV2UKICAgICAgICAgICAgLy8gZGVjaWRlZCBub3QgdG8gZW5hYmxlIGl0LgogICAgICAgICAgICAoZXhlY3V0aW9uQ29udGV4dCAmIFJlbmRlckNvbnRleHQpICE9PSBOb0NvbnRleHQKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgY3VycmVudFRpbWUpIHsKICAgICAgICAgIHZhciBleGlzdGluZ0NhbGxiYWNrTm9kZSA9IHJvb3QzLmNhbGxiYWNrTm9kZTsKICAgICAgICAgIG1hcmtTdGFydmVkTGFuZXNBc0V4cGlyZWQocm9vdDMsIGN1cnJlbnRUaW1lKTsKICAgICAgICAgIHZhciBuZXh0TGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgaWYgKG5leHRMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBpZiAoZXhpc3RpbmdDYWxsYmFja05vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBjYW5jZWxDYWxsYmFjayQxKGV4aXN0aW5nQ2FsbGJhY2tOb2RlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByb290My5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gTm9MYW5lOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2FsbGJhY2tQcmlvcml0eSA9IGdldEhpZ2hlc3RQcmlvcml0eUxhbmUobmV4dExhbmVzKTsKICAgICAgICAgIHZhciBleGlzdGluZ0NhbGxiYWNrUHJpb3JpdHkgPSByb290My5jYWxsYmFja1ByaW9yaXR5OwogICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tQcmlvcml0eSA9PT0gbmV3Q2FsbGJhY2tQcmlvcml0eSAmJiAvLyBTcGVjaWFsIGNhc2UgcmVsYXRlZCB0byBgYWN0YC4gSWYgdGhlIGN1cnJlbnRseSBzY2hlZHVsZWQgdGFzayBpcyBhCiAgICAgICAgICAvLyBTY2hlZHVsZXIgdGFzaywgcmF0aGVyIHRoYW4gYW4gYGFjdGAgdGFzaywgY2FuY2VsIGl0IGFuZCByZS1zY2hlZHVsZWQKICAgICAgICAgIC8vIG9uIHRoZSBgYWN0YCBxdWV1ZS4KICAgICAgICAgICEoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsICYmIGV4aXN0aW5nQ2FsbGJhY2tOb2RlICE9PSBmYWtlQWN0Q2FsbGJhY2tOb2RlKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tOb2RlID09IG51bGwgJiYgZXhpc3RpbmdDYWxsYmFja1ByaW9yaXR5ICE9PSBTeW5jTGFuZSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkV4cGVjdGVkIHNjaGVkdWxlZCBjYWxsYmFjayB0byBleGlzdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXN0aW5nQ2FsbGJhY2tOb2RlICE9IG51bGwpIHsKICAgICAgICAgICAgY2FuY2VsQ2FsbGJhY2skMShleGlzdGluZ0NhbGxiYWNrTm9kZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbmV3Q2FsbGJhY2tOb2RlOwogICAgICAgICAgaWYgKG5ld0NhbGxiYWNrUHJpb3JpdHkgPT09IFN5bmNMYW5lKSB7CiAgICAgICAgICAgIGlmIChyb290My50YWcgPT09IExlZ2FjeVJvb3QpIHsKICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5pc0JhdGNoaW5nTGVnYWN5ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmRpZFNjaGVkdWxlTGVnYWN5VXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc2NoZWR1bGVMZWdhY3lTeW5jQ2FsbGJhY2socGVyZm9ybVN5bmNXb3JrT25Sb290LmJpbmQobnVsbCwgcm9vdDMpKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzY2hlZHVsZVN5bmNDYWxsYmFjayhwZXJmb3JtU3luY1dvcmtPblJvb3QuYmluZChudWxsLCByb290MykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQucHVzaChmbHVzaFN5bmNDYWxsYmFja3MpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZU1pY3JvdGFzayhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q2FsbGJhY2tOb2RlID0gbnVsbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBzY2hlZHVsZXJQcmlvcml0eUxldmVsOwogICAgICAgICAgICBzd2l0Y2ggKGxhbmVzVG9FdmVudFByaW9yaXR5KG5leHRMYW5lcykpIHsKICAgICAgICAgICAgICBjYXNlIERpc2NyZXRlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJbW1lZGlhdGVQcmlvcml0eTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIGNhc2UgQ29udGludW91c0V2ZW50UHJpb3JpdHk6CiAgICAgICAgICAgICAgICBzY2hlZHVsZXJQcmlvcml0eUxldmVsID0gVXNlckJsb2NraW5nUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIERlZmF1bHRFdmVudFByaW9yaXR5OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBJZGxlRXZlbnRQcmlvcml0eToKICAgICAgICAgICAgICAgIHNjaGVkdWxlclByaW9yaXR5TGV2ZWwgPSBJZGxlUHJpb3JpdHk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgc2NoZWR1bGVyUHJpb3JpdHlMZXZlbCA9IE5vcm1hbFByaW9yaXR5OwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbmV3Q2FsbGJhY2tOb2RlID0gc2NoZWR1bGVDYWxsYmFjayQxKHNjaGVkdWxlclByaW9yaXR5TGV2ZWwsIHBlcmZvcm1Db25jdXJyZW50V29ya09uUm9vdC5iaW5kKG51bGwsIHJvb3QzKSk7CiAgICAgICAgICB9CiAgICAgICAgICByb290My5jYWxsYmFja1ByaW9yaXR5ID0gbmV3Q2FsbGJhY2tQcmlvcml0eTsKICAgICAgICAgIHJvb3QzLmNhbGxiYWNrTm9kZSA9IG5ld0NhbGxiYWNrTm9kZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGVyZm9ybUNvbmN1cnJlbnRXb3JrT25Sb290KHJvb3QzLCBkaWRUaW1lb3V0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJlc2V0TmVzdGVkVXBkYXRlRmxhZygpOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudEV2ZW50VGltZSA9IE5vVGltZXN0YW1wOwogICAgICAgICAgY3VycmVudEV2ZW50VHJhbnNpdGlvbkxhbmUgPSBOb0xhbmVzOwogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG9yaWdpbmFsQ2FsbGJhY2tOb2RlID0gcm9vdDMuY2FsbGJhY2tOb2RlOwogICAgICAgICAgdmFyIGRpZEZsdXNoUGFzc2l2ZUVmZmVjdHMgPSBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICBpZiAoZGlkRmx1c2hQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICBpZiAocm9vdDMuY2FsbGJhY2tOb2RlICE9PSBvcmlnaW5hbENhbGxiYWNrTm9kZSkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgbGFuZXMgPSBnZXROZXh0TGFuZXMocm9vdDMsIHJvb3QzID09PSB3b3JrSW5Qcm9ncmVzc1Jvb3QgPyB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA6IE5vTGFuZXMpOwogICAgICAgICAgaWYgKGxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHNob3VsZFRpbWVTbGljZSA9ICFpbmNsdWRlc0Jsb2NraW5nTGFuZShyb290MywgbGFuZXMpICYmICFpbmNsdWRlc0V4cGlyZWRMYW5lKHJvb3QzLCBsYW5lcykgJiYgIWRpZFRpbWVvdXQ7CiAgICAgICAgICB2YXIgZXhpdFN0YXR1cyA9IHNob3VsZFRpbWVTbGljZSA/IHJlbmRlclJvb3RDb25jdXJyZW50KHJvb3QzLCBsYW5lcykgOiByZW5kZXJSb290U3luYyhyb290MywgbGFuZXMpOwogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgIT09IFJvb3RJblByb2dyZXNzKSB7CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RXJyb3JlZCkgewogICAgICAgICAgICAgIHZhciBlcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgICAgaWYgKGVycm9yUmV0cnlMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgbGFuZXMgPSBlcnJvclJldHJ5TGFuZXM7CiAgICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgICAgdmFyIGZhdGFsRXJyb3IgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yOwogICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgICAgdGhyb3cgZmF0YWxFcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdERpZE5vdENvbXBsZXRlKSB7CiAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHZhciByZW5kZXJXYXNDb25jdXJyZW50ID0gIWluY2x1ZGVzQmxvY2tpbmdMYW5lKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmN1cnJlbnQuYWx0ZXJuYXRlOwogICAgICAgICAgICAgIGlmIChyZW5kZXJXYXNDb25jdXJyZW50ICYmICFpc1JlbmRlckNvbnNpc3RlbnRXaXRoRXh0ZXJuYWxTdG9yZXMoZmluaXNoZWRXb3JrKSkgewogICAgICAgICAgICAgICAgZXhpdFN0YXR1cyA9IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgICBpZiAoZXhpdFN0YXR1cyA9PT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgICAgICAgdmFyIF9lcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgICAgICAgIGlmIChfZXJyb3JSZXRyeUxhbmVzICE9PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICAgICAgbGFuZXMgPSBfZXJyb3JSZXRyeUxhbmVzOwogICAgICAgICAgICAgICAgICAgIGV4aXRTdGF0dXMgPSByZWNvdmVyRnJvbUNvbmN1cnJlbnRFcnJvcihyb290MywgX2Vycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgICAgICAgIHZhciBfZmF0YWxFcnJvciA9IHdvcmtJblByb2dyZXNzUm9vdEZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICAgICAgbWFya1Jvb3RTdXNwZW5kZWQkMShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgICAgICAgdGhyb3cgX2ZhdGFsRXJyb3I7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgICAgICByb290My5maW5pc2hlZExhbmVzID0gbGFuZXM7CiAgICAgICAgICAgICAgZmluaXNoQ29uY3VycmVudFJlbmRlcihyb290MywgZXhpdFN0YXR1cywgbGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgIGlmIChyb290My5jYWxsYmFja05vZGUgPT09IG9yaWdpbmFsQ2FsbGJhY2tOb2RlKSB7CiAgICAgICAgICAgIHJldHVybiBwZXJmb3JtQ29uY3VycmVudFdvcmtPblJvb3QuYmluZChudWxsLCByb290Myk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcykgewogICAgICAgICAgdmFyIGVycm9yc0Zyb21GaXJzdEF0dGVtcHQgPSB3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzOwogICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgIHZhciByb290V29ya0luUHJvZ3Jlc3MgPSBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgZXJyb3JSZXRyeUxhbmVzKTsKICAgICAgICAgICAgcm9vdFdvcmtJblByb2dyZXNzLmZsYWdzIHw9IEZvcmNlQ2xpZW50UmVuZGVyOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgZXJyb3JIeWRyYXRpbmdDb250YWluZXIocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciBleGl0U3RhdHVzID0gcmVuZGVyUm9vdFN5bmMocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICBpZiAoZXhpdFN0YXR1cyAhPT0gUm9vdEVycm9yZWQpIHsKICAgICAgICAgICAgdmFyIGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0ID0gd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzID0gZXJyb3JzRnJvbUZpcnN0QXR0ZW1wdDsKICAgICAgICAgICAgaWYgKGVycm9yc0Zyb21TZWNvbmRBdHRlbXB0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgcXVldWVSZWNvdmVyYWJsZUVycm9ycyhlcnJvcnNGcm9tU2Vjb25kQXR0ZW1wdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBleGl0U3RhdHVzOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBxdWV1ZVJlY292ZXJhYmxlRXJyb3JzKGVycm9yczMpIHsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9IGVycm9yczM7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycy5wdXNoLmFwcGx5KHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCBlcnJvcnMzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluaXNoQ29uY3VycmVudFJlbmRlcihyb290MywgZXhpdFN0YXR1cywgbGFuZXMpIHsKICAgICAgICAgIHN3aXRjaCAoZXhpdFN0YXR1cykgewogICAgICAgICAgICBjYXNlIFJvb3RJblByb2dyZXNzOgogICAgICAgICAgICBjYXNlIFJvb3RGYXRhbEVycm9yZWQ6IHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RFcnJvcmVkOiB7CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgUm9vdFN1c3BlbmRlZDogewogICAgICAgICAgICAgIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICBpZiAoaW5jbHVkZXNPbmx5UmV0cmllcyhsYW5lcykgJiYgLy8gZG8gbm90IGRlbGF5IGlmIHdlJ3JlIGluc2lkZSBhbiBhY3QoKSBzY29wZQogICAgICAgICAgICAgICFzaG91bGRGb3JjZUZsdXNoRmFsbGJhY2tzSW5ERVYoKSkgewogICAgICAgICAgICAgICAgdmFyIG1zVW50aWxUaW1lb3V0ID0gZ2xvYmFsTW9zdFJlY2VudEZhbGxiYWNrVGltZSArIEZBTExCQUNLX1RIUk9UVExFX01TIC0gbm93KCk7CiAgICAgICAgICAgICAgICBpZiAobXNVbnRpbFRpbWVvdXQgPiAxMCkgewogICAgICAgICAgICAgICAgICB2YXIgbmV4dExhbmVzID0gZ2V0TmV4dExhbmVzKHJvb3QzLCBOb0xhbmVzKTsKICAgICAgICAgICAgICAgICAgaWYgKG5leHRMYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBzdXNwZW5kZWRMYW5lcyA9IHJvb3QzLnN1c3BlbmRlZExhbmVzOwogICAgICAgICAgICAgICAgICBpZiAoIWlzU3Vic2V0T2ZMYW5lcyhzdXNwZW5kZWRMYW5lcywgbGFuZXMpKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgICAgICAgICAgICBtYXJrUm9vdFBpbmdlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJvb3QzLnRpbWVvdXRIYW5kbGUgPSBzY2hlZHVsZVRpbWVvdXQoY29tbWl0Um9vdC5iaW5kKG51bGwsIHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyksIG1zVW50aWxUaW1lb3V0KTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlIFJvb3RTdXNwZW5kZWRXaXRoRGVsYXk6IHsKICAgICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGluY2x1ZGVzT25seVRyYW5zaXRpb25zKGxhbmVzKSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICghc2hvdWxkRm9yY2VGbHVzaEZhbGxiYWNrc0luREVWKCkpIHsKICAgICAgICAgICAgICAgIHZhciBtb3N0UmVjZW50RXZlbnRUaW1lID0gZ2V0TW9zdFJlY2VudEV2ZW50VGltZShyb290MywgbGFuZXMpOwogICAgICAgICAgICAgICAgdmFyIGV2ZW50VGltZU1zID0gbW9zdFJlY2VudEV2ZW50VGltZTsKICAgICAgICAgICAgICAgIHZhciB0aW1lRWxhcHNlZE1zID0gbm93KCkgLSBldmVudFRpbWVNczsKICAgICAgICAgICAgICAgIHZhciBfbXNVbnRpbFRpbWVvdXQgPSBqbmQodGltZUVsYXBzZWRNcykgLSB0aW1lRWxhcHNlZE1zOwogICAgICAgICAgICAgICAgaWYgKF9tc1VudGlsVGltZW91dCA+IDEwKSB7CiAgICAgICAgICAgICAgICAgIHJvb3QzLnRpbWVvdXRIYW5kbGUgPSBzY2hlZHVsZVRpbWVvdXQoY29tbWl0Um9vdC5iaW5kKG51bGwsIHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyksIF9tc1VudGlsVGltZW91dCk7CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb21taXRSb290KHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycywgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSBSb290Q29tcGxldGVkOiB7CiAgICAgICAgICAgICAgY29tbWl0Um9vdChyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVjb3ZlcmFibGVFcnJvcnMsIHdvcmtJblByb2dyZXNzVHJhbnNpdGlvbnMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gcm9vdCBleGl0IHN0YXR1cy4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1JlbmRlckNvbnNpc3RlbnRXaXRoRXh0ZXJuYWxTdG9yZXMoZmluaXNoZWRXb3JrKSB7CiAgICAgICAgICB2YXIgbm9kZSA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgIGlmIChub2RlLmZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSkgewogICAgICAgICAgICAgIHZhciB1cGRhdGVRdWV1ZSA9IG5vZGUudXBkYXRlUXVldWU7CiAgICAgICAgICAgICAgaWYgKHVwZGF0ZVF1ZXVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB2YXIgY2hlY2tzID0gdXBkYXRlUXVldWUuc3RvcmVzOwogICAgICAgICAgICAgICAgaWYgKGNoZWNrcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNoZWNrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGVjayA9IGNoZWNrc1tpXTsKICAgICAgICAgICAgICAgICAgICB2YXIgZ2V0U25hcHNob3QgPSBjaGVjay5nZXRTbmFwc2hvdDsKICAgICAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRWYWx1ZSA9IGNoZWNrLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIW9iamVjdElzKGdldFNuYXBzaG90KCksIHJlbmRlcmVkVmFsdWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcjIpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNoaWxkID0gbm9kZS5jaGlsZDsKICAgICAgICAgICAgaWYgKG5vZGUuc3VidHJlZUZsYWdzICYgU3RvcmVDb25zaXN0ZW5jeSAmJiBjaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGNoaWxkLnJldHVybiA9IG5vZGU7CiAgICAgICAgICAgICAgbm9kZSA9IGNoaWxkOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChub2RlID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUucmV0dXJuID09PSBudWxsIHx8IG5vZGUucmV0dXJuID09PSBmaW5pc2hlZFdvcmspIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5zaWJsaW5nLnJldHVybiA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtSb290U3VzcGVuZGVkJDEocm9vdDMsIHN1c3BlbmRlZExhbmVzKSB7CiAgICAgICAgICBzdXNwZW5kZWRMYW5lcyA9IHJlbW92ZUxhbmVzKHN1c3BlbmRlZExhbmVzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RQaW5nZWRMYW5lcyk7CiAgICAgICAgICBzdXNwZW5kZWRMYW5lcyA9IHJlbW92ZUxhbmVzKHN1c3BlbmRlZExhbmVzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RJbnRlcmxlYXZlZFVwZGF0ZWRMYW5lcyk7CiAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZChyb290Mywgc3VzcGVuZGVkTGFuZXMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwZXJmb3JtU3luY1dvcmtPblJvb3Qocm9vdDMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgc3luY05lc3RlZFVwZGF0ZUZsYWcoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJTaG91bGQgbm90IGFscmVhZHkgYmUgd29ya2luZy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIHZhciBsYW5lcyA9IGdldE5leHRMYW5lcyhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICBpZiAoIWluY2x1ZGVzU29tZUxhbmUobGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXhpdFN0YXR1cyA9IHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICBpZiAocm9vdDMudGFnICE9PSBMZWdhY3lSb290ICYmIGV4aXRTdGF0dXMgPT09IFJvb3RFcnJvcmVkKSB7CiAgICAgICAgICAgIHZhciBlcnJvclJldHJ5TGFuZXMgPSBnZXRMYW5lc1RvUmV0cnlTeW5jaHJvbm91c2x5T25FcnJvcihyb290Myk7CiAgICAgICAgICAgIGlmIChlcnJvclJldHJ5TGFuZXMgIT09IE5vTGFuZXMpIHsKICAgICAgICAgICAgICBsYW5lcyA9IGVycm9yUmV0cnlMYW5lczsKICAgICAgICAgICAgICBleGl0U3RhdHVzID0gcmVjb3ZlckZyb21Db25jdXJyZW50RXJyb3Iocm9vdDMsIGVycm9yUmV0cnlMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmIChleGl0U3RhdHVzID09PSBSb290RmF0YWxFcnJvcmVkKSB7CiAgICAgICAgICAgIHZhciBmYXRhbEVycm9yID0gd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvcjsKICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIE5vTGFuZXMpOwogICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgICB0aHJvdyBmYXRhbEVycm9yOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGV4aXRTdGF0dXMgPT09IFJvb3REaWROb3RDb21wbGV0ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlJvb3QgZGlkIG5vdCBjb21wbGV0ZS4gVGhpcyBpcyBhIGJ1ZyBpbiBSZWFjdC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBmaW5pc2hlZFdvcmsgPSByb290My5jdXJyZW50LmFsdGVybmF0ZTsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IGZpbmlzaGVkV29yazsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBsYW5lczsKICAgICAgICAgIGNvbW1pdFJvb3Qocm9vdDMsIHdvcmtJblByb2dyZXNzUm9vdFJlY292ZXJhYmxlRXJyb3JzLCB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zKTsKICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290Mywgbm93KCkpOwogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUm9vdChyb290MywgbGFuZXMpIHsKICAgICAgICAgIGlmIChsYW5lcyAhPT0gTm9MYW5lcykgewogICAgICAgICAgICBtYXJrUm9vdEVudGFuZ2xlZChyb290MywgbWVyZ2VMYW5lcyhsYW5lcywgU3luY0xhbmUpKTsKICAgICAgICAgICAgZW5zdXJlUm9vdElzU2NoZWR1bGVkKHJvb3QzLCBub3coKSk7CiAgICAgICAgICAgIGlmICgoZXhlY3V0aW9uQ29udGV4dCAmIChSZW5kZXJDb250ZXh0IHwgQ29tbWl0Q29udGV4dCkpID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYmF0Y2hlZFVwZGF0ZXMkMShmbiwgYSkgewogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gQmF0Y2hlZENvbnRleHQ7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICByZXR1cm4gZm4oYSk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0ID0gcHJldkV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ID09PSBOb0NvbnRleHQgJiYgLy8gVHJlYXQgYGFjdGAgYXMgaWYgaXQncyBpbnNpZGUgYGJhdGNoZWRVcGRhdGVzYCwgZXZlbiBpbiBsZWdhY3kgbW9kZS4KICAgICAgICAgICAgIVJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuaXNCYXRjaGluZ0xlZ2FjeSkgewogICAgICAgICAgICAgIHJlc2V0UmVuZGVyVGltZXIoKTsKICAgICAgICAgICAgICBmbHVzaFN5bmNDYWxsYmFja3NPbmx5SW5MZWdhY3lNb2RlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGlzY3JldGVVcGRhdGVzKGZuLCBhLCBiLCBjLCBkKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gbnVsbDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KERpc2NyZXRlRXZlbnRQcmlvcml0eSk7CiAgICAgICAgICAgIHJldHVybiBmbihhLCBiLCBjLCBkKTsKICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShwcmV2aW91c1ByaW9yaXR5KTsKICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ID09PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmx1c2hTeW5jKGZuKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwgJiYgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMudGFnID09PSBMZWdhY3lSb290ICYmIChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgPT09IE5vQ29udGV4dCkgewogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBCYXRjaGVkQ29udGV4dDsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBudWxsOwogICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoRGlzY3JldGVFdmVudFByaW9yaXR5KTsKICAgICAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZuKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSA9PT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBbHJlYWR5UmVuZGVyaW5nKCkgewogICAgICAgICAgcmV0dXJuIChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHVzaFJlbmRlckxhbmVzKGZpYmVyLCBsYW5lcykgewogICAgICAgICAgcHVzaChzdWJ0cmVlUmVuZGVyTGFuZXNDdXJzb3IsIHN1YnRyZWVSZW5kZXJMYW5lcywgZmliZXIpOwogICAgICAgICAgc3VidHJlZVJlbmRlckxhbmVzID0gbWVyZ2VMYW5lcyhzdWJ0cmVlUmVuZGVyTGFuZXMsIGxhbmVzKTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEluY2x1ZGVkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdEluY2x1ZGVkTGFuZXMsIGxhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wUmVuZGVyTGFuZXMoZmliZXIpIHsKICAgICAgICAgIHN1YnRyZWVSZW5kZXJMYW5lcyA9IHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvci5jdXJyZW50OwogICAgICAgICAgcG9wKHN1YnRyZWVSZW5kZXJMYW5lc0N1cnNvciwgZmliZXIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkV29yayA9IG51bGw7CiAgICAgICAgICByb290My5maW5pc2hlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHZhciB0aW1lb3V0SGFuZGxlID0gcm9vdDMudGltZW91dEhhbmRsZTsKICAgICAgICAgIGlmICh0aW1lb3V0SGFuZGxlICE9PSBub1RpbWVvdXQpIHsKICAgICAgICAgICAgcm9vdDMudGltZW91dEhhbmRsZSA9IG5vVGltZW91dDsKICAgICAgICAgICAgY2FuY2VsVGltZW91dCh0aW1lb3V0SGFuZGxlKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgaW50ZXJydXB0ZWRXb3JrID0gd29ya0luUHJvZ3Jlc3MucmV0dXJuOwogICAgICAgICAgICB3aGlsZSAoaW50ZXJydXB0ZWRXb3JrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gaW50ZXJydXB0ZWRXb3JrLmFsdGVybmF0ZTsKICAgICAgICAgICAgICB1bndpbmRJbnRlcnJ1cHRlZFdvcmsoY3VycmVudDQsIGludGVycnVwdGVkV29yayk7CiAgICAgICAgICAgICAgaW50ZXJydXB0ZWRXb3JrID0gaW50ZXJydXB0ZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290ID0gcm9vdDM7CiAgICAgICAgICB2YXIgcm9vdFdvcmtJblByb2dyZXNzID0gY3JlYXRlV29ya0luUHJvZ3Jlc3Mocm9vdDMuY3VycmVudCwgbnVsbCk7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IHJvb3RXb3JrSW5Qcm9ncmVzczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gc3VidHJlZVJlbmRlckxhbmVzID0gd29ya0luUHJvZ3Jlc3NSb290SW5jbHVkZWRMYW5lcyA9IGxhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RJblByb2dyZXNzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RmF0YWxFcnJvciA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290Q29uY3VycmVudEVycm9ycyA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZWNvdmVyYWJsZUVycm9ycyA9IG51bGw7CiAgICAgICAgICBmaW5pc2hRdWV1ZWluZ0NvbmN1cnJlbnRVcGRhdGVzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmRpc2NhcmRQZW5kaW5nV2FybmluZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByb290V29ya0luUHJvZ3Jlc3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhbmRsZUVycm9yMyhyb290MywgdGhyb3duVmFsdWUpIHsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdmFyIGVycm9yZWRXb3JrID0gd29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgcmVzZXRDb250ZXh0RGVwZW5kZW5jaWVzKCk7CiAgICAgICAgICAgICAgcmVzZXRIb29rc0FmdGVyVGhyb3coKTsKICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgICAgaWYgKGVycm9yZWRXb3JrID09PSBudWxsIHx8IGVycm9yZWRXb3JrLnJldHVybiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9IFJvb3RGYXRhbEVycm9yZWQ7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RGYXRhbEVycm9yID0gdGhyb3duVmFsdWU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChlbmFibGVQcm9maWxlclRpbWVyICYmIGVycm9yZWRXb3JrLm1vZGUgJiBQcm9maWxlTW9kZSkgewogICAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShlcnJvcmVkV29yaywgdHJ1ZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChlbmFibGVTY2hlZHVsaW5nUHJvZmlsZXIpIHsKICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRSZW5kZXJTdG9wcGVkKCk7CiAgICAgICAgICAgICAgICBpZiAodGhyb3duVmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHRocm93blZhbHVlID09PSAib2JqZWN0IiAmJiB0eXBlb2YgdGhyb3duVmFsdWUudGhlbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICB2YXIgd2FrZWFibGUgPSB0aHJvd25WYWx1ZTsKICAgICAgICAgICAgICAgICAgbWFya0NvbXBvbmVudFN1c3BlbmRlZChlcnJvcmVkV29yaywgd2FrZWFibGUsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIG1hcmtDb21wb25lbnRFcnJvcmVkKGVycm9yZWRXb3JrLCB0aHJvd25WYWx1ZSwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvd0V4Y2VwdGlvbihyb290MywgZXJyb3JlZFdvcmsucmV0dXJuLCBlcnJvcmVkV29yaywgdGhyb3duVmFsdWUsIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzKTsKICAgICAgICAgICAgICBjb21wbGV0ZVVuaXRPZldvcmsoZXJyb3JlZFdvcmspOwogICAgICAgICAgICB9IGNhdGNoICh5ZXRBbm90aGVyVGhyb3duVmFsdWUpIHsKICAgICAgICAgICAgICB0aHJvd25WYWx1ZSA9IHlldEFub3RoZXJUaHJvd25WYWx1ZTsKICAgICAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgPT09IGVycm9yZWRXb3JrICYmIGVycm9yZWRXb3JrICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBlcnJvcmVkV29yayA9IGVycm9yZWRXb3JrLnJldHVybjsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gZXJyb3JlZFdvcms7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVycm9yZWRXb3JrID0gd29ya0luUHJvZ3Jlc3M7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0gd2hpbGUgKHRydWUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBwdXNoRGlzcGF0Y2hlcigpIHsKICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIkMi5jdXJyZW50OwogICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQyLmN1cnJlbnQgPSBDb250ZXh0T25seURpc3BhdGNoZXI7CiAgICAgICAgICBpZiAocHJldkRpc3BhdGNoZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIENvbnRleHRPbmx5RGlzcGF0Y2hlcjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcG9wRGlzcGF0Y2hlcihwcmV2RGlzcGF0Y2hlcikgewogICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlciQyLmN1cnJlbnQgPSBwcmV2RGlzcGF0Y2hlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya0NvbW1pdFRpbWVPZkZhbGxiYWNrKCkgewogICAgICAgICAgZ2xvYmFsTW9zdFJlY2VudEZhbGxiYWNrVGltZSA9IG5vdygpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrU2tpcHBlZFVwZGF0ZUxhbmVzKGxhbmUpIHsKICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFNraXBwZWRMYW5lcyA9IG1lcmdlTGFuZXMobGFuZSwgd29ya0luUHJvZ3Jlc3NSb290U2tpcHBlZExhbmVzKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyRGlkU3VzcGVuZCgpIHsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzcykgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdFN1c3BlbmRlZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyRGlkU3VzcGVuZERlbGF5SWZQb3NzaWJsZSgpIHsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzcyB8fCB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkIHx8IHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RFcnJvcmVkKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290U3VzcGVuZGVkV2l0aERlbGF5OwogICAgICAgICAgfQogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzUm9vdCAhPT0gbnVsbCAmJiAoaW5jbHVkZXNOb25JZGxlV29yayh3b3JrSW5Qcm9ncmVzc1Jvb3RTa2lwcGVkTGFuZXMpIHx8IGluY2x1ZGVzTm9uSWRsZVdvcmsod29ya0luUHJvZ3Jlc3NSb290SW50ZXJsZWF2ZWRVcGRhdGVkTGFuZXMpKSkgewogICAgICAgICAgICBtYXJrUm9vdFN1c3BlbmRlZCQxKHdvcmtJblByb2dyZXNzUm9vdCwgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJEaWRFcnJvcihlcnJvcjIpIHsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzICE9PSBSb290U3VzcGVuZGVkV2l0aERlbGF5KSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290RXJyb3JlZDsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RDb25jdXJyZW50RXJyb3JzID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnMgPSBbZXJyb3IyXTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdENvbmN1cnJlbnRFcnJvcnMucHVzaChlcnJvcjIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZW5kZXJIYXNOb3RTdXNwZW5kZWRZZXQoKSB7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1cyA9PT0gUm9vdEluUHJvZ3Jlc3M7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlclJvb3RTeW5jKHJvb3QzLCBsYW5lcykgewogICAgICAgICAgdmFyIHByZXZFeGVjdXRpb25Db250ZXh0ID0gZXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgfD0gUmVuZGVyQ29udGV4dDsKICAgICAgICAgIHZhciBwcmV2RGlzcGF0Y2hlciA9IHB1c2hEaXNwYXRjaGVyKCk7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3NSb290ICE9PSByb290MyB8fCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyAhPT0gbGFuZXMpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0RldlRvb2xzUHJlc2VudCkgewogICAgICAgICAgICAgICAgdmFyIG1lbW9pemVkVXBkYXRlcnMgPSByb290My5tZW1vaXplZFVwZGF0ZXJzOwogICAgICAgICAgICAgICAgaWYgKG1lbW9pemVkVXBkYXRlcnMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290Mywgd29ya0luUHJvZ3Jlc3NSb290UmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgICBtZW1vaXplZFVwZGF0ZXJzLmNsZWFyKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtb3ZlUGVuZGluZ0ZpYmVyc1RvTWVtb2l6ZWQocm9vdDMsIGxhbmVzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NUcmFuc2l0aW9ucyA9IGdldFRyYW5zaXRpb25zRm9yTGFuZXMoKTsKICAgICAgICAgICAgcHJlcGFyZUZyZXNoU3RhY2socm9vdDMsIGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1JlbmRlclN0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgZG8gewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIHdvcmtMb29wU3luYygpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGNhdGNoICh0aHJvd25WYWx1ZSkgewogICAgICAgICAgICAgIGhhbmRsZUVycm9yMyhyb290MywgdGhyb3duVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IHdoaWxlICh0cnVlKTsKICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgcG9wRGlzcGF0Y2hlcihwcmV2RGlzcGF0Y2hlcik7CiAgICAgICAgICBpZiAod29ya0luUHJvZ3Jlc3MgIT09IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgY29tbWl0IGFuIGluY29tcGxldGUgcm9vdC4gVGhpcyBlcnJvciBpcyBsaWtlbHkgY2F1c2VkIGJ5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgbWFya1JlbmRlclN0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICByZXR1cm4gd29ya0luUHJvZ3Jlc3NSb290RXhpdFN0YXR1czsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd29ya0xvb3BTeW5jKCkgewogICAgICAgICAgd2hpbGUgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHBlcmZvcm1Vbml0T2ZXb3JrKHdvcmtJblByb2dyZXNzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyUm9vdENvbmN1cnJlbnQocm9vdDMsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCB8PSBSZW5kZXJDb250ZXh0OwogICAgICAgICAgdmFyIHByZXZEaXNwYXRjaGVyID0gcHVzaERpc3BhdGNoZXIoKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgIT09IHJvb3QzIHx8IHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzICE9PSBsYW5lcykgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgICB2YXIgbWVtb2l6ZWRVcGRhdGVycyA9IHJvb3QzLm1lbW9pemVkVXBkYXRlcnM7CiAgICAgICAgICAgICAgICBpZiAobWVtb2l6ZWRVcGRhdGVycy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICByZXN0b3JlUGVuZGluZ1VwZGF0ZXJzKHJvb3QzLCB3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcyk7CiAgICAgICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuY2xlYXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG1vdmVQZW5kaW5nRmliZXJzVG9NZW1vaXplZChyb290MywgbGFuZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1RyYW5zaXRpb25zID0gZ2V0VHJhbnNpdGlvbnNGb3JMYW5lcygpOwogICAgICAgICAgICByZXNldFJlbmRlclRpbWVyKCk7CiAgICAgICAgICAgIHByZXBhcmVGcmVzaFN0YWNrKHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB3b3JrTG9vcENvbmN1cnJlbnQoKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBjYXRjaCAodGhyb3duVmFsdWUpIHsKICAgICAgICAgICAgICBoYW5kbGVFcnJvcjMocm9vdDMsIHRocm93blZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSB3aGlsZSAodHJ1ZSk7CiAgICAgICAgICByZXNldENvbnRleHREZXBlbmRlbmNpZXMoKTsKICAgICAgICAgIHBvcERpc3BhdGNoZXIocHJldkRpc3BhdGNoZXIpOwogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyWWllbGRlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSb290SW5Qcm9ncmVzczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrUmVuZGVyU3RvcHBlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXM7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdvcmtMb29wQ29uY3VycmVudCgpIHsKICAgICAgICAgIHdoaWxlICh3b3JrSW5Qcm9ncmVzcyAhPT0gbnVsbCAmJiAhc2hvdWxkWWllbGQoKSkgewogICAgICAgICAgICBwZXJmb3JtVW5pdE9mV29yayh3b3JrSW5Qcm9ncmVzcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHBlcmZvcm1Vbml0T2ZXb3JrKHVuaXRPZldvcmspIHsKICAgICAgICAgIHZhciBjdXJyZW50NCA9IHVuaXRPZldvcmsuYWx0ZXJuYXRlOwogICAgICAgICAgc2V0Q3VycmVudEZpYmVyKHVuaXRPZldvcmspOwogICAgICAgICAgdmFyIG5leHQ7CiAgICAgICAgICBpZiAoKHVuaXRPZldvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSAhPT0gTm9Nb2RlKSB7CiAgICAgICAgICAgIHN0YXJ0UHJvZmlsZXJUaW1lcih1bml0T2ZXb3JrKTsKICAgICAgICAgICAgbmV4dCA9IGJlZ2luV29yayQxKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICBzdG9wUHJvZmlsZXJUaW1lcklmUnVubmluZ0FuZFJlY29yZERlbHRhKHVuaXRPZldvcmssIHRydWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbmV4dCA9IGJlZ2luV29yayQxKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgfQogICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIHVuaXRPZldvcmsubWVtb2l6ZWRQcm9wcyA9IHVuaXRPZldvcmsucGVuZGluZ1Byb3BzOwogICAgICAgICAgaWYgKG5leHQgPT09IG51bGwpIHsKICAgICAgICAgICAgY29tcGxldGVVbml0T2ZXb3JrKHVuaXRPZldvcmspOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MgPSBuZXh0OwogICAgICAgICAgfQogICAgICAgICAgUmVhY3RDdXJyZW50T3duZXIkMi5jdXJyZW50ID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tcGxldGVVbml0T2ZXb3JrKHVuaXRPZldvcmspIHsKICAgICAgICAgIHZhciBjb21wbGV0ZWRXb3JrID0gdW5pdE9mV29yazsKICAgICAgICAgIGRvIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnQ0ID0gY29tcGxldGVkV29yay5hbHRlcm5hdGU7CiAgICAgICAgICAgIHZhciByZXR1cm5GaWJlciA9IGNvbXBsZXRlZFdvcmsucmV0dXJuOwogICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsuZmxhZ3MgJiBJbmNvbXBsZXRlKSA9PT0gTm9GbGFncykgewogICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihjb21wbGV0ZWRXb3JrKTsKICAgICAgICAgICAgICB2YXIgbmV4dCA9IHZvaWQgMDsKICAgICAgICAgICAgICBpZiAoKGNvbXBsZXRlZFdvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSA9PT0gTm9Nb2RlKSB7CiAgICAgICAgICAgICAgICBuZXh0ID0gY29tcGxldGVXb3JrKGN1cnJlbnQ0LCBjb21wbGV0ZWRXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdGFydFByb2ZpbGVyVGltZXIoY29tcGxldGVkV29yayk7CiAgICAgICAgICAgICAgICBuZXh0ID0gY29tcGxldGVXb3JrKGN1cnJlbnQ0LCBjb21wbGV0ZWRXb3JrLCBzdWJ0cmVlUmVuZGVyTGFuZXMpOwogICAgICAgICAgICAgICAgc3RvcFByb2ZpbGVyVGltZXJJZlJ1bm5pbmdBbmRSZWNvcmREZWx0YShjb21wbGV0ZWRXb3JrLCBmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgaWYgKG5leHQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gbmV4dDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFyIF9uZXh0ID0gdW53aW5kV29yayhjdXJyZW50NCwgY29tcGxldGVkV29yayk7CiAgICAgICAgICAgICAgaWYgKF9uZXh0ICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBfbmV4dC5mbGFncyAmPSBIb3N0RWZmZWN0TWFzazsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzID0gX25leHQ7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICgoY29tcGxldGVkV29yay5tb2RlICYgUHJvZmlsZU1vZGUpICE9PSBOb01vZGUpIHsKICAgICAgICAgICAgICAgIHN0b3BQcm9maWxlclRpbWVySWZSdW5uaW5nQW5kUmVjb3JkRGVsdGEoY29tcGxldGVkV29yaywgZmFsc2UpOwogICAgICAgICAgICAgICAgdmFyIGFjdHVhbER1cmF0aW9uID0gY29tcGxldGVkV29yay5hY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGNvbXBsZXRlZFdvcmsuY2hpbGQ7CiAgICAgICAgICAgICAgICB3aGlsZSAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgYWN0dWFsRHVyYXRpb24gKz0gY2hpbGQuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgICAgICAgIGNoaWxkID0gY2hpbGQuc2libGluZzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbXBsZXRlZFdvcmsuYWN0dWFsRHVyYXRpb24gPSBhY3R1YWxEdXJhdGlvbjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKHJldHVybkZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICByZXR1cm5GaWJlci5mbGFncyB8PSBJbmNvbXBsZXRlOwogICAgICAgICAgICAgICAgcmV0dXJuRmliZXIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgICAgIHJldHVybkZpYmVyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPSBSb290RGlkTm90Q29tcGxldGU7CiAgICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBzaWJsaW5nRmliZXIgPSBjb21wbGV0ZWRXb3JrLnNpYmxpbmc7CiAgICAgICAgICAgIGlmIChzaWJsaW5nRmliZXIgIT09IG51bGwpIHsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IHNpYmxpbmdGaWJlcjsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tcGxldGVkV29yayA9IHJldHVybkZpYmVyOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IGNvbXBsZXRlZFdvcms7CiAgICAgICAgICB9IHdoaWxlIChjb21wbGV0ZWRXb3JrICE9PSBudWxsKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290SW5Qcm9ncmVzcykgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID0gUm9vdENvbXBsZXRlZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0Um9vdChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zKSB7CiAgICAgICAgICB2YXIgcHJldmlvdXNVcGRhdGVMYW5lUHJpb3JpdHkgPSBnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkoKTsKICAgICAgICAgIHZhciBwcmV2VHJhbnNpdGlvbiA9IFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbjsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICBjb21taXRSb290SW1wbChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zLCBwcmV2aW91c1VwZGF0ZUxhbmVQcmlvcml0eSk7CiAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzVXBkYXRlTGFuZVByaW9yaXR5KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjb21taXRSb290SW1wbChyb290MywgcmVjb3ZlcmFibGVFcnJvcnMsIHRyYW5zaXRpb25zLCByZW5kZXJQcmlvcml0eUxldmVsKSB7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0gd2hpbGUgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzICE9PSBudWxsKTsKICAgICAgICAgIGZsdXNoUmVuZGVyUGhhc2VTdHJpY3RNb2RlV2FybmluZ3NJbkRFVigpOwogICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgKFJlbmRlckNvbnRleHQgfCBDb21taXRDb250ZXh0KSkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlNob3VsZCBub3QgYWxyZWFkeSBiZSB3b3JraW5nLiIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpbmlzaGVkV29yayA9IHJvb3QzLmZpbmlzaGVkV29yazsKICAgICAgICAgIHZhciBsYW5lcyA9IHJvb3QzLmZpbmlzaGVkTGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtDb21taXRTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChmaW5pc2hlZFdvcmsgPT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIG1hcmtDb21taXRTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgaWYgKGxhbmVzID09PSBOb0xhbmVzKSB7CiAgICAgICAgICAgICAgICBlcnJvcigicm9vdC5maW5pc2hlZExhbmVzIHNob3VsZCBub3QgYmUgZW1wdHkgZHVyaW5nIGEgY29tbWl0LiBUaGlzIGlzIGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcm9vdDMuZmluaXNoZWRXb3JrID0gbnVsbDsKICAgICAgICAgIHJvb3QzLmZpbmlzaGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgaWYgKGZpbmlzaGVkV29yayA9PT0gcm9vdDMuY3VycmVudCkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBjb21taXQgdGhlIHNhbWUgdHJlZSBhcyBiZWZvcmUuIFRoaXMgZXJyb3IgaXMgbGlrZWx5IGNhdXNlZCBieSBhIGJ1ZyBpbiBSZWFjdC4gUGxlYXNlIGZpbGUgYW4gaXNzdWUuIik7CiAgICAgICAgICB9CiAgICAgICAgICByb290My5jYWxsYmFja05vZGUgPSBudWxsOwogICAgICAgICAgcm9vdDMuY2FsbGJhY2tQcmlvcml0eSA9IE5vTGFuZTsKICAgICAgICAgIHZhciByZW1haW5pbmdMYW5lcyA9IG1lcmdlTGFuZXMoZmluaXNoZWRXb3JrLmxhbmVzLCBmaW5pc2hlZFdvcmsuY2hpbGRMYW5lcyk7CiAgICAgICAgICBtYXJrUm9vdEZpbmlzaGVkKHJvb3QzLCByZW1haW5pbmdMYW5lcyk7CiAgICAgICAgICBpZiAocm9vdDMgPT09IHdvcmtJblByb2dyZXNzUm9vdCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzc1Jvb3QgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzcyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzUm9vdFJlbmRlckxhbmVzID0gTm9MYW5lczsKICAgICAgICAgIH0KICAgICAgICAgIGlmICgoZmluaXNoZWRXb3JrLnN1YnRyZWVGbGFncyAmIFBhc3NpdmVNYXNrKSAhPT0gTm9GbGFncyB8fCAoZmluaXNoZWRXb3JrLmZsYWdzICYgUGFzc2l2ZU1hc2spICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgIGlmICghcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVUcmFuc2l0aW9ucyA9IHRyYW5zaXRpb25zOwogICAgICAgICAgICAgIHNjaGVkdWxlQ2FsbGJhY2skMShOb3JtYWxQcmlvcml0eSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHN1YnRyZWVIYXNFZmZlY3RzID0gKGZpbmlzaGVkV29yay5zdWJ0cmVlRmxhZ3MgJiAoQmVmb3JlTXV0YXRpb25NYXNrIHwgTXV0YXRpb25NYXNrIHwgTGF5b3V0TWFzayB8IFBhc3NpdmVNYXNrKSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICB2YXIgcm9vdEhhc0VmZmVjdCA9IChmaW5pc2hlZFdvcmsuZmxhZ3MgJiAoQmVmb3JlTXV0YXRpb25NYXNrIHwgTXV0YXRpb25NYXNrIHwgTGF5b3V0TWFzayB8IFBhc3NpdmVNYXNrKSkgIT09IE5vRmxhZ3M7CiAgICAgICAgICBpZiAoc3VidHJlZUhhc0VmZmVjdHMgfHwgcm9vdEhhc0VmZmVjdCkgewogICAgICAgICAgICB2YXIgcHJldlRyYW5zaXRpb24gPSBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb247CiAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgIHZhciBwcmV2aW91c1ByaW9yaXR5ID0gZ2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KCk7CiAgICAgICAgICAgIHNldEN1cnJlbnRVcGRhdGVQcmlvcml0eShEaXNjcmV0ZUV2ZW50UHJpb3JpdHkpOwogICAgICAgICAgICB2YXIgcHJldkV4ZWN1dGlvbkNvbnRleHQgPSBleGVjdXRpb25Db250ZXh0OwogICAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IENvbW1pdENvbnRleHQ7CiAgICAgICAgICAgIFJlYWN0Q3VycmVudE93bmVyJDIuY3VycmVudCA9IG51bGw7CiAgICAgICAgICAgIHZhciBzaG91bGRGaXJlQWZ0ZXJBY3RpdmVJbnN0YW5jZUJsdXIyID0gY29tbWl0QmVmb3JlTXV0YXRpb25FZmZlY3RzKHJvb3QzLCBmaW5pc2hlZFdvcmspOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgcmVjb3JkQ29tbWl0VGltZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdE11dGF0aW9uRWZmZWN0cyhyb290MywgZmluaXNoZWRXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgIHJlc2V0QWZ0ZXJDb21taXQocm9vdDMuY29udGFpbmVySW5mbyk7CiAgICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBtYXJrTGF5b3V0RWZmZWN0c1N0YXJ0ZWQobGFuZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1pdExheW91dEVmZmVjdHMoZmluaXNoZWRXb3JrLCByb290MywgbGFuZXMpOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya0xheW91dEVmZmVjdHNTdG9wcGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVxdWVzdFBhaW50KCk7CiAgICAgICAgICAgIGV4ZWN1dGlvbkNvbnRleHQgPSBwcmV2RXhlY3V0aW9uQ29udGV4dDsKICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByZXZpb3VzUHJpb3JpdHkpOwogICAgICAgICAgICBSZWFjdEN1cnJlbnRCYXRjaENvbmZpZyQzLnRyYW5zaXRpb24gPSBwcmV2VHJhbnNpdGlvbjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJvb3QzLmN1cnJlbnQgPSBmaW5pc2hlZFdvcms7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICByZWNvcmRDb21taXRUaW1lKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290RGlkSGF2ZVBhc3NpdmVFZmZlY3RzID0gcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHM7CiAgICAgICAgICBpZiAocm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICAgICAgcm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgPSByb290MzsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMgPSBsYW5lczsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZW1haW5pbmdMYW5lcyA9IHJvb3QzLnBlbmRpbmdMYW5lczsKICAgICAgICAgIGlmIChyZW1haW5pbmdMYW5lcyA9PT0gTm9MYW5lcykgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghcm9vdERpZEhhdmVQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGNvbW1pdERvdWJsZUludm9rZUVmZmVjdHNJbkRFVihyb290My5jdXJyZW50LCBmYWxzZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIG9uQ29tbWl0Um9vdChmaW5pc2hlZFdvcmsuc3RhdGVOb2RlLCByZW5kZXJQcmlvcml0eUxldmVsKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgcm9vdDMubWVtb2l6ZWRVcGRhdGVycy5jbGVhcigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG9uQ29tbWl0Um9vdCQxKCk7CiAgICAgICAgICB9CiAgICAgICAgICBlbnN1cmVSb290SXNTY2hlZHVsZWQocm9vdDMsIG5vdygpKTsKICAgICAgICAgIGlmIChyZWNvdmVyYWJsZUVycm9ycyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgb25SZWNvdmVyYWJsZUVycm9yID0gcm9vdDMub25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlY292ZXJhYmxlRXJyb3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHJlY292ZXJhYmxlRXJyb3IgPSByZWNvdmVyYWJsZUVycm9yc1tpXTsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50U3RhY2sgPSByZWNvdmVyYWJsZUVycm9yLnN0YWNrOwogICAgICAgICAgICAgIHZhciBkaWdlc3QgPSByZWNvdmVyYWJsZUVycm9yLmRpZ2VzdDsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IocmVjb3ZlcmFibGVFcnJvci52YWx1ZSwgewogICAgICAgICAgICAgICAgY29tcG9uZW50U3RhY2ssCiAgICAgICAgICAgICAgICBkaWdlc3QKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGhhc1VuY2F1Z2h0RXJyb3IpIHsKICAgICAgICAgICAgaGFzVW5jYXVnaHRFcnJvciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgZXJyb3IkMSA9IGZpcnN0VW5jYXVnaHRFcnJvcjsKICAgICAgICAgICAgZmlyc3RVbmNhdWdodEVycm9yID0gbnVsbDsKICAgICAgICAgICAgdGhyb3cgZXJyb3IkMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChpbmNsdWRlc1NvbWVMYW5lKHBlbmRpbmdQYXNzaXZlRWZmZWN0c0xhbmVzLCBTeW5jTGFuZSkgJiYgcm9vdDMudGFnICE9PSBMZWdhY3lSb290KSB7CiAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgIH0KICAgICAgICAgIHJlbWFpbmluZ0xhbmVzID0gcm9vdDMucGVuZGluZ0xhbmVzOwogICAgICAgICAgaWYgKGluY2x1ZGVzU29tZUxhbmUocmVtYWluaW5nTGFuZXMsIFN5bmNMYW5lKSkgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgbWFya05lc3RlZFVwZGF0ZVNjaGVkdWxlZCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyb290MyA9PT0gcm9vdFdpdGhOZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQrKzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBuZXN0ZWRVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhOZXN0ZWRVcGRhdGVzID0gcm9vdDM7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG5lc3RlZFVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIGZsdXNoU3luY0NhbGxiYWNrcygpOwogICAgICAgICAgewogICAgICAgICAgICBtYXJrQ29tbWl0U3RvcHBlZCgpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKSB7CiAgICAgICAgICBpZiAocm9vdFdpdGhQZW5kaW5nUGFzc2l2ZUVmZmVjdHMgIT09IG51bGwpIHsKICAgICAgICAgICAgdmFyIHJlbmRlclByaW9yaXR5ID0gbGFuZXNUb0V2ZW50UHJpb3JpdHkocGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXMpOwogICAgICAgICAgICB2YXIgcHJpb3JpdHkgPSBsb3dlckV2ZW50UHJpb3JpdHkoRGVmYXVsdEV2ZW50UHJpb3JpdHksIHJlbmRlclByaW9yaXR5KTsKICAgICAgICAgICAgdmFyIHByZXZUcmFuc2l0aW9uID0gUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uOwogICAgICAgICAgICB2YXIgcHJldmlvdXNQcmlvcml0eSA9IGdldEN1cnJlbnRVcGRhdGVQcmlvcml0eSgpOwogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIFJlYWN0Q3VycmVudEJhdGNoQ29uZmlnJDMudHJhbnNpdGlvbiA9IG51bGw7CiAgICAgICAgICAgICAgc2V0Q3VycmVudFVwZGF0ZVByaW9yaXR5KHByaW9yaXR5KTsKICAgICAgICAgICAgICByZXR1cm4gZmx1c2hQYXNzaXZlRWZmZWN0c0ltcGwoKTsKICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkocHJldmlvdXNQcmlvcml0eSk7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50QmF0Y2hDb25maWckMy50cmFuc2l0aW9uID0gcHJldlRyYW5zaXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZW5xdWV1ZVBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3QoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHMucHVzaChmaWJlcik7CiAgICAgICAgICAgIGlmICghcm9vdERvZXNIYXZlUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICByb290RG9lc0hhdmVQYXNzaXZlRWZmZWN0cyA9IHRydWU7CiAgICAgICAgICAgICAgc2NoZWR1bGVDYWxsYmFjayQxKE5vcm1hbFByaW9yaXR5LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGZsdXNoUGFzc2l2ZUVmZmVjdHMoKTsKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoUGFzc2l2ZUVmZmVjdHNJbXBsKCkgewogICAgICAgICAgaWYgKHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciB0cmFuc2l0aW9ucyA9IHBlbmRpbmdQYXNzaXZlVHJhbnNpdGlvbnM7CiAgICAgICAgICBwZW5kaW5nUGFzc2l2ZVRyYW5zaXRpb25zID0gbnVsbDsKICAgICAgICAgIHZhciByb290MyA9IHJvb3RXaXRoUGVuZGluZ1Bhc3NpdmVFZmZlY3RzOwogICAgICAgICAgdmFyIGxhbmVzID0gcGVuZGluZ1Bhc3NpdmVFZmZlY3RzTGFuZXM7CiAgICAgICAgICByb290V2l0aFBlbmRpbmdQYXNzaXZlRWZmZWN0cyA9IG51bGw7CiAgICAgICAgICBwZW5kaW5nUGFzc2l2ZUVmZmVjdHNMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICBpZiAoKGV4ZWN1dGlvbkNvbnRleHQgJiAoUmVuZGVyQ29udGV4dCB8IENvbW1pdENvbnRleHQpKSAhPT0gTm9Db250ZXh0KSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGZsdXNoIHBhc3NpdmUgZWZmZWN0cyB3aGlsZSBhbHJlYWR5IHJlbmRlcmluZy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaXNGbHVzaGluZ1Bhc3NpdmVFZmZlY3RzID0gdHJ1ZTsKICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICBtYXJrUGFzc2l2ZUVmZmVjdHNTdGFydGVkKGxhbmVzKTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBwcmV2RXhlY3V0aW9uQ29udGV4dCA9IGV4ZWN1dGlvbkNvbnRleHQ7CiAgICAgICAgICBleGVjdXRpb25Db250ZXh0IHw9IENvbW1pdENvbnRleHQ7CiAgICAgICAgICBjb21taXRQYXNzaXZlVW5tb3VudEVmZmVjdHMocm9vdDMuY3VycmVudCk7CiAgICAgICAgICBjb21taXRQYXNzaXZlTW91bnRFZmZlY3RzKHJvb3QzLCByb290My5jdXJyZW50LCBsYW5lcywgdHJhbnNpdGlvbnMpOwogICAgICAgICAgewogICAgICAgICAgICB2YXIgcHJvZmlsZXJFZmZlY3RzID0gcGVuZGluZ1Bhc3NpdmVQcm9maWxlckVmZmVjdHM7CiAgICAgICAgICAgIHBlbmRpbmdQYXNzaXZlUHJvZmlsZXJFZmZlY3RzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvZmlsZXJFZmZlY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIF9maWJlciA9IHByb2ZpbGVyRWZmZWN0c1tpXTsKICAgICAgICAgICAgICBjb21taXRQYXNzaXZlRWZmZWN0RHVyYXRpb25zKHJvb3QzLCBfZmliZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtQYXNzaXZlRWZmZWN0c1N0b3BwZWQoKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKHJvb3QzLmN1cnJlbnQsIHRydWUpOwogICAgICAgICAgfQogICAgICAgICAgZXhlY3V0aW9uQ29udGV4dCA9IHByZXZFeGVjdXRpb25Db250ZXh0OwogICAgICAgICAgZmx1c2hTeW5jQ2FsbGJhY2tzKCk7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChkaWRTY2hlZHVsZVVwZGF0ZUR1cmluZ1Bhc3NpdmVFZmZlY3RzKSB7CiAgICAgICAgICAgICAgaWYgKHJvb3QzID09PSByb290V2l0aFBhc3NpdmVOZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgICBuZXN0ZWRQYXNzaXZlVXBkYXRlQ291bnQrKzsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgICAgIHJvb3RXaXRoUGFzc2l2ZU5lc3RlZFVwZGF0ZXMgPSByb290MzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgbmVzdGVkUGFzc2l2ZVVwZGF0ZUNvdW50ID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpc0ZsdXNoaW5nUGFzc2l2ZUVmZmVjdHMgPSBmYWxzZTsKICAgICAgICAgICAgZGlkU2NoZWR1bGVVcGRhdGVEdXJpbmdQYXNzaXZlRWZmZWN0cyA9IGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgb25Qb3N0Q29tbWl0Um9vdChyb290Myk7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBzdGF0ZU5vZGUgPSByb290My5jdXJyZW50LnN0YXRlTm9kZTsKICAgICAgICAgICAgc3RhdGVOb2RlLmVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgICAgc3RhdGVOb2RlLnBhc3NpdmVFZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaXNBbHJlYWR5RmFpbGVkTGVnYWN5RXJyb3JCb3VuZGFyeShpbnN0YW5jZSkgewogICAgICAgICAgcmV0dXJuIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkICE9PSBudWxsICYmIGxlZ2FjeUVycm9yQm91bmRhcmllc1RoYXRBbHJlYWR5RmFpbGVkLmhhcyhpbnN0YW5jZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG1hcmtMZWdhY3lFcnJvckJvdW5kYXJ5QXNGYWlsZWQoaW5zdGFuY2UpIHsKICAgICAgICAgIGlmIChsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9PT0gbnVsbCkgewogICAgICAgICAgICBsZWdhY3lFcnJvckJvdW5kYXJpZXNUaGF0QWxyZWFkeUZhaWxlZCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtpbnN0YW5jZV0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGVnYWN5RXJyb3JCb3VuZGFyaWVzVGhhdEFscmVhZHlGYWlsZWQuYWRkKGluc3RhbmNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJlcGFyZVRvVGhyb3dVbmNhdWdodEVycm9yKGVycm9yMikgewogICAgICAgICAgaWYgKCFoYXNVbmNhdWdodEVycm9yKSB7CiAgICAgICAgICAgIGhhc1VuY2F1Z2h0RXJyb3IgPSB0cnVlOwogICAgICAgICAgICBmaXJzdFVuY2F1Z2h0RXJyb3IgPSBlcnJvcjI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBvblVuY2F1Z2h0RXJyb3IgPSBwcmVwYXJlVG9UaHJvd1VuY2F1Z2h0RXJyb3I7CiAgICAgICAgZnVuY3Rpb24gY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3Qocm9vdEZpYmVyLCBzb3VyY2VGaWJlciwgZXJyb3IyKSB7CiAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IyLCBzb3VyY2VGaWJlcik7CiAgICAgICAgICB2YXIgdXBkYXRlID0gY3JlYXRlUm9vdEVycm9yVXBkYXRlKHJvb3RGaWJlciwgZXJyb3JJbmZvLCBTeW5jTGFuZSk7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlVXBkYXRlKHJvb3RGaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3Ioc291cmNlRmliZXIsIG5lYXJlc3RNb3VudGVkQW5jZXN0b3IsIGVycm9yJDEpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmVwb3J0VW5jYXVnaHRFcnJvckluREVWKGVycm9yJDEpOwogICAgICAgICAgICBzZXRJc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QoZmFsc2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZUZpYmVyLnRhZyA9PT0gSG9zdFJvb3QpIHsKICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3Qoc291cmNlRmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvciQxKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpYmVyID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgZmliZXIgPSBuZWFyZXN0TW91bnRlZEFuY2VzdG9yOwogICAgICAgICAgfQogICAgICAgICAgd2hpbGUgKGZpYmVyICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmIChmaWJlci50YWcgPT09IEhvc3RSb290KSB7CiAgICAgICAgICAgICAgY2FwdHVyZUNvbW1pdFBoYXNlRXJyb3JPblJvb3QoZmliZXIsIHNvdXJjZUZpYmVyLCBlcnJvciQxKTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICAgIHZhciBjdG9yID0gZmliZXIudHlwZTsKICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21FcnJvciA9PT0gImZ1bmN0aW9uIiB8fCB0eXBlb2YgaW5zdGFuY2UuY29tcG9uZW50RGlkQ2F0Y2ggPT09ICJmdW5jdGlvbiIgJiYgIWlzQWxyZWFkeUZhaWxlZExlZ2FjeUVycm9yQm91bmRhcnkoaW5zdGFuY2UpKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3JJbmZvID0gY3JlYXRlQ2FwdHVyZWRWYWx1ZUF0RmliZXIoZXJyb3IkMSwgc291cmNlRmliZXIpOwogICAgICAgICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZUNsYXNzRXJyb3JVcGRhdGUoZmliZXIsIGVycm9ySW5mbywgU3luY0xhbmUpOwogICAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShmaWJlciwgdXBkYXRlLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgIG1hcmtSb290VXBkYXRlZChyb290MywgU3luY0xhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmliZXIgPSBmaWJlci5yZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJJbnRlcm5hbCBSZWFjdCBlcnJvcjogQXR0ZW1wdGVkIHRvIGNhcHR1cmUgYSBjb21taXQgcGhhc2UgZXJyb3IgaW5zaWRlIGEgZGV0YWNoZWQgdHJlZS4gVGhpcyBpbmRpY2F0ZXMgYSBidWcgaW4gUmVhY3QuIExpa2VseSBjYXVzZXMgaW5jbHVkZSBkZWxldGluZyB0aGUgc2FtZSBmaWJlciBtb3JlIHRoYW4gb25jZSwgY29tbWl0dGluZyBhbiBhbHJlYWR5LWZpbmlzaGVkIHRyZWUsIG9yIGFuIGluY29uc2lzdGVudCByZXR1cm4gcG9pbnRlci5cblxuRXJyb3IgbWVzc2FnZTpcblxuJXMiLCBlcnJvciQxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcGluZ1N1c3BlbmRlZFJvb3Qocm9vdDMsIHdha2VhYmxlLCBwaW5nZWRMYW5lcykgewogICAgICAgICAgdmFyIHBpbmdDYWNoZSA9IHJvb3QzLnBpbmdDYWNoZTsKICAgICAgICAgIGlmIChwaW5nQ2FjaGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcGluZ0NhY2hlLmRlbGV0ZSh3YWtlYWJsZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgbWFya1Jvb3RQaW5nZWQocm9vdDMsIHBpbmdlZExhbmVzKTsKICAgICAgICAgIHdhcm5JZlN1c3BlbnNlUmVzb2x1dGlvbk5vdFdyYXBwZWRXaXRoQWN0REVWKHJvb3QzKTsKICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3QgPT09IHJvb3QzICYmIGlzU3Vic2V0T2ZMYW5lcyh3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcywgcGluZ2VkTGFuZXMpKSB7CiAgICAgICAgICAgIGlmICh3b3JrSW5Qcm9ncmVzc1Jvb3RFeGl0U3RhdHVzID09PSBSb290U3VzcGVuZGVkV2l0aERlbGF5IHx8IHdvcmtJblByb2dyZXNzUm9vdEV4aXRTdGF0dXMgPT09IFJvb3RTdXNwZW5kZWQgJiYgaW5jbHVkZXNPbmx5UmV0cmllcyh3b3JrSW5Qcm9ncmVzc1Jvb3RSZW5kZXJMYW5lcykgJiYgbm93KCkgLSBnbG9iYWxNb3N0UmVjZW50RmFsbGJhY2tUaW1lIDwgRkFMTEJBQ0tfVEhST1RUTEVfTVMpIHsKICAgICAgICAgICAgICBwcmVwYXJlRnJlc2hTdGFjayhyb290MywgTm9MYW5lcyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3NSb290UGluZ2VkTGFuZXMgPSBtZXJnZUxhbmVzKHdvcmtJblByb2dyZXNzUm9vdFBpbmdlZExhbmVzLCBwaW5nZWRMYW5lcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSkgewogICAgICAgICAgaWYgKHJldHJ5TGFuZSA9PT0gTm9MYW5lKSB7CiAgICAgICAgICAgIHJldHJ5TGFuZSA9IHJlcXVlc3RSZXRyeUxhbmUoYm91bmRhcnlGaWJlcik7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgbWFya1Jvb3RVcGRhdGVkKHJvb3QzLCByZXRyeUxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVuc3VyZVJvb3RJc1NjaGVkdWxlZChyb290MywgZXZlbnRUaW1lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmV0cnlEZWh5ZHJhdGVkU3VzcGVuc2VCb3VuZGFyeShib3VuZGFyeUZpYmVyKSB7CiAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGJvdW5kYXJ5RmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgIHZhciByZXRyeUxhbmUgPSBOb0xhbmU7CiAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICByZXRyeUxhbmUgPSBzdXNwZW5zZVN0YXRlLnJldHJ5TGFuZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHJ5VGltZWRPdXRCb3VuZGFyeShib3VuZGFyeUZpYmVyLCByZXRyeUxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZXNvbHZlUmV0cnlXYWtlYWJsZShib3VuZGFyeUZpYmVyLCB3YWtlYWJsZSkgewogICAgICAgICAgdmFyIHJldHJ5TGFuZSA9IE5vTGFuZTsKICAgICAgICAgIHZhciByZXRyeUNhY2hlOwogICAgICAgICAgc3dpdGNoIChib3VuZGFyeUZpYmVyLnRhZykgewogICAgICAgICAgICBjYXNlIFN1c3BlbnNlQ29tcG9uZW50OgogICAgICAgICAgICAgIHJldHJ5Q2FjaGUgPSBib3VuZGFyeUZpYmVyLnN0YXRlTm9kZTsKICAgICAgICAgICAgICB2YXIgc3VzcGVuc2VTdGF0ZSA9IGJvdW5kYXJ5RmliZXIubWVtb2l6ZWRTdGF0ZTsKICAgICAgICAgICAgICBpZiAoc3VzcGVuc2VTdGF0ZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0cnlMYW5lID0gc3VzcGVuc2VTdGF0ZS5yZXRyeUxhbmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFN1c3BlbnNlTGlzdENvbXBvbmVudDoKICAgICAgICAgICAgICByZXRyeUNhY2hlID0gYm91bmRhcnlGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQaW5nZWQgdW5rbm93biBzdXNwZW5zZSBib3VuZGFyeSB0eXBlLiBUaGlzIGlzIHByb2JhYmx5IGEgYnVnIGluIFJlYWN0LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHJldHJ5Q2FjaGUgIT09IG51bGwpIHsKICAgICAgICAgICAgcmV0cnlDYWNoZS5kZWxldGUod2FrZWFibGUpOwogICAgICAgICAgfQogICAgICAgICAgcmV0cnlUaW1lZE91dEJvdW5kYXJ5KGJvdW5kYXJ5RmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpuZCh0aW1lRWxhcHNlZCkgewogICAgICAgICAgcmV0dXJuIHRpbWVFbGFwc2VkIDwgMTIwID8gMTIwIDogdGltZUVsYXBzZWQgPCA0ODAgPyA0ODAgOiB0aW1lRWxhcHNlZCA8IDEwODAgPyAxMDgwIDogdGltZUVsYXBzZWQgPCAxOTIwID8gMTkyMCA6IHRpbWVFbGFwc2VkIDwgM2UzID8gM2UzIDogdGltZUVsYXBzZWQgPCA0MzIwID8gNDMyMCA6IGNlaWwodGltZUVsYXBzZWQgLyAxOTYwKSAqIDE5NjA7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNoZWNrRm9yTmVzdGVkVXBkYXRlcygpIHsKICAgICAgICAgIGlmIChuZXN0ZWRVcGRhdGVDb3VudCA+IE5FU1RFRF9VUERBVEVfTElNSVQpIHsKICAgICAgICAgICAgbmVzdGVkVXBkYXRlQ291bnQgPSAwOwogICAgICAgICAgICByb290V2l0aE5lc3RlZFVwZGF0ZXMgPSBudWxsOwogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1heGltdW0gdXBkYXRlIGRlcHRoIGV4Y2VlZGVkLiBUaGlzIGNhbiBoYXBwZW4gd2hlbiBhIGNvbXBvbmVudCByZXBlYXRlZGx5IGNhbGxzIHNldFN0YXRlIGluc2lkZSBjb21wb25lbnRXaWxsVXBkYXRlIG9yIGNvbXBvbmVudERpZFVwZGF0ZS4gUmVhY3QgbGltaXRzIHRoZSBudW1iZXIgb2YgbmVzdGVkIHVwZGF0ZXMgdG8gcHJldmVudCBpbmZpbml0ZSBsb29wcy4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA+IE5FU1RFRF9QQVNTSVZFX1VQREFURV9MSU1JVCkgewogICAgICAgICAgICAgIG5lc3RlZFBhc3NpdmVVcGRhdGVDb3VudCA9IDA7CiAgICAgICAgICAgICAgcm9vdFdpdGhQYXNzaXZlTmVzdGVkVXBkYXRlcyA9IG51bGw7CiAgICAgICAgICAgICAgZXJyb3IoIk1heGltdW0gdXBkYXRlIGRlcHRoIGV4Y2VlZGVkLiBUaGlzIGNhbiBoYXBwZW4gd2hlbiBhIGNvbXBvbmVudCBjYWxscyBzZXRTdGF0ZSBpbnNpZGUgdXNlRWZmZWN0LCBidXQgdXNlRWZmZWN0IGVpdGhlciBkb2Vzbid0IGhhdmUgYSBkZXBlbmRlbmN5IGFycmF5LCBvciBvbmUgb2YgdGhlIGRlcGVuZGVuY2llcyBjaGFuZ2VzIG9uIGV2ZXJ5IHJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBmbHVzaFJlbmRlclBoYXNlU3RyaWN0TW9kZVdhcm5pbmdzSW5ERVYoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmZsdXNoTGVnYWN5Q29udGV4dFdhcm5pbmcoKTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIFJlYWN0U3RyaWN0TW9kZVdhcm5pbmdzLmZsdXNoUGVuZGluZ1Vuc2FmZUxpZmVjeWNsZVdhcm5pbmdzKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY29tbWl0RG91YmxlSW52b2tlRWZmZWN0c0luREVWKGZpYmVyLCBoYXNQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgewogICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50TGF5b3V0RGV2LCBpbnZva2VMYXlvdXRFZmZlY3RVbm1vdW50SW5ERVYpOwogICAgICAgICAgICBpZiAoaGFzUGFzc2l2ZUVmZmVjdHMpIHsKICAgICAgICAgICAgICBpbnZva2VFZmZlY3RzSW5EZXYoZmliZXIsIE1vdW50UGFzc2l2ZURldiwgaW52b2tlUGFzc2l2ZUVmZmVjdFVubW91bnRJbkRFVik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW52b2tlRWZmZWN0c0luRGV2KGZpYmVyLCBNb3VudExheW91dERldiwgaW52b2tlTGF5b3V0RWZmZWN0TW91bnRJbkRFVik7CiAgICAgICAgICAgIGlmIChoYXNQYXNzaXZlRWZmZWN0cykgewogICAgICAgICAgICAgIGludm9rZUVmZmVjdHNJbkRldihmaWJlciwgTW91bnRQYXNzaXZlRGV2LCBpbnZva2VQYXNzaXZlRWZmZWN0TW91bnRJbkRFVik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW52b2tlRWZmZWN0c0luRGV2KGZpcnN0Q2hpbGQsIGZpYmVyRmxhZ3MsIGludm9rZUVmZmVjdEZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBjdXJyZW50NCA9IGZpcnN0Q2hpbGQ7CiAgICAgICAgICAgIHZhciBzdWJ0cmVlUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmltYXJ5U3VidHJlZUZsYWcgPSBjdXJyZW50NC5zdWJ0cmVlRmxhZ3MgJiBmaWJlckZsYWdzOwogICAgICAgICAgICAgIGlmIChjdXJyZW50NCAhPT0gc3VidHJlZVJvb3QgJiYgY3VycmVudDQuY2hpbGQgIT09IG51bGwgJiYgcHJpbWFyeVN1YnRyZWVGbGFnICE9PSBOb0ZsYWdzKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50NCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoKGN1cnJlbnQ0LmZsYWdzICYgZmliZXJGbGFncykgIT09IE5vRmxhZ3MpIHsKICAgICAgICAgICAgICAgICAgaW52b2tlRWZmZWN0Rm4oY3VycmVudDQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQ0LnNpYmxpbmcgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgY3VycmVudDQgPSBjdXJyZW50NC5zaWJsaW5nOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgY3VycmVudDQgPSBzdWJ0cmVlUm9vdCA9IGN1cnJlbnQ0LnJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQgPSBudWxsOwogICAgICAgIGZ1bmN0aW9uIHdhcm5BYm91dFVwZGF0ZU9uTm90WWV0TW91bnRlZEZpYmVySW5ERVYoZmliZXIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKChleGVjdXRpb25Db250ZXh0ICYgUmVuZGVyQ29udGV4dCkgIT09IE5vQ29udGV4dCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIShmaWJlci5tb2RlICYgQ29uY3VycmVudE1vZGUpKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0YWcgPSBmaWJlci50YWc7CiAgICAgICAgICAgIGlmICh0YWcgIT09IEluZGV0ZXJtaW5hdGVDb21wb25lbnQgJiYgdGFnICE9PSBIb3N0Um9vdCAmJiB0YWcgIT09IENsYXNzQ29tcG9uZW50ICYmIHRhZyAhPT0gRnVuY3Rpb25Db21wb25lbnQgJiYgdGFnICE9PSBGb3J3YXJkUmVmMiAmJiB0YWcgIT09IE1lbW9Db21wb25lbnQgJiYgdGFnICE9PSBTaW1wbGVNZW1vQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlJlYWN0Q29tcG9uZW50IjsKICAgICAgICAgICAgaWYgKGRpZFdhcm5TdGF0ZVVwZGF0ZUZvck5vdFlldE1vdW50ZWRDb21wb25lbnQgIT09IG51bGwpIHsKICAgICAgICAgICAgICBpZiAoZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudC5oYXMoY29tcG9uZW50TmFtZSkpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudC5hZGQoY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgZGlkV2FyblN0YXRlVXBkYXRlRm9yTm90WWV0TW91bnRlZENvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtjb21wb25lbnROYW1lXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHByZXZpb3VzRmliZXIgPSBjdXJyZW50MzsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgIGVycm9yKCJDYW4ndCBwZXJmb3JtIGEgUmVhY3Qgc3RhdGUgdXBkYXRlIG9uIGEgY29tcG9uZW50IHRoYXQgaGFzbid0IG1vdW50ZWQgeWV0LiBUaGlzIGluZGljYXRlcyB0aGF0IHlvdSBoYXZlIGEgc2lkZS1lZmZlY3QgaW4geW91ciByZW5kZXIgZnVuY3Rpb24gdGhhdCBhc3luY2hyb25vdXNseSBsYXRlciBjYWxscyB0cmllcyB0byB1cGRhdGUgdGhlIGNvbXBvbmVudC4gTW92ZSB0aGlzIHdvcmsgdG8gdXNlRWZmZWN0IGluc3RlYWQuIik7CiAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgaWYgKHByZXZpb3VzRmliZXIpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJlc2V0Q3VycmVudEZpYmVyKCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBiZWdpbldvcmskMTsKICAgICAgICB7CiAgICAgICAgICB2YXIgZHVtbXlGaWJlciA9IG51bGw7CiAgICAgICAgICBiZWdpbldvcmskMSA9IGZ1bmN0aW9uKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBsYW5lcykgewogICAgICAgICAgICB2YXIgb3JpZ2luYWxXb3JrSW5Qcm9ncmVzc0NvcHkgPSBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVihkdW1teUZpYmVyLCB1bml0T2ZXb3JrKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICByZXR1cm4gYmVnaW5Xb3JrKGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgIH0gY2F0Y2ggKG9yaWdpbmFsRXJyb3IpIHsKICAgICAgICAgICAgICBpZiAoZGlkU3VzcGVuZE9yRXJyb3JXaGlsZUh5ZHJhdGluZ0RFVigpIHx8IG9yaWdpbmFsRXJyb3IgIT09IG51bGwgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IgPT09ICJvYmplY3QiICYmIHR5cGVvZiBvcmlnaW5hbEVycm9yLnRoZW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHRocm93IG9yaWdpbmFsRXJyb3I7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJlc2V0Q29udGV4dERlcGVuZGVuY2llcygpOwogICAgICAgICAgICAgIHJlc2V0SG9va3NBZnRlclRocm93KCk7CiAgICAgICAgICAgICAgdW53aW5kSW50ZXJydXB0ZWRXb3JrKGN1cnJlbnQ0LCB1bml0T2ZXb3JrKTsKICAgICAgICAgICAgICBhc3NpZ25GaWJlclByb3BlcnRpZXNJbkRFVih1bml0T2ZXb3JrLCBvcmlnaW5hbFdvcmtJblByb2dyZXNzQ29weSk7CiAgICAgICAgICAgICAgaWYgKHVuaXRPZldvcmsubW9kZSAmIFByb2ZpbGVNb2RlKSB7CiAgICAgICAgICAgICAgICBzdGFydFByb2ZpbGVyVGltZXIodW5pdE9mV29yayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGludm9rZUd1YXJkZWRDYWxsYmFjayhudWxsLCBiZWdpbldvcmssIG51bGwsIGN1cnJlbnQ0LCB1bml0T2ZXb3JrLCBsYW5lcyk7CiAgICAgICAgICAgICAgaWYgKGhhc0NhdWdodEVycm9yKCkpIHsKICAgICAgICAgICAgICAgIHZhciByZXBsYXlFcnJvciA9IGNsZWFyQ2F1Z2h0RXJyb3IoKTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVwbGF5RXJyb3IgPT09ICJvYmplY3QiICYmIHJlcGxheUVycm9yICE9PSBudWxsICYmIHJlcGxheUVycm9yLl9zdXBwcmVzc0xvZ2dpbmcgJiYgdHlwZW9mIG9yaWdpbmFsRXJyb3IgPT09ICJvYmplY3QiICYmIG9yaWdpbmFsRXJyb3IgIT09IG51bGwgJiYgIW9yaWdpbmFsRXJyb3IuX3N1cHByZXNzTG9nZ2luZykgewogICAgICAgICAgICAgICAgICBvcmlnaW5hbEVycm9yLl9zdXBwcmVzc0xvZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB0aHJvdyBvcmlnaW5hbEVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXIgPSBmYWxzZTsKICAgICAgICB2YXIgZGlkV2FybkFib3V0VXBkYXRlSW5SZW5kZXJGb3JBbm90aGVyQ29tcG9uZW50OwogICAgICAgIHsKICAgICAgICAgIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5BYm91dFJlbmRlclBoYXNlVXBkYXRlc0luREVWKGZpYmVyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc1JlbmRlcmluZyAmJiAhZ2V0SXNVcGRhdGluZ09wYXF1ZVZhbHVlSW5SZW5kZXJQaGFzZUluREVWKCkpIHsKICAgICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgICAgY2FzZSBGdW5jdGlvbkNvbXBvbmVudDoKICAgICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6CiAgICAgICAgICAgICAgICBjYXNlIFNpbXBsZU1lbW9Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgdmFyIHJlbmRlcmluZ0NvbXBvbmVudE5hbWUgPSB3b3JrSW5Qcm9ncmVzcyAmJiBnZXRDb21wb25lbnROYW1lRnJvbUZpYmVyKHdvcmtJblByb2dyZXNzKSB8fCAiVW5rbm93biI7CiAgICAgICAgICAgICAgICAgIHZhciBkZWR1cGVLZXkgPSByZW5kZXJpbmdDb21wb25lbnROYW1lOwogICAgICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudC5oYXMoZGVkdXBlS2V5KSkgewogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyRm9yQW5vdGhlckNvbXBvbmVudC5hZGQoZGVkdXBlS2V5KTsKICAgICAgICAgICAgICAgICAgICB2YXIgc2V0U3RhdGVDb21wb25lbnROYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikgfHwgIlVua25vd24iOwogICAgICAgICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgdXBkYXRlIGEgY29tcG9uZW50IChgJXNgKSB3aGlsZSByZW5kZXJpbmcgYSBkaWZmZXJlbnQgY29tcG9uZW50IChgJXNgKS4gVG8gbG9jYXRlIHRoZSBiYWQgc2V0U3RhdGUoKSBjYWxsIGluc2lkZSBgJXNgLCBmb2xsb3cgdGhlIHN0YWNrIHRyYWNlIGFzIGRlc2NyaWJlZCBpbiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc2V0c3RhdGUtaW4tcmVuZGVyIiwgc2V0U3RhdGVDb21wb25lbnROYW1lLCByZW5kZXJpbmdDb21wb25lbnROYW1lLCByZW5kZXJpbmdDb21wb25lbnROYW1lKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVcGRhdGVJblJlbmRlcikgewogICAgICAgICAgICAgICAgICAgIGVycm9yKCJDYW5ub3QgdXBkYXRlIGR1cmluZyBhbiBleGlzdGluZyBzdGF0ZSB0cmFuc2l0aW9uIChzdWNoIGFzIHdpdGhpbiBgcmVuZGVyYCkuIFJlbmRlciBtZXRob2RzIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlLiIpOwogICAgICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dFVwZGF0ZUluUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzdG9yZVBlbmRpbmdVcGRhdGVycyhyb290MywgbGFuZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgICAgdmFyIG1lbW9pemVkVXBkYXRlcnMgPSByb290My5tZW1vaXplZFVwZGF0ZXJzOwogICAgICAgICAgICAgIG1lbW9pemVkVXBkYXRlcnMuZm9yRWFjaChmdW5jdGlvbihzY2hlZHVsaW5nRmliZXIpIHsKICAgICAgICAgICAgICAgIGFkZEZpYmVyVG9MYW5lc01hcChyb290Mywgc2NoZWR1bGluZ0ZpYmVyLCBsYW5lcyk7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGZha2VBY3RDYWxsYmFja05vZGUgPSB7fTsKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrJDEocHJpb3JpdHlMZXZlbCwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGFjdFF1ZXVlID0gUmVhY3RDdXJyZW50QWN0UXVldWUkMS5jdXJyZW50OwogICAgICAgICAgICBpZiAoYWN0UXVldWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICBhY3RRdWV1ZS5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgICByZXR1cm4gZmFrZUFjdENhbGxiYWNrTm9kZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gc2NoZWR1bGVDYWxsYmFjayhwcmlvcml0eUxldmVsLCBjYWxsYmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY2FuY2VsQ2FsbGJhY2skMShjYWxsYmFja05vZGUpIHsKICAgICAgICAgIGlmIChjYWxsYmFja05vZGUgPT09IGZha2VBY3RDYWxsYmFja05vZGUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNhbmNlbENhbGxiYWNrKGNhbGxiYWNrTm9kZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNob3VsZEZvcmNlRmx1c2hGYWxsYmFja3NJbkRFVigpIHsKICAgICAgICAgIHJldHVybiBSZWFjdEN1cnJlbnRBY3RRdWV1ZSQxLmN1cnJlbnQgIT09IG51bGw7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlVwZGF0ZXNOb3RXcmFwcGVkV2l0aEFjdERFVihmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoZmliZXIubW9kZSAmIENvbmN1cnJlbnRNb2RlKSB7CiAgICAgICAgICAgICAgaWYgKCFpc0NvbmN1cnJlbnRBY3RFbnZpcm9ubWVudCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGlmICghaXNMZWdhY3lBY3RFbnZpcm9ubWVudCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChleGVjdXRpb25Db250ZXh0ICE9PSBOb0NvbnRleHQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gRnVuY3Rpb25Db21wb25lbnQgJiYgZmliZXIudGFnICE9PSBGb3J3YXJkUmVmMiAmJiBmaWJlci50YWcgIT09IFNpbXBsZU1lbW9Db21wb25lbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gY3VycmVudDM7CiAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihmaWJlcik7CiAgICAgICAgICAgICAgICBlcnJvcigiQW4gdXBkYXRlIHRvICVzIGluc2lkZSBhIHRlc3Qgd2FzIG5vdCB3cmFwcGVkIGluIGFjdCguLi4pLlxuXG5XaGVuIHRlc3RpbmcsIGNvZGUgdGhhdCBjYXVzZXMgUmVhY3Qgc3RhdGUgdXBkYXRlcyBzaG91bGQgYmUgd3JhcHBlZCBpbnRvIGFjdCguLi4pOlxuXG5hY3QoKCkgPT4ge1xuICAvKiBmaXJlIGV2ZW50cyB0aGF0IHVwZGF0ZSBzdGF0ZSAqL1xufSk7XG4vKiBhc3NlcnQgb24gdGhlIG91dHB1dCAqL1xuXG5UaGlzIGVuc3VyZXMgdGhhdCB5b3UncmUgdGVzdGluZyB0aGUgYmVoYXZpb3IgdGhlIHVzZXIgd291bGQgc2VlIGluIHRoZSBicm93c2VyLiBMZWFybiBtb3JlIGF0IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93cmFwLXRlc3RzLXdpdGgtYWN0IiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihmaWJlcikpOwogICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlcikgewogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoZmliZXIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgcmVzZXRDdXJyZW50RmliZXIoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gd2FybklmU3VzcGVuc2VSZXNvbHV0aW9uTm90V3JhcHBlZFdpdGhBY3RERVYocm9vdDMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJvb3QzLnRhZyAhPT0gTGVnYWN5Um9vdCAmJiBpc0NvbmN1cnJlbnRBY3RFbnZpcm9ubWVudCgpICYmIFJlYWN0Q3VycmVudEFjdFF1ZXVlJDEuY3VycmVudCA9PT0gbnVsbCkgewogICAgICAgICAgICAgIGVycm9yKCJBIHN1c3BlbmRlZCByZXNvdXJjZSBmaW5pc2hlZCBsb2FkaW5nIGluc2lkZSBhIHRlc3QsIGJ1dCB0aGUgZXZlbnQgd2FzIG5vdCB3cmFwcGVkIGluIGFjdCguLi4pLlxuXG5XaGVuIHRlc3RpbmcsIGNvZGUgdGhhdCByZXNvbHZlcyBzdXNwZW5kZWQgZGF0YSBzaG91bGQgYmUgd3JhcHBlZCBpbnRvIGFjdCguLi4pOlxuXG5hY3QoKCkgPT4ge1xuICAvKiBmaW5pc2ggbG9hZGluZyBzdXNwZW5kZWQgZGF0YSAqL1xufSk7XG4vKiBhc3NlcnQgb24gdGhlIG91dHB1dCAqL1xuXG5UaGlzIGVuc3VyZXMgdGhhdCB5b3UncmUgdGVzdGluZyB0aGUgYmVoYXZpb3IgdGhlIHVzZXIgd291bGQgc2VlIGluIHRoZSBicm93c2VyLiBMZWFybiBtb3JlIGF0IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93cmFwLXRlc3RzLXdpdGgtYWN0Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2V0SXNSdW5uaW5nSW5zZXJ0aW9uRWZmZWN0KGlzUnVubmluZykgewogICAgICAgICAgewogICAgICAgICAgICBpc1J1bm5pbmdJbnNlcnRpb25FZmZlY3QgPSBpc1J1bm5pbmc7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZXNvbHZlRmFtaWx5ID0gbnVsbDsKICAgICAgICB2YXIgZmFpbGVkQm91bmRhcmllcyA9IG51bGw7CiAgICAgICAgdmFyIHNldFJlZnJlc2hIYW5kbGVyID0gZnVuY3Rpb24oaGFuZGxlcikgewogICAgICAgICAgewogICAgICAgICAgICByZXNvbHZlRmFtaWx5ID0gaGFuZGxlcjsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyh0eXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyZXNvbHZlRmFtaWx5ID09PSBudWxsKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGZhbWlseSA9IHJlc29sdmVGYW1pbHkodHlwZSk7CiAgICAgICAgICAgIGlmIChmYW1pbHkgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYW1pbHkuY3VycmVudDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKHR5cGUpIHsKICAgICAgICAgIHJldHVybiByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcodHlwZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlc29sdmVGb3J3YXJkUmVmRm9ySG90UmVsb2FkaW5nKHR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZmFtaWx5ID0gcmVzb2x2ZUZhbWlseSh0eXBlKTsKICAgICAgICAgICAgaWYgKGZhbWlseSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGUgIT09IG51bGwgJiYgdHlwZSAhPT0gdm9pZCAwICYmIHR5cGVvZiB0eXBlLnJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRSZW5kZXIgPSByZXNvbHZlRnVuY3Rpb25Gb3JIb3RSZWxvYWRpbmcodHlwZS5yZW5kZXIpOwogICAgICAgICAgICAgICAgaWYgKHR5cGUucmVuZGVyICE9PSBjdXJyZW50UmVuZGVyKSB7CiAgICAgICAgICAgICAgICAgIHZhciBzeW50aGV0aWNUeXBlID0gewogICAgICAgICAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiwKICAgICAgICAgICAgICAgICAgICByZW5kZXI6IGN1cnJlbnRSZW5kZXIKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgaWYgKHR5cGUuZGlzcGxheU5hbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgIHN5bnRoZXRpY1R5cGUuZGlzcGxheU5hbWUgPSB0eXBlLmRpc3BsYXlOYW1lOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHJldHVybiBzeW50aGV0aWNUeXBlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFtaWx5LmN1cnJlbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzQ29tcGF0aWJsZUZhbWlseUZvckhvdFJlbG9hZGluZyhmaWJlciwgZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJldlR5cGUgPSBmaWJlci5lbGVtZW50VHlwZTsKICAgICAgICAgICAgdmFyIG5leHRUeXBlID0gZWxlbWVudC50eXBlOwogICAgICAgICAgICB2YXIgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSBmYWxzZTsKICAgICAgICAgICAgdmFyICQkdHlwZW9mTmV4dFR5cGUgPSB0eXBlb2YgbmV4dFR5cGUgPT09ICJvYmplY3QiICYmIG5leHRUeXBlICE9PSBudWxsID8gbmV4dFR5cGUuJCR0eXBlb2YgOiBudWxsOwogICAgICAgICAgICBzd2l0Y2ggKGZpYmVyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgQ2xhc3NDb21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgRnVuY3Rpb25Db21wb25lbnQ6IHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV4dFR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNhc2UgRm9yd2FyZFJlZjI6IHsKICAgICAgICAgICAgICAgIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMikgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX0xBWllfVFlQRSkgewogICAgICAgICAgICAgICAgICBuZWVkc0NvbXBhcmVGYW1pbGllcyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY2FzZSBNZW1vQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDogewogICAgICAgICAgICAgICAgaWYgKCQkdHlwZW9mTmV4dFR5cGUgPT09IFJFQUNUX01FTU9fVFlQRTIpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICgkJHR5cGVvZk5leHRUeXBlID09PSBSRUFDVF9MQVpZX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgbmVlZHNDb21wYXJlRmFtaWxpZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG5lZWRzQ29tcGFyZUZhbWlsaWVzKSB7CiAgICAgICAgICAgICAgdmFyIHByZXZGYW1pbHkgPSByZXNvbHZlRmFtaWx5KHByZXZUeXBlKTsKICAgICAgICAgICAgICBpZiAocHJldkZhbWlseSAhPT0gdm9pZCAwICYmIHByZXZGYW1pbHkgPT09IHJlc29sdmVGYW1pbHkobmV4dFR5cGUpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrRmFpbGVkRXJyb3JCb3VuZGFyeUZvckhvdFJlbG9hZGluZyhmaWJlcikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIFdlYWtTZXQgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZhaWxlZEJvdW5kYXJpZXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICBmYWlsZWRCb3VuZGFyaWVzID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmFpbGVkQm91bmRhcmllcy5hZGQoZmliZXIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgc2NoZWR1bGVSZWZyZXNoID0gZnVuY3Rpb24ocm9vdDMsIHVwZGF0ZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocmVzb2x2ZUZhbWlseSA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgc3RhbGVGYW1pbGllcyA9IHVwZGF0ZS5zdGFsZUZhbWlsaWVzLCB1cGRhdGVkRmFtaWxpZXMgPSB1cGRhdGUudXBkYXRlZEZhbWlsaWVzOwogICAgICAgICAgICBmbHVzaFBhc3NpdmVFZmZlY3RzKCk7CiAgICAgICAgICAgIGZsdXNoU3luYyhmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KHJvb3QzLmN1cnJlbnQsIHVwZGF0ZWRGYW1pbGllcywgc3RhbGVGYW1pbGllcyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIHNjaGVkdWxlUm9vdCA9IGZ1bmN0aW9uKHJvb3QzLCBlbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChyb290My5jb250ZXh0ICE9PSBlbXB0eUNvbnRleHRPYmplY3QpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZmx1c2hQYXNzaXZlRWZmZWN0cygpOwogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGVsZW1lbnQsIHJvb3QzLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBzY2hlZHVsZUZpYmVyc1dpdGhGYW1pbGllc1JlY3Vyc2l2ZWx5KGZpYmVyLCB1cGRhdGVkRmFtaWxpZXMsIHN0YWxlRmFtaWxpZXMpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGFsdGVybmF0ZSA9IGZpYmVyLmFsdGVybmF0ZSwgY2hpbGQgPSBmaWJlci5jaGlsZCwgc2libGluZyA9IGZpYmVyLnNpYmxpbmcsIHRhZyA9IGZpYmVyLnRhZywgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgIHZhciBjYW5kaWRhdGVUeXBlID0gbnVsbDsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGUucmVuZGVyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHJlc29sdmVGYW1pbHkgPT09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkV4cGVjdGVkIHJlc29sdmVGYW1pbHkgdG8gYmUgc2V0IGR1cmluZyBob3QgcmVsb2FkLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBuZWVkc1JlbmRlciA9IGZhbHNlOwogICAgICAgICAgICB2YXIgbmVlZHNSZW1vdW50ID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChjYW5kaWRhdGVUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIGZhbWlseSA9IHJlc29sdmVGYW1pbHkoY2FuZGlkYXRlVHlwZSk7CiAgICAgICAgICAgICAgaWYgKGZhbWlseSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBpZiAoc3RhbGVGYW1pbGllcy5oYXMoZmFtaWx5KSkgewogICAgICAgICAgICAgICAgICBuZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh1cGRhdGVkRmFtaWxpZXMuaGFzKGZhbWlseSkpIHsKICAgICAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gQ2xhc3NDb21wb25lbnQpIHsKICAgICAgICAgICAgICAgICAgICBuZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIG5lZWRzUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZmFpbGVkQm91bmRhcmllcyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGlmIChmYWlsZWRCb3VuZGFyaWVzLmhhcyhmaWJlcikgfHwgYWx0ZXJuYXRlICE9PSBudWxsICYmIGZhaWxlZEJvdW5kYXJpZXMuaGFzKGFsdGVybmF0ZSkpIHsKICAgICAgICAgICAgICAgIG5lZWRzUmVtb3VudCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZWVkc1JlbW91bnQpIHsKICAgICAgICAgICAgICBmaWJlci5fZGVidWdOZWVkc1JlbW91bnQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZWVkc1JlbW91bnQgfHwgbmVlZHNSZW5kZXIpIHsKICAgICAgICAgICAgICB2YXIgX3Jvb3QgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAoX3Jvb3QgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihfcm9vdCwgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChjaGlsZCAhPT0gbnVsbCAmJiAhbmVlZHNSZW1vdW50KSB7CiAgICAgICAgICAgICAgc2NoZWR1bGVGaWJlcnNXaXRoRmFtaWxpZXNSZWN1cnNpdmVseShjaGlsZCwgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlRmliZXJzV2l0aEZhbWlsaWVzUmVjdXJzaXZlbHkoc2libGluZywgdXBkYXRlZEZhbWlsaWVzLCBzdGFsZUZhbWlsaWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgZmluZEhvc3RJbnN0YW5jZXNGb3JSZWZyZXNoID0gZnVuY3Rpb24ocm9vdDMsIGZhbWlsaWVzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2VzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdmFyIHR5cGVzID0gbmV3IFNldChmYW1pbGllcy5tYXAoZnVuY3Rpb24oZmFtaWx5KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbWlseS5jdXJyZW50OwogICAgICAgICAgICB9KSk7CiAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShyb290My5jdXJyZW50LCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgIHJldHVybiBob3N0SW5zdGFuY2VzOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZXNGb3JNYXRjaGluZ0ZpYmVyc1JlY3Vyc2l2ZWx5KGZpYmVyLCB0eXBlcywgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgY2hpbGQgPSBmaWJlci5jaGlsZCwgc2libGluZyA9IGZpYmVyLnNpYmxpbmcsIHRhZyA9IGZpYmVyLnRhZywgdHlwZSA9IGZpYmVyLnR5cGU7CiAgICAgICAgICAgIHZhciBjYW5kaWRhdGVUeXBlID0gbnVsbDsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIENsYXNzQ29tcG9uZW50OgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIEZvcndhcmRSZWYyOgogICAgICAgICAgICAgICAgY2FuZGlkYXRlVHlwZSA9IHR5cGUucmVuZGVyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGRpZE1hdGNoID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChjYW5kaWRhdGVUeXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgaWYgKHR5cGVzLmhhcyhjYW5kaWRhdGVUeXBlKSkgewogICAgICAgICAgICAgICAgZGlkTWF0Y2ggPSB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlkTWF0Y2gpIHsKICAgICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBpZiAoY2hpbGQgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShjaGlsZCwgdHlwZXMsIGhvc3RJbnN0YW5jZXMpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2libGluZyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VzRm9yTWF0Y2hpbmdGaWJlcnNSZWN1cnNpdmVseShzaWJsaW5nLCB0eXBlcywgaG9zdEluc3RhbmNlcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZXNGb3JGaWJlclNoYWxsb3dseShmaWJlciwgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgZm91bmRIb3N0SW5zdGFuY2VzID0gZmluZENoaWxkSG9zdEluc3RhbmNlc0ZvckZpYmVyU2hhbGxvd2x5KGZpYmVyLCBob3N0SW5zdGFuY2VzKTsKICAgICAgICAgICAgaWYgKGZvdW5kSG9zdEluc3RhbmNlcykgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB3aGlsZSAodHJ1ZSkgewogICAgICAgICAgICAgIHN3aXRjaCAobm9kZS50YWcpIHsKICAgICAgICAgICAgICAgIGNhc2UgSG9zdENvbXBvbmVudDoKICAgICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RQb3J0YWw6CiAgICAgICAgICAgICAgICAgIGhvc3RJbnN0YW5jZXMuYWRkKG5vZGUuc3RhdGVOb2RlLmNvbnRhaW5lckluZm8pOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICBjYXNlIEhvc3RSb290OgogICAgICAgICAgICAgICAgICBob3N0SW5zdGFuY2VzLmFkZChub2RlLnN0YXRlTm9kZS5jb250YWluZXJJbmZvKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdG8gcmVhY2ggcm9vdCBmaXJzdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbm9kZSA9IG5vZGUucmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRDaGlsZEhvc3RJbnN0YW5jZXNGb3JGaWJlclNoYWxsb3dseShmaWJlciwgaG9zdEluc3RhbmNlcykgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgbm9kZSA9IGZpYmVyOwogICAgICAgICAgICB2YXIgZm91bmRIb3N0SW5zdGFuY2VzID0gZmFsc2U7CiAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUudGFnID09PSBIb3N0Q29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICBmb3VuZEhvc3RJbnN0YW5jZXMgPSB0cnVlOwogICAgICAgICAgICAgICAgaG9zdEluc3RhbmNlcy5hZGQobm9kZS5zdGF0ZU5vZGUpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5jaGlsZCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbm9kZS5jaGlsZC5yZXR1cm4gPSBub2RlOwogICAgICAgICAgICAgICAgbm9kZSA9IG5vZGUuY2hpbGQ7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG5vZGUgPT09IGZpYmVyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZm91bmRIb3N0SW5zdGFuY2VzOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobm9kZS5zaWJsaW5nID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5yZXR1cm4gPT09IG51bGwgfHwgbm9kZS5yZXR1cm4gPT09IGZpYmVyKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBmb3VuZEhvc3RJbnN0YW5jZXM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZS5yZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG5vZGUuc2libGluZy5yZXR1cm4gPSBub2RlLnJldHVybjsKICAgICAgICAgICAgICBub2RlID0gbm9kZS5zaWJsaW5nOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHZhciBoYXNCYWRNYXBQb2x5ZmlsbDsKICAgICAgICB7CiAgICAgICAgICBoYXNCYWRNYXBQb2x5ZmlsbCA9IGZhbHNlOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgdmFyIG5vbkV4dGVuc2libGVPYmplY3QgPSBPYmplY3QucHJldmVudEV4dGVuc2lvbnMoe30pOwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gbmV3IE1hcChbW25vbkV4dGVuc2libGVPYmplY3QsIG51bGxdXSk7CiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFtub25FeHRlbnNpYmxlT2JqZWN0XSk7CiAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGhhc0JhZE1hcFBvbHlmaWxsID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gRmliZXJOb2RlKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpIHsKICAgICAgICAgIHRoaXMudGFnID0gdGFnOwogICAgICAgICAgdGhpcy5rZXkgPSBrZXk7CiAgICAgICAgICB0aGlzLmVsZW1lbnRUeXBlID0gbnVsbDsKICAgICAgICAgIHRoaXMudHlwZSA9IG51bGw7CiAgICAgICAgICB0aGlzLnN0YXRlTm9kZSA9IG51bGw7CiAgICAgICAgICB0aGlzLnJldHVybiA9IG51bGw7CiAgICAgICAgICB0aGlzLmNoaWxkID0gbnVsbDsKICAgICAgICAgIHRoaXMuc2libGluZyA9IG51bGw7CiAgICAgICAgICB0aGlzLmluZGV4ID0gMDsKICAgICAgICAgIHRoaXMucmVmID0gbnVsbDsKICAgICAgICAgIHRoaXMucGVuZGluZ1Byb3BzID0gcGVuZGluZ1Byb3BzOwogICAgICAgICAgdGhpcy5tZW1vaXplZFByb3BzID0gbnVsbDsKICAgICAgICAgIHRoaXMudXBkYXRlUXVldWUgPSBudWxsOwogICAgICAgICAgdGhpcy5tZW1vaXplZFN0YXRlID0gbnVsbDsKICAgICAgICAgIHRoaXMuZGVwZW5kZW5jaWVzID0gbnVsbDsKICAgICAgICAgIHRoaXMubW9kZSA9IG1vZGU7CiAgICAgICAgICB0aGlzLmZsYWdzID0gTm9GbGFnczsKICAgICAgICAgIHRoaXMuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgIHRoaXMuZGVsZXRpb25zID0gbnVsbDsKICAgICAgICAgIHRoaXMubGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuYWx0ZXJuYXRlID0gbnVsbDsKICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hY3R1YWxEdXJhdGlvbiA9IE51bWJlci5OYU47CiAgICAgICAgICAgIHRoaXMuYWN0dWFsU3RhcnRUaW1lID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy5zZWxmQmFzZUR1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy50cmVlQmFzZUR1cmF0aW9uID0gTnVtYmVyLk5hTjsKICAgICAgICAgICAgdGhpcy5hY3R1YWxEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuYWN0dWFsU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIHRoaXMuc2VsZkJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMudHJlZUJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnU291cmNlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5fZGVidWdPd25lciA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnTmVlZHNSZW1vdW50ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnSG9va1R5cGVzID0gbnVsbDsKICAgICAgICAgICAgaWYgKCFoYXNCYWRNYXBQb2x5ZmlsbCAmJiB0eXBlb2YgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBjcmVhdGVGaWJlciA9IGZ1bmN0aW9uKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpIHsKICAgICAgICAgIHJldHVybiBuZXcgRmliZXJOb2RlKHRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0JDEoQ29tcG9uZW50KSB7CiAgICAgICAgICB2YXIgcHJvdG90eXBlID0gQ29tcG9uZW50LnByb3RvdHlwZTsKICAgICAgICAgIHJldHVybiAhIShwcm90b3R5cGUgJiYgcHJvdG90eXBlLmlzUmVhY3RDb21wb25lbnQpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1NpbXBsZUZ1bmN0aW9uQ29tcG9uZW50KHR5cGUpIHsKICAgICAgICAgIHJldHVybiB0eXBlb2YgdHlwZSA9PT0gImZ1bmN0aW9uIiAmJiAhc2hvdWxkQ29uc3RydWN0JDEodHlwZSkgJiYgdHlwZS5kZWZhdWx0UHJvcHMgPT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZUxhenlDb21wb25lbnRUYWcoQ29tcG9uZW50KSB7CiAgICAgICAgICBpZiAodHlwZW9mIENvbXBvbmVudCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gc2hvdWxkQ29uc3RydWN0JDEoQ29tcG9uZW50KSA/IENsYXNzQ29tcG9uZW50IDogRnVuY3Rpb25Db21wb25lbnQ7CiAgICAgICAgICB9IGVsc2UgaWYgKENvbXBvbmVudCAhPT0gdm9pZCAwICYmIENvbXBvbmVudCAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgJCR0eXBlb2YgPSBDb21wb25lbnQuJCR0eXBlb2Y7CiAgICAgICAgICAgIGlmICgkJHR5cGVvZiA9PT0gUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTIpIHsKICAgICAgICAgICAgICByZXR1cm4gRm9yd2FyZFJlZjI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCQkdHlwZW9mID09PSBSRUFDVF9NRU1PX1RZUEUyKSB7CiAgICAgICAgICAgICAgcmV0dXJuIE1lbW9Db21wb25lbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBJbmRldGVybWluYXRlQ29tcG9uZW50OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVXb3JrSW5Qcm9ncmVzcyhjdXJyZW50NCwgcGVuZGluZ1Byb3BzKSB7CiAgICAgICAgICB2YXIgd29ya0luUHJvZ3Jlc3MyID0gY3VycmVudDQuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKHdvcmtJblByb2dyZXNzMiA9PT0gbnVsbCkgewogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIgPSBjcmVhdGVGaWJlcihjdXJyZW50NC50YWcsIHBlbmRpbmdQcm9wcywgY3VycmVudDQua2V5LCBjdXJyZW50NC5tb2RlKTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmVsZW1lbnRUeXBlID0gY3VycmVudDQuZWxlbWVudFR5cGU7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gY3VycmVudDQudHlwZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN0YXRlTm9kZSA9IGN1cnJlbnQ0LnN0YXRlTm9kZTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdTb3VyY2UgPSBjdXJyZW50NC5fZGVidWdTb3VyY2U7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z093bmVyID0gY3VycmVudDQuX2RlYnVnT3duZXI7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLl9kZWJ1Z0hvb2tUeXBlcyA9IGN1cnJlbnQ0Ll9kZWJ1Z0hvb2tUeXBlczsKICAgICAgICAgICAgfQogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlID0gY3VycmVudDQ7CiAgICAgICAgICAgIGN1cnJlbnQ0LmFsdGVybmF0ZSA9IHdvcmtJblByb2dyZXNzMjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5wZW5kaW5nUHJvcHMgPSBwZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gY3VycmVudDQudHlwZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnN1YnRyZWVGbGFncyA9IE5vRmxhZ3M7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZWxldGlvbnMgPSBudWxsOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmFjdHVhbER1cmF0aW9uID0gMDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuYWN0dWFsU3RhcnRUaW1lID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5mbGFncyA9IGN1cnJlbnQ0LmZsYWdzICYgU3RhdGljTWFzazsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gY3VycmVudDQuY2hpbGRMYW5lczsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5sYW5lcyA9IGN1cnJlbnQ0LmxhbmVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmNoaWxkID0gY3VycmVudDQuY2hpbGQ7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRQcm9wcyA9IGN1cnJlbnQ0Lm1lbW9pemVkUHJvcHM7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IGN1cnJlbnQ0Lm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgIHZhciBjdXJyZW50RGVwZW5kZW5jaWVzID0gY3VycmVudDQuZGVwZW5kZW5jaWVzOwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IGN1cnJlbnREZXBlbmRlbmNpZXMgPT09IG51bGwgPyBudWxsIDogewogICAgICAgICAgICBsYW5lczogY3VycmVudERlcGVuZGVuY2llcy5sYW5lcywKICAgICAgICAgICAgZmlyc3RDb250ZXh0OiBjdXJyZW50RGVwZW5kZW5jaWVzLmZpcnN0Q29udGV4dAogICAgICAgICAgfTsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zaWJsaW5nID0gY3VycmVudDQuc2libGluZzsKICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5pbmRleCA9IGN1cnJlbnQ0LmluZGV4OwogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnJlZiA9IGN1cnJlbnQ0LnJlZjsKICAgICAgICAgIHsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnNlbGZCYXNlRHVyYXRpb24gPSBjdXJyZW50NC5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnQ0LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5fZGVidWdOZWVkc1JlbW91bnQgPSBjdXJyZW50NC5fZGVidWdOZWVkc1JlbW91bnQ7CiAgICAgICAgICAgIHN3aXRjaCAod29ya0luUHJvZ3Jlc3MyLnRhZykgewogICAgICAgICAgICAgIGNhc2UgSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDoKICAgICAgICAgICAgICBjYXNlIEZ1bmN0aW9uQ29tcG9uZW50OgogICAgICAgICAgICAgIGNhc2UgU2ltcGxlTWVtb0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUZ1bmN0aW9uRm9ySG90UmVsb2FkaW5nKGN1cnJlbnQ0LnR5cGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBDbGFzc0NvbXBvbmVudDoKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKGN1cnJlbnQ0LnR5cGUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBGb3J3YXJkUmVmMjoKICAgICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi50eXBlID0gcmVzb2x2ZUZvcndhcmRSZWZGb3JIb3RSZWxvYWRpbmcoY3VycmVudDQudHlwZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHdvcmtJblByb2dyZXNzMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVzZXRXb3JrSW5Qcm9ncmVzcyh3b3JrSW5Qcm9ncmVzczIsIHJlbmRlckxhbmVzMikgewogICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmZsYWdzICY9IFN0YXRpY01hc2sgfCBQbGFjZW1lbnQ7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSB3b3JrSW5Qcm9ncmVzczIuYWx0ZXJuYXRlOwogICAgICAgICAgaWYgKGN1cnJlbnQ0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gcmVuZGVyTGFuZXMyOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuY2hpbGQgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkUHJvcHMgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIubWVtb2l6ZWRTdGF0ZSA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi51cGRhdGVRdWV1ZSA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5kZXBlbmRlbmNpZXMgPSBudWxsOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3RhdGVOb2RlID0gbnVsbDsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zZWxmQmFzZUR1cmF0aW9uID0gMDsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZExhbmVzID0gY3VycmVudDQuY2hpbGRMYW5lczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmxhbmVzID0gY3VycmVudDQubGFuZXM7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5jaGlsZCA9IGN1cnJlbnQ0LmNoaWxkOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIuc3VidHJlZUZsYWdzID0gTm9GbGFnczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlbGV0aW9ucyA9IG51bGw7CiAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5tZW1vaXplZFByb3BzID0gY3VycmVudDQubWVtb2l6ZWRQcm9wczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLm1lbW9pemVkU3RhdGUgPSBjdXJyZW50NC5tZW1vaXplZFN0YXRlOwogICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudXBkYXRlUXVldWUgPSBjdXJyZW50NC51cGRhdGVRdWV1ZTsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLnR5cGUgPSBjdXJyZW50NC50eXBlOwogICAgICAgICAgICB2YXIgY3VycmVudERlcGVuZGVuY2llcyA9IGN1cnJlbnQ0LmRlcGVuZGVuY2llczsKICAgICAgICAgICAgd29ya0luUHJvZ3Jlc3MyLmRlcGVuZGVuY2llcyA9IGN1cnJlbnREZXBlbmRlbmNpZXMgPT09IG51bGwgPyBudWxsIDogewogICAgICAgICAgICAgIGxhbmVzOiBjdXJyZW50RGVwZW5kZW5jaWVzLmxhbmVzLAogICAgICAgICAgICAgIGZpcnN0Q29udGV4dDogY3VycmVudERlcGVuZGVuY2llcy5maXJzdENvbnRleHQKICAgICAgICAgICAgfTsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHdvcmtJblByb2dyZXNzMi5zZWxmQmFzZUR1cmF0aW9uID0gY3VycmVudDQuc2VsZkJhc2VEdXJhdGlvbjsKICAgICAgICAgICAgICB3b3JrSW5Qcm9ncmVzczIudHJlZUJhc2VEdXJhdGlvbiA9IGN1cnJlbnQ0LnRyZWVCYXNlRHVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB3b3JrSW5Qcm9ncmVzczI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUhvc3RSb290RmliZXIodGFnLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUpIHsKICAgICAgICAgIHZhciBtb2RlOwogICAgICAgICAgaWYgKHRhZyA9PT0gQ29uY3VycmVudFJvb3QpIHsKICAgICAgICAgICAgbW9kZSA9IENvbmN1cnJlbnRNb2RlOwogICAgICAgICAgICBpZiAoaXNTdHJpY3RNb2RlID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgbW9kZSB8PSBTdHJpY3RMZWdhY3lNb2RlOwogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1vZGUgfD0gU3RyaWN0RWZmZWN0c01vZGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtb2RlID0gTm9Nb2RlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzRGV2VG9vbHNQcmVzZW50KSB7CiAgICAgICAgICAgIG1vZGUgfD0gUHJvZmlsZU1vZGU7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXIoSG9zdFJvb3QsIG51bGwsIG51bGwsIG1vZGUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21UeXBlQW5kUHJvcHModHlwZSwga2V5LCBwZW5kaW5nUHJvcHMsIG93bmVyLCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIGZpYmVyVGFnID0gSW5kZXRlcm1pbmF0ZUNvbXBvbmVudDsKICAgICAgICAgIHZhciByZXNvbHZlZFR5cGUgPSB0eXBlOwogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIGlmIChzaG91bGRDb25zdHJ1Y3QkMSh0eXBlKSkgewogICAgICAgICAgICAgIGZpYmVyVGFnID0gQ2xhc3NDb21wb25lbnQ7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVzb2x2ZWRUeXBlID0gcmVzb2x2ZUNsYXNzRm9ySG90UmVsb2FkaW5nKHJlc29sdmVkVHlwZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IHJlc29sdmVGdW5jdGlvbkZvckhvdFJlbG9hZGluZyhyZXNvbHZlZFR5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgZmliZXJUYWcgPSBIb3N0Q29tcG9uZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2V0VGFnOiBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tRnJhZ21lbnQocGVuZGluZ1Byb3BzLmNoaWxkcmVuLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NUUklDVF9NT0RFX1RZUEU6CiAgICAgICAgICAgICAgICBmaWJlclRhZyA9IE1vZGU7CiAgICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdExlZ2FjeU1vZGU7CiAgICAgICAgICAgICAgICBpZiAoKG1vZGUgJiBDb25jdXJyZW50TW9kZSkgIT09IE5vTW9kZSkgewogICAgICAgICAgICAgICAgICBtb2RlIHw9IFN0cmljdEVmZmVjdHNNb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9QUk9GSUxFUl9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbVByb2ZpbGVyKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9UWVBFOgogICAgICAgICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyRnJvbVN1c3BlbnNlKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU6CiAgICAgICAgICAgICAgICByZXR1cm4gY3JlYXRlRmliZXJGcm9tU3VzcGVuc2VMaXN0KHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSk7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9PRkZTQ1JFRU5fVFlQRToKICAgICAgICAgICAgICAgIHJldHVybiBjcmVhdGVGaWJlckZyb21PZmZzY3JlZW4ocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xFR0FDWV9ISURERU5fVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1NDT1BFX1RZUEU6CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DQUNIRV9UWVBFOgogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfVFJBQ0lOR19NQVJLRVJfVFlQRToKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0RFQlVHX1RSQUNJTkdfTU9ERV9UWVBFOgogICAgICAgICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgdHlwZSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICBzd2l0Y2ggKHR5cGUuJCR0eXBlb2YpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IENvbnRleHRQcm92aWRlcjsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0NPTlRFWFRfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gQ29udGV4dENvbnN1bWVyOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICAgICAgICBmaWJlclRhZyA9IEZvcndhcmRSZWYyOwogICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlZFR5cGUgPSByZXNvbHZlRm9yd2FyZFJlZkZvckhvdFJlbG9hZGluZyhyZXNvbHZlZFR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgYnJlYWsgZ2V0VGFnOwogICAgICAgICAgICAgICAgICAgIGNhc2UgUkVBQ1RfTUVNT19UWVBFMjoKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gTWVtb0NvbXBvbmVudDsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrIGdldFRhZzsKICAgICAgICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRToKICAgICAgICAgICAgICAgICAgICAgIGZpYmVyVGFnID0gTGF6eUNvbXBvbmVudDsKICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmVkVHlwZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICBicmVhayBnZXRUYWc7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBpbmZvID0gIiI7CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwgJiYgT2JqZWN0LmtleXModHlwZSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaW5mbyArPSAiIFlvdSBsaWtlbHkgZm9yZ290IHRvIGV4cG9ydCB5b3VyIGNvbXBvbmVudCBmcm9tIHRoZSBmaWxlIGl0J3MgZGVmaW5lZCBpbiwgb3IgeW91IG1pZ2h0IGhhdmUgbWl4ZWQgdXAgZGVmYXVsdCBhbmQgbmFtZWQgaW1wb3J0cy4iOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIHZhciBvd25lck5hbWUgPSBvd25lciA/IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIob3duZXIpIDogbnVsbDsKICAgICAgICAgICAgICAgICAgaWYgKG93bmVyTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGluZm8gKz0gIlxuXG5DaGVjayB0aGUgcmVuZGVyIG1ldGhvZCBvZiBgIiArIG93bmVyTmFtZSArICJgLiI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRWxlbWVudCB0eXBlIGlzIGludmFsaWQ6IGV4cGVjdGVkIGEgc3RyaW5nIChmb3IgYnVpbHQtaW4gY29tcG9uZW50cykgb3IgYSBjbGFzcy9mdW5jdGlvbiAoZm9yIGNvbXBvc2l0ZSBjb21wb25lbnRzKSAiICsgKCJidXQgZ290OiAiICsgKHR5cGUgPT0gbnVsbCA/IHR5cGUgOiB0eXBlb2YgdHlwZSkgKyAiLiIgKyBpbmZvKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihmaWJlclRhZywgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSB0eXBlOwogICAgICAgICAgZmliZXIudHlwZSA9IHJlc29sdmVkVHlwZTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICB7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gb3duZXI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbUVsZW1lbnQoZWxlbWVudCwgbW9kZSwgbGFuZXMpIHsKICAgICAgICAgIHZhciBvd25lciA9IG51bGw7CiAgICAgICAgICB7CiAgICAgICAgICAgIG93bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgIHZhciBrZXkgPSBlbGVtZW50LmtleTsKICAgICAgICAgIHZhciBwZW5kaW5nUHJvcHMgPSBlbGVtZW50LnByb3BzOwogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXJGcm9tVHlwZUFuZFByb3BzKHR5cGUsIGtleSwgcGVuZGluZ1Byb3BzLCBvd25lciwgbW9kZSwgbGFuZXMpOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlci5fZGVidWdTb3VyY2UgPSBlbGVtZW50Ll9zb3VyY2U7CiAgICAgICAgICAgIGZpYmVyLl9kZWJ1Z093bmVyID0gZWxlbWVudC5fb3duZXI7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbUZyYWdtZW50KGVsZW1lbnRzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihGcmFnbWVudDksIGVsZW1lbnRzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tUHJvZmlsZXIocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcGVuZGluZ1Byb3BzLmlkICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgIGVycm9yKCdQcm9maWxlciBtdXN0IHNwZWNpZnkgYW4gImlkIiBvZiB0eXBlIGBzdHJpbmdgIGFzIGEgcHJvcC4gUmVjZWl2ZWQgdGhlIHR5cGUgYCVzYCBpbnN0ZWFkLicsIHR5cGVvZiBwZW5kaW5nUHJvcHMuaWQpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihQcm9maWxlciwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUgfCBQcm9maWxlTW9kZSk7CiAgICAgICAgICBmaWJlci5lbGVtZW50VHlwZSA9IFJFQUNUX1BST0ZJTEVSX1RZUEU7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgewogICAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSB7CiAgICAgICAgICAgICAgZWZmZWN0RHVyYXRpb246IDAsCiAgICAgICAgICAgICAgcGFzc2l2ZUVmZmVjdER1cmF0aW9uOiAwCiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVN1c3BlbnNlKHBlbmRpbmdQcm9wcywgbW9kZSwgbGFuZXMsIGtleSkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoU3VzcGVuc2VDb21wb25lbnQsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gUkVBQ1RfU1VTUEVOU0VfVFlQRTsKICAgICAgICAgIGZpYmVyLmxhbmVzID0gbGFuZXM7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVN1c3BlbnNlTGlzdChwZW5kaW5nUHJvcHMsIG1vZGUsIGxhbmVzLCBrZXkpIHsKICAgICAgICAgIHZhciBmaWJlciA9IGNyZWF0ZUZpYmVyKFN1c3BlbnNlTGlzdENvbXBvbmVudCwgcGVuZGluZ1Byb3BzLCBrZXksIG1vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEU7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgcmV0dXJuIGZpYmVyOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlckZyb21PZmZzY3JlZW4ocGVuZGluZ1Byb3BzLCBtb2RlLCBsYW5lcywga2V5KSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihPZmZzY3JlZW5Db21wb25lbnQsIHBlbmRpbmdQcm9wcywga2V5LCBtb2RlKTsKICAgICAgICAgIGZpYmVyLmVsZW1lbnRUeXBlID0gUkVBQ1RfT0ZGU0NSRUVOX1RZUEU7CiAgICAgICAgICBmaWJlci5sYW5lcyA9IGxhbmVzOwogICAgICAgICAgdmFyIHByaW1hcnlDaGlsZEluc3RhbmNlID0gewogICAgICAgICAgICBpc0hpZGRlbjogZmFsc2UKICAgICAgICAgIH07CiAgICAgICAgICBmaWJlci5zdGF0ZU5vZGUgPSBwcmltYXJ5Q2hpbGRJbnN0YW5jZTsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tVGV4dChjb250ZW50LCBtb2RlLCBsYW5lcykgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoSG9zdFRleHQsIGNvbnRlbnQsIG51bGwsIG1vZGUpOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlRmliZXJGcm9tSG9zdEluc3RhbmNlRm9yRGVsZXRpb24oKSB7CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0Q29tcG9uZW50LCBudWxsLCBudWxsLCBOb01vZGUpOwogICAgICAgICAgZmliZXIuZWxlbWVudFR5cGUgPSAiREVMRVRFRCI7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbURlaHlkcmF0ZWRGcmFnbWVudChkZWh5ZHJhdGVkTm9kZSkgewogICAgICAgICAgdmFyIGZpYmVyID0gY3JlYXRlRmliZXIoRGVoeWRyYXRlZEZyYWdtZW50LCBudWxsLCBudWxsLCBOb01vZGUpOwogICAgICAgICAgZmliZXIuc3RhdGVOb2RlID0gZGVoeWRyYXRlZE5vZGU7CiAgICAgICAgICByZXR1cm4gZmliZXI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZUZpYmVyRnJvbVBvcnRhbChwb3J0YWwsIG1vZGUsIGxhbmVzKSB7CiAgICAgICAgICB2YXIgcGVuZGluZ1Byb3BzID0gcG9ydGFsLmNoaWxkcmVuICE9PSBudWxsID8gcG9ydGFsLmNoaWxkcmVuIDogW107CiAgICAgICAgICB2YXIgZmliZXIgPSBjcmVhdGVGaWJlcihIb3N0UG9ydGFsLCBwZW5kaW5nUHJvcHMsIHBvcnRhbC5rZXksIG1vZGUpOwogICAgICAgICAgZmliZXIubGFuZXMgPSBsYW5lczsKICAgICAgICAgIGZpYmVyLnN0YXRlTm9kZSA9IHsKICAgICAgICAgICAgY29udGFpbmVySW5mbzogcG9ydGFsLmNvbnRhaW5lckluZm8sCiAgICAgICAgICAgIHBlbmRpbmdDaGlsZHJlbjogbnVsbCwKICAgICAgICAgICAgLy8gVXNlZCBieSBwZXJzaXN0ZW50IHVwZGF0ZXMKICAgICAgICAgICAgaW1wbGVtZW50YXRpb246IHBvcnRhbC5pbXBsZW1lbnRhdGlvbgogICAgICAgICAgfTsKICAgICAgICAgIHJldHVybiBmaWJlcjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXNzaWduRmliZXJQcm9wZXJ0aWVzSW5ERVYodGFyZ2V0LCBzb3VyY2UpIHsKICAgICAgICAgIGlmICh0YXJnZXQgPT09IG51bGwpIHsKICAgICAgICAgICAgdGFyZ2V0ID0gY3JlYXRlRmliZXIoSW5kZXRlcm1pbmF0ZUNvbXBvbmVudCwgbnVsbCwgbnVsbCwgTm9Nb2RlKTsKICAgICAgICAgIH0KICAgICAgICAgIHRhcmdldC50YWcgPSBzb3VyY2UudGFnOwogICAgICAgICAgdGFyZ2V0LmtleSA9IHNvdXJjZS5rZXk7CiAgICAgICAgICB0YXJnZXQuZWxlbWVudFR5cGUgPSBzb3VyY2UuZWxlbWVudFR5cGU7CiAgICAgICAgICB0YXJnZXQudHlwZSA9IHNvdXJjZS50eXBlOwogICAgICAgICAgdGFyZ2V0LnN0YXRlTm9kZSA9IHNvdXJjZS5zdGF0ZU5vZGU7CiAgICAgICAgICB0YXJnZXQucmV0dXJuID0gc291cmNlLnJldHVybjsKICAgICAgICAgIHRhcmdldC5jaGlsZCA9IHNvdXJjZS5jaGlsZDsKICAgICAgICAgIHRhcmdldC5zaWJsaW5nID0gc291cmNlLnNpYmxpbmc7CiAgICAgICAgICB0YXJnZXQuaW5kZXggPSBzb3VyY2UuaW5kZXg7CiAgICAgICAgICB0YXJnZXQucmVmID0gc291cmNlLnJlZjsKICAgICAgICAgIHRhcmdldC5wZW5kaW5nUHJvcHMgPSBzb3VyY2UucGVuZGluZ1Byb3BzOwogICAgICAgICAgdGFyZ2V0Lm1lbW9pemVkUHJvcHMgPSBzb3VyY2UubWVtb2l6ZWRQcm9wczsKICAgICAgICAgIHRhcmdldC51cGRhdGVRdWV1ZSA9IHNvdXJjZS51cGRhdGVRdWV1ZTsKICAgICAgICAgIHRhcmdldC5tZW1vaXplZFN0YXRlID0gc291cmNlLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICB0YXJnZXQuZGVwZW5kZW5jaWVzID0gc291cmNlLmRlcGVuZGVuY2llczsKICAgICAgICAgIHRhcmdldC5tb2RlID0gc291cmNlLm1vZGU7CiAgICAgICAgICB0YXJnZXQuZmxhZ3MgPSBzb3VyY2UuZmxhZ3M7CiAgICAgICAgICB0YXJnZXQuc3VidHJlZUZsYWdzID0gc291cmNlLnN1YnRyZWVGbGFnczsKICAgICAgICAgIHRhcmdldC5kZWxldGlvbnMgPSBzb3VyY2UuZGVsZXRpb25zOwogICAgICAgICAgdGFyZ2V0LmxhbmVzID0gc291cmNlLmxhbmVzOwogICAgICAgICAgdGFyZ2V0LmNoaWxkTGFuZXMgPSBzb3VyY2UuY2hpbGRMYW5lczsKICAgICAgICAgIHRhcmdldC5hbHRlcm5hdGUgPSBzb3VyY2UuYWx0ZXJuYXRlOwogICAgICAgICAgewogICAgICAgICAgICB0YXJnZXQuYWN0dWFsRHVyYXRpb24gPSBzb3VyY2UuYWN0dWFsRHVyYXRpb247CiAgICAgICAgICAgIHRhcmdldC5hY3R1YWxTdGFydFRpbWUgPSBzb3VyY2UuYWN0dWFsU3RhcnRUaW1lOwogICAgICAgICAgICB0YXJnZXQuc2VsZkJhc2VEdXJhdGlvbiA9IHNvdXJjZS5zZWxmQmFzZUR1cmF0aW9uOwogICAgICAgICAgICB0YXJnZXQudHJlZUJhc2VEdXJhdGlvbiA9IHNvdXJjZS50cmVlQmFzZUR1cmF0aW9uOwogICAgICAgICAgfQogICAgICAgICAgdGFyZ2V0Ll9kZWJ1Z1NvdXJjZSA9IHNvdXJjZS5fZGVidWdTb3VyY2U7CiAgICAgICAgICB0YXJnZXQuX2RlYnVnT3duZXIgPSBzb3VyY2UuX2RlYnVnT3duZXI7CiAgICAgICAgICB0YXJnZXQuX2RlYnVnTmVlZHNSZW1vdW50ID0gc291cmNlLl9kZWJ1Z05lZWRzUmVtb3VudDsKICAgICAgICAgIHRhcmdldC5fZGVidWdIb29rVHlwZXMgPSBzb3VyY2UuX2RlYnVnSG9va1R5cGVzOwogICAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gRmliZXJSb290Tm9kZShjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpIHsKICAgICAgICAgIHRoaXMudGFnID0gdGFnOwogICAgICAgICAgdGhpcy5jb250YWluZXJJbmZvID0gY29udGFpbmVySW5mbzsKICAgICAgICAgIHRoaXMucGVuZGluZ0NoaWxkcmVuID0gbnVsbDsKICAgICAgICAgIHRoaXMuY3VycmVudCA9IG51bGw7CiAgICAgICAgICB0aGlzLnBpbmdDYWNoZSA9IG51bGw7CiAgICAgICAgICB0aGlzLmZpbmlzaGVkV29yayA9IG51bGw7CiAgICAgICAgICB0aGlzLnRpbWVvdXRIYW5kbGUgPSBub1RpbWVvdXQ7CiAgICAgICAgICB0aGlzLmNvbnRleHQgPSBudWxsOwogICAgICAgICAgdGhpcy5wZW5kaW5nQ29udGV4dCA9IG51bGw7CiAgICAgICAgICB0aGlzLmNhbGxiYWNrTm9kZSA9IG51bGw7CiAgICAgICAgICB0aGlzLmNhbGxiYWNrUHJpb3JpdHkgPSBOb0xhbmU7CiAgICAgICAgICB0aGlzLmV2ZW50VGltZXMgPSBjcmVhdGVMYW5lTWFwKE5vTGFuZXMpOwogICAgICAgICAgdGhpcy5leHBpcmF0aW9uVGltZXMgPSBjcmVhdGVMYW5lTWFwKE5vVGltZXN0YW1wKTsKICAgICAgICAgIHRoaXMucGVuZGluZ0xhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuc3VzcGVuZGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5waW5nZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLmV4cGlyZWRMYW5lcyA9IE5vTGFuZXM7CiAgICAgICAgICB0aGlzLm11dGFibGVSZWFkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5maW5pc2hlZExhbmVzID0gTm9MYW5lczsKICAgICAgICAgIHRoaXMuZW50YW5nbGVkTGFuZXMgPSBOb0xhbmVzOwogICAgICAgICAgdGhpcy5lbnRhbmdsZW1lbnRzID0gY3JlYXRlTGFuZU1hcChOb0xhbmVzKTsKICAgICAgICAgIHRoaXMuaWRlbnRpZmllclByZWZpeCA9IGlkZW50aWZpZXJQcmVmaXg7CiAgICAgICAgICB0aGlzLm9uUmVjb3ZlcmFibGVFcnJvciA9IG9uUmVjb3ZlcmFibGVFcnJvcjsKICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tdXRhYmxlU291cmNlRWFnZXJIeWRyYXRpb25EYXRhID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5lZmZlY3REdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMucGFzc2l2ZUVmZmVjdER1cmF0aW9uID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tZW1vaXplZFVwZGF0ZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICAgICAgdmFyIHBlbmRpbmdVcGRhdGVyc0xhbmVNYXAgPSB0aGlzLnBlbmRpbmdVcGRhdGVyc0xhbmVNYXAgPSBbXTsKICAgICAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IFRvdGFsTGFuZXM7IF9pKyspIHsKICAgICAgICAgICAgICBwZW5kaW5nVXBkYXRlcnNMYW5lTWFwLnB1c2goLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgc3dpdGNoICh0YWcpIHsKICAgICAgICAgICAgICBjYXNlIENvbmN1cnJlbnRSb290OgogICAgICAgICAgICAgICAgdGhpcy5fZGVidWdSb290VHlwZSA9IGh5ZHJhdGUyID8gImh5ZHJhdGVSb290KCkiIDogImNyZWF0ZVJvb3QoKSI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICBjYXNlIExlZ2FjeVJvb3Q6CiAgICAgICAgICAgICAgICB0aGlzLl9kZWJ1Z1Jvb3RUeXBlID0gaHlkcmF0ZTIgPyAiaHlkcmF0ZSgpIiA6ICJyZW5kZXIoKSI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVGaWJlclJvb3QoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRlMiwgaW5pdGlhbENoaWxkcmVuLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yLCB0cmFuc2l0aW9uQ2FsbGJhY2tzKSB7CiAgICAgICAgICB2YXIgcm9vdDMgPSBuZXcgRmliZXJSb290Tm9kZShjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgICAgdmFyIHVuaW5pdGlhbGl6ZWRGaWJlciA9IGNyZWF0ZUhvc3RSb290RmliZXIodGFnLCBpc1N0cmljdE1vZGUpOwogICAgICAgICAgcm9vdDMuY3VycmVudCA9IHVuaW5pdGlhbGl6ZWRGaWJlcjsKICAgICAgICAgIHVuaW5pdGlhbGl6ZWRGaWJlci5zdGF0ZU5vZGUgPSByb290MzsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIF9pbml0aWFsU3RhdGUgPSB7CiAgICAgICAgICAgICAgZWxlbWVudDogaW5pdGlhbENoaWxkcmVuLAogICAgICAgICAgICAgIGlzRGVoeWRyYXRlZDogaHlkcmF0ZTIsCiAgICAgICAgICAgICAgY2FjaGU6IG51bGwsCiAgICAgICAgICAgICAgLy8gbm90IGVuYWJsZWQgeWV0CiAgICAgICAgICAgICAgdHJhbnNpdGlvbnM6IG51bGwsCiAgICAgICAgICAgICAgcGVuZGluZ1N1c3BlbnNlQm91bmRhcmllczogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgICB1bmluaXRpYWxpemVkRmliZXIubWVtb2l6ZWRTdGF0ZSA9IF9pbml0aWFsU3RhdGU7CiAgICAgICAgICB9CiAgICAgICAgICBpbml0aWFsaXplVXBkYXRlUXVldWUodW5pbml0aWFsaXplZEZpYmVyKTsKICAgICAgICAgIHJldHVybiByb290MzsKICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0VmVyc2lvbiA9ICIxOC4zLjEiOwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVBvcnRhbDMoY2hpbGRyZW4sIGNvbnRhaW5lckluZm8sIGltcGxlbWVudGF0aW9uKSB7CiAgICAgICAgICB2YXIga2V5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbM10gOiBudWxsOwogICAgICAgICAgewogICAgICAgICAgICBjaGVja0tleVN0cmluZ0NvZXJjaW9uKGtleSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAvLyBUaGlzIHRhZyBhbGxvdyB1cyB0byB1bmlxdWVseSBpZGVudGlmeSB0aGlzIGFzIGEgUmVhY3QgUG9ydGFsCiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9QT1JUQUxfVFlQRSwKICAgICAgICAgICAga2V5OiBrZXkgPT0gbnVsbCA/IG51bGwgOiAiIiArIGtleSwKICAgICAgICAgICAgY2hpbGRyZW4sCiAgICAgICAgICAgIGNvbnRhaW5lckluZm8sCiAgICAgICAgICAgIGltcGxlbWVudGF0aW9uCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB2YXIgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlczsKICAgICAgICB2YXIgZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGU7CiAgICAgICAgewogICAgICAgICAgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcyA9IGZhbHNlOwogICAgICAgICAgZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGUgPSB7fTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dEZvclN1YnRyZWUocGFyZW50Q29tcG9uZW50KSB7CiAgICAgICAgICBpZiAoIXBhcmVudENvbXBvbmVudCkgewogICAgICAgICAgICByZXR1cm4gZW1wdHlDb250ZXh0T2JqZWN0OwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZpYmVyID0gZ2V0NihwYXJlbnRDb21wb25lbnQpOwogICAgICAgICAgdmFyIHBhcmVudENvbnRleHQgPSBmaW5kQ3VycmVudFVubWFza2VkQ29udGV4dChmaWJlcik7CiAgICAgICAgICBpZiAoZmliZXIudGFnID09PSBDbGFzc0NvbXBvbmVudCkgewogICAgICAgICAgICB2YXIgQ29tcG9uZW50ID0gZmliZXIudHlwZTsKICAgICAgICAgICAgaWYgKGlzQ29udGV4dFByb3ZpZGVyKENvbXBvbmVudCkpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJvY2Vzc0NoaWxkQ29udGV4dChmaWJlciwgQ29tcG9uZW50LCBwYXJlbnRDb250ZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHBhcmVudENvbnRleHQ7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VXaXRoV2FybmluZyhjb21wb25lbnQsIG1ldGhvZE5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZpYmVyID0gZ2V0Nihjb21wb25lbnQpOwogICAgICAgICAgICBpZiAoZmliZXIgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgY29tcG9uZW50LnJlbmRlciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gZmluZCBub2RlIG9uIGFuIHVubW91bnRlZCBjb21wb25lbnQuIik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoY29tcG9uZW50KS5qb2luKCIsIik7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkFyZ3VtZW50IGFwcGVhcnMgdG8gbm90IGJlIGEgUmVhY3RDb21wb25lbnQuIEtleXM6ICIgKyBrZXlzKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGhvc3RGaWJlciA9IGZpbmRDdXJyZW50SG9zdEZpYmVyKGZpYmVyKTsKICAgICAgICAgICAgaWYgKGhvc3RGaWJlciA9PT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChob3N0RmliZXIubW9kZSAmIFN0cmljdExlZ2FjeU1vZGUpIHsKICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tRmliZXIoZmliZXIpIHx8ICJDb21wb25lbnQiOwogICAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RmluZE5vZGVJblN0cmljdE1vZGVbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGRpZFdhcm5BYm91dEZpbmROb2RlSW5TdHJpY3RNb2RlW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c0ZpYmVyID0gY3VycmVudDM7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50RmliZXIoaG9zdEZpYmVyKTsKICAgICAgICAgICAgICAgICAgaWYgKGZpYmVyLm1vZGUgJiBTdHJpY3RMZWdhY3lNb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzIGlzIGRlcHJlY2F0ZWQgaW4gU3RyaWN0TW9kZS4gJXMgd2FzIHBhc3NlZCBhbiBpbnN0YW5jZSBvZiAlcyB3aGljaCBpcyBpbnNpZGUgU3RyaWN0TW9kZS4gSW5zdGVhZCwgYWRkIGEgcmVmIGRpcmVjdGx5IHRvIHRoZSBlbGVtZW50IHlvdSB3YW50IHRvIHJlZmVyZW5jZS4gTGVhcm4gbW9yZSBhYm91dCB1c2luZyByZWZzIHNhZmVseSBoZXJlOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3RyaWN0LW1vZGUtZmluZC1ub2RlIiwgbWV0aG9kTmFtZSwgbWV0aG9kTmFtZSwgY29tcG9uZW50TmFtZSk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzIGlzIGRlcHJlY2F0ZWQgaW4gU3RyaWN0TW9kZS4gJXMgd2FzIHBhc3NlZCBhbiBpbnN0YW5jZSBvZiAlcyB3aGljaCByZW5kZXJzIFN0cmljdE1vZGUgY2hpbGRyZW4uIEluc3RlYWQsIGFkZCBhIHJlZiBkaXJlY3RseSB0byB0aGUgZWxlbWVudCB5b3Ugd2FudCB0byByZWZlcmVuY2UuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLWZpbmQtbm9kZSIsIG1ldGhvZE5hbWUsIG1ldGhvZE5hbWUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNGaWJlcikgewogICAgICAgICAgICAgICAgICAgIHNldEN1cnJlbnRGaWJlcihwcmV2aW91c0ZpYmVyKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXNldEN1cnJlbnRGaWJlcigpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBob3N0RmliZXIuc3RhdGVOb2RlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVDb250YWluZXIoY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yLCB0cmFuc2l0aW9uQ2FsbGJhY2tzKSB7CiAgICAgICAgICB2YXIgaHlkcmF0ZTIgPSBmYWxzZTsKICAgICAgICAgIHZhciBpbml0aWFsQ2hpbGRyZW4gPSBudWxsOwogICAgICAgICAgcmV0dXJuIGNyZWF0ZUZpYmVyUm9vdChjb250YWluZXJJbmZvLCB0YWcsIGh5ZHJhdGUyLCBpbml0aWFsQ2hpbGRyZW4sIGh5ZHJhdGlvbkNhbGxiYWNrcywgaXNTdHJpY3RNb2RlLCBjb25jdXJyZW50VXBkYXRlc0J5RGVmYXVsdE92ZXJyaWRlLCBpZGVudGlmaWVyUHJlZml4LCBvblJlY292ZXJhYmxlRXJyb3IpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjcmVhdGVIeWRyYXRpb25Db250YWluZXIoaW5pdGlhbENoaWxkcmVuLCBjYWxsYmFjaywgY29udGFpbmVySW5mbywgdGFnLCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yLCB0cmFuc2l0aW9uQ2FsbGJhY2tzKSB7CiAgICAgICAgICB2YXIgaHlkcmF0ZTIgPSB0cnVlOwogICAgICAgICAgdmFyIHJvb3QzID0gY3JlYXRlRmliZXJSb290KGNvbnRhaW5lckluZm8sIHRhZywgaHlkcmF0ZTIsIGluaXRpYWxDaGlsZHJlbiwgaHlkcmF0aW9uQ2FsbGJhY2tzLCBpc1N0cmljdE1vZGUsIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsIGlkZW50aWZpZXJQcmVmaXgsIG9uUmVjb3ZlcmFibGVFcnJvcik7CiAgICAgICAgICByb290My5jb250ZXh0ID0gZ2V0Q29udGV4dEZvclN1YnRyZWUobnVsbCk7CiAgICAgICAgICB2YXIgY3VycmVudDQgPSByb290My5jdXJyZW50OwogICAgICAgICAgdmFyIGV2ZW50VGltZSA9IHJlcXVlc3RFdmVudFRpbWUoKTsKICAgICAgICAgIHZhciBsYW5lID0gcmVxdWVzdFVwZGF0ZUxhbmUoY3VycmVudDQpOwogICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgdXBkYXRlLmNhbGxiYWNrID0gY2FsbGJhY2sgIT09IHZvaWQgMCAmJiBjYWxsYmFjayAhPT0gbnVsbCA/IGNhbGxiYWNrIDogbnVsbDsKICAgICAgICAgIGVucXVldWVVcGRhdGUoY3VycmVudDQsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICBzY2hlZHVsZUluaXRpYWxIeWRyYXRpb25PblJvb3Qocm9vdDMsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICByZXR1cm4gcm9vdDM7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUNvbnRhaW5lcihlbGVtZW50LCBjb250YWluZXIyLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIG9uU2NoZWR1bGVSb290KGNvbnRhaW5lcjIsIGVsZW1lbnQpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGN1cnJlbnQkMSA9IGNvbnRhaW5lcjIuY3VycmVudDsKICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICB2YXIgbGFuZSA9IHJlcXVlc3RVcGRhdGVMYW5lKGN1cnJlbnQkMSk7CiAgICAgICAgICB7CiAgICAgICAgICAgIG1hcmtSZW5kZXJTY2hlZHVsZWQobGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgY29udGV4dCA9IGdldENvbnRleHRGb3JTdWJ0cmVlKHBhcmVudENvbXBvbmVudCk7CiAgICAgICAgICBpZiAoY29udGFpbmVyMi5jb250ZXh0ID09PSBudWxsKSB7CiAgICAgICAgICAgIGNvbnRhaW5lcjIuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250YWluZXIyLnBlbmRpbmdDb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGlzUmVuZGVyaW5nICYmIGN1cnJlbnQzICE9PSBudWxsICYmICFkaWRXYXJuQWJvdXROZXN0ZWRVcGRhdGVzKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0TmVzdGVkVXBkYXRlcyA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoIlJlbmRlciBtZXRob2RzIHNob3VsZCBiZSBhIHB1cmUgZnVuY3Rpb24gb2YgcHJvcHMgYW5kIHN0YXRlOyB0cmlnZ2VyaW5nIG5lc3RlZCBjb21wb25lbnQgdXBkYXRlcyBmcm9tIHJlbmRlciBpcyBub3QgYWxsb3dlZC4gSWYgbmVjZXNzYXJ5LCB0cmlnZ2VyIG5lc3RlZCB1cGRhdGVzIGluIGNvbXBvbmVudERpZFVwZGF0ZS5cblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgJXMuIiwgZ2V0Q29tcG9uZW50TmFtZUZyb21GaWJlcihjdXJyZW50MykgfHwgIlVua25vd24iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHVwZGF0ZSA9IGNyZWF0ZVVwZGF0ZShldmVudFRpbWUsIGxhbmUpOwogICAgICAgICAgdXBkYXRlLnBheWxvYWQgPSB7CiAgICAgICAgICAgIGVsZW1lbnQKICAgICAgICAgIH07CiAgICAgICAgICBjYWxsYmFjayA9IGNhbGxiYWNrID09PSB2b2lkIDAgPyBudWxsIDogY2FsbGJhY2s7CiAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogRXhwZWN0ZWQgdGhlIGxhc3Qgb3B0aW9uYWwgYGNhbGxiYWNrYCBhcmd1bWVudCB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkIHJlY2VpdmVkOiAlcy4iLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHVwZGF0ZS5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZVVwZGF0ZShjdXJyZW50JDEsIHVwZGF0ZSwgbGFuZSk7CiAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgc2NoZWR1bGVVcGRhdGVPbkZpYmVyKHJvb3QzLCBjdXJyZW50JDEsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICAgIGVudGFuZ2xlVHJhbnNpdGlvbnMocm9vdDMsIGN1cnJlbnQkMSwgbGFuZSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbGFuZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0UHVibGljUm9vdEluc3RhbmNlKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHZhciBjb250YWluZXJGaWJlciA9IGNvbnRhaW5lcjIuY3VycmVudDsKICAgICAgICAgIGlmICghY29udGFpbmVyRmliZXIuY2hpbGQpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBzd2l0Y2ggKGNvbnRhaW5lckZpYmVyLmNoaWxkLnRhZykgewogICAgICAgICAgICBjYXNlIEhvc3RDb21wb25lbnQ6CiAgICAgICAgICAgICAgcmV0dXJuIGdldFB1YmxpY0luc3RhbmNlKGNvbnRhaW5lckZpYmVyLmNoaWxkLnN0YXRlTm9kZSk7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lckZpYmVyLmNoaWxkLnN0YXRlTm9kZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uJDEoZmliZXIpIHsKICAgICAgICAgIHN3aXRjaCAoZmliZXIudGFnKSB7CiAgICAgICAgICAgIGNhc2UgSG9zdFJvb3Q6IHsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBmaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgICAgICAgaWYgKGlzUm9vdERlaHlkcmF0ZWQocm9vdDMpKSB7CiAgICAgICAgICAgICAgICB2YXIgbGFuZXMgPSBnZXRIaWdoZXN0UHJpb3JpdHlQZW5kaW5nTGFuZXMocm9vdDMpOwogICAgICAgICAgICAgICAgZmx1c2hSb290KHJvb3QzLCBsYW5lcyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhc2UgU3VzcGVuc2VDb21wb25lbnQ6IHsKICAgICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgcm9vdDQgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICAgIGlmIChyb290NCAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDQsIGZpYmVyLCBTeW5jTGFuZSwgZXZlbnRUaW1lKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB2YXIgcmV0cnlMYW5lID0gU3luY0xhbmU7CiAgICAgICAgICAgICAgbWFya1JldHJ5TGFuZUlmTm90SHlkcmF0ZWQoZmliZXIsIHJldHJ5TGFuZSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbWFya1JldHJ5TGFuZUltcGwoZmliZXIsIHJldHJ5TGFuZSkgewogICAgICAgICAgdmFyIHN1c3BlbnNlU3RhdGUgPSBmaWJlci5tZW1vaXplZFN0YXRlOwogICAgICAgICAgaWYgKHN1c3BlbnNlU3RhdGUgIT09IG51bGwgJiYgc3VzcGVuc2VTdGF0ZS5kZWh5ZHJhdGVkICE9PSBudWxsKSB7CiAgICAgICAgICAgIHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lID0gaGlnaGVyUHJpb3JpdHlMYW5lKHN1c3BlbnNlU3RhdGUucmV0cnlMYW5lLCByZXRyeUxhbmUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgcmV0cnlMYW5lKSB7CiAgICAgICAgICBtYXJrUmV0cnlMYW5lSW1wbChmaWJlciwgcmV0cnlMYW5lKTsKICAgICAgICAgIHZhciBhbHRlcm5hdGUgPSBmaWJlci5hbHRlcm5hdGU7CiAgICAgICAgICBpZiAoYWx0ZXJuYXRlKSB7CiAgICAgICAgICAgIG1hcmtSZXRyeUxhbmVJbXBsKGFsdGVybmF0ZSwgcmV0cnlMYW5lKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gYXR0ZW1wdENvbnRpbnVvdXNIeWRyYXRpb24kMShmaWJlcikgewogICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhbmUgPSBTZWxlY3RpdmVIeWRyYXRpb25MYW5lOwogICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBsYW5lKTsKICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICB2YXIgZXZlbnRUaW1lID0gcmVxdWVzdEV2ZW50VGltZSgpOwogICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBsYW5lLCBldmVudFRpbWUpOwogICAgICAgICAgfQogICAgICAgICAgbWFya1JldHJ5TGFuZUlmTm90SHlkcmF0ZWQoZmliZXIsIGxhbmUpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBhdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkkMShmaWJlcikgewogICAgICAgICAgaWYgKGZpYmVyLnRhZyAhPT0gU3VzcGVuc2VDb21wb25lbnQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGxhbmUgPSByZXF1ZXN0VXBkYXRlTGFuZShmaWJlcik7CiAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIGxhbmUpOwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHZhciBldmVudFRpbWUgPSByZXF1ZXN0RXZlbnRUaW1lKCk7CiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIGxhbmUsIGV2ZW50VGltZSk7CiAgICAgICAgICB9CiAgICAgICAgICBtYXJrUmV0cnlMYW5lSWZOb3RIeWRyYXRlZChmaWJlciwgbGFuZSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZpbmRIb3N0SW5zdGFuY2VXaXRoTm9Qb3J0YWxzKGZpYmVyKSB7CiAgICAgICAgICB2YXIgaG9zdEZpYmVyID0gZmluZEN1cnJlbnRIb3N0RmliZXJXaXRoTm9Qb3J0YWxzKGZpYmVyKTsKICAgICAgICAgIGlmIChob3N0RmliZXIgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaG9zdEZpYmVyLnN0YXRlTm9kZTsKICAgICAgICB9CiAgICAgICAgdmFyIHNob3VsZEVycm9ySW1wbCA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNob3VsZEVycm9yKGZpYmVyKSB7CiAgICAgICAgICByZXR1cm4gc2hvdWxkRXJyb3JJbXBsKGZpYmVyKTsKICAgICAgICB9CiAgICAgICAgdmFyIHNob3VsZFN1c3BlbmRJbXBsID0gZnVuY3Rpb24oZmliZXIpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIHNob3VsZFN1c3BlbmQoZmliZXIpIHsKICAgICAgICAgIHJldHVybiBzaG91bGRTdXNwZW5kSW1wbChmaWJlcik7CiAgICAgICAgfQogICAgICAgIHZhciBvdmVycmlkZUhvb2tTdGF0ZSA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlSG9va1N0YXRlRGVsZXRlUGF0aCA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlSG9va1N0YXRlUmVuYW1lUGF0aCA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlUHJvcHMgPSBudWxsOwogICAgICAgIHZhciBvdmVycmlkZVByb3BzRGVsZXRlUGF0aCA9IG51bGw7CiAgICAgICAgdmFyIG92ZXJyaWRlUHJvcHNSZW5hbWVQYXRoID0gbnVsbDsKICAgICAgICB2YXIgc2NoZWR1bGVVcGRhdGUgPSBudWxsOwogICAgICAgIHZhciBzZXRFcnJvckhhbmRsZXIgPSBudWxsOwogICAgICAgIHZhciBzZXRTdXNwZW5zZUhhbmRsZXIgPSBudWxsOwogICAgICAgIHsKICAgICAgICAgIHZhciBjb3B5V2l0aERlbGV0ZUltcGwgPSBmdW5jdGlvbihvYmosIHBhdGgyLCBpbmRleDIpIHsKICAgICAgICAgICAgdmFyIGtleSA9IHBhdGgyW2luZGV4Ml07CiAgICAgICAgICAgIHZhciB1cGRhdGVkID0gaXNBcnJheTIob2JqKSA/IG9iai5zbGljZSgpIDogYXNzaWduMih7fSwgb2JqKTsKICAgICAgICAgICAgaWYgKGluZGV4MiArIDEgPT09IHBhdGgyLmxlbmd0aCkgewogICAgICAgICAgICAgIGlmIChpc0FycmF5Mih1cGRhdGVkKSkgewogICAgICAgICAgICAgICAgdXBkYXRlZC5zcGxpY2Uoa2V5LCAxKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZGVsZXRlIHVwZGF0ZWRba2V5XTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlZFtrZXldID0gY29weVdpdGhEZWxldGVJbXBsKG9ialtrZXldLCBwYXRoMiwgaW5kZXgyICsgMSk7CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkOwogICAgICAgICAgfTsKICAgICAgICAgIHZhciBjb3B5V2l0aERlbGV0ZSA9IGZ1bmN0aW9uKG9iaiwgcGF0aDIpIHsKICAgICAgICAgICAgcmV0dXJuIGNvcHlXaXRoRGVsZXRlSW1wbChvYmosIHBhdGgyLCAwKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhSZW5hbWVJbXBsID0gZnVuY3Rpb24ob2JqLCBvbGRQYXRoLCBuZXdQYXRoLCBpbmRleDIpIHsKICAgICAgICAgICAgdmFyIG9sZEtleSA9IG9sZFBhdGhbaW5kZXgyXTsKICAgICAgICAgICAgdmFyIHVwZGF0ZWQgPSBpc0FycmF5MihvYmopID8gb2JqLnNsaWNlKCkgOiBhc3NpZ24yKHt9LCBvYmopOwogICAgICAgICAgICBpZiAoaW5kZXgyICsgMSA9PT0gb2xkUGF0aC5sZW5ndGgpIHsKICAgICAgICAgICAgICB2YXIgbmV3S2V5ID0gbmV3UGF0aFtpbmRleDJdOwogICAgICAgICAgICAgIHVwZGF0ZWRbbmV3S2V5XSA9IHVwZGF0ZWRbb2xkS2V5XTsKICAgICAgICAgICAgICBpZiAoaXNBcnJheTIodXBkYXRlZCkpIHsKICAgICAgICAgICAgICAgIHVwZGF0ZWQuc3BsaWNlKG9sZEtleSwgMSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSB1cGRhdGVkW29sZEtleV07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHVwZGF0ZWRbb2xkS2V5XSA9IGNvcHlXaXRoUmVuYW1lSW1wbCgKICAgICAgICAgICAgICAgIC8vICRGbG93Rml4TWUgbnVtYmVyIG9yIHN0cmluZyBpcyBmaW5lIGhlcmUKICAgICAgICAgICAgICAgIG9ialtvbGRLZXldLAogICAgICAgICAgICAgICAgb2xkUGF0aCwKICAgICAgICAgICAgICAgIG5ld1BhdGgsCiAgICAgICAgICAgICAgICBpbmRleDIgKyAxCiAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhSZW5hbWUgPSBmdW5jdGlvbihvYmosIG9sZFBhdGgsIG5ld1BhdGgpIHsKICAgICAgICAgICAgaWYgKG9sZFBhdGgubGVuZ3RoICE9PSBuZXdQYXRoLmxlbmd0aCkgewogICAgICAgICAgICAgIHdhcm4zKCJjb3B5V2l0aFJlbmFtZSgpIGV4cGVjdHMgcGF0aHMgb2YgdGhlIHNhbWUgbGVuZ3RoIik7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbmV3UGF0aC5sZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChvbGRQYXRoW2ldICE9PSBuZXdQYXRoW2ldKSB7CiAgICAgICAgICAgICAgICAgIHdhcm4zKCJjb3B5V2l0aFJlbmFtZSgpIGV4cGVjdHMgcGF0aHMgdG8gYmUgdGhlIHNhbWUgZXhjZXB0IGZvciB0aGUgZGVlcGVzdCBrZXkiKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY29weVdpdGhSZW5hbWVJbXBsKG9iaiwgb2xkUGF0aCwgbmV3UGF0aCwgMCk7CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGNvcHlXaXRoU2V0SW1wbCA9IGZ1bmN0aW9uKG9iaiwgcGF0aDIsIGluZGV4MiwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKGluZGV4MiA+PSBwYXRoMi5sZW5ndGgpIHsKICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGtleSA9IHBhdGgyW2luZGV4Ml07CiAgICAgICAgICAgIHZhciB1cGRhdGVkID0gaXNBcnJheTIob2JqKSA/IG9iai5zbGljZSgpIDogYXNzaWduMih7fSwgb2JqKTsKICAgICAgICAgICAgdXBkYXRlZFtrZXldID0gY29weVdpdGhTZXRJbXBsKG9ialtrZXldLCBwYXRoMiwgaW5kZXgyICsgMSwgdmFsdWUpOwogICAgICAgICAgICByZXR1cm4gdXBkYXRlZDsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgY29weVdpdGhTZXQgPSBmdW5jdGlvbihvYmosIHBhdGgyLCB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gY29weVdpdGhTZXRJbXBsKG9iaiwgcGF0aDIsIDAsIHZhbHVlKTsKICAgICAgICAgIH07CiAgICAgICAgICB2YXIgZmluZEhvb2sgPSBmdW5jdGlvbihmaWJlciwgaWQpIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnRIb29rMiA9IGZpYmVyLm1lbW9pemVkU3RhdGU7CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50SG9vazIgIT09IG51bGwgJiYgaWQgPiAwKSB7CiAgICAgICAgICAgICAgY3VycmVudEhvb2syID0gY3VycmVudEhvb2syLm5leHQ7CiAgICAgICAgICAgICAgaWQtLTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gY3VycmVudEhvb2syOwogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlID0gZnVuY3Rpb24oZmliZXIsIGlkLCBwYXRoMiwgdmFsdWUpIHsKICAgICAgICAgICAgdmFyIGhvb2sgPSBmaW5kSG9vayhmaWJlciwgaWQpOwogICAgICAgICAgICBpZiAoaG9vayAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHZhciBuZXdTdGF0ZSA9IGNvcHlXaXRoU2V0KGhvb2subWVtb2l6ZWRTdGF0ZSwgcGF0aDIsIHZhbHVlKTsKICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBhc3NpZ24yKHt9LCBmaWJlci5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoID0gZnVuY3Rpb24oZmliZXIsIGlkLCBwYXRoMikgewogICAgICAgICAgICB2YXIgaG9vayA9IGZpbmRIb29rKGZpYmVyLCBpZCk7CiAgICAgICAgICAgIGlmIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhEZWxldGUoaG9vay5tZW1vaXplZFN0YXRlLCBwYXRoMik7CiAgICAgICAgICAgICAgaG9vay5tZW1vaXplZFN0YXRlID0gbmV3U3RhdGU7CiAgICAgICAgICAgICAgaG9vay5iYXNlU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBmaWJlci5tZW1vaXplZFByb3BzID0gYXNzaWduMih7fSwgZmliZXIubWVtb2l6ZWRQcm9wcyk7CiAgICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICAgIG92ZXJyaWRlSG9va1N0YXRlUmVuYW1lUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBpZCwgb2xkUGF0aCwgbmV3UGF0aCkgewogICAgICAgICAgICB2YXIgaG9vayA9IGZpbmRIb29rKGZpYmVyLCBpZCk7CiAgICAgICAgICAgIGlmIChob29rICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1N0YXRlID0gY29weVdpdGhSZW5hbWUoaG9vay5tZW1vaXplZFN0YXRlLCBvbGRQYXRoLCBuZXdQYXRoKTsKICAgICAgICAgICAgICBob29rLm1lbW9pemVkU3RhdGUgPSBuZXdTdGF0ZTsKICAgICAgICAgICAgICBob29rLmJhc2VTdGF0ZSA9IG5ld1N0YXRlOwogICAgICAgICAgICAgIGZpYmVyLm1lbW9pemVkUHJvcHMgPSBhc3NpZ24yKHt9LCBmaWJlci5tZW1vaXplZFByb3BzKTsKICAgICAgICAgICAgICB2YXIgcm9vdDMgPSBlbnF1ZXVlQ29uY3VycmVudFJlbmRlckZvckxhbmUoZmliZXIsIFN5bmNMYW5lKTsKICAgICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVQcm9wcyA9IGZ1bmN0aW9uKGZpYmVyLCBwYXRoMiwgdmFsdWUpIHsKICAgICAgICAgICAgZmliZXIucGVuZGluZ1Byb3BzID0gY29weVdpdGhTZXQoZmliZXIubWVtb2l6ZWRQcm9wcywgcGF0aDIsIHZhbHVlKTsKICAgICAgICAgICAgaWYgKGZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZS5wZW5kaW5nUHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBvdmVycmlkZVByb3BzRGVsZXRlUGF0aCA9IGZ1bmN0aW9uKGZpYmVyLCBwYXRoMikgewogICAgICAgICAgICBmaWJlci5wZW5kaW5nUHJvcHMgPSBjb3B5V2l0aERlbGV0ZShmaWJlci5tZW1vaXplZFByb3BzLCBwYXRoMik7CiAgICAgICAgICAgIGlmIChmaWJlci5hbHRlcm5hdGUpIHsKICAgICAgICAgICAgICBmaWJlci5hbHRlcm5hdGUucGVuZGluZ1Byb3BzID0gZmliZXIucGVuZGluZ1Byb3BzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgb3ZlcnJpZGVQcm9wc1JlbmFtZVBhdGggPSBmdW5jdGlvbihmaWJlciwgb2xkUGF0aCwgbmV3UGF0aCkgewogICAgICAgICAgICBmaWJlci5wZW5kaW5nUHJvcHMgPSBjb3B5V2l0aFJlbmFtZShmaWJlci5tZW1vaXplZFByb3BzLCBvbGRQYXRoLCBuZXdQYXRoKTsKICAgICAgICAgICAgaWYgKGZpYmVyLmFsdGVybmF0ZSkgewogICAgICAgICAgICAgIGZpYmVyLmFsdGVybmF0ZS5wZW5kaW5nUHJvcHMgPSBmaWJlci5wZW5kaW5nUHJvcHM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIHJvb3QzID0gZW5xdWV1ZUNvbmN1cnJlbnRSZW5kZXJGb3JMYW5lKGZpYmVyLCBTeW5jTGFuZSk7CiAgICAgICAgICAgIGlmIChyb290MyAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlT25GaWJlcihyb290MywgZmliZXIsIFN5bmNMYW5lLCBOb1RpbWVzdGFtcCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgICBzY2hlZHVsZVVwZGF0ZSA9IGZ1bmN0aW9uKGZpYmVyKSB7CiAgICAgICAgICAgIHZhciByb290MyA9IGVucXVldWVDb25jdXJyZW50UmVuZGVyRm9yTGFuZShmaWJlciwgU3luY0xhbmUpOwogICAgICAgICAgICBpZiAocm9vdDMgIT09IG51bGwpIHsKICAgICAgICAgICAgICBzY2hlZHVsZVVwZGF0ZU9uRmliZXIocm9vdDMsIGZpYmVyLCBTeW5jTGFuZSwgTm9UaW1lc3RhbXApOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgc2V0RXJyb3JIYW5kbGVyID0gZnVuY3Rpb24obmV3U2hvdWxkRXJyb3JJbXBsKSB7CiAgICAgICAgICAgIHNob3VsZEVycm9ySW1wbCA9IG5ld1Nob3VsZEVycm9ySW1wbDsKICAgICAgICAgIH07CiAgICAgICAgICBzZXRTdXNwZW5zZUhhbmRsZXIgPSBmdW5jdGlvbihuZXdTaG91bGRTdXNwZW5kSW1wbCkgewogICAgICAgICAgICBzaG91bGRTdXNwZW5kSW1wbCA9IG5ld1Nob3VsZFN1c3BlbmRJbXBsOwogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZmluZEhvc3RJbnN0YW5jZUJ5RmliZXIoZmliZXIpIHsKICAgICAgICAgIHZhciBob3N0RmliZXIgPSBmaW5kQ3VycmVudEhvc3RGaWJlcihmaWJlcik7CiAgICAgICAgICBpZiAoaG9zdEZpYmVyID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGhvc3RGaWJlci5zdGF0ZU5vZGU7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGVtcHR5RmluZEZpYmVyQnlIb3N0SW5zdGFuY2UoaW5zdGFuY2UpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDdXJyZW50RmliZXJGb3JEZXZUb29scygpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50MzsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaW5qZWN0SW50b0RldlRvb2xzKGRldlRvb2xzQ29uZmlnKSB7CiAgICAgICAgICB2YXIgZmluZEZpYmVyQnlIb3N0SW5zdGFuY2UgPSBkZXZUb29sc0NvbmZpZy5maW5kRmliZXJCeUhvc3RJbnN0YW5jZTsKICAgICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0Q3VycmVudERpc3BhdGNoZXI7CiAgICAgICAgICByZXR1cm4gaW5qZWN0SW50ZXJuYWxzKHsKICAgICAgICAgICAgYnVuZGxlVHlwZTogZGV2VG9vbHNDb25maWcuYnVuZGxlVHlwZSwKICAgICAgICAgICAgdmVyc2lvbjogZGV2VG9vbHNDb25maWcudmVyc2lvbiwKICAgICAgICAgICAgcmVuZGVyZXJQYWNrYWdlTmFtZTogZGV2VG9vbHNDb25maWcucmVuZGVyZXJQYWNrYWdlTmFtZSwKICAgICAgICAgICAgcmVuZGVyZXJDb25maWc6IGRldlRvb2xzQ29uZmlnLnJlbmRlcmVyQ29uZmlnLAogICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZSwKICAgICAgICAgICAgb3ZlcnJpZGVIb29rU3RhdGVEZWxldGVQYXRoLAogICAgICAgICAgICBvdmVycmlkZUhvb2tTdGF0ZVJlbmFtZVBhdGgsCiAgICAgICAgICAgIG92ZXJyaWRlUHJvcHMsCiAgICAgICAgICAgIG92ZXJyaWRlUHJvcHNEZWxldGVQYXRoLAogICAgICAgICAgICBvdmVycmlkZVByb3BzUmVuYW1lUGF0aCwKICAgICAgICAgICAgc2V0RXJyb3JIYW5kbGVyLAogICAgICAgICAgICBzZXRTdXNwZW5zZUhhbmRsZXIsCiAgICAgICAgICAgIHNjaGVkdWxlVXBkYXRlLAogICAgICAgICAgICBjdXJyZW50RGlzcGF0Y2hlclJlZjogUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjIsCiAgICAgICAgICAgIGZpbmRIb3N0SW5zdGFuY2VCeUZpYmVyLAogICAgICAgICAgICBmaW5kRmliZXJCeUhvc3RJbnN0YW5jZTogZmluZEZpYmVyQnlIb3N0SW5zdGFuY2UgfHwgZW1wdHlGaW5kRmliZXJCeUhvc3RJbnN0YW5jZSwKICAgICAgICAgICAgLy8gUmVhY3QgUmVmcmVzaAogICAgICAgICAgICBmaW5kSG9zdEluc3RhbmNlc0ZvclJlZnJlc2gsCiAgICAgICAgICAgIHNjaGVkdWxlUmVmcmVzaCwKICAgICAgICAgICAgc2NoZWR1bGVSb290LAogICAgICAgICAgICBzZXRSZWZyZXNoSGFuZGxlciwKICAgICAgICAgICAgLy8gRW5hYmxlcyBEZXZUb29scyB0byBhcHBlbmQgb3duZXIgc3RhY2tzIHRvIGVycm9yIG1lc3NhZ2VzIGluIERFViBtb2RlLgogICAgICAgICAgICBnZXRDdXJyZW50RmliZXI6IGdldEN1cnJlbnRGaWJlckZvckRldlRvb2xzLAogICAgICAgICAgICAvLyBFbmFibGVzIERldlRvb2xzIHRvIGRldGVjdCByZWNvbmNpbGVyIHZlcnNpb24gcmF0aGVyIHRoYW4gcmVuZGVyZXIgdmVyc2lvbgogICAgICAgICAgICAvLyB3aGljaCBtYXkgbm90IG1hdGNoIGZvciB0aGlyZCBwYXJ0eSByZW5kZXJlcnMuCiAgICAgICAgICAgIHJlY29uY2lsZXJWZXJzaW9uOiBSZWFjdFZlcnNpb24KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICB2YXIgZGVmYXVsdE9uUmVjb3ZlcmFibGVFcnJvciA9IHR5cGVvZiByZXBvcnRFcnJvciA9PT0gImZ1bmN0aW9uIiA/ICgKICAgICAgICAgIC8vIEluIG1vZGVybiBicm93c2VycywgcmVwb3J0RXJyb3Igd2lsbCBkaXNwYXRjaCBhbiBlcnJvciBldmVudCwKICAgICAgICAgIC8vIGVtdWxhdGluZyBhbiB1bmNhdWdodCBKYXZhU2NyaXB0IGVycm9yLgogICAgICAgICAgcmVwb3J0RXJyb3IKICAgICAgICApIDogZnVuY3Rpb24oZXJyb3IyKSB7CiAgICAgICAgICBjb25zb2xlWyJlcnJvciJdKGVycm9yMik7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBSZWFjdERPTVJvb3QoaW50ZXJuYWxSb290KSB7CiAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBpbnRlcm5hbFJvb3Q7CiAgICAgICAgfQogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUucmVuZGVyID0gUmVhY3RET01Sb290LnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihjaGlsZHJlbikgewogICAgICAgICAgdmFyIHJvb3QzID0gdGhpcy5faW50ZXJuYWxSb290OwogICAgICAgICAgaWYgKHJvb3QzID09PSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IHVwZGF0ZSBhbiB1bm1vdW50ZWQgcm9vdC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbMV0gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IGRvZXMgbm90IHN1cHBvcnQgdGhlIHNlY29uZCBjYWxsYmFjayBhcmd1bWVudC4gVG8gZXhlY3V0ZSBhIHNpZGUgZWZmZWN0IGFmdGVyIHJlbmRlcmluZywgZGVjbGFyZSBpdCBpbiBhIGNvbXBvbmVudCBib2R5IHdpdGggdXNlRWZmZWN0KCkuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNWYWxpZENvbnRhaW5lcihhcmd1bWVudHNbMV0pKSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBjb250YWluZXIgdG8gdGhlIHNlY29uZCBhcmd1bWVudCBvZiByb290LnJlbmRlciguLi4pLiBZb3UgZG9uJ3QgbmVlZCB0byBwYXNzIGl0IGFnYWluIHNpbmNlIHlvdSBhbHJlYWR5IHBhc3NlZCBpdCB0byBjcmVhdGUgdGhlIHJvb3QuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZ3VtZW50c1sxXSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IHBhc3NlZCBhIHNlY29uZCBhcmd1bWVudCB0byByb290LnJlbmRlciguLi4pIGJ1dCBpdCBvbmx5IGFjY2VwdHMgb25lIGFyZ3VtZW50LiIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gcm9vdDMuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2UgPSBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhyb290My5jdXJyZW50KTsKICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlKSB7CiAgICAgICAgICAgICAgICBpZiAoaG9zdEluc3RhbmNlLnBhcmVudE5vZGUgIT09IGNvbnRhaW5lcjIpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoInJlbmRlciguLi4pOiBJdCBsb29rcyBsaWtlIHRoZSBSZWFjdC1yZW5kZXJlZCBjb250ZW50IG9mIHRoZSByb290IGNvbnRhaW5lciB3YXMgcmVtb3ZlZCB3aXRob3V0IHVzaW5nIFJlYWN0LiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgY2F1c2UgZXJyb3JzLiBJbnN0ZWFkLCBjYWxsIHJvb3QudW5tb3VudCgpIHRvIGVtcHR5IGEgcm9vdCdzIGNvbnRhaW5lci4iKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHVwZGF0ZUNvbnRhaW5lcihjaGlsZHJlbiwgcm9vdDMsIG51bGwsIG51bGwpOwogICAgICAgIH07CiAgICAgICAgUmVhY3RET01IeWRyYXRpb25Sb290LnByb3RvdHlwZS51bm1vdW50ID0gUmVhY3RET01Sb290LnByb3RvdHlwZS51bm1vdW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzBdID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoInVubW91bnQoLi4uKTogZG9lcyBub3Qgc3VwcG9ydCBhIGNhbGxiYWNrIGFyZ3VtZW50LiBUbyBleGVjdXRlIGEgc2lkZSBlZmZlY3QgYWZ0ZXIgcmVuZGVyaW5nLCBkZWNsYXJlIGl0IGluIGEgY29tcG9uZW50IGJvZHkgd2l0aCB1c2VFZmZlY3QoKS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIHJvb3QzID0gdGhpcy5faW50ZXJuYWxSb290OwogICAgICAgICAgaWYgKHJvb3QzICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuX2ludGVybmFsUm9vdCA9IG51bGw7CiAgICAgICAgICAgIHZhciBjb250YWluZXIyID0gcm9vdDMuY29udGFpbmVySW5mbzsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGlmIChpc0FscmVhZHlSZW5kZXJpbmcoKSkgewogICAgICAgICAgICAgICAgZXJyb3IoIkF0dGVtcHRlZCB0byBzeW5jaHJvbm91c2x5IHVubW91bnQgYSByb290IHdoaWxlIFJlYWN0IHdhcyBhbHJlYWR5IHJlbmRlcmluZy4gUmVhY3QgY2Fubm90IGZpbmlzaCB1bm1vdW50aW5nIHRoZSByb290IHVudGlsIHRoZSBjdXJyZW50IHJlbmRlciBoYXMgY29tcGxldGVkLCB3aGljaCBtYXkgbGVhZCB0byBhIHJhY2UgY29uZGl0aW9uLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKG51bGwsIHJvb3QzLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHVubWFya0NvbnRhaW5lckFzUm9vdChjb250YWluZXIyKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJvb3QyKGNvbnRhaW5lcjIsIG9wdGlvbnMyKSB7CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXIoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjcmVhdGVSb290KC4uLik6IFRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICB3YXJuSWZSZWFjdERPTUNvbnRhaW5lckluREVWKGNvbnRhaW5lcjIpOwogICAgICAgICAgdmFyIGlzU3RyaWN0TW9kZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUgPSBmYWxzZTsKICAgICAgICAgIHZhciBpZGVudGlmaWVyUHJlZml4ID0gIiI7CiAgICAgICAgICB2YXIgb25SZWNvdmVyYWJsZUVycm9yID0gZGVmYXVsdE9uUmVjb3ZlcmFibGVFcnJvcjsKICAgICAgICAgIHZhciB0cmFuc2l0aW9uQ2FsbGJhY2tzID0gbnVsbDsKICAgICAgICAgIGlmIChvcHRpb25zMiAhPT0gbnVsbCAmJiBvcHRpb25zMiAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAob3B0aW9uczIuaHlkcmF0ZSkgewogICAgICAgICAgICAgICAgd2FybjMoImh5ZHJhdGUgdGhyb3VnaCBjcmVhdGVSb290IGlzIGRlcHJlY2F0ZWQuIFVzZSBSZWFjdERPTUNsaWVudC5oeWRyYXRlUm9vdChjb250YWluZXIsIDxBcHAgLz4pIGluc3RlYWQuIik7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9uczIgPT09ICJvYmplY3QiICYmIG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgICAgZXJyb3IoIllvdSBwYXNzZWQgYSBKU1ggZWxlbWVudCB0byBjcmVhdGVSb290LiBZb3UgcHJvYmFibHkgbWVhbnQgdG8gY2FsbCByb290LnJlbmRlciBpbnN0ZWFkLiBFeGFtcGxlIHVzYWdlOlxuXG4gIGxldCByb290ID0gY3JlYXRlUm9vdChkb21Db250YWluZXIpO1xuICByb290LnJlbmRlcig8QXBwIC8+KTsiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnVuc3RhYmxlX3N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBpc1N0cmljdE1vZGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4ID0gb3B0aW9uczIuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IgPSBvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnRyYW5zaXRpb25DYWxsYmFja3MgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHRyYW5zaXRpb25DYWxsYmFja3MgPSBvcHRpb25zMi50cmFuc2l0aW9uQ2FsbGJhY2tzOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcm9vdDMgPSBjcmVhdGVDb250YWluZXIoY29udGFpbmVyMiwgQ29uY3VycmVudFJvb3QsIG51bGwsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICB2YXIgcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgcmV0dXJuIG5ldyBSZWFjdERPTVJvb3Qocm9vdDMpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBSZWFjdERPTUh5ZHJhdGlvblJvb3QoaW50ZXJuYWxSb290KSB7CiAgICAgICAgICB0aGlzLl9pbnRlcm5hbFJvb3QgPSBpbnRlcm5hbFJvb3Q7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlSHlkcmF0aW9uKHRhcmdldCkgewogICAgICAgICAgaWYgKHRhcmdldCkgewogICAgICAgICAgICBxdWV1ZUV4cGxpY2l0SHlkcmF0aW9uVGFyZ2V0KHRhcmdldCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIFJlYWN0RE9NSHlkcmF0aW9uUm9vdC5wcm90b3R5cGUudW5zdGFibGVfc2NoZWR1bGVIeWRyYXRpb24gPSBzY2hlZHVsZUh5ZHJhdGlvbjsKICAgICAgICBmdW5jdGlvbiBoeWRyYXRlUm9vdChjb250YWluZXIyLCBpbml0aWFsQ2hpbGRyZW4sIG9wdGlvbnMyKSB7CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXIoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJoeWRyYXRlUm9vdCguLi4pOiBUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgd2FybklmUmVhY3RET01Db250YWluZXJJbkRFVihjb250YWluZXIyKTsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGluaXRpYWxDaGlsZHJlbiA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgZXJyb3IoIk11c3QgcHJvdmlkZSBpbml0aWFsIGNoaWxkcmVuIGFzIHNlY29uZCBhcmd1bWVudCB0byBoeWRyYXRlUm9vdC4gRXhhbXBsZSB1c2FnZTogaHlkcmF0ZVJvb3QoZG9tQ29udGFpbmVyLCA8QXBwIC8+KSIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgaHlkcmF0aW9uQ2FsbGJhY2tzID0gb3B0aW9uczIgIT0gbnVsbCA/IG9wdGlvbnMyIDogbnVsbDsKICAgICAgICAgIHZhciBtdXRhYmxlU291cmNlcyA9IG9wdGlvbnMyICE9IG51bGwgJiYgb3B0aW9uczIuaHlkcmF0ZWRTb3VyY2VzIHx8IG51bGw7CiAgICAgICAgICB2YXIgaXNTdHJpY3RNb2RlID0gZmFsc2U7CiAgICAgICAgICB2YXIgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSA9IGZhbHNlOwogICAgICAgICAgdmFyIGlkZW50aWZpZXJQcmVmaXggPSAiIjsKICAgICAgICAgIHZhciBvblJlY292ZXJhYmxlRXJyb3IgPSBkZWZhdWx0T25SZWNvdmVyYWJsZUVycm9yOwogICAgICAgICAgaWYgKG9wdGlvbnMyICE9PSBudWxsICYmIG9wdGlvbnMyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMyLnVuc3RhYmxlX3N0cmljdE1vZGUgPT09IHRydWUpIHsKICAgICAgICAgICAgICBpc1N0cmljdE1vZGUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvcHRpb25zMi5pZGVudGlmaWVyUHJlZml4ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBpZGVudGlmaWVyUHJlZml4ID0gb3B0aW9uczIuaWRlbnRpZmllclByZWZpeDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob3B0aW9uczIub25SZWNvdmVyYWJsZUVycm9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICBvblJlY292ZXJhYmxlRXJyb3IgPSBvcHRpb25zMi5vblJlY292ZXJhYmxlRXJyb3I7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcihpbml0aWFsQ2hpbGRyZW4sIG51bGwsIGNvbnRhaW5lcjIsIENvbmN1cnJlbnRSb290LCBoeWRyYXRpb25DYWxsYmFja3MsIGlzU3RyaWN0TW9kZSwgY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwgaWRlbnRpZmllclByZWZpeCwgb25SZWNvdmVyYWJsZUVycm9yKTsKICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3Qocm9vdDMuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhjb250YWluZXIyKTsKICAgICAgICAgIGlmIChtdXRhYmxlU291cmNlcykgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG11dGFibGVTb3VyY2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIG11dGFibGVTb3VyY2UgPSBtdXRhYmxlU291cmNlc1tpXTsKICAgICAgICAgICAgICByZWdpc3Rlck11dGFibGVTb3VyY2VGb3JIeWRyYXRpb24ocm9vdDMsIG11dGFibGVTb3VyY2UpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmV3IFJlYWN0RE9NSHlkcmF0aW9uUm9vdChyb290Myk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRDb250YWluZXIobm9kZSkgewogICAgICAgICAgcmV0dXJuICEhKG5vZGUgJiYgKG5vZGUubm9kZVR5cGUgPT09IEVMRU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IERPQ1VNRU5UX0ZSQUdNRU5UX05PREUgfHwgIWRpc2FibGVDb21tZW50c0FzRE9NQ29udGFpbmVycykpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KG5vZGUpIHsKICAgICAgICAgIHJldHVybiAhIShub2RlICYmIChub2RlLm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUgfHwgbm9kZS5ub2RlVHlwZSA9PT0gRE9DVU1FTlRfTk9ERSB8fCBub2RlLm5vZGVUeXBlID09PSBET0NVTUVOVF9GUkFHTUVOVF9OT0RFIHx8IG5vZGUubm9kZVR5cGUgPT09IENPTU1FTlRfTk9ERSAmJiBub2RlLm5vZGVWYWx1ZSA9PT0gIiByZWFjdC1tb3VudC1wb2ludC11bnN0YWJsZSAiKSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdhcm5JZlJlYWN0RE9NQ29udGFpbmVySW5ERVYoY29udGFpbmVyMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lcjIudGFnTmFtZSAmJiBjb250YWluZXIyLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PT0gIkJPRFkiKSB7CiAgICAgICAgICAgICAgZXJyb3IoImNyZWF0ZVJvb3QoKTogQ3JlYXRpbmcgcm9vdHMgZGlyZWN0bHkgd2l0aCBkb2N1bWVudC5ib2R5IGlzIGRpc2NvdXJhZ2VkLCBzaW5jZSBpdHMgY2hpbGRyZW4gYXJlIG9mdGVuIG1hbmlwdWxhdGVkIGJ5IHRoaXJkLXBhcnR5IHNjcmlwdHMgYW5kIGJyb3dzZXIgZXh0ZW5zaW9ucy4gVGhpcyBtYXkgbGVhZCB0byBzdWJ0bGUgcmVjb25jaWxpYXRpb24gaXNzdWVzLiBUcnkgdXNpbmcgYSBjb250YWluZXIgZWxlbWVudCBjcmVhdGVkIGZvciB5b3VyIGFwcC4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikpIHsKICAgICAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyKSB7CiAgICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKSBvbiBhIGNvbnRhaW5lciB0aGF0IHdhcyBwcmV2aW91c2x5IHBhc3NlZCB0byBSZWFjdERPTS5yZW5kZXIoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiIpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKSBvbiBhIGNvbnRhaW5lciB0aGF0IGhhcyBhbHJlYWR5IGJlZW4gcGFzc2VkIHRvIGNyZWF0ZVJvb3QoKSBiZWZvcmUuIEluc3RlYWQsIGNhbGwgcm9vdC5yZW5kZXIoKSBvbiB0aGUgZXhpc3Rpbmcgcm9vdCBpbnN0ZWFkIGlmIHlvdSB3YW50IHRvIHVwZGF0ZSBpdC4iKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyJDMgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgdG9wTGV2ZWxVcGRhdGVXYXJuaW5nczsKICAgICAgICB7CiAgICAgICAgICB0b3BMZXZlbFVwZGF0ZVdhcm5pbmdzID0gZnVuY3Rpb24oY29udGFpbmVyMikgewogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyICYmIGNvbnRhaW5lcjIubm9kZVR5cGUgIT09IENPTU1FTlRfTk9ERSkgewogICAgICAgICAgICAgIHZhciBob3N0SW5zdGFuY2UgPSBmaW5kSG9zdEluc3RhbmNlV2l0aE5vUG9ydGFscyhjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIuY3VycmVudCk7CiAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZSkgewogICAgICAgICAgICAgICAgaWYgKGhvc3RJbnN0YW5jZS5wYXJlbnROb2RlICE9PSBjb250YWluZXIyKSB7CiAgICAgICAgICAgICAgICAgIGVycm9yKCJyZW5kZXIoLi4uKTogSXQgbG9va3MgbGlrZSB0aGUgUmVhY3QtcmVuZGVyZWQgY29udGVudCBvZiB0aGlzIGNvbnRhaW5lciB3YXMgcmVtb3ZlZCB3aXRob3V0IHVzaW5nIFJlYWN0LiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQgYW5kIHdpbGwgY2F1c2UgZXJyb3JzLiBJbnN0ZWFkLCBjYWxsIFJlYWN0RE9NLnVubW91bnRDb21wb25lbnRBdE5vZGUgdG8gZW1wdHkgYSBjb250YWluZXIuIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBpc1Jvb3RSZW5kZXJlZEJ5U29tZVJlYWN0ID0gISFjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXI7CiAgICAgICAgICAgIHZhciByb290RWwgPSBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciBoYXNOb25Sb290UmVhY3RDaGlsZCA9ICEhKHJvb3RFbCAmJiBnZXRJbnN0YW5jZUZyb21Ob2RlKHJvb3RFbCkpOwogICAgICAgICAgICBpZiAoaGFzTm9uUm9vdFJlYWN0Q2hpbGQgJiYgIWlzUm9vdFJlbmRlcmVkQnlTb21lUmVhY3QpIHsKICAgICAgICAgICAgICBlcnJvcigicmVuZGVyKC4uLik6IFJlcGxhY2luZyBSZWFjdC1yZW5kZXJlZCBjaGlsZHJlbiB3aXRoIGEgbmV3IHJvb3QgY29tcG9uZW50LiBJZiB5b3UgaW50ZW5kZWQgdG8gdXBkYXRlIHRoZSBjaGlsZHJlbiBvZiB0aGlzIG5vZGUsIHlvdSBzaG91bGQgaW5zdGVhZCBoYXZlIHRoZSBleGlzdGluZyBjaGlsZHJlbiB1cGRhdGUgdGhlaXIgc3RhdGUgYW5kIHJlbmRlciB0aGUgbmV3IGNvbXBvbmVudHMgaW5zdGVhZCBvZiBjYWxsaW5nIFJlYWN0RE9NLnJlbmRlci4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGNvbnRhaW5lcjIudGFnTmFtZSAmJiBjb250YWluZXIyLnRhZ05hbWUudG9VcHBlckNhc2UoKSA9PT0gIkJPRFkiKSB7CiAgICAgICAgICAgICAgZXJyb3IoInJlbmRlcigpOiBSZW5kZXJpbmcgY29tcG9uZW50cyBkaXJlY3RseSBpbnRvIGRvY3VtZW50LmJvZHkgaXMgZGlzY291cmFnZWQsIHNpbmNlIGl0cyBjaGlsZHJlbiBhcmUgb2Z0ZW4gbWFuaXB1bGF0ZWQgYnkgdGhpcmQtcGFydHkgc2NyaXB0cyBhbmQgYnJvd3NlciBleHRlbnNpb25zLiBUaGlzIG1heSBsZWFkIHRvIHN1YnRsZSByZWNvbmNpbGlhdGlvbiBpc3N1ZXMuIFRyeSByZW5kZXJpbmcgaW50byBhIGNvbnRhaW5lciBlbGVtZW50IGNyZWF0ZWQgZm9yIHlvdXIgYXBwLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRSZWFjdFJvb3RFbGVtZW50SW5Db250YWluZXIoY29udGFpbmVyMikgewogICAgICAgICAgaWYgKCFjb250YWluZXIyKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbnRhaW5lcjIubm9kZVR5cGUgPT09IERPQ1VNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjIuZG9jdW1lbnRFbGVtZW50OwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGNvbnRhaW5lcjIuZmlyc3RDaGlsZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbm9vcE9uUmVjb3ZlcmFibGVFcnJvcigpIHsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gbGVnYWN5Q3JlYXRlUm9vdEZyb21ET01Db250YWluZXIoY29udGFpbmVyMiwgaW5pdGlhbENoaWxkcmVuLCBwYXJlbnRDb21wb25lbnQsIGNhbGxiYWNrLCBpc0h5ZHJhdGlvbkNvbnRhaW5lcikgewogICAgICAgICAgaWYgKGlzSHlkcmF0aW9uQ29udGFpbmVyKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgb3JpZ2luYWxDYWxsYmFjayA9IGNhbGxiYWNrOwogICAgICAgICAgICAgIGNhbGxiYWNrID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBnZXRQdWJsaWNSb290SW5zdGFuY2Uocm9vdDMpOwogICAgICAgICAgICAgICAgb3JpZ2luYWxDYWxsYmFjay5jYWxsKGluc3RhbmNlKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciByb290MyA9IGNyZWF0ZUh5ZHJhdGlvbkNvbnRhaW5lcigKICAgICAgICAgICAgICBpbml0aWFsQ2hpbGRyZW4sCiAgICAgICAgICAgICAgY2FsbGJhY2ssCiAgICAgICAgICAgICAgY29udGFpbmVyMiwKICAgICAgICAgICAgICBMZWdhY3lSb290LAogICAgICAgICAgICAgIG51bGwsCiAgICAgICAgICAgICAgLy8gaHlkcmF0aW9uQ2FsbGJhY2tzCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gaXNTdHJpY3RNb2RlCiAgICAgICAgICAgICAgZmFsc2UsCiAgICAgICAgICAgICAgLy8gY29uY3VycmVudFVwZGF0ZXNCeURlZmF1bHRPdmVycmlkZSwKICAgICAgICAgICAgICAiIiwKICAgICAgICAgICAgICAvLyBpZGVudGlmaWVyUHJlZml4CiAgICAgICAgICAgICAgbm9vcE9uUmVjb3ZlcmFibGVFcnJvcgogICAgICAgICAgICApOwogICAgICAgICAgICBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPSByb290MzsKICAgICAgICAgICAgbWFya0NvbnRhaW5lckFzUm9vdChyb290My5jdXJyZW50LCBjb250YWluZXIyKTsKICAgICAgICAgICAgdmFyIHJvb3RDb250YWluZXJFbGVtZW50ID0gY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gQ09NTUVOVF9OT0RFID8gY29udGFpbmVyMi5wYXJlbnROb2RlIDogY29udGFpbmVyMjsKICAgICAgICAgICAgbGlzdGVuVG9BbGxTdXBwb3J0ZWRFdmVudHMocm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICBmbHVzaFN5bmMoKTsKICAgICAgICAgICAgcmV0dXJuIHJvb3QzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIHJvb3RTaWJsaW5nOwogICAgICAgICAgICB3aGlsZSAocm9vdFNpYmxpbmcgPSBjb250YWluZXIyLmxhc3RDaGlsZCkgewogICAgICAgICAgICAgIGNvbnRhaW5lcjIucmVtb3ZlQ2hpbGQocm9vdFNpYmxpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICB2YXIgX29yaWdpbmFsQ2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gZ2V0UHVibGljUm9vdEluc3RhbmNlKF9yb290KTsKICAgICAgICAgICAgICAgIF9vcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIF9yb290ID0gY3JlYXRlQ29udGFpbmVyKAogICAgICAgICAgICAgIGNvbnRhaW5lcjIsCiAgICAgICAgICAgICAgTGVnYWN5Um9vdCwKICAgICAgICAgICAgICBudWxsLAogICAgICAgICAgICAgIC8vIGh5ZHJhdGlvbkNhbGxiYWNrcwogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGlzU3RyaWN0TW9kZQogICAgICAgICAgICAgIGZhbHNlLAogICAgICAgICAgICAgIC8vIGNvbmN1cnJlbnRVcGRhdGVzQnlEZWZhdWx0T3ZlcnJpZGUsCiAgICAgICAgICAgICAgIiIsCiAgICAgICAgICAgICAgLy8gaWRlbnRpZmllclByZWZpeAogICAgICAgICAgICAgIG5vb3BPblJlY292ZXJhYmxlRXJyb3IKICAgICAgICAgICAgKTsKICAgICAgICAgICAgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID0gX3Jvb3Q7CiAgICAgICAgICAgIG1hcmtDb250YWluZXJBc1Jvb3QoX3Jvb3QuY3VycmVudCwgY29udGFpbmVyMik7CiAgICAgICAgICAgIHZhciBfcm9vdENvbnRhaW5lckVsZW1lbnQgPSBjb250YWluZXIyLm5vZGVUeXBlID09PSBDT01NRU5UX05PREUgPyBjb250YWluZXIyLnBhcmVudE5vZGUgOiBjb250YWluZXIyOwogICAgICAgICAgICBsaXN0ZW5Ub0FsbFN1cHBvcnRlZEV2ZW50cyhfcm9vdENvbnRhaW5lckVsZW1lbnQpOwogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGluaXRpYWxDaGlsZHJlbiwgX3Jvb3QsIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2spOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIF9yb290OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuT25JbnZhbGlkQ2FsbGJhY2skMShjYWxsYmFjaywgY2FsbGVyTmFtZSkgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoY2FsbGJhY2sgIT09IG51bGwgJiYgdHlwZW9mIGNhbGxiYWNrICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgZXJyb3IoIiVzKC4uLik6IEV4cGVjdGVkIHRoZSBsYXN0IG9wdGlvbmFsIGBjYWxsYmFja2AgYXJndW1lbnQgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCByZWNlaXZlZDogJXMuIiwgY2FsbGVyTmFtZSwgY2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgY2hpbGRyZW4sIGNvbnRhaW5lcjIsIGZvcmNlSHlkcmF0ZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdG9wTGV2ZWxVcGRhdGVXYXJuaW5ncyhjb250YWluZXIyKTsKICAgICAgICAgICAgd2Fybk9uSW52YWxpZENhbGxiYWNrJDEoY2FsbGJhY2sgPT09IHZvaWQgMCA/IG51bGwgOiBjYWxsYmFjaywgInJlbmRlciIpOwogICAgICAgICAgfQogICAgICAgICAgdmFyIG1heWJlUm9vdCA9IGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcjsKICAgICAgICAgIHZhciByb290MzsKICAgICAgICAgIGlmICghbWF5YmVSb290KSB7CiAgICAgICAgICAgIHJvb3QzID0gbGVnYWN5Q3JlYXRlUm9vdEZyb21ET01Db250YWluZXIoY29udGFpbmVyMiwgY2hpbGRyZW4sIHBhcmVudENvbXBvbmVudCwgY2FsbGJhY2ssIGZvcmNlSHlkcmF0ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByb290MyA9IG1heWJlUm9vdDsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIHZhciBvcmlnaW5hbENhbGxiYWNrID0gY2FsbGJhY2s7CiAgICAgICAgICAgICAgY2FsbGJhY2sgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IGdldFB1YmxpY1Jvb3RJbnN0YW5jZShyb290Myk7CiAgICAgICAgICAgICAgICBvcmlnaW5hbENhbGxiYWNrLmNhbGwoaW5zdGFuY2UpOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXBkYXRlQ29udGFpbmVyKGNoaWxkcmVuLCByb290MywgcGFyZW50Q29tcG9uZW50LCBjYWxsYmFjayk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZ2V0UHVibGljUm9vdEluc3RhbmNlKHJvb3QzKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEZpbmRET01Ob2RlID0gZmFsc2U7CiAgICAgICAgZnVuY3Rpb24gZmluZERPTU5vZGUoY29tcG9uZW50T3JFbGVtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZGlkV2FybkFib3V0RmluZERPTU5vZGUpIHsKICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRGaW5kRE9NTm9kZSA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoImZpbmRET01Ob2RlIGlzIGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgbmV4dCBtYWpvciByZWxlYXNlLiBJbnN0ZWFkLCBhZGQgYSByZWYgZGlyZWN0bHkgdG8gdGhlIGVsZW1lbnQgeW91IHdhbnQgdG8gcmVmZXJlbmNlLiBMZWFybiBtb3JlIGFib3V0IHVzaW5nIHJlZnMgc2FmZWx5IGhlcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zdHJpY3QtbW9kZS1maW5kLW5vZGUiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgb3duZXIgPSBSZWFjdEN1cnJlbnRPd25lciQzLmN1cnJlbnQ7CiAgICAgICAgICAgIGlmIChvd25lciAhPT0gbnVsbCAmJiBvd25lci5zdGF0ZU5vZGUgIT09IG51bGwpIHsKICAgICAgICAgICAgICB2YXIgd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSBvd25lci5zdGF0ZU5vZGUuX3dhcm5lZEFib3V0UmVmc0luUmVuZGVyOwogICAgICAgICAgICAgIGlmICghd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIpIHsKICAgICAgICAgICAgICAgIGVycm9yKCIlcyBpcyBhY2Nlc3NpbmcgZmluZERPTU5vZGUgaW5zaWRlIGl0cyByZW5kZXIoKS4gcmVuZGVyKCkgc2hvdWxkIGJlIGEgcHVyZSBmdW5jdGlvbiBvZiBwcm9wcyBhbmQgc3RhdGUuIEl0IHNob3VsZCBuZXZlciBhY2Nlc3Mgc29tZXRoaW5nIHRoYXQgcmVxdWlyZXMgc3RhbGUgZGF0YSBmcm9tIHRoZSBwcmV2aW91cyByZW5kZXIsIHN1Y2ggYXMgcmVmcy4gTW92ZSB0aGlzIGxvZ2ljIHRvIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnREaWRVcGRhdGUgaW5zdGVhZC4iLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUob3duZXIudHlwZSkgfHwgIkEgY29tcG9uZW50Iik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG93bmVyLnN0YXRlTm9kZS5fd2FybmVkQWJvdXRSZWZzSW5SZW5kZXIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29tcG9uZW50T3JFbGVtZW50ID09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29tcG9uZW50T3JFbGVtZW50Lm5vZGVUeXBlID09PSBFTEVNRU5UX05PREUpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbXBvbmVudE9yRWxlbWVudDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZpbmRIb3N0SW5zdGFuY2VXaXRoV2FybmluZyhjb21wb25lbnRPckVsZW1lbnQsICJmaW5kRE9NTm9kZSIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlKGVsZW1lbnQsIGNvbnRhaW5lcjIsIGNhbGxiYWNrKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGVycm9yKCJSZWFjdERPTS5oeWRyYXRlIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIFVzZSBoeWRyYXRlUm9vdCBpbnN0ZWFkLiBVbnRpbCB5b3Ugc3dpdGNoIHRvIHRoZSBuZXcgQVBJLCB5b3VyIGFwcCB3aWxsIGJlaGF2ZSBhcyBpZiBpdCdzIHJ1bm5pbmcgUmVhY3QgMTcuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFpc1ZhbGlkQ29udGFpbmVyTGVnYWN5KGNvbnRhaW5lcjIpKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVGFyZ2V0IGNvbnRhaW5lciBpcyBub3QgYSBET00gZWxlbWVudC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGlzTW9kZXJuUm9vdCA9IGlzQ29udGFpbmVyTWFya2VkQXNSb290KGNvbnRhaW5lcjIpICYmIGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lciA9PT0gdm9pZCAwOwogICAgICAgICAgICBpZiAoaXNNb2Rlcm5Sb290KSB7CiAgICAgICAgICAgICAgZXJyb3IoIllvdSBhcmUgY2FsbGluZyBSZWFjdERPTS5oeWRyYXRlKCkgb24gYSBjb250YWluZXIgdGhhdCB3YXMgcHJldmlvdXNseSBwYXNzZWQgdG8gUmVhY3RET01DbGllbnQuY3JlYXRlUm9vdCgpLiBUaGlzIGlzIG5vdCBzdXBwb3J0ZWQuIERpZCB5b3UgbWVhbiB0byBjYWxsIGh5ZHJhdGVSb290KGNvbnRhaW5lciwgZWxlbWVudCk/Iik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBsZWdhY3lSZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lcihudWxsLCBlbGVtZW50LCBjb250YWluZXIyLCB0cnVlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHJlbmRlcihlbGVtZW50LCBjb250YWluZXIyLCBjYWxsYmFjaykgewogICAgICAgICAgewogICAgICAgICAgICBlcnJvcigiUmVhY3RET00ucmVuZGVyIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWQgaW4gUmVhY3QgMTguIFVzZSBjcmVhdGVSb290IGluc3RlYWQuIFVudGlsIHlvdSBzd2l0Y2ggdG8gdGhlIG5ldyBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgewogICAgICAgICAgICB2YXIgaXNNb2Rlcm5Sb290ID0gaXNDb250YWluZXJNYXJrZWRBc1Jvb3QoY29udGFpbmVyMikgJiYgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID09PSB2b2lkIDA7CiAgICAgICAgICAgIGlmIChpc01vZGVyblJvb3QpIHsKICAgICAgICAgICAgICBlcnJvcigiWW91IGFyZSBjYWxsaW5nIFJlYWN0RE9NLnJlbmRlcigpIG9uIGEgY29udGFpbmVyIHRoYXQgd2FzIHByZXZpb3VzbHkgcGFzc2VkIHRvIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCByb290LnJlbmRlcihlbGVtZW50KT8iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKG51bGwsIGVsZW1lbnQsIGNvbnRhaW5lcjIsIGZhbHNlLCBjYWxsYmFjayk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spIHsKICAgICAgICAgIHsKICAgICAgICAgICAgZXJyb3IoIlJlYWN0RE9NLnVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKCkgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCBpbiBSZWFjdCAxOC4gQ29uc2lkZXIgdXNpbmcgYSBwb3J0YWwgaW5zdGVhZC4gVW50aWwgeW91IHN3aXRjaCB0byB0aGUgY3JlYXRlUm9vdCBBUEksIHlvdXIgYXBwIHdpbGwgYmVoYXZlIGFzIGlmIGl0J3MgcnVubmluZyBSZWFjdCAxNy4gTGVhcm4gbW9yZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N3aXRjaC10by1jcmVhdGVyb290Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyTm9kZSkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJUYXJnZXQgY29udGFpbmVyIGlzIG5vdCBhIERPTSBlbGVtZW50LiIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHBhcmVudENvbXBvbmVudCA9PSBudWxsIHx8ICFoYXMzKHBhcmVudENvbXBvbmVudCkpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJwYXJlbnRDb21wb25lbnQgbXVzdCBiZSBhIHZhbGlkIFJlYWN0IENvbXBvbmVudCIpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGxlZ2FjeVJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgZmFsc2UsIGNhbGxiYWNrKTsKICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dFVubW91bnRDb21wb25lbnRBdE5vZGUgPSBmYWxzZTsKICAgICAgICBmdW5jdGlvbiB1bm1vdW50Q29tcG9uZW50QXROb2RlKGNvbnRhaW5lcjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRVbm1vdW50Q29tcG9uZW50QXROb2RlKSB7CiAgICAgICAgICAgICAgZGlkV2FybkFib3V0VW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IHRydWU7CiAgICAgICAgICAgICAgZXJyb3IoInVubW91bnRDb21wb25lbnRBdE5vZGUgaXMgZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIHRoZSBuZXh0IG1ham9yIHJlbGVhc2UuIFN3aXRjaCB0byB0aGUgY3JlYXRlUm9vdCBBUEkuIExlYXJuIG1vcmU6IGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zd2l0Y2gtdG8tY3JlYXRlcm9vdCIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIWlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyMikpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ1bm1vdW50Q29tcG9uZW50QXROb2RlKC4uLik6IFRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBpc01vZGVyblJvb3QgPSBpc0NvbnRhaW5lck1hcmtlZEFzUm9vdChjb250YWluZXIyKSAmJiBjb250YWluZXIyLl9yZWFjdFJvb3RDb250YWluZXIgPT09IHZvaWQgMDsKICAgICAgICAgICAgaWYgKGlzTW9kZXJuUm9vdCkgewogICAgICAgICAgICAgIGVycm9yKCJZb3UgYXJlIGNhbGxpbmcgUmVhY3RET00udW5tb3VudENvbXBvbmVudEF0Tm9kZSgpIG9uIGEgY29udGFpbmVyIHRoYXQgd2FzIHByZXZpb3VzbHkgcGFzc2VkIHRvIFJlYWN0RE9NQ2xpZW50LmNyZWF0ZVJvb3QoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBEaWQgeW91IG1lYW4gdG8gY2FsbCByb290LnVubW91bnQoKT8iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKGNvbnRhaW5lcjIuX3JlYWN0Um9vdENvbnRhaW5lcikgewogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdmFyIHJvb3RFbCA9IGdldFJlYWN0Um9vdEVsZW1lbnRJbkNvbnRhaW5lcihjb250YWluZXIyKTsKICAgICAgICAgICAgICB2YXIgcmVuZGVyZWRCeURpZmZlcmVudFJlYWN0ID0gcm9vdEVsICYmICFnZXRJbnN0YW5jZUZyb21Ob2RlKHJvb3RFbCk7CiAgICAgICAgICAgICAgaWYgKHJlbmRlcmVkQnlEaWZmZXJlbnRSZWFjdCkgewogICAgICAgICAgICAgICAgZXJyb3IoInVubW91bnRDb21wb25lbnRBdE5vZGUoKTogVGhlIG5vZGUgeW91J3JlIGF0dGVtcHRpbmcgdG8gdW5tb3VudCB3YXMgcmVuZGVyZWQgYnkgYW5vdGhlciBjb3B5IG9mIFJlYWN0LiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBmbHVzaFN5bmMoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgbGVnYWN5UmVuZGVyU3VidHJlZUludG9Db250YWluZXIobnVsbCwgbnVsbCwgY29udGFpbmVyMiwgZmFsc2UsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgY29udGFpbmVyMi5fcmVhY3RSb290Q29udGFpbmVyID0gbnVsbDsKICAgICAgICAgICAgICAgIHVubWFya0NvbnRhaW5lckFzUm9vdChjb250YWluZXIyKTsKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHZhciBfcm9vdEVsID0gZ2V0UmVhY3RSb290RWxlbWVudEluQ29udGFpbmVyKGNvbnRhaW5lcjIpOwogICAgICAgICAgICAgIHZhciBoYXNOb25Sb290UmVhY3RDaGlsZCA9ICEhKF9yb290RWwgJiYgZ2V0SW5zdGFuY2VGcm9tTm9kZShfcm9vdEVsKSk7CiAgICAgICAgICAgICAgdmFyIGlzQ29udGFpbmVyUmVhY3RSb290ID0gY29udGFpbmVyMi5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFICYmIGlzVmFsaWRDb250YWluZXJMZWdhY3koY29udGFpbmVyMi5wYXJlbnROb2RlKSAmJiAhIWNvbnRhaW5lcjIucGFyZW50Tm9kZS5fcmVhY3RSb290Q29udGFpbmVyOwogICAgICAgICAgICAgIGlmIChoYXNOb25Sb290UmVhY3RDaGlsZCkgewogICAgICAgICAgICAgICAgZXJyb3IoInVubW91bnRDb21wb25lbnRBdE5vZGUoKTogVGhlIG5vZGUgeW91J3JlIGF0dGVtcHRpbmcgdG8gdW5tb3VudCB3YXMgcmVuZGVyZWQgYnkgUmVhY3QgYW5kIGlzIG5vdCBhIHRvcC1sZXZlbCBjb250YWluZXIuICVzIiwgaXNDb250YWluZXJSZWFjdFJvb3QgPyAiWW91IG1heSBoYXZlIGFjY2lkZW50YWxseSBwYXNzZWQgaW4gYSBSZWFjdCByb290IG5vZGUgaW5zdGVhZCBvZiBpdHMgY29udGFpbmVyLiIgOiAiSW5zdGVhZCwgaGF2ZSB0aGUgcGFyZW50IGNvbXBvbmVudCB1cGRhdGUgaXRzIHN0YXRlIGFuZCByZXJlbmRlciBpbiBvcmRlciB0byByZW1vdmUgdGhpcyBjb21wb25lbnQuIik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc2V0QXR0ZW1wdFN5bmNocm9ub3VzSHlkcmF0aW9uKGF0dGVtcHRTeW5jaHJvbm91c0h5ZHJhdGlvbiQxKTsKICAgICAgICBzZXRBdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbihhdHRlbXB0Q29udGludW91c0h5ZHJhdGlvbiQxKTsKICAgICAgICBzZXRBdHRlbXB0SHlkcmF0aW9uQXRDdXJyZW50UHJpb3JpdHkoYXR0ZW1wdEh5ZHJhdGlvbkF0Q3VycmVudFByaW9yaXR5JDEpOwogICAgICAgIHNldEdldEN1cnJlbnRVcGRhdGVQcmlvcml0eShnZXRDdXJyZW50VXBkYXRlUHJpb3JpdHkpOwogICAgICAgIHNldEF0dGVtcHRIeWRyYXRpb25BdFByaW9yaXR5KHJ1bldpdGhQcmlvcml0eSk7CiAgICAgICAgewogICAgICAgICAgaWYgKHR5cGVvZiBNYXAgIT09ICJmdW5jdGlvbiIgfHwgLy8gJEZsb3dJc3N1ZSBGbG93IGluY29ycmVjdGx5IHRoaW5rcyBNYXAgaGFzIG5vIHByb3RvdHlwZQogICAgICAgICAgTWFwLnByb3RvdHlwZSA9PSBudWxsIHx8IHR5cGVvZiBNYXAucHJvdG90eXBlLmZvckVhY2ggIT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIFNldCAhPT0gImZ1bmN0aW9uIiB8fCAvLyAkRmxvd0lzc3VlIEZsb3cgaW5jb3JyZWN0bHkgdGhpbmtzIFNldCBoYXMgbm8gcHJvdG90eXBlCiAgICAgICAgICBTZXQucHJvdG90eXBlID09IG51bGwgfHwgdHlwZW9mIFNldC5wcm90b3R5cGUuY2xlYXIgIT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIFNldC5wcm90b3R5cGUuZm9yRWFjaCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICBlcnJvcigiUmVhY3QgZGVwZW5kcyBvbiBNYXAgYW5kIFNldCBidWlsdC1pbiB0eXBlcy4gTWFrZSBzdXJlIHRoYXQgeW91IGxvYWQgYSBwb2x5ZmlsbCBpbiBvbGRlciBicm93c2Vycy4gaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlYWN0LXBvbHlmaWxscyIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZXRSZXN0b3JlSW1wbGVtZW50YXRpb24ocmVzdG9yZUNvbnRyb2xsZWRTdGF0ZSQzKTsKICAgICAgICBzZXRCYXRjaGluZ0ltcGxlbWVudGF0aW9uKGJhdGNoZWRVcGRhdGVzJDEsIGRpc2NyZXRlVXBkYXRlcywgZmx1c2hTeW5jKTsKICAgICAgICBmdW5jdGlvbiBjcmVhdGVQb3J0YWwkMShjaGlsZHJlbiwgY29udGFpbmVyMikgewogICAgICAgICAgdmFyIGtleSA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzJdIDogbnVsbDsKICAgICAgICAgIGlmICghaXNWYWxpZENvbnRhaW5lcihjb250YWluZXIyKSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlRhcmdldCBjb250YWluZXIgaXMgbm90IGEgRE9NIGVsZW1lbnQuIik7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3JlYXRlUG9ydGFsMyhjaGlsZHJlbiwgY29udGFpbmVyMiwgbnVsbCwga2V5KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcmVuZGVyU3VidHJlZUludG9Db250YWluZXIocGFyZW50Q29tcG9uZW50LCBlbGVtZW50LCBjb250YWluZXJOb2RlLCBjYWxsYmFjaykgewogICAgICAgICAgcmV0dXJuIHVuc3RhYmxlX3JlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyKHBhcmVudENvbXBvbmVudCwgZWxlbWVudCwgY29udGFpbmVyTm9kZSwgY2FsbGJhY2spOwogICAgICAgIH0KICAgICAgICB2YXIgSW50ZXJuYWxzID0gewogICAgICAgICAgdXNpbmdDbGllbnRFbnRyeVBvaW50OiBmYWxzZSwKICAgICAgICAgIC8vIEtlZXAgaW4gc3luYyB3aXRoIFJlYWN0VGVzdFV0aWxzLmpzLgogICAgICAgICAgLy8gVGhpcyBpcyBhbiBhcnJheSBmb3IgYmV0dGVyIG1pbmlmaWNhdGlvbi4KICAgICAgICAgIEV2ZW50czogW2dldEluc3RhbmNlRnJvbU5vZGUsIGdldE5vZGVGcm9tSW5zdGFuY2UsIGdldEZpYmVyQ3VycmVudFByb3BzRnJvbU5vZGUsIGVucXVldWVTdGF0ZVJlc3RvcmUsIHJlc3RvcmVTdGF0ZUlmTmVlZGVkLCBiYXRjaGVkVXBkYXRlcyQxXQogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUm9vdCQxKGNvbnRhaW5lcjIsIG9wdGlvbnMyKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghSW50ZXJuYWxzLnVzaW5nQ2xpZW50RW50cnlQb2ludCAmJiB0cnVlKSB7CiAgICAgICAgICAgICAgZXJyb3IoJ1lvdSBhcmUgaW1wb3J0aW5nIGNyZWF0ZVJvb3QgZnJvbSAicmVhY3QtZG9tIiB3aGljaCBpcyBub3Qgc3VwcG9ydGVkLiBZb3Ugc2hvdWxkIGluc3RlYWQgaW1wb3J0IGl0IGZyb20gInJlYWN0LWRvbS9jbGllbnQiLicpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY3JlYXRlUm9vdDIoY29udGFpbmVyMiwgb3B0aW9uczIpOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBoeWRyYXRlUm9vdCQxKGNvbnRhaW5lcjIsIGluaXRpYWxDaGlsZHJlbiwgb3B0aW9uczIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKCFJbnRlcm5hbHMudXNpbmdDbGllbnRFbnRyeVBvaW50ICYmIHRydWUpIHsKICAgICAgICAgICAgICBlcnJvcignWW91IGFyZSBpbXBvcnRpbmcgaHlkcmF0ZVJvb3QgZnJvbSAicmVhY3QtZG9tIiB3aGljaCBpcyBub3Qgc3VwcG9ydGVkLiBZb3Ugc2hvdWxkIGluc3RlYWQgaW1wb3J0IGl0IGZyb20gInJlYWN0LWRvbS9jbGllbnQiLicpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gaHlkcmF0ZVJvb3QoY29udGFpbmVyMiwgaW5pdGlhbENoaWxkcmVuLCBvcHRpb25zMik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGZsdXNoU3luYyQxKGZuKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChpc0FscmVhZHlSZW5kZXJpbmcoKSkgewogICAgICAgICAgICAgIGVycm9yKCJmbHVzaFN5bmMgd2FzIGNhbGxlZCBmcm9tIGluc2lkZSBhIGxpZmVjeWNsZSBtZXRob2QuIFJlYWN0IGNhbm5vdCBmbHVzaCB3aGVuIFJlYWN0IGlzIGFscmVhZHkgcmVuZGVyaW5nLiBDb25zaWRlciBtb3ZpbmcgdGhpcyBjYWxsIHRvIGEgc2NoZWR1bGVyIHRhc2sgb3IgbWljcm8gdGFzay4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZsdXNoU3luYyhmbik7CiAgICAgICAgfQogICAgICAgIHZhciBmb3VuZERldlRvb2xzID0gaW5qZWN0SW50b0RldlRvb2xzKHsKICAgICAgICAgIGZpbmRGaWJlckJ5SG9zdEluc3RhbmNlOiBnZXRDbG9zZXN0SW5zdGFuY2VGcm9tTm9kZSwKICAgICAgICAgIGJ1bmRsZVR5cGU6IDEsCiAgICAgICAgICB2ZXJzaW9uOiBSZWFjdFZlcnNpb24sCiAgICAgICAgICByZW5kZXJlclBhY2thZ2VOYW1lOiAicmVhY3QtZG9tIgogICAgICAgIH0pOwogICAgICAgIHsKICAgICAgICAgIGlmICghZm91bmREZXZUb29scyAmJiBjYW5Vc2VET00yICYmIHdpbmRvdy50b3AgPT09IHdpbmRvdy5zZWxmKSB7CiAgICAgICAgICAgIGlmIChuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIkNocm9tZSIpID4gLTEgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJFZGdlIikgPT09IC0xIHx8IG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiRmlyZWZveCIpID4gLTEpIHsKICAgICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2w7CiAgICAgICAgICAgICAgaWYgKC9eKGh0dHBzP3xmaWxlKTokLy50ZXN0KHByb3RvY29sKSkgewogICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKCIlY0Rvd25sb2FkIHRoZSBSZWFjdCBEZXZUb29scyBmb3IgYSBiZXR0ZXIgZGV2ZWxvcG1lbnQgZXhwZXJpZW5jZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3JlYWN0LWRldnRvb2xzIiArIChwcm90b2NvbCA9PT0gImZpbGU6IiA/ICJcbllvdSBtaWdodCBuZWVkIHRvIHVzZSBhIGxvY2FsIEhUVFAgc2VydmVyIChpbnN0ZWFkIG9mIGZpbGU6Ly8pOiBodHRwczovL3JlYWN0anMub3JnL2xpbmsvcmVhY3QtZGV2dG9vbHMtZmFxIiA6ICIiKSwgImZvbnQtd2VpZ2h0OmJvbGQiKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXhwb3J0cy5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRCA9IEludGVybmFsczsKICAgICAgICBleHBvcnRzLmNyZWF0ZVBvcnRhbCA9IGNyZWF0ZVBvcnRhbCQxOwogICAgICAgIGV4cG9ydHMuY3JlYXRlUm9vdCA9IGNyZWF0ZVJvb3QkMTsKICAgICAgICBleHBvcnRzLmZpbmRET01Ob2RlID0gZmluZERPTU5vZGU7CiAgICAgICAgZXhwb3J0cy5mbHVzaFN5bmMgPSBmbHVzaFN5bmMkMTsKICAgICAgICBleHBvcnRzLmh5ZHJhdGUgPSBoeWRyYXRlOwogICAgICAgIGV4cG9ydHMuaHlkcmF0ZVJvb3QgPSBoeWRyYXRlUm9vdCQxOwogICAgICAgIGV4cG9ydHMucmVuZGVyID0gcmVuZGVyOwogICAgICAgIGV4cG9ydHMudW5tb3VudENvbXBvbmVudEF0Tm9kZSA9IHVubW91bnRDb21wb25lbnRBdE5vZGU7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9iYXRjaGVkVXBkYXRlcyA9IGJhdGNoZWRVcGRhdGVzJDE7CiAgICAgICAgZXhwb3J0cy51bnN0YWJsZV9yZW5kZXJTdWJ0cmVlSW50b0NvbnRhaW5lciA9IHJlbmRlclN1YnRyZWVJbnRvQ29udGFpbmVyOwogICAgICAgIGV4cG9ydHMudmVyc2lvbiA9IFJlYWN0VmVyc2lvbjsKICAgICAgICBpZiAodHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcCA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wKG5ldyBFcnJvcigpKTsKICAgICAgICB9CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvcmVhY3QtZG9tL2luZGV4LmpzCnZhciByZXF1aXJlX3JlYWN0X2RvbSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgY2hlY2tEQ0UoKTsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3JlYWN0X2RvbV9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0LWRvbS9jbGllbnQuanMKdmFyIHJlcXVpcmVfY2xpZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvcmVhY3QtZG9tL2NsaWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgdmFyIG0gPSByZXF1aXJlX3JlYWN0X2RvbSgpOwogICAgaWYgKGZhbHNlKSB7CiAgICAgIGV4cG9ydHMuY3JlYXRlUm9vdCA9IG0uY3JlYXRlUm9vdDsKICAgICAgZXhwb3J0cy5oeWRyYXRlUm9vdCA9IG0uaHlkcmF0ZVJvb3Q7CiAgICB9IGVsc2UgewogICAgICBpID0gbS5fX1NFQ1JFVF9JTlRFUk5BTFNfRE9fTk9UX1VTRV9PUl9ZT1VfV0lMTF9CRV9GSVJFRDsKICAgICAgZXhwb3J0cy5jcmVhdGVSb290ID0gZnVuY3Rpb24oYywgbykgewogICAgICAgIGkudXNpbmdDbGllbnRFbnRyeVBvaW50ID0gdHJ1ZTsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIG0uY3JlYXRlUm9vdChjLCBvKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaS51c2luZ0NsaWVudEVudHJ5UG9pbnQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIGV4cG9ydHMuaHlkcmF0ZVJvb3QgPSBmdW5jdGlvbihjLCBoLCBvKSB7CiAgICAgICAgaS51c2luZ0NsaWVudEVudHJ5UG9pbnQgPSB0cnVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXR1cm4gbS5oeWRyYXRlUm9vdChjLCBoLCBvKTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaS51c2luZ0NsaWVudEVudHJ5UG9pbnQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICB2YXIgaTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvX2ludGVybmFsL2lzVW5zYWZlUHJvcGVydHkuanMKdmFyIHJlcXVpcmVfaXNVbnNhZmVQcm9wZXJ0eSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9faW50ZXJuYWwvaXNVbnNhZmVQcm9wZXJ0eS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc1Vuc2FmZVByb3BlcnR5KGtleSkgewogICAgICByZXR1cm4ga2V5ID09PSAiX19wcm90b19fIjsKICAgIH0KICAgIGV4cG9ydHMuaXNVbnNhZmVQcm9wZXJ0eSA9IGlzVW5zYWZlUHJvcGVydHk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNEZWVwS2V5LmpzCnZhciByZXF1aXJlX2lzRGVlcEtleSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzRGVlcEtleS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc0RlZXBLZXkoa2V5KSB7CiAgICAgIHN3aXRjaCAodHlwZW9mIGtleSkgewogICAgICAgIGNhc2UgIm51bWJlciI6CiAgICAgICAgY2FzZSAic3ltYm9sIjogewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBjYXNlICJzdHJpbmciOiB7CiAgICAgICAgICByZXR1cm4ga2V5LmluY2x1ZGVzKCIuIikgfHwga2V5LmluY2x1ZGVzKCJbIikgfHwga2V5LmluY2x1ZGVzKCJdIik7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBleHBvcnRzLmlzRGVlcEtleSA9IGlzRGVlcEtleTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC90b0tleS5qcwp2YXIgcmVxdWlyZV90b0tleSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL3RvS2V5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIHRvS2V5KHZhbHVlKSB7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciIHx8IHR5cGVvZiB2YWx1ZSA9PT0gInN5bWJvbCIpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgaWYgKE9iamVjdC5pcyh2YWx1ZT8udmFsdWVPZj8uKCksIC0wKSkgewogICAgICAgIHJldHVybiAiLTAiOwogICAgICB9CiAgICAgIHJldHVybiBTdHJpbmcodmFsdWUpOwogICAgfQogICAgZXhwb3J0cy50b0tleSA9IHRvS2V5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b1N0cmluZy5qcwp2YXIgcmVxdWlyZV90b1N0cmluZyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b1N0cmluZy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiB0b1N0cmluZyh2YWx1ZSkgewogICAgICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgICAgIHJldHVybiAiIjsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgfQogICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdmFsdWUubWFwKHRvU3RyaW5nKS5qb2luKCIsIik7CiAgICAgIH0KICAgICAgY29uc3QgcmVzdWx0ID0gU3RyaW5nKHZhbHVlKTsKICAgICAgaWYgKHJlc3VsdCA9PT0gIjAiICYmIE9iamVjdC5pcyhOdW1iZXIodmFsdWUpLCAtMCkpIHsKICAgICAgICByZXR1cm4gIi0wIjsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZXhwb3J0cy50b1N0cmluZyA9IHRvU3RyaW5nOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC90b1BhdGguanMKdmFyIHJlcXVpcmVfdG9QYXRoID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvUGF0aC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgdG9TdHJpbmcgPSByZXF1aXJlX3RvU3RyaW5nKCk7CiAgICB2YXIgdG9LZXkgPSByZXF1aXJlX3RvS2V5KCk7CiAgICBmdW5jdGlvbiB0b1BhdGgoZGVlcEtleSkgewogICAgICBpZiAoQXJyYXkuaXNBcnJheShkZWVwS2V5KSkgewogICAgICAgIHJldHVybiBkZWVwS2V5Lm1hcCh0b0tleS50b0tleSk7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBkZWVwS2V5ID09PSAic3ltYm9sIikgewogICAgICAgIHJldHVybiBbZGVlcEtleV07CiAgICAgIH0KICAgICAgZGVlcEtleSA9IHRvU3RyaW5nLnRvU3RyaW5nKGRlZXBLZXkpOwogICAgICBjb25zdCByZXN1bHQgPSBbXTsKICAgICAgY29uc3QgbGVuZ3RoID0gZGVlcEtleS5sZW5ndGg7CiAgICAgIGlmIChsZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgIGxldCBrZXkgPSAiIjsKICAgICAgbGV0IHF1b3RlQ2hhciA9ICIiOwogICAgICBsZXQgYnJhY2tldCA9IGZhbHNlOwogICAgICBpZiAoZGVlcEtleS5jaGFyQ29kZUF0KDApID09PSA0NikgewogICAgICAgIHJlc3VsdC5wdXNoKCIiKTsKICAgICAgICBpbmRleCsrOwogICAgICB9CiAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgewogICAgICAgIGNvbnN0IGNoYXIgPSBkZWVwS2V5W2luZGV4XTsKICAgICAgICBpZiAocXVvdGVDaGFyKSB7CiAgICAgICAgICBpZiAoY2hhciA9PT0gIlxcIiAmJiBpbmRleCArIDEgPCBsZW5ndGgpIHsKICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAga2V5ICs9IGRlZXBLZXlbaW5kZXhdOwogICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSBxdW90ZUNoYXIpIHsKICAgICAgICAgICAgcXVvdGVDaGFyID0gIiI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrZXkgKz0gY2hhcjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGJyYWNrZXQpIHsKICAgICAgICAgIGlmIChjaGFyID09PSAnIicgfHwgY2hhciA9PT0gIiciKSB7CiAgICAgICAgICAgIHF1b3RlQ2hhciA9IGNoYXI7CiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICJdIikgewogICAgICAgICAgICBicmFja2V0ID0gZmFsc2U7CiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICAgICAgICAgIGtleSA9ICIiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga2V5ICs9IGNoYXI7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChjaGFyID09PSAiWyIpIHsKICAgICAgICAgICAgYnJhY2tldCA9IHRydWU7CiAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICByZXN1bHQucHVzaChrZXkpOwogICAgICAgICAgICAgIGtleSA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICIuIikgewogICAgICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgICAgcmVzdWx0LnB1c2goa2V5KTsKICAgICAgICAgICAgICBrZXkgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga2V5ICs9IGNoYXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGluZGV4Kys7CiAgICAgIH0KICAgICAgaWYgKGtleSkgewogICAgICAgIHJlc3VsdC5wdXNoKGtleSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGV4cG9ydHMudG9QYXRoID0gdG9QYXRoOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L2dldC5qcwp2YXIgcmVxdWlyZV9nZXQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9nZXQuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzVW5zYWZlUHJvcGVydHkgPSByZXF1aXJlX2lzVW5zYWZlUHJvcGVydHkoKTsKICAgIHZhciBpc0RlZXBLZXkgPSByZXF1aXJlX2lzRGVlcEtleSgpOwogICAgdmFyIHRvS2V5ID0gcmVxdWlyZV90b0tleSgpOwogICAgdmFyIHRvUGF0aCA9IHJlcXVpcmVfdG9QYXRoKCk7CiAgICBmdW5jdGlvbiBnZXQ2KG9iamVjdCwgcGF0aDIsIGRlZmF1bHRWYWx1ZSkgewogICAgICBpZiAob2JqZWN0ID09IG51bGwpIHsKICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICB9CiAgICAgIHN3aXRjaCAodHlwZW9mIHBhdGgyKSB7CiAgICAgICAgY2FzZSAic3RyaW5nIjogewogICAgICAgICAgaWYgKGlzVW5zYWZlUHJvcGVydHkuaXNVbnNhZmVQcm9wZXJ0eShwYXRoMikpIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IG9iamVjdFtwYXRoMl07CiAgICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKGlzRGVlcEtleS5pc0RlZXBLZXkocGF0aDIpKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGdldDYob2JqZWN0LCB0b1BhdGgudG9QYXRoKHBhdGgyKSwgZGVmYXVsdFZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgIGNhc2UgInN5bWJvbCI6IHsKICAgICAgICAgIGlmICh0eXBlb2YgcGF0aDIgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIHBhdGgyID0gdG9LZXkudG9LZXkocGF0aDIpOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgcmVzdWx0ID0gb2JqZWN0W3BhdGgyXTsKICAgICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocGF0aDIpKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRXaXRoUGF0aChvYmplY3QsIHBhdGgyLCBkZWZhdWx0VmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKE9iamVjdC5pcyhwYXRoMj8udmFsdWVPZigpLCAtMCkpIHsKICAgICAgICAgICAgcGF0aDIgPSAiLTAiOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcGF0aDIgPSBTdHJpbmcocGF0aDIpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzVW5zYWZlUHJvcGVydHkuaXNVbnNhZmVQcm9wZXJ0eShwYXRoMikpIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IG9iamVjdFtwYXRoMl07CiAgICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBnZXRXaXRoUGF0aChvYmplY3QsIHBhdGgyLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgaWYgKHBhdGgyLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgIH0KICAgICAgbGV0IGN1cnJlbnQzID0gb2JqZWN0OwogICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcGF0aDIubGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgaWYgKGN1cnJlbnQzID09IG51bGwpIHsKICAgICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICAgICAgfQogICAgICAgIGlmIChpc1Vuc2FmZVByb3BlcnR5LmlzVW5zYWZlUHJvcGVydHkocGF0aDJbaW5kZXhdKSkgewogICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgICB9CiAgICAgICAgY3VycmVudDMgPSBjdXJyZW50M1twYXRoMltpbmRleF1dOwogICAgICB9CiAgICAgIGlmIChjdXJyZW50MyA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gY3VycmVudDM7CiAgICB9CiAgICBleHBvcnRzLmdldCA9IGdldDY7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvZ2V0LmpzCnZhciByZXF1aXJlX2dldDIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9nZXQuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX2dldCgpLmdldDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvYXJyYXkvdW5pcUJ5LmpzCnZhciByZXF1aXJlX3VuaXFCeSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9hcnJheS91bmlxQnkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gdW5pcUJ5MihhcnIsIG1hcHBlcikgewogICAgICBjb25zdCBtYXAzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBpdGVtID0gYXJyW2ldOwogICAgICAgIGNvbnN0IGtleSA9IG1hcHBlcihpdGVtKTsKICAgICAgICBpZiAoIW1hcDMuaGFzKGtleSkpIHsKICAgICAgICAgIG1hcDMuc2V0KGtleSwgaXRlbSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBBcnJheS5mcm9tKG1hcDMudmFsdWVzKCkpOwogICAgfQogICAgZXhwb3J0cy51bmlxQnkgPSB1bmlxQnkyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9mdW5jdGlvbi9pZGVudGl0eS5qcwp2YXIgcmVxdWlyZV9pZGVudGl0eSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9mdW5jdGlvbi9pZGVudGl0eS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpZGVudGl0eTQoeDIpIHsKICAgICAgcmV0dXJuIHgyOwogICAgfQogICAgZXhwb3J0cy5pZGVudGl0eSA9IGlkZW50aXR5NDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzTGVuZ3RoLmpzCnZhciByZXF1aXJlX2lzTGVuZ3RoID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L3ByZWRpY2F0ZS9pc0xlbmd0aC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBpc0xlbmd0aCh2YWx1ZSkgewogICAgICByZXR1cm4gTnVtYmVyLmlzU2FmZUludGVnZXIodmFsdWUpICYmIHZhbHVlID49IDA7CiAgICB9CiAgICBleHBvcnRzLmlzTGVuZ3RoID0gaXNMZW5ndGg7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNBcnJheUxpa2UuanMKdmFyIHJlcXVpcmVfaXNBcnJheUxpa2UgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FycmF5TGlrZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNMZW5ndGggPSByZXF1aXJlX2lzTGVuZ3RoKCk7CiAgICBmdW5jdGlvbiBpc0FycmF5TGlrZSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgIT09ICJmdW5jdGlvbiIgJiYgaXNMZW5ndGguaXNMZW5ndGgodmFsdWUubGVuZ3RoKTsKICAgIH0KICAgIGV4cG9ydHMuaXNBcnJheUxpa2UgPSBpc0FycmF5TGlrZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc09iamVjdExpa2UuanMKdmFyIHJlcXVpcmVfaXNPYmplY3RMaWtlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNPYmplY3RMaWtlLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzT2JqZWN0TGlrZSh2YWx1ZSkgewogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB2YWx1ZSAhPT0gbnVsbDsKICAgIH0KICAgIGV4cG9ydHMuaXNPYmplY3RMaWtlID0gaXNPYmplY3RMaWtlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzQXJyYXlMaWtlT2JqZWN0LmpzCnZhciByZXF1aXJlX2lzQXJyYXlMaWtlT2JqZWN0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNBcnJheUxpa2VPYmplY3QuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzQXJyYXlMaWtlID0gcmVxdWlyZV9pc0FycmF5TGlrZSgpOwogICAgdmFyIGlzT2JqZWN0TGlrZSA9IHJlcXVpcmVfaXNPYmplY3RMaWtlKCk7CiAgICBmdW5jdGlvbiBpc0FycmF5TGlrZU9iamVjdCh2YWx1ZSkgewogICAgICByZXR1cm4gaXNPYmplY3RMaWtlLmlzT2JqZWN0TGlrZSh2YWx1ZSkgJiYgaXNBcnJheUxpa2UuaXNBcnJheUxpa2UodmFsdWUpOwogICAgfQogICAgZXhwb3J0cy5pc0FycmF5TGlrZU9iamVjdCA9IGlzQXJyYXlMaWtlT2JqZWN0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L3Byb3BlcnR5LmpzCnZhciByZXF1aXJlX3Byb3BlcnR5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvcHJvcGVydHkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGdldDYgPSByZXF1aXJlX2dldCgpOwogICAgZnVuY3Rpb24gcHJvcGVydHkocGF0aDIpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKG9iamVjdCkgewogICAgICAgIHJldHVybiBnZXQ2LmdldChvYmplY3QsIHBhdGgyKTsKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMucHJvcGVydHkgPSBwcm9wZXJ0eTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc09iamVjdC5qcwp2YXIgcmVxdWlyZV9pc09iamVjdCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzT2JqZWN0LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSAhPT0gbnVsbCAmJiAodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiB8fCB0eXBlb2YgdmFsdWUgPT09ICJmdW5jdGlvbiIpOwogICAgfQogICAgZXhwb3J0cy5pc09iamVjdCA9IGlzT2JqZWN0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNQcmltaXRpdmUuanMKdmFyIHJlcXVpcmVfaXNQcmltaXRpdmUgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvcHJlZGljYXRlL2lzUHJpbWl0aXZlLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzUHJpbWl0aXZlKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSAhPT0gIm9iamVjdCIgJiYgdHlwZW9mIHZhbHVlICE9PSAiZnVuY3Rpb24iOwogICAgfQogICAgZXhwb3J0cy5pc1ByaW1pdGl2ZSA9IGlzUHJpbWl0aXZlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC9lcS5qcwp2YXIgcmVxdWlyZV9lcSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC9lcS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBlcSh2YWx1ZSwgb3RoZXIpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSBvdGhlciB8fCBOdW1iZXIuaXNOYU4odmFsdWUpICYmIE51bWJlci5pc05hTihvdGhlcik7CiAgICB9CiAgICBleHBvcnRzLmVxID0gZXE7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNNYXRjaFdpdGguanMKdmFyIHJlcXVpcmVfaXNNYXRjaFdpdGggPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc01hdGNoV2l0aC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNPYmplY3QgPSByZXF1aXJlX2lzT2JqZWN0KCk7CiAgICB2YXIgaXNQcmltaXRpdmUgPSByZXF1aXJlX2lzUHJpbWl0aXZlKCk7CiAgICB2YXIgZXEgPSByZXF1aXJlX2VxKCk7CiAgICBmdW5jdGlvbiBpc01hdGNoV2l0aCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSkgewogICAgICBpZiAodHlwZW9mIGNvbXBhcmUgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICByZXR1cm4gaXNNYXRjaFdpdGgodGFyZ2V0LCBzb3VyY2UsICgpID0+IHZvaWQgMCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGlzTWF0Y2hXaXRoSW50ZXJuYWwodGFyZ2V0LCBzb3VyY2UsIGZ1bmN0aW9uIGRvZXNNYXRjaChvYmpWYWx1ZSwgc3JjVmFsdWUsIGtleSwgb2JqZWN0LCBzb3VyY2UyLCBzdGFjaykgewogICAgICAgIGNvbnN0IGlzRXF1YWwgPSBjb21wYXJlKG9ialZhbHVlLCBzcmNWYWx1ZSwga2V5LCBvYmplY3QsIHNvdXJjZTIsIHN0YWNrKTsKICAgICAgICBpZiAoaXNFcXVhbCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICByZXR1cm4gQm9vbGVhbihpc0VxdWFsKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGlzTWF0Y2hXaXRoSW50ZXJuYWwob2JqVmFsdWUsIHNyY1ZhbHVlLCBkb2VzTWF0Y2gsIHN0YWNrKTsKICAgICAgfSwgLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSk7CiAgICB9CiAgICBmdW5jdGlvbiBpc01hdGNoV2l0aEludGVybmFsKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjaykgewogICAgICBpZiAoc291cmNlID09PSB0YXJnZXQpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBzd2l0Y2ggKHR5cGVvZiBzb3VyY2UpIHsKICAgICAgICBjYXNlICJvYmplY3QiOiB7CiAgICAgICAgICByZXR1cm4gaXNPYmplY3RNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spOwogICAgICAgIH0KICAgICAgICBjYXNlICJmdW5jdGlvbiI6IHsKICAgICAgICAgIGNvbnN0IHNvdXJjZUtleXMgPSBPYmplY3Qua2V5cyhzb3VyY2UpOwogICAgICAgICAgaWYgKHNvdXJjZUtleXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICByZXR1cm4gaXNNYXRjaFdpdGhJbnRlcm5hbCh0YXJnZXQsIHsgLi4uc291cmNlIH0sIGNvbXBhcmUsIHN0YWNrKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlcS5lcSh0YXJnZXQsIHNvdXJjZSk7CiAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgIGlmICghaXNPYmplY3QuaXNPYmplY3QodGFyZ2V0KSkgewogICAgICAgICAgICByZXR1cm4gZXEuZXEodGFyZ2V0LCBzb3VyY2UpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiBzb3VyY2UgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIHJldHVybiBzb3VyY2UgPT09ICIiOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpc09iamVjdE1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjaykgewogICAgICBpZiAoc291cmNlID09IG51bGwpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoQXJyYXkuaXNBcnJheShzb3VyY2UpKSB7CiAgICAgICAgcmV0dXJuIGlzQXJyYXlNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spOwogICAgICB9CiAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBNYXApIHsKICAgICAgICByZXR1cm4gaXNNYXBNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spOwogICAgICB9CiAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBTZXQpIHsKICAgICAgICByZXR1cm4gaXNTZXRNYXRjaCh0YXJnZXQsIHNvdXJjZSwgY29tcGFyZSwgc3RhY2spOwogICAgICB9CiAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhzb3VyY2UpOwogICAgICBpZiAodGFyZ2V0ID09IG51bGwpIHsKICAgICAgICByZXR1cm4ga2V5cy5sZW5ndGggPT09IDA7CiAgICAgIH0KICAgICAgaWYgKGtleXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKHN0YWNrPy5oYXMoc291cmNlKSkgewogICAgICAgIHJldHVybiBzdGFjay5nZXQoc291cmNlKSA9PT0gdGFyZ2V0OwogICAgICB9CiAgICAgIHN0YWNrPy5zZXQoc291cmNlLCB0YXJnZXQpOwogICAgICB0cnkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3Qga2V5ID0ga2V5c1tpXTsKICAgICAgICAgIGlmICghaXNQcmltaXRpdmUuaXNQcmltaXRpdmUodGFyZ2V0KSAmJiAhKGtleSBpbiB0YXJnZXQpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChzb3VyY2Vba2V5XSA9PT0gdm9pZCAwICYmIHRhcmdldFtrZXldICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHNvdXJjZVtrZXldID09PSBudWxsICYmIHRhcmdldFtrZXldICE9PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IGlzRXF1YWwgPSBjb21wYXJlKHRhcmdldFtrZXldLCBzb3VyY2Vba2V5XSwga2V5LCB0YXJnZXQsIHNvdXJjZSwgc3RhY2spOwogICAgICAgICAgaWYgKCFpc0VxdWFsKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgc3RhY2s/LmRlbGV0ZShzb3VyY2UpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBpc01hcE1hdGNoKHRhcmdldCwgc291cmNlLCBjb21wYXJlLCBzdGFjaykgewogICAgICBpZiAoc291cmNlLnNpemUgPT09IDApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoISh0YXJnZXQgaW5zdGFuY2VvZiBNYXApKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGZvciAoY29uc3QgW2tleSwgc291cmNlVmFsdWVdIG9mIHNvdXJjZS5lbnRyaWVzKCkpIHsKICAgICAgICBjb25zdCB0YXJnZXRWYWx1ZSA9IHRhcmdldC5nZXQoa2V5KTsKICAgICAgICBjb25zdCBpc0VxdWFsID0gY29tcGFyZSh0YXJnZXRWYWx1ZSwgc291cmNlVmFsdWUsIGtleSwgdGFyZ2V0LCBzb3VyY2UsIHN0YWNrKTsKICAgICAgICBpZiAoaXNFcXVhbCA9PT0gZmFsc2UpIHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBmdW5jdGlvbiBpc0FycmF5TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKSB7CiAgICAgIGlmIChzb3VyY2UubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRhcmdldCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgY29uc3QgY291bnRlZEluZGV4ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzb3VyY2UubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBzb3VyY2VJdGVtID0gc291cmNlW2ldOwogICAgICAgIGxldCBmb3VuZCA9IGZhbHNlOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGFyZ2V0Lmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBpZiAoY291bnRlZEluZGV4LmhhcyhqKSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHRhcmdldEl0ZW0gPSB0YXJnZXRbal07CiAgICAgICAgICBsZXQgbWF0Y2hlczIgPSBmYWxzZTsKICAgICAgICAgIGNvbnN0IGlzRXF1YWwgPSBjb21wYXJlKHRhcmdldEl0ZW0sIHNvdXJjZUl0ZW0sIGksIHRhcmdldCwgc291cmNlLCBzdGFjayk7CiAgICAgICAgICBpZiAoaXNFcXVhbCkgewogICAgICAgICAgICBtYXRjaGVzMiA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAobWF0Y2hlczIpIHsKICAgICAgICAgICAgY291bnRlZEluZGV4LmFkZChqKTsKICAgICAgICAgICAgZm91bmQgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFmb3VuZCkgewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGZ1bmN0aW9uIGlzU2V0TWF0Y2godGFyZ2V0LCBzb3VyY2UsIGNvbXBhcmUsIHN0YWNrKSB7CiAgICAgIGlmIChzb3VyY2Uuc2l6ZSA9PT0gMCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmICghKHRhcmdldCBpbnN0YW5jZW9mIFNldCkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIGlzQXJyYXlNYXRjaChbLi4udGFyZ2V0XSwgWy4uLnNvdXJjZV0sIGNvbXBhcmUsIHN0YWNrKTsKICAgIH0KICAgIGV4cG9ydHMuaXNNYXRjaFdpdGggPSBpc01hdGNoV2l0aDsKICAgIGV4cG9ydHMuaXNTZXRNYXRjaCA9IGlzU2V0TWF0Y2g7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNNYXRjaC5qcwp2YXIgcmVxdWlyZV9pc01hdGNoID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNNYXRjaC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNNYXRjaFdpdGggPSByZXF1aXJlX2lzTWF0Y2hXaXRoKCk7CiAgICBmdW5jdGlvbiBpc01hdGNoKHRhcmdldCwgc291cmNlKSB7CiAgICAgIHJldHVybiBpc01hdGNoV2l0aC5pc01hdGNoV2l0aCh0YXJnZXQsIHNvdXJjZSwgKCkgPT4gdm9pZCAwKTsKICAgIH0KICAgIGV4cG9ydHMuaXNNYXRjaCA9IGlzTWF0Y2g7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvZ2V0U3ltYm9scy5qcwp2YXIgcmVxdWlyZV9nZXRTeW1ib2xzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvZ2V0U3ltYm9scy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBnZXRTeW1ib2xzKG9iamVjdCkgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhvYmplY3QpLmZpbHRlcigoc3ltYm9sKSA9PiBPYmplY3QucHJvdG90eXBlLnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwob2JqZWN0LCBzeW1ib2wpKTsKICAgIH0KICAgIGV4cG9ydHMuZ2V0U3ltYm9scyA9IGdldFN5bWJvbHM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvZ2V0VGFnLmpzCnZhciByZXF1aXJlX2dldFRhZyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2dldFRhZy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBnZXRUYWcodmFsdWUpIHsKICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsKICAgICAgICByZXR1cm4gdmFsdWUgPT09IHZvaWQgMCA/ICJbb2JqZWN0IFVuZGVmaW5lZF0iIDogIltvYmplY3QgTnVsbF0iOwogICAgICB9CiAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpOwogICAgfQogICAgZXhwb3J0cy5nZXRUYWcgPSBnZXRUYWc7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdGFncy5qcwp2YXIgcmVxdWlyZV90YWdzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdGFncy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgcmVnZXhwVGFnID0gIltvYmplY3QgUmVnRXhwXSI7CiAgICB2YXIgc3RyaW5nVGFnID0gIltvYmplY3QgU3RyaW5nXSI7CiAgICB2YXIgbnVtYmVyVGFnID0gIltvYmplY3QgTnVtYmVyXSI7CiAgICB2YXIgYm9vbGVhblRhZyA9ICJbb2JqZWN0IEJvb2xlYW5dIjsKICAgIHZhciBhcmd1bWVudHNUYWcgPSAiW29iamVjdCBBcmd1bWVudHNdIjsKICAgIHZhciBzeW1ib2xUYWcgPSAiW29iamVjdCBTeW1ib2xdIjsKICAgIHZhciBkYXRlVGFnID0gIltvYmplY3QgRGF0ZV0iOwogICAgdmFyIG1hcFRhZyA9ICJbb2JqZWN0IE1hcF0iOwogICAgdmFyIHNldFRhZyA9ICJbb2JqZWN0IFNldF0iOwogICAgdmFyIGFycmF5VGFnID0gIltvYmplY3QgQXJyYXldIjsKICAgIHZhciBmdW5jdGlvblRhZyA9ICJbb2JqZWN0IEZ1bmN0aW9uXSI7CiAgICB2YXIgYXJyYXlCdWZmZXJUYWcgPSAiW29iamVjdCBBcnJheUJ1ZmZlcl0iOwogICAgdmFyIG9iamVjdFRhZyA9ICJbb2JqZWN0IE9iamVjdF0iOwogICAgdmFyIGVycm9yVGFnID0gIltvYmplY3QgRXJyb3JdIjsKICAgIHZhciBkYXRhVmlld1RhZyA9ICJbb2JqZWN0IERhdGFWaWV3XSI7CiAgICB2YXIgdWludDhBcnJheVRhZyA9ICJbb2JqZWN0IFVpbnQ4QXJyYXldIjsKICAgIHZhciB1aW50OENsYW1wZWRBcnJheVRhZyA9ICJbb2JqZWN0IFVpbnQ4Q2xhbXBlZEFycmF5XSI7CiAgICB2YXIgdWludDE2QXJyYXlUYWcgPSAiW29iamVjdCBVaW50MTZBcnJheV0iOwogICAgdmFyIHVpbnQzMkFycmF5VGFnID0gIltvYmplY3QgVWludDMyQXJyYXldIjsKICAgIHZhciBiaWdVaW50NjRBcnJheVRhZyA9ICJbb2JqZWN0IEJpZ1VpbnQ2NEFycmF5XSI7CiAgICB2YXIgaW50OEFycmF5VGFnID0gIltvYmplY3QgSW50OEFycmF5XSI7CiAgICB2YXIgaW50MTZBcnJheVRhZyA9ICJbb2JqZWN0IEludDE2QXJyYXldIjsKICAgIHZhciBpbnQzMkFycmF5VGFnID0gIltvYmplY3QgSW50MzJBcnJheV0iOwogICAgdmFyIGJpZ0ludDY0QXJyYXlUYWcgPSAiW29iamVjdCBCaWdJbnQ2NEFycmF5XSI7CiAgICB2YXIgZmxvYXQzMkFycmF5VGFnID0gIltvYmplY3QgRmxvYXQzMkFycmF5XSI7CiAgICB2YXIgZmxvYXQ2NEFycmF5VGFnID0gIltvYmplY3QgRmxvYXQ2NEFycmF5XSI7CiAgICBleHBvcnRzLmFyZ3VtZW50c1RhZyA9IGFyZ3VtZW50c1RhZzsKICAgIGV4cG9ydHMuYXJyYXlCdWZmZXJUYWcgPSBhcnJheUJ1ZmZlclRhZzsKICAgIGV4cG9ydHMuYXJyYXlUYWcgPSBhcnJheVRhZzsKICAgIGV4cG9ydHMuYmlnSW50NjRBcnJheVRhZyA9IGJpZ0ludDY0QXJyYXlUYWc7CiAgICBleHBvcnRzLmJpZ1VpbnQ2NEFycmF5VGFnID0gYmlnVWludDY0QXJyYXlUYWc7CiAgICBleHBvcnRzLmJvb2xlYW5UYWcgPSBib29sZWFuVGFnOwogICAgZXhwb3J0cy5kYXRhVmlld1RhZyA9IGRhdGFWaWV3VGFnOwogICAgZXhwb3J0cy5kYXRlVGFnID0gZGF0ZVRhZzsKICAgIGV4cG9ydHMuZXJyb3JUYWcgPSBlcnJvclRhZzsKICAgIGV4cG9ydHMuZmxvYXQzMkFycmF5VGFnID0gZmxvYXQzMkFycmF5VGFnOwogICAgZXhwb3J0cy5mbG9hdDY0QXJyYXlUYWcgPSBmbG9hdDY0QXJyYXlUYWc7CiAgICBleHBvcnRzLmZ1bmN0aW9uVGFnID0gZnVuY3Rpb25UYWc7CiAgICBleHBvcnRzLmludDE2QXJyYXlUYWcgPSBpbnQxNkFycmF5VGFnOwogICAgZXhwb3J0cy5pbnQzMkFycmF5VGFnID0gaW50MzJBcnJheVRhZzsKICAgIGV4cG9ydHMuaW50OEFycmF5VGFnID0gaW50OEFycmF5VGFnOwogICAgZXhwb3J0cy5tYXBUYWcgPSBtYXBUYWc7CiAgICBleHBvcnRzLm51bWJlclRhZyA9IG51bWJlclRhZzsKICAgIGV4cG9ydHMub2JqZWN0VGFnID0gb2JqZWN0VGFnOwogICAgZXhwb3J0cy5yZWdleHBUYWcgPSByZWdleHBUYWc7CiAgICBleHBvcnRzLnNldFRhZyA9IHNldFRhZzsKICAgIGV4cG9ydHMuc3RyaW5nVGFnID0gc3RyaW5nVGFnOwogICAgZXhwb3J0cy5zeW1ib2xUYWcgPSBzeW1ib2xUYWc7CiAgICBleHBvcnRzLnVpbnQxNkFycmF5VGFnID0gdWludDE2QXJyYXlUYWc7CiAgICBleHBvcnRzLnVpbnQzMkFycmF5VGFnID0gdWludDMyQXJyYXlUYWc7CiAgICBleHBvcnRzLnVpbnQ4QXJyYXlUYWcgPSB1aW50OEFycmF5VGFnOwogICAgZXhwb3J0cy51aW50OENsYW1wZWRBcnJheVRhZyA9IHVpbnQ4Q2xhbXBlZEFycmF5VGFnOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNUeXBlZEFycmF5LmpzCnZhciByZXF1aXJlX2lzVHlwZWRBcnJheSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9wcmVkaWNhdGUvaXNUeXBlZEFycmF5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzVHlwZWRBcnJheSh4MikgewogICAgICByZXR1cm4gQXJyYXlCdWZmZXIuaXNWaWV3KHgyKSAmJiAhKHgyIGluc3RhbmNlb2YgRGF0YVZpZXcpOwogICAgfQogICAgZXhwb3J0cy5pc1R5cGVkQXJyYXkgPSBpc1R5cGVkQXJyYXk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L29iamVjdC9jbG9uZURlZXBXaXRoLmpzCnZhciByZXF1aXJlX2Nsb25lRGVlcFdpdGggPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3Qvb2JqZWN0L2Nsb25lRGVlcFdpdGguanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGdldFN5bWJvbHMgPSByZXF1aXJlX2dldFN5bWJvbHMoKTsKICAgIHZhciBnZXRUYWcgPSByZXF1aXJlX2dldFRhZygpOwogICAgdmFyIHRhZ3MgPSByZXF1aXJlX3RhZ3MoKTsKICAgIHZhciBpc1ByaW1pdGl2ZSA9IHJlcXVpcmVfaXNQcmltaXRpdmUoKTsKICAgIHZhciBpc1R5cGVkQXJyYXkgPSByZXF1aXJlX2lzVHlwZWRBcnJheSgpOwogICAgZnVuY3Rpb24gY2xvbmVEZWVwV2l0aChvYmosIGNsb25lVmFsdWUpIHsKICAgICAgcmV0dXJuIGNsb25lRGVlcFdpdGhJbXBsKG9iaiwgdm9pZCAwLCBvYmosIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCksIGNsb25lVmFsdWUpOwogICAgfQogICAgZnVuY3Rpb24gY2xvbmVEZWVwV2l0aEltcGwodmFsdWVUb0Nsb25lLCBrZXlUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjayA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCksIGNsb25lVmFsdWUgPSB2b2lkIDApIHsKICAgICAgY29uc3QgY2xvbmVkID0gY2xvbmVWYWx1ZT8uKHZhbHVlVG9DbG9uZSwga2V5VG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2spOwogICAgICBpZiAoY2xvbmVkICE9PSB2b2lkIDApIHsKICAgICAgICByZXR1cm4gY2xvbmVkOwogICAgICB9CiAgICAgIGlmIChpc1ByaW1pdGl2ZS5pc1ByaW1pdGl2ZSh2YWx1ZVRvQ2xvbmUpKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlVG9DbG9uZTsKICAgICAgfQogICAgICBpZiAoc3RhY2suaGFzKHZhbHVlVG9DbG9uZSkpIHsKICAgICAgICByZXR1cm4gc3RhY2suZ2V0KHZhbHVlVG9DbG9uZSk7CiAgICAgIH0KICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWVUb0Nsb25lKSkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBBcnJheSh2YWx1ZVRvQ2xvbmUubGVuZ3RoKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWVUb0Nsb25lLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICByZXN1bHRbaV0gPSBjbG9uZURlZXBXaXRoSW1wbCh2YWx1ZVRvQ2xvbmVbaV0sIGksIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICB9CiAgICAgICAgaWYgKE9iamVjdC5oYXNPd24odmFsdWVUb0Nsb25lLCAiaW5kZXgiKSkgewogICAgICAgICAgcmVzdWx0LmluZGV4ID0gdmFsdWVUb0Nsb25lLmluZGV4OwogICAgICAgIH0KICAgICAgICBpZiAoT2JqZWN0Lmhhc093bih2YWx1ZVRvQ2xvbmUsICJpbnB1dCIpKSB7CiAgICAgICAgICByZXN1bHQuaW5wdXQgPSB2YWx1ZVRvQ2xvbmUuaW5wdXQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgICByZXR1cm4gbmV3IERhdGUodmFsdWVUb0Nsb25lLmdldFRpbWUoKSk7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBSZWdFeHAodmFsdWVUb0Nsb25lLnNvdXJjZSwgdmFsdWVUb0Nsb25lLmZsYWdzKTsKICAgICAgICByZXN1bHQubGFzdEluZGV4ID0gdmFsdWVUb0Nsb25lLmxhc3RJbmRleDsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBNYXApIHsKICAgICAgICBjb25zdCByZXN1bHQgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgdmFsdWVUb0Nsb25lKSB7CiAgICAgICAgICByZXN1bHQuc2V0KGtleSwgY2xvbmVEZWVwV2l0aEltcGwodmFsdWUsIGtleSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgU2V0KSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVUb0Nsb25lKSB7CiAgICAgICAgICByZXN1bHQuYWRkKGNsb25lRGVlcFdpdGhJbXBsKHZhbHVlLCB2b2lkIDAsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBCdWZmZXIgIT09ICJ1bmRlZmluZWQiICYmIEJ1ZmZlci5pc0J1ZmZlcih2YWx1ZVRvQ2xvbmUpKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlVG9DbG9uZS5zdWJhcnJheSgpOwogICAgICB9CiAgICAgIGlmIChpc1R5cGVkQXJyYXkuaXNUeXBlZEFycmF5KHZhbHVlVG9DbG9uZSkpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgKE9iamVjdC5nZXRQcm90b3R5cGVPZih2YWx1ZVRvQ2xvbmUpKS5jb25zdHJ1Y3Rvcih2YWx1ZVRvQ2xvbmUubGVuZ3RoKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWVUb0Nsb25lLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICByZXN1bHRbaV0gPSBjbG9uZURlZXBXaXRoSW1wbCh2YWx1ZVRvQ2xvbmVbaV0sIGksIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIgfHwgdHlwZW9mIFNoYXJlZEFycmF5QnVmZmVyICE9PSAidW5kZWZpbmVkIiAmJiB2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBTaGFyZWRBcnJheUJ1ZmZlcikgewogICAgICAgIHJldHVybiB2YWx1ZVRvQ2xvbmUuc2xpY2UoMCk7CiAgICAgIH0KICAgICAgaWYgKHZhbHVlVG9DbG9uZSBpbnN0YW5jZW9mIERhdGFWaWV3KSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IERhdGFWaWV3KHZhbHVlVG9DbG9uZS5idWZmZXIuc2xpY2UoMCksIHZhbHVlVG9DbG9uZS5ieXRlT2Zmc2V0LCB2YWx1ZVRvQ2xvbmUuYnl0ZUxlbmd0aCk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBjb3B5UHJvcGVydGllcyhyZXN1bHQsIHZhbHVlVG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBGaWxlICE9PSAidW5kZWZpbmVkIiAmJiB2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBGaWxlKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IEZpbGUoW3ZhbHVlVG9DbG9uZV0sIHZhbHVlVG9DbG9uZS5uYW1lLCB7CiAgICAgICAgICB0eXBlOiB2YWx1ZVRvQ2xvbmUudHlwZQogICAgICAgIH0pOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgQmxvYiAhPT0gInVuZGVmaW5lZCIgJiYgdmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgQmxvYikgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBCbG9iKFt2YWx1ZVRvQ2xvbmVdLCB7IHR5cGU6IHZhbHVlVG9DbG9uZS50eXBlIH0pOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyB2YWx1ZVRvQ2xvbmUuY29uc3RydWN0b3IoKTsKICAgICAgICBzdGFjay5zZXQodmFsdWVUb0Nsb25lLCByZXN1bHQpOwogICAgICAgIHJlc3VsdC5tZXNzYWdlID0gdmFsdWVUb0Nsb25lLm1lc3NhZ2U7CiAgICAgICAgcmVzdWx0Lm5hbWUgPSB2YWx1ZVRvQ2xvbmUubmFtZTsKICAgICAgICByZXN1bHQuc3RhY2sgPSB2YWx1ZVRvQ2xvbmUuc3RhY2s7CiAgICAgICAgcmVzdWx0LmNhdXNlID0gdmFsdWVUb0Nsb25lLmNhdXNlOwogICAgICAgIGNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgdmFsdWVUb0Nsb25lLCBvYmplY3RUb0Nsb25lLCBzdGFjaywgY2xvbmVWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICBpZiAodmFsdWVUb0Nsb25lIGluc3RhbmNlb2YgQm9vbGVhbikgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBCb29sZWFuKHZhbHVlVG9DbG9uZS52YWx1ZU9mKCkpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBOdW1iZXIpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgTnVtYmVyKHZhbHVlVG9DbG9uZS52YWx1ZU9mKCkpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh2YWx1ZVRvQ2xvbmUgaW5zdGFuY2VvZiBTdHJpbmcpIHsKICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgU3RyaW5nKHZhbHVlVG9DbG9uZS52YWx1ZU9mKCkpOwogICAgICAgIHN0YWNrLnNldCh2YWx1ZVRvQ2xvbmUsIHJlc3VsdCk7CiAgICAgICAgY29weVByb3BlcnRpZXMocmVzdWx0LCB2YWx1ZVRvQ2xvbmUsIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgdmFsdWVUb0Nsb25lID09PSAib2JqZWN0IiAmJiBpc0Nsb25lYWJsZU9iamVjdCh2YWx1ZVRvQ2xvbmUpKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gT2JqZWN0LmNyZWF0ZShPYmplY3QuZ2V0UHJvdG90eXBlT2YodmFsdWVUb0Nsb25lKSk7CiAgICAgICAgc3RhY2suc2V0KHZhbHVlVG9DbG9uZSwgcmVzdWx0KTsKICAgICAgICBjb3B5UHJvcGVydGllcyhyZXN1bHQsIHZhbHVlVG9DbG9uZSwgb2JqZWN0VG9DbG9uZSwgc3RhY2ssIGNsb25lVmFsdWUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIHZhbHVlVG9DbG9uZTsKICAgIH0KICAgIGZ1bmN0aW9uIGNvcHlQcm9wZXJ0aWVzKHRhcmdldCwgc291cmNlLCBvYmplY3RUb0Nsb25lID0gdGFyZ2V0LCBzdGFjaywgY2xvbmVWYWx1ZSkgewogICAgICBjb25zdCBrZXlzID0gWy4uLk9iamVjdC5rZXlzKHNvdXJjZSksIC4uLmdldFN5bWJvbHMuZ2V0U3ltYm9scyhzb3VyY2UpXTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3Qga2V5ID0ga2V5c1tpXTsKICAgICAgICBjb25zdCBkZXNjcmlwdG9yID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0YXJnZXQsIGtleSk7CiAgICAgICAgaWYgKGRlc2NyaXB0b3IgPT0gbnVsbCB8fCBkZXNjcmlwdG9yLndyaXRhYmxlKSB7CiAgICAgICAgICB0YXJnZXRba2V5XSA9IGNsb25lRGVlcFdpdGhJbXBsKHNvdXJjZVtrZXldLCBrZXksIG9iamVjdFRvQ2xvbmUsIHN0YWNrLCBjbG9uZVZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGlzQ2xvbmVhYmxlT2JqZWN0KG9iamVjdCkgewogICAgICBzd2l0Y2ggKGdldFRhZy5nZXRUYWcob2JqZWN0KSkgewogICAgICAgIGNhc2UgdGFncy5hcmd1bWVudHNUYWc6CiAgICAgICAgY2FzZSB0YWdzLmFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5hcnJheUJ1ZmZlclRhZzoKICAgICAgICBjYXNlIHRhZ3MuZGF0YVZpZXdUYWc6CiAgICAgICAgY2FzZSB0YWdzLmJvb2xlYW5UYWc6CiAgICAgICAgY2FzZSB0YWdzLmRhdGVUYWc6CiAgICAgICAgY2FzZSB0YWdzLmZsb2F0MzJBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MuZmxvYXQ2NEFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy5pbnQ4QXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLmludDE2QXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLmludDMyQXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLm1hcFRhZzoKICAgICAgICBjYXNlIHRhZ3MubnVtYmVyVGFnOgogICAgICAgIGNhc2UgdGFncy5vYmplY3RUYWc6CiAgICAgICAgY2FzZSB0YWdzLnJlZ2V4cFRhZzoKICAgICAgICBjYXNlIHRhZ3Muc2V0VGFnOgogICAgICAgIGNhc2UgdGFncy5zdHJpbmdUYWc6CiAgICAgICAgY2FzZSB0YWdzLnN5bWJvbFRhZzoKICAgICAgICBjYXNlIHRhZ3MudWludDhBcnJheVRhZzoKICAgICAgICBjYXNlIHRhZ3MudWludDhDbGFtcGVkQXJyYXlUYWc6CiAgICAgICAgY2FzZSB0YWdzLnVpbnQxNkFycmF5VGFnOgogICAgICAgIGNhc2UgdGFncy51aW50MzJBcnJheVRhZzogewogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuY2xvbmVEZWVwV2l0aCA9IGNsb25lRGVlcFdpdGg7CiAgICBleHBvcnRzLmNsb25lRGVlcFdpdGhJbXBsID0gY2xvbmVEZWVwV2l0aEltcGw7CiAgICBleHBvcnRzLmNvcHlQcm9wZXJ0aWVzID0gY29weVByb3BlcnRpZXM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L29iamVjdC9jbG9uZURlZXAuanMKdmFyIHJlcXVpcmVfY2xvbmVEZWVwID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L29iamVjdC9jbG9uZURlZXAuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGNsb25lRGVlcFdpdGggPSByZXF1aXJlX2Nsb25lRGVlcFdpdGgoKTsKICAgIGZ1bmN0aW9uIGNsb25lRGVlcChvYmopIHsKICAgICAgcmV0dXJuIGNsb25lRGVlcFdpdGguY2xvbmVEZWVwV2l0aEltcGwob2JqLCB2b2lkIDAsIG9iaiwgLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKSwgdm9pZCAwKTsKICAgIH0KICAgIGV4cG9ydHMuY2xvbmVEZWVwID0gY2xvbmVEZWVwOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXMuanMKdmFyIHJlcXVpcmVfbWF0Y2hlcyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXMuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzTWF0Y2ggPSByZXF1aXJlX2lzTWF0Y2goKTsKICAgIHZhciBjbG9uZURlZXAgPSByZXF1aXJlX2Nsb25lRGVlcCgpOwogICAgZnVuY3Rpb24gbWF0Y2hlczIoc291cmNlKSB7CiAgICAgIHNvdXJjZSA9IGNsb25lRGVlcC5jbG9uZURlZXAoc291cmNlKTsKICAgICAgcmV0dXJuICh0YXJnZXQpID0+IHsKICAgICAgICByZXR1cm4gaXNNYXRjaC5pc01hdGNoKHRhcmdldCwgc291cmNlKTsKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMubWF0Y2hlcyA9IG1hdGNoZXMyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L2Nsb25lRGVlcFdpdGguanMKdmFyIHJlcXVpcmVfY2xvbmVEZWVwV2l0aDIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9jbG9uZURlZXBXaXRoLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBjbG9uZURlZXBXaXRoJDEgPSByZXF1aXJlX2Nsb25lRGVlcFdpdGgoKTsKICAgIHZhciB0YWdzID0gcmVxdWlyZV90YWdzKCk7CiAgICBmdW5jdGlvbiBjbG9uZURlZXBXaXRoKG9iaiwgY3VzdG9taXplcikgewogICAgICByZXR1cm4gY2xvbmVEZWVwV2l0aCQxLmNsb25lRGVlcFdpdGgob2JqLCAodmFsdWUsIGtleSwgb2JqZWN0LCBzdGFjaykgPT4gewogICAgICAgIGNvbnN0IGNsb25lZCA9IGN1c3RvbWl6ZXI/Lih2YWx1ZSwga2V5LCBvYmplY3QsIHN0YWNrKTsKICAgICAgICBpZiAoY2xvbmVkICE9PSB2b2lkIDApIHsKICAgICAgICAgIHJldHVybiBjbG9uZWQ7CiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2Ygb2JqICE9PSAib2JqZWN0IikgewogICAgICAgICAgcmV0dXJuIHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgc3dpdGNoIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSkgewogICAgICAgICAgY2FzZSB0YWdzLm51bWJlclRhZzoKICAgICAgICAgIGNhc2UgdGFncy5zdHJpbmdUYWc6CiAgICAgICAgICBjYXNlIHRhZ3MuYm9vbGVhblRhZzogewogICAgICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgb2JqLmNvbnN0cnVjdG9yKG9iaj8udmFsdWVPZigpKTsKICAgICAgICAgICAgY2xvbmVEZWVwV2l0aCQxLmNvcHlQcm9wZXJ0aWVzKHJlc3VsdCwgb2JqKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICAgIGNhc2UgdGFncy5hcmd1bWVudHNUYWc6IHsKICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0ge307CiAgICAgICAgICAgIGNsb25lRGVlcFdpdGgkMS5jb3B5UHJvcGVydGllcyhyZXN1bHQsIG9iaik7CiAgICAgICAgICAgIHJlc3VsdC5sZW5ndGggPSBvYmoubGVuZ3RoOwogICAgICAgICAgICByZXN1bHRbU3ltYm9sLml0ZXJhdG9yXSA9IG9ialtTeW1ib2wuaXRlcmF0b3JdOwogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgICAgfQogICAgICAgICAgZGVmYXVsdDogewogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBleHBvcnRzLmNsb25lRGVlcFdpdGggPSBjbG9uZURlZXBXaXRoOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvb2JqZWN0L2Nsb25lRGVlcC5qcwp2YXIgcmVxdWlyZV9jbG9uZURlZXAyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvY2xvbmVEZWVwLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBjbG9uZURlZXBXaXRoID0gcmVxdWlyZV9jbG9uZURlZXBXaXRoMigpOwogICAgZnVuY3Rpb24gY2xvbmVEZWVwKG9iaikgewogICAgICByZXR1cm4gY2xvbmVEZWVwV2l0aC5jbG9uZURlZXBXaXRoKG9iaik7CiAgICB9CiAgICBleHBvcnRzLmNsb25lRGVlcCA9IGNsb25lRGVlcDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0luZGV4LmpzCnZhciByZXF1aXJlX2lzSW5kZXggPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0luZGV4LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBJU19VTlNJR05FRF9JTlRFR0VSID0gL14oPzowfFsxLTldXGQqKSQvOwogICAgZnVuY3Rpb24gaXNJbmRleCh2YWx1ZSwgbGVuZ3RoID0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIpIHsKICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICBjYXNlICJudW1iZXIiOiB7CiAgICAgICAgICByZXR1cm4gTnVtYmVyLmlzSW50ZWdlcih2YWx1ZSkgJiYgdmFsdWUgPj0gMCAmJiB2YWx1ZSA8IGxlbmd0aDsKICAgICAgICB9CiAgICAgICAgY2FzZSAic3ltYm9sIjogewogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBjYXNlICJzdHJpbmciOiB7CiAgICAgICAgICByZXR1cm4gSVNfVU5TSUdORURfSU5URUdFUi50ZXN0KHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGV4cG9ydHMuaXNJbmRleCA9IGlzSW5kZXg7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvaXNBcmd1bWVudHMuanMKdmFyIHJlcXVpcmVfaXNBcmd1bWVudHMgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc0FyZ3VtZW50cy5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgZ2V0VGFnID0gcmVxdWlyZV9nZXRUYWcoKTsKICAgIGZ1bmN0aW9uIGlzQXJndW1lbnRzKHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiICYmIGdldFRhZy5nZXRUYWcodmFsdWUpID09PSAiW29iamVjdCBBcmd1bWVudHNdIjsKICAgIH0KICAgIGV4cG9ydHMuaXNBcmd1bWVudHMgPSBpc0FyZ3VtZW50czsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L29iamVjdC9oYXMuanMKdmFyIHJlcXVpcmVfaGFzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9vYmplY3QvaGFzLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc0RlZXBLZXkgPSByZXF1aXJlX2lzRGVlcEtleSgpOwogICAgdmFyIGlzSW5kZXggPSByZXF1aXJlX2lzSW5kZXgoKTsKICAgIHZhciBpc0FyZ3VtZW50cyA9IHJlcXVpcmVfaXNBcmd1bWVudHMoKTsKICAgIHZhciB0b1BhdGggPSByZXF1aXJlX3RvUGF0aCgpOwogICAgZnVuY3Rpb24gaGFzMyhvYmplY3QsIHBhdGgyKSB7CiAgICAgIGxldCByZXNvbHZlZFBhdGg7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHBhdGgyKSkgewogICAgICAgIHJlc29sdmVkUGF0aCA9IHBhdGgyOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiBwYXRoMiA9PT0gInN0cmluZyIgJiYgaXNEZWVwS2V5LmlzRGVlcEtleShwYXRoMikgJiYgb2JqZWN0Py5bcGF0aDJdID09IG51bGwpIHsKICAgICAgICByZXNvbHZlZFBhdGggPSB0b1BhdGgudG9QYXRoKHBhdGgyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXNvbHZlZFBhdGggPSBbcGF0aDJdOwogICAgICB9CiAgICAgIGlmIChyZXNvbHZlZFBhdGgubGVuZ3RoID09PSAwKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGxldCBjdXJyZW50MyA9IG9iamVjdDsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXNvbHZlZFBhdGgubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBrZXkgPSByZXNvbHZlZFBhdGhbaV07CiAgICAgICAgaWYgKGN1cnJlbnQzID09IG51bGwgfHwgIU9iamVjdC5oYXNPd24oY3VycmVudDMsIGtleSkpIHsKICAgICAgICAgIGNvbnN0IGlzU3BhcnNlSW5kZXggPSAoQXJyYXkuaXNBcnJheShjdXJyZW50MykgfHwgaXNBcmd1bWVudHMuaXNBcmd1bWVudHMoY3VycmVudDMpKSAmJiBpc0luZGV4LmlzSW5kZXgoa2V5KSAmJiBrZXkgPCBjdXJyZW50My5sZW5ndGg7CiAgICAgICAgICBpZiAoIWlzU3BhcnNlSW5kZXgpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjdXJyZW50MyA9IGN1cnJlbnQzW2tleV07CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBleHBvcnRzLmhhcyA9IGhhczM7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9wcmVkaWNhdGUvbWF0Y2hlc1Byb3BlcnR5LmpzCnZhciByZXF1aXJlX21hdGNoZXNQcm9wZXJ0eSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL21hdGNoZXNQcm9wZXJ0eS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNNYXRjaCA9IHJlcXVpcmVfaXNNYXRjaCgpOwogICAgdmFyIHRvS2V5ID0gcmVxdWlyZV90b0tleSgpOwogICAgdmFyIGNsb25lRGVlcCA9IHJlcXVpcmVfY2xvbmVEZWVwMigpOwogICAgdmFyIGdldDYgPSByZXF1aXJlX2dldCgpOwogICAgdmFyIGhhczMgPSByZXF1aXJlX2hhcygpOwogICAgZnVuY3Rpb24gbWF0Y2hlc1Byb3BlcnR5KHByb3BlcnR5LCBzb3VyY2UpIHsKICAgICAgc3dpdGNoICh0eXBlb2YgcHJvcGVydHkpIHsKICAgICAgICBjYXNlICJvYmplY3QiOiB7CiAgICAgICAgICBpZiAoT2JqZWN0LmlzKHByb3BlcnR5Py52YWx1ZU9mKCksIC0wKSkgewogICAgICAgICAgICBwcm9wZXJ0eSA9ICItMCI7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgY2FzZSAibnVtYmVyIjogewogICAgICAgICAgcHJvcGVydHkgPSB0b0tleS50b0tleShwcm9wZXJ0eSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgc291cmNlID0gY2xvbmVEZWVwLmNsb25lRGVlcChzb3VyY2UpOwogICAgICByZXR1cm4gZnVuY3Rpb24odGFyZ2V0KSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gZ2V0Ni5nZXQodGFyZ2V0LCBwcm9wZXJ0eSk7CiAgICAgICAgaWYgKHJlc3VsdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICByZXR1cm4gaGFzMy5oYXModGFyZ2V0LCBwcm9wZXJ0eSk7CiAgICAgICAgfQogICAgICAgIGlmIChzb3VyY2UgPT09IHZvaWQgMCkgewogICAgICAgICAgcmV0dXJuIHJlc3VsdCA9PT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaXNNYXRjaC5pc01hdGNoKHJlc3VsdCwgc291cmNlKTsKICAgICAgfTsKICAgIH0KICAgIGV4cG9ydHMubWF0Y2hlc1Byb3BlcnR5ID0gbWF0Y2hlc1Byb3BlcnR5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC9pdGVyYXRlZS5qcwp2YXIgcmVxdWlyZV9pdGVyYXRlZSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvdXRpbC9pdGVyYXRlZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaWRlbnRpdHk0ID0gcmVxdWlyZV9pZGVudGl0eSgpOwogICAgdmFyIHByb3BlcnR5ID0gcmVxdWlyZV9wcm9wZXJ0eSgpOwogICAgdmFyIG1hdGNoZXMyID0gcmVxdWlyZV9tYXRjaGVzKCk7CiAgICB2YXIgbWF0Y2hlc1Byb3BlcnR5ID0gcmVxdWlyZV9tYXRjaGVzUHJvcGVydHkoKTsKICAgIGZ1bmN0aW9uIGl0ZXJhdGVlKHZhbHVlKSB7CiAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGlkZW50aXR5NC5pZGVudGl0eTsKICAgICAgfQogICAgICBzd2l0Y2ggKHR5cGVvZiB2YWx1ZSkgewogICAgICAgIGNhc2UgImZ1bmN0aW9uIjogewogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBjYXNlICJvYmplY3QiOiB7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiYgdmFsdWUubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICAgIHJldHVybiBtYXRjaGVzUHJvcGVydHkubWF0Y2hlc1Byb3BlcnR5KHZhbHVlWzBdLCB2YWx1ZVsxXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2hlczIubWF0Y2hlcyh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGNhc2UgInN0cmluZyI6CiAgICAgICAgY2FzZSAic3ltYm9sIjoKICAgICAgICBjYXNlICJudW1iZXIiOiB7CiAgICAgICAgICByZXR1cm4gcHJvcGVydHkucHJvcGVydHkodmFsdWUpOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgZXhwb3J0cy5pdGVyYXRlZSA9IGl0ZXJhdGVlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvdW5pcUJ5LmpzCnZhciByZXF1aXJlX3VuaXFCeTIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L3VuaXFCeS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgdW5pcUJ5JDEgPSByZXF1aXJlX3VuaXFCeSgpOwogICAgdmFyIGlkZW50aXR5NCA9IHJlcXVpcmVfaWRlbnRpdHkoKTsKICAgIHZhciBpc0FycmF5TGlrZU9iamVjdCA9IHJlcXVpcmVfaXNBcnJheUxpa2VPYmplY3QoKTsKICAgIHZhciBpdGVyYXRlZSA9IHJlcXVpcmVfaXRlcmF0ZWUoKTsKICAgIGZ1bmN0aW9uIHVuaXFCeTIoYXJyYXksIGl0ZXJhdGVlJDEgPSBpZGVudGl0eTQuaWRlbnRpdHkpIHsKICAgICAgaWYgKCFpc0FycmF5TGlrZU9iamVjdC5pc0FycmF5TGlrZU9iamVjdChhcnJheSkpIHsKICAgICAgICByZXR1cm4gW107CiAgICAgIH0KICAgICAgcmV0dXJuIHVuaXFCeSQxLnVuaXFCeShBcnJheS5mcm9tKGFycmF5KSwgaXRlcmF0ZWUuaXRlcmF0ZWUoaXRlcmF0ZWUkMSkpOwogICAgfQogICAgZXhwb3J0cy51bmlxQnkgPSB1bmlxQnkyOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3VuaXFCeS5qcwp2YXIgcmVxdWlyZV91bmlxQnkzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvdW5pcUJ5LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV91bmlxQnkyKCkudW5pcUJ5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmVAMS42LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV91c2Vfc3luY19leHRlcm5hbF9zdG9yZV9zaGltX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS91c2Utc3luYy1leHRlcm5hbC1zdG9yZUAxLjYuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICAoZnVuY3Rpb24oKSB7CiAgICAgIGZ1bmN0aW9uIGlzNCh4MiwgeTIpIHsKICAgICAgICByZXR1cm4geDIgPT09IHkyICYmICgwICE9PSB4MiB8fCAxIC8geDIgPT09IDEgLyB5MikgfHwgeDIgIT09IHgyICYmIHkyICE9PSB5MjsKICAgICAgfQogICAgICBmdW5jdGlvbiB1c2VTeW5jRXh0ZXJuYWxTdG9yZSQyKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpIHsKICAgICAgICBkaWRXYXJuT2xkMThBbHBoYSB8fCB2b2lkIDAgPT09IFJlYWN0Mzkuc3RhcnRUcmFuc2l0aW9uIHx8IChkaWRXYXJuT2xkMThBbHBoYSA9IHRydWUsIGNvbnNvbGUuZXJyb3IoCiAgICAgICAgICAiWW91IGFyZSB1c2luZyBhbiBvdXRkYXRlZCwgcHJlLXJlbGVhc2UgYWxwaGEgb2YgUmVhY3QgMTggdGhhdCBkb2VzIG5vdCBzdXBwb3J0IHVzZVN5bmNFeHRlcm5hbFN0b3JlLiBUaGUgdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUgc2hpbSB3aWxsIG5vdCB3b3JrIGNvcnJlY3RseS4gVXBncmFkZSB0byBhIG5ld2VyIHByZS1yZWxlYXNlLiIKICAgICAgICApKTsKICAgICAgICB2YXIgdmFsdWUgPSBnZXRTbmFwc2hvdCgpOwogICAgICAgIGlmICghZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QpIHsKICAgICAgICAgIHZhciBjYWNoZWRWYWx1ZSA9IGdldFNuYXBzaG90KCk7CiAgICAgICAgICBvYmplY3RJcyh2YWx1ZSwgY2FjaGVkVmFsdWUpIHx8IChjb25zb2xlLmVycm9yKAogICAgICAgICAgICAiVGhlIHJlc3VsdCBvZiBnZXRTbmFwc2hvdCBzaG91bGQgYmUgY2FjaGVkIHRvIGF2b2lkIGFuIGluZmluaXRlIGxvb3AiCiAgICAgICAgICApLCBkaWRXYXJuVW5jYWNoZWRHZXRTbmFwc2hvdCA9IHRydWUpOwogICAgICAgIH0KICAgICAgICBjYWNoZWRWYWx1ZSA9IHVzZVN0YXRlMTMoewogICAgICAgICAgaW5zdDogeyB2YWx1ZSwgZ2V0U25hcHNob3QgfQogICAgICAgIH0pOwogICAgICAgIHZhciBpbnN0ID0gY2FjaGVkVmFsdWVbMF0uaW5zdCwgZm9yY2VVcGRhdGUgPSBjYWNoZWRWYWx1ZVsxXTsKICAgICAgICB1c2VMYXlvdXRFZmZlY3Q5KAogICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGluc3QudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgaW5zdC5nZXRTbmFwc2hvdCA9IGdldFNuYXBzaG90OwogICAgICAgICAgICBjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpICYmIGZvcmNlVXBkYXRlKHsgaW5zdCB9KTsKICAgICAgICAgIH0sCiAgICAgICAgICBbc3Vic2NyaWJlLCB2YWx1ZSwgZ2V0U25hcHNob3RdCiAgICAgICAgKTsKICAgICAgICB1c2VFZmZlY3QxNCgKICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpICYmIGZvcmNlVXBkYXRlKHsgaW5zdCB9KTsKICAgICAgICAgICAgcmV0dXJuIHN1YnNjcmliZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBjaGVja0lmU25hcHNob3RDaGFuZ2VkKGluc3QpICYmIGZvcmNlVXBkYXRlKHsgaW5zdCB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9LAogICAgICAgICAgW3N1YnNjcmliZV0KICAgICAgICApOwogICAgICAgIHVzZURlYnVnVmFsdWUyKHZhbHVlKTsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gY2hlY2tJZlNuYXBzaG90Q2hhbmdlZChpbnN0KSB7CiAgICAgICAgdmFyIGxhdGVzdEdldFNuYXBzaG90ID0gaW5zdC5nZXRTbmFwc2hvdDsKICAgICAgICBpbnN0ID0gaW5zdC52YWx1ZTsKICAgICAgICB0cnkgewogICAgICAgICAgdmFyIG5leHRWYWx1ZSA9IGxhdGVzdEdldFNuYXBzaG90KCk7CiAgICAgICAgICByZXR1cm4gIW9iamVjdElzKGluc3QsIG5leHRWYWx1ZSk7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiB1c2VTeW5jRXh0ZXJuYWxTdG9yZSQxKHN1YnNjcmliZSwgZ2V0U25hcHNob3QpIHsKICAgICAgICByZXR1cm4gZ2V0U25hcHNob3QoKTsKICAgICAgfQogICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCAmJiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0KEVycm9yKCkpOwogICAgICB2YXIgUmVhY3QzOSA9IHJlcXVpcmVfcmVhY3QoKSwgb2JqZWN0SXMgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgT2JqZWN0LmlzID8gT2JqZWN0LmlzIDogaXM0LCB1c2VTdGF0ZTEzID0gUmVhY3QzOS51c2VTdGF0ZSwgdXNlRWZmZWN0MTQgPSBSZWFjdDM5LnVzZUVmZmVjdCwgdXNlTGF5b3V0RWZmZWN0OSA9IFJlYWN0MzkudXNlTGF5b3V0RWZmZWN0LCB1c2VEZWJ1Z1ZhbHVlMiA9IFJlYWN0MzkudXNlRGVidWdWYWx1ZSwgZGlkV2Fybk9sZDE4QWxwaGEgPSBmYWxzZSwgZGlkV2FyblVuY2FjaGVkR2V0U25hcHNob3QgPSBmYWxzZSwgc2hpbSA9ICJ1bmRlZmluZWQiID09PSB0eXBlb2Ygd2luZG93IHx8ICJ1bmRlZmluZWQiID09PSB0eXBlb2Ygd2luZG93LmRvY3VtZW50IHx8ICJ1bmRlZmluZWQiID09PSB0eXBlb2Ygd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgPyB1c2VTeW5jRXh0ZXJuYWxTdG9yZSQxIDogdXNlU3luY0V4dGVybmFsU3RvcmUkMjsKICAgICAgZXhwb3J0cy51c2VTeW5jRXh0ZXJuYWxTdG9yZSA9IHZvaWQgMCAhPT0gUmVhY3QzOS51c2VTeW5jRXh0ZXJuYWxTdG9yZSA/IFJlYWN0MzkudXNlU3luY0V4dGVybmFsU3RvcmUgOiBzaGltOwogICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChFcnJvcigpKTsKICAgIH0pKCk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS91c2Utc3luYy1leHRlcm5hbC1zdG9yZUAxLjYuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3NoaW0vaW5kZXguanMKdmFyIHJlcXVpcmVfc2hpbSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmVAMS42LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9zaGltL2luZGV4LmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfdXNlX3N5bmNfZXh0ZXJuYWxfc3RvcmVfc2hpbV9kZXZlbG9wbWVudCgpOwogICAgfQogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmVAMS42LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS93aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3dpdGhfc2VsZWN0b3JfZGV2ZWxvcG1lbnQgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlQDEuNi4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXNoaW0vd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgKGZ1bmN0aW9uKCkgewogICAgICBmdW5jdGlvbiBpczQoeDIsIHkyKSB7CiAgICAgICAgcmV0dXJuIHgyID09PSB5MiAmJiAoMCAhPT0geDIgfHwgMSAvIHgyID09PSAxIC8geTIpIHx8IHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgICAgIH0KICAgICAgInVuZGVmaW5lZCIgIT09IHR5cGVvZiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18gJiYgImZ1bmN0aW9uIiA9PT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RhcnQgJiYgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydChFcnJvcigpKTsKICAgICAgdmFyIFJlYWN0MzkgPSByZXF1aXJlX3JlYWN0KCksIHNoaW0gPSByZXF1aXJlX3NoaW0oKSwgb2JqZWN0SXMgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgT2JqZWN0LmlzID8gT2JqZWN0LmlzIDogaXM0LCB1c2VTeW5jRXh0ZXJuYWxTdG9yZTIgPSBzaGltLnVzZVN5bmNFeHRlcm5hbFN0b3JlLCB1c2VSZWYxNiA9IFJlYWN0MzkudXNlUmVmLCB1c2VFZmZlY3QxNCA9IFJlYWN0MzkudXNlRWZmZWN0LCB1c2VNZW1vOSA9IFJlYWN0MzkudXNlTWVtbywgdXNlRGVidWdWYWx1ZTIgPSBSZWFjdDM5LnVzZURlYnVnVmFsdWU7CiAgICAgIGV4cG9ydHMudXNlU3luY0V4dGVybmFsU3RvcmVXaXRoU2VsZWN0b3IgPSBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCwgc2VsZWN0b3IsIGlzRXF1YWwpIHsKICAgICAgICB2YXIgaW5zdFJlZiA9IHVzZVJlZjE2KG51bGwpOwogICAgICAgIGlmIChudWxsID09PSBpbnN0UmVmLmN1cnJlbnQpIHsKICAgICAgICAgIHZhciBpbnN0ID0geyBoYXNWYWx1ZTogZmFsc2UsIHZhbHVlOiBudWxsIH07CiAgICAgICAgICBpbnN0UmVmLmN1cnJlbnQgPSBpbnN0OwogICAgICAgIH0gZWxzZSBpbnN0ID0gaW5zdFJlZi5jdXJyZW50OwogICAgICAgIGluc3RSZWYgPSB1c2VNZW1vOSgKICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmdW5jdGlvbiBtZW1vaXplZFNlbGVjdG9yKG5leHRTbmFwc2hvdCkgewogICAgICAgICAgICAgIGlmICghaGFzTWVtbykgewogICAgICAgICAgICAgICAgaGFzTWVtbyA9IHRydWU7CiAgICAgICAgICAgICAgICBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICAgICAgbmV4dFNuYXBzaG90ID0gc2VsZWN0b3IobmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IGlzRXF1YWwgJiYgaW5zdC5oYXNWYWx1ZSkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFNlbGVjdGlvbiA9IGluc3QudmFsdWU7CiAgICAgICAgICAgICAgICAgIGlmIChpc0VxdWFsKGN1cnJlbnRTZWxlY3Rpb24sIG5leHRTbmFwc2hvdCkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0aW9uID0gY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudFNlbGVjdGlvbiA9IG1lbW9pemVkU2VsZWN0aW9uOwogICAgICAgICAgICAgIGlmIChvYmplY3RJcyhtZW1vaXplZFNuYXBzaG90LCBuZXh0U25hcHNob3QpKQogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgICAgdmFyIG5leHRTZWxlY3Rpb24gPSBzZWxlY3RvcihuZXh0U25hcHNob3QpOwogICAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IGlzRXF1YWwgJiYgaXNFcXVhbChjdXJyZW50U2VsZWN0aW9uLCBuZXh0U2VsZWN0aW9uKSkKICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90LCBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICAgIG1lbW9pemVkU25hcHNob3QgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0aW9uID0gbmV4dFNlbGVjdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzTWVtbyA9IGZhbHNlLCBtZW1vaXplZFNuYXBzaG90LCBtZW1vaXplZFNlbGVjdGlvbiwgbWF5YmVHZXRTZXJ2ZXJTbmFwc2hvdCA9IHZvaWQgMCA9PT0gZ2V0U2VydmVyU25hcHNob3QgPyBudWxsIDogZ2V0U2VydmVyU25hcHNob3Q7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3RvcihnZXRTbmFwc2hvdCgpKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG51bGwgPT09IG1heWJlR2V0U2VydmVyU25hcHNob3QgPyB2b2lkIDAgOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdG9yKG1heWJlR2V0U2VydmVyU25hcHNob3QoKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBdOwogICAgICAgICAgfSwKICAgICAgICAgIFtnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QsIHNlbGVjdG9yLCBpc0VxdWFsXQogICAgICAgICk7CiAgICAgICAgdmFyIHZhbHVlID0gdXNlU3luY0V4dGVybmFsU3RvcmUyKHN1YnNjcmliZSwgaW5zdFJlZlswXSwgaW5zdFJlZlsxXSk7CiAgICAgICAgdXNlRWZmZWN0MTQoCiAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5zdC5oYXNWYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGluc3QudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgIH0sCiAgICAgICAgICBbdmFsdWVdCiAgICAgICAgKTsKICAgICAgICB1c2VEZWJ1Z1ZhbHVlMih2YWx1ZSk7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9OwogICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChFcnJvcigpKTsKICAgIH0pKCk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS91c2Utc3luYy1leHRlcm5hbC1zdG9yZUAxLjYuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3NoaW0vd2l0aC1zZWxlY3Rvci5qcwp2YXIgcmVxdWlyZV93aXRoX3NlbGVjdG9yID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS91c2Utc3luYy1leHRlcm5hbC1zdG9yZUAxLjYuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3NoaW0vd2l0aC1zZWxlY3Rvci5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3dpdGhfc2VsZWN0b3JfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9jb21wYXJlVmFsdWVzLmpzCnZhciByZXF1aXJlX2NvbXBhcmVWYWx1ZXMgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9jb21wYXJlVmFsdWVzLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGdldFByaW9yaXR5KGEpIHsKICAgICAgaWYgKHR5cGVvZiBhID09PSAic3ltYm9sIikgewogICAgICAgIHJldHVybiAxOwogICAgICB9CiAgICAgIGlmIChhID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIDI7CiAgICAgIH0KICAgICAgaWYgKGEgPT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiAzOwogICAgICB9CiAgICAgIGlmIChhICE9PSBhKSB7CiAgICAgICAgcmV0dXJuIDQ7CiAgICAgIH0KICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICB2YXIgY29tcGFyZVZhbHVlcyA9IChhLCBiLCBvcmRlcikgPT4gewogICAgICBpZiAoYSAhPT0gYikgewogICAgICAgIGNvbnN0IGFQcmlvcml0eSA9IGdldFByaW9yaXR5KGEpOwogICAgICAgIGNvbnN0IGJQcmlvcml0eSA9IGdldFByaW9yaXR5KGIpOwogICAgICAgIGlmIChhUHJpb3JpdHkgPT09IGJQcmlvcml0eSAmJiBhUHJpb3JpdHkgPT09IDApIHsKICAgICAgICAgIGlmIChhIDwgYikgewogICAgICAgICAgICByZXR1cm4gb3JkZXIgPT09ICJkZXNjIiA/IDEgOiAtMTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhID4gYikgewogICAgICAgICAgICByZXR1cm4gb3JkZXIgPT09ICJkZXNjIiA/IC0xIDogMTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9yZGVyID09PSAiZGVzYyIgPyBiUHJpb3JpdHkgLSBhUHJpb3JpdHkgOiBhUHJpb3JpdHkgLSBiUHJpb3JpdHk7CiAgICAgIH0KICAgICAgcmV0dXJuIDA7CiAgICB9OwogICAgZXhwb3J0cy5jb21wYXJlVmFsdWVzID0gY29tcGFyZVZhbHVlczsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L3ByZWRpY2F0ZS9pc1N5bWJvbC5qcwp2YXIgcmVxdWlyZV9pc1N5bWJvbCA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvcHJlZGljYXRlL2lzU3ltYm9sLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIGZ1bmN0aW9uIGlzU3ltYm9sKHZhbHVlKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICJzeW1ib2wiIHx8IHZhbHVlIGluc3RhbmNlb2YgU3ltYm9sOwogICAgfQogICAgZXhwb3J0cy5pc1N5bWJvbCA9IGlzU3ltYm9sOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvX2ludGVybmFsL2lzS2V5LmpzCnZhciByZXF1aXJlX2lzS2V5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNLZXkuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGlzU3ltYm9sID0gcmVxdWlyZV9pc1N5bWJvbCgpOwogICAgdmFyIHJlZ2V4SXNEZWVwUHJvcCA9IC9cLnxcWyg/OlteW1xdXSp8KFsiJ10pKD86KD8hXDEpW15cXF18XFwuKSo/XDEpXF0vOwogICAgdmFyIHJlZ2V4SXNQbGFpblByb3AgPSAvXlx3KiQvOwogICAgZnVuY3Rpb24gaXNLZXkodmFsdWUsIG9iamVjdCkgewogICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIgfHwgdHlwZW9mIHZhbHVlID09PSAiYm9vbGVhbiIgfHwgdmFsdWUgPT0gbnVsbCB8fCBpc1N5bWJvbC5pc1N5bWJvbCh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiAmJiAocmVnZXhJc1BsYWluUHJvcC50ZXN0KHZhbHVlKSB8fCAhcmVnZXhJc0RlZXBQcm9wLnRlc3QodmFsdWUpKSB8fCBvYmplY3QgIT0gbnVsbCAmJiBPYmplY3QuaGFzT3duKG9iamVjdCwgdmFsdWUpOwogICAgfQogICAgZXhwb3J0cy5pc0tleSA9IGlzS2V5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvYXJyYXkvb3JkZXJCeS5qcwp2YXIgcmVxdWlyZV9vcmRlckJ5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9vcmRlckJ5LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBjb21wYXJlVmFsdWVzID0gcmVxdWlyZV9jb21wYXJlVmFsdWVzKCk7CiAgICB2YXIgaXNLZXkgPSByZXF1aXJlX2lzS2V5KCk7CiAgICB2YXIgdG9QYXRoID0gcmVxdWlyZV90b1BhdGgoKTsKICAgIGZ1bmN0aW9uIG9yZGVyQnkoY29sbGVjdGlvbiwgY3JpdGVyaWEsIG9yZGVycywgZ3VhcmQpIHsKICAgICAgaWYgKGNvbGxlY3Rpb24gPT0gbnVsbCkgewogICAgICAgIHJldHVybiBbXTsKICAgICAgfQogICAgICBvcmRlcnMgPSBndWFyZCA/IHZvaWQgMCA6IG9yZGVyczsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGNvbGxlY3Rpb24pKSB7CiAgICAgICAgY29sbGVjdGlvbiA9IE9iamVjdC52YWx1ZXMoY29sbGVjdGlvbik7CiAgICAgIH0KICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGNyaXRlcmlhKSkgewogICAgICAgIGNyaXRlcmlhID0gY3JpdGVyaWEgPT0gbnVsbCA/IFtudWxsXSA6IFtjcml0ZXJpYV07CiAgICAgIH0KICAgICAgaWYgKGNyaXRlcmlhLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGNyaXRlcmlhID0gW251bGxdOwogICAgICB9CiAgICAgIGlmICghQXJyYXkuaXNBcnJheShvcmRlcnMpKSB7CiAgICAgICAgb3JkZXJzID0gb3JkZXJzID09IG51bGwgPyBbXSA6IFtvcmRlcnNdOwogICAgICB9CiAgICAgIG9yZGVycyA9IG9yZGVycy5tYXAoKG9yZGVyKSA9PiBTdHJpbmcob3JkZXIpKTsKICAgICAgY29uc3QgZ2V0VmFsdWVCeU5lc3RlZFBhdGggPSAob2JqZWN0LCBwYXRoMikgPT4gewogICAgICAgIGxldCB0YXJnZXQgPSBvYmplY3Q7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXRoMi5sZW5ndGggJiYgdGFyZ2V0ICE9IG51bGw7ICsraSkgewogICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0W3BhdGgyW2ldXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRhcmdldDsKICAgICAgfTsKICAgICAgY29uc3QgZ2V0VmFsdWVCeUNyaXRlcmlvbiA9IChjcml0ZXJpb24sIG9iamVjdCkgPT4gewogICAgICAgIGlmIChvYmplY3QgPT0gbnVsbCB8fCBjcml0ZXJpb24gPT0gbnVsbCkgewogICAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBjcml0ZXJpb24gPT09ICJvYmplY3QiICYmICJrZXkiIGluIGNyaXRlcmlvbikgewogICAgICAgICAgaWYgKE9iamVjdC5oYXNPd24ob2JqZWN0LCBjcml0ZXJpb24ua2V5KSkgewogICAgICAgICAgICByZXR1cm4gb2JqZWN0W2NyaXRlcmlvbi5rZXldOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGdldFZhbHVlQnlOZXN0ZWRQYXRoKG9iamVjdCwgY3JpdGVyaW9uLnBhdGgpOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGNyaXRlcmlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgcmV0dXJuIGNyaXRlcmlvbihvYmplY3QpOwogICAgICAgIH0KICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjcml0ZXJpb24pKSB7CiAgICAgICAgICByZXR1cm4gZ2V0VmFsdWVCeU5lc3RlZFBhdGgob2JqZWN0LCBjcml0ZXJpb24pOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIG9iamVjdCA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgIHJldHVybiBvYmplY3RbY3JpdGVyaW9uXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9iamVjdDsKICAgICAgfTsKICAgICAgY29uc3QgcHJlcGFyZWRDcml0ZXJpYSA9IGNyaXRlcmlhLm1hcCgoY3JpdGVyaW9uKSA9PiB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY3JpdGVyaW9uKSAmJiBjcml0ZXJpb24ubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICBjcml0ZXJpb24gPSBjcml0ZXJpb25bMF07CiAgICAgICAgfQogICAgICAgIGlmIChjcml0ZXJpb24gPT0gbnVsbCB8fCB0eXBlb2YgY3JpdGVyaW9uID09PSAiZnVuY3Rpb24iIHx8IEFycmF5LmlzQXJyYXkoY3JpdGVyaW9uKSB8fCBpc0tleS5pc0tleShjcml0ZXJpb24pKSB7CiAgICAgICAgICByZXR1cm4gY3JpdGVyaW9uOwogICAgICAgIH0KICAgICAgICByZXR1cm4geyBrZXk6IGNyaXRlcmlvbiwgcGF0aDogdG9QYXRoLnRvUGF0aChjcml0ZXJpb24pIH07CiAgICAgIH0pOwogICAgICBjb25zdCBwcmVwYXJlZENvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLm1hcCgoaXRlbSkgPT4gKHsKICAgICAgICBvcmlnaW5hbDogaXRlbSwKICAgICAgICBjcml0ZXJpYTogcHJlcGFyZWRDcml0ZXJpYS5tYXAoKGNyaXRlcmlvbikgPT4gZ2V0VmFsdWVCeUNyaXRlcmlvbihjcml0ZXJpb24sIGl0ZW0pKQogICAgICB9KSk7CiAgICAgIHJldHVybiBwcmVwYXJlZENvbGxlY3Rpb24uc2xpY2UoKS5zb3J0KChhLCBiKSA9PiB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcmVwYXJlZENyaXRlcmlhLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBjb25zdCBjb21wYXJlZFJlc3VsdCA9IGNvbXBhcmVWYWx1ZXMuY29tcGFyZVZhbHVlcyhhLmNyaXRlcmlhW2ldLCBiLmNyaXRlcmlhW2ldLCBvcmRlcnNbaV0pOwogICAgICAgICAgaWYgKGNvbXBhcmVkUmVzdWx0ICE9PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBjb21wYXJlZFJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0pLm1hcCgoaXRlbSkgPT4gaXRlbS5vcmlnaW5hbCk7CiAgICB9CiAgICBleHBvcnRzLm9yZGVyQnkgPSBvcmRlckJ5OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9hcnJheS9mbGF0dGVuLmpzCnZhciByZXF1aXJlX2ZsYXR0ZW4gPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvYXJyYXkvZmxhdHRlbi5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiBmbGF0dGVuKGFyciwgZGVwdGggPSAxKSB7CiAgICAgIGNvbnN0IHJlc3VsdCA9IFtdOwogICAgICBjb25zdCBmbG9vcmVkRGVwdGggPSBNYXRoLmZsb29yKGRlcHRoKTsKICAgICAgY29uc3QgcmVjdXJzaXZlID0gKGFycjIsIGN1cnJlbnREZXB0aCkgPT4gewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyMi5sZW5ndGg7IGkrKykgewogICAgICAgICAgY29uc3QgaXRlbSA9IGFycjJbaV07CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShpdGVtKSAmJiBjdXJyZW50RGVwdGggPCBmbG9vcmVkRGVwdGgpIHsKICAgICAgICAgICAgcmVjdXJzaXZlKGl0ZW0sIGN1cnJlbnREZXB0aCArIDEpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmVzdWx0LnB1c2goaXRlbSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgICByZWN1cnNpdmUoYXJyLCAwKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICAgIGV4cG9ydHMuZmxhdHRlbiA9IGZsYXR0ZW47CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvaXNJdGVyYXRlZUNhbGwuanMKdmFyIHJlcXVpcmVfaXNJdGVyYXRlZUNhbGwgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L19pbnRlcm5hbC9pc0l0ZXJhdGVlQ2FsbC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNJbmRleCA9IHJlcXVpcmVfaXNJbmRleCgpOwogICAgdmFyIGlzQXJyYXlMaWtlID0gcmVxdWlyZV9pc0FycmF5TGlrZSgpOwogICAgdmFyIGlzT2JqZWN0ID0gcmVxdWlyZV9pc09iamVjdCgpOwogICAgdmFyIGVxID0gcmVxdWlyZV9lcSgpOwogICAgZnVuY3Rpb24gaXNJdGVyYXRlZUNhbGwodmFsdWUsIGluZGV4LCBvYmplY3QpIHsKICAgICAgaWYgKCFpc09iamVjdC5pc09iamVjdChvYmplY3QpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgaW5kZXggPT09ICJudW1iZXIiICYmIGlzQXJyYXlMaWtlLmlzQXJyYXlMaWtlKG9iamVjdCkgJiYgaXNJbmRleC5pc0luZGV4KGluZGV4KSAmJiBpbmRleCA8IG9iamVjdC5sZW5ndGggfHwgdHlwZW9mIGluZGV4ID09PSAic3RyaW5nIiAmJiBpbmRleCBpbiBvYmplY3QpIHsKICAgICAgICByZXR1cm4gZXEuZXEob2JqZWN0W2luZGV4XSwgdmFsdWUpOwogICAgICB9CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGV4cG9ydHMuaXNJdGVyYXRlZUNhbGwgPSBpc0l0ZXJhdGVlQ2FsbDsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L3NvcnRCeS5qcwp2YXIgcmVxdWlyZV9zb3J0QnkgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2FycmF5L3NvcnRCeS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgb3JkZXJCeSA9IHJlcXVpcmVfb3JkZXJCeSgpOwogICAgdmFyIGZsYXR0ZW4gPSByZXF1aXJlX2ZsYXR0ZW4oKTsKICAgIHZhciBpc0l0ZXJhdGVlQ2FsbCA9IHJlcXVpcmVfaXNJdGVyYXRlZUNhbGwoKTsKICAgIGZ1bmN0aW9uIHNvcnRCeTUoY29sbGVjdGlvbiwgLi4uY3JpdGVyaWEpIHsKICAgICAgY29uc3QgbGVuZ3RoID0gY3JpdGVyaWEubGVuZ3RoOwogICAgICBpZiAobGVuZ3RoID4gMSAmJiBpc0l0ZXJhdGVlQ2FsbC5pc0l0ZXJhdGVlQ2FsbChjb2xsZWN0aW9uLCBjcml0ZXJpYVswXSwgY3JpdGVyaWFbMV0pKSB7CiAgICAgICAgY3JpdGVyaWEgPSBbXTsKICAgICAgfSBlbHNlIGlmIChsZW5ndGggPiAyICYmIGlzSXRlcmF0ZWVDYWxsLmlzSXRlcmF0ZWVDYWxsKGNyaXRlcmlhWzBdLCBjcml0ZXJpYVsxXSwgY3JpdGVyaWFbMl0pKSB7CiAgICAgICAgY3JpdGVyaWEgPSBbY3JpdGVyaWFbMF1dOwogICAgICB9CiAgICAgIHJldHVybiBvcmRlckJ5Lm9yZGVyQnkoY29sbGVjdGlvbiwgZmxhdHRlbi5mbGF0dGVuKGNyaXRlcmlhKSwgWyJhc2MiXSk7CiAgICB9CiAgICBleHBvcnRzLnNvcnRCeSA9IHNvcnRCeTU7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvc29ydEJ5LmpzCnZhciByZXF1aXJlX3NvcnRCeTIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9zb3J0QnkuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3NvcnRCeSgpLnNvcnRCeTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvZnVuY3Rpb24vZGVib3VuY2UuanMKdmFyIHJlcXVpcmVfZGVib3VuY2UgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvZnVuY3Rpb24vZGVib3VuY2UuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gZGVib3VuY2UoZnVuYywgZGVib3VuY2VNcywgeyBzaWduYWwsIGVkZ2VzIH0gPSB7fSkgewogICAgICBsZXQgcGVuZGluZ1RoaXMgPSB2b2lkIDA7CiAgICAgIGxldCBwZW5kaW5nQXJncyA9IG51bGw7CiAgICAgIGNvbnN0IGxlYWRpbmcgPSBlZGdlcyAhPSBudWxsICYmIGVkZ2VzLmluY2x1ZGVzKCJsZWFkaW5nIik7CiAgICAgIGNvbnN0IHRyYWlsaW5nID0gZWRnZXMgPT0gbnVsbCB8fCBlZGdlcy5pbmNsdWRlcygidHJhaWxpbmciKTsKICAgICAgY29uc3QgaW52b2tlID0gKCkgPT4gewogICAgICAgIGlmIChwZW5kaW5nQXJncyAhPT0gbnVsbCkgewogICAgICAgICAgZnVuYy5hcHBseShwZW5kaW5nVGhpcywgcGVuZGluZ0FyZ3MpOwogICAgICAgICAgcGVuZGluZ1RoaXMgPSB2b2lkIDA7CiAgICAgICAgICBwZW5kaW5nQXJncyA9IG51bGw7CiAgICAgICAgfQogICAgICB9OwogICAgICBjb25zdCBvblRpbWVyRW5kID0gKCkgPT4gewogICAgICAgIGlmICh0cmFpbGluZykgewogICAgICAgICAgaW52b2tlKCk7CiAgICAgICAgfQogICAgICAgIGNhbmNlbCgpOwogICAgICB9OwogICAgICBsZXQgdGltZW91dElkID0gbnVsbDsKICAgICAgY29uc3Qgc2NoZWR1bGUgPSAoKSA9PiB7CiAgICAgICAgaWYgKHRpbWVvdXRJZCAhPSBudWxsKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTsKICAgICAgICB9CiAgICAgICAgdGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICB0aW1lb3V0SWQgPSBudWxsOwogICAgICAgICAgb25UaW1lckVuZCgpOwogICAgICAgIH0sIGRlYm91bmNlTXMpOwogICAgICB9OwogICAgICBjb25zdCBjYW5jZWxUaW1lciA9ICgpID0+IHsKICAgICAgICBpZiAodGltZW91dElkICE9PSBudWxsKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTsKICAgICAgICAgIHRpbWVvdXRJZCA9IG51bGw7CiAgICAgICAgfQogICAgICB9OwogICAgICBjb25zdCBjYW5jZWwgPSAoKSA9PiB7CiAgICAgICAgY2FuY2VsVGltZXIoKTsKICAgICAgICBwZW5kaW5nVGhpcyA9IHZvaWQgMDsKICAgICAgICBwZW5kaW5nQXJncyA9IG51bGw7CiAgICAgIH07CiAgICAgIGNvbnN0IGZsdXNoID0gKCkgPT4gewogICAgICAgIGludm9rZSgpOwogICAgICB9OwogICAgICBjb25zdCBkZWJvdW5jZWQgPSBmdW5jdGlvbiguLi5hcmdzKSB7CiAgICAgICAgaWYgKHNpZ25hbD8uYWJvcnRlZCkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBwZW5kaW5nVGhpcyA9IHRoaXM7CiAgICAgICAgcGVuZGluZ0FyZ3MgPSBhcmdzOwogICAgICAgIGNvbnN0IGlzRmlyc3RDYWxsID0gdGltZW91dElkID09IG51bGw7CiAgICAgICAgc2NoZWR1bGUoKTsKICAgICAgICBpZiAobGVhZGluZyAmJiBpc0ZpcnN0Q2FsbCkgewogICAgICAgICAgaW52b2tlKCk7CiAgICAgICAgfQogICAgICB9OwogICAgICBkZWJvdW5jZWQuc2NoZWR1bGUgPSBzY2hlZHVsZTsKICAgICAgZGVib3VuY2VkLmNhbmNlbCA9IGNhbmNlbDsKICAgICAgZGVib3VuY2VkLmZsdXNoID0gZmx1c2g7CiAgICAgIHNpZ25hbD8uYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBjYW5jZWwsIHsgb25jZTogdHJ1ZSB9KTsKICAgICAgcmV0dXJuIGRlYm91bmNlZDsKICAgIH0KICAgIGV4cG9ydHMuZGVib3VuY2UgPSBkZWJvdW5jZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2Z1bmN0aW9uL2RlYm91bmNlLmpzCnZhciByZXF1aXJlX2RlYm91bmNlMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvZnVuY3Rpb24vZGVib3VuY2UuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgdmFyIGRlYm91bmNlJDEgPSByZXF1aXJlX2RlYm91bmNlKCk7CiAgICBmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCBkZWJvdW5jZU1zID0gMCwgb3B0aW9ucyA9IHt9KSB7CiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gIm9iamVjdCIpIHsKICAgICAgICBvcHRpb25zID0ge307CiAgICAgIH0KICAgICAgY29uc3QgeyBsZWFkaW5nID0gZmFsc2UsIHRyYWlsaW5nID0gdHJ1ZSwgbWF4V2FpdCB9ID0gb3B0aW9uczsKICAgICAgY29uc3QgZWRnZXMgPSBBcnJheSgyKTsKICAgICAgaWYgKGxlYWRpbmcpIHsKICAgICAgICBlZGdlc1swXSA9ICJsZWFkaW5nIjsKICAgICAgfQogICAgICBpZiAodHJhaWxpbmcpIHsKICAgICAgICBlZGdlc1sxXSA9ICJ0cmFpbGluZyI7CiAgICAgIH0KICAgICAgbGV0IHJlc3VsdCA9IHZvaWQgMDsKICAgICAgbGV0IHBlbmRpbmdBdCA9IG51bGw7CiAgICAgIGNvbnN0IF9kZWJvdW5jZWQgPSBkZWJvdW5jZSQxLmRlYm91bmNlKGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIHBlbmRpbmdBdCA9IG51bGw7CiAgICAgIH0sIGRlYm91bmNlTXMsIHsgZWRnZXMgfSk7CiAgICAgIGNvbnN0IGRlYm91bmNlZCA9IGZ1bmN0aW9uKC4uLmFyZ3MpIHsKICAgICAgICBpZiAobWF4V2FpdCAhPSBudWxsKSB7CiAgICAgICAgICBpZiAocGVuZGluZ0F0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHBlbmRpbmdBdCA9IERhdGUubm93KCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIHBlbmRpbmdBdCA+PSBtYXhXYWl0KSB7CiAgICAgICAgICAgIHJlc3VsdCA9IGZ1bmMuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgICAgIHBlbmRpbmdBdCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIF9kZWJvdW5jZWQuY2FuY2VsKCk7CiAgICAgICAgICAgIF9kZWJvdW5jZWQuc2NoZWR1bGUoKTsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgX2RlYm91bmNlZC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9OwogICAgICBjb25zdCBmbHVzaCA9ICgpID0+IHsKICAgICAgICBfZGVib3VuY2VkLmZsdXNoKCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfTsKICAgICAgZGVib3VuY2VkLmNhbmNlbCA9IF9kZWJvdW5jZWQuY2FuY2VsOwogICAgICBkZWJvdW5jZWQuZmx1c2ggPSBmbHVzaDsKICAgICAgcmV0dXJuIGRlYm91bmNlZDsKICAgIH0KICAgIGV4cG9ydHMuZGVib3VuY2UgPSBkZWJvdW5jZTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvY29tcGF0L2Z1bmN0aW9uL3Rocm90dGxlLmpzCnZhciByZXF1aXJlX3Rocm90dGxlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9mdW5jdGlvbi90aHJvdHRsZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgZGVib3VuY2UgPSByZXF1aXJlX2RlYm91bmNlMigpOwogICAgZnVuY3Rpb24gdGhyb3R0bGUyKGZ1bmMsIHRocm90dGxlTXMgPSAwLCBvcHRpb25zID0ge30pIHsKICAgICAgY29uc3QgeyBsZWFkaW5nID0gdHJ1ZSwgdHJhaWxpbmcgPSB0cnVlIH0gPSBvcHRpb25zOwogICAgICByZXR1cm4gZGVib3VuY2UuZGVib3VuY2UoZnVuYywgdGhyb3R0bGVNcywgewogICAgICAgIGxlYWRpbmcsCiAgICAgICAgbWF4V2FpdDogdGhyb3R0bGVNcywKICAgICAgICB0cmFpbGluZwogICAgICB9KTsKICAgIH0KICAgIGV4cG9ydHMudGhyb3R0bGUgPSB0aHJvdHRsZTI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvdGhyb3R0bGUuanMKdmFyIHJlcXVpcmVfdGhyb3R0bGUyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvdGhyb3R0bGUuanMiKGV4cG9ydHMsIG1vZHVsZSkgewogICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3Rocm90dGxlKCkudGhyb3R0bGU7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvTnVtYmVyLmpzCnZhciByZXF1aXJlX3RvTnVtYmVyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvTnVtYmVyLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBpc1N5bWJvbCA9IHJlcXVpcmVfaXNTeW1ib2woKTsKICAgIGZ1bmN0aW9uIHRvTnVtYmVyMih2YWx1ZSkgewogICAgICBpZiAoaXNTeW1ib2wuaXNTeW1ib2wodmFsdWUpKSB7CiAgICAgICAgcmV0dXJuIE5hTjsKICAgICAgfQogICAgICByZXR1cm4gTnVtYmVyKHZhbHVlKTsKICAgIH0KICAgIGV4cG9ydHMudG9OdW1iZXIgPSB0b051bWJlcjI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvRmluaXRlLmpzCnZhciByZXF1aXJlX3RvRmluaXRlID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC91dGlsL3RvRmluaXRlLmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciB0b051bWJlcjIgPSByZXF1aXJlX3RvTnVtYmVyKCk7CiAgICBmdW5jdGlvbiB0b0Zpbml0ZSh2YWx1ZSkgewogICAgICBpZiAoIXZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlID09PSAwID8gdmFsdWUgOiAwOwogICAgICB9CiAgICAgIHZhbHVlID0gdG9OdW1iZXIyLnRvTnVtYmVyKHZhbHVlKTsKICAgICAgaWYgKHZhbHVlID09PSBJbmZpbml0eSB8fCB2YWx1ZSA9PT0gLUluZmluaXR5KSB7CiAgICAgICAgY29uc3Qgc2lnbjIgPSB2YWx1ZSA8IDAgPyAtMSA6IDE7CiAgICAgICAgcmV0dXJuIHNpZ24yICogTnVtYmVyLk1BWF9WQUxVRTsKICAgICAgfQogICAgICByZXR1cm4gdmFsdWUgPT09IHZhbHVlID8gdmFsdWUgOiAwOwogICAgfQogICAgZXhwb3J0cy50b0Zpbml0ZSA9IHRvRmluaXRlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvbWF0aC9yYW5nZS5qcwp2YXIgcmVxdWlyZV9yYW5nZSA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvZGlzdC9jb21wYXQvbWF0aC9yYW5nZS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICB2YXIgaXNJdGVyYXRlZUNhbGwgPSByZXF1aXJlX2lzSXRlcmF0ZWVDYWxsKCk7CiAgICB2YXIgdG9GaW5pdGUgPSByZXF1aXJlX3RvRmluaXRlKCk7CiAgICBmdW5jdGlvbiByYW5nZTQoc3RhcnQsIGVuZCwgc3RlcCkgewogICAgICBpZiAoc3RlcCAmJiB0eXBlb2Ygc3RlcCAhPT0gIm51bWJlciIgJiYgaXNJdGVyYXRlZUNhbGwuaXNJdGVyYXRlZUNhbGwoc3RhcnQsIGVuZCwgc3RlcCkpIHsKICAgICAgICBlbmQgPSBzdGVwID0gdm9pZCAwOwogICAgICB9CiAgICAgIHN0YXJ0ID0gdG9GaW5pdGUudG9GaW5pdGUoc3RhcnQpOwogICAgICBpZiAoZW5kID09PSB2b2lkIDApIHsKICAgICAgICBlbmQgPSBzdGFydDsKICAgICAgICBzdGFydCA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZW5kID0gdG9GaW5pdGUudG9GaW5pdGUoZW5kKTsKICAgICAgfQogICAgICBzdGVwID0gc3RlcCA9PT0gdm9pZCAwID8gc3RhcnQgPCBlbmQgPyAxIDogLTEgOiB0b0Zpbml0ZS50b0Zpbml0ZShzdGVwKTsKICAgICAgY29uc3QgbGVuZ3RoID0gTWF0aC5tYXgoTWF0aC5jZWlsKChlbmQgLSBzdGFydCkgLyAoc3RlcCB8fCAxKSksIDApOwogICAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgIHJlc3VsdFtpbmRleF0gPSBzdGFydDsKICAgICAgICBzdGFydCArPSBzdGVwOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBleHBvcnRzLnJhbmdlID0gcmFuZ2U0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3JhbmdlLmpzCnZhciByZXF1aXJlX3JhbmdlMiA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXMtdG9vbGtpdEAxLjQyLjAvbm9kZV9tb2R1bGVzL2VzLXRvb2xraXQvY29tcGF0L3JhbmdlLmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcmVxdWlyZV9yYW5nZSgpLnJhbmdlOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZGVjaW1hbC5qcy1saWdodEAyLjUuMS9ub2RlX21vZHVsZXMvZGVjaW1hbC5qcy1saWdodC9kZWNpbWFsLmpzCnZhciByZXF1aXJlX2RlY2ltYWwgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL2RlY2ltYWwuanMtbGlnaHRAMi41LjEvbm9kZV9tb2R1bGVzL2RlY2ltYWwuanMtbGlnaHQvZGVjaW1hbC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAoZnVuY3Rpb24oZ2xvYmFsU2NvcGUpIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICB2YXIgTUFYX0RJR0lUUyA9IDFlOSwgRGVjaW1hbDMgPSB7CiAgICAgICAgLy8gVGhlc2UgdmFsdWVzIG11c3QgYmUgaW50ZWdlcnMgd2l0aGluIHRoZSBzdGF0ZWQgcmFuZ2VzIChpbmNsdXNpdmUpLgogICAgICAgIC8vIE1vc3Qgb2YgdGhlc2UgdmFsdWVzIGNhbiBiZSBjaGFuZ2VkIGR1cmluZyBydW4tdGltZSB1c2luZyBgRGVjaW1hbC5jb25maWdgLgogICAgICAgIC8vIFRoZSBtYXhpbXVtIG51bWJlciBvZiBzaWduaWZpY2FudCBkaWdpdHMgb2YgdGhlIHJlc3VsdCBvZiBhIGNhbGN1bGF0aW9uIG9yIGJhc2UgY29udmVyc2lvbi4KICAgICAgICAvLyBFLmcuIGBEZWNpbWFsLmNvbmZpZyh7IHByZWNpc2lvbjogMjAgfSk7YAogICAgICAgIHByZWNpc2lvbjogMjAsCiAgICAgICAgLy8gMSB0byBNQVhfRElHSVRTCiAgICAgICAgLy8gVGhlIHJvdW5kaW5nIG1vZGUgdXNlZCBieSBkZWZhdWx0IGJ5IGB0b0ludGVnZXJgLCBgdG9EZWNpbWFsUGxhY2VzYCwgYHRvRXhwb25lbnRpYWxgLAogICAgICAgIC8vIGB0b0ZpeGVkYCwgYHRvUHJlY2lzaW9uYCBhbmQgYHRvU2lnbmlmaWNhbnREaWdpdHNgLgogICAgICAgIC8vCiAgICAgICAgLy8gUk9VTkRfVVAgICAgICAgICAwIEF3YXkgZnJvbSB6ZXJvLgogICAgICAgIC8vIFJPVU5EX0RPV04gICAgICAgMSBUb3dhcmRzIHplcm8uCiAgICAgICAgLy8gUk9VTkRfQ0VJTCAgICAgICAyIFRvd2FyZHMgK0luZmluaXR5LgogICAgICAgIC8vIFJPVU5EX0ZMT09SICAgICAgMyBUb3dhcmRzIC1JbmZpbml0eS4KICAgICAgICAvLyBST1VORF9IQUxGX1VQICAgIDQgVG93YXJkcyBuZWFyZXN0IG5laWdoYm91ci4gSWYgZXF1aWRpc3RhbnQsIHVwLgogICAgICAgIC8vIFJPVU5EX0hBTEZfRE9XTiAgNSBUb3dhcmRzIG5lYXJlc3QgbmVpZ2hib3VyLiBJZiBlcXVpZGlzdGFudCwgZG93bi4KICAgICAgICAvLyBST1VORF9IQUxGX0VWRU4gIDYgVG93YXJkcyBuZWFyZXN0IG5laWdoYm91ci4gSWYgZXF1aWRpc3RhbnQsIHRvd2FyZHMgZXZlbiBuZWlnaGJvdXIuCiAgICAgICAgLy8gUk9VTkRfSEFMRl9DRUlMICA3IFRvd2FyZHMgbmVhcmVzdCBuZWlnaGJvdXIuIElmIGVxdWlkaXN0YW50LCB0b3dhcmRzICtJbmZpbml0eS4KICAgICAgICAvLyBST1VORF9IQUxGX0ZMT09SIDggVG93YXJkcyBuZWFyZXN0IG5laWdoYm91ci4gSWYgZXF1aWRpc3RhbnQsIHRvd2FyZHMgLUluZmluaXR5LgogICAgICAgIC8vCiAgICAgICAgLy8gRS5nLgogICAgICAgIC8vIGBEZWNpbWFsLnJvdW5kaW5nID0gNDtgCiAgICAgICAgLy8gYERlY2ltYWwucm91bmRpbmcgPSBEZWNpbWFsLlJPVU5EX0hBTEZfVVA7YAogICAgICAgIHJvdW5kaW5nOiA0LAogICAgICAgIC8vIDAgdG8gOAogICAgICAgIC8vIFRoZSBleHBvbmVudCB2YWx1ZSBhdCBhbmQgYmVuZWF0aCB3aGljaCBgdG9TdHJpbmdgIHJldHVybnMgZXhwb25lbnRpYWwgbm90YXRpb24uCiAgICAgICAgLy8gSmF2YVNjcmlwdCBudW1iZXJzOiAtNwogICAgICAgIHRvRXhwTmVnOiAtNywKICAgICAgICAvLyAwIHRvIC1NQVhfRQogICAgICAgIC8vIFRoZSBleHBvbmVudCB2YWx1ZSBhdCBhbmQgYWJvdmUgd2hpY2ggYHRvU3RyaW5nYCByZXR1cm5zIGV4cG9uZW50aWFsIG5vdGF0aW9uLgogICAgICAgIC8vIEphdmFTY3JpcHQgbnVtYmVyczogMjEKICAgICAgICB0b0V4cFBvczogMjEsCiAgICAgICAgLy8gMCB0byBNQVhfRQogICAgICAgIC8vIFRoZSBuYXR1cmFsIGxvZ2FyaXRobSBvZiAxMC4KICAgICAgICAvLyAxMTUgZGlnaXRzCiAgICAgICAgTE4xMDogIjIuMzAyNTg1MDkyOTk0MDQ1Njg0MDE3OTkxNDU0Njg0MzY0MjA3NjAxMTAxNDg4NjI4NzcyOTc2MDMzMzI3OTAwOTY3NTcyNjA5Njc3MzUyNDgwMjM1OTk3MjA1MDg5NTk4Mjk4MzQxOTY3Nzg0MDQyMjg2IgogICAgICB9LCBleHRlcm5hbCA9IHRydWUsIGRlY2ltYWxFcnJvciA9ICJbRGVjaW1hbEVycm9yXSAiLCBpbnZhbGlkQXJndW1lbnQgPSBkZWNpbWFsRXJyb3IgKyAiSW52YWxpZCBhcmd1bWVudDogIiwgZXhwb25lbnRPdXRPZlJhbmdlID0gZGVjaW1hbEVycm9yICsgIkV4cG9uZW50IG91dCBvZiByYW5nZTogIiwgbWF0aGZsb29yID0gTWF0aC5mbG9vciwgbWF0aHBvdyA9IE1hdGgucG93LCBpc0RlY2ltYWwgPSAvXihcZCsoXC5cZCopP3xcLlxkKykoZVsrLV0/XGQrKT8kL2ksIE9ORSwgQkFTRSA9IDFlNywgTE9HX0JBU0UgPSA3LCBNQVhfU0FGRV9JTlRFR0VSID0gOTAwNzE5OTI1NDc0MDk5MSwgTUFYX0UgPSBtYXRoZmxvb3IoTUFYX1NBRkVfSU5URUdFUiAvIExPR19CQVNFKSwgUCA9IHt9OwogICAgICBQLmFic29sdXRlVmFsdWUgPSBQLmFicyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB4MiA9IG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMpOwogICAgICAgIGlmICh4Mi5zKSB4Mi5zID0gMTsKICAgICAgICByZXR1cm4geDI7CiAgICAgIH07CiAgICAgIFAuY29tcGFyZWRUbyA9IFAuY21wID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICB2YXIgaSwgaiwgeGRMLCB5ZEwsIHgyID0gdGhpczsKICAgICAgICB5MiA9IG5ldyB4Mi5jb25zdHJ1Y3Rvcih5Mik7CiAgICAgICAgaWYgKHgyLnMgIT09IHkyLnMpIHJldHVybiB4Mi5zIHx8IC15Mi5zOwogICAgICAgIGlmICh4Mi5lICE9PSB5Mi5lKSByZXR1cm4geDIuZSA+IHkyLmUgXiB4Mi5zIDwgMCA/IDEgOiAtMTsKICAgICAgICB4ZEwgPSB4Mi5kLmxlbmd0aDsKICAgICAgICB5ZEwgPSB5Mi5kLmxlbmd0aDsKICAgICAgICBmb3IgKGkgPSAwLCBqID0geGRMIDwgeWRMID8geGRMIDogeWRMOyBpIDwgajsgKytpKSB7CiAgICAgICAgICBpZiAoeDIuZFtpXSAhPT0geTIuZFtpXSkgcmV0dXJuIHgyLmRbaV0gPiB5Mi5kW2ldIF4geDIucyA8IDAgPyAxIDogLTE7CiAgICAgICAgfQogICAgICAgIHJldHVybiB4ZEwgPT09IHlkTCA/IDAgOiB4ZEwgPiB5ZEwgXiB4Mi5zIDwgMCA/IDEgOiAtMTsKICAgICAgfTsKICAgICAgUC5kZWNpbWFsUGxhY2VzID0gUC5kcCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB4MiA9IHRoaXMsIHcgPSB4Mi5kLmxlbmd0aCAtIDEsIGRwID0gKHcgLSB4Mi5lKSAqIExPR19CQVNFOwogICAgICAgIHcgPSB4Mi5kW3ddOwogICAgICAgIGlmICh3KSBmb3IgKDsgdyAlIDEwID09IDA7IHcgLz0gMTApIGRwLS07CiAgICAgICAgcmV0dXJuIGRwIDwgMCA/IDAgOiBkcDsKICAgICAgfTsKICAgICAgUC5kaXZpZGVkQnkgPSBQLmRpdiA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIGRpdmlkZSh0aGlzLCBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih5MikpOwogICAgICB9OwogICAgICBQLmRpdmlkZWRUb0ludGVnZXJCeSA9IFAuaWRpdiA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIHJldHVybiByb3VuZChkaXZpZGUoeDIsIG5ldyBDdG9yKHkyKSwgMCwgMSksIEN0b3IucHJlY2lzaW9uKTsKICAgICAgfTsKICAgICAgUC5lcXVhbHMgPSBQLmVxID0gZnVuY3Rpb24oeTIpIHsKICAgICAgICByZXR1cm4gIXRoaXMuY21wKHkyKTsKICAgICAgfTsKICAgICAgUC5leHBvbmVudCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRCYXNlMTBFeHBvbmVudCh0aGlzKTsKICAgICAgfTsKICAgICAgUC5ncmVhdGVyVGhhbiA9IFAuZ3QgPSBmdW5jdGlvbih5MikgewogICAgICAgIHJldHVybiB0aGlzLmNtcCh5MikgPiAwOwogICAgICB9OwogICAgICBQLmdyZWF0ZXJUaGFuT3JFcXVhbFRvID0gUC5ndGUgPSBmdW5jdGlvbih5MikgewogICAgICAgIHJldHVybiB0aGlzLmNtcCh5MikgPj0gMDsKICAgICAgfTsKICAgICAgUC5pc0ludGVnZXIgPSBQLmlzaW50ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZSA+IHRoaXMuZC5sZW5ndGggLSAyOwogICAgICB9OwogICAgICBQLmlzTmVnYXRpdmUgPSBQLmlzbmVnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucyA8IDA7CiAgICAgIH07CiAgICAgIFAuaXNQb3NpdGl2ZSA9IFAuaXNwb3MgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zID4gMDsKICAgICAgfTsKICAgICAgUC5pc1plcm8gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zID09PSAwOwogICAgICB9OwogICAgICBQLmxlc3NUaGFuID0gUC5sdCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY21wKHkyKSA8IDA7CiAgICAgIH07CiAgICAgIFAubGVzc1RoYW5PckVxdWFsVG8gPSBQLmx0ZSA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY21wKHkyKSA8IDE7CiAgICAgIH07CiAgICAgIFAubG9nYXJpdGhtID0gUC5sb2cgPSBmdW5jdGlvbihiYXNlKSB7CiAgICAgICAgdmFyIHIyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbiwgd3ByID0gcHIgKyA1OwogICAgICAgIGlmIChiYXNlID09PSB2b2lkIDApIHsKICAgICAgICAgIGJhc2UgPSBuZXcgQ3RvcigxMCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGJhc2UgPSBuZXcgQ3RvcihiYXNlKTsKICAgICAgICAgIGlmIChiYXNlLnMgPCAxIHx8IGJhc2UuZXEoT05FKSkgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk5hTiIpOwogICAgICAgIH0KICAgICAgICBpZiAoeDIucyA8IDEpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICh4Mi5zID8gIk5hTiIgOiAiLUluZmluaXR5IikpOwogICAgICAgIGlmICh4Mi5lcShPTkUpKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgZXh0ZXJuYWwgPSBmYWxzZTsKICAgICAgICByMiA9IGRpdmlkZShsbih4Miwgd3ByKSwgbG4oYmFzZSwgd3ByKSwgd3ByKTsKICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgcmV0dXJuIHJvdW5kKHIyLCBwcik7CiAgICAgIH07CiAgICAgIFAubWludXMgPSBQLnN1YiA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIHgyID0gdGhpczsKICAgICAgICB5MiA9IG5ldyB4Mi5jb25zdHJ1Y3Rvcih5Mik7CiAgICAgICAgcmV0dXJuIHgyLnMgPT0geTIucyA/IHN1YnRyYWN0KHgyLCB5MikgOiBhZGQoeDIsICh5Mi5zID0gLXkyLnMsIHkyKSk7CiAgICAgIH07CiAgICAgIFAubW9kdWxvID0gUC5tb2QgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBxLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICB5MiA9IG5ldyBDdG9yKHkyKTsKICAgICAgICBpZiAoIXkyLnMpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJOYU4iKTsKICAgICAgICBpZiAoIXgyLnMpIHJldHVybiByb3VuZChuZXcgQ3Rvcih4MiksIHByKTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHEgPSBkaXZpZGUoeDIsIHkyLCAwLCAxKS50aW1lcyh5Mik7CiAgICAgICAgZXh0ZXJuYWwgPSB0cnVlOwogICAgICAgIHJldHVybiB4Mi5taW51cyhxKTsKICAgICAgfTsKICAgICAgUC5uYXR1cmFsRXhwb25lbnRpYWwgPSBQLmV4cCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBleHAodGhpcyk7CiAgICAgIH07CiAgICAgIFAubmF0dXJhbExvZ2FyaXRobSA9IFAubG4gPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gbG4odGhpcyk7CiAgICAgIH07CiAgICAgIFAubmVnYXRlZCA9IFAubmVnID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcyk7CiAgICAgICAgeDIucyA9IC14Mi5zIHx8IDA7CiAgICAgICAgcmV0dXJuIHgyOwogICAgICB9OwogICAgICBQLnBsdXMgPSBQLmFkZCA9IGZ1bmN0aW9uKHkyKSB7CiAgICAgICAgdmFyIHgyID0gdGhpczsKICAgICAgICB5MiA9IG5ldyB4Mi5jb25zdHJ1Y3Rvcih5Mik7CiAgICAgICAgcmV0dXJuIHgyLnMgPT0geTIucyA/IGFkZCh4MiwgeTIpIDogc3VidHJhY3QoeDIsICh5Mi5zID0gLXkyLnMsIHkyKSk7CiAgICAgIH07CiAgICAgIFAucHJlY2lzaW9uID0gUC5zZCA9IGZ1bmN0aW9uKHopIHsKICAgICAgICB2YXIgZSwgc2QsIHcsIHgyID0gdGhpczsKICAgICAgICBpZiAoeiAhPT0gdm9pZCAwICYmIHogIT09ICEheiAmJiB6ICE9PSAxICYmIHogIT09IDApIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHopOwogICAgICAgIGUgPSBnZXRCYXNlMTBFeHBvbmVudCh4MikgKyAxOwogICAgICAgIHcgPSB4Mi5kLmxlbmd0aCAtIDE7CiAgICAgICAgc2QgPSB3ICogTE9HX0JBU0UgKyAxOwogICAgICAgIHcgPSB4Mi5kW3ddOwogICAgICAgIGlmICh3KSB7CiAgICAgICAgICBmb3IgKDsgdyAlIDEwID09IDA7IHcgLz0gMTApIHNkLS07CiAgICAgICAgICBmb3IgKHcgPSB4Mi5kWzBdOyB3ID49IDEwOyB3IC89IDEwKSBzZCsrOwogICAgICAgIH0KICAgICAgICByZXR1cm4geiAmJiBlID4gc2QgPyBlIDogc2Q7CiAgICAgIH07CiAgICAgIFAuc3F1YXJlUm9vdCA9IFAuc3FydCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBlLCBuLCBwciwgcjIsIHMsIHQsIHdwciwgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3I7CiAgICAgICAgaWYgKHgyLnMgPCAxKSB7CiAgICAgICAgICBpZiAoIXgyLnMpIHJldHVybiBuZXcgQ3RvcigwKTsKICAgICAgICAgIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJOYU4iKTsKICAgICAgICB9CiAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHMgPSBNYXRoLnNxcnQoK3gyKTsKICAgICAgICBpZiAocyA9PSAwIHx8IHMgPT0gMSAvIDApIHsKICAgICAgICAgIG4gPSBkaWdpdHNUb1N0cmluZyh4Mi5kKTsKICAgICAgICAgIGlmICgobi5sZW5ndGggKyBlKSAlIDIgPT0gMCkgbiArPSAiMCI7CiAgICAgICAgICBzID0gTWF0aC5zcXJ0KG4pOwogICAgICAgICAgZSA9IG1hdGhmbG9vcigoZSArIDEpIC8gMikgLSAoZSA8IDAgfHwgZSAlIDIpOwogICAgICAgICAgaWYgKHMgPT0gMSAvIDApIHsKICAgICAgICAgICAgbiA9ICI1ZSIgKyBlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbiA9IHMudG9FeHBvbmVudGlhbCgpOwogICAgICAgICAgICBuID0gbi5zbGljZSgwLCBuLmluZGV4T2YoImUiKSArIDEpICsgZTsKICAgICAgICAgIH0KICAgICAgICAgIHIyID0gbmV3IEN0b3Iobik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHIyID0gbmV3IEN0b3Iocy50b1N0cmluZygpKTsKICAgICAgICB9CiAgICAgICAgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBzID0gd3ByID0gcHIgKyAzOwogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgdCA9IHIyOwogICAgICAgICAgcjIgPSB0LnBsdXMoZGl2aWRlKHgyLCB0LCB3cHIgKyAyKSkudGltZXMoMC41KTsKICAgICAgICAgIGlmIChkaWdpdHNUb1N0cmluZyh0LmQpLnNsaWNlKDAsIHdwcikgPT09IChuID0gZGlnaXRzVG9TdHJpbmcocjIuZCkpLnNsaWNlKDAsIHdwcikpIHsKICAgICAgICAgICAgbiA9IG4uc2xpY2Uod3ByIC0gMywgd3ByICsgMSk7CiAgICAgICAgICAgIGlmIChzID09IHdwciAmJiBuID09ICI0OTk5IikgewogICAgICAgICAgICAgIHJvdW5kKHQsIHByICsgMSwgMCk7CiAgICAgICAgICAgICAgaWYgKHQudGltZXModCkuZXEoeDIpKSB7CiAgICAgICAgICAgICAgICByMiA9IHQ7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobiAhPSAiOTk5OSIpIHsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICB3cHIgKz0gNDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZXh0ZXJuYWwgPSB0cnVlOwogICAgICAgIHJldHVybiByb3VuZChyMiwgcHIpOwogICAgICB9OwogICAgICBQLnRpbWVzID0gUC5tdWwgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBjYXJyeSwgZSwgaSwgaywgcjIsIHJMLCB0LCB4ZEwsIHlkTCwgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3IsIHhkID0geDIuZCwgeWQgPSAoeTIgPSBuZXcgQ3Rvcih5MikpLmQ7CiAgICAgICAgaWYgKCF4Mi5zIHx8ICF5Mi5zKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgeTIucyAqPSB4Mi5zOwogICAgICAgIGUgPSB4Mi5lICsgeTIuZTsKICAgICAgICB4ZEwgPSB4ZC5sZW5ndGg7CiAgICAgICAgeWRMID0geWQubGVuZ3RoOwogICAgICAgIGlmICh4ZEwgPCB5ZEwpIHsKICAgICAgICAgIHIyID0geGQ7CiAgICAgICAgICB4ZCA9IHlkOwogICAgICAgICAgeWQgPSByMjsKICAgICAgICAgIHJMID0geGRMOwogICAgICAgICAgeGRMID0geWRMOwogICAgICAgICAgeWRMID0gckw7CiAgICAgICAgfQogICAgICAgIHIyID0gW107CiAgICAgICAgckwgPSB4ZEwgKyB5ZEw7CiAgICAgICAgZm9yIChpID0gckw7IGktLTsgKSByMi5wdXNoKDApOwogICAgICAgIGZvciAoaSA9IHlkTDsgLS1pID49IDA7ICkgewogICAgICAgICAgY2FycnkgPSAwOwogICAgICAgICAgZm9yIChrID0geGRMICsgaTsgayA+IGk7ICkgewogICAgICAgICAgICB0ID0gcjJba10gKyB5ZFtpXSAqIHhkW2sgLSBpIC0gMV0gKyBjYXJyeTsKICAgICAgICAgICAgcjJbay0tXSA9IHQgJSBCQVNFIHwgMDsKICAgICAgICAgICAgY2FycnkgPSB0IC8gQkFTRSB8IDA7CiAgICAgICAgICB9CiAgICAgICAgICByMltrXSA9IChyMltrXSArIGNhcnJ5KSAlIEJBU0UgfCAwOwogICAgICAgIH0KICAgICAgICBmb3IgKDsgIXIyWy0tckxdOyApIHIyLnBvcCgpOwogICAgICAgIGlmIChjYXJyeSkgKytlOwogICAgICAgIGVsc2UgcjIuc2hpZnQoKTsKICAgICAgICB5Mi5kID0gcjI7CiAgICAgICAgeTIuZSA9IGU7CiAgICAgICAgcmV0dXJuIGV4dGVybmFsID8gcm91bmQoeTIsIEN0b3IucHJlY2lzaW9uKSA6IHkyOwogICAgICB9OwogICAgICBQLnRvRGVjaW1hbFBsYWNlcyA9IFAudG9kcCA9IGZ1bmN0aW9uKGRwLCBybSkgewogICAgICAgIHZhciB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICB4MiA9IG5ldyBDdG9yKHgyKTsKICAgICAgICBpZiAoZHAgPT09IHZvaWQgMCkgcmV0dXJuIHgyOwogICAgICAgIGNoZWNrSW50MzIoZHAsIDAsIE1BWF9ESUdJVFMpOwogICAgICAgIGlmIChybSA9PT0gdm9pZCAwKSBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgZWxzZSBjaGVja0ludDMyKHJtLCAwLCA4KTsKICAgICAgICByZXR1cm4gcm91bmQoeDIsIGRwICsgZ2V0QmFzZTEwRXhwb25lbnQoeDIpICsgMSwgcm0pOwogICAgICB9OwogICAgICBQLnRvRXhwb25lbnRpYWwgPSBmdW5jdGlvbihkcCwgcm0pIHsKICAgICAgICB2YXIgc3RyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoZHAgPT09IHZvaWQgMCkgewogICAgICAgICAgc3RyID0gdG9TdHJpbmcoeDIsIHRydWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjaGVja0ludDMyKGRwLCAwLCBNQVhfRElHSVRTKTsKICAgICAgICAgIGlmIChybSA9PT0gdm9pZCAwKSBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgICBlbHNlIGNoZWNrSW50MzIocm0sIDAsIDgpOwogICAgICAgICAgeDIgPSByb3VuZChuZXcgQ3Rvcih4MiksIGRwICsgMSwgcm0pOwogICAgICAgICAgc3RyID0gdG9TdHJpbmcoeDIsIHRydWUsIGRwICsgMSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHI7CiAgICAgIH07CiAgICAgIFAudG9GaXhlZCA9IGZ1bmN0aW9uKGRwLCBybSkgewogICAgICAgIHZhciBzdHIsIHkyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoZHAgPT09IHZvaWQgMCkgcmV0dXJuIHRvU3RyaW5nKHgyKTsKICAgICAgICBjaGVja0ludDMyKGRwLCAwLCBNQVhfRElHSVRTKTsKICAgICAgICBpZiAocm0gPT09IHZvaWQgMCkgcm0gPSBDdG9yLnJvdW5kaW5nOwogICAgICAgIGVsc2UgY2hlY2tJbnQzMihybSwgMCwgOCk7CiAgICAgICAgeTIgPSByb3VuZChuZXcgQ3Rvcih4MiksIGRwICsgZ2V0QmFzZTEwRXhwb25lbnQoeDIpICsgMSwgcm0pOwogICAgICAgIHN0ciA9IHRvU3RyaW5nKHkyLmFicygpLCBmYWxzZSwgZHAgKyBnZXRCYXNlMTBFeHBvbmVudCh5MikgKyAxKTsKICAgICAgICByZXR1cm4geDIuaXNuZWcoKSAmJiAheDIuaXNaZXJvKCkgPyAiLSIgKyBzdHIgOiBzdHI7CiAgICAgIH07CiAgICAgIFAudG9JbnRlZ2VyID0gUC50b2ludCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICByZXR1cm4gcm91bmQobmV3IEN0b3IoeDIpLCBnZXRCYXNlMTBFeHBvbmVudCh4MikgKyAxLCBDdG9yLnJvdW5kaW5nKTsKICAgICAgfTsKICAgICAgUC50b051bWJlciA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiArdGhpczsKICAgICAgfTsKICAgICAgUC50b1Bvd2VyID0gUC5wb3cgPSBmdW5jdGlvbih5MikgewogICAgICAgIHZhciBlLCBrLCBwciwgcjIsIHNpZ24yLCB5SXNJbnQsIHgyID0gdGhpcywgQ3RvciA9IHgyLmNvbnN0cnVjdG9yLCBndWFyZCA9IDEyLCB5biA9ICsoeTIgPSBuZXcgQ3Rvcih5MikpOwogICAgICAgIGlmICgheTIucykgcmV0dXJuIG5ldyBDdG9yKE9ORSk7CiAgICAgICAgeDIgPSBuZXcgQ3Rvcih4Mik7CiAgICAgICAgaWYgKCF4Mi5zKSB7CiAgICAgICAgICBpZiAoeTIucyA8IDEpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICJJbmZpbml0eSIpOwogICAgICAgICAgcmV0dXJuIHgyOwogICAgICAgIH0KICAgICAgICBpZiAoeDIuZXEoT05FKSkgcmV0dXJuIHgyOwogICAgICAgIHByID0gQ3Rvci5wcmVjaXNpb247CiAgICAgICAgaWYgKHkyLmVxKE9ORSkpIHJldHVybiByb3VuZCh4MiwgcHIpOwogICAgICAgIGUgPSB5Mi5lOwogICAgICAgIGsgPSB5Mi5kLmxlbmd0aCAtIDE7CiAgICAgICAgeUlzSW50ID0gZSA+PSBrOwogICAgICAgIHNpZ24yID0geDIuczsKICAgICAgICBpZiAoIXlJc0ludCkgewogICAgICAgICAgaWYgKHNpZ24yIDwgMCkgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk5hTiIpOwogICAgICAgIH0gZWxzZSBpZiAoKGsgPSB5biA8IDAgPyAteW4gOiB5bikgPD0gTUFYX1NBRkVfSU5URUdFUikgewogICAgICAgICAgcjIgPSBuZXcgQ3RvcihPTkUpOwogICAgICAgICAgZSA9IE1hdGguY2VpbChwciAvIExPR19CQVNFICsgNCk7CiAgICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgICAgZm9yICg7IDsgKSB7CiAgICAgICAgICAgIGlmIChrICUgMikgewogICAgICAgICAgICAgIHIyID0gcjIudGltZXMoeDIpOwogICAgICAgICAgICAgIHRydW5jYXRlKHIyLmQsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGsgPSBtYXRoZmxvb3IoayAvIDIpOwogICAgICAgICAgICBpZiAoayA9PT0gMCkgYnJlYWs7CiAgICAgICAgICAgIHgyID0geDIudGltZXMoeDIpOwogICAgICAgICAgICB0cnVuY2F0ZSh4Mi5kLCBlKTsKICAgICAgICAgIH0KICAgICAgICAgIGV4dGVybmFsID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiB5Mi5zIDwgMCA/IG5ldyBDdG9yKE9ORSkuZGl2KHIyKSA6IHJvdW5kKHIyLCBwcik7CiAgICAgICAgfQogICAgICAgIHNpZ24yID0gc2lnbjIgPCAwICYmIHkyLmRbTWF0aC5tYXgoZSwgayldICYgMSA/IC0xIDogMTsKICAgICAgICB4Mi5zID0gMTsKICAgICAgICBleHRlcm5hbCA9IGZhbHNlOwogICAgICAgIHIyID0geTIudGltZXMobG4oeDIsIHByICsgZ3VhcmQpKTsKICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgcjIgPSBleHAocjIpOwogICAgICAgIHIyLnMgPSBzaWduMjsKICAgICAgICByZXR1cm4gcjI7CiAgICAgIH07CiAgICAgIFAudG9QcmVjaXNpb24gPSBmdW5jdGlvbihzZCwgcm0pIHsKICAgICAgICB2YXIgZSwgc3RyLCB4MiA9IHRoaXMsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvcjsKICAgICAgICBpZiAoc2QgPT09IHZvaWQgMCkgewogICAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKTsKICAgICAgICAgIHN0ciA9IHRvU3RyaW5nKHgyLCBlIDw9IEN0b3IudG9FeHBOZWcgfHwgZSA+PSBDdG9yLnRvRXhwUG9zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2hlY2tJbnQzMihzZCwgMSwgTUFYX0RJR0lUUyk7CiAgICAgICAgICBpZiAocm0gPT09IHZvaWQgMCkgcm0gPSBDdG9yLnJvdW5kaW5nOwogICAgICAgICAgZWxzZSBjaGVja0ludDMyKHJtLCAwLCA4KTsKICAgICAgICAgIHgyID0gcm91bmQobmV3IEN0b3IoeDIpLCBzZCwgcm0pOwogICAgICAgICAgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKTsKICAgICAgICAgIHN0ciA9IHRvU3RyaW5nKHgyLCBzZCA8PSBlIHx8IGUgPD0gQ3Rvci50b0V4cE5lZywgc2QpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyOwogICAgICB9OwogICAgICBQLnRvU2lnbmlmaWNhbnREaWdpdHMgPSBQLnRvc2QgPSBmdW5jdGlvbihzZCwgcm0pIHsKICAgICAgICB2YXIgeDIgPSB0aGlzLCBDdG9yID0geDIuY29uc3RydWN0b3I7CiAgICAgICAgaWYgKHNkID09PSB2b2lkIDApIHsKICAgICAgICAgIHNkID0gQ3Rvci5wcmVjaXNpb247CiAgICAgICAgICBybSA9IEN0b3Iucm91bmRpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNoZWNrSW50MzIoc2QsIDEsIE1BWF9ESUdJVFMpOwogICAgICAgICAgaWYgKHJtID09PSB2b2lkIDApIHJtID0gQ3Rvci5yb3VuZGluZzsKICAgICAgICAgIGVsc2UgY2hlY2tJbnQzMihybSwgMCwgOCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByb3VuZChuZXcgQ3Rvcih4MiksIHNkLCBybSk7CiAgICAgIH07CiAgICAgIFAudG9TdHJpbmcgPSBQLnZhbHVlT2YgPSBQLnZhbCA9IFAudG9KU09OID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHgyID0gdGhpcywgZSA9IGdldEJhc2UxMEV4cG9uZW50KHgyKSwgQ3RvciA9IHgyLmNvbnN0cnVjdG9yOwogICAgICAgIHJldHVybiB0b1N0cmluZyh4MiwgZSA8PSBDdG9yLnRvRXhwTmVnIHx8IGUgPj0gQ3Rvci50b0V4cFBvcyk7CiAgICAgIH07CiAgICAgIGZ1bmN0aW9uIGFkZCh4MiwgeTIpIHsKICAgICAgICB2YXIgY2FycnksIGQsIGUsIGksIGssIGxlbiwgeGQsIHlkLCBDdG9yID0geDIuY29uc3RydWN0b3IsIHByID0gQ3Rvci5wcmVjaXNpb247CiAgICAgICAgaWYgKCF4Mi5zIHx8ICF5Mi5zKSB7CiAgICAgICAgICBpZiAoIXkyLnMpIHkyID0gbmV3IEN0b3IoeDIpOwogICAgICAgICAgcmV0dXJuIGV4dGVybmFsID8gcm91bmQoeTIsIHByKSA6IHkyOwogICAgICAgIH0KICAgICAgICB4ZCA9IHgyLmQ7CiAgICAgICAgeWQgPSB5Mi5kOwogICAgICAgIGsgPSB4Mi5lOwogICAgICAgIGUgPSB5Mi5lOwogICAgICAgIHhkID0geGQuc2xpY2UoKTsKICAgICAgICBpID0gayAtIGU7CiAgICAgICAgaWYgKGkpIHsKICAgICAgICAgIGlmIChpIDwgMCkgewogICAgICAgICAgICBkID0geGQ7CiAgICAgICAgICAgIGkgPSAtaTsKICAgICAgICAgICAgbGVuID0geWQubGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZCA9IHlkOwogICAgICAgICAgICBlID0gazsKICAgICAgICAgICAgbGVuID0geGQubGVuZ3RoOwogICAgICAgICAgfQogICAgICAgICAgayA9IE1hdGguY2VpbChwciAvIExPR19CQVNFKTsKICAgICAgICAgIGxlbiA9IGsgPiBsZW4gPyBrICsgMSA6IGxlbiArIDE7CiAgICAgICAgICBpZiAoaSA+IGxlbikgewogICAgICAgICAgICBpID0gbGVuOwogICAgICAgICAgICBkLmxlbmd0aCA9IDE7CiAgICAgICAgICB9CiAgICAgICAgICBkLnJldmVyc2UoKTsKICAgICAgICAgIGZvciAoOyBpLS07ICkgZC5wdXNoKDApOwogICAgICAgICAgZC5yZXZlcnNlKCk7CiAgICAgICAgfQogICAgICAgIGxlbiA9IHhkLmxlbmd0aDsKICAgICAgICBpID0geWQubGVuZ3RoOwogICAgICAgIGlmIChsZW4gLSBpIDwgMCkgewogICAgICAgICAgaSA9IGxlbjsKICAgICAgICAgIGQgPSB5ZDsKICAgICAgICAgIHlkID0geGQ7CiAgICAgICAgICB4ZCA9IGQ7CiAgICAgICAgfQogICAgICAgIGZvciAoY2FycnkgPSAwOyBpOyApIHsKICAgICAgICAgIGNhcnJ5ID0gKHhkWy0taV0gPSB4ZFtpXSArIHlkW2ldICsgY2FycnkpIC8gQkFTRSB8IDA7CiAgICAgICAgICB4ZFtpXSAlPSBCQVNFOwogICAgICAgIH0KICAgICAgICBpZiAoY2FycnkpIHsKICAgICAgICAgIHhkLnVuc2hpZnQoY2FycnkpOwogICAgICAgICAgKytlOwogICAgICAgIH0KICAgICAgICBmb3IgKGxlbiA9IHhkLmxlbmd0aDsgeGRbLS1sZW5dID09IDA7ICkgeGQucG9wKCk7CiAgICAgICAgeTIuZCA9IHhkOwogICAgICAgIHkyLmUgPSBlOwogICAgICAgIHJldHVybiBleHRlcm5hbCA/IHJvdW5kKHkyLCBwcikgOiB5MjsKICAgICAgfQogICAgICBmdW5jdGlvbiBjaGVja0ludDMyKGksIG1pbjIsIG1heDIpIHsKICAgICAgICBpZiAoaSAhPT0gfn5pIHx8IGkgPCBtaW4yIHx8IGkgPiBtYXgyKSB7CiAgICAgICAgICB0aHJvdyBFcnJvcihpbnZhbGlkQXJndW1lbnQgKyBpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZGlnaXRzVG9TdHJpbmcoZCkgewogICAgICAgIHZhciBpLCBrLCB3cywgaW5kZXhPZkxhc3RXb3JkID0gZC5sZW5ndGggLSAxLCBzdHIgPSAiIiwgdyA9IGRbMF07CiAgICAgICAgaWYgKGluZGV4T2ZMYXN0V29yZCA+IDApIHsKICAgICAgICAgIHN0ciArPSB3OwogICAgICAgICAgZm9yIChpID0gMTsgaSA8IGluZGV4T2ZMYXN0V29yZDsgaSsrKSB7CiAgICAgICAgICAgIHdzID0gZFtpXSArICIiOwogICAgICAgICAgICBrID0gTE9HX0JBU0UgLSB3cy5sZW5ndGg7CiAgICAgICAgICAgIGlmIChrKSBzdHIgKz0gZ2V0WmVyb1N0cmluZyhrKTsKICAgICAgICAgICAgc3RyICs9IHdzOwogICAgICAgICAgfQogICAgICAgICAgdyA9IGRbaV07CiAgICAgICAgICB3cyA9IHcgKyAiIjsKICAgICAgICAgIGsgPSBMT0dfQkFTRSAtIHdzLmxlbmd0aDsKICAgICAgICAgIGlmIChrKSBzdHIgKz0gZ2V0WmVyb1N0cmluZyhrKTsKICAgICAgICB9IGVsc2UgaWYgKHcgPT09IDApIHsKICAgICAgICAgIHJldHVybiAiMCI7CiAgICAgICAgfQogICAgICAgIGZvciAoOyB3ICUgMTAgPT09IDA7ICkgdyAvPSAxMDsKICAgICAgICByZXR1cm4gc3RyICsgdzsKICAgICAgfQogICAgICB2YXIgZGl2aWRlID0gLyogQF9fUFVSRV9fICovIGZ1bmN0aW9uKCkgewogICAgICAgIGZ1bmN0aW9uIG11bHRpcGx5SW50ZWdlcih4MiwgaykgewogICAgICAgICAgdmFyIHRlbXAsIGNhcnJ5ID0gMCwgaSA9IHgyLmxlbmd0aDsKICAgICAgICAgIGZvciAoeDIgPSB4Mi5zbGljZSgpOyBpLS07ICkgewogICAgICAgICAgICB0ZW1wID0geDJbaV0gKiBrICsgY2Fycnk7CiAgICAgICAgICAgIHgyW2ldID0gdGVtcCAlIEJBU0UgfCAwOwogICAgICAgICAgICBjYXJyeSA9IHRlbXAgLyBCQVNFIHwgMDsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjYXJyeSkgeDIudW5zaGlmdChjYXJyeSk7CiAgICAgICAgICByZXR1cm4geDI7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGNvbXBhcmUoYSwgYiwgYUwsIGJMKSB7CiAgICAgICAgICB2YXIgaSwgcjI7CiAgICAgICAgICBpZiAoYUwgIT0gYkwpIHsKICAgICAgICAgICAgcjIgPSBhTCA+IGJMID8gMSA6IC0xOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZm9yIChpID0gcjIgPSAwOyBpIDwgYUw7IGkrKykgewogICAgICAgICAgICAgIGlmIChhW2ldICE9IGJbaV0pIHsKICAgICAgICAgICAgICAgIHIyID0gYVtpXSA+IGJbaV0gPyAxIDogLTE7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByMjsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc3VidHJhY3QyKGEsIGIsIGFMKSB7CiAgICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgICBmb3IgKDsgYUwtLTsgKSB7CiAgICAgICAgICAgIGFbYUxdIC09IGk7CiAgICAgICAgICAgIGkgPSBhW2FMXSA8IGJbYUxdID8gMSA6IDA7CiAgICAgICAgICAgIGFbYUxdID0gaSAqIEJBU0UgKyBhW2FMXSAtIGJbYUxdOwogICAgICAgICAgfQogICAgICAgICAgZm9yICg7ICFhWzBdICYmIGEubGVuZ3RoID4gMTsgKSBhLnNoaWZ0KCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmdW5jdGlvbih4MiwgeTIsIHByLCBkcCkgewogICAgICAgICAgdmFyIGNtcCwgZSwgaSwgaywgcHJvZCwgcHJvZEwsIHEsIHFkLCByZW0sIHJlbUwsIHJlbTAsIHNkLCB0LCB4aSwgeEwsIHlkMCwgeUwsIHl6LCBDdG9yID0geDIuY29uc3RydWN0b3IsIHNpZ24yID0geDIucyA9PSB5Mi5zID8gMSA6IC0xLCB4ZCA9IHgyLmQsIHlkID0geTIuZDsKICAgICAgICAgIGlmICgheDIucykgcmV0dXJuIG5ldyBDdG9yKHgyKTsKICAgICAgICAgIGlmICgheTIucykgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIkRpdmlzaW9uIGJ5IHplcm8iKTsKICAgICAgICAgIGUgPSB4Mi5lIC0geTIuZTsKICAgICAgICAgIHlMID0geWQubGVuZ3RoOwogICAgICAgICAgeEwgPSB4ZC5sZW5ndGg7CiAgICAgICAgICBxID0gbmV3IEN0b3Ioc2lnbjIpOwogICAgICAgICAgcWQgPSBxLmQgPSBbXTsKICAgICAgICAgIGZvciAoaSA9IDA7IHlkW2ldID09ICh4ZFtpXSB8fCAwKTsgKSArK2k7CiAgICAgICAgICBpZiAoeWRbaV0gPiAoeGRbaV0gfHwgMCkpIC0tZTsKICAgICAgICAgIGlmIChwciA9PSBudWxsKSB7CiAgICAgICAgICAgIHNkID0gcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICAgIH0gZWxzZSBpZiAoZHApIHsKICAgICAgICAgICAgc2QgPSBwciArIChnZXRCYXNlMTBFeHBvbmVudCh4MikgLSBnZXRCYXNlMTBFeHBvbmVudCh5MikpICsgMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNkID0gcHI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoc2QgPCAwKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgICBzZCA9IHNkIC8gTE9HX0JBU0UgKyAyIHwgMDsKICAgICAgICAgIGkgPSAwOwogICAgICAgICAgaWYgKHlMID09IDEpIHsKICAgICAgICAgICAgayA9IDA7CiAgICAgICAgICAgIHlkID0geWRbMF07CiAgICAgICAgICAgIHNkKys7CiAgICAgICAgICAgIGZvciAoOyAoaSA8IHhMIHx8IGspICYmIHNkLS07IGkrKykgewogICAgICAgICAgICAgIHQgPSBrICogQkFTRSArICh4ZFtpXSB8fCAwKTsKICAgICAgICAgICAgICBxZFtpXSA9IHQgLyB5ZCB8IDA7CiAgICAgICAgICAgICAgayA9IHQgJSB5ZCB8IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGsgPSBCQVNFIC8gKHlkWzBdICsgMSkgfCAwOwogICAgICAgICAgICBpZiAoayA+IDEpIHsKICAgICAgICAgICAgICB5ZCA9IG11bHRpcGx5SW50ZWdlcih5ZCwgayk7CiAgICAgICAgICAgICAgeGQgPSBtdWx0aXBseUludGVnZXIoeGQsIGspOwogICAgICAgICAgICAgIHlMID0geWQubGVuZ3RoOwogICAgICAgICAgICAgIHhMID0geGQubGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHhpID0geUw7CiAgICAgICAgICAgIHJlbSA9IHhkLnNsaWNlKDAsIHlMKTsKICAgICAgICAgICAgcmVtTCA9IHJlbS5sZW5ndGg7CiAgICAgICAgICAgIGZvciAoOyByZW1MIDwgeUw7ICkgcmVtW3JlbUwrK10gPSAwOwogICAgICAgICAgICB5eiA9IHlkLnNsaWNlKCk7CiAgICAgICAgICAgIHl6LnVuc2hpZnQoMCk7CiAgICAgICAgICAgIHlkMCA9IHlkWzBdOwogICAgICAgICAgICBpZiAoeWRbMV0gPj0gQkFTRSAvIDIpICsreWQwOwogICAgICAgICAgICBkbyB7CiAgICAgICAgICAgICAgayA9IDA7CiAgICAgICAgICAgICAgY21wID0gY29tcGFyZSh5ZCwgcmVtLCB5TCwgcmVtTCk7CiAgICAgICAgICAgICAgaWYgKGNtcCA8IDApIHsKICAgICAgICAgICAgICAgIHJlbTAgPSByZW1bMF07CiAgICAgICAgICAgICAgICBpZiAoeUwgIT0gcmVtTCkgcmVtMCA9IHJlbTAgKiBCQVNFICsgKHJlbVsxXSB8fCAwKTsKICAgICAgICAgICAgICAgIGsgPSByZW0wIC8geWQwIHwgMDsKICAgICAgICAgICAgICAgIGlmIChrID4gMSkgewogICAgICAgICAgICAgICAgICBpZiAoayA+PSBCQVNFKSBrID0gQkFTRSAtIDE7CiAgICAgICAgICAgICAgICAgIHByb2QgPSBtdWx0aXBseUludGVnZXIoeWQsIGspOwogICAgICAgICAgICAgICAgICBwcm9kTCA9IHByb2QubGVuZ3RoOwogICAgICAgICAgICAgICAgICByZW1MID0gcmVtLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgY21wID0gY29tcGFyZShwcm9kLCByZW0sIHByb2RMLCByZW1MKTsKICAgICAgICAgICAgICAgICAgaWYgKGNtcCA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgay0tOwogICAgICAgICAgICAgICAgICAgIHN1YnRyYWN0Mihwcm9kLCB5TCA8IHByb2RMID8geXogOiB5ZCwgcHJvZEwpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBpZiAoayA9PSAwKSBjbXAgPSBrID0gMTsKICAgICAgICAgICAgICAgICAgcHJvZCA9IHlkLnNsaWNlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwcm9kTCA9IHByb2QubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKHByb2RMIDwgcmVtTCkgcHJvZC51bnNoaWZ0KDApOwogICAgICAgICAgICAgICAgc3VidHJhY3QyKHJlbSwgcHJvZCwgcmVtTCk7CiAgICAgICAgICAgICAgICBpZiAoY21wID09IC0xKSB7CiAgICAgICAgICAgICAgICAgIHJlbUwgPSByZW0ubGVuZ3RoOwogICAgICAgICAgICAgICAgICBjbXAgPSBjb21wYXJlKHlkLCByZW0sIHlMLCByZW1MKTsKICAgICAgICAgICAgICAgICAgaWYgKGNtcCA8IDEpIHsKICAgICAgICAgICAgICAgICAgICBrKys7CiAgICAgICAgICAgICAgICAgICAgc3VidHJhY3QyKHJlbSwgeUwgPCByZW1MID8geXogOiB5ZCwgcmVtTCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJlbUwgPSByZW0ubGVuZ3RoOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoY21wID09PSAwKSB7CiAgICAgICAgICAgICAgICBrKys7CiAgICAgICAgICAgICAgICByZW0gPSBbMF07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHFkW2krK10gPSBrOwogICAgICAgICAgICAgIGlmIChjbXAgJiYgcmVtWzBdKSB7CiAgICAgICAgICAgICAgICByZW1bcmVtTCsrXSA9IHhkW3hpXSB8fCAwOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZW0gPSBbeGRbeGldXTsKICAgICAgICAgICAgICAgIHJlbUwgPSAxOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoKHhpKysgPCB4TCB8fCByZW1bMF0gIT09IHZvaWQgMCkgJiYgc2QtLSk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXFkWzBdKSBxZC5zaGlmdCgpOwogICAgICAgICAgcS5lID0gZTsKICAgICAgICAgIHJldHVybiByb3VuZChxLCBkcCA/IHByICsgZ2V0QmFzZTEwRXhwb25lbnQocSkgKyAxIDogcHIpOwogICAgICAgIH07CiAgICAgIH0oKTsKICAgICAgZnVuY3Rpb24gZXhwKHgyLCBzZCkgewogICAgICAgIHZhciBkZW5vbWluYXRvciwgZ3VhcmQsIHBvdzIsIHN1bSwgdCwgd3ByLCBpID0gMCwgayA9IDAsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoZ2V0QmFzZTEwRXhwb25lbnQoeDIpID4gMTYpIHRocm93IEVycm9yKGV4cG9uZW50T3V0T2ZSYW5nZSArIGdldEJhc2UxMEV4cG9uZW50KHgyKSk7CiAgICAgICAgaWYgKCF4Mi5zKSByZXR1cm4gbmV3IEN0b3IoT05FKTsKICAgICAgICBpZiAoc2QgPT0gbnVsbCkgewogICAgICAgICAgZXh0ZXJuYWwgPSBmYWxzZTsKICAgICAgICAgIHdwciA9IHByOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3cHIgPSBzZDsKICAgICAgICB9CiAgICAgICAgdCA9IG5ldyBDdG9yKDAuMDMxMjUpOwogICAgICAgIHdoaWxlICh4Mi5hYnMoKS5ndGUoMC4xKSkgewogICAgICAgICAgeDIgPSB4Mi50aW1lcyh0KTsKICAgICAgICAgIGsgKz0gNTsKICAgICAgICB9CiAgICAgICAgZ3VhcmQgPSBNYXRoLmxvZyhtYXRocG93KDIsIGspKSAvIE1hdGguTE4xMCAqIDIgKyA1IHwgMDsKICAgICAgICB3cHIgKz0gZ3VhcmQ7CiAgICAgICAgZGVub21pbmF0b3IgPSBwb3cyID0gc3VtID0gbmV3IEN0b3IoT05FKTsKICAgICAgICBDdG9yLnByZWNpc2lvbiA9IHdwcjsKICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgIHBvdzIgPSByb3VuZChwb3cyLnRpbWVzKHgyKSwgd3ByKTsKICAgICAgICAgIGRlbm9taW5hdG9yID0gZGVub21pbmF0b3IudGltZXMoKytpKTsKICAgICAgICAgIHQgPSBzdW0ucGx1cyhkaXZpZGUocG93MiwgZGVub21pbmF0b3IsIHdwcikpOwogICAgICAgICAgaWYgKGRpZ2l0c1RvU3RyaW5nKHQuZCkuc2xpY2UoMCwgd3ByKSA9PT0gZGlnaXRzVG9TdHJpbmcoc3VtLmQpLnNsaWNlKDAsIHdwcikpIHsKICAgICAgICAgICAgd2hpbGUgKGstLSkgc3VtID0gcm91bmQoc3VtLnRpbWVzKHN1bSksIHdwcik7CiAgICAgICAgICAgIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICAgIHJldHVybiBzZCA9PSBudWxsID8gKGV4dGVybmFsID0gdHJ1ZSwgcm91bmQoc3VtLCBwcikpIDogc3VtOwogICAgICAgICAgfQogICAgICAgICAgc3VtID0gdDsKICAgICAgICB9CiAgICAgIH0KICAgICAgZnVuY3Rpb24gZ2V0QmFzZTEwRXhwb25lbnQoeDIpIHsKICAgICAgICB2YXIgZSA9IHgyLmUgKiBMT0dfQkFTRSwgdyA9IHgyLmRbMF07CiAgICAgICAgZm9yICg7IHcgPj0gMTA7IHcgLz0gMTApIGUrKzsKICAgICAgICByZXR1cm4gZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRMbjEwKEN0b3IsIHNkLCBwcikgewogICAgICAgIGlmIChzZCA+IEN0b3IuTE4xMC5zZCgpKSB7CiAgICAgICAgICBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgICBpZiAocHIpIEN0b3IucHJlY2lzaW9uID0gcHI7CiAgICAgICAgICB0aHJvdyBFcnJvcihkZWNpbWFsRXJyb3IgKyAiTE4xMCBwcmVjaXNpb24gbGltaXQgZXhjZWVkZWQiKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJvdW5kKG5ldyBDdG9yKEN0b3IuTE4xMCksIHNkKTsKICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRaZXJvU3RyaW5nKGspIHsKICAgICAgICB2YXIgenMgPSAiIjsKICAgICAgICBmb3IgKDsgay0tOyApIHpzICs9ICIwIjsKICAgICAgICByZXR1cm4genM7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gbG4oeTIsIHNkKSB7CiAgICAgICAgdmFyIGMsIGMwLCBkZW5vbWluYXRvciwgZSwgbnVtZXJhdG9yLCBzdW0sIHQsIHdwciwgeDIsIG4gPSAxLCBndWFyZCA9IDEwLCB4MyA9IHkyLCB4ZCA9IHgzLmQsIEN0b3IgPSB4My5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoeDMucyA8IDEpIHRocm93IEVycm9yKGRlY2ltYWxFcnJvciArICh4My5zID8gIk5hTiIgOiAiLUluZmluaXR5IikpOwogICAgICAgIGlmICh4My5lcShPTkUpKSByZXR1cm4gbmV3IEN0b3IoMCk7CiAgICAgICAgaWYgKHNkID09IG51bGwpIHsKICAgICAgICAgIGV4dGVybmFsID0gZmFsc2U7CiAgICAgICAgICB3cHIgPSBwcjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd3ByID0gc2Q7CiAgICAgICAgfQogICAgICAgIGlmICh4My5lcSgxMCkpIHsKICAgICAgICAgIGlmIChzZCA9PSBudWxsKSBleHRlcm5hbCA9IHRydWU7CiAgICAgICAgICByZXR1cm4gZ2V0TG4xMChDdG9yLCB3cHIpOwogICAgICAgIH0KICAgICAgICB3cHIgKz0gZ3VhcmQ7CiAgICAgICAgQ3Rvci5wcmVjaXNpb24gPSB3cHI7CiAgICAgICAgYyA9IGRpZ2l0c1RvU3RyaW5nKHhkKTsKICAgICAgICBjMCA9IGMuY2hhckF0KDApOwogICAgICAgIGUgPSBnZXRCYXNlMTBFeHBvbmVudCh4Myk7CiAgICAgICAgaWYgKE1hdGguYWJzKGUpIDwgMTVlMTQpIHsKICAgICAgICAgIHdoaWxlIChjMCA8IDcgJiYgYzAgIT0gMSB8fCBjMCA9PSAxICYmIGMuY2hhckF0KDEpID4gMykgewogICAgICAgICAgICB4MyA9IHgzLnRpbWVzKHkyKTsKICAgICAgICAgICAgYyA9IGRpZ2l0c1RvU3RyaW5nKHgzLmQpOwogICAgICAgICAgICBjMCA9IGMuY2hhckF0KDApOwogICAgICAgICAgICBuKys7CiAgICAgICAgICB9CiAgICAgICAgICBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDMpOwogICAgICAgICAgaWYgKGMwID4gMSkgewogICAgICAgICAgICB4MyA9IG5ldyBDdG9yKCIwLiIgKyBjKTsKICAgICAgICAgICAgZSsrOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgeDMgPSBuZXcgQ3RvcihjMCArICIuIiArIGMuc2xpY2UoMSkpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0ID0gZ2V0TG4xMChDdG9yLCB3cHIgKyAyLCBwcikudGltZXMoZSArICIiKTsKICAgICAgICAgIHgzID0gbG4obmV3IEN0b3IoYzAgKyAiLiIgKyBjLnNsaWNlKDEpKSwgd3ByIC0gZ3VhcmQpLnBsdXModCk7CiAgICAgICAgICBDdG9yLnByZWNpc2lvbiA9IHByOwogICAgICAgICAgcmV0dXJuIHNkID09IG51bGwgPyAoZXh0ZXJuYWwgPSB0cnVlLCByb3VuZCh4MywgcHIpKSA6IHgzOwogICAgICAgIH0KICAgICAgICBzdW0gPSBudW1lcmF0b3IgPSB4MyA9IGRpdmlkZSh4My5taW51cyhPTkUpLCB4My5wbHVzKE9ORSksIHdwcik7CiAgICAgICAgeDIgPSByb3VuZCh4My50aW1lcyh4MyksIHdwcik7CiAgICAgICAgZGVub21pbmF0b3IgPSAzOwogICAgICAgIGZvciAoOyA7ICkgewogICAgICAgICAgbnVtZXJhdG9yID0gcm91bmQobnVtZXJhdG9yLnRpbWVzKHgyKSwgd3ByKTsKICAgICAgICAgIHQgPSBzdW0ucGx1cyhkaXZpZGUobnVtZXJhdG9yLCBuZXcgQ3RvcihkZW5vbWluYXRvciksIHdwcikpOwogICAgICAgICAgaWYgKGRpZ2l0c1RvU3RyaW5nKHQuZCkuc2xpY2UoMCwgd3ByKSA9PT0gZGlnaXRzVG9TdHJpbmcoc3VtLmQpLnNsaWNlKDAsIHdwcikpIHsKICAgICAgICAgICAgc3VtID0gc3VtLnRpbWVzKDIpOwogICAgICAgICAgICBpZiAoZSAhPT0gMCkgc3VtID0gc3VtLnBsdXMoZ2V0TG4xMChDdG9yLCB3cHIgKyAyLCBwcikudGltZXMoZSArICIiKSk7CiAgICAgICAgICAgIHN1bSA9IGRpdmlkZShzdW0sIG5ldyBDdG9yKG4pLCB3cHIpOwogICAgICAgICAgICBDdG9yLnByZWNpc2lvbiA9IHByOwogICAgICAgICAgICByZXR1cm4gc2QgPT0gbnVsbCA/IChleHRlcm5hbCA9IHRydWUsIHJvdW5kKHN1bSwgcHIpKSA6IHN1bTsKICAgICAgICAgIH0KICAgICAgICAgIHN1bSA9IHQ7CiAgICAgICAgICBkZW5vbWluYXRvciArPSAyOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBwYXJzZURlY2ltYWwoeDIsIHN0cikgewogICAgICAgIHZhciBlLCBpLCBsZW47CiAgICAgICAgaWYgKChlID0gc3RyLmluZGV4T2YoIi4iKSkgPiAtMSkgc3RyID0gc3RyLnJlcGxhY2UoIi4iLCAiIik7CiAgICAgICAgaWYgKChpID0gc3RyLnNlYXJjaCgvZS9pKSkgPiAwKSB7CiAgICAgICAgICBpZiAoZSA8IDApIGUgPSBpOwogICAgICAgICAgZSArPSArc3RyLnNsaWNlKGkgKyAxKTsKICAgICAgICAgIHN0ciA9IHN0ci5zdWJzdHJpbmcoMCwgaSk7CiAgICAgICAgfSBlbHNlIGlmIChlIDwgMCkgewogICAgICAgICAgZSA9IHN0ci5sZW5ndGg7CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IDA7IHN0ci5jaGFyQ29kZUF0KGkpID09PSA0ODsgKSArK2k7CiAgICAgICAgZm9yIChsZW4gPSBzdHIubGVuZ3RoOyBzdHIuY2hhckNvZGVBdChsZW4gLSAxKSA9PT0gNDg7ICkgLS1sZW47CiAgICAgICAgc3RyID0gc3RyLnNsaWNlKGksIGxlbik7CiAgICAgICAgaWYgKHN0cikgewogICAgICAgICAgbGVuIC09IGk7CiAgICAgICAgICBlID0gZSAtIGkgLSAxOwogICAgICAgICAgeDIuZSA9IG1hdGhmbG9vcihlIC8gTE9HX0JBU0UpOwogICAgICAgICAgeDIuZCA9IFtdOwogICAgICAgICAgaSA9IChlICsgMSkgJSBMT0dfQkFTRTsKICAgICAgICAgIGlmIChlIDwgMCkgaSArPSBMT0dfQkFTRTsKICAgICAgICAgIGlmIChpIDwgbGVuKSB7CiAgICAgICAgICAgIGlmIChpKSB4Mi5kLnB1c2goK3N0ci5zbGljZSgwLCBpKSk7CiAgICAgICAgICAgIGZvciAobGVuIC09IExPR19CQVNFOyBpIDwgbGVuOyApIHgyLmQucHVzaCgrc3RyLnNsaWNlKGksIGkgKz0gTE9HX0JBU0UpKTsKICAgICAgICAgICAgc3RyID0gc3RyLnNsaWNlKGkpOwogICAgICAgICAgICBpID0gTE9HX0JBU0UgLSBzdHIubGVuZ3RoOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaSAtPSBsZW47CiAgICAgICAgICB9CiAgICAgICAgICBmb3IgKDsgaS0tOyApIHN0ciArPSAiMCI7CiAgICAgICAgICB4Mi5kLnB1c2goK3N0cik7CiAgICAgICAgICBpZiAoZXh0ZXJuYWwgJiYgKHgyLmUgPiBNQVhfRSB8fCB4Mi5lIDwgLU1BWF9FKSkgdGhyb3cgRXJyb3IoZXhwb25lbnRPdXRPZlJhbmdlICsgZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHgyLnMgPSAwOwogICAgICAgICAgeDIuZSA9IDA7CiAgICAgICAgICB4Mi5kID0gWzBdOwogICAgICAgIH0KICAgICAgICByZXR1cm4geDI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gcm91bmQoeDIsIHNkLCBybSkgewogICAgICAgIHZhciBpLCBqLCBrLCBuLCByZCwgZG9Sb3VuZCwgdywgeGRpLCB4ZCA9IHgyLmQ7CiAgICAgICAgZm9yIChuID0gMSwgayA9IHhkWzBdOyBrID49IDEwOyBrIC89IDEwKSBuKys7CiAgICAgICAgaSA9IHNkIC0gbjsKICAgICAgICBpZiAoaSA8IDApIHsKICAgICAgICAgIGkgKz0gTE9HX0JBU0U7CiAgICAgICAgICBqID0gc2Q7CiAgICAgICAgICB3ID0geGRbeGRpID0gMF07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHhkaSA9IE1hdGguY2VpbCgoaSArIDEpIC8gTE9HX0JBU0UpOwogICAgICAgICAgayA9IHhkLmxlbmd0aDsKICAgICAgICAgIGlmICh4ZGkgPj0gaykgcmV0dXJuIHgyOwogICAgICAgICAgdyA9IGsgPSB4ZFt4ZGldOwogICAgICAgICAgZm9yIChuID0gMTsgayA+PSAxMDsgayAvPSAxMCkgbisrOwogICAgICAgICAgaSAlPSBMT0dfQkFTRTsKICAgICAgICAgIGogPSBpIC0gTE9HX0JBU0UgKyBuOwogICAgICAgIH0KICAgICAgICBpZiAocm0gIT09IHZvaWQgMCkgewogICAgICAgICAgayA9IG1hdGhwb3coMTAsIG4gLSBqIC0gMSk7CiAgICAgICAgICByZCA9IHcgLyBrICUgMTAgfCAwOwogICAgICAgICAgZG9Sb3VuZCA9IHNkIDwgMCB8fCB4ZFt4ZGkgKyAxXSAhPT0gdm9pZCAwIHx8IHcgJSBrOwogICAgICAgICAgZG9Sb3VuZCA9IHJtIDwgNCA/IChyZCB8fCBkb1JvdW5kKSAmJiAocm0gPT0gMCB8fCBybSA9PSAoeDIucyA8IDAgPyAzIDogMikpIDogcmQgPiA1IHx8IHJkID09IDUgJiYgKHJtID09IDQgfHwgZG9Sb3VuZCB8fCBybSA9PSA2ICYmIC8vIENoZWNrIHdoZXRoZXIgdGhlIGRpZ2l0IHRvIHRoZSBsZWZ0IG9mIHRoZSByb3VuZGluZyBkaWdpdCBpcyBvZGQuCiAgICAgICAgICAoaSA+IDAgPyBqID4gMCA/IHcgLyBtYXRocG93KDEwLCBuIC0gaikgOiAwIDogeGRbeGRpIC0gMV0pICUgMTAgJiAxIHx8IHJtID09ICh4Mi5zIDwgMCA/IDggOiA3KSk7CiAgICAgICAgfQogICAgICAgIGlmIChzZCA8IDEgfHwgIXhkWzBdKSB7CiAgICAgICAgICBpZiAoZG9Sb3VuZCkgewogICAgICAgICAgICBrID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpOwogICAgICAgICAgICB4ZC5sZW5ndGggPSAxOwogICAgICAgICAgICBzZCA9IHNkIC0gayAtIDE7CiAgICAgICAgICAgIHhkWzBdID0gbWF0aHBvdygxMCwgKExPR19CQVNFIC0gc2QgJSBMT0dfQkFTRSkgJSBMT0dfQkFTRSk7CiAgICAgICAgICAgIHgyLmUgPSBtYXRoZmxvb3IoLXNkIC8gTE9HX0JBU0UpIHx8IDA7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB4ZC5sZW5ndGggPSAxOwogICAgICAgICAgICB4ZFswXSA9IHgyLmUgPSB4Mi5zID0gMDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB4MjsKICAgICAgICB9CiAgICAgICAgaWYgKGkgPT0gMCkgewogICAgICAgICAgeGQubGVuZ3RoID0geGRpOwogICAgICAgICAgayA9IDE7CiAgICAgICAgICB4ZGktLTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeGQubGVuZ3RoID0geGRpICsgMTsKICAgICAgICAgIGsgPSBtYXRocG93KDEwLCBMT0dfQkFTRSAtIGkpOwogICAgICAgICAgeGRbeGRpXSA9IGogPiAwID8gKHcgLyBtYXRocG93KDEwLCBuIC0gaikgJSBtYXRocG93KDEwLCBqKSB8IDApICogayA6IDA7CiAgICAgICAgfQogICAgICAgIGlmIChkb1JvdW5kKSB7CiAgICAgICAgICBmb3IgKDsgOyApIHsKICAgICAgICAgICAgaWYgKHhkaSA9PSAwKSB7CiAgICAgICAgICAgICAgaWYgKCh4ZFswXSArPSBrKSA9PSBCQVNFKSB7CiAgICAgICAgICAgICAgICB4ZFswXSA9IDE7CiAgICAgICAgICAgICAgICArK3gyLmU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHhkW3hkaV0gKz0gazsKICAgICAgICAgICAgICBpZiAoeGRbeGRpXSAhPSBCQVNFKSBicmVhazsKICAgICAgICAgICAgICB4ZFt4ZGktLV0gPSAwOwogICAgICAgICAgICAgIGsgPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAoaSA9IHhkLmxlbmd0aDsgeGRbLS1pXSA9PT0gMDsgKSB4ZC5wb3AoKTsKICAgICAgICBpZiAoZXh0ZXJuYWwgJiYgKHgyLmUgPiBNQVhfRSB8fCB4Mi5lIDwgLU1BWF9FKSkgewogICAgICAgICAgdGhyb3cgRXJyb3IoZXhwb25lbnRPdXRPZlJhbmdlICsgZ2V0QmFzZTEwRXhwb25lbnQoeDIpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHgyOwogICAgICB9CiAgICAgIGZ1bmN0aW9uIHN1YnRyYWN0KHgyLCB5MikgewogICAgICAgIHZhciBkLCBlLCBpLCBqLCBrLCBsZW4sIHhkLCB4ZSwgeExUeSwgeWQsIEN0b3IgPSB4Mi5jb25zdHJ1Y3RvciwgcHIgPSBDdG9yLnByZWNpc2lvbjsKICAgICAgICBpZiAoIXgyLnMgfHwgIXkyLnMpIHsKICAgICAgICAgIGlmICh5Mi5zKSB5Mi5zID0gLXkyLnM7CiAgICAgICAgICBlbHNlIHkyID0gbmV3IEN0b3IoeDIpOwogICAgICAgICAgcmV0dXJuIGV4dGVybmFsID8gcm91bmQoeTIsIHByKSA6IHkyOwogICAgICAgIH0KICAgICAgICB4ZCA9IHgyLmQ7CiAgICAgICAgeWQgPSB5Mi5kOwogICAgICAgIGUgPSB5Mi5lOwogICAgICAgIHhlID0geDIuZTsKICAgICAgICB4ZCA9IHhkLnNsaWNlKCk7CiAgICAgICAgayA9IHhlIC0gZTsKICAgICAgICBpZiAoaykgewogICAgICAgICAgeExUeSA9IGsgPCAwOwogICAgICAgICAgaWYgKHhMVHkpIHsKICAgICAgICAgICAgZCA9IHhkOwogICAgICAgICAgICBrID0gLWs7CiAgICAgICAgICAgIGxlbiA9IHlkLmxlbmd0aDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGQgPSB5ZDsKICAgICAgICAgICAgZSA9IHhlOwogICAgICAgICAgICBsZW4gPSB4ZC5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgICBpID0gTWF0aC5tYXgoTWF0aC5jZWlsKHByIC8gTE9HX0JBU0UpLCBsZW4pICsgMjsKICAgICAgICAgIGlmIChrID4gaSkgewogICAgICAgICAgICBrID0gaTsKICAgICAgICAgICAgZC5sZW5ndGggPSAxOwogICAgICAgICAgfQogICAgICAgICAgZC5yZXZlcnNlKCk7CiAgICAgICAgICBmb3IgKGkgPSBrOyBpLS07ICkgZC5wdXNoKDApOwogICAgICAgICAgZC5yZXZlcnNlKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGkgPSB4ZC5sZW5ndGg7CiAgICAgICAgICBsZW4gPSB5ZC5sZW5ndGg7CiAgICAgICAgICB4TFR5ID0gaSA8IGxlbjsKICAgICAgICAgIGlmICh4TFR5KSBsZW4gPSBpOwogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGlmICh4ZFtpXSAhPSB5ZFtpXSkgewogICAgICAgICAgICAgIHhMVHkgPSB4ZFtpXSA8IHlkW2ldOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBrID0gMDsKICAgICAgICB9CiAgICAgICAgaWYgKHhMVHkpIHsKICAgICAgICAgIGQgPSB4ZDsKICAgICAgICAgIHhkID0geWQ7CiAgICAgICAgICB5ZCA9IGQ7CiAgICAgICAgICB5Mi5zID0gLXkyLnM7CiAgICAgICAgfQogICAgICAgIGxlbiA9IHhkLmxlbmd0aDsKICAgICAgICBmb3IgKGkgPSB5ZC5sZW5ndGggLSBsZW47IGkgPiAwOyAtLWkpIHhkW2xlbisrXSA9IDA7CiAgICAgICAgZm9yIChpID0geWQubGVuZ3RoOyBpID4gazsgKSB7CiAgICAgICAgICBpZiAoeGRbLS1pXSA8IHlkW2ldKSB7CiAgICAgICAgICAgIGZvciAoaiA9IGk7IGogJiYgeGRbLS1qXSA9PT0gMDsgKSB4ZFtqXSA9IEJBU0UgLSAxOwogICAgICAgICAgICAtLXhkW2pdOwogICAgICAgICAgICB4ZFtpXSArPSBCQVNFOwogICAgICAgICAgfQogICAgICAgICAgeGRbaV0gLT0geWRbaV07CiAgICAgICAgfQogICAgICAgIGZvciAoOyB4ZFstLWxlbl0gPT09IDA7ICkgeGQucG9wKCk7CiAgICAgICAgZm9yICg7IHhkWzBdID09PSAwOyB4ZC5zaGlmdCgpKSAtLWU7CiAgICAgICAgaWYgKCF4ZFswXSkgcmV0dXJuIG5ldyBDdG9yKDApOwogICAgICAgIHkyLmQgPSB4ZDsKICAgICAgICB5Mi5lID0gZTsKICAgICAgICByZXR1cm4gZXh0ZXJuYWwgPyByb3VuZCh5MiwgcHIpIDogeTI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdG9TdHJpbmcoeDIsIGlzRXhwLCBzZCkgewogICAgICAgIHZhciBrLCBlID0gZ2V0QmFzZTEwRXhwb25lbnQoeDIpLCBzdHIgPSBkaWdpdHNUb1N0cmluZyh4Mi5kKSwgbGVuID0gc3RyLmxlbmd0aDsKICAgICAgICBpZiAoaXNFeHApIHsKICAgICAgICAgIGlmIChzZCAmJiAoayA9IHNkIC0gbGVuKSA+IDApIHsKICAgICAgICAgICAgc3RyID0gc3RyLmNoYXJBdCgwKSArICIuIiArIHN0ci5zbGljZSgxKSArIGdldFplcm9TdHJpbmcoayk7CiAgICAgICAgICB9IGVsc2UgaWYgKGxlbiA+IDEpIHsKICAgICAgICAgICAgc3RyID0gc3RyLmNoYXJBdCgwKSArICIuIiArIHN0ci5zbGljZSgxKTsKICAgICAgICAgIH0KICAgICAgICAgIHN0ciA9IHN0ciArIChlIDwgMCA/ICJlIiA6ICJlKyIpICsgZTsKICAgICAgICB9IGVsc2UgaWYgKGUgPCAwKSB7CiAgICAgICAgICBzdHIgPSAiMC4iICsgZ2V0WmVyb1N0cmluZygtZSAtIDEpICsgc3RyOwogICAgICAgICAgaWYgKHNkICYmIChrID0gc2QgLSBsZW4pID4gMCkgc3RyICs9IGdldFplcm9TdHJpbmcoayk7CiAgICAgICAgfSBlbHNlIGlmIChlID49IGxlbikgewogICAgICAgICAgc3RyICs9IGdldFplcm9TdHJpbmcoZSArIDEgLSBsZW4pOwogICAgICAgICAgaWYgKHNkICYmIChrID0gc2QgLSBlIC0gMSkgPiAwKSBzdHIgPSBzdHIgKyAiLiIgKyBnZXRaZXJvU3RyaW5nKGspOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoKGsgPSBlICsgMSkgPCBsZW4pIHN0ciA9IHN0ci5zbGljZSgwLCBrKSArICIuIiArIHN0ci5zbGljZShrKTsKICAgICAgICAgIGlmIChzZCAmJiAoayA9IHNkIC0gbGVuKSA+IDApIHsKICAgICAgICAgICAgaWYgKGUgKyAxID09PSBsZW4pIHN0ciArPSAiLiI7CiAgICAgICAgICAgIHN0ciArPSBnZXRaZXJvU3RyaW5nKGspOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4geDIucyA8IDAgPyAiLSIgKyBzdHIgOiBzdHI7CiAgICAgIH0KICAgICAgZnVuY3Rpb24gdHJ1bmNhdGUoYXJyLCBsZW4pIHsKICAgICAgICBpZiAoYXJyLmxlbmd0aCA+IGxlbikgewogICAgICAgICAgYXJyLmxlbmd0aCA9IGxlbjsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBjbG9uZShvYmopIHsKICAgICAgICB2YXIgaSwgcCwgcHM7CiAgICAgICAgZnVuY3Rpb24gRGVjaW1hbDQodmFsdWUpIHsKICAgICAgICAgIHZhciB4MiA9IHRoaXM7CiAgICAgICAgICBpZiAoISh4MiBpbnN0YW5jZW9mIERlY2ltYWw0KSkgcmV0dXJuIG5ldyBEZWNpbWFsNCh2YWx1ZSk7CiAgICAgICAgICB4Mi5jb25zdHJ1Y3RvciA9IERlY2ltYWw0OwogICAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGVjaW1hbDQpIHsKICAgICAgICAgICAgeDIucyA9IHZhbHVlLnM7CiAgICAgICAgICAgIHgyLmUgPSB2YWx1ZS5lOwogICAgICAgICAgICB4Mi5kID0gKHZhbHVlID0gdmFsdWUuZCkgPyB2YWx1ZS5zbGljZSgpIDogdmFsdWU7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAqIDAgIT09IDApIHsKICAgICAgICAgICAgICB0aHJvdyBFcnJvcihpbnZhbGlkQXJndW1lbnQgKyB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHZhbHVlID4gMCkgewogICAgICAgICAgICAgIHgyLnMgPSAxOwogICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlIDwgMCkgewogICAgICAgICAgICAgIHZhbHVlID0gLXZhbHVlOwogICAgICAgICAgICAgIHgyLnMgPSAtMTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB4Mi5zID0gMDsKICAgICAgICAgICAgICB4Mi5lID0gMDsKICAgICAgICAgICAgICB4Mi5kID0gWzBdOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodmFsdWUgPT09IH5+dmFsdWUgJiYgdmFsdWUgPCAxZTcpIHsKICAgICAgICAgICAgICB4Mi5lID0gMDsKICAgICAgICAgICAgICB4Mi5kID0gW3ZhbHVlXTsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHBhcnNlRGVjaW1hbCh4MiwgdmFsdWUudG9TdHJpbmcoKSk7CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgdGhyb3cgRXJyb3IoaW52YWxpZEFyZ3VtZW50ICsgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHZhbHVlLmNoYXJDb2RlQXQoMCkgPT09IDQ1KSB7CiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc2xpY2UoMSk7CiAgICAgICAgICAgIHgyLnMgPSAtMTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHgyLnMgPSAxOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGlzRGVjaW1hbC50ZXN0KHZhbHVlKSkgcGFyc2VEZWNpbWFsKHgyLCB2YWx1ZSk7CiAgICAgICAgICBlbHNlIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgRGVjaW1hbDQucHJvdG90eXBlID0gUDsKICAgICAgICBEZWNpbWFsNC5ST1VORF9VUCA9IDA7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfRE9XTiA9IDE7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfQ0VJTCA9IDI7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfRkxPT1IgPSAzOwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfVVAgPSA0OwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfRE9XTiA9IDU7CiAgICAgICAgRGVjaW1hbDQuUk9VTkRfSEFMRl9FVkVOID0gNjsKICAgICAgICBEZWNpbWFsNC5ST1VORF9IQUxGX0NFSUwgPSA3OwogICAgICAgIERlY2ltYWw0LlJPVU5EX0hBTEZfRkxPT1IgPSA4OwogICAgICAgIERlY2ltYWw0LmNsb25lID0gY2xvbmU7CiAgICAgICAgRGVjaW1hbDQuY29uZmlnID0gRGVjaW1hbDQuc2V0ID0gY29uZmlnOwogICAgICAgIGlmIChvYmogPT09IHZvaWQgMCkgb2JqID0ge307CiAgICAgICAgaWYgKG9iaikgewogICAgICAgICAgcHMgPSBbInByZWNpc2lvbiIsICJyb3VuZGluZyIsICJ0b0V4cE5lZyIsICJ0b0V4cFBvcyIsICJMTjEwIl07CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHMubGVuZ3RoOyApIGlmICghb2JqLmhhc093blByb3BlcnR5KHAgPSBwc1tpKytdKSkgb2JqW3BdID0gdGhpc1twXTsKICAgICAgICB9CiAgICAgICAgRGVjaW1hbDQuY29uZmlnKG9iaik7CiAgICAgICAgcmV0dXJuIERlY2ltYWw0OwogICAgICB9CiAgICAgIGZ1bmN0aW9uIGNvbmZpZyhvYmopIHsKICAgICAgICBpZiAoIW9iaiB8fCB0eXBlb2Ygb2JqICE9PSAib2JqZWN0IikgewogICAgICAgICAgdGhyb3cgRXJyb3IoZGVjaW1hbEVycm9yICsgIk9iamVjdCBleHBlY3RlZCIpOwogICAgICAgIH0KICAgICAgICB2YXIgaSwgcCwgdiwgcHMgPSBbCiAgICAgICAgICAicHJlY2lzaW9uIiwKICAgICAgICAgIDEsCiAgICAgICAgICBNQVhfRElHSVRTLAogICAgICAgICAgInJvdW5kaW5nIiwKICAgICAgICAgIDAsCiAgICAgICAgICA4LAogICAgICAgICAgInRvRXhwTmVnIiwKICAgICAgICAgIC0xIC8gMCwKICAgICAgICAgIDAsCiAgICAgICAgICAidG9FeHBQb3MiLAogICAgICAgICAgMCwKICAgICAgICAgIDEgLyAwCiAgICAgICAgXTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHMubGVuZ3RoOyBpICs9IDMpIHsKICAgICAgICAgIGlmICgodiA9IG9ialtwID0gcHNbaV1dKSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChtYXRoZmxvb3IodikgPT09IHYgJiYgdiA+PSBwc1tpICsgMV0gJiYgdiA8PSBwc1tpICsgMl0pIHRoaXNbcF0gPSB2OwogICAgICAgICAgICBlbHNlIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHAgKyAiOiAiICsgdik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICgodiA9IG9ialtwID0gIkxOMTAiXSkgIT09IHZvaWQgMCkgewogICAgICAgICAgaWYgKHYgPT0gTWF0aC5MTjEwKSB0aGlzW3BdID0gbmV3IHRoaXModik7CiAgICAgICAgICBlbHNlIHRocm93IEVycm9yKGludmFsaWRBcmd1bWVudCArIHAgKyAiOiAiICsgdik7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICAgIERlY2ltYWwzID0gY2xvbmUoRGVjaW1hbDMpOwogICAgICBEZWNpbWFsM1siZGVmYXVsdCJdID0gRGVjaW1hbDMuRGVjaW1hbCA9IERlY2ltYWwzOwogICAgICBPTkUgPSBuZXcgRGVjaW1hbDMoMSk7CiAgICAgIGlmICh0eXBlb2YgZGVmaW5lID09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgICAgIGRlZmluZShmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiBEZWNpbWFsMzsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbW9kdWxlICE9ICJ1bmRlZmluZWQiICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgICAgbW9kdWxlLmV4cG9ydHMgPSBEZWNpbWFsMzsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoIWdsb2JhbFNjb3BlKSB7CiAgICAgICAgICBnbG9iYWxTY29wZSA9IHR5cGVvZiBzZWxmICE9ICJ1bmRlZmluZWQiICYmIHNlbGYgJiYgc2VsZi5zZWxmID09IHNlbGYgPyBzZWxmIDogRnVuY3Rpb24oInJldHVybiB0aGlzIikoKTsKICAgICAgICB9CiAgICAgICAgZ2xvYmFsU2NvcGUuRGVjaW1hbCA9IERlY2ltYWwzOwogICAgICB9CiAgICB9KShleHBvcnRzKTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2V2ZW50ZW1pdHRlcjNANS4wLjEvbm9kZV9tb2R1bGVzL2V2ZW50ZW1pdHRlcjMvaW5kZXguanMKdmFyIHJlcXVpcmVfZXZlbnRlbWl0dGVyMyA9IF9fY29tbW9uSlMoewogICJub2RlX21vZHVsZXMvLnBucG0vZXZlbnRlbWl0dGVyM0A1LjAuMS9ub2RlX21vZHVsZXMvZXZlbnRlbWl0dGVyMy9pbmRleC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICB2YXIgaGFzMyA9IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICB2YXIgcHJlZml4ID0gIn4iOwogICAgZnVuY3Rpb24gRXZlbnRzKCkgewogICAgfQogICAgaWYgKE9iamVjdC5jcmVhdGUpIHsKICAgICAgRXZlbnRzLnByb3RvdHlwZSA9IC8qIEBfX1BVUkVfXyAqLyBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgICBpZiAoIW5ldyBFdmVudHMoKS5fX3Byb3RvX18pIHByZWZpeCA9IGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24gRUUoZm4sIGNvbnRleHQsIG9uY2UpIHsKICAgICAgdGhpcy5mbiA9IGZuOwogICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogICAgICB0aGlzLm9uY2UgPSBvbmNlIHx8IGZhbHNlOwogICAgfQogICAgZnVuY3Rpb24gYWRkTGlzdGVuZXIyKGVtaXR0ZXIsIGV2ZW50LCBmbiwgY29udGV4dCwgb25jZSkgewogICAgICBpZiAodHlwZW9mIGZuICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiVGhlIGxpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgICB9CiAgICAgIHZhciBsaXN0ZW5lcjIgPSBuZXcgRUUoZm4sIGNvbnRleHQgfHwgZW1pdHRlciwgb25jZSksIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7CiAgICAgIGlmICghZW1pdHRlci5fZXZlbnRzW2V2dF0pIGVtaXR0ZXIuX2V2ZW50c1tldnRdID0gbGlzdGVuZXIyLCBlbWl0dGVyLl9ldmVudHNDb3VudCsrOwogICAgICBlbHNlIGlmICghZW1pdHRlci5fZXZlbnRzW2V2dF0uZm4pIGVtaXR0ZXIuX2V2ZW50c1tldnRdLnB1c2gobGlzdGVuZXIyKTsKICAgICAgZWxzZSBlbWl0dGVyLl9ldmVudHNbZXZ0XSA9IFtlbWl0dGVyLl9ldmVudHNbZXZ0XSwgbGlzdGVuZXIyXTsKICAgICAgcmV0dXJuIGVtaXR0ZXI7CiAgICB9CiAgICBmdW5jdGlvbiBjbGVhckV2ZW50KGVtaXR0ZXIsIGV2dCkgewogICAgICBpZiAoLS1lbWl0dGVyLl9ldmVudHNDb3VudCA9PT0gMCkgZW1pdHRlci5fZXZlbnRzID0gbmV3IEV2ZW50cygpOwogICAgICBlbHNlIGRlbGV0ZSBlbWl0dGVyLl9ldmVudHNbZXZ0XTsKICAgIH0KICAgIGZ1bmN0aW9uIEV2ZW50RW1pdHRlcjIoKSB7CiAgICAgIHRoaXMuX2V2ZW50cyA9IG5ldyBFdmVudHMoKTsKICAgICAgdGhpcy5fZXZlbnRzQ291bnQgPSAwOwogICAgfQogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUuZXZlbnROYW1lcyA9IGZ1bmN0aW9uIGV2ZW50TmFtZXMoKSB7CiAgICAgIHZhciBuYW1lcyA9IFtdLCBldmVudHMsIG5hbWU7CiAgICAgIGlmICh0aGlzLl9ldmVudHNDb3VudCA9PT0gMCkgcmV0dXJuIG5hbWVzOwogICAgICBmb3IgKG5hbWUgaW4gZXZlbnRzID0gdGhpcy5fZXZlbnRzKSB7CiAgICAgICAgaWYgKGhhczMuY2FsbChldmVudHMsIG5hbWUpKSBuYW1lcy5wdXNoKHByZWZpeCA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lKTsKICAgICAgfQogICAgICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgICAgIHJldHVybiBuYW1lcy5jb25jYXQoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhldmVudHMpKTsKICAgICAgfQogICAgICByZXR1cm4gbmFtZXM7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUubGlzdGVuZXJzID0gZnVuY3Rpb24gbGlzdGVuZXJzKGV2ZW50KSB7CiAgICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50LCBoYW5kbGVycyA9IHRoaXMuX2V2ZW50c1tldnRdOwogICAgICBpZiAoIWhhbmRsZXJzKSByZXR1cm4gW107CiAgICAgIGlmIChoYW5kbGVycy5mbikgcmV0dXJuIFtoYW5kbGVycy5mbl07CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gaGFuZGxlcnMubGVuZ3RoLCBlZSA9IG5ldyBBcnJheShsKTsgaSA8IGw7IGkrKykgewogICAgICAgIGVlW2ldID0gaGFuZGxlcnNbaV0uZm47CiAgICAgIH0KICAgICAgcmV0dXJuIGVlOwogICAgfTsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLmxpc3RlbmVyQ291bnQgPSBmdW5jdGlvbiBsaXN0ZW5lckNvdW50KGV2ZW50KSB7CiAgICAgIHZhciBldnQgPSBwcmVmaXggPyBwcmVmaXggKyBldmVudCA6IGV2ZW50LCBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbZXZ0XTsKICAgICAgaWYgKCFsaXN0ZW5lcnMpIHJldHVybiAwOwogICAgICBpZiAobGlzdGVuZXJzLmZuKSByZXR1cm4gMTsKICAgICAgcmV0dXJuIGxpc3RlbmVycy5sZW5ndGg7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uIGVtaXQoZXZlbnQsIGExLCBhMiwgYTMsIGE0LCBhNSkgewogICAgICB2YXIgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDsKICAgICAgaWYgKCF0aGlzLl9ldmVudHNbZXZ0XSkgcmV0dXJuIGZhbHNlOwogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW2V2dF0sIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MsIGk7CiAgICAgIGlmIChsaXN0ZW5lcnMuZm4pIHsKICAgICAgICBpZiAobGlzdGVuZXJzLm9uY2UpIHRoaXMucmVtb3ZlTGlzdGVuZXIoZXZlbnQsIGxpc3RlbmVycy5mbiwgdm9pZCAwLCB0cnVlKTsKICAgICAgICBzd2l0Y2ggKGxlbikgewogICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQpLCB0cnVlOwogICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExKSwgdHJ1ZTsKICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIpLCB0cnVlOwogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMpLCB0cnVlOwogICAgICAgICAgY2FzZSA1OgogICAgICAgICAgICByZXR1cm4gbGlzdGVuZXJzLmZuLmNhbGwobGlzdGVuZXJzLmNvbnRleHQsIGExLCBhMiwgYTMsIGE0KSwgdHJ1ZTsKICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgcmV0dXJuIGxpc3RlbmVycy5mbi5jYWxsKGxpc3RlbmVycy5jb250ZXh0LCBhMSwgYTIsIGEzLCBhNCwgYTUpLCB0cnVlOwogICAgICAgIH0KICAgICAgICBmb3IgKGkgPSAxLCBhcmdzID0gbmV3IEFycmF5KGxlbiAtIDEpOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwogICAgICAgIH0KICAgICAgICBsaXN0ZW5lcnMuZm4uYXBwbHkobGlzdGVuZXJzLmNvbnRleHQsIGFyZ3MpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBsZW5ndGggPSBsaXN0ZW5lcnMubGVuZ3RoLCBqOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKGxpc3RlbmVyc1tpXS5vbmNlKSB0aGlzLnJlbW92ZUxpc3RlbmVyKGV2ZW50LCBsaXN0ZW5lcnNbaV0uZm4sIHZvaWQgMCwgdHJ1ZSk7CiAgICAgICAgICBzd2l0Y2ggKGxlbikgewogICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAzOgogICAgICAgICAgICAgIGxpc3RlbmVyc1tpXS5mbi5jYWxsKGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhMSwgYTIpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmNhbGwobGlzdGVuZXJzW2ldLmNvbnRleHQsIGExLCBhMiwgYTMpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgIGlmICghYXJncykgZm9yIChqID0gMSwgYXJncyA9IG5ldyBBcnJheShsZW4gLSAxKTsgaiA8IGxlbjsgaisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW2ogLSAxXSA9IGFyZ3VtZW50c1tqXTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbGlzdGVuZXJzW2ldLmZuLmFwcGx5KGxpc3RlbmVyc1tpXS5jb250ZXh0LCBhcmdzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUub24gPSBmdW5jdGlvbiBvbihldmVudCwgZm4sIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIGFkZExpc3RlbmVyMih0aGlzLCBldmVudCwgZm4sIGNvbnRleHQsIGZhbHNlKTsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5vbmNlID0gZnVuY3Rpb24gb25jZShldmVudCwgZm4sIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIGFkZExpc3RlbmVyMih0aGlzLCBldmVudCwgZm4sIGNvbnRleHQsIHRydWUpOwogICAgfTsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLnJlbW92ZUxpc3RlbmVyID0gZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIyKGV2ZW50LCBmbiwgY29udGV4dCwgb25jZSkgewogICAgICB2YXIgZXZ0ID0gcHJlZml4ID8gcHJlZml4ICsgZXZlbnQgOiBldmVudDsKICAgICAgaWYgKCF0aGlzLl9ldmVudHNbZXZ0XSkgcmV0dXJuIHRoaXM7CiAgICAgIGlmICghZm4pIHsKICAgICAgICBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1tldnRdOwogICAgICBpZiAobGlzdGVuZXJzLmZuKSB7CiAgICAgICAgaWYgKGxpc3RlbmVycy5mbiA9PT0gZm4gJiYgKCFvbmNlIHx8IGxpc3RlbmVycy5vbmNlKSAmJiAoIWNvbnRleHQgfHwgbGlzdGVuZXJzLmNvbnRleHQgPT09IGNvbnRleHQpKSB7CiAgICAgICAgICBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvciAodmFyIGkgPSAwLCBldmVudHMgPSBbXSwgbGVuZ3RoID0gbGlzdGVuZXJzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAobGlzdGVuZXJzW2ldLmZuICE9PSBmbiB8fCBvbmNlICYmICFsaXN0ZW5lcnNbaV0ub25jZSB8fCBjb250ZXh0ICYmIGxpc3RlbmVyc1tpXS5jb250ZXh0ICE9PSBjb250ZXh0KSB7CiAgICAgICAgICAgIGV2ZW50cy5wdXNoKGxpc3RlbmVyc1tpXSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChldmVudHMubGVuZ3RoKSB0aGlzLl9ldmVudHNbZXZ0XSA9IGV2ZW50cy5sZW5ndGggPT09IDEgPyBldmVudHNbMF0gOiBldmVudHM7CiAgICAgICAgZWxzZSBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9OwogICAgRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUucmVtb3ZlQWxsTGlzdGVuZXJzID0gZnVuY3Rpb24gcmVtb3ZlQWxsTGlzdGVuZXJzKGV2ZW50KSB7CiAgICAgIHZhciBldnQ7CiAgICAgIGlmIChldmVudCkgewogICAgICAgIGV2dCA9IHByZWZpeCA/IHByZWZpeCArIGV2ZW50IDogZXZlbnQ7CiAgICAgICAgaWYgKHRoaXMuX2V2ZW50c1tldnRdKSBjbGVhckV2ZW50KHRoaXMsIGV2dCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5fZXZlbnRzID0gbmV3IEV2ZW50cygpOwogICAgICAgIHRoaXMuX2V2ZW50c0NvdW50ID0gMDsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH07CiAgICBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5vZmYgPSBFdmVudEVtaXR0ZXIyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lcjsKICAgIEV2ZW50RW1pdHRlcjIucHJvdG90eXBlLmFkZExpc3RlbmVyID0gRXZlbnRFbWl0dGVyMi5wcm90b3R5cGUub247CiAgICBFdmVudEVtaXR0ZXIyLnByZWZpeGVkID0gcHJlZml4OwogICAgRXZlbnRFbWl0dGVyMi5FdmVudEVtaXR0ZXIgPSBFdmVudEVtaXR0ZXIyOwogICAgaWYgKCJ1bmRlZmluZWQiICE9PSB0eXBlb2YgbW9kdWxlKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gRXZlbnRFbWl0dGVyMjsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2Rpc3QvYXJyYXkvbGFzdC5qcwp2YXIgcmVxdWlyZV9sYXN0ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2FycmF5L2xhc3QuanMiKGV4cG9ydHMpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICJNb2R1bGUiIH0pOwogICAgZnVuY3Rpb24gbGFzdDIoYXJyKSB7CiAgICAgIHJldHVybiBhcnJbYXJyLmxlbmd0aCAtIDFdOwogICAgfQogICAgZXhwb3J0cy5sYXN0ID0gbGFzdDI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdG9BcnJheS5qcwp2YXIgcmVxdWlyZV90b0FycmF5ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9faW50ZXJuYWwvdG9BcnJheS5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFN5bWJvbC50b1N0cmluZ1RhZywgeyB2YWx1ZTogIk1vZHVsZSIgfSk7CiAgICBmdW5jdGlvbiB0b0FycmF5Mih2YWx1ZSkgewogICAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZSkgPyB2YWx1ZSA6IEFycmF5LmZyb20odmFsdWUpOwogICAgfQogICAgZXhwb3J0cy50b0FycmF5ID0gdG9BcnJheTI7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9sYXN0LmpzCnZhciByZXF1aXJlX2xhc3QyID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9kaXN0L2NvbXBhdC9hcnJheS9sYXN0LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgU3ltYm9sLnRvU3RyaW5nVGFnLCB7IHZhbHVlOiAiTW9kdWxlIiB9KTsKICAgIHZhciBsYXN0JDEgPSByZXF1aXJlX2xhc3QoKTsKICAgIHZhciB0b0FycmF5MiA9IHJlcXVpcmVfdG9BcnJheSgpOwogICAgdmFyIGlzQXJyYXlMaWtlID0gcmVxdWlyZV9pc0FycmF5TGlrZSgpOwogICAgZnVuY3Rpb24gbGFzdDIoYXJyYXkpIHsKICAgICAgaWYgKCFpc0FycmF5TGlrZS5pc0FycmF5TGlrZShhcnJheSkpIHsKICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICB9CiAgICAgIHJldHVybiBsYXN0JDEubGFzdCh0b0FycmF5Mi50b0FycmF5KGFycmF5KSk7CiAgICB9CiAgICBleHBvcnRzLmxhc3QgPSBsYXN0MjsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2VzLXRvb2xraXRAMS40Mi4wL25vZGVfbW9kdWxlcy9lcy10b29sa2l0L2NvbXBhdC9sYXN0LmpzCnZhciByZXF1aXJlX2xhc3QzID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9lcy10b29sa2l0QDEuNDIuMC9ub2RlX21vZHVsZXMvZXMtdG9vbGtpdC9jb21wYXQvbGFzdC5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfbGFzdDIoKS5sYXN0OwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmVAMS42LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS9janMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtd2l0aC1zZWxlY3Rvci5kZXZlbG9wbWVudC5qcwp2YXIgcmVxdWlyZV91c2Vfc3luY19leHRlcm5hbF9zdG9yZV93aXRoX3NlbGVjdG9yX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS91c2Utc3luYy1leHRlcm5hbC1zdG9yZUAxLjYuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS13aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzIihleHBvcnRzKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICAoZnVuY3Rpb24oKSB7CiAgICAgIGZ1bmN0aW9uIGlzNCh4MiwgeTIpIHsKICAgICAgICByZXR1cm4geDIgPT09IHkyICYmICgwICE9PSB4MiB8fCAxIC8geDIgPT09IDEgLyB5MikgfHwgeDIgIT09IHgyICYmIHkyICE9PSB5MjsKICAgICAgfQogICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdGFydCAmJiBfX1JFQUNUX0RFVlRPT0xTX0dMT0JBTF9IT09LX18ucmVnaXN0ZXJJbnRlcm5hbE1vZHVsZVN0YXJ0KEVycm9yKCkpOwogICAgICB2YXIgUmVhY3QzOSA9IHJlcXVpcmVfcmVhY3QoKSwgb2JqZWN0SXMgPSAiZnVuY3Rpb24iID09PSB0eXBlb2YgT2JqZWN0LmlzID8gT2JqZWN0LmlzIDogaXM0LCB1c2VTeW5jRXh0ZXJuYWxTdG9yZTIgPSBSZWFjdDM5LnVzZVN5bmNFeHRlcm5hbFN0b3JlLCB1c2VSZWYxNiA9IFJlYWN0MzkudXNlUmVmLCB1c2VFZmZlY3QxNCA9IFJlYWN0MzkudXNlRWZmZWN0LCB1c2VNZW1vOSA9IFJlYWN0MzkudXNlTWVtbywgdXNlRGVidWdWYWx1ZTIgPSBSZWFjdDM5LnVzZURlYnVnVmFsdWU7CiAgICAgIGV4cG9ydHMudXNlU3luY0V4dGVybmFsU3RvcmVXaXRoU2VsZWN0b3IgPSBmdW5jdGlvbihzdWJzY3JpYmUsIGdldFNuYXBzaG90LCBnZXRTZXJ2ZXJTbmFwc2hvdCwgc2VsZWN0b3IsIGlzRXF1YWwpIHsKICAgICAgICB2YXIgaW5zdFJlZiA9IHVzZVJlZjE2KG51bGwpOwogICAgICAgIGlmIChudWxsID09PSBpbnN0UmVmLmN1cnJlbnQpIHsKICAgICAgICAgIHZhciBpbnN0ID0geyBoYXNWYWx1ZTogZmFsc2UsIHZhbHVlOiBudWxsIH07CiAgICAgICAgICBpbnN0UmVmLmN1cnJlbnQgPSBpbnN0OwogICAgICAgIH0gZWxzZSBpbnN0ID0gaW5zdFJlZi5jdXJyZW50OwogICAgICAgIGluc3RSZWYgPSB1c2VNZW1vOSgKICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICBmdW5jdGlvbiBtZW1vaXplZFNlbGVjdG9yKG5leHRTbmFwc2hvdCkgewogICAgICAgICAgICAgIGlmICghaGFzTWVtbykgewogICAgICAgICAgICAgICAgaGFzTWVtbyA9IHRydWU7CiAgICAgICAgICAgICAgICBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90OwogICAgICAgICAgICAgICAgbmV4dFNuYXBzaG90ID0gc2VsZWN0b3IobmV4dFNuYXBzaG90KTsKICAgICAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IGlzRXF1YWwgJiYgaW5zdC5oYXNWYWx1ZSkgewogICAgICAgICAgICAgICAgICB2YXIgY3VycmVudFNlbGVjdGlvbiA9IGluc3QudmFsdWU7CiAgICAgICAgICAgICAgICAgIGlmIChpc0VxdWFsKGN1cnJlbnRTZWxlY3Rpb24sIG5leHRTbmFwc2hvdCkpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0aW9uID0gY3VycmVudFNlbGVjdGlvbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdGlvbiA9IG5leHRTbmFwc2hvdDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY3VycmVudFNlbGVjdGlvbiA9IG1lbW9pemVkU2VsZWN0aW9uOwogICAgICAgICAgICAgIGlmIChvYmplY3RJcyhtZW1vaXplZFNuYXBzaG90LCBuZXh0U25hcHNob3QpKQogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRTZWxlY3Rpb247CiAgICAgICAgICAgICAgdmFyIG5leHRTZWxlY3Rpb24gPSBzZWxlY3RvcihuZXh0U25hcHNob3QpOwogICAgICAgICAgICAgIGlmICh2b2lkIDAgIT09IGlzRXF1YWwgJiYgaXNFcXVhbChjdXJyZW50U2VsZWN0aW9uLCBuZXh0U2VsZWN0aW9uKSkKICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNuYXBzaG90ID0gbmV4dFNuYXBzaG90LCBjdXJyZW50U2VsZWN0aW9uOwogICAgICAgICAgICAgIG1lbW9pemVkU25hcHNob3QgPSBuZXh0U25hcHNob3Q7CiAgICAgICAgICAgICAgcmV0dXJuIG1lbW9pemVkU2VsZWN0aW9uID0gbmV4dFNlbGVjdGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgaGFzTWVtbyA9IGZhbHNlLCBtZW1vaXplZFNuYXBzaG90LCBtZW1vaXplZFNlbGVjdGlvbiwgbWF5YmVHZXRTZXJ2ZXJTbmFwc2hvdCA9IHZvaWQgMCA9PT0gZ2V0U2VydmVyU25hcHNob3QgPyBudWxsIDogZ2V0U2VydmVyU25hcHNob3Q7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gbWVtb2l6ZWRTZWxlY3RvcihnZXRTbmFwc2hvdCgpKTsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIG51bGwgPT09IG1heWJlR2V0U2VydmVyU25hcHNob3QgPyB2b2lkIDAgOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBtZW1vaXplZFNlbGVjdG9yKG1heWJlR2V0U2VydmVyU25hcHNob3QoKSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICBdOwogICAgICAgICAgfSwKICAgICAgICAgIFtnZXRTbmFwc2hvdCwgZ2V0U2VydmVyU25hcHNob3QsIHNlbGVjdG9yLCBpc0VxdWFsXQogICAgICAgICk7CiAgICAgICAgdmFyIHZhbHVlID0gdXNlU3luY0V4dGVybmFsU3RvcmUyKHN1YnNjcmliZSwgaW5zdFJlZlswXSwgaW5zdFJlZlsxXSk7CiAgICAgICAgdXNlRWZmZWN0MTQoCiAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaW5zdC5oYXNWYWx1ZSA9IHRydWU7CiAgICAgICAgICAgIGluc3QudmFsdWUgPSB2YWx1ZTsKICAgICAgICAgIH0sCiAgICAgICAgICBbdmFsdWVdCiAgICAgICAgKTsKICAgICAgICB1c2VEZWJ1Z1ZhbHVlMih2YWx1ZSk7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9OwogICAgICAidW5kZWZpbmVkIiAhPT0gdHlwZW9mIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXyAmJiAiZnVuY3Rpb24iID09PSB0eXBlb2YgX19SRUFDVF9ERVZUT09MU19HTE9CQUxfSE9PS19fLnJlZ2lzdGVySW50ZXJuYWxNb2R1bGVTdG9wICYmIF9fUkVBQ1RfREVWVE9PTFNfR0xPQkFMX0hPT0tfXy5yZWdpc3RlckludGVybmFsTW9kdWxlU3RvcChFcnJvcigpKTsKICAgIH0pKCk7CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS91c2Utc3luYy1leHRlcm5hbC1zdG9yZUAxLjYuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlL3dpdGgtc2VsZWN0b3IuanMKdmFyIHJlcXVpcmVfd2l0aF9zZWxlY3RvcjIgPSBfX2NvbW1vbkpTKHsKICAibm9kZV9tb2R1bGVzLy5wbnBtL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlQDEuNi4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvd2l0aC1zZWxlY3Rvci5qcyIoZXhwb3J0cywgbW9kdWxlKSB7CiAgICAidXNlIHN0cmljdCI7CiAgICBpZiAoZmFsc2UpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlX3VzZV9zeW5jX2V4dGVybmFsX3N0b3JlX3dpdGhfc2VsZWN0b3JfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvcmVhY3QvY2pzL3JlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzCnZhciByZXF1aXJlX3JlYWN0X2pzeF9ydW50aW1lX2RldmVsb3BtZW50ID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0L2Nqcy9yZWFjdC1qc3gtcnVudGltZS5kZXZlbG9wbWVudC5qcyIoZXhwb3J0cykgewogICAgInVzZSBzdHJpY3QiOwogICAgaWYgKHRydWUpIHsKICAgICAgKGZ1bmN0aW9uKCkgewogICAgICAgICJ1c2Ugc3RyaWN0IjsKICAgICAgICB2YXIgUmVhY3QzOSA9IHJlcXVpcmVfcmVhY3QoKTsKICAgICAgICB2YXIgUkVBQ1RfRUxFTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZWxlbWVudCIpOwogICAgICAgIHZhciBSRUFDVF9QT1JUQUxfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnBvcnRhbCIpOwogICAgICAgIHZhciBSRUFDVF9GUkFHTUVOVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuZnJhZ21lbnQiKTsKICAgICAgICB2YXIgUkVBQ1RfU1RSSUNUX01PREVfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LnN0cmljdF9tb2RlIik7CiAgICAgICAgdmFyIFJFQUNUX1BST0ZJTEVSX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5wcm9maWxlciIpOwogICAgICAgIHZhciBSRUFDVF9QUk9WSURFUl9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QucHJvdmlkZXIiKTsKICAgICAgICB2YXIgUkVBQ1RfQ09OVEVYVF9UWVBFID0gU3ltYm9sLmZvcigicmVhY3QuY29udGV4dCIpOwogICAgICAgIHZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiA9IFN5bWJvbC5mb3IoInJlYWN0LmZvcndhcmRfcmVmIik7CiAgICAgICAgdmFyIFJFQUNUX1NVU1BFTlNFX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZSIpOwogICAgICAgIHZhciBSRUFDVF9TVVNQRU5TRV9MSVNUX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5zdXNwZW5zZV9saXN0Iik7CiAgICAgICAgdmFyIFJFQUNUX01FTU9fVFlQRTIgPSBTeW1ib2wuZm9yKCJyZWFjdC5tZW1vIik7CiAgICAgICAgdmFyIFJFQUNUX0xBWllfVFlQRSA9IFN5bWJvbC5mb3IoInJlYWN0LmxhenkiKTsKICAgICAgICB2YXIgUkVBQ1RfT0ZGU0NSRUVOX1RZUEUgPSBTeW1ib2wuZm9yKCJyZWFjdC5vZmZzY3JlZW4iKTsKICAgICAgICB2YXIgTUFZQkVfSVRFUkFUT1JfU1lNQk9MID0gU3ltYm9sLml0ZXJhdG9yOwogICAgICAgIHZhciBGQVVYX0lURVJBVE9SX1NZTUJPTCA9ICJAQGl0ZXJhdG9yIjsKICAgICAgICBmdW5jdGlvbiBnZXRJdGVyYXRvckZuKG1heWJlSXRlcmFibGUpIHsKICAgICAgICAgIGlmIChtYXliZUl0ZXJhYmxlID09PSBudWxsIHx8IHR5cGVvZiBtYXliZUl0ZXJhYmxlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBtYXliZUl0ZXJhdG9yID0gTUFZQkVfSVRFUkFUT1JfU1lNQk9MICYmIG1heWJlSXRlcmFibGVbTUFZQkVfSVRFUkFUT1JfU1lNQk9MXSB8fCBtYXliZUl0ZXJhYmxlW0ZBVVhfSVRFUkFUT1JfU1lNQk9MXTsKICAgICAgICAgIGlmICh0eXBlb2YgbWF5YmVJdGVyYXRvciA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gbWF5YmVJdGVyYXRvcjsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RTaGFyZWRJbnRlcm5hbHMgPSBSZWFjdDM5Ll9fU0VDUkVUX0lOVEVSTkFMU19ET19OT1RfVVNFX09SX1lPVV9XSUxMX0JFX0ZJUkVEOwogICAgICAgIGZ1bmN0aW9uIGVycm9yKGZvcm1hdDIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiA+IDEgPyBfbGVuMiAtIDEgOiAwKSwgX2tleTIgPSAxOyBfa2V5MiA8IF9sZW4yOyBfa2V5MisrKSB7CiAgICAgICAgICAgICAgICBhcmdzW19rZXkyIC0gMV0gPSBhcmd1bWVudHNbX2tleTJdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwcmludFdhcm5pbmcoImVycm9yIiwgZm9ybWF0MiwgYXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gcHJpbnRXYXJuaW5nKGxldmVsLCBmb3JtYXQyLCBhcmdzKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBSZWFjdERlYnVnQ3VycmVudEZyYW1lMiA9IFJlYWN0U2hhcmVkSW50ZXJuYWxzLlJlYWN0RGVidWdDdXJyZW50RnJhbWU7CiAgICAgICAgICAgIHZhciBzdGFjayA9IFJlYWN0RGVidWdDdXJyZW50RnJhbWUyLmdldFN0YWNrQWRkZW5kdW0oKTsKICAgICAgICAgICAgaWYgKHN0YWNrICE9PSAiIikgewogICAgICAgICAgICAgIGZvcm1hdDIgKz0gIiVzIjsKICAgICAgICAgICAgICBhcmdzID0gYXJncy5jb25jYXQoW3N0YWNrXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFyZ3NXaXRoRm9ybWF0ID0gYXJncy5tYXAoZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICAgIHJldHVybiBTdHJpbmcoaXRlbSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBhcmdzV2l0aEZvcm1hdC51bnNoaWZ0KCJXYXJuaW5nOiAiICsgZm9ybWF0Mik7CiAgICAgICAgICAgIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKGNvbnNvbGVbbGV2ZWxdLCBjb25zb2xlLCBhcmdzV2l0aEZvcm1hdCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBlbmFibGVTY29wZUFQSSA9IGZhbHNlOwogICAgICAgIHZhciBlbmFibGVDYWNoZUVsZW1lbnQgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlVHJhbnNpdGlvblRyYWNpbmcgPSBmYWxzZTsKICAgICAgICB2YXIgZW5hYmxlTGVnYWN5SGlkZGVuID0gZmFsc2U7CiAgICAgICAgdmFyIGVuYWJsZURlYnVnVHJhY2luZyA9IGZhbHNlOwogICAgICAgIHZhciBSRUFDVF9NT0RVTEVfUkVGRVJFTkNFOwogICAgICAgIHsKICAgICAgICAgIFJFQUNUX01PRFVMRV9SRUZFUkVOQ0UgPSBTeW1ib2wuZm9yKCJyZWFjdC5tb2R1bGUucmVmZXJlbmNlIik7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJzdHJpbmciIHx8IHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUgfHwgdHlwZSA9PT0gUkVBQ1RfUFJPRklMRVJfVFlQRSB8fCBlbmFibGVEZWJ1Z1RyYWNpbmcgfHwgdHlwZSA9PT0gUkVBQ1RfU1RSSUNUX01PREVfVFlQRSB8fCB0eXBlID09PSBSRUFDVF9TVVNQRU5TRV9UWVBFIHx8IHR5cGUgPT09IFJFQUNUX1NVU1BFTlNFX0xJU1RfVFlQRSB8fCBlbmFibGVMZWdhY3lIaWRkZW4gfHwgdHlwZSA9PT0gUkVBQ1RfT0ZGU0NSRUVOX1RZUEUgfHwgZW5hYmxlU2NvcGVBUEkgfHwgZW5hYmxlQ2FjaGVFbGVtZW50IHx8IGVuYWJsZVRyYW5zaXRpb25UcmFjaW5nKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAib2JqZWN0IiAmJiB0eXBlICE9PSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9MQVpZX1RZUEUgfHwgdHlwZS4kJHR5cGVvZiA9PT0gUkVBQ1RfTUVNT19UWVBFMiB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9QUk9WSURFUl9UWVBFIHx8IHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0NPTlRFWFRfVFlQRSB8fCB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFMiB8fCAvLyBUaGlzIG5lZWRzIHRvIGluY2x1ZGUgYWxsIHBvc3NpYmxlIG1vZHVsZSByZWZlcmVuY2Ugb2JqZWN0CiAgICAgICAgICAgIC8vIHR5cGVzIHN1cHBvcnRlZCBieSBhbnkgRmxpZ2h0IGNvbmZpZ3VyYXRpb24gYW55d2hlcmUgc2luY2UKICAgICAgICAgICAgLy8gd2UgZG9uJ3Qga25vdyB3aGljaCBGbGlnaHQgYnVpbGQgdGhpcyB3aWxsIGVuZCB1cCBiZWluZyB1c2VkCiAgICAgICAgICAgIC8vIHdpdGguCiAgICAgICAgICAgIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01PRFVMRV9SRUZFUkVOQ0UgfHwgdHlwZS5nZXRNb2R1bGVJZCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0V3JhcHBlZE5hbWUob3V0ZXJUeXBlLCBpbm5lclR5cGUsIHdyYXBwZXJOYW1lKSB7CiAgICAgICAgICB2YXIgZGlzcGxheU5hbWUgPSBvdXRlclR5cGUuZGlzcGxheU5hbWU7CiAgICAgICAgICBpZiAoZGlzcGxheU5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIGRpc3BsYXlOYW1lOwogICAgICAgICAgfQogICAgICAgICAgdmFyIGZ1bmN0aW9uTmFtZSA9IGlubmVyVHlwZS5kaXNwbGF5TmFtZSB8fCBpbm5lclR5cGUubmFtZSB8fCAiIjsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbk5hbWUgIT09ICIiID8gd3JhcHBlck5hbWUgKyAiKCIgKyBmdW5jdGlvbk5hbWUgKyAiKSIgOiB3cmFwcGVyTmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZ2V0Q29udGV4dE5hbWUodHlwZSkgewogICAgICAgICAgcmV0dXJuIHR5cGUuZGlzcGxheU5hbWUgfHwgIkNvbnRleHQiOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZSkgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0eXBlLnRhZyA9PT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICBlcnJvcigiUmVjZWl2ZWQgYW4gdW5leHBlY3RlZCBvYmplY3QgaW4gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKCkuIFRoaXMgaXMgbGlrZWx5IGEgYnVnIGluIFJlYWN0LiBQbGVhc2UgZmlsZSBhbiBpc3N1ZS4iKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCBudWxsOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICByZXR1cm4gdHlwZTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICBjYXNlIFJFQUNUX0ZSQUdNRU5UX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJGcmFnbWVudCI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfUE9SVEFMX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQb3J0YWwiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1BST0ZJTEVSX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJQcm9maWxlciI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1RSSUNUX01PREVfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gIlN0cmljdE1vZGUiOwogICAgICAgICAgICBjYXNlIFJFQUNUX1NVU1BFTlNFX1RZUEU6CiAgICAgICAgICAgICAgcmV0dXJuICJTdXNwZW5zZSI7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiAiU3VzcGVuc2VMaXN0IjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgc3dpdGNoICh0eXBlLiQkdHlwZW9mKSB7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9DT05URVhUX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHR5cGU7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0Q29udGV4dE5hbWUoY29udGV4dCkgKyAiLkNvbnN1bWVyIjsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX1BST1ZJREVSX1RZUEU6CiAgICAgICAgICAgICAgICB2YXIgcHJvdmlkZXIgPSB0eXBlOwogICAgICAgICAgICAgICAgcmV0dXJuIGdldENvbnRleHROYW1lKHByb3ZpZGVyLl9jb250ZXh0KSArICIuUHJvdmlkZXIiOwogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0V3JhcHBlZE5hbWUodHlwZSwgdHlwZS5yZW5kZXIsICJGb3J3YXJkUmVmIik7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9NRU1PX1RZUEUyOgogICAgICAgICAgICAgICAgdmFyIG91dGVyTmFtZSA9IHR5cGUuZGlzcGxheU5hbWUgfHwgbnVsbDsKICAgICAgICAgICAgICAgIGlmIChvdXRlck5hbWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG91dGVyTmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUodHlwZS50eXBlKSB8fCAiTWVtbyI7CiAgICAgICAgICAgICAgY2FzZSBSRUFDVF9MQVpZX1RZUEU6IHsKICAgICAgICAgICAgICAgIHZhciBsYXp5Q29tcG9uZW50ID0gdHlwZTsKICAgICAgICAgICAgICAgIHZhciBwYXlsb2FkID0gbGF6eUNvbXBvbmVudC5fcGF5bG9hZDsKICAgICAgICAgICAgICAgIHZhciBpbml0ID0gbGF6eUNvbXBvbmVudC5faW5pdDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoaW5pdChwYXlsb2FkKSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgYXNzaWduMiA9IE9iamVjdC5hc3NpZ247CiAgICAgICAgdmFyIGRpc2FibGVkRGVwdGggPSAwOwogICAgICAgIHZhciBwcmV2TG9nOwogICAgICAgIHZhciBwcmV2SW5mbzsKICAgICAgICB2YXIgcHJldldhcm47CiAgICAgICAgdmFyIHByZXZFcnJvcjsKICAgICAgICB2YXIgcHJldkdyb3VwOwogICAgICAgIHZhciBwcmV2R3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgdmFyIHByZXZHcm91cEVuZDsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlZExvZygpIHsKICAgICAgICB9CiAgICAgICAgZGlzYWJsZWRMb2cuX19yZWFjdERpc2FibGVkTG9nID0gdHJ1ZTsKICAgICAgICBmdW5jdGlvbiBkaXNhYmxlTG9ncygpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICBwcmV2TG9nID0gY29uc29sZS5sb2c7CiAgICAgICAgICAgICAgcHJldkluZm8gPSBjb25zb2xlLmluZm87CiAgICAgICAgICAgICAgcHJldldhcm4gPSBjb25zb2xlLndhcm47CiAgICAgICAgICAgICAgcHJldkVycm9yID0gY29uc29sZS5lcnJvcjsKICAgICAgICAgICAgICBwcmV2R3JvdXAgPSBjb25zb2xlLmdyb3VwOwogICAgICAgICAgICAgIHByZXZHcm91cENvbGxhcHNlZCA9IGNvbnNvbGUuZ3JvdXBDb2xsYXBzZWQ7CiAgICAgICAgICAgICAgcHJldkdyb3VwRW5kID0gY29uc29sZS5ncm91cEVuZDsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IGRpc2FibGVkTG9nLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGluZm86IHByb3BzLAogICAgICAgICAgICAgICAgbG9nOiBwcm9wcywKICAgICAgICAgICAgICAgIHdhcm46IHByb3BzLAogICAgICAgICAgICAgICAgZXJyb3I6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXA6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBDb2xsYXBzZWQ6IHByb3BzLAogICAgICAgICAgICAgICAgZ3JvdXBFbmQ6IHByb3BzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGlzYWJsZWREZXB0aCsrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiByZWVuYWJsZUxvZ3MoKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGRpc2FibGVkRGVwdGgtLTsKICAgICAgICAgICAgaWYgKGRpc2FibGVkRGVwdGggPT09IDApIHsKICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7CiAgICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICAgICAgd3JpdGFibGU6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGNvbnNvbGUsIHsKICAgICAgICAgICAgICAgIGxvZzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZMb2cKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgaW5mbzogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZJbmZvCiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHdhcm46IGFzc2lnbjIoe30sIHByb3BzLCB7CiAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmV2V2FybgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBlcnJvcjogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZFcnJvcgogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cENvbGxhcHNlZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cENvbGxhcHNlZAogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBncm91cEVuZDogYXNzaWduMih7fSwgcHJvcHMsIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHByZXZHcm91cEVuZAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZGlzYWJsZWREZXB0aCA8IDApIHsKICAgICAgICAgICAgICBlcnJvcigiZGlzYWJsZWREZXB0aCBmZWxsIGJlbG93IHplcm8uIFRoaXMgaXMgYSBidWcgaW4gUmVhY3QuIFBsZWFzZSBmaWxlIGFuIGlzc3VlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEN1cnJlbnREaXNwYXRjaGVyID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3RDdXJyZW50RGlzcGF0Y2hlcjsKICAgICAgICB2YXIgcHJlZml4OwogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKG5hbWUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAocHJlZml4ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgdmFyIG1hdGNoID0geDIuc3RhY2sudHJpbSgpLm1hdGNoKC9cbiggKihhdCApPykvKTsKICAgICAgICAgICAgICAgIHByZWZpeCA9IG1hdGNoICYmIG1hdGNoWzFdIHx8ICIiOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIlxuIiArIHByZWZpeCArIG5hbWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciByZWVudHJ5ID0gZmFsc2U7CiAgICAgICAgdmFyIGNvbXBvbmVudEZyYW1lQ2FjaGU7CiAgICAgICAgewogICAgICAgICAgdmFyIFBvc3NpYmx5V2Vha01hcCA9IHR5cGVvZiBXZWFrTWFwID09PSAiZnVuY3Rpb24iID8gV2Vha01hcCA6IE1hcDsKICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUgPSBuZXcgUG9zc2libHlXZWFrTWFwKCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGNvbnN0cnVjdCkgewogICAgICAgICAgaWYgKCFmbiB8fCByZWVudHJ5KSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGZyYW1lID0gY29tcG9uZW50RnJhbWVDYWNoZS5nZXQoZm4pOwogICAgICAgICAgICBpZiAoZnJhbWUgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHJldHVybiBmcmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdmFyIGNvbnRyb2w7CiAgICAgICAgICByZWVudHJ5ID0gdHJ1ZTsKICAgICAgICAgIHZhciBwcmV2aW91c1ByZXBhcmVTdGFja1RyYWNlID0gRXJyb3IucHJlcGFyZVN0YWNrVHJhY2U7CiAgICAgICAgICBFcnJvci5wcmVwYXJlU3RhY2tUcmFjZSA9IHZvaWQgMDsKICAgICAgICAgIHZhciBwcmV2aW91c0Rpc3BhdGNoZXI7CiAgICAgICAgICB7CiAgICAgICAgICAgIHByZXZpb3VzRGlzcGF0Y2hlciA9IFJlYWN0Q3VycmVudERpc3BhdGNoZXIuY3VycmVudDsKICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50ID0gbnVsbDsKICAgICAgICAgICAgZGlzYWJsZUxvZ3MoKTsKICAgICAgICAgIH0KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChjb25zdHJ1Y3QpIHsKICAgICAgICAgICAgICB2YXIgRmFrZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShGYWtlLnByb3RvdHlwZSwgInByb3BzIiwgewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIFJlZmxlY3QgPT09ICJvYmplY3QiICYmIFJlZmxlY3QuY29uc3RydWN0KSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChGYWtlLCBbXSk7CiAgICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgICBjb250cm9sID0geDI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBSZWZsZWN0LmNvbnN0cnVjdChmbiwgW10sIEZha2UpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICBGYWtlLmNhbGwoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKHgyKSB7CiAgICAgICAgICAgICAgICAgIGNvbnRyb2wgPSB4MjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZuLmNhbGwoRmFrZS5wcm90b3R5cGUpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgICB9IGNhdGNoICh4MikgewogICAgICAgICAgICAgICAgY29udHJvbCA9IHgyOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBmbigpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGNhdGNoIChzYW1wbGUpIHsKICAgICAgICAgICAgaWYgKHNhbXBsZSAmJiBjb250cm9sICYmIHR5cGVvZiBzYW1wbGUuc3RhY2sgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgdmFyIHNhbXBsZUxpbmVzID0gc2FtcGxlLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBjb250cm9sTGluZXMgPSBjb250cm9sLnN0YWNrLnNwbGl0KCJcbiIpOwogICAgICAgICAgICAgIHZhciBzID0gc2FtcGxlTGluZXMubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICB2YXIgYyA9IGNvbnRyb2xMaW5lcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgIHdoaWxlIChzID49IDEgJiYgYyA+PSAwICYmIHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgIGMtLTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgZm9yICg7IHMgPj0gMSAmJiBjID49IDA7IHMtLSwgYy0tKSB7CiAgICAgICAgICAgICAgICBpZiAoc2FtcGxlTGluZXNbc10gIT09IGNvbnRyb2xMaW5lc1tjXSkgewogICAgICAgICAgICAgICAgICBpZiAocyAhPT0gMSB8fCBjICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgICAgICAgcy0tOwogICAgICAgICAgICAgICAgICAgICAgYy0tOwogICAgICAgICAgICAgICAgICAgICAgaWYgKGMgPCAwIHx8IHNhbXBsZUxpbmVzW3NdICE9PSBjb250cm9sTGluZXNbY10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9mcmFtZSA9ICJcbiIgKyBzYW1wbGVMaW5lc1tzXS5yZXBsYWNlKCIgYXQgbmV3ICIsICIgYXQgIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbi5kaXNwbGF5TmFtZSAmJiBfZnJhbWUuaW5jbHVkZXMoIjxhbm9ueW1vdXM+IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICBfZnJhbWUgPSBfZnJhbWUucmVwbGFjZSgiPGFub255bW91cz4iLCBmbi5kaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBfZnJhbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gX2ZyYW1lOwogICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gd2hpbGUgKHMgPj0gMSAmJiBjID49IDApOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgcmVlbnRyeSA9IGZhbHNlOwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgUmVhY3RDdXJyZW50RGlzcGF0Y2hlci5jdXJyZW50ID0gcHJldmlvdXNEaXNwYXRjaGVyOwogICAgICAgICAgICAgIHJlZW5hYmxlTG9ncygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIEVycm9yLnByZXBhcmVTdGFja1RyYWNlID0gcHJldmlvdXNQcmVwYXJlU3RhY2tUcmFjZTsKICAgICAgICAgIH0KICAgICAgICAgIHZhciBuYW1lID0gZm4gPyBmbi5kaXNwbGF5TmFtZSB8fCBmbi5uYW1lIDogIiI7CiAgICAgICAgICB2YXIgc3ludGhldGljRnJhbWUgPSBuYW1lID8gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUobmFtZSkgOiAiIjsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBmbiA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgIGNvbXBvbmVudEZyYW1lQ2FjaGUuc2V0KGZuLCBzeW50aGV0aWNGcmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBzeW50aGV0aWNGcmFtZTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKGZuLCBzb3VyY2UsIG93bmVyRm4pIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlTmF0aXZlQ29tcG9uZW50RnJhbWUoZm4sIGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gc2hvdWxkQ29uc3RydWN0KENvbXBvbmVudCkgewogICAgICAgICAgdmFyIHByb3RvdHlwZSA9IENvbXBvbmVudC5wcm90b3R5cGU7CiAgICAgICAgICByZXR1cm4gISEocHJvdG90eXBlICYmIHByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KTsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUsIHNvdXJjZSwgb3duZXJGbikgewogICAgICAgICAgaWYgKHR5cGUgPT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgewogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZU5hdGl2ZUNvbXBvbmVudEZyYW1lKHR5cGUsIHNob3VsZENvbnN0cnVjdCh0eXBlKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlQnVpbHRJbkNvbXBvbmVudEZyYW1lKHR5cGUpOwogICAgICAgICAgfQogICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfVFlQRToKICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVCdWlsdEluQ29tcG9uZW50RnJhbWUoIlN1c3BlbnNlIik7CiAgICAgICAgICAgIGNhc2UgUkVBQ1RfU1VTUEVOU0VfTElTVF9UWVBFOgogICAgICAgICAgICAgIHJldHVybiBkZXNjcmliZUJ1aWx0SW5Db21wb25lbnRGcmFtZSgiU3VzcGVuc2VMaXN0Iik7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZS4kJHR5cGVvZikgewogICAgICAgICAgICAgIGNhc2UgUkVBQ1RfRk9SV0FSRF9SRUZfVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVGdW5jdGlvbkNvbXBvbmVudEZyYW1lKHR5cGUucmVuZGVyKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX01FTU9fVFlQRTI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGVzY3JpYmVVbmtub3duRWxlbWVudFR5cGVGcmFtZUluREVWKHR5cGUudHlwZSwgc291cmNlLCBvd25lckZuKTsKICAgICAgICAgICAgICBjYXNlIFJFQUNUX0xBWllfVFlQRTogewogICAgICAgICAgICAgICAgdmFyIGxhenlDb21wb25lbnQgPSB0eXBlOwogICAgICAgICAgICAgICAgdmFyIHBheWxvYWQgPSBsYXp5Q29tcG9uZW50Ll9wYXlsb2FkOwogICAgICAgICAgICAgICAgdmFyIGluaXQgPSBsYXp5Q29tcG9uZW50Ll9pbml0OwogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlc2NyaWJlVW5rbm93bkVsZW1lbnRUeXBlRnJhbWVJbkRFVihpbml0KHBheWxvYWQpLCBzb3VyY2UsIG93bmVyRm4pOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoeDIpIHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKICAgICAgICB2YXIgbG9nZ2VkVHlwZUZhaWx1cmVzID0ge307CiAgICAgICAgdmFyIFJlYWN0RGVidWdDdXJyZW50RnJhbWUgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdERlYnVnQ3VycmVudEZyYW1lOwogICAgICAgIGZ1bmN0aW9uIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50KGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUuc2V0RXh0cmFTdGFja0ZyYW1lKHN0YWNrKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBSZWFjdERlYnVnQ3VycmVudEZyYW1lLnNldEV4dHJhU3RhY2tGcmFtZShudWxsKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja1Byb3BUeXBlcyh0eXBlU3BlY3MsIHZhbHVlcywgbG9jYXRpb24sIGNvbXBvbmVudE5hbWUsIGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIGhhczMgPSBGdW5jdGlvbi5jYWxsLmJpbmQoaGFzT3duUHJvcGVydHkpOwogICAgICAgICAgICBmb3IgKHZhciB0eXBlU3BlY05hbWUgaW4gdHlwZVNwZWNzKSB7CiAgICAgICAgICAgICAgaWYgKGhhczModHlwZVNwZWNzLCB0eXBlU3BlY05hbWUpKSB7CiAgICAgICAgICAgICAgICB2YXIgZXJyb3IkMSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0gIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXJyID0gRXJyb3IoKGNvbXBvbmVudE5hbWUgfHwgIlJlYWN0IGNsYXNzIikgKyAiOiAiICsgbG9jYXRpb24gKyAiIHR5cGUgYCIgKyB0eXBlU3BlY05hbWUgKyAiYCBpcyBpbnZhbGlkOyBpdCBtdXN0IGJlIGEgZnVuY3Rpb24sIHVzdWFsbHkgZnJvbSB0aGUgYHByb3AtdHlwZXNgIHBhY2thZ2UsIGJ1dCByZWNlaXZlZCBgIiArIHR5cGVvZiB0eXBlU3BlY3NbdHlwZVNwZWNOYW1lXSArICJgLlRoaXMgb2Z0ZW4gaGFwcGVucyBiZWNhdXNlIG9mIHR5cG9zIHN1Y2ggYXMgYFByb3BUeXBlcy5mdW5jdGlvbmAgaW5zdGVhZCBvZiBgUHJvcFR5cGVzLmZ1bmNgLiIpOwogICAgICAgICAgICAgICAgICAgIGVyci5uYW1lID0gIkludmFyaWFudCBWaW9sYXRpb24iOwogICAgICAgICAgICAgICAgICAgIHRocm93IGVycjsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlcnJvciQxID0gdHlwZVNwZWNzW3R5cGVTcGVjTmFtZV0odmFsdWVzLCB0eXBlU3BlY05hbWUsIGNvbXBvbmVudE5hbWUsIGxvY2F0aW9uLCBudWxsLCAiU0VDUkVUX0RPX05PVF9QQVNTX1RISVNfT1JfWU9VX1dJTExfQkVfRklSRUQiKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7CiAgICAgICAgICAgICAgICAgIGVycm9yJDEgPSBleDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlcnJvciQxICYmICEoZXJyb3IkMSBpbnN0YW5jZW9mIEVycm9yKSkgewogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIiVzOiB0eXBlIHNwZWNpZmljYXRpb24gb2YgJXMgYCVzYCBpcyBpbnZhbGlkOyB0aGUgdHlwZSBjaGVja2VyIGZ1bmN0aW9uIG11c3QgcmV0dXJuIGBudWxsYCBvciBhbiBgRXJyb3JgIGJ1dCByZXR1cm5lZCBhICVzLiBZb3UgbWF5IGhhdmUgZm9yZ290dGVuIHRvIHBhc3MgYW4gYXJndW1lbnQgdG8gdGhlIHR5cGUgY2hlY2tlciBjcmVhdG9yIChhcnJheU9mLCBpbnN0YW5jZU9mLCBvYmplY3RPZiwgb25lT2YsIG9uZU9mVHlwZSwgYW5kIHNoYXBlIGFsbCByZXF1aXJlIGFuIGFyZ3VtZW50KS4iLCBjb21wb25lbnROYW1lIHx8ICJSZWFjdCBjbGFzcyIsIGxvY2F0aW9uLCB0eXBlU3BlY05hbWUsIHR5cGVvZiBlcnJvciQxKTsKICAgICAgICAgICAgICAgICAgc2V0Q3VycmVudGx5VmFsaWRhdGluZ0VsZW1lbnQobnVsbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoZXJyb3IkMSBpbnN0YW5jZW9mIEVycm9yICYmICEoZXJyb3IkMS5tZXNzYWdlIGluIGxvZ2dlZFR5cGVGYWlsdXJlcykpIHsKICAgICAgICAgICAgICAgICAgbG9nZ2VkVHlwZUZhaWx1cmVzW2Vycm9yJDEubWVzc2FnZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChlbGVtZW50KTsKICAgICAgICAgICAgICAgICAgZXJyb3IoIkZhaWxlZCAlcyB0eXBlOiAlcyIsIGxvY2F0aW9uLCBlcnJvciQxLm1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudChudWxsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGlzQXJyYXlJbXBsID0gQXJyYXkuaXNBcnJheTsKICAgICAgICBmdW5jdGlvbiBpc0FycmF5MihhKSB7CiAgICAgICAgICByZXR1cm4gaXNBcnJheUltcGwoYSk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHR5cGVOYW1lKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBoYXNUb1N0cmluZ1RhZyA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgU3ltYm9sLnRvU3RyaW5nVGFnOwogICAgICAgICAgICB2YXIgdHlwZSA9IGhhc1RvU3RyaW5nVGFnICYmIHZhbHVlW1N5bWJvbC50b1N0cmluZ1RhZ10gfHwgdmFsdWUuY29uc3RydWN0b3IubmFtZSB8fCAiT2JqZWN0IjsKICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHdpbGxDb2VyY2lvblRocm93KHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB0ZXN0U3RyaW5nQ29lcmNpb24odmFsdWUpIHsKICAgICAgICAgIHJldHVybiAiIiArIHZhbHVlOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBjaGVja0tleVN0cmluZ0NvZXJjaW9uKHZhbHVlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICh3aWxsQ29lcmNpb25UaHJvdyh2YWx1ZSkpIHsKICAgICAgICAgICAgICBlcnJvcigiVGhlIHByb3ZpZGVkIGtleSBpcyBhbiB1bnN1cHBvcnRlZCB0eXBlICVzLiBUaGlzIHZhbHVlIG11c3QgYmUgY29lcmNlZCB0byBhIHN0cmluZyBiZWZvcmUgYmVmb3JlIHVzaW5nIGl0IGhlcmUuIiwgdHlwZU5hbWUodmFsdWUpKTsKICAgICAgICAgICAgICByZXR1cm4gdGVzdFN0cmluZ0NvZXJjaW9uKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIgUmVhY3RDdXJyZW50T3duZXIgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgUkVTRVJWRURfUFJPUFMgPSB7CiAgICAgICAgICBrZXk6IHRydWUsCiAgICAgICAgICByZWY6IHRydWUsCiAgICAgICAgICBfX3NlbGY6IHRydWUsCiAgICAgICAgICBfX3NvdXJjZTogdHJ1ZQogICAgICAgIH07CiAgICAgICAgdmFyIHNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duOwogICAgICAgIHZhciBzcGVjaWFsUHJvcFJlZldhcm5pbmdTaG93bjsKICAgICAgICB2YXIgZGlkV2FybkFib3V0U3RyaW5nUmVmczsKICAgICAgICB7CiAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzID0ge307CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGhhc1ZhbGlkUmVmKGNvbmZpZykgewogICAgICAgICAgewogICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsICJyZWYiKSkgewogICAgICAgICAgICAgIHZhciBnZXR0ZXIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGNvbmZpZywgInJlZiIpLmdldDsKICAgICAgICAgICAgICBpZiAoZ2V0dGVyICYmIGdldHRlci5pc1JlYWN0V2FybmluZykgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGNvbmZpZy5yZWYgIT09IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gaGFzVmFsaWRLZXkoY29uZmlnKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKGNvbmZpZywgImtleSIpKSB7CiAgICAgICAgICAgICAgdmFyIGdldHRlciA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoY29uZmlnLCAia2V5IikuZ2V0OwogICAgICAgICAgICAgIGlmIChnZXR0ZXIgJiYgZ2V0dGVyLmlzUmVhY3RXYXJuaW5nKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gY29uZmlnLmtleSAhPT0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnLCBzZWxmMikgewogICAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5yZWYgPT09ICJzdHJpbmciICYmIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQgJiYgc2VsZjIgJiYgUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC5zdGF0ZU5vZGUgIT09IHNlbGYyKSB7CiAgICAgICAgICAgICAgdmFyIGNvbXBvbmVudE5hbWUgPSBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAoIWRpZFdhcm5BYm91dFN0cmluZ1JlZnNbY29tcG9uZW50TmFtZV0pIHsKICAgICAgICAgICAgICAgIGVycm9yKCdDb21wb25lbnQgIiVzIiBjb250YWlucyB0aGUgc3RyaW5nIHJlZiAiJXMiLiBTdXBwb3J0IGZvciBzdHJpbmcgcmVmcyB3aWxsIGJlIHJlbW92ZWQgaW4gYSBmdXR1cmUgbWFqb3IgcmVsZWFzZS4gVGhpcyBjYXNlIGNhbm5vdCBiZSBhdXRvbWF0aWNhbGx5IGNvbnZlcnRlZCB0byBhbiBhcnJvdyBmdW5jdGlvbi4gV2UgYXNrIHlvdSB0byBtYW51YWxseSBmaXggdGhpcyBjYXNlIGJ5IHVzaW5nIHVzZVJlZigpIG9yIGNyZWF0ZVJlZigpIGluc3RlYWQuIExlYXJuIG1vcmUgYWJvdXQgdXNpbmcgcmVmcyBzYWZlbHkgaGVyZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9saW5rL3N0cmljdC1tb2RlLXN0cmluZy1yZWYnLCBnZXRDb21wb25lbnROYW1lRnJvbVR5cGUoUmVhY3RDdXJyZW50T3duZXIuY3VycmVudC50eXBlKSwgY29uZmlnLnJlZik7CiAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRTdHJpbmdSZWZzW2NvbXBvbmVudE5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gZGVmaW5lS2V5UHJvcFdhcm5pbmdHZXR0ZXIocHJvcHMsIGRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICBpZiAoIXNwZWNpYWxQcm9wS2V5V2FybmluZ1Nob3duKSB7CiAgICAgICAgICAgICAgICBzcGVjaWFsUHJvcEtleVdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgICBlcnJvcigiJXM6IGBrZXlgIGlzIG5vdCBhIHByb3AuIFRyeWluZyB0byBhY2Nlc3MgaXQgd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgYmVpbmcgcmV0dXJuZWQuIElmIHlvdSBuZWVkIHRvIGFjY2VzcyB0aGUgc2FtZSB2YWx1ZSB3aXRoaW4gdGhlIGNoaWxkIGNvbXBvbmVudCwgeW91IHNob3VsZCBwYXNzIGl0IGFzIGEgZGlmZmVyZW50IHByb3AuIChodHRwczovL3JlYWN0anMub3JnL2xpbmsvc3BlY2lhbC1wcm9wcykiLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB3YXJuQWJvdXRBY2Nlc3NpbmdLZXkuaXNSZWFjdFdhcm5pbmcgPSB0cnVlOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICJrZXkiLCB7CiAgICAgICAgICAgICAgZ2V0OiB3YXJuQWJvdXRBY2Nlc3NpbmdLZXksCiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBkZWZpbmVSZWZQcm9wV2FybmluZ0dldHRlcihwcm9wcywgZGlzcGxheU5hbWUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHdhcm5BYm91dEFjY2Vzc2luZ1JlZiA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGlmICghc3BlY2lhbFByb3BSZWZXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICAgIHNwZWNpYWxQcm9wUmVmV2FybmluZ1Nob3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGVycm9yKCIlczogYHJlZmAgaXMgbm90IGEgcHJvcC4gVHJ5aW5nIHRvIGFjY2VzcyBpdCB3aWxsIHJlc3VsdCBpbiBgdW5kZWZpbmVkYCBiZWluZyByZXR1cm5lZC4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzYW1lIHZhbHVlIHdpdGhpbiB0aGUgY2hpbGQgY29tcG9uZW50LCB5b3Ugc2hvdWxkIHBhc3MgaXQgYXMgYSBkaWZmZXJlbnQgcHJvcC4gKGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay9zcGVjaWFsLXByb3BzKSIsIGRpc3BsYXlOYW1lKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHdhcm5BYm91dEFjY2Vzc2luZ1JlZi5pc1JlYWN0V2FybmluZyA9IHRydWU7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShwcm9wcywgInJlZiIsIHsKICAgICAgICAgICAgICBnZXQ6IHdhcm5BYm91dEFjY2Vzc2luZ1JlZiwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBSZWFjdEVsZW1lbnQgPSBmdW5jdGlvbih0eXBlLCBrZXksIHJlZiwgc2VsZjIsIHNvdXJjZSwgb3duZXIsIHByb3BzKSB7CiAgICAgICAgICB2YXIgZWxlbWVudCA9IHsKICAgICAgICAgICAgLy8gVGhpcyB0YWcgYWxsb3dzIHVzIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IHRoaXMgYXMgYSBSZWFjdCBFbGVtZW50CiAgICAgICAgICAgICQkdHlwZW9mOiBSRUFDVF9FTEVNRU5UX1RZUEUsCiAgICAgICAgICAgIC8vIEJ1aWx0LWluIHByb3BlcnRpZXMgdGhhdCBiZWxvbmcgb24gdGhlIGVsZW1lbnQKICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAga2V5LAogICAgICAgICAgICByZWYsCiAgICAgICAgICAgIHByb3BzLAogICAgICAgICAgICAvLyBSZWNvcmQgdGhlIGNvbXBvbmVudCByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgdGhpcyBlbGVtZW50LgogICAgICAgICAgICBfb3duZXI6IG93bmVyCiAgICAgICAgICB9OwogICAgICAgICAgewogICAgICAgICAgICBlbGVtZW50Ll9zdG9yZSA9IHt9OwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudC5fc3RvcmUsICJ2YWxpZGF0ZWQiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgICB2YWx1ZTogZmFsc2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbGVtZW50LCAiX3NlbGYiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgdmFsdWU6IHNlbGYyCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZWxlbWVudCwgIl9zb3VyY2UiLCB7CiAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICB3cml0YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgdmFsdWU6IHNvdXJjZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKE9iamVjdC5mcmVlemUpIHsKICAgICAgICAgICAgICBPYmplY3QuZnJlZXplKGVsZW1lbnQucHJvcHMpOwogICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24ganN4REVWKHR5cGUsIGNvbmZpZywgbWF5YmVLZXksIHNvdXJjZSwgc2VsZjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHByb3BOYW1lOwogICAgICAgICAgICB2YXIgcHJvcHMgPSB7fTsKICAgICAgICAgICAgdmFyIGtleSA9IG51bGw7CiAgICAgICAgICAgIHZhciByZWYgPSBudWxsOwogICAgICAgICAgICBpZiAobWF5YmVLZXkgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNoZWNrS2V5U3RyaW5nQ29lcmNpb24obWF5YmVLZXkpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBrZXkgPSAiIiArIG1heWJlS2V5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNWYWxpZEtleShjb25maWcpKSB7CiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY2hlY2tLZXlTdHJpbmdDb2VyY2lvbihjb25maWcua2V5KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAga2V5ID0gIiIgKyBjb25maWcua2V5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChoYXNWYWxpZFJlZihjb25maWcpKSB7CiAgICAgICAgICAgICAgcmVmID0gY29uZmlnLnJlZjsKICAgICAgICAgICAgICB3YXJuSWZTdHJpbmdSZWZDYW5ub3RCZUF1dG9Db252ZXJ0ZWQoY29uZmlnLCBzZWxmMik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChwcm9wTmFtZSBpbiBjb25maWcpIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChjb25maWcsIHByb3BOYW1lKSAmJiAhUkVTRVJWRURfUFJPUFMuaGFzT3duUHJvcGVydHkocHJvcE5hbWUpKSB7CiAgICAgICAgICAgICAgICBwcm9wc1twcm9wTmFtZV0gPSBjb25maWdbcHJvcE5hbWVdOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZSAmJiB0eXBlLmRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgIHZhciBkZWZhdWx0UHJvcHMgPSB0eXBlLmRlZmF1bHRQcm9wczsKICAgICAgICAgICAgICBmb3IgKHByb3BOYW1lIGluIGRlZmF1bHRQcm9wcykgewogICAgICAgICAgICAgICAgaWYgKHByb3BzW3Byb3BOYW1lXSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgIHByb3BzW3Byb3BOYW1lXSA9IGRlZmF1bHRQcm9wc1twcm9wTmFtZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChrZXkgfHwgcmVmKSB7CiAgICAgICAgICAgICAgdmFyIGRpc3BsYXlOYW1lID0gdHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIgPyB0eXBlLmRpc3BsYXlOYW1lIHx8IHR5cGUubmFtZSB8fCAiVW5rbm93biIgOiB0eXBlOwogICAgICAgICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgICAgIGRlZmluZUtleVByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZWYpIHsKICAgICAgICAgICAgICAgIGRlZmluZVJlZlByb3BXYXJuaW5nR2V0dGVyKHByb3BzLCBkaXNwbGF5TmFtZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBSZWFjdEVsZW1lbnQodHlwZSwga2V5LCByZWYsIHNlbGYyLCBzb3VyY2UsIFJlYWN0Q3VycmVudE93bmVyLmN1cnJlbnQsIHByb3BzKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIFJlYWN0Q3VycmVudE93bmVyJDEgPSBSZWFjdFNoYXJlZEludGVybmFscy5SZWFjdEN1cnJlbnRPd25lcjsKICAgICAgICB2YXIgUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZSQxID0gUmVhY3RTaGFyZWRJbnRlcm5hbHMuUmVhY3REZWJ1Z0N1cnJlbnRGcmFtZTsKICAgICAgICBmdW5jdGlvbiBzZXRDdXJyZW50bHlWYWxpZGF0aW5nRWxlbWVudCQxKGVsZW1lbnQpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHsKICAgICAgICAgICAgICB2YXIgb3duZXIgPSBlbGVtZW50Ll9vd25lcjsKICAgICAgICAgICAgICB2YXIgc3RhY2sgPSBkZXNjcmliZVVua25vd25FbGVtZW50VHlwZUZyYW1lSW5ERVYoZWxlbWVudC50eXBlLCBlbGVtZW50Ll9zb3VyY2UsIG93bmVyID8gb3duZXIudHlwZSA6IG51bGwpOwogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUoc3RhY2spOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIFJlYWN0RGVidWdDdXJyZW50RnJhbWUkMS5zZXRFeHRyYVN0YWNrRnJhbWUobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duOwogICAgICAgIHsKICAgICAgICAgIHByb3BUeXBlc01pc3NwZWxsV2FybmluZ1Nob3duID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGlzVmFsaWRFbGVtZW50MTUob2JqZWN0KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0eXBlb2Ygb2JqZWN0ID09PSAib2JqZWN0IiAmJiBvYmplY3QgIT09IG51bGwgJiYgb2JqZWN0LiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudCkgewogICAgICAgICAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKFJlYWN0Q3VycmVudE93bmVyJDEuY3VycmVudC50eXBlKTsKICAgICAgICAgICAgICBpZiAobmFtZSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJcblxuQ2hlY2sgdGhlIHJlbmRlciBtZXRob2Qgb2YgYCIgKyBuYW1lICsgImAuIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBnZXRTb3VyY2VJbmZvRXJyb3JBZGRlbmR1bShzb3VyY2UpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHNvdXJjZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgdmFyIGZpbGVOYW1lID0gc291cmNlLmZpbGVOYW1lLnJlcGxhY2UoL14uKltcXFwvXS8sICIiKTsKICAgICAgICAgICAgICB2YXIgbGluZU51bWJlciA9IHNvdXJjZS5saW5lTnVtYmVyOwogICAgICAgICAgICAgIHJldHVybiAiXG5cbkNoZWNrIHlvdXIgY29kZSBhdCAiICsgZmlsZU5hbWUgKyAiOiIgKyBsaW5lTnVtYmVyICsgIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIG93bmVySGFzS2V5VXNlV2FybmluZyA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGdldEN1cnJlbnRDb21wb25lbnRFcnJvckluZm8ocGFyZW50VHlwZSkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgaW5mbyA9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgICBpZiAoIWluZm8pIHsKICAgICAgICAgICAgICB2YXIgcGFyZW50TmFtZSA9IHR5cGVvZiBwYXJlbnRUeXBlID09PSAic3RyaW5nIiA/IHBhcmVudFR5cGUgOiBwYXJlbnRUeXBlLmRpc3BsYXlOYW1lIHx8IHBhcmVudFR5cGUubmFtZTsKICAgICAgICAgICAgICBpZiAocGFyZW50TmFtZSkgewogICAgICAgICAgICAgICAgaW5mbyA9ICJcblxuQ2hlY2sgdGhlIHRvcC1sZXZlbCByZW5kZXIgY2FsbCB1c2luZyA8IiArIHBhcmVudE5hbWUgKyAiPi4iOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gaW5mbzsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVFeHBsaWNpdEtleShlbGVtZW50LCBwYXJlbnRUeXBlKSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIGlmICghZWxlbWVudC5fc3RvcmUgfHwgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkIHx8IGVsZW1lbnQua2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbWVudC5fc3RvcmUudmFsaWRhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRDb21wb25lbnRFcnJvckluZm8gPSBnZXRDdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvKHBhcmVudFR5cGUpOwogICAgICAgICAgICBpZiAob3duZXJIYXNLZXlVc2VXYXJuaW5nW2N1cnJlbnRDb21wb25lbnRFcnJvckluZm9dKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG93bmVySGFzS2V5VXNlV2FybmluZ1tjdXJyZW50Q29tcG9uZW50RXJyb3JJbmZvXSA9IHRydWU7CiAgICAgICAgICAgIHZhciBjaGlsZE93bmVyID0gIiI7CiAgICAgICAgICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQuX293bmVyICYmIGVsZW1lbnQuX293bmVyICE9PSBSZWFjdEN1cnJlbnRPd25lciQxLmN1cnJlbnQpIHsKICAgICAgICAgICAgICBjaGlsZE93bmVyID0gIiBJdCB3YXMgcGFzc2VkIGEgY2hpbGQgZnJvbSAiICsgZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKGVsZW1lbnQuX293bmVyLnR5cGUpICsgIi4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZWxlbWVudCk7CiAgICAgICAgICAgIGVycm9yKCdFYWNoIGNoaWxkIGluIGEgbGlzdCBzaG91bGQgaGF2ZSBhIHVuaXF1ZSAia2V5IiBwcm9wLiVzJXMgU2VlIGh0dHBzOi8vcmVhY3Rqcy5vcmcvbGluay93YXJuaW5nLWtleXMgZm9yIG1vcmUgaW5mb3JtYXRpb24uJywgY3VycmVudENvbXBvbmVudEVycm9ySW5mbywgY2hpbGRPd25lcik7CiAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIHZhbGlkYXRlQ2hpbGRLZXlzKG5vZGUsIHBhcmVudFR5cGUpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBub2RlICE9PSAib2JqZWN0IikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaXNBcnJheTIobm9kZSkpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5vZGUubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IG5vZGVbaV07CiAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQxNShjaGlsZCkpIHsKICAgICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShjaGlsZCwgcGFyZW50VHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKGlzVmFsaWRFbGVtZW50MTUobm9kZSkpIHsKICAgICAgICAgICAgICBpZiAobm9kZS5fc3RvcmUpIHsKICAgICAgICAgICAgICAgIG5vZGUuX3N0b3JlLnZhbGlkYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUpIHsKICAgICAgICAgICAgICB2YXIgaXRlcmF0b3JGbiA9IGdldEl0ZXJhdG9yRm4obm9kZSk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVyYXRvckZuID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICBpZiAoaXRlcmF0b3JGbiAhPT0gbm9kZS5lbnRyaWVzKSB7CiAgICAgICAgICAgICAgICAgIHZhciBpdGVyYXRvciA9IGl0ZXJhdG9yRm4uY2FsbChub2RlKTsKICAgICAgICAgICAgICAgICAgdmFyIHN0ZXA7CiAgICAgICAgICAgICAgICAgIHdoaWxlICghKHN0ZXAgPSBpdGVyYXRvci5uZXh0KCkpLmRvbmUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZEVsZW1lbnQxNShzdGVwLnZhbHVlKSkgewogICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVFeHBsaWNpdEtleShzdGVwLnZhbHVlLCBwYXJlbnRUeXBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCkgewogICAgICAgICAgewogICAgICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQudHlwZTsKICAgICAgICAgICAgaWYgKHR5cGUgPT09IG51bGwgfHwgdHlwZSA9PT0gdm9pZCAwIHx8IHR5cGVvZiB0eXBlID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgcHJvcFR5cGVzOwogICAgICAgICAgICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICBwcm9wVHlwZXMgPSB0eXBlLnByb3BUeXBlczsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdHlwZSA9PT0gIm9iamVjdCIgJiYgKHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEUyIHx8IC8vIE5vdGU6IE1lbW8gb25seSBjaGVja3Mgb3V0ZXIgcHJvcHMgaGVyZS4KICAgICAgICAgICAgLy8gSW5uZXIgcHJvcHMgYXJlIGNoZWNrZWQgaW4gdGhlIHJlY29uY2lsZXIuCiAgICAgICAgICAgIHR5cGUuJCR0eXBlb2YgPT09IFJFQUNUX01FTU9fVFlQRTIpKSB7CiAgICAgICAgICAgICAgcHJvcFR5cGVzID0gdHlwZS5wcm9wVHlwZXM7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwcm9wVHlwZXMpIHsKICAgICAgICAgICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICBjaGVja1Byb3BUeXBlcyhwcm9wVHlwZXMsIGVsZW1lbnQucHJvcHMsICJwcm9wIiwgbmFtZSwgZWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZS5Qcm9wVHlwZXMgIT09IHZvaWQgMCAmJiAhcHJvcFR5cGVzTWlzc3BlbGxXYXJuaW5nU2hvd24pIHsKICAgICAgICAgICAgICBwcm9wVHlwZXNNaXNzcGVsbFdhcm5pbmdTaG93biA9IHRydWU7CiAgICAgICAgICAgICAgdmFyIF9uYW1lID0gZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUpOwogICAgICAgICAgICAgIGVycm9yKCJDb21wb25lbnQgJXMgZGVjbGFyZWQgYFByb3BUeXBlc2AgaW5zdGVhZCBvZiBgcHJvcFR5cGVzYC4gRGlkIHlvdSBtaXNzcGVsbCB0aGUgcHJvcGVydHkgYXNzaWdubWVudD8iLCBfbmFtZSB8fCAiVW5rbm93biIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZS5nZXREZWZhdWx0UHJvcHMgPT09ICJmdW5jdGlvbiIgJiYgIXR5cGUuZ2V0RGVmYXVsdFByb3BzLmlzUmVhY3RDbGFzc0FwcHJvdmVkKSB7CiAgICAgICAgICAgICAgZXJyb3IoImdldERlZmF1bHRQcm9wcyBpcyBvbmx5IHVzZWQgb24gY2xhc3NpYyBSZWFjdC5jcmVhdGVDbGFzcyBkZWZpbml0aW9ucy4gVXNlIGEgc3RhdGljIHByb3BlcnR5IG5hbWVkIGBkZWZhdWx0UHJvcHNgIGluc3RlYWQuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZnVuY3Rpb24gdmFsaWRhdGVGcmFnbWVudFByb3BzKGZyYWdtZW50KSB7CiAgICAgICAgICB7CiAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoZnJhZ21lbnQucHJvcHMpOwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICB2YXIga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICBpZiAoa2V5ICE9PSAiY2hpbGRyZW4iICYmIGtleSAhPT0gImtleSIpIHsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgICAgZXJyb3IoIkludmFsaWQgcHJvcCBgJXNgIHN1cHBsaWVkIHRvIGBSZWFjdC5GcmFnbWVudGAuIFJlYWN0LkZyYWdtZW50IGNhbiBvbmx5IGhhdmUgYGtleWAgYW5kIGBjaGlsZHJlbmAgcHJvcHMuIiwga2V5KTsKICAgICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZyYWdtZW50LnJlZiAhPT0gbnVsbCkgewogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEoZnJhZ21lbnQpOwogICAgICAgICAgICAgIGVycm9yKCJJbnZhbGlkIGF0dHJpYnV0ZSBgcmVmYCBzdXBwbGllZCB0byBgUmVhY3QuRnJhZ21lbnRgLiIpOwogICAgICAgICAgICAgIHNldEN1cnJlbnRseVZhbGlkYXRpbmdFbGVtZW50JDEobnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGRpZFdhcm5BYm91dEtleVNwcmVhZCA9IHt9OwogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uKHR5cGUsIHByb3BzLCBrZXksIGlzU3RhdGljQ2hpbGRyZW4sIHNvdXJjZSwgc2VsZjIpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgdmFyIHZhbGlkVHlwZSA9IGlzVmFsaWRFbGVtZW50VHlwZSh0eXBlKTsKICAgICAgICAgICAgaWYgKCF2YWxpZFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgaW5mbyA9ICIiOwogICAgICAgICAgICAgIGlmICh0eXBlID09PSB2b2lkIDAgfHwgdHlwZW9mIHR5cGUgPT09ICJvYmplY3QiICYmIHR5cGUgIT09IG51bGwgJiYgT2JqZWN0LmtleXModHlwZSkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICBpbmZvICs9ICIgWW91IGxpa2VseSBmb3Jnb3QgdG8gZXhwb3J0IHlvdXIgY29tcG9uZW50IGZyb20gdGhlIGZpbGUgaXQncyBkZWZpbmVkIGluLCBvciB5b3UgbWlnaHQgaGF2ZSBtaXhlZCB1cCBkZWZhdWx0IGFuZCBuYW1lZCBpbXBvcnRzLiI7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHZhciBzb3VyY2VJbmZvID0gZ2V0U291cmNlSW5mb0Vycm9yQWRkZW5kdW0oc291cmNlKTsKICAgICAgICAgICAgICBpZiAoc291cmNlSW5mbykgewogICAgICAgICAgICAgICAgaW5mbyArPSBzb3VyY2VJbmZvOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpbmZvICs9IGdldERlY2xhcmF0aW9uRXJyb3JBZGRlbmR1bSgpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB2YXIgdHlwZVN0cmluZzsKICAgICAgICAgICAgICBpZiAodHlwZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgdHlwZVN0cmluZyA9ICJudWxsIjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGlzQXJyYXkyKHR5cGUpKSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gImFycmF5IjsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgIT09IHZvaWQgMCAmJiB0eXBlLiQkdHlwZW9mID09PSBSRUFDVF9FTEVNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICAgIHR5cGVTdHJpbmcgPSAiPCIgKyAoZ2V0Q29tcG9uZW50TmFtZUZyb21UeXBlKHR5cGUudHlwZSkgfHwgIlVua25vd24iKSArICIgLz4iOwogICAgICAgICAgICAgICAgaW5mbyA9ICIgRGlkIHlvdSBhY2NpZGVudGFsbHkgZXhwb3J0IGEgSlNYIGxpdGVyYWwgaW5zdGVhZCBvZiBhIGNvbXBvbmVudD8iOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0eXBlU3RyaW5nID0gdHlwZW9mIHR5cGU7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVycm9yKCJSZWFjdC5qc3g6IHR5cGUgaXMgaW52YWxpZCAtLSBleHBlY3RlZCBhIHN0cmluZyAoZm9yIGJ1aWx0LWluIGNvbXBvbmVudHMpIG9yIGEgY2xhc3MvZnVuY3Rpb24gKGZvciBjb21wb3NpdGUgY29tcG9uZW50cykgYnV0IGdvdDogJXMuJXMiLCB0eXBlU3RyaW5nLCBpbmZvKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgZWxlbWVudCA9IGpzeERFVih0eXBlLCBwcm9wcywga2V5LCBzb3VyY2UsIHNlbGYyKTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQgPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh2YWxpZFR5cGUpIHsKICAgICAgICAgICAgICB2YXIgY2hpbGRyZW4gPSBwcm9wcy5jaGlsZHJlbjsKICAgICAgICAgICAgICBpZiAoY2hpbGRyZW4gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaWYgKGlzU3RhdGljQ2hpbGRyZW4pIHsKICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkyKGNoaWxkcmVuKSkgewogICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlQ2hpbGRLZXlzKGNoaWxkcmVuW2ldLCB0eXBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5mcmVlemUpIHsKICAgICAgICAgICAgICAgICAgICAgIE9iamVjdC5mcmVlemUoY2hpbGRyZW4pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJvcigiUmVhY3QuanN4OiBTdGF0aWMgY2hpbGRyZW4gc2hvdWxkIGFsd2F5cyBiZSBhbiBhcnJheS4gWW91IGFyZSBsaWtlbHkgZXhwbGljaXRseSBjYWxsaW5nIFJlYWN0LmpzeHMgb3IgUmVhY3QuanN4REVWLiBVc2UgdGhlIEJhYmVsIHRyYW5zZm9ybSBpbnN0ZWFkLiIpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB2YWxpZGF0ZUNoaWxkS2V5cyhjaGlsZHJlbiwgdHlwZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChwcm9wcywgImtleSIpKSB7CiAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50TmFtZSA9IGdldENvbXBvbmVudE5hbWVGcm9tVHlwZSh0eXBlKTsKICAgICAgICAgICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMocHJvcHMpLmZpbHRlcihmdW5jdGlvbihrKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBrICE9PSAia2V5IjsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdmFyIGJlZm9yZUV4YW1wbGUgPSBrZXlzLmxlbmd0aCA+IDAgPyAie2tleTogc29tZUtleSwgIiArIGtleXMuam9pbigiOiAuLi4sICIpICsgIjogLi4ufSIgOiAie2tleTogc29tZUtleX0iOwogICAgICAgICAgICAgICAgaWYgKCFkaWRXYXJuQWJvdXRLZXlTcHJlYWRbY29tcG9uZW50TmFtZSArIGJlZm9yZUV4YW1wbGVdKSB7CiAgICAgICAgICAgICAgICAgIHZhciBhZnRlckV4YW1wbGUgPSBrZXlzLmxlbmd0aCA+IDAgPyAieyIgKyBrZXlzLmpvaW4oIjogLi4uLCAiKSArICI6IC4uLn0iIDogInt9IjsKICAgICAgICAgICAgICAgICAgZXJyb3IoJ0EgcHJvcHMgb2JqZWN0IGNvbnRhaW5pbmcgYSAia2V5IiBwcm9wIGlzIGJlaW5nIHNwcmVhZCBpbnRvIEpTWDpcbiAgbGV0IHByb3BzID0gJXM7XG4gIDwlcyB7Li4ucHJvcHN9IC8+XG5SZWFjdCBrZXlzIG11c3QgYmUgcGFzc2VkIGRpcmVjdGx5IHRvIEpTWCB3aXRob3V0IHVzaW5nIHNwcmVhZDpcbiAgbGV0IHByb3BzID0gJXM7XG4gIDwlcyBrZXk9e3NvbWVLZXl9IHsuLi5wcm9wc30gLz4nLCBiZWZvcmVFeGFtcGxlLCBjb21wb25lbnROYW1lLCBhZnRlckV4YW1wbGUsIGNvbXBvbmVudE5hbWUpOwogICAgICAgICAgICAgICAgICBkaWRXYXJuQWJvdXRLZXlTcHJlYWRbY29tcG9uZW50TmFtZSArIGJlZm9yZUV4YW1wbGVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGUgPT09IFJFQUNUX0ZSQUdNRU5UX1RZUEUpIHsKICAgICAgICAgICAgICB2YWxpZGF0ZUZyYWdtZW50UHJvcHMoZWxlbWVudCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdmFsaWRhdGVQcm9wVHlwZXMoZWxlbWVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIGpzeFdpdGhWYWxpZGF0aW9uU3RhdGljKHR5cGUsIHByb3BzLCBrZXkpIHsKICAgICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGpzeFdpdGhWYWxpZGF0aW9uKHR5cGUsIHByb3BzLCBrZXksIHRydWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmdW5jdGlvbiBqc3hXaXRoVmFsaWRhdGlvbkR5bmFtaWModHlwZSwgcHJvcHMsIGtleSkgewogICAgICAgICAgewogICAgICAgICAgICByZXR1cm4ganN4V2l0aFZhbGlkYXRpb24odHlwZSwgcHJvcHMsIGtleSwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB2YXIganN4NCA9IGpzeFdpdGhWYWxpZGF0aW9uRHluYW1pYzsKICAgICAgICB2YXIganN4czQgPSBqc3hXaXRoVmFsaWRhdGlvblN0YXRpYzsKICAgICAgICBleHBvcnRzLkZyYWdtZW50ID0gUkVBQ1RfRlJBR01FTlRfVFlQRTsKICAgICAgICBleHBvcnRzLmpzeCA9IGpzeDQ7CiAgICAgICAgZXhwb3J0cy5qc3hzID0ganN4czQ7CiAgICAgIH0pKCk7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0L2pzeC1ydW50aW1lLmpzCnZhciByZXF1aXJlX2pzeF9ydW50aW1lID0gX19jb21tb25KUyh7CiAgIm5vZGVfbW9kdWxlcy8ucG5wbS9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL3JlYWN0L2pzeC1ydW50aW1lLmpzIihleHBvcnRzLCBtb2R1bGUpIHsKICAgICJ1c2Ugc3RyaWN0IjsKICAgIGlmIChmYWxzZSkgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IG51bGw7CiAgICB9IGVsc2UgewogICAgICBtb2R1bGUuZXhwb3J0cyA9IHJlcXVpcmVfcmVhY3RfanN4X3J1bnRpbWVfZGV2ZWxvcG1lbnQoKTsKICAgIH0KICB9Cn0pOwoKLy8gc3JjL21haW4udHN4CnZhciBpbXBvcnRfcmVhY3Q1MyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpLCAxKTsKdmFyIGltcG9ydF9jbGllbnQgPSBfX3RvRVNNKHJlcXVpcmVfY2xpZW50KCksIDEpOwoKLy8gc3JjL015QnVkZ2V0LnRzeAp2YXIgaW1wb3J0X3JlYWN0NTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSwgMSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vY3JlYXRlTHVjaWRlSWNvbi5qcwp2YXIgaW1wb3J0X3JlYWN0MiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9zaGFyZWQvc3JjL3V0aWxzLmpzCnZhciB0b0tlYmFiQ2FzZSA9IChzdHJpbmcpID0+IHN0cmluZy5yZXBsYWNlKC8oW2EtejAtOV0pKFtBLVpdKS9nLCAiJDEtJDIiKS50b0xvd2VyQ2FzZSgpOwp2YXIgdG9DYW1lbENhc2UgPSAoc3RyaW5nKSA9PiBzdHJpbmcucmVwbGFjZSgKICAvXihbQS1aXSl8W1xzLV9dKyhcdykvZywKICAobWF0Y2gsIHAxLCBwMikgPT4gcDIgPyBwMi50b1VwcGVyQ2FzZSgpIDogcDEudG9Mb3dlckNhc2UoKQopOwp2YXIgdG9QYXNjYWxDYXNlID0gKHN0cmluZykgPT4gewogIGNvbnN0IGNhbWVsQ2FzZSA9IHRvQ2FtZWxDYXNlKHN0cmluZyk7CiAgcmV0dXJuIGNhbWVsQ2FzZS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIGNhbWVsQ2FzZS5zbGljZSgxKTsKfTsKdmFyIG1lcmdlQ2xhc3NlcyA9ICguLi5jbGFzc2VzKSA9PiBjbGFzc2VzLmZpbHRlcigoY2xhc3NOYW1lLCBpbmRleCwgYXJyYXkpID0+IHsKICByZXR1cm4gQm9vbGVhbihjbGFzc05hbWUpICYmIGNsYXNzTmFtZS50cmltKCkgIT09ICIiICYmIGFycmF5LmluZGV4T2YoY2xhc3NOYW1lKSA9PT0gaW5kZXg7Cn0pLmpvaW4oIiAiKS50cmltKCk7CnZhciBoYXNBMTF5UHJvcCA9IChwcm9wcykgPT4gewogIGZvciAoY29uc3QgcHJvcCBpbiBwcm9wcykgewogICAgaWYgKHByb3Auc3RhcnRzV2l0aCgiYXJpYS0iKSB8fCBwcm9wID09PSAicm9sZSIgfHwgcHJvcCA9PT0gInRpdGxlIikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vSWNvbi5qcwp2YXIgaW1wb3J0X3JlYWN0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2RlZmF1bHRBdHRyaWJ1dGVzLmpzCnZhciBkZWZhdWx0QXR0cmlidXRlcyA9IHsKICB4bWxuczogImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiwKICB3aWR0aDogMjQsCiAgaGVpZ2h0OiAyNCwKICB2aWV3Qm94OiAiMCAwIDI0IDI0IiwKICBmaWxsOiAibm9uZSIsCiAgc3Ryb2tlOiAiY3VycmVudENvbG9yIiwKICBzdHJva2VXaWR0aDogMiwKICBzdHJva2VMaW5lY2FwOiAicm91bmQiLAogIHN0cm9rZUxpbmVqb2luOiAicm91bmQiCn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vSWNvbi5qcwp2YXIgSWNvbiA9ICgwLCBpbXBvcnRfcmVhY3QuZm9yd2FyZFJlZikoCiAgKHsKICAgIGNvbG9yOiBjb2xvcjIgPSAiY3VycmVudENvbG9yIiwKICAgIHNpemUgPSAyNCwKICAgIHN0cm9rZVdpZHRoID0gMiwKICAgIGFic29sdXRlU3Ryb2tlV2lkdGgsCiAgICBjbGFzc05hbWUgPSAiIiwKICAgIGNoaWxkcmVuLAogICAgaWNvbk5vZGUsCiAgICAuLi5yZXN0CiAgfSwgcmVmKSA9PiAoMCwgaW1wb3J0X3JlYWN0LmNyZWF0ZUVsZW1lbnQpKAogICAgInN2ZyIsCiAgICB7CiAgICAgIHJlZiwKICAgICAgLi4uZGVmYXVsdEF0dHJpYnV0ZXMsCiAgICAgIHdpZHRoOiBzaXplLAogICAgICBoZWlnaHQ6IHNpemUsCiAgICAgIHN0cm9rZTogY29sb3IyLAogICAgICBzdHJva2VXaWR0aDogYWJzb2x1dGVTdHJva2VXaWR0aCA/IE51bWJlcihzdHJva2VXaWR0aCkgKiAyNCAvIE51bWJlcihzaXplKSA6IHN0cm9rZVdpZHRoLAogICAgICBjbGFzc05hbWU6IG1lcmdlQ2xhc3NlcygibHVjaWRlIiwgY2xhc3NOYW1lKSwKICAgICAgLi4uIWNoaWxkcmVuICYmICFoYXNBMTF5UHJvcChyZXN0KSAmJiB7ICJhcmlhLWhpZGRlbiI6ICJ0cnVlIiB9LAogICAgICAuLi5yZXN0CiAgICB9LAogICAgWwogICAgICAuLi5pY29uTm9kZS5tYXAoKFt0YWcsIGF0dHJzXSkgPT4gKDAsIGltcG9ydF9yZWFjdC5jcmVhdGVFbGVtZW50KSh0YWcsIGF0dHJzKSksCiAgICAgIC4uLkFycmF5LmlzQXJyYXkoY2hpbGRyZW4pID8gY2hpbGRyZW4gOiBbY2hpbGRyZW5dCiAgICBdCiAgKQopOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2NyZWF0ZUx1Y2lkZUljb24uanMKdmFyIGNyZWF0ZUx1Y2lkZUljb24gPSAoaWNvbk5hbWUsIGljb25Ob2RlKSA9PiB7CiAgY29uc3QgQ29tcG9uZW50ID0gKDAsIGltcG9ydF9yZWFjdDIuZm9yd2FyZFJlZikoCiAgICAoeyBjbGFzc05hbWUsIC4uLnByb3BzIH0sIHJlZikgPT4gKDAsIGltcG9ydF9yZWFjdDIuY3JlYXRlRWxlbWVudCkoSWNvbiwgewogICAgICByZWYsCiAgICAgIGljb25Ob2RlLAogICAgICBjbGFzc05hbWU6IG1lcmdlQ2xhc3NlcygKICAgICAgICBgbHVjaWRlLSR7dG9LZWJhYkNhc2UodG9QYXNjYWxDYXNlKGljb25OYW1lKSl9YCwKICAgICAgICBgbHVjaWRlLSR7aWNvbk5hbWV9YCwKICAgICAgICBjbGFzc05hbWUKICAgICAgKSwKICAgICAgLi4ucHJvcHMKICAgIH0pCiAgKTsKICBDb21wb25lbnQuZGlzcGxheU5hbWUgPSB0b1Bhc2NhbENhc2UoaWNvbk5hbWUpOwogIHJldHVybiBDb21wb25lbnQ7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYXJyb3ctdXAtcmlnaHQuanMKdmFyIF9faWNvbk5vZGUgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTcgN2gxMHYxMCIsIGtleTogIjF0aXZuOSIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTcgMTcgMTcgNyIsIGtleTogIjF2a2l6YSIgfV0KXTsKdmFyIEFycm93VXBSaWdodCA9IGNyZWF0ZUx1Y2lkZUljb24oImFycm93LXVwLXJpZ2h0IiwgX19pY29uTm9kZSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYnVpbGRpbmctMi5qcwp2YXIgX19pY29uTm9kZTIgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTEwIDEyaDQiLCBrZXk6ICJhNTZiMHAiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xMCA4aDQiLCBrZXk6ICIxc3IyYWYiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xNCAyMXYtM2EyIDIgMCAwIDAtNCAwdjMiLCBrZXk6ICIxcmdpZWkiIH1dLAogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk02IDEwSDRhMiAyIDAgMCAwLTIgMnY3YTIgMiAwIDAgMCAyIDJoMTZhMiAyIDAgMCAwIDItMlY5YTIgMiAwIDAgMC0yLTJoLTIiLAogICAgICBrZXk6ICJzZWNtaTIiCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNNiAyMVY1YTIgMiAwIDAgMSAyLTJoOGEyIDIgMCAwIDEgMiAydjE2Iiwga2V5OiAiMTZyYTB0IiB9XQpdOwp2YXIgQnVpbGRpbmcyID0gY3JlYXRlTHVjaWRlSWNvbigiYnVpbGRpbmctMiIsIF9faWNvbk5vZGUyKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGVjay5qcwp2YXIgX19pY29uTm9kZTMgPSBbWyJwYXRoIiwgeyBkOiAiTTIwIDYgOSAxN2wtNS01Iiwga2V5OiAiMWdtZjJjIiB9XV07CnZhciBDaGVjayA9IGNyZWF0ZUx1Y2lkZUljb24oImNoZWNrIiwgX19pY29uTm9kZTMpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2NoZXZyb24tZG93bi5qcwp2YXIgX19pY29uTm9kZTQgPSBbWyJwYXRoIiwgeyBkOiAibTYgOSA2IDYgNi02Iiwga2V5OiAicXJ1bnNsIiB9XV07CnZhciBDaGV2cm9uRG93biA9IGNyZWF0ZUx1Y2lkZUljb24oImNoZXZyb24tZG93biIsIF9faWNvbk5vZGU0KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGV2cm9uLXVwLmpzCnZhciBfX2ljb25Ob2RlNSA9IFtbInBhdGgiLCB7IGQ6ICJtMTggMTUtNi02LTYgNiIsIGtleTogIjE1M3VkeiIgfV1dOwp2YXIgQ2hldnJvblVwID0gY3JlYXRlTHVjaWRlSWNvbigiY2hldnJvbi11cCIsIF9faWNvbk5vZGU1KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaXJjbGUtYWxlcnQuanMKdmFyIF9faWNvbk5vZGU2ID0gWwogIFsiY2lyY2xlIiwgeyBjeDogIjEyIiwgY3k6ICIxMiIsIHI6ICIxMCIsIGtleTogIjFtZ2xheSIgfV0sCiAgWyJsaW5lIiwgeyB4MTogIjEyIiwgeDI6ICIxMiIsIHkxOiAiOCIsIHkyOiAiMTIiLCBrZXk6ICIxcGtldWgiIH1dLAogIFsibGluZSIsIHsgeDE6ICIxMiIsIHgyOiAiMTIuMDEiLCB5MTogIjE2IiwgeTI6ICIxNiIsIGtleTogIjRkZnE5MCIgfV0KXTsKdmFyIENpcmNsZUFsZXJ0ID0gY3JlYXRlTHVjaWRlSWNvbigiY2lyY2xlLWFsZXJ0IiwgX19pY29uTm9kZTYpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2NpcmNsZS1jaGVjay1iaWcuanMKdmFyIF9faWNvbk5vZGU3ID0gWwogIFsicGF0aCIsIHsgZDogIk0yMS44MDEgMTBBMTAgMTAgMCAxIDEgMTcgMy4zMzUiLCBrZXk6ICJ5cHMzY3QiIH1dLAogIFsicGF0aCIsIHsgZDogIm05IDExIDMgM0wyMiA0Iiwga2V5OiAiMXBmbHpsIiB9XQpdOwp2YXIgQ2lyY2xlQ2hlY2tCaWcgPSBjcmVhdGVMdWNpZGVJY29uKCJjaXJjbGUtY2hlY2stYmlnIiwgX19pY29uTm9kZTcpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2Nsb2NrLmpzCnZhciBfX2ljb25Ob2RlOCA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTIgNnY2bDQgMiIsIGtleTogIm1tazd5ZyIgfV0sCiAgWyJjaXJjbGUiLCB7IGN4OiAiMTIiLCBjeTogIjEyIiwgcjogIjEwIiwga2V5OiAiMW1nbGF5IiB9XQpdOwp2YXIgQ2xvY2sgPSBjcmVhdGVMdWNpZGVJY29uKCJjbG9jayIsIF9faWNvbk5vZGU4KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jbG91ZC11cGxvYWQuanMKdmFyIF9faWNvbk5vZGU5ID0gWwogIFsicGF0aCIsIHsgZDogIk0xMiAxM3Y4Iiwga2V5OiAiMWw1cHEwIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNNCAxNC44OTlBNyA3IDAgMSAxIDE1LjcxIDhoMS43OWE0LjUgNC41IDAgMCAxIDIuNSA4LjI0MiIsIGtleTogIjFwbGpudCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAibTggMTcgNC00IDQgNCIsIGtleTogIjFxdWFpMSIgfV0KXTsKdmFyIENsb3VkVXBsb2FkID0gY3JlYXRlTHVjaWRlSWNvbigiY2xvdWQtdXBsb2FkIiwgX19pY29uTm9kZTkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2RvbGxhci1zaWduLmpzCnZhciBfX2ljb25Ob2RlMTAgPSBbCiAgWyJsaW5lIiwgeyB4MTogIjEyIiwgeDI6ICIxMiIsIHkxOiAiMiIsIHkyOiAiMjIiLCBrZXk6ICI3ZXF5cWgiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xNyA1SDkuNWEzLjUgMy41IDAgMCAwIDAgN2g1YTMuNSAzLjUgMCAwIDEgMCA3SDYiLCBrZXk6ICIxYjBwNHMiIH1dCl07CnZhciBEb2xsYXJTaWduID0gY3JlYXRlTHVjaWRlSWNvbigiZG9sbGFyLXNpZ24iLCBfX2ljb25Ob2RlMTApOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2dyaXAtdmVydGljYWwuanMKdmFyIF9faWNvbk5vZGUxMSA9IFsKICBbImNpcmNsZSIsIHsgY3g6ICI5IiwgY3k6ICIxMiIsIHI6ICIxIiwga2V5OiAiMXZjdGdmIiB9XSwKICBbImNpcmNsZSIsIHsgY3g6ICI5IiwgY3k6ICI1IiwgcjogIjEiLCBrZXk6ICJocDB0Y2YiIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjkiLCBjeTogIjE5IiwgcjogIjEiLCBrZXk6ICJma2pqZjYiIH1dLAogIFsiY2lyY2xlIiwgeyBjeDogIjE1IiwgY3k6ICIxMiIsIHI6ICIxIiwga2V5OiAiMXRtYWlqIiB9XSwKICBbImNpcmNsZSIsIHsgY3g6ICIxNSIsIGN5OiAiNSIsIHI6ICIxIiwga2V5OiAiMTlsMjhlIiB9XSwKICBbImNpcmNsZSIsIHsgY3g6ICIxNSIsIGN5OiAiMTkiLCByOiAiMSIsIGtleTogImY0em9qMyIgfV0KXTsKdmFyIEdyaXBWZXJ0aWNhbCA9IGNyZWF0ZUx1Y2lkZUljb24oImdyaXAtdmVydGljYWwiLCBfX2ljb25Ob2RlMTEpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2hlYXJ0LmpzCnZhciBfX2ljb25Ob2RlMTIgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTIgOS41YTUuNSA1LjUgMCAwIDEgOS41OTEtMy42NzYuNTYuNTYgMCAwIDAgLjgxOCAwQTUuNDkgNS40OSAwIDAgMSAyMiA5LjVjMCAyLjI5LTEuNSA0LTMgNS41bC01LjQ5MiA1LjMxM2EyIDIgMCAwIDEtMyAuMDE5TDUgMTVjLTEuNS0xLjUtMy0zLjItMy01LjUiLAogICAgICBrZXk6ICJtdnIxYTAiCiAgICB9CiAgXQpdOwp2YXIgSGVhcnQgPSBjcmVhdGVMdWNpZGVJY29uKCJoZWFydCIsIF9faWNvbk5vZGUxMik7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvaG91c2UuanMKdmFyIF9faWNvbk5vZGUxMyA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTUgMjF2LThhMSAxIDAgMCAwLTEtMWgtNGExIDEgMCAwIDAtMSAxdjgiLCBrZXk6ICI1d3dscjUiIH1dLAogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0zIDEwYTIgMiAwIDAgMSAuNzA5LTEuNTI4bDctNmEyIDIgMCAwIDEgMi41ODIgMGw3IDZBMiAyIDAgMCAxIDIxIDEwdjlhMiAyIDAgMCAxLTIgMkg1YTIgMiAwIDAgMS0yLTJ6IiwKICAgICAga2V5OiAicjZuc3MxIgogICAgfQogIF0KXTsKdmFyIEhvdXNlID0gY3JlYXRlTHVjaWRlSWNvbigiaG91c2UiLCBfX2ljb25Ob2RlMTMpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2xhbmRtYXJrLmpzCnZhciBfX2ljb25Ob2RlMTQgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTEwIDE4di03Iiwga2V5OiAid3QxMTZiIiB9XSwKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMTEuMTIgMi4xOThhMiAyIDAgMCAxIDEuNzYuMDA2bDcuODY2IDMuODQ3Yy40NzYuMjMzLjMxLjk0OS0uMjIuOTQ5SDMuNDc0Yy0uNTMgMC0uNjk1LS43MTYtLjIyLS45NDl6IiwKICAgICAga2V5OiAiMW0zMjltIgogICAgfQogIF0sCiAgWyJwYXRoIiwgeyBkOiAiTTE0IDE4di03Iiwga2V5OiAidmF2NnQzIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTggMTh2LTciLCBrZXk6ICJhZXhkbWoiIH1dLAogIFsicGF0aCIsIHsgZDogIk0zIDIyaDE4Iiwga2V5OiAiOHBycjQ1IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNNiAxOHYtNyIsIGtleTogIjFpdmZsayIgfV0KXTsKdmFyIExhbmRtYXJrID0gY3JlYXRlTHVjaWRlSWNvbigibGFuZG1hcmsiLCBfX2ljb25Ob2RlMTQpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2xvYWRlci1jaXJjbGUuanMKdmFyIF9faWNvbk5vZGUxNSA9IFtbInBhdGgiLCB7IGQ6ICJNMjEgMTJhOSA5IDAgMSAxLTYuMjE5LTguNTYiLCBrZXk6ICIxM3phbGQiIH1dXTsKdmFyIExvYWRlckNpcmNsZSA9IGNyZWF0ZUx1Y2lkZUljb24oImxvYWRlci1jaXJjbGUiLCBfX2ljb25Ob2RlMTUpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2xvY2suanMKdmFyIF9faWNvbk5vZGUxNiA9IFsKICBbInJlY3QiLCB7IHdpZHRoOiAiMTgiLCBoZWlnaHQ6ICIxMSIsIHg6ICIzIiwgeTogIjExIiwgcng6ICIyIiwgcnk6ICIyIiwga2V5OiAiMXc0ZXcxIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNNyAxMVY3YTUgNSAwIDAgMSAxMCAwdjQiLCBrZXk6ICJmd3Ztem0iIH1dCl07CnZhciBMb2NrID0gY3JlYXRlTHVjaWRlSWNvbigibG9jayIsIF9faWNvbk5vZGUxNik7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbG9nLW91dC5qcwp2YXIgX19pY29uTm9kZTE3ID0gWwogIFsicGF0aCIsIHsgZDogIm0xNiAxNyA1LTUtNS01Iiwga2V5OiAiMWJqaTJoIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMjEgMTJIOSIsIGtleTogImRuMW05MiIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTkgMjFINWEyIDIgMCAwIDEtMi0yVjVhMiAyIDAgMCAxIDItMmg0Iiwga2V5OiAiMXVmM3JzIiB9XQpdOwp2YXIgTG9nT3V0ID0gY3JlYXRlTHVjaWRlSWNvbigibG9nLW91dCIsIF9faWNvbk5vZGUxNyk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbWFpbC5qcwp2YXIgX19pY29uTm9kZTE4ID0gWwogIFsicGF0aCIsIHsgZDogIm0yMiA3LTguOTkxIDUuNzI3YTIgMiAwIDAgMS0yLjAwOSAwTDIgNyIsIGtleTogIjEzMnE3cSIgfV0sCiAgWyJyZWN0IiwgeyB4OiAiMiIsIHk6ICI0Iiwgd2lkdGg6ICIyMCIsIGhlaWdodDogIjE2Iiwgcng6ICIyIiwga2V5OiAiaXp4bGFvIiB9XQpdOwp2YXIgTWFpbCA9IGNyZWF0ZUx1Y2lkZUljb24oIm1haWwiLCBfX2ljb25Ob2RlMTgpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL21lc3NhZ2Utc3F1YXJlLmpzCnZhciBfX2ljb25Ob2RlMTkgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTIyIDE3YTIgMiAwIDAgMS0yIDJINi44MjhhMiAyIDAgMCAwLTEuNDE0LjU4NmwtMi4yMDIgMi4yMDJBLjcxLjcxIDAgMCAxIDIgMjEuMjg2VjVhMiAyIDAgMCAxIDItMmgxNmEyIDIgMCAwIDEgMiAyeiIsCiAgICAgIGtleTogIjE4ODg3cCIKICAgIH0KICBdCl07CnZhciBNZXNzYWdlU3F1YXJlID0gY3JlYXRlTHVjaWRlSWNvbigibWVzc2FnZS1zcXVhcmUiLCBfX2ljb25Ob2RlMTkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3Blbi5qcwp2YXIgX19pY29uTm9kZTIwID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0yMS4xNzQgNi44MTJhMSAxIDAgMCAwLTMuOTg2LTMuOTg3TDMuODQyIDE2LjE3NGEyIDIgMCAwIDAtLjUuODNsLTEuMzIxIDQuMzUyYS41LjUgMCAwIDAgLjYyMy42MjJsNC4zNTMtMS4zMmEyIDIgMCAwIDAgLjgzLS40OTd6IiwKICAgICAga2V5OiAiMWE4dXN1IgogICAgfQogIF0KXTsKdmFyIFBlbiA9IGNyZWF0ZUx1Y2lkZUljb24oInBlbiIsIF9faWNvbk5vZGUyMCk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcGlnZ3ktYmFuay5qcwp2YXIgX19pY29uTm9kZTIxID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0xMSAxN2gzdjJhMSAxIDAgMCAwIDEgMWgyYTEgMSAwIDAgMCAxLTF2LTNhMy4xNiAzLjE2IDAgMCAwIDItMmgxYTEgMSAwIDAgMCAxLTF2LTJhMSAxIDAgMCAwLTEtMWgtMWE1IDUgMCAwIDAtMi00VjNhNCA0IDAgMCAwLTMuMiAxLjZsLS4zLjRIMTFhNiA2IDAgMCAwLTYgNnYxYTUgNSAwIDAgMCAyIDR2M2ExIDEgMCAwIDAgMSAxaDJhMSAxIDAgMCAwIDEtMXoiLAogICAgICBrZXk6ICIxcGlnbGMiCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNMTYgMTBoLjAxIiwga2V5OiAiMW05NHd6IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMiA4djFhMiAyIDAgMCAwIDIgMmgxIiwga2V5OiAiMWVudjQzIiB9XQpdOwp2YXIgUGlnZ3lCYW5rID0gY3JlYXRlTHVjaWRlSWNvbigicGlnZ3ktYmFuayIsIF9faWNvbk5vZGUyMSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcGx1cy5qcwp2YXIgX19pY29uTm9kZTIyID0gWwogIFsicGF0aCIsIHsgZDogIk01IDEyaDE0Iiwga2V5OiAiMWF5czBoIiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTIgNXYxNCIsIGtleTogInM2OTlsZSIgfV0KXTsKdmFyIFBsdXMgPSBjcmVhdGVMdWNpZGVJY29uKCJwbHVzIiwgX19pY29uTm9kZTIyKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wcmludGVyLmpzCnZhciBfX2ljb25Ob2RlMjMgPSBbCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTYgMThINGEyIDIgMCAwIDEtMi0ydi01YTIgMiAwIDAgMSAyLTJoMTZhMiAyIDAgMCAxIDIgMnY1YTIgMiAwIDAgMS0yIDJoLTIiLAogICAgICBrZXk6ICIxNDN3eWQiCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNNiA5VjNhMSAxIDAgMCAxIDEtMWgxMGExIDEgMCAwIDEgMSAxdjYiLCBrZXk6ICIxaXRuZTciIH1dLAogIFsicmVjdCIsIHsgeDogIjYiLCB5OiAiMTQiLCB3aWR0aDogIjEyIiwgaGVpZ2h0OiAiOCIsIHJ4OiAiMSIsIGtleTogIjF1ZTB0ZyIgfV0KXTsKdmFyIFByaW50ZXIgPSBjcmVhdGVMdWNpZGVJY29uKCJwcmludGVyIiwgX19pY29uTm9kZTIzKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9yZWZyZXNoLWN3LmpzCnZhciBfX2ljb25Ob2RlMjQgPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTMgMTJhOSA5IDAgMCAxIDktOSA5Ljc1IDkuNzUgMCAwIDEgNi43NCAyLjc0TDIxIDgiLCBrZXk6ICJ2OWg1dmMiIH1dLAogIFsicGF0aCIsIHsgZDogIk0yMSAzdjVoLTUiLCBrZXk6ICIxcTd0bzAiIH1dLAogIFsicGF0aCIsIHsgZDogIk0yMSAxMmE5IDkgMCAwIDEtOSA5IDkuNzUgOS43NSAwIDAgMS02Ljc0LTIuNzRMMyAxNiIsIGtleTogIjN1aWZsMyIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTggMTZIM3Y1Iiwga2V5OiAiMWN2Njc4IiB9XQpdOwp2YXIgUmVmcmVzaEN3ID0gY3JlYXRlTHVjaWRlSWNvbigicmVmcmVzaC1jdyIsIF9faWNvbk5vZGUyNCk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcm90YXRlLWNjdy5qcwp2YXIgX19pY29uTm9kZTI1ID0gWwogIFsicGF0aCIsIHsgZDogIk0zIDEyYTkgOSAwIDEgMCA5LTkgOS43NSA5Ljc1IDAgMCAwLTYuNzQgMi43NEwzIDgiLCBrZXk6ICIxMzU3ZTMiIH1dLAogIFsicGF0aCIsIHsgZDogIk0zIDN2NWg1Iiwga2V5OiAiMXhocThhIiB9XQpdOwp2YXIgUm90YXRlQ2N3ID0gY3JlYXRlTHVjaWRlSWNvbigicm90YXRlLWNjdyIsIF9faWNvbk5vZGUyNSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvc2F2ZS5qcwp2YXIgX19pY29uTm9kZTI2ID0gWwogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk0xNS4yIDNhMiAyIDAgMCAxIDEuNC42bDMuOCAzLjhhMiAyIDAgMCAxIC42IDEuNFYxOWEyIDIgMCAwIDEtMiAySDVhMiAyIDAgMCAxLTItMlY1YTIgMiAwIDAgMSAyLTJ6IiwKICAgICAga2V5OiAiMWM4NDc2IgogICAgfQogIF0sCiAgWyJwYXRoIiwgeyBkOiAiTTE3IDIxdi03YTEgMSAwIDAgMC0xLTFIOGExIDEgMCAwIDAtMSAxdjciLCBrZXk6ICIxeWR0b3MiIH1dLAogIFsicGF0aCIsIHsgZDogIk03IDN2NGExIDEgMCAwIDAgMSAxaDciLCBrZXk6ICJ0NTF1NzMiIH1dCl07CnZhciBTYXZlID0gY3JlYXRlTHVjaWRlSWNvbigic2F2ZSIsIF9faWNvbk5vZGUyNik7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvc2VhcmNoLmpzCnZhciBfX2ljb25Ob2RlMjcgPSBbCiAgWyJwYXRoIiwgeyBkOiAibTIxIDIxLTQuMzQtNC4zNCIsIGtleTogIjE0ajdyaiIgfV0sCiAgWyJjaXJjbGUiLCB7IGN4OiAiMTEiLCBjeTogIjExIiwgcjogIjgiLCBrZXk6ICI0ZWo5N3UiIH1dCl07CnZhciBTZWFyY2ggPSBjcmVhdGVMdWNpZGVJY29uKCJzZWFyY2giLCBfX2ljb25Ob2RlMjcpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RodW1icy1kb3duLmpzCnZhciBfX2ljb25Ob2RlMjggPSBbCiAgWyJwYXRoIiwgeyBkOiAiTTE3IDE0VjIiLCBrZXk6ICI4eW1xbmsiIH1dLAogIFsKICAgICJwYXRoIiwKICAgIHsKICAgICAgZDogIk05IDE4LjEyIDEwIDE0SDQuMTdhMiAyIDAgMCAxLTEuOTItMi41NmwyLjMzLThBMiAyIDAgMCAxIDYuNSAySDIwYTIgMiAwIDAgMSAyIDJ2OGEyIDIgMCAwIDEtMiAyaC0yLjc2YTIgMiAwIDAgMC0xLjc5IDEuMTFMMTIgMjJhMy4xMyAzLjEzIDAgMCAxLTMtMy44OFoiLAogICAgICBrZXk6ICJtNjFtNzciCiAgICB9CiAgXQpdOwp2YXIgVGh1bWJzRG93biA9IGNyZWF0ZUx1Y2lkZUljb24oInRodW1icy1kb3duIiwgX19pY29uTm9kZTI4KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90aHVtYnMtdXAuanMKdmFyIF9faWNvbk5vZGUyOSA9IFsKICBbInBhdGgiLCB7IGQ6ICJNNyAxMHYxMiIsIGtleTogIjFxYzkzbiIgfV0sCiAgWwogICAgInBhdGgiLAogICAgewogICAgICBkOiAiTTE1IDUuODggMTQgMTBoNS44M2EyIDIgMCAwIDEgMS45MiAyLjU2bC0yLjMzIDhBMiAyIDAgMCAxIDE3LjUgMjJINGEyIDIgMCAwIDEtMi0ydi04YTIgMiAwIDAgMSAyLTJoMi43NmEyIDIgMCAwIDAgMS43OS0xLjExTDEyIDJhMy4xMyAzLjEzIDAgMCAxIDMgMy44OFoiLAogICAgICBrZXk6ICJlbW1tY3IiCiAgICB9CiAgXQpdOwp2YXIgVGh1bWJzVXAgPSBjcmVhdGVMdWNpZGVJY29uKCJ0aHVtYnMtdXAiLCBfX2ljb25Ob2RlMjkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RyYXNoLTIuanMKdmFyIF9faWNvbk5vZGUzMCA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTAgMTF2NiIsIGtleTogIm5jbzBvbSIgfV0sCiAgWyJwYXRoIiwgeyBkOiAiTTE0IDExdjYiLCBrZXk6ICJvdXR2MXUiIH1dLAogIFsicGF0aCIsIHsgZDogIk0xOSA2djE0YTIgMiAwIDAgMS0yIDJIN2EyIDIgMCAwIDEtMi0yVjYiLCBrZXk6ICJtaXl0cmMiIH1dLAogIFsicGF0aCIsIHsgZDogIk0zIDZoMTgiLCBrZXk6ICJkMHdtMGoiIH1dLAogIFsicGF0aCIsIHsgZDogIk04IDZWNGEyIDIgMCAwIDEgMi0yaDRhMiAyIDAgMCAxIDIgMnYyIiwga2V5OiAiZTc5MWppIiB9XQpdOwp2YXIgVHJhc2gyID0gY3JlYXRlTHVjaWRlSWNvbigidHJhc2gtMiIsIF9faWNvbk5vZGUzMCk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdHJlbmRpbmctZG93bi5qcwp2YXIgX19pY29uTm9kZTMxID0gWwogIFsicGF0aCIsIHsgZDogIk0xNiAxN2g2di02Iiwga2V5OiAidDZuMml0IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJtMjIgMTctOC41LTguNS01IDVMMiA3Iiwga2V5OiAieDQ3M3AiIH1dCl07CnZhciBUcmVuZGluZ0Rvd24gPSBjcmVhdGVMdWNpZGVJY29uKCJ0cmVuZGluZy1kb3duIiwgX19pY29uTm9kZTMxKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90cmVuZGluZy11cC5qcwp2YXIgX19pY29uTm9kZTMyID0gWwogIFsicGF0aCIsIHsgZDogIk0xNiA3aDZ2NiIsIGtleTogImJveDU1bCIgfV0sCiAgWyJwYXRoIiwgeyBkOiAibTIyIDctOC41IDguNS01LTVMMiAxNyIsIGtleTogIjF0MW03OSIgfV0KXTsKdmFyIFRyZW5kaW5nVXAgPSBjcmVhdGVMdWNpZGVJY29uKCJ0cmVuZGluZy11cCIsIF9faWNvbk5vZGUzMik7CgovLyBub2RlX21vZHVsZXMvLnBucG0vbHVjaWRlLXJlYWN0QDAuNTU0LjBfcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9sdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdHJpYW5nbGUtYWxlcnQuanMKdmFyIF9faWNvbk5vZGUzMyA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJtMjEuNzMgMTgtOC0xNGEyIDIgMCAwIDAtMy40OCAwbC04IDE0QTIgMiAwIDAgMCA0IDIxaDE2YTIgMiAwIDAgMCAxLjczLTMiLAogICAgICBrZXk6ICJ3bW9lbnEiCiAgICB9CiAgXSwKICBbInBhdGgiLCB7IGQ6ICJNMTIgOXY0Iiwga2V5OiAianV6cHU3IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJNMTIgMTdoLjAxIiwga2V5OiAicDMycDA1IiB9XQpdOwp2YXIgVHJpYW5nbGVBbGVydCA9IGNyZWF0ZUx1Y2lkZUljb24oInRyaWFuZ2xlLWFsZXJ0IiwgX19pY29uTm9kZTMzKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9sdWNpZGUtcmVhY3RAMC41NTQuMF9yZWFjdEAxOC4zLjEvbm9kZV9tb2R1bGVzL2x1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy93YWxsZXQuanMKdmFyIF9faWNvbk5vZGUzNCA9IFsKICBbCiAgICAicGF0aCIsCiAgICB7CiAgICAgIGQ6ICJNMTkgN1Y0YTEgMSAwIDAgMC0xLTFINWEyIDIgMCAwIDAgMCA0aDE1YTEgMSAwIDAgMSAxIDF2NGgtM2EyIDIgMCAwIDAgMCA0aDNhMSAxIDAgMCAwIDEtMXYtMmExIDEgMCAwIDAtMS0xIiwKICAgICAga2V5OiAiMThldGI2IgogICAgfQogIF0sCiAgWyJwYXRoIiwgeyBkOiAiTTMgNXYxNGEyIDIgMCAwIDAgMiAyaDE1YTEgMSAwIDAgMCAxLTF2LTQiLCBrZXk6ICJ4b2MwcTQiIH1dCl07CnZhciBXYWxsZXQgPSBjcmVhdGVMdWNpZGVJY29uKCJ3YWxsZXQiLCBfX2ljb25Ob2RlMzQpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2x1Y2lkZS1yZWFjdEAwLjU1NC4wX3JlYWN0QDE4LjMuMS9ub2RlX21vZHVsZXMvbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3guanMKdmFyIF9faWNvbk5vZGUzNSA9IFsKICBbInBhdGgiLCB7IGQ6ICJNMTggNiA2IDE4Iiwga2V5OiAiMWJsNWY4IiB9XSwKICBbInBhdGgiLCB7IGQ6ICJtNiA2IDEyIDEyIiwga2V5OiAiZDhiazZ2IiB9XQpdOwp2YXIgWCA9IGNyZWF0ZUx1Y2lkZUljb24oIngiLCBfX2ljb25Ob2RlMzUpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL1N1cmZhY2UuanMKdmFyIFJlYWN0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9jbHN4QDIuMS4xL25vZGVfbW9kdWxlcy9jbHN4L2Rpc3QvY2xzeC5tanMKZnVuY3Rpb24gcihlKSB7CiAgdmFyIHQsIGYsIG4gPSAiIjsKICBpZiAoInN0cmluZyIgPT0gdHlwZW9mIGUgfHwgIm51bWJlciIgPT0gdHlwZW9mIGUpIG4gKz0gZTsKICBlbHNlIGlmICgib2JqZWN0IiA9PSB0eXBlb2YgZSkgaWYgKEFycmF5LmlzQXJyYXkoZSkpIHsKICAgIHZhciBvID0gZS5sZW5ndGg7CiAgICBmb3IgKHQgPSAwOyB0IDwgbzsgdCsrKSBlW3RdICYmIChmID0gcihlW3RdKSkgJiYgKG4gJiYgKG4gKz0gIiAiKSwgbiArPSBmKTsKICB9IGVsc2UgZm9yIChmIGluIGUpIGVbZl0gJiYgKG4gJiYgKG4gKz0gIiAiKSwgbiArPSBmKTsKICByZXR1cm4gbjsKfQpmdW5jdGlvbiBjbHN4KCkgewogIGZvciAodmFyIGUsIHQsIGYgPSAwLCBuID0gIiIsIG8gPSBhcmd1bWVudHMubGVuZ3RoOyBmIDwgbzsgZisrKSAoZSA9IGFyZ3VtZW50c1tmXSkgJiYgKHQgPSByKGUpKSAmJiAobiAmJiAobiArPSAiICIpLCBuICs9IHQpOwogIHJldHVybiBuOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3N2Z1Byb3BlcnRpZXNBbmRFdmVudHMuanMKdmFyIGltcG9ydF9yZWFjdDQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2V4Y2x1ZGVFdmVudFByb3BzLmpzCnZhciBFdmVudEtleXMgPSBbImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwgIm9uQ29weSIsICJvbkNvcHlDYXB0dXJlIiwgIm9uQ3V0IiwgIm9uQ3V0Q2FwdHVyZSIsICJvblBhc3RlIiwgIm9uUGFzdGVDYXB0dXJlIiwgIm9uQ29tcG9zaXRpb25FbmQiLCAib25Db21wb3NpdGlvbkVuZENhcHR1cmUiLCAib25Db21wb3NpdGlvblN0YXJ0IiwgIm9uQ29tcG9zaXRpb25TdGFydENhcHR1cmUiLCAib25Db21wb3NpdGlvblVwZGF0ZSIsICJvbkNvbXBvc2l0aW9uVXBkYXRlQ2FwdHVyZSIsICJvbkZvY3VzIiwgIm9uRm9jdXNDYXB0dXJlIiwgIm9uQmx1ciIsICJvbkJsdXJDYXB0dXJlIiwgIm9uQ2hhbmdlIiwgIm9uQ2hhbmdlQ2FwdHVyZSIsICJvbkJlZm9yZUlucHV0IiwgIm9uQmVmb3JlSW5wdXRDYXB0dXJlIiwgIm9uSW5wdXQiLCAib25JbnB1dENhcHR1cmUiLCAib25SZXNldCIsICJvblJlc2V0Q2FwdHVyZSIsICJvblN1Ym1pdCIsICJvblN1Ym1pdENhcHR1cmUiLCAib25JbnZhbGlkIiwgIm9uSW52YWxpZENhcHR1cmUiLCAib25Mb2FkIiwgIm9uTG9hZENhcHR1cmUiLCAib25FcnJvciIsICJvbkVycm9yQ2FwdHVyZSIsICJvbktleURvd24iLCAib25LZXlEb3duQ2FwdHVyZSIsICJvbktleVByZXNzIiwgIm9uS2V5UHJlc3NDYXB0dXJlIiwgIm9uS2V5VXAiLCAib25LZXlVcENhcHR1cmUiLCAib25BYm9ydCIsICJvbkFib3J0Q2FwdHVyZSIsICJvbkNhblBsYXkiLCAib25DYW5QbGF5Q2FwdHVyZSIsICJvbkNhblBsYXlUaHJvdWdoIiwgIm9uQ2FuUGxheVRocm91Z2hDYXB0dXJlIiwgIm9uRHVyYXRpb25DaGFuZ2UiLCAib25EdXJhdGlvbkNoYW5nZUNhcHR1cmUiLCAib25FbXB0aWVkIiwgIm9uRW1wdGllZENhcHR1cmUiLCAib25FbmNyeXB0ZWQiLCAib25FbmNyeXB0ZWRDYXB0dXJlIiwgIm9uRW5kZWQiLCAib25FbmRlZENhcHR1cmUiLCAib25Mb2FkZWREYXRhIiwgIm9uTG9hZGVkRGF0YUNhcHR1cmUiLCAib25Mb2FkZWRNZXRhZGF0YSIsICJvbkxvYWRlZE1ldGFkYXRhQ2FwdHVyZSIsICJvbkxvYWRTdGFydCIsICJvbkxvYWRTdGFydENhcHR1cmUiLCAib25QYXVzZSIsICJvblBhdXNlQ2FwdHVyZSIsICJvblBsYXkiLCAib25QbGF5Q2FwdHVyZSIsICJvblBsYXlpbmciLCAib25QbGF5aW5nQ2FwdHVyZSIsICJvblByb2dyZXNzIiwgIm9uUHJvZ3Jlc3NDYXB0dXJlIiwgIm9uUmF0ZUNoYW5nZSIsICJvblJhdGVDaGFuZ2VDYXB0dXJlIiwgIm9uU2Vla2VkIiwgIm9uU2Vla2VkQ2FwdHVyZSIsICJvblNlZWtpbmciLCAib25TZWVraW5nQ2FwdHVyZSIsICJvblN0YWxsZWQiLCAib25TdGFsbGVkQ2FwdHVyZSIsICJvblN1c3BlbmQiLCAib25TdXNwZW5kQ2FwdHVyZSIsICJvblRpbWVVcGRhdGUiLCAib25UaW1lVXBkYXRlQ2FwdHVyZSIsICJvblZvbHVtZUNoYW5nZSIsICJvblZvbHVtZUNoYW5nZUNhcHR1cmUiLCAib25XYWl0aW5nIiwgIm9uV2FpdGluZ0NhcHR1cmUiLCAib25BdXhDbGljayIsICJvbkF1eENsaWNrQ2FwdHVyZSIsICJvbkNsaWNrIiwgIm9uQ2xpY2tDYXB0dXJlIiwgIm9uQ29udGV4dE1lbnUiLCAib25Db250ZXh0TWVudUNhcHR1cmUiLCAib25Eb3VibGVDbGljayIsICJvbkRvdWJsZUNsaWNrQ2FwdHVyZSIsICJvbkRyYWciLCAib25EcmFnQ2FwdHVyZSIsICJvbkRyYWdFbmQiLCAib25EcmFnRW5kQ2FwdHVyZSIsICJvbkRyYWdFbnRlciIsICJvbkRyYWdFbnRlckNhcHR1cmUiLCAib25EcmFnRXhpdCIsICJvbkRyYWdFeGl0Q2FwdHVyZSIsICJvbkRyYWdMZWF2ZSIsICJvbkRyYWdMZWF2ZUNhcHR1cmUiLCAib25EcmFnT3ZlciIsICJvbkRyYWdPdmVyQ2FwdHVyZSIsICJvbkRyYWdTdGFydCIsICJvbkRyYWdTdGFydENhcHR1cmUiLCAib25Ecm9wIiwgIm9uRHJvcENhcHR1cmUiLCAib25Nb3VzZURvd24iLCAib25Nb3VzZURvd25DYXB0dXJlIiwgIm9uTW91c2VFbnRlciIsICJvbk1vdXNlTGVhdmUiLCAib25Nb3VzZU1vdmUiLCAib25Nb3VzZU1vdmVDYXB0dXJlIiwgIm9uTW91c2VPdXQiLCAib25Nb3VzZU91dENhcHR1cmUiLCAib25Nb3VzZU92ZXIiLCAib25Nb3VzZU92ZXJDYXB0dXJlIiwgIm9uTW91c2VVcCIsICJvbk1vdXNlVXBDYXB0dXJlIiwgIm9uU2VsZWN0IiwgIm9uU2VsZWN0Q2FwdHVyZSIsICJvblRvdWNoQ2FuY2VsIiwgIm9uVG91Y2hDYW5jZWxDYXB0dXJlIiwgIm9uVG91Y2hFbmQiLCAib25Ub3VjaEVuZENhcHR1cmUiLCAib25Ub3VjaE1vdmUiLCAib25Ub3VjaE1vdmVDYXB0dXJlIiwgIm9uVG91Y2hTdGFydCIsICJvblRvdWNoU3RhcnRDYXB0dXJlIiwgIm9uUG9pbnRlckRvd24iLCAib25Qb2ludGVyRG93bkNhcHR1cmUiLCAib25Qb2ludGVyTW92ZSIsICJvblBvaW50ZXJNb3ZlQ2FwdHVyZSIsICJvblBvaW50ZXJVcCIsICJvblBvaW50ZXJVcENhcHR1cmUiLCAib25Qb2ludGVyQ2FuY2VsIiwgIm9uUG9pbnRlckNhbmNlbENhcHR1cmUiLCAib25Qb2ludGVyRW50ZXIiLCAib25Qb2ludGVyRW50ZXJDYXB0dXJlIiwgIm9uUG9pbnRlckxlYXZlIiwgIm9uUG9pbnRlckxlYXZlQ2FwdHVyZSIsICJvblBvaW50ZXJPdmVyIiwgIm9uUG9pbnRlck92ZXJDYXB0dXJlIiwgIm9uUG9pbnRlck91dCIsICJvblBvaW50ZXJPdXRDYXB0dXJlIiwgIm9uR290UG9pbnRlckNhcHR1cmUiLCAib25Hb3RQb2ludGVyQ2FwdHVyZUNhcHR1cmUiLCAib25Mb3N0UG9pbnRlckNhcHR1cmUiLCAib25Mb3N0UG9pbnRlckNhcHR1cmVDYXB0dXJlIiwgIm9uU2Nyb2xsIiwgIm9uU2Nyb2xsQ2FwdHVyZSIsICJvbldoZWVsIiwgIm9uV2hlZWxDYXB0dXJlIiwgIm9uQW5pbWF0aW9uU3RhcnQiLCAib25BbmltYXRpb25TdGFydENhcHR1cmUiLCAib25BbmltYXRpb25FbmQiLCAib25BbmltYXRpb25FbmRDYXB0dXJlIiwgIm9uQW5pbWF0aW9uSXRlcmF0aW9uIiwgIm9uQW5pbWF0aW9uSXRlcmF0aW9uQ2FwdHVyZSIsICJvblRyYW5zaXRpb25FbmQiLCAib25UcmFuc2l0aW9uRW5kQ2FwdHVyZSJdOwpmdW5jdGlvbiBpc0V2ZW50S2V5KGtleSkgewogIGlmICh0eXBlb2Yga2V5ICE9PSAic3RyaW5nIikgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICB2YXIgYWxsb3dlZEV2ZW50S2V5cyA9IEV2ZW50S2V5czsKICByZXR1cm4gYWxsb3dlZEV2ZW50S2V5cy5pbmNsdWRlcyhrZXkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3N2Z1Byb3BlcnRpZXNOb0V2ZW50cy5qcwp2YXIgaW1wb3J0X3JlYWN0MyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIFNWR0VsZW1lbnRQcm9wS2V5cyA9IFsKICAiYXJpYS1hY3RpdmVkZXNjZW5kYW50IiwKICAiYXJpYS1hdG9taWMiLAogICJhcmlhLWF1dG9jb21wbGV0ZSIsCiAgImFyaWEtYnVzeSIsCiAgImFyaWEtY2hlY2tlZCIsCiAgImFyaWEtY29sY291bnQiLAogICJhcmlhLWNvbGluZGV4IiwKICAiYXJpYS1jb2xzcGFuIiwKICAiYXJpYS1jb250cm9scyIsCiAgImFyaWEtY3VycmVudCIsCiAgImFyaWEtZGVzY3JpYmVkYnkiLAogICJhcmlhLWRldGFpbHMiLAogICJhcmlhLWRpc2FibGVkIiwKICAiYXJpYS1lcnJvcm1lc3NhZ2UiLAogICJhcmlhLWV4cGFuZGVkIiwKICAiYXJpYS1mbG93dG8iLAogICJhcmlhLWhhc3BvcHVwIiwKICAiYXJpYS1oaWRkZW4iLAogICJhcmlhLWludmFsaWQiLAogICJhcmlhLWtleXNob3J0Y3V0cyIsCiAgImFyaWEtbGFiZWwiLAogICJhcmlhLWxhYmVsbGVkYnkiLAogICJhcmlhLWxldmVsIiwKICAiYXJpYS1saXZlIiwKICAiYXJpYS1tb2RhbCIsCiAgImFyaWEtbXVsdGlsaW5lIiwKICAiYXJpYS1tdWx0aXNlbGVjdGFibGUiLAogICJhcmlhLW9yaWVudGF0aW9uIiwKICAiYXJpYS1vd25zIiwKICAiYXJpYS1wbGFjZWhvbGRlciIsCiAgImFyaWEtcG9zaW5zZXQiLAogICJhcmlhLXByZXNzZWQiLAogICJhcmlhLXJlYWRvbmx5IiwKICAiYXJpYS1yZWxldmFudCIsCiAgImFyaWEtcmVxdWlyZWQiLAogICJhcmlhLXJvbGVkZXNjcmlwdGlvbiIsCiAgImFyaWEtcm93Y291bnQiLAogICJhcmlhLXJvd2luZGV4IiwKICAiYXJpYS1yb3dzcGFuIiwKICAiYXJpYS1zZWxlY3RlZCIsCiAgImFyaWEtc2V0c2l6ZSIsCiAgImFyaWEtc29ydCIsCiAgImFyaWEtdmFsdWVtYXgiLAogICJhcmlhLXZhbHVlbWluIiwKICAiYXJpYS12YWx1ZW5vdyIsCiAgImFyaWEtdmFsdWV0ZXh0IiwKICAiY2xhc3NOYW1lIiwKICAiY29sb3IiLAogICJoZWlnaHQiLAogICJpZCIsCiAgImxhbmciLAogICJtYXgiLAogICJtZWRpYSIsCiAgIm1ldGhvZCIsCiAgIm1pbiIsCiAgIm5hbWUiLAogICJzdHlsZSIsCiAgLyoKICAgKiByZW1vdmVkICd0eXBlJyBTVkdFbGVtZW50UHJvcEtleSBiZWNhdXNlIHdlIGRvIG5vdCBjdXJyZW50bHkgdXNlIGFueSBTVkcgZWxlbWVudHMKICAgKiB0aGF0IGNhbiB1c2UgaXQsIGFuZCBpdCBjb25mbGljdHMgd2l0aCB0aGUgcmVjaGFydHMgcHJvcCAndHlwZScKICAgKiBodHRwczovL2dpdGh1Yi5jb20vcmVjaGFydHMvcmVjaGFydHMvcHVsbC8zMzI3CiAgICogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvU1ZHL0F0dHJpYnV0ZS90eXBlCiAgICovCiAgLy8gJ3R5cGUnLAogICJ0YXJnZXQiLAogICJ3aWR0aCIsCiAgInJvbGUiLAogICJ0YWJJbmRleCIsCiAgImFjY2VudEhlaWdodCIsCiAgImFjY3VtdWxhdGUiLAogICJhZGRpdGl2ZSIsCiAgImFsaWdubWVudEJhc2VsaW5lIiwKICAiYWxsb3dSZW9yZGVyIiwKICAiYWxwaGFiZXRpYyIsCiAgImFtcGxpdHVkZSIsCiAgImFyYWJpY0Zvcm0iLAogICJhc2NlbnQiLAogICJhdHRyaWJ1dGVOYW1lIiwKICAiYXR0cmlidXRlVHlwZSIsCiAgImF1dG9SZXZlcnNlIiwKICAiYXppbXV0aCIsCiAgImJhc2VGcmVxdWVuY3kiLAogICJiYXNlbGluZVNoaWZ0IiwKICAiYmFzZVByb2ZpbGUiLAogICJiYm94IiwKICAiYmVnaW4iLAogICJiaWFzIiwKICAiYnkiLAogICJjYWxjTW9kZSIsCiAgImNhcEhlaWdodCIsCiAgImNsaXAiLAogICJjbGlwUGF0aCIsCiAgImNsaXBQYXRoVW5pdHMiLAogICJjbGlwUnVsZSIsCiAgImNvbG9ySW50ZXJwb2xhdGlvbiIsCiAgImNvbG9ySW50ZXJwb2xhdGlvbkZpbHRlcnMiLAogICJjb2xvclByb2ZpbGUiLAogICJjb2xvclJlbmRlcmluZyIsCiAgImNvbnRlbnRTY3JpcHRUeXBlIiwKICAiY29udGVudFN0eWxlVHlwZSIsCiAgImN1cnNvciIsCiAgImN4IiwKICAiY3kiLAogICJkIiwKICAiZGVjZWxlcmF0ZSIsCiAgImRlc2NlbnQiLAogICJkaWZmdXNlQ29uc3RhbnQiLAogICJkaXJlY3Rpb24iLAogICJkaXNwbGF5IiwKICAiZGl2aXNvciIsCiAgImRvbWluYW50QmFzZWxpbmUiLAogICJkdXIiLAogICJkeCIsCiAgImR5IiwKICAiZWRnZU1vZGUiLAogICJlbGV2YXRpb24iLAogICJlbmFibGVCYWNrZ3JvdW5kIiwKICAiZW5kIiwKICAiZXhwb25lbnQiLAogICJleHRlcm5hbFJlc291cmNlc1JlcXVpcmVkIiwKICAiZmlsbCIsCiAgImZpbGxPcGFjaXR5IiwKICAiZmlsbFJ1bGUiLAogICJmaWx0ZXIiLAogICJmaWx0ZXJSZXMiLAogICJmaWx0ZXJVbml0cyIsCiAgImZsb29kQ29sb3IiLAogICJmbG9vZE9wYWNpdHkiLAogICJmb2N1c2FibGUiLAogICJmb250RmFtaWx5IiwKICAiZm9udFNpemUiLAogICJmb250U2l6ZUFkanVzdCIsCiAgImZvbnRTdHJldGNoIiwKICAiZm9udFN0eWxlIiwKICAiZm9udFZhcmlhbnQiLAogICJmb250V2VpZ2h0IiwKICAiZm9ybWF0IiwKICAiZnJvbSIsCiAgImZ4IiwKICAiZnkiLAogICJnMSIsCiAgImcyIiwKICAiZ2x5cGhOYW1lIiwKICAiZ2x5cGhPcmllbnRhdGlvbkhvcml6b250YWwiLAogICJnbHlwaE9yaWVudGF0aW9uVmVydGljYWwiLAogICJnbHlwaFJlZiIsCiAgImdyYWRpZW50VHJhbnNmb3JtIiwKICAiZ3JhZGllbnRVbml0cyIsCiAgImhhbmdpbmciLAogICJob3JpekFkdlgiLAogICJob3Jpek9yaWdpblgiLAogICJocmVmIiwKICAiaWRlb2dyYXBoaWMiLAogICJpbWFnZVJlbmRlcmluZyIsCiAgImluMiIsCiAgImluIiwKICAiaW50ZXJjZXB0IiwKICAiazEiLAogICJrMiIsCiAgImszIiwKICAiazQiLAogICJrIiwKICAia2VybmVsTWF0cml4IiwKICAia2VybmVsVW5pdExlbmd0aCIsCiAgImtlcm5pbmciLAogICJrZXlQb2ludHMiLAogICJrZXlTcGxpbmVzIiwKICAia2V5VGltZXMiLAogICJsZW5ndGhBZGp1c3QiLAogICJsZXR0ZXJTcGFjaW5nIiwKICAibGlnaHRpbmdDb2xvciIsCiAgImxpbWl0aW5nQ29uZUFuZ2xlIiwKICAibG9jYWwiLAogICJtYXJrZXJFbmQiLAogICJtYXJrZXJIZWlnaHQiLAogICJtYXJrZXJNaWQiLAogICJtYXJrZXJTdGFydCIsCiAgIm1hcmtlclVuaXRzIiwKICAibWFya2VyV2lkdGgiLAogICJtYXNrIiwKICAibWFza0NvbnRlbnRVbml0cyIsCiAgIm1hc2tVbml0cyIsCiAgIm1hdGhlbWF0aWNhbCIsCiAgIm1vZGUiLAogICJudW1PY3RhdmVzIiwKICAib2Zmc2V0IiwKICAib3BhY2l0eSIsCiAgIm9wZXJhdG9yIiwKICAib3JkZXIiLAogICJvcmllbnQiLAogICJvcmllbnRhdGlvbiIsCiAgIm9yaWdpbiIsCiAgIm92ZXJmbG93IiwKICAib3ZlcmxpbmVQb3NpdGlvbiIsCiAgIm92ZXJsaW5lVGhpY2tuZXNzIiwKICAicGFpbnRPcmRlciIsCiAgInBhbm9zZTEiLAogICJwYXRoTGVuZ3RoIiwKICAicGF0dGVybkNvbnRlbnRVbml0cyIsCiAgInBhdHRlcm5UcmFuc2Zvcm0iLAogICJwYXR0ZXJuVW5pdHMiLAogICJwb2ludGVyRXZlbnRzIiwKICAicG9pbnRzQXRYIiwKICAicG9pbnRzQXRZIiwKICAicG9pbnRzQXRaIiwKICAicHJlc2VydmVBbHBoYSIsCiAgInByZXNlcnZlQXNwZWN0UmF0aW8iLAogICJwcmltaXRpdmVVbml0cyIsCiAgInIiLAogICJyYWRpdXMiLAogICJyZWZYIiwKICAicmVmWSIsCiAgInJlbmRlcmluZ0ludGVudCIsCiAgInJlcGVhdENvdW50IiwKICAicmVwZWF0RHVyIiwKICAicmVxdWlyZWRFeHRlbnNpb25zIiwKICAicmVxdWlyZWRGZWF0dXJlcyIsCiAgInJlc3RhcnQiLAogICJyZXN1bHQiLAogICJyb3RhdGUiLAogICJyeCIsCiAgInJ5IiwKICAic2VlZCIsCiAgInNoYXBlUmVuZGVyaW5nIiwKICAic2xvcGUiLAogICJzcGFjaW5nIiwKICAic3BlY3VsYXJDb25zdGFudCIsCiAgInNwZWN1bGFyRXhwb25lbnQiLAogICJzcGVlZCIsCiAgInNwcmVhZE1ldGhvZCIsCiAgInN0YXJ0T2Zmc2V0IiwKICAic3RkRGV2aWF0aW9uIiwKICAic3RlbWgiLAogICJzdGVtdiIsCiAgInN0aXRjaFRpbGVzIiwKICAic3RvcENvbG9yIiwKICAic3RvcE9wYWNpdHkiLAogICJzdHJpa2V0aHJvdWdoUG9zaXRpb24iLAogICJzdHJpa2V0aHJvdWdoVGhpY2tuZXNzIiwKICAic3RyaW5nIiwKICAic3Ryb2tlIiwKICAic3Ryb2tlRGFzaGFycmF5IiwKICAic3Ryb2tlRGFzaG9mZnNldCIsCiAgInN0cm9rZUxpbmVjYXAiLAogICJzdHJva2VMaW5lam9pbiIsCiAgInN0cm9rZU1pdGVybGltaXQiLAogICJzdHJva2VPcGFjaXR5IiwKICAic3Ryb2tlV2lkdGgiLAogICJzdXJmYWNlU2NhbGUiLAogICJzeXN0ZW1MYW5ndWFnZSIsCiAgInRhYmxlVmFsdWVzIiwKICAidGFyZ2V0WCIsCiAgInRhcmdldFkiLAogICJ0ZXh0QW5jaG9yIiwKICAidGV4dERlY29yYXRpb24iLAogICJ0ZXh0TGVuZ3RoIiwKICAidGV4dFJlbmRlcmluZyIsCiAgInRvIiwKICAidHJhbnNmb3JtIiwKICAidTEiLAogICJ1MiIsCiAgInVuZGVybGluZVBvc2l0aW9uIiwKICAidW5kZXJsaW5lVGhpY2tuZXNzIiwKICAidW5pY29kZSIsCiAgInVuaWNvZGVCaWRpIiwKICAidW5pY29kZVJhbmdlIiwKICAidW5pdHNQZXJFbSIsCiAgInZBbHBoYWJldGljIiwKICAidmFsdWVzIiwKICAidmVjdG9yRWZmZWN0IiwKICAidmVyc2lvbiIsCiAgInZlcnRBZHZZIiwKICAidmVydE9yaWdpblgiLAogICJ2ZXJ0T3JpZ2luWSIsCiAgInZIYW5naW5nIiwKICAidklkZW9ncmFwaGljIiwKICAidmlld1RhcmdldCIsCiAgInZpc2liaWxpdHkiLAogICJ2TWF0aGVtYXRpY2FsIiwKICAid2lkdGhzIiwKICAid29yZFNwYWNpbmciLAogICJ3cml0aW5nTW9kZSIsCiAgIngxIiwKICAieDIiLAogICJ4IiwKICAieENoYW5uZWxTZWxlY3RvciIsCiAgInhIZWlnaHQiLAogICJ4bGlua0FjdHVhdGUiLAogICJ4bGlua0FyY3JvbGUiLAogICJ4bGlua0hyZWYiLAogICJ4bGlua1JvbGUiLAogICJ4bGlua1Nob3ciLAogICJ4bGlua1RpdGxlIiwKICAieGxpbmtUeXBlIiwKICAieG1sQmFzZSIsCiAgInhtbExhbmciLAogICJ4bWxucyIsCiAgInhtbG5zWGxpbmsiLAogICJ4bWxTcGFjZSIsCiAgInkxIiwKICAieTIiLAogICJ5IiwKICAieUNoYW5uZWxTZWxlY3RvciIsCiAgInoiLAogICJ6b29tQW5kUGFuIiwKICAicmVmIiwKICAia2V5IiwKICAiYW5nbGUiCl07CnZhciBTVkdFbGVtZW50UHJvcEtleVNldCA9IG5ldyBTZXQoU1ZHRWxlbWVudFByb3BLZXlzKTsKZnVuY3Rpb24gaXNTdmdFbGVtZW50UHJvcEtleShrZXkpIHsKICBpZiAodHlwZW9mIGtleSAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgcmV0dXJuIFNWR0VsZW1lbnRQcm9wS2V5U2V0LmhhcyhrZXkpOwp9CmZ1bmN0aW9uIGlzRGF0YUF0dHJpYnV0ZShrZXkpIHsKICByZXR1cm4gdHlwZW9mIGtleSA9PT0gInN0cmluZyIgJiYga2V5LnN0YXJ0c1dpdGgoImRhdGEtIik7Cn0KZnVuY3Rpb24gc3ZnUHJvcGVydGllc05vRXZlbnRzKG9iaikgewogIGlmICh0eXBlb2Ygb2JqICE9PSAib2JqZWN0IiB8fCBvYmogPT09IG51bGwpIHsKICAgIHJldHVybiB7fTsKICB9CiAgdmFyIHJlc3VsdCA9IHt9OwogIGZvciAodmFyIGtleSBpbiBvYmopIHsKICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpKSB7CiAgICAgIGlmIChpc1N2Z0VsZW1lbnRQcm9wS2V5KGtleSkgfHwgaXNEYXRhQXR0cmlidXRlKGtleSkpIHsKICAgICAgICByZXN1bHRba2V5XSA9IG9ialtrZXldOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gc3ZnUHJvcGVydGllc05vRXZlbnRzRnJvbVVua25vd24oaW5wdXQpIHsKICBpZiAoaW5wdXQgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmICgvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDMuaXNWYWxpZEVsZW1lbnQpKGlucHV0KSAmJiB0eXBlb2YgaW5wdXQucHJvcHMgPT09ICJvYmplY3QiICYmIGlucHV0LnByb3BzICE9PSBudWxsKSB7CiAgICB2YXIgcCA9IGlucHV0LnByb3BzOwogICAgcmV0dXJuIHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhwKTsKICB9CiAgaWYgKHR5cGVvZiBpbnB1dCA9PT0gIm9iamVjdCIgJiYgIUFycmF5LmlzQXJyYXkoaW5wdXQpKSB7CiAgICByZXR1cm4gc3ZnUHJvcGVydGllc05vRXZlbnRzKGlucHV0KTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc3ZnUHJvcGVydGllc0FuZEV2ZW50cy5qcwpmdW5jdGlvbiBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKG9iaikgewogIHZhciByZXN1bHQgPSB7fTsKICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KSkgewogICAgICBpZiAoaXNTdmdFbGVtZW50UHJvcEtleShrZXkpIHx8IGlzRGF0YUF0dHJpYnV0ZShrZXkpIHx8IGlzRXZlbnRLZXkoa2V5KSkgewogICAgICAgIHJlc3VsdFtrZXldID0gb2JqW2tleV07CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzRnJvbVVua25vd24oaW5wdXQpIHsKICBpZiAoaW5wdXQgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmICgvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQuaXNWYWxpZEVsZW1lbnQpKGlucHV0KSkgewogICAgcmV0dXJuIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMoaW5wdXQucHJvcHMpOwogIH0KICBpZiAodHlwZW9mIGlucHV0ID09PSAib2JqZWN0IiAmJiAhQXJyYXkuaXNBcnJheShpbnB1dCkpIHsKICAgIHJldHVybiBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKGlucHV0KTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRhaW5lci9TdXJmYWNlLmpzCnZhciBfZXhjbHVkZWQgPSBbImNoaWxkcmVuIiwgIndpZHRoIiwgImhlaWdodCIsICJ2aWV3Qm94IiwgImNsYXNzTmFtZSIsICJzdHlsZSIsICJ0aXRsZSIsICJkZXNjIl07CmZ1bmN0aW9uIF9leHRlbmRzKCkgewogIHJldHVybiBfZXh0ZW5kcyA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZShyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIFN1cmZhY2UgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDUuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHZpZXdCb3gsCiAgICBjbGFzc05hbWUsCiAgICBzdHlsZSwKICAgIHRpdGxlLAogICAgZGVzYwogIH0gPSBwcm9wcywgb3RoZXJzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzKHByb3BzLCBfZXhjbHVkZWQpOwogIHZhciBzdmdWaWV3ID0gdmlld0JveCB8fCB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHg6IDAsCiAgICB5OiAwCiAgfTsKICB2YXIgbGF5ZXJDbGFzcyA9IGNsc3goInJlY2hhcnRzLXN1cmZhY2UiLCBjbGFzc05hbWUpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QuY3JlYXRlRWxlbWVudCgic3ZnIiwgX2V4dGVuZHMoe30sIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMob3RoZXJzKSwgewogICAgY2xhc3NOYW1lOiBsYXllckNsYXNzLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBzdHlsZSwKICAgIHZpZXdCb3g6ICIiLmNvbmNhdChzdmdWaWV3LngsICIgIikuY29uY2F0KHN2Z1ZpZXcueSwgIiAiKS5jb25jYXQoc3ZnVmlldy53aWR0aCwgIiAiKS5jb25jYXQoc3ZnVmlldy5oZWlnaHQpLAogICAgcmVmCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdC5jcmVhdGVFbGVtZW50KCJ0aXRsZSIsIG51bGwsIHRpdGxlKSwgLyogQF9fUFVSRV9fICovIFJlYWN0LmNyZWF0ZUVsZW1lbnQoImRlc2MiLCBudWxsLCBkZXNjKSwgY2hpbGRyZW4pOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRhaW5lci9MYXllci5qcwp2YXIgUmVhY3QyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkMiA9IFsiY2hpbGRyZW4iLCAiY2xhc3NOYW1lIl07CmZ1bmN0aW9uIF9leHRlbmRzMigpIHsKICByZXR1cm4gX2V4dGVuZHMyID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMyLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMihlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMihlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMihyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIExheWVyID0gLyogQF9fUFVSRV9fICovIFJlYWN0Mi5mb3J3YXJkUmVmKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgY2xhc3NOYW1lCiAgfSA9IHByb3BzLCBvdGhlcnMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMyKHByb3BzLCBfZXhjbHVkZWQyKTsKICB2YXIgbGF5ZXJDbGFzcyA9IGNsc3goInJlY2hhcnRzLWxheWVyIiwgY2xhc3NOYW1lKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0Mi5jcmVhdGVFbGVtZW50KCJnIiwgX2V4dGVuZHMyKHsKICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcwogIH0sIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMob3RoZXJzKSwgewogICAgcmVmCiAgfSksIGNoaWxkcmVuKTsKfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L2xlZ2VuZFBvcnRhbENvbnRleHQuanMKdmFyIGltcG9ydF9yZWFjdDYgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBMZWdlbmRQb3J0YWxDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q2LmNyZWF0ZUNvbnRleHQpKG51bGwpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY29uc3RhbnQuanMKZnVuY3Rpb24gY29uc3RhbnRfZGVmYXVsdCh4MikgewogIHJldHVybiBmdW5jdGlvbiBjb25zdGFudCgpIHsKICAgIHJldHVybiB4MjsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtcGF0aEAzLjEuMC9ub2RlX21vZHVsZXMvZDMtcGF0aC9zcmMvcGF0aC5qcwp2YXIgcGkgPSBNYXRoLlBJOwp2YXIgdGF1ID0gMiAqIHBpOwp2YXIgZXBzaWxvbiA9IDFlLTY7CnZhciB0YXVFcHNpbG9uID0gdGF1IC0gZXBzaWxvbjsKZnVuY3Rpb24gYXBwZW5kKHN0cmluZ3MpIHsKICB0aGlzLl8gKz0gc3RyaW5nc1swXTsKICBmb3IgKGxldCBpID0gMSwgbiA9IHN0cmluZ3MubGVuZ3RoOyBpIDwgbjsgKytpKSB7CiAgICB0aGlzLl8gKz0gYXJndW1lbnRzW2ldICsgc3RyaW5nc1tpXTsKICB9Cn0KZnVuY3Rpb24gYXBwZW5kUm91bmQoZGlnaXRzKSB7CiAgbGV0IGQgPSBNYXRoLmZsb29yKGRpZ2l0cyk7CiAgaWYgKCEoZCA+PSAwKSkgdGhyb3cgbmV3IEVycm9yKGBpbnZhbGlkIGRpZ2l0czogJHtkaWdpdHN9YCk7CiAgaWYgKGQgPiAxNSkgcmV0dXJuIGFwcGVuZDsKICBjb25zdCBrID0gMTAgKiogZDsKICByZXR1cm4gZnVuY3Rpb24oc3RyaW5ncykgewogICAgdGhpcy5fICs9IHN0cmluZ3NbMF07CiAgICBmb3IgKGxldCBpID0gMSwgbiA9IHN0cmluZ3MubGVuZ3RoOyBpIDwgbjsgKytpKSB7CiAgICAgIHRoaXMuXyArPSBNYXRoLnJvdW5kKGFyZ3VtZW50c1tpXSAqIGspIC8gayArIHN0cmluZ3NbaV07CiAgICB9CiAgfTsKfQp2YXIgUGF0aCA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihkaWdpdHMpIHsKICAgIHRoaXMuX3gwID0gdGhpcy5feTAgPSAvLyBzdGFydCBvZiBjdXJyZW50IHN1YnBhdGgKICAgIHRoaXMuX3gxID0gdGhpcy5feTEgPSBudWxsOwogICAgdGhpcy5fID0gIiI7CiAgICB0aGlzLl9hcHBlbmQgPSBkaWdpdHMgPT0gbnVsbCA/IGFwcGVuZCA6IGFwcGVuZFJvdW5kKGRpZ2l0cyk7CiAgfQogIG1vdmVUbyh4MiwgeTIpIHsKICAgIHRoaXMuX2FwcGVuZGBNJHt0aGlzLl94MCA9IHRoaXMuX3gxID0gK3gyfSwke3RoaXMuX3kwID0gdGhpcy5feTEgPSAreTJ9YDsKICB9CiAgY2xvc2VQYXRoKCkgewogICAgaWYgKHRoaXMuX3gxICE9PSBudWxsKSB7CiAgICAgIHRoaXMuX3gxID0gdGhpcy5feDAsIHRoaXMuX3kxID0gdGhpcy5feTA7CiAgICAgIHRoaXMuX2FwcGVuZGBaYDsKICAgIH0KICB9CiAgbGluZVRvKHgyLCB5MikgewogICAgdGhpcy5fYXBwZW5kYEwke3RoaXMuX3gxID0gK3gyfSwke3RoaXMuX3kxID0gK3kyfWA7CiAgfQogIHF1YWRyYXRpY0N1cnZlVG8oeDEsIHkxLCB4MiwgeTIpIHsKICAgIHRoaXMuX2FwcGVuZGBRJHsreDF9LCR7K3kxfSwke3RoaXMuX3gxID0gK3gyfSwke3RoaXMuX3kxID0gK3kyfWA7CiAgfQogIGJlemllckN1cnZlVG8oeDEsIHkxLCB4MiwgeTIsIHgzLCB5MykgewogICAgdGhpcy5fYXBwZW5kYEMkeyt4MX0sJHsreTF9LCR7K3gyfSwkeyt5Mn0sJHt0aGlzLl94MSA9ICt4M30sJHt0aGlzLl95MSA9ICt5M31gOwogIH0KICBhcmNUbyh4MSwgeTEsIHgyLCB5MiwgcjIpIHsKICAgIHgxID0gK3gxLCB5MSA9ICt5MSwgeDIgPSAreDIsIHkyID0gK3kyLCByMiA9ICtyMjsKICAgIGlmIChyMiA8IDApIHRocm93IG5ldyBFcnJvcihgbmVnYXRpdmUgcmFkaXVzOiAke3IyfWApOwogICAgbGV0IHgwID0gdGhpcy5feDEsIHkwID0gdGhpcy5feTEsIHgyMSA9IHgyIC0geDEsIHkyMSA9IHkyIC0geTEsIHgwMSA9IHgwIC0geDEsIHkwMSA9IHkwIC0geTEsIGwwMV8yID0geDAxICogeDAxICsgeTAxICogeTAxOwogICAgaWYgKHRoaXMuX3gxID09PSBudWxsKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBNJHt0aGlzLl94MSA9IHgxfSwke3RoaXMuX3kxID0geTF9YDsKICAgIH0gZWxzZSBpZiAoIShsMDFfMiA+IGVwc2lsb24pKSA7CiAgICBlbHNlIGlmICghKE1hdGguYWJzKHkwMSAqIHgyMSAtIHkyMSAqIHgwMSkgPiBlcHNpbG9uKSB8fCAhcjIpIHsKICAgICAgdGhpcy5fYXBwZW5kYEwke3RoaXMuX3gxID0geDF9LCR7dGhpcy5feTEgPSB5MX1gOwogICAgfSBlbHNlIHsKICAgICAgbGV0IHgyMCA9IHgyIC0geDAsIHkyMCA9IHkyIC0geTAsIGwyMV8yID0geDIxICogeDIxICsgeTIxICogeTIxLCBsMjBfMiA9IHgyMCAqIHgyMCArIHkyMCAqIHkyMCwgbDIxID0gTWF0aC5zcXJ0KGwyMV8yKSwgbDAxID0gTWF0aC5zcXJ0KGwwMV8yKSwgbCA9IHIyICogTWF0aC50YW4oKHBpIC0gTWF0aC5hY29zKChsMjFfMiArIGwwMV8yIC0gbDIwXzIpIC8gKDIgKiBsMjEgKiBsMDEpKSkgLyAyKSwgdDAxID0gbCAvIGwwMSwgdDIxID0gbCAvIGwyMTsKICAgICAgaWYgKE1hdGguYWJzKHQwMSAtIDEpID4gZXBzaWxvbikgewogICAgICAgIHRoaXMuX2FwcGVuZGBMJHt4MSArIHQwMSAqIHgwMX0sJHt5MSArIHQwMSAqIHkwMX1gOwogICAgICB9CiAgICAgIHRoaXMuX2FwcGVuZGBBJHtyMn0sJHtyMn0sMCwwLCR7Kyh5MDEgKiB4MjAgPiB4MDEgKiB5MjApfSwke3RoaXMuX3gxID0geDEgKyB0MjEgKiB4MjF9LCR7dGhpcy5feTEgPSB5MSArIHQyMSAqIHkyMX1gOwogICAgfQogIH0KICBhcmMoeDIsIHkyLCByMiwgYTAsIGExLCBjY3cpIHsKICAgIHgyID0gK3gyLCB5MiA9ICt5MiwgcjIgPSArcjIsIGNjdyA9ICEhY2N3OwogICAgaWYgKHIyIDwgMCkgdGhyb3cgbmV3IEVycm9yKGBuZWdhdGl2ZSByYWRpdXM6ICR7cjJ9YCk7CiAgICBsZXQgZHggPSByMiAqIE1hdGguY29zKGEwKSwgZHkgPSByMiAqIE1hdGguc2luKGEwKSwgeDAgPSB4MiArIGR4LCB5MCA9IHkyICsgZHksIGN3ID0gMSBeIGNjdywgZGEgPSBjY3cgPyBhMCAtIGExIDogYTEgLSBhMDsKICAgIGlmICh0aGlzLl94MSA9PT0gbnVsbCkgewogICAgICB0aGlzLl9hcHBlbmRgTSR7eDB9LCR7eTB9YDsKICAgIH0gZWxzZSBpZiAoTWF0aC5hYnModGhpcy5feDEgLSB4MCkgPiBlcHNpbG9uIHx8IE1hdGguYWJzKHRoaXMuX3kxIC0geTApID4gZXBzaWxvbikgewogICAgICB0aGlzLl9hcHBlbmRgTCR7eDB9LCR7eTB9YDsKICAgIH0KICAgIGlmICghcjIpIHJldHVybjsKICAgIGlmIChkYSA8IDApIGRhID0gZGEgJSB0YXUgKyB0YXU7CiAgICBpZiAoZGEgPiB0YXVFcHNpbG9uKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBBJHtyMn0sJHtyMn0sMCwxLCR7Y3d9LCR7eDIgLSBkeH0sJHt5MiAtIGR5fUEke3IyfSwke3IyfSwwLDEsJHtjd30sJHt0aGlzLl94MSA9IHgwfSwke3RoaXMuX3kxID0geTB9YDsKICAgIH0gZWxzZSBpZiAoZGEgPiBlcHNpbG9uKSB7CiAgICAgIHRoaXMuX2FwcGVuZGBBJHtyMn0sJHtyMn0sMCwkeysoZGEgPj0gcGkpfSwke2N3fSwke3RoaXMuX3gxID0geDIgKyByMiAqIE1hdGguY29zKGExKX0sJHt0aGlzLl95MSA9IHkyICsgcjIgKiBNYXRoLnNpbihhMSl9YDsKICAgIH0KICB9CiAgcmVjdCh4MiwgeTIsIHcsIGgpIHsKICAgIHRoaXMuX2FwcGVuZGBNJHt0aGlzLl94MCA9IHRoaXMuX3gxID0gK3gyfSwke3RoaXMuX3kwID0gdGhpcy5feTEgPSAreTJ9aCR7dyA9ICt3fXYkeytofWgkey13fVpgOwogIH0KICB0b1N0cmluZygpIHsKICAgIHJldHVybiB0aGlzLl87CiAgfQp9OwpmdW5jdGlvbiBwYXRoKCkgewogIHJldHVybiBuZXcgUGF0aCgpOwp9CnBhdGgucHJvdG90eXBlID0gUGF0aC5wcm90b3R5cGU7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9wYXRoLmpzCmZ1bmN0aW9uIHdpdGhQYXRoKHNoYXBlKSB7CiAgbGV0IGRpZ2l0cyA9IDM7CiAgc2hhcGUuZGlnaXRzID0gZnVuY3Rpb24oXykgewogICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gZGlnaXRzOwogICAgaWYgKF8gPT0gbnVsbCkgewogICAgICBkaWdpdHMgPSBudWxsOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgZCA9IE1hdGguZmxvb3IoXyk7CiAgICAgIGlmICghKGQgPj0gMCkpIHRocm93IG5ldyBSYW5nZUVycm9yKGBpbnZhbGlkIGRpZ2l0czogJHtffWApOwogICAgICBkaWdpdHMgPSBkOwogICAgfQogICAgcmV0dXJuIHNoYXBlOwogIH07CiAgcmV0dXJuICgpID0+IG5ldyBQYXRoKGRpZ2l0cyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2FycmF5LmpzCnZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKZnVuY3Rpb24gYXJyYXlfZGVmYXVsdCh4MikgewogIHJldHVybiB0eXBlb2YgeDIgPT09ICJvYmplY3QiICYmICJsZW5ndGgiIGluIHgyID8geDIgOiBBcnJheS5mcm9tKHgyKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvbGluZWFyLmpzCmZ1bmN0aW9uIExpbmVhcihjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KTGluZWFyLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IDA7CiAgfSwKICBhcmVhRW5kOiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSBOYU47CiAgfSwKICBsaW5lU3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIHRoaXMuX3BvaW50ID09PSAxKSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgfQogIH0KfTsKZnVuY3Rpb24gbGluZWFyX2RlZmF1bHQoY29udGV4dCkgewogIHJldHVybiBuZXcgTGluZWFyKGNvbnRleHQpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9wb2ludC5qcwpmdW5jdGlvbiB4KHApIHsKICByZXR1cm4gcFswXTsKfQpmdW5jdGlvbiB5KHApIHsKICByZXR1cm4gcFsxXTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvbGluZS5qcwpmdW5jdGlvbiBsaW5lX2RlZmF1bHQoeDIsIHkyKSB7CiAgdmFyIGRlZmluZWQyID0gY29uc3RhbnRfZGVmYXVsdCh0cnVlKSwgY29udGV4dCA9IG51bGwsIGN1cnZlID0gbGluZWFyX2RlZmF1bHQsIG91dHB1dCA9IG51bGwsIHBhdGgyID0gd2l0aFBhdGgobGluZSk7CiAgeDIgPSB0eXBlb2YgeDIgPT09ICJmdW5jdGlvbiIgPyB4MiA6IHgyID09PSB2b2lkIDAgPyB4IDogY29uc3RhbnRfZGVmYXVsdCh4Mik7CiAgeTIgPSB0eXBlb2YgeTIgPT09ICJmdW5jdGlvbiIgPyB5MiA6IHkyID09PSB2b2lkIDAgPyB5IDogY29uc3RhbnRfZGVmYXVsdCh5Mik7CiAgZnVuY3Rpb24gbGluZShkYXRhKSB7CiAgICB2YXIgaSwgbiA9IChkYXRhID0gYXJyYXlfZGVmYXVsdChkYXRhKSkubGVuZ3RoLCBkLCBkZWZpbmVkMCA9IGZhbHNlLCBidWZmZXI7CiAgICBpZiAoY29udGV4dCA9PSBudWxsKSBvdXRwdXQgPSBjdXJ2ZShidWZmZXIgPSBwYXRoMigpKTsKICAgIGZvciAoaSA9IDA7IGkgPD0gbjsgKytpKSB7CiAgICAgIGlmICghKGkgPCBuICYmIGRlZmluZWQyKGQgPSBkYXRhW2ldLCBpLCBkYXRhKSkgPT09IGRlZmluZWQwKSB7CiAgICAgICAgaWYgKGRlZmluZWQwID0gIWRlZmluZWQwKSBvdXRwdXQubGluZVN0YXJ0KCk7CiAgICAgICAgZWxzZSBvdXRwdXQubGluZUVuZCgpOwogICAgICB9CiAgICAgIGlmIChkZWZpbmVkMCkgb3V0cHV0LnBvaW50KCt4MihkLCBpLCBkYXRhKSwgK3kyKGQsIGksIGRhdGEpKTsKICAgIH0KICAgIGlmIChidWZmZXIpIHJldHVybiBvdXRwdXQgPSBudWxsLCBidWZmZXIgKyAiIiB8fCBudWxsOwogIH0KICBsaW5lLnggPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh4MiA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCBsaW5lKSA6IHgyOwogIH07CiAgbGluZS55ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeTIgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgbGluZSkgOiB5MjsKICB9OwogIGxpbmUuZGVmaW5lZCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRlZmluZWQyID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCghIV8pLCBsaW5lKSA6IGRlZmluZWQyOwogIH07CiAgbGluZS5jdXJ2ZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGN1cnZlID0gXywgY29udGV4dCAhPSBudWxsICYmIChvdXRwdXQgPSBjdXJ2ZShjb250ZXh0KSksIGxpbmUpIDogY3VydmU7CiAgfTsKICBsaW5lLmNvbnRleHQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChfID09IG51bGwgPyBjb250ZXh0ID0gb3V0cHV0ID0gbnVsbCA6IG91dHB1dCA9IGN1cnZlKGNvbnRleHQgPSBfKSwgbGluZSkgOiBjb250ZXh0OwogIH07CiAgcmV0dXJuIGxpbmU7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2FyZWEuanMKZnVuY3Rpb24gYXJlYV9kZWZhdWx0KHgwLCB5MCwgeTEpIHsKICB2YXIgeDEgPSBudWxsLCBkZWZpbmVkMiA9IGNvbnN0YW50X2RlZmF1bHQodHJ1ZSksIGNvbnRleHQgPSBudWxsLCBjdXJ2ZSA9IGxpbmVhcl9kZWZhdWx0LCBvdXRwdXQgPSBudWxsLCBwYXRoMiA9IHdpdGhQYXRoKGFyZWEpOwogIHgwID0gdHlwZW9mIHgwID09PSAiZnVuY3Rpb24iID8geDAgOiB4MCA9PT0gdm9pZCAwID8geCA6IGNvbnN0YW50X2RlZmF1bHQoK3gwKTsKICB5MCA9IHR5cGVvZiB5MCA9PT0gImZ1bmN0aW9uIiA/IHkwIDogeTAgPT09IHZvaWQgMCA/IGNvbnN0YW50X2RlZmF1bHQoMCkgOiBjb25zdGFudF9kZWZhdWx0KCt5MCk7CiAgeTEgPSB0eXBlb2YgeTEgPT09ICJmdW5jdGlvbiIgPyB5MSA6IHkxID09PSB2b2lkIDAgPyB5IDogY29uc3RhbnRfZGVmYXVsdCgreTEpOwogIGZ1bmN0aW9uIGFyZWEoZGF0YSkgewogICAgdmFyIGksIGosIGssIG4gPSAoZGF0YSA9IGFycmF5X2RlZmF1bHQoZGF0YSkpLmxlbmd0aCwgZCwgZGVmaW5lZDAgPSBmYWxzZSwgYnVmZmVyLCB4MHogPSBuZXcgQXJyYXkobiksIHkweiA9IG5ldyBBcnJheShuKTsKICAgIGlmIChjb250ZXh0ID09IG51bGwpIG91dHB1dCA9IGN1cnZlKGJ1ZmZlciA9IHBhdGgyKCkpOwogICAgZm9yIChpID0gMDsgaSA8PSBuOyArK2kpIHsKICAgICAgaWYgKCEoaSA8IG4gJiYgZGVmaW5lZDIoZCA9IGRhdGFbaV0sIGksIGRhdGEpKSA9PT0gZGVmaW5lZDApIHsKICAgICAgICBpZiAoZGVmaW5lZDAgPSAhZGVmaW5lZDApIHsKICAgICAgICAgIGogPSBpOwogICAgICAgICAgb3V0cHV0LmFyZWFTdGFydCgpOwogICAgICAgICAgb3V0cHV0LmxpbmVTdGFydCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBvdXRwdXQubGluZUVuZCgpOwogICAgICAgICAgb3V0cHV0LmxpbmVTdGFydCgpOwogICAgICAgICAgZm9yIChrID0gaSAtIDE7IGsgPj0gajsgLS1rKSB7CiAgICAgICAgICAgIG91dHB1dC5wb2ludCh4MHpba10sIHkweltrXSk7CiAgICAgICAgICB9CiAgICAgICAgICBvdXRwdXQubGluZUVuZCgpOwogICAgICAgICAgb3V0cHV0LmFyZWFFbmQoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGRlZmluZWQwKSB7CiAgICAgICAgeDB6W2ldID0gK3gwKGQsIGksIGRhdGEpLCB5MHpbaV0gPSAreTAoZCwgaSwgZGF0YSk7CiAgICAgICAgb3V0cHV0LnBvaW50KHgxID8gK3gxKGQsIGksIGRhdGEpIDogeDB6W2ldLCB5MSA/ICt5MShkLCBpLCBkYXRhKSA6IHkweltpXSk7CiAgICAgIH0KICAgIH0KICAgIGlmIChidWZmZXIpIHJldHVybiBvdXRwdXQgPSBudWxsLCBidWZmZXIgKyAiIiB8fCBudWxsOwogIH0KICBmdW5jdGlvbiBhcmVhbGluZSgpIHsKICAgIHJldHVybiBsaW5lX2RlZmF1bHQoKS5kZWZpbmVkKGRlZmluZWQyKS5jdXJ2ZShjdXJ2ZSkuY29udGV4dChjb250ZXh0KTsKICB9CiAgYXJlYS54ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeDAgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgeDEgPSBudWxsLCBhcmVhKSA6IHgwOwogIH07CiAgYXJlYS54MCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHgwID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIGFyZWEpIDogeDA7CiAgfTsKICBhcmVhLngxID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeDEgPSBfID09IG51bGwgPyBudWxsIDogdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdCgrXyksIGFyZWEpIDogeDE7CiAgfTsKICBhcmVhLnkgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh5MCA9IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoK18pLCB5MSA9IG51bGwsIGFyZWEpIDogeTA7CiAgfTsKICBhcmVhLnkwID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoeTAgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgYXJlYSkgOiB5MDsKICB9OwogIGFyZWEueTEgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh5MSA9IF8gPT0gbnVsbCA/IG51bGwgOiB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgYXJlYSkgOiB5MTsKICB9OwogIGFyZWEubGluZVgwID0gYXJlYS5saW5lWTAgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBhcmVhbGluZSgpLngoeDApLnkoeTApOwogIH07CiAgYXJlYS5saW5lWTEgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBhcmVhbGluZSgpLngoeDApLnkoeTEpOwogIH07CiAgYXJlYS5saW5lWDEgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBhcmVhbGluZSgpLngoeDEpLnkoeTApOwogIH07CiAgYXJlYS5kZWZpbmVkID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoZGVmaW5lZDIgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCEhXyksIGFyZWEpIDogZGVmaW5lZDI7CiAgfTsKICBhcmVhLmN1cnZlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoY3VydmUgPSBfLCBjb250ZXh0ICE9IG51bGwgJiYgKG91dHB1dCA9IGN1cnZlKGNvbnRleHQpKSwgYXJlYSkgOiBjdXJ2ZTsKICB9OwogIGFyZWEuY29udGV4dCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKF8gPT0gbnVsbCA/IGNvbnRleHQgPSBvdXRwdXQgPSBudWxsIDogb3V0cHV0ID0gY3VydmUoY29udGV4dCA9IF8pLCBhcmVhKSA6IGNvbnRleHQ7CiAgfTsKICByZXR1cm4gYXJlYTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvYnVtcC5qcwp2YXIgQnVtcCA9IGNsYXNzIHsKICBjb25zdHJ1Y3Rvcihjb250ZXh0LCB4MikgewogICAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7CiAgICB0aGlzLl94ID0geDI7CiAgfQogIGFyZWFTdGFydCgpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0KICBhcmVhRW5kKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9CiAgbGluZVN0YXJ0KCkgewogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0KICBsaW5lRW5kKCkgewogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiB0aGlzLl9wb2ludCA9PT0gMSkgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIHRoaXMuX2xpbmUgPSAxIC0gdGhpcy5fbGluZTsKICB9CiAgcG9pbnQoeDIsIHkyKSB7CiAgICB4MiA9ICt4MiwgeTIgPSAreTI7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMDogewogICAgICAgIHRoaXMuX3BvaW50ID0gMTsKICAgICAgICBpZiAodGhpcy5fbGluZSkgdGhpcy5fY29udGV4dC5saW5lVG8oeDIsIHkyKTsKICAgICAgICBlbHNlIHRoaXMuX2NvbnRleHQubW92ZVRvKHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgZGVmYXVsdDogewogICAgICAgIGlmICh0aGlzLl94KSB0aGlzLl9jb250ZXh0LmJlemllckN1cnZlVG8odGhpcy5feDAgPSAodGhpcy5feDAgKyB4MikgLyAyLCB0aGlzLl95MCwgdGhpcy5feDAsIHkyLCB4MiwgeTIpOwogICAgICAgIGVsc2UgdGhpcy5fY29udGV4dC5iZXppZXJDdXJ2ZVRvKHRoaXMuX3gwLCB0aGlzLl95MCA9ICh0aGlzLl95MCArIHkyKSAvIDIsIHgyLCB0aGlzLl95MCwgeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgdGhpcy5feDAgPSB4MiwgdGhpcy5feTAgPSB5MjsKICB9Cn07CmZ1bmN0aW9uIGJ1bXBYKGNvbnRleHQpIHsKICByZXR1cm4gbmV3IEJ1bXAoY29udGV4dCwgdHJ1ZSk7Cn0KZnVuY3Rpb24gYnVtcFkoY29udGV4dCkgewogIHJldHVybiBuZXcgQnVtcChjb250ZXh0LCBmYWxzZSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL25vb3AuanMKZnVuY3Rpb24gbm9vcF9kZWZhdWx0KCkgewp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9iYXNpcy5qcwpmdW5jdGlvbiBwb2ludCh0aGF0LCB4MiwgeTIpIHsKICB0aGF0Ll9jb250ZXh0LmJlemllckN1cnZlVG8oCiAgICAoMiAqIHRoYXQuX3gwICsgdGhhdC5feDEpIC8gMywKICAgICgyICogdGhhdC5feTAgKyB0aGF0Ll95MSkgLyAzLAogICAgKHRoYXQuX3gwICsgMiAqIHRoYXQuX3gxKSAvIDMsCiAgICAodGhhdC5feTAgKyAyICogdGhhdC5feTEpIC8gMywKICAgICh0aGF0Ll94MCArIDQgKiB0aGF0Ll94MSArIHgyKSAvIDYsCiAgICAodGhhdC5feTAgKyA0ICogdGhhdC5feTEgKyB5MikgLyA2CiAgKTsKfQpmdW5jdGlvbiBCYXNpcyhjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KQmFzaXMucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9LAogIGFyZWFFbmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxID0gdGhpcy5feTAgPSB0aGlzLl95MSA9IE5hTjsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDM6CiAgICAgICAgcG9pbnQodGhpcywgdGhpcy5feDEsIHRoaXMuX3kxKTsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHRoaXMuX3gxLCB0aGlzLl95MSk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICBpZiAodGhpcy5fbGluZSB8fCB0aGlzLl9saW5lICE9PSAwICYmIHRoaXMuX3BvaW50ID09PSAxKSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDA6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAxOwogICAgICAgIHRoaXMuX2xpbmUgPyB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpIDogdGhpcy5fY29udGV4dC5tb3ZlVG8oeDIsIHkyKTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX3BvaW50ID0gMzsKICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbygoNSAqIHRoaXMuX3gwICsgdGhpcy5feDEpIC8gNiwgKDUgKiB0aGlzLl95MCArIHRoaXMuX3kxKSAvIDYpOwogICAgICBkZWZhdWx0OgogICAgICAgIHBvaW50KHRoaXMsIHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxLCB0aGlzLl94MSA9IHgyOwogICAgdGhpcy5feTAgPSB0aGlzLl95MSwgdGhpcy5feTEgPSB5MjsKICB9Cn07CmZ1bmN0aW9uIGJhc2lzX2RlZmF1bHQoY29udGV4dCkgewogIHJldHVybiBuZXcgQmFzaXMoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL2Jhc2lzQ2xvc2VkLmpzCmZ1bmN0aW9uIEJhc2lzQ2xvc2VkKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpCYXNpc0Nsb3NlZC5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBub29wX2RlZmF1bHQsCiAgYXJlYUVuZDogbm9vcF9kZWZhdWx0LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxID0gdGhpcy5feDIgPSB0aGlzLl94MyA9IHRoaXMuX3g0ID0gdGhpcy5feTAgPSB0aGlzLl95MSA9IHRoaXMuX3kyID0gdGhpcy5feTMgPSB0aGlzLl95NCA9IE5hTjsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgc3dpdGNoICh0aGlzLl9wb2ludCkgewogICAgICBjYXNlIDE6IHsKICAgICAgICB0aGlzLl9jb250ZXh0Lm1vdmVUbyh0aGlzLl94MiwgdGhpcy5feTIpOwogICAgICAgIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgY2FzZSAyOiB7CiAgICAgICAgdGhpcy5fY29udGV4dC5tb3ZlVG8oKHRoaXMuX3gyICsgMiAqIHRoaXMuX3gzKSAvIDMsICh0aGlzLl95MiArIDIgKiB0aGlzLl95MykgLyAzKTsKICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbygodGhpcy5feDMgKyAyICogdGhpcy5feDIpIC8gMywgKHRoaXMuX3kzICsgMiAqIHRoaXMuX3kyKSAvIDMpOwogICAgICAgIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgY2FzZSAzOiB7CiAgICAgICAgdGhpcy5wb2ludCh0aGlzLl94MiwgdGhpcy5feTIpOwogICAgICAgIHRoaXMucG9pbnQodGhpcy5feDMsIHRoaXMuX3kzKTsKICAgICAgICB0aGlzLnBvaW50KHRoaXMuX3g0LCB0aGlzLl95NCk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9LAogIHBvaW50OiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHgyID0gK3gyLCB5MiA9ICt5MjsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMuX3BvaW50ID0gMTsKICAgICAgICB0aGlzLl94MiA9IHgyLCB0aGlzLl95MiA9IHkyOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDE6CiAgICAgICAgdGhpcy5fcG9pbnQgPSAyOwogICAgICAgIHRoaXMuX3gzID0geDIsIHRoaXMuX3kzID0geTI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLl9wb2ludCA9IDM7CiAgICAgICAgdGhpcy5feDQgPSB4MiwgdGhpcy5feTQgPSB5MjsKICAgICAgICB0aGlzLl9jb250ZXh0Lm1vdmVUbygodGhpcy5feDAgKyA0ICogdGhpcy5feDEgKyB4MikgLyA2LCAodGhpcy5feTAgKyA0ICogdGhpcy5feTEgKyB5MikgLyA2KTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICBwb2ludCh0aGlzLCB4MiwgeTIpOwogICAgICAgIGJyZWFrOwogICAgfQogICAgdGhpcy5feDAgPSB0aGlzLl94MSwgdGhpcy5feDEgPSB4MjsKICAgIHRoaXMuX3kwID0gdGhpcy5feTEsIHRoaXMuX3kxID0geTI7CiAgfQp9OwpmdW5jdGlvbiBiYXNpc0Nsb3NlZF9kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IEJhc2lzQ2xvc2VkKGNvbnRleHQpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9iYXNpc09wZW4uanMKZnVuY3Rpb24gQmFzaXNPcGVuKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpCYXNpc09wZW4ucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9LAogIGFyZWFFbmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxID0gdGhpcy5feTAgPSB0aGlzLl95MSA9IE5hTjsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiB0aGlzLl9wb2ludCA9PT0gMykgdGhpcy5fY29udGV4dC5jbG9zZVBhdGgoKTsKICAgIHRoaXMuX2xpbmUgPSAxIC0gdGhpcy5fbGluZTsKICB9LAogIHBvaW50OiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHgyID0gK3gyLCB5MiA9ICt5MjsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMuX3BvaW50ID0gMTsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAxOgogICAgICAgIHRoaXMuX3BvaW50ID0gMjsKICAgICAgICBicmVhazsKICAgICAgY2FzZSAyOgogICAgICAgIHRoaXMuX3BvaW50ID0gMzsKICAgICAgICB2YXIgeDAgPSAodGhpcy5feDAgKyA0ICogdGhpcy5feDEgKyB4MikgLyA2LCB5MCA9ICh0aGlzLl95MCArIDQgKiB0aGlzLl95MSArIHkyKSAvIDY7CiAgICAgICAgdGhpcy5fbGluZSA/IHRoaXMuX2NvbnRleHQubGluZVRvKHgwLCB5MCkgOiB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MCwgeTApOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDM6CiAgICAgICAgdGhpcy5fcG9pbnQgPSA0OwogICAgICBkZWZhdWx0OgogICAgICAgIHBvaW50KHRoaXMsIHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxLCB0aGlzLl94MSA9IHgyOwogICAgdGhpcy5feTAgPSB0aGlzLl95MSwgdGhpcy5feTEgPSB5MjsKICB9Cn07CmZ1bmN0aW9uIGJhc2lzT3Blbl9kZWZhdWx0KGNvbnRleHQpIHsKICByZXR1cm4gbmV3IEJhc2lzT3Blbihjb250ZXh0KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvY3VydmUvbGluZWFyQ2xvc2VkLmpzCmZ1bmN0aW9uIExpbmVhckNsb3NlZChjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KTGluZWFyQ2xvc2VkLnByb3RvdHlwZSA9IHsKICBhcmVhU3RhcnQ6IG5vb3BfZGVmYXVsdCwKICBhcmVhRW5kOiBub29wX2RlZmF1bHQsCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuX3BvaW50KSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgaWYgKHRoaXMuX3BvaW50KSB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpOwogICAgZWxzZSB0aGlzLl9wb2ludCA9IDEsIHRoaXMuX2NvbnRleHQubW92ZVRvKHgyLCB5Mik7CiAgfQp9OwpmdW5jdGlvbiBsaW5lYXJDbG9zZWRfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBMaW5lYXJDbG9zZWQoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL21vbm90b25lLmpzCmZ1bmN0aW9uIHNpZ24oeDIpIHsKICByZXR1cm4geDIgPCAwID8gLTEgOiAxOwp9CmZ1bmN0aW9uIHNsb3BlMyh0aGF0LCB4MiwgeTIpIHsKICB2YXIgaDAgPSB0aGF0Ll94MSAtIHRoYXQuX3gwLCBoMSA9IHgyIC0gdGhhdC5feDEsIHMwID0gKHRoYXQuX3kxIC0gdGhhdC5feTApIC8gKGgwIHx8IGgxIDwgMCAmJiAtMCksIHMxID0gKHkyIC0gdGhhdC5feTEpIC8gKGgxIHx8IGgwIDwgMCAmJiAtMCksIHAgPSAoczAgKiBoMSArIHMxICogaDApIC8gKGgwICsgaDEpOwogIHJldHVybiAoc2lnbihzMCkgKyBzaWduKHMxKSkgKiBNYXRoLm1pbihNYXRoLmFicyhzMCksIE1hdGguYWJzKHMxKSwgMC41ICogTWF0aC5hYnMocCkpIHx8IDA7Cn0KZnVuY3Rpb24gc2xvcGUyKHRoYXQsIHQpIHsKICB2YXIgaCA9IHRoYXQuX3gxIC0gdGhhdC5feDA7CiAgcmV0dXJuIGggPyAoMyAqICh0aGF0Ll95MSAtIHRoYXQuX3kwKSAvIGggLSB0KSAvIDIgOiB0Owp9CmZ1bmN0aW9uIHBvaW50Mih0aGF0LCB0MDIsIHQxMikgewogIHZhciB4MCA9IHRoYXQuX3gwLCB5MCA9IHRoYXQuX3kwLCB4MSA9IHRoYXQuX3gxLCB5MSA9IHRoYXQuX3kxLCBkeCA9ICh4MSAtIHgwKSAvIDM7CiAgdGhhdC5fY29udGV4dC5iZXppZXJDdXJ2ZVRvKHgwICsgZHgsIHkwICsgZHggKiB0MDIsIHgxIC0gZHgsIHkxIC0gZHggKiB0MTIsIHgxLCB5MSk7Cn0KZnVuY3Rpb24gTW9ub3RvbmVYKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gY29udGV4dDsKfQpNb25vdG9uZVgucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9LAogIGFyZWFFbmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxID0gdGhpcy5feTAgPSB0aGlzLl95MSA9IHRoaXMuX3QwID0gTmFOOwogICAgdGhpcy5fcG9pbnQgPSAwOwogIH0sCiAgbGluZUVuZDogZnVuY3Rpb24oKSB7CiAgICBzd2l0Y2ggKHRoaXMuX3BvaW50KSB7CiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbyh0aGlzLl94MSwgdGhpcy5feTEpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlIDM6CiAgICAgICAgcG9pbnQyKHRoaXMsIHRoaXMuX3QwLCBzbG9wZTIodGhpcywgdGhpcy5fdDApKTsKICAgICAgICBicmVhazsKICAgIH0KICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgdGhpcy5fcG9pbnQgPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB0aGlzLl9saW5lID0gMSAtIHRoaXMuX2xpbmU7CiAgfSwKICBwb2ludDogZnVuY3Rpb24oeDIsIHkyKSB7CiAgICB2YXIgdDEyID0gTmFOOwogICAgeDIgPSAreDIsIHkyID0gK3kyOwogICAgaWYgKHgyID09PSB0aGlzLl94MSAmJiB5MiA9PT0gdGhpcy5feTEpIHJldHVybjsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMuX3BvaW50ID0gMTsKICAgICAgICB0aGlzLl9saW5lID8gdGhpcy5fY29udGV4dC5saW5lVG8oeDIsIHkyKSA6IHRoaXMuX2NvbnRleHQubW92ZVRvKHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLl9wb2ludCA9IDI7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMjoKICAgICAgICB0aGlzLl9wb2ludCA9IDM7CiAgICAgICAgcG9pbnQyKHRoaXMsIHNsb3BlMih0aGlzLCB0MTIgPSBzbG9wZTModGhpcywgeDIsIHkyKSksIHQxMik7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcG9pbnQyKHRoaXMsIHRoaXMuX3QwLCB0MTIgPSBzbG9wZTModGhpcywgeDIsIHkyKSk7CiAgICAgICAgYnJlYWs7CiAgICB9CiAgICB0aGlzLl94MCA9IHRoaXMuX3gxLCB0aGlzLl94MSA9IHgyOwogICAgdGhpcy5feTAgPSB0aGlzLl95MSwgdGhpcy5feTEgPSB5MjsKICAgIHRoaXMuX3QwID0gdDEyOwogIH0KfTsKZnVuY3Rpb24gTW9ub3RvbmVZKGNvbnRleHQpIHsKICB0aGlzLl9jb250ZXh0ID0gbmV3IFJlZmxlY3RDb250ZXh0KGNvbnRleHQpOwp9CihNb25vdG9uZVkucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShNb25vdG9uZVgucHJvdG90eXBlKSkucG9pbnQgPSBmdW5jdGlvbih4MiwgeTIpIHsKICBNb25vdG9uZVgucHJvdG90eXBlLnBvaW50LmNhbGwodGhpcywgeTIsIHgyKTsKfTsKZnVuY3Rpb24gUmVmbGVjdENvbnRleHQoY29udGV4dCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0Owp9ClJlZmxlY3RDb250ZXh0LnByb3RvdHlwZSA9IHsKICBtb3ZlVG86IGZ1bmN0aW9uKHgyLCB5MikgewogICAgdGhpcy5fY29udGV4dC5tb3ZlVG8oeTIsIHgyKTsKICB9LAogIGNsb3NlUGF0aDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogIH0sCiAgbGluZVRvOiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHkyLCB4Mik7CiAgfSwKICBiZXppZXJDdXJ2ZVRvOiBmdW5jdGlvbih4MSwgeTEsIHgyLCB5MiwgeDMsIHkzKSB7CiAgICB0aGlzLl9jb250ZXh0LmJlemllckN1cnZlVG8oeTEsIHgxLCB5MiwgeDIsIHkzLCB4Myk7CiAgfQp9OwpmdW5jdGlvbiBtb25vdG9uZVgoY29udGV4dCkgewogIHJldHVybiBuZXcgTW9ub3RvbmVYKGNvbnRleHQpOwp9CmZ1bmN0aW9uIG1vbm90b25lWShjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBNb25vdG9uZVkoY29udGV4dCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL2N1cnZlL25hdHVyYWwuanMKZnVuY3Rpb24gTmF0dXJhbChjb250ZXh0KSB7CiAgdGhpcy5fY29udGV4dCA9IGNvbnRleHQ7Cn0KTmF0dXJhbC5wcm90b3R5cGUgPSB7CiAgYXJlYVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX2xpbmUgPSAwOwogIH0sCiAgYXJlYUVuZDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gTmFOOwogIH0sCiAgbGluZVN0YXJ0OiBmdW5jdGlvbigpIHsKICAgIHRoaXMuX3ggPSBbXTsKICAgIHRoaXMuX3kgPSBbXTsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgdmFyIHgyID0gdGhpcy5feCwgeTIgPSB0aGlzLl95LCBuID0geDIubGVuZ3RoOwogICAgaWYgKG4pIHsKICAgICAgdGhpcy5fbGluZSA/IHRoaXMuX2NvbnRleHQubGluZVRvKHgyWzBdLCB5MlswXSkgOiB0aGlzLl9jb250ZXh0Lm1vdmVUbyh4MlswXSwgeTJbMF0pOwogICAgICBpZiAobiA9PT0gMikgewogICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHgyWzFdLCB5MlsxXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIHB4ID0gY29udHJvbFBvaW50cyh4MiksIHB5ID0gY29udHJvbFBvaW50cyh5Mik7CiAgICAgICAgZm9yICh2YXIgaTAgPSAwLCBpMSA9IDE7IGkxIDwgbjsgKytpMCwgKytpMSkgewogICAgICAgICAgdGhpcy5fY29udGV4dC5iZXppZXJDdXJ2ZVRvKHB4WzBdW2kwXSwgcHlbMF1baTBdLCBweFsxXVtpMF0sIHB5WzFdW2kwXSwgeDJbaTFdLCB5MltpMV0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogICAgaWYgKHRoaXMuX2xpbmUgfHwgdGhpcy5fbGluZSAhPT0gMCAmJiBuID09PSAxKSB0aGlzLl9jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgdGhpcy5fbGluZSA9IDEgLSB0aGlzLl9saW5lOwogICAgdGhpcy5feCA9IHRoaXMuX3kgPSBudWxsOwogIH0sCiAgcG9pbnQ6IGZ1bmN0aW9uKHgyLCB5MikgewogICAgdGhpcy5feC5wdXNoKCt4Mik7CiAgICB0aGlzLl95LnB1c2goK3kyKTsKICB9Cn07CmZ1bmN0aW9uIGNvbnRyb2xQb2ludHMoeDIpIHsKICB2YXIgaSwgbiA9IHgyLmxlbmd0aCAtIDEsIG0sIGEgPSBuZXcgQXJyYXkobiksIGIgPSBuZXcgQXJyYXkobiksIHIyID0gbmV3IEFycmF5KG4pOwogIGFbMF0gPSAwLCBiWzBdID0gMiwgcjJbMF0gPSB4MlswXSArIDIgKiB4MlsxXTsKICBmb3IgKGkgPSAxOyBpIDwgbiAtIDE7ICsraSkgYVtpXSA9IDEsIGJbaV0gPSA0LCByMltpXSA9IDQgKiB4MltpXSArIDIgKiB4MltpICsgMV07CiAgYVtuIC0gMV0gPSAyLCBiW24gLSAxXSA9IDcsIHIyW24gLSAxXSA9IDggKiB4MltuIC0gMV0gKyB4MltuXTsKICBmb3IgKGkgPSAxOyBpIDwgbjsgKytpKSBtID0gYVtpXSAvIGJbaSAtIDFdLCBiW2ldIC09IG0sIHIyW2ldIC09IG0gKiByMltpIC0gMV07CiAgYVtuIC0gMV0gPSByMltuIC0gMV0gLyBiW24gLSAxXTsKICBmb3IgKGkgPSBuIC0gMjsgaSA+PSAwOyAtLWkpIGFbaV0gPSAocjJbaV0gLSBhW2kgKyAxXSkgLyBiW2ldOwogIGJbbiAtIDFdID0gKHgyW25dICsgYVtuIC0gMV0pIC8gMjsKICBmb3IgKGkgPSAwOyBpIDwgbiAtIDE7ICsraSkgYltpXSA9IDIgKiB4MltpICsgMV0gLSBhW2kgKyAxXTsKICByZXR1cm4gW2EsIGJdOwp9CmZ1bmN0aW9uIG5hdHVyYWxfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBOYXR1cmFsKGNvbnRleHQpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9jdXJ2ZS9zdGVwLmpzCmZ1bmN0aW9uIFN0ZXAoY29udGV4dCwgdCkgewogIHRoaXMuX2NvbnRleHQgPSBjb250ZXh0OwogIHRoaXMuX3QgPSB0Owp9ClN0ZXAucHJvdG90eXBlID0gewogIGFyZWFTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl9saW5lID0gMDsKICB9LAogIGFyZWFFbmQ6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5fbGluZSA9IE5hTjsKICB9LAogIGxpbmVTdGFydDogZnVuY3Rpb24oKSB7CiAgICB0aGlzLl94ID0gdGhpcy5feSA9IE5hTjsKICAgIHRoaXMuX3BvaW50ID0gMDsKICB9LAogIGxpbmVFbmQ6IGZ1bmN0aW9uKCkgewogICAgaWYgKDAgPCB0aGlzLl90ICYmIHRoaXMuX3QgPCAxICYmIHRoaXMuX3BvaW50ID09PSAyKSB0aGlzLl9jb250ZXh0LmxpbmVUbyh0aGlzLl94LCB0aGlzLl95KTsKICAgIGlmICh0aGlzLl9saW5lIHx8IHRoaXMuX2xpbmUgIT09IDAgJiYgdGhpcy5fcG9pbnQgPT09IDEpIHRoaXMuX2NvbnRleHQuY2xvc2VQYXRoKCk7CiAgICBpZiAodGhpcy5fbGluZSA+PSAwKSB0aGlzLl90ID0gMSAtIHRoaXMuX3QsIHRoaXMuX2xpbmUgPSAxIC0gdGhpcy5fbGluZTsKICB9LAogIHBvaW50OiBmdW5jdGlvbih4MiwgeTIpIHsKICAgIHgyID0gK3gyLCB5MiA9ICt5MjsKICAgIHN3aXRjaCAodGhpcy5fcG9pbnQpIHsKICAgICAgY2FzZSAwOgogICAgICAgIHRoaXMuX3BvaW50ID0gMTsKICAgICAgICB0aGlzLl9saW5lID8gdGhpcy5fY29udGV4dC5saW5lVG8oeDIsIHkyKSA6IHRoaXMuX2NvbnRleHQubW92ZVRvKHgyLCB5Mik7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgMToKICAgICAgICB0aGlzLl9wb2ludCA9IDI7CiAgICAgIGRlZmF1bHQ6IHsKICAgICAgICBpZiAodGhpcy5fdCA8PSAwKSB7CiAgICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbyh0aGlzLl94LCB5Mik7CiAgICAgICAgICB0aGlzLl9jb250ZXh0LmxpbmVUbyh4MiwgeTIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgeDEgPSB0aGlzLl94ICogKDEgLSB0aGlzLl90KSArIHgyICogdGhpcy5fdDsKICAgICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHgxLCB0aGlzLl95KTsKICAgICAgICAgIHRoaXMuX2NvbnRleHQubGluZVRvKHgxLCB5Mik7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICB0aGlzLl94ID0geDIsIHRoaXMuX3kgPSB5MjsKICB9Cn07CmZ1bmN0aW9uIHN0ZXBfZGVmYXVsdChjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBTdGVwKGNvbnRleHQsIDAuNSk7Cn0KZnVuY3Rpb24gc3RlcEJlZm9yZShjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBTdGVwKGNvbnRleHQsIDApOwp9CmZ1bmN0aW9uIHN0ZXBBZnRlcihjb250ZXh0KSB7CiAgcmV0dXJuIG5ldyBTdGVwKGNvbnRleHQsIDEpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9vZmZzZXQvbm9uZS5qcwpmdW5jdGlvbiBub25lX2RlZmF1bHQoc2VyaWVzLCBvcmRlcikgewogIGlmICghKChuID0gc2VyaWVzLmxlbmd0aCkgPiAxKSkgcmV0dXJuOwogIGZvciAodmFyIGkgPSAxLCBqLCBzMCwgczEgPSBzZXJpZXNbb3JkZXJbMF1dLCBuLCBtID0gczEubGVuZ3RoOyBpIDwgbjsgKytpKSB7CiAgICBzMCA9IHMxLCBzMSA9IHNlcmllc1tvcmRlcltpXV07CiAgICBmb3IgKGogPSAwOyBqIDwgbTsgKytqKSB7CiAgICAgIHMxW2pdWzFdICs9IHMxW2pdWzBdID0gaXNOYU4oczBbal1bMV0pID8gczBbal1bMF0gOiBzMFtqXVsxXTsKICAgIH0KICB9Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zaGFwZUAzLjIuMC9ub2RlX21vZHVsZXMvZDMtc2hhcGUvc3JjL29yZGVyL25vbmUuanMKZnVuY3Rpb24gbm9uZV9kZWZhdWx0MihzZXJpZXMpIHsKICB2YXIgbiA9IHNlcmllcy5sZW5ndGgsIG8gPSBuZXcgQXJyYXkobik7CiAgd2hpbGUgKC0tbiA+PSAwKSBvW25dID0gbjsKICByZXR1cm4gbzsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvc3RhY2suanMKZnVuY3Rpb24gc3RhY2tWYWx1ZShkLCBrZXkpIHsKICByZXR1cm4gZFtrZXldOwp9CmZ1bmN0aW9uIHN0YWNrU2VyaWVzKGtleSkgewogIGNvbnN0IHNlcmllcyA9IFtdOwogIHNlcmllcy5rZXkgPSBrZXk7CiAgcmV0dXJuIHNlcmllczsKfQpmdW5jdGlvbiBzdGFja19kZWZhdWx0KCkgewogIHZhciBrZXlzID0gY29uc3RhbnRfZGVmYXVsdChbXSksIG9yZGVyID0gbm9uZV9kZWZhdWx0Miwgb2Zmc2V0ID0gbm9uZV9kZWZhdWx0LCB2YWx1ZSA9IHN0YWNrVmFsdWU7CiAgZnVuY3Rpb24gc3RhY2soZGF0YSkgewogICAgdmFyIHN6ID0gQXJyYXkuZnJvbShrZXlzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyksIHN0YWNrU2VyaWVzKSwgaSwgbiA9IHN6Lmxlbmd0aCwgaiA9IC0xLCBvejsKICAgIGZvciAoY29uc3QgZCBvZiBkYXRhKSB7CiAgICAgIGZvciAoaSA9IDAsICsrajsgaSA8IG47ICsraSkgewogICAgICAgIChzeltpXVtqXSA9IFswLCArdmFsdWUoZCwgc3pbaV0ua2V5LCBqLCBkYXRhKV0pLmRhdGEgPSBkOwogICAgICB9CiAgICB9CiAgICBmb3IgKGkgPSAwLCBveiA9IGFycmF5X2RlZmF1bHQob3JkZXIoc3opKTsgaSA8IG47ICsraSkgewogICAgICBzeltveltpXV0uaW5kZXggPSBpOwogICAgfQogICAgb2Zmc2V0KHN6LCBveik7CiAgICByZXR1cm4gc3o7CiAgfQogIHN0YWNrLmtleXMgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChrZXlzID0gdHlwZW9mIF8gPT09ICJmdW5jdGlvbiIgPyBfIDogY29uc3RhbnRfZGVmYXVsdChBcnJheS5mcm9tKF8pKSwgc3RhY2spIDoga2V5czsKICB9OwogIHN0YWNrLnZhbHVlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodmFsdWUgPSB0eXBlb2YgXyA9PT0gImZ1bmN0aW9uIiA/IF8gOiBjb25zdGFudF9kZWZhdWx0KCtfKSwgc3RhY2spIDogdmFsdWU7CiAgfTsKICBzdGFjay5vcmRlciA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKG9yZGVyID0gXyA9PSBudWxsID8gbm9uZV9kZWZhdWx0MiA6IHR5cGVvZiBfID09PSAiZnVuY3Rpb24iID8gXyA6IGNvbnN0YW50X2RlZmF1bHQoQXJyYXkuZnJvbShfKSksIHN0YWNrKSA6IG9yZGVyOwogIH07CiAgc3RhY2sub2Zmc2V0ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAob2Zmc2V0ID0gXyA9PSBudWxsID8gbm9uZV9kZWZhdWx0IDogXywgc3RhY2spIDogb2Zmc2V0OwogIH07CiAgcmV0dXJuIHN0YWNrOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9vZmZzZXQvZXhwYW5kLmpzCmZ1bmN0aW9uIGV4cGFuZF9kZWZhdWx0KHNlcmllcywgb3JkZXIpIHsKICBpZiAoISgobiA9IHNlcmllcy5sZW5ndGgpID4gMCkpIHJldHVybjsKICBmb3IgKHZhciBpLCBuLCBqID0gMCwgbSA9IHNlcmllc1swXS5sZW5ndGgsIHkyOyBqIDwgbTsgKytqKSB7CiAgICBmb3IgKHkyID0gaSA9IDA7IGkgPCBuOyArK2kpIHkyICs9IHNlcmllc1tpXVtqXVsxXSB8fCAwOwogICAgaWYgKHkyKSBmb3IgKGkgPSAwOyBpIDwgbjsgKytpKSBzZXJpZXNbaV1bal1bMV0gLz0geTI7CiAgfQogIG5vbmVfZGVmYXVsdChzZXJpZXMsIG9yZGVyKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNoYXBlQDMuMi4wL25vZGVfbW9kdWxlcy9kMy1zaGFwZS9zcmMvb2Zmc2V0L3NpbGhvdWV0dGUuanMKZnVuY3Rpb24gc2lsaG91ZXR0ZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpIHsKICBpZiAoISgobiA9IHNlcmllcy5sZW5ndGgpID4gMCkpIHJldHVybjsKICBmb3IgKHZhciBqID0gMCwgczAgPSBzZXJpZXNbb3JkZXJbMF1dLCBuLCBtID0gczAubGVuZ3RoOyBqIDwgbTsgKytqKSB7CiAgICBmb3IgKHZhciBpID0gMCwgeTIgPSAwOyBpIDwgbjsgKytpKSB5MiArPSBzZXJpZXNbaV1bal1bMV0gfHwgMDsKICAgIHMwW2pdWzFdICs9IHMwW2pdWzBdID0gLXkyIC8gMjsKICB9CiAgbm9uZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2hhcGVAMy4yLjAvbm9kZV9tb2R1bGVzL2QzLXNoYXBlL3NyYy9vZmZzZXQvd2lnZ2xlLmpzCmZ1bmN0aW9uIHdpZ2dsZV9kZWZhdWx0KHNlcmllcywgb3JkZXIpIHsKICBpZiAoISgobiA9IHNlcmllcy5sZW5ndGgpID4gMCkgfHwgISgobSA9IChzMCA9IHNlcmllc1tvcmRlclswXV0pLmxlbmd0aCkgPiAwKSkgcmV0dXJuOwogIGZvciAodmFyIHkyID0gMCwgaiA9IDEsIHMwLCBtLCBuOyBqIDwgbTsgKytqKSB7CiAgICBmb3IgKHZhciBpID0gMCwgczEgPSAwLCBzMiA9IDA7IGkgPCBuOyArK2kpIHsKICAgICAgdmFyIHNpID0gc2VyaWVzW29yZGVyW2ldXSwgc2lqMCA9IHNpW2pdWzFdIHx8IDAsIHNpajEgPSBzaVtqIC0gMV1bMV0gfHwgMCwgczMgPSAoc2lqMCAtIHNpajEpIC8gMjsKICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBpOyArK2spIHsKICAgICAgICB2YXIgc2sgPSBzZXJpZXNbb3JkZXJba11dLCBza2owID0gc2tbal1bMV0gfHwgMCwgc2tqMSA9IHNrW2ogLSAxXVsxXSB8fCAwOwogICAgICAgIHMzICs9IHNrajAgLSBza2oxOwogICAgICB9CiAgICAgIHMxICs9IHNpajAsIHMyICs9IHMzICogc2lqMDsKICAgIH0KICAgIHMwW2ogLSAxXVsxXSArPSBzMFtqIC0gMV1bMF0gPSB5MjsKICAgIGlmIChzMSkgeTIgLT0gczIgLyBzMTsKICB9CiAgczBbaiAtIDFdWzFdICs9IHMwW2ogLSAxXVswXSA9IHkyOwogIG5vbmVfZGVmYXVsdChzZXJpZXMsIG9yZGVyKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9EYXRhVXRpbHMuanMKdmFyIGltcG9ydF9nZXQgPSBfX3RvRVNNKHJlcXVpcmVfZ2V0MigpKTsKdmFyIG1hdGhTaWduID0gKHZhbHVlKSA9PiB7CiAgaWYgKHZhbHVlID09PSAwKSB7CiAgICByZXR1cm4gMDsKICB9CiAgaWYgKHZhbHVlID4gMCkgewogICAgcmV0dXJuIDE7CiAgfQogIHJldHVybiAtMTsKfTsKdmFyIGlzTmFuID0gKHZhbHVlKSA9PiB7CiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PSAibnVtYmVyIiAmJiB2YWx1ZSAhPSArdmFsdWU7Cn07CnZhciBpc1BlcmNlbnQgPSAodmFsdWUpID0+IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiJSIpID09PSB2YWx1ZS5sZW5ndGggLSAxOwp2YXIgaXNOdW1iZXIgPSAodmFsdWUpID0+ICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiIHx8IHZhbHVlIGluc3RhbmNlb2YgTnVtYmVyKSAmJiAhaXNOYW4odmFsdWUpOwp2YXIgaXNOdW1PclN0ciA9ICh2YWx1ZSkgPT4gaXNOdW1iZXIodmFsdWUpIHx8IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyI7CnZhciBpZENvdW50ZXIgPSAwOwp2YXIgdW5pcXVlSWQgPSAocHJlZml4KSA9PiB7CiAgdmFyIGlkID0gKytpZENvdW50ZXI7CiAgcmV0dXJuICIiLmNvbmNhdChwcmVmaXggfHwgIiIpLmNvbmNhdChpZCk7Cn07CnZhciBnZXRQZXJjZW50VmFsdWUgPSBmdW5jdGlvbiBnZXRQZXJjZW50VmFsdWUyKHBlcmNlbnQsIHRvdGFsVmFsdWUpIHsKICB2YXIgZGVmYXVsdFZhbHVlID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiAwOwogIHZhciB2YWxpZGF0ZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAzICYmIGFyZ3VtZW50c1szXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzNdIDogZmFsc2U7CiAgaWYgKCFpc051bWJlcihwZXJjZW50KSAmJiB0eXBlb2YgcGVyY2VudCAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgfQogIHZhciB2YWx1ZTsKICBpZiAoaXNQZXJjZW50KHBlcmNlbnQpKSB7CiAgICBpZiAodG90YWxWYWx1ZSA9PSBudWxsKSB7CiAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7CiAgICB9CiAgICB2YXIgaW5kZXggPSBwZXJjZW50LmluZGV4T2YoIiUiKTsKICAgIHZhbHVlID0gdG90YWxWYWx1ZSAqIHBhcnNlRmxvYXQocGVyY2VudC5zbGljZSgwLCBpbmRleCkpIC8gMTAwOwogIH0gZWxzZSB7CiAgICB2YWx1ZSA9ICtwZXJjZW50OwogIH0KICBpZiAoaXNOYW4odmFsdWUpKSB7CiAgICB2YWx1ZSA9IGRlZmF1bHRWYWx1ZTsKICB9CiAgaWYgKHZhbGlkYXRlICYmIHRvdGFsVmFsdWUgIT0gbnVsbCAmJiB2YWx1ZSA+IHRvdGFsVmFsdWUpIHsKICAgIHZhbHVlID0gdG90YWxWYWx1ZTsKICB9CiAgcmV0dXJuIHZhbHVlOwp9Owp2YXIgaGFzRHVwbGljYXRlID0gKGFyeSkgPT4gewogIGlmICghQXJyYXkuaXNBcnJheShhcnkpKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHZhciBsZW4gPSBhcnkubGVuZ3RoOwogIHZhciBjYWNoZSA9IHt9OwogIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgIGlmICghY2FjaGVbYXJ5W2ldXSkgewogICAgICBjYWNoZVthcnlbaV1dID0gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn07CmZ1bmN0aW9uIGludGVycG9sYXRlKHN0YXJ0LCBlbmQsIHQpIHsKICBpZiAoaXNOdW1iZXIoc3RhcnQpICYmIGlzTnVtYmVyKGVuZCkpIHsKICAgIHJldHVybiBzdGFydCArIHQgKiAoZW5kIC0gc3RhcnQpOwogIH0KICByZXR1cm4gZW5kOwp9CmZ1bmN0aW9uIGZpbmRFbnRyeUluQXJyYXkoYXJ5LCBzcGVjaWZpZWRLZXksIHNwZWNpZmllZFZhbHVlKSB7CiAgaWYgKCFhcnkgfHwgIWFyeS5sZW5ndGgpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBhcnkuZmluZCgoZW50cnkpID0+IGVudHJ5ICYmICh0eXBlb2Ygc3BlY2lmaWVkS2V5ID09PSAiZnVuY3Rpb24iID8gc3BlY2lmaWVkS2V5KGVudHJ5KSA6ICgwLCBpbXBvcnRfZ2V0LmRlZmF1bHQpKGVudHJ5LCBzcGVjaWZpZWRLZXkpKSA9PT0gc3BlY2lmaWVkVmFsdWUpOwp9CnZhciBpc051bGxpc2ggPSAodmFsdWUpID0+IHsKICByZXR1cm4gdmFsdWUgPT09IG51bGwgfHwgdHlwZW9mIHZhbHVlID09PSAidW5kZWZpbmVkIjsKfTsKdmFyIHVwcGVyRmlyc3QgPSAodmFsdWUpID0+IHsKICBpZiAoaXNOdWxsaXNoKHZhbHVlKSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KICByZXR1cm4gIiIuY29uY2F0KHZhbHVlLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpKS5jb25jYXQodmFsdWUuc2xpY2UoMSkpOwp9OwpmdW5jdGlvbiBpc05vdE5pbCh2YWx1ZSkgewogIHJldHVybiB2YWx1ZSAhPSBudWxsOwp9CmZ1bmN0aW9uIG5vb3AoKSB7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdHlwZXMuanMKdmFyIGltcG9ydF9yZWFjdDcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpc1BvbGFyQ29vcmRpbmF0ZSA9IChjKSA9PiB7CiAgcmV0dXJuICJyYWRpdXMiIGluIGMgJiYgInN0YXJ0QW5nbGUiIGluIGMgJiYgImVuZEFuZ2xlIiBpbiBjOwp9Owp2YXIgYWRhcHRFdmVudEhhbmRsZXJzID0gKHByb3BzLCBuZXdIYW5kbGVyKSA9PiB7CiAgaWYgKCFwcm9wcyB8fCB0eXBlb2YgcHJvcHMgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIHByb3BzID09PSAiYm9vbGVhbiIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgaW5wdXRQcm9wcyA9IHByb3BzOwogIGlmICgvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDcuaXNWYWxpZEVsZW1lbnQpKHByb3BzKSkgewogICAgaW5wdXRQcm9wcyA9IHByb3BzLnByb3BzOwogIH0KICBpZiAodHlwZW9mIGlucHV0UHJvcHMgIT09ICJvYmplY3QiICYmIHR5cGVvZiBpbnB1dFByb3BzICE9PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIG91dCA9IHt9OwogIE9iamVjdC5rZXlzKGlucHV0UHJvcHMpLmZvckVhY2goKGtleSkgPT4gewogICAgaWYgKGlzRXZlbnRLZXkoa2V5KSkgewogICAgICBvdXRba2V5XSA9IG5ld0hhbmRsZXIgfHwgKChlKSA9PiBpbnB1dFByb3BzW2tleV0oaW5wdXRQcm9wcywgZSkpOwogICAgfQogIH0pOwogIHJldHVybiBvdXQ7Cn07CnZhciBnZXRFdmVudEhhbmRsZXJPZkNoaWxkID0gKG9yaWdpbmFsSGFuZGxlciwgZGF0YSwgaW5kZXgpID0+IChlKSA9PiB7CiAgb3JpZ2luYWxIYW5kbGVyKGRhdGEsIGluZGV4LCBlKTsKICByZXR1cm4gbnVsbDsKfTsKdmFyIGFkYXB0RXZlbnRzT2ZDaGlsZCA9IChwcm9wcywgZGF0YSwgaW5kZXgpID0+IHsKICBpZiAocHJvcHMgPT09IG51bGwgfHwgdHlwZW9mIHByb3BzICE9PSAib2JqZWN0IiAmJiB0eXBlb2YgcHJvcHMgIT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgb3V0ID0gbnVsbDsKICBPYmplY3Qua2V5cyhwcm9wcykuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICB2YXIgaXRlbSA9IHByb3BzW2tleV07CiAgICBpZiAoaXNFdmVudEtleShrZXkpICYmIHR5cGVvZiBpdGVtID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGlmICghb3V0KSBvdXQgPSB7fTsKICAgICAgb3V0W2tleV0gPSBnZXRFdmVudEhhbmRsZXJPZkNoaWxkKGl0ZW0sIGRhdGEsIGluZGV4KTsKICAgIH0KICB9KTsKICByZXR1cm4gb3V0Owp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9yZXNvbHZlRGVmYXVsdFByb3BzLmpzCmZ1bmN0aW9uIG93bktleXMoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gcmVzb2x2ZURlZmF1bHRQcm9wcyhyZWFsUHJvcHMsIGRlZmF1bHRQcm9wcykgewogIHZhciByZXNvbHZlZFByb3BzID0gX29iamVjdFNwcmVhZCh7fSwgcmVhbFByb3BzKTsKICB2YXIgZHAgPSBkZWZhdWx0UHJvcHM7CiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhkZWZhdWx0UHJvcHMpOwogIHZhciB3aXRoRGVmYXVsdHMgPSBrZXlzLnJlZHVjZSgoYWNjLCBrZXkpID0+IHsKICAgIGlmIChhY2Nba2V5XSA9PT0gdm9pZCAwICYmIGRwW2tleV0gIT09IHZvaWQgMCkgewogICAgICBhY2Nba2V5XSA9IGRwW2tleV07CiAgICB9CiAgICByZXR1cm4gYWNjOwogIH0sIHJlc29sdmVkUHJvcHMpOwogIHJldHVybiB3aXRoRGVmYXVsdHM7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvcGF5bG9hZC9nZXRVbmlxUGF5bG9hZC5qcwp2YXIgaW1wb3J0X3VuaXFCeSA9IF9fdG9FU00ocmVxdWlyZV91bmlxQnkzKCkpOwpmdW5jdGlvbiBnZXRVbmlxUGF5bG9hZChwYXlsb2FkLCBvcHRpb24sIGRlZmF1bHRVbmlxQnkyKSB7CiAgaWYgKG9wdGlvbiA9PT0gdHJ1ZSkgewogICAgcmV0dXJuICgwLCBpbXBvcnRfdW5pcUJ5LmRlZmF1bHQpKHBheWxvYWQsIGRlZmF1bHRVbmlxQnkyKTsKICB9CiAgaWYgKHR5cGVvZiBvcHRpb24gPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiAoMCwgaW1wb3J0X3VuaXFCeS5kZWZhdWx0KShwYXlsb2FkLCBvcHRpb24pOwogIH0KICByZXR1cm4gcGF5bG9hZDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvaG9va3MuanMKdmFyIGltcG9ydF93aXRoX3NlbGVjdG9yID0gX190b0VTTShyZXF1aXJlX3dpdGhfc2VsZWN0b3IoKSk7CnZhciBpbXBvcnRfcmVhY3Q5ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvUmVjaGFydHNSZWR1eENvbnRleHQuanMKdmFyIGltcG9ydF9yZWFjdDggPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBSZWNoYXJ0c1JlZHV4Q29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0OC5jcmVhdGVDb250ZXh0KShudWxsKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2hvb2tzLmpzCnZhciBub29wRGlzcGF0Y2ggPSAoYSkgPT4gYTsKdmFyIHVzZUFwcERpc3BhdGNoID0gKCkgPT4gewogIHZhciBjb250ZXh0ID0gKDAsIGltcG9ydF9yZWFjdDkudXNlQ29udGV4dCkoUmVjaGFydHNSZWR1eENvbnRleHQpOwogIGlmIChjb250ZXh0KSB7CiAgICByZXR1cm4gY29udGV4dC5zdG9yZS5kaXNwYXRjaDsKICB9CiAgcmV0dXJuIG5vb3BEaXNwYXRjaDsKfTsKdmFyIG5vb3AyID0gKCkgPT4gewp9Owp2YXIgYWRkTmVzdGVkU3ViTm9vcCA9ICgpID0+IG5vb3AyOwp2YXIgcmVmRXF1YWxpdHkgPSAoYSwgYikgPT4gYSA9PT0gYjsKZnVuY3Rpb24gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0b3IpIHsKICB2YXIgY29udGV4dCA9ICgwLCBpbXBvcnRfcmVhY3Q5LnVzZUNvbnRleHQpKFJlY2hhcnRzUmVkdXhDb250ZXh0KTsKICByZXR1cm4gKDAsIGltcG9ydF93aXRoX3NlbGVjdG9yLnVzZVN5bmNFeHRlcm5hbFN0b3JlV2l0aFNlbGVjdG9yKShjb250ZXh0ID8gY29udGV4dC5zdWJzY3JpcHRpb24uYWRkTmVzdGVkU3ViIDogYWRkTmVzdGVkU3ViTm9vcCwgY29udGV4dCA/IGNvbnRleHQuc3RvcmUuZ2V0U3RhdGUgOiBub29wMiwgY29udGV4dCA/IGNvbnRleHQuc3RvcmUuZ2V0U3RhdGUgOiBub29wMiwgY29udGV4dCA/IHNlbGVjdG9yIDogbm9vcDIsIHJlZkVxdWFsaXR5KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3Jlc2VsZWN0QDUuMS4xL25vZGVfbW9kdWxlcy9yZXNlbGVjdC9kaXN0L3Jlc2VsZWN0Lm1qcwp2YXIgcnVuSWRlbnRpdHlGdW5jdGlvbkNoZWNrID0gKHJlc3VsdEZ1bmMsIGlucHV0U2VsZWN0b3JzUmVzdWx0cywgb3V0cHV0U2VsZWN0b3JSZXN1bHQpID0+IHsKICBpZiAoaW5wdXRTZWxlY3RvcnNSZXN1bHRzLmxlbmd0aCA9PT0gMSAmJiBpbnB1dFNlbGVjdG9yc1Jlc3VsdHNbMF0gPT09IG91dHB1dFNlbGVjdG9yUmVzdWx0KSB7CiAgICBsZXQgaXNJbnB1dFNhbWVBc091dHB1dCA9IGZhbHNlOwogICAgdHJ5IHsKICAgICAgY29uc3QgZW1wdHlPYmplY3QgPSB7fTsKICAgICAgaWYgKHJlc3VsdEZ1bmMoZW1wdHlPYmplY3QpID09PSBlbXB0eU9iamVjdCkKICAgICAgICBpc0lucHV0U2FtZUFzT3V0cHV0ID0gdHJ1ZTsKICAgIH0gY2F0Y2ggewogICAgfQogICAgaWYgKGlzSW5wdXRTYW1lQXNPdXRwdXQpIHsKICAgICAgbGV0IHN0YWNrID0gdm9pZCAwOwogICAgICB0cnkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgOwogICAgICAgICh7IHN0YWNrIH0gPSBlKTsKICAgICAgfQogICAgICBjb25zb2xlLndhcm4oCiAgICAgICAgIlRoZSByZXN1bHQgZnVuY3Rpb24gcmV0dXJuZWQgaXRzIG93biBpbnB1dHMgd2l0aG91dCBtb2RpZmljYXRpb24uIGUuZ1xuYGNyZWF0ZVNlbGVjdG9yKFtzdGF0ZSA9PiBzdGF0ZS50b2Rvc10sIHRvZG9zID0+IHRvZG9zKWBcblRoaXMgY291bGQgbGVhZCB0byBpbmVmZmljaWVudCBtZW1vaXphdGlvbiBhbmQgdW5uZWNlc3NhcnkgcmUtcmVuZGVycy5cbkVuc3VyZSB0cmFuc2Zvcm1hdGlvbiBsb2dpYyBpcyBpbiB0aGUgcmVzdWx0IGZ1bmN0aW9uLCBhbmQgZXh0cmFjdGlvbiBsb2dpYyBpcyBpbiB0aGUgaW5wdXQgc2VsZWN0b3JzLiIsCiAgICAgICAgeyBzdGFjayB9CiAgICAgICk7CiAgICB9CiAgfQp9Owp2YXIgcnVuSW5wdXRTdGFiaWxpdHlDaGVjayA9IChpbnB1dFNlbGVjdG9yUmVzdWx0c09iamVjdCwgb3B0aW9ucywgaW5wdXRTZWxlY3RvckFyZ3MpID0+IHsKICBjb25zdCB7IG1lbW9pemUsIG1lbW9pemVPcHRpb25zIH0gPSBvcHRpb25zOwogIGNvbnN0IHsgaW5wdXRTZWxlY3RvclJlc3VsdHMsIGlucHV0U2VsZWN0b3JSZXN1bHRzQ29weSB9ID0gaW5wdXRTZWxlY3RvclJlc3VsdHNPYmplY3Q7CiAgY29uc3QgY3JlYXRlQW5FbXB0eU9iamVjdCA9IG1lbW9pemUoKCkgPT4gKHt9KSwgLi4ubWVtb2l6ZU9wdGlvbnMpOwogIGNvbnN0IGFyZUlucHV0U2VsZWN0b3JSZXN1bHRzRXF1YWwgPSBjcmVhdGVBbkVtcHR5T2JqZWN0LmFwcGx5KG51bGwsIGlucHV0U2VsZWN0b3JSZXN1bHRzKSA9PT0gY3JlYXRlQW5FbXB0eU9iamVjdC5hcHBseShudWxsLCBpbnB1dFNlbGVjdG9yUmVzdWx0c0NvcHkpOwogIGlmICghYXJlSW5wdXRTZWxlY3RvclJlc3VsdHNFcXVhbCkgewogICAgbGV0IHN0YWNrID0gdm9pZCAwOwogICAgdHJ5IHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIDsKICAgICAgKHsgc3RhY2sgfSA9IGUpOwogICAgfQogICAgY29uc29sZS53YXJuKAogICAgICAiQW4gaW5wdXQgc2VsZWN0b3IgcmV0dXJuZWQgYSBkaWZmZXJlbnQgcmVzdWx0IHdoZW4gcGFzc2VkIHNhbWUgYXJndW1lbnRzLlxuVGhpcyBtZWFucyB5b3VyIG91dHB1dCBzZWxlY3RvciB3aWxsIGxpa2VseSBydW4gbW9yZSBmcmVxdWVudGx5IHRoYW4gaW50ZW5kZWQuXG5Bdm9pZCByZXR1cm5pbmcgYSBuZXcgcmVmZXJlbmNlIGluc2lkZSB5b3VyIGlucHV0IHNlbGVjdG9yLCBlLmcuXG5gY3JlYXRlU2VsZWN0b3IoW3N0YXRlID0+IHN0YXRlLnRvZG9zLm1hcCh0b2RvID0+IHRvZG8uaWQpXSwgdG9kb0lkcyA9PiB0b2RvSWRzLmxlbmd0aClgIiwKICAgICAgewogICAgICAgIGFyZ3VtZW50czogaW5wdXRTZWxlY3RvckFyZ3MsCiAgICAgICAgZmlyc3RJbnB1dHM6IGlucHV0U2VsZWN0b3JSZXN1bHRzLAogICAgICAgIHNlY29uZElucHV0czogaW5wdXRTZWxlY3RvclJlc3VsdHNDb3B5LAogICAgICAgIHN0YWNrCiAgICAgIH0KICAgICk7CiAgfQp9Owp2YXIgZ2xvYmFsRGV2TW9kZUNoZWNrcyA9IHsKICBpbnB1dFN0YWJpbGl0eUNoZWNrOiAib25jZSIsCiAgaWRlbnRpdHlGdW5jdGlvbkNoZWNrOiAib25jZSIKfTsKZnVuY3Rpb24gYXNzZXJ0SXNGdW5jdGlvbihmdW5jLCBlcnJvck1lc3NhZ2UgPSBgZXhwZWN0ZWQgYSBmdW5jdGlvbiwgaW5zdGVhZCByZWNlaXZlZCAke3R5cGVvZiBmdW5jfWApIHsKICBpZiAodHlwZW9mIGZ1bmMgIT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoZXJyb3JNZXNzYWdlKTsKICB9Cn0KZnVuY3Rpb24gYXNzZXJ0SXNPYmplY3Qob2JqZWN0LCBlcnJvck1lc3NhZ2UgPSBgZXhwZWN0ZWQgYW4gb2JqZWN0LCBpbnN0ZWFkIHJlY2VpdmVkICR7dHlwZW9mIG9iamVjdH1gKSB7CiAgaWYgKHR5cGVvZiBvYmplY3QgIT09ICJvYmplY3QiKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGVycm9yTWVzc2FnZSk7CiAgfQp9CmZ1bmN0aW9uIGFzc2VydElzQXJyYXlPZkZ1bmN0aW9ucyhhcnJheSwgZXJyb3JNZXNzYWdlID0gYGV4cGVjdGVkIGFsbCBpdGVtcyB0byBiZSBmdW5jdGlvbnMsIGluc3RlYWQgcmVjZWl2ZWQgdGhlIGZvbGxvd2luZyB0eXBlczogYCkgewogIGlmICghYXJyYXkuZXZlcnkoKGl0ZW0pID0+IHR5cGVvZiBpdGVtID09PSAiZnVuY3Rpb24iKSkgewogICAgY29uc3QgaXRlbVR5cGVzID0gYXJyYXkubWFwKAogICAgICAoaXRlbSkgPT4gdHlwZW9mIGl0ZW0gPT09ICJmdW5jdGlvbiIgPyBgZnVuY3Rpb24gJHtpdGVtLm5hbWUgfHwgInVubmFtZWQifSgpYCA6IHR5cGVvZiBpdGVtCiAgICApLmpvaW4oIiwgIik7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKGAke2Vycm9yTWVzc2FnZX1bJHtpdGVtVHlwZXN9XWApOwogIH0KfQp2YXIgZW5zdXJlSXNBcnJheSA9IChpdGVtKSA9PiB7CiAgcmV0dXJuIEFycmF5LmlzQXJyYXkoaXRlbSkgPyBpdGVtIDogW2l0ZW1dOwp9OwpmdW5jdGlvbiBnZXREZXBlbmRlbmNpZXMoY3JlYXRlU2VsZWN0b3JBcmdzKSB7CiAgY29uc3QgZGVwZW5kZW5jaWVzID0gQXJyYXkuaXNBcnJheShjcmVhdGVTZWxlY3RvckFyZ3NbMF0pID8gY3JlYXRlU2VsZWN0b3JBcmdzWzBdIDogY3JlYXRlU2VsZWN0b3JBcmdzOwogIGFzc2VydElzQXJyYXlPZkZ1bmN0aW9ucygKICAgIGRlcGVuZGVuY2llcywKICAgIGBjcmVhdGVTZWxlY3RvciBleHBlY3RzIGFsbCBpbnB1dC1zZWxlY3RvcnMgdG8gYmUgZnVuY3Rpb25zLCBidXQgcmVjZWl2ZWQgdGhlIGZvbGxvd2luZyB0eXBlczogYAogICk7CiAgcmV0dXJuIGRlcGVuZGVuY2llczsKfQpmdW5jdGlvbiBjb2xsZWN0SW5wdXRTZWxlY3RvclJlc3VsdHMoZGVwZW5kZW5jaWVzLCBpbnB1dFNlbGVjdG9yQXJncykgewogIGNvbnN0IGlucHV0U2VsZWN0b3JSZXN1bHRzID0gW107CiAgY29uc3QgeyBsZW5ndGggfSA9IGRlcGVuZGVuY2llczsKICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICBpbnB1dFNlbGVjdG9yUmVzdWx0cy5wdXNoKGRlcGVuZGVuY2llc1tpXS5hcHBseShudWxsLCBpbnB1dFNlbGVjdG9yQXJncykpOwogIH0KICByZXR1cm4gaW5wdXRTZWxlY3RvclJlc3VsdHM7Cn0KdmFyIGdldERldk1vZGVDaGVja3NFeGVjdXRpb25JbmZvID0gKGZpcnN0UnVuLCBkZXZNb2RlQ2hlY2tzKSA9PiB7CiAgY29uc3QgeyBpZGVudGl0eUZ1bmN0aW9uQ2hlY2ssIGlucHV0U3RhYmlsaXR5Q2hlY2sgfSA9IHsKICAgIC4uLmdsb2JhbERldk1vZGVDaGVja3MsCiAgICAuLi5kZXZNb2RlQ2hlY2tzCiAgfTsKICByZXR1cm4gewogICAgaWRlbnRpdHlGdW5jdGlvbkNoZWNrOiB7CiAgICAgIHNob3VsZFJ1bjogaWRlbnRpdHlGdW5jdGlvbkNoZWNrID09PSAiYWx3YXlzIiB8fCBpZGVudGl0eUZ1bmN0aW9uQ2hlY2sgPT09ICJvbmNlIiAmJiBmaXJzdFJ1biwKICAgICAgcnVuOiBydW5JZGVudGl0eUZ1bmN0aW9uQ2hlY2sKICAgIH0sCiAgICBpbnB1dFN0YWJpbGl0eUNoZWNrOiB7CiAgICAgIHNob3VsZFJ1bjogaW5wdXRTdGFiaWxpdHlDaGVjayA9PT0gImFsd2F5cyIgfHwgaW5wdXRTdGFiaWxpdHlDaGVjayA9PT0gIm9uY2UiICYmIGZpcnN0UnVuLAogICAgICBydW46IHJ1bklucHV0U3RhYmlsaXR5Q2hlY2sKICAgIH0KICB9Owp9Owp2YXIgUkVEVVhfUFJPWFlfTEFCRUwgPSBTeW1ib2woKTsKdmFyIHByb3RvID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHt9KTsKdmFyIFN0cm9uZ1JlZiA9IGNsYXNzIHsKICBjb25zdHJ1Y3Rvcih2YWx1ZSkgewogICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogIH0KICBkZXJlZigpIHsKICAgIHJldHVybiB0aGlzLnZhbHVlOwogIH0KfTsKdmFyIFJlZiA9IHR5cGVvZiBXZWFrUmVmICE9PSAidW5kZWZpbmVkIiA/IFdlYWtSZWYgOiBTdHJvbmdSZWY7CnZhciBVTlRFUk1JTkFURUQgPSAwOwp2YXIgVEVSTUlOQVRFRCA9IDE7CmZ1bmN0aW9uIGNyZWF0ZUNhY2hlTm9kZSgpIHsKICByZXR1cm4gewogICAgczogVU5URVJNSU5BVEVELAogICAgdjogdm9pZCAwLAogICAgbzogbnVsbCwKICAgIHA6IG51bGwKICB9Owp9CmZ1bmN0aW9uIHdlYWtNYXBNZW1vaXplKGZ1bmMsIG9wdGlvbnMgPSB7fSkgewogIGxldCBmbk5vZGUgPSBjcmVhdGVDYWNoZU5vZGUoKTsKICBjb25zdCB7IHJlc3VsdEVxdWFsaXR5Q2hlY2sgfSA9IG9wdGlvbnM7CiAgbGV0IGxhc3RSZXN1bHQ7CiAgbGV0IHJlc3VsdHNDb3VudCA9IDA7CiAgZnVuY3Rpb24gbWVtb2l6ZWQoKSB7CiAgICBsZXQgY2FjaGVOb2RlID0gZm5Ob2RlOwogICAgY29uc3QgeyBsZW5ndGggfSA9IGFyZ3VtZW50czsKICAgIGZvciAobGV0IGkgPSAwLCBsID0gbGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGNvbnN0IGFyZyA9IGFyZ3VtZW50c1tpXTsKICAgICAgaWYgKHR5cGVvZiBhcmcgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGFyZyA9PT0gIm9iamVjdCIgJiYgYXJnICE9PSBudWxsKSB7CiAgICAgICAgbGV0IG9iamVjdENhY2hlID0gY2FjaGVOb2RlLm87CiAgICAgICAgaWYgKG9iamVjdENhY2hlID09PSBudWxsKSB7CiAgICAgICAgICBjYWNoZU5vZGUubyA9IG9iamVjdENhY2hlID0gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IG9iamVjdE5vZGUgPSBvYmplY3RDYWNoZS5nZXQoYXJnKTsKICAgICAgICBpZiAob2JqZWN0Tm9kZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICBjYWNoZU5vZGUgPSBjcmVhdGVDYWNoZU5vZGUoKTsKICAgICAgICAgIG9iamVjdENhY2hlLnNldChhcmcsIGNhY2hlTm9kZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNhY2hlTm9kZSA9IG9iamVjdE5vZGU7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGxldCBwcmltaXRpdmVDYWNoZSA9IGNhY2hlTm9kZS5wOwogICAgICAgIGlmIChwcmltaXRpdmVDYWNoZSA9PT0gbnVsbCkgewogICAgICAgICAgY2FjaGVOb2RlLnAgPSBwcmltaXRpdmVDYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHByaW1pdGl2ZU5vZGUgPSBwcmltaXRpdmVDYWNoZS5nZXQoYXJnKTsKICAgICAgICBpZiAocHJpbWl0aXZlTm9kZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICBjYWNoZU5vZGUgPSBjcmVhdGVDYWNoZU5vZGUoKTsKICAgICAgICAgIHByaW1pdGl2ZUNhY2hlLnNldChhcmcsIGNhY2hlTm9kZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNhY2hlTm9kZSA9IHByaW1pdGl2ZU5vZGU7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBjb25zdCB0ZXJtaW5hdGVkTm9kZSA9IGNhY2hlTm9kZTsKICAgIGxldCByZXN1bHQ7CiAgICBpZiAoY2FjaGVOb2RlLnMgPT09IFRFUk1JTkFURUQpIHsKICAgICAgcmVzdWx0ID0gY2FjaGVOb2RlLnY7CiAgICB9IGVsc2UgewogICAgICByZXN1bHQgPSBmdW5jLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7CiAgICAgIHJlc3VsdHNDb3VudCsrOwogICAgICBpZiAocmVzdWx0RXF1YWxpdHlDaGVjaykgewogICAgICAgIGNvbnN0IGxhc3RSZXN1bHRWYWx1ZSA9IGxhc3RSZXN1bHQ/LmRlcmVmPy4oKSA/PyBsYXN0UmVzdWx0OwogICAgICAgIGlmIChsYXN0UmVzdWx0VmFsdWUgIT0gbnVsbCAmJiByZXN1bHRFcXVhbGl0eUNoZWNrKGxhc3RSZXN1bHRWYWx1ZSwgcmVzdWx0KSkgewogICAgICAgICAgcmVzdWx0ID0gbGFzdFJlc3VsdFZhbHVlOwogICAgICAgICAgcmVzdWx0c0NvdW50ICE9PSAwICYmIHJlc3VsdHNDb3VudC0tOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZWVkc1dlYWtSZWYgPSB0eXBlb2YgcmVzdWx0ID09PSAib2JqZWN0IiAmJiByZXN1bHQgIT09IG51bGwgfHwgdHlwZW9mIHJlc3VsdCA9PT0gImZ1bmN0aW9uIjsKICAgICAgICBsYXN0UmVzdWx0ID0gbmVlZHNXZWFrUmVmID8gbmV3IFJlZihyZXN1bHQpIDogcmVzdWx0OwogICAgICB9CiAgICB9CiAgICB0ZXJtaW5hdGVkTm9kZS5zID0gVEVSTUlOQVRFRDsKICAgIHRlcm1pbmF0ZWROb2RlLnYgPSByZXN1bHQ7CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBtZW1vaXplZC5jbGVhckNhY2hlID0gKCkgPT4gewogICAgZm5Ob2RlID0gY3JlYXRlQ2FjaGVOb2RlKCk7CiAgICBtZW1vaXplZC5yZXNldFJlc3VsdHNDb3VudCgpOwogIH07CiAgbWVtb2l6ZWQucmVzdWx0c0NvdW50ID0gKCkgPT4gcmVzdWx0c0NvdW50OwogIG1lbW9pemVkLnJlc2V0UmVzdWx0c0NvdW50ID0gKCkgPT4gewogICAgcmVzdWx0c0NvdW50ID0gMDsKICB9OwogIHJldHVybiBtZW1vaXplZDsKfQpmdW5jdGlvbiBjcmVhdGVTZWxlY3RvckNyZWF0b3IobWVtb2l6ZU9yT3B0aW9ucywgLi4ubWVtb2l6ZU9wdGlvbnNGcm9tQXJncykgewogIGNvbnN0IGNyZWF0ZVNlbGVjdG9yQ3JlYXRvck9wdGlvbnMgPSB0eXBlb2YgbWVtb2l6ZU9yT3B0aW9ucyA9PT0gImZ1bmN0aW9uIiA/IHsKICAgIG1lbW9pemU6IG1lbW9pemVPck9wdGlvbnMsCiAgICBtZW1vaXplT3B0aW9uczogbWVtb2l6ZU9wdGlvbnNGcm9tQXJncwogIH0gOiBtZW1vaXplT3JPcHRpb25zOwogIGNvbnN0IGNyZWF0ZVNlbGVjdG9yMiA9ICguLi5jcmVhdGVTZWxlY3RvckFyZ3MpID0+IHsKICAgIGxldCByZWNvbXB1dGF0aW9ucyA9IDA7CiAgICBsZXQgZGVwZW5kZW5jeVJlY29tcHV0YXRpb25zID0gMDsKICAgIGxldCBsYXN0UmVzdWx0OwogICAgbGV0IGRpcmVjdGx5UGFzc2VkT3B0aW9ucyA9IHt9OwogICAgbGV0IHJlc3VsdEZ1bmMgPSBjcmVhdGVTZWxlY3RvckFyZ3MucG9wKCk7CiAgICBpZiAodHlwZW9mIHJlc3VsdEZ1bmMgPT09ICJvYmplY3QiKSB7CiAgICAgIGRpcmVjdGx5UGFzc2VkT3B0aW9ucyA9IHJlc3VsdEZ1bmM7CiAgICAgIHJlc3VsdEZ1bmMgPSBjcmVhdGVTZWxlY3RvckFyZ3MucG9wKCk7CiAgICB9CiAgICBhc3NlcnRJc0Z1bmN0aW9uKAogICAgICByZXN1bHRGdW5jLAogICAgICBgY3JlYXRlU2VsZWN0b3IgZXhwZWN0cyBhbiBvdXRwdXQgZnVuY3Rpb24gYWZ0ZXIgdGhlIGlucHV0cywgYnV0IHJlY2VpdmVkOiBbJHt0eXBlb2YgcmVzdWx0RnVuY31dYAogICAgKTsKICAgIGNvbnN0IGNvbWJpbmVkT3B0aW9ucyA9IHsKICAgICAgLi4uY3JlYXRlU2VsZWN0b3JDcmVhdG9yT3B0aW9ucywKICAgICAgLi4uZGlyZWN0bHlQYXNzZWRPcHRpb25zCiAgICB9OwogICAgY29uc3QgewogICAgICBtZW1vaXplLAogICAgICBtZW1vaXplT3B0aW9ucyA9IFtdLAogICAgICBhcmdzTWVtb2l6ZSA9IHdlYWtNYXBNZW1vaXplLAogICAgICBhcmdzTWVtb2l6ZU9wdGlvbnMgPSBbXSwKICAgICAgZGV2TW9kZUNoZWNrcyA9IHt9CiAgICB9ID0gY29tYmluZWRPcHRpb25zOwogICAgY29uc3QgZmluYWxNZW1vaXplT3B0aW9ucyA9IGVuc3VyZUlzQXJyYXkobWVtb2l6ZU9wdGlvbnMpOwogICAgY29uc3QgZmluYWxBcmdzTWVtb2l6ZU9wdGlvbnMgPSBlbnN1cmVJc0FycmF5KGFyZ3NNZW1vaXplT3B0aW9ucyk7CiAgICBjb25zdCBkZXBlbmRlbmNpZXMgPSBnZXREZXBlbmRlbmNpZXMoY3JlYXRlU2VsZWN0b3JBcmdzKTsKICAgIGNvbnN0IG1lbW9pemVkUmVzdWx0RnVuYyA9IG1lbW9pemUoZnVuY3Rpb24gcmVjb21wdXRhdGlvbldyYXBwZXIoKSB7CiAgICAgIHJlY29tcHV0YXRpb25zKys7CiAgICAgIHJldHVybiByZXN1bHRGdW5jLmFwcGx5KAogICAgICAgIG51bGwsCiAgICAgICAgYXJndW1lbnRzCiAgICAgICk7CiAgICB9LCAuLi5maW5hbE1lbW9pemVPcHRpb25zKTsKICAgIGxldCBmaXJzdFJ1biA9IHRydWU7CiAgICBjb25zdCBzZWxlY3RvciA9IGFyZ3NNZW1vaXplKGZ1bmN0aW9uIGRlcGVuZGVuY2llc0NoZWNrZXIoKSB7CiAgICAgIGRlcGVuZGVuY3lSZWNvbXB1dGF0aW9ucysrOwogICAgICBjb25zdCBpbnB1dFNlbGVjdG9yUmVzdWx0cyA9IGNvbGxlY3RJbnB1dFNlbGVjdG9yUmVzdWx0cygKICAgICAgICBkZXBlbmRlbmNpZXMsCiAgICAgICAgYXJndW1lbnRzCiAgICAgICk7CiAgICAgIGxhc3RSZXN1bHQgPSBtZW1vaXplZFJlc3VsdEZ1bmMuYXBwbHkobnVsbCwgaW5wdXRTZWxlY3RvclJlc3VsdHMpOwogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGNvbnN0IHsgaWRlbnRpdHlGdW5jdGlvbkNoZWNrLCBpbnB1dFN0YWJpbGl0eUNoZWNrIH0gPSBnZXREZXZNb2RlQ2hlY2tzRXhlY3V0aW9uSW5mbyhmaXJzdFJ1biwgZGV2TW9kZUNoZWNrcyk7CiAgICAgICAgaWYgKGlkZW50aXR5RnVuY3Rpb25DaGVjay5zaG91bGRSdW4pIHsKICAgICAgICAgIGlkZW50aXR5RnVuY3Rpb25DaGVjay5ydW4oCiAgICAgICAgICAgIHJlc3VsdEZ1bmMsCiAgICAgICAgICAgIGlucHV0U2VsZWN0b3JSZXN1bHRzLAogICAgICAgICAgICBsYXN0UmVzdWx0CiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoaW5wdXRTdGFiaWxpdHlDaGVjay5zaG91bGRSdW4pIHsKICAgICAgICAgIGNvbnN0IGlucHV0U2VsZWN0b3JSZXN1bHRzQ29weSA9IGNvbGxlY3RJbnB1dFNlbGVjdG9yUmVzdWx0cygKICAgICAgICAgICAgZGVwZW5kZW5jaWVzLAogICAgICAgICAgICBhcmd1bWVudHMKICAgICAgICAgICk7CiAgICAgICAgICBpbnB1dFN0YWJpbGl0eUNoZWNrLnJ1bigKICAgICAgICAgICAgeyBpbnB1dFNlbGVjdG9yUmVzdWx0cywgaW5wdXRTZWxlY3RvclJlc3VsdHNDb3B5IH0sCiAgICAgICAgICAgIHsgbWVtb2l6ZSwgbWVtb2l6ZU9wdGlvbnM6IGZpbmFsTWVtb2l6ZU9wdGlvbnMgfSwKICAgICAgICAgICAgYXJndW1lbnRzCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgICBpZiAoZmlyc3RSdW4pCiAgICAgICAgICBmaXJzdFJ1biA9IGZhbHNlOwogICAgICB9CiAgICAgIHJldHVybiBsYXN0UmVzdWx0OwogICAgfSwgLi4uZmluYWxBcmdzTWVtb2l6ZU9wdGlvbnMpOwogICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oc2VsZWN0b3IsIHsKICAgICAgcmVzdWx0RnVuYywKICAgICAgbWVtb2l6ZWRSZXN1bHRGdW5jLAogICAgICBkZXBlbmRlbmNpZXMsCiAgICAgIGRlcGVuZGVuY3lSZWNvbXB1dGF0aW9uczogKCkgPT4gZGVwZW5kZW5jeVJlY29tcHV0YXRpb25zLAogICAgICByZXNldERlcGVuZGVuY3lSZWNvbXB1dGF0aW9uczogKCkgPT4gewogICAgICAgIGRlcGVuZGVuY3lSZWNvbXB1dGF0aW9ucyA9IDA7CiAgICAgIH0sCiAgICAgIGxhc3RSZXN1bHQ6ICgpID0+IGxhc3RSZXN1bHQsCiAgICAgIHJlY29tcHV0YXRpb25zOiAoKSA9PiByZWNvbXB1dGF0aW9ucywKICAgICAgcmVzZXRSZWNvbXB1dGF0aW9uczogKCkgPT4gewogICAgICAgIHJlY29tcHV0YXRpb25zID0gMDsKICAgICAgfSwKICAgICAgbWVtb2l6ZSwKICAgICAgYXJnc01lbW9pemUKICAgIH0pOwogIH07CiAgT2JqZWN0LmFzc2lnbihjcmVhdGVTZWxlY3RvcjIsIHsKICAgIHdpdGhUeXBlczogKCkgPT4gY3JlYXRlU2VsZWN0b3IyCiAgfSk7CiAgcmV0dXJuIGNyZWF0ZVNlbGVjdG9yMjsKfQp2YXIgY3JlYXRlU2VsZWN0b3IgPSAvKiBAX19QVVJFX18gKi8gY3JlYXRlU2VsZWN0b3JDcmVhdG9yKHdlYWtNYXBNZW1vaXplKTsKdmFyIGNyZWF0ZVN0cnVjdHVyZWRTZWxlY3RvciA9IE9iamVjdC5hc3NpZ24oCiAgKGlucHV0U2VsZWN0b3JzT2JqZWN0LCBzZWxlY3RvckNyZWF0b3IgPSBjcmVhdGVTZWxlY3RvcikgPT4gewogICAgYXNzZXJ0SXNPYmplY3QoCiAgICAgIGlucHV0U2VsZWN0b3JzT2JqZWN0LAogICAgICBgY3JlYXRlU3RydWN0dXJlZFNlbGVjdG9yIGV4cGVjdHMgZmlyc3QgYXJndW1lbnQgdG8gYmUgYW4gb2JqZWN0IHdoZXJlIGVhY2ggcHJvcGVydHkgaXMgYSBzZWxlY3RvciwgaW5zdGVhZCByZWNlaXZlZCBhICR7dHlwZW9mIGlucHV0U2VsZWN0b3JzT2JqZWN0fWAKICAgICk7CiAgICBjb25zdCBpbnB1dFNlbGVjdG9yS2V5cyA9IE9iamVjdC5rZXlzKGlucHV0U2VsZWN0b3JzT2JqZWN0KTsKICAgIGNvbnN0IGRlcGVuZGVuY2llcyA9IGlucHV0U2VsZWN0b3JLZXlzLm1hcCgKICAgICAgKGtleSkgPT4gaW5wdXRTZWxlY3RvcnNPYmplY3Rba2V5XQogICAgKTsKICAgIGNvbnN0IHN0cnVjdHVyZWRTZWxlY3RvciA9IHNlbGVjdG9yQ3JlYXRvcigKICAgICAgZGVwZW5kZW5jaWVzLAogICAgICAoLi4uaW5wdXRTZWxlY3RvclJlc3VsdHMpID0+IHsKICAgICAgICByZXR1cm4gaW5wdXRTZWxlY3RvclJlc3VsdHMucmVkdWNlKChjb21wb3NpdGlvbiwgdmFsdWUsIGluZGV4KSA9PiB7CiAgICAgICAgICBjb21wb3NpdGlvbltpbnB1dFNlbGVjdG9yS2V5c1tpbmRleF1dID0gdmFsdWU7CiAgICAgICAgICByZXR1cm4gY29tcG9zaXRpb247CiAgICAgICAgfSwge30pOwogICAgICB9CiAgICApOwogICAgcmV0dXJuIHN0cnVjdHVyZWRTZWxlY3RvcjsKICB9LAogIHsgd2l0aFR5cGVzOiAoKSA9PiBjcmVhdGVTdHJ1Y3R1cmVkU2VsZWN0b3IgfQopOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2xlZ2VuZFNlbGVjdG9ycy5qcwp2YXIgaW1wb3J0X3NvcnRCeSA9IF9fdG9FU00ocmVxdWlyZV9zb3J0QnkyKCkpOwp2YXIgc2VsZWN0TGVnZW5kU2V0dGluZ3MgPSAoc3RhdGUpID0+IHN0YXRlLmxlZ2VuZC5zZXR0aW5nczsKdmFyIHNlbGVjdExlZ2VuZFNpemUgPSAoc3RhdGUpID0+IHN0YXRlLmxlZ2VuZC5zaXplOwp2YXIgc2VsZWN0QWxsTGVnZW5kUGF5bG9hZDJEQXJyYXkgPSAoc3RhdGUpID0+IHN0YXRlLmxlZ2VuZC5wYXlsb2FkOwp2YXIgc2VsZWN0TGVnZW5kUGF5bG9hZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxMZWdlbmRQYXlsb2FkMkRBcnJheSwgc2VsZWN0TGVnZW5kU2V0dGluZ3NdLCAocGF5bG9hZHMsIF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGl0ZW1Tb3J0ZXIKICB9ID0gX3JlZjI7CiAgdmFyIGZsYXQgPSBwYXlsb2Fkcy5mbGF0KDEpOwogIHJldHVybiBpdGVtU29ydGVyID8gKDAsIGltcG9ydF9zb3J0QnkuZGVmYXVsdCkoZmxhdCwgaXRlbVNvcnRlcikgOiBmbGF0Owp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdXNlRWxlbWVudE9mZnNldC5qcwp2YXIgaW1wb3J0X3JlYWN0MTAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBFUFMgPSAxOwpmdW5jdGlvbiB1c2VFbGVtZW50T2Zmc2V0KCkgewogIHZhciBleHRyYURlcGVuZGVuY2llcyA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzBdIDogW107CiAgdmFyIFtsYXN0Qm91bmRpbmdCb3gsIHNldExhc3RCb3VuZGluZ0JveF0gPSAoMCwgaW1wb3J0X3JlYWN0MTAudXNlU3RhdGUpKHsKICAgIGhlaWdodDogMCwKICAgIGxlZnQ6IDAsCiAgICB0b3A6IDAsCiAgICB3aWR0aDogMAogIH0pOwogIHZhciB1cGRhdGVCb3VuZGluZ0JveCA9ICgwLCBpbXBvcnRfcmVhY3QxMC51c2VDYWxsYmFjaykoCiAgICAobm9kZSkgPT4gewogICAgICBpZiAobm9kZSAhPSBudWxsKSB7CiAgICAgICAgdmFyIHJlY3QgPSBub2RlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgIHZhciBib3ggPSB7CiAgICAgICAgICBoZWlnaHQ6IHJlY3QuaGVpZ2h0LAogICAgICAgICAgbGVmdDogcmVjdC5sZWZ0LAogICAgICAgICAgdG9wOiByZWN0LnRvcCwKICAgICAgICAgIHdpZHRoOiByZWN0LndpZHRoCiAgICAgICAgfTsKICAgICAgICBpZiAoTWF0aC5hYnMoYm94LmhlaWdodCAtIGxhc3RCb3VuZGluZ0JveC5oZWlnaHQpID4gRVBTIHx8IE1hdGguYWJzKGJveC5sZWZ0IC0gbGFzdEJvdW5kaW5nQm94LmxlZnQpID4gRVBTIHx8IE1hdGguYWJzKGJveC50b3AgLSBsYXN0Qm91bmRpbmdCb3gudG9wKSA+IEVQUyB8fCBNYXRoLmFicyhib3gud2lkdGggLSBsYXN0Qm91bmRpbmdCb3gud2lkdGgpID4gRVBTKSB7CiAgICAgICAgICBzZXRMYXN0Qm91bmRpbmdCb3goewogICAgICAgICAgICBoZWlnaHQ6IGJveC5oZWlnaHQsCiAgICAgICAgICAgIGxlZnQ6IGJveC5sZWZ0LAogICAgICAgICAgICB0b3A6IGJveC50b3AsCiAgICAgICAgICAgIHdpZHRoOiBib3gud2lkdGgKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC1ob29rcy9leGhhdXN0aXZlLWRlcHMKICAgIFtsYXN0Qm91bmRpbmdCb3gud2lkdGgsIGxhc3RCb3VuZGluZ0JveC5oZWlnaHQsIGxhc3RCb3VuZGluZ0JveC50b3AsIGxhc3RCb3VuZGluZ0JveC5sZWZ0LCAuLi5leHRyYURlcGVuZGVuY2llc10KICApOwogIHJldHVybiBbbGFzdEJvdW5kaW5nQm94LCB1cGRhdGVCb3VuZGluZ0JveF07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvY2hhcnRMYXlvdXRDb250ZXh0LmpzCnZhciBpbXBvcnRfcmVhY3QxMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVkdXgvZGlzdC9yZWR1eC5tanMKdmFyICQkb2JzZXJ2YWJsZSA9IC8qIEBfX1BVUkVfXyAqLyAoKCkgPT4gdHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIiAmJiBTeW1ib2wub2JzZXJ2YWJsZSB8fCAiQEBvYnNlcnZhYmxlIikoKTsKdmFyIHN5bWJvbF9vYnNlcnZhYmxlX2RlZmF1bHQgPSAkJG9ic2VydmFibGU7CnZhciByYW5kb21TdHJpbmcgPSAoKSA9PiBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHJpbmcoNykuc3BsaXQoIiIpLmpvaW4oIi4iKTsKdmFyIEFjdGlvblR5cGVzID0gewogIElOSVQ6IGBAQHJlZHV4L0lOSVQkey8qIEBfX1BVUkVfXyAqLyByYW5kb21TdHJpbmcoKX1gLAogIFJFUExBQ0U6IGBAQHJlZHV4L1JFUExBQ0Ukey8qIEBfX1BVUkVfXyAqLyByYW5kb21TdHJpbmcoKX1gLAogIFBST0JFX1VOS05PV05fQUNUSU9OOiAoKSA9PiBgQEByZWR1eC9QUk9CRV9VTktOT1dOX0FDVElPTiR7cmFuZG9tU3RyaW5nKCl9YAp9Owp2YXIgYWN0aW9uVHlwZXNfZGVmYXVsdCA9IEFjdGlvblR5cGVzOwpmdW5jdGlvbiBpc1BsYWluT2JqZWN0KG9iaikgewogIGlmICh0eXBlb2Ygb2JqICE9PSAib2JqZWN0IiB8fCBvYmogPT09IG51bGwpCiAgICByZXR1cm4gZmFsc2U7CiAgbGV0IHByb3RvMiA9IG9iajsKICB3aGlsZSAoT2JqZWN0LmdldFByb3RvdHlwZU9mKHByb3RvMikgIT09IG51bGwpIHsKICAgIHByb3RvMiA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihwcm90bzIpOwogIH0KICByZXR1cm4gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iaikgPT09IHByb3RvMiB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqKSA9PT0gbnVsbDsKfQpmdW5jdGlvbiBtaW5pS2luZE9mKHZhbCkgewogIGlmICh2YWwgPT09IHZvaWQgMCkKICAgIHJldHVybiAidW5kZWZpbmVkIjsKICBpZiAodmFsID09PSBudWxsKQogICAgcmV0dXJuICJudWxsIjsKICBjb25zdCB0eXBlID0gdHlwZW9mIHZhbDsKICBzd2l0Y2ggKHR5cGUpIHsKICAgIGNhc2UgImJvb2xlYW4iOgogICAgY2FzZSAic3RyaW5nIjoKICAgIGNhc2UgIm51bWJlciI6CiAgICBjYXNlICJzeW1ib2wiOgogICAgY2FzZSAiZnVuY3Rpb24iOiB7CiAgICAgIHJldHVybiB0eXBlOwogICAgfQogIH0KICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKQogICAgcmV0dXJuICJhcnJheSI7CiAgaWYgKGlzRGF0ZSh2YWwpKQogICAgcmV0dXJuICJkYXRlIjsKICBpZiAoaXNFcnJvcih2YWwpKQogICAgcmV0dXJuICJlcnJvciI7CiAgY29uc3QgY29uc3RydWN0b3JOYW1lID0gY3Rvck5hbWUodmFsKTsKICBzd2l0Y2ggKGNvbnN0cnVjdG9yTmFtZSkgewogICAgY2FzZSAiU3ltYm9sIjoKICAgIGNhc2UgIlByb21pc2UiOgogICAgY2FzZSAiV2Vha01hcCI6CiAgICBjYXNlICJXZWFrU2V0IjoKICAgIGNhc2UgIk1hcCI6CiAgICBjYXNlICJTZXQiOgogICAgICByZXR1cm4gY29uc3RydWN0b3JOYW1lOwogIH0KICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbCkuc2xpY2UoOCwgLTEpLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXHMvZywgIiIpOwp9CmZ1bmN0aW9uIGN0b3JOYW1lKHZhbCkgewogIHJldHVybiB0eXBlb2YgdmFsLmNvbnN0cnVjdG9yID09PSAiZnVuY3Rpb24iID8gdmFsLmNvbnN0cnVjdG9yLm5hbWUgOiBudWxsOwp9CmZ1bmN0aW9uIGlzRXJyb3IodmFsKSB7CiAgcmV0dXJuIHZhbCBpbnN0YW5jZW9mIEVycm9yIHx8IHR5cGVvZiB2YWwubWVzc2FnZSA9PT0gInN0cmluZyIgJiYgdmFsLmNvbnN0cnVjdG9yICYmIHR5cGVvZiB2YWwuY29uc3RydWN0b3Iuc3RhY2tUcmFjZUxpbWl0ID09PSAibnVtYmVyIjsKfQpmdW5jdGlvbiBpc0RhdGUodmFsKSB7CiAgaWYgKHZhbCBpbnN0YW5jZW9mIERhdGUpCiAgICByZXR1cm4gdHJ1ZTsKICByZXR1cm4gdHlwZW9mIHZhbC50b0RhdGVTdHJpbmcgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIHZhbC5nZXREYXRlID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiB2YWwuc2V0RGF0ZSA9PT0gImZ1bmN0aW9uIjsKfQpmdW5jdGlvbiBraW5kT2YodmFsKSB7CiAgbGV0IHR5cGVPZlZhbCA9IHR5cGVvZiB2YWw7CiAgaWYgKHRydWUpIHsKICAgIHR5cGVPZlZhbCA9IG1pbmlLaW5kT2YodmFsKTsKICB9CiAgcmV0dXJuIHR5cGVPZlZhbDsKfQpmdW5jdGlvbiBjcmVhdGVTdG9yZShyZWR1Y2VyLCBwcmVsb2FkZWRTdGF0ZSwgZW5oYW5jZXIpIHsKICBpZiAodHlwZW9mIHJlZHVjZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMikgOiBgRXhwZWN0ZWQgdGhlIHJvb3QgcmVkdWNlciB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkLCByZWNlaXZlZDogJyR7a2luZE9mKHJlZHVjZXIpfSdgKTsKICB9CiAgaWYgKHR5cGVvZiBwcmVsb2FkZWRTdGF0ZSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgZW5oYW5jZXIgPT09ICJmdW5jdGlvbiIgfHwgdHlwZW9mIGVuaGFuY2VyID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBhcmd1bWVudHNbM10gPT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMCkgOiAiSXQgbG9va3MgbGlrZSB5b3UgYXJlIHBhc3Npbmcgc2V2ZXJhbCBzdG9yZSBlbmhhbmNlcnMgdG8gY3JlYXRlU3RvcmUoKS4gVGhpcyBpcyBub3Qgc3VwcG9ydGVkLiBJbnN0ZWFkLCBjb21wb3NlIHRoZW0gdG9nZXRoZXIgdG8gYSBzaW5nbGUgZnVuY3Rpb24uIFNlZSBodHRwczovL3JlZHV4LmpzLm9yZy90dXRvcmlhbHMvZnVuZGFtZW50YWxzL3BhcnQtNC1zdG9yZSNjcmVhdGluZy1hLXN0b3JlLXdpdGgtZW5oYW5jZXJzIGZvciBhbiBleGFtcGxlLiIpOwogIH0KICBpZiAodHlwZW9mIHByZWxvYWRlZFN0YXRlID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBlbmhhbmNlciA9PT0gInVuZGVmaW5lZCIpIHsKICAgIGVuaGFuY2VyID0gcHJlbG9hZGVkU3RhdGU7CiAgICBwcmVsb2FkZWRTdGF0ZSA9IHZvaWQgMDsKICB9CiAgaWYgKHR5cGVvZiBlbmhhbmNlciAhPT0gInVuZGVmaW5lZCIpIHsKICAgIGlmICh0eXBlb2YgZW5oYW5jZXIgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxKSA6IGBFeHBlY3RlZCB0aGUgZW5oYW5jZXIgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCwgcmVjZWl2ZWQ6ICcke2tpbmRPZihlbmhhbmNlcil9J2ApOwogICAgfQogICAgcmV0dXJuIGVuaGFuY2VyKGNyZWF0ZVN0b3JlKShyZWR1Y2VyLCBwcmVsb2FkZWRTdGF0ZSk7CiAgfQogIGxldCBjdXJyZW50UmVkdWNlciA9IHJlZHVjZXI7CiAgbGV0IGN1cnJlbnRTdGF0ZSA9IHByZWxvYWRlZFN0YXRlOwogIGxldCBjdXJyZW50TGlzdGVuZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBsZXQgbmV4dExpc3RlbmVycyA9IGN1cnJlbnRMaXN0ZW5lcnM7CiAgbGV0IGxpc3RlbmVySWRDb3VudGVyID0gMDsKICBsZXQgaXNEaXNwYXRjaGluZyA9IGZhbHNlOwogIGZ1bmN0aW9uIGVuc3VyZUNhbk11dGF0ZU5leHRMaXN0ZW5lcnMoKSB7CiAgICBpZiAobmV4dExpc3RlbmVycyA9PT0gY3VycmVudExpc3RlbmVycykgewogICAgICBuZXh0TGlzdGVuZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICAgICAgY3VycmVudExpc3RlbmVycy5mb3JFYWNoKChsaXN0ZW5lcjIsIGtleSkgPT4gewogICAgICAgIG5leHRMaXN0ZW5lcnMuc2V0KGtleSwgbGlzdGVuZXIyKTsKICAgICAgfSk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIGdldFN0YXRlKCkgewogICAgaWYgKGlzRGlzcGF0Y2hpbmcpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgzKSA6ICJZb3UgbWF5IG5vdCBjYWxsIHN0b3JlLmdldFN0YXRlKCkgd2hpbGUgdGhlIHJlZHVjZXIgaXMgZXhlY3V0aW5nLiBUaGUgcmVkdWNlciBoYXMgYWxyZWFkeSByZWNlaXZlZCB0aGUgc3RhdGUgYXMgYW4gYXJndW1lbnQuIFBhc3MgaXQgZG93biBmcm9tIHRoZSB0b3AgcmVkdWNlciBpbnN0ZWFkIG9mIHJlYWRpbmcgaXQgZnJvbSB0aGUgc3RvcmUuIik7CiAgICB9CiAgICByZXR1cm4gY3VycmVudFN0YXRlOwogIH0KICBmdW5jdGlvbiBzdWJzY3JpYmUobGlzdGVuZXIyKSB7CiAgICBpZiAodHlwZW9mIGxpc3RlbmVyMiAhPT0gImZ1bmN0aW9uIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDQpIDogYEV4cGVjdGVkIHRoZSBsaXN0ZW5lciB0byBiZSBhIGZ1bmN0aW9uLiBJbnN0ZWFkLCByZWNlaXZlZDogJyR7a2luZE9mKGxpc3RlbmVyMil9J2ApOwogICAgfQogICAgaWYgKGlzRGlzcGF0Y2hpbmcpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg1KSA6ICJZb3UgbWF5IG5vdCBjYWxsIHN0b3JlLnN1YnNjcmliZSgpIHdoaWxlIHRoZSByZWR1Y2VyIGlzIGV4ZWN1dGluZy4gSWYgeW91IHdvdWxkIGxpa2UgdG8gYmUgbm90aWZpZWQgYWZ0ZXIgdGhlIHN0b3JlIGhhcyBiZWVuIHVwZGF0ZWQsIHN1YnNjcmliZSBmcm9tIGEgY29tcG9uZW50IGFuZCBpbnZva2Ugc3RvcmUuZ2V0U3RhdGUoKSBpbiB0aGUgY2FsbGJhY2sgdG8gYWNjZXNzIHRoZSBsYXRlc3Qgc3RhdGUuIFNlZSBodHRwczovL3JlZHV4LmpzLm9yZy9hcGkvc3RvcmUjc3Vic2NyaWJlbGlzdGVuZXIgZm9yIG1vcmUgZGV0YWlscy4iKTsKICAgIH0KICAgIGxldCBpc1N1YnNjcmliZWQgPSB0cnVlOwogICAgZW5zdXJlQ2FuTXV0YXRlTmV4dExpc3RlbmVycygpOwogICAgY29uc3QgbGlzdGVuZXJJZCA9IGxpc3RlbmVySWRDb3VudGVyKys7CiAgICBuZXh0TGlzdGVuZXJzLnNldChsaXN0ZW5lcklkLCBsaXN0ZW5lcjIpOwogICAgcmV0dXJuIGZ1bmN0aW9uIHVuc3Vic2NyaWJlKCkgewogICAgICBpZiAoIWlzU3Vic2NyaWJlZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoaXNEaXNwYXRjaGluZykgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNikgOiAiWW91IG1heSBub3QgdW5zdWJzY3JpYmUgZnJvbSBhIHN0b3JlIGxpc3RlbmVyIHdoaWxlIHRoZSByZWR1Y2VyIGlzIGV4ZWN1dGluZy4gU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL2FwaS9zdG9yZSNzdWJzY3JpYmVsaXN0ZW5lciBmb3IgbW9yZSBkZXRhaWxzLiIpOwogICAgICB9CiAgICAgIGlzU3Vic2NyaWJlZCA9IGZhbHNlOwogICAgICBlbnN1cmVDYW5NdXRhdGVOZXh0TGlzdGVuZXJzKCk7CiAgICAgIG5leHRMaXN0ZW5lcnMuZGVsZXRlKGxpc3RlbmVySWQpOwogICAgICBjdXJyZW50TGlzdGVuZXJzID0gbnVsbDsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGRpc3BhdGNoKGFjdGlvbikgewogICAgaWYgKCFpc1BsYWluT2JqZWN0KGFjdGlvbikpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg3KSA6IGBBY3Rpb25zIG11c3QgYmUgcGxhaW4gb2JqZWN0cy4gSW5zdGVhZCwgdGhlIGFjdHVhbCB0eXBlIHdhczogJyR7a2luZE9mKGFjdGlvbil9Jy4gWW91IG1heSBuZWVkIHRvIGFkZCBtaWRkbGV3YXJlIHRvIHlvdXIgc3RvcmUgc2V0dXAgdG8gaGFuZGxlIGRpc3BhdGNoaW5nIG90aGVyIHZhbHVlcywgc3VjaCBhcyAncmVkdXgtdGh1bmsnIHRvIGhhbmRsZSBkaXNwYXRjaGluZyBmdW5jdGlvbnMuIFNlZSBodHRwczovL3JlZHV4LmpzLm9yZy90dXRvcmlhbHMvZnVuZGFtZW50YWxzL3BhcnQtNC1zdG9yZSNtaWRkbGV3YXJlIGFuZCBodHRwczovL3JlZHV4LmpzLm9yZy90dXRvcmlhbHMvZnVuZGFtZW50YWxzL3BhcnQtNi1hc3luYy1sb2dpYyN1c2luZy10aGUtcmVkdXgtdGh1bmstbWlkZGxld2FyZSBmb3IgZXhhbXBsZXMuYCk7CiAgICB9CiAgICBpZiAodHlwZW9mIGFjdGlvbi50eXBlID09PSAidW5kZWZpbmVkIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDgpIDogJ0FjdGlvbnMgbWF5IG5vdCBoYXZlIGFuIHVuZGVmaW5lZCAidHlwZSIgcHJvcGVydHkuIFlvdSBtYXkgaGF2ZSBtaXNzcGVsbGVkIGFuIGFjdGlvbiB0eXBlIHN0cmluZyBjb25zdGFudC4nKTsKICAgIH0KICAgIGlmICh0eXBlb2YgYWN0aW9uLnR5cGUgIT09ICJzdHJpbmciKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTcpIDogYEFjdGlvbiAidHlwZSIgcHJvcGVydHkgbXVzdCBiZSBhIHN0cmluZy4gSW5zdGVhZCwgdGhlIGFjdHVhbCB0eXBlIHdhczogJyR7a2luZE9mKGFjdGlvbi50eXBlKX0nLiBWYWx1ZSB3YXM6ICcke2FjdGlvbi50eXBlfScgKHN0cmluZ2lmaWVkKWApOwogICAgfQogICAgaWYgKGlzRGlzcGF0Y2hpbmcpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg5KSA6ICJSZWR1Y2VycyBtYXkgbm90IGRpc3BhdGNoIGFjdGlvbnMuIik7CiAgICB9CiAgICB0cnkgewogICAgICBpc0Rpc3BhdGNoaW5nID0gdHJ1ZTsKICAgICAgY3VycmVudFN0YXRlID0gY3VycmVudFJlZHVjZXIoY3VycmVudFN0YXRlLCBhY3Rpb24pOwogICAgfSBmaW5hbGx5IHsKICAgICAgaXNEaXNwYXRjaGluZyA9IGZhbHNlOwogICAgfQogICAgY29uc3QgbGlzdGVuZXJzID0gY3VycmVudExpc3RlbmVycyA9IG5leHRMaXN0ZW5lcnM7CiAgICBsaXN0ZW5lcnMuZm9yRWFjaCgobGlzdGVuZXIyKSA9PiB7CiAgICAgIGxpc3RlbmVyMigpOwogICAgfSk7CiAgICByZXR1cm4gYWN0aW9uOwogIH0KICBmdW5jdGlvbiByZXBsYWNlUmVkdWNlcihuZXh0UmVkdWNlcikgewogICAgaWYgKHR5cGVvZiBuZXh0UmVkdWNlciAhPT0gImZ1bmN0aW9uIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEwKSA6IGBFeHBlY3RlZCB0aGUgbmV4dFJlZHVjZXIgdG8gYmUgYSBmdW5jdGlvbi4gSW5zdGVhZCwgcmVjZWl2ZWQ6ICcke2tpbmRPZihuZXh0UmVkdWNlcil9YCk7CiAgICB9CiAgICBjdXJyZW50UmVkdWNlciA9IG5leHRSZWR1Y2VyOwogICAgZGlzcGF0Y2goewogICAgICB0eXBlOiBhY3Rpb25UeXBlc19kZWZhdWx0LlJFUExBQ0UKICAgIH0pOwogIH0KICBmdW5jdGlvbiBvYnNlcnZhYmxlKCkgewogICAgY29uc3Qgb3V0ZXJTdWJzY3JpYmUgPSBzdWJzY3JpYmU7CiAgICByZXR1cm4gewogICAgICAvKioKICAgICAgICogVGhlIG1pbmltYWwgb2JzZXJ2YWJsZSBzdWJzY3JpcHRpb24gbWV0aG9kLgogICAgICAgKiBAcGFyYW0gb2JzZXJ2ZXIgQW55IG9iamVjdCB0aGF0IGNhbiBiZSB1c2VkIGFzIGFuIG9ic2VydmVyLgogICAgICAgKiBUaGUgb2JzZXJ2ZXIgb2JqZWN0IHNob3VsZCBoYXZlIGEgYG5leHRgIG1ldGhvZC4KICAgICAgICogQHJldHVybnMgQW4gb2JqZWN0IHdpdGggYW4gYHVuc3Vic2NyaWJlYCBtZXRob2QgdGhhdCBjYW4KICAgICAgICogYmUgdXNlZCB0byB1bnN1YnNjcmliZSB0aGUgb2JzZXJ2YWJsZSBmcm9tIHRoZSBzdG9yZSwgYW5kIHByZXZlbnQgZnVydGhlcgogICAgICAgKiBlbWlzc2lvbiBvZiB2YWx1ZXMgZnJvbSB0aGUgb2JzZXJ2YWJsZS4KICAgICAgICovCiAgICAgIHN1YnNjcmliZShvYnNlcnZlcikgewogICAgICAgIGlmICh0eXBlb2Ygb2JzZXJ2ZXIgIT09ICJvYmplY3QiIHx8IG9ic2VydmVyID09PSBudWxsKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDExKSA6IGBFeHBlY3RlZCB0aGUgb2JzZXJ2ZXIgdG8gYmUgYW4gb2JqZWN0LiBJbnN0ZWFkLCByZWNlaXZlZDogJyR7a2luZE9mKG9ic2VydmVyKX0nYCk7CiAgICAgICAgfQogICAgICAgIGZ1bmN0aW9uIG9ic2VydmVTdGF0ZSgpIHsKICAgICAgICAgIGNvbnN0IG9ic2VydmVyQXNPYnNlcnZlciA9IG9ic2VydmVyOwogICAgICAgICAgaWYgKG9ic2VydmVyQXNPYnNlcnZlci5uZXh0KSB7CiAgICAgICAgICAgIG9ic2VydmVyQXNPYnNlcnZlci5uZXh0KGdldFN0YXRlKCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBvYnNlcnZlU3RhdGUoKTsKICAgICAgICBjb25zdCB1bnN1YnNjcmliZSA9IG91dGVyU3Vic2NyaWJlKG9ic2VydmVTdGF0ZSk7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHVuc3Vic2NyaWJlCiAgICAgICAgfTsKICAgICAgfSwKICAgICAgW3N5bWJvbF9vYnNlcnZhYmxlX2RlZmF1bHRdKCkgewogICAgICAgIHJldHVybiB0aGlzOwogICAgICB9CiAgICB9OwogIH0KICBkaXNwYXRjaCh7CiAgICB0eXBlOiBhY3Rpb25UeXBlc19kZWZhdWx0LklOSVQKICB9KTsKICBjb25zdCBzdG9yZSA9IHsKICAgIGRpc3BhdGNoLAogICAgc3Vic2NyaWJlLAogICAgZ2V0U3RhdGUsCiAgICByZXBsYWNlUmVkdWNlciwKICAgIFtzeW1ib2xfb2JzZXJ2YWJsZV9kZWZhdWx0XTogb2JzZXJ2YWJsZQogIH07CiAgcmV0dXJuIHN0b3JlOwp9CmZ1bmN0aW9uIHdhcm5pbmcobWVzc2FnZSkgewogIGlmICh0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIGNvbnNvbGUuZXJyb3IgPT09ICJmdW5jdGlvbiIpIHsKICAgIGNvbnNvbGUuZXJyb3IobWVzc2FnZSk7CiAgfQogIHRyeSB7CiAgICB0aHJvdyBuZXcgRXJyb3IobWVzc2FnZSk7CiAgfSBjYXRjaCAoZSkgewogIH0KfQpmdW5jdGlvbiBnZXRVbmV4cGVjdGVkU3RhdGVTaGFwZVdhcm5pbmdNZXNzYWdlKGlucHV0U3RhdGUsIHJlZHVjZXJzLCBhY3Rpb24sIHVuZXhwZWN0ZWRLZXlDYWNoZSkgewogIGNvbnN0IHJlZHVjZXJLZXlzID0gT2JqZWN0LmtleXMocmVkdWNlcnMpOwogIGNvbnN0IGFyZ3VtZW50TmFtZSA9IGFjdGlvbiAmJiBhY3Rpb24udHlwZSA9PT0gYWN0aW9uVHlwZXNfZGVmYXVsdC5JTklUID8gInByZWxvYWRlZFN0YXRlIGFyZ3VtZW50IHBhc3NlZCB0byBjcmVhdGVTdG9yZSIgOiAicHJldmlvdXMgc3RhdGUgcmVjZWl2ZWQgYnkgdGhlIHJlZHVjZXIiOwogIGlmIChyZWR1Y2VyS2V5cy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiAiU3RvcmUgZG9lcyBub3QgaGF2ZSBhIHZhbGlkIHJlZHVjZXIuIE1ha2Ugc3VyZSB0aGUgYXJndW1lbnQgcGFzc2VkIHRvIGNvbWJpbmVSZWR1Y2VycyBpcyBhbiBvYmplY3Qgd2hvc2UgdmFsdWVzIGFyZSByZWR1Y2Vycy4iOwogIH0KICBpZiAoIWlzUGxhaW5PYmplY3QoaW5wdXRTdGF0ZSkpIHsKICAgIHJldHVybiBgVGhlICR7YXJndW1lbnROYW1lfSBoYXMgdW5leHBlY3RlZCB0eXBlIG9mICIke2tpbmRPZihpbnB1dFN0YXRlKX0iLiBFeHBlY3RlZCBhcmd1bWVudCB0byBiZSBhbiBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIGtleXM6ICIke3JlZHVjZXJLZXlzLmpvaW4oJyIsICInKX0iYDsKICB9CiAgY29uc3QgdW5leHBlY3RlZEtleXMgPSBPYmplY3Qua2V5cyhpbnB1dFN0YXRlKS5maWx0ZXIoKGtleSkgPT4gIXJlZHVjZXJzLmhhc093blByb3BlcnR5KGtleSkgJiYgIXVuZXhwZWN0ZWRLZXlDYWNoZVtrZXldKTsKICB1bmV4cGVjdGVkS2V5cy5mb3JFYWNoKChrZXkpID0+IHsKICAgIHVuZXhwZWN0ZWRLZXlDYWNoZVtrZXldID0gdHJ1ZTsKICB9KTsKICBpZiAoYWN0aW9uICYmIGFjdGlvbi50eXBlID09PSBhY3Rpb25UeXBlc19kZWZhdWx0LlJFUExBQ0UpCiAgICByZXR1cm47CiAgaWYgKHVuZXhwZWN0ZWRLZXlzLmxlbmd0aCA+IDApIHsKICAgIHJldHVybiBgVW5leHBlY3RlZCAke3VuZXhwZWN0ZWRLZXlzLmxlbmd0aCA+IDEgPyAia2V5cyIgOiAia2V5In0gIiR7dW5leHBlY3RlZEtleXMuam9pbignIiwgIicpfSIgZm91bmQgaW4gJHthcmd1bWVudE5hbWV9LiBFeHBlY3RlZCB0byBmaW5kIG9uZSBvZiB0aGUga25vd24gcmVkdWNlciBrZXlzIGluc3RlYWQ6ICIke3JlZHVjZXJLZXlzLmpvaW4oJyIsICInKX0iLiBVbmV4cGVjdGVkIGtleXMgd2lsbCBiZSBpZ25vcmVkLmA7CiAgfQp9CmZ1bmN0aW9uIGFzc2VydFJlZHVjZXJTaGFwZShyZWR1Y2VycykgewogIE9iamVjdC5rZXlzKHJlZHVjZXJzKS5mb3JFYWNoKChrZXkpID0+IHsKICAgIGNvbnN0IHJlZHVjZXIgPSByZWR1Y2Vyc1trZXldOwogICAgY29uc3QgaW5pdGlhbFN0YXRlMTMgPSByZWR1Y2VyKHZvaWQgMCwgewogICAgICB0eXBlOiBhY3Rpb25UeXBlc19kZWZhdWx0LklOSVQKICAgIH0pOwogICAgaWYgKHR5cGVvZiBpbml0aWFsU3RhdGUxMyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxMikgOiBgVGhlIHNsaWNlIHJlZHVjZXIgZm9yIGtleSAiJHtrZXl9IiByZXR1cm5lZCB1bmRlZmluZWQgZHVyaW5nIGluaXRpYWxpemF0aW9uLiBJZiB0aGUgc3RhdGUgcGFzc2VkIHRvIHRoZSByZWR1Y2VyIGlzIHVuZGVmaW5lZCwgeW91IG11c3QgZXhwbGljaXRseSByZXR1cm4gdGhlIGluaXRpYWwgc3RhdGUuIFRoZSBpbml0aWFsIHN0YXRlIG1heSBub3QgYmUgdW5kZWZpbmVkLiBJZiB5b3UgZG9uJ3Qgd2FudCB0byBzZXQgYSB2YWx1ZSBmb3IgdGhpcyByZWR1Y2VyLCB5b3UgY2FuIHVzZSBudWxsIGluc3RlYWQgb2YgdW5kZWZpbmVkLmApOwogICAgfQogICAgaWYgKHR5cGVvZiByZWR1Y2VyKHZvaWQgMCwgewogICAgICB0eXBlOiBhY3Rpb25UeXBlc19kZWZhdWx0LlBST0JFX1VOS05PV05fQUNUSU9OKCkKICAgIH0pID09PSAidW5kZWZpbmVkIikgewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEzKSA6IGBUaGUgc2xpY2UgcmVkdWNlciBmb3Iga2V5ICIke2tleX0iIHJldHVybmVkIHVuZGVmaW5lZCB3aGVuIHByb2JlZCB3aXRoIGEgcmFuZG9tIHR5cGUuIERvbid0IHRyeSB0byBoYW5kbGUgJyR7YWN0aW9uVHlwZXNfZGVmYXVsdC5JTklUfScgb3Igb3RoZXIgYWN0aW9ucyBpbiAicmVkdXgvKiIgbmFtZXNwYWNlLiBUaGV5IGFyZSBjb25zaWRlcmVkIHByaXZhdGUuIEluc3RlYWQsIHlvdSBtdXN0IHJldHVybiB0aGUgY3VycmVudCBzdGF0ZSBmb3IgYW55IHVua25vd24gYWN0aW9ucywgdW5sZXNzIGl0IGlzIHVuZGVmaW5lZCwgaW4gd2hpY2ggY2FzZSB5b3UgbXVzdCByZXR1cm4gdGhlIGluaXRpYWwgc3RhdGUsIHJlZ2FyZGxlc3Mgb2YgdGhlIGFjdGlvbiB0eXBlLiBUaGUgaW5pdGlhbCBzdGF0ZSBtYXkgbm90IGJlIHVuZGVmaW5lZCwgYnV0IGNhbiBiZSBudWxsLmApOwogICAgfQogIH0pOwp9CmZ1bmN0aW9uIGNvbWJpbmVSZWR1Y2VycyhyZWR1Y2VycykgewogIGNvbnN0IHJlZHVjZXJLZXlzID0gT2JqZWN0LmtleXMocmVkdWNlcnMpOwogIGNvbnN0IGZpbmFsUmVkdWNlcnMgPSB7fTsKICBmb3IgKGxldCBpID0gMDsgaSA8IHJlZHVjZXJLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBrZXkgPSByZWR1Y2VyS2V5c1tpXTsKICAgIGlmICh0cnVlKSB7CiAgICAgIGlmICh0eXBlb2YgcmVkdWNlcnNba2V5XSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICB3YXJuaW5nKGBObyByZWR1Y2VyIHByb3ZpZGVkIGZvciBrZXkgIiR7a2V5fSJgKTsKICAgICAgfQogICAgfQogICAgaWYgKHR5cGVvZiByZWR1Y2Vyc1trZXldID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIGZpbmFsUmVkdWNlcnNba2V5XSA9IHJlZHVjZXJzW2tleV07CiAgICB9CiAgfQogIGNvbnN0IGZpbmFsUmVkdWNlcktleXMgPSBPYmplY3Qua2V5cyhmaW5hbFJlZHVjZXJzKTsKICBsZXQgdW5leHBlY3RlZEtleUNhY2hlOwogIGlmICh0cnVlKSB7CiAgICB1bmV4cGVjdGVkS2V5Q2FjaGUgPSB7fTsKICB9CiAgbGV0IHNoYXBlQXNzZXJ0aW9uRXJyb3I7CiAgdHJ5IHsKICAgIGFzc2VydFJlZHVjZXJTaGFwZShmaW5hbFJlZHVjZXJzKTsKICB9IGNhdGNoIChlKSB7CiAgICBzaGFwZUFzc2VydGlvbkVycm9yID0gZTsKICB9CiAgcmV0dXJuIGZ1bmN0aW9uIGNvbWJpbmF0aW9uKHN0YXRlID0ge30sIGFjdGlvbikgewogICAgaWYgKHNoYXBlQXNzZXJ0aW9uRXJyb3IpIHsKICAgICAgdGhyb3cgc2hhcGVBc3NlcnRpb25FcnJvcjsKICAgIH0KICAgIGlmICh0cnVlKSB7CiAgICAgIGNvbnN0IHdhcm5pbmdNZXNzYWdlID0gZ2V0VW5leHBlY3RlZFN0YXRlU2hhcGVXYXJuaW5nTWVzc2FnZShzdGF0ZSwgZmluYWxSZWR1Y2VycywgYWN0aW9uLCB1bmV4cGVjdGVkS2V5Q2FjaGUpOwogICAgICBpZiAod2FybmluZ01lc3NhZ2UpIHsKICAgICAgICB3YXJuaW5nKHdhcm5pbmdNZXNzYWdlKTsKICAgICAgfQogICAgfQogICAgbGV0IGhhc0NoYW5nZWQgPSBmYWxzZTsKICAgIGNvbnN0IG5leHRTdGF0ZSA9IHt9OwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaW5hbFJlZHVjZXJLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGtleSA9IGZpbmFsUmVkdWNlcktleXNbaV07CiAgICAgIGNvbnN0IHJlZHVjZXIgPSBmaW5hbFJlZHVjZXJzW2tleV07CiAgICAgIGNvbnN0IHByZXZpb3VzU3RhdGVGb3JLZXkgPSBzdGF0ZVtrZXldOwogICAgICBjb25zdCBuZXh0U3RhdGVGb3JLZXkgPSByZWR1Y2VyKHByZXZpb3VzU3RhdGVGb3JLZXksIGFjdGlvbik7CiAgICAgIGlmICh0eXBlb2YgbmV4dFN0YXRlRm9yS2V5ID09PSAidW5kZWZpbmVkIikgewogICAgICAgIGNvbnN0IGFjdGlvblR5cGUgPSBhY3Rpb24gJiYgYWN0aW9uLnR5cGU7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNCkgOiBgV2hlbiBjYWxsZWQgd2l0aCBhbiBhY3Rpb24gb2YgdHlwZSAke2FjdGlvblR5cGUgPyBgIiR7U3RyaW5nKGFjdGlvblR5cGUpfSJgIDogIih1bmtub3duIHR5cGUpIn0sIHRoZSBzbGljZSByZWR1Y2VyIGZvciBrZXkgIiR7a2V5fSIgcmV0dXJuZWQgdW5kZWZpbmVkLiBUbyBpZ25vcmUgYW4gYWN0aW9uLCB5b3UgbXVzdCBleHBsaWNpdGx5IHJldHVybiB0aGUgcHJldmlvdXMgc3RhdGUuIElmIHlvdSB3YW50IHRoaXMgcmVkdWNlciB0byBob2xkIG5vIHZhbHVlLCB5b3UgY2FuIHJldHVybiBudWxsIGluc3RlYWQgb2YgdW5kZWZpbmVkLmApOwogICAgICB9CiAgICAgIG5leHRTdGF0ZVtrZXldID0gbmV4dFN0YXRlRm9yS2V5OwogICAgICBoYXNDaGFuZ2VkID0gaGFzQ2hhbmdlZCB8fCBuZXh0U3RhdGVGb3JLZXkgIT09IHByZXZpb3VzU3RhdGVGb3JLZXk7CiAgICB9CiAgICBoYXNDaGFuZ2VkID0gaGFzQ2hhbmdlZCB8fCBmaW5hbFJlZHVjZXJLZXlzLmxlbmd0aCAhPT0gT2JqZWN0LmtleXMoc3RhdGUpLmxlbmd0aDsKICAgIHJldHVybiBoYXNDaGFuZ2VkID8gbmV4dFN0YXRlIDogc3RhdGU7CiAgfTsKfQpmdW5jdGlvbiBjb21wb3NlKC4uLmZ1bmNzKSB7CiAgaWYgKGZ1bmNzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIChhcmcpID0+IGFyZzsKICB9CiAgaWYgKGZ1bmNzLmxlbmd0aCA9PT0gMSkgewogICAgcmV0dXJuIGZ1bmNzWzBdOwogIH0KICByZXR1cm4gZnVuY3MucmVkdWNlKChhLCBiKSA9PiAoLi4uYXJncykgPT4gYShiKC4uLmFyZ3MpKSk7Cn0KZnVuY3Rpb24gYXBwbHlNaWRkbGV3YXJlKC4uLm1pZGRsZXdhcmVzKSB7CiAgcmV0dXJuIChjcmVhdGVTdG9yZTIpID0+IChyZWR1Y2VyLCBwcmVsb2FkZWRTdGF0ZSkgPT4gewogICAgY29uc3Qgc3RvcmUgPSBjcmVhdGVTdG9yZTIocmVkdWNlciwgcHJlbG9hZGVkU3RhdGUpOwogICAgbGV0IGRpc3BhdGNoID0gKCkgPT4gewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE1KSA6ICJEaXNwYXRjaGluZyB3aGlsZSBjb25zdHJ1Y3RpbmcgeW91ciBtaWRkbGV3YXJlIGlzIG5vdCBhbGxvd2VkLiBPdGhlciBtaWRkbGV3YXJlIHdvdWxkIG5vdCBiZSBhcHBsaWVkIHRvIHRoaXMgZGlzcGF0Y2guIik7CiAgICB9OwogICAgY29uc3QgbWlkZGxld2FyZUFQSSA9IHsKICAgICAgZ2V0U3RhdGU6IHN0b3JlLmdldFN0YXRlLAogICAgICBkaXNwYXRjaDogKGFjdGlvbiwgLi4uYXJncykgPT4gZGlzcGF0Y2goYWN0aW9uLCAuLi5hcmdzKQogICAgfTsKICAgIGNvbnN0IGNoYWluID0gbWlkZGxld2FyZXMubWFwKChtaWRkbGV3YXJlKSA9PiBtaWRkbGV3YXJlKG1pZGRsZXdhcmVBUEkpKTsKICAgIGRpc3BhdGNoID0gY29tcG9zZSguLi5jaGFpbikoc3RvcmUuZGlzcGF0Y2gpOwogICAgcmV0dXJuIHsKICAgICAgLi4uc3RvcmUsCiAgICAgIGRpc3BhdGNoCiAgICB9OwogIH07Cn0KZnVuY3Rpb24gaXNBY3Rpb24oYWN0aW9uKSB7CiAgcmV0dXJuIGlzUGxhaW5PYmplY3QoYWN0aW9uKSAmJiAidHlwZSIgaW4gYWN0aW9uICYmIHR5cGVvZiBhY3Rpb24udHlwZSA9PT0gInN0cmluZyI7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9pbW1lckAxMS4wLjEvbm9kZV9tb2R1bGVzL2ltbWVyL2Rpc3QvaW1tZXIubWpzCnZhciBOT1RISU5HID0gU3ltYm9sLmZvcigiaW1tZXItbm90aGluZyIpOwp2YXIgRFJBRlRBQkxFID0gU3ltYm9sLmZvcigiaW1tZXItZHJhZnRhYmxlIik7CnZhciBEUkFGVF9TVEFURSA9IFN5bWJvbC5mb3IoImltbWVyLXN0YXRlIik7CnZhciBlcnJvcnMgPSB0cnVlID8gWwogIC8vIEFsbCBlcnJvciBjb2Rlcywgc3RhcnRpbmcgYnkgMDoKICBmdW5jdGlvbihwbHVnaW4pIHsKICAgIHJldHVybiBgVGhlIHBsdWdpbiBmb3IgJyR7cGx1Z2lufScgaGFzIG5vdCBiZWVuIGxvYWRlZCBpbnRvIEltbWVyLiBUbyBlbmFibGUgdGhlIHBsdWdpbiwgaW1wb3J0IGFuZCBjYWxsIFxgZW5hYmxlJHtwbHVnaW59KClcYCB3aGVuIGluaXRpYWxpemluZyB5b3VyIGFwcGxpY2F0aW9uLmA7CiAgfSwKICBmdW5jdGlvbih0aGluZykgewogICAgcmV0dXJuIGBwcm9kdWNlIGNhbiBvbmx5IGJlIGNhbGxlZCBvbiB0aGluZ3MgdGhhdCBhcmUgZHJhZnRhYmxlOiBwbGFpbiBvYmplY3RzLCBhcnJheXMsIE1hcCwgU2V0IG9yIGNsYXNzZXMgdGhhdCBhcmUgbWFya2VkIHdpdGggJ1tpbW1lcmFibGVdOiB0cnVlJy4gR290ICcke3RoaW5nfSdgOwogIH0sCiAgIlRoaXMgb2JqZWN0IGhhcyBiZWVuIGZyb3plbiBhbmQgc2hvdWxkIG5vdCBiZSBtdXRhdGVkIiwKICBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gIkNhbm5vdCB1c2UgYSBwcm94eSB0aGF0IGhhcyBiZWVuIHJldm9rZWQuIERpZCB5b3UgcGFzcyBhbiBvYmplY3QgZnJvbSBpbnNpZGUgYW4gaW1tZXIgZnVuY3Rpb24gdG8gYW4gYXN5bmMgcHJvY2Vzcz8gIiArIGRhdGE7CiAgfSwKICAiQW4gaW1tZXIgcHJvZHVjZXIgcmV0dXJuZWQgYSBuZXcgdmFsdWUgKmFuZCogbW9kaWZpZWQgaXRzIGRyYWZ0LiBFaXRoZXIgcmV0dXJuIGEgbmV3IHZhbHVlICpvciogbW9kaWZ5IHRoZSBkcmFmdC4iLAogICJJbW1lciBmb3JiaWRzIGNpcmN1bGFyIHJlZmVyZW5jZXMiLAogICJUaGUgZmlyc3Qgb3Igc2Vjb25kIGFyZ3VtZW50IHRvIGBwcm9kdWNlYCBtdXN0IGJlIGEgZnVuY3Rpb24iLAogICJUaGUgdGhpcmQgYXJndW1lbnQgdG8gYHByb2R1Y2VgIG11c3QgYmUgYSBmdW5jdGlvbiBvciB1bmRlZmluZWQiLAogICJGaXJzdCBhcmd1bWVudCB0byBgY3JlYXRlRHJhZnRgIG11c3QgYmUgYSBwbGFpbiBvYmplY3QsIGFuIGFycmF5LCBvciBhbiBpbW1lcmFibGUgb2JqZWN0IiwKICAiRmlyc3QgYXJndW1lbnQgdG8gYGZpbmlzaERyYWZ0YCBtdXN0IGJlIGEgZHJhZnQgcmV0dXJuZWQgYnkgYGNyZWF0ZURyYWZ0YCIsCiAgZnVuY3Rpb24odGhpbmcpIHsKICAgIHJldHVybiBgJ2N1cnJlbnQnIGV4cGVjdHMgYSBkcmFmdCwgZ290OiAke3RoaW5nfWA7CiAgfSwKICAiT2JqZWN0LmRlZmluZVByb3BlcnR5KCkgY2Fubm90IGJlIHVzZWQgb24gYW4gSW1tZXIgZHJhZnQiLAogICJPYmplY3Quc2V0UHJvdG90eXBlT2YoKSBjYW5ub3QgYmUgdXNlZCBvbiBhbiBJbW1lciBkcmFmdCIsCiAgIkltbWVyIG9ubHkgc3VwcG9ydHMgZGVsZXRpbmcgYXJyYXkgaW5kaWNlcyIsCiAgIkltbWVyIG9ubHkgc3VwcG9ydHMgc2V0dGluZyBhcnJheSBpbmRpY2VzIGFuZCB0aGUgJ2xlbmd0aCcgcHJvcGVydHkiLAogIGZ1bmN0aW9uKHRoaW5nKSB7CiAgICByZXR1cm4gYCdvcmlnaW5hbCcgZXhwZWN0cyBhIGRyYWZ0LCBnb3Q6ICR7dGhpbmd9YDsKICB9CiAgLy8gTm90ZTogaWYgbW9yZSBlcnJvcnMgYXJlIGFkZGVkLCB0aGUgZXJyb3JPZmZzZXQgaW4gUGF0Y2hlcy50cyBzaG91bGQgYmUgaW5jcmVhc2VkCiAgLy8gU2VlIFBhdGNoZXMudHMgZm9yIGFkZGl0aW9uYWwgZXJyb3JzCl0gOiBbXTsKZnVuY3Rpb24gZGllKGVycm9yLCAuLi5hcmdzKSB7CiAgaWYgKHRydWUpIHsKICAgIGNvbnN0IGUgPSBlcnJvcnNbZXJyb3JdOwogICAgY29uc3QgbXNnID0gaXNGdW5jdGlvbihlKSA/IGUuYXBwbHkobnVsbCwgYXJncykgOiBlOwogICAgdGhyb3cgbmV3IEVycm9yKGBbSW1tZXJdICR7bXNnfWApOwogIH0KICB0aHJvdyBuZXcgRXJyb3IoCiAgICBgW0ltbWVyXSBtaW5pZmllZCBlcnJvciBucjogJHtlcnJvcn0uIEZ1bGwgZXJyb3IgYXQ6IGh0dHBzOi8vYml0Lmx5LzNjWEVLV2ZgCiAgKTsKfQp2YXIgTyA9IE9iamVjdDsKdmFyIGdldFByb3RvdHlwZU9mID0gTy5nZXRQcm90b3R5cGVPZjsKdmFyIENPTlNUUlVDVE9SID0gImNvbnN0cnVjdG9yIjsKdmFyIFBST1RPVFlQRSA9ICJwcm90b3R5cGUiOwp2YXIgQ09ORklHVVJBQkxFID0gImNvbmZpZ3VyYWJsZSI7CnZhciBFTlVNRVJBQkxFID0gImVudW1lcmFibGUiOwp2YXIgV1JJVEFCTEUgPSAid3JpdGFibGUiOwp2YXIgVkFMVUUgPSAidmFsdWUiOwp2YXIgaXNEcmFmdCA9ICh2YWx1ZSkgPT4gISF2YWx1ZSAmJiAhIXZhbHVlW0RSQUZUX1NUQVRFXTsKZnVuY3Rpb24gaXNEcmFmdGFibGUodmFsdWUpIHsKICBpZiAoIXZhbHVlKQogICAgcmV0dXJuIGZhbHNlOwogIHJldHVybiBpc1BsYWluT2JqZWN0Mih2YWx1ZSkgfHwgaXNBcnJheSh2YWx1ZSkgfHwgISF2YWx1ZVtEUkFGVEFCTEVdIHx8ICEhdmFsdWVbQ09OU1RSVUNUT1JdPy5bRFJBRlRBQkxFXSB8fCBpc01hcCh2YWx1ZSkgfHwgaXNTZXQodmFsdWUpOwp9CnZhciBvYmplY3RDdG9yU3RyaW5nID0gT1tQUk9UT1RZUEVdW0NPTlNUUlVDVE9SXS50b1N0cmluZygpOwp2YXIgY2FjaGVkQ3RvclN0cmluZ3MgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKZnVuY3Rpb24gaXNQbGFpbk9iamVjdDIodmFsdWUpIHsKICBpZiAoIXZhbHVlIHx8ICFpc09iamVjdGlzaCh2YWx1ZSkpCiAgICByZXR1cm4gZmFsc2U7CiAgY29uc3QgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2YodmFsdWUpOwogIGlmIChwcm90bzIgPT09IG51bGwgfHwgcHJvdG8yID09PSBPW1BST1RPVFlQRV0pCiAgICByZXR1cm4gdHJ1ZTsKICBjb25zdCBDdG9yID0gTy5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb3RvMiwgQ09OU1RSVUNUT1IpICYmIHByb3RvMltDT05TVFJVQ1RPUl07CiAgaWYgKEN0b3IgPT09IE9iamVjdCkKICAgIHJldHVybiB0cnVlOwogIGlmICghaXNGdW5jdGlvbihDdG9yKSkKICAgIHJldHVybiBmYWxzZTsKICBsZXQgY3RvclN0cmluZyA9IGNhY2hlZEN0b3JTdHJpbmdzLmdldChDdG9yKTsKICBpZiAoY3RvclN0cmluZyA9PT0gdm9pZCAwKSB7CiAgICBjdG9yU3RyaW5nID0gRnVuY3Rpb24udG9TdHJpbmcuY2FsbChDdG9yKTsKICAgIGNhY2hlZEN0b3JTdHJpbmdzLnNldChDdG9yLCBjdG9yU3RyaW5nKTsKICB9CiAgcmV0dXJuIGN0b3JTdHJpbmcgPT09IG9iamVjdEN0b3JTdHJpbmc7Cn0KZnVuY3Rpb24gZWFjaChvYmosIGl0ZXIsIHN0cmljdCA9IHRydWUpIHsKICBpZiAoZ2V0QXJjaHR5cGUob2JqKSA9PT0gMCkgewogICAgY29uc3Qga2V5cyA9IHN0cmljdCA/IFJlZmxlY3Qub3duS2V5cyhvYmopIDogTy5rZXlzKG9iaik7CiAgICBrZXlzLmZvckVhY2goKGtleSkgPT4gewogICAgICBpdGVyKGtleSwgb2JqW2tleV0sIG9iaik7CiAgICB9KTsKICB9IGVsc2UgewogICAgb2JqLmZvckVhY2goKGVudHJ5LCBpbmRleCkgPT4gaXRlcihpbmRleCwgZW50cnksIG9iaikpOwogIH0KfQpmdW5jdGlvbiBnZXRBcmNodHlwZSh0aGluZykgewogIGNvbnN0IHN0YXRlID0gdGhpbmdbRFJBRlRfU1RBVEVdOwogIHJldHVybiBzdGF0ZSA/IHN0YXRlLnR5cGVfIDogaXNBcnJheSh0aGluZykgPyAxIDogaXNNYXAodGhpbmcpID8gMiA6IGlzU2V0KHRoaW5nKSA/IDMgOiAwOwp9CnZhciBoYXMgPSAodGhpbmcsIHByb3AsIHR5cGUgPSBnZXRBcmNodHlwZSh0aGluZykpID0+IHR5cGUgPT09IDIgPyB0aGluZy5oYXMocHJvcCkgOiBPW1BST1RPVFlQRV0uaGFzT3duUHJvcGVydHkuY2FsbCh0aGluZywgcHJvcCk7CnZhciBnZXQyID0gKHRoaW5nLCBwcm9wLCB0eXBlID0gZ2V0QXJjaHR5cGUodGhpbmcpKSA9PiAoCiAgLy8gQHRzLWlnbm9yZQogIHR5cGUgPT09IDIgPyB0aGluZy5nZXQocHJvcCkgOiB0aGluZ1twcm9wXQopOwp2YXIgc2V0ID0gKHRoaW5nLCBwcm9wT3JPbGRWYWx1ZSwgdmFsdWUsIHR5cGUgPSBnZXRBcmNodHlwZSh0aGluZykpID0+IHsKICBpZiAodHlwZSA9PT0gMikKICAgIHRoaW5nLnNldChwcm9wT3JPbGRWYWx1ZSwgdmFsdWUpOwogIGVsc2UgaWYgKHR5cGUgPT09IDMpIHsKICAgIHRoaW5nLmFkZCh2YWx1ZSk7CiAgfSBlbHNlCiAgICB0aGluZ1twcm9wT3JPbGRWYWx1ZV0gPSB2YWx1ZTsKfTsKZnVuY3Rpb24gaXMoeDIsIHkyKSB7CiAgaWYgKHgyID09PSB5MikgewogICAgcmV0dXJuIHgyICE9PSAwIHx8IDEgLyB4MiA9PT0gMSAvIHkyOwogIH0gZWxzZSB7CiAgICByZXR1cm4geDIgIT09IHgyICYmIHkyICE9PSB5MjsKICB9Cn0KdmFyIGlzQXJyYXkgPSBBcnJheS5pc0FycmF5Owp2YXIgaXNNYXAgPSAodGFyZ2V0KSA9PiB0YXJnZXQgaW5zdGFuY2VvZiBNYXA7CnZhciBpc1NldCA9ICh0YXJnZXQpID0+IHRhcmdldCBpbnN0YW5jZW9mIFNldDsKdmFyIGlzT2JqZWN0aXNoID0gKHRhcmdldCkgPT4gdHlwZW9mIHRhcmdldCA9PT0gIm9iamVjdCI7CnZhciBpc0Z1bmN0aW9uID0gKHRhcmdldCkgPT4gdHlwZW9mIHRhcmdldCA9PT0gImZ1bmN0aW9uIjsKdmFyIGlzQm9vbGVhbiA9ICh0YXJnZXQpID0+IHR5cGVvZiB0YXJnZXQgPT09ICJib29sZWFuIjsKdmFyIGxhdGVzdCA9IChzdGF0ZSkgPT4gc3RhdGUuY29weV8gfHwgc3RhdGUuYmFzZV87CnZhciBnZXRGaW5hbFZhbHVlID0gKHN0YXRlKSA9PiBzdGF0ZS5tb2RpZmllZF8gPyBzdGF0ZS5jb3B5XyA6IHN0YXRlLmJhc2VfOwpmdW5jdGlvbiBzaGFsbG93Q29weShiYXNlLCBzdHJpY3QpIHsKICBpZiAoaXNNYXAoYmFzZSkpIHsKICAgIHJldHVybiBuZXcgTWFwKGJhc2UpOwogIH0KICBpZiAoaXNTZXQoYmFzZSkpIHsKICAgIHJldHVybiBuZXcgU2V0KGJhc2UpOwogIH0KICBpZiAoaXNBcnJheShiYXNlKSkKICAgIHJldHVybiBBcnJheVtQUk9UT1RZUEVdLnNsaWNlLmNhbGwoYmFzZSk7CiAgY29uc3QgaXNQbGFpbjIgPSBpc1BsYWluT2JqZWN0MihiYXNlKTsKICBpZiAoc3RyaWN0ID09PSB0cnVlIHx8IHN0cmljdCA9PT0gImNsYXNzX29ubHkiICYmICFpc1BsYWluMikgewogICAgY29uc3QgZGVzY3JpcHRvcnMgPSBPLmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMoYmFzZSk7CiAgICBkZWxldGUgZGVzY3JpcHRvcnNbRFJBRlRfU1RBVEVdOwogICAgbGV0IGtleXMgPSBSZWZsZWN0Lm93bktleXMoZGVzY3JpcHRvcnMpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICAgIGNvbnN0IGRlc2MgPSBkZXNjcmlwdG9yc1trZXldOwogICAgICBpZiAoZGVzY1tXUklUQUJMRV0gPT09IGZhbHNlKSB7CiAgICAgICAgZGVzY1tXUklUQUJMRV0gPSB0cnVlOwogICAgICAgIGRlc2NbQ09ORklHVVJBQkxFXSA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKGRlc2MuZ2V0IHx8IGRlc2Muc2V0KQogICAgICAgIGRlc2NyaXB0b3JzW2tleV0gPSB7CiAgICAgICAgICBbQ09ORklHVVJBQkxFXTogdHJ1ZSwKICAgICAgICAgIFtXUklUQUJMRV06IHRydWUsCiAgICAgICAgICAvLyBjb3VsZCBsaXZlIHdpdGggISFkZXNjLnNldCBhcyB3ZWxsIGhlcmUuLi4KICAgICAgICAgIFtFTlVNRVJBQkxFXTogZGVzY1tFTlVNRVJBQkxFXSwKICAgICAgICAgIFtWQUxVRV06IGJhc2Vba2V5XQogICAgICAgIH07CiAgICB9CiAgICByZXR1cm4gTy5jcmVhdGUoZ2V0UHJvdG90eXBlT2YoYmFzZSksIGRlc2NyaXB0b3JzKTsKICB9IGVsc2UgewogICAgY29uc3QgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2YoYmFzZSk7CiAgICBpZiAocHJvdG8yICE9PSBudWxsICYmIGlzUGxhaW4yKSB7CiAgICAgIHJldHVybiB7IC4uLmJhc2UgfTsKICAgIH0KICAgIGNvbnN0IG9iaiA9IE8uY3JlYXRlKHByb3RvMik7CiAgICByZXR1cm4gTy5hc3NpZ24ob2JqLCBiYXNlKTsKICB9Cn0KZnVuY3Rpb24gZnJlZXplKG9iaiwgZGVlcCA9IGZhbHNlKSB7CiAgaWYgKGlzRnJvemVuKG9iaikgfHwgaXNEcmFmdChvYmopIHx8ICFpc0RyYWZ0YWJsZShvYmopKQogICAgcmV0dXJuIG9iajsKICBpZiAoZ2V0QXJjaHR5cGUob2JqKSA+IDEpIHsKICAgIE8uZGVmaW5lUHJvcGVydGllcyhvYmosIHsKICAgICAgc2V0OiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUsCiAgICAgIGFkZDogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlLAogICAgICBjbGVhcjogZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlLAogICAgICBkZWxldGU6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZQogICAgfSk7CiAgfQogIE8uZnJlZXplKG9iaik7CiAgaWYgKGRlZXApCiAgICBlYWNoKAogICAgICBvYmosCiAgICAgIChfa2V5LCB2YWx1ZSkgPT4gewogICAgICAgIGZyZWV6ZSh2YWx1ZSwgdHJ1ZSk7CiAgICAgIH0sCiAgICAgIGZhbHNlCiAgICApOwogIHJldHVybiBvYmo7Cn0KZnVuY3Rpb24gZG9udE11dGF0ZUZyb3plbkNvbGxlY3Rpb25zKCkgewogIGRpZSgyKTsKfQp2YXIgZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlID0gewogIFtWQUxVRV06IGRvbnRNdXRhdGVGcm96ZW5Db2xsZWN0aW9ucwp9OwpmdW5jdGlvbiBpc0Zyb3plbihvYmopIHsKICBpZiAob2JqID09PSBudWxsIHx8ICFpc09iamVjdGlzaChvYmopKQogICAgcmV0dXJuIHRydWU7CiAgcmV0dXJuIE8uaXNGcm96ZW4ob2JqKTsKfQp2YXIgUGx1Z2luTWFwU2V0ID0gIk1hcFNldCI7CnZhciBQbHVnaW5QYXRjaGVzID0gIlBhdGNoZXMiOwp2YXIgcGx1Z2lucyA9IHt9OwpmdW5jdGlvbiBnZXRQbHVnaW4ocGx1Z2luS2V5KSB7CiAgY29uc3QgcGx1Z2luID0gcGx1Z2luc1twbHVnaW5LZXldOwogIGlmICghcGx1Z2luKSB7CiAgICBkaWUoMCwgcGx1Z2luS2V5KTsKICB9CiAgcmV0dXJuIHBsdWdpbjsKfQp2YXIgaXNQbHVnaW5Mb2FkZWQgPSAocGx1Z2luS2V5KSA9PiAhIXBsdWdpbnNbcGx1Z2luS2V5XTsKdmFyIGN1cnJlbnRTY29wZTsKdmFyIGdldEN1cnJlbnRTY29wZSA9ICgpID0+IGN1cnJlbnRTY29wZTsKdmFyIGNyZWF0ZVNjb3BlID0gKHBhcmVudF8sIGltbWVyXykgPT4gKHsKICBkcmFmdHNfOiBbXSwKICBwYXJlbnRfLAogIGltbWVyXywKICAvLyBXaGVuZXZlciB0aGUgbW9kaWZpZWQgZHJhZnQgY29udGFpbnMgYSBkcmFmdCBmcm9tIGFub3RoZXIgc2NvcGUsIHdlCiAgLy8gbmVlZCB0byBwcmV2ZW50IGF1dG8tZnJlZXppbmcgc28gdGhlIHVub3duZWQgZHJhZnQgY2FuIGJlIGZpbmFsaXplZC4KICBjYW5BdXRvRnJlZXplXzogdHJ1ZSwKICB1bmZpbmFsaXplZERyYWZ0c186IDAsCiAgaGFuZGxlZFNldF86IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksCiAgcHJvY2Vzc2VkRm9yUGF0Y2hlc186IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksCiAgbWFwU2V0UGx1Z2luXzogaXNQbHVnaW5Mb2FkZWQoUGx1Z2luTWFwU2V0KSA/IGdldFBsdWdpbihQbHVnaW5NYXBTZXQpIDogdm9pZCAwCn0pOwpmdW5jdGlvbiB1c2VQYXRjaGVzSW5TY29wZShzY29wZSwgcGF0Y2hMaXN0ZW5lcikgewogIGlmIChwYXRjaExpc3RlbmVyKSB7CiAgICBzY29wZS5wYXRjaFBsdWdpbl8gPSBnZXRQbHVnaW4oUGx1Z2luUGF0Y2hlcyk7CiAgICBzY29wZS5wYXRjaGVzXyA9IFtdOwogICAgc2NvcGUuaW52ZXJzZVBhdGNoZXNfID0gW107CiAgICBzY29wZS5wYXRjaExpc3RlbmVyXyA9IHBhdGNoTGlzdGVuZXI7CiAgfQp9CmZ1bmN0aW9uIHJldm9rZVNjb3BlKHNjb3BlKSB7CiAgbGVhdmVTY29wZShzY29wZSk7CiAgc2NvcGUuZHJhZnRzXy5mb3JFYWNoKHJldm9rZURyYWZ0KTsKICBzY29wZS5kcmFmdHNfID0gbnVsbDsKfQpmdW5jdGlvbiBsZWF2ZVNjb3BlKHNjb3BlKSB7CiAgaWYgKHNjb3BlID09PSBjdXJyZW50U2NvcGUpIHsKICAgIGN1cnJlbnRTY29wZSA9IHNjb3BlLnBhcmVudF87CiAgfQp9CnZhciBlbnRlclNjb3BlID0gKGltbWVyMjIpID0+IGN1cnJlbnRTY29wZSA9IGNyZWF0ZVNjb3BlKGN1cnJlbnRTY29wZSwgaW1tZXIyMik7CmZ1bmN0aW9uIHJldm9rZURyYWZ0KGRyYWZ0KSB7CiAgY29uc3Qgc3RhdGUgPSBkcmFmdFtEUkFGVF9TVEFURV07CiAgaWYgKHN0YXRlLnR5cGVfID09PSAwIHx8IHN0YXRlLnR5cGVfID09PSAxKQogICAgc3RhdGUucmV2b2tlXygpOwogIGVsc2UKICAgIHN0YXRlLnJldm9rZWRfID0gdHJ1ZTsKfQpmdW5jdGlvbiBwcm9jZXNzUmVzdWx0KHJlc3VsdCwgc2NvcGUpIHsKICBzY29wZS51bmZpbmFsaXplZERyYWZ0c18gPSBzY29wZS5kcmFmdHNfLmxlbmd0aDsKICBjb25zdCBiYXNlRHJhZnQgPSBzY29wZS5kcmFmdHNfWzBdOwogIGNvbnN0IGlzUmVwbGFjZWQgPSByZXN1bHQgIT09IHZvaWQgMCAmJiByZXN1bHQgIT09IGJhc2VEcmFmdDsKICBpZiAoaXNSZXBsYWNlZCkgewogICAgaWYgKGJhc2VEcmFmdFtEUkFGVF9TVEFURV0ubW9kaWZpZWRfKSB7CiAgICAgIHJldm9rZVNjb3BlKHNjb3BlKTsKICAgICAgZGllKDQpOwogICAgfQogICAgaWYgKGlzRHJhZnRhYmxlKHJlc3VsdCkpIHsKICAgICAgcmVzdWx0ID0gZmluYWxpemUoc2NvcGUsIHJlc3VsdCk7CiAgICB9CiAgICBjb25zdCB7IHBhdGNoUGx1Z2luXyB9ID0gc2NvcGU7CiAgICBpZiAocGF0Y2hQbHVnaW5fKSB7CiAgICAgIHBhdGNoUGx1Z2luXy5nZW5lcmF0ZVJlcGxhY2VtZW50UGF0Y2hlc18oCiAgICAgICAgYmFzZURyYWZ0W0RSQUZUX1NUQVRFXS5iYXNlXywKICAgICAgICByZXN1bHQsCiAgICAgICAgc2NvcGUKICAgICAgKTsKICAgIH0KICB9IGVsc2UgewogICAgcmVzdWx0ID0gZmluYWxpemUoc2NvcGUsIGJhc2VEcmFmdCk7CiAgfQogIG1heWJlRnJlZXplKHNjb3BlLCByZXN1bHQsIHRydWUpOwogIHJldm9rZVNjb3BlKHNjb3BlKTsKICBpZiAoc2NvcGUucGF0Y2hlc18pIHsKICAgIHNjb3BlLnBhdGNoTGlzdGVuZXJfKHNjb3BlLnBhdGNoZXNfLCBzY29wZS5pbnZlcnNlUGF0Y2hlc18pOwogIH0KICByZXR1cm4gcmVzdWx0ICE9PSBOT1RISU5HID8gcmVzdWx0IDogdm9pZCAwOwp9CmZ1bmN0aW9uIGZpbmFsaXplKHJvb3RTY29wZSwgdmFsdWUpIHsKICBpZiAoaXNGcm96ZW4odmFsdWUpKQogICAgcmV0dXJuIHZhbHVlOwogIGNvbnN0IHN0YXRlID0gdmFsdWVbRFJBRlRfU1RBVEVdOwogIGlmICghc3RhdGUpIHsKICAgIGNvbnN0IGZpbmFsVmFsdWUgPSBoYW5kbGVWYWx1ZSh2YWx1ZSwgcm9vdFNjb3BlLmhhbmRsZWRTZXRfLCByb290U2NvcGUpOwogICAgcmV0dXJuIGZpbmFsVmFsdWU7CiAgfQogIGlmICghaXNTYW1lU2NvcGUoc3RhdGUsIHJvb3RTY29wZSkpIHsKICAgIHJldHVybiB2YWx1ZTsKICB9CiAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pIHsKICAgIHJldHVybiBzdGF0ZS5iYXNlXzsKICB9CiAgaWYgKCFzdGF0ZS5maW5hbGl6ZWRfKSB7CiAgICBjb25zdCB7IGNhbGxiYWNrc18gfSA9IHN0YXRlOwogICAgaWYgKGNhbGxiYWNrc18pIHsKICAgICAgd2hpbGUgKGNhbGxiYWNrc18ubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnN0IGNhbGxiYWNrID0gY2FsbGJhY2tzXy5wb3AoKTsKICAgICAgICBjYWxsYmFjayhyb290U2NvcGUpOwogICAgICB9CiAgICB9CiAgICBnZW5lcmF0ZVBhdGNoZXNBbmRGaW5hbGl6ZShzdGF0ZSwgcm9vdFNjb3BlKTsKICB9CiAgcmV0dXJuIHN0YXRlLmNvcHlfOwp9CmZ1bmN0aW9uIG1heWJlRnJlZXplKHNjb3BlLCB2YWx1ZSwgZGVlcCA9IGZhbHNlKSB7CiAgaWYgKCFzY29wZS5wYXJlbnRfICYmIHNjb3BlLmltbWVyXy5hdXRvRnJlZXplXyAmJiBzY29wZS5jYW5BdXRvRnJlZXplXykgewogICAgZnJlZXplKHZhbHVlLCBkZWVwKTsKICB9Cn0KZnVuY3Rpb24gbWFya1N0YXRlRmluYWxpemVkKHN0YXRlKSB7CiAgc3RhdGUuZmluYWxpemVkXyA9IHRydWU7CiAgc3RhdGUuc2NvcGVfLnVuZmluYWxpemVkRHJhZnRzXy0tOwp9CnZhciBpc1NhbWVTY29wZSA9IChzdGF0ZSwgcm9vdFNjb3BlKSA9PiBzdGF0ZS5zY29wZV8gPT09IHJvb3RTY29wZTsKdmFyIEVNUFRZX0xPQ0FUSU9OU19SRVNVTFQgPSBbXTsKZnVuY3Rpb24gdXBkYXRlRHJhZnRJblBhcmVudChwYXJlbnQsIGRyYWZ0VmFsdWUsIGZpbmFsaXplZFZhbHVlLCBvcmlnaW5hbEtleSkgewogIGNvbnN0IHBhcmVudENvcHkgPSBsYXRlc3QocGFyZW50KTsKICBjb25zdCBwYXJlbnRUeXBlID0gcGFyZW50LnR5cGVfOwogIGlmIChvcmlnaW5hbEtleSAhPT0gdm9pZCAwKSB7CiAgICBjb25zdCBjdXJyZW50VmFsdWUgPSBnZXQyKHBhcmVudENvcHksIG9yaWdpbmFsS2V5LCBwYXJlbnRUeXBlKTsKICAgIGlmIChjdXJyZW50VmFsdWUgPT09IGRyYWZ0VmFsdWUpIHsKICAgICAgc2V0KHBhcmVudENvcHksIG9yaWdpbmFsS2V5LCBmaW5hbGl6ZWRWYWx1ZSwgcGFyZW50VHlwZSk7CiAgICAgIHJldHVybjsKICAgIH0KICB9CiAgaWYgKCFwYXJlbnQuZHJhZnRMb2NhdGlvbnNfKSB7CiAgICBjb25zdCBkcmFmdExvY2F0aW9ucyA9IHBhcmVudC5kcmFmdExvY2F0aW9uc18gPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgZWFjaChwYXJlbnRDb3B5LCAoa2V5LCB2YWx1ZSkgPT4gewogICAgICBpZiAoaXNEcmFmdCh2YWx1ZSkpIHsKICAgICAgICBjb25zdCBrZXlzID0gZHJhZnRMb2NhdGlvbnMuZ2V0KHZhbHVlKSB8fCBbXTsKICAgICAgICBrZXlzLnB1c2goa2V5KTsKICAgICAgICBkcmFmdExvY2F0aW9ucy5zZXQodmFsdWUsIGtleXMpOwogICAgICB9CiAgICB9KTsKICB9CiAgY29uc3QgbG9jYXRpb25zID0gcGFyZW50LmRyYWZ0TG9jYXRpb25zXy5nZXQoZHJhZnRWYWx1ZSkgPz8gRU1QVFlfTE9DQVRJT05TX1JFU1VMVDsKICBmb3IgKGNvbnN0IGxvY2F0aW9uIG9mIGxvY2F0aW9ucykgewogICAgc2V0KHBhcmVudENvcHksIGxvY2F0aW9uLCBmaW5hbGl6ZWRWYWx1ZSwgcGFyZW50VHlwZSk7CiAgfQp9CmZ1bmN0aW9uIHJlZ2lzdGVyQ2hpbGRGaW5hbGl6YXRpb25DYWxsYmFjayhwYXJlbnQsIGNoaWxkLCBrZXkpIHsKICBwYXJlbnQuY2FsbGJhY2tzXy5wdXNoKGZ1bmN0aW9uIGNoaWxkQ2xlYW51cChyb290U2NvcGUpIHsKICAgIGNvbnN0IHN0YXRlID0gY2hpbGQ7CiAgICBpZiAoIXN0YXRlIHx8ICFpc1NhbWVTY29wZShzdGF0ZSwgcm9vdFNjb3BlKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICByb290U2NvcGUubWFwU2V0UGx1Z2luXz8uZml4U2V0Q29udGVudHMoc3RhdGUpOwogICAgY29uc3QgZmluYWxpemVkVmFsdWUgPSBnZXRGaW5hbFZhbHVlKHN0YXRlKTsKICAgIHVwZGF0ZURyYWZ0SW5QYXJlbnQocGFyZW50LCBzdGF0ZS5kcmFmdF8gPz8gc3RhdGUsIGZpbmFsaXplZFZhbHVlLCBrZXkpOwogICAgZ2VuZXJhdGVQYXRjaGVzQW5kRmluYWxpemUoc3RhdGUsIHJvb3RTY29wZSk7CiAgfSk7Cn0KZnVuY3Rpb24gZ2VuZXJhdGVQYXRjaGVzQW5kRmluYWxpemUoc3RhdGUsIHJvb3RTY29wZSkgewogIGNvbnN0IHNob3VsZEZpbmFsaXplID0gc3RhdGUubW9kaWZpZWRfICYmICFzdGF0ZS5maW5hbGl6ZWRfICYmIChzdGF0ZS50eXBlXyA9PT0gMyB8fCAoc3RhdGUuYXNzaWduZWRfPy5zaXplID8/IDApID4gMCk7CiAgaWYgKHNob3VsZEZpbmFsaXplKSB7CiAgICBjb25zdCB7IHBhdGNoUGx1Z2luXyB9ID0gcm9vdFNjb3BlOwogICAgaWYgKHBhdGNoUGx1Z2luXykgewogICAgICBjb25zdCBiYXNlUGF0aCA9IHBhdGNoUGx1Z2luXy5nZXRQYXRoKHN0YXRlKTsKICAgICAgaWYgKGJhc2VQYXRoKSB7CiAgICAgICAgcGF0Y2hQbHVnaW5fLmdlbmVyYXRlUGF0Y2hlc18oc3RhdGUsIGJhc2VQYXRoLCByb290U2NvcGUpOwogICAgICB9CiAgICB9CiAgICBtYXJrU3RhdGVGaW5hbGl6ZWQoc3RhdGUpOwogIH0KfQpmdW5jdGlvbiBoYW5kbGVDcm9zc1JlZmVyZW5jZSh0YXJnZXQsIGtleSwgdmFsdWUpIHsKICBjb25zdCB7IHNjb3BlXyB9ID0gdGFyZ2V0OwogIGlmIChpc0RyYWZ0KHZhbHVlKSkgewogICAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURV07CiAgICBpZiAoaXNTYW1lU2NvcGUoc3RhdGUsIHNjb3BlXykpIHsKICAgICAgc3RhdGUuY2FsbGJhY2tzXy5wdXNoKGZ1bmN0aW9uIGNyb3NzUmVmZXJlbmNlQ2xlYW51cCgpIHsKICAgICAgICBwcmVwYXJlQ29weSh0YXJnZXQpOwogICAgICAgIGNvbnN0IGZpbmFsaXplZFZhbHVlID0gZ2V0RmluYWxWYWx1ZShzdGF0ZSk7CiAgICAgICAgdXBkYXRlRHJhZnRJblBhcmVudCh0YXJnZXQsIHZhbHVlLCBmaW5hbGl6ZWRWYWx1ZSwga2V5KTsKICAgICAgfSk7CiAgICB9CiAgfSBlbHNlIGlmIChpc0RyYWZ0YWJsZSh2YWx1ZSkpIHsKICAgIHRhcmdldC5jYWxsYmFja3NfLnB1c2goZnVuY3Rpb24gbmVzdGVkRHJhZnRDbGVhbnVwKCkgewogICAgICBjb25zdCB0YXJnZXRDb3B5ID0gbGF0ZXN0KHRhcmdldCk7CiAgICAgIGlmIChnZXQyKHRhcmdldENvcHksIGtleSwgdGFyZ2V0LnR5cGVfKSA9PT0gdmFsdWUpIHsKICAgICAgICBpZiAoc2NvcGVfLmRyYWZ0c18ubGVuZ3RoID4gMSAmJiAodGFyZ2V0LmFzc2lnbmVkXy5nZXQoa2V5KSA/PyBmYWxzZSkgPT09IHRydWUgJiYgdGFyZ2V0LmNvcHlfKSB7CiAgICAgICAgICBoYW5kbGVWYWx1ZSgKICAgICAgICAgICAgZ2V0Mih0YXJnZXQuY29weV8sIGtleSwgdGFyZ2V0LnR5cGVfKSwKICAgICAgICAgICAgc2NvcGVfLmhhbmRsZWRTZXRfLAogICAgICAgICAgICBzY29wZV8KICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9Cn0KZnVuY3Rpb24gaGFuZGxlVmFsdWUodGFyZ2V0LCBoYW5kbGVkU2V0LCByb290U2NvcGUpIHsKICBpZiAoIXJvb3RTY29wZS5pbW1lcl8uYXV0b0ZyZWV6ZV8gJiYgcm9vdFNjb3BlLnVuZmluYWxpemVkRHJhZnRzXyA8IDEpIHsKICAgIHJldHVybiB0YXJnZXQ7CiAgfQogIGlmIChpc0RyYWZ0KHRhcmdldCkgfHwgaGFuZGxlZFNldC5oYXModGFyZ2V0KSB8fCAhaXNEcmFmdGFibGUodGFyZ2V0KSB8fCBpc0Zyb3plbih0YXJnZXQpKSB7CiAgICByZXR1cm4gdGFyZ2V0OwogIH0KICBoYW5kbGVkU2V0LmFkZCh0YXJnZXQpOwogIGVhY2godGFyZ2V0LCAoa2V5LCB2YWx1ZSkgPT4gewogICAgaWYgKGlzRHJhZnQodmFsdWUpKSB7CiAgICAgIGNvbnN0IHN0YXRlID0gdmFsdWVbRFJBRlRfU1RBVEVdOwogICAgICBpZiAoaXNTYW1lU2NvcGUoc3RhdGUsIHJvb3RTY29wZSkpIHsKICAgICAgICBjb25zdCB1cGRhdGVkVmFsdWUgPSBnZXRGaW5hbFZhbHVlKHN0YXRlKTsKICAgICAgICBzZXQodGFyZ2V0LCBrZXksIHVwZGF0ZWRWYWx1ZSwgdGFyZ2V0LnR5cGVfKTsKICAgICAgICBtYXJrU3RhdGVGaW5hbGl6ZWQoc3RhdGUpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzRHJhZnRhYmxlKHZhbHVlKSkgewogICAgICBoYW5kbGVWYWx1ZSh2YWx1ZSwgaGFuZGxlZFNldCwgcm9vdFNjb3BlKTsKICAgIH0KICB9KTsKICByZXR1cm4gdGFyZ2V0Owp9CmZ1bmN0aW9uIGNyZWF0ZVByb3h5UHJveHkoYmFzZSwgcGFyZW50KSB7CiAgY29uc3QgYmFzZUlzQXJyYXkgPSBpc0FycmF5KGJhc2UpOwogIGNvbnN0IHN0YXRlID0gewogICAgdHlwZV86IGJhc2VJc0FycmF5ID8gMSA6IDAsCiAgICAvLyBUcmFjayB3aGljaCBwcm9kdWNlIGNhbGwgdGhpcyBpcyBhc3NvY2lhdGVkIHdpdGguCiAgICBzY29wZV86IHBhcmVudCA/IHBhcmVudC5zY29wZV8gOiBnZXRDdXJyZW50U2NvcGUoKSwKICAgIC8vIFRydWUgZm9yIGJvdGggc2hhbGxvdyBhbmQgZGVlcCBjaGFuZ2VzLgogICAgbW9kaWZpZWRfOiBmYWxzZSwKICAgIC8vIFVzZWQgZHVyaW5nIGZpbmFsaXphdGlvbi4KICAgIGZpbmFsaXplZF86IGZhbHNlLAogICAgLy8gVHJhY2sgd2hpY2ggcHJvcGVydGllcyBoYXZlIGJlZW4gYXNzaWduZWQgKHRydWUpIG9yIGRlbGV0ZWQgKGZhbHNlKS4KICAgIC8vIGFjdHVhbGx5IGluc3RhbnRpYXRlZCBpbiBgcHJlcGFyZUNvcHkoKWAKICAgIGFzc2lnbmVkXzogdm9pZCAwLAogICAgLy8gVGhlIHBhcmVudCBkcmFmdCBzdGF0ZS4KICAgIHBhcmVudF86IHBhcmVudCwKICAgIC8vIFRoZSBiYXNlIHN0YXRlLgogICAgYmFzZV86IGJhc2UsCiAgICAvLyBUaGUgYmFzZSBwcm94eS4KICAgIGRyYWZ0XzogbnVsbCwKICAgIC8vIHNldCBiZWxvdwogICAgLy8gVGhlIGJhc2UgY29weSB3aXRoIGFueSB1cGRhdGVkIHZhbHVlcy4KICAgIGNvcHlfOiBudWxsLAogICAgLy8gQ2FsbGVkIGJ5IHRoZSBgcHJvZHVjZWAgZnVuY3Rpb24uCiAgICByZXZva2VfOiBudWxsLAogICAgaXNNYW51YWxfOiBmYWxzZSwKICAgIC8vIGBjYWxsYmFja3NgIGFjdHVhbGx5IGdldHMgYXNzaWduZWQgaW4gYGNyZWF0ZVByb3h5YAogICAgY2FsbGJhY2tzXzogdm9pZCAwCiAgfTsKICBsZXQgdGFyZ2V0ID0gc3RhdGU7CiAgbGV0IHRyYXBzID0gb2JqZWN0VHJhcHM7CiAgaWYgKGJhc2VJc0FycmF5KSB7CiAgICB0YXJnZXQgPSBbc3RhdGVdOwogICAgdHJhcHMgPSBhcnJheVRyYXBzOwogIH0KICBjb25zdCB7IHJldm9rZSwgcHJveHkgfSA9IFByb3h5LnJldm9jYWJsZSh0YXJnZXQsIHRyYXBzKTsKICBzdGF0ZS5kcmFmdF8gPSBwcm94eTsKICBzdGF0ZS5yZXZva2VfID0gcmV2b2tlOwogIHJldHVybiBbcHJveHksIHN0YXRlXTsKfQp2YXIgb2JqZWN0VHJhcHMgPSB7CiAgZ2V0KHN0YXRlLCBwcm9wKSB7CiAgICBpZiAocHJvcCA9PT0gRFJBRlRfU1RBVEUpCiAgICAgIHJldHVybiBzdGF0ZTsKICAgIGNvbnN0IHNvdXJjZSA9IGxhdGVzdChzdGF0ZSk7CiAgICBpZiAoIWhhcyhzb3VyY2UsIHByb3AsIHN0YXRlLnR5cGVfKSkgewogICAgICByZXR1cm4gcmVhZFByb3BGcm9tUHJvdG8oc3RhdGUsIHNvdXJjZSwgcHJvcCk7CiAgICB9CiAgICBjb25zdCB2YWx1ZSA9IHNvdXJjZVtwcm9wXTsKICAgIGlmIChzdGF0ZS5maW5hbGl6ZWRfIHx8ICFpc0RyYWZ0YWJsZSh2YWx1ZSkpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgaWYgKHZhbHVlID09PSBwZWVrKHN0YXRlLmJhc2VfLCBwcm9wKSkgewogICAgICBwcmVwYXJlQ29weShzdGF0ZSk7CiAgICAgIGNvbnN0IGNoaWxkS2V5ID0gc3RhdGUudHlwZV8gPT09IDEgPyArcHJvcCA6IHByb3A7CiAgICAgIGNvbnN0IGNoaWxkRHJhZnQgPSBjcmVhdGVQcm94eShzdGF0ZS5zY29wZV8sIHZhbHVlLCBzdGF0ZSwgY2hpbGRLZXkpOwogICAgICByZXR1cm4gc3RhdGUuY29weV9bY2hpbGRLZXldID0gY2hpbGREcmFmdDsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKICB9LAogIGhhcyhzdGF0ZSwgcHJvcCkgewogICAgcmV0dXJuIHByb3AgaW4gbGF0ZXN0KHN0YXRlKTsKICB9LAogIG93bktleXMoc3RhdGUpIHsKICAgIHJldHVybiBSZWZsZWN0Lm93bktleXMobGF0ZXN0KHN0YXRlKSk7CiAgfSwKICBzZXQoc3RhdGUsIHByb3AsIHZhbHVlKSB7CiAgICBjb25zdCBkZXNjID0gZ2V0RGVzY3JpcHRvckZyb21Qcm90byhsYXRlc3Qoc3RhdGUpLCBwcm9wKTsKICAgIGlmIChkZXNjPy5zZXQpIHsKICAgICAgZGVzYy5zZXQuY2FsbChzdGF0ZS5kcmFmdF8sIHZhbHVlKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgICBjb25zdCBjdXJyZW50MjIgPSBwZWVrKGxhdGVzdChzdGF0ZSksIHByb3ApOwogICAgICBjb25zdCBjdXJyZW50U3RhdGUgPSBjdXJyZW50MjI/LltEUkFGVF9TVEFURV07CiAgICAgIGlmIChjdXJyZW50U3RhdGUgJiYgY3VycmVudFN0YXRlLmJhc2VfID09PSB2YWx1ZSkgewogICAgICAgIHN0YXRlLmNvcHlfW3Byb3BdID0gdmFsdWU7CiAgICAgICAgc3RhdGUuYXNzaWduZWRfLnNldChwcm9wLCBmYWxzZSk7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgaWYgKGlzKHZhbHVlLCBjdXJyZW50MjIpICYmICh2YWx1ZSAhPT0gdm9pZCAwIHx8IGhhcyhzdGF0ZS5iYXNlXywgcHJvcCwgc3RhdGUudHlwZV8pKSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgcHJlcGFyZUNvcHkoc3RhdGUpOwogICAgICBtYXJrQ2hhbmdlZChzdGF0ZSk7CiAgICB9CiAgICBpZiAoc3RhdGUuY29weV9bcHJvcF0gPT09IHZhbHVlICYmIC8vIHNwZWNpYWwgY2FzZTogaGFuZGxlIG5ldyBwcm9wcyB3aXRoIHZhbHVlICd1bmRlZmluZWQnCiAgICAodmFsdWUgIT09IHZvaWQgMCB8fCBwcm9wIGluIHN0YXRlLmNvcHlfKSB8fCAvLyBzcGVjaWFsIGNhc2U6IE5hTgogICAgTnVtYmVyLmlzTmFOKHZhbHVlKSAmJiBOdW1iZXIuaXNOYU4oc3RhdGUuY29weV9bcHJvcF0pKQogICAgICByZXR1cm4gdHJ1ZTsKICAgIHN0YXRlLmNvcHlfW3Byb3BdID0gdmFsdWU7CiAgICBzdGF0ZS5hc3NpZ25lZF8uc2V0KHByb3AsIHRydWUpOwogICAgaGFuZGxlQ3Jvc3NSZWZlcmVuY2Uoc3RhdGUsIHByb3AsIHZhbHVlKTsKICAgIHJldHVybiB0cnVlOwogIH0sCiAgZGVsZXRlUHJvcGVydHkoc3RhdGUsIHByb3ApIHsKICAgIHByZXBhcmVDb3B5KHN0YXRlKTsKICAgIGlmIChwZWVrKHN0YXRlLmJhc2VfLCBwcm9wKSAhPT0gdm9pZCAwIHx8IHByb3AgaW4gc3RhdGUuYmFzZV8pIHsKICAgICAgc3RhdGUuYXNzaWduZWRfLnNldChwcm9wLCBmYWxzZSk7CiAgICAgIG1hcmtDaGFuZ2VkKHN0YXRlKTsKICAgIH0gZWxzZSB7CiAgICAgIHN0YXRlLmFzc2lnbmVkXy5kZWxldGUocHJvcCk7CiAgICB9CiAgICBpZiAoc3RhdGUuY29weV8pIHsKICAgICAgZGVsZXRlIHN0YXRlLmNvcHlfW3Byb3BdOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfSwKICAvLyBOb3RlOiBXZSBuZXZlciBjb2VyY2UgYGRlc2MudmFsdWVgIGludG8gYW4gSW1tZXIgZHJhZnQsIGJlY2F1c2Ugd2UgY2FuJ3QgbWFrZQogIC8vIHRoZSBzYW1lIGd1YXJhbnRlZSBpbiBFUzUgbW9kZS4KICBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Ioc3RhdGUsIHByb3ApIHsKICAgIGNvbnN0IG93bmVyID0gbGF0ZXN0KHN0YXRlKTsKICAgIGNvbnN0IGRlc2MgPSBSZWZsZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvd25lciwgcHJvcCk7CiAgICBpZiAoIWRlc2MpCiAgICAgIHJldHVybiBkZXNjOwogICAgcmV0dXJuIHsKICAgICAgW1dSSVRBQkxFXTogdHJ1ZSwKICAgICAgW0NPTkZJR1VSQUJMRV06IHN0YXRlLnR5cGVfICE9PSAxIHx8IHByb3AgIT09ICJsZW5ndGgiLAogICAgICBbRU5VTUVSQUJMRV06IGRlc2NbRU5VTUVSQUJMRV0sCiAgICAgIFtWQUxVRV06IG93bmVyW3Byb3BdCiAgICB9OwogIH0sCiAgZGVmaW5lUHJvcGVydHkoKSB7CiAgICBkaWUoMTEpOwogIH0sCiAgZ2V0UHJvdG90eXBlT2Yoc3RhdGUpIHsKICAgIHJldHVybiBnZXRQcm90b3R5cGVPZihzdGF0ZS5iYXNlXyk7CiAgfSwKICBzZXRQcm90b3R5cGVPZigpIHsKICAgIGRpZSgxMik7CiAgfQp9Owp2YXIgYXJyYXlUcmFwcyA9IHt9OwplYWNoKG9iamVjdFRyYXBzLCAoa2V5LCBmbikgPT4gewogIGFycmF5VHJhcHNba2V5XSA9IGZ1bmN0aW9uKCkgewogICAgY29uc3QgYXJncyA9IGFyZ3VtZW50czsKICAgIGFyZ3NbMF0gPSBhcmdzWzBdWzBdOwogICAgcmV0dXJuIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwogIH07Cn0pOwphcnJheVRyYXBzLmRlbGV0ZVByb3BlcnR5ID0gZnVuY3Rpb24oc3RhdGUsIHByb3ApIHsKICBpZiAoaXNOYU4ocGFyc2VJbnQocHJvcCkpKQogICAgZGllKDEzKTsKICByZXR1cm4gYXJyYXlUcmFwcy5zZXQuY2FsbCh0aGlzLCBzdGF0ZSwgcHJvcCwgdm9pZCAwKTsKfTsKYXJyYXlUcmFwcy5zZXQgPSBmdW5jdGlvbihzdGF0ZSwgcHJvcCwgdmFsdWUpIHsKICBpZiAocHJvcCAhPT0gImxlbmd0aCIgJiYgaXNOYU4ocGFyc2VJbnQocHJvcCkpKQogICAgZGllKDE0KTsKICByZXR1cm4gb2JqZWN0VHJhcHMuc2V0LmNhbGwodGhpcywgc3RhdGVbMF0sIHByb3AsIHZhbHVlLCBzdGF0ZVswXSk7Cn07CmZ1bmN0aW9uIHBlZWsoZHJhZnQsIHByb3ApIHsKICBjb25zdCBzdGF0ZSA9IGRyYWZ0W0RSQUZUX1NUQVRFXTsKICBjb25zdCBzb3VyY2UgPSBzdGF0ZSA/IGxhdGVzdChzdGF0ZSkgOiBkcmFmdDsKICByZXR1cm4gc291cmNlW3Byb3BdOwp9CmZ1bmN0aW9uIHJlYWRQcm9wRnJvbVByb3RvKHN0YXRlLCBzb3VyY2UsIHByb3ApIHsKICBjb25zdCBkZXNjID0gZ2V0RGVzY3JpcHRvckZyb21Qcm90byhzb3VyY2UsIHByb3ApOwogIHJldHVybiBkZXNjID8gVkFMVUUgaW4gZGVzYyA/IGRlc2NbVkFMVUVdIDogKAogICAgLy8gVGhpcyBpcyBhIHZlcnkgc3BlY2lhbCBjYXNlLCBpZiB0aGUgcHJvcCBpcyBhIGdldHRlciBkZWZpbmVkIGJ5IHRoZQogICAgLy8gcHJvdG90eXBlLCB3ZSBzaG91bGQgaW52b2tlIGl0IHdpdGggdGhlIGRyYWZ0IGFzIGNvbnRleHQhCiAgICBkZXNjLmdldD8uY2FsbChzdGF0ZS5kcmFmdF8pCiAgKSA6IHZvaWQgMDsKfQpmdW5jdGlvbiBnZXREZXNjcmlwdG9yRnJvbVByb3RvKHNvdXJjZSwgcHJvcCkgewogIGlmICghKHByb3AgaW4gc291cmNlKSkKICAgIHJldHVybiB2b2lkIDA7CiAgbGV0IHByb3RvMiA9IGdldFByb3RvdHlwZU9mKHNvdXJjZSk7CiAgd2hpbGUgKHByb3RvMikgewogICAgY29uc3QgZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocHJvdG8yLCBwcm9wKTsKICAgIGlmIChkZXNjKQogICAgICByZXR1cm4gZGVzYzsKICAgIHByb3RvMiA9IGdldFByb3RvdHlwZU9mKHByb3RvMik7CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KZnVuY3Rpb24gbWFya0NoYW5nZWQoc3RhdGUpIHsKICBpZiAoIXN0YXRlLm1vZGlmaWVkXykgewogICAgc3RhdGUubW9kaWZpZWRfID0gdHJ1ZTsKICAgIGlmIChzdGF0ZS5wYXJlbnRfKSB7CiAgICAgIG1hcmtDaGFuZ2VkKHN0YXRlLnBhcmVudF8pOwogICAgfQogIH0KfQpmdW5jdGlvbiBwcmVwYXJlQ29weShzdGF0ZSkgewogIGlmICghc3RhdGUuY29weV8pIHsKICAgIHN0YXRlLmFzc2lnbmVkXyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBzdGF0ZS5jb3B5XyA9IHNoYWxsb3dDb3B5KAogICAgICBzdGF0ZS5iYXNlXywKICAgICAgc3RhdGUuc2NvcGVfLmltbWVyXy51c2VTdHJpY3RTaGFsbG93Q29weV8KICAgICk7CiAgfQp9CnZhciBJbW1lcjIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY29uZmlnKSB7CiAgICB0aGlzLmF1dG9GcmVlemVfID0gdHJ1ZTsKICAgIHRoaXMudXNlU3RyaWN0U2hhbGxvd0NvcHlfID0gZmFsc2U7CiAgICB0aGlzLnVzZVN0cmljdEl0ZXJhdGlvbl8gPSBmYWxzZTsKICAgIHRoaXMucHJvZHVjZSA9IChiYXNlLCByZWNpcGUsIHBhdGNoTGlzdGVuZXIpID0+IHsKICAgICAgaWYgKGlzRnVuY3Rpb24oYmFzZSkgJiYgIWlzRnVuY3Rpb24ocmVjaXBlKSkgewogICAgICAgIGNvbnN0IGRlZmF1bHRCYXNlID0gcmVjaXBlOwogICAgICAgIHJlY2lwZSA9IGJhc2U7CiAgICAgICAgY29uc3Qgc2VsZjIgPSB0aGlzOwogICAgICAgIHJldHVybiBmdW5jdGlvbiBjdXJyaWVkUHJvZHVjZShiYXNlMiA9IGRlZmF1bHRCYXNlLCAuLi5hcmdzKSB7CiAgICAgICAgICByZXR1cm4gc2VsZjIucHJvZHVjZShiYXNlMiwgKGRyYWZ0KSA9PiByZWNpcGUuY2FsbCh0aGlzLCBkcmFmdCwgLi4uYXJncykpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgaWYgKCFpc0Z1bmN0aW9uKHJlY2lwZSkpCiAgICAgICAgZGllKDYpOwogICAgICBpZiAocGF0Y2hMaXN0ZW5lciAhPT0gdm9pZCAwICYmICFpc0Z1bmN0aW9uKHBhdGNoTGlzdGVuZXIpKQogICAgICAgIGRpZSg3KTsKICAgICAgbGV0IHJlc3VsdDsKICAgICAgaWYgKGlzRHJhZnRhYmxlKGJhc2UpKSB7CiAgICAgICAgY29uc3Qgc2NvcGUgPSBlbnRlclNjb3BlKHRoaXMpOwogICAgICAgIGNvbnN0IHByb3h5ID0gY3JlYXRlUHJveHkoc2NvcGUsIGJhc2UsIHZvaWQgMCk7CiAgICAgICAgbGV0IGhhc0Vycm9yID0gdHJ1ZTsKICAgICAgICB0cnkgewogICAgICAgICAgcmVzdWx0ID0gcmVjaXBlKHByb3h5KTsKICAgICAgICAgIGhhc0Vycm9yID0gZmFsc2U7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmIChoYXNFcnJvcikKICAgICAgICAgICAgcmV2b2tlU2NvcGUoc2NvcGUpOwogICAgICAgICAgZWxzZQogICAgICAgICAgICBsZWF2ZVNjb3BlKHNjb3BlKTsKICAgICAgICB9CiAgICAgICAgdXNlUGF0Y2hlc0luU2NvcGUoc2NvcGUsIHBhdGNoTGlzdGVuZXIpOwogICAgICAgIHJldHVybiBwcm9jZXNzUmVzdWx0KHJlc3VsdCwgc2NvcGUpOwogICAgICB9IGVsc2UgaWYgKCFiYXNlIHx8ICFpc09iamVjdGlzaChiYXNlKSkgewogICAgICAgIHJlc3VsdCA9IHJlY2lwZShiYXNlKTsKICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApCiAgICAgICAgICByZXN1bHQgPSBiYXNlOwogICAgICAgIGlmIChyZXN1bHQgPT09IE5PVEhJTkcpCiAgICAgICAgICByZXN1bHQgPSB2b2lkIDA7CiAgICAgICAgaWYgKHRoaXMuYXV0b0ZyZWV6ZV8pCiAgICAgICAgICBmcmVlemUocmVzdWx0LCB0cnVlKTsKICAgICAgICBpZiAocGF0Y2hMaXN0ZW5lcikgewogICAgICAgICAgY29uc3QgcCA9IFtdOwogICAgICAgICAgY29uc3QgaXAgPSBbXTsKICAgICAgICAgIGdldFBsdWdpbihQbHVnaW5QYXRjaGVzKS5nZW5lcmF0ZVJlcGxhY2VtZW50UGF0Y2hlc18oYmFzZSwgcmVzdWx0LCB7CiAgICAgICAgICAgIHBhdGNoZXNfOiBwLAogICAgICAgICAgICBpbnZlcnNlUGF0Y2hlc186IGlwCiAgICAgICAgICB9KTsKICAgICAgICAgIHBhdGNoTGlzdGVuZXIocCwgaXApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9IGVsc2UKICAgICAgICBkaWUoMSwgYmFzZSk7CiAgICB9OwogICAgdGhpcy5wcm9kdWNlV2l0aFBhdGNoZXMgPSAoYmFzZSwgcmVjaXBlKSA9PiB7CiAgICAgIGlmIChpc0Z1bmN0aW9uKGJhc2UpKSB7CiAgICAgICAgcmV0dXJuIChzdGF0ZSwgLi4uYXJncykgPT4gdGhpcy5wcm9kdWNlV2l0aFBhdGNoZXMoc3RhdGUsIChkcmFmdCkgPT4gYmFzZShkcmFmdCwgLi4uYXJncykpOwogICAgICB9CiAgICAgIGxldCBwYXRjaGVzLCBpbnZlcnNlUGF0Y2hlczsKICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5wcm9kdWNlKGJhc2UsIHJlY2lwZSwgKHAsIGlwKSA9PiB7CiAgICAgICAgcGF0Y2hlcyA9IHA7CiAgICAgICAgaW52ZXJzZVBhdGNoZXMgPSBpcDsKICAgICAgfSk7CiAgICAgIHJldHVybiBbcmVzdWx0LCBwYXRjaGVzLCBpbnZlcnNlUGF0Y2hlc107CiAgICB9OwogICAgaWYgKGlzQm9vbGVhbihjb25maWc/LmF1dG9GcmVlemUpKQogICAgICB0aGlzLnNldEF1dG9GcmVlemUoY29uZmlnLmF1dG9GcmVlemUpOwogICAgaWYgKGlzQm9vbGVhbihjb25maWc/LnVzZVN0cmljdFNoYWxsb3dDb3B5KSkKICAgICAgdGhpcy5zZXRVc2VTdHJpY3RTaGFsbG93Q29weShjb25maWcudXNlU3RyaWN0U2hhbGxvd0NvcHkpOwogICAgaWYgKGlzQm9vbGVhbihjb25maWc/LnVzZVN0cmljdEl0ZXJhdGlvbikpCiAgICAgIHRoaXMuc2V0VXNlU3RyaWN0SXRlcmF0aW9uKGNvbmZpZy51c2VTdHJpY3RJdGVyYXRpb24pOwogIH0KICBjcmVhdGVEcmFmdChiYXNlKSB7CiAgICBpZiAoIWlzRHJhZnRhYmxlKGJhc2UpKQogICAgICBkaWUoOCk7CiAgICBpZiAoaXNEcmFmdChiYXNlKSkKICAgICAgYmFzZSA9IGN1cnJlbnQoYmFzZSk7CiAgICBjb25zdCBzY29wZSA9IGVudGVyU2NvcGUodGhpcyk7CiAgICBjb25zdCBwcm94eSA9IGNyZWF0ZVByb3h5KHNjb3BlLCBiYXNlLCB2b2lkIDApOwogICAgcHJveHlbRFJBRlRfU1RBVEVdLmlzTWFudWFsXyA9IHRydWU7CiAgICBsZWF2ZVNjb3BlKHNjb3BlKTsKICAgIHJldHVybiBwcm94eTsKICB9CiAgZmluaXNoRHJhZnQoZHJhZnQsIHBhdGNoTGlzdGVuZXIpIHsKICAgIGNvbnN0IHN0YXRlID0gZHJhZnQgJiYgZHJhZnRbRFJBRlRfU1RBVEVdOwogICAgaWYgKCFzdGF0ZSB8fCAhc3RhdGUuaXNNYW51YWxfKQogICAgICBkaWUoOSk7CiAgICBjb25zdCB7IHNjb3BlXzogc2NvcGUgfSA9IHN0YXRlOwogICAgdXNlUGF0Y2hlc0luU2NvcGUoc2NvcGUsIHBhdGNoTGlzdGVuZXIpOwogICAgcmV0dXJuIHByb2Nlc3NSZXN1bHQodm9pZCAwLCBzY29wZSk7CiAgfQogIC8qKgogICAqIFBhc3MgdHJ1ZSB0byBhdXRvbWF0aWNhbGx5IGZyZWV6ZSBhbGwgY29waWVzIGNyZWF0ZWQgYnkgSW1tZXIuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBhdXRvLWZyZWV6aW5nIGlzIGVuYWJsZWQuCiAgICovCiAgc2V0QXV0b0ZyZWV6ZSh2YWx1ZSkgewogICAgdGhpcy5hdXRvRnJlZXplXyA9IHZhbHVlOwogIH0KICAvKioKICAgKiBQYXNzIHRydWUgdG8gZW5hYmxlIHN0cmljdCBzaGFsbG93IGNvcHkuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBpbW1lciBkb2VzIG5vdCBjb3B5IHRoZSBvYmplY3QgZGVzY3JpcHRvcnMgc3VjaCBhcyBnZXR0ZXIsIHNldHRlciBhbmQgbm9uLWVudW1yYWJsZSBwcm9wZXJ0aWVzLgogICAqLwogIHNldFVzZVN0cmljdFNoYWxsb3dDb3B5KHZhbHVlKSB7CiAgICB0aGlzLnVzZVN0cmljdFNoYWxsb3dDb3B5XyA9IHZhbHVlOwogIH0KICAvKioKICAgKiBQYXNzIGZhbHNlIHRvIHVzZSBmYXN0ZXIgaXRlcmF0aW9uIHRoYXQgc2tpcHMgbm9uLWVudW1lcmFibGUgcHJvcGVydGllcwogICAqIGJ1dCBzdGlsbCBoYW5kbGVzIHN5bWJvbHMgZm9yIGNvbXBhdGliaWxpdHkuCiAgICoKICAgKiBCeSBkZWZhdWx0LCBzdHJpY3QgaXRlcmF0aW9uIGlzIGVuYWJsZWQgKGluY2x1ZGVzIGFsbCBvd24gcHJvcGVydGllcykuCiAgICovCiAgc2V0VXNlU3RyaWN0SXRlcmF0aW9uKHZhbHVlKSB7CiAgICB0aGlzLnVzZVN0cmljdEl0ZXJhdGlvbl8gPSB2YWx1ZTsKICB9CiAgc2hvdWxkVXNlU3RyaWN0SXRlcmF0aW9uKCkgewogICAgcmV0dXJuIHRoaXMudXNlU3RyaWN0SXRlcmF0aW9uXzsKICB9CiAgYXBwbHlQYXRjaGVzKGJhc2UsIHBhdGNoZXMpIHsKICAgIGxldCBpOwogICAgZm9yIChpID0gcGF0Y2hlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICBjb25zdCBwYXRjaCA9IHBhdGNoZXNbaV07CiAgICAgIGlmIChwYXRjaC5wYXRoLmxlbmd0aCA9PT0gMCAmJiBwYXRjaC5vcCA9PT0gInJlcGxhY2UiKSB7CiAgICAgICAgYmFzZSA9IHBhdGNoLnZhbHVlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgICBpZiAoaSA+IC0xKSB7CiAgICAgIHBhdGNoZXMgPSBwYXRjaGVzLnNsaWNlKGkgKyAxKTsKICAgIH0KICAgIGNvbnN0IGFwcGx5UGF0Y2hlc0ltcGwgPSBnZXRQbHVnaW4oUGx1Z2luUGF0Y2hlcykuYXBwbHlQYXRjaGVzXzsKICAgIGlmIChpc0RyYWZ0KGJhc2UpKSB7CiAgICAgIHJldHVybiBhcHBseVBhdGNoZXNJbXBsKGJhc2UsIHBhdGNoZXMpOwogICAgfQogICAgcmV0dXJuIHRoaXMucHJvZHVjZSgKICAgICAgYmFzZSwKICAgICAgKGRyYWZ0KSA9PiBhcHBseVBhdGNoZXNJbXBsKGRyYWZ0LCBwYXRjaGVzKQogICAgKTsKICB9Cn07CmZ1bmN0aW9uIGNyZWF0ZVByb3h5KHJvb3RTY29wZSwgdmFsdWUsIHBhcmVudCwga2V5KSB7CiAgY29uc3QgW2RyYWZ0LCBzdGF0ZV0gPSBpc01hcCh2YWx1ZSkgPyBnZXRQbHVnaW4oUGx1Z2luTWFwU2V0KS5wcm94eU1hcF8odmFsdWUsIHBhcmVudCkgOiBpc1NldCh2YWx1ZSkgPyBnZXRQbHVnaW4oUGx1Z2luTWFwU2V0KS5wcm94eVNldF8odmFsdWUsIHBhcmVudCkgOiBjcmVhdGVQcm94eVByb3h5KHZhbHVlLCBwYXJlbnQpOwogIGNvbnN0IHNjb3BlID0gcGFyZW50Py5zY29wZV8gPz8gZ2V0Q3VycmVudFNjb3BlKCk7CiAgc2NvcGUuZHJhZnRzXy5wdXNoKGRyYWZ0KTsKICBzdGF0ZS5jYWxsYmFja3NfID0gcGFyZW50Py5jYWxsYmFja3NfID8/IFtdOwogIHN0YXRlLmtleV8gPSBrZXk7CiAgaWYgKHBhcmVudCAmJiBrZXkgIT09IHZvaWQgMCkgewogICAgcmVnaXN0ZXJDaGlsZEZpbmFsaXphdGlvbkNhbGxiYWNrKHBhcmVudCwgc3RhdGUsIGtleSk7CiAgfSBlbHNlIHsKICAgIHN0YXRlLmNhbGxiYWNrc18ucHVzaChmdW5jdGlvbiByb290RHJhZnRDbGVhbnVwKHJvb3RTY29wZTIpIHsKICAgICAgcm9vdFNjb3BlMi5tYXBTZXRQbHVnaW5fPy5maXhTZXRDb250ZW50cyhzdGF0ZSk7CiAgICAgIGNvbnN0IHsgcGF0Y2hQbHVnaW5fIH0gPSByb290U2NvcGUyOwogICAgICBpZiAoc3RhdGUubW9kaWZpZWRfICYmIHBhdGNoUGx1Z2luXykgewogICAgICAgIHBhdGNoUGx1Z2luXy5nZW5lcmF0ZVBhdGNoZXNfKHN0YXRlLCBbXSwgcm9vdFNjb3BlMik7CiAgICAgIH0KICAgIH0pOwogIH0KICByZXR1cm4gZHJhZnQ7Cn0KZnVuY3Rpb24gY3VycmVudCh2YWx1ZSkgewogIGlmICghaXNEcmFmdCh2YWx1ZSkpCiAgICBkaWUoMTAsIHZhbHVlKTsKICByZXR1cm4gY3VycmVudEltcGwodmFsdWUpOwp9CmZ1bmN0aW9uIGN1cnJlbnRJbXBsKHZhbHVlKSB7CiAgaWYgKCFpc0RyYWZ0YWJsZSh2YWx1ZSkgfHwgaXNGcm96ZW4odmFsdWUpKQogICAgcmV0dXJuIHZhbHVlOwogIGNvbnN0IHN0YXRlID0gdmFsdWVbRFJBRlRfU1RBVEVdOwogIGxldCBjb3B5MzsKICBsZXQgc3RyaWN0ID0gdHJ1ZTsKICBpZiAoc3RhdGUpIHsKICAgIGlmICghc3RhdGUubW9kaWZpZWRfKQogICAgICByZXR1cm4gc3RhdGUuYmFzZV87CiAgICBzdGF0ZS5maW5hbGl6ZWRfID0gdHJ1ZTsKICAgIGNvcHkzID0gc2hhbGxvd0NvcHkodmFsdWUsIHN0YXRlLnNjb3BlXy5pbW1lcl8udXNlU3RyaWN0U2hhbGxvd0NvcHlfKTsKICAgIHN0cmljdCA9IHN0YXRlLnNjb3BlXy5pbW1lcl8uc2hvdWxkVXNlU3RyaWN0SXRlcmF0aW9uKCk7CiAgfSBlbHNlIHsKICAgIGNvcHkzID0gc2hhbGxvd0NvcHkodmFsdWUsIHRydWUpOwogIH0KICBlYWNoKAogICAgY29weTMsCiAgICAoa2V5LCBjaGlsZFZhbHVlKSA9PiB7CiAgICAgIHNldChjb3B5Mywga2V5LCBjdXJyZW50SW1wbChjaGlsZFZhbHVlKSk7CiAgICB9LAogICAgc3RyaWN0CiAgKTsKICBpZiAoc3RhdGUpIHsKICAgIHN0YXRlLmZpbmFsaXplZF8gPSBmYWxzZTsKICB9CiAgcmV0dXJuIGNvcHkzOwp9CnZhciBpbW1lciA9IG5ldyBJbW1lcjIoKTsKdmFyIHByb2R1Y2UgPSBpbW1lci5wcm9kdWNlOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlZHV4LXRodW5rQDMuMS4wX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWR1eC10aHVuay9kaXN0L3JlZHV4LXRodW5rLm1qcwpmdW5jdGlvbiBjcmVhdGVUaHVua01pZGRsZXdhcmUoZXh0cmFBcmd1bWVudCkgewogIGNvbnN0IG1pZGRsZXdhcmUgPSAoeyBkaXNwYXRjaCwgZ2V0U3RhdGUgfSkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IHsKICAgIGlmICh0eXBlb2YgYWN0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJldHVybiBhY3Rpb24oZGlzcGF0Y2gsIGdldFN0YXRlLCBleHRyYUFyZ3VtZW50KTsKICAgIH0KICAgIHJldHVybiBuZXh0KGFjdGlvbik7CiAgfTsKICByZXR1cm4gbWlkZGxld2FyZTsKfQp2YXIgdGh1bmsgPSBjcmVhdGVUaHVua01pZGRsZXdhcmUoKTsKdmFyIHdpdGhFeHRyYUFyZ3VtZW50ID0gY3JlYXRlVGh1bmtNaWRkbGV3YXJlOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0ByZWR1eGpzK3Rvb2xraXRAMi4xMS4wX3JlYWN0LXJlZHV4QDkuMi4wX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMV9fcmVhY3RAMTguMy4xL25vZGVfbW9kdWxlcy9AcmVkdXhqcy90b29sa2l0L2Rpc3QvcmVkdXgtdG9vbGtpdC5tb2Rlcm4ubWpzCnZhciBjb21wb3NlV2l0aERldlRvb2xzID0gdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93Ll9fUkVEVVhfREVWVE9PTFNfRVhURU5TSU9OX0NPTVBPU0VfXyA/IHdpbmRvdy5fX1JFRFVYX0RFVlRPT0xTX0VYVEVOU0lPTl9DT01QT1NFX18gOiBmdW5jdGlvbigpIHsKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHZvaWQgMDsKICBpZiAodHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gIm9iamVjdCIpIHJldHVybiBjb21wb3NlOwogIHJldHVybiBjb21wb3NlLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn07CnZhciBkZXZUb29sc0VuaGFuY2VyID0gdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93Ll9fUkVEVVhfREVWVE9PTFNfRVhURU5TSU9OX18gPyB3aW5kb3cuX19SRURVWF9ERVZUT09MU19FWFRFTlNJT05fXyA6IGZ1bmN0aW9uKCkgewogIHJldHVybiBmdW5jdGlvbihub29wMzIpIHsKICAgIHJldHVybiBub29wMzI7CiAgfTsKfTsKdmFyIGhhc01hdGNoRnVuY3Rpb24gPSAodikgPT4gewogIHJldHVybiB2ICYmIHR5cGVvZiB2Lm1hdGNoID09PSAiZnVuY3Rpb24iOwp9OwpmdW5jdGlvbiBjcmVhdGVBY3Rpb24odHlwZSwgcHJlcGFyZUFjdGlvbikgewogIGZ1bmN0aW9uIGFjdGlvbkNyZWF0b3IoLi4uYXJncykgewogICAgaWYgKHByZXBhcmVBY3Rpb24pIHsKICAgICAgbGV0IHByZXBhcmVkID0gcHJlcGFyZUFjdGlvbiguLi5hcmdzKTsKICAgICAgaWYgKCFwcmVwYXJlZCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMCkgOiAicHJlcGFyZUFjdGlvbiBkaWQgbm90IHJldHVybiBhbiBvYmplY3QiKTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHR5cGUsCiAgICAgICAgcGF5bG9hZDogcHJlcGFyZWQucGF5bG9hZCwKICAgICAgICAuLi4ibWV0YSIgaW4gcHJlcGFyZWQgJiYgewogICAgICAgICAgbWV0YTogcHJlcGFyZWQubWV0YQogICAgICAgIH0sCiAgICAgICAgLi4uImVycm9yIiBpbiBwcmVwYXJlZCAmJiB7CiAgICAgICAgICBlcnJvcjogcHJlcGFyZWQuZXJyb3IKICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgICByZXR1cm4gewogICAgICB0eXBlLAogICAgICBwYXlsb2FkOiBhcmdzWzBdCiAgICB9OwogIH0KICBhY3Rpb25DcmVhdG9yLnRvU3RyaW5nID0gKCkgPT4gYCR7dHlwZX1gOwogIGFjdGlvbkNyZWF0b3IudHlwZSA9IHR5cGU7CiAgYWN0aW9uQ3JlYXRvci5tYXRjaCA9IChhY3Rpb24pID0+IGlzQWN0aW9uKGFjdGlvbikgJiYgYWN0aW9uLnR5cGUgPT09IHR5cGU7CiAgcmV0dXJuIGFjdGlvbkNyZWF0b3I7Cn0KZnVuY3Rpb24gaXNBY3Rpb25DcmVhdG9yKGFjdGlvbikgewogIHJldHVybiB0eXBlb2YgYWN0aW9uID09PSAiZnVuY3Rpb24iICYmICJ0eXBlIiBpbiBhY3Rpb24gJiYgLy8gaGFzTWF0Y2hGdW5jdGlvbiBvbmx5IHdhbnRzIE1hdGNoZXJzIGJ1dCBJIGRvbid0IHNlZSB0aGUgcG9pbnQgaW4gcmV3cml0aW5nIGl0CiAgaGFzTWF0Y2hGdW5jdGlvbihhY3Rpb24pOwp9CmZ1bmN0aW9uIGdldE1lc3NhZ2UodHlwZSkgewogIGNvbnN0IHNwbGl0VHlwZSA9IHR5cGUgPyBgJHt0eXBlfWAuc3BsaXQoIi8iKSA6IFtdOwogIGNvbnN0IGFjdGlvbk5hbWUgPSBzcGxpdFR5cGVbc3BsaXRUeXBlLmxlbmd0aCAtIDFdIHx8ICJhY3Rpb25DcmVhdG9yIjsKICByZXR1cm4gYERldGVjdGVkIGFuIGFjdGlvbiBjcmVhdG9yIHdpdGggdHlwZSAiJHt0eXBlIHx8ICJ1bmtub3duIn0iIGJlaW5nIGRpc3BhdGNoZWQuIApNYWtlIHN1cmUgeW91J3JlIGNhbGxpbmcgdGhlIGFjdGlvbiBjcmVhdG9yIGJlZm9yZSBkaXNwYXRjaGluZywgaS5lLiBcYGRpc3BhdGNoKCR7YWN0aW9uTmFtZX0oKSlcYCBpbnN0ZWFkIG9mIFxgZGlzcGF0Y2goJHthY3Rpb25OYW1lfSlcYC4gVGhpcyBpcyBuZWNlc3NhcnkgZXZlbiBpZiB0aGUgYWN0aW9uIGhhcyBubyBwYXlsb2FkLmA7Cn0KZnVuY3Rpb24gY3JlYXRlQWN0aW9uQ3JlYXRvckludmFyaWFudE1pZGRsZXdhcmUob3B0aW9ucyA9IHt9KSB7CiAgaWYgKGZhbHNlKSB7CiAgICByZXR1cm4gKCkgPT4gKG5leHQpID0+IChhY3Rpb24pID0+IG5leHQoYWN0aW9uKTsKICB9CiAgY29uc3QgewogICAgaXNBY3Rpb25DcmVhdG9yOiBpc0FjdGlvbkNyZWF0b3IyID0gaXNBY3Rpb25DcmVhdG9yCiAgfSA9IG9wdGlvbnM7CiAgcmV0dXJuICgpID0+IChuZXh0KSA9PiAoYWN0aW9uKSA9PiB7CiAgICBpZiAoaXNBY3Rpb25DcmVhdG9yMihhY3Rpb24pKSB7CiAgICAgIGNvbnNvbGUud2FybihnZXRNZXNzYWdlKGFjdGlvbi50eXBlKSk7CiAgICB9CiAgICByZXR1cm4gbmV4dChhY3Rpb24pOwogIH07Cn0KZnVuY3Rpb24gZ2V0VGltZU1lYXN1cmVVdGlscyhtYXhEZWxheSwgZm5OYW1lKSB7CiAgbGV0IGVsYXBzZWQgPSAwOwogIHJldHVybiB7CiAgICBtZWFzdXJlVGltZShmbikgewogICAgICBjb25zdCBzdGFydGVkID0gRGF0ZS5ub3coKTsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gZm4oKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBjb25zdCBmaW5pc2hlZCA9IERhdGUubm93KCk7CiAgICAgICAgZWxhcHNlZCArPSBmaW5pc2hlZCAtIHN0YXJ0ZWQ7CiAgICAgIH0KICAgIH0sCiAgICB3YXJuSWZFeGNlZWRlZCgpIHsKICAgICAgaWYgKGVsYXBzZWQgPiBtYXhEZWxheSkgewogICAgICAgIGNvbnNvbGUud2FybihgJHtmbk5hbWV9IHRvb2sgJHtlbGFwc2VkfW1zLCB3aGljaCBpcyBtb3JlIHRoYW4gdGhlIHdhcm5pbmcgdGhyZXNob2xkIG9mICR7bWF4RGVsYXl9bXMuIApJZiB5b3VyIHN0YXRlIG9yIGFjdGlvbnMgYXJlIHZlcnkgbGFyZ2UsIHlvdSBtYXkgd2FudCB0byBkaXNhYmxlIHRoZSBtaWRkbGV3YXJlIGFzIGl0IG1pZ2h0IGNhdXNlIHRvbyBtdWNoIG9mIGEgc2xvd2Rvd24gaW4gZGV2ZWxvcG1lbnQgbW9kZS4gU2VlIGh0dHBzOi8vcmVkdXgtdG9vbGtpdC5qcy5vcmcvYXBpL2dldERlZmF1bHRNaWRkbGV3YXJlIGZvciBpbnN0cnVjdGlvbnMuCkl0IGlzIGRpc2FibGVkIGluIHByb2R1Y3Rpb24gYnVpbGRzLCBzbyB5b3UgZG9uJ3QgbmVlZCB0byB3b3JyeSBhYm91dCB0aGF0LmApOwogICAgICB9CiAgICB9CiAgfTsKfQp2YXIgVHVwbGUgPSBjbGFzcyBfVHVwbGUgZXh0ZW5kcyBBcnJheSB7CiAgY29uc3RydWN0b3IoLi4uaXRlbXMpIHsKICAgIHN1cGVyKC4uLml0ZW1zKTsKICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZih0aGlzLCBfVHVwbGUucHJvdG90eXBlKTsKICB9CiAgc3RhdGljIGdldCBbU3ltYm9sLnNwZWNpZXNdKCkgewogICAgcmV0dXJuIF9UdXBsZTsKICB9CiAgY29uY2F0KC4uLmFycikgewogICAgcmV0dXJuIHN1cGVyLmNvbmNhdC5hcHBseSh0aGlzLCBhcnIpOwogIH0KICBwcmVwZW5kKC4uLmFycikgewogICAgaWYgKGFyci5sZW5ndGggPT09IDEgJiYgQXJyYXkuaXNBcnJheShhcnJbMF0pKSB7CiAgICAgIHJldHVybiBuZXcgX1R1cGxlKC4uLmFyclswXS5jb25jYXQodGhpcykpOwogICAgfQogICAgcmV0dXJuIG5ldyBfVHVwbGUoLi4uYXJyLmNvbmNhdCh0aGlzKSk7CiAgfQp9OwpmdW5jdGlvbiBmcmVlemVEcmFmdGFibGUodmFsKSB7CiAgcmV0dXJuIGlzRHJhZnRhYmxlKHZhbCkgPyBwcm9kdWNlKHZhbCwgKCkgPT4gewogIH0pIDogdmFsOwp9CmZ1bmN0aW9uIGdldE9ySW5zZXJ0Q29tcHV0ZWQobWFwMywga2V5LCBjb21wdXRlKSB7CiAgaWYgKG1hcDMuaGFzKGtleSkpIHJldHVybiBtYXAzLmdldChrZXkpOwogIHJldHVybiBtYXAzLnNldChrZXksIGNvbXB1dGUoa2V5KSkuZ2V0KGtleSk7Cn0KZnVuY3Rpb24gaXNJbW11dGFibGVEZWZhdWx0KHZhbHVlKSB7CiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSAhPT0gIm9iamVjdCIgfHwgdmFsdWUgPT0gbnVsbCB8fCBPYmplY3QuaXNGcm96ZW4odmFsdWUpOwp9CmZ1bmN0aW9uIHRyYWNrRm9yTXV0YXRpb25zKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMsIG9iaikgewogIGNvbnN0IHRyYWNrZWRQcm9wZXJ0aWVzID0gdHJhY2tQcm9wZXJ0aWVzKGlzSW1tdXRhYmxlLCBpZ25vcmVkUGF0aHMsIG9iaik7CiAgcmV0dXJuIHsKICAgIGRldGVjdE11dGF0aW9ucygpIHsKICAgICAgcmV0dXJuIGRldGVjdE11dGF0aW9ucyhpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzLCB0cmFja2VkUHJvcGVydGllcywgb2JqKTsKICAgIH0KICB9Owp9CmZ1bmN0aW9uIHRyYWNrUHJvcGVydGllcyhpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzID0gW10sIG9iaiwgcGF0aDIgPSAiIiwgY2hlY2tlZE9iamVjdHMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpKSB7CiAgY29uc3QgdHJhY2tlZCA9IHsKICAgIHZhbHVlOiBvYmoKICB9OwogIGlmICghaXNJbW11dGFibGUob2JqKSAmJiAhY2hlY2tlZE9iamVjdHMuaGFzKG9iaikpIHsKICAgIGNoZWNrZWRPYmplY3RzLmFkZChvYmopOwogICAgdHJhY2tlZC5jaGlsZHJlbiA9IHt9OwogICAgY29uc3QgaGFzSWdub3JlZFBhdGhzID0gaWdub3JlZFBhdGhzLmxlbmd0aCA+IDA7CiAgICBmb3IgKGNvbnN0IGtleSBpbiBvYmopIHsKICAgICAgY29uc3QgbmVzdGVkUGF0aCA9IHBhdGgyID8gcGF0aDIgKyAiLiIgKyBrZXkgOiBrZXk7CiAgICAgIGlmIChoYXNJZ25vcmVkUGF0aHMpIHsKICAgICAgICBjb25zdCBoYXNNYXRjaGVzID0gaWdub3JlZFBhdGhzLnNvbWUoKGlnbm9yZWQpID0+IHsKICAgICAgICAgIGlmIChpZ25vcmVkIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgICAgIHJldHVybiBpZ25vcmVkLnRlc3QobmVzdGVkUGF0aCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbmVzdGVkUGF0aCA9PT0gaWdub3JlZDsKICAgICAgICB9KTsKICAgICAgICBpZiAoaGFzTWF0Y2hlcykgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRyYWNrZWQuY2hpbGRyZW5ba2V5XSA9IHRyYWNrUHJvcGVydGllcyhpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzLCBvYmpba2V5XSwgbmVzdGVkUGF0aCk7CiAgICB9CiAgfQogIHJldHVybiB0cmFja2VkOwp9CmZ1bmN0aW9uIGRldGVjdE11dGF0aW9ucyhpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzID0gW10sIHRyYWNrZWRQcm9wZXJ0eSwgb2JqLCBzYW1lUGFyZW50UmVmID0gZmFsc2UsIHBhdGgyID0gIiIpIHsKICBjb25zdCBwcmV2T2JqID0gdHJhY2tlZFByb3BlcnR5ID8gdHJhY2tlZFByb3BlcnR5LnZhbHVlIDogdm9pZCAwOwogIGNvbnN0IHNhbWVSZWYgPSBwcmV2T2JqID09PSBvYmo7CiAgaWYgKHNhbWVQYXJlbnRSZWYgJiYgIXNhbWVSZWYgJiYgIU51bWJlci5pc05hTihvYmopKSB7CiAgICByZXR1cm4gewogICAgICB3YXNNdXRhdGVkOiB0cnVlLAogICAgICBwYXRoOiBwYXRoMgogICAgfTsKICB9CiAgaWYgKGlzSW1tdXRhYmxlKHByZXZPYmopIHx8IGlzSW1tdXRhYmxlKG9iaikpIHsKICAgIHJldHVybiB7CiAgICAgIHdhc011dGF0ZWQ6IGZhbHNlCiAgICB9OwogIH0KICBjb25zdCBrZXlzVG9EZXRlY3QgPSB7fTsKICBmb3IgKGxldCBrZXkgaW4gdHJhY2tlZFByb3BlcnR5LmNoaWxkcmVuKSB7CiAgICBrZXlzVG9EZXRlY3Rba2V5XSA9IHRydWU7CiAgfQogIGZvciAobGV0IGtleSBpbiBvYmopIHsKICAgIGtleXNUb0RldGVjdFtrZXldID0gdHJ1ZTsKICB9CiAgY29uc3QgaGFzSWdub3JlZFBhdGhzID0gaWdub3JlZFBhdGhzLmxlbmd0aCA+IDA7CiAgZm9yIChsZXQga2V5IGluIGtleXNUb0RldGVjdCkgewogICAgY29uc3QgbmVzdGVkUGF0aCA9IHBhdGgyID8gcGF0aDIgKyAiLiIgKyBrZXkgOiBrZXk7CiAgICBpZiAoaGFzSWdub3JlZFBhdGhzKSB7CiAgICAgIGNvbnN0IGhhc01hdGNoZXMgPSBpZ25vcmVkUGF0aHMuc29tZSgoaWdub3JlZCkgPT4gewogICAgICAgIGlmIChpZ25vcmVkIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgICByZXR1cm4gaWdub3JlZC50ZXN0KG5lc3RlZFBhdGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmVzdGVkUGF0aCA9PT0gaWdub3JlZDsKICAgICAgfSk7CiAgICAgIGlmIChoYXNNYXRjaGVzKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgIH0KICAgIGNvbnN0IHJlc3VsdCA9IGRldGVjdE11dGF0aW9ucyhpc0ltbXV0YWJsZSwgaWdub3JlZFBhdGhzLCB0cmFja2VkUHJvcGVydHkuY2hpbGRyZW5ba2V5XSwgb2JqW2tleV0sIHNhbWVSZWYsIG5lc3RlZFBhdGgpOwogICAgaWYgKHJlc3VsdC53YXNNdXRhdGVkKSB7CiAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgfQogIHJldHVybiB7CiAgICB3YXNNdXRhdGVkOiBmYWxzZQogIH07Cn0KZnVuY3Rpb24gY3JlYXRlSW1tdXRhYmxlU3RhdGVJbnZhcmlhbnRNaWRkbGV3YXJlKG9wdGlvbnMgPSB7fSkgewogIGlmIChmYWxzZSkgewogICAgcmV0dXJuICgpID0+IChuZXh0KSA9PiAoYWN0aW9uKSA9PiBuZXh0KGFjdGlvbik7CiAgfSBlbHNlIHsKICAgIGxldCBzdHJpbmdpZnkyID0gZnVuY3Rpb24ob2JqLCBzZXJpYWxpemVyLCBpbmRlbnQsIGRlY3ljbGVyKSB7CiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmosIGdldFNlcmlhbGl6ZTIoc2VyaWFsaXplciwgZGVjeWNsZXIpLCBpbmRlbnQpOwogICAgfSwgZ2V0U2VyaWFsaXplMiA9IGZ1bmN0aW9uKHNlcmlhbGl6ZXIsIGRlY3ljbGVyKSB7CiAgICAgIGxldCBzdGFjayA9IFtdLCBrZXlzID0gW107CiAgICAgIGlmICghZGVjeWNsZXIpIGRlY3ljbGVyID0gZnVuY3Rpb24oXywgdmFsdWUpIHsKICAgICAgICBpZiAoc3RhY2tbMF0gPT09IHZhbHVlKSByZXR1cm4gIltDaXJjdWxhciB+XSI7CiAgICAgICAgcmV0dXJuICJbQ2lyY3VsYXIgfi4iICsga2V5cy5zbGljZSgwLCBzdGFjay5pbmRleE9mKHZhbHVlKSkuam9pbigiLiIpICsgIl0iOwogICAgICB9OwogICAgICByZXR1cm4gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIGlmIChzdGFjay5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgdGhpc1BvcyA9IHN0YWNrLmluZGV4T2YodGhpcyk7CiAgICAgICAgICB+dGhpc1BvcyA/IHN0YWNrLnNwbGljZSh0aGlzUG9zICsgMSkgOiBzdGFjay5wdXNoKHRoaXMpOwogICAgICAgICAgfnRoaXNQb3MgPyBrZXlzLnNwbGljZSh0aGlzUG9zLCBJbmZpbml0eSwga2V5KSA6IGtleXMucHVzaChrZXkpOwogICAgICAgICAgaWYgKH5zdGFjay5pbmRleE9mKHZhbHVlKSkgdmFsdWUgPSBkZWN5Y2xlci5jYWxsKHRoaXMsIGtleSwgdmFsdWUpOwogICAgICAgIH0gZWxzZSBzdGFjay5wdXNoKHZhbHVlKTsKICAgICAgICByZXR1cm4gc2VyaWFsaXplciA9PSBudWxsID8gdmFsdWUgOiBzZXJpYWxpemVyLmNhbGwodGhpcywga2V5LCB2YWx1ZSk7CiAgICAgIH07CiAgICB9OwogICAgdmFyIHN0cmluZ2lmeSA9IHN0cmluZ2lmeTIsIGdldFNlcmlhbGl6ZSA9IGdldFNlcmlhbGl6ZTI7CiAgICBsZXQgewogICAgICBpc0ltbXV0YWJsZSA9IGlzSW1tdXRhYmxlRGVmYXVsdCwKICAgICAgaWdub3JlZFBhdGhzLAogICAgICB3YXJuQWZ0ZXIgPSAzMgogICAgfSA9IG9wdGlvbnM7CiAgICBjb25zdCB0cmFjayA9IHRyYWNrRm9yTXV0YXRpb25zLmJpbmQobnVsbCwgaXNJbW11dGFibGUsIGlnbm9yZWRQYXRocyk7CiAgICByZXR1cm4gKHsKICAgICAgZ2V0U3RhdGUKICAgIH0pID0+IHsKICAgICAgbGV0IHN0YXRlID0gZ2V0U3RhdGUoKTsKICAgICAgbGV0IHRyYWNrZXIgPSB0cmFjayhzdGF0ZSk7CiAgICAgIGxldCByZXN1bHQ7CiAgICAgIHJldHVybiAobmV4dCkgPT4gKGFjdGlvbikgPT4gewogICAgICAgIGNvbnN0IG1lYXN1cmVVdGlscyA9IGdldFRpbWVNZWFzdXJlVXRpbHMod2FybkFmdGVyLCAiSW1tdXRhYmxlU3RhdGVJbnZhcmlhbnRNaWRkbGV3YXJlIik7CiAgICAgICAgbWVhc3VyZVV0aWxzLm1lYXN1cmVUaW1lKCgpID0+IHsKICAgICAgICAgIHN0YXRlID0gZ2V0U3RhdGUoKTsKICAgICAgICAgIHJlc3VsdCA9IHRyYWNrZXIuZGV0ZWN0TXV0YXRpb25zKCk7CiAgICAgICAgICB0cmFja2VyID0gdHJhY2soc3RhdGUpOwogICAgICAgICAgaWYgKHJlc3VsdC53YXNNdXRhdGVkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTkpIDogYEEgc3RhdGUgbXV0YXRpb24gd2FzIGRldGVjdGVkIGJldHdlZW4gZGlzcGF0Y2hlcywgaW4gdGhlIHBhdGggJyR7cmVzdWx0LnBhdGggfHwgIiJ9Jy4gIFRoaXMgbWF5IGNhdXNlIGluY29ycmVjdCBiZWhhdmlvci4gKGh0dHBzOi8vcmVkdXguanMub3JnL3N0eWxlLWd1aWRlL3N0eWxlLWd1aWRlI2RvLW5vdC1tdXRhdGUtc3RhdGUpYCk7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgY29uc3QgZGlzcGF0Y2hlZEFjdGlvbiA9IG5leHQoYWN0aW9uKTsKICAgICAgICBtZWFzdXJlVXRpbHMubWVhc3VyZVRpbWUoKCkgPT4gewogICAgICAgICAgc3RhdGUgPSBnZXRTdGF0ZSgpOwogICAgICAgICAgcmVzdWx0ID0gdHJhY2tlci5kZXRlY3RNdXRhdGlvbnMoKTsKICAgICAgICAgIHRyYWNrZXIgPSB0cmFjayhzdGF0ZSk7CiAgICAgICAgICBpZiAocmVzdWx0Lndhc011dGF0ZWQpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyMCkgOiBgQSBzdGF0ZSBtdXRhdGlvbiB3YXMgZGV0ZWN0ZWQgaW5zaWRlIGEgZGlzcGF0Y2gsIGluIHRoZSBwYXRoOiAke3Jlc3VsdC5wYXRoIHx8ICIifS4gVGFrZSBhIGxvb2sgYXQgdGhlIHJlZHVjZXIocykgaGFuZGxpbmcgdGhlIGFjdGlvbiAke3N0cmluZ2lmeTIoYWN0aW9uKX0uIChodHRwczovL3JlZHV4LmpzLm9yZy9zdHlsZS1ndWlkZS9zdHlsZS1ndWlkZSNkby1ub3QtbXV0YXRlLXN0YXRlKWApOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIG1lYXN1cmVVdGlscy53YXJuSWZFeGNlZWRlZCgpOwogICAgICAgIHJldHVybiBkaXNwYXRjaGVkQWN0aW9uOwogICAgICB9OwogICAgfTsKICB9Cn0KZnVuY3Rpb24gaXNQbGFpbih2YWwpIHsKICBjb25zdCB0eXBlID0gdHlwZW9mIHZhbDsKICByZXR1cm4gdmFsID09IG51bGwgfHwgdHlwZSA9PT0gInN0cmluZyIgfHwgdHlwZSA9PT0gImJvb2xlYW4iIHx8IHR5cGUgPT09ICJudW1iZXIiIHx8IEFycmF5LmlzQXJyYXkodmFsKSB8fCBpc1BsYWluT2JqZWN0KHZhbCk7Cn0KZnVuY3Rpb24gZmluZE5vblNlcmlhbGl6YWJsZVZhbHVlKHZhbHVlLCBwYXRoMiA9ICIiLCBpc1NlcmlhbGl6YWJsZSA9IGlzUGxhaW4sIGdldEVudHJpZXMsIGlnbm9yZWRQYXRocyA9IFtdLCBjYWNoZSkgewogIGxldCBmb3VuZE5lc3RlZFNlcmlhbGl6YWJsZTsKICBpZiAoIWlzU2VyaWFsaXphYmxlKHZhbHVlKSkgewogICAgcmV0dXJuIHsKICAgICAga2V5UGF0aDogcGF0aDIgfHwgIjxyb290PiIsCiAgICAgIHZhbHVlCiAgICB9OwogIH0KICBpZiAodHlwZW9mIHZhbHVlICE9PSAib2JqZWN0IiB8fCB2YWx1ZSA9PT0gbnVsbCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBpZiAoY2FjaGU/Lmhhcyh2YWx1ZSkpIHJldHVybiBmYWxzZTsKICBjb25zdCBlbnRyaWVzID0gZ2V0RW50cmllcyAhPSBudWxsID8gZ2V0RW50cmllcyh2YWx1ZSkgOiBPYmplY3QuZW50cmllcyh2YWx1ZSk7CiAgY29uc3QgaGFzSWdub3JlZFBhdGhzID0gaWdub3JlZFBhdGhzLmxlbmd0aCA+IDA7CiAgZm9yIChjb25zdCBba2V5LCBuZXN0ZWRWYWx1ZV0gb2YgZW50cmllcykgewogICAgY29uc3QgbmVzdGVkUGF0aCA9IHBhdGgyID8gcGF0aDIgKyAiLiIgKyBrZXkgOiBrZXk7CiAgICBpZiAoaGFzSWdub3JlZFBhdGhzKSB7CiAgICAgIGNvbnN0IGhhc01hdGNoZXMgPSBpZ25vcmVkUGF0aHMuc29tZSgoaWdub3JlZCkgPT4gewogICAgICAgIGlmIChpZ25vcmVkIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgICByZXR1cm4gaWdub3JlZC50ZXN0KG5lc3RlZFBhdGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmVzdGVkUGF0aCA9PT0gaWdub3JlZDsKICAgICAgfSk7CiAgICAgIGlmIChoYXNNYXRjaGVzKSB7CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgIH0KICAgIGlmICghaXNTZXJpYWxpemFibGUobmVzdGVkVmFsdWUpKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAga2V5UGF0aDogbmVzdGVkUGF0aCwKICAgICAgICB2YWx1ZTogbmVzdGVkVmFsdWUKICAgICAgfTsKICAgIH0KICAgIGlmICh0eXBlb2YgbmVzdGVkVmFsdWUgPT09ICJvYmplY3QiKSB7CiAgICAgIGZvdW5kTmVzdGVkU2VyaWFsaXphYmxlID0gZmluZE5vblNlcmlhbGl6YWJsZVZhbHVlKG5lc3RlZFZhbHVlLCBuZXN0ZWRQYXRoLCBpc1NlcmlhbGl6YWJsZSwgZ2V0RW50cmllcywgaWdub3JlZFBhdGhzLCBjYWNoZSk7CiAgICAgIGlmIChmb3VuZE5lc3RlZFNlcmlhbGl6YWJsZSkgewogICAgICAgIHJldHVybiBmb3VuZE5lc3RlZFNlcmlhbGl6YWJsZTsKICAgICAgfQogICAgfQogIH0KICBpZiAoY2FjaGUgJiYgaXNOZXN0ZWRGcm96ZW4odmFsdWUpKSBjYWNoZS5hZGQodmFsdWUpOwogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBpc05lc3RlZEZyb3plbih2YWx1ZSkgewogIGlmICghT2JqZWN0LmlzRnJvemVuKHZhbHVlKSkgcmV0dXJuIGZhbHNlOwogIGZvciAoY29uc3QgbmVzdGVkVmFsdWUgb2YgT2JqZWN0LnZhbHVlcyh2YWx1ZSkpIHsKICAgIGlmICh0eXBlb2YgbmVzdGVkVmFsdWUgIT09ICJvYmplY3QiIHx8IG5lc3RlZFZhbHVlID09PSBudWxsKSBjb250aW51ZTsKICAgIGlmICghaXNOZXN0ZWRGcm96ZW4obmVzdGVkVmFsdWUpKSByZXR1cm4gZmFsc2U7CiAgfQogIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIGNyZWF0ZVNlcmlhbGl6YWJsZVN0YXRlSW52YXJpYW50TWlkZGxld2FyZShvcHRpb25zID0ge30pIHsKICBpZiAoZmFsc2UpIHsKICAgIHJldHVybiAoKSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gbmV4dChhY3Rpb24pOwogIH0gZWxzZSB7CiAgICBjb25zdCB7CiAgICAgIGlzU2VyaWFsaXphYmxlID0gaXNQbGFpbiwKICAgICAgZ2V0RW50cmllcywKICAgICAgaWdub3JlZEFjdGlvbnMgPSBbXSwKICAgICAgaWdub3JlZEFjdGlvblBhdGhzID0gWyJtZXRhLmFyZyIsICJtZXRhLmJhc2VRdWVyeU1ldGEiXSwKICAgICAgaWdub3JlZFBhdGhzID0gW10sCiAgICAgIHdhcm5BZnRlciA9IDMyLAogICAgICBpZ25vcmVTdGF0ZSA9IGZhbHNlLAogICAgICBpZ25vcmVBY3Rpb25zID0gZmFsc2UsCiAgICAgIGRpc2FibGVDYWNoZSA9IGZhbHNlCiAgICB9ID0gb3B0aW9uczsKICAgIGNvbnN0IGNhY2hlID0gIWRpc2FibGVDYWNoZSAmJiBXZWFrU2V0ID8gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrU2V0KCkgOiB2b2lkIDA7CiAgICByZXR1cm4gKHN0b3JlQVBJKSA9PiAobmV4dCkgPT4gKGFjdGlvbikgPT4gewogICAgICBpZiAoIWlzQWN0aW9uKGFjdGlvbikpIHsKICAgICAgICByZXR1cm4gbmV4dChhY3Rpb24pOwogICAgICB9CiAgICAgIGNvbnN0IHJlc3VsdCA9IG5leHQoYWN0aW9uKTsKICAgICAgY29uc3QgbWVhc3VyZVV0aWxzID0gZ2V0VGltZU1lYXN1cmVVdGlscyh3YXJuQWZ0ZXIsICJTZXJpYWxpemFibGVTdGF0ZUludmFyaWFudE1pZGRsZXdhcmUiKTsKICAgICAgaWYgKCFpZ25vcmVBY3Rpb25zICYmICEoaWdub3JlZEFjdGlvbnMubGVuZ3RoICYmIGlnbm9yZWRBY3Rpb25zLmluZGV4T2YoYWN0aW9uLnR5cGUpICE9PSAtMSkpIHsKICAgICAgICBtZWFzdXJlVXRpbHMubWVhc3VyZVRpbWUoKCkgPT4gewogICAgICAgICAgY29uc3QgZm91bmRBY3Rpb25Ob25TZXJpYWxpemFibGVWYWx1ZSA9IGZpbmROb25TZXJpYWxpemFibGVWYWx1ZShhY3Rpb24sICIiLCBpc1NlcmlhbGl6YWJsZSwgZ2V0RW50cmllcywgaWdub3JlZEFjdGlvblBhdGhzLCBjYWNoZSk7CiAgICAgICAgICBpZiAoZm91bmRBY3Rpb25Ob25TZXJpYWxpemFibGVWYWx1ZSkgewogICAgICAgICAgICBjb25zdCB7CiAgICAgICAgICAgICAga2V5UGF0aCwKICAgICAgICAgICAgICB2YWx1ZQogICAgICAgICAgICB9ID0gZm91bmRBY3Rpb25Ob25TZXJpYWxpemFibGVWYWx1ZTsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgQSBub24tc2VyaWFsaXphYmxlIHZhbHVlIHdhcyBkZXRlY3RlZCBpbiBhbiBhY3Rpb24sIGluIHRoZSBwYXRoOiBcYCR7a2V5UGF0aH1cYC4gVmFsdWU6YCwgdmFsdWUsICJcblRha2UgYSBsb29rIGF0IHRoZSBsb2dpYyB0aGF0IGRpc3BhdGNoZWQgdGhpcyBhY3Rpb246ICIsIGFjdGlvbiwgIlxuKFNlZSBodHRwczovL3JlZHV4LmpzLm9yZy9mYXEvYWN0aW9ucyN3aHktc2hvdWxkLXR5cGUtYmUtYS1zdHJpbmctb3ItYXQtbGVhc3Qtc2VyaWFsaXphYmxlLXdoeS1zaG91bGQtbXktYWN0aW9uLXR5cGVzLWJlLWNvbnN0YW50cykiLCAiXG4oVG8gYWxsb3cgbm9uLXNlcmlhbGl6YWJsZSB2YWx1ZXMgc2VlOiBodHRwczovL3JlZHV4LXRvb2xraXQuanMub3JnL3VzYWdlL3VzYWdlLWd1aWRlI3dvcmtpbmctd2l0aC1ub24tc2VyaWFsaXphYmxlLWRhdGEpIik7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKCFpZ25vcmVTdGF0ZSkgewogICAgICAgIG1lYXN1cmVVdGlscy5tZWFzdXJlVGltZSgoKSA9PiB7CiAgICAgICAgICBjb25zdCBzdGF0ZSA9IHN0b3JlQVBJLmdldFN0YXRlKCk7CiAgICAgICAgICBjb25zdCBmb3VuZFN0YXRlTm9uU2VyaWFsaXphYmxlVmFsdWUgPSBmaW5kTm9uU2VyaWFsaXphYmxlVmFsdWUoc3RhdGUsICIiLCBpc1NlcmlhbGl6YWJsZSwgZ2V0RW50cmllcywgaWdub3JlZFBhdGhzLCBjYWNoZSk7CiAgICAgICAgICBpZiAoZm91bmRTdGF0ZU5vblNlcmlhbGl6YWJsZVZhbHVlKSB7CiAgICAgICAgICAgIGNvbnN0IHsKICAgICAgICAgICAgICBrZXlQYXRoLAogICAgICAgICAgICAgIHZhbHVlCiAgICAgICAgICAgIH0gPSBmb3VuZFN0YXRlTm9uU2VyaWFsaXphYmxlVmFsdWU7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEEgbm9uLXNlcmlhbGl6YWJsZSB2YWx1ZSB3YXMgZGV0ZWN0ZWQgaW4gdGhlIHN0YXRlLCBpbiB0aGUgcGF0aDogXGAke2tleVBhdGh9XGAuIFZhbHVlOmAsIHZhbHVlLCBgClRha2UgYSBsb29rIGF0IHRoZSByZWR1Y2VyKHMpIGhhbmRsaW5nIHRoaXMgYWN0aW9uIHR5cGU6ICR7YWN0aW9uLnR5cGV9LgooU2VlIGh0dHBzOi8vcmVkdXguanMub3JnL2ZhcS9vcmdhbml6aW5nLXN0YXRlI2Nhbi1pLXB1dC1mdW5jdGlvbnMtcHJvbWlzZXMtb3Itb3RoZXItbm9uLXNlcmlhbGl6YWJsZS1pdGVtcy1pbi1teS1zdG9yZS1zdGF0ZSlgKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBtZWFzdXJlVXRpbHMud2FybklmRXhjZWVkZWQoKTsKICAgICAgfQogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9Cn0KZnVuY3Rpb24gaXNCb29sZWFuMih4MikgewogIHJldHVybiB0eXBlb2YgeDIgPT09ICJib29sZWFuIjsKfQp2YXIgYnVpbGRHZXREZWZhdWx0TWlkZGxld2FyZSA9ICgpID0+IGZ1bmN0aW9uIGdldERlZmF1bHRNaWRkbGV3YXJlKG9wdGlvbnMpIHsKICBjb25zdCB7CiAgICB0aHVuazogdGh1bmsyID0gdHJ1ZSwKICAgIGltbXV0YWJsZUNoZWNrID0gdHJ1ZSwKICAgIHNlcmlhbGl6YWJsZUNoZWNrID0gdHJ1ZSwKICAgIGFjdGlvbkNyZWF0b3JDaGVjayA9IHRydWUKICB9ID0gb3B0aW9ucyA/PyB7fTsKICBsZXQgbWlkZGxld2FyZUFycmF5ID0gbmV3IFR1cGxlKCk7CiAgaWYgKHRodW5rMikgewogICAgaWYgKGlzQm9vbGVhbjIodGh1bmsyKSkgewogICAgICBtaWRkbGV3YXJlQXJyYXkucHVzaCh0aHVuayk7CiAgICB9IGVsc2UgewogICAgICBtaWRkbGV3YXJlQXJyYXkucHVzaCh3aXRoRXh0cmFBcmd1bWVudCh0aHVuazIuZXh0cmFBcmd1bWVudCkpOwogICAgfQogIH0KICBpZiAodHJ1ZSkgewogICAgaWYgKGltbXV0YWJsZUNoZWNrKSB7CiAgICAgIGxldCBpbW11dGFibGVPcHRpb25zID0ge307CiAgICAgIGlmICghaXNCb29sZWFuMihpbW11dGFibGVDaGVjaykpIHsKICAgICAgICBpbW11dGFibGVPcHRpb25zID0gaW1tdXRhYmxlQ2hlY2s7CiAgICAgIH0KICAgICAgbWlkZGxld2FyZUFycmF5LnVuc2hpZnQoY3JlYXRlSW1tdXRhYmxlU3RhdGVJbnZhcmlhbnRNaWRkbGV3YXJlKGltbXV0YWJsZU9wdGlvbnMpKTsKICAgIH0KICAgIGlmIChzZXJpYWxpemFibGVDaGVjaykgewogICAgICBsZXQgc2VyaWFsaXphYmxlT3B0aW9ucyA9IHt9OwogICAgICBpZiAoIWlzQm9vbGVhbjIoc2VyaWFsaXphYmxlQ2hlY2spKSB7CiAgICAgICAgc2VyaWFsaXphYmxlT3B0aW9ucyA9IHNlcmlhbGl6YWJsZUNoZWNrOwogICAgICB9CiAgICAgIG1pZGRsZXdhcmVBcnJheS5wdXNoKGNyZWF0ZVNlcmlhbGl6YWJsZVN0YXRlSW52YXJpYW50TWlkZGxld2FyZShzZXJpYWxpemFibGVPcHRpb25zKSk7CiAgICB9CiAgICBpZiAoYWN0aW9uQ3JlYXRvckNoZWNrKSB7CiAgICAgIGxldCBhY3Rpb25DcmVhdG9yT3B0aW9ucyA9IHt9OwogICAgICBpZiAoIWlzQm9vbGVhbjIoYWN0aW9uQ3JlYXRvckNoZWNrKSkgewogICAgICAgIGFjdGlvbkNyZWF0b3JPcHRpb25zID0gYWN0aW9uQ3JlYXRvckNoZWNrOwogICAgICB9CiAgICAgIG1pZGRsZXdhcmVBcnJheS51bnNoaWZ0KGNyZWF0ZUFjdGlvbkNyZWF0b3JJbnZhcmlhbnRNaWRkbGV3YXJlKGFjdGlvbkNyZWF0b3JPcHRpb25zKSk7CiAgICB9CiAgfQogIHJldHVybiBtaWRkbGV3YXJlQXJyYXk7Cn07CnZhciBTSE9VTERfQVVUT0JBVENIID0gIlJUS19hdXRvQmF0Y2giOwp2YXIgcHJlcGFyZUF1dG9CYXRjaGVkID0gKCkgPT4gKHBheWxvYWQpID0+ICh7CiAgcGF5bG9hZCwKICBtZXRhOiB7CiAgICBbU0hPVUxEX0FVVE9CQVRDSF06IHRydWUKICB9Cn0pOwp2YXIgY3JlYXRlUXVldWVXaXRoVGltZXIgPSAodGltZW91dCkgPT4gewogIHJldHVybiAobm90aWZ5KSA9PiB7CiAgICBzZXRUaW1lb3V0KG5vdGlmeSwgdGltZW91dCk7CiAgfTsKfTsKdmFyIGF1dG9CYXRjaEVuaGFuY2VyID0gKG9wdGlvbnMgPSB7CiAgdHlwZTogInJhZiIKfSkgPT4gKG5leHQpID0+ICguLi5hcmdzKSA9PiB7CiAgY29uc3Qgc3RvcmUgPSBuZXh0KC4uLmFyZ3MpOwogIGxldCBub3RpZnlpbmcgPSB0cnVlOwogIGxldCBzaG91bGROb3RpZnlBdEVuZE9mVGljayA9IGZhbHNlOwogIGxldCBub3RpZmljYXRpb25RdWV1ZWQgPSBmYWxzZTsKICBjb25zdCBsaXN0ZW5lcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IFNldCgpOwogIGNvbnN0IHF1ZXVlQ2FsbGJhY2sgPSBvcHRpb25zLnR5cGUgPT09ICJ0aWNrIiA/IHF1ZXVlTWljcm90YXNrIDogb3B0aW9ucy50eXBlID09PSAicmFmIiA/ICgKICAgIC8vIHJlcXVlc3RBbmltYXRpb25GcmFtZSB3b24ndCBleGlzdCBpbiBTU1IgZW52aXJvbm1lbnRzLiBGYWxsIGJhY2sgdG8gYSB2YWd1ZSBhcHByb3hpbWF0aW9uIGp1c3QgdG8ga2VlcCBmcm9tIGVycm9yaW5nLgogICAgdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA/IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgOiBjcmVhdGVRdWV1ZVdpdGhUaW1lcigxMCkKICApIDogb3B0aW9ucy50eXBlID09PSAiY2FsbGJhY2siID8gb3B0aW9ucy5xdWV1ZU5vdGlmaWNhdGlvbiA6IGNyZWF0ZVF1ZXVlV2l0aFRpbWVyKG9wdGlvbnMudGltZW91dCk7CiAgY29uc3Qgbm90aWZ5TGlzdGVuZXJzID0gKCkgPT4gewogICAgbm90aWZpY2F0aW9uUXVldWVkID0gZmFsc2U7CiAgICBpZiAoc2hvdWxkTm90aWZ5QXRFbmRPZlRpY2spIHsKICAgICAgc2hvdWxkTm90aWZ5QXRFbmRPZlRpY2sgPSBmYWxzZTsKICAgICAgbGlzdGVuZXJzLmZvckVhY2goKGwpID0+IGwoKSk7CiAgICB9CiAgfTsKICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgc3RvcmUsIHsKICAgIC8vIE92ZXJyaWRlIHRoZSBiYXNlIGBzdG9yZS5zdWJzY3JpYmVgIG1ldGhvZCB0byBrZWVwIG9yaWdpbmFsIGxpc3RlbmVycwogICAgLy8gZnJvbSBydW5uaW5nIGlmIHdlJ3JlIGRlbGF5aW5nIG5vdGlmaWNhdGlvbnMKICAgIHN1YnNjcmliZShsaXN0ZW5lcjIpIHsKICAgICAgY29uc3Qgd3JhcHBlZExpc3RlbmVyID0gKCkgPT4gbm90aWZ5aW5nICYmIGxpc3RlbmVyMigpOwogICAgICBjb25zdCB1bnN1YnNjcmliZSA9IHN0b3JlLnN1YnNjcmliZSh3cmFwcGVkTGlzdGVuZXIpOwogICAgICBsaXN0ZW5lcnMuYWRkKGxpc3RlbmVyMik7CiAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgdW5zdWJzY3JpYmUoKTsKICAgICAgICBsaXN0ZW5lcnMuZGVsZXRlKGxpc3RlbmVyMik7CiAgICAgIH07CiAgICB9LAogICAgLy8gT3ZlcnJpZGUgdGhlIGJhc2UgYHN0b3JlLmRpc3BhdGNoYCBtZXRob2Qgc28gdGhhdCB3ZSBjYW4gY2hlY2sgYWN0aW9ucwogICAgLy8gZm9yIHRoZSBgc2hvdWxkQXV0b0JhdGNoYCBmbGFnIGFuZCBkZXRlcm1pbmUgaWYgYmF0Y2hpbmcgaXMgYWN0aXZlCiAgICBkaXNwYXRjaChhY3Rpb24pIHsKICAgICAgdHJ5IHsKICAgICAgICBub3RpZnlpbmcgPSAhYWN0aW9uPy5tZXRhPy5bU0hPVUxEX0FVVE9CQVRDSF07CiAgICAgICAgc2hvdWxkTm90aWZ5QXRFbmRPZlRpY2sgPSAhbm90aWZ5aW5nOwogICAgICAgIGlmIChzaG91bGROb3RpZnlBdEVuZE9mVGljaykgewogICAgICAgICAgaWYgKCFub3RpZmljYXRpb25RdWV1ZWQpIHsKICAgICAgICAgICAgbm90aWZpY2F0aW9uUXVldWVkID0gdHJ1ZTsKICAgICAgICAgICAgcXVldWVDYWxsYmFjayhub3RpZnlMaXN0ZW5lcnMpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RvcmUuZGlzcGF0Y2goYWN0aW9uKTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICBub3RpZnlpbmcgPSB0cnVlOwogICAgICB9CiAgICB9CiAgfSk7Cn07CnZhciBidWlsZEdldERlZmF1bHRFbmhhbmNlcnMgPSAobWlkZGxld2FyZUVuaGFuY2VyKSA9PiBmdW5jdGlvbiBnZXREZWZhdWx0RW5oYW5jZXJzKG9wdGlvbnMpIHsKICBjb25zdCB7CiAgICBhdXRvQmF0Y2ggPSB0cnVlCiAgfSA9IG9wdGlvbnMgPz8ge307CiAgbGV0IGVuaGFuY2VyQXJyYXkgPSBuZXcgVHVwbGUobWlkZGxld2FyZUVuaGFuY2VyKTsKICBpZiAoYXV0b0JhdGNoKSB7CiAgICBlbmhhbmNlckFycmF5LnB1c2goYXV0b0JhdGNoRW5oYW5jZXIodHlwZW9mIGF1dG9CYXRjaCA9PT0gIm9iamVjdCIgPyBhdXRvQmF0Y2ggOiB2b2lkIDApKTsKICB9CiAgcmV0dXJuIGVuaGFuY2VyQXJyYXk7Cn07CmZ1bmN0aW9uIGNvbmZpZ3VyZVN0b3JlKG9wdGlvbnMpIHsKICBjb25zdCBnZXREZWZhdWx0TWlkZGxld2FyZSA9IGJ1aWxkR2V0RGVmYXVsdE1pZGRsZXdhcmUoKTsKICBjb25zdCB7CiAgICByZWR1Y2VyID0gdm9pZCAwLAogICAgbWlkZGxld2FyZSwKICAgIGRldlRvb2xzID0gdHJ1ZSwKICAgIGR1cGxpY2F0ZU1pZGRsZXdhcmVDaGVjayA9IHRydWUsCiAgICBwcmVsb2FkZWRTdGF0ZSA9IHZvaWQgMCwKICAgIGVuaGFuY2VycyA9IHZvaWQgMAogIH0gPSBvcHRpb25zIHx8IHt9OwogIGxldCByb290UmVkdWNlcjI7CiAgaWYgKHR5cGVvZiByZWR1Y2VyID09PSAiZnVuY3Rpb24iKSB7CiAgICByb290UmVkdWNlcjIgPSByZWR1Y2VyOwogIH0gZWxzZSBpZiAoaXNQbGFpbk9iamVjdChyZWR1Y2VyKSkgewogICAgcm9vdFJlZHVjZXIyID0gY29tYmluZVJlZHVjZXJzKHJlZHVjZXIpOwogIH0gZWxzZSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEpIDogImByZWR1Y2VyYCBpcyBhIHJlcXVpcmVkIGFyZ3VtZW50LCBhbmQgbXVzdCBiZSBhIGZ1bmN0aW9uIG9yIGFuIG9iamVjdCBvZiBmdW5jdGlvbnMgdGhhdCBjYW4gYmUgcGFzc2VkIHRvIGNvbWJpbmVSZWR1Y2VycyIpOwogIH0KICBpZiAobWlkZGxld2FyZSAmJiB0eXBlb2YgbWlkZGxld2FyZSAhPT0gImZ1bmN0aW9uIikgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyKSA6ICJgbWlkZGxld2FyZWAgZmllbGQgbXVzdCBiZSBhIGNhbGxiYWNrIik7CiAgfQogIGxldCBmaW5hbE1pZGRsZXdhcmU7CiAgaWYgKHR5cGVvZiBtaWRkbGV3YXJlID09PSAiZnVuY3Rpb24iKSB7CiAgICBmaW5hbE1pZGRsZXdhcmUgPSBtaWRkbGV3YXJlKGdldERlZmF1bHRNaWRkbGV3YXJlKTsKICAgIGlmICghQXJyYXkuaXNBcnJheShmaW5hbE1pZGRsZXdhcmUpKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMykgOiAid2hlbiB1c2luZyBhIG1pZGRsZXdhcmUgYnVpbGRlciBmdW5jdGlvbiwgYW4gYXJyYXkgb2YgbWlkZGxld2FyZSBtdXN0IGJlIHJldHVybmVkIik7CiAgICB9CiAgfSBlbHNlIHsKICAgIGZpbmFsTWlkZGxld2FyZSA9IGdldERlZmF1bHRNaWRkbGV3YXJlKCk7CiAgfQogIGlmIChmaW5hbE1pZGRsZXdhcmUuc29tZSgoaXRlbSkgPT4gdHlwZW9mIGl0ZW0gIT09ICJmdW5jdGlvbiIpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDQpIDogImVhY2ggbWlkZGxld2FyZSBwcm92aWRlZCB0byBjb25maWd1cmVTdG9yZSBtdXN0IGJlIGEgZnVuY3Rpb24iKTsKICB9CiAgaWYgKGR1cGxpY2F0ZU1pZGRsZXdhcmVDaGVjaykgewogICAgbGV0IG1pZGRsZXdhcmVSZWZlcmVuY2VzID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoKTsKICAgIGZpbmFsTWlkZGxld2FyZS5mb3JFYWNoKChtaWRkbGV3YXJlMikgPT4gewogICAgICBpZiAobWlkZGxld2FyZVJlZmVyZW5jZXMuaGFzKG1pZGRsZXdhcmUyKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNDIpIDogIkR1cGxpY2F0ZSBtaWRkbGV3YXJlIHJlZmVyZW5jZXMgZm91bmQgd2hlbiBjcmVhdGluZyB0aGUgc3RvcmUuIEVuc3VyZSB0aGF0IGVhY2ggbWlkZGxld2FyZSBpcyBvbmx5IGluY2x1ZGVkIG9uY2UuIik7CiAgICAgIH0KICAgICAgbWlkZGxld2FyZVJlZmVyZW5jZXMuYWRkKG1pZGRsZXdhcmUyKTsKICAgIH0pOwogIH0KICBsZXQgZmluYWxDb21wb3NlID0gY29tcG9zZTsKICBpZiAoZGV2VG9vbHMpIHsKICAgIGZpbmFsQ29tcG9zZSA9IGNvbXBvc2VXaXRoRGV2VG9vbHMoewogICAgICAvLyBFbmFibGUgY2FwdHVyZSBvZiBzdGFjayB0cmFjZXMgZm9yIGRpc3BhdGNoZWQgUmVkdXggYWN0aW9ucwogICAgICB0cmFjZTogdHJ1ZSwKICAgICAgLi4udHlwZW9mIGRldlRvb2xzID09PSAib2JqZWN0IiAmJiBkZXZUb29scwogICAgfSk7CiAgfQogIGNvbnN0IG1pZGRsZXdhcmVFbmhhbmNlciA9IGFwcGx5TWlkZGxld2FyZSguLi5maW5hbE1pZGRsZXdhcmUpOwogIGNvbnN0IGdldERlZmF1bHRFbmhhbmNlcnMgPSBidWlsZEdldERlZmF1bHRFbmhhbmNlcnMobWlkZGxld2FyZUVuaGFuY2VyKTsKICBpZiAoZW5oYW5jZXJzICYmIHR5cGVvZiBlbmhhbmNlcnMgIT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNSkgOiAiYGVuaGFuY2Vyc2AgZmllbGQgbXVzdCBiZSBhIGNhbGxiYWNrIik7CiAgfQogIGxldCBzdG9yZUVuaGFuY2VycyA9IHR5cGVvZiBlbmhhbmNlcnMgPT09ICJmdW5jdGlvbiIgPyBlbmhhbmNlcnMoZ2V0RGVmYXVsdEVuaGFuY2VycykgOiBnZXREZWZhdWx0RW5oYW5jZXJzKCk7CiAgaWYgKCFBcnJheS5pc0FycmF5KHN0b3JlRW5oYW5jZXJzKSkgewogICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg2KSA6ICJgZW5oYW5jZXJzYCBjYWxsYmFjayBtdXN0IHJldHVybiBhbiBhcnJheSIpOwogIH0KICBpZiAoc3RvcmVFbmhhbmNlcnMuc29tZSgoaXRlbSkgPT4gdHlwZW9mIGl0ZW0gIT09ICJmdW5jdGlvbiIpKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDcpIDogImVhY2ggZW5oYW5jZXIgcHJvdmlkZWQgdG8gY29uZmlndXJlU3RvcmUgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgfQogIGlmIChmaW5hbE1pZGRsZXdhcmUubGVuZ3RoICYmICFzdG9yZUVuaGFuY2Vycy5pbmNsdWRlcyhtaWRkbGV3YXJlRW5oYW5jZXIpKSB7CiAgICBjb25zb2xlLmVycm9yKCJtaWRkbGV3YXJlcyB3ZXJlIHByb3ZpZGVkLCBidXQgbWlkZGxld2FyZSBlbmhhbmNlciB3YXMgbm90IGluY2x1ZGVkIGluIGZpbmFsIGVuaGFuY2VycyAtIG1ha2Ugc3VyZSB0byBjYWxsIGBnZXREZWZhdWx0RW5oYW5jZXJzYCIpOwogIH0KICBjb25zdCBjb21wb3NlZEVuaGFuY2VyID0gZmluYWxDb21wb3NlKC4uLnN0b3JlRW5oYW5jZXJzKTsKICByZXR1cm4gY3JlYXRlU3RvcmUocm9vdFJlZHVjZXIyLCBwcmVsb2FkZWRTdGF0ZSwgY29tcG9zZWRFbmhhbmNlcik7Cn0KZnVuY3Rpb24gZXhlY3V0ZVJlZHVjZXJCdWlsZGVyQ2FsbGJhY2soYnVpbGRlckNhbGxiYWNrKSB7CiAgY29uc3QgYWN0aW9uc01hcCA9IHt9OwogIGNvbnN0IGFjdGlvbk1hdGNoZXJzID0gW107CiAgbGV0IGRlZmF1bHRDYXNlUmVkdWNlcjsKICBjb25zdCBidWlsZGVyID0gewogICAgYWRkQ2FzZSh0eXBlT3JBY3Rpb25DcmVhdG9yLCByZWR1Y2VyKSB7CiAgICAgIGlmICh0cnVlKSB7CiAgICAgICAgaWYgKGFjdGlvbk1hdGNoZXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjYpIDogImBidWlsZGVyLmFkZENhc2VgIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBiZWZvcmUgY2FsbGluZyBgYnVpbGRlci5hZGRNYXRjaGVyYCIpOwogICAgICAgIH0KICAgICAgICBpZiAoZGVmYXVsdENhc2VSZWR1Y2VyKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDI3KSA6ICJgYnVpbGRlci5hZGRDYXNlYCBzaG91bGQgb25seSBiZSBjYWxsZWQgYmVmb3JlIGNhbGxpbmcgYGJ1aWxkZXIuYWRkRGVmYXVsdENhc2VgIik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IHR5cGUgPSB0eXBlb2YgdHlwZU9yQWN0aW9uQ3JlYXRvciA9PT0gInN0cmluZyIgPyB0eXBlT3JBY3Rpb25DcmVhdG9yIDogdHlwZU9yQWN0aW9uQ3JlYXRvci50eXBlOwogICAgICBpZiAoIXR5cGUpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDI4KSA6ICJgYnVpbGRlci5hZGRDYXNlYCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYW4gZW1wdHkgYWN0aW9uIHR5cGUiKTsKICAgICAgfQogICAgICBpZiAodHlwZSBpbiBhY3Rpb25zTWFwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgyOSkgOiBgXGBidWlsZGVyLmFkZENhc2VcYCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggdHdvIHJlZHVjZXJzIGZvciB0aGUgc2FtZSBhY3Rpb24gdHlwZSAnJHt0eXBlfSdgKTsKICAgICAgfQogICAgICBhY3Rpb25zTWFwW3R5cGVdID0gcmVkdWNlcjsKICAgICAgcmV0dXJuIGJ1aWxkZXI7CiAgICB9LAogICAgYWRkQXN5bmNUaHVuayhhc3luY1RodW5rLCByZWR1Y2VycykgewogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGlmIChkZWZhdWx0Q2FzZVJlZHVjZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoNDMpIDogImBidWlsZGVyLmFkZEFzeW5jVGh1bmtgIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBiZWZvcmUgY2FsbGluZyBgYnVpbGRlci5hZGREZWZhdWx0Q2FzZWAiKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHJlZHVjZXJzLnBlbmRpbmcpIGFjdGlvbnNNYXBbYXN5bmNUaHVuay5wZW5kaW5nLnR5cGVdID0gcmVkdWNlcnMucGVuZGluZzsKICAgICAgaWYgKHJlZHVjZXJzLnJlamVjdGVkKSBhY3Rpb25zTWFwW2FzeW5jVGh1bmsucmVqZWN0ZWQudHlwZV0gPSByZWR1Y2Vycy5yZWplY3RlZDsKICAgICAgaWYgKHJlZHVjZXJzLmZ1bGZpbGxlZCkgYWN0aW9uc01hcFthc3luY1RodW5rLmZ1bGZpbGxlZC50eXBlXSA9IHJlZHVjZXJzLmZ1bGZpbGxlZDsKICAgICAgaWYgKHJlZHVjZXJzLnNldHRsZWQpIGFjdGlvbk1hdGNoZXJzLnB1c2goewogICAgICAgIG1hdGNoZXI6IGFzeW5jVGh1bmsuc2V0dGxlZCwKICAgICAgICByZWR1Y2VyOiByZWR1Y2Vycy5zZXR0bGVkCiAgICAgIH0pOwogICAgICByZXR1cm4gYnVpbGRlcjsKICAgIH0sCiAgICBhZGRNYXRjaGVyKG1hdGNoZXIsIHJlZHVjZXIpIHsKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBpZiAoZGVmYXVsdENhc2VSZWR1Y2VyKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDMwKSA6ICJgYnVpbGRlci5hZGRNYXRjaGVyYCBzaG91bGQgb25seSBiZSBjYWxsZWQgYmVmb3JlIGNhbGxpbmcgYGJ1aWxkZXIuYWRkRGVmYXVsdENhc2VgIik7CiAgICAgICAgfQogICAgICB9CiAgICAgIGFjdGlvbk1hdGNoZXJzLnB1c2goewogICAgICAgIG1hdGNoZXIsCiAgICAgICAgcmVkdWNlcgogICAgICB9KTsKICAgICAgcmV0dXJuIGJ1aWxkZXI7CiAgICB9LAogICAgYWRkRGVmYXVsdENhc2UocmVkdWNlcikgewogICAgICBpZiAodHJ1ZSkgewogICAgICAgIGlmIChkZWZhdWx0Q2FzZVJlZHVjZXIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMzEpIDogImBidWlsZGVyLmFkZERlZmF1bHRDYXNlYCBjYW4gb25seSBiZSBjYWxsZWQgb25jZSIpOwogICAgICAgIH0KICAgICAgfQogICAgICBkZWZhdWx0Q2FzZVJlZHVjZXIgPSByZWR1Y2VyOwogICAgICByZXR1cm4gYnVpbGRlcjsKICAgIH0KICB9OwogIGJ1aWxkZXJDYWxsYmFjayhidWlsZGVyKTsKICByZXR1cm4gW2FjdGlvbnNNYXAsIGFjdGlvbk1hdGNoZXJzLCBkZWZhdWx0Q2FzZVJlZHVjZXJdOwp9CmZ1bmN0aW9uIGlzU3RhdGVGdW5jdGlvbih4MikgewogIHJldHVybiB0eXBlb2YgeDIgPT09ICJmdW5jdGlvbiI7Cn0KZnVuY3Rpb24gY3JlYXRlUmVkdWNlcihpbml0aWFsU3RhdGUxMywgbWFwT3JCdWlsZGVyQ2FsbGJhY2spIHsKICBpZiAodHJ1ZSkgewogICAgaWYgKHR5cGVvZiBtYXBPckJ1aWxkZXJDYWxsYmFjayA9PT0gIm9iamVjdCIpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSg4KSA6ICJUaGUgb2JqZWN0IG5vdGF0aW9uIGZvciBgY3JlYXRlUmVkdWNlcmAgaGFzIGJlZW4gcmVtb3ZlZC4gUGxlYXNlIHVzZSB0aGUgJ2J1aWxkZXIgY2FsbGJhY2snIG5vdGF0aW9uIGluc3RlYWQ6IGh0dHBzOi8vcmVkdXgtdG9vbGtpdC5qcy5vcmcvYXBpL2NyZWF0ZVJlZHVjZXIiKTsKICAgIH0KICB9CiAgbGV0IFthY3Rpb25zTWFwLCBmaW5hbEFjdGlvbk1hdGNoZXJzLCBmaW5hbERlZmF1bHRDYXNlUmVkdWNlcl0gPSBleGVjdXRlUmVkdWNlckJ1aWxkZXJDYWxsYmFjayhtYXBPckJ1aWxkZXJDYWxsYmFjayk7CiAgbGV0IGdldEluaXRpYWxTdGF0ZTsKICBpZiAoaXNTdGF0ZUZ1bmN0aW9uKGluaXRpYWxTdGF0ZTEzKSkgewogICAgZ2V0SW5pdGlhbFN0YXRlID0gKCkgPT4gZnJlZXplRHJhZnRhYmxlKGluaXRpYWxTdGF0ZTEzKCkpOwogIH0gZWxzZSB7CiAgICBjb25zdCBmcm96ZW5Jbml0aWFsU3RhdGUgPSBmcmVlemVEcmFmdGFibGUoaW5pdGlhbFN0YXRlMTMpOwogICAgZ2V0SW5pdGlhbFN0YXRlID0gKCkgPT4gZnJvemVuSW5pdGlhbFN0YXRlOwogIH0KICBmdW5jdGlvbiByZWR1Y2VyKHN0YXRlID0gZ2V0SW5pdGlhbFN0YXRlKCksIGFjdGlvbikgewogICAgbGV0IGNhc2VSZWR1Y2VycyA9IFthY3Rpb25zTWFwW2FjdGlvbi50eXBlXSwgLi4uZmluYWxBY3Rpb25NYXRjaGVycy5maWx0ZXIoKHsKICAgICAgbWF0Y2hlcgogICAgfSkgPT4gbWF0Y2hlcihhY3Rpb24pKS5tYXAoKHsKICAgICAgcmVkdWNlcjogcmVkdWNlcjIKICAgIH0pID0+IHJlZHVjZXIyKV07CiAgICBpZiAoY2FzZVJlZHVjZXJzLmZpbHRlcigoY3IpID0+ICEhY3IpLmxlbmd0aCA9PT0gMCkgewogICAgICBjYXNlUmVkdWNlcnMgPSBbZmluYWxEZWZhdWx0Q2FzZVJlZHVjZXJdOwogICAgfQogICAgcmV0dXJuIGNhc2VSZWR1Y2Vycy5yZWR1Y2UoKHByZXZpb3VzU3RhdGUsIGNhc2VSZWR1Y2VyKSA9PiB7CiAgICAgIGlmIChjYXNlUmVkdWNlcikgewogICAgICAgIGlmIChpc0RyYWZ0KHByZXZpb3VzU3RhdGUpKSB7CiAgICAgICAgICBjb25zdCBkcmFmdCA9IHByZXZpb3VzU3RhdGU7CiAgICAgICAgICBjb25zdCByZXN1bHQgPSBjYXNlUmVkdWNlcihkcmFmdCwgYWN0aW9uKTsKICAgICAgICAgIGlmIChyZXN1bHQgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gcHJldmlvdXNTdGF0ZTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSBlbHNlIGlmICghaXNEcmFmdGFibGUocHJldmlvdXNTdGF0ZSkpIHsKICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNhc2VSZWR1Y2VyKHByZXZpb3VzU3RhdGUsIGFjdGlvbik7CiAgICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHByZXZpb3VzU3RhdGUgPT09IG51bGwpIHsKICAgICAgICAgICAgICByZXR1cm4gcHJldmlvdXNTdGF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aHJvdyBFcnJvcigiQSBjYXNlIHJlZHVjZXIgb24gYSBub24tZHJhZnRhYmxlIHZhbHVlIG11c3Qgbm90IHJldHVybiB1bmRlZmluZWQiKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBwcm9kdWNlKHByZXZpb3VzU3RhdGUsIChkcmFmdCkgPT4gewogICAgICAgICAgICByZXR1cm4gY2FzZVJlZHVjZXIoZHJhZnQsIGFjdGlvbik7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHByZXZpb3VzU3RhdGU7CiAgICB9LCBzdGF0ZSk7CiAgfQogIHJlZHVjZXIuZ2V0SW5pdGlhbFN0YXRlID0gZ2V0SW5pdGlhbFN0YXRlOwogIHJldHVybiByZWR1Y2VyOwp9CnZhciBtYXRjaGVzID0gKG1hdGNoZXIsIGFjdGlvbikgPT4gewogIGlmIChoYXNNYXRjaEZ1bmN0aW9uKG1hdGNoZXIpKSB7CiAgICByZXR1cm4gbWF0Y2hlci5tYXRjaChhY3Rpb24pOwogIH0gZWxzZSB7CiAgICByZXR1cm4gbWF0Y2hlcihhY3Rpb24pOwogIH0KfTsKZnVuY3Rpb24gaXNBbnlPZiguLi5tYXRjaGVycykgewogIHJldHVybiAoYWN0aW9uKSA9PiB7CiAgICByZXR1cm4gbWF0Y2hlcnMuc29tZSgobWF0Y2hlcikgPT4gbWF0Y2hlcyhtYXRjaGVyLCBhY3Rpb24pKTsKICB9Owp9CnZhciB1cmxBbHBoYWJldCA9ICJNb2R1bGVTeW1iaGFzT3duUHItMDEyMzQ1Njc4OUFCQ0RFRkdITlJWZmdjdGlVdnpfS3FZVEprTHhwWlhJalFXIjsKdmFyIG5hbm9pZCA9IChzaXplID0gMjEpID0+IHsKICBsZXQgaWQgPSAiIjsKICBsZXQgaSA9IHNpemU7CiAgd2hpbGUgKGktLSkgewogICAgaWQgKz0gdXJsQWxwaGFiZXRbTWF0aC5yYW5kb20oKSAqIDY0IHwgMF07CiAgfQogIHJldHVybiBpZDsKfTsKdmFyIGNvbW1vblByb3BlcnRpZXMgPSBbIm5hbWUiLCAibWVzc2FnZSIsICJzdGFjayIsICJjb2RlIl07CnZhciBSZWplY3RXaXRoVmFsdWUgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IocGF5bG9hZCwgbWV0YSkgewogICAgdGhpcy5wYXlsb2FkID0gcGF5bG9hZDsKICAgIHRoaXMubWV0YSA9IG1ldGE7CiAgfQogIC8qCiAgdHlwZS1vbmx5IHByb3BlcnR5IHRvIGRpc3Rpbmd1aXNoIGJldHdlZW4gUmVqZWN0V2l0aFZhbHVlIGFuZCBGdWxmaWxsV2l0aE1ldGEKICBkb2VzIG5vdCBleGlzdCBhdCBydW50aW1lCiAgKi8KICBfdHlwZTsKfTsKdmFyIEZ1bGZpbGxXaXRoTWV0YSA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihwYXlsb2FkLCBtZXRhKSB7CiAgICB0aGlzLnBheWxvYWQgPSBwYXlsb2FkOwogICAgdGhpcy5tZXRhID0gbWV0YTsKICB9CiAgLyoKICB0eXBlLW9ubHkgcHJvcGVydHkgdG8gZGlzdGluZ3Vpc2ggYmV0d2VlbiBSZWplY3RXaXRoVmFsdWUgYW5kIEZ1bGZpbGxXaXRoTWV0YQogIGRvZXMgbm90IGV4aXN0IGF0IHJ1bnRpbWUKICAqLwogIF90eXBlOwp9Owp2YXIgbWluaVNlcmlhbGl6ZUVycm9yID0gKHZhbHVlKSA9PiB7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGwpIHsKICAgIGNvbnN0IHNpbXBsZUVycm9yID0ge307CiAgICBmb3IgKGNvbnN0IHByb3BlcnR5IG9mIGNvbW1vblByb3BlcnRpZXMpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZVtwcm9wZXJ0eV0gPT09ICJzdHJpbmciKSB7CiAgICAgICAgc2ltcGxlRXJyb3JbcHJvcGVydHldID0gdmFsdWVbcHJvcGVydHldOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gc2ltcGxlRXJyb3I7CiAgfQogIHJldHVybiB7CiAgICBtZXNzYWdlOiBTdHJpbmcodmFsdWUpCiAgfTsKfTsKdmFyIGV4dGVybmFsQWJvcnRNZXNzYWdlID0gIkV4dGVybmFsIHNpZ25hbCB3YXMgYWJvcnRlZCI7CnZhciBjcmVhdGVBc3luY1RodW5rID0gLyogQF9fUFVSRV9fICovICgoKSA9PiB7CiAgZnVuY3Rpb24gY3JlYXRlQXN5bmNUaHVuazIodHlwZVByZWZpeCwgcGF5bG9hZENyZWF0b3IsIG9wdGlvbnMpIHsKICAgIGNvbnN0IGZ1bGZpbGxlZCA9IGNyZWF0ZUFjdGlvbih0eXBlUHJlZml4ICsgIi9mdWxmaWxsZWQiLCAocGF5bG9hZCwgcmVxdWVzdElkLCBhcmcsIG1ldGEpID0+ICh7CiAgICAgIHBheWxvYWQsCiAgICAgIG1ldGE6IHsKICAgICAgICAuLi5tZXRhIHx8IHt9LAogICAgICAgIGFyZywKICAgICAgICByZXF1ZXN0SWQsCiAgICAgICAgcmVxdWVzdFN0YXR1czogImZ1bGZpbGxlZCIKICAgICAgfQogICAgfSkpOwogICAgY29uc3QgcGVuZGluZyA9IGNyZWF0ZUFjdGlvbih0eXBlUHJlZml4ICsgIi9wZW5kaW5nIiwgKHJlcXVlc3RJZCwgYXJnLCBtZXRhKSA9PiAoewogICAgICBwYXlsb2FkOiB2b2lkIDAsCiAgICAgIG1ldGE6IHsKICAgICAgICAuLi5tZXRhIHx8IHt9LAogICAgICAgIGFyZywKICAgICAgICByZXF1ZXN0SWQsCiAgICAgICAgcmVxdWVzdFN0YXR1czogInBlbmRpbmciCiAgICAgIH0KICAgIH0pKTsKICAgIGNvbnN0IHJlamVjdGVkID0gY3JlYXRlQWN0aW9uKHR5cGVQcmVmaXggKyAiL3JlamVjdGVkIiwgKGVycm9yLCByZXF1ZXN0SWQsIGFyZywgcGF5bG9hZCwgbWV0YSkgPT4gKHsKICAgICAgcGF5bG9hZCwKICAgICAgZXJyb3I6IChvcHRpb25zICYmIG9wdGlvbnMuc2VyaWFsaXplRXJyb3IgfHwgbWluaVNlcmlhbGl6ZUVycm9yKShlcnJvciB8fCAiUmVqZWN0ZWQiKSwKICAgICAgbWV0YTogewogICAgICAgIC4uLm1ldGEgfHwge30sCiAgICAgICAgYXJnLAogICAgICAgIHJlcXVlc3RJZCwKICAgICAgICByZWplY3RlZFdpdGhWYWx1ZTogISFwYXlsb2FkLAogICAgICAgIHJlcXVlc3RTdGF0dXM6ICJyZWplY3RlZCIsCiAgICAgICAgYWJvcnRlZDogZXJyb3I/Lm5hbWUgPT09ICJBYm9ydEVycm9yIiwKICAgICAgICBjb25kaXRpb246IGVycm9yPy5uYW1lID09PSAiQ29uZGl0aW9uRXJyb3IiCiAgICAgIH0KICAgIH0pKTsKICAgIGZ1bmN0aW9uIGFjdGlvbkNyZWF0b3IoYXJnLCB7CiAgICAgIHNpZ25hbAogICAgfSA9IHt9KSB7CiAgICAgIHJldHVybiAoZGlzcGF0Y2gsIGdldFN0YXRlLCBleHRyYSkgPT4gewogICAgICAgIGNvbnN0IHJlcXVlc3RJZCA9IG9wdGlvbnM/LmlkR2VuZXJhdG9yID8gb3B0aW9ucy5pZEdlbmVyYXRvcihhcmcpIDogbmFub2lkKCk7CiAgICAgICAgY29uc3QgYWJvcnRDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgICAgIGxldCBhYm9ydEhhbmRsZXI7CiAgICAgICAgbGV0IGFib3J0UmVhc29uOwogICAgICAgIGZ1bmN0aW9uIGFib3J0KHJlYXNvbikgewogICAgICAgICAgYWJvcnRSZWFzb24gPSByZWFzb247CiAgICAgICAgICBhYm9ydENvbnRyb2xsZXIuYWJvcnQoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNpZ25hbCkgewogICAgICAgICAgaWYgKHNpZ25hbC5hYm9ydGVkKSB7CiAgICAgICAgICAgIGFib3J0KGV4dGVybmFsQWJvcnRNZXNzYWdlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNpZ25hbC5hZGRFdmVudExpc3RlbmVyKCJhYm9ydCIsICgpID0+IGFib3J0KGV4dGVybmFsQWJvcnRNZXNzYWdlKSwgewogICAgICAgICAgICAgIG9uY2U6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnN0IHByb21pc2UgPSBhc3luYyBmdW5jdGlvbigpIHsKICAgICAgICAgIGxldCBmaW5hbEFjdGlvbjsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGxldCBjb25kaXRpb25SZXN1bHQgPSBvcHRpb25zPy5jb25kaXRpb24/LihhcmcsIHsKICAgICAgICAgICAgICBnZXRTdGF0ZSwKICAgICAgICAgICAgICBleHRyYQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKGlzVGhlbmFibGUoY29uZGl0aW9uUmVzdWx0KSkgewogICAgICAgICAgICAgIGNvbmRpdGlvblJlc3VsdCA9IGF3YWl0IGNvbmRpdGlvblJlc3VsdDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY29uZGl0aW9uUmVzdWx0ID09PSBmYWxzZSB8fCBhYm9ydENvbnRyb2xsZXIuc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgICAgICAgICB0aHJvdyB7CiAgICAgICAgICAgICAgICBuYW1lOiAiQ29uZGl0aW9uRXJyb3IiLAogICAgICAgICAgICAgICAgbWVzc2FnZTogIkFib3J0ZWQgZHVlIHRvIGNvbmRpdGlvbiBjYWxsYmFjayByZXR1cm5pbmcgZmFsc2UuIgogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgYWJvcnRlZFByb21pc2UgPSBuZXcgUHJvbWlzZSgoXywgcmVqZWN0KSA9PiB7CiAgICAgICAgICAgICAgYWJvcnRIYW5kbGVyID0gKCkgPT4gewogICAgICAgICAgICAgICAgcmVqZWN0KHsKICAgICAgICAgICAgICAgICAgbmFtZTogIkFib3J0RXJyb3IiLAogICAgICAgICAgICAgICAgICBtZXNzYWdlOiBhYm9ydFJlYXNvbiB8fCAiQWJvcnRlZCIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgYWJvcnRDb250cm9sbGVyLnNpZ25hbC5hZGRFdmVudExpc3RlbmVyKCJhYm9ydCIsIGFib3J0SGFuZGxlcik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBkaXNwYXRjaChwZW5kaW5nKHJlcXVlc3RJZCwgYXJnLCBvcHRpb25zPy5nZXRQZW5kaW5nTWV0YT8uKHsKICAgICAgICAgICAgICByZXF1ZXN0SWQsCiAgICAgICAgICAgICAgYXJnCiAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICBnZXRTdGF0ZSwKICAgICAgICAgICAgICBleHRyYQogICAgICAgICAgICB9KSkpOwogICAgICAgICAgICBmaW5hbEFjdGlvbiA9IGF3YWl0IFByb21pc2UucmFjZShbYWJvcnRlZFByb21pc2UsIFByb21pc2UucmVzb2x2ZShwYXlsb2FkQ3JlYXRvcihhcmcsIHsKICAgICAgICAgICAgICBkaXNwYXRjaCwKICAgICAgICAgICAgICBnZXRTdGF0ZSwKICAgICAgICAgICAgICBleHRyYSwKICAgICAgICAgICAgICByZXF1ZXN0SWQsCiAgICAgICAgICAgICAgc2lnbmFsOiBhYm9ydENvbnRyb2xsZXIuc2lnbmFsLAogICAgICAgICAgICAgIGFib3J0LAogICAgICAgICAgICAgIHJlamVjdFdpdGhWYWx1ZTogKHZhbHVlLCBtZXRhKSA9PiB7CiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFJlamVjdFdpdGhWYWx1ZSh2YWx1ZSwgbWV0YSk7CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBmdWxmaWxsV2l0aFZhbHVlOiAodmFsdWUsIG1ldGEpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRnVsZmlsbFdpdGhNZXRhKHZhbHVlLCBtZXRhKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pKS50aGVuKChyZXN1bHQpID0+IHsKICAgICAgICAgICAgICBpZiAocmVzdWx0IGluc3RhbmNlb2YgUmVqZWN0V2l0aFZhbHVlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyByZXN1bHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChyZXN1bHQgaW5zdGFuY2VvZiBGdWxmaWxsV2l0aE1ldGEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmdWxmaWxsZWQocmVzdWx0LnBheWxvYWQsIHJlcXVlc3RJZCwgYXJnLCByZXN1bHQubWV0YSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBmdWxmaWxsZWQocmVzdWx0LCByZXF1ZXN0SWQsIGFyZyk7CiAgICAgICAgICAgIH0pXSk7CiAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgZmluYWxBY3Rpb24gPSBlcnIgaW5zdGFuY2VvZiBSZWplY3RXaXRoVmFsdWUgPyByZWplY3RlZChudWxsLCByZXF1ZXN0SWQsIGFyZywgZXJyLnBheWxvYWQsIGVyci5tZXRhKSA6IHJlamVjdGVkKGVyciwgcmVxdWVzdElkLCBhcmcpOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgaWYgKGFib3J0SGFuZGxlcikgewogICAgICAgICAgICAgIGFib3J0Q29udHJvbGxlci5zaWduYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBhYm9ydEhhbmRsZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBza2lwRGlzcGF0Y2ggPSBvcHRpb25zICYmICFvcHRpb25zLmRpc3BhdGNoQ29uZGl0aW9uUmVqZWN0aW9uICYmIHJlamVjdGVkLm1hdGNoKGZpbmFsQWN0aW9uKSAmJiBmaW5hbEFjdGlvbi5tZXRhLmNvbmRpdGlvbjsKICAgICAgICAgIGlmICghc2tpcERpc3BhdGNoKSB7CiAgICAgICAgICAgIGRpc3BhdGNoKGZpbmFsQWN0aW9uKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBmaW5hbEFjdGlvbjsKICAgICAgICB9KCk7CiAgICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24ocHJvbWlzZSwgewogICAgICAgICAgYWJvcnQsCiAgICAgICAgICByZXF1ZXN0SWQsCiAgICAgICAgICBhcmcsCiAgICAgICAgICB1bndyYXAoKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlLnRoZW4odW53cmFwUmVzdWx0KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfTsKICAgIH0KICAgIHJldHVybiBPYmplY3QuYXNzaWduKGFjdGlvbkNyZWF0b3IsIHsKICAgICAgcGVuZGluZywKICAgICAgcmVqZWN0ZWQsCiAgICAgIGZ1bGZpbGxlZCwKICAgICAgc2V0dGxlZDogaXNBbnlPZihyZWplY3RlZCwgZnVsZmlsbGVkKSwKICAgICAgdHlwZVByZWZpeAogICAgfSk7CiAgfQogIGNyZWF0ZUFzeW5jVGh1bmsyLndpdGhUeXBlcyA9ICgpID0+IGNyZWF0ZUFzeW5jVGh1bmsyOwogIHJldHVybiBjcmVhdGVBc3luY1RodW5rMjsKfSkoKTsKZnVuY3Rpb24gdW53cmFwUmVzdWx0KGFjdGlvbikgewogIGlmIChhY3Rpb24ubWV0YSAmJiBhY3Rpb24ubWV0YS5yZWplY3RlZFdpdGhWYWx1ZSkgewogICAgdGhyb3cgYWN0aW9uLnBheWxvYWQ7CiAgfQogIGlmIChhY3Rpb24uZXJyb3IpIHsKICAgIHRocm93IGFjdGlvbi5lcnJvcjsKICB9CiAgcmV0dXJuIGFjdGlvbi5wYXlsb2FkOwp9CmZ1bmN0aW9uIGlzVGhlbmFibGUodmFsdWUpIHsKICByZXR1cm4gdmFsdWUgIT09IG51bGwgJiYgdHlwZW9mIHZhbHVlID09PSAib2JqZWN0IiAmJiB0eXBlb2YgdmFsdWUudGhlbiA9PT0gImZ1bmN0aW9uIjsKfQp2YXIgYXN5bmNUaHVua1N5bWJvbCA9IC8qIEBfX1BVUkVfXyAqLyBTeW1ib2wuZm9yKCJydGstc2xpY2UtY3JlYXRlYXN5bmN0aHVuayIpOwp2YXIgYXN5bmNUaHVua0NyZWF0b3IgPSB7CiAgW2FzeW5jVGh1bmtTeW1ib2xdOiBjcmVhdGVBc3luY1RodW5rCn07CmZ1bmN0aW9uIGdldFR5cGUoc2xpY2UyLCBhY3Rpb25LZXkpIHsKICByZXR1cm4gYCR7c2xpY2UyfS8ke2FjdGlvbktleX1gOwp9CmZ1bmN0aW9uIGJ1aWxkQ3JlYXRlU2xpY2UoewogIGNyZWF0b3JzCn0gPSB7fSkgewogIGNvbnN0IGNBVCA9IGNyZWF0b3JzPy5hc3luY1RodW5rPy5bYXN5bmNUaHVua1N5bWJvbF07CiAgcmV0dXJuIGZ1bmN0aW9uIGNyZWF0ZVNsaWNlMihvcHRpb25zKSB7CiAgICBjb25zdCB7CiAgICAgIG5hbWUsCiAgICAgIHJlZHVjZXJQYXRoID0gbmFtZQogICAgfSA9IG9wdGlvbnM7CiAgICBpZiAoIW5hbWUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxMSkgOiAiYG5hbWVgIGlzIGEgcmVxdWlyZWQgb3B0aW9uIGZvciBjcmVhdGVTbGljZSIpOwogICAgfQogICAgaWYgKHR5cGVvZiBwcm9jZXNzICE9PSAidW5kZWZpbmVkIiAmJiB0cnVlKSB7CiAgICAgIGlmIChvcHRpb25zLmluaXRpYWxTdGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiWW91IG11c3QgcHJvdmlkZSBhbiBgaW5pdGlhbFN0YXRlYCB2YWx1ZSB0aGF0IGlzIG5vdCBgdW5kZWZpbmVkYC4gWW91IG1heSBoYXZlIG1pc3NwZWxsZWQgYGluaXRpYWxTdGF0ZWAiKTsKICAgICAgfQogICAgfQogICAgY29uc3QgcmVkdWNlcnMgPSAodHlwZW9mIG9wdGlvbnMucmVkdWNlcnMgPT09ICJmdW5jdGlvbiIgPyBvcHRpb25zLnJlZHVjZXJzKGJ1aWxkUmVkdWNlckNyZWF0b3JzKCkpIDogb3B0aW9ucy5yZWR1Y2VycykgfHwge307CiAgICBjb25zdCByZWR1Y2VyTmFtZXMgPSBPYmplY3Qua2V5cyhyZWR1Y2Vycyk7CiAgICBjb25zdCBjb250ZXh0ID0gewogICAgICBzbGljZUNhc2VSZWR1Y2Vyc0J5TmFtZToge30sCiAgICAgIHNsaWNlQ2FzZVJlZHVjZXJzQnlUeXBlOiB7fSwKICAgICAgYWN0aW9uQ3JlYXRvcnM6IHt9LAogICAgICBzbGljZU1hdGNoZXJzOiBbXQogICAgfTsKICAgIGNvbnN0IGNvbnRleHRNZXRob2RzID0gewogICAgICBhZGRDYXNlKHR5cGVPckFjdGlvbkNyZWF0b3IsIHJlZHVjZXIyKSB7CiAgICAgICAgY29uc3QgdHlwZSA9IHR5cGVvZiB0eXBlT3JBY3Rpb25DcmVhdG9yID09PSAic3RyaW5nIiA/IHR5cGVPckFjdGlvbkNyZWF0b3IgOiB0eXBlT3JBY3Rpb25DcmVhdG9yLnR5cGU7CiAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDEyKSA6ICJgY29udGV4dC5hZGRDYXNlYCBjYW5ub3QgYmUgY2FsbGVkIHdpdGggYW4gZW1wdHkgYWN0aW9uIHR5cGUiKTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGUgaW4gY29udGV4dC5zbGljZUNhc2VSZWR1Y2Vyc0J5VHlwZSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxMykgOiAiYGNvbnRleHQuYWRkQ2FzZWAgY2Fubm90IGJlIGNhbGxlZCB3aXRoIHR3byByZWR1Y2VycyBmb3IgdGhlIHNhbWUgYWN0aW9uIHR5cGU6ICIgKyB0eXBlKTsKICAgICAgICB9CiAgICAgICAgY29udGV4dC5zbGljZUNhc2VSZWR1Y2Vyc0J5VHlwZVt0eXBlXSA9IHJlZHVjZXIyOwogICAgICAgIHJldHVybiBjb250ZXh0TWV0aG9kczsKICAgICAgfSwKICAgICAgYWRkTWF0Y2hlcihtYXRjaGVyLCByZWR1Y2VyMikgewogICAgICAgIGNvbnRleHQuc2xpY2VNYXRjaGVycy5wdXNoKHsKICAgICAgICAgIG1hdGNoZXIsCiAgICAgICAgICByZWR1Y2VyOiByZWR1Y2VyMgogICAgICAgIH0pOwogICAgICAgIHJldHVybiBjb250ZXh0TWV0aG9kczsKICAgICAgfSwKICAgICAgZXhwb3NlQWN0aW9uKG5hbWUyLCBhY3Rpb25DcmVhdG9yKSB7CiAgICAgICAgY29udGV4dC5hY3Rpb25DcmVhdG9yc1tuYW1lMl0gPSBhY3Rpb25DcmVhdG9yOwogICAgICAgIHJldHVybiBjb250ZXh0TWV0aG9kczsKICAgICAgfSwKICAgICAgZXhwb3NlQ2FzZVJlZHVjZXIobmFtZTIsIHJlZHVjZXIyKSB7CiAgICAgICAgY29udGV4dC5zbGljZUNhc2VSZWR1Y2Vyc0J5TmFtZVtuYW1lMl0gPSByZWR1Y2VyMjsKICAgICAgICByZXR1cm4gY29udGV4dE1ldGhvZHM7CiAgICAgIH0KICAgIH07CiAgICByZWR1Y2VyTmFtZXMuZm9yRWFjaCgocmVkdWNlck5hbWUpID0+IHsKICAgICAgY29uc3QgcmVkdWNlckRlZmluaXRpb24gPSByZWR1Y2Vyc1tyZWR1Y2VyTmFtZV07CiAgICAgIGNvbnN0IHJlZHVjZXJEZXRhaWxzID0gewogICAgICAgIHJlZHVjZXJOYW1lLAogICAgICAgIHR5cGU6IGdldFR5cGUobmFtZSwgcmVkdWNlck5hbWUpLAogICAgICAgIGNyZWF0ZU5vdGF0aW9uOiB0eXBlb2Ygb3B0aW9ucy5yZWR1Y2VycyA9PT0gImZ1bmN0aW9uIgogICAgICB9OwogICAgICBpZiAoaXNBc3luY1RodW5rU2xpY2VSZWR1Y2VyRGVmaW5pdGlvbihyZWR1Y2VyRGVmaW5pdGlvbikpIHsKICAgICAgICBoYW5kbGVUaHVua0Nhc2VSZWR1Y2VyRGVmaW5pdGlvbihyZWR1Y2VyRGV0YWlscywgcmVkdWNlckRlZmluaXRpb24sIGNvbnRleHRNZXRob2RzLCBjQVQpOwogICAgICB9IGVsc2UgewogICAgICAgIGhhbmRsZU5vcm1hbFJlZHVjZXJEZWZpbml0aW9uKHJlZHVjZXJEZXRhaWxzLCByZWR1Y2VyRGVmaW5pdGlvbiwgY29udGV4dE1ldGhvZHMpOwogICAgICB9CiAgICB9KTsKICAgIGZ1bmN0aW9uIGJ1aWxkUmVkdWNlcigpIHsKICAgICAgaWYgKHRydWUpIHsKICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMuZXh0cmFSZWR1Y2VycyA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTQpIDogIlRoZSBvYmplY3Qgbm90YXRpb24gZm9yIGBjcmVhdGVTbGljZS5leHRyYVJlZHVjZXJzYCBoYXMgYmVlbiByZW1vdmVkLiBQbGVhc2UgdXNlIHRoZSAnYnVpbGRlciBjYWxsYmFjaycgbm90YXRpb24gaW5zdGVhZDogaHR0cHM6Ly9yZWR1eC10b29sa2l0LmpzLm9yZy9hcGkvY3JlYXRlU2xpY2UiKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgW2V4dHJhUmVkdWNlcnMgPSB7fSwgYWN0aW9uTWF0Y2hlcnMgPSBbXSwgZGVmYXVsdENhc2VSZWR1Y2VyID0gdm9pZCAwXSA9IHR5cGVvZiBvcHRpb25zLmV4dHJhUmVkdWNlcnMgPT09ICJmdW5jdGlvbiIgPyBleGVjdXRlUmVkdWNlckJ1aWxkZXJDYWxsYmFjayhvcHRpb25zLmV4dHJhUmVkdWNlcnMpIDogW29wdGlvbnMuZXh0cmFSZWR1Y2Vyc107CiAgICAgIGNvbnN0IGZpbmFsQ2FzZVJlZHVjZXJzID0gewogICAgICAgIC4uLmV4dHJhUmVkdWNlcnMsCiAgICAgICAgLi4uY29udGV4dC5zbGljZUNhc2VSZWR1Y2Vyc0J5VHlwZQogICAgICB9OwogICAgICByZXR1cm4gY3JlYXRlUmVkdWNlcihvcHRpb25zLmluaXRpYWxTdGF0ZSwgKGJ1aWxkZXIpID0+IHsKICAgICAgICBmb3IgKGxldCBrZXkgaW4gZmluYWxDYXNlUmVkdWNlcnMpIHsKICAgICAgICAgIGJ1aWxkZXIuYWRkQ2FzZShrZXksIGZpbmFsQ2FzZVJlZHVjZXJzW2tleV0pOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBzTSBvZiBjb250ZXh0LnNsaWNlTWF0Y2hlcnMpIHsKICAgICAgICAgIGJ1aWxkZXIuYWRkTWF0Y2hlcihzTS5tYXRjaGVyLCBzTS5yZWR1Y2VyKTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgbSBvZiBhY3Rpb25NYXRjaGVycykgewogICAgICAgICAgYnVpbGRlci5hZGRNYXRjaGVyKG0ubWF0Y2hlciwgbS5yZWR1Y2VyKTsKICAgICAgICB9CiAgICAgICAgaWYgKGRlZmF1bHRDYXNlUmVkdWNlcikgewogICAgICAgICAgYnVpbGRlci5hZGREZWZhdWx0Q2FzZShkZWZhdWx0Q2FzZVJlZHVjZXIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgICBjb25zdCBzZWxlY3RTZWxmID0gKHN0YXRlKSA9PiBzdGF0ZTsKICAgIGNvbnN0IGluamVjdGVkU2VsZWN0b3JDYWNoZSA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICBjb25zdCBpbmplY3RlZFN0YXRlQ2FjaGUgPSAvKiBAX19QVVJFX18gKi8gbmV3IFdlYWtNYXAoKTsKICAgIGxldCBfcmVkdWNlcjsKICAgIGZ1bmN0aW9uIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICBpZiAoIV9yZWR1Y2VyKSBfcmVkdWNlciA9IGJ1aWxkUmVkdWNlcigpOwogICAgICByZXR1cm4gX3JlZHVjZXIoc3RhdGUsIGFjdGlvbik7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRJbml0aWFsU3RhdGUoKSB7CiAgICAgIGlmICghX3JlZHVjZXIpIF9yZWR1Y2VyID0gYnVpbGRSZWR1Y2VyKCk7CiAgICAgIHJldHVybiBfcmVkdWNlci5nZXRJbml0aWFsU3RhdGUoKTsKICAgIH0KICAgIGZ1bmN0aW9uIG1ha2VTZWxlY3RvclByb3BzKHJlZHVjZXJQYXRoMiwgaW5qZWN0ZWQgPSBmYWxzZSkgewogICAgICBmdW5jdGlvbiBzZWxlY3RTbGljZShzdGF0ZSkgewogICAgICAgIGxldCBzbGljZVN0YXRlID0gc3RhdGVbcmVkdWNlclBhdGgyXTsKICAgICAgICBpZiAodHlwZW9mIHNsaWNlU3RhdGUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICBpZiAoaW5qZWN0ZWQpIHsKICAgICAgICAgICAgc2xpY2VTdGF0ZSA9IGdldE9ySW5zZXJ0Q29tcHV0ZWQoaW5qZWN0ZWRTdGF0ZUNhY2hlLCBzZWxlY3RTbGljZSwgZ2V0SW5pdGlhbFN0YXRlKTsKICAgICAgICAgIH0gZWxzZSBpZiAodHJ1ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDE1KSA6ICJzZWxlY3RTbGljZSByZXR1cm5lZCB1bmRlZmluZWQgZm9yIGFuIHVuaW5qZWN0ZWQgc2xpY2UgcmVkdWNlciIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gc2xpY2VTdGF0ZTsKICAgICAgfQogICAgICBmdW5jdGlvbiBnZXRTZWxlY3RvcnMoc2VsZWN0U3RhdGUgPSBzZWxlY3RTZWxmKSB7CiAgICAgICAgY29uc3Qgc2VsZWN0b3JDYWNoZSA9IGdldE9ySW5zZXJ0Q29tcHV0ZWQoaW5qZWN0ZWRTZWxlY3RvckNhY2hlLCBpbmplY3RlZCwgKCkgPT4gLyogQF9fUFVSRV9fICovIG5ldyBXZWFrTWFwKCkpOwogICAgICAgIHJldHVybiBnZXRPckluc2VydENvbXB1dGVkKHNlbGVjdG9yQ2FjaGUsIHNlbGVjdFN0YXRlLCAoKSA9PiB7CiAgICAgICAgICBjb25zdCBtYXAzID0ge307CiAgICAgICAgICBmb3IgKGNvbnN0IFtuYW1lMiwgc2VsZWN0b3JdIG9mIE9iamVjdC5lbnRyaWVzKG9wdGlvbnMuc2VsZWN0b3JzID8/IHt9KSkgewogICAgICAgICAgICBtYXAzW25hbWUyXSA9IHdyYXBTZWxlY3RvcihzZWxlY3Rvciwgc2VsZWN0U3RhdGUsICgpID0+IGdldE9ySW5zZXJ0Q29tcHV0ZWQoaW5qZWN0ZWRTdGF0ZUNhY2hlLCBzZWxlY3RTdGF0ZSwgZ2V0SW5pdGlhbFN0YXRlKSwgaW5qZWN0ZWQpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hcDM7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICByZWR1Y2VyUGF0aDogcmVkdWNlclBhdGgyLAogICAgICAgIGdldFNlbGVjdG9ycywKICAgICAgICBnZXQgc2VsZWN0b3JzKCkgewogICAgICAgICAgcmV0dXJuIGdldFNlbGVjdG9ycyhzZWxlY3RTbGljZSk7CiAgICAgICAgfSwKICAgICAgICBzZWxlY3RTbGljZQogICAgICB9OwogICAgfQogICAgY29uc3Qgc2xpY2UyID0gewogICAgICBuYW1lLAogICAgICByZWR1Y2VyLAogICAgICBhY3Rpb25zOiBjb250ZXh0LmFjdGlvbkNyZWF0b3JzLAogICAgICBjYXNlUmVkdWNlcnM6IGNvbnRleHQuc2xpY2VDYXNlUmVkdWNlcnNCeU5hbWUsCiAgICAgIGdldEluaXRpYWxTdGF0ZSwKICAgICAgLi4ubWFrZVNlbGVjdG9yUHJvcHMocmVkdWNlclBhdGgpLAogICAgICBpbmplY3RJbnRvKGluamVjdGFibGUsIHsKICAgICAgICByZWR1Y2VyUGF0aDogcGF0aE9wdCwKICAgICAgICAuLi5jb25maWcKICAgICAgfSA9IHt9KSB7CiAgICAgICAgY29uc3QgbmV3UmVkdWNlclBhdGggPSBwYXRoT3B0ID8/IHJlZHVjZXJQYXRoOwogICAgICAgIGluamVjdGFibGUuaW5qZWN0KHsKICAgICAgICAgIHJlZHVjZXJQYXRoOiBuZXdSZWR1Y2VyUGF0aCwKICAgICAgICAgIHJlZHVjZXIKICAgICAgICB9LCBjb25maWcpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAuLi5zbGljZTIsCiAgICAgICAgICAuLi5tYWtlU2VsZWN0b3JQcm9wcyhuZXdSZWR1Y2VyUGF0aCwgdHJ1ZSkKICAgICAgICB9OwogICAgICB9CiAgICB9OwogICAgcmV0dXJuIHNsaWNlMjsKICB9Owp9CmZ1bmN0aW9uIHdyYXBTZWxlY3RvcihzZWxlY3Rvciwgc2VsZWN0U3RhdGUsIGdldEluaXRpYWxTdGF0ZSwgaW5qZWN0ZWQpIHsKICBmdW5jdGlvbiB3cmFwcGVyKHJvb3RTdGF0ZSwgLi4uYXJncykgewogICAgbGV0IHNsaWNlU3RhdGUgPSBzZWxlY3RTdGF0ZShyb290U3RhdGUpOwogICAgaWYgKHR5cGVvZiBzbGljZVN0YXRlID09PSAidW5kZWZpbmVkIikgewogICAgICBpZiAoaW5qZWN0ZWQpIHsKICAgICAgICBzbGljZVN0YXRlID0gZ2V0SW5pdGlhbFN0YXRlKCk7CiAgICAgIH0gZWxzZSBpZiAodHJ1ZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTYpIDogInNlbGVjdFN0YXRlIHJldHVybmVkIHVuZGVmaW5lZCBmb3IgYW4gdW5pbmplY3RlZCBzbGljZSByZWR1Y2VyIik7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBzZWxlY3RvcihzbGljZVN0YXRlLCAuLi5hcmdzKTsKICB9CiAgd3JhcHBlci51bndyYXBwZWQgPSBzZWxlY3RvcjsKICByZXR1cm4gd3JhcHBlcjsKfQp2YXIgY3JlYXRlU2xpY2UgPSAvKiBAX19QVVJFX18gKi8gYnVpbGRDcmVhdGVTbGljZSgpOwpmdW5jdGlvbiBidWlsZFJlZHVjZXJDcmVhdG9ycygpIHsKICBmdW5jdGlvbiBhc3luY1RodW5rKHBheWxvYWRDcmVhdG9yLCBjb25maWcpIHsKICAgIHJldHVybiB7CiAgICAgIF9yZWR1Y2VyRGVmaW5pdGlvblR5cGU6ICJhc3luY1RodW5rIiwKICAgICAgcGF5bG9hZENyZWF0b3IsCiAgICAgIC4uLmNvbmZpZwogICAgfTsKICB9CiAgYXN5bmNUaHVuay53aXRoVHlwZXMgPSAoKSA9PiBhc3luY1RodW5rOwogIHJldHVybiB7CiAgICByZWR1Y2VyKGNhc2VSZWR1Y2VyKSB7CiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHsKICAgICAgICAvLyBoYWNrIHNvIHRoZSB3cmFwcGluZyBmdW5jdGlvbiBoYXMgdGhlIHNhbWUgbmFtZSBhcyB0aGUgb3JpZ2luYWwKICAgICAgICAvLyB3ZSBuZWVkIHRvIGNyZWF0ZSBhIHdyYXBwZXIgc28gdGhlIGByZWR1Y2VyRGVmaW5pdGlvblR5cGVgIGlzIG5vdCBhc3NpZ25lZCB0byB0aGUgb3JpZ2luYWwKICAgICAgICBbY2FzZVJlZHVjZXIubmFtZV0oLi4uYXJncykgewogICAgICAgICAgcmV0dXJuIGNhc2VSZWR1Y2VyKC4uLmFyZ3MpOwogICAgICAgIH0KICAgICAgfVtjYXNlUmVkdWNlci5uYW1lXSwgewogICAgICAgIF9yZWR1Y2VyRGVmaW5pdGlvblR5cGU6ICJyZWR1Y2VyIgogICAgICAgIC8qIHJlZHVjZXIgKi8KICAgICAgfSk7CiAgICB9LAogICAgcHJlcGFyZWRSZWR1Y2VyKHByZXBhcmUsIHJlZHVjZXIpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBfcmVkdWNlckRlZmluaXRpb25UeXBlOiAicmVkdWNlcldpdGhQcmVwYXJlIiwKICAgICAgICBwcmVwYXJlLAogICAgICAgIHJlZHVjZXIKICAgICAgfTsKICAgIH0sCiAgICBhc3luY1RodW5rCiAgfTsKfQpmdW5jdGlvbiBoYW5kbGVOb3JtYWxSZWR1Y2VyRGVmaW5pdGlvbih7CiAgdHlwZSwKICByZWR1Y2VyTmFtZSwKICBjcmVhdGVOb3RhdGlvbgp9LCBtYXliZVJlZHVjZXJXaXRoUHJlcGFyZSwgY29udGV4dCkgewogIGxldCBjYXNlUmVkdWNlcjsKICBsZXQgcHJlcGFyZUNhbGxiYWNrOwogIGlmICgicmVkdWNlciIgaW4gbWF5YmVSZWR1Y2VyV2l0aFByZXBhcmUpIHsKICAgIGlmIChjcmVhdGVOb3RhdGlvbiAmJiAhaXNDYXNlUmVkdWNlcldpdGhQcmVwYXJlRGVmaW5pdGlvbihtYXliZVJlZHVjZXJXaXRoUHJlcGFyZSkpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGZhbHNlID8gZm9ybWF0UHJvZEVycm9yTWVzc2FnZSgxNykgOiAiUGxlYXNlIHVzZSB0aGUgYGNyZWF0ZS5wcmVwYXJlZFJlZHVjZXJgIG5vdGF0aW9uIGZvciBwcmVwYXJlZCBhY3Rpb24gY3JlYXRvcnMgd2l0aCB0aGUgYGNyZWF0ZWAgbm90YXRpb24uIik7CiAgICB9CiAgICBjYXNlUmVkdWNlciA9IG1heWJlUmVkdWNlcldpdGhQcmVwYXJlLnJlZHVjZXI7CiAgICBwcmVwYXJlQ2FsbGJhY2sgPSBtYXliZVJlZHVjZXJXaXRoUHJlcGFyZS5wcmVwYXJlOwogIH0gZWxzZSB7CiAgICBjYXNlUmVkdWNlciA9IG1heWJlUmVkdWNlcldpdGhQcmVwYXJlOwogIH0KICBjb250ZXh0LmFkZENhc2UodHlwZSwgY2FzZVJlZHVjZXIpLmV4cG9zZUNhc2VSZWR1Y2VyKHJlZHVjZXJOYW1lLCBjYXNlUmVkdWNlcikuZXhwb3NlQWN0aW9uKHJlZHVjZXJOYW1lLCBwcmVwYXJlQ2FsbGJhY2sgPyBjcmVhdGVBY3Rpb24odHlwZSwgcHJlcGFyZUNhbGxiYWNrKSA6IGNyZWF0ZUFjdGlvbih0eXBlKSk7Cn0KZnVuY3Rpb24gaXNBc3luY1RodW5rU2xpY2VSZWR1Y2VyRGVmaW5pdGlvbihyZWR1Y2VyRGVmaW5pdGlvbikgewogIHJldHVybiByZWR1Y2VyRGVmaW5pdGlvbi5fcmVkdWNlckRlZmluaXRpb25UeXBlID09PSAiYXN5bmNUaHVuayI7Cn0KZnVuY3Rpb24gaXNDYXNlUmVkdWNlcldpdGhQcmVwYXJlRGVmaW5pdGlvbihyZWR1Y2VyRGVmaW5pdGlvbikgewogIHJldHVybiByZWR1Y2VyRGVmaW5pdGlvbi5fcmVkdWNlckRlZmluaXRpb25UeXBlID09PSAicmVkdWNlcldpdGhQcmVwYXJlIjsKfQpmdW5jdGlvbiBoYW5kbGVUaHVua0Nhc2VSZWR1Y2VyRGVmaW5pdGlvbih7CiAgdHlwZSwKICByZWR1Y2VyTmFtZQp9LCByZWR1Y2VyRGVmaW5pdGlvbiwgY29udGV4dCwgY0FUKSB7CiAgaWYgKCFjQVQpIHsKICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMTgpIDogIkNhbm5vdCB1c2UgYGNyZWF0ZS5hc3luY1RodW5rYCBpbiB0aGUgYnVpbHQtaW4gYGNyZWF0ZVNsaWNlYC4gVXNlIGBidWlsZENyZWF0ZVNsaWNlKHsgY3JlYXRvcnM6IHsgYXN5bmNUaHVuazogYXN5bmNUaHVua0NyZWF0b3IgfSB9KWAgdG8gY3JlYXRlIGEgY3VzdG9taXNlZCB2ZXJzaW9uIG9mIGBjcmVhdGVTbGljZWAuIik7CiAgfQogIGNvbnN0IHsKICAgIHBheWxvYWRDcmVhdG9yLAogICAgZnVsZmlsbGVkLAogICAgcGVuZGluZywKICAgIHJlamVjdGVkLAogICAgc2V0dGxlZCwKICAgIG9wdGlvbnMKICB9ID0gcmVkdWNlckRlZmluaXRpb247CiAgY29uc3QgdGh1bmsyID0gY0FUKHR5cGUsIHBheWxvYWRDcmVhdG9yLCBvcHRpb25zKTsKICBjb250ZXh0LmV4cG9zZUFjdGlvbihyZWR1Y2VyTmFtZSwgdGh1bmsyKTsKICBpZiAoZnVsZmlsbGVkKSB7CiAgICBjb250ZXh0LmFkZENhc2UodGh1bmsyLmZ1bGZpbGxlZCwgZnVsZmlsbGVkKTsKICB9CiAgaWYgKHBlbmRpbmcpIHsKICAgIGNvbnRleHQuYWRkQ2FzZSh0aHVuazIucGVuZGluZywgcGVuZGluZyk7CiAgfQogIGlmIChyZWplY3RlZCkgewogICAgY29udGV4dC5hZGRDYXNlKHRodW5rMi5yZWplY3RlZCwgcmVqZWN0ZWQpOwogIH0KICBpZiAoc2V0dGxlZCkgewogICAgY29udGV4dC5hZGRNYXRjaGVyKHRodW5rMi5zZXR0bGVkLCBzZXR0bGVkKTsKICB9CiAgY29udGV4dC5leHBvc2VDYXNlUmVkdWNlcihyZWR1Y2VyTmFtZSwgewogICAgZnVsZmlsbGVkOiBmdWxmaWxsZWQgfHwgbm9vcDMsCiAgICBwZW5kaW5nOiBwZW5kaW5nIHx8IG5vb3AzLAogICAgcmVqZWN0ZWQ6IHJlamVjdGVkIHx8IG5vb3AzLAogICAgc2V0dGxlZDogc2V0dGxlZCB8fCBub29wMwogIH0pOwp9CmZ1bmN0aW9uIG5vb3AzKCkgewp9CnZhciB0YXNrID0gInRhc2siOwp2YXIgbGlzdGVuZXIgPSAibGlzdGVuZXIiOwp2YXIgY29tcGxldGVkID0gImNvbXBsZXRlZCI7CnZhciBjYW5jZWxsZWQgPSAiY2FuY2VsbGVkIjsKdmFyIHRhc2tDYW5jZWxsZWQgPSBgdGFzay0ke2NhbmNlbGxlZH1gOwp2YXIgdGFza0NvbXBsZXRlZCA9IGB0YXNrLSR7Y29tcGxldGVkfWA7CnZhciBsaXN0ZW5lckNhbmNlbGxlZCA9IGAke2xpc3RlbmVyfS0ke2NhbmNlbGxlZH1gOwp2YXIgbGlzdGVuZXJDb21wbGV0ZWQgPSBgJHtsaXN0ZW5lcn0tJHtjb21wbGV0ZWR9YDsKdmFyIFRhc2tBYm9ydEVycm9yID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGNvZGUpIHsKICAgIHRoaXMuY29kZSA9IGNvZGU7CiAgICB0aGlzLm1lc3NhZ2UgPSBgJHt0YXNrfSAke2NhbmNlbGxlZH0gKHJlYXNvbjogJHtjb2RlfSlgOwogIH0KICBuYW1lID0gIlRhc2tBYm9ydEVycm9yIjsKICBtZXNzYWdlOwp9Owp2YXIgYXNzZXJ0RnVuY3Rpb24gPSAoZnVuYywgZXhwZWN0ZWQpID0+IHsKICBpZiAodHlwZW9mIGZ1bmMgIT09ICJmdW5jdGlvbiIpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDMyKSA6IGAke2V4cGVjdGVkfSBpcyBub3QgYSBmdW5jdGlvbmApOwogIH0KfTsKdmFyIG5vb3AyMiA9ICgpID0+IHsKfTsKdmFyIGNhdGNoUmVqZWN0aW9uID0gKHByb21pc2UsIG9uRXJyb3IgPSBub29wMjIpID0+IHsKICBwcm9taXNlLmNhdGNoKG9uRXJyb3IpOwogIHJldHVybiBwcm9taXNlOwp9Owp2YXIgYWRkQWJvcnRTaWduYWxMaXN0ZW5lciA9IChhYm9ydFNpZ25hbCwgY2FsbGJhY2spID0+IHsKICBhYm9ydFNpZ25hbC5hZGRFdmVudExpc3RlbmVyKCJhYm9ydCIsIGNhbGxiYWNrLCB7CiAgICBvbmNlOiB0cnVlCiAgfSk7CiAgcmV0dXJuICgpID0+IGFib3J0U2lnbmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoImFib3J0IiwgY2FsbGJhY2spOwp9Owp2YXIgYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbiA9IChhYm9ydENvbnRyb2xsZXIsIHJlYXNvbikgPT4gewogIGNvbnN0IHNpZ25hbCA9IGFib3J0Q29udHJvbGxlci5zaWduYWw7CiAgaWYgKHNpZ25hbC5hYm9ydGVkKSB7CiAgICByZXR1cm47CiAgfQogIGlmICghKCJyZWFzb24iIGluIHNpZ25hbCkpIHsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShzaWduYWwsICJyZWFzb24iLCB7CiAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgIHZhbHVlOiByZWFzb24sCiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgd3JpdGFibGU6IHRydWUKICAgIH0pOwogIH0KICA7CiAgYWJvcnRDb250cm9sbGVyLmFib3J0KHJlYXNvbik7Cn07CnZhciB2YWxpZGF0ZUFjdGl2ZSA9IChzaWduYWwpID0+IHsKICBpZiAoc2lnbmFsLmFib3J0ZWQpIHsKICAgIGNvbnN0IHsKICAgICAgcmVhc29uCiAgICB9ID0gc2lnbmFsOwogICAgdGhyb3cgbmV3IFRhc2tBYm9ydEVycm9yKHJlYXNvbik7CiAgfQp9OwpmdW5jdGlvbiByYWNlV2l0aFNpZ25hbChzaWduYWwsIHByb21pc2UpIHsKICBsZXQgY2xlYW51cCA9IG5vb3AyMjsKICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgY29uc3Qgbm90aWZ5UmVqZWN0aW9uID0gKCkgPT4gcmVqZWN0KG5ldyBUYXNrQWJvcnRFcnJvcihzaWduYWwucmVhc29uKSk7CiAgICBpZiAoc2lnbmFsLmFib3J0ZWQpIHsKICAgICAgbm90aWZ5UmVqZWN0aW9uKCk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGNsZWFudXAgPSBhZGRBYm9ydFNpZ25hbExpc3RlbmVyKHNpZ25hbCwgbm90aWZ5UmVqZWN0aW9uKTsKICAgIHByb21pc2UuZmluYWxseSgoKSA9PiBjbGVhbnVwKCkpLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTsKICB9KS5maW5hbGx5KCgpID0+IHsKICAgIGNsZWFudXAgPSBub29wMjI7CiAgfSk7Cn0KdmFyIHJ1blRhc2sgPSBhc3luYyAodGFzazIsIGNsZWFuVXApID0+IHsKICB0cnkgewogICAgYXdhaXQgUHJvbWlzZS5yZXNvbHZlKCk7CiAgICBjb25zdCB2YWx1ZSA9IGF3YWl0IHRhc2syKCk7CiAgICByZXR1cm4gewogICAgICBzdGF0dXM6ICJvayIsCiAgICAgIHZhbHVlCiAgICB9OwogIH0gY2F0Y2ggKGVycm9yKSB7CiAgICByZXR1cm4gewogICAgICBzdGF0dXM6IGVycm9yIGluc3RhbmNlb2YgVGFza0Fib3J0RXJyb3IgPyAiY2FuY2VsbGVkIiA6ICJyZWplY3RlZCIsCiAgICAgIGVycm9yCiAgICB9OwogIH0gZmluYWxseSB7CiAgICBjbGVhblVwPy4oKTsKICB9Cn07CnZhciBjcmVhdGVQYXVzZSA9IChzaWduYWwpID0+IHsKICByZXR1cm4gKHByb21pc2UpID0+IHsKICAgIHJldHVybiBjYXRjaFJlamVjdGlvbihyYWNlV2l0aFNpZ25hbChzaWduYWwsIHByb21pc2UpLnRoZW4oKG91dHB1dCkgPT4gewogICAgICB2YWxpZGF0ZUFjdGl2ZShzaWduYWwpOwogICAgICByZXR1cm4gb3V0cHV0OwogICAgfSkpOwogIH07Cn07CnZhciBjcmVhdGVEZWxheSA9IChzaWduYWwpID0+IHsKICBjb25zdCBwYXVzZSA9IGNyZWF0ZVBhdXNlKHNpZ25hbCk7CiAgcmV0dXJuICh0aW1lb3V0TXMpID0+IHsKICAgIHJldHVybiBwYXVzZShuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCB0aW1lb3V0TXMpKSk7CiAgfTsKfTsKdmFyIHsKICBhc3NpZ24KfSA9IE9iamVjdDsKdmFyIElOVEVSTkFMX05JTF9UT0tFTiA9IHt9Owp2YXIgYWxtID0gImxpc3RlbmVyTWlkZGxld2FyZSI7CnZhciBjcmVhdGVGb3JrID0gKHBhcmVudEFib3J0U2lnbmFsLCBwYXJlbnRCbG9ja2luZ1Byb21pc2VzKSA9PiB7CiAgY29uc3QgbGlua0NvbnRyb2xsZXJzID0gKGNvbnRyb2xsZXIpID0+IGFkZEFib3J0U2lnbmFsTGlzdGVuZXIocGFyZW50QWJvcnRTaWduYWwsICgpID0+IGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24oY29udHJvbGxlciwgcGFyZW50QWJvcnRTaWduYWwucmVhc29uKSk7CiAgcmV0dXJuICh0YXNrRXhlY3V0b3IsIG9wdHMpID0+IHsKICAgIGFzc2VydEZ1bmN0aW9uKHRhc2tFeGVjdXRvciwgInRhc2tFeGVjdXRvciIpOwogICAgY29uc3QgY2hpbGRBYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICBsaW5rQ29udHJvbGxlcnMoY2hpbGRBYm9ydENvbnRyb2xsZXIpOwogICAgY29uc3QgcmVzdWx0ID0gcnVuVGFzayhhc3luYyAoKSA9PiB7CiAgICAgIHZhbGlkYXRlQWN0aXZlKHBhcmVudEFib3J0U2lnbmFsKTsKICAgICAgdmFsaWRhdGVBY3RpdmUoY2hpbGRBYm9ydENvbnRyb2xsZXIuc2lnbmFsKTsKICAgICAgY29uc3QgcmVzdWx0MiA9IGF3YWl0IHRhc2tFeGVjdXRvcih7CiAgICAgICAgcGF1c2U6IGNyZWF0ZVBhdXNlKGNoaWxkQWJvcnRDb250cm9sbGVyLnNpZ25hbCksCiAgICAgICAgZGVsYXk6IGNyZWF0ZURlbGF5KGNoaWxkQWJvcnRDb250cm9sbGVyLnNpZ25hbCksCiAgICAgICAgc2lnbmFsOiBjaGlsZEFib3J0Q29udHJvbGxlci5zaWduYWwKICAgICAgfSk7CiAgICAgIHZhbGlkYXRlQWN0aXZlKGNoaWxkQWJvcnRDb250cm9sbGVyLnNpZ25hbCk7CiAgICAgIHJldHVybiByZXN1bHQyOwogICAgfSwgKCkgPT4gYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihjaGlsZEFib3J0Q29udHJvbGxlciwgdGFza0NvbXBsZXRlZCkpOwogICAgaWYgKG9wdHM/LmF1dG9Kb2luKSB7CiAgICAgIHBhcmVudEJsb2NraW5nUHJvbWlzZXMucHVzaChyZXN1bHQuY2F0Y2gobm9vcDIyKSk7CiAgICB9CiAgICByZXR1cm4gewogICAgICByZXN1bHQ6IGNyZWF0ZVBhdXNlKHBhcmVudEFib3J0U2lnbmFsKShyZXN1bHQpLAogICAgICBjYW5jZWwoKSB7CiAgICAgICAgYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihjaGlsZEFib3J0Q29udHJvbGxlciwgdGFza0NhbmNlbGxlZCk7CiAgICAgIH0KICAgIH07CiAgfTsKfTsKdmFyIGNyZWF0ZVRha2VQYXR0ZXJuID0gKHN0YXJ0TGlzdGVuaW5nLCBzaWduYWwpID0+IHsKICBjb25zdCB0YWtlID0gYXN5bmMgKHByZWRpY2F0ZSwgdGltZW91dCkgPT4gewogICAgdmFsaWRhdGVBY3RpdmUoc2lnbmFsKTsKICAgIGxldCB1bnN1YnNjcmliZSA9ICgpID0+IHsKICAgIH07CiAgICBjb25zdCB0dXBsZVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGxldCBzdG9wTGlzdGVuaW5nID0gc3RhcnRMaXN0ZW5pbmcoewogICAgICAgIHByZWRpY2F0ZSwKICAgICAgICBlZmZlY3Q6IChhY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICAgICAgICBsaXN0ZW5lckFwaS51bnN1YnNjcmliZSgpOwogICAgICAgICAgcmVzb2x2ZShbYWN0aW9uLCBsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpLCBsaXN0ZW5lckFwaS5nZXRPcmlnaW5hbFN0YXRlKCldKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICB1bnN1YnNjcmliZSA9ICgpID0+IHsKICAgICAgICBzdG9wTGlzdGVuaW5nKCk7CiAgICAgICAgcmVqZWN0KCk7CiAgICAgIH07CiAgICB9KTsKICAgIGNvbnN0IHByb21pc2VzID0gW3R1cGxlUHJvbWlzZV07CiAgICBpZiAodGltZW91dCAhPSBudWxsKSB7CiAgICAgIHByb21pc2VzLnB1c2gobmV3IFByb21pc2UoKHJlc29sdmUpID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgdGltZW91dCwgbnVsbCkpKTsKICAgIH0KICAgIHRyeSB7CiAgICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHJhY2VXaXRoU2lnbmFsKHNpZ25hbCwgUHJvbWlzZS5yYWNlKHByb21pc2VzKSk7CiAgICAgIHZhbGlkYXRlQWN0aXZlKHNpZ25hbCk7CiAgICAgIHJldHVybiBvdXRwdXQ7CiAgICB9IGZpbmFsbHkgewogICAgICB1bnN1YnNjcmliZSgpOwogICAgfQogIH07CiAgcmV0dXJuIChwcmVkaWNhdGUsIHRpbWVvdXQpID0+IGNhdGNoUmVqZWN0aW9uKHRha2UocHJlZGljYXRlLCB0aW1lb3V0KSk7Cn07CnZhciBnZXRMaXN0ZW5lckVudHJ5UHJvcHNGcm9tID0gKG9wdGlvbnMpID0+IHsKICBsZXQgewogICAgdHlwZSwKICAgIGFjdGlvbkNyZWF0b3IsCiAgICBtYXRjaGVyLAogICAgcHJlZGljYXRlLAogICAgZWZmZWN0CiAgfSA9IG9wdGlvbnM7CiAgaWYgKHR5cGUpIHsKICAgIHByZWRpY2F0ZSA9IGNyZWF0ZUFjdGlvbih0eXBlKS5tYXRjaDsKICB9IGVsc2UgaWYgKGFjdGlvbkNyZWF0b3IpIHsKICAgIHR5cGUgPSBhY3Rpb25DcmVhdG9yLnR5cGU7CiAgICBwcmVkaWNhdGUgPSBhY3Rpb25DcmVhdG9yLm1hdGNoOwogIH0gZWxzZSBpZiAobWF0Y2hlcikgewogICAgcHJlZGljYXRlID0gbWF0Y2hlcjsKICB9IGVsc2UgaWYgKHByZWRpY2F0ZSkgewogIH0gZWxzZSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDIxKSA6ICJDcmVhdGluZyBvciByZW1vdmluZyBhIGxpc3RlbmVyIHJlcXVpcmVzIG9uZSBvZiB0aGUga25vd24gZmllbGRzIGZvciBtYXRjaGluZyBhbiBhY3Rpb24iKTsKICB9CiAgYXNzZXJ0RnVuY3Rpb24oZWZmZWN0LCAib3B0aW9ucy5saXN0ZW5lciIpOwogIHJldHVybiB7CiAgICBwcmVkaWNhdGUsCiAgICB0eXBlLAogICAgZWZmZWN0CiAgfTsKfTsKdmFyIGNyZWF0ZUxpc3RlbmVyRW50cnkgPSAvKiBAX19QVVJFX18gKi8gYXNzaWduKChvcHRpb25zKSA9PiB7CiAgY29uc3QgewogICAgdHlwZSwKICAgIHByZWRpY2F0ZSwKICAgIGVmZmVjdAogIH0gPSBnZXRMaXN0ZW5lckVudHJ5UHJvcHNGcm9tKG9wdGlvbnMpOwogIGNvbnN0IGVudHJ5ID0gewogICAgaWQ6IG5hbm9pZCgpLAogICAgZWZmZWN0LAogICAgdHlwZSwKICAgIHByZWRpY2F0ZSwKICAgIHBlbmRpbmc6IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KCksCiAgICB1bnN1YnNjcmliZTogKCkgPT4gewogICAgICB0aHJvdyBuZXcgRXJyb3IoZmFsc2UgPyBmb3JtYXRQcm9kRXJyb3JNZXNzYWdlKDIyKSA6ICJVbnN1YnNjcmliZSBub3QgaW5pdGlhbGl6ZWQiKTsKICAgIH0KICB9OwogIHJldHVybiBlbnRyeTsKfSwgewogIHdpdGhUeXBlczogKCkgPT4gY3JlYXRlTGlzdGVuZXJFbnRyeQp9KTsKdmFyIGZpbmRMaXN0ZW5lckVudHJ5ID0gKGxpc3RlbmVyTWFwLCBvcHRpb25zKSA9PiB7CiAgY29uc3QgewogICAgdHlwZSwKICAgIGVmZmVjdCwKICAgIHByZWRpY2F0ZQogIH0gPSBnZXRMaXN0ZW5lckVudHJ5UHJvcHNGcm9tKG9wdGlvbnMpOwogIHJldHVybiBBcnJheS5mcm9tKGxpc3RlbmVyTWFwLnZhbHVlcygpKS5maW5kKChlbnRyeSkgPT4gewogICAgY29uc3QgbWF0Y2hQcmVkaWNhdGVPclR5cGUgPSB0eXBlb2YgdHlwZSA9PT0gInN0cmluZyIgPyBlbnRyeS50eXBlID09PSB0eXBlIDogZW50cnkucHJlZGljYXRlID09PSBwcmVkaWNhdGU7CiAgICByZXR1cm4gbWF0Y2hQcmVkaWNhdGVPclR5cGUgJiYgZW50cnkuZWZmZWN0ID09PSBlZmZlY3Q7CiAgfSk7Cn07CnZhciBjYW5jZWxBY3RpdmVMaXN0ZW5lcnMgPSAoZW50cnkpID0+IHsKICBlbnRyeS5wZW5kaW5nLmZvckVhY2goKGNvbnRyb2xsZXIpID0+IHsKICAgIGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24oY29udHJvbGxlciwgbGlzdGVuZXJDYW5jZWxsZWQpOwogIH0pOwp9Owp2YXIgY3JlYXRlQ2xlYXJMaXN0ZW5lck1pZGRsZXdhcmUgPSAobGlzdGVuZXJNYXAsIGV4ZWN1dGluZ0xpc3RlbmVycykgPT4gewogIHJldHVybiAoKSA9PiB7CiAgICBmb3IgKGNvbnN0IGxpc3RlbmVyMiBvZiBleGVjdXRpbmdMaXN0ZW5lcnMua2V5cygpKSB7CiAgICAgIGNhbmNlbEFjdGl2ZUxpc3RlbmVycyhsaXN0ZW5lcjIpOwogICAgfQogICAgbGlzdGVuZXJNYXAuY2xlYXIoKTsKICB9Owp9Owp2YXIgc2FmZWx5Tm90aWZ5RXJyb3IgPSAoZXJyb3JIYW5kbGVyLCBlcnJvclRvTm90aWZ5LCBlcnJvckluZm8pID0+IHsKICB0cnkgewogICAgZXJyb3JIYW5kbGVyKGVycm9yVG9Ob3RpZnksIGVycm9ySW5mbyk7CiAgfSBjYXRjaCAoZXJyb3JIYW5kbGVyRXJyb3IpIHsKICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICB0aHJvdyBlcnJvckhhbmRsZXJFcnJvcjsKICAgIH0sIDApOwogIH0KfTsKdmFyIGFkZExpc3RlbmVyID0gLyogQF9fUFVSRV9fICovIGFzc2lnbigvKiBAX19QVVJFX18gKi8gY3JlYXRlQWN0aW9uKGAke2FsbX0vYWRkYCksIHsKICB3aXRoVHlwZXM6ICgpID0+IGFkZExpc3RlbmVyCn0pOwp2YXIgY2xlYXJBbGxMaXN0ZW5lcnMgPSAvKiBAX19QVVJFX18gKi8gY3JlYXRlQWN0aW9uKGAke2FsbX0vcmVtb3ZlQWxsYCk7CnZhciByZW1vdmVMaXN0ZW5lciA9IC8qIEBfX1BVUkVfXyAqLyBhc3NpZ24oLyogQF9fUFVSRV9fICovIGNyZWF0ZUFjdGlvbihgJHthbG19L3JlbW92ZWApLCB7CiAgd2l0aFR5cGVzOiAoKSA9PiByZW1vdmVMaXN0ZW5lcgp9KTsKdmFyIGRlZmF1bHRFcnJvckhhbmRsZXIgPSAoLi4uYXJncykgPT4gewogIGNvbnNvbGUuZXJyb3IoYCR7YWxtfS9lcnJvcmAsIC4uLmFyZ3MpOwp9Owp2YXIgY3JlYXRlTGlzdGVuZXJNaWRkbGV3YXJlID0gKG1pZGRsZXdhcmVPcHRpb25zID0ge30pID0+IHsKICBjb25zdCBsaXN0ZW5lck1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgY29uc3QgZXhlY3V0aW5nTGlzdGVuZXJzID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBjb25zdCB0cmFja0V4ZWN1dGluZ0xpc3RlbmVyID0gKGVudHJ5KSA9PiB7CiAgICBjb25zdCBjb3VudCA9IGV4ZWN1dGluZ0xpc3RlbmVycy5nZXQoZW50cnkpID8/IDA7CiAgICBleGVjdXRpbmdMaXN0ZW5lcnMuc2V0KGVudHJ5LCBjb3VudCArIDEpOwogIH07CiAgY29uc3QgdW50cmFja0V4ZWN1dGluZ0xpc3RlbmVyID0gKGVudHJ5KSA9PiB7CiAgICBjb25zdCBjb3VudCA9IGV4ZWN1dGluZ0xpc3RlbmVycy5nZXQoZW50cnkpID8/IDE7CiAgICBpZiAoY291bnQgPT09IDEpIHsKICAgICAgZXhlY3V0aW5nTGlzdGVuZXJzLmRlbGV0ZShlbnRyeSk7CiAgICB9IGVsc2UgewogICAgICBleGVjdXRpbmdMaXN0ZW5lcnMuc2V0KGVudHJ5LCBjb3VudCAtIDEpOwogICAgfQogIH07CiAgY29uc3QgewogICAgZXh0cmEsCiAgICBvbkVycm9yID0gZGVmYXVsdEVycm9ySGFuZGxlcgogIH0gPSBtaWRkbGV3YXJlT3B0aW9uczsKICBhc3NlcnRGdW5jdGlvbihvbkVycm9yLCAib25FcnJvciIpOwogIGNvbnN0IGluc2VydEVudHJ5ID0gKGVudHJ5KSA9PiB7CiAgICBlbnRyeS51bnN1YnNjcmliZSA9ICgpID0+IGxpc3RlbmVyTWFwLmRlbGV0ZShlbnRyeS5pZCk7CiAgICBsaXN0ZW5lck1hcC5zZXQoZW50cnkuaWQsIGVudHJ5KTsKICAgIHJldHVybiAoY2FuY2VsT3B0aW9ucykgPT4gewogICAgICBlbnRyeS51bnN1YnNjcmliZSgpOwogICAgICBpZiAoY2FuY2VsT3B0aW9ucz8uY2FuY2VsQWN0aXZlKSB7CiAgICAgICAgY2FuY2VsQWN0aXZlTGlzdGVuZXJzKGVudHJ5KTsKICAgICAgfQogICAgfTsKICB9OwogIGNvbnN0IHN0YXJ0TGlzdGVuaW5nID0gKG9wdGlvbnMpID0+IHsKICAgIGNvbnN0IGVudHJ5ID0gZmluZExpc3RlbmVyRW50cnkobGlzdGVuZXJNYXAsIG9wdGlvbnMpID8/IGNyZWF0ZUxpc3RlbmVyRW50cnkob3B0aW9ucyk7CiAgICByZXR1cm4gaW5zZXJ0RW50cnkoZW50cnkpOwogIH07CiAgYXNzaWduKHN0YXJ0TGlzdGVuaW5nLCB7CiAgICB3aXRoVHlwZXM6ICgpID0+IHN0YXJ0TGlzdGVuaW5nCiAgfSk7CiAgY29uc3Qgc3RvcExpc3RlbmluZyA9IChvcHRpb25zKSA9PiB7CiAgICBjb25zdCBlbnRyeSA9IGZpbmRMaXN0ZW5lckVudHJ5KGxpc3RlbmVyTWFwLCBvcHRpb25zKTsKICAgIGlmIChlbnRyeSkgewogICAgICBlbnRyeS51bnN1YnNjcmliZSgpOwogICAgICBpZiAob3B0aW9ucy5jYW5jZWxBY3RpdmUpIHsKICAgICAgICBjYW5jZWxBY3RpdmVMaXN0ZW5lcnMoZW50cnkpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gISFlbnRyeTsKICB9OwogIGFzc2lnbihzdG9wTGlzdGVuaW5nLCB7CiAgICB3aXRoVHlwZXM6ICgpID0+IHN0b3BMaXN0ZW5pbmcKICB9KTsKICBjb25zdCBub3RpZnlMaXN0ZW5lciA9IGFzeW5jIChlbnRyeSwgYWN0aW9uLCBhcGksIGdldE9yaWdpbmFsU3RhdGUpID0+IHsKICAgIGNvbnN0IGludGVybmFsVGFza0NvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICBjb25zdCB0YWtlID0gY3JlYXRlVGFrZVBhdHRlcm4oc3RhcnRMaXN0ZW5pbmcsIGludGVybmFsVGFza0NvbnRyb2xsZXIuc2lnbmFsKTsKICAgIGNvbnN0IGF1dG9Kb2luUHJvbWlzZXMgPSBbXTsKICAgIHRyeSB7CiAgICAgIGVudHJ5LnBlbmRpbmcuYWRkKGludGVybmFsVGFza0NvbnRyb2xsZXIpOwogICAgICB0cmFja0V4ZWN1dGluZ0xpc3RlbmVyKGVudHJ5KTsKICAgICAgYXdhaXQgUHJvbWlzZS5yZXNvbHZlKGVudHJ5LmVmZmVjdCgKICAgICAgICBhY3Rpb24sCiAgICAgICAgLy8gVXNlIGFzc2lnbigpIHJhdGhlciB0aGFuIC4uLiB0byBhdm9pZCBleHRyYSBoZWxwZXIgZnVuY3Rpb25zIGFkZGVkIHRvIGJ1bmRsZQogICAgICAgIGFzc2lnbih7fSwgYXBpLCB7CiAgICAgICAgICBnZXRPcmlnaW5hbFN0YXRlLAogICAgICAgICAgY29uZGl0aW9uOiAocHJlZGljYXRlLCB0aW1lb3V0KSA9PiB0YWtlKHByZWRpY2F0ZSwgdGltZW91dCkudGhlbihCb29sZWFuKSwKICAgICAgICAgIHRha2UsCiAgICAgICAgICBkZWxheTogY3JlYXRlRGVsYXkoaW50ZXJuYWxUYXNrQ29udHJvbGxlci5zaWduYWwpLAogICAgICAgICAgcGF1c2U6IGNyZWF0ZVBhdXNlKGludGVybmFsVGFza0NvbnRyb2xsZXIuc2lnbmFsKSwKICAgICAgICAgIGV4dHJhLAogICAgICAgICAgc2lnbmFsOiBpbnRlcm5hbFRhc2tDb250cm9sbGVyLnNpZ25hbCwKICAgICAgICAgIGZvcms6IGNyZWF0ZUZvcmsoaW50ZXJuYWxUYXNrQ29udHJvbGxlci5zaWduYWwsIGF1dG9Kb2luUHJvbWlzZXMpLAogICAgICAgICAgdW5zdWJzY3JpYmU6IGVudHJ5LnVuc3Vic2NyaWJlLAogICAgICAgICAgc3Vic2NyaWJlOiAoKSA9PiB7CiAgICAgICAgICAgIGxpc3RlbmVyTWFwLnNldChlbnRyeS5pZCwgZW50cnkpOwogICAgICAgICAgfSwKICAgICAgICAgIGNhbmNlbEFjdGl2ZUxpc3RlbmVyczogKCkgPT4gewogICAgICAgICAgICBlbnRyeS5wZW5kaW5nLmZvckVhY2goKGNvbnRyb2xsZXIsIF8sIHNldDMpID0+IHsKICAgICAgICAgICAgICBpZiAoY29udHJvbGxlciAhPT0gaW50ZXJuYWxUYXNrQ29udHJvbGxlcikgewogICAgICAgICAgICAgICAgYWJvcnRDb250cm9sbGVyV2l0aFJlYXNvbihjb250cm9sbGVyLCBsaXN0ZW5lckNhbmNlbGxlZCk7CiAgICAgICAgICAgICAgICBzZXQzLmRlbGV0ZShjb250cm9sbGVyKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwKICAgICAgICAgIGNhbmNlbDogKCkgPT4gewogICAgICAgICAgICBhYm9ydENvbnRyb2xsZXJXaXRoUmVhc29uKGludGVybmFsVGFza0NvbnRyb2xsZXIsIGxpc3RlbmVyQ2FuY2VsbGVkKTsKICAgICAgICAgICAgZW50cnkucGVuZGluZy5kZWxldGUoaW50ZXJuYWxUYXNrQ29udHJvbGxlcik7CiAgICAgICAgICB9LAogICAgICAgICAgdGhyb3dJZkNhbmNlbGxlZDogKCkgPT4gewogICAgICAgICAgICB2YWxpZGF0ZUFjdGl2ZShpbnRlcm5hbFRhc2tDb250cm9sbGVyLnNpZ25hbCk7CiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgKSk7CiAgICB9IGNhdGNoIChsaXN0ZW5lckVycm9yKSB7CiAgICAgIGlmICghKGxpc3RlbmVyRXJyb3IgaW5zdGFuY2VvZiBUYXNrQWJvcnRFcnJvcikpIHsKICAgICAgICBzYWZlbHlOb3RpZnlFcnJvcihvbkVycm9yLCBsaXN0ZW5lckVycm9yLCB7CiAgICAgICAgICByYWlzZWRCeTogImVmZmVjdCIKICAgICAgICB9KTsKICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoYXV0b0pvaW5Qcm9taXNlcyk7CiAgICAgIGFib3J0Q29udHJvbGxlcldpdGhSZWFzb24oaW50ZXJuYWxUYXNrQ29udHJvbGxlciwgbGlzdGVuZXJDb21wbGV0ZWQpOwogICAgICB1bnRyYWNrRXhlY3V0aW5nTGlzdGVuZXIoZW50cnkpOwogICAgICBlbnRyeS5wZW5kaW5nLmRlbGV0ZShpbnRlcm5hbFRhc2tDb250cm9sbGVyKTsKICAgIH0KICB9OwogIGNvbnN0IGNsZWFyTGlzdGVuZXJNaWRkbGV3YXJlID0gY3JlYXRlQ2xlYXJMaXN0ZW5lck1pZGRsZXdhcmUobGlzdGVuZXJNYXAsIGV4ZWN1dGluZ0xpc3RlbmVycyk7CiAgY29uc3QgbWlkZGxld2FyZSA9IChhcGkpID0+IChuZXh0KSA9PiAoYWN0aW9uKSA9PiB7CiAgICBpZiAoIWlzQWN0aW9uKGFjdGlvbikpIHsKICAgICAgcmV0dXJuIG5leHQoYWN0aW9uKTsKICAgIH0KICAgIGlmIChhZGRMaXN0ZW5lci5tYXRjaChhY3Rpb24pKSB7CiAgICAgIHJldHVybiBzdGFydExpc3RlbmluZyhhY3Rpb24ucGF5bG9hZCk7CiAgICB9CiAgICBpZiAoY2xlYXJBbGxMaXN0ZW5lcnMubWF0Y2goYWN0aW9uKSkgewogICAgICBjbGVhckxpc3RlbmVyTWlkZGxld2FyZSgpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocmVtb3ZlTGlzdGVuZXIubWF0Y2goYWN0aW9uKSkgewogICAgICByZXR1cm4gc3RvcExpc3RlbmluZyhhY3Rpb24ucGF5bG9hZCk7CiAgICB9CiAgICBsZXQgb3JpZ2luYWxTdGF0ZSA9IGFwaS5nZXRTdGF0ZSgpOwogICAgY29uc3QgZ2V0T3JpZ2luYWxTdGF0ZSA9ICgpID0+IHsKICAgICAgaWYgKG9yaWdpbmFsU3RhdGUgPT09IElOVEVSTkFMX05JTF9UT0tFTikgewogICAgICAgIHRocm93IG5ldyBFcnJvcihmYWxzZSA/IGZvcm1hdFByb2RFcnJvck1lc3NhZ2UoMjMpIDogYCR7YWxtfTogZ2V0T3JpZ2luYWxTdGF0ZSBjYW4gb25seSBiZSBjYWxsZWQgc3luY2hyb25vdXNseWApOwogICAgICB9CiAgICAgIHJldHVybiBvcmlnaW5hbFN0YXRlOwogICAgfTsKICAgIGxldCByZXN1bHQ7CiAgICB0cnkgewogICAgICByZXN1bHQgPSBuZXh0KGFjdGlvbik7CiAgICAgIGlmIChsaXN0ZW5lck1hcC5zaXplID4gMCkgewogICAgICAgIGNvbnN0IGN1cnJlbnRTdGF0ZSA9IGFwaS5nZXRTdGF0ZSgpOwogICAgICAgIGNvbnN0IGxpc3RlbmVyRW50cmllcyA9IEFycmF5LmZyb20obGlzdGVuZXJNYXAudmFsdWVzKCkpOwogICAgICAgIGZvciAoY29uc3QgZW50cnkgb2YgbGlzdGVuZXJFbnRyaWVzKSB7CiAgICAgICAgICBsZXQgcnVuTGlzdGVuZXIgPSBmYWxzZTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJ1bkxpc3RlbmVyID0gZW50cnkucHJlZGljYXRlKGFjdGlvbiwgY3VycmVudFN0YXRlLCBvcmlnaW5hbFN0YXRlKTsKICAgICAgICAgIH0gY2F0Y2ggKHByZWRpY2F0ZUVycm9yKSB7CiAgICAgICAgICAgIHJ1bkxpc3RlbmVyID0gZmFsc2U7CiAgICAgICAgICAgIHNhZmVseU5vdGlmeUVycm9yKG9uRXJyb3IsIHByZWRpY2F0ZUVycm9yLCB7CiAgICAgICAgICAgICAgcmFpc2VkQnk6ICJwcmVkaWNhdGUiCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgaWYgKCFydW5MaXN0ZW5lcikgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIG5vdGlmeUxpc3RlbmVyKGVudHJ5LCBhY3Rpb24sIGFwaSwgZ2V0T3JpZ2luYWxTdGF0ZSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGZpbmFsbHkgewogICAgICBvcmlnaW5hbFN0YXRlID0gSU5URVJOQUxfTklMX1RPS0VOOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9OwogIHJldHVybiB7CiAgICBtaWRkbGV3YXJlLAogICAgc3RhcnRMaXN0ZW5pbmcsCiAgICBzdG9wTGlzdGVuaW5nLAogICAgY2xlYXJMaXN0ZW5lcnM6IGNsZWFyTGlzdGVuZXJNaWRkbGV3YXJlCiAgfTsKfTsKdmFyIE9SSUdJTkFMX1NUQVRFID0gU3ltYm9sLmZvcigicnRrLXN0YXRlLXByb3h5LW9yaWdpbmFsIik7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9sYXlvdXRTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlID0gewogIGxheW91dFR5cGU6ICJob3Jpem9udGFsIiwKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgbWFyZ2luOiB7CiAgICB0b3A6IDUsCiAgICByaWdodDogNSwKICAgIGJvdHRvbTogNSwKICAgIGxlZnQ6IDUKICB9LAogIHNjYWxlOiAxCn07CnZhciBjaGFydExheW91dFNsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJjaGFydExheW91dCIsCiAgaW5pdGlhbFN0YXRlLAogIHJlZHVjZXJzOiB7CiAgICBzZXRMYXlvdXQoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5sYXlvdXRUeXBlID0gYWN0aW9uLnBheWxvYWQ7CiAgICB9LAogICAgc2V0Q2hhcnRTaXplKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUud2lkdGggPSBhY3Rpb24ucGF5bG9hZC53aWR0aDsKICAgICAgc3RhdGUuaGVpZ2h0ID0gYWN0aW9uLnBheWxvYWQuaGVpZ2h0OwogICAgfSwKICAgIHNldE1hcmdpbihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHZhciBfYWN0aW9uJHBheWxvYWQkdG9wLCBfYWN0aW9uJHBheWxvYWQkcmlnaHQsIF9hY3Rpb24kcGF5bG9hZCRib3R0bywgX2FjdGlvbiRwYXlsb2FkJGxlZnQ7CiAgICAgIHN0YXRlLm1hcmdpbi50b3AgPSAoX2FjdGlvbiRwYXlsb2FkJHRvcCA9IGFjdGlvbi5wYXlsb2FkLnRvcCkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJHRvcCAhPT0gdm9pZCAwID8gX2FjdGlvbiRwYXlsb2FkJHRvcCA6IDA7CiAgICAgIHN0YXRlLm1hcmdpbi5yaWdodCA9IChfYWN0aW9uJHBheWxvYWQkcmlnaHQgPSBhY3Rpb24ucGF5bG9hZC5yaWdodCkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJHJpZ2h0ICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkcmlnaHQgOiAwOwogICAgICBzdGF0ZS5tYXJnaW4uYm90dG9tID0gKF9hY3Rpb24kcGF5bG9hZCRib3R0byA9IGFjdGlvbi5wYXlsb2FkLmJvdHRvbSkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkJGJvdHRvICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkYm90dG8gOiAwOwogICAgICBzdGF0ZS5tYXJnaW4ubGVmdCA9IChfYWN0aW9uJHBheWxvYWQkbGVmdCA9IGFjdGlvbi5wYXlsb2FkLmxlZnQpICE9PSBudWxsICYmIF9hY3Rpb24kcGF5bG9hZCRsZWZ0ICE9PSB2b2lkIDAgPyBfYWN0aW9uJHBheWxvYWQkbGVmdCA6IDA7CiAgICB9LAogICAgc2V0U2NhbGUoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zY2FsZSA9IGFjdGlvbi5wYXlsb2FkOwogICAgfQogIH0KfSk7CnZhciB7CiAgc2V0TWFyZ2luLAogIHNldExheW91dCwKICBzZXRDaGFydFNpemUsCiAgc2V0U2NhbGUKfSA9IGNoYXJ0TGF5b3V0U2xpY2UuYWN0aW9uczsKdmFyIGNoYXJ0TGF5b3V0UmVkdWNlciA9IGNoYXJ0TGF5b3V0U2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvQ2hhcnRVdGlscy5qcwp2YXIgaW1wb3J0X3NvcnRCeTIgPSBfX3RvRVNNKHJlcXVpcmVfc29ydEJ5MigpKTsKdmFyIGltcG9ydF9nZXQyID0gX190b0VTTShyZXF1aXJlX2dldDIoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2dldFNsaWNlZC5qcwpmdW5jdGlvbiBnZXRTbGljZWQoYXJyLCBzdGFydEluZGV4LCBlbmRJbmRleCkgewogIGlmICghQXJyYXkuaXNBcnJheShhcnIpKSB7CiAgICByZXR1cm4gYXJyOwogIH0KICBpZiAoYXJyICYmIHN0YXJ0SW5kZXggKyBlbmRJbmRleCAhPT0gMCkgewogICAgcmV0dXJuIGFyci5zbGljZShzdGFydEluZGV4LCBlbmRJbmRleCArIDEpOwogIH0KICByZXR1cm4gYXJyOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0NoYXJ0VXRpbHMuanMKZnVuY3Rpb24gb3duS2V5czIoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMihPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MihlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTIodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gZ2V0VmFsdWVCeURhdGFLZXkob2JqLCBkYXRhS2V5LCBkZWZhdWx0VmFsdWUpIHsKICBpZiAoaXNOdWxsaXNoKG9iaikgfHwgaXNOdWxsaXNoKGRhdGFLZXkpKSB7CiAgICByZXR1cm4gZGVmYXVsdFZhbHVlOwogIH0KICBpZiAoaXNOdW1PclN0cihkYXRhS2V5KSkgewogICAgcmV0dXJuICgwLCBpbXBvcnRfZ2V0Mi5kZWZhdWx0KShvYmosIGRhdGFLZXksIGRlZmF1bHRWYWx1ZSk7CiAgfQogIGlmICh0eXBlb2YgZGF0YUtleSA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIGRhdGFLZXkob2JqKTsKICB9CiAgcmV0dXJuIGRlZmF1bHRWYWx1ZTsKfQp2YXIgYXBwZW5kT2Zmc2V0T2ZMZWdlbmQgPSAob2Zmc2V0LCBsZWdlbmRTZXR0aW5ncywgbGVnZW5kU2l6ZSkgPT4gewogIGlmIChsZWdlbmRTZXR0aW5ncyAmJiBsZWdlbmRTaXplKSB7CiAgICB2YXIgewogICAgICB3aWR0aDogYm94V2lkdGgsCiAgICAgIGhlaWdodDogYm94SGVpZ2h0CiAgICB9ID0gbGVnZW5kU2l6ZTsKICAgIHZhciB7CiAgICAgIGFsaWduLAogICAgICB2ZXJ0aWNhbEFsaWduLAogICAgICBsYXlvdXQKICAgIH0gPSBsZWdlbmRTZXR0aW5nczsKICAgIGlmICgobGF5b3V0ID09PSAidmVydGljYWwiIHx8IGxheW91dCA9PT0gImhvcml6b250YWwiICYmIHZlcnRpY2FsQWxpZ24gPT09ICJtaWRkbGUiKSAmJiBhbGlnbiAhPT0gImNlbnRlciIgJiYgaXNOdW1iZXIob2Zmc2V0W2FsaWduXSkpIHsKICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyKF9vYmplY3RTcHJlYWQyKHt9LCBvZmZzZXQpLCB7fSwgewogICAgICAgIFthbGlnbl06IG9mZnNldFthbGlnbl0gKyAoYm94V2lkdGggfHwgMCkKICAgICAgfSk7CiAgICB9CiAgICBpZiAoKGxheW91dCA9PT0gImhvcml6b250YWwiIHx8IGxheW91dCA9PT0gInZlcnRpY2FsIiAmJiBhbGlnbiA9PT0gImNlbnRlciIpICYmIHZlcnRpY2FsQWxpZ24gIT09ICJtaWRkbGUiICYmIGlzTnVtYmVyKG9mZnNldFt2ZXJ0aWNhbEFsaWduXSkpIHsKICAgICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyKF9vYmplY3RTcHJlYWQyKHt9LCBvZmZzZXQpLCB7fSwgewogICAgICAgIFt2ZXJ0aWNhbEFsaWduXTogb2Zmc2V0W3ZlcnRpY2FsQWxpZ25dICsgKGJveEhlaWdodCB8fCAwKQogICAgICB9KTsKICAgIH0KICB9CiAgcmV0dXJuIG9mZnNldDsKfTsKdmFyIGlzQ2F0ZWdvcmljYWxBeGlzID0gKGxheW91dCwgYXhpc1R5cGUpID0+IGxheW91dCA9PT0gImhvcml6b250YWwiICYmIGF4aXNUeXBlID09PSAieEF4aXMiIHx8IGxheW91dCA9PT0gInZlcnRpY2FsIiAmJiBheGlzVHlwZSA9PT0gInlBeGlzIiB8fCBsYXlvdXQgPT09ICJjZW50cmljIiAmJiBheGlzVHlwZSA9PT0gImFuZ2xlQXhpcyIgfHwgbGF5b3V0ID09PSAicmFkaWFsIiAmJiBheGlzVHlwZSA9PT0gInJhZGl1c0F4aXMiOwp2YXIgZ2V0Q29vcmRpbmF0ZXNPZkdyaWQgPSAodGlja3MyLCBtaW5WYWx1ZSwgbWF4VmFsdWUsIHN5bmNXaXRoVGlja3MpID0+IHsKICBpZiAoc3luY1dpdGhUaWNrcykgewogICAgcmV0dXJuIHRpY2tzMi5tYXAoKGVudHJ5KSA9PiBlbnRyeS5jb29yZGluYXRlKTsKICB9CiAgdmFyIGhhc01pbiwgaGFzTWF4OwogIHZhciB2YWx1ZXMgPSB0aWNrczIubWFwKChlbnRyeSkgPT4gewogICAgaWYgKGVudHJ5LmNvb3JkaW5hdGUgPT09IG1pblZhbHVlKSB7CiAgICAgIGhhc01pbiA9IHRydWU7CiAgICB9CiAgICBpZiAoZW50cnkuY29vcmRpbmF0ZSA9PT0gbWF4VmFsdWUpIHsKICAgICAgaGFzTWF4ID0gdHJ1ZTsKICAgIH0KICAgIHJldHVybiBlbnRyeS5jb29yZGluYXRlOwogIH0pOwogIGlmICghaGFzTWluKSB7CiAgICB2YWx1ZXMucHVzaChtaW5WYWx1ZSk7CiAgfQogIGlmICghaGFzTWF4KSB7CiAgICB2YWx1ZXMucHVzaChtYXhWYWx1ZSk7CiAgfQogIHJldHVybiB2YWx1ZXM7Cn07CnZhciBnZXRUaWNrc09mQXhpcyA9IChheGlzLCBpc0dyaWQsIGlzQWxsKSA9PiB7CiAgaWYgKCFheGlzKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIGR1cGxpY2F0ZURvbWFpbiwKICAgIHR5cGUsCiAgICByYW5nZTogcmFuZ2U0LAogICAgc2NhbGUsCiAgICByZWFsU2NhbGVUeXBlLAogICAgaXNDYXRlZ29yaWNhbCwKICAgIGNhdGVnb3JpY2FsRG9tYWluLAogICAgdGlja0NvdW50LAogICAgdGlja3M6IHRpY2tzMiwKICAgIG5pY2VUaWNrcywKICAgIGF4aXNUeXBlCiAgfSA9IGF4aXM7CiAgaWYgKCFzY2FsZSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBvZmZzZXRGb3JCYW5kID0gcmVhbFNjYWxlVHlwZSA9PT0gInNjYWxlQmFuZCIgJiYgc2NhbGUuYmFuZHdpZHRoID8gc2NhbGUuYmFuZHdpZHRoKCkgLyAyIDogMjsKICB2YXIgb2Zmc2V0ID0gKGlzR3JpZCB8fCBpc0FsbCkgJiYgdHlwZSA9PT0gImNhdGVnb3J5IiAmJiBzY2FsZS5iYW5kd2lkdGggPyBzY2FsZS5iYW5kd2lkdGgoKSAvIG9mZnNldEZvckJhbmQgOiAwOwogIG9mZnNldCA9IGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIiAmJiByYW5nZTQgJiYgcmFuZ2U0Lmxlbmd0aCA+PSAyID8gbWF0aFNpZ24ocmFuZ2U0WzBdIC0gcmFuZ2U0WzFdKSAqIDIgKiBvZmZzZXQgOiBvZmZzZXQ7CiAgaWYgKGlzR3JpZCAmJiAodGlja3MyIHx8IG5pY2VUaWNrcykpIHsKICAgIHZhciByZXN1bHQgPSAodGlja3MyIHx8IG5pY2VUaWNrcyB8fCBbXSkubWFwKChlbnRyeSwgaW5kZXgpID0+IHsKICAgICAgdmFyIHNjYWxlQ29udGVudCA9IGR1cGxpY2F0ZURvbWFpbiA/IGR1cGxpY2F0ZURvbWFpbi5pbmRleE9mKGVudHJ5KSA6IGVudHJ5OwogICAgICByZXR1cm4gewogICAgICAgIC8vIElmIHRoZSBzY2FsZUNvbnRlbnQgaXMgbm90IGEgbnVtYmVyLCB0aGUgY29vcmRpbmF0ZSB3aWxsIGJlIE5hTi4KICAgICAgICAvLyBUaGF0IGNvdWxkIGJlIHRoZSBjYXNlIGZvciBleGFtcGxlIHdpdGggYSBQb2ludFNjYWxlIGFuZCBhIHN0cmluZyBhcyBkb21haW4uCiAgICAgICAgY29vcmRpbmF0ZTogc2NhbGUoc2NhbGVDb250ZW50KSArIG9mZnNldCwKICAgICAgICB2YWx1ZTogZW50cnksCiAgICAgICAgb2Zmc2V0LAogICAgICAgIGluZGV4CiAgICAgIH07CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQuZmlsdGVyKChyb3cpID0+ICFpc05hbihyb3cuY29vcmRpbmF0ZSkpOwogIH0KICBpZiAoaXNDYXRlZ29yaWNhbCAmJiBjYXRlZ29yaWNhbERvbWFpbikgewogICAgcmV0dXJuIGNhdGVnb3JpY2FsRG9tYWluLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICAgIHZhbHVlOiBlbnRyeSwKICAgICAgaW5kZXgsCiAgICAgIG9mZnNldAogICAgfSkpOwogIH0KICBpZiAoc2NhbGUudGlja3MgJiYgIWlzQWxsICYmIHRpY2tDb3VudCAhPSBudWxsKSB7CiAgICByZXR1cm4gc2NhbGUudGlja3ModGlja0NvdW50KS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIG9mZnNldCwKICAgICAgaW5kZXgKICAgIH0pKTsKICB9CiAgcmV0dXJuIHNjYWxlLmRvbWFpbigpLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgdmFsdWU6IGR1cGxpY2F0ZURvbWFpbiA/IGR1cGxpY2F0ZURvbWFpbltlbnRyeV0gOiBlbnRyeSwKICAgIGluZGV4LAogICAgb2Zmc2V0CiAgfSkpOwp9Owp2YXIgRVBTMiA9IDFlLTQ7CnZhciBjaGVja0RvbWFpbk9mU2NhbGUgPSAoc2NhbGUpID0+IHsKICB2YXIgZG9tYWluID0gc2NhbGUuZG9tYWluKCk7CiAgaWYgKCFkb21haW4gfHwgZG9tYWluLmxlbmd0aCA8PSAyKSB7CiAgICByZXR1cm47CiAgfQogIHZhciBsZW4gPSBkb21haW4ubGVuZ3RoOwogIHZhciByYW5nZTQgPSBzY2FsZS5yYW5nZSgpOwogIHZhciBtaW5WYWx1ZSA9IE1hdGgubWluKHJhbmdlNFswXSwgcmFuZ2U0WzFdKSAtIEVQUzI7CiAgdmFyIG1heFZhbHVlID0gTWF0aC5tYXgocmFuZ2U0WzBdLCByYW5nZTRbMV0pICsgRVBTMjsKICB2YXIgZmlyc3QgPSBzY2FsZShkb21haW5bMF0pOwogIHZhciBsYXN0MiA9IHNjYWxlKGRvbWFpbltsZW4gLSAxXSk7CiAgaWYgKGZpcnN0IDwgbWluVmFsdWUgfHwgZmlyc3QgPiBtYXhWYWx1ZSB8fCBsYXN0MiA8IG1pblZhbHVlIHx8IGxhc3QyID4gbWF4VmFsdWUpIHsKICAgIHNjYWxlLmRvbWFpbihbZG9tYWluWzBdLCBkb21haW5bbGVuIC0gMV1dKTsKICB9Cn07CnZhciBvZmZzZXRTaWduID0gKHNlcmllcykgPT4gewogIHZhciBuID0gc2VyaWVzLmxlbmd0aDsKICBpZiAobiA8PSAwKSB7CiAgICByZXR1cm47CiAgfQogIGZvciAodmFyIGogPSAwLCBtID0gc2VyaWVzWzBdLmxlbmd0aDsgaiA8IG07ICsraikgewogICAgdmFyIHBvc2l0aXZlID0gMDsKICAgIHZhciBuZWdhdGl2ZSA9IDA7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47ICsraSkgewogICAgICB2YXIgdmFsdWUgPSBpc05hbihzZXJpZXNbaV1bal1bMV0pID8gc2VyaWVzW2ldW2pdWzBdIDogc2VyaWVzW2ldW2pdWzFdOwogICAgICBpZiAodmFsdWUgPj0gMCkgewogICAgICAgIHNlcmllc1tpXVtqXVswXSA9IHBvc2l0aXZlOwogICAgICAgIHNlcmllc1tpXVtqXVsxXSA9IHBvc2l0aXZlICsgdmFsdWU7CiAgICAgICAgcG9zaXRpdmUgPSBzZXJpZXNbaV1bal1bMV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2VyaWVzW2ldW2pdWzBdID0gbmVnYXRpdmU7CiAgICAgICAgc2VyaWVzW2ldW2pdWzFdID0gbmVnYXRpdmUgKyB2YWx1ZTsKICAgICAgICBuZWdhdGl2ZSA9IHNlcmllc1tpXVtqXVsxXTsKICAgICAgfQogICAgfQogIH0KfTsKdmFyIG9mZnNldFBvc2l0aXZlID0gKHNlcmllcykgPT4gewogIHZhciBuID0gc2VyaWVzLmxlbmd0aDsKICBpZiAobiA8PSAwKSB7CiAgICByZXR1cm47CiAgfQogIGZvciAodmFyIGogPSAwLCBtID0gc2VyaWVzWzBdLmxlbmd0aDsgaiA8IG07ICsraikgewogICAgdmFyIHBvc2l0aXZlID0gMDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgIHZhciB2YWx1ZSA9IGlzTmFuKHNlcmllc1tpXVtqXVsxXSkgPyBzZXJpZXNbaV1bal1bMF0gOiBzZXJpZXNbaV1bal1bMV07CiAgICAgIGlmICh2YWx1ZSA+PSAwKSB7CiAgICAgICAgc2VyaWVzW2ldW2pdWzBdID0gcG9zaXRpdmU7CiAgICAgICAgc2VyaWVzW2ldW2pdWzFdID0gcG9zaXRpdmUgKyB2YWx1ZTsKICAgICAgICBwb3NpdGl2ZSA9IHNlcmllc1tpXVtqXVsxXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXJpZXNbaV1bal1bMF0gPSAwOwogICAgICAgIHNlcmllc1tpXVtqXVsxXSA9IDA7CiAgICAgIH0KICAgIH0KICB9Cn07CnZhciBTVEFDS19PRkZTRVRfTUFQID0gewogIHNpZ246IG9mZnNldFNpZ24sCiAgLy8gQHRzLWV4cGVjdC1lcnJvciBkZWZpbml0ZWx5dHlwZWQgdHlwZXMgYXJlIGluY29ycmVjdAogIGV4cGFuZDogZXhwYW5kX2RlZmF1bHQsCiAgLy8gQHRzLWV4cGVjdC1lcnJvciBkZWZpbml0ZWx5dHlwZWQgdHlwZXMgYXJlIGluY29ycmVjdAogIG5vbmU6IG5vbmVfZGVmYXVsdCwKICAvLyBAdHMtZXhwZWN0LWVycm9yIGRlZmluaXRlbHl0eXBlZCB0eXBlcyBhcmUgaW5jb3JyZWN0CiAgc2lsaG91ZXR0ZTogc2lsaG91ZXR0ZV9kZWZhdWx0LAogIC8vIEB0cy1leHBlY3QtZXJyb3IgZGVmaW5pdGVseXR5cGVkIHR5cGVzIGFyZSBpbmNvcnJlY3QKICB3aWdnbGU6IHdpZ2dsZV9kZWZhdWx0LAogIHBvc2l0aXZlOiBvZmZzZXRQb3NpdGl2ZQp9Owp2YXIgZ2V0U3RhY2tlZERhdGEgPSAoZGF0YSwgZGF0YUtleXMsIG9mZnNldFR5cGUpID0+IHsKICB2YXIgb2Zmc2V0QWNjZXNzb3IgPSBTVEFDS19PRkZTRVRfTUFQW29mZnNldFR5cGVdOwogIHZhciBzdGFjayA9IHN0YWNrX2RlZmF1bHQoKS5rZXlzKGRhdGFLZXlzKS52YWx1ZSgoZCwga2V5KSA9PiBOdW1iZXIoZ2V0VmFsdWVCeURhdGFLZXkoZCwga2V5LCAwKSkpLm9yZGVyKG5vbmVfZGVmYXVsdDIpLm9mZnNldChvZmZzZXRBY2Nlc3Nvcik7CiAgcmV0dXJuIHN0YWNrKGRhdGEpOwp9OwpmdW5jdGlvbiBnZXROb3JtYWxpemVkU3RhY2tJZChwdWJsaWNTdGFja0lkKSB7CiAgcmV0dXJuIHB1YmxpY1N0YWNrSWQgPT0gbnVsbCA/IHZvaWQgMCA6IFN0cmluZyhwdWJsaWNTdGFja0lkKTsKfQpmdW5jdGlvbiBnZXRDYXRlQ29vcmRpbmF0ZU9mTGluZShfcmVmMikgewogIHZhciB7CiAgICBheGlzLAogICAgdGlja3M6IHRpY2tzMiwKICAgIGJhbmRTaXplLAogICAgZW50cnksCiAgICBpbmRleCwKICAgIGRhdGFLZXkKICB9ID0gX3JlZjI7CiAgaWYgKGF4aXMudHlwZSA9PT0gImNhdGVnb3J5IikgewogICAgaWYgKCFheGlzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5ICYmIGF4aXMuZGF0YUtleSAmJiAhaXNOdWxsaXNoKGVudHJ5W2F4aXMuZGF0YUtleV0pKSB7CiAgICAgIHZhciBtYXRjaGVkVGljayA9IGZpbmRFbnRyeUluQXJyYXkodGlja3MyLCAidmFsdWUiLCBlbnRyeVtheGlzLmRhdGFLZXldKTsKICAgICAgaWYgKG1hdGNoZWRUaWNrKSB7CiAgICAgICAgcmV0dXJuIG1hdGNoZWRUaWNrLmNvb3JkaW5hdGUgKyBiYW5kU2l6ZSAvIDI7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB0aWNrczJbaW5kZXhdID8gdGlja3MyW2luZGV4XS5jb29yZGluYXRlICsgYmFuZFNpemUgLyAyIDogbnVsbDsKICB9CiAgdmFyIHZhbHVlID0gZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksICFpc051bGxpc2goZGF0YUtleSkgPyBkYXRhS2V5IDogYXhpcy5kYXRhS2V5KTsKICByZXR1cm4gIWlzTnVsbGlzaCh2YWx1ZSkgPyBheGlzLnNjYWxlKHZhbHVlKSA6IG51bGw7Cn0KdmFyIGdldERvbWFpbk9mU2luZ2xlID0gKGRhdGEpID0+IHsKICB2YXIgZmxhdCA9IGRhdGEuZmxhdCgyKS5maWx0ZXIoaXNOdW1iZXIpOwogIHJldHVybiBbTWF0aC5taW4oLi4uZmxhdCksIE1hdGgubWF4KC4uLmZsYXQpXTsKfTsKdmFyIG1ha2VEb21haW5GaW5pdGUgPSAoZG9tYWluKSA9PiB7CiAgcmV0dXJuIFtkb21haW5bMF0gPT09IEluZmluaXR5ID8gMCA6IGRvbWFpblswXSwgZG9tYWluWzFdID09PSAtSW5maW5pdHkgPyAwIDogZG9tYWluWzFdXTsKfTsKdmFyIGdldERvbWFpbk9mU3RhY2tHcm91cHMgPSAoc3RhY2tHcm91cHMsIHN0YXJ0SW5kZXgsIGVuZEluZGV4KSA9PiB7CiAgaWYgKHN0YWNrR3JvdXBzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBtYWtlRG9tYWluRmluaXRlKE9iamVjdC5rZXlzKHN0YWNrR3JvdXBzKS5yZWR1Y2UoKHJlc3VsdCwgc3RhY2tJZCkgPT4gewogICAgdmFyIGdyb3VwID0gc3RhY2tHcm91cHNbc3RhY2tJZF07CiAgICB2YXIgewogICAgICBzdGFja2VkRGF0YQogICAgfSA9IGdyb3VwOwogICAgdmFyIGRvbWFpbiA9IHN0YWNrZWREYXRhLnJlZHVjZSgocmVzLCBlbnRyeSkgPT4gewogICAgICB2YXIgc2xpY2VkID0gZ2V0U2xpY2VkKGVudHJ5LCBzdGFydEluZGV4LCBlbmRJbmRleCk7CiAgICAgIHZhciBzID0gZ2V0RG9tYWluT2ZTaW5nbGUoc2xpY2VkKTsKICAgICAgcmV0dXJuIFtNYXRoLm1pbihyZXNbMF0sIHNbMF0pLCBNYXRoLm1heChyZXNbMV0sIHNbMV0pXTsKICAgIH0sIFtJbmZpbml0eSwgLUluZmluaXR5XSk7CiAgICByZXR1cm4gW01hdGgubWluKGRvbWFpblswXSwgcmVzdWx0WzBdKSwgTWF0aC5tYXgoZG9tYWluWzFdLCByZXN1bHRbMV0pXTsKICB9LCBbSW5maW5pdHksIC1JbmZpbml0eV0pKTsKfTsKdmFyIE1JTl9WQUxVRV9SRUcgPSAvXmRhdGFNaW5bXHNdKi1bXHNdKihbMC05XSsoWy5dezF9WzAtOV0rKXswLDF9KSQvOwp2YXIgTUFYX1ZBTFVFX1JFRyA9IC9eZGF0YU1heFtcc10qXCtbXHNdKihbMC05XSsoWy5dezF9WzAtOV0rKXswLDF9KSQvOwp2YXIgZ2V0QmFuZFNpemVPZkF4aXMgPSAoYXhpcywgdGlja3MyLCBpc0JhcikgPT4gewogIGlmIChheGlzICYmIGF4aXMuc2NhbGUgJiYgYXhpcy5zY2FsZS5iYW5kd2lkdGgpIHsKICAgIHZhciBiYW5kV2lkdGggPSBheGlzLnNjYWxlLmJhbmR3aWR0aCgpOwogICAgaWYgKCFpc0JhciB8fCBiYW5kV2lkdGggPiAwKSB7CiAgICAgIHJldHVybiBiYW5kV2lkdGg7CiAgICB9CiAgfQogIGlmIChheGlzICYmIHRpY2tzMiAmJiB0aWNrczIubGVuZ3RoID49IDIpIHsKICAgIHZhciBvcmRlcmVkVGlja3MgPSAoMCwgaW1wb3J0X3NvcnRCeTIuZGVmYXVsdCkodGlja3MyLCAobykgPT4gby5jb29yZGluYXRlKTsKICAgIHZhciBiYW5kU2l6ZSA9IEluZmluaXR5OwogICAgZm9yICh2YXIgaSA9IDEsIGxlbiA9IG9yZGVyZWRUaWNrcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgICB2YXIgY3VyID0gb3JkZXJlZFRpY2tzW2ldOwogICAgICB2YXIgcHJldiA9IG9yZGVyZWRUaWNrc1tpIC0gMV07CiAgICAgIGJhbmRTaXplID0gTWF0aC5taW4oKGN1ci5jb29yZGluYXRlIHx8IDApIC0gKHByZXYuY29vcmRpbmF0ZSB8fCAwKSwgYmFuZFNpemUpOwogICAgfQogICAgcmV0dXJuIGJhbmRTaXplID09PSBJbmZpbml0eSA/IDAgOiBiYW5kU2l6ZTsKICB9CiAgcmV0dXJuIGlzQmFyID8gdm9pZCAwIDogMDsKfTsKZnVuY3Rpb24gZ2V0VG9vbHRpcEVudHJ5KF9yZWY0KSB7CiAgdmFyIHsKICAgIHRvb2x0aXBFbnRyeVNldHRpbmdzLAogICAgZGF0YUtleSwKICAgIHBheWxvYWQsCiAgICB2YWx1ZSwKICAgIG5hbWUKICB9ID0gX3JlZjQ7CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQyKF9vYmplY3RTcHJlYWQyKHt9LCB0b29sdGlwRW50cnlTZXR0aW5ncyksIHt9LCB7CiAgICBkYXRhS2V5LAogICAgcGF5bG9hZCwKICAgIHZhbHVlLAogICAgbmFtZQogIH0pOwp9CmZ1bmN0aW9uIGdldFRvb2x0aXBOYW1lUHJvcChuYW1lRnJvbUl0ZW0sIGRhdGFLZXkpIHsKICBpZiAobmFtZUZyb21JdGVtKSB7CiAgICByZXR1cm4gU3RyaW5nKG5hbWVGcm9tSXRlbSk7CiAgfQogIGlmICh0eXBlb2YgZGF0YUtleSA9PT0gInN0cmluZyIpIHsKICAgIHJldHVybiBkYXRhS2V5OwogIH0KICByZXR1cm4gdm9pZCAwOwp9CnZhciBjYWxjdWxhdGVDYXJ0ZXNpYW5Ub29sdGlwUG9zID0gKGNvb3JkaW5hdGUsIGxheW91dCkgPT4gewogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIikgewogICAgcmV0dXJuIGNvb3JkaW5hdGUuY2hhcnRYOwogIH0KICBpZiAobGF5b3V0ID09PSAidmVydGljYWwiKSB7CiAgICByZXR1cm4gY29vcmRpbmF0ZS5jaGFydFk7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciBjYWxjdWxhdGVQb2xhclRvb2x0aXBQb3MgPSAocmFuZ2VPYmosIGxheW91dCkgPT4gewogIGlmIChsYXlvdXQgPT09ICJjZW50cmljIikgewogICAgcmV0dXJuIHJhbmdlT2JqLmFuZ2xlOwogIH0KICByZXR1cm4gcmFuZ2VPYmoucmFkaXVzOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2NvbnRhaW5lclNlbGVjdG9ycy5qcwp2YXIgc2VsZWN0Q2hhcnRXaWR0aCA9IChzdGF0ZSkgPT4gc3RhdGUubGF5b3V0LndpZHRoOwp2YXIgc2VsZWN0Q2hhcnRIZWlnaHQgPSAoc3RhdGUpID0+IHN0YXRlLmxheW91dC5oZWlnaHQ7CnZhciBzZWxlY3RDb250YWluZXJTY2FsZSA9IChzdGF0ZSkgPT4gc3RhdGUubGF5b3V0LnNjYWxlOwp2YXIgc2VsZWN0TWFyZ2luID0gKHN0YXRlKSA9PiBzdGF0ZS5sYXlvdXQubWFyZ2luOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdEFsbEF4ZXMuanMKdmFyIHNlbGVjdEFsbFhBeGVzID0gY3JlYXRlU2VsZWN0b3IoKHN0YXRlKSA9PiBzdGF0ZS5jYXJ0ZXNpYW5BeGlzLnhBeGlzLCAoeEF4aXNNYXApID0+IHsKICByZXR1cm4gT2JqZWN0LnZhbHVlcyh4QXhpc01hcCk7Cn0pOwp2YXIgc2VsZWN0QWxsWUF4ZXMgPSBjcmVhdGVTZWxlY3Rvcigoc3RhdGUpID0+IHN0YXRlLmNhcnRlc2lhbkF4aXMueUF4aXMsICh5QXhpc01hcCkgPT4gewogIHJldHVybiBPYmplY3QudmFsdWVzKHlBeGlzTWFwKTsKfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL0NvbnN0YW50cy5qcwp2YXIgREFUQV9JVEVNX0lOREVYX0FUVFJJQlVURV9OQU1FID0gImRhdGEtcmVjaGFydHMtaXRlbS1pbmRleCI7CnZhciBEQVRBX0lURU1fREFUQUtFWV9BVFRSSUJVVEVfTkFNRSA9ICJkYXRhLXJlY2hhcnRzLWl0ZW0tZGF0YS1rZXkiOwp2YXIgREVGQVVMVF9ZX0FYSVNfV0lEVEggPSA2MDsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RDaGFydE9mZnNldEludGVybmFsLmpzCmZ1bmN0aW9uIG93bktleXMzKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMyhlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czMoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTMoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTMocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5Myh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUzKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTModCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBzZWxlY3RCcnVzaEhlaWdodCA9IChzdGF0ZSkgPT4gc3RhdGUuYnJ1c2guaGVpZ2h0OwpmdW5jdGlvbiBzZWxlY3RMZWZ0QXhlc09mZnNldChzdGF0ZSkgewogIHZhciB5QXhlcyA9IHNlbGVjdEFsbFlBeGVzKHN0YXRlKTsKICByZXR1cm4geUF4ZXMucmVkdWNlKChyZXN1bHQsIGVudHJ5KSA9PiB7CiAgICBpZiAoZW50cnkub3JpZW50YXRpb24gPT09ICJsZWZ0IiAmJiAhZW50cnkubWlycm9yICYmICFlbnRyeS5oaWRlKSB7CiAgICAgIHZhciB3aWR0aCA9IHR5cGVvZiBlbnRyeS53aWR0aCA9PT0gIm51bWJlciIgPyBlbnRyeS53aWR0aCA6IERFRkFVTFRfWV9BWElTX1dJRFRIOwogICAgICByZXR1cm4gcmVzdWx0ICsgd2lkdGg7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0sIDApOwp9CmZ1bmN0aW9uIHNlbGVjdFJpZ2h0QXhlc09mZnNldChzdGF0ZSkgewogIHZhciB5QXhlcyA9IHNlbGVjdEFsbFlBeGVzKHN0YXRlKTsKICByZXR1cm4geUF4ZXMucmVkdWNlKChyZXN1bHQsIGVudHJ5KSA9PiB7CiAgICBpZiAoZW50cnkub3JpZW50YXRpb24gPT09ICJyaWdodCIgJiYgIWVudHJ5Lm1pcnJvciAmJiAhZW50cnkuaGlkZSkgewogICAgICB2YXIgd2lkdGggPSB0eXBlb2YgZW50cnkud2lkdGggPT09ICJudW1iZXIiID8gZW50cnkud2lkdGggOiBERUZBVUxUX1lfQVhJU19XSURUSDsKICAgICAgcmV0dXJuIHJlc3VsdCArIHdpZHRoOwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9LCAwKTsKfQpmdW5jdGlvbiBzZWxlY3RUb3BBeGVzT2Zmc2V0KHN0YXRlKSB7CiAgdmFyIHhBeGVzID0gc2VsZWN0QWxsWEF4ZXMoc3RhdGUpOwogIHJldHVybiB4QXhlcy5yZWR1Y2UoKHJlc3VsdCwgZW50cnkpID0+IHsKICAgIGlmIChlbnRyeS5vcmllbnRhdGlvbiA9PT0gInRvcCIgJiYgIWVudHJ5Lm1pcnJvciAmJiAhZW50cnkuaGlkZSkgewogICAgICByZXR1cm4gcmVzdWx0ICsgZW50cnkuaGVpZ2h0OwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9LCAwKTsKfQpmdW5jdGlvbiBzZWxlY3RCb3R0b21BeGVzT2Zmc2V0KHN0YXRlKSB7CiAgdmFyIHhBeGVzID0gc2VsZWN0QWxsWEF4ZXMoc3RhdGUpOwogIHJldHVybiB4QXhlcy5yZWR1Y2UoKHJlc3VsdCwgZW50cnkpID0+IHsKICAgIGlmIChlbnRyeS5vcmllbnRhdGlvbiA9PT0gImJvdHRvbSIgJiYgIWVudHJ5Lm1pcnJvciAmJiAhZW50cnkuaGlkZSkgewogICAgICByZXR1cm4gcmVzdWx0ICsgZW50cnkuaGVpZ2h0OwogICAgfQogICAgcmV0dXJuIHJlc3VsdDsKICB9LCAwKTsKfQp2YXIgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodCwgc2VsZWN0TWFyZ2luLCBzZWxlY3RCcnVzaEhlaWdodCwgc2VsZWN0TGVmdEF4ZXNPZmZzZXQsIHNlbGVjdFJpZ2h0QXhlc09mZnNldCwgc2VsZWN0VG9wQXhlc09mZnNldCwgc2VsZWN0Qm90dG9tQXhlc09mZnNldCwgc2VsZWN0TGVnZW5kU2V0dGluZ3MsIHNlbGVjdExlZ2VuZFNpemVdLCAoY2hhcnRXaWR0aCwgY2hhcnRIZWlnaHQsIG1hcmdpbiwgYnJ1c2hIZWlnaHQsIGxlZnRBeGVzT2Zmc2V0LCByaWdodEF4ZXNPZmZzZXQsIHRvcEF4ZXNPZmZzZXQsIGJvdHRvbUF4ZXNPZmZzZXQsIGxlZ2VuZFNldHRpbmdzLCBsZWdlbmRTaXplKSA9PiB7CiAgdmFyIG9mZnNldEggPSB7CiAgICBsZWZ0OiAobWFyZ2luLmxlZnQgfHwgMCkgKyBsZWZ0QXhlc09mZnNldCwKICAgIHJpZ2h0OiAobWFyZ2luLnJpZ2h0IHx8IDApICsgcmlnaHRBeGVzT2Zmc2V0CiAgfTsKICB2YXIgb2Zmc2V0ViA9IHsKICAgIHRvcDogKG1hcmdpbi50b3AgfHwgMCkgKyB0b3BBeGVzT2Zmc2V0LAogICAgYm90dG9tOiAobWFyZ2luLmJvdHRvbSB8fCAwKSArIGJvdHRvbUF4ZXNPZmZzZXQKICB9OwogIHZhciBvZmZzZXQgPSBfb2JqZWN0U3ByZWFkMyhfb2JqZWN0U3ByZWFkMyh7fSwgb2Zmc2V0ViksIG9mZnNldEgpOwogIHZhciBicnVzaEJvdHRvbSA9IG9mZnNldC5ib3R0b207CiAgb2Zmc2V0LmJvdHRvbSArPSBicnVzaEhlaWdodDsKICBvZmZzZXQgPSBhcHBlbmRPZmZzZXRPZkxlZ2VuZChvZmZzZXQsIGxlZ2VuZFNldHRpbmdzLCBsZWdlbmRTaXplKTsKICB2YXIgb2Zmc2V0V2lkdGggPSBjaGFydFdpZHRoIC0gb2Zmc2V0LmxlZnQgLSBvZmZzZXQucmlnaHQ7CiAgdmFyIG9mZnNldEhlaWdodCA9IGNoYXJ0SGVpZ2h0IC0gb2Zmc2V0LnRvcCAtIG9mZnNldC5ib3R0b207CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQzKF9vYmplY3RTcHJlYWQzKHsKICAgIGJydXNoQm90dG9tCiAgfSwgb2Zmc2V0KSwge30sIHsKICAgIC8vIG5ldmVyIHJldHVybiBuZWdhdGl2ZSB2YWx1ZXMgZm9yIGhlaWdodCBhbmQgd2lkdGgKICAgIHdpZHRoOiBNYXRoLm1heChvZmZzZXRXaWR0aCwgMCksCiAgICBoZWlnaHQ6IE1hdGgubWF4KG9mZnNldEhlaWdodCwgMCkKICB9KTsKfSk7CnZhciBzZWxlY3RDaGFydFZpZXdCb3ggPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCAob2Zmc2V0KSA9PiAoewogIHg6IG9mZnNldC5sZWZ0LAogIHk6IG9mZnNldC50b3AsCiAgd2lkdGg6IG9mZnNldC53aWR0aCwKICBoZWlnaHQ6IG9mZnNldC5oZWlnaHQKfSkpOwp2YXIgc2VsZWN0QXhpc1ZpZXdCb3ggPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodCwgKHdpZHRoLCBoZWlnaHQpID0+ICh7CiAgeDogMCwKICB5OiAwLAogIHdpZHRoLAogIGhlaWdodAp9KSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L1Bhbm9yYW1hQ29udGV4dC5qcwp2YXIgUmVhY3QzID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MTEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBQYW5vcmFtYUNvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDExLmNyZWF0ZUNvbnRleHQpKG51bGwpOwp2YXIgdXNlSXNQYW5vcmFtYSA9ICgpID0+ICgwLCBpbXBvcnRfcmVhY3QxMS51c2VDb250ZXh0KShQYW5vcmFtYUNvbnRleHQpICE9IG51bGw7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvYnJ1c2hTZWxlY3RvcnMuanMKdmFyIHNlbGVjdEJydXNoU2V0dGluZ3MgPSAoc3RhdGUpID0+IHN0YXRlLmJydXNoOwp2YXIgc2VsZWN0QnJ1c2hEaW1lbnNpb25zID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJydXNoU2V0dGluZ3MsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdE1hcmdpbl0sIChicnVzaFNldHRpbmdzLCBvZmZzZXQsIG1hcmdpbikgPT4gKHsKICBoZWlnaHQ6IGJydXNoU2V0dGluZ3MuaGVpZ2h0LAogIHg6IGlzTnVtYmVyKGJydXNoU2V0dGluZ3MueCkgPyBicnVzaFNldHRpbmdzLnggOiBvZmZzZXQubGVmdCwKICB5OiBpc051bWJlcihicnVzaFNldHRpbmdzLnkpID8gYnJ1c2hTZXR0aW5ncy55IDogb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQgKyBvZmZzZXQuYnJ1c2hCb3R0b20gLSAoKG1hcmdpbiA9PT0gbnVsbCB8fCBtYXJnaW4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IG1hcmdpbi5ib3R0b20pIHx8IDApLAogIHdpZHRoOiBpc051bWJlcihicnVzaFNldHRpbmdzLndpZHRoKSA/IGJydXNoU2V0dGluZ3Mud2lkdGggOiBvZmZzZXQud2lkdGgKfSkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1Jlc3BvbnNpdmVDb250YWluZXIuanMKdmFyIFJlYWN0NCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDEyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3Rocm90dGxlID0gX190b0VTTShyZXF1aXJlX3Rocm90dGxlMigpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvTG9nVXRpbHMuanMKdmFyIGlzRGV2ID0gdHJ1ZTsKdmFyIHdhcm4gPSBmdW5jdGlvbiB3YXJuMihjb25kaXRpb24sIGZvcm1hdDIpIHsKICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuID4gMiA/IF9sZW4gLSAyIDogMCksIF9rZXkgPSAyOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICBhcmdzW19rZXkgLSAyXSA9IGFyZ3VtZW50c1tfa2V5XTsKICB9CiAgaWYgKGlzRGV2ICYmIHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiBjb25zb2xlLndhcm4pIHsKICAgIGlmIChmb3JtYXQyID09PSB2b2lkIDApIHsKICAgICAgY29uc29sZS53YXJuKCJMb2dVdGlscyByZXF1aXJlcyBhbiBlcnJvciBtZXNzYWdlIGFyZ3VtZW50Iik7CiAgICB9CiAgICBpZiAoIWNvbmRpdGlvbikgewogICAgICBpZiAoZm9ybWF0MiA9PT0gdm9pZCAwKSB7CiAgICAgICAgY29uc29sZS53YXJuKCJNaW5pZmllZCBleGNlcHRpb24gb2NjdXJyZWQ7IHVzZSB0aGUgbm9uLW1pbmlmaWVkIGRldiBlbnZpcm9ubWVudCBmb3IgdGhlIGZ1bGwgZXJyb3IgbWVzc2FnZSBhbmQgYWRkaXRpb25hbCBoZWxwZnVsIHdhcm5pbmdzLiIpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBhcmdJbmRleCA9IDA7CiAgICAgICAgY29uc29sZS53YXJuKGZvcm1hdDIucmVwbGFjZSgvJXMvZywgKCkgPT4gYXJnc1thcmdJbmRleCsrXSkpOwogICAgICB9CiAgICB9CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L3Jlc3BvbnNpdmVDb250YWluZXJVdGlscy5qcwp2YXIgY2FsY3VsYXRlQ2hhcnREaW1lbnNpb25zID0gKGNvbnRhaW5lcldpZHRoLCBjb250YWluZXJIZWlnaHQsIHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoID0gIjEwMCUiLAogICAgaGVpZ2h0ID0gIjEwMCUiLAogICAgYXNwZWN0LAogICAgbWF4SGVpZ2h0CiAgfSA9IHByb3BzOwogIHZhciBjYWxjdWxhdGVkV2lkdGggPSBpc1BlcmNlbnQod2lkdGgpID8gY29udGFpbmVyV2lkdGggOiBOdW1iZXIod2lkdGgpOwogIHZhciBjYWxjdWxhdGVkSGVpZ2h0ID0gaXNQZXJjZW50KGhlaWdodCkgPyBjb250YWluZXJIZWlnaHQgOiBOdW1iZXIoaGVpZ2h0KTsKICBpZiAoYXNwZWN0ICYmIGFzcGVjdCA+IDApIHsKICAgIGlmIChjYWxjdWxhdGVkV2lkdGgpIHsKICAgICAgY2FsY3VsYXRlZEhlaWdodCA9IGNhbGN1bGF0ZWRXaWR0aCAvIGFzcGVjdDsKICAgIH0gZWxzZSBpZiAoY2FsY3VsYXRlZEhlaWdodCkgewogICAgICBjYWxjdWxhdGVkV2lkdGggPSBjYWxjdWxhdGVkSGVpZ2h0ICogYXNwZWN0OwogICAgfQogICAgaWYgKG1heEhlaWdodCAmJiBjYWxjdWxhdGVkSGVpZ2h0ICE9IG51bGwgJiYgY2FsY3VsYXRlZEhlaWdodCA+IG1heEhlaWdodCkgewogICAgICBjYWxjdWxhdGVkSGVpZ2h0ID0gbWF4SGVpZ2h0OwogICAgfQogIH0KICByZXR1cm4gewogICAgY2FsY3VsYXRlZFdpZHRoLAogICAgY2FsY3VsYXRlZEhlaWdodAogIH07Cn07CnZhciBib3RoT3ZlcmZsb3cgPSB7CiAgd2lkdGg6IDAsCiAgaGVpZ2h0OiAwLAogIG92ZXJmbG93OiAidmlzaWJsZSIKfTsKdmFyIG92ZXJmbG93WCA9IHsKICB3aWR0aDogMCwKICBvdmVyZmxvd1g6ICJ2aXNpYmxlIgp9Owp2YXIgb3ZlcmZsb3dZID0gewogIGhlaWdodDogMCwKICBvdmVyZmxvd1k6ICJ2aXNpYmxlIgp9Owp2YXIgbm9TdHlsZSA9IHt9Owp2YXIgZ2V0SW5uZXJEaXZTdHlsZSA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBwcm9wczsKICB2YXIgaXNXaWR0aFBlcmNlbnQgPSBpc1BlcmNlbnQod2lkdGgpOwogIHZhciBpc0hlaWdodFBlcmNlbnQgPSBpc1BlcmNlbnQoaGVpZ2h0KTsKICBpZiAoaXNXaWR0aFBlcmNlbnQgJiYgaXNIZWlnaHRQZXJjZW50KSB7CiAgICByZXR1cm4gYm90aE92ZXJmbG93OwogIH0KICBpZiAoaXNXaWR0aFBlcmNlbnQpIHsKICAgIHJldHVybiBvdmVyZmxvd1g7CiAgfQogIGlmIChpc0hlaWdodFBlcmNlbnQpIHsKICAgIHJldHVybiBvdmVyZmxvd1k7CiAgfQogIHJldHVybiBub1N0eWxlOwp9OwpmdW5jdGlvbiBnZXREZWZhdWx0V2lkdGhBbmRIZWlnaHQoX3JlZjIpIHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBhc3BlY3QKICB9ID0gX3JlZjI7CiAgdmFyIGNhbGN1bGF0ZWRXaWR0aCA9IHdpZHRoOwogIHZhciBjYWxjdWxhdGVkSGVpZ2h0ID0gaGVpZ2h0OwogIGlmIChjYWxjdWxhdGVkV2lkdGggPT09IHZvaWQgMCAmJiBjYWxjdWxhdGVkSGVpZ2h0ID09PSB2b2lkIDApIHsKICAgIGNhbGN1bGF0ZWRXaWR0aCA9ICIxMDAlIjsKICAgIGNhbGN1bGF0ZWRIZWlnaHQgPSAiMTAwJSI7CiAgfSBlbHNlIGlmIChjYWxjdWxhdGVkV2lkdGggPT09IHZvaWQgMCkgewogICAgY2FsY3VsYXRlZFdpZHRoID0gYXNwZWN0ICYmIGFzcGVjdCA+IDAgPyB2b2lkIDAgOiAiMTAwJSI7CiAgfSBlbHNlIGlmIChjYWxjdWxhdGVkSGVpZ2h0ID09PSB2b2lkIDApIHsKICAgIGNhbGN1bGF0ZWRIZWlnaHQgPSBhc3BlY3QgJiYgYXNwZWN0ID4gMCA/IHZvaWQgMCA6ICIxMDAlIjsKICB9CiAgcmV0dXJuIHsKICAgIHdpZHRoOiBjYWxjdWxhdGVkV2lkdGgsCiAgICBoZWlnaHQ6IGNhbGN1bGF0ZWRIZWlnaHQKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2lzV2VsbEJlaGF2ZWROdW1iZXIuanMKZnVuY3Rpb24gaXNXZWxsQmVoYXZlZE51bWJlcihuKSB7CiAgcmV0dXJuIE51bWJlci5pc0Zpbml0ZShuKTsKfQpmdW5jdGlvbiBpc1Bvc2l0aXZlTnVtYmVyKG4pIHsKICByZXR1cm4gdHlwZW9mIG4gPT09ICJudW1iZXIiICYmIG4gPiAwICYmIE51bWJlci5pc0Zpbml0ZShuKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1Jlc3BvbnNpdmVDb250YWluZXIuanMKZnVuY3Rpb24gX2V4dGVuZHMzKCkgewogIHJldHVybiBfZXh0ZW5kczMgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczMuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzNChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDQoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXM0KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHk0KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czQoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTQoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXk0KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTQodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlNCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmU0KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDEyLmNyZWF0ZUNvbnRleHQpKHsKICB3aWR0aDogLTEsCiAgaGVpZ2h0OiAtMQp9KTsKZnVuY3Rpb24gaXNBY2NlcHRhYmxlU2l6ZShzaXplKSB7CiAgcmV0dXJuIGlzUG9zaXRpdmVOdW1iZXIoc2l6ZS53aWR0aCkgJiYgaXNQb3NpdGl2ZU51bWJlcihzaXplLmhlaWdodCk7Cn0KZnVuY3Rpb24gUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHRQcm92aWRlcihfcmVmMikgewogIHZhciB7CiAgICBjaGlsZHJlbiwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IF9yZWYyOwogIHZhciBzaXplID0gKDAsIGltcG9ydF9yZWFjdDEyLnVzZU1lbW8pKCgpID0+ICh7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0pLCBbd2lkdGgsIGhlaWdodF0pOwogIGlmICghaXNBY2NlcHRhYmxlU2l6ZShzaXplKSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q0LmNyZWF0ZUVsZW1lbnQoUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQuUHJvdmlkZXIsIHsKICAgIHZhbHVlOiBzaXplCiAgfSwgY2hpbGRyZW4pOwp9CnZhciB1c2VSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCA9ICgpID0+ICgwLCBpbXBvcnRfcmVhY3QxMi51c2VDb250ZXh0KShSZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dCk7CnZhciBTaXplRGV0ZWN0b3JDb250YWluZXIgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDEyLmZvcndhcmRSZWYpKChfcmVmMiwgcmVmKSA9PiB7CiAgdmFyIHsKICAgIGFzcGVjdCwKICAgIGluaXRpYWxEaW1lbnNpb24gPSB7CiAgICAgIHdpZHRoOiAtMSwKICAgICAgaGVpZ2h0OiAtMQogICAgfSwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgLyoKICAgICAqIGRlZmF1bHQgbWluLXdpZHRoIHRvIDAgaWYgbm90IHNwZWNpZmllZCAtICdhdXRvJyBjYXVzZXMgaXNzdWVzIHdpdGggZmxleGJveAogICAgICogaHR0cHM6Ly9naXRodWIuY29tL3JlY2hhcnRzL3JlY2hhcnRzL2lzc3Vlcy8xNzIKICAgICAqLwogICAgbWluV2lkdGggPSAwLAogICAgbWluSGVpZ2h0LAogICAgbWF4SGVpZ2h0LAogICAgY2hpbGRyZW4sCiAgICBkZWJvdW5jZSA9IDAsCiAgICBpZCwKICAgIGNsYXNzTmFtZSwKICAgIG9uUmVzaXplLAogICAgc3R5bGUgPSB7fQogIH0gPSBfcmVmMjsKICB2YXIgY29udGFpbmVyUmVmID0gKDAsIGltcG9ydF9yZWFjdDEyLnVzZVJlZikobnVsbCk7CiAgdmFyIG9uUmVzaXplUmVmID0gKDAsIGltcG9ydF9yZWFjdDEyLnVzZVJlZikoKTsKICBvblJlc2l6ZVJlZi5jdXJyZW50ID0gb25SZXNpemU7CiAgKDAsIGltcG9ydF9yZWFjdDEyLnVzZUltcGVyYXRpdmVIYW5kbGUpKHJlZiwgKCkgPT4gY29udGFpbmVyUmVmLmN1cnJlbnQpOwogIHZhciBbc2l6ZXMsIHNldFNpemVzXSA9ICgwLCBpbXBvcnRfcmVhY3QxMi51c2VTdGF0ZSkoewogICAgY29udGFpbmVyV2lkdGg6IGluaXRpYWxEaW1lbnNpb24ud2lkdGgsCiAgICBjb250YWluZXJIZWlnaHQ6IGluaXRpYWxEaW1lbnNpb24uaGVpZ2h0CiAgfSk7CiAgdmFyIHNldENvbnRhaW5lclNpemUgPSAoMCwgaW1wb3J0X3JlYWN0MTIudXNlQ2FsbGJhY2spKChuZXdXaWR0aCwgbmV3SGVpZ2h0KSA9PiB7CiAgICBzZXRTaXplcygocHJldlN0YXRlKSA9PiB7CiAgICAgIHZhciByb3VuZGVkV2lkdGggPSBNYXRoLnJvdW5kKG5ld1dpZHRoKTsKICAgICAgdmFyIHJvdW5kZWRIZWlnaHQgPSBNYXRoLnJvdW5kKG5ld0hlaWdodCk7CiAgICAgIGlmIChwcmV2U3RhdGUuY29udGFpbmVyV2lkdGggPT09IHJvdW5kZWRXaWR0aCAmJiBwcmV2U3RhdGUuY29udGFpbmVySGVpZ2h0ID09PSByb3VuZGVkSGVpZ2h0KSB7CiAgICAgICAgcmV0dXJuIHByZXZTdGF0ZTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGNvbnRhaW5lcldpZHRoOiByb3VuZGVkV2lkdGgsCiAgICAgICAgY29udGFpbmVySGVpZ2h0OiByb3VuZGVkSGVpZ2h0CiAgICAgIH07CiAgICB9KTsKICB9LCBbXSk7CiAgKDAsIGltcG9ydF9yZWFjdDEyLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKGNvbnRhaW5lclJlZi5jdXJyZW50ID09IG51bGwgfHwgdHlwZW9mIFJlc2l6ZU9ic2VydmVyID09PSAidW5kZWZpbmVkIikgewogICAgICByZXR1cm4gbm9vcDsKICAgIH0KICAgIHZhciBjYWxsYmFjayA9IChlbnRyaWVzKSA9PiB7CiAgICAgIHZhciBfb25SZXNpemVSZWYkY3VycmVudDsKICAgICAgdmFyIHsKICAgICAgICB3aWR0aDogY29udGFpbmVyV2lkdGgzLAogICAgICAgIGhlaWdodDogY29udGFpbmVySGVpZ2h0MwogICAgICB9ID0gZW50cmllc1swXS5jb250ZW50UmVjdDsKICAgICAgc2V0Q29udGFpbmVyU2l6ZShjb250YWluZXJXaWR0aDMsIGNvbnRhaW5lckhlaWdodDMpOwogICAgICAoX29uUmVzaXplUmVmJGN1cnJlbnQgPSBvblJlc2l6ZVJlZi5jdXJyZW50KSA9PT0gbnVsbCB8fCBfb25SZXNpemVSZWYkY3VycmVudCA9PT0gdm9pZCAwIHx8IF9vblJlc2l6ZVJlZiRjdXJyZW50LmNhbGwob25SZXNpemVSZWYsIGNvbnRhaW5lcldpZHRoMywgY29udGFpbmVySGVpZ2h0Myk7CiAgICB9OwogICAgaWYgKGRlYm91bmNlID4gMCkgewogICAgICBjYWxsYmFjayA9ICgwLCBpbXBvcnRfdGhyb3R0bGUuZGVmYXVsdCkoY2FsbGJhY2ssIGRlYm91bmNlLCB7CiAgICAgICAgdHJhaWxpbmc6IHRydWUsCiAgICAgICAgbGVhZGluZzogZmFsc2UKICAgICAgfSk7CiAgICB9CiAgICB2YXIgb2JzZXJ2ZXIgPSBuZXcgUmVzaXplT2JzZXJ2ZXIoY2FsbGJhY2spOwogICAgdmFyIHsKICAgICAgd2lkdGg6IGNvbnRhaW5lcldpZHRoMiwKICAgICAgaGVpZ2h0OiBjb250YWluZXJIZWlnaHQyCiAgICB9ID0gY29udGFpbmVyUmVmLmN1cnJlbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICBzZXRDb250YWluZXJTaXplKGNvbnRhaW5lcldpZHRoMiwgY29udGFpbmVySGVpZ2h0Mik7CiAgICBvYnNlcnZlci5vYnNlcnZlKGNvbnRhaW5lclJlZi5jdXJyZW50KTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIG9ic2VydmVyLmRpc2Nvbm5lY3QoKTsKICAgIH07CiAgfSwgW3NldENvbnRhaW5lclNpemUsIGRlYm91bmNlXSk7CiAgdmFyIHsKICAgIGNvbnRhaW5lcldpZHRoLAogICAgY29udGFpbmVySGVpZ2h0CiAgfSA9IHNpemVzOwogIHdhcm4oIWFzcGVjdCB8fCBhc3BlY3QgPiAwLCAiVGhlIGFzcGVjdCglcykgbXVzdCBiZSBncmVhdGVyIHRoYW4gemVyby4iLCBhc3BlY3QpOwogIHZhciB7CiAgICBjYWxjdWxhdGVkV2lkdGgsCiAgICBjYWxjdWxhdGVkSGVpZ2h0CiAgfSA9IGNhbGN1bGF0ZUNoYXJ0RGltZW5zaW9ucyhjb250YWluZXJXaWR0aCwgY29udGFpbmVySGVpZ2h0LCB7CiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIGFzcGVjdCwKICAgIG1heEhlaWdodAogIH0pOwogIHdhcm4oY2FsY3VsYXRlZFdpZHRoICE9IG51bGwgJiYgY2FsY3VsYXRlZFdpZHRoID4gMCB8fCBjYWxjdWxhdGVkSGVpZ2h0ICE9IG51bGwgJiYgY2FsY3VsYXRlZEhlaWdodCA+IDAsICJUaGUgd2lkdGgoJXMpIGFuZCBoZWlnaHQoJXMpIG9mIGNoYXJ0IHNob3VsZCBiZSBncmVhdGVyIHRoYW4gMCxcbiAgICAgICBwbGVhc2UgY2hlY2sgdGhlIHN0eWxlIG9mIGNvbnRhaW5lciwgb3IgdGhlIHByb3BzIHdpZHRoKCVzKSBhbmQgaGVpZ2h0KCVzKSxcbiAgICAgICBvciBhZGQgYSBtaW5XaWR0aCglcykgb3IgbWluSGVpZ2h0KCVzKSBvciB1c2UgYXNwZWN0KCVzKSB0byBjb250cm9sIHRoZVxuICAgICAgIGhlaWdodCBhbmQgd2lkdGguIiwgY2FsY3VsYXRlZFdpZHRoLCBjYWxjdWxhdGVkSGVpZ2h0LCB3aWR0aCwgaGVpZ2h0LCBtaW5XaWR0aCwgbWluSGVpZ2h0LCBhc3BlY3QpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q0LmNyZWF0ZUVsZW1lbnQoImRpdiIsIHsKICAgIGlkOiBpZCA/ICIiLmNvbmNhdChpZCkgOiB2b2lkIDAsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLXJlc3BvbnNpdmUtY29udGFpbmVyIiwgY2xhc3NOYW1lKSwKICAgIHN0eWxlOiBfb2JqZWN0U3ByZWFkNChfb2JqZWN0U3ByZWFkNCh7fSwgc3R5bGUpLCB7fSwgewogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0LAogICAgICBtaW5XaWR0aCwKICAgICAgbWluSGVpZ2h0LAogICAgICBtYXhIZWlnaHQKICAgIH0pLAogICAgcmVmOiBjb250YWluZXJSZWYKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3Q0LmNyZWF0ZUVsZW1lbnQoImRpdiIsIHsKICAgIHN0eWxlOiBnZXRJbm5lckRpdlN0eWxlKHsKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfSkKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3Q0LmNyZWF0ZUVsZW1lbnQoUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHRQcm92aWRlciwgewogICAgd2lkdGg6IGNhbGN1bGF0ZWRXaWR0aCwKICAgIGhlaWdodDogY2FsY3VsYXRlZEhlaWdodAogIH0sIGNoaWxkcmVuKSkpOwp9KTsKdmFyIFJlc3BvbnNpdmVDb250YWluZXIgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDEyLmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHJlc3BvbnNpdmVDb250YWluZXJDb250ZXh0ID0gdXNlUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQoKTsKICBpZiAoaXNQb3NpdGl2ZU51bWJlcihyZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dC53aWR0aCkgJiYgaXNQb3NpdGl2ZU51bWJlcihyZXNwb25zaXZlQ29udGFpbmVyQ29udGV4dC5oZWlnaHQpKSB7CiAgICByZXR1cm4gcHJvcHMuY2hpbGRyZW47CiAgfQogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBnZXREZWZhdWx0V2lkdGhBbmRIZWlnaHQoewogICAgd2lkdGg6IHByb3BzLndpZHRoLAogICAgaGVpZ2h0OiBwcm9wcy5oZWlnaHQsCiAgICBhc3BlY3Q6IHByb3BzLmFzcGVjdAogIH0pOwogIHZhciB7CiAgICBjYWxjdWxhdGVkV2lkdGgsCiAgICBjYWxjdWxhdGVkSGVpZ2h0CiAgfSA9IGNhbGN1bGF0ZUNoYXJ0RGltZW5zaW9ucyh2b2lkIDAsIHZvaWQgMCwgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBhc3BlY3Q6IHByb3BzLmFzcGVjdCwKICAgIG1heEhlaWdodDogcHJvcHMubWF4SGVpZ2h0CiAgfSk7CiAgaWYgKGlzTnVtYmVyKGNhbGN1bGF0ZWRXaWR0aCkgJiYgaXNOdW1iZXIoY2FsY3VsYXRlZEhlaWdodCkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q0LmNyZWF0ZUVsZW1lbnQoUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHRQcm92aWRlciwgewogICAgICB3aWR0aDogY2FsY3VsYXRlZFdpZHRoLAogICAgICBoZWlnaHQ6IGNhbGN1bGF0ZWRIZWlnaHQKICAgIH0sIHByb3BzLmNoaWxkcmVuKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDQuY3JlYXRlRWxlbWVudChTaXplRGV0ZWN0b3JDb250YWluZXIsIF9leHRlbmRzMyh7fSwgcHJvcHMsIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgcmVmCiAgfSkpOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvY2hhcnRMYXlvdXRDb250ZXh0LmpzCmZ1bmN0aW9uIGNhcnRlc2lhblZpZXdCb3hUb1RyYXBlem9pZChib3gpIHsKICBpZiAoIWJveCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIHsKICAgIHg6IGJveC54LAogICAgeTogYm94LnksCiAgICB1cHBlcldpZHRoOiAidXBwZXJXaWR0aCIgaW4gYm94ID8gYm94LnVwcGVyV2lkdGggOiBib3gud2lkdGgsCiAgICBsb3dlcldpZHRoOiAibG93ZXJXaWR0aCIgaW4gYm94ID8gYm94Lmxvd2VyV2lkdGggOiBib3gud2lkdGgsCiAgICB3aWR0aDogYm94LndpZHRoLAogICAgaGVpZ2h0OiBib3guaGVpZ2h0CiAgfTsKfQp2YXIgdXNlVmlld0JveCA9ICgpID0+IHsKICB2YXIgX3VzZUFwcFNlbGVjdG9yOwogIHZhciBwYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgcm9vdFZpZXdCb3ggPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RDaGFydFZpZXdCb3gpOwogIHZhciBicnVzaERpbWVuc2lvbnMgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RCcnVzaERpbWVuc2lvbnMpOwogIHZhciBicnVzaFBhZGRpbmcgPSAoX3VzZUFwcFNlbGVjdG9yID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0QnJ1c2hTZXR0aW5ncykpID09PSBudWxsIHx8IF91c2VBcHBTZWxlY3RvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3VzZUFwcFNlbGVjdG9yLnBhZGRpbmc7CiAgaWYgKCFwYW5vcmFtYSB8fCAhYnJ1c2hEaW1lbnNpb25zIHx8ICFicnVzaFBhZGRpbmcpIHsKICAgIHJldHVybiByb290Vmlld0JveDsKICB9CiAgcmV0dXJuIHsKICAgIHdpZHRoOiBicnVzaERpbWVuc2lvbnMud2lkdGggLSBicnVzaFBhZGRpbmcubGVmdCAtIGJydXNoUGFkZGluZy5yaWdodCwKICAgIGhlaWdodDogYnJ1c2hEaW1lbnNpb25zLmhlaWdodCAtIGJydXNoUGFkZGluZy50b3AgLSBicnVzaFBhZGRpbmcuYm90dG9tLAogICAgeDogYnJ1c2hQYWRkaW5nLmxlZnQsCiAgICB5OiBicnVzaFBhZGRpbmcudG9wCiAgfTsKfTsKdmFyIG1hbnlDb21wb25lbnRzVGhyb3dFcnJvcnNJZk9mZnNldElzVW5kZWZpbmVkID0gewogIHRvcDogMCwKICBib3R0b206IDAsCiAgbGVmdDogMCwKICByaWdodDogMCwKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgYnJ1c2hCb3R0b206IDAKfTsKdmFyIHVzZU9mZnNldEludGVybmFsID0gKCkgPT4gewogIHZhciBfdXNlQXBwU2VsZWN0b3IyOwogIHJldHVybiAoX3VzZUFwcFNlbGVjdG9yMiA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwpKSAhPT0gbnVsbCAmJiBfdXNlQXBwU2VsZWN0b3IyICE9PSB2b2lkIDAgPyBfdXNlQXBwU2VsZWN0b3IyIDogbWFueUNvbXBvbmVudHNUaHJvd0Vycm9yc0lmT2Zmc2V0SXNVbmRlZmluZWQ7Cn07CnZhciB1c2VDaGFydFdpZHRoID0gKCkgPT4gewogIHJldHVybiB1c2VBcHBTZWxlY3RvcihzZWxlY3RDaGFydFdpZHRoKTsKfTsKdmFyIHVzZUNoYXJ0SGVpZ2h0ID0gKCkgPT4gewogIHJldHVybiB1c2VBcHBTZWxlY3RvcihzZWxlY3RDaGFydEhlaWdodCk7Cn07CnZhciBzZWxlY3RDaGFydExheW91dCA9IChzdGF0ZSkgPT4gc3RhdGUubGF5b3V0LmxheW91dFR5cGU7CnZhciB1c2VDaGFydExheW91dCA9ICgpID0+IHVzZUFwcFNlbGVjdG9yKHNlbGVjdENoYXJ0TGF5b3V0KTsKdmFyIHVzZUNhcnRlc2lhbkNoYXJ0TGF5b3V0ID0gKCkgPT4gewogIHZhciBsYXlvdXQgPSB1c2VDaGFydExheW91dCgpOwogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIiB8fCBsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgIHJldHVybiBsYXlvdXQ7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciB1c2VJc0luQ2hhcnRDb250ZXh0ID0gKCkgPT4gewogIHZhciBsYXlvdXQgPSB1c2VDaGFydExheW91dCgpOwogIHJldHVybiBsYXlvdXQgIT09IHZvaWQgMDsKfTsKdmFyIFJlcG9ydENoYXJ0U2l6ZSA9IChwcm9wcykgPT4gewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHsKICAgIHdpZHRoOiB3aWR0aEZyb21Qcm9wcywKICAgIGhlaWdodDogaGVpZ2h0RnJvbVByb3BzCiAgfSA9IHByb3BzOwogIHZhciByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zID0gdXNlUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQoKTsKICB2YXIgd2lkdGggPSB3aWR0aEZyb21Qcm9wczsKICB2YXIgaGVpZ2h0ID0gaGVpZ2h0RnJvbVByb3BzOwogIGlmIChyZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zKSB7CiAgICB3aWR0aCA9IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMud2lkdGggPiAwID8gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy53aWR0aCA6IHdpZHRoRnJvbVByb3BzOwogICAgaGVpZ2h0ID0gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy5oZWlnaHQgPiAwID8gcmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucy5oZWlnaHQgOiBoZWlnaHRGcm9tUHJvcHM7CiAgfQogICgwLCBpbXBvcnRfcmVhY3QxMy51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmICghaXNQYW5vcmFtYSAmJiBpc1Bvc2l0aXZlTnVtYmVyKHdpZHRoKSAmJiBpc1Bvc2l0aXZlTnVtYmVyKGhlaWdodCkpIHsKICAgICAgZGlzcGF0Y2goc2V0Q2hhcnRTaXplKHsKICAgICAgICB3aWR0aCwKICAgICAgICBoZWlnaHQKICAgICAgfSkpOwogICAgfQogIH0sIFtkaXNwYXRjaCwgaXNQYW5vcmFtYSwgd2lkdGgsIGhlaWdodF0pOwogIHJldHVybiBudWxsOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2ltbWVyQDEwLjIuMC9ub2RlX21vZHVsZXMvaW1tZXIvZGlzdC9pbW1lci5tanMKdmFyIE5PVEhJTkcyID0gU3ltYm9sLmZvcigiaW1tZXItbm90aGluZyIpOwp2YXIgRFJBRlRBQkxFMiA9IFN5bWJvbC5mb3IoImltbWVyLWRyYWZ0YWJsZSIpOwp2YXIgRFJBRlRfU1RBVEUyID0gU3ltYm9sLmZvcigiaW1tZXItc3RhdGUiKTsKdmFyIGVycm9yczIgPSB0cnVlID8gWwogIC8vIEFsbCBlcnJvciBjb2Rlcywgc3RhcnRpbmcgYnkgMDoKICBmdW5jdGlvbihwbHVnaW4pIHsKICAgIHJldHVybiBgVGhlIHBsdWdpbiBmb3IgJyR7cGx1Z2lufScgaGFzIG5vdCBiZWVuIGxvYWRlZCBpbnRvIEltbWVyLiBUbyBlbmFibGUgdGhlIHBsdWdpbiwgaW1wb3J0IGFuZCBjYWxsIFxgZW5hYmxlJHtwbHVnaW59KClcYCB3aGVuIGluaXRpYWxpemluZyB5b3VyIGFwcGxpY2F0aW9uLmA7CiAgfSwKICBmdW5jdGlvbih0aGluZykgewogICAgcmV0dXJuIGBwcm9kdWNlIGNhbiBvbmx5IGJlIGNhbGxlZCBvbiB0aGluZ3MgdGhhdCBhcmUgZHJhZnRhYmxlOiBwbGFpbiBvYmplY3RzLCBhcnJheXMsIE1hcCwgU2V0IG9yIGNsYXNzZXMgdGhhdCBhcmUgbWFya2VkIHdpdGggJ1tpbW1lcmFibGVdOiB0cnVlJy4gR290ICcke3RoaW5nfSdgOwogIH0sCiAgIlRoaXMgb2JqZWN0IGhhcyBiZWVuIGZyb3plbiBhbmQgc2hvdWxkIG5vdCBiZSBtdXRhdGVkIiwKICBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gIkNhbm5vdCB1c2UgYSBwcm94eSB0aGF0IGhhcyBiZWVuIHJldm9rZWQuIERpZCB5b3UgcGFzcyBhbiBvYmplY3QgZnJvbSBpbnNpZGUgYW4gaW1tZXIgZnVuY3Rpb24gdG8gYW4gYXN5bmMgcHJvY2Vzcz8gIiArIGRhdGE7CiAgfSwKICAiQW4gaW1tZXIgcHJvZHVjZXIgcmV0dXJuZWQgYSBuZXcgdmFsdWUgKmFuZCogbW9kaWZpZWQgaXRzIGRyYWZ0LiBFaXRoZXIgcmV0dXJuIGEgbmV3IHZhbHVlICpvciogbW9kaWZ5IHRoZSBkcmFmdC4iLAogICJJbW1lciBmb3JiaWRzIGNpcmN1bGFyIHJlZmVyZW5jZXMiLAogICJUaGUgZmlyc3Qgb3Igc2Vjb25kIGFyZ3VtZW50IHRvIGBwcm9kdWNlYCBtdXN0IGJlIGEgZnVuY3Rpb24iLAogICJUaGUgdGhpcmQgYXJndW1lbnQgdG8gYHByb2R1Y2VgIG11c3QgYmUgYSBmdW5jdGlvbiBvciB1bmRlZmluZWQiLAogICJGaXJzdCBhcmd1bWVudCB0byBgY3JlYXRlRHJhZnRgIG11c3QgYmUgYSBwbGFpbiBvYmplY3QsIGFuIGFycmF5LCBvciBhbiBpbW1lcmFibGUgb2JqZWN0IiwKICAiRmlyc3QgYXJndW1lbnQgdG8gYGZpbmlzaERyYWZ0YCBtdXN0IGJlIGEgZHJhZnQgcmV0dXJuZWQgYnkgYGNyZWF0ZURyYWZ0YCIsCiAgZnVuY3Rpb24odGhpbmcpIHsKICAgIHJldHVybiBgJ2N1cnJlbnQnIGV4cGVjdHMgYSBkcmFmdCwgZ290OiAke3RoaW5nfWA7CiAgfSwKICAiT2JqZWN0LmRlZmluZVByb3BlcnR5KCkgY2Fubm90IGJlIHVzZWQgb24gYW4gSW1tZXIgZHJhZnQiLAogICJPYmplY3Quc2V0UHJvdG90eXBlT2YoKSBjYW5ub3QgYmUgdXNlZCBvbiBhbiBJbW1lciBkcmFmdCIsCiAgIkltbWVyIG9ubHkgc3VwcG9ydHMgZGVsZXRpbmcgYXJyYXkgaW5kaWNlcyIsCiAgIkltbWVyIG9ubHkgc3VwcG9ydHMgc2V0dGluZyBhcnJheSBpbmRpY2VzIGFuZCB0aGUgJ2xlbmd0aCcgcHJvcGVydHkiLAogIGZ1bmN0aW9uKHRoaW5nKSB7CiAgICByZXR1cm4gYCdvcmlnaW5hbCcgZXhwZWN0cyBhIGRyYWZ0LCBnb3Q6ICR7dGhpbmd9YDsKICB9CiAgLy8gTm90ZTogaWYgbW9yZSBlcnJvcnMgYXJlIGFkZGVkLCB0aGUgZXJyb3JPZmZzZXQgaW4gUGF0Y2hlcy50cyBzaG91bGQgYmUgaW5jcmVhc2VkCiAgLy8gU2VlIFBhdGNoZXMudHMgZm9yIGFkZGl0aW9uYWwgZXJyb3JzCl0gOiBbXTsKZnVuY3Rpb24gZGllMihlcnJvciwgLi4uYXJncykgewogIGlmICh0cnVlKSB7CiAgICBjb25zdCBlID0gZXJyb3JzMltlcnJvcl07CiAgICBjb25zdCBtc2cgPSB0eXBlb2YgZSA9PT0gImZ1bmN0aW9uIiA/IGUuYXBwbHkobnVsbCwgYXJncykgOiBlOwogICAgdGhyb3cgbmV3IEVycm9yKGBbSW1tZXJdICR7bXNnfWApOwogIH0KICB0aHJvdyBuZXcgRXJyb3IoCiAgICBgW0ltbWVyXSBtaW5pZmllZCBlcnJvciBucjogJHtlcnJvcn0uIEZ1bGwgZXJyb3IgYXQ6IGh0dHBzOi8vYml0Lmx5LzNjWEVLV2ZgCiAgKTsKfQp2YXIgZ2V0UHJvdG90eXBlT2YyID0gT2JqZWN0LmdldFByb3RvdHlwZU9mOwpmdW5jdGlvbiBpc0RyYWZ0Mih2YWx1ZSkgewogIHJldHVybiAhIXZhbHVlICYmICEhdmFsdWVbRFJBRlRfU1RBVEUyXTsKfQpmdW5jdGlvbiBpc0RyYWZ0YWJsZTIodmFsdWUpIHsKICBpZiAoIXZhbHVlKQogICAgcmV0dXJuIGZhbHNlOwogIHJldHVybiBpc1BsYWluT2JqZWN0Myh2YWx1ZSkgfHwgQXJyYXkuaXNBcnJheSh2YWx1ZSkgfHwgISF2YWx1ZVtEUkFGVEFCTEUyXSB8fCAhIXZhbHVlLmNvbnN0cnVjdG9yPy5bRFJBRlRBQkxFMl0gfHwgaXNNYXAyKHZhbHVlKSB8fCBpc1NldDIodmFsdWUpOwp9CnZhciBvYmplY3RDdG9yU3RyaW5nMiA9IE9iamVjdC5wcm90b3R5cGUuY29uc3RydWN0b3IudG9TdHJpbmcoKTsKdmFyIGNhY2hlZEN0b3JTdHJpbmdzMiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgV2Vha01hcCgpOwpmdW5jdGlvbiBpc1BsYWluT2JqZWN0Myh2YWx1ZSkgewogIGlmICghdmFsdWUgfHwgdHlwZW9mIHZhbHVlICE9PSAib2JqZWN0IikKICAgIHJldHVybiBmYWxzZTsKICBjb25zdCBwcm90bzIgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodmFsdWUpOwogIGlmIChwcm90bzIgPT09IG51bGwgfHwgcHJvdG8yID09PSBPYmplY3QucHJvdG90eXBlKQogICAgcmV0dXJuIHRydWU7CiAgY29uc3QgQ3RvciA9IE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb3RvMiwgImNvbnN0cnVjdG9yIikgJiYgcHJvdG8yLmNvbnN0cnVjdG9yOwogIGlmIChDdG9yID09PSBPYmplY3QpCiAgICByZXR1cm4gdHJ1ZTsKICBpZiAodHlwZW9mIEN0b3IgIT09ICJmdW5jdGlvbiIpCiAgICByZXR1cm4gZmFsc2U7CiAgbGV0IGN0b3JTdHJpbmcgPSBjYWNoZWRDdG9yU3RyaW5nczIuZ2V0KEN0b3IpOwogIGlmIChjdG9yU3RyaW5nID09PSB2b2lkIDApIHsKICAgIGN0b3JTdHJpbmcgPSBGdW5jdGlvbi50b1N0cmluZy5jYWxsKEN0b3IpOwogICAgY2FjaGVkQ3RvclN0cmluZ3MyLnNldChDdG9yLCBjdG9yU3RyaW5nKTsKICB9CiAgcmV0dXJuIGN0b3JTdHJpbmcgPT09IG9iamVjdEN0b3JTdHJpbmcyOwp9CmZ1bmN0aW9uIGVhY2gyKG9iaiwgaXRlciwgc3RyaWN0ID0gdHJ1ZSkgewogIGlmIChnZXRBcmNodHlwZTIob2JqKSA9PT0gMCkgewogICAgY29uc3Qga2V5cyA9IHN0cmljdCA/IFJlZmxlY3Qub3duS2V5cyhvYmopIDogT2JqZWN0LmtleXMob2JqKTsKICAgIGtleXMuZm9yRWFjaCgoa2V5KSA9PiB7CiAgICAgIGl0ZXIoa2V5LCBvYmpba2V5XSwgb2JqKTsKICAgIH0pOwogIH0gZWxzZSB7CiAgICBvYmouZm9yRWFjaCgoZW50cnksIGluZGV4KSA9PiBpdGVyKGluZGV4LCBlbnRyeSwgb2JqKSk7CiAgfQp9CmZ1bmN0aW9uIGdldEFyY2h0eXBlMih0aGluZykgewogIGNvbnN0IHN0YXRlID0gdGhpbmdbRFJBRlRfU1RBVEUyXTsKICByZXR1cm4gc3RhdGUgPyBzdGF0ZS50eXBlXyA6IEFycmF5LmlzQXJyYXkodGhpbmcpID8gMSA6IGlzTWFwMih0aGluZykgPyAyIDogaXNTZXQyKHRoaW5nKSA/IDMgOiAwOwp9CmZ1bmN0aW9uIGhhczIodGhpbmcsIHByb3ApIHsKICByZXR1cm4gZ2V0QXJjaHR5cGUyKHRoaW5nKSA9PT0gMiA/IHRoaW5nLmhhcyhwcm9wKSA6IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbCh0aGluZywgcHJvcCk7Cn0KZnVuY3Rpb24gc2V0Mih0aGluZywgcHJvcE9yT2xkVmFsdWUsIHZhbHVlKSB7CiAgY29uc3QgdCA9IGdldEFyY2h0eXBlMih0aGluZyk7CiAgaWYgKHQgPT09IDIpCiAgICB0aGluZy5zZXQocHJvcE9yT2xkVmFsdWUsIHZhbHVlKTsKICBlbHNlIGlmICh0ID09PSAzKSB7CiAgICB0aGluZy5hZGQodmFsdWUpOwogIH0gZWxzZQogICAgdGhpbmdbcHJvcE9yT2xkVmFsdWVdID0gdmFsdWU7Cn0KZnVuY3Rpb24gaXMyKHgyLCB5MikgewogIGlmICh4MiA9PT0geTIpIHsKICAgIHJldHVybiB4MiAhPT0gMCB8fCAxIC8geDIgPT09IDEgLyB5MjsKICB9IGVsc2UgewogICAgcmV0dXJuIHgyICE9PSB4MiAmJiB5MiAhPT0geTI7CiAgfQp9CmZ1bmN0aW9uIGlzTWFwMih0YXJnZXQpIHsKICByZXR1cm4gdGFyZ2V0IGluc3RhbmNlb2YgTWFwOwp9CmZ1bmN0aW9uIGlzU2V0Mih0YXJnZXQpIHsKICByZXR1cm4gdGFyZ2V0IGluc3RhbmNlb2YgU2V0Owp9CmZ1bmN0aW9uIGxhdGVzdDIoc3RhdGUpIHsKICByZXR1cm4gc3RhdGUuY29weV8gfHwgc3RhdGUuYmFzZV87Cn0KZnVuY3Rpb24gc2hhbGxvd0NvcHkyKGJhc2UsIHN0cmljdCkgewogIGlmIChpc01hcDIoYmFzZSkpIHsKICAgIHJldHVybiBuZXcgTWFwKGJhc2UpOwogIH0KICBpZiAoaXNTZXQyKGJhc2UpKSB7CiAgICByZXR1cm4gbmV3IFNldChiYXNlKTsKICB9CiAgaWYgKEFycmF5LmlzQXJyYXkoYmFzZSkpCiAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYmFzZSk7CiAgY29uc3QgaXNQbGFpbjIgPSBpc1BsYWluT2JqZWN0MyhiYXNlKTsKICBpZiAoc3RyaWN0ID09PSB0cnVlIHx8IHN0cmljdCA9PT0gImNsYXNzX29ubHkiICYmICFpc1BsYWluMikgewogICAgY29uc3QgZGVzY3JpcHRvcnMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhiYXNlKTsKICAgIGRlbGV0ZSBkZXNjcmlwdG9yc1tEUkFGVF9TVEFURTJdOwogICAgbGV0IGtleXMgPSBSZWZsZWN0Lm93bktleXMoZGVzY3JpcHRvcnMpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICAgIGNvbnN0IGRlc2MgPSBkZXNjcmlwdG9yc1trZXldOwogICAgICBpZiAoZGVzYy53cml0YWJsZSA9PT0gZmFsc2UpIHsKICAgICAgICBkZXNjLndyaXRhYmxlID0gdHJ1ZTsKICAgICAgICBkZXNjLmNvbmZpZ3VyYWJsZSA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKGRlc2MuZ2V0IHx8IGRlc2Muc2V0KQogICAgICAgIGRlc2NyaXB0b3JzW2tleV0gPSB7CiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgIC8vIGNvdWxkIGxpdmUgd2l0aCAhIWRlc2Muc2V0IGFzIHdlbGwgaGVyZS4uLgogICAgICAgICAgZW51bWVyYWJsZTogZGVzYy5lbnVtZXJhYmxlLAogICAgICAgICAgdmFsdWU6IGJhc2Vba2V5XQogICAgICAgIH07CiAgICB9CiAgICByZXR1cm4gT2JqZWN0LmNyZWF0ZShnZXRQcm90b3R5cGVPZjIoYmFzZSksIGRlc2NyaXB0b3JzKTsKICB9IGVsc2UgewogICAgY29uc3QgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2YyKGJhc2UpOwogICAgaWYgKHByb3RvMiAhPT0gbnVsbCAmJiBpc1BsYWluMikgewogICAgICByZXR1cm4geyAuLi5iYXNlIH07CiAgICB9CiAgICBjb25zdCBvYmogPSBPYmplY3QuY3JlYXRlKHByb3RvMik7CiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihvYmosIGJhc2UpOwogIH0KfQpmdW5jdGlvbiBmcmVlemUyKG9iaiwgZGVlcCA9IGZhbHNlKSB7CiAgaWYgKGlzRnJvemVuMihvYmopIHx8IGlzRHJhZnQyKG9iaikgfHwgIWlzRHJhZnRhYmxlMihvYmopKQogICAgcmV0dXJuIG9iajsKICBpZiAoZ2V0QXJjaHR5cGUyKG9iaikgPiAxKSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhvYmosIHsKICAgICAgc2V0OiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUyLAogICAgICBhZGQ6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZTIsCiAgICAgIGNsZWFyOiBkb250TXV0YXRlTWV0aG9kT3ZlcnJpZGUyLAogICAgICBkZWxldGU6IGRvbnRNdXRhdGVNZXRob2RPdmVycmlkZTIKICAgIH0pOwogIH0KICBPYmplY3QuZnJlZXplKG9iaik7CiAgaWYgKGRlZXApCiAgICBPYmplY3QudmFsdWVzKG9iaikuZm9yRWFjaCgodmFsdWUpID0+IGZyZWV6ZTIodmFsdWUsIHRydWUpKTsKICByZXR1cm4gb2JqOwp9CmZ1bmN0aW9uIGRvbnRNdXRhdGVGcm96ZW5Db2xsZWN0aW9uczIoKSB7CiAgZGllMigyKTsKfQp2YXIgZG9udE11dGF0ZU1ldGhvZE92ZXJyaWRlMiA9IHsKICB2YWx1ZTogZG9udE11dGF0ZUZyb3plbkNvbGxlY3Rpb25zMgp9OwpmdW5jdGlvbiBpc0Zyb3plbjIob2JqKSB7CiAgaWYgKG9iaiA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqICE9PSAib2JqZWN0IikKICAgIHJldHVybiB0cnVlOwogIHJldHVybiBPYmplY3QuaXNGcm96ZW4ob2JqKTsKfQp2YXIgcGx1Z2luczIgPSB7fTsKZnVuY3Rpb24gZ2V0UGx1Z2luMihwbHVnaW5LZXkpIHsKICBjb25zdCBwbHVnaW4gPSBwbHVnaW5zMltwbHVnaW5LZXldOwogIGlmICghcGx1Z2luKSB7CiAgICBkaWUyKDAsIHBsdWdpbktleSk7CiAgfQogIHJldHVybiBwbHVnaW47Cn0KdmFyIGN1cnJlbnRTY29wZTI7CmZ1bmN0aW9uIGdldEN1cnJlbnRTY29wZTIoKSB7CiAgcmV0dXJuIGN1cnJlbnRTY29wZTI7Cn0KZnVuY3Rpb24gY3JlYXRlU2NvcGUyKHBhcmVudF8sIGltbWVyXykgewogIHJldHVybiB7CiAgICBkcmFmdHNfOiBbXSwKICAgIHBhcmVudF8sCiAgICBpbW1lcl8sCiAgICAvLyBXaGVuZXZlciB0aGUgbW9kaWZpZWQgZHJhZnQgY29udGFpbnMgYSBkcmFmdCBmcm9tIGFub3RoZXIgc2NvcGUsIHdlCiAgICAvLyBuZWVkIHRvIHByZXZlbnQgYXV0by1mcmVlemluZyBzbyB0aGUgdW5vd25lZCBkcmFmdCBjYW4gYmUgZmluYWxpemVkLgogICAgY2FuQXV0b0ZyZWV6ZV86IHRydWUsCiAgICB1bmZpbmFsaXplZERyYWZ0c186IDAKICB9Owp9CmZ1bmN0aW9uIHVzZVBhdGNoZXNJblNjb3BlMihzY29wZSwgcGF0Y2hMaXN0ZW5lcikgewogIGlmIChwYXRjaExpc3RlbmVyKSB7CiAgICBnZXRQbHVnaW4yKCJQYXRjaGVzIik7CiAgICBzY29wZS5wYXRjaGVzXyA9IFtdOwogICAgc2NvcGUuaW52ZXJzZVBhdGNoZXNfID0gW107CiAgICBzY29wZS5wYXRjaExpc3RlbmVyXyA9IHBhdGNoTGlzdGVuZXI7CiAgfQp9CmZ1bmN0aW9uIHJldm9rZVNjb3BlMihzY29wZSkgewogIGxlYXZlU2NvcGUyKHNjb3BlKTsKICBzY29wZS5kcmFmdHNfLmZvckVhY2gocmV2b2tlRHJhZnQyKTsKICBzY29wZS5kcmFmdHNfID0gbnVsbDsKfQpmdW5jdGlvbiBsZWF2ZVNjb3BlMihzY29wZSkgewogIGlmIChzY29wZSA9PT0gY3VycmVudFNjb3BlMikgewogICAgY3VycmVudFNjb3BlMiA9IHNjb3BlLnBhcmVudF87CiAgfQp9CmZ1bmN0aW9uIGVudGVyU2NvcGUyKGltbWVyMjIpIHsKICByZXR1cm4gY3VycmVudFNjb3BlMiA9IGNyZWF0ZVNjb3BlMihjdXJyZW50U2NvcGUyLCBpbW1lcjIyKTsKfQpmdW5jdGlvbiByZXZva2VEcmFmdDIoZHJhZnQpIHsKICBjb25zdCBzdGF0ZSA9IGRyYWZ0W0RSQUZUX1NUQVRFMl07CiAgaWYgKHN0YXRlLnR5cGVfID09PSAwIHx8IHN0YXRlLnR5cGVfID09PSAxKQogICAgc3RhdGUucmV2b2tlXygpOwogIGVsc2UKICAgIHN0YXRlLnJldm9rZWRfID0gdHJ1ZTsKfQpmdW5jdGlvbiBwcm9jZXNzUmVzdWx0MihyZXN1bHQsIHNjb3BlKSB7CiAgc2NvcGUudW5maW5hbGl6ZWREcmFmdHNfID0gc2NvcGUuZHJhZnRzXy5sZW5ndGg7CiAgY29uc3QgYmFzZURyYWZ0ID0gc2NvcGUuZHJhZnRzX1swXTsKICBjb25zdCBpc1JlcGxhY2VkID0gcmVzdWx0ICE9PSB2b2lkIDAgJiYgcmVzdWx0ICE9PSBiYXNlRHJhZnQ7CiAgaWYgKGlzUmVwbGFjZWQpIHsKICAgIGlmIChiYXNlRHJhZnRbRFJBRlRfU1RBVEUyXS5tb2RpZmllZF8pIHsKICAgICAgcmV2b2tlU2NvcGUyKHNjb3BlKTsKICAgICAgZGllMig0KTsKICAgIH0KICAgIGlmIChpc0RyYWZ0YWJsZTIocmVzdWx0KSkgewogICAgICByZXN1bHQgPSBmaW5hbGl6ZTIoc2NvcGUsIHJlc3VsdCk7CiAgICAgIGlmICghc2NvcGUucGFyZW50XykKICAgICAgICBtYXliZUZyZWV6ZTIoc2NvcGUsIHJlc3VsdCk7CiAgICB9CiAgICBpZiAoc2NvcGUucGF0Y2hlc18pIHsKICAgICAgZ2V0UGx1Z2luMigiUGF0Y2hlcyIpLmdlbmVyYXRlUmVwbGFjZW1lbnRQYXRjaGVzXygKICAgICAgICBiYXNlRHJhZnRbRFJBRlRfU1RBVEUyXS5iYXNlXywKICAgICAgICByZXN1bHQsCiAgICAgICAgc2NvcGUucGF0Y2hlc18sCiAgICAgICAgc2NvcGUuaW52ZXJzZVBhdGNoZXNfCiAgICAgICk7CiAgICB9CiAgfSBlbHNlIHsKICAgIHJlc3VsdCA9IGZpbmFsaXplMihzY29wZSwgYmFzZURyYWZ0LCBbXSk7CiAgfQogIHJldm9rZVNjb3BlMihzY29wZSk7CiAgaWYgKHNjb3BlLnBhdGNoZXNfKSB7CiAgICBzY29wZS5wYXRjaExpc3RlbmVyXyhzY29wZS5wYXRjaGVzXywgc2NvcGUuaW52ZXJzZVBhdGNoZXNfKTsKICB9CiAgcmV0dXJuIHJlc3VsdCAhPT0gTk9USElORzIgPyByZXN1bHQgOiB2b2lkIDA7Cn0KZnVuY3Rpb24gZmluYWxpemUyKHJvb3RTY29wZSwgdmFsdWUsIHBhdGgyKSB7CiAgaWYgKGlzRnJvemVuMih2YWx1ZSkpCiAgICByZXR1cm4gdmFsdWU7CiAgY29uc3QgdXNlU3RyaWN0SXRlcmF0aW9uID0gcm9vdFNjb3BlLmltbWVyXy5zaG91bGRVc2VTdHJpY3RJdGVyYXRpb24oKTsKICBjb25zdCBzdGF0ZSA9IHZhbHVlW0RSQUZUX1NUQVRFMl07CiAgaWYgKCFzdGF0ZSkgewogICAgZWFjaDIoCiAgICAgIHZhbHVlLAogICAgICAoa2V5LCBjaGlsZFZhbHVlKSA9PiBmaW5hbGl6ZVByb3BlcnR5KHJvb3RTY29wZSwgc3RhdGUsIHZhbHVlLCBrZXksIGNoaWxkVmFsdWUsIHBhdGgyKSwKICAgICAgdXNlU3RyaWN0SXRlcmF0aW9uCiAgICApOwogICAgcmV0dXJuIHZhbHVlOwogIH0KICBpZiAoc3RhdGUuc2NvcGVfICE9PSByb290U2NvcGUpCiAgICByZXR1cm4gdmFsdWU7CiAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pIHsKICAgIG1heWJlRnJlZXplMihyb290U2NvcGUsIHN0YXRlLmJhc2VfLCB0cnVlKTsKICAgIHJldHVybiBzdGF0ZS5iYXNlXzsKICB9CiAgaWYgKCFzdGF0ZS5maW5hbGl6ZWRfKSB7CiAgICBzdGF0ZS5maW5hbGl6ZWRfID0gdHJ1ZTsKICAgIHN0YXRlLnNjb3BlXy51bmZpbmFsaXplZERyYWZ0c18tLTsKICAgIGNvbnN0IHJlc3VsdCA9IHN0YXRlLmNvcHlfOwogICAgbGV0IHJlc3VsdEVhY2ggPSByZXN1bHQ7CiAgICBsZXQgaXNTZXQyMiA9IGZhbHNlOwogICAgaWYgKHN0YXRlLnR5cGVfID09PSAzKSB7CiAgICAgIHJlc3VsdEVhY2ggPSBuZXcgU2V0KHJlc3VsdCk7CiAgICAgIHJlc3VsdC5jbGVhcigpOwogICAgICBpc1NldDIyID0gdHJ1ZTsKICAgIH0KICAgIGVhY2gyKAogICAgICByZXN1bHRFYWNoLAogICAgICAoa2V5LCBjaGlsZFZhbHVlKSA9PiBmaW5hbGl6ZVByb3BlcnR5KAogICAgICAgIHJvb3RTY29wZSwKICAgICAgICBzdGF0ZSwKICAgICAgICByZXN1bHQsCiAgICAgICAga2V5LAogICAgICAgIGNoaWxkVmFsdWUsCiAgICAgICAgcGF0aDIsCiAgICAgICAgaXNTZXQyMgogICAgICApLAogICAgICB1c2VTdHJpY3RJdGVyYXRpb24KICAgICk7CiAgICBtYXliZUZyZWV6ZTIocm9vdFNjb3BlLCByZXN1bHQsIGZhbHNlKTsKICAgIGlmIChwYXRoMiAmJiByb290U2NvcGUucGF0Y2hlc18pIHsKICAgICAgZ2V0UGx1Z2luMigiUGF0Y2hlcyIpLmdlbmVyYXRlUGF0Y2hlc18oCiAgICAgICAgc3RhdGUsCiAgICAgICAgcGF0aDIsCiAgICAgICAgcm9vdFNjb3BlLnBhdGNoZXNfLAogICAgICAgIHJvb3RTY29wZS5pbnZlcnNlUGF0Y2hlc18KICAgICAgKTsKICAgIH0KICB9CiAgcmV0dXJuIHN0YXRlLmNvcHlfOwp9CmZ1bmN0aW9uIGZpbmFsaXplUHJvcGVydHkocm9vdFNjb3BlLCBwYXJlbnRTdGF0ZSwgdGFyZ2V0T2JqZWN0LCBwcm9wLCBjaGlsZFZhbHVlLCByb290UGF0aCwgdGFyZ2V0SXNTZXQpIHsKICBpZiAoY2hpbGRWYWx1ZSA9PSBudWxsKSB7CiAgICByZXR1cm47CiAgfQogIGlmICh0eXBlb2YgY2hpbGRWYWx1ZSAhPT0gIm9iamVjdCIgJiYgIXRhcmdldElzU2V0KSB7CiAgICByZXR1cm47CiAgfQogIGNvbnN0IGNoaWxkSXNGcm96ZW4gPSBpc0Zyb3plbjIoY2hpbGRWYWx1ZSk7CiAgaWYgKGNoaWxkSXNGcm96ZW4gJiYgIXRhcmdldElzU2V0KSB7CiAgICByZXR1cm47CiAgfQogIGlmIChjaGlsZFZhbHVlID09PSB0YXJnZXRPYmplY3QpCiAgICBkaWUyKDUpOwogIGlmIChpc0RyYWZ0MihjaGlsZFZhbHVlKSkgewogICAgY29uc3QgcGF0aDIgPSByb290UGF0aCAmJiBwYXJlbnRTdGF0ZSAmJiBwYXJlbnRTdGF0ZS50eXBlXyAhPT0gMyAmJiAvLyBTZXQgb2JqZWN0cyBhcmUgYXRvbWljIHNpbmNlIHRoZXkgaGF2ZSBubyBrZXlzLgogICAgIWhhczIocGFyZW50U3RhdGUuYXNzaWduZWRfLCBwcm9wKSA/IHJvb3RQYXRoLmNvbmNhdChwcm9wKSA6IHZvaWQgMDsKICAgIGNvbnN0IHJlcyA9IGZpbmFsaXplMihyb290U2NvcGUsIGNoaWxkVmFsdWUsIHBhdGgyKTsKICAgIHNldDIodGFyZ2V0T2JqZWN0LCBwcm9wLCByZXMpOwogICAgaWYgKGlzRHJhZnQyKHJlcykpIHsKICAgICAgcm9vdFNjb3BlLmNhbkF1dG9GcmVlemVfID0gZmFsc2U7CiAgICB9IGVsc2UKICAgICAgcmV0dXJuOwogIH0gZWxzZSBpZiAodGFyZ2V0SXNTZXQpIHsKICAgIHRhcmdldE9iamVjdC5hZGQoY2hpbGRWYWx1ZSk7CiAgfQogIGlmIChpc0RyYWZ0YWJsZTIoY2hpbGRWYWx1ZSkgJiYgIWNoaWxkSXNGcm96ZW4pIHsKICAgIGlmICghcm9vdFNjb3BlLmltbWVyXy5hdXRvRnJlZXplXyAmJiByb290U2NvcGUudW5maW5hbGl6ZWREcmFmdHNfIDwgMSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocGFyZW50U3RhdGUgJiYgcGFyZW50U3RhdGUuYmFzZV8gJiYgcGFyZW50U3RhdGUuYmFzZV9bcHJvcF0gPT09IGNoaWxkVmFsdWUgJiYgY2hpbGRJc0Zyb3plbikgewogICAgICByZXR1cm47CiAgICB9CiAgICBmaW5hbGl6ZTIocm9vdFNjb3BlLCBjaGlsZFZhbHVlKTsKICAgIGlmICgoIXBhcmVudFN0YXRlIHx8ICFwYXJlbnRTdGF0ZS5zY29wZV8ucGFyZW50XykgJiYgdHlwZW9mIHByb3AgIT09ICJzeW1ib2wiICYmIChpc01hcDIodGFyZ2V0T2JqZWN0KSA/IHRhcmdldE9iamVjdC5oYXMocHJvcCkgOiBPYmplY3QucHJvdG90eXBlLnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwodGFyZ2V0T2JqZWN0LCBwcm9wKSkpCiAgICAgIG1heWJlRnJlZXplMihyb290U2NvcGUsIGNoaWxkVmFsdWUpOwogIH0KfQpmdW5jdGlvbiBtYXliZUZyZWV6ZTIoc2NvcGUsIHZhbHVlLCBkZWVwID0gZmFsc2UpIHsKICBpZiAoIXNjb3BlLnBhcmVudF8gJiYgc2NvcGUuaW1tZXJfLmF1dG9GcmVlemVfICYmIHNjb3BlLmNhbkF1dG9GcmVlemVfKSB7CiAgICBmcmVlemUyKHZhbHVlLCBkZWVwKTsKICB9Cn0KZnVuY3Rpb24gY3JlYXRlUHJveHlQcm94eTIoYmFzZSwgcGFyZW50KSB7CiAgY29uc3QgaXNBcnJheTIgPSBBcnJheS5pc0FycmF5KGJhc2UpOwogIGNvbnN0IHN0YXRlID0gewogICAgdHlwZV86IGlzQXJyYXkyID8gMSA6IDAsCiAgICAvLyBUcmFjayB3aGljaCBwcm9kdWNlIGNhbGwgdGhpcyBpcyBhc3NvY2lhdGVkIHdpdGguCiAgICBzY29wZV86IHBhcmVudCA/IHBhcmVudC5zY29wZV8gOiBnZXRDdXJyZW50U2NvcGUyKCksCiAgICAvLyBUcnVlIGZvciBib3RoIHNoYWxsb3cgYW5kIGRlZXAgY2hhbmdlcy4KICAgIG1vZGlmaWVkXzogZmFsc2UsCiAgICAvLyBVc2VkIGR1cmluZyBmaW5hbGl6YXRpb24uCiAgICBmaW5hbGl6ZWRfOiBmYWxzZSwKICAgIC8vIFRyYWNrIHdoaWNoIHByb3BlcnRpZXMgaGF2ZSBiZWVuIGFzc2lnbmVkICh0cnVlKSBvciBkZWxldGVkIChmYWxzZSkuCiAgICBhc3NpZ25lZF86IHt9LAogICAgLy8gVGhlIHBhcmVudCBkcmFmdCBzdGF0ZS4KICAgIHBhcmVudF86IHBhcmVudCwKICAgIC8vIFRoZSBiYXNlIHN0YXRlLgogICAgYmFzZV86IGJhc2UsCiAgICAvLyBUaGUgYmFzZSBwcm94eS4KICAgIGRyYWZ0XzogbnVsbCwKICAgIC8vIHNldCBiZWxvdwogICAgLy8gVGhlIGJhc2UgY29weSB3aXRoIGFueSB1cGRhdGVkIHZhbHVlcy4KICAgIGNvcHlfOiBudWxsLAogICAgLy8gQ2FsbGVkIGJ5IHRoZSBgcHJvZHVjZWAgZnVuY3Rpb24uCiAgICByZXZva2VfOiBudWxsLAogICAgaXNNYW51YWxfOiBmYWxzZQogIH07CiAgbGV0IHRhcmdldCA9IHN0YXRlOwogIGxldCB0cmFwcyA9IG9iamVjdFRyYXBzMjsKICBpZiAoaXNBcnJheTIpIHsKICAgIHRhcmdldCA9IFtzdGF0ZV07CiAgICB0cmFwcyA9IGFycmF5VHJhcHMyOwogIH0KICBjb25zdCB7IHJldm9rZSwgcHJveHkgfSA9IFByb3h5LnJldm9jYWJsZSh0YXJnZXQsIHRyYXBzKTsKICBzdGF0ZS5kcmFmdF8gPSBwcm94eTsKICBzdGF0ZS5yZXZva2VfID0gcmV2b2tlOwogIHJldHVybiBwcm94eTsKfQp2YXIgb2JqZWN0VHJhcHMyID0gewogIGdldChzdGF0ZSwgcHJvcCkgewogICAgaWYgKHByb3AgPT09IERSQUZUX1NUQVRFMikKICAgICAgcmV0dXJuIHN0YXRlOwogICAgY29uc3Qgc291cmNlID0gbGF0ZXN0MihzdGF0ZSk7CiAgICBpZiAoIWhhczIoc291cmNlLCBwcm9wKSkgewogICAgICByZXR1cm4gcmVhZFByb3BGcm9tUHJvdG8yKHN0YXRlLCBzb3VyY2UsIHByb3ApOwogICAgfQogICAgY29uc3QgdmFsdWUgPSBzb3VyY2VbcHJvcF07CiAgICBpZiAoc3RhdGUuZmluYWxpemVkXyB8fCAhaXNEcmFmdGFibGUyKHZhbHVlKSkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBpZiAodmFsdWUgPT09IHBlZWsyKHN0YXRlLmJhc2VfLCBwcm9wKSkgewogICAgICBwcmVwYXJlQ29weTIoc3RhdGUpOwogICAgICByZXR1cm4gc3RhdGUuY29weV9bcHJvcF0gPSBjcmVhdGVQcm94eTIodmFsdWUsIHN0YXRlKTsKICAgIH0KICAgIHJldHVybiB2YWx1ZTsKICB9LAogIGhhcyhzdGF0ZSwgcHJvcCkgewogICAgcmV0dXJuIHByb3AgaW4gbGF0ZXN0MihzdGF0ZSk7CiAgfSwKICBvd25LZXlzKHN0YXRlKSB7CiAgICByZXR1cm4gUmVmbGVjdC5vd25LZXlzKGxhdGVzdDIoc3RhdGUpKTsKICB9LAogIHNldChzdGF0ZSwgcHJvcCwgdmFsdWUpIHsKICAgIGNvbnN0IGRlc2MgPSBnZXREZXNjcmlwdG9yRnJvbVByb3RvMihsYXRlc3QyKHN0YXRlKSwgcHJvcCk7CiAgICBpZiAoZGVzYz8uc2V0KSB7CiAgICAgIGRlc2Muc2V0LmNhbGwoc3RhdGUuZHJhZnRfLCB2YWx1ZSk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pIHsKICAgICAgY29uc3QgY3VycmVudDIyID0gcGVlazIobGF0ZXN0MihzdGF0ZSksIHByb3ApOwogICAgICBjb25zdCBjdXJyZW50U3RhdGUgPSBjdXJyZW50MjI/LltEUkFGVF9TVEFURTJdOwogICAgICBpZiAoY3VycmVudFN0YXRlICYmIGN1cnJlbnRTdGF0ZS5iYXNlXyA9PT0gdmFsdWUpIHsKICAgICAgICBzdGF0ZS5jb3B5X1twcm9wXSA9IHZhbHVlOwogICAgICAgIHN0YXRlLmFzc2lnbmVkX1twcm9wXSA9IGZhbHNlOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmIChpczIodmFsdWUsIGN1cnJlbnQyMikgJiYgKHZhbHVlICE9PSB2b2lkIDAgfHwgaGFzMihzdGF0ZS5iYXNlXywgcHJvcCkpKQogICAgICAgIHJldHVybiB0cnVlOwogICAgICBwcmVwYXJlQ29weTIoc3RhdGUpOwogICAgICBtYXJrQ2hhbmdlZDIoc3RhdGUpOwogICAgfQogICAgaWYgKHN0YXRlLmNvcHlfW3Byb3BdID09PSB2YWx1ZSAmJiAvLyBzcGVjaWFsIGNhc2U6IGhhbmRsZSBuZXcgcHJvcHMgd2l0aCB2YWx1ZSAndW5kZWZpbmVkJwogICAgKHZhbHVlICE9PSB2b2lkIDAgfHwgcHJvcCBpbiBzdGF0ZS5jb3B5XykgfHwgLy8gc3BlY2lhbCBjYXNlOiBOYU4KICAgIE51bWJlci5pc05hTih2YWx1ZSkgJiYgTnVtYmVyLmlzTmFOKHN0YXRlLmNvcHlfW3Byb3BdKSkKICAgICAgcmV0dXJuIHRydWU7CiAgICBzdGF0ZS5jb3B5X1twcm9wXSA9IHZhbHVlOwogICAgc3RhdGUuYXNzaWduZWRfW3Byb3BdID0gdHJ1ZTsKICAgIHJldHVybiB0cnVlOwogIH0sCiAgZGVsZXRlUHJvcGVydHkoc3RhdGUsIHByb3ApIHsKICAgIGlmIChwZWVrMihzdGF0ZS5iYXNlXywgcHJvcCkgIT09IHZvaWQgMCB8fCBwcm9wIGluIHN0YXRlLmJhc2VfKSB7CiAgICAgIHN0YXRlLmFzc2lnbmVkX1twcm9wXSA9IGZhbHNlOwogICAgICBwcmVwYXJlQ29weTIoc3RhdGUpOwogICAgICBtYXJrQ2hhbmdlZDIoc3RhdGUpOwogICAgfSBlbHNlIHsKICAgICAgZGVsZXRlIHN0YXRlLmFzc2lnbmVkX1twcm9wXTsKICAgIH0KICAgIGlmIChzdGF0ZS5jb3B5XykgewogICAgICBkZWxldGUgc3RhdGUuY29weV9bcHJvcF07CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9LAogIC8vIE5vdGU6IFdlIG5ldmVyIGNvZXJjZSBgZGVzYy52YWx1ZWAgaW50byBhbiBJbW1lciBkcmFmdCwgYmVjYXVzZSB3ZSBjYW4ndCBtYWtlCiAgLy8gdGhlIHNhbWUgZ3VhcmFudGVlIGluIEVTNSBtb2RlLgogIGdldE93blByb3BlcnR5RGVzY3JpcHRvcihzdGF0ZSwgcHJvcCkgewogICAgY29uc3Qgb3duZXIgPSBsYXRlc3QyKHN0YXRlKTsKICAgIGNvbnN0IGRlc2MgPSBSZWZsZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvd25lciwgcHJvcCk7CiAgICBpZiAoIWRlc2MpCiAgICAgIHJldHVybiBkZXNjOwogICAgcmV0dXJuIHsKICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgIGNvbmZpZ3VyYWJsZTogc3RhdGUudHlwZV8gIT09IDEgfHwgcHJvcCAhPT0gImxlbmd0aCIsCiAgICAgIGVudW1lcmFibGU6IGRlc2MuZW51bWVyYWJsZSwKICAgICAgdmFsdWU6IG93bmVyW3Byb3BdCiAgICB9OwogIH0sCiAgZGVmaW5lUHJvcGVydHkoKSB7CiAgICBkaWUyKDExKTsKICB9LAogIGdldFByb3RvdHlwZU9mKHN0YXRlKSB7CiAgICByZXR1cm4gZ2V0UHJvdG90eXBlT2YyKHN0YXRlLmJhc2VfKTsKICB9LAogIHNldFByb3RvdHlwZU9mKCkgewogICAgZGllMigxMik7CiAgfQp9Owp2YXIgYXJyYXlUcmFwczIgPSB7fTsKZWFjaDIob2JqZWN0VHJhcHMyLCAoa2V5LCBmbikgPT4gewogIGFycmF5VHJhcHMyW2tleV0gPSBmdW5jdGlvbigpIHsKICAgIGFyZ3VtZW50c1swXSA9IGFyZ3VtZW50c1swXVswXTsKICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07Cn0pOwphcnJheVRyYXBzMi5kZWxldGVQcm9wZXJ0eSA9IGZ1bmN0aW9uKHN0YXRlLCBwcm9wKSB7CiAgaWYgKGlzTmFOKHBhcnNlSW50KHByb3ApKSkKICAgIGRpZTIoMTMpOwogIHJldHVybiBhcnJheVRyYXBzMi5zZXQuY2FsbCh0aGlzLCBzdGF0ZSwgcHJvcCwgdm9pZCAwKTsKfTsKYXJyYXlUcmFwczIuc2V0ID0gZnVuY3Rpb24oc3RhdGUsIHByb3AsIHZhbHVlKSB7CiAgaWYgKHByb3AgIT09ICJsZW5ndGgiICYmIGlzTmFOKHBhcnNlSW50KHByb3ApKSkKICAgIGRpZTIoMTQpOwogIHJldHVybiBvYmplY3RUcmFwczIuc2V0LmNhbGwodGhpcywgc3RhdGVbMF0sIHByb3AsIHZhbHVlLCBzdGF0ZVswXSk7Cn07CmZ1bmN0aW9uIHBlZWsyKGRyYWZ0LCBwcm9wKSB7CiAgY29uc3Qgc3RhdGUgPSBkcmFmdFtEUkFGVF9TVEFURTJdOwogIGNvbnN0IHNvdXJjZSA9IHN0YXRlID8gbGF0ZXN0MihzdGF0ZSkgOiBkcmFmdDsKICByZXR1cm4gc291cmNlW3Byb3BdOwp9CmZ1bmN0aW9uIHJlYWRQcm9wRnJvbVByb3RvMihzdGF0ZSwgc291cmNlLCBwcm9wKSB7CiAgY29uc3QgZGVzYyA9IGdldERlc2NyaXB0b3JGcm9tUHJvdG8yKHNvdXJjZSwgcHJvcCk7CiAgcmV0dXJuIGRlc2MgPyBgdmFsdWVgIGluIGRlc2MgPyBkZXNjLnZhbHVlIDogKAogICAgLy8gVGhpcyBpcyBhIHZlcnkgc3BlY2lhbCBjYXNlLCBpZiB0aGUgcHJvcCBpcyBhIGdldHRlciBkZWZpbmVkIGJ5IHRoZQogICAgLy8gcHJvdG90eXBlLCB3ZSBzaG91bGQgaW52b2tlIGl0IHdpdGggdGhlIGRyYWZ0IGFzIGNvbnRleHQhCiAgICBkZXNjLmdldD8uY2FsbChzdGF0ZS5kcmFmdF8pCiAgKSA6IHZvaWQgMDsKfQpmdW5jdGlvbiBnZXREZXNjcmlwdG9yRnJvbVByb3RvMihzb3VyY2UsIHByb3ApIHsKICBpZiAoIShwcm9wIGluIHNvdXJjZSkpCiAgICByZXR1cm4gdm9pZCAwOwogIGxldCBwcm90bzIgPSBnZXRQcm90b3R5cGVPZjIoc291cmNlKTsKICB3aGlsZSAocHJvdG8yKSB7CiAgICBjb25zdCBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwcm90bzIsIHByb3ApOwogICAgaWYgKGRlc2MpCiAgICAgIHJldHVybiBkZXNjOwogICAgcHJvdG8yID0gZ2V0UHJvdG90eXBlT2YyKHByb3RvMik7CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KZnVuY3Rpb24gbWFya0NoYW5nZWQyKHN0YXRlKSB7CiAgaWYgKCFzdGF0ZS5tb2RpZmllZF8pIHsKICAgIHN0YXRlLm1vZGlmaWVkXyA9IHRydWU7CiAgICBpZiAoc3RhdGUucGFyZW50XykgewogICAgICBtYXJrQ2hhbmdlZDIoc3RhdGUucGFyZW50Xyk7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIHByZXBhcmVDb3B5MihzdGF0ZSkgewogIGlmICghc3RhdGUuY29weV8pIHsKICAgIHN0YXRlLmNvcHlfID0gc2hhbGxvd0NvcHkyKAogICAgICBzdGF0ZS5iYXNlXywKICAgICAgc3RhdGUuc2NvcGVfLmltbWVyXy51c2VTdHJpY3RTaGFsbG93Q29weV8KICAgICk7CiAgfQp9CnZhciBJbW1lcjIyID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGNvbmZpZykgewogICAgdGhpcy5hdXRvRnJlZXplXyA9IHRydWU7CiAgICB0aGlzLnVzZVN0cmljdFNoYWxsb3dDb3B5XyA9IGZhbHNlOwogICAgdGhpcy51c2VTdHJpY3RJdGVyYXRpb25fID0gdHJ1ZTsKICAgIHRoaXMucHJvZHVjZSA9IChiYXNlLCByZWNpcGUsIHBhdGNoTGlzdGVuZXIpID0+IHsKICAgICAgaWYgKHR5cGVvZiBiYXNlID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiByZWNpcGUgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBjb25zdCBkZWZhdWx0QmFzZSA9IHJlY2lwZTsKICAgICAgICByZWNpcGUgPSBiYXNlOwogICAgICAgIGNvbnN0IHNlbGYyID0gdGhpczsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gY3VycmllZFByb2R1Y2UoYmFzZTIgPSBkZWZhdWx0QmFzZSwgLi4uYXJncykgewogICAgICAgICAgcmV0dXJuIHNlbGYyLnByb2R1Y2UoYmFzZTIsIChkcmFmdCkgPT4gcmVjaXBlLmNhbGwodGhpcywgZHJhZnQsIC4uLmFyZ3MpKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgcmVjaXBlICE9PSAiZnVuY3Rpb24iKQogICAgICAgIGRpZTIoNik7CiAgICAgIGlmIChwYXRjaExpc3RlbmVyICE9PSB2b2lkIDAgJiYgdHlwZW9mIHBhdGNoTGlzdGVuZXIgIT09ICJmdW5jdGlvbiIpCiAgICAgICAgZGllMig3KTsKICAgICAgbGV0IHJlc3VsdDsKICAgICAgaWYgKGlzRHJhZnRhYmxlMihiYXNlKSkgewogICAgICAgIGNvbnN0IHNjb3BlID0gZW50ZXJTY29wZTIodGhpcyk7CiAgICAgICAgY29uc3QgcHJveHkgPSBjcmVhdGVQcm94eTIoYmFzZSwgdm9pZCAwKTsKICAgICAgICBsZXQgaGFzRXJyb3IgPSB0cnVlOwogICAgICAgIHRyeSB7CiAgICAgICAgICByZXN1bHQgPSByZWNpcGUocHJveHkpOwogICAgICAgICAgaGFzRXJyb3IgPSBmYWxzZTsKICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgaWYgKGhhc0Vycm9yKQogICAgICAgICAgICByZXZva2VTY29wZTIoc2NvcGUpOwogICAgICAgICAgZWxzZQogICAgICAgICAgICBsZWF2ZVNjb3BlMihzY29wZSk7CiAgICAgICAgfQogICAgICAgIHVzZVBhdGNoZXNJblNjb3BlMihzY29wZSwgcGF0Y2hMaXN0ZW5lcik7CiAgICAgICAgcmV0dXJuIHByb2Nlc3NSZXN1bHQyKHJlc3VsdCwgc2NvcGUpOwogICAgICB9IGVsc2UgaWYgKCFiYXNlIHx8IHR5cGVvZiBiYXNlICE9PSAib2JqZWN0IikgewogICAgICAgIHJlc3VsdCA9IHJlY2lwZShiYXNlKTsKICAgICAgICBpZiAocmVzdWx0ID09PSB2b2lkIDApCiAgICAgICAgICByZXN1bHQgPSBiYXNlOwogICAgICAgIGlmIChyZXN1bHQgPT09IE5PVEhJTkcyKQogICAgICAgICAgcmVzdWx0ID0gdm9pZCAwOwogICAgICAgIGlmICh0aGlzLmF1dG9GcmVlemVfKQogICAgICAgICAgZnJlZXplMihyZXN1bHQsIHRydWUpOwogICAgICAgIGlmIChwYXRjaExpc3RlbmVyKSB7CiAgICAgICAgICBjb25zdCBwID0gW107CiAgICAgICAgICBjb25zdCBpcCA9IFtdOwogICAgICAgICAgZ2V0UGx1Z2luMigiUGF0Y2hlcyIpLmdlbmVyYXRlUmVwbGFjZW1lbnRQYXRjaGVzXyhiYXNlLCByZXN1bHQsIHAsIGlwKTsKICAgICAgICAgIHBhdGNoTGlzdGVuZXIocCwgaXApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICB9IGVsc2UKICAgICAgICBkaWUyKDEsIGJhc2UpOwogICAgfTsKICAgIHRoaXMucHJvZHVjZVdpdGhQYXRjaGVzID0gKGJhc2UsIHJlY2lwZSkgPT4gewogICAgICBpZiAodHlwZW9mIGJhc2UgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICByZXR1cm4gKHN0YXRlLCAuLi5hcmdzKSA9PiB0aGlzLnByb2R1Y2VXaXRoUGF0Y2hlcyhzdGF0ZSwgKGRyYWZ0KSA9PiBiYXNlKGRyYWZ0LCAuLi5hcmdzKSk7CiAgICAgIH0KICAgICAgbGV0IHBhdGNoZXMsIGludmVyc2VQYXRjaGVzOwogICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnByb2R1Y2UoYmFzZSwgcmVjaXBlLCAocCwgaXApID0+IHsKICAgICAgICBwYXRjaGVzID0gcDsKICAgICAgICBpbnZlcnNlUGF0Y2hlcyA9IGlwOwogICAgICB9KTsKICAgICAgcmV0dXJuIFtyZXN1bHQsIHBhdGNoZXMsIGludmVyc2VQYXRjaGVzXTsKICAgIH07CiAgICBpZiAodHlwZW9mIGNvbmZpZz8uYXV0b0ZyZWV6ZSA9PT0gImJvb2xlYW4iKQogICAgICB0aGlzLnNldEF1dG9GcmVlemUoY29uZmlnLmF1dG9GcmVlemUpOwogICAgaWYgKHR5cGVvZiBjb25maWc/LnVzZVN0cmljdFNoYWxsb3dDb3B5ID09PSAiYm9vbGVhbiIpCiAgICAgIHRoaXMuc2V0VXNlU3RyaWN0U2hhbGxvd0NvcHkoY29uZmlnLnVzZVN0cmljdFNoYWxsb3dDb3B5KTsKICAgIGlmICh0eXBlb2YgY29uZmlnPy51c2VTdHJpY3RJdGVyYXRpb24gPT09ICJib29sZWFuIikKICAgICAgdGhpcy5zZXRVc2VTdHJpY3RJdGVyYXRpb24oY29uZmlnLnVzZVN0cmljdEl0ZXJhdGlvbik7CiAgfQogIGNyZWF0ZURyYWZ0KGJhc2UpIHsKICAgIGlmICghaXNEcmFmdGFibGUyKGJhc2UpKQogICAgICBkaWUyKDgpOwogICAgaWYgKGlzRHJhZnQyKGJhc2UpKQogICAgICBiYXNlID0gY3VycmVudDIoYmFzZSk7CiAgICBjb25zdCBzY29wZSA9IGVudGVyU2NvcGUyKHRoaXMpOwogICAgY29uc3QgcHJveHkgPSBjcmVhdGVQcm94eTIoYmFzZSwgdm9pZCAwKTsKICAgIHByb3h5W0RSQUZUX1NUQVRFMl0uaXNNYW51YWxfID0gdHJ1ZTsKICAgIGxlYXZlU2NvcGUyKHNjb3BlKTsKICAgIHJldHVybiBwcm94eTsKICB9CiAgZmluaXNoRHJhZnQoZHJhZnQsIHBhdGNoTGlzdGVuZXIpIHsKICAgIGNvbnN0IHN0YXRlID0gZHJhZnQgJiYgZHJhZnRbRFJBRlRfU1RBVEUyXTsKICAgIGlmICghc3RhdGUgfHwgIXN0YXRlLmlzTWFudWFsXykKICAgICAgZGllMig5KTsKICAgIGNvbnN0IHsgc2NvcGVfOiBzY29wZSB9ID0gc3RhdGU7CiAgICB1c2VQYXRjaGVzSW5TY29wZTIoc2NvcGUsIHBhdGNoTGlzdGVuZXIpOwogICAgcmV0dXJuIHByb2Nlc3NSZXN1bHQyKHZvaWQgMCwgc2NvcGUpOwogIH0KICAvKioKICAgKiBQYXNzIHRydWUgdG8gYXV0b21hdGljYWxseSBmcmVlemUgYWxsIGNvcGllcyBjcmVhdGVkIGJ5IEltbWVyLgogICAqCiAgICogQnkgZGVmYXVsdCwgYXV0by1mcmVlemluZyBpcyBlbmFibGVkLgogICAqLwogIHNldEF1dG9GcmVlemUodmFsdWUpIHsKICAgIHRoaXMuYXV0b0ZyZWV6ZV8gPSB2YWx1ZTsKICB9CiAgLyoqCiAgICogUGFzcyB0cnVlIHRvIGVuYWJsZSBzdHJpY3Qgc2hhbGxvdyBjb3B5LgogICAqCiAgICogQnkgZGVmYXVsdCwgaW1tZXIgZG9lcyBub3QgY29weSB0aGUgb2JqZWN0IGRlc2NyaXB0b3JzIHN1Y2ggYXMgZ2V0dGVyLCBzZXR0ZXIgYW5kIG5vbi1lbnVtcmFibGUgcHJvcGVydGllcy4KICAgKi8KICBzZXRVc2VTdHJpY3RTaGFsbG93Q29weSh2YWx1ZSkgewogICAgdGhpcy51c2VTdHJpY3RTaGFsbG93Q29weV8gPSB2YWx1ZTsKICB9CiAgLyoqCiAgICogUGFzcyBmYWxzZSB0byB1c2UgZmFzdGVyIGl0ZXJhdGlvbiB0aGF0IHNraXBzIG5vbi1lbnVtZXJhYmxlIHByb3BlcnRpZXMKICAgKiBidXQgc3RpbGwgaGFuZGxlcyBzeW1ib2xzIGZvciBjb21wYXRpYmlsaXR5LgogICAqCiAgICogQnkgZGVmYXVsdCwgc3RyaWN0IGl0ZXJhdGlvbiBpcyBlbmFibGVkIChpbmNsdWRlcyBhbGwgb3duIHByb3BlcnRpZXMpLgogICAqLwogIHNldFVzZVN0cmljdEl0ZXJhdGlvbih2YWx1ZSkgewogICAgdGhpcy51c2VTdHJpY3RJdGVyYXRpb25fID0gdmFsdWU7CiAgfQogIHNob3VsZFVzZVN0cmljdEl0ZXJhdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnVzZVN0cmljdEl0ZXJhdGlvbl87CiAgfQogIGFwcGx5UGF0Y2hlcyhiYXNlLCBwYXRjaGVzKSB7CiAgICBsZXQgaTsKICAgIGZvciAoaSA9IHBhdGNoZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgcGF0Y2ggPSBwYXRjaGVzW2ldOwogICAgICBpZiAocGF0Y2gucGF0aC5sZW5ndGggPT09IDAgJiYgcGF0Y2gub3AgPT09ICJyZXBsYWNlIikgewogICAgICAgIGJhc2UgPSBwYXRjaC52YWx1ZTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogICAgaWYgKGkgPiAtMSkgewogICAgICBwYXRjaGVzID0gcGF0Y2hlcy5zbGljZShpICsgMSk7CiAgICB9CiAgICBjb25zdCBhcHBseVBhdGNoZXNJbXBsID0gZ2V0UGx1Z2luMigiUGF0Y2hlcyIpLmFwcGx5UGF0Y2hlc187CiAgICBpZiAoaXNEcmFmdDIoYmFzZSkpIHsKICAgICAgcmV0dXJuIGFwcGx5UGF0Y2hlc0ltcGwoYmFzZSwgcGF0Y2hlcyk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5wcm9kdWNlKAogICAgICBiYXNlLAogICAgICAoZHJhZnQpID0+IGFwcGx5UGF0Y2hlc0ltcGwoZHJhZnQsIHBhdGNoZXMpCiAgICApOwogIH0KfTsKZnVuY3Rpb24gY3JlYXRlUHJveHkyKHZhbHVlLCBwYXJlbnQpIHsKICBjb25zdCBkcmFmdCA9IGlzTWFwMih2YWx1ZSkgPyBnZXRQbHVnaW4yKCJNYXBTZXQiKS5wcm94eU1hcF8odmFsdWUsIHBhcmVudCkgOiBpc1NldDIodmFsdWUpID8gZ2V0UGx1Z2luMigiTWFwU2V0IikucHJveHlTZXRfKHZhbHVlLCBwYXJlbnQpIDogY3JlYXRlUHJveHlQcm94eTIodmFsdWUsIHBhcmVudCk7CiAgY29uc3Qgc2NvcGUgPSBwYXJlbnQgPyBwYXJlbnQuc2NvcGVfIDogZ2V0Q3VycmVudFNjb3BlMigpOwogIHNjb3BlLmRyYWZ0c18ucHVzaChkcmFmdCk7CiAgcmV0dXJuIGRyYWZ0Owp9CmZ1bmN0aW9uIGN1cnJlbnQyKHZhbHVlKSB7CiAgaWYgKCFpc0RyYWZ0Mih2YWx1ZSkpCiAgICBkaWUyKDEwLCB2YWx1ZSk7CiAgcmV0dXJuIGN1cnJlbnRJbXBsMih2YWx1ZSk7Cn0KZnVuY3Rpb24gY3VycmVudEltcGwyKHZhbHVlKSB7CiAgaWYgKCFpc0RyYWZ0YWJsZTIodmFsdWUpIHx8IGlzRnJvemVuMih2YWx1ZSkpCiAgICByZXR1cm4gdmFsdWU7CiAgY29uc3Qgc3RhdGUgPSB2YWx1ZVtEUkFGVF9TVEFURTJdOwogIGxldCBjb3B5MzsKICBsZXQgc3RyaWN0ID0gdHJ1ZTsKICBpZiAoc3RhdGUpIHsKICAgIGlmICghc3RhdGUubW9kaWZpZWRfKQogICAgICByZXR1cm4gc3RhdGUuYmFzZV87CiAgICBzdGF0ZS5maW5hbGl6ZWRfID0gdHJ1ZTsKICAgIGNvcHkzID0gc2hhbGxvd0NvcHkyKHZhbHVlLCBzdGF0ZS5zY29wZV8uaW1tZXJfLnVzZVN0cmljdFNoYWxsb3dDb3B5Xyk7CiAgICBzdHJpY3QgPSBzdGF0ZS5zY29wZV8uaW1tZXJfLnNob3VsZFVzZVN0cmljdEl0ZXJhdGlvbigpOwogIH0gZWxzZSB7CiAgICBjb3B5MyA9IHNoYWxsb3dDb3B5Mih2YWx1ZSwgdHJ1ZSk7CiAgfQogIGVhY2gyKAogICAgY29weTMsCiAgICAoa2V5LCBjaGlsZFZhbHVlKSA9PiB7CiAgICAgIHNldDIoY29weTMsIGtleSwgY3VycmVudEltcGwyKGNoaWxkVmFsdWUpKTsKICAgIH0sCiAgICBzdHJpY3QKICApOwogIGlmIChzdGF0ZSkgewogICAgc3RhdGUuZmluYWxpemVkXyA9IGZhbHNlOwogIH0KICByZXR1cm4gY29weTM7Cn0KdmFyIGltbWVyMiA9IG5ldyBJbW1lcjIyKCk7CnZhciBwcm9kdWNlMiA9IGltbWVyMi5wcm9kdWNlOwpmdW5jdGlvbiBjYXN0RHJhZnQodmFsdWUpIHsKICByZXR1cm4gdmFsdWU7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2xlZ2VuZFNsaWNlLmpzCnZhciBpbml0aWFsU3RhdGUyID0gewogIHNldHRpbmdzOiB7CiAgICBsYXlvdXQ6ICJob3Jpem9udGFsIiwKICAgIGFsaWduOiAiY2VudGVyIiwKICAgIHZlcnRpY2FsQWxpZ246ICJtaWRkbGUiLAogICAgaXRlbVNvcnRlcjogInZhbHVlIgogIH0sCiAgc2l6ZTogewogICAgd2lkdGg6IDAsCiAgICBoZWlnaHQ6IDAKICB9LAogIHBheWxvYWQ6IFtdCn07CnZhciBsZWdlbmRTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAibGVnZW5kIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTIsCiAgcmVkdWNlcnM6IHsKICAgIHNldExlZ2VuZFNpemUoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zaXplLndpZHRoID0gYWN0aW9uLnBheWxvYWQud2lkdGg7CiAgICAgIHN0YXRlLnNpemUuaGVpZ2h0ID0gYWN0aW9uLnBheWxvYWQuaGVpZ2h0OwogICAgfSwKICAgIHNldExlZ2VuZFNldHRpbmdzKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc2V0dGluZ3MuYWxpZ24gPSBhY3Rpb24ucGF5bG9hZC5hbGlnbjsKICAgICAgc3RhdGUuc2V0dGluZ3MubGF5b3V0ID0gYWN0aW9uLnBheWxvYWQubGF5b3V0OwogICAgICBzdGF0ZS5zZXR0aW5ncy52ZXJ0aWNhbEFsaWduID0gYWN0aW9uLnBheWxvYWQudmVydGljYWxBbGlnbjsKICAgICAgc3RhdGUuc2V0dGluZ3MuaXRlbVNvcnRlciA9IGFjdGlvbi5wYXlsb2FkLml0ZW1Tb3J0ZXI7CiAgICB9LAogICAgYWRkTGVnZW5kUGF5bG9hZDogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS5wYXlsb2FkLnB1c2goY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVwbGFjZUxlZ2VuZFBheWxvYWQ6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHByZXYsCiAgICAgICAgICBuZXh0CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLnBheWxvYWQuaW5kZXhPZihjYXN0RHJhZnQocHJldikpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS5wYXlsb2FkW2luZGV4XSA9IGNhc3REcmFmdChuZXh0KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlTGVnZW5kUGF5bG9hZDogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5wYXlsb2FkLmluZGV4T2YoY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLnBheWxvYWQuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9CiAgfQp9KTsKdmFyIHsKICBzZXRMZWdlbmRTaXplLAogIHNldExlZ2VuZFNldHRpbmdzLAogIGFkZExlZ2VuZFBheWxvYWQsCiAgcmVwbGFjZUxlZ2VuZFBheWxvYWQsCiAgcmVtb3ZlTGVnZW5kUGF5bG9hZAp9ID0gbGVnZW5kU2xpY2UuYWN0aW9uczsKdmFyIGxlZ2VuZFJlZHVjZXIgPSBsZWdlbmRTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1Rvb2x0aXAuanMKdmFyIFJlYWN0MTIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QyNCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdF9kb20yID0gX190b0VTTShyZXF1aXJlX3JlYWN0X2RvbSgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9EZWZhdWx0VG9vbHRpcENvbnRlbnQuanMKdmFyIFJlYWN0NSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9zb3J0QnkzID0gX190b0VTTShyZXF1aXJlX3NvcnRCeTIoKSk7CmZ1bmN0aW9uIF9leHRlbmRzNCgpIHsKICByZXR1cm4gX2V4dGVuZHM0ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHM0LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gb3duS2V5czUoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQ1KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzNShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5NShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXM1KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHk1KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5NShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXk1KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTUodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlNSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gZGVmYXVsdEZvcm1hdHRlcih2YWx1ZSkgewogIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSAmJiBpc051bU9yU3RyKHZhbHVlWzBdKSAmJiBpc051bU9yU3RyKHZhbHVlWzFdKSA/IHZhbHVlLmpvaW4oIiB+ICIpIDogdmFsdWU7Cn0KdmFyIERlZmF1bHRUb29sdGlwQ29udGVudCA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICBzZXBhcmF0b3IgPSAiIDogIiwKICAgIGNvbnRlbnRTdHlsZSA9IHt9LAogICAgaXRlbVN0eWxlID0ge30sCiAgICBsYWJlbFN0eWxlID0ge30sCiAgICBwYXlsb2FkLAogICAgZm9ybWF0dGVyLAogICAgaXRlbVNvcnRlciwKICAgIHdyYXBwZXJDbGFzc05hbWUsCiAgICBsYWJlbENsYXNzTmFtZSwKICAgIGxhYmVsLAogICAgbGFiZWxGb3JtYXR0ZXIsCiAgICBhY2Nlc3NpYmlsaXR5TGF5ZXIgPSBmYWxzZQogIH0gPSBwcm9wczsKICB2YXIgcmVuZGVyQ29udGVudDIgPSAoKSA9PiB7CiAgICBpZiAocGF5bG9hZCAmJiBwYXlsb2FkLmxlbmd0aCkgewogICAgICB2YXIgbGlzdFN0eWxlID0gewogICAgICAgIHBhZGRpbmc6IDAsCiAgICAgICAgbWFyZ2luOiAwCiAgICAgIH07CiAgICAgIHZhciBpdGVtcyA9IChpdGVtU29ydGVyID8gKDAsIGltcG9ydF9zb3J0QnkzLmRlZmF1bHQpKHBheWxvYWQsIGl0ZW1Tb3J0ZXIpIDogcGF5bG9hZCkubWFwKChlbnRyeSwgaSkgPT4gewogICAgICAgIGlmIChlbnRyeS50eXBlID09PSAibm9uZSIpIHsKICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgICAgICB2YXIgZmluYWxGb3JtYXR0ZXIgPSBlbnRyeS5mb3JtYXR0ZXIgfHwgZm9ybWF0dGVyIHx8IGRlZmF1bHRGb3JtYXR0ZXI7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHZhbHVlLAogICAgICAgICAgbmFtZQogICAgICAgIH0gPSBlbnRyeTsKICAgICAgICB2YXIgZmluYWxWYWx1ZSA9IHZhbHVlOwogICAgICAgIHZhciBmaW5hbE5hbWUgPSBuYW1lOwogICAgICAgIGlmIChmaW5hbEZvcm1hdHRlcikgewogICAgICAgICAgdmFyIGZvcm1hdHRlZCA9IGZpbmFsRm9ybWF0dGVyKHZhbHVlLCBuYW1lLCBlbnRyeSwgaSwgcGF5bG9hZCk7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShmb3JtYXR0ZWQpKSB7CiAgICAgICAgICAgIFtmaW5hbFZhbHVlLCBmaW5hbE5hbWVdID0gZm9ybWF0dGVkOwogICAgICAgICAgfSBlbHNlIGlmIChmb3JtYXR0ZWQgIT0gbnVsbCkgewogICAgICAgICAgICBmaW5hbFZhbHVlID0gZm9ybWF0dGVkOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBmaW5hbEl0ZW1TdHlsZSA9IF9vYmplY3RTcHJlYWQ1KHsKICAgICAgICAgIGRpc3BsYXk6ICJibG9jayIsCiAgICAgICAgICBwYWRkaW5nVG9wOiA0LAogICAgICAgICAgcGFkZGluZ0JvdHRvbTogNCwKICAgICAgICAgIGNvbG9yOiBlbnRyeS5jb2xvciB8fCAiIzAwMCIKICAgICAgICB9LCBpdGVtU3R5bGUpOwogICAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q1LmNyZWF0ZUVsZW1lbnQoImxpIiwgewogICAgICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtdG9vbHRpcC1pdGVtIiwKICAgICAgICAgIGtleTogInRvb2x0aXAtaXRlbS0iLmNvbmNhdChpKSwKICAgICAgICAgIHN0eWxlOiBmaW5hbEl0ZW1TdHlsZQogICAgICAgIH0sIGlzTnVtT3JTdHIoZmluYWxOYW1lKSA/IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgic3BhbiIsIHsKICAgICAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXRvb2x0aXAtaXRlbS1uYW1lIgogICAgICAgIH0sIGZpbmFsTmFtZSkgOiBudWxsLCBpc051bU9yU3RyKGZpbmFsTmFtZSkgPyAvKiBAX19QVVJFX18gKi8gUmVhY3Q1LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCB7CiAgICAgICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy10b29sdGlwLWl0ZW0tc2VwYXJhdG9yIgogICAgICAgIH0sIHNlcGFyYXRvcikgOiBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3Q1LmNyZWF0ZUVsZW1lbnQoInNwYW4iLCB7CiAgICAgICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy10b29sdGlwLWl0ZW0tdmFsdWUiCiAgICAgICAgfSwgZmluYWxWYWx1ZSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgic3BhbiIsIHsKICAgICAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXRvb2x0aXAtaXRlbS11bml0IgogICAgICAgIH0sIGVudHJ5LnVuaXQgfHwgIiIpKTsKICAgICAgfSk7CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q1LmNyZWF0ZUVsZW1lbnQoInVsIiwgewogICAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLXRvb2x0aXAtaXRlbS1saXN0IiwKICAgICAgICBzdHlsZTogbGlzdFN0eWxlCiAgICAgIH0sIGl0ZW1zKTsKICAgIH0KICAgIHJldHVybiBudWxsOwogIH07CiAgdmFyIGZpbmFsU3R5bGUgPSBfb2JqZWN0U3ByZWFkNSh7CiAgICBtYXJnaW46IDAsCiAgICBwYWRkaW5nOiAxMCwKICAgIGJhY2tncm91bmRDb2xvcjogIiNmZmYiLAogICAgYm9yZGVyOiAiMXB4IHNvbGlkICNjY2MiLAogICAgd2hpdGVTcGFjZTogIm5vd3JhcCIKICB9LCBjb250ZW50U3R5bGUpOwogIHZhciBmaW5hbExhYmVsU3R5bGUgPSBfb2JqZWN0U3ByZWFkNSh7CiAgICBtYXJnaW46IDAKICB9LCBsYWJlbFN0eWxlKTsKICB2YXIgaGFzTGFiZWwgPSAhaXNOdWxsaXNoKGxhYmVsKTsKICB2YXIgZmluYWxMYWJlbCA9IGhhc0xhYmVsID8gbGFiZWwgOiAiIjsKICB2YXIgd3JhcHBlckNOID0gY2xzeCgicmVjaGFydHMtZGVmYXVsdC10b29sdGlwIiwgd3JhcHBlckNsYXNzTmFtZSk7CiAgdmFyIGxhYmVsQ04gPSBjbHN4KCJyZWNoYXJ0cy10b29sdGlwLWxhYmVsIiwgbGFiZWxDbGFzc05hbWUpOwogIGlmIChoYXNMYWJlbCAmJiBsYWJlbEZvcm1hdHRlciAmJiBwYXlsb2FkICE9PSB2b2lkIDAgJiYgcGF5bG9hZCAhPT0gbnVsbCkgewogICAgZmluYWxMYWJlbCA9IGxhYmVsRm9ybWF0dGVyKGxhYmVsLCBwYXlsb2FkKTsKICB9CiAgdmFyIGFjY2Vzc2liaWxpdHlBdHRyaWJ1dGVzID0gYWNjZXNzaWJpbGl0eUxheWVyID8gewogICAgcm9sZTogInN0YXR1cyIsCiAgICAiYXJpYS1saXZlIjogImFzc2VydGl2ZSIKICB9IDoge307CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgiZGl2IiwgX2V4dGVuZHM0KHsKICAgIGNsYXNzTmFtZTogd3JhcHBlckNOLAogICAgc3R5bGU6IGZpbmFsU3R5bGUKICB9LCBhY2Nlc3NpYmlsaXR5QXR0cmlidXRlcyksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDUuY3JlYXRlRWxlbWVudCgicCIsIHsKICAgIGNsYXNzTmFtZTogbGFiZWxDTiwKICAgIHN0eWxlOiBmaW5hbExhYmVsU3R5bGUKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3Q1LmlzVmFsaWRFbGVtZW50KGZpbmFsTGFiZWwpID8gZmluYWxMYWJlbCA6ICIiLmNvbmNhdChmaW5hbExhYmVsKSksIHJlbmRlckNvbnRlbnQyKCkpOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1Rvb2x0aXBCb3VuZGluZ0JveC5qcwp2YXIgUmVhY3Q2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MTQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3Rvb2x0aXAvdHJhbnNsYXRlLmpzCnZhciBDU1NfQ0xBU1NfUFJFRklYID0gInJlY2hhcnRzLXRvb2x0aXAtd3JhcHBlciI7CnZhciBUT09MVElQX0hJRERFTiA9IHsKICB2aXNpYmlsaXR5OiAiaGlkZGVuIgp9OwpmdW5jdGlvbiBnZXRUb29sdGlwQ1NTQ2xhc3NOYW1lKF9yZWYyKSB7CiAgdmFyIHsKICAgIGNvb3JkaW5hdGUsCiAgICB0cmFuc2xhdGVYLAogICAgdHJhbnNsYXRlWQogIH0gPSBfcmVmMjsKICByZXR1cm4gY2xzeChDU1NfQ0xBU1NfUFJFRklYLCB7CiAgICBbIiIuY29uY2F0KENTU19DTEFTU19QUkVGSVgsICItcmlnaHQiKV06IGlzTnVtYmVyKHRyYW5zbGF0ZVgpICYmIGNvb3JkaW5hdGUgJiYgaXNOdW1iZXIoY29vcmRpbmF0ZS54KSAmJiB0cmFuc2xhdGVYID49IGNvb3JkaW5hdGUueCwKICAgIFsiIi5jb25jYXQoQ1NTX0NMQVNTX1BSRUZJWCwgIi1sZWZ0IildOiBpc051bWJlcih0cmFuc2xhdGVYKSAmJiBjb29yZGluYXRlICYmIGlzTnVtYmVyKGNvb3JkaW5hdGUueCkgJiYgdHJhbnNsYXRlWCA8IGNvb3JkaW5hdGUueCwKICAgIFsiIi5jb25jYXQoQ1NTX0NMQVNTX1BSRUZJWCwgIi1ib3R0b20iKV06IGlzTnVtYmVyKHRyYW5zbGF0ZVkpICYmIGNvb3JkaW5hdGUgJiYgaXNOdW1iZXIoY29vcmRpbmF0ZS55KSAmJiB0cmFuc2xhdGVZID49IGNvb3JkaW5hdGUueSwKICAgIFsiIi5jb25jYXQoQ1NTX0NMQVNTX1BSRUZJWCwgIi10b3AiKV06IGlzTnVtYmVyKHRyYW5zbGF0ZVkpICYmIGNvb3JkaW5hdGUgJiYgaXNOdW1iZXIoY29vcmRpbmF0ZS55KSAmJiB0cmFuc2xhdGVZIDwgY29vcmRpbmF0ZS55CiAgfSk7Cn0KZnVuY3Rpb24gZ2V0VG9vbHRpcFRyYW5zbGF0ZVhZKF9yZWYyKSB7CiAgdmFyIHsKICAgIGFsbG93RXNjYXBlVmlld0JveCwKICAgIGNvb3JkaW5hdGUsCiAgICBrZXksCiAgICBvZmZzZXRUb3BMZWZ0LAogICAgcG9zaXRpb24sCiAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgdG9vbHRpcERpbWVuc2lvbiwKICAgIHZpZXdCb3gsCiAgICB2aWV3Qm94RGltZW5zaW9uCiAgfSA9IF9yZWYyOwogIGlmIChwb3NpdGlvbiAmJiBpc051bWJlcihwb3NpdGlvbltrZXldKSkgewogICAgcmV0dXJuIHBvc2l0aW9uW2tleV07CiAgfQogIHZhciBuZWdhdGl2ZSA9IGNvb3JkaW5hdGVba2V5XSAtIHRvb2x0aXBEaW1lbnNpb24gLSAob2Zmc2V0VG9wTGVmdCA+IDAgPyBvZmZzZXRUb3BMZWZ0IDogMCk7CiAgdmFyIHBvc2l0aXZlID0gY29vcmRpbmF0ZVtrZXldICsgb2Zmc2V0VG9wTGVmdDsKICBpZiAoYWxsb3dFc2NhcGVWaWV3Qm94W2tleV0pIHsKICAgIHJldHVybiByZXZlcnNlRGlyZWN0aW9uW2tleV0gPyBuZWdhdGl2ZSA6IHBvc2l0aXZlOwogIH0KICB2YXIgdmlld0JveEtleSA9IHZpZXdCb3hba2V5XTsKICBpZiAodmlld0JveEtleSA9PSBudWxsKSB7CiAgICByZXR1cm4gMDsKICB9CiAgaWYgKHJldmVyc2VEaXJlY3Rpb25ba2V5XSkgewogICAgdmFyIF90b29sdGlwQm91bmRhcnkgPSBuZWdhdGl2ZTsKICAgIHZhciBfdmlld0JveEJvdW5kYXJ5ID0gdmlld0JveEtleTsKICAgIGlmIChfdG9vbHRpcEJvdW5kYXJ5IDwgX3ZpZXdCb3hCb3VuZGFyeSkgewogICAgICByZXR1cm4gTWF0aC5tYXgocG9zaXRpdmUsIHZpZXdCb3hLZXkpOwogICAgfQogICAgcmV0dXJuIE1hdGgubWF4KG5lZ2F0aXZlLCB2aWV3Qm94S2V5KTsKICB9CiAgaWYgKHZpZXdCb3hEaW1lbnNpb24gPT0gbnVsbCkgewogICAgcmV0dXJuIDA7CiAgfQogIHZhciB0b29sdGlwQm91bmRhcnkgPSBwb3NpdGl2ZSArIHRvb2x0aXBEaW1lbnNpb247CiAgdmFyIHZpZXdCb3hCb3VuZGFyeSA9IHZpZXdCb3hLZXkgKyB2aWV3Qm94RGltZW5zaW9uOwogIGlmICh0b29sdGlwQm91bmRhcnkgPiB2aWV3Qm94Qm91bmRhcnkpIHsKICAgIHJldHVybiBNYXRoLm1heChuZWdhdGl2ZSwgdmlld0JveEtleSk7CiAgfQogIHJldHVybiBNYXRoLm1heChwb3NpdGl2ZSwgdmlld0JveEtleSk7Cn0KZnVuY3Rpb24gZ2V0VHJhbnNmb3JtU3R5bGUoX3JlZjMpIHsKICB2YXIgewogICAgdHJhbnNsYXRlWCwKICAgIHRyYW5zbGF0ZVksCiAgICB1c2VUcmFuc2xhdGUzZAogIH0gPSBfcmVmMzsKICByZXR1cm4gewogICAgdHJhbnNmb3JtOiB1c2VUcmFuc2xhdGUzZCA/ICJ0cmFuc2xhdGUzZCgiLmNvbmNhdCh0cmFuc2xhdGVYLCAicHgsICIpLmNvbmNhdCh0cmFuc2xhdGVZLCAicHgsIDApIikgOiAidHJhbnNsYXRlKCIuY29uY2F0KHRyYW5zbGF0ZVgsICJweCwgIikuY29uY2F0KHRyYW5zbGF0ZVksICJweCkiKQogIH07Cn0KZnVuY3Rpb24gZ2V0VG9vbHRpcFRyYW5zbGF0ZShfcmVmNCkgewogIHZhciB7CiAgICBhbGxvd0VzY2FwZVZpZXdCb3gsCiAgICBjb29yZGluYXRlLAogICAgb2Zmc2V0VG9wTGVmdCwKICAgIHBvc2l0aW9uLAogICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgIHRvb2x0aXBCb3gsCiAgICB1c2VUcmFuc2xhdGUzZCwKICAgIHZpZXdCb3gKICB9ID0gX3JlZjQ7CiAgdmFyIGNzc1Byb3BlcnRpZXMsIHRyYW5zbGF0ZVgsIHRyYW5zbGF0ZVk7CiAgaWYgKHRvb2x0aXBCb3guaGVpZ2h0ID4gMCAmJiB0b29sdGlwQm94LndpZHRoID4gMCAmJiBjb29yZGluYXRlKSB7CiAgICB0cmFuc2xhdGVYID0gZ2V0VG9vbHRpcFRyYW5zbGF0ZVhZKHsKICAgICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgICBjb29yZGluYXRlLAogICAgICBrZXk6ICJ4IiwKICAgICAgb2Zmc2V0VG9wTGVmdCwKICAgICAgcG9zaXRpb24sCiAgICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICAgIHRvb2x0aXBEaW1lbnNpb246IHRvb2x0aXBCb3gud2lkdGgsCiAgICAgIHZpZXdCb3gsCiAgICAgIHZpZXdCb3hEaW1lbnNpb246IHZpZXdCb3gud2lkdGgKICAgIH0pOwogICAgdHJhbnNsYXRlWSA9IGdldFRvb2x0aXBUcmFuc2xhdGVYWSh7CiAgICAgIGFsbG93RXNjYXBlVmlld0JveCwKICAgICAgY29vcmRpbmF0ZSwKICAgICAga2V5OiAieSIsCiAgICAgIG9mZnNldFRvcExlZnQsCiAgICAgIHBvc2l0aW9uLAogICAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgICB0b29sdGlwRGltZW5zaW9uOiB0b29sdGlwQm94LmhlaWdodCwKICAgICAgdmlld0JveCwKICAgICAgdmlld0JveERpbWVuc2lvbjogdmlld0JveC5oZWlnaHQKICAgIH0pOwogICAgY3NzUHJvcGVydGllcyA9IGdldFRyYW5zZm9ybVN0eWxlKHsKICAgICAgdHJhbnNsYXRlWCwKICAgICAgdHJhbnNsYXRlWSwKICAgICAgdXNlVHJhbnNsYXRlM2QKICAgIH0pOwogIH0gZWxzZSB7CiAgICBjc3NQcm9wZXJ0aWVzID0gVE9PTFRJUF9ISURERU47CiAgfQogIHJldHVybiB7CiAgICBjc3NQcm9wZXJ0aWVzLAogICAgY3NzQ2xhc3NlczogZ2V0VG9vbHRpcENTU0NsYXNzTmFtZSh7CiAgICAgIHRyYW5zbGF0ZVgsCiAgICAgIHRyYW5zbGF0ZVksCiAgICAgIGNvb3JkaW5hdGUKICAgIH0pCiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1Rvb2x0aXBCb3VuZGluZ0JveC5qcwpmdW5jdGlvbiBvd25LZXlzNihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDYoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXM2KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHk2KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czYoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTYoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXk2KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTYodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlNih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmU2KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgVG9vbHRpcEJvdW5kaW5nQm94ID0gY2xhc3MgZXh0ZW5kcyBpbXBvcnRfcmVhY3QxNC5QdXJlQ29tcG9uZW50IHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIHN1cGVyKC4uLmFyZ3VtZW50cyk7CiAgICBfZGVmaW5lUHJvcGVydHk2KHRoaXMsICJzdGF0ZSIsIHsKICAgICAgZGlzbWlzc2VkOiBmYWxzZSwKICAgICAgZGlzbWlzc2VkQXRDb29yZGluYXRlOiB7CiAgICAgICAgeDogMCwKICAgICAgICB5OiAwCiAgICAgIH0KICAgIH0pOwogICAgX2RlZmluZVByb3BlcnR5Nih0aGlzLCAiaGFuZGxlS2V5RG93biIsIChldmVudCkgPT4gewogICAgICBpZiAoZXZlbnQua2V5ID09PSAiRXNjYXBlIikgewogICAgICAgIHZhciBfdGhpcyRwcm9wcyRjb29yZGluYXQsIF90aGlzJHByb3BzJGNvb3JkaW5hdDIsIF90aGlzJHByb3BzJGNvb3JkaW5hdDMsIF90aGlzJHByb3BzJGNvb3JkaW5hdDQ7CiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7CiAgICAgICAgICBkaXNtaXNzZWQ6IHRydWUsCiAgICAgICAgICBkaXNtaXNzZWRBdENvb3JkaW5hdGU6IHsKICAgICAgICAgICAgeDogKF90aGlzJHByb3BzJGNvb3JkaW5hdCA9IChfdGhpcyRwcm9wcyRjb29yZGluYXQyID0gdGhpcy5wcm9wcy5jb29yZGluYXRlKSA9PT0gbnVsbCB8fCBfdGhpcyRwcm9wcyRjb29yZGluYXQyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdGhpcyRwcm9wcyRjb29yZGluYXQyLngpICE9PSBudWxsICYmIF90aGlzJHByb3BzJGNvb3JkaW5hdCAhPT0gdm9pZCAwID8gX3RoaXMkcHJvcHMkY29vcmRpbmF0IDogMCwKICAgICAgICAgICAgeTogKF90aGlzJHByb3BzJGNvb3JkaW5hdDMgPSAoX3RoaXMkcHJvcHMkY29vcmRpbmF0NCA9IHRoaXMucHJvcHMuY29vcmRpbmF0ZSkgPT09IG51bGwgfHwgX3RoaXMkcHJvcHMkY29vcmRpbmF0NCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RoaXMkcHJvcHMkY29vcmRpbmF0NC55KSAhPT0gbnVsbCAmJiBfdGhpcyRwcm9wcyRjb29yZGluYXQzICE9PSB2b2lkIDAgPyBfdGhpcyRwcm9wcyRjb29yZGluYXQzIDogMAogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9CiAgY29tcG9uZW50RGlkTW91bnQoKSB7CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy5oYW5kbGVLZXlEb3duKTsKICB9CiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7CiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgdGhpcy5oYW5kbGVLZXlEb3duKTsKICB9CiAgY29tcG9uZW50RGlkVXBkYXRlKCkgewogICAgdmFyIF90aGlzJHByb3BzJGNvb3JkaW5hdDUsIF90aGlzJHByb3BzJGNvb3JkaW5hdDY7CiAgICBpZiAoIXRoaXMuc3RhdGUuZGlzbWlzc2VkKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICgoKF90aGlzJHByb3BzJGNvb3JkaW5hdDUgPSB0aGlzLnByb3BzLmNvb3JkaW5hdGUpID09PSBudWxsIHx8IF90aGlzJHByb3BzJGNvb3JkaW5hdDUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJHByb3BzJGNvb3JkaW5hdDUueCkgIT09IHRoaXMuc3RhdGUuZGlzbWlzc2VkQXRDb29yZGluYXRlLnggfHwgKChfdGhpcyRwcm9wcyRjb29yZGluYXQ2ID0gdGhpcy5wcm9wcy5jb29yZGluYXRlKSA9PT0gbnVsbCB8fCBfdGhpcyRwcm9wcyRjb29yZGluYXQ2ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfdGhpcyRwcm9wcyRjb29yZGluYXQ2LnkpICE9PSB0aGlzLnN0YXRlLmRpc21pc3NlZEF0Q29vcmRpbmF0ZS55KSB7CiAgICAgIHRoaXMuc3RhdGUuZGlzbWlzc2VkID0gZmFsc2U7CiAgICB9CiAgfQogIHJlbmRlcigpIHsKICAgIHZhciB7CiAgICAgIGFjdGl2ZSwKICAgICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgICAgYW5pbWF0aW9uRWFzaW5nLAogICAgICBjaGlsZHJlbiwKICAgICAgY29vcmRpbmF0ZSwKICAgICAgaGFzUGF5bG9hZCwKICAgICAgaXNBbmltYXRpb25BY3RpdmUsCiAgICAgIG9mZnNldCwKICAgICAgcG9zaXRpb24sCiAgICAgIHJldmVyc2VEaXJlY3Rpb24sCiAgICAgIHVzZVRyYW5zbGF0ZTNkLAogICAgICB2aWV3Qm94LAogICAgICB3cmFwcGVyU3R5bGUsCiAgICAgIGxhc3RCb3VuZGluZ0JveCwKICAgICAgaW5uZXJSZWYsCiAgICAgIGhhc1BvcnRhbEZyb21Qcm9wcwogICAgfSA9IHRoaXMucHJvcHM7CiAgICB2YXIgewogICAgICBjc3NDbGFzc2VzLAogICAgICBjc3NQcm9wZXJ0aWVzCiAgICB9ID0gZ2V0VG9vbHRpcFRyYW5zbGF0ZSh7CiAgICAgIGFsbG93RXNjYXBlVmlld0JveCwKICAgICAgY29vcmRpbmF0ZSwKICAgICAgb2Zmc2V0VG9wTGVmdDogb2Zmc2V0LAogICAgICBwb3NpdGlvbiwKICAgICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgICAgdG9vbHRpcEJveDogewogICAgICAgIGhlaWdodDogbGFzdEJvdW5kaW5nQm94LmhlaWdodCwKICAgICAgICB3aWR0aDogbGFzdEJvdW5kaW5nQm94LndpZHRoCiAgICAgIH0sCiAgICAgIHVzZVRyYW5zbGF0ZTNkLAogICAgICB2aWV3Qm94CiAgICB9KTsKICAgIHZhciBwb3NpdGlvblN0eWxlcyA9IGhhc1BvcnRhbEZyb21Qcm9wcyA/IHt9IDogX29iamVjdFNwcmVhZDYoX29iamVjdFNwcmVhZDYoewogICAgICB0cmFuc2l0aW9uOiBpc0FuaW1hdGlvbkFjdGl2ZSAmJiBhY3RpdmUgPyAidHJhbnNmb3JtICIuY29uY2F0KGFuaW1hdGlvbkR1cmF0aW9uLCAibXMgIikuY29uY2F0KGFuaW1hdGlvbkVhc2luZykgOiB2b2lkIDAKICAgIH0sIGNzc1Byb3BlcnRpZXMpLCB7fSwgewogICAgICBwb2ludGVyRXZlbnRzOiAibm9uZSIsCiAgICAgIHZpc2liaWxpdHk6ICF0aGlzLnN0YXRlLmRpc21pc3NlZCAmJiBhY3RpdmUgJiYgaGFzUGF5bG9hZCA/ICJ2aXNpYmxlIiA6ICJoaWRkZW4iLAogICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgdG9wOiAwLAogICAgICBsZWZ0OiAwCiAgICB9KTsKICAgIHZhciBvdXRlclN0eWxlID0gX29iamVjdFNwcmVhZDYoX29iamVjdFNwcmVhZDYoe30sIHBvc2l0aW9uU3R5bGVzKSwge30sIHsKICAgICAgdmlzaWJpbGl0eTogIXRoaXMuc3RhdGUuZGlzbWlzc2VkICYmIGFjdGl2ZSAmJiBoYXNQYXlsb2FkID8gInZpc2libGUiIDogImhpZGRlbiIKICAgIH0sIHdyYXBwZXJTdHlsZSk7CiAgICByZXR1cm4gKAogICAgICAvLyBUaGlzIGVsZW1lbnQgYWxsb3cgbGlzdGVuaW5nIHRvIHRoZSBgRXNjYXBlYCBrZXkuIFNlZSBodHRwczovL2dpdGh1Yi5jb20vcmVjaGFydHMvcmVjaGFydHMvcHVsbC8yOTI1CiAgICAgIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDYuY3JlYXRlRWxlbWVudCgiZGl2IiwgewogICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgdHlwZXNjcmlwdCBsaWJyYXJ5IGRvZXMgbm90IHJlY29nbml6ZSB4bWxucyBhdHRyaWJ1dGUsIGJ1dCBpdCdzIHJlcXVpcmVkIGZvciBhbiBIVE1MIGNodW5rIGluc2lkZSBTVkcuCiAgICAgICAgeG1sbnM6ICJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiwKICAgICAgICB0YWJJbmRleDogLTEsCiAgICAgICAgY2xhc3NOYW1lOiBjc3NDbGFzc2VzLAogICAgICAgIHN0eWxlOiBvdXRlclN0eWxlLAogICAgICAgIHJlZjogaW5uZXJSZWYKICAgICAgfSwgY2hpbGRyZW4pCiAgICApOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRleHQvYWNjZXNzaWJpbGl0eUNvbnRleHQuanMKdmFyIHVzZUFjY2Vzc2liaWxpdHlMYXllciA9ICgpID0+IHsKICB2YXIgX3VzZUFwcFNlbGVjdG9yOwogIHJldHVybiAoX3VzZUFwcFNlbGVjdG9yID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuYWNjZXNzaWJpbGl0eUxheWVyKSkgIT09IG51bGwgJiYgX3VzZUFwcFNlbGVjdG9yICE9PSB2b2lkIDAgPyBfdXNlQXBwU2VsZWN0b3IgOiB0cnVlOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0N1cnNvci5qcwp2YXIgUmVhY3QxMSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDIxID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc2hhcGUvQ3VydmUuanMKdmFyIFJlYWN0NyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gX2V4dGVuZHM1KCkgewogIHJldHVybiBfZXh0ZW5kczUgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczUuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzNyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDcoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXM3KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHk3KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czcoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTcoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXk3KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTcodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlNyh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmU3KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgQ1VSVkVfRkFDVE9SSUVTID0gewogIGN1cnZlQmFzaXNDbG9zZWQ6IGJhc2lzQ2xvc2VkX2RlZmF1bHQsCiAgY3VydmVCYXNpc09wZW46IGJhc2lzT3Blbl9kZWZhdWx0LAogIGN1cnZlQmFzaXM6IGJhc2lzX2RlZmF1bHQsCiAgY3VydmVCdW1wWDogYnVtcFgsCiAgY3VydmVCdW1wWTogYnVtcFksCiAgY3VydmVMaW5lYXJDbG9zZWQ6IGxpbmVhckNsb3NlZF9kZWZhdWx0LAogIGN1cnZlTGluZWFyOiBsaW5lYXJfZGVmYXVsdCwKICBjdXJ2ZU1vbm90b25lWDogbW9ub3RvbmVYLAogIGN1cnZlTW9ub3RvbmVZOiBtb25vdG9uZVksCiAgY3VydmVOYXR1cmFsOiBuYXR1cmFsX2RlZmF1bHQsCiAgY3VydmVTdGVwOiBzdGVwX2RlZmF1bHQsCiAgY3VydmVTdGVwQWZ0ZXI6IHN0ZXBBZnRlciwKICBjdXJ2ZVN0ZXBCZWZvcmU6IHN0ZXBCZWZvcmUKfTsKdmFyIGRlZmluZWQgPSAocCkgPT4gaXNXZWxsQmVoYXZlZE51bWJlcihwLngpICYmIGlzV2VsbEJlaGF2ZWROdW1iZXIocC55KTsKdmFyIGFyZWFEZWZpbmVkID0gKGQpID0+IGQuYmFzZSAhPSBudWxsICYmIGRlZmluZWQoZC5iYXNlKSAmJiBkZWZpbmVkKGQpOwp2YXIgZ2V0WCA9IChwKSA9PiBwLng7CnZhciBnZXRZID0gKHApID0+IHAueTsKdmFyIGdldEN1cnZlRmFjdG9yeSA9ICh0eXBlLCBsYXlvdXQpID0+IHsKICBpZiAodHlwZW9mIHR5cGUgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiB0eXBlOwogIH0KICB2YXIgbmFtZSA9ICJjdXJ2ZSIuY29uY2F0KHVwcGVyRmlyc3QodHlwZSkpOwogIGlmICgobmFtZSA9PT0gImN1cnZlTW9ub3RvbmUiIHx8IG5hbWUgPT09ICJjdXJ2ZUJ1bXAiKSAmJiBsYXlvdXQpIHsKICAgIHJldHVybiBDVVJWRV9GQUNUT1JJRVNbIiIuY29uY2F0KG5hbWUpLmNvbmNhdChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIgPyAiWSIgOiAiWCIpXTsKICB9CiAgcmV0dXJuIENVUlZFX0ZBQ1RPUklFU1tuYW1lXSB8fCBsaW5lYXJfZGVmYXVsdDsKfTsKdmFyIGdldFBhdGggPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgdHlwZSA9ICJsaW5lYXIiLAogICAgcG9pbnRzID0gW10sCiAgICBiYXNlTGluZSwKICAgIGxheW91dCwKICAgIGNvbm5lY3ROdWxscyA9IGZhbHNlCiAgfSA9IF9yZWYyOwogIHZhciBjdXJ2ZUZhY3RvcnkgPSBnZXRDdXJ2ZUZhY3RvcnkodHlwZSwgbGF5b3V0KTsKICB2YXIgZm9ybWF0UG9pbnRzID0gY29ubmVjdE51bGxzID8gcG9pbnRzLmZpbHRlcihkZWZpbmVkKSA6IHBvaW50czsKICB2YXIgbGluZUZ1bmN0aW9uOwogIGlmIChBcnJheS5pc0FycmF5KGJhc2VMaW5lKSkgewogICAgdmFyIGFyZWFQb2ludHMgPSBwb2ludHMubWFwKChlbnRyeSwgaW5kZXgpID0+IF9vYmplY3RTcHJlYWQ3KF9vYmplY3RTcHJlYWQ3KHt9LCBlbnRyeSksIHt9LCB7CiAgICAgIGJhc2U6IGJhc2VMaW5lW2luZGV4XQogICAgfSkpOwogICAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgICBsaW5lRnVuY3Rpb24gPSBhcmVhX2RlZmF1bHQoKS55KGdldFkpLngxKGdldFgpLngwKChkKSA9PiBkLmJhc2UueCk7CiAgICB9IGVsc2UgewogICAgICBsaW5lRnVuY3Rpb24gPSBhcmVhX2RlZmF1bHQoKS54KGdldFgpLnkxKGdldFkpLnkwKChkKSA9PiBkLmJhc2UueSk7CiAgICB9CiAgICB2YXIgX251bGxhYmxlTGluZUZ1bmN0aW9uID0gbGluZUZ1bmN0aW9uLmRlZmluZWQoYXJlYURlZmluZWQpLmN1cnZlKGN1cnZlRmFjdG9yeSk7CiAgICB2YXIgZmluYWxQb2ludHMgPSBjb25uZWN0TnVsbHMgPyBhcmVhUG9pbnRzLmZpbHRlcihhcmVhRGVmaW5lZCkgOiBhcmVhUG9pbnRzOwogICAgcmV0dXJuIF9udWxsYWJsZUxpbmVGdW5jdGlvbihmaW5hbFBvaW50cyk7CiAgfQogIGlmIChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIgJiYgaXNOdW1iZXIoYmFzZUxpbmUpKSB7CiAgICBsaW5lRnVuY3Rpb24gPSBhcmVhX2RlZmF1bHQoKS55KGdldFkpLngxKGdldFgpLngwKGJhc2VMaW5lKTsKICB9IGVsc2UgaWYgKGlzTnVtYmVyKGJhc2VMaW5lKSkgewogICAgbGluZUZ1bmN0aW9uID0gYXJlYV9kZWZhdWx0KCkueChnZXRYKS55MShnZXRZKS55MChiYXNlTGluZSk7CiAgfSBlbHNlIHsKICAgIGxpbmVGdW5jdGlvbiA9IGxpbmVfZGVmYXVsdCgpLngoZ2V0WCkueShnZXRZKTsKICB9CiAgdmFyIG51bGxhYmxlTGluZUZ1bmN0aW9uID0gbGluZUZ1bmN0aW9uLmRlZmluZWQoZGVmaW5lZCkuY3VydmUoY3VydmVGYWN0b3J5KTsKICByZXR1cm4gbnVsbGFibGVMaW5lRnVuY3Rpb24oZm9ybWF0UG9pbnRzKTsKfTsKdmFyIEN1cnZlID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIGNsYXNzTmFtZSwKICAgIHBvaW50cywKICAgIHBhdGg6IHBhdGgyLAogICAgcGF0aFJlZgogIH0gPSBwcm9wczsKICBpZiAoKCFwb2ludHMgfHwgIXBvaW50cy5sZW5ndGgpICYmICFwYXRoMikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciByZWFsUGF0aCA9IHBvaW50cyAmJiBwb2ludHMubGVuZ3RoID8gZ2V0UGF0aChwcm9wcykgOiBwYXRoMjsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0Ny5jcmVhdGVFbGVtZW50KCJwYXRoIiwgX2V4dGVuZHM1KHt9LCBzdmdQcm9wZXJ0aWVzTm9FdmVudHMocHJvcHMpLCBhZGFwdEV2ZW50SGFuZGxlcnMocHJvcHMpLCB7CiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLWN1cnZlIiwgY2xhc3NOYW1lKSwKICAgIGQ6IHJlYWxQYXRoID09PSBudWxsID8gdm9pZCAwIDogcmVhbFBhdGgsCiAgICByZWY6IHBhdGhSZWYKICB9KSk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zaGFwZS9Dcm9zcy5qcwp2YXIgUmVhY3Q4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkMyA9IFsieCIsICJ5IiwgInRvcCIsICJsZWZ0IiwgIndpZHRoIiwgImhlaWdodCIsICJjbGFzc05hbWUiXTsKZnVuY3Rpb24gX2V4dGVuZHM2KCkgewogIHJldHVybiBfZXh0ZW5kczYgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczYuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBvd25LZXlzOChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDgoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXM4KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHk4KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czgoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTgoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXk4KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTgodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlOCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmU4KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMzKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UzKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UzKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgZ2V0UGF0aDIgPSAoeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCB0b3AsIGxlZnQpID0+IHsKICByZXR1cm4gIk0iLmNvbmNhdCh4MiwgIiwiKS5jb25jYXQodG9wLCAidiIpLmNvbmNhdChoZWlnaHQsICJNIikuY29uY2F0KGxlZnQsICIsIikuY29uY2F0KHkyLCAiaCIpLmNvbmNhdCh3aWR0aCk7Cn07CnZhciBDcm9zcyA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICB4OiB4MiA9IDAsCiAgICB5OiB5MiA9IDAsCiAgICB0b3AgPSAwLAogICAgbGVmdCA9IDAsCiAgICB3aWR0aCA9IDAsCiAgICBoZWlnaHQgPSAwLAogICAgY2xhc3NOYW1lCiAgfSA9IF9yZWYyLCByZXN0ID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMyhfcmVmMiwgX2V4Y2x1ZGVkMyk7CiAgdmFyIHByb3BzID0gX29iamVjdFNwcmVhZDgoewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHRvcCwKICAgIGxlZnQsCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0sIHJlc3QpOwogIGlmICghaXNOdW1iZXIoeDIpIHx8ICFpc051bWJlcih5MikgfHwgIWlzTnVtYmVyKHdpZHRoKSB8fCAhaXNOdW1iZXIoaGVpZ2h0KSB8fCAhaXNOdW1iZXIodG9wKSB8fCAhaXNOdW1iZXIobGVmdCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0OC5jcmVhdGVFbGVtZW50KCJwYXRoIiwgX2V4dGVuZHM2KHt9LCBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzKSwgewogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1jcm9zcyIsIGNsYXNzTmFtZSksCiAgICBkOiBnZXRQYXRoMih4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIHRvcCwgbGVmdCkKICB9KSk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2N1cnNvci9nZXRDdXJzb3JSZWN0YW5nbGUuanMKZnVuY3Rpb24gZ2V0Q3Vyc29yUmVjdGFuZ2xlKGxheW91dCwgYWN0aXZlQ29vcmRpbmF0ZSwgb2Zmc2V0LCB0b29sdGlwQXhpc0JhbmRTaXplKSB7CiAgdmFyIGhhbGZTaXplID0gdG9vbHRpcEF4aXNCYW5kU2l6ZSAvIDI7CiAgcmV0dXJuIHsKICAgIHN0cm9rZTogIm5vbmUiLAogICAgZmlsbDogIiNjY2MiLAogICAgeDogbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgPyBhY3RpdmVDb29yZGluYXRlLnggLSBoYWxmU2l6ZSA6IG9mZnNldC5sZWZ0ICsgMC41LAogICAgeTogbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgPyBvZmZzZXQudG9wICsgMC41IDogYWN0aXZlQ29vcmRpbmF0ZS55IC0gaGFsZlNpemUsCiAgICB3aWR0aDogbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgPyB0b29sdGlwQXhpc0JhbmRTaXplIDogb2Zmc2V0LndpZHRoIC0gMSwKICAgIGhlaWdodDogbGF5b3V0ID09PSAiaG9yaXpvbnRhbCIgPyBvZmZzZXQuaGVpZ2h0IC0gMSA6IHRvb2x0aXBBeGlzQmFuZFNpemUKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zaGFwZS9SZWN0YW5nbGUuanMKdmFyIFJlYWN0OSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDE4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL0phdmFzY3JpcHRBbmltYXRlLmpzCnZhciBpbXBvcnRfcmVhY3QxNiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi91dGlsLmpzCmZ1bmN0aW9uIG93bktleXM5KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkOShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czkoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTkoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzOShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5OShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTkocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5OSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmU5KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTkodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBnZXREYXNoQ2FzZSA9IChuYW1lKSA9PiBuYW1lLnJlcGxhY2UoLyhbQS1aXSkvZywgKHYpID0+ICItIi5jb25jYXQodi50b0xvd2VyQ2FzZSgpKSk7CnZhciBnZXRUcmFuc2l0aW9uVmFsID0gKHByb3BzLCBkdXJhdGlvbiwgZWFzaW5nKSA9PiBwcm9wcy5tYXAoKHByb3ApID0+ICIiLmNvbmNhdChnZXREYXNoQ2FzZShwcm9wKSwgIiAiKS5jb25jYXQoZHVyYXRpb24sICJtcyAiKS5jb25jYXQoZWFzaW5nKSkuam9pbigiLCIpOwp2YXIgZ2V0SW50ZXJzZWN0aW9uS2V5cyA9IChwcmVPYmosIG5leHRPYmopID0+IFtPYmplY3Qua2V5cyhwcmVPYmopLCBPYmplY3Qua2V5cyhuZXh0T2JqKV0ucmVkdWNlKChhLCBiKSA9PiBhLmZpbHRlcigoYykgPT4gYi5pbmNsdWRlcyhjKSkpOwp2YXIgbWFwT2JqZWN0ID0gKGZuLCBvYmopID0+IE9iamVjdC5rZXlzKG9iaikucmVkdWNlKChyZXMsIGtleSkgPT4gX29iamVjdFNwcmVhZDkoX29iamVjdFNwcmVhZDkoe30sIHJlcyksIHt9LCB7CiAgW2tleV06IGZuKGtleSwgb2JqW2tleV0pCn0pLCB7fSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vY29uZmlnVXBkYXRlLmpzCmZ1bmN0aW9uIG93bktleXMxMChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDEwKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTAoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTEwKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czEwKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxMChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTEwKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTEwKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTEwKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTEwKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgYWxwaGEgPSAoYmVnaW4sIGVuZCwgaykgPT4gYmVnaW4gKyAoZW5kIC0gYmVnaW4pICogazsKdmFyIG5lZWRDb250aW51ZSA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBmcm9tOiBmcm9tMiwKICAgIHRvOiB0bzIKICB9ID0gX3JlZjI7CiAgcmV0dXJuIGZyb20yICE9PSB0bzI7Cn07CnZhciBjYWxTdGVwcGVyVmFscyA9IChlYXNpbmcsIHByZVZhbHMsIHN0ZXBzKSA9PiB7CiAgdmFyIG5leHRTdGVwVmFscyA9IG1hcE9iamVjdCgoa2V5LCB2YWwpID0+IHsKICAgIGlmIChuZWVkQ29udGludWUodmFsKSkgewogICAgICB2YXIgW25ld1gsIG5ld1ZdID0gZWFzaW5nKHZhbC5mcm9tLCB2YWwudG8sIHZhbC52ZWxvY2l0eSk7CiAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCB2YWwpLCB7fSwgewogICAgICAgIGZyb206IG5ld1gsCiAgICAgICAgdmVsb2NpdHk6IG5ld1YKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gdmFsOwogIH0sIHByZVZhbHMpOwogIGlmIChzdGVwcyA8IDEpIHsKICAgIHJldHVybiBtYXBPYmplY3QoKGtleSwgdmFsKSA9PiB7CiAgICAgIGlmIChuZWVkQ29udGludWUodmFsKSkgewogICAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCB2YWwpLCB7fSwgewogICAgICAgICAgdmVsb2NpdHk6IGFscGhhKHZhbC52ZWxvY2l0eSwgbmV4dFN0ZXBWYWxzW2tleV0udmVsb2NpdHksIHN0ZXBzKSwKICAgICAgICAgIGZyb206IGFscGhhKHZhbC5mcm9tLCBuZXh0U3RlcFZhbHNba2V5XS5mcm9tLCBzdGVwcykKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gdmFsOwogICAgfSwgcHJlVmFscyk7CiAgfQogIHJldHVybiBjYWxTdGVwcGVyVmFscyhlYXNpbmcsIG5leHRTdGVwVmFscywgc3RlcHMgLSAxKTsKfTsKZnVuY3Rpb24gY3JlYXRlU3RlcHBlclVwZGF0ZShmcm9tMiwgdG8yLCBlYXNpbmcsIGludGVyS2V5cywgcmVuZGVyLCB0aW1lb3V0Q29udHJvbGxlcikgewogIHZhciBwcmVUaW1lOwogIHZhciBzdGVwcGVyU3R5bGUgPSBpbnRlcktleXMucmVkdWNlKChyZXMsIGtleSkgPT4gX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMCh7fSwgcmVzKSwge30sIHsKICAgIFtrZXldOiB7CiAgICAgIGZyb206IGZyb20yW2tleV0sCiAgICAgIHZlbG9jaXR5OiAwLAogICAgICB0bzogdG8yW2tleV0KICAgIH0KICB9KSwge30pOwogIHZhciBnZXRDdXJyU3R5bGUgPSAoKSA9PiBtYXBPYmplY3QoKGtleSwgdmFsKSA9PiB2YWwuZnJvbSwgc3RlcHBlclN0eWxlKTsKICB2YXIgc2hvdWxkU3RvcEFuaW1hdGlvbiA9ICgpID0+ICFPYmplY3QudmFsdWVzKHN0ZXBwZXJTdHlsZSkuZmlsdGVyKG5lZWRDb250aW51ZSkubGVuZ3RoOwogIHZhciBzdG9wQW5pbWF0aW9uID0gbnVsbDsKICB2YXIgc3RlcHBlclVwZGF0ZSA9IChub3cpID0+IHsKICAgIGlmICghcHJlVGltZSkgewogICAgICBwcmVUaW1lID0gbm93OwogICAgfQogICAgdmFyIGRlbHRhVGltZSA9IG5vdyAtIHByZVRpbWU7CiAgICB2YXIgc3RlcHMgPSBkZWx0YVRpbWUgLyBlYXNpbmcuZHQ7CiAgICBzdGVwcGVyU3R5bGUgPSBjYWxTdGVwcGVyVmFscyhlYXNpbmcsIHN0ZXBwZXJTdHlsZSwgc3RlcHMpOwogICAgcmVuZGVyKF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCBmcm9tMiksIHRvMiksIGdldEN1cnJTdHlsZSgpKSk7CiAgICBwcmVUaW1lID0gbm93OwogICAgaWYgKCFzaG91bGRTdG9wQW5pbWF0aW9uKCkpIHsKICAgICAgc3RvcEFuaW1hdGlvbiA9IHRpbWVvdXRDb250cm9sbGVyLnNldFRpbWVvdXQoc3RlcHBlclVwZGF0ZSk7CiAgICB9CiAgfTsKICByZXR1cm4gKCkgPT4gewogICAgc3RvcEFuaW1hdGlvbiA9IHRpbWVvdXRDb250cm9sbGVyLnNldFRpbWVvdXQoc3RlcHBlclVwZGF0ZSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICB2YXIgX3N0b3BBbmltYXRpb247CiAgICAgIChfc3RvcEFuaW1hdGlvbiA9IHN0b3BBbmltYXRpb24pID09PSBudWxsIHx8IF9zdG9wQW5pbWF0aW9uID09PSB2b2lkIDAgfHwgX3N0b3BBbmltYXRpb24oKTsKICAgIH07CiAgfTsKfQpmdW5jdGlvbiBjcmVhdGVUaW1pbmdVcGRhdGUoZnJvbTIsIHRvMiwgZWFzaW5nLCBkdXJhdGlvbiwgaW50ZXJLZXlzLCByZW5kZXIsIHRpbWVvdXRDb250cm9sbGVyKSB7CiAgdmFyIHN0b3BBbmltYXRpb24gPSBudWxsOwogIHZhciB0aW1pbmdTdHlsZSA9IGludGVyS2V5cy5yZWR1Y2UoKHJlcywga2V5KSA9PiBfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCByZXMpLCB7fSwgewogICAgW2tleV06IFtmcm9tMltrZXldLCB0bzJba2V5XV0KICB9KSwge30pOwogIHZhciBiZWdpblRpbWU7CiAgdmFyIHRpbWluZ1VwZGF0ZSA9IChub3cpID0+IHsKICAgIGlmICghYmVnaW5UaW1lKSB7CiAgICAgIGJlZ2luVGltZSA9IG5vdzsKICAgIH0KICAgIHZhciB0ID0gKG5vdyAtIGJlZ2luVGltZSkgLyBkdXJhdGlvbjsKICAgIHZhciBjdXJyU3R5bGUgPSBtYXBPYmplY3QoKGtleSwgdmFsKSA9PiBhbHBoYSguLi52YWwsIGVhc2luZyh0KSksIHRpbWluZ1N0eWxlKTsKICAgIHJlbmRlcihfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMCh7fSwgZnJvbTIpLCB0bzIpLCBjdXJyU3R5bGUpKTsKICAgIGlmICh0IDwgMSkgewogICAgICBzdG9wQW5pbWF0aW9uID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dCh0aW1pbmdVcGRhdGUpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIGZpbmFsU3R5bGUgPSBtYXBPYmplY3QoKGtleSwgdmFsKSA9PiBhbHBoYSguLi52YWwsIGVhc2luZygxKSksIHRpbWluZ1N0eWxlKTsKICAgICAgcmVuZGVyKF9vYmplY3RTcHJlYWQxMChfb2JqZWN0U3ByZWFkMTAoX29iamVjdFNwcmVhZDEwKHt9LCBmcm9tMiksIHRvMiksIGZpbmFsU3R5bGUpKTsKICAgIH0KICB9OwogIHJldHVybiAoKSA9PiB7CiAgICBzdG9wQW5pbWF0aW9uID0gdGltZW91dENvbnRyb2xsZXIuc2V0VGltZW91dCh0aW1pbmdVcGRhdGUpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgdmFyIF9zdG9wQW5pbWF0aW9uMjsKICAgICAgKF9zdG9wQW5pbWF0aW9uMiA9IHN0b3BBbmltYXRpb24pID09PSBudWxsIHx8IF9zdG9wQW5pbWF0aW9uMiA9PT0gdm9pZCAwIHx8IF9zdG9wQW5pbWF0aW9uMigpOwogICAgfTsKICB9Owp9CnZhciBjb25maWdVcGRhdGVfZGVmYXVsdCA9IChmcm9tMiwgdG8yLCBlYXNpbmcsIGR1cmF0aW9uLCByZW5kZXIsIHRpbWVvdXRDb250cm9sbGVyKSA9PiB7CiAgdmFyIGludGVyS2V5cyA9IGdldEludGVyc2VjdGlvbktleXMoZnJvbTIsIHRvMik7CiAgaWYgKGVhc2luZyA9PSBudWxsKSB7CiAgICByZXR1cm4gKCkgPT4gewogICAgICByZW5kZXIoX29iamVjdFNwcmVhZDEwKF9vYmplY3RTcHJlYWQxMCh7fSwgZnJvbTIpLCB0bzIpKTsKICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgfTsKICAgIH07CiAgfQogIHJldHVybiBlYXNpbmcuaXNTdGVwcGVyID09PSB0cnVlID8gY3JlYXRlU3RlcHBlclVwZGF0ZShmcm9tMiwgdG8yLCBlYXNpbmcsIGludGVyS2V5cywgcmVuZGVyLCB0aW1lb3V0Q29udHJvbGxlcikgOiBjcmVhdGVUaW1pbmdVcGRhdGUoZnJvbTIsIHRvMiwgZWFzaW5nLCBkdXJhdGlvbiwgaW50ZXJLZXlzLCByZW5kZXIsIHRpbWVvdXRDb250cm9sbGVyKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2FuaW1hdGlvbi9lYXNpbmcuanMKdmFyIEFDQ1VSQUNZID0gMWUtNDsKdmFyIGN1YmljQmV6aWVyRmFjdG9yID0gKGMxLCBjMikgPT4gWzAsIDMgKiBjMSwgMyAqIGMyIC0gNiAqIGMxLCAzICogYzEgLSAzICogYzIgKyAxXTsKdmFyIGV2YWx1YXRlUG9seW5vbWlhbCA9IChwYXJhbXMsIHQpID0+IHBhcmFtcy5tYXAoKHBhcmFtLCBpKSA9PiBwYXJhbSAqIHQgKiogaSkucmVkdWNlKChwcmUsIGN1cnIpID0+IHByZSArIGN1cnIpOwp2YXIgY3ViaWNCZXppZXIgPSAoYzEsIGMyKSA9PiAodCkgPT4gewogIHZhciBwYXJhbXMgPSBjdWJpY0JlemllckZhY3RvcihjMSwgYzIpOwogIHJldHVybiBldmFsdWF0ZVBvbHlub21pYWwocGFyYW1zLCB0KTsKfTsKdmFyIGRlcml2YXRpdmVDdWJpY0JlemllciA9IChjMSwgYzIpID0+ICh0KSA9PiB7CiAgdmFyIHBhcmFtcyA9IGN1YmljQmV6aWVyRmFjdG9yKGMxLCBjMik7CiAgdmFyIG5ld1BhcmFtcyA9IFsuLi5wYXJhbXMubWFwKChwYXJhbSwgaSkgPT4gcGFyYW0gKiBpKS5zbGljZSgxKSwgMF07CiAgcmV0dXJuIGV2YWx1YXRlUG9seW5vbWlhbChuZXdQYXJhbXMsIHQpOwp9Owp2YXIgZ2V0QmV6aWVyQ29vcmRpbmF0ZXMgPSBmdW5jdGlvbiBnZXRCZXppZXJDb29yZGluYXRlczIoKSB7CiAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldOwogIH0KICBpZiAoYXJncy5sZW5ndGggPT09IDEpIHsKICAgIHN3aXRjaCAoYXJnc1swXSkgewogICAgICBjYXNlICJsaW5lYXIiOgogICAgICAgIHJldHVybiBbMCwgMCwgMSwgMV07CiAgICAgIGNhc2UgImVhc2UiOgogICAgICAgIHJldHVybiBbMC4yNSwgMC4xLCAwLjI1LCAxXTsKICAgICAgY2FzZSAiZWFzZS1pbiI6CiAgICAgICAgcmV0dXJuIFswLjQyLCAwLCAxLCAxXTsKICAgICAgY2FzZSAiZWFzZS1vdXQiOgogICAgICAgIHJldHVybiBbMC40MiwgMCwgMC41OCwgMV07CiAgICAgIGNhc2UgImVhc2UtaW4tb3V0IjoKICAgICAgICByZXR1cm4gWzAsIDAsIDAuNTgsIDFdOwogICAgICBkZWZhdWx0OiB7CiAgICAgICAgdmFyIF9lYXNpbmckOwogICAgICAgIHZhciBlYXNpbmcgPSBhcmdzWzBdLnNwbGl0KCIoIik7CiAgICAgICAgaWYgKGVhc2luZ1swXSA9PT0gImN1YmljLWJlemllciIgJiYgKChfZWFzaW5nJCA9IGVhc2luZ1sxXSkgPT09IG51bGwgfHwgX2Vhc2luZyQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lYXNpbmckLnNwbGl0KCIpIilbMF0uc3BsaXQoIiwiKS5sZW5ndGgpID09PSA0KSB7CiAgICAgICAgICB2YXIgY29vcmRzID0gZWFzaW5nWzFdLnNwbGl0KCIpIilbMF0uc3BsaXQoIiwiKS5tYXAoKHgyKSA9PiBwYXJzZUZsb2F0KHgyKSk7CiAgICAgICAgICByZXR1cm4gW2Nvb3Jkc1swXSwgY29vcmRzWzFdLCBjb29yZHNbMl0sIGNvb3Jkc1szXV07CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGlmIChhcmdzLmxlbmd0aCA9PT0gNCkgewogICAgcmV0dXJuIGFyZ3M7CiAgfQogIHJldHVybiBbMCwgMCwgMSwgMV07Cn07CnZhciBjcmVhdGVCZXppZXJFYXNpbmcgPSAoeDEsIHkxLCB4MiwgeTIpID0+IHsKICB2YXIgY3VydmVYID0gY3ViaWNCZXppZXIoeDEsIHgyKTsKICB2YXIgY3VydmVZID0gY3ViaWNCZXppZXIoeTEsIHkyKTsKICB2YXIgZGVyQ3VydmVYID0gZGVyaXZhdGl2ZUN1YmljQmV6aWVyKHgxLCB4Mik7CiAgdmFyIHJhbmdlVmFsdWUgPSAodmFsdWUpID0+IHsKICAgIGlmICh2YWx1ZSA+IDEpIHsKICAgICAgcmV0dXJuIDE7CiAgICB9CiAgICBpZiAodmFsdWUgPCAwKSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH07CiAgdmFyIGJlemllciA9IChfdCkgPT4gewogICAgdmFyIHQgPSBfdCA+IDEgPyAxIDogX3Q7CiAgICB2YXIgeDMgPSB0OwogICAgZm9yICh2YXIgaSA9IDA7IGkgPCA4OyArK2kpIHsKICAgICAgdmFyIGV2YWxUID0gY3VydmVYKHgzKSAtIHQ7CiAgICAgIHZhciBkZXJWYWwgPSBkZXJDdXJ2ZVgoeDMpOwogICAgICBpZiAoTWF0aC5hYnMoZXZhbFQgLSB0KSA8IEFDQ1VSQUNZIHx8IGRlclZhbCA8IEFDQ1VSQUNZKSB7CiAgICAgICAgcmV0dXJuIGN1cnZlWSh4Myk7CiAgICAgIH0KICAgICAgeDMgPSByYW5nZVZhbHVlKHgzIC0gZXZhbFQgLyBkZXJWYWwpOwogICAgfQogICAgcmV0dXJuIGN1cnZlWSh4Myk7CiAgfTsKICBiZXppZXIuaXNTdGVwcGVyID0gZmFsc2U7CiAgcmV0dXJuIGJlemllcjsKfTsKdmFyIGNvbmZpZ0JlemllciA9IGZ1bmN0aW9uIGNvbmZpZ0JlemllcjIoKSB7CiAgcmV0dXJuIGNyZWF0ZUJlemllckVhc2luZyguLi5nZXRCZXppZXJDb29yZGluYXRlcyguLi5hcmd1bWVudHMpKTsKfTsKdmFyIGNvbmZpZ1NwcmluZyA9IGZ1bmN0aW9uIGNvbmZpZ1NwcmluZzIoKSB7CiAgdmFyIGNvbmZpZyA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIGFyZ3VtZW50c1swXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzBdIDoge307CiAgdmFyIHsKICAgIHN0aWZmID0gMTAwLAogICAgZGFtcGluZyA9IDgsCiAgICBkdCA9IDE3CiAgfSA9IGNvbmZpZzsKICB2YXIgc3RlcHBlciA9IChjdXJyWCwgZGVzdFgsIGN1cnJWKSA9PiB7CiAgICB2YXIgRlNwcmluZyA9IC0oY3VyclggLSBkZXN0WCkgKiBzdGlmZjsKICAgIHZhciBGRGFtcGluZyA9IGN1cnJWICogZGFtcGluZzsKICAgIHZhciBuZXdWID0gY3VyclYgKyAoRlNwcmluZyAtIEZEYW1waW5nKSAqIGR0IC8gMWUzOwogICAgdmFyIG5ld1ggPSBjdXJyViAqIGR0IC8gMWUzICsgY3Vyclg7CiAgICBpZiAoTWF0aC5hYnMobmV3WCAtIGRlc3RYKSA8IEFDQ1VSQUNZICYmIE1hdGguYWJzKG5ld1YpIDwgQUNDVVJBQ1kpIHsKICAgICAgcmV0dXJuIFtkZXN0WCwgMF07CiAgICB9CiAgICByZXR1cm4gW25ld1gsIG5ld1ZdOwogIH07CiAgc3RlcHBlci5pc1N0ZXBwZXIgPSB0cnVlOwogIHN0ZXBwZXIuZHQgPSBkdDsKICByZXR1cm4gc3RlcHBlcjsKfTsKdmFyIGNvbmZpZ0Vhc2luZyA9IChlYXNpbmcpID0+IHsKICBpZiAodHlwZW9mIGVhc2luZyA9PT0gInN0cmluZyIpIHsKICAgIHN3aXRjaCAoZWFzaW5nKSB7CiAgICAgIGNhc2UgImVhc2UiOgogICAgICBjYXNlICJlYXNlLWluLW91dCI6CiAgICAgIGNhc2UgImVhc2Utb3V0IjoKICAgICAgY2FzZSAiZWFzZS1pbiI6CiAgICAgIGNhc2UgImxpbmVhciI6CiAgICAgICAgcmV0dXJuIGNvbmZpZ0JlemllcihlYXNpbmcpOwogICAgICBjYXNlICJzcHJpbmciOgogICAgICAgIHJldHVybiBjb25maWdTcHJpbmcoKTsKICAgICAgZGVmYXVsdDoKICAgICAgICBpZiAoZWFzaW5nLnNwbGl0KCIoIilbMF0gPT09ICJjdWJpYy1iZXppZXIiKSB7CiAgICAgICAgICByZXR1cm4gY29uZmlnQmV6aWVyKGVhc2luZyk7CiAgICAgICAgfQogICAgfQogIH0KICBpZiAodHlwZW9mIGVhc2luZyA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIGVhc2luZzsKICB9CiAgcmV0dXJuIG51bGw7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vdXNlQW5pbWF0aW9uTWFuYWdlci5qcwp2YXIgaW1wb3J0X3JlYWN0MTUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vQW5pbWF0aW9uTWFuYWdlci5qcwpmdW5jdGlvbiBjcmVhdGVBbmltYXRlTWFuYWdlcih0aW1lb3V0Q29udHJvbGxlcikgewogIHZhciBjdXJyU3R5bGU7CiAgdmFyIGhhbmRsZUNoYW5nZSA9ICgpID0+IG51bGw7CiAgdmFyIHNob3VsZFN0b3AgPSBmYWxzZTsKICB2YXIgY2FuY2VsVGltZW91dCA9IG51bGw7CiAgdmFyIHNldFN0eWxlID0gKF9zdHlsZSkgPT4gewogICAgaWYgKHNob3VsZFN0b3ApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKEFycmF5LmlzQXJyYXkoX3N0eWxlKSkgewogICAgICBpZiAoIV9zdHlsZS5sZW5ndGgpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHN0eWxlcyA9IF9zdHlsZTsKICAgICAgdmFyIFtjdXJyLCAuLi5yZXN0U3R5bGVzXSA9IHN0eWxlczsKICAgICAgaWYgKHR5cGVvZiBjdXJyID09PSAibnVtYmVyIikgewogICAgICAgIGNhbmNlbFRpbWVvdXQgPSB0aW1lb3V0Q29udHJvbGxlci5zZXRUaW1lb3V0KHNldFN0eWxlLmJpbmQobnVsbCwgcmVzdFN0eWxlcyksIGN1cnIpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBzZXRTdHlsZShjdXJyKTsKICAgICAgY2FuY2VsVGltZW91dCA9IHRpbWVvdXRDb250cm9sbGVyLnNldFRpbWVvdXQoc2V0U3R5bGUuYmluZChudWxsLCByZXN0U3R5bGVzKSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGlmICh0eXBlb2YgX3N0eWxlID09PSAic3RyaW5nIikgewogICAgICBjdXJyU3R5bGUgPSBfc3R5bGU7CiAgICAgIGhhbmRsZUNoYW5nZShjdXJyU3R5bGUpOwogICAgfQogICAgaWYgKHR5cGVvZiBfc3R5bGUgPT09ICJvYmplY3QiKSB7CiAgICAgIGN1cnJTdHlsZSA9IF9zdHlsZTsKICAgICAgaGFuZGxlQ2hhbmdlKGN1cnJTdHlsZSk7CiAgICB9CiAgICBpZiAodHlwZW9mIF9zdHlsZSA9PT0gImZ1bmN0aW9uIikgewogICAgICBfc3R5bGUoKTsKICAgIH0KICB9OwogIHJldHVybiB7CiAgICBzdG9wOiAoKSA9PiB7CiAgICAgIHNob3VsZFN0b3AgPSB0cnVlOwogICAgfSwKICAgIHN0YXJ0OiAoc3R5bGUpID0+IHsKICAgICAgc2hvdWxkU3RvcCA9IGZhbHNlOwogICAgICBpZiAoY2FuY2VsVGltZW91dCkgewogICAgICAgIGNhbmNlbFRpbWVvdXQoKTsKICAgICAgICBjYW5jZWxUaW1lb3V0ID0gbnVsbDsKICAgICAgfQogICAgICBzZXRTdHlsZShzdHlsZSk7CiAgICB9LAogICAgc3Vic2NyaWJlOiAoX2hhbmRsZUNoYW5nZSkgPT4gewogICAgICBoYW5kbGVDaGFuZ2UgPSBfaGFuZGxlQ2hhbmdlOwogICAgICByZXR1cm4gKCkgPT4gewogICAgICAgIGhhbmRsZUNoYW5nZSA9ICgpID0+IG51bGw7CiAgICAgIH07CiAgICB9LAogICAgZ2V0VGltZW91dENvbnRyb2xsZXI6ICgpID0+IHRpbWVvdXRDb250cm9sbGVyCiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL3RpbWVvdXRDb250cm9sbGVyLmpzCnZhciBSZXF1ZXN0QW5pbWF0aW9uRnJhbWVUaW1lb3V0Q29udHJvbGxlciA9IGNsYXNzIHsKICBzZXRUaW1lb3V0KGNhbGxiYWNrKSB7CiAgICB2YXIgZGVsYXkgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6IDA7CiAgICB2YXIgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7CiAgICB2YXIgcmVxdWVzdElkID0gbnVsbDsKICAgIHZhciBleGVjdXRlQ2FsbGJhY2sgPSAobm93KSA9PiB7CiAgICAgIGlmIChub3cgLSBzdGFydFRpbWUgPj0gZGVsYXkpIHsKICAgICAgICBjYWxsYmFjayhub3cpOwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICByZXF1ZXN0SWQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZXhlY3V0ZUNhbGxiYWNrKTsKICAgICAgfQogICAgfTsKICAgIHJlcXVlc3RJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZShleGVjdXRlQ2FsbGJhY2spOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKHJlcXVlc3RJZCAhPSBudWxsKSB7CiAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUocmVxdWVzdElkKTsKICAgICAgfQogICAgfTsKICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9hbmltYXRpb24vY3JlYXRlRGVmYXVsdEFuaW1hdGlvbk1hbmFnZXIuanMKZnVuY3Rpb24gY3JlYXRlRGVmYXVsdEFuaW1hdGlvbk1hbmFnZXIoKSB7CiAgcmV0dXJuIGNyZWF0ZUFuaW1hdGVNYW5hZ2VyKG5ldyBSZXF1ZXN0QW5pbWF0aW9uRnJhbWVUaW1lb3V0Q29udHJvbGxlcigpKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL3VzZUFuaW1hdGlvbk1hbmFnZXIuanMKdmFyIEFuaW1hdGlvbk1hbmFnZXJDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QxNS5jcmVhdGVDb250ZXh0KShjcmVhdGVEZWZhdWx0QW5pbWF0aW9uTWFuYWdlcik7CmZ1bmN0aW9uIHVzZUFuaW1hdGlvbk1hbmFnZXIoYW5pbWF0aW9uSWQsIGFuaW1hdGlvbk1hbmFnZXJGcm9tUHJvcHMpIHsKICB2YXIgY29udGV4dEFuaW1hdGlvbk1hbmFnZXIgPSAoMCwgaW1wb3J0X3JlYWN0MTUudXNlQ29udGV4dCkoQW5pbWF0aW9uTWFuYWdlckNvbnRleHQpOwogIHJldHVybiAoMCwgaW1wb3J0X3JlYWN0MTUudXNlTWVtbykoKCkgPT4gYW5pbWF0aW9uTWFuYWdlckZyb21Qcm9wcyAhPT0gbnVsbCAmJiBhbmltYXRpb25NYW5hZ2VyRnJvbVByb3BzICE9PSB2b2lkIDAgPyBhbmltYXRpb25NYW5hZ2VyRnJvbVByb3BzIDogY29udGV4dEFuaW1hdGlvbk1hbmFnZXIoYW5pbWF0aW9uSWQpLCBbYW5pbWF0aW9uSWQsIGFuaW1hdGlvbk1hbmFnZXJGcm9tUHJvcHMsIGNvbnRleHRBbmltYXRpb25NYW5hZ2VyXSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvR2xvYmFsLmpzCnZhciBwYXJzZUlzU3NyQnlEZWZhdWx0ID0gKCkgPT4gISh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cuZG9jdW1lbnQgJiYgQm9vbGVhbih3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCkgJiYgd2luZG93LnNldFRpbWVvdXQpOwp2YXIgR2xvYmFsID0gewogIGRldlRvb2xzRW5hYmxlZDogZmFsc2UsCiAgaXNTc3I6IHBhcnNlSXNTc3JCeURlZmF1bHQoKQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvYW5pbWF0aW9uL0phdmFzY3JpcHRBbmltYXRlLmpzCnZhciBkZWZhdWx0SmF2YXNjcmlwdEFuaW1hdGVQcm9wcyA9IHsKICBiZWdpbjogMCwKICBkdXJhdGlvbjogMWUzLAogIGVhc2luZzogImVhc2UiLAogIGlzQWN0aXZlOiB0cnVlLAogIGNhbkJlZ2luOiB0cnVlLAogIG9uQW5pbWF0aW9uRW5kOiAoKSA9PiB7CiAgfSwKICBvbkFuaW1hdGlvblN0YXJ0OiAoKSA9PiB7CiAgfQp9Owp2YXIgZnJvbSA9IHsKICB0OiAwCn07CnZhciB0byA9IHsKICB0OiAxCn07CmZ1bmN0aW9uIEphdmFzY3JpcHRBbmltYXRlKG91dHNpZGVQcm9wcykgewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCBkZWZhdWx0SmF2YXNjcmlwdEFuaW1hdGVQcm9wcyk7CiAgdmFyIHsKICAgIGlzQWN0aXZlOiBpc0FjdGl2ZVByb3AsCiAgICBjYW5CZWdpbiwKICAgIGR1cmF0aW9uLAogICAgZWFzaW5nLAogICAgYmVnaW4sCiAgICBvbkFuaW1hdGlvbkVuZCwKICAgIG9uQW5pbWF0aW9uU3RhcnQsCiAgICBjaGlsZHJlbgogIH0gPSBwcm9wczsKICB2YXIgaXNBY3RpdmUgPSBpc0FjdGl2ZVByb3AgPT09ICJhdXRvIiA/ICFHbG9iYWwuaXNTc3IgOiBpc0FjdGl2ZVByb3A7CiAgdmFyIGFuaW1hdGlvbk1hbmFnZXIgPSB1c2VBbmltYXRpb25NYW5hZ2VyKHByb3BzLmFuaW1hdGlvbklkLCBwcm9wcy5hbmltYXRpb25NYW5hZ2VyKTsKICB2YXIgW3N0eWxlLCBzZXRTdHlsZV0gPSAoMCwgaW1wb3J0X3JlYWN0MTYudXNlU3RhdGUpKGlzQWN0aXZlID8gZnJvbSA6IHRvKTsKICB2YXIgc3RvcEpTQW5pbWF0aW9uID0gKDAsIGltcG9ydF9yZWFjdDE2LnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDE2LnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFpc0FjdGl2ZSkgewogICAgICBzZXRTdHlsZSh0byk7CiAgICB9CiAgfSwgW2lzQWN0aXZlXSk7CiAgKDAsIGltcG9ydF9yZWFjdDE2LnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFpc0FjdGl2ZSB8fCAhY2FuQmVnaW4pIHsKICAgICAgcmV0dXJuIG5vb3A7CiAgICB9CiAgICB2YXIgc3RhcnRBbmltYXRpb24gPSBjb25maWdVcGRhdGVfZGVmYXVsdChmcm9tLCB0bywgY29uZmlnRWFzaW5nKGVhc2luZyksIGR1cmF0aW9uLCBzZXRTdHlsZSwgYW5pbWF0aW9uTWFuYWdlci5nZXRUaW1lb3V0Q29udHJvbGxlcigpKTsKICAgIHZhciBvbkFuaW1hdGlvbkFjdGl2ZSA9ICgpID0+IHsKICAgICAgc3RvcEpTQW5pbWF0aW9uLmN1cnJlbnQgPSBzdGFydEFuaW1hdGlvbigpOwogICAgfTsKICAgIGFuaW1hdGlvbk1hbmFnZXIuc3RhcnQoW29uQW5pbWF0aW9uU3RhcnQsIGJlZ2luLCBvbkFuaW1hdGlvbkFjdGl2ZSwgZHVyYXRpb24sIG9uQW5pbWF0aW9uRW5kXSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBhbmltYXRpb25NYW5hZ2VyLnN0b3AoKTsKICAgICAgaWYgKHN0b3BKU0FuaW1hdGlvbi5jdXJyZW50KSB7CiAgICAgICAgc3RvcEpTQW5pbWF0aW9uLmN1cnJlbnQoKTsKICAgICAgfQogICAgICBvbkFuaW1hdGlvbkVuZCgpOwogICAgfTsKICB9LCBbaXNBY3RpdmUsIGNhbkJlZ2luLCBkdXJhdGlvbiwgZWFzaW5nLCBiZWdpbiwgb25BbmltYXRpb25TdGFydCwgb25BbmltYXRpb25FbmQsIGFuaW1hdGlvbk1hbmFnZXJdKTsKICByZXR1cm4gY2hpbGRyZW4oc3R5bGUudCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdXNlQW5pbWF0aW9uSWQuanMKdmFyIGltcG9ydF9yZWFjdDE3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiB1c2VBbmltYXRpb25JZChpbnB1dCkgewogIHZhciBwcmVmaXggPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6ICJhbmltYXRpb24tIjsKICB2YXIgYW5pbWF0aW9uSWQgPSAoMCwgaW1wb3J0X3JlYWN0MTcudXNlUmVmKSh1bmlxdWVJZChwcmVmaXgpKTsKICB2YXIgcHJldlByb3BzID0gKDAsIGltcG9ydF9yZWFjdDE3LnVzZVJlZikoaW5wdXQpOwogIGlmIChwcmV2UHJvcHMuY3VycmVudCAhPT0gaW5wdXQpIHsKICAgIGFuaW1hdGlvbklkLmN1cnJlbnQgPSB1bmlxdWVJZChwcmVmaXgpOwogICAgcHJldlByb3BzLmN1cnJlbnQgPSBpbnB1dDsKICB9CiAgcmV0dXJuIGFuaW1hdGlvbklkLmN1cnJlbnQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL1JlY3RhbmdsZS5qcwp2YXIgX2V4Y2x1ZGVkNCA9IFsicmFkaXVzIl07CnZhciBfZXhjbHVkZWQyMiA9IFsicmFkaXVzIl07CmZ1bmN0aW9uIG93bktleXMxMShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDExKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTEoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTExKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czExKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxMShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTExKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTExKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTExKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTExKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfZXh0ZW5kczcoKSB7CiAgcmV0dXJuIF9leHRlbmRzNyA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzNy5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczQoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTQoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTQocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBnZXRSZWN0YW5nbGVQYXRoID0gKHgyLCB5Miwgd2lkdGgsIGhlaWdodCwgcmFkaXVzKSA9PiB7CiAgdmFyIG1heFJhZGl1cyA9IE1hdGgubWluKE1hdGguYWJzKHdpZHRoKSAvIDIsIE1hdGguYWJzKGhlaWdodCkgLyAyKTsKICB2YXIgeVNpZ24gPSBoZWlnaHQgPj0gMCA/IDEgOiAtMTsKICB2YXIgeFNpZ24gPSB3aWR0aCA+PSAwID8gMSA6IC0xOwogIHZhciBjbG9ja1dpc2UgPSBoZWlnaHQgPj0gMCAmJiB3aWR0aCA+PSAwIHx8IGhlaWdodCA8IDAgJiYgd2lkdGggPCAwID8gMSA6IDA7CiAgdmFyIHBhdGgyOwogIGlmIChtYXhSYWRpdXMgPiAwICYmIHJhZGl1cyBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICB2YXIgbmV3UmFkaXVzID0gWzAsIDAsIDAsIDBdOwogICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IDQ7IGkgPCBsZW47IGkrKykgewogICAgICBuZXdSYWRpdXNbaV0gPSByYWRpdXNbaV0gPiBtYXhSYWRpdXMgPyBtYXhSYWRpdXMgOiByYWRpdXNbaV07CiAgICB9CiAgICBwYXRoMiA9ICJNIi5jb25jYXQoeDIsICIsIikuY29uY2F0KHkyICsgeVNpZ24gKiBuZXdSYWRpdXNbMF0pOwogICAgaWYgKG5ld1JhZGl1c1swXSA+IDApIHsKICAgICAgcGF0aDIgKz0gIkEgIi5jb25jYXQobmV3UmFkaXVzWzBdLCAiLCIpLmNvbmNhdChuZXdSYWRpdXNbMF0sICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsIikuY29uY2F0KHgyICsgeFNpZ24gKiBuZXdSYWRpdXNbMF0sICIsIikuY29uY2F0KHkyKTsKICAgIH0KICAgIHBhdGgyICs9ICJMICIuY29uY2F0KHgyICsgd2lkdGggLSB4U2lnbiAqIG5ld1JhZGl1c1sxXSwgIiwiKS5jb25jYXQoeTIpOwogICAgaWYgKG5ld1JhZGl1c1sxXSA+IDApIHsKICAgICAgcGF0aDIgKz0gIkEgIi5jb25jYXQobmV3UmFkaXVzWzFdLCAiLCIpLmNvbmNhdChuZXdSYWRpdXNbMV0sICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsXG4gICAgICAgICIpLmNvbmNhdCh4MiArIHdpZHRoLCAiLCIpLmNvbmNhdCh5MiArIHlTaWduICogbmV3UmFkaXVzWzFdKTsKICAgIH0KICAgIHBhdGgyICs9ICJMICIuY29uY2F0KHgyICsgd2lkdGgsICIsIikuY29uY2F0KHkyICsgaGVpZ2h0IC0geVNpZ24gKiBuZXdSYWRpdXNbMl0pOwogICAgaWYgKG5ld1JhZGl1c1syXSA+IDApIHsKICAgICAgcGF0aDIgKz0gIkEgIi5jb25jYXQobmV3UmFkaXVzWzJdLCAiLCIpLmNvbmNhdChuZXdSYWRpdXNbMl0sICIsMCwwLCIpLmNvbmNhdChjbG9ja1dpc2UsICIsXG4gICAgICAgICIpLmNvbmNhdCh4MiArIHdpZHRoIC0geFNpZ24gKiBuZXdSYWRpdXNbMl0sICIsIikuY29uY2F0KHkyICsgaGVpZ2h0KTsKICAgIH0KICAgIHBhdGgyICs9ICJMICIuY29uY2F0KHgyICsgeFNpZ24gKiBuZXdSYWRpdXNbM10sICIsIikuY29uY2F0KHkyICsgaGVpZ2h0KTsKICAgIGlmIChuZXdSYWRpdXNbM10gPiAwKSB7CiAgICAgIHBhdGgyICs9ICJBICIuY29uY2F0KG5ld1JhZGl1c1szXSwgIiwiKS5jb25jYXQobmV3UmFkaXVzWzNdLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLFxuICAgICAgICAiKS5jb25jYXQoeDIsICIsIikuY29uY2F0KHkyICsgaGVpZ2h0IC0geVNpZ24gKiBuZXdSYWRpdXNbM10pOwogICAgfQogICAgcGF0aDIgKz0gIloiOwogIH0gZWxzZSBpZiAobWF4UmFkaXVzID4gMCAmJiByYWRpdXMgPT09ICtyYWRpdXMgJiYgcmFkaXVzID4gMCkgewogICAgdmFyIF9uZXdSYWRpdXMgPSBNYXRoLm1pbihtYXhSYWRpdXMsIHJhZGl1cyk7CiAgICBwYXRoMiA9ICJNICIuY29uY2F0KHgyLCAiLCIpLmNvbmNhdCh5MiArIHlTaWduICogX25ld1JhZGl1cywgIlxuICAgICAgICAgICAgQSAiKS5jb25jYXQoX25ld1JhZGl1cywgIiwiKS5jb25jYXQoX25ld1JhZGl1cywgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIiwiKS5jb25jYXQoeDIgKyB4U2lnbiAqIF9uZXdSYWRpdXMsICIsIikuY29uY2F0KHkyLCAiXG4gICAgICAgICAgICBMICIpLmNvbmNhdCh4MiArIHdpZHRoIC0geFNpZ24gKiBfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdCh5MiwgIlxuICAgICAgICAgICAgQSAiKS5jb25jYXQoX25ld1JhZGl1cywgIiwiKS5jb25jYXQoX25ld1JhZGl1cywgIiwwLDAsIikuY29uY2F0KGNsb2NrV2lzZSwgIiwiKS5jb25jYXQoeDIgKyB3aWR0aCwgIiwiKS5jb25jYXQoeTIgKyB5U2lnbiAqIF9uZXdSYWRpdXMsICJcbiAgICAgICAgICAgIEwgIikuY29uY2F0KHgyICsgd2lkdGgsICIsIikuY29uY2F0KHkyICsgaGVpZ2h0IC0geVNpZ24gKiBfbmV3UmFkaXVzLCAiXG4gICAgICAgICAgICBBICIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLCIpLmNvbmNhdCh4MiArIHdpZHRoIC0geFNpZ24gKiBfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdCh5MiArIGhlaWdodCwgIlxuICAgICAgICAgICAgTCAiKS5jb25jYXQoeDIgKyB4U2lnbiAqIF9uZXdSYWRpdXMsICIsIikuY29uY2F0KHkyICsgaGVpZ2h0LCAiXG4gICAgICAgICAgICBBICIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLCIpLmNvbmNhdChfbmV3UmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoY2xvY2tXaXNlLCAiLCIpLmNvbmNhdCh4MiwgIiwiKS5jb25jYXQoeTIgKyBoZWlnaHQgLSB5U2lnbiAqIF9uZXdSYWRpdXMsICIgWiIpOwogIH0gZWxzZSB7CiAgICBwYXRoMiA9ICJNICIuY29uY2F0KHgyLCAiLCIpLmNvbmNhdCh5MiwgIiBoICIpLmNvbmNhdCh3aWR0aCwgIiB2ICIpLmNvbmNhdChoZWlnaHQsICIgaCAiKS5jb25jYXQoLXdpZHRoLCAiIFoiKTsKICB9CiAgcmV0dXJuIHBhdGgyOwp9Owp2YXIgZGVmYXVsdFJlY3RhbmdsZVByb3BzID0gewogIHg6IDAsCiAgeTogMCwKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgLy8gVGhlIHJhZGl1cyBvZiBib3JkZXIKICAvLyBUaGUgcmFkaXVzIG9mIGZvdXIgY29ybmVycyB3aGVuIHJhZGl1cyBpcyBhIG51bWJlcgogIC8vIFRoZSByYWRpdXMgb2YgbGVmdC10b3AsIHJpZ2h0LXRvcCwgcmlnaHQtYm90dG9tLCBsZWZ0LWJvdHRvbSB3aGVuIHJhZGl1cyBpcyBhbiBhcnJheQogIHJhZGl1czogMCwKICBpc0FuaW1hdGlvbkFjdGl2ZTogZmFsc2UsCiAgaXNVcGRhdGVBbmltYXRpb25BY3RpdmU6IGZhbHNlLAogIGFuaW1hdGlvbkJlZ2luOiAwLAogIGFuaW1hdGlvbkR1cmF0aW9uOiAxNTAwLAogIGFuaW1hdGlvbkVhc2luZzogImVhc2UiCn07CnZhciBSZWN0YW5nbGUgPSAocmVjdGFuZ2xlUHJvcHMpID0+IHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKHJlY3RhbmdsZVByb3BzLCBkZWZhdWx0UmVjdGFuZ2xlUHJvcHMpOwogIHZhciBwYXRoUmVmID0gKDAsIGltcG9ydF9yZWFjdDE4LnVzZVJlZikobnVsbCk7CiAgdmFyIFt0b3RhbExlbmd0aCwgc2V0VG90YWxMZW5ndGhdID0gKDAsIGltcG9ydF9yZWFjdDE4LnVzZVN0YXRlKSgtMSk7CiAgKDAsIGltcG9ydF9yZWFjdDE4LnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKHBhdGhSZWYuY3VycmVudCAmJiBwYXRoUmVmLmN1cnJlbnQuZ2V0VG90YWxMZW5ndGgpIHsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgcGF0aFRvdGFsTGVuZ3RoID0gcGF0aFJlZi5jdXJyZW50LmdldFRvdGFsTGVuZ3RoKCk7CiAgICAgICAgaWYgKHBhdGhUb3RhbExlbmd0aCkgewogICAgICAgICAgc2V0VG90YWxMZW5ndGgocGF0aFRvdGFsTGVuZ3RoKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgICAgfQogICAgfQogIH0sIFtdKTsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgcmFkaXVzLAogICAgY2xhc3NOYW1lCiAgfSA9IHByb3BzOwogIHZhciB7CiAgICBhbmltYXRpb25FYXNpbmcsCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkJlZ2luLAogICAgaXNBbmltYXRpb25BY3RpdmUsCiAgICBpc1VwZGF0ZUFuaW1hdGlvbkFjdGl2ZQogIH0gPSBwcm9wczsKICB2YXIgcHJldldpZHRoUmVmID0gKDAsIGltcG9ydF9yZWFjdDE4LnVzZVJlZikod2lkdGgpOwogIHZhciBwcmV2SGVpZ2h0UmVmID0gKDAsIGltcG9ydF9yZWFjdDE4LnVzZVJlZikoaGVpZ2h0KTsKICB2YXIgcHJldlhSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MTgudXNlUmVmKSh4Mik7CiAgdmFyIHByZXZZUmVmID0gKDAsIGltcG9ydF9yZWFjdDE4LnVzZVJlZikoeTIpOwogIHZhciBhbmltYXRpb25JZElucHV0ID0gKDAsIGltcG9ydF9yZWFjdDE4LnVzZU1lbW8pKCgpID0+ICh7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByYWRpdXMKICB9KSwgW3gyLCB5Miwgd2lkdGgsIGhlaWdodCwgcmFkaXVzXSk7CiAgdmFyIGFuaW1hdGlvbklkID0gdXNlQW5pbWF0aW9uSWQoYW5pbWF0aW9uSWRJbnB1dCwgInJlY3RhbmdsZS0iKTsKICBpZiAoeDIgIT09ICt4MiB8fCB5MiAhPT0gK3kyIHx8IHdpZHRoICE9PSArd2lkdGggfHwgaGVpZ2h0ICE9PSAraGVpZ2h0IHx8IHdpZHRoID09PSAwIHx8IGhlaWdodCA9PT0gMCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtcmVjdGFuZ2xlIiwgY2xhc3NOYW1lKTsKICBpZiAoIWlzVXBkYXRlQW5pbWF0aW9uQWN0aXZlKSB7CiAgICB2YXIgX3N2Z1Byb3BlcnRpZXNBbmRFdmVuID0gc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhwcm9wcyksIHsKICAgICAgcmFkaXVzOiBfCiAgICB9ID0gX3N2Z1Byb3BlcnRpZXNBbmRFdmVuLCBvdGhlclBhdGhQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczQoX3N2Z1Byb3BlcnRpZXNBbmRFdmVuLCBfZXhjbHVkZWQ0KTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3Q5LmNyZWF0ZUVsZW1lbnQoInBhdGgiLCBfZXh0ZW5kczcoe30sIG90aGVyUGF0aFByb3BzLCB7CiAgICAgIHJhZGl1czogdHlwZW9mIHJhZGl1cyA9PT0gIm51bWJlciIgPyByYWRpdXMgOiB2b2lkIDAsCiAgICAgIGNsYXNzTmFtZTogbGF5ZXJDbGFzcywKICAgICAgZDogZ2V0UmVjdGFuZ2xlUGF0aCh4MiwgeTIsIHdpZHRoLCBoZWlnaHQsIHJhZGl1cykKICAgIH0pKTsKICB9CiAgdmFyIHByZXZXaWR0aCA9IHByZXZXaWR0aFJlZi5jdXJyZW50OwogIHZhciBwcmV2SGVpZ2h0ID0gcHJldkhlaWdodFJlZi5jdXJyZW50OwogIHZhciBwcmV2WCA9IHByZXZYUmVmLmN1cnJlbnQ7CiAgdmFyIHByZXZZID0gcHJldllSZWYuY3VycmVudDsKICB2YXIgZnJvbTIgPSAiMHB4ICIuY29uY2F0KHRvdGFsTGVuZ3RoID09PSAtMSA/IDEgOiB0b3RhbExlbmd0aCwgInB4Iik7CiAgdmFyIHRvMiA9ICIiLmNvbmNhdCh0b3RhbExlbmd0aCwgInB4IDBweCIpOwogIHZhciB0cmFuc2l0aW9uID0gZ2V0VHJhbnNpdGlvblZhbChbInN0cm9rZURhc2hhcnJheSJdLCBhbmltYXRpb25EdXJhdGlvbiwgdHlwZW9mIGFuaW1hdGlvbkVhc2luZyA9PT0gInN0cmluZyIgPyBhbmltYXRpb25FYXNpbmcgOiBkZWZhdWx0UmVjdGFuZ2xlUHJvcHMuYW5pbWF0aW9uRWFzaW5nKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0OS5jcmVhdGVFbGVtZW50KEphdmFzY3JpcHRBbmltYXRlLCB7CiAgICBhbmltYXRpb25JZCwKICAgIGtleTogYW5pbWF0aW9uSWQsCiAgICBjYW5CZWdpbjogdG90YWxMZW5ndGggPiAwLAogICAgZHVyYXRpb246IGFuaW1hdGlvbkR1cmF0aW9uLAogICAgZWFzaW5nOiBhbmltYXRpb25FYXNpbmcsCiAgICBpc0FjdGl2ZTogaXNVcGRhdGVBbmltYXRpb25BY3RpdmUsCiAgICBiZWdpbjogYW5pbWF0aW9uQmVnaW4KICB9LCAodCkgPT4gewogICAgdmFyIGN1cnJXaWR0aCA9IGludGVycG9sYXRlKHByZXZXaWR0aCwgd2lkdGgsIHQpOwogICAgdmFyIGN1cnJIZWlnaHQgPSBpbnRlcnBvbGF0ZShwcmV2SGVpZ2h0LCBoZWlnaHQsIHQpOwogICAgdmFyIGN1cnJYID0gaW50ZXJwb2xhdGUocHJldlgsIHgyLCB0KTsKICAgIHZhciBjdXJyWSA9IGludGVycG9sYXRlKHByZXZZLCB5MiwgdCk7CiAgICBpZiAocGF0aFJlZi5jdXJyZW50KSB7CiAgICAgIHByZXZXaWR0aFJlZi5jdXJyZW50ID0gY3VycldpZHRoOwogICAgICBwcmV2SGVpZ2h0UmVmLmN1cnJlbnQgPSBjdXJySGVpZ2h0OwogICAgICBwcmV2WFJlZi5jdXJyZW50ID0gY3Vyclg7CiAgICAgIHByZXZZUmVmLmN1cnJlbnQgPSBjdXJyWTsKICAgIH0KICAgIHZhciBhbmltYXRpb25TdHlsZTsKICAgIGlmICghaXNBbmltYXRpb25BY3RpdmUpIHsKICAgICAgYW5pbWF0aW9uU3R5bGUgPSB7CiAgICAgICAgc3Ryb2tlRGFzaGFycmF5OiB0bzIKICAgICAgfTsKICAgIH0gZWxzZSBpZiAodCA+IDApIHsKICAgICAgYW5pbWF0aW9uU3R5bGUgPSB7CiAgICAgICAgdHJhbnNpdGlvbiwKICAgICAgICBzdHJva2VEYXNoYXJyYXk6IHRvMgogICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgYW5pbWF0aW9uU3R5bGUgPSB7CiAgICAgICAgc3Ryb2tlRGFzaGFycmF5OiBmcm9tMgogICAgICB9OwogICAgfQogICAgdmFyIF9zdmdQcm9wZXJ0aWVzQW5kRXZlbjIgPSBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzKHByb3BzKSwgewogICAgICByYWRpdXM6IF8yCiAgICB9ID0gX3N2Z1Byb3BlcnRpZXNBbmRFdmVuMiwgb3RoZXJQYXRoUHJvcHMyID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNChfc3ZnUHJvcGVydGllc0FuZEV2ZW4yLCBfZXhjbHVkZWQyMik7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0OS5jcmVhdGVFbGVtZW50KCJwYXRoIiwgX2V4dGVuZHM3KHt9LCBvdGhlclBhdGhQcm9wczIsIHsKICAgICAgcmFkaXVzOiB0eXBlb2YgcmFkaXVzID09PSAibnVtYmVyIiA/IHJhZGl1cyA6IHZvaWQgMCwKICAgICAgY2xhc3NOYW1lOiBsYXllckNsYXNzLAogICAgICBkOiBnZXRSZWN0YW5nbGVQYXRoKGN1cnJYLCBjdXJyWSwgY3VycldpZHRoLCBjdXJySGVpZ2h0LCByYWRpdXMpLAogICAgICByZWY6IHBhdGhSZWYsCiAgICAgIHN0eWxlOiBfb2JqZWN0U3ByZWFkMTEoX29iamVjdFNwcmVhZDExKHt9LCBhbmltYXRpb25TdHlsZSksIHByb3BzLnN0eWxlKQogICAgfSkpOwogIH0pOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9Qb2xhclV0aWxzLmpzCnZhciBpbXBvcnRfcmVhY3QxOSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gb3duS2V5czEyKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTIoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxMihPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTIoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTIoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTEyKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTIocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTIodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTIodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTIodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBSQURJQU4gPSBNYXRoLlBJIC8gMTgwOwp2YXIgcmFkaWFuVG9EZWdyZWUgPSAoYW5nbGVJblJhZGlhbikgPT4gYW5nbGVJblJhZGlhbiAqIDE4MCAvIE1hdGguUEk7CnZhciBwb2xhclRvQ2FydGVzaWFuID0gKGN4LCBjeSwgcmFkaXVzLCBhbmdsZSkgPT4gKHsKICB4OiBjeCArIE1hdGguY29zKC1SQURJQU4gKiBhbmdsZSkgKiByYWRpdXMsCiAgeTogY3kgKyBNYXRoLnNpbigtUkFESUFOICogYW5nbGUpICogcmFkaXVzCn0pOwp2YXIgZ2V0TWF4UmFkaXVzID0gZnVuY3Rpb24gZ2V0TWF4UmFkaXVzMih3aWR0aCwgaGVpZ2h0KSB7CiAgdmFyIG9mZnNldCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzJdIDogewogICAgdG9wOiAwLAogICAgcmlnaHQ6IDAsCiAgICBib3R0b206IDAsCiAgICBsZWZ0OiAwLAogICAgd2lkdGg6IDAsCiAgICBoZWlnaHQ6IDAsCiAgICBicnVzaEJvdHRvbTogMAogIH07CiAgcmV0dXJuIE1hdGgubWluKE1hdGguYWJzKHdpZHRoIC0gKG9mZnNldC5sZWZ0IHx8IDApIC0gKG9mZnNldC5yaWdodCB8fCAwKSksIE1hdGguYWJzKGhlaWdodCAtIChvZmZzZXQudG9wIHx8IDApIC0gKG9mZnNldC5ib3R0b20gfHwgMCkpKSAvIDI7Cn07CnZhciBkaXN0YW5jZUJldHdlZW5Qb2ludHMgPSAocG9pbnQ0LCBhbm90aGVyUG9pbnQpID0+IHsKICB2YXIgewogICAgeDogeDEsCiAgICB5OiB5MQogIH0gPSBwb2ludDQ7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIKICB9ID0gYW5vdGhlclBvaW50OwogIHJldHVybiBNYXRoLnNxcnQoKHgxIC0geDIpICoqIDIgKyAoeTEgLSB5MikgKiogMik7Cn07CnZhciBnZXRBbmdsZU9mUG9pbnQgPSAoX3JlZjIsIF9yZWYyMikgPT4gewogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyCiAgfSA9IF9yZWYyOwogIHZhciB7CiAgICBjeCwKICAgIGN5CiAgfSA9IF9yZWYyMjsKICB2YXIgcmFkaXVzID0gZGlzdGFuY2VCZXR3ZWVuUG9pbnRzKHsKICAgIHg6IHgyLAogICAgeTogeTIKICB9LCB7CiAgICB4OiBjeCwKICAgIHk6IGN5CiAgfSk7CiAgaWYgKHJhZGl1cyA8PSAwKSB7CiAgICByZXR1cm4gewogICAgICByYWRpdXMsCiAgICAgIGFuZ2xlOiAwCiAgICB9OwogIH0KICB2YXIgY29zID0gKHgyIC0gY3gpIC8gcmFkaXVzOwogIHZhciBhbmdsZUluUmFkaWFuID0gTWF0aC5hY29zKGNvcyk7CiAgaWYgKHkyID4gY3kpIHsKICAgIGFuZ2xlSW5SYWRpYW4gPSAyICogTWF0aC5QSSAtIGFuZ2xlSW5SYWRpYW47CiAgfQogIHJldHVybiB7CiAgICByYWRpdXMsCiAgICBhbmdsZTogcmFkaWFuVG9EZWdyZWUoYW5nbGVJblJhZGlhbiksCiAgICBhbmdsZUluUmFkaWFuCiAgfTsKfTsKdmFyIGZvcm1hdEFuZ2xlT2ZTZWN0b3IgPSAoX3JlZjMpID0+IHsKICB2YXIgewogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IF9yZWYzOwogIHZhciBzdGFydENudCA9IE1hdGguZmxvb3Ioc3RhcnRBbmdsZSAvIDM2MCk7CiAgdmFyIGVuZENudCA9IE1hdGguZmxvb3IoZW5kQW5nbGUgLyAzNjApOwogIHZhciBtaW4yID0gTWF0aC5taW4oc3RhcnRDbnQsIGVuZENudCk7CiAgcmV0dXJuIHsKICAgIHN0YXJ0QW5nbGU6IHN0YXJ0QW5nbGUgLSBtaW4yICogMzYwLAogICAgZW5kQW5nbGU6IGVuZEFuZ2xlIC0gbWluMiAqIDM2MAogIH07Cn07CnZhciByZXZlcnNlRm9ybWF0QW5nbGVPZlNlY3RvciA9IChhbmdsZSwgX3JlZjQpID0+IHsKICB2YXIgewogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IF9yZWY0OwogIHZhciBzdGFydENudCA9IE1hdGguZmxvb3Ioc3RhcnRBbmdsZSAvIDM2MCk7CiAgdmFyIGVuZENudCA9IE1hdGguZmxvb3IoZW5kQW5nbGUgLyAzNjApOwogIHZhciBtaW4yID0gTWF0aC5taW4oc3RhcnRDbnQsIGVuZENudCk7CiAgcmV0dXJuIGFuZ2xlICsgbWluMiAqIDM2MDsKfTsKdmFyIGluUmFuZ2VPZlNlY3RvciA9IChfcmVmNSwgdmlld0JveCkgPT4gewogIHZhciB7CiAgICBjaGFydFg6IHgyLAogICAgY2hhcnRZOiB5MgogIH0gPSBfcmVmNTsKICB2YXIgewogICAgcmFkaXVzLAogICAgYW5nbGUKICB9ID0gZ2V0QW5nbGVPZlBvaW50KHsKICAgIHg6IHgyLAogICAgeTogeTIKICB9LCB2aWV3Qm94KTsKICB2YXIgewogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cwogIH0gPSB2aWV3Qm94OwogIGlmIChyYWRpdXMgPCBpbm5lclJhZGl1cyB8fCByYWRpdXMgPiBvdXRlclJhZGl1cykgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmIChyYWRpdXMgPT09IDApIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlCiAgfSA9IGZvcm1hdEFuZ2xlT2ZTZWN0b3Iodmlld0JveCk7CiAgdmFyIGZvcm1hdEFuZ2xlID0gYW5nbGU7CiAgdmFyIGluUmFuZ2U7CiAgaWYgKHN0YXJ0QW5nbGUgPD0gZW5kQW5nbGUpIHsKICAgIHdoaWxlIChmb3JtYXRBbmdsZSA+IGVuZEFuZ2xlKSB7CiAgICAgIGZvcm1hdEFuZ2xlIC09IDM2MDsKICAgIH0KICAgIHdoaWxlIChmb3JtYXRBbmdsZSA8IHN0YXJ0QW5nbGUpIHsKICAgICAgZm9ybWF0QW5nbGUgKz0gMzYwOwogICAgfQogICAgaW5SYW5nZSA9IGZvcm1hdEFuZ2xlID49IHN0YXJ0QW5nbGUgJiYgZm9ybWF0QW5nbGUgPD0gZW5kQW5nbGU7CiAgfSBlbHNlIHsKICAgIHdoaWxlIChmb3JtYXRBbmdsZSA+IHN0YXJ0QW5nbGUpIHsKICAgICAgZm9ybWF0QW5nbGUgLT0gMzYwOwogICAgfQogICAgd2hpbGUgKGZvcm1hdEFuZ2xlIDwgZW5kQW5nbGUpIHsKICAgICAgZm9ybWF0QW5nbGUgKz0gMzYwOwogICAgfQogICAgaW5SYW5nZSA9IGZvcm1hdEFuZ2xlID49IGVuZEFuZ2xlICYmIGZvcm1hdEFuZ2xlIDw9IHN0YXJ0QW5nbGU7CiAgfQogIGlmIChpblJhbmdlKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDEyKF9vYmplY3RTcHJlYWQxMih7fSwgdmlld0JveCksIHt9LCB7CiAgICAgIHJhZGl1cywKICAgICAgYW5nbGU6IHJldmVyc2VGb3JtYXRBbmdsZU9mU2VjdG9yKGZvcm1hdEFuZ2xlLCB2aWV3Qm94KQogICAgfSk7CiAgfQogIHJldHVybiBudWxsOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9jdXJzb3IvZ2V0UmFkaWFsQ3Vyc29yUG9pbnRzLmpzCmZ1bmN0aW9uIGdldFJhZGlhbEN1cnNvclBvaW50cyhhY3RpdmVDb29yZGluYXRlKSB7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICByYWRpdXMsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gYWN0aXZlQ29vcmRpbmF0ZTsKICB2YXIgc3RhcnRQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCByYWRpdXMsIHN0YXJ0QW5nbGUpOwogIHZhciBlbmRQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCByYWRpdXMsIGVuZEFuZ2xlKTsKICByZXR1cm4gewogICAgcG9pbnRzOiBbc3RhcnRQb2ludCwgZW5kUG9pbnRdLAogICAgY3gsCiAgICBjeSwKICAgIHJhZGl1cywKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL1NlY3Rvci5qcwp2YXIgUmVhY3QxMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gX2V4dGVuZHM4KCkgewogIHJldHVybiBfZXh0ZW5kczggPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczguYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQp2YXIgZ2V0RGVsdGFBbmdsZSA9IChzdGFydEFuZ2xlLCBlbmRBbmdsZSkgPT4gewogIHZhciBzaWduMiA9IG1hdGhTaWduKGVuZEFuZ2xlIC0gc3RhcnRBbmdsZSk7CiAgdmFyIGRlbHRhQW5nbGUgPSBNYXRoLm1pbihNYXRoLmFicyhlbmRBbmdsZSAtIHN0YXJ0QW5nbGUpLCAzNTkuOTk5KTsKICByZXR1cm4gc2lnbjIgKiBkZWx0YUFuZ2xlOwp9Owp2YXIgZ2V0VGFuZ2VudENpcmNsZSA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgcmFkaXVzLAogICAgYW5nbGUsCiAgICBzaWduOiBzaWduMiwKICAgIGlzRXh0ZXJuYWwsCiAgICBjb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsCiAgfSA9IF9yZWYyOwogIHZhciBjZW50ZXJSYWRpdXMgPSBjb3JuZXJSYWRpdXMgKiAoaXNFeHRlcm5hbCA/IDEgOiAtMSkgKyByYWRpdXM7CiAgdmFyIHRoZXRhID0gTWF0aC5hc2luKGNvcm5lclJhZGl1cyAvIGNlbnRlclJhZGl1cykgLyBSQURJQU47CiAgdmFyIGNlbnRlckFuZ2xlID0gY29ybmVySXNFeHRlcm5hbCA/IGFuZ2xlIDogYW5nbGUgKyBzaWduMiAqIHRoZXRhOwogIHZhciBjZW50ZXIgPSBwb2xhclRvQ2FydGVzaWFuKGN4LCBjeSwgY2VudGVyUmFkaXVzLCBjZW50ZXJBbmdsZSk7CiAgdmFyIGNpcmNsZVRhbmdlbmN5ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHJhZGl1cywgY2VudGVyQW5nbGUpOwogIHZhciBsaW5lVGFuZ2VuY3lBbmdsZSA9IGNvcm5lcklzRXh0ZXJuYWwgPyBhbmdsZSAtIHNpZ24yICogdGhldGEgOiBhbmdsZTsKICB2YXIgbGluZVRhbmdlbmN5ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIGNlbnRlclJhZGl1cyAqIE1hdGguY29zKHRoZXRhICogUkFESUFOKSwgbGluZVRhbmdlbmN5QW5nbGUpOwogIHJldHVybiB7CiAgICBjZW50ZXIsCiAgICBjaXJjbGVUYW5nZW5jeSwKICAgIGxpbmVUYW5nZW5jeSwKICAgIHRoZXRhCiAgfTsKfTsKdmFyIGdldFNlY3RvclBhdGggPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIGlubmVyUmFkaXVzLAogICAgb3V0ZXJSYWRpdXMsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gX3JlZjI7CiAgdmFyIGFuZ2xlID0gZ2V0RGVsdGFBbmdsZShzdGFydEFuZ2xlLCBlbmRBbmdsZSk7CiAgdmFyIHRlbXBFbmRBbmdsZSA9IHN0YXJ0QW5nbGUgKyBhbmdsZTsKICB2YXIgb3V0ZXJTdGFydFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIG91dGVyUmFkaXVzLCBzdGFydEFuZ2xlKTsKICB2YXIgb3V0ZXJFbmRQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBvdXRlclJhZGl1cywgdGVtcEVuZEFuZ2xlKTsKICB2YXIgcGF0aDIgPSAiTSAiLmNvbmNhdChvdXRlclN0YXJ0UG9pbnQueCwgIiwiKS5jb25jYXQob3V0ZXJTdGFydFBvaW50LnksICJcbiAgICBBICIpLmNvbmNhdChvdXRlclJhZGl1cywgIiwiKS5jb25jYXQob3V0ZXJSYWRpdXMsICIsMCxcbiAgICAiKS5jb25jYXQoKyhNYXRoLmFicyhhbmdsZSkgPiAxODApLCAiLCIpLmNvbmNhdCgrKHN0YXJ0QW5nbGUgPiB0ZW1wRW5kQW5nbGUpLCAiLFxuICAgICIpLmNvbmNhdChvdXRlckVuZFBvaW50LngsICIsIikuY29uY2F0KG91dGVyRW5kUG9pbnQueSwgIlxuICAiKTsKICBpZiAoaW5uZXJSYWRpdXMgPiAwKSB7CiAgICB2YXIgaW5uZXJTdGFydFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIGlubmVyUmFkaXVzLCBzdGFydEFuZ2xlKTsKICAgIHZhciBpbm5lckVuZFBvaW50ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIGlubmVyUmFkaXVzLCB0ZW1wRW5kQW5nbGUpOwogICAgcGF0aDIgKz0gIkwgIi5jb25jYXQoaW5uZXJFbmRQb2ludC54LCAiLCIpLmNvbmNhdChpbm5lckVuZFBvaW50LnksICJcbiAgICAgICAgICAgIEEgIikuY29uY2F0KGlubmVyUmFkaXVzLCAiLCIpLmNvbmNhdChpbm5lclJhZGl1cywgIiwwLFxuICAgICAgICAgICAgIikuY29uY2F0KCsoTWF0aC5hYnMoYW5nbGUpID4gMTgwKSwgIiwiKS5jb25jYXQoKyhzdGFydEFuZ2xlIDw9IHRlbXBFbmRBbmdsZSksICIsXG4gICAgICAgICAgICAiKS5jb25jYXQoaW5uZXJTdGFydFBvaW50LngsICIsIikuY29uY2F0KGlubmVyU3RhcnRQb2ludC55LCAiIFoiKTsKICB9IGVsc2UgewogICAgcGF0aDIgKz0gIkwgIi5jb25jYXQoY3gsICIsIikuY29uY2F0KGN5LCAiIFoiKTsKICB9CiAgcmV0dXJuIHBhdGgyOwp9Owp2YXIgZ2V0U2VjdG9yV2l0aENvcm5lciA9IChfcmVmMykgPT4gewogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIGNvcm5lclJhZGl1cywKICAgIGZvcmNlQ29ybmVyUmFkaXVzLAogICAgY29ybmVySXNFeHRlcm5hbCwKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZQogIH0gPSBfcmVmMzsKICB2YXIgc2lnbjIgPSBtYXRoU2lnbihlbmRBbmdsZSAtIHN0YXJ0QW5nbGUpOwogIHZhciB7CiAgICBjaXJjbGVUYW5nZW5jeTogc29jdCwKICAgIGxpbmVUYW5nZW5jeTogc29sdCwKICAgIHRoZXRhOiBzb3QKICB9ID0gZ2V0VGFuZ2VudENpcmNsZSh7CiAgICBjeCwKICAgIGN5LAogICAgcmFkaXVzOiBvdXRlclJhZGl1cywKICAgIGFuZ2xlOiBzdGFydEFuZ2xlLAogICAgc2lnbjogc2lnbjIsCiAgICBjb3JuZXJSYWRpdXMsCiAgICBjb3JuZXJJc0V4dGVybmFsCiAgfSk7CiAgdmFyIHsKICAgIGNpcmNsZVRhbmdlbmN5OiBlb2N0LAogICAgbGluZVRhbmdlbmN5OiBlb2x0LAogICAgdGhldGE6IGVvdAogIH0gPSBnZXRUYW5nZW50Q2lyY2xlKHsKICAgIGN4LAogICAgY3ksCiAgICByYWRpdXM6IG91dGVyUmFkaXVzLAogICAgYW5nbGU6IGVuZEFuZ2xlLAogICAgc2lnbjogLXNpZ24yLAogICAgY29ybmVyUmFkaXVzLAogICAgY29ybmVySXNFeHRlcm5hbAogIH0pOwogIHZhciBvdXRlckFyY0FuZ2xlID0gY29ybmVySXNFeHRlcm5hbCA/IE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgOiBNYXRoLmFicyhzdGFydEFuZ2xlIC0gZW5kQW5nbGUpIC0gc290IC0gZW90OwogIGlmIChvdXRlckFyY0FuZ2xlIDwgMCkgewogICAgaWYgKGZvcmNlQ29ybmVyUmFkaXVzKSB7CiAgICAgIHJldHVybiAiTSAiLmNvbmNhdChzb2x0LngsICIsIikuY29uY2F0KHNvbHQueSwgIlxuICAgICAgICBhIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwxLCIpLmNvbmNhdChjb3JuZXJSYWRpdXMgKiAyLCAiLDBcbiAgICAgICAgYSIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwwLDAsMSwiKS5jb25jYXQoLWNvcm5lclJhZGl1cyAqIDIsICIsMFxuICAgICAgIik7CiAgICB9CiAgICByZXR1cm4gZ2V0U2VjdG9yUGF0aCh7CiAgICAgIGN4LAogICAgICBjeSwKICAgICAgaW5uZXJSYWRpdXMsCiAgICAgIG91dGVyUmFkaXVzLAogICAgICBzdGFydEFuZ2xlLAogICAgICBlbmRBbmdsZQogICAgfSk7CiAgfQogIHZhciBwYXRoMiA9ICJNICIuY29uY2F0KHNvbHQueCwgIiwiKS5jb25jYXQoc29sdC55LCAiXG4gICAgQSIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwwLDAsIikuY29uY2F0KCsoc2lnbjIgPCAwKSwgIiwiKS5jb25jYXQoc29jdC54LCAiLCIpLmNvbmNhdChzb2N0LnksICJcbiAgICBBIikuY29uY2F0KG91dGVyUmFkaXVzLCAiLCIpLmNvbmNhdChvdXRlclJhZGl1cywgIiwwLCIpLmNvbmNhdCgrKG91dGVyQXJjQW5nbGUgPiAxODApLCAiLCIpLmNvbmNhdCgrKHNpZ24yIDwgMCksICIsIikuY29uY2F0KGVvY3QueCwgIiwiKS5jb25jYXQoZW9jdC55LCAiXG4gICAgQSIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwwLDAsIikuY29uY2F0KCsoc2lnbjIgPCAwKSwgIiwiKS5jb25jYXQoZW9sdC54LCAiLCIpLmNvbmNhdChlb2x0LnksICJcbiAgIik7CiAgaWYgKGlubmVyUmFkaXVzID4gMCkgewogICAgdmFyIHsKICAgICAgY2lyY2xlVGFuZ2VuY3k6IHNpY3QsCiAgICAgIGxpbmVUYW5nZW5jeTogc2lsdCwKICAgICAgdGhldGE6IHNpdAogICAgfSA9IGdldFRhbmdlbnRDaXJjbGUoewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIHJhZGl1czogaW5uZXJSYWRpdXMsCiAgICAgIGFuZ2xlOiBzdGFydEFuZ2xlLAogICAgICBzaWduOiBzaWduMiwKICAgICAgaXNFeHRlcm5hbDogdHJ1ZSwKICAgICAgY29ybmVyUmFkaXVzLAogICAgICBjb3JuZXJJc0V4dGVybmFsCiAgICB9KTsKICAgIHZhciB7CiAgICAgIGNpcmNsZVRhbmdlbmN5OiBlaWN0LAogICAgICBsaW5lVGFuZ2VuY3k6IGVpbHQsCiAgICAgIHRoZXRhOiBlaXQKICAgIH0gPSBnZXRUYW5nZW50Q2lyY2xlKHsKICAgICAgY3gsCiAgICAgIGN5LAogICAgICByYWRpdXM6IGlubmVyUmFkaXVzLAogICAgICBhbmdsZTogZW5kQW5nbGUsCiAgICAgIHNpZ246IC1zaWduMiwKICAgICAgaXNFeHRlcm5hbDogdHJ1ZSwKICAgICAgY29ybmVyUmFkaXVzLAogICAgICBjb3JuZXJJc0V4dGVybmFsCiAgICB9KTsKICAgIHZhciBpbm5lckFyY0FuZ2xlID0gY29ybmVySXNFeHRlcm5hbCA/IE1hdGguYWJzKHN0YXJ0QW5nbGUgLSBlbmRBbmdsZSkgOiBNYXRoLmFicyhzdGFydEFuZ2xlIC0gZW5kQW5nbGUpIC0gc2l0IC0gZWl0OwogICAgaWYgKGlubmVyQXJjQW5nbGUgPCAwICYmIGNvcm5lclJhZGl1cyA9PT0gMCkgewogICAgICByZXR1cm4gIiIuY29uY2F0KHBhdGgyLCAiTCIpLmNvbmNhdChjeCwgIiwiKS5jb25jYXQoY3ksICJaIik7CiAgICB9CiAgICBwYXRoMiArPSAiTCIuY29uY2F0KGVpbHQueCwgIiwiKS5jb25jYXQoZWlsdC55LCAiXG4gICAgICBBIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwiKS5jb25jYXQoY29ybmVyUmFkaXVzLCAiLDAsMCwiKS5jb25jYXQoKyhzaWduMiA8IDApLCAiLCIpLmNvbmNhdChlaWN0LngsICIsIikuY29uY2F0KGVpY3QueSwgIlxuICAgICAgQSIpLmNvbmNhdChpbm5lclJhZGl1cywgIiwiKS5jb25jYXQoaW5uZXJSYWRpdXMsICIsMCwiKS5jb25jYXQoKyhpbm5lckFyY0FuZ2xlID4gMTgwKSwgIiwiKS5jb25jYXQoKyhzaWduMiA+IDApLCAiLCIpLmNvbmNhdChzaWN0LngsICIsIikuY29uY2F0KHNpY3QueSwgIlxuICAgICAgQSIpLmNvbmNhdChjb3JuZXJSYWRpdXMsICIsIikuY29uY2F0KGNvcm5lclJhZGl1cywgIiwwLDAsIikuY29uY2F0KCsoc2lnbjIgPCAwKSwgIiwiKS5jb25jYXQoc2lsdC54LCAiLCIpLmNvbmNhdChzaWx0LnksICJaIik7CiAgfSBlbHNlIHsKICAgIHBhdGgyICs9ICJMIi5jb25jYXQoY3gsICIsIikuY29uY2F0KGN5LCAiWiIpOwogIH0KICByZXR1cm4gcGF0aDI7Cn07CnZhciBkZWZhdWx0U2VjdG9yUHJvcHMgPSB7CiAgY3g6IDAsCiAgY3k6IDAsCiAgaW5uZXJSYWRpdXM6IDAsCiAgb3V0ZXJSYWRpdXM6IDAsCiAgc3RhcnRBbmdsZTogMCwKICBlbmRBbmdsZTogMCwKICBjb3JuZXJSYWRpdXM6IDAsCiAgZm9yY2VDb3JuZXJSYWRpdXM6IGZhbHNlLAogIGNvcm5lcklzRXh0ZXJuYWw6IGZhbHNlCn07CnZhciBTZWN0b3IgPSAoc2VjdG9yUHJvcHMpID0+IHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKHNlY3RvclByb3BzLCBkZWZhdWx0U2VjdG9yUHJvcHMpOwogIHZhciB7CiAgICBjeCwKICAgIGN5LAogICAgaW5uZXJSYWRpdXMsCiAgICBvdXRlclJhZGl1cywKICAgIGNvcm5lclJhZGl1cywKICAgIGZvcmNlQ29ybmVyUmFkaXVzLAogICAgY29ybmVySXNFeHRlcm5hbCwKICAgIHN0YXJ0QW5nbGUsCiAgICBlbmRBbmdsZSwKICAgIGNsYXNzTmFtZQogIH0gPSBwcm9wczsKICBpZiAob3V0ZXJSYWRpdXMgPCBpbm5lclJhZGl1cyB8fCBzdGFydEFuZ2xlID09PSBlbmRBbmdsZSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBsYXllckNsYXNzID0gY2xzeCgicmVjaGFydHMtc2VjdG9yIiwgY2xhc3NOYW1lKTsKICB2YXIgZGVsdGFSYWRpdXMgPSBvdXRlclJhZGl1cyAtIGlubmVyUmFkaXVzOwogIHZhciBjciA9IGdldFBlcmNlbnRWYWx1ZShjb3JuZXJSYWRpdXMsIGRlbHRhUmFkaXVzLCAwLCB0cnVlKTsKICB2YXIgcGF0aDI7CiAgaWYgKGNyID4gMCAmJiBNYXRoLmFicyhzdGFydEFuZ2xlIC0gZW5kQW5nbGUpIDwgMzYwKSB7CiAgICBwYXRoMiA9IGdldFNlY3RvcldpdGhDb3JuZXIoewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIGlubmVyUmFkaXVzLAogICAgICBvdXRlclJhZGl1cywKICAgICAgY29ybmVyUmFkaXVzOiBNYXRoLm1pbihjciwgZGVsdGFSYWRpdXMgLyAyKSwKICAgICAgZm9yY2VDb3JuZXJSYWRpdXMsCiAgICAgIGNvcm5lcklzRXh0ZXJuYWwsCiAgICAgIHN0YXJ0QW5nbGUsCiAgICAgIGVuZEFuZ2xlCiAgICB9KTsKICB9IGVsc2UgewogICAgcGF0aDIgPSBnZXRTZWN0b3JQYXRoKHsKICAgICAgY3gsCiAgICAgIGN5LAogICAgICBpbm5lclJhZGl1cywKICAgICAgb3V0ZXJSYWRpdXMsCiAgICAgIHN0YXJ0QW5nbGUsCiAgICAgIGVuZEFuZ2xlCiAgICB9KTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEwLmNyZWF0ZUVsZW1lbnQoInBhdGgiLCBfZXh0ZW5kczgoe30sIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHMocHJvcHMpLCB7CiAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MsCiAgICBkOiBwYXRoMgogIH0pKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvY3Vyc29yL2dldEN1cnNvclBvaW50cy5qcwpmdW5jdGlvbiBnZXRDdXJzb3JQb2ludHMobGF5b3V0LCBhY3RpdmVDb29yZGluYXRlLCBvZmZzZXQpIHsKICBpZiAobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIpIHsKICAgIHJldHVybiBbewogICAgICB4OiBhY3RpdmVDb29yZGluYXRlLngsCiAgICAgIHk6IG9mZnNldC50b3AKICAgIH0sIHsKICAgICAgeDogYWN0aXZlQ29vcmRpbmF0ZS54LAogICAgICB5OiBvZmZzZXQudG9wICsgb2Zmc2V0LmhlaWdodAogICAgfV07CiAgfQogIGlmIChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgIHJldHVybiBbewogICAgICB4OiBvZmZzZXQubGVmdCwKICAgICAgeTogYWN0aXZlQ29vcmRpbmF0ZS55CiAgICB9LCB7CiAgICAgIHg6IG9mZnNldC5sZWZ0ICsgb2Zmc2V0LndpZHRoLAogICAgICB5OiBhY3RpdmVDb29yZGluYXRlLnkKICAgIH1dOwogIH0KICBpZiAoaXNQb2xhckNvb3JkaW5hdGUoYWN0aXZlQ29vcmRpbmF0ZSkpIHsKICAgIGlmIChsYXlvdXQgPT09ICJjZW50cmljIikgewogICAgICB2YXIgewogICAgICAgIGN4LAogICAgICAgIGN5LAogICAgICAgIGlubmVyUmFkaXVzLAogICAgICAgIG91dGVyUmFkaXVzLAogICAgICAgIGFuZ2xlCiAgICAgIH0gPSBhY3RpdmVDb29yZGluYXRlOwogICAgICB2YXIgaW5uZXJQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBpbm5lclJhZGl1cywgYW5nbGUpOwogICAgICB2YXIgb3V0ZXJQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBvdXRlclJhZGl1cywgYW5nbGUpOwogICAgICByZXR1cm4gW3sKICAgICAgICB4OiBpbm5lclBvaW50LngsCiAgICAgICAgeTogaW5uZXJQb2ludC55CiAgICAgIH0sIHsKICAgICAgICB4OiBvdXRlclBvaW50LngsCiAgICAgICAgeTogb3V0ZXJQb2ludC55CiAgICAgIH1dOwogICAgfQogICAgcmV0dXJuIGdldFJhZGlhbEN1cnNvclBvaW50cyhhY3RpdmVDb29yZGluYXRlKTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2F4aXNTZWxlY3RvcnMuanMKdmFyIGltcG9ydF9yYW5nZTIgPSBfX3RvRVNNKHJlcXVpcmVfcmFuZ2UyKCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3ZpY3RvcnktdmVuZG9yQDM3LjMuNi9ub2RlX21vZHVsZXMvdmljdG9yeS12ZW5kb3IvZXMvZDMtc2NhbGUuanMKdmFyIGQzX3NjYWxlX2V4cG9ydHMgPSB7fTsKX19leHBvcnQoZDNfc2NhbGVfZXhwb3J0cywgewogIHNjYWxlQmFuZDogKCkgPT4gYmFuZCwKICBzY2FsZURpdmVyZ2luZzogKCkgPT4gZGl2ZXJnaW5nLAogIHNjYWxlRGl2ZXJnaW5nTG9nOiAoKSA9PiBkaXZlcmdpbmdMb2csCiAgc2NhbGVEaXZlcmdpbmdQb3c6ICgpID0+IGRpdmVyZ2luZ1BvdywKICBzY2FsZURpdmVyZ2luZ1NxcnQ6ICgpID0+IGRpdmVyZ2luZ1NxcnQsCiAgc2NhbGVEaXZlcmdpbmdTeW1sb2c6ICgpID0+IGRpdmVyZ2luZ1N5bWxvZywKICBzY2FsZUlkZW50aXR5OiAoKSA9PiBpZGVudGl0eTIsCiAgc2NhbGVJbXBsaWNpdDogKCkgPT4gaW1wbGljaXQsCiAgc2NhbGVMaW5lYXI6ICgpID0+IGxpbmVhcjIsCiAgc2NhbGVMb2c6ICgpID0+IGxvZywKICBzY2FsZU9yZGluYWw6ICgpID0+IG9yZGluYWwsCiAgc2NhbGVQb2ludDogKCkgPT4gcG9pbnQzLAogIHNjYWxlUG93OiAoKSA9PiBwb3csCiAgc2NhbGVRdWFudGlsZTogKCkgPT4gcXVhbnRpbGUyLAogIHNjYWxlUXVhbnRpemU6ICgpID0+IHF1YW50aXplLAogIHNjYWxlUmFkaWFsOiAoKSA9PiByYWRpYWwsCiAgc2NhbGVTZXF1ZW50aWFsOiAoKSA9PiBzZXF1ZW50aWFsLAogIHNjYWxlU2VxdWVudGlhbExvZzogKCkgPT4gc2VxdWVudGlhbExvZywKICBzY2FsZVNlcXVlbnRpYWxQb3c6ICgpID0+IHNlcXVlbnRpYWxQb3csCiAgc2NhbGVTZXF1ZW50aWFsUXVhbnRpbGU6ICgpID0+IHNlcXVlbnRpYWxRdWFudGlsZSwKICBzY2FsZVNlcXVlbnRpYWxTcXJ0OiAoKSA9PiBzZXF1ZW50aWFsU3FydCwKICBzY2FsZVNlcXVlbnRpYWxTeW1sb2c6ICgpID0+IHNlcXVlbnRpYWxTeW1sb2csCiAgc2NhbGVTcXJ0OiAoKSA9PiBzcXJ0LAogIHNjYWxlU3ltbG9nOiAoKSA9PiBzeW1sb2csCiAgc2NhbGVUaHJlc2hvbGQ6ICgpID0+IHRocmVzaG9sZCwKICBzY2FsZVRpbWU6ICgpID0+IHRpbWUsCiAgc2NhbGVVdGM6ICgpID0+IHV0Y1RpbWUsCiAgdGlja0Zvcm1hdDogKCkgPT4gdGlja0Zvcm1hdAp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1hcnJheUAzLjIuNC9ub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL2FzY2VuZGluZy5qcwpmdW5jdGlvbiBhc2NlbmRpbmcoYSwgYikgewogIHJldHVybiBhID09IG51bGwgfHwgYiA9PSBudWxsID8gTmFOIDogYSA8IGIgPyAtMSA6IGEgPiBiID8gMSA6IGEgPj0gYiA/IDAgOiBOYU47Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1hcnJheUAzLjIuNC9ub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL2Rlc2NlbmRpbmcuanMKZnVuY3Rpb24gZGVzY2VuZGluZyhhLCBiKSB7CiAgcmV0dXJuIGEgPT0gbnVsbCB8fCBiID09IG51bGwgPyBOYU4gOiBiIDwgYSA/IC0xIDogYiA+IGEgPyAxIDogYiA+PSBhID8gMCA6IE5hTjsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWFycmF5QDMuMi40L25vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvYmlzZWN0b3IuanMKZnVuY3Rpb24gYmlzZWN0b3IoZikgewogIGxldCBjb21wYXJlMSwgY29tcGFyZTIsIGRlbHRhOwogIGlmIChmLmxlbmd0aCAhPT0gMikgewogICAgY29tcGFyZTEgPSBhc2NlbmRpbmc7CiAgICBjb21wYXJlMiA9IChkLCB4MikgPT4gYXNjZW5kaW5nKGYoZCksIHgyKTsKICAgIGRlbHRhID0gKGQsIHgyKSA9PiBmKGQpIC0geDI7CiAgfSBlbHNlIHsKICAgIGNvbXBhcmUxID0gZiA9PT0gYXNjZW5kaW5nIHx8IGYgPT09IGRlc2NlbmRpbmcgPyBmIDogemVybzsKICAgIGNvbXBhcmUyID0gZjsKICAgIGRlbHRhID0gZjsKICB9CiAgZnVuY3Rpb24gbGVmdChhLCB4MiwgbG8gPSAwLCBoaSA9IGEubGVuZ3RoKSB7CiAgICBpZiAobG8gPCBoaSkgewogICAgICBpZiAoY29tcGFyZTEoeDIsIHgyKSAhPT0gMCkgcmV0dXJuIGhpOwogICAgICBkbyB7CiAgICAgICAgY29uc3QgbWlkID0gbG8gKyBoaSA+Pj4gMTsKICAgICAgICBpZiAoY29tcGFyZTIoYVttaWRdLCB4MikgPCAwKSBsbyA9IG1pZCArIDE7CiAgICAgICAgZWxzZSBoaSA9IG1pZDsKICAgICAgfSB3aGlsZSAobG8gPCBoaSk7CiAgICB9CiAgICByZXR1cm4gbG87CiAgfQogIGZ1bmN0aW9uIHJpZ2h0KGEsIHgyLCBsbyA9IDAsIGhpID0gYS5sZW5ndGgpIHsKICAgIGlmIChsbyA8IGhpKSB7CiAgICAgIGlmIChjb21wYXJlMSh4MiwgeDIpICE9PSAwKSByZXR1cm4gaGk7CiAgICAgIGRvIHsKICAgICAgICBjb25zdCBtaWQgPSBsbyArIGhpID4+PiAxOwogICAgICAgIGlmIChjb21wYXJlMihhW21pZF0sIHgyKSA8PSAwKSBsbyA9IG1pZCArIDE7CiAgICAgICAgZWxzZSBoaSA9IG1pZDsKICAgICAgfSB3aGlsZSAobG8gPCBoaSk7CiAgICB9CiAgICByZXR1cm4gbG87CiAgfQogIGZ1bmN0aW9uIGNlbnRlcihhLCB4MiwgbG8gPSAwLCBoaSA9IGEubGVuZ3RoKSB7CiAgICBjb25zdCBpID0gbGVmdChhLCB4MiwgbG8sIGhpIC0gMSk7CiAgICByZXR1cm4gaSA+IGxvICYmIGRlbHRhKGFbaSAtIDFdLCB4MikgPiAtZGVsdGEoYVtpXSwgeDIpID8gaSAtIDEgOiBpOwogIH0KICByZXR1cm4geyBsZWZ0LCBjZW50ZXIsIHJpZ2h0IH07Cn0KZnVuY3Rpb24gemVybygpIHsKICByZXR1cm4gMDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWFycmF5QDMuMi40L25vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvbnVtYmVyLmpzCmZ1bmN0aW9uIG51bWJlcih4MikgewogIHJldHVybiB4MiA9PT0gbnVsbCA/IE5hTiA6ICt4MjsKfQpmdW5jdGlvbiogbnVtYmVycyh2YWx1ZXMsIHZhbHVlb2YpIHsKICBpZiAodmFsdWVvZiA9PT0gdm9pZCAwKSB7CiAgICBmb3IgKGxldCB2YWx1ZSBvZiB2YWx1ZXMpIHsKICAgICAgaWYgKHZhbHVlICE9IG51bGwgJiYgKHZhbHVlID0gK3ZhbHVlKSA+PSB2YWx1ZSkgewogICAgICAgIHlpZWxkIHZhbHVlOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGxldCBpbmRleCA9IC0xOwogICAgZm9yIChsZXQgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIGlmICgodmFsdWUgPSB2YWx1ZW9mKHZhbHVlLCArK2luZGV4LCB2YWx1ZXMpKSAhPSBudWxsICYmICh2YWx1ZSA9ICt2YWx1ZSkgPj0gdmFsdWUpIHsKICAgICAgICB5aWVsZCB2YWx1ZTsKICAgICAgfQogICAgfQogIH0KfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWFycmF5QDMuMi40L25vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvYmlzZWN0LmpzCnZhciBhc2NlbmRpbmdCaXNlY3QgPSBiaXNlY3Rvcihhc2NlbmRpbmcpOwp2YXIgYmlzZWN0UmlnaHQgPSBhc2NlbmRpbmdCaXNlY3QucmlnaHQ7CnZhciBiaXNlY3RMZWZ0ID0gYXNjZW5kaW5nQmlzZWN0LmxlZnQ7CnZhciBiaXNlY3RDZW50ZXIgPSBiaXNlY3RvcihudW1iZXIpLmNlbnRlcjsKdmFyIGJpc2VjdF9kZWZhdWx0ID0gYmlzZWN0UmlnaHQ7CgovLyBub2RlX21vZHVsZXMvLnBucG0vaW50ZXJubWFwQDIuMC4zL25vZGVfbW9kdWxlcy9pbnRlcm5tYXAvc3JjL2luZGV4LmpzCnZhciBJbnRlcm5NYXAgPSBjbGFzcyBleHRlbmRzIE1hcCB7CiAgY29uc3RydWN0b3IoZW50cmllcywga2V5ID0ga2V5b2YpIHsKICAgIHN1cGVyKCk7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydGllcyh0aGlzLCB7IF9pbnRlcm46IHsgdmFsdWU6IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkgfSwgX2tleTogeyB2YWx1ZToga2V5IH0gfSk7CiAgICBpZiAoZW50cmllcyAhPSBudWxsKSBmb3IgKGNvbnN0IFtrZXkyLCB2YWx1ZV0gb2YgZW50cmllcykgdGhpcy5zZXQoa2V5MiwgdmFsdWUpOwogIH0KICBnZXQoa2V5KSB7CiAgICByZXR1cm4gc3VwZXIuZ2V0KGludGVybl9nZXQodGhpcywga2V5KSk7CiAgfQogIGhhcyhrZXkpIHsKICAgIHJldHVybiBzdXBlci5oYXMoaW50ZXJuX2dldCh0aGlzLCBrZXkpKTsKICB9CiAgc2V0KGtleSwgdmFsdWUpIHsKICAgIHJldHVybiBzdXBlci5zZXQoaW50ZXJuX3NldCh0aGlzLCBrZXkpLCB2YWx1ZSk7CiAgfQogIGRlbGV0ZShrZXkpIHsKICAgIHJldHVybiBzdXBlci5kZWxldGUoaW50ZXJuX2RlbGV0ZSh0aGlzLCBrZXkpKTsKICB9Cn07CmZ1bmN0aW9uIGludGVybl9nZXQoeyBfaW50ZXJuLCBfa2V5IH0sIHZhbHVlKSB7CiAgY29uc3Qga2V5ID0gX2tleSh2YWx1ZSk7CiAgcmV0dXJuIF9pbnRlcm4uaGFzKGtleSkgPyBfaW50ZXJuLmdldChrZXkpIDogdmFsdWU7Cn0KZnVuY3Rpb24gaW50ZXJuX3NldCh7IF9pbnRlcm4sIF9rZXkgfSwgdmFsdWUpIHsKICBjb25zdCBrZXkgPSBfa2V5KHZhbHVlKTsKICBpZiAoX2ludGVybi5oYXMoa2V5KSkgcmV0dXJuIF9pbnRlcm4uZ2V0KGtleSk7CiAgX2ludGVybi5zZXQoa2V5LCB2YWx1ZSk7CiAgcmV0dXJuIHZhbHVlOwp9CmZ1bmN0aW9uIGludGVybl9kZWxldGUoeyBfaW50ZXJuLCBfa2V5IH0sIHZhbHVlKSB7CiAgY29uc3Qga2V5ID0gX2tleSh2YWx1ZSk7CiAgaWYgKF9pbnRlcm4uaGFzKGtleSkpIHsKICAgIHZhbHVlID0gX2ludGVybi5nZXQoa2V5KTsKICAgIF9pbnRlcm4uZGVsZXRlKGtleSk7CiAgfQogIHJldHVybiB2YWx1ZTsKfQpmdW5jdGlvbiBrZXlvZih2YWx1ZSkgewogIHJldHVybiB2YWx1ZSAhPT0gbnVsbCAmJiB0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiID8gdmFsdWUudmFsdWVPZigpIDogdmFsdWU7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1hcnJheUAzLjIuNC9ub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL3NvcnQuanMKZnVuY3Rpb24gY29tcGFyZURlZmluZWQoY29tcGFyZSA9IGFzY2VuZGluZykgewogIGlmIChjb21wYXJlID09PSBhc2NlbmRpbmcpIHJldHVybiBhc2NlbmRpbmdEZWZpbmVkOwogIGlmICh0eXBlb2YgY29tcGFyZSAhPT0gImZ1bmN0aW9uIikgdGhyb3cgbmV3IFR5cGVFcnJvcigiY29tcGFyZSBpcyBub3QgYSBmdW5jdGlvbiIpOwogIHJldHVybiAoYSwgYikgPT4gewogICAgY29uc3QgeDIgPSBjb21wYXJlKGEsIGIpOwogICAgaWYgKHgyIHx8IHgyID09PSAwKSByZXR1cm4geDI7CiAgICByZXR1cm4gKGNvbXBhcmUoYiwgYikgPT09IDApIC0gKGNvbXBhcmUoYSwgYSkgPT09IDApOwogIH07Cn0KZnVuY3Rpb24gYXNjZW5kaW5nRGVmaW5lZChhLCBiKSB7CiAgcmV0dXJuIChhID09IG51bGwgfHwgIShhID49IGEpKSAtIChiID09IG51bGwgfHwgIShiID49IGIpKSB8fCAoYSA8IGIgPyAtMSA6IGEgPiBiID8gMSA6IDApOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtYXJyYXlAMy4yLjQvbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy90aWNrcy5qcwp2YXIgZTEwID0gTWF0aC5zcXJ0KDUwKTsKdmFyIGU1ID0gTWF0aC5zcXJ0KDEwKTsKdmFyIGUyID0gTWF0aC5zcXJ0KDIpOwpmdW5jdGlvbiB0aWNrU3BlYyhzdGFydCwgc3RvcCwgY291bnQpIHsKICBjb25zdCBzdGVwID0gKHN0b3AgLSBzdGFydCkgLyBNYXRoLm1heCgwLCBjb3VudCksIHBvd2VyID0gTWF0aC5mbG9vcihNYXRoLmxvZzEwKHN0ZXApKSwgZXJyb3IgPSBzdGVwIC8gTWF0aC5wb3coMTAsIHBvd2VyKSwgZmFjdG9yID0gZXJyb3IgPj0gZTEwID8gMTAgOiBlcnJvciA+PSBlNSA/IDUgOiBlcnJvciA+PSBlMiA/IDIgOiAxOwogIGxldCBpMSwgaTIsIGluYzsKICBpZiAocG93ZXIgPCAwKSB7CiAgICBpbmMgPSBNYXRoLnBvdygxMCwgLXBvd2VyKSAvIGZhY3RvcjsKICAgIGkxID0gTWF0aC5yb3VuZChzdGFydCAqIGluYyk7CiAgICBpMiA9IE1hdGgucm91bmQoc3RvcCAqIGluYyk7CiAgICBpZiAoaTEgLyBpbmMgPCBzdGFydCkgKytpMTsKICAgIGlmIChpMiAvIGluYyA+IHN0b3ApIC0taTI7CiAgICBpbmMgPSAtaW5jOwogIH0gZWxzZSB7CiAgICBpbmMgPSBNYXRoLnBvdygxMCwgcG93ZXIpICogZmFjdG9yOwogICAgaTEgPSBNYXRoLnJvdW5kKHN0YXJ0IC8gaW5jKTsKICAgIGkyID0gTWF0aC5yb3VuZChzdG9wIC8gaW5jKTsKICAgIGlmIChpMSAqIGluYyA8IHN0YXJ0KSArK2kxOwogICAgaWYgKGkyICogaW5jID4gc3RvcCkgLS1pMjsKICB9CiAgaWYgKGkyIDwgaTEgJiYgMC41IDw9IGNvdW50ICYmIGNvdW50IDwgMikgcmV0dXJuIHRpY2tTcGVjKHN0YXJ0LCBzdG9wLCBjb3VudCAqIDIpOwogIHJldHVybiBbaTEsIGkyLCBpbmNdOwp9CmZ1bmN0aW9uIHRpY2tzKHN0YXJ0LCBzdG9wLCBjb3VudCkgewogIHN0b3AgPSArc3RvcCwgc3RhcnQgPSArc3RhcnQsIGNvdW50ID0gK2NvdW50OwogIGlmICghKGNvdW50ID4gMCkpIHJldHVybiBbXTsKICBpZiAoc3RhcnQgPT09IHN0b3ApIHJldHVybiBbc3RhcnRdOwogIGNvbnN0IHJldmVyc2UyID0gc3RvcCA8IHN0YXJ0LCBbaTEsIGkyLCBpbmNdID0gcmV2ZXJzZTIgPyB0aWNrU3BlYyhzdG9wLCBzdGFydCwgY291bnQpIDogdGlja1NwZWMoc3RhcnQsIHN0b3AsIGNvdW50KTsKICBpZiAoIShpMiA+PSBpMSkpIHJldHVybiBbXTsKICBjb25zdCBuID0gaTIgLSBpMSArIDEsIHRpY2tzMiA9IG5ldyBBcnJheShuKTsKICBpZiAocmV2ZXJzZTIpIHsKICAgIGlmIChpbmMgPCAwKSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkyIC0gaSkgLyAtaW5jOwogICAgZWxzZSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkyIC0gaSkgKiBpbmM7CiAgfSBlbHNlIHsKICAgIGlmIChpbmMgPCAwKSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkxICsgaSkgLyAtaW5jOwogICAgZWxzZSBmb3IgKGxldCBpID0gMDsgaSA8IG47ICsraSkgdGlja3MyW2ldID0gKGkxICsgaSkgKiBpbmM7CiAgfQogIHJldHVybiB0aWNrczI7Cn0KZnVuY3Rpb24gdGlja0luY3JlbWVudChzdGFydCwgc3RvcCwgY291bnQpIHsKICBzdG9wID0gK3N0b3AsIHN0YXJ0ID0gK3N0YXJ0LCBjb3VudCA9ICtjb3VudDsKICByZXR1cm4gdGlja1NwZWMoc3RhcnQsIHN0b3AsIGNvdW50KVsyXTsKfQpmdW5jdGlvbiB0aWNrU3RlcChzdGFydCwgc3RvcCwgY291bnQpIHsKICBzdG9wID0gK3N0b3AsIHN0YXJ0ID0gK3N0YXJ0LCBjb3VudCA9ICtjb3VudDsKICBjb25zdCByZXZlcnNlMiA9IHN0b3AgPCBzdGFydCwgaW5jID0gcmV2ZXJzZTIgPyB0aWNrSW5jcmVtZW50KHN0b3AsIHN0YXJ0LCBjb3VudCkgOiB0aWNrSW5jcmVtZW50KHN0YXJ0LCBzdG9wLCBjb3VudCk7CiAgcmV0dXJuIChyZXZlcnNlMiA/IC0xIDogMSkgKiAoaW5jIDwgMCA/IDEgLyAtaW5jIDogaW5jKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWFycmF5QDMuMi40L25vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvbWF4LmpzCmZ1bmN0aW9uIG1heCh2YWx1ZXMsIHZhbHVlb2YpIHsKICBsZXQgbWF4MjsKICBpZiAodmFsdWVvZiA9PT0gdm9pZCAwKSB7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAodmFsdWUgIT0gbnVsbCAmJiAobWF4MiA8IHZhbHVlIHx8IG1heDIgPT09IHZvaWQgMCAmJiB2YWx1ZSA+PSB2YWx1ZSkpIHsKICAgICAgICBtYXgyID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgewogICAgbGV0IGluZGV4ID0gLTE7CiAgICBmb3IgKGxldCB2YWx1ZSBvZiB2YWx1ZXMpIHsKICAgICAgaWYgKCh2YWx1ZSA9IHZhbHVlb2YodmFsdWUsICsraW5kZXgsIHZhbHVlcykpICE9IG51bGwgJiYgKG1heDIgPCB2YWx1ZSB8fCBtYXgyID09PSB2b2lkIDAgJiYgdmFsdWUgPj0gdmFsdWUpKSB7CiAgICAgICAgbWF4MiA9IHZhbHVlOwogICAgICB9CiAgICB9CiAgfQogIHJldHVybiBtYXgyOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtYXJyYXlAMy4yLjQvbm9kZV9tb2R1bGVzL2QzLWFycmF5L3NyYy9taW4uanMKZnVuY3Rpb24gbWluKHZhbHVlcywgdmFsdWVvZikgewogIGxldCBtaW4yOwogIGlmICh2YWx1ZW9mID09PSB2b2lkIDApIHsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVzKSB7CiAgICAgIGlmICh2YWx1ZSAhPSBudWxsICYmIChtaW4yID4gdmFsdWUgfHwgbWluMiA9PT0gdm9pZCAwICYmIHZhbHVlID49IHZhbHVlKSkgewogICAgICAgIG1pbjIgPSB2YWx1ZTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBsZXQgaW5kZXggPSAtMTsKICAgIGZvciAobGV0IHZhbHVlIG9mIHZhbHVlcykgewogICAgICBpZiAoKHZhbHVlID0gdmFsdWVvZih2YWx1ZSwgKytpbmRleCwgdmFsdWVzKSkgIT0gbnVsbCAmJiAobWluMiA+IHZhbHVlIHx8IG1pbjIgPT09IHZvaWQgMCAmJiB2YWx1ZSA+PSB2YWx1ZSkpIHsKICAgICAgICBtaW4yID0gdmFsdWU7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIG1pbjI7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1hcnJheUAzLjIuNC9ub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL3F1aWNrc2VsZWN0LmpzCmZ1bmN0aW9uIHF1aWNrc2VsZWN0KGFycmF5LCBrLCBsZWZ0ID0gMCwgcmlnaHQgPSBJbmZpbml0eSwgY29tcGFyZSkgewogIGsgPSBNYXRoLmZsb29yKGspOwogIGxlZnQgPSBNYXRoLmZsb29yKE1hdGgubWF4KDAsIGxlZnQpKTsKICByaWdodCA9IE1hdGguZmxvb3IoTWF0aC5taW4oYXJyYXkubGVuZ3RoIC0gMSwgcmlnaHQpKTsKICBpZiAoIShsZWZ0IDw9IGsgJiYgayA8PSByaWdodCkpIHJldHVybiBhcnJheTsKICBjb21wYXJlID0gY29tcGFyZSA9PT0gdm9pZCAwID8gYXNjZW5kaW5nRGVmaW5lZCA6IGNvbXBhcmVEZWZpbmVkKGNvbXBhcmUpOwogIHdoaWxlIChyaWdodCA+IGxlZnQpIHsKICAgIGlmIChyaWdodCAtIGxlZnQgPiA2MDApIHsKICAgICAgY29uc3QgbiA9IHJpZ2h0IC0gbGVmdCArIDE7CiAgICAgIGNvbnN0IG0gPSBrIC0gbGVmdCArIDE7CiAgICAgIGNvbnN0IHogPSBNYXRoLmxvZyhuKTsKICAgICAgY29uc3QgcyA9IDAuNSAqIE1hdGguZXhwKDIgKiB6IC8gMyk7CiAgICAgIGNvbnN0IHNkID0gMC41ICogTWF0aC5zcXJ0KHogKiBzICogKG4gLSBzKSAvIG4pICogKG0gLSBuIC8gMiA8IDAgPyAtMSA6IDEpOwogICAgICBjb25zdCBuZXdMZWZ0ID0gTWF0aC5tYXgobGVmdCwgTWF0aC5mbG9vcihrIC0gbSAqIHMgLyBuICsgc2QpKTsKICAgICAgY29uc3QgbmV3UmlnaHQgPSBNYXRoLm1pbihyaWdodCwgTWF0aC5mbG9vcihrICsgKG4gLSBtKSAqIHMgLyBuICsgc2QpKTsKICAgICAgcXVpY2tzZWxlY3QoYXJyYXksIGssIG5ld0xlZnQsIG5ld1JpZ2h0LCBjb21wYXJlKTsKICAgIH0KICAgIGNvbnN0IHQgPSBhcnJheVtrXTsKICAgIGxldCBpID0gbGVmdDsKICAgIGxldCBqID0gcmlnaHQ7CiAgICBzd2FwKGFycmF5LCBsZWZ0LCBrKTsKICAgIGlmIChjb21wYXJlKGFycmF5W3JpZ2h0XSwgdCkgPiAwKSBzd2FwKGFycmF5LCBsZWZ0LCByaWdodCk7CiAgICB3aGlsZSAoaSA8IGopIHsKICAgICAgc3dhcChhcnJheSwgaSwgaiksICsraSwgLS1qOwogICAgICB3aGlsZSAoY29tcGFyZShhcnJheVtpXSwgdCkgPCAwKSArK2k7CiAgICAgIHdoaWxlIChjb21wYXJlKGFycmF5W2pdLCB0KSA+IDApIC0tajsKICAgIH0KICAgIGlmIChjb21wYXJlKGFycmF5W2xlZnRdLCB0KSA9PT0gMCkgc3dhcChhcnJheSwgbGVmdCwgaik7CiAgICBlbHNlICsraiwgc3dhcChhcnJheSwgaiwgcmlnaHQpOwogICAgaWYgKGogPD0gaykgbGVmdCA9IGogKyAxOwogICAgaWYgKGsgPD0gaikgcmlnaHQgPSBqIC0gMTsKICB9CiAgcmV0dXJuIGFycmF5Owp9CmZ1bmN0aW9uIHN3YXAoYXJyYXksIGksIGopIHsKICBjb25zdCB0ID0gYXJyYXlbaV07CiAgYXJyYXlbaV0gPSBhcnJheVtqXTsKICBhcnJheVtqXSA9IHQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1hcnJheUAzLjIuNC9ub2RlX21vZHVsZXMvZDMtYXJyYXkvc3JjL3F1YW50aWxlLmpzCmZ1bmN0aW9uIHF1YW50aWxlKHZhbHVlcywgcCwgdmFsdWVvZikgewogIHZhbHVlcyA9IEZsb2F0NjRBcnJheS5mcm9tKG51bWJlcnModmFsdWVzLCB2YWx1ZW9mKSk7CiAgaWYgKCEobiA9IHZhbHVlcy5sZW5ndGgpIHx8IGlzTmFOKHAgPSArcCkpIHJldHVybjsKICBpZiAocCA8PSAwIHx8IG4gPCAyKSByZXR1cm4gbWluKHZhbHVlcyk7CiAgaWYgKHAgPj0gMSkgcmV0dXJuIG1heCh2YWx1ZXMpOwogIHZhciBuLCBpID0gKG4gLSAxKSAqIHAsIGkwID0gTWF0aC5mbG9vcihpKSwgdmFsdWUwID0gbWF4KHF1aWNrc2VsZWN0KHZhbHVlcywgaTApLnN1YmFycmF5KDAsIGkwICsgMSkpLCB2YWx1ZTEgPSBtaW4odmFsdWVzLnN1YmFycmF5KGkwICsgMSkpOwogIHJldHVybiB2YWx1ZTAgKyAodmFsdWUxIC0gdmFsdWUwKSAqIChpIC0gaTApOwp9CmZ1bmN0aW9uIHF1YW50aWxlU29ydGVkKHZhbHVlcywgcCwgdmFsdWVvZiA9IG51bWJlcikgewogIGlmICghKG4gPSB2YWx1ZXMubGVuZ3RoKSB8fCBpc05hTihwID0gK3ApKSByZXR1cm47CiAgaWYgKHAgPD0gMCB8fCBuIDwgMikgcmV0dXJuICt2YWx1ZW9mKHZhbHVlc1swXSwgMCwgdmFsdWVzKTsKICBpZiAocCA+PSAxKSByZXR1cm4gK3ZhbHVlb2YodmFsdWVzW24gLSAxXSwgbiAtIDEsIHZhbHVlcyk7CiAgdmFyIG4sIGkgPSAobiAtIDEpICogcCwgaTAgPSBNYXRoLmZsb29yKGkpLCB2YWx1ZTAgPSArdmFsdWVvZih2YWx1ZXNbaTBdLCBpMCwgdmFsdWVzKSwgdmFsdWUxID0gK3ZhbHVlb2YodmFsdWVzW2kwICsgMV0sIGkwICsgMSwgdmFsdWVzKTsKICByZXR1cm4gdmFsdWUwICsgKHZhbHVlMSAtIHZhbHVlMCkgKiAoaSAtIGkwKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWFycmF5QDMuMi40L25vZGVfbW9kdWxlcy9kMy1hcnJheS9zcmMvcmFuZ2UuanMKZnVuY3Rpb24gcmFuZ2Uoc3RhcnQsIHN0b3AsIHN0ZXApIHsKICBzdGFydCA9ICtzdGFydCwgc3RvcCA9ICtzdG9wLCBzdGVwID0gKG4gPSBhcmd1bWVudHMubGVuZ3RoKSA8IDIgPyAoc3RvcCA9IHN0YXJ0LCBzdGFydCA9IDAsIDEpIDogbiA8IDMgPyAxIDogK3N0ZXA7CiAgdmFyIGkgPSAtMSwgbiA9IE1hdGgubWF4KDAsIE1hdGguY2VpbCgoc3RvcCAtIHN0YXJ0KSAvIHN0ZXApKSB8IDAsIHJhbmdlNCA9IG5ldyBBcnJheShuKTsKICB3aGlsZSAoKytpIDwgbikgewogICAgcmFuZ2U0W2ldID0gc3RhcnQgKyBpICogc3RlcDsKICB9CiAgcmV0dXJuIHJhbmdlNDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvaW5pdC5qcwpmdW5jdGlvbiBpbml0UmFuZ2UoZG9tYWluLCByYW5nZTQpIHsKICBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsKICAgIGNhc2UgMDoKICAgICAgYnJlYWs7CiAgICBjYXNlIDE6CiAgICAgIHRoaXMucmFuZ2UoZG9tYWluKTsKICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICB0aGlzLnJhbmdlKHJhbmdlNCkuZG9tYWluKGRvbWFpbik7CiAgICAgIGJyZWFrOwogIH0KICByZXR1cm4gdGhpczsKfQpmdW5jdGlvbiBpbml0SW50ZXJwb2xhdG9yKGRvbWFpbiwgaW50ZXJwb2xhdG9yKSB7CiAgc3dpdGNoIChhcmd1bWVudHMubGVuZ3RoKSB7CiAgICBjYXNlIDA6CiAgICAgIGJyZWFrOwogICAgY2FzZSAxOiB7CiAgICAgIGlmICh0eXBlb2YgZG9tYWluID09PSAiZnVuY3Rpb24iKSB0aGlzLmludGVycG9sYXRvcihkb21haW4pOwogICAgICBlbHNlIHRoaXMucmFuZ2UoZG9tYWluKTsKICAgICAgYnJlYWs7CiAgICB9CiAgICBkZWZhdWx0OiB7CiAgICAgIHRoaXMuZG9tYWluKGRvbWFpbik7CiAgICAgIGlmICh0eXBlb2YgaW50ZXJwb2xhdG9yID09PSAiZnVuY3Rpb24iKSB0aGlzLmludGVycG9sYXRvcihpbnRlcnBvbGF0b3IpOwogICAgICBlbHNlIHRoaXMucmFuZ2UoaW50ZXJwb2xhdG9yKTsKICAgICAgYnJlYWs7CiAgICB9CiAgfQogIHJldHVybiB0aGlzOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9vcmRpbmFsLmpzCnZhciBpbXBsaWNpdCA9IFN5bWJvbCgiaW1wbGljaXQiKTsKZnVuY3Rpb24gb3JkaW5hbCgpIHsKICB2YXIgaW5kZXggPSBuZXcgSW50ZXJuTWFwKCksIGRvbWFpbiA9IFtdLCByYW5nZTQgPSBbXSwgdW5rbm93biA9IGltcGxpY2l0OwogIGZ1bmN0aW9uIHNjYWxlKGQpIHsKICAgIGxldCBpID0gaW5kZXguZ2V0KGQpOwogICAgaWYgKGkgPT09IHZvaWQgMCkgewogICAgICBpZiAodW5rbm93biAhPT0gaW1wbGljaXQpIHJldHVybiB1bmtub3duOwogICAgICBpbmRleC5zZXQoZCwgaSA9IGRvbWFpbi5wdXNoKGQpIC0gMSk7CiAgICB9CiAgICByZXR1cm4gcmFuZ2U0W2kgJSByYW5nZTQubGVuZ3RoXTsKICB9CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gZG9tYWluLnNsaWNlKCk7CiAgICBkb21haW4gPSBbXSwgaW5kZXggPSBuZXcgSW50ZXJuTWFwKCk7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIF8pIHsKICAgICAgaWYgKGluZGV4Lmhhcyh2YWx1ZSkpIGNvbnRpbnVlOwogICAgICBpbmRleC5zZXQodmFsdWUsIGRvbWFpbi5wdXNoKHZhbHVlKSAtIDEpOwogICAgfQogICAgcmV0dXJuIHNjYWxlOwogIH07CiAgc2NhbGUucmFuZ2UgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyYW5nZTQgPSBBcnJheS5mcm9tKF8pLCBzY2FsZSkgOiByYW5nZTQuc2xpY2UoKTsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBvcmRpbmFsKGRvbWFpbiwgcmFuZ2U0KS51bmtub3duKHVua25vd24pOwogIH07CiAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwogIHJldHVybiBzY2FsZTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvYmFuZC5qcwpmdW5jdGlvbiBiYW5kKCkgewogIHZhciBzY2FsZSA9IG9yZGluYWwoKS51bmtub3duKHZvaWQgMCksIGRvbWFpbiA9IHNjYWxlLmRvbWFpbiwgb3JkaW5hbFJhbmdlID0gc2NhbGUucmFuZ2UsIHIwID0gMCwgcjEgPSAxLCBzdGVwLCBiYW5kd2lkdGgsIHJvdW5kID0gZmFsc2UsIHBhZGRpbmdJbm5lciA9IDAsIHBhZGRpbmdPdXRlciA9IDAsIGFsaWduID0gMC41OwogIGRlbGV0ZSBzY2FsZS51bmtub3duOwogIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICB2YXIgbiA9IGRvbWFpbigpLmxlbmd0aCwgcmV2ZXJzZTIgPSByMSA8IHIwLCBzdGFydCA9IHJldmVyc2UyID8gcjEgOiByMCwgc3RvcCA9IHJldmVyc2UyID8gcjAgOiByMTsKICAgIHN0ZXAgPSAoc3RvcCAtIHN0YXJ0KSAvIE1hdGgubWF4KDEsIG4gLSBwYWRkaW5nSW5uZXIgKyBwYWRkaW5nT3V0ZXIgKiAyKTsKICAgIGlmIChyb3VuZCkgc3RlcCA9IE1hdGguZmxvb3Ioc3RlcCk7CiAgICBzdGFydCArPSAoc3RvcCAtIHN0YXJ0IC0gc3RlcCAqIChuIC0gcGFkZGluZ0lubmVyKSkgKiBhbGlnbjsKICAgIGJhbmR3aWR0aCA9IHN0ZXAgKiAoMSAtIHBhZGRpbmdJbm5lcik7CiAgICBpZiAocm91bmQpIHN0YXJ0ID0gTWF0aC5yb3VuZChzdGFydCksIGJhbmR3aWR0aCA9IE1hdGgucm91bmQoYmFuZHdpZHRoKTsKICAgIHZhciB2YWx1ZXMgPSByYW5nZShuKS5tYXAoZnVuY3Rpb24oaSkgewogICAgICByZXR1cm4gc3RhcnQgKyBzdGVwICogaTsKICAgIH0pOwogICAgcmV0dXJuIG9yZGluYWxSYW5nZShyZXZlcnNlMiA/IHZhbHVlcy5yZXZlcnNlKCkgOiB2YWx1ZXMpOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkb21haW4oXyksIHJlc2NhbGUoKSkgOiBkb21haW4oKTsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoW3IwLCByMV0gPSBfLCByMCA9ICtyMCwgcjEgPSArcjEsIHJlc2NhbGUoKSkgOiBbcjAsIHIxXTsKICB9OwogIHNjYWxlLnJhbmdlUm91bmQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gW3IwLCByMV0gPSBfLCByMCA9ICtyMCwgcjEgPSArcjEsIHJvdW5kID0gdHJ1ZSwgcmVzY2FsZSgpOwogIH07CiAgc2NhbGUuYmFuZHdpZHRoID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gYmFuZHdpZHRoOwogIH07CiAgc2NhbGUuc3RlcCA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHN0ZXA7CiAgfTsKICBzY2FsZS5yb3VuZCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHJvdW5kID0gISFfLCByZXNjYWxlKCkpIDogcm91bmQ7CiAgfTsKICBzY2FsZS5wYWRkaW5nID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocGFkZGluZ0lubmVyID0gTWF0aC5taW4oMSwgcGFkZGluZ091dGVyID0gK18pLCByZXNjYWxlKCkpIDogcGFkZGluZ0lubmVyOwogIH07CiAgc2NhbGUucGFkZGluZ0lubmVyID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocGFkZGluZ0lubmVyID0gTWF0aC5taW4oMSwgXyksIHJlc2NhbGUoKSkgOiBwYWRkaW5nSW5uZXI7CiAgfTsKICBzY2FsZS5wYWRkaW5nT3V0ZXIgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChwYWRkaW5nT3V0ZXIgPSArXywgcmVzY2FsZSgpKSA6IHBhZGRpbmdPdXRlcjsKICB9OwogIHNjYWxlLmFsaWduID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoYWxpZ24gPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBfKSksIHJlc2NhbGUoKSkgOiBhbGlnbjsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBiYW5kKGRvbWFpbigpLCBbcjAsIHIxXSkucm91bmQocm91bmQpLnBhZGRpbmdJbm5lcihwYWRkaW5nSW5uZXIpLnBhZGRpbmdPdXRlcihwYWRkaW5nT3V0ZXIpLmFsaWduKGFsaWduKTsKICB9OwogIHJldHVybiBpbml0UmFuZ2UuYXBwbHkocmVzY2FsZSgpLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIHBvaW50aXNoKHNjYWxlKSB7CiAgdmFyIGNvcHkzID0gc2NhbGUuY29weTsKICBzY2FsZS5wYWRkaW5nID0gc2NhbGUucGFkZGluZ091dGVyOwogIGRlbGV0ZSBzY2FsZS5wYWRkaW5nSW5uZXI7CiAgZGVsZXRlIHNjYWxlLnBhZGRpbmdPdXRlcjsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gcG9pbnRpc2goY29weTMoKSk7CiAgfTsKICByZXR1cm4gc2NhbGU7Cn0KZnVuY3Rpb24gcG9pbnQzKCkgewogIHJldHVybiBwb2ludGlzaChiYW5kLmFwcGx5KG51bGwsIGFyZ3VtZW50cykucGFkZGluZ0lubmVyKDEpKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWNvbG9yQDMuMS4wL25vZGVfbW9kdWxlcy9kMy1jb2xvci9zcmMvZGVmaW5lLmpzCmZ1bmN0aW9uIGRlZmluZV9kZWZhdWx0KGNvbnN0cnVjdG9yLCBmYWN0b3J5LCBwcm90b3R5cGUpIHsKICBjb25zdHJ1Y3Rvci5wcm90b3R5cGUgPSBmYWN0b3J5LnByb3RvdHlwZSA9IHByb3RvdHlwZTsKICBwcm90b3R5cGUuY29uc3RydWN0b3IgPSBjb25zdHJ1Y3RvcjsKfQpmdW5jdGlvbiBleHRlbmQocGFyZW50LCBkZWZpbml0aW9uKSB7CiAgdmFyIHByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUocGFyZW50LnByb3RvdHlwZSk7CiAgZm9yICh2YXIga2V5IGluIGRlZmluaXRpb24pIHByb3RvdHlwZVtrZXldID0gZGVmaW5pdGlvbltrZXldOwogIHJldHVybiBwcm90b3R5cGU7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1jb2xvckAzLjEuMC9ub2RlX21vZHVsZXMvZDMtY29sb3Ivc3JjL2NvbG9yLmpzCmZ1bmN0aW9uIENvbG9yKCkgewp9CnZhciBkYXJrZXIgPSAwLjc7CnZhciBicmlnaHRlciA9IDEgLyBkYXJrZXI7CnZhciByZUkgPSAiXFxzKihbKy1dP1xcZCspXFxzKiI7CnZhciByZU4gPSAiXFxzKihbKy1dPyg/OlxcZCpcXC4pP1xcZCsoPzpbZUVdWystXT9cXGQrKT8pXFxzKiI7CnZhciByZVAgPSAiXFxzKihbKy1dPyg/OlxcZCpcXC4pP1xcZCsoPzpbZUVdWystXT9cXGQrKT8pJVxccyoiOwp2YXIgcmVIZXggPSAvXiMoWzAtOWEtZl17Myw4fSkkLzsKdmFyIHJlUmdiSW50ZWdlciA9IG5ldyBSZWdFeHAoYF5yZ2JcXCgke3JlSX0sJHtyZUl9LCR7cmVJfVxcKSRgKTsKdmFyIHJlUmdiUGVyY2VudCA9IG5ldyBSZWdFeHAoYF5yZ2JcXCgke3JlUH0sJHtyZVB9LCR7cmVQfVxcKSRgKTsKdmFyIHJlUmdiYUludGVnZXIgPSBuZXcgUmVnRXhwKGBecmdiYVxcKCR7cmVJfSwke3JlSX0sJHtyZUl9LCR7cmVOfVxcKSRgKTsKdmFyIHJlUmdiYVBlcmNlbnQgPSBuZXcgUmVnRXhwKGBecmdiYVxcKCR7cmVQfSwke3JlUH0sJHtyZVB9LCR7cmVOfVxcKSRgKTsKdmFyIHJlSHNsUGVyY2VudCA9IG5ldyBSZWdFeHAoYF5oc2xcXCgke3JlTn0sJHtyZVB9LCR7cmVQfVxcKSRgKTsKdmFyIHJlSHNsYVBlcmNlbnQgPSBuZXcgUmVnRXhwKGBeaHNsYVxcKCR7cmVOfSwke3JlUH0sJHtyZVB9LCR7cmVOfVxcKSRgKTsKdmFyIG5hbWVkID0gewogIGFsaWNlYmx1ZTogMTU3OTIzODMsCiAgYW50aXF1ZXdoaXRlOiAxNjQ0NDM3NSwKICBhcXVhOiA2NTUzNSwKICBhcXVhbWFyaW5lOiA4Mzg4NTY0LAogIGF6dXJlOiAxNTc5NDE3NSwKICBiZWlnZTogMTYxMTkyNjAsCiAgYmlzcXVlOiAxNjc3MDI0NCwKICBibGFjazogMCwKICBibGFuY2hlZGFsbW9uZDogMTY3NzIwNDUsCiAgYmx1ZTogMjU1LAogIGJsdWV2aW9sZXQ6IDkwNTUyMDIsCiAgYnJvd246IDEwODI0MjM0LAogIGJ1cmx5d29vZDogMTQ1OTYyMzEsCiAgY2FkZXRibHVlOiA2MjY2NTI4LAogIGNoYXJ0cmV1c2U6IDgzODgzNTIsCiAgY2hvY29sYXRlOiAxMzc4OTQ3MCwKICBjb3JhbDogMTY3NDQyNzIsCiAgY29ybmZsb3dlcmJsdWU6IDY1OTE5ODEsCiAgY29ybnNpbGs6IDE2Nzc1Mzg4LAogIGNyaW1zb246IDE0NDIzMTAwLAogIGN5YW46IDY1NTM1LAogIGRhcmtibHVlOiAxMzksCiAgZGFya2N5YW46IDM1NzIzLAogIGRhcmtnb2xkZW5yb2Q6IDEyMDkyOTM5LAogIGRhcmtncmF5OiAxMTExOTAxNywKICBkYXJrZ3JlZW46IDI1NjAwLAogIGRhcmtncmV5OiAxMTExOTAxNywKICBkYXJra2hha2k6IDEyNDMzMjU5LAogIGRhcmttYWdlbnRhOiA5MTA5NjQzLAogIGRhcmtvbGl2ZWdyZWVuOiA1NTk3OTk5LAogIGRhcmtvcmFuZ2U6IDE2NzQ3NTIwLAogIGRhcmtvcmNoaWQ6IDEwMDQwMDEyLAogIGRhcmtyZWQ6IDkxMDk1MDQsCiAgZGFya3NhbG1vbjogMTUzMDg0MTAsCiAgZGFya3NlYWdyZWVuOiA5NDE5OTE5LAogIGRhcmtzbGF0ZWJsdWU6IDQ3MzQzNDcsCiAgZGFya3NsYXRlZ3JheTogMzEwMDQ5NSwKICBkYXJrc2xhdGVncmV5OiAzMTAwNDk1LAogIGRhcmt0dXJxdW9pc2U6IDUyOTQ1LAogIGRhcmt2aW9sZXQ6IDk2OTk1MzksCiAgZGVlcHBpbms6IDE2NzE2OTQ3LAogIGRlZXBza3libHVlOiA0OTE1MSwKICBkaW1ncmF5OiA2OTA4MjY1LAogIGRpbWdyZXk6IDY5MDgyNjUsCiAgZG9kZ2VyYmx1ZTogMjAwMzE5OSwKICBmaXJlYnJpY2s6IDExNjc0MTQ2LAogIGZsb3JhbHdoaXRlOiAxNjc3NTkyMCwKICBmb3Jlc3RncmVlbjogMjI2Mzg0MiwKICBmdWNoc2lhOiAxNjcxMTkzNSwKICBnYWluc2Jvcm86IDE0NDc0NDYwLAogIGdob3N0d2hpdGU6IDE2MzE2NjcxLAogIGdvbGQ6IDE2NzY2NzIwLAogIGdvbGRlbnJvZDogMTQzMjkxMjAsCiAgZ3JheTogODQyMTUwNCwKICBncmVlbjogMzI3NjgsCiAgZ3JlZW55ZWxsb3c6IDExNDAzMDU1LAogIGdyZXk6IDg0MjE1MDQsCiAgaG9uZXlkZXc6IDE1Nzk0MTYwLAogIGhvdHBpbms6IDE2NzM4NzQwLAogIGluZGlhbnJlZDogMTM0NTg1MjQsCiAgaW5kaWdvOiA0OTE1MzMwLAogIGl2b3J5OiAxNjc3NzIwMCwKICBraGFraTogMTU3ODc2NjAsCiAgbGF2ZW5kZXI6IDE1MTMyNDEwLAogIGxhdmVuZGVyYmx1c2g6IDE2NzczMzY1LAogIGxhd25ncmVlbjogODE5MDk3NiwKICBsZW1vbmNoaWZmb246IDE2Nzc1ODg1LAogIGxpZ2h0Ymx1ZTogMTEzOTMyNTQsCiAgbGlnaHRjb3JhbDogMTU3NjE1MzYsCiAgbGlnaHRjeWFuOiAxNDc0NTU5OSwKICBsaWdodGdvbGRlbnJvZHllbGxvdzogMTY0NDgyMTAsCiAgbGlnaHRncmF5OiAxMzg4MjMyMywKICBsaWdodGdyZWVuOiA5NDk4MjU2LAogIGxpZ2h0Z3JleTogMTM4ODIzMjMsCiAgbGlnaHRwaW5rOiAxNjc1ODQ2NSwKICBsaWdodHNhbG1vbjogMTY3NTI3NjIsCiAgbGlnaHRzZWFncmVlbjogMjE0Mjg5MCwKICBsaWdodHNreWJsdWU6IDg5MDAzNDYsCiAgbGlnaHRzbGF0ZWdyYXk6IDc4MzM3NTMsCiAgbGlnaHRzbGF0ZWdyZXk6IDc4MzM3NTMsCiAgbGlnaHRzdGVlbGJsdWU6IDExNTg0NzM0LAogIGxpZ2h0eWVsbG93OiAxNjc3NzE4NCwKICBsaW1lOiA2NTI4MCwKICBsaW1lZ3JlZW46IDMzMjkzMzAsCiAgbGluZW46IDE2NDQ1NjcwLAogIG1hZ2VudGE6IDE2NzExOTM1LAogIG1hcm9vbjogODM4ODYwOCwKICBtZWRpdW1hcXVhbWFyaW5lOiA2NzM3MzIyLAogIG1lZGl1bWJsdWU6IDIwNSwKICBtZWRpdW1vcmNoaWQ6IDEyMjExNjY3LAogIG1lZGl1bXB1cnBsZTogOTY2MjY4MywKICBtZWRpdW1zZWFncmVlbjogMzk3ODA5NywKICBtZWRpdW1zbGF0ZWJsdWU6IDgwODc3OTAsCiAgbWVkaXVtc3ByaW5nZ3JlZW46IDY0MTU0LAogIG1lZGl1bXR1cnF1b2lzZTogNDc3MjMwMCwKICBtZWRpdW12aW9sZXRyZWQ6IDEzMDQ3MTczLAogIG1pZG5pZ2h0Ymx1ZTogMTY0NDkxMiwKICBtaW50Y3JlYW06IDE2MTIxODUwLAogIG1pc3R5cm9zZTogMTY3NzAyNzMsCiAgbW9jY2FzaW46IDE2NzcwMjI5LAogIG5hdmFqb3doaXRlOiAxNjc2ODY4NSwKICBuYXZ5OiAxMjgsCiAgb2xkbGFjZTogMTY2NDM1NTgsCiAgb2xpdmU6IDg0MjEzNzYsCiAgb2xpdmVkcmFiOiA3MDQ4NzM5LAogIG9yYW5nZTogMTY3NTM5MjAsCiAgb3JhbmdlcmVkOiAxNjcyOTM0NCwKICBvcmNoaWQ6IDE0MzE1NzM0LAogIHBhbGVnb2xkZW5yb2Q6IDE1NjU3MTMwLAogIHBhbGVncmVlbjogMTAwMjU4ODAsCiAgcGFsZXR1cnF1b2lzZTogMTE1Mjk5NjYsCiAgcGFsZXZpb2xldHJlZDogMTQzODEyMDMsCiAgcGFwYXlhd2hpcDogMTY3NzMwNzcsCiAgcGVhY2hwdWZmOiAxNjc2NzY3MywKICBwZXJ1OiAxMzQ2ODk5MSwKICBwaW5rOiAxNjc2MTAzNSwKICBwbHVtOiAxNDUyNDYzNywKICBwb3dkZXJibHVlOiAxMTU5MTkxMCwKICBwdXJwbGU6IDgzODg3MzYsCiAgcmViZWNjYXB1cnBsZTogNjY5Nzg4MSwKICByZWQ6IDE2NzExNjgwLAogIHJvc3licm93bjogMTIzNTc1MTksCiAgcm95YWxibHVlOiA0Mjg2OTQ1LAogIHNhZGRsZWJyb3duOiA5MTI3MTg3LAogIHNhbG1vbjogMTY0MTY4ODIsCiAgc2FuZHlicm93bjogMTYwMzI4NjQsCiAgc2VhZ3JlZW46IDMwNTAzMjcsCiAgc2Vhc2hlbGw6IDE2Nzc0NjM4LAogIHNpZW5uYTogMTA1MDY3OTcsCiAgc2lsdmVyOiAxMjYzMjI1NiwKICBza3libHVlOiA4OTAwMzMxLAogIHNsYXRlYmx1ZTogNjk3MDA2MSwKICBzbGF0ZWdyYXk6IDczNzI5NDQsCiAgc2xhdGVncmV5OiA3MzcyOTQ0LAogIHNub3c6IDE2Nzc1OTMwLAogIHNwcmluZ2dyZWVuOiA2NTQwNywKICBzdGVlbGJsdWU6IDQ2MjA5ODAsCiAgdGFuOiAxMzgwODc4MCwKICB0ZWFsOiAzMjg5NiwKICB0aGlzdGxlOiAxNDIwNDg4OCwKICB0b21hdG86IDE2NzM3MDk1LAogIHR1cnF1b2lzZTogNDI1MTg1NiwKICB2aW9sZXQ6IDE1NjMxMDg2LAogIHdoZWF0OiAxNjExMzMzMSwKICB3aGl0ZTogMTY3NzcyMTUsCiAgd2hpdGVzbW9rZTogMTYxMTkyODUsCiAgeWVsbG93OiAxNjc3Njk2MCwKICB5ZWxsb3dncmVlbjogMTAxNDUwNzQKfTsKZGVmaW5lX2RlZmF1bHQoQ29sb3IsIGNvbG9yLCB7CiAgY29weShjaGFubmVscykgewogICAgcmV0dXJuIE9iamVjdC5hc3NpZ24obmV3IHRoaXMuY29uc3RydWN0b3IoKSwgdGhpcywgY2hhbm5lbHMpOwogIH0sCiAgZGlzcGxheWFibGUoKSB7CiAgICByZXR1cm4gdGhpcy5yZ2IoKS5kaXNwbGF5YWJsZSgpOwogIH0sCiAgaGV4OiBjb2xvcl9mb3JtYXRIZXgsCiAgLy8gRGVwcmVjYXRlZCEgVXNlIGNvbG9yLmZvcm1hdEhleC4KICBmb3JtYXRIZXg6IGNvbG9yX2Zvcm1hdEhleCwKICBmb3JtYXRIZXg4OiBjb2xvcl9mb3JtYXRIZXg4LAogIGZvcm1hdEhzbDogY29sb3JfZm9ybWF0SHNsLAogIGZvcm1hdFJnYjogY29sb3JfZm9ybWF0UmdiLAogIHRvU3RyaW5nOiBjb2xvcl9mb3JtYXRSZ2IKfSk7CmZ1bmN0aW9uIGNvbG9yX2Zvcm1hdEhleCgpIHsKICByZXR1cm4gdGhpcy5yZ2IoKS5mb3JtYXRIZXgoKTsKfQpmdW5jdGlvbiBjb2xvcl9mb3JtYXRIZXg4KCkgewogIHJldHVybiB0aGlzLnJnYigpLmZvcm1hdEhleDgoKTsKfQpmdW5jdGlvbiBjb2xvcl9mb3JtYXRIc2woKSB7CiAgcmV0dXJuIGhzbENvbnZlcnQodGhpcykuZm9ybWF0SHNsKCk7Cn0KZnVuY3Rpb24gY29sb3JfZm9ybWF0UmdiKCkgewogIHJldHVybiB0aGlzLnJnYigpLmZvcm1hdFJnYigpOwp9CmZ1bmN0aW9uIGNvbG9yKGZvcm1hdDIpIHsKICB2YXIgbSwgbDsKICBmb3JtYXQyID0gKGZvcm1hdDIgKyAiIikudHJpbSgpLnRvTG93ZXJDYXNlKCk7CiAgcmV0dXJuIChtID0gcmVIZXguZXhlYyhmb3JtYXQyKSkgPyAobCA9IG1bMV0ubGVuZ3RoLCBtID0gcGFyc2VJbnQobVsxXSwgMTYpLCBsID09PSA2ID8gcmdibihtKSA6IGwgPT09IDMgPyBuZXcgUmdiKG0gPj4gOCAmIDE1IHwgbSA+PiA0ICYgMjQwLCBtID4+IDQgJiAxNSB8IG0gJiAyNDAsIChtICYgMTUpIDw8IDQgfCBtICYgMTUsIDEpIDogbCA9PT0gOCA/IHJnYmEobSA+PiAyNCAmIDI1NSwgbSA+PiAxNiAmIDI1NSwgbSA+PiA4ICYgMjU1LCAobSAmIDI1NSkgLyAyNTUpIDogbCA9PT0gNCA/IHJnYmEobSA+PiAxMiAmIDE1IHwgbSA+PiA4ICYgMjQwLCBtID4+IDggJiAxNSB8IG0gPj4gNCAmIDI0MCwgbSA+PiA0ICYgMTUgfCBtICYgMjQwLCAoKG0gJiAxNSkgPDwgNCB8IG0gJiAxNSkgLyAyNTUpIDogbnVsbCkgOiAobSA9IHJlUmdiSW50ZWdlci5leGVjKGZvcm1hdDIpKSA/IG5ldyBSZ2IobVsxXSwgbVsyXSwgbVszXSwgMSkgOiAobSA9IHJlUmdiUGVyY2VudC5leGVjKGZvcm1hdDIpKSA/IG5ldyBSZ2IobVsxXSAqIDI1NSAvIDEwMCwgbVsyXSAqIDI1NSAvIDEwMCwgbVszXSAqIDI1NSAvIDEwMCwgMSkgOiAobSA9IHJlUmdiYUludGVnZXIuZXhlYyhmb3JtYXQyKSkgPyByZ2JhKG1bMV0sIG1bMl0sIG1bM10sIG1bNF0pIDogKG0gPSByZVJnYmFQZXJjZW50LmV4ZWMoZm9ybWF0MikpID8gcmdiYShtWzFdICogMjU1IC8gMTAwLCBtWzJdICogMjU1IC8gMTAwLCBtWzNdICogMjU1IC8gMTAwLCBtWzRdKSA6IChtID0gcmVIc2xQZXJjZW50LmV4ZWMoZm9ybWF0MikpID8gaHNsYShtWzFdLCBtWzJdIC8gMTAwLCBtWzNdIC8gMTAwLCAxKSA6IChtID0gcmVIc2xhUGVyY2VudC5leGVjKGZvcm1hdDIpKSA/IGhzbGEobVsxXSwgbVsyXSAvIDEwMCwgbVszXSAvIDEwMCwgbVs0XSkgOiBuYW1lZC5oYXNPd25Qcm9wZXJ0eShmb3JtYXQyKSA/IHJnYm4obmFtZWRbZm9ybWF0Ml0pIDogZm9ybWF0MiA9PT0gInRyYW5zcGFyZW50IiA/IG5ldyBSZ2IoTmFOLCBOYU4sIE5hTiwgMCkgOiBudWxsOwp9CmZ1bmN0aW9uIHJnYm4obikgewogIHJldHVybiBuZXcgUmdiKG4gPj4gMTYgJiAyNTUsIG4gPj4gOCAmIDI1NSwgbiAmIDI1NSwgMSk7Cn0KZnVuY3Rpb24gcmdiYShyMiwgZywgYiwgYSkgewogIGlmIChhIDw9IDApIHIyID0gZyA9IGIgPSBOYU47CiAgcmV0dXJuIG5ldyBSZ2IocjIsIGcsIGIsIGEpOwp9CmZ1bmN0aW9uIHJnYkNvbnZlcnQobykgewogIGlmICghKG8gaW5zdGFuY2VvZiBDb2xvcikpIG8gPSBjb2xvcihvKTsKICBpZiAoIW8pIHJldHVybiBuZXcgUmdiKCk7CiAgbyA9IG8ucmdiKCk7CiAgcmV0dXJuIG5ldyBSZ2Ioby5yLCBvLmcsIG8uYiwgby5vcGFjaXR5KTsKfQpmdW5jdGlvbiByZ2IocjIsIGcsIGIsIG9wYWNpdHkpIHsKICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA9PT0gMSA/IHJnYkNvbnZlcnQocjIpIDogbmV3IFJnYihyMiwgZywgYiwgb3BhY2l0eSA9PSBudWxsID8gMSA6IG9wYWNpdHkpOwp9CmZ1bmN0aW9uIFJnYihyMiwgZywgYiwgb3BhY2l0eSkgewogIHRoaXMuciA9ICtyMjsKICB0aGlzLmcgPSArZzsKICB0aGlzLmIgPSArYjsKICB0aGlzLm9wYWNpdHkgPSArb3BhY2l0eTsKfQpkZWZpbmVfZGVmYXVsdChSZ2IsIHJnYiwgZXh0ZW5kKENvbG9yLCB7CiAgYnJpZ2h0ZXIoaykgewogICAgayA9IGsgPT0gbnVsbCA/IGJyaWdodGVyIDogTWF0aC5wb3coYnJpZ2h0ZXIsIGspOwogICAgcmV0dXJuIG5ldyBSZ2IodGhpcy5yICogaywgdGhpcy5nICogaywgdGhpcy5iICogaywgdGhpcy5vcGFjaXR5KTsKICB9LAogIGRhcmtlcihrKSB7CiAgICBrID0gayA9PSBudWxsID8gZGFya2VyIDogTWF0aC5wb3coZGFya2VyLCBrKTsKICAgIHJldHVybiBuZXcgUmdiKHRoaXMuciAqIGssIHRoaXMuZyAqIGssIHRoaXMuYiAqIGssIHRoaXMub3BhY2l0eSk7CiAgfSwKICByZ2IoKSB7CiAgICByZXR1cm4gdGhpczsKICB9LAogIGNsYW1wKCkgewogICAgcmV0dXJuIG5ldyBSZ2IoY2xhbXBpKHRoaXMuciksIGNsYW1waSh0aGlzLmcpLCBjbGFtcGkodGhpcy5iKSwgY2xhbXBhKHRoaXMub3BhY2l0eSkpOwogIH0sCiAgZGlzcGxheWFibGUoKSB7CiAgICByZXR1cm4gLTAuNSA8PSB0aGlzLnIgJiYgdGhpcy5yIDwgMjU1LjUgJiYgKC0wLjUgPD0gdGhpcy5nICYmIHRoaXMuZyA8IDI1NS41KSAmJiAoLTAuNSA8PSB0aGlzLmIgJiYgdGhpcy5iIDwgMjU1LjUpICYmICgwIDw9IHRoaXMub3BhY2l0eSAmJiB0aGlzLm9wYWNpdHkgPD0gMSk7CiAgfSwKICBoZXg6IHJnYl9mb3JtYXRIZXgsCiAgLy8gRGVwcmVjYXRlZCEgVXNlIGNvbG9yLmZvcm1hdEhleC4KICBmb3JtYXRIZXg6IHJnYl9mb3JtYXRIZXgsCiAgZm9ybWF0SGV4ODogcmdiX2Zvcm1hdEhleDgsCiAgZm9ybWF0UmdiOiByZ2JfZm9ybWF0UmdiLAogIHRvU3RyaW5nOiByZ2JfZm9ybWF0UmdiCn0pKTsKZnVuY3Rpb24gcmdiX2Zvcm1hdEhleCgpIHsKICByZXR1cm4gYCMke2hleCh0aGlzLnIpfSR7aGV4KHRoaXMuZyl9JHtoZXgodGhpcy5iKX1gOwp9CmZ1bmN0aW9uIHJnYl9mb3JtYXRIZXg4KCkgewogIHJldHVybiBgIyR7aGV4KHRoaXMucil9JHtoZXgodGhpcy5nKX0ke2hleCh0aGlzLmIpfSR7aGV4KChpc05hTih0aGlzLm9wYWNpdHkpID8gMSA6IHRoaXMub3BhY2l0eSkgKiAyNTUpfWA7Cn0KZnVuY3Rpb24gcmdiX2Zvcm1hdFJnYigpIHsKICBjb25zdCBhID0gY2xhbXBhKHRoaXMub3BhY2l0eSk7CiAgcmV0dXJuIGAke2EgPT09IDEgPyAicmdiKCIgOiAicmdiYSgifSR7Y2xhbXBpKHRoaXMucil9LCAke2NsYW1waSh0aGlzLmcpfSwgJHtjbGFtcGkodGhpcy5iKX0ke2EgPT09IDEgPyAiKSIgOiBgLCAke2F9KWB9YDsKfQpmdW5jdGlvbiBjbGFtcGEob3BhY2l0eSkgewogIHJldHVybiBpc05hTihvcGFjaXR5KSA/IDEgOiBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBvcGFjaXR5KSk7Cn0KZnVuY3Rpb24gY2xhbXBpKHZhbHVlKSB7CiAgcmV0dXJuIE1hdGgubWF4KDAsIE1hdGgubWluKDI1NSwgTWF0aC5yb3VuZCh2YWx1ZSkgfHwgMCkpOwp9CmZ1bmN0aW9uIGhleCh2YWx1ZSkgewogIHZhbHVlID0gY2xhbXBpKHZhbHVlKTsKICByZXR1cm4gKHZhbHVlIDwgMTYgPyAiMCIgOiAiIikgKyB2YWx1ZS50b1N0cmluZygxNik7Cn0KZnVuY3Rpb24gaHNsYShoLCBzLCBsLCBhKSB7CiAgaWYgKGEgPD0gMCkgaCA9IHMgPSBsID0gTmFOOwogIGVsc2UgaWYgKGwgPD0gMCB8fCBsID49IDEpIGggPSBzID0gTmFOOwogIGVsc2UgaWYgKHMgPD0gMCkgaCA9IE5hTjsKICByZXR1cm4gbmV3IEhzbChoLCBzLCBsLCBhKTsKfQpmdW5jdGlvbiBoc2xDb252ZXJ0KG8pIHsKICBpZiAobyBpbnN0YW5jZW9mIEhzbCkgcmV0dXJuIG5ldyBIc2woby5oLCBvLnMsIG8ubCwgby5vcGFjaXR5KTsKICBpZiAoIShvIGluc3RhbmNlb2YgQ29sb3IpKSBvID0gY29sb3Iobyk7CiAgaWYgKCFvKSByZXR1cm4gbmV3IEhzbCgpOwogIGlmIChvIGluc3RhbmNlb2YgSHNsKSByZXR1cm4gbzsKICBvID0gby5yZ2IoKTsKICB2YXIgcjIgPSBvLnIgLyAyNTUsIGcgPSBvLmcgLyAyNTUsIGIgPSBvLmIgLyAyNTUsIG1pbjIgPSBNYXRoLm1pbihyMiwgZywgYiksIG1heDIgPSBNYXRoLm1heChyMiwgZywgYiksIGggPSBOYU4sIHMgPSBtYXgyIC0gbWluMiwgbCA9IChtYXgyICsgbWluMikgLyAyOwogIGlmIChzKSB7CiAgICBpZiAocjIgPT09IG1heDIpIGggPSAoZyAtIGIpIC8gcyArIChnIDwgYikgKiA2OwogICAgZWxzZSBpZiAoZyA9PT0gbWF4MikgaCA9IChiIC0gcjIpIC8gcyArIDI7CiAgICBlbHNlIGggPSAocjIgLSBnKSAvIHMgKyA0OwogICAgcyAvPSBsIDwgMC41ID8gbWF4MiArIG1pbjIgOiAyIC0gbWF4MiAtIG1pbjI7CiAgICBoICo9IDYwOwogIH0gZWxzZSB7CiAgICBzID0gbCA+IDAgJiYgbCA8IDEgPyAwIDogaDsKICB9CiAgcmV0dXJuIG5ldyBIc2woaCwgcywgbCwgby5vcGFjaXR5KTsKfQpmdW5jdGlvbiBoc2woaCwgcywgbCwgb3BhY2l0eSkgewogIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID09PSAxID8gaHNsQ29udmVydChoKSA6IG5ldyBIc2woaCwgcywgbCwgb3BhY2l0eSA9PSBudWxsID8gMSA6IG9wYWNpdHkpOwp9CmZ1bmN0aW9uIEhzbChoLCBzLCBsLCBvcGFjaXR5KSB7CiAgdGhpcy5oID0gK2g7CiAgdGhpcy5zID0gK3M7CiAgdGhpcy5sID0gK2w7CiAgdGhpcy5vcGFjaXR5ID0gK29wYWNpdHk7Cn0KZGVmaW5lX2RlZmF1bHQoSHNsLCBoc2wsIGV4dGVuZChDb2xvciwgewogIGJyaWdodGVyKGspIHsKICAgIGsgPSBrID09IG51bGwgPyBicmlnaHRlciA6IE1hdGgucG93KGJyaWdodGVyLCBrKTsKICAgIHJldHVybiBuZXcgSHNsKHRoaXMuaCwgdGhpcy5zLCB0aGlzLmwgKiBrLCB0aGlzLm9wYWNpdHkpOwogIH0sCiAgZGFya2VyKGspIHsKICAgIGsgPSBrID09IG51bGwgPyBkYXJrZXIgOiBNYXRoLnBvdyhkYXJrZXIsIGspOwogICAgcmV0dXJuIG5ldyBIc2wodGhpcy5oLCB0aGlzLnMsIHRoaXMubCAqIGssIHRoaXMub3BhY2l0eSk7CiAgfSwKICByZ2IoKSB7CiAgICB2YXIgaCA9IHRoaXMuaCAlIDM2MCArICh0aGlzLmggPCAwKSAqIDM2MCwgcyA9IGlzTmFOKGgpIHx8IGlzTmFOKHRoaXMucykgPyAwIDogdGhpcy5zLCBsID0gdGhpcy5sLCBtMiA9IGwgKyAobCA8IDAuNSA/IGwgOiAxIC0gbCkgKiBzLCBtMSA9IDIgKiBsIC0gbTI7CiAgICByZXR1cm4gbmV3IFJnYigKICAgICAgaHNsMnJnYihoID49IDI0MCA/IGggLSAyNDAgOiBoICsgMTIwLCBtMSwgbTIpLAogICAgICBoc2wycmdiKGgsIG0xLCBtMiksCiAgICAgIGhzbDJyZ2IoaCA8IDEyMCA/IGggKyAyNDAgOiBoIC0gMTIwLCBtMSwgbTIpLAogICAgICB0aGlzLm9wYWNpdHkKICAgICk7CiAgfSwKICBjbGFtcCgpIHsKICAgIHJldHVybiBuZXcgSHNsKGNsYW1waCh0aGlzLmgpLCBjbGFtcHQodGhpcy5zKSwgY2xhbXB0KHRoaXMubCksIGNsYW1wYSh0aGlzLm9wYWNpdHkpKTsKICB9LAogIGRpc3BsYXlhYmxlKCkgewogICAgcmV0dXJuICgwIDw9IHRoaXMucyAmJiB0aGlzLnMgPD0gMSB8fCBpc05hTih0aGlzLnMpKSAmJiAoMCA8PSB0aGlzLmwgJiYgdGhpcy5sIDw9IDEpICYmICgwIDw9IHRoaXMub3BhY2l0eSAmJiB0aGlzLm9wYWNpdHkgPD0gMSk7CiAgfSwKICBmb3JtYXRIc2woKSB7CiAgICBjb25zdCBhID0gY2xhbXBhKHRoaXMub3BhY2l0eSk7CiAgICByZXR1cm4gYCR7YSA9PT0gMSA/ICJoc2woIiA6ICJoc2xhKCJ9JHtjbGFtcGgodGhpcy5oKX0sICR7Y2xhbXB0KHRoaXMucykgKiAxMDB9JSwgJHtjbGFtcHQodGhpcy5sKSAqIDEwMH0lJHthID09PSAxID8gIikiIDogYCwgJHthfSlgfWA7CiAgfQp9KSk7CmZ1bmN0aW9uIGNsYW1waCh2YWx1ZSkgewogIHZhbHVlID0gKHZhbHVlIHx8IDApICUgMzYwOwogIHJldHVybiB2YWx1ZSA8IDAgPyB2YWx1ZSArIDM2MCA6IHZhbHVlOwp9CmZ1bmN0aW9uIGNsYW1wdCh2YWx1ZSkgewogIHJldHVybiBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCB2YWx1ZSB8fCAwKSk7Cn0KZnVuY3Rpb24gaHNsMnJnYihoLCBtMSwgbTIpIHsKICByZXR1cm4gKGggPCA2MCA/IG0xICsgKG0yIC0gbTEpICogaCAvIDYwIDogaCA8IDE4MCA/IG0yIDogaCA8IDI0MCA/IG0xICsgKG0yIC0gbTEpICogKDI0MCAtIGgpIC8gNjAgOiBtMSkgKiAyNTU7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1pbnRlcnBvbGF0ZUAzLjAuMS9ub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL2Jhc2lzLmpzCmZ1bmN0aW9uIGJhc2lzKHQxMiwgdjAsIHYxLCB2MiwgdjMpIHsKICB2YXIgdDIgPSB0MTIgKiB0MTIsIHQzID0gdDIgKiB0MTI7CiAgcmV0dXJuICgoMSAtIDMgKiB0MTIgKyAzICogdDIgLSB0MykgKiB2MCArICg0IC0gNiAqIHQyICsgMyAqIHQzKSAqIHYxICsgKDEgKyAzICogdDEyICsgMyAqIHQyIC0gMyAqIHQzKSAqIHYyICsgdDMgKiB2MykgLyA2Owp9CmZ1bmN0aW9uIGJhc2lzX2RlZmF1bHQyKHZhbHVlcykgewogIHZhciBuID0gdmFsdWVzLmxlbmd0aCAtIDE7CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHZhciBpID0gdCA8PSAwID8gdCA9IDAgOiB0ID49IDEgPyAodCA9IDEsIG4gLSAxKSA6IE1hdGguZmxvb3IodCAqIG4pLCB2MSA9IHZhbHVlc1tpXSwgdjIgPSB2YWx1ZXNbaSArIDFdLCB2MCA9IGkgPiAwID8gdmFsdWVzW2kgLSAxXSA6IDIgKiB2MSAtIHYyLCB2MyA9IGkgPCBuIC0gMSA/IHZhbHVlc1tpICsgMl0gOiAyICogdjIgLSB2MTsKICAgIHJldHVybiBiYXNpcygodCAtIGkgLyBuKSAqIG4sIHYwLCB2MSwgdjIsIHYzKTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9iYXNpc0Nsb3NlZC5qcwpmdW5jdGlvbiBiYXNpc0Nsb3NlZF9kZWZhdWx0Mih2YWx1ZXMpIHsKICB2YXIgbiA9IHZhbHVlcy5sZW5ndGg7CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHZhciBpID0gTWF0aC5mbG9vcigoKHQgJT0gMSkgPCAwID8gKyt0IDogdCkgKiBuKSwgdjAgPSB2YWx1ZXNbKGkgKyBuIC0gMSkgJSBuXSwgdjEgPSB2YWx1ZXNbaSAlIG5dLCB2MiA9IHZhbHVlc1soaSArIDEpICUgbl0sIHYzID0gdmFsdWVzWyhpICsgMikgJSBuXTsKICAgIHJldHVybiBiYXNpcygodCAtIGkgLyBuKSAqIG4sIHYwLCB2MSwgdjIsIHYzKTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9jb25zdGFudC5qcwp2YXIgY29uc3RhbnRfZGVmYXVsdDIgPSAoeDIpID0+ICgpID0+IHgyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWludGVycG9sYXRlQDMuMC4xL25vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvY29sb3IuanMKZnVuY3Rpb24gbGluZWFyKGEsIGQpIHsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgcmV0dXJuIGEgKyB0ICogZDsKICB9Owp9CmZ1bmN0aW9uIGV4cG9uZW50aWFsKGEsIGIsIHkyKSB7CiAgcmV0dXJuIGEgPSBNYXRoLnBvdyhhLCB5MiksIGIgPSBNYXRoLnBvdyhiLCB5MikgLSBhLCB5MiA9IDEgLyB5MiwgZnVuY3Rpb24odCkgewogICAgcmV0dXJuIE1hdGgucG93KGEgKyB0ICogYiwgeTIpOwogIH07Cn0KZnVuY3Rpb24gZ2FtbWEoeTIpIHsKICByZXR1cm4gKHkyID0gK3kyKSA9PT0gMSA/IG5vZ2FtbWEgOiBmdW5jdGlvbihhLCBiKSB7CiAgICByZXR1cm4gYiAtIGEgPyBleHBvbmVudGlhbChhLCBiLCB5MikgOiBjb25zdGFudF9kZWZhdWx0Mihpc05hTihhKSA/IGIgOiBhKTsKICB9Owp9CmZ1bmN0aW9uIG5vZ2FtbWEoYSwgYikgewogIHZhciBkID0gYiAtIGE7CiAgcmV0dXJuIGQgPyBsaW5lYXIoYSwgZCkgOiBjb25zdGFudF9kZWZhdWx0Mihpc05hTihhKSA/IGIgOiBhKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWludGVycG9sYXRlQDMuMC4xL25vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvcmdiLmpzCnZhciByZ2JfZGVmYXVsdCA9IGZ1bmN0aW9uIHJnYkdhbW1hKHkyKSB7CiAgdmFyIGNvbG9yMiA9IGdhbW1hKHkyKTsKICBmdW5jdGlvbiByZ2IyKHN0YXJ0LCBlbmQpIHsKICAgIHZhciByMiA9IGNvbG9yMigoc3RhcnQgPSByZ2Ioc3RhcnQpKS5yLCAoZW5kID0gcmdiKGVuZCkpLnIpLCBnID0gY29sb3IyKHN0YXJ0LmcsIGVuZC5nKSwgYiA9IGNvbG9yMihzdGFydC5iLCBlbmQuYiksIG9wYWNpdHkgPSBub2dhbW1hKHN0YXJ0Lm9wYWNpdHksIGVuZC5vcGFjaXR5KTsKICAgIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICAgIHN0YXJ0LnIgPSByMih0KTsKICAgICAgc3RhcnQuZyA9IGcodCk7CiAgICAgIHN0YXJ0LmIgPSBiKHQpOwogICAgICBzdGFydC5vcGFjaXR5ID0gb3BhY2l0eSh0KTsKICAgICAgcmV0dXJuIHN0YXJ0ICsgIiI7CiAgICB9OwogIH0KICByZ2IyLmdhbW1hID0gcmdiR2FtbWE7CiAgcmV0dXJuIHJnYjI7Cn0oMSk7CmZ1bmN0aW9uIHJnYlNwbGluZShzcGxpbmUpIHsKICByZXR1cm4gZnVuY3Rpb24oY29sb3JzKSB7CiAgICB2YXIgbiA9IGNvbG9ycy5sZW5ndGgsIHIyID0gbmV3IEFycmF5KG4pLCBnID0gbmV3IEFycmF5KG4pLCBiID0gbmV3IEFycmF5KG4pLCBpLCBjb2xvcjI7CiAgICBmb3IgKGkgPSAwOyBpIDwgbjsgKytpKSB7CiAgICAgIGNvbG9yMiA9IHJnYihjb2xvcnNbaV0pOwogICAgICByMltpXSA9IGNvbG9yMi5yIHx8IDA7CiAgICAgIGdbaV0gPSBjb2xvcjIuZyB8fCAwOwogICAgICBiW2ldID0gY29sb3IyLmIgfHwgMDsKICAgIH0KICAgIHIyID0gc3BsaW5lKHIyKTsKICAgIGcgPSBzcGxpbmUoZyk7CiAgICBiID0gc3BsaW5lKGIpOwogICAgY29sb3IyLm9wYWNpdHkgPSAxOwogICAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgICAgY29sb3IyLnIgPSByMih0KTsKICAgICAgY29sb3IyLmcgPSBnKHQpOwogICAgICBjb2xvcjIuYiA9IGIodCk7CiAgICAgIHJldHVybiBjb2xvcjIgKyAiIjsKICAgIH07CiAgfTsKfQp2YXIgcmdiQmFzaXMgPSByZ2JTcGxpbmUoYmFzaXNfZGVmYXVsdDIpOwp2YXIgcmdiQmFzaXNDbG9zZWQgPSByZ2JTcGxpbmUoYmFzaXNDbG9zZWRfZGVmYXVsdDIpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWludGVycG9sYXRlQDMuMC4xL25vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvbnVtYmVyQXJyYXkuanMKZnVuY3Rpb24gbnVtYmVyQXJyYXlfZGVmYXVsdChhLCBiKSB7CiAgaWYgKCFiKSBiID0gW107CiAgdmFyIG4gPSBhID8gTWF0aC5taW4oYi5sZW5ndGgsIGEubGVuZ3RoKSA6IDAsIGMgPSBiLnNsaWNlKCksIGk7CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIGZvciAoaSA9IDA7IGkgPCBuOyArK2kpIGNbaV0gPSBhW2ldICogKDEgLSB0KSArIGJbaV0gKiB0OwogICAgcmV0dXJuIGM7CiAgfTsKfQpmdW5jdGlvbiBpc051bWJlckFycmF5KHgyKSB7CiAgcmV0dXJuIEFycmF5QnVmZmVyLmlzVmlldyh4MikgJiYgISh4MiBpbnN0YW5jZW9mIERhdGFWaWV3KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWludGVycG9sYXRlQDMuMC4xL25vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvYXJyYXkuanMKZnVuY3Rpb24gZ2VuZXJpY0FycmF5KGEsIGIpIHsKICB2YXIgbmIgPSBiID8gYi5sZW5ndGggOiAwLCBuYSA9IGEgPyBNYXRoLm1pbihuYiwgYS5sZW5ndGgpIDogMCwgeDIgPSBuZXcgQXJyYXkobmEpLCBjID0gbmV3IEFycmF5KG5iKSwgaTsKICBmb3IgKGkgPSAwOyBpIDwgbmE7ICsraSkgeDJbaV0gPSB2YWx1ZV9kZWZhdWx0KGFbaV0sIGJbaV0pOwogIGZvciAoOyBpIDwgbmI7ICsraSkgY1tpXSA9IGJbaV07CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIGZvciAoaSA9IDA7IGkgPCBuYTsgKytpKSBjW2ldID0geDJbaV0odCk7CiAgICByZXR1cm4gYzsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9kYXRlLmpzCmZ1bmN0aW9uIGRhdGVfZGVmYXVsdChhLCBiKSB7CiAgdmFyIGQgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKTsKICByZXR1cm4gYSA9ICthLCBiID0gK2IsIGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiBkLnNldFRpbWUoYSAqICgxIC0gdCkgKyBiICogdCksIGQ7CiAgfTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWludGVycG9sYXRlQDMuMC4xL25vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvbnVtYmVyLmpzCmZ1bmN0aW9uIG51bWJlcl9kZWZhdWx0KGEsIGIpIHsKICByZXR1cm4gYSA9ICthLCBiID0gK2IsIGZ1bmN0aW9uKHQpIHsKICAgIHJldHVybiBhICogKDEgLSB0KSArIGIgKiB0OwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1pbnRlcnBvbGF0ZUAzLjAuMS9ub2RlX21vZHVsZXMvZDMtaW50ZXJwb2xhdGUvc3JjL29iamVjdC5qcwpmdW5jdGlvbiBvYmplY3RfZGVmYXVsdChhLCBiKSB7CiAgdmFyIGkgPSB7fSwgYyA9IHt9LCBrOwogIGlmIChhID09PSBudWxsIHx8IHR5cGVvZiBhICE9PSAib2JqZWN0IikgYSA9IHt9OwogIGlmIChiID09PSBudWxsIHx8IHR5cGVvZiBiICE9PSAib2JqZWN0IikgYiA9IHt9OwogIGZvciAoayBpbiBiKSB7CiAgICBpZiAoayBpbiBhKSB7CiAgICAgIGlba10gPSB2YWx1ZV9kZWZhdWx0KGFba10sIGJba10pOwogICAgfSBlbHNlIHsKICAgICAgY1trXSA9IGJba107CiAgICB9CiAgfQogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICBmb3IgKGsgaW4gaSkgY1trXSA9IGlba10odCk7CiAgICByZXR1cm4gYzsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9zdHJpbmcuanMKdmFyIHJlQSA9IC9bLStdPyg/OlxkK1wuP1xkKnxcLj9cZCspKD86W2VFXVstK10/XGQrKT8vZzsKdmFyIHJlQiA9IG5ldyBSZWdFeHAocmVBLnNvdXJjZSwgImciKTsKZnVuY3Rpb24gemVybzIoYikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBiOwogIH07Cn0KZnVuY3Rpb24gb25lKGIpIHsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgcmV0dXJuIGIodCkgKyAiIjsKICB9Owp9CmZ1bmN0aW9uIHN0cmluZ19kZWZhdWx0KGEsIGIpIHsKICB2YXIgYmkgPSByZUEubGFzdEluZGV4ID0gcmVCLmxhc3RJbmRleCA9IDAsIGFtLCBibSwgYnMsIGkgPSAtMSwgcyA9IFtdLCBxID0gW107CiAgYSA9IGEgKyAiIiwgYiA9IGIgKyAiIjsKICB3aGlsZSAoKGFtID0gcmVBLmV4ZWMoYSkpICYmIChibSA9IHJlQi5leGVjKGIpKSkgewogICAgaWYgKChicyA9IGJtLmluZGV4KSA+IGJpKSB7CiAgICAgIGJzID0gYi5zbGljZShiaSwgYnMpOwogICAgICBpZiAoc1tpXSkgc1tpXSArPSBiczsKICAgICAgZWxzZSBzWysraV0gPSBiczsKICAgIH0KICAgIGlmICgoYW0gPSBhbVswXSkgPT09IChibSA9IGJtWzBdKSkgewogICAgICBpZiAoc1tpXSkgc1tpXSArPSBibTsKICAgICAgZWxzZSBzWysraV0gPSBibTsKICAgIH0gZWxzZSB7CiAgICAgIHNbKytpXSA9IG51bGw7CiAgICAgIHEucHVzaCh7IGksIHg6IG51bWJlcl9kZWZhdWx0KGFtLCBibSkgfSk7CiAgICB9CiAgICBiaSA9IHJlQi5sYXN0SW5kZXg7CiAgfQogIGlmIChiaSA8IGIubGVuZ3RoKSB7CiAgICBicyA9IGIuc2xpY2UoYmkpOwogICAgaWYgKHNbaV0pIHNbaV0gKz0gYnM7CiAgICBlbHNlIHNbKytpXSA9IGJzOwogIH0KICByZXR1cm4gcy5sZW5ndGggPCAyID8gcVswXSA/IG9uZShxWzBdLngpIDogemVybzIoYikgOiAoYiA9IHEubGVuZ3RoLCBmdW5jdGlvbih0KSB7CiAgICBmb3IgKHZhciBpMiA9IDAsIG87IGkyIDwgYjsgKytpMikgc1sobyA9IHFbaTJdKS5pXSA9IG8ueCh0KTsKICAgIHJldHVybiBzLmpvaW4oIiIpOwogIH0pOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy92YWx1ZS5qcwpmdW5jdGlvbiB2YWx1ZV9kZWZhdWx0KGEsIGIpIHsKICB2YXIgdCA9IHR5cGVvZiBiLCBjOwogIHJldHVybiBiID09IG51bGwgfHwgdCA9PT0gImJvb2xlYW4iID8gY29uc3RhbnRfZGVmYXVsdDIoYikgOiAodCA9PT0gIm51bWJlciIgPyBudW1iZXJfZGVmYXVsdCA6IHQgPT09ICJzdHJpbmciID8gKGMgPSBjb2xvcihiKSkgPyAoYiA9IGMsIHJnYl9kZWZhdWx0KSA6IHN0cmluZ19kZWZhdWx0IDogYiBpbnN0YW5jZW9mIGNvbG9yID8gcmdiX2RlZmF1bHQgOiBiIGluc3RhbmNlb2YgRGF0ZSA/IGRhdGVfZGVmYXVsdCA6IGlzTnVtYmVyQXJyYXkoYikgPyBudW1iZXJBcnJheV9kZWZhdWx0IDogQXJyYXkuaXNBcnJheShiKSA/IGdlbmVyaWNBcnJheSA6IHR5cGVvZiBiLnZhbHVlT2YgIT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIGIudG9TdHJpbmcgIT09ICJmdW5jdGlvbiIgfHwgaXNOYU4oYikgPyBvYmplY3RfZGVmYXVsdCA6IG51bWJlcl9kZWZhdWx0KShhLCBiKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWludGVycG9sYXRlQDMuMC4xL25vZGVfbW9kdWxlcy9kMy1pbnRlcnBvbGF0ZS9zcmMvcm91bmQuanMKZnVuY3Rpb24gcm91bmRfZGVmYXVsdChhLCBiKSB7CiAgcmV0dXJuIGEgPSArYSwgYiA9ICtiLCBmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gTWF0aC5yb3VuZChhICogKDEgLSB0KSArIGIgKiB0KTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtaW50ZXJwb2xhdGVAMy4wLjEvbm9kZV9tb2R1bGVzL2QzLWludGVycG9sYXRlL3NyYy9waWVjZXdpc2UuanMKZnVuY3Rpb24gcGllY2V3aXNlKGludGVycG9sYXRlMiwgdmFsdWVzKSB7CiAgaWYgKHZhbHVlcyA9PT0gdm9pZCAwKSB2YWx1ZXMgPSBpbnRlcnBvbGF0ZTIsIGludGVycG9sYXRlMiA9IHZhbHVlX2RlZmF1bHQ7CiAgdmFyIGkgPSAwLCBuID0gdmFsdWVzLmxlbmd0aCAtIDEsIHYgPSB2YWx1ZXNbMF0sIEkgPSBuZXcgQXJyYXkobiA8IDAgPyAwIDogbik7CiAgd2hpbGUgKGkgPCBuKSBJW2ldID0gaW50ZXJwb2xhdGUyKHYsIHYgPSB2YWx1ZXNbKytpXSk7CiAgcmV0dXJuIGZ1bmN0aW9uKHQpIHsKICAgIHZhciBpMiA9IE1hdGgubWF4KDAsIE1hdGgubWluKG4gLSAxLCBNYXRoLmZsb29yKHQgKj0gbikpKTsKICAgIHJldHVybiBJW2kyXSh0IC0gaTIpOwogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2NvbnN0YW50LmpzCmZ1bmN0aW9uIGNvbnN0YW50cyh4MikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB4MjsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9udW1iZXIuanMKZnVuY3Rpb24gbnVtYmVyMih4MikgewogIHJldHVybiAreDI7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2NvbnRpbnVvdXMuanMKdmFyIHVuaXQgPSBbMCwgMV07CmZ1bmN0aW9uIGlkZW50aXR5KHgyKSB7CiAgcmV0dXJuIHgyOwp9CmZ1bmN0aW9uIG5vcm1hbGl6ZShhLCBiKSB7CiAgcmV0dXJuIChiIC09IGEgPSArYSkgPyBmdW5jdGlvbih4MikgewogICAgcmV0dXJuICh4MiAtIGEpIC8gYjsKICB9IDogY29uc3RhbnRzKGlzTmFOKGIpID8gTmFOIDogMC41KTsKfQpmdW5jdGlvbiBjbGFtcGVyKGEsIGIpIHsKICB2YXIgdDsKICBpZiAoYSA+IGIpIHQgPSBhLCBhID0gYiwgYiA9IHQ7CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4gTWF0aC5tYXgoYSwgTWF0aC5taW4oYiwgeDIpKTsKICB9Owp9CmZ1bmN0aW9uIGJpbWFwKGRvbWFpbiwgcmFuZ2U0LCBpbnRlcnBvbGF0ZTIpIHsKICB2YXIgZDAgPSBkb21haW5bMF0sIGQxID0gZG9tYWluWzFdLCByMCA9IHJhbmdlNFswXSwgcjEgPSByYW5nZTRbMV07CiAgaWYgKGQxIDwgZDApIGQwID0gbm9ybWFsaXplKGQxLCBkMCksIHIwID0gaW50ZXJwb2xhdGUyKHIxLCByMCk7CiAgZWxzZSBkMCA9IG5vcm1hbGl6ZShkMCwgZDEpLCByMCA9IGludGVycG9sYXRlMihyMCwgcjEpOwogIHJldHVybiBmdW5jdGlvbih4MikgewogICAgcmV0dXJuIHIwKGQwKHgyKSk7CiAgfTsKfQpmdW5jdGlvbiBwb2x5bWFwKGRvbWFpbiwgcmFuZ2U0LCBpbnRlcnBvbGF0ZTIpIHsKICB2YXIgaiA9IE1hdGgubWluKGRvbWFpbi5sZW5ndGgsIHJhbmdlNC5sZW5ndGgpIC0gMSwgZCA9IG5ldyBBcnJheShqKSwgcjIgPSBuZXcgQXJyYXkoaiksIGkgPSAtMTsKICBpZiAoZG9tYWluW2pdIDwgZG9tYWluWzBdKSB7CiAgICBkb21haW4gPSBkb21haW4uc2xpY2UoKS5yZXZlcnNlKCk7CiAgICByYW5nZTQgPSByYW5nZTQuc2xpY2UoKS5yZXZlcnNlKCk7CiAgfQogIHdoaWxlICgrK2kgPCBqKSB7CiAgICBkW2ldID0gbm9ybWFsaXplKGRvbWFpbltpXSwgZG9tYWluW2kgKyAxXSk7CiAgICByMltpXSA9IGludGVycG9sYXRlMihyYW5nZTRbaV0sIHJhbmdlNFtpICsgMV0pOwogIH0KICByZXR1cm4gZnVuY3Rpb24oeDIpIHsKICAgIHZhciBpMiA9IGJpc2VjdF9kZWZhdWx0KGRvbWFpbiwgeDIsIDEsIGopIC0gMTsKICAgIHJldHVybiByMltpMl0oZFtpMl0oeDIpKTsKICB9Owp9CmZ1bmN0aW9uIGNvcHkoc291cmNlLCB0YXJnZXQpIHsKICByZXR1cm4gdGFyZ2V0LmRvbWFpbihzb3VyY2UuZG9tYWluKCkpLnJhbmdlKHNvdXJjZS5yYW5nZSgpKS5pbnRlcnBvbGF0ZShzb3VyY2UuaW50ZXJwb2xhdGUoKSkuY2xhbXAoc291cmNlLmNsYW1wKCkpLnVua25vd24oc291cmNlLnVua25vd24oKSk7Cn0KZnVuY3Rpb24gdHJhbnNmb3JtZXIoKSB7CiAgdmFyIGRvbWFpbiA9IHVuaXQsIHJhbmdlNCA9IHVuaXQsIGludGVycG9sYXRlMiA9IHZhbHVlX2RlZmF1bHQsIHRyYW5zZm9ybSwgdW50cmFuc2Zvcm0sIHVua25vd24sIGNsYW1wID0gaWRlbnRpdHksIHBpZWNld2lzZTIsIG91dHB1dCwgaW5wdXQ7CiAgZnVuY3Rpb24gcmVzY2FsZSgpIHsKICAgIHZhciBuID0gTWF0aC5taW4oZG9tYWluLmxlbmd0aCwgcmFuZ2U0Lmxlbmd0aCk7CiAgICBpZiAoY2xhbXAgIT09IGlkZW50aXR5KSBjbGFtcCA9IGNsYW1wZXIoZG9tYWluWzBdLCBkb21haW5bbiAtIDFdKTsKICAgIHBpZWNld2lzZTIgPSBuID4gMiA/IHBvbHltYXAgOiBiaW1hcDsKICAgIG91dHB1dCA9IGlucHV0ID0gbnVsbDsKICAgIHJldHVybiBzY2FsZTsKICB9CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiA9PSBudWxsIHx8IGlzTmFOKHgyID0gK3gyKSA/IHVua25vd24gOiAob3V0cHV0IHx8IChvdXRwdXQgPSBwaWVjZXdpc2UyKGRvbWFpbi5tYXAodHJhbnNmb3JtKSwgcmFuZ2U0LCBpbnRlcnBvbGF0ZTIpKSkodHJhbnNmb3JtKGNsYW1wKHgyKSkpOwogIH0KICBzY2FsZS5pbnZlcnQgPSBmdW5jdGlvbih5MikgewogICAgcmV0dXJuIGNsYW1wKHVudHJhbnNmb3JtKChpbnB1dCB8fCAoaW5wdXQgPSBwaWVjZXdpc2UyKHJhbmdlNCwgZG9tYWluLm1hcCh0cmFuc2Zvcm0pLCBudW1iZXJfZGVmYXVsdCkpKSh5MikpKTsKICB9OwogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRvbWFpbiA9IEFycmF5LmZyb20oXywgbnVtYmVyMiksIHJlc2NhbGUoKSkgOiBkb21haW4uc2xpY2UoKTsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocmFuZ2U0ID0gQXJyYXkuZnJvbShfKSwgcmVzY2FsZSgpKSA6IHJhbmdlNC5zbGljZSgpOwogIH07CiAgc2NhbGUucmFuZ2VSb3VuZCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiByYW5nZTQgPSBBcnJheS5mcm9tKF8pLCBpbnRlcnBvbGF0ZTIgPSByb3VuZF9kZWZhdWx0LCByZXNjYWxlKCk7CiAgfTsKICBzY2FsZS5jbGFtcCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGNsYW1wID0gXyA/IHRydWUgOiBpZGVudGl0eSwgcmVzY2FsZSgpKSA6IGNsYW1wICE9PSBpZGVudGl0eTsKICB9OwogIHNjYWxlLmludGVycG9sYXRlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoaW50ZXJwb2xhdGUyID0gXywgcmVzY2FsZSgpKSA6IGludGVycG9sYXRlMjsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHJldHVybiBmdW5jdGlvbih0LCB1KSB7CiAgICB0cmFuc2Zvcm0gPSB0LCB1bnRyYW5zZm9ybSA9IHU7CiAgICByZXR1cm4gcmVzY2FsZSgpOwogIH07Cn0KZnVuY3Rpb24gY29udGludW91cygpIHsKICByZXR1cm4gdHJhbnNmb3JtZXIoKShpZGVudGl0eSwgaWRlbnRpdHkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdERlY2ltYWwuanMKZnVuY3Rpb24gZm9ybWF0RGVjaW1hbF9kZWZhdWx0KHgyKSB7CiAgcmV0dXJuIE1hdGguYWJzKHgyID0gTWF0aC5yb3VuZCh4MikpID49IDFlMjEgPyB4Mi50b0xvY2FsZVN0cmluZygiZW4iKS5yZXBsYWNlKC8sL2csICIiKSA6IHgyLnRvU3RyaW5nKDEwKTsKfQpmdW5jdGlvbiBmb3JtYXREZWNpbWFsUGFydHMoeDIsIHApIHsKICBpZiAoKGkgPSAoeDIgPSBwID8geDIudG9FeHBvbmVudGlhbChwIC0gMSkgOiB4Mi50b0V4cG9uZW50aWFsKCkpLmluZGV4T2YoImUiKSkgPCAwKSByZXR1cm4gbnVsbDsKICB2YXIgaSwgY29lZmZpY2llbnQgPSB4Mi5zbGljZSgwLCBpKTsKICByZXR1cm4gWwogICAgY29lZmZpY2llbnQubGVuZ3RoID4gMSA/IGNvZWZmaWNpZW50WzBdICsgY29lZmZpY2llbnQuc2xpY2UoMikgOiBjb2VmZmljaWVudCwKICAgICt4Mi5zbGljZShpICsgMSkKICBdOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2V4cG9uZW50LmpzCmZ1bmN0aW9uIGV4cG9uZW50X2RlZmF1bHQoeDIpIHsKICByZXR1cm4geDIgPSBmb3JtYXREZWNpbWFsUGFydHMoTWF0aC5hYnMoeDIpKSwgeDIgPyB4MlsxXSA6IE5hTjsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWZvcm1hdEAzLjEuMC9ub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXRHcm91cC5qcwpmdW5jdGlvbiBmb3JtYXRHcm91cF9kZWZhdWx0KGdyb3VwaW5nLCB0aG91c2FuZHMpIHsKICByZXR1cm4gZnVuY3Rpb24odmFsdWUsIHdpZHRoKSB7CiAgICB2YXIgaSA9IHZhbHVlLmxlbmd0aCwgdCA9IFtdLCBqID0gMCwgZyA9IGdyb3VwaW5nWzBdLCBsZW5ndGggPSAwOwogICAgd2hpbGUgKGkgPiAwICYmIGcgPiAwKSB7CiAgICAgIGlmIChsZW5ndGggKyBnICsgMSA+IHdpZHRoKSBnID0gTWF0aC5tYXgoMSwgd2lkdGggLSBsZW5ndGgpOwogICAgICB0LnB1c2godmFsdWUuc3Vic3RyaW5nKGkgLT0gZywgaSArIGcpKTsKICAgICAgaWYgKChsZW5ndGggKz0gZyArIDEpID4gd2lkdGgpIGJyZWFrOwogICAgICBnID0gZ3JvdXBpbmdbaiA9IChqICsgMSkgJSBncm91cGluZy5sZW5ndGhdOwogICAgfQogICAgcmV0dXJuIHQucmV2ZXJzZSgpLmpvaW4odGhvdXNhbmRzKTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdE51bWVyYWxzLmpzCmZ1bmN0aW9uIGZvcm1hdE51bWVyYWxzX2RlZmF1bHQobnVtZXJhbHMpIHsKICByZXR1cm4gZnVuY3Rpb24odmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZS5yZXBsYWNlKC9bMC05XS9nLCBmdW5jdGlvbihpKSB7CiAgICAgIHJldHVybiBudW1lcmFsc1sraV07CiAgICB9KTsKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdFNwZWNpZmllci5qcwp2YXIgcmUgPSAvXig/OiguKT8oWzw+PV5dKSk/KFsrXC0oIF0pPyhbJCNdKT8oMCk/KFxkKyk/KCwpPyhcLlxkKyk/KH4pPyhbYS16JV0pPyQvaTsKZnVuY3Rpb24gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllcikgewogIGlmICghKG1hdGNoID0gcmUuZXhlYyhzcGVjaWZpZXIpKSkgdGhyb3cgbmV3IEVycm9yKCJpbnZhbGlkIGZvcm1hdDogIiArIHNwZWNpZmllcik7CiAgdmFyIG1hdGNoOwogIHJldHVybiBuZXcgRm9ybWF0U3BlY2lmaWVyKHsKICAgIGZpbGw6IG1hdGNoWzFdLAogICAgYWxpZ246IG1hdGNoWzJdLAogICAgc2lnbjogbWF0Y2hbM10sCiAgICBzeW1ib2w6IG1hdGNoWzRdLAogICAgemVybzogbWF0Y2hbNV0sCiAgICB3aWR0aDogbWF0Y2hbNl0sCiAgICBjb21tYTogbWF0Y2hbN10sCiAgICBwcmVjaXNpb246IG1hdGNoWzhdICYmIG1hdGNoWzhdLnNsaWNlKDEpLAogICAgdHJpbTogbWF0Y2hbOV0sCiAgICB0eXBlOiBtYXRjaFsxMF0KICB9KTsKfQpmb3JtYXRTcGVjaWZpZXIucHJvdG90eXBlID0gRm9ybWF0U3BlY2lmaWVyLnByb3RvdHlwZTsKZnVuY3Rpb24gRm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllcikgewogIHRoaXMuZmlsbCA9IHNwZWNpZmllci5maWxsID09PSB2b2lkIDAgPyAiICIgOiBzcGVjaWZpZXIuZmlsbCArICIiOwogIHRoaXMuYWxpZ24gPSBzcGVjaWZpZXIuYWxpZ24gPT09IHZvaWQgMCA/ICI+IiA6IHNwZWNpZmllci5hbGlnbiArICIiOwogIHRoaXMuc2lnbiA9IHNwZWNpZmllci5zaWduID09PSB2b2lkIDAgPyAiLSIgOiBzcGVjaWZpZXIuc2lnbiArICIiOwogIHRoaXMuc3ltYm9sID0gc3BlY2lmaWVyLnN5bWJvbCA9PT0gdm9pZCAwID8gIiIgOiBzcGVjaWZpZXIuc3ltYm9sICsgIiI7CiAgdGhpcy56ZXJvID0gISFzcGVjaWZpZXIuemVybzsKICB0aGlzLndpZHRoID0gc3BlY2lmaWVyLndpZHRoID09PSB2b2lkIDAgPyB2b2lkIDAgOiArc3BlY2lmaWVyLndpZHRoOwogIHRoaXMuY29tbWEgPSAhIXNwZWNpZmllci5jb21tYTsKICB0aGlzLnByZWNpc2lvbiA9IHNwZWNpZmllci5wcmVjaXNpb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6ICtzcGVjaWZpZXIucHJlY2lzaW9uOwogIHRoaXMudHJpbSA9ICEhc3BlY2lmaWVyLnRyaW07CiAgdGhpcy50eXBlID0gc3BlY2lmaWVyLnR5cGUgPT09IHZvaWQgMCA/ICIiIDogc3BlY2lmaWVyLnR5cGUgKyAiIjsKfQpGb3JtYXRTcGVjaWZpZXIucHJvdG90eXBlLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgcmV0dXJuIHRoaXMuZmlsbCArIHRoaXMuYWxpZ24gKyB0aGlzLnNpZ24gKyB0aGlzLnN5bWJvbCArICh0aGlzLnplcm8gPyAiMCIgOiAiIikgKyAodGhpcy53aWR0aCA9PT0gdm9pZCAwID8gIiIgOiBNYXRoLm1heCgxLCB0aGlzLndpZHRoIHwgMCkpICsgKHRoaXMuY29tbWEgPyAiLCIgOiAiIikgKyAodGhpcy5wcmVjaXNpb24gPT09IHZvaWQgMCA/ICIiIDogIi4iICsgTWF0aC5tYXgoMCwgdGhpcy5wcmVjaXNpb24gfCAwKSkgKyAodGhpcy50cmltID8gIn4iIDogIiIpICsgdGhpcy50eXBlOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWZvcm1hdEAzLjEuMC9ub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXRUcmltLmpzCmZ1bmN0aW9uIGZvcm1hdFRyaW1fZGVmYXVsdChzKSB7CiAgb3V0OiBmb3IgKHZhciBuID0gcy5sZW5ndGgsIGkgPSAxLCBpMCA9IC0xLCBpMTsgaSA8IG47ICsraSkgewogICAgc3dpdGNoIChzW2ldKSB7CiAgICAgIGNhc2UgIi4iOgogICAgICAgIGkwID0gaTEgPSBpOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICIwIjoKICAgICAgICBpZiAoaTAgPT09IDApIGkwID0gaTsKICAgICAgICBpMSA9IGk7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgaWYgKCErc1tpXSkgYnJlYWsgb3V0OwogICAgICAgIGlmIChpMCA+IDApIGkwID0gMDsKICAgICAgICBicmVhazsKICAgIH0KICB9CiAgcmV0dXJuIGkwID4gMCA/IHMuc2xpY2UoMCwgaTApICsgcy5zbGljZShpMSArIDEpIDogczsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWZvcm1hdEAzLjEuMC9ub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9mb3JtYXRQcmVmaXhBdXRvLmpzCnZhciBwcmVmaXhFeHBvbmVudDsKZnVuY3Rpb24gZm9ybWF0UHJlZml4QXV0b19kZWZhdWx0KHgyLCBwKSB7CiAgdmFyIGQgPSBmb3JtYXREZWNpbWFsUGFydHMoeDIsIHApOwogIGlmICghZCkgcmV0dXJuIHgyICsgIiI7CiAgdmFyIGNvZWZmaWNpZW50ID0gZFswXSwgZXhwb25lbnQgPSBkWzFdLCBpID0gZXhwb25lbnQgLSAocHJlZml4RXhwb25lbnQgPSBNYXRoLm1heCgtOCwgTWF0aC5taW4oOCwgTWF0aC5mbG9vcihleHBvbmVudCAvIDMpKSkgKiAzKSArIDEsIG4gPSBjb2VmZmljaWVudC5sZW5ndGg7CiAgcmV0dXJuIGkgPT09IG4gPyBjb2VmZmljaWVudCA6IGkgPiBuID8gY29lZmZpY2llbnQgKyBuZXcgQXJyYXkoaSAtIG4gKyAxKS5qb2luKCIwIikgOiBpID4gMCA/IGNvZWZmaWNpZW50LnNsaWNlKDAsIGkpICsgIi4iICsgY29lZmZpY2llbnQuc2xpY2UoaSkgOiAiMC4iICsgbmV3IEFycmF5KDEgLSBpKS5qb2luKCIwIikgKyBmb3JtYXREZWNpbWFsUGFydHMoeDIsIE1hdGgubWF4KDAsIHAgKyBpIC0gMSkpWzBdOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdFJvdW5kZWQuanMKZnVuY3Rpb24gZm9ybWF0Um91bmRlZF9kZWZhdWx0KHgyLCBwKSB7CiAgdmFyIGQgPSBmb3JtYXREZWNpbWFsUGFydHMoeDIsIHApOwogIGlmICghZCkgcmV0dXJuIHgyICsgIiI7CiAgdmFyIGNvZWZmaWNpZW50ID0gZFswXSwgZXhwb25lbnQgPSBkWzFdOwogIHJldHVybiBleHBvbmVudCA8IDAgPyAiMC4iICsgbmV3IEFycmF5KC1leHBvbmVudCkuam9pbigiMCIpICsgY29lZmZpY2llbnQgOiBjb2VmZmljaWVudC5sZW5ndGggPiBleHBvbmVudCArIDEgPyBjb2VmZmljaWVudC5zbGljZSgwLCBleHBvbmVudCArIDEpICsgIi4iICsgY29lZmZpY2llbnQuc2xpY2UoZXhwb25lbnQgKyAxKSA6IGNvZWZmaWNpZW50ICsgbmV3IEFycmF5KGV4cG9uZW50IC0gY29lZmZpY2llbnQubGVuZ3RoICsgMikuam9pbigiMCIpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2Zvcm1hdFR5cGVzLmpzCnZhciBmb3JtYXRUeXBlc19kZWZhdWx0ID0gewogICIlIjogKHgyLCBwKSA9PiAoeDIgKiAxMDApLnRvRml4ZWQocCksCiAgImIiOiAoeDIpID0+IE1hdGgucm91bmQoeDIpLnRvU3RyaW5nKDIpLAogICJjIjogKHgyKSA9PiB4MiArICIiLAogICJkIjogZm9ybWF0RGVjaW1hbF9kZWZhdWx0LAogICJlIjogKHgyLCBwKSA9PiB4Mi50b0V4cG9uZW50aWFsKHApLAogICJmIjogKHgyLCBwKSA9PiB4Mi50b0ZpeGVkKHApLAogICJnIjogKHgyLCBwKSA9PiB4Mi50b1ByZWNpc2lvbihwKSwKICAibyI6ICh4MikgPT4gTWF0aC5yb3VuZCh4MikudG9TdHJpbmcoOCksCiAgInAiOiAoeDIsIHApID0+IGZvcm1hdFJvdW5kZWRfZGVmYXVsdCh4MiAqIDEwMCwgcCksCiAgInIiOiBmb3JtYXRSb3VuZGVkX2RlZmF1bHQsCiAgInMiOiBmb3JtYXRQcmVmaXhBdXRvX2RlZmF1bHQsCiAgIlgiOiAoeDIpID0+IE1hdGgucm91bmQoeDIpLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpLAogICJ4IjogKHgyKSA9PiBNYXRoLnJvdW5kKHgyKS50b1N0cmluZygxNikKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1mb3JtYXRAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLWZvcm1hdC9zcmMvaWRlbnRpdHkuanMKZnVuY3Rpb24gaWRlbnRpdHlfZGVmYXVsdCh4MikgewogIHJldHVybiB4MjsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWZvcm1hdEAzLjEuMC9ub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9sb2NhbGUuanMKdmFyIG1hcCA9IEFycmF5LnByb3RvdHlwZS5tYXA7CnZhciBwcmVmaXhlcyA9IFsieSIsICJ6IiwgImEiLCAiZiIsICJwIiwgIm4iLCAiXHhCNSIsICJtIiwgIiIsICJrIiwgIk0iLCAiRyIsICJUIiwgIlAiLCAiRSIsICJaIiwgIlkiXTsKZnVuY3Rpb24gbG9jYWxlX2RlZmF1bHQobG9jYWxlMykgewogIHZhciBncm91cCA9IGxvY2FsZTMuZ3JvdXBpbmcgPT09IHZvaWQgMCB8fCBsb2NhbGUzLnRob3VzYW5kcyA9PT0gdm9pZCAwID8gaWRlbnRpdHlfZGVmYXVsdCA6IGZvcm1hdEdyb3VwX2RlZmF1bHQobWFwLmNhbGwobG9jYWxlMy5ncm91cGluZywgTnVtYmVyKSwgbG9jYWxlMy50aG91c2FuZHMgKyAiIiksIGN1cnJlbmN5UHJlZml4ID0gbG9jYWxlMy5jdXJyZW5jeSA9PT0gdm9pZCAwID8gIiIgOiBsb2NhbGUzLmN1cnJlbmN5WzBdICsgIiIsIGN1cnJlbmN5U3VmZml4ID0gbG9jYWxlMy5jdXJyZW5jeSA9PT0gdm9pZCAwID8gIiIgOiBsb2NhbGUzLmN1cnJlbmN5WzFdICsgIiIsIGRlY2ltYWwgPSBsb2NhbGUzLmRlY2ltYWwgPT09IHZvaWQgMCA/ICIuIiA6IGxvY2FsZTMuZGVjaW1hbCArICIiLCBudW1lcmFscyA9IGxvY2FsZTMubnVtZXJhbHMgPT09IHZvaWQgMCA/IGlkZW50aXR5X2RlZmF1bHQgOiBmb3JtYXROdW1lcmFsc19kZWZhdWx0KG1hcC5jYWxsKGxvY2FsZTMubnVtZXJhbHMsIFN0cmluZykpLCBwZXJjZW50ID0gbG9jYWxlMy5wZXJjZW50ID09PSB2b2lkIDAgPyAiJSIgOiBsb2NhbGUzLnBlcmNlbnQgKyAiIiwgbWludXMgPSBsb2NhbGUzLm1pbnVzID09PSB2b2lkIDAgPyAiXHUyMjEyIiA6IGxvY2FsZTMubWludXMgKyAiIiwgbmFuID0gbG9jYWxlMy5uYW4gPT09IHZvaWQgMCA/ICJOYU4iIDogbG9jYWxlMy5uYW4gKyAiIjsKICBmdW5jdGlvbiBuZXdGb3JtYXQoc3BlY2lmaWVyKSB7CiAgICBzcGVjaWZpZXIgPSBmb3JtYXRTcGVjaWZpZXIoc3BlY2lmaWVyKTsKICAgIHZhciBmaWxsID0gc3BlY2lmaWVyLmZpbGwsIGFsaWduID0gc3BlY2lmaWVyLmFsaWduLCBzaWduMiA9IHNwZWNpZmllci5zaWduLCBzeW1ib2wgPSBzcGVjaWZpZXIuc3ltYm9sLCB6ZXJvMyA9IHNwZWNpZmllci56ZXJvLCB3aWR0aCA9IHNwZWNpZmllci53aWR0aCwgY29tbWEgPSBzcGVjaWZpZXIuY29tbWEsIHByZWNpc2lvbiA9IHNwZWNpZmllci5wcmVjaXNpb24sIHRyaW0gPSBzcGVjaWZpZXIudHJpbSwgdHlwZSA9IHNwZWNpZmllci50eXBlOwogICAgaWYgKHR5cGUgPT09ICJuIikgY29tbWEgPSB0cnVlLCB0eXBlID0gImciOwogICAgZWxzZSBpZiAoIWZvcm1hdFR5cGVzX2RlZmF1bHRbdHlwZV0pIHByZWNpc2lvbiA9PT0gdm9pZCAwICYmIChwcmVjaXNpb24gPSAxMiksIHRyaW0gPSB0cnVlLCB0eXBlID0gImciOwogICAgaWYgKHplcm8zIHx8IGZpbGwgPT09ICIwIiAmJiBhbGlnbiA9PT0gIj0iKSB6ZXJvMyA9IHRydWUsIGZpbGwgPSAiMCIsIGFsaWduID0gIj0iOwogICAgdmFyIHByZWZpeCA9IHN5bWJvbCA9PT0gIiQiID8gY3VycmVuY3lQcmVmaXggOiBzeW1ib2wgPT09ICIjIiAmJiAvW2JveFhdLy50ZXN0KHR5cGUpID8gIjAiICsgdHlwZS50b0xvd2VyQ2FzZSgpIDogIiIsIHN1ZmZpeDIgPSBzeW1ib2wgPT09ICIkIiA/IGN1cnJlbmN5U3VmZml4IDogL1slcF0vLnRlc3QodHlwZSkgPyBwZXJjZW50IDogIiI7CiAgICB2YXIgZm9ybWF0VHlwZSA9IGZvcm1hdFR5cGVzX2RlZmF1bHRbdHlwZV0sIG1heWJlU3VmZml4ID0gL1tkZWZncHJzJV0vLnRlc3QodHlwZSk7CiAgICBwcmVjaXNpb24gPSBwcmVjaXNpb24gPT09IHZvaWQgMCA/IDYgOiAvW2dwcnNdLy50ZXN0KHR5cGUpID8gTWF0aC5tYXgoMSwgTWF0aC5taW4oMjEsIHByZWNpc2lvbikpIDogTWF0aC5tYXgoMCwgTWF0aC5taW4oMjAsIHByZWNpc2lvbikpOwogICAgZnVuY3Rpb24gZm9ybWF0Mih2YWx1ZSkgewogICAgICB2YXIgdmFsdWVQcmVmaXggPSBwcmVmaXgsIHZhbHVlU3VmZml4ID0gc3VmZml4MiwgaSwgbiwgYzsKICAgICAgaWYgKHR5cGUgPT09ICJjIikgewogICAgICAgIHZhbHVlU3VmZml4ID0gZm9ybWF0VHlwZSh2YWx1ZSkgKyB2YWx1ZVN1ZmZpeDsKICAgICAgICB2YWx1ZSA9ICIiOwogICAgICB9IGVsc2UgewogICAgICAgIHZhbHVlID0gK3ZhbHVlOwogICAgICAgIHZhciB2YWx1ZU5lZ2F0aXZlID0gdmFsdWUgPCAwIHx8IDEgLyB2YWx1ZSA8IDA7CiAgICAgICAgdmFsdWUgPSBpc05hTih2YWx1ZSkgPyBuYW4gOiBmb3JtYXRUeXBlKE1hdGguYWJzKHZhbHVlKSwgcHJlY2lzaW9uKTsKICAgICAgICBpZiAodHJpbSkgdmFsdWUgPSBmb3JtYXRUcmltX2RlZmF1bHQodmFsdWUpOwogICAgICAgIGlmICh2YWx1ZU5lZ2F0aXZlICYmICt2YWx1ZSA9PT0gMCAmJiBzaWduMiAhPT0gIisiKSB2YWx1ZU5lZ2F0aXZlID0gZmFsc2U7CiAgICAgICAgdmFsdWVQcmVmaXggPSAodmFsdWVOZWdhdGl2ZSA/IHNpZ24yID09PSAiKCIgPyBzaWduMiA6IG1pbnVzIDogc2lnbjIgPT09ICItIiB8fCBzaWduMiA9PT0gIigiID8gIiIgOiBzaWduMikgKyB2YWx1ZVByZWZpeDsKICAgICAgICB2YWx1ZVN1ZmZpeCA9ICh0eXBlID09PSAicyIgPyBwcmVmaXhlc1s4ICsgcHJlZml4RXhwb25lbnQgLyAzXSA6ICIiKSArIHZhbHVlU3VmZml4ICsgKHZhbHVlTmVnYXRpdmUgJiYgc2lnbjIgPT09ICIoIiA/ICIpIiA6ICIiKTsKICAgICAgICBpZiAobWF5YmVTdWZmaXgpIHsKICAgICAgICAgIGkgPSAtMSwgbiA9IHZhbHVlLmxlbmd0aDsKICAgICAgICAgIHdoaWxlICgrK2kgPCBuKSB7CiAgICAgICAgICAgIGlmIChjID0gdmFsdWUuY2hhckNvZGVBdChpKSwgNDggPiBjIHx8IGMgPiA1NykgewogICAgICAgICAgICAgIHZhbHVlU3VmZml4ID0gKGMgPT09IDQ2ID8gZGVjaW1hbCArIHZhbHVlLnNsaWNlKGkgKyAxKSA6IHZhbHVlLnNsaWNlKGkpKSArIHZhbHVlU3VmZml4OwogICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuc2xpY2UoMCwgaSk7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGNvbW1hICYmICF6ZXJvMykgdmFsdWUgPSBncm91cCh2YWx1ZSwgSW5maW5pdHkpOwogICAgICB2YXIgbGVuZ3RoID0gdmFsdWVQcmVmaXgubGVuZ3RoICsgdmFsdWUubGVuZ3RoICsgdmFsdWVTdWZmaXgubGVuZ3RoLCBwYWRkaW5nID0gbGVuZ3RoIDwgd2lkdGggPyBuZXcgQXJyYXkod2lkdGggLSBsZW5ndGggKyAxKS5qb2luKGZpbGwpIDogIiI7CiAgICAgIGlmIChjb21tYSAmJiB6ZXJvMykgdmFsdWUgPSBncm91cChwYWRkaW5nICsgdmFsdWUsIHBhZGRpbmcubGVuZ3RoID8gd2lkdGggLSB2YWx1ZVN1ZmZpeC5sZW5ndGggOiBJbmZpbml0eSksIHBhZGRpbmcgPSAiIjsKICAgICAgc3dpdGNoIChhbGlnbikgewogICAgICAgIGNhc2UgIjwiOgogICAgICAgICAgdmFsdWUgPSB2YWx1ZVByZWZpeCArIHZhbHVlICsgdmFsdWVTdWZmaXggKyBwYWRkaW5nOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAiPSI6CiAgICAgICAgICB2YWx1ZSA9IHZhbHVlUHJlZml4ICsgcGFkZGluZyArIHZhbHVlICsgdmFsdWVTdWZmaXg7CiAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICJeIjoKICAgICAgICAgIHZhbHVlID0gcGFkZGluZy5zbGljZSgwLCBsZW5ndGggPSBwYWRkaW5nLmxlbmd0aCA+PiAxKSArIHZhbHVlUHJlZml4ICsgdmFsdWUgKyB2YWx1ZVN1ZmZpeCArIHBhZGRpbmcuc2xpY2UobGVuZ3RoKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICB2YWx1ZSA9IHBhZGRpbmcgKyB2YWx1ZVByZWZpeCArIHZhbHVlICsgdmFsdWVTdWZmaXg7CiAgICAgICAgICBicmVhazsKICAgICAgfQogICAgICByZXR1cm4gbnVtZXJhbHModmFsdWUpOwogICAgfQogICAgZm9ybWF0Mi50b1N0cmluZyA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gc3BlY2lmaWVyICsgIiI7CiAgICB9OwogICAgcmV0dXJuIGZvcm1hdDI7CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFByZWZpeDIoc3BlY2lmaWVyLCB2YWx1ZSkgewogICAgdmFyIGYgPSBuZXdGb3JtYXQoKHNwZWNpZmllciA9IGZvcm1hdFNwZWNpZmllcihzcGVjaWZpZXIpLCBzcGVjaWZpZXIudHlwZSA9ICJmIiwgc3BlY2lmaWVyKSksIGUgPSBNYXRoLm1heCgtOCwgTWF0aC5taW4oOCwgTWF0aC5mbG9vcihleHBvbmVudF9kZWZhdWx0KHZhbHVlKSAvIDMpKSkgKiAzLCBrID0gTWF0aC5wb3coMTAsIC1lKSwgcHJlZml4ID0gcHJlZml4ZXNbOCArIGUgLyAzXTsKICAgIHJldHVybiBmdW5jdGlvbih2YWx1ZTIpIHsKICAgICAgcmV0dXJuIGYoayAqIHZhbHVlMikgKyBwcmVmaXg7CiAgICB9OwogIH0KICByZXR1cm4gewogICAgZm9ybWF0OiBuZXdGb3JtYXQsCiAgICBmb3JtYXRQcmVmaXg6IGZvcm1hdFByZWZpeDIKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtZm9ybWF0QDMuMS4wL25vZGVfbW9kdWxlcy9kMy1mb3JtYXQvc3JjL2RlZmF1bHRMb2NhbGUuanMKdmFyIGxvY2FsZTsKdmFyIGZvcm1hdDsKdmFyIGZvcm1hdFByZWZpeDsKZGVmYXVsdExvY2FsZSh7CiAgdGhvdXNhbmRzOiAiLCIsCiAgZ3JvdXBpbmc6IFszXSwKICBjdXJyZW5jeTogWyIkIiwgIiJdCn0pOwpmdW5jdGlvbiBkZWZhdWx0TG9jYWxlKGRlZmluaXRpb24pIHsKICBsb2NhbGUgPSBsb2NhbGVfZGVmYXVsdChkZWZpbml0aW9uKTsKICBmb3JtYXQgPSBsb2NhbGUuZm9ybWF0OwogIGZvcm1hdFByZWZpeCA9IGxvY2FsZS5mb3JtYXRQcmVmaXg7CiAgcmV0dXJuIGxvY2FsZTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWZvcm1hdEAzLjEuMC9ub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9wcmVjaXNpb25GaXhlZC5qcwpmdW5jdGlvbiBwcmVjaXNpb25GaXhlZF9kZWZhdWx0KHN0ZXApIHsKICByZXR1cm4gTWF0aC5tYXgoMCwgLWV4cG9uZW50X2RlZmF1bHQoTWF0aC5hYnMoc3RlcCkpKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWZvcm1hdEAzLjEuMC9ub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9wcmVjaXNpb25QcmVmaXguanMKZnVuY3Rpb24gcHJlY2lzaW9uUHJlZml4X2RlZmF1bHQoc3RlcCwgdmFsdWUpIHsKICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5tYXgoLTgsIE1hdGgubWluKDgsIE1hdGguZmxvb3IoZXhwb25lbnRfZGVmYXVsdCh2YWx1ZSkgLyAzKSkpICogMyAtIGV4cG9uZW50X2RlZmF1bHQoTWF0aC5hYnMoc3RlcCkpKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLWZvcm1hdEAzLjEuMC9ub2RlX21vZHVsZXMvZDMtZm9ybWF0L3NyYy9wcmVjaXNpb25Sb3VuZC5qcwpmdW5jdGlvbiBwcmVjaXNpb25Sb3VuZF9kZWZhdWx0KHN0ZXAsIG1heDIpIHsKICBzdGVwID0gTWF0aC5hYnMoc3RlcCksIG1heDIgPSBNYXRoLmFicyhtYXgyKSAtIHN0ZXA7CiAgcmV0dXJuIE1hdGgubWF4KDAsIGV4cG9uZW50X2RlZmF1bHQobWF4MikgLSBleHBvbmVudF9kZWZhdWx0KHN0ZXApKSArIDE7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3RpY2tGb3JtYXQuanMKZnVuY3Rpb24gdGlja0Zvcm1hdChzdGFydCwgc3RvcCwgY291bnQsIHNwZWNpZmllcikgewogIHZhciBzdGVwID0gdGlja1N0ZXAoc3RhcnQsIHN0b3AsIGNvdW50KSwgcHJlY2lzaW9uOwogIHNwZWNpZmllciA9IGZvcm1hdFNwZWNpZmllcihzcGVjaWZpZXIgPT0gbnVsbCA/ICIsZiIgOiBzcGVjaWZpZXIpOwogIHN3aXRjaCAoc3BlY2lmaWVyLnR5cGUpIHsKICAgIGNhc2UgInMiOiB7CiAgICAgIHZhciB2YWx1ZSA9IE1hdGgubWF4KE1hdGguYWJzKHN0YXJ0KSwgTWF0aC5hYnMoc3RvcCkpOwogICAgICBpZiAoc3BlY2lmaWVyLnByZWNpc2lvbiA9PSBudWxsICYmICFpc05hTihwcmVjaXNpb24gPSBwcmVjaXNpb25QcmVmaXhfZGVmYXVsdChzdGVwLCB2YWx1ZSkpKSBzcGVjaWZpZXIucHJlY2lzaW9uID0gcHJlY2lzaW9uOwogICAgICByZXR1cm4gZm9ybWF0UHJlZml4KHNwZWNpZmllciwgdmFsdWUpOwogICAgfQogICAgY2FzZSAiIjoKICAgIGNhc2UgImUiOgogICAgY2FzZSAiZyI6CiAgICBjYXNlICJwIjoKICAgIGNhc2UgInIiOiB7CiAgICAgIGlmIChzcGVjaWZpZXIucHJlY2lzaW9uID09IG51bGwgJiYgIWlzTmFOKHByZWNpc2lvbiA9IHByZWNpc2lvblJvdW5kX2RlZmF1bHQoc3RlcCwgTWF0aC5tYXgoTWF0aC5hYnMoc3RhcnQpLCBNYXRoLmFicyhzdG9wKSkpKSkgc3BlY2lmaWVyLnByZWNpc2lvbiA9IHByZWNpc2lvbiAtIChzcGVjaWZpZXIudHlwZSA9PT0gImUiKTsKICAgICAgYnJlYWs7CiAgICB9CiAgICBjYXNlICJmIjoKICAgIGNhc2UgIiUiOiB7CiAgICAgIGlmIChzcGVjaWZpZXIucHJlY2lzaW9uID09IG51bGwgJiYgIWlzTmFOKHByZWNpc2lvbiA9IHByZWNpc2lvbkZpeGVkX2RlZmF1bHQoc3RlcCkpKSBzcGVjaWZpZXIucHJlY2lzaW9uID0gcHJlY2lzaW9uIC0gKHNwZWNpZmllci50eXBlID09PSAiJSIpICogMjsKICAgICAgYnJlYWs7CiAgICB9CiAgfQogIHJldHVybiBmb3JtYXQoc3BlY2lmaWVyKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvbGluZWFyLmpzCmZ1bmN0aW9uIGxpbmVhcmlzaChzY2FsZSkgewogIHZhciBkb21haW4gPSBzY2FsZS5kb21haW47CiAgc2NhbGUudGlja3MgPSBmdW5jdGlvbihjb3VudCkgewogICAgdmFyIGQgPSBkb21haW4oKTsKICAgIHJldHVybiB0aWNrcyhkWzBdLCBkW2QubGVuZ3RoIC0gMV0sIGNvdW50ID09IG51bGwgPyAxMCA6IGNvdW50KTsKICB9OwogIHNjYWxlLnRpY2tGb3JtYXQgPSBmdW5jdGlvbihjb3VudCwgc3BlY2lmaWVyKSB7CiAgICB2YXIgZCA9IGRvbWFpbigpOwogICAgcmV0dXJuIHRpY2tGb3JtYXQoZFswXSwgZFtkLmxlbmd0aCAtIDFdLCBjb3VudCA9PSBudWxsID8gMTAgOiBjb3VudCwgc3BlY2lmaWVyKTsKICB9OwogIHNjYWxlLm5pY2UgPSBmdW5jdGlvbihjb3VudCkgewogICAgaWYgKGNvdW50ID09IG51bGwpIGNvdW50ID0gMTA7CiAgICB2YXIgZCA9IGRvbWFpbigpOwogICAgdmFyIGkwID0gMDsKICAgIHZhciBpMSA9IGQubGVuZ3RoIC0gMTsKICAgIHZhciBzdGFydCA9IGRbaTBdOwogICAgdmFyIHN0b3AgPSBkW2kxXTsKICAgIHZhciBwcmVzdGVwOwogICAgdmFyIHN0ZXA7CiAgICB2YXIgbWF4SXRlciA9IDEwOwogICAgaWYgKHN0b3AgPCBzdGFydCkgewogICAgICBzdGVwID0gc3RhcnQsIHN0YXJ0ID0gc3RvcCwgc3RvcCA9IHN0ZXA7CiAgICAgIHN0ZXAgPSBpMCwgaTAgPSBpMSwgaTEgPSBzdGVwOwogICAgfQogICAgd2hpbGUgKG1heEl0ZXItLSA+IDApIHsKICAgICAgc3RlcCA9IHRpY2tJbmNyZW1lbnQoc3RhcnQsIHN0b3AsIGNvdW50KTsKICAgICAgaWYgKHN0ZXAgPT09IHByZXN0ZXApIHsKICAgICAgICBkW2kwXSA9IHN0YXJ0OwogICAgICAgIGRbaTFdID0gc3RvcDsKICAgICAgICByZXR1cm4gZG9tYWluKGQpOwogICAgICB9IGVsc2UgaWYgKHN0ZXAgPiAwKSB7CiAgICAgICAgc3RhcnQgPSBNYXRoLmZsb29yKHN0YXJ0IC8gc3RlcCkgKiBzdGVwOwogICAgICAgIHN0b3AgPSBNYXRoLmNlaWwoc3RvcCAvIHN0ZXApICogc3RlcDsKICAgICAgfSBlbHNlIGlmIChzdGVwIDwgMCkgewogICAgICAgIHN0YXJ0ID0gTWF0aC5jZWlsKHN0YXJ0ICogc3RlcCkgLyBzdGVwOwogICAgICAgIHN0b3AgPSBNYXRoLmZsb29yKHN0b3AgKiBzdGVwKSAvIHN0ZXA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgICAgcHJlc3RlcCA9IHN0ZXA7CiAgICB9CiAgICByZXR1cm4gc2NhbGU7CiAgfTsKICByZXR1cm4gc2NhbGU7Cn0KZnVuY3Rpb24gbGluZWFyMigpIHsKICB2YXIgc2NhbGUgPSBjb250aW51b3VzKCk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkoc2NhbGUsIGxpbmVhcjIoKSk7CiAgfTsKICBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7CiAgcmV0dXJuIGxpbmVhcmlzaChzY2FsZSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL2lkZW50aXR5LmpzCmZ1bmN0aW9uIGlkZW50aXR5Mihkb21haW4pIHsKICB2YXIgdW5rbm93bjsKICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgcmV0dXJuIHgyID09IG51bGwgfHwgaXNOYU4oeDIgPSAreDIpID8gdW5rbm93biA6IHgyOwogIH0KICBzY2FsZS5pbnZlcnQgPSBzY2FsZTsKICBzY2FsZS5kb21haW4gPSBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGRvbWFpbiA9IEFycmF5LmZyb20oXywgbnVtYmVyMiksIHNjYWxlKSA6IGRvbWFpbi5zbGljZSgpOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGlkZW50aXR5Mihkb21haW4pLnVua25vd24odW5rbm93bik7CiAgfTsKICBkb21haW4gPSBhcmd1bWVudHMubGVuZ3RoID8gQXJyYXkuZnJvbShkb21haW4sIG51bWJlcjIpIDogWzAsIDFdOwogIHJldHVybiBsaW5lYXJpc2goc2NhbGUpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9uaWNlLmpzCmZ1bmN0aW9uIG5pY2UoZG9tYWluLCBpbnRlcnZhbCkgewogIGRvbWFpbiA9IGRvbWFpbi5zbGljZSgpOwogIHZhciBpMCA9IDAsIGkxID0gZG9tYWluLmxlbmd0aCAtIDEsIHgwID0gZG9tYWluW2kwXSwgeDEgPSBkb21haW5baTFdLCB0OwogIGlmICh4MSA8IHgwKSB7CiAgICB0ID0gaTAsIGkwID0gaTEsIGkxID0gdDsKICAgIHQgPSB4MCwgeDAgPSB4MSwgeDEgPSB0OwogIH0KICBkb21haW5baTBdID0gaW50ZXJ2YWwuZmxvb3IoeDApOwogIGRvbWFpbltpMV0gPSBpbnRlcnZhbC5jZWlsKHgxKTsKICByZXR1cm4gZG9tYWluOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9sb2cuanMKZnVuY3Rpb24gdHJhbnNmb3JtTG9nKHgyKSB7CiAgcmV0dXJuIE1hdGgubG9nKHgyKTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1FeHAoeDIpIHsKICByZXR1cm4gTWF0aC5leHAoeDIpOwp9CmZ1bmN0aW9uIHRyYW5zZm9ybUxvZ24oeDIpIHsKICByZXR1cm4gLU1hdGgubG9nKC14Mik7Cn0KZnVuY3Rpb24gdHJhbnNmb3JtRXhwbih4MikgewogIHJldHVybiAtTWF0aC5leHAoLXgyKTsKfQpmdW5jdGlvbiBwb3cxMCh4MikgewogIHJldHVybiBpc0Zpbml0ZSh4MikgPyArKCIxZSIgKyB4MikgOiB4MiA8IDAgPyAwIDogeDI7Cn0KZnVuY3Rpb24gcG93cChiYXNlKSB7CiAgcmV0dXJuIGJhc2UgPT09IDEwID8gcG93MTAgOiBiYXNlID09PSBNYXRoLkUgPyBNYXRoLmV4cCA6ICh4MikgPT4gTWF0aC5wb3coYmFzZSwgeDIpOwp9CmZ1bmN0aW9uIGxvZ3AoYmFzZSkgewogIHJldHVybiBiYXNlID09PSBNYXRoLkUgPyBNYXRoLmxvZyA6IGJhc2UgPT09IDEwICYmIE1hdGgubG9nMTAgfHwgYmFzZSA9PT0gMiAmJiBNYXRoLmxvZzIgfHwgKGJhc2UgPSBNYXRoLmxvZyhiYXNlKSwgKHgyKSA9PiBNYXRoLmxvZyh4MikgLyBiYXNlKTsKfQpmdW5jdGlvbiByZWZsZWN0KGYpIHsKICByZXR1cm4gKHgyLCBrKSA9PiAtZigteDIsIGspOwp9CmZ1bmN0aW9uIGxvZ2dpc2godHJhbnNmb3JtKSB7CiAgY29uc3Qgc2NhbGUgPSB0cmFuc2Zvcm0odHJhbnNmb3JtTG9nLCB0cmFuc2Zvcm1FeHApOwogIGNvbnN0IGRvbWFpbiA9IHNjYWxlLmRvbWFpbjsKICBsZXQgYmFzZSA9IDEwOwogIGxldCBsb2dzOwogIGxldCBwb3dzOwogIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICBsb2dzID0gbG9ncChiYXNlKSwgcG93cyA9IHBvd3AoYmFzZSk7CiAgICBpZiAoZG9tYWluKClbMF0gPCAwKSB7CiAgICAgIGxvZ3MgPSByZWZsZWN0KGxvZ3MpLCBwb3dzID0gcmVmbGVjdChwb3dzKTsKICAgICAgdHJhbnNmb3JtKHRyYW5zZm9ybUxvZ24sIHRyYW5zZm9ybUV4cG4pOwogICAgfSBlbHNlIHsKICAgICAgdHJhbnNmb3JtKHRyYW5zZm9ybUxvZywgdHJhbnNmb3JtRXhwKTsKICAgIH0KICAgIHJldHVybiBzY2FsZTsKICB9CiAgc2NhbGUuYmFzZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGJhc2UgPSArXywgcmVzY2FsZSgpKSA6IGJhc2U7CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkb21haW4oXyksIHJlc2NhbGUoKSkgOiBkb21haW4oKTsKICB9OwogIHNjYWxlLnRpY2tzID0gKGNvdW50KSA9PiB7CiAgICBjb25zdCBkID0gZG9tYWluKCk7CiAgICBsZXQgdSA9IGRbMF07CiAgICBsZXQgdiA9IGRbZC5sZW5ndGggLSAxXTsKICAgIGNvbnN0IHIyID0gdiA8IHU7CiAgICBpZiAocjIpIFt1LCB2XSA9IFt2LCB1XTsKICAgIGxldCBpID0gbG9ncyh1KTsKICAgIGxldCBqID0gbG9ncyh2KTsKICAgIGxldCBrOwogICAgbGV0IHQ7CiAgICBjb25zdCBuID0gY291bnQgPT0gbnVsbCA/IDEwIDogK2NvdW50OwogICAgbGV0IHogPSBbXTsKICAgIGlmICghKGJhc2UgJSAxKSAmJiBqIC0gaSA8IG4pIHsKICAgICAgaSA9IE1hdGguZmxvb3IoaSksIGogPSBNYXRoLmNlaWwoaik7CiAgICAgIGlmICh1ID4gMCkgZm9yICg7IGkgPD0gajsgKytpKSB7CiAgICAgICAgZm9yIChrID0gMTsgayA8IGJhc2U7ICsraykgewogICAgICAgICAgdCA9IGkgPCAwID8gayAvIHBvd3MoLWkpIDogayAqIHBvd3MoaSk7CiAgICAgICAgICBpZiAodCA8IHUpIGNvbnRpbnVlOwogICAgICAgICAgaWYgKHQgPiB2KSBicmVhazsKICAgICAgICAgIHoucHVzaCh0KTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZSBmb3IgKDsgaSA8PSBqOyArK2kpIHsKICAgICAgICBmb3IgKGsgPSBiYXNlIC0gMTsgayA+PSAxOyAtLWspIHsKICAgICAgICAgIHQgPSBpID4gMCA/IGsgLyBwb3dzKC1pKSA6IGsgKiBwb3dzKGkpOwogICAgICAgICAgaWYgKHQgPCB1KSBjb250aW51ZTsKICAgICAgICAgIGlmICh0ID4gdikgYnJlYWs7CiAgICAgICAgICB6LnB1c2godCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmICh6Lmxlbmd0aCAqIDIgPCBuKSB6ID0gdGlja3ModSwgdiwgbik7CiAgICB9IGVsc2UgewogICAgICB6ID0gdGlja3MoaSwgaiwgTWF0aC5taW4oaiAtIGksIG4pKS5tYXAocG93cyk7CiAgICB9CiAgICByZXR1cm4gcjIgPyB6LnJldmVyc2UoKSA6IHo7CiAgfTsKICBzY2FsZS50aWNrRm9ybWF0ID0gKGNvdW50LCBzcGVjaWZpZXIpID0+IHsKICAgIGlmIChjb3VudCA9PSBudWxsKSBjb3VudCA9IDEwOwogICAgaWYgKHNwZWNpZmllciA9PSBudWxsKSBzcGVjaWZpZXIgPSBiYXNlID09PSAxMCA/ICJzIiA6ICIsIjsKICAgIGlmICh0eXBlb2Ygc3BlY2lmaWVyICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgIGlmICghKGJhc2UgJSAxKSAmJiAoc3BlY2lmaWVyID0gZm9ybWF0U3BlY2lmaWVyKHNwZWNpZmllcikpLnByZWNpc2lvbiA9PSBudWxsKSBzcGVjaWZpZXIudHJpbSA9IHRydWU7CiAgICAgIHNwZWNpZmllciA9IGZvcm1hdChzcGVjaWZpZXIpOwogICAgfQogICAgaWYgKGNvdW50ID09PSBJbmZpbml0eSkgcmV0dXJuIHNwZWNpZmllcjsKICAgIGNvbnN0IGsgPSBNYXRoLm1heCgxLCBiYXNlICogY291bnQgLyBzY2FsZS50aWNrcygpLmxlbmd0aCk7CiAgICByZXR1cm4gKGQpID0+IHsKICAgICAgbGV0IGkgPSBkIC8gcG93cyhNYXRoLnJvdW5kKGxvZ3MoZCkpKTsKICAgICAgaWYgKGkgKiBiYXNlIDwgYmFzZSAtIDAuNSkgaSAqPSBiYXNlOwogICAgICByZXR1cm4gaSA8PSBrID8gc3BlY2lmaWVyKGQpIDogIiI7CiAgICB9OwogIH07CiAgc2NhbGUubmljZSA9ICgpID0+IHsKICAgIHJldHVybiBkb21haW4obmljZShkb21haW4oKSwgewogICAgICBmbG9vcjogKHgyKSA9PiBwb3dzKE1hdGguZmxvb3IobG9ncyh4MikpKSwKICAgICAgY2VpbDogKHgyKSA9PiBwb3dzKE1hdGguY2VpbChsb2dzKHgyKSkpCiAgICB9KSk7CiAgfTsKICByZXR1cm4gc2NhbGU7Cn0KZnVuY3Rpb24gbG9nKCkgewogIGNvbnN0IHNjYWxlID0gbG9nZ2lzaCh0cmFuc2Zvcm1lcigpKS5kb21haW4oWzEsIDEwXSk7CiAgc2NhbGUuY29weSA9ICgpID0+IGNvcHkoc2NhbGUsIGxvZygpKS5iYXNlKHNjYWxlLmJhc2UoKSk7CiAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwogIHJldHVybiBzY2FsZTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvc3ltbG9nLmpzCmZ1bmN0aW9uIHRyYW5zZm9ybVN5bWxvZyhjKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKHgyKSB7CiAgICByZXR1cm4gTWF0aC5zaWduKHgyKSAqIE1hdGgubG9nMXAoTWF0aC5hYnMoeDIgLyBjKSk7CiAgfTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1TeW1leHAoYykgewogIHJldHVybiBmdW5jdGlvbih4MikgewogICAgcmV0dXJuIE1hdGguc2lnbih4MikgKiBNYXRoLmV4cG0xKE1hdGguYWJzKHgyKSkgKiBjOwogIH07Cn0KZnVuY3Rpb24gc3ltbG9naXNoKHRyYW5zZm9ybSkgewogIHZhciBjID0gMSwgc2NhbGUgPSB0cmFuc2Zvcm0odHJhbnNmb3JtU3ltbG9nKGMpLCB0cmFuc2Zvcm1TeW1leHAoYykpOwogIHNjYWxlLmNvbnN0YW50ID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyB0cmFuc2Zvcm0odHJhbnNmb3JtU3ltbG9nKGMgPSArXyksIHRyYW5zZm9ybVN5bWV4cChjKSkgOiBjOwogIH07CiAgcmV0dXJuIGxpbmVhcmlzaChzY2FsZSk7Cn0KZnVuY3Rpb24gc3ltbG9nKCkgewogIHZhciBzY2FsZSA9IHN5bWxvZ2lzaCh0cmFuc2Zvcm1lcigpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weShzY2FsZSwgc3ltbG9nKCkpLmNvbnN0YW50KHNjYWxlLmNvbnN0YW50KCkpOwogIH07CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvcG93LmpzCmZ1bmN0aW9uIHRyYW5zZm9ybVBvdyhleHBvbmVudCkgewogIHJldHVybiBmdW5jdGlvbih4MikgewogICAgcmV0dXJuIHgyIDwgMCA/IC1NYXRoLnBvdygteDIsIGV4cG9uZW50KSA6IE1hdGgucG93KHgyLCBleHBvbmVudCk7CiAgfTsKfQpmdW5jdGlvbiB0cmFuc2Zvcm1TcXJ0KHgyKSB7CiAgcmV0dXJuIHgyIDwgMCA/IC1NYXRoLnNxcnQoLXgyKSA6IE1hdGguc3FydCh4Mik7Cn0KZnVuY3Rpb24gdHJhbnNmb3JtU3F1YXJlKHgyKSB7CiAgcmV0dXJuIHgyIDwgMCA/IC14MiAqIHgyIDogeDIgKiB4MjsKfQpmdW5jdGlvbiBwb3dpc2godHJhbnNmb3JtKSB7CiAgdmFyIHNjYWxlID0gdHJhbnNmb3JtKGlkZW50aXR5LCBpZGVudGl0eSksIGV4cG9uZW50ID0gMTsKICBmdW5jdGlvbiByZXNjYWxlKCkgewogICAgcmV0dXJuIGV4cG9uZW50ID09PSAxID8gdHJhbnNmb3JtKGlkZW50aXR5LCBpZGVudGl0eSkgOiBleHBvbmVudCA9PT0gMC41ID8gdHJhbnNmb3JtKHRyYW5zZm9ybVNxcnQsIHRyYW5zZm9ybVNxdWFyZSkgOiB0cmFuc2Zvcm0odHJhbnNmb3JtUG93KGV4cG9uZW50KSwgdHJhbnNmb3JtUG93KDEgLyBleHBvbmVudCkpOwogIH0KICBzY2FsZS5leHBvbmVudCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKGV4cG9uZW50ID0gK18sIHJlc2NhbGUoKSkgOiBleHBvbmVudDsKICB9OwogIHJldHVybiBsaW5lYXJpc2goc2NhbGUpOwp9CmZ1bmN0aW9uIHBvdygpIHsKICB2YXIgc2NhbGUgPSBwb3dpc2godHJhbnNmb3JtZXIoKSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkoc2NhbGUsIHBvdygpKS5leHBvbmVudChzY2FsZS5leHBvbmVudCgpKTsKICB9OwogIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKICByZXR1cm4gc2NhbGU7Cn0KZnVuY3Rpb24gc3FydCgpIHsKICByZXR1cm4gcG93LmFwcGx5KG51bGwsIGFyZ3VtZW50cykuZXhwb25lbnQoMC41KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvcmFkaWFsLmpzCmZ1bmN0aW9uIHNxdWFyZSh4MikgewogIHJldHVybiBNYXRoLnNpZ24oeDIpICogeDIgKiB4MjsKfQpmdW5jdGlvbiB1bnNxdWFyZSh4MikgewogIHJldHVybiBNYXRoLnNpZ24oeDIpICogTWF0aC5zcXJ0KE1hdGguYWJzKHgyKSk7Cn0KZnVuY3Rpb24gcmFkaWFsKCkgewogIHZhciBzcXVhcmVkID0gY29udGludW91cygpLCByYW5nZTQgPSBbMCwgMV0sIHJvdW5kID0gZmFsc2UsIHVua25vd247CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHZhciB5MiA9IHVuc3F1YXJlKHNxdWFyZWQoeDIpKTsKICAgIHJldHVybiBpc05hTih5MikgPyB1bmtub3duIDogcm91bmQgPyBNYXRoLnJvdW5kKHkyKSA6IHkyOwogIH0KICBzY2FsZS5pbnZlcnQgPSBmdW5jdGlvbih5MikgewogICAgcmV0dXJuIHNxdWFyZWQuaW52ZXJ0KHNxdWFyZSh5MikpOwogIH07CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoc3F1YXJlZC5kb21haW4oXyksIHNjYWxlKSA6IHNxdWFyZWQuZG9tYWluKCk7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHNxdWFyZWQucmFuZ2UoKHJhbmdlNCA9IEFycmF5LmZyb20oXywgbnVtYmVyMikpLm1hcChzcXVhcmUpKSwgc2NhbGUpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS5yYW5nZVJvdW5kID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIHNjYWxlLnJhbmdlKF8pLnJvdW5kKHRydWUpOwogIH07CiAgc2NhbGUucm91bmQgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChyb3VuZCA9ICEhXywgc2NhbGUpIDogcm91bmQ7CiAgfTsKICBzY2FsZS5jbGFtcCA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHNxdWFyZWQuY2xhbXAoXyksIHNjYWxlKSA6IHNxdWFyZWQuY2xhbXAoKTsKICB9OwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiByYWRpYWwoc3F1YXJlZC5kb21haW4oKSwgcmFuZ2U0KS5yb3VuZChyb3VuZCkuY2xhbXAoc3F1YXJlZC5jbGFtcCgpKS51bmtub3duKHVua25vd24pOwogIH07CiAgaW5pdFJhbmdlLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwogIHJldHVybiBsaW5lYXJpc2goc2NhbGUpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtc2NhbGVANC4wLjIvbm9kZV9tb2R1bGVzL2QzLXNjYWxlL3NyYy9xdWFudGlsZS5qcwpmdW5jdGlvbiBxdWFudGlsZTIoKSB7CiAgdmFyIGRvbWFpbiA9IFtdLCByYW5nZTQgPSBbXSwgdGhyZXNob2xkcyA9IFtdLCB1bmtub3duOwogIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICB2YXIgaSA9IDAsIG4gPSBNYXRoLm1heCgxLCByYW5nZTQubGVuZ3RoKTsKICAgIHRocmVzaG9sZHMgPSBuZXcgQXJyYXkobiAtIDEpOwogICAgd2hpbGUgKCsraSA8IG4pIHRocmVzaG9sZHNbaSAtIDFdID0gcXVhbnRpbGVTb3J0ZWQoZG9tYWluLCBpIC8gbik7CiAgICByZXR1cm4gc2NhbGU7CiAgfQogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICByZXR1cm4geDIgPT0gbnVsbCB8fCBpc05hTih4MiA9ICt4MikgPyB1bmtub3duIDogcmFuZ2U0W2Jpc2VjdF9kZWZhdWx0KHRocmVzaG9sZHMsIHgyKV07CiAgfQogIHNjYWxlLmludmVydEV4dGVudCA9IGZ1bmN0aW9uKHkyKSB7CiAgICB2YXIgaSA9IHJhbmdlNC5pbmRleE9mKHkyKTsKICAgIHJldHVybiBpIDwgMCA/IFtOYU4sIE5hTl0gOiBbCiAgICAgIGkgPiAwID8gdGhyZXNob2xkc1tpIC0gMV0gOiBkb21haW5bMF0sCiAgICAgIGkgPCB0aHJlc2hvbGRzLmxlbmd0aCA/IHRocmVzaG9sZHNbaV0gOiBkb21haW5bZG9tYWluLmxlbmd0aCAtIDFdCiAgICBdOwogIH07CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gZG9tYWluLnNsaWNlKCk7CiAgICBkb21haW4gPSBbXTsKICAgIGZvciAobGV0IGQgb2YgXykgaWYgKGQgIT0gbnVsbCAmJiAhaXNOYU4oZCA9ICtkKSkgZG9tYWluLnB1c2goZCk7CiAgICBkb21haW4uc29ydChhc2NlbmRpbmcpOwogICAgcmV0dXJuIHJlc2NhbGUoKTsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocmFuZ2U0ID0gQXJyYXkuZnJvbShfKSwgcmVzY2FsZSgpKSA6IHJhbmdlNC5zbGljZSgpOwogIH07CiAgc2NhbGUudW5rbm93biA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKHVua25vd24gPSBfLCBzY2FsZSkgOiB1bmtub3duOwogIH07CiAgc2NhbGUucXVhbnRpbGVzID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhyZXNob2xkcy5zbGljZSgpOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHF1YW50aWxlMigpLmRvbWFpbihkb21haW4pLnJhbmdlKHJhbmdlNCkudW5rbm93bih1bmtub3duKTsKICB9OwogIHJldHVybiBpbml0UmFuZ2UuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3F1YW50aXplLmpzCmZ1bmN0aW9uIHF1YW50aXplKCkgewogIHZhciB4MCA9IDAsIHgxID0gMSwgbiA9IDEsIGRvbWFpbiA9IFswLjVdLCByYW5nZTQgPSBbMCwgMV0sIHVua25vd247CiAgZnVuY3Rpb24gc2NhbGUoeDIpIHsKICAgIHJldHVybiB4MiAhPSBudWxsICYmIHgyIDw9IHgyID8gcmFuZ2U0W2Jpc2VjdF9kZWZhdWx0KGRvbWFpbiwgeDIsIDAsIG4pXSA6IHVua25vd247CiAgfQogIGZ1bmN0aW9uIHJlc2NhbGUoKSB7CiAgICB2YXIgaSA9IC0xOwogICAgZG9tYWluID0gbmV3IEFycmF5KG4pOwogICAgd2hpbGUgKCsraSA8IG4pIGRvbWFpbltpXSA9ICgoaSArIDEpICogeDEgLSAoaSAtIG4pICogeDApIC8gKG4gKyAxKTsKICAgIHJldHVybiBzY2FsZTsKICB9CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoW3gwLCB4MV0gPSBfLCB4MCA9ICt4MCwgeDEgPSAreDEsIHJlc2NhbGUoKSkgOiBbeDAsIHgxXTsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAobiA9IChyYW5nZTQgPSBBcnJheS5mcm9tKF8pKS5sZW5ndGggLSAxLCByZXNjYWxlKCkpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS5pbnZlcnRFeHRlbnQgPSBmdW5jdGlvbih5MikgewogICAgdmFyIGkgPSByYW5nZTQuaW5kZXhPZih5Mik7CiAgICByZXR1cm4gaSA8IDAgPyBbTmFOLCBOYU5dIDogaSA8IDEgPyBbeDAsIGRvbWFpblswXV0gOiBpID49IG4gPyBbZG9tYWluW24gLSAxXSwgeDFdIDogW2RvbWFpbltpIC0gMV0sIGRvbWFpbltpXV07CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHNjYWxlOwogIH07CiAgc2NhbGUudGhyZXNob2xkcyA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGRvbWFpbi5zbGljZSgpOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIHF1YW50aXplKCkuZG9tYWluKFt4MCwgeDFdKS5yYW5nZShyYW5nZTQpLnVua25vd24odW5rbm93bik7CiAgfTsKICByZXR1cm4gaW5pdFJhbmdlLmFwcGx5KGxpbmVhcmlzaChzY2FsZSksIGFyZ3VtZW50cyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3RocmVzaG9sZC5qcwpmdW5jdGlvbiB0aHJlc2hvbGQoKSB7CiAgdmFyIGRvbWFpbiA9IFswLjVdLCByYW5nZTQgPSBbMCwgMV0sIHVua25vd24sIG4gPSAxOwogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICByZXR1cm4geDIgIT0gbnVsbCAmJiB4MiA8PSB4MiA/IHJhbmdlNFtiaXNlY3RfZGVmYXVsdChkb21haW4sIHgyLCAwLCBuKV0gOiB1bmtub3duOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChkb21haW4gPSBBcnJheS5mcm9tKF8pLCBuID0gTWF0aC5taW4oZG9tYWluLmxlbmd0aCwgcmFuZ2U0Lmxlbmd0aCAtIDEpLCBzY2FsZSkgOiBkb21haW4uc2xpY2UoKTsKICB9OwogIHNjYWxlLnJhbmdlID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAocmFuZ2U0ID0gQXJyYXkuZnJvbShfKSwgbiA9IE1hdGgubWluKGRvbWFpbi5sZW5ndGgsIHJhbmdlNC5sZW5ndGggLSAxKSwgc2NhbGUpIDogcmFuZ2U0LnNsaWNlKCk7CiAgfTsKICBzY2FsZS5pbnZlcnRFeHRlbnQgPSBmdW5jdGlvbih5MikgewogICAgdmFyIGkgPSByYW5nZTQuaW5kZXhPZih5Mik7CiAgICByZXR1cm4gW2RvbWFpbltpIC0gMV0sIGRvbWFpbltpXV07CiAgfTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhyZXNob2xkKCkuZG9tYWluKGRvbWFpbikucmFuZ2UocmFuZ2U0KS51bmtub3duKHVua25vd24pOwogIH07CiAgcmV0dXJuIGluaXRSYW5nZS5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXRpbWVAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL2ludGVydmFsLmpzCnZhciB0MCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpOwp2YXIgdDEgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKTsKZnVuY3Rpb24gdGltZUludGVydmFsKGZsb29yaSwgb2Zmc2V0aSwgY291bnQsIGZpZWxkKSB7CiAgZnVuY3Rpb24gaW50ZXJ2YWwoZGF0ZTIpIHsKICAgIHJldHVybiBmbG9vcmkoZGF0ZTIgPSBhcmd1bWVudHMubGVuZ3RoID09PSAwID8gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCkgOiAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoK2RhdGUyKSksIGRhdGUyOwogIH0KICBpbnRlcnZhbC5mbG9vciA9IChkYXRlMikgPT4gewogICAgcmV0dXJuIGZsb29yaShkYXRlMiA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgrZGF0ZTIpKSwgZGF0ZTI7CiAgfTsKICBpbnRlcnZhbC5jZWlsID0gKGRhdGUyKSA9PiB7CiAgICByZXR1cm4gZmxvb3JpKGRhdGUyID0gbmV3IERhdGUoZGF0ZTIgLSAxKSksIG9mZnNldGkoZGF0ZTIsIDEpLCBmbG9vcmkoZGF0ZTIpLCBkYXRlMjsKICB9OwogIGludGVydmFsLnJvdW5kID0gKGRhdGUyKSA9PiB7CiAgICBjb25zdCBkMCA9IGludGVydmFsKGRhdGUyKSwgZDEgPSBpbnRlcnZhbC5jZWlsKGRhdGUyKTsKICAgIHJldHVybiBkYXRlMiAtIGQwIDwgZDEgLSBkYXRlMiA/IGQwIDogZDE7CiAgfTsKICBpbnRlcnZhbC5vZmZzZXQgPSAoZGF0ZTIsIHN0ZXApID0+IHsKICAgIHJldHVybiBvZmZzZXRpKGRhdGUyID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCtkYXRlMiksIHN0ZXAgPT0gbnVsbCA/IDEgOiBNYXRoLmZsb29yKHN0ZXApKSwgZGF0ZTI7CiAgfTsKICBpbnRlcnZhbC5yYW5nZSA9IChzdGFydCwgc3RvcCwgc3RlcCkgPT4gewogICAgY29uc3QgcmFuZ2U0ID0gW107CiAgICBzdGFydCA9IGludGVydmFsLmNlaWwoc3RhcnQpOwogICAgc3RlcCA9IHN0ZXAgPT0gbnVsbCA/IDEgOiBNYXRoLmZsb29yKHN0ZXApOwogICAgaWYgKCEoc3RhcnQgPCBzdG9wKSB8fCAhKHN0ZXAgPiAwKSkgcmV0dXJuIHJhbmdlNDsKICAgIGxldCBwcmV2aW91czsKICAgIGRvCiAgICAgIHJhbmdlNC5wdXNoKHByZXZpb3VzID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCtzdGFydCkpLCBvZmZzZXRpKHN0YXJ0LCBzdGVwKSwgZmxvb3JpKHN0YXJ0KTsKICAgIHdoaWxlIChwcmV2aW91cyA8IHN0YXJ0ICYmIHN0YXJ0IDwgc3RvcCk7CiAgICByZXR1cm4gcmFuZ2U0OwogIH07CiAgaW50ZXJ2YWwuZmlsdGVyID0gKHRlc3QpID0+IHsKICAgIHJldHVybiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICAgIGlmIChkYXRlMiA+PSBkYXRlMikgd2hpbGUgKGZsb29yaShkYXRlMiksICF0ZXN0KGRhdGUyKSkgZGF0ZTIuc2V0VGltZShkYXRlMiAtIDEpOwogICAgfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgICAgIGlmIChkYXRlMiA+PSBkYXRlMikgewogICAgICAgIGlmIChzdGVwIDwgMCkgd2hpbGUgKCsrc3RlcCA8PSAwKSB7CiAgICAgICAgICB3aGlsZSAob2Zmc2V0aShkYXRlMiwgLTEpLCAhdGVzdChkYXRlMikpIHsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSB3aGlsZSAoLS1zdGVwID49IDApIHsKICAgICAgICAgIHdoaWxlIChvZmZzZXRpKGRhdGUyLCAxKSwgIXRlc3QoZGF0ZTIpKSB7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9OwogIGlmIChjb3VudCkgewogICAgaW50ZXJ2YWwuY291bnQgPSAoc3RhcnQsIGVuZCkgPT4gewogICAgICB0MC5zZXRUaW1lKCtzdGFydCksIHQxLnNldFRpbWUoK2VuZCk7CiAgICAgIGZsb29yaSh0MCksIGZsb29yaSh0MSk7CiAgICAgIHJldHVybiBNYXRoLmZsb29yKGNvdW50KHQwLCB0MSkpOwogICAgfTsKICAgIGludGVydmFsLmV2ZXJ5ID0gKHN0ZXApID0+IHsKICAgICAgc3RlcCA9IE1hdGguZmxvb3Ioc3RlcCk7CiAgICAgIHJldHVybiAhaXNGaW5pdGUoc3RlcCkgfHwgIShzdGVwID4gMCkgPyBudWxsIDogIShzdGVwID4gMSkgPyBpbnRlcnZhbCA6IGludGVydmFsLmZpbHRlcihmaWVsZCA/IChkKSA9PiBmaWVsZChkKSAlIHN0ZXAgPT09IDAgOiAoZCkgPT4gaW50ZXJ2YWwuY291bnQoMCwgZCkgJSBzdGVwID09PSAwKTsKICAgIH07CiAgfQogIHJldHVybiBpbnRlcnZhbDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXRpbWVAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL21pbGxpc2Vjb25kLmpzCnZhciBtaWxsaXNlY29uZCA9IHRpbWVJbnRlcnZhbCgoKSA9PiB7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZCAtIHN0YXJ0Owp9KTsKbWlsbGlzZWNvbmQuZXZlcnkgPSAoaykgPT4gewogIGsgPSBNYXRoLmZsb29yKGspOwogIGlmICghaXNGaW5pdGUoaykgfHwgIShrID4gMCkpIHJldHVybiBudWxsOwogIGlmICghKGsgPiAxKSkgcmV0dXJuIG1pbGxpc2Vjb25kOwogIHJldHVybiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICBkYXRlMi5zZXRUaW1lKE1hdGguZmxvb3IoZGF0ZTIgLyBrKSAqIGspOwogIH0sIChkYXRlMiwgc3RlcCkgPT4gewogICAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwICogayk7CiAgfSwgKHN0YXJ0LCBlbmQpID0+IHsKICAgIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gazsKICB9KTsKfTsKdmFyIG1pbGxpc2Vjb25kcyA9IG1pbGxpc2Vjb25kLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXRpbWVAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL2R1cmF0aW9uLmpzCnZhciBkdXJhdGlvblNlY29uZCA9IDFlMzsKdmFyIGR1cmF0aW9uTWludXRlID0gZHVyYXRpb25TZWNvbmQgKiA2MDsKdmFyIGR1cmF0aW9uSG91ciA9IGR1cmF0aW9uTWludXRlICogNjA7CnZhciBkdXJhdGlvbkRheSA9IGR1cmF0aW9uSG91ciAqIDI0Owp2YXIgZHVyYXRpb25XZWVrID0gZHVyYXRpb25EYXkgKiA3Owp2YXIgZHVyYXRpb25Nb250aCA9IGR1cmF0aW9uRGF5ICogMzA7CnZhciBkdXJhdGlvblllYXIgPSBkdXJhdGlvbkRheSAqIDM2NTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy10aW1lQDMuMS4wL25vZGVfbW9kdWxlcy9kMy10aW1lL3NyYy9zZWNvbmQuanMKdmFyIHNlY29uZCA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRUaW1lKGRhdGUyIC0gZGF0ZTIuZ2V0TWlsbGlzZWNvbmRzKCkpOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXAgKiBkdXJhdGlvblNlY29uZCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvblNlY29uZDsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldFVUQ1NlY29uZHMoKTsKfSk7CnZhciBzZWNvbmRzID0gc2Vjb25kLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXRpbWVAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL21pbnV0ZS5qcwp2YXIgdGltZU1pbnV0ZSA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRUaW1lKGRhdGUyIC0gZGF0ZTIuZ2V0TWlsbGlzZWNvbmRzKCkgLSBkYXRlMi5nZXRTZWNvbmRzKCkgKiBkdXJhdGlvblNlY29uZCk7Cn0sIChkYXRlMiwgc3RlcCkgPT4gewogIGRhdGUyLnNldFRpbWUoK2RhdGUyICsgc3RlcCAqIGR1cmF0aW9uTWludXRlKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uTWludXRlOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0TWludXRlcygpOwp9KTsKdmFyIHRpbWVNaW51dGVzID0gdGltZU1pbnV0ZS5yYW5nZTsKdmFyIHV0Y01pbnV0ZSA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRVVENTZWNvbmRzKDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXAgKiBkdXJhdGlvbk1pbnV0ZSk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIChlbmQgLSBzdGFydCkgLyBkdXJhdGlvbk1pbnV0ZTsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldFVUQ01pbnV0ZXMoKTsKfSk7CnZhciB1dGNNaW51dGVzID0gdXRjTWludXRlLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXRpbWVAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL2hvdXIuanMKdmFyIHRpbWVIb3VyID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFRpbWUoZGF0ZTIgLSBkYXRlMi5nZXRNaWxsaXNlY29uZHMoKSAtIGRhdGUyLmdldFNlY29uZHMoKSAqIGR1cmF0aW9uU2Vjb25kIC0gZGF0ZTIuZ2V0TWludXRlcygpICogZHVyYXRpb25NaW51dGUpOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRUaW1lKCtkYXRlMiArIHN0ZXAgKiBkdXJhdGlvbkhvdXIpOwp9LCAoc3RhcnQsIGVuZCkgPT4gewogIHJldHVybiAoZW5kIC0gc3RhcnQpIC8gZHVyYXRpb25Ib3VyOwp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0SG91cnMoKTsKfSk7CnZhciB0aW1lSG91cnMgPSB0aW1lSG91ci5yYW5nZTsKdmFyIHV0Y0hvdXIgPSB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgZGF0ZTIuc2V0VVRDTWludXRlcygwLCAwLCAwKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VGltZSgrZGF0ZTIgKyBzdGVwICogZHVyYXRpb25Ib3VyKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uSG91cjsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldFVUQ0hvdXJzKCk7Cn0pOwp2YXIgdXRjSG91cnMgPSB1dGNIb3VyLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXRpbWVAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL2RheS5qcwp2YXIgdGltZURheSA9IHRpbWVJbnRlcnZhbCgKICAoZGF0ZTIpID0+IGRhdGUyLnNldEhvdXJzKDAsIDAsIDAsIDApLAogIChkYXRlMiwgc3RlcCkgPT4gZGF0ZTIuc2V0RGF0ZShkYXRlMi5nZXREYXRlKCkgKyBzdGVwKSwKICAoc3RhcnQsIGVuZCkgPT4gKGVuZCAtIHN0YXJ0IC0gKGVuZC5nZXRUaW1lem9uZU9mZnNldCgpIC0gc3RhcnQuZ2V0VGltZXpvbmVPZmZzZXQoKSkgKiBkdXJhdGlvbk1pbnV0ZSkgLyBkdXJhdGlvbkRheSwKICAoZGF0ZTIpID0+IGRhdGUyLmdldERhdGUoKSAtIDEKKTsKdmFyIHRpbWVEYXlzID0gdGltZURheS5yYW5nZTsKdmFyIHV0Y0RheSA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRVVENIb3VycygwLCAwLCAwLCAwKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VVRDRGF0ZShkYXRlMi5nZXRVVENEYXRlKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uRGF5Owp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gZGF0ZTIuZ2V0VVRDRGF0ZSgpIC0gMTsKfSk7CnZhciB1dGNEYXlzID0gdXRjRGF5LnJhbmdlOwp2YXIgdW5peERheSA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRVVENIb3VycygwLCAwLCAwLCAwKTsKfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgZGF0ZTIuc2V0VVRDRGF0ZShkYXRlMi5nZXRVVENEYXRlKCkgKyBzdGVwKTsKfSwgKHN0YXJ0LCBlbmQpID0+IHsKICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uRGF5Owp9LCAoZGF0ZTIpID0+IHsKICByZXR1cm4gTWF0aC5mbG9vcihkYXRlMiAvIGR1cmF0aW9uRGF5KTsKfSk7CnZhciB1bml4RGF5cyA9IHVuaXhEYXkucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvd2Vlay5qcwpmdW5jdGlvbiB0aW1lV2Vla2RheShpKSB7CiAgcmV0dXJuIHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICAgIGRhdGUyLnNldERhdGUoZGF0ZTIuZ2V0RGF0ZSgpIC0gKGRhdGUyLmdldERheSgpICsgNyAtIGkpICUgNyk7CiAgICBkYXRlMi5zZXRIb3VycygwLCAwLCAwLCAwKTsKICB9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICAgIGRhdGUyLnNldERhdGUoZGF0ZTIuZ2V0RGF0ZSgpICsgc3RlcCAqIDcpOwogIH0sIChzdGFydCwgZW5kKSA9PiB7CiAgICByZXR1cm4gKGVuZCAtIHN0YXJ0IC0gKGVuZC5nZXRUaW1lem9uZU9mZnNldCgpIC0gc3RhcnQuZ2V0VGltZXpvbmVPZmZzZXQoKSkgKiBkdXJhdGlvbk1pbnV0ZSkgLyBkdXJhdGlvbldlZWs7CiAgfSk7Cn0KdmFyIHRpbWVTdW5kYXkgPSB0aW1lV2Vla2RheSgwKTsKdmFyIHRpbWVNb25kYXkgPSB0aW1lV2Vla2RheSgxKTsKdmFyIHRpbWVUdWVzZGF5ID0gdGltZVdlZWtkYXkoMik7CnZhciB0aW1lV2VkbmVzZGF5ID0gdGltZVdlZWtkYXkoMyk7CnZhciB0aW1lVGh1cnNkYXkgPSB0aW1lV2Vla2RheSg0KTsKdmFyIHRpbWVGcmlkYXkgPSB0aW1lV2Vla2RheSg1KTsKdmFyIHRpbWVTYXR1cmRheSA9IHRpbWVXZWVrZGF5KDYpOwp2YXIgdGltZVN1bmRheXMgPSB0aW1lU3VuZGF5LnJhbmdlOwp2YXIgdGltZU1vbmRheXMgPSB0aW1lTW9uZGF5LnJhbmdlOwp2YXIgdGltZVR1ZXNkYXlzID0gdGltZVR1ZXNkYXkucmFuZ2U7CnZhciB0aW1lV2VkbmVzZGF5cyA9IHRpbWVXZWRuZXNkYXkucmFuZ2U7CnZhciB0aW1lVGh1cnNkYXlzID0gdGltZVRodXJzZGF5LnJhbmdlOwp2YXIgdGltZUZyaWRheXMgPSB0aW1lRnJpZGF5LnJhbmdlOwp2YXIgdGltZVNhdHVyZGF5cyA9IHRpbWVTYXR1cmRheS5yYW5nZTsKZnVuY3Rpb24gdXRjV2Vla2RheShpKSB7CiAgcmV0dXJuIHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICAgIGRhdGUyLnNldFVUQ0RhdGUoZGF0ZTIuZ2V0VVRDRGF0ZSgpIC0gKGRhdGUyLmdldFVUQ0RheSgpICsgNyAtIGkpICUgNyk7CiAgICBkYXRlMi5zZXRVVENIb3VycygwLCAwLCAwLCAwKTsKICB9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICAgIGRhdGUyLnNldFVUQ0RhdGUoZGF0ZTIuZ2V0VVRDRGF0ZSgpICsgc3RlcCAqIDcpOwogIH0sIChzdGFydCwgZW5kKSA9PiB7CiAgICByZXR1cm4gKGVuZCAtIHN0YXJ0KSAvIGR1cmF0aW9uV2VlazsKICB9KTsKfQp2YXIgdXRjU3VuZGF5ID0gdXRjV2Vla2RheSgwKTsKdmFyIHV0Y01vbmRheSA9IHV0Y1dlZWtkYXkoMSk7CnZhciB1dGNUdWVzZGF5ID0gdXRjV2Vla2RheSgyKTsKdmFyIHV0Y1dlZG5lc2RheSA9IHV0Y1dlZWtkYXkoMyk7CnZhciB1dGNUaHVyc2RheSA9IHV0Y1dlZWtkYXkoNCk7CnZhciB1dGNGcmlkYXkgPSB1dGNXZWVrZGF5KDUpOwp2YXIgdXRjU2F0dXJkYXkgPSB1dGNXZWVrZGF5KDYpOwp2YXIgdXRjU3VuZGF5cyA9IHV0Y1N1bmRheS5yYW5nZTsKdmFyIHV0Y01vbmRheXMgPSB1dGNNb25kYXkucmFuZ2U7CnZhciB1dGNUdWVzZGF5cyA9IHV0Y1R1ZXNkYXkucmFuZ2U7CnZhciB1dGNXZWRuZXNkYXlzID0gdXRjV2VkbmVzZGF5LnJhbmdlOwp2YXIgdXRjVGh1cnNkYXlzID0gdXRjVGh1cnNkYXkucmFuZ2U7CnZhciB1dGNGcmlkYXlzID0gdXRjRnJpZGF5LnJhbmdlOwp2YXIgdXRjU2F0dXJkYXlzID0gdXRjU2F0dXJkYXkucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvbW9udGguanMKdmFyIHRpbWVNb250aCA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXREYXRlKDEpOwogIGRhdGUyLnNldEhvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRNb250aChkYXRlMi5nZXRNb250aCgpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZC5nZXRNb250aCgpIC0gc3RhcnQuZ2V0TW9udGgoKSArIChlbmQuZ2V0RnVsbFllYXIoKSAtIHN0YXJ0LmdldEZ1bGxZZWFyKCkpICogMTI7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRNb250aCgpOwp9KTsKdmFyIHRpbWVNb250aHMgPSB0aW1lTW9udGgucmFuZ2U7CnZhciB1dGNNb250aCA9IHRpbWVJbnRlcnZhbCgoZGF0ZTIpID0+IHsKICBkYXRlMi5zZXRVVENEYXRlKDEpOwogIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRVVENNb250aChkYXRlMi5nZXRVVENNb250aCgpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZC5nZXRVVENNb250aCgpIC0gc3RhcnQuZ2V0VVRDTW9udGgoKSArIChlbmQuZ2V0VVRDRnVsbFllYXIoKSAtIHN0YXJ0LmdldFVUQ0Z1bGxZZWFyKCkpICogMTI7Cn0sIChkYXRlMikgPT4gewogIHJldHVybiBkYXRlMi5nZXRVVENNb250aCgpOwp9KTsKdmFyIHV0Y01vbnRocyA9IHV0Y01vbnRoLnJhbmdlOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXRpbWVAMy4xLjAvbm9kZV9tb2R1bGVzL2QzLXRpbWUvc3JjL3llYXIuanMKdmFyIHRpbWVZZWFyID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldE1vbnRoKDAsIDEpOwogIGRhdGUyLnNldEhvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRGdWxsWWVhcihkYXRlMi5nZXRGdWxsWWVhcigpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZC5nZXRGdWxsWWVhcigpIC0gc3RhcnQuZ2V0RnVsbFllYXIoKTsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldEZ1bGxZZWFyKCk7Cn0pOwp0aW1lWWVhci5ldmVyeSA9IChrKSA9PiB7CiAgcmV0dXJuICFpc0Zpbml0ZShrID0gTWF0aC5mbG9vcihrKSkgfHwgIShrID4gMCkgPyBudWxsIDogdGltZUludGVydmFsKChkYXRlMikgPT4gewogICAgZGF0ZTIuc2V0RnVsbFllYXIoTWF0aC5mbG9vcihkYXRlMi5nZXRGdWxsWWVhcigpIC8gaykgKiBrKTsKICAgIGRhdGUyLnNldE1vbnRoKDAsIDEpOwogICAgZGF0ZTIuc2V0SG91cnMoMCwgMCwgMCwgMCk7CiAgfSwgKGRhdGUyLCBzdGVwKSA9PiB7CiAgICBkYXRlMi5zZXRGdWxsWWVhcihkYXRlMi5nZXRGdWxsWWVhcigpICsgc3RlcCAqIGspOwogIH0pOwp9Owp2YXIgdGltZVllYXJzID0gdGltZVllYXIucmFuZ2U7CnZhciB1dGNZZWFyID0gdGltZUludGVydmFsKChkYXRlMikgPT4gewogIGRhdGUyLnNldFVUQ01vbnRoKDAsIDEpOwogIGRhdGUyLnNldFVUQ0hvdXJzKDAsIDAsIDAsIDApOwp9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICBkYXRlMi5zZXRVVENGdWxsWWVhcihkYXRlMi5nZXRVVENGdWxsWWVhcigpICsgc3RlcCk7Cn0sIChzdGFydCwgZW5kKSA9PiB7CiAgcmV0dXJuIGVuZC5nZXRVVENGdWxsWWVhcigpIC0gc3RhcnQuZ2V0VVRDRnVsbFllYXIoKTsKfSwgKGRhdGUyKSA9PiB7CiAgcmV0dXJuIGRhdGUyLmdldFVUQ0Z1bGxZZWFyKCk7Cn0pOwp1dGNZZWFyLmV2ZXJ5ID0gKGspID0+IHsKICByZXR1cm4gIWlzRmluaXRlKGsgPSBNYXRoLmZsb29yKGspKSB8fCAhKGsgPiAwKSA/IG51bGwgOiB0aW1lSW50ZXJ2YWwoKGRhdGUyKSA9PiB7CiAgICBkYXRlMi5zZXRVVENGdWxsWWVhcihNYXRoLmZsb29yKGRhdGUyLmdldFVUQ0Z1bGxZZWFyKCkgLyBrKSAqIGspOwogICAgZGF0ZTIuc2V0VVRDTW9udGgoMCwgMSk7CiAgICBkYXRlMi5zZXRVVENIb3VycygwLCAwLCAwLCAwKTsKICB9LCAoZGF0ZTIsIHN0ZXApID0+IHsKICAgIGRhdGUyLnNldFVUQ0Z1bGxZZWFyKGRhdGUyLmdldFVUQ0Z1bGxZZWFyKCkgKyBzdGVwICogayk7CiAgfSk7Cn07CnZhciB1dGNZZWFycyA9IHV0Y1llYXIucmFuZ2U7CgovLyBub2RlX21vZHVsZXMvLnBucG0vZDMtdGltZUAzLjEuMC9ub2RlX21vZHVsZXMvZDMtdGltZS9zcmMvdGlja3MuanMKZnVuY3Rpb24gdGlja2VyKHllYXIsIG1vbnRoLCB3ZWVrLCBkYXksIGhvdXIsIG1pbnV0ZSkgewogIGNvbnN0IHRpY2tJbnRlcnZhbHMgPSBbCiAgICBbc2Vjb25kLCAxLCBkdXJhdGlvblNlY29uZF0sCiAgICBbc2Vjb25kLCA1LCA1ICogZHVyYXRpb25TZWNvbmRdLAogICAgW3NlY29uZCwgMTUsIDE1ICogZHVyYXRpb25TZWNvbmRdLAogICAgW3NlY29uZCwgMzAsIDMwICogZHVyYXRpb25TZWNvbmRdLAogICAgW21pbnV0ZSwgMSwgZHVyYXRpb25NaW51dGVdLAogICAgW21pbnV0ZSwgNSwgNSAqIGR1cmF0aW9uTWludXRlXSwKICAgIFttaW51dGUsIDE1LCAxNSAqIGR1cmF0aW9uTWludXRlXSwKICAgIFttaW51dGUsIDMwLCAzMCAqIGR1cmF0aW9uTWludXRlXSwKICAgIFtob3VyLCAxLCBkdXJhdGlvbkhvdXJdLAogICAgW2hvdXIsIDMsIDMgKiBkdXJhdGlvbkhvdXJdLAogICAgW2hvdXIsIDYsIDYgKiBkdXJhdGlvbkhvdXJdLAogICAgW2hvdXIsIDEyLCAxMiAqIGR1cmF0aW9uSG91cl0sCiAgICBbZGF5LCAxLCBkdXJhdGlvbkRheV0sCiAgICBbZGF5LCAyLCAyICogZHVyYXRpb25EYXldLAogICAgW3dlZWssIDEsIGR1cmF0aW9uV2Vla10sCiAgICBbbW9udGgsIDEsIGR1cmF0aW9uTW9udGhdLAogICAgW21vbnRoLCAzLCAzICogZHVyYXRpb25Nb250aF0sCiAgICBbeWVhciwgMSwgZHVyYXRpb25ZZWFyXQogIF07CiAgZnVuY3Rpb24gdGlja3MyKHN0YXJ0LCBzdG9wLCBjb3VudCkgewogICAgY29uc3QgcmV2ZXJzZTIgPSBzdG9wIDwgc3RhcnQ7CiAgICBpZiAocmV2ZXJzZTIpIFtzdGFydCwgc3RvcF0gPSBbc3RvcCwgc3RhcnRdOwogICAgY29uc3QgaW50ZXJ2YWwgPSBjb3VudCAmJiB0eXBlb2YgY291bnQucmFuZ2UgPT09ICJmdW5jdGlvbiIgPyBjb3VudCA6IHRpY2tJbnRlcnZhbChzdGFydCwgc3RvcCwgY291bnQpOwogICAgY29uc3QgdGlja3MzID0gaW50ZXJ2YWwgPyBpbnRlcnZhbC5yYW5nZShzdGFydCwgK3N0b3AgKyAxKSA6IFtdOwogICAgcmV0dXJuIHJldmVyc2UyID8gdGlja3MzLnJldmVyc2UoKSA6IHRpY2tzMzsKICB9CiAgZnVuY3Rpb24gdGlja0ludGVydmFsKHN0YXJ0LCBzdG9wLCBjb3VudCkgewogICAgY29uc3QgdGFyZ2V0ID0gTWF0aC5hYnMoc3RvcCAtIHN0YXJ0KSAvIGNvdW50OwogICAgY29uc3QgaSA9IGJpc2VjdG9yKChbLCAsIHN0ZXAyXSkgPT4gc3RlcDIpLnJpZ2h0KHRpY2tJbnRlcnZhbHMsIHRhcmdldCk7CiAgICBpZiAoaSA9PT0gdGlja0ludGVydmFscy5sZW5ndGgpIHJldHVybiB5ZWFyLmV2ZXJ5KHRpY2tTdGVwKHN0YXJ0IC8gZHVyYXRpb25ZZWFyLCBzdG9wIC8gZHVyYXRpb25ZZWFyLCBjb3VudCkpOwogICAgaWYgKGkgPT09IDApIHJldHVybiBtaWxsaXNlY29uZC5ldmVyeShNYXRoLm1heCh0aWNrU3RlcChzdGFydCwgc3RvcCwgY291bnQpLCAxKSk7CiAgICBjb25zdCBbdCwgc3RlcF0gPSB0aWNrSW50ZXJ2YWxzW3RhcmdldCAvIHRpY2tJbnRlcnZhbHNbaSAtIDFdWzJdIDwgdGlja0ludGVydmFsc1tpXVsyXSAvIHRhcmdldCA/IGkgLSAxIDogaV07CiAgICByZXR1cm4gdC5ldmVyeShzdGVwKTsKICB9CiAgcmV0dXJuIFt0aWNrczIsIHRpY2tJbnRlcnZhbF07Cn0KdmFyIFt1dGNUaWNrcywgdXRjVGlja0ludGVydmFsXSA9IHRpY2tlcih1dGNZZWFyLCB1dGNNb250aCwgdXRjU3VuZGF5LCB1bml4RGF5LCB1dGNIb3VyLCB1dGNNaW51dGUpOwp2YXIgW3RpbWVUaWNrcywgdGltZVRpY2tJbnRlcnZhbF0gPSB0aWNrZXIodGltZVllYXIsIHRpbWVNb250aCwgdGltZVN1bmRheSwgdGltZURheSwgdGltZUhvdXIsIHRpbWVNaW51dGUpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXRpbWUtZm9ybWF0QDQuMS4wL25vZGVfbW9kdWxlcy9kMy10aW1lLWZvcm1hdC9zcmMvbG9jYWxlLmpzCmZ1bmN0aW9uIGxvY2FsRGF0ZShkKSB7CiAgaWYgKDAgPD0gZC55ICYmIGQueSA8IDEwMCkgewogICAgdmFyIGRhdGUyID0gbmV3IERhdGUoLTEsIGQubSwgZC5kLCBkLkgsIGQuTSwgZC5TLCBkLkwpOwogICAgZGF0ZTIuc2V0RnVsbFllYXIoZC55KTsKICAgIHJldHVybiBkYXRlMjsKICB9CiAgcmV0dXJuIG5ldyBEYXRlKGQueSwgZC5tLCBkLmQsIGQuSCwgZC5NLCBkLlMsIGQuTCk7Cn0KZnVuY3Rpb24gdXRjRGF0ZShkKSB7CiAgaWYgKDAgPD0gZC55ICYmIGQueSA8IDEwMCkgewogICAgdmFyIGRhdGUyID0gbmV3IERhdGUoRGF0ZS5VVEMoLTEsIGQubSwgZC5kLCBkLkgsIGQuTSwgZC5TLCBkLkwpKTsKICAgIGRhdGUyLnNldFVUQ0Z1bGxZZWFyKGQueSk7CiAgICByZXR1cm4gZGF0ZTI7CiAgfQogIHJldHVybiBuZXcgRGF0ZShEYXRlLlVUQyhkLnksIGQubSwgZC5kLCBkLkgsIGQuTSwgZC5TLCBkLkwpKTsKfQpmdW5jdGlvbiBuZXdEYXRlKHkyLCBtLCBkKSB7CiAgcmV0dXJuIHsgeTogeTIsIG0sIGQsIEg6IDAsIE06IDAsIFM6IDAsIEw6IDAgfTsKfQpmdW5jdGlvbiBmb3JtYXRMb2NhbGUobG9jYWxlMykgewogIHZhciBsb2NhbGVfZGF0ZVRpbWUgPSBsb2NhbGUzLmRhdGVUaW1lLCBsb2NhbGVfZGF0ZSA9IGxvY2FsZTMuZGF0ZSwgbG9jYWxlX3RpbWUgPSBsb2NhbGUzLnRpbWUsIGxvY2FsZV9wZXJpb2RzID0gbG9jYWxlMy5wZXJpb2RzLCBsb2NhbGVfd2Vla2RheXMgPSBsb2NhbGUzLmRheXMsIGxvY2FsZV9zaG9ydFdlZWtkYXlzID0gbG9jYWxlMy5zaG9ydERheXMsIGxvY2FsZV9tb250aHMgPSBsb2NhbGUzLm1vbnRocywgbG9jYWxlX3Nob3J0TW9udGhzID0gbG9jYWxlMy5zaG9ydE1vbnRoczsKICB2YXIgcGVyaW9kUmUgPSBmb3JtYXRSZShsb2NhbGVfcGVyaW9kcyksIHBlcmlvZExvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfcGVyaW9kcyksIHdlZWtkYXlSZSA9IGZvcm1hdFJlKGxvY2FsZV93ZWVrZGF5cyksIHdlZWtkYXlMb29rdXAgPSBmb3JtYXRMb29rdXAobG9jYWxlX3dlZWtkYXlzKSwgc2hvcnRXZWVrZGF5UmUgPSBmb3JtYXRSZShsb2NhbGVfc2hvcnRXZWVrZGF5cyksIHNob3J0V2Vla2RheUxvb2t1cCA9IGZvcm1hdExvb2t1cChsb2NhbGVfc2hvcnRXZWVrZGF5cyksIG1vbnRoUmUgPSBmb3JtYXRSZShsb2NhbGVfbW9udGhzKSwgbW9udGhMb29rdXAgPSBmb3JtYXRMb29rdXAobG9jYWxlX21vbnRocyksIHNob3J0TW9udGhSZSA9IGZvcm1hdFJlKGxvY2FsZV9zaG9ydE1vbnRocyksIHNob3J0TW9udGhMb29rdXAgPSBmb3JtYXRMb29rdXAobG9jYWxlX3Nob3J0TW9udGhzKTsKICB2YXIgZm9ybWF0cyA9IHsKICAgICJhIjogZm9ybWF0U2hvcnRXZWVrZGF5LAogICAgIkEiOiBmb3JtYXRXZWVrZGF5LAogICAgImIiOiBmb3JtYXRTaG9ydE1vbnRoLAogICAgIkIiOiBmb3JtYXRNb250aCwKICAgICJjIjogbnVsbCwKICAgICJkIjogZm9ybWF0RGF5T2ZNb250aCwKICAgICJlIjogZm9ybWF0RGF5T2ZNb250aCwKICAgICJmIjogZm9ybWF0TWljcm9zZWNvbmRzLAogICAgImciOiBmb3JtYXRZZWFySVNPLAogICAgIkciOiBmb3JtYXRGdWxsWWVhcklTTywKICAgICJIIjogZm9ybWF0SG91cjI0LAogICAgIkkiOiBmb3JtYXRIb3VyMTIsCiAgICAiaiI6IGZvcm1hdERheU9mWWVhciwKICAgICJMIjogZm9ybWF0TWlsbGlzZWNvbmRzLAogICAgIm0iOiBmb3JtYXRNb250aE51bWJlciwKICAgICJNIjogZm9ybWF0TWludXRlcywKICAgICJwIjogZm9ybWF0UGVyaW9kLAogICAgInEiOiBmb3JtYXRRdWFydGVyLAogICAgIlEiOiBmb3JtYXRVbml4VGltZXN0YW1wLAogICAgInMiOiBmb3JtYXRVbml4VGltZXN0YW1wU2Vjb25kcywKICAgICJTIjogZm9ybWF0U2Vjb25kcywKICAgICJ1IjogZm9ybWF0V2Vla2RheU51bWJlck1vbmRheSwKICAgICJVIjogZm9ybWF0V2Vla051bWJlclN1bmRheSwKICAgICJWIjogZm9ybWF0V2Vla051bWJlcklTTywKICAgICJ3IjogZm9ybWF0V2Vla2RheU51bWJlclN1bmRheSwKICAgICJXIjogZm9ybWF0V2Vla051bWJlck1vbmRheSwKICAgICJ4IjogbnVsbCwKICAgICJYIjogbnVsbCwKICAgICJ5IjogZm9ybWF0WWVhciwKICAgICJZIjogZm9ybWF0RnVsbFllYXIsCiAgICAiWiI6IGZvcm1hdFpvbmUsCiAgICAiJSI6IGZvcm1hdExpdGVyYWxQZXJjZW50CiAgfTsKICB2YXIgdXRjRm9ybWF0cyA9IHsKICAgICJhIjogZm9ybWF0VVRDU2hvcnRXZWVrZGF5LAogICAgIkEiOiBmb3JtYXRVVENXZWVrZGF5LAogICAgImIiOiBmb3JtYXRVVENTaG9ydE1vbnRoLAogICAgIkIiOiBmb3JtYXRVVENNb250aCwKICAgICJjIjogbnVsbCwKICAgICJkIjogZm9ybWF0VVRDRGF5T2ZNb250aCwKICAgICJlIjogZm9ybWF0VVRDRGF5T2ZNb250aCwKICAgICJmIjogZm9ybWF0VVRDTWljcm9zZWNvbmRzLAogICAgImciOiBmb3JtYXRVVENZZWFySVNPLAogICAgIkciOiBmb3JtYXRVVENGdWxsWWVhcklTTywKICAgICJIIjogZm9ybWF0VVRDSG91cjI0LAogICAgIkkiOiBmb3JtYXRVVENIb3VyMTIsCiAgICAiaiI6IGZvcm1hdFVUQ0RheU9mWWVhciwKICAgICJMIjogZm9ybWF0VVRDTWlsbGlzZWNvbmRzLAogICAgIm0iOiBmb3JtYXRVVENNb250aE51bWJlciwKICAgICJNIjogZm9ybWF0VVRDTWludXRlcywKICAgICJwIjogZm9ybWF0VVRDUGVyaW9kLAogICAgInEiOiBmb3JtYXRVVENRdWFydGVyLAogICAgIlEiOiBmb3JtYXRVbml4VGltZXN0YW1wLAogICAgInMiOiBmb3JtYXRVbml4VGltZXN0YW1wU2Vjb25kcywKICAgICJTIjogZm9ybWF0VVRDU2Vjb25kcywKICAgICJ1IjogZm9ybWF0VVRDV2Vla2RheU51bWJlck1vbmRheSwKICAgICJVIjogZm9ybWF0VVRDV2Vla051bWJlclN1bmRheSwKICAgICJWIjogZm9ybWF0VVRDV2Vla051bWJlcklTTywKICAgICJ3IjogZm9ybWF0VVRDV2Vla2RheU51bWJlclN1bmRheSwKICAgICJXIjogZm9ybWF0VVRDV2Vla051bWJlck1vbmRheSwKICAgICJ4IjogbnVsbCwKICAgICJYIjogbnVsbCwKICAgICJ5IjogZm9ybWF0VVRDWWVhciwKICAgICJZIjogZm9ybWF0VVRDRnVsbFllYXIsCiAgICAiWiI6IGZvcm1hdFVUQ1pvbmUsCiAgICAiJSI6IGZvcm1hdExpdGVyYWxQZXJjZW50CiAgfTsKICB2YXIgcGFyc2VzID0gewogICAgImEiOiBwYXJzZVNob3J0V2Vla2RheSwKICAgICJBIjogcGFyc2VXZWVrZGF5LAogICAgImIiOiBwYXJzZVNob3J0TW9udGgsCiAgICAiQiI6IHBhcnNlTW9udGgsCiAgICAiYyI6IHBhcnNlTG9jYWxlRGF0ZVRpbWUsCiAgICAiZCI6IHBhcnNlRGF5T2ZNb250aCwKICAgICJlIjogcGFyc2VEYXlPZk1vbnRoLAogICAgImYiOiBwYXJzZU1pY3Jvc2Vjb25kcywKICAgICJnIjogcGFyc2VZZWFyLAogICAgIkciOiBwYXJzZUZ1bGxZZWFyLAogICAgIkgiOiBwYXJzZUhvdXIyNCwKICAgICJJIjogcGFyc2VIb3VyMjQsCiAgICAiaiI6IHBhcnNlRGF5T2ZZZWFyLAogICAgIkwiOiBwYXJzZU1pbGxpc2Vjb25kcywKICAgICJtIjogcGFyc2VNb250aE51bWJlciwKICAgICJNIjogcGFyc2VNaW51dGVzLAogICAgInAiOiBwYXJzZVBlcmlvZCwKICAgICJxIjogcGFyc2VRdWFydGVyLAogICAgIlEiOiBwYXJzZVVuaXhUaW1lc3RhbXAsCiAgICAicyI6IHBhcnNlVW5peFRpbWVzdGFtcFNlY29uZHMsCiAgICAiUyI6IHBhcnNlU2Vjb25kcywKICAgICJ1IjogcGFyc2VXZWVrZGF5TnVtYmVyTW9uZGF5LAogICAgIlUiOiBwYXJzZVdlZWtOdW1iZXJTdW5kYXksCiAgICAiViI6IHBhcnNlV2Vla051bWJlcklTTywKICAgICJ3IjogcGFyc2VXZWVrZGF5TnVtYmVyU3VuZGF5LAogICAgIlciOiBwYXJzZVdlZWtOdW1iZXJNb25kYXksCiAgICAieCI6IHBhcnNlTG9jYWxlRGF0ZSwKICAgICJYIjogcGFyc2VMb2NhbGVUaW1lLAogICAgInkiOiBwYXJzZVllYXIsCiAgICAiWSI6IHBhcnNlRnVsbFllYXIsCiAgICAiWiI6IHBhcnNlWm9uZSwKICAgICIlIjogcGFyc2VMaXRlcmFsUGVyY2VudAogIH07CiAgZm9ybWF0cy54ID0gbmV3Rm9ybWF0KGxvY2FsZV9kYXRlLCBmb3JtYXRzKTsKICBmb3JtYXRzLlggPSBuZXdGb3JtYXQobG9jYWxlX3RpbWUsIGZvcm1hdHMpOwogIGZvcm1hdHMuYyA9IG5ld0Zvcm1hdChsb2NhbGVfZGF0ZVRpbWUsIGZvcm1hdHMpOwogIHV0Y0Zvcm1hdHMueCA9IG5ld0Zvcm1hdChsb2NhbGVfZGF0ZSwgdXRjRm9ybWF0cyk7CiAgdXRjRm9ybWF0cy5YID0gbmV3Rm9ybWF0KGxvY2FsZV90aW1lLCB1dGNGb3JtYXRzKTsKICB1dGNGb3JtYXRzLmMgPSBuZXdGb3JtYXQobG9jYWxlX2RhdGVUaW1lLCB1dGNGb3JtYXRzKTsKICBmdW5jdGlvbiBuZXdGb3JtYXQoc3BlY2lmaWVyLCBmb3JtYXRzMikgewogICAgcmV0dXJuIGZ1bmN0aW9uKGRhdGUyKSB7CiAgICAgIHZhciBzdHJpbmcgPSBbXSwgaSA9IC0xLCBqID0gMCwgbiA9IHNwZWNpZmllci5sZW5ndGgsIGMsIHBhZDIsIGZvcm1hdDI7CiAgICAgIGlmICghKGRhdGUyIGluc3RhbmNlb2YgRGF0ZSkpIGRhdGUyID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCtkYXRlMik7CiAgICAgIHdoaWxlICgrK2kgPCBuKSB7CiAgICAgICAgaWYgKHNwZWNpZmllci5jaGFyQ29kZUF0KGkpID09PSAzNykgewogICAgICAgICAgc3RyaW5nLnB1c2goc3BlY2lmaWVyLnNsaWNlKGosIGkpKTsKICAgICAgICAgIGlmICgocGFkMiA9IHBhZHNbYyA9IHNwZWNpZmllci5jaGFyQXQoKytpKV0pICE9IG51bGwpIGMgPSBzcGVjaWZpZXIuY2hhckF0KCsraSk7CiAgICAgICAgICBlbHNlIHBhZDIgPSBjID09PSAiZSIgPyAiICIgOiAiMCI7CiAgICAgICAgICBpZiAoZm9ybWF0MiA9IGZvcm1hdHMyW2NdKSBjID0gZm9ybWF0MihkYXRlMiwgcGFkMik7CiAgICAgICAgICBzdHJpbmcucHVzaChjKTsKICAgICAgICAgIGogPSBpICsgMTsKICAgICAgICB9CiAgICAgIH0KICAgICAgc3RyaW5nLnB1c2goc3BlY2lmaWVyLnNsaWNlKGosIGkpKTsKICAgICAgcmV0dXJuIHN0cmluZy5qb2luKCIiKTsKICAgIH07CiAgfQogIGZ1bmN0aW9uIG5ld1BhcnNlKHNwZWNpZmllciwgWikgewogICAgcmV0dXJuIGZ1bmN0aW9uKHN0cmluZykgewogICAgICB2YXIgZCA9IG5ld0RhdGUoMTkwMCwgdm9pZCAwLCAxKSwgaSA9IHBhcnNlU3BlY2lmaWVyKGQsIHNwZWNpZmllciwgc3RyaW5nICs9ICIiLCAwKSwgd2VlaywgZGF5OwogICAgICBpZiAoaSAhPSBzdHJpbmcubGVuZ3RoKSByZXR1cm4gbnVsbDsKICAgICAgaWYgKCJRIiBpbiBkKSByZXR1cm4gbmV3IERhdGUoZC5RKTsKICAgICAgaWYgKCJzIiBpbiBkKSByZXR1cm4gbmV3IERhdGUoZC5zICogMWUzICsgKCJMIiBpbiBkID8gZC5MIDogMCkpOwogICAgICBpZiAoWiAmJiAhKCJaIiBpbiBkKSkgZC5aID0gMDsKICAgICAgaWYgKCJwIiBpbiBkKSBkLkggPSBkLkggJSAxMiArIGQucCAqIDEyOwogICAgICBpZiAoZC5tID09PSB2b2lkIDApIGQubSA9ICJxIiBpbiBkID8gZC5xIDogMDsKICAgICAgaWYgKCJWIiBpbiBkKSB7CiAgICAgICAgaWYgKGQuViA8IDEgfHwgZC5WID4gNTMpIHJldHVybiBudWxsOwogICAgICAgIGlmICghKCJ3IiBpbiBkKSkgZC53ID0gMTsKICAgICAgICBpZiAoIloiIGluIGQpIHsKICAgICAgICAgIHdlZWsgPSB1dGNEYXRlKG5ld0RhdGUoZC55LCAwLCAxKSksIGRheSA9IHdlZWsuZ2V0VVRDRGF5KCk7CiAgICAgICAgICB3ZWVrID0gZGF5ID4gNCB8fCBkYXkgPT09IDAgPyB1dGNNb25kYXkuY2VpbCh3ZWVrKSA6IHV0Y01vbmRheSh3ZWVrKTsKICAgICAgICAgIHdlZWsgPSB1dGNEYXkub2Zmc2V0KHdlZWssIChkLlYgLSAxKSAqIDcpOwogICAgICAgICAgZC55ID0gd2Vlay5nZXRVVENGdWxsWWVhcigpOwogICAgICAgICAgZC5tID0gd2Vlay5nZXRVVENNb250aCgpOwogICAgICAgICAgZC5kID0gd2Vlay5nZXRVVENEYXRlKCkgKyAoZC53ICsgNikgJSA3OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3ZWVrID0gbG9jYWxEYXRlKG5ld0RhdGUoZC55LCAwLCAxKSksIGRheSA9IHdlZWsuZ2V0RGF5KCk7CiAgICAgICAgICB3ZWVrID0gZGF5ID4gNCB8fCBkYXkgPT09IDAgPyB0aW1lTW9uZGF5LmNlaWwod2VlaykgOiB0aW1lTW9uZGF5KHdlZWspOwogICAgICAgICAgd2VlayA9IHRpbWVEYXkub2Zmc2V0KHdlZWssIChkLlYgLSAxKSAqIDcpOwogICAgICAgICAgZC55ID0gd2Vlay5nZXRGdWxsWWVhcigpOwogICAgICAgICAgZC5tID0gd2Vlay5nZXRNb250aCgpOwogICAgICAgICAgZC5kID0gd2Vlay5nZXREYXRlKCkgKyAoZC53ICsgNikgJSA3OwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICgiVyIgaW4gZCB8fCAiVSIgaW4gZCkgewogICAgICAgIGlmICghKCJ3IiBpbiBkKSkgZC53ID0gInUiIGluIGQgPyBkLnUgJSA3IDogIlciIGluIGQgPyAxIDogMDsKICAgICAgICBkYXkgPSAiWiIgaW4gZCA/IHV0Y0RhdGUobmV3RGF0ZShkLnksIDAsIDEpKS5nZXRVVENEYXkoKSA6IGxvY2FsRGF0ZShuZXdEYXRlKGQueSwgMCwgMSkpLmdldERheSgpOwogICAgICAgIGQubSA9IDA7CiAgICAgICAgZC5kID0gIlciIGluIGQgPyAoZC53ICsgNikgJSA3ICsgZC5XICogNyAtIChkYXkgKyA1KSAlIDcgOiBkLncgKyBkLlUgKiA3IC0gKGRheSArIDYpICUgNzsKICAgICAgfQogICAgICBpZiAoIloiIGluIGQpIHsKICAgICAgICBkLkggKz0gZC5aIC8gMTAwIHwgMDsKICAgICAgICBkLk0gKz0gZC5aICUgMTAwOwogICAgICAgIHJldHVybiB1dGNEYXRlKGQpOwogICAgICB9CiAgICAgIHJldHVybiBsb2NhbERhdGUoZCk7CiAgICB9OwogIH0KICBmdW5jdGlvbiBwYXJzZVNwZWNpZmllcihkLCBzcGVjaWZpZXIsIHN0cmluZywgaikgewogICAgdmFyIGkgPSAwLCBuID0gc3BlY2lmaWVyLmxlbmd0aCwgbSA9IHN0cmluZy5sZW5ndGgsIGMsIHBhcnNlOwogICAgd2hpbGUgKGkgPCBuKSB7CiAgICAgIGlmIChqID49IG0pIHJldHVybiAtMTsKICAgICAgYyA9IHNwZWNpZmllci5jaGFyQ29kZUF0KGkrKyk7CiAgICAgIGlmIChjID09PSAzNykgewogICAgICAgIGMgPSBzcGVjaWZpZXIuY2hhckF0KGkrKyk7CiAgICAgICAgcGFyc2UgPSBwYXJzZXNbYyBpbiBwYWRzID8gc3BlY2lmaWVyLmNoYXJBdChpKyspIDogY107CiAgICAgICAgaWYgKCFwYXJzZSB8fCAoaiA9IHBhcnNlKGQsIHN0cmluZywgaikpIDwgMCkgcmV0dXJuIC0xOwogICAgICB9IGVsc2UgaWYgKGMgIT0gc3RyaW5nLmNoYXJDb2RlQXQoaisrKSkgewogICAgICAgIHJldHVybiAtMTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGo7CiAgfQogIGZ1bmN0aW9uIHBhcnNlUGVyaW9kKGQsIHN0cmluZywgaSkgewogICAgdmFyIG4gPSBwZXJpb2RSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgICByZXR1cm4gbiA/IChkLnAgPSBwZXJpb2RMb29rdXAuZ2V0KG5bMF0udG9Mb3dlckNhc2UoKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKICB9CiAgZnVuY3Rpb24gcGFyc2VTaG9ydFdlZWtkYXkoZCwgc3RyaW5nLCBpKSB7CiAgICB2YXIgbiA9IHNob3J0V2Vla2RheVJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICAgIHJldHVybiBuID8gKGQudyA9IHNob3J0V2Vla2RheUxvb2t1cC5nZXQoblswXS50b0xvd2VyQ2FzZSgpKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwogIH0KICBmdW5jdGlvbiBwYXJzZVdlZWtkYXkoZCwgc3RyaW5nLCBpKSB7CiAgICB2YXIgbiA9IHdlZWtkYXlSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgICByZXR1cm4gbiA/IChkLncgPSB3ZWVrZGF5TG9va3VwLmdldChuWzBdLnRvTG93ZXJDYXNlKCkpLCBpICsgblswXS5sZW5ndGgpIDogLTE7CiAgfQogIGZ1bmN0aW9uIHBhcnNlU2hvcnRNb250aChkLCBzdHJpbmcsIGkpIHsKICAgIHZhciBuID0gc2hvcnRNb250aFJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICAgIHJldHVybiBuID8gKGQubSA9IHNob3J0TW9udGhMb29rdXAuZ2V0KG5bMF0udG9Mb3dlckNhc2UoKSksIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKICB9CiAgZnVuY3Rpb24gcGFyc2VNb250aChkLCBzdHJpbmcsIGkpIHsKICAgIHZhciBuID0gbW9udGhSZS5leGVjKHN0cmluZy5zbGljZShpKSk7CiAgICByZXR1cm4gbiA/IChkLm0gPSBtb250aExvb2t1cC5nZXQoblswXS50b0xvd2VyQ2FzZSgpKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwogIH0KICBmdW5jdGlvbiBwYXJzZUxvY2FsZURhdGVUaW1lKGQsIHN0cmluZywgaSkgewogICAgcmV0dXJuIHBhcnNlU3BlY2lmaWVyKGQsIGxvY2FsZV9kYXRlVGltZSwgc3RyaW5nLCBpKTsKICB9CiAgZnVuY3Rpb24gcGFyc2VMb2NhbGVEYXRlKGQsIHN0cmluZywgaSkgewogICAgcmV0dXJuIHBhcnNlU3BlY2lmaWVyKGQsIGxvY2FsZV9kYXRlLCBzdHJpbmcsIGkpOwogIH0KICBmdW5jdGlvbiBwYXJzZUxvY2FsZVRpbWUoZCwgc3RyaW5nLCBpKSB7CiAgICByZXR1cm4gcGFyc2VTcGVjaWZpZXIoZCwgbG9jYWxlX3RpbWUsIHN0cmluZywgaSk7CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFNob3J0V2Vla2RheShkKSB7CiAgICByZXR1cm4gbG9jYWxlX3Nob3J0V2Vla2RheXNbZC5nZXREYXkoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFdlZWtkYXkoZCkgewogICAgcmV0dXJuIGxvY2FsZV93ZWVrZGF5c1tkLmdldERheSgpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0U2hvcnRNb250aChkKSB7CiAgICByZXR1cm4gbG9jYWxlX3Nob3J0TW9udGhzW2QuZ2V0TW9udGgoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdE1vbnRoKGQpIHsKICAgIHJldHVybiBsb2NhbGVfbW9udGhzW2QuZ2V0TW9udGgoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFBlcmlvZChkKSB7CiAgICByZXR1cm4gbG9jYWxlX3BlcmlvZHNbKyhkLmdldEhvdXJzKCkgPj0gMTIpXTsKICB9CiAgZnVuY3Rpb24gZm9ybWF0UXVhcnRlcihkKSB7CiAgICByZXR1cm4gMSArIH5+KGQuZ2V0TW9udGgoKSAvIDMpOwogIH0KICBmdW5jdGlvbiBmb3JtYXRVVENTaG9ydFdlZWtkYXkoZCkgewogICAgcmV0dXJuIGxvY2FsZV9zaG9ydFdlZWtkYXlzW2QuZ2V0VVRDRGF5KCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRVVENXZWVrZGF5KGQpIHsKICAgIHJldHVybiBsb2NhbGVfd2Vla2RheXNbZC5nZXRVVENEYXkoKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1Nob3J0TW9udGgoZCkgewogICAgcmV0dXJuIGxvY2FsZV9zaG9ydE1vbnRoc1tkLmdldFVUQ01vbnRoKCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRVVENNb250aChkKSB7CiAgICByZXR1cm4gbG9jYWxlX21vbnRoc1tkLmdldFVUQ01vbnRoKCldOwogIH0KICBmdW5jdGlvbiBmb3JtYXRVVENQZXJpb2QoZCkgewogICAgcmV0dXJuIGxvY2FsZV9wZXJpb2RzWysoZC5nZXRVVENIb3VycygpID49IDEyKV07CiAgfQogIGZ1bmN0aW9uIGZvcm1hdFVUQ1F1YXJ0ZXIoZCkgewogICAgcmV0dXJuIDEgKyB+fihkLmdldFVUQ01vbnRoKCkgLyAzKTsKICB9CiAgcmV0dXJuIHsKICAgIGZvcm1hdDogZnVuY3Rpb24oc3BlY2lmaWVyKSB7CiAgICAgIHZhciBmID0gbmV3Rm9ybWF0KHNwZWNpZmllciArPSAiIiwgZm9ybWF0cyk7CiAgICAgIGYudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc3BlY2lmaWVyOwogICAgICB9OwogICAgICByZXR1cm4gZjsKICAgIH0sCiAgICBwYXJzZTogZnVuY3Rpb24oc3BlY2lmaWVyKSB7CiAgICAgIHZhciBwID0gbmV3UGFyc2Uoc3BlY2lmaWVyICs9ICIiLCBmYWxzZSk7CiAgICAgIHAudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc3BlY2lmaWVyOwogICAgICB9OwogICAgICByZXR1cm4gcDsKICAgIH0sCiAgICB1dGNGb3JtYXQ6IGZ1bmN0aW9uKHNwZWNpZmllcikgewogICAgICB2YXIgZiA9IG5ld0Zvcm1hdChzcGVjaWZpZXIgKz0gIiIsIHV0Y0Zvcm1hdHMpOwogICAgICBmLnRvU3RyaW5nID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHNwZWNpZmllcjsKICAgICAgfTsKICAgICAgcmV0dXJuIGY7CiAgICB9LAogICAgdXRjUGFyc2U6IGZ1bmN0aW9uKHNwZWNpZmllcikgewogICAgICB2YXIgcCA9IG5ld1BhcnNlKHNwZWNpZmllciArPSAiIiwgdHJ1ZSk7CiAgICAgIHAudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gc3BlY2lmaWVyOwogICAgICB9OwogICAgICByZXR1cm4gcDsKICAgIH0KICB9Owp9CnZhciBwYWRzID0geyAiLSI6ICIiLCAiXyI6ICIgIiwgIjAiOiAiMCIgfTsKdmFyIG51bWJlclJlID0gL15ccypcZCsvOwp2YXIgcGVyY2VudFJlID0gL14lLzsKdmFyIHJlcXVvdGVSZSA9IC9bXFxeJCorP3xbXF0oKS57fV0vZzsKZnVuY3Rpb24gcGFkKHZhbHVlLCBmaWxsLCB3aWR0aCkgewogIHZhciBzaWduMiA9IHZhbHVlIDwgMCA/ICItIiA6ICIiLCBzdHJpbmcgPSAoc2lnbjIgPyAtdmFsdWUgOiB2YWx1ZSkgKyAiIiwgbGVuZ3RoID0gc3RyaW5nLmxlbmd0aDsKICByZXR1cm4gc2lnbjIgKyAobGVuZ3RoIDwgd2lkdGggPyBuZXcgQXJyYXkod2lkdGggLSBsZW5ndGggKyAxKS5qb2luKGZpbGwpICsgc3RyaW5nIDogc3RyaW5nKTsKfQpmdW5jdGlvbiByZXF1b3RlKHMpIHsKICByZXR1cm4gcy5yZXBsYWNlKHJlcXVvdGVSZSwgIlxcJCYiKTsKfQpmdW5jdGlvbiBmb3JtYXRSZShuYW1lcykgewogIHJldHVybiBuZXcgUmVnRXhwKCJeKD86IiArIG5hbWVzLm1hcChyZXF1b3RlKS5qb2luKCJ8IikgKyAiKSIsICJpIik7Cn0KZnVuY3Rpb24gZm9ybWF0TG9va3VwKG5hbWVzKSB7CiAgcmV0dXJuIG5ldyBNYXAobmFtZXMubWFwKChuYW1lLCBpKSA9PiBbbmFtZS50b0xvd2VyQ2FzZSgpLCBpXSkpOwp9CmZ1bmN0aW9uIHBhcnNlV2Vla2RheU51bWJlclN1bmRheShkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAxKSk7CiAgcmV0dXJuIG4gPyAoZC53ID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVdlZWtkYXlOdW1iZXJNb25kYXkoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMSkpOwogIHJldHVybiBuID8gKGQudSA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VXZWVrTnVtYmVyU3VuZGF5KGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLlUgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlV2Vla051bWJlcklTTyhkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5WID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVdlZWtOdW1iZXJNb25kYXkoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuVyA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VGdWxsWWVhcihkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyA0KSk7CiAgcmV0dXJuIG4gPyAoZC55ID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZVllYXIoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQueSA9ICtuWzBdICsgKCtuWzBdID4gNjggPyAxOTAwIDogMmUzKSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlWm9uZShkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IC9eKFopfChbKy1dXGRcZCkoPzo6PyhcZFxkKSk/Ly5leGVjKHN0cmluZy5zbGljZShpLCBpICsgNikpOwogIHJldHVybiBuID8gKGQuWiA9IG5bMV0gPyAwIDogLShuWzJdICsgKG5bM10gfHwgIjAwIikpLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VRdWFydGVyKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDEpKTsKICByZXR1cm4gbiA/IChkLnEgPSBuWzBdICogMyAtIDMsIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZU1vbnRoTnVtYmVyKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLm0gPSBuWzBdIC0gMSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlRGF5T2ZNb250aChkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5kID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZURheU9mWWVhcihkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAzKSk7CiAgcmV0dXJuIG4gPyAoZC5tID0gMCwgZC5kID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZUhvdXIyNChkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGksIGkgKyAyKSk7CiAgcmV0dXJuIG4gPyAoZC5IID0gK25bMF0sIGkgKyBuWzBdLmxlbmd0aCkgOiAtMTsKfQpmdW5jdGlvbiBwYXJzZU1pbnV0ZXMoZCwgc3RyaW5nLCBpKSB7CiAgdmFyIG4gPSBudW1iZXJSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMikpOwogIHJldHVybiBuID8gKGQuTSA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VTZWNvbmRzKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDIpKTsKICByZXR1cm4gbiA/IChkLlMgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlTWlsbGlzZWNvbmRzKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDMpKTsKICByZXR1cm4gbiA/IChkLkwgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIHBhcnNlTWljcm9zZWNvbmRzKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSwgaSArIDYpKTsKICByZXR1cm4gbiA/IChkLkwgPSBNYXRoLmZsb29yKG5bMF0gLyAxZTMpLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VMaXRlcmFsUGVyY2VudChkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IHBlcmNlbnRSZS5leGVjKHN0cmluZy5zbGljZShpLCBpICsgMSkpOwogIHJldHVybiBuID8gaSArIG5bMF0ubGVuZ3RoIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VVbml4VGltZXN0YW1wKGQsIHN0cmluZywgaSkgewogIHZhciBuID0gbnVtYmVyUmUuZXhlYyhzdHJpbmcuc2xpY2UoaSkpOwogIHJldHVybiBuID8gKGQuUSA9ICtuWzBdLCBpICsgblswXS5sZW5ndGgpIDogLTE7Cn0KZnVuY3Rpb24gcGFyc2VVbml4VGltZXN0YW1wU2Vjb25kcyhkLCBzdHJpbmcsIGkpIHsKICB2YXIgbiA9IG51bWJlclJlLmV4ZWMoc3RyaW5nLnNsaWNlKGkpKTsKICByZXR1cm4gbiA/IChkLnMgPSArblswXSwgaSArIG5bMF0ubGVuZ3RoKSA6IC0xOwp9CmZ1bmN0aW9uIGZvcm1hdERheU9mTW9udGgoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXREYXRlKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdEhvdXIyNChkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldEhvdXJzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdEhvdXIxMihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldEhvdXJzKCkgJSAxMiB8fCAxMiwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0RGF5T2ZZZWFyKGQsIHApIHsKICByZXR1cm4gcGFkKDEgKyB0aW1lRGF5LmNvdW50KHRpbWVZZWFyKGQpLCBkKSwgcCwgMyk7Cn0KZnVuY3Rpb24gZm9ybWF0TWlsbGlzZWNvbmRzKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0TWlsbGlzZWNvbmRzKCksIHAsIDMpOwp9CmZ1bmN0aW9uIGZvcm1hdE1pY3Jvc2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIGZvcm1hdE1pbGxpc2Vjb25kcyhkLCBwKSArICIwMDAiOwp9CmZ1bmN0aW9uIGZvcm1hdE1vbnRoTnVtYmVyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0TW9udGgoKSArIDEsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdE1pbnV0ZXMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRNaW51dGVzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFNlY29uZHMoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRTZWNvbmRzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFdlZWtkYXlOdW1iZXJNb25kYXkoZCkgewogIHZhciBkYXkgPSBkLmdldERheSgpOwogIHJldHVybiBkYXkgPT09IDAgPyA3IDogZGF5Owp9CmZ1bmN0aW9uIGZvcm1hdFdlZWtOdW1iZXJTdW5kYXkoZCwgcCkgewogIHJldHVybiBwYWQodGltZVN1bmRheS5jb3VudCh0aW1lWWVhcihkKSAtIDEsIGQpLCBwLCAyKTsKfQpmdW5jdGlvbiBkSVNPKGQpIHsKICB2YXIgZGF5ID0gZC5nZXREYXkoKTsKICByZXR1cm4gZGF5ID49IDQgfHwgZGF5ID09PSAwID8gdGltZVRodXJzZGF5KGQpIDogdGltZVRodXJzZGF5LmNlaWwoZCk7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla051bWJlcklTTyhkLCBwKSB7CiAgZCA9IGRJU08oZCk7CiAgcmV0dXJuIHBhZCh0aW1lVGh1cnNkYXkuY291bnQodGltZVllYXIoZCksIGQpICsgKHRpbWVZZWFyKGQpLmdldERheSgpID09PSA0KSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla2RheU51bWJlclN1bmRheShkKSB7CiAgcmV0dXJuIGQuZ2V0RGF5KCk7Cn0KZnVuY3Rpb24gZm9ybWF0V2Vla051bWJlck1vbmRheShkLCBwKSB7CiAgcmV0dXJuIHBhZCh0aW1lTW9uZGF5LmNvdW50KHRpbWVZZWFyKGQpIC0gMSwgZCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFllYXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRGdWxsWWVhcigpICUgMTAwLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRZZWFySVNPKGQsIHApIHsKICBkID0gZElTTyhkKTsKICByZXR1cm4gcGFkKGQuZ2V0RnVsbFllYXIoKSAlIDEwMCwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0RnVsbFllYXIoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRGdWxsWWVhcigpICUgMWU0LCBwLCA0KTsKfQpmdW5jdGlvbiBmb3JtYXRGdWxsWWVhcklTTyhkLCBwKSB7CiAgdmFyIGRheSA9IGQuZ2V0RGF5KCk7CiAgZCA9IGRheSA+PSA0IHx8IGRheSA9PT0gMCA/IHRpbWVUaHVyc2RheShkKSA6IHRpbWVUaHVyc2RheS5jZWlsKGQpOwogIHJldHVybiBwYWQoZC5nZXRGdWxsWWVhcigpICUgMWU0LCBwLCA0KTsKfQpmdW5jdGlvbiBmb3JtYXRab25lKGQpIHsKICB2YXIgeiA9IGQuZ2V0VGltZXpvbmVPZmZzZXQoKTsKICByZXR1cm4gKHogPiAwID8gIi0iIDogKHogKj0gLTEsICIrIikpICsgcGFkKHogLyA2MCB8IDAsICIwIiwgMikgKyBwYWQoeiAlIDYwLCAiMCIsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ0RheU9mTW9udGgoZCwgcCkgewogIHJldHVybiBwYWQoZC5nZXRVVENEYXRlKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ0hvdXIyNChkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0hvdXJzKCksIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ0hvdXIxMihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0hvdXJzKCkgJSAxMiB8fCAxMiwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDRGF5T2ZZZWFyKGQsIHApIHsKICByZXR1cm4gcGFkKDEgKyB1dGNEYXkuY291bnQodXRjWWVhcihkKSwgZCksIHAsIDMpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ01pbGxpc2Vjb25kcyhkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ01pbGxpc2Vjb25kcygpLCBwLCAzKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENNaWNyb3NlY29uZHMoZCwgcCkgewogIHJldHVybiBmb3JtYXRVVENNaWxsaXNlY29uZHMoZCwgcCkgKyAiMDAwIjsKfQpmdW5jdGlvbiBmb3JtYXRVVENNb250aE51bWJlcihkLCBwKSB7CiAgcmV0dXJuIHBhZChkLmdldFVUQ01vbnRoKCkgKyAxLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENNaW51dGVzKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDTWludXRlcygpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENTZWNvbmRzKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDU2Vjb25kcygpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrZGF5TnVtYmVyTW9uZGF5KGQpIHsKICB2YXIgZG93ID0gZC5nZXRVVENEYXkoKTsKICByZXR1cm4gZG93ID09PSAwID8gNyA6IGRvdzsKfQpmdW5jdGlvbiBmb3JtYXRVVENXZWVrTnVtYmVyU3VuZGF5KGQsIHApIHsKICByZXR1cm4gcGFkKHV0Y1N1bmRheS5jb3VudCh1dGNZZWFyKGQpIC0gMSwgZCksIHAsIDIpOwp9CmZ1bmN0aW9uIFVUQ2RJU08oZCkgewogIHZhciBkYXkgPSBkLmdldFVUQ0RheSgpOwogIHJldHVybiBkYXkgPj0gNCB8fCBkYXkgPT09IDAgPyB1dGNUaHVyc2RheShkKSA6IHV0Y1RodXJzZGF5LmNlaWwoZCk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDV2Vla051bWJlcklTTyhkLCBwKSB7CiAgZCA9IFVUQ2RJU08oZCk7CiAgcmV0dXJuIHBhZCh1dGNUaHVyc2RheS5jb3VudCh1dGNZZWFyKGQpLCBkKSArICh1dGNZZWFyKGQpLmdldFVUQ0RheSgpID09PSA0KSwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDV2Vla2RheU51bWJlclN1bmRheShkKSB7CiAgcmV0dXJuIGQuZ2V0VVRDRGF5KCk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDV2Vla051bWJlck1vbmRheShkLCBwKSB7CiAgcmV0dXJuIHBhZCh1dGNNb25kYXkuY291bnQodXRjWWVhcihkKSAtIDEsIGQpLCBwLCAyKTsKfQpmdW5jdGlvbiBmb3JtYXRVVENZZWFyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDRnVsbFllYXIoKSAlIDEwMCwgcCwgMik7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDWWVhcklTTyhkLCBwKSB7CiAgZCA9IFVUQ2RJU08oZCk7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0Z1bGxZZWFyKCkgJSAxMDAsIHAsIDIpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ0Z1bGxZZWFyKGQsIHApIHsKICByZXR1cm4gcGFkKGQuZ2V0VVRDRnVsbFllYXIoKSAlIDFlNCwgcCwgNCk7Cn0KZnVuY3Rpb24gZm9ybWF0VVRDRnVsbFllYXJJU08oZCwgcCkgewogIHZhciBkYXkgPSBkLmdldFVUQ0RheSgpOwogIGQgPSBkYXkgPj0gNCB8fCBkYXkgPT09IDAgPyB1dGNUaHVyc2RheShkKSA6IHV0Y1RodXJzZGF5LmNlaWwoZCk7CiAgcmV0dXJuIHBhZChkLmdldFVUQ0Z1bGxZZWFyKCkgJSAxZTQsIHAsIDQpOwp9CmZ1bmN0aW9uIGZvcm1hdFVUQ1pvbmUoKSB7CiAgcmV0dXJuICIrMDAwMCI7Cn0KZnVuY3Rpb24gZm9ybWF0TGl0ZXJhbFBlcmNlbnQoKSB7CiAgcmV0dXJuICIlIjsKfQpmdW5jdGlvbiBmb3JtYXRVbml4VGltZXN0YW1wKGQpIHsKICByZXR1cm4gK2Q7Cn0KZnVuY3Rpb24gZm9ybWF0VW5peFRpbWVzdGFtcFNlY29uZHMoZCkgewogIHJldHVybiBNYXRoLmZsb29yKCtkIC8gMWUzKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXRpbWUtZm9ybWF0QDQuMS4wL25vZGVfbW9kdWxlcy9kMy10aW1lLWZvcm1hdC9zcmMvZGVmYXVsdExvY2FsZS5qcwp2YXIgbG9jYWxlMjsKdmFyIHRpbWVGb3JtYXQ7CnZhciB0aW1lUGFyc2U7CnZhciB1dGNGb3JtYXQ7CnZhciB1dGNQYXJzZTsKZGVmYXVsdExvY2FsZTIoewogIGRhdGVUaW1lOiAiJXgsICVYIiwKICBkYXRlOiAiJS1tLyUtZC8lWSIsCiAgdGltZTogIiUtSTolTTolUyAlcCIsCiAgcGVyaW9kczogWyJBTSIsICJQTSJdLAogIGRheXM6IFsiU3VuZGF5IiwgIk1vbmRheSIsICJUdWVzZGF5IiwgIldlZG5lc2RheSIsICJUaHVyc2RheSIsICJGcmlkYXkiLCAiU2F0dXJkYXkiXSwKICBzaG9ydERheXM6IFsiU3VuIiwgIk1vbiIsICJUdWUiLCAiV2VkIiwgIlRodSIsICJGcmkiLCAiU2F0Il0sCiAgbW9udGhzOiBbIkphbnVhcnkiLCAiRmVicnVhcnkiLCAiTWFyY2giLCAiQXByaWwiLCAiTWF5IiwgIkp1bmUiLCAiSnVseSIsICJBdWd1c3QiLCAiU2VwdGVtYmVyIiwgIk9jdG9iZXIiLCAiTm92ZW1iZXIiLCAiRGVjZW1iZXIiXSwKICBzaG9ydE1vbnRoczogWyJKYW4iLCAiRmViIiwgIk1hciIsICJBcHIiLCAiTWF5IiwgIkp1biIsICJKdWwiLCAiQXVnIiwgIlNlcCIsICJPY3QiLCAiTm92IiwgIkRlYyJdCn0pOwpmdW5jdGlvbiBkZWZhdWx0TG9jYWxlMihkZWZpbml0aW9uKSB7CiAgbG9jYWxlMiA9IGZvcm1hdExvY2FsZShkZWZpbml0aW9uKTsKICB0aW1lRm9ybWF0ID0gbG9jYWxlMi5mb3JtYXQ7CiAgdGltZVBhcnNlID0gbG9jYWxlMi5wYXJzZTsKICB1dGNGb3JtYXQgPSBsb2NhbGUyLnV0Y0Zvcm1hdDsKICB1dGNQYXJzZSA9IGxvY2FsZTIudXRjUGFyc2U7CiAgcmV0dXJuIGxvY2FsZTI7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3RpbWUuanMKZnVuY3Rpb24gZGF0ZSh0KSB7CiAgcmV0dXJuIG5ldyBEYXRlKHQpOwp9CmZ1bmN0aW9uIG51bWJlcjModCkgewogIHJldHVybiB0IGluc3RhbmNlb2YgRGF0ZSA/ICt0IDogKy8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgrdCk7Cn0KZnVuY3Rpb24gY2FsZW5kYXIodGlja3MyLCB0aWNrSW50ZXJ2YWwsIHllYXIsIG1vbnRoLCB3ZWVrLCBkYXksIGhvdXIsIG1pbnV0ZSwgc2Vjb25kMiwgZm9ybWF0MikgewogIHZhciBzY2FsZSA9IGNvbnRpbnVvdXMoKSwgaW52ZXJ0ID0gc2NhbGUuaW52ZXJ0LCBkb21haW4gPSBzY2FsZS5kb21haW47CiAgdmFyIGZvcm1hdE1pbGxpc2Vjb25kID0gZm9ybWF0MigiLiVMIiksIGZvcm1hdFNlY29uZCA9IGZvcm1hdDIoIjolUyIpLCBmb3JtYXRNaW51dGUgPSBmb3JtYXQyKCIlSTolTSIpLCBmb3JtYXRIb3VyID0gZm9ybWF0MigiJUkgJXAiKSwgZm9ybWF0RGF5ID0gZm9ybWF0MigiJWEgJWQiKSwgZm9ybWF0V2VlayA9IGZvcm1hdDIoIiViICVkIiksIGZvcm1hdE1vbnRoID0gZm9ybWF0MigiJUIiKSwgZm9ybWF0WWVhcjIgPSBmb3JtYXQyKCIlWSIpOwogIGZ1bmN0aW9uIHRpY2tGb3JtYXQyKGRhdGUyKSB7CiAgICByZXR1cm4gKHNlY29uZDIoZGF0ZTIpIDwgZGF0ZTIgPyBmb3JtYXRNaWxsaXNlY29uZCA6IG1pbnV0ZShkYXRlMikgPCBkYXRlMiA/IGZvcm1hdFNlY29uZCA6IGhvdXIoZGF0ZTIpIDwgZGF0ZTIgPyBmb3JtYXRNaW51dGUgOiBkYXkoZGF0ZTIpIDwgZGF0ZTIgPyBmb3JtYXRIb3VyIDogbW9udGgoZGF0ZTIpIDwgZGF0ZTIgPyB3ZWVrKGRhdGUyKSA8IGRhdGUyID8gZm9ybWF0RGF5IDogZm9ybWF0V2VlayA6IHllYXIoZGF0ZTIpIDwgZGF0ZTIgPyBmb3JtYXRNb250aCA6IGZvcm1hdFllYXIyKShkYXRlMik7CiAgfQogIHNjYWxlLmludmVydCA9IGZ1bmN0aW9uKHkyKSB7CiAgICByZXR1cm4gbmV3IERhdGUoaW52ZXJ0KHkyKSk7CiAgfTsKICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IGRvbWFpbihBcnJheS5mcm9tKF8sIG51bWJlcjMpKSA6IGRvbWFpbigpLm1hcChkYXRlKTsKICB9OwogIHNjYWxlLnRpY2tzID0gZnVuY3Rpb24oaW50ZXJ2YWwpIHsKICAgIHZhciBkID0gZG9tYWluKCk7CiAgICByZXR1cm4gdGlja3MyKGRbMF0sIGRbZC5sZW5ndGggLSAxXSwgaW50ZXJ2YWwgPT0gbnVsbCA/IDEwIDogaW50ZXJ2YWwpOwogIH07CiAgc2NhbGUudGlja0Zvcm1hdCA9IGZ1bmN0aW9uKGNvdW50LCBzcGVjaWZpZXIpIHsKICAgIHJldHVybiBzcGVjaWZpZXIgPT0gbnVsbCA/IHRpY2tGb3JtYXQyIDogZm9ybWF0MihzcGVjaWZpZXIpOwogIH07CiAgc2NhbGUubmljZSA9IGZ1bmN0aW9uKGludGVydmFsKSB7CiAgICB2YXIgZCA9IGRvbWFpbigpOwogICAgaWYgKCFpbnRlcnZhbCB8fCB0eXBlb2YgaW50ZXJ2YWwucmFuZ2UgIT09ICJmdW5jdGlvbiIpIGludGVydmFsID0gdGlja0ludGVydmFsKGRbMF0sIGRbZC5sZW5ndGggLSAxXSwgaW50ZXJ2YWwgPT0gbnVsbCA/IDEwIDogaW50ZXJ2YWwpOwogICAgcmV0dXJuIGludGVydmFsID8gZG9tYWluKG5pY2UoZCwgaW50ZXJ2YWwpKSA6IHNjYWxlOwogIH07CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkoc2NhbGUsIGNhbGVuZGFyKHRpY2tzMiwgdGlja0ludGVydmFsLCB5ZWFyLCBtb250aCwgd2VlaywgZGF5LCBob3VyLCBtaW51dGUsIHNlY29uZDIsIGZvcm1hdDIpKTsKICB9OwogIHJldHVybiBzY2FsZTsKfQpmdW5jdGlvbiB0aW1lKCkgewogIHJldHVybiBpbml0UmFuZ2UuYXBwbHkoY2FsZW5kYXIodGltZVRpY2tzLCB0aW1lVGlja0ludGVydmFsLCB0aW1lWWVhciwgdGltZU1vbnRoLCB0aW1lU3VuZGF5LCB0aW1lRGF5LCB0aW1lSG91ciwgdGltZU1pbnV0ZSwgc2Vjb25kLCB0aW1lRm9ybWF0KS5kb21haW4oW25ldyBEYXRlKDJlMywgMCwgMSksIG5ldyBEYXRlKDJlMywgMCwgMildKSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvdXRjVGltZS5qcwpmdW5jdGlvbiB1dGNUaW1lKCkgewogIHJldHVybiBpbml0UmFuZ2UuYXBwbHkoY2FsZW5kYXIodXRjVGlja3MsIHV0Y1RpY2tJbnRlcnZhbCwgdXRjWWVhciwgdXRjTW9udGgsIHV0Y1N1bmRheSwgdXRjRGF5LCB1dGNIb3VyLCB1dGNNaW51dGUsIHNlY29uZCwgdXRjRm9ybWF0KS5kb21haW4oW0RhdGUuVVRDKDJlMywgMCwgMSksIERhdGUuVVRDKDJlMywgMCwgMildKSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvc2VxdWVudGlhbC5qcwpmdW5jdGlvbiB0cmFuc2Zvcm1lcjIoKSB7CiAgdmFyIHgwID0gMCwgeDEgPSAxLCB0MDIsIHQxMiwgazEwLCB0cmFuc2Zvcm0sIGludGVycG9sYXRvciA9IGlkZW50aXR5LCBjbGFtcCA9IGZhbHNlLCB1bmtub3duOwogIGZ1bmN0aW9uIHNjYWxlKHgyKSB7CiAgICByZXR1cm4geDIgPT0gbnVsbCB8fCBpc05hTih4MiA9ICt4MikgPyB1bmtub3duIDogaW50ZXJwb2xhdG9yKGsxMCA9PT0gMCA/IDAuNSA6ICh4MiA9ICh0cmFuc2Zvcm0oeDIpIC0gdDAyKSAqIGsxMCwgY2xhbXAgPyBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCB4MikpIDogeDIpKTsKICB9CiAgc2NhbGUuZG9tYWluID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoW3gwLCB4MV0gPSBfLCB0MDIgPSB0cmFuc2Zvcm0oeDAgPSAreDApLCB0MTIgPSB0cmFuc2Zvcm0oeDEgPSAreDEpLCBrMTAgPSB0MDIgPT09IHQxMiA/IDAgOiAxIC8gKHQxMiAtIHQwMiksIHNjYWxlKSA6IFt4MCwgeDFdOwogIH07CiAgc2NhbGUuY2xhbXAgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChjbGFtcCA9ICEhXywgc2NhbGUpIDogY2xhbXA7CiAgfTsKICBzY2FsZS5pbnRlcnBvbGF0b3IgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChpbnRlcnBvbGF0b3IgPSBfLCBzY2FsZSkgOiBpbnRlcnBvbGF0b3I7CiAgfTsKICBmdW5jdGlvbiByYW5nZTQoaW50ZXJwb2xhdGUyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oXykgewogICAgICB2YXIgcjAsIHIxOwogICAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChbcjAsIHIxXSA9IF8sIGludGVycG9sYXRvciA9IGludGVycG9sYXRlMihyMCwgcjEpLCBzY2FsZSkgOiBbaW50ZXJwb2xhdG9yKDApLCBpbnRlcnBvbGF0b3IoMSldOwogICAgfTsKICB9CiAgc2NhbGUucmFuZ2UgPSByYW5nZTQodmFsdWVfZGVmYXVsdCk7CiAgc2NhbGUucmFuZ2VSb3VuZCA9IHJhbmdlNChyb3VuZF9kZWZhdWx0KTsKICBzY2FsZS51bmtub3duID0gZnVuY3Rpb24oXykgewogICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAodW5rbm93biA9IF8sIHNjYWxlKSA6IHVua25vd247CiAgfTsKICByZXR1cm4gZnVuY3Rpb24odCkgewogICAgdHJhbnNmb3JtID0gdCwgdDAyID0gdCh4MCksIHQxMiA9IHQoeDEpLCBrMTAgPSB0MDIgPT09IHQxMiA/IDAgOiAxIC8gKHQxMiAtIHQwMik7CiAgICByZXR1cm4gc2NhbGU7CiAgfTsKfQpmdW5jdGlvbiBjb3B5Mihzb3VyY2UsIHRhcmdldCkgewogIHJldHVybiB0YXJnZXQuZG9tYWluKHNvdXJjZS5kb21haW4oKSkuaW50ZXJwb2xhdG9yKHNvdXJjZS5pbnRlcnBvbGF0b3IoKSkuY2xhbXAoc291cmNlLmNsYW1wKCkpLnVua25vd24oc291cmNlLnVua25vd24oKSk7Cn0KZnVuY3Rpb24gc2VxdWVudGlhbCgpIHsKICB2YXIgc2NhbGUgPSBsaW5lYXJpc2godHJhbnNmb3JtZXIyKCkoaWRlbnRpdHkpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIHNlcXVlbnRpYWwoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBzZXF1ZW50aWFsTG9nKCkgewogIHZhciBzY2FsZSA9IGxvZ2dpc2godHJhbnNmb3JtZXIyKCkpLmRvbWFpbihbMSwgMTBdKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIHNlcXVlbnRpYWxMb2coKSkuYmFzZShzY2FsZS5iYXNlKCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gc2VxdWVudGlhbFN5bWxvZygpIHsKICB2YXIgc2NhbGUgPSBzeW1sb2dpc2godHJhbnNmb3JtZXIyKCkpOwogIHNjYWxlLmNvcHkgPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBjb3B5MihzY2FsZSwgc2VxdWVudGlhbFN5bWxvZygpKS5jb25zdGFudChzY2FsZS5jb25zdGFudCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIHNlcXVlbnRpYWxQb3coKSB7CiAgdmFyIHNjYWxlID0gcG93aXNoKHRyYW5zZm9ybWVyMigpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIHNlcXVlbnRpYWxQb3coKSkuZXhwb25lbnQoc2NhbGUuZXhwb25lbnQoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBzZXF1ZW50aWFsU3FydCgpIHsKICByZXR1cm4gc2VxdWVudGlhbFBvdy5hcHBseShudWxsLCBhcmd1bWVudHMpLmV4cG9uZW50KDAuNSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9kMy1zY2FsZUA0LjAuMi9ub2RlX21vZHVsZXMvZDMtc2NhbGUvc3JjL3NlcXVlbnRpYWxRdWFudGlsZS5qcwpmdW5jdGlvbiBzZXF1ZW50aWFsUXVhbnRpbGUoKSB7CiAgdmFyIGRvbWFpbiA9IFtdLCBpbnRlcnBvbGF0b3IgPSBpZGVudGl0eTsKICBmdW5jdGlvbiBzY2FsZSh4MikgewogICAgaWYgKHgyICE9IG51bGwgJiYgIWlzTmFOKHgyID0gK3gyKSkgcmV0dXJuIGludGVycG9sYXRvcigoYmlzZWN0X2RlZmF1bHQoZG9tYWluLCB4MiwgMSkgLSAxKSAvIChkb21haW4ubGVuZ3RoIC0gMSkpOwogIH0KICBzY2FsZS5kb21haW4gPSBmdW5jdGlvbihfKSB7CiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHJldHVybiBkb21haW4uc2xpY2UoKTsKICAgIGRvbWFpbiA9IFtdOwogICAgZm9yIChsZXQgZCBvZiBfKSBpZiAoZCAhPSBudWxsICYmICFpc05hTihkID0gK2QpKSBkb21haW4ucHVzaChkKTsKICAgIGRvbWFpbi5zb3J0KGFzY2VuZGluZyk7CiAgICByZXR1cm4gc2NhbGU7CiAgfTsKICBzY2FsZS5pbnRlcnBvbGF0b3IgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChpbnRlcnBvbGF0b3IgPSBfLCBzY2FsZSkgOiBpbnRlcnBvbGF0b3I7CiAgfTsKICBzY2FsZS5yYW5nZSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGRvbWFpbi5tYXAoKGQsIGkpID0+IGludGVycG9sYXRvcihpIC8gKGRvbWFpbi5sZW5ndGggLSAxKSkpOwogIH07CiAgc2NhbGUucXVhbnRpbGVzID0gZnVuY3Rpb24obikgewogICAgcmV0dXJuIEFycmF5LmZyb20oeyBsZW5ndGg6IG4gKyAxIH0sIChfLCBpKSA9PiBxdWFudGlsZShkb21haW4sIGkgLyBuKSk7CiAgfTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gc2VxdWVudGlhbFF1YW50aWxlKGludGVycG9sYXRvcikuZG9tYWluKGRvbWFpbik7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL2QzLXNjYWxlQDQuMC4yL25vZGVfbW9kdWxlcy9kMy1zY2FsZS9zcmMvZGl2ZXJnaW5nLmpzCmZ1bmN0aW9uIHRyYW5zZm9ybWVyMygpIHsKICB2YXIgeDAgPSAwLCB4MSA9IDAuNSwgeDIgPSAxLCBzID0gMSwgdDAyLCB0MTIsIHQyLCBrMTAsIGsyMSwgaW50ZXJwb2xhdG9yID0gaWRlbnRpdHksIHRyYW5zZm9ybSwgY2xhbXAgPSBmYWxzZSwgdW5rbm93bjsKICBmdW5jdGlvbiBzY2FsZSh4MykgewogICAgcmV0dXJuIGlzTmFOKHgzID0gK3gzKSA/IHVua25vd24gOiAoeDMgPSAwLjUgKyAoKHgzID0gK3RyYW5zZm9ybSh4MykpIC0gdDEyKSAqIChzICogeDMgPCBzICogdDEyID8gazEwIDogazIxKSwgaW50ZXJwb2xhdG9yKGNsYW1wID8gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgeDMpKSA6IHgzKSk7CiAgfQogIHNjYWxlLmRvbWFpbiA9IGZ1bmN0aW9uKF8pIHsKICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID8gKFt4MCwgeDEsIHgyXSA9IF8sIHQwMiA9IHRyYW5zZm9ybSh4MCA9ICt4MCksIHQxMiA9IHRyYW5zZm9ybSh4MSA9ICt4MSksIHQyID0gdHJhbnNmb3JtKHgyID0gK3gyKSwgazEwID0gdDAyID09PSB0MTIgPyAwIDogMC41IC8gKHQxMiAtIHQwMiksIGsyMSA9IHQxMiA9PT0gdDIgPyAwIDogMC41IC8gKHQyIC0gdDEyKSwgcyA9IHQxMiA8IHQwMiA/IC0xIDogMSwgc2NhbGUpIDogW3gwLCB4MSwgeDJdOwogIH07CiAgc2NhbGUuY2xhbXAgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChjbGFtcCA9ICEhXywgc2NhbGUpIDogY2xhbXA7CiAgfTsKICBzY2FsZS5pbnRlcnBvbGF0b3IgPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/IChpbnRlcnBvbGF0b3IgPSBfLCBzY2FsZSkgOiBpbnRlcnBvbGF0b3I7CiAgfTsKICBmdW5jdGlvbiByYW5nZTQoaW50ZXJwb2xhdGUyKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oXykgewogICAgICB2YXIgcjAsIHIxLCByMjsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPyAoW3IwLCByMSwgcjJdID0gXywgaW50ZXJwb2xhdG9yID0gcGllY2V3aXNlKGludGVycG9sYXRlMiwgW3IwLCByMSwgcjJdKSwgc2NhbGUpIDogW2ludGVycG9sYXRvcigwKSwgaW50ZXJwb2xhdG9yKDAuNSksIGludGVycG9sYXRvcigxKV07CiAgICB9OwogIH0KICBzY2FsZS5yYW5nZSA9IHJhbmdlNCh2YWx1ZV9kZWZhdWx0KTsKICBzY2FsZS5yYW5nZVJvdW5kID0gcmFuZ2U0KHJvdW5kX2RlZmF1bHQpOwogIHNjYWxlLnVua25vd24gPSBmdW5jdGlvbihfKSB7CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA/ICh1bmtub3duID0gXywgc2NhbGUpIDogdW5rbm93bjsKICB9OwogIHJldHVybiBmdW5jdGlvbih0KSB7CiAgICB0cmFuc2Zvcm0gPSB0LCB0MDIgPSB0KHgwKSwgdDEyID0gdCh4MSksIHQyID0gdCh4MiksIGsxMCA9IHQwMiA9PT0gdDEyID8gMCA6IDAuNSAvICh0MTIgLSB0MDIpLCBrMjEgPSB0MTIgPT09IHQyID8gMCA6IDAuNSAvICh0MiAtIHQxMiksIHMgPSB0MTIgPCB0MDIgPyAtMSA6IDE7CiAgICByZXR1cm4gc2NhbGU7CiAgfTsKfQpmdW5jdGlvbiBkaXZlcmdpbmcoKSB7CiAgdmFyIHNjYWxlID0gbGluZWFyaXNoKHRyYW5zZm9ybWVyMygpKGlkZW50aXR5KSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkyKHNjYWxlLCBkaXZlcmdpbmcoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBkaXZlcmdpbmdMb2coKSB7CiAgdmFyIHNjYWxlID0gbG9nZ2lzaCh0cmFuc2Zvcm1lcjMoKSkuZG9tYWluKFswLjEsIDEsIDEwXSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkyKHNjYWxlLCBkaXZlcmdpbmdMb2coKSkuYmFzZShzY2FsZS5iYXNlKCkpOwogIH07CiAgcmV0dXJuIGluaXRJbnRlcnBvbGF0b3IuYXBwbHkoc2NhbGUsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gZGl2ZXJnaW5nU3ltbG9nKCkgewogIHZhciBzY2FsZSA9IHN5bWxvZ2lzaCh0cmFuc2Zvcm1lcjMoKSk7CiAgc2NhbGUuY29weSA9IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGNvcHkyKHNjYWxlLCBkaXZlcmdpbmdTeW1sb2coKSkuY29uc3RhbnQoc2NhbGUuY29uc3RhbnQoKSk7CiAgfTsKICByZXR1cm4gaW5pdEludGVycG9sYXRvci5hcHBseShzY2FsZSwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBkaXZlcmdpbmdQb3coKSB7CiAgdmFyIHNjYWxlID0gcG93aXNoKHRyYW5zZm9ybWVyMygpKTsKICBzY2FsZS5jb3B5ID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gY29weTIoc2NhbGUsIGRpdmVyZ2luZ1BvdygpKS5leHBvbmVudChzY2FsZS5leHBvbmVudCgpKTsKICB9OwogIHJldHVybiBpbml0SW50ZXJwb2xhdG9yLmFwcGx5KHNjYWxlLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIGRpdmVyZ2luZ1NxcnQoKSB7CiAgcmV0dXJuIGRpdmVyZ2luZ1Bvdy5hcHBseShudWxsLCBhcmd1bWVudHMpLmV4cG9uZW50KDAuNSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9kYXRhU2VsZWN0b3JzLmpzCnZhciBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlcyA9IChzdGF0ZSkgPT4gc3RhdGUuY2hhcnREYXRhOwp2YXIgc2VsZWN0Q2hhcnREYXRhQW5kQWx3YXlzSWdub3JlSW5kZXhlcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlc10sIChkYXRhU3RhdGUpID0+IHsKICB2YXIgZGF0YUVuZEluZGV4ID0gZGF0YVN0YXRlLmNoYXJ0RGF0YSAhPSBudWxsID8gZGF0YVN0YXRlLmNoYXJ0RGF0YS5sZW5ndGggLSAxIDogMDsKICByZXR1cm4gewogICAgY2hhcnREYXRhOiBkYXRhU3RhdGUuY2hhcnREYXRhLAogICAgY29tcHV0ZWREYXRhOiBkYXRhU3RhdGUuY29tcHV0ZWREYXRhLAogICAgZGF0YUVuZEluZGV4LAogICAgZGF0YVN0YXJ0SW5kZXg6IDAKICB9Owp9KTsKdmFyIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzSWZOb3RJblBhbm9yYW1hID0gKHN0YXRlLCBfdW51c2VkMSwgX3VudXNlZDIsIGlzUGFub3JhbWEpID0+IHsKICBpZiAoaXNQYW5vcmFtYSkgewogICAgcmV0dXJuIHNlbGVjdENoYXJ0RGF0YUFuZEFsd2F5c0lnbm9yZUluZGV4ZXMoc3RhdGUpOwogIH0KICByZXR1cm4gc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXMoc3RhdGUpOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9pc0RvbWFpblNwZWNpZmllZEJ5VXNlci5qcwpmdW5jdGlvbiBpc1dlbGxGb3JtZWROdW1iZXJEb21haW4odikgewogIGlmIChBcnJheS5pc0FycmF5KHYpICYmIHYubGVuZ3RoID09PSAyKSB7CiAgICB2YXIgW21pbjIsIG1heDJdID0gdjsKICAgIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKG1pbjIpICYmIGlzV2VsbEJlaGF2ZWROdW1iZXIobWF4MikpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQogIHJldHVybiBmYWxzZTsKfQpmdW5jdGlvbiBleHRlbmREb21haW4ocHJvdmlkZWREb21haW4sIGJvdW5kYXJ5RG9tYWluLCBhbGxvd0RhdGFPdmVyZmxvdykgewogIGlmIChhbGxvd0RhdGFPdmVyZmxvdykgewogICAgcmV0dXJuIHByb3ZpZGVkRG9tYWluOwogIH0KICByZXR1cm4gW01hdGgubWluKHByb3ZpZGVkRG9tYWluWzBdLCBib3VuZGFyeURvbWFpblswXSksIE1hdGgubWF4KHByb3ZpZGVkRG9tYWluWzFdLCBib3VuZGFyeURvbWFpblsxXSldOwp9CmZ1bmN0aW9uIG51bWVyaWNhbERvbWFpblNwZWNpZmllZFdpdGhvdXRSZXF1aXJpbmdEYXRhKHVzZXJEb21haW4sIGFsbG93RGF0YU92ZXJmbG93KSB7CiAgaWYgKCFhbGxvd0RhdGFPdmVyZmxvdykgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKHR5cGVvZiB1c2VyRG9tYWluID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoQXJyYXkuaXNBcnJheSh1c2VyRG9tYWluKSAmJiB1c2VyRG9tYWluLmxlbmd0aCA9PT0gMikgewogICAgdmFyIFtwcm92aWRlZE1pbiwgcHJvdmlkZWRNYXhdID0gdXNlckRvbWFpbjsKICAgIHZhciBmaW5hbE1pbiwgZmluYWxNYXg7CiAgICBpZiAoaXNXZWxsQmVoYXZlZE51bWJlcihwcm92aWRlZE1pbikpIHsKICAgICAgZmluYWxNaW4gPSBwcm92aWRlZE1pbjsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWluID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBpZiAoaXNXZWxsQmVoYXZlZE51bWJlcihwcm92aWRlZE1heCkpIHsKICAgICAgZmluYWxNYXggPSBwcm92aWRlZE1heDsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWF4ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICB2YXIgY2FuZGlkYXRlID0gW2ZpbmFsTWluLCBmaW5hbE1heF07CiAgICBpZiAoaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKGNhbmRpZGF0ZSkpIHsKICAgICAgcmV0dXJuIGNhbmRpZGF0ZTsKICAgIH0KICB9CiAgcmV0dXJuIHZvaWQgMDsKfQpmdW5jdGlvbiBwYXJzZU51bWVyaWNhbFVzZXJEb21haW4odXNlckRvbWFpbiwgZGF0YURvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpIHsKICBpZiAoIWFsbG93RGF0YU92ZXJmbG93ICYmIGRhdGFEb21haW4gPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKHR5cGVvZiB1c2VyRG9tYWluID09PSAiZnVuY3Rpb24iICYmIGRhdGFEb21haW4gIT0gbnVsbCkgewogICAgdHJ5IHsKICAgICAgdmFyIHJlc3VsdCA9IHVzZXJEb21haW4oZGF0YURvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpOwogICAgICBpZiAoaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKHJlc3VsdCkpIHsKICAgICAgICByZXR1cm4gZXh0ZW5kRG9tYWluKHJlc3VsdCwgZGF0YURvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpOwogICAgICB9CiAgICB9IGNhdGNoIChfdW51c2VkKSB7CiAgICB9CiAgfQogIGlmIChBcnJheS5pc0FycmF5KHVzZXJEb21haW4pICYmIHVzZXJEb21haW4ubGVuZ3RoID09PSAyKSB7CiAgICB2YXIgW3Byb3ZpZGVkTWluLCBwcm92aWRlZE1heF0gPSB1c2VyRG9tYWluOwogICAgdmFyIGZpbmFsTWluLCBmaW5hbE1heDsKICAgIGlmIChwcm92aWRlZE1pbiA9PT0gImF1dG8iKSB7CiAgICAgIGlmIChkYXRhRG9tYWluICE9IG51bGwpIHsKICAgICAgICBmaW5hbE1pbiA9IE1hdGgubWluKC4uLmRhdGFEb21haW4pOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGlzTnVtYmVyKHByb3ZpZGVkTWluKSkgewogICAgICBmaW5hbE1pbiA9IHByb3ZpZGVkTWluOwogICAgfSBlbHNlIGlmICh0eXBlb2YgcHJvdmlkZWRNaW4gPT09ICJmdW5jdGlvbiIpIHsKICAgICAgdHJ5IHsKICAgICAgICBpZiAoZGF0YURvbWFpbiAhPSBudWxsKSB7CiAgICAgICAgICBmaW5hbE1pbiA9IHByb3ZpZGVkTWluKGRhdGFEb21haW4gPT09IG51bGwgfHwgZGF0YURvbWFpbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YURvbWFpblswXSk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChfdW51c2VkMikgewogICAgICB9CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm92aWRlZE1pbiA9PT0gInN0cmluZyIgJiYgTUlOX1ZBTFVFX1JFRy50ZXN0KHByb3ZpZGVkTWluKSkgewogICAgICB2YXIgbWF0Y2ggPSBNSU5fVkFMVUVfUkVHLmV4ZWMocHJvdmlkZWRNaW4pOwogICAgICBpZiAobWF0Y2ggPT0gbnVsbCB8fCBkYXRhRG9tYWluID09IG51bGwpIHsKICAgICAgICBmaW5hbE1pbiA9IHZvaWQgMDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgdmFsdWUgPSArbWF0Y2hbMV07CiAgICAgICAgZmluYWxNaW4gPSBkYXRhRG9tYWluWzBdIC0gdmFsdWU7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZpbmFsTWluID0gZGF0YURvbWFpbiA9PT0gbnVsbCB8fCBkYXRhRG9tYWluID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhRG9tYWluWzBdOwogICAgfQogICAgaWYgKHByb3ZpZGVkTWF4ID09PSAiYXV0byIpIHsKICAgICAgaWYgKGRhdGFEb21haW4gIT0gbnVsbCkgewogICAgICAgIGZpbmFsTWF4ID0gTWF0aC5tYXgoLi4uZGF0YURvbWFpbik7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNOdW1iZXIocHJvdmlkZWRNYXgpKSB7CiAgICAgIGZpbmFsTWF4ID0gcHJvdmlkZWRNYXg7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwcm92aWRlZE1heCA9PT0gImZ1bmN0aW9uIikgewogICAgICB0cnkgewogICAgICAgIGlmIChkYXRhRG9tYWluICE9IG51bGwpIHsKICAgICAgICAgIGZpbmFsTWF4ID0gcHJvdmlkZWRNYXgoZGF0YURvbWFpbiA9PT0gbnVsbCB8fCBkYXRhRG9tYWluID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhRG9tYWluWzFdKTsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKF91bnVzZWQzKSB7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodHlwZW9mIHByb3ZpZGVkTWF4ID09PSAic3RyaW5nIiAmJiBNQVhfVkFMVUVfUkVHLnRlc3QocHJvdmlkZWRNYXgpKSB7CiAgICAgIHZhciBfbWF0Y2ggPSBNQVhfVkFMVUVfUkVHLmV4ZWMocHJvdmlkZWRNYXgpOwogICAgICBpZiAoX21hdGNoID09IG51bGwgfHwgZGF0YURvbWFpbiA9PSBudWxsKSB7CiAgICAgICAgZmluYWxNYXggPSB2b2lkIDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIF92YWx1ZSA9ICtfbWF0Y2hbMV07CiAgICAgICAgZmluYWxNYXggPSBkYXRhRG9tYWluWzFdICsgX3ZhbHVlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmaW5hbE1heCA9IGRhdGFEb21haW4gPT09IG51bGwgfHwgZGF0YURvbWFpbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YURvbWFpblsxXTsKICAgIH0KICAgIHZhciBjYW5kaWRhdGUgPSBbZmluYWxNaW4sIGZpbmFsTWF4XTsKICAgIGlmIChpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oY2FuZGlkYXRlKSkgewogICAgICBpZiAoZGF0YURvbWFpbiA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGNhbmRpZGF0ZTsKICAgICAgfQogICAgICByZXR1cm4gZXh0ZW5kRG9tYWluKGNhbmRpZGF0ZSwgZGF0YURvbWFpbiwgYWxsb3dEYXRhT3ZlcmZsb3cpOwogICAgfQogIH0KICByZXR1cm4gdm9pZCAwOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3NjYWxlL2dldE5pY2VUaWNrVmFsdWVzLmpzCnZhciBpbXBvcnRfZGVjaW1hbDIgPSBfX3RvRVNNKHJlcXVpcmVfZGVjaW1hbCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc2NhbGUvdXRpbC91dGlscy5qcwp2YXIgaWRlbnRpdHkzID0gKGkpID0+IGk7CnZhciBQTEFDRV9IT0xERVIgPSB7CiAgIkBAZnVuY3Rpb25hbC9wbGFjZWhvbGRlciI6IHRydWUKfTsKdmFyIGlzUGxhY2VIb2xkZXIgPSAodmFsKSA9PiB2YWwgPT09IFBMQUNFX0hPTERFUjsKdmFyIGN1cnJ5MCA9IChmbikgPT4gZnVuY3Rpb24gX2N1cnJpZWQoKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDAgfHwgYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiBpc1BsYWNlSG9sZGVyKGFyZ3VtZW50cy5sZW5ndGggPD0gMCA/IHZvaWQgMCA6IGFyZ3VtZW50c1swXSkpIHsKICAgIHJldHVybiBfY3VycmllZDsKICB9CiAgcmV0dXJuIGZuKC4uLmFyZ3VtZW50cyk7Cn07CnZhciBjdXJyeU4gPSAobiwgZm4pID0+IHsKICBpZiAobiA9PT0gMSkgewogICAgcmV0dXJuIGZuOwogIH0KICByZXR1cm4gY3VycnkwKGZ1bmN0aW9uKCkgewogICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7CiAgICAgIGFyZ3NbX2tleV0gPSBhcmd1bWVudHNbX2tleV07CiAgICB9CiAgICB2YXIgYXJnc0xlbmd0aCA9IGFyZ3MuZmlsdGVyKChhcmcpID0+IGFyZyAhPT0gUExBQ0VfSE9MREVSKS5sZW5ndGg7CiAgICBpZiAoYXJnc0xlbmd0aCA+PSBuKSB7CiAgICAgIHJldHVybiBmbiguLi5hcmdzKTsKICAgIH0KICAgIHJldHVybiBjdXJyeU4obiAtIGFyZ3NMZW5ndGgsIGN1cnJ5MChmdW5jdGlvbigpIHsKICAgICAgZm9yICh2YXIgX2xlbjIgPSBhcmd1bWVudHMubGVuZ3RoLCByZXN0QXJncyA9IG5ldyBBcnJheShfbGVuMiksIF9rZXkyID0gMDsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykgewogICAgICAgIHJlc3RBcmdzW19rZXkyXSA9IGFyZ3VtZW50c1tfa2V5Ml07CiAgICAgIH0KICAgICAgdmFyIG5ld0FyZ3MgPSBhcmdzLm1hcCgoYXJnKSA9PiBpc1BsYWNlSG9sZGVyKGFyZykgPyByZXN0QXJncy5zaGlmdCgpIDogYXJnKTsKICAgICAgcmV0dXJuIGZuKC4uLm5ld0FyZ3MsIC4uLnJlc3RBcmdzKTsKICAgIH0pKTsKICB9KTsKfTsKdmFyIGN1cnJ5ID0gKGZuKSA9PiBjdXJyeU4oZm4ubGVuZ3RoLCBmbik7CnZhciByYW5nZTIgPSAoYmVnaW4sIGVuZCkgPT4gewogIHZhciBhcnIgPSBbXTsKICBmb3IgKHZhciBpID0gYmVnaW47IGkgPCBlbmQ7ICsraSkgewogICAgYXJyW2kgLSBiZWdpbl0gPSBpOwogIH0KICByZXR1cm4gYXJyOwp9Owp2YXIgbWFwMiA9IGN1cnJ5KChmbiwgYXJyKSA9PiB7CiAgaWYgKEFycmF5LmlzQXJyYXkoYXJyKSkgewogICAgcmV0dXJuIGFyci5tYXAoZm4pOwogIH0KICByZXR1cm4gT2JqZWN0LmtleXMoYXJyKS5tYXAoKGtleSkgPT4gYXJyW2tleV0pLm1hcChmbik7Cn0pOwp2YXIgY29tcG9zZTIgPSBmdW5jdGlvbiBjb21wb3NlMygpIHsKICBmb3IgKHZhciBfbGVuMyA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbjMpLCBfa2V5MyA9IDA7IF9rZXkzIDwgX2xlbjM7IF9rZXkzKyspIHsKICAgIGFyZ3NbX2tleTNdID0gYXJndW1lbnRzW19rZXkzXTsKICB9CiAgaWYgKCFhcmdzLmxlbmd0aCkgewogICAgcmV0dXJuIGlkZW50aXR5MzsKICB9CiAgdmFyIGZucyA9IGFyZ3MucmV2ZXJzZSgpOwogIHZhciBmaXJzdEZuID0gZm5zWzBdOwogIHZhciB0YWlsc0ZuID0gZm5zLnNsaWNlKDEpOwogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0YWlsc0ZuLnJlZHVjZSgocmVzLCBmbikgPT4gZm4ocmVzKSwgZmlyc3RGbiguLi5hcmd1bWVudHMpKTsKICB9Owp9Owp2YXIgcmV2ZXJzZSA9IChhcnIpID0+IHsKICBpZiAoQXJyYXkuaXNBcnJheShhcnIpKSB7CiAgICByZXR1cm4gYXJyLnJldmVyc2UoKTsKICB9CiAgcmV0dXJuIGFyci5zcGxpdCgiIikucmV2ZXJzZSgpLmpvaW4oIiIpOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC9zY2FsZS91dGlsL2FyaXRobWV0aWMuanMKdmFyIGltcG9ydF9kZWNpbWFsID0gX190b0VTTShyZXF1aXJlX2RlY2ltYWwoKSk7CmZ1bmN0aW9uIGdldERpZ2l0Q291bnQodmFsdWUpIHsKICB2YXIgcmVzdWx0OwogIGlmICh2YWx1ZSA9PT0gMCkgewogICAgcmVzdWx0ID0gMTsKICB9IGVsc2UgewogICAgcmVzdWx0ID0gTWF0aC5mbG9vcihuZXcgaW1wb3J0X2RlY2ltYWwuZGVmYXVsdCh2YWx1ZSkuYWJzKCkubG9nKDEwKS50b051bWJlcigpKSArIDE7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gcmFuZ2VTdGVwKHN0YXJ0LCBlbmQsIHN0ZXApIHsKICB2YXIgbnVtID0gbmV3IGltcG9ydF9kZWNpbWFsLmRlZmF1bHQoc3RhcnQpOwogIHZhciBpID0gMDsKICB2YXIgcmVzdWx0ID0gW107CiAgd2hpbGUgKG51bS5sdChlbmQpICYmIGkgPCAxZTUpIHsKICAgIHJlc3VsdC5wdXNoKG51bS50b051bWJlcigpKTsKICAgIG51bSA9IG51bS5hZGQoc3RlcCk7CiAgICBpKys7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvc2NhbGUvZ2V0TmljZVRpY2tWYWx1ZXMuanMKdmFyIGdldFZhbGlkSW50ZXJ2YWwgPSAoX3JlZjIpID0+IHsKICB2YXIgW21pbjIsIG1heDJdID0gX3JlZjI7CiAgdmFyIFt2YWxpZE1pbiwgdmFsaWRNYXhdID0gW21pbjIsIG1heDJdOwogIGlmIChtaW4yID4gbWF4MikgewogICAgW3ZhbGlkTWluLCB2YWxpZE1heF0gPSBbbWF4MiwgbWluMl07CiAgfQogIHJldHVybiBbdmFsaWRNaW4sIHZhbGlkTWF4XTsKfTsKdmFyIGdldEZvcm1hdFN0ZXAgPSAocm91Z2hTdGVwLCBhbGxvd0RlY2ltYWxzLCBjb3JyZWN0aW9uRmFjdG9yKSA9PiB7CiAgaWYgKHJvdWdoU3RlcC5sdGUoMCkpIHsKICAgIHJldHVybiBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMCk7CiAgfQogIHZhciBkaWdpdENvdW50ID0gZ2V0RGlnaXRDb3VudChyb3VnaFN0ZXAudG9OdW1iZXIoKSk7CiAgdmFyIGRpZ2l0Q291bnRWYWx1ZSA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgxMCkucG93KGRpZ2l0Q291bnQpOwogIHZhciBzdGVwUmF0aW8gPSByb3VnaFN0ZXAuZGl2KGRpZ2l0Q291bnRWYWx1ZSk7CiAgdmFyIHN0ZXBSYXRpb1NjYWxlID0gZGlnaXRDb3VudCAhPT0gMSA/IDAuMDUgOiAwLjE7CiAgdmFyIGFtZW5kU3RlcFJhdGlvID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguY2VpbChzdGVwUmF0aW8uZGl2KHN0ZXBSYXRpb1NjYWxlKS50b051bWJlcigpKSkuYWRkKGNvcnJlY3Rpb25GYWN0b3IpLm11bChzdGVwUmF0aW9TY2FsZSk7CiAgdmFyIGZvcm1hdFN0ZXAgPSBhbWVuZFN0ZXBSYXRpby5tdWwoZGlnaXRDb3VudFZhbHVlKTsKICByZXR1cm4gYWxsb3dEZWNpbWFscyA/IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChmb3JtYXRTdGVwLnRvTnVtYmVyKCkpIDogbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguY2VpbChmb3JtYXRTdGVwLnRvTnVtYmVyKCkpKTsKfTsKdmFyIGdldFRpY2tPZlNpbmdsZVZhbHVlID0gKHZhbHVlLCB0aWNrQ291bnQsIGFsbG93RGVjaW1hbHMpID0+IHsKICB2YXIgc3RlcCA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgxKTsKICB2YXIgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KHZhbHVlKTsKICBpZiAoIW1pZGRsZS5pc2ludCgpICYmIGFsbG93RGVjaW1hbHMpIHsKICAgIHZhciBhYnNWYWwgPSBNYXRoLmFicyh2YWx1ZSk7CiAgICBpZiAoYWJzVmFsIDwgMSkgewogICAgICBzdGVwID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDEwKS5wb3coZ2V0RGlnaXRDb3VudCh2YWx1ZSkgLSAxKTsKICAgICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguZmxvb3IobWlkZGxlLmRpdihzdGVwKS50b051bWJlcigpKSkubXVsKHN0ZXApOwogICAgfSBlbHNlIGlmIChhYnNWYWwgPiAxKSB7CiAgICAgIG1pZGRsZSA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChNYXRoLmZsb29yKHZhbHVlKSk7CiAgICB9CiAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gMCkgewogICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KE1hdGguZmxvb3IoKHRpY2tDb3VudCAtIDEpIC8gMikpOwogIH0gZWxzZSBpZiAoIWFsbG93RGVjaW1hbHMpIHsKICAgIG1pZGRsZSA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChNYXRoLmZsb29yKHZhbHVlKSk7CiAgfQogIHZhciBtaWRkbGVJbmRleCA9IE1hdGguZmxvb3IoKHRpY2tDb3VudCAtIDEpIC8gMik7CiAgdmFyIGZuID0gY29tcG9zZTIobWFwMigobikgPT4gbWlkZGxlLmFkZChuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQobiAtIG1pZGRsZUluZGV4KS5tdWwoc3RlcCkpLnRvTnVtYmVyKCkpLCByYW5nZTIpOwogIHJldHVybiBmbigwLCB0aWNrQ291bnQpOwp9Owp2YXIgX2NhbGN1bGF0ZVN0ZXAgPSBmdW5jdGlvbiBjYWxjdWxhdGVTdGVwKG1pbjIsIG1heDIsIHRpY2tDb3VudCwgYWxsb3dEZWNpbWFscykgewogIHZhciBjb3JyZWN0aW9uRmFjdG9yID0gYXJndW1lbnRzLmxlbmd0aCA+IDQgJiYgYXJndW1lbnRzWzRdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbNF0gOiAwOwogIGlmICghTnVtYmVyLmlzRmluaXRlKChtYXgyIC0gbWluMikgLyAodGlja0NvdW50IC0gMSkpKSB7CiAgICByZXR1cm4gewogICAgICBzdGVwOiBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoMCksCiAgICAgIHRpY2tNaW46IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgwKSwKICAgICAgdGlja01heDogbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDApCiAgICB9OwogIH0KICB2YXIgc3RlcCA9IGdldEZvcm1hdFN0ZXAobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KG1heDIpLnN1YihtaW4yKS5kaXYodGlja0NvdW50IC0gMSksIGFsbG93RGVjaW1hbHMsIGNvcnJlY3Rpb25GYWN0b3IpOwogIHZhciBtaWRkbGU7CiAgaWYgKG1pbjIgPD0gMCAmJiBtYXgyID49IDApIHsKICAgIG1pZGRsZSA9IG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdCgwKTsKICB9IGVsc2UgewogICAgbWlkZGxlID0gbmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KG1pbjIpLmFkZChtYXgyKS5kaXYoMik7CiAgICBtaWRkbGUgPSBtaWRkbGUuc3ViKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChtaWRkbGUpLm1vZChzdGVwKSk7CiAgfQogIHZhciBiZWxvd0NvdW50ID0gTWF0aC5jZWlsKG1pZGRsZS5zdWIobWluMikuZGl2KHN0ZXApLnRvTnVtYmVyKCkpOwogIHZhciB1cENvdW50ID0gTWF0aC5jZWlsKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChtYXgyKS5zdWIobWlkZGxlKS5kaXYoc3RlcCkudG9OdW1iZXIoKSk7CiAgdmFyIHNjYWxlQ291bnQgPSBiZWxvd0NvdW50ICsgdXBDb3VudCArIDE7CiAgaWYgKHNjYWxlQ291bnQgPiB0aWNrQ291bnQpIHsKICAgIHJldHVybiBfY2FsY3VsYXRlU3RlcChtaW4yLCBtYXgyLCB0aWNrQ291bnQsIGFsbG93RGVjaW1hbHMsIGNvcnJlY3Rpb25GYWN0b3IgKyAxKTsKICB9CiAgaWYgKHNjYWxlQ291bnQgPCB0aWNrQ291bnQpIHsKICAgIHVwQ291bnQgPSBtYXgyID4gMCA/IHVwQ291bnQgKyAodGlja0NvdW50IC0gc2NhbGVDb3VudCkgOiB1cENvdW50OwogICAgYmVsb3dDb3VudCA9IG1heDIgPiAwID8gYmVsb3dDb3VudCA6IGJlbG93Q291bnQgKyAodGlja0NvdW50IC0gc2NhbGVDb3VudCk7CiAgfQogIHJldHVybiB7CiAgICBzdGVwLAogICAgdGlja01pbjogbWlkZGxlLnN1YihuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoYmVsb3dDb3VudCkubXVsKHN0ZXApKSwKICAgIHRpY2tNYXg6IG1pZGRsZS5hZGQobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KHVwQ291bnQpLm11bChzdGVwKSkKICB9Owp9Owp2YXIgZ2V0TmljZVRpY2tWYWx1ZXMgPSBmdW5jdGlvbiBnZXROaWNlVGlja1ZhbHVlczIoX3JlZjIpIHsKICB2YXIgW21pbjIsIG1heDJdID0gX3JlZjI7CiAgdmFyIHRpY2tDb3VudCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDogNjsKICB2YXIgYWxsb3dEZWNpbWFscyA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzJdIDogdHJ1ZTsKICB2YXIgY291bnQgPSBNYXRoLm1heCh0aWNrQ291bnQsIDIpOwogIHZhciBbY29ybWluLCBjb3JtYXhdID0gZ2V0VmFsaWRJbnRlcnZhbChbbWluMiwgbWF4Ml0pOwogIGlmIChjb3JtaW4gPT09IC1JbmZpbml0eSB8fCBjb3JtYXggPT09IEluZmluaXR5KSB7CiAgICB2YXIgX3ZhbHVlcyA9IGNvcm1heCA9PT0gSW5maW5pdHkgPyBbY29ybWluLCAuLi5yYW5nZTIoMCwgdGlja0NvdW50IC0gMSkubWFwKCgpID0+IEluZmluaXR5KV0gOiBbLi4ucmFuZ2UyKDAsIHRpY2tDb3VudCAtIDEpLm1hcCgoKSA9PiAtSW5maW5pdHkpLCBjb3JtYXhdOwogICAgcmV0dXJuIG1pbjIgPiBtYXgyID8gcmV2ZXJzZShfdmFsdWVzKSA6IF92YWx1ZXM7CiAgfQogIGlmIChjb3JtaW4gPT09IGNvcm1heCkgewogICAgcmV0dXJuIGdldFRpY2tPZlNpbmdsZVZhbHVlKGNvcm1pbiwgdGlja0NvdW50LCBhbGxvd0RlY2ltYWxzKTsKICB9CiAgdmFyIHsKICAgIHN0ZXAsCiAgICB0aWNrTWluLAogICAgdGlja01heAogIH0gPSBfY2FsY3VsYXRlU3RlcChjb3JtaW4sIGNvcm1heCwgY291bnQsIGFsbG93RGVjaW1hbHMsIDApOwogIHZhciB2YWx1ZXMgPSByYW5nZVN0ZXAodGlja01pbiwgdGlja01heC5hZGQobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KDAuMSkubXVsKHN0ZXApKSwgc3RlcCk7CiAgcmV0dXJuIG1pbjIgPiBtYXgyID8gcmV2ZXJzZSh2YWx1ZXMpIDogdmFsdWVzOwp9Owp2YXIgZ2V0VGlja1ZhbHVlc0ZpeGVkRG9tYWluID0gZnVuY3Rpb24gZ2V0VGlja1ZhbHVlc0ZpeGVkRG9tYWluMihfcmVmMywgdGlja0NvdW50KSB7CiAgdmFyIFttaW4yLCBtYXgyXSA9IF9yZWYzOwogIHZhciBhbGxvd0RlY2ltYWxzID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMl0gOiB0cnVlOwogIHZhciBbY29ybWluLCBjb3JtYXhdID0gZ2V0VmFsaWRJbnRlcnZhbChbbWluMiwgbWF4Ml0pOwogIGlmIChjb3JtaW4gPT09IC1JbmZpbml0eSB8fCBjb3JtYXggPT09IEluZmluaXR5KSB7CiAgICByZXR1cm4gW21pbjIsIG1heDJdOwogIH0KICBpZiAoY29ybWluID09PSBjb3JtYXgpIHsKICAgIHJldHVybiBbY29ybWluXTsKICB9CiAgdmFyIGNvdW50ID0gTWF0aC5tYXgodGlja0NvdW50LCAyKTsKICB2YXIgc3RlcCA9IGdldEZvcm1hdFN0ZXAobmV3IGltcG9ydF9kZWNpbWFsMi5kZWZhdWx0KGNvcm1heCkuc3ViKGNvcm1pbikuZGl2KGNvdW50IC0gMSksIGFsbG93RGVjaW1hbHMsIDApOwogIHZhciB2YWx1ZXMgPSBbLi4ucmFuZ2VTdGVwKG5ldyBpbXBvcnRfZGVjaW1hbDIuZGVmYXVsdChjb3JtaW4pLCBuZXcgaW1wb3J0X2RlY2ltYWwyLmRlZmF1bHQoY29ybWF4KSwgc3RlcCksIGNvcm1heF07CiAgaWYgKGFsbG93RGVjaW1hbHMgPT09IGZhbHNlKSB7CiAgICB2YWx1ZXMgPSB2YWx1ZXMubWFwKCh2YWx1ZSkgPT4gTWF0aC5yb3VuZCh2YWx1ZSkpOwogIH0KICByZXR1cm4gbWluMiA+IG1heDIgPyByZXZlcnNlKHZhbHVlcykgOiB2YWx1ZXM7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvcm9vdFByb3BzU2VsZWN0b3JzLmpzCnZhciBzZWxlY3RCYXJDYXRlZ29yeUdhcCA9IChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLmJhckNhdGVnb3J5R2FwOwp2YXIgc2VsZWN0U3RhY2tPZmZzZXRUeXBlID0gKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuc3RhY2tPZmZzZXQ7CnZhciBzZWxlY3RSZXZlcnNlU3RhY2tPcmRlciA9IChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLnJldmVyc2VTdGFja09yZGVyOwp2YXIgc2VsZWN0Q2hhcnROYW1lID0gKHN0YXRlKSA9PiBzdGF0ZS5vcHRpb25zLmNoYXJ0TmFtZTsKdmFyIHNlbGVjdFN5bmNJZCA9IChzdGF0ZSkgPT4gc3RhdGUucm9vdFByb3BzLnN5bmNJZDsKdmFyIHNlbGVjdFN5bmNNZXRob2QgPSAoc3RhdGUpID0+IHN0YXRlLnJvb3RQcm9wcy5zeW5jTWV0aG9kOwp2YXIgc2VsZWN0RXZlbnRFbWl0dGVyID0gKHN0YXRlKSA9PiBzdGF0ZS5vcHRpb25zLmV2ZW50RW1pdHRlcjsKdmFyIHNlbGVjdENoYXJ0QmFzZVZhbHVlID0gKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuYmFzZVZhbHVlOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvekluZGV4L0RlZmF1bHRaSW5kZXhlcy5qcwp2YXIgRGVmYXVsdFpJbmRleGVzID0gewogIC8qKgogICAqIENhcnRlc2lhbkdyaWQgYW5kIFBvbGFyR3JpZAogICAqLwogIGdyaWQ6IC0xMDAsCiAgLyoqCiAgICogQmFja2dyb3VuZCBvZiBCYXIgYW5kIFJhZGlhbEJhci4KICAgKiBUaGlzIGlzIG5vdCB2aXNpYmxlIGJ5IGRlZmF1bHQgYnV0IGNhbiBiZSBlbmFibGVkIGJ5IHNldHRpbmcgYmFja2dyb3VuZD17dHJ1ZX0gb24gQmFyIG9yIFJhZGlhbEJhci4KICAgKi8KICBiYXJCYWNrZ3JvdW5kOiAtNTAsCiAgLyoKICAgKiBvdGhlciBjaGFydCBlbGVtZW50cyBvciBjdXN0b20gZWxlbWVudHMgd2l0aG91dCBzcGVjaWZpYyB6SW5kZXgKICAgKiByZW5kZXIgaW4gaGVyZSwgYXQgekluZGV4IDAKICAgKi8KICAvKioKICAgKiBBcmVhLCBQaWUsIFJhZGFyLCBhbmQgUmVmZXJlbmNlQXJlYQogICAqLwogIGFyZWE6IDEwMCwKICAvKioKICAgKiBDdXJzb3IgaXMgZW1iZWRkZWQgaW5zaWRlIFRvb2x0aXAgYW5kIGNvbnRyb2xsZWQgYnkgaXQuCiAgICogVGhlIFRvb2x0aXAgaXRzZWxmIGhhcyBhIHNlcGFyYXRlIHBvcnRhbCBhbmQgaXMgbm90IGluY2x1ZGVkIGluIHRoZSB6SW5kZXggc3lzdGVtOwogICAqIEN1cnNvciBpcyB0aGUgZGVjb3JhdGlvbiBpbnNpZGUgdGhlIGNoYXJ0IGFyZWEuIEN1cnNvclJlY3RhbmdsZSBpcyBhIHJlY3RhbmdsZSBib3guCiAgICogSXQgcmVuZGVycyBiZWxvdyBiYXIgc28gdGhhdCBpbiBhIHN0YWNrZWQgYmFyIGNoYXJ0IHRoZSBjdXJzb3IgcmVjdGFuZ2xlIGRvZXMgbm90IGhpZGUgdGhlIG90aGVyIGJhcnMuCiAgICovCiAgY3Vyc29yUmVjdGFuZ2xlOiAyMDAsCiAgLyoqCiAgICogQmFyIGFuZCBSYWRpYWxCYXIKICAgKi8KICBiYXI6IDMwMCwKICAvKioKICAgKiBMaW5lIGFuZCBSZWZlcmVuY2VMaW5lLCBhbmQgRXJyb3JCb3IKICAgKi8KICBsaW5lOiA0MDAsCiAgLyoqCiAgICogWEF4aXMgYW5kIFlBeGlzIGFuZCBQb2xhckFuZ2xlQXhpcyBhbmQgUG9sYXJSYWRpdXNBeGlzIHRpY2tzIGFuZCBsaW5lcyBhbmQgY2hpbGRyZW4KICAgKi8KICBheGlzOiA1MDAsCiAgLyoqCiAgICogU2NhdHRlciBhbmQgUmVmZXJlbmNlRG90LAogICAqIGFuZCBEb3RzIG9mIExpbmUgYW5kIEFyZWEgYW5kIFJhZGFyIGlmIHRoZXkgaGF2ZSBkb3Q9dHJ1ZQogICAqLwogIHNjYXR0ZXI6IDYwMCwKICAvKioKICAgKiBIb3ZlcmluZyBvdmVyIGEgQmFyIG9yIFJhZGlhbEJhciByZW5kZXJzIGEgaGlnaGxpZ2h0IHJlY3RhbmdsZQogICAqLwogIGFjdGl2ZUJhcjogMWUzLAogIC8qKgogICAqIEN1cnNvciBpcyBlbWJlZGRlZCBpbnNpZGUgVG9vbHRpcCBhbmQgY29udHJvbGxlZCBieSBpdC4KICAgKiBUaGUgVG9vbHRpcCBpdHNlbGYgaGFzIGEgc2VwYXJhdGUgcG9ydGFsIGFuZCBpcyBub3QgaW5jbHVkZWQgaW4gdGhlIHpJbmRleCBzeXN0ZW07CiAgICogQ3Vyc29yIGlzIHRoZSBkZWNvcmF0aW9uIGluc2lkZSB0aGUgY2hhcnQgYXJlYSwgdXN1YWxseSBhIGNyb3NzIG9yIGEgYm94LgogICAqIEN1cnNvckxpbmUgaXMgYSBsaW5lIGN1cnNvciByZW5kZXJlZCBpbiBMaW5lLCBBcmVhLCBTY2F0dGVyLCBSYWRhciBjaGFydHMuCiAgICogSXQgcmVuZGVycyBhYm92ZSB0aGUgTGluZSBhbmQgU2NhdHRlciBzbyB0aGF0IGl0IGlzIGFsd2F5cyB2aXNpYmxlLgogICAqIEl0IHJlbmRlcnMgYmVsb3cgYWN0aXZlIGRvdCBzbyB0aGF0IHRoZSBkb3QgaXMgYWx3YXlzIHZpc2libGUgYW5kIHNob3dzIHRoZSBjdXJyZW50IHBvaW50LgogICAqIFdlJ3JlIGFsc28gYXNzdW1pbmcgdGhhdCB0aGUgYWN0aXZlIGRvdCBpcyBzbWFsbCBlbm91Z2ggdGhhdCBpdCBkb2VzIG5vdCBmdWxseSBjb3ZlciB0aGUgY3Vyc29yIGxpbmUuCiAgICoKICAgKiBUaGlzIGFsc28gYXBwbGllcyB0byB0aGUgcmFkaWFsIGN1cnNvciBpbiBSYWRpYWxCYXJDaGFydC4KICAgKi8KICBjdXJzb3JMaW5lOiAxMTAwLAogIC8qKgogICAqIEhvdmVyaW5nIG92ZXIgYSBQb2ludCBpbiBMaW5lLCBBcmVhLCBTY2F0dGVyLCBSYWRhciByZW5kZXJzIGEgaGlnaGxpZ2h0IGRvdAogICAqLwogIGFjdGl2ZURvdDogMTIwMCwKICAvKioKICAgKiBMYWJlbExpc3QgYW5kIExhYmVsLCBpbmNsdWRpbmcgQXhpcyBsYWJlbHMKICAgKi8KICBsYWJlbDogMmUzCn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9wb2xhci9kZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5qcwp2YXIgZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMgPSB7CiAgYWxsb3dEZWNpbWFsczogZmFsc2UsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IHRydWUsCiAgLy8gaWYgSSBzZXQgdGhpcyB0byBmYWxzZSB0aGVuIFRvb2x0aXAgc3luY2hyb25pc2F0aW9uIHN0b3BzIHdvcmtpbmcgaW4gUmFkYXIsIHd0ZgogIGFuZ2xlQXhpc0lkOiAwLAogIGF4aXNMaW5lOiB0cnVlLAogIGF4aXNMaW5lVHlwZTogInBvbHlnb24iLAogIGN4OiAwLAogIGN5OiAwLAogIG9yaWVudGF0aW9uOiAib3V0ZXIiLAogIHJldmVyc2VkOiBmYWxzZSwKICBzY2FsZTogImF1dG8iLAogIHRpY2s6IHRydWUsCiAgdGlja0xpbmU6IHRydWUsCiAgdGlja1NpemU6IDgsCiAgdHlwZTogImNhdGVnb3J5IiwKICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5heGlzCn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9wb2xhci9kZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuanMKdmFyIGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZmFsc2UsCiAgYWxsb3dEZWNpbWFsczogZmFsc2UsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IHRydWUsCiAgYW5nbGU6IDAsCiAgYXhpc0xpbmU6IHRydWUsCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgbGFiZWw6IGZhbHNlLAogIG9yaWVudGF0aW9uOiAicmlnaHQiLAogIHJhZGl1c0F4aXNJZDogMCwKICByZXZlcnNlZDogZmFsc2UsCiAgc2NhbGU6ICJhdXRvIiwKICBzdHJva2U6ICIjY2NjIiwKICB0aWNrOiB0cnVlLAogIHRpY2tDb3VudDogNSwKICB0eXBlOiAibnVtYmVyIiwKICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5heGlzCn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29tYmluZXJzL2NvbWJpbmVBeGlzUmFuZ2VXaXRoUmV2ZXJzZS5qcwp2YXIgY29tYmluZUF4aXNSYW5nZVdpdGhSZXZlcnNlID0gKGF4aXNTZXR0aW5ncywgYXhpc1JhbmdlKSA9PiB7CiAgaWYgKCFheGlzU2V0dGluZ3MgfHwgIWF4aXNSYW5nZSkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKGF4aXNTZXR0aW5ncyAhPT0gbnVsbCAmJiBheGlzU2V0dGluZ3MgIT09IHZvaWQgMCAmJiBheGlzU2V0dGluZ3MucmV2ZXJzZWQpIHsKICAgIHJldHVybiBbYXhpc1JhbmdlWzFdLCBheGlzUmFuZ2VbMF1dOwogIH0KICByZXR1cm4gYXhpc1JhbmdlOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3BvbGFyQXhpc1NlbGVjdG9ycy5qcwp2YXIgaW1wbGljaXRBbmdsZUF4aXMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGZhbHNlLAogIGFsbG93RGVjaW1hbHM6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBmYWxzZSwKICAvLyBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSBoYXMgaXQgc2V0IHRvIHRydWUgYnV0IHRoZSBhY3R1YWwgYXhpcyByZW5kZXJpbmcgaWdub3JlcyB0aGUgcHJvcCBiZWNhdXNlIHJlYXNvbnMsCiAgZGF0YUtleTogdm9pZCAwLAogIGRvbWFpbjogdm9pZCAwLAogIGlkOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5hbmdsZUF4aXNJZCwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICBuYW1lOiB2b2lkIDAsCiAgcmV2ZXJzZWQ6IGRlZmF1bHRQb2xhckFuZ2xlQXhpc1Byb3BzLnJldmVyc2VkLAogIHNjYWxlOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5zY2FsZSwKICB0aWNrOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy50aWNrLAogIHRpY2tDb3VudDogdm9pZCAwLAogIHRpY2tzOiB2b2lkIDAsCiAgdHlwZTogZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMudHlwZSwKICB1bml0OiB2b2lkIDAKfTsKdmFyIGltcGxpY2l0UmFkaXVzQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLmFsbG93RGF0YU92ZXJmbG93LAogIGFsbG93RGVjaW1hbHM6IGZhbHNlLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgZGF0YUtleTogdm9pZCAwLAogIGRvbWFpbjogdm9pZCAwLAogIGlkOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMucmFkaXVzQXhpc0lkLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIG5hbWU6IHZvaWQgMCwKICByZXZlcnNlZDogZmFsc2UsCiAgc2NhbGU6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5zY2FsZSwKICB0aWNrOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMudGljaywKICB0aWNrQ291bnQ6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy50aWNrQ291bnQsCiAgdGlja3M6IHZvaWQgMCwKICB0eXBlOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMudHlwZSwKICB1bml0OiB2b2lkIDAKfTsKdmFyIGltcGxpY2l0UmFkaWFsQmFyQW5nbGVBeGlzID0gewogIGFsbG93RGF0YU92ZXJmbG93OiBmYWxzZSwKICBhbGxvd0RlY2ltYWxzOiBmYWxzZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogZGVmYXVsdFBvbGFyQW5nbGVBeGlzUHJvcHMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgZGF0YUtleTogdm9pZCAwLAogIGRvbWFpbjogdm9pZCAwLAogIGlkOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5hbmdsZUF4aXNJZCwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICBuYW1lOiB2b2lkIDAsCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy5zY2FsZSwKICB0aWNrOiBkZWZhdWx0UG9sYXJBbmdsZUF4aXNQcm9wcy50aWNrLAogIHRpY2tDb3VudDogdm9pZCAwLAogIHRpY2tzOiB2b2lkIDAsCiAgdHlwZTogIm51bWJlciIsCiAgdW5pdDogdm9pZCAwCn07CnZhciBpbXBsaWNpdFJhZGlhbEJhclJhZGl1c0F4aXMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGRlZmF1bHRQb2xhclJhZGl1c0F4aXNQcm9wcy5hbGxvd0RhdGFPdmVyZmxvdywKICBhbGxvd0RlY2ltYWxzOiBmYWxzZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogIGRhdGFLZXk6IHZvaWQgMCwKICBkb21haW46IHZvaWQgMCwKICBpZDogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnJhZGl1c0F4aXNJZCwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICBuYW1lOiB2b2lkIDAsCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIHNjYWxlOiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMuc2NhbGUsCiAgdGljazogZGVmYXVsdFBvbGFyUmFkaXVzQXhpc1Byb3BzLnRpY2ssCiAgdGlja0NvdW50OiBkZWZhdWx0UG9sYXJSYWRpdXNBeGlzUHJvcHMudGlja0NvdW50LAogIHRpY2tzOiB2b2lkIDAsCiAgdHlwZTogImNhdGVnb3J5IiwKICB1bml0OiB2b2lkIDAKfTsKdmFyIHNlbGVjdEFuZ2xlQXhpcyA9IChzdGF0ZSwgYW5nbGVBeGlzSWQpID0+IHsKICBpZiAoc3RhdGUucG9sYXJBeGlzLmFuZ2xlQXhpc1thbmdsZUF4aXNJZF0gIT0gbnVsbCkgewogICAgcmV0dXJuIHN0YXRlLnBvbGFyQXhpcy5hbmdsZUF4aXNbYW5nbGVBeGlzSWRdOwogIH0KICBpZiAoc3RhdGUubGF5b3V0LmxheW91dFR5cGUgPT09ICJyYWRpYWwiKSB7CiAgICByZXR1cm4gaW1wbGljaXRSYWRpYWxCYXJBbmdsZUF4aXM7CiAgfQogIHJldHVybiBpbXBsaWNpdEFuZ2xlQXhpczsKfTsKdmFyIHNlbGVjdFJhZGl1c0F4aXMgPSAoc3RhdGUsIHJhZGl1c0F4aXNJZCkgPT4gewogIGlmIChzdGF0ZS5wb2xhckF4aXMucmFkaXVzQXhpc1tyYWRpdXNBeGlzSWRdICE9IG51bGwpIHsKICAgIHJldHVybiBzdGF0ZS5wb2xhckF4aXMucmFkaXVzQXhpc1tyYWRpdXNBeGlzSWRdOwogIH0KICBpZiAoc3RhdGUubGF5b3V0LmxheW91dFR5cGUgPT09ICJyYWRpYWwiKSB7CiAgICByZXR1cm4gaW1wbGljaXRSYWRpYWxCYXJSYWRpdXNBeGlzOwogIH0KICByZXR1cm4gaW1wbGljaXRSYWRpdXNBeGlzOwp9Owp2YXIgc2VsZWN0UG9sYXJPcHRpb25zID0gKHN0YXRlKSA9PiBzdGF0ZS5wb2xhck9wdGlvbnM7CnZhciBzZWxlY3RNYXhSYWRpdXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRXaWR0aCwgc2VsZWN0Q2hhcnRIZWlnaHQsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWxdLCBnZXRNYXhSYWRpdXMpOwp2YXIgc2VsZWN0SW5uZXJSYWRpdXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UG9sYXJPcHRpb25zLCBzZWxlY3RNYXhSYWRpdXNdLCAocG9sYXJDaGFydE9wdGlvbnMsIG1heFJhZGl1cykgPT4gewogIGlmIChwb2xhckNoYXJ0T3B0aW9ucyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gZ2V0UGVyY2VudFZhbHVlKHBvbGFyQ2hhcnRPcHRpb25zLmlubmVyUmFkaXVzLCBtYXhSYWRpdXMsIDApOwp9KTsKdmFyIHNlbGVjdE91dGVyUmFkaXVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFBvbGFyT3B0aW9ucywgc2VsZWN0TWF4UmFkaXVzXSwgKHBvbGFyQ2hhcnRPcHRpb25zLCBtYXhSYWRpdXMpID0+IHsKICBpZiAocG9sYXJDaGFydE9wdGlvbnMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGdldFBlcmNlbnRWYWx1ZShwb2xhckNoYXJ0T3B0aW9ucy5vdXRlclJhZGl1cywgbWF4UmFkaXVzLCBtYXhSYWRpdXMgKiAwLjgpOwp9KTsKdmFyIGNvbWJpbmVBbmdsZUF4aXNSYW5nZSA9IChwb2xhck9wdGlvbnMpID0+IHsKICBpZiAocG9sYXJPcHRpb25zID09IG51bGwpIHsKICAgIHJldHVybiBbMCwgMF07CiAgfQogIHZhciB7CiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gcG9sYXJPcHRpb25zOwogIHJldHVybiBbc3RhcnRBbmdsZSwgZW5kQW5nbGVdOwp9Owp2YXIgc2VsZWN0QW5nbGVBeGlzUmFuZ2UgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UG9sYXJPcHRpb25zXSwgY29tYmluZUFuZ2xlQXhpc1JhbmdlKTsKdmFyIHNlbGVjdEFuZ2xlQXhpc1JhbmdlV2l0aFJldmVyc2VkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFuZ2xlQXhpcywgc2VsZWN0QW5nbGVBeGlzUmFuZ2VdLCBjb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UpOwp2YXIgc2VsZWN0UmFkaXVzQXhpc1JhbmdlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdE1heFJhZGl1cywgc2VsZWN0SW5uZXJSYWRpdXMsIHNlbGVjdE91dGVyUmFkaXVzXSwgKG1heFJhZGl1cywgaW5uZXJSYWRpdXMsIG91dGVyUmFkaXVzKSA9PiB7CiAgaWYgKG1heFJhZGl1cyA9PSBudWxsIHx8IGlubmVyUmFkaXVzID09IG51bGwgfHwgb3V0ZXJSYWRpdXMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtpbm5lclJhZGl1cywgb3V0ZXJSYWRpdXNdOwp9KTsKdmFyIHNlbGVjdFJhZGl1c0F4aXNSYW5nZVdpdGhSZXZlcnNlZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSYWRpdXNBeGlzLCBzZWxlY3RSYWRpdXNBeGlzUmFuZ2VdLCBjb21iaW5lQXhpc1JhbmdlV2l0aFJldmVyc2UpOwp2YXIgc2VsZWN0UG9sYXJWaWV3Qm94ID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RQb2xhck9wdGlvbnMsIHNlbGVjdElubmVyUmFkaXVzLCBzZWxlY3RPdXRlclJhZGl1cywgc2VsZWN0Q2hhcnRXaWR0aCwgc2VsZWN0Q2hhcnRIZWlnaHRdLCAobGF5b3V0LCBwb2xhck9wdGlvbnMsIGlubmVyUmFkaXVzLCBvdXRlclJhZGl1cywgd2lkdGgsIGhlaWdodCkgPT4gewogIGlmIChsYXlvdXQgIT09ICJjZW50cmljIiAmJiBsYXlvdXQgIT09ICJyYWRpYWwiIHx8IHBvbGFyT3B0aW9ucyA9PSBudWxsIHx8IGlubmVyUmFkaXVzID09IG51bGwgfHwgb3V0ZXJSYWRpdXMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gcG9sYXJPcHRpb25zOwogIHJldHVybiB7CiAgICBjeDogZ2V0UGVyY2VudFZhbHVlKGN4LCB3aWR0aCwgd2lkdGggLyAyKSwKICAgIGN5OiBnZXRQZXJjZW50VmFsdWUoY3ksIGhlaWdodCwgaGVpZ2h0IC8gMiksCiAgICBpbm5lclJhZGl1cywKICAgIG91dGVyUmFkaXVzLAogICAgc3RhcnRBbmdsZSwKICAgIGVuZEFuZ2xlLAogICAgY2xvY2tXaXNlOiBmYWxzZQogICAgLy8gdGhpcyBwcm9wZXJ0eSBsb29rIHVzZWZ1bCwgd2h5IG5vdCB1c2UgaXQ/CiAgfTsKfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvcGlja0F4aXNUeXBlLmpzCnZhciBwaWNrQXhpc1R5cGUgPSAoX3N0YXRlLCBheGlzVHlwZSkgPT4gYXhpc1R5cGU7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvcGlja0F4aXNJZC5qcwp2YXIgcGlja0F4aXNJZCA9IChfc3RhdGUsIF9heGlzVHlwZSwgYXhpc0lkKSA9PiBheGlzSWQ7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3N0YWNrcy9nZXRTdGFja1Nlcmllc0lkZW50aWZpZXIuanMKZnVuY3Rpb24gZ2V0U3RhY2tTZXJpZXNJZGVudGlmaWVyKGdyYXBoaWNhbEl0ZW0pIHsKICByZXR1cm4gZ3JhcGhpY2FsSXRlbSA9PT0gbnVsbCB8fCBncmFwaGljYWxJdGVtID09PSB2b2lkIDAgPyB2b2lkIDAgOiBncmFwaGljYWxJdGVtLmlkOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29tYmluZXJzL2NvbWJpbmVEaXNwbGF5ZWRTdGFja2VkRGF0YS5qcwpmdW5jdGlvbiBjb21iaW5lRGlzcGxheWVkU3RhY2tlZERhdGEoc3RhY2tlZEdyYXBoaWNhbEl0ZW1zLCBfcmVmMiwgdG9vbHRpcEF4aXNTZXR0aW5ncykgewogIHZhciB7CiAgICBjaGFydERhdGEgPSBbXQogIH0gPSBfcmVmMjsKICB2YXIgewogICAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgICBkYXRhS2V5OiB0b29sdGlwRGF0YUtleQogIH0gPSB0b29sdGlwQXhpc1NldHRpbmdzOwogIHZhciBrbm93bkl0ZW1zQnlEYXRhS2V5ID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKICBzdGFja2VkR3JhcGhpY2FsSXRlbXMuZm9yRWFjaCgoaXRlbSkgPT4gewogICAgdmFyIF9pdGVtJGRhdGE7CiAgICB2YXIgcmVzb2x2ZWREYXRhID0gKF9pdGVtJGRhdGEgPSBpdGVtLmRhdGEpICE9PSBudWxsICYmIF9pdGVtJGRhdGEgIT09IHZvaWQgMCA/IF9pdGVtJGRhdGEgOiBjaGFydERhdGE7CiAgICBpZiAocmVzb2x2ZWREYXRhID09IG51bGwgfHwgcmVzb2x2ZWREYXRhLmxlbmd0aCA9PT0gMCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgc3RhY2tJZGVudGlmaWVyID0gZ2V0U3RhY2tTZXJpZXNJZGVudGlmaWVyKGl0ZW0pOwogICAgcmVzb2x2ZWREYXRhLmZvckVhY2goKGVudHJ5LCBpbmRleCkgPT4gewogICAgICB2YXIgdG9vbHRpcFZhbHVlID0gdG9vbHRpcERhdGFLZXkgPT0gbnVsbCB8fCBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSA/IGluZGV4IDogU3RyaW5nKGdldFZhbHVlQnlEYXRhS2V5KGVudHJ5LCB0b29sdGlwRGF0YUtleSwgbnVsbCkpOwogICAgICB2YXIgbnVtZXJpY1ZhbHVlID0gZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIGl0ZW0uZGF0YUtleSwgMCk7CiAgICAgIHZhciBjdXJyOwogICAgICBpZiAoa25vd25JdGVtc0J5RGF0YUtleS5oYXModG9vbHRpcFZhbHVlKSkgewogICAgICAgIGN1cnIgPSBrbm93bkl0ZW1zQnlEYXRhS2V5LmdldCh0b29sdGlwVmFsdWUpOwogICAgICB9IGVsc2UgewogICAgICAgIGN1cnIgPSB7fTsKICAgICAgfQogICAgICBPYmplY3QuYXNzaWduKGN1cnIsIHsKICAgICAgICBbc3RhY2tJZGVudGlmaWVyXTogbnVtZXJpY1ZhbHVlCiAgICAgIH0pOwogICAgICBrbm93bkl0ZW1zQnlEYXRhS2V5LnNldCh0b29sdGlwVmFsdWUsIGN1cnIpOwogICAgfSk7CiAgfSk7CiAgcmV0dXJuIEFycmF5LmZyb20oa25vd25JdGVtc0J5RGF0YUtleS52YWx1ZXMoKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3R5cGVzL1N0YWNrZWRHcmFwaGljYWxJdGVtLmpzCmZ1bmN0aW9uIGlzU3RhY2tlZChncmFwaGljYWxJdGVtKSB7CiAgcmV0dXJuIGdyYXBoaWNhbEl0ZW0uc3RhY2tJZCAhPSBudWxsICYmIGdyYXBoaWNhbEl0ZW0uZGF0YUtleSAhPSBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjay5qcwp2YXIgbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjayA9IChhLCBiKSA9PiB7CiAgaWYgKGEgPT09IGIpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBpZiAoYSA9PSBudWxsIHx8IGIgPT0gbnVsbCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICByZXR1cm4gYVswXSA9PT0gYlswXSAmJiBhWzFdID09PSBiWzFdOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2FycmF5RXF1YWxpdHlDaGVjay5qcwpmdW5jdGlvbiBlbXB0eUFycmF5c0FyZUVxdWFsQ2hlY2soYSwgYikgewogIGlmIChBcnJheS5pc0FycmF5KGEpICYmIEFycmF5LmlzQXJyYXkoYikgJiYgYS5sZW5ndGggPT09IDAgJiYgYi5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gYSA9PT0gYjsKfQpmdW5jdGlvbiBhcnJheUNvbnRlbnRzQXJlRXF1YWxDaGVjayhhLCBiKSB7CiAgaWYgKGEubGVuZ3RoID09PSBiLmxlbmd0aCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChhW2ldICE9PSBiW2ldKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuIGZhbHNlOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvc2VsZWN0VG9vbHRpcEF4aXNUeXBlLmpzCnZhciBzZWxlY3RUb29sdGlwQXhpc1R5cGUgPSAoc3RhdGUpID0+IHsKICB2YXIgbGF5b3V0ID0gc2VsZWN0Q2hhcnRMYXlvdXQoc3RhdGUpOwogIGlmIChsYXlvdXQgPT09ICJob3Jpem9udGFsIikgewogICAgcmV0dXJuICJ4QXhpcyI7CiAgfQogIGlmIChsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIpIHsKICAgIHJldHVybiAieUF4aXMiOwogIH0KICBpZiAobGF5b3V0ID09PSAiY2VudHJpYyIpIHsKICAgIHJldHVybiAiYW5nbGVBeGlzIjsKICB9CiAgcmV0dXJuICJyYWRpdXNBeGlzIjsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RUb29sdGlwQXhpc0lkLmpzCnZhciBzZWxlY3RUb29sdGlwQXhpc0lkID0gKHN0YXRlKSA9PiBzdGF0ZS50b29sdGlwLnNldHRpbmdzLmF4aXNJZDsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9heGlzU2VsZWN0b3JzLmpzCmZ1bmN0aW9uIG93bktleXMxMyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDEzKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTMoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTEzKGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czEzKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxMyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTEzKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTEzKHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTEzKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTEzKHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgZGVmYXVsdE51bWVyaWNEb21haW4gPSBbMCwgImF1dG8iXTsKdmFyIGltcGxpY2l0WEF4aXMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGZhbHNlLAogIGFsbG93RGVjaW1hbHM6IHRydWUsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IHRydWUsCiAgYW5nbGU6IDAsCiAgZGF0YUtleTogdm9pZCAwLAogIGRvbWFpbjogdm9pZCAwLAogIGhlaWdodDogMzAsCiAgaGlkZTogdHJ1ZSwKICBpZDogMCwKICBpbmNsdWRlSGlkZGVuOiBmYWxzZSwKICBpbnRlcnZhbDogInByZXNlcnZlRW5kIiwKICBtaW5UaWNrR2FwOiA1LAogIG1pcnJvcjogZmFsc2UsCiAgbmFtZTogdm9pZCAwLAogIG9yaWVudGF0aW9uOiAiYm90dG9tIiwKICBwYWRkaW5nOiB7CiAgICBsZWZ0OiAwLAogICAgcmlnaHQ6IDAKICB9LAogIHJldmVyc2VkOiBmYWxzZSwKICBzY2FsZTogImF1dG8iLAogIHRpY2s6IHRydWUsCiAgdGlja0NvdW50OiA1LAogIHRpY2tGb3JtYXR0ZXI6IHZvaWQgMCwKICB0aWNrczogdm9pZCAwLAogIHR5cGU6ICJjYXRlZ29yeSIsCiAgdW5pdDogdm9pZCAwCn07CnZhciBzZWxlY3RYQXhpc1NldHRpbmdzTm9EZWZhdWx0cyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgcmV0dXJuIHN0YXRlLmNhcnRlc2lhbkF4aXMueEF4aXNbYXhpc0lkXTsKfTsKdmFyIHNlbGVjdFhBeGlzU2V0dGluZ3MgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciBheGlzID0gc2VsZWN0WEF4aXNTZXR0aW5nc05vRGVmYXVsdHMoc3RhdGUsIGF4aXNJZCk7CiAgaWYgKGF4aXMgPT0gbnVsbCkgewogICAgcmV0dXJuIGltcGxpY2l0WEF4aXM7CiAgfQogIHJldHVybiBheGlzOwp9Owp2YXIgaW1wbGljaXRZQXhpcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogZmFsc2UsCiAgYWxsb3dEZWNpbWFsczogdHJ1ZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogdHJ1ZSwKICBhbmdsZTogMCwKICBkYXRhS2V5OiB2b2lkIDAsCiAgZG9tYWluOiBkZWZhdWx0TnVtZXJpY0RvbWFpbiwKICBoaWRlOiB0cnVlLAogIGlkOiAwLAogIGluY2x1ZGVIaWRkZW46IGZhbHNlLAogIGludGVydmFsOiAicHJlc2VydmVFbmQiLAogIG1pblRpY2tHYXA6IDUsCiAgbWlycm9yOiBmYWxzZSwKICBuYW1lOiB2b2lkIDAsCiAgb3JpZW50YXRpb246ICJsZWZ0IiwKICBwYWRkaW5nOiB7CiAgICB0b3A6IDAsCiAgICBib3R0b206IDAKICB9LAogIHJldmVyc2VkOiBmYWxzZSwKICBzY2FsZTogImF1dG8iLAogIHRpY2s6IHRydWUsCiAgdGlja0NvdW50OiA1LAogIHRpY2tGb3JtYXR0ZXI6IHZvaWQgMCwKICB0aWNrczogdm9pZCAwLAogIHR5cGU6ICJudW1iZXIiLAogIHVuaXQ6IHZvaWQgMCwKICB3aWR0aDogREVGQVVMVF9ZX0FYSVNfV0lEVEgKfTsKdmFyIHNlbGVjdFlBeGlzU2V0dGluZ3NOb0RlZmF1bHRzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICByZXR1cm4gc3RhdGUuY2FydGVzaWFuQXhpcy55QXhpc1theGlzSWRdOwp9Owp2YXIgc2VsZWN0WUF4aXNTZXR0aW5ncyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIGF4aXMgPSBzZWxlY3RZQXhpc1NldHRpbmdzTm9EZWZhdWx0cyhzdGF0ZSwgYXhpc0lkKTsKICBpZiAoYXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gaW1wbGljaXRZQXhpczsKICB9CiAgcmV0dXJuIGF4aXM7Cn07CnZhciBpbXBsaWNpdFpBeGlzID0gewogIGRvbWFpbjogWzAsICJhdXRvIl0sCiAgaW5jbHVkZUhpZGRlbjogZmFsc2UsCiAgcmV2ZXJzZWQ6IGZhbHNlLAogIGFsbG93RGF0YU92ZXJmbG93OiBmYWxzZSwKICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogZmFsc2UsCiAgZGF0YUtleTogdm9pZCAwLAogIGlkOiAwLAogIG5hbWU6ICIiLAogIHJhbmdlOiBbNjQsIDY0XSwKICBzY2FsZTogImF1dG8iLAogIHR5cGU6ICJudW1iZXIiLAogIHVuaXQ6ICIiCn07CnZhciBzZWxlY3RaQXhpc1NldHRpbmdzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICB2YXIgYXhpcyA9IHN0YXRlLmNhcnRlc2lhbkF4aXMuekF4aXNbYXhpc0lkXTsKICBpZiAoYXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gaW1wbGljaXRaQXhpczsKICB9CiAgcmV0dXJuIGF4aXM7Cn07CnZhciBzZWxlY3RCYXNlQXhpcyA9IChzdGF0ZSwgYXhpc1R5cGUsIGF4aXNJZCkgPT4gewogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WEF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgInlBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WUF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgInpBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WkF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgImFuZ2xlQXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdEFuZ2xlQXhpcyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgInJhZGl1c0F4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RSYWRpdXNBeGlzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGF4aXMgdHlwZTogIi5jb25jYXQoYXhpc1R5cGUpKTsKICB9Cn07CnZhciBzZWxlY3RDYXJ0ZXNpYW5BeGlzU2V0dGluZ3MgPSAoc3RhdGUsIGF4aXNUeXBlLCBheGlzSWQpID0+IHsKICBzd2l0Y2ggKGF4aXNUeXBlKSB7CiAgICBjYXNlICJ4QXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFhBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBjYXNlICJ5QXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdFlBeGlzU2V0dGluZ3Moc3RhdGUsIGF4aXNJZCk7CiAgICB9CiAgICBkZWZhdWx0OgogICAgICB0aHJvdyBuZXcgRXJyb3IoIlVuZXhwZWN0ZWQgYXhpcyB0eXBlOiAiLmNvbmNhdChheGlzVHlwZSkpOwogIH0KfTsKdmFyIHNlbGVjdEF4aXNTZXR0aW5ncyA9IChzdGF0ZSwgYXhpc1R5cGUsIGF4aXNJZCkgPT4gewogIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgIGNhc2UgInhBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WEF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgInlBeGlzIjogewogICAgICByZXR1cm4gc2VsZWN0WUF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgImFuZ2xlQXhpcyI6IHsKICAgICAgcmV0dXJuIHNlbGVjdEFuZ2xlQXhpcyhzdGF0ZSwgYXhpc0lkKTsKICAgIH0KICAgIGNhc2UgInJhZGl1c0F4aXMiOiB7CiAgICAgIHJldHVybiBzZWxlY3RSYWRpdXNBeGlzKHN0YXRlLCBheGlzSWQpOwogICAgfQogICAgZGVmYXVsdDoKICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmV4cGVjdGVkIGF4aXMgdHlwZTogIi5jb25jYXQoYXhpc1R5cGUpKTsKICB9Cn07CnZhciBzZWxlY3RIYXNCYXIgPSAoc3RhdGUpID0+IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLmNhcnRlc2lhbkl0ZW1zLnNvbWUoKGl0ZW0pID0+IGl0ZW0udHlwZSA9PT0gImJhciIpIHx8IHN0YXRlLmdyYXBoaWNhbEl0ZW1zLnBvbGFySXRlbXMuc29tZSgoaXRlbSkgPT4gaXRlbS50eXBlID09PSAicmFkaWFsQmFyIik7CmZ1bmN0aW9uIGl0ZW1BeGlzUHJlZGljYXRlKGF4aXNUeXBlLCBheGlzSWQpIHsKICByZXR1cm4gKGl0ZW0pID0+IHsKICAgIHN3aXRjaCAoYXhpc1R5cGUpIHsKICAgICAgY2FzZSAieEF4aXMiOgogICAgICAgIHJldHVybiAieEF4aXNJZCIgaW4gaXRlbSAmJiBpdGVtLnhBeGlzSWQgPT09IGF4aXNJZDsKICAgICAgY2FzZSAieUF4aXMiOgogICAgICAgIHJldHVybiAieUF4aXNJZCIgaW4gaXRlbSAmJiBpdGVtLnlBeGlzSWQgPT09IGF4aXNJZDsKICAgICAgY2FzZSAiekF4aXMiOgogICAgICAgIHJldHVybiAiekF4aXNJZCIgaW4gaXRlbSAmJiBpdGVtLnpBeGlzSWQgPT09IGF4aXNJZDsKICAgICAgY2FzZSAiYW5nbGVBeGlzIjoKICAgICAgICByZXR1cm4gImFuZ2xlQXhpc0lkIiBpbiBpdGVtICYmIGl0ZW0uYW5nbGVBeGlzSWQgPT09IGF4aXNJZDsKICAgICAgY2FzZSAicmFkaXVzQXhpcyI6CiAgICAgICAgcmV0dXJuICJyYWRpdXNBeGlzSWQiIGluIGl0ZW0gJiYgaXRlbS5yYWRpdXNBeGlzSWQgPT09IGF4aXNJZDsKICAgICAgZGVmYXVsdDoKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfTsKfQp2YXIgc2VsZWN0VW5maWx0ZXJlZENhcnRlc2lhbkl0ZW1zID0gKHN0YXRlKSA9PiBzdGF0ZS5ncmFwaGljYWxJdGVtcy5jYXJ0ZXNpYW5JdGVtczsKdmFyIHNlbGVjdEF4aXNQcmVkaWNhdGUgPSBjcmVhdGVTZWxlY3RvcihbcGlja0F4aXNUeXBlLCBwaWNrQXhpc0lkXSwgaXRlbUF4aXNQcmVkaWNhdGUpOwp2YXIgY29tYmluZUdyYXBoaWNhbEl0ZW1zU2V0dGluZ3MgPSAoZ3JhcGhpY2FsSXRlbXMsIGF4aXNTZXR0aW5ncywgYXhpc1ByZWRpY2F0ZSkgPT4gZ3JhcGhpY2FsSXRlbXMuZmlsdGVyKGF4aXNQcmVkaWNhdGUpLmZpbHRlcigoaXRlbSkgPT4gewogIGlmICgoYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLmluY2x1ZGVIaWRkZW4pID09PSB0cnVlKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgcmV0dXJuICFpdGVtLmhpZGU7Cn0pOwp2YXIgc2VsZWN0Q2FydGVzaWFuSXRlbXNTZXR0aW5ncyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RVbmZpbHRlcmVkQ2FydGVzaWFuSXRlbXMsIHNlbGVjdEJhc2VBeGlzLCBzZWxlY3RBeGlzUHJlZGljYXRlXSwgY29tYmluZUdyYXBoaWNhbEl0ZW1zU2V0dGluZ3MsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogZW1wdHlBcnJheXNBcmVFcXVhbENoZWNrCiAgfQp9KTsKdmFyIHNlbGVjdFN0YWNrZWRDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENhcnRlc2lhbkl0ZW1zU2V0dGluZ3NdLCAoY2FydGVzaWFuSXRlbXMpID0+IHsKICByZXR1cm4gY2FydGVzaWFuSXRlbXMuZmlsdGVyKChpdGVtKSA9PiBpdGVtLnR5cGUgPT09ICJhcmVhIiB8fCBpdGVtLnR5cGUgPT09ICJiYXIiKS5maWx0ZXIoaXNTdGFja2VkKTsKfSk7CnZhciBmaWx0ZXJHcmFwaGljYWxOb3RTdGFja2VkSXRlbXMgPSAoY2FydGVzaWFuSXRlbXMpID0+IGNhcnRlc2lhbkl0ZW1zLmZpbHRlcigoaXRlbSkgPT4gISgic3RhY2tJZCIgaW4gaXRlbSkgfHwgaXRlbS5zdGFja0lkID09PSB2b2lkIDApOwp2YXIgc2VsZWN0Q2FydGVzaWFuSXRlbXNTZXR0aW5nc0V4Y2VwdFN0YWNrZWQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2FydGVzaWFuSXRlbXNTZXR0aW5nc10sIGZpbHRlckdyYXBoaWNhbE5vdFN0YWNrZWRJdGVtcyk7CnZhciBjb21iaW5lR3JhcGhpY2FsSXRlbXNEYXRhID0gKGNhcnRlc2lhbkl0ZW1zKSA9PiBjYXJ0ZXNpYW5JdGVtcy5tYXAoKGl0ZW0pID0+IGl0ZW0uZGF0YSkuZmlsdGVyKEJvb2xlYW4pLmZsYXQoMSk7CnZhciBzZWxlY3RDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtc0RhdGEgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2FydGVzaWFuSXRlbXNTZXR0aW5nc10sIGNvbWJpbmVHcmFwaGljYWxJdGVtc0RhdGEsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogZW1wdHlBcnJheXNBcmVFcXVhbENoZWNrCiAgfQp9KTsKdmFyIGNvbWJpbmVEaXNwbGF5ZWREYXRhID0gKGdyYXBoaWNhbEl0ZW1zRGF0YSwgX3JlZjIpID0+IHsKICB2YXIgewogICAgY2hhcnREYXRhID0gW10sCiAgICBkYXRhU3RhcnRJbmRleCwKICAgIGRhdGFFbmRJbmRleAogIH0gPSBfcmVmMjsKICBpZiAoZ3JhcGhpY2FsSXRlbXNEYXRhLmxlbmd0aCA+IDApIHsKICAgIHJldHVybiBncmFwaGljYWxJdGVtc0RhdGE7CiAgfQogIHJldHVybiBjaGFydERhdGEuc2xpY2UoZGF0YVN0YXJ0SW5kZXgsIGRhdGFFbmRJbmRleCArIDEpOwp9Owp2YXIgc2VsZWN0RGlzcGxheWVkRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtc0RhdGEsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzSWZOb3RJblBhbm9yYW1hXSwgY29tYmluZURpc3BsYXllZERhdGEpOwp2YXIgY29tYmluZUFwcGxpZWRWYWx1ZXMgPSAoZGF0YSwgYXhpc1NldHRpbmdzLCBpdGVtcykgPT4gewogIGlmICgoYXhpc1NldHRpbmdzID09PSBudWxsIHx8IGF4aXNTZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1NldHRpbmdzLmRhdGFLZXkpICE9IG51bGwpIHsKICAgIHJldHVybiBkYXRhLm1hcCgoaXRlbSkgPT4gKHsKICAgICAgdmFsdWU6IGdldFZhbHVlQnlEYXRhS2V5KGl0ZW0sIGF4aXNTZXR0aW5ncy5kYXRhS2V5KQogICAgfSkpOwogIH0KICBpZiAoaXRlbXMubGVuZ3RoID4gMCkgewogICAgcmV0dXJuIGl0ZW1zLm1hcCgoaXRlbSkgPT4gaXRlbS5kYXRhS2V5KS5mbGF0TWFwKChkYXRhS2V5KSA9PiBkYXRhLm1hcCgoZW50cnkpID0+ICh7CiAgICAgIHZhbHVlOiBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZGF0YUtleSkKICAgIH0pKSk7CiAgfQogIHJldHVybiBkYXRhLm1hcCgoZW50cnkpID0+ICh7CiAgICB2YWx1ZTogZW50cnkKICB9KSk7Cn07CnZhciBzZWxlY3RBbGxBcHBsaWVkVmFsdWVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdERpc3BsYXllZERhdGEsIHNlbGVjdEJhc2VBeGlzLCBzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzXSwgY29tYmluZUFwcGxpZWRWYWx1ZXMpOwpmdW5jdGlvbiBpc0Vycm9yQmFyUmVsZXZhbnRGb3JBeGlzVHlwZShheGlzVHlwZSwgZXJyb3JCYXIpIHsKICBzd2l0Y2ggKGF4aXNUeXBlKSB7CiAgICBjYXNlICJ4QXhpcyI6CiAgICAgIHJldHVybiBlcnJvckJhci5kaXJlY3Rpb24gPT09ICJ4IjsKICAgIGNhc2UgInlBeGlzIjoKICAgICAgcmV0dXJuIGVycm9yQmFyLmRpcmVjdGlvbiA9PT0gInkiOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIGZhbHNlOwogIH0KfQpmdW5jdGlvbiBtYWtlTnVtYmVyKHZhbCkgewogIGlmIChpc051bU9yU3RyKHZhbCkgfHwgdmFsIGluc3RhbmNlb2YgRGF0ZSkgewogICAgdmFyIG4gPSBOdW1iZXIodmFsKTsKICAgIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKG4pKSB7CiAgICAgIHJldHVybiBuOwogICAgfQogIH0KICByZXR1cm4gdm9pZCAwOwp9CmZ1bmN0aW9uIG1ha2VEb21haW4odmFsKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkgewogICAgdmFyIGF0dGVtcHQgPSBbbWFrZU51bWJlcih2YWxbMF0pLCBtYWtlTnVtYmVyKHZhbFsxXSldOwogICAgaWYgKGlzV2VsbEZvcm1lZE51bWJlckRvbWFpbihhdHRlbXB0KSkgewogICAgICByZXR1cm4gYXR0ZW1wdDsKICAgIH0KICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBuID0gbWFrZU51bWJlcih2YWwpOwogIGlmIChuID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBbbiwgbl07Cn0KZnVuY3Rpb24gb25seUFsbG93TnVtYmVycyhkYXRhKSB7CiAgcmV0dXJuIGRhdGEubWFwKG1ha2VOdW1iZXIpLmZpbHRlcihpc05vdE5pbCk7Cn0KZnVuY3Rpb24gZ2V0RXJyb3JEb21haW5CeURhdGFLZXkoZW50cnksIGFwcGxpZWRWYWx1ZSwgcmVsZXZhbnRFcnJvckJhcnMpIHsKICBpZiAoIXJlbGV2YW50RXJyb3JCYXJzIHx8IHR5cGVvZiBhcHBsaWVkVmFsdWUgIT09ICJudW1iZXIiIHx8IGlzTmFuKGFwcGxpZWRWYWx1ZSkpIHsKICAgIHJldHVybiBbXTsKICB9CiAgaWYgKCFyZWxldmFudEVycm9yQmFycy5sZW5ndGgpIHsKICAgIHJldHVybiBbXTsKICB9CiAgcmV0dXJuIG9ubHlBbGxvd051bWJlcnMocmVsZXZhbnRFcnJvckJhcnMuZmxhdE1hcCgoZWIpID0+IHsKICAgIHZhciBlcnJvclZhbHVlID0gZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIGViLmRhdGFLZXkpOwogICAgdmFyIGxvd0JvdW5kLCBoaWdoQm91bmQ7CiAgICBpZiAoQXJyYXkuaXNBcnJheShlcnJvclZhbHVlKSkgewogICAgICBbbG93Qm91bmQsIGhpZ2hCb3VuZF0gPSBlcnJvclZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgbG93Qm91bmQgPSBoaWdoQm91bmQgPSBlcnJvclZhbHVlOwogICAgfQogICAgaWYgKCFpc1dlbGxCZWhhdmVkTnVtYmVyKGxvd0JvdW5kKSB8fCAhaXNXZWxsQmVoYXZlZE51bWJlcihoaWdoQm91bmQpKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICByZXR1cm4gW2FwcGxpZWRWYWx1ZSAtIGxvd0JvdW5kLCBhcHBsaWVkVmFsdWUgKyBoaWdoQm91bmRdOwogIH0pKTsKfQp2YXIgc2VsZWN0VG9vbHRpcEF4aXMgPSAoc3RhdGUpID0+IHsKICB2YXIgYXhpc1R5cGUgPSBzZWxlY3RUb29sdGlwQXhpc1R5cGUoc3RhdGUpOwogIHZhciBheGlzSWQgPSBzZWxlY3RUb29sdGlwQXhpc0lkKHN0YXRlKTsKICByZXR1cm4gc2VsZWN0QXhpc1NldHRpbmdzKHN0YXRlLCBheGlzVHlwZSwgYXhpc0lkKTsKfTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc10sIChheGlzKSA9PiBheGlzID09PSBudWxsIHx8IGF4aXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF4aXMuZGF0YUtleSk7CnZhciBzZWxlY3REaXNwbGF5ZWRTdGFja2VkRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RTdGFja2VkQ2FydGVzaWFuSXRlbXNTZXR0aW5ncywgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXNJZk5vdEluUGFub3JhbWEsIHNlbGVjdFRvb2x0aXBBeGlzXSwgY29tYmluZURpc3BsYXllZFN0YWNrZWREYXRhKTsKdmFyIGNvbWJpbmVTdGFja0dyb3VwcyA9IChkaXNwbGF5ZWREYXRhLCBpdGVtcywgc3RhY2tPZmZzZXRUeXBlLCByZXZlcnNlU3RhY2tPcmRlcikgPT4gewogIHZhciBpbml0aWFsSXRlbXNHcm91cHMgPSB7fTsKICB2YXIgaXRlbXNHcm91cCA9IGl0ZW1zLnJlZHVjZSgoYWNjLCBpdGVtKSA9PiB7CiAgICBpZiAoaXRlbS5zdGFja0lkID09IG51bGwpIHsKICAgICAgcmV0dXJuIGFjYzsKICAgIH0KICAgIGlmIChhY2NbaXRlbS5zdGFja0lkXSA9PSBudWxsKSB7CiAgICAgIGFjY1tpdGVtLnN0YWNrSWRdID0gW107CiAgICB9CiAgICBhY2NbaXRlbS5zdGFja0lkXS5wdXNoKGl0ZW0pOwogICAgcmV0dXJuIGFjYzsKICB9LCBpbml0aWFsSXRlbXNHcm91cHMpOwogIHJldHVybiBPYmplY3QuZnJvbUVudHJpZXMoT2JqZWN0LmVudHJpZXMoaXRlbXNHcm91cCkubWFwKChfcmVmMikgPT4gewogICAgdmFyIFtzdGFja0lkLCBncmFwaGljYWxJdGVtc10gPSBfcmVmMjsKICAgIHZhciBvcmRlcmVkR3JhcGhpY2FsSXRlbXMgPSByZXZlcnNlU3RhY2tPcmRlciA/IFsuLi5ncmFwaGljYWxJdGVtc10ucmV2ZXJzZSgpIDogZ3JhcGhpY2FsSXRlbXM7CiAgICB2YXIgZGF0YUtleXMgPSBvcmRlcmVkR3JhcGhpY2FsSXRlbXMubWFwKGdldFN0YWNrU2VyaWVzSWRlbnRpZmllcik7CiAgICByZXR1cm4gW3N0YWNrSWQsIHsKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBnZXRTdGFja2VkRGF0YSByZXF1aXJlcyB0aGF0IHRoZSBpbnB1dCBpcyBhcnJheSBvZiBvYmplY3RzLCBSZWNoYXJ0cyBkb2VzIG5vdCB0ZXN0IGZvciB0aGF0CiAgICAgIHN0YWNrZWREYXRhOiBnZXRTdGFja2VkRGF0YShkaXNwbGF5ZWREYXRhLCBkYXRhS2V5cywgc3RhY2tPZmZzZXRUeXBlKSwKICAgICAgZ3JhcGhpY2FsSXRlbXM6IG9yZGVyZWRHcmFwaGljYWxJdGVtcwogICAgfV07CiAgfSkpOwp9Owp2YXIgc2VsZWN0U3RhY2tHcm91cHMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0RGlzcGxheWVkU3RhY2tlZERhdGEsIHNlbGVjdFN0YWNrZWRDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzLCBzZWxlY3RTdGFja09mZnNldFR5cGUsIHNlbGVjdFJldmVyc2VTdGFja09yZGVyXSwgY29tYmluZVN0YWNrR3JvdXBzKTsKdmFyIGNvbWJpbmVEb21haW5PZlN0YWNrR3JvdXBzID0gKHN0YWNrR3JvdXBzLCBfcmVmMywgYXhpc1R5cGUsIGRvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZSkgPT4gewogIHZhciB7CiAgICBkYXRhU3RhcnRJbmRleCwKICAgIGRhdGFFbmRJbmRleAogIH0gPSBfcmVmMzsKICBpZiAoZG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlICE9IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChheGlzVHlwZSA9PT0gInpBeGlzIikgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGRvbWFpbk9mU3RhY2tHcm91cHMgPSBnZXREb21haW5PZlN0YWNrR3JvdXBzKHN0YWNrR3JvdXBzLCBkYXRhU3RhcnRJbmRleCwgZGF0YUVuZEluZGV4KTsKICBpZiAoZG9tYWluT2ZTdGFja0dyb3VwcyAhPSBudWxsICYmIGRvbWFpbk9mU3RhY2tHcm91cHNbMF0gPT09IDAgJiYgZG9tYWluT2ZTdGFja0dyb3Vwc1sxXSA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIGRvbWFpbk9mU3RhY2tHcm91cHM7Cn07CnZhciBzZWxlY3RBbGxvd3NEYXRhT3ZlcmZsb3cgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXNdLCAoYXhpc1NldHRpbmdzKSA9PiBheGlzU2V0dGluZ3MuYWxsb3dEYXRhT3ZlcmZsb3cpOwp2YXIgZ2V0RG9tYWluRGVmaW5pdGlvbiA9IChheGlzU2V0dGluZ3MpID0+IHsKICB2YXIgX2F4aXNTZXR0aW5ncyRkb21haW47CiAgaWYgKGF4aXNTZXR0aW5ncyA9PSBudWxsIHx8ICEoImRvbWFpbiIgaW4gYXhpc1NldHRpbmdzKSkgewogICAgcmV0dXJuIGRlZmF1bHROdW1lcmljRG9tYWluOwogIH0KICBpZiAoYXhpc1NldHRpbmdzLmRvbWFpbiAhPSBudWxsKSB7CiAgICByZXR1cm4gYXhpc1NldHRpbmdzLmRvbWFpbjsKICB9CiAgaWYgKGF4aXNTZXR0aW5ncy50aWNrcyAhPSBudWxsKSB7CiAgICBpZiAoYXhpc1NldHRpbmdzLnR5cGUgPT09ICJudW1iZXIiKSB7CiAgICAgIHZhciBhbGxWYWx1ZXMgPSBvbmx5QWxsb3dOdW1iZXJzKGF4aXNTZXR0aW5ncy50aWNrcyk7CiAgICAgIHJldHVybiBbTWF0aC5taW4oLi4uYWxsVmFsdWVzKSwgTWF0aC5tYXgoLi4uYWxsVmFsdWVzKV07CiAgICB9CiAgICBpZiAoYXhpc1NldHRpbmdzLnR5cGUgPT09ICJjYXRlZ29yeSIpIHsKICAgICAgcmV0dXJuIGF4aXNTZXR0aW5ncy50aWNrcy5tYXAoU3RyaW5nKTsKICAgIH0KICB9CiAgcmV0dXJuIChfYXhpc1NldHRpbmdzJGRvbWFpbiA9IGF4aXNTZXR0aW5ncyA9PT0gbnVsbCB8fCBheGlzU2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF4aXNTZXR0aW5ncy5kb21haW4pICE9PSBudWxsICYmIF9heGlzU2V0dGluZ3MkZG9tYWluICE9PSB2b2lkIDAgPyBfYXhpc1NldHRpbmdzJGRvbWFpbiA6IGRlZmF1bHROdW1lcmljRG9tYWluOwp9Owp2YXIgc2VsZWN0RG9tYWluRGVmaW5pdGlvbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpc10sIGdldERvbWFpbkRlZmluaXRpb24pOwp2YXIgc2VsZWN0RG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdERvbWFpbkRlZmluaXRpb24sIHNlbGVjdEFsbG93c0RhdGFPdmVyZmxvd10sIG51bWVyaWNhbERvbWFpblNwZWNpZmllZFdpdGhvdXRSZXF1aXJpbmdEYXRhKTsKdmFyIHNlbGVjdERvbWFpbk9mU3RhY2tHcm91cHMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0U3RhY2tHcm91cHMsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzLCBwaWNrQXhpc1R5cGUsIHNlbGVjdERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZV0sIGNvbWJpbmVEb21haW5PZlN0YWNrR3JvdXBzLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IG51bWJlckRvbWFpbkVxdWFsaXR5Q2hlY2sKICB9Cn0pOwp2YXIgc2VsZWN0QWxsRXJyb3JCYXJTZXR0aW5ncyA9IChzdGF0ZSkgPT4gc3RhdGUuZXJyb3JCYXJzOwp2YXIgY29tYmluZVJlbGV2YW50RXJyb3JCYXJTZXR0aW5ncyA9IChjYXJ0ZXNpYW5JdGVtc1NldHRpbmdzLCBhbGxFcnJvckJhclNldHRpbmdzLCBheGlzVHlwZSkgPT4gewogIHJldHVybiBjYXJ0ZXNpYW5JdGVtc1NldHRpbmdzLmZsYXRNYXAoKGl0ZW0pID0+IHsKICAgIHJldHVybiBhbGxFcnJvckJhclNldHRpbmdzW2l0ZW0uaWRdOwogIH0pLmZpbHRlcihCb29sZWFuKS5maWx0ZXIoKGUpID0+IHsKICAgIHJldHVybiBpc0Vycm9yQmFyUmVsZXZhbnRGb3JBeGlzVHlwZShheGlzVHlwZSwgZSk7CiAgfSk7Cn07CnZhciBtZXJnZURvbWFpbnMgPSBmdW5jdGlvbiBtZXJnZURvbWFpbnMyKCkgewogIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBkb21haW5zID0gbmV3IEFycmF5KF9sZW4pLCBfa2V5ID0gMDsgX2tleSA8IF9sZW47IF9rZXkrKykgewogICAgZG9tYWluc1tfa2V5XSA9IGFyZ3VtZW50c1tfa2V5XTsKICB9CiAgdmFyIGFsbERvbWFpbnMgPSBkb21haW5zLmZpbHRlcihCb29sZWFuKTsKICBpZiAoYWxsRG9tYWlucy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBhbGxWYWx1ZXMgPSBhbGxEb21haW5zLmZsYXQoKTsKICB2YXIgbWluMiA9IE1hdGgubWluKC4uLmFsbFZhbHVlcyk7CiAgdmFyIG1heDIgPSBNYXRoLm1heCguLi5hbGxWYWx1ZXMpOwogIHJldHVybiBbbWluMiwgbWF4Ml07Cn07CnZhciBjb21iaW5lRG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMgPSAoZGF0YSwgYXhpc1NldHRpbmdzLCBpdGVtcywgZXJyb3JCYXJzLCBheGlzVHlwZSkgPT4gewogIHZhciBsb3dlckVuZCwgdXBwZXJFbmQ7CiAgaWYgKGl0ZW1zLmxlbmd0aCA+IDApIHsKICAgIGRhdGEuZm9yRWFjaCgoZW50cnkpID0+IHsKICAgICAgaXRlbXMuZm9yRWFjaCgoaXRlbSkgPT4gewogICAgICAgIHZhciBfZXJyb3JCYXJzJGl0ZW0kaWQsIF9heGlzU2V0dGluZ3MkZGF0YUtleTsKICAgICAgICB2YXIgcmVsZXZhbnRFcnJvckJhcnMgPSAoX2Vycm9yQmFycyRpdGVtJGlkID0gZXJyb3JCYXJzW2l0ZW0uaWRdKSA9PT0gbnVsbCB8fCBfZXJyb3JCYXJzJGl0ZW0kaWQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lcnJvckJhcnMkaXRlbSRpZC5maWx0ZXIoKGVycm9yQmFyKSA9PiBpc0Vycm9yQmFyUmVsZXZhbnRGb3JBeGlzVHlwZShheGlzVHlwZSwgZXJyb3JCYXIpKTsKICAgICAgICB2YXIgdmFsdWVCeURhdGFLZXkgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgKF9heGlzU2V0dGluZ3MkZGF0YUtleSA9IGF4aXNTZXR0aW5ncy5kYXRhS2V5KSAhPT0gbnVsbCAmJiBfYXhpc1NldHRpbmdzJGRhdGFLZXkgIT09IHZvaWQgMCA/IF9heGlzU2V0dGluZ3MkZGF0YUtleSA6IGl0ZW0uZGF0YUtleSk7CiAgICAgICAgdmFyIGVycm9yRG9tYWluID0gZ2V0RXJyb3JEb21haW5CeURhdGFLZXkoZW50cnksIHZhbHVlQnlEYXRhS2V5LCByZWxldmFudEVycm9yQmFycyk7CiAgICAgICAgaWYgKGVycm9yRG9tYWluLmxlbmd0aCA+PSAyKSB7CiAgICAgICAgICB2YXIgbG9jYWxMb3dlciA9IE1hdGgubWluKC4uLmVycm9yRG9tYWluKTsKICAgICAgICAgIHZhciBsb2NhbFVwcGVyID0gTWF0aC5tYXgoLi4uZXJyb3JEb21haW4pOwogICAgICAgICAgaWYgKGxvd2VyRW5kID09IG51bGwgfHwgbG9jYWxMb3dlciA8IGxvd2VyRW5kKSB7CiAgICAgICAgICAgIGxvd2VyRW5kID0gbG9jYWxMb3dlcjsKICAgICAgICAgIH0KICAgICAgICAgIGlmICh1cHBlckVuZCA9PSBudWxsIHx8IGxvY2FsVXBwZXIgPiB1cHBlckVuZCkgewogICAgICAgICAgICB1cHBlckVuZCA9IGxvY2FsVXBwZXI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHZhciBkYXRhVmFsdWVEb21haW4gPSBtYWtlRG9tYWluKHZhbHVlQnlEYXRhS2V5KTsKICAgICAgICBpZiAoZGF0YVZhbHVlRG9tYWluICE9IG51bGwpIHsKICAgICAgICAgIGxvd2VyRW5kID0gbG93ZXJFbmQgPT0gbnVsbCA/IGRhdGFWYWx1ZURvbWFpblswXSA6IE1hdGgubWluKGxvd2VyRW5kLCBkYXRhVmFsdWVEb21haW5bMF0pOwogICAgICAgICAgdXBwZXJFbmQgPSB1cHBlckVuZCA9PSBudWxsID8gZGF0YVZhbHVlRG9tYWluWzFdIDogTWF0aC5tYXgodXBwZXJFbmQsIGRhdGFWYWx1ZURvbWFpblsxXSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0pOwogIH0KICBpZiAoKGF4aXNTZXR0aW5ncyA9PT0gbnVsbCB8fCBheGlzU2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF4aXNTZXR0aW5ncy5kYXRhS2V5KSAhPSBudWxsKSB7CiAgICBkYXRhLmZvckVhY2goKGl0ZW0pID0+IHsKICAgICAgdmFyIGRhdGFWYWx1ZURvbWFpbiA9IG1ha2VEb21haW4oZ2V0VmFsdWVCeURhdGFLZXkoaXRlbSwgYXhpc1NldHRpbmdzLmRhdGFLZXkpKTsKICAgICAgaWYgKGRhdGFWYWx1ZURvbWFpbiAhPSBudWxsKSB7CiAgICAgICAgbG93ZXJFbmQgPSBsb3dlckVuZCA9PSBudWxsID8gZGF0YVZhbHVlRG9tYWluWzBdIDogTWF0aC5taW4obG93ZXJFbmQsIGRhdGFWYWx1ZURvbWFpblswXSk7CiAgICAgICAgdXBwZXJFbmQgPSB1cHBlckVuZCA9PSBudWxsID8gZGF0YVZhbHVlRG9tYWluWzFdIDogTWF0aC5tYXgodXBwZXJFbmQsIGRhdGFWYWx1ZURvbWFpblsxXSk7CiAgICAgIH0KICAgIH0pOwogIH0KICBpZiAoaXNXZWxsQmVoYXZlZE51bWJlcihsb3dlckVuZCkgJiYgaXNXZWxsQmVoYXZlZE51bWJlcih1cHBlckVuZCkpIHsKICAgIHJldHVybiBbbG93ZXJFbmQsIHVwcGVyRW5kXTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIHNlbGVjdERvbWFpbk9mQWxsQXBwbGllZE51bWVyaWNhbFZhbHVlc0luY2x1ZGluZ0Vycm9yVmFsdWVzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdERpc3BsYXllZERhdGEsIHNlbGVjdEJhc2VBeGlzLCBzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzRXhjZXB0U3RhY2tlZCwgc2VsZWN0QWxsRXJyb3JCYXJTZXR0aW5ncywgcGlja0F4aXNUeXBlXSwgY29tYmluZURvbWFpbk9mQWxsQXBwbGllZE51bWVyaWNhbFZhbHVlc0luY2x1ZGluZ0Vycm9yVmFsdWVzLCB7CiAgbWVtb2l6ZU9wdGlvbnM6IHsKICAgIHJlc3VsdEVxdWFsaXR5Q2hlY2s6IG51bWJlckRvbWFpbkVxdWFsaXR5Q2hlY2sKICB9Cn0pOwpmdW5jdGlvbiBvbmx5QWxsb3dOdW1iZXJzQW5kU3RyaW5nc0FuZERhdGVzKGl0ZW0pIHsKICB2YXIgewogICAgdmFsdWUKICB9ID0gaXRlbTsKICBpZiAoaXNOdW1PclN0cih2YWx1ZSkgfHwgdmFsdWUgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIHJldHVybiB2b2lkIDA7Cn0KdmFyIGNvbXB1dGVEb21haW5PZlR5cGVDYXRlZ29yeSA9IChhbGxEYXRhU3F1aXNoZWQsIGF4aXNTZXR0aW5ncywgaXNDYXRlZ29yaWNhbCkgPT4gewogIHZhciBjYXRlZ29yaWNhbERvbWFpbiA9IGFsbERhdGFTcXVpc2hlZC5tYXAob25seUFsbG93TnVtYmVyc0FuZFN0cmluZ3NBbmREYXRlcykuZmlsdGVyKCh2KSA9PiB2ICE9IG51bGwpOwogIGlmIChpc0NhdGVnb3JpY2FsICYmIChheGlzU2V0dGluZ3MuZGF0YUtleSA9PSBudWxsIHx8IGF4aXNTZXR0aW5ncy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSAmJiBoYXNEdXBsaWNhdGUoY2F0ZWdvcmljYWxEb21haW4pKSkgewogICAgcmV0dXJuICgwLCBpbXBvcnRfcmFuZ2UyLmRlZmF1bHQpKDAsIGFsbERhdGFTcXVpc2hlZC5sZW5ndGgpOwogIH0KICBpZiAoYXhpc1NldHRpbmdzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5KSB7CiAgICByZXR1cm4gY2F0ZWdvcmljYWxEb21haW47CiAgfQogIHJldHVybiBBcnJheS5mcm9tKG5ldyBTZXQoY2F0ZWdvcmljYWxEb21haW4pKTsKfTsKdmFyIHNlbGVjdFJlZmVyZW5jZURvdHMgPSAoc3RhdGUpID0+IHN0YXRlLnJlZmVyZW5jZUVsZW1lbnRzLmRvdHM7CnZhciBmaWx0ZXJSZWZlcmVuY2VFbGVtZW50cyA9IChlbGVtZW50cywgYXhpc1R5cGUsIGF4aXNJZCkgPT4gewogIHJldHVybiBlbGVtZW50cy5maWx0ZXIoKGVsKSA9PiBlbC5pZk92ZXJmbG93ID09PSAiZXh0ZW5kRG9tYWluIikuZmlsdGVyKChlbCkgPT4gewogICAgaWYgKGF4aXNUeXBlID09PSAieEF4aXMiKSB7CiAgICAgIHJldHVybiBlbC54QXhpc0lkID09PSBheGlzSWQ7CiAgICB9CiAgICByZXR1cm4gZWwueUF4aXNJZCA9PT0gYXhpc0lkOwogIH0pOwp9Owp2YXIgc2VsZWN0UmVmZXJlbmNlRG90c0J5QXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VEb3RzLCBwaWNrQXhpc1R5cGUsIHBpY2tBeGlzSWRdLCBmaWx0ZXJSZWZlcmVuY2VFbGVtZW50cyk7CnZhciBzZWxlY3RSZWZlcmVuY2VBcmVhcyA9IChzdGF0ZSkgPT4gc3RhdGUucmVmZXJlbmNlRWxlbWVudHMuYXJlYXM7CnZhciBzZWxlY3RSZWZlcmVuY2VBcmVhc0J5QXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VBcmVhcywgcGlja0F4aXNUeXBlLCBwaWNrQXhpc0lkXSwgZmlsdGVyUmVmZXJlbmNlRWxlbWVudHMpOwp2YXIgc2VsZWN0UmVmZXJlbmNlTGluZXMgPSAoc3RhdGUpID0+IHN0YXRlLnJlZmVyZW5jZUVsZW1lbnRzLmxpbmVzOwp2YXIgc2VsZWN0UmVmZXJlbmNlTGluZXNCeUF4aXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlTGluZXMsIHBpY2tBeGlzVHlwZSwgcGlja0F4aXNJZF0sIGZpbHRlclJlZmVyZW5jZUVsZW1lbnRzKTsKdmFyIGNvbWJpbmVEb3RzRG9tYWluID0gKGRvdHMsIGF4aXNUeXBlKSA9PiB7CiAgdmFyIGFsbENvb3JkcyA9IG9ubHlBbGxvd051bWJlcnMoZG90cy5tYXAoKGRvdCkgPT4gYXhpc1R5cGUgPT09ICJ4QXhpcyIgPyBkb3QueCA6IGRvdC55KSk7CiAgaWYgKGFsbENvb3Jkcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBbTWF0aC5taW4oLi4uYWxsQ29vcmRzKSwgTWF0aC5tYXgoLi4uYWxsQ29vcmRzKV07Cn07CnZhciBzZWxlY3RSZWZlcmVuY2VEb3RzRG9tYWluID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0UmVmZXJlbmNlRG90c0J5QXhpcywgcGlja0F4aXNUeXBlLCBjb21iaW5lRG90c0RvbWFpbik7CnZhciBjb21iaW5lQXJlYXNEb21haW4gPSAoYXJlYXMsIGF4aXNUeXBlKSA9PiB7CiAgdmFyIGFsbENvb3JkcyA9IG9ubHlBbGxvd051bWJlcnMoYXJlYXMuZmxhdE1hcCgoYXJlYSkgPT4gW2F4aXNUeXBlID09PSAieEF4aXMiID8gYXJlYS54MSA6IGFyZWEueTEsIGF4aXNUeXBlID09PSAieEF4aXMiID8gYXJlYS54MiA6IGFyZWEueTJdKSk7CiAgaWYgKGFsbENvb3Jkcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBbTWF0aC5taW4oLi4uYWxsQ29vcmRzKSwgTWF0aC5tYXgoLi4uYWxsQ29vcmRzKV07Cn07CnZhciBzZWxlY3RSZWZlcmVuY2VBcmVhc0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VBcmVhc0J5QXhpcywgcGlja0F4aXNUeXBlXSwgY29tYmluZUFyZWFzRG9tYWluKTsKZnVuY3Rpb24gZXh0cmFjdFhDb29yZGluYXRlcyhsaW5lKSB7CiAgdmFyIF9saW5lJHNlZ21lbnQ7CiAgaWYgKGxpbmUueCAhPSBudWxsKSB7CiAgICByZXR1cm4gb25seUFsbG93TnVtYmVycyhbbGluZS54XSk7CiAgfQogIHZhciBzZWdtZW50Q29vcmRpbmF0ZXMgPSAoX2xpbmUkc2VnbWVudCA9IGxpbmUuc2VnbWVudCkgPT09IG51bGwgfHwgX2xpbmUkc2VnbWVudCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2xpbmUkc2VnbWVudC5tYXAoKHMpID0+IHMueCk7CiAgaWYgKHNlZ21lbnRDb29yZGluYXRlcyA9PSBudWxsIHx8IHNlZ21lbnRDb29yZGluYXRlcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBbXTsKICB9CiAgcmV0dXJuIG9ubHlBbGxvd051bWJlcnMoc2VnbWVudENvb3JkaW5hdGVzKTsKfQpmdW5jdGlvbiBleHRyYWN0WUNvb3JkaW5hdGVzKGxpbmUpIHsKICB2YXIgX2xpbmUkc2VnbWVudDI7CiAgaWYgKGxpbmUueSAhPSBudWxsKSB7CiAgICByZXR1cm4gb25seUFsbG93TnVtYmVycyhbbGluZS55XSk7CiAgfQogIHZhciBzZWdtZW50Q29vcmRpbmF0ZXMgPSAoX2xpbmUkc2VnbWVudDIgPSBsaW5lLnNlZ21lbnQpID09PSBudWxsIHx8IF9saW5lJHNlZ21lbnQyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfbGluZSRzZWdtZW50Mi5tYXAoKHMpID0+IHMueSk7CiAgaWYgKHNlZ21lbnRDb29yZGluYXRlcyA9PSBudWxsIHx8IHNlZ21lbnRDb29yZGluYXRlcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBbXTsKICB9CiAgcmV0dXJuIG9ubHlBbGxvd051bWJlcnMoc2VnbWVudENvb3JkaW5hdGVzKTsKfQp2YXIgY29tYmluZUxpbmVzRG9tYWluID0gKGxpbmVzLCBheGlzVHlwZSkgPT4gewogIHZhciBhbGxDb29yZHMgPSBsaW5lcy5mbGF0TWFwKChsaW5lKSA9PiBheGlzVHlwZSA9PT0gInhBeGlzIiA/IGV4dHJhY3RYQ29vcmRpbmF0ZXMobGluZSkgOiBleHRyYWN0WUNvb3JkaW5hdGVzKGxpbmUpKTsKICBpZiAoYWxsQ29vcmRzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIFtNYXRoLm1pbiguLi5hbGxDb29yZHMpLCBNYXRoLm1heCguLi5hbGxDb29yZHMpXTsKfTsKdmFyIHNlbGVjdFJlZmVyZW5jZUxpbmVzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUxpbmVzQnlBeGlzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lTGluZXNEb21haW4pOwp2YXIgc2VsZWN0UmVmZXJlbmNlRWxlbWVudHNEb21haW4gPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RSZWZlcmVuY2VEb3RzRG9tYWluLCBzZWxlY3RSZWZlcmVuY2VMaW5lc0RvbWFpbiwgc2VsZWN0UmVmZXJlbmNlQXJlYXNEb21haW4sIChkb3RzRG9tYWluLCBsaW5lc0RvbWFpbiwgYXJlYXNEb21haW4pID0+IHsKICByZXR1cm4gbWVyZ2VEb21haW5zKGRvdHNEb21haW4sIGFyZWFzRG9tYWluLCBsaW5lc0RvbWFpbik7Cn0pOwp2YXIgY29tYmluZU51bWVyaWNhbERvbWFpbiA9IChheGlzU2V0dGluZ3MsIGRvbWFpbkRlZmluaXRpb24sIGRvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZSwgZG9tYWluT2ZTdGFja0dyb3VwcywgZGF0YUFuZEVycm9yQmFyc0RvbWFpbiwgcmVmZXJlbmNlRWxlbWVudHNEb21haW4sIGxheW91dCwgYXhpc1R5cGUpID0+IHsKICBpZiAoZG9tYWluRnJvbVVzZXJQcmVmZXJlbmNlICE9IG51bGwpIHsKICAgIHJldHVybiBkb21haW5Gcm9tVXNlclByZWZlcmVuY2U7CiAgfQogIHZhciBzaG91bGRJbmNsdWRlRG9tYWluT2ZTdGFja0dyb3VwcyA9IGxheW91dCA9PT0gInZlcnRpY2FsIiAmJiBheGlzVHlwZSA9PT0gInhBeGlzIiB8fCBsYXlvdXQgPT09ICJob3Jpem9udGFsIiAmJiBheGlzVHlwZSA9PT0gInlBeGlzIjsKICB2YXIgbWVyZ2VkRG9tYWlucyA9IHNob3VsZEluY2x1ZGVEb21haW5PZlN0YWNrR3JvdXBzID8gbWVyZ2VEb21haW5zKGRvbWFpbk9mU3RhY2tHcm91cHMsIHJlZmVyZW5jZUVsZW1lbnRzRG9tYWluLCBkYXRhQW5kRXJyb3JCYXJzRG9tYWluKSA6IG1lcmdlRG9tYWlucyhyZWZlcmVuY2VFbGVtZW50c0RvbWFpbiwgZGF0YUFuZEVycm9yQmFyc0RvbWFpbik7CiAgcmV0dXJuIHBhcnNlTnVtZXJpY2FsVXNlckRvbWFpbihkb21haW5EZWZpbml0aW9uLCBtZXJnZWREb21haW5zLCBheGlzU2V0dGluZ3MuYWxsb3dEYXRhT3ZlcmZsb3cpOwp9Owp2YXIgc2VsZWN0TnVtZXJpY2FsRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEJhc2VBeGlzLCBzZWxlY3REb21haW5EZWZpbml0aW9uLCBzZWxlY3REb21haW5Gcm9tVXNlclByZWZlcmVuY2UsIHNlbGVjdERvbWFpbk9mU3RhY2tHcm91cHMsIHNlbGVjdERvbWFpbk9mQWxsQXBwbGllZE51bWVyaWNhbFZhbHVlc0luY2x1ZGluZ0Vycm9yVmFsdWVzLCBzZWxlY3RSZWZlcmVuY2VFbGVtZW50c0RvbWFpbiwgc2VsZWN0Q2hhcnRMYXlvdXQsIHBpY2tBeGlzVHlwZV0sIGNvbWJpbmVOdW1lcmljYWxEb21haW4sIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjawogIH0KfSk7CnZhciBleHBhbmREb21haW4gPSBbMCwgMV07CnZhciBjb21iaW5lQXhpc0RvbWFpbiA9IChheGlzU2V0dGluZ3MsIGxheW91dCwgZGlzcGxheWVkRGF0YSwgYWxsQXBwbGllZFZhbHVlcywgc3RhY2tPZmZzZXRUeXBlLCBheGlzVHlwZSwgbnVtZXJpY2FsRG9tYWluKSA9PiB7CiAgaWYgKChheGlzU2V0dGluZ3MgPT0gbnVsbCB8fCBkaXNwbGF5ZWREYXRhID09IG51bGwgfHwgZGlzcGxheWVkRGF0YS5sZW5ndGggPT09IDApICYmIG51bWVyaWNhbERvbWFpbiA9PT0gdm9pZCAwKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgZGF0YUtleSwKICAgIHR5cGUKICB9ID0gYXhpc1NldHRpbmdzOwogIHZhciBpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCBheGlzVHlwZSk7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgZGF0YUtleSA9PSBudWxsKSB7CiAgICB2YXIgX2Rpc3BsYXllZERhdGEkbGVuZ3RoOwogICAgcmV0dXJuICgwLCBpbXBvcnRfcmFuZ2UyLmRlZmF1bHQpKDAsIChfZGlzcGxheWVkRGF0YSRsZW5ndGggPSBkaXNwbGF5ZWREYXRhID09PSBudWxsIHx8IGRpc3BsYXllZERhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRpc3BsYXllZERhdGEubGVuZ3RoKSAhPT0gbnVsbCAmJiBfZGlzcGxheWVkRGF0YSRsZW5ndGggIT09IHZvaWQgMCA/IF9kaXNwbGF5ZWREYXRhJGxlbmd0aCA6IDApOwogIH0KICBpZiAodHlwZSA9PT0gImNhdGVnb3J5IikgewogICAgcmV0dXJuIGNvbXB1dGVEb21haW5PZlR5cGVDYXRlZ29yeShhbGxBcHBsaWVkVmFsdWVzLCBheGlzU2V0dGluZ3MsIGlzQ2F0ZWdvcmljYWwpOwogIH0KICBpZiAoc3RhY2tPZmZzZXRUeXBlID09PSAiZXhwYW5kIikgewogICAgcmV0dXJuIGV4cGFuZERvbWFpbjsKICB9CiAgcmV0dXJuIG51bWVyaWNhbERvbWFpbjsKfTsKdmFyIHNlbGVjdEF4aXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3REaXNwbGF5ZWREYXRhLCBzZWxlY3RBbGxBcHBsaWVkVmFsdWVzLCBzZWxlY3RTdGFja09mZnNldFR5cGUsIHBpY2tBeGlzVHlwZSwgc2VsZWN0TnVtZXJpY2FsRG9tYWluXSwgY29tYmluZUF4aXNEb21haW4pOwp2YXIgY29tYmluZVJlYWxTY2FsZVR5cGUgPSAoYXhpc0NvbmZpZywgbGF5b3V0LCBoYXNCYXIsIGNoYXJ0VHlwZSwgYXhpc1R5cGUpID0+IHsKICBpZiAoYXhpc0NvbmZpZyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgc2NhbGUsCiAgICB0eXBlCiAgfSA9IGF4aXNDb25maWc7CiAgaWYgKHNjYWxlID09PSAiYXV0byIpIHsKICAgIGlmIChsYXlvdXQgPT09ICJyYWRpYWwiICYmIGF4aXNUeXBlID09PSAicmFkaXVzQXhpcyIpIHsKICAgICAgcmV0dXJuICJiYW5kIjsKICAgIH0KICAgIGlmIChsYXlvdXQgPT09ICJyYWRpYWwiICYmIGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIikgewogICAgICByZXR1cm4gImxpbmVhciI7CiAgICB9CiAgICBpZiAodHlwZSA9PT0gImNhdGVnb3J5IiAmJiBjaGFydFR5cGUgJiYgKGNoYXJ0VHlwZS5pbmRleE9mKCJMaW5lQ2hhcnQiKSA+PSAwIHx8IGNoYXJ0VHlwZS5pbmRleE9mKCJBcmVhQ2hhcnQiKSA+PSAwIHx8IGNoYXJ0VHlwZS5pbmRleE9mKCJDb21wb3NlZENoYXJ0IikgPj0gMCAmJiAhaGFzQmFyKSkgewogICAgICByZXR1cm4gInBvaW50IjsKICAgIH0KICAgIGlmICh0eXBlID09PSAiY2F0ZWdvcnkiKSB7CiAgICAgIHJldHVybiAiYmFuZCI7CiAgICB9CiAgICByZXR1cm4gImxpbmVhciI7CiAgfQogIGlmICh0eXBlb2Ygc2NhbGUgPT09ICJzdHJpbmciKSB7CiAgICB2YXIgbmFtZSA9ICJzY2FsZSIuY29uY2F0KHVwcGVyRmlyc3Qoc2NhbGUpKTsKICAgIHJldHVybiBuYW1lIGluIGQzX3NjYWxlX2V4cG9ydHMgPyBuYW1lIDogInBvaW50IjsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfTsKdmFyIHNlbGVjdFJlYWxTY2FsZVR5cGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RIYXNCYXIsIHNlbGVjdENoYXJ0TmFtZSwgcGlja0F4aXNUeXBlXSwgY29tYmluZVJlYWxTY2FsZVR5cGUpOwpmdW5jdGlvbiBnZXREM1NjYWxlRnJvbVR5cGUocmVhbFNjYWxlVHlwZSkgewogIGlmIChyZWFsU2NhbGVUeXBlID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmIChyZWFsU2NhbGVUeXBlIGluIGQzX3NjYWxlX2V4cG9ydHMpIHsKICAgIHJldHVybiBkM19zY2FsZV9leHBvcnRzW3JlYWxTY2FsZVR5cGVdKCk7CiAgfQogIHZhciBuYW1lID0gInNjYWxlIi5jb25jYXQodXBwZXJGaXJzdChyZWFsU2NhbGVUeXBlKSk7CiAgaWYgKG5hbWUgaW4gZDNfc2NhbGVfZXhwb3J0cykgewogICAgcmV0dXJuIGQzX3NjYWxlX2V4cG9ydHNbbmFtZV0oKTsKICB9CiAgcmV0dXJuIHZvaWQgMDsKfQpmdW5jdGlvbiBjb21iaW5lU2NhbGVGdW5jdGlvbihheGlzLCByZWFsU2NhbGVUeXBlLCBheGlzRG9tYWluLCBheGlzUmFuZ2UpIHsKICBpZiAoYXhpc0RvbWFpbiA9PSBudWxsIHx8IGF4aXNSYW5nZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAodHlwZW9mIGF4aXMuc2NhbGUgPT09ICJmdW5jdGlvbiIpIHsKICAgIHJldHVybiBheGlzLnNjYWxlLmNvcHkoKS5kb21haW4oYXhpc0RvbWFpbikucmFuZ2UoYXhpc1JhbmdlKTsKICB9CiAgdmFyIGQzU2NhbGVGdW5jdGlvbiA9IGdldEQzU2NhbGVGcm9tVHlwZShyZWFsU2NhbGVUeXBlKTsKICBpZiAoZDNTY2FsZUZ1bmN0aW9uID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBzY2FsZSA9IGQzU2NhbGVGdW5jdGlvbi5kb21haW4oYXhpc0RvbWFpbikucmFuZ2UoYXhpc1JhbmdlKTsKICBjaGVja0RvbWFpbk9mU2NhbGUoc2NhbGUpOwogIHJldHVybiBzY2FsZTsKfQp2YXIgY29tYmluZU5pY2VUaWNrcyA9IChheGlzRG9tYWluLCBheGlzU2V0dGluZ3MsIHJlYWxTY2FsZVR5cGUpID0+IHsKICB2YXIgZG9tYWluRGVmaW5pdGlvbiA9IGdldERvbWFpbkRlZmluaXRpb24oYXhpc1NldHRpbmdzKTsKICBpZiAocmVhbFNjYWxlVHlwZSAhPT0gImF1dG8iICYmIHJlYWxTY2FsZVR5cGUgIT09ICJsaW5lYXIiKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoYXhpc1NldHRpbmdzICE9IG51bGwgJiYgYXhpc1NldHRpbmdzLnRpY2tDb3VudCAmJiBBcnJheS5pc0FycmF5KGRvbWFpbkRlZmluaXRpb24pICYmIChkb21haW5EZWZpbml0aW9uWzBdID09PSAiYXV0byIgfHwgZG9tYWluRGVmaW5pdGlvblsxXSA9PT0gImF1dG8iKSAmJiBpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oYXhpc0RvbWFpbikpIHsKICAgIHJldHVybiBnZXROaWNlVGlja1ZhbHVlcyhheGlzRG9tYWluLCBheGlzU2V0dGluZ3MudGlja0NvdW50LCBheGlzU2V0dGluZ3MuYWxsb3dEZWNpbWFscyk7CiAgfQogIGlmIChheGlzU2V0dGluZ3MgIT0gbnVsbCAmJiBheGlzU2V0dGluZ3MudGlja0NvdW50ICYmIGF4aXNTZXR0aW5ncy50eXBlID09PSAibnVtYmVyIiAmJiBpc1dlbGxGb3JtZWROdW1iZXJEb21haW4oYXhpc0RvbWFpbikpIHsKICAgIHJldHVybiBnZXRUaWNrVmFsdWVzRml4ZWREb21haW4oYXhpc0RvbWFpbiwgYXhpc1NldHRpbmdzLnRpY2tDb3VudCwgYXhpc1NldHRpbmdzLmFsbG93RGVjaW1hbHMpOwogIH0KICByZXR1cm4gdm9pZCAwOwp9Owp2YXIgc2VsZWN0TmljZVRpY2tzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEF4aXNEb21haW4sIHNlbGVjdEF4aXNTZXR0aW5ncywgc2VsZWN0UmVhbFNjYWxlVHlwZV0sIGNvbWJpbmVOaWNlVGlja3MpOwp2YXIgY29tYmluZUF4aXNEb21haW5XaXRoTmljZVRpY2tzID0gKGF4aXNTZXR0aW5ncywgZG9tYWluLCBuaWNlVGlja3MsIGF4aXNUeXBlKSA9PiB7CiAgaWYgKAogICAgLyoKICAgICAqIEFuZ2xlIGF4aXMgZm9yIHNvbWUgcmVhc29uIHVzZXMgbmljZSB0aWNrcyB3aGVuIHJlbmRlcmluZyBheGlzIHRpY2sgbGFiZWxzLAogICAgICogYnV0IGRvZXNuJ3QgdXNlIG5pY2UgdGlja3MgZm9yIGV4dGVuZGluZyBkb21haW4gbGlrZSBhbGwgdGhlIG90aGVyIGF4ZXMgZG8uCiAgICAgKiBOb3QgcmVhbGx5IHN1cmUgd2h5PyBJcyB0aGVyZSBhIGdvb2QgcmVhc29uLAogICAgICogb3IgaXMgaXQganVzdCBiZWNhdXNlIHNvbWVvbmUgYWRkZWQgc3VwcG9ydCBmb3IgbmljZSB0aWNrcyB0byB0aGUgb3RoZXIgYXhlcyBhbmQgZm9yZ290IHRoaXMgb25lPwogICAgICovCiAgICBheGlzVHlwZSAhPT0gImFuZ2xlQXhpcyIgJiYgKGF4aXNTZXR0aW5ncyA9PT0gbnVsbCB8fCBheGlzU2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGF4aXNTZXR0aW5ncy50eXBlKSA9PT0gIm51bWJlciIgJiYgaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKGRvbWFpbikgJiYgQXJyYXkuaXNBcnJheShuaWNlVGlja3MpICYmIG5pY2VUaWNrcy5sZW5ndGggPiAwCiAgKSB7CiAgICB2YXIgbWluRnJvbURvbWFpbiA9IGRvbWFpblswXTsKICAgIHZhciBtaW5Gcm9tVGlja3MgPSBuaWNlVGlja3NbMF07CiAgICB2YXIgbWF4RnJvbURvbWFpbiA9IGRvbWFpblsxXTsKICAgIHZhciBtYXhGcm9tVGlja3MgPSBuaWNlVGlja3NbbmljZVRpY2tzLmxlbmd0aCAtIDFdOwogICAgcmV0dXJuIFtNYXRoLm1pbihtaW5Gcm9tRG9tYWluLCBtaW5Gcm9tVGlja3MpLCBNYXRoLm1heChtYXhGcm9tRG9tYWluLCBtYXhGcm9tVGlja3MpXTsKICB9CiAgcmV0dXJuIGRvbWFpbjsKfTsKdmFyIHNlbGVjdEF4aXNEb21haW5JbmNsdWRpbmdOaWNlVGlja3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdEF4aXNEb21haW4sIHNlbGVjdE5pY2VUaWNrcywgcGlja0F4aXNUeXBlXSwgY29tYmluZUF4aXNEb21haW5XaXRoTmljZVRpY2tzKTsKdmFyIHNlbGVjdFNtYWxsZXN0RGlzdGFuY2VCZXR3ZWVuVmFsdWVzID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0QWxsQXBwbGllZFZhbHVlcywgc2VsZWN0QmFzZUF4aXMsIChhbGxEYXRhU3F1aXNoZWQsIGF4aXNTZXR0aW5ncykgPT4gewogIGlmICghYXhpc1NldHRpbmdzIHx8IGF4aXNTZXR0aW5ncy50eXBlICE9PSAibnVtYmVyIikgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHNtYWxsZXN0RGlzdGFuY2VCZXR3ZWVuVmFsdWVzID0gSW5maW5pdHk7CiAgdmFyIHNvcnRlZFZhbHVlcyA9IEFycmF5LmZyb20ob25seUFsbG93TnVtYmVycyhhbGxEYXRhU3F1aXNoZWQubWFwKChkKSA9PiBkLnZhbHVlKSkpLnNvcnQoKGEsIGIpID0+IGEgLSBiKTsKICBpZiAoc29ydGVkVmFsdWVzLmxlbmd0aCA8IDIpIHsKICAgIHJldHVybiBJbmZpbml0eTsKICB9CiAgdmFyIGRpZmYgPSBzb3J0ZWRWYWx1ZXNbc29ydGVkVmFsdWVzLmxlbmd0aCAtIDFdIC0gc29ydGVkVmFsdWVzWzBdOwogIGlmIChkaWZmID09PSAwKSB7CiAgICByZXR1cm4gSW5maW5pdHk7CiAgfQogIGZvciAodmFyIGkgPSAwOyBpIDwgc29ydGVkVmFsdWVzLmxlbmd0aCAtIDE7IGkrKykgewogICAgdmFyIGRpc3RhbmNlID0gc29ydGVkVmFsdWVzW2kgKyAxXSAtIHNvcnRlZFZhbHVlc1tpXTsKICAgIHNtYWxsZXN0RGlzdGFuY2VCZXR3ZWVuVmFsdWVzID0gTWF0aC5taW4oc21hbGxlc3REaXN0YW5jZUJldHdlZW5WYWx1ZXMsIGRpc3RhbmNlKTsKICB9CiAgcmV0dXJuIHNtYWxsZXN0RGlzdGFuY2VCZXR3ZWVuVmFsdWVzIC8gZGlmZjsKfSk7CnZhciBzZWxlY3RDYWxjdWxhdGVkUGFkZGluZyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFNtYWxsZXN0RGlzdGFuY2VCZXR3ZWVuVmFsdWVzLCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QmFyQ2F0ZWdvcnlHYXAsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIChfMSwgXzIsIF8zLCBwYWRkaW5nKSA9PiBwYWRkaW5nLCAoc21hbGxlc3REaXN0YW5jZUluUGVyY2VudCwgbGF5b3V0LCBiYXJDYXRlZ29yeUdhcCwgb2Zmc2V0LCBwYWRkaW5nKSA9PiB7CiAgaWYgKCFpc1dlbGxCZWhhdmVkTnVtYmVyKHNtYWxsZXN0RGlzdGFuY2VJblBlcmNlbnQpKSB7CiAgICByZXR1cm4gMDsKICB9CiAgdmFyIHJhbmdlV2lkdGggPSBsYXlvdXQgPT09ICJ2ZXJ0aWNhbCIgPyBvZmZzZXQuaGVpZ2h0IDogb2Zmc2V0LndpZHRoOwogIGlmIChwYWRkaW5nID09PSAiZ2FwIikgewogICAgcmV0dXJuIHNtYWxsZXN0RGlzdGFuY2VJblBlcmNlbnQgKiByYW5nZVdpZHRoIC8gMjsKICB9CiAgaWYgKHBhZGRpbmcgPT09ICJuby1nYXAiKSB7CiAgICB2YXIgZ2FwID0gZ2V0UGVyY2VudFZhbHVlKGJhckNhdGVnb3J5R2FwLCBzbWFsbGVzdERpc3RhbmNlSW5QZXJjZW50ICogcmFuZ2VXaWR0aCk7CiAgICB2YXIgaGFsZkJhbmQgPSBzbWFsbGVzdERpc3RhbmNlSW5QZXJjZW50ICogcmFuZ2VXaWR0aCAvIDI7CiAgICByZXR1cm4gaGFsZkJhbmQgLSBnYXAgLSAoaGFsZkJhbmQgLSBnYXApIC8gcmFuZ2VXaWR0aCAqIGdhcDsKICB9CiAgcmV0dXJuIDA7Cn0pOwp2YXIgc2VsZWN0Q2FsY3VsYXRlZFhBeGlzUGFkZGluZyA9IChzdGF0ZSwgYXhpc0lkKSA9PiB7CiAgdmFyIHhBeGlzU2V0dGluZ3MgPSBzZWxlY3RYQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogIGlmICh4QXhpc1NldHRpbmdzID09IG51bGwgfHwgdHlwZW9mIHhBeGlzU2V0dGluZ3MucGFkZGluZyAhPT0gInN0cmluZyIpIHsKICAgIHJldHVybiAwOwogIH0KICByZXR1cm4gc2VsZWN0Q2FsY3VsYXRlZFBhZGRpbmcoc3RhdGUsICJ4QXhpcyIsIGF4aXNJZCwgeEF4aXNTZXR0aW5ncy5wYWRkaW5nKTsKfTsKdmFyIHNlbGVjdENhbGN1bGF0ZWRZQXhpc1BhZGRpbmcgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciB5QXhpc1NldHRpbmdzID0gc2VsZWN0WUF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICBpZiAoeUF4aXNTZXR0aW5ncyA9PSBudWxsIHx8IHR5cGVvZiB5QXhpc1NldHRpbmdzLnBhZGRpbmcgIT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gMDsKICB9CiAgcmV0dXJuIHNlbGVjdENhbGN1bGF0ZWRQYWRkaW5nKHN0YXRlLCAieUF4aXMiLCBheGlzSWQsIHlBeGlzU2V0dGluZ3MucGFkZGluZyk7Cn07CnZhciBzZWxlY3RYQXhpc1BhZGRpbmcgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RYQXhpc1NldHRpbmdzLCBzZWxlY3RDYWxjdWxhdGVkWEF4aXNQYWRkaW5nLCAoeEF4aXNTZXR0aW5ncywgY2FsY3VsYXRlZCkgPT4gewogIHZhciBfcGFkZGluZyRsZWZ0LCBfcGFkZGluZyRyaWdodDsKICBpZiAoeEF4aXNTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gewogICAgICBsZWZ0OiAwLAogICAgICByaWdodDogMAogICAgfTsKICB9CiAgdmFyIHsKICAgIHBhZGRpbmcKICB9ID0geEF4aXNTZXR0aW5nczsKICBpZiAodHlwZW9mIHBhZGRpbmcgPT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gewogICAgICBsZWZ0OiBjYWxjdWxhdGVkLAogICAgICByaWdodDogY2FsY3VsYXRlZAogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIGxlZnQ6ICgoX3BhZGRpbmckbGVmdCA9IHBhZGRpbmcubGVmdCkgIT09IG51bGwgJiYgX3BhZGRpbmckbGVmdCAhPT0gdm9pZCAwID8gX3BhZGRpbmckbGVmdCA6IDApICsgY2FsY3VsYXRlZCwKICAgIHJpZ2h0OiAoKF9wYWRkaW5nJHJpZ2h0ID0gcGFkZGluZy5yaWdodCkgIT09IG51bGwgJiYgX3BhZGRpbmckcmlnaHQgIT09IHZvaWQgMCA/IF9wYWRkaW5nJHJpZ2h0IDogMCkgKyBjYWxjdWxhdGVkCiAgfTsKfSk7CnZhciBzZWxlY3RZQXhpc1BhZGRpbmcgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RZQXhpc1NldHRpbmdzLCBzZWxlY3RDYWxjdWxhdGVkWUF4aXNQYWRkaW5nLCAoeUF4aXNTZXR0aW5ncywgY2FsY3VsYXRlZCkgPT4gewogIHZhciBfcGFkZGluZyR0b3AsIF9wYWRkaW5nJGJvdHRvbTsKICBpZiAoeUF4aXNTZXR0aW5ncyA9PSBudWxsKSB7CiAgICByZXR1cm4gewogICAgICB0b3A6IDAsCiAgICAgIGJvdHRvbTogMAogICAgfTsKICB9CiAgdmFyIHsKICAgIHBhZGRpbmcKICB9ID0geUF4aXNTZXR0aW5nczsKICBpZiAodHlwZW9mIHBhZGRpbmcgPT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gewogICAgICB0b3A6IGNhbGN1bGF0ZWQsCiAgICAgIGJvdHRvbTogY2FsY3VsYXRlZAogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIHRvcDogKChfcGFkZGluZyR0b3AgPSBwYWRkaW5nLnRvcCkgIT09IG51bGwgJiYgX3BhZGRpbmckdG9wICE9PSB2b2lkIDAgPyBfcGFkZGluZyR0b3AgOiAwKSArIGNhbGN1bGF0ZWQsCiAgICBib3R0b206ICgoX3BhZGRpbmckYm90dG9tID0gcGFkZGluZy5ib3R0b20pICE9PSBudWxsICYmIF9wYWRkaW5nJGJvdHRvbSAhPT0gdm9pZCAwID8gX3BhZGRpbmckYm90dG9tIDogMCkgKyBjYWxjdWxhdGVkCiAgfTsKfSk7CnZhciBjb21iaW5lWEF4aXNSYW5nZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RYQXhpc1BhZGRpbmcsIHNlbGVjdEJydXNoRGltZW5zaW9ucywgc2VsZWN0QnJ1c2hTZXR0aW5ncywgKF9zdGF0ZSwgX2F4aXNJZCwgaXNQYW5vcmFtYSkgPT4gaXNQYW5vcmFtYV0sIChvZmZzZXQsIHBhZGRpbmcsIGJydXNoRGltZW5zaW9ucywgX3JlZjQsIGlzUGFub3JhbWEpID0+IHsKICB2YXIgewogICAgcGFkZGluZzogYnJ1c2hQYWRkaW5nCiAgfSA9IF9yZWY0OwogIGlmIChpc1Bhbm9yYW1hKSB7CiAgICByZXR1cm4gW2JydXNoUGFkZGluZy5sZWZ0LCBicnVzaERpbWVuc2lvbnMud2lkdGggLSBicnVzaFBhZGRpbmcucmlnaHRdOwogIH0KICByZXR1cm4gW29mZnNldC5sZWZ0ICsgcGFkZGluZy5sZWZ0LCBvZmZzZXQubGVmdCArIG9mZnNldC53aWR0aCAtIHBhZGRpbmcucmlnaHRdOwp9KTsKdmFyIGNvbWJpbmVZQXhpc1JhbmdlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RZQXhpc1BhZGRpbmcsIHNlbGVjdEJydXNoRGltZW5zaW9ucywgc2VsZWN0QnJ1c2hTZXR0aW5ncywgKF9zdGF0ZSwgX2F4aXNJZCwgaXNQYW5vcmFtYSkgPT4gaXNQYW5vcmFtYV0sIChvZmZzZXQsIGxheW91dCwgcGFkZGluZywgYnJ1c2hEaW1lbnNpb25zLCBfcmVmNSwgaXNQYW5vcmFtYSkgPT4gewogIHZhciB7CiAgICBwYWRkaW5nOiBicnVzaFBhZGRpbmcKICB9ID0gX3JlZjU7CiAgaWYgKGlzUGFub3JhbWEpIHsKICAgIHJldHVybiBbYnJ1c2hEaW1lbnNpb25zLmhlaWdodCAtIGJydXNoUGFkZGluZy5ib3R0b20sIGJydXNoUGFkZGluZy50b3BdOwogIH0KICBpZiAobGF5b3V0ID09PSAiaG9yaXpvbnRhbCIpIHsKICAgIHJldHVybiBbb2Zmc2V0LnRvcCArIG9mZnNldC5oZWlnaHQgLSBwYWRkaW5nLmJvdHRvbSwgb2Zmc2V0LnRvcCArIHBhZGRpbmcudG9wXTsKICB9CiAgcmV0dXJuIFtvZmZzZXQudG9wICsgcGFkZGluZy50b3AsIG9mZnNldC50b3AgKyBvZmZzZXQuaGVpZ2h0IC0gcGFkZGluZy5ib3R0b21dOwp9KTsKdmFyIHNlbGVjdEF4aXNSYW5nZSA9IChzdGF0ZSwgYXhpc1R5cGUsIGF4aXNJZCwgaXNQYW5vcmFtYSkgPT4gewogIHZhciBfc2VsZWN0WkF4aXNTZXR0aW5nczsKICBzd2l0Y2ggKGF4aXNUeXBlKSB7CiAgICBjYXNlICJ4QXhpcyI6CiAgICAgIHJldHVybiBjb21iaW5lWEF4aXNSYW5nZShzdGF0ZSwgYXhpc0lkLCBpc1Bhbm9yYW1hKTsKICAgIGNhc2UgInlBeGlzIjoKICAgICAgcmV0dXJuIGNvbWJpbmVZQXhpc1JhbmdlKHN0YXRlLCBheGlzSWQsIGlzUGFub3JhbWEpOwogICAgY2FzZSAiekF4aXMiOgogICAgICByZXR1cm4gKF9zZWxlY3RaQXhpc1NldHRpbmdzID0gc2VsZWN0WkF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKSkgPT09IG51bGwgfHwgX3NlbGVjdFpBeGlzU2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9zZWxlY3RaQXhpc1NldHRpbmdzLnJhbmdlOwogICAgY2FzZSAiYW5nbGVBeGlzIjoKICAgICAgcmV0dXJuIHNlbGVjdEFuZ2xlQXhpc1JhbmdlKHN0YXRlKTsKICAgIGNhc2UgInJhZGl1c0F4aXMiOgogICAgICByZXR1cm4gc2VsZWN0UmFkaXVzQXhpc1JhbmdlKHN0YXRlLCBheGlzSWQpOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIHZvaWQgMDsKICB9Cn07CnZhciBzZWxlY3RBeGlzUmFuZ2VXaXRoUmV2ZXJzZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0QXhpc1JhbmdlXSwgY29tYmluZUF4aXNSYW5nZVdpdGhSZXZlcnNlKTsKdmFyIHNlbGVjdEF4aXNTY2FsZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RCYXNlQXhpcywgc2VsZWN0UmVhbFNjYWxlVHlwZSwgc2VsZWN0QXhpc0RvbWFpbkluY2x1ZGluZ05pY2VUaWNrcywgc2VsZWN0QXhpc1JhbmdlV2l0aFJldmVyc2VdLCBjb21iaW5lU2NhbGVGdW5jdGlvbik7CnZhciBzZWxlY3RFcnJvckJhcnNTZXR0aW5ncyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDYXJ0ZXNpYW5JdGVtc1NldHRpbmdzLCBzZWxlY3RBbGxFcnJvckJhclNldHRpbmdzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lUmVsZXZhbnRFcnJvckJhclNldHRpbmdzKTsKZnVuY3Rpb24gY29tcGFyZUlkcyhhLCBiKSB7CiAgaWYgKGEuaWQgPCBiLmlkKSB7CiAgICByZXR1cm4gLTE7CiAgfQogIGlmIChhLmlkID4gYi5pZCkgewogICAgcmV0dXJuIDE7CiAgfQogIHJldHVybiAwOwp9CnZhciBwaWNrQXhpc09yaWVudGF0aW9uID0gKF9zdGF0ZSwgb3JpZW50YXRpb24pID0+IG9yaWVudGF0aW9uOwp2YXIgcGlja01pcnJvciA9IChfc3RhdGUsIF9vcmllbnRhdGlvbiwgbWlycm9yKSA9PiBtaXJyb3I7CnZhciBzZWxlY3RBbGxYQXhlc1dpdGhPZmZzZXRUeXBlID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0QWxsWEF4ZXMsIHBpY2tBeGlzT3JpZW50YXRpb24sIHBpY2tNaXJyb3IsIChhbGxBeGVzLCBvcmllbnRhdGlvbiwgbWlycm9yKSA9PiBhbGxBeGVzLmZpbHRlcigoYXhpcykgPT4gYXhpcy5vcmllbnRhdGlvbiA9PT0gb3JpZW50YXRpb24pLmZpbHRlcigoYXhpcykgPT4gYXhpcy5taXJyb3IgPT09IG1pcnJvcikuc29ydChjb21wYXJlSWRzKSk7CnZhciBzZWxlY3RBbGxZQXhlc1dpdGhPZmZzZXRUeXBlID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0QWxsWUF4ZXMsIHBpY2tBeGlzT3JpZW50YXRpb24sIHBpY2tNaXJyb3IsIChhbGxBeGVzLCBvcmllbnRhdGlvbiwgbWlycm9yKSA9PiBhbGxBeGVzLmZpbHRlcigoYXhpcykgPT4gYXhpcy5vcmllbnRhdGlvbiA9PT0gb3JpZW50YXRpb24pLmZpbHRlcigoYXhpcykgPT4gYXhpcy5taXJyb3IgPT09IG1pcnJvcikuc29ydChjb21wYXJlSWRzKSk7CnZhciBnZXRYQXhpc1NpemUgPSAob2Zmc2V0LCBheGlzU2V0dGluZ3MpID0+IHsKICByZXR1cm4gewogICAgd2lkdGg6IG9mZnNldC53aWR0aCwKICAgIGhlaWdodDogYXhpc1NldHRpbmdzLmhlaWdodAogIH07Cn07CnZhciBnZXRZQXhpc1NpemUgPSAob2Zmc2V0LCBheGlzU2V0dGluZ3MpID0+IHsKICB2YXIgd2lkdGggPSB0eXBlb2YgYXhpc1NldHRpbmdzLndpZHRoID09PSAibnVtYmVyIiA/IGF4aXNTZXR0aW5ncy53aWR0aCA6IERFRkFVTFRfWV9BWElTX1dJRFRIOwogIHJldHVybiB7CiAgICB3aWR0aCwKICAgIGhlaWdodDogb2Zmc2V0LmhlaWdodAogIH07Cn07CnZhciBzZWxlY3RYQXhpc1NpemUgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RYQXhpc1NldHRpbmdzLCBnZXRYQXhpc1NpemUpOwp2YXIgY29tYmluZVhBeGlzUG9zaXRpb25TdGFydGluZ1BvaW50ID0gKG9mZnNldCwgb3JpZW50YXRpb24sIGNoYXJ0SGVpZ2h0KSA9PiB7CiAgc3dpdGNoIChvcmllbnRhdGlvbikgewogICAgY2FzZSAidG9wIjoKICAgICAgcmV0dXJuIG9mZnNldC50b3A7CiAgICBjYXNlICJib3R0b20iOgogICAgICByZXR1cm4gY2hhcnRIZWlnaHQgLSBvZmZzZXQuYm90dG9tOwogICAgZGVmYXVsdDoKICAgICAgcmV0dXJuIDA7CiAgfQp9Owp2YXIgY29tYmluZVlBeGlzUG9zaXRpb25TdGFydGluZ1BvaW50ID0gKG9mZnNldCwgb3JpZW50YXRpb24sIGNoYXJ0V2lkdGgpID0+IHsKICBzd2l0Y2ggKG9yaWVudGF0aW9uKSB7CiAgICBjYXNlICJsZWZ0IjoKICAgICAgcmV0dXJuIG9mZnNldC5sZWZ0OwogICAgY2FzZSAicmlnaHQiOgogICAgICByZXR1cm4gY2hhcnRXaWR0aCAtIG9mZnNldC5yaWdodDsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiAwOwogIH0KfTsKdmFyIHNlbGVjdEFsbFhBeGVzT2Zmc2V0U3RlcHMgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RDaGFydEhlaWdodCwgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbCwgc2VsZWN0QWxsWEF4ZXNXaXRoT2Zmc2V0VHlwZSwgcGlja0F4aXNPcmllbnRhdGlvbiwgcGlja01pcnJvciwgKGNoYXJ0SGVpZ2h0LCBvZmZzZXQsIGFsbEF4ZXNXaXRoU2FtZU9mZnNldFR5cGUsIG9yaWVudGF0aW9uLCBtaXJyb3IpID0+IHsKICB2YXIgc3RlcHMgPSB7fTsKICB2YXIgcG9zaXRpb247CiAgYWxsQXhlc1dpdGhTYW1lT2Zmc2V0VHlwZS5mb3JFYWNoKChheGlzKSA9PiB7CiAgICB2YXIgYXhpc1NpemUgPSBnZXRYQXhpc1NpemUob2Zmc2V0LCBheGlzKTsKICAgIGlmIChwb3NpdGlvbiA9PSBudWxsKSB7CiAgICAgIHBvc2l0aW9uID0gY29tYmluZVhBeGlzUG9zaXRpb25TdGFydGluZ1BvaW50KG9mZnNldCwgb3JpZW50YXRpb24sIGNoYXJ0SGVpZ2h0KTsKICAgIH0KICAgIHZhciBuZWVkU3BhY2UgPSBvcmllbnRhdGlvbiA9PT0gInRvcCIgJiYgIW1pcnJvciB8fCBvcmllbnRhdGlvbiA9PT0gImJvdHRvbSIgJiYgbWlycm9yOwogICAgc3RlcHNbYXhpcy5pZF0gPSBwb3NpdGlvbiAtIE51bWJlcihuZWVkU3BhY2UpICogYXhpc1NpemUuaGVpZ2h0OwogICAgcG9zaXRpb24gKz0gKG5lZWRTcGFjZSA/IC0xIDogMSkgKiBheGlzU2l6ZS5oZWlnaHQ7CiAgfSk7CiAgcmV0dXJuIHN0ZXBzOwp9KTsKdmFyIHNlbGVjdEFsbFlBeGVzT2Zmc2V0U3RlcHMgPSBjcmVhdGVTZWxlY3RvcihzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RBbGxZQXhlc1dpdGhPZmZzZXRUeXBlLCBwaWNrQXhpc09yaWVudGF0aW9uLCBwaWNrTWlycm9yLCAoY2hhcnRXaWR0aCwgb2Zmc2V0LCBhbGxBeGVzV2l0aFNhbWVPZmZzZXRUeXBlLCBvcmllbnRhdGlvbiwgbWlycm9yKSA9PiB7CiAgdmFyIHN0ZXBzID0ge307CiAgdmFyIHBvc2l0aW9uOwogIGFsbEF4ZXNXaXRoU2FtZU9mZnNldFR5cGUuZm9yRWFjaCgoYXhpcykgPT4gewogICAgdmFyIGF4aXNTaXplID0gZ2V0WUF4aXNTaXplKG9mZnNldCwgYXhpcyk7CiAgICBpZiAocG9zaXRpb24gPT0gbnVsbCkgewogICAgICBwb3NpdGlvbiA9IGNvbWJpbmVZQXhpc1Bvc2l0aW9uU3RhcnRpbmdQb2ludChvZmZzZXQsIG9yaWVudGF0aW9uLCBjaGFydFdpZHRoKTsKICAgIH0KICAgIHZhciBuZWVkU3BhY2UgPSBvcmllbnRhdGlvbiA9PT0gImxlZnQiICYmICFtaXJyb3IgfHwgb3JpZW50YXRpb24gPT09ICJyaWdodCIgJiYgbWlycm9yOwogICAgc3RlcHNbYXhpcy5pZF0gPSBwb3NpdGlvbiAtIE51bWJlcihuZWVkU3BhY2UpICogYXhpc1NpemUud2lkdGg7CiAgICBwb3NpdGlvbiArPSAobmVlZFNwYWNlID8gLTEgOiAxKSAqIGF4aXNTaXplLndpZHRoOwogIH0pOwogIHJldHVybiBzdGVwczsKfSk7CnZhciBzZWxlY3RYQXhpc09mZnNldFN0ZXBzID0gKHN0YXRlLCBheGlzSWQpID0+IHsKICB2YXIgYXhpc1NldHRpbmdzID0gc2VsZWN0WEF4aXNTZXR0aW5ncyhzdGF0ZSwgYXhpc0lkKTsKICBpZiAoYXhpc1NldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBzZWxlY3RBbGxYQXhlc09mZnNldFN0ZXBzKHN0YXRlLCBheGlzU2V0dGluZ3Mub3JpZW50YXRpb24sIGF4aXNTZXR0aW5ncy5taXJyb3IpOwp9Owp2YXIgc2VsZWN0WEF4aXNQb3NpdGlvbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydE9mZnNldEludGVybmFsLCBzZWxlY3RYQXhpc1NldHRpbmdzLCBzZWxlY3RYQXhpc09mZnNldFN0ZXBzLCAoXywgYXhpc0lkKSA9PiBheGlzSWRdLCAob2Zmc2V0LCBheGlzU2V0dGluZ3MsIGFsbFN0ZXBzLCBheGlzSWQpID0+IHsKICBpZiAoYXhpc1NldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBzdGVwT2ZUaGlzQXhpcyA9IGFsbFN0ZXBzID09PSBudWxsIHx8IGFsbFN0ZXBzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhbGxTdGVwc1theGlzSWRdOwogIGlmIChzdGVwT2ZUaGlzQXhpcyA9PSBudWxsKSB7CiAgICByZXR1cm4gewogICAgICB4OiBvZmZzZXQubGVmdCwKICAgICAgeTogMAogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIHg6IG9mZnNldC5sZWZ0LAogICAgeTogc3RlcE9mVGhpc0F4aXMKICB9Owp9KTsKdmFyIHNlbGVjdFlBeGlzT2Zmc2V0U3RlcHMgPSAoc3RhdGUsIGF4aXNJZCkgPT4gewogIHZhciBheGlzU2V0dGluZ3MgPSBzZWxlY3RZQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpOwogIGlmIChheGlzU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIHNlbGVjdEFsbFlBeGVzT2Zmc2V0U3RlcHMoc3RhdGUsIGF4aXNTZXR0aW5ncy5vcmllbnRhdGlvbiwgYXhpc1NldHRpbmdzLm1pcnJvcik7Cn07CnZhciBzZWxlY3RZQXhpc1Bvc2l0aW9uID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFlBeGlzU2V0dGluZ3MsIHNlbGVjdFlBeGlzT2Zmc2V0U3RlcHMsIChfLCBheGlzSWQpID0+IGF4aXNJZF0sIChvZmZzZXQsIGF4aXNTZXR0aW5ncywgYWxsU3RlcHMsIGF4aXNJZCkgPT4gewogIGlmIChheGlzU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHN0ZXBPZlRoaXNBeGlzID0gYWxsU3RlcHMgPT09IG51bGwgfHwgYWxsU3RlcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFsbFN0ZXBzW2F4aXNJZF07CiAgaWYgKHN0ZXBPZlRoaXNBeGlzID09IG51bGwpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IDAsCiAgICAgIHk6IG9mZnNldC50b3AKICAgIH07CiAgfQogIHJldHVybiB7CiAgICB4OiBzdGVwT2ZUaGlzQXhpcywKICAgIHk6IG9mZnNldC50b3AKICB9Owp9KTsKdmFyIHNlbGVjdFlBeGlzU2l6ZSA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFlBeGlzU2V0dGluZ3MsIChvZmZzZXQsIGF4aXNTZXR0aW5ncykgPT4gewogIHZhciB3aWR0aCA9IHR5cGVvZiBheGlzU2V0dGluZ3Mud2lkdGggPT09ICJudW1iZXIiID8gYXhpc1NldHRpbmdzLndpZHRoIDogREVGQVVMVF9ZX0FYSVNfV0lEVEg7CiAgcmV0dXJuIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0OiBvZmZzZXQuaGVpZ2h0CiAgfTsKfSk7CnZhciBjb21iaW5lRHVwbGljYXRlRG9tYWluID0gKGNoYXJ0TGF5b3V0LCBhcHBsaWVkVmFsdWVzLCBheGlzLCBheGlzVHlwZSkgPT4gewogIGlmIChheGlzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICAgIHR5cGUsCiAgICBkYXRhS2V5CiAgfSA9IGF4aXM7CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhjaGFydExheW91dCwgYXhpc1R5cGUpOwogIHZhciBhbGxEYXRhID0gYXBwbGllZFZhbHVlcy5tYXAoKGF2KSA9PiBhdi52YWx1ZSk7CiAgaWYgKGRhdGFLZXkgJiYgaXNDYXRlZ29yaWNhbCAmJiB0eXBlID09PSAiY2F0ZWdvcnkiICYmIGFsbG93RHVwbGljYXRlZENhdGVnb3J5ICYmIGhhc0R1cGxpY2F0ZShhbGxEYXRhKSkgewogICAgcmV0dXJuIGFsbERhdGE7CiAgfQogIHJldHVybiB2b2lkIDA7Cn07CnZhciBzZWxlY3REdXBsaWNhdGVEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEFsbEFwcGxpZWRWYWx1ZXMsIHNlbGVjdEJhc2VBeGlzLCBwaWNrQXhpc1R5cGVdLCBjb21iaW5lRHVwbGljYXRlRG9tYWluKTsKdmFyIGNvbWJpbmVDYXRlZ29yaWNhbERvbWFpbiA9IChsYXlvdXQsIGFwcGxpZWRWYWx1ZXMsIGF4aXMsIGF4aXNUeXBlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCB8fCBheGlzLmRhdGFLZXkgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIHR5cGUsCiAgICBzY2FsZQogIH0gPSBheGlzOwogIHZhciBpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCBheGlzVHlwZSk7CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgKHR5cGUgPT09ICJudW1iZXIiIHx8IHNjYWxlICE9PSAiYXV0byIpKSB7CiAgICByZXR1cm4gYXBwbGllZFZhbHVlcy5tYXAoKGQpID0+IGQudmFsdWUpOwogIH0KICByZXR1cm4gdm9pZCAwOwp9Owp2YXIgc2VsZWN0Q2F0ZWdvcmljYWxEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEFsbEFwcGxpZWRWYWx1ZXMsIHNlbGVjdEF4aXNTZXR0aW5ncywgcGlja0F4aXNUeXBlXSwgY29tYmluZUNhdGVnb3JpY2FsRG9tYWluKTsKdmFyIHNlbGVjdEF4aXNQcm9wc05lZWRlZEZvckNhcnRlc2lhbkdyaWRUaWNrc0dlbmVyYXRvciA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0Q2FydGVzaWFuQXhpc1NldHRpbmdzLCBzZWxlY3RSZWFsU2NhbGVUeXBlLCBzZWxlY3RBeGlzU2NhbGUsIHNlbGVjdER1cGxpY2F0ZURvbWFpbiwgc2VsZWN0Q2F0ZWdvcmljYWxEb21haW4sIHNlbGVjdEF4aXNSYW5nZSwgc2VsZWN0TmljZVRpY2tzLCBwaWNrQXhpc1R5cGVdLCAobGF5b3V0LCBheGlzLCByZWFsU2NhbGVUeXBlLCBzY2FsZSwgZHVwbGljYXRlRG9tYWluLCBjYXRlZ29yaWNhbERvbWFpbiwgYXhpc1JhbmdlLCBuaWNlVGlja3MsIGF4aXNUeXBlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICByZXR1cm4gewogICAgYW5nbGU6IGF4aXMuYW5nbGUsCiAgICBpbnRlcnZhbDogYXhpcy5pbnRlcnZhbCwKICAgIG1pblRpY2tHYXA6IGF4aXMubWluVGlja0dhcCwKICAgIG9yaWVudGF0aW9uOiBheGlzLm9yaWVudGF0aW9uLAogICAgdGljazogYXhpcy50aWNrLAogICAgdGlja0NvdW50OiBheGlzLnRpY2tDb3VudCwKICAgIHRpY2tGb3JtYXR0ZXI6IGF4aXMudGlja0Zvcm1hdHRlciwKICAgIHRpY2tzOiBheGlzLnRpY2tzLAogICAgdHlwZTogYXhpcy50eXBlLAogICAgdW5pdDogYXhpcy51bml0LAogICAgYXhpc1R5cGUsCiAgICBjYXRlZ29yaWNhbERvbWFpbiwKICAgIGR1cGxpY2F0ZURvbWFpbiwKICAgIGlzQ2F0ZWdvcmljYWwsCiAgICBuaWNlVGlja3MsCiAgICByYW5nZTogYXhpc1JhbmdlLAogICAgcmVhbFNjYWxlVHlwZSwKICAgIHNjYWxlCiAgfTsKfSk7CnZhciBjb21iaW5lQXhpc1RpY2tzID0gKGxheW91dCwgYXhpcywgcmVhbFNjYWxlVHlwZSwgc2NhbGUsIG5pY2VUaWNrcywgYXhpc1JhbmdlLCBkdXBsaWNhdGVEb21haW4sIGNhdGVnb3JpY2FsRG9tYWluLCBheGlzVHlwZSkgPT4gewogIGlmIChheGlzID09IG51bGwgfHwgc2NhbGUgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGlzQ2F0ZWdvcmljYWwgPSBpc0NhdGVnb3JpY2FsQXhpcyhsYXlvdXQsIGF4aXNUeXBlKTsKICB2YXIgewogICAgdHlwZSwKICAgIHRpY2tzOiB0aWNrczIsCiAgICB0aWNrQ291bnQKICB9ID0gYXhpczsKICB2YXIgb2Zmc2V0Rm9yQmFuZCA9IHJlYWxTY2FsZVR5cGUgPT09ICJzY2FsZUJhbmQiICYmIHR5cGVvZiBzY2FsZS5iYW5kd2lkdGggPT09ICJmdW5jdGlvbiIgPyBzY2FsZS5iYW5kd2lkdGgoKSAvIDIgOiAyOwogIHZhciBvZmZzZXQgPSB0eXBlID09PSAiY2F0ZWdvcnkiICYmIHNjYWxlLmJhbmR3aWR0aCA/IHNjYWxlLmJhbmR3aWR0aCgpIC8gb2Zmc2V0Rm9yQmFuZCA6IDA7CiAgb2Zmc2V0ID0gYXhpc1R5cGUgPT09ICJhbmdsZUF4aXMiICYmIGF4aXNSYW5nZSAhPSBudWxsICYmIGF4aXNSYW5nZS5sZW5ndGggPj0gMiA/IG1hdGhTaWduKGF4aXNSYW5nZVswXSAtIGF4aXNSYW5nZVsxXSkgKiAyICogb2Zmc2V0IDogb2Zmc2V0OwogIHZhciB0aWNrc09yTmljZVRpY2tzID0gdGlja3MyIHx8IG5pY2VUaWNrczsKICBpZiAodGlja3NPck5pY2VUaWNrcykgewogICAgdmFyIHJlc3VsdCA9IHRpY2tzT3JOaWNlVGlja3MubWFwKChlbnRyeSwgaW5kZXgpID0+IHsKICAgICAgdmFyIHNjYWxlQ29udGVudCA9IGR1cGxpY2F0ZURvbWFpbiA/IGR1cGxpY2F0ZURvbWFpbi5pbmRleE9mKGVudHJ5KSA6IGVudHJ5OwogICAgICByZXR1cm4gewogICAgICAgIGluZGV4LAogICAgICAgIC8vIElmIHRoZSBzY2FsZUNvbnRlbnQgaXMgbm90IGEgbnVtYmVyLCB0aGUgY29vcmRpbmF0ZSB3aWxsIGJlIE5hTi4KICAgICAgICAvLyBUaGF0IGNvdWxkIGJlIHRoZSBjYXNlIGZvciBleGFtcGxlIHdpdGggYSBQb2ludFNjYWxlIGFuZCBhIHN0cmluZyBhcyBkb21haW4uCiAgICAgICAgY29vcmRpbmF0ZTogc2NhbGUoc2NhbGVDb250ZW50KSArIG9mZnNldCwKICAgICAgICB2YWx1ZTogZW50cnksCiAgICAgICAgb2Zmc2V0CiAgICAgIH07CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQuZmlsdGVyKChyb3cpID0+IGlzV2VsbEJlaGF2ZWROdW1iZXIocm93LmNvb3JkaW5hdGUpKTsKICB9CiAgaWYgKGlzQ2F0ZWdvcmljYWwgJiYgY2F0ZWdvcmljYWxEb21haW4pIHsKICAgIHJldHVybiBjYXRlZ29yaWNhbERvbWFpbi5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIGluZGV4LAogICAgICBvZmZzZXQKICAgIH0pKS5maWx0ZXIoKHJvdykgPT4gaXNXZWxsQmVoYXZlZE51bWJlcihyb3cuY29vcmRpbmF0ZSkpOwogIH0KICBpZiAoc2NhbGUudGlja3MpIHsKICAgIHJldHVybiBzY2FsZS50aWNrcyh0aWNrQ291bnQpLm1hcCgoZW50cnkpID0+ICh7CiAgICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgICAgdmFsdWU6IGVudHJ5LAogICAgICBvZmZzZXQKICAgIH0pKTsKICB9CiAgcmV0dXJuIHNjYWxlLmRvbWFpbigpLm1hcCgoZW50cnksIGluZGV4KSA9PiAoewogICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgdmFsdWU6IGR1cGxpY2F0ZURvbWFpbiA/IGR1cGxpY2F0ZURvbWFpbltlbnRyeV0gOiBlbnRyeSwKICAgIGluZGV4LAogICAgb2Zmc2V0CiAgfSkpOwp9Owp2YXIgc2VsZWN0VGlja3NPZkF4aXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEF4aXNTZXR0aW5ncywgc2VsZWN0UmVhbFNjYWxlVHlwZSwgc2VsZWN0QXhpc1NjYWxlLCBzZWxlY3ROaWNlVGlja3MsIHNlbGVjdEF4aXNSYW5nZSwgc2VsZWN0RHVwbGljYXRlRG9tYWluLCBzZWxlY3RDYXRlZ29yaWNhbERvbWFpbiwgcGlja0F4aXNUeXBlXSwgY29tYmluZUF4aXNUaWNrcyk7CnZhciBjb21iaW5lR3JhcGhpY2FsSXRlbVRpY2tzID0gKGxheW91dCwgYXhpcywgc2NhbGUsIGF4aXNSYW5nZSwgZHVwbGljYXRlRG9tYWluLCBjYXRlZ29yaWNhbERvbWFpbiwgYXhpc1R5cGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsIHx8IHNjYWxlID09IG51bGwgfHwgYXhpc1JhbmdlID09IG51bGwgfHwgYXhpc1JhbmdlWzBdID09PSBheGlzUmFuZ2VbMV0pIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBpc0NhdGVnb3JpY2FsID0gaXNDYXRlZ29yaWNhbEF4aXMobGF5b3V0LCBheGlzVHlwZSk7CiAgdmFyIHsKICAgIHRpY2tDb3VudAogIH0gPSBheGlzOwogIHZhciBvZmZzZXQgPSAwOwogIG9mZnNldCA9IGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIiAmJiAoYXhpc1JhbmdlID09PSBudWxsIHx8IGF4aXNSYW5nZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXhpc1JhbmdlLmxlbmd0aCkgPj0gMiA/IG1hdGhTaWduKGF4aXNSYW5nZVswXSAtIGF4aXNSYW5nZVsxXSkgKiAyICogb2Zmc2V0IDogb2Zmc2V0OwogIGlmIChpc0NhdGVnb3JpY2FsICYmIGNhdGVnb3JpY2FsRG9tYWluKSB7CiAgICByZXR1cm4gY2F0ZWdvcmljYWxEb21haW4ubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgICAgdmFsdWU6IGVudHJ5LAogICAgICBpbmRleCwKICAgICAgb2Zmc2V0CiAgICB9KSk7CiAgfQogIGlmIChzY2FsZS50aWNrcykgewogICAgcmV0dXJuIHNjYWxlLnRpY2tzKHRpY2tDb3VudCkubWFwKChlbnRyeSkgPT4gKHsKICAgICAgY29vcmRpbmF0ZTogc2NhbGUoZW50cnkpICsgb2Zmc2V0LAogICAgICB2YWx1ZTogZW50cnksCiAgICAgIG9mZnNldAogICAgfSkpOwogIH0KICByZXR1cm4gc2NhbGUuZG9tYWluKCkubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICBjb29yZGluYXRlOiBzY2FsZShlbnRyeSkgKyBvZmZzZXQsCiAgICB2YWx1ZTogZHVwbGljYXRlRG9tYWluID8gZHVwbGljYXRlRG9tYWluW2VudHJ5XSA6IGVudHJ5LAogICAgaW5kZXgsCiAgICBvZmZzZXQKICB9KSk7Cn07CnZhciBzZWxlY3RUaWNrc09mR3JhcGhpY2FsSXRlbSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0QXhpc1NldHRpbmdzLCBzZWxlY3RBeGlzU2NhbGUsIHNlbGVjdEF4aXNSYW5nZSwgc2VsZWN0RHVwbGljYXRlRG9tYWluLCBzZWxlY3RDYXRlZ29yaWNhbERvbWFpbiwgcGlja0F4aXNUeXBlXSwgY29tYmluZUdyYXBoaWNhbEl0ZW1UaWNrcyk7CnZhciBzZWxlY3RBeGlzV2l0aFNjYWxlID0gY3JlYXRlU2VsZWN0b3Ioc2VsZWN0QmFzZUF4aXMsIHNlbGVjdEF4aXNTY2FsZSwgKGF4aXMsIHNjYWxlKSA9PiB7CiAgaWYgKGF4aXMgPT0gbnVsbCB8fCBzY2FsZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gX29iamVjdFNwcmVhZDEzKF9vYmplY3RTcHJlYWQxMyh7fSwgYXhpcyksIHt9LCB7CiAgICBzY2FsZQogIH0pOwp9KTsKdmFyIHNlbGVjdFpBeGlzU2NhbGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QmFzZUF4aXMsIHNlbGVjdFJlYWxTY2FsZVR5cGUsIHNlbGVjdEF4aXNEb21haW4sIHNlbGVjdEF4aXNSYW5nZVdpdGhSZXZlcnNlXSwgY29tYmluZVNjYWxlRnVuY3Rpb24pOwp2YXIgc2VsZWN0WkF4aXNXaXRoU2NhbGUgPSBjcmVhdGVTZWxlY3Rvcigoc3RhdGUsIF9heGlzVHlwZSwgYXhpc0lkKSA9PiBzZWxlY3RaQXhpc1NldHRpbmdzKHN0YXRlLCBheGlzSWQpLCBzZWxlY3RaQXhpc1NjYWxlLCAoYXhpcywgc2NhbGUpID0+IHsKICBpZiAoYXhpcyA9PSBudWxsIHx8IHNjYWxlID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBfb2JqZWN0U3ByZWFkMTMoX29iamVjdFNwcmVhZDEzKHt9LCBheGlzKSwge30sIHsKICAgIHNjYWxlCiAgfSk7Cn0pOwp2YXIgc2VsZWN0Q2hhcnREaXJlY3Rpb24gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEFsbFhBeGVzLCBzZWxlY3RBbGxZQXhlc10sIChsYXlvdXQsIGFsbFhBeGVzLCBhbGxZQXhlcykgPT4gewogIHN3aXRjaCAobGF5b3V0KSB7CiAgICBjYXNlICJob3Jpem9udGFsIjogewogICAgICByZXR1cm4gYWxsWEF4ZXMuc29tZSgoYXhpcykgPT4gYXhpcy5yZXZlcnNlZCkgPyAicmlnaHQtdG8tbGVmdCIgOiAibGVmdC10by1yaWdodCI7CiAgICB9CiAgICBjYXNlICJ2ZXJ0aWNhbCI6IHsKICAgICAgcmV0dXJuIGFsbFlBeGVzLnNvbWUoKGF4aXMpID0+IGF4aXMucmV2ZXJzZWQpID8gImJvdHRvbS10by10b3AiIDogInRvcC10by1ib3R0b20iOwogICAgfQogICAgY2FzZSAiY2VudHJpYyI6CiAgICBjYXNlICJyYWRpYWwiOiB7CiAgICAgIHJldHVybiAibGVmdC10by1yaWdodCI7CiAgICB9CiAgICBkZWZhdWx0OiB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgfQp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RUb29sdGlwRXZlbnRUeXBlLmpzCnZhciBzZWxlY3REZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSA9IChzdGF0ZSkgPT4gc3RhdGUub3B0aW9ucy5kZWZhdWx0VG9vbHRpcEV2ZW50VHlwZTsKdmFyIHNlbGVjdFZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMgPSAoc3RhdGUpID0+IHN0YXRlLm9wdGlvbnMudmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlczsKZnVuY3Rpb24gY29tYmluZVRvb2x0aXBFdmVudFR5cGUoc2hhcmVkLCBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSwgdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcykgewogIGlmIChzaGFyZWQgPT0gbnVsbCkgewogICAgcmV0dXJuIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlOwogIH0KICB2YXIgZXZlbnRUeXBlID0gc2hhcmVkID8gImF4aXMiIDogIml0ZW0iOwogIGlmICh2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzID09IG51bGwpIHsKICAgIHJldHVybiBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZTsKICB9CiAgcmV0dXJuIHZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMuaW5jbHVkZXMoZXZlbnRUeXBlKSA/IGV2ZW50VHlwZSA6IGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlOwp9CmZ1bmN0aW9uIHNlbGVjdFRvb2x0aXBFdmVudFR5cGUoc3RhdGUsIHNoYXJlZCkgewogIHZhciBkZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSA9IHNlbGVjdERlZmF1bHRUb29sdGlwRXZlbnRUeXBlKHN0YXRlKTsKICB2YXIgdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcyA9IHNlbGVjdFZhbGlkYXRlVG9vbHRpcEV2ZW50VHlwZXMoc3RhdGUpOwogIHJldHVybiBjb21iaW5lVG9vbHRpcEV2ZW50VHlwZShzaGFyZWQsIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlLCB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzKTsKfQpmdW5jdGlvbiB1c2VUb29sdGlwRXZlbnRUeXBlKHNoYXJlZCkgewogIHJldHVybiB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFRvb2x0aXBFdmVudFR5cGUoc3RhdGUsIHNoYXJlZCkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29tYmluZXJzL2NvbWJpbmVBY3RpdmVMYWJlbC5qcwp2YXIgY29tYmluZUFjdGl2ZUxhYmVsID0gKHRvb2x0aXBUaWNrcywgYWN0aXZlSW5kZXgpID0+IHsKICB2YXIgX3Rvb2x0aXBUaWNrcyRuOwogIHZhciBuID0gTnVtYmVyKGFjdGl2ZUluZGV4KTsKICBpZiAoaXNOYW4obikgfHwgYWN0aXZlSW5kZXggPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgcmV0dXJuIG4gPj0gMCA/IHRvb2x0aXBUaWNrcyA9PT0gbnVsbCB8fCB0b29sdGlwVGlja3MgPT09IHZvaWQgMCB8fCAoX3Rvb2x0aXBUaWNrcyRuID0gdG9vbHRpcFRpY2tzW25dKSA9PT0gbnVsbCB8fCBfdG9vbHRpcFRpY2tzJG4gPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90b29sdGlwVGlja3Mkbi52YWx1ZSA6IHZvaWQgMDsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RUb29sdGlwU2V0dGluZ3MuanMKdmFyIHNlbGVjdFRvb2x0aXBTZXR0aW5ncyA9IChzdGF0ZSkgPT4gc3RhdGUudG9vbHRpcC5zZXR0aW5nczsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3Rvb2x0aXBTbGljZS5qcwp2YXIgbm9JbnRlcmFjdGlvbiA9IHsKICBhY3RpdmU6IGZhbHNlLAogIGluZGV4OiBudWxsLAogIGRhdGFLZXk6IHZvaWQgMCwKICBncmFwaGljYWxJdGVtSWQ6IHZvaWQgMCwKICBjb29yZGluYXRlOiB2b2lkIDAKfTsKdmFyIGluaXRpYWxTdGF0ZTMgPSB7CiAgaXRlbUludGVyYWN0aW9uOiB7CiAgICBjbGljazogbm9JbnRlcmFjdGlvbiwKICAgIGhvdmVyOiBub0ludGVyYWN0aW9uCiAgfSwKICBheGlzSW50ZXJhY3Rpb246IHsKICAgIGNsaWNrOiBub0ludGVyYWN0aW9uLAogICAgaG92ZXI6IG5vSW50ZXJhY3Rpb24KICB9LAogIGtleWJvYXJkSW50ZXJhY3Rpb246IG5vSW50ZXJhY3Rpb24sCiAgc3luY0ludGVyYWN0aW9uOiB7CiAgICBhY3RpdmU6IGZhbHNlLAogICAgaW5kZXg6IG51bGwsCiAgICBkYXRhS2V5OiB2b2lkIDAsCiAgICBsYWJlbDogdm9pZCAwLAogICAgY29vcmRpbmF0ZTogdm9pZCAwLAogICAgc291cmNlVmlld0JveDogdm9pZCAwLAogICAgZ3JhcGhpY2FsSXRlbUlkOiB2b2lkIDAKICB9LAogIHRvb2x0aXBJdGVtUGF5bG9hZHM6IFtdLAogIHNldHRpbmdzOiB7CiAgICBzaGFyZWQ6IHZvaWQgMCwKICAgIHRyaWdnZXI6ICJob3ZlciIsCiAgICBheGlzSWQ6IDAsCiAgICBhY3RpdmU6IGZhbHNlLAogICAgZGVmYXVsdEluZGV4OiB2b2lkIDAKICB9Cn07CnZhciB0b29sdGlwU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogInRvb2x0aXAiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMywKICByZWR1Y2VyczogewogICAgYWRkVG9vbHRpcEVudHJ5U2V0dGluZ3M6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkcy5wdXNoKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlcGxhY2VUb29sdGlwRW50cnlTZXR0aW5nczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgewogICAgICAgICAgcHJldiwKICAgICAgICAgIG5leHQKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkudG9vbHRpcEl0ZW1QYXlsb2Fkcy5pbmRleE9mKGNhc3REcmFmdChwcmV2KSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHNbaW5kZXhdID0gY2FzdERyYWZ0KG5leHQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVUb29sdGlwRW50cnlTZXR0aW5nczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS50b29sdGlwSXRlbVBheWxvYWRzLmluZGV4T2YoY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKSk7CiAgICAgICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgICAgIHN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgc2V0VG9vbHRpcFNldHRpbmdzU3RhdGUoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5zZXR0aW5ncyA9IGFjdGlvbi5wYXlsb2FkOwogICAgfSwKICAgIHNldEFjdGl2ZU1vdXNlT3Zlckl0ZW1JbmRleChzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnN5bmNJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmFjdGl2ZSA9IHRydWU7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5pbmRleCA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUluZGV4OwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuZGF0YUtleSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZURhdGFLZXk7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5ncmFwaGljYWxJdGVtSWQgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVHcmFwaGljYWxJdGVtSWQ7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3Zlci5jb29yZGluYXRlID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlQ29vcmRpbmF0ZTsKICAgIH0sCiAgICBtb3VzZUxlYXZlQ2hhcnQoc3RhdGUpIHsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uaG92ZXIuYWN0aXZlID0gZmFsc2U7CiAgICB9LAogICAgbW91c2VMZWF2ZUl0ZW0oc3RhdGUpIHsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmhvdmVyLmFjdGl2ZSA9IGZhbHNlOwogICAgfSwKICAgIHNldEFjdGl2ZUNsaWNrSXRlbUluZGV4KHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc3luY0ludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suYWN0aXZlID0gdHJ1ZTsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmluZGV4ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlSW5kZXg7CiAgICAgIHN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5kYXRhS2V5ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlRGF0YUtleTsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmdyYXBoaWNhbEl0ZW1JZCA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUdyYXBoaWNhbEl0ZW1JZDsKICAgICAgc3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrLmNvb3JkaW5hdGUgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVDb29yZGluYXRlOwogICAgfSwKICAgIHNldE1vdXNlT3ZlckF4aXNJbmRleChzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnN5bmNJbnRlcmFjdGlvbi5hY3RpdmUgPSBmYWxzZTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyLmFjdGl2ZSA9IHRydWU7CiAgICAgIHN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlID0gZmFsc2U7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3Zlci5pbmRleCA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUluZGV4OwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uaG92ZXIuZGF0YUtleSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZURhdGFLZXk7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3Zlci5jb29yZGluYXRlID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlQ29vcmRpbmF0ZTsKICAgIH0sCiAgICBzZXRNb3VzZUNsaWNrQXhpc0luZGV4KHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuc3luY0ludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSA9IGZhbHNlOwogICAgICBzdGF0ZS5heGlzSW50ZXJhY3Rpb24uY2xpY2suYWN0aXZlID0gdHJ1ZTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmNsaWNrLmluZGV4ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlSW5kZXg7CiAgICAgIHN0YXRlLmF4aXNJbnRlcmFjdGlvbi5jbGljay5kYXRhS2V5ID0gYWN0aW9uLnBheWxvYWQuYWN0aXZlRGF0YUtleTsKICAgICAgc3RhdGUuYXhpc0ludGVyYWN0aW9uLmNsaWNrLmNvb3JkaW5hdGUgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVDb29yZGluYXRlOwogICAgfSwKICAgIHNldFN5bmNJbnRlcmFjdGlvbihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLnN5bmNJbnRlcmFjdGlvbiA9IGFjdGlvbi5wYXlsb2FkOwogICAgfSwKICAgIHNldEtleWJvYXJkSW50ZXJhY3Rpb24oc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZTsKICAgICAgc3RhdGUua2V5Ym9hcmRJbnRlcmFjdGlvbi5pbmRleCA9IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZUluZGV4OwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmNvb3JkaW5hdGUgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVDb29yZGluYXRlOwogICAgICBzdGF0ZS5rZXlib2FyZEludGVyYWN0aW9uLmRhdGFLZXkgPSBhY3Rpb24ucGF5bG9hZC5hY3RpdmVEYXRhS2V5OwogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkVG9vbHRpcEVudHJ5U2V0dGluZ3MsCiAgcmVwbGFjZVRvb2x0aXBFbnRyeVNldHRpbmdzLAogIHJlbW92ZVRvb2x0aXBFbnRyeVNldHRpbmdzLAogIHNldFRvb2x0aXBTZXR0aW5nc1N0YXRlLAogIHNldEFjdGl2ZU1vdXNlT3Zlckl0ZW1JbmRleCwKICBtb3VzZUxlYXZlSXRlbSwKICBtb3VzZUxlYXZlQ2hhcnQsCiAgc2V0QWN0aXZlQ2xpY2tJdGVtSW5kZXgsCiAgc2V0TW91c2VPdmVyQXhpc0luZGV4LAogIHNldE1vdXNlQ2xpY2tBeGlzSW5kZXgsCiAgc2V0U3luY0ludGVyYWN0aW9uLAogIHNldEtleWJvYXJkSW50ZXJhY3Rpb24KfSA9IHRvb2x0aXBTbGljZS5hY3Rpb25zOwp2YXIgdG9vbHRpcFJlZHVjZXIgPSB0b29sdGlwU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZVRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmpzCmZ1bmN0aW9uIG93bktleXMxNChlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDE0KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTQoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTE0KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czE0KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxNChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTE0KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTE0KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTE0KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTE0KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBjaG9vc2VBcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24odG9vbHRpcFN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyKSB7CiAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgaWYgKHRyaWdnZXIgPT09ICJjbGljayIpIHsKICAgICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5heGlzSW50ZXJhY3Rpb24uY2xpY2s7CiAgICB9CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLmF4aXNJbnRlcmFjdGlvbi5ob3ZlcjsKICB9CiAgaWYgKHRyaWdnZXIgPT09ICJjbGljayIpIHsKICAgIHJldHVybiB0b29sdGlwU3RhdGUuaXRlbUludGVyYWN0aW9uLmNsaWNrOwogIH0KICByZXR1cm4gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5ob3ZlcjsKfQpmdW5jdGlvbiBoYXNCZWVuQWN0aXZlUHJldmlvdXNseSh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSkgewogIHJldHVybiB0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZS5pbmRleCAhPSBudWxsOwp9CnZhciBjb21iaW5lVG9vbHRpcEludGVyYWN0aW9uU3RhdGUgPSAodG9vbHRpcFN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBkZWZhdWx0SW5kZXgpID0+IHsKICBpZiAodG9vbHRpcEV2ZW50VHlwZSA9PSBudWxsKSB7CiAgICByZXR1cm4gbm9JbnRlcmFjdGlvbjsKICB9CiAgdmFyIGFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbiA9IGNob29zZUFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbih0b29sdGlwU3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIpOwogIGlmIChhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24gPT0gbnVsbCkgewogICAgcmV0dXJuIG5vSW50ZXJhY3Rpb247CiAgfQogIGlmIChhcHByb3ByaWF0ZU1vdXNlSW50ZXJhY3Rpb24uYWN0aXZlKSB7CiAgICByZXR1cm4gYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uOwogIH0KICBpZiAodG9vbHRpcFN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlKSB7CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLmtleWJvYXJkSW50ZXJhY3Rpb247CiAgfQogIGlmICh0b29sdGlwU3RhdGUuc3luY0ludGVyYWN0aW9uLmFjdGl2ZSAmJiB0b29sdGlwU3RhdGUuc3luY0ludGVyYWN0aW9uLmluZGV4ICE9IG51bGwpIHsKICAgIHJldHVybiB0b29sdGlwU3RhdGUuc3luY0ludGVyYWN0aW9uOwogIH0KICB2YXIgYWN0aXZlRnJvbVByb3BzID0gdG9vbHRpcFN0YXRlLnNldHRpbmdzLmFjdGl2ZSA9PT0gdHJ1ZTsKICBpZiAoaGFzQmVlbkFjdGl2ZVByZXZpb3VzbHkoYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uKSkgewogICAgaWYgKGFjdGl2ZUZyb21Qcm9wcykgewogICAgICByZXR1cm4gX29iamVjdFNwcmVhZDE0KF9vYmplY3RTcHJlYWQxNCh7fSwgYXBwcm9wcmlhdGVNb3VzZUludGVyYWN0aW9uKSwge30sIHsKICAgICAgICBhY3RpdmU6IHRydWUKICAgICAgfSk7CiAgICB9CiAgfSBlbHNlIGlmIChkZWZhdWx0SW5kZXggIT0gbnVsbCkgewogICAgcmV0dXJuIHsKICAgICAgYWN0aXZlOiB0cnVlLAogICAgICBjb29yZGluYXRlOiB2b2lkIDAsCiAgICAgIGRhdGFLZXk6IHZvaWQgMCwKICAgICAgaW5kZXg6IGRlZmF1bHRJbmRleCwKICAgICAgZ3JhcGhpY2FsSXRlbUlkOiB2b2lkIDAKICAgIH07CiAgfQogIHJldHVybiBfb2JqZWN0U3ByZWFkMTQoX29iamVjdFNwcmVhZDE0KHt9LCBub0ludGVyYWN0aW9uKSwge30sIHsKICAgIGNvb3JkaW5hdGU6IGFwcHJvcHJpYXRlTW91c2VJbnRlcmFjdGlvbi5jb29yZGluYXRlCiAgfSk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29tYmluZXJzL2NvbWJpbmVBY3RpdmVUb29sdGlwSW5kZXguanMKZnVuY3Rpb24gdG9GaW5pdGVOdW1iZXIodmFsdWUpIHsKICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIikgewogICAgcmV0dXJuIE51bWJlci5pc0Zpbml0ZSh2YWx1ZSkgPyB2YWx1ZSA6IHZvaWQgMDsKICB9CiAgaWYgKHZhbHVlIGluc3RhbmNlb2YgRGF0ZSkgewogICAgdmFyIG51bWVyaWNWYWx1ZSA9IHZhbHVlLnZhbHVlT2YoKTsKICAgIHJldHVybiBOdW1iZXIuaXNGaW5pdGUobnVtZXJpY1ZhbHVlKSA/IG51bWVyaWNWYWx1ZSA6IHZvaWQgMDsKICB9CiAgdmFyIHBhcnNlZCA9IE51bWJlcih2YWx1ZSk7CiAgcmV0dXJuIE51bWJlci5pc0Zpbml0ZShwYXJzZWQpID8gcGFyc2VkIDogdm9pZCAwOwp9CmZ1bmN0aW9uIGlzVmFsdWVXaXRoaW5OdW1iZXJEb21haW4odmFsdWUsIGRvbWFpbikgewogIHZhciBudW1lcmljVmFsdWUgPSB0b0Zpbml0ZU51bWJlcih2YWx1ZSk7CiAgdmFyIGxvd2VyQm91bmQgPSBkb21haW5bMF07CiAgdmFyIHVwcGVyQm91bmQgPSBkb21haW5bMV07CiAgaWYgKG51bWVyaWNWYWx1ZSA9PT0gdm9pZCAwKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHZhciBtaW4yID0gTWF0aC5taW4obG93ZXJCb3VuZCwgdXBwZXJCb3VuZCk7CiAgdmFyIG1heDIgPSBNYXRoLm1heChsb3dlckJvdW5kLCB1cHBlckJvdW5kKTsKICByZXR1cm4gbnVtZXJpY1ZhbHVlID49IG1pbjIgJiYgbnVtZXJpY1ZhbHVlIDw9IG1heDI7Cn0KZnVuY3Rpb24gaXNWYWx1ZVdpdGhpbkRvbWFpbihlbnRyeSwgYXhpc0RhdGFLZXksIGRvbWFpbikgewogIGlmIChkb21haW4gPT0gbnVsbCB8fCBheGlzRGF0YUtleSA9PSBudWxsKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgdmFyIHZhbHVlID0gZ2V0VmFsdWVCeURhdGFLZXkoZW50cnksIGF4aXNEYXRhS2V5KTsKICBpZiAodmFsdWUgPT0gbnVsbCkgewogICAgcmV0dXJuIHRydWU7CiAgfQogIGlmICghaXNXZWxsRm9ybWVkTnVtYmVyRG9tYWluKGRvbWFpbikpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gaXNWYWx1ZVdpdGhpbk51bWJlckRvbWFpbih2YWx1ZSwgZG9tYWluKTsKfQp2YXIgY29tYmluZUFjdGl2ZVRvb2x0aXBJbmRleCA9ICh0b29sdGlwSW50ZXJhY3Rpb24sIGNoYXJ0RGF0YSwgYXhpc0RhdGFLZXksIGRvbWFpbikgPT4gewogIHZhciBkZXNpcmVkSW5kZXggPSB0b29sdGlwSW50ZXJhY3Rpb24gPT09IG51bGwgfHwgdG9vbHRpcEludGVyYWN0aW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiB0b29sdGlwSW50ZXJhY3Rpb24uaW5kZXg7CiAgaWYgKGRlc2lyZWRJbmRleCA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGluZGV4QXNOdW1iZXIgPSBOdW1iZXIoZGVzaXJlZEluZGV4KTsKICBpZiAoIWlzV2VsbEJlaGF2ZWROdW1iZXIoaW5kZXhBc051bWJlcikpIHsKICAgIHJldHVybiBkZXNpcmVkSW5kZXg7CiAgfQogIHZhciBsb3dlckxpbWl0ID0gMDsKICB2YXIgdXBwZXJMaW1pdCA9IEluZmluaXR5OwogIGlmIChjaGFydERhdGEubGVuZ3RoID4gMCkgewogICAgdXBwZXJMaW1pdCA9IGNoYXJ0RGF0YS5sZW5ndGggLSAxOwogIH0KICB2YXIgY2xhbXBlZEluZGV4ID0gTWF0aC5tYXgobG93ZXJMaW1pdCwgTWF0aC5taW4oaW5kZXhBc051bWJlciwgdXBwZXJMaW1pdCkpOwogIHZhciBlbnRyeSA9IGNoYXJ0RGF0YVtjbGFtcGVkSW5kZXhdOwogIGlmIChlbnRyeSA9PSBudWxsKSB7CiAgICByZXR1cm4gU3RyaW5nKGNsYW1wZWRJbmRleCk7CiAgfQogIGlmICghaXNWYWx1ZVdpdGhpbkRvbWFpbihlbnRyeSwgYXhpc0RhdGFLZXksIGRvbWFpbikpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gU3RyaW5nKGNsYW1wZWRJbmRleCk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvY29tYmluZXJzL2NvbWJpbmVDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4LmpzCnZhciBjb21iaW5lQ29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleCA9ICh3aWR0aCwgaGVpZ2h0LCBsYXlvdXQsIG9mZnNldCwgdG9vbHRpcFRpY2tzLCBkZWZhdWx0SW5kZXgsIHRvb2x0aXBDb25maWd1cmF0aW9ucywgdG9vbHRpcFBheWxvYWRTZWFyY2hlcikgPT4gewogIGlmIChkZWZhdWx0SW5kZXggPT0gbnVsbCB8fCB0b29sdGlwUGF5bG9hZFNlYXJjaGVyID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBmaXJzdENvbmZpZ3VyYXRpb24gPSB0b29sdGlwQ29uZmlndXJhdGlvbnNbMF07CiAgdmFyIG1heWJlUG9zaXRpb24gPSBmaXJzdENvbmZpZ3VyYXRpb24gPT0gbnVsbCA/IHZvaWQgMCA6IHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIoZmlyc3RDb25maWd1cmF0aW9uLnBvc2l0aW9ucywgZGVmYXVsdEluZGV4KTsKICBpZiAobWF5YmVQb3NpdGlvbiAhPSBudWxsKSB7CiAgICByZXR1cm4gbWF5YmVQb3NpdGlvbjsKICB9CiAgdmFyIHRpY2sgPSB0b29sdGlwVGlja3MgPT09IG51bGwgfHwgdG9vbHRpcFRpY2tzID09PSB2b2lkIDAgPyB2b2lkIDAgOiB0b29sdGlwVGlja3NbTnVtYmVyKGRlZmF1bHRJbmRleCldOwogIGlmICghdGljaykgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgc3dpdGNoIChsYXlvdXQpIHsKICAgIGNhc2UgImhvcml6b250YWwiOiB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogdGljay5jb29yZGluYXRlLAogICAgICAgIHk6IChvZmZzZXQudG9wICsgaGVpZ2h0KSAvIDIKICAgICAgfTsKICAgIH0KICAgIGRlZmF1bHQ6IHsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiAob2Zmc2V0LmxlZnQgKyB3aWR0aCkgLyAyLAogICAgICAgIHk6IHRpY2suY29vcmRpbmF0ZQogICAgICB9OwogICAgfQogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZVRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMuanMKdmFyIGNvbWJpbmVUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zID0gKHRvb2x0aXBTdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4KSA9PiB7CiAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS50b29sdGlwSXRlbVBheWxvYWRzOwogIH0KICBpZiAodG9vbHRpcFN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4gW107CiAgfQogIHZhciBmaWx0ZXJCeURhdGFLZXk7CiAgaWYgKHRyaWdnZXIgPT09ICJob3ZlciIpIHsKICAgIGZpbHRlckJ5RGF0YUtleSA9IHRvb2x0aXBTdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuZGF0YUtleTsKICB9IGVsc2UgewogICAgZmlsdGVyQnlEYXRhS2V5ID0gdG9vbHRpcFN0YXRlLml0ZW1JbnRlcmFjdGlvbi5jbGljay5kYXRhS2V5OwogIH0KICBpZiAoZmlsdGVyQnlEYXRhS2V5ID09IG51bGwgJiYgZGVmYXVsdEluZGV4ICE9IG51bGwpIHsKICAgIHJldHVybiBbdG9vbHRpcFN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHNbMF1dOwogIH0KICByZXR1cm4gdG9vbHRpcFN0YXRlLnRvb2x0aXBJdGVtUGF5bG9hZHMuZmlsdGVyKCh0cGMpID0+IHsKICAgIHZhciBfdHBjJHNldHRpbmdzOwogICAgcmV0dXJuICgoX3RwYyRzZXR0aW5ncyA9IHRwYy5zZXR0aW5ncykgPT09IG51bGwgfHwgX3RwYyRzZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RwYyRzZXR0aW5ncy5kYXRhS2V5KSA9PT0gZmlsdGVyQnlEYXRhS2V5OwogIH0pOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXIuanMKdmFyIHNlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXIgPSAoc3RhdGUpID0+IHN0YXRlLm9wdGlvbnMudG9vbHRpcFBheWxvYWRTZWFyY2hlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RUb29sdGlwU3RhdGUuanMKdmFyIHNlbGVjdFRvb2x0aXBTdGF0ZSA9IChzdGF0ZSkgPT4gc3RhdGUudG9vbHRpcDsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9jb21iaW5lcnMvY29tYmluZVRvb2x0aXBQYXlsb2FkLmpzCmZ1bmN0aW9uIG93bktleXMxNShlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDE1KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMTUoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTE1KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czE1KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkxNShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTE1KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTE1KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTE1KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTE1KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBzZWxlY3RGaW5hbERhdGEoZGF0YURlZmluZWRPbkl0ZW0sIGRhdGFEZWZpbmVkT25DaGFydCkgewogIGlmIChkYXRhRGVmaW5lZE9uSXRlbSAhPSBudWxsKSB7CiAgICByZXR1cm4gZGF0YURlZmluZWRPbkl0ZW07CiAgfQogIHJldHVybiBkYXRhRGVmaW5lZE9uQ2hhcnQ7Cn0KdmFyIGNvbWJpbmVUb29sdGlwUGF5bG9hZCA9ICh0b29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zLCBhY3RpdmVJbmRleCwgY2hhcnREYXRhU3RhdGUsIHRvb2x0aXBBeGlzRGF0YUtleSwgYWN0aXZlTGFiZWwsIHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsIHRvb2x0aXBFdmVudFR5cGUpID0+IHsKICBpZiAoYWN0aXZlSW5kZXggPT0gbnVsbCB8fCB0b29sdGlwUGF5bG9hZFNlYXJjaGVyID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBjaGFydERhdGEsCiAgICBjb21wdXRlZERhdGEsCiAgICBkYXRhU3RhcnRJbmRleCwKICAgIGRhdGFFbmRJbmRleAogIH0gPSBjaGFydERhdGFTdGF0ZTsKICB2YXIgaW5pdCA9IFtdOwogIHJldHVybiB0b29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zLnJlZHVjZSgoYWdnLCBfcmVmMikgPT4gewogICAgdmFyIF9zZXR0aW5ncyRkYXRhS2V5OwogICAgdmFyIHsKICAgICAgZGF0YURlZmluZWRPbkl0ZW0sCiAgICAgIHNldHRpbmdzCiAgICB9ID0gX3JlZjI7CiAgICB2YXIgZmluYWxEYXRhID0gc2VsZWN0RmluYWxEYXRhKGRhdGFEZWZpbmVkT25JdGVtLCBjaGFydERhdGEpOwogICAgdmFyIHNsaWNlZCA9IEFycmF5LmlzQXJyYXkoZmluYWxEYXRhKSA/IGdldFNsaWNlZChmaW5hbERhdGEsIGRhdGFTdGFydEluZGV4LCBkYXRhRW5kSW5kZXgpIDogZmluYWxEYXRhOwogICAgdmFyIGZpbmFsRGF0YUtleSA9IChfc2V0dGluZ3MkZGF0YUtleSA9IHNldHRpbmdzID09PSBudWxsIHx8IHNldHRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXR0aW5ncy5kYXRhS2V5KSAhPT0gbnVsbCAmJiBfc2V0dGluZ3MkZGF0YUtleSAhPT0gdm9pZCAwID8gX3NldHRpbmdzJGRhdGFLZXkgOiB0b29sdGlwQXhpc0RhdGFLZXk7CiAgICB2YXIgZmluYWxOYW1lS2V5ID0gc2V0dGluZ3MgPT09IG51bGwgfHwgc2V0dGluZ3MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNldHRpbmdzLm5hbWVLZXk7CiAgICB2YXIgdG9vbHRpcFBheWxvYWQ7CiAgICBpZiAodG9vbHRpcEF4aXNEYXRhS2V5ICYmIEFycmF5LmlzQXJyYXkoc2xpY2VkKSAmJiAvKgogICAgICogZmluZEVudHJ5SW5BcnJheSB3b24ndCB3b3JrIGZvciBTY2F0dGVyIGJlY2F1c2UgU2NhdHRlciBwcm92aWRlcyBhbiBhcnJheSBvZiBhcnJheXMKICAgICAqIGFzIHRvb2x0aXAgcGF5bG9hZHMgYW5kIGZpbmRFbnRyeUluQXJyYXkgaXMgbm90IHByZXBhcmVkIHRvIGhhbmRsZSB0aGF0LgogICAgICogU2FkIGJ1dCBhbHNvIFNjYXR0ZXJDaGFydCBvbmx5IGFsbG93cyAnaXRlbScgdG9vbHRpcEV2ZW50VHlwZQogICAgICogYW5kIGFsc28gdGhpcyBpcyBvbmx5IGEgcHJvYmxlbSBpZiB0aGVyZSBhcmUgbXVsdGlwbGUgU2NhdHRlcnMgYW5kIGVhY2ggaGFzIGl0cyBvd24gZGF0YSBhcnJheQogICAgICogc28gbGV0J3MgZml4IHRoYXQgc29tZSBvdGhlciB0aW1lLgogICAgICovCiAgICAhQXJyYXkuaXNBcnJheShzbGljZWRbMF0pICYmIC8qCiAgICAgKiBJZiB0aGUgdG9vbHRpcEV2ZW50VHlwZSBpcyAnYXhpcycsIHdlIHNob3VsZCBzZWFyY2ggZm9yIHRoZSBkYXRhS2V5IGluIHRoZSBzbGljZWQgZGF0YQogICAgICogYmVjYXVzZSB0aGFua3MgdG8gYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk9ZmFsc2UsIHRoZSBvcmRlciBvZiBlbGVtZW50cyBpbiB0aGUgYXJyYXkKICAgICAqIG5vIGxvbmdlciBtYXRjaGVzIHRoZSBvcmRlciBvZiBlbGVtZW50cyBpbiB0aGUgb3JpZ2luYWwgZGF0YQogICAgICogYW5kIHNvIHdlIG5lZWQgdG8gc2VhcmNoIGJ5IHRoZSBhY3RpdmUgZGF0YUtleSArIGxhYmVsIHJhdGhlciB0aGFuIGJ5IGluZGV4LgogICAgICoKICAgICAqIFRoZSBzYW1lIGhhcHBlbnMgaWYgbXVsdGlwbGUgZ3JhcGhpY2FsIGl0ZW1zIGFyZSBwcmVzZW50IGluIHRoZSBjaGFydAogICAgICogYW5kIGVhY2ggb2YgdGhlbSBoYXMgaXRzIG93biBkYXRhIGFycmF5LiBUaG9zZSBhcnJheXMgZ2V0IGNvbmNhdGVuYXRlZAogICAgICogYW5kIGFnYWluIHRoZSB0b29sdGlwIGluZGV4IG5vIGxvbmdlciBtYXRjaGVzIHRoZSBvcmlnaW5hbCBkYXRhLgogICAgICoKICAgICAqIE9uIHRoZSBvdGhlciBoYW5kIHRoZSB0b29sdGlwRXZlbnRUeXBlICdpdGVtJyBzaG91bGQgYWx3YXlzIHNlYXJjaCBieSBpbmRleAogICAgICogYmVjYXVzZSB3ZSBnZXQgdGhlIGluZGV4IGZyb20gaW50ZXJhY3Rpbmcgb3ZlciB0aGUgaW5kaXZpZHVhbCBlbGVtZW50cwogICAgICogd2hpY2ggaXMgYWx3YXlzIGFjY3VyYXRlLCBpcnJlc3BlY3RpdmUgb2YgdGhlIGFsbG93RHVwbGljYXRlZENhdGVnb3J5IHNldHRpbmcuCiAgICAgKi8KICAgIHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgICB0b29sdGlwUGF5bG9hZCA9IGZpbmRFbnRyeUluQXJyYXkoc2xpY2VkLCB0b29sdGlwQXhpc0RhdGFLZXksIGFjdGl2ZUxhYmVsKTsKICAgIH0gZWxzZSB7CiAgICAgIHRvb2x0aXBQYXlsb2FkID0gdG9vbHRpcFBheWxvYWRTZWFyY2hlcihzbGljZWQsIGFjdGl2ZUluZGV4LCBjb21wdXRlZERhdGEsIGZpbmFsTmFtZUtleSk7CiAgICB9CiAgICBpZiAoQXJyYXkuaXNBcnJheSh0b29sdGlwUGF5bG9hZCkpIHsKICAgICAgdG9vbHRpcFBheWxvYWQuZm9yRWFjaCgoaXRlbSkgPT4gewogICAgICAgIHZhciBuZXdTZXR0aW5ncyA9IF9vYmplY3RTcHJlYWQxNShfb2JqZWN0U3ByZWFkMTUoe30sIHNldHRpbmdzKSwge30sIHsKICAgICAgICAgIG5hbWU6IGl0ZW0ubmFtZSwKICAgICAgICAgIHVuaXQ6IGl0ZW0udW5pdCwKICAgICAgICAgIC8vIGNvbG9yIGFuZCBmaWxsIGFyZSBlcmFzZWQgdG8ga2VlcCAxMDAlIHRoZSBpZGVudGljYWwgYmVoYXZpb3VyIHRvIHJlY2hhcnRzIDIueCAtIGJ1dCB0aGVyZSdzIG5vdGhpbmcgc3RvcHBpbmcgdXMgZnJvbSByZXR1cm5pbmcgdGhlbSBoZXJlLiBJdCdzIHRlY2huaWNhbGx5IGEgYnJlYWtpbmcgY2hhbmdlLgogICAgICAgICAgY29sb3I6IHZvaWQgMCwKICAgICAgICAgIC8vIGNvbG9yIGFuZCBmaWxsIGFyZSBlcmFzZWQgdG8ga2VlcCAxMDAlIHRoZSBpZGVudGljYWwgYmVoYXZpb3VyIHRvIHJlY2hhcnRzIDIueCAtIGJ1dCB0aGVyZSdzIG5vdGhpbmcgc3RvcHBpbmcgdXMgZnJvbSByZXR1cm5pbmcgdGhlbSBoZXJlLiBJdCdzIHRlY2huaWNhbGx5IGEgYnJlYWtpbmcgY2hhbmdlLgogICAgICAgICAgZmlsbDogdm9pZCAwCiAgICAgICAgfSk7CiAgICAgICAgYWdnLnB1c2goZ2V0VG9vbHRpcEVudHJ5KHsKICAgICAgICAgIHRvb2x0aXBFbnRyeVNldHRpbmdzOiBuZXdTZXR0aW5ncywKICAgICAgICAgIGRhdGFLZXk6IGl0ZW0uZGF0YUtleSwKICAgICAgICAgIHBheWxvYWQ6IGl0ZW0ucGF5bG9hZCwKICAgICAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgZ2V0VmFsdWVCeURhdGFLZXkgZG9lcyBub3QgdmFsaWRhdGUgdGhlIG91dHB1dCB0eXBlCiAgICAgICAgICB2YWx1ZTogZ2V0VmFsdWVCeURhdGFLZXkoaXRlbS5wYXlsb2FkLCBpdGVtLmRhdGFLZXkpLAogICAgICAgICAgbmFtZTogaXRlbS5uYW1lCiAgICAgICAgfSkpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBfZ2V0VmFsdWVCeURhdGFLZXk7CiAgICAgIGFnZy5wdXNoKGdldFRvb2x0aXBFbnRyeSh7CiAgICAgICAgdG9vbHRpcEVudHJ5U2V0dGluZ3M6IHNldHRpbmdzLAogICAgICAgIGRhdGFLZXk6IGZpbmFsRGF0YUtleSwKICAgICAgICBwYXlsb2FkOiB0b29sdGlwUGF5bG9hZCwKICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGdldFZhbHVlQnlEYXRhS2V5IGRvZXMgbm90IHZhbGlkYXRlIHRoZSBvdXRwdXQgdHlwZQogICAgICAgIHZhbHVlOiBnZXRWYWx1ZUJ5RGF0YUtleSh0b29sdGlwUGF5bG9hZCwgZmluYWxEYXRhS2V5KSwKICAgICAgICAvLyBAdHMtZXhwZWN0LWVycm9yIGdldFZhbHVlQnlEYXRhS2V5IGRvZXMgbm90IHZhbGlkYXRlIHRoZSBvdXRwdXQgdHlwZQogICAgICAgIG5hbWU6IChfZ2V0VmFsdWVCeURhdGFLZXkgPSBnZXRWYWx1ZUJ5RGF0YUtleSh0b29sdGlwUGF5bG9hZCwgZmluYWxOYW1lS2V5KSkgIT09IG51bGwgJiYgX2dldFZhbHVlQnlEYXRhS2V5ICE9PSB2b2lkIDAgPyBfZ2V0VmFsdWVCeURhdGFLZXkgOiBzZXR0aW5ncyA9PT0gbnVsbCB8fCBzZXR0aW5ncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2V0dGluZ3MubmFtZQogICAgICB9KSk7CiAgICB9CiAgICByZXR1cm4gYWdnOwogIH0sIGluaXQpOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3Rvb2x0aXBTZWxlY3RvcnMuanMKdmFyIHNlbGVjdFRvb2x0aXBBeGlzUmVhbFNjYWxlVHlwZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEhhc0Jhciwgc2VsZWN0Q2hhcnROYW1lLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lUmVhbFNjYWxlVHlwZSk7CnZhciBzZWxlY3RBbGxVbmZpbHRlcmVkR3JhcGhpY2FsSXRlbXMgPSBjcmVhdGVTZWxlY3RvcihbKHN0YXRlKSA9PiBzdGF0ZS5ncmFwaGljYWxJdGVtcy5jYXJ0ZXNpYW5JdGVtcywgKHN0YXRlKSA9PiBzdGF0ZS5ncmFwaGljYWxJdGVtcy5wb2xhckl0ZW1zXSwgKGNhcnRlc2lhbkl0ZW1zLCBwb2xhckl0ZW1zKSA9PiBbLi4uY2FydGVzaWFuSXRlbXMsIC4uLnBvbGFySXRlbXNdKTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzUHJlZGljYXRlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNJZF0sIGl0ZW1BeGlzUHJlZGljYXRlKTsKdmFyIHNlbGVjdEFsbEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsVW5maWx0ZXJlZEdyYXBoaWNhbEl0ZW1zLCBzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNQcmVkaWNhdGVdLCBjb21iaW5lR3JhcGhpY2FsSXRlbXNTZXR0aW5ncywgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBlbXB0eUFycmF5c0FyZUVxdWFsQ2hlY2sKICB9Cn0pOwp2YXIgc2VsZWN0QWxsU3RhY2tlZEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsR3JhcGhpY2FsSXRlbXNTZXR0aW5nc10sIChncmFwaGljYWxJdGVtcykgPT4gZ3JhcGhpY2FsSXRlbXMuZmlsdGVyKGlzU3RhY2tlZCkpOwp2YXIgc2VsZWN0VG9vbHRpcEdyYXBoaWNhbEl0ZW1zRGF0YSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxHcmFwaGljYWxJdGVtc1NldHRpbmdzXSwgY29tYmluZUdyYXBoaWNhbEl0ZW1zRGF0YSwgewogIG1lbW9pemVPcHRpb25zOiB7CiAgICByZXN1bHRFcXVhbGl0eUNoZWNrOiBlbXB0eUFycmF5c0FyZUVxdWFsQ2hlY2sKICB9Cn0pOwp2YXIgc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEdyYXBoaWNhbEl0ZW1zRGF0YSwgc2VsZWN0Q2hhcnREYXRhV2l0aEluZGV4ZXNdLCBjb21iaW5lRGlzcGxheWVkRGF0YSk7CnZhciBzZWxlY3RUb29sdGlwU3RhY2tlZERhdGEgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0QWxsU3RhY2tlZEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3MsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzLCBzZWxlY3RUb29sdGlwQXhpc10sIGNvbWJpbmVEaXNwbGF5ZWRTdGFja2VkRGF0YSk7CnZhciBzZWxlY3RBbGxUb29sdGlwQXBwbGllZFZhbHVlcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YSwgc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdEFsbEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3NdLCBjb21iaW5lQXBwbGllZFZhbHVlcyk7CnZhciBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbkRlZmluaXRpb24gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNdLCBnZXREb21haW5EZWZpbml0aW9uKTsKdmFyIHNlbGVjdFRvb2x0aXBEYXRhT3ZlcmZsb3cgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNdLCAoYXhpc1NldHRpbmdzKSA9PiBheGlzU2V0dGluZ3MuYWxsb3dEYXRhT3ZlcmZsb3cpOwp2YXIgc2VsZWN0VG9vbHRpcERvbWFpbkZyb21Vc2VyUHJlZmVyZW5jZXMgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNEb21haW5EZWZpbml0aW9uLCBzZWxlY3RUb29sdGlwRGF0YU92ZXJmbG93XSwgbnVtZXJpY2FsRG9tYWluU3BlY2lmaWVkV2l0aG91dFJlcXVpcmluZ0RhdGEpOwp2YXIgc2VsZWN0QWxsU3RhY2tlZEdyYXBoaWNhbEl0ZW1zID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3NdLCAoZ3JhcGhpY2FsSXRlbXMpID0+IGdyYXBoaWNhbEl0ZW1zLmZpbHRlcihpc1N0YWNrZWQpKTsKdmFyIHNlbGVjdFRvb2x0aXBTdGFja0dyb3VwcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwU3RhY2tlZERhdGEsIHNlbGVjdEFsbFN0YWNrZWRHcmFwaGljYWxJdGVtcywgc2VsZWN0U3RhY2tPZmZzZXRUeXBlLCBzZWxlY3RSZXZlcnNlU3RhY2tPcmRlcl0sIGNvbWJpbmVTdGFja0dyb3Vwcyk7CnZhciBzZWxlY3RUb29sdGlwRG9tYWluT2ZTdGFja0dyb3VwcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwU3RhY2tHcm91cHMsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGUsIHNlbGVjdFRvb2x0aXBEb21haW5Gcm9tVXNlclByZWZlcmVuY2VzXSwgY29tYmluZURvbWFpbk9mU3RhY2tHcm91cHMpOwp2YXIgc2VsZWN0VG9vbHRpcEl0ZW1zU2V0dGluZ3NFeGNlcHRTdGFja2VkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdEFsbEdyYXBoaWNhbEl0ZW1zU2V0dGluZ3NdLCBmaWx0ZXJHcmFwaGljYWxOb3RTdGFja2VkSXRlbXMpOwp2YXIgc2VsZWN0RG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBEaXNwbGF5ZWREYXRhLCBzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEl0ZW1zU2V0dGluZ3NFeGNlcHRTdGFja2VkLCBzZWxlY3RBbGxFcnJvckJhclNldHRpbmdzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lRG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMsIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogbnVtYmVyRG9tYWluRXF1YWxpdHlDaGVjawogIH0KfSk7CnZhciBzZWxlY3RSZWZlcmVuY2VEb3RzQnlUb29sdGlwQXhpcyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VEb3RzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGUsIHNlbGVjdFRvb2x0aXBBeGlzSWRdLCBmaWx0ZXJSZWZlcmVuY2VFbGVtZW50cyk7CnZhciBzZWxlY3RUb29sdGlwUmVmZXJlbmNlRG90c0RvbWFpbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RSZWZlcmVuY2VEb3RzQnlUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNUeXBlXSwgY29tYmluZURvdHNEb21haW4pOwp2YXIgc2VsZWN0UmVmZXJlbmNlQXJlYXNCeVRvb2x0aXBBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUFyZWFzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGUsIHNlbGVjdFRvb2x0aXBBeGlzSWRdLCBmaWx0ZXJSZWZlcmVuY2VFbGVtZW50cyk7CnZhciBzZWxlY3RUb29sdGlwUmVmZXJlbmNlQXJlYXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlQXJlYXNCeVRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lQXJlYXNEb21haW4pOwp2YXIgc2VsZWN0UmVmZXJlbmNlTGluZXNCeVRvb2x0aXBBeGlzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFJlZmVyZW5jZUxpbmVzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGUsIHNlbGVjdFRvb2x0aXBBeGlzSWRdLCBmaWx0ZXJSZWZlcmVuY2VFbGVtZW50cyk7CnZhciBzZWxlY3RUb29sdGlwUmVmZXJlbmNlTGluZXNEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0UmVmZXJlbmNlTGluZXNCeVRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lTGluZXNEb21haW4pOwp2YXIgc2VsZWN0VG9vbHRpcFJlZmVyZW5jZUVsZW1lbnRzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBSZWZlcmVuY2VEb3RzRG9tYWluLCBzZWxlY3RUb29sdGlwUmVmZXJlbmNlTGluZXNEb21haW4sIHNlbGVjdFRvb2x0aXBSZWZlcmVuY2VBcmVhc0RvbWFpbl0sIG1lcmdlRG9tYWlucyk7CnZhciBzZWxlY3RUb29sdGlwTnVtZXJpY2FsRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbkRlZmluaXRpb24sIHNlbGVjdFRvb2x0aXBEb21haW5Gcm9tVXNlclByZWZlcmVuY2VzLCBzZWxlY3RUb29sdGlwRG9tYWluT2ZTdGFja0dyb3Vwcywgc2VsZWN0RG9tYWluT2ZBbGxBcHBsaWVkTnVtZXJpY2FsVmFsdWVzSW5jbHVkaW5nRXJyb3JWYWx1ZXMyLCBzZWxlY3RUb29sdGlwUmVmZXJlbmNlRWxlbWVudHNEb21haW4sIHNlbGVjdENoYXJ0TGF5b3V0LCBzZWxlY3RUb29sdGlwQXhpc1R5cGVdLCBjb21iaW5lTnVtZXJpY2FsRG9tYWluKTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0VG9vbHRpcERpc3BsYXllZERhdGEsIHNlbGVjdEFsbFRvb2x0aXBBcHBsaWVkVmFsdWVzLCBzZWxlY3RTdGFja09mZnNldFR5cGUsIHNlbGVjdFRvb2x0aXBBeGlzVHlwZSwgc2VsZWN0VG9vbHRpcE51bWVyaWNhbERvbWFpbl0sIGNvbWJpbmVBeGlzRG9tYWluKTsKdmFyIHNlbGVjdFRvb2x0aXBOaWNlVGlja3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXNEb21haW4sIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1JlYWxTY2FsZVR5cGVdLCBjb21iaW5lTmljZVRpY2tzKTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluSW5jbHVkaW5nTmljZVRpY2tzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc0RvbWFpbiwgc2VsZWN0VG9vbHRpcE5pY2VUaWNrcywgc2VsZWN0VG9vbHRpcEF4aXNUeXBlXSwgY29tYmluZUF4aXNEb21haW5XaXRoTmljZVRpY2tzKTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzUmFuZ2UgPSAoc3RhdGUpID0+IHsKICB2YXIgYXhpc1R5cGUgPSBzZWxlY3RUb29sdGlwQXhpc1R5cGUoc3RhdGUpOwogIHZhciBheGlzSWQgPSBzZWxlY3RUb29sdGlwQXhpc0lkKHN0YXRlKTsKICB2YXIgaXNQYW5vcmFtYSA9IGZhbHNlOwogIHJldHVybiBzZWxlY3RBeGlzUmFuZ2Uoc3RhdGUsIGF4aXNUeXBlLCBheGlzSWQsIGlzUGFub3JhbWEpOwp9Owp2YXIgc2VsZWN0VG9vbHRpcEF4aXNSYW5nZVdpdGhSZXZlcnNlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1JhbmdlXSwgY29tYmluZUF4aXNSYW5nZVdpdGhSZXZlcnNlKTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzU2NhbGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEF4aXMsIHNlbGVjdFRvb2x0aXBBeGlzUmVhbFNjYWxlVHlwZSwgc2VsZWN0VG9vbHRpcEF4aXNEb21haW5JbmNsdWRpbmdOaWNlVGlja3MsIHNlbGVjdFRvb2x0aXBBeGlzUmFuZ2VXaXRoUmV2ZXJzZV0sIGNvbWJpbmVTY2FsZUZ1bmN0aW9uKTsKdmFyIHNlbGVjdFRvb2x0aXBEdXBsaWNhdGVEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEFsbFRvb2x0aXBBcHBsaWVkVmFsdWVzLCBzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNUeXBlXSwgY29tYmluZUR1cGxpY2F0ZURvbWFpbik7CnZhciBzZWxlY3RUb29sdGlwQ2F0ZWdvcmljYWxEb21haW4gPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdEFsbFRvb2x0aXBBcHBsaWVkVmFsdWVzLCBzZWxlY3RUb29sdGlwQXhpcywgc2VsZWN0VG9vbHRpcEF4aXNUeXBlXSwgY29tYmluZUNhdGVnb3JpY2FsRG9tYWluKTsKdmFyIGNvbWJpbmVUaWNrc09mVG9vbHRpcEF4aXMgPSAobGF5b3V0LCBheGlzLCByZWFsU2NhbGVUeXBlLCBzY2FsZSwgcmFuZ2U0LCBkdXBsaWNhdGVEb21haW4sIGNhdGVnb3JpY2FsRG9tYWluLCBheGlzVHlwZSkgPT4gewogIGlmICghYXhpcykgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIHsKICAgIHR5cGUKICB9ID0gYXhpczsKICB2YXIgaXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGxheW91dCwgYXhpc1R5cGUpOwogIGlmICghc2NhbGUpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBvZmZzZXRGb3JCYW5kID0gcmVhbFNjYWxlVHlwZSA9PT0gInNjYWxlQmFuZCIgJiYgc2NhbGUuYmFuZHdpZHRoID8gc2NhbGUuYmFuZHdpZHRoKCkgLyAyIDogMjsKICB2YXIgb2Zmc2V0ID0gdHlwZSA9PT0gImNhdGVnb3J5IiAmJiBzY2FsZS5iYW5kd2lkdGggPyBzY2FsZS5iYW5kd2lkdGgoKSAvIG9mZnNldEZvckJhbmQgOiAwOwogIG9mZnNldCA9IGF4aXNUeXBlID09PSAiYW5nbGVBeGlzIiAmJiByYW5nZTQgIT0gbnVsbCAmJiAocmFuZ2U0ID09PSBudWxsIHx8IHJhbmdlNCA9PT0gdm9pZCAwID8gdm9pZCAwIDogcmFuZ2U0Lmxlbmd0aCkgPj0gMiA/IG1hdGhTaWduKHJhbmdlNFswXSAtIHJhbmdlNFsxXSkgKiAyICogb2Zmc2V0IDogb2Zmc2V0OwogIGlmIChpc0NhdGVnb3JpY2FsICYmIGNhdGVnb3JpY2FsRG9tYWluKSB7CiAgICByZXR1cm4gY2F0ZWdvcmljYWxEb21haW4ubWFwKChlbnRyeSwgaW5kZXgpID0+ICh7CiAgICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgICAgdmFsdWU6IGVudHJ5LAogICAgICBpbmRleCwKICAgICAgb2Zmc2V0CiAgICB9KSk7CiAgfQogIHJldHVybiBzY2FsZS5kb21haW4oKS5tYXAoKGVudHJ5LCBpbmRleCkgPT4gKHsKICAgIGNvb3JkaW5hdGU6IHNjYWxlKGVudHJ5KSArIG9mZnNldCwKICAgIHZhbHVlOiBkdXBsaWNhdGVEb21haW4gPyBkdXBsaWNhdGVEb21haW5bZW50cnldIDogZW50cnksCiAgICBpbmRleCwKICAgIG9mZnNldAogIH0pKTsKfTsKdmFyIHNlbGVjdFRvb2x0aXBBeGlzVGlja3MgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFRvb2x0aXBBeGlzLCBzZWxlY3RUb29sdGlwQXhpc1JlYWxTY2FsZVR5cGUsIHNlbGVjdFRvb2x0aXBBeGlzU2NhbGUsIHNlbGVjdFRvb2x0aXBBeGlzUmFuZ2UsIHNlbGVjdFRvb2x0aXBEdXBsaWNhdGVEb21haW4sIHNlbGVjdFRvb2x0aXBDYXRlZ29yaWNhbERvbWFpbiwgc2VsZWN0VG9vbHRpcEF4aXNUeXBlXSwgY29tYmluZVRpY2tzT2ZUb29sdGlwQXhpcyk7CnZhciBzZWxlY3RUb29sdGlwRXZlbnRUeXBlMiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3REZWZhdWx0VG9vbHRpcEV2ZW50VHlwZSwgc2VsZWN0VmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcywgc2VsZWN0VG9vbHRpcFNldHRpbmdzXSwgKGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlLCB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGUsIHNldHRpbmdzKSA9PiBjb21iaW5lVG9vbHRpcEV2ZW50VHlwZShzZXR0aW5ncy5zaGFyZWQsIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlLCB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGUpKTsKdmFyIHNlbGVjdFRvb2x0aXBUcmlnZ2VyID0gKHN0YXRlKSA9PiBzdGF0ZS50b29sdGlwLnNldHRpbmdzLnRyaWdnZXI7CnZhciBzZWxlY3REZWZhdWx0SW5kZXggPSAoc3RhdGUpID0+IHN0YXRlLnRvb2x0aXAuc2V0dGluZ3MuZGVmYXVsdEluZGV4Owp2YXIgc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcFN0YXRlLCBzZWxlY3RUb29sdGlwRXZlbnRUeXBlMiwgc2VsZWN0VG9vbHRpcFRyaWdnZXIsIHNlbGVjdERlZmF1bHRJbmRleF0sIGNvbWJpbmVUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSk7CnZhciBzZWxlY3RBY3RpdmVUb29sdGlwSW5kZXggPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGUsIHNlbGVjdFRvb2x0aXBEaXNwbGF5ZWREYXRhLCBzZWxlY3RUb29sdGlwQXhpc0RhdGFLZXksIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluXSwgY29tYmluZUFjdGl2ZVRvb2x0aXBJbmRleCk7CnZhciBzZWxlY3RBY3RpdmVMYWJlbCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc1RpY2tzLCBzZWxlY3RBY3RpdmVUb29sdGlwSW5kZXhdLCBjb21iaW5lQWN0aXZlTGFiZWwpOwp2YXIgc2VsZWN0QWN0aXZlVG9vbHRpcERhdGFLZXkgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGVdLCAodG9vbHRpcEludGVyYWN0aW9uKSA9PiB7CiAgaWYgKCF0b29sdGlwSW50ZXJhY3Rpb24pIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiB0b29sdGlwSW50ZXJhY3Rpb24uZGF0YUtleTsKfSk7CnZhciBzZWxlY3RBY3RpdmVUb29sdGlwR3JhcGhpY2FsSXRlbUlkID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlXSwgKHRvb2x0aXBJbnRlcmFjdGlvbikgPT4gewogIGlmICghdG9vbHRpcEludGVyYWN0aW9uKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gdG9vbHRpcEludGVyYWN0aW9uLmdyYXBoaWNhbEl0ZW1JZDsKfSk7CnZhciBzZWxlY3RUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGF0ZSwgc2VsZWN0VG9vbHRpcEV2ZW50VHlwZTIsIHNlbGVjdFRvb2x0aXBUcmlnZ2VyLCBzZWxlY3REZWZhdWx0SW5kZXhdLCBjb21iaW5lVG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9ucyk7CnZhciBzZWxlY3RUb29sdGlwQ29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodCwgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFRvb2x0aXBBeGlzVGlja3MsIHNlbGVjdERlZmF1bHRJbmRleCwgc2VsZWN0VG9vbHRpcFBheWxvYWRDb25maWd1cmF0aW9ucywgc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlcl0sIGNvbWJpbmVDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4KTsKdmFyIHNlbGVjdEFjdGl2ZVRvb2x0aXBDb29yZGluYXRlID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLCBzZWxlY3RUb29sdGlwQ29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleF0sICh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSwgZGVmYXVsdEluZGV4Q29vcmRpbmF0ZSkgPT4gewogIGlmICh0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSAhPT0gbnVsbCAmJiB0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZSAhPT0gdm9pZCAwICYmIHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmNvb3JkaW5hdGUpIHsKICAgIHJldHVybiB0b29sdGlwSW50ZXJhY3Rpb25TdGF0ZS5jb29yZGluYXRlOwogIH0KICByZXR1cm4gZGVmYXVsdEluZGV4Q29vcmRpbmF0ZTsKfSk7CnZhciBzZWxlY3RJc1Rvb2x0aXBBY3RpdmUgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0VG9vbHRpcEludGVyYWN0aW9uU3RhdGVdLCAodG9vbHRpcEludGVyYWN0aW9uU3RhdGUpID0+IHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLmFjdGl2ZSk7CnZhciBzZWxlY3RBY3RpdmVUb29sdGlwUGF5bG9hZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zLCBzZWxlY3RBY3RpdmVUb29sdGlwSW5kZXgsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzLCBzZWxlY3RUb29sdGlwQXhpc0RhdGFLZXksIHNlbGVjdEFjdGl2ZUxhYmVsLCBzZWxlY3RUb29sdGlwUGF5bG9hZFNlYXJjaGVyLCBzZWxlY3RUb29sdGlwRXZlbnRUeXBlMl0sIGNvbWJpbmVUb29sdGlwUGF5bG9hZCk7CnZhciBzZWxlY3RBY3RpdmVUb29sdGlwRGF0YVBvaW50cyA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBY3RpdmVUb29sdGlwUGF5bG9hZF0sIChwYXlsb2FkKSA9PiB7CiAgaWYgKHBheWxvYWQgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGRhdGFQb2ludHMgPSBwYXlsb2FkLm1hcCgocCkgPT4gcC5wYXlsb2FkKS5maWx0ZXIoKHApID0+IHAgIT0gbnVsbCk7CiAgcmV0dXJuIEFycmF5LmZyb20obmV3IFNldChkYXRhUG9pbnRzKSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGV4dC91c2VUb29sdGlwQXhpcy5qcwpmdW5jdGlvbiBvd25LZXlzMTYoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxNihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czE2KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxNihlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxNihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTYoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxNihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxNih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxNih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxNih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIHVzZVRvb2x0aXBBeGlzID0gKCkgPT4gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0VG9vbHRpcEF4aXMpOwp2YXIgdXNlVG9vbHRpcEF4aXNCYW5kU2l6ZSA9ICgpID0+IHsKICB2YXIgdG9vbHRpcEF4aXMgPSB1c2VUb29sdGlwQXhpcygpOwogIHZhciB0b29sdGlwVGlja3MgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RUb29sdGlwQXhpc1RpY2tzKTsKICB2YXIgdG9vbHRpcEF4aXNTY2FsZSA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFRvb2x0aXBBeGlzU2NhbGUpOwogIGlmICghdG9vbHRpcEF4aXMgfHwgIXRvb2x0aXBBeGlzU2NhbGUpIHsKICAgIHJldHVybiBnZXRCYW5kU2l6ZU9mQXhpcyh2b2lkIDAsIHRvb2x0aXBUaWNrcyk7CiAgfQogIHJldHVybiBnZXRCYW5kU2l6ZU9mQXhpcyhfb2JqZWN0U3ByZWFkMTYoX29iamVjdFNwcmVhZDE2KHt9LCB0b29sdGlwQXhpcyksIHt9LCB7CiAgICBzY2FsZTogdG9vbHRpcEF4aXNTY2FsZQogIH0pLCB0b29sdGlwVGlja3MpOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdG9ycy5qcwp2YXIgaW1wb3J0X3NvcnRCeTQgPSBfX3RvRVNNKHJlcXVpcmVfc29ydEJ5MigpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZ2V0QWN0aXZlQ29vcmRpbmF0ZS5qcwpmdW5jdGlvbiBvd25LZXlzMTcoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQxNyhlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czE3KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkxNyhlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMxNyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MTcoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkxNyhyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkxNyh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUxNyh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUxNyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGdldEFjdGl2ZUNhcnRlc2lhbkNvb3JkaW5hdGUgPSAobGF5b3V0LCB0b29sdGlwVGlja3MsIGFjdGl2ZUluZGV4LCBwb2ludGVyKSA9PiB7CiAgdmFyIGVudHJ5ID0gdG9vbHRpcFRpY2tzLmZpbmQoKHRpY2spID0+IHRpY2sgJiYgdGljay5pbmRleCA9PT0gYWN0aXZlSW5kZXgpOwogIGlmIChlbnRyeSkgewogICAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogZW50cnkuY29vcmRpbmF0ZSwKICAgICAgICB5OiBwb2ludGVyLmNoYXJ0WQogICAgICB9OwogICAgfQogICAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgICByZXR1cm4gewogICAgICAgIHg6IHBvaW50ZXIuY2hhcnRYLAogICAgICAgIHk6IGVudHJ5LmNvb3JkaW5hdGUKICAgICAgfTsKICAgIH0KICB9CiAgcmV0dXJuIHsKICAgIHg6IDAsCiAgICB5OiAwCiAgfTsKfTsKdmFyIGdldEFjdGl2ZVBvbGFyQ29vcmRpbmF0ZSA9IChsYXlvdXQsIHRvb2x0aXBUaWNrcywgYWN0aXZlSW5kZXgsIHJhbmdlT2JqKSA9PiB7CiAgdmFyIGVudHJ5ID0gdG9vbHRpcFRpY2tzLmZpbmQoKHRpY2spID0+IHRpY2sgJiYgdGljay5pbmRleCA9PT0gYWN0aXZlSW5kZXgpOwogIGlmIChlbnRyeSkgewogICAgaWYgKGxheW91dCA9PT0gImNlbnRyaWMiKSB7CiAgICAgIHZhciBfYW5nbGUgPSBlbnRyeS5jb29yZGluYXRlOwogICAgICB2YXIgewogICAgICAgIHJhZGl1czogX3JhZGl1cwogICAgICB9ID0gcmFuZ2VPYmo7CiAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMTcoX29iamVjdFNwcmVhZDE3KF9vYmplY3RTcHJlYWQxNyh7fSwgcmFuZ2VPYmopLCBwb2xhclRvQ2FydGVzaWFuKHJhbmdlT2JqLmN4LCByYW5nZU9iai5jeSwgX3JhZGl1cywgX2FuZ2xlKSksIHt9LCB7CiAgICAgICAgYW5nbGU6IF9hbmdsZSwKICAgICAgICByYWRpdXM6IF9yYWRpdXMKICAgICAgfSk7CiAgICB9CiAgICB2YXIgcmFkaXVzID0gZW50cnkuY29vcmRpbmF0ZTsKICAgIHZhciB7CiAgICAgIGFuZ2xlCiAgICB9ID0gcmFuZ2VPYmo7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDE3KF9vYmplY3RTcHJlYWQxNyhfb2JqZWN0U3ByZWFkMTcoe30sIHJhbmdlT2JqKSwgcG9sYXJUb0NhcnRlc2lhbihyYW5nZU9iai5jeCwgcmFuZ2VPYmouY3ksIHJhZGl1cywgYW5nbGUpKSwge30sIHsKICAgICAgYW5nbGUsCiAgICAgIHJhZGl1cwogICAgfSk7CiAgfQogIHJldHVybiB7CiAgICBhbmdsZTogMCwKICAgIGNsb2NrV2lzZTogZmFsc2UsCiAgICBjeDogMCwKICAgIGN5OiAwLAogICAgZW5kQW5nbGU6IDAsCiAgICBpbm5lclJhZGl1czogMCwKICAgIG91dGVyUmFkaXVzOiAwLAogICAgcmFkaXVzOiAwLAogICAgc3RhcnRBbmdsZTogMCwKICAgIHg6IDAsCiAgICB5OiAwCiAgfTsKfTsKZnVuY3Rpb24gaXNJbkNhcnRlc2lhblJhbmdlKHBvaW50ZXIsIG9mZnNldCkgewogIHZhciB7CiAgICBjaGFydFg6IHgyLAogICAgY2hhcnRZOiB5MgogIH0gPSBwb2ludGVyOwogIHJldHVybiB4MiA+PSBvZmZzZXQubGVmdCAmJiB4MiA8PSBvZmZzZXQubGVmdCArIG9mZnNldC53aWR0aCAmJiB5MiA+PSBvZmZzZXQudG9wICYmIHkyIDw9IG9mZnNldC50b3AgKyBvZmZzZXQuaGVpZ2h0Owp9CnZhciBjYWxjdWxhdGVBY3RpdmVUaWNrSW5kZXggPSAoY29vcmRpbmF0ZSwgdGlja3MyLCB1bnNvcnRlZFRpY2tzLCBheGlzVHlwZSwgcmFuZ2U0KSA9PiB7CiAgdmFyIF90aWNrcyRsZW5ndGg7CiAgdmFyIGluZGV4ID0gLTE7CiAgdmFyIGxlbiA9IChfdGlja3MkbGVuZ3RoID0gdGlja3MyID09PSBudWxsIHx8IHRpY2tzMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogdGlja3MyLmxlbmd0aCkgIT09IG51bGwgJiYgX3RpY2tzJGxlbmd0aCAhPT0gdm9pZCAwID8gX3RpY2tzJGxlbmd0aCA6IDA7CiAgaWYgKGxlbiA8PSAxIHx8IGNvb3JkaW5hdGUgPT0gbnVsbCkgewogICAgcmV0dXJuIDA7CiAgfQogIGlmIChheGlzVHlwZSA9PT0gImFuZ2xlQXhpcyIgJiYgcmFuZ2U0ICE9IG51bGwgJiYgTWF0aC5hYnMoTWF0aC5hYnMocmFuZ2U0WzFdIC0gcmFuZ2U0WzBdKSAtIDM2MCkgPD0gMWUtNikgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICB2YXIgYmVmb3JlID0gaSA+IDAgPyB1bnNvcnRlZFRpY2tzW2kgLSAxXS5jb29yZGluYXRlIDogdW5zb3J0ZWRUaWNrc1tsZW4gLSAxXS5jb29yZGluYXRlOwogICAgICB2YXIgY3VyID0gdW5zb3J0ZWRUaWNrc1tpXS5jb29yZGluYXRlOwogICAgICB2YXIgYWZ0ZXIgPSBpID49IGxlbiAtIDEgPyB1bnNvcnRlZFRpY2tzWzBdLmNvb3JkaW5hdGUgOiB1bnNvcnRlZFRpY2tzW2kgKyAxXS5jb29yZGluYXRlOwogICAgICB2YXIgc2FtZURpcmVjdGlvbkNvb3JkID0gdm9pZCAwOwogICAgICBpZiAobWF0aFNpZ24oY3VyIC0gYmVmb3JlKSAhPT0gbWF0aFNpZ24oYWZ0ZXIgLSBjdXIpKSB7CiAgICAgICAgdmFyIGRpZmZJbnRlcnZhbCA9IFtdOwogICAgICAgIGlmIChtYXRoU2lnbihhZnRlciAtIGN1cikgPT09IG1hdGhTaWduKHJhbmdlNFsxXSAtIHJhbmdlNFswXSkpIHsKICAgICAgICAgIHNhbWVEaXJlY3Rpb25Db29yZCA9IGFmdGVyOwogICAgICAgICAgdmFyIGN1ckluUmFuZ2UgPSBjdXIgKyByYW5nZTRbMV0gLSByYW5nZTRbMF07CiAgICAgICAgICBkaWZmSW50ZXJ2YWxbMF0gPSBNYXRoLm1pbihjdXJJblJhbmdlLCAoY3VySW5SYW5nZSArIGJlZm9yZSkgLyAyKTsKICAgICAgICAgIGRpZmZJbnRlcnZhbFsxXSA9IE1hdGgubWF4KGN1ckluUmFuZ2UsIChjdXJJblJhbmdlICsgYmVmb3JlKSAvIDIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzYW1lRGlyZWN0aW9uQ29vcmQgPSBiZWZvcmU7CiAgICAgICAgICB2YXIgYWZ0ZXJJblJhbmdlID0gYWZ0ZXIgKyByYW5nZTRbMV0gLSByYW5nZTRbMF07CiAgICAgICAgICBkaWZmSW50ZXJ2YWxbMF0gPSBNYXRoLm1pbihjdXIsIChhZnRlckluUmFuZ2UgKyBjdXIpIC8gMik7CiAgICAgICAgICBkaWZmSW50ZXJ2YWxbMV0gPSBNYXRoLm1heChjdXIsIChhZnRlckluUmFuZ2UgKyBjdXIpIC8gMik7CiAgICAgICAgfQogICAgICAgIHZhciBzYW1lSW50ZXJ2YWwgPSBbTWF0aC5taW4oY3VyLCAoc2FtZURpcmVjdGlvbkNvb3JkICsgY3VyKSAvIDIpLCBNYXRoLm1heChjdXIsIChzYW1lRGlyZWN0aW9uQ29vcmQgKyBjdXIpIC8gMildOwogICAgICAgIGlmIChjb29yZGluYXRlID4gc2FtZUludGVydmFsWzBdICYmIGNvb3JkaW5hdGUgPD0gc2FtZUludGVydmFsWzFdIHx8IGNvb3JkaW5hdGUgPj0gZGlmZkludGVydmFsWzBdICYmIGNvb3JkaW5hdGUgPD0gZGlmZkludGVydmFsWzFdKSB7CiAgICAgICAgICAoewogICAgICAgICAgICBpbmRleAogICAgICAgICAgfSA9IHVuc29ydGVkVGlja3NbaV0pOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZhciBtaW5WYWx1ZSA9IE1hdGgubWluKGJlZm9yZSwgYWZ0ZXIpOwogICAgICAgIHZhciBtYXhWYWx1ZSA9IE1hdGgubWF4KGJlZm9yZSwgYWZ0ZXIpOwogICAgICAgIGlmIChjb29yZGluYXRlID4gKG1pblZhbHVlICsgY3VyKSAvIDIgJiYgY29vcmRpbmF0ZSA8PSAobWF4VmFsdWUgKyBjdXIpIC8gMikgewogICAgICAgICAgKHsKICAgICAgICAgICAgaW5kZXgKICAgICAgICAgIH0gPSB1bnNvcnRlZFRpY2tzW2ldKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0gZWxzZSBpZiAodGlja3MyKSB7CiAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgbGVuOyBfaSsrKSB7CiAgICAgIGlmIChfaSA9PT0gMCAmJiBjb29yZGluYXRlIDw9ICh0aWNrczJbX2ldLmNvb3JkaW5hdGUgKyB0aWNrczJbX2kgKyAxXS5jb29yZGluYXRlKSAvIDIgfHwgX2kgPiAwICYmIF9pIDwgbGVuIC0gMSAmJiBjb29yZGluYXRlID4gKHRpY2tzMltfaV0uY29vcmRpbmF0ZSArIHRpY2tzMltfaSAtIDFdLmNvb3JkaW5hdGUpIC8gMiAmJiBjb29yZGluYXRlIDw9ICh0aWNrczJbX2ldLmNvb3JkaW5hdGUgKyB0aWNrczJbX2kgKyAxXS5jb29yZGluYXRlKSAvIDIgfHwgX2kgPT09IGxlbiAtIDEgJiYgY29vcmRpbmF0ZSA+ICh0aWNrczJbX2ldLmNvb3JkaW5hdGUgKyB0aWNrczJbX2kgLSAxXS5jb29yZGluYXRlKSAvIDIpIHsKICAgICAgICAoewogICAgICAgICAgaW5kZXgKICAgICAgICB9ID0gdGlja3MyW19pXSk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIGluZGV4Owp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdG9ycy5qcwp2YXIgdXNlQ2hhcnROYW1lID0gKCkgPT4gewogIHJldHVybiB1c2VBcHBTZWxlY3RvcihzZWxlY3RDaGFydE5hbWUpOwp9Owp2YXIgcGlja1Rvb2x0aXBFdmVudFR5cGUgPSAoX3N0YXRlLCB0b29sdGlwRXZlbnRUeXBlKSA9PiB0b29sdGlwRXZlbnRUeXBlOwp2YXIgcGlja1RyaWdnZXIgPSAoX3N0YXRlLCBfdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlcikgPT4gdHJpZ2dlcjsKdmFyIHBpY2tEZWZhdWx0SW5kZXggPSAoX3N0YXRlLCBfdG9vbHRpcEV2ZW50VHlwZSwgX3RyaWdnZXIsIGRlZmF1bHRJbmRleCkgPT4gZGVmYXVsdEluZGV4Owp2YXIgc2VsZWN0T3JkZXJlZFRvb2x0aXBUaWNrcyA9IGNyZWF0ZVNlbGVjdG9yKHNlbGVjdFRvb2x0aXBBeGlzVGlja3MsICh0aWNrczIpID0+ICgwLCBpbXBvcnRfc29ydEJ5NC5kZWZhdWx0KSh0aWNrczIsIChvKSA9PiBvLmNvb3JkaW5hdGUpKTsKdmFyIHNlbGVjdFRvb2x0aXBJbnRlcmFjdGlvblN0YXRlMiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwU3RhdGUsIHBpY2tUb29sdGlwRXZlbnRUeXBlLCBwaWNrVHJpZ2dlciwgcGlja0RlZmF1bHRJbmRleF0sIGNvbWJpbmVUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZSk7CnZhciBzZWxlY3RBY3RpdmVJbmRleCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZTIsIHNlbGVjdFRvb2x0aXBEaXNwbGF5ZWREYXRhLCBzZWxlY3RUb29sdGlwQXhpc0RhdGFLZXksIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluXSwgY29tYmluZUFjdGl2ZVRvb2x0aXBJbmRleCk7CnZhciBzZWxlY3RUb29sdGlwRGF0YUtleSA9IChzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlcikgPT4gewogIGlmICh0b29sdGlwRXZlbnRUeXBlID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB0b29sdGlwU3RhdGUgPSBzZWxlY3RUb29sdGlwU3RhdGUoc3RhdGUpOwogIGlmICh0b29sdGlwRXZlbnRUeXBlID09PSAiYXhpcyIpIHsKICAgIGlmICh0cmlnZ2VyID09PSAiaG92ZXIiKSB7CiAgICAgIHJldHVybiB0b29sdGlwU3RhdGUuYXhpc0ludGVyYWN0aW9uLmhvdmVyLmRhdGFLZXk7CiAgICB9CiAgICByZXR1cm4gdG9vbHRpcFN0YXRlLmF4aXNJbnRlcmFjdGlvbi5jbGljay5kYXRhS2V5OwogIH0KICBpZiAodHJpZ2dlciA9PT0gImhvdmVyIikgewogICAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5pdGVtSW50ZXJhY3Rpb24uaG92ZXIuZGF0YUtleTsKICB9CiAgcmV0dXJuIHRvb2x0aXBTdGF0ZS5pdGVtSW50ZXJhY3Rpb24uY2xpY2suZGF0YUtleTsKfTsKdmFyIHNlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMyID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFRvb2x0aXBTdGF0ZSwgcGlja1Rvb2x0aXBFdmVudFR5cGUsIHBpY2tUcmlnZ2VyLCBwaWNrRGVmYXVsdEluZGV4XSwgY29tYmluZVRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMpOwp2YXIgc2VsZWN0Q29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydFdpZHRoLCBzZWxlY3RDaGFydEhlaWdodCwgc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdENoYXJ0T2Zmc2V0SW50ZXJuYWwsIHNlbGVjdFRvb2x0aXBBeGlzVGlja3MsIHBpY2tEZWZhdWx0SW5kZXgsIHNlbGVjdFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbnMyLCBzZWxlY3RUb29sdGlwUGF5bG9hZFNlYXJjaGVyXSwgY29tYmluZUNvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXgpOwp2YXIgc2VsZWN0QWN0aXZlQ29vcmRpbmF0ZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZTIsIHNlbGVjdENvb3JkaW5hdGVGb3JEZWZhdWx0SW5kZXhdLCAodG9vbHRpcEludGVyYWN0aW9uU3RhdGUsIGRlZmF1bHRJbmRleENvb3JkaW5hdGUpID0+IHsKICB2YXIgX3Rvb2x0aXBJbnRlcmFjdGlvblN0OwogIHJldHVybiAoX3Rvb2x0aXBJbnRlcmFjdGlvblN0ID0gdG9vbHRpcEludGVyYWN0aW9uU3RhdGUuY29vcmRpbmF0ZSkgIT09IG51bGwgJiYgX3Rvb2x0aXBJbnRlcmFjdGlvblN0ICE9PSB2b2lkIDAgPyBfdG9vbHRpcEludGVyYWN0aW9uU3QgOiBkZWZhdWx0SW5kZXhDb29yZGluYXRlOwp9KTsKdmFyIHNlbGVjdEFjdGl2ZUxhYmVsMiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwQXhpc1RpY2tzLCBzZWxlY3RBY3RpdmVJbmRleF0sIGNvbWJpbmVBY3RpdmVMYWJlbCk7CnZhciBzZWxlY3RUb29sdGlwUGF5bG9hZCA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb25zMiwgc2VsZWN0QWN0aXZlSW5kZXgsIHNlbGVjdENoYXJ0RGF0YVdpdGhJbmRleGVzLCBzZWxlY3RUb29sdGlwQXhpc0RhdGFLZXksIHNlbGVjdEFjdGl2ZUxhYmVsMiwgc2VsZWN0VG9vbHRpcFBheWxvYWRTZWFyY2hlciwgcGlja1Rvb2x0aXBFdmVudFR5cGVdLCBjb21iaW5lVG9vbHRpcFBheWxvYWQpOwp2YXIgc2VsZWN0SXNUb29sdGlwQWN0aXZlMiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwSW50ZXJhY3Rpb25TdGF0ZTIsIHNlbGVjdEFjdGl2ZUluZGV4XSwgKHRvb2x0aXBJbnRlcmFjdGlvblN0YXRlLCBhY3RpdmVJbmRleCkgPT4gewogIHJldHVybiB7CiAgICBpc0FjdGl2ZTogdG9vbHRpcEludGVyYWN0aW9uU3RhdGUuYWN0aXZlICYmIGFjdGl2ZUluZGV4ICE9IG51bGwsCiAgICBhY3RpdmVJbmRleAogIH07Cn0pOwp2YXIgY29tYmluZUFjdGl2ZUNhcnRlc2lhblByb3BzID0gKGNoYXJ0RXZlbnQsIGxheW91dCwgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlLCB0b29sdGlwVGlja3MsIG9yZGVyZWRUb29sdGlwVGlja3MsIG9mZnNldCkgPT4gewogIGlmICghY2hhcnRFdmVudCB8fCAhdG9vbHRpcEF4aXNUeXBlIHx8ICF0b29sdGlwQXhpc1JhbmdlIHx8ICF0b29sdGlwVGlja3MpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIGlmICghaXNJbkNhcnRlc2lhblJhbmdlKGNoYXJ0RXZlbnQsIG9mZnNldCkpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBwb3MgPSBjYWxjdWxhdGVDYXJ0ZXNpYW5Ub29sdGlwUG9zKGNoYXJ0RXZlbnQsIGxheW91dCk7CiAgdmFyIGFjdGl2ZUluZGV4ID0gY2FsY3VsYXRlQWN0aXZlVGlja0luZGV4KHBvcywgb3JkZXJlZFRvb2x0aXBUaWNrcywgdG9vbHRpcFRpY2tzLCB0b29sdGlwQXhpc1R5cGUsIHRvb2x0aXBBeGlzUmFuZ2UpOwogIHZhciBhY3RpdmVDb29yZGluYXRlID0gZ2V0QWN0aXZlQ2FydGVzaWFuQ29vcmRpbmF0ZShsYXlvdXQsIHRvb2x0aXBUaWNrcywgYWN0aXZlSW5kZXgsIGNoYXJ0RXZlbnQpOwogIHJldHVybiB7CiAgICBhY3RpdmVJbmRleDogU3RyaW5nKGFjdGl2ZUluZGV4KSwKICAgIGFjdGl2ZUNvb3JkaW5hdGUKICB9Owp9Owp2YXIgY29tYmluZUFjdGl2ZVBvbGFyUHJvcHMgPSAoY2hhcnRFdmVudCwgbGF5b3V0LCBwb2xhclZpZXdCb3gsIHRvb2x0aXBBeGlzVHlwZSwgdG9vbHRpcEF4aXNSYW5nZSwgdG9vbHRpcFRpY2tzLCBvcmRlcmVkVG9vbHRpcFRpY2tzKSA9PiB7CiAgaWYgKCFjaGFydEV2ZW50IHx8ICF0b29sdGlwQXhpc1R5cGUgfHwgIXRvb2x0aXBBeGlzUmFuZ2UgfHwgIXRvb2x0aXBUaWNrcyB8fCAhcG9sYXJWaWV3Qm94KSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgcmFuZ2VPYmogPSBpblJhbmdlT2ZTZWN0b3IoY2hhcnRFdmVudCwgcG9sYXJWaWV3Qm94KTsKICBpZiAoIXJhbmdlT2JqKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgcG9zID0gY2FsY3VsYXRlUG9sYXJUb29sdGlwUG9zKHJhbmdlT2JqLCBsYXlvdXQpOwogIHZhciBhY3RpdmVJbmRleCA9IGNhbGN1bGF0ZUFjdGl2ZVRpY2tJbmRleChwb3MsIG9yZGVyZWRUb29sdGlwVGlja3MsIHRvb2x0aXBUaWNrcywgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlKTsKICB2YXIgYWN0aXZlQ29vcmRpbmF0ZSA9IGdldEFjdGl2ZVBvbGFyQ29vcmRpbmF0ZShsYXlvdXQsIHRvb2x0aXBUaWNrcywgYWN0aXZlSW5kZXgsIHJhbmdlT2JqKTsKICByZXR1cm4gewogICAgYWN0aXZlSW5kZXg6IFN0cmluZyhhY3RpdmVJbmRleCksCiAgICBhY3RpdmVDb29yZGluYXRlCiAgfTsKfTsKdmFyIGNvbWJpbmVBY3RpdmVQcm9wcyA9IChjaGFydEV2ZW50LCBsYXlvdXQsIHBvbGFyVmlld0JveCwgdG9vbHRpcEF4aXNUeXBlLCB0b29sdGlwQXhpc1JhbmdlLCB0b29sdGlwVGlja3MsIG9yZGVyZWRUb29sdGlwVGlja3MsIG9mZnNldCkgPT4gewogIGlmICghY2hhcnRFdmVudCB8fCAhbGF5b3V0IHx8ICF0b29sdGlwQXhpc1R5cGUgfHwgIXRvb2x0aXBBeGlzUmFuZ2UgfHwgIXRvb2x0aXBUaWNrcykgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgaWYgKGxheW91dCA9PT0gImhvcml6b250YWwiIHx8IGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgcmV0dXJuIGNvbWJpbmVBY3RpdmVDYXJ0ZXNpYW5Qcm9wcyhjaGFydEV2ZW50LCBsYXlvdXQsIHRvb2x0aXBBeGlzVHlwZSwgdG9vbHRpcEF4aXNSYW5nZSwgdG9vbHRpcFRpY2tzLCBvcmRlcmVkVG9vbHRpcFRpY2tzLCBvZmZzZXQpOwogIH0KICByZXR1cm4gY29tYmluZUFjdGl2ZVBvbGFyUHJvcHMoY2hhcnRFdmVudCwgbGF5b3V0LCBwb2xhclZpZXdCb3gsIHRvb2x0aXBBeGlzVHlwZSwgdG9vbHRpcEF4aXNSYW5nZSwgdG9vbHRpcFRpY2tzLCBvcmRlcmVkVG9vbHRpcFRpY2tzKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3pJbmRleC9aSW5kZXhMYXllci5qcwp2YXIgaW1wb3J0X3JlYWN0MjAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3RfZG9tID0gX190b0VTTShyZXF1aXJlX3JlYWN0X2RvbSgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3pJbmRleC96SW5kZXhTZWxlY3RvcnMuanMKdmFyIHNlbGVjdFpJbmRleFBvcnRhbElkID0gY3JlYXRlU2VsZWN0b3IoKHN0YXRlKSA9PiBzdGF0ZS56SW5kZXguekluZGV4TWFwLCAoXywgekluZGV4KSA9PiB6SW5kZXgsIChfLCBfekluZGV4LCBpc1Bhbm9yYW1hKSA9PiBpc1Bhbm9yYW1hLCAoekluZGV4TWFwLCB6SW5kZXgsIGlzUGFub3JhbWEpID0+IHsKICBpZiAoekluZGV4ID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBlbnRyeSA9IHpJbmRleE1hcFt6SW5kZXhdOwogIGlmIChlbnRyeSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICBpZiAoaXNQYW5vcmFtYSkgewogICAgcmV0dXJuIGVudHJ5LnBhbm9yYW1hRWxlbWVudElkOwogIH0KICByZXR1cm4gZW50cnkuZWxlbWVudElkOwp9KTsKdmFyIHNlbGVjdEFsbFJlZ2lzdGVyZWRaSW5kZXhlcyA9IGNyZWF0ZVNlbGVjdG9yKChzdGF0ZSkgPT4gc3RhdGUuekluZGV4LnpJbmRleE1hcCwgKHpJbmRleE1hcCkgPT4gewogIHZhciBhbGxOdW1iZXJzID0gT2JqZWN0LmtleXMoekluZGV4TWFwKS5tYXAoKHpJbmRleFN0cikgPT4gcGFyc2VJbnQoekluZGV4U3RyLCAxMCkpLmNvbmNhdChPYmplY3QudmFsdWVzKERlZmF1bHRaSW5kZXhlcykpOwogIHZhciB1bmlxdWVOdW1iZXJzID0gQXJyYXkuZnJvbShuZXcgU2V0KGFsbE51bWJlcnMpKTsKICByZXR1cm4gdW5pcXVlTnVtYmVycy5zb3J0KChhLCBiKSA9PiBhIC0gYik7Cn0sIHsKICBtZW1vaXplT3B0aW9uczogewogICAgcmVzdWx0RXF1YWxpdHlDaGVjazogYXJyYXlDb250ZW50c0FyZUVxdWFsQ2hlY2sKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvekluZGV4U2xpY2UuanMKZnVuY3Rpb24gb3duS2V5czE4KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTgoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxOChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTgoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTgoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTE4KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTgocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTgodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTgodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTgodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBzZWVkID0ge307CnZhciBpbml0aWFsU3RhdGU0ID0gewogIHpJbmRleE1hcDogT2JqZWN0LnZhbHVlcyhEZWZhdWx0WkluZGV4ZXMpLnJlZHVjZSgoYWNjLCBjdXJyZW50MykgPT4gX29iamVjdFNwcmVhZDE4KF9vYmplY3RTcHJlYWQxOCh7fSwgYWNjKSwge30sIHsKICAgIFtjdXJyZW50M106IHsKICAgICAgZWxlbWVudElkOiB2b2lkIDAsCiAgICAgIHBhbm9yYW1hRWxlbWVudElkOiB2b2lkIDAsCiAgICAgIGNvbnN1bWVyczogMAogICAgfQogIH0pLCBzZWVkKQp9Owp2YXIgZGVmYXVsdFpJbmRleFNldCA9IG5ldyBTZXQoT2JqZWN0LnZhbHVlcyhEZWZhdWx0WkluZGV4ZXMpKTsKZnVuY3Rpb24gaXNEZWZhdWx0WkluZGV4KHpJbmRleCkgewogIHJldHVybiBkZWZhdWx0WkluZGV4U2V0Lmhhcyh6SW5kZXgpOwp9CnZhciB6SW5kZXhTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiekluZGV4IiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTQsCiAgcmVkdWNlcnM6IHsKICAgIHJlZ2lzdGVyWkluZGV4UG9ydGFsOiB7CiAgICAgIHJlZHVjZXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHpJbmRleAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUuekluZGV4TWFwW3pJbmRleF0pIHsKICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLmNvbnN1bWVycyArPSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XSA9IHsKICAgICAgICAgICAgY29uc3VtZXJzOiAxLAogICAgICAgICAgICBlbGVtZW50SWQ6IHZvaWQgMCwKICAgICAgICAgICAgcGFub3JhbWFFbGVtZW50SWQ6IHZvaWQgMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgdW5yZWdpc3RlclpJbmRleFBvcnRhbDogewogICAgICByZWR1Y2VyOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICAgIHZhciB7CiAgICAgICAgICB6SW5kZXgKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgaWYgKHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdKSB7CiAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XS5jb25zdW1lcnMgLT0gMTsKICAgICAgICAgIGlmIChzdGF0ZS56SW5kZXhNYXBbekluZGV4XS5jb25zdW1lcnMgPD0gMCAmJiAhaXNEZWZhdWx0WkluZGV4KHpJbmRleCkpIHsKICAgICAgICAgICAgZGVsZXRlIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZWdpc3RlclpJbmRleFBvcnRhbElkOiB7CiAgICAgIHJlZHVjZXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHpJbmRleCwKICAgICAgICAgIGVsZW1lbnRJZCwKICAgICAgICAgIGlzUGFub3JhbWEKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgaWYgKHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdKSB7CiAgICAgICAgICBpZiAoaXNQYW5vcmFtYSkgewogICAgICAgICAgICBzdGF0ZS56SW5kZXhNYXBbekluZGV4XS5wYW5vcmFtYUVsZW1lbnRJZCA9IGVsZW1lbnRJZDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLmVsZW1lbnRJZCA9IGVsZW1lbnRJZDsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0gPSB7CiAgICAgICAgICAgIGNvbnN1bWVyczogMCwKICAgICAgICAgICAgZWxlbWVudElkOiBpc1Bhbm9yYW1hID8gdm9pZCAwIDogZWxlbWVudElkLAogICAgICAgICAgICBwYW5vcmFtYUVsZW1lbnRJZDogaXNQYW5vcmFtYSA/IGVsZW1lbnRJZCA6IHZvaWQgMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgdW5yZWdpc3RlclpJbmRleFBvcnRhbElkOiB7CiAgICAgIHJlZHVjZXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHpJbmRleAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUuekluZGV4TWFwW3pJbmRleF0pIHsKICAgICAgICAgIGlmIChhY3Rpb24ucGF5bG9hZC5pc1Bhbm9yYW1hKSB7CiAgICAgICAgICAgIHN0YXRlLnpJbmRleE1hcFt6SW5kZXhdLnBhbm9yYW1hRWxlbWVudElkID0gdm9pZCAwOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhdGUuekluZGV4TWFwW3pJbmRleF0uZWxlbWVudElkID0gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0KICB9Cn0pOwp2YXIgewogIHJlZ2lzdGVyWkluZGV4UG9ydGFsLAogIHVucmVnaXN0ZXJaSW5kZXhQb3J0YWwsCiAgcmVnaXN0ZXJaSW5kZXhQb3J0YWxJZCwKICB1bnJlZ2lzdGVyWkluZGV4UG9ydGFsSWQKfSA9IHpJbmRleFNsaWNlLmFjdGlvbnM7CnZhciB6SW5kZXhSZWR1Y2VyID0gekluZGV4U2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3pJbmRleC9aSW5kZXhMYXllci5qcwpmdW5jdGlvbiBaSW5kZXhMYXllcihfcmVmMikgewogIHZhciB7CiAgICB6SW5kZXgsCiAgICBjaGlsZHJlbgogIH0gPSBfcmVmMjsKICB2YXIgaXNJbkNoYXJ0Q29udGV4dCA9IHVzZUlzSW5DaGFydENvbnRleHQoKTsKICB2YXIgc2hvdWxkUmVuZGVySW5Qb3J0YWwgPSBpc0luQ2hhcnRDb250ZXh0ICYmIHpJbmRleCAhPT0gdm9pZCAwICYmIHpJbmRleCAhPT0gMDsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogICgwLCBpbXBvcnRfcmVhY3QyMC51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIGlmICghc2hvdWxkUmVuZGVySW5Qb3J0YWwpIHsKICAgICAgcmV0dXJuIG5vb3A7CiAgICB9CiAgICBkaXNwYXRjaChyZWdpc3RlclpJbmRleFBvcnRhbCh7CiAgICAgIHpJbmRleAogICAgfSkpOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgZGlzcGF0Y2godW5yZWdpc3RlclpJbmRleFBvcnRhbCh7CiAgICAgICAgekluZGV4CiAgICAgIH0pKTsKICAgIH07CiAgfSwgW2Rpc3BhdGNoLCB6SW5kZXgsIHNob3VsZFJlbmRlckluUG9ydGFsXSk7CiAgdmFyIHBvcnRhbElkID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RaSW5kZXhQb3J0YWxJZChzdGF0ZSwgekluZGV4LCBpc1Bhbm9yYW1hKSk7CiAgaWYgKCFzaG91bGRSZW5kZXJJblBvcnRhbCkgewogICAgcmV0dXJuIGNoaWxkcmVuOwogIH0KICBpZiAoIXBvcnRhbElkKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHpJbmRleFBvcnRhbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHBvcnRhbElkKTsKICBpZiAoekluZGV4UG9ydGFsKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3RfZG9tLmNyZWF0ZVBvcnRhbCkoY2hpbGRyZW4sIHpJbmRleFBvcnRhbCk7CiAgfQogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvQ3Vyc29yLmpzCmZ1bmN0aW9uIF9leHRlbmRzOSgpIHsKICByZXR1cm4gX2V4dGVuZHM5ID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHM5LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gb3duS2V5czE5KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMTkoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMxOShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MTkoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMTkoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTE5KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MTkocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MTkodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMTkodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMTkodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIFJlbmRlckN1cnNvcihfcmVmMikgewogIHZhciB7CiAgICBjdXJzb3IsCiAgICBjdXJzb3JDb21wLAogICAgY3Vyc29yUHJvcHMKICB9ID0gX3JlZjI7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjEuaXNWYWxpZEVsZW1lbnQpKGN1cnNvcikpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDIxLmNsb25lRWxlbWVudCkoY3Vyc29yLCBjdXJzb3JQcm9wcyk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDIxLmNyZWF0ZUVsZW1lbnQpKGN1cnNvckNvbXAsIGN1cnNvclByb3BzKTsKfQpmdW5jdGlvbiBDdXJzb3JJbnRlcm5hbChwcm9wcykgewogIHZhciBfcHJvcHMkekluZGV4OwogIHZhciB7CiAgICBjb29yZGluYXRlLAogICAgcGF5bG9hZCwKICAgIGluZGV4LAogICAgb2Zmc2V0LAogICAgdG9vbHRpcEF4aXNCYW5kU2l6ZSwKICAgIGxheW91dCwKICAgIGN1cnNvciwKICAgIHRvb2x0aXBFdmVudFR5cGUsCiAgICBjaGFydE5hbWUKICB9ID0gcHJvcHM7CiAgdmFyIGFjdGl2ZUNvb3JkaW5hdGUgPSBjb29yZGluYXRlOwogIHZhciBhY3RpdmVQYXlsb2FkID0gcGF5bG9hZDsKICB2YXIgYWN0aXZlVG9vbHRpcEluZGV4ID0gaW5kZXg7CiAgaWYgKCFjdXJzb3IgfHwgIWFjdGl2ZUNvb3JkaW5hdGUgfHwgY2hhcnROYW1lICE9PSAiU2NhdHRlckNoYXJ0IiAmJiB0b29sdGlwRXZlbnRUeXBlICE9PSAiYXhpcyIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgcmVzdFByb3BzLCBjdXJzb3JDb21wLCBwcmVmZXJyZWRaSW5kZXg7CiAgaWYgKGNoYXJ0TmFtZSA9PT0gIlNjYXR0ZXJDaGFydCIpIHsKICAgIHJlc3RQcm9wcyA9IGFjdGl2ZUNvb3JkaW5hdGU7CiAgICBjdXJzb3JDb21wID0gQ3Jvc3M7CiAgICBwcmVmZXJyZWRaSW5kZXggPSBEZWZhdWx0WkluZGV4ZXMuY3Vyc29yTGluZTsKICB9IGVsc2UgaWYgKGNoYXJ0TmFtZSA9PT0gIkJhckNoYXJ0IikgewogICAgcmVzdFByb3BzID0gZ2V0Q3Vyc29yUmVjdGFuZ2xlKGxheW91dCwgYWN0aXZlQ29vcmRpbmF0ZSwgb2Zmc2V0LCB0b29sdGlwQXhpc0JhbmRTaXplKTsKICAgIGN1cnNvckNvbXAgPSBSZWN0YW5nbGU7CiAgICBwcmVmZXJyZWRaSW5kZXggPSBEZWZhdWx0WkluZGV4ZXMuY3Vyc29yUmVjdGFuZ2xlOwogIH0gZWxzZSBpZiAobGF5b3V0ID09PSAicmFkaWFsIiAmJiBpc1BvbGFyQ29vcmRpbmF0ZShhY3RpdmVDb29yZGluYXRlKSkgewogICAgdmFyIHsKICAgICAgY3gsCiAgICAgIGN5LAogICAgICByYWRpdXMsCiAgICAgIHN0YXJ0QW5nbGUsCiAgICAgIGVuZEFuZ2xlCiAgICB9ID0gZ2V0UmFkaWFsQ3Vyc29yUG9pbnRzKGFjdGl2ZUNvb3JkaW5hdGUpOwogICAgcmVzdFByb3BzID0gewogICAgICBjeCwKICAgICAgY3ksCiAgICAgIHN0YXJ0QW5nbGUsCiAgICAgIGVuZEFuZ2xlLAogICAgICBpbm5lclJhZGl1czogcmFkaXVzLAogICAgICBvdXRlclJhZGl1czogcmFkaXVzCiAgICB9OwogICAgY3Vyc29yQ29tcCA9IFNlY3RvcjsKICAgIHByZWZlcnJlZFpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5jdXJzb3JMaW5lOwogIH0gZWxzZSB7CiAgICByZXN0UHJvcHMgPSB7CiAgICAgIHBvaW50czogZ2V0Q3Vyc29yUG9pbnRzKGxheW91dCwgYWN0aXZlQ29vcmRpbmF0ZSwgb2Zmc2V0KQogICAgfTsKICAgIGN1cnNvckNvbXAgPSBDdXJ2ZTsKICAgIHByZWZlcnJlZFpJbmRleCA9IERlZmF1bHRaSW5kZXhlcy5jdXJzb3JMaW5lOwogIH0KICB2YXIgZXh0cmFDbGFzc05hbWUgPSB0eXBlb2YgY3Vyc29yID09PSAib2JqZWN0IiAmJiAiY2xhc3NOYW1lIiBpbiBjdXJzb3IgPyBjdXJzb3IuY2xhc3NOYW1lIDogdm9pZCAwOwogIHZhciBjdXJzb3JQcm9wcyA9IF9vYmplY3RTcHJlYWQxOShfb2JqZWN0U3ByZWFkMTkoX29iamVjdFNwcmVhZDE5KF9vYmplY3RTcHJlYWQxOSh7CiAgICBzdHJva2U6ICIjY2NjIiwKICAgIHBvaW50ZXJFdmVudHM6ICJub25lIgogIH0sIG9mZnNldCksIHJlc3RQcm9wcyksIHN2Z1Byb3BlcnRpZXNOb0V2ZW50c0Zyb21Vbmtub3duKGN1cnNvcikpLCB7fSwgewogICAgcGF5bG9hZDogYWN0aXZlUGF5bG9hZCwKICAgIHBheWxvYWRJbmRleDogYWN0aXZlVG9vbHRpcEluZGV4LAogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy10b29sdGlwLWN1cnNvciIsIGV4dHJhQ2xhc3NOYW1lKQogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMS5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IChfcHJvcHMkekluZGV4ID0gcHJvcHMuekluZGV4KSAhPT0gbnVsbCAmJiBfcHJvcHMkekluZGV4ICE9PSB2b2lkIDAgPyBfcHJvcHMkekluZGV4IDogcHJlZmVycmVkWkluZGV4CiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MTEuY3JlYXRlRWxlbWVudChSZW5kZXJDdXJzb3IsIHsKICAgIGN1cnNvciwKICAgIGN1cnNvckNvbXAsCiAgICBjdXJzb3JQcm9wcwogIH0pKTsKfQpmdW5jdGlvbiBDdXJzb3IocHJvcHMpIHsKICB2YXIgdG9vbHRpcEF4aXNCYW5kU2l6ZSA9IHVzZVRvb2x0aXBBeGlzQmFuZFNpemUoKTsKICB2YXIgb2Zmc2V0ID0gdXNlT2Zmc2V0SW50ZXJuYWwoKTsKICB2YXIgbGF5b3V0ID0gdXNlQ2hhcnRMYXlvdXQoKTsKICB2YXIgY2hhcnROYW1lID0gdXNlQ2hhcnROYW1lKCk7CiAgaWYgKHRvb2x0aXBBeGlzQmFuZFNpemUgPT0gbnVsbCB8fCBvZmZzZXQgPT0gbnVsbCB8fCBsYXlvdXQgPT0gbnVsbCB8fCBjaGFydE5hbWUgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMS5jcmVhdGVFbGVtZW50KEN1cnNvckludGVybmFsLCBfZXh0ZW5kczkoe30sIHByb3BzLCB7CiAgICBvZmZzZXQsCiAgICBsYXlvdXQsCiAgICB0b29sdGlwQXhpc0JhbmRTaXplLAogICAgY2hhcnROYW1lCiAgfSkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L3Rvb2x0aXBQb3J0YWxDb250ZXh0LmpzCnZhciBpbXBvcnRfcmVhY3QyMiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIFRvb2x0aXBQb3J0YWxDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyMi5jcmVhdGVDb250ZXh0KShudWxsKTsKdmFyIHVzZVRvb2x0aXBQb3J0YWwgPSAoKSA9PiAoMCwgaW1wb3J0X3JlYWN0MjIudXNlQ29udGV4dCkoVG9vbHRpcFBvcnRhbENvbnRleHQpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3luY2hyb25pc2F0aW9uL3VzZUNoYXJ0U3luY2hyb25pc2F0aW9uLmpzCnZhciBpbXBvcnRfcmVhY3QyMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9ldmVudGVtaXR0ZXIzQDUuMC4xL25vZGVfbW9kdWxlcy9ldmVudGVtaXR0ZXIzL2luZGV4Lm1qcwp2YXIgaW1wb3J0X2luZGV4ID0gX190b0VTTShyZXF1aXJlX2V2ZW50ZW1pdHRlcjMoKSwgMSk7CnZhciBldmVudGVtaXR0ZXIzX2RlZmF1bHQgPSBpbXBvcnRfaW5kZXguZGVmYXVsdDsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvRXZlbnRzLmpzCnZhciBldmVudENlbnRlciA9IG5ldyBldmVudGVtaXR0ZXIzX2RlZmF1bHQoKTsKdmFyIFRPT0xUSVBfU1lOQ19FVkVOVCA9ICJyZWNoYXJ0cy5zeW5jRXZlbnQudG9vbHRpcCI7CnZhciBCUlVTSF9TWU5DX0VWRU5UID0gInJlY2hhcnRzLnN5bmNFdmVudC5icnVzaCI7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9vcHRpb25zU2xpY2UuanMKZnVuY3Rpb24gYXJyYXlUb29sdGlwU2VhcmNoZXIoZGF0YSwgc3RySW5kZXgpIHsKICBpZiAoIXN0ckluZGV4KSByZXR1cm4gdm9pZCAwOwogIHZhciBudW1JbmRleCA9IE51bWJlci5wYXJzZUludChzdHJJbmRleCwgMTApOwogIGlmIChpc05hbihudW1JbmRleCkpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBkYXRhID09PSBudWxsIHx8IGRhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGFbbnVtSW5kZXhdOwp9CnZhciBpbml0aWFsU3RhdGU1ID0gewogIGNoYXJ0TmFtZTogIiIsCiAgdG9vbHRpcFBheWxvYWRTZWFyY2hlcjogdm9pZCAwLAogIGV2ZW50RW1pdHRlcjogdm9pZCAwLAogIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlOiAiYXhpcyIKfTsKdmFyIG9wdGlvbnNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAib3B0aW9ucyIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGU1LAogIHJlZHVjZXJzOiB7CiAgICBjcmVhdGVFdmVudEVtaXR0ZXI6IChzdGF0ZSkgPT4gewogICAgICBpZiAoc3RhdGUuZXZlbnRFbWl0dGVyID09IG51bGwpIHsKICAgICAgICBzdGF0ZS5ldmVudEVtaXR0ZXIgPSBTeW1ib2woInJlY2hhcnRzRXZlbnRFbWl0dGVyIik7CiAgICAgIH0KICAgIH0KICB9Cn0pOwp2YXIgb3B0aW9uc1JlZHVjZXIgPSBvcHRpb25zU2xpY2UucmVkdWNlcjsKdmFyIHsKICBjcmVhdGVFdmVudEVtaXR0ZXIKfSA9IG9wdGlvbnNTbGljZS5hY3Rpb25zOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3luY2hyb25pc2F0aW9uL3N5bmNTZWxlY3RvcnMuanMKZnVuY3Rpb24gc2VsZWN0U3luY2hyb25pc2VkVG9vbHRpcFN0YXRlKHN0YXRlKSB7CiAgcmV0dXJuIHN0YXRlLnRvb2x0aXAuc3luY0ludGVyYWN0aW9uOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9jaGFydERhdGFTbGljZS5qcwp2YXIgaW5pdGlhbENoYXJ0RGF0YVN0YXRlID0gewogIGNoYXJ0RGF0YTogdm9pZCAwLAogIGNvbXB1dGVkRGF0YTogdm9pZCAwLAogIGRhdGFTdGFydEluZGV4OiAwLAogIGRhdGFFbmRJbmRleDogMAp9Owp2YXIgY2hhcnREYXRhU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImNoYXJ0RGF0YSIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsQ2hhcnREYXRhU3RhdGUsCiAgcmVkdWNlcnM6IHsKICAgIHNldENoYXJ0RGF0YShzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHN0YXRlLmNoYXJ0RGF0YSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICBpZiAoYWN0aW9uLnBheWxvYWQgPT0gbnVsbCkgewogICAgICAgIHN0YXRlLmRhdGFTdGFydEluZGV4ID0gMDsKICAgICAgICBzdGF0ZS5kYXRhRW5kSW5kZXggPSAwOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoYWN0aW9uLnBheWxvYWQubGVuZ3RoID4gMCAmJiBzdGF0ZS5kYXRhRW5kSW5kZXggIT09IGFjdGlvbi5wYXlsb2FkLmxlbmd0aCAtIDEpIHsKICAgICAgICBzdGF0ZS5kYXRhRW5kSW5kZXggPSBhY3Rpb24ucGF5bG9hZC5sZW5ndGggLSAxOwogICAgICB9CiAgICB9LAogICAgc2V0Q29tcHV0ZWREYXRhKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgc3RhdGUuY29tcHV0ZWREYXRhID0gYWN0aW9uLnBheWxvYWQ7CiAgICB9LAogICAgc2V0RGF0YVN0YXJ0RW5kSW5kZXhlcyhzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIHZhciB7CiAgICAgICAgc3RhcnRJbmRleCwKICAgICAgICBlbmRJbmRleAogICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIGlmIChzdGFydEluZGV4ICE9IG51bGwpIHsKICAgICAgICBzdGF0ZS5kYXRhU3RhcnRJbmRleCA9IHN0YXJ0SW5kZXg7CiAgICAgIH0KICAgICAgaWYgKGVuZEluZGV4ICE9IG51bGwpIHsKICAgICAgICBzdGF0ZS5kYXRhRW5kSW5kZXggPSBlbmRJbmRleDsKICAgICAgfQogICAgfQogIH0KfSk7CnZhciB7CiAgc2V0Q2hhcnREYXRhLAogIHNldERhdGFTdGFydEVuZEluZGV4ZXMsCiAgc2V0Q29tcHV0ZWREYXRhCn0gPSBjaGFydERhdGFTbGljZS5hY3Rpb25zOwp2YXIgY2hhcnREYXRhUmVkdWNlciA9IGNoYXJ0RGF0YVNsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zeW5jaHJvbmlzYXRpb24vdXNlQ2hhcnRTeW5jaHJvbmlzYXRpb24uanMKdmFyIF9leGNsdWRlZDUgPSBbIngiLCAieSJdOwpmdW5jdGlvbiBvd25LZXlzMjAoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyMChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czIwKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyMChlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyMChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjAoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyMChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyMCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyMCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyMCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNShlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNShlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNShyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gdXNlVG9vbHRpcFN5bmNFdmVudHNMaXN0ZW5lcigpIHsKICB2YXIgbXlTeW5jSWQgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RTeW5jSWQpOwogIHZhciBteUV2ZW50RW1pdHRlciA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEV2ZW50RW1pdHRlcik7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgc3luY01ldGhvZCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFN5bmNNZXRob2QpOwogIHZhciB0b29sdGlwVGlja3MgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RUb29sdGlwQXhpc1RpY2tzKTsKICB2YXIgbGF5b3V0ID0gdXNlQ2hhcnRMYXlvdXQoKTsKICB2YXIgdmlld0JveCA9IHVzZVZpZXdCb3goKTsKICB2YXIgY2xhc3NOYW1lID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzdGF0ZS5yb290UHJvcHMuY2xhc3NOYW1lKTsKICAoMCwgaW1wb3J0X3JlYWN0MjMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAobXlTeW5jSWQgPT0gbnVsbCkgewogICAgICByZXR1cm4gbm9vcDsKICAgIH0KICAgIHZhciBsaXN0ZW5lcjIgPSAoaW5jb21pbmdTeW5jSWQsIGFjdGlvbiwgZW1pdHRlcikgPT4gewogICAgICBpZiAobXlFdmVudEVtaXR0ZXIgPT09IGVtaXR0ZXIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKG15U3luY0lkICE9PSBpbmNvbWluZ1N5bmNJZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoc3luY01ldGhvZCA9PT0gImluZGV4IikgewogICAgICAgIHZhciBfYWN0aW9uJHBheWxvYWQ7CiAgICAgICAgaWYgKHZpZXdCb3ggJiYgYWN0aW9uICE9PSBudWxsICYmIGFjdGlvbiAhPT0gdm9pZCAwICYmIChfYWN0aW9uJHBheWxvYWQgPSBhY3Rpb24ucGF5bG9hZCkgIT09IG51bGwgJiYgX2FjdGlvbiRwYXlsb2FkICE9PSB2b2lkIDAgJiYgX2FjdGlvbiRwYXlsb2FkLmNvb3JkaW5hdGUgJiYgYWN0aW9uLnBheWxvYWQuc291cmNlVmlld0JveCkgewogICAgICAgICAgdmFyIF9hY3Rpb24kcGF5bG9hZCRjb29yZCA9IGFjdGlvbi5wYXlsb2FkLmNvb3JkaW5hdGUsIHsKICAgICAgICAgICAgeDogX3gsCiAgICAgICAgICAgIHk6IF95CiAgICAgICAgICB9ID0gX2FjdGlvbiRwYXlsb2FkJGNvb3JkLCBvdGhlckNvb3JkaW5hdGVQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczUoX2FjdGlvbiRwYXlsb2FkJGNvb3JkLCBfZXhjbHVkZWQ1KTsKICAgICAgICAgIHZhciB7CiAgICAgICAgICAgIHg6IHNvdXJjZVgsCiAgICAgICAgICAgIHk6IHNvdXJjZVksCiAgICAgICAgICAgIHdpZHRoOiBzb3VyY2VXaWR0aCwKICAgICAgICAgICAgaGVpZ2h0OiBzb3VyY2VIZWlnaHQKICAgICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZC5zb3VyY2VWaWV3Qm94OwogICAgICAgICAgdmFyIHNjYWxlZENvb3JkaW5hdGUgPSBfb2JqZWN0U3ByZWFkMjAoX29iamVjdFNwcmVhZDIwKHt9LCBvdGhlckNvb3JkaW5hdGVQcm9wcyksIHt9LCB7CiAgICAgICAgICAgIHg6IHZpZXdCb3gueCArIChzb3VyY2VXaWR0aCA/IChfeCAtIHNvdXJjZVgpIC8gc291cmNlV2lkdGggOiAwKSAqIHZpZXdCb3gud2lkdGgsCiAgICAgICAgICAgIHk6IHZpZXdCb3gueSArIChzb3VyY2VIZWlnaHQgPyAoX3kgLSBzb3VyY2VZKSAvIHNvdXJjZUhlaWdodCA6IDApICogdmlld0JveC5oZWlnaHQKICAgICAgICAgIH0pOwogICAgICAgICAgZGlzcGF0Y2goX29iamVjdFNwcmVhZDIwKF9vYmplY3RTcHJlYWQyMCh7fSwgYWN0aW9uKSwge30sIHsKICAgICAgICAgICAgcGF5bG9hZDogX29iamVjdFNwcmVhZDIwKF9vYmplY3RTcHJlYWQyMCh7fSwgYWN0aW9uLnBheWxvYWQpLCB7fSwgewogICAgICAgICAgICAgIGNvb3JkaW5hdGU6IHNjYWxlZENvb3JkaW5hdGUKICAgICAgICAgICAgfSkKICAgICAgICAgIH0pKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGlzcGF0Y2goYWN0aW9uKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICh0b29sdGlwVGlja3MgPT0gbnVsbCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgYWN0aXZlVGljazsKICAgICAgaWYgKHR5cGVvZiBzeW5jTWV0aG9kID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgdmFyIHN5bmNNZXRob2RQYXJhbSA9IHsKICAgICAgICAgIGFjdGl2ZVRvb2x0aXBJbmRleDogYWN0aW9uLnBheWxvYWQuaW5kZXggPT0gbnVsbCA/IHZvaWQgMCA6IE51bWJlcihhY3Rpb24ucGF5bG9hZC5pbmRleCksCiAgICAgICAgICBpc1Rvb2x0aXBBY3RpdmU6IGFjdGlvbi5wYXlsb2FkLmFjdGl2ZSwKICAgICAgICAgIGFjdGl2ZUluZGV4OiBhY3Rpb24ucGF5bG9hZC5pbmRleCA9PSBudWxsID8gdm9pZCAwIDogTnVtYmVyKGFjdGlvbi5wYXlsb2FkLmluZGV4KSwKICAgICAgICAgIGFjdGl2ZUxhYmVsOiBhY3Rpb24ucGF5bG9hZC5sYWJlbCwKICAgICAgICAgIGFjdGl2ZURhdGFLZXk6IGFjdGlvbi5wYXlsb2FkLmRhdGFLZXksCiAgICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBhY3Rpb24ucGF5bG9hZC5jb29yZGluYXRlCiAgICAgICAgfTsKICAgICAgICB2YXIgYWN0aXZlVG9vbHRpcEluZGV4ID0gc3luY01ldGhvZCh0b29sdGlwVGlja3MsIHN5bmNNZXRob2RQYXJhbSk7CiAgICAgICAgYWN0aXZlVGljayA9IHRvb2x0aXBUaWNrc1thY3RpdmVUb29sdGlwSW5kZXhdOwogICAgICB9IGVsc2UgaWYgKHN5bmNNZXRob2QgPT09ICJ2YWx1ZSIpIHsKICAgICAgICBhY3RpdmVUaWNrID0gdG9vbHRpcFRpY2tzLmZpbmQoKHRpY2spID0+IFN0cmluZyh0aWNrLnZhbHVlKSA9PT0gYWN0aW9uLnBheWxvYWQubGFiZWwpOwogICAgICB9CiAgICAgIHZhciB7CiAgICAgICAgY29vcmRpbmF0ZQogICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIGlmIChhY3RpdmVUaWNrID09IG51bGwgfHwgYWN0aW9uLnBheWxvYWQuYWN0aXZlID09PSBmYWxzZSB8fCBjb29yZGluYXRlID09IG51bGwgfHwgdmlld0JveCA9PSBudWxsKSB7CiAgICAgICAgZGlzcGF0Y2goc2V0U3luY0ludGVyYWN0aW9uKHsKICAgICAgICAgIGFjdGl2ZTogZmFsc2UsCiAgICAgICAgICBjb29yZGluYXRlOiB2b2lkIDAsCiAgICAgICAgICBkYXRhS2V5OiB2b2lkIDAsCiAgICAgICAgICBpbmRleDogbnVsbCwKICAgICAgICAgIGxhYmVsOiB2b2lkIDAsCiAgICAgICAgICBzb3VyY2VWaWV3Qm94OiB2b2lkIDAsCiAgICAgICAgICBncmFwaGljYWxJdGVtSWQ6IHZvaWQgMAogICAgICAgIH0pKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHsKICAgICAgICB4OiB4MiwKICAgICAgICB5OiB5MgogICAgICB9ID0gY29vcmRpbmF0ZTsKICAgICAgdmFyIHZhbGlkYXRlQ2hhcnRYID0gTWF0aC5taW4oeDIsIHZpZXdCb3gueCArIHZpZXdCb3gud2lkdGgpOwogICAgICB2YXIgdmFsaWRhdGVDaGFydFkgPSBNYXRoLm1pbih5Miwgdmlld0JveC55ICsgdmlld0JveC5oZWlnaHQpOwogICAgICB2YXIgYWN0aXZlQ29vcmRpbmF0ZSA9IHsKICAgICAgICB4OiBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IGFjdGl2ZVRpY2suY29vcmRpbmF0ZSA6IHZhbGlkYXRlQ2hhcnRYLAogICAgICAgIHk6IGxheW91dCA9PT0gImhvcml6b250YWwiID8gdmFsaWRhdGVDaGFydFkgOiBhY3RpdmVUaWNrLmNvb3JkaW5hdGUKICAgICAgfTsKICAgICAgdmFyIHN5bmNBY3Rpb24gPSBzZXRTeW5jSW50ZXJhY3Rpb24oewogICAgICAgIGFjdGl2ZTogYWN0aW9uLnBheWxvYWQuYWN0aXZlLAogICAgICAgIGNvb3JkaW5hdGU6IGFjdGl2ZUNvb3JkaW5hdGUsCiAgICAgICAgZGF0YUtleTogYWN0aW9uLnBheWxvYWQuZGF0YUtleSwKICAgICAgICBpbmRleDogU3RyaW5nKGFjdGl2ZVRpY2suaW5kZXgpLAogICAgICAgIGxhYmVsOiBhY3Rpb24ucGF5bG9hZC5sYWJlbCwKICAgICAgICBzb3VyY2VWaWV3Qm94OiBhY3Rpb24ucGF5bG9hZC5zb3VyY2VWaWV3Qm94LAogICAgICAgIGdyYXBoaWNhbEl0ZW1JZDogYWN0aW9uLnBheWxvYWQuZ3JhcGhpY2FsSXRlbUlkCiAgICAgIH0pOwogICAgICBkaXNwYXRjaChzeW5jQWN0aW9uKTsKICAgIH07CiAgICBldmVudENlbnRlci5vbihUT09MVElQX1NZTkNfRVZFTlQsIGxpc3RlbmVyMik7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBldmVudENlbnRlci5vZmYoVE9PTFRJUF9TWU5DX0VWRU5ULCBsaXN0ZW5lcjIpOwogICAgfTsKICB9LCBbY2xhc3NOYW1lLCBkaXNwYXRjaCwgbXlFdmVudEVtaXR0ZXIsIG15U3luY0lkLCBzeW5jTWV0aG9kLCB0b29sdGlwVGlja3MsIGxheW91dCwgdmlld0JveF0pOwp9CmZ1bmN0aW9uIHVzZUJydXNoU3luY0V2ZW50c0xpc3RlbmVyKCkgewogIHZhciBteVN5bmNJZCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFN5bmNJZCk7CiAgdmFyIG15RXZlbnRFbWl0dGVyID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0RXZlbnRFbWl0dGVyKTsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogICgwLCBpbXBvcnRfcmVhY3QyMy51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChteVN5bmNJZCA9PSBudWxsKSB7CiAgICAgIHJldHVybiBub29wOwogICAgfQogICAgdmFyIGxpc3RlbmVyMiA9IChpbmNvbWluZ1N5bmNJZCwgYWN0aW9uLCBlbWl0dGVyKSA9PiB7CiAgICAgIGlmIChteUV2ZW50RW1pdHRlciA9PT0gZW1pdHRlcikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAobXlTeW5jSWQgPT09IGluY29taW5nU3luY0lkKSB7CiAgICAgICAgZGlzcGF0Y2goc2V0RGF0YVN0YXJ0RW5kSW5kZXhlcyhhY3Rpb24pKTsKICAgICAgfQogICAgfTsKICAgIGV2ZW50Q2VudGVyLm9uKEJSVVNIX1NZTkNfRVZFTlQsIGxpc3RlbmVyMik7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBldmVudENlbnRlci5vZmYoQlJVU0hfU1lOQ19FVkVOVCwgbGlzdGVuZXIyKTsKICAgIH07CiAgfSwgW2Rpc3BhdGNoLCBteUV2ZW50RW1pdHRlciwgbXlTeW5jSWRdKTsKfQpmdW5jdGlvbiB1c2VTeW5jaHJvbmlzZWRFdmVudHNGcm9tT3RoZXJDaGFydHMoKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICAoMCwgaW1wb3J0X3JlYWN0MjMudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBkaXNwYXRjaChjcmVhdGVFdmVudEVtaXR0ZXIoKSk7CiAgfSwgW2Rpc3BhdGNoXSk7CiAgdXNlVG9vbHRpcFN5bmNFdmVudHNMaXN0ZW5lcigpOwogIHVzZUJydXNoU3luY0V2ZW50c0xpc3RlbmVyKCk7Cn0KZnVuY3Rpb24gdXNlVG9vbHRpcENoYXJ0U3luY2hyb25pc2F0aW9uKHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGFjdGl2ZUNvb3JkaW5hdGUsIGFjdGl2ZUxhYmVsLCBhY3RpdmVJbmRleCwgaXNUb29sdGlwQWN0aXZlKSB7CiAgdmFyIGFjdGl2ZURhdGFLZXkgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFRvb2x0aXBEYXRhS2V5KHN0YXRlLCB0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyKSk7CiAgdmFyIGV2ZW50RW1pdHRlclN5bWJvbCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEV2ZW50RW1pdHRlcik7CiAgdmFyIHN5bmNJZCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdFN5bmNJZCk7CiAgdmFyIHN5bmNNZXRob2QgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RTeW5jTWV0aG9kKTsKICB2YXIgdG9vbHRpcFN0YXRlID0gdXNlQXBwU2VsZWN0b3Ioc2VsZWN0U3luY2hyb25pc2VkVG9vbHRpcFN0YXRlKTsKICB2YXIgaXNSZWNlaXZpbmdTeW5jaHJvbmlzYXRpb24gPSB0b29sdGlwU3RhdGUgPT09IG51bGwgfHwgdG9vbHRpcFN0YXRlID09PSB2b2lkIDAgPyB2b2lkIDAgOiB0b29sdGlwU3RhdGUuYWN0aXZlOwogIHZhciB2aWV3Qm94ID0gdXNlVmlld0JveCgpOwogICgwLCBpbXBvcnRfcmVhY3QyMy51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChpc1JlY2VpdmluZ1N5bmNocm9uaXNhdGlvbikgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoc3luY0lkID09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKGV2ZW50RW1pdHRlclN5bWJvbCA9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBzeW5jQWN0aW9uID0gc2V0U3luY0ludGVyYWN0aW9uKHsKICAgICAgYWN0aXZlOiBpc1Rvb2x0aXBBY3RpdmUsCiAgICAgIGNvb3JkaW5hdGU6IGFjdGl2ZUNvb3JkaW5hdGUsCiAgICAgIGRhdGFLZXk6IGFjdGl2ZURhdGFLZXksCiAgICAgIGluZGV4OiBhY3RpdmVJbmRleCwKICAgICAgbGFiZWw6IHR5cGVvZiBhY3RpdmVMYWJlbCA9PT0gIm51bWJlciIgPyBTdHJpbmcoYWN0aXZlTGFiZWwpIDogYWN0aXZlTGFiZWwsCiAgICAgIHNvdXJjZVZpZXdCb3g6IHZpZXdCb3gsCiAgICAgIGdyYXBoaWNhbEl0ZW1JZDogdm9pZCAwCiAgICB9KTsKICAgIGV2ZW50Q2VudGVyLmVtaXQoVE9PTFRJUF9TWU5DX0VWRU5ULCBzeW5jSWQsIHN5bmNBY3Rpb24sIGV2ZW50RW1pdHRlclN5bWJvbCk7CiAgfSwgW2lzUmVjZWl2aW5nU3luY2hyb25pc2F0aW9uLCBhY3RpdmVDb29yZGluYXRlLCBhY3RpdmVEYXRhS2V5LCBhY3RpdmVJbmRleCwgYWN0aXZlTGFiZWwsIGV2ZW50RW1pdHRlclN5bWJvbCwgc3luY0lkLCBzeW5jTWV0aG9kLCBpc1Rvb2x0aXBBY3RpdmUsIHZpZXdCb3hdKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1Rvb2x0aXAuanMKZnVuY3Rpb24gb3duS2V5czIxKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjEoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyMShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjEoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjEoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTIxKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjEocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjEodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjEodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjEodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIGRlZmF1bHRVbmlxQnkoZW50cnkpIHsKICByZXR1cm4gZW50cnkuZGF0YUtleTsKfQpmdW5jdGlvbiByZW5kZXJDb250ZW50KGNvbnRlbnQsIHByb3BzKSB7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEyLmlzVmFsaWRFbGVtZW50KGNvbnRlbnQpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTIuY2xvbmVFbGVtZW50KGNvbnRlbnQsIHByb3BzKTsKICB9CiAgaWYgKHR5cGVvZiBjb250ZW50ID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTIuY3JlYXRlRWxlbWVudChjb250ZW50LCBwcm9wcyk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxMi5jcmVhdGVFbGVtZW50KERlZmF1bHRUb29sdGlwQ29udGVudCwgcHJvcHMpOwp9CnZhciBlbXB0eVBheWxvYWQgPSBbXTsKdmFyIGRlZmF1bHRUb29sdGlwUHJvcHMgPSB7CiAgYWxsb3dFc2NhcGVWaWV3Qm94OiB7CiAgICB4OiBmYWxzZSwKICAgIHk6IGZhbHNlCiAgfSwKICBhbmltYXRpb25EdXJhdGlvbjogNDAwLAogIGFuaW1hdGlvbkVhc2luZzogImVhc2UiLAogIGF4aXNJZDogMCwKICBjb250ZW50U3R5bGU6IHt9LAogIGN1cnNvcjogdHJ1ZSwKICBmaWx0ZXJOdWxsOiB0cnVlLAogIGlzQW5pbWF0aW9uQWN0aXZlOiAiYXV0byIsCiAgaXRlbVNvcnRlcjogIm5hbWUiLAogIGl0ZW1TdHlsZToge30sCiAgbGFiZWxTdHlsZToge30sCiAgb2Zmc2V0OiAxMCwKICByZXZlcnNlRGlyZWN0aW9uOiB7CiAgICB4OiBmYWxzZSwKICAgIHk6IGZhbHNlCiAgfSwKICBzZXBhcmF0b3I6ICIgOiAiLAogIHRyaWdnZXI6ICJob3ZlciIsCiAgdXNlVHJhbnNsYXRlM2Q6IGZhbHNlLAogIHdyYXBwZXJTdHlsZToge30KfTsKZnVuY3Rpb24gVG9vbHRpcChvdXRzaWRlUHJvcHMpIHsKICB2YXIgX3VzZUFwcFNlbGVjdG9yLCBfcmVmMjsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgZGVmYXVsdFRvb2x0aXBQcm9wcyk7CiAgdmFyIHsKICAgIGFjdGl2ZTogYWN0aXZlRnJvbVByb3BzLAogICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25FYXNpbmcsCiAgICBjb250ZW50LAogICAgZmlsdGVyTnVsbCwKICAgIGlzQW5pbWF0aW9uQWN0aXZlLAogICAgb2Zmc2V0LAogICAgcGF5bG9hZFVuaXFCeSwKICAgIHBvc2l0aW9uLAogICAgcmV2ZXJzZURpcmVjdGlvbiwKICAgIHVzZVRyYW5zbGF0ZTNkLAogICAgd3JhcHBlclN0eWxlLAogICAgY3Vyc29yLAogICAgc2hhcmVkLAogICAgdHJpZ2dlciwKICAgIGRlZmF1bHRJbmRleCwKICAgIHBvcnRhbDogcG9ydGFsRnJvbVByb3BzLAogICAgYXhpc0lkCiAgfSA9IHByb3BzOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGRlZmF1bHRJbmRleEFzU3RyaW5nID0gdHlwZW9mIGRlZmF1bHRJbmRleCA9PT0gIm51bWJlciIgPyBTdHJpbmcoZGVmYXVsdEluZGV4KSA6IGRlZmF1bHRJbmRleDsKICAoMCwgaW1wb3J0X3JlYWN0MjQudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBkaXNwYXRjaChzZXRUb29sdGlwU2V0dGluZ3NTdGF0ZSh7CiAgICAgIHNoYXJlZCwKICAgICAgdHJpZ2dlciwKICAgICAgYXhpc0lkLAogICAgICBhY3RpdmU6IGFjdGl2ZUZyb21Qcm9wcywKICAgICAgZGVmYXVsdEluZGV4OiBkZWZhdWx0SW5kZXhBc1N0cmluZwogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgc2hhcmVkLCB0cmlnZ2VyLCBheGlzSWQsIGFjdGl2ZUZyb21Qcm9wcywgZGVmYXVsdEluZGV4QXNTdHJpbmddKTsKICB2YXIgdmlld0JveCA9IHVzZVZpZXdCb3goKTsKICB2YXIgYWNjZXNzaWJpbGl0eUxheWVyID0gdXNlQWNjZXNzaWJpbGl0eUxheWVyKCk7CiAgdmFyIHRvb2x0aXBFdmVudFR5cGUgPSB1c2VUb29sdGlwRXZlbnRUeXBlKHNoYXJlZCk7CiAgdmFyIHsKICAgIGFjdGl2ZUluZGV4LAogICAgaXNBY3RpdmUKICB9ID0gKF91c2VBcHBTZWxlY3RvciA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0SXNUb29sdGlwQWN0aXZlMihzdGF0ZSwgdG9vbHRpcEV2ZW50VHlwZSwgdHJpZ2dlciwgZGVmYXVsdEluZGV4QXNTdHJpbmcpKSkgIT09IG51bGwgJiYgX3VzZUFwcFNlbGVjdG9yICE9PSB2b2lkIDAgPyBfdXNlQXBwU2VsZWN0b3IgOiB7fTsKICB2YXIgcGF5bG9hZEZyb21SZWR1eCA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0VG9vbHRpcFBheWxvYWQoc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGRlZmF1bHRJbmRleEFzU3RyaW5nKSk7CiAgdmFyIGxhYmVsRnJvbVJlZHV4ID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBY3RpdmVMYWJlbDIoc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGRlZmF1bHRJbmRleEFzU3RyaW5nKSk7CiAgdmFyIGNvb3JkaW5hdGUgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEFjdGl2ZUNvb3JkaW5hdGUoc3RhdGUsIHRvb2x0aXBFdmVudFR5cGUsIHRyaWdnZXIsIGRlZmF1bHRJbmRleEFzU3RyaW5nKSk7CiAgdmFyIHBheWxvYWQgPSBwYXlsb2FkRnJvbVJlZHV4OwogIHZhciB0b29sdGlwUG9ydGFsRnJvbUNvbnRleHQgPSB1c2VUb29sdGlwUG9ydGFsKCk7CiAgdmFyIGZpbmFsSXNBY3RpdmUgPSAoX3JlZjIgPSBhY3RpdmVGcm9tUHJvcHMgIT09IG51bGwgJiYgYWN0aXZlRnJvbVByb3BzICE9PSB2b2lkIDAgPyBhY3RpdmVGcm9tUHJvcHMgOiBpc0FjdGl2ZSkgIT09IG51bGwgJiYgX3JlZjIgIT09IHZvaWQgMCA/IF9yZWYyIDogZmFsc2U7CiAgdmFyIFtsYXN0Qm91bmRpbmdCb3gsIHVwZGF0ZUJvdW5kaW5nQm94XSA9IHVzZUVsZW1lbnRPZmZzZXQoW3BheWxvYWQsIGZpbmFsSXNBY3RpdmVdKTsKICB2YXIgZmluYWxMYWJlbCA9IHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIiA/IGxhYmVsRnJvbVJlZHV4IDogdm9pZCAwOwogIHVzZVRvb2x0aXBDaGFydFN5bmNocm9uaXNhdGlvbih0b29sdGlwRXZlbnRUeXBlLCB0cmlnZ2VyLCBjb29yZGluYXRlLCBmaW5hbExhYmVsLCBhY3RpdmVJbmRleCwgZmluYWxJc0FjdGl2ZSk7CiAgdmFyIHRvb2x0aXBQb3J0YWwgPSBwb3J0YWxGcm9tUHJvcHMgIT09IG51bGwgJiYgcG9ydGFsRnJvbVByb3BzICE9PSB2b2lkIDAgPyBwb3J0YWxGcm9tUHJvcHMgOiB0b29sdGlwUG9ydGFsRnJvbUNvbnRleHQ7CiAgaWYgKHRvb2x0aXBQb3J0YWwgPT0gbnVsbCB8fCB2aWV3Qm94ID09IG51bGwgfHwgdG9vbHRpcEV2ZW50VHlwZSA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGZpbmFsUGF5bG9hZCA9IHBheWxvYWQgIT09IG51bGwgJiYgcGF5bG9hZCAhPT0gdm9pZCAwID8gcGF5bG9hZCA6IGVtcHR5UGF5bG9hZDsKICBpZiAoIWZpbmFsSXNBY3RpdmUpIHsKICAgIGZpbmFsUGF5bG9hZCA9IGVtcHR5UGF5bG9hZDsKICB9CiAgaWYgKGZpbHRlck51bGwgJiYgZmluYWxQYXlsb2FkLmxlbmd0aCkgewogICAgZmluYWxQYXlsb2FkID0gZ2V0VW5pcVBheWxvYWQoZmluYWxQYXlsb2FkLmZpbHRlcigoZW50cnkpID0+IGVudHJ5LnZhbHVlICE9IG51bGwgJiYgKGVudHJ5LmhpZGUgIT09IHRydWUgfHwgcHJvcHMuaW5jbHVkZUhpZGRlbikpLCBwYXlsb2FkVW5pcUJ5LCBkZWZhdWx0VW5pcUJ5KTsKICB9CiAgdmFyIGhhc1BheWxvYWQgPSBmaW5hbFBheWxvYWQubGVuZ3RoID4gMDsKICB2YXIgdG9vbHRpcEVsZW1lbnQgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QxMi5jcmVhdGVFbGVtZW50KFRvb2x0aXBCb3VuZGluZ0JveCwgewogICAgYWxsb3dFc2NhcGVWaWV3Qm94LAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25FYXNpbmcsCiAgICBpc0FuaW1hdGlvbkFjdGl2ZSwKICAgIGFjdGl2ZTogZmluYWxJc0FjdGl2ZSwKICAgIGNvb3JkaW5hdGUsCiAgICBoYXNQYXlsb2FkLAogICAgb2Zmc2V0LAogICAgcG9zaXRpb24sCiAgICByZXZlcnNlRGlyZWN0aW9uLAogICAgdXNlVHJhbnNsYXRlM2QsCiAgICB2aWV3Qm94LAogICAgd3JhcHBlclN0eWxlLAogICAgbGFzdEJvdW5kaW5nQm94LAogICAgaW5uZXJSZWY6IHVwZGF0ZUJvdW5kaW5nQm94LAogICAgaGFzUG9ydGFsRnJvbVByb3BzOiBCb29sZWFuKHBvcnRhbEZyb21Qcm9wcykKICB9LCByZW5kZXJDb250ZW50KGNvbnRlbnQsIF9vYmplY3RTcHJlYWQyMShfb2JqZWN0U3ByZWFkMjEoe30sIHByb3BzKSwge30sIHsKICAgIHBheWxvYWQ6IGZpbmFsUGF5bG9hZCwKICAgIGxhYmVsOiBmaW5hbExhYmVsLAogICAgYWN0aXZlOiBmaW5hbElzQWN0aXZlLAogICAgYWN0aXZlSW5kZXgsCiAgICBjb29yZGluYXRlLAogICAgYWNjZXNzaWJpbGl0eUxheWVyCiAgfSkpKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTIuY3JlYXRlRWxlbWVudChSZWFjdDEyLkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdF9kb20yLmNyZWF0ZVBvcnRhbCkodG9vbHRpcEVsZW1lbnQsIHRvb2x0aXBQb3J0YWwpLCBmaW5hbElzQWN0aXZlICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEyLmNyZWF0ZUVsZW1lbnQoQ3Vyc29yLCB7CiAgICBjdXJzb3IsCiAgICB0b29sdGlwRXZlbnRUeXBlLAogICAgY29vcmRpbmF0ZSwKICAgIHBheWxvYWQ6IGZpbmFsUGF5bG9hZCwKICAgIGluZGV4OiBhY3RpdmVJbmRleAogIH0pKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L1RleHQuanMKdmFyIFJlYWN0MTMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QyNSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvTFJVQ2FjaGUuanMKZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjIoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyMihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyMih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyMih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyMih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIExSVUNhY2hlID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKG1heFNpemUpIHsKICAgIF9kZWZpbmVQcm9wZXJ0eTIyKHRoaXMsICJjYWNoZSIsIC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCkpOwogICAgdGhpcy5tYXhTaXplID0gbWF4U2l6ZTsKICB9CiAgZ2V0KGtleSkgewogICAgdmFyIHZhbHVlID0gdGhpcy5jYWNoZS5nZXQoa2V5KTsKICAgIGlmICh2YWx1ZSAhPT0gdm9pZCAwKSB7CiAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKGtleSk7CiAgICAgIHRoaXMuY2FjaGUuc2V0KGtleSwgdmFsdWUpOwogICAgfQogICAgcmV0dXJuIHZhbHVlOwogIH0KICBzZXQoa2V5LCB2YWx1ZSkgewogICAgaWYgKHRoaXMuY2FjaGUuaGFzKGtleSkpIHsKICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTsKICAgIH0gZWxzZSBpZiAodGhpcy5jYWNoZS5zaXplID49IHRoaXMubWF4U2l6ZSkgewogICAgICB2YXIgZmlyc3RLZXkgPSB0aGlzLmNhY2hlLmtleXMoKS5uZXh0KCkudmFsdWU7CiAgICAgIGlmIChmaXJzdEtleSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5jYWNoZS5kZWxldGUoZmlyc3RLZXkpOwogICAgICB9CiAgICB9CiAgICB0aGlzLmNhY2hlLnNldChrZXksIHZhbHVlKTsKICB9CiAgY2xlYXIoKSB7CiAgICB0aGlzLmNhY2hlLmNsZWFyKCk7CiAgfQogIHNpemUoKSB7CiAgICByZXR1cm4gdGhpcy5jYWNoZS5zaXplOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvRE9NVXRpbHMuanMKZnVuY3Rpb24gb3duS2V5czIyKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjIoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyMihPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MjMoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjIoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTIzKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MjMocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MjModCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMjModCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMjModCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBkZWZhdWx0Q29uZmlnID0gewogIGNhY2hlU2l6ZTogMmUzLAogIGVuYWJsZUNhY2hlOiB0cnVlCn07CnZhciBjdXJyZW50Q29uZmlnID0gX29iamVjdFNwcmVhZDIyKHt9LCBkZWZhdWx0Q29uZmlnKTsKdmFyIHN0cmluZ0NhY2hlID0gbmV3IExSVUNhY2hlKGN1cnJlbnRDb25maWcuY2FjaGVTaXplKTsKdmFyIFNQQU5fU1RZTEUgPSB7CiAgcG9zaXRpb246ICJhYnNvbHV0ZSIsCiAgdG9wOiAiLTIwMDAwcHgiLAogIGxlZnQ6IDAsCiAgcGFkZGluZzogMCwKICBtYXJnaW46IDAsCiAgYm9yZGVyOiAibm9uZSIsCiAgd2hpdGVTcGFjZTogInByZSIKfTsKdmFyIE1FQVNVUkVNRU5UX1NQQU5fSUQgPSAicmVjaGFydHNfbWVhc3VyZW1lbnRfc3BhbiI7CmZ1bmN0aW9uIGNyZWF0ZUNhY2hlS2V5KHRleHQsIHN0eWxlKSB7CiAgdmFyIGZvbnRTaXplID0gc3R5bGUuZm9udFNpemUgfHwgIiI7CiAgdmFyIGZvbnRGYW1pbHkgPSBzdHlsZS5mb250RmFtaWx5IHx8ICIiOwogIHZhciBmb250V2VpZ2h0ID0gc3R5bGUuZm9udFdlaWdodCB8fCAiIjsKICB2YXIgZm9udFN0eWxlID0gc3R5bGUuZm9udFN0eWxlIHx8ICIiOwogIHZhciBsZXR0ZXJTcGFjaW5nID0gc3R5bGUubGV0dGVyU3BhY2luZyB8fCAiIjsKICB2YXIgdGV4dFRyYW5zZm9ybSA9IHN0eWxlLnRleHRUcmFuc2Zvcm0gfHwgIiI7CiAgcmV0dXJuICIiLmNvbmNhdCh0ZXh0LCAifCIpLmNvbmNhdChmb250U2l6ZSwgInwiKS5jb25jYXQoZm9udEZhbWlseSwgInwiKS5jb25jYXQoZm9udFdlaWdodCwgInwiKS5jb25jYXQoZm9udFN0eWxlLCAifCIpLmNvbmNhdChsZXR0ZXJTcGFjaW5nLCAifCIpLmNvbmNhdCh0ZXh0VHJhbnNmb3JtKTsKfQp2YXIgbWVhc3VyZVRleHRXaXRoRE9NID0gKHRleHQsIHN0eWxlKSA9PiB7CiAgdHJ5IHsKICAgIHZhciBtZWFzdXJlbWVudFNwYW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChNRUFTVVJFTUVOVF9TUEFOX0lEKTsKICAgIGlmICghbWVhc3VyZW1lbnRTcGFuKSB7CiAgICAgIG1lYXN1cmVtZW50U3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKTsKICAgICAgbWVhc3VyZW1lbnRTcGFuLnNldEF0dHJpYnV0ZSgiaWQiLCBNRUFTVVJFTUVOVF9TUEFOX0lEKTsKICAgICAgbWVhc3VyZW1lbnRTcGFuLnNldEF0dHJpYnV0ZSgiYXJpYS1oaWRkZW4iLCAidHJ1ZSIpOwogICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG1lYXN1cmVtZW50U3Bhbik7CiAgICB9CiAgICBPYmplY3QuYXNzaWduKG1lYXN1cmVtZW50U3Bhbi5zdHlsZSwgU1BBTl9TVFlMRSwgc3R5bGUpOwogICAgbWVhc3VyZW1lbnRTcGFuLnRleHRDb250ZW50ID0gIiIuY29uY2F0KHRleHQpOwogICAgdmFyIHJlY3QgPSBtZWFzdXJlbWVudFNwYW4uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICByZXR1cm4gewogICAgICB3aWR0aDogcmVjdC53aWR0aCwKICAgICAgaGVpZ2h0OiByZWN0LmhlaWdodAogICAgfTsKICB9IGNhdGNoIChfdW51c2VkKSB7CiAgICByZXR1cm4gewogICAgICB3aWR0aDogMCwKICAgICAgaGVpZ2h0OiAwCiAgICB9OwogIH0KfTsKdmFyIGdldFN0cmluZ1NpemUgPSBmdW5jdGlvbiBnZXRTdHJpbmdTaXplMih0ZXh0KSB7CiAgdmFyIHN0eWxlID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiB7fTsKICBpZiAodGV4dCA9PT0gdm9pZCAwIHx8IHRleHQgPT09IG51bGwgfHwgR2xvYmFsLmlzU3NyKSB7CiAgICByZXR1cm4gewogICAgICB3aWR0aDogMCwKICAgICAgaGVpZ2h0OiAwCiAgICB9OwogIH0KICBpZiAoIWN1cnJlbnRDb25maWcuZW5hYmxlQ2FjaGUpIHsKICAgIHJldHVybiBtZWFzdXJlVGV4dFdpdGhET00odGV4dCwgc3R5bGUpOwogIH0KICB2YXIgY2FjaGVLZXkgPSBjcmVhdGVDYWNoZUtleSh0ZXh0LCBzdHlsZSk7CiAgdmFyIGNhY2hlZFJlc3VsdCA9IHN0cmluZ0NhY2hlLmdldChjYWNoZUtleSk7CiAgaWYgKGNhY2hlZFJlc3VsdCkgewogICAgcmV0dXJuIGNhY2hlZFJlc3VsdDsKICB9CiAgdmFyIHJlc3VsdCA9IG1lYXN1cmVUZXh0V2l0aERPTSh0ZXh0LCBzdHlsZSk7CiAgc3RyaW5nQ2FjaGUuc2V0KGNhY2hlS2V5LCByZXN1bHQpOwogIHJldHVybiByZXN1bHQ7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL1JlZHVjZUNTU0NhbGMuanMKdmFyIE1VTFRJUExZX09SX0RJVklERV9SRUdFWCA9IC8oLT9cZCsoPzpcLlxkKyk/W2EtekEtWiVdKikoWyovXSkoLT9cZCsoPzpcLlxkKyk/W2EtekEtWiVdKikvOwp2YXIgQUREX09SX1NVQlRSQUNUX1JFR0VYID0gLygtP1xkKyg/OlwuXGQrKT9bYS16QS1aJV0qKShbKy1dKSgtP1xkKyg/OlwuXGQrKT9bYS16QS1aJV0qKS87CnZhciBDU1NfTEVOR1RIX1VOSVRfUkVHRVggPSAvXnB4fGNtfHZofHZ3fGVtfHJlbXwlfG1tfGlufHB0fHBjfGV4fGNofHZtaW58dm1heHxRJC87CnZhciBOVU1fU1BMSVRfUkVHRVggPSAvKC0/XGQrKD86XC5cZCspPykoW2EtekEtWiVdKyk/LzsKdmFyIENPTlZFUlNJT05fUkFURVMgPSB7CiAgY206IDk2IC8gMi41NCwKICBtbTogOTYgLyAyNS40LAogIHB0OiA5NiAvIDcyLAogIHBjOiA5NiAvIDYsCiAgaW46IDk2LAogIFE6IDk2IC8gKDIuNTQgKiA0MCksCiAgcHg6IDEKfTsKdmFyIEZJWEVEX0NTU19MRU5HVEhfVU5JVFMgPSBPYmplY3Qua2V5cyhDT05WRVJTSU9OX1JBVEVTKTsKdmFyIFNUUl9OQU4gPSAiTmFOIjsKZnVuY3Rpb24gY29udmVydFRvUHgodmFsdWUsIHVuaXQyKSB7CiAgcmV0dXJuIHZhbHVlICogQ09OVkVSU0lPTl9SQVRFU1t1bml0Ml07Cn0KdmFyIERlY2ltYWxDU1MgPSBjbGFzcyBfRGVjaW1hbENTUyB7CiAgc3RhdGljIHBhcnNlKHN0cikgewogICAgdmFyIF9OVU1fU1BMSVRfUkVHRVgkZXhlYzsKICAgIHZhciBbLCBudW1TdHIsIHVuaXQyXSA9IChfTlVNX1NQTElUX1JFR0VYJGV4ZWMgPSBOVU1fU1BMSVRfUkVHRVguZXhlYyhzdHIpKSAhPT0gbnVsbCAmJiBfTlVNX1NQTElUX1JFR0VYJGV4ZWMgIT09IHZvaWQgMCA/IF9OVU1fU1BMSVRfUkVHRVgkZXhlYyA6IFtdOwogICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyhwYXJzZUZsb2F0KG51bVN0ciksIHVuaXQyICE9PSBudWxsICYmIHVuaXQyICE9PSB2b2lkIDAgPyB1bml0MiA6ICIiKTsKICB9CiAgY29uc3RydWN0b3IobnVtLCB1bml0MikgewogICAgdGhpcy5udW0gPSBudW07CiAgICB0aGlzLnVuaXQgPSB1bml0MjsKICAgIHRoaXMubnVtID0gbnVtOwogICAgdGhpcy51bml0ID0gdW5pdDI7CiAgICBpZiAoaXNOYW4obnVtKSkgewogICAgICB0aGlzLnVuaXQgPSAiIjsKICAgIH0KICAgIGlmICh1bml0MiAhPT0gIiIgJiYgIUNTU19MRU5HVEhfVU5JVF9SRUdFWC50ZXN0KHVuaXQyKSkgewogICAgICB0aGlzLm51bSA9IE5hTjsKICAgICAgdGhpcy51bml0ID0gIiI7CiAgICB9CiAgICBpZiAoRklYRURfQ1NTX0xFTkdUSF9VTklUUy5pbmNsdWRlcyh1bml0MikpIHsKICAgICAgdGhpcy5udW0gPSBjb252ZXJ0VG9QeChudW0sIHVuaXQyKTsKICAgICAgdGhpcy51bml0ID0gInB4IjsKICAgIH0KICB9CiAgYWRkKG90aGVyKSB7CiAgICBpZiAodGhpcy51bml0ICE9PSBvdGhlci51bml0KSB7CiAgICAgIHJldHVybiBuZXcgX0RlY2ltYWxDU1MoTmFOLCAiIik7CiAgICB9CiAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKHRoaXMubnVtICsgb3RoZXIubnVtLCB0aGlzLnVuaXQpOwogIH0KICBzdWJ0cmFjdChvdGhlcikgewogICAgaWYgKHRoaXMudW5pdCAhPT0gb3RoZXIudW5pdCkgewogICAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKE5hTiwgIiIpOwogICAgfQogICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyh0aGlzLm51bSAtIG90aGVyLm51bSwgdGhpcy51bml0KTsKICB9CiAgbXVsdGlwbHkob3RoZXIpIHsKICAgIGlmICh0aGlzLnVuaXQgIT09ICIiICYmIG90aGVyLnVuaXQgIT09ICIiICYmIHRoaXMudW5pdCAhPT0gb3RoZXIudW5pdCkgewogICAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKE5hTiwgIiIpOwogICAgfQogICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyh0aGlzLm51bSAqIG90aGVyLm51bSwgdGhpcy51bml0IHx8IG90aGVyLnVuaXQpOwogIH0KICBkaXZpZGUob3RoZXIpIHsKICAgIGlmICh0aGlzLnVuaXQgIT09ICIiICYmIG90aGVyLnVuaXQgIT09ICIiICYmIHRoaXMudW5pdCAhPT0gb3RoZXIudW5pdCkgewogICAgICByZXR1cm4gbmV3IF9EZWNpbWFsQ1NTKE5hTiwgIiIpOwogICAgfQogICAgcmV0dXJuIG5ldyBfRGVjaW1hbENTUyh0aGlzLm51bSAvIG90aGVyLm51bSwgdGhpcy51bml0IHx8IG90aGVyLnVuaXQpOwogIH0KICB0b1N0cmluZygpIHsKICAgIHJldHVybiAiIi5jb25jYXQodGhpcy5udW0pLmNvbmNhdCh0aGlzLnVuaXQpOwogIH0KICBpc05hTigpIHsKICAgIHJldHVybiBpc05hbih0aGlzLm51bSk7CiAgfQp9OwpmdW5jdGlvbiBjYWxjdWxhdGVBcml0aG1ldGljKGV4cHIpIHsKICBpZiAoZXhwci5pbmNsdWRlcyhTVFJfTkFOKSkgewogICAgcmV0dXJuIFNUUl9OQU47CiAgfQogIHZhciBuZXdFeHByID0gZXhwcjsKICB3aGlsZSAobmV3RXhwci5pbmNsdWRlcygiKiIpIHx8IG5ld0V4cHIuaW5jbHVkZXMoIi8iKSkgewogICAgdmFyIF9NVUxUSVBMWV9PUl9ESVZJREVfUjsKICAgIHZhciBbLCBsZWZ0T3BlcmFuZCwgb3BlcmF0b3IsIHJpZ2h0T3BlcmFuZF0gPSAoX01VTFRJUExZX09SX0RJVklERV9SID0gTVVMVElQTFlfT1JfRElWSURFX1JFR0VYLmV4ZWMobmV3RXhwcikpICE9PSBudWxsICYmIF9NVUxUSVBMWV9PUl9ESVZJREVfUiAhPT0gdm9pZCAwID8gX01VTFRJUExZX09SX0RJVklERV9SIDogW107CiAgICB2YXIgbFRzID0gRGVjaW1hbENTUy5wYXJzZShsZWZ0T3BlcmFuZCAhPT0gbnVsbCAmJiBsZWZ0T3BlcmFuZCAhPT0gdm9pZCAwID8gbGVmdE9wZXJhbmQgOiAiIik7CiAgICB2YXIgclRzID0gRGVjaW1hbENTUy5wYXJzZShyaWdodE9wZXJhbmQgIT09IG51bGwgJiYgcmlnaHRPcGVyYW5kICE9PSB2b2lkIDAgPyByaWdodE9wZXJhbmQgOiAiIik7CiAgICB2YXIgcmVzdWx0ID0gb3BlcmF0b3IgPT09ICIqIiA/IGxUcy5tdWx0aXBseShyVHMpIDogbFRzLmRpdmlkZShyVHMpOwogICAgaWYgKHJlc3VsdC5pc05hTigpKSB7CiAgICAgIHJldHVybiBTVFJfTkFOOwogICAgfQogICAgbmV3RXhwciA9IG5ld0V4cHIucmVwbGFjZShNVUxUSVBMWV9PUl9ESVZJREVfUkVHRVgsIHJlc3VsdC50b1N0cmluZygpKTsKICB9CiAgd2hpbGUgKG5ld0V4cHIuaW5jbHVkZXMoIisiKSB8fCAvLi1cZCsoPzpcLlxkKyk/Ly50ZXN0KG5ld0V4cHIpKSB7CiAgICB2YXIgX0FERF9PUl9TVUJUUkFDVF9SRUdFOwogICAgdmFyIFssIF9sZWZ0T3BlcmFuZCwgX29wZXJhdG9yLCBfcmlnaHRPcGVyYW5kXSA9IChfQUREX09SX1NVQlRSQUNUX1JFR0UgPSBBRERfT1JfU1VCVFJBQ1RfUkVHRVguZXhlYyhuZXdFeHByKSkgIT09IG51bGwgJiYgX0FERF9PUl9TVUJUUkFDVF9SRUdFICE9PSB2b2lkIDAgPyBfQUREX09SX1NVQlRSQUNUX1JFR0UgOiBbXTsKICAgIHZhciBfbFRzID0gRGVjaW1hbENTUy5wYXJzZShfbGVmdE9wZXJhbmQgIT09IG51bGwgJiYgX2xlZnRPcGVyYW5kICE9PSB2b2lkIDAgPyBfbGVmdE9wZXJhbmQgOiAiIik7CiAgICB2YXIgX3JUcyA9IERlY2ltYWxDU1MucGFyc2UoX3JpZ2h0T3BlcmFuZCAhPT0gbnVsbCAmJiBfcmlnaHRPcGVyYW5kICE9PSB2b2lkIDAgPyBfcmlnaHRPcGVyYW5kIDogIiIpOwogICAgdmFyIF9yZXN1bHQgPSBfb3BlcmF0b3IgPT09ICIrIiA/IF9sVHMuYWRkKF9yVHMpIDogX2xUcy5zdWJ0cmFjdChfclRzKTsKICAgIGlmIChfcmVzdWx0LmlzTmFOKCkpIHsKICAgICAgcmV0dXJuIFNUUl9OQU47CiAgICB9CiAgICBuZXdFeHByID0gbmV3RXhwci5yZXBsYWNlKEFERF9PUl9TVUJUUkFDVF9SRUdFWCwgX3Jlc3VsdC50b1N0cmluZygpKTsKICB9CiAgcmV0dXJuIG5ld0V4cHI7Cn0KdmFyIFBBUkVOVEhFU0VTX1JFR0VYID0gL1woKFteKCldKilcKS87CmZ1bmN0aW9uIGNhbGN1bGF0ZVBhcmVudGhlc2VzKGV4cHIpIHsKICB2YXIgbmV3RXhwciA9IGV4cHI7CiAgdmFyIG1hdGNoOwogIHdoaWxlICgobWF0Y2ggPSBQQVJFTlRIRVNFU19SRUdFWC5leGVjKG5ld0V4cHIpKSAhPSBudWxsKSB7CiAgICB2YXIgWywgcGFyZW50aGV0aWNhbEV4cHJlc3Npb25dID0gbWF0Y2g7CiAgICBuZXdFeHByID0gbmV3RXhwci5yZXBsYWNlKFBBUkVOVEhFU0VTX1JFR0VYLCBjYWxjdWxhdGVBcml0aG1ldGljKHBhcmVudGhldGljYWxFeHByZXNzaW9uKSk7CiAgfQogIHJldHVybiBuZXdFeHByOwp9CmZ1bmN0aW9uIGV2YWx1YXRlRXhwcmVzc2lvbihleHByZXNzaW9uKSB7CiAgdmFyIG5ld0V4cHIgPSBleHByZXNzaW9uLnJlcGxhY2UoL1xzKy9nLCAiIik7CiAgbmV3RXhwciA9IGNhbGN1bGF0ZVBhcmVudGhlc2VzKG5ld0V4cHIpOwogIG5ld0V4cHIgPSBjYWxjdWxhdGVBcml0aG1ldGljKG5ld0V4cHIpOwogIHJldHVybiBuZXdFeHByOwp9CmZ1bmN0aW9uIHNhZmVFdmFsdWF0ZUV4cHJlc3Npb24oZXhwcmVzc2lvbikgewogIHRyeSB7CiAgICByZXR1cm4gZXZhbHVhdGVFeHByZXNzaW9uKGV4cHJlc3Npb24pOwogIH0gY2F0Y2ggKF91bnVzZWQpIHsKICAgIHJldHVybiBTVFJfTkFOOwogIH0KfQpmdW5jdGlvbiByZWR1Y2VDU1NDYWxjKGV4cHJlc3Npb24pIHsKICB2YXIgcmVzdWx0ID0gc2FmZUV2YWx1YXRlRXhwcmVzc2lvbihleHByZXNzaW9uLnNsaWNlKDUsIC0xKSk7CiAgaWYgKHJlc3VsdCA9PT0gU1RSX05BTikgewogICAgcmV0dXJuICIiOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvVGV4dC5qcwp2YXIgX2V4Y2x1ZGVkNiA9IFsieCIsICJ5IiwgImxpbmVIZWlnaHQiLCAiY2FwSGVpZ2h0IiwgImZpbGwiLCAic2NhbGVUb0ZpdCIsICJ0ZXh0QW5jaG9yIiwgInZlcnRpY2FsQW5jaG9yIl07CnZhciBfZXhjbHVkZWQyMyA9IFsiZHgiLCAiZHkiLCAiYW5nbGUiLCAiY2xhc3NOYW1lIiwgImJyZWFrQWxsIl07CmZ1bmN0aW9uIF9leHRlbmRzMTAoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTAgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczEwLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNihlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNihlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlNihyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIEJSRUFLSU5HX1NQQUNFUyA9IC9bIFxmXG5cclx0XHZcdTIwMjhcdTIwMjldKy87CnZhciBjYWxjdWxhdGVXb3JkV2lkdGhzID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuLAogICAgYnJlYWtBbGwsCiAgICBzdHlsZQogIH0gPSBfcmVmMjsKICB0cnkgewogICAgdmFyIHdvcmRzID0gW107CiAgICBpZiAoIWlzTnVsbGlzaChjaGlsZHJlbikpIHsKICAgICAgaWYgKGJyZWFrQWxsKSB7CiAgICAgICAgd29yZHMgPSBjaGlsZHJlbi50b1N0cmluZygpLnNwbGl0KCIiKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB3b3JkcyA9IGNoaWxkcmVuLnRvU3RyaW5nKCkuc3BsaXQoQlJFQUtJTkdfU1BBQ0VTKTsKICAgICAgfQogICAgfQogICAgdmFyIHdvcmRzV2l0aENvbXB1dGVkV2lkdGggPSB3b3Jkcy5tYXAoKHdvcmQpID0+ICh7CiAgICAgIHdvcmQsCiAgICAgIHdpZHRoOiBnZXRTdHJpbmdTaXplKHdvcmQsIHN0eWxlKS53aWR0aAogICAgfSkpOwogICAgdmFyIHNwYWNlV2lkdGggPSBicmVha0FsbCA/IDAgOiBnZXRTdHJpbmdTaXplKCJceEEwIiwgc3R5bGUpLndpZHRoOwogICAgcmV0dXJuIHsKICAgICAgd29yZHNXaXRoQ29tcHV0ZWRXaWR0aCwKICAgICAgc3BhY2VXaWR0aAogICAgfTsKICB9IGNhdGNoIChfdW51c2VkKSB7CiAgICByZXR1cm4gbnVsbDsKICB9Cn07CmZ1bmN0aW9uIGlzVmFsaWRUZXh0QW5jaG9yKHZhbHVlKSB7CiAgcmV0dXJuIHZhbHVlID09PSAic3RhcnQiIHx8IHZhbHVlID09PSAibWlkZGxlIiB8fCB2YWx1ZSA9PT0gImVuZCIgfHwgdmFsdWUgPT09ICJpbmhlcml0IjsKfQp2YXIgY2FsY3VsYXRlID0gKHdvcmRzLCBsaW5lV2lkdGgsIHNwYWNlV2lkdGgsIHNjYWxlVG9GaXQpID0+IHdvcmRzLnJlZHVjZSgocmVzdWx0LCBfcmVmMikgPT4gewogIHZhciB7CiAgICB3b3JkLAogICAgd2lkdGgKICB9ID0gX3JlZjI7CiAgdmFyIGN1cnJlbnRMaW5lID0gcmVzdWx0W3Jlc3VsdC5sZW5ndGggLSAxXTsKICBpZiAoY3VycmVudExpbmUgJiYgd2lkdGggIT0gbnVsbCAmJiAobGluZVdpZHRoID09IG51bGwgfHwgc2NhbGVUb0ZpdCB8fCBjdXJyZW50TGluZS53aWR0aCArIHdpZHRoICsgc3BhY2VXaWR0aCA8IE51bWJlcihsaW5lV2lkdGgpKSkgewogICAgY3VycmVudExpbmUud29yZHMucHVzaCh3b3JkKTsKICAgIGN1cnJlbnRMaW5lLndpZHRoICs9IHdpZHRoICsgc3BhY2VXaWR0aDsKICB9IGVsc2UgewogICAgdmFyIG5ld0xpbmUgPSB7CiAgICAgIHdvcmRzOiBbd29yZF0sCiAgICAgIHdpZHRoCiAgICB9OwogICAgcmVzdWx0LnB1c2gobmV3TGluZSk7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0sIFtdKTsKdmFyIGZpbmRMb25nZXN0TGluZSA9ICh3b3JkcykgPT4gd29yZHMucmVkdWNlKChhLCBiKSA9PiBhLndpZHRoID4gYi53aWR0aCA/IGEgOiBiKTsKdmFyIHN1ZmZpeCA9ICJcdTIwMjYiOwp2YXIgY2hlY2tPdmVyZmxvdyA9ICh0ZXh0LCBpbmRleCwgYnJlYWtBbGwsIHN0eWxlLCBtYXhMaW5lcywgbGluZVdpZHRoLCBzcGFjZVdpZHRoLCBzY2FsZVRvRml0KSA9PiB7CiAgdmFyIHRlbXBUZXh0ID0gdGV4dC5zbGljZSgwLCBpbmRleCk7CiAgdmFyIHdvcmRzID0gY2FsY3VsYXRlV29yZFdpZHRocyh7CiAgICBicmVha0FsbCwKICAgIHN0eWxlLAogICAgY2hpbGRyZW46IHRlbXBUZXh0ICsgc3VmZml4CiAgfSk7CiAgaWYgKCF3b3JkcykgewogICAgcmV0dXJuIFtmYWxzZSwgW11dOwogIH0KICB2YXIgcmVzdWx0ID0gY2FsY3VsYXRlKHdvcmRzLndvcmRzV2l0aENvbXB1dGVkV2lkdGgsIGxpbmVXaWR0aCwgc3BhY2VXaWR0aCwgc2NhbGVUb0ZpdCk7CiAgdmFyIGRvZXNPdmVyZmxvdyA9IHJlc3VsdC5sZW5ndGggPiBtYXhMaW5lcyB8fCBmaW5kTG9uZ2VzdExpbmUocmVzdWx0KS53aWR0aCA+IE51bWJlcihsaW5lV2lkdGgpOwogIHJldHVybiBbZG9lc092ZXJmbG93LCByZXN1bHRdOwp9Owp2YXIgY2FsY3VsYXRlV29yZHNCeUxpbmVzID0gKF9yZWYzLCBpbml0aWFsV29yZHNXaXRoQ29tcHV0ZWRXaXRoLCBzcGFjZVdpZHRoLCBsaW5lV2lkdGgsIHNjYWxlVG9GaXQpID0+IHsKICB2YXIgewogICAgbWF4TGluZXMsCiAgICBjaGlsZHJlbiwKICAgIHN0eWxlLAogICAgYnJlYWtBbGwKICB9ID0gX3JlZjM7CiAgdmFyIHNob3VsZExpbWl0TGluZXMgPSBpc051bWJlcihtYXhMaW5lcyk7CiAgdmFyIHRleHQgPSBTdHJpbmcoY2hpbGRyZW4pOwogIHZhciBvcmlnaW5hbFJlc3VsdCA9IGNhbGN1bGF0ZShpbml0aWFsV29yZHNXaXRoQ29tcHV0ZWRXaXRoLCBsaW5lV2lkdGgsIHNwYWNlV2lkdGgsIHNjYWxlVG9GaXQpOwogIGlmICghc2hvdWxkTGltaXRMaW5lcyB8fCBzY2FsZVRvRml0KSB7CiAgICByZXR1cm4gb3JpZ2luYWxSZXN1bHQ7CiAgfQogIHZhciBvdmVyZmxvd3MgPSBvcmlnaW5hbFJlc3VsdC5sZW5ndGggPiBtYXhMaW5lcyB8fCBmaW5kTG9uZ2VzdExpbmUob3JpZ2luYWxSZXN1bHQpLndpZHRoID4gTnVtYmVyKGxpbmVXaWR0aCk7CiAgaWYgKCFvdmVyZmxvd3MpIHsKICAgIHJldHVybiBvcmlnaW5hbFJlc3VsdDsKICB9CiAgdmFyIHN0YXJ0ID0gMDsKICB2YXIgZW5kID0gdGV4dC5sZW5ndGggLSAxOwogIHZhciBpdGVyYXRpb25zID0gMDsKICB2YXIgdHJpbW1lZFJlc3VsdDsKICB3aGlsZSAoc3RhcnQgPD0gZW5kICYmIGl0ZXJhdGlvbnMgPD0gdGV4dC5sZW5ndGggLSAxKSB7CiAgICB2YXIgbWlkZGxlID0gTWF0aC5mbG9vcigoc3RhcnQgKyBlbmQpIC8gMik7CiAgICB2YXIgcHJldiA9IG1pZGRsZSAtIDE7CiAgICB2YXIgW2RvZXNQcmV2T3ZlcmZsb3csIHJlc3VsdF0gPSBjaGVja092ZXJmbG93KHRleHQsIHByZXYsIGJyZWFrQWxsLCBzdHlsZSwgbWF4TGluZXMsIGxpbmVXaWR0aCwgc3BhY2VXaWR0aCwgc2NhbGVUb0ZpdCk7CiAgICB2YXIgW2RvZXNNaWRkbGVPdmVyZmxvd10gPSBjaGVja092ZXJmbG93KHRleHQsIG1pZGRsZSwgYnJlYWtBbGwsIHN0eWxlLCBtYXhMaW5lcywgbGluZVdpZHRoLCBzcGFjZVdpZHRoLCBzY2FsZVRvRml0KTsKICAgIGlmICghZG9lc1ByZXZPdmVyZmxvdyAmJiAhZG9lc01pZGRsZU92ZXJmbG93KSB7CiAgICAgIHN0YXJ0ID0gbWlkZGxlICsgMTsKICAgIH0KICAgIGlmIChkb2VzUHJldk92ZXJmbG93ICYmIGRvZXNNaWRkbGVPdmVyZmxvdykgewogICAgICBlbmQgPSBtaWRkbGUgLSAxOwogICAgfQogICAgaWYgKCFkb2VzUHJldk92ZXJmbG93ICYmIGRvZXNNaWRkbGVPdmVyZmxvdykgewogICAgICB0cmltbWVkUmVzdWx0ID0gcmVzdWx0OwogICAgICBicmVhazsKICAgIH0KICAgIGl0ZXJhdGlvbnMrKzsKICB9CiAgcmV0dXJuIHRyaW1tZWRSZXN1bHQgfHwgb3JpZ2luYWxSZXN1bHQ7Cn07CnZhciBnZXRXb3Jkc1dpdGhvdXRDYWxjdWxhdGUgPSAoY2hpbGRyZW4pID0+IHsKICB2YXIgd29yZHMgPSAhaXNOdWxsaXNoKGNoaWxkcmVuKSA/IGNoaWxkcmVuLnRvU3RyaW5nKCkuc3BsaXQoQlJFQUtJTkdfU1BBQ0VTKSA6IFtdOwogIHJldHVybiBbewogICAgd29yZHMsCiAgICB3aWR0aDogdm9pZCAwCiAgfV07Cn07CnZhciBnZXRXb3Jkc0J5TGluZXMgPSAoX3JlZjQpID0+IHsKICB2YXIgewogICAgd2lkdGgsCiAgICBzY2FsZVRvRml0LAogICAgY2hpbGRyZW4sCiAgICBzdHlsZSwKICAgIGJyZWFrQWxsLAogICAgbWF4TGluZXMKICB9ID0gX3JlZjQ7CiAgaWYgKCh3aWR0aCB8fCBzY2FsZVRvRml0KSAmJiAhR2xvYmFsLmlzU3NyKSB7CiAgICB2YXIgd29yZHNXaXRoQ29tcHV0ZWRXaWR0aCwgc3BhY2VXaWR0aDsKICAgIHZhciB3b3JkV2lkdGhzID0gY2FsY3VsYXRlV29yZFdpZHRocyh7CiAgICAgIGJyZWFrQWxsLAogICAgICBjaGlsZHJlbiwKICAgICAgc3R5bGUKICAgIH0pOwogICAgaWYgKHdvcmRXaWR0aHMpIHsKICAgICAgdmFyIHsKICAgICAgICB3b3Jkc1dpdGhDb21wdXRlZFdpZHRoOiB3Y3csCiAgICAgICAgc3BhY2VXaWR0aDogc3cKICAgICAgfSA9IHdvcmRXaWR0aHM7CiAgICAgIHdvcmRzV2l0aENvbXB1dGVkV2lkdGggPSB3Y3c7CiAgICAgIHNwYWNlV2lkdGggPSBzdzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBnZXRXb3Jkc1dpdGhvdXRDYWxjdWxhdGUoY2hpbGRyZW4pOwogICAgfQogICAgcmV0dXJuIGNhbGN1bGF0ZVdvcmRzQnlMaW5lcyh7CiAgICAgIGJyZWFrQWxsLAogICAgICBjaGlsZHJlbiwKICAgICAgbWF4TGluZXMsCiAgICAgIHN0eWxlCiAgICB9LCB3b3Jkc1dpdGhDb21wdXRlZFdpZHRoLCBzcGFjZVdpZHRoLCB3aWR0aCwgQm9vbGVhbihzY2FsZVRvRml0KSk7CiAgfQogIHJldHVybiBnZXRXb3Jkc1dpdGhvdXRDYWxjdWxhdGUoY2hpbGRyZW4pOwp9Owp2YXIgREVGQVVMVF9GSUxMID0gIiM4MDgwODAiOwp2YXIgdGV4dERlZmF1bHRQcm9wcyA9IHsKICBhbmdsZTogMCwKICBicmVha0FsbDogZmFsc2UsCiAgLy8gTWFnaWMgbnVtYmVyIGZyb20gZDMKICBjYXBIZWlnaHQ6ICIwLjcxZW0iLAogIGZpbGw6IERFRkFVTFRfRklMTCwKICBsaW5lSGVpZ2h0OiAiMWVtIiwKICBzY2FsZVRvRml0OiBmYWxzZSwKICB0ZXh0QW5jaG9yOiAic3RhcnQiLAogIC8vIE1haW50YWluIGNvbXBhdCB3aXRoIGV4aXN0aW5nIGNoYXJ0cyAvIGRlZmF1bHQgU1ZHIGJlaGF2aW9yCiAgdmVydGljYWxBbmNob3I6ICJlbmQiLAogIHg6IDAsCiAgeTogMAp9Owp2YXIgVGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjUuZm9yd2FyZFJlZikoKG91dHNpZGVQcm9wcywgcmVmKSA9PiB7CiAgdmFyIF9yZXNvbHZlRGVmYXVsdFByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhvdXRzaWRlUHJvcHMsIHRleHREZWZhdWx0UHJvcHMpLCB7CiAgICB4OiBwcm9wc1gsCiAgICB5OiBwcm9wc1ksCiAgICBsaW5lSGVpZ2h0LAogICAgY2FwSGVpZ2h0LAogICAgZmlsbCwKICAgIHNjYWxlVG9GaXQsCiAgICB0ZXh0QW5jaG9yLAogICAgdmVydGljYWxBbmNob3IKICB9ID0gX3Jlc29sdmVEZWZhdWx0UHJvcHMsIHByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNihfcmVzb2x2ZURlZmF1bHRQcm9wcywgX2V4Y2x1ZGVkNik7CiAgdmFyIHdvcmRzQnlMaW5lcyA9ICgwLCBpbXBvcnRfcmVhY3QyNS51c2VNZW1vKSgoKSA9PiB7CiAgICByZXR1cm4gZ2V0V29yZHNCeUxpbmVzKHsKICAgICAgYnJlYWtBbGw6IHByb3BzLmJyZWFrQWxsLAogICAgICBjaGlsZHJlbjogcHJvcHMuY2hpbGRyZW4sCiAgICAgIG1heExpbmVzOiBwcm9wcy5tYXhMaW5lcywKICAgICAgc2NhbGVUb0ZpdCwKICAgICAgc3R5bGU6IHByb3BzLnN0eWxlLAogICAgICB3aWR0aDogcHJvcHMud2lkdGgKICAgIH0pOwogIH0sIFtwcm9wcy5icmVha0FsbCwgcHJvcHMuY2hpbGRyZW4sIHByb3BzLm1heExpbmVzLCBzY2FsZVRvRml0LCBwcm9wcy5zdHlsZSwgcHJvcHMud2lkdGhdKTsKICB2YXIgewogICAgZHgsCiAgICBkeSwKICAgIGFuZ2xlLAogICAgY2xhc3NOYW1lLAogICAgYnJlYWtBbGwKICB9ID0gcHJvcHMsIHRleHRQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczYocHJvcHMsIF9leGNsdWRlZDIzKTsKICBpZiAoIWlzTnVtT3JTdHIocHJvcHNYKSB8fCAhaXNOdW1PclN0cihwcm9wc1kpIHx8IHdvcmRzQnlMaW5lcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgeDIgPSBOdW1iZXIocHJvcHNYKSArIChpc051bWJlcihkeCkgPyBkeCA6IDApOwogIHZhciB5MiA9IE51bWJlcihwcm9wc1kpICsgKGlzTnVtYmVyKGR5KSA/IGR5IDogMCk7CiAgaWYgKCFpc1dlbGxCZWhhdmVkTnVtYmVyKHgyKSB8fCAhaXNXZWxsQmVoYXZlZE51bWJlcih5MikpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgc3RhcnREeTsKICBzd2l0Y2ggKHZlcnRpY2FsQW5jaG9yKSB7CiAgICBjYXNlICJzdGFydCI6CiAgICAgIHN0YXJ0RHkgPSByZWR1Y2VDU1NDYWxjKCJjYWxjKCIuY29uY2F0KGNhcEhlaWdodCwgIikiKSk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAibWlkZGxlIjoKICAgICAgc3RhcnREeSA9IHJlZHVjZUNTU0NhbGMoImNhbGMoIi5jb25jYXQoKHdvcmRzQnlMaW5lcy5sZW5ndGggLSAxKSAvIDIsICIgKiAtIikuY29uY2F0KGxpbmVIZWlnaHQsICIgKyAoIikuY29uY2F0KGNhcEhlaWdodCwgIiAvIDIpKSIpKTsKICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICBzdGFydER5ID0gcmVkdWNlQ1NTQ2FsYygiY2FsYygiLmNvbmNhdCh3b3Jkc0J5TGluZXMubGVuZ3RoIC0gMSwgIiAqIC0iKS5jb25jYXQobGluZUhlaWdodCwgIikiKSk7CiAgICAgIGJyZWFrOwogIH0KICB2YXIgdHJhbnNmb3JtcyA9IFtdOwogIGlmIChzY2FsZVRvRml0KSB7CiAgICB2YXIgbGluZVdpZHRoID0gd29yZHNCeUxpbmVzWzBdLndpZHRoOwogICAgdmFyIHsKICAgICAgd2lkdGgKICAgIH0gPSBwcm9wczsKICAgIHRyYW5zZm9ybXMucHVzaCgic2NhbGUoIi5jb25jYXQoaXNOdW1iZXIod2lkdGgpICYmIGlzTnVtYmVyKGxpbmVXaWR0aCkgPyB3aWR0aCAvIGxpbmVXaWR0aCA6IDEsICIpIikpOwogIH0KICBpZiAoYW5nbGUpIHsKICAgIHRyYW5zZm9ybXMucHVzaCgicm90YXRlKCIuY29uY2F0KGFuZ2xlLCAiLCAiKS5jb25jYXQoeDIsICIsICIpLmNvbmNhdCh5MiwgIikiKSk7CiAgfQogIGlmICh0cmFuc2Zvcm1zLmxlbmd0aCkgewogICAgdGV4dFByb3BzLnRyYW5zZm9ybSA9IHRyYW5zZm9ybXMuam9pbigiICIpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTMuY3JlYXRlRWxlbWVudCgidGV4dCIsIF9leHRlbmRzMTAoe30sIHN2Z1Byb3BlcnRpZXNBbmRFdmVudHModGV4dFByb3BzKSwgewogICAgcmVmLAogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtdGV4dCIsIGNsYXNzTmFtZSksCiAgICB0ZXh0QW5jaG9yLAogICAgZmlsbDogZmlsbC5pbmNsdWRlcygidXJsIikgPyBERUZBVUxUX0ZJTEwgOiBmaWxsCiAgfSksIHdvcmRzQnlMaW5lcy5tYXAoKGxpbmUsIGluZGV4KSA9PiB7CiAgICB2YXIgd29yZHMgPSBsaW5lLndvcmRzLmpvaW4oYnJlYWtBbGwgPyAiIiA6ICIgIik7CiAgICByZXR1cm4gKAogICAgICAvLyBkdXBsaWNhdGUgd29yZHMgd2lsbCBjYXVzZSBkdXBsaWNhdGUga2V5cyB3aGljaCBpcyB3aHkgd2UgYWRkIHRoZSBhcnJheSBpbmRleCBoZXJlCiAgICAgIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDEzLmNyZWF0ZUVsZW1lbnQoInRzcGFuIiwgewogICAgICAgIHg6IHgyLAogICAgICAgIGR5OiBpbmRleCA9PT0gMCA/IHN0YXJ0RHkgOiBsaW5lSGVpZ2h0LAogICAgICAgIGtleTogIiIuY29uY2F0KHdvcmRzLCAiLSIpLmNvbmNhdChpbmRleCkKICAgICAgfSwgd29yZHMpCiAgICApOwogIH0pKTsKfSk7ClRleHQuZGlzcGxheU5hbWUgPSAiVGV4dCI7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvTGFiZWwuanMKdmFyIFJlYWN0MTQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QyNiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIF9leGNsdWRlZDcgPSBbImxhYmVsUmVmIl07CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczcoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTcoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTcocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIG93bktleXMyMyhlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDIzKGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjMoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI0KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czIzKE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyNChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI0KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI0KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI0KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI0KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQpmdW5jdGlvbiBfZXh0ZW5kczExKCkgewogIHJldHVybiBfZXh0ZW5kczExID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxMS5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciBDYXJ0ZXNpYW5MYWJlbENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmNyZWF0ZUNvbnRleHQpKG51bGwpOwp2YXIgQ2FydGVzaWFuTGFiZWxDb250ZXh0UHJvdmlkZXIgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHVwcGVyV2lkdGgsCiAgICBsb3dlcldpZHRoLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBjaGlsZHJlbgogIH0gPSBfcmVmMjsKICB2YXIgdmlld0JveCA9ICgwLCBpbXBvcnRfcmVhY3QyNi51c2VNZW1vKSgoKSA9PiAoewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHVwcGVyV2lkdGgsCiAgICBsb3dlcldpZHRoLAogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9KSwgW3gyLCB5MiwgdXBwZXJXaWR0aCwgbG93ZXJXaWR0aCwgd2lkdGgsIGhlaWdodF0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkxhYmVsQ29udGV4dC5Qcm92aWRlciwgewogICAgdmFsdWU6IHZpZXdCb3gKICB9LCBjaGlsZHJlbik7Cn07CnZhciB1c2VDYXJ0ZXNpYW5MYWJlbENvbnRleHQgPSAoKSA9PiB7CiAgdmFyIGxhYmVsQ2hpbGRDb250ZXh0ID0gKDAsIGltcG9ydF9yZWFjdDI2LnVzZUNvbnRleHQpKENhcnRlc2lhbkxhYmVsQ29udGV4dCk7CiAgdmFyIGNoYXJ0Q29udGV4dCA9IHVzZVZpZXdCb3goKTsKICByZXR1cm4gbGFiZWxDaGlsZENvbnRleHQgfHwgY2FydGVzaWFuVmlld0JveFRvVHJhcGV6b2lkKGNoYXJ0Q29udGV4dCk7Cn07CnZhciBQb2xhckxhYmVsQ29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuY3JlYXRlQ29udGV4dCkobnVsbCk7CnZhciB1c2VQb2xhckxhYmVsQ29udGV4dCA9ICgpID0+IHsKICB2YXIgbGFiZWxDaGlsZENvbnRleHQgPSAoMCwgaW1wb3J0X3JlYWN0MjYudXNlQ29udGV4dCkoUG9sYXJMYWJlbENvbnRleHQpOwogIHZhciBjaGFydENvbnRleHQgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RQb2xhclZpZXdCb3gpOwogIHJldHVybiBsYWJlbENoaWxkQ29udGV4dCB8fCBjaGFydENvbnRleHQ7Cn07CnZhciBnZXRMYWJlbCA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICB2YWx1ZSwKICAgIGZvcm1hdHRlcgogIH0gPSBwcm9wczsKICB2YXIgbGFiZWwgPSBpc051bGxpc2gocHJvcHMuY2hpbGRyZW4pID8gdmFsdWUgOiBwcm9wcy5jaGlsZHJlbjsKICBpZiAodHlwZW9mIGZvcm1hdHRlciA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIGZvcm1hdHRlcihsYWJlbCk7CiAgfQogIHJldHVybiBsYWJlbDsKfTsKdmFyIGlzTGFiZWxDb250ZW50QUZ1bmN0aW9uID0gKGNvbnRlbnQpID0+IHsKICByZXR1cm4gY29udGVudCAhPSBudWxsICYmIHR5cGVvZiBjb250ZW50ID09PSAiZnVuY3Rpb24iOwp9Owp2YXIgZ2V0RGVsdGFBbmdsZTIgPSAoc3RhcnRBbmdsZSwgZW5kQW5nbGUpID0+IHsKICB2YXIgc2lnbjIgPSBtYXRoU2lnbihlbmRBbmdsZSAtIHN0YXJ0QW5nbGUpOwogIHZhciBkZWx0YUFuZ2xlID0gTWF0aC5taW4oTWF0aC5hYnMoZW5kQW5nbGUgLSBzdGFydEFuZ2xlKSwgMzYwKTsKICByZXR1cm4gc2lnbjIgKiBkZWx0YUFuZ2xlOwp9Owp2YXIgcmVuZGVyUmFkaWFsTGFiZWwgPSAobGFiZWxQcm9wcywgcG9zaXRpb24sIGxhYmVsLCBhdHRycywgdmlld0JveCkgPT4gewogIHZhciB7CiAgICBvZmZzZXQsCiAgICBjbGFzc05hbWUKICB9ID0gbGFiZWxQcm9wczsKICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIGlubmVyUmFkaXVzLAogICAgb3V0ZXJSYWRpdXMsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUsCiAgICBjbG9ja1dpc2UKICB9ID0gdmlld0JveDsKICB2YXIgcmFkaXVzID0gKGlubmVyUmFkaXVzICsgb3V0ZXJSYWRpdXMpIC8gMjsKICB2YXIgZGVsdGFBbmdsZSA9IGdldERlbHRhQW5nbGUyKHN0YXJ0QW5nbGUsIGVuZEFuZ2xlKTsKICB2YXIgc2lnbjIgPSBkZWx0YUFuZ2xlID49IDAgPyAxIDogLTE7CiAgdmFyIGxhYmVsQW5nbGUsIGRpcmVjdGlvbjsKICBzd2l0Y2ggKHBvc2l0aW9uKSB7CiAgICBjYXNlICJpbnNpZGVTdGFydCI6CiAgICAgIGxhYmVsQW5nbGUgPSBzdGFydEFuZ2xlICsgc2lnbjIgKiBvZmZzZXQ7CiAgICAgIGRpcmVjdGlvbiA9IGNsb2NrV2lzZTsKICAgICAgYnJlYWs7CiAgICBjYXNlICJpbnNpZGVFbmQiOgogICAgICBsYWJlbEFuZ2xlID0gZW5kQW5nbGUgLSBzaWduMiAqIG9mZnNldDsKICAgICAgZGlyZWN0aW9uID0gIWNsb2NrV2lzZTsKICAgICAgYnJlYWs7CiAgICBjYXNlICJlbmQiOgogICAgICBsYWJlbEFuZ2xlID0gZW5kQW5nbGUgKyBzaWduMiAqIG9mZnNldDsKICAgICAgZGlyZWN0aW9uID0gY2xvY2tXaXNlOwogICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcigiVW5zdXBwb3J0ZWQgcG9zaXRpb24gIi5jb25jYXQocG9zaXRpb24pKTsKICB9CiAgZGlyZWN0aW9uID0gZGVsdGFBbmdsZSA8PSAwID8gZGlyZWN0aW9uIDogIWRpcmVjdGlvbjsKICB2YXIgc3RhcnRQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCByYWRpdXMsIGxhYmVsQW5nbGUpOwogIHZhciBlbmRQb2ludCA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCByYWRpdXMsIGxhYmVsQW5nbGUgKyAoZGlyZWN0aW9uID8gMSA6IC0xKSAqIDM1OSk7CiAgdmFyIHBhdGgyID0gIk0iLmNvbmNhdChzdGFydFBvaW50LngsICIsIikuY29uY2F0KHN0YXJ0UG9pbnQueSwgIlxuICAgIEEiKS5jb25jYXQocmFkaXVzLCAiLCIpLmNvbmNhdChyYWRpdXMsICIsMCwxLCIpLmNvbmNhdChkaXJlY3Rpb24gPyAwIDogMSwgIixcbiAgICAiKS5jb25jYXQoZW5kUG9pbnQueCwgIiwiKS5jb25jYXQoZW5kUG9pbnQueSk7CiAgdmFyIGlkID0gaXNOdWxsaXNoKGxhYmVsUHJvcHMuaWQpID8gdW5pcXVlSWQoInJlY2hhcnRzLXJhZGlhbC1saW5lLSIpIDogbGFiZWxQcm9wcy5pZDsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudCgidGV4dCIsIF9leHRlbmRzMTEoe30sIGF0dHJzLCB7CiAgICBkb21pbmFudEJhc2VsaW5lOiAiY2VudHJhbCIsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLXJhZGlhbC1iYXItbGFiZWwiLCBjbGFzc05hbWUpCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoImRlZnMiLCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KCJwYXRoIiwgewogICAgaWQsCiAgICBkOiBwYXRoMgogIH0pKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudCgidGV4dFBhdGgiLCB7CiAgICB4bGlua0hyZWY6ICIjIi5jb25jYXQoaWQpCiAgfSwgbGFiZWwpKTsKfTsKdmFyIGdldEF0dHJzT2ZQb2xhckxhYmVsID0gKHZpZXdCb3gsIG9mZnNldCwgcG9zaXRpb24pID0+IHsKICB2YXIgewogICAgY3gsCiAgICBjeSwKICAgIGlubmVyUmFkaXVzLAogICAgb3V0ZXJSYWRpdXMsCiAgICBzdGFydEFuZ2xlLAogICAgZW5kQW5nbGUKICB9ID0gdmlld0JveDsKICB2YXIgbWlkQW5nbGUgPSAoc3RhcnRBbmdsZSArIGVuZEFuZ2xlKSAvIDI7CiAgaWYgKHBvc2l0aW9uID09PSAib3V0c2lkZSIpIHsKICAgIHZhciB7CiAgICAgIHg6IF94LAogICAgICB5OiBfeQogICAgfSA9IHBvbGFyVG9DYXJ0ZXNpYW4oY3gsIGN5LCBvdXRlclJhZGl1cyArIG9mZnNldCwgbWlkQW5nbGUpOwogICAgcmV0dXJuIHsKICAgICAgeDogX3gsCiAgICAgIHk6IF95LAogICAgICB0ZXh0QW5jaG9yOiBfeCA+PSBjeCA/ICJzdGFydCIgOiAiZW5kIiwKICAgICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgICB9OwogIH0KICBpZiAocG9zaXRpb24gPT09ICJjZW50ZXIiKSB7CiAgICByZXR1cm4gewogICAgICB4OiBjeCwKICAgICAgeTogY3ksCiAgICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICAgIH07CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImNlbnRlclRvcCIpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IGN4LAogICAgICB5OiBjeSwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAic3RhcnQiCiAgICB9OwogIH0KICBpZiAocG9zaXRpb24gPT09ICJjZW50ZXJCb3R0b20iKSB7CiAgICByZXR1cm4gewogICAgICB4OiBjeCwKICAgICAgeTogY3ksCiAgICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogImVuZCIKICAgIH07CiAgfQogIHZhciByMiA9IChpbm5lclJhZGl1cyArIG91dGVyUmFkaXVzKSAvIDI7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIKICB9ID0gcG9sYXJUb0NhcnRlc2lhbihjeCwgY3ksIHIyLCBtaWRBbmdsZSk7CiAgcmV0dXJuIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogIH07Cn07CnZhciBpc1BvbGFyID0gKHZpZXdCb3gpID0+ICJjeCIgaW4gdmlld0JveCAmJiBpc051bWJlcih2aWV3Qm94LmN4KTsKdmFyIGdldEF0dHJzT2ZDYXJ0ZXNpYW5MYWJlbCA9IChwcm9wcywgdmlld0JveCkgPT4gewogIHZhciB7CiAgICBwYXJlbnRWaWV3Qm94OiBwYXJlbnRWaWV3Qm94RnJvbVByb3BzLAogICAgb2Zmc2V0LAogICAgcG9zaXRpb24KICB9ID0gcHJvcHM7CiAgdmFyIHBhcmVudFZpZXdCb3g7CiAgaWYgKHBhcmVudFZpZXdCb3hGcm9tUHJvcHMgIT0gbnVsbCAmJiAhaXNQb2xhcihwYXJlbnRWaWV3Qm94RnJvbVByb3BzKSkgewogICAgcGFyZW50Vmlld0JveCA9IHBhcmVudFZpZXdCb3hGcm9tUHJvcHM7CiAgfQogIHZhciB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgdXBwZXJXaWR0aCwKICAgIGxvd2VyV2lkdGgsCiAgICBoZWlnaHQKICB9ID0gdmlld0JveDsKICB2YXIgdXBwZXJYID0geDI7CiAgdmFyIGxvd2VyWCA9IHgyICsgKHVwcGVyV2lkdGggLSBsb3dlcldpZHRoKSAvIDI7CiAgdmFyIG1pZGRsZVggPSAodXBwZXJYICsgbG93ZXJYKSAvIDI7CiAgdmFyIG1pZEhlaWdodFdpZHRoID0gKHVwcGVyV2lkdGggKyBsb3dlcldpZHRoKSAvIDI7CiAgdmFyIGNlbnRlclggPSB1cHBlclggKyB1cHBlcldpZHRoIC8gMjsKICB2YXIgdmVydGljYWxTaWduID0gaGVpZ2h0ID49IDAgPyAxIDogLTE7CiAgdmFyIHZlcnRpY2FsT2Zmc2V0ID0gdmVydGljYWxTaWduICogb2Zmc2V0OwogIHZhciB2ZXJ0aWNhbEVuZCA9IHZlcnRpY2FsU2lnbiA+IDAgPyAiZW5kIiA6ICJzdGFydCI7CiAgdmFyIHZlcnRpY2FsU3RhcnQgPSB2ZXJ0aWNhbFNpZ24gPiAwID8gInN0YXJ0IiA6ICJlbmQiOwogIHZhciBob3Jpem9udGFsU2lnbiA9IHVwcGVyV2lkdGggPj0gMCA/IDEgOiAtMTsKICB2YXIgaG9yaXpvbnRhbE9mZnNldCA9IGhvcml6b250YWxTaWduICogb2Zmc2V0OwogIHZhciBob3Jpem9udGFsRW5kID0gaG9yaXpvbnRhbFNpZ24gPiAwID8gImVuZCIgOiAic3RhcnQiOwogIHZhciBob3Jpem9udGFsU3RhcnQgPSBob3Jpem9udGFsU2lnbiA+IDAgPyAic3RhcnQiIDogImVuZCI7CiAgaWYgKHBvc2l0aW9uID09PSAidG9wIikgewogICAgdmFyIGF0dHJzID0gewogICAgICB4OiB1cHBlclggKyB1cHBlcldpZHRoIC8gMiwKICAgICAgeTogeTIgLSB2ZXJ0aWNhbE9mZnNldCwKICAgICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbEVuZAogICAgfTsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoX29iamVjdFNwcmVhZDIzKHt9LCBhdHRycyksIHBhcmVudFZpZXdCb3ggPyB7CiAgICAgIGhlaWdodDogTWF0aC5tYXgoeTIgLSBwYXJlbnRWaWV3Qm94LnksIDApLAogICAgICB3aWR0aDogdXBwZXJXaWR0aAogICAgfSA6IHt9KTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiYm90dG9tIikgewogICAgdmFyIF9hdHRycyA9IHsKICAgICAgeDogbG93ZXJYICsgbG93ZXJXaWR0aCAvIDIsCiAgICAgIHk6IHkyICsgaGVpZ2h0ICsgdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxTdGFydAogICAgfTsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoX29iamVjdFNwcmVhZDIzKHt9LCBfYXR0cnMpLCBwYXJlbnRWaWV3Qm94ID8gewogICAgICBoZWlnaHQ6IE1hdGgubWF4KHBhcmVudFZpZXdCb3gueSArIHBhcmVudFZpZXdCb3guaGVpZ2h0IC0gKHkyICsgaGVpZ2h0KSwgMCksCiAgICAgIHdpZHRoOiBsb3dlcldpZHRoCiAgICB9IDoge30pOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJsZWZ0IikgewogICAgdmFyIF9hdHRyczIgPSB7CiAgICAgIHg6IG1pZGRsZVggLSBob3Jpem9udGFsT2Zmc2V0LAogICAgICB5OiB5MiArIGhlaWdodCAvIDIsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxFbmQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogICAgfTsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoX29iamVjdFNwcmVhZDIzKHt9LCBfYXR0cnMyKSwgcGFyZW50Vmlld0JveCA/IHsKICAgICAgd2lkdGg6IE1hdGgubWF4KF9hdHRyczIueCAtIHBhcmVudFZpZXdCb3gueCwgMCksCiAgICAgIGhlaWdodAogICAgfSA6IHt9KTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAicmlnaHQiKSB7CiAgICB2YXIgX2F0dHJzMyA9IHsKICAgICAgeDogbWlkZGxlWCArIG1pZEhlaWdodFdpZHRoICsgaG9yaXpvbnRhbE9mZnNldCwKICAgICAgeTogeTIgKyBoZWlnaHQgLyAyLAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsU3RhcnQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAibWlkZGxlIgogICAgfTsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoX29iamVjdFNwcmVhZDIzKHt9LCBfYXR0cnMzKSwgcGFyZW50Vmlld0JveCA/IHsKICAgICAgd2lkdGg6IE1hdGgubWF4KHBhcmVudFZpZXdCb3gueCArIHBhcmVudFZpZXdCb3gud2lkdGggLSBfYXR0cnMzLngsIDApLAogICAgICBoZWlnaHQKICAgIH0gOiB7fSk7CiAgfQogIHZhciBzaXplQXR0cnMgPSBwYXJlbnRWaWV3Qm94ID8gewogICAgd2lkdGg6IG1pZEhlaWdodFdpZHRoLAogICAgaGVpZ2h0CiAgfSA6IHt9OwogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZUxlZnQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogbWlkZGxlWCArIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC8gMiwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbFN0YXJ0LAogICAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZVJpZ2h0IikgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IG1pZGRsZVggKyBtaWRIZWlnaHRXaWR0aCAtIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC8gMiwKICAgICAgdGV4dEFuY2hvcjogaG9yaXpvbnRhbEVuZCwKICAgICAgdmVydGljYWxBbmNob3I6ICJtaWRkbGUiCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVUb3AiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogdXBwZXJYICsgdXBwZXJXaWR0aCAvIDIsCiAgICAgIHk6IHkyICsgdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6ICJtaWRkbGUiLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxTdGFydAogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlQm90dG9tIikgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IGxvd2VyWCArIGxvd2VyV2lkdGggLyAyLAogICAgICB5OiB5MiArIGhlaWdodCAtIHZlcnRpY2FsT2Zmc2V0LAogICAgICB0ZXh0QW5jaG9yOiAibWlkZGxlIiwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsRW5kCiAgICB9LCBzaXplQXR0cnMpOwogIH0KICBpZiAocG9zaXRpb24gPT09ICJpbnNpZGVUb3BMZWZ0IikgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IHVwcGVyWCArIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxTdGFydCwKICAgICAgdmVydGljYWxBbmNob3I6IHZlcnRpY2FsU3RhcnQKICAgIH0sIHNpemVBdHRycyk7CiAgfQogIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZVRvcFJpZ2h0IikgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IHVwcGVyWCArIHVwcGVyV2lkdGggLSBob3Jpem9udGFsT2Zmc2V0LAogICAgICB5OiB5MiArIHZlcnRpY2FsT2Zmc2V0LAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsRW5kLAogICAgICB2ZXJ0aWNhbEFuY2hvcjogdmVydGljYWxTdGFydAogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlQm90dG9tTGVmdCIpIHsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMjMoewogICAgICB4OiBsb3dlclggKyBob3Jpem9udGFsT2Zmc2V0LAogICAgICB5OiB5MiArIGhlaWdodCAtIHZlcnRpY2FsT2Zmc2V0LAogICAgICB0ZXh0QW5jaG9yOiBob3Jpem9udGFsU3RhcnQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbEVuZAogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKHBvc2l0aW9uID09PSAiaW5zaWRlQm90dG9tUmlnaHQiKSB7CiAgICByZXR1cm4gX29iamVjdFNwcmVhZDIzKHsKICAgICAgeDogbG93ZXJYICsgbG93ZXJXaWR0aCAtIGhvcml6b250YWxPZmZzZXQsCiAgICAgIHk6IHkyICsgaGVpZ2h0IC0gdmVydGljYWxPZmZzZXQsCiAgICAgIHRleHRBbmNob3I6IGhvcml6b250YWxFbmQsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiB2ZXJ0aWNhbEVuZAogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgaWYgKCEhcG9zaXRpb24gJiYgdHlwZW9mIHBvc2l0aW9uID09PSAib2JqZWN0IiAmJiAoaXNOdW1iZXIocG9zaXRpb24ueCkgfHwgaXNQZXJjZW50KHBvc2l0aW9uLngpKSAmJiAoaXNOdW1iZXIocG9zaXRpb24ueSkgfHwgaXNQZXJjZW50KHBvc2l0aW9uLnkpKSkgewogICAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgIHg6IHgyICsgZ2V0UGVyY2VudFZhbHVlKHBvc2l0aW9uLngsIG1pZEhlaWdodFdpZHRoKSwKICAgICAgeTogeTIgKyBnZXRQZXJjZW50VmFsdWUocG9zaXRpb24ueSwgaGVpZ2h0KSwKICAgICAgdGV4dEFuY2hvcjogImVuZCIsCiAgICAgIHZlcnRpY2FsQW5jaG9yOiAiZW5kIgogICAgfSwgc2l6ZUF0dHJzKTsKICB9CiAgcmV0dXJuIF9vYmplY3RTcHJlYWQyMyh7CiAgICB4OiBjZW50ZXJYLAogICAgeTogeTIgKyBoZWlnaHQgLyAyLAogICAgdGV4dEFuY2hvcjogIm1pZGRsZSIsCiAgICB2ZXJ0aWNhbEFuY2hvcjogIm1pZGRsZSIKICB9LCBzaXplQXR0cnMpOwp9Owp2YXIgZGVmYXVsdExhYmVsUHJvcHMgPSB7CiAgYW5nbGU6IDAsCiAgb2Zmc2V0OiA1LAogIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmxhYmVsLAogIHBvc2l0aW9uOiAibWlkZGxlIiwKICB0ZXh0QnJlYWtBbGw6IGZhbHNlCn07CmZ1bmN0aW9uIExhYmVsKG91dGVyUHJvcHMpIHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dGVyUHJvcHMsIGRlZmF1bHRMYWJlbFByb3BzKTsKICB2YXIgewogICAgdmlld0JveDogdmlld0JveEZyb21Qcm9wcywKICAgIHBvc2l0aW9uLAogICAgdmFsdWUsCiAgICBjaGlsZHJlbiwKICAgIGNvbnRlbnQsCiAgICBjbGFzc05hbWUgPSAiIiwKICAgIHRleHRCcmVha0FsbCwKICAgIGxhYmVsUmVmCiAgfSA9IHByb3BzOwogIHZhciBwb2xhclZpZXdCb3ggPSB1c2VQb2xhckxhYmVsQ29udGV4dCgpOwogIHZhciBjYXJ0ZXNpYW5WaWV3Qm94ID0gdXNlQ2FydGVzaWFuTGFiZWxDb250ZXh0KCk7CiAgdmFyIHJlc29sdmVkVmlld0JveCA9IHBvc2l0aW9uID09PSAiY2VudGVyIiA/IGNhcnRlc2lhblZpZXdCb3ggOiBwb2xhclZpZXdCb3ggIT09IG51bGwgJiYgcG9sYXJWaWV3Qm94ICE9PSB2b2lkIDAgPyBwb2xhclZpZXdCb3ggOiBjYXJ0ZXNpYW5WaWV3Qm94OwogIHZhciB2aWV3Qm94LCBsYWJlbCwgcG9zaXRpb25BdHRyczsKICBpZiAodmlld0JveEZyb21Qcm9wcyA9PSBudWxsKSB7CiAgICB2aWV3Qm94ID0gcmVzb2x2ZWRWaWV3Qm94OwogIH0gZWxzZSBpZiAoaXNQb2xhcih2aWV3Qm94RnJvbVByb3BzKSkgewogICAgdmlld0JveCA9IHZpZXdCb3hGcm9tUHJvcHM7CiAgfSBlbHNlIHsKICAgIHZpZXdCb3ggPSBjYXJ0ZXNpYW5WaWV3Qm94VG9UcmFwZXpvaWQodmlld0JveEZyb21Qcm9wcyk7CiAgfQogIGlmICghdmlld0JveCB8fCBpc051bGxpc2godmFsdWUpICYmIGlzTnVsbGlzaChjaGlsZHJlbikgJiYgIS8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuaXNWYWxpZEVsZW1lbnQpKGNvbnRlbnQpICYmIHR5cGVvZiBjb250ZW50ICE9PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHByb3BzV2l0aFZpZXdCb3ggPSBfb2JqZWN0U3ByZWFkMjMoX29iamVjdFNwcmVhZDIzKHt9LCBwcm9wcyksIHt9LCB7CiAgICB2aWV3Qm94CiAgfSk7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuaXNWYWxpZEVsZW1lbnQpKGNvbnRlbnQpKSB7CiAgICB2YXIgewogICAgICBsYWJlbFJlZjogXwogICAgfSA9IHByb3BzV2l0aFZpZXdCb3gsIHByb3BzV2l0aG91dExhYmVsUmVmID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzNyhwcm9wc1dpdGhWaWV3Qm94LCBfZXhjbHVkZWQ3KTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmNsb25lRWxlbWVudCkoY29udGVudCwgcHJvcHNXaXRob3V0TGFiZWxSZWYpOwogIH0KICBpZiAodHlwZW9mIGNvbnRlbnQgPT09ICJmdW5jdGlvbiIpIHsKICAgIGxhYmVsID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QyNi5jcmVhdGVFbGVtZW50KShjb250ZW50LCBwcm9wc1dpdGhWaWV3Qm94KTsKICAgIGlmICgvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmlzVmFsaWRFbGVtZW50KShsYWJlbCkpIHsKICAgICAgcmV0dXJuIGxhYmVsOwogICAgfQogIH0gZWxzZSB7CiAgICBsYWJlbCA9IGdldExhYmVsKHByb3BzKTsKICB9CiAgdmFyIGF0dHJzID0gc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhwcm9wcyk7CiAgaWYgKGlzUG9sYXIodmlld0JveCkpIHsKICAgIGlmIChwb3NpdGlvbiA9PT0gImluc2lkZVN0YXJ0IiB8fCBwb3NpdGlvbiA9PT0gImluc2lkZUVuZCIgfHwgcG9zaXRpb24gPT09ICJlbmQiKSB7CiAgICAgIHJldHVybiByZW5kZXJSYWRpYWxMYWJlbChwcm9wcywgcG9zaXRpb24sIGxhYmVsLCBhdHRycywgdmlld0JveCk7CiAgICB9CiAgICBwb3NpdGlvbkF0dHJzID0gZ2V0QXR0cnNPZlBvbGFyTGFiZWwodmlld0JveCwgcHJvcHMub2Zmc2V0LCBwcm9wcy5wb3NpdGlvbik7CiAgfSBlbHNlIHsKICAgIHBvc2l0aW9uQXR0cnMgPSBnZXRBdHRyc09mQ2FydGVzaWFuTGFiZWwocHJvcHMsIHZpZXdCb3gpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4OiBwcm9wcy56SW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KFRleHQsIF9leHRlbmRzMTEoewogICAgcmVmOiBsYWJlbFJlZiwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtbGFiZWwiLCBjbGFzc05hbWUpCiAgfSwgYXR0cnMsIHBvc2l0aW9uQXR0cnMsIHsKICAgIC8qCiAgICAgKiB0ZXh0QW5jaG9yIGlzIGRlY2lkZWQgYnkgZGVmYXVsdCBiYXNlZCBvbiB0aGUgYHBvc2l0aW9uYAogICAgICogYnV0IHdlIGFsbG93IG92ZXJyaWRpbmcgdmlhIHByb3BzIGZvciBwcmVjaXNlIGNvbnRyb2wuCiAgICAgKi8KICAgIHRleHRBbmNob3I6IGlzVmFsaWRUZXh0QW5jaG9yKGF0dHJzLnRleHRBbmNob3IpID8gYXR0cnMudGV4dEFuY2hvciA6IHBvc2l0aW9uQXR0cnMudGV4dEFuY2hvciwKICAgIGJyZWFrQWxsOiB0ZXh0QnJlYWtBbGwKICB9KSwgbGFiZWwpKTsKfQpMYWJlbC5kaXNwbGF5TmFtZSA9ICJMYWJlbCI7CnZhciBwYXJzZUxhYmVsID0gKGxhYmVsLCB2aWV3Qm94LCBsYWJlbFJlZikgPT4gewogIGlmICghbGFiZWwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgY29tbW9uUHJvcHMgPSB7CiAgICB2aWV3Qm94LAogICAgbGFiZWxSZWYKICB9OwogIGlmIChsYWJlbCA9PT0gdHJ1ZSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoTGFiZWwsIF9leHRlbmRzMTEoewogICAgICBrZXk6ICJsYWJlbC1pbXBsaWNpdCIKICAgIH0sIGNvbW1vblByb3BzKSk7CiAgfQogIGlmIChpc051bU9yU3RyKGxhYmVsKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE0LmNyZWF0ZUVsZW1lbnQoTGFiZWwsIF9leHRlbmRzMTEoewogICAgICBrZXk6ICJsYWJlbC1pbXBsaWNpdCIsCiAgICAgIHZhbHVlOiBsYWJlbAogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjYuaXNWYWxpZEVsZW1lbnQpKGxhYmVsKSkgewogICAgaWYgKGxhYmVsLnR5cGUgPT09IExhYmVsKSB7CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI2LmNsb25lRWxlbWVudCkobGFiZWwsIF9vYmplY3RTcHJlYWQyMyh7CiAgICAgICAga2V5OiAibGFiZWwtaW1wbGljaXQiCiAgICAgIH0sIGNvbW1vblByb3BzKSk7CiAgICB9CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTQuY3JlYXRlRWxlbWVudChMYWJlbCwgX2V4dGVuZHMxMSh7CiAgICAgIGtleTogImxhYmVsLWltcGxpY2l0IiwKICAgICAgY29udGVudDogbGFiZWwKICAgIH0sIGNvbW1vblByb3BzKSk7CiAgfQogIGlmIChpc0xhYmVsQ29udGVudEFGdW5jdGlvbihsYWJlbCkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KExhYmVsLCBfZXh0ZW5kczExKHsKICAgICAga2V5OiAibGFiZWwtaW1wbGljaXQiLAogICAgICBjb250ZW50OiBsYWJlbAogICAgfSwgY29tbW9uUHJvcHMpKTsKICB9CiAgaWYgKGxhYmVsICYmIHR5cGVvZiBsYWJlbCA9PT0gIm9iamVjdCIpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNC5jcmVhdGVFbGVtZW50KExhYmVsLCBfZXh0ZW5kczExKHt9LCBsYWJlbCwgewogICAgICBrZXk6ICJsYWJlbC1pbXBsaWNpdCIKICAgIH0sIGNvbW1vblByb3BzKSk7CiAgfQogIHJldHVybiBudWxsOwp9OwpmdW5jdGlvbiBDYXJ0ZXNpYW5MYWJlbEZyb21MYWJlbFByb3AoX3JlZjMpIHsKICB2YXIgewogICAgbGFiZWwsCiAgICBsYWJlbFJlZgogIH0gPSBfcmVmMzsKICB2YXIgdmlld0JveCA9IHVzZUNhcnRlc2lhbkxhYmVsQ29udGV4dCgpOwogIHJldHVybiBwYXJzZUxhYmVsKGxhYmVsLCB2aWV3Qm94LCBsYWJlbFJlZikgfHwgbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0xhYmVsTGlzdC5qcwp2YXIgUmVhY3QxNSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDI3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X2xhc3QgPSBfX3RvRVNNKHJlcXVpcmVfbGFzdDMoKSk7CnZhciBfZXhjbHVkZWQ4ID0gWyJ2YWx1ZUFjY2Vzc29yIl07CnZhciBfZXhjbHVkZWQyNCA9IFsiZGF0YUtleSIsICJjbG9ja1dpc2UiLCAiaWQiLCAidGV4dEJyZWFrQWxsIiwgInpJbmRleCJdOwpmdW5jdGlvbiBfZXh0ZW5kczEyKCkgewogIHJldHVybiBfZXh0ZW5kczEyID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMxMi5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczgoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTgoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTgocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CnZhciBkZWZhdWx0QWNjZXNzb3IgPSAoZW50cnkpID0+IEFycmF5LmlzQXJyYXkoZW50cnkudmFsdWUpID8gKDAsIGltcG9ydF9sYXN0LmRlZmF1bHQpKGVudHJ5LnZhbHVlKSA6IGVudHJ5LnZhbHVlOwp2YXIgQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MjcuY3JlYXRlQ29udGV4dCkodm9pZCAwKTsKdmFyIENhcnRlc2lhbkxhYmVsTGlzdENvbnRleHRQcm92aWRlciA9IENhcnRlc2lhbkxhYmVsTGlzdENvbnRleHQuUHJvdmlkZXI7CnZhciBQb2xhckxhYmVsTGlzdENvbnRleHQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDI3LmNyZWF0ZUNvbnRleHQpKHZvaWQgMCk7CnZhciBQb2xhckxhYmVsTGlzdENvbnRleHRQcm92aWRlciA9IFBvbGFyTGFiZWxMaXN0Q29udGV4dC5Qcm92aWRlcjsKZnVuY3Rpb24gdXNlQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dCgpIHsKICByZXR1cm4gKDAsIGltcG9ydF9yZWFjdDI3LnVzZUNvbnRleHQpKENhcnRlc2lhbkxhYmVsTGlzdENvbnRleHQpOwp9CmZ1bmN0aW9uIHVzZVBvbGFyTGFiZWxMaXN0Q29udGV4dCgpIHsKICByZXR1cm4gKDAsIGltcG9ydF9yZWFjdDI3LnVzZUNvbnRleHQpKFBvbGFyTGFiZWxMaXN0Q29udGV4dCk7Cn0KZnVuY3Rpb24gTGFiZWxMaXN0KF9yZWYyKSB7CiAgdmFyIHsKICAgIHZhbHVlQWNjZXNzb3IgPSBkZWZhdWx0QWNjZXNzb3IKICB9ID0gX3JlZjIsIHJlc3RQcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczgoX3JlZjIsIF9leGNsdWRlZDgpOwogIHZhciB7CiAgICBkYXRhS2V5LAogICAgY2xvY2tXaXNlLAogICAgaWQsCiAgICB0ZXh0QnJlYWtBbGwsCiAgICB6SW5kZXgKICB9ID0gcmVzdFByb3BzLCBvdGhlcnMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM4KHJlc3RQcm9wcywgX2V4Y2x1ZGVkMjQpOwogIHZhciBjYXJ0ZXNpYW5EYXRhID0gdXNlQ2FydGVzaWFuTGFiZWxMaXN0Q29udGV4dCgpOwogIHZhciBwb2xhckRhdGEgPSB1c2VQb2xhckxhYmVsTGlzdENvbnRleHQoKTsKICB2YXIgZGF0YSA9IGNhcnRlc2lhbkRhdGEgfHwgcG9sYXJEYXRhOwogIGlmICghZGF0YSB8fCAhZGF0YS5sZW5ndGgpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTUuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4OiB6SW5kZXggIT09IG51bGwgJiYgekluZGV4ICE9PSB2b2lkIDAgPyB6SW5kZXggOiBEZWZhdWx0WkluZGV4ZXMubGFiZWwKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1sYWJlbC1saXN0IgogIH0sIGRhdGEubWFwKChlbnRyeSwgaW5kZXgpID0+IHsKICAgIHZhciBfcmVzdFByb3BzJGZpbGw7CiAgICB2YXIgdmFsdWUgPSBpc051bGxpc2goZGF0YUtleSkgPyB2YWx1ZUFjY2Vzc29yKGVudHJ5LCBpbmRleCkgOiBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSAmJiBlbnRyeS5wYXlsb2FkLCBkYXRhS2V5KTsKICAgIHZhciBpZFByb3BzID0gaXNOdWxsaXNoKGlkKSA/IHt9IDogewogICAgICBpZDogIiIuY29uY2F0KGlkLCAiLSIpLmNvbmNhdChpbmRleCkKICAgIH07CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTUuY3JlYXRlRWxlbWVudChMYWJlbCwgX2V4dGVuZHMxMih7CiAgICAgIGtleTogImxhYmVsLSIuY29uY2F0KGluZGV4KQogICAgfSwgc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhlbnRyeSksIG90aGVycywgaWRQcm9wcywgewogICAgICAvKgogICAgICAgKiBQcmVmZXIgdG8gdXNlIHRoZSBleHBsaWNpdCBmaWxsIGZyb20gTGFiZWxMaXN0IHByb3BzLgogICAgICAgKiBPbmx5IGluIGFuIGFic2VuY2Ugb2YgdGhhdCwgZmFsbCBiYWNrIHRvIHRoZSBmaWxsIG9mIHRoZSBlbnRyeS4KICAgICAgICogVGhlIGVudHJ5IGZpbGwgY2FuIGJlIHF1aXRlIGRpZmZpY3VsdCB0byBzZWUgZXNwZWNpYWxseSBpbiBCYXIsIFBpZSwgUmFkaWFsQmFyIGluIGluc2lkZSBwb3NpdGlvbnMuCiAgICAgICAqIE9uIHRoZSBvdGhlciBoYW5kIGl0J3MgcXVpdGUgY29udmVuaWVudCBpbiBTY2F0dGVyLCBMaW5lLCBvciB3aGVuIHRoZSBwb3NpdGlvbiBpcyBvdXRzaWRlIHRoZSBCYXIsIFBpZSBmaWxsZWQgc2hhcGVzLgogICAgICAgKi8KICAgICAgZmlsbDogKF9yZXN0UHJvcHMkZmlsbCA9IHJlc3RQcm9wcy5maWxsKSAhPT0gbnVsbCAmJiBfcmVzdFByb3BzJGZpbGwgIT09IHZvaWQgMCA/IF9yZXN0UHJvcHMkZmlsbCA6IGVudHJ5LmZpbGwsCiAgICAgIHBhcmVudFZpZXdCb3g6IGVudHJ5LnBhcmVudFZpZXdCb3gsCiAgICAgIHZhbHVlLAogICAgICB0ZXh0QnJlYWtBbGwsCiAgICAgIHZpZXdCb3g6IGVudHJ5LnZpZXdCb3gsCiAgICAgIGluZGV4LAogICAgICB6SW5kZXg6IDAKICAgIH0pKTsKICB9KSkpOwp9CkxhYmVsTGlzdC5kaXNwbGF5TmFtZSA9ICJMYWJlbExpc3QiOwpmdW5jdGlvbiBMYWJlbExpc3RGcm9tTGFiZWxQcm9wKF9yZWYyKSB7CiAgdmFyIHsKICAgIGxhYmVsCiAgfSA9IF9yZWYyOwogIGlmICghbGFiZWwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBpZiAobGFiZWwgPT09IHRydWUpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KExhYmVsTGlzdCwgewogICAgICBrZXk6ICJsYWJlbExpc3QtaW1wbGljaXQiCiAgICB9KTsKICB9CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE1LmlzVmFsaWRFbGVtZW50KGxhYmVsKSB8fCBpc0xhYmVsQ29udGVudEFGdW5jdGlvbihsYWJlbCkpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxNS5jcmVhdGVFbGVtZW50KExhYmVsTGlzdCwgewogICAgICBrZXk6ICJsYWJlbExpc3QtaW1wbGljaXQiLAogICAgICBjb250ZW50OiBsYWJlbAogICAgfSk7CiAgfQogIGlmICh0eXBlb2YgbGFiZWwgPT09ICJvYmplY3QiKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTUuY3JlYXRlRWxlbWVudChMYWJlbExpc3QsIF9leHRlbmRzMTIoewogICAgICBrZXk6ICJsYWJlbExpc3QtaW1wbGljaXQiCiAgICB9LCBsYWJlbCwgewogICAgICB0eXBlOiBTdHJpbmcobGFiZWwudHlwZSkKICAgIH0pKTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3NoYXBlL0RvdC5qcwp2YXIgUmVhY3QxNiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gX2V4dGVuZHMxMygpIHsKICByZXR1cm4gX2V4dGVuZHMxMyA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTMuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQp2YXIgRG90ID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIGN4LAogICAgY3ksCiAgICByOiByMiwKICAgIGNsYXNzTmFtZQogIH0gPSBwcm9wczsKICB2YXIgbGF5ZXJDbGFzcyA9IGNsc3goInJlY2hhcnRzLWRvdCIsIGNsYXNzTmFtZSk7CiAgaWYgKGlzTnVtYmVyKGN4KSAmJiBpc051bWJlcihjeSkgJiYgaXNOdW1iZXIocjIpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTYuY3JlYXRlRWxlbWVudCgiY2lyY2xlIiwgX2V4dGVuZHMxMyh7fSwgc3ZnUHJvcGVydGllc05vRXZlbnRzKHByb3BzKSwgYWRhcHRFdmVudEhhbmRsZXJzKHByb3BzKSwgewogICAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MsCiAgICAgIGN4LAogICAgICBjeSwKICAgICAgcjogcjIKICAgIH0pKTsKICB9CiAgcmV0dXJuIG51bGw7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9wb2xhckF4aXNTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlNiA9IHsKICByYWRpdXNBeGlzOiB7fSwKICBhbmdsZUF4aXM6IHt9Cn07CnZhciBwb2xhckF4aXNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAicG9sYXJBeGlzIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTYsCiAgcmVkdWNlcnM6IHsKICAgIGFkZFJhZGl1c0F4aXMoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5yYWRpdXNBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXSA9IGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCk7CiAgICB9LAogICAgcmVtb3ZlUmFkaXVzQXhpcyhzdGF0ZSwgYWN0aW9uKSB7CiAgICAgIGRlbGV0ZSBzdGF0ZS5yYWRpdXNBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXTsKICAgIH0sCiAgICBhZGRBbmdsZUF4aXMoc3RhdGUsIGFjdGlvbikgewogICAgICBzdGF0ZS5hbmdsZUF4aXNbYWN0aW9uLnBheWxvYWQuaWRdID0gY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKTsKICAgIH0sCiAgICByZW1vdmVBbmdsZUF4aXMoc3RhdGUsIGFjdGlvbikgewogICAgICBkZWxldGUgc3RhdGUuYW5nbGVBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXTsKICAgIH0KICB9Cn0pOwp2YXIgewogIGFkZFJhZGl1c0F4aXMsCiAgcmVtb3ZlUmFkaXVzQXhpcywKICBhZGRBbmdsZUF4aXMsCiAgcmVtb3ZlQW5nbGVBeGlzCn0gPSBwb2xhckF4aXNTbGljZS5hY3Rpb25zOwp2YXIgcG9sYXJBeGlzUmVkdWNlciA9IHBvbGFyQXhpc1NsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL1JlYWN0VXRpbHMuanMKdmFyIGltcG9ydF9yZWFjdDI4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaXNDbGlwRG90ID0gKGRvdCkgPT4gewogIGlmIChkb3QgJiYgdHlwZW9mIGRvdCA9PT0gIm9iamVjdCIgJiYgImNsaXBEb3QiIGluIGRvdCkgewogICAgcmV0dXJuIEJvb2xlYW4oZG90LmNsaXBEb3QpOwogIH0KICByZXR1cm4gdHJ1ZTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1NldFRvb2x0aXBFbnRyeVNldHRpbmdzLmpzCnZhciBpbXBvcnRfcmVhY3QyOSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gU2V0VG9vbHRpcEVudHJ5U2V0dGluZ3MoX3JlZjIpIHsKICB2YXIgewogICAgdG9vbHRpcEVudHJ5U2V0dGluZ3MKICB9ID0gX3JlZjI7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgcHJldlNldHRpbmdzUmVmID0gKDAsIGltcG9ydF9yZWFjdDI5LnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDI5LnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKGlzUGFub3JhbWEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgIGRpc3BhdGNoKGFkZFRvb2x0aXBFbnRyeVNldHRpbmdzKHRvb2x0aXBFbnRyeVNldHRpbmdzKSk7CiAgICB9IGVsc2UgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ICE9PSB0b29sdGlwRW50cnlTZXR0aW5ncykgewogICAgICBkaXNwYXRjaChyZXBsYWNlVG9vbHRpcEVudHJ5U2V0dGluZ3MoewogICAgICAgIHByZXY6IHByZXZTZXR0aW5nc1JlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IHRvb2x0aXBFbnRyeVNldHRpbmdzCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID0gdG9vbHRpcEVudHJ5U2V0dGluZ3M7CiAgfSwgW3Rvb2x0aXBFbnRyeVNldHRpbmdzLCBkaXNwYXRjaCwgaXNQYW5vcmFtYV0pOwogICgwLCBpbXBvcnRfcmVhY3QyOS51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZVRvb2x0aXBFbnRyeVNldHRpbmdzKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0sIFtkaXNwYXRjaF0pOwogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9TZXRMZWdlbmRQYXlsb2FkLmpzCnZhciBpbXBvcnRfcmVhY3QzMCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gU2V0TGVnZW5kUGF5bG9hZChfcmVmMikgewogIHZhciB7CiAgICBsZWdlbmRQYXlsb2FkCiAgfSA9IF9yZWYyOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHByZXZQYXlsb2FkUmVmID0gKDAsIGltcG9ydF9yZWFjdDMwLnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDMwLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKGlzUGFub3JhbWEpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHByZXZQYXlsb2FkUmVmLmN1cnJlbnQgPT09IG51bGwpIHsKICAgICAgZGlzcGF0Y2goYWRkTGVnZW5kUGF5bG9hZChsZWdlbmRQYXlsb2FkKSk7CiAgICB9IGVsc2UgaWYgKHByZXZQYXlsb2FkUmVmLmN1cnJlbnQgIT09IGxlZ2VuZFBheWxvYWQpIHsKICAgICAgZGlzcGF0Y2gocmVwbGFjZUxlZ2VuZFBheWxvYWQoewogICAgICAgIHByZXY6IHByZXZQYXlsb2FkUmVmLmN1cnJlbnQsCiAgICAgICAgbmV4dDogbGVnZW5kUGF5bG9hZAogICAgICB9KSk7CiAgICB9CiAgICBwcmV2UGF5bG9hZFJlZi5jdXJyZW50ID0gbGVnZW5kUGF5bG9hZDsKICB9LCBbZGlzcGF0Y2gsIGlzUGFub3JhbWEsIGxlZ2VuZFBheWxvYWRdKTsKICAoMCwgaW1wb3J0X3JlYWN0MzAudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAocHJldlBheWxvYWRSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZUxlZ2VuZFBheWxvYWQocHJldlBheWxvYWRSZWYuY3VycmVudCkpOwogICAgICAgIHByZXZQYXlsb2FkUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0sIFtkaXNwYXRjaF0pOwogIHJldHVybiBudWxsOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L1JlZ2lzdGVyR3JhcGhpY2FsSXRlbUlkLmpzCnZhciBSZWFjdDE4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0MzEgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL3VzZUlkLmpzCnZhciBSZWFjdDE3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX3JlZjsKdmFyIHVzZUlkRmFsbGJhY2sgPSAoKSA9PiB7CiAgdmFyIFtpZF0gPSBSZWFjdDE3LnVzZVN0YXRlKCgpID0+IHVuaXF1ZUlkKCJ1aWQtIikpOwogIHJldHVybiBpZDsKfTsKdmFyIHVzZUlkID0gKF9yZWYgPSBSZWFjdDE3WyJ1c2VJZCIudG9TdHJpbmcoKV0pICE9PSBudWxsICYmIF9yZWYgIT09IHZvaWQgMCA/IF9yZWYgOiB1c2VJZEZhbGxiYWNrOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvdXRpbC91c2VVbmlxdWVJZC5qcwpmdW5jdGlvbiB1c2VVbmlxdWVJZChwcmVmaXgsIGN1c3RvbUlkKSB7CiAgdmFyIGdlbmVyYXRlZElkID0gdXNlSWQoKTsKICBpZiAoY3VzdG9tSWQpIHsKICAgIHJldHVybiBjdXN0b21JZDsKICB9CiAgcmV0dXJuIHByZWZpeCA/ICIiLmNvbmNhdChwcmVmaXgsICItIikuY29uY2F0KGdlbmVyYXRlZElkKSA6IGdlbmVyYXRlZElkOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L1JlZ2lzdGVyR3JhcGhpY2FsSXRlbUlkLmpzCnZhciBHcmFwaGljYWxJdGVtSWRDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzMS5jcmVhdGVDb250ZXh0KSh2b2lkIDApOwp2YXIgUmVnaXN0ZXJHcmFwaGljYWxJdGVtSWQgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgaWQsCiAgICB0eXBlLAogICAgY2hpbGRyZW4KICB9ID0gX3JlZjI7CiAgdmFyIHJlc29sdmVkSWQgPSB1c2VVbmlxdWVJZCgicmVjaGFydHMtIi5jb25jYXQodHlwZSksIGlkKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTguY3JlYXRlRWxlbWVudChHcmFwaGljYWxJdGVtSWRDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogcmVzb2x2ZWRJZAogIH0sIGNoaWxkcmVuKHJlc29sdmVkSWQpKTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1NldEdyYXBoaWNhbEl0ZW0uanMKdmFyIGltcG9ydF9yZWFjdDMyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvZ3JhcGhpY2FsSXRlbXNTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlNyA9IHsKICBjYXJ0ZXNpYW5JdGVtczogW10sCiAgcG9sYXJJdGVtczogW10KfTsKdmFyIGdyYXBoaWNhbEl0ZW1zU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImdyYXBoaWNhbEl0ZW1zIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTcsCiAgcmVkdWNlcnM6IHsKICAgIGFkZENhcnRlc2lhbkdyYXBoaWNhbEl0ZW06IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUuY2FydGVzaWFuSXRlbXMucHVzaChjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZXBsYWNlQ2FydGVzaWFuR3JhcGhpY2FsSXRlbTogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgewogICAgICAgICAgcHJldiwKICAgICAgICAgIG5leHQKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkuY2FydGVzaWFuSXRlbXMuaW5kZXhPZihjYXN0RHJhZnQocHJldikpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS5jYXJ0ZXNpYW5JdGVtc1tpbmRleF0gPSBjYXN0RHJhZnQobmV4dCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZUNhcnRlc2lhbkdyYXBoaWNhbEl0ZW06IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkuY2FydGVzaWFuSXRlbXMuaW5kZXhPZihjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgICAgc3RhdGUuY2FydGVzaWFuSXRlbXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgYWRkUG9sYXJHcmFwaGljYWxJdGVtOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLnBvbGFySXRlbXMucHVzaChjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVQb2xhckdyYXBoaWNhbEl0ZW06IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkucG9sYXJJdGVtcy5pbmRleE9mKGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCkpOwogICAgICAgIGlmIChpbmRleCA+IC0xKSB7CiAgICAgICAgICBzdGF0ZS5wb2xhckl0ZW1zLnNwbGljZShpbmRleCwgMSk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkQ2FydGVzaWFuR3JhcGhpY2FsSXRlbSwKICByZXBsYWNlQ2FydGVzaWFuR3JhcGhpY2FsSXRlbSwKICByZW1vdmVDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtLAogIGFkZFBvbGFyR3JhcGhpY2FsSXRlbSwKICByZW1vdmVQb2xhckdyYXBoaWNhbEl0ZW0KfSA9IGdyYXBoaWNhbEl0ZW1zU2xpY2UuYWN0aW9uczsKdmFyIGdyYXBoaWNhbEl0ZW1zUmVkdWNlciA9IGdyYXBoaWNhbEl0ZW1zU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL1NldEdyYXBoaWNhbEl0ZW0uanMKdmFyIFNldENhcnRlc2lhbkdyYXBoaWNhbEl0ZW1JbXBsID0gKHByb3BzKSA9PiB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgcHJldlByb3BzUmVmID0gKDAsIGltcG9ydF9yZWFjdDMyLnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDMyLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKHByZXZQcm9wc1JlZi5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgIGRpc3BhdGNoKGFkZENhcnRlc2lhbkdyYXBoaWNhbEl0ZW0ocHJvcHMpKTsKICAgIH0gZWxzZSBpZiAocHJldlByb3BzUmVmLmN1cnJlbnQgIT09IHByb3BzKSB7CiAgICAgIGRpc3BhdGNoKHJlcGxhY2VDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtKHsKICAgICAgICBwcmV2OiBwcmV2UHJvcHNSZWYuY3VycmVudCwKICAgICAgICBuZXh0OiBwcm9wcwogICAgICB9KSk7CiAgICB9CiAgICBwcmV2UHJvcHNSZWYuY3VycmVudCA9IHByb3BzOwogIH0sIFtkaXNwYXRjaCwgcHJvcHNdKTsKICAoMCwgaW1wb3J0X3JlYWN0MzIudXNlTGF5b3V0RWZmZWN0KSgoKSA9PiB7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBpZiAocHJldlByb3BzUmVmLmN1cnJlbnQpIHsKICAgICAgICBkaXNwYXRjaChyZW1vdmVDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtKHByZXZQcm9wc1JlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlByb3BzUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0sIFtkaXNwYXRjaF0pOwogIHJldHVybiBudWxsOwp9Owp2YXIgU2V0Q2FydGVzaWFuR3JhcGhpY2FsSXRlbSA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzIubWVtbykoU2V0Q2FydGVzaWFuR3JhcGhpY2FsSXRlbUltcGwpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29tcG9uZW50L0RvdHMuanMKdmFyIFJlYWN0MTkgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QzMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIF9leGNsdWRlZDkgPSBbInBvaW50cyJdOwpmdW5jdGlvbiBvd25LZXlzMjQoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyNChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czI0KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyNShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyNChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjUoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyNShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyNSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyNSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyNSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gX2V4dGVuZHMxNCgpIHsKICByZXR1cm4gX2V4dGVuZHMxNCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTQuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM5KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U5KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2U5KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBEb3RJdGVtKF9yZWYyKSB7CiAgdmFyIHsKICAgIG9wdGlvbiwKICAgIGRvdFByb3BzLAogICAgY2xhc3NOYW1lCiAgfSA9IF9yZWYyOwogIGlmICgvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDMzLmlzVmFsaWRFbGVtZW50KShvcHRpb24pKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzMy5jbG9uZUVsZW1lbnQpKG9wdGlvbiwgZG90UHJvcHMpOwogIH0KICBpZiAodHlwZW9mIG9wdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIG9wdGlvbihkb3RQcm9wcyk7CiAgfQogIHZhciBmaW5hbENsYXNzTmFtZSA9IGNsc3goY2xhc3NOYW1lLCB0eXBlb2Ygb3B0aW9uICE9PSAiYm9vbGVhbiIgPyBvcHRpb24uY2xhc3NOYW1lIDogIiIpOwogIHZhciBfcmVmMjIgPSBkb3RQcm9wcyAhPT0gbnVsbCAmJiBkb3RQcm9wcyAhPT0gdm9pZCAwID8gZG90UHJvcHMgOiB7fSwgewogICAgcG9pbnRzCiAgfSA9IF9yZWYyMiwgcHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXM5KF9yZWYyMiwgX2V4Y2x1ZGVkOSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDE5LmNyZWF0ZUVsZW1lbnQoRG90LCBfZXh0ZW5kczE0KHt9LCBwcm9wcywgewogICAgY2xhc3NOYW1lOiBmaW5hbENsYXNzTmFtZQogIH0pKTsKfQpmdW5jdGlvbiBzaG91bGRSZW5kZXJEb3RzKHBvaW50cywgZG90KSB7CiAgaWYgKHBvaW50cyA9PSBudWxsKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGlmIChkb3QpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICByZXR1cm4gcG9pbnRzLmxlbmd0aCA9PT0gMTsKfQpmdW5jdGlvbiBEb3RzKF9yZWYzKSB7CiAgdmFyIHsKICAgIHBvaW50cywKICAgIGRvdCwKICAgIGNsYXNzTmFtZSwKICAgIGRvdENsYXNzTmFtZSwKICAgIGRhdGFLZXksCiAgICBiYXNlUHJvcHMsCiAgICBuZWVkQ2xpcCwKICAgIGNsaXBQYXRoSWQsCiAgICB6SW5kZXggPSBEZWZhdWx0WkluZGV4ZXMuc2NhdHRlcgogIH0gPSBfcmVmMzsKICBpZiAoIXNob3VsZFJlbmRlckRvdHMocG9pbnRzLCBkb3QpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGNsaXBEb3QgPSBpc0NsaXBEb3QoZG90KTsKICB2YXIgY3VzdG9tRG90UHJvcHMgPSBzdmdQcm9wZXJ0aWVzQW5kRXZlbnRzRnJvbVVua25vd24oZG90KTsKICB2YXIgZG90cyA9IHBvaW50cy5tYXAoKGVudHJ5LCBpKSA9PiB7CiAgICB2YXIgX2VudHJ5JHgsIF9lbnRyeSR5OwogICAgdmFyIGRvdFByb3BzID0gX29iamVjdFNwcmVhZDI0KF9vYmplY3RTcHJlYWQyNChfb2JqZWN0U3ByZWFkMjQoewogICAgICByOiAzCiAgICB9LCBiYXNlUHJvcHMpLCBjdXN0b21Eb3RQcm9wcyksIHt9LCB7CiAgICAgIGluZGV4OiBpLAogICAgICBjeDogKF9lbnRyeSR4ID0gZW50cnkueCkgIT09IG51bGwgJiYgX2VudHJ5JHggIT09IHZvaWQgMCA/IF9lbnRyeSR4IDogdm9pZCAwLAogICAgICBjeTogKF9lbnRyeSR5ID0gZW50cnkueSkgIT09IG51bGwgJiYgX2VudHJ5JHkgIT09IHZvaWQgMCA/IF9lbnRyeSR5IDogdm9pZCAwLAogICAgICBkYXRhS2V5LAogICAgICB2YWx1ZTogZW50cnkudmFsdWUsCiAgICAgIHBheWxvYWQ6IGVudHJ5LnBheWxvYWQsCiAgICAgIHBvaW50cwogICAgfSk7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MTkuY3JlYXRlRWxlbWVudChEb3RJdGVtLCB7CiAgICAgIGtleTogImRvdC0iLmNvbmNhdChpKSwKICAgICAgb3B0aW9uOiBkb3QsCiAgICAgIGRvdFByb3BzLAogICAgICBjbGFzc05hbWU6IGRvdENsYXNzTmFtZQogICAgfSk7CiAgfSk7CiAgdmFyIGxheWVyUHJvcHMgPSB7fTsKICBpZiAobmVlZENsaXAgJiYgY2xpcFBhdGhJZCAhPSBudWxsKSB7CiAgICBsYXllclByb3BzLmNsaXBQYXRoID0gInVybCgjY2xpcFBhdGgtIi5jb25jYXQoY2xpcERvdCA/ICIiIDogImRvdHMtIikuY29uY2F0KGNsaXBQYXRoSWQsICIpIik7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QxOS5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QxOS5jcmVhdGVFbGVtZW50KExheWVyLCBfZXh0ZW5kczE0KHsKICAgIGNsYXNzTmFtZQogIH0sIGxheWVyUHJvcHMpLCBkb3RzKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbXBvbmVudC9BY3RpdmVQb2ludHMuanMKdmFyIFJlYWN0MjAgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QzNCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL2NhcnRlc2lhbkF4aXNTbGljZS5qcwpmdW5jdGlvbiBvd25LZXlzMjUoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyNShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czI1KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyNihlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyNShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjYoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyNihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyNih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyNih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyNih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIGluaXRpYWxTdGF0ZTggPSB7CiAgeEF4aXM6IHt9LAogIHlBeGlzOiB7fSwKICB6QXhpczoge30KfTsKdmFyIGNhcnRlc2lhbkF4aXNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAiY2FydGVzaWFuQXhpcyIsCiAgaW5pdGlhbFN0YXRlOiBpbml0aWFsU3RhdGU4LAogIHJlZHVjZXJzOiB7CiAgICBhZGRYQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBzdGF0ZS54QXhpc1thY3Rpb24ucGF5bG9hZC5pZF0gPSBjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlcGxhY2VYQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICB2YXIgewogICAgICAgICAgcHJldiwKICAgICAgICAgIG5leHQKICAgICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgICAgaWYgKHN0YXRlLnhBeGlzW3ByZXYuaWRdICE9PSB2b2lkIDApIHsKICAgICAgICAgIGlmIChwcmV2LmlkICE9PSBuZXh0LmlkKSB7CiAgICAgICAgICAgIGRlbGV0ZSBzdGF0ZS54QXhpc1twcmV2LmlkXTsKICAgICAgICAgIH0KICAgICAgICAgIHN0YXRlLnhBeGlzW25leHQuaWRdID0gY2FzdERyYWZ0KG5leHQpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZW1vdmVYQXhpczogewogICAgICByZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgICBkZWxldGUgc3RhdGUueEF4aXNbYWN0aW9uLnBheWxvYWQuaWRdOwogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIGFkZFlBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHN0YXRlLnlBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXSA9IGNhc3REcmFmdChhY3Rpb24ucGF5bG9hZCk7CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVwbGFjZVlBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIHZhciB7CiAgICAgICAgICBwcmV2LAogICAgICAgICAgbmV4dAogICAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgICBpZiAoc3RhdGUueUF4aXNbcHJldi5pZF0gIT09IHZvaWQgMCkgewogICAgICAgICAgaWYgKHByZXYuaWQgIT09IG5leHQuaWQpIHsKICAgICAgICAgICAgZGVsZXRlIHN0YXRlLnlBeGlzW3ByZXYuaWRdOwogICAgICAgICAgfQogICAgICAgICAgc3RhdGUueUF4aXNbbmV4dC5pZF0gPSBjYXN0RHJhZnQobmV4dCk7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmVwYXJlOiBwcmVwYXJlQXV0b0JhdGNoZWQoKQogICAgfSwKICAgIHJlbW92ZVlBeGlzOiB7CiAgICAgIHJlZHVjZXIoc3RhdGUsIGFjdGlvbikgewogICAgICAgIGRlbGV0ZSBzdGF0ZS55QXhpc1thY3Rpb24ucGF5bG9hZC5pZF07CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgYWRkWkF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgc3RhdGUuekF4aXNbYWN0aW9uLnBheWxvYWQuaWRdID0gY2FzdERyYWZ0KGFjdGlvbi5wYXlsb2FkKTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICByZXBsYWNlWkF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgdmFyIHsKICAgICAgICAgIHByZXYsCiAgICAgICAgICBuZXh0CiAgICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICAgIGlmIChzdGF0ZS56QXhpc1twcmV2LmlkXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICBpZiAocHJldi5pZCAhPT0gbmV4dC5pZCkgewogICAgICAgICAgICBkZWxldGUgc3RhdGUuekF4aXNbcHJldi5pZF07CiAgICAgICAgICB9CiAgICAgICAgICBzdGF0ZS56QXhpc1tuZXh0LmlkXSA9IGNhc3REcmFmdChuZXh0KTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHByZXBhcmU6IHByZXBhcmVBdXRvQmF0Y2hlZCgpCiAgICB9LAogICAgcmVtb3ZlWkF4aXM6IHsKICAgICAgcmVkdWNlcihzdGF0ZSwgYWN0aW9uKSB7CiAgICAgICAgZGVsZXRlIHN0YXRlLnpBeGlzW2FjdGlvbi5wYXlsb2FkLmlkXTsKICAgICAgfSwKICAgICAgcHJlcGFyZTogcHJlcGFyZUF1dG9CYXRjaGVkKCkKICAgIH0sCiAgICB1cGRhdGVZQXhpc1dpZHRoKHN0YXRlLCBhY3Rpb24pIHsKICAgICAgdmFyIHsKICAgICAgICBpZCwKICAgICAgICB3aWR0aAogICAgICB9ID0gYWN0aW9uLnBheWxvYWQ7CiAgICAgIHZhciBheGlzID0gc3RhdGUueUF4aXNbaWRdOwogICAgICBpZiAoYXhpcykgewogICAgICAgIHZhciBoaXN0b3J5ID0gYXhpcy53aWR0aEhpc3RvcnkgfHwgW107CiAgICAgICAgaWYgKGhpc3RvcnkubGVuZ3RoID09PSAzICYmIGhpc3RvcnlbMF0gPT09IGhpc3RvcnlbMl0gJiYgd2lkdGggPT09IGhpc3RvcnlbMV0gJiYgd2lkdGggIT09IGF4aXMud2lkdGggJiYgTWF0aC5hYnMod2lkdGggLSBoaXN0b3J5WzBdKSA8PSAxKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHZhciBuZXdIaXN0b3J5ID0gWy4uLmhpc3RvcnksIHdpZHRoXS5zbGljZSgtMyk7CiAgICAgICAgc3RhdGUueUF4aXNbaWRdID0gX29iamVjdFNwcmVhZDI1KF9vYmplY3RTcHJlYWQyNSh7fSwgc3RhdGUueUF4aXNbaWRdKSwge30sIHsKICAgICAgICAgIHdpZHRoLAogICAgICAgICAgd2lkdGhIaXN0b3J5OiBuZXdIaXN0b3J5CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KICB9Cn0pOwp2YXIgewogIGFkZFhBeGlzLAogIHJlcGxhY2VYQXhpcywKICByZW1vdmVYQXhpcywKICBhZGRZQXhpcywKICByZXBsYWNlWUF4aXMsCiAgcmVtb3ZlWUF4aXMsCiAgYWRkWkF4aXMsCiAgcmVwbGFjZVpBeGlzLAogIHJlbW92ZVpBeGlzLAogIHVwZGF0ZVlBeGlzV2lkdGgKfSA9IGNhcnRlc2lhbkF4aXNTbGljZS5hY3Rpb25zOwp2YXIgY2FydGVzaWFuQXhpc1JlZHVjZXIgPSBjYXJ0ZXNpYW5BeGlzU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RDaGFydE9mZnNldC5qcwp2YXIgc2VsZWN0Q2hhcnRPZmZzZXQgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbF0sIChvZmZzZXRJbnRlcm5hbCkgPT4gewogIHJldHVybiB7CiAgICB0b3A6IG9mZnNldEludGVybmFsLnRvcCwKICAgIGJvdHRvbTogb2Zmc2V0SW50ZXJuYWwuYm90dG9tLAogICAgbGVmdDogb2Zmc2V0SW50ZXJuYWwubGVmdCwKICAgIHJpZ2h0OiBvZmZzZXRJbnRlcm5hbC5yaWdodAogIH07Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL3NlbGVjdFBsb3RBcmVhLmpzCnZhciBzZWxlY3RQbG90QXJlYSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydE9mZnNldCwgc2VsZWN0Q2hhcnRXaWR0aCwgc2VsZWN0Q2hhcnRIZWlnaHRdLCAob2Zmc2V0LCBjaGFydFdpZHRoLCBjaGFydEhlaWdodCkgPT4gewogIGlmICghb2Zmc2V0IHx8IGNoYXJ0V2lkdGggPT0gbnVsbCB8fCBjaGFydEhlaWdodCA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICByZXR1cm4gewogICAgeDogb2Zmc2V0LmxlZnQsCiAgICB5OiBvZmZzZXQudG9wLAogICAgd2lkdGg6IE1hdGgubWF4KDAsIGNoYXJ0V2lkdGggLSBvZmZzZXQubGVmdCAtIG9mZnNldC5yaWdodCksCiAgICBoZWlnaHQ6IE1hdGgubWF4KDAsIGNoYXJ0SGVpZ2h0IC0gb2Zmc2V0LnRvcCAtIG9mZnNldC5ib3R0b20pCiAgfTsKfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9ob29rcy5qcwp2YXIgdXNlUGxvdEFyZWEgPSAoKSA9PiB7CiAgcmV0dXJuIHVzZUFwcFNlbGVjdG9yKHNlbGVjdFBsb3RBcmVhKTsKfTsKdmFyIHVzZUFjdGl2ZVRvb2x0aXBEYXRhUG9pbnRzID0gKCkgPT4gewogIHJldHVybiB1c2VBcHBTZWxlY3RvcihzZWxlY3RBY3RpdmVUb29sdGlwRGF0YVBvaW50cyk7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb21wb25lbnQvQWN0aXZlUG9pbnRzLmpzCmZ1bmN0aW9uIG93bktleXMyNihlLCByMikgewogIHZhciB0ID0gT2JqZWN0LmtleXMoZSk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBvID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIHIyICYmIChvID0gby5maWx0ZXIoZnVuY3Rpb24ocjMpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgcjMpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDI2KGUpIHsKICBmb3IgKHZhciByMiA9IDE7IHIyIDwgYXJndW1lbnRzLmxlbmd0aDsgcjIrKykgewogICAgdmFyIHQgPSBudWxsICE9IGFyZ3VtZW50c1tyMl0gPyBhcmd1bWVudHNbcjJdIDoge307CiAgICByMiAlIDIgPyBvd25LZXlzMjYoT2JqZWN0KHQpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTI3KGUsIHIzLCB0W3IzXSk7CiAgICB9KSA6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzID8gT2JqZWN0LmRlZmluZVByb3BlcnRpZXMoZSwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnModCkpIDogb3duS2V5czI2KE9iamVjdCh0KSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjMsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgcjMpKTsKICAgIH0pOwogIH0KICByZXR1cm4gZTsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkyNyhlLCByMiwgdCkgewogIHJldHVybiAocjIgPSBfdG9Qcm9wZXJ0eUtleTI3KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgeyB2YWx1ZTogdCwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBfdG9Qcm9wZXJ0eUtleTI3KHQpIHsKICB2YXIgaSA9IF90b1ByaW1pdGl2ZTI3KHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gdHlwZW9mIGkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF90b1ByaW1pdGl2ZTI3KHQsIHIyKSB7CiAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiB0IHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IHR5cGVvZiBpKSByZXR1cm4gaTsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkBAdG9QcmltaXRpdmUgbXVzdCByZXR1cm4gYSBwcmltaXRpdmUgdmFsdWUuIik7CiAgfQogIHJldHVybiAoInN0cmluZyIgPT09IHIyID8gU3RyaW5nIDogTnVtYmVyKSh0KTsKfQp2YXIgQWN0aXZlUG9pbnQgPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgcG9pbnQ6IHBvaW50NCwKICAgIGNoaWxkSW5kZXgsCiAgICBtYWluQ29sb3IsCiAgICBhY3RpdmVEb3QsCiAgICBkYXRhS2V5LAogICAgY2xpcFBhdGgKICB9ID0gX3JlZjI7CiAgaWYgKGFjdGl2ZURvdCA9PT0gZmFsc2UgfHwgcG9pbnQ0LnggPT0gbnVsbCB8fCBwb2ludDQueSA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGRvdFByb3BzVHlwZWQgPSB7CiAgICBpbmRleDogY2hpbGRJbmRleCwKICAgIGRhdGFLZXksCiAgICBjeDogcG9pbnQ0LngsCiAgICBjeTogcG9pbnQ0LnksCiAgICByOiA0LAogICAgZmlsbDogbWFpbkNvbG9yICE9PSBudWxsICYmIG1haW5Db2xvciAhPT0gdm9pZCAwID8gbWFpbkNvbG9yIDogIm5vbmUiLAogICAgc3Ryb2tlV2lkdGg6IDIsCiAgICBzdHJva2U6ICIjZmZmIiwKICAgIHBheWxvYWQ6IHBvaW50NC5wYXlsb2FkLAogICAgdmFsdWU6IHBvaW50NC52YWx1ZQogIH07CiAgdmFyIGRvdFByb3BzID0gX29iamVjdFNwcmVhZDI2KF9vYmplY3RTcHJlYWQyNihfb2JqZWN0U3ByZWFkMjYoe30sIGRvdFByb3BzVHlwZWQpLCBzdmdQcm9wZXJ0aWVzTm9FdmVudHNGcm9tVW5rbm93bihhY3RpdmVEb3QpKSwgYWRhcHRFdmVudEhhbmRsZXJzKGFjdGl2ZURvdCkpOwogIHZhciBkb3Q7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzQuaXNWYWxpZEVsZW1lbnQpKGFjdGl2ZURvdCkpIHsKICAgIGRvdCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzQuY2xvbmVFbGVtZW50KShhY3RpdmVEb3QsIGRvdFByb3BzKTsKICB9IGVsc2UgaWYgKHR5cGVvZiBhY3RpdmVEb3QgPT09ICJmdW5jdGlvbiIpIHsKICAgIGRvdCA9IGFjdGl2ZURvdChkb3RQcm9wcyk7CiAgfSBlbHNlIHsKICAgIGRvdCA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIwLmNyZWF0ZUVsZW1lbnQoRG90LCBkb3RQcm9wcyk7CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMC5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1hY3RpdmUtZG90IiwKICAgIGNsaXBQYXRoCiAgfSwgZG90KTsKfTsKZnVuY3Rpb24gQWN0aXZlUG9pbnRzKF9yZWYyKSB7CiAgdmFyIHsKICAgIHBvaW50cywKICAgIG1haW5Db2xvciwKICAgIGFjdGl2ZURvdCwKICAgIGl0ZW1EYXRhS2V5LAogICAgY2xpcFBhdGgsCiAgICB6SW5kZXggPSBEZWZhdWx0WkluZGV4ZXMuYWN0aXZlRG90CiAgfSA9IF9yZWYyOwogIHZhciBhY3RpdmVUb29sdGlwSW5kZXggPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RBY3RpdmVUb29sdGlwSW5kZXgpOwogIHZhciBhY3RpdmVEYXRhUG9pbnRzID0gdXNlQWN0aXZlVG9vbHRpcERhdGFQb2ludHMoKTsKICBpZiAocG9pbnRzID09IG51bGwgfHwgYWN0aXZlRGF0YVBvaW50cyA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGFjdGl2ZVBvaW50ID0gcG9pbnRzLmZpbmQoKHApID0+IGFjdGl2ZURhdGFQb2ludHMuaW5jbHVkZXMocC5wYXlsb2FkKSk7CiAgaWYgKGlzTnVsbGlzaChhY3RpdmVQb2ludCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjAuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4CiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjAuY3JlYXRlRWxlbWVudChBY3RpdmVQb2ludCwgewogICAgcG9pbnQ6IGFjdGl2ZVBvaW50LAogICAgY2hpbGRJbmRleDogTnVtYmVyKGFjdGl2ZVRvb2x0aXBJbmRleCksCiAgICBtYWluQ29sb3IsCiAgICBkYXRhS2V5OiBpdGVtRGF0YUtleSwKICAgIGFjdGl2ZURvdCwKICAgIGNsaXBQYXRoCiAgfSkpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9lcnJvckJhclNsaWNlLmpzCnZhciBpbml0aWFsU3RhdGU5ID0ge307CnZhciBlcnJvckJhclNsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJlcnJvckJhcnMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlOSwKICByZWR1Y2VyczogewogICAgYWRkRXJyb3JCYXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciB7CiAgICAgICAgaXRlbUlkLAogICAgICAgIGVycm9yQmFyCiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgaWYgKCFzdGF0ZVtpdGVtSWRdKSB7CiAgICAgICAgc3RhdGVbaXRlbUlkXSA9IFtdOwogICAgICB9CiAgICAgIHN0YXRlW2l0ZW1JZF0ucHVzaChlcnJvckJhcik7CiAgICB9LAogICAgcmVwbGFjZUVycm9yQmFyOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICB2YXIgewogICAgICAgIGl0ZW1JZCwKICAgICAgICBwcmV2LAogICAgICAgIG5leHQKICAgICAgfSA9IGFjdGlvbi5wYXlsb2FkOwogICAgICBpZiAoc3RhdGVbaXRlbUlkXSkgewogICAgICAgIHN0YXRlW2l0ZW1JZF0gPSBzdGF0ZVtpdGVtSWRdLm1hcCgoZSkgPT4gZS5kYXRhS2V5ID09PSBwcmV2LmRhdGFLZXkgJiYgZS5kaXJlY3Rpb24gPT09IHByZXYuZGlyZWN0aW9uID8gbmV4dCA6IGUpOwogICAgICB9CiAgICB9LAogICAgcmVtb3ZlRXJyb3JCYXI6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciB7CiAgICAgICAgaXRlbUlkLAogICAgICAgIGVycm9yQmFyCiAgICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgICAgaWYgKHN0YXRlW2l0ZW1JZF0pIHsKICAgICAgICBzdGF0ZVtpdGVtSWRdID0gc3RhdGVbaXRlbUlkXS5maWx0ZXIoKGUpID0+IGUuZGF0YUtleSAhPT0gZXJyb3JCYXIuZGF0YUtleSB8fCBlLmRpcmVjdGlvbiAhPT0gZXJyb3JCYXIuZGlyZWN0aW9uKTsKICAgICAgfQogICAgfQogIH0KfSk7CnZhciB7CiAgYWRkRXJyb3JCYXIsCiAgcmVwbGFjZUVycm9yQmFyLAogIHJlbW92ZUVycm9yQmFyCn0gPSBlcnJvckJhclNsaWNlLmFjdGlvbnM7CnZhciBlcnJvckJhclJlZHVjZXIgPSBlcnJvckJhclNsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vR3JhcGhpY2FsSXRlbUNsaXBQYXRoLmpzCnZhciBSZWFjdDIxID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiB1c2VOZWVkc0NsaXAoeEF4aXNJZCwgeUF4aXNJZCkgewogIHZhciBfeEF4aXMkYWxsb3dEYXRhT3ZlcmYsIF95QXhpcyRhbGxvd0RhdGFPdmVyZjsKICB2YXIgeEF4aXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFhBeGlzU2V0dGluZ3Moc3RhdGUsIHhBeGlzSWQpKTsKICB2YXIgeUF4aXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFlBeGlzU2V0dGluZ3Moc3RhdGUsIHlBeGlzSWQpKTsKICB2YXIgbmVlZENsaXBYID0gKF94QXhpcyRhbGxvd0RhdGFPdmVyZiA9IHhBeGlzID09PSBudWxsIHx8IHhBeGlzID09PSB2b2lkIDAgPyB2b2lkIDAgOiB4QXhpcy5hbGxvd0RhdGFPdmVyZmxvdykgIT09IG51bGwgJiYgX3hBeGlzJGFsbG93RGF0YU92ZXJmICE9PSB2b2lkIDAgPyBfeEF4aXMkYWxsb3dEYXRhT3ZlcmYgOiBpbXBsaWNpdFhBeGlzLmFsbG93RGF0YU92ZXJmbG93OwogIHZhciBuZWVkQ2xpcFkgPSAoX3lBeGlzJGFsbG93RGF0YU92ZXJmID0geUF4aXMgPT09IG51bGwgfHwgeUF4aXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHlBeGlzLmFsbG93RGF0YU92ZXJmbG93KSAhPT0gbnVsbCAmJiBfeUF4aXMkYWxsb3dEYXRhT3ZlcmYgIT09IHZvaWQgMCA/IF95QXhpcyRhbGxvd0RhdGFPdmVyZiA6IGltcGxpY2l0WUF4aXMuYWxsb3dEYXRhT3ZlcmZsb3c7CiAgdmFyIG5lZWRDbGlwID0gbmVlZENsaXBYIHx8IG5lZWRDbGlwWTsKICByZXR1cm4gewogICAgbmVlZENsaXAsCiAgICBuZWVkQ2xpcFgsCiAgICBuZWVkQ2xpcFkKICB9Owp9CmZ1bmN0aW9uIEdyYXBoaWNhbEl0ZW1DbGlwUGF0aChfcmVmMikgewogIHZhciB7CiAgICB4QXhpc0lkLAogICAgeUF4aXNJZCwKICAgIGNsaXBQYXRoSWQKICB9ID0gX3JlZjI7CiAgdmFyIHBsb3RBcmVhID0gdXNlUGxvdEFyZWEoKTsKICB2YXIgewogICAgbmVlZENsaXBYLAogICAgbmVlZENsaXBZLAogICAgbmVlZENsaXAKICB9ID0gdXNlTmVlZHNDbGlwKHhBeGlzSWQsIHlBeGlzSWQpOwogIGlmICghbmVlZENsaXAgfHwgIXBsb3RBcmVhKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBwbG90QXJlYTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjEuY3JlYXRlRWxlbWVudCgiY2xpcFBhdGgiLCB7CiAgICBpZDogImNsaXBQYXRoLSIuY29uY2F0KGNsaXBQYXRoSWQpCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjEuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgIHg6IG5lZWRDbGlwWCA/IHgyIDogeDIgLSB3aWR0aCAvIDIsCiAgICB5OiBuZWVkQ2xpcFkgPyB5MiA6IHkyIC0gaGVpZ2h0IC8gMiwKICAgIHdpZHRoOiBuZWVkQ2xpcFggPyB3aWR0aCA6IHdpZHRoICogMiwKICAgIGhlaWdodDogbmVlZENsaXBZID8gaGVpZ2h0IDogaGVpZ2h0ICogMgogIH0pKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlYWN0LXJlZHV4QDkuMi4wX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVhY3QtcmVkdXgvZGlzdC9yZWFjdC1yZWR1eC5tanMKdmFyIFJlYWN0MjIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSwgMSk7CnZhciBpbXBvcnRfd2l0aF9zZWxlY3RvcjIgPSBfX3RvRVNNKHJlcXVpcmVfd2l0aF9zZWxlY3RvcjIoKSwgMSk7CnZhciBSRUFDVF9GT1JXQVJEX1JFRl9UWVBFID0gLyogQF9fUFVSRV9fICovIFN5bWJvbC5mb3IoInJlYWN0LmZvcndhcmRfcmVmIik7CnZhciBSRUFDVF9NRU1PX1RZUEUgPSAvKiBAX19QVVJFX18gKi8gU3ltYm9sLmZvcigicmVhY3QubWVtbyIpOwp2YXIgRm9yd2FyZFJlZiA9IFJFQUNUX0ZPUldBUkRfUkVGX1RZUEU7CnZhciBNZW1vID0gUkVBQ1RfTUVNT19UWVBFOwpmdW5jdGlvbiBkZWZhdWx0Tm9vcEJhdGNoKGNhbGxiYWNrKSB7CiAgY2FsbGJhY2soKTsKfQpmdW5jdGlvbiBjcmVhdGVMaXN0ZW5lckNvbGxlY3Rpb24oKSB7CiAgbGV0IGZpcnN0ID0gbnVsbDsKICBsZXQgbGFzdDIgPSBudWxsOwogIHJldHVybiB7CiAgICBjbGVhcigpIHsKICAgICAgZmlyc3QgPSBudWxsOwogICAgICBsYXN0MiA9IG51bGw7CiAgICB9LAogICAgbm90aWZ5KCkgewogICAgICBkZWZhdWx0Tm9vcEJhdGNoKCgpID0+IHsKICAgICAgICBsZXQgbGlzdGVuZXIyID0gZmlyc3Q7CiAgICAgICAgd2hpbGUgKGxpc3RlbmVyMikgewogICAgICAgICAgbGlzdGVuZXIyLmNhbGxiYWNrKCk7CiAgICAgICAgICBsaXN0ZW5lcjIgPSBsaXN0ZW5lcjIubmV4dDsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGdldCgpIHsKICAgICAgY29uc3QgbGlzdGVuZXJzID0gW107CiAgICAgIGxldCBsaXN0ZW5lcjIgPSBmaXJzdDsKICAgICAgd2hpbGUgKGxpc3RlbmVyMikgewogICAgICAgIGxpc3RlbmVycy5wdXNoKGxpc3RlbmVyMik7CiAgICAgICAgbGlzdGVuZXIyID0gbGlzdGVuZXIyLm5leHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGxpc3RlbmVyczsKICAgIH0sCiAgICBzdWJzY3JpYmUoY2FsbGJhY2spIHsKICAgICAgbGV0IGlzU3Vic2NyaWJlZCA9IHRydWU7CiAgICAgIGNvbnN0IGxpc3RlbmVyMiA9IGxhc3QyID0gewogICAgICAgIGNhbGxiYWNrLAogICAgICAgIG5leHQ6IG51bGwsCiAgICAgICAgcHJldjogbGFzdDIKICAgICAgfTsKICAgICAgaWYgKGxpc3RlbmVyMi5wcmV2KSB7CiAgICAgICAgbGlzdGVuZXIyLnByZXYubmV4dCA9IGxpc3RlbmVyMjsKICAgICAgfSBlbHNlIHsKICAgICAgICBmaXJzdCA9IGxpc3RlbmVyMjsKICAgICAgfQogICAgICByZXR1cm4gZnVuY3Rpb24gdW5zdWJzY3JpYmUoKSB7CiAgICAgICAgaWYgKCFpc1N1YnNjcmliZWQgfHwgZmlyc3QgPT09IG51bGwpIHJldHVybjsKICAgICAgICBpc1N1YnNjcmliZWQgPSBmYWxzZTsKICAgICAgICBpZiAobGlzdGVuZXIyLm5leHQpIHsKICAgICAgICAgIGxpc3RlbmVyMi5uZXh0LnByZXYgPSBsaXN0ZW5lcjIucHJldjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbGFzdDIgPSBsaXN0ZW5lcjIucHJldjsKICAgICAgICB9CiAgICAgICAgaWYgKGxpc3RlbmVyMi5wcmV2KSB7CiAgICAgICAgICBsaXN0ZW5lcjIucHJldi5uZXh0ID0gbGlzdGVuZXIyLm5leHQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZpcnN0ID0gbGlzdGVuZXIyLm5leHQ7CiAgICAgICAgfQogICAgICB9OwogICAgfQogIH07Cn0KdmFyIG51bGxMaXN0ZW5lcnMgPSB7CiAgbm90aWZ5KCkgewogIH0sCiAgZ2V0OiAoKSA9PiBbXQp9OwpmdW5jdGlvbiBjcmVhdGVTdWJzY3JpcHRpb24oc3RvcmUsIHBhcmVudFN1YikgewogIGxldCB1bnN1YnNjcmliZTsKICBsZXQgbGlzdGVuZXJzID0gbnVsbExpc3RlbmVyczsKICBsZXQgc3Vic2NyaXB0aW9uc0Ftb3VudCA9IDA7CiAgbGV0IHNlbGZTdWJzY3JpYmVkID0gZmFsc2U7CiAgZnVuY3Rpb24gYWRkTmVzdGVkU3ViKGxpc3RlbmVyMikgewogICAgdHJ5U3Vic2NyaWJlKCk7CiAgICBjb25zdCBjbGVhbnVwTGlzdGVuZXIgPSBsaXN0ZW5lcnMuc3Vic2NyaWJlKGxpc3RlbmVyMik7CiAgICBsZXQgcmVtb3ZlZCA9IGZhbHNlOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKCFyZW1vdmVkKSB7CiAgICAgICAgcmVtb3ZlZCA9IHRydWU7CiAgICAgICAgY2xlYW51cExpc3RlbmVyKCk7CiAgICAgICAgdHJ5VW5zdWJzY3JpYmUoKTsKICAgICAgfQogICAgfTsKICB9CiAgZnVuY3Rpb24gbm90aWZ5TmVzdGVkU3VicygpIHsKICAgIGxpc3RlbmVycy5ub3RpZnkoKTsKICB9CiAgZnVuY3Rpb24gaGFuZGxlQ2hhbmdlV3JhcHBlcigpIHsKICAgIGlmIChzdWJzY3JpcHRpb24ub25TdGF0ZUNoYW5nZSkgewogICAgICBzdWJzY3JpcHRpb24ub25TdGF0ZUNoYW5nZSgpOwogICAgfQogIH0KICBmdW5jdGlvbiBpc1N1YnNjcmliZWQoKSB7CiAgICByZXR1cm4gc2VsZlN1YnNjcmliZWQ7CiAgfQogIGZ1bmN0aW9uIHRyeVN1YnNjcmliZSgpIHsKICAgIHN1YnNjcmlwdGlvbnNBbW91bnQrKzsKICAgIGlmICghdW5zdWJzY3JpYmUpIHsKICAgICAgdW5zdWJzY3JpYmUgPSBwYXJlbnRTdWIgPyBwYXJlbnRTdWIuYWRkTmVzdGVkU3ViKGhhbmRsZUNoYW5nZVdyYXBwZXIpIDogc3RvcmUuc3Vic2NyaWJlKGhhbmRsZUNoYW5nZVdyYXBwZXIpOwogICAgICBsaXN0ZW5lcnMgPSBjcmVhdGVMaXN0ZW5lckNvbGxlY3Rpb24oKTsKICAgIH0KICB9CiAgZnVuY3Rpb24gdHJ5VW5zdWJzY3JpYmUoKSB7CiAgICBzdWJzY3JpcHRpb25zQW1vdW50LS07CiAgICBpZiAodW5zdWJzY3JpYmUgJiYgc3Vic2NyaXB0aW9uc0Ftb3VudCA9PT0gMCkgewogICAgICB1bnN1YnNjcmliZSgpOwogICAgICB1bnN1YnNjcmliZSA9IHZvaWQgMDsKICAgICAgbGlzdGVuZXJzLmNsZWFyKCk7CiAgICAgIGxpc3RlbmVycyA9IG51bGxMaXN0ZW5lcnM7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyeVN1YnNjcmliZVNlbGYoKSB7CiAgICBpZiAoIXNlbGZTdWJzY3JpYmVkKSB7CiAgICAgIHNlbGZTdWJzY3JpYmVkID0gdHJ1ZTsKICAgICAgdHJ5U3Vic2NyaWJlKCk7CiAgICB9CiAgfQogIGZ1bmN0aW9uIHRyeVVuc3Vic2NyaWJlU2VsZigpIHsKICAgIGlmIChzZWxmU3Vic2NyaWJlZCkgewogICAgICBzZWxmU3Vic2NyaWJlZCA9IGZhbHNlOwogICAgICB0cnlVbnN1YnNjcmliZSgpOwogICAgfQogIH0KICBjb25zdCBzdWJzY3JpcHRpb24gPSB7CiAgICBhZGROZXN0ZWRTdWIsCiAgICBub3RpZnlOZXN0ZWRTdWJzLAogICAgaGFuZGxlQ2hhbmdlV3JhcHBlciwKICAgIGlzU3Vic2NyaWJlZCwKICAgIHRyeVN1YnNjcmliZTogdHJ5U3Vic2NyaWJlU2VsZiwKICAgIHRyeVVuc3Vic2NyaWJlOiB0cnlVbnN1YnNjcmliZVNlbGYsCiAgICBnZXRMaXN0ZW5lcnM6ICgpID0+IGxpc3RlbmVycwogIH07CiAgcmV0dXJuIHN1YnNjcmlwdGlvbjsKfQp2YXIgY2FuVXNlRE9NID0gKCkgPT4gISEodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50ICE9PSAidW5kZWZpbmVkIik7CnZhciBpc0RPTSA9IC8qIEBfX1BVUkVfXyAqLyBjYW5Vc2VET00oKTsKdmFyIGlzUnVubmluZ0luUmVhY3ROYXRpdmUgPSAoKSA9PiB0eXBlb2YgbmF2aWdhdG9yICE9PSAidW5kZWZpbmVkIiAmJiBuYXZpZ2F0b3IucHJvZHVjdCA9PT0gIlJlYWN0TmF0aXZlIjsKdmFyIGlzUmVhY3ROYXRpdmUgPSAvKiBAX19QVVJFX18gKi8gaXNSdW5uaW5nSW5SZWFjdE5hdGl2ZSgpOwp2YXIgZ2V0VXNlSXNvbW9ycGhpY0xheW91dEVmZmVjdCA9ICgpID0+IGlzRE9NIHx8IGlzUmVhY3ROYXRpdmUgPyBSZWFjdDIyLnVzZUxheW91dEVmZmVjdCA6IFJlYWN0MjIudXNlRWZmZWN0Owp2YXIgdXNlSXNvbW9ycGhpY0xheW91dEVmZmVjdCA9IC8qIEBfX1BVUkVfXyAqLyBnZXRVc2VJc29tb3JwaGljTGF5b3V0RWZmZWN0KCk7CmZ1bmN0aW9uIGlzMyh4MiwgeTIpIHsKICBpZiAoeDIgPT09IHkyKSB7CiAgICByZXR1cm4geDIgIT09IDAgfHwgeTIgIT09IDAgfHwgMSAvIHgyID09PSAxIC8geTI7CiAgfSBlbHNlIHsKICAgIHJldHVybiB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogIH0KfQpmdW5jdGlvbiBzaGFsbG93RXF1YWwob2JqQSwgb2JqQikgewogIGlmIChpczMob2JqQSwgb2JqQikpIHJldHVybiB0cnVlOwogIGlmICh0eXBlb2Ygb2JqQSAhPT0gIm9iamVjdCIgfHwgb2JqQSA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqQiAhPT0gIm9iamVjdCIgfHwgb2JqQiA9PT0gbnVsbCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBjb25zdCBrZXlzQSA9IE9iamVjdC5rZXlzKG9iakEpOwogIGNvbnN0IGtleXNCID0gT2JqZWN0LmtleXMob2JqQik7CiAgaWYgKGtleXNBLmxlbmd0aCAhPT0ga2V5c0IubGVuZ3RoKSByZXR1cm4gZmFsc2U7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBrZXlzQS5sZW5ndGg7IGkrKykgewogICAgaWYgKCFPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqQiwga2V5c0FbaV0pIHx8ICFpczMob2JqQVtrZXlzQVtpXV0sIG9iakJba2V5c0FbaV1dKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQogIHJldHVybiB0cnVlOwp9CnZhciBGT1JXQVJEX1JFRl9TVEFUSUNTID0gewogICQkdHlwZW9mOiB0cnVlLAogIHJlbmRlcjogdHJ1ZSwKICBkZWZhdWx0UHJvcHM6IHRydWUsCiAgZGlzcGxheU5hbWU6IHRydWUsCiAgcHJvcFR5cGVzOiB0cnVlCn07CnZhciBNRU1PX1NUQVRJQ1MgPSB7CiAgJCR0eXBlb2Y6IHRydWUsCiAgY29tcGFyZTogdHJ1ZSwKICBkZWZhdWx0UHJvcHM6IHRydWUsCiAgZGlzcGxheU5hbWU6IHRydWUsCiAgcHJvcFR5cGVzOiB0cnVlLAogIHR5cGU6IHRydWUKfTsKdmFyIFRZUEVfU1RBVElDUyA9IHsKICBbRm9yd2FyZFJlZl06IEZPUldBUkRfUkVGX1NUQVRJQ1MsCiAgW01lbW9dOiBNRU1PX1NUQVRJQ1MKfTsKdmFyIG9iamVjdFByb3RvdHlwZSA9IE9iamVjdC5wcm90b3R5cGU7CnZhciBDb250ZXh0S2V5ID0gLyogQF9fUFVSRV9fICovIFN5bWJvbC5mb3IoYHJlYWN0LXJlZHV4LWNvbnRleHRgKTsKdmFyIGdUID0gdHlwZW9mIGdsb2JhbFRoaXMgIT09ICJ1bmRlZmluZWQiID8gZ2xvYmFsVGhpcyA6ICgKICAvKiBmYWxsIGJhY2sgdG8gYSBwZXItbW9kdWxlIHNjb3BlIChwcmUtOC4xIGJlaGF2aW91cikgaWYgYGdsb2JhbFRoaXNgIGlzIG5vdCBhdmFpbGFibGUgKi8KICB7fQopOwpmdW5jdGlvbiBnZXRDb250ZXh0KCkgewogIGlmICghUmVhY3QyMi5jcmVhdGVDb250ZXh0KSByZXR1cm4ge307CiAgY29uc3QgY29udGV4dE1hcCA9IGdUW0NvbnRleHRLZXldID8/PSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogIGxldCByZWFsQ29udGV4dCA9IGNvbnRleHRNYXAuZ2V0KFJlYWN0MjIuY3JlYXRlQ29udGV4dCk7CiAgaWYgKCFyZWFsQ29udGV4dCkgewogICAgcmVhbENvbnRleHQgPSBSZWFjdDIyLmNyZWF0ZUNvbnRleHQoCiAgICAgIG51bGwKICAgICk7CiAgICBpZiAodHJ1ZSkgewogICAgICByZWFsQ29udGV4dC5kaXNwbGF5TmFtZSA9ICJSZWFjdFJlZHV4IjsKICAgIH0KICAgIGNvbnRleHRNYXAuc2V0KFJlYWN0MjIuY3JlYXRlQ29udGV4dCwgcmVhbENvbnRleHQpOwogIH0KICByZXR1cm4gcmVhbENvbnRleHQ7Cn0KdmFyIFJlYWN0UmVkdXhDb250ZXh0ID0gLyogQF9fUFVSRV9fICovIGdldENvbnRleHQoKTsKZnVuY3Rpb24gUHJvdmlkZXIocHJvdmlkZXJQcm9wcykgewogIGNvbnN0IHsgY2hpbGRyZW4sIGNvbnRleHQsIHNlcnZlclN0YXRlLCBzdG9yZSB9ID0gcHJvdmlkZXJQcm9wczsKICBjb25zdCBjb250ZXh0VmFsdWUgPSBSZWFjdDIyLnVzZU1lbW8oKCkgPT4gewogICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gY3JlYXRlU3Vic2NyaXB0aW9uKHN0b3JlKTsKICAgIGNvbnN0IGJhc2VDb250ZXh0VmFsdWUgPSB7CiAgICAgIHN0b3JlLAogICAgICBzdWJzY3JpcHRpb24sCiAgICAgIGdldFNlcnZlclN0YXRlOiBzZXJ2ZXJTdGF0ZSA/ICgpID0+IHNlcnZlclN0YXRlIDogdm9pZCAwCiAgICB9OwogICAgaWYgKGZhbHNlKSB7CiAgICAgIHJldHVybiBiYXNlQ29udGV4dFZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgeyBpZGVudGl0eUZ1bmN0aW9uQ2hlY2sgPSAib25jZSIsIHN0YWJpbGl0eUNoZWNrID0gIm9uY2UiIH0gPSBwcm92aWRlclByb3BzOwogICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIE9iamVjdC5hc3NpZ24oYmFzZUNvbnRleHRWYWx1ZSwgewogICAgICAgIHN0YWJpbGl0eUNoZWNrLAogICAgICAgIGlkZW50aXR5RnVuY3Rpb25DaGVjawogICAgICB9KTsKICAgIH0KICB9LCBbc3RvcmUsIHNlcnZlclN0YXRlXSk7CiAgY29uc3QgcHJldmlvdXNTdGF0ZSA9IFJlYWN0MjIudXNlTWVtbygoKSA9PiBzdG9yZS5nZXRTdGF0ZSgpLCBbc3RvcmVdKTsKICB1c2VJc29tb3JwaGljTGF5b3V0RWZmZWN0KCgpID0+IHsKICAgIGNvbnN0IHsgc3Vic2NyaXB0aW9uIH0gPSBjb250ZXh0VmFsdWU7CiAgICBzdWJzY3JpcHRpb24ub25TdGF0ZUNoYW5nZSA9IHN1YnNjcmlwdGlvbi5ub3RpZnlOZXN0ZWRTdWJzOwogICAgc3Vic2NyaXB0aW9uLnRyeVN1YnNjcmliZSgpOwogICAgaWYgKHByZXZpb3VzU3RhdGUgIT09IHN0b3JlLmdldFN0YXRlKCkpIHsKICAgICAgc3Vic2NyaXB0aW9uLm5vdGlmeU5lc3RlZFN1YnMoKTsKICAgIH0KICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHN1YnNjcmlwdGlvbi50cnlVbnN1YnNjcmliZSgpOwogICAgICBzdWJzY3JpcHRpb24ub25TdGF0ZUNoYW5nZSA9IHZvaWQgMDsKICAgIH07CiAgfSwgW2NvbnRleHRWYWx1ZSwgcHJldmlvdXNTdGF0ZV0pOwogIGNvbnN0IENvbnRleHQgPSBjb250ZXh0IHx8IFJlYWN0UmVkdXhDb250ZXh0OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyMi5jcmVhdGVFbGVtZW50KENvbnRleHQuUHJvdmlkZXIsIHsgdmFsdWU6IGNvbnRleHRWYWx1ZSB9LCBjaGlsZHJlbik7Cn0KdmFyIFByb3ZpZGVyX2RlZmF1bHQgPSBQcm92aWRlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvcHJvcHNBcmVFcXVhbC5qcwp2YXIgcHJvcHNUb1NoYWxsb3dDb21wYXJlID0gLyogQF9fUFVSRV9fICovIG5ldyBTZXQoWyJheGlzTGluZSIsICJ0aWNrTGluZSIsICJhY3RpdmVCYXIiLCAiYWN0aXZlRG90IiwgImFjdGl2ZUxhYmVsIiwgImFjdGl2ZVNoYXBlIiwgImFsbG93RXNjYXBlVmlld0JveCIsICJiYWNrZ3JvdW5kIiwgImN1cnNvciIsICJkb3QiLCAibGFiZWwiLCAibGluZSIsICJtYXJnaW4iLCAicGFkZGluZyIsICJwb3NpdGlvbiIsICJzaGFwZSIsICJzdHlsZSIsICJ0aWNrIiwgIndyYXBwZXJTdHlsZSJdKTsKZnVuY3Rpb24gc2FtZVZhbHVlWmVybyh4MiwgeTIpIHsKICBpZiAoeDIgPT0gbnVsbCAmJiB5MiA9PSBudWxsKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgaWYgKHR5cGVvZiB4MiA9PT0gIm51bWJlciIgJiYgdHlwZW9mIHkyID09PSAibnVtYmVyIikgewogICAgcmV0dXJuIHgyID09PSB5MiB8fCB4MiAhPT0geDIgJiYgeTIgIT09IHkyOwogIH0KICByZXR1cm4geDIgPT09IHkyOwp9CmZ1bmN0aW9uIHByb3BzQXJlRXF1YWwocHJldlByb3BzLCBuZXh0UHJvcHMpIHsKICB2YXIgYWxsS2V5cyA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgU2V0KFsuLi5PYmplY3Qua2V5cyhwcmV2UHJvcHMpLCAuLi5PYmplY3Qua2V5cyhuZXh0UHJvcHMpXSk7CiAgZm9yICh2YXIga2V5IG9mIGFsbEtleXMpIHsKICAgIGlmIChwcm9wc1RvU2hhbGxvd0NvbXBhcmUuaGFzKGtleSkpIHsKICAgICAgaWYgKHByZXZQcm9wc1trZXldID09IG51bGwgJiYgbmV4dFByb3BzW2tleV0gPT0gbnVsbCkgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CiAgICAgIGlmICghc2hhbGxvd0VxdWFsKHByZXZQcm9wc1trZXldLCBuZXh0UHJvcHNba2V5XSkpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoIXNhbWVWYWx1ZVplcm8ocHJldlByb3BzW2tleV0sIG5leHRQcm9wc1trZXldKSkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQogIHJldHVybiB0cnVlOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jb250ZXh0L2NoYXJ0RGF0YUNvbnRleHQuanMKdmFyIGltcG9ydF9yZWFjdDM1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgQ2hhcnREYXRhQ29udGV4dFByb3ZpZGVyID0gKHByb3BzKSA9PiB7CiAgdmFyIHsKICAgIGNoYXJ0RGF0YQogIH0gPSBwcm9wczsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogICgwLCBpbXBvcnRfcmVhY3QzNS51c2VFZmZlY3QpKCgpID0+IHsKICAgIGlmIChpc1Bhbm9yYW1hKSB7CiAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgIH07CiAgICB9CiAgICBkaXNwYXRjaChzZXRDaGFydERhdGEoY2hhcnREYXRhKSk7CiAgICByZXR1cm4gKCkgPT4gewogICAgICBkaXNwYXRjaChzZXRDaGFydERhdGEodm9pZCAwKSk7CiAgICB9OwogIH0sIFtjaGFydERhdGEsIGRpc3BhdGNoLCBpc1Bhbm9yYW1hXSk7CiAgcmV0dXJuIG51bGw7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9icnVzaFNsaWNlLmpzCnZhciBpbml0aWFsU3RhdGUxMCA9IHsKICB4OiAwLAogIHk6IDAsCiAgd2lkdGg6IDAsCiAgaGVpZ2h0OiAwLAogIHBhZGRpbmc6IHsKICAgIHRvcDogMCwKICAgIHJpZ2h0OiAwLAogICAgYm90dG9tOiAwLAogICAgbGVmdDogMAogIH0KfTsKdmFyIGJydXNoU2xpY2UgPSBjcmVhdGVTbGljZSh7CiAgbmFtZTogImJydXNoIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTEwLAogIHJlZHVjZXJzOiB7CiAgICBzZXRCcnVzaFNldHRpbmdzKF9zdGF0ZSwgYWN0aW9uKSB7CiAgICAgIGlmIChhY3Rpb24ucGF5bG9hZCA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGluaXRpYWxTdGF0ZTEwOwogICAgICB9CiAgICAgIHJldHVybiBhY3Rpb24ucGF5bG9hZDsKICAgIH0KICB9Cn0pOwp2YXIgewogIHNldEJydXNoU2V0dGluZ3MKfSA9IGJydXNoU2xpY2UuYWN0aW9uczsKdmFyIGJydXNoUmVkdWNlciA9IGJydXNoU2xpY2UucmVkdWNlcjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvQ2FydGVzaWFuVXRpbHMuanMKZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjgoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyOChyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyOCh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyOCh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyOCh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KdmFyIFNjYWxlSGVscGVyID0gY2xhc3MgX1NjYWxlSGVscGVyIHsKICBzdGF0aWMgY3JlYXRlKG9iaikgewogICAgcmV0dXJuIG5ldyBfU2NhbGVIZWxwZXIob2JqKTsKICB9CiAgY29uc3RydWN0b3Ioc2NhbGUpIHsKICAgIHRoaXMuc2NhbGUgPSBzY2FsZTsKICB9CiAgZ2V0IGRvbWFpbigpIHsKICAgIHJldHVybiB0aGlzLnNjYWxlLmRvbWFpbjsKICB9CiAgZ2V0IHJhbmdlKCkgewogICAgcmV0dXJuIHRoaXMuc2NhbGUucmFuZ2U7CiAgfQogIGdldCByYW5nZU1pbigpIHsKICAgIHJldHVybiB0aGlzLnJhbmdlKClbMF07CiAgfQogIGdldCByYW5nZU1heCgpIHsKICAgIHJldHVybiB0aGlzLnJhbmdlKClbMV07CiAgfQogIGdldCBiYW5kd2lkdGgoKSB7CiAgICByZXR1cm4gdGhpcy5zY2FsZS5iYW5kd2lkdGg7CiAgfQogIGFwcGx5KHZhbHVlKSB7CiAgICB2YXIgewogICAgICBiYW5kQXdhcmUsCiAgICAgIHBvc2l0aW9uCiAgICB9ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB2b2lkIDAgPyBhcmd1bWVudHNbMV0gOiB7fTsKICAgIGlmICh2YWx1ZSA9PT0gdm9pZCAwKSB7CiAgICAgIHJldHVybiB2b2lkIDA7CiAgICB9CiAgICBpZiAocG9zaXRpb24pIHsKICAgICAgc3dpdGNoIChwb3NpdGlvbikgewogICAgICAgIGNhc2UgInN0YXJ0IjogewogICAgICAgICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpOwogICAgICAgIH0KICAgICAgICBjYXNlICJtaWRkbGUiOiB7CiAgICAgICAgICB2YXIgb2Zmc2V0ID0gdGhpcy5iYW5kd2lkdGggPyB0aGlzLmJhbmR3aWR0aCgpIC8gMiA6IDA7CiAgICAgICAgICByZXR1cm4gdGhpcy5zY2FsZSh2YWx1ZSkgKyBvZmZzZXQ7CiAgICAgICAgfQogICAgICAgIGNhc2UgImVuZCI6IHsKICAgICAgICAgIHZhciBfb2Zmc2V0ID0gdGhpcy5iYW5kd2lkdGggPyB0aGlzLmJhbmR3aWR0aCgpIDogMDsKICAgICAgICAgIHJldHVybiB0aGlzLnNjYWxlKHZhbHVlKSArIF9vZmZzZXQ7CiAgICAgICAgfQogICAgICAgIGRlZmF1bHQ6IHsKICAgICAgICAgIHJldHVybiB0aGlzLnNjYWxlKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChiYW5kQXdhcmUpIHsKICAgICAgdmFyIF9vZmZzZXQyID0gdGhpcy5iYW5kd2lkdGggPyB0aGlzLmJhbmR3aWR0aCgpIC8gMiA6IDA7CiAgICAgIHJldHVybiB0aGlzLnNjYWxlKHZhbHVlKSArIF9vZmZzZXQyOwogICAgfQogICAgcmV0dXJuIHRoaXMuc2NhbGUodmFsdWUpOwogIH0KICBpc0luUmFuZ2UodmFsdWUpIHsKICAgIHZhciByYW5nZTQgPSB0aGlzLnJhbmdlKCk7CiAgICB2YXIgZmlyc3QgPSByYW5nZTRbMF07CiAgICB2YXIgbGFzdDIgPSByYW5nZTRbcmFuZ2U0Lmxlbmd0aCAtIDFdOwogICAgcmV0dXJuIGZpcnN0IDw9IGxhc3QyID8gdmFsdWUgPj0gZmlyc3QgJiYgdmFsdWUgPD0gbGFzdDIgOiB2YWx1ZSA+PSBsYXN0MiAmJiB2YWx1ZSA8PSBmaXJzdDsKICB9Cn07Cl9kZWZpbmVQcm9wZXJ0eTI4KFNjYWxlSGVscGVyLCAiRVBTIiwgMWUtNCk7CmZ1bmN0aW9uIG5vcm1hbGl6ZUFuZ2xlKGFuZ2xlKSB7CiAgcmV0dXJuIChhbmdsZSAlIDE4MCArIDE4MCkgJSAxODA7Cn0KdmFyIGdldEFuZ2xlZFJlY3RhbmdsZVdpZHRoID0gZnVuY3Rpb24gZ2V0QW5nbGVkUmVjdGFuZ2xlV2lkdGgyKF9yZWY1KSB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IF9yZWY1OwogIHZhciBhbmdsZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdm9pZCAwID8gYXJndW1lbnRzWzFdIDogMDsKICB2YXIgbm9ybWFsaXplZEFuZ2xlID0gbm9ybWFsaXplQW5nbGUoYW5nbGUpOwogIHZhciBhbmdsZVJhZGlhbnMgPSBub3JtYWxpemVkQW5nbGUgKiBNYXRoLlBJIC8gMTgwOwogIHZhciBhbmdsZVRocmVzaG9sZCA9IE1hdGguYXRhbihoZWlnaHQgLyB3aWR0aCk7CiAgdmFyIGFuZ2xlZFdpZHRoID0gYW5nbGVSYWRpYW5zID4gYW5nbGVUaHJlc2hvbGQgJiYgYW5nbGVSYWRpYW5zIDwgTWF0aC5QSSAtIGFuZ2xlVGhyZXNob2xkID8gaGVpZ2h0IC8gTWF0aC5zaW4oYW5nbGVSYWRpYW5zKSA6IHdpZHRoIC8gTWF0aC5jb3MoYW5nbGVSYWRpYW5zKTsKICByZXR1cm4gTWF0aC5hYnMoYW5nbGVkV2lkdGgpOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvcmVmZXJlbmNlRWxlbWVudHNTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlMTEgPSB7CiAgZG90czogW10sCiAgYXJlYXM6IFtdLAogIGxpbmVzOiBbXQp9Owp2YXIgcmVmZXJlbmNlRWxlbWVudHNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAicmVmZXJlbmNlRWxlbWVudHMiLAogIGluaXRpYWxTdGF0ZTogaW5pdGlhbFN0YXRlMTEsCiAgcmVkdWNlcnM6IHsKICAgIGFkZERvdDogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgc3RhdGUuZG90cy5wdXNoKGFjdGlvbi5wYXlsb2FkKTsKICAgIH0sCiAgICByZW1vdmVEb3Q6IChzdGF0ZSwgYWN0aW9uKSA9PiB7CiAgICAgIHZhciBpbmRleCA9IGN1cnJlbnQoc3RhdGUpLmRvdHMuZmluZEluZGV4KChkb3QpID0+IGRvdCA9PT0gYWN0aW9uLnBheWxvYWQpOwogICAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgICAgc3RhdGUuZG90cy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CiAgICB9LAogICAgYWRkQXJlYTogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgc3RhdGUuYXJlYXMucHVzaChhY3Rpb24ucGF5bG9hZCk7CiAgICB9LAogICAgcmVtb3ZlQXJlYTogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgdmFyIGluZGV4ID0gY3VycmVudChzdGF0ZSkuYXJlYXMuZmluZEluZGV4KChhcmVhKSA9PiBhcmVhID09PSBhY3Rpb24ucGF5bG9hZCk7CiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHsKICAgICAgICBzdGF0ZS5hcmVhcy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICB9CiAgICB9LAogICAgYWRkTGluZTogKHN0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgc3RhdGUubGluZXMucHVzaChjYXN0RHJhZnQoYWN0aW9uLnBheWxvYWQpKTsKICAgIH0sCiAgICByZW1vdmVMaW5lOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICB2YXIgaW5kZXggPSBjdXJyZW50KHN0YXRlKS5saW5lcy5maW5kSW5kZXgoKGxpbmUpID0+IGxpbmUgPT09IGFjdGlvbi5wYXlsb2FkKTsKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgIHN0YXRlLmxpbmVzLnNwbGljZShpbmRleCwgMSk7CiAgICAgIH0KICAgIH0KICB9Cn0pOwp2YXIgewogIGFkZERvdCwKICByZW1vdmVEb3QsCiAgYWRkQXJlYSwKICByZW1vdmVBcmVhLAogIGFkZExpbmUsCiAgcmVtb3ZlTGluZQp9ID0gcmVmZXJlbmNlRWxlbWVudHNTbGljZS5hY3Rpb25zOwp2YXIgcmVmZXJlbmNlRWxlbWVudHNSZWR1Y2VyID0gcmVmZXJlbmNlRWxlbWVudHNTbGljZS5yZWR1Y2VyOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL0NsaXBQYXRoUHJvdmlkZXIuanMKdmFyIFJlYWN0MjMgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QzNiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIENsaXBQYXRoSWRDb250ZXh0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzNi5jcmVhdGVDb250ZXh0KSh2b2lkIDApOwp2YXIgQ2xpcFBhdGhQcm92aWRlciA9IChfcmVmMikgPT4gewogIHZhciB7CiAgICBjaGlsZHJlbgogIH0gPSBfcmVmMjsKICB2YXIgW2NsaXBQYXRoSWRdID0gKDAsIGltcG9ydF9yZWFjdDM2LnVzZVN0YXRlKSgiIi5jb25jYXQodW5pcXVlSWQoInJlY2hhcnRzIiksICItY2xpcCIpKTsKICB2YXIgcGxvdEFyZWEgPSB1c2VQbG90QXJlYSgpOwogIGlmIChwbG90QXJlYSA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBwbG90QXJlYTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjMuY3JlYXRlRWxlbWVudChDbGlwUGF0aElkQ29udGV4dC5Qcm92aWRlciwgewogICAgdmFsdWU6IGNsaXBQYXRoSWQKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyMy5jcmVhdGVFbGVtZW50KCJkZWZzIiwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MjMuY3JlYXRlRWxlbWVudCgiY2xpcFBhdGgiLCB7CiAgICBpZDogY2xpcFBhdGhJZAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDIzLmNyZWF0ZUVsZW1lbnQoInJlY3QiLCB7CiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgaGVpZ2h0LAogICAgd2lkdGgKICB9KSkpLCBjaGlsZHJlbik7Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vQ2FydGVzaWFuQXhpcy5qcwp2YXIgUmVhY3QyNCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM3ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X2dldDMgPSBfX3RvRVNNKHJlcXVpcmVfZ2V0MigpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvZ2V0RXZlcnlOdGhXaXRoQ29uZGl0aW9uLmpzCmZ1bmN0aW9uIGdldEV2ZXJ5TnRoV2l0aENvbmRpdGlvbihhcnJheSwgbikgewogIGlmIChuIDwgMSkgewogICAgcmV0dXJuIFtdOwogIH0KICBpZiAobiA9PT0gMSkgewogICAgcmV0dXJuIGFycmF5OwogIH0KICB2YXIgcmVzdWx0ID0gW107CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkgKz0gbikgewogICAgcmVzdWx0LnB1c2goYXJyYXlbaV0pOwogIH0KICByZXR1cm4gcmVzdWx0Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL1RpY2tVdGlscy5qcwpmdW5jdGlvbiBnZXRBbmdsZWRUaWNrV2lkdGgoY29udGVudFNpemUsIHVuaXRTaXplLCBhbmdsZSkgewogIHZhciBzaXplID0gewogICAgd2lkdGg6IGNvbnRlbnRTaXplLndpZHRoICsgdW5pdFNpemUud2lkdGgsCiAgICBoZWlnaHQ6IGNvbnRlbnRTaXplLmhlaWdodCArIHVuaXRTaXplLmhlaWdodAogIH07CiAgcmV0dXJuIGdldEFuZ2xlZFJlY3RhbmdsZVdpZHRoKHNpemUsIGFuZ2xlKTsKfQpmdW5jdGlvbiBnZXRUaWNrQm91bmRhcmllcyh2aWV3Qm94LCBzaWduMiwgc2l6ZUtleSkgewogIHZhciBpc1dpZHRoID0gc2l6ZUtleSA9PT0gIndpZHRoIjsKICB2YXIgewogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0CiAgfSA9IHZpZXdCb3g7CiAgaWYgKHNpZ24yID09PSAxKSB7CiAgICByZXR1cm4gewogICAgICBzdGFydDogaXNXaWR0aCA/IHgyIDogeTIsCiAgICAgIGVuZDogaXNXaWR0aCA/IHgyICsgd2lkdGggOiB5MiArIGhlaWdodAogICAgfTsKICB9CiAgcmV0dXJuIHsKICAgIHN0YXJ0OiBpc1dpZHRoID8geDIgKyB3aWR0aCA6IHkyICsgaGVpZ2h0LAogICAgZW5kOiBpc1dpZHRoID8geDIgOiB5MgogIH07Cn0KZnVuY3Rpb24gaXNWaXNpYmxlKHNpZ24yLCB0aWNrUG9zaXRpb24sIGdldFNpemUsIHN0YXJ0LCBlbmQpIHsKICBpZiAoc2lnbjIgKiB0aWNrUG9zaXRpb24gPCBzaWduMiAqIHN0YXJ0IHx8IHNpZ24yICogdGlja1Bvc2l0aW9uID4gc2lnbjIgKiBlbmQpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgdmFyIHNpemUgPSBnZXRTaXplKCk7CiAgcmV0dXJuIHNpZ24yICogKHRpY2tQb3NpdGlvbiAtIHNpZ24yICogc2l6ZSAvIDIgLSBzdGFydCkgPj0gMCAmJiBzaWduMiAqICh0aWNrUG9zaXRpb24gKyBzaWduMiAqIHNpemUgLyAyIC0gZW5kKSA8PSAwOwp9CmZ1bmN0aW9uIGdldE51bWJlckludGVydmFsVGlja3ModGlja3MyLCBpbnRlcnZhbCkgewogIHJldHVybiBnZXRFdmVyeU50aFdpdGhDb25kaXRpb24odGlja3MyLCBpbnRlcnZhbCArIDEpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vZ2V0RXF1aWRpc3RhbnRUaWNrcy5qcwpmdW5jdGlvbiBnZXRFcXVpZGlzdGFudFRpY2tzKHNpZ24yLCBib3VuZGFyaWVzLCBnZXRUaWNrU2l6ZSwgdGlja3MyLCBtaW5UaWNrR2FwKSB7CiAgdmFyIHJlc3VsdCA9ICh0aWNrczIgfHwgW10pLnNsaWNlKCk7CiAgdmFyIHsKICAgIHN0YXJ0OiBpbml0aWFsU3RhcnQsCiAgICBlbmQKICB9ID0gYm91bmRhcmllczsKICB2YXIgaW5kZXggPSAwOwogIHZhciBzdGVwc2l6ZSA9IDE7CiAgdmFyIHN0YXJ0ID0gaW5pdGlhbFN0YXJ0OwogIHZhciBfbG9vcCA9IGZ1bmN0aW9uIF9sb29wMigpIHsKICAgIHZhciBlbnRyeSA9IHRpY2tzMiA9PT0gbnVsbCB8fCB0aWNrczIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHRpY2tzMltpbmRleF07CiAgICBpZiAoZW50cnkgPT09IHZvaWQgMCkgewogICAgICByZXR1cm4gewogICAgICAgIHY6IGdldEV2ZXJ5TnRoV2l0aENvbmRpdGlvbih0aWNrczIsIHN0ZXBzaXplKQogICAgICB9OwogICAgfQogICAgdmFyIGkgPSBpbmRleDsKICAgIHZhciBzaXplOwogICAgdmFyIGdldFNpemUgPSAoKSA9PiB7CiAgICAgIGlmIChzaXplID09PSB2b2lkIDApIHsKICAgICAgICBzaXplID0gZ2V0VGlja1NpemUoZW50cnksIGkpOwogICAgICB9CiAgICAgIHJldHVybiBzaXplOwogICAgfTsKICAgIHZhciB0aWNrQ29vcmQgPSBlbnRyeS5jb29yZGluYXRlOwogICAgdmFyIGlzU2hvdyA9IGluZGV4ID09PSAwIHx8IGlzVmlzaWJsZShzaWduMiwgdGlja0Nvb3JkLCBnZXRTaXplLCBzdGFydCwgZW5kKTsKICAgIGlmICghaXNTaG93KSB7CiAgICAgIGluZGV4ID0gMDsKICAgICAgc3RhcnQgPSBpbml0aWFsU3RhcnQ7CiAgICAgIHN0ZXBzaXplICs9IDE7CiAgICB9CiAgICBpZiAoaXNTaG93KSB7CiAgICAgIHN0YXJ0ID0gdGlja0Nvb3JkICsgc2lnbjIgKiAoZ2V0U2l6ZSgpIC8gMiArIG1pblRpY2tHYXApOwogICAgICBpbmRleCArPSBzdGVwc2l6ZTsKICAgIH0KICB9LCBfcmV0OwogIHdoaWxlIChzdGVwc2l6ZSA8PSByZXN1bHQubGVuZ3RoKSB7CiAgICBfcmV0ID0gX2xvb3AoKTsKICAgIGlmIChfcmV0KSByZXR1cm4gX3JldC52OwogIH0KICByZXR1cm4gW107Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9nZXRUaWNrcy5qcwpmdW5jdGlvbiBvd25LZXlzMjcoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyNyhlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czI3KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkyOShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyNyhPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MjkoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkyOShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkyOSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUyOSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUyOSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gZ2V0VGlja3NFbmQoc2lnbjIsIGJvdW5kYXJpZXMsIGdldFRpY2tTaXplLCB0aWNrczIsIG1pblRpY2tHYXApIHsKICB2YXIgcmVzdWx0ID0gKHRpY2tzMiB8fCBbXSkuc2xpY2UoKTsKICB2YXIgbGVuID0gcmVzdWx0Lmxlbmd0aDsKICB2YXIgewogICAgc3RhcnQKICB9ID0gYm91bmRhcmllczsKICB2YXIgewogICAgZW5kCiAgfSA9IGJvdW5kYXJpZXM7CiAgdmFyIF9sb29wID0gZnVuY3Rpb24gX2xvb3AyKGkyKSB7CiAgICB2YXIgZW50cnkgPSByZXN1bHRbaTJdOwogICAgdmFyIHNpemU7CiAgICB2YXIgZ2V0U2l6ZSA9ICgpID0+IHsKICAgICAgaWYgKHNpemUgPT09IHZvaWQgMCkgewogICAgICAgIHNpemUgPSBnZXRUaWNrU2l6ZShlbnRyeSwgaTIpOwogICAgICB9CiAgICAgIHJldHVybiBzaXplOwogICAgfTsKICAgIGlmIChpMiA9PT0gbGVuIC0gMSkgewogICAgICB2YXIgZ2FwID0gc2lnbjIgKiAoZW50cnkuY29vcmRpbmF0ZSArIHNpZ24yICogZ2V0U2l6ZSgpIC8gMiAtIGVuZCk7CiAgICAgIHJlc3VsdFtpMl0gPSBlbnRyeSA9IF9vYmplY3RTcHJlYWQyNyhfb2JqZWN0U3ByZWFkMjcoe30sIGVudHJ5KSwge30sIHsKICAgICAgICB0aWNrQ29vcmQ6IGdhcCA+IDAgPyBlbnRyeS5jb29yZGluYXRlIC0gZ2FwICogc2lnbjIgOiBlbnRyeS5jb29yZGluYXRlCiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgcmVzdWx0W2kyXSA9IGVudHJ5ID0gX29iamVjdFNwcmVhZDI3KF9vYmplY3RTcHJlYWQyNyh7fSwgZW50cnkpLCB7fSwgewogICAgICAgIHRpY2tDb29yZDogZW50cnkuY29vcmRpbmF0ZQogICAgICB9KTsKICAgIH0KICAgIGlmIChlbnRyeS50aWNrQ29vcmQgIT0gbnVsbCkgewogICAgICB2YXIgaXNTaG93ID0gaXNWaXNpYmxlKHNpZ24yLCBlbnRyeS50aWNrQ29vcmQsIGdldFNpemUsIHN0YXJ0LCBlbmQpOwogICAgICBpZiAoaXNTaG93KSB7CiAgICAgICAgZW5kID0gZW50cnkudGlja0Nvb3JkIC0gc2lnbjIgKiAoZ2V0U2l6ZSgpIC8gMiArIG1pblRpY2tHYXApOwogICAgICAgIHJlc3VsdFtpMl0gPSBfb2JqZWN0U3ByZWFkMjcoX29iamVjdFNwcmVhZDI3KHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgICBpc1Nob3c6IHRydWUKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH07CiAgZm9yICh2YXIgaSA9IGxlbiAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICBfbG9vcChpKTsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiBnZXRUaWNrc1N0YXJ0KHNpZ24yLCBib3VuZGFyaWVzLCBnZXRUaWNrU2l6ZSwgdGlja3MyLCBtaW5UaWNrR2FwLCBwcmVzZXJ2ZUVuZCkgewogIHZhciByZXN1bHQgPSAodGlja3MyIHx8IFtdKS5zbGljZSgpOwogIHZhciBsZW4gPSByZXN1bHQubGVuZ3RoOwogIHZhciB7CiAgICBzdGFydCwKICAgIGVuZAogIH0gPSBib3VuZGFyaWVzOwogIGlmIChwcmVzZXJ2ZUVuZCkgewogICAgdmFyIHRhaWwgPSB0aWNrczJbbGVuIC0gMV07CiAgICB2YXIgdGFpbFNpemUgPSBnZXRUaWNrU2l6ZSh0YWlsLCBsZW4gLSAxKTsKICAgIHZhciB0YWlsR2FwID0gc2lnbjIgKiAodGFpbC5jb29yZGluYXRlICsgc2lnbjIgKiB0YWlsU2l6ZSAvIDIgLSBlbmQpOwogICAgcmVzdWx0W2xlbiAtIDFdID0gdGFpbCA9IF9vYmplY3RTcHJlYWQyNyhfb2JqZWN0U3ByZWFkMjcoe30sIHRhaWwpLCB7fSwgewogICAgICB0aWNrQ29vcmQ6IHRhaWxHYXAgPiAwID8gdGFpbC5jb29yZGluYXRlIC0gdGFpbEdhcCAqIHNpZ24yIDogdGFpbC5jb29yZGluYXRlCiAgICB9KTsKICAgIGlmICh0YWlsLnRpY2tDb29yZCAhPSBudWxsKSB7CiAgICAgIHZhciBpc1RhaWxTaG93ID0gaXNWaXNpYmxlKHNpZ24yLCB0YWlsLnRpY2tDb29yZCwgKCkgPT4gdGFpbFNpemUsIHN0YXJ0LCBlbmQpOwogICAgICBpZiAoaXNUYWlsU2hvdykgewogICAgICAgIGVuZCA9IHRhaWwudGlja0Nvb3JkIC0gc2lnbjIgKiAodGFpbFNpemUgLyAyICsgbWluVGlja0dhcCk7CiAgICAgICAgcmVzdWx0W2xlbiAtIDFdID0gX29iamVjdFNwcmVhZDI3KF9vYmplY3RTcHJlYWQyNyh7fSwgdGFpbCksIHt9LCB7CiAgICAgICAgICBpc1Nob3c6IHRydWUKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH0KICB2YXIgY291bnQgPSBwcmVzZXJ2ZUVuZCA/IGxlbiAtIDEgOiBsZW47CiAgdmFyIF9sb29wMiA9IGZ1bmN0aW9uIF9sb29wMjIoaTIpIHsKICAgIHZhciBlbnRyeSA9IHJlc3VsdFtpMl07CiAgICB2YXIgc2l6ZTsKICAgIHZhciBnZXRTaXplID0gKCkgPT4gewogICAgICBpZiAoc2l6ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgc2l6ZSA9IGdldFRpY2tTaXplKGVudHJ5LCBpMik7CiAgICAgIH0KICAgICAgcmV0dXJuIHNpemU7CiAgICB9OwogICAgaWYgKGkyID09PSAwKSB7CiAgICAgIHZhciBnYXAgPSBzaWduMiAqIChlbnRyeS5jb29yZGluYXRlIC0gc2lnbjIgKiBnZXRTaXplKCkgLyAyIC0gc3RhcnQpOwogICAgICByZXN1bHRbaTJdID0gZW50cnkgPSBfb2JqZWN0U3ByZWFkMjcoX29iamVjdFNwcmVhZDI3KHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgdGlja0Nvb3JkOiBnYXAgPCAwID8gZW50cnkuY29vcmRpbmF0ZSAtIGdhcCAqIHNpZ24yIDogZW50cnkuY29vcmRpbmF0ZQogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHJlc3VsdFtpMl0gPSBlbnRyeSA9IF9vYmplY3RTcHJlYWQyNyhfb2JqZWN0U3ByZWFkMjcoe30sIGVudHJ5KSwge30sIHsKICAgICAgICB0aWNrQ29vcmQ6IGVudHJ5LmNvb3JkaW5hdGUKICAgICAgfSk7CiAgICB9CiAgICBpZiAoZW50cnkudGlja0Nvb3JkICE9IG51bGwpIHsKICAgICAgdmFyIGlzU2hvdyA9IGlzVmlzaWJsZShzaWduMiwgZW50cnkudGlja0Nvb3JkLCBnZXRTaXplLCBzdGFydCwgZW5kKTsKICAgICAgaWYgKGlzU2hvdykgewogICAgICAgIHN0YXJ0ID0gZW50cnkudGlja0Nvb3JkICsgc2lnbjIgKiAoZ2V0U2l6ZSgpIC8gMiArIG1pblRpY2tHYXApOwogICAgICAgIHJlc3VsdFtpMl0gPSBfb2JqZWN0U3ByZWFkMjcoX29iamVjdFNwcmVhZDI3KHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgICBpc1Nob3c6IHRydWUKICAgICAgICB9KTsKICAgICAgfQogICAgfQogIH07CiAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICBfbG9vcDIoaSk7CiAgfQogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gZ2V0VGlja3MocHJvcHMsIGZvbnRTaXplLCBsZXR0ZXJTcGFjaW5nKSB7CiAgdmFyIHsKICAgIHRpY2ssCiAgICB0aWNrczogdGlja3MyLAogICAgdmlld0JveCwKICAgIG1pblRpY2tHYXAsCiAgICBvcmllbnRhdGlvbiwKICAgIGludGVydmFsLAogICAgdGlja0Zvcm1hdHRlciwKICAgIHVuaXQ6IHVuaXQyLAogICAgYW5nbGUKICB9ID0gcHJvcHM7CiAgaWYgKCF0aWNrczIgfHwgIXRpY2tzMi5sZW5ndGggfHwgIXRpY2spIHsKICAgIHJldHVybiBbXTsKICB9CiAgaWYgKGlzTnVtYmVyKGludGVydmFsKSB8fCBHbG9iYWwuaXNTc3IpIHsKICAgIHZhciBfZ2V0TnVtYmVySW50ZXJ2YWxUaWM7CiAgICByZXR1cm4gKF9nZXROdW1iZXJJbnRlcnZhbFRpYyA9IGdldE51bWJlckludGVydmFsVGlja3ModGlja3MyLCBpc051bWJlcihpbnRlcnZhbCkgPyBpbnRlcnZhbCA6IDApKSAhPT0gbnVsbCAmJiBfZ2V0TnVtYmVySW50ZXJ2YWxUaWMgIT09IHZvaWQgMCA/IF9nZXROdW1iZXJJbnRlcnZhbFRpYyA6IFtdOwogIH0KICB2YXIgY2FuZGlkYXRlcyA9IFtdOwogIHZhciBzaXplS2V5ID0gb3JpZW50YXRpb24gPT09ICJ0b3AiIHx8IG9yaWVudGF0aW9uID09PSAiYm90dG9tIiA/ICJ3aWR0aCIgOiAiaGVpZ2h0IjsKICB2YXIgdW5pdFNpemUgPSB1bml0MiAmJiBzaXplS2V5ID09PSAid2lkdGgiID8gZ2V0U3RyaW5nU2l6ZSh1bml0MiwgewogICAgZm9udFNpemUsCiAgICBsZXR0ZXJTcGFjaW5nCiAgfSkgOiB7CiAgICB3aWR0aDogMCwKICAgIGhlaWdodDogMAogIH07CiAgdmFyIGdldFRpY2tTaXplID0gKGNvbnRlbnQsIGluZGV4KSA9PiB7CiAgICB2YXIgdmFsdWUgPSB0eXBlb2YgdGlja0Zvcm1hdHRlciA9PT0gImZ1bmN0aW9uIiA/IHRpY2tGb3JtYXR0ZXIoY29udGVudC52YWx1ZSwgaW5kZXgpIDogY29udGVudC52YWx1ZTsKICAgIHJldHVybiBzaXplS2V5ID09PSAid2lkdGgiID8gZ2V0QW5nbGVkVGlja1dpZHRoKGdldFN0cmluZ1NpemUodmFsdWUsIHsKICAgICAgZm9udFNpemUsCiAgICAgIGxldHRlclNwYWNpbmcKICAgIH0pLCB1bml0U2l6ZSwgYW5nbGUpIDogZ2V0U3RyaW5nU2l6ZSh2YWx1ZSwgewogICAgICBmb250U2l6ZSwKICAgICAgbGV0dGVyU3BhY2luZwogICAgfSlbc2l6ZUtleV07CiAgfTsKICB2YXIgc2lnbjIgPSB0aWNrczIubGVuZ3RoID49IDIgPyBtYXRoU2lnbih0aWNrczJbMV0uY29vcmRpbmF0ZSAtIHRpY2tzMlswXS5jb29yZGluYXRlKSA6IDE7CiAgdmFyIGJvdW5kYXJpZXMgPSBnZXRUaWNrQm91bmRhcmllcyh2aWV3Qm94LCBzaWduMiwgc2l6ZUtleSk7CiAgaWYgKGludGVydmFsID09PSAiZXF1aWRpc3RhbnRQcmVzZXJ2ZVN0YXJ0IikgewogICAgcmV0dXJuIGdldEVxdWlkaXN0YW50VGlja3Moc2lnbjIsIGJvdW5kYXJpZXMsIGdldFRpY2tTaXplLCB0aWNrczIsIG1pblRpY2tHYXApOwogIH0KICBpZiAoaW50ZXJ2YWwgPT09ICJwcmVzZXJ2ZVN0YXJ0IiB8fCBpbnRlcnZhbCA9PT0gInByZXNlcnZlU3RhcnRFbmQiKSB7CiAgICBjYW5kaWRhdGVzID0gZ2V0VGlja3NTdGFydChzaWduMiwgYm91bmRhcmllcywgZ2V0VGlja1NpemUsIHRpY2tzMiwgbWluVGlja0dhcCwgaW50ZXJ2YWwgPT09ICJwcmVzZXJ2ZVN0YXJ0RW5kIik7CiAgfSBlbHNlIHsKICAgIGNhbmRpZGF0ZXMgPSBnZXRUaWNrc0VuZChzaWduMiwgYm91bmRhcmllcywgZ2V0VGlja1NpemUsIHRpY2tzMiwgbWluVGlja0dhcCk7CiAgfQogIHJldHVybiBjYW5kaWRhdGVzLmZpbHRlcigoZW50cnkpID0+IGVudHJ5LmlzU2hvdyk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvWUF4aXNVdGlscy5qcwp2YXIgZ2V0Q2FsY3VsYXRlZFlBeGlzV2lkdGggPSAoX3JlZjIpID0+IHsKICB2YXIgewogICAgdGlja3M6IHRpY2tzMiwKICAgIGxhYmVsLAogICAgbGFiZWxHYXBXaXRoVGljayA9IDUsCiAgICAvLyBEZWZhdWx0IGdhcCBiZXR3ZWVuIGxhYmVsIGFuZCB0aWNrCiAgICB0aWNrU2l6ZSA9IDAsCiAgICB0aWNrTWFyZ2luID0gMAogIH0gPSBfcmVmMjsKICB2YXIgbWF4VGlja1dpZHRoID0gMDsKICBpZiAodGlja3MyKSB7CiAgICBBcnJheS5mcm9tKHRpY2tzMikuZm9yRWFjaCgodGlja05vZGUpID0+IHsKICAgICAgaWYgKHRpY2tOb2RlKSB7CiAgICAgICAgdmFyIGJib3ggPSB0aWNrTm9kZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICBpZiAoYmJveC53aWR0aCA+IG1heFRpY2tXaWR0aCkgewogICAgICAgICAgbWF4VGlja1dpZHRoID0gYmJveC53aWR0aDsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgdmFyIGxhYmVsV2lkdGggPSBsYWJlbCA/IGxhYmVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoIDogMDsKICAgIHZhciB0aWNrV2lkdGggPSB0aWNrU2l6ZSArIHRpY2tNYXJnaW47CiAgICB2YXIgdXBkYXRlZFlBeGlzV2lkdGggPSBtYXhUaWNrV2lkdGggKyB0aWNrV2lkdGggKyBsYWJlbFdpZHRoICsgKGxhYmVsID8gbGFiZWxHYXBXaXRoVGljayA6IDApOwogICAgcmV0dXJuIE1hdGgucm91bmQodXBkYXRlZFlBeGlzV2lkdGgpOwogIH0KICByZXR1cm4gMDsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9DYXJ0ZXNpYW5BeGlzLmpzCnZhciBfZXhjbHVkZWQxMCA9IFsiYXhpc0xpbmUiLCAid2lkdGgiLCAiaGVpZ2h0IiwgImNsYXNzTmFtZSIsICJoaWRlIiwgInRpY2tzIiwgImF4aXNUeXBlIl07CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczEwKGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMChlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTAocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9leHRlbmRzMTUoKSB7CiAgcmV0dXJuIF9leHRlbmRzMTUgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczE1LmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KZnVuY3Rpb24gb3duS2V5czI4KGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMjgoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMyOChPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MzAoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMjgoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTMwKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MzAocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MzAodCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMzAodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMzAodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CnZhciBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzID0gewogIHg6IDAsCiAgeTogMCwKICB3aWR0aDogMCwKICBoZWlnaHQ6IDAsCiAgdmlld0JveDogewogICAgeDogMCwKICAgIHk6IDAsCiAgICB3aWR0aDogMCwKICAgIGhlaWdodDogMAogIH0sCiAgLy8gVGhlIG9yaWVudGF0aW9uIG9mIGF4aXMKICBvcmllbnRhdGlvbjogImJvdHRvbSIsCiAgLy8gVGhlIHRpY2tzCiAgdGlja3M6IFtdLAogIHN0cm9rZTogIiM2NjYiLAogIHRpY2tMaW5lOiB0cnVlLAogIGF4aXNMaW5lOiB0cnVlLAogIHRpY2s6IHRydWUsCiAgbWlycm9yOiBmYWxzZSwKICBtaW5UaWNrR2FwOiA1LAogIC8vIFRoZSB3aWR0aCBvciBoZWlnaHQgb2YgdGljawogIHRpY2tTaXplOiA2LAogIHRpY2tNYXJnaW46IDIsCiAgaW50ZXJ2YWw6ICJwcmVzZXJ2ZUVuZCIsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMuYXhpcwp9OwpmdW5jdGlvbiBBeGlzTGluZShheGlzTGluZVByb3BzKSB7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIG9yaWVudGF0aW9uLAogICAgbWlycm9yLAogICAgYXhpc0xpbmUsCiAgICBvdGhlclN2Z1Byb3BzCiAgfSA9IGF4aXNMaW5lUHJvcHM7CiAgaWYgKCFheGlzTGluZSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciBwcm9wcyA9IF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KHt9LCBvdGhlclN2Z1Byb3BzKSwgc3ZnUHJvcGVydGllc05vRXZlbnRzKGF4aXNMaW5lKSksIHt9LCB7CiAgICBmaWxsOiAibm9uZSIKICB9KTsKICBpZiAob3JpZW50YXRpb24gPT09ICJ0b3AiIHx8IG9yaWVudGF0aW9uID09PSAiYm90dG9tIikgewogICAgdmFyIG5lZWRIZWlnaHQgPSArKG9yaWVudGF0aW9uID09PSAidG9wIiAmJiAhbWlycm9yIHx8IG9yaWVudGF0aW9uID09PSAiYm90dG9tIiAmJiBtaXJyb3IpOwogICAgcHJvcHMgPSBfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KHt9LCBwcm9wcyksIHt9LCB7CiAgICAgIHgxOiB4MiwKICAgICAgeTE6IHkyICsgbmVlZEhlaWdodCAqIGhlaWdodCwKICAgICAgeDI6IHgyICsgd2lkdGgsCiAgICAgIHkyOiB5MiArIG5lZWRIZWlnaHQgKiBoZWlnaHQKICAgIH0pOwogIH0gZWxzZSB7CiAgICB2YXIgbmVlZFdpZHRoID0gKyhvcmllbnRhdGlvbiA9PT0gImxlZnQiICYmICFtaXJyb3IgfHwgb3JpZW50YXRpb24gPT09ICJyaWdodCIgJiYgbWlycm9yKTsKICAgIHByb3BzID0gX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7fSwgcHJvcHMpLCB7fSwgewogICAgICB4MTogeDIgKyBuZWVkV2lkdGggKiB3aWR0aCwKICAgICAgeTE6IHkyLAogICAgICB4MjogeDIgKyBuZWVkV2lkdGggKiB3aWR0aCwKICAgICAgeTI6IHkyICsgaGVpZ2h0CiAgICB9KTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoImxpbmUiLCBfZXh0ZW5kczE1KHt9LCBwcm9wcywgewogICAgY2xhc3NOYW1lOiBjbHN4KCJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy1saW5lIiwgKDAsIGltcG9ydF9nZXQzLmRlZmF1bHQpKGF4aXNMaW5lLCAiY2xhc3NOYW1lIikpCiAgfSkpOwp9CmZ1bmN0aW9uIGdldFRpY2tMaW5lQ29vcmQoZGF0YSwgeDIsIHkyLCB3aWR0aCwgaGVpZ2h0LCBvcmllbnRhdGlvbiwgdGlja1NpemUsIG1pcnJvciwgdGlja01hcmdpbikgewogIHZhciB4MSwgeDIyLCB5MSwgeTIyLCB0eCwgdHk7CiAgdmFyIHNpZ24yID0gbWlycm9yID8gLTEgOiAxOwogIHZhciBmaW5hbFRpY2tTaXplID0gZGF0YS50aWNrU2l6ZSB8fCB0aWNrU2l6ZTsKICB2YXIgdGlja0Nvb3JkID0gaXNOdW1iZXIoZGF0YS50aWNrQ29vcmQpID8gZGF0YS50aWNrQ29vcmQgOiBkYXRhLmNvb3JkaW5hdGU7CiAgc3dpdGNoIChvcmllbnRhdGlvbikgewogICAgY2FzZSAidG9wIjoKICAgICAgeDEgPSB4MjIgPSBkYXRhLmNvb3JkaW5hdGU7CiAgICAgIHkyMiA9IHkyICsgKyFtaXJyb3IgKiBoZWlnaHQ7CiAgICAgIHkxID0geTIyIC0gc2lnbjIgKiBmaW5hbFRpY2tTaXplOwogICAgICB0eSA9IHkxIC0gc2lnbjIgKiB0aWNrTWFyZ2luOwogICAgICB0eCA9IHRpY2tDb29yZDsKICAgICAgYnJlYWs7CiAgICBjYXNlICJsZWZ0IjoKICAgICAgeTEgPSB5MjIgPSBkYXRhLmNvb3JkaW5hdGU7CiAgICAgIHgyMiA9IHgyICsgKyFtaXJyb3IgKiB3aWR0aDsKICAgICAgeDEgPSB4MjIgLSBzaWduMiAqIGZpbmFsVGlja1NpemU7CiAgICAgIHR4ID0geDEgLSBzaWduMiAqIHRpY2tNYXJnaW47CiAgICAgIHR5ID0gdGlja0Nvb3JkOwogICAgICBicmVhazsKICAgIGNhc2UgInJpZ2h0IjoKICAgICAgeTEgPSB5MjIgPSBkYXRhLmNvb3JkaW5hdGU7CiAgICAgIHgyMiA9IHgyICsgK21pcnJvciAqIHdpZHRoOwogICAgICB4MSA9IHgyMiArIHNpZ24yICogZmluYWxUaWNrU2l6ZTsKICAgICAgdHggPSB4MSArIHNpZ24yICogdGlja01hcmdpbjsKICAgICAgdHkgPSB0aWNrQ29vcmQ7CiAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgeDEgPSB4MjIgPSBkYXRhLmNvb3JkaW5hdGU7CiAgICAgIHkyMiA9IHkyICsgK21pcnJvciAqIGhlaWdodDsKICAgICAgeTEgPSB5MjIgKyBzaWduMiAqIGZpbmFsVGlja1NpemU7CiAgICAgIHR5ID0geTEgKyBzaWduMiAqIHRpY2tNYXJnaW47CiAgICAgIHR4ID0gdGlja0Nvb3JkOwogICAgICBicmVhazsKICB9CiAgcmV0dXJuIHsKICAgIGxpbmU6IHsKICAgICAgeDEsCiAgICAgIHkxLAogICAgICB4MjogeDIyLAogICAgICB5MjogeTIyCiAgICB9LAogICAgdGljazogewogICAgICB4OiB0eCwKICAgICAgeTogdHkKICAgIH0KICB9Owp9CmZ1bmN0aW9uIGdldFRpY2tUZXh0QW5jaG9yKG9yaWVudGF0aW9uLCBtaXJyb3IpIHsKICBzd2l0Y2ggKG9yaWVudGF0aW9uKSB7CiAgICBjYXNlICJsZWZ0IjoKICAgICAgcmV0dXJuIG1pcnJvciA/ICJzdGFydCIgOiAiZW5kIjsKICAgIGNhc2UgInJpZ2h0IjoKICAgICAgcmV0dXJuIG1pcnJvciA/ICJlbmQiIDogInN0YXJ0IjsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiAibWlkZGxlIjsKICB9Cn0KZnVuY3Rpb24gZ2V0VGlja1ZlcnRpY2FsQW5jaG9yKG9yaWVudGF0aW9uLCBtaXJyb3IpIHsKICBzd2l0Y2ggKG9yaWVudGF0aW9uKSB7CiAgICBjYXNlICJsZWZ0IjoKICAgIGNhc2UgInJpZ2h0IjoKICAgICAgcmV0dXJuICJtaWRkbGUiOwogICAgY2FzZSAidG9wIjoKICAgICAgcmV0dXJuIG1pcnJvciA/ICJzdGFydCIgOiAiZW5kIjsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiBtaXJyb3IgPyAiZW5kIiA6ICJzdGFydCI7CiAgfQp9CmZ1bmN0aW9uIFRpY2tJdGVtKHByb3BzKSB7CiAgdmFyIHsKICAgIG9wdGlvbiwKICAgIHRpY2tQcm9wcywKICAgIHZhbHVlCiAgfSA9IHByb3BzOwogIHZhciB0aWNrSXRlbTsKICB2YXIgY29tYmluZWRDbGFzc05hbWUgPSBjbHN4KHRpY2tQcm9wcy5jbGFzc05hbWUsICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLXZhbHVlIik7CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmlzVmFsaWRFbGVtZW50KG9wdGlvbikpIHsKICAgIHRpY2tJdGVtID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY2xvbmVFbGVtZW50KG9wdGlvbiwgX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7fSwgdGlja1Byb3BzKSwge30sIHsKICAgICAgY2xhc3NOYW1lOiBjb21iaW5lZENsYXNzTmFtZQogICAgfSkpOwogIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbiA9PT0gImZ1bmN0aW9uIikgewogICAgdGlja0l0ZW0gPSBvcHRpb24oX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7fSwgdGlja1Byb3BzKSwge30sIHsKICAgICAgY2xhc3NOYW1lOiBjb21iaW5lZENsYXNzTmFtZQogICAgfSkpOwogIH0gZWxzZSB7CiAgICB2YXIgY2xhc3NOYW1lID0gInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stdmFsdWUiOwogICAgaWYgKHR5cGVvZiBvcHRpb24gIT09ICJib29sZWFuIikgewogICAgICBjbGFzc05hbWUgPSBjbHN4KGNsYXNzTmFtZSwgb3B0aW9uID09PSBudWxsIHx8IG9wdGlvbiA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9uLmNsYXNzTmFtZSk7CiAgICB9CiAgICB0aWNrSXRlbSA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoVGV4dCwgX2V4dGVuZHMxNSh7fSwgdGlja1Byb3BzLCB7CiAgICAgIGNsYXNzTmFtZQogICAgfSksIHZhbHVlKTsKICB9CiAgcmV0dXJuIHRpY2tJdGVtOwp9CnZhciBUaWNrcyA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0MzcuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgdGlja3M6IHRpY2tzMiA9IFtdLAogICAgdGljaywKICAgIHRpY2tMaW5lLAogICAgc3Ryb2tlLAogICAgdGlja0Zvcm1hdHRlciwKICAgIHVuaXQ6IHVuaXQyLAogICAgcGFkZGluZywKICAgIHRpY2tUZXh0UHJvcHMsCiAgICBvcmllbnRhdGlvbiwKICAgIG1pcnJvciwKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHRpY2tTaXplLAogICAgdGlja01hcmdpbiwKICAgIGZvbnRTaXplLAogICAgbGV0dGVyU3BhY2luZywKICAgIGdldFRpY2tzQ29uZmlnLAogICAgZXZlbnRzLAogICAgYXhpc1R5cGUKICB9ID0gcHJvcHM7CiAgdmFyIGZpbmFsVGlja3MgPSBnZXRUaWNrcyhfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KHt9LCBnZXRUaWNrc0NvbmZpZyksIHt9LCB7CiAgICB0aWNrczogdGlja3MyCiAgfSksIGZvbnRTaXplLCBsZXR0ZXJTcGFjaW5nKTsKICB2YXIgdGV4dEFuY2hvciA9IGdldFRpY2tUZXh0QW5jaG9yKG9yaWVudGF0aW9uLCBtaXJyb3IpOwogIHZhciB2ZXJ0aWNhbEFuY2hvciA9IGdldFRpY2tWZXJ0aWNhbEFuY2hvcihvcmllbnRhdGlvbiwgbWlycm9yKTsKICB2YXIgYXhpc1Byb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKGdldFRpY2tzQ29uZmlnKTsKICB2YXIgY3VzdG9tVGlja1Byb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzRnJvbVVua25vd24odGljayk7CiAgdmFyIHRpY2tMaW5lUHJvcHNPYmplY3QgPSB7fTsKICBpZiAodHlwZW9mIHRpY2tMaW5lID09PSAib2JqZWN0IikgewogICAgdGlja0xpbmVQcm9wc09iamVjdCA9IHRpY2tMaW5lOwogIH0KICB2YXIgdGlja0xpbmVQcm9wcyA9IF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoe30sIGF4aXNQcm9wcyksIHt9LCB7CiAgICBmaWxsOiAibm9uZSIKICB9LCB0aWNrTGluZVByb3BzT2JqZWN0KTsKICB2YXIgdGlja0xpbmVDb29yZHMgPSBmaW5hbFRpY2tzLm1hcCgoZW50cnkpID0+IF9vYmplY3RTcHJlYWQyOCh7CiAgICBlbnRyeQogIH0sIGdldFRpY2tMaW5lQ29vcmQoZW50cnksIHgyLCB5Miwgd2lkdGgsIGhlaWdodCwgb3JpZW50YXRpb24sIHRpY2tTaXplLCBtaXJyb3IsIHRpY2tNYXJnaW4pKSk7CiAgdmFyIHRpY2tMaW5lcyA9IHRpY2tMaW5lQ29vcmRzLm1hcCgoX3JlZjIpID0+IHsKICAgIHZhciB7CiAgICAgIGVudHJ5LAogICAgICBsaW5lOiBsaW5lQ29vcmQKICAgIH0gPSBfcmVmMjsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2siLAogICAgICBrZXk6ICJ0aWNrLSIuY29uY2F0KGVudHJ5LnZhbHVlLCAiLSIpLmNvbmNhdChlbnRyeS5jb29yZGluYXRlLCAiLSIpLmNvbmNhdChlbnRyeS50aWNrQ29vcmQpCiAgICB9LCB0aWNrTGluZSAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KCJsaW5lIiwgX2V4dGVuZHMxNSh7fSwgdGlja0xpbmVQcm9wcywgbGluZUNvb3JkLCB7CiAgICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljay1saW5lIiwgKDAsIGltcG9ydF9nZXQzLmRlZmF1bHQpKHRpY2tMaW5lLCAiY2xhc3NOYW1lIikpCiAgICB9KSkpOwogIH0pOwogIHZhciB0aWNrTGFiZWxzID0gdGlja0xpbmVDb29yZHMubWFwKChfcmVmMiwgaSkgPT4gewogICAgdmFyIHsKICAgICAgZW50cnksCiAgICAgIHRpY2s6IHRpY2tDb29yZAogICAgfSA9IF9yZWYyOwogICAgdmFyIHRpY2tQcm9wcyA9IF9vYmplY3RTcHJlYWQyOChfb2JqZWN0U3ByZWFkMjgoX29iamVjdFNwcmVhZDI4KF9vYmplY3RTcHJlYWQyOCh7CiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgdGV4dEFuY2hvciBmcm9tIGF4aXNQcm9wcyBpcyB0eXBlZCBhcyBgc3RyaW5nYCBidXQgVGV4dCB3YW50cyB0eXBlIGBUZXh0QW5jaG9yYAogICAgICB0ZXh0QW5jaG9yLAogICAgICB2ZXJ0aWNhbEFuY2hvcgogICAgfSwgYXhpc1Byb3BzKSwge30sIHsKICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBjdXN0b21UaWNrUHJvcHMgaXMgY29udHJpYnV0aW5nIHVua25vd24gcHJvcHMKICAgICAgc3Ryb2tlOiAibm9uZSIsCiAgICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgY3VzdG9tVGlja1Byb3BzIGlzIGNvbnRyaWJ1dGluZyB1bmtub3duIHByb3BzCiAgICAgIGZpbGw6IHN0cm9rZQogICAgfSwgY3VzdG9tVGlja1Byb3BzKSwgdGlja0Nvb3JkKSwge30sIHsKICAgICAgaW5kZXg6IGksCiAgICAgIHBheWxvYWQ6IGVudHJ5LAogICAgICB2aXNpYmxlVGlja3NDb3VudDogZmluYWxUaWNrcy5sZW5ndGgsCiAgICAgIHRpY2tGb3JtYXR0ZXIsCiAgICAgIHBhZGRpbmcKICAgIH0sIHRpY2tUZXh0UHJvcHMpOwogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoTGF5ZXIsIF9leHRlbmRzMTUoewogICAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLWxhYmVsIiwKICAgICAga2V5OiAidGljay1sYWJlbC0iLmNvbmNhdChlbnRyeS52YWx1ZSwgIi0iKS5jb25jYXQoZW50cnkuY29vcmRpbmF0ZSwgIi0iKS5jb25jYXQoZW50cnkudGlja0Nvb3JkKQogICAgfSwgYWRhcHRFdmVudHNPZkNoaWxkKGV2ZW50cywgZW50cnksIGkpKSwgdGljayAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KFRpY2tJdGVtLCB7CiAgICAgIG9wdGlvbjogdGljaywKICAgICAgdGlja1Byb3BzLAogICAgICB2YWx1ZTogIiIuY29uY2F0KHR5cGVvZiB0aWNrRm9ybWF0dGVyID09PSAiZnVuY3Rpb24iID8gdGlja0Zvcm1hdHRlcihlbnRyeS52YWx1ZSwgaSkgOiBlbnRyeS52YWx1ZSkuY29uY2F0KHVuaXQyIHx8ICIiKQogICAgfSkpOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGlja3MgcmVjaGFydHMtIi5jb25jYXQoYXhpc1R5cGUsICItdGlja3MiKQogIH0sIHRpY2tMYWJlbHMubGVuZ3RoID4gMCAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IERlZmF1bHRaSW5kZXhlcy5sYWJlbAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tYXhpcy10aWNrLWxhYmVscyByZWNoYXJ0cy0iLmNvbmNhdChheGlzVHlwZSwgIi10aWNrLWxhYmVscyIpLAogICAgcmVmCiAgfSwgdGlja0xhYmVscykpLCB0aWNrTGluZXMubGVuZ3RoID4gMCAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWF4aXMtdGljay1saW5lcyByZWNoYXJ0cy0iLmNvbmNhdChheGlzVHlwZSwgIi10aWNrLWxpbmVzIikKICB9LCB0aWNrTGluZXMpKTsKfSk7CnZhciBDYXJ0ZXNpYW5BeGlzQ29tcG9uZW50ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3QzNy5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICBheGlzTGluZSwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgY2xhc3NOYW1lLAogICAgaGlkZSwKICAgIHRpY2tzOiB0aWNrczIsCiAgICBheGlzVHlwZQogIH0gPSBwcm9wcywgcmVzdCA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczEwKHByb3BzLCBfZXhjbHVkZWQxMCk7CiAgdmFyIFtmb250U2l6ZSwgc2V0Rm9udFNpemVdID0gKDAsIGltcG9ydF9yZWFjdDM3LnVzZVN0YXRlKSgiIik7CiAgdmFyIFtsZXR0ZXJTcGFjaW5nLCBzZXRMZXR0ZXJTcGFjaW5nXSA9ICgwLCBpbXBvcnRfcmVhY3QzNy51c2VTdGF0ZSkoIiIpOwogIHZhciB0aWNrUmVmcyA9ICgwLCBpbXBvcnRfcmVhY3QzNy51c2VSZWYpKG51bGwpOwogICgwLCBpbXBvcnRfcmVhY3QzNy51c2VJbXBlcmF0aXZlSGFuZGxlKShyZWYsICgpID0+ICh7CiAgICBnZXRDYWxjdWxhdGVkV2lkdGg6ICgpID0+IHsKICAgICAgdmFyIF9wcm9wcyRsYWJlbFJlZjsKICAgICAgcmV0dXJuIGdldENhbGN1bGF0ZWRZQXhpc1dpZHRoKHsKICAgICAgICB0aWNrczogdGlja1JlZnMuY3VycmVudCwKICAgICAgICBsYWJlbDogKF9wcm9wcyRsYWJlbFJlZiA9IHByb3BzLmxhYmVsUmVmKSA9PT0gbnVsbCB8fCBfcHJvcHMkbGFiZWxSZWYgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9wcm9wcyRsYWJlbFJlZi5jdXJyZW50LAogICAgICAgIGxhYmVsR2FwV2l0aFRpY2s6IDUsCiAgICAgICAgdGlja1NpemU6IHByb3BzLnRpY2tTaXplLAogICAgICAgIHRpY2tNYXJnaW46IHByb3BzLnRpY2tNYXJnaW4KICAgICAgfSk7CiAgICB9CiAgfSkpOwogIHZhciBsYXllclJlZiA9ICgwLCBpbXBvcnRfcmVhY3QzNy51c2VDYWxsYmFjaykoKGVsKSA9PiB7CiAgICBpZiAoZWwpIHsKICAgICAgdmFyIHRpY2tOb2RlcyA9IGVsLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzLXRpY2stdmFsdWUiKTsKICAgICAgdGlja1JlZnMuY3VycmVudCA9IHRpY2tOb2RlczsKICAgICAgdmFyIHRpY2sgPSB0aWNrTm9kZXNbMF07CiAgICAgIGlmICh0aWNrKSB7CiAgICAgICAgdmFyIGNvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSh0aWNrKTsKICAgICAgICB2YXIgY2FsY3VsYXRlZEZvbnRTaXplID0gY29tcHV0ZWRTdHlsZS5mb250U2l6ZTsKICAgICAgICB2YXIgY2FsY3VsYXRlZExldHRlclNwYWNpbmcgPSBjb21wdXRlZFN0eWxlLmxldHRlclNwYWNpbmc7CiAgICAgICAgaWYgKGNhbGN1bGF0ZWRGb250U2l6ZSAhPT0gZm9udFNpemUgfHwgY2FsY3VsYXRlZExldHRlclNwYWNpbmcgIT09IGxldHRlclNwYWNpbmcpIHsKICAgICAgICAgIHNldEZvbnRTaXplKGNhbGN1bGF0ZWRGb250U2l6ZSk7CiAgICAgICAgICBzZXRMZXR0ZXJTcGFjaW5nKGNhbGN1bGF0ZWRMZXR0ZXJTcGFjaW5nKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9LCBbZm9udFNpemUsIGxldHRlclNwYWNpbmddKTsKICBpZiAoaGlkZSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIGlmICh3aWR0aCAhPSBudWxsICYmIHdpZHRoIDw9IDAgfHwgaGVpZ2h0ICE9IG51bGwgJiYgaGVpZ2h0IDw9IDApIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChaSW5kZXhMYXllciwgewogICAgekluZGV4OiBwcm9wcy56SW5kZXgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLWNhcnRlc2lhbi1heGlzIiwgY2xhc3NOYW1lKQogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI0LmNyZWF0ZUVsZW1lbnQoQXhpc0xpbmUsIHsKICAgIHg6IHByb3BzLngsCiAgICB5OiBwcm9wcy55LAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBvcmllbnRhdGlvbjogcHJvcHMub3JpZW50YXRpb24sCiAgICBtaXJyb3I6IHByb3BzLm1pcnJvciwKICAgIGF4aXNMaW5lLAogICAgb3RoZXJTdmdQcm9wczogc3ZnUHJvcGVydGllc05vRXZlbnRzKHByb3BzKQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KFRpY2tzLCB7CiAgICByZWY6IGxheWVyUmVmLAogICAgYXhpc1R5cGUsCiAgICBldmVudHM6IHJlc3QsCiAgICBmb250U2l6ZSwKICAgIGdldFRpY2tzQ29uZmlnOiBwcm9wcywKICAgIGhlaWdodDogcHJvcHMuaGVpZ2h0LAogICAgbGV0dGVyU3BhY2luZywKICAgIG1pcnJvcjogcHJvcHMubWlycm9yLAogICAgb3JpZW50YXRpb246IHByb3BzLm9yaWVudGF0aW9uLAogICAgcGFkZGluZzogcHJvcHMucGFkZGluZywKICAgIHN0cm9rZTogcHJvcHMuc3Ryb2tlLAogICAgdGljazogcHJvcHMudGljaywKICAgIHRpY2tGb3JtYXR0ZXI6IHByb3BzLnRpY2tGb3JtYXR0ZXIsCiAgICB0aWNrTGluZTogcHJvcHMudGlja0xpbmUsCiAgICB0aWNrTWFyZ2luOiBwcm9wcy50aWNrTWFyZ2luLAogICAgdGlja1NpemU6IHByb3BzLnRpY2tTaXplLAogICAgdGlja1RleHRQcm9wczogcHJvcHMudGlja1RleHRQcm9wcywKICAgIHRpY2tzOiB0aWNrczIsCiAgICB1bml0OiBwcm9wcy51bml0LAogICAgd2lkdGg6IHByb3BzLndpZHRoLAogICAgeDogcHJvcHMueCwKICAgIHk6IHByb3BzLnkKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5MYWJlbENvbnRleHRQcm92aWRlciwgewogICAgeDogcHJvcHMueCwKICAgIHk6IHByb3BzLnksCiAgICB3aWR0aDogcHJvcHMud2lkdGgsCiAgICBoZWlnaHQ6IHByb3BzLmhlaWdodCwKICAgIGxvd2VyV2lkdGg6IHByb3BzLndpZHRoLAogICAgdXBwZXJXaWR0aDogcHJvcHMud2lkdGgKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5jcmVhdGVFbGVtZW50KENhcnRlc2lhbkxhYmVsRnJvbUxhYmVsUHJvcCwgewogICAgbGFiZWw6IHByb3BzLmxhYmVsLAogICAgbGFiZWxSZWY6IHByb3BzLmxhYmVsUmVmCiAgfSksIHByb3BzLmNoaWxkcmVuKSkpOwp9KTsKdmFyIENhcnRlc2lhbkF4aXMgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNC5mb3J3YXJkUmVmKChvdXRzaWRlUHJvcHMsIHJlZikgPT4gewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjQuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5BeGlzQ29tcG9uZW50LCBfZXh0ZW5kczE1KHt9LCBwcm9wcywgewogICAgcmVmCiAgfSkpOwp9KTsKQ2FydGVzaWFuQXhpcy5kaXNwbGF5TmFtZSA9ICJDYXJ0ZXNpYW5BeGlzIjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9DYXJ0ZXNpYW5HcmlkLmpzCnZhciBSZWFjdDI1ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkMTEgPSBbIngxIiwgInkxIiwgIngyIiwgInkyIiwgImtleSJdOwp2YXIgX2V4Y2x1ZGVkMjUgPSBbIm9mZnNldCJdOwp2YXIgX2V4Y2x1ZGVkMzIgPSBbInhBeGlzSWQiLCAieUF4aXNJZCJdOwp2YXIgX2V4Y2x1ZGVkNDIgPSBbInhBeGlzSWQiLCAieUF4aXNJZCJdOwpmdW5jdGlvbiBvd25LZXlzMjkoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyOShlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czI5KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkzMShlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMyOShPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MzEoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkzMShyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzMSh0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUzMSh0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUzMSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gX2V4dGVuZHMxNigpIHsKICByZXR1cm4gX2V4dGVuZHMxNiA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTYuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMShlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTEoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTExKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQp2YXIgQmFja2dyb3VuZCA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICBmaWxsCiAgfSA9IHByb3BzOwogIGlmICghZmlsbCB8fCBmaWxsID09PSAibm9uZSIpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgZmlsbE9wYWNpdHksCiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICByeQogIH0gPSBwcm9wczsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgIHg6IHgyLAogICAgeTogeTIsCiAgICByeSwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgc3Ryb2tlOiAibm9uZSIsCiAgICBmaWxsLAogICAgZmlsbE9wYWNpdHksCiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC1iZyIKICB9KTsKfTsKZnVuY3Rpb24gTGluZUl0ZW0oX3JlZjIpIHsKICB2YXIgewogICAgb3B0aW9uLAogICAgbGluZUl0ZW1Qcm9wcwogIH0gPSBfcmVmMjsKICB2YXIgbGluZUl0ZW07CiAgaWYgKC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmlzVmFsaWRFbGVtZW50KG9wdGlvbikpIHsKICAgIGxpbmVJdGVtID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY2xvbmVFbGVtZW50KG9wdGlvbiwgbGluZUl0ZW1Qcm9wcyk7CiAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9uID09PSAiZnVuY3Rpb24iKSB7CiAgICBsaW5lSXRlbSA9IG9wdGlvbihsaW5lSXRlbVByb3BzKTsKICB9IGVsc2UgewogICAgdmFyIF9zdmdQcm9wZXJ0aWVzTm9FdmVudDsKICAgIHZhciB7CiAgICAgIHgxLAogICAgICB5MSwKICAgICAgeDIsCiAgICAgIHkyLAogICAgICBrZXkKICAgIH0gPSBsaW5lSXRlbVByb3BzLCBvdGhlcnMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMShsaW5lSXRlbVByb3BzLCBfZXhjbHVkZWQxMSk7CiAgICB2YXIgX3JlZjIyID0gKF9zdmdQcm9wZXJ0aWVzTm9FdmVudCA9IHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhvdGhlcnMpKSAhPT0gbnVsbCAmJiBfc3ZnUHJvcGVydGllc05vRXZlbnQgIT09IHZvaWQgMCA/IF9zdmdQcm9wZXJ0aWVzTm9FdmVudCA6IHt9LCB7CiAgICAgIG9mZnNldDogX18KICAgIH0gPSBfcmVmMjIsIHJlc3RPZkZpbHRlcmVkUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMShfcmVmMjIsIF9leGNsdWRlZDI1KTsKICAgIGxpbmVJdGVtID0gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudCgibGluZSIsIF9leHRlbmRzMTYoe30sIHJlc3RPZkZpbHRlcmVkUHJvcHMsIHsKICAgICAgeDEsCiAgICAgIHkxLAogICAgICB4MiwKICAgICAgeTIsCiAgICAgIGZpbGw6ICJub25lIiwKICAgICAga2V5CiAgICB9KSk7CiAgfQogIHJldHVybiBsaW5lSXRlbTsKfQpmdW5jdGlvbiBIb3Jpem9udGFsR3JpZExpbmVzKHByb3BzKSB7CiAgdmFyIHsKICAgIHg6IHgyLAogICAgd2lkdGgsCiAgICBob3Jpem9udGFsID0gdHJ1ZSwKICAgIGhvcml6b250YWxQb2ludHMKICB9ID0gcHJvcHM7CiAgaWYgKCFob3Jpem9udGFsIHx8ICFob3Jpem9udGFsUG9pbnRzIHx8ICFob3Jpem9udGFsUG9pbnRzLmxlbmd0aCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICB4QXhpc0lkLAogICAgeUF4aXNJZAogIH0gPSBwcm9wcywgb3RoZXJMaW5lSXRlbVByb3BzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTEocHJvcHMsIF9leGNsdWRlZDMyKTsKICB2YXIgaXRlbXMgPSBob3Jpem9udGFsUG9pbnRzLm1hcCgoZW50cnksIGkpID0+IHsKICAgIHZhciBsaW5lSXRlbVByb3BzID0gX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOSh7fSwgb3RoZXJMaW5lSXRlbVByb3BzKSwge30sIHsKICAgICAgeDE6IHgyLAogICAgICB5MTogZW50cnksCiAgICAgIHgyOiB4MiArIHdpZHRoLAogICAgICB5MjogZW50cnksCiAgICAgIGtleTogImxpbmUtIi5jb25jYXQoaSksCiAgICAgIGluZGV4OiBpCiAgICB9KTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KExpbmVJdGVtLCB7CiAgICAgIGtleTogImxpbmUtIi5jb25jYXQoaSksCiAgICAgIG9wdGlvbjogaG9yaXpvbnRhbCwKICAgICAgbGluZUl0ZW1Qcm9wcwogICAgfSk7CiAgfSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoImciLCB7CiAgICBjbGFzc05hbWU6ICJyZWNoYXJ0cy1jYXJ0ZXNpYW4tZ3JpZC1ob3Jpem9udGFsIgogIH0sIGl0ZW1zKTsKfQpmdW5jdGlvbiBWZXJ0aWNhbEdyaWRMaW5lcyhwcm9wcykgewogIHZhciB7CiAgICB5OiB5MiwKICAgIGhlaWdodCwKICAgIHZlcnRpY2FsID0gdHJ1ZSwKICAgIHZlcnRpY2FsUG9pbnRzCiAgfSA9IHByb3BzOwogIGlmICghdmVydGljYWwgfHwgIXZlcnRpY2FsUG9pbnRzIHx8ICF2ZXJ0aWNhbFBvaW50cy5sZW5ndGgpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgewogICAgeEF4aXNJZCwKICAgIHlBeGlzSWQKICB9ID0gcHJvcHMsIG90aGVyTGluZUl0ZW1Qcm9wcyA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczExKHByb3BzLCBfZXhjbHVkZWQ0Mik7CiAgdmFyIGl0ZW1zID0gdmVydGljYWxQb2ludHMubWFwKChlbnRyeSwgaSkgPT4gewogICAgdmFyIGxpbmVJdGVtUHJvcHMgPSBfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KHt9LCBvdGhlckxpbmVJdGVtUHJvcHMpLCB7fSwgewogICAgICB4MTogZW50cnksCiAgICAgIHkxOiB5MiwKICAgICAgeDI6IGVudHJ5LAogICAgICB5MjogeTIgKyBoZWlnaHQsCiAgICAgIGtleTogImxpbmUtIi5jb25jYXQoaSksCiAgICAgIGluZGV4OiBpCiAgICB9KTsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KExpbmVJdGVtLCB7CiAgICAgIG9wdGlvbjogdmVydGljYWwsCiAgICAgIGxpbmVJdGVtUHJvcHMsCiAgICAgIGtleTogImxpbmUtIi5jb25jYXQoaSkKICAgIH0pOwogIH0pOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KCJnIiwgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWQtdmVydGljYWwiCiAgfSwgaXRlbXMpOwp9CmZ1bmN0aW9uIEhvcml6b250YWxTdHJpcGVzKHByb3BzKSB7CiAgdmFyIHsKICAgIGhvcml6b250YWxGaWxsLAogICAgZmlsbE9wYWNpdHksCiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBob3Jpem9udGFsUG9pbnRzLAogICAgaG9yaXpvbnRhbCA9IHRydWUKICB9ID0gcHJvcHM7CiAgaWYgKCFob3Jpem9udGFsIHx8ICFob3Jpem9udGFsRmlsbCB8fCAhaG9yaXpvbnRhbEZpbGwubGVuZ3RoIHx8IGhvcml6b250YWxQb2ludHMgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciByb3VuZGVkU29ydGVkSG9yaXpvbnRhbFBvaW50cyA9IGhvcml6b250YWxQb2ludHMubWFwKChlKSA9PiBNYXRoLnJvdW5kKGUgKyB5MiAtIHkyKSkuc29ydCgoYSwgYikgPT4gYSAtIGIpOwogIGlmICh5MiAhPT0gcm91bmRlZFNvcnRlZEhvcml6b250YWxQb2ludHNbMF0pIHsKICAgIHJvdW5kZWRTb3J0ZWRIb3Jpem9udGFsUG9pbnRzLnVuc2hpZnQoMCk7CiAgfQogIHZhciBpdGVtcyA9IHJvdW5kZWRTb3J0ZWRIb3Jpem9udGFsUG9pbnRzLm1hcCgoZW50cnksIGkpID0+IHsKICAgIHZhciBsYXN0U3RyaXBlID0gIXJvdW5kZWRTb3J0ZWRIb3Jpem9udGFsUG9pbnRzW2kgKyAxXTsKICAgIHZhciBsaW5lSGVpZ2h0ID0gbGFzdFN0cmlwZSA/IHkyICsgaGVpZ2h0IC0gZW50cnkgOiByb3VuZGVkU29ydGVkSG9yaXpvbnRhbFBvaW50c1tpICsgMV0gLSBlbnRyeTsKICAgIGlmIChsaW5lSGVpZ2h0IDw9IDApIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICB2YXIgY29sb3JJbmRleCA9IGkgJSBob3Jpem9udGFsRmlsbC5sZW5ndGg7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgICAga2V5OiAicmVhY3QtIi5jb25jYXQoaSksCiAgICAgIHk6IGVudHJ5LAogICAgICB4OiB4MiwKICAgICAgaGVpZ2h0OiBsaW5lSGVpZ2h0LAogICAgICB3aWR0aCwKICAgICAgc3Ryb2tlOiAibm9uZSIsCiAgICAgIGZpbGw6IGhvcml6b250YWxGaWxsW2NvbG9ySW5kZXhdLAogICAgICBmaWxsT3BhY2l0eSwKICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWQtYmciCiAgICB9KTsKICB9KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudCgiZyIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1ncmlkc3RyaXBlcy1ob3Jpem9udGFsIgogIH0sIGl0ZW1zKTsKfQpmdW5jdGlvbiBWZXJ0aWNhbFN0cmlwZXMocHJvcHMpIHsKICB2YXIgewogICAgdmVydGljYWwgPSB0cnVlLAogICAgdmVydGljYWxGaWxsLAogICAgZmlsbE9wYWNpdHksCiAgICB4OiB4MiwKICAgIHk6IHkyLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICB2ZXJ0aWNhbFBvaW50cwogIH0gPSBwcm9wczsKICBpZiAoIXZlcnRpY2FsIHx8ICF2ZXJ0aWNhbEZpbGwgfHwgIXZlcnRpY2FsRmlsbC5sZW5ndGgpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgcm91bmRlZFNvcnRlZFZlcnRpY2FsUG9pbnRzID0gdmVydGljYWxQb2ludHMubWFwKChlKSA9PiBNYXRoLnJvdW5kKGUgKyB4MiAtIHgyKSkuc29ydCgoYSwgYikgPT4gYSAtIGIpOwogIGlmICh4MiAhPT0gcm91bmRlZFNvcnRlZFZlcnRpY2FsUG9pbnRzWzBdKSB7CiAgICByb3VuZGVkU29ydGVkVmVydGljYWxQb2ludHMudW5zaGlmdCgwKTsKICB9CiAgdmFyIGl0ZW1zID0gcm91bmRlZFNvcnRlZFZlcnRpY2FsUG9pbnRzLm1hcCgoZW50cnksIGkpID0+IHsKICAgIHZhciBsYXN0U3RyaXBlID0gIXJvdW5kZWRTb3J0ZWRWZXJ0aWNhbFBvaW50c1tpICsgMV07CiAgICB2YXIgbGluZVdpZHRoID0gbGFzdFN0cmlwZSA/IHgyICsgd2lkdGggLSBlbnRyeSA6IHJvdW5kZWRTb3J0ZWRWZXJ0aWNhbFBvaW50c1tpICsgMV0gLSBlbnRyeTsKICAgIGlmIChsaW5lV2lkdGggPD0gMCkgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHZhciBjb2xvckluZGV4ID0gaSAlIHZlcnRpY2FsRmlsbC5sZW5ndGg7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgICAga2V5OiAicmVhY3QtIi5jb25jYXQoaSksCiAgICAgIHg6IGVudHJ5LAogICAgICB5OiB5MiwKICAgICAgd2lkdGg6IGxpbmVXaWR0aCwKICAgICAgaGVpZ2h0LAogICAgICBzdHJva2U6ICJub25lIiwKICAgICAgZmlsbDogdmVydGljYWxGaWxsW2NvbG9ySW5kZXhdLAogICAgICBmaWxsT3BhY2l0eSwKICAgICAgY2xhc3NOYW1lOiAicmVjaGFydHMtY2FydGVzaWFuLWdyaWQtYmciCiAgICB9KTsKICB9KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudCgiZyIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1ncmlkc3RyaXBlcy12ZXJ0aWNhbCIKICB9LCBpdGVtcyk7Cn0KdmFyIGRlZmF1bHRWZXJ0aWNhbENvb3JkaW5hdGVzR2VuZXJhdG9yID0gKF9yZWYzLCBzeW5jV2l0aFRpY2tzKSA9PiB7CiAgdmFyIHsKICAgIHhBeGlzLAogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICBvZmZzZXQKICB9ID0gX3JlZjM7CiAgcmV0dXJuIGdldENvb3JkaW5hdGVzT2ZHcmlkKGdldFRpY2tzKF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KHt9LCBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzKSwgeEF4aXMpLCB7fSwgewogICAgdGlja3M6IGdldFRpY2tzT2ZBeGlzKHhBeGlzLCB0cnVlKSwKICAgIHZpZXdCb3g6IHsKICAgICAgeDogMCwKICAgICAgeTogMCwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodAogICAgfQogIH0pKSwgb2Zmc2V0LmxlZnQsIG9mZnNldC5sZWZ0ICsgb2Zmc2V0LndpZHRoLCBzeW5jV2l0aFRpY2tzKTsKfTsKdmFyIGRlZmF1bHRIb3Jpem9udGFsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgPSAoX3JlZjQsIHN5bmNXaXRoVGlja3MpID0+IHsKICB2YXIgewogICAgeUF4aXMsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIG9mZnNldAogIH0gPSBfcmVmNDsKICByZXR1cm4gZ2V0Q29vcmRpbmF0ZXNPZkdyaWQoZ2V0VGlja3MoX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOShfb2JqZWN0U3ByZWFkMjkoe30sIGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMpLCB5QXhpcyksIHt9LCB7CiAgICB0aWNrczogZ2V0VGlja3NPZkF4aXMoeUF4aXMsIHRydWUpLAogICAgdmlld0JveDogewogICAgICB4OiAwLAogICAgICB5OiAwLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9CiAgfSkpLCBvZmZzZXQudG9wLCBvZmZzZXQudG9wICsgb2Zmc2V0LmhlaWdodCwgc3luY1dpdGhUaWNrcyk7Cn07CnZhciBkZWZhdWx0Q2FydGVzaWFuR3JpZFByb3BzID0gewogIGhvcml6b250YWw6IHRydWUsCiAgdmVydGljYWw6IHRydWUsCiAgLy8gVGhlIG9yZGluYXRlcyBvZiBob3Jpem9udGFsIGdyaWQgbGluZXMKICBob3Jpem9udGFsUG9pbnRzOiBbXSwKICAvLyBUaGUgYWJzY2lzc2FzIG9mIHZlcnRpY2FsIGdyaWQgbGluZXMKICB2ZXJ0aWNhbFBvaW50czogW10sCiAgc3Ryb2tlOiAiI2NjYyIsCiAgZmlsbDogIm5vbmUiLAogIC8vIFRoZSBmaWxsIG9mIGNvbG9ycyBvZiBncmlkIGxpbmVzCiAgdmVydGljYWxGaWxsOiBbXSwKICBob3Jpem9udGFsRmlsbDogW10sCiAgeEF4aXNJZDogMCwKICB5QXhpc0lkOiAwLAogIHN5bmNXaXRoVGlja3M6IGZhbHNlLAogIHpJbmRleDogRGVmYXVsdFpJbmRleGVzLmdyaWQKfTsKZnVuY3Rpb24gQ2FydGVzaWFuR3JpZChwcm9wcykgewogIHZhciBjaGFydFdpZHRoID0gdXNlQ2hhcnRXaWR0aCgpOwogIHZhciBjaGFydEhlaWdodCA9IHVzZUNoYXJ0SGVpZ2h0KCk7CiAgdmFyIG9mZnNldCA9IHVzZU9mZnNldEludGVybmFsKCk7CiAgdmFyIHByb3BzSW5jbHVkaW5nRGVmYXVsdHMgPSBfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KHt9LCByZXNvbHZlRGVmYXVsdFByb3BzKHByb3BzLCBkZWZhdWx0Q2FydGVzaWFuR3JpZFByb3BzKSksIHt9LCB7CiAgICB4OiBpc051bWJlcihwcm9wcy54KSA/IHByb3BzLnggOiBvZmZzZXQubGVmdCwKICAgIHk6IGlzTnVtYmVyKHByb3BzLnkpID8gcHJvcHMueSA6IG9mZnNldC50b3AsCiAgICB3aWR0aDogaXNOdW1iZXIocHJvcHMud2lkdGgpID8gcHJvcHMud2lkdGggOiBvZmZzZXQud2lkdGgsCiAgICBoZWlnaHQ6IGlzTnVtYmVyKHByb3BzLmhlaWdodCkgPyBwcm9wcy5oZWlnaHQgOiBvZmZzZXQuaGVpZ2h0CiAgfSk7CiAgdmFyIHsKICAgIHhBeGlzSWQsCiAgICB5QXhpc0lkLAogICAgeDogeDIsCiAgICB5OiB5MiwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgc3luY1dpdGhUaWNrcywKICAgIGhvcml6b250YWxWYWx1ZXMsCiAgICB2ZXJ0aWNhbFZhbHVlcwogIH0gPSBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzOwogIHZhciBpc1Bhbm9yYW1hID0gdXNlSXNQYW5vcmFtYSgpOwogIHZhciB4QXhpcyA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0QXhpc1Byb3BzTmVlZGVkRm9yQ2FydGVzaWFuR3JpZFRpY2tzR2VuZXJhdG9yKHN0YXRlLCAieEF4aXMiLCB4QXhpc0lkLCBpc1Bhbm9yYW1hKSk7CiAgdmFyIHlBeGlzID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBeGlzUHJvcHNOZWVkZWRGb3JDYXJ0ZXNpYW5HcmlkVGlja3NHZW5lcmF0b3Ioc3RhdGUsICJ5QXhpcyIsIHlBeGlzSWQsIGlzUGFub3JhbWEpKTsKICBpZiAoIWlzUG9zaXRpdmVOdW1iZXIod2lkdGgpIHx8ICFpc1Bvc2l0aXZlTnVtYmVyKGhlaWdodCkgfHwgIWlzTnVtYmVyKHgyKSB8fCAhaXNOdW1iZXIoeTIpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHZlcnRpY2FsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgPSBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLnZlcnRpY2FsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgfHwgZGVmYXVsdFZlcnRpY2FsQ29vcmRpbmF0ZXNHZW5lcmF0b3I7CiAgdmFyIGhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvciA9IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMuaG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yIHx8IGRlZmF1bHRIb3Jpem9udGFsQ29vcmRpbmF0ZXNHZW5lcmF0b3I7CiAgdmFyIHsKICAgIGhvcml6b250YWxQb2ludHMsCiAgICB2ZXJ0aWNhbFBvaW50cwogIH0gPSBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzOwogIGlmICgoIWhvcml6b250YWxQb2ludHMgfHwgIWhvcml6b250YWxQb2ludHMubGVuZ3RoKSAmJiB0eXBlb2YgaG9yaXpvbnRhbENvb3JkaW5hdGVzR2VuZXJhdG9yID09PSAiZnVuY3Rpb24iKSB7CiAgICB2YXIgaXNIb3Jpem9udGFsVmFsdWVzID0gaG9yaXpvbnRhbFZhbHVlcyAmJiBob3Jpem9udGFsVmFsdWVzLmxlbmd0aDsKICAgIHZhciBnZW5lcmF0b3JSZXN1bHQgPSBob3Jpem9udGFsQ29vcmRpbmF0ZXNHZW5lcmF0b3IoewogICAgICB5QXhpczogeUF4aXMgPyBfb2JqZWN0U3ByZWFkMjkoX29iamVjdFNwcmVhZDI5KHt9LCB5QXhpcyksIHt9LCB7CiAgICAgICAgdGlja3M6IGlzSG9yaXpvbnRhbFZhbHVlcyA/IGhvcml6b250YWxWYWx1ZXMgOiB5QXhpcy50aWNrcwogICAgICB9KSA6IHZvaWQgMCwKICAgICAgd2lkdGg6IGNoYXJ0V2lkdGggIT09IG51bGwgJiYgY2hhcnRXaWR0aCAhPT0gdm9pZCAwID8gY2hhcnRXaWR0aCA6IHdpZHRoLAogICAgICBoZWlnaHQ6IGNoYXJ0SGVpZ2h0ICE9PSBudWxsICYmIGNoYXJ0SGVpZ2h0ICE9PSB2b2lkIDAgPyBjaGFydEhlaWdodCA6IGhlaWdodCwKICAgICAgb2Zmc2V0CiAgICB9LCBpc0hvcml6b250YWxWYWx1ZXMgPyB0cnVlIDogc3luY1dpdGhUaWNrcyk7CiAgICB3YXJuKEFycmF5LmlzQXJyYXkoZ2VuZXJhdG9yUmVzdWx0KSwgImhvcml6b250YWxDb29yZGluYXRlc0dlbmVyYXRvciBzaG91bGQgcmV0dXJuIEFycmF5IGJ1dCBpbnN0ZWFkIGl0IHJldHVybmVkIFsiLmNvbmNhdCh0eXBlb2YgZ2VuZXJhdG9yUmVzdWx0LCAiXSIpKTsKICAgIGlmIChBcnJheS5pc0FycmF5KGdlbmVyYXRvclJlc3VsdCkpIHsKICAgICAgaG9yaXpvbnRhbFBvaW50cyA9IGdlbmVyYXRvclJlc3VsdDsKICAgIH0KICB9CiAgaWYgKCghdmVydGljYWxQb2ludHMgfHwgIXZlcnRpY2FsUG9pbnRzLmxlbmd0aCkgJiYgdHlwZW9mIHZlcnRpY2FsQ29vcmRpbmF0ZXNHZW5lcmF0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgIHZhciBpc1ZlcnRpY2FsVmFsdWVzID0gdmVydGljYWxWYWx1ZXMgJiYgdmVydGljYWxWYWx1ZXMubGVuZ3RoOwogICAgdmFyIF9nZW5lcmF0b3JSZXN1bHQgPSB2ZXJ0aWNhbENvb3JkaW5hdGVzR2VuZXJhdG9yKHsKICAgICAgeEF4aXM6IHhBeGlzID8gX29iamVjdFNwcmVhZDI5KF9vYmplY3RTcHJlYWQyOSh7fSwgeEF4aXMpLCB7fSwgewogICAgICAgIHRpY2tzOiBpc1ZlcnRpY2FsVmFsdWVzID8gdmVydGljYWxWYWx1ZXMgOiB4QXhpcy50aWNrcwogICAgICB9KSA6IHZvaWQgMCwKICAgICAgd2lkdGg6IGNoYXJ0V2lkdGggIT09IG51bGwgJiYgY2hhcnRXaWR0aCAhPT0gdm9pZCAwID8gY2hhcnRXaWR0aCA6IHdpZHRoLAogICAgICBoZWlnaHQ6IGNoYXJ0SGVpZ2h0ICE9PSBudWxsICYmIGNoYXJ0SGVpZ2h0ICE9PSB2b2lkIDAgPyBjaGFydEhlaWdodCA6IGhlaWdodCwKICAgICAgb2Zmc2V0CiAgICB9LCBpc1ZlcnRpY2FsVmFsdWVzID8gdHJ1ZSA6IHN5bmNXaXRoVGlja3MpOwogICAgd2FybihBcnJheS5pc0FycmF5KF9nZW5lcmF0b3JSZXN1bHQpLCAidmVydGljYWxDb29yZGluYXRlc0dlbmVyYXRvciBzaG91bGQgcmV0dXJuIEFycmF5IGJ1dCBpbnN0ZWFkIGl0IHJldHVybmVkIFsiLmNvbmNhdCh0eXBlb2YgX2dlbmVyYXRvclJlc3VsdCwgIl0iKSk7CiAgICBpZiAoQXJyYXkuaXNBcnJheShfZ2VuZXJhdG9yUmVzdWx0KSkgewogICAgICB2ZXJ0aWNhbFBvaW50cyA9IF9nZW5lcmF0b3JSZXN1bHQ7CiAgICB9CiAgfQogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICB6SW5kZXg6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMuekluZGV4CiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjUuY3JlYXRlRWxlbWVudCgiZyIsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWNhcnRlc2lhbi1ncmlkIgogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoQmFja2dyb3VuZCwgewogICAgZmlsbDogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy5maWxsLAogICAgZmlsbE9wYWNpdHk6IHByb3BzSW5jbHVkaW5nRGVmYXVsdHMuZmlsbE9wYWNpdHksCiAgICB4OiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLngsCiAgICB5OiBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLnksCiAgICB3aWR0aDogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy53aWR0aCwKICAgIGhlaWdodDogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy5oZWlnaHQsCiAgICByeTogcHJvcHNJbmNsdWRpbmdEZWZhdWx0cy5yeQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KEhvcml6b250YWxTdHJpcGVzLCBfZXh0ZW5kczE2KHt9LCBwcm9wc0luY2x1ZGluZ0RlZmF1bHRzLCB7CiAgICBob3Jpem9udGFsUG9pbnRzCiAgfSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNS5jcmVhdGVFbGVtZW50KFZlcnRpY2FsU3RyaXBlcywgX2V4dGVuZHMxNih7fSwgcHJvcHNJbmNsdWRpbmdEZWZhdWx0cywgewogICAgdmVydGljYWxQb2ludHMKICB9KSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoSG9yaXpvbnRhbEdyaWRMaW5lcywgX2V4dGVuZHMxNih7fSwgcHJvcHNJbmNsdWRpbmdEZWZhdWx0cywgewogICAgb2Zmc2V0LAogICAgaG9yaXpvbnRhbFBvaW50cywKICAgIHhBeGlzLAogICAgeUF4aXMKICB9KSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI1LmNyZWF0ZUVsZW1lbnQoVmVydGljYWxHcmlkTGluZXMsIF9leHRlbmRzMTYoe30sIHByb3BzSW5jbHVkaW5nRGVmYXVsdHMsIHsKICAgIG9mZnNldCwKICAgIHZlcnRpY2FsUG9pbnRzLAogICAgeEF4aXMsCiAgICB5QXhpcwogIH0pKSkpOwp9CkNhcnRlc2lhbkdyaWQuZGlzcGxheU5hbWUgPSAiQ2FydGVzaWFuR3JpZCI7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2dldFJhZGl1c0FuZFN0cm9rZVdpZHRoRnJvbURvdC5qcwpmdW5jdGlvbiBnZXRSYWRpdXNBbmRTdHJva2VXaWR0aEZyb21Eb3QoZG90KSB7CiAgdmFyIHByb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzRnJvbVVua25vd24oZG90KTsKICB2YXIgZGVmYXVsdFIgPSAzOwogIHZhciBkZWZhdWx0U3Ryb2tlV2lkdGggPSAyOwogIGlmIChwcm9wcyAhPSBudWxsKSB7CiAgICB2YXIgewogICAgICByOiByMiwKICAgICAgc3Ryb2tlV2lkdGgKICAgIH0gPSBwcm9wczsKICAgIHZhciByZWFsUiA9IE51bWJlcihyMik7CiAgICB2YXIgcmVhbFN0cm9rZVdpZHRoID0gTnVtYmVyKHN0cm9rZVdpZHRoKTsKICAgIGlmIChOdW1iZXIuaXNOYU4ocmVhbFIpIHx8IHJlYWxSIDwgMCkgewogICAgICByZWFsUiA9IGRlZmF1bHRSOwogICAgfQogICAgaWYgKE51bWJlci5pc05hTihyZWFsU3Ryb2tlV2lkdGgpIHx8IHJlYWxTdHJva2VXaWR0aCA8IDApIHsKICAgICAgcmVhbFN0cm9rZVdpZHRoID0gZGVmYXVsdFN0cm9rZVdpZHRoOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgcjogcmVhbFIsCiAgICAgIHN0cm9rZVdpZHRoOiByZWFsU3Ryb2tlV2lkdGgKICAgIH07CiAgfQogIHJldHVybiB7CiAgICByOiBkZWZhdWx0UiwKICAgIHN0cm9rZVdpZHRoOiBkZWZhdWx0U3Ryb2tlV2lkdGgKICB9Owp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vQXJlYS5qcwp2YXIgUmVhY3QyNiA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDM4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc2VsZWN0b3JzL2FyZWFTZWxlY3RvcnMuanMKdmFyIHNlbGVjdFhBeGlzV2l0aFNjYWxlID0gKHN0YXRlLCB4QXhpc0lkLCBfeUF4aXNJZCwgaXNQYW5vcmFtYSkgPT4gc2VsZWN0QXhpc1dpdGhTY2FsZShzdGF0ZSwgInhBeGlzIiwgeEF4aXNJZCwgaXNQYW5vcmFtYSk7CnZhciBzZWxlY3RYQXhpc1RpY2tzID0gKHN0YXRlLCB4QXhpc0lkLCBfeUF4aXNJZCwgaXNQYW5vcmFtYSkgPT4gc2VsZWN0VGlja3NPZkdyYXBoaWNhbEl0ZW0oc3RhdGUsICJ4QXhpcyIsIHhBeGlzSWQsIGlzUGFub3JhbWEpOwp2YXIgc2VsZWN0WUF4aXNXaXRoU2NhbGUgPSAoc3RhdGUsIF94QXhpc0lkLCB5QXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBzZWxlY3RBeGlzV2l0aFNjYWxlKHN0YXRlLCAieUF4aXMiLCB5QXhpc0lkLCBpc1Bhbm9yYW1hKTsKdmFyIHNlbGVjdFlBeGlzVGlja3MgPSAoc3RhdGUsIF94QXhpc0lkLCB5QXhpc0lkLCBpc1Bhbm9yYW1hKSA9PiBzZWxlY3RUaWNrc09mR3JhcGhpY2FsSXRlbShzdGF0ZSwgInlBeGlzIiwgeUF4aXNJZCwgaXNQYW5vcmFtYSk7CnZhciBzZWxlY3RCYW5kU2l6ZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RDaGFydExheW91dCwgc2VsZWN0WEF4aXNXaXRoU2NhbGUsIHNlbGVjdFlBeGlzV2l0aFNjYWxlLCBzZWxlY3RYQXhpc1RpY2tzLCBzZWxlY3RZQXhpc1RpY2tzXSwgKGxheW91dCwgeEF4aXMsIHlBeGlzLCB4QXhpc1RpY2tzLCB5QXhpc1RpY2tzKSA9PiB7CiAgaWYgKGlzQ2F0ZWdvcmljYWxBeGlzKGxheW91dCwgInhBeGlzIikpIHsKICAgIHJldHVybiBnZXRCYW5kU2l6ZU9mQXhpcyh4QXhpcywgeEF4aXNUaWNrcywgZmFsc2UpOwogIH0KICByZXR1cm4gZ2V0QmFuZFNpemVPZkF4aXMoeUF4aXMsIHlBeGlzVGlja3MsIGZhbHNlKTsKfSk7CnZhciBwaWNrQXJlYUlkID0gKF9zdGF0ZSwgX3hBeGlzSWQsIF95QXhpc0lkLCBfaXNQYW5vcmFtYSwgaWQpID0+IGlkOwp2YXIgc2VsZWN0U3luY2hyb25pc2VkQXJlYVNldHRpbmdzID0gY3JlYXRlU2VsZWN0b3IoW3NlbGVjdFVuZmlsdGVyZWRDYXJ0ZXNpYW5JdGVtcywgcGlja0FyZWFJZF0sIChncmFwaGljYWxJdGVtcywgaWQpID0+IGdyYXBoaWNhbEl0ZW1zLmZpbHRlcigoaXRlbSkgPT4gaXRlbS50eXBlID09PSAiYXJlYSIpLmZpbmQoKGl0ZW0pID0+IGl0ZW0uaWQgPT09IGlkKSk7CnZhciBzZWxlY3RHcmFwaGljYWxJdGVtU3RhY2tlZERhdGEgPSAoc3RhdGUsIHhBeGlzSWQsIHlBeGlzSWQsIGlzUGFub3JhbWEsIGlkKSA9PiB7CiAgdmFyIF9zdGFja0dyb3VwcyRzdGFja0lkOwogIHZhciBhcmVhU2V0dGluZ3MgPSBzZWxlY3RTeW5jaHJvbmlzZWRBcmVhU2V0dGluZ3Moc3RhdGUsIHhBeGlzSWQsIHlBeGlzSWQsIGlzUGFub3JhbWEsIGlkKTsKICBpZiAoYXJlYVNldHRpbmdzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciBsYXlvdXQgPSBzZWxlY3RDaGFydExheW91dChzdGF0ZSk7CiAgdmFyIGlzWEF4aXNDYXRlZ29yaWNhbCA9IGlzQ2F0ZWdvcmljYWxBeGlzKGxheW91dCwgInhBeGlzIik7CiAgdmFyIHN0YWNrR3JvdXBzOwogIGlmIChpc1hBeGlzQ2F0ZWdvcmljYWwpIHsKICAgIHN0YWNrR3JvdXBzID0gc2VsZWN0U3RhY2tHcm91cHMoc3RhdGUsICJ5QXhpcyIsIHlBeGlzSWQsIGlzUGFub3JhbWEpOwogIH0gZWxzZSB7CiAgICBzdGFja0dyb3VwcyA9IHNlbGVjdFN0YWNrR3JvdXBzKHN0YXRlLCAieEF4aXMiLCB4QXhpc0lkLCBpc1Bhbm9yYW1hKTsKICB9CiAgaWYgKHN0YWNrR3JvdXBzID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBzdGFja0lkCiAgfSA9IGFyZWFTZXR0aW5nczsKICB2YXIgc3RhY2tTZXJpZXNJZGVudGlmaWVyID0gZ2V0U3RhY2tTZXJpZXNJZGVudGlmaWVyKGFyZWFTZXR0aW5ncyk7CiAgaWYgKHN0YWNrSWQgPT0gbnVsbCB8fCBzdGFja1Nlcmllc0lkZW50aWZpZXIgPT0gbnVsbCkgewogICAgcmV0dXJuIHZvaWQgMDsKICB9CiAgdmFyIGdyb3VwcyA9IChfc3RhY2tHcm91cHMkc3RhY2tJZCA9IHN0YWNrR3JvdXBzW3N0YWNrSWRdKSA9PT0gbnVsbCB8fCBfc3RhY2tHcm91cHMkc3RhY2tJZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3N0YWNrR3JvdXBzJHN0YWNrSWQuc3RhY2tlZERhdGE7CiAgcmV0dXJuIGdyb3VwcyA9PT0gbnVsbCB8fCBncm91cHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGdyb3Vwcy5maW5kKCh2KSA9PiB2LmtleSA9PT0gc3RhY2tTZXJpZXNJZGVudGlmaWVyKTsKfTsKdmFyIHNlbGVjdEFyZWEgPSBjcmVhdGVTZWxlY3Rvcihbc2VsZWN0Q2hhcnRMYXlvdXQsIHNlbGVjdFhBeGlzV2l0aFNjYWxlLCBzZWxlY3RZQXhpc1dpdGhTY2FsZSwgc2VsZWN0WEF4aXNUaWNrcywgc2VsZWN0WUF4aXNUaWNrcywgc2VsZWN0R3JhcGhpY2FsSXRlbVN0YWNrZWREYXRhLCBzZWxlY3RDaGFydERhdGFXaXRoSW5kZXhlc0lmTm90SW5QYW5vcmFtYSwgc2VsZWN0QmFuZFNpemUsIHNlbGVjdFN5bmNocm9uaXNlZEFyZWFTZXR0aW5ncywgc2VsZWN0Q2hhcnRCYXNlVmFsdWVdLCAobGF5b3V0LCB4QXhpcywgeUF4aXMsIHhBeGlzVGlja3MsIHlBeGlzVGlja3MsIHN0YWNrZWREYXRhLCBfcmVmMiwgYmFuZFNpemUsIGFyZWFTZXR0aW5ncywgY2hhcnRCYXNlVmFsdWUpID0+IHsKICB2YXIgewogICAgY2hhcnREYXRhLAogICAgZGF0YVN0YXJ0SW5kZXgsCiAgICBkYXRhRW5kSW5kZXgKICB9ID0gX3JlZjI7CiAgaWYgKGFyZWFTZXR0aW5ncyA9PSBudWxsIHx8IGxheW91dCAhPT0gImhvcml6b250YWwiICYmIGxheW91dCAhPT0gInZlcnRpY2FsIiB8fCB4QXhpcyA9PSBudWxsIHx8IHlBeGlzID09IG51bGwgfHwgeEF4aXNUaWNrcyA9PSBudWxsIHx8IHlBeGlzVGlja3MgPT0gbnVsbCB8fCB4QXhpc1RpY2tzLmxlbmd0aCA9PT0gMCB8fCB5QXhpc1RpY2tzLmxlbmd0aCA9PT0gMCB8fCBiYW5kU2l6ZSA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgewogICAgZGF0YQogIH0gPSBhcmVhU2V0dGluZ3M7CiAgdmFyIGRpc3BsYXllZERhdGE7CiAgaWYgKGRhdGEgJiYgZGF0YS5sZW5ndGggPiAwKSB7CiAgICBkaXNwbGF5ZWREYXRhID0gZGF0YTsKICB9IGVsc2UgewogICAgZGlzcGxheWVkRGF0YSA9IGNoYXJ0RGF0YSA9PT0gbnVsbCB8fCBjaGFydERhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNoYXJ0RGF0YS5zbGljZShkYXRhU3RhcnRJbmRleCwgZGF0YUVuZEluZGV4ICsgMSk7CiAgfQogIGlmIChkaXNwbGF5ZWREYXRhID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHJldHVybiBjb21wdXRlQXJlYSh7CiAgICBsYXlvdXQsCiAgICB4QXhpcywKICAgIHlBeGlzLAogICAgeEF4aXNUaWNrcywKICAgIHlBeGlzVGlja3MsCiAgICBkYXRhU3RhcnRJbmRleCwKICAgIGFyZWFTZXR0aW5ncywKICAgIHN0YWNrZWREYXRhLAogICAgZGlzcGxheWVkRGF0YSwKICAgIGNoYXJ0QmFzZVZhbHVlLAogICAgYmFuZFNpemUKICB9KTsKfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vQXJlYS5qcwp2YXIgX2V4Y2x1ZGVkMTIgPSBbImlkIl07CnZhciBfZXhjbHVkZWQyNiA9IFsiYWN0aXZlRG90IiwgImFuaW1hdGlvbkJlZ2luIiwgImFuaW1hdGlvbkR1cmF0aW9uIiwgImFuaW1hdGlvbkVhc2luZyIsICJjb25uZWN0TnVsbHMiLCAiZG90IiwgImZpbGwiLCAiZmlsbE9wYWNpdHkiLCAiaGlkZSIsICJpc0FuaW1hdGlvbkFjdGl2ZSIsICJsZWdlbmRUeXBlIiwgInN0cm9rZSIsICJ4QXhpc0lkIiwgInlBeGlzSWQiXTsKZnVuY3Rpb24gX2V4dGVuZHMxNygpIHsKICByZXR1cm4gX2V4dGVuZHMxNyA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTcuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMihlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTIoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTEyKHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBvd25LZXlzMzAoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIzKSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHIzKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQzMChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czMwKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyMykgewogICAgICBfZGVmaW5lUHJvcGVydHkzMihlLCByMywgdFtyM10pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzMChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIzLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIzKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KZnVuY3Rpb24gX2RlZmluZVByb3BlcnR5MzIoZSwgcjIsIHQpIHsKICByZXR1cm4gKHIyID0gX3RvUHJvcGVydHlLZXkzMihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsgdmFsdWU6IHQsIGVudW1lcmFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSwgd3JpdGFibGU6IHRydWUgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gX3RvUHJvcGVydHlLZXkzMih0KSB7CiAgdmFyIGkgPSBfdG9QcmltaXRpdmUzMih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IHR5cGVvZiBpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfdG9QcmltaXRpdmUzMih0LCByMikgewogIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgdCB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSB0eXBlb2YgaSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gZ2V0TGVnZW5kSXRlbUNvbG9yKHN0cm9rZSwgZmlsbCkgewogIHJldHVybiBzdHJva2UgJiYgc3Ryb2tlICE9PSAibm9uZSIgPyBzdHJva2UgOiBmaWxsOwp9CnZhciBjb21wdXRlTGVnZW5kUGF5bG9hZEZyb21BcmVhRGF0YSA9IChwcm9wcykgPT4gewogIHZhciB7CiAgICBkYXRhS2V5LAogICAgbmFtZSwKICAgIHN0cm9rZSwKICAgIGZpbGwsCiAgICBsZWdlbmRUeXBlLAogICAgaGlkZQogIH0gPSBwcm9wczsKICByZXR1cm4gW3sKICAgIGluYWN0aXZlOiBoaWRlLAogICAgZGF0YUtleSwKICAgIHR5cGU6IGxlZ2VuZFR5cGUsCiAgICBjb2xvcjogZ2V0TGVnZW5kSXRlbUNvbG9yKHN0cm9rZSwgZmlsbCksCiAgICB2YWx1ZTogZ2V0VG9vbHRpcE5hbWVQcm9wKG5hbWUsIGRhdGFLZXkpLAogICAgcGF5bG9hZDogcHJvcHMKICB9XTsKfTsKdmFyIFNldEFyZWFUb29sdGlwRW50cnlTZXR0aW5ncyA9IC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2Lm1lbW8oKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGRhdGFLZXksCiAgICBkYXRhLAogICAgc3Ryb2tlLAogICAgc3Ryb2tlV2lkdGgsCiAgICBmaWxsLAogICAgbmFtZSwKICAgIGhpZGUsCiAgICB1bml0OiB1bml0MiwKICAgIHRvb2x0aXBUeXBlCiAgfSA9IF9yZWYyOwogIHZhciB0b29sdGlwRW50cnlTZXR0aW5ncyA9IHsKICAgIGRhdGFEZWZpbmVkT25JdGVtOiBkYXRhLAogICAgcG9zaXRpb25zOiB2b2lkIDAsCiAgICBzZXR0aW5nczogewogICAgICBzdHJva2UsCiAgICAgIHN0cm9rZVdpZHRoLAogICAgICBmaWxsLAogICAgICBkYXRhS2V5LAogICAgICBuYW1lS2V5OiB2b2lkIDAsCiAgICAgIG5hbWU6IGdldFRvb2x0aXBOYW1lUHJvcChuYW1lLCBkYXRhS2V5KSwKICAgICAgaGlkZSwKICAgICAgdHlwZTogdG9vbHRpcFR5cGUsCiAgICAgIGNvbG9yOiBnZXRMZWdlbmRJdGVtQ29sb3Ioc3Ryb2tlLCBmaWxsKSwKICAgICAgdW5pdDogdW5pdDIKICAgIH0KICB9OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFNldFRvb2x0aXBFbnRyeVNldHRpbmdzLCB7CiAgICB0b29sdGlwRW50cnlTZXR0aW5ncwogIH0pOwp9KTsKZnVuY3Rpb24gQXJlYURvdHNXcmFwcGVyKF9yZWYyKSB7CiAgdmFyIHsKICAgIGNsaXBQYXRoSWQsCiAgICBwb2ludHMsCiAgICBwcm9wcwogIH0gPSBfcmVmMjsKICB2YXIgewogICAgbmVlZENsaXAsCiAgICBkb3QsCiAgICBkYXRhS2V5CiAgfSA9IHByb3BzOwogIHZhciBhcmVhUHJvcHMgPSBzdmdQcm9wZXJ0aWVzTm9FdmVudHMocHJvcHMpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KERvdHMsIHsKICAgIHBvaW50cywKICAgIGRvdCwKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWFyZWEtZG90cyIsCiAgICBkb3RDbGFzc05hbWU6ICJyZWNoYXJ0cy1hcmVhLWRvdCIsCiAgICBkYXRhS2V5LAogICAgYmFzZVByb3BzOiBhcmVhUHJvcHMsCiAgICBuZWVkQ2xpcCwKICAgIGNsaXBQYXRoSWQKICB9KTsKfQpmdW5jdGlvbiBBcmVhTGFiZWxMaXN0UHJvdmlkZXIoX3JlZjMpIHsKICB2YXIgewogICAgc2hvd0xhYmVscywKICAgIGNoaWxkcmVuLAogICAgcG9pbnRzCiAgfSA9IF9yZWYzOwogIHZhciBsYWJlbExpc3RFbnRyaWVzID0gcG9pbnRzLm1hcCgocG9pbnQ0KSA9PiB7CiAgICB2YXIgX3BvaW50JHgsIF9wb2ludCR5OwogICAgdmFyIHZpZXdCb3ggPSB7CiAgICAgIHg6IChfcG9pbnQkeCA9IHBvaW50NC54KSAhPT0gbnVsbCAmJiBfcG9pbnQkeCAhPT0gdm9pZCAwID8gX3BvaW50JHggOiAwLAogICAgICB5OiAoX3BvaW50JHkgPSBwb2ludDQueSkgIT09IG51bGwgJiYgX3BvaW50JHkgIT09IHZvaWQgMCA/IF9wb2ludCR5IDogMCwKICAgICAgd2lkdGg6IDAsCiAgICAgIGxvd2VyV2lkdGg6IDAsCiAgICAgIHVwcGVyV2lkdGg6IDAsCiAgICAgIGhlaWdodDogMAogICAgfTsKICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMzAoX29iamVjdFNwcmVhZDMwKHt9LCB2aWV3Qm94KSwge30sIHsKICAgICAgdmFsdWU6IHBvaW50NC52YWx1ZSwKICAgICAgcGF5bG9hZDogcG9pbnQ0LnBheWxvYWQsCiAgICAgIHBhcmVudFZpZXdCb3g6IHZvaWQgMCwKICAgICAgdmlld0JveCwKICAgICAgZmlsbDogdm9pZCAwCiAgICB9KTsKICB9KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5MYWJlbExpc3RDb250ZXh0UHJvdmlkZXIsIHsKICAgIHZhbHVlOiBzaG93TGFiZWxzID8gbGFiZWxMaXN0RW50cmllcyA6IHZvaWQgMAogIH0sIGNoaWxkcmVuKTsKfQpmdW5jdGlvbiBTdGF0aWNBcmVhKF9yZWY0KSB7CiAgdmFyIHsKICAgIHBvaW50cywKICAgIGJhc2VMaW5lLAogICAgbmVlZENsaXAsCiAgICBjbGlwUGF0aElkLAogICAgcHJvcHMKICB9ID0gX3JlZjQ7CiAgdmFyIHsKICAgIGxheW91dCwKICAgIHR5cGUsCiAgICBzdHJva2UsCiAgICBjb25uZWN0TnVsbHMsCiAgICBpc1JhbmdlCiAgfSA9IHByb3BzOwogIHZhciB7CiAgICBpZAogIH0gPSBwcm9wcywgcHJvcHNXaXRob3V0SWQgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxMihwcm9wcywgX2V4Y2x1ZGVkMTIpOwogIHZhciBhbGxPdGhlclByb3BzID0gc3ZnUHJvcGVydGllc05vRXZlbnRzKHByb3BzV2l0aG91dElkKTsKICB2YXIgcHJvcHNXaXRoRXZlbnRzID0gc3ZnUHJvcGVydGllc0FuZEV2ZW50cyhwcm9wc1dpdGhvdXRJZCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoUmVhY3QyNi5GcmFnbWVudCwgbnVsbCwgKHBvaW50cyA9PT0gbnVsbCB8fCBwb2ludHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBvaW50cy5sZW5ndGgpID4gMSAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KExheWVyLCB7CiAgICBjbGlwUGF0aDogbmVlZENsaXAgPyAidXJsKCNjbGlwUGF0aC0iLmNvbmNhdChjbGlwUGF0aElkLCAiKSIpIDogdm9pZCAwCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChDdXJ2ZSwgX2V4dGVuZHMxNyh7fSwgcHJvcHNXaXRoRXZlbnRzLCB7CiAgICBpZCwKICAgIHBvaW50cywKICAgIGNvbm5lY3ROdWxscywKICAgIHR5cGUsCiAgICBiYXNlTGluZSwKICAgIGxheW91dCwKICAgIHN0cm9rZTogIm5vbmUiLAogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtYXJlYS1hcmVhIgogIH0pKSwgc3Ryb2tlICE9PSAibm9uZSIgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChDdXJ2ZSwgX2V4dGVuZHMxNyh7fSwgYWxsT3RoZXJQcm9wcywgewogICAgY2xhc3NOYW1lOiAicmVjaGFydHMtYXJlYS1jdXJ2ZSIsCiAgICBsYXlvdXQsCiAgICB0eXBlLAogICAgY29ubmVjdE51bGxzLAogICAgZmlsbDogIm5vbmUiLAogICAgcG9pbnRzCiAgfSkpLCBzdHJva2UgIT09ICJub25lIiAmJiBpc1JhbmdlICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQ3VydmUsIF9leHRlbmRzMTcoe30sIGFsbE90aGVyUHJvcHMsIHsKICAgIGNsYXNzTmFtZTogInJlY2hhcnRzLWFyZWEtY3VydmUiLAogICAgbGF5b3V0LAogICAgdHlwZSwKICAgIGNvbm5lY3ROdWxscywKICAgIGZpbGw6ICJub25lIiwKICAgIHBvaW50czogYmFzZUxpbmUKICB9KSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEFyZWFEb3RzV3JhcHBlciwgewogICAgcG9pbnRzLAogICAgcHJvcHM6IHByb3BzV2l0aG91dElkLAogICAgY2xpcFBhdGhJZAogIH0pKTsKfQpmdW5jdGlvbiBWZXJ0aWNhbFJlY3QoX3JlZjUpIHsKICB2YXIgewogICAgYWxwaGE6IGFscGhhMiwKICAgIGJhc2VMaW5lLAogICAgcG9pbnRzLAogICAgc3Ryb2tlV2lkdGgKICB9ID0gX3JlZjU7CiAgdmFyIHN0YXJ0WSA9IHBvaW50c1swXS55OwogIHZhciBlbmRZID0gcG9pbnRzW3BvaW50cy5sZW5ndGggLSAxXS55OwogIGlmICghaXNXZWxsQmVoYXZlZE51bWJlcihzdGFydFkpIHx8ICFpc1dlbGxCZWhhdmVkTnVtYmVyKGVuZFkpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIGhlaWdodCA9IGFscGhhMiAqIE1hdGguYWJzKHN0YXJ0WSAtIGVuZFkpOwogIHZhciBtYXhYID0gTWF0aC5tYXgoLi4ucG9pbnRzLm1hcCgoZW50cnkpID0+IGVudHJ5LnggfHwgMCkpOwogIGlmIChpc051bWJlcihiYXNlTGluZSkpIHsKICAgIG1heFggPSBNYXRoLm1heChiYXNlTGluZSwgbWF4WCk7CiAgfSBlbHNlIGlmIChiYXNlTGluZSAmJiBBcnJheS5pc0FycmF5KGJhc2VMaW5lKSAmJiBiYXNlTGluZS5sZW5ndGgpIHsKICAgIG1heFggPSBNYXRoLm1heCguLi5iYXNlTGluZS5tYXAoKGVudHJ5KSA9PiBlbnRyeS54IHx8IDApLCBtYXhYKTsKICB9CiAgaWYgKGlzTnVtYmVyKG1heFgpKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgICAgeDogMCwKICAgICAgeTogc3RhcnRZIDwgZW5kWSA/IHN0YXJ0WSA6IHN0YXJ0WSAtIGhlaWdodCwKICAgICAgd2lkdGg6IG1heFggKyAoc3Ryb2tlV2lkdGggPyBwYXJzZUludCgiIi5jb25jYXQoc3Ryb2tlV2lkdGgpLCAxMCkgOiAxKSwKICAgICAgaGVpZ2h0OiBNYXRoLmZsb29yKGhlaWdodCkKICAgIH0pOwogIH0KICByZXR1cm4gbnVsbDsKfQpmdW5jdGlvbiBIb3Jpem9udGFsUmVjdChfcmVmNikgewogIHZhciB7CiAgICBhbHBoYTogYWxwaGEyLAogICAgYmFzZUxpbmUsCiAgICBwb2ludHMsCiAgICBzdHJva2VXaWR0aAogIH0gPSBfcmVmNjsKICB2YXIgc3RhcnRYID0gcG9pbnRzWzBdLng7CiAgdmFyIGVuZFggPSBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdLng7CiAgaWYgKCFpc1dlbGxCZWhhdmVkTnVtYmVyKHN0YXJ0WCkgfHwgIWlzV2VsbEJlaGF2ZWROdW1iZXIoZW5kWCkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICB2YXIgd2lkdGggPSBhbHBoYTIgKiBNYXRoLmFicyhzdGFydFggLSBlbmRYKTsKICB2YXIgbWF4WSA9IE1hdGgubWF4KC4uLnBvaW50cy5tYXAoKGVudHJ5KSA9PiBlbnRyeS55IHx8IDApKTsKICBpZiAoaXNOdW1iZXIoYmFzZUxpbmUpKSB7CiAgICBtYXhZID0gTWF0aC5tYXgoYmFzZUxpbmUsIG1heFkpOwogIH0gZWxzZSBpZiAoYmFzZUxpbmUgJiYgQXJyYXkuaXNBcnJheShiYXNlTGluZSkgJiYgYmFzZUxpbmUubGVuZ3RoKSB7CiAgICBtYXhZID0gTWF0aC5tYXgoLi4uYmFzZUxpbmUubWFwKChlbnRyeSkgPT4gZW50cnkueSB8fCAwKSwgbWF4WSk7CiAgfQogIGlmIChpc051bWJlcihtYXhZKSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoInJlY3QiLCB7CiAgICAgIHg6IHN0YXJ0WCA8IGVuZFggPyBzdGFydFggOiBzdGFydFggLSB3aWR0aCwKICAgICAgeTogMCwKICAgICAgd2lkdGgsCiAgICAgIGhlaWdodDogTWF0aC5mbG9vcihtYXhZICsgKHN0cm9rZVdpZHRoID8gcGFyc2VJbnQoIiIuY29uY2F0KHN0cm9rZVdpZHRoKSwgMTApIDogMSkpCiAgICB9KTsKICB9CiAgcmV0dXJuIG51bGw7Cn0KZnVuY3Rpb24gQ2xpcFJlY3QoX3JlZjcpIHsKICB2YXIgewogICAgYWxwaGE6IGFscGhhMiwKICAgIGxheW91dCwKICAgIHBvaW50cywKICAgIGJhc2VMaW5lLAogICAgc3Ryb2tlV2lkdGgKICB9ID0gX3JlZjc7CiAgaWYgKGxheW91dCA9PT0gInZlcnRpY2FsIikgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoVmVydGljYWxSZWN0LCB7CiAgICAgIGFscGhhOiBhbHBoYTIsCiAgICAgIHBvaW50cywKICAgICAgYmFzZUxpbmUsCiAgICAgIHN0cm9rZVdpZHRoCiAgICB9KTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoSG9yaXpvbnRhbFJlY3QsIHsKICAgIGFscGhhOiBhbHBoYTIsCiAgICBwb2ludHMsCiAgICBiYXNlTGluZSwKICAgIHN0cm9rZVdpZHRoCiAgfSk7Cn0KZnVuY3Rpb24gQXJlYVdpdGhBbmltYXRpb24oX3JlZjgpIHsKICB2YXIgewogICAgbmVlZENsaXAsCiAgICBjbGlwUGF0aElkLAogICAgcHJvcHMsCiAgICBwcmV2aW91c1BvaW50c1JlZiwKICAgIHByZXZpb3VzQmFzZWxpbmVSZWYKICB9ID0gX3JlZjg7CiAgdmFyIHsKICAgIHBvaW50cywKICAgIGJhc2VMaW5lLAogICAgaXNBbmltYXRpb25BY3RpdmUsCiAgICBhbmltYXRpb25CZWdpbiwKICAgIGFuaW1hdGlvbkR1cmF0aW9uLAogICAgYW5pbWF0aW9uRWFzaW5nLAogICAgb25BbmltYXRpb25TdGFydCwKICAgIG9uQW5pbWF0aW9uRW5kCiAgfSA9IHByb3BzOwogIHZhciBhbmltYXRpb25JbnB1dCA9ICgwLCBpbXBvcnRfcmVhY3QzOC51c2VNZW1vKSgoKSA9PiAoewogICAgcG9pbnRzLAogICAgYmFzZUxpbmUKICB9KSwgW3BvaW50cywgYmFzZUxpbmVdKTsKICB2YXIgYW5pbWF0aW9uSWQgPSB1c2VBbmltYXRpb25JZChhbmltYXRpb25JbnB1dCwgInJlY2hhcnRzLWFyZWEtIik7CiAgdmFyIGxheW91dCA9IHVzZUNhcnRlc2lhbkNoYXJ0TGF5b3V0KCk7CiAgdmFyIFtpc0FuaW1hdGluZywgc2V0SXNBbmltYXRpbmddID0gKDAsIGltcG9ydF9yZWFjdDM4LnVzZVN0YXRlKShmYWxzZSk7CiAgdmFyIHNob3dMYWJlbHMgPSAhaXNBbmltYXRpbmc7CiAgdmFyIGhhbmRsZUFuaW1hdGlvbkVuZCA9ICgwLCBpbXBvcnRfcmVhY3QzOC51c2VDYWxsYmFjaykoKCkgPT4gewogICAgaWYgKHR5cGVvZiBvbkFuaW1hdGlvbkVuZCA9PT0gImZ1bmN0aW9uIikgewogICAgICBvbkFuaW1hdGlvbkVuZCgpOwogICAgfQogICAgc2V0SXNBbmltYXRpbmcoZmFsc2UpOwogIH0sIFtvbkFuaW1hdGlvbkVuZF0pOwogIHZhciBoYW5kbGVBbmltYXRpb25TdGFydCA9ICgwLCBpbXBvcnRfcmVhY3QzOC51c2VDYWxsYmFjaykoKCkgPT4gewogICAgaWYgKHR5cGVvZiBvbkFuaW1hdGlvblN0YXJ0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIG9uQW5pbWF0aW9uU3RhcnQoKTsKICAgIH0KICAgIHNldElzQW5pbWF0aW5nKHRydWUpOwogIH0sIFtvbkFuaW1hdGlvblN0YXJ0XSk7CiAgaWYgKGxheW91dCA9PSBudWxsKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHByZXZQb2ludHMgPSBwcmV2aW91c1BvaW50c1JlZi5jdXJyZW50OwogIHZhciBwcmV2QmFzZUxpbmUgPSBwcmV2aW91c0Jhc2VsaW5lUmVmLmN1cnJlbnQ7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQXJlYUxhYmVsTGlzdFByb3ZpZGVyLCB7CiAgICBzaG93TGFiZWxzLAogICAgcG9pbnRzCiAgfSwgcHJvcHMuY2hpbGRyZW4sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoSmF2YXNjcmlwdEFuaW1hdGUsIHsKICAgIGFuaW1hdGlvbklkLAogICAgYmVnaW46IGFuaW1hdGlvbkJlZ2luLAogICAgZHVyYXRpb246IGFuaW1hdGlvbkR1cmF0aW9uLAogICAgaXNBY3RpdmU6IGlzQW5pbWF0aW9uQWN0aXZlLAogICAgZWFzaW5nOiBhbmltYXRpb25FYXNpbmcsCiAgICBvbkFuaW1hdGlvbkVuZDogaGFuZGxlQW5pbWF0aW9uRW5kLAogICAgb25BbmltYXRpb25TdGFydDogaGFuZGxlQW5pbWF0aW9uU3RhcnQsCiAgICBrZXk6IGFuaW1hdGlvbklkCiAgfSwgKHQpID0+IHsKICAgIGlmIChwcmV2UG9pbnRzKSB7CiAgICAgIHZhciBwcmV2UG9pbnRzRGlmZkZhY3RvciA9IHByZXZQb2ludHMubGVuZ3RoIC8gcG9pbnRzLmxlbmd0aDsKICAgICAgdmFyIHN0ZXBQb2ludHMgPSAoCiAgICAgICAgLyoKICAgICAgICAgKiBIZXJlIGl0IGlzIGltcG9ydGFudCB0aGF0IGF0IHRoZSB2ZXJ5IGVuZCBvZiB0aGUgYW5pbWF0aW9uLCBvbiB0aGUgbGFzdCBmcmFtZSwKICAgICAgICAgKiB3ZSByZW5kZXIgdGhlIG9yaWdpbmFsIHBvaW50cyB3aXRob3V0IGFueSBpbnRlcnBvbGF0aW9uLgogICAgICAgICAqIFRoaXMgaXMgbmVlZGVkIGJlY2F1c2UgdGhlIGNvZGUgYWJvdmUgaXMgY2hlY2tpbmcgZm9yIHJlZmVyZW5jZSBlcXVhbGl0eSB0byBkZWNpZGUgaWYgdGhlIGFuaW1hdGlvbiBzaG91bGQgcnVuCiAgICAgICAgICogYW5kIGlmIHdlIGNyZWF0ZSBhIG5ldyBhcnJheSBpbnN0YW5jZSAoZXZlbiBpZiB0aGUgbnVtYmVycyB3ZXJlIHRoZSBzYW1lKQogICAgICAgICAqIHRoZW4gd2Ugd291bGQgYnJlYWsgYW5pbWF0aW9ucy4KICAgICAgICAgKi8KICAgICAgICB0ID09PSAxID8gcG9pbnRzIDogcG9pbnRzLm1hcCgoZW50cnksIGluZGV4KSA9PiB7CiAgICAgICAgICB2YXIgcHJldlBvaW50SW5kZXggPSBNYXRoLmZsb29yKGluZGV4ICogcHJldlBvaW50c0RpZmZGYWN0b3IpOwogICAgICAgICAgaWYgKHByZXZQb2ludHNbcHJldlBvaW50SW5kZXhdKSB7CiAgICAgICAgICAgIHZhciBwcmV2ID0gcHJldlBvaW50c1twcmV2UG9pbnRJbmRleF07CiAgICAgICAgICAgIHJldHVybiBfb2JqZWN0U3ByZWFkMzAoX29iamVjdFNwcmVhZDMwKHt9LCBlbnRyeSksIHt9LCB7CiAgICAgICAgICAgICAgeDogaW50ZXJwb2xhdGUocHJldi54LCBlbnRyeS54LCB0KSwKICAgICAgICAgICAgICB5OiBpbnRlcnBvbGF0ZShwcmV2LnksIGVudHJ5LnksIHQpCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGVudHJ5OwogICAgICAgIH0pCiAgICAgICk7CiAgICAgIHZhciBzdGVwQmFzZUxpbmU7CiAgICAgIGlmIChpc051bWJlcihiYXNlTGluZSkpIHsKICAgICAgICBzdGVwQmFzZUxpbmUgPSBpbnRlcnBvbGF0ZShwcmV2QmFzZUxpbmUsIGJhc2VMaW5lLCB0KTsKICAgICAgfSBlbHNlIGlmIChpc051bGxpc2goYmFzZUxpbmUpIHx8IGlzTmFuKGJhc2VMaW5lKSkgewogICAgICAgIHN0ZXBCYXNlTGluZSA9IGludGVycG9sYXRlKHByZXZCYXNlTGluZSwgMCwgdCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc3RlcEJhc2VMaW5lID0gYmFzZUxpbmUubWFwKChlbnRyeSwgaW5kZXgpID0+IHsKICAgICAgICAgIHZhciBwcmV2UG9pbnRJbmRleCA9IE1hdGguZmxvb3IoaW5kZXggKiBwcmV2UG9pbnRzRGlmZkZhY3Rvcik7CiAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShwcmV2QmFzZUxpbmUpICYmIHByZXZCYXNlTGluZVtwcmV2UG9pbnRJbmRleF0pIHsKICAgICAgICAgICAgdmFyIHByZXYgPSBwcmV2QmFzZUxpbmVbcHJldlBvaW50SW5kZXhdOwogICAgICAgICAgICByZXR1cm4gX29iamVjdFNwcmVhZDMwKF9vYmplY3RTcHJlYWQzMCh7fSwgZW50cnkpLCB7fSwgewogICAgICAgICAgICAgIHg6IGludGVycG9sYXRlKHByZXYueCwgZW50cnkueCwgdCksCiAgICAgICAgICAgICAgeTogaW50ZXJwb2xhdGUocHJldi55LCBlbnRyeS55LCB0KQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbnRyeTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAodCA+IDApIHsKICAgICAgICBwcmV2aW91c1BvaW50c1JlZi5jdXJyZW50ID0gc3RlcFBvaW50czsKICAgICAgICBwcmV2aW91c0Jhc2VsaW5lUmVmLmN1cnJlbnQgPSBzdGVwQmFzZUxpbmU7CiAgICAgIH0KICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoU3RhdGljQXJlYSwgewogICAgICAgIHBvaW50czogc3RlcFBvaW50cywKICAgICAgICBiYXNlTGluZTogc3RlcEJhc2VMaW5lLAogICAgICAgIG5lZWRDbGlwLAogICAgICAgIGNsaXBQYXRoSWQsCiAgICAgICAgcHJvcHMKICAgICAgfSk7CiAgICB9CiAgICBpZiAodCA+IDApIHsKICAgICAgcHJldmlvdXNQb2ludHNSZWYuY3VycmVudCA9IHBvaW50czsKICAgICAgcHJldmlvdXNCYXNlbGluZVJlZi5jdXJyZW50ID0gYmFzZUxpbmU7CiAgICB9CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChMYXllciwgbnVsbCwgaXNBbmltYXRpb25BY3RpdmUgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudCgiZGVmcyIsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoImNsaXBQYXRoIiwgewogICAgICBpZDogImFuaW1hdGlvbkNsaXBQYXRoLSIuY29uY2F0KGNsaXBQYXRoSWQpCiAgICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KENsaXBSZWN0LCB7CiAgICAgIGFscGhhOiB0LAogICAgICBwb2ludHMsCiAgICAgIGJhc2VMaW5lLAogICAgICBsYXlvdXQsCiAgICAgIHN0cm9rZVdpZHRoOiBwcm9wcy5zdHJva2VXaWR0aAogICAgfSkpKSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChMYXllciwgewogICAgICBjbGlwUGF0aDogInVybCgjYW5pbWF0aW9uQ2xpcFBhdGgtIi5jb25jYXQoY2xpcFBhdGhJZCwgIikiKQogICAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChTdGF0aWNBcmVhLCB7CiAgICAgIHBvaW50cywKICAgICAgYmFzZUxpbmUsCiAgICAgIG5lZWRDbGlwLAogICAgICBjbGlwUGF0aElkLAogICAgICBwcm9wcwogICAgfSkpKTsKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChMYWJlbExpc3RGcm9tTGFiZWxQcm9wLCB7CiAgICBsYWJlbDogcHJvcHMubGFiZWwKICB9KSk7Cn0KZnVuY3Rpb24gUmVuZGVyQXJlYShfcmVmOSkgewogIHZhciB7CiAgICBuZWVkQ2xpcCwKICAgIGNsaXBQYXRoSWQsCiAgICBwcm9wcwogIH0gPSBfcmVmOTsKICB2YXIgcHJldmlvdXNQb2ludHNSZWYgPSAoMCwgaW1wb3J0X3JlYWN0MzgudXNlUmVmKShudWxsKTsKICB2YXIgcHJldmlvdXNCYXNlbGluZVJlZiA9ICgwLCBpbXBvcnRfcmVhY3QzOC51c2VSZWYpKCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQXJlYVdpdGhBbmltYXRpb24sIHsKICAgIG5lZWRDbGlwLAogICAgY2xpcFBhdGhJZCwKICAgIHByb3BzLAogICAgcHJldmlvdXNQb2ludHNSZWYsCiAgICBwcmV2aW91c0Jhc2VsaW5lUmVmCiAgfSk7Cn0KdmFyIEFyZWFXaXRoU3RhdGUgPSBjbGFzcyBleHRlbmRzIGltcG9ydF9yZWFjdDM4LlB1cmVDb21wb25lbnQgewogIHJlbmRlcigpIHsKICAgIHZhciB7CiAgICAgIGhpZGUsCiAgICAgIGRvdCwKICAgICAgcG9pbnRzLAogICAgICBjbGFzc05hbWUsCiAgICAgIHRvcCwKICAgICAgbGVmdCwKICAgICAgbmVlZENsaXAsCiAgICAgIHhBeGlzSWQsCiAgICAgIHlBeGlzSWQsCiAgICAgIHdpZHRoLAogICAgICBoZWlnaHQsCiAgICAgIGlkLAogICAgICBiYXNlTGluZSwKICAgICAgekluZGV4CiAgICB9ID0gdGhpcy5wcm9wczsKICAgIGlmIChoaWRlKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogICAgdmFyIGxheWVyQ2xhc3MgPSBjbHN4KCJyZWNoYXJ0cy1hcmVhIiwgY2xhc3NOYW1lKTsKICAgIHZhciBjbGlwUGF0aElkID0gaWQ7CiAgICB2YXIgewogICAgICByOiByMiwKICAgICAgc3Ryb2tlV2lkdGgKICAgIH0gPSBnZXRSYWRpdXNBbmRTdHJva2VXaWR0aEZyb21Eb3QoZG90KTsKICAgIHZhciBjbGlwRG90ID0gaXNDbGlwRG90KGRvdCk7CiAgICB2YXIgZG90U2l6ZSA9IHIyICogMiArIHN0cm9rZVdpZHRoOwogICAgdmFyIGFjdGl2ZVBvaW50c0NsaXBQYXRoID0gbmVlZENsaXAgPyAidXJsKCNjbGlwUGF0aC0iLmNvbmNhdChjbGlwRG90ID8gIiIgOiAiZG90cy0iKS5jb25jYXQoY2xpcFBhdGhJZCwgIikiKSA6IHZvaWQgMDsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFpJbmRleExheWVyLCB7CiAgICAgIHpJbmRleAogICAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChMYXllciwgewogICAgICBjbGFzc05hbWU6IGxheWVyQ2xhc3MKICAgIH0sIG5lZWRDbGlwICYmIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoImRlZnMiLCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEdyYXBoaWNhbEl0ZW1DbGlwUGF0aCwgewogICAgICBjbGlwUGF0aElkLAogICAgICB4QXhpc0lkLAogICAgICB5QXhpc0lkCiAgICB9KSwgIWNsaXBEb3QgJiYgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudCgiY2xpcFBhdGgiLCB7CiAgICAgIGlkOiAiY2xpcFBhdGgtZG90cy0iLmNvbmNhdChjbGlwUGF0aElkKQogICAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudCgicmVjdCIsIHsKICAgICAgeDogbGVmdCAtIGRvdFNpemUgLyAyLAogICAgICB5OiB0b3AgLSBkb3RTaXplIC8gMiwKICAgICAgd2lkdGg6IHdpZHRoICsgZG90U2l6ZSwKICAgICAgaGVpZ2h0OiBoZWlnaHQgKyBkb3RTaXplCiAgICB9KSkpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFJlbmRlckFyZWEsIHsKICAgICAgbmVlZENsaXAsCiAgICAgIGNsaXBQYXRoSWQsCiAgICAgIHByb3BzOiB0aGlzLnByb3BzCiAgICB9KSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoQWN0aXZlUG9pbnRzLCB7CiAgICAgIHBvaW50cywKICAgICAgbWFpbkNvbG9yOiBnZXRMZWdlbmRJdGVtQ29sb3IodGhpcy5wcm9wcy5zdHJva2UsIHRoaXMucHJvcHMuZmlsbCksCiAgICAgIGl0ZW1EYXRhS2V5OiB0aGlzLnByb3BzLmRhdGFLZXksCiAgICAgIGFjdGl2ZURvdDogdGhpcy5wcm9wcy5hY3RpdmVEb3QsCiAgICAgIGNsaXBQYXRoOiBhY3RpdmVQb2ludHNDbGlwUGF0aAogICAgfSksIHRoaXMucHJvcHMuaXNSYW5nZSAmJiBBcnJheS5pc0FycmF5KGJhc2VMaW5lKSAmJiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KEFjdGl2ZVBvaW50cywgewogICAgICBwb2ludHM6IGJhc2VMaW5lLAogICAgICBtYWluQ29sb3I6IGdldExlZ2VuZEl0ZW1Db2xvcih0aGlzLnByb3BzLnN0cm9rZSwgdGhpcy5wcm9wcy5maWxsKSwKICAgICAgaXRlbURhdGFLZXk6IHRoaXMucHJvcHMuZGF0YUtleSwKICAgICAgYWN0aXZlRG90OiB0aGlzLnByb3BzLmFjdGl2ZURvdCwKICAgICAgY2xpcFBhdGg6IGFjdGl2ZVBvaW50c0NsaXBQYXRoCiAgICB9KSk7CiAgfQp9Owp2YXIgZGVmYXVsdEFyZWFQcm9wcyA9IHsKICBhY3RpdmVEb3Q6IHRydWUsCiAgYW5pbWF0aW9uQmVnaW46IDAsCiAgYW5pbWF0aW9uRHVyYXRpb246IDE1MDAsCiAgYW5pbWF0aW9uRWFzaW5nOiAiZWFzZSIsCiAgY29ubmVjdE51bGxzOiBmYWxzZSwKICBkb3Q6IGZhbHNlLAogIGZpbGw6ICIjMzE4MmJkIiwKICBmaWxsT3BhY2l0eTogMC42LAogIGhpZGU6IGZhbHNlLAogIGlzQW5pbWF0aW9uQWN0aXZlOiAiYXV0byIsCiAgbGVnZW5kVHlwZTogImxpbmUiLAogIHN0cm9rZTogIiMzMTgyYmQiLAogIHN0cm9rZVdpZHRoOiAxLAogIHR5cGU6ICJsaW5lYXIiLAogIGxhYmVsOiBmYWxzZSwKICB4QXhpc0lkOiAwLAogIHlBeGlzSWQ6IDAsCiAgekluZGV4OiBEZWZhdWx0WkluZGV4ZXMuYXJlYQp9OwpmdW5jdGlvbiBBcmVhSW1wbChwcm9wcykgewogIHZhciBfdXNlQXBwU2VsZWN0b3I7CiAgdmFyIF9yZXNvbHZlRGVmYXVsdFByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhwcm9wcywgZGVmYXVsdEFyZWFQcm9wcyksIHsKICAgIGFjdGl2ZURvdCwKICAgIGFuaW1hdGlvbkJlZ2luLAogICAgYW5pbWF0aW9uRHVyYXRpb24sCiAgICBhbmltYXRpb25FYXNpbmcsCiAgICBjb25uZWN0TnVsbHMsCiAgICBkb3QsCiAgICBmaWxsLAogICAgZmlsbE9wYWNpdHksCiAgICBoaWRlLAogICAgaXNBbmltYXRpb25BY3RpdmUsCiAgICBsZWdlbmRUeXBlLAogICAgc3Ryb2tlLAogICAgeEF4aXNJZCwKICAgIHlBeGlzSWQKICB9ID0gX3Jlc29sdmVEZWZhdWx0UHJvcHMsIGV2ZXJ5dGhpbmdFbHNlID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTIoX3Jlc29sdmVEZWZhdWx0UHJvcHMsIF9leGNsdWRlZDI2KTsKICB2YXIgbGF5b3V0ID0gdXNlQ2hhcnRMYXlvdXQoKTsKICB2YXIgY2hhcnROYW1lID0gdXNlQ2hhcnROYW1lKCk7CiAgdmFyIHsKICAgIG5lZWRDbGlwCiAgfSA9IHVzZU5lZWRzQ2xpcCh4QXhpc0lkLCB5QXhpc0lkKTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgewogICAgcG9pbnRzLAogICAgaXNSYW5nZSwKICAgIGJhc2VMaW5lCiAgfSA9IChfdXNlQXBwU2VsZWN0b3IgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdEFyZWEoc3RhdGUsIHhBeGlzSWQsIHlBeGlzSWQsIGlzUGFub3JhbWEsIHByb3BzLmlkKSkpICE9PSBudWxsICYmIF91c2VBcHBTZWxlY3RvciAhPT0gdm9pZCAwID8gX3VzZUFwcFNlbGVjdG9yIDoge307CiAgdmFyIHBsb3RBcmVhID0gdXNlUGxvdEFyZWEoKTsKICBpZiAobGF5b3V0ICE9PSAiaG9yaXpvbnRhbCIgJiYgbGF5b3V0ICE9PSAidmVydGljYWwiIHx8IHBsb3RBcmVhID09IG51bGwpIHsKICAgIHJldHVybiBudWxsOwogIH0KICBpZiAoY2hhcnROYW1lICE9PSAiQXJlYUNoYXJ0IiAmJiBjaGFydE5hbWUgIT09ICJDb21wb3NlZENoYXJ0IikgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBoZWlnaHQsCiAgICB3aWR0aCwKICAgIHg6IGxlZnQsCiAgICB5OiB0b3AKICB9ID0gcGxvdEFyZWE7CiAgaWYgKCFwb2ludHMgfHwgIXBvaW50cy5sZW5ndGgpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChBcmVhV2l0aFN0YXRlLCBfZXh0ZW5kczE3KHt9LCBldmVyeXRoaW5nRWxzZSwgewogICAgYWN0aXZlRG90LAogICAgYW5pbWF0aW9uQmVnaW4sCiAgICBhbmltYXRpb25EdXJhdGlvbiwKICAgIGFuaW1hdGlvbkVhc2luZywKICAgIGJhc2VMaW5lLAogICAgY29ubmVjdE51bGxzLAogICAgZG90LAogICAgZmlsbCwKICAgIGZpbGxPcGFjaXR5LAogICAgaGVpZ2h0LAogICAgaGlkZSwKICAgIGxheW91dCwKICAgIGlzQW5pbWF0aW9uQWN0aXZlOiBpc0FuaW1hdGlvbkFjdGl2ZSA9PT0gImF1dG8iID8gIUdsb2JhbC5pc1NzciA6IGlzQW5pbWF0aW9uQWN0aXZlLAogICAgaXNSYW5nZSwKICAgIGxlZ2VuZFR5cGUsCiAgICBuZWVkQ2xpcCwKICAgIHBvaW50cywKICAgIHN0cm9rZSwKICAgIHdpZHRoLAogICAgbGVmdCwKICAgIHRvcCwKICAgIHhBeGlzSWQsCiAgICB5QXhpc0lkCiAgfSkpOwp9CnZhciBnZXRCYXNlVmFsdWUgPSAobGF5b3V0LCBjaGFydEJhc2VWYWx1ZSwgaXRlbUJhc2VWYWx1ZSwgeEF4aXMsIHlBeGlzKSA9PiB7CiAgdmFyIGJhc2VWYWx1ZSA9IGl0ZW1CYXNlVmFsdWUgIT09IG51bGwgJiYgaXRlbUJhc2VWYWx1ZSAhPT0gdm9pZCAwID8gaXRlbUJhc2VWYWx1ZSA6IGNoYXJ0QmFzZVZhbHVlOwogIGlmIChpc051bWJlcihiYXNlVmFsdWUpKSB7CiAgICByZXR1cm4gYmFzZVZhbHVlOwogIH0KICB2YXIgbnVtZXJpY0F4aXMgPSBsYXlvdXQgPT09ICJob3Jpem9udGFsIiA/IHlBeGlzIDogeEF4aXM7CiAgdmFyIGRvbWFpbiA9IG51bWVyaWNBeGlzLnNjYWxlLmRvbWFpbigpOwogIGlmIChudW1lcmljQXhpcy50eXBlID09PSAibnVtYmVyIikgewogICAgdmFyIGRvbWFpbk1heCA9IE1hdGgubWF4KGRvbWFpblswXSwgZG9tYWluWzFdKTsKICAgIHZhciBkb21haW5NaW4gPSBNYXRoLm1pbihkb21haW5bMF0sIGRvbWFpblsxXSk7CiAgICBpZiAoYmFzZVZhbHVlID09PSAiZGF0YU1pbiIpIHsKICAgICAgcmV0dXJuIGRvbWFpbk1pbjsKICAgIH0KICAgIGlmIChiYXNlVmFsdWUgPT09ICJkYXRhTWF4IikgewogICAgICByZXR1cm4gZG9tYWluTWF4OwogICAgfQogICAgcmV0dXJuIGRvbWFpbk1heCA8IDAgPyBkb21haW5NYXggOiBNYXRoLm1heChNYXRoLm1pbihkb21haW5bMF0sIGRvbWFpblsxXSksIDApOwogIH0KICBpZiAoYmFzZVZhbHVlID09PSAiZGF0YU1pbiIpIHsKICAgIHJldHVybiBkb21haW5bMF07CiAgfQogIGlmIChiYXNlVmFsdWUgPT09ICJkYXRhTWF4IikgewogICAgcmV0dXJuIGRvbWFpblsxXTsKICB9CiAgcmV0dXJuIGRvbWFpblswXTsKfTsKZnVuY3Rpb24gY29tcHV0ZUFyZWEoX3JlZjApIHsKICB2YXIgewogICAgYXJlYVNldHRpbmdzOiB7CiAgICAgIGNvbm5lY3ROdWxscywKICAgICAgYmFzZVZhbHVlOiBpdGVtQmFzZVZhbHVlLAogICAgICBkYXRhS2V5CiAgICB9LAogICAgc3RhY2tlZERhdGEsCiAgICBsYXlvdXQsCiAgICBjaGFydEJhc2VWYWx1ZSwKICAgIHhBeGlzLAogICAgeUF4aXMsCiAgICBkaXNwbGF5ZWREYXRhLAogICAgZGF0YVN0YXJ0SW5kZXgsCiAgICB4QXhpc1RpY2tzLAogICAgeUF4aXNUaWNrcywKICAgIGJhbmRTaXplCiAgfSA9IF9yZWYwOwogIHZhciBoYXNTdGFjayA9IHN0YWNrZWREYXRhICYmIHN0YWNrZWREYXRhLmxlbmd0aDsKICB2YXIgYmFzZVZhbHVlID0gZ2V0QmFzZVZhbHVlKGxheW91dCwgY2hhcnRCYXNlVmFsdWUsIGl0ZW1CYXNlVmFsdWUsIHhBeGlzLCB5QXhpcyk7CiAgdmFyIGlzSG9yaXpvbnRhbExheW91dCA9IGxheW91dCA9PT0gImhvcml6b250YWwiOwogIHZhciBpc1JhbmdlID0gZmFsc2U7CiAgdmFyIHBvaW50cyA9IGRpc3BsYXllZERhdGEubWFwKChlbnRyeSwgaW5kZXgpID0+IHsKICAgIHZhciB2YWx1ZTsKICAgIGlmIChoYXNTdGFjaykgewogICAgICB2YWx1ZSA9IHN0YWNrZWREYXRhW2RhdGFTdGFydEluZGV4ICsgaW5kZXhdOwogICAgfSBlbHNlIHsKICAgICAgdmFsdWUgPSBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZGF0YUtleSk7CiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICB2YWx1ZSA9IFtiYXNlVmFsdWUsIHZhbHVlXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpc1JhbmdlID0gdHJ1ZTsKICAgICAgfQogICAgfQogICAgdmFyIGlzQnJlYWtQb2ludCA9IHZhbHVlWzFdID09IG51bGwgfHwgaGFzU3RhY2sgJiYgIWNvbm5lY3ROdWxscyAmJiBnZXRWYWx1ZUJ5RGF0YUtleShlbnRyeSwgZGF0YUtleSkgPT0gbnVsbDsKICAgIGlmIChpc0hvcml6b250YWxMYXlvdXQpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiBnZXRDYXRlQ29vcmRpbmF0ZU9mTGluZSh7CiAgICAgICAgICBheGlzOiB4QXhpcywKICAgICAgICAgIHRpY2tzOiB4QXhpc1RpY2tzLAogICAgICAgICAgYmFuZFNpemUsCiAgICAgICAgICBlbnRyeSwKICAgICAgICAgIGluZGV4CiAgICAgICAgfSksCiAgICAgICAgeTogaXNCcmVha1BvaW50ID8gbnVsbCA6IHlBeGlzLnNjYWxlKHZhbHVlWzFdKSwKICAgICAgICB2YWx1ZSwKICAgICAgICBwYXlsb2FkOiBlbnRyeQogICAgICB9OwogICAgfQogICAgcmV0dXJuIHsKICAgICAgeDogaXNCcmVha1BvaW50ID8gbnVsbCA6IHhBeGlzLnNjYWxlKHZhbHVlWzFdKSwKICAgICAgeTogZ2V0Q2F0ZUNvb3JkaW5hdGVPZkxpbmUoewogICAgICAgIGF4aXM6IHlBeGlzLAogICAgICAgIHRpY2tzOiB5QXhpc1RpY2tzLAogICAgICAgIGJhbmRTaXplLAogICAgICAgIGVudHJ5LAogICAgICAgIGluZGV4CiAgICAgIH0pLAogICAgICB2YWx1ZSwKICAgICAgcGF5bG9hZDogZW50cnkKICAgIH07CiAgfSk7CiAgdmFyIGJhc2VMaW5lOwogIGlmIChoYXNTdGFjayB8fCBpc1JhbmdlKSB7CiAgICBiYXNlTGluZSA9IHBvaW50cy5tYXAoKGVudHJ5KSA9PiB7CiAgICAgIHZhciB4MiA9IEFycmF5LmlzQXJyYXkoZW50cnkudmFsdWUpID8gZW50cnkudmFsdWVbMF0gOiBudWxsOwogICAgICBpZiAoaXNIb3Jpem9udGFsTGF5b3V0KSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIHg6IGVudHJ5LngsCiAgICAgICAgICB5OiB4MiAhPSBudWxsICYmIGVudHJ5LnkgIT0gbnVsbCA/IHlBeGlzLnNjYWxlKHgyKSA6IG51bGwsCiAgICAgICAgICBwYXlsb2FkOiBlbnRyeS5wYXlsb2FkCiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIHg6IHgyICE9IG51bGwgPyB4QXhpcy5zY2FsZSh4MikgOiBudWxsLAogICAgICAgIHk6IGVudHJ5LnksCiAgICAgICAgcGF5bG9hZDogZW50cnkucGF5bG9hZAogICAgICB9OwogICAgfSk7CiAgfSBlbHNlIHsKICAgIGJhc2VMaW5lID0gaXNIb3Jpem9udGFsTGF5b3V0ID8geUF4aXMuc2NhbGUoYmFzZVZhbHVlKSA6IHhBeGlzLnNjYWxlKGJhc2VWYWx1ZSk7CiAgfQogIHJldHVybiB7CiAgICBwb2ludHMsCiAgICBiYXNlTGluZSwKICAgIGlzUmFuZ2UKICB9Owp9CmZ1bmN0aW9uIEFyZWFGbihvdXRzaWRlUHJvcHMpIHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgZGVmYXVsdEFyZWFQcm9wcyk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI2LmNyZWF0ZUVsZW1lbnQoUmVnaXN0ZXJHcmFwaGljYWxJdGVtSWQsIHsKICAgIGlkOiBwcm9wcy5pZCwKICAgIHR5cGU6ICJhcmVhIgogIH0sIChpZCkgPT4gLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChSZWFjdDI2LkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFNldExlZ2VuZFBheWxvYWQsIHsKICAgIGxlZ2VuZFBheWxvYWQ6IGNvbXB1dGVMZWdlbmRQYXlsb2FkRnJvbUFyZWFEYXRhKHByb3BzKQogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5jcmVhdGVFbGVtZW50KFNldEFyZWFUb29sdGlwRW50cnlTZXR0aW5ncywgewogICAgZGF0YUtleTogcHJvcHMuZGF0YUtleSwKICAgIGRhdGE6IHByb3BzLmRhdGEsCiAgICBzdHJva2U6IHByb3BzLnN0cm9rZSwKICAgIHN0cm9rZVdpZHRoOiBwcm9wcy5zdHJva2VXaWR0aCwKICAgIGZpbGw6IHByb3BzLmZpbGwsCiAgICBuYW1lOiBwcm9wcy5uYW1lLAogICAgaGlkZTogcHJvcHMuaGlkZSwKICAgIHVuaXQ6IHByb3BzLnVuaXQsCiAgICB0b29sdGlwVHlwZTogcHJvcHMudG9vbHRpcFR5cGUKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChTZXRDYXJ0ZXNpYW5HcmFwaGljYWxJdGVtLCB7CiAgICB0eXBlOiAiYXJlYSIsCiAgICBpZCwKICAgIGRhdGE6IHByb3BzLmRhdGEsCiAgICBkYXRhS2V5OiBwcm9wcy5kYXRhS2V5LAogICAgeEF4aXNJZDogcHJvcHMueEF4aXNJZCwKICAgIHlBeGlzSWQ6IHByb3BzLnlBeGlzSWQsCiAgICB6QXhpc0lkOiAwLAogICAgc3RhY2tJZDogZ2V0Tm9ybWFsaXplZFN0YWNrSWQocHJvcHMuc3RhY2tJZCksCiAgICBoaWRlOiBwcm9wcy5oaWRlLAogICAgYmFyU2l6ZTogdm9pZCAwLAogICAgYmFzZVZhbHVlOiBwcm9wcy5iYXNlVmFsdWUsCiAgICBpc1Bhbm9yYW1hLAogICAgY29ubmVjdE51bGxzOiBwcm9wcy5jb25uZWN0TnVsbHMKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MjYuY3JlYXRlRWxlbWVudChBcmVhSW1wbCwgX2V4dGVuZHMxNyh7fSwgcHJvcHMsIHsKICAgIGlkCiAgfSkpKSk7Cn0KdmFyIEFyZWEgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNi5tZW1vKEFyZWFGbiwgcHJvcHNBcmVFcXVhbCk7CkFyZWEuZGlzcGxheU5hbWUgPSAiQXJlYSI7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jYXJ0ZXNpYW4vWEF4aXMuanMKdmFyIFJlYWN0MjcgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3QzOSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvYXhpc1Byb3BzQXJlRXF1YWwuanMKdmFyIF9leGNsdWRlZDEzID0gWyJkb21haW4iLCAicmFuZ2UiXTsKdmFyIF9leGNsdWRlZDI3ID0gWyJkb21haW4iLCAicmFuZ2UiXTsKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTMoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTEzKGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxMyhyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gc2hvcnRBcnJheXNBcmVFcXVhbChhcnIxLCBhcnIyKSB7CiAgaWYgKGFycjEgPT09IGFycjIpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICBpZiAoQXJyYXkuaXNBcnJheShhcnIxKSAmJiBhcnIxLmxlbmd0aCA9PT0gMiAmJiBBcnJheS5pc0FycmF5KGFycjIpICYmIGFycjIubGVuZ3RoID09PSAyKSB7CiAgICByZXR1cm4gYXJyMVswXSA9PT0gYXJyMlswXSAmJiBhcnIxWzFdID09PSBhcnIyWzFdOwogIH0KICByZXR1cm4gZmFsc2U7Cn0KZnVuY3Rpb24gYXhpc1Byb3BzQXJlRXF1YWwocHJldlByb3BzLCBuZXh0UHJvcHMpIHsKICBpZiAocHJldlByb3BzID09PSBuZXh0UHJvcHMpIHsKICAgIHJldHVybiB0cnVlOwogIH0KICB2YXIgewogICAgZG9tYWluOiBwcmV2RG9tYWluLAogICAgcmFuZ2U6IHByZXZSYW5nZQogIH0gPSBwcmV2UHJvcHMsIHByZXZSZXN0ID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTMocHJldlByb3BzLCBfZXhjbHVkZWQxMyk7CiAgdmFyIHsKICAgIGRvbWFpbjogbmV4dERvbWFpbiwKICAgIHJhbmdlOiBuZXh0UmFuZ2UKICB9ID0gbmV4dFByb3BzLCBuZXh0UmVzdCA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllczEzKG5leHRQcm9wcywgX2V4Y2x1ZGVkMjcpOwogIGlmICghc2hvcnRBcnJheXNBcmVFcXVhbChwcmV2RG9tYWluLCBuZXh0RG9tYWluKSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KICBpZiAoIXNob3J0QXJyYXlzQXJlRXF1YWwocHJldlJhbmdlLCBuZXh0UmFuZ2UpKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIHJldHVybiBwcm9wc0FyZUVxdWFsKHByZXZSZXN0LCBuZXh0UmVzdCk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9YQXhpcy5qcwp2YXIgX2V4Y2x1ZGVkMTQgPSBbImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwgInRpY2tzIl07CnZhciBfZXhjbHVkZWQyOCA9IFsiaWQiXTsKZnVuY3Rpb24gX2V4dGVuZHMxOCgpIHsKICByZXR1cm4gX2V4dGVuZHMxOCA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTguYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNChlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTQoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE0KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBTZXRYQXhpc1NldHRpbmdzKHNldHRpbmdzKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgcHJldlNldHRpbmdzUmVmID0gKDAsIGltcG9ydF9yZWFjdDM5LnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDM5LnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgIGRpc3BhdGNoKGFkZFhBeGlzKHNldHRpbmdzKSk7CiAgICB9IGVsc2UgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ICE9PSBzZXR0aW5ncykgewogICAgICBkaXNwYXRjaChyZXBsYWNlWEF4aXMoewogICAgICAgIHByZXY6IHByZXZTZXR0aW5nc1JlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IHNldHRpbmdzCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID0gc2V0dGluZ3M7CiAgfSwgW3NldHRpbmdzLCBkaXNwYXRjaF0pOwogICgwLCBpbXBvcnRfcmVhY3QzOS51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZVhBeGlzKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0sIFtkaXNwYXRjaF0pOwogIHJldHVybiBudWxsOwp9CnZhciBYQXhpc0ltcGwgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgeEF4aXNJZCwKICAgIGNsYXNzTmFtZQogIH0gPSBwcm9wczsKICB2YXIgdmlld0JveCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEF4aXNWaWV3Qm94KTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgYXhpc1R5cGUgPSAieEF4aXMiOwogIHZhciBzY2FsZSA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0QXhpc1NjYWxlKHN0YXRlLCBheGlzVHlwZSwgeEF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIHZhciBjYXJ0ZXNpYW5UaWNrSXRlbXMgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFRpY2tzT2ZBeGlzKHN0YXRlLCBheGlzVHlwZSwgeEF4aXNJZCwgaXNQYW5vcmFtYSkpOwogIHZhciBheGlzU2l6ZSA9IHVzZUFwcFNlbGVjdG9yKChzdGF0ZSkgPT4gc2VsZWN0WEF4aXNTaXplKHN0YXRlLCB4QXhpc0lkKSk7CiAgdmFyIHBvc2l0aW9uID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RYQXhpc1Bvc2l0aW9uKHN0YXRlLCB4QXhpc0lkKSk7CiAgdmFyIHN5bmNocm9uaXplZFNldHRpbmdzID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RYQXhpc1NldHRpbmdzTm9EZWZhdWx0cyhzdGF0ZSwgeEF4aXNJZCkpOwogIGlmIChheGlzU2l6ZSA9PSBudWxsIHx8IHBvc2l0aW9uID09IG51bGwgfHwgc3luY2hyb25pemVkU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBkYW5nZXJvdXNseVNldElubmVySFRNTCwKICAgIHRpY2tzOiB0aWNrczIKICB9ID0gcHJvcHMsIGFsbE90aGVyUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNChwcm9wcywgX2V4Y2x1ZGVkMTQpOwogIHZhciB7CiAgICBpZAogIH0gPSBzeW5jaHJvbml6ZWRTZXR0aW5ncywgcmVzdFN5bmNocm9uaXplZFNldHRpbmdzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTQoc3luY2hyb25pemVkU2V0dGluZ3MsIF9leGNsdWRlZDI4KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjcuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5BeGlzLCBfZXh0ZW5kczE4KHt9LCBhbGxPdGhlclByb3BzLCByZXN0U3luY2hyb25pemVkU2V0dGluZ3MsIHsKICAgIHNjYWxlLAogICAgeDogcG9zaXRpb24ueCwKICAgIHk6IHBvc2l0aW9uLnksCiAgICB3aWR0aDogYXhpc1NpemUud2lkdGgsCiAgICBoZWlnaHQ6IGF4aXNTaXplLmhlaWdodCwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtIi5jb25jYXQoYXhpc1R5cGUsICIgIikuY29uY2F0KGF4aXNUeXBlKSwgY2xhc3NOYW1lKSwKICAgIHZpZXdCb3gsCiAgICB0aWNrczogY2FydGVzaWFuVGlja0l0ZW1zLAogICAgYXhpc1R5cGUKICB9KSk7Cn07CnZhciB4QXhpc0RlZmF1bHRQcm9wcyA9IHsKICBhbGxvd0RhdGFPdmVyZmxvdzogaW1wbGljaXRYQXhpcy5hbGxvd0RhdGFPdmVyZmxvdywKICBhbGxvd0RlY2ltYWxzOiBpbXBsaWNpdFhBeGlzLmFsbG93RGVjaW1hbHMsCiAgYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnk6IGltcGxpY2l0WEF4aXMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgYW5nbGU6IGltcGxpY2l0WEF4aXMuYW5nbGUsCiAgYXhpc0xpbmU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMuYXhpc0xpbmUsCiAgaGVpZ2h0OiBpbXBsaWNpdFhBeGlzLmhlaWdodCwKICBoaWRlOiBmYWxzZSwKICBpbmNsdWRlSGlkZGVuOiBpbXBsaWNpdFhBeGlzLmluY2x1ZGVIaWRkZW4sCiAgaW50ZXJ2YWw6IGltcGxpY2l0WEF4aXMuaW50ZXJ2YWwsCiAgbWluVGlja0dhcDogaW1wbGljaXRYQXhpcy5taW5UaWNrR2FwLAogIG1pcnJvcjogaW1wbGljaXRYQXhpcy5taXJyb3IsCiAgb3JpZW50YXRpb246IGltcGxpY2l0WEF4aXMub3JpZW50YXRpb24sCiAgcGFkZGluZzogaW1wbGljaXRYQXhpcy5wYWRkaW5nLAogIHJldmVyc2VkOiBpbXBsaWNpdFhBeGlzLnJldmVyc2VkLAogIHNjYWxlOiBpbXBsaWNpdFhBeGlzLnNjYWxlLAogIHRpY2s6IGltcGxpY2l0WEF4aXMudGljaywKICB0aWNrQ291bnQ6IGltcGxpY2l0WEF4aXMudGlja0NvdW50LAogIHRpY2tMaW5lOiBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzLnRpY2tMaW5lLAogIHRpY2tTaXplOiBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzLnRpY2tTaXplLAogIHR5cGU6IGltcGxpY2l0WEF4aXMudHlwZSwKICB4QXhpc0lkOiAwCn07CnZhciBYQXhpc1NldHRpbmdzRGlzcGF0Y2hlciA9IChvdXRzaWRlUHJvcHMpID0+IHsKICB2YXIgcHJvcHMgPSByZXNvbHZlRGVmYXVsdFByb3BzKG91dHNpZGVQcm9wcywgeEF4aXNEZWZhdWx0UHJvcHMpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5jcmVhdGVFbGVtZW50KFJlYWN0MjcuRnJhZ21lbnQsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoU2V0WEF4aXNTZXR0aW5ncywgewogICAgYWxsb3dEYXRhT3ZlcmZsb3c6IHByb3BzLmFsbG93RGF0YU92ZXJmbG93LAogICAgYWxsb3dEZWNpbWFsczogcHJvcHMuYWxsb3dEZWNpbWFscywKICAgIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBwcm9wcy5hbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeSwKICAgIGFuZ2xlOiBwcm9wcy5hbmdsZSwKICAgIGRhdGFLZXk6IHByb3BzLmRhdGFLZXksCiAgICBkb21haW46IHByb3BzLmRvbWFpbiwKICAgIGhlaWdodDogcHJvcHMuaGVpZ2h0LAogICAgaGlkZTogcHJvcHMuaGlkZSwKICAgIGlkOiBwcm9wcy54QXhpc0lkLAogICAgaW5jbHVkZUhpZGRlbjogcHJvcHMuaW5jbHVkZUhpZGRlbiwKICAgIGludGVydmFsOiBwcm9wcy5pbnRlcnZhbCwKICAgIG1pblRpY2tHYXA6IHByb3BzLm1pblRpY2tHYXAsCiAgICBtaXJyb3I6IHByb3BzLm1pcnJvciwKICAgIG5hbWU6IHByb3BzLm5hbWUsCiAgICBvcmllbnRhdGlvbjogcHJvcHMub3JpZW50YXRpb24sCiAgICBwYWRkaW5nOiBwcm9wcy5wYWRkaW5nLAogICAgcmV2ZXJzZWQ6IHByb3BzLnJldmVyc2VkLAogICAgc2NhbGU6IHByb3BzLnNjYWxlLAogICAgdGljazogcHJvcHMudGljaywKICAgIHRpY2tDb3VudDogcHJvcHMudGlja0NvdW50LAogICAgdGlja0Zvcm1hdHRlcjogcHJvcHMudGlja0Zvcm1hdHRlciwKICAgIHRpY2tzOiBwcm9wcy50aWNrcywKICAgIHR5cGU6IHByb3BzLnR5cGUsCiAgICB1bml0OiBwcm9wcy51bml0CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI3LmNyZWF0ZUVsZW1lbnQoWEF4aXNJbXBsLCBwcm9wcykpOwp9Owp2YXIgWEF4aXMgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyNy5tZW1vKFhBeGlzU2V0dGluZ3NEaXNwYXRjaGVyLCBheGlzUHJvcHNBcmVFcXVhbCk7ClhBeGlzLmRpc3BsYXlOYW1lID0gIlhBeGlzIjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NhcnRlc2lhbi9ZQXhpcy5qcwp2YXIgUmVhY3QyOCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgX2V4Y2x1ZGVkMTUgPSBbImRhbmdlcm91c2x5U2V0SW5uZXJIVE1MIiwgInRpY2tzIl07CnZhciBfZXhjbHVkZWQyOSA9IFsiaWQiXTsKZnVuY3Rpb24gX2V4dGVuZHMxOSgpIHsKICByZXR1cm4gX2V4dGVuZHMxOSA9IE9iamVjdC5hc3NpZ24gPyBPYmplY3QuYXNzaWduLmJpbmQoKSA6IGZ1bmN0aW9uKG4pIHsKICAgIGZvciAodmFyIGUgPSAxOyBlIDwgYXJndW1lbnRzLmxlbmd0aDsgZSsrKSB7CiAgICAgIHZhciB0ID0gYXJndW1lbnRzW2VdOwogICAgICBmb3IgKHZhciByMiBpbiB0KSAoe30pLmhhc093blByb3BlcnR5LmNhbGwodCwgcjIpICYmIChuW3IyXSA9IHRbcjJdKTsKICAgIH0KICAgIHJldHVybiBuOwogIH0sIF9leHRlbmRzMTkuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNShlLCB0KSB7CiAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogIHZhciBvLCByMiwgaSA9IF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTUoZSwgdCk7CiAgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsKICAgIHZhciBuID0gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhlKTsKICAgIGZvciAocjIgPSAwOyByMiA8IG4ubGVuZ3RoOyByMisrKSBvID0gbltyMl0sIC0xID09PSB0LmluZGV4T2YobykgJiYge30ucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBvKSAmJiAoaVtvXSA9IGVbb10pOwogIH0KICByZXR1cm4gaTsKfQpmdW5jdGlvbiBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE1KHIyLCBlKSB7CiAgaWYgKG51bGwgPT0gcjIpIHJldHVybiB7fTsKICB2YXIgdCA9IHt9OwogIGZvciAodmFyIG4gaW4gcjIpIGlmICh7fS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHIyLCBuKSkgewogICAgaWYgKC0xICE9PSBlLmluZGV4T2YobikpIGNvbnRpbnVlOwogICAgdFtuXSA9IHIyW25dOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBTZXRZQXhpc1NldHRpbmdzKHNldHRpbmdzKSB7CiAgdmFyIGRpc3BhdGNoID0gdXNlQXBwRGlzcGF0Y2goKTsKICB2YXIgcHJldlNldHRpbmdzUmVmID0gKDAsIGltcG9ydF9yZWFjdDQwLnVzZVJlZikobnVsbCk7CiAgKDAsIGltcG9ydF9yZWFjdDQwLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID09PSBudWxsKSB7CiAgICAgIGRpc3BhdGNoKGFkZFlBeGlzKHNldHRpbmdzKSk7CiAgICB9IGVsc2UgaWYgKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ICE9PSBzZXR0aW5ncykgewogICAgICBkaXNwYXRjaChyZXBsYWNlWUF4aXMoewogICAgICAgIHByZXY6IHByZXZTZXR0aW5nc1JlZi5jdXJyZW50LAogICAgICAgIG5leHQ6IHNldHRpbmdzCiAgICAgIH0pKTsKICAgIH0KICAgIHByZXZTZXR0aW5nc1JlZi5jdXJyZW50ID0gc2V0dGluZ3M7CiAgfSwgW3NldHRpbmdzLCBkaXNwYXRjaF0pOwogICgwLCBpbXBvcnRfcmVhY3Q0MC51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGlmIChwcmV2U2V0dGluZ3NSZWYuY3VycmVudCkgewogICAgICAgIGRpc3BhdGNoKHJlbW92ZVlBeGlzKHByZXZTZXR0aW5nc1JlZi5jdXJyZW50KSk7CiAgICAgICAgcHJldlNldHRpbmdzUmVmLmN1cnJlbnQgPSBudWxsOwogICAgICB9CiAgICB9OwogIH0sIFtkaXNwYXRjaF0pOwogIHJldHVybiBudWxsOwp9CnZhciBZQXhpc0ltcGwgPSAocHJvcHMpID0+IHsKICB2YXIgewogICAgeUF4aXNJZCwKICAgIGNsYXNzTmFtZSwKICAgIHdpZHRoLAogICAgbGFiZWwKICB9ID0gcHJvcHM7CiAgdmFyIGNhcnRlc2lhbkF4aXNSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDAudXNlUmVmKShudWxsKTsKICB2YXIgbGFiZWxSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDAudXNlUmVmKShudWxsKTsKICB2YXIgdmlld0JveCA9IHVzZUFwcFNlbGVjdG9yKHNlbGVjdEF4aXNWaWV3Qm94KTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBheGlzVHlwZSA9ICJ5QXhpcyI7CiAgdmFyIHNjYWxlID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RBeGlzU2NhbGUoc3RhdGUsIGF4aXNUeXBlLCB5QXhpc0lkLCBpc1Bhbm9yYW1hKSk7CiAgdmFyIGF4aXNTaXplID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RZQXhpc1NpemUoc3RhdGUsIHlBeGlzSWQpKTsKICB2YXIgcG9zaXRpb24gPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFlBeGlzUG9zaXRpb24oc3RhdGUsIHlBeGlzSWQpKTsKICB2YXIgY2FydGVzaWFuVGlja0l0ZW1zID0gdXNlQXBwU2VsZWN0b3IoKHN0YXRlKSA9PiBzZWxlY3RUaWNrc09mQXhpcyhzdGF0ZSwgYXhpc1R5cGUsIHlBeGlzSWQsIGlzUGFub3JhbWEpKTsKICB2YXIgc3luY2hyb25pemVkU2V0dGluZ3MgPSB1c2VBcHBTZWxlY3Rvcigoc3RhdGUpID0+IHNlbGVjdFlBeGlzU2V0dGluZ3NOb0RlZmF1bHRzKHN0YXRlLCB5QXhpc0lkKSk7CiAgKDAsIGltcG9ydF9yZWFjdDQwLnVzZUxheW91dEVmZmVjdCkoKCkgPT4gewogICAgaWYgKHdpZHRoICE9PSAiYXV0byIgfHwgIWF4aXNTaXplIHx8IGlzTGFiZWxDb250ZW50QUZ1bmN0aW9uKGxhYmVsKSB8fCAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQwLmlzVmFsaWRFbGVtZW50KShsYWJlbCkgfHwgc3luY2hyb25pemVkU2V0dGluZ3MgPT0gbnVsbCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgYXhpc0NvbXBvbmVudCA9IGNhcnRlc2lhbkF4aXNSZWYuY3VycmVudDsKICAgIGlmICghYXhpc0NvbXBvbmVudCkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgdXBkYXRlZFlBeGlzV2lkdGggPSBheGlzQ29tcG9uZW50LmdldENhbGN1bGF0ZWRXaWR0aCgpOwogICAgaWYgKE1hdGgucm91bmQoYXhpc1NpemUud2lkdGgpICE9PSBNYXRoLnJvdW5kKHVwZGF0ZWRZQXhpc1dpZHRoKSkgewogICAgICBkaXNwYXRjaCh1cGRhdGVZQXhpc1dpZHRoKHsKICAgICAgICBpZDogeUF4aXNJZCwKICAgICAgICB3aWR0aDogdXBkYXRlZFlBeGlzV2lkdGgKICAgICAgfSkpOwogICAgfQogIH0sIFsKICAgIC8vIFRoZSBkZXBlbmRlbmN5IG9uIGNhcnRlc2lhbkF4aXNSZWYuY3VycmVudCBpcyBub3QgbmVlZGVkIGJlY2F1c2UgdXNlTGF5b3V0RWZmZWN0IHdpbGwgcnVuIGFmdGVyIGV2ZXJ5IHJlbmRlci4KICAgIC8vIFRoZSByZWYgd2lsbCBiZSBwb3B1bGF0ZWQgYnkgdGhlbi4KICAgIC8vIFRvIHJlLXJ1biB0aGlzIGVmZmVjdCB3aGVuIHRpY2tzIGNoYW5nZSwgd2UgY2FuIGRlcGVuZCBvbiB0aGUgdGlja3MgYXJyYXkgZnJvbSB0aGUgc3RvcmUuCiAgICBjYXJ0ZXNpYW5UaWNrSXRlbXMsCiAgICBheGlzU2l6ZSwKICAgIGRpc3BhdGNoLAogICAgbGFiZWwsCiAgICB5QXhpc0lkLAogICAgd2lkdGgsCiAgICBzeW5jaHJvbml6ZWRTZXR0aW5ncwogIF0pOwogIGlmIChheGlzU2l6ZSA9PSBudWxsIHx8IHBvc2l0aW9uID09IG51bGwgfHwgc3luY2hyb25pemVkU2V0dGluZ3MgPT0gbnVsbCkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBkYW5nZXJvdXNseVNldElubmVySFRNTCwKICAgIHRpY2tzOiB0aWNrczIKICB9ID0gcHJvcHMsIGFsbE90aGVyUHJvcHMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNShwcm9wcywgX2V4Y2x1ZGVkMTUpOwogIHZhciB7CiAgICBpZAogIH0gPSBzeW5jaHJvbml6ZWRTZXR0aW5ncywgcmVzdFN5bmNocm9uaXplZFNldHRpbmdzID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTUoc3luY2hyb25pemVkU2V0dGluZ3MsIF9leGNsdWRlZDI5KTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5BeGlzLCBfZXh0ZW5kczE5KHt9LCBhbGxPdGhlclByb3BzLCByZXN0U3luY2hyb25pemVkU2V0dGluZ3MsIHsKICAgIHJlZjogY2FydGVzaWFuQXhpc1JlZiwKICAgIGxhYmVsUmVmLAogICAgc2NhbGUsCiAgICB4OiBwb3NpdGlvbi54LAogICAgeTogcG9zaXRpb24ueSwKICAgIHRpY2tUZXh0UHJvcHM6IHdpZHRoID09PSAiYXV0byIgPyB7CiAgICAgIHdpZHRoOiB2b2lkIDAKICAgIH0gOiB7CiAgICAgIHdpZHRoCiAgICB9LAogICAgd2lkdGg6IGF4aXNTaXplLndpZHRoLAogICAgaGVpZ2h0OiBheGlzU2l6ZS5oZWlnaHQsCiAgICBjbGFzc05hbWU6IGNsc3goInJlY2hhcnRzLSIuY29uY2F0KGF4aXNUeXBlLCAiICIpLmNvbmNhdChheGlzVHlwZSksIGNsYXNzTmFtZSksCiAgICB2aWV3Qm94LAogICAgdGlja3M6IGNhcnRlc2lhblRpY2tJdGVtcywKICAgIGF4aXNUeXBlCiAgfSkpOwp9Owp2YXIgeUF4aXNEZWZhdWx0UHJvcHMgPSB7CiAgYWxsb3dEYXRhT3ZlcmZsb3c6IGltcGxpY2l0WUF4aXMuYWxsb3dEYXRhT3ZlcmZsb3csCiAgYWxsb3dEZWNpbWFsczogaW1wbGljaXRZQXhpcy5hbGxvd0RlY2ltYWxzLAogIGFsbG93RHVwbGljYXRlZENhdGVnb3J5OiBpbXBsaWNpdFlBeGlzLmFsbG93RHVwbGljYXRlZENhdGVnb3J5LAogIGFuZ2xlOiBpbXBsaWNpdFlBeGlzLmFuZ2xlLAogIGF4aXNMaW5lOiBkZWZhdWx0Q2FydGVzaWFuQXhpc1Byb3BzLmF4aXNMaW5lLAogIGhpZGU6IGZhbHNlLAogIGluY2x1ZGVIaWRkZW46IGltcGxpY2l0WUF4aXMuaW5jbHVkZUhpZGRlbiwKICBpbnRlcnZhbDogaW1wbGljaXRZQXhpcy5pbnRlcnZhbCwKICBtaW5UaWNrR2FwOiBpbXBsaWNpdFlBeGlzLm1pblRpY2tHYXAsCiAgbWlycm9yOiBpbXBsaWNpdFlBeGlzLm1pcnJvciwKICBvcmllbnRhdGlvbjogaW1wbGljaXRZQXhpcy5vcmllbnRhdGlvbiwKICBwYWRkaW5nOiBpbXBsaWNpdFlBeGlzLnBhZGRpbmcsCiAgcmV2ZXJzZWQ6IGltcGxpY2l0WUF4aXMucmV2ZXJzZWQsCiAgc2NhbGU6IGltcGxpY2l0WUF4aXMuc2NhbGUsCiAgdGljazogaW1wbGljaXRZQXhpcy50aWNrLAogIHRpY2tDb3VudDogaW1wbGljaXRZQXhpcy50aWNrQ291bnQsCiAgdGlja0xpbmU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMudGlja0xpbmUsCiAgdGlja1NpemU6IGRlZmF1bHRDYXJ0ZXNpYW5BeGlzUHJvcHMudGlja1NpemUsCiAgdHlwZTogaW1wbGljaXRZQXhpcy50eXBlLAogIHdpZHRoOiBpbXBsaWNpdFlBeGlzLndpZHRoLAogIHlBeGlzSWQ6IDAKfTsKdmFyIFlBeGlzU2V0dGluZ3NEaXNwYXRjaGVyID0gKG91dHNpZGVQcm9wcykgPT4gewogIHZhciBwcm9wcyA9IHJlc29sdmVEZWZhdWx0UHJvcHMob3V0c2lkZVByb3BzLCB5QXhpc0RlZmF1bHRQcm9wcyk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI4LmNyZWF0ZUVsZW1lbnQoUmVhY3QyOC5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MjguY3JlYXRlRWxlbWVudChTZXRZQXhpc1NldHRpbmdzLCB7CiAgICBpbnRlcnZhbDogcHJvcHMuaW50ZXJ2YWwsCiAgICBpZDogcHJvcHMueUF4aXNJZCwKICAgIHNjYWxlOiBwcm9wcy5zY2FsZSwKICAgIHR5cGU6IHByb3BzLnR5cGUsCiAgICBkb21haW46IHByb3BzLmRvbWFpbiwKICAgIGFsbG93RGF0YU92ZXJmbG93OiBwcm9wcy5hbGxvd0RhdGFPdmVyZmxvdywKICAgIGRhdGFLZXk6IHByb3BzLmRhdGFLZXksCiAgICBhbGxvd0R1cGxpY2F0ZWRDYXRlZ29yeTogcHJvcHMuYWxsb3dEdXBsaWNhdGVkQ2F0ZWdvcnksCiAgICBhbGxvd0RlY2ltYWxzOiBwcm9wcy5hbGxvd0RlY2ltYWxzLAogICAgdGlja0NvdW50OiBwcm9wcy50aWNrQ291bnQsCiAgICBwYWRkaW5nOiBwcm9wcy5wYWRkaW5nLAogICAgaW5jbHVkZUhpZGRlbjogcHJvcHMuaW5jbHVkZUhpZGRlbiwKICAgIHJldmVyc2VkOiBwcm9wcy5yZXZlcnNlZCwKICAgIHRpY2tzOiBwcm9wcy50aWNrcywKICAgIHdpZHRoOiBwcm9wcy53aWR0aCwKICAgIG9yaWVudGF0aW9uOiBwcm9wcy5vcmllbnRhdGlvbiwKICAgIG1pcnJvcjogcHJvcHMubWlycm9yLAogICAgaGlkZTogcHJvcHMuaGlkZSwKICAgIHVuaXQ6IHByb3BzLnVuaXQsCiAgICBuYW1lOiBwcm9wcy5uYW1lLAogICAgYW5nbGU6IHByb3BzLmFuZ2xlLAogICAgbWluVGlja0dhcDogcHJvcHMubWluVGlja0dhcCwKICAgIHRpY2s6IHByb3BzLnRpY2ssCiAgICB0aWNrRm9ybWF0dGVyOiBwcm9wcy50aWNrRm9ybWF0dGVyCiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI4LmNyZWF0ZUVsZW1lbnQoWUF4aXNJbXBsLCBwcm9wcykpOwp9Owp2YXIgWUF4aXMgPSAvKiBAX19QVVJFX18gKi8gUmVhY3QyOC5tZW1vKFlBeGlzU2V0dGluZ3NEaXNwYXRjaGVyLCBheGlzUHJvcHNBcmVFcXVhbCk7CllBeGlzLmRpc3BsYXlOYW1lID0gIllBeGlzIjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NoYXJ0L0NhcnRlc2lhbkNoYXJ0LmpzCnZhciBSZWFjdDM0ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NDkgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9SZWNoYXJ0c1N0b3JlUHJvdmlkZXIuanMKdmFyIFJlYWN0MjkgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0MSA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3NlbGVjdG9ycy9zZWxlY3RBY3RpdmVQcm9wc0Zyb21DaGFydFBvaW50ZXIuanMKdmFyIHBpY2tDaGFydFBvaW50ZXIgPSAoX3N0YXRlLCBjaGFydFBvaW50ZXIpID0+IGNoYXJ0UG9pbnRlcjsKdmFyIHNlbGVjdEFjdGl2ZVByb3BzRnJvbUNoYXJ0UG9pbnRlciA9IGNyZWF0ZVNlbGVjdG9yKFtwaWNrQ2hhcnRQb2ludGVyLCBzZWxlY3RDaGFydExheW91dCwgc2VsZWN0UG9sYXJWaWV3Qm94LCBzZWxlY3RUb29sdGlwQXhpc1R5cGUsIHNlbGVjdFRvb2x0aXBBeGlzUmFuZ2VXaXRoUmV2ZXJzZSwgc2VsZWN0VG9vbHRpcEF4aXNUaWNrcywgc2VsZWN0T3JkZXJlZFRvb2x0aXBUaWNrcywgc2VsZWN0Q2hhcnRPZmZzZXRJbnRlcm5hbF0sIGNvbWJpbmVBY3RpdmVQcm9wcyk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi91dGlsL2dldENoYXJ0UG9pbnRlci5qcwp2YXIgZ2V0Q2hhcnRQb2ludGVyID0gKGV2ZW50KSA9PiB7CiAgdmFyIHJlY3QgPSBldmVudC5jdXJyZW50VGFyZ2V0LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogIHZhciBzY2FsZVggPSByZWN0LndpZHRoIC8gZXZlbnQuY3VycmVudFRhcmdldC5vZmZzZXRXaWR0aDsKICB2YXIgc2NhbGVZID0gcmVjdC5oZWlnaHQgLyBldmVudC5jdXJyZW50VGFyZ2V0Lm9mZnNldEhlaWdodDsKICByZXR1cm4gewogICAgLyoKICAgICAqIEhlcmUgaXQncyBpbXBvcnRhbnQgdG8gdXNlOgogICAgICogLSBldmVudC5jbGllbnRYIGFuZCBldmVudC5jbGllbnRZIHRvIGdldCB0aGUgbW91c2UgcG9zaXRpb24gcmVsYXRpdmUgdG8gdGhlIHZpZXdwb3J0LCBpbmNsdWRpbmcgc2Nyb2xsLgogICAgICogLSBwYWdlWCBhbmQgcGFnZVkgYXJlIG5vdCB1c2VkIGJlY2F1c2UgdGhleSBhcmUgcmVsYXRpdmUgdG8gdGhlIHdob2xlIGRvY3VtZW50LCBhbmQgaWdub3JlIHNjcm9sbC4KICAgICAqIC0gcmVjdC5sZWZ0IGFuZCByZWN0LnRvcCBhcmUgdXNlZCB0byBnZXQgdGhlIHBvc2l0aW9uIG9mIHRoZSBjaGFydCByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnQuCiAgICAgKiAtIG9mZnNldFggYW5kIG9mZnNldFkgYXJlIG5vdCB1c2VkIGJlY2F1c2UgdGhleSBhcmUgcmVsYXRpdmUgdG8gdGhlIG9mZnNldCBwYXJlbnQKICAgICAqICB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSB0aGUgc2FtZSBhcyB0aGUgY2xpZW50WCBhbmQgY2xpZW50WSwgZGVwZW5kaW5nIG9uIHRoZSBwb3NpdGlvbiBvZiB0aGUgY2hhcnQgaW4gdGhlIERPTQogICAgICogIGFuZCBzdXJyb3VuZGluZyBlbGVtZW50IHN0eWxlcy4gQ1NTIHBvc2l0aW9uOiByZWxhdGl2ZSwgYWJzb2x1dGUsIGZpeGVkLCB3aWxsIGNoYW5nZSB0aGUgb2Zmc2V0IHBhcmVudC4KICAgICAqIC0gc2NhbGVYIGFuZCBzY2FsZVkgYXJlIG5lY2Vzc2FyeSBmb3Igd2hlbiB0aGUgY2hhcnQgZWxlbWVudCBpcyBzY2FsZWQgdXNpbmcgQ1NTIGB0cmFuc2Zvcm06IHNjYWxlKE4pYC4KICAgICAqLwogICAgY2hhcnRYOiBNYXRoLnJvdW5kKChldmVudC5jbGllbnRYIC0gcmVjdC5sZWZ0KSAvIHNjYWxlWCksCiAgICBjaGFydFk6IE1hdGgucm91bmQoKGV2ZW50LmNsaWVudFkgLSByZWN0LnRvcCkgLyBzY2FsZVkpCiAgfTsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL21vdXNlRXZlbnRzTWlkZGxld2FyZS5qcwp2YXIgbW91c2VDbGlja0FjdGlvbiA9IGNyZWF0ZUFjdGlvbigibW91c2VDbGljayIpOwp2YXIgbW91c2VDbGlja01pZGRsZXdhcmUgPSBjcmVhdGVMaXN0ZW5lck1pZGRsZXdhcmUoKTsKbW91c2VDbGlja01pZGRsZXdhcmUuc3RhcnRMaXN0ZW5pbmcoewogIGFjdGlvbkNyZWF0b3I6IG1vdXNlQ2xpY2tBY3Rpb24sCiAgZWZmZWN0OiAoYWN0aW9uLCBsaXN0ZW5lckFwaSkgPT4gewogICAgdmFyIG1vdXNlUG9pbnRlciA9IGFjdGlvbi5wYXlsb2FkOwogICAgdmFyIGFjdGl2ZVByb3BzID0gc2VsZWN0QWN0aXZlUHJvcHNGcm9tQ2hhcnRQb2ludGVyKGxpc3RlbmVyQXBpLmdldFN0YXRlKCksIGdldENoYXJ0UG9pbnRlcihtb3VzZVBvaW50ZXIpKTsKICAgIGlmICgoYWN0aXZlUHJvcHMgPT09IG51bGwgfHwgYWN0aXZlUHJvcHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGFjdGl2ZVByb3BzLmFjdGl2ZUluZGV4KSAhPSBudWxsKSB7CiAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldE1vdXNlQ2xpY2tBeGlzSW5kZXgoewogICAgICAgIGFjdGl2ZUluZGV4OiBhY3RpdmVQcm9wcy5hY3RpdmVJbmRleCwKICAgICAgICBhY3RpdmVEYXRhS2V5OiB2b2lkIDAsCiAgICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogYWN0aXZlUHJvcHMuYWN0aXZlQ29vcmRpbmF0ZQogICAgICB9KSk7CiAgICB9CiAgfQp9KTsKdmFyIG1vdXNlTW92ZUFjdGlvbiA9IGNyZWF0ZUFjdGlvbigibW91c2VNb3ZlIik7CnZhciBtb3VzZU1vdmVNaWRkbGV3YXJlID0gY3JlYXRlTGlzdGVuZXJNaWRkbGV3YXJlKCk7CnZhciByYWZJZCA9IG51bGw7Cm1vdXNlTW92ZU1pZGRsZXdhcmUuc3RhcnRMaXN0ZW5pbmcoewogIGFjdGlvbkNyZWF0b3I6IG1vdXNlTW92ZUFjdGlvbiwKICBlZmZlY3Q6IChhY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICB2YXIgbW91c2VQb2ludGVyID0gYWN0aW9uLnBheWxvYWQ7CiAgICBpZiAocmFmSWQgIT09IG51bGwpIHsKICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUocmFmSWQpOwogICAgfQogICAgdmFyIGNoYXJ0UG9pbnRlciA9IGdldENoYXJ0UG9pbnRlcihtb3VzZVBvaW50ZXIpOwogICAgcmFmSWQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gewogICAgICB2YXIgc3RhdGUgPSBsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpOwogICAgICB2YXIgdG9vbHRpcEV2ZW50VHlwZSA9IHNlbGVjdFRvb2x0aXBFdmVudFR5cGUoc3RhdGUsIHN0YXRlLnRvb2x0aXAuc2V0dGluZ3Muc2hhcmVkKTsKICAgICAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgICAgIHZhciBhY3RpdmVQcm9wcyA9IHNlbGVjdEFjdGl2ZVByb3BzRnJvbUNoYXJ0UG9pbnRlcihzdGF0ZSwgY2hhcnRQb2ludGVyKTsKICAgICAgICBpZiAoKGFjdGl2ZVByb3BzID09PSBudWxsIHx8IGFjdGl2ZVByb3BzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBhY3RpdmVQcm9wcy5hY3RpdmVJbmRleCkgIT0gbnVsbCkgewogICAgICAgICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2goc2V0TW91c2VPdmVyQXhpc0luZGV4KHsKICAgICAgICAgICAgYWN0aXZlSW5kZXg6IGFjdGl2ZVByb3BzLmFjdGl2ZUluZGV4LAogICAgICAgICAgICBhY3RpdmVEYXRhS2V5OiB2b2lkIDAsCiAgICAgICAgICAgIGFjdGl2ZUNvb3JkaW5hdGU6IGFjdGl2ZVByb3BzLmFjdGl2ZUNvb3JkaW5hdGUKICAgICAgICAgIH0pKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbGlzdGVuZXJBcGkuZGlzcGF0Y2gobW91c2VMZWF2ZUNoYXJ0KCkpOwogICAgICAgIH0KICAgICAgfQogICAgICByYWZJZCA9IG51bGw7CiAgICB9KTsKICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvcmVkdXhEZXZ0b29sc0pzb25TdHJpbmdpZnlSZXBsYWNlci5qcwpmdW5jdGlvbiByZWR1eERldnRvb2xzSnNvblN0cmluZ2lmeVJlcGxhY2VyKGtleSwgdmFsdWUpIHsKICBpZiAodmFsdWUgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgewogICAgcmV0dXJuICJIVE1MRWxlbWVudCA8Ii5jb25jYXQodmFsdWUudGFnTmFtZSwgJyBjbGFzcz0iJykuY29uY2F0KHZhbHVlLmNsYXNzTmFtZSwgJyI+Jyk7CiAgfQogIGlmICh2YWx1ZSA9PT0gd2luZG93KSB7CiAgICByZXR1cm4gImdsb2JhbC53aW5kb3ciOwogIH0KICBpZiAoa2V5ID09PSAiY2hpbGRyZW4iICYmIHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgJiYgdmFsdWUgIT09IG51bGwpIHsKICAgIHJldHVybiAiPDxDSElMRFJFTj4+IjsKICB9CiAgcmV0dXJuIHZhbHVlOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9yb290UHJvcHNTbGljZS5qcwp2YXIgaW5pdGlhbFN0YXRlMTIgPSB7CiAgYWNjZXNzaWJpbGl0eUxheWVyOiB0cnVlLAogIGJhckNhdGVnb3J5R2FwOiAiMTAlIiwKICBiYXJHYXA6IDQsCiAgYmFyU2l6ZTogdm9pZCAwLAogIGNsYXNzTmFtZTogdm9pZCAwLAogIG1heEJhclNpemU6IHZvaWQgMCwKICBzdGFja09mZnNldDogIm5vbmUiLAogIHN5bmNJZDogdm9pZCAwLAogIHN5bmNNZXRob2Q6ICJpbmRleCIsCiAgYmFzZVZhbHVlOiB2b2lkIDAsCiAgcmV2ZXJzZVN0YWNrT3JkZXI6IGZhbHNlCn07CnZhciByb290UHJvcHNTbGljZSA9IGNyZWF0ZVNsaWNlKHsKICBuYW1lOiAicm9vdFByb3BzIiwKICBpbml0aWFsU3RhdGU6IGluaXRpYWxTdGF0ZTEyLAogIHJlZHVjZXJzOiB7CiAgICB1cGRhdGVPcHRpb25zOiAoc3RhdGUsIGFjdGlvbikgPT4gewogICAgICB2YXIgX2FjdGlvbiRwYXlsb2FkJGJhckdhOwogICAgICBzdGF0ZS5hY2Nlc3NpYmlsaXR5TGF5ZXIgPSBhY3Rpb24ucGF5bG9hZC5hY2Nlc3NpYmlsaXR5TGF5ZXI7CiAgICAgIHN0YXRlLmJhckNhdGVnb3J5R2FwID0gYWN0aW9uLnBheWxvYWQuYmFyQ2F0ZWdvcnlHYXA7CiAgICAgIHN0YXRlLmJhckdhcCA9IChfYWN0aW9uJHBheWxvYWQkYmFyR2EgPSBhY3Rpb24ucGF5bG9hZC5iYXJHYXApICE9PSBudWxsICYmIF9hY3Rpb24kcGF5bG9hZCRiYXJHYSAhPT0gdm9pZCAwID8gX2FjdGlvbiRwYXlsb2FkJGJhckdhIDogaW5pdGlhbFN0YXRlMTIuYmFyR2FwOwogICAgICBzdGF0ZS5iYXJTaXplID0gYWN0aW9uLnBheWxvYWQuYmFyU2l6ZTsKICAgICAgc3RhdGUubWF4QmFyU2l6ZSA9IGFjdGlvbi5wYXlsb2FkLm1heEJhclNpemU7CiAgICAgIHN0YXRlLnN0YWNrT2Zmc2V0ID0gYWN0aW9uLnBheWxvYWQuc3RhY2tPZmZzZXQ7CiAgICAgIHN0YXRlLnN5bmNJZCA9IGFjdGlvbi5wYXlsb2FkLnN5bmNJZDsKICAgICAgc3RhdGUuc3luY01ldGhvZCA9IGFjdGlvbi5wYXlsb2FkLnN5bmNNZXRob2Q7CiAgICAgIHN0YXRlLmNsYXNzTmFtZSA9IGFjdGlvbi5wYXlsb2FkLmNsYXNzTmFtZTsKICAgICAgc3RhdGUuYmFzZVZhbHVlID0gYWN0aW9uLnBheWxvYWQuYmFzZVZhbHVlOwogICAgICBzdGF0ZS5yZXZlcnNlU3RhY2tPcmRlciA9IGFjdGlvbi5wYXlsb2FkLnJldmVyc2VTdGFja09yZGVyOwogICAgfQogIH0KfSk7CnZhciByb290UHJvcHNSZWR1Y2VyID0gcm9vdFByb3BzU2xpY2UucmVkdWNlcjsKdmFyIHsKICB1cGRhdGVPcHRpb25zCn0gPSByb290UHJvcHNTbGljZS5hY3Rpb25zOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvcG9sYXJPcHRpb25zU2xpY2UuanMKdmFyIHBvbGFyT3B0aW9uc1NsaWNlID0gY3JlYXRlU2xpY2UoewogIG5hbWU6ICJwb2xhck9wdGlvbnMiLAogIGluaXRpYWxTdGF0ZTogbnVsbCwKICByZWR1Y2VyczogewogICAgdXBkYXRlUG9sYXJPcHRpb25zOiAoX3N0YXRlLCBhY3Rpb24pID0+IHsKICAgICAgcmV0dXJuIGFjdGlvbi5wYXlsb2FkOwogICAgfQogIH0KfSk7CnZhciB7CiAgdXBkYXRlUG9sYXJPcHRpb25zCn0gPSBwb2xhck9wdGlvbnNTbGljZS5hY3Rpb25zOwp2YXIgcG9sYXJPcHRpb25zUmVkdWNlciA9IHBvbGFyT3B0aW9uc1NsaWNlLnJlZHVjZXI7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9rZXlib2FyZEV2ZW50c01pZGRsZXdhcmUuanMKdmFyIGtleURvd25BY3Rpb24gPSBjcmVhdGVBY3Rpb24oImtleURvd24iKTsKdmFyIGZvY3VzQWN0aW9uID0gY3JlYXRlQWN0aW9uKCJmb2N1cyIpOwp2YXIga2V5Ym9hcmRFdmVudHNNaWRkbGV3YXJlID0gY3JlYXRlTGlzdGVuZXJNaWRkbGV3YXJlKCk7CmtleWJvYXJkRXZlbnRzTWlkZGxld2FyZS5zdGFydExpc3RlbmluZyh7CiAgYWN0aW9uQ3JlYXRvcjoga2V5RG93bkFjdGlvbiwKICBlZmZlY3Q6IChhY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICB2YXIgc3RhdGUgPSBsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpOwogICAgdmFyIGFjY2Vzc2liaWxpdHlMYXllcklzQWN0aXZlID0gc3RhdGUucm9vdFByb3BzLmFjY2Vzc2liaWxpdHlMYXllciAhPT0gZmFsc2U7CiAgICBpZiAoIWFjY2Vzc2liaWxpdHlMYXllcklzQWN0aXZlKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciB7CiAgICAgIGtleWJvYXJkSW50ZXJhY3Rpb24KICAgIH0gPSBzdGF0ZS50b29sdGlwOwogICAgdmFyIGtleSA9IGFjdGlvbi5wYXlsb2FkOwogICAgaWYgKGtleSAhPT0gIkFycm93UmlnaHQiICYmIGtleSAhPT0gIkFycm93TGVmdCIgJiYga2V5ICE9PSAiRW50ZXIiKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciByZXNvbHZlZEluZGV4ID0gY29tYmluZUFjdGl2ZVRvb2x0aXBJbmRleChrZXlib2FyZEludGVyYWN0aW9uLCBzZWxlY3RUb29sdGlwRGlzcGxheWVkRGF0YShzdGF0ZSksIHNlbGVjdFRvb2x0aXBBeGlzRGF0YUtleShzdGF0ZSksIHNlbGVjdFRvb2x0aXBBeGlzRG9tYWluKHN0YXRlKSk7CiAgICB2YXIgY3VycmVudEluZGV4ID0gcmVzb2x2ZWRJbmRleCA9PSBudWxsID8gLTEgOiBOdW1iZXIocmVzb2x2ZWRJbmRleCk7CiAgICBpZiAoIU51bWJlci5pc0Zpbml0ZShjdXJyZW50SW5kZXgpIHx8IGN1cnJlbnRJbmRleCA8IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHRvb2x0aXBUaWNrcyA9IHNlbGVjdFRvb2x0aXBBeGlzVGlja3Moc3RhdGUpOwogICAgaWYgKGtleSA9PT0gIkVudGVyIikgewogICAgICB2YXIgX2Nvb3JkaW5hdGUgPSBzZWxlY3RDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4KHN0YXRlLCAiYXhpcyIsICJob3ZlciIsIFN0cmluZyhrZXlib2FyZEludGVyYWN0aW9uLmluZGV4KSk7CiAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldEtleWJvYXJkSW50ZXJhY3Rpb24oewogICAgICAgIGFjdGl2ZTogIWtleWJvYXJkSW50ZXJhY3Rpb24uYWN0aXZlLAogICAgICAgIGFjdGl2ZUluZGV4OiBrZXlib2FyZEludGVyYWN0aW9uLmluZGV4LAogICAgICAgIGFjdGl2ZURhdGFLZXk6IGtleWJvYXJkSW50ZXJhY3Rpb24uZGF0YUtleSwKICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBfY29vcmRpbmF0ZQogICAgICB9KSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciBkaXJlY3Rpb24gPSBzZWxlY3RDaGFydERpcmVjdGlvbihzdGF0ZSk7CiAgICB2YXIgZGlyZWN0aW9uTXVsdGlwbGllciA9IGRpcmVjdGlvbiA9PT0gImxlZnQtdG8tcmlnaHQiID8gMSA6IC0xOwogICAgdmFyIG1vdmVtZW50ID0ga2V5ID09PSAiQXJyb3dSaWdodCIgPyAxIDogLTE7CiAgICB2YXIgbmV4dEluZGV4ID0gY3VycmVudEluZGV4ICsgbW92ZW1lbnQgKiBkaXJlY3Rpb25NdWx0aXBsaWVyOwogICAgaWYgKHRvb2x0aXBUaWNrcyA9PSBudWxsIHx8IG5leHRJbmRleCA+PSB0b29sdGlwVGlja3MubGVuZ3RoIHx8IG5leHRJbmRleCA8IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGNvb3JkaW5hdGUgPSBzZWxlY3RDb29yZGluYXRlRm9yRGVmYXVsdEluZGV4KHN0YXRlLCAiYXhpcyIsICJob3ZlciIsIFN0cmluZyhuZXh0SW5kZXgpKTsKICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldEtleWJvYXJkSW50ZXJhY3Rpb24oewogICAgICBhY3RpdmU6IHRydWUsCiAgICAgIGFjdGl2ZUluZGV4OiBuZXh0SW5kZXgudG9TdHJpbmcoKSwKICAgICAgYWN0aXZlRGF0YUtleTogdm9pZCAwLAogICAgICBhY3RpdmVDb29yZGluYXRlOiBjb29yZGluYXRlCiAgICB9KSk7CiAgfQp9KTsKa2V5Ym9hcmRFdmVudHNNaWRkbGV3YXJlLnN0YXJ0TGlzdGVuaW5nKHsKICBhY3Rpb25DcmVhdG9yOiBmb2N1c0FjdGlvbiwKICBlZmZlY3Q6IChfYWN0aW9uLCBsaXN0ZW5lckFwaSkgPT4gewogICAgdmFyIHN0YXRlID0gbGlzdGVuZXJBcGkuZ2V0U3RhdGUoKTsKICAgIHZhciBhY2Nlc3NpYmlsaXR5TGF5ZXJJc0FjdGl2ZSA9IHN0YXRlLnJvb3RQcm9wcy5hY2Nlc3NpYmlsaXR5TGF5ZXIgIT09IGZhbHNlOwogICAgaWYgKCFhY2Nlc3NpYmlsaXR5TGF5ZXJJc0FjdGl2ZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB2YXIgewogICAgICBrZXlib2FyZEludGVyYWN0aW9uCiAgICB9ID0gc3RhdGUudG9vbHRpcDsKICAgIGlmIChrZXlib2FyZEludGVyYWN0aW9uLmFjdGl2ZSkgewogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAoa2V5Ym9hcmRJbnRlcmFjdGlvbi5pbmRleCA9PSBudWxsKSB7CiAgICAgIHZhciBuZXh0SW5kZXggPSAiMCI7CiAgICAgIHZhciBjb29yZGluYXRlID0gc2VsZWN0Q29vcmRpbmF0ZUZvckRlZmF1bHRJbmRleChzdGF0ZSwgImF4aXMiLCAiaG92ZXIiLCBTdHJpbmcobmV4dEluZGV4KSk7CiAgICAgIGxpc3RlbmVyQXBpLmRpc3BhdGNoKHNldEtleWJvYXJkSW50ZXJhY3Rpb24oewogICAgICAgIGFjdGl2ZURhdGFLZXk6IHZvaWQgMCwKICAgICAgICBhY3RpdmU6IHRydWUsCiAgICAgICAgYWN0aXZlSW5kZXg6IG5leHRJbmRleCwKICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBjb29yZGluYXRlCiAgICAgIH0pKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvZXh0ZXJuYWxFdmVudHNNaWRkbGV3YXJlLmpzCnZhciBleHRlcm5hbEV2ZW50QWN0aW9uID0gY3JlYXRlQWN0aW9uKCJleHRlcm5hbEV2ZW50Iik7CnZhciBleHRlcm5hbEV2ZW50c01pZGRsZXdhcmUgPSBjcmVhdGVMaXN0ZW5lck1pZGRsZXdhcmUoKTsKdmFyIHJhZklkTWFwID0gLyogQF9fUFVSRV9fICovIG5ldyBNYXAoKTsKZXh0ZXJuYWxFdmVudHNNaWRkbGV3YXJlLnN0YXJ0TGlzdGVuaW5nKHsKICBhY3Rpb25DcmVhdG9yOiBleHRlcm5hbEV2ZW50QWN0aW9uLAogIGVmZmVjdDogKGFjdGlvbiwgbGlzdGVuZXJBcGkpID0+IHsKICAgIHZhciB7CiAgICAgIGhhbmRsZXIsCiAgICAgIHJlYWN0RXZlbnQKICAgIH0gPSBhY3Rpb24ucGF5bG9hZDsKICAgIGlmIChoYW5kbGVyID09IG51bGwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgcmVhY3RFdmVudC5wZXJzaXN0KCk7CiAgICB2YXIgZXZlbnRUeXBlID0gcmVhY3RFdmVudC50eXBlOwogICAgdmFyIGV4aXN0aW5nUmFmSWQgPSByYWZJZE1hcC5nZXQoZXZlbnRUeXBlKTsKICAgIGlmIChleGlzdGluZ1JhZklkICE9PSB2b2lkIDApIHsKICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUoZXhpc3RpbmdSYWZJZCk7CiAgICB9CiAgICB2YXIgcmFmSWQyID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICB2YXIgc3RhdGUgPSBsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpOwogICAgICAgIHZhciBuZXh0U3RhdGUgPSB7CiAgICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBzZWxlY3RBY3RpdmVUb29sdGlwQ29vcmRpbmF0ZShzdGF0ZSksCiAgICAgICAgICBhY3RpdmVEYXRhS2V5OiBzZWxlY3RBY3RpdmVUb29sdGlwRGF0YUtleShzdGF0ZSksCiAgICAgICAgICBhY3RpdmVJbmRleDogc2VsZWN0QWN0aXZlVG9vbHRpcEluZGV4KHN0YXRlKSwKICAgICAgICAgIGFjdGl2ZUxhYmVsOiBzZWxlY3RBY3RpdmVMYWJlbChzdGF0ZSksCiAgICAgICAgICBhY3RpdmVUb29sdGlwSW5kZXg6IHNlbGVjdEFjdGl2ZVRvb2x0aXBJbmRleChzdGF0ZSksCiAgICAgICAgICBpc1Rvb2x0aXBBY3RpdmU6IHNlbGVjdElzVG9vbHRpcEFjdGl2ZShzdGF0ZSkKICAgICAgICB9OwogICAgICAgIGhhbmRsZXIobmV4dFN0YXRlLCByZWFjdEV2ZW50KTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICByYWZJZE1hcC5kZWxldGUoZXZlbnRUeXBlKTsKICAgICAgfQogICAgfSk7CiAgICByYWZJZE1hcC5zZXQoZXZlbnRUeXBlLCByYWZJZDIpOwogIH0KfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9zZWxlY3RvcnMvdG91Y2hTZWxlY3RvcnMuanMKdmFyIHNlbGVjdEFsbFRvb2x0aXBQYXlsb2FkQ29uZmlndXJhdGlvbiA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RUb29sdGlwU3RhdGVdLCAodG9vbHRpcFN0YXRlKSA9PiB0b29sdGlwU3RhdGUudG9vbHRpcEl0ZW1QYXlsb2Fkcyk7CnZhciBzZWxlY3RUb29sdGlwQ29vcmRpbmF0ZSA9IGNyZWF0ZVNlbGVjdG9yKFtzZWxlY3RBbGxUb29sdGlwUGF5bG9hZENvbmZpZ3VyYXRpb24sIHNlbGVjdFRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsIChfc3RhdGUsIHRvb2x0aXBJbmRleCwgX2RhdGFLZXkpID0+IHRvb2x0aXBJbmRleCwgKF9zdGF0ZSwgX3Rvb2x0aXBJbmRleCwgZGF0YUtleSkgPT4gZGF0YUtleV0sIChhbGxUb29sdGlwQ29uZmlndXJhdGlvbnMsIHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsIHRvb2x0aXBJbmRleCwgZGF0YUtleSkgPT4gewogIHZhciBtb3N0UmVsZXZhbnRUb29sdGlwQ29uZmlndXJhdGlvbiA9IGFsbFRvb2x0aXBDb25maWd1cmF0aW9ucy5maW5kKCh0b29sdGlwQ29uZmlndXJhdGlvbikgPT4gewogICAgcmV0dXJuIHRvb2x0aXBDb25maWd1cmF0aW9uLnNldHRpbmdzLmRhdGFLZXkgPT09IGRhdGFLZXk7CiAgfSk7CiAgaWYgKG1vc3RSZWxldmFudFRvb2x0aXBDb25maWd1cmF0aW9uID09IG51bGwpIHsKICAgIHJldHVybiB2b2lkIDA7CiAgfQogIHZhciB7CiAgICBwb3NpdGlvbnMKICB9ID0gbW9zdFJlbGV2YW50VG9vbHRpcENvbmZpZ3VyYXRpb247CiAgaWYgKHBvc2l0aW9ucyA9PSBudWxsKSB7CiAgICByZXR1cm4gdm9pZCAwOwogIH0KICB2YXIgbWF5YmVQb3NpdGlvbiA9IHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIocG9zaXRpb25zLCB0b29sdGlwSW5kZXgpOwogIHJldHVybiBtYXliZVBvc2l0aW9uOwp9KTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3N0YXRlL3RvdWNoRXZlbnRzTWlkZGxld2FyZS5qcwp2YXIgdG91Y2hFdmVudEFjdGlvbiA9IGNyZWF0ZUFjdGlvbigidG91Y2hNb3ZlIik7CnZhciB0b3VjaEV2ZW50TWlkZGxld2FyZSA9IGNyZWF0ZUxpc3RlbmVyTWlkZGxld2FyZSgpOwp0b3VjaEV2ZW50TWlkZGxld2FyZS5zdGFydExpc3RlbmluZyh7CiAgYWN0aW9uQ3JlYXRvcjogdG91Y2hFdmVudEFjdGlvbiwKICBlZmZlY3Q6IChhY3Rpb24sIGxpc3RlbmVyQXBpKSA9PiB7CiAgICB2YXIgdG91Y2hFdmVudCA9IGFjdGlvbi5wYXlsb2FkOwogICAgaWYgKHRvdWNoRXZlbnQudG91Y2hlcyA9PSBudWxsIHx8IHRvdWNoRXZlbnQudG91Y2hlcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIHN0YXRlID0gbGlzdGVuZXJBcGkuZ2V0U3RhdGUoKTsKICAgIHZhciB0b29sdGlwRXZlbnRUeXBlID0gc2VsZWN0VG9vbHRpcEV2ZW50VHlwZShzdGF0ZSwgc3RhdGUudG9vbHRpcC5zZXR0aW5ncy5zaGFyZWQpOwogICAgaWYgKHRvb2x0aXBFdmVudFR5cGUgPT09ICJheGlzIikgewogICAgICB2YXIgYWN0aXZlUHJvcHMgPSBzZWxlY3RBY3RpdmVQcm9wc0Zyb21DaGFydFBvaW50ZXIoc3RhdGUsIGdldENoYXJ0UG9pbnRlcih7CiAgICAgICAgY2xpZW50WDogdG91Y2hFdmVudC50b3VjaGVzWzBdLmNsaWVudFgsCiAgICAgICAgY2xpZW50WTogdG91Y2hFdmVudC50b3VjaGVzWzBdLmNsaWVudFksCiAgICAgICAgY3VycmVudFRhcmdldDogdG91Y2hFdmVudC5jdXJyZW50VGFyZ2V0CiAgICAgIH0pKTsKICAgICAgaWYgKChhY3RpdmVQcm9wcyA9PT0gbnVsbCB8fCBhY3RpdmVQcm9wcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYWN0aXZlUHJvcHMuYWN0aXZlSW5kZXgpICE9IG51bGwpIHsKICAgICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChzZXRNb3VzZU92ZXJBeGlzSW5kZXgoewogICAgICAgICAgYWN0aXZlSW5kZXg6IGFjdGl2ZVByb3BzLmFjdGl2ZUluZGV4LAogICAgICAgICAgYWN0aXZlRGF0YUtleTogdm9pZCAwLAogICAgICAgICAgYWN0aXZlQ29vcmRpbmF0ZTogYWN0aXZlUHJvcHMuYWN0aXZlQ29vcmRpbmF0ZQogICAgICAgIH0pKTsKICAgICAgfQogICAgfSBlbHNlIGlmICh0b29sdGlwRXZlbnRUeXBlID09PSAiaXRlbSIpIHsKICAgICAgdmFyIF90YXJnZXQkZ2V0QXR0cmlidXRlOwogICAgICB2YXIgdG91Y2ggPSB0b3VjaEV2ZW50LnRvdWNoZXNbMF07CiAgICAgIGlmIChkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50ID09IG51bGwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFyIHRhcmdldCA9IGRvY3VtZW50LmVsZW1lbnRGcm9tUG9pbnQodG91Y2guY2xpZW50WCwgdG91Y2guY2xpZW50WSk7CiAgICAgIGlmICghdGFyZ2V0IHx8ICF0YXJnZXQuZ2V0QXR0cmlidXRlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHZhciBpdGVtSW5kZXggPSB0YXJnZXQuZ2V0QXR0cmlidXRlKERBVEFfSVRFTV9JTkRFWF9BVFRSSUJVVEVfTkFNRSk7CiAgICAgIHZhciBkYXRhS2V5ID0gKF90YXJnZXQkZ2V0QXR0cmlidXRlID0gdGFyZ2V0LmdldEF0dHJpYnV0ZShEQVRBX0lURU1fREFUQUtFWV9BVFRSSUJVVEVfTkFNRSkpICE9PSBudWxsICYmIF90YXJnZXQkZ2V0QXR0cmlidXRlICE9PSB2b2lkIDAgPyBfdGFyZ2V0JGdldEF0dHJpYnV0ZSA6IHZvaWQgMDsKICAgICAgdmFyIGNvb3JkaW5hdGUgPSBzZWxlY3RUb29sdGlwQ29vcmRpbmF0ZShsaXN0ZW5lckFwaS5nZXRTdGF0ZSgpLCBpdGVtSW5kZXgsIGRhdGFLZXkpOwogICAgICBsaXN0ZW5lckFwaS5kaXNwYXRjaChzZXRBY3RpdmVNb3VzZU92ZXJJdGVtSW5kZXgoewogICAgICAgIGFjdGl2ZURhdGFLZXk6IGRhdGFLZXksCiAgICAgICAgYWN0aXZlSW5kZXg6IGl0ZW1JbmRleCwKICAgICAgICBhY3RpdmVDb29yZGluYXRlOiBjb29yZGluYXRlCiAgICAgIH0pKTsKICAgIH0KICB9Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvc3RvcmUuanMKdmFyIHJvb3RSZWR1Y2VyID0gY29tYmluZVJlZHVjZXJzKHsKICBicnVzaDogYnJ1c2hSZWR1Y2VyLAogIGNhcnRlc2lhbkF4aXM6IGNhcnRlc2lhbkF4aXNSZWR1Y2VyLAogIGNoYXJ0RGF0YTogY2hhcnREYXRhUmVkdWNlciwKICBlcnJvckJhcnM6IGVycm9yQmFyUmVkdWNlciwKICBncmFwaGljYWxJdGVtczogZ3JhcGhpY2FsSXRlbXNSZWR1Y2VyLAogIGxheW91dDogY2hhcnRMYXlvdXRSZWR1Y2VyLAogIGxlZ2VuZDogbGVnZW5kUmVkdWNlciwKICBvcHRpb25zOiBvcHRpb25zUmVkdWNlciwKICBwb2xhckF4aXM6IHBvbGFyQXhpc1JlZHVjZXIsCiAgcG9sYXJPcHRpb25zOiBwb2xhck9wdGlvbnNSZWR1Y2VyLAogIHJlZmVyZW5jZUVsZW1lbnRzOiByZWZlcmVuY2VFbGVtZW50c1JlZHVjZXIsCiAgcm9vdFByb3BzOiByb290UHJvcHNSZWR1Y2VyLAogIHRvb2x0aXA6IHRvb2x0aXBSZWR1Y2VyLAogIHpJbmRleDogekluZGV4UmVkdWNlcgp9KTsKdmFyIGNyZWF0ZVJlY2hhcnRzU3RvcmUgPSBmdW5jdGlvbiBjcmVhdGVSZWNoYXJ0c1N0b3JlMihwcmVsb2FkZWRTdGF0ZSkgewogIHZhciBjaGFydE5hbWUgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHZvaWQgMCA/IGFyZ3VtZW50c1sxXSA6ICJDaGFydCI7CiAgcmV0dXJuIGNvbmZpZ3VyZVN0b3JlKHsKICAgIHJlZHVjZXI6IHJvb3RSZWR1Y2VyLAogICAgLy8gcmVkdXgtdG9vbGtpdCB2MSB0eXBlcyBhcmUgdW5oYXBweSB3aXRoIHRoZSBwcmVsb2FkZWRTdGF0ZSB0eXBlLiBSZW1vdmUgdGhlIGBhcyBhbnlgIHdoZW4gYnVtcGluZyB0byB2MgogICAgcHJlbG9hZGVkU3RhdGUsCiAgICAvLyBAdHMtZXhwZWN0LWVycm9yIHJlZHV4LXRvb2xraXQgdjEgdHlwZXMgYXJlIHVuaGFwcHkgd2l0aCB0aGUgbWlkZGxld2FyZSBhcnJheS4gUmVtb3ZlIHRoaXMgY29tbWVudCB3aGVuIGJ1bXBpbmcgdG8gdjIKICAgIG1pZGRsZXdhcmU6IChnZXREZWZhdWx0TWlkZGxld2FyZSkgPT4gewogICAgICB2YXIgX3Byb2Nlc3MkZW52JE5PREVfRU5WOwogICAgICByZXR1cm4gZ2V0RGVmYXVsdE1pZGRsZXdhcmUoewogICAgICAgIHNlcmlhbGl6YWJsZUNoZWNrOiBmYWxzZSwKICAgICAgICBpbW11dGFibGVDaGVjazogIVsiY29tbW9uanMiLCAiZXM2IiwgInByb2R1Y3Rpb24iXS5pbmNsdWRlcygoX3Byb2Nlc3MkZW52JE5PREVfRU5WID0gImVzNiIpICE9PSBudWxsICYmIF9wcm9jZXNzJGVudiROT0RFX0VOViAhPT0gdm9pZCAwID8gX3Byb2Nlc3MkZW52JE5PREVfRU5WIDogIiIpCiAgICAgIH0pLmNvbmNhdChbbW91c2VDbGlja01pZGRsZXdhcmUubWlkZGxld2FyZSwgbW91c2VNb3ZlTWlkZGxld2FyZS5taWRkbGV3YXJlLCBrZXlib2FyZEV2ZW50c01pZGRsZXdhcmUubWlkZGxld2FyZSwgZXh0ZXJuYWxFdmVudHNNaWRkbGV3YXJlLm1pZGRsZXdhcmUsIHRvdWNoRXZlbnRNaWRkbGV3YXJlLm1pZGRsZXdhcmVdKTsKICAgIH0sCiAgICAvKgogICAgICogSSBjYW4ndCBmaW5kIG91dCBob3cgdG8gc2F0aXNmeSB0eXBlc2NyaXB0IGhlcmUuCiAgICAgKiBXZSByZXR1cm4gYEVuaGFuY2VyQXJyYXk8W1N0b3JlRW5oYW5jZXI8e30sIHt9PiwgU3RvcmVFbmhhbmNlcl0+YCBmcm9tIHRoaXMgZnVuY3Rpb24sCiAgICAgKiBidXQgdGhlIHR5cGVzIHNheSB3ZSBzaG91bGQgcmV0dXJuIGBFbmhhbmNlckFycmF5PFN0b3JlRW5oYW5jZXI8e30sIHt9PmAuCiAgICAgKiBMb29rcyBsaWtlIGl0J3MgYmFkbHkgaW5mZXJyZWQgZ2VuZXJpY3MsIGJ1dCBpdCB3b24ndCBhbGxvdyBtZSB0byBwcm92aWRlIHRoZSBjb3JyZWN0IHR5cGUgbWFudWFsbHkgZWl0aGVyLgogICAgICogU28gbGV0J3MganVzdCBpZ25vcmUgdGhlIGVycm9yIGZvciBub3cuCiAgICAgKi8KICAgIC8vIEB0cy1leHBlY3QtZXJyb3IgbWlzbWF0Y2hlZCBnZW5lcmljcwogICAgZW5oYW5jZXJzOiAoZ2V0RGVmYXVsdEVuaGFuY2VycykgPT4gewogICAgICB2YXIgZW5oYW5jZXJzID0gZ2V0RGVmYXVsdEVuaGFuY2VyczsKICAgICAgaWYgKHR5cGVvZiBnZXREZWZhdWx0RW5oYW5jZXJzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgZW5oYW5jZXJzID0gZ2V0RGVmYXVsdEVuaGFuY2VycygpOwogICAgICB9CiAgICAgIHJldHVybiBlbmhhbmNlcnMuY29uY2F0KGF1dG9CYXRjaEVuaGFuY2VyKHsKICAgICAgICB0eXBlOiAicmFmIgogICAgICB9KSk7CiAgICB9LAogICAgZGV2VG9vbHM6IEdsb2JhbC5kZXZUb29sc0VuYWJsZWQgJiYgewogICAgICBzZXJpYWxpemU6IHsKICAgICAgICByZXBsYWNlcjogcmVkdXhEZXZ0b29sc0pzb25TdHJpbmdpZnlSZXBsYWNlcgogICAgICB9LAogICAgICBuYW1lOiAicmVjaGFydHMtIi5jb25jYXQoY2hhcnROYW1lKQogICAgfQogIH0pOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvUmVjaGFydHNTdG9yZVByb3ZpZGVyLmpzCmZ1bmN0aW9uIFJlY2hhcnRzU3RvcmVQcm92aWRlcihfcmVmMikgewogIHZhciB7CiAgICBwcmVsb2FkZWRTdGF0ZSwKICAgIGNoaWxkcmVuLAogICAgcmVkdXhTdG9yZU5hbWUKICB9ID0gX3JlZjI7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgdmFyIHN0b3JlUmVmID0gKDAsIGltcG9ydF9yZWFjdDQxLnVzZVJlZikobnVsbCk7CiAgaWYgKGlzUGFub3JhbWEpIHsKICAgIHJldHVybiBjaGlsZHJlbjsKICB9CiAgaWYgKHN0b3JlUmVmLmN1cnJlbnQgPT0gbnVsbCkgewogICAgc3RvcmVSZWYuY3VycmVudCA9IGNyZWF0ZVJlY2hhcnRzU3RvcmUocHJlbG9hZGVkU3RhdGUsIHJlZHV4U3RvcmVOYW1lKTsKICB9CiAgdmFyIG5vbk51bGxDb250ZXh0ID0gUmVjaGFydHNSZWR1eENvbnRleHQ7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDI5LmNyZWF0ZUVsZW1lbnQoUHJvdmlkZXJfZGVmYXVsdCwgewogICAgY29udGV4dDogbm9uTnVsbENvbnRleHQsCiAgICBzdG9yZTogc3RvcmVSZWYuY3VycmVudAogIH0sIGNoaWxkcmVuKTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvc3RhdGUvUmVwb3J0TWFpbkNoYXJ0UHJvcHMuanMKdmFyIGltcG9ydF9yZWFjdDQyID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiBSZXBvcnRNYWluQ2hhcnRQcm9wc0ltcGwoX3JlZjIpIHsKICB2YXIgewogICAgbGF5b3V0LAogICAgbWFyZ2luCiAgfSA9IF9yZWYyOwogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgdmFyIGlzUGFub3JhbWEgPSB1c2VJc1Bhbm9yYW1hKCk7CiAgKDAsIGltcG9ydF9yZWFjdDQyLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFpc1Bhbm9yYW1hKSB7CiAgICAgIGRpc3BhdGNoKHNldExheW91dChsYXlvdXQpKTsKICAgICAgZGlzcGF0Y2goc2V0TWFyZ2luKG1hcmdpbikpOwogICAgfQogIH0sIFtkaXNwYXRjaCwgaXNQYW5vcmFtYSwgbGF5b3V0LCBtYXJnaW5dKTsKICByZXR1cm4gbnVsbDsKfQp2YXIgUmVwb3J0TWFpbkNoYXJ0UHJvcHMgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQyLm1lbW8pKFJlcG9ydE1haW5DaGFydFByb3BzSW1wbCwgcHJvcHNBcmVFcXVhbCk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9zdGF0ZS9SZXBvcnRDaGFydFByb3BzLmpzCnZhciBpbXBvcnRfcmVhY3Q0MyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKZnVuY3Rpb24gUmVwb3J0Q2hhcnRQcm9wcyhwcm9wcykgewogIHZhciBkaXNwYXRjaCA9IHVzZUFwcERpc3BhdGNoKCk7CiAgKDAsIGltcG9ydF9yZWFjdDQzLnVzZUVmZmVjdCkoKCkgPT4gewogICAgZGlzcGF0Y2godXBkYXRlT3B0aW9ucyhwcm9wcykpOwogIH0sIFtkaXNwYXRjaCwgcHJvcHNdKTsKICByZXR1cm4gbnVsbDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvQ2F0ZWdvcmljYWxDaGFydC5qcwp2YXIgUmVhY3QzMyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGltcG9ydF9yZWFjdDQ4ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY29udGFpbmVyL1Jvb3RTdXJmYWNlLmpzCnZhciBSZWFjdDMxID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NDUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi96SW5kZXgvWkluZGV4UG9ydGFsLmpzCnZhciBSZWFjdDMwID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwp2YXIgaW1wb3J0X3JlYWN0NDQgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CmZ1bmN0aW9uIFpJbmRleFN2Z1BvcnRhbChfcmVmMikgewogIHZhciB7CiAgICB6SW5kZXgsCiAgICBpc1Bhbm9yYW1hCiAgfSA9IF9yZWYyOwogIHZhciBwcmVmaXggPSBpc1Bhbm9yYW1hID8gInJlY2hhcnRzLXppbmRleC1wYW5vcmFtYS0iIDogInJlY2hhcnRzLXppbmRleC0iOwogIHZhciBwb3J0YWxJZCA9IHVzZVVuaXF1ZUlkKCIiLmNvbmNhdChwcmVmaXgpLmNvbmNhdCh6SW5kZXgpKTsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogICgwLCBpbXBvcnRfcmVhY3Q0NC51c2VMYXlvdXRFZmZlY3QpKCgpID0+IHsKICAgIGRpc3BhdGNoKHJlZ2lzdGVyWkluZGV4UG9ydGFsSWQoewogICAgICB6SW5kZXgsCiAgICAgIGVsZW1lbnRJZDogcG9ydGFsSWQsCiAgICAgIGlzUGFub3JhbWEKICAgIH0pKTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIGRpc3BhdGNoKHVucmVnaXN0ZXJaSW5kZXhQb3J0YWxJZCh7CiAgICAgICAgekluZGV4LAogICAgICAgIGlzUGFub3JhbWEKICAgICAgfSkpOwogICAgfTsKICB9LCBbZGlzcGF0Y2gsIHpJbmRleCwgcG9ydGFsSWQsIGlzUGFub3JhbWFdKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudCgiZyIsIHsKICAgIHRhYkluZGV4OiAtMSwKICAgIGlkOiBwb3J0YWxJZAogIH0pOwp9CmZ1bmN0aW9uIEFsbFpJbmRleFBvcnRhbHMoX3JlZjIpIHsKICB2YXIgewogICAgY2hpbGRyZW4sCiAgICBpc1Bhbm9yYW1hCiAgfSA9IF9yZWYyOwogIHZhciBhbGxSZWdpc3RlcmVkWkluZGV4ZXMgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RBbGxSZWdpc3RlcmVkWkluZGV4ZXMpOwogIGlmICghYWxsUmVnaXN0ZXJlZFpJbmRleGVzIHx8IGFsbFJlZ2lzdGVyZWRaSW5kZXhlcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiBjaGlsZHJlbjsKICB9CiAgdmFyIGFsbE5lZ2F0aXZlWkluZGV4ZXMgPSBhbGxSZWdpc3RlcmVkWkluZGV4ZXMuZmlsdGVyKCh6SW5kZXgpID0+IHpJbmRleCA8IDApOwogIHZhciBhbGxQb3NpdGl2ZVpJbmRleGVzID0gYWxsUmVnaXN0ZXJlZFpJbmRleGVzLmZpbHRlcigoekluZGV4KSA9PiB6SW5kZXggPiAwKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChSZWFjdDMwLkZyYWdtZW50LCBudWxsLCBhbGxOZWdhdGl2ZVpJbmRleGVzLm1hcCgoekluZGV4KSA9PiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMC5jcmVhdGVFbGVtZW50KFpJbmRleFN2Z1BvcnRhbCwgewogICAga2V5OiB6SW5kZXgsCiAgICB6SW5kZXgsCiAgICBpc1Bhbm9yYW1hCiAgfSkpLCBjaGlsZHJlbiwgYWxsUG9zaXRpdmVaSW5kZXhlcy5tYXAoKHpJbmRleCkgPT4gLyogQF9fUFVSRV9fICovIFJlYWN0MzAuY3JlYXRlRWxlbWVudChaSW5kZXhTdmdQb3J0YWwsIHsKICAgIGtleTogekluZGV4LAogICAgekluZGV4LAogICAgaXNQYW5vcmFtYQogIH0pKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L2NvbnRhaW5lci9Sb290U3VyZmFjZS5qcwp2YXIgX2V4Y2x1ZGVkMTYgPSBbImNoaWxkcmVuIl07CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllczE2KGUsIHQpIHsKICBpZiAobnVsbCA9PSBlKSByZXR1cm4ge307CiAgdmFyIG8sIHIyLCBpID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxNihlLCB0KTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG4gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgZm9yIChyMiA9IDA7IHIyIDwgbi5sZW5ndGg7IHIyKyspIG8gPSBuW3IyXSwgLTEgPT09IHQuaW5kZXhPZihvKSAmJiB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZS5jYWxsKGUsIG8pICYmIChpW29dID0gZVtvXSk7CiAgfQogIHJldHVybiBpOwp9CmZ1bmN0aW9uIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMTYocjIsIGUpIHsKICBpZiAobnVsbCA9PSByMikgcmV0dXJuIHt9OwogIHZhciB0ID0ge307CiAgZm9yICh2YXIgbiBpbiByMikgaWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwocjIsIG4pKSB7CiAgICBpZiAoLTEgIT09IGUuaW5kZXhPZihuKSkgY29udGludWU7CiAgICB0W25dID0gcjJbbl07CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9leHRlbmRzMjAoKSB7CiAgcmV0dXJuIF9leHRlbmRzMjAgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczIwLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KdmFyIEZVTExfV0lEVEhfQU5EX0hFSUdIVCA9IHsKICB3aWR0aDogIjEwMCUiLAogIGhlaWdodDogIjEwMCUiLAogIC8qCiAgICogZGlzcGxheTogYmxvY2sgaXMgbmVjZXNzYXJ5IGhlcmUgYmVjYXVzZSB0aGUgZGVmYXVsdCBmb3IgYW4gU1ZHIGlzIGRpc3BsYXk6IGlubGluZSwKICAgKiB3aGljaCBpbiBzb21lIGJyb3dzZXJzIChDaHJvbWUpIGFkZHMgYSBsaXR0bGUgYml0IG9mIGV4dHJhIHNwYWNlIGFib3ZlIGFuZCBiZWxvdyB0aGUgU1ZHCiAgICogdG8gbWFrZSBzcGFjZSBmb3IgdGhlIGRlc2NlbmRlciBvZiBsZXR0ZXJzIGxpa2UgImciIGFuZCAieSIuIFRoaXMgdGhyb3dzIG9mZiB0aGUgaGVpZ2h0IGNhbGN1bGF0aW9uCiAgICogYW5kIGNhdXNlcyB0aGUgY29udGFpbmVyIHRvIGdyb3cgaW5kZWZpbml0ZWx5IG9uIGVhY2ggcmVuZGVyIHdpdGggcmVzcG9uc2l2ZT10cnVlLgogICAqIERpc3BsYXk6IGJsb2NrIHJlbW92ZXMgdGhhdCBleHRyYSBzcGFjZS4KICAgKgogICAqIEludGVyZXN0aW5nbHksIEZpcmVmb3ggZG9lcyBub3QgaGF2ZSB0aGlzIHByb2JsZW0sIGJ1dCBpdCBkb2Vzbid0IGh1cnQgdG8gYWRkIHRoZSBzdHlsZSBhbnl3YXkuCiAgICovCiAgZGlzcGxheTogImJsb2NrIgp9Owp2YXIgTWFpbkNoYXJ0U3VyZmFjZSA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDUuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgd2lkdGggPSB1c2VDaGFydFdpZHRoKCk7CiAgdmFyIGhlaWdodCA9IHVzZUNoYXJ0SGVpZ2h0KCk7CiAgdmFyIGhhc0FjY2Vzc2liaWxpdHlMYXllciA9IHVzZUFjY2Vzc2liaWxpdHlMYXllcigpOwogIGlmICghaXNQb3NpdGl2ZU51bWJlcih3aWR0aCkgfHwgIWlzUG9zaXRpdmVOdW1iZXIoaGVpZ2h0KSkgewogICAgcmV0dXJuIG51bGw7CiAgfQogIHZhciB7CiAgICBjaGlsZHJlbiwKICAgIG90aGVyQXR0cmlidXRlcywKICAgIHRpdGxlLAogICAgZGVzYwogIH0gPSBwcm9wczsKICB2YXIgdGFiSW5kZXgsIHJvbGU7CiAgaWYgKG90aGVyQXR0cmlidXRlcyAhPSBudWxsKSB7CiAgICBpZiAodHlwZW9mIG90aGVyQXR0cmlidXRlcy50YWJJbmRleCA9PT0gIm51bWJlciIpIHsKICAgICAgdGFiSW5kZXggPSBvdGhlckF0dHJpYnV0ZXMudGFiSW5kZXg7CiAgICB9IGVsc2UgewogICAgICB0YWJJbmRleCA9IGhhc0FjY2Vzc2liaWxpdHlMYXllciA/IDAgOiB2b2lkIDA7CiAgICB9CiAgICBpZiAodHlwZW9mIG90aGVyQXR0cmlidXRlcy5yb2xlID09PSAic3RyaW5nIikgewogICAgICByb2xlID0gb3RoZXJBdHRyaWJ1dGVzLnJvbGU7CiAgICB9IGVsc2UgewogICAgICByb2xlID0gaGFzQWNjZXNzaWJpbGl0eUxheWVyID8gImFwcGxpY2F0aW9uIiA6IHZvaWQgMDsKICAgIH0KICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMxLmNyZWF0ZUVsZW1lbnQoU3VyZmFjZSwgX2V4dGVuZHMyMCh7fSwgb3RoZXJBdHRyaWJ1dGVzLCB7CiAgICB0aXRsZSwKICAgIGRlc2MsCiAgICByb2xlLAogICAgdGFiSW5kZXgsCiAgICB3aWR0aCwKICAgIGhlaWdodCwKICAgIHN0eWxlOiBGVUxMX1dJRFRIX0FORF9IRUlHSFQsCiAgICByZWYKICB9KSwgY2hpbGRyZW4pOwp9KTsKdmFyIEJydXNoUGFub3JhbWFTdXJmYWNlID0gKF9yZWYyKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyOwogIHZhciBicnVzaERpbWVuc2lvbnMgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RCcnVzaERpbWVuc2lvbnMpOwogIGlmICghYnJ1c2hEaW1lbnNpb25zKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgeTogeTIsCiAgICB4OiB4MgogIH0gPSBicnVzaERpbWVuc2lvbnM7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMxLmNyZWF0ZUVsZW1lbnQoU3VyZmFjZSwgewogICAgd2lkdGgsCiAgICBoZWlnaHQsCiAgICB4OiB4MiwKICAgIHk6IHkyCiAgfSwgY2hpbGRyZW4pOwp9Owp2YXIgUm9vdFN1cmZhY2UgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ1LmZvcndhcmRSZWYpKChfcmVmMiwgcmVmKSA9PiB7CiAgdmFyIHsKICAgIGNoaWxkcmVuCiAgfSA9IF9yZWYyLCByZXN0ID0gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTYoX3JlZjIsIF9leGNsdWRlZDE2KTsKICB2YXIgaXNQYW5vcmFtYSA9IHVzZUlzUGFub3JhbWEoKTsKICBpZiAoaXNQYW5vcmFtYSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMxLmNyZWF0ZUVsZW1lbnQoQnJ1c2hQYW5vcmFtYVN1cmZhY2UsIG51bGwsIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMxLmNyZWF0ZUVsZW1lbnQoQWxsWkluZGV4UG9ydGFscywgewogICAgICBpc1Bhbm9yYW1hOiB0cnVlCiAgICB9LCBjaGlsZHJlbikpOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzEuY3JlYXRlRWxlbWVudChNYWluQ2hhcnRTdXJmYWNlLCBfZXh0ZW5kczIwKHsKICAgIHJlZgogIH0sIHJlc3QpLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMS5jcmVhdGVFbGVtZW50KEFsbFpJbmRleFBvcnRhbHMsIHsKICAgIGlzUGFub3JhbWE6IGZhbHNlCiAgfSwgY2hpbGRyZW4pKTsKfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9SZWNoYXJ0c1dyYXBwZXIuanMKdmFyIFJlYWN0MzIgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q0NyA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9yZWNoYXJ0c0AzLjUuMV9AdHlwZXMrcmVhY3RAMTguMy4yN19yZWFjdC1kb21AMTguMy4xX3JlYWN0QDE4LjMuMV9fcmVhY3QtaXNAMTkuMi4wX3JlYWN0QDE4LjMuMV9yZWR1eEA1LjAuMS9ub2RlX21vZHVsZXMvcmVjaGFydHMvZXM2L3V0aWwvdXNlUmVwb3J0U2NhbGUuanMKdmFyIGltcG9ydF9yZWFjdDQ2ID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCkpOwpmdW5jdGlvbiB1c2VSZXBvcnRTY2FsZSgpIHsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBbcmVmLCBzZXRSZWZdID0gKDAsIGltcG9ydF9yZWFjdDQ2LnVzZVN0YXRlKShudWxsKTsKICB2YXIgc2NhbGUgPSB1c2VBcHBTZWxlY3RvcihzZWxlY3RDb250YWluZXJTY2FsZSk7CiAgKDAsIGltcG9ydF9yZWFjdDQ2LnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKHJlZiA9PSBudWxsKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHZhciByZWN0ID0gcmVmLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgdmFyIG5ld1NjYWxlID0gcmVjdC53aWR0aCAvIHJlZi5vZmZzZXRXaWR0aDsKICAgIGlmIChpc1dlbGxCZWhhdmVkTnVtYmVyKG5ld1NjYWxlKSAmJiBuZXdTY2FsZSAhPT0gc2NhbGUpIHsKICAgICAgZGlzcGF0Y2goc2V0U2NhbGUobmV3U2NhbGUpKTsKICAgIH0KICB9LCBbcmVmLCBkaXNwYXRjaCwgc2NhbGVdKTsKICByZXR1cm4gc2V0UmVmOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9SZWNoYXJ0c1dyYXBwZXIuanMKZnVuY3Rpb24gb3duS2V5czMxKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyMykgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByMykuZW51bWVyYWJsZTsKICAgIH0pKSwgdC5wdXNoLmFwcGx5KHQsIG8pOwogIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfb2JqZWN0U3ByZWFkMzEoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMzMShPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ocjMpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MzMoZSwgcjMsIHRbcjNdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMzEoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIzKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMywgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0LCByMykpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTMzKGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IF90b1Byb3BlcnR5S2V5MzMocjIpKSBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHIyLCB7IHZhbHVlOiB0LCBlbnVtZXJhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUsIHdyaXRhYmxlOiB0cnVlIH0pIDogZVtyMl0gPSB0LCBlOwp9CmZ1bmN0aW9uIF90b1Byb3BlcnR5S2V5MzModCkgewogIHZhciBpID0gX3RvUHJpbWl0aXZlMzModCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSB0eXBlb2YgaSA/IGkgOiBpICsgIiI7Cn0KZnVuY3Rpb24gX3RvUHJpbWl0aXZlMzModCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIHQgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gdHlwZW9mIGkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIF9leHRlbmRzMjEoKSB7CiAgcmV0dXJuIF9leHRlbmRzMjEgPSBPYmplY3QuYXNzaWduID8gT2JqZWN0LmFzc2lnbi5iaW5kKCkgOiBmdW5jdGlvbihuKSB7CiAgICBmb3IgKHZhciBlID0gMTsgZSA8IGFyZ3VtZW50cy5sZW5ndGg7IGUrKykgewogICAgICB2YXIgdCA9IGFyZ3VtZW50c1tlXTsKICAgICAgZm9yICh2YXIgcjIgaW4gdCkgKHt9KS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHQsIHIyKSAmJiAobltyMl0gPSB0W3IyXSk7CiAgICB9CiAgICByZXR1cm4gbjsKICB9LCBfZXh0ZW5kczIxLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7Cn0KdmFyIEV2ZW50U3luY2hyb25pemVyID0gKCkgPT4gewogIHVzZVN5bmNocm9uaXNlZEV2ZW50c0Zyb21PdGhlckNoYXJ0cygpOwogIHJldHVybiBudWxsOwp9OwpmdW5jdGlvbiBnZXROdW1iZXJPclplcm8odmFsdWUpIHsKICBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIikgewogICAgcmV0dXJuIHZhbHVlOwogIH0KICBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgewogICAgdmFyIHBhcnNlZCA9IHBhcnNlRmxvYXQodmFsdWUpOwogICAgaWYgKCFOdW1iZXIuaXNOYU4ocGFyc2VkKSkgewogICAgICByZXR1cm4gcGFyc2VkOwogICAgfQogIH0KICByZXR1cm4gMDsKfQp2YXIgUmVzcG9uc2l2ZURpdiA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDcuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgX3Byb3BzJHN0eWxlLCBfcHJvcHMkc3R5bGUyOwogIHZhciBvYnNlcnZlclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VSZWYpKG51bGwpOwogIHZhciBbc2l6ZXMsIHNldFNpemVzXSA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VTdGF0ZSkoewogICAgY29udGFpbmVyV2lkdGg6IGdldE51bWJlck9yWmVybygoX3Byb3BzJHN0eWxlID0gcHJvcHMuc3R5bGUpID09PSBudWxsIHx8IF9wcm9wcyRzdHlsZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3Byb3BzJHN0eWxlLndpZHRoKSwKICAgIGNvbnRhaW5lckhlaWdodDogZ2V0TnVtYmVyT3JaZXJvKChfcHJvcHMkc3R5bGUyID0gcHJvcHMuc3R5bGUpID09PSBudWxsIHx8IF9wcm9wcyRzdHlsZTIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9wcm9wcyRzdHlsZTIuaGVpZ2h0KQogIH0pOwogIHZhciBzZXRDb250YWluZXJTaXplID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgobmV3V2lkdGgsIG5ld0hlaWdodCkgPT4gewogICAgc2V0U2l6ZXMoKHByZXZTdGF0ZSkgPT4gewogICAgICB2YXIgcm91bmRlZFdpZHRoID0gTWF0aC5yb3VuZChuZXdXaWR0aCk7CiAgICAgIHZhciByb3VuZGVkSGVpZ2h0ID0gTWF0aC5yb3VuZChuZXdIZWlnaHQpOwogICAgICBpZiAocHJldlN0YXRlLmNvbnRhaW5lcldpZHRoID09PSByb3VuZGVkV2lkdGggJiYgcHJldlN0YXRlLmNvbnRhaW5lckhlaWdodCA9PT0gcm91bmRlZEhlaWdodCkgewogICAgICAgIHJldHVybiBwcmV2U3RhdGU7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBjb250YWluZXJXaWR0aDogcm91bmRlZFdpZHRoLAogICAgICAgIGNvbnRhaW5lckhlaWdodDogcm91bmRlZEhlaWdodAogICAgICB9OwogICAgfSk7CiAgfSwgW10pOwogIHZhciBpbm5lclJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKG5vZGUpID0+IHsKICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJlZihub2RlKTsKICAgIH0KICAgIGlmIChub2RlICE9IG51bGwgJiYgdHlwZW9mIFJlc2l6ZU9ic2VydmVyICE9PSAidW5kZWZpbmVkIikgewogICAgICB2YXIgewogICAgICAgIHdpZHRoOiBjb250YWluZXJXaWR0aCwKICAgICAgICBoZWlnaHQ6IGNvbnRhaW5lckhlaWdodAogICAgICB9ID0gbm9kZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgc2V0Q29udGFpbmVyU2l6ZShjb250YWluZXJXaWR0aCwgY29udGFpbmVySGVpZ2h0KTsKICAgICAgdmFyIGNhbGxiYWNrID0gKGVudHJpZXMpID0+IHsKICAgICAgICB2YXIgewogICAgICAgICAgd2lkdGgsCiAgICAgICAgICBoZWlnaHQKICAgICAgICB9ID0gZW50cmllc1swXS5jb250ZW50UmVjdDsKICAgICAgICBzZXRDb250YWluZXJTaXplKHdpZHRoLCBoZWlnaHQpOwogICAgICB9OwogICAgICB2YXIgb2JzZXJ2ZXIgPSBuZXcgUmVzaXplT2JzZXJ2ZXIoY2FsbGJhY2spOwogICAgICBvYnNlcnZlci5vYnNlcnZlKG5vZGUpOwogICAgICBvYnNlcnZlclJlZi5jdXJyZW50ID0gb2JzZXJ2ZXI7CiAgICB9CiAgfSwgW3JlZiwgc2V0Q29udGFpbmVyU2l6ZV0pOwogICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VFZmZlY3QpKCgpID0+IHsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHZhciBvYnNlcnZlciA9IG9ic2VydmVyUmVmLmN1cnJlbnQ7CiAgICAgIGlmIChvYnNlcnZlciAhPSBudWxsKSB7CiAgICAgICAgb2JzZXJ2ZXIuZGlzY29ubmVjdCgpOwogICAgICB9CiAgICB9OwogIH0sIFtzZXRDb250YWluZXJTaXplXSk7CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoUmVhY3QzMi5GcmFnbWVudCwgbnVsbCwgLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChSZXBvcnRDaGFydFNpemUsIHsKICAgIHdpZHRoOiBzaXplcy5jb250YWluZXJXaWR0aCwKICAgIGhlaWdodDogc2l6ZXMuY29udGFpbmVySGVpZ2h0CiAgfSksIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoImRpdiIsIF9leHRlbmRzMjEoewogICAgcmVmOiBpbm5lclJlZgogIH0sIHByb3BzKSkpOwp9KTsKdmFyIFJlYWRTaXplT25jZURpdiA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NDcuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICB2YXIgewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9ID0gcHJvcHM7CiAgdmFyIFtzaXplcywgc2V0U2l6ZXNdID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZVN0YXRlKSh7CiAgICBjb250YWluZXJXaWR0aDogZ2V0TnVtYmVyT3JaZXJvKHdpZHRoKSwKICAgIGNvbnRhaW5lckhlaWdodDogZ2V0TnVtYmVyT3JaZXJvKGhlaWdodCkKICB9KTsKICB2YXIgc2V0Q29udGFpbmVyU2l6ZSA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKG5ld1dpZHRoLCBuZXdIZWlnaHQpID0+IHsKICAgIHNldFNpemVzKChwcmV2U3RhdGUpID0+IHsKICAgICAgdmFyIHJvdW5kZWRXaWR0aCA9IE1hdGgucm91bmQobmV3V2lkdGgpOwogICAgICB2YXIgcm91bmRlZEhlaWdodCA9IE1hdGgucm91bmQobmV3SGVpZ2h0KTsKICAgICAgaWYgKHByZXZTdGF0ZS5jb250YWluZXJXaWR0aCA9PT0gcm91bmRlZFdpZHRoICYmIHByZXZTdGF0ZS5jb250YWluZXJIZWlnaHQgPT09IHJvdW5kZWRIZWlnaHQpIHsKICAgICAgICByZXR1cm4gcHJldlN0YXRlOwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgY29udGFpbmVyV2lkdGg6IHJvdW5kZWRXaWR0aCwKICAgICAgICBjb250YWluZXJIZWlnaHQ6IHJvdW5kZWRIZWlnaHQKICAgICAgfTsKICAgIH0pOwogIH0sIFtdKTsKICB2YXIgaW5uZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChub2RlKSA9PiB7CiAgICBpZiAodHlwZW9mIHJlZiA9PT0gImZ1bmN0aW9uIikgewogICAgICByZWYobm9kZSk7CiAgICB9CiAgICBpZiAobm9kZSAhPSBudWxsKSB7CiAgICAgIHZhciB7CiAgICAgICAgd2lkdGg6IGNvbnRhaW5lcldpZHRoLAogICAgICAgIGhlaWdodDogY29udGFpbmVySGVpZ2h0CiAgICAgIH0gPSBub2RlLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICBzZXRDb250YWluZXJTaXplKGNvbnRhaW5lcldpZHRoLCBjb250YWluZXJIZWlnaHQpOwogICAgfQogIH0sIFtyZWYsIHNldENvbnRhaW5lclNpemVdKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChSZWFjdDMyLkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFJlcG9ydENoYXJ0U2l6ZSwgewogICAgd2lkdGg6IHNpemVzLmNvbnRhaW5lcldpZHRoLAogICAgaGVpZ2h0OiBzaXplcy5jb250YWluZXJIZWlnaHQKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudCgiZGl2IiwgX2V4dGVuZHMyMSh7CiAgICByZWY6IGlubmVyUmVmCiAgfSwgcHJvcHMpKSk7Cn0pOwp2YXIgU3RhdGljRGl2ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0Ny5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBwcm9wczsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudChSZWFjdDMyLkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFJlcG9ydENoYXJ0U2l6ZSwgewogICAgd2lkdGgsCiAgICBoZWlnaHQKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzIuY3JlYXRlRWxlbWVudCgiZGl2IiwgX2V4dGVuZHMyMSh7CiAgICByZWYKICB9LCBwcm9wcykpKTsKfSk7CnZhciBOb25SZXNwb25zaXZlRGl2ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0Ny5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICB3aWR0aCwKICAgIGhlaWdodAogIH0gPSBwcm9wczsKICBpZiAoaXNQZXJjZW50KHdpZHRoKSB8fCBpc1BlcmNlbnQoaGVpZ2h0KSkgewogICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoUmVhZFNpemVPbmNlRGl2LCBfZXh0ZW5kczIxKHt9LCBwcm9wcywgewogICAgICByZWYKICAgIH0pKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoU3RhdGljRGl2LCBfZXh0ZW5kczIxKHt9LCBwcm9wcywgewogICAgcmVmCiAgfSkpOwp9KTsKZnVuY3Rpb24gZ2V0V3JhcHBlckRpdkNvbXBvbmVudChyZXNwb25zaXZlKSB7CiAgcmV0dXJuIHJlc3BvbnNpdmUgPT09IHRydWUgPyBSZXNwb25zaXZlRGl2IDogTm9uUmVzcG9uc2l2ZURpdjsKfQp2YXIgUmVjaGFydHNXcmFwcGVyID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0Ny5mb3J3YXJkUmVmKSgocHJvcHMsIHJlZikgPT4gewogIHZhciB7CiAgICBjaGlsZHJlbiwKICAgIGNsYXNzTmFtZSwKICAgIGhlaWdodDogaGVpZ2h0RnJvbVByb3BzLAogICAgb25DbGljaywKICAgIG9uQ29udGV4dE1lbnUsCiAgICBvbkRvdWJsZUNsaWNrLAogICAgb25Nb3VzZURvd24sCiAgICBvbk1vdXNlRW50ZXIsCiAgICBvbk1vdXNlTGVhdmUsCiAgICBvbk1vdXNlTW92ZSwKICAgIG9uTW91c2VVcCwKICAgIG9uVG91Y2hFbmQsCiAgICBvblRvdWNoTW92ZSwKICAgIG9uVG91Y2hTdGFydCwKICAgIHN0eWxlLAogICAgd2lkdGg6IHdpZHRoRnJvbVByb3BzLAogICAgcmVzcG9uc2l2ZSwKICAgIGRpc3BhdGNoVG91Y2hFdmVudHMgPSB0cnVlCiAgfSA9IHByb3BzOwogIHZhciBjb250YWluZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlUmVmKShudWxsKTsKICB2YXIgZGlzcGF0Y2ggPSB1c2VBcHBEaXNwYXRjaCgpOwogIHZhciBbdG9vbHRpcFBvcnRhbCwgc2V0VG9vbHRpcFBvcnRhbF0gPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlU3RhdGUpKG51bGwpOwogIHZhciBbbGVnZW5kUG9ydGFsLCBzZXRMZWdlbmRQb3J0YWxdID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZVN0YXRlKShudWxsKTsKICB2YXIgc2V0U2NhbGVSZWYgPSB1c2VSZXBvcnRTY2FsZSgpOwogIHZhciByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zID0gdXNlUmVzcG9uc2l2ZUNvbnRhaW5lckNvbnRleHQoKTsKICB2YXIgd2lkdGggPSAocmVzcG9uc2l2ZUNvbnRhaW5lckNhbGN1bGF0aW9ucyA9PT0gbnVsbCB8fCByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLndpZHRoKSA+IDAgPyByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLndpZHRoIDogd2lkdGhGcm9tUHJvcHM7CiAgdmFyIGhlaWdodCA9IChyZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zID09PSBudWxsIHx8IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHJlc3BvbnNpdmVDb250YWluZXJDYWxjdWxhdGlvbnMuaGVpZ2h0KSA+IDAgPyByZXNwb25zaXZlQ29udGFpbmVyQ2FsY3VsYXRpb25zLmhlaWdodCA6IGhlaWdodEZyb21Qcm9wczsKICB2YXIgaW5uZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChub2RlKSA9PiB7CiAgICBzZXRTY2FsZVJlZihub2RlKTsKICAgIGlmICh0eXBlb2YgcmVmID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJlZihub2RlKTsKICAgIH0KICAgIHNldFRvb2x0aXBQb3J0YWwobm9kZSk7CiAgICBzZXRMZWdlbmRQb3J0YWwobm9kZSk7CiAgICBpZiAobm9kZSAhPSBudWxsKSB7CiAgICAgIGNvbnRhaW5lclJlZi5jdXJyZW50ID0gbm9kZTsKICAgIH0KICB9LCBbc2V0U2NhbGVSZWYsIHJlZiwgc2V0VG9vbHRpcFBvcnRhbCwgc2V0TGVnZW5kUG9ydGFsXSk7CiAgdmFyIG15T25DbGljayA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKG1vdXNlQ2xpY2tBY3Rpb24oZSkpOwogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uQ2xpY2ssCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uQ2xpY2tdKTsKICB2YXIgbXlPbk1vdXNlRW50ZXIgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChtb3VzZU1vdmVBY3Rpb24oZSkpOwogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uTW91c2VFbnRlciwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Nb3VzZUVudGVyXSk7CiAgdmFyIG15T25Nb3VzZUxlYXZlID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2gobW91c2VMZWF2ZUNoYXJ0KCkpOwogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uTW91c2VMZWF2ZSwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Nb3VzZUxlYXZlXSk7CiAgdmFyIG15T25Nb3VzZU1vdmUgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChtb3VzZU1vdmVBY3Rpb24oZSkpOwogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uTW91c2VNb3ZlLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbk1vdXNlTW92ZV0pOwogIHZhciBvbkZvY3VzID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoKSA9PiB7CiAgICBkaXNwYXRjaChmb2N1c0FjdGlvbigpKTsKICB9LCBbZGlzcGF0Y2hdKTsKICB2YXIgb25LZXlEb3duID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goa2V5RG93bkFjdGlvbihlLmtleSkpOwogIH0sIFtkaXNwYXRjaF0pOwogIHZhciBteU9uQ29udGV4dE1lbnUgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Db250ZXh0TWVudSwKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Db250ZXh0TWVudV0pOwogIHZhciBteU9uRG91YmxlQ2xpY2sgPSAoMCwgaW1wb3J0X3JlYWN0NDcudXNlQ2FsbGJhY2spKChlKSA9PiB7CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Eb3VibGVDbGljaywKICAgICAgcmVhY3RFdmVudDogZQogICAgfSkpOwogIH0sIFtkaXNwYXRjaCwgb25Eb3VibGVDbGlja10pOwogIHZhciBteU9uTW91c2VEb3duID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgZGlzcGF0Y2goZXh0ZXJuYWxFdmVudEFjdGlvbih7CiAgICAgIGhhbmRsZXI6IG9uTW91c2VEb3duLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvbk1vdXNlRG93bl0pOwogIHZhciBteU9uTW91c2VVcCA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvbk1vdXNlVXAsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uTW91c2VVcF0pOwogIHZhciBteU9uVG91Y2hTdGFydCA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvblRvdWNoU3RhcnQsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIG9uVG91Y2hTdGFydF0pOwogIHZhciBteU9uVG91Y2hNb3ZlID0gKDAsIGltcG9ydF9yZWFjdDQ3LnVzZUNhbGxiYWNrKSgoZSkgPT4gewogICAgaWYgKGRpc3BhdGNoVG91Y2hFdmVudHMpIHsKICAgICAgZGlzcGF0Y2godG91Y2hFdmVudEFjdGlvbihlKSk7CiAgICB9CiAgICBkaXNwYXRjaChleHRlcm5hbEV2ZW50QWN0aW9uKHsKICAgICAgaGFuZGxlcjogb25Ub3VjaE1vdmUsCiAgICAgIHJlYWN0RXZlbnQ6IGUKICAgIH0pKTsKICB9LCBbZGlzcGF0Y2gsIGRpc3BhdGNoVG91Y2hFdmVudHMsIG9uVG91Y2hNb3ZlXSk7CiAgdmFyIG15T25Ub3VjaEVuZCA9ICgwLCBpbXBvcnRfcmVhY3Q0Ny51c2VDYWxsYmFjaykoKGUpID0+IHsKICAgIGRpc3BhdGNoKGV4dGVybmFsRXZlbnRBY3Rpb24oewogICAgICBoYW5kbGVyOiBvblRvdWNoRW5kLAogICAgICByZWFjdEV2ZW50OiBlCiAgICB9KSk7CiAgfSwgW2Rpc3BhdGNoLCBvblRvdWNoRW5kXSk7CiAgdmFyIFdyYXBwZXJEaXYgPSBnZXRXcmFwcGVyRGl2Q29tcG9uZW50KHJlc3BvbnNpdmUpOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KFRvb2x0aXBQb3J0YWxDb250ZXh0LlByb3ZpZGVyLCB7CiAgICB2YWx1ZTogdG9vbHRpcFBvcnRhbAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoTGVnZW5kUG9ydGFsQ29udGV4dC5Qcm92aWRlciwgewogICAgdmFsdWU6IGxlZ2VuZFBvcnRhbAogIH0sIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMyLmNyZWF0ZUVsZW1lbnQoV3JhcHBlckRpdiwgewogICAgd2lkdGg6IHdpZHRoICE9PSBudWxsICYmIHdpZHRoICE9PSB2b2lkIDAgPyB3aWR0aCA6IHN0eWxlID09PSBudWxsIHx8IHN0eWxlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzdHlsZS53aWR0aCwKICAgIGhlaWdodDogaGVpZ2h0ICE9PSBudWxsICYmIGhlaWdodCAhPT0gdm9pZCAwID8gaGVpZ2h0IDogc3R5bGUgPT09IG51bGwgfHwgc3R5bGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHN0eWxlLmhlaWdodCwKICAgIGNsYXNzTmFtZTogY2xzeCgicmVjaGFydHMtd3JhcHBlciIsIGNsYXNzTmFtZSksCiAgICBzdHlsZTogX29iamVjdFNwcmVhZDMxKHsKICAgICAgcG9zaXRpb246ICJyZWxhdGl2ZSIsCiAgICAgIGN1cnNvcjogImRlZmF1bHQiLAogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9LCBzdHlsZSksCiAgICBvbkNsaWNrOiBteU9uQ2xpY2ssCiAgICBvbkNvbnRleHRNZW51OiBteU9uQ29udGV4dE1lbnUsCiAgICBvbkRvdWJsZUNsaWNrOiBteU9uRG91YmxlQ2xpY2ssCiAgICBvbkZvY3VzLAogICAgb25LZXlEb3duLAogICAgb25Nb3VzZURvd246IG15T25Nb3VzZURvd24sCiAgICBvbk1vdXNlRW50ZXI6IG15T25Nb3VzZUVudGVyLAogICAgb25Nb3VzZUxlYXZlOiBteU9uTW91c2VMZWF2ZSwKICAgIG9uTW91c2VNb3ZlOiBteU9uTW91c2VNb3ZlLAogICAgb25Nb3VzZVVwOiBteU9uTW91c2VVcCwKICAgIG9uVG91Y2hFbmQ6IG15T25Ub3VjaEVuZCwKICAgIG9uVG91Y2hNb3ZlOiBteU9uVG91Y2hNb3ZlLAogICAgb25Ub3VjaFN0YXJ0OiBteU9uVG91Y2hTdGFydCwKICAgIHJlZjogaW5uZXJSZWYKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMi5jcmVhdGVFbGVtZW50KEV2ZW50U3luY2hyb25pemVyLCBudWxsKSwgY2hpbGRyZW4pKSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3JlY2hhcnRzQDMuNS4xX0B0eXBlcytyZWFjdEAxOC4zLjI3X3JlYWN0LWRvbUAxOC4zLjFfcmVhY3RAMTguMy4xX19yZWFjdC1pc0AxOS4yLjBfcmVhY3RAMTguMy4xX3JlZHV4QDUuMC4xL25vZGVfbW9kdWxlcy9yZWNoYXJ0cy9lczYvY2hhcnQvQ2F0ZWdvcmljYWxDaGFydC5qcwp2YXIgX2V4Y2x1ZGVkMTcgPSBbIndpZHRoIiwgImhlaWdodCIsICJyZXNwb25zaXZlIiwgImNoaWxkcmVuIiwgImNsYXNzTmFtZSIsICJzdHlsZSIsICJjb21wYWN0IiwgInRpdGxlIiwgImRlc2MiXTsKZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzMTcoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKICB2YXIgbywgcjIsIGkgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZTE3KGUsIHQpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbiA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICBmb3IgKHIyID0gMDsgcjIgPCBuLmxlbmd0aDsgcjIrKykgbyA9IG5bcjJdLCAtMSA9PT0gdC5pbmRleE9mKG8pICYmIHt9LnByb3BlcnR5SXNFbnVtZXJhYmxlLmNhbGwoZSwgbykgJiYgKGlbb10gPSBlW29dKTsKICB9CiAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gX29iamVjdFdpdGhvdXRQcm9wZXJ0aWVzTG9vc2UxNyhyMiwgZSkgewogIGlmIChudWxsID09IHIyKSByZXR1cm4ge307CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBuIGluIHIyKSBpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChyMiwgbikpIHsKICAgIGlmICgtMSAhPT0gZS5pbmRleE9mKG4pKSBjb250aW51ZTsKICAgIHRbbl0gPSByMltuXTsKICB9CiAgcmV0dXJuIHQ7Cn0KdmFyIENhdGVnb3JpY2FsQ2hhcnQgPSAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9yZWFjdDQ4LmZvcndhcmRSZWYpKChwcm9wcywgcmVmKSA9PiB7CiAgdmFyIHsKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgcmVzcG9uc2l2ZSwKICAgIGNoaWxkcmVuLAogICAgY2xhc3NOYW1lLAogICAgc3R5bGUsCiAgICBjb21wYWN0LAogICAgdGl0bGUsCiAgICBkZXNjCiAgfSA9IHByb3BzLCBvdGhlcnMgPSBfb2JqZWN0V2l0aG91dFByb3BlcnRpZXMxNyhwcm9wcywgX2V4Y2x1ZGVkMTcpOwogIHZhciBhdHRycyA9IHN2Z1Byb3BlcnRpZXNOb0V2ZW50cyhvdGhlcnMpOwogIGlmIChjb21wYWN0KSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChSZWFjdDMzLkZyYWdtZW50LCBudWxsLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KFJlcG9ydENoYXJ0U2l6ZSwgewogICAgICB3aWR0aCwKICAgICAgaGVpZ2h0CiAgICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChSb290U3VyZmFjZSwgewogICAgICBvdGhlckF0dHJpYnV0ZXM6IGF0dHJzLAogICAgICB0aXRsZSwKICAgICAgZGVzYwogICAgfSwgY2hpbGRyZW4pKTsKICB9CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDMzLmNyZWF0ZUVsZW1lbnQoUmVjaGFydHNXcmFwcGVyLCB7CiAgICBjbGFzc05hbWUsCiAgICBzdHlsZSwKICAgIHdpZHRoLAogICAgaGVpZ2h0LAogICAgcmVzcG9uc2l2ZTogcmVzcG9uc2l2ZSAhPT0gbnVsbCAmJiByZXNwb25zaXZlICE9PSB2b2lkIDAgPyByZXNwb25zaXZlIDogZmFsc2UsCiAgICBvbkNsaWNrOiBwcm9wcy5vbkNsaWNrLAogICAgb25Nb3VzZUxlYXZlOiBwcm9wcy5vbk1vdXNlTGVhdmUsCiAgICBvbk1vdXNlRW50ZXI6IHByb3BzLm9uTW91c2VFbnRlciwKICAgIG9uTW91c2VNb3ZlOiBwcm9wcy5vbk1vdXNlTW92ZSwKICAgIG9uTW91c2VEb3duOiBwcm9wcy5vbk1vdXNlRG93biwKICAgIG9uTW91c2VVcDogcHJvcHMub25Nb3VzZVVwLAogICAgb25Db250ZXh0TWVudTogcHJvcHMub25Db250ZXh0TWVudSwKICAgIG9uRG91YmxlQ2xpY2s6IHByb3BzLm9uRG91YmxlQ2xpY2ssCiAgICBvblRvdWNoU3RhcnQ6IHByb3BzLm9uVG91Y2hTdGFydCwKICAgIG9uVG91Y2hNb3ZlOiBwcm9wcy5vblRvdWNoTW92ZSwKICAgIG9uVG91Y2hFbmQ6IHByb3BzLm9uVG91Y2hFbmQKICB9LCAvKiBAX19QVVJFX18gKi8gUmVhY3QzMy5jcmVhdGVFbGVtZW50KFJvb3RTdXJmYWNlLCB7CiAgICBvdGhlckF0dHJpYnV0ZXM6IGF0dHJzLAogICAgdGl0bGUsCiAgICBkZXNjLAogICAgcmVmCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzMuY3JlYXRlRWxlbWVudChDbGlwUGF0aFByb3ZpZGVyLCBudWxsLCBjaGlsZHJlbikpKTsKfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9DYXJ0ZXNpYW5DaGFydC5qcwpmdW5jdGlvbiBfZXh0ZW5kczIyKCkgewogIHJldHVybiBfZXh0ZW5kczIyID0gT2JqZWN0LmFzc2lnbiA/IE9iamVjdC5hc3NpZ24uYmluZCgpIDogZnVuY3Rpb24obikgewogICAgZm9yICh2YXIgZSA9IDE7IGUgPCBhcmd1bWVudHMubGVuZ3RoOyBlKyspIHsKICAgICAgdmFyIHQgPSBhcmd1bWVudHNbZV07CiAgICAgIGZvciAodmFyIHIyIGluIHQpICh7fSkuaGFzT3duUHJvcGVydHkuY2FsbCh0LCByMikgJiYgKG5bcjJdID0gdFtyMl0pOwogICAgfQogICAgcmV0dXJuIG47CiAgfSwgX2V4dGVuZHMyMi5hcHBseShudWxsLCBhcmd1bWVudHMpOwp9CnZhciBkZWZhdWx0TWFyZ2luID0gewogIHRvcDogNSwKICByaWdodDogNSwKICBib3R0b206IDUsCiAgbGVmdDogNQp9Owp2YXIgZGVmYXVsdENhcnRlc2lhbkNoYXJ0UHJvcHMgPSB7CiAgYWNjZXNzaWJpbGl0eUxheWVyOiB0cnVlLAogIGJhckNhdGVnb3J5R2FwOiAiMTAlIiwKICBiYXJHYXA6IDQsCiAgbGF5b3V0OiAiaG9yaXpvbnRhbCIsCiAgbWFyZ2luOiBkZWZhdWx0TWFyZ2luLAogIHJlc3BvbnNpdmU6IGZhbHNlLAogIHJldmVyc2VTdGFja09yZGVyOiBmYWxzZSwKICBzdGFja09mZnNldDogIm5vbmUiLAogIHN5bmNNZXRob2Q6ICJpbmRleCIKfTsKdmFyIENhcnRlc2lhbkNoYXJ0ID0gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfcmVhY3Q0OS5mb3J3YXJkUmVmKShmdW5jdGlvbiBDYXJ0ZXNpYW5DaGFydDIocHJvcHMsIHJlZikgewogIHZhciBfY2F0ZWdvcmljYWxDaGFydFByb3A7CiAgdmFyIHJvb3RDaGFydFByb3BzID0gcmVzb2x2ZURlZmF1bHRQcm9wcyhwcm9wcy5jYXRlZ29yaWNhbENoYXJ0UHJvcHMsIGRlZmF1bHRDYXJ0ZXNpYW5DaGFydFByb3BzKTsKICB2YXIgewogICAgY2hhcnROYW1lLAogICAgZGVmYXVsdFRvb2x0aXBFdmVudFR5cGUsCiAgICB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzLAogICAgdG9vbHRpcFBheWxvYWRTZWFyY2hlciwKICAgIGNhdGVnb3JpY2FsQ2hhcnRQcm9wcwogIH0gPSBwcm9wczsKICB2YXIgb3B0aW9ucyA9IHsKICAgIGNoYXJ0TmFtZSwKICAgIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlLAogICAgdmFsaWRhdGVUb29sdGlwRXZlbnRUeXBlcywKICAgIHRvb2x0aXBQYXlsb2FkU2VhcmNoZXIsCiAgICBldmVudEVtaXR0ZXI6IHZvaWQgMAogIH07CiAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyBSZWFjdDM0LmNyZWF0ZUVsZW1lbnQoUmVjaGFydHNTdG9yZVByb3ZpZGVyLCB7CiAgICBwcmVsb2FkZWRTdGF0ZTogewogICAgICBvcHRpb25zCiAgICB9LAogICAgcmVkdXhTdG9yZU5hbWU6IChfY2F0ZWdvcmljYWxDaGFydFByb3AgPSBjYXRlZ29yaWNhbENoYXJ0UHJvcHMuaWQpICE9PSBudWxsICYmIF9jYXRlZ29yaWNhbENoYXJ0UHJvcCAhPT0gdm9pZCAwID8gX2NhdGVnb3JpY2FsQ2hhcnRQcm9wIDogY2hhcnROYW1lCiAgfSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzQuY3JlYXRlRWxlbWVudChDaGFydERhdGFDb250ZXh0UHJvdmlkZXIsIHsKICAgIGNoYXJ0RGF0YTogY2F0ZWdvcmljYWxDaGFydFByb3BzLmRhdGEKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzQuY3JlYXRlRWxlbWVudChSZXBvcnRNYWluQ2hhcnRQcm9wcywgewogICAgbGF5b3V0OiByb290Q2hhcnRQcm9wcy5sYXlvdXQsCiAgICBtYXJnaW46IHJvb3RDaGFydFByb3BzLm1hcmdpbgogIH0pLCAvKiBAX19QVVJFX18gKi8gUmVhY3QzNC5jcmVhdGVFbGVtZW50KFJlcG9ydENoYXJ0UHJvcHMsIHsKICAgIGJhc2VWYWx1ZTogcm9vdENoYXJ0UHJvcHMuYmFzZVZhbHVlLAogICAgYWNjZXNzaWJpbGl0eUxheWVyOiByb290Q2hhcnRQcm9wcy5hY2Nlc3NpYmlsaXR5TGF5ZXIsCiAgICBiYXJDYXRlZ29yeUdhcDogcm9vdENoYXJ0UHJvcHMuYmFyQ2F0ZWdvcnlHYXAsCiAgICBtYXhCYXJTaXplOiByb290Q2hhcnRQcm9wcy5tYXhCYXJTaXplLAogICAgc3RhY2tPZmZzZXQ6IHJvb3RDaGFydFByb3BzLnN0YWNrT2Zmc2V0LAogICAgYmFyR2FwOiByb290Q2hhcnRQcm9wcy5iYXJHYXAsCiAgICBiYXJTaXplOiByb290Q2hhcnRQcm9wcy5iYXJTaXplLAogICAgc3luY0lkOiByb290Q2hhcnRQcm9wcy5zeW5jSWQsCiAgICBzeW5jTWV0aG9kOiByb290Q2hhcnRQcm9wcy5zeW5jTWV0aG9kLAogICAgY2xhc3NOYW1lOiByb290Q2hhcnRQcm9wcy5jbGFzc05hbWUsCiAgICByZXZlcnNlU3RhY2tPcmRlcjogcm9vdENoYXJ0UHJvcHMucmV2ZXJzZVN0YWNrT3JkZXIKICB9KSwgLyogQF9fUFVSRV9fICovIFJlYWN0MzQuY3JlYXRlRWxlbWVudChDYXRlZ29yaWNhbENoYXJ0LCBfZXh0ZW5kczIyKHt9LCByb290Q2hhcnRQcm9wcywgewogICAgcmVmCiAgfSkpKTsKfSk7CgovLyBub2RlX21vZHVsZXMvLnBucG0vcmVjaGFydHNAMy41LjFfQHR5cGVzK3JlYWN0QDE4LjMuMjdfcmVhY3QtZG9tQDE4LjMuMV9yZWFjdEAxOC4zLjFfX3JlYWN0LWlzQDE5LjIuMF9yZWFjdEAxOC4zLjFfcmVkdXhANS4wLjEvbm9kZV9tb2R1bGVzL3JlY2hhcnRzL2VzNi9jaGFydC9BcmVhQ2hhcnQuanMKdmFyIFJlYWN0MzUgPSBfX3RvRVNNKHJlcXVpcmVfcmVhY3QoKSk7CnZhciBpbXBvcnRfcmVhY3Q1MCA9IF9fdG9FU00ocmVxdWlyZV9yZWFjdCgpKTsKdmFyIGFsbG93ZWRUb29sdGlwVHlwZXMgPSBbImF4aXMiXTsKdmFyIEFyZWFDaGFydCA9IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X3JlYWN0NTAuZm9yd2FyZFJlZikoKHByb3BzLCByZWYpID0+IHsKICByZXR1cm4gLyogQF9fUFVSRV9fICovIFJlYWN0MzUuY3JlYXRlRWxlbWVudChDYXJ0ZXNpYW5DaGFydCwgewogICAgY2hhcnROYW1lOiAiQXJlYUNoYXJ0IiwKICAgIGRlZmF1bHRUb29sdGlwRXZlbnRUeXBlOiAiYXhpcyIsCiAgICB2YWxpZGF0ZVRvb2x0aXBFdmVudFR5cGVzOiBhbGxvd2VkVG9vbHRpcFR5cGVzLAogICAgdG9vbHRpcFBheWxvYWRTZWFyY2hlcjogYXJyYXlUb29sdGlwU2VhcmNoZXIsCiAgICBjYXRlZ29yaWNhbENoYXJ0UHJvcHM6IHByb3BzLAogICAgcmVmCiAgfSk7Cn0pOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL3RzbGliQDIuOC4xL25vZGVfbW9kdWxlcy90c2xpYi90c2xpYi5lczYubWpzCmZ1bmN0aW9uIF9fcmVzdChzLCBlKSB7CiAgdmFyIHQgPSB7fTsKICBmb3IgKHZhciBwIGluIHMpIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwocywgcCkgJiYgZS5pbmRleE9mKHApIDwgMCkKICAgIHRbcF0gPSBzW3BdOwogIGlmIChzICE9IG51bGwgJiYgdHlwZW9mIE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMgPT09ICJmdW5jdGlvbiIpCiAgICBmb3IgKHZhciBpID0gMCwgcCA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMocyk7IGkgPCBwLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChlLmluZGV4T2YocFtpXSkgPCAwICYmIE9iamVjdC5wcm90b3R5cGUucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChzLCBwW2ldKSkKICAgICAgICB0W3BbaV1dID0gc1twW2ldXTsKICAgIH0KICByZXR1cm4gdDsKfQpmdW5jdGlvbiBfX2F3YWl0ZXIodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7CiAgZnVuY3Rpb24gYWRvcHQodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIFAgPyB2YWx1ZSA6IG5ldyBQKGZ1bmN0aW9uKHJlc29sdmUpIHsKICAgICAgcmVzb2x2ZSh2YWx1ZSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHsKICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgewogICAgICB0cnkgewogICAgICAgIHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHJlamVjdChlKTsKICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsKICAgICAgdHJ5IHsKICAgICAgICBzdGVwKGdlbmVyYXRvclsidGhyb3ciXSh2YWx1ZSkpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmVqZWN0KGUpOwogICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgewogICAgICByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IGFkb3B0KHJlc3VsdC52YWx1ZSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsKICAgIH0KICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTsKICB9KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZStmdW5jdGlvbnMtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvZnVuY3Rpb25zLWpzL2Rpc3QvbW9kdWxlL2hlbHBlci5qcwp2YXIgcmVzb2x2ZUZldGNoID0gKGN1c3RvbUZldGNoKSA9PiB7CiAgaWYgKGN1c3RvbUZldGNoKSB7CiAgICByZXR1cm4gKC4uLmFyZ3MpID0+IGN1c3RvbUZldGNoKC4uLmFyZ3MpOwogIH0KICByZXR1cm4gKC4uLmFyZ3MpID0+IGZldGNoKC4uLmFyZ3MpOwp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZStmdW5jdGlvbnMtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvZnVuY3Rpb25zLWpzL2Rpc3QvbW9kdWxlL3R5cGVzLmpzCnZhciBGdW5jdGlvbnNFcnJvciA9IGNsYXNzIGV4dGVuZHMgRXJyb3IgewogIGNvbnN0cnVjdG9yKG1lc3NhZ2UsIG5hbWUgPSAiRnVuY3Rpb25zRXJyb3IiLCBjb250ZXh0KSB7CiAgICBzdXBlcihtZXNzYWdlKTsKICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogIH0KfTsKdmFyIEZ1bmN0aW9uc0ZldGNoRXJyb3IgPSBjbGFzcyBleHRlbmRzIEZ1bmN0aW9uc0Vycm9yIHsKICBjb25zdHJ1Y3Rvcihjb250ZXh0KSB7CiAgICBzdXBlcigiRmFpbGVkIHRvIHNlbmQgYSByZXF1ZXN0IHRvIHRoZSBFZGdlIEZ1bmN0aW9uIiwgIkZ1bmN0aW9uc0ZldGNoRXJyb3IiLCBjb250ZXh0KTsKICB9Cn07CnZhciBGdW5jdGlvbnNSZWxheUVycm9yID0gY2xhc3MgZXh0ZW5kcyBGdW5jdGlvbnNFcnJvciB7CiAgY29uc3RydWN0b3IoY29udGV4dCkgewogICAgc3VwZXIoIlJlbGF5IEVycm9yIGludm9raW5nIHRoZSBFZGdlIEZ1bmN0aW9uIiwgIkZ1bmN0aW9uc1JlbGF5RXJyb3IiLCBjb250ZXh0KTsKICB9Cn07CnZhciBGdW5jdGlvbnNIdHRwRXJyb3IgPSBjbGFzcyBleHRlbmRzIEZ1bmN0aW9uc0Vycm9yIHsKICBjb25zdHJ1Y3Rvcihjb250ZXh0KSB7CiAgICBzdXBlcigiRWRnZSBGdW5jdGlvbiByZXR1cm5lZCBhIG5vbi0yeHggc3RhdHVzIGNvZGUiLCAiRnVuY3Rpb25zSHR0cEVycm9yIiwgY29udGV4dCk7CiAgfQp9Owp2YXIgRnVuY3Rpb25SZWdpb247CihmdW5jdGlvbihGdW5jdGlvblJlZ2lvbjIpIHsKICBGdW5jdGlvblJlZ2lvbjJbIkFueSJdID0gImFueSI7CiAgRnVuY3Rpb25SZWdpb24yWyJBcE5vcnRoZWFzdDEiXSA9ICJhcC1ub3J0aGVhc3QtMSI7CiAgRnVuY3Rpb25SZWdpb24yWyJBcE5vcnRoZWFzdDIiXSA9ICJhcC1ub3J0aGVhc3QtMiI7CiAgRnVuY3Rpb25SZWdpb24yWyJBcFNvdXRoMSJdID0gImFwLXNvdXRoLTEiOwogIEZ1bmN0aW9uUmVnaW9uMlsiQXBTb3V0aGVhc3QxIl0gPSAiYXAtc291dGhlYXN0LTEiOwogIEZ1bmN0aW9uUmVnaW9uMlsiQXBTb3V0aGVhc3QyIl0gPSAiYXAtc291dGhlYXN0LTIiOwogIEZ1bmN0aW9uUmVnaW9uMlsiQ2FDZW50cmFsMSJdID0gImNhLWNlbnRyYWwtMSI7CiAgRnVuY3Rpb25SZWdpb24yWyJFdUNlbnRyYWwxIl0gPSAiZXUtY2VudHJhbC0xIjsKICBGdW5jdGlvblJlZ2lvbjJbIkV1V2VzdDEiXSA9ICJldS13ZXN0LTEiOwogIEZ1bmN0aW9uUmVnaW9uMlsiRXVXZXN0MiJdID0gImV1LXdlc3QtMiI7CiAgRnVuY3Rpb25SZWdpb24yWyJFdVdlc3QzIl0gPSAiZXUtd2VzdC0zIjsKICBGdW5jdGlvblJlZ2lvbjJbIlNhRWFzdDEiXSA9ICJzYS1lYXN0LTEiOwogIEZ1bmN0aW9uUmVnaW9uMlsiVXNFYXN0MSJdID0gInVzLWVhc3QtMSI7CiAgRnVuY3Rpb25SZWdpb24yWyJVc1dlc3QxIl0gPSAidXMtd2VzdC0xIjsKICBGdW5jdGlvblJlZ2lvbjJbIlVzV2VzdDIiXSA9ICJ1cy13ZXN0LTIiOwp9KShGdW5jdGlvblJlZ2lvbiB8fCAoRnVuY3Rpb25SZWdpb24gPSB7fSkpOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZStmdW5jdGlvbnMtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvZnVuY3Rpb25zLWpzL2Rpc3QvbW9kdWxlL0Z1bmN0aW9uc0NsaWVudC5qcwp2YXIgRnVuY3Rpb25zQ2xpZW50ID0gY2xhc3MgewogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgRnVuY3Rpb25zIGNsaWVudCBib3VuZCB0byBhbiBFZGdlIEZ1bmN0aW9ucyBVUkwuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIGBgYHRzCiAgICogaW1wb3J0IHsgRnVuY3Rpb25zQ2xpZW50LCBGdW5jdGlvblJlZ2lvbiB9IGZyb20gJ0BzdXBhYmFzZS9mdW5jdGlvbnMtanMnCiAgICoKICAgKiBjb25zdCBmdW5jdGlvbnMgPSBuZXcgRnVuY3Rpb25zQ2xpZW50KCdodHRwczovL3h5emNvbXBhbnkuc3VwYWJhc2UuY28vZnVuY3Rpb25zL3YxJywgewogICAqICAgaGVhZGVyczogeyBhcGlrZXk6ICdwdWJsaWMtYW5vbi1rZXknIH0sCiAgICogICByZWdpb246IEZ1bmN0aW9uUmVnaW9uLlVzRWFzdDEsCiAgICogfSkKICAgKiBgYGAKICAgKi8KICBjb25zdHJ1Y3Rvcih1cmwsIHsgaGVhZGVycyA9IHt9LCBjdXN0b21GZXRjaCwgcmVnaW9uID0gRnVuY3Rpb25SZWdpb24uQW55IH0gPSB7fSkgewogICAgdGhpcy51cmwgPSB1cmw7CiAgICB0aGlzLmhlYWRlcnMgPSBoZWFkZXJzOwogICAgdGhpcy5yZWdpb24gPSByZWdpb247CiAgICB0aGlzLmZldGNoID0gcmVzb2x2ZUZldGNoKGN1c3RvbUZldGNoKTsKICB9CiAgLyoqCiAgICogVXBkYXRlcyB0aGUgYXV0aG9yaXphdGlvbiBoZWFkZXIKICAgKiBAcGFyYW0gdG9rZW4gLSB0aGUgbmV3IGp3dCB0b2tlbiBzZW50IGluIHRoZSBhdXRob3Jpc2F0aW9uIGhlYWRlcgogICAqIEBleGFtcGxlCiAgICogYGBgdHMKICAgKiBmdW5jdGlvbnMuc2V0QXV0aChzZXNzaW9uLmFjY2Vzc190b2tlbikKICAgKiBgYGAKICAgKi8KICBzZXRBdXRoKHRva2VuKSB7CiAgICB0aGlzLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGBCZWFyZXIgJHt0b2tlbn1gOwogIH0KICAvKioKICAgKiBJbnZva2VzIGEgZnVuY3Rpb24KICAgKiBAcGFyYW0gZnVuY3Rpb25OYW1lIC0gVGhlIG5hbWUgb2YgdGhlIEZ1bmN0aW9uIHRvIGludm9rZS4KICAgKiBAcGFyYW0gb3B0aW9ucyAtIE9wdGlvbnMgZm9yIGludm9raW5nIHRoZSBGdW5jdGlvbi4KICAgKiBAZXhhbXBsZQogICAqIGBgYHRzCiAgICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgZnVuY3Rpb25zLmludm9rZSgnaGVsbG8td29ybGQnLCB7CiAgICogICBib2R5OiB7IG5hbWU6ICdBZGEnIH0sCiAgICogfSkKICAgKiBgYGAKICAgKi8KICBpbnZva2UoZnVuY3Rpb25OYW1lXzEpIHsKICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgYXJndW1lbnRzLCB2b2lkIDAsIGZ1bmN0aW9uKiAoZnVuY3Rpb25OYW1lLCBvcHRpb25zID0ge30pIHsKICAgICAgdmFyIF9hOwogICAgICBsZXQgdGltZW91dElkOwogICAgICBsZXQgdGltZW91dENvbnRyb2xsZXI7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgeyBoZWFkZXJzLCBtZXRob2QsIGJvZHk6IGZ1bmN0aW9uQXJncywgc2lnbmFsLCB0aW1lb3V0IH0gPSBvcHRpb25zOwogICAgICAgIGxldCBfaGVhZGVycyA9IHt9OwogICAgICAgIGxldCB7IHJlZ2lvbiB9ID0gb3B0aW9uczsKICAgICAgICBpZiAoIXJlZ2lvbikgewogICAgICAgICAgcmVnaW9uID0gdGhpcy5yZWdpb247CiAgICAgICAgfQogICAgICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoYCR7dGhpcy51cmx9LyR7ZnVuY3Rpb25OYW1lfWApOwogICAgICAgIGlmIChyZWdpb24gJiYgcmVnaW9uICE9PSAiYW55IikgewogICAgICAgICAgX2hlYWRlcnNbIngtcmVnaW9uIl0gPSByZWdpb247CiAgICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgiZm9yY2VGdW5jdGlvblJlZ2lvbiIsIHJlZ2lvbik7CiAgICAgICAgfQogICAgICAgIGxldCBib2R5OwogICAgICAgIGlmIChmdW5jdGlvbkFyZ3MgJiYgKGhlYWRlcnMgJiYgIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChoZWFkZXJzLCAiQ29udGVudC1UeXBlIikgfHwgIWhlYWRlcnMpKSB7CiAgICAgICAgICBpZiAodHlwZW9mIEJsb2IgIT09ICJ1bmRlZmluZWQiICYmIGZ1bmN0aW9uQXJncyBpbnN0YW5jZW9mIEJsb2IgfHwgZnVuY3Rpb25BcmdzIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpIHsKICAgICAgICAgICAgX2hlYWRlcnNbIkNvbnRlbnQtVHlwZSJdID0gImFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSI7CiAgICAgICAgICAgIGJvZHkgPSBmdW5jdGlvbkFyZ3M7CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBmdW5jdGlvbkFyZ3MgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgIF9oZWFkZXJzWyJDb250ZW50LVR5cGUiXSA9ICJ0ZXh0L3BsYWluIjsKICAgICAgICAgICAgYm9keSA9IGZ1bmN0aW9uQXJnczsKICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIEZvcm1EYXRhICE9PSAidW5kZWZpbmVkIiAmJiBmdW5jdGlvbkFyZ3MgaW5zdGFuY2VvZiBGb3JtRGF0YSkgewogICAgICAgICAgICBib2R5ID0gZnVuY3Rpb25BcmdzOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgX2hlYWRlcnNbIkNvbnRlbnQtVHlwZSJdID0gImFwcGxpY2F0aW9uL2pzb24iOwogICAgICAgICAgICBib2R5ID0gSlNPTi5zdHJpbmdpZnkoZnVuY3Rpb25BcmdzKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGZ1bmN0aW9uQXJncyAmJiB0eXBlb2YgZnVuY3Rpb25BcmdzICE9PSAic3RyaW5nIiAmJiAhKHR5cGVvZiBCbG9iICE9PSAidW5kZWZpbmVkIiAmJiBmdW5jdGlvbkFyZ3MgaW5zdGFuY2VvZiBCbG9iKSAmJiAhKGZ1bmN0aW9uQXJncyBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSAmJiAhKHR5cGVvZiBGb3JtRGF0YSAhPT0gInVuZGVmaW5lZCIgJiYgZnVuY3Rpb25BcmdzIGluc3RhbmNlb2YgRm9ybURhdGEpKSB7CiAgICAgICAgICAgIGJvZHkgPSBKU09OLnN0cmluZ2lmeShmdW5jdGlvbkFyZ3MpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYm9keSA9IGZ1bmN0aW9uQXJnczsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbGV0IGVmZmVjdGl2ZVNpZ25hbCA9IHNpZ25hbDsKICAgICAgICBpZiAodGltZW91dCkgewogICAgICAgICAgdGltZW91dENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IHRpbWVvdXRDb250cm9sbGVyLmFib3J0KCksIHRpbWVvdXQpOwogICAgICAgICAgaWYgKHNpZ25hbCkgewogICAgICAgICAgICBlZmZlY3RpdmVTaWduYWwgPSB0aW1lb3V0Q29udHJvbGxlci5zaWduYWw7CiAgICAgICAgICAgIHNpZ25hbC5hZGRFdmVudExpc3RlbmVyKCJhYm9ydCIsICgpID0+IHRpbWVvdXRDb250cm9sbGVyLmFib3J0KCkpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWZmZWN0aXZlU2lnbmFsID0gdGltZW91dENvbnRyb2xsZXIuc2lnbmFsOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCByZXNwb25zZSA9IHlpZWxkIHRoaXMuZmV0Y2godXJsLnRvU3RyaW5nKCksIHsKICAgICAgICAgIG1ldGhvZDogbWV0aG9kIHx8ICJQT1NUIiwKICAgICAgICAgIC8vIGhlYWRlcnMgcHJpb3JpdHkgaXMgKGhpZ2ggdG8gbG93KToKICAgICAgICAgIC8vIDEuIGludm9rZS1sZXZlbCBoZWFkZXJzCiAgICAgICAgICAvLyAyLiBjbGllbnQtbGV2ZWwgaGVhZGVycwogICAgICAgICAgLy8gMy4gZGVmYXVsdCBDb250ZW50LVR5cGUgaGVhZGVyCiAgICAgICAgICBoZWFkZXJzOiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgX2hlYWRlcnMpLCB0aGlzLmhlYWRlcnMpLCBoZWFkZXJzKSwKICAgICAgICAgIGJvZHksCiAgICAgICAgICBzaWduYWw6IGVmZmVjdGl2ZVNpZ25hbAogICAgICAgIH0pLmNhdGNoKChmZXRjaEVycm9yKSA9PiB7CiAgICAgICAgICB0aHJvdyBuZXcgRnVuY3Rpb25zRmV0Y2hFcnJvcihmZXRjaEVycm9yKTsKICAgICAgICB9KTsKICAgICAgICBjb25zdCBpc1JlbGF5RXJyb3IgPSByZXNwb25zZS5oZWFkZXJzLmdldCgieC1yZWxheS1lcnJvciIpOwogICAgICAgIGlmIChpc1JlbGF5RXJyb3IgJiYgaXNSZWxheUVycm9yID09PSAidHJ1ZSIpIHsKICAgICAgICAgIHRocm93IG5ldyBGdW5jdGlvbnNSZWxheUVycm9yKHJlc3BvbnNlKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFyZXNwb25zZS5vaykgewogICAgICAgICAgdGhyb3cgbmV3IEZ1bmN0aW9uc0h0dHBFcnJvcihyZXNwb25zZSk7CiAgICAgICAgfQogICAgICAgIGxldCByZXNwb25zZVR5cGUgPSAoKF9hID0gcmVzcG9uc2UuaGVhZGVycy5nZXQoIkNvbnRlbnQtVHlwZSIpKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiAidGV4dC9wbGFpbiIpLnNwbGl0KCI7IilbMF0udHJpbSgpOwogICAgICAgIGxldCBkYXRhOwogICAgICAgIGlmIChyZXNwb25zZVR5cGUgPT09ICJhcHBsaWNhdGlvbi9qc29uIikgewogICAgICAgICAgZGF0YSA9IHlpZWxkIHJlc3BvbnNlLmpzb24oKTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlVHlwZSA9PT0gImFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSIgfHwgcmVzcG9uc2VUeXBlID09PSAiYXBwbGljYXRpb24vcGRmIikgewogICAgICAgICAgZGF0YSA9IHlpZWxkIHJlc3BvbnNlLmJsb2IoKTsKICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlVHlwZSA9PT0gInRleHQvZXZlbnQtc3RyZWFtIikgewogICAgICAgICAgZGF0YSA9IHJlc3BvbnNlOwogICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2VUeXBlID09PSAibXVsdGlwYXJ0L2Zvcm0tZGF0YSIpIHsKICAgICAgICAgIGRhdGEgPSB5aWVsZCByZXNwb25zZS5mb3JtRGF0YSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkYXRhID0geWllbGQgcmVzcG9uc2UudGV4dCgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4geyBkYXRhLCBlcnJvcjogbnVsbCwgcmVzcG9uc2UgfTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICAgIGVycm9yLAogICAgICAgICAgcmVzcG9uc2U6IGVycm9yIGluc3RhbmNlb2YgRnVuY3Rpb25zSHR0cEVycm9yIHx8IGVycm9yIGluc3RhbmNlb2YgRnVuY3Rpb25zUmVsYXlFcnJvciA/IGVycm9yLmNvbnRleHQgOiB2b2lkIDAKICAgICAgICB9OwogICAgICB9IGZpbmFsbHkgewogICAgICAgIGlmICh0aW1lb3V0SWQpIHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZStwb3N0Z3Jlc3QtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvcG9zdGdyZXN0LWpzL2Rpc3QvaW5kZXgubWpzCnZhciBQb3N0Z3Jlc3RFcnJvciA9IGNsYXNzIGV4dGVuZHMgRXJyb3IgewogIC8qKgogICogQGV4YW1wbGUKICAqIGBgYHRzCiAgKiBpbXBvcnQgUG9zdGdyZXN0RXJyb3IgZnJvbSAnQHN1cGFiYXNlL3Bvc3RncmVzdC1qcycKICAqCiAgKiB0aHJvdyBuZXcgUG9zdGdyZXN0RXJyb3IoewogICogICBtZXNzYWdlOiAnUm93IGxldmVsIHNlY3VyaXR5IHByZXZlbnRlZCB0aGUgcmVxdWVzdCcsCiAgKiAgIGRldGFpbHM6ICdSTFMgZGVuaWVkIHRoZSBpbnNlcnQnLAogICogICBoaW50OiAnQ2hlY2sgeW91ciBwb2xpY2llcycsCiAgKiAgIGNvZGU6ICdQR1JTVDMwMScsCiAgKiB9KQogICogYGBgCiAgKi8KICBjb25zdHJ1Y3Rvcihjb250ZXh0KSB7CiAgICBzdXBlcihjb250ZXh0Lm1lc3NhZ2UpOwogICAgdGhpcy5uYW1lID0gIlBvc3RncmVzdEVycm9yIjsKICAgIHRoaXMuZGV0YWlscyA9IGNvbnRleHQuZGV0YWlsczsKICAgIHRoaXMuaGludCA9IGNvbnRleHQuaGludDsKICAgIHRoaXMuY29kZSA9IGNvbnRleHQuY29kZTsKICB9Cn07CnZhciBQb3N0Z3Jlc3RCdWlsZGVyID0gY2xhc3MgewogIC8qKgogICogQ3JlYXRlcyBhIGJ1aWxkZXIgY29uZmlndXJlZCBmb3IgYSBzcGVjaWZpYyBQb3N0Z1JFU1QgcmVxdWVzdC4KICAqCiAgKiBAZXhhbXBsZQogICogYGBgdHMKICAqIGltcG9ydCBQb3N0Z3Jlc3RRdWVyeUJ1aWxkZXIgZnJvbSAnQHN1cGFiYXNlL3Bvc3RncmVzdC1qcycKICAqCiAgKiBjb25zdCBidWlsZGVyID0gbmV3IFBvc3RncmVzdFF1ZXJ5QnVpbGRlcigKICAqICAgbmV3IFVSTCgnaHR0cHM6Ly94eXpjb21wYW55LnN1cGFiYXNlLmNvL3Jlc3QvdjEvdXNlcnMnKSwKICAqICAgeyBoZWFkZXJzOiBuZXcgSGVhZGVycyh7IGFwaWtleTogJ3B1YmxpYy1hbm9uLWtleScgfSkgfQogICogKQogICogYGBgCiAgKi8KICBjb25zdHJ1Y3RvcihidWlsZGVyKSB7CiAgICB2YXIgX2J1aWxkZXIkc2hvdWxkVGhyb3dPLCBfYnVpbGRlciRpc01heWJlU2luZ2wsIF9idWlsZGVyJHVybExlbmd0aExpbTsKICAgIHRoaXMuc2hvdWxkVGhyb3dPbkVycm9yID0gZmFsc2U7CiAgICB0aGlzLm1ldGhvZCA9IGJ1aWxkZXIubWV0aG9kOwogICAgdGhpcy51cmwgPSBidWlsZGVyLnVybDsKICAgIHRoaXMuaGVhZGVycyA9IG5ldyBIZWFkZXJzKGJ1aWxkZXIuaGVhZGVycyk7CiAgICB0aGlzLnNjaGVtYSA9IGJ1aWxkZXIuc2NoZW1hOwogICAgdGhpcy5ib2R5ID0gYnVpbGRlci5ib2R5OwogICAgdGhpcy5zaG91bGRUaHJvd09uRXJyb3IgPSAoX2J1aWxkZXIkc2hvdWxkVGhyb3dPID0gYnVpbGRlci5zaG91bGRUaHJvd09uRXJyb3IpICE9PSBudWxsICYmIF9idWlsZGVyJHNob3VsZFRocm93TyAhPT0gdm9pZCAwID8gX2J1aWxkZXIkc2hvdWxkVGhyb3dPIDogZmFsc2U7CiAgICB0aGlzLnNpZ25hbCA9IGJ1aWxkZXIuc2lnbmFsOwogICAgdGhpcy5pc01heWJlU2luZ2xlID0gKF9idWlsZGVyJGlzTWF5YmVTaW5nbCA9IGJ1aWxkZXIuaXNNYXliZVNpbmdsZSkgIT09IG51bGwgJiYgX2J1aWxkZXIkaXNNYXliZVNpbmdsICE9PSB2b2lkIDAgPyBfYnVpbGRlciRpc01heWJlU2luZ2wgOiBmYWxzZTsKICAgIHRoaXMudXJsTGVuZ3RoTGltaXQgPSAoX2J1aWxkZXIkdXJsTGVuZ3RoTGltID0gYnVpbGRlci51cmxMZW5ndGhMaW1pdCkgIT09IG51bGwgJiYgX2J1aWxkZXIkdXJsTGVuZ3RoTGltICE9PSB2b2lkIDAgPyBfYnVpbGRlciR1cmxMZW5ndGhMaW0gOiA4ZTM7CiAgICBpZiAoYnVpbGRlci5mZXRjaCkgdGhpcy5mZXRjaCA9IGJ1aWxkZXIuZmV0Y2g7CiAgICBlbHNlIHRoaXMuZmV0Y2ggPSBmZXRjaDsKICB9CiAgLyoqCiAgKiBJZiB0aGVyZSdzIGFuIGVycm9yIHdpdGggdGhlIHF1ZXJ5LCB0aHJvd09uRXJyb3Igd2lsbCByZWplY3QgdGhlIHByb21pc2UgYnkKICAqIHRocm93aW5nIHRoZSBlcnJvciBpbnN0ZWFkIG9mIHJldHVybmluZyBpdCBhcyBwYXJ0IG9mIGEgc3VjY2Vzc2Z1bCByZXNwb25zZS4KICAqCiAgKiB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3N1cGFiYXNlL3N1cGFiYXNlLWpzL2lzc3Vlcy85Mn0KICAqLwogIHRocm93T25FcnJvcigpIHsKICAgIHRoaXMuc2hvdWxkVGhyb3dPbkVycm9yID0gdHJ1ZTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIFNldCBhbiBIVFRQIGhlYWRlciBmb3IgdGhlIHJlcXVlc3QuCiAgKi8KICBzZXRIZWFkZXIobmFtZSwgdmFsdWUpIHsKICAgIHRoaXMuaGVhZGVycyA9IG5ldyBIZWFkZXJzKHRoaXMuaGVhZGVycyk7CiAgICB0aGlzLmhlYWRlcnMuc2V0KG5hbWUsIHZhbHVlKTsKICAgIHJldHVybiB0aGlzOwogIH0KICB0aGVuKG9uZnVsZmlsbGVkLCBvbnJlamVjdGVkKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgaWYgKHRoaXMuc2NoZW1hID09PSB2b2lkIDApIHsKICAgIH0gZWxzZSBpZiAoWyJHRVQiLCAiSEVBRCJdLmluY2x1ZGVzKHRoaXMubWV0aG9kKSkgdGhpcy5oZWFkZXJzLnNldCgiQWNjZXB0LVByb2ZpbGUiLCB0aGlzLnNjaGVtYSk7CiAgICBlbHNlIHRoaXMuaGVhZGVycy5zZXQoIkNvbnRlbnQtUHJvZmlsZSIsIHRoaXMuc2NoZW1hKTsKICAgIGlmICh0aGlzLm1ldGhvZCAhPT0gIkdFVCIgJiYgdGhpcy5tZXRob2QgIT09ICJIRUFEIikgdGhpcy5oZWFkZXJzLnNldCgiQ29udGVudC1UeXBlIiwgImFwcGxpY2F0aW9uL2pzb24iKTsKICAgIGNvbnN0IF9mZXRjaCA9IHRoaXMuZmV0Y2g7CiAgICBsZXQgcmVzID0gX2ZldGNoKHRoaXMudXJsLnRvU3RyaW5nKCksIHsKICAgICAgbWV0aG9kOiB0aGlzLm1ldGhvZCwKICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh0aGlzLmJvZHkpLAogICAgICBzaWduYWw6IHRoaXMuc2lnbmFsCiAgICB9KS50aGVuKGFzeW5jIChyZXMkMSkgPT4gewogICAgICBsZXQgZXJyb3IgPSBudWxsOwogICAgICBsZXQgZGF0YSA9IG51bGw7CiAgICAgIGxldCBjb3VudCA9IG51bGw7CiAgICAgIGxldCBzdGF0dXMgPSByZXMkMS5zdGF0dXM7CiAgICAgIGxldCBzdGF0dXNUZXh0ID0gcmVzJDEuc3RhdHVzVGV4dDsKICAgICAgaWYgKHJlcyQxLm9rKSB7CiAgICAgICAgdmFyIF90aGlzJGhlYWRlcnMkZ2V0MiwgX3JlcyRoZWFkZXJzJGdldDsKICAgICAgICBpZiAoX3RoaXMubWV0aG9kICE9PSAiSEVBRCIpIHsKICAgICAgICAgIHZhciBfdGhpcyRoZWFkZXJzJGdldDsKICAgICAgICAgIGNvbnN0IGJvZHkgPSBhd2FpdCByZXMkMS50ZXh0KCk7CiAgICAgICAgICBpZiAoYm9keSA9PT0gIiIpIHsKICAgICAgICAgIH0gZWxzZSBpZiAoX3RoaXMuaGVhZGVycy5nZXQoIkFjY2VwdCIpID09PSAidGV4dC9jc3YiKSBkYXRhID0gYm9keTsKICAgICAgICAgIGVsc2UgaWYgKF90aGlzLmhlYWRlcnMuZ2V0KCJBY2NlcHQiKSAmJiAoKF90aGlzJGhlYWRlcnMkZ2V0ID0gX3RoaXMuaGVhZGVycy5nZXQoIkFjY2VwdCIpKSA9PT0gbnVsbCB8fCBfdGhpcyRoZWFkZXJzJGdldCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3RoaXMkaGVhZGVycyRnZXQuaW5jbHVkZXMoImFwcGxpY2F0aW9uL3ZuZC5wZ3JzdC5wbGFuK3RleHQiKSkpIGRhdGEgPSBib2R5OwogICAgICAgICAgZWxzZSBkYXRhID0gSlNPTi5wYXJzZShib2R5KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY291bnRIZWFkZXIgPSAoX3RoaXMkaGVhZGVycyRnZXQyID0gX3RoaXMuaGVhZGVycy5nZXQoIlByZWZlciIpKSA9PT0gbnVsbCB8fCBfdGhpcyRoZWFkZXJzJGdldDIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF90aGlzJGhlYWRlcnMkZ2V0Mi5tYXRjaCgvY291bnQ9KGV4YWN0fHBsYW5uZWR8ZXN0aW1hdGVkKS8pOwogICAgICAgIGNvbnN0IGNvbnRlbnRSYW5nZSA9IChfcmVzJGhlYWRlcnMkZ2V0ID0gcmVzJDEuaGVhZGVycy5nZXQoImNvbnRlbnQtcmFuZ2UiKSkgPT09IG51bGwgfHwgX3JlcyRoZWFkZXJzJGdldCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3JlcyRoZWFkZXJzJGdldC5zcGxpdCgiLyIpOwogICAgICAgIGlmIChjb3VudEhlYWRlciAmJiBjb250ZW50UmFuZ2UgJiYgY29udGVudFJhbmdlLmxlbmd0aCA+IDEpIGNvdW50ID0gcGFyc2VJbnQoY29udGVudFJhbmdlWzFdKTsKICAgICAgICBpZiAoX3RoaXMuaXNNYXliZVNpbmdsZSAmJiBfdGhpcy5tZXRob2QgPT09ICJHRVQiICYmIEFycmF5LmlzQXJyYXkoZGF0YSkpIGlmIChkYXRhLmxlbmd0aCA+IDEpIHsKICAgICAgICAgIGVycm9yID0gewogICAgICAgICAgICBjb2RlOiAiUEdSU1QxMTYiLAogICAgICAgICAgICBkZXRhaWxzOiBgUmVzdWx0cyBjb250YWluICR7ZGF0YS5sZW5ndGh9IHJvd3MsIGFwcGxpY2F0aW9uL3ZuZC5wZ3JzdC5vYmplY3QranNvbiByZXF1aXJlcyAxIHJvd2AsCiAgICAgICAgICAgIGhpbnQ6IG51bGwsCiAgICAgICAgICAgIG1lc3NhZ2U6ICJKU09OIG9iamVjdCByZXF1ZXN0ZWQsIG11bHRpcGxlIChvciBubykgcm93cyByZXR1cm5lZCIKICAgICAgICAgIH07CiAgICAgICAgICBkYXRhID0gbnVsbDsKICAgICAgICAgIGNvdW50ID0gbnVsbDsKICAgICAgICAgIHN0YXR1cyA9IDQwNjsKICAgICAgICAgIHN0YXR1c1RleHQgPSAiTm90IEFjY2VwdGFibGUiOwogICAgICAgIH0gZWxzZSBpZiAoZGF0YS5sZW5ndGggPT09IDEpIGRhdGEgPSBkYXRhWzBdOwogICAgICAgIGVsc2UgZGF0YSA9IG51bGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIF9lcnJvciRkZXRhaWxzOwogICAgICAgIGNvbnN0IGJvZHkgPSBhd2FpdCByZXMkMS50ZXh0KCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGVycm9yID0gSlNPTi5wYXJzZShib2R5KTsKICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGVycm9yKSAmJiByZXMkMS5zdGF0dXMgPT09IDQwNCkgewogICAgICAgICAgICBkYXRhID0gW107CiAgICAgICAgICAgIGVycm9yID0gbnVsbDsKICAgICAgICAgICAgc3RhdHVzID0gMjAwOwogICAgICAgICAgICBzdGF0dXNUZXh0ID0gIk9LIjsKICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChfdW51c2VkKSB7CiAgICAgICAgICBpZiAocmVzJDEuc3RhdHVzID09PSA0MDQgJiYgYm9keSA9PT0gIiIpIHsKICAgICAgICAgICAgc3RhdHVzID0gMjA0OwogICAgICAgICAgICBzdGF0dXNUZXh0ID0gIk5vIENvbnRlbnQiOwogICAgICAgICAgfSBlbHNlIGVycm9yID0geyBtZXNzYWdlOiBib2R5IH07CiAgICAgICAgfQogICAgICAgIGlmIChlcnJvciAmJiBfdGhpcy5pc01heWJlU2luZ2xlICYmIChlcnJvciA9PT0gbnVsbCB8fCBlcnJvciA9PT0gdm9pZCAwIHx8IChfZXJyb3IkZGV0YWlscyA9IGVycm9yLmRldGFpbHMpID09PSBudWxsIHx8IF9lcnJvciRkZXRhaWxzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZXJyb3IkZGV0YWlscy5pbmNsdWRlcygiMCByb3dzIikpKSB7CiAgICAgICAgICBlcnJvciA9IG51bGw7CiAgICAgICAgICBzdGF0dXMgPSAyMDA7CiAgICAgICAgICBzdGF0dXNUZXh0ID0gIk9LIjsKICAgICAgICB9CiAgICAgICAgaWYgKGVycm9yICYmIF90aGlzLnNob3VsZFRocm93T25FcnJvcikgdGhyb3cgbmV3IFBvc3RncmVzdEVycm9yKGVycm9yKTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGVycm9yLAogICAgICAgIGRhdGEsCiAgICAgICAgY291bnQsCiAgICAgICAgc3RhdHVzLAogICAgICAgIHN0YXR1c1RleHQKICAgICAgfTsKICAgIH0pOwogICAgaWYgKCF0aGlzLnNob3VsZFRocm93T25FcnJvcikgcmVzID0gcmVzLmNhdGNoKChmZXRjaEVycm9yKSA9PiB7CiAgICAgIHZhciBfZmV0Y2hFcnJvciRuYW1lMjsKICAgICAgbGV0IGVycm9yRGV0YWlscyA9ICIiOwogICAgICBsZXQgaGludCA9ICIiOwogICAgICBsZXQgY29kZSA9ICIiOwogICAgICBjb25zdCBjYXVzZSA9IGZldGNoRXJyb3IgPT09IG51bGwgfHwgZmV0Y2hFcnJvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmV0Y2hFcnJvci5jYXVzZTsKICAgICAgaWYgKGNhdXNlKSB7CiAgICAgICAgdmFyIF9jYXVzZSRtZXNzYWdlLCBfY2F1c2UkY29kZSwgX2ZldGNoRXJyb3IkbmFtZSwgX2NhdXNlJG5hbWU7CiAgICAgICAgY29uc3QgY2F1c2VNZXNzYWdlID0gKF9jYXVzZSRtZXNzYWdlID0gY2F1c2UgPT09IG51bGwgfHwgY2F1c2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNhdXNlLm1lc3NhZ2UpICE9PSBudWxsICYmIF9jYXVzZSRtZXNzYWdlICE9PSB2b2lkIDAgPyBfY2F1c2UkbWVzc2FnZSA6ICIiOwogICAgICAgIGNvbnN0IGNhdXNlQ29kZSA9IChfY2F1c2UkY29kZSA9IGNhdXNlID09PSBudWxsIHx8IGNhdXNlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjYXVzZS5jb2RlKSAhPT0gbnVsbCAmJiBfY2F1c2UkY29kZSAhPT0gdm9pZCAwID8gX2NhdXNlJGNvZGUgOiAiIjsKICAgICAgICBlcnJvckRldGFpbHMgPSBgJHsoX2ZldGNoRXJyb3IkbmFtZSA9IGZldGNoRXJyb3IgPT09IG51bGwgfHwgZmV0Y2hFcnJvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmV0Y2hFcnJvci5uYW1lKSAhPT0gbnVsbCAmJiBfZmV0Y2hFcnJvciRuYW1lICE9PSB2b2lkIDAgPyBfZmV0Y2hFcnJvciRuYW1lIDogIkZldGNoRXJyb3IifTogJHtmZXRjaEVycm9yID09PSBudWxsIHx8IGZldGNoRXJyb3IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGZldGNoRXJyb3IubWVzc2FnZX1gOwogICAgICAgIGVycm9yRGV0YWlscyArPSBgCgpDYXVzZWQgYnk6ICR7KF9jYXVzZSRuYW1lID0gY2F1c2UgPT09IG51bGwgfHwgY2F1c2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNhdXNlLm5hbWUpICE9PSBudWxsICYmIF9jYXVzZSRuYW1lICE9PSB2b2lkIDAgPyBfY2F1c2UkbmFtZSA6ICJFcnJvciJ9OiAke2NhdXNlTWVzc2FnZX1gOwogICAgICAgIGlmIChjYXVzZUNvZGUpIGVycm9yRGV0YWlscyArPSBgICgke2NhdXNlQ29kZX0pYDsKICAgICAgICBpZiAoY2F1c2UgPT09IG51bGwgfHwgY2F1c2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNhdXNlLnN0YWNrKSBlcnJvckRldGFpbHMgKz0gYAoke2NhdXNlLnN0YWNrfWA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIF9mZXRjaEVycm9yJHN0YWNrOwogICAgICAgIGVycm9yRGV0YWlscyA9IChfZmV0Y2hFcnJvciRzdGFjayA9IGZldGNoRXJyb3IgPT09IG51bGwgfHwgZmV0Y2hFcnJvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmV0Y2hFcnJvci5zdGFjaykgIT09IG51bGwgJiYgX2ZldGNoRXJyb3Ikc3RhY2sgIT09IHZvaWQgMCA/IF9mZXRjaEVycm9yJHN0YWNrIDogIiI7CiAgICAgIH0KICAgICAgY29uc3QgdXJsTGVuZ3RoID0gdGhpcy51cmwudG9TdHJpbmcoKS5sZW5ndGg7CiAgICAgIGlmICgoZmV0Y2hFcnJvciA9PT0gbnVsbCB8fCBmZXRjaEVycm9yID09PSB2b2lkIDAgPyB2b2lkIDAgOiBmZXRjaEVycm9yLm5hbWUpID09PSAiQWJvcnRFcnJvciIgfHwgKGZldGNoRXJyb3IgPT09IG51bGwgfHwgZmV0Y2hFcnJvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmV0Y2hFcnJvci5jb2RlKSA9PT0gIkFCT1JUX0VSUiIpIHsKICAgICAgICBjb2RlID0gIiI7CiAgICAgICAgaGludCA9ICJSZXF1ZXN0IHdhcyBhYm9ydGVkICh0aW1lb3V0IG9yIG1hbnVhbCBjYW5jZWxsYXRpb24pIjsKICAgICAgICBpZiAodXJsTGVuZ3RoID4gdGhpcy51cmxMZW5ndGhMaW1pdCkgaGludCArPSBgLiBOb3RlOiBZb3VyIHJlcXVlc3QgVVJMIGlzICR7dXJsTGVuZ3RofSBjaGFyYWN0ZXJzLCB3aGljaCBtYXkgZXhjZWVkIHNlcnZlciBsaW1pdHMuIElmIHNlbGVjdGluZyBtYW55IGZpZWxkcywgY29uc2lkZXIgdXNpbmcgdmlld3MuIElmIGZpbHRlcmluZyB3aXRoIGxhcmdlIGFycmF5cyAoZS5nLiwgLmluKCdpZCcsIFttYW55IElEc10pKSwgY29uc2lkZXIgdXNpbmcgYW4gUlBDIGZ1bmN0aW9uIHRvIHBhc3MgdmFsdWVzIHNlcnZlci1zaWRlLmA7CiAgICAgIH0gZWxzZSBpZiAoKGNhdXNlID09PSBudWxsIHx8IGNhdXNlID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjYXVzZS5uYW1lKSA9PT0gIkhlYWRlcnNPdmVyZmxvd0Vycm9yIiB8fCAoY2F1c2UgPT09IG51bGwgfHwgY2F1c2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNhdXNlLmNvZGUpID09PSAiVU5EX0VSUl9IRUFERVJTX09WRVJGTE9XIikgewogICAgICAgIGNvZGUgPSAiIjsKICAgICAgICBoaW50ID0gIkhUVFAgaGVhZGVycyBleGNlZWRlZCBzZXJ2ZXIgbGltaXRzICh0eXBpY2FsbHkgMTZLQikiOwogICAgICAgIGlmICh1cmxMZW5ndGggPiB0aGlzLnVybExlbmd0aExpbWl0KSBoaW50ICs9IGAuIFlvdXIgcmVxdWVzdCBVUkwgaXMgJHt1cmxMZW5ndGh9IGNoYXJhY3RlcnMuIElmIHNlbGVjdGluZyBtYW55IGZpZWxkcywgY29uc2lkZXIgdXNpbmcgdmlld3MuIElmIGZpbHRlcmluZyB3aXRoIGxhcmdlIGFycmF5cyAoZS5nLiwgLmluKCdpZCcsIFsyMDArIElEc10pKSwgY29uc2lkZXIgdXNpbmcgYW4gUlBDIGZ1bmN0aW9uIGluc3RlYWQuYDsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGVycm9yOiB7CiAgICAgICAgICBtZXNzYWdlOiBgJHsoX2ZldGNoRXJyb3IkbmFtZTIgPSBmZXRjaEVycm9yID09PSBudWxsIHx8IGZldGNoRXJyb3IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGZldGNoRXJyb3IubmFtZSkgIT09IG51bGwgJiYgX2ZldGNoRXJyb3IkbmFtZTIgIT09IHZvaWQgMCA/IF9mZXRjaEVycm9yJG5hbWUyIDogIkZldGNoRXJyb3IifTogJHtmZXRjaEVycm9yID09PSBudWxsIHx8IGZldGNoRXJyb3IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGZldGNoRXJyb3IubWVzc2FnZX1gLAogICAgICAgICAgZGV0YWlsczogZXJyb3JEZXRhaWxzLAogICAgICAgICAgaGludCwKICAgICAgICAgIGNvZGUKICAgICAgICB9LAogICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgY291bnQ6IG51bGwsCiAgICAgICAgc3RhdHVzOiAwLAogICAgICAgIHN0YXR1c1RleHQ6ICIiCiAgICAgIH07CiAgICB9KTsKICAgIHJldHVybiByZXMudGhlbihvbmZ1bGZpbGxlZCwgb25yZWplY3RlZCk7CiAgfQogIC8qKgogICogT3ZlcnJpZGUgdGhlIHR5cGUgb2YgdGhlIHJldHVybmVkIGBkYXRhYC4KICAqCiAgKiBAdHlwZVBhcmFtIE5ld1Jlc3VsdCAtIFRoZSBuZXcgcmVzdWx0IHR5cGUgdG8gb3ZlcnJpZGUgd2l0aAogICogQGRlcHJlY2F0ZWQgVXNlIG92ZXJyaWRlVHlwZXM8eW91clR5cGUsIHsgbWVyZ2U6IGZhbHNlIH0+KCkgbWV0aG9kIGF0IHRoZSBlbmQgb2YgeW91ciBjYWxsIGNoYWluIGluc3RlYWQKICAqLwogIHJldHVybnMoKSB7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBPdmVycmlkZSB0aGUgdHlwZSBvZiB0aGUgcmV0dXJuZWQgYGRhdGFgIGZpZWxkIGluIHRoZSByZXNwb25zZS4KICAqCiAgKiBAdHlwZVBhcmFtIE5ld1Jlc3VsdCAtIFRoZSBuZXcgdHlwZSB0byBjYXN0IHRoZSByZXNwb25zZSBkYXRhIHRvCiAgKiBAdHlwZVBhcmFtIE9wdGlvbnMgLSBPcHRpb25hbCB0eXBlIGNvbmZpZ3VyYXRpb24gKGRlZmF1bHRzIHRvIHsgbWVyZ2U6IHRydWUgfSkKICAqIEB0eXBlUGFyYW0gT3B0aW9ucy5tZXJnZSAtIFdoZW4gdHJ1ZSwgbWVyZ2VzIHRoZSBuZXcgdHlwZSB3aXRoIGV4aXN0aW5nIHJldHVybiB0eXBlLiBXaGVuIGZhbHNlLCByZXBsYWNlcyB0aGUgZXhpc3RpbmcgdHlwZXMgZW50aXJlbHkgKGRlZmF1bHRzIHRvIHRydWUpCiAgKiBAZXhhbXBsZQogICogYGBgdHlwZXNjcmlwdAogICogLy8gTWVyZ2Ugd2l0aCBleGlzdGluZyB0eXBlcyAoZGVmYXVsdCBiZWhhdmlvcikKICAqIGNvbnN0IHF1ZXJ5ID0gc3VwYWJhc2UKICAqICAgLmZyb20oJ3VzZXJzJykKICAqICAgLnNlbGVjdCgpCiAgKiAgIC5vdmVycmlkZVR5cGVzPHsgY3VzdG9tX2ZpZWxkOiBzdHJpbmcgfT4oKQogICoKICAqIC8vIFJlcGxhY2UgZXhpc3RpbmcgdHlwZXMgY29tcGxldGVseQogICogY29uc3QgcmVwbGFjZVF1ZXJ5ID0gc3VwYWJhc2UKICAqICAgLmZyb20oJ3VzZXJzJykKICAqICAgLnNlbGVjdCgpCiAgKiAgIC5vdmVycmlkZVR5cGVzPHsgaWQ6IG51bWJlcjsgbmFtZTogc3RyaW5nIH0sIHsgbWVyZ2U6IGZhbHNlIH0+KCkKICAqIGBgYAogICogQHJldHVybnMgQSBQb3N0Z3Jlc3RCdWlsZGVyIGluc3RhbmNlIHdpdGggdGhlIG5ldyB0eXBlCiAgKi8KICBvdmVycmlkZVR5cGVzKCkgewogICAgcmV0dXJuIHRoaXM7CiAgfQp9Owp2YXIgUG9zdGdyZXN0VHJhbnNmb3JtQnVpbGRlciA9IGNsYXNzIGV4dGVuZHMgUG9zdGdyZXN0QnVpbGRlciB7CiAgLyoqCiAgKiBQZXJmb3JtIGEgU0VMRUNUIG9uIHRoZSBxdWVyeSByZXN1bHQuCiAgKgogICogQnkgZGVmYXVsdCwgYC5pbnNlcnQoKWAsIGAudXBkYXRlKClgLCBgLnVwc2VydCgpYCwgYW5kIGAuZGVsZXRlKClgIGRvIG5vdAogICogcmV0dXJuIG1vZGlmaWVkIHJvd3MuIEJ5IGNhbGxpbmcgdGhpcyBtZXRob2QsIG1vZGlmaWVkIHJvd3MgYXJlIHJldHVybmVkIGluCiAgKiBgZGF0YWAuCiAgKgogICogQHBhcmFtIGNvbHVtbnMgLSBUaGUgY29sdW1ucyB0byByZXRyaWV2ZSwgc2VwYXJhdGVkIGJ5IGNvbW1hcwogICovCiAgc2VsZWN0KGNvbHVtbnMpIHsKICAgIGxldCBxdW90ZWQgPSBmYWxzZTsKICAgIGNvbnN0IGNsZWFuZWRDb2x1bW5zID0gKGNvbHVtbnMgIT09IG51bGwgJiYgY29sdW1ucyAhPT0gdm9pZCAwID8gY29sdW1ucyA6ICIqIikuc3BsaXQoIiIpLm1hcCgoYykgPT4gewogICAgICBpZiAoL1xzLy50ZXN0KGMpICYmICFxdW90ZWQpIHJldHVybiAiIjsKICAgICAgaWYgKGMgPT09ICciJykgcXVvdGVkID0gIXF1b3RlZDsKICAgICAgcmV0dXJuIGM7CiAgICB9KS5qb2luKCIiKTsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5zZXQoInNlbGVjdCIsIGNsZWFuZWRDb2x1bW5zKTsKICAgIHRoaXMuaGVhZGVycy5hcHBlbmQoIlByZWZlciIsICJyZXR1cm49cmVwcmVzZW50YXRpb24iKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE9yZGVyIHRoZSBxdWVyeSByZXN1bHQgYnkgYGNvbHVtbmAuCiAgKgogICogWW91IGNhbiBjYWxsIHRoaXMgbWV0aG9kIG11bHRpcGxlIHRpbWVzIHRvIG9yZGVyIGJ5IG11bHRpcGxlIGNvbHVtbnMuCiAgKgogICogWW91IGNhbiBvcmRlciByZWZlcmVuY2VkIHRhYmxlcywgYnV0IGl0IG9ubHkgYWZmZWN0cyB0aGUgb3JkZXJpbmcgb2YgdGhlCiAgKiBwYXJlbnQgdGFibGUgaWYgeW91IHVzZSBgIWlubmVyYCBpbiB0aGUgcXVlcnkuCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSBjb2x1bW4gdG8gb3JkZXIgYnkKICAqIEBwYXJhbSBvcHRpb25zIC0gTmFtZWQgcGFyYW1ldGVycwogICogQHBhcmFtIG9wdGlvbnMuYXNjZW5kaW5nIC0gSWYgYHRydWVgLCB0aGUgcmVzdWx0IHdpbGwgYmUgaW4gYXNjZW5kaW5nIG9yZGVyCiAgKiBAcGFyYW0gb3B0aW9ucy5udWxsc0ZpcnN0IC0gSWYgYHRydWVgLCBgbnVsbGBzIGFwcGVhciBmaXJzdC4gSWYgYGZhbHNlYCwKICAqIGBudWxsYHMgYXBwZWFyIGxhc3QuCiAgKiBAcGFyYW0gb3B0aW9ucy5yZWZlcmVuY2VkVGFibGUgLSBTZXQgdGhpcyB0byBvcmRlciBhIHJlZmVyZW5jZWQgdGFibGUgYnkKICAqIGl0cyBjb2x1bW5zCiAgKiBAcGFyYW0gb3B0aW9ucy5mb3JlaWduVGFibGUgLSBEZXByZWNhdGVkLCB1c2UgYG9wdGlvbnMucmVmZXJlbmNlZFRhYmxlYAogICogaW5zdGVhZAogICovCiAgb3JkZXIoY29sdW1uLCB7IGFzY2VuZGluZzogYXNjZW5kaW5nMiA9IHRydWUsIG51bGxzRmlyc3QsIGZvcmVpZ25UYWJsZSwgcmVmZXJlbmNlZFRhYmxlID0gZm9yZWlnblRhYmxlIH0gPSB7fSkgewogICAgY29uc3Qga2V5ID0gcmVmZXJlbmNlZFRhYmxlID8gYCR7cmVmZXJlbmNlZFRhYmxlfS5vcmRlcmAgOiAib3JkZXIiOwogICAgY29uc3QgZXhpc3RpbmdPcmRlciA9IHRoaXMudXJsLnNlYXJjaFBhcmFtcy5nZXQoa2V5KTsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5zZXQoa2V5LCBgJHtleGlzdGluZ09yZGVyID8gYCR7ZXhpc3RpbmdPcmRlcn0sYCA6ICIifSR7Y29sdW1ufS4ke2FzY2VuZGluZzIgPyAiYXNjIiA6ICJkZXNjIn0ke251bGxzRmlyc3QgPT09IHZvaWQgMCA/ICIiIDogbnVsbHNGaXJzdCA/ICIubnVsbHNmaXJzdCIgOiAiLm51bGxzbGFzdCJ9YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBMaW1pdCB0aGUgcXVlcnkgcmVzdWx0IGJ5IGBjb3VudGAuCiAgKgogICogQHBhcmFtIGNvdW50IC0gVGhlIG1heGltdW0gbnVtYmVyIG9mIHJvd3MgdG8gcmV0dXJuCiAgKiBAcGFyYW0gb3B0aW9ucyAtIE5hbWVkIHBhcmFtZXRlcnMKICAqIEBwYXJhbSBvcHRpb25zLnJlZmVyZW5jZWRUYWJsZSAtIFNldCB0aGlzIHRvIGxpbWl0IHJvd3Mgb2YgcmVmZXJlbmNlZAogICogdGFibGVzIGluc3RlYWQgb2YgdGhlIHBhcmVudCB0YWJsZQogICogQHBhcmFtIG9wdGlvbnMuZm9yZWlnblRhYmxlIC0gRGVwcmVjYXRlZCwgdXNlIGBvcHRpb25zLnJlZmVyZW5jZWRUYWJsZWAKICAqIGluc3RlYWQKICAqLwogIGxpbWl0KGNvdW50LCB7IGZvcmVpZ25UYWJsZSwgcmVmZXJlbmNlZFRhYmxlID0gZm9yZWlnblRhYmxlIH0gPSB7fSkgewogICAgY29uc3Qga2V5ID0gdHlwZW9mIHJlZmVyZW5jZWRUYWJsZSA9PT0gInVuZGVmaW5lZCIgPyAibGltaXQiIDogYCR7cmVmZXJlbmNlZFRhYmxlfS5saW1pdGA7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuc2V0KGtleSwgYCR7Y291bnR9YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBMaW1pdCB0aGUgcXVlcnkgcmVzdWx0IGJ5IHN0YXJ0aW5nIGF0IGFuIG9mZnNldCBgZnJvbWAgYW5kIGVuZGluZyBhdCB0aGUgb2Zmc2V0IGB0b2AuCiAgKiBPbmx5IHJlY29yZHMgd2l0aGluIHRoaXMgcmFuZ2UgYXJlIHJldHVybmVkLgogICogVGhpcyByZXNwZWN0cyB0aGUgcXVlcnkgb3JkZXIgYW5kIGlmIHRoZXJlIGlzIG5vIG9yZGVyIGNsYXVzZSB0aGUgcmFuZ2UgY291bGQgYmVoYXZlIHVuZXhwZWN0ZWRseS4KICAqIFRoZSBgZnJvbWAgYW5kIGB0b2AgdmFsdWVzIGFyZSAwLWJhc2VkIGFuZCBpbmNsdXNpdmU6IGByYW5nZSgxLCAzKWAgd2lsbCBpbmNsdWRlIHRoZSBzZWNvbmQsIHRoaXJkCiAgKiBhbmQgZm91cnRoIHJvd3Mgb2YgdGhlIHF1ZXJ5LgogICoKICAqIEBwYXJhbSBmcm9tIC0gVGhlIHN0YXJ0aW5nIGluZGV4IGZyb20gd2hpY2ggdG8gbGltaXQgdGhlIHJlc3VsdAogICogQHBhcmFtIHRvIC0gVGhlIGxhc3QgaW5kZXggdG8gd2hpY2ggdG8gbGltaXQgdGhlIHJlc3VsdAogICogQHBhcmFtIG9wdGlvbnMgLSBOYW1lZCBwYXJhbWV0ZXJzCiAgKiBAcGFyYW0gb3B0aW9ucy5yZWZlcmVuY2VkVGFibGUgLSBTZXQgdGhpcyB0byBsaW1pdCByb3dzIG9mIHJlZmVyZW5jZWQKICAqIHRhYmxlcyBpbnN0ZWFkIG9mIHRoZSBwYXJlbnQgdGFibGUKICAqIEBwYXJhbSBvcHRpb25zLmZvcmVpZ25UYWJsZSAtIERlcHJlY2F0ZWQsIHVzZSBgb3B0aW9ucy5yZWZlcmVuY2VkVGFibGVgCiAgKiBpbnN0ZWFkCiAgKi8KICByYW5nZShmcm9tMiwgdG8yLCB7IGZvcmVpZ25UYWJsZSwgcmVmZXJlbmNlZFRhYmxlID0gZm9yZWlnblRhYmxlIH0gPSB7fSkgewogICAgY29uc3Qga2V5T2Zmc2V0ID0gdHlwZW9mIHJlZmVyZW5jZWRUYWJsZSA9PT0gInVuZGVmaW5lZCIgPyAib2Zmc2V0IiA6IGAke3JlZmVyZW5jZWRUYWJsZX0ub2Zmc2V0YDsKICAgIGNvbnN0IGtleUxpbWl0ID0gdHlwZW9mIHJlZmVyZW5jZWRUYWJsZSA9PT0gInVuZGVmaW5lZCIgPyAibGltaXQiIDogYCR7cmVmZXJlbmNlZFRhYmxlfS5saW1pdGA7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuc2V0KGtleU9mZnNldCwgYCR7ZnJvbTJ9YCk7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuc2V0KGtleUxpbWl0LCBgJHt0bzIgLSBmcm9tMiArIDF9YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBTZXQgdGhlIEFib3J0U2lnbmFsIGZvciB0aGUgZmV0Y2ggcmVxdWVzdC4KICAqCiAgKiBAcGFyYW0gc2lnbmFsIC0gVGhlIEFib3J0U2lnbmFsIHRvIHVzZSBmb3IgdGhlIGZldGNoIHJlcXVlc3QKICAqLwogIGFib3J0U2lnbmFsKHNpZ25hbCkgewogICAgdGhpcy5zaWduYWwgPSBzaWduYWw7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBSZXR1cm4gYGRhdGFgIGFzIGEgc2luZ2xlIG9iamVjdCBpbnN0ZWFkIG9mIGFuIGFycmF5IG9mIG9iamVjdHMuCiAgKgogICogUXVlcnkgcmVzdWx0IG11c3QgYmUgb25lIHJvdyAoZS5nLiB1c2luZyBgLmxpbWl0KDEpYCksIG90aGVyd2lzZSB0aGlzCiAgKiByZXR1cm5zIGFuIGVycm9yLgogICovCiAgc2luZ2xlKCkgewogICAgdGhpcy5oZWFkZXJzLnNldCgiQWNjZXB0IiwgImFwcGxpY2F0aW9uL3ZuZC5wZ3JzdC5vYmplY3QranNvbiIpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogUmV0dXJuIGBkYXRhYCBhcyBhIHNpbmdsZSBvYmplY3QgaW5zdGVhZCBvZiBhbiBhcnJheSBvZiBvYmplY3RzLgogICoKICAqIFF1ZXJ5IHJlc3VsdCBtdXN0IGJlIHplcm8gb3Igb25lIHJvdyAoZS5nLiB1c2luZyBgLmxpbWl0KDEpYCksIG90aGVyd2lzZQogICogdGhpcyByZXR1cm5zIGFuIGVycm9yLgogICovCiAgbWF5YmVTaW5nbGUoKSB7CiAgICBpZiAodGhpcy5tZXRob2QgPT09ICJHRVQiKSB0aGlzLmhlYWRlcnMuc2V0KCJBY2NlcHQiLCAiYXBwbGljYXRpb24vanNvbiIpOwogICAgZWxzZSB0aGlzLmhlYWRlcnMuc2V0KCJBY2NlcHQiLCAiYXBwbGljYXRpb24vdm5kLnBncnN0Lm9iamVjdCtqc29uIik7CiAgICB0aGlzLmlzTWF5YmVTaW5nbGUgPSB0cnVlOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogUmV0dXJuIGBkYXRhYCBhcyBhIHN0cmluZyBpbiBDU1YgZm9ybWF0LgogICovCiAgY3N2KCkgewogICAgdGhpcy5oZWFkZXJzLnNldCgiQWNjZXB0IiwgInRleHQvY3N2Iik7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBSZXR1cm4gYGRhdGFgIGFzIGFuIG9iamVjdCBpbiBbR2VvSlNPTl0oaHR0cHM6Ly9nZW9qc29uLm9yZykgZm9ybWF0LgogICovCiAgZ2VvanNvbigpIHsKICAgIHRoaXMuaGVhZGVycy5zZXQoIkFjY2VwdCIsICJhcHBsaWNhdGlvbi9nZW8ranNvbiIpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogUmV0dXJuIGBkYXRhYCBhcyB0aGUgRVhQTEFJTiBwbGFuIGZvciB0aGUgcXVlcnkuCiAgKgogICogWW91IG5lZWQgdG8gZW5hYmxlIHRoZQogICogW2RiX3BsYW5fZW5hYmxlZF0oaHR0cHM6Ly9zdXBhYmFzZS5jb20vZG9jcy9ndWlkZXMvZGF0YWJhc2UvZGVidWdnaW5nLXBlcmZvcm1hbmNlI2VuYWJsaW5nLWV4cGxhaW4pCiAgKiBzZXR0aW5nIGJlZm9yZSB1c2luZyB0aGlzIG1ldGhvZC4KICAqCiAgKiBAcGFyYW0gb3B0aW9ucyAtIE5hbWVkIHBhcmFtZXRlcnMKICAqCiAgKiBAcGFyYW0gb3B0aW9ucy5hbmFseXplIC0gSWYgYHRydWVgLCB0aGUgcXVlcnkgd2lsbCBiZSBleGVjdXRlZCBhbmQgdGhlCiAgKiBhY3R1YWwgcnVuIHRpbWUgd2lsbCBiZSByZXR1cm5lZAogICoKICAqIEBwYXJhbSBvcHRpb25zLnZlcmJvc2UgLSBJZiBgdHJ1ZWAsIHRoZSBxdWVyeSBpZGVudGlmaWVyIHdpbGwgYmUgcmV0dXJuZWQKICAqIGFuZCBgZGF0YWAgd2lsbCBpbmNsdWRlIHRoZSBvdXRwdXQgY29sdW1ucyBvZiB0aGUgcXVlcnkKICAqCiAgKiBAcGFyYW0gb3B0aW9ucy5zZXR0aW5ncyAtIElmIGB0cnVlYCwgaW5jbHVkZSBpbmZvcm1hdGlvbiBvbiBjb25maWd1cmF0aW9uCiAgKiBwYXJhbWV0ZXJzIHRoYXQgYWZmZWN0IHF1ZXJ5IHBsYW5uaW5nCiAgKgogICogQHBhcmFtIG9wdGlvbnMuYnVmZmVycyAtIElmIGB0cnVlYCwgaW5jbHVkZSBpbmZvcm1hdGlvbiBvbiBidWZmZXIgdXNhZ2UKICAqCiAgKiBAcGFyYW0gb3B0aW9ucy53YWwgLSBJZiBgdHJ1ZWAsIGluY2x1ZGUgaW5mb3JtYXRpb24gb24gV0FMIHJlY29yZCBnZW5lcmF0aW9uCiAgKgogICogQHBhcmFtIG9wdGlvbnMuZm9ybWF0IC0gVGhlIGZvcm1hdCBvZiB0aGUgb3V0cHV0LCBjYW4gYmUgYCJ0ZXh0ImAgKGRlZmF1bHQpCiAgKiBvciBgImpzb24iYAogICovCiAgZXhwbGFpbih7IGFuYWx5emUgPSBmYWxzZSwgdmVyYm9zZSA9IGZhbHNlLCBzZXR0aW5ncyA9IGZhbHNlLCBidWZmZXJzID0gZmFsc2UsIHdhbCA9IGZhbHNlLCBmb3JtYXQ6IGZvcm1hdDIgPSAidGV4dCIgfSA9IHt9KSB7CiAgICB2YXIgX3RoaXMkaGVhZGVycyRnZXQ7CiAgICBjb25zdCBvcHRpb25zID0gWwogICAgICBhbmFseXplID8gImFuYWx5emUiIDogbnVsbCwKICAgICAgdmVyYm9zZSA/ICJ2ZXJib3NlIiA6IG51bGwsCiAgICAgIHNldHRpbmdzID8gInNldHRpbmdzIiA6IG51bGwsCiAgICAgIGJ1ZmZlcnMgPyAiYnVmZmVycyIgOiBudWxsLAogICAgICB3YWwgPyAid2FsIiA6IG51bGwKICAgIF0uZmlsdGVyKEJvb2xlYW4pLmpvaW4oInwiKTsKICAgIGNvbnN0IGZvck1lZGlhdHlwZSA9IChfdGhpcyRoZWFkZXJzJGdldCA9IHRoaXMuaGVhZGVycy5nZXQoIkFjY2VwdCIpKSAhPT0gbnVsbCAmJiBfdGhpcyRoZWFkZXJzJGdldCAhPT0gdm9pZCAwID8gX3RoaXMkaGVhZGVycyRnZXQgOiAiYXBwbGljYXRpb24vanNvbiI7CiAgICB0aGlzLmhlYWRlcnMuc2V0KCJBY2NlcHQiLCBgYXBwbGljYXRpb24vdm5kLnBncnN0LnBsYW4rJHtmb3JtYXQyfTsgZm9yPSIke2Zvck1lZGlhdHlwZX0iOyBvcHRpb25zPSR7b3B0aW9uc307YCk7CiAgICBpZiAoZm9ybWF0MiA9PT0gImpzb24iKSByZXR1cm4gdGhpczsKICAgIGVsc2UgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogUm9sbGJhY2sgdGhlIHF1ZXJ5LgogICoKICAqIGBkYXRhYCB3aWxsIHN0aWxsIGJlIHJldHVybmVkLCBidXQgdGhlIHF1ZXJ5IGlzIG5vdCBjb21taXR0ZWQuCiAgKi8KICByb2xsYmFjaygpIHsKICAgIHRoaXMuaGVhZGVycy5hcHBlbmQoIlByZWZlciIsICJ0eD1yb2xsYmFjayIpOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogT3ZlcnJpZGUgdGhlIHR5cGUgb2YgdGhlIHJldHVybmVkIGBkYXRhYC4KICAqCiAgKiBAdHlwZVBhcmFtIE5ld1Jlc3VsdCAtIFRoZSBuZXcgcmVzdWx0IHR5cGUgdG8gb3ZlcnJpZGUgd2l0aAogICogQGRlcHJlY2F0ZWQgVXNlIG92ZXJyaWRlVHlwZXM8eW91clR5cGUsIHsgbWVyZ2U6IGZhbHNlIH0+KCkgbWV0aG9kIGF0IHRoZSBlbmQgb2YgeW91ciBjYWxsIGNoYWluIGluc3RlYWQKICAqLwogIHJldHVybnMoKSB7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBTZXQgdGhlIG1heGltdW0gbnVtYmVyIG9mIHJvd3MgdGhhdCBjYW4gYmUgYWZmZWN0ZWQgYnkgdGhlIHF1ZXJ5LgogICogT25seSBhdmFpbGFibGUgaW4gUG9zdGdSRVNUIHYxMysgYW5kIG9ubHkgd29ya3Mgd2l0aCBQQVRDSCBhbmQgREVMRVRFIG1ldGhvZHMuCiAgKgogICogQHBhcmFtIHZhbHVlIC0gVGhlIG1heGltdW0gbnVtYmVyIG9mIHJvd3MgdGhhdCBjYW4gYmUgYWZmZWN0ZWQKICAqLwogIG1heEFmZmVjdGVkKHZhbHVlKSB7CiAgICB0aGlzLmhlYWRlcnMuYXBwZW5kKCJQcmVmZXIiLCAiaGFuZGxpbmc9c3RyaWN0Iik7CiAgICB0aGlzLmhlYWRlcnMuYXBwZW5kKCJQcmVmZXIiLCBgbWF4LWFmZmVjdGVkPSR7dmFsdWV9YCk7CiAgICByZXR1cm4gdGhpczsKICB9Cn07CnZhciBQb3N0Z3Jlc3RSZXNlcnZlZENoYXJzUmVnZXhwID0gLyogQF9fUFVSRV9fICovIG5ldyBSZWdFeHAoIlssKCldIik7CnZhciBQb3N0Z3Jlc3RGaWx0ZXJCdWlsZGVyID0gY2xhc3MgZXh0ZW5kcyBQb3N0Z3Jlc3RUcmFuc2Zvcm1CdWlsZGVyIHsKICAvKioKICAqIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBgY29sdW1uYCBpcyBlcXVhbCB0byBgdmFsdWVgLgogICoKICAqIFRvIGNoZWNrIGlmIHRoZSB2YWx1ZSBvZiBgY29sdW1uYCBpcyBOVUxMLCB5b3Ugc2hvdWxkIHVzZSBgLmlzKClgIGluc3RlYWQuCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gZmlsdGVyIHdpdGgKICAqLwogIGVxKGNvbHVtbiwgdmFsdWUpIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgZXEuJHt2YWx1ZX1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBgY29sdW1uYCBpcyBub3QgZXF1YWwgdG8gYHZhbHVlYC4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBmaWx0ZXIgd2l0aAogICovCiAgbmVxKGNvbHVtbiwgdmFsdWUpIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgbmVxLiR7dmFsdWV9YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUgYGNvbHVtbmAgaXMgZ3JlYXRlciB0aGFuIGB2YWx1ZWAuCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gZmlsdGVyIHdpdGgKICAqLwogIGd0KGNvbHVtbiwgdmFsdWUpIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgZ3QuJHt2YWx1ZX1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBgY29sdW1uYCBpcyBncmVhdGVyIHRoYW4gb3IgZXF1YWwgdG8gYHZhbHVlYC4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBmaWx0ZXIgd2l0aAogICovCiAgZ3RlKGNvbHVtbiwgdmFsdWUpIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgZ3RlLiR7dmFsdWV9YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUgYGNvbHVtbmAgaXMgbGVzcyB0aGFuIGB2YWx1ZWAuCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gZmlsdGVyIHdpdGgKICAqLwogIGx0KGNvbHVtbiwgdmFsdWUpIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgbHQuJHt2YWx1ZX1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBgY29sdW1uYCBpcyBsZXNzIHRoYW4gb3IgZXF1YWwgdG8gYHZhbHVlYC4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBmaWx0ZXIgd2l0aAogICovCiAgbHRlKGNvbHVtbiwgdmFsdWUpIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgbHRlLiR7dmFsdWV9YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUgYGNvbHVtbmAgbWF0Y2hlcyBgcGF0dGVybmAgY2FzZS1zZW5zaXRpdmVseS4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSBwYXR0ZXJuIC0gVGhlIHBhdHRlcm4gdG8gbWF0Y2ggd2l0aAogICovCiAgbGlrZShjb2x1bW4sIHBhdHRlcm4pIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgbGlrZS4ke3BhdHRlcm59YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUgYGNvbHVtbmAgbWF0Y2hlcyBhbGwgb2YgYHBhdHRlcm5zYCBjYXNlLXNlbnNpdGl2ZWx5LgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHBhdHRlcm5zIC0gVGhlIHBhdHRlcm5zIHRvIG1hdGNoIHdpdGgKICAqLwogIGxpa2VBbGxPZihjb2x1bW4sIHBhdHRlcm5zKSB7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYGxpa2UoYWxsKS57JHtwYXR0ZXJucy5qb2luKCIsIil9fWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogTWF0Y2ggb25seSByb3dzIHdoZXJlIGBjb2x1bW5gIG1hdGNoZXMgYW55IG9mIGBwYXR0ZXJuc2AgY2FzZS1zZW5zaXRpdmVseS4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSBwYXR0ZXJucyAtIFRoZSBwYXR0ZXJucyB0byBtYXRjaCB3aXRoCiAgKi8KICBsaWtlQW55T2YoY29sdW1uLCBwYXR0ZXJucykgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBsaWtlKGFueSkueyR7cGF0dGVybnMuam9pbigiLCIpfX1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBgY29sdW1uYCBtYXRjaGVzIGBwYXR0ZXJuYCBjYXNlLWluc2Vuc2l0aXZlbHkuCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gcGF0dGVybiAtIFRoZSBwYXR0ZXJuIHRvIG1hdGNoIHdpdGgKICAqLwogIGlsaWtlKGNvbHVtbiwgcGF0dGVybikgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBpbGlrZS4ke3BhdHRlcm59YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUgYGNvbHVtbmAgbWF0Y2hlcyBhbGwgb2YgYHBhdHRlcm5zYCBjYXNlLWluc2Vuc2l0aXZlbHkuCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gcGF0dGVybnMgLSBUaGUgcGF0dGVybnMgdG8gbWF0Y2ggd2l0aAogICovCiAgaWxpa2VBbGxPZihjb2x1bW4sIHBhdHRlcm5zKSB7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYGlsaWtlKGFsbCkueyR7cGF0dGVybnMuam9pbigiLCIpfX1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBgY29sdW1uYCBtYXRjaGVzIGFueSBvZiBgcGF0dGVybnNgIGNhc2UtaW5zZW5zaXRpdmVseS4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSBwYXR0ZXJucyAtIFRoZSBwYXR0ZXJucyB0byBtYXRjaCB3aXRoCiAgKi8KICBpbGlrZUFueU9mKGNvbHVtbiwgcGF0dGVybnMpIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgaWxpa2UoYW55KS57JHtwYXR0ZXJucy5qb2luKCIsIil9fWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogTWF0Y2ggb25seSByb3dzIHdoZXJlIGBjb2x1bW5gIG1hdGNoZXMgdGhlIFBvc3RncmVTUUwgcmVnZXggYHBhdHRlcm5gCiAgKiBjYXNlLXNlbnNpdGl2ZWx5ICh1c2luZyB0aGUgYH5gIG9wZXJhdG9yKS4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSBwYXR0ZXJuIC0gVGhlIFBvc3RncmVTUUwgcmVndWxhciBleHByZXNzaW9uIHBhdHRlcm4gdG8gbWF0Y2ggd2l0aAogICovCiAgcmVnZXhNYXRjaChjb2x1bW4sIHBhdHRlcm4pIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgbWF0Y2guJHtwYXR0ZXJufWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogTWF0Y2ggb25seSByb3dzIHdoZXJlIGBjb2x1bW5gIG1hdGNoZXMgdGhlIFBvc3RncmVTUUwgcmVnZXggYHBhdHRlcm5gCiAgKiBjYXNlLWluc2Vuc2l0aXZlbHkgKHVzaW5nIHRoZSBgfipgIG9wZXJhdG9yKS4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSBwYXR0ZXJuIC0gVGhlIFBvc3RncmVTUUwgcmVndWxhciBleHByZXNzaW9uIHBhdHRlcm4gdG8gbWF0Y2ggd2l0aAogICovCiAgcmVnZXhJTWF0Y2goY29sdW1uLCBwYXR0ZXJuKSB7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYGltYXRjaC4ke3BhdHRlcm59YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUgYGNvbHVtbmAgSVMgYHZhbHVlYC4KICAqCiAgKiBGb3Igbm9uLWJvb2xlYW4gY29sdW1ucywgdGhpcyBpcyBvbmx5IHJlbGV2YW50IGZvciBjaGVja2luZyBpZiB0aGUgdmFsdWUgb2YKICAqIGBjb2x1bW5gIGlzIE5VTEwgYnkgc2V0dGluZyBgdmFsdWVgIHRvIGBudWxsYC4KICAqCiAgKiBGb3IgYm9vbGVhbiBjb2x1bW5zLCB5b3UgY2FuIGFsc28gc2V0IGB2YWx1ZWAgdG8gYHRydWVgIG9yIGBmYWxzZWAgYW5kIGl0CiAgKiB3aWxsIGJlaGF2ZSB0aGUgc2FtZSB3YXkgYXMgYC5lcSgpYC4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBmaWx0ZXIgd2l0aAogICovCiAgaXMoY29sdW1uLCB2YWx1ZSkgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBpcy4ke3ZhbHVlfWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogTWF0Y2ggb25seSByb3dzIHdoZXJlIGBjb2x1bW5gIElTIERJU1RJTkNUIEZST00gYHZhbHVlYC4KICAqCiAgKiBVbmxpa2UgYC5uZXEoKWAsIHRoaXMgdHJlYXRzIGBOVUxMYCBhcyBhIGNvbXBhcmFibGUgdmFsdWUuIFR3byBgTlVMTGAgdmFsdWVzCiAgKiBhcmUgY29uc2lkZXJlZCBlcXVhbCAobm90IGRpc3RpbmN0KSwgYW5kIGNvbXBhcmluZyBgTlVMTGAgd2l0aCBhbnkgbm9uLU5VTEwKICAqIHZhbHVlIHJldHVybnMgdHJ1ZSAoZGlzdGluY3QpLgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHZhbHVlIC0gVGhlIHZhbHVlIHRvIGZpbHRlciB3aXRoCiAgKi8KICBpc0Rpc3RpbmN0KGNvbHVtbiwgdmFsdWUpIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgaXNkaXN0aW5jdC4ke3ZhbHVlfWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogTWF0Y2ggb25seSByb3dzIHdoZXJlIGBjb2x1bW5gIGlzIGluY2x1ZGVkIGluIHRoZSBgdmFsdWVzYCBhcnJheS4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSB2YWx1ZXMgLSBUaGUgdmFsdWVzIGFycmF5IHRvIGZpbHRlciB3aXRoCiAgKi8KICBpbihjb2x1bW4sIHZhbHVlcykgewogICAgY29uc3QgY2xlYW5lZFZhbHVlcyA9IEFycmF5LmZyb20obmV3IFNldCh2YWx1ZXMpKS5tYXAoKHMpID0+IHsKICAgICAgaWYgKHR5cGVvZiBzID09PSAic3RyaW5nIiAmJiBQb3N0Z3Jlc3RSZXNlcnZlZENoYXJzUmVnZXhwLnRlc3QocykpIHJldHVybiBgIiR7c30iYDsKICAgICAgZWxzZSByZXR1cm4gYCR7c31gOwogICAgfSkuam9pbigiLCIpOwogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBpbi4oJHtjbGVhbmVkVmFsdWVzfSlgKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBgY29sdW1uYCBpcyBOT1QgaW5jbHVkZWQgaW4gdGhlIGB2YWx1ZXNgIGFycmF5LgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHZhbHVlcyAtIFRoZSB2YWx1ZXMgYXJyYXkgdG8gZmlsdGVyIHdpdGgKICAqLwogIG5vdEluKGNvbHVtbiwgdmFsdWVzKSB7CiAgICBjb25zdCBjbGVhbmVkVmFsdWVzID0gQXJyYXkuZnJvbShuZXcgU2V0KHZhbHVlcykpLm1hcCgocykgPT4gewogICAgICBpZiAodHlwZW9mIHMgPT09ICJzdHJpbmciICYmIFBvc3RncmVzdFJlc2VydmVkQ2hhcnNSZWdleHAudGVzdChzKSkgcmV0dXJuIGAiJHtzfSJgOwogICAgICBlbHNlIHJldHVybiBgJHtzfWA7CiAgICB9KS5qb2luKCIsIik7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYG5vdC5pbi4oJHtjbGVhbmVkVmFsdWVzfSlgKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE9ubHkgcmVsZXZhbnQgZm9yIGpzb25iLCBhcnJheSwgYW5kIHJhbmdlIGNvbHVtbnMuIE1hdGNoIG9ubHkgcm93cyB3aGVyZQogICogYGNvbHVtbmAgY29udGFpbnMgZXZlcnkgZWxlbWVudCBhcHBlYXJpbmcgaW4gYHZhbHVlYC4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGpzb25iLCBhcnJheSwgb3IgcmFuZ2UgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHZhbHVlIC0gVGhlIGpzb25iLCBhcnJheSwgb3IgcmFuZ2UgdmFsdWUgdG8gZmlsdGVyIHdpdGgKICAqLwogIGNvbnRhaW5zKGNvbHVtbiwgdmFsdWUpIHsKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYGNzLiR7dmFsdWV9YCk7CiAgICBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBjcy57JHt2YWx1ZS5qb2luKCIsIil9fWApOwogICAgZWxzZSB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYGNzLiR7SlNPTi5zdHJpbmdpZnkodmFsdWUpfWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogT25seSByZWxldmFudCBmb3IganNvbmIsIGFycmF5LCBhbmQgcmFuZ2UgY29sdW1ucy4gTWF0Y2ggb25seSByb3dzIHdoZXJlCiAgKiBldmVyeSBlbGVtZW50IGFwcGVhcmluZyBpbiBgY29sdW1uYCBpcyBjb250YWluZWQgYnkgYHZhbHVlYC4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIGpzb25iLCBhcnJheSwgb3IgcmFuZ2UgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHZhbHVlIC0gVGhlIGpzb25iLCBhcnJheSwgb3IgcmFuZ2UgdmFsdWUgdG8gZmlsdGVyIHdpdGgKICAqLwogIGNvbnRhaW5lZEJ5KGNvbHVtbiwgdmFsdWUpIHsKICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYGNkLiR7dmFsdWV9YCk7CiAgICBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBjZC57JHt2YWx1ZS5qb2luKCIsIil9fWApOwogICAgZWxzZSB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYGNkLiR7SlNPTi5zdHJpbmdpZnkodmFsdWUpfWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogT25seSByZWxldmFudCBmb3IgcmFuZ2UgY29sdW1ucy4gTWF0Y2ggb25seSByb3dzIHdoZXJlIGV2ZXJ5IGVsZW1lbnQgaW4KICAqIGBjb2x1bW5gIGlzIGdyZWF0ZXIgdGhhbiBhbnkgZWxlbWVudCBpbiBgcmFuZ2VgLgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgcmFuZ2UgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHJhbmdlIC0gVGhlIHJhbmdlIHRvIGZpbHRlciB3aXRoCiAgKi8KICByYW5nZUd0KGNvbHVtbiwgcmFuZ2U0KSB7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYHNyLiR7cmFuZ2U0fWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogT25seSByZWxldmFudCBmb3IgcmFuZ2UgY29sdW1ucy4gTWF0Y2ggb25seSByb3dzIHdoZXJlIGV2ZXJ5IGVsZW1lbnQgaW4KICAqIGBjb2x1bW5gIGlzIGVpdGhlciBjb250YWluZWQgaW4gYHJhbmdlYCBvciBncmVhdGVyIHRoYW4gYW55IGVsZW1lbnQgaW4KICAqIGByYW5nZWAuCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSByYW5nZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gcmFuZ2UgLSBUaGUgcmFuZ2UgdG8gZmlsdGVyIHdpdGgKICAqLwogIHJhbmdlR3RlKGNvbHVtbiwgcmFuZ2U0KSB7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYG54bC4ke3JhbmdlNH1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE9ubHkgcmVsZXZhbnQgZm9yIHJhbmdlIGNvbHVtbnMuIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBldmVyeSBlbGVtZW50IGluCiAgKiBgY29sdW1uYCBpcyBsZXNzIHRoYW4gYW55IGVsZW1lbnQgaW4gYHJhbmdlYC4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIHJhbmdlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSByYW5nZSAtIFRoZSByYW5nZSB0byBmaWx0ZXIgd2l0aAogICovCiAgcmFuZ2VMdChjb2x1bW4sIHJhbmdlNCkgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBzbC4ke3JhbmdlNH1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAqIE9ubHkgcmVsZXZhbnQgZm9yIHJhbmdlIGNvbHVtbnMuIE1hdGNoIG9ubHkgcm93cyB3aGVyZSBldmVyeSBlbGVtZW50IGluCiAgKiBgY29sdW1uYCBpcyBlaXRoZXIgY29udGFpbmVkIGluIGByYW5nZWAgb3IgbGVzcyB0aGFuIGFueSBlbGVtZW50IGluCiAgKiBgcmFuZ2VgLgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgcmFuZ2UgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHJhbmdlIC0gVGhlIHJhbmdlIHRvIGZpbHRlciB3aXRoCiAgKi8KICByYW5nZUx0ZShjb2x1bW4sIHJhbmdlNCkgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBueHIuJHtyYW5nZTR9YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBPbmx5IHJlbGV2YW50IGZvciByYW5nZSBjb2x1bW5zLiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUgYGNvbHVtbmAgaXMKICAqIG11dHVhbGx5IGV4Y2x1c2l2ZSB0byBgcmFuZ2VgIGFuZCB0aGVyZSBjYW4gYmUgbm8gZWxlbWVudCBiZXR3ZWVuIHRoZSB0d28KICAqIHJhbmdlcy4KICAqCiAgKiBAcGFyYW0gY29sdW1uIC0gVGhlIHJhbmdlIGNvbHVtbiB0byBmaWx0ZXIgb24KICAqIEBwYXJhbSByYW5nZSAtIFRoZSByYW5nZSB0byBmaWx0ZXIgd2l0aAogICovCiAgcmFuZ2VBZGphY2VudChjb2x1bW4sIHJhbmdlNCkgewogICAgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBhZGouJHtyYW5nZTR9YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBPbmx5IHJlbGV2YW50IGZvciBhcnJheSBhbmQgcmFuZ2UgY29sdW1ucy4gTWF0Y2ggb25seSByb3dzIHdoZXJlCiAgKiBgY29sdW1uYCBhbmQgYHZhbHVlYCBoYXZlIGFuIGVsZW1lbnQgaW4gY29tbW9uLgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgYXJyYXkgb3IgcmFuZ2UgY29sdW1uIHRvIGZpbHRlciBvbgogICogQHBhcmFtIHZhbHVlIC0gVGhlIGFycmF5IG9yIHJhbmdlIHZhbHVlIHRvIGZpbHRlciB3aXRoCiAgKi8KICBvdmVybGFwcyhjb2x1bW4sIHZhbHVlKSB7CiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAic3RyaW5nIikgdGhpcy51cmwuc2VhcmNoUGFyYW1zLmFwcGVuZChjb2x1bW4sIGBvdi4ke3ZhbHVlfWApOwogICAgZWxzZSB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYG92Lnske3ZhbHVlLmpvaW4oIiwiKX19YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBPbmx5IHJlbGV2YW50IGZvciB0ZXh0IGFuZCB0c3ZlY3RvciBjb2x1bW5zLiBNYXRjaCBvbmx5IHJvd3Mgd2hlcmUKICAqIGBjb2x1bW5gIG1hdGNoZXMgdGhlIHF1ZXJ5IHN0cmluZyBpbiBgcXVlcnlgLgogICoKICAqIEBwYXJhbSBjb2x1bW4gLSBUaGUgdGV4dCBvciB0c3ZlY3RvciBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gcXVlcnkgLSBUaGUgcXVlcnkgdGV4dCB0byBtYXRjaCB3aXRoCiAgKiBAcGFyYW0gb3B0aW9ucyAtIE5hbWVkIHBhcmFtZXRlcnMKICAqIEBwYXJhbSBvcHRpb25zLmNvbmZpZyAtIFRoZSB0ZXh0IHNlYXJjaCBjb25maWd1cmF0aW9uIHRvIHVzZQogICogQHBhcmFtIG9wdGlvbnMudHlwZSAtIENoYW5nZSBob3cgdGhlIGBxdWVyeWAgdGV4dCBpcyBpbnRlcnByZXRlZAogICovCiAgdGV4dFNlYXJjaChjb2x1bW4sIHF1ZXJ5LCB7IGNvbmZpZywgdHlwZSB9ID0ge30pIHsKICAgIGxldCB0eXBlUGFydCA9ICIiOwogICAgaWYgKHR5cGUgPT09ICJwbGFpbiIpIHR5cGVQYXJ0ID0gInBsIjsKICAgIGVsc2UgaWYgKHR5cGUgPT09ICJwaHJhc2UiKSB0eXBlUGFydCA9ICJwaCI7CiAgICBlbHNlIGlmICh0eXBlID09PSAid2Vic2VhcmNoIikgdHlwZVBhcnQgPSAidyI7CiAgICBjb25zdCBjb25maWdQYXJ0ID0gY29uZmlnID09PSB2b2lkIDAgPyAiIiA6IGAoJHtjb25maWd9KWA7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGNvbHVtbiwgYCR7dHlwZVBhcnR9ZnRzJHtjb25maWdQYXJ0fS4ke3F1ZXJ5fWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogTWF0Y2ggb25seSByb3dzIHdoZXJlIGVhY2ggY29sdW1uIGluIGBxdWVyeWAga2V5cyBpcyBlcXVhbCB0byBpdHMKICAqIGFzc29jaWF0ZWQgdmFsdWUuIFNob3J0aGFuZCBmb3IgbXVsdGlwbGUgYC5lcSgpYHMuCiAgKgogICogQHBhcmFtIHF1ZXJ5IC0gVGhlIG9iamVjdCB0byBmaWx0ZXIgd2l0aCwgd2l0aCBjb2x1bW4gbmFtZXMgYXMga2V5cyBtYXBwZWQKICAqIHRvIHRoZWlyIGZpbHRlciB2YWx1ZXMKICAqLwogIG1hdGNoKHF1ZXJ5KSB7CiAgICBPYmplY3QuZW50cmllcyhxdWVyeSkuZm9yRWFjaCgoW2NvbHVtbiwgdmFsdWVdKSA9PiB7CiAgICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgZXEuJHt2YWx1ZX1gKTsKICAgIH0pOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogTWF0Y2ggb25seSByb3dzIHdoaWNoIGRvZXNuJ3Qgc2F0aXNmeSB0aGUgZmlsdGVyLgogICoKICAqIFVubGlrZSBtb3N0IGZpbHRlcnMsIGBvcGVhcmF0b3JgIGFuZCBgdmFsdWVgIGFyZSB1c2VkIGFzLWlzIGFuZCBuZWVkIHRvCiAgKiBmb2xsb3cgW1Bvc3RnUkVTVAogICogc3ludGF4XShodHRwczovL3Bvc3RncmVzdC5vcmcvZW4vc3RhYmxlL2FwaS5odG1sI29wZXJhdG9ycykuIFlvdSBhbHNvIG5lZWQKICAqIHRvIG1ha2Ugc3VyZSB0aGV5IGFyZSBwcm9wZXJseSBzYW5pdGl6ZWQuCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gb3BlcmF0b3IgLSBUaGUgb3BlcmF0b3IgdG8gYmUgbmVnYXRlZCB0byBmaWx0ZXIgd2l0aCwgZm9sbG93aW5nCiAgKiBQb3N0Z1JFU1Qgc3ludGF4CiAgKiBAcGFyYW0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gZmlsdGVyIHdpdGgsIGZvbGxvd2luZyBQb3N0Z1JFU1Qgc3ludGF4CiAgKi8KICBub3QoY29sdW1uLCBvcGVyYXRvciwgdmFsdWUpIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgbm90LiR7b3BlcmF0b3J9LiR7dmFsdWV9YCk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBNYXRjaCBvbmx5IHJvd3Mgd2hpY2ggc2F0aXNmeSBhdCBsZWFzdCBvbmUgb2YgdGhlIGZpbHRlcnMuCiAgKgogICogVW5saWtlIG1vc3QgZmlsdGVycywgYGZpbHRlcnNgIGlzIHVzZWQgYXMtaXMgYW5kIG5lZWRzIHRvIGZvbGxvdyBbUG9zdGdSRVNUCiAgKiBzeW50YXhdKGh0dHBzOi8vcG9zdGdyZXN0Lm9yZy9lbi9zdGFibGUvYXBpLmh0bWwjb3BlcmF0b3JzKS4gWW91IGFsc28gbmVlZAogICogdG8gbWFrZSBzdXJlIGl0J3MgcHJvcGVybHkgc2FuaXRpemVkLgogICoKICAqIEl0J3MgY3VycmVudGx5IG5vdCBwb3NzaWJsZSB0byBkbyBhbiBgLm9yKClgIGZpbHRlciBhY3Jvc3MgbXVsdGlwbGUgdGFibGVzLgogICoKICAqIEBwYXJhbSBmaWx0ZXJzIC0gVGhlIGZpbHRlcnMgdG8gdXNlLCBmb2xsb3dpbmcgUG9zdGdSRVNUIHN5bnRheAogICogQHBhcmFtIG9wdGlvbnMgLSBOYW1lZCBwYXJhbWV0ZXJzCiAgKiBAcGFyYW0gb3B0aW9ucy5yZWZlcmVuY2VkVGFibGUgLSBTZXQgdGhpcyB0byBmaWx0ZXIgb24gcmVmZXJlbmNlZCB0YWJsZXMKICAqIGluc3RlYWQgb2YgdGhlIHBhcmVudCB0YWJsZQogICogQHBhcmFtIG9wdGlvbnMuZm9yZWlnblRhYmxlIC0gRGVwcmVjYXRlZCwgdXNlIGByZWZlcmVuY2VkVGFibGVgIGluc3RlYWQKICAqLwogIG9yKGZpbHRlcnMsIHsgZm9yZWlnblRhYmxlLCByZWZlcmVuY2VkVGFibGUgPSBmb3JlaWduVGFibGUgfSA9IHt9KSB7CiAgICBjb25zdCBrZXkgPSByZWZlcmVuY2VkVGFibGUgPyBgJHtyZWZlcmVuY2VkVGFibGV9Lm9yYCA6ICJvciI7CiAgICB0aGlzLnVybC5zZWFyY2hQYXJhbXMuYXBwZW5kKGtleSwgYCgke2ZpbHRlcnN9KWApOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogTWF0Y2ggb25seSByb3dzIHdoaWNoIHNhdGlzZnkgdGhlIGZpbHRlci4gVGhpcyBpcyBhbiBlc2NhcGUgaGF0Y2ggLSB5b3UKICAqIHNob3VsZCB1c2UgdGhlIHNwZWNpZmljIGZpbHRlciBtZXRob2RzIHdoZXJldmVyIHBvc3NpYmxlLgogICoKICAqIFVubGlrZSBtb3N0IGZpbHRlcnMsIGBvcGVhcmF0b3JgIGFuZCBgdmFsdWVgIGFyZSB1c2VkIGFzLWlzIGFuZCBuZWVkIHRvCiAgKiBmb2xsb3cgW1Bvc3RnUkVTVAogICogc3ludGF4XShodHRwczovL3Bvc3RncmVzdC5vcmcvZW4vc3RhYmxlL2FwaS5odG1sI29wZXJhdG9ycykuIFlvdSBhbHNvIG5lZWQKICAqIHRvIG1ha2Ugc3VyZSB0aGV5IGFyZSBwcm9wZXJseSBzYW5pdGl6ZWQuCiAgKgogICogQHBhcmFtIGNvbHVtbiAtIFRoZSBjb2x1bW4gdG8gZmlsdGVyIG9uCiAgKiBAcGFyYW0gb3BlcmF0b3IgLSBUaGUgb3BlcmF0b3IgdG8gZmlsdGVyIHdpdGgsIGZvbGxvd2luZyBQb3N0Z1JFU1Qgc3ludGF4CiAgKiBAcGFyYW0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gZmlsdGVyIHdpdGgsIGZvbGxvd2luZyBQb3N0Z1JFU1Qgc3ludGF4CiAgKi8KICBmaWx0ZXIoY29sdW1uLCBvcGVyYXRvciwgdmFsdWUpIHsKICAgIHRoaXMudXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQoY29sdW1uLCBgJHtvcGVyYXRvcn0uJHt2YWx1ZX1gKTsKICAgIHJldHVybiB0aGlzOwogIH0KfTsKdmFyIFBvc3RncmVzdFF1ZXJ5QnVpbGRlciA9IGNsYXNzIHsKICAvKioKICAqIENyZWF0ZXMgYSBxdWVyeSBidWlsZGVyIHNjb3BlZCB0byBhIFBvc3RncmVzIHRhYmxlIG9yIHZpZXcuCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHRzCiAgKiBpbXBvcnQgUG9zdGdyZXN0UXVlcnlCdWlsZGVyIGZyb20gJ0BzdXBhYmFzZS9wb3N0Z3Jlc3QtanMnCiAgKgogICogY29uc3QgcXVlcnkgPSBuZXcgUG9zdGdyZXN0UXVlcnlCdWlsZGVyKAogICogICBuZXcgVVJMKCdodHRwczovL3h5emNvbXBhbnkuc3VwYWJhc2UuY28vcmVzdC92MS91c2VycycpLAogICogICB7IGhlYWRlcnM6IHsgYXBpa2V5OiAncHVibGljLWFub24ta2V5JyB9IH0KICAqICkKICAqIGBgYAogICovCiAgY29uc3RydWN0b3IodXJsLCB7IGhlYWRlcnMgPSB7fSwgc2NoZW1hLCBmZXRjaDogZmV0Y2gkMSwgdXJsTGVuZ3RoTGltaXQgPSA4ZTMgfSkgewogICAgdGhpcy51cmwgPSB1cmw7CiAgICB0aGlzLmhlYWRlcnMgPSBuZXcgSGVhZGVycyhoZWFkZXJzKTsKICAgIHRoaXMuc2NoZW1hID0gc2NoZW1hOwogICAgdGhpcy5mZXRjaCA9IGZldGNoJDE7CiAgICB0aGlzLnVybExlbmd0aExpbWl0ID0gdXJsTGVuZ3RoTGltaXQ7CiAgfQogIC8qKgogICogQ2xvbmUgVVJMIGFuZCBoZWFkZXJzIHRvIHByZXZlbnQgc2hhcmVkIHN0YXRlIGJldHdlZW4gb3BlcmF0aW9ucy4KICAqLwogIGNsb25lUmVxdWVzdFN0YXRlKCkgewogICAgcmV0dXJuIHsKICAgICAgdXJsOiBuZXcgVVJMKHRoaXMudXJsLnRvU3RyaW5nKCkpLAogICAgICBoZWFkZXJzOiBuZXcgSGVhZGVycyh0aGlzLmhlYWRlcnMpCiAgICB9OwogIH0KICAvKioKICAqIFBlcmZvcm0gYSBTRUxFQ1QgcXVlcnkgb24gdGhlIHRhYmxlIG9yIHZpZXcuCiAgKgogICogQHBhcmFtIGNvbHVtbnMgLSBUaGUgY29sdW1ucyB0byByZXRyaWV2ZSwgc2VwYXJhdGVkIGJ5IGNvbW1hcy4gQ29sdW1ucyBjYW4gYmUgcmVuYW1lZCB3aGVuIHJldHVybmVkIHdpdGggYGN1c3RvbU5hbWU6Y29sdW1uTmFtZWAKICAqCiAgKiBAcGFyYW0gb3B0aW9ucyAtIE5hbWVkIHBhcmFtZXRlcnMKICAqCiAgKiBAcGFyYW0gb3B0aW9ucy5oZWFkIC0gV2hlbiBzZXQgdG8gYHRydWVgLCBgZGF0YWAgd2lsbCBub3QgYmUgcmV0dXJuZWQuCiAgKiBVc2VmdWwgaWYgeW91IG9ubHkgbmVlZCB0aGUgY291bnQuCiAgKgogICogQHBhcmFtIG9wdGlvbnMuY291bnQgLSBDb3VudCBhbGdvcml0aG0gdG8gdXNlIHRvIGNvdW50IHJvd3MgaW4gdGhlIHRhYmxlIG9yIHZpZXcuCiAgKgogICogYCJleGFjdCJgOiBFeGFjdCBidXQgc2xvdyBjb3VudCBhbGdvcml0aG0uIFBlcmZvcm1zIGEgYENPVU5UKCopYCB1bmRlciB0aGUKICAqIGhvb2QuCiAgKgogICogYCJwbGFubmVkImA6IEFwcHJveGltYXRlZCBidXQgZmFzdCBjb3VudCBhbGdvcml0aG0uIFVzZXMgdGhlIFBvc3RncmVzCiAgKiBzdGF0aXN0aWNzIHVuZGVyIHRoZSBob29kLgogICoKICAqIGAiZXN0aW1hdGVkImA6IFVzZXMgZXhhY3QgY291bnQgZm9yIGxvdyBudW1iZXJzIGFuZCBwbGFubmVkIGNvdW50IGZvciBoaWdoCiAgKiBudW1iZXJzLgogICoKICAqIEByZW1hcmtzCiAgKiBXaGVuIHVzaW5nIGBjb3VudGAgd2l0aCBgLnJhbmdlKClgIG9yIGAubGltaXQoKWAsIHRoZSByZXR1cm5lZCBgY291bnRgIGlzIHRoZSB0b3RhbCBudW1iZXIgb2Ygcm93cwogICogdGhhdCBtYXRjaCB5b3VyIGZpbHRlcnMsIG5vdCB0aGUgbnVtYmVyIG9mIHJvd3MgaW4gdGhlIGN1cnJlbnQgcGFnZS4gVXNlIHRoaXMgdG8gYnVpbGQgcGFnaW5hdGlvbiBVSS4KICAqLwogIHNlbGVjdChjb2x1bW5zLCBvcHRpb25zKSB7CiAgICBjb25zdCB7IGhlYWQ6IGhlYWQyID0gZmFsc2UsIGNvdW50IH0gPSBvcHRpb25zICE9PSBudWxsICYmIG9wdGlvbnMgIT09IHZvaWQgMCA/IG9wdGlvbnMgOiB7fTsKICAgIGNvbnN0IG1ldGhvZCA9IGhlYWQyID8gIkhFQUQiIDogIkdFVCI7CiAgICBsZXQgcXVvdGVkID0gZmFsc2U7CiAgICBjb25zdCBjbGVhbmVkQ29sdW1ucyA9IChjb2x1bW5zICE9PSBudWxsICYmIGNvbHVtbnMgIT09IHZvaWQgMCA/IGNvbHVtbnMgOiAiKiIpLnNwbGl0KCIiKS5tYXAoKGMpID0+IHsKICAgICAgaWYgKC9ccy8udGVzdChjKSAmJiAhcXVvdGVkKSByZXR1cm4gIiI7CiAgICAgIGlmIChjID09PSAnIicpIHF1b3RlZCA9ICFxdW90ZWQ7CiAgICAgIHJldHVybiBjOwogICAgfSkuam9pbigiIik7CiAgICBjb25zdCB7IHVybCwgaGVhZGVycyB9ID0gdGhpcy5jbG9uZVJlcXVlc3RTdGF0ZSgpOwogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoInNlbGVjdCIsIGNsZWFuZWRDb2x1bW5zKTsKICAgIGlmIChjb3VudCkgaGVhZGVycy5hcHBlbmQoIlByZWZlciIsIGBjb3VudD0ke2NvdW50fWApOwogICAgcmV0dXJuIG5ldyBQb3N0Z3Jlc3RGaWx0ZXJCdWlsZGVyKHsKICAgICAgbWV0aG9kLAogICAgICB1cmwsCiAgICAgIGhlYWRlcnMsCiAgICAgIHNjaGVtYTogdGhpcy5zY2hlbWEsCiAgICAgIGZldGNoOiB0aGlzLmZldGNoLAogICAgICB1cmxMZW5ndGhMaW1pdDogdGhpcy51cmxMZW5ndGhMaW1pdAogICAgfSk7CiAgfQogIC8qKgogICogUGVyZm9ybSBhbiBJTlNFUlQgaW50byB0aGUgdGFibGUgb3Igdmlldy4KICAqCiAgKiBCeSBkZWZhdWx0LCBpbnNlcnRlZCByb3dzIGFyZSBub3QgcmV0dXJuZWQuIFRvIHJldHVybiBpdCwgY2hhaW4gdGhlIGNhbGwKICAqIHdpdGggYC5zZWxlY3QoKWAuCiAgKgogICogQHBhcmFtIHZhbHVlcyAtIFRoZSB2YWx1ZXMgdG8gaW5zZXJ0LiBQYXNzIGFuIG9iamVjdCB0byBpbnNlcnQgYSBzaW5nbGUgcm93CiAgKiBvciBhbiBhcnJheSB0byBpbnNlcnQgbXVsdGlwbGUgcm93cy4KICAqCiAgKiBAcGFyYW0gb3B0aW9ucyAtIE5hbWVkIHBhcmFtZXRlcnMKICAqCiAgKiBAcGFyYW0gb3B0aW9ucy5jb3VudCAtIENvdW50IGFsZ29yaXRobSB0byB1c2UgdG8gY291bnQgaW5zZXJ0ZWQgcm93cy4KICAqCiAgKiBgImV4YWN0ImA6IEV4YWN0IGJ1dCBzbG93IGNvdW50IGFsZ29yaXRobS4gUGVyZm9ybXMgYSBgQ09VTlQoKilgIHVuZGVyIHRoZQogICogaG9vZC4KICAqCiAgKiBgInBsYW5uZWQiYDogQXBwcm94aW1hdGVkIGJ1dCBmYXN0IGNvdW50IGFsZ29yaXRobS4gVXNlcyB0aGUgUG9zdGdyZXMKICAqIHN0YXRpc3RpY3MgdW5kZXIgdGhlIGhvb2QuCiAgKgogICogYCJlc3RpbWF0ZWQiYDogVXNlcyBleGFjdCBjb3VudCBmb3IgbG93IG51bWJlcnMgYW5kIHBsYW5uZWQgY291bnQgZm9yIGhpZ2gKICAqIG51bWJlcnMuCiAgKgogICogQHBhcmFtIG9wdGlvbnMuZGVmYXVsdFRvTnVsbCAtIE1ha2UgbWlzc2luZyBmaWVsZHMgZGVmYXVsdCB0byBgbnVsbGAuCiAgKiBPdGhlcndpc2UsIHVzZSB0aGUgZGVmYXVsdCB2YWx1ZSBmb3IgdGhlIGNvbHVtbi4gT25seSBhcHBsaWVzIGZvciBidWxrCiAgKiBpbnNlcnRzLgogICovCiAgaW5zZXJ0KHZhbHVlcywgeyBjb3VudCwgZGVmYXVsdFRvTnVsbCA9IHRydWUgfSA9IHt9KSB7CiAgICB2YXIgX3RoaXMkZmV0Y2g7CiAgICBjb25zdCBtZXRob2QgPSAiUE9TVCI7CiAgICBjb25zdCB7IHVybCwgaGVhZGVycyB9ID0gdGhpcy5jbG9uZVJlcXVlc3RTdGF0ZSgpOwogICAgaWYgKGNvdW50KSBoZWFkZXJzLmFwcGVuZCgiUHJlZmVyIiwgYGNvdW50PSR7Y291bnR9YCk7CiAgICBpZiAoIWRlZmF1bHRUb051bGwpIGhlYWRlcnMuYXBwZW5kKCJQcmVmZXIiLCBgbWlzc2luZz1kZWZhdWx0YCk7CiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZXMpKSB7CiAgICAgIGNvbnN0IGNvbHVtbnMgPSB2YWx1ZXMucmVkdWNlKChhY2MsIHgyKSA9PiBhY2MuY29uY2F0KE9iamVjdC5rZXlzKHgyKSksIFtdKTsKICAgICAgaWYgKGNvbHVtbnMubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnN0IHVuaXF1ZUNvbHVtbnMgPSBbLi4ubmV3IFNldChjb2x1bW5zKV0ubWFwKChjb2x1bW4pID0+IGAiJHtjb2x1bW59ImApOwogICAgICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCJjb2x1bW5zIiwgdW5pcXVlQ29sdW1ucy5qb2luKCIsIikpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gbmV3IFBvc3RncmVzdEZpbHRlckJ1aWxkZXIoewogICAgICBtZXRob2QsCiAgICAgIHVybCwKICAgICAgaGVhZGVycywKICAgICAgc2NoZW1hOiB0aGlzLnNjaGVtYSwKICAgICAgYm9keTogdmFsdWVzLAogICAgICBmZXRjaDogKF90aGlzJGZldGNoID0gdGhpcy5mZXRjaCkgIT09IG51bGwgJiYgX3RoaXMkZmV0Y2ggIT09IHZvaWQgMCA/IF90aGlzJGZldGNoIDogZmV0Y2gsCiAgICAgIHVybExlbmd0aExpbWl0OiB0aGlzLnVybExlbmd0aExpbWl0CiAgICB9KTsKICB9CiAgLyoqCiAgKiBQZXJmb3JtIGFuIFVQU0VSVCBvbiB0aGUgdGFibGUgb3Igdmlldy4gRGVwZW5kaW5nIG9uIHRoZSBjb2x1bW4ocykgcGFzc2VkCiAgKiB0byBgb25Db25mbGljdGAsIGAudXBzZXJ0KClgIGFsbG93cyB5b3UgdG8gcGVyZm9ybSB0aGUgZXF1aXZhbGVudCBvZgogICogYC5pbnNlcnQoKWAgaWYgYSByb3cgd2l0aCB0aGUgY29ycmVzcG9uZGluZyBgb25Db25mbGljdGAgY29sdW1ucyBkb2Vzbid0CiAgKiBleGlzdCwgb3IgaWYgaXQgZG9lcyBleGlzdCwgcGVyZm9ybSBhbiBhbHRlcm5hdGl2ZSBhY3Rpb24gZGVwZW5kaW5nIG9uCiAgKiBgaWdub3JlRHVwbGljYXRlc2AuCiAgKgogICogQnkgZGVmYXVsdCwgdXBzZXJ0ZWQgcm93cyBhcmUgbm90IHJldHVybmVkLiBUbyByZXR1cm4gaXQsIGNoYWluIHRoZSBjYWxsCiAgKiB3aXRoIGAuc2VsZWN0KClgLgogICoKICAqIEBwYXJhbSB2YWx1ZXMgLSBUaGUgdmFsdWVzIHRvIHVwc2VydCB3aXRoLiBQYXNzIGFuIG9iamVjdCB0byB1cHNlcnQgYQogICogc2luZ2xlIHJvdyBvciBhbiBhcnJheSB0byB1cHNlcnQgbXVsdGlwbGUgcm93cy4KICAqCiAgKiBAcGFyYW0gb3B0aW9ucyAtIE5hbWVkIHBhcmFtZXRlcnMKICAqCiAgKiBAcGFyYW0gb3B0aW9ucy5vbkNvbmZsaWN0IC0gQ29tbWEtc2VwYXJhdGVkIFVOSVFVRSBjb2x1bW4ocykgdG8gc3BlY2lmeSBob3cKICAqIGR1cGxpY2F0ZSByb3dzIGFyZSBkZXRlcm1pbmVkLiBUd28gcm93cyBhcmUgZHVwbGljYXRlcyBpZiBhbGwgdGhlCiAgKiBgb25Db25mbGljdGAgY29sdW1ucyBhcmUgZXF1YWwuCiAgKgogICogQHBhcmFtIG9wdGlvbnMuaWdub3JlRHVwbGljYXRlcyAtIElmIGB0cnVlYCwgZHVwbGljYXRlIHJvd3MgYXJlIGlnbm9yZWQuIElmCiAgKiBgZmFsc2VgLCBkdXBsaWNhdGUgcm93cyBhcmUgbWVyZ2VkIHdpdGggZXhpc3Rpbmcgcm93cy4KICAqCiAgKiBAcGFyYW0gb3B0aW9ucy5jb3VudCAtIENvdW50IGFsZ29yaXRobSB0byB1c2UgdG8gY291bnQgdXBzZXJ0ZWQgcm93cy4KICAqCiAgKiBgImV4YWN0ImA6IEV4YWN0IGJ1dCBzbG93IGNvdW50IGFsZ29yaXRobS4gUGVyZm9ybXMgYSBgQ09VTlQoKilgIHVuZGVyIHRoZQogICogaG9vZC4KICAqCiAgKiBgInBsYW5uZWQiYDogQXBwcm94aW1hdGVkIGJ1dCBmYXN0IGNvdW50IGFsZ29yaXRobS4gVXNlcyB0aGUgUG9zdGdyZXMKICAqIHN0YXRpc3RpY3MgdW5kZXIgdGhlIGhvb2QuCiAgKgogICogYCJlc3RpbWF0ZWQiYDogVXNlcyBleGFjdCBjb3VudCBmb3IgbG93IG51bWJlcnMgYW5kIHBsYW5uZWQgY291bnQgZm9yIGhpZ2gKICAqIG51bWJlcnMuCiAgKgogICogQHBhcmFtIG9wdGlvbnMuZGVmYXVsdFRvTnVsbCAtIE1ha2UgbWlzc2luZyBmaWVsZHMgZGVmYXVsdCB0byBgbnVsbGAuCiAgKiBPdGhlcndpc2UsIHVzZSB0aGUgZGVmYXVsdCB2YWx1ZSBmb3IgdGhlIGNvbHVtbi4gVGhpcyBvbmx5IGFwcGxpZXMgd2hlbgogICogaW5zZXJ0aW5nIG5ldyByb3dzLCBub3Qgd2hlbiBtZXJnaW5nIHdpdGggZXhpc3Rpbmcgcm93cyB1bmRlcgogICogYGlnbm9yZUR1cGxpY2F0ZXM6IGZhbHNlYC4gVGhpcyBhbHNvIG9ubHkgYXBwbGllcyB3aGVuIGRvaW5nIGJ1bGsgdXBzZXJ0cy4KICAqCiAgKiBAZXhhbXBsZSBVcHNlcnQgYSBzaW5nbGUgcm93IHVzaW5nIGEgdW5pcXVlIGtleQogICogYGBgdHMKICAqIC8vIFVwc2VydGluZyBhIHNpbmdsZSByb3csIG92ZXJ3cml0aW5nIGJhc2VkIG9uIHRoZSAndXNlcm5hbWUnIHVuaXF1ZSBjb2x1bW4KICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5mcm9tKCd1c2VycycpCiAgKiAgIC51cHNlcnQoeyB1c2VybmFtZTogJ3N1cGFib3QnIH0sIHsgb25Db25mbGljdDogJ3VzZXJuYW1lJyB9KQogICoKICAqIC8vIEV4YW1wbGUgcmVzcG9uc2U6CiAgKiAvLyB7CiAgKiAvLyAgIGRhdGE6IFsKICAqIC8vICAgICB7IGlkOiA0LCBtZXNzYWdlOiAnYmFyJywgdXNlcm5hbWU6ICdzdXBhYm90JyB9CiAgKiAvLyAgIF0sCiAgKiAvLyAgIGVycm9yOiBudWxsCiAgKiAvLyB9CiAgKiBgYGAKICAqCiAgKiBAZXhhbXBsZSBVcHNlcnQgd2l0aCBjb25mbGljdCByZXNvbHV0aW9uIGFuZCBleGFjdCByb3cgY291bnRpbmcKICAqIGBgYHRzCiAgKiAvLyBVcHNlcnRpbmcgYW5kIHJldHVybmluZyBleGFjdCBjb3VudAogICogY29uc3QgeyBkYXRhLCBlcnJvciwgY291bnQgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5mcm9tKCd1c2VycycpCiAgKiAgIC51cHNlcnQoCiAgKiAgICAgewogICogICAgICAgaWQ6IDMsCiAgKiAgICAgICBtZXNzYWdlOiAnZm9vJywKICAqICAgICAgIHVzZXJuYW1lOiAnc3VwYWJvdCcKICAqICAgICB9LAogICogICAgIHsKICAqICAgICAgIG9uQ29uZmxpY3Q6ICd1c2VybmFtZScsCiAgKiAgICAgICBjb3VudDogJ2V4YWN0JwogICogICAgIH0KICAqICAgKQogICoKICAqIC8vIEV4YW1wbGUgcmVzcG9uc2U6CiAgKiAvLyB7CiAgKiAvLyAgIGRhdGE6IFsKICAqIC8vICAgICB7CiAgKiAvLyAgICAgICBpZDogNDIsCiAgKiAvLyAgICAgICBoYW5kbGU6ICJzYW9pcnNlIiwKICAqIC8vICAgICAgIGRpc3BsYXlfbmFtZTogIlNhb2lyc2UiCiAgKiAvLyAgICAgfQogICogLy8gICBdLAogICogLy8gICBjb3VudDogMSwKICAqIC8vICAgZXJyb3I6IG51bGwKICAqIC8vIH0KICAqIGBgYAogICovCiAgdXBzZXJ0KHZhbHVlcywgeyBvbkNvbmZsaWN0LCBpZ25vcmVEdXBsaWNhdGVzID0gZmFsc2UsIGNvdW50LCBkZWZhdWx0VG9OdWxsID0gdHJ1ZSB9ID0ge30pIHsKICAgIHZhciBfdGhpcyRmZXRjaDI7CiAgICBjb25zdCBtZXRob2QgPSAiUE9TVCI7CiAgICBjb25zdCB7IHVybCwgaGVhZGVycyB9ID0gdGhpcy5jbG9uZVJlcXVlc3RTdGF0ZSgpOwogICAgaGVhZGVycy5hcHBlbmQoIlByZWZlciIsIGByZXNvbHV0aW9uPSR7aWdub3JlRHVwbGljYXRlcyA/ICJpZ25vcmUiIDogIm1lcmdlIn0tZHVwbGljYXRlc2ApOwogICAgaWYgKG9uQ29uZmxpY3QgIT09IHZvaWQgMCkgdXJsLnNlYXJjaFBhcmFtcy5zZXQoIm9uX2NvbmZsaWN0Iiwgb25Db25mbGljdCk7CiAgICBpZiAoY291bnQpIGhlYWRlcnMuYXBwZW5kKCJQcmVmZXIiLCBgY291bnQ9JHtjb3VudH1gKTsKICAgIGlmICghZGVmYXVsdFRvTnVsbCkgaGVhZGVycy5hcHBlbmQoIlByZWZlciIsICJtaXNzaW5nPWRlZmF1bHQiKTsKICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlcykpIHsKICAgICAgY29uc3QgY29sdW1ucyA9IHZhbHVlcy5yZWR1Y2UoKGFjYywgeDIpID0+IGFjYy5jb25jYXQoT2JqZWN0LmtleXMoeDIpKSwgW10pOwogICAgICBpZiAoY29sdW1ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3QgdW5pcXVlQ29sdW1ucyA9IFsuLi5uZXcgU2V0KGNvbHVtbnMpXS5tYXAoKGNvbHVtbikgPT4gYCIke2NvbHVtbn0iYCk7CiAgICAgICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoImNvbHVtbnMiLCB1bmlxdWVDb2x1bW5zLmpvaW4oIiwiKSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBuZXcgUG9zdGdyZXN0RmlsdGVyQnVpbGRlcih7CiAgICAgIG1ldGhvZCwKICAgICAgdXJsLAogICAgICBoZWFkZXJzLAogICAgICBzY2hlbWE6IHRoaXMuc2NoZW1hLAogICAgICBib2R5OiB2YWx1ZXMsCiAgICAgIGZldGNoOiAoX3RoaXMkZmV0Y2gyID0gdGhpcy5mZXRjaCkgIT09IG51bGwgJiYgX3RoaXMkZmV0Y2gyICE9PSB2b2lkIDAgPyBfdGhpcyRmZXRjaDIgOiBmZXRjaCwKICAgICAgdXJsTGVuZ3RoTGltaXQ6IHRoaXMudXJsTGVuZ3RoTGltaXQKICAgIH0pOwogIH0KICAvKioKICAqIFBlcmZvcm0gYW4gVVBEQVRFIG9uIHRoZSB0YWJsZSBvciB2aWV3LgogICoKICAqIEJ5IGRlZmF1bHQsIHVwZGF0ZWQgcm93cyBhcmUgbm90IHJldHVybmVkLiBUbyByZXR1cm4gaXQsIGNoYWluIHRoZSBjYWxsCiAgKiB3aXRoIGAuc2VsZWN0KClgIGFmdGVyIGZpbHRlcnMuCiAgKgogICogQHBhcmFtIHZhbHVlcyAtIFRoZSB2YWx1ZXMgdG8gdXBkYXRlIHdpdGgKICAqCiAgKiBAcGFyYW0gb3B0aW9ucyAtIE5hbWVkIHBhcmFtZXRlcnMKICAqCiAgKiBAcGFyYW0gb3B0aW9ucy5jb3VudCAtIENvdW50IGFsZ29yaXRobSB0byB1c2UgdG8gY291bnQgdXBkYXRlZCByb3dzLgogICoKICAqIGAiZXhhY3QiYDogRXhhY3QgYnV0IHNsb3cgY291bnQgYWxnb3JpdGhtLiBQZXJmb3JtcyBhIGBDT1VOVCgqKWAgdW5kZXIgdGhlCiAgKiBob29kLgogICoKICAqIGAicGxhbm5lZCJgOiBBcHByb3hpbWF0ZWQgYnV0IGZhc3QgY291bnQgYWxnb3JpdGhtLiBVc2VzIHRoZSBQb3N0Z3JlcwogICogc3RhdGlzdGljcyB1bmRlciB0aGUgaG9vZC4KICAqCiAgKiBgImVzdGltYXRlZCJgOiBVc2VzIGV4YWN0IGNvdW50IGZvciBsb3cgbnVtYmVycyBhbmQgcGxhbm5lZCBjb3VudCBmb3IgaGlnaAogICogbnVtYmVycy4KICAqLwogIHVwZGF0ZSh2YWx1ZXMsIHsgY291bnQgfSA9IHt9KSB7CiAgICB2YXIgX3RoaXMkZmV0Y2gzOwogICAgY29uc3QgbWV0aG9kID0gIlBBVENIIjsKICAgIGNvbnN0IHsgdXJsLCBoZWFkZXJzIH0gPSB0aGlzLmNsb25lUmVxdWVzdFN0YXRlKCk7CiAgICBpZiAoY291bnQpIGhlYWRlcnMuYXBwZW5kKCJQcmVmZXIiLCBgY291bnQ9JHtjb3VudH1gKTsKICAgIHJldHVybiBuZXcgUG9zdGdyZXN0RmlsdGVyQnVpbGRlcih7CiAgICAgIG1ldGhvZCwKICAgICAgdXJsLAogICAgICBoZWFkZXJzLAogICAgICBzY2hlbWE6IHRoaXMuc2NoZW1hLAogICAgICBib2R5OiB2YWx1ZXMsCiAgICAgIGZldGNoOiAoX3RoaXMkZmV0Y2gzID0gdGhpcy5mZXRjaCkgIT09IG51bGwgJiYgX3RoaXMkZmV0Y2gzICE9PSB2b2lkIDAgPyBfdGhpcyRmZXRjaDMgOiBmZXRjaCwKICAgICAgdXJsTGVuZ3RoTGltaXQ6IHRoaXMudXJsTGVuZ3RoTGltaXQKICAgIH0pOwogIH0KICAvKioKICAqIFBlcmZvcm0gYSBERUxFVEUgb24gdGhlIHRhYmxlIG9yIHZpZXcuCiAgKgogICogQnkgZGVmYXVsdCwgZGVsZXRlZCByb3dzIGFyZSBub3QgcmV0dXJuZWQuIFRvIHJldHVybiBpdCwgY2hhaW4gdGhlIGNhbGwKICAqIHdpdGggYC5zZWxlY3QoKWAgYWZ0ZXIgZmlsdGVycy4KICAqCiAgKiBAcGFyYW0gb3B0aW9ucyAtIE5hbWVkIHBhcmFtZXRlcnMKICAqCiAgKiBAcGFyYW0gb3B0aW9ucy5jb3VudCAtIENvdW50IGFsZ29yaXRobSB0byB1c2UgdG8gY291bnQgZGVsZXRlZCByb3dzLgogICoKICAqIGAiZXhhY3QiYDogRXhhY3QgYnV0IHNsb3cgY291bnQgYWxnb3JpdGhtLiBQZXJmb3JtcyBhIGBDT1VOVCgqKWAgdW5kZXIgdGhlCiAgKiBob29kLgogICoKICAqIGAicGxhbm5lZCJgOiBBcHByb3hpbWF0ZWQgYnV0IGZhc3QgY291bnQgYWxnb3JpdGhtLiBVc2VzIHRoZSBQb3N0Z3JlcwogICogc3RhdGlzdGljcyB1bmRlciB0aGUgaG9vZC4KICAqCiAgKiBgImVzdGltYXRlZCJgOiBVc2VzIGV4YWN0IGNvdW50IGZvciBsb3cgbnVtYmVycyBhbmQgcGxhbm5lZCBjb3VudCBmb3IgaGlnaAogICogbnVtYmVycy4KICAqLwogIGRlbGV0ZSh7IGNvdW50IH0gPSB7fSkgewogICAgdmFyIF90aGlzJGZldGNoNDsKICAgIGNvbnN0IG1ldGhvZCA9ICJERUxFVEUiOwogICAgY29uc3QgeyB1cmwsIGhlYWRlcnMgfSA9IHRoaXMuY2xvbmVSZXF1ZXN0U3RhdGUoKTsKICAgIGlmIChjb3VudCkgaGVhZGVycy5hcHBlbmQoIlByZWZlciIsIGBjb3VudD0ke2NvdW50fWApOwogICAgcmV0dXJuIG5ldyBQb3N0Z3Jlc3RGaWx0ZXJCdWlsZGVyKHsKICAgICAgbWV0aG9kLAogICAgICB1cmwsCiAgICAgIGhlYWRlcnMsCiAgICAgIHNjaGVtYTogdGhpcy5zY2hlbWEsCiAgICAgIGZldGNoOiAoX3RoaXMkZmV0Y2g0ID0gdGhpcy5mZXRjaCkgIT09IG51bGwgJiYgX3RoaXMkZmV0Y2g0ICE9PSB2b2lkIDAgPyBfdGhpcyRmZXRjaDQgOiBmZXRjaCwKICAgICAgdXJsTGVuZ3RoTGltaXQ6IHRoaXMudXJsTGVuZ3RoTGltaXQKICAgIH0pOwogIH0KfTsKZnVuY3Rpb24gX3R5cGVvZihvKSB7CiAgIkBiYWJlbC9oZWxwZXJzIC0gdHlwZW9mIjsKICByZXR1cm4gX3R5cGVvZiA9ICJmdW5jdGlvbiIgPT0gdHlwZW9mIFN5bWJvbCAmJiAic3ltYm9sIiA9PSB0eXBlb2YgU3ltYm9sLml0ZXJhdG9yID8gZnVuY3Rpb24obyQxKSB7CiAgICByZXR1cm4gdHlwZW9mIG8kMTsKICB9IDogZnVuY3Rpb24obyQxKSB7CiAgICByZXR1cm4gbyQxICYmICJmdW5jdGlvbiIgPT0gdHlwZW9mIFN5bWJvbCAmJiBvJDEuY29uc3RydWN0b3IgPT09IFN5bWJvbCAmJiBvJDEgIT09IFN5bWJvbC5wcm90b3R5cGUgPyAic3ltYm9sIiA6IHR5cGVvZiBvJDE7CiAgfSwgX3R5cGVvZihvKTsKfQpmdW5jdGlvbiB0b1ByaW1pdGl2ZSh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSBfdHlwZW9mKHQpIHx8ICF0KSByZXR1cm4gdDsKICB2YXIgZSA9IHRbU3ltYm9sLnRvUHJpbWl0aXZlXTsKICBpZiAodm9pZCAwICE9PSBlKSB7CiAgICB2YXIgaSA9IGUuY2FsbCh0LCByMiB8fCAiZGVmYXVsdCIpOwogICAgaWYgKCJvYmplY3QiICE9IF90eXBlb2YoaSkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIHRvUHJvcGVydHlLZXkodCkgewogIHZhciBpID0gdG9QcmltaXRpdmUodCwgInN0cmluZyIpOwogIHJldHVybiAic3ltYm9sIiA9PSBfdHlwZW9mKGkpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzNChlLCByMiwgdCkgewogIHJldHVybiAocjIgPSB0b1Byb3BlcnR5S2V5KHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgewogICAgdmFsdWU6IHQsCiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgd3JpdGFibGU6IHRydWUKICB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBvd25LZXlzMzIoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIkMSkgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByJDEpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDIxMChlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czMyKE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyJDEpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MzQoZSwgciQxLCB0W3IkMV0pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzMihPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ociQxKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByJDEsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgciQxKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KdmFyIFBvc3RncmVzdENsaWVudCA9IGNsYXNzIFBvc3RncmVzdENsaWVudDIgewogIC8qKgogICogQ3JlYXRlcyBhIFBvc3RnUkVTVCBjbGllbnQuCiAgKgogICogQHBhcmFtIHVybCAtIFVSTCBvZiB0aGUgUG9zdGdSRVNUIGVuZHBvaW50CiAgKiBAcGFyYW0gb3B0aW9ucyAtIE5hbWVkIHBhcmFtZXRlcnMKICAqIEBwYXJhbSBvcHRpb25zLmhlYWRlcnMgLSBDdXN0b20gaGVhZGVycwogICogQHBhcmFtIG9wdGlvbnMuc2NoZW1hIC0gUG9zdGdyZXMgc2NoZW1hIHRvIHN3aXRjaCB0bwogICogQHBhcmFtIG9wdGlvbnMuZmV0Y2ggLSBDdXN0b20gZmV0Y2gKICAqIEBwYXJhbSBvcHRpb25zLnRpbWVvdXQgLSBPcHRpb25hbCB0aW1lb3V0IGluIG1pbGxpc2Vjb25kcyBmb3IgYWxsIHJlcXVlc3RzLiBXaGVuIHNldCwgcmVxdWVzdHMgd2lsbCBhdXRvbWF0aWNhbGx5IGFib3J0IGFmdGVyIHRoaXMgZHVyYXRpb24gdG8gcHJldmVudCBpbmRlZmluaXRlIGhhbmdzLgogICogQHBhcmFtIG9wdGlvbnMudXJsTGVuZ3RoTGltaXQgLSBNYXhpbXVtIFVSTCBsZW5ndGggaW4gY2hhcmFjdGVycyBiZWZvcmUgd2FybmluZ3MvZXJyb3JzIGFyZSB0cmlnZ2VyZWQuIERlZmF1bHRzIHRvIDgwMDAuCiAgKiBAZXhhbXBsZQogICogYGBgdHMKICAqIGltcG9ydCBQb3N0Z3Jlc3RDbGllbnQgZnJvbSAnQHN1cGFiYXNlL3Bvc3RncmVzdC1qcycKICAqCiAgKiBjb25zdCBwb3N0Z3Jlc3QgPSBuZXcgUG9zdGdyZXN0Q2xpZW50KCdodHRwczovL3h5emNvbXBhbnkuc3VwYWJhc2UuY28vcmVzdC92MScsIHsKICAqICAgaGVhZGVyczogeyBhcGlrZXk6ICdwdWJsaWMtYW5vbi1rZXknIH0sCiAgKiAgIHNjaGVtYTogJ3B1YmxpYycsCiAgKiAgIHRpbWVvdXQ6IDMwMDAwLCAvLyAzMCBzZWNvbmQgdGltZW91dAogICogfSkKICAqIGBgYAogICovCiAgY29uc3RydWN0b3IodXJsLCB7IGhlYWRlcnMgPSB7fSwgc2NoZW1hLCBmZXRjaDogZmV0Y2gkMSwgdGltZW91dCwgdXJsTGVuZ3RoTGltaXQgPSA4ZTMgfSA9IHt9KSB7CiAgICB0aGlzLnVybCA9IHVybDsKICAgIHRoaXMuaGVhZGVycyA9IG5ldyBIZWFkZXJzKGhlYWRlcnMpOwogICAgdGhpcy5zY2hlbWFOYW1lID0gc2NoZW1hOwogICAgdGhpcy51cmxMZW5ndGhMaW1pdCA9IHVybExlbmd0aExpbWl0OwogICAgY29uc3Qgb3JpZ2luYWxGZXRjaCA9IGZldGNoJDEgIT09IG51bGwgJiYgZmV0Y2gkMSAhPT0gdm9pZCAwID8gZmV0Y2gkMSA6IGdsb2JhbFRoaXMuZmV0Y2g7CiAgICBpZiAodGltZW91dCAhPT0gdm9pZCAwICYmIHRpbWVvdXQgPiAwKSB0aGlzLmZldGNoID0gKGlucHV0LCBpbml0KSA9PiB7CiAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICAgIGNvbnN0IHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4gY29udHJvbGxlci5hYm9ydCgpLCB0aW1lb3V0KTsKICAgICAgY29uc3QgZXhpc3RpbmdTaWduYWwgPSBpbml0ID09PSBudWxsIHx8IGluaXQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGluaXQuc2lnbmFsOwogICAgICBpZiAoZXhpc3RpbmdTaWduYWwpIHsKICAgICAgICBpZiAoZXhpc3RpbmdTaWduYWwuYWJvcnRlZCkgewogICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXRJZCk7CiAgICAgICAgICByZXR1cm4gb3JpZ2luYWxGZXRjaChpbnB1dCwgaW5pdCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGFib3J0SGFuZGxlciA9ICgpID0+IHsKICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpOwogICAgICAgICAgY29udHJvbGxlci5hYm9ydCgpOwogICAgICAgIH07CiAgICAgICAgZXhpc3RpbmdTaWduYWwuYWRkRXZlbnRMaXN0ZW5lcigiYWJvcnQiLCBhYm9ydEhhbmRsZXIsIHsgb25jZTogdHJ1ZSB9KTsKICAgICAgICByZXR1cm4gb3JpZ2luYWxGZXRjaChpbnB1dCwgX29iamVjdFNwcmVhZDIxMChfb2JqZWN0U3ByZWFkMjEwKHt9LCBpbml0KSwge30sIHsgc2lnbmFsOiBjb250cm9sbGVyLnNpZ25hbCB9KSkuZmluYWxseSgoKSA9PiB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTsKICAgICAgICAgIGV4aXN0aW5nU2lnbmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoImFib3J0IiwgYWJvcnRIYW5kbGVyKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gb3JpZ2luYWxGZXRjaChpbnB1dCwgX29iamVjdFNwcmVhZDIxMChfb2JqZWN0U3ByZWFkMjEwKHt9LCBpbml0KSwge30sIHsgc2lnbmFsOiBjb250cm9sbGVyLnNpZ25hbCB9KSkuZmluYWxseSgoKSA9PiBjbGVhclRpbWVvdXQodGltZW91dElkKSk7CiAgICB9OwogICAgZWxzZSB0aGlzLmZldGNoID0gb3JpZ2luYWxGZXRjaDsKICB9CiAgLyoqCiAgKiBQZXJmb3JtIGEgcXVlcnkgb24gYSB0YWJsZSBvciBhIHZpZXcuCiAgKgogICogQHBhcmFtIHJlbGF0aW9uIC0gVGhlIHRhYmxlIG9yIHZpZXcgbmFtZSB0byBxdWVyeQogICovCiAgZnJvbShyZWxhdGlvbikgewogICAgaWYgKCFyZWxhdGlvbiB8fCB0eXBlb2YgcmVsYXRpb24gIT09ICJzdHJpbmciIHx8IHJlbGF0aW9uLnRyaW0oKSA9PT0gIiIpIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCByZWxhdGlvbiBuYW1lOiByZWxhdGlvbiBtdXN0IGJlIGEgbm9uLWVtcHR5IHN0cmluZy4iKTsKICAgIHJldHVybiBuZXcgUG9zdGdyZXN0UXVlcnlCdWlsZGVyKG5ldyBVUkwoYCR7dGhpcy51cmx9LyR7cmVsYXRpb259YCksIHsKICAgICAgaGVhZGVyczogbmV3IEhlYWRlcnModGhpcy5oZWFkZXJzKSwKICAgICAgc2NoZW1hOiB0aGlzLnNjaGVtYU5hbWUsCiAgICAgIGZldGNoOiB0aGlzLmZldGNoLAogICAgICB1cmxMZW5ndGhMaW1pdDogdGhpcy51cmxMZW5ndGhMaW1pdAogICAgfSk7CiAgfQogIC8qKgogICogU2VsZWN0IGEgc2NoZW1hIHRvIHF1ZXJ5IG9yIHBlcmZvcm0gYW4gZnVuY3Rpb24gKHJwYykgY2FsbC4KICAqCiAgKiBUaGUgc2NoZW1hIG5lZWRzIHRvIGJlIG9uIHRoZSBsaXN0IG9mIGV4cG9zZWQgc2NoZW1hcyBpbnNpZGUgU3VwYWJhc2UuCiAgKgogICogQHBhcmFtIHNjaGVtYSAtIFRoZSBzY2hlbWEgdG8gcXVlcnkKICAqLwogIHNjaGVtYShzY2hlbWEpIHsKICAgIHJldHVybiBuZXcgUG9zdGdyZXN0Q2xpZW50Mih0aGlzLnVybCwgewogICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgIHNjaGVtYSwKICAgICAgZmV0Y2g6IHRoaXMuZmV0Y2gsCiAgICAgIHVybExlbmd0aExpbWl0OiB0aGlzLnVybExlbmd0aExpbWl0CiAgICB9KTsKICB9CiAgLyoqCiAgKiBQZXJmb3JtIGEgZnVuY3Rpb24gY2FsbC4KICAqCiAgKiBAcGFyYW0gZm4gLSBUaGUgZnVuY3Rpb24gbmFtZSB0byBjYWxsCiAgKiBAcGFyYW0gYXJncyAtIFRoZSBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUgZnVuY3Rpb24gY2FsbAogICogQHBhcmFtIG9wdGlvbnMgLSBOYW1lZCBwYXJhbWV0ZXJzCiAgKiBAcGFyYW0gb3B0aW9ucy5oZWFkIC0gV2hlbiBzZXQgdG8gYHRydWVgLCBgZGF0YWAgd2lsbCBub3QgYmUgcmV0dXJuZWQuCiAgKiBVc2VmdWwgaWYgeW91IG9ubHkgbmVlZCB0aGUgY291bnQuCiAgKiBAcGFyYW0gb3B0aW9ucy5nZXQgLSBXaGVuIHNldCB0byBgdHJ1ZWAsIHRoZSBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCB3aXRoCiAgKiByZWFkLW9ubHkgYWNjZXNzIG1vZGUuCiAgKiBAcGFyYW0gb3B0aW9ucy5jb3VudCAtIENvdW50IGFsZ29yaXRobSB0byB1c2UgdG8gY291bnQgcm93cyByZXR1cm5lZCBieSB0aGUKICAqIGZ1bmN0aW9uLiBPbmx5IGFwcGxpY2FibGUgZm9yIFtzZXQtcmV0dXJuaW5nCiAgKiBmdW5jdGlvbnNdKGh0dHBzOi8vd3d3LnBvc3RncmVzcWwub3JnL2RvY3MvY3VycmVudC9mdW5jdGlvbnMtc3JmLmh0bWwpLgogICoKICAqIGAiZXhhY3QiYDogRXhhY3QgYnV0IHNsb3cgY291bnQgYWxnb3JpdGhtLiBQZXJmb3JtcyBhIGBDT1VOVCgqKWAgdW5kZXIgdGhlCiAgKiBob29kLgogICoKICAqIGAicGxhbm5lZCJgOiBBcHByb3hpbWF0ZWQgYnV0IGZhc3QgY291bnQgYWxnb3JpdGhtLiBVc2VzIHRoZSBQb3N0Z3JlcwogICogc3RhdGlzdGljcyB1bmRlciB0aGUgaG9vZC4KICAqCiAgKiBgImVzdGltYXRlZCJgOiBVc2VzIGV4YWN0IGNvdW50IGZvciBsb3cgbnVtYmVycyBhbmQgcGxhbm5lZCBjb3VudCBmb3IgaGlnaAogICogbnVtYmVycy4KICAqCiAgKiBAZXhhbXBsZQogICogYGBgdHMKICAqIC8vIEZvciBjcm9zcy1zY2hlbWEgZnVuY3Rpb25zIHdoZXJlIHR5cGUgaW5mZXJlbmNlIGZhaWxzLCB1c2Ugb3ZlcnJpZGVUeXBlczoKICAqIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnNjaGVtYSgnc2NoZW1hX2InKQogICogICAucnBjKCdmdW5jdGlvbl9hJywge30pCiAgKiAgIC5vdmVycmlkZVR5cGVzPHsgaWQ6IHN0cmluZzsgdXNlcl9pZDogc3RyaW5nIH1bXT4oKQogICogYGBgCiAgKi8KICBycGMoZm4sIGFyZ3MgPSB7fSwgeyBoZWFkOiBoZWFkMiA9IGZhbHNlLCBnZXQ6IGdldDYgPSBmYWxzZSwgY291bnQgfSA9IHt9KSB7CiAgICB2YXIgX3RoaXMkZmV0Y2g7CiAgICBsZXQgbWV0aG9kOwogICAgY29uc3QgdXJsID0gbmV3IFVSTChgJHt0aGlzLnVybH0vcnBjLyR7Zm59YCk7CiAgICBsZXQgYm9keTsKICAgIGNvbnN0IF9pc09iamVjdCA9ICh2KSA9PiB2ICE9PSBudWxsICYmIHR5cGVvZiB2ID09PSAib2JqZWN0IiAmJiAoIUFycmF5LmlzQXJyYXkodikgfHwgdi5zb21lKF9pc09iamVjdCkpOwogICAgY29uc3QgX2hhc09iamVjdEFyZyA9IGhlYWQyICYmIE9iamVjdC52YWx1ZXMoYXJncykuc29tZShfaXNPYmplY3QpOwogICAgaWYgKF9oYXNPYmplY3RBcmcpIHsKICAgICAgbWV0aG9kID0gIlBPU1QiOwogICAgICBib2R5ID0gYXJnczsKICAgIH0gZWxzZSBpZiAoaGVhZDIgfHwgZ2V0NikgewogICAgICBtZXRob2QgPSBoZWFkMiA/ICJIRUFEIiA6ICJHRVQiOwogICAgICBPYmplY3QuZW50cmllcyhhcmdzKS5maWx0ZXIoKFtfLCB2YWx1ZV0pID0+IHZhbHVlICE9PSB2b2lkIDApLm1hcCgoW25hbWUsIHZhbHVlXSkgPT4gW25hbWUsIEFycmF5LmlzQXJyYXkodmFsdWUpID8gYHske3ZhbHVlLmpvaW4oIiwiKX19YCA6IGAke3ZhbHVlfWBdKS5mb3JFYWNoKChbbmFtZSwgdmFsdWVdKSA9PiB7CiAgICAgICAgdXJsLnNlYXJjaFBhcmFtcy5hcHBlbmQobmFtZSwgdmFsdWUpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIG1ldGhvZCA9ICJQT1NUIjsKICAgICAgYm9keSA9IGFyZ3M7CiAgICB9CiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEhlYWRlcnModGhpcy5oZWFkZXJzKTsKICAgIGlmIChfaGFzT2JqZWN0QXJnKSBoZWFkZXJzLnNldCgiUHJlZmVyIiwgY291bnQgPyBgY291bnQ9JHtjb3VudH0scmV0dXJuPW1pbmltYWxgIDogInJldHVybj1taW5pbWFsIik7CiAgICBlbHNlIGlmIChjb3VudCkgaGVhZGVycy5zZXQoIlByZWZlciIsIGBjb3VudD0ke2NvdW50fWApOwogICAgcmV0dXJuIG5ldyBQb3N0Z3Jlc3RGaWx0ZXJCdWlsZGVyKHsKICAgICAgbWV0aG9kLAogICAgICB1cmwsCiAgICAgIGhlYWRlcnMsCiAgICAgIHNjaGVtYTogdGhpcy5zY2hlbWFOYW1lLAogICAgICBib2R5LAogICAgICBmZXRjaDogKF90aGlzJGZldGNoID0gdGhpcy5mZXRjaCkgIT09IG51bGwgJiYgX3RoaXMkZmV0Y2ggIT09IHZvaWQgMCA/IF90aGlzJGZldGNoIDogZmV0Y2gsCiAgICAgIHVybExlbmd0aExpbWl0OiB0aGlzLnVybExlbmd0aExpbWl0CiAgICB9KTsKICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK3JlYWx0aW1lLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL3JlYWx0aW1lLWpzL2Rpc3QvbW9kdWxlL2xpYi93ZWJzb2NrZXQtZmFjdG9yeS5qcwp2YXIgV2ViU29ja2V0RmFjdG9yeSA9IGNsYXNzIHsKICAvKioKICAgKiBTdGF0aWMtb25seSB1dGlsaXR5IOKAkyBwcmV2ZW50IGluc3RhbnRpYXRpb24uCiAgICovCiAgY29uc3RydWN0b3IoKSB7CiAgfQogIHN0YXRpYyBkZXRlY3RFbnZpcm9ubWVudCgpIHsKICAgIHZhciBfYTsKICAgIGlmICh0eXBlb2YgV2ViU29ja2V0ICE9PSAidW5kZWZpbmVkIikgewogICAgICByZXR1cm4geyB0eXBlOiAibmF0aXZlIiwgY29uc3RydWN0b3I6IFdlYlNvY2tldCB9OwogICAgfQogICAgaWYgKHR5cGVvZiBnbG9iYWxUaGlzICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgZ2xvYmFsVGhpcy5XZWJTb2NrZXQgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgIHJldHVybiB7IHR5cGU6ICJuYXRpdmUiLCBjb25zdHJ1Y3RvcjogZ2xvYmFsVGhpcy5XZWJTb2NrZXQgfTsKICAgIH0KICAgIGlmICh0eXBlb2YgZ2xvYmFsICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgZ2xvYmFsLldlYlNvY2tldCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgcmV0dXJuIHsgdHlwZTogIm5hdGl2ZSIsIGNvbnN0cnVjdG9yOiBnbG9iYWwuV2ViU29ja2V0IH07CiAgICB9CiAgICBpZiAodHlwZW9mIGdsb2JhbFRoaXMgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBnbG9iYWxUaGlzLldlYlNvY2tldFBhaXIgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBnbG9iYWxUaGlzLldlYlNvY2tldCA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB0eXBlOiAiY2xvdWRmbGFyZSIsCiAgICAgICAgZXJyb3I6ICJDbG91ZGZsYXJlIFdvcmtlcnMgZGV0ZWN0ZWQuIFdlYlNvY2tldCBjbGllbnRzIGFyZSBub3Qgc3VwcG9ydGVkIGluIENsb3VkZmxhcmUgV29ya2Vycy4iLAogICAgICAgIHdvcmthcm91bmQ6ICJVc2UgQ2xvdWRmbGFyZSBXb3JrZXJzIFdlYlNvY2tldCBBUEkgZm9yIHNlcnZlci1zaWRlIFdlYlNvY2tldCBoYW5kbGluZywgb3IgZGVwbG95IHRvIGEgZGlmZmVyZW50IHJ1bnRpbWUuIgogICAgICB9OwogICAgfQogICAgaWYgKHR5cGVvZiBnbG9iYWxUaGlzICE9PSAidW5kZWZpbmVkIiAmJiBnbG9iYWxUaGlzLkVkZ2VSdW50aW1lIHx8IHR5cGVvZiBuYXZpZ2F0b3IgIT09ICJ1bmRlZmluZWQiICYmICgoX2EgPSBuYXZpZ2F0b3IudXNlckFnZW50KSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuaW5jbHVkZXMoIlZlcmNlbC1FZGdlIikpKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdHlwZTogInVuc3VwcG9ydGVkIiwKICAgICAgICBlcnJvcjogIkVkZ2UgcnVudGltZSBkZXRlY3RlZCAoVmVyY2VsIEVkZ2UvTmV0bGlmeSBFZGdlKS4gV2ViU29ja2V0cyBhcmUgbm90IHN1cHBvcnRlZCBpbiBlZGdlIGZ1bmN0aW9ucy4iLAogICAgICAgIHdvcmthcm91bmQ6ICJVc2Ugc2VydmVybGVzcyBmdW5jdGlvbnMgb3IgYSBkaWZmZXJlbnQgZGVwbG95bWVudCB0YXJnZXQgZm9yIFdlYlNvY2tldCBmdW5jdGlvbmFsaXR5LiIKICAgICAgfTsKICAgIH0KICAgIGNvbnN0IF9wcm9jZXNzID0gZ2xvYmFsVGhpc1sicHJvY2VzcyJdOwogICAgaWYgKF9wcm9jZXNzKSB7CiAgICAgIGNvbnN0IHByb2Nlc3NWZXJzaW9ucyA9IF9wcm9jZXNzWyJ2ZXJzaW9ucyJdOwogICAgICBpZiAocHJvY2Vzc1ZlcnNpb25zICYmIHByb2Nlc3NWZXJzaW9uc1sibm9kZSJdKSB7CiAgICAgICAgY29uc3QgdmVyc2lvblN0cmluZyA9IHByb2Nlc3NWZXJzaW9uc1sibm9kZSJdOwogICAgICAgIGNvbnN0IG5vZGVWZXJzaW9uID0gcGFyc2VJbnQodmVyc2lvblN0cmluZy5yZXBsYWNlKC9edi8sICIiKS5zcGxpdCgiLiIpWzBdKTsKICAgICAgICBpZiAobm9kZVZlcnNpb24gPj0gMjIpIHsKICAgICAgICAgIGlmICh0eXBlb2YgZ2xvYmFsVGhpcy5XZWJTb2NrZXQgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiB7IHR5cGU6ICJuYXRpdmUiLCBjb25zdHJ1Y3RvcjogZ2xvYmFsVGhpcy5XZWJTb2NrZXQgfTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHR5cGU6ICJ1bnN1cHBvcnRlZCIsCiAgICAgICAgICAgIGVycm9yOiBgTm9kZS5qcyAke25vZGVWZXJzaW9ufSBkZXRlY3RlZCBidXQgbmF0aXZlIFdlYlNvY2tldCBub3QgZm91bmQuYCwKICAgICAgICAgICAgd29ya2Fyb3VuZDogIlByb3ZpZGUgYSBXZWJTb2NrZXQgaW1wbGVtZW50YXRpb24gdmlhIHRoZSB0cmFuc3BvcnQgb3B0aW9uLiIKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICB0eXBlOiAidW5zdXBwb3J0ZWQiLAogICAgICAgICAgZXJyb3I6IGBOb2RlLmpzICR7bm9kZVZlcnNpb259IGRldGVjdGVkIHdpdGhvdXQgbmF0aXZlIFdlYlNvY2tldCBzdXBwb3J0LmAsCiAgICAgICAgICB3b3JrYXJvdW5kOiAnRm9yIE5vZGUuanMgPCAyMiwgaW5zdGFsbCAid3MiIHBhY2thZ2UgYW5kIHByb3ZpZGUgaXQgdmlhIHRoZSB0cmFuc3BvcnQgb3B0aW9uOlxuaW1wb3J0IHdzIGZyb20gIndzIlxubmV3IFJlYWx0aW1lQ2xpZW50KHVybCwgeyB0cmFuc3BvcnQ6IHdzIH0pJwogICAgICAgIH07CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgIHR5cGU6ICJ1bnN1cHBvcnRlZCIsCiAgICAgIGVycm9yOiAiVW5rbm93biBKYXZhU2NyaXB0IHJ1bnRpbWUgd2l0aG91dCBXZWJTb2NrZXQgc3VwcG9ydC4iLAogICAgICB3b3JrYXJvdW5kOiAiRW5zdXJlIHlvdSdyZSBydW5uaW5nIGluIGEgc3VwcG9ydGVkIGVudmlyb25tZW50IChicm93c2VyLCBOb2RlLmpzLCBEZW5vKSBvciBwcm92aWRlIGEgY3VzdG9tIFdlYlNvY2tldCBpbXBsZW1lbnRhdGlvbi4iCiAgICB9OwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBiZXN0IGF2YWlsYWJsZSBXZWJTb2NrZXQgY29uc3RydWN0b3IgZm9yIHRoZSBjdXJyZW50IHJ1bnRpbWUuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIGBgYHRzCiAgICogY29uc3QgV1MgPSBXZWJTb2NrZXRGYWN0b3J5LmdldFdlYlNvY2tldENvbnN0cnVjdG9yKCkKICAgKiBjb25zdCBzb2NrZXQgPSBuZXcgV1MoJ3dzczovL3JlYWx0aW1lLnN1cGFiYXNlLmNvL3NvY2tldCcpCiAgICogYGBgCiAgICovCiAgc3RhdGljIGdldFdlYlNvY2tldENvbnN0cnVjdG9yKCkgewogICAgY29uc3QgZW52ID0gdGhpcy5kZXRlY3RFbnZpcm9ubWVudCgpOwogICAgaWYgKGVudi5jb25zdHJ1Y3RvcikgewogICAgICByZXR1cm4gZW52LmNvbnN0cnVjdG9yOwogICAgfQogICAgbGV0IGVycm9yTWVzc2FnZSA9IGVudi5lcnJvciB8fCAiV2ViU29ja2V0IG5vdCBzdXBwb3J0ZWQgaW4gdGhpcyBlbnZpcm9ubWVudC4iOwogICAgaWYgKGVudi53b3JrYXJvdW5kKSB7CiAgICAgIGVycm9yTWVzc2FnZSArPSBgCgpTdWdnZXN0ZWQgc29sdXRpb246ICR7ZW52Lndvcmthcm91bmR9YDsKICAgIH0KICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UpOwogIH0KICAvKioKICAgKiBDcmVhdGVzIGEgV2ViU29ja2V0IHVzaW5nIHRoZSBkZXRlY3RlZCBjb25zdHJ1Y3Rvci4KICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHMKICAgKiBjb25zdCBzb2NrZXQgPSBXZWJTb2NrZXRGYWN0b3J5LmNyZWF0ZVdlYlNvY2tldCgnd3NzOi8vcmVhbHRpbWUuc3VwYWJhc2UuY28vc29ja2V0JykKICAgKiBgYGAKICAgKi8KICBzdGF0aWMgY3JlYXRlV2ViU29ja2V0KHVybCwgcHJvdG9jb2xzKSB7CiAgICBjb25zdCBXUyA9IHRoaXMuZ2V0V2ViU29ja2V0Q29uc3RydWN0b3IoKTsKICAgIHJldHVybiBuZXcgV1ModXJsLCBwcm90b2NvbHMpOwogIH0KICAvKioKICAgKiBEZXRlY3RzIHdoZXRoZXIgdGhlIHJ1bnRpbWUgY2FuIGVzdGFibGlzaCBXZWJTb2NrZXQgY29ubmVjdGlvbnMuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIGBgYHRzCiAgICogaWYgKCFXZWJTb2NrZXRGYWN0b3J5LmlzV2ViU29ja2V0U3VwcG9ydGVkKCkpIHsKICAgKiAgIGNvbnNvbGUud2FybignRmFsbGluZyBiYWNrIHRvIGxvbmcgcG9sbGluZycpCiAgICogfQogICAqIGBgYAogICAqLwogIHN0YXRpYyBpc1dlYlNvY2tldFN1cHBvcnRlZCgpIHsKICAgIHRyeSB7CiAgICAgIGNvbnN0IGVudiA9IHRoaXMuZGV0ZWN0RW52aXJvbm1lbnQoKTsKICAgICAgcmV0dXJuIGVudi50eXBlID09PSAibmF0aXZlIiB8fCBlbnYudHlwZSA9PT0gIndzIjsKICAgIH0gY2F0Y2ggKF9hKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9Cn07CnZhciB3ZWJzb2NrZXRfZmFjdG9yeV9kZWZhdWx0ID0gV2ViU29ja2V0RmFjdG9yeTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrcmVhbHRpbWUtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvcmVhbHRpbWUtanMvZGlzdC9tb2R1bGUvbGliL3ZlcnNpb24uanMKdmFyIHZlcnNpb24yID0gIjIuOTcuMCI7CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK3JlYWx0aW1lLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL3JlYWx0aW1lLWpzL2Rpc3QvbW9kdWxlL2xpYi9jb25zdGFudHMuanMKdmFyIERFRkFVTFRfVkVSU0lPTiA9IGByZWFsdGltZS1qcy8ke3ZlcnNpb24yfWA7CnZhciBWU05fMV8wXzAgPSAiMS4wLjAiOwp2YXIgVlNOXzJfMF8wID0gIjIuMC4wIjsKdmFyIERFRkFVTFRfVlNOID0gVlNOXzJfMF8wOwp2YXIgREVGQVVMVF9USU1FT1VUID0gMWU0Owp2YXIgV1NfQ0xPU0VfTk9STUFMID0gMWUzOwp2YXIgTUFYX1BVU0hfQlVGRkVSX1NJWkUgPSAxMDA7CnZhciBTT0NLRVRfU1RBVEVTOwooZnVuY3Rpb24oU09DS0VUX1NUQVRFUzIpIHsKICBTT0NLRVRfU1RBVEVTMltTT0NLRVRfU1RBVEVTMlsiY29ubmVjdGluZyJdID0gMF0gPSAiY29ubmVjdGluZyI7CiAgU09DS0VUX1NUQVRFUzJbU09DS0VUX1NUQVRFUzJbIm9wZW4iXSA9IDFdID0gIm9wZW4iOwogIFNPQ0tFVF9TVEFURVMyW1NPQ0tFVF9TVEFURVMyWyJjbG9zaW5nIl0gPSAyXSA9ICJjbG9zaW5nIjsKICBTT0NLRVRfU1RBVEVTMltTT0NLRVRfU1RBVEVTMlsiY2xvc2VkIl0gPSAzXSA9ICJjbG9zZWQiOwp9KShTT0NLRVRfU1RBVEVTIHx8IChTT0NLRVRfU1RBVEVTID0ge30pKTsKdmFyIENIQU5ORUxfU1RBVEVTOwooZnVuY3Rpb24oQ0hBTk5FTF9TVEFURVMyKSB7CiAgQ0hBTk5FTF9TVEFURVMyWyJjbG9zZWQiXSA9ICJjbG9zZWQiOwogIENIQU5ORUxfU1RBVEVTMlsiZXJyb3JlZCJdID0gImVycm9yZWQiOwogIENIQU5ORUxfU1RBVEVTMlsiam9pbmVkIl0gPSAiam9pbmVkIjsKICBDSEFOTkVMX1NUQVRFUzJbImpvaW5pbmciXSA9ICJqb2luaW5nIjsKICBDSEFOTkVMX1NUQVRFUzJbImxlYXZpbmciXSA9ICJsZWF2aW5nIjsKfSkoQ0hBTk5FTF9TVEFURVMgfHwgKENIQU5ORUxfU1RBVEVTID0ge30pKTsKdmFyIENIQU5ORUxfRVZFTlRTOwooZnVuY3Rpb24oQ0hBTk5FTF9FVkVOVFMyKSB7CiAgQ0hBTk5FTF9FVkVOVFMyWyJjbG9zZSJdID0gInBoeF9jbG9zZSI7CiAgQ0hBTk5FTF9FVkVOVFMyWyJlcnJvciJdID0gInBoeF9lcnJvciI7CiAgQ0hBTk5FTF9FVkVOVFMyWyJqb2luIl0gPSAicGh4X2pvaW4iOwogIENIQU5ORUxfRVZFTlRTMlsicmVwbHkiXSA9ICJwaHhfcmVwbHkiOwogIENIQU5ORUxfRVZFTlRTMlsibGVhdmUiXSA9ICJwaHhfbGVhdmUiOwogIENIQU5ORUxfRVZFTlRTMlsiYWNjZXNzX3Rva2VuIl0gPSAiYWNjZXNzX3Rva2VuIjsKfSkoQ0hBTk5FTF9FVkVOVFMgfHwgKENIQU5ORUxfRVZFTlRTID0ge30pKTsKdmFyIFRSQU5TUE9SVFM7CihmdW5jdGlvbihUUkFOU1BPUlRTMikgewogIFRSQU5TUE9SVFMyWyJ3ZWJzb2NrZXQiXSA9ICJ3ZWJzb2NrZXQiOwp9KShUUkFOU1BPUlRTIHx8IChUUkFOU1BPUlRTID0ge30pKTsKdmFyIENPTk5FQ1RJT05fU1RBVEU7CihmdW5jdGlvbihDT05ORUNUSU9OX1NUQVRFMikgewogIENPTk5FQ1RJT05fU1RBVEUyWyJDb25uZWN0aW5nIl0gPSAiY29ubmVjdGluZyI7CiAgQ09OTkVDVElPTl9TVEFURTJbIk9wZW4iXSA9ICJvcGVuIjsKICBDT05ORUNUSU9OX1NUQVRFMlsiQ2xvc2luZyJdID0gImNsb3NpbmciOwogIENPTk5FQ1RJT05fU1RBVEUyWyJDbG9zZWQiXSA9ICJjbG9zZWQiOwp9KShDT05ORUNUSU9OX1NUQVRFIHx8IChDT05ORUNUSU9OX1NUQVRFID0ge30pKTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrcmVhbHRpbWUtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvcmVhbHRpbWUtanMvZGlzdC9tb2R1bGUvbGliL3NlcmlhbGl6ZXIuanMKdmFyIFNlcmlhbGl6ZXIgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoYWxsb3dlZE1ldGFkYXRhS2V5cykgewogICAgdGhpcy5IRUFERVJfTEVOR1RIID0gMTsKICAgIHRoaXMuVVNFUl9CUk9BRENBU1RfUFVTSF9NRVRBX0xFTkdUSCA9IDY7CiAgICB0aGlzLktJTkRTID0geyB1c2VyQnJvYWRjYXN0UHVzaDogMywgdXNlckJyb2FkY2FzdDogNCB9OwogICAgdGhpcy5CSU5BUllfRU5DT0RJTkcgPSAwOwogICAgdGhpcy5KU09OX0VOQ09ESU5HID0gMTsKICAgIHRoaXMuQlJPQURDQVNUX0VWRU5UID0gImJyb2FkY2FzdCI7CiAgICB0aGlzLmFsbG93ZWRNZXRhZGF0YUtleXMgPSBbXTsKICAgIHRoaXMuYWxsb3dlZE1ldGFkYXRhS2V5cyA9IGFsbG93ZWRNZXRhZGF0YUtleXMgIT09IG51bGwgJiYgYWxsb3dlZE1ldGFkYXRhS2V5cyAhPT0gdm9pZCAwID8gYWxsb3dlZE1ldGFkYXRhS2V5cyA6IFtdOwogIH0KICBlbmNvZGUobXNnLCBjYWxsYmFjaykgewogICAgaWYgKG1zZy5ldmVudCA9PT0gdGhpcy5CUk9BRENBU1RfRVZFTlQgJiYgIShtc2cucGF5bG9hZCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKSAmJiB0eXBlb2YgbXNnLnBheWxvYWQuZXZlbnQgPT09ICJzdHJpbmciKSB7CiAgICAgIHJldHVybiBjYWxsYmFjayh0aGlzLl9iaW5hcnlFbmNvZGVVc2VyQnJvYWRjYXN0UHVzaChtc2cpKTsKICAgIH0KICAgIGxldCBwYXlsb2FkID0gW21zZy5qb2luX3JlZiwgbXNnLnJlZiwgbXNnLnRvcGljLCBtc2cuZXZlbnQsIG1zZy5wYXlsb2FkXTsKICAgIHJldHVybiBjYWxsYmFjayhKU09OLnN0cmluZ2lmeShwYXlsb2FkKSk7CiAgfQogIF9iaW5hcnlFbmNvZGVVc2VyQnJvYWRjYXN0UHVzaChtZXNzYWdlKSB7CiAgICB2YXIgX2E7CiAgICBpZiAodGhpcy5faXNBcnJheUJ1ZmZlcigoX2EgPSBtZXNzYWdlLnBheWxvYWQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5wYXlsb2FkKSkgewogICAgICByZXR1cm4gdGhpcy5fZW5jb2RlQmluYXJ5VXNlckJyb2FkY2FzdFB1c2gobWVzc2FnZSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gdGhpcy5fZW5jb2RlSnNvblVzZXJCcm9hZGNhc3RQdXNoKG1lc3NhZ2UpOwogICAgfQogIH0KICBfZW5jb2RlQmluYXJ5VXNlckJyb2FkY2FzdFB1c2gobWVzc2FnZSkgewogICAgdmFyIF9hLCBfYjsKICAgIGNvbnN0IHVzZXJQYXlsb2FkID0gKF9iID0gKF9hID0gbWVzc2FnZS5wYXlsb2FkKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucGF5bG9hZCkgIT09IG51bGwgJiYgX2IgIT09IHZvaWQgMCA/IF9iIDogbmV3IEFycmF5QnVmZmVyKDApOwogICAgcmV0dXJuIHRoaXMuX2VuY29kZVVzZXJCcm9hZGNhc3RQdXNoKG1lc3NhZ2UsIHRoaXMuQklOQVJZX0VOQ09ESU5HLCB1c2VyUGF5bG9hZCk7CiAgfQogIF9lbmNvZGVKc29uVXNlckJyb2FkY2FzdFB1c2gobWVzc2FnZSkgewogICAgdmFyIF9hLCBfYjsKICAgIGNvbnN0IHVzZXJQYXlsb2FkID0gKF9iID0gKF9hID0gbWVzc2FnZS5wYXlsb2FkKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucGF5bG9hZCkgIT09IG51bGwgJiYgX2IgIT09IHZvaWQgMCA/IF9iIDoge307CiAgICBjb25zdCBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7CiAgICBjb25zdCBlbmNvZGVkVXNlclBheWxvYWQgPSBlbmNvZGVyLmVuY29kZShKU09OLnN0cmluZ2lmeSh1c2VyUGF5bG9hZCkpLmJ1ZmZlcjsKICAgIHJldHVybiB0aGlzLl9lbmNvZGVVc2VyQnJvYWRjYXN0UHVzaChtZXNzYWdlLCB0aGlzLkpTT05fRU5DT0RJTkcsIGVuY29kZWRVc2VyUGF5bG9hZCk7CiAgfQogIF9lbmNvZGVVc2VyQnJvYWRjYXN0UHVzaChtZXNzYWdlLCBlbmNvZGluZ1R5cGUsIGVuY29kZWRQYXlsb2FkKSB7CiAgICB2YXIgX2EsIF9iOwogICAgY29uc3QgdG9waWMgPSBtZXNzYWdlLnRvcGljOwogICAgY29uc3QgcmVmID0gKF9hID0gbWVzc2FnZS5yZWYpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6ICIiOwogICAgY29uc3Qgam9pblJlZiA9IChfYiA9IG1lc3NhZ2Uuam9pbl9yZWYpICE9PSBudWxsICYmIF9iICE9PSB2b2lkIDAgPyBfYiA6ICIiOwogICAgY29uc3QgdXNlckV2ZW50ID0gbWVzc2FnZS5wYXlsb2FkLmV2ZW50OwogICAgY29uc3QgcmVzdCA9IHRoaXMuYWxsb3dlZE1ldGFkYXRhS2V5cyA/IHRoaXMuX3BpY2sobWVzc2FnZS5wYXlsb2FkLCB0aGlzLmFsbG93ZWRNZXRhZGF0YUtleXMpIDoge307CiAgICBjb25zdCBtZXRhZGF0YSA9IE9iamVjdC5rZXlzKHJlc3QpLmxlbmd0aCA9PT0gMCA/ICIiIDogSlNPTi5zdHJpbmdpZnkocmVzdCk7CiAgICBpZiAoam9pblJlZi5sZW5ndGggPiAyNTUpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKGBqb2luUmVmIGxlbmd0aCAke2pvaW5SZWYubGVuZ3RofSBleGNlZWRzIG1heGltdW0gb2YgMjU1YCk7CiAgICB9CiAgICBpZiAocmVmLmxlbmd0aCA+IDI1NSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYHJlZiBsZW5ndGggJHtyZWYubGVuZ3RofSBleGNlZWRzIG1heGltdW0gb2YgMjU1YCk7CiAgICB9CiAgICBpZiAodG9waWMubGVuZ3RoID4gMjU1KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgdG9waWMgbGVuZ3RoICR7dG9waWMubGVuZ3RofSBleGNlZWRzIG1heGltdW0gb2YgMjU1YCk7CiAgICB9CiAgICBpZiAodXNlckV2ZW50Lmxlbmd0aCA+IDI1NSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYHVzZXJFdmVudCBsZW5ndGggJHt1c2VyRXZlbnQubGVuZ3RofSBleGNlZWRzIG1heGltdW0gb2YgMjU1YCk7CiAgICB9CiAgICBpZiAobWV0YWRhdGEubGVuZ3RoID4gMjU1KSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgbWV0YWRhdGEgbGVuZ3RoICR7bWV0YWRhdGEubGVuZ3RofSBleGNlZWRzIG1heGltdW0gb2YgMjU1YCk7CiAgICB9CiAgICBjb25zdCBtZXRhTGVuZ3RoID0gdGhpcy5VU0VSX0JST0FEQ0FTVF9QVVNIX01FVEFfTEVOR1RIICsgam9pblJlZi5sZW5ndGggKyByZWYubGVuZ3RoICsgdG9waWMubGVuZ3RoICsgdXNlckV2ZW50Lmxlbmd0aCArIG1ldGFkYXRhLmxlbmd0aDsKICAgIGNvbnN0IGhlYWRlciA9IG5ldyBBcnJheUJ1ZmZlcih0aGlzLkhFQURFUl9MRU5HVEggKyBtZXRhTGVuZ3RoKTsKICAgIGxldCB2aWV3ID0gbmV3IERhdGFWaWV3KGhlYWRlcik7CiAgICBsZXQgb2Zmc2V0ID0gMDsKICAgIHZpZXcuc2V0VWludDgob2Zmc2V0KyssIHRoaXMuS0lORFMudXNlckJyb2FkY2FzdFB1c2gpOwogICAgdmlldy5zZXRVaW50OChvZmZzZXQrKywgam9pblJlZi5sZW5ndGgpOwogICAgdmlldy5zZXRVaW50OChvZmZzZXQrKywgcmVmLmxlbmd0aCk7CiAgICB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCB0b3BpYy5sZW5ndGgpOwogICAgdmlldy5zZXRVaW50OChvZmZzZXQrKywgdXNlckV2ZW50Lmxlbmd0aCk7CiAgICB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCBtZXRhZGF0YS5sZW5ndGgpOwogICAgdmlldy5zZXRVaW50OChvZmZzZXQrKywgZW5jb2RpbmdUeXBlKTsKICAgIEFycmF5LmZyb20oam9pblJlZiwgKGNoYXIpID0+IHZpZXcuc2V0VWludDgob2Zmc2V0KyssIGNoYXIuY2hhckNvZGVBdCgwKSkpOwogICAgQXJyYXkuZnJvbShyZWYsIChjaGFyKSA9PiB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCBjaGFyLmNoYXJDb2RlQXQoMCkpKTsKICAgIEFycmF5LmZyb20odG9waWMsIChjaGFyKSA9PiB2aWV3LnNldFVpbnQ4KG9mZnNldCsrLCBjaGFyLmNoYXJDb2RlQXQoMCkpKTsKICAgIEFycmF5LmZyb20odXNlckV2ZW50LCAoY2hhcikgPT4gdmlldy5zZXRVaW50OChvZmZzZXQrKywgY2hhci5jaGFyQ29kZUF0KDApKSk7CiAgICBBcnJheS5mcm9tKG1ldGFkYXRhLCAoY2hhcikgPT4gdmlldy5zZXRVaW50OChvZmZzZXQrKywgY2hhci5jaGFyQ29kZUF0KDApKSk7CiAgICB2YXIgY29tYmluZWQgPSBuZXcgVWludDhBcnJheShoZWFkZXIuYnl0ZUxlbmd0aCArIGVuY29kZWRQYXlsb2FkLmJ5dGVMZW5ndGgpOwogICAgY29tYmluZWQuc2V0KG5ldyBVaW50OEFycmF5KGhlYWRlciksIDApOwogICAgY29tYmluZWQuc2V0KG5ldyBVaW50OEFycmF5KGVuY29kZWRQYXlsb2FkKSwgaGVhZGVyLmJ5dGVMZW5ndGgpOwogICAgcmV0dXJuIGNvbWJpbmVkLmJ1ZmZlcjsKICB9CiAgZGVjb2RlKHJhd1BheWxvYWQsIGNhbGxiYWNrKSB7CiAgICBpZiAodGhpcy5faXNBcnJheUJ1ZmZlcihyYXdQYXlsb2FkKSkgewogICAgICBsZXQgcmVzdWx0ID0gdGhpcy5fYmluYXJ5RGVjb2RlKHJhd1BheWxvYWQpOwogICAgICByZXR1cm4gY2FsbGJhY2socmVzdWx0KTsKICAgIH0KICAgIGlmICh0eXBlb2YgcmF3UGF5bG9hZCA9PT0gInN0cmluZyIpIHsKICAgICAgY29uc3QganNvblBheWxvYWQgPSBKU09OLnBhcnNlKHJhd1BheWxvYWQpOwogICAgICBjb25zdCBbam9pbl9yZWYsIHJlZiwgdG9waWMsIGV2ZW50LCBwYXlsb2FkXSA9IGpzb25QYXlsb2FkOwogICAgICByZXR1cm4gY2FsbGJhY2soeyBqb2luX3JlZiwgcmVmLCB0b3BpYywgZXZlbnQsIHBheWxvYWQgfSk7CiAgICB9CiAgICByZXR1cm4gY2FsbGJhY2soe30pOwogIH0KICBfYmluYXJ5RGVjb2RlKGJ1ZmZlcikgewogICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIpOwogICAgY29uc3Qga2luZCA9IHZpZXcuZ2V0VWludDgoMCk7CiAgICBjb25zdCBkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCk7CiAgICBzd2l0Y2ggKGtpbmQpIHsKICAgICAgY2FzZSB0aGlzLktJTkRTLnVzZXJCcm9hZGNhc3Q6CiAgICAgICAgcmV0dXJuIHRoaXMuX2RlY29kZVVzZXJCcm9hZGNhc3QoYnVmZmVyLCB2aWV3LCBkZWNvZGVyKTsKICAgIH0KICB9CiAgX2RlY29kZVVzZXJCcm9hZGNhc3QoYnVmZmVyLCB2aWV3LCBkZWNvZGVyKSB7CiAgICBjb25zdCB0b3BpY1NpemUgPSB2aWV3LmdldFVpbnQ4KDEpOwogICAgY29uc3QgdXNlckV2ZW50U2l6ZSA9IHZpZXcuZ2V0VWludDgoMik7CiAgICBjb25zdCBtZXRhZGF0YVNpemUgPSB2aWV3LmdldFVpbnQ4KDMpOwogICAgY29uc3QgcGF5bG9hZEVuY29kaW5nID0gdmlldy5nZXRVaW50OCg0KTsKICAgIGxldCBvZmZzZXQgPSB0aGlzLkhFQURFUl9MRU5HVEggKyA0OwogICAgY29uc3QgdG9waWMgPSBkZWNvZGVyLmRlY29kZShidWZmZXIuc2xpY2Uob2Zmc2V0LCBvZmZzZXQgKyB0b3BpY1NpemUpKTsKICAgIG9mZnNldCA9IG9mZnNldCArIHRvcGljU2l6ZTsKICAgIGNvbnN0IHVzZXJFdmVudCA9IGRlY29kZXIuZGVjb2RlKGJ1ZmZlci5zbGljZShvZmZzZXQsIG9mZnNldCArIHVzZXJFdmVudFNpemUpKTsKICAgIG9mZnNldCA9IG9mZnNldCArIHVzZXJFdmVudFNpemU7CiAgICBjb25zdCBtZXRhZGF0YSA9IGRlY29kZXIuZGVjb2RlKGJ1ZmZlci5zbGljZShvZmZzZXQsIG9mZnNldCArIG1ldGFkYXRhU2l6ZSkpOwogICAgb2Zmc2V0ID0gb2Zmc2V0ICsgbWV0YWRhdGFTaXplOwogICAgY29uc3QgcGF5bG9hZCA9IGJ1ZmZlci5zbGljZShvZmZzZXQsIGJ1ZmZlci5ieXRlTGVuZ3RoKTsKICAgIGNvbnN0IHBhcnNlZFBheWxvYWQgPSBwYXlsb2FkRW5jb2RpbmcgPT09IHRoaXMuSlNPTl9FTkNPRElORyA/IEpTT04ucGFyc2UoZGVjb2Rlci5kZWNvZGUocGF5bG9hZCkpIDogcGF5bG9hZDsKICAgIGNvbnN0IGRhdGEgPSB7CiAgICAgIHR5cGU6IHRoaXMuQlJPQURDQVNUX0VWRU5ULAogICAgICBldmVudDogdXNlckV2ZW50LAogICAgICBwYXlsb2FkOiBwYXJzZWRQYXlsb2FkCiAgICB9OwogICAgaWYgKG1ldGFkYXRhU2l6ZSA+IDApIHsKICAgICAgZGF0YVsibWV0YSJdID0gSlNPTi5wYXJzZShtZXRhZGF0YSk7CiAgICB9CiAgICByZXR1cm4geyBqb2luX3JlZjogbnVsbCwgcmVmOiBudWxsLCB0b3BpYywgZXZlbnQ6IHRoaXMuQlJPQURDQVNUX0VWRU5ULCBwYXlsb2FkOiBkYXRhIH07CiAgfQogIF9pc0FycmF5QnVmZmVyKGJ1ZmZlcikgewogICAgdmFyIF9hOwogICAgcmV0dXJuIGJ1ZmZlciBpbnN0YW5jZW9mIEFycmF5QnVmZmVyIHx8ICgoX2EgPSBidWZmZXIgPT09IG51bGwgfHwgYnVmZmVyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBidWZmZXIuY29uc3RydWN0b3IpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5uYW1lKSA9PT0gIkFycmF5QnVmZmVyIjsKICB9CiAgX3BpY2sob2JqLCBrZXlzKSB7CiAgICBpZiAoIW9iaiB8fCB0eXBlb2Ygb2JqICE9PSAib2JqZWN0IikgewogICAgICByZXR1cm4ge307CiAgICB9CiAgICByZXR1cm4gT2JqZWN0LmZyb21FbnRyaWVzKE9iamVjdC5lbnRyaWVzKG9iaikuZmlsdGVyKChba2V5XSkgPT4ga2V5cy5pbmNsdWRlcyhrZXkpKSk7CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZStyZWFsdGltZS1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9yZWFsdGltZS1qcy9kaXN0L21vZHVsZS9saWIvdGltZXIuanMKdmFyIFRpbWVyID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGNhbGxiYWNrLCB0aW1lckNhbGMpIHsKICAgIHRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgIHRoaXMudGltZXJDYWxjID0gdGltZXJDYWxjOwogICAgdGhpcy50aW1lciA9IHZvaWQgMDsKICAgIHRoaXMudHJpZXMgPSAwOwogICAgdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgdGhpcy50aW1lckNhbGMgPSB0aW1lckNhbGM7CiAgfQogIHJlc2V0KCkgewogICAgdGhpcy50cmllcyA9IDA7CiAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lcik7CiAgICB0aGlzLnRpbWVyID0gdm9pZCAwOwogIH0KICAvLyBDYW5jZWxzIGFueSBwcmV2aW91cyBzY2hlZHVsZVRpbWVvdXQgYW5kIHNjaGVkdWxlcyBjYWxsYmFjawogIHNjaGVkdWxlVGltZW91dCgpIHsKICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTsKICAgIHRoaXMudGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgdGhpcy50cmllcyA9IHRoaXMudHJpZXMgKyAxOwogICAgICB0aGlzLmNhbGxiYWNrKCk7CiAgICB9LCB0aGlzLnRpbWVyQ2FsYyh0aGlzLnRyaWVzICsgMSkpOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrcmVhbHRpbWUtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvcmVhbHRpbWUtanMvZGlzdC9tb2R1bGUvbGliL3RyYW5zZm9ybWVycy5qcwp2YXIgUG9zdGdyZXNUeXBlczsKKGZ1bmN0aW9uKFBvc3RncmVzVHlwZXMyKSB7CiAgUG9zdGdyZXNUeXBlczJbImFic3RpbWUiXSA9ICJhYnN0aW1lIjsKICBQb3N0Z3Jlc1R5cGVzMlsiYm9vbCJdID0gImJvb2wiOwogIFBvc3RncmVzVHlwZXMyWyJkYXRlIl0gPSAiZGF0ZSI7CiAgUG9zdGdyZXNUeXBlczJbImRhdGVyYW5nZSJdID0gImRhdGVyYW5nZSI7CiAgUG9zdGdyZXNUeXBlczJbImZsb2F0NCJdID0gImZsb2F0NCI7CiAgUG9zdGdyZXNUeXBlczJbImZsb2F0OCJdID0gImZsb2F0OCI7CiAgUG9zdGdyZXNUeXBlczJbImludDIiXSA9ICJpbnQyIjsKICBQb3N0Z3Jlc1R5cGVzMlsiaW50NCJdID0gImludDQiOwogIFBvc3RncmVzVHlwZXMyWyJpbnQ0cmFuZ2UiXSA9ICJpbnQ0cmFuZ2UiOwogIFBvc3RncmVzVHlwZXMyWyJpbnQ4Il0gPSAiaW50OCI7CiAgUG9zdGdyZXNUeXBlczJbImludDhyYW5nZSJdID0gImludDhyYW5nZSI7CiAgUG9zdGdyZXNUeXBlczJbImpzb24iXSA9ICJqc29uIjsKICBQb3N0Z3Jlc1R5cGVzMlsianNvbmIiXSA9ICJqc29uYiI7CiAgUG9zdGdyZXNUeXBlczJbIm1vbmV5Il0gPSAibW9uZXkiOwogIFBvc3RncmVzVHlwZXMyWyJudW1lcmljIl0gPSAibnVtZXJpYyI7CiAgUG9zdGdyZXNUeXBlczJbIm9pZCJdID0gIm9pZCI7CiAgUG9zdGdyZXNUeXBlczJbInJlbHRpbWUiXSA9ICJyZWx0aW1lIjsKICBQb3N0Z3Jlc1R5cGVzMlsidGV4dCJdID0gInRleHQiOwogIFBvc3RncmVzVHlwZXMyWyJ0aW1lIl0gPSAidGltZSI7CiAgUG9zdGdyZXNUeXBlczJbInRpbWVzdGFtcCJdID0gInRpbWVzdGFtcCI7CiAgUG9zdGdyZXNUeXBlczJbInRpbWVzdGFtcHR6Il0gPSAidGltZXN0YW1wdHoiOwogIFBvc3RncmVzVHlwZXMyWyJ0aW1ldHoiXSA9ICJ0aW1ldHoiOwogIFBvc3RncmVzVHlwZXMyWyJ0c3JhbmdlIl0gPSAidHNyYW5nZSI7CiAgUG9zdGdyZXNUeXBlczJbInRzdHpyYW5nZSJdID0gInRzdHpyYW5nZSI7Cn0pKFBvc3RncmVzVHlwZXMgfHwgKFBvc3RncmVzVHlwZXMgPSB7fSkpOwp2YXIgY29udmVydENoYW5nZURhdGEgPSAoY29sdW1ucywgcmVjb3JkLCBvcHRpb25zID0ge30pID0+IHsKICB2YXIgX2E7CiAgY29uc3Qgc2tpcFR5cGVzID0gKF9hID0gb3B0aW9ucy5za2lwVHlwZXMpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IFtdOwogIGlmICghcmVjb3JkKSB7CiAgICByZXR1cm4ge307CiAgfQogIHJldHVybiBPYmplY3Qua2V5cyhyZWNvcmQpLnJlZHVjZSgoYWNjLCByZWNfa2V5KSA9PiB7CiAgICBhY2NbcmVjX2tleV0gPSBjb252ZXJ0Q29sdW1uKHJlY19rZXksIGNvbHVtbnMsIHJlY29yZCwgc2tpcFR5cGVzKTsKICAgIHJldHVybiBhY2M7CiAgfSwge30pOwp9Owp2YXIgY29udmVydENvbHVtbiA9IChjb2x1bW5OYW1lLCBjb2x1bW5zLCByZWNvcmQsIHNraXBUeXBlcykgPT4gewogIGNvbnN0IGNvbHVtbiA9IGNvbHVtbnMuZmluZCgoeDIpID0+IHgyLm5hbWUgPT09IGNvbHVtbk5hbWUpOwogIGNvbnN0IGNvbFR5cGUgPSBjb2x1bW4gPT09IG51bGwgfHwgY29sdW1uID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjb2x1bW4udHlwZTsKICBjb25zdCB2YWx1ZSA9IHJlY29yZFtjb2x1bW5OYW1lXTsKICBpZiAoY29sVHlwZSAmJiAhc2tpcFR5cGVzLmluY2x1ZGVzKGNvbFR5cGUpKSB7CiAgICByZXR1cm4gY29udmVydENlbGwoY29sVHlwZSwgdmFsdWUpOwogIH0KICByZXR1cm4gbm9vcDQodmFsdWUpOwp9Owp2YXIgY29udmVydENlbGwgPSAodHlwZSwgdmFsdWUpID0+IHsKICBpZiAodHlwZS5jaGFyQXQoMCkgPT09ICJfIikgewogICAgY29uc3QgZGF0YVR5cGUgPSB0eXBlLnNsaWNlKDEsIHR5cGUubGVuZ3RoKTsKICAgIHJldHVybiB0b0FycmF5KHZhbHVlLCBkYXRhVHlwZSk7CiAgfQogIHN3aXRjaCAodHlwZSkgewogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLmJvb2w6CiAgICAgIHJldHVybiB0b0Jvb2xlYW4odmFsdWUpOwogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLmZsb2F0NDoKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy5mbG9hdDg6CiAgICBjYXNlIFBvc3RncmVzVHlwZXMuaW50MjoKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy5pbnQ0OgogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLmludDg6CiAgICBjYXNlIFBvc3RncmVzVHlwZXMubnVtZXJpYzoKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy5vaWQ6CiAgICAgIHJldHVybiB0b051bWJlcih2YWx1ZSk7CiAgICBjYXNlIFBvc3RncmVzVHlwZXMuanNvbjoKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy5qc29uYjoKICAgICAgcmV0dXJuIHRvSnNvbih2YWx1ZSk7CiAgICBjYXNlIFBvc3RncmVzVHlwZXMudGltZXN0YW1wOgogICAgICByZXR1cm4gdG9UaW1lc3RhbXBTdHJpbmcodmFsdWUpOwogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLmFic3RpbWU6CiAgICBjYXNlIFBvc3RncmVzVHlwZXMuZGF0ZToKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy5kYXRlcmFuZ2U6CiAgICBjYXNlIFBvc3RncmVzVHlwZXMuaW50NHJhbmdlOgogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLmludDhyYW5nZToKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy5tb25leToKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy5yZWx0aW1lOgogICAgY2FzZSBQb3N0Z3Jlc1R5cGVzLnRleHQ6CiAgICBjYXNlIFBvc3RncmVzVHlwZXMudGltZToKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy50aW1lc3RhbXB0ejoKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy50aW1ldHo6CiAgICBjYXNlIFBvc3RncmVzVHlwZXMudHNyYW5nZToKICAgIGNhc2UgUG9zdGdyZXNUeXBlcy50c3R6cmFuZ2U6CiAgICAgIHJldHVybiBub29wNCh2YWx1ZSk7CiAgICBkZWZhdWx0OgogICAgICByZXR1cm4gbm9vcDQodmFsdWUpOwogIH0KfTsKdmFyIG5vb3A0ID0gKHZhbHVlKSA9PiB7CiAgcmV0dXJuIHZhbHVlOwp9Owp2YXIgdG9Cb29sZWFuID0gKHZhbHVlKSA9PiB7CiAgc3dpdGNoICh2YWx1ZSkgewogICAgY2FzZSAidCI6CiAgICAgIHJldHVybiB0cnVlOwogICAgY2FzZSAiZiI6CiAgICAgIHJldHVybiBmYWxzZTsKICAgIGRlZmF1bHQ6CiAgICAgIHJldHVybiB2YWx1ZTsKICB9Cn07CnZhciB0b051bWJlciA9ICh2YWx1ZSkgPT4gewogIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICBjb25zdCBwYXJzZWRWYWx1ZSA9IHBhcnNlRmxvYXQodmFsdWUpOwogICAgaWYgKCFOdW1iZXIuaXNOYU4ocGFyc2VkVmFsdWUpKSB7CiAgICAgIHJldHVybiBwYXJzZWRWYWx1ZTsKICAgIH0KICB9CiAgcmV0dXJuIHZhbHVlOwp9Owp2YXIgdG9Kc29uID0gKHZhbHVlKSA9PiB7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKICAgIH0gY2F0Y2ggKF9hKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICB9CiAgcmV0dXJuIHZhbHVlOwp9Owp2YXIgdG9BcnJheSA9ICh2YWx1ZSwgdHlwZSkgPT4gewogIGlmICh0eXBlb2YgdmFsdWUgIT09ICJzdHJpbmciKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQogIGNvbnN0IGxhc3RJZHggPSB2YWx1ZS5sZW5ndGggLSAxOwogIGNvbnN0IGNsb3NlQnJhY2UgPSB2YWx1ZVtsYXN0SWR4XTsKICBjb25zdCBvcGVuQnJhY2UgPSB2YWx1ZVswXTsKICBpZiAob3BlbkJyYWNlID09PSAieyIgJiYgY2xvc2VCcmFjZSA9PT0gIn0iKSB7CiAgICBsZXQgYXJyOwogICAgY29uc3QgdmFsVHJpbSA9IHZhbHVlLnNsaWNlKDEsIGxhc3RJZHgpOwogICAgdHJ5IHsKICAgICAgYXJyID0gSlNPTi5wYXJzZSgiWyIgKyB2YWxUcmltICsgIl0iKTsKICAgIH0gY2F0Y2ggKF8pIHsKICAgICAgYXJyID0gdmFsVHJpbSA/IHZhbFRyaW0uc3BsaXQoIiwiKSA6IFtdOwogICAgfQogICAgcmV0dXJuIGFyci5tYXAoKHZhbCkgPT4gY29udmVydENlbGwodHlwZSwgdmFsKSk7CiAgfQogIHJldHVybiB2YWx1ZTsKfTsKdmFyIHRvVGltZXN0YW1wU3RyaW5nID0gKHZhbHVlKSA9PiB7CiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIpIHsKICAgIHJldHVybiB2YWx1ZS5yZXBsYWNlKCIgIiwgIlQiKTsKICB9CiAgcmV0dXJuIHZhbHVlOwp9Owp2YXIgaHR0cEVuZHBvaW50VVJMID0gKHNvY2tldFVybCkgPT4gewogIGNvbnN0IHdzVXJsID0gbmV3IFVSTChzb2NrZXRVcmwpOwogIHdzVXJsLnByb3RvY29sID0gd3NVcmwucHJvdG9jb2wucmVwbGFjZSgvXndzL2ksICJodHRwIik7CiAgd3NVcmwucGF0aG5hbWUgPSB3c1VybC5wYXRobmFtZS5yZXBsYWNlKC9cLyskLywgIiIpLnJlcGxhY2UoL1wvc29ja2V0XC93ZWJzb2NrZXQkL2ksICIiKS5yZXBsYWNlKC9cL3NvY2tldCQvaSwgIiIpLnJlcGxhY2UoL1wvd2Vic29ja2V0JC9pLCAiIik7CiAgaWYgKHdzVXJsLnBhdGhuYW1lID09PSAiIiB8fCB3c1VybC5wYXRobmFtZSA9PT0gIi8iKSB7CiAgICB3c1VybC5wYXRobmFtZSA9ICIvYXBpL2Jyb2FkY2FzdCI7CiAgfSBlbHNlIHsKICAgIHdzVXJsLnBhdGhuYW1lID0gd3NVcmwucGF0aG5hbWUgKyAiL2FwaS9icm9hZGNhc3QiOwogIH0KICByZXR1cm4gd3NVcmwuaHJlZjsKfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrcmVhbHRpbWUtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvcmVhbHRpbWUtanMvZGlzdC9tb2R1bGUvbGliL3B1c2guanMKdmFyIFB1c2ggPSBjbGFzcyB7CiAgLyoqCiAgICogSW5pdGlhbGl6ZXMgdGhlIFB1c2gKICAgKgogICAqIEBwYXJhbSBjaGFubmVsIFRoZSBDaGFubmVsCiAgICogQHBhcmFtIGV2ZW50IFRoZSBldmVudCwgZm9yIGV4YW1wbGUgYCJwaHhfam9pbiJgCiAgICogQHBhcmFtIHBheWxvYWQgVGhlIHBheWxvYWQsIGZvciBleGFtcGxlIGB7dXNlcl9pZDogMTIzfWAKICAgKiBAcGFyYW0gdGltZW91dCBUaGUgcHVzaCB0aW1lb3V0IGluIG1pbGxpc2Vjb25kcwogICAqLwogIGNvbnN0cnVjdG9yKGNoYW5uZWwsIGV2ZW50LCBwYXlsb2FkID0ge30sIHRpbWVvdXQgPSBERUZBVUxUX1RJTUVPVVQpIHsKICAgIHRoaXMuY2hhbm5lbCA9IGNoYW5uZWw7CiAgICB0aGlzLmV2ZW50ID0gZXZlbnQ7CiAgICB0aGlzLnBheWxvYWQgPSBwYXlsb2FkOwogICAgdGhpcy50aW1lb3V0ID0gdGltZW91dDsKICAgIHRoaXMuc2VudCA9IGZhbHNlOwogICAgdGhpcy50aW1lb3V0VGltZXIgPSB2b2lkIDA7CiAgICB0aGlzLnJlZiA9ICIiOwogICAgdGhpcy5yZWNlaXZlZFJlc3AgPSBudWxsOwogICAgdGhpcy5yZWNIb29rcyA9IFtdOwogICAgdGhpcy5yZWZFdmVudCA9IG51bGw7CiAgfQogIHJlc2VuZCh0aW1lb3V0KSB7CiAgICB0aGlzLnRpbWVvdXQgPSB0aW1lb3V0OwogICAgdGhpcy5fY2FuY2VsUmVmRXZlbnQoKTsKICAgIHRoaXMucmVmID0gIiI7CiAgICB0aGlzLnJlZkV2ZW50ID0gbnVsbDsKICAgIHRoaXMucmVjZWl2ZWRSZXNwID0gbnVsbDsKICAgIHRoaXMuc2VudCA9IGZhbHNlOwogICAgdGhpcy5zZW5kKCk7CiAgfQogIHNlbmQoKSB7CiAgICBpZiAodGhpcy5faGFzUmVjZWl2ZWQoInRpbWVvdXQiKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLnN0YXJ0VGltZW91dCgpOwogICAgdGhpcy5zZW50ID0gdHJ1ZTsKICAgIHRoaXMuY2hhbm5lbC5zb2NrZXQucHVzaCh7CiAgICAgIHRvcGljOiB0aGlzLmNoYW5uZWwudG9waWMsCiAgICAgIGV2ZW50OiB0aGlzLmV2ZW50LAogICAgICBwYXlsb2FkOiB0aGlzLnBheWxvYWQsCiAgICAgIHJlZjogdGhpcy5yZWYsCiAgICAgIGpvaW5fcmVmOiB0aGlzLmNoYW5uZWwuX2pvaW5SZWYoKQogICAgfSk7CiAgfQogIHVwZGF0ZVBheWxvYWQocGF5bG9hZCkgewogICAgdGhpcy5wYXlsb2FkID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCB0aGlzLnBheWxvYWQpLCBwYXlsb2FkKTsKICB9CiAgcmVjZWl2ZShzdGF0dXMsIGNhbGxiYWNrKSB7CiAgICB2YXIgX2E7CiAgICBpZiAodGhpcy5faGFzUmVjZWl2ZWQoc3RhdHVzKSkgewogICAgICBjYWxsYmFjaygoX2EgPSB0aGlzLnJlY2VpdmVkUmVzcCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlc3BvbnNlKTsKICAgIH0KICAgIHRoaXMucmVjSG9va3MucHVzaCh7IHN0YXR1cywgY2FsbGJhY2sgfSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgc3RhcnRUaW1lb3V0KCkgewogICAgaWYgKHRoaXMudGltZW91dFRpbWVyKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMucmVmID0gdGhpcy5jaGFubmVsLnNvY2tldC5fbWFrZVJlZigpOwogICAgdGhpcy5yZWZFdmVudCA9IHRoaXMuY2hhbm5lbC5fcmVwbHlFdmVudE5hbWUodGhpcy5yZWYpOwogICAgY29uc3QgY2FsbGJhY2sgPSAocGF5bG9hZCkgPT4gewogICAgICB0aGlzLl9jYW5jZWxSZWZFdmVudCgpOwogICAgICB0aGlzLl9jYW5jZWxUaW1lb3V0KCk7CiAgICAgIHRoaXMucmVjZWl2ZWRSZXNwID0gcGF5bG9hZDsKICAgICAgdGhpcy5fbWF0Y2hSZWNlaXZlKHBheWxvYWQpOwogICAgfTsKICAgIHRoaXMuY2hhbm5lbC5fb24odGhpcy5yZWZFdmVudCwge30sIGNhbGxiYWNrKTsKICAgIHRoaXMudGltZW91dFRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgIHRoaXMudHJpZ2dlcigidGltZW91dCIsIHt9KTsKICAgIH0sIHRoaXMudGltZW91dCk7CiAgfQogIHRyaWdnZXIoc3RhdHVzLCByZXNwb25zZSkgewogICAgaWYgKHRoaXMucmVmRXZlbnQpCiAgICAgIHRoaXMuY2hhbm5lbC5fdHJpZ2dlcih0aGlzLnJlZkV2ZW50LCB7IHN0YXR1cywgcmVzcG9uc2UgfSk7CiAgfQogIGRlc3Ryb3koKSB7CiAgICB0aGlzLl9jYW5jZWxSZWZFdmVudCgpOwogICAgdGhpcy5fY2FuY2VsVGltZW91dCgpOwogIH0KICBfY2FuY2VsUmVmRXZlbnQoKSB7CiAgICBpZiAoIXRoaXMucmVmRXZlbnQpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5jaGFubmVsLl9vZmYodGhpcy5yZWZFdmVudCwge30pOwogIH0KICBfY2FuY2VsVGltZW91dCgpIHsKICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXRUaW1lcik7CiAgICB0aGlzLnRpbWVvdXRUaW1lciA9IHZvaWQgMDsKICB9CiAgX21hdGNoUmVjZWl2ZSh7IHN0YXR1cywgcmVzcG9uc2UgfSkgewogICAgdGhpcy5yZWNIb29rcy5maWx0ZXIoKGgpID0+IGguc3RhdHVzID09PSBzdGF0dXMpLmZvckVhY2goKGgpID0+IGguY2FsbGJhY2socmVzcG9uc2UpKTsKICB9CiAgX2hhc1JlY2VpdmVkKHN0YXR1cykgewogICAgcmV0dXJuIHRoaXMucmVjZWl2ZWRSZXNwICYmIHRoaXMucmVjZWl2ZWRSZXNwLnN0YXR1cyA9PT0gc3RhdHVzOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrcmVhbHRpbWUtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvcmVhbHRpbWUtanMvZGlzdC9tb2R1bGUvUmVhbHRpbWVQcmVzZW5jZS5qcwp2YXIgUkVBTFRJTUVfUFJFU0VOQ0VfTElTVEVOX0VWRU5UUzsKKGZ1bmN0aW9uKFJFQUxUSU1FX1BSRVNFTkNFX0xJU1RFTl9FVkVOVFMyKSB7CiAgUkVBTFRJTUVfUFJFU0VOQ0VfTElTVEVOX0VWRU5UUzJbIlNZTkMiXSA9ICJzeW5jIjsKICBSRUFMVElNRV9QUkVTRU5DRV9MSVNURU5fRVZFTlRTMlsiSk9JTiJdID0gImpvaW4iOwogIFJFQUxUSU1FX1BSRVNFTkNFX0xJU1RFTl9FVkVOVFMyWyJMRUFWRSJdID0gImxlYXZlIjsKfSkoUkVBTFRJTUVfUFJFU0VOQ0VfTElTVEVOX0VWRU5UUyB8fCAoUkVBTFRJTUVfUFJFU0VOQ0VfTElTVEVOX0VWRU5UUyA9IHt9KSk7CnZhciBSZWFsdGltZVByZXNlbmNlID0gY2xhc3MgX1JlYWx0aW1lUHJlc2VuY2UgewogIC8qKgogICAqIENyZWF0ZXMgYSBQcmVzZW5jZSBoZWxwZXIgdGhhdCBrZWVwcyB0aGUgbG9jYWwgcHJlc2VuY2Ugc3RhdGUgaW4gc3luYyB3aXRoIHRoZSBzZXJ2ZXIuCiAgICoKICAgKiBAcGFyYW0gY2hhbm5lbCAtIFRoZSByZWFsdGltZSBjaGFubmVsIHRvIGJpbmQgdG8uCiAgICogQHBhcmFtIG9wdHMgLSBPcHRpb25hbCBjdXN0b20gZXZlbnQgbmFtZXMsIGUuZy4gYHsgZXZlbnRzOiB7IHN0YXRlOiAnc3RhdGUnLCBkaWZmOiAnZGlmZicgfSB9YC4KICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHMKICAgKiBjb25zdCBwcmVzZW5jZSA9IG5ldyBSZWFsdGltZVByZXNlbmNlKGNoYW5uZWwpCiAgICoKICAgKiBjaGFubmVsLm9uKCdwcmVzZW5jZScsICh7IGV2ZW50LCBrZXkgfSkgPT4gewogICAqICAgY29uc29sZS5sb2coYFByZXNlbmNlICR7ZXZlbnR9IG9uICR7a2V5fWApCiAgICogfSkKICAgKiBgYGAKICAgKi8KICBjb25zdHJ1Y3RvcihjaGFubmVsLCBvcHRzKSB7CiAgICB0aGlzLmNoYW5uZWwgPSBjaGFubmVsOwogICAgdGhpcy5zdGF0ZSA9IHt9OwogICAgdGhpcy5wZW5kaW5nRGlmZnMgPSBbXTsKICAgIHRoaXMuam9pblJlZiA9IG51bGw7CiAgICB0aGlzLmVuYWJsZWQgPSBmYWxzZTsKICAgIHRoaXMuY2FsbGVyID0gewogICAgICBvbkpvaW46ICgpID0+IHsKICAgICAgfSwKICAgICAgb25MZWF2ZTogKCkgPT4gewogICAgICB9LAogICAgICBvblN5bmM6ICgpID0+IHsKICAgICAgfQogICAgfTsKICAgIGNvbnN0IGV2ZW50cyA9IChvcHRzID09PSBudWxsIHx8IG9wdHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdHMuZXZlbnRzKSB8fCB7CiAgICAgIHN0YXRlOiAicHJlc2VuY2Vfc3RhdGUiLAogICAgICBkaWZmOiAicHJlc2VuY2VfZGlmZiIKICAgIH07CiAgICB0aGlzLmNoYW5uZWwuX29uKGV2ZW50cy5zdGF0ZSwge30sIChuZXdTdGF0ZSkgPT4gewogICAgICBjb25zdCB7IG9uSm9pbiwgb25MZWF2ZSwgb25TeW5jIH0gPSB0aGlzLmNhbGxlcjsKICAgICAgdGhpcy5qb2luUmVmID0gdGhpcy5jaGFubmVsLl9qb2luUmVmKCk7CiAgICAgIHRoaXMuc3RhdGUgPSBfUmVhbHRpbWVQcmVzZW5jZS5zeW5jU3RhdGUodGhpcy5zdGF0ZSwgbmV3U3RhdGUsIG9uSm9pbiwgb25MZWF2ZSk7CiAgICAgIHRoaXMucGVuZGluZ0RpZmZzLmZvckVhY2goKGRpZmYpID0+IHsKICAgICAgICB0aGlzLnN0YXRlID0gX1JlYWx0aW1lUHJlc2VuY2Uuc3luY0RpZmYodGhpcy5zdGF0ZSwgZGlmZiwgb25Kb2luLCBvbkxlYXZlKTsKICAgICAgfSk7CiAgICAgIHRoaXMucGVuZGluZ0RpZmZzID0gW107CiAgICAgIG9uU3luYygpOwogICAgfSk7CiAgICB0aGlzLmNoYW5uZWwuX29uKGV2ZW50cy5kaWZmLCB7fSwgKGRpZmYpID0+IHsKICAgICAgY29uc3QgeyBvbkpvaW4sIG9uTGVhdmUsIG9uU3luYyB9ID0gdGhpcy5jYWxsZXI7CiAgICAgIGlmICh0aGlzLmluUGVuZGluZ1N5bmNTdGF0ZSgpKSB7CiAgICAgICAgdGhpcy5wZW5kaW5nRGlmZnMucHVzaChkaWZmKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnN0YXRlID0gX1JlYWx0aW1lUHJlc2VuY2Uuc3luY0RpZmYodGhpcy5zdGF0ZSwgZGlmZiwgb25Kb2luLCBvbkxlYXZlKTsKICAgICAgICBvblN5bmMoKTsKICAgICAgfQogICAgfSk7CiAgICB0aGlzLm9uSm9pbigoa2V5LCBjdXJyZW50UHJlc2VuY2VzLCBuZXdQcmVzZW5jZXMpID0+IHsKICAgICAgdGhpcy5jaGFubmVsLl90cmlnZ2VyKCJwcmVzZW5jZSIsIHsKICAgICAgICBldmVudDogImpvaW4iLAogICAgICAgIGtleSwKICAgICAgICBjdXJyZW50UHJlc2VuY2VzLAogICAgICAgIG5ld1ByZXNlbmNlcwogICAgICB9KTsKICAgIH0pOwogICAgdGhpcy5vbkxlYXZlKChrZXksIGN1cnJlbnRQcmVzZW5jZXMsIGxlZnRQcmVzZW5jZXMpID0+IHsKICAgICAgdGhpcy5jaGFubmVsLl90cmlnZ2VyKCJwcmVzZW5jZSIsIHsKICAgICAgICBldmVudDogImxlYXZlIiwKICAgICAgICBrZXksCiAgICAgICAgY3VycmVudFByZXNlbmNlcywKICAgICAgICBsZWZ0UHJlc2VuY2VzCiAgICAgIH0pOwogICAgfSk7CiAgICB0aGlzLm9uU3luYygoKSA9PiB7CiAgICAgIHRoaXMuY2hhbm5lbC5fdHJpZ2dlcigicHJlc2VuY2UiLCB7IGV2ZW50OiAic3luYyIgfSk7CiAgICB9KTsKICB9CiAgLyoqCiAgICogVXNlZCB0byBzeW5jIHRoZSBsaXN0IG9mIHByZXNlbmNlcyBvbiB0aGUgc2VydmVyIHdpdGggdGhlCiAgICogY2xpZW50J3Mgc3RhdGUuCiAgICoKICAgKiBBbiBvcHRpb25hbCBgb25Kb2luYCBhbmQgYG9uTGVhdmVgIGNhbGxiYWNrIGNhbiBiZSBwcm92aWRlZCB0bwogICAqIHJlYWN0IHRvIGNoYW5nZXMgaW4gdGhlIGNsaWVudCdzIGxvY2FsIHByZXNlbmNlcyBhY3Jvc3MKICAgKiBkaXNjb25uZWN0cyBhbmQgcmVjb25uZWN0cyB3aXRoIHRoZSBzZXJ2ZXIuCiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KICBzdGF0aWMgc3luY1N0YXRlKGN1cnJlbnRTdGF0ZSwgbmV3U3RhdGUsIG9uSm9pbiwgb25MZWF2ZSkgewogICAgY29uc3Qgc3RhdGUgPSB0aGlzLmNsb25lRGVlcChjdXJyZW50U3RhdGUpOwogICAgY29uc3QgdHJhbnNmb3JtZWRTdGF0ZSA9IHRoaXMudHJhbnNmb3JtU3RhdGUobmV3U3RhdGUpOwogICAgY29uc3Qgam9pbnMgPSB7fTsKICAgIGNvbnN0IGxlYXZlcyA9IHt9OwogICAgdGhpcy5tYXAoc3RhdGUsIChrZXksIHByZXNlbmNlcykgPT4gewogICAgICBpZiAoIXRyYW5zZm9ybWVkU3RhdGVba2V5XSkgewogICAgICAgIGxlYXZlc1trZXldID0gcHJlc2VuY2VzOwogICAgICB9CiAgICB9KTsKICAgIHRoaXMubWFwKHRyYW5zZm9ybWVkU3RhdGUsIChrZXksIG5ld1ByZXNlbmNlcykgPT4gewogICAgICBjb25zdCBjdXJyZW50UHJlc2VuY2VzID0gc3RhdGVba2V5XTsKICAgICAgaWYgKGN1cnJlbnRQcmVzZW5jZXMpIHsKICAgICAgICBjb25zdCBuZXdQcmVzZW5jZVJlZnMgPSBuZXdQcmVzZW5jZXMubWFwKChtKSA9PiBtLnByZXNlbmNlX3JlZik7CiAgICAgICAgY29uc3QgY3VyUHJlc2VuY2VSZWZzID0gY3VycmVudFByZXNlbmNlcy5tYXAoKG0pID0+IG0ucHJlc2VuY2VfcmVmKTsKICAgICAgICBjb25zdCBqb2luZWRQcmVzZW5jZXMgPSBuZXdQcmVzZW5jZXMuZmlsdGVyKChtKSA9PiBjdXJQcmVzZW5jZVJlZnMuaW5kZXhPZihtLnByZXNlbmNlX3JlZikgPCAwKTsKICAgICAgICBjb25zdCBsZWZ0UHJlc2VuY2VzID0gY3VycmVudFByZXNlbmNlcy5maWx0ZXIoKG0pID0+IG5ld1ByZXNlbmNlUmVmcy5pbmRleE9mKG0ucHJlc2VuY2VfcmVmKSA8IDApOwogICAgICAgIGlmIChqb2luZWRQcmVzZW5jZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgam9pbnNba2V5XSA9IGpvaW5lZFByZXNlbmNlczsKICAgICAgICB9CiAgICAgICAgaWYgKGxlZnRQcmVzZW5jZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgbGVhdmVzW2tleV0gPSBsZWZ0UHJlc2VuY2VzOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBqb2luc1trZXldID0gbmV3UHJlc2VuY2VzOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiB0aGlzLnN5bmNEaWZmKHN0YXRlLCB7IGpvaW5zLCBsZWF2ZXMgfSwgb25Kb2luLCBvbkxlYXZlKTsKICB9CiAgLyoqCiAgICogVXNlZCB0byBzeW5jIGEgZGlmZiBvZiBwcmVzZW5jZSBqb2luIGFuZCBsZWF2ZSBldmVudHMgZnJvbSB0aGUKICAgKiBzZXJ2ZXIsIGFzIHRoZXkgaGFwcGVuLgogICAqCiAgICogTGlrZSBgc3luY1N0YXRlYCwgYHN5bmNEaWZmYCBhY2NlcHRzIG9wdGlvbmFsIGBvbkpvaW5gIGFuZAogICAqIGBvbkxlYXZlYCBjYWxsYmFja3MgdG8gcmVhY3QgdG8gYSB1c2VyIGpvaW5pbmcgb3IgbGVhdmluZyBmcm9tIGEKICAgKiBkZXZpY2UuCiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KICBzdGF0aWMgc3luY0RpZmYoc3RhdGUsIGRpZmYsIG9uSm9pbiwgb25MZWF2ZSkgewogICAgY29uc3QgeyBqb2lucywgbGVhdmVzIH0gPSB7CiAgICAgIGpvaW5zOiB0aGlzLnRyYW5zZm9ybVN0YXRlKGRpZmYuam9pbnMpLAogICAgICBsZWF2ZXM6IHRoaXMudHJhbnNmb3JtU3RhdGUoZGlmZi5sZWF2ZXMpCiAgICB9OwogICAgaWYgKCFvbkpvaW4pIHsKICAgICAgb25Kb2luID0gKCkgPT4gewogICAgICB9OwogICAgfQogICAgaWYgKCFvbkxlYXZlKSB7CiAgICAgIG9uTGVhdmUgPSAoKSA9PiB7CiAgICAgIH07CiAgICB9CiAgICB0aGlzLm1hcChqb2lucywgKGtleSwgbmV3UHJlc2VuY2VzKSA9PiB7CiAgICAgIHZhciBfYTsKICAgICAgY29uc3QgY3VycmVudFByZXNlbmNlcyA9IChfYSA9IHN0YXRlW2tleV0pICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IFtdOwogICAgICBzdGF0ZVtrZXldID0gdGhpcy5jbG9uZURlZXAobmV3UHJlc2VuY2VzKTsKICAgICAgaWYgKGN1cnJlbnRQcmVzZW5jZXMubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnN0IGpvaW5lZFByZXNlbmNlUmVmcyA9IHN0YXRlW2tleV0ubWFwKChtKSA9PiBtLnByZXNlbmNlX3JlZik7CiAgICAgICAgY29uc3QgY3VyUHJlc2VuY2VzID0gY3VycmVudFByZXNlbmNlcy5maWx0ZXIoKG0pID0+IGpvaW5lZFByZXNlbmNlUmVmcy5pbmRleE9mKG0ucHJlc2VuY2VfcmVmKSA8IDApOwogICAgICAgIHN0YXRlW2tleV0udW5zaGlmdCguLi5jdXJQcmVzZW5jZXMpOwogICAgICB9CiAgICAgIG9uSm9pbihrZXksIGN1cnJlbnRQcmVzZW5jZXMsIG5ld1ByZXNlbmNlcyk7CiAgICB9KTsKICAgIHRoaXMubWFwKGxlYXZlcywgKGtleSwgbGVmdFByZXNlbmNlcykgPT4gewogICAgICBsZXQgY3VycmVudFByZXNlbmNlcyA9IHN0YXRlW2tleV07CiAgICAgIGlmICghY3VycmVudFByZXNlbmNlcykKICAgICAgICByZXR1cm47CiAgICAgIGNvbnN0IHByZXNlbmNlUmVmc1RvUmVtb3ZlID0gbGVmdFByZXNlbmNlcy5tYXAoKG0pID0+IG0ucHJlc2VuY2VfcmVmKTsKICAgICAgY3VycmVudFByZXNlbmNlcyA9IGN1cnJlbnRQcmVzZW5jZXMuZmlsdGVyKChtKSA9PiBwcmVzZW5jZVJlZnNUb1JlbW92ZS5pbmRleE9mKG0ucHJlc2VuY2VfcmVmKSA8IDApOwogICAgICBzdGF0ZVtrZXldID0gY3VycmVudFByZXNlbmNlczsKICAgICAgb25MZWF2ZShrZXksIGN1cnJlbnRQcmVzZW5jZXMsIGxlZnRQcmVzZW5jZXMpOwogICAgICBpZiAoY3VycmVudFByZXNlbmNlcy5sZW5ndGggPT09IDApCiAgICAgICAgZGVsZXRlIHN0YXRlW2tleV07CiAgICB9KTsKICAgIHJldHVybiBzdGF0ZTsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIHN0YXRpYyBtYXAob2JqLCBmdW5jKSB7CiAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMob2JqKS5tYXAoKGtleSkgPT4gZnVuYyhrZXksIG9ialtrZXldKSk7CiAgfQogIC8qKgogICAqIFJlbW92ZSAnbWV0YXMnIGtleQogICAqIENoYW5nZSAncGh4X3JlZicgdG8gJ3ByZXNlbmNlX3JlZicKICAgKiBSZW1vdmUgJ3BoeF9yZWYnIGFuZCAncGh4X3JlZl9wcmV2JwogICAqCiAgICogQGV4YW1wbGUKICAgKiAvLyByZXR1cm5zIHsKICAgKiAgYWJjMTIzOiBbCiAgICogICAgeyBwcmVzZW5jZV9yZWY6ICcyJywgdXNlcl9pZDogMSB9LAogICAqICAgIHsgcHJlc2VuY2VfcmVmOiAnMycsIHVzZXJfaWQ6IDIgfQogICAqICBdCiAgICogfQogICAqIFJlYWx0aW1lUHJlc2VuY2UudHJhbnNmb3JtU3RhdGUoewogICAqICBhYmMxMjM6IHsKICAgKiAgICBtZXRhczogWwogICAqICAgICAgeyBwaHhfcmVmOiAnMicsIHBoeF9yZWZfcHJldjogJzEnIHVzZXJfaWQ6IDEgfSwKICAgKiAgICAgIHsgcGh4X3JlZjogJzMnLCB1c2VyX2lkOiAyIH0KICAgKiAgICBdCiAgICogIH0KICAgKiB9KQogICAqCiAgICogQGludGVybmFsCiAgICovCiAgc3RhdGljIHRyYW5zZm9ybVN0YXRlKHN0YXRlKSB7CiAgICBzdGF0ZSA9IHRoaXMuY2xvbmVEZWVwKHN0YXRlKTsKICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhzdGF0ZSkucmVkdWNlKChuZXdTdGF0ZSwga2V5KSA9PiB7CiAgICAgIGNvbnN0IHByZXNlbmNlcyA9IHN0YXRlW2tleV07CiAgICAgIGlmICgibWV0YXMiIGluIHByZXNlbmNlcykgewogICAgICAgIG5ld1N0YXRlW2tleV0gPSBwcmVzZW5jZXMubWV0YXMubWFwKChwcmVzZW5jZSkgPT4gewogICAgICAgICAgcHJlc2VuY2VbInByZXNlbmNlX3JlZiJdID0gcHJlc2VuY2VbInBoeF9yZWYiXTsKICAgICAgICAgIGRlbGV0ZSBwcmVzZW5jZVsicGh4X3JlZiJdOwogICAgICAgICAgZGVsZXRlIHByZXNlbmNlWyJwaHhfcmVmX3ByZXYiXTsKICAgICAgICAgIHJldHVybiBwcmVzZW5jZTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBuZXdTdGF0ZVtrZXldID0gcHJlc2VuY2VzOwogICAgICB9CiAgICAgIHJldHVybiBuZXdTdGF0ZTsKICAgIH0sIHt9KTsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIHN0YXRpYyBjbG9uZURlZXAob2JqKSB7CiAgICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvYmopKTsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIG9uSm9pbihjYWxsYmFjaykgewogICAgdGhpcy5jYWxsZXIub25Kb2luID0gY2FsbGJhY2s7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBvbkxlYXZlKGNhbGxiYWNrKSB7CiAgICB0aGlzLmNhbGxlci5vbkxlYXZlID0gY2FsbGJhY2s7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBvblN5bmMoY2FsbGJhY2spIHsKICAgIHRoaXMuY2FsbGVyLm9uU3luYyA9IGNhbGxiYWNrOwogIH0KICAvKiogQGludGVybmFsICovCiAgaW5QZW5kaW5nU3luY1N0YXRlKCkgewogICAgcmV0dXJuICF0aGlzLmpvaW5SZWYgfHwgdGhpcy5qb2luUmVmICE9PSB0aGlzLmNoYW5uZWwuX2pvaW5SZWYoKTsKICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK3JlYWx0aW1lLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL3JlYWx0aW1lLWpzL2Rpc3QvbW9kdWxlL1JlYWx0aW1lQ2hhbm5lbC5qcwp2YXIgUkVBTFRJTUVfUE9TVEdSRVNfQ0hBTkdFU19MSVNURU5fRVZFTlQ7CihmdW5jdGlvbihSRUFMVElNRV9QT1NUR1JFU19DSEFOR0VTX0xJU1RFTl9FVkVOVDIpIHsKICBSRUFMVElNRV9QT1NUR1JFU19DSEFOR0VTX0xJU1RFTl9FVkVOVDJbIkFMTCJdID0gIioiOwogIFJFQUxUSU1FX1BPU1RHUkVTX0NIQU5HRVNfTElTVEVOX0VWRU5UMlsiSU5TRVJUIl0gPSAiSU5TRVJUIjsKICBSRUFMVElNRV9QT1NUR1JFU19DSEFOR0VTX0xJU1RFTl9FVkVOVDJbIlVQREFURSJdID0gIlVQREFURSI7CiAgUkVBTFRJTUVfUE9TVEdSRVNfQ0hBTkdFU19MSVNURU5fRVZFTlQyWyJERUxFVEUiXSA9ICJERUxFVEUiOwp9KShSRUFMVElNRV9QT1NUR1JFU19DSEFOR0VTX0xJU1RFTl9FVkVOVCB8fCAoUkVBTFRJTUVfUE9TVEdSRVNfQ0hBTkdFU19MSVNURU5fRVZFTlQgPSB7fSkpOwp2YXIgUkVBTFRJTUVfTElTVEVOX1RZUEVTOwooZnVuY3Rpb24oUkVBTFRJTUVfTElTVEVOX1RZUEVTMikgewogIFJFQUxUSU1FX0xJU1RFTl9UWVBFUzJbIkJST0FEQ0FTVCJdID0gImJyb2FkY2FzdCI7CiAgUkVBTFRJTUVfTElTVEVOX1RZUEVTMlsiUFJFU0VOQ0UiXSA9ICJwcmVzZW5jZSI7CiAgUkVBTFRJTUVfTElTVEVOX1RZUEVTMlsiUE9TVEdSRVNfQ0hBTkdFUyJdID0gInBvc3RncmVzX2NoYW5nZXMiOwogIFJFQUxUSU1FX0xJU1RFTl9UWVBFUzJbIlNZU1RFTSJdID0gInN5c3RlbSI7Cn0pKFJFQUxUSU1FX0xJU1RFTl9UWVBFUyB8fCAoUkVBTFRJTUVfTElTVEVOX1RZUEVTID0ge30pKTsKdmFyIFJFQUxUSU1FX1NVQlNDUklCRV9TVEFURVM7CihmdW5jdGlvbihSRUFMVElNRV9TVUJTQ1JJQkVfU1RBVEVTMikgewogIFJFQUxUSU1FX1NVQlNDUklCRV9TVEFURVMyWyJTVUJTQ1JJQkVEIl0gPSAiU1VCU0NSSUJFRCI7CiAgUkVBTFRJTUVfU1VCU0NSSUJFX1NUQVRFUzJbIlRJTUVEX09VVCJdID0gIlRJTUVEX09VVCI7CiAgUkVBTFRJTUVfU1VCU0NSSUJFX1NUQVRFUzJbIkNMT1NFRCJdID0gIkNMT1NFRCI7CiAgUkVBTFRJTUVfU1VCU0NSSUJFX1NUQVRFUzJbIkNIQU5ORUxfRVJST1IiXSA9ICJDSEFOTkVMX0VSUk9SIjsKfSkoUkVBTFRJTUVfU1VCU0NSSUJFX1NUQVRFUyB8fCAoUkVBTFRJTUVfU1VCU0NSSUJFX1NUQVRFUyA9IHt9KSk7CnZhciBSZWFsdGltZUNoYW5uZWwgPSBjbGFzcyBfUmVhbHRpbWVDaGFubmVsIHsKICAvKioKICAgKiBDcmVhdGVzIGEgY2hhbm5lbCB0aGF0IGNhbiBicm9hZGNhc3QgbWVzc2FnZXMsIHN5bmMgcHJlc2VuY2UsIGFuZCBsaXN0ZW4gdG8gUG9zdGdyZXMgY2hhbmdlcy4KICAgKgogICAqIFRoZSB0b3BpYyBkZXRlcm1pbmVzIHdoaWNoIHJlYWx0aW1lIHN0cmVhbSB5b3UgYXJlIHN1YnNjcmliaW5nIHRvLiBDb25maWcgb3B0aW9ucyBsZXQgeW91CiAgICogZW5hYmxlIGFja25vd2xlZGdlbWVudCBmb3IgYnJvYWRjYXN0cywgcHJlc2VuY2UgdHJhY2tpbmcsIG9yIHByaXZhdGUgY2hhbm5lbHMuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIGBgYHRzCiAgICogaW1wb3J0IFJlYWx0aW1lQ2xpZW50IGZyb20gJ0BzdXBhYmFzZS9yZWFsdGltZS1qcycKICAgKgogICAqIGNvbnN0IGNsaWVudCA9IG5ldyBSZWFsdGltZUNsaWVudCgnaHR0cHM6Ly94eXpjb21wYW55LnN1cGFiYXNlLmNvL3JlYWx0aW1lL3YxJywgewogICAqICAgcGFyYW1zOiB7IGFwaWtleTogJ3B1YmxpYy1hbm9uLWtleScgfSwKICAgKiB9KQogICAqIGNvbnN0IGNoYW5uZWwgPSBuZXcgUmVhbHRpbWVDaGFubmVsKCdyZWFsdGltZTpwdWJsaWM6bWVzc2FnZXMnLCB7IGNvbmZpZzoge30gfSwgY2xpZW50KQogICAqIGBgYAogICAqLwogIGNvbnN0cnVjdG9yKHRvcGljLCBwYXJhbXMgPSB7IGNvbmZpZzoge30gfSwgc29ja2V0KSB7CiAgICB2YXIgX2EsIF9iOwogICAgdGhpcy50b3BpYyA9IHRvcGljOwogICAgdGhpcy5wYXJhbXMgPSBwYXJhbXM7CiAgICB0aGlzLnNvY2tldCA9IHNvY2tldDsKICAgIHRoaXMuYmluZGluZ3MgPSB7fTsKICAgIHRoaXMuc3RhdGUgPSBDSEFOTkVMX1NUQVRFUy5jbG9zZWQ7CiAgICB0aGlzLmpvaW5lZE9uY2UgPSBmYWxzZTsKICAgIHRoaXMucHVzaEJ1ZmZlciA9IFtdOwogICAgdGhpcy5zdWJUb3BpYyA9IHRvcGljLnJlcGxhY2UoL15yZWFsdGltZTovaSwgIiIpOwogICAgdGhpcy5wYXJhbXMuY29uZmlnID0gT2JqZWN0LmFzc2lnbih7CiAgICAgIGJyb2FkY2FzdDogeyBhY2s6IGZhbHNlLCBzZWxmOiBmYWxzZSB9LAogICAgICBwcmVzZW5jZTogeyBrZXk6ICIiLCBlbmFibGVkOiBmYWxzZSB9LAogICAgICBwcml2YXRlOiBmYWxzZQogICAgfSwgcGFyYW1zLmNvbmZpZyk7CiAgICB0aGlzLnRpbWVvdXQgPSB0aGlzLnNvY2tldC50aW1lb3V0OwogICAgdGhpcy5qb2luUHVzaCA9IG5ldyBQdXNoKHRoaXMsIENIQU5ORUxfRVZFTlRTLmpvaW4sIHRoaXMucGFyYW1zLCB0aGlzLnRpbWVvdXQpOwogICAgdGhpcy5yZWpvaW5UaW1lciA9IG5ldyBUaW1lcigoKSA9PiB0aGlzLl9yZWpvaW5VbnRpbENvbm5lY3RlZCgpLCB0aGlzLnNvY2tldC5yZWNvbm5lY3RBZnRlck1zKTsKICAgIHRoaXMuam9pblB1c2gucmVjZWl2ZSgib2siLCAoKSA9PiB7CiAgICAgIHRoaXMuc3RhdGUgPSBDSEFOTkVMX1NUQVRFUy5qb2luZWQ7CiAgICAgIHRoaXMucmVqb2luVGltZXIucmVzZXQoKTsKICAgICAgdGhpcy5wdXNoQnVmZmVyLmZvckVhY2goKHB1c2hFdmVudCkgPT4gcHVzaEV2ZW50LnNlbmQoKSk7CiAgICAgIHRoaXMucHVzaEJ1ZmZlciA9IFtdOwogICAgfSk7CiAgICB0aGlzLl9vbkNsb3NlKCgpID0+IHsKICAgICAgdGhpcy5yZWpvaW5UaW1lci5yZXNldCgpOwogICAgICB0aGlzLnNvY2tldC5sb2coImNoYW5uZWwiLCBgY2xvc2UgJHt0aGlzLnRvcGljfSAke3RoaXMuX2pvaW5SZWYoKX1gKTsKICAgICAgdGhpcy5zdGF0ZSA9IENIQU5ORUxfU1RBVEVTLmNsb3NlZDsKICAgICAgdGhpcy5zb2NrZXQuX3JlbW92ZSh0aGlzKTsKICAgIH0pOwogICAgdGhpcy5fb25FcnJvcigocmVhc29uKSA9PiB7CiAgICAgIGlmICh0aGlzLl9pc0xlYXZpbmcoKSB8fCB0aGlzLl9pc0Nsb3NlZCgpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMuc29ja2V0LmxvZygiY2hhbm5lbCIsIGBlcnJvciAke3RoaXMudG9waWN9YCwgcmVhc29uKTsKICAgICAgdGhpcy5zdGF0ZSA9IENIQU5ORUxfU1RBVEVTLmVycm9yZWQ7CiAgICAgIHRoaXMucmVqb2luVGltZXIuc2NoZWR1bGVUaW1lb3V0KCk7CiAgICB9KTsKICAgIHRoaXMuam9pblB1c2gucmVjZWl2ZSgidGltZW91dCIsICgpID0+IHsKICAgICAgaWYgKCF0aGlzLl9pc0pvaW5pbmcoKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB0aGlzLnNvY2tldC5sb2coImNoYW5uZWwiLCBgdGltZW91dCAke3RoaXMudG9waWN9YCwgdGhpcy5qb2luUHVzaC50aW1lb3V0KTsKICAgICAgdGhpcy5zdGF0ZSA9IENIQU5ORUxfU1RBVEVTLmVycm9yZWQ7CiAgICAgIHRoaXMucmVqb2luVGltZXIuc2NoZWR1bGVUaW1lb3V0KCk7CiAgICB9KTsKICAgIHRoaXMuam9pblB1c2gucmVjZWl2ZSgiZXJyb3IiLCAocmVhc29uKSA9PiB7CiAgICAgIGlmICh0aGlzLl9pc0xlYXZpbmcoKSB8fCB0aGlzLl9pc0Nsb3NlZCgpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRoaXMuc29ja2V0LmxvZygiY2hhbm5lbCIsIGBlcnJvciAke3RoaXMudG9waWN9YCwgcmVhc29uKTsKICAgICAgdGhpcy5zdGF0ZSA9IENIQU5ORUxfU1RBVEVTLmVycm9yZWQ7CiAgICAgIHRoaXMucmVqb2luVGltZXIuc2NoZWR1bGVUaW1lb3V0KCk7CiAgICB9KTsKICAgIHRoaXMuX29uKENIQU5ORUxfRVZFTlRTLnJlcGx5LCB7fSwgKHBheWxvYWQsIHJlZikgPT4gewogICAgICB0aGlzLl90cmlnZ2VyKHRoaXMuX3JlcGx5RXZlbnROYW1lKHJlZiksIHBheWxvYWQpOwogICAgfSk7CiAgICB0aGlzLnByZXNlbmNlID0gbmV3IFJlYWx0aW1lUHJlc2VuY2UodGhpcyk7CiAgICB0aGlzLmJyb2FkY2FzdEVuZHBvaW50VVJMID0gaHR0cEVuZHBvaW50VVJMKHRoaXMuc29ja2V0LmVuZFBvaW50KTsKICAgIHRoaXMucHJpdmF0ZSA9IHRoaXMucGFyYW1zLmNvbmZpZy5wcml2YXRlIHx8IGZhbHNlOwogICAgaWYgKCF0aGlzLnByaXZhdGUgJiYgKChfYiA9IChfYSA9IHRoaXMucGFyYW1zLmNvbmZpZykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmJyb2FkY2FzdCkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnJlcGxheSkpIHsKICAgICAgdGhyb3cgYHRyaWVkIHRvIHVzZSByZXBsYXkgb24gcHVibGljIGNoYW5uZWwgJyR7dGhpcy50b3BpY30nLiBJdCBtdXN0IGJlIGEgcHJpdmF0ZSBjaGFubmVsLmA7CiAgICB9CiAgfQogIC8qKiBTdWJzY3JpYmUgcmVnaXN0ZXJzIHlvdXIgY2xpZW50IHdpdGggdGhlIHNlcnZlciAqLwogIHN1YnNjcmliZShjYWxsYmFjaywgdGltZW91dCA9IHRoaXMudGltZW91dCkgewogICAgdmFyIF9hLCBfYiwgX2M7CiAgICBpZiAoIXRoaXMuc29ja2V0LmlzQ29ubmVjdGVkKCkpIHsKICAgICAgdGhpcy5zb2NrZXQuY29ubmVjdCgpOwogICAgfQogICAgaWYgKHRoaXMuc3RhdGUgPT0gQ0hBTk5FTF9TVEFURVMuY2xvc2VkKSB7CiAgICAgIGNvbnN0IHsgY29uZmlnOiB7IGJyb2FkY2FzdCwgcHJlc2VuY2UsIHByaXZhdGU6IGlzUHJpdmF0ZSB9IH0gPSB0aGlzLnBhcmFtczsKICAgICAgY29uc3QgcG9zdGdyZXNfY2hhbmdlcyA9IChfYiA9IChfYSA9IHRoaXMuYmluZGluZ3MucG9zdGdyZXNfY2hhbmdlcykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLm1hcCgocjIpID0+IHIyLmZpbHRlcikpICE9PSBudWxsICYmIF9iICE9PSB2b2lkIDAgPyBfYiA6IFtdOwogICAgICBjb25zdCBwcmVzZW5jZV9lbmFibGVkID0gISF0aGlzLmJpbmRpbmdzW1JFQUxUSU1FX0xJU1RFTl9UWVBFUy5QUkVTRU5DRV0gJiYgdGhpcy5iaW5kaW5nc1tSRUFMVElNRV9MSVNURU5fVFlQRVMuUFJFU0VOQ0VdLmxlbmd0aCA+IDAgfHwgKChfYyA9IHRoaXMucGFyYW1zLmNvbmZpZy5wcmVzZW5jZSkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmVuYWJsZWQpID09PSB0cnVlOwogICAgICBjb25zdCBhY2Nlc3NUb2tlblBheWxvYWQgPSB7fTsKICAgICAgY29uc3QgY29uZmlnID0gewogICAgICAgIGJyb2FkY2FzdCwKICAgICAgICBwcmVzZW5jZTogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBwcmVzZW5jZSksIHsgZW5hYmxlZDogcHJlc2VuY2VfZW5hYmxlZCB9KSwKICAgICAgICBwb3N0Z3Jlc19jaGFuZ2VzLAogICAgICAgIHByaXZhdGU6IGlzUHJpdmF0ZQogICAgICB9OwogICAgICBpZiAodGhpcy5zb2NrZXQuYWNjZXNzVG9rZW5WYWx1ZSkgewogICAgICAgIGFjY2Vzc1Rva2VuUGF5bG9hZC5hY2Nlc3NfdG9rZW4gPSB0aGlzLnNvY2tldC5hY2Nlc3NUb2tlblZhbHVlOwogICAgICB9CiAgICAgIHRoaXMuX29uRXJyb3IoKGUpID0+IGNhbGxiYWNrID09PSBudWxsIHx8IGNhbGxiYWNrID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjYWxsYmFjayhSRUFMVElNRV9TVUJTQ1JJQkVfU1RBVEVTLkNIQU5ORUxfRVJST1IsIGUpKTsKICAgICAgdGhpcy5fb25DbG9zZSgoKSA9PiBjYWxsYmFjayA9PT0gbnVsbCB8fCBjYWxsYmFjayA9PT0gdm9pZCAwID8gdm9pZCAwIDogY2FsbGJhY2soUkVBTFRJTUVfU1VCU0NSSUJFX1NUQVRFUy5DTE9TRUQpKTsKICAgICAgdGhpcy51cGRhdGVKb2luUGF5bG9hZChPYmplY3QuYXNzaWduKHsgY29uZmlnIH0sIGFjY2Vzc1Rva2VuUGF5bG9hZCkpOwogICAgICB0aGlzLmpvaW5lZE9uY2UgPSB0cnVlOwogICAgICB0aGlzLl9yZWpvaW4odGltZW91dCk7CiAgICAgIHRoaXMuam9pblB1c2gucmVjZWl2ZSgib2siLCBhc3luYyAoeyBwb3N0Z3Jlc19jaGFuZ2VzOiBwb3N0Z3Jlc19jaGFuZ2VzMiB9KSA9PiB7CiAgICAgICAgdmFyIF9hMjsKICAgICAgICBpZiAoIXRoaXMuc29ja2V0Ll9pc01hbnVhbFRva2VuKCkpIHsKICAgICAgICAgIHRoaXMuc29ja2V0LnNldEF1dGgoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHBvc3RncmVzX2NoYW5nZXMyID09PSB2b2lkIDApIHsKICAgICAgICAgIGNhbGxiYWNrID09PSBudWxsIHx8IGNhbGxiYWNrID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjYWxsYmFjayhSRUFMVElNRV9TVUJTQ1JJQkVfU1RBVEVTLlNVQlNDUklCRUQpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCBjbGllbnRQb3N0Z3Jlc0JpbmRpbmdzID0gdGhpcy5iaW5kaW5ncy5wb3N0Z3Jlc19jaGFuZ2VzOwogICAgICAgICAgY29uc3QgYmluZGluZ3NMZW4gPSAoX2EyID0gY2xpZW50UG9zdGdyZXNCaW5kaW5ncyA9PT0gbnVsbCB8fCBjbGllbnRQb3N0Z3Jlc0JpbmRpbmdzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjbGllbnRQb3N0Z3Jlc0JpbmRpbmdzLmxlbmd0aCkgIT09IG51bGwgJiYgX2EyICE9PSB2b2lkIDAgPyBfYTIgOiAwOwogICAgICAgICAgY29uc3QgbmV3UG9zdGdyZXNCaW5kaW5ncyA9IFtdOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBiaW5kaW5nc0xlbjsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGNsaWVudFBvc3RncmVzQmluZGluZyA9IGNsaWVudFBvc3RncmVzQmluZGluZ3NbaV07CiAgICAgICAgICAgIGNvbnN0IHsgZmlsdGVyOiB7IGV2ZW50LCBzY2hlbWEsIHRhYmxlLCBmaWx0ZXIgfSB9ID0gY2xpZW50UG9zdGdyZXNCaW5kaW5nOwogICAgICAgICAgICBjb25zdCBzZXJ2ZXJQb3N0Z3Jlc0ZpbHRlciA9IHBvc3RncmVzX2NoYW5nZXMyICYmIHBvc3RncmVzX2NoYW5nZXMyW2ldOwogICAgICAgICAgICBpZiAoc2VydmVyUG9zdGdyZXNGaWx0ZXIgJiYgc2VydmVyUG9zdGdyZXNGaWx0ZXIuZXZlbnQgPT09IGV2ZW50ICYmIF9SZWFsdGltZUNoYW5uZWwuaXNGaWx0ZXJWYWx1ZUVxdWFsKHNlcnZlclBvc3RncmVzRmlsdGVyLnNjaGVtYSwgc2NoZW1hKSAmJiBfUmVhbHRpbWVDaGFubmVsLmlzRmlsdGVyVmFsdWVFcXVhbChzZXJ2ZXJQb3N0Z3Jlc0ZpbHRlci50YWJsZSwgdGFibGUpICYmIF9SZWFsdGltZUNoYW5uZWwuaXNGaWx0ZXJWYWx1ZUVxdWFsKHNlcnZlclBvc3RncmVzRmlsdGVyLmZpbHRlciwgZmlsdGVyKSkgewogICAgICAgICAgICAgIG5ld1Bvc3RncmVzQmluZGluZ3MucHVzaChPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIGNsaWVudFBvc3RncmVzQmluZGluZyksIHsgaWQ6IHNlcnZlclBvc3RncmVzRmlsdGVyLmlkIH0pKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLnVuc3Vic2NyaWJlKCk7CiAgICAgICAgICAgICAgdGhpcy5zdGF0ZSA9IENIQU5ORUxfU1RBVEVTLmVycm9yZWQ7CiAgICAgICAgICAgICAgY2FsbGJhY2sgPT09IG51bGwgfHwgY2FsbGJhY2sgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNhbGxiYWNrKFJFQUxUSU1FX1NVQlNDUklCRV9TVEFURVMuQ0hBTk5FTF9FUlJPUiwgbmV3IEVycm9yKCJtaXNtYXRjaCBiZXR3ZWVuIHNlcnZlciBhbmQgY2xpZW50IGJpbmRpbmdzIGZvciBwb3N0Z3JlcyBjaGFuZ2VzIikpOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGhpcy5iaW5kaW5ncy5wb3N0Z3Jlc19jaGFuZ2VzID0gbmV3UG9zdGdyZXNCaW5kaW5nczsKICAgICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKFJFQUxUSU1FX1NVQlNDUklCRV9TVEFURVMuU1VCU0NSSUJFRCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9KS5yZWNlaXZlKCJlcnJvciIsIChlcnJvcikgPT4gewogICAgICAgIHRoaXMuc3RhdGUgPSBDSEFOTkVMX1NUQVRFUy5lcnJvcmVkOwogICAgICAgIGNhbGxiYWNrID09PSBudWxsIHx8IGNhbGxiYWNrID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjYWxsYmFjayhSRUFMVElNRV9TVUJTQ1JJQkVfU1RBVEVTLkNIQU5ORUxfRVJST1IsIG5ldyBFcnJvcihKU09OLnN0cmluZ2lmeShPYmplY3QudmFsdWVzKGVycm9yKS5qb2luKCIsICIpIHx8ICJlcnJvciIpKSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9KS5yZWNlaXZlKCJ0aW1lb3V0IiwgKCkgPT4gewogICAgICAgIGNhbGxiYWNrID09PSBudWxsIHx8IGNhbGxiYWNrID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjYWxsYmFjayhSRUFMVElNRV9TVUJTQ1JJQkVfU1RBVEVTLlRJTUVEX09VVCk7CiAgICAgICAgcmV0dXJuOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IHByZXNlbmNlIHN0YXRlIGZvciB0aGlzIGNoYW5uZWwuCiAgICoKICAgKiBUaGUgc2hhcGUgaXMgYSBtYXAga2V5ZWQgYnkgcHJlc2VuY2Uga2V5IChmb3IgZXhhbXBsZSBhIHVzZXIgaWQpIHdoZXJlIGVhY2ggZW50cnkgY29udGFpbnMgdGhlCiAgICogdHJhY2tlZCBtZXRhZGF0YSBmb3IgdGhhdCB1c2VyLgogICAqLwogIHByZXNlbmNlU3RhdGUoKSB7CiAgICByZXR1cm4gdGhpcy5wcmVzZW5jZS5zdGF0ZTsKICB9CiAgLyoqCiAgICogU2VuZHMgdGhlIHN1cHBsaWVkIHBheWxvYWQgdG8gdGhlIHByZXNlbmNlIHRyYWNrZXIgc28gb3RoZXIgc3Vic2NyaWJlcnMgY2FuIHNlZSB0aGF0IHRoaXMKICAgKiBjbGllbnQgaXMgb25saW5lLiBVc2UgYHVudHJhY2tgIHRvIHN0b3AgYnJvYWRjYXN0aW5nIHByZXNlbmNlIGZvciB0aGUgc2FtZSBrZXkuCiAgICovCiAgYXN5bmMgdHJhY2socGF5bG9hZCwgb3B0cyA9IHt9KSB7CiAgICByZXR1cm4gYXdhaXQgdGhpcy5zZW5kKHsKICAgICAgdHlwZTogInByZXNlbmNlIiwKICAgICAgZXZlbnQ6ICJ0cmFjayIsCiAgICAgIHBheWxvYWQKICAgIH0sIG9wdHMudGltZW91dCB8fCB0aGlzLnRpbWVvdXQpOwogIH0KICAvKioKICAgKiBSZW1vdmVzIHRoZSBjdXJyZW50IHByZXNlbmNlIHN0YXRlIGZvciB0aGlzIGNsaWVudC4KICAgKi8KICBhc3luYyB1bnRyYWNrKG9wdHMgPSB7fSkgewogICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VuZCh7CiAgICAgIHR5cGU6ICJwcmVzZW5jZSIsCiAgICAgIGV2ZW50OiAidW50cmFjayIKICAgIH0sIG9wdHMpOwogIH0KICBvbih0eXBlLCBmaWx0ZXIsIGNhbGxiYWNrKSB7CiAgICBpZiAodGhpcy5zdGF0ZSA9PT0gQ0hBTk5FTF9TVEFURVMuam9pbmVkICYmIHR5cGUgPT09IFJFQUxUSU1FX0xJU1RFTl9UWVBFUy5QUkVTRU5DRSkgewogICAgICB0aGlzLnNvY2tldC5sb2coImNoYW5uZWwiLCBgcmVzdWJzY3JpYmUgdG8gJHt0aGlzLnRvcGljfSBkdWUgdG8gY2hhbmdlIGluIHByZXNlbmNlIGNhbGxiYWNrcyBvbiBqb2luZWQgY2hhbm5lbGApOwogICAgICB0aGlzLnVuc3Vic2NyaWJlKCkudGhlbihhc3luYyAoKSA9PiBhd2FpdCB0aGlzLnN1YnNjcmliZSgpKTsKICAgIH0KICAgIHJldHVybiB0aGlzLl9vbih0eXBlLCBmaWx0ZXIsIGNhbGxiYWNrKTsKICB9CiAgLyoqCiAgICogU2VuZHMgYSBicm9hZGNhc3QgbWVzc2FnZSBleHBsaWNpdGx5IHZpYSBSRVNUIEFQSS4KICAgKgogICAqIFRoaXMgbWV0aG9kIGFsd2F5cyB1c2VzIHRoZSBSRVNUIEFQSSBlbmRwb2ludCByZWdhcmRsZXNzIG9mIFdlYlNvY2tldCBjb25uZWN0aW9uIHN0YXRlLgogICAqIFVzZWZ1bCB3aGVuIHlvdSB3YW50IHRvIGd1YXJhbnRlZSBSRVNUIGRlbGl2ZXJ5IG9yIHdoZW4gZ3JhZHVhbGx5IG1pZ3JhdGluZyBmcm9tIGltcGxpY2l0IFJFU1QgZmFsbGJhY2suCiAgICoKICAgKiBAcGFyYW0gZXZlbnQgVGhlIG5hbWUgb2YgdGhlIGJyb2FkY2FzdCBldmVudAogICAqIEBwYXJhbSBwYXlsb2FkIFBheWxvYWQgdG8gYmUgc2VudCAocmVxdWlyZWQpCiAgICogQHBhcmFtIG9wdHMgT3B0aW9ucyBpbmNsdWRpbmcgdGltZW91dAogICAqIEByZXR1cm5zIFByb21pc2UgcmVzb2x2aW5nIHRvIG9iamVjdCB3aXRoIHN1Y2Nlc3Mgc3RhdHVzLCBhbmQgZXJyb3IgZGV0YWlscyBpZiBmYWlsZWQKICAgKi8KICBhc3luYyBodHRwU2VuZChldmVudCwgcGF5bG9hZCwgb3B0cyA9IHt9KSB7CiAgICB2YXIgX2E7CiAgICBpZiAocGF5bG9hZCA9PT0gdm9pZCAwIHx8IHBheWxvYWQgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCJQYXlsb2FkIGlzIHJlcXVpcmVkIGZvciBodHRwU2VuZCgpIik7CiAgICB9CiAgICBjb25zdCBoZWFkZXJzID0gewogICAgICBhcGlrZXk6IHRoaXMuc29ja2V0LmFwaUtleSA/IHRoaXMuc29ja2V0LmFwaUtleSA6ICIiLAogICAgICAiQ29udGVudC1UeXBlIjogImFwcGxpY2F0aW9uL2pzb24iCiAgICB9OwogICAgaWYgKHRoaXMuc29ja2V0LmFjY2Vzc1Rva2VuVmFsdWUpIHsKICAgICAgaGVhZGVyc1siQXV0aG9yaXphdGlvbiJdID0gYEJlYXJlciAke3RoaXMuc29ja2V0LmFjY2Vzc1Rva2VuVmFsdWV9YDsKICAgIH0KICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICBoZWFkZXJzLAogICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgbWVzc2FnZXM6IFsKICAgICAgICAgIHsKICAgICAgICAgICAgdG9waWM6IHRoaXMuc3ViVG9waWMsCiAgICAgICAgICAgIGV2ZW50LAogICAgICAgICAgICBwYXlsb2FkLAogICAgICAgICAgICBwcml2YXRlOiB0aGlzLnByaXZhdGUKICAgICAgICAgIH0KICAgICAgICBdCiAgICAgIH0pCiAgICB9OwogICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLl9mZXRjaFdpdGhUaW1lb3V0KHRoaXMuYnJvYWRjYXN0RW5kcG9pbnRVUkwsIG9wdGlvbnMsIChfYSA9IG9wdHMudGltZW91dCkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogdGhpcy50aW1lb3V0KTsKICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMikgewogICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07CiAgICB9CiAgICBsZXQgZXJyb3JNZXNzYWdlID0gcmVzcG9uc2Uuc3RhdHVzVGV4dDsKICAgIHRyeSB7CiAgICAgIGNvbnN0IGVycm9yQm9keSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTsKICAgICAgZXJyb3JNZXNzYWdlID0gZXJyb3JCb2R5LmVycm9yIHx8IGVycm9yQm9keS5tZXNzYWdlIHx8IGVycm9yTWVzc2FnZTsKICAgIH0gY2F0Y2ggKF9iKSB7CiAgICB9CiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKGVycm9yTWVzc2FnZSkpOwogIH0KICAvKioKICAgKiBTZW5kcyBhIG1lc3NhZ2UgaW50byB0aGUgY2hhbm5lbC4KICAgKgogICAqIEBwYXJhbSBhcmdzIEFyZ3VtZW50cyB0byBzZW5kIHRvIGNoYW5uZWwKICAgKiBAcGFyYW0gYXJncy50eXBlIFRoZSB0eXBlIG9mIGV2ZW50IHRvIHNlbmQKICAgKiBAcGFyYW0gYXJncy5ldmVudCBUaGUgbmFtZSBvZiB0aGUgZXZlbnQgYmVpbmcgc2VudAogICAqIEBwYXJhbSBhcmdzLnBheWxvYWQgUGF5bG9hZCB0byBiZSBzZW50CiAgICogQHBhcmFtIG9wdHMgT3B0aW9ucyB0byBiZSB1c2VkIGR1cmluZyB0aGUgc2VuZCBwcm9jZXNzCiAgICovCiAgYXN5bmMgc2VuZChhcmdzLCBvcHRzID0ge30pIHsKICAgIHZhciBfYSwgX2I7CiAgICBpZiAoIXRoaXMuX2NhblB1c2goKSAmJiBhcmdzLnR5cGUgPT09ICJicm9hZGNhc3QiKSB7CiAgICAgIGNvbnNvbGUud2FybigiUmVhbHRpbWUgc2VuZCgpIGlzIGF1dG9tYXRpY2FsbHkgZmFsbGluZyBiYWNrIHRvIFJFU1QgQVBJLiBUaGlzIGJlaGF2aW9yIHdpbGwgYmUgZGVwcmVjYXRlZCBpbiB0aGUgZnV0dXJlLiBQbGVhc2UgdXNlIGh0dHBTZW5kKCkgZXhwbGljaXRseSBmb3IgUkVTVCBkZWxpdmVyeS4iKTsKICAgICAgY29uc3QgeyBldmVudCwgcGF5bG9hZDogZW5kcG9pbnRfcGF5bG9hZCB9ID0gYXJnczsKICAgICAgY29uc3QgaGVhZGVycyA9IHsKICAgICAgICBhcGlrZXk6IHRoaXMuc29ja2V0LmFwaUtleSA/IHRoaXMuc29ja2V0LmFwaUtleSA6ICIiLAogICAgICAgICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIKICAgICAgfTsKICAgICAgaWYgKHRoaXMuc29ja2V0LmFjY2Vzc1Rva2VuVmFsdWUpIHsKICAgICAgICBoZWFkZXJzWyJBdXRob3JpemF0aW9uIl0gPSBgQmVhcmVyICR7dGhpcy5zb2NrZXQuYWNjZXNzVG9rZW5WYWx1ZX1gOwogICAgICB9CiAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgbWV0aG9kOiAiUE9TVCIsCiAgICAgICAgaGVhZGVycywKICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICBtZXNzYWdlczogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgdG9waWM6IHRoaXMuc3ViVG9waWMsCiAgICAgICAgICAgICAgZXZlbnQsCiAgICAgICAgICAgICAgcGF5bG9hZDogZW5kcG9pbnRfcGF5bG9hZCwKICAgICAgICAgICAgICBwcml2YXRlOiB0aGlzLnByaXZhdGUKICAgICAgICAgICAgfQogICAgICAgICAgXQogICAgICAgIH0pCiAgICAgIH07CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLl9mZXRjaFdpdGhUaW1lb3V0KHRoaXMuYnJvYWRjYXN0RW5kcG9pbnRVUkwsIG9wdGlvbnMsIChfYSA9IG9wdHMudGltZW91dCkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogdGhpcy50aW1lb3V0KTsKICAgICAgICBhd2FpdCAoKF9iID0gcmVzcG9uc2UuYm9keSkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmNhbmNlbCgpKTsKICAgICAgICByZXR1cm4gcmVzcG9uc2Uub2sgPyAib2siIDogImVycm9yIjsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBpZiAoZXJyb3IubmFtZSA9PT0gIkFib3J0RXJyb3IiKSB7CiAgICAgICAgICByZXR1cm4gInRpbWVkIG91dCI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiAiZXJyb3IiOwogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgICAgdmFyIF9hMiwgX2IyLCBfYzsKICAgICAgICBjb25zdCBwdXNoID0gdGhpcy5fcHVzaChhcmdzLnR5cGUsIGFyZ3MsIG9wdHMudGltZW91dCB8fCB0aGlzLnRpbWVvdXQpOwogICAgICAgIGlmIChhcmdzLnR5cGUgPT09ICJicm9hZGNhc3QiICYmICEoKF9jID0gKF9iMiA9IChfYTIgPSB0aGlzLnBhcmFtcykgPT09IG51bGwgfHwgX2EyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYTIuY29uZmlnKSA9PT0gbnVsbCB8fCBfYjIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iMi5icm9hZGNhc3QpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5hY2spKSB7CiAgICAgICAgICByZXNvbHZlKCJvayIpOwogICAgICAgIH0KICAgICAgICBwdXNoLnJlY2VpdmUoIm9rIiwgKCkgPT4gcmVzb2x2ZSgib2siKSk7CiAgICAgICAgcHVzaC5yZWNlaXZlKCJlcnJvciIsICgpID0+IHJlc29sdmUoImVycm9yIikpOwogICAgICAgIHB1c2gucmVjZWl2ZSgidGltZW91dCIsICgpID0+IHJlc29sdmUoInRpbWVkIG91dCIpKTsKICAgICAgfSk7CiAgICB9CiAgfQogIC8qKgogICAqIFVwZGF0ZXMgdGhlIHBheWxvYWQgdGhhdCB3aWxsIGJlIHNlbnQgdGhlIG5leHQgdGltZSB0aGUgY2hhbm5lbCBqb2lucyAocmVjb25uZWN0cykuCiAgICogVXNlZnVsIGZvciByb3RhdGluZyBhY2Nlc3MgdG9rZW5zIG9yIHVwZGF0aW5nIGNvbmZpZyB3aXRob3V0IHJlLWNyZWF0aW5nIHRoZSBjaGFubmVsLgogICAqLwogIHVwZGF0ZUpvaW5QYXlsb2FkKHBheWxvYWQpIHsKICAgIHRoaXMuam9pblB1c2gudXBkYXRlUGF5bG9hZChwYXlsb2FkKTsKICB9CiAgLyoqCiAgICogTGVhdmVzIHRoZSBjaGFubmVsLgogICAqCiAgICogVW5zdWJzY3JpYmVzIGZyb20gc2VydmVyIGV2ZW50cywgYW5kIGluc3RydWN0cyBjaGFubmVsIHRvIHRlcm1pbmF0ZSBvbiBzZXJ2ZXIuCiAgICogVHJpZ2dlcnMgb25DbG9zZSgpIGhvb2tzLgogICAqCiAgICogVG8gcmVjZWl2ZSBsZWF2ZSBhY2tub3dsZWRnZW1lbnRzLCB1c2UgdGhlIGEgYHJlY2VpdmVgIGhvb2sgdG8gYmluZCB0byB0aGUgc2VydmVyIGFjaywgaWU6CiAgICogY2hhbm5lbC51bnN1YnNjcmliZSgpLnJlY2VpdmUoIm9rIiwgKCkgPT4gYWxlcnQoImxlZnQhIikgKQogICAqLwogIHVuc3Vic2NyaWJlKHRpbWVvdXQgPSB0aGlzLnRpbWVvdXQpIHsKICAgIHRoaXMuc3RhdGUgPSBDSEFOTkVMX1NUQVRFUy5sZWF2aW5nOwogICAgY29uc3Qgb25DbG9zZSA9ICgpID0+IHsKICAgICAgdGhpcy5zb2NrZXQubG9nKCJjaGFubmVsIiwgYGxlYXZlICR7dGhpcy50b3BpY31gKTsKICAgICAgdGhpcy5fdHJpZ2dlcihDSEFOTkVMX0VWRU5UUy5jbG9zZSwgImxlYXZlIiwgdGhpcy5fam9pblJlZigpKTsKICAgIH07CiAgICB0aGlzLmpvaW5QdXNoLmRlc3Ryb3koKTsKICAgIGxldCBsZWF2ZVB1c2ggPSBudWxsOwogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7CiAgICAgIGxlYXZlUHVzaCA9IG5ldyBQdXNoKHRoaXMsIENIQU5ORUxfRVZFTlRTLmxlYXZlLCB7fSwgdGltZW91dCk7CiAgICAgIGxlYXZlUHVzaC5yZWNlaXZlKCJvayIsICgpID0+IHsKICAgICAgICBvbkNsb3NlKCk7CiAgICAgICAgcmVzb2x2ZSgib2siKTsKICAgICAgfSkucmVjZWl2ZSgidGltZW91dCIsICgpID0+IHsKICAgICAgICBvbkNsb3NlKCk7CiAgICAgICAgcmVzb2x2ZSgidGltZWQgb3V0Iik7CiAgICAgIH0pLnJlY2VpdmUoImVycm9yIiwgKCkgPT4gewogICAgICAgIHJlc29sdmUoImVycm9yIik7CiAgICAgIH0pOwogICAgICBsZWF2ZVB1c2guc2VuZCgpOwogICAgICBpZiAoIXRoaXMuX2NhblB1c2goKSkgewogICAgICAgIGxlYXZlUHVzaC50cmlnZ2VyKCJvayIsIHt9KTsKICAgICAgfQogICAgfSkuZmluYWxseSgoKSA9PiB7CiAgICAgIGxlYXZlUHVzaCA9PT0gbnVsbCB8fCBsZWF2ZVB1c2ggPT09IHZvaWQgMCA/IHZvaWQgMCA6IGxlYXZlUHVzaC5kZXN0cm95KCk7CiAgICB9KTsKICB9CiAgLyoqCiAgICogVGVhcmRvd24gdGhlIGNoYW5uZWwuCiAgICoKICAgKiBEZXN0cm95cyBhbmQgc3RvcHMgcmVsYXRlZCB0aW1lcnMuCiAgICovCiAgdGVhcmRvd24oKSB7CiAgICB0aGlzLnB1c2hCdWZmZXIuZm9yRWFjaCgocHVzaCkgPT4gcHVzaC5kZXN0cm95KCkpOwogICAgdGhpcy5wdXNoQnVmZmVyID0gW107CiAgICB0aGlzLnJlam9pblRpbWVyLnJlc2V0KCk7CiAgICB0aGlzLmpvaW5QdXNoLmRlc3Ryb3koKTsKICAgIHRoaXMuc3RhdGUgPSBDSEFOTkVMX1NUQVRFUy5jbG9zZWQ7CiAgICB0aGlzLmJpbmRpbmdzID0ge307CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBhc3luYyBfZmV0Y2hXaXRoVGltZW91dCh1cmwsIG9wdGlvbnMsIHRpbWVvdXQpIHsKICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7CiAgICBjb25zdCBpZCA9IHNldFRpbWVvdXQoKCkgPT4gY29udHJvbGxlci5hYm9ydCgpLCB0aW1lb3V0KTsKICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5zb2NrZXQuZmV0Y2godXJsLCBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMpLCB7IHNpZ25hbDogY29udHJvbGxlci5zaWduYWwgfSkpOwogICAgY2xlYXJUaW1lb3V0KGlkKTsKICAgIHJldHVybiByZXNwb25zZTsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIF9wdXNoKGV2ZW50LCBwYXlsb2FkLCB0aW1lb3V0ID0gdGhpcy50aW1lb3V0KSB7CiAgICBpZiAoIXRoaXMuam9pbmVkT25jZSkgewogICAgICB0aHJvdyBgdHJpZWQgdG8gcHVzaCAnJHtldmVudH0nIHRvICcke3RoaXMudG9waWN9JyBiZWZvcmUgam9pbmluZy4gVXNlIGNoYW5uZWwuc3Vic2NyaWJlKCkgYmVmb3JlIHB1c2hpbmcgZXZlbnRzYDsKICAgIH0KICAgIGxldCBwdXNoRXZlbnQgPSBuZXcgUHVzaCh0aGlzLCBldmVudCwgcGF5bG9hZCwgdGltZW91dCk7CiAgICBpZiAodGhpcy5fY2FuUHVzaCgpKSB7CiAgICAgIHB1c2hFdmVudC5zZW5kKCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl9hZGRUb1B1c2hCdWZmZXIocHVzaEV2ZW50KTsKICAgIH0KICAgIHJldHVybiBwdXNoRXZlbnQ7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfYWRkVG9QdXNoQnVmZmVyKHB1c2hFdmVudCkgewogICAgcHVzaEV2ZW50LnN0YXJ0VGltZW91dCgpOwogICAgdGhpcy5wdXNoQnVmZmVyLnB1c2gocHVzaEV2ZW50KTsKICAgIGlmICh0aGlzLnB1c2hCdWZmZXIubGVuZ3RoID4gTUFYX1BVU0hfQlVGRkVSX1NJWkUpIHsKICAgICAgY29uc3QgcmVtb3ZlZFB1c2ggPSB0aGlzLnB1c2hCdWZmZXIuc2hpZnQoKTsKICAgICAgaWYgKHJlbW92ZWRQdXNoKSB7CiAgICAgICAgcmVtb3ZlZFB1c2guZGVzdHJveSgpOwogICAgICAgIHRoaXMuc29ja2V0LmxvZygiY2hhbm5lbCIsIGBkaXNjYXJkZWQgcHVzaCBkdWUgdG8gYnVmZmVyIG92ZXJmbG93OiAke3JlbW92ZWRQdXNoLmV2ZW50fWAsIHJlbW92ZWRQdXNoLnBheWxvYWQpOwogICAgICB9CiAgICB9CiAgfQogIC8qKgogICAqIE92ZXJyaWRhYmxlIG1lc3NhZ2UgaG9vawogICAqCiAgICogUmVjZWl2ZXMgYWxsIGV2ZW50cyBmb3Igc3BlY2lhbGl6ZWQgbWVzc2FnZSBoYW5kbGluZyBiZWZvcmUgZGlzcGF0Y2hpbmcgdG8gdGhlIGNoYW5uZWwgY2FsbGJhY2tzLgogICAqIE11c3QgcmV0dXJuIHRoZSBwYXlsb2FkLCBtb2RpZmllZCBvciB1bm1vZGlmaWVkLgogICAqCiAgICogQGludGVybmFsCiAgICovCiAgX29uTWVzc2FnZShfZXZlbnQsIHBheWxvYWQsIF9yZWYyKSB7CiAgICByZXR1cm4gcGF5bG9hZDsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIF9pc01lbWJlcih0b3BpYykgewogICAgcmV0dXJuIHRoaXMudG9waWMgPT09IHRvcGljOwogIH0KICAvKiogQGludGVybmFsICovCiAgX2pvaW5SZWYoKSB7CiAgICByZXR1cm4gdGhpcy5qb2luUHVzaC5yZWY7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfdHJpZ2dlcih0eXBlLCBwYXlsb2FkLCByZWYpIHsKICAgIHZhciBfYSwgX2I7CiAgICBjb25zdCB0eXBlTG93ZXIgPSB0eXBlLnRvTG9jYWxlTG93ZXJDYXNlKCk7CiAgICBjb25zdCB7IGNsb3NlLCBlcnJvciwgbGVhdmUsIGpvaW4gfSA9IENIQU5ORUxfRVZFTlRTOwogICAgY29uc3QgZXZlbnRzID0gW2Nsb3NlLCBlcnJvciwgbGVhdmUsIGpvaW5dOwogICAgaWYgKHJlZiAmJiBldmVudHMuaW5kZXhPZih0eXBlTG93ZXIpID49IDAgJiYgcmVmICE9PSB0aGlzLl9qb2luUmVmKCkpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgbGV0IGhhbmRsZWRQYXlsb2FkID0gdGhpcy5fb25NZXNzYWdlKHR5cGVMb3dlciwgcGF5bG9hZCwgcmVmKTsKICAgIGlmIChwYXlsb2FkICYmICFoYW5kbGVkUGF5bG9hZCkgewogICAgICB0aHJvdyAiY2hhbm5lbCBvbk1lc3NhZ2UgY2FsbGJhY2tzIG11c3QgcmV0dXJuIHRoZSBwYXlsb2FkLCBtb2RpZmllZCBvciB1bm1vZGlmaWVkIjsKICAgIH0KICAgIGlmIChbImluc2VydCIsICJ1cGRhdGUiLCAiZGVsZXRlIl0uaW5jbHVkZXModHlwZUxvd2VyKSkgewogICAgICAoX2EgPSB0aGlzLmJpbmRpbmdzLnBvc3RncmVzX2NoYW5nZXMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5maWx0ZXIoKGJpbmQpID0+IHsKICAgICAgICB2YXIgX2EyLCBfYjIsIF9jOwogICAgICAgIHJldHVybiAoKF9hMiA9IGJpbmQuZmlsdGVyKSA9PT0gbnVsbCB8fCBfYTIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hMi5ldmVudCkgPT09ICIqIiB8fCAoKF9jID0gKF9iMiA9IGJpbmQuZmlsdGVyKSA9PT0gbnVsbCB8fCBfYjIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iMi5ldmVudCkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLnRvTG9jYWxlTG93ZXJDYXNlKCkpID09PSB0eXBlTG93ZXI7CiAgICAgIH0pLm1hcCgoYmluZCkgPT4gYmluZC5jYWxsYmFjayhoYW5kbGVkUGF5bG9hZCwgcmVmKSk7CiAgICB9IGVsc2UgewogICAgICAoX2IgPSB0aGlzLmJpbmRpbmdzW3R5cGVMb3dlcl0pID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5maWx0ZXIoKGJpbmQpID0+IHsKICAgICAgICB2YXIgX2EyLCBfYjIsIF9jLCBfZCwgX2UsIF9mOwogICAgICAgIGlmIChbImJyb2FkY2FzdCIsICJwcmVzZW5jZSIsICJwb3N0Z3Jlc19jaGFuZ2VzIl0uaW5jbHVkZXModHlwZUxvd2VyKSkgewogICAgICAgICAgaWYgKCJpZCIgaW4gYmluZCkgewogICAgICAgICAgICBjb25zdCBiaW5kSWQgPSBiaW5kLmlkOwogICAgICAgICAgICBjb25zdCBiaW5kRXZlbnQgPSAoX2EyID0gYmluZC5maWx0ZXIpID09PSBudWxsIHx8IF9hMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EyLmV2ZW50OwogICAgICAgICAgICByZXR1cm4gYmluZElkICYmICgoX2IyID0gcGF5bG9hZC5pZHMpID09PSBudWxsIHx8IF9iMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IyLmluY2x1ZGVzKGJpbmRJZCkpICYmIChiaW5kRXZlbnQgPT09ICIqIiB8fCAoYmluZEV2ZW50ID09PSBudWxsIHx8IGJpbmRFdmVudCA9PT0gdm9pZCAwID8gdm9pZCAwIDogYmluZEV2ZW50LnRvTG9jYWxlTG93ZXJDYXNlKCkpID09PSAoKF9jID0gcGF5bG9hZC5kYXRhKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MudHlwZS50b0xvY2FsZUxvd2VyQ2FzZSgpKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBiaW5kRXZlbnQgPSAoX2UgPSAoX2QgPSBiaW5kID09PSBudWxsIHx8IGJpbmQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGJpbmQuZmlsdGVyKSA9PT0gbnVsbCB8fCBfZCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2QuZXZlbnQpID09PSBudWxsIHx8IF9lID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZS50b0xvY2FsZUxvd2VyQ2FzZSgpOwogICAgICAgICAgICByZXR1cm4gYmluZEV2ZW50ID09PSAiKiIgfHwgYmluZEV2ZW50ID09PSAoKF9mID0gcGF5bG9hZCA9PT0gbnVsbCB8fCBwYXlsb2FkID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwYXlsb2FkLmV2ZW50KSA9PT0gbnVsbCB8fCBfZiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2YudG9Mb2NhbGVMb3dlckNhc2UoKSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiBiaW5kLnR5cGUudG9Mb2NhbGVMb3dlckNhc2UoKSA9PT0gdHlwZUxvd2VyOwogICAgICAgIH0KICAgICAgfSkubWFwKChiaW5kKSA9PiB7CiAgICAgICAgaWYgKHR5cGVvZiBoYW5kbGVkUGF5bG9hZCA9PT0gIm9iamVjdCIgJiYgImlkcyIgaW4gaGFuZGxlZFBheWxvYWQpIHsKICAgICAgICAgIGNvbnN0IHBvc3RncmVzQ2hhbmdlcyA9IGhhbmRsZWRQYXlsb2FkLmRhdGE7CiAgICAgICAgICBjb25zdCB7IHNjaGVtYSwgdGFibGUsIGNvbW1pdF90aW1lc3RhbXAsIHR5cGU6IHR5cGUyLCBlcnJvcnM6IGVycm9yczMgfSA9IHBvc3RncmVzQ2hhbmdlczsKICAgICAgICAgIGNvbnN0IGVucmljaGVkUGF5bG9hZCA9IHsKICAgICAgICAgICAgc2NoZW1hLAogICAgICAgICAgICB0YWJsZSwKICAgICAgICAgICAgY29tbWl0X3RpbWVzdGFtcCwKICAgICAgICAgICAgZXZlbnRUeXBlOiB0eXBlMiwKICAgICAgICAgICAgbmV3OiB7fSwKICAgICAgICAgICAgb2xkOiB7fSwKICAgICAgICAgICAgZXJyb3JzOiBlcnJvcnMzCiAgICAgICAgICB9OwogICAgICAgICAgaGFuZGxlZFBheWxvYWQgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIGVucmljaGVkUGF5bG9hZCksIHRoaXMuX2dldFBheWxvYWRSZWNvcmRzKHBvc3RncmVzQ2hhbmdlcykpOwogICAgICAgIH0KICAgICAgICBiaW5kLmNhbGxiYWNrKGhhbmRsZWRQYXlsb2FkLCByZWYpOwogICAgICB9KTsKICAgIH0KICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIF9pc0Nsb3NlZCgpIHsKICAgIHJldHVybiB0aGlzLnN0YXRlID09PSBDSEFOTkVMX1NUQVRFUy5jbG9zZWQ7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfaXNKb2luZWQoKSB7CiAgICByZXR1cm4gdGhpcy5zdGF0ZSA9PT0gQ0hBTk5FTF9TVEFURVMuam9pbmVkOwogIH0KICAvKiogQGludGVybmFsICovCiAgX2lzSm9pbmluZygpIHsKICAgIHJldHVybiB0aGlzLnN0YXRlID09PSBDSEFOTkVMX1NUQVRFUy5qb2luaW5nOwogIH0KICAvKiogQGludGVybmFsICovCiAgX2lzTGVhdmluZygpIHsKICAgIHJldHVybiB0aGlzLnN0YXRlID09PSBDSEFOTkVMX1NUQVRFUy5sZWF2aW5nOwogIH0KICAvKiogQGludGVybmFsICovCiAgX3JlcGx5RXZlbnROYW1lKHJlZikgewogICAgcmV0dXJuIGBjaGFuX3JlcGx5XyR7cmVmfWA7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfb24odHlwZSwgZmlsdGVyLCBjYWxsYmFjaykgewogICAgY29uc3QgdHlwZUxvd2VyID0gdHlwZS50b0xvY2FsZUxvd2VyQ2FzZSgpOwogICAgY29uc3QgYmluZGluZyA9IHsKICAgICAgdHlwZTogdHlwZUxvd2VyLAogICAgICBmaWx0ZXIsCiAgICAgIGNhbGxiYWNrCiAgICB9OwogICAgaWYgKHRoaXMuYmluZGluZ3NbdHlwZUxvd2VyXSkgewogICAgICB0aGlzLmJpbmRpbmdzW3R5cGVMb3dlcl0ucHVzaChiaW5kaW5nKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuYmluZGluZ3NbdHlwZUxvd2VyXSA9IFtiaW5kaW5nXTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICAvKiogQGludGVybmFsICovCiAgX29mZih0eXBlLCBmaWx0ZXIpIHsKICAgIGNvbnN0IHR5cGVMb3dlciA9IHR5cGUudG9Mb2NhbGVMb3dlckNhc2UoKTsKICAgIGlmICh0aGlzLmJpbmRpbmdzW3R5cGVMb3dlcl0pIHsKICAgICAgdGhpcy5iaW5kaW5nc1t0eXBlTG93ZXJdID0gdGhpcy5iaW5kaW5nc1t0eXBlTG93ZXJdLmZpbHRlcigoYmluZCkgPT4gewogICAgICAgIHZhciBfYTsKICAgICAgICByZXR1cm4gISgoKF9hID0gYmluZC50eXBlKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EudG9Mb2NhbGVMb3dlckNhc2UoKSkgPT09IHR5cGVMb3dlciAmJiBfUmVhbHRpbWVDaGFubmVsLmlzRXF1YWwoYmluZC5maWx0ZXIsIGZpbHRlcikpOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICAvKiogQGludGVybmFsICovCiAgc3RhdGljIGlzRXF1YWwob2JqMSwgb2JqMikgewogICAgaWYgKE9iamVjdC5rZXlzKG9iajEpLmxlbmd0aCAhPT0gT2JqZWN0LmtleXMob2JqMikubGVuZ3RoKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGZvciAoY29uc3QgayBpbiBvYmoxKSB7CiAgICAgIGlmIChvYmoxW2tdICE9PSBvYmoyW2tdKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgLyoqCiAgICogQ29tcGFyZXMgdHdvIG9wdGlvbmFsIGZpbHRlciB2YWx1ZXMgZm9yIGVxdWFsaXR5LgogICAqIFRyZWF0cyB1bmRlZmluZWQsIG51bGwsIGFuZCBlbXB0eSBzdHJpbmcgYXMgZXF1aXZhbGVudCBlbXB0eSB2YWx1ZXMuCiAgICogQGludGVybmFsCiAgICovCiAgc3RhdGljIGlzRmlsdGVyVmFsdWVFcXVhbChzZXJ2ZXJWYWx1ZSwgY2xpZW50VmFsdWUpIHsKICAgIGNvbnN0IG5vcm1hbGl6ZWRTZXJ2ZXIgPSBzZXJ2ZXJWYWx1ZSAhPT0gbnVsbCAmJiBzZXJ2ZXJWYWx1ZSAhPT0gdm9pZCAwID8gc2VydmVyVmFsdWUgOiB2b2lkIDA7CiAgICBjb25zdCBub3JtYWxpemVkQ2xpZW50ID0gY2xpZW50VmFsdWUgIT09IG51bGwgJiYgY2xpZW50VmFsdWUgIT09IHZvaWQgMCA/IGNsaWVudFZhbHVlIDogdm9pZCAwOwogICAgcmV0dXJuIG5vcm1hbGl6ZWRTZXJ2ZXIgPT09IG5vcm1hbGl6ZWRDbGllbnQ7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfcmVqb2luVW50aWxDb25uZWN0ZWQoKSB7CiAgICB0aGlzLnJlam9pblRpbWVyLnNjaGVkdWxlVGltZW91dCgpOwogICAgaWYgKHRoaXMuc29ja2V0LmlzQ29ubmVjdGVkKCkpIHsKICAgICAgdGhpcy5fcmVqb2luKCk7CiAgICB9CiAgfQogIC8qKgogICAqIFJlZ2lzdGVycyBhIGNhbGxiYWNrIHRoYXQgd2lsbCBiZSBleGVjdXRlZCB3aGVuIHRoZSBjaGFubmVsIGNsb3Nlcy4KICAgKgogICAqIEBpbnRlcm5hbAogICAqLwogIF9vbkNsb3NlKGNhbGxiYWNrKSB7CiAgICB0aGlzLl9vbihDSEFOTkVMX0VWRU5UUy5jbG9zZSwge30sIGNhbGxiYWNrKTsKICB9CiAgLyoqCiAgICogUmVnaXN0ZXJzIGEgY2FsbGJhY2sgdGhhdCB3aWxsIGJlIGV4ZWN1dGVkIHdoZW4gdGhlIGNoYW5uZWwgZW5jb3VudGVyZXMgYW4gZXJyb3IuCiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KICBfb25FcnJvcihjYWxsYmFjaykgewogICAgdGhpcy5fb24oQ0hBTk5FTF9FVkVOVFMuZXJyb3IsIHt9LCAocmVhc29uKSA9PiBjYWxsYmFjayhyZWFzb24pKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIHNvY2tldCBpcyBjb25uZWN0ZWQgYW5kIHRoZSBjaGFubmVsIGhhcyBiZWVuIGpvaW5lZC4KICAgKgogICAqIEBpbnRlcm5hbAogICAqLwogIF9jYW5QdXNoKCkgewogICAgcmV0dXJuIHRoaXMuc29ja2V0LmlzQ29ubmVjdGVkKCkgJiYgdGhpcy5faXNKb2luZWQoKTsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIF9yZWpvaW4odGltZW91dCA9IHRoaXMudGltZW91dCkgewogICAgaWYgKHRoaXMuX2lzTGVhdmluZygpKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuc29ja2V0Ll9sZWF2ZU9wZW5Ub3BpYyh0aGlzLnRvcGljKTsKICAgIHRoaXMuc3RhdGUgPSBDSEFOTkVMX1NUQVRFUy5qb2luaW5nOwogICAgdGhpcy5qb2luUHVzaC5yZXNlbmQodGltZW91dCk7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfZ2V0UGF5bG9hZFJlY29yZHMocGF5bG9hZCkgewogICAgY29uc3QgcmVjb3JkcyA9IHsKICAgICAgbmV3OiB7fSwKICAgICAgb2xkOiB7fQogICAgfTsKICAgIGlmIChwYXlsb2FkLnR5cGUgPT09ICJJTlNFUlQiIHx8IHBheWxvYWQudHlwZSA9PT0gIlVQREFURSIpIHsKICAgICAgcmVjb3Jkcy5uZXcgPSBjb252ZXJ0Q2hhbmdlRGF0YShwYXlsb2FkLmNvbHVtbnMsIHBheWxvYWQucmVjb3JkKTsKICAgIH0KICAgIGlmIChwYXlsb2FkLnR5cGUgPT09ICJVUERBVEUiIHx8IHBheWxvYWQudHlwZSA9PT0gIkRFTEVURSIpIHsKICAgICAgcmVjb3Jkcy5vbGQgPSBjb252ZXJ0Q2hhbmdlRGF0YShwYXlsb2FkLmNvbHVtbnMsIHBheWxvYWQub2xkX3JlY29yZCk7CiAgICB9CiAgICByZXR1cm4gcmVjb3JkczsKICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK3JlYWx0aW1lLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL3JlYWx0aW1lLWpzL2Rpc3QvbW9kdWxlL1JlYWx0aW1lQ2xpZW50LmpzCnZhciBub29wNSA9ICgpID0+IHsKfTsKdmFyIENPTk5FQ1RJT05fVElNRU9VVFMgPSB7CiAgSEVBUlRCRUFUX0lOVEVSVkFMOiAyNWUzLAogIFJFQ09OTkVDVF9ERUxBWTogMTAsCiAgSEVBUlRCRUFUX1RJTUVPVVRfRkFMTEJBQ0s6IDEwMAp9Owp2YXIgUkVDT05ORUNUX0lOVEVSVkFMUyA9IFsxZTMsIDJlMywgNWUzLCAxZTRdOwp2YXIgREVGQVVMVF9SRUNPTk5FQ1RfRkFMTEJBQ0sgPSAxZTQ7CnZhciBXT1JLRVJfU0NSSVBUID0gYAogIGFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCAoZSkgPT4gewogICAgaWYgKGUuZGF0YS5ldmVudCA9PT0gInN0YXJ0IikgewogICAgICBzZXRJbnRlcnZhbCgoKSA9PiBwb3N0TWVzc2FnZSh7IGV2ZW50OiAia2VlcEFsaXZlIiB9KSwgZS5kYXRhLmludGVydmFsKTsKICAgIH0KICB9KTtgOwp2YXIgUmVhbHRpbWVDbGllbnQgPSBjbGFzcyB7CiAgLyoqCiAgICogSW5pdGlhbGl6ZXMgdGhlIFNvY2tldC4KICAgKgogICAqIEBwYXJhbSBlbmRQb2ludCBUaGUgc3RyaW5nIFdlYlNvY2tldCBlbmRwb2ludCwgaWUsICJ3czovL2V4YW1wbGUuY29tL3NvY2tldCIsICJ3c3M6Ly9leGFtcGxlLmNvbSIsICIvc29ja2V0IiAoaW5oZXJpdGVkIGhvc3QgJiBwcm90b2NvbCkKICAgKiBAcGFyYW0gaHR0cEVuZHBvaW50IFRoZSBzdHJpbmcgSFRUUCBlbmRwb2ludCwgaWUsICJodHRwczovL2V4YW1wbGUuY29tIiwgIi8iIChpbmhlcml0ZWQgaG9zdCAmIHByb3RvY29sKQogICAqIEBwYXJhbSBvcHRpb25zLnRyYW5zcG9ydCBUaGUgV2Vic29ja2V0IFRyYW5zcG9ydCwgZm9yIGV4YW1wbGUgV2ViU29ja2V0LiBUaGlzIGNhbiBiZSBhIGN1c3RvbSBpbXBsZW1lbnRhdGlvbgogICAqIEBwYXJhbSBvcHRpb25zLnRpbWVvdXQgVGhlIGRlZmF1bHQgdGltZW91dCBpbiBtaWxsaXNlY29uZHMgdG8gdHJpZ2dlciBwdXNoIHRpbWVvdXRzLgogICAqIEBwYXJhbSBvcHRpb25zLnBhcmFtcyBUaGUgb3B0aW9uYWwgcGFyYW1zIHRvIHBhc3Mgd2hlbiBjb25uZWN0aW5nLgogICAqIEBwYXJhbSBvcHRpb25zLmhlYWRlcnMgRGVwcmVjYXRlZDogaGVhZGVycyBjYW5ub3QgYmUgc2V0IG9uIHdlYnNvY2tldCBjb25uZWN0aW9ucyBhbmQgdGhpcyBvcHRpb24gd2lsbCBiZSByZW1vdmVkIGluIHRoZSBmdXR1cmUuCiAgICogQHBhcmFtIG9wdGlvbnMuaGVhcnRiZWF0SW50ZXJ2YWxNcyBUaGUgbWlsbGlzZWMgaW50ZXJ2YWwgdG8gc2VuZCBhIGhlYXJ0YmVhdCBtZXNzYWdlLgogICAqIEBwYXJhbSBvcHRpb25zLmhlYXJ0YmVhdENhbGxiYWNrIFRoZSBvcHRpb25hbCBmdW5jdGlvbiB0byBoYW5kbGUgaGVhcnRiZWF0IHN0YXR1cyBhbmQgbGF0ZW5jeS4KICAgKiBAcGFyYW0gb3B0aW9ucy5sb2dnZXIgVGhlIG9wdGlvbmFsIGZ1bmN0aW9uIGZvciBzcGVjaWFsaXplZCBsb2dnaW5nLCBpZTogbG9nZ2VyOiAoa2luZCwgbXNnLCBkYXRhKSA9PiB7IGNvbnNvbGUubG9nKGAke2tpbmR9OiAke21zZ31gLCBkYXRhKSB9CiAgICogQHBhcmFtIG9wdGlvbnMubG9nTGV2ZWwgU2V0cyB0aGUgbG9nIGxldmVsIGZvciBSZWFsdGltZQogICAqIEBwYXJhbSBvcHRpb25zLmVuY29kZSBUaGUgZnVuY3Rpb24gdG8gZW5jb2RlIG91dGdvaW5nIG1lc3NhZ2VzLiBEZWZhdWx0cyB0byBKU09OOiAocGF5bG9hZCwgY2FsbGJhY2spID0+IGNhbGxiYWNrKEpTT04uc3RyaW5naWZ5KHBheWxvYWQpKQogICAqIEBwYXJhbSBvcHRpb25zLmRlY29kZSBUaGUgZnVuY3Rpb24gdG8gZGVjb2RlIGluY29taW5nIG1lc3NhZ2VzLiBEZWZhdWx0cyB0byBTZXJpYWxpemVyJ3MgZGVjb2RlLgogICAqIEBwYXJhbSBvcHRpb25zLnJlY29ubmVjdEFmdGVyTXMgaGUgb3B0aW9uYWwgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZSBtaWxsc2VjIHJlY29ubmVjdCBpbnRlcnZhbC4gRGVmYXVsdHMgdG8gc3RlcHBlZCBiYWNrb2ZmIG9mZi4KICAgKiBAcGFyYW0gb3B0aW9ucy53b3JrZXIgVXNlIFdlYiBXb3JrZXIgdG8gc2V0IGEgc2lkZSBmbG93LiBEZWZhdWx0cyB0byBmYWxzZS4KICAgKiBAcGFyYW0gb3B0aW9ucy53b3JrZXJVcmwgVGhlIFVSTCBvZiB0aGUgd29ya2VyIHNjcmlwdC4gRGVmYXVsdHMgdG8gaHR0cHM6Ly9yZWFsdGltZS5zdXBhYmFzZS5jb20vd29ya2VyLmpzIHRoYXQgaW5jbHVkZXMgYSBoZWFydGJlYXQgZXZlbnQgY2FsbCB0byBrZWVwIHRoZSBjb25uZWN0aW9uIGFsaXZlLgogICAqIEBwYXJhbSBvcHRpb25zLnZzbiBUaGUgcHJvdG9jb2wgdmVyc2lvbiB0byB1c2Ugd2hlbiBjb25uZWN0aW5nLiBTdXBwb3J0ZWQgdmVyc2lvbnMgYXJlICIxLjAuMCIgYW5kICIyLjAuMCIuIERlZmF1bHRzIHRvICIyLjAuMCIuCiAgICogQGV4YW1wbGUKICAgKiBgYGB0cwogICAqIGltcG9ydCBSZWFsdGltZUNsaWVudCBmcm9tICdAc3VwYWJhc2UvcmVhbHRpbWUtanMnCiAgICoKICAgKiBjb25zdCBjbGllbnQgPSBuZXcgUmVhbHRpbWVDbGllbnQoJ2h0dHBzOi8veHl6Y29tcGFueS5zdXBhYmFzZS5jby9yZWFsdGltZS92MScsIHsKICAgKiAgIHBhcmFtczogeyBhcGlrZXk6ICdwdWJsaWMtYW5vbi1rZXknIH0sCiAgICogfSkKICAgKiBjbGllbnQuY29ubmVjdCgpCiAgICogYGBgCiAgICovCiAgY29uc3RydWN0b3IoZW5kUG9pbnQsIG9wdGlvbnMpIHsKICAgIHZhciBfYTsKICAgIHRoaXMuYWNjZXNzVG9rZW5WYWx1ZSA9IG51bGw7CiAgICB0aGlzLmFwaUtleSA9IG51bGw7CiAgICB0aGlzLl9tYW51YWxseVNldFRva2VuID0gZmFsc2U7CiAgICB0aGlzLmNoYW5uZWxzID0gbmV3IEFycmF5KCk7CiAgICB0aGlzLmVuZFBvaW50ID0gIiI7CiAgICB0aGlzLmh0dHBFbmRwb2ludCA9ICIiOwogICAgdGhpcy5oZWFkZXJzID0ge307CiAgICB0aGlzLnBhcmFtcyA9IHt9OwogICAgdGhpcy50aW1lb3V0ID0gREVGQVVMVF9USU1FT1VUOwogICAgdGhpcy50cmFuc3BvcnQgPSBudWxsOwogICAgdGhpcy5oZWFydGJlYXRJbnRlcnZhbE1zID0gQ09OTkVDVElPTl9USU1FT1VUUy5IRUFSVEJFQVRfSU5URVJWQUw7CiAgICB0aGlzLmhlYXJ0YmVhdFRpbWVyID0gdm9pZCAwOwogICAgdGhpcy5wZW5kaW5nSGVhcnRiZWF0UmVmID0gbnVsbDsKICAgIHRoaXMuaGVhcnRiZWF0Q2FsbGJhY2sgPSBub29wNTsKICAgIHRoaXMucmVmID0gMDsKICAgIHRoaXMucmVjb25uZWN0VGltZXIgPSBudWxsOwogICAgdGhpcy52c24gPSBERUZBVUxUX1ZTTjsKICAgIHRoaXMubG9nZ2VyID0gbm9vcDU7CiAgICB0aGlzLmNvbm4gPSBudWxsOwogICAgdGhpcy5zZW5kQnVmZmVyID0gW107CiAgICB0aGlzLnNlcmlhbGl6ZXIgPSBuZXcgU2VyaWFsaXplcigpOwogICAgdGhpcy5zdGF0ZUNoYW5nZUNhbGxiYWNrcyA9IHsKICAgICAgb3BlbjogW10sCiAgICAgIGNsb3NlOiBbXSwKICAgICAgZXJyb3I6IFtdLAogICAgICBtZXNzYWdlOiBbXQogICAgfTsKICAgIHRoaXMuYWNjZXNzVG9rZW4gPSBudWxsOwogICAgdGhpcy5fY29ubmVjdGlvblN0YXRlID0gImRpc2Nvbm5lY3RlZCI7CiAgICB0aGlzLl93YXNNYW51YWxEaXNjb25uZWN0ID0gZmFsc2U7CiAgICB0aGlzLl9hdXRoUHJvbWlzZSA9IG51bGw7CiAgICB0aGlzLl9oZWFydGJlYXRTZW50QXQgPSBudWxsOwogICAgdGhpcy5fcmVzb2x2ZUZldGNoID0gKGN1c3RvbUZldGNoKSA9PiB7CiAgICAgIGlmIChjdXN0b21GZXRjaCkgewogICAgICAgIHJldHVybiAoLi4uYXJncykgPT4gY3VzdG9tRmV0Y2goLi4uYXJncyk7CiAgICAgIH0KICAgICAgcmV0dXJuICguLi5hcmdzKSA9PiBmZXRjaCguLi5hcmdzKTsKICAgIH07CiAgICBpZiAoISgoX2EgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMucGFyYW1zKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuYXBpa2V5KSkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkFQSSBrZXkgaXMgcmVxdWlyZWQgdG8gY29ubmVjdCB0byBSZWFsdGltZSIpOwogICAgfQogICAgdGhpcy5hcGlLZXkgPSBvcHRpb25zLnBhcmFtcy5hcGlrZXk7CiAgICB0aGlzLmVuZFBvaW50ID0gYCR7ZW5kUG9pbnR9LyR7VFJBTlNQT1JUUy53ZWJzb2NrZXR9YDsKICAgIHRoaXMuaHR0cEVuZHBvaW50ID0gaHR0cEVuZHBvaW50VVJMKGVuZFBvaW50KTsKICAgIHRoaXMuX2luaXRpYWxpemVPcHRpb25zKG9wdGlvbnMpOwogICAgdGhpcy5fc2V0dXBSZWNvbm5lY3Rpb25UaW1lcigpOwogICAgdGhpcy5mZXRjaCA9IHRoaXMuX3Jlc29sdmVGZXRjaChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuZmV0Y2gpOwogIH0KICAvKioKICAgKiBDb25uZWN0cyB0aGUgc29ja2V0LCB1bmxlc3MgYWxyZWFkeSBjb25uZWN0ZWQuCiAgICovCiAgY29ubmVjdCgpIHsKICAgIGlmICh0aGlzLmlzQ29ubmVjdGluZygpIHx8IHRoaXMuaXNEaXNjb25uZWN0aW5nKCkgfHwgdGhpcy5jb25uICE9PSBudWxsICYmIHRoaXMuaXNDb25uZWN0ZWQoKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLl9zZXRDb25uZWN0aW9uU3RhdGUoImNvbm5lY3RpbmciKTsKICAgIGlmICh0aGlzLmFjY2Vzc1Rva2VuICYmICF0aGlzLl9hdXRoUHJvbWlzZSkgewogICAgICB0aGlzLl9zZXRBdXRoU2FmZWx5KCJjb25uZWN0Iik7CiAgICB9CiAgICBpZiAodGhpcy50cmFuc3BvcnQpIHsKICAgICAgdGhpcy5jb25uID0gbmV3IHRoaXMudHJhbnNwb3J0KHRoaXMuZW5kcG9pbnRVUkwoKSk7CiAgICB9IGVsc2UgewogICAgICB0cnkgewogICAgICAgIHRoaXMuY29ubiA9IHdlYnNvY2tldF9mYWN0b3J5X2RlZmF1bHQuY3JlYXRlV2ViU29ja2V0KHRoaXMuZW5kcG9pbnRVUkwoKSk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgdGhpcy5fc2V0Q29ubmVjdGlvblN0YXRlKCJkaXNjb25uZWN0ZWQiKTsKICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlOwogICAgICAgIGlmIChlcnJvck1lc3NhZ2UuaW5jbHVkZXMoIk5vZGUuanMiKSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke2Vycm9yTWVzc2FnZX0KClRvIHVzZSBSZWFsdGltZSBpbiBOb2RlLmpzLCB5b3UgbmVlZCB0byBwcm92aWRlIGEgV2ViU29ja2V0IGltcGxlbWVudGF0aW9uOgoKT3B0aW9uIDE6IFVzZSBOb2RlLmpzIDIyKyB3aGljaCBoYXMgbmF0aXZlIFdlYlNvY2tldCBzdXBwb3J0Ck9wdGlvbiAyOiBJbnN0YWxsIGFuZCBwcm92aWRlIHRoZSAid3MiIHBhY2thZ2U6CgogIG5wbSBpbnN0YWxsIHdzCgogIGltcG9ydCB3cyBmcm9tICJ3cyIKICBjb25zdCBjbGllbnQgPSBuZXcgUmVhbHRpbWVDbGllbnQodXJsLCB7CiAgICAuLi5vcHRpb25zLAogICAgdHJhbnNwb3J0OiB3cwogIH0pYCk7CiAgICAgICAgfQogICAgICAgIHRocm93IG5ldyBFcnJvcihgV2ViU29ja2V0IG5vdCBhdmFpbGFibGU6ICR7ZXJyb3JNZXNzYWdlfWApOwogICAgICB9CiAgICB9CiAgICB0aGlzLl9zZXR1cENvbm5lY3Rpb25IYW5kbGVycygpOwogIH0KICAvKioKICAgKiBSZXR1cm5zIHRoZSBVUkwgb2YgdGhlIHdlYnNvY2tldC4KICAgKiBAcmV0dXJucyBzdHJpbmcgVGhlIFVSTCBvZiB0aGUgd2Vic29ja2V0LgogICAqLwogIGVuZHBvaW50VVJMKCkgewogICAgcmV0dXJuIHRoaXMuX2FwcGVuZFBhcmFtcyh0aGlzLmVuZFBvaW50LCBPYmplY3QuYXNzaWduKHt9LCB0aGlzLnBhcmFtcywgeyB2c246IHRoaXMudnNuIH0pKTsKICB9CiAgLyoqCiAgICogRGlzY29ubmVjdHMgdGhlIHNvY2tldC4KICAgKgogICAqIEBwYXJhbSBjb2RlIEEgbnVtZXJpYyBzdGF0dXMgY29kZSB0byBzZW5kIG9uIGRpc2Nvbm5lY3QuCiAgICogQHBhcmFtIHJlYXNvbiBBIGN1c3RvbSByZWFzb24gZm9yIHRoZSBkaXNjb25uZWN0LgogICAqLwogIGRpc2Nvbm5lY3QoY29kZSwgcmVhc29uKSB7CiAgICBpZiAodGhpcy5pc0Rpc2Nvbm5lY3RpbmcoKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICB0aGlzLl9zZXRDb25uZWN0aW9uU3RhdGUoImRpc2Nvbm5lY3RpbmciLCB0cnVlKTsKICAgIGlmICh0aGlzLmNvbm4pIHsKICAgICAgY29uc3QgZmFsbGJhY2tUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIHRoaXMuX3NldENvbm5lY3Rpb25TdGF0ZSgiZGlzY29ubmVjdGVkIik7CiAgICAgIH0sIDEwMCk7CiAgICAgIHRoaXMuY29ubi5vbmNsb3NlID0gKCkgPT4gewogICAgICAgIGNsZWFyVGltZW91dChmYWxsYmFja1RpbWVyKTsKICAgICAgICB0aGlzLl9zZXRDb25uZWN0aW9uU3RhdGUoImRpc2Nvbm5lY3RlZCIpOwogICAgICB9OwogICAgICBpZiAodHlwZW9mIHRoaXMuY29ubi5jbG9zZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGlmIChjb2RlKSB7CiAgICAgICAgICB0aGlzLmNvbm4uY2xvc2UoY29kZSwgcmVhc29uICE9PSBudWxsICYmIHJlYXNvbiAhPT0gdm9pZCAwID8gcmVhc29uIDogIiIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLmNvbm4uY2xvc2UoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgdGhpcy5fdGVhcmRvd25Db25uZWN0aW9uKCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl9zZXRDb25uZWN0aW9uU3RhdGUoImRpc2Nvbm5lY3RlZCIpOwogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm5zIGFsbCBjcmVhdGVkIGNoYW5uZWxzCiAgICovCiAgZ2V0Q2hhbm5lbHMoKSB7CiAgICByZXR1cm4gdGhpcy5jaGFubmVsczsKICB9CiAgLyoqCiAgICogVW5zdWJzY3JpYmVzIGFuZCByZW1vdmVzIGEgc2luZ2xlIGNoYW5uZWwKICAgKiBAcGFyYW0gY2hhbm5lbCBBIFJlYWx0aW1lQ2hhbm5lbCBpbnN0YW5jZQogICAqLwogIGFzeW5jIHJlbW92ZUNoYW5uZWwoY2hhbm5lbCkgewogICAgY29uc3Qgc3RhdHVzID0gYXdhaXQgY2hhbm5lbC51bnN1YnNjcmliZSgpOwogICAgaWYgKHRoaXMuY2hhbm5lbHMubGVuZ3RoID09PSAwKSB7CiAgICAgIHRoaXMuZGlzY29ubmVjdCgpOwogICAgfQogICAgcmV0dXJuIHN0YXR1czsKICB9CiAgLyoqCiAgICogVW5zdWJzY3JpYmVzIGFuZCByZW1vdmVzIGFsbCBjaGFubmVscwogICAqLwogIGFzeW5jIHJlbW92ZUFsbENoYW5uZWxzKCkgewogICAgY29uc3QgdmFsdWVzXzEgPSBhd2FpdCBQcm9taXNlLmFsbCh0aGlzLmNoYW5uZWxzLm1hcCgoY2hhbm5lbCkgPT4gY2hhbm5lbC51bnN1YnNjcmliZSgpKSk7CiAgICB0aGlzLmNoYW5uZWxzID0gW107CiAgICB0aGlzLmRpc2Nvbm5lY3QoKTsKICAgIHJldHVybiB2YWx1ZXNfMTsKICB9CiAgLyoqCiAgICogTG9ncyB0aGUgbWVzc2FnZS4KICAgKgogICAqIEZvciBjdXN0b21pemVkIGxvZ2dpbmcsIGB0aGlzLmxvZ2dlcmAgY2FuIGJlIG92ZXJyaWRkZW4uCiAgICovCiAgbG9nKGtpbmQsIG1zZywgZGF0YSkgewogICAgdGhpcy5sb2dnZXIoa2luZCwgbXNnLCBkYXRhKTsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgc29ja2V0LgogICAqLwogIGNvbm5lY3Rpb25TdGF0ZSgpIHsKICAgIHN3aXRjaCAodGhpcy5jb25uICYmIHRoaXMuY29ubi5yZWFkeVN0YXRlKSB7CiAgICAgIGNhc2UgU09DS0VUX1NUQVRFUy5jb25uZWN0aW5nOgogICAgICAgIHJldHVybiBDT05ORUNUSU9OX1NUQVRFLkNvbm5lY3Rpbmc7CiAgICAgIGNhc2UgU09DS0VUX1NUQVRFUy5vcGVuOgogICAgICAgIHJldHVybiBDT05ORUNUSU9OX1NUQVRFLk9wZW47CiAgICAgIGNhc2UgU09DS0VUX1NUQVRFUy5jbG9zaW5nOgogICAgICAgIHJldHVybiBDT05ORUNUSU9OX1NUQVRFLkNsb3Npbmc7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIENPTk5FQ1RJT05fU1RBVEUuQ2xvc2VkOwogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpcyB0aGUgY29ubmVjdGlvbiBpcyBvcGVuLgogICAqLwogIGlzQ29ubmVjdGVkKCkgewogICAgcmV0dXJuIHRoaXMuY29ubmVjdGlvblN0YXRlKCkgPT09IENPTk5FQ1RJT05fU1RBVEUuT3BlbjsKICB9CiAgLyoqCiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGNvbm5lY3Rpb24gaXMgY3VycmVudGx5IGNvbm5lY3RpbmcuCiAgICovCiAgaXNDb25uZWN0aW5nKCkgewogICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb25TdGF0ZSA9PT0gImNvbm5lY3RpbmciOwogIH0KICAvKioKICAgKiBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgY29ubmVjdGlvbiBpcyBjdXJyZW50bHkgZGlzY29ubmVjdGluZy4KICAgKi8KICBpc0Rpc2Nvbm5lY3RpbmcoKSB7CiAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvblN0YXRlID09PSAiZGlzY29ubmVjdGluZyI7CiAgfQogIC8qKgogICAqIENyZWF0ZXMgKG9yIHJldXNlcykgYSB7QGxpbmsgUmVhbHRpbWVDaGFubmVsfSBmb3IgdGhlIHByb3ZpZGVkIHRvcGljLgogICAqCiAgICogVG9waWNzIGFyZSBhdXRvbWF0aWNhbGx5IHByZWZpeGVkIHdpdGggYHJlYWx0aW1lOmAgdG8gbWF0Y2ggdGhlIFJlYWx0aW1lIHNlcnZpY2UuCiAgICogSWYgYSBjaGFubmVsIHdpdGggdGhlIHNhbWUgdG9waWMgYWxyZWFkeSBleGlzdHMgaXQgd2lsbCBiZSByZXR1cm5lZCBpbnN0ZWFkIG9mIGNyZWF0aW5nCiAgICogYSBkdXBsaWNhdGUgY29ubmVjdGlvbi4KICAgKi8KICBjaGFubmVsKHRvcGljLCBwYXJhbXMgPSB7IGNvbmZpZzoge30gfSkgewogICAgY29uc3QgcmVhbHRpbWVUb3BpYyA9IGByZWFsdGltZToke3RvcGljfWA7CiAgICBjb25zdCBleGlzdHMgPSB0aGlzLmdldENoYW5uZWxzKCkuZmluZCgoYykgPT4gYy50b3BpYyA9PT0gcmVhbHRpbWVUb3BpYyk7CiAgICBpZiAoIWV4aXN0cykgewogICAgICBjb25zdCBjaGFuID0gbmV3IFJlYWx0aW1lQ2hhbm5lbChgcmVhbHRpbWU6JHt0b3BpY31gLCBwYXJhbXMsIHRoaXMpOwogICAgICB0aGlzLmNoYW5uZWxzLnB1c2goY2hhbik7CiAgICAgIHJldHVybiBjaGFuOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGV4aXN0czsKICAgIH0KICB9CiAgLyoqCiAgICogUHVzaCBvdXQgYSBtZXNzYWdlIGlmIHRoZSBzb2NrZXQgaXMgY29ubmVjdGVkLgogICAqCiAgICogSWYgdGhlIHNvY2tldCBpcyBub3QgY29ubmVjdGVkLCB0aGUgbWVzc2FnZSBnZXRzIGVucXVldWVkIHdpdGhpbiBhIGxvY2FsIGJ1ZmZlciwgYW5kIHNlbnQgb3V0IHdoZW4gYSBjb25uZWN0aW9uIGlzIG5leHQgZXN0YWJsaXNoZWQuCiAgICovCiAgcHVzaChkYXRhKSB7CiAgICBjb25zdCB7IHRvcGljLCBldmVudCwgcGF5bG9hZCwgcmVmIH0gPSBkYXRhOwogICAgY29uc3QgY2FsbGJhY2sgPSAoKSA9PiB7CiAgICAgIHRoaXMuZW5jb2RlKGRhdGEsIChyZXN1bHQpID0+IHsKICAgICAgICB2YXIgX2E7CiAgICAgICAgKF9hID0gdGhpcy5jb25uKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2VuZChyZXN1bHQpOwogICAgICB9KTsKICAgIH07CiAgICB0aGlzLmxvZygicHVzaCIsIGAke3RvcGljfSAke2V2ZW50fSAoJHtyZWZ9KWAsIHBheWxvYWQpOwogICAgaWYgKHRoaXMuaXNDb25uZWN0ZWQoKSkgewogICAgICBjYWxsYmFjaygpOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5zZW5kQnVmZmVyLnB1c2goY2FsbGJhY2spOwogICAgfQogIH0KICAvKioKICAgKiBTZXRzIHRoZSBKV1QgYWNjZXNzIHRva2VuIHVzZWQgZm9yIGNoYW5uZWwgc3Vic2NyaXB0aW9uIGF1dGhvcml6YXRpb24gYW5kIFJlYWx0aW1lIFJMUy4KICAgKgogICAqIElmIHBhcmFtIGlzIG51bGwgaXQgd2lsbCB1c2UgdGhlIGBhY2Nlc3NUb2tlbmAgY2FsbGJhY2sgZnVuY3Rpb24gb3IgdGhlIHRva2VuIHNldCBvbiB0aGUgY2xpZW50LgogICAqCiAgICogT24gY2FsbGJhY2sgdXNlZCwgaXQgd2lsbCBzZXQgdGhlIHZhbHVlIG9mIHRoZSB0b2tlbiBpbnRlcm5hbCB0byB0aGUgY2xpZW50LgogICAqCiAgICogV2hlbiBhIHRva2VuIGlzIGV4cGxpY2l0bHkgcHJvdmlkZWQsIGl0IHdpbGwgYmUgcHJlc2VydmVkIGFjcm9zcyBjaGFubmVsIG9wZXJhdGlvbnMKICAgKiAoaW5jbHVkaW5nIHJlbW92ZUNoYW5uZWwgYW5kIHJlc3Vic2NyaWJlKS4gVGhlIGBhY2Nlc3NUb2tlbmAgY2FsbGJhY2sgd2lsbCBub3QgYmUKICAgKiBpbnZva2VkIHVudGlsIGBzZXRBdXRoKClgIGlzIGNhbGxlZCB3aXRob3V0IGFyZ3VtZW50cy4KICAgKgogICAqIEBwYXJhbSB0b2tlbiBBIEpXVCBzdHJpbmcgdG8gb3ZlcnJpZGUgdGhlIHRva2VuIHNldCBvbiB0aGUgY2xpZW50LgogICAqCiAgICogQGV4YW1wbGUKICAgKiAvLyBVc2UgYSBtYW51YWwgdG9rZW4gKHByZXNlcnZlZCBhY3Jvc3MgcmVzdWJzY3JpYmVzLCBpZ25vcmVzIGFjY2Vzc1Rva2VuIGNhbGxiYWNrKQogICAqIGNsaWVudC5yZWFsdGltZS5zZXRBdXRoKCdteS1jdXN0b20tand0JykKICAgKgogICAqIC8vIFN3aXRjaCBiYWNrIHRvIHVzaW5nIHRoZSBhY2Nlc3NUb2tlbiBjYWxsYmFjawogICAqIGNsaWVudC5yZWFsdGltZS5zZXRBdXRoKCkKICAgKi8KICBhc3luYyBzZXRBdXRoKHRva2VuID0gbnVsbCkgewogICAgdGhpcy5fYXV0aFByb21pc2UgPSB0aGlzLl9wZXJmb3JtQXV0aCh0b2tlbik7CiAgICB0cnkgewogICAgICBhd2FpdCB0aGlzLl9hdXRoUHJvbWlzZTsKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX2F1dGhQcm9taXNlID0gbnVsbDsKICAgIH0KICB9CiAgLyoqCiAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBjdXJyZW50IGFjY2VzcyB0b2tlbiB3YXMgZXhwbGljaXRseSBzZXQgdmlhIHNldEF1dGgodG9rZW4pLAogICAqIGZhbHNlIGlmIGl0IHdhcyBvYnRhaW5lZCB2aWEgdGhlIGFjY2Vzc1Rva2VuIGNhbGxiYWNrLgogICAqIEBpbnRlcm5hbAogICAqLwogIF9pc01hbnVhbFRva2VuKCkgewogICAgcmV0dXJuIHRoaXMuX21hbnVhbGx5U2V0VG9rZW47CiAgfQogIC8qKgogICAqIFNlbmRzIGEgaGVhcnRiZWF0IG1lc3NhZ2UgaWYgdGhlIHNvY2tldCBpcyBjb25uZWN0ZWQuCiAgICovCiAgYXN5bmMgc2VuZEhlYXJ0YmVhdCgpIHsKICAgIHZhciBfYTsKICAgIGlmICghdGhpcy5pc0Nvbm5lY3RlZCgpKSB7CiAgICAgIHRyeSB7CiAgICAgICAgdGhpcy5oZWFydGJlYXRDYWxsYmFjaygiZGlzY29ubmVjdGVkIik7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB0aGlzLmxvZygiZXJyb3IiLCAiZXJyb3IgaW4gaGVhcnRiZWF0IGNhbGxiYWNrIiwgZSk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHRoaXMucGVuZGluZ0hlYXJ0YmVhdFJlZikgewogICAgICB0aGlzLnBlbmRpbmdIZWFydGJlYXRSZWYgPSBudWxsOwogICAgICB0aGlzLl9oZWFydGJlYXRTZW50QXQgPSBudWxsOwogICAgICB0aGlzLmxvZygidHJhbnNwb3J0IiwgImhlYXJ0YmVhdCB0aW1lb3V0LiBBdHRlbXB0aW5nIHRvIHJlLWVzdGFibGlzaCBjb25uZWN0aW9uIik7CiAgICAgIHRyeSB7CiAgICAgICAgdGhpcy5oZWFydGJlYXRDYWxsYmFjaygidGltZW91dCIpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgdGhpcy5sb2coImVycm9yIiwgImVycm9yIGluIGhlYXJ0YmVhdCBjYWxsYmFjayIsIGUpOwogICAgICB9CiAgICAgIHRoaXMuX3dhc01hbnVhbERpc2Nvbm5lY3QgPSBmYWxzZTsKICAgICAgKF9hID0gdGhpcy5jb25uKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY2xvc2UoV1NfQ0xPU0VfTk9STUFMLCAiaGVhcnRiZWF0IHRpbWVvdXQiKTsKICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgdmFyIF9hMjsKICAgICAgICBpZiAoIXRoaXMuaXNDb25uZWN0ZWQoKSkgewogICAgICAgICAgKF9hMiA9IHRoaXMucmVjb25uZWN0VGltZXIpID09PSBudWxsIHx8IF9hMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EyLnNjaGVkdWxlVGltZW91dCgpOwogICAgICAgIH0KICAgICAgfSwgQ09OTkVDVElPTl9USU1FT1VUUy5IRUFSVEJFQVRfVElNRU9VVF9GQUxMQkFDSyk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMuX2hlYXJ0YmVhdFNlbnRBdCA9IERhdGUubm93KCk7CiAgICB0aGlzLnBlbmRpbmdIZWFydGJlYXRSZWYgPSB0aGlzLl9tYWtlUmVmKCk7CiAgICB0aGlzLnB1c2goewogICAgICB0b3BpYzogInBob2VuaXgiLAogICAgICBldmVudDogImhlYXJ0YmVhdCIsCiAgICAgIHBheWxvYWQ6IHt9LAogICAgICByZWY6IHRoaXMucGVuZGluZ0hlYXJ0YmVhdFJlZgogICAgfSk7CiAgICB0cnkgewogICAgICB0aGlzLmhlYXJ0YmVhdENhbGxiYWNrKCJzZW50Iik7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHRoaXMubG9nKCJlcnJvciIsICJlcnJvciBpbiBoZWFydGJlYXQgY2FsbGJhY2siLCBlKTsKICAgIH0KICAgIHRoaXMuX3NldEF1dGhTYWZlbHkoImhlYXJ0YmVhdCIpOwogIH0KICAvKioKICAgKiBTZXRzIGEgY2FsbGJhY2sgdGhhdCByZWNlaXZlcyBsaWZlY3ljbGUgZXZlbnRzIGZvciBpbnRlcm5hbCBoZWFydGJlYXQgbWVzc2FnZXMuCiAgICogVXNlZnVsIGZvciBpbnN0cnVtZW50aW5nIGNvbm5lY3Rpb24gaGVhbHRoIChlLmcuIHNlbnQvb2svdGltZW91dC9kaXNjb25uZWN0ZWQpLgogICAqLwogIG9uSGVhcnRiZWF0KGNhbGxiYWNrKSB7CiAgICB0aGlzLmhlYXJ0YmVhdENhbGxiYWNrID0gY2FsbGJhY2s7CiAgfQogIC8qKgogICAqIEZsdXNoZXMgc2VuZCBidWZmZXIKICAgKi8KICBmbHVzaFNlbmRCdWZmZXIoKSB7CiAgICBpZiAodGhpcy5pc0Nvbm5lY3RlZCgpICYmIHRoaXMuc2VuZEJ1ZmZlci5sZW5ndGggPiAwKSB7CiAgICAgIHRoaXMuc2VuZEJ1ZmZlci5mb3JFYWNoKChjYWxsYmFjaykgPT4gY2FsbGJhY2soKSk7CiAgICAgIHRoaXMuc2VuZEJ1ZmZlciA9IFtdOwogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm4gdGhlIG5leHQgbWVzc2FnZSByZWYsIGFjY291bnRpbmcgZm9yIG92ZXJmbG93cwogICAqCiAgICogQGludGVybmFsCiAgICovCiAgX21ha2VSZWYoKSB7CiAgICBsZXQgbmV3UmVmID0gdGhpcy5yZWYgKyAxOwogICAgaWYgKG5ld1JlZiA9PT0gdGhpcy5yZWYpIHsKICAgICAgdGhpcy5yZWYgPSAwOwogICAgfSBlbHNlIHsKICAgICAgdGhpcy5yZWYgPSBuZXdSZWY7CiAgICB9CiAgICByZXR1cm4gdGhpcy5yZWYudG9TdHJpbmcoKTsKICB9CiAgLyoqCiAgICogVW5zdWJzY3JpYmUgZnJvbSBjaGFubmVscyB3aXRoIHRoZSBzcGVjaWZpZWQgdG9waWMuCiAgICoKICAgKiBAaW50ZXJuYWwKICAgKi8KICBfbGVhdmVPcGVuVG9waWModG9waWMpIHsKICAgIGxldCBkdXBDaGFubmVsID0gdGhpcy5jaGFubmVscy5maW5kKChjKSA9PiBjLnRvcGljID09PSB0b3BpYyAmJiAoYy5faXNKb2luZWQoKSB8fCBjLl9pc0pvaW5pbmcoKSkpOwogICAgaWYgKGR1cENoYW5uZWwpIHsKICAgICAgdGhpcy5sb2coInRyYW5zcG9ydCIsIGBsZWF2aW5nIGR1cGxpY2F0ZSB0b3BpYyAiJHt0b3BpY30iYCk7CiAgICAgIGR1cENoYW5uZWwudW5zdWJzY3JpYmUoKTsKICAgIH0KICB9CiAgLyoqCiAgICogUmVtb3ZlcyBhIHN1YnNjcmlwdGlvbiBmcm9tIHRoZSBzb2NrZXQuCiAgICoKICAgKiBAcGFyYW0gY2hhbm5lbCBBbiBvcGVuIHN1YnNjcmlwdGlvbi4KICAgKgogICAqIEBpbnRlcm5hbAogICAqLwogIF9yZW1vdmUoY2hhbm5lbCkgewogICAgdGhpcy5jaGFubmVscyA9IHRoaXMuY2hhbm5lbHMuZmlsdGVyKChjKSA9PiBjLnRvcGljICE9PSBjaGFubmVsLnRvcGljKTsKICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIF9vbkNvbm5NZXNzYWdlKHJhd01lc3NhZ2UpIHsKICAgIHRoaXMuZGVjb2RlKHJhd01lc3NhZ2UuZGF0YSwgKG1zZykgPT4gewogICAgICBpZiAobXNnLnRvcGljID09PSAicGhvZW5peCIgJiYgbXNnLmV2ZW50ID09PSAicGh4X3JlcGx5IiAmJiBtc2cucmVmICYmIG1zZy5yZWYgPT09IHRoaXMucGVuZGluZ0hlYXJ0YmVhdFJlZikgewogICAgICAgIGNvbnN0IGxhdGVuY3kgPSB0aGlzLl9oZWFydGJlYXRTZW50QXQgPyBEYXRlLm5vdygpIC0gdGhpcy5faGVhcnRiZWF0U2VudEF0IDogdm9pZCAwOwogICAgICAgIHRyeSB7CiAgICAgICAgICB0aGlzLmhlYXJ0YmVhdENhbGxiYWNrKG1zZy5wYXlsb2FkLnN0YXR1cyA9PT0gIm9rIiA/ICJvayIgOiAiZXJyb3IiLCBsYXRlbmN5KTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICB0aGlzLmxvZygiZXJyb3IiLCAiZXJyb3IgaW4gaGVhcnRiZWF0IGNhbGxiYWNrIiwgZSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2hlYXJ0YmVhdFNlbnRBdCA9IG51bGw7CiAgICAgICAgdGhpcy5wZW5kaW5nSGVhcnRiZWF0UmVmID0gbnVsbDsKICAgICAgfQogICAgICBjb25zdCB7IHRvcGljLCBldmVudCwgcGF5bG9hZCwgcmVmIH0gPSBtc2c7CiAgICAgIGNvbnN0IHJlZlN0cmluZyA9IHJlZiA/IGAoJHtyZWZ9KWAgOiAiIjsKICAgICAgY29uc3Qgc3RhdHVzID0gcGF5bG9hZC5zdGF0dXMgfHwgIiI7CiAgICAgIHRoaXMubG9nKCJyZWNlaXZlIiwgYCR7c3RhdHVzfSAke3RvcGljfSAke2V2ZW50fSAke3JlZlN0cmluZ31gLnRyaW0oKSwgcGF5bG9hZCk7CiAgICAgIHRoaXMuY2hhbm5lbHMuZmlsdGVyKChjaGFubmVsKSA9PiBjaGFubmVsLl9pc01lbWJlcih0b3BpYykpLmZvckVhY2goKGNoYW5uZWwpID0+IGNoYW5uZWwuX3RyaWdnZXIoZXZlbnQsIHBheWxvYWQsIHJlZikpOwogICAgICB0aGlzLl90cmlnZ2VyU3RhdGVDYWxsYmFja3MoIm1lc3NhZ2UiLCBtc2cpOwogICAgfSk7CiAgfQogIC8qKgogICAqIENsZWFyIHNwZWNpZmljIHRpbWVyCiAgICogQGludGVybmFsCiAgICovCiAgX2NsZWFyVGltZXIodGltZXIpIHsKICAgIHZhciBfYTsKICAgIGlmICh0aW1lciA9PT0gImhlYXJ0YmVhdCIgJiYgdGhpcy5oZWFydGJlYXRUaW1lcikgewogICAgICBjbGVhckludGVydmFsKHRoaXMuaGVhcnRiZWF0VGltZXIpOwogICAgICB0aGlzLmhlYXJ0YmVhdFRpbWVyID0gdm9pZCAwOwogICAgfSBlbHNlIGlmICh0aW1lciA9PT0gInJlY29ubmVjdCIpIHsKICAgICAgKF9hID0gdGhpcy5yZWNvbm5lY3RUaW1lcikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlc2V0KCk7CiAgICB9CiAgfQogIC8qKgogICAqIENsZWFyIGFsbCB0aW1lcnMKICAgKiBAaW50ZXJuYWwKICAgKi8KICBfY2xlYXJBbGxUaW1lcnMoKSB7CiAgICB0aGlzLl9jbGVhclRpbWVyKCJoZWFydGJlYXQiKTsKICAgIHRoaXMuX2NsZWFyVGltZXIoInJlY29ubmVjdCIpOwogIH0KICAvKioKICAgKiBTZXR1cCBjb25uZWN0aW9uIGhhbmRsZXJzIGZvciBXZWJTb2NrZXQgZXZlbnRzCiAgICogQGludGVybmFsCiAgICovCiAgX3NldHVwQ29ubmVjdGlvbkhhbmRsZXJzKCkgewogICAgaWYgKCF0aGlzLmNvbm4pCiAgICAgIHJldHVybjsKICAgIGlmICgiYmluYXJ5VHlwZSIgaW4gdGhpcy5jb25uKSB7CiAgICAgIDsKICAgICAgdGhpcy5jb25uLmJpbmFyeVR5cGUgPSAiYXJyYXlidWZmZXIiOwogICAgfQogICAgdGhpcy5jb25uLm9ub3BlbiA9ICgpID0+IHRoaXMuX29uQ29ubk9wZW4oKTsKICAgIHRoaXMuY29ubi5vbmVycm9yID0gKGVycm9yKSA9PiB0aGlzLl9vbkNvbm5FcnJvcihlcnJvcik7CiAgICB0aGlzLmNvbm4ub25tZXNzYWdlID0gKGV2ZW50KSA9PiB0aGlzLl9vbkNvbm5NZXNzYWdlKGV2ZW50KTsKICAgIHRoaXMuY29ubi5vbmNsb3NlID0gKGV2ZW50KSA9PiB0aGlzLl9vbkNvbm5DbG9zZShldmVudCk7CiAgICBpZiAodGhpcy5jb25uLnJlYWR5U3RhdGUgPT09IFNPQ0tFVF9TVEFURVMub3BlbikgewogICAgICB0aGlzLl9vbkNvbm5PcGVuKCk7CiAgICB9CiAgfQogIC8qKgogICAqIFRlYXJkb3duIGNvbm5lY3Rpb24gYW5kIGNsZWFudXAgcmVzb3VyY2VzCiAgICogQGludGVybmFsCiAgICovCiAgX3RlYXJkb3duQ29ubmVjdGlvbigpIHsKICAgIGlmICh0aGlzLmNvbm4pIHsKICAgICAgaWYgKHRoaXMuY29ubi5yZWFkeVN0YXRlID09PSBTT0NLRVRfU1RBVEVTLm9wZW4gfHwgdGhpcy5jb25uLnJlYWR5U3RhdGUgPT09IFNPQ0tFVF9TVEFURVMuY29ubmVjdGluZykgewogICAgICAgIHRyeSB7CiAgICAgICAgICB0aGlzLmNvbm4uY2xvc2UoKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICB0aGlzLmxvZygiZXJyb3IiLCAiRXJyb3IgY2xvc2luZyBjb25uZWN0aW9uIiwgZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHRoaXMuY29ubi5vbm9wZW4gPSBudWxsOwogICAgICB0aGlzLmNvbm4ub25lcnJvciA9IG51bGw7CiAgICAgIHRoaXMuY29ubi5vbm1lc3NhZ2UgPSBudWxsOwogICAgICB0aGlzLmNvbm4ub25jbG9zZSA9IG51bGw7CiAgICAgIHRoaXMuY29ubiA9IG51bGw7CiAgICB9CiAgICB0aGlzLl9jbGVhckFsbFRpbWVycygpOwogICAgdGhpcy5fdGVybWluYXRlV29ya2VyKCk7CiAgICB0aGlzLmNoYW5uZWxzLmZvckVhY2goKGNoYW5uZWwpID0+IGNoYW5uZWwudGVhcmRvd24oKSk7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfb25Db25uT3BlbigpIHsKICAgIHRoaXMuX3NldENvbm5lY3Rpb25TdGF0ZSgiY29ubmVjdGVkIik7CiAgICB0aGlzLmxvZygidHJhbnNwb3J0IiwgYGNvbm5lY3RlZCB0byAke3RoaXMuZW5kcG9pbnRVUkwoKX1gKTsKICAgIGNvbnN0IGF1dGhQcm9taXNlID0gdGhpcy5fYXV0aFByb21pc2UgfHwgKHRoaXMuYWNjZXNzVG9rZW4gJiYgIXRoaXMuYWNjZXNzVG9rZW5WYWx1ZSA/IHRoaXMuc2V0QXV0aCgpIDogUHJvbWlzZS5yZXNvbHZlKCkpOwogICAgYXV0aFByb21pc2UudGhlbigoKSA9PiB7CiAgICAgIHRoaXMuZmx1c2hTZW5kQnVmZmVyKCk7CiAgICB9KS5jYXRjaCgoZSkgPT4gewogICAgICB0aGlzLmxvZygiZXJyb3IiLCAiZXJyb3Igd2FpdGluZyBmb3IgYXV0aCBvbiBjb25uZWN0IiwgZSk7CiAgICAgIHRoaXMuZmx1c2hTZW5kQnVmZmVyKCk7CiAgICB9KTsKICAgIHRoaXMuX2NsZWFyVGltZXIoInJlY29ubmVjdCIpOwogICAgaWYgKCF0aGlzLndvcmtlcikgewogICAgICB0aGlzLl9zdGFydEhlYXJ0YmVhdCgpOwogICAgfSBlbHNlIHsKICAgICAgaWYgKCF0aGlzLndvcmtlclJlZikgewogICAgICAgIHRoaXMuX3N0YXJ0V29ya2VySGVhcnRiZWF0KCk7CiAgICAgIH0KICAgIH0KICAgIHRoaXMuX3RyaWdnZXJTdGF0ZUNhbGxiYWNrcygib3BlbiIpOwogIH0KICAvKiogQGludGVybmFsICovCiAgX3N0YXJ0SGVhcnRiZWF0KCkgewogICAgdGhpcy5oZWFydGJlYXRUaW1lciAmJiBjbGVhckludGVydmFsKHRoaXMuaGVhcnRiZWF0VGltZXIpOwogICAgdGhpcy5oZWFydGJlYXRUaW1lciA9IHNldEludGVydmFsKCgpID0+IHRoaXMuc2VuZEhlYXJ0YmVhdCgpLCB0aGlzLmhlYXJ0YmVhdEludGVydmFsTXMpOwogIH0KICAvKiogQGludGVybmFsICovCiAgX3N0YXJ0V29ya2VySGVhcnRiZWF0KCkgewogICAgaWYgKHRoaXMud29ya2VyVXJsKSB7CiAgICAgIHRoaXMubG9nKCJ3b3JrZXIiLCBgc3RhcnRpbmcgd29ya2VyIGZvciBmcm9tICR7dGhpcy53b3JrZXJVcmx9YCk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmxvZygid29ya2VyIiwgYHN0YXJ0aW5nIGRlZmF1bHQgd29ya2VyYCk7CiAgICB9CiAgICBjb25zdCBvYmplY3RVcmwgPSB0aGlzLl93b3JrZXJPYmplY3RVcmwodGhpcy53b3JrZXJVcmwpOwogICAgdGhpcy53b3JrZXJSZWYgPSBuZXcgV29ya2VyKG9iamVjdFVybCk7CiAgICB0aGlzLndvcmtlclJlZi5vbmVycm9yID0gKGVycm9yKSA9PiB7CiAgICAgIHRoaXMubG9nKCJ3b3JrZXIiLCAid29ya2VyIGVycm9yIiwgZXJyb3IubWVzc2FnZSk7CiAgICAgIHRoaXMuX3Rlcm1pbmF0ZVdvcmtlcigpOwogICAgfTsKICAgIHRoaXMud29ya2VyUmVmLm9ubWVzc2FnZSA9IChldmVudCkgPT4gewogICAgICBpZiAoZXZlbnQuZGF0YS5ldmVudCA9PT0gImtlZXBBbGl2ZSIpIHsKICAgICAgICB0aGlzLnNlbmRIZWFydGJlYXQoKTsKICAgICAgfQogICAgfTsKICAgIHRoaXMud29ya2VyUmVmLnBvc3RNZXNzYWdlKHsKICAgICAgZXZlbnQ6ICJzdGFydCIsCiAgICAgIGludGVydmFsOiB0aGlzLmhlYXJ0YmVhdEludGVydmFsTXMKICAgIH0pOwogIH0KICAvKioKICAgKiBUZXJtaW5hdGUgdGhlIFdlYiBXb3JrZXIgYW5kIGNsZWFyIHRoZSByZWZlcmVuY2UKICAgKiBAaW50ZXJuYWwKICAgKi8KICBfdGVybWluYXRlV29ya2VyKCkgewogICAgaWYgKHRoaXMud29ya2VyUmVmKSB7CiAgICAgIHRoaXMubG9nKCJ3b3JrZXIiLCAidGVybWluYXRpbmcgd29ya2VyIik7CiAgICAgIHRoaXMud29ya2VyUmVmLnRlcm1pbmF0ZSgpOwogICAgICB0aGlzLndvcmtlclJlZiA9IHZvaWQgMDsKICAgIH0KICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIF9vbkNvbm5DbG9zZShldmVudCkgewogICAgdmFyIF9hOwogICAgdGhpcy5fc2V0Q29ubmVjdGlvblN0YXRlKCJkaXNjb25uZWN0ZWQiKTsKICAgIHRoaXMubG9nKCJ0cmFuc3BvcnQiLCAiY2xvc2UiLCBldmVudCk7CiAgICB0aGlzLl90cmlnZ2VyQ2hhbkVycm9yKCk7CiAgICB0aGlzLl9jbGVhclRpbWVyKCJoZWFydGJlYXQiKTsKICAgIGlmICghdGhpcy5fd2FzTWFudWFsRGlzY29ubmVjdCkgewogICAgICAoX2EgPSB0aGlzLnJlY29ubmVjdFRpbWVyKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Euc2NoZWR1bGVUaW1lb3V0KCk7CiAgICB9CiAgICB0aGlzLl90cmlnZ2VyU3RhdGVDYWxsYmFja3MoImNsb3NlIiwgZXZlbnQpOwogIH0KICAvKiogQGludGVybmFsICovCiAgX29uQ29ubkVycm9yKGVycm9yKSB7CiAgICB0aGlzLl9zZXRDb25uZWN0aW9uU3RhdGUoImRpc2Nvbm5lY3RlZCIpOwogICAgdGhpcy5sb2coInRyYW5zcG9ydCIsIGAke2Vycm9yfWApOwogICAgdGhpcy5fdHJpZ2dlckNoYW5FcnJvcigpOwogICAgdGhpcy5fdHJpZ2dlclN0YXRlQ2FsbGJhY2tzKCJlcnJvciIsIGVycm9yKTsKICAgIHRyeSB7CiAgICAgIHRoaXMuaGVhcnRiZWF0Q2FsbGJhY2soImVycm9yIik7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHRoaXMubG9nKCJlcnJvciIsICJlcnJvciBpbiBoZWFydGJlYXQgY2FsbGJhY2siLCBlKTsKICAgIH0KICB9CiAgLyoqIEBpbnRlcm5hbCAqLwogIF90cmlnZ2VyQ2hhbkVycm9yKCkgewogICAgdGhpcy5jaGFubmVscy5mb3JFYWNoKChjaGFubmVsKSA9PiBjaGFubmVsLl90cmlnZ2VyKENIQU5ORUxfRVZFTlRTLmVycm9yKSk7CiAgfQogIC8qKiBAaW50ZXJuYWwgKi8KICBfYXBwZW5kUGFyYW1zKHVybCwgcGFyYW1zKSB7CiAgICBpZiAoT2JqZWN0LmtleXMocGFyYW1zKS5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIHVybDsKICAgIH0KICAgIGNvbnN0IHByZWZpeCA9IHVybC5tYXRjaCgvXD8vKSA/ICImIiA6ICI/IjsKICAgIGNvbnN0IHF1ZXJ5ID0gbmV3IFVSTFNlYXJjaFBhcmFtcyhwYXJhbXMpOwogICAgcmV0dXJuIGAke3VybH0ke3ByZWZpeH0ke3F1ZXJ5fWA7CiAgfQogIF93b3JrZXJPYmplY3RVcmwodXJsKSB7CiAgICBsZXQgcmVzdWx0X3VybDsKICAgIGlmICh1cmwpIHsKICAgICAgcmVzdWx0X3VybCA9IHVybDsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbV09SS0VSX1NDUklQVF0sIHsgdHlwZTogImFwcGxpY2F0aW9uL2phdmFzY3JpcHQiIH0pOwogICAgICByZXN1bHRfdXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRfdXJsOwogIH0KICAvKioKICAgKiBTZXQgY29ubmVjdGlvbiBzdGF0ZSB3aXRoIHByb3BlciBzdGF0ZSBtYW5hZ2VtZW50CiAgICogQGludGVybmFsCiAgICovCiAgX3NldENvbm5lY3Rpb25TdGF0ZShzdGF0ZSwgbWFudWFsID0gZmFsc2UpIHsKICAgIHRoaXMuX2Nvbm5lY3Rpb25TdGF0ZSA9IHN0YXRlOwogICAgaWYgKHN0YXRlID09PSAiY29ubmVjdGluZyIpIHsKICAgICAgdGhpcy5fd2FzTWFudWFsRGlzY29ubmVjdCA9IGZhbHNlOwogICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gImRpc2Nvbm5lY3RpbmciKSB7CiAgICAgIHRoaXMuX3dhc01hbnVhbERpc2Nvbm5lY3QgPSBtYW51YWw7CiAgICB9CiAgfQogIC8qKgogICAqIFBlcmZvcm0gdGhlIGFjdHVhbCBhdXRoIG9wZXJhdGlvbgogICAqIEBpbnRlcm5hbAogICAqLwogIGFzeW5jIF9wZXJmb3JtQXV0aCh0b2tlbiA9IG51bGwpIHsKICAgIGxldCB0b2tlblRvU2VuZDsKICAgIGxldCBpc01hbnVhbFRva2VuID0gZmFsc2U7CiAgICBpZiAodG9rZW4pIHsKICAgICAgdG9rZW5Ub1NlbmQgPSB0b2tlbjsKICAgICAgaXNNYW51YWxUb2tlbiA9IHRydWU7CiAgICB9IGVsc2UgaWYgKHRoaXMuYWNjZXNzVG9rZW4pIHsKICAgICAgdHJ5IHsKICAgICAgICB0b2tlblRvU2VuZCA9IGF3YWl0IHRoaXMuYWNjZXNzVG9rZW4oKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHRoaXMubG9nKCJlcnJvciIsICJFcnJvciBmZXRjaGluZyBhY2Nlc3MgdG9rZW4gZnJvbSBjYWxsYmFjayIsIGUpOwogICAgICAgIHRva2VuVG9TZW5kID0gdGhpcy5hY2Nlc3NUb2tlblZhbHVlOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICB0b2tlblRvU2VuZCA9IHRoaXMuYWNjZXNzVG9rZW5WYWx1ZTsKICAgIH0KICAgIGlmIChpc01hbnVhbFRva2VuKSB7CiAgICAgIHRoaXMuX21hbnVhbGx5U2V0VG9rZW4gPSB0cnVlOwogICAgfSBlbHNlIGlmICh0aGlzLmFjY2Vzc1Rva2VuKSB7CiAgICAgIHRoaXMuX21hbnVhbGx5U2V0VG9rZW4gPSBmYWxzZTsKICAgIH0KICAgIGlmICh0aGlzLmFjY2Vzc1Rva2VuVmFsdWUgIT0gdG9rZW5Ub1NlbmQpIHsKICAgICAgdGhpcy5hY2Nlc3NUb2tlblZhbHVlID0gdG9rZW5Ub1NlbmQ7CiAgICAgIHRoaXMuY2hhbm5lbHMuZm9yRWFjaCgoY2hhbm5lbCkgPT4gewogICAgICAgIGNvbnN0IHBheWxvYWQgPSB7CiAgICAgICAgICBhY2Nlc3NfdG9rZW46IHRva2VuVG9TZW5kLAogICAgICAgICAgdmVyc2lvbjogREVGQVVMVF9WRVJTSU9OCiAgICAgICAgfTsKICAgICAgICB0b2tlblRvU2VuZCAmJiBjaGFubmVsLnVwZGF0ZUpvaW5QYXlsb2FkKHBheWxvYWQpOwogICAgICAgIGlmIChjaGFubmVsLmpvaW5lZE9uY2UgJiYgY2hhbm5lbC5faXNKb2luZWQoKSkgewogICAgICAgICAgY2hhbm5lbC5fcHVzaChDSEFOTkVMX0VWRU5UUy5hY2Nlc3NfdG9rZW4sIHsKICAgICAgICAgICAgYWNjZXNzX3Rva2VuOiB0b2tlblRvU2VuZAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CiAgLyoqCiAgICogV2FpdCBmb3IgYW55IGluLWZsaWdodCBhdXRoIG9wZXJhdGlvbnMgdG8gY29tcGxldGUKICAgKiBAaW50ZXJuYWwKICAgKi8KICBhc3luYyBfd2FpdEZvckF1dGhJZk5lZWRlZCgpIHsKICAgIGlmICh0aGlzLl9hdXRoUHJvbWlzZSkgewogICAgICBhd2FpdCB0aGlzLl9hdXRoUHJvbWlzZTsKICAgIH0KICB9CiAgLyoqCiAgICogU2FmZWx5IGNhbGwgc2V0QXV0aCB3aXRoIHN0YW5kYXJkaXplZCBlcnJvciBoYW5kbGluZwogICAqIEBpbnRlcm5hbAogICAqLwogIF9zZXRBdXRoU2FmZWx5KGNvbnRleHQgPSAiZ2VuZXJhbCIpIHsKICAgIGlmICghdGhpcy5faXNNYW51YWxUb2tlbigpKSB7CiAgICAgIHRoaXMuc2V0QXV0aCgpLmNhdGNoKChlKSA9PiB7CiAgICAgICAgdGhpcy5sb2coImVycm9yIiwgYEVycm9yIHNldHRpbmcgYXV0aCBpbiAke2NvbnRleHR9YCwgZSk7CiAgICAgIH0pOwogICAgfQogIH0KICAvKioKICAgKiBUcmlnZ2VyIHN0YXRlIGNoYW5nZSBjYWxsYmFja3Mgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcKICAgKiBAaW50ZXJuYWwKICAgKi8KICBfdHJpZ2dlclN0YXRlQ2FsbGJhY2tzKGV2ZW50LCBkYXRhKSB7CiAgICB0cnkgewogICAgICB0aGlzLnN0YXRlQ2hhbmdlQ2FsbGJhY2tzW2V2ZW50XS5mb3JFYWNoKChjYWxsYmFjaykgPT4gewogICAgICAgIHRyeSB7CiAgICAgICAgICBjYWxsYmFjayhkYXRhKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICB0aGlzLmxvZygiZXJyb3IiLCBgZXJyb3IgaW4gJHtldmVudH0gY2FsbGJhY2tgLCBlKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZSkgewogICAgICB0aGlzLmxvZygiZXJyb3IiLCBgZXJyb3IgdHJpZ2dlcmluZyAke2V2ZW50fSBjYWxsYmFja3NgLCBlKTsKICAgIH0KICB9CiAgLyoqCiAgICogU2V0dXAgcmVjb25uZWN0aW9uIHRpbWVyIHdpdGggcHJvcGVyIGNvbmZpZ3VyYXRpb24KICAgKiBAaW50ZXJuYWwKICAgKi8KICBfc2V0dXBSZWNvbm5lY3Rpb25UaW1lcigpIHsKICAgIHRoaXMucmVjb25uZWN0VGltZXIgPSBuZXcgVGltZXIoYXN5bmMgKCkgPT4gewogICAgICBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsKICAgICAgICBhd2FpdCB0aGlzLl93YWl0Rm9yQXV0aElmTmVlZGVkKCk7CiAgICAgICAgaWYgKCF0aGlzLmlzQ29ubmVjdGVkKCkpIHsKICAgICAgICAgIHRoaXMuY29ubmVjdCgpOwogICAgICAgIH0KICAgICAgfSwgQ09OTkVDVElPTl9USU1FT1VUUy5SRUNPTk5FQ1RfREVMQVkpOwogICAgfSwgdGhpcy5yZWNvbm5lY3RBZnRlck1zKTsKICB9CiAgLyoqCiAgICogSW5pdGlhbGl6ZSBjbGllbnQgb3B0aW9ucyB3aXRoIGRlZmF1bHRzCiAgICogQGludGVybmFsCiAgICovCiAgX2luaXRpYWxpemVPcHRpb25zKG9wdGlvbnMpIHsKICAgIHZhciBfYSwgX2IsIF9jLCBfZCwgX2UsIF9mLCBfZywgX2gsIF9qLCBfaywgX2wsIF9tOwogICAgdGhpcy50cmFuc3BvcnQgPSAoX2EgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMudHJhbnNwb3J0KSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBudWxsOwogICAgdGhpcy50aW1lb3V0ID0gKF9iID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnRpbWVvdXQpICE9PSBudWxsICYmIF9iICE9PSB2b2lkIDAgPyBfYiA6IERFRkFVTFRfVElNRU9VVDsKICAgIHRoaXMuaGVhcnRiZWF0SW50ZXJ2YWxNcyA9IChfYyA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5oZWFydGJlYXRJbnRlcnZhbE1zKSAhPT0gbnVsbCAmJiBfYyAhPT0gdm9pZCAwID8gX2MgOiBDT05ORUNUSU9OX1RJTUVPVVRTLkhFQVJUQkVBVF9JTlRFUlZBTDsKICAgIHRoaXMud29ya2VyID0gKF9kID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLndvcmtlcikgIT09IG51bGwgJiYgX2QgIT09IHZvaWQgMCA/IF9kIDogZmFsc2U7CiAgICB0aGlzLmFjY2Vzc1Rva2VuID0gKF9lID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmFjY2Vzc1Rva2VuKSAhPT0gbnVsbCAmJiBfZSAhPT0gdm9pZCAwID8gX2UgOiBudWxsOwogICAgdGhpcy5oZWFydGJlYXRDYWxsYmFjayA9IChfZiA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5oZWFydGJlYXRDYWxsYmFjaykgIT09IG51bGwgJiYgX2YgIT09IHZvaWQgMCA/IF9mIDogbm9vcDU7CiAgICB0aGlzLnZzbiA9IChfZyA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy52c24pICE9PSBudWxsICYmIF9nICE9PSB2b2lkIDAgPyBfZyA6IERFRkFVTFRfVlNOOwogICAgaWYgKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5wYXJhbXMpCiAgICAgIHRoaXMucGFyYW1zID0gb3B0aW9ucy5wYXJhbXM7CiAgICBpZiAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmxvZ2dlcikKICAgICAgdGhpcy5sb2dnZXIgPSBvcHRpb25zLmxvZ2dlcjsKICAgIGlmICgob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmxvZ0xldmVsKSB8fCAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmxvZ19sZXZlbCkpIHsKICAgICAgdGhpcy5sb2dMZXZlbCA9IG9wdGlvbnMubG9nTGV2ZWwgfHwgb3B0aW9ucy5sb2dfbGV2ZWw7CiAgICAgIHRoaXMucGFyYW1zID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCB0aGlzLnBhcmFtcyksIHsgbG9nX2xldmVsOiB0aGlzLmxvZ0xldmVsIH0pOwogICAgfQogICAgdGhpcy5yZWNvbm5lY3RBZnRlck1zID0gKF9oID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnJlY29ubmVjdEFmdGVyTXMpICE9PSBudWxsICYmIF9oICE9PSB2b2lkIDAgPyBfaCA6ICh0cmllcykgPT4gewogICAgICByZXR1cm4gUkVDT05ORUNUX0lOVEVSVkFMU1t0cmllcyAtIDFdIHx8IERFRkFVTFRfUkVDT05ORUNUX0ZBTExCQUNLOwogICAgfTsKICAgIHN3aXRjaCAodGhpcy52c24pIHsKICAgICAgY2FzZSBWU05fMV8wXzA6CiAgICAgICAgdGhpcy5lbmNvZGUgPSAoX2ogPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuZW5jb2RlKSAhPT0gbnVsbCAmJiBfaiAhPT0gdm9pZCAwID8gX2ogOiAocGF5bG9hZCwgY2FsbGJhY2spID0+IHsKICAgICAgICAgIHJldHVybiBjYWxsYmFjayhKU09OLnN0cmluZ2lmeShwYXlsb2FkKSk7CiAgICAgICAgfTsKICAgICAgICB0aGlzLmRlY29kZSA9IChfayA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5kZWNvZGUpICE9PSBudWxsICYmIF9rICE9PSB2b2lkIDAgPyBfayA6IChwYXlsb2FkLCBjYWxsYmFjaykgPT4gewogICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKEpTT04ucGFyc2UocGF5bG9hZCkpOwogICAgICAgIH07CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgVlNOXzJfMF8wOgogICAgICAgIHRoaXMuZW5jb2RlID0gKF9sID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmVuY29kZSkgIT09IG51bGwgJiYgX2wgIT09IHZvaWQgMCA/IF9sIDogdGhpcy5zZXJpYWxpemVyLmVuY29kZS5iaW5kKHRoaXMuc2VyaWFsaXplcik7CiAgICAgICAgdGhpcy5kZWNvZGUgPSAoX20gPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuZGVjb2RlKSAhPT0gbnVsbCAmJiBfbSAhPT0gdm9pZCAwID8gX20gOiB0aGlzLnNlcmlhbGl6ZXIuZGVjb2RlLmJpbmQodGhpcy5zZXJpYWxpemVyKTsKICAgICAgICBicmVhazsKICAgICAgZGVmYXVsdDoKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuc3VwcG9ydGVkIHNlcmlhbGl6ZXIgdmVyc2lvbjogJHt0aGlzLnZzbn1gKTsKICAgIH0KICAgIGlmICh0aGlzLndvcmtlcikgewogICAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgIXdpbmRvdy5Xb3JrZXIpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIldlYiBXb3JrZXIgaXMgbm90IHN1cHBvcnRlZCIpOwogICAgICB9CiAgICAgIHRoaXMud29ya2VyVXJsID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLndvcmtlclVybDsKICAgIH0KICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vaWNlYmVyZy1qc0AwLjguMS9ub2RlX21vZHVsZXMvaWNlYmVyZy1qcy9kaXN0L2luZGV4Lm1qcwp2YXIgSWNlYmVyZ0Vycm9yID0gY2xhc3MgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSwgb3B0cykgewogICAgc3VwZXIobWVzc2FnZSk7CiAgICB0aGlzLm5hbWUgPSAiSWNlYmVyZ0Vycm9yIjsKICAgIHRoaXMuc3RhdHVzID0gb3B0cy5zdGF0dXM7CiAgICB0aGlzLmljZWJlcmdUeXBlID0gb3B0cy5pY2ViZXJnVHlwZTsKICAgIHRoaXMuaWNlYmVyZ0NvZGUgPSBvcHRzLmljZWJlcmdDb2RlOwogICAgdGhpcy5kZXRhaWxzID0gb3B0cy5kZXRhaWxzOwogICAgdGhpcy5pc0NvbW1pdFN0YXRlVW5rbm93biA9IG9wdHMuaWNlYmVyZ1R5cGUgPT09ICJDb21taXRTdGF0ZVVua25vd25FeGNlcHRpb24iIHx8IFs1MDAsIDUwMiwgNTA0XS5pbmNsdWRlcyhvcHRzLnN0YXR1cykgJiYgb3B0cy5pY2ViZXJnVHlwZT8uaW5jbHVkZXMoIkNvbW1pdFN0YXRlIikgPT09IHRydWU7CiAgfQogIC8qKgogICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgZXJyb3IgaXMgYSA0MDQgTm90IEZvdW5kIGVycm9yLgogICAqLwogIGlzTm90Rm91bmQoKSB7CiAgICByZXR1cm4gdGhpcy5zdGF0dXMgPT09IDQwNDsKICB9CiAgLyoqCiAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBlcnJvciBpcyBhIDQwOSBDb25mbGljdCBlcnJvci4KICAgKi8KICBpc0NvbmZsaWN0KCkgewogICAgcmV0dXJuIHRoaXMuc3RhdHVzID09PSA0MDk7CiAgfQogIC8qKgogICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgZXJyb3IgaXMgYSA0MTkgQXV0aGVudGljYXRpb24gVGltZW91dCBlcnJvci4KICAgKi8KICBpc0F1dGhlbnRpY2F0aW9uVGltZW91dCgpIHsKICAgIHJldHVybiB0aGlzLnN0YXR1cyA9PT0gNDE5OwogIH0KfTsKZnVuY3Rpb24gYnVpbGRVcmwoYmFzZVVybCwgcGF0aDIsIHF1ZXJ5KSB7CiAgY29uc3QgdXJsID0gbmV3IFVSTChwYXRoMiwgYmFzZVVybCk7CiAgaWYgKHF1ZXJ5KSB7CiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhxdWVyeSkpIHsKICAgICAgaWYgKHZhbHVlICE9PSB2b2lkIDApIHsKICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLnNldChrZXksIHZhbHVlKTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gdXJsLnRvU3RyaW5nKCk7Cn0KYXN5bmMgZnVuY3Rpb24gYnVpbGRBdXRoSGVhZGVycyhhdXRoKSB7CiAgaWYgKCFhdXRoIHx8IGF1dGgudHlwZSA9PT0gIm5vbmUiKSB7CiAgICByZXR1cm4ge307CiAgfQogIGlmIChhdXRoLnR5cGUgPT09ICJiZWFyZXIiKSB7CiAgICByZXR1cm4geyBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7YXV0aC50b2tlbn1gIH07CiAgfQogIGlmIChhdXRoLnR5cGUgPT09ICJoZWFkZXIiKSB7CiAgICByZXR1cm4geyBbYXV0aC5uYW1lXTogYXV0aC52YWx1ZSB9OwogIH0KICBpZiAoYXV0aC50eXBlID09PSAiY3VzdG9tIikgewogICAgcmV0dXJuIGF3YWl0IGF1dGguZ2V0SGVhZGVycygpOwogIH0KICByZXR1cm4ge307Cn0KZnVuY3Rpb24gY3JlYXRlRmV0Y2hDbGllbnQob3B0aW9ucykgewogIGNvbnN0IGZldGNoRm4gPSBvcHRpb25zLmZldGNoSW1wbCA/PyBnbG9iYWxUaGlzLmZldGNoOwogIHJldHVybiB7CiAgICBhc3luYyByZXF1ZXN0KHsKICAgICAgbWV0aG9kLAogICAgICBwYXRoOiBwYXRoMiwKICAgICAgcXVlcnksCiAgICAgIGJvZHksCiAgICAgIGhlYWRlcnMKICAgIH0pIHsKICAgICAgY29uc3QgdXJsID0gYnVpbGRVcmwob3B0aW9ucy5iYXNlVXJsLCBwYXRoMiwgcXVlcnkpOwogICAgICBjb25zdCBhdXRoSGVhZGVycyA9IGF3YWl0IGJ1aWxkQXV0aEhlYWRlcnMob3B0aW9ucy5hdXRoKTsKICAgICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2hGbih1cmwsIHsKICAgICAgICBtZXRob2QsCiAgICAgICAgaGVhZGVyczogewogICAgICAgICAgLi4uYm9keSA/IHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9IDoge30sCiAgICAgICAgICAuLi5hdXRoSGVhZGVycywKICAgICAgICAgIC4uLmhlYWRlcnMKICAgICAgICB9LAogICAgICAgIGJvZHk6IGJvZHkgPyBKU09OLnN0cmluZ2lmeShib2R5KSA6IHZvaWQgMAogICAgICB9KTsKICAgICAgY29uc3QgdGV4dCA9IGF3YWl0IHJlcy50ZXh0KCk7CiAgICAgIGNvbnN0IGlzSnNvbiA9IChyZXMuaGVhZGVycy5nZXQoImNvbnRlbnQtdHlwZSIpIHx8ICIiKS5pbmNsdWRlcygiYXBwbGljYXRpb24vanNvbiIpOwogICAgICBjb25zdCBkYXRhID0gaXNKc29uICYmIHRleHQgPyBKU09OLnBhcnNlKHRleHQpIDogdGV4dDsKICAgICAgaWYgKCFyZXMub2spIHsKICAgICAgICBjb25zdCBlcnJCb2R5ID0gaXNKc29uID8gZGF0YSA6IHZvaWQgMDsKICAgICAgICBjb25zdCBlcnJvckRldGFpbCA9IGVyckJvZHk/LmVycm9yOwogICAgICAgIHRocm93IG5ldyBJY2ViZXJnRXJyb3IoCiAgICAgICAgICBlcnJvckRldGFpbD8ubWVzc2FnZSA/PyBgUmVxdWVzdCBmYWlsZWQgd2l0aCBzdGF0dXMgJHtyZXMuc3RhdHVzfWAsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0YXR1czogcmVzLnN0YXR1cywKICAgICAgICAgICAgaWNlYmVyZ1R5cGU6IGVycm9yRGV0YWlsPy50eXBlLAogICAgICAgICAgICBpY2ViZXJnQ29kZTogZXJyb3JEZXRhaWw/LmNvZGUsCiAgICAgICAgICAgIGRldGFpbHM6IGVyckJvZHkKICAgICAgICAgIH0KICAgICAgICApOwogICAgICB9CiAgICAgIHJldHVybiB7IHN0YXR1czogcmVzLnN0YXR1cywgaGVhZGVyczogcmVzLmhlYWRlcnMsIGRhdGEgfTsKICAgIH0KICB9Owp9CmZ1bmN0aW9uIG5hbWVzcGFjZVRvUGF0aChuYW1lc3BhY2UpIHsKICByZXR1cm4gbmFtZXNwYWNlLmpvaW4oIh8iKTsKfQp2YXIgTmFtZXNwYWNlT3BlcmF0aW9ucyA9IGNsYXNzIHsKICBjb25zdHJ1Y3RvcihjbGllbnQsIHByZWZpeCA9ICIiKSB7CiAgICB0aGlzLmNsaWVudCA9IGNsaWVudDsKICAgIHRoaXMucHJlZml4ID0gcHJlZml4OwogIH0KICBhc3luYyBsaXN0TmFtZXNwYWNlcyhwYXJlbnQpIHsKICAgIGNvbnN0IHF1ZXJ5ID0gcGFyZW50ID8geyBwYXJlbnQ6IG5hbWVzcGFjZVRvUGF0aChwYXJlbnQubmFtZXNwYWNlKSB9IDogdm9pZCAwOwogICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNsaWVudC5yZXF1ZXN0KHsKICAgICAgbWV0aG9kOiAiR0VUIiwKICAgICAgcGF0aDogYCR7dGhpcy5wcmVmaXh9L25hbWVzcGFjZXNgLAogICAgICBxdWVyeQogICAgfSk7CiAgICByZXR1cm4gcmVzcG9uc2UuZGF0YS5uYW1lc3BhY2VzLm1hcCgobnMpID0+ICh7IG5hbWVzcGFjZTogbnMgfSkpOwogIH0KICBhc3luYyBjcmVhdGVOYW1lc3BhY2UoaWQsIG1ldGFkYXRhKSB7CiAgICBjb25zdCByZXF1ZXN0ID0gewogICAgICBuYW1lc3BhY2U6IGlkLm5hbWVzcGFjZSwKICAgICAgcHJvcGVydGllczogbWV0YWRhdGE/LnByb3BlcnRpZXMKICAgIH07CiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuY2xpZW50LnJlcXVlc3QoewogICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgcGF0aDogYCR7dGhpcy5wcmVmaXh9L25hbWVzcGFjZXNgLAogICAgICBib2R5OiByZXF1ZXN0CiAgICB9KTsKICAgIHJldHVybiByZXNwb25zZS5kYXRhOwogIH0KICBhc3luYyBkcm9wTmFtZXNwYWNlKGlkKSB7CiAgICBhd2FpdCB0aGlzLmNsaWVudC5yZXF1ZXN0KHsKICAgICAgbWV0aG9kOiAiREVMRVRFIiwKICAgICAgcGF0aDogYCR7dGhpcy5wcmVmaXh9L25hbWVzcGFjZXMvJHtuYW1lc3BhY2VUb1BhdGgoaWQubmFtZXNwYWNlKX1gCiAgICB9KTsKICB9CiAgYXN5bmMgbG9hZE5hbWVzcGFjZU1ldGFkYXRhKGlkKSB7CiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuY2xpZW50LnJlcXVlc3QoewogICAgICBtZXRob2Q6ICJHRVQiLAogICAgICBwYXRoOiBgJHt0aGlzLnByZWZpeH0vbmFtZXNwYWNlcy8ke25hbWVzcGFjZVRvUGF0aChpZC5uYW1lc3BhY2UpfWAKICAgIH0pOwogICAgcmV0dXJuIHsKICAgICAgcHJvcGVydGllczogcmVzcG9uc2UuZGF0YS5wcm9wZXJ0aWVzCiAgICB9OwogIH0KICBhc3luYyBuYW1lc3BhY2VFeGlzdHMoaWQpIHsKICAgIHRyeSB7CiAgICAgIGF3YWl0IHRoaXMuY2xpZW50LnJlcXVlc3QoewogICAgICAgIG1ldGhvZDogIkhFQUQiLAogICAgICAgIHBhdGg6IGAke3RoaXMucHJlZml4fS9uYW1lc3BhY2VzLyR7bmFtZXNwYWNlVG9QYXRoKGlkLm5hbWVzcGFjZSl9YAogICAgICB9KTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBJY2ViZXJnRXJyb3IgJiYgZXJyb3Iuc3RhdHVzID09PSA0MDQpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIGFzeW5jIGNyZWF0ZU5hbWVzcGFjZUlmTm90RXhpc3RzKGlkLCBtZXRhZGF0YSkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuY3JlYXRlTmFtZXNwYWNlKGlkLCBtZXRhZGF0YSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBJY2ViZXJnRXJyb3IgJiYgZXJyb3Iuc3RhdHVzID09PSA0MDkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQp9OwpmdW5jdGlvbiBuYW1lc3BhY2VUb1BhdGgyKG5hbWVzcGFjZSkgewogIHJldHVybiBuYW1lc3BhY2Uuam9pbigiHyIpOwp9CnZhciBUYWJsZU9wZXJhdGlvbnMgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY2xpZW50LCBwcmVmaXggPSAiIiwgYWNjZXNzRGVsZWdhdGlvbikgewogICAgdGhpcy5jbGllbnQgPSBjbGllbnQ7CiAgICB0aGlzLnByZWZpeCA9IHByZWZpeDsKICAgIHRoaXMuYWNjZXNzRGVsZWdhdGlvbiA9IGFjY2Vzc0RlbGVnYXRpb247CiAgfQogIGFzeW5jIGxpc3RUYWJsZXMobmFtZXNwYWNlKSB7CiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuY2xpZW50LnJlcXVlc3QoewogICAgICBtZXRob2Q6ICJHRVQiLAogICAgICBwYXRoOiBgJHt0aGlzLnByZWZpeH0vbmFtZXNwYWNlcy8ke25hbWVzcGFjZVRvUGF0aDIobmFtZXNwYWNlLm5hbWVzcGFjZSl9L3RhYmxlc2AKICAgIH0pOwogICAgcmV0dXJuIHJlc3BvbnNlLmRhdGEuaWRlbnRpZmllcnM7CiAgfQogIGFzeW5jIGNyZWF0ZVRhYmxlKG5hbWVzcGFjZSwgcmVxdWVzdCkgewogICAgY29uc3QgaGVhZGVycyA9IHt9OwogICAgaWYgKHRoaXMuYWNjZXNzRGVsZWdhdGlvbikgewogICAgICBoZWFkZXJzWyJYLUljZWJlcmctQWNjZXNzLURlbGVnYXRpb24iXSA9IHRoaXMuYWNjZXNzRGVsZWdhdGlvbjsKICAgIH0KICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5jbGllbnQucmVxdWVzdCh7CiAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICBwYXRoOiBgJHt0aGlzLnByZWZpeH0vbmFtZXNwYWNlcy8ke25hbWVzcGFjZVRvUGF0aDIobmFtZXNwYWNlLm5hbWVzcGFjZSl9L3RhYmxlc2AsCiAgICAgIGJvZHk6IHJlcXVlc3QsCiAgICAgIGhlYWRlcnMKICAgIH0pOwogICAgcmV0dXJuIHJlc3BvbnNlLmRhdGEubWV0YWRhdGE7CiAgfQogIGFzeW5jIHVwZGF0ZVRhYmxlKGlkLCByZXF1ZXN0KSB7CiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuY2xpZW50LnJlcXVlc3QoewogICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgcGF0aDogYCR7dGhpcy5wcmVmaXh9L25hbWVzcGFjZXMvJHtuYW1lc3BhY2VUb1BhdGgyKGlkLm5hbWVzcGFjZSl9L3RhYmxlcy8ke2lkLm5hbWV9YCwKICAgICAgYm9keTogcmVxdWVzdAogICAgfSk7CiAgICByZXR1cm4gewogICAgICAibWV0YWRhdGEtbG9jYXRpb24iOiByZXNwb25zZS5kYXRhWyJtZXRhZGF0YS1sb2NhdGlvbiJdLAogICAgICBtZXRhZGF0YTogcmVzcG9uc2UuZGF0YS5tZXRhZGF0YQogICAgfTsKICB9CiAgYXN5bmMgZHJvcFRhYmxlKGlkLCBvcHRpb25zKSB7CiAgICBhd2FpdCB0aGlzLmNsaWVudC5yZXF1ZXN0KHsKICAgICAgbWV0aG9kOiAiREVMRVRFIiwKICAgICAgcGF0aDogYCR7dGhpcy5wcmVmaXh9L25hbWVzcGFjZXMvJHtuYW1lc3BhY2VUb1BhdGgyKGlkLm5hbWVzcGFjZSl9L3RhYmxlcy8ke2lkLm5hbWV9YCwKICAgICAgcXVlcnk6IHsgcHVyZ2VSZXF1ZXN0ZWQ6IFN0cmluZyhvcHRpb25zPy5wdXJnZSA/PyBmYWxzZSkgfQogICAgfSk7CiAgfQogIGFzeW5jIGxvYWRUYWJsZShpZCkgewogICAgY29uc3QgaGVhZGVycyA9IHt9OwogICAgaWYgKHRoaXMuYWNjZXNzRGVsZWdhdGlvbikgewogICAgICBoZWFkZXJzWyJYLUljZWJlcmctQWNjZXNzLURlbGVnYXRpb24iXSA9IHRoaXMuYWNjZXNzRGVsZWdhdGlvbjsKICAgIH0KICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5jbGllbnQucmVxdWVzdCh7CiAgICAgIG1ldGhvZDogIkdFVCIsCiAgICAgIHBhdGg6IGAke3RoaXMucHJlZml4fS9uYW1lc3BhY2VzLyR7bmFtZXNwYWNlVG9QYXRoMihpZC5uYW1lc3BhY2UpfS90YWJsZXMvJHtpZC5uYW1lfWAsCiAgICAgIGhlYWRlcnMKICAgIH0pOwogICAgcmV0dXJuIHJlc3BvbnNlLmRhdGEubWV0YWRhdGE7CiAgfQogIGFzeW5jIHRhYmxlRXhpc3RzKGlkKSB7CiAgICBjb25zdCBoZWFkZXJzID0ge307CiAgICBpZiAodGhpcy5hY2Nlc3NEZWxlZ2F0aW9uKSB7CiAgICAgIGhlYWRlcnNbIlgtSWNlYmVyZy1BY2Nlc3MtRGVsZWdhdGlvbiJdID0gdGhpcy5hY2Nlc3NEZWxlZ2F0aW9uOwogICAgfQogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5jbGllbnQucmVxdWVzdCh7CiAgICAgICAgbWV0aG9kOiAiSEVBRCIsCiAgICAgICAgcGF0aDogYCR7dGhpcy5wcmVmaXh9L25hbWVzcGFjZXMvJHtuYW1lc3BhY2VUb1BhdGgyKGlkLm5hbWVzcGFjZSl9L3RhYmxlcy8ke2lkLm5hbWV9YCwKICAgICAgICBoZWFkZXJzCiAgICAgIH0pOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEljZWJlcmdFcnJvciAmJiBlcnJvci5zdGF0dXMgPT09IDQwNCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgYXN5bmMgY3JlYXRlVGFibGVJZk5vdEV4aXN0cyhuYW1lc3BhY2UsIHJlcXVlc3QpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmNyZWF0ZVRhYmxlKG5hbWVzcGFjZSwgcmVxdWVzdCk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBJY2ViZXJnRXJyb3IgJiYgZXJyb3Iuc3RhdHVzID09PSA0MDkpIHsKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5sb2FkVGFibGUoeyBuYW1lc3BhY2U6IG5hbWVzcGFjZS5uYW1lc3BhY2UsIG5hbWU6IHJlcXVlc3QubmFtZSB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9Cn07CnZhciBJY2ViZXJnUmVzdENhdGFsb2cgPSBjbGFzcyB7CiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyBJY2ViZXJnIFJFU1QgQ2F0YWxvZyBjbGllbnQuCiAgICoKICAgKiBAcGFyYW0gb3B0aW9ucyAtIENvbmZpZ3VyYXRpb24gb3B0aW9ucyBmb3IgdGhlIGNhdGFsb2cgY2xpZW50CiAgICovCiAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgbGV0IHByZWZpeCA9ICJ2MSI7CiAgICBpZiAob3B0aW9ucy5jYXRhbG9nTmFtZSkgewogICAgICBwcmVmaXggKz0gYC8ke29wdGlvbnMuY2F0YWxvZ05hbWV9YDsKICAgIH0KICAgIGNvbnN0IGJhc2VVcmwgPSBvcHRpb25zLmJhc2VVcmwuZW5kc1dpdGgoIi8iKSA/IG9wdGlvbnMuYmFzZVVybCA6IGAke29wdGlvbnMuYmFzZVVybH0vYDsKICAgIHRoaXMuY2xpZW50ID0gY3JlYXRlRmV0Y2hDbGllbnQoewogICAgICBiYXNlVXJsLAogICAgICBhdXRoOiBvcHRpb25zLmF1dGgsCiAgICAgIGZldGNoSW1wbDogb3B0aW9ucy5mZXRjaAogICAgfSk7CiAgICB0aGlzLmFjY2Vzc0RlbGVnYXRpb24gPSBvcHRpb25zLmFjY2Vzc0RlbGVnYXRpb24/LmpvaW4oIiwiKTsKICAgIHRoaXMubmFtZXNwYWNlT3BzID0gbmV3IE5hbWVzcGFjZU9wZXJhdGlvbnModGhpcy5jbGllbnQsIHByZWZpeCk7CiAgICB0aGlzLnRhYmxlT3BzID0gbmV3IFRhYmxlT3BlcmF0aW9ucyh0aGlzLmNsaWVudCwgcHJlZml4LCB0aGlzLmFjY2Vzc0RlbGVnYXRpb24pOwogIH0KICAvKioKICAgKiBMaXN0cyBhbGwgbmFtZXNwYWNlcyBpbiB0aGUgY2F0YWxvZy4KICAgKgogICAqIEBwYXJhbSBwYXJlbnQgLSBPcHRpb25hbCBwYXJlbnQgbmFtZXNwYWNlIHRvIGxpc3QgY2hpbGRyZW4gdW5kZXIKICAgKiBAcmV0dXJucyBBcnJheSBvZiBuYW1lc3BhY2UgaWRlbnRpZmllcnMKICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHlwZXNjcmlwdAogICAqIC8vIExpc3QgYWxsIHRvcC1sZXZlbCBuYW1lc3BhY2VzCiAgICogY29uc3QgbmFtZXNwYWNlcyA9IGF3YWl0IGNhdGFsb2cubGlzdE5hbWVzcGFjZXMoKTsKICAgKgogICAqIC8vIExpc3QgbmFtZXNwYWNlcyB1bmRlciBhIHBhcmVudAogICAqIGNvbnN0IGNoaWxkcmVuID0gYXdhaXQgY2F0YWxvZy5saXN0TmFtZXNwYWNlcyh7IG5hbWVzcGFjZTogWydhbmFseXRpY3MnXSB9KTsKICAgKiBgYGAKICAgKi8KICBhc3luYyBsaXN0TmFtZXNwYWNlcyhwYXJlbnQpIHsKICAgIHJldHVybiB0aGlzLm5hbWVzcGFjZU9wcy5saXN0TmFtZXNwYWNlcyhwYXJlbnQpOwogIH0KICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IG5hbWVzcGFjZSBpbiB0aGUgY2F0YWxvZy4KICAgKgogICAqIEBwYXJhbSBpZCAtIE5hbWVzcGFjZSBpZGVudGlmaWVyIHRvIGNyZWF0ZQogICAqIEBwYXJhbSBtZXRhZGF0YSAtIE9wdGlvbmFsIG1ldGFkYXRhIHByb3BlcnRpZXMgZm9yIHRoZSBuYW1lc3BhY2UKICAgKiBAcmV0dXJucyBSZXNwb25zZSBjb250YWluaW5nIHRoZSBjcmVhdGVkIG5hbWVzcGFjZSBhbmQgaXRzIHByb3BlcnRpZXMKICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHlwZXNjcmlwdAogICAqIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY2F0YWxvZy5jcmVhdGVOYW1lc3BhY2UoCiAgICogICB7IG5hbWVzcGFjZTogWydhbmFseXRpY3MnXSB9LAogICAqICAgeyBwcm9wZXJ0aWVzOiB7IG93bmVyOiAnZGF0YS10ZWFtJyB9IH0KICAgKiApOwogICAqIGNvbnNvbGUubG9nKHJlc3BvbnNlLm5hbWVzcGFjZSk7IC8vIFsnYW5hbHl0aWNzJ10KICAgKiBjb25zb2xlLmxvZyhyZXNwb25zZS5wcm9wZXJ0aWVzKTsgLy8geyBvd25lcjogJ2RhdGEtdGVhbScsIC4uLiB9CiAgICogYGBgCiAgICovCiAgYXN5bmMgY3JlYXRlTmFtZXNwYWNlKGlkLCBtZXRhZGF0YSkgewogICAgcmV0dXJuIHRoaXMubmFtZXNwYWNlT3BzLmNyZWF0ZU5hbWVzcGFjZShpZCwgbWV0YWRhdGEpOwogIH0KICAvKioKICAgKiBEcm9wcyBhIG5hbWVzcGFjZSBmcm9tIHRoZSBjYXRhbG9nLgogICAqCiAgICogVGhlIG5hbWVzcGFjZSBtdXN0IGJlIGVtcHR5IChjb250YWluIG5vIHRhYmxlcykgYmVmb3JlIGl0IGNhbiBiZSBkcm9wcGVkLgogICAqCiAgICogQHBhcmFtIGlkIC0gTmFtZXNwYWNlIGlkZW50aWZpZXIgdG8gZHJvcAogICAqCiAgICogQGV4YW1wbGUKICAgKiBgYGB0eXBlc2NyaXB0CiAgICogYXdhaXQgY2F0YWxvZy5kcm9wTmFtZXNwYWNlKHsgbmFtZXNwYWNlOiBbJ2FuYWx5dGljcyddIH0pOwogICAqIGBgYAogICAqLwogIGFzeW5jIGRyb3BOYW1lc3BhY2UoaWQpIHsKICAgIGF3YWl0IHRoaXMubmFtZXNwYWNlT3BzLmRyb3BOYW1lc3BhY2UoaWQpOwogIH0KICAvKioKICAgKiBMb2FkcyBtZXRhZGF0YSBmb3IgYSBuYW1lc3BhY2UuCiAgICoKICAgKiBAcGFyYW0gaWQgLSBOYW1lc3BhY2UgaWRlbnRpZmllciB0byBsb2FkCiAgICogQHJldHVybnMgTmFtZXNwYWNlIG1ldGFkYXRhIGluY2x1ZGluZyBwcm9wZXJ0aWVzCiAgICoKICAgKiBAZXhhbXBsZQogICAqIGBgYHR5cGVzY3JpcHQKICAgKiBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IGNhdGFsb2cubG9hZE5hbWVzcGFjZU1ldGFkYXRhKHsgbmFtZXNwYWNlOiBbJ2FuYWx5dGljcyddIH0pOwogICAqIGNvbnNvbGUubG9nKG1ldGFkYXRhLnByb3BlcnRpZXMpOwogICAqIGBgYAogICAqLwogIGFzeW5jIGxvYWROYW1lc3BhY2VNZXRhZGF0YShpZCkgewogICAgcmV0dXJuIHRoaXMubmFtZXNwYWNlT3BzLmxvYWROYW1lc3BhY2VNZXRhZGF0YShpZCk7CiAgfQogIC8qKgogICAqIExpc3RzIGFsbCB0YWJsZXMgaW4gYSBuYW1lc3BhY2UuCiAgICoKICAgKiBAcGFyYW0gbmFtZXNwYWNlIC0gTmFtZXNwYWNlIGlkZW50aWZpZXIgdG8gbGlzdCB0YWJsZXMgZnJvbQogICAqIEByZXR1cm5zIEFycmF5IG9mIHRhYmxlIGlkZW50aWZpZXJzCiAgICoKICAgKiBAZXhhbXBsZQogICAqIGBgYHR5cGVzY3JpcHQKICAgKiBjb25zdCB0YWJsZXMgPSBhd2FpdCBjYXRhbG9nLmxpc3RUYWJsZXMoeyBuYW1lc3BhY2U6IFsnYW5hbHl0aWNzJ10gfSk7CiAgICogY29uc29sZS5sb2codGFibGVzKTsgLy8gW3sgbmFtZXNwYWNlOiBbJ2FuYWx5dGljcyddLCBuYW1lOiAnZXZlbnRzJyB9LCAuLi5dCiAgICogYGBgCiAgICovCiAgYXN5bmMgbGlzdFRhYmxlcyhuYW1lc3BhY2UpIHsKICAgIHJldHVybiB0aGlzLnRhYmxlT3BzLmxpc3RUYWJsZXMobmFtZXNwYWNlKTsKICB9CiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyB0YWJsZSBpbiB0aGUgY2F0YWxvZy4KICAgKgogICAqIEBwYXJhbSBuYW1lc3BhY2UgLSBOYW1lc3BhY2UgdG8gY3JlYXRlIHRoZSB0YWJsZSBpbgogICAqIEBwYXJhbSByZXF1ZXN0IC0gVGFibGUgY3JlYXRpb24gcmVxdWVzdCBpbmNsdWRpbmcgbmFtZSwgc2NoZW1hLCBwYXJ0aXRpb24gc3BlYywgZXRjLgogICAqIEByZXR1cm5zIFRhYmxlIG1ldGFkYXRhIGZvciB0aGUgY3JlYXRlZCB0YWJsZQogICAqCiAgICogQGV4YW1wbGUKICAgKiBgYGB0eXBlc2NyaXB0CiAgICogY29uc3QgbWV0YWRhdGEgPSBhd2FpdCBjYXRhbG9nLmNyZWF0ZVRhYmxlKAogICAqICAgeyBuYW1lc3BhY2U6IFsnYW5hbHl0aWNzJ10gfSwKICAgKiAgIHsKICAgKiAgICAgbmFtZTogJ2V2ZW50cycsCiAgICogICAgIHNjaGVtYTogewogICAqICAgICAgIHR5cGU6ICdzdHJ1Y3QnLAogICAqICAgICAgIGZpZWxkczogWwogICAqICAgICAgICAgeyBpZDogMSwgbmFtZTogJ2lkJywgdHlwZTogJ2xvbmcnLCByZXF1aXJlZDogdHJ1ZSB9LAogICAqICAgICAgICAgeyBpZDogMiwgbmFtZTogJ3RpbWVzdGFtcCcsIHR5cGU6ICd0aW1lc3RhbXAnLCByZXF1aXJlZDogdHJ1ZSB9CiAgICogICAgICAgXSwKICAgKiAgICAgICAnc2NoZW1hLWlkJzogMAogICAqICAgICB9LAogICAqICAgICAncGFydGl0aW9uLXNwZWMnOiB7CiAgICogICAgICAgJ3NwZWMtaWQnOiAwLAogICAqICAgICAgIGZpZWxkczogWwogICAqICAgICAgICAgeyBzb3VyY2VfaWQ6IDIsIGZpZWxkX2lkOiAxMDAwLCBuYW1lOiAndHNfZGF5JywgdHJhbnNmb3JtOiAnZGF5JyB9CiAgICogICAgICAgXQogICAqICAgICB9CiAgICogICB9CiAgICogKTsKICAgKiBgYGAKICAgKi8KICBhc3luYyBjcmVhdGVUYWJsZShuYW1lc3BhY2UsIHJlcXVlc3QpIHsKICAgIHJldHVybiB0aGlzLnRhYmxlT3BzLmNyZWF0ZVRhYmxlKG5hbWVzcGFjZSwgcmVxdWVzdCk7CiAgfQogIC8qKgogICAqIFVwZGF0ZXMgYW4gZXhpc3RpbmcgdGFibGUncyBtZXRhZGF0YS4KICAgKgogICAqIENhbiB1cGRhdGUgdGhlIHNjaGVtYSwgcGFydGl0aW9uIHNwZWMsIG9yIHByb3BlcnRpZXMgb2YgYSB0YWJsZS4KICAgKgogICAqIEBwYXJhbSBpZCAtIFRhYmxlIGlkZW50aWZpZXIgdG8gdXBkYXRlCiAgICogQHBhcmFtIHJlcXVlc3QgLSBVcGRhdGUgcmVxdWVzdCB3aXRoIGZpZWxkcyB0byBtb2RpZnkKICAgKiBAcmV0dXJucyBSZXNwb25zZSBjb250YWluaW5nIHRoZSBtZXRhZGF0YSBsb2NhdGlvbiBhbmQgdXBkYXRlZCB0YWJsZSBtZXRhZGF0YQogICAqCiAgICogQGV4YW1wbGUKICAgKiBgYGB0eXBlc2NyaXB0CiAgICogY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBjYXRhbG9nLnVwZGF0ZVRhYmxlKAogICAqICAgeyBuYW1lc3BhY2U6IFsnYW5hbHl0aWNzJ10sIG5hbWU6ICdldmVudHMnIH0sCiAgICogICB7CiAgICogICAgIHByb3BlcnRpZXM6IHsgJ3JlYWQuc3BsaXQudGFyZ2V0LXNpemUnOiAnMTM0MjE3NzI4JyB9CiAgICogICB9CiAgICogKTsKICAgKiBjb25zb2xlLmxvZyhyZXNwb25zZVsnbWV0YWRhdGEtbG9jYXRpb24nXSk7IC8vIHMzOi8vLi4uCiAgICogY29uc29sZS5sb2cocmVzcG9uc2UubWV0YWRhdGEpOyAvLyBUYWJsZU1ldGFkYXRhIG9iamVjdAogICAqIGBgYAogICAqLwogIGFzeW5jIHVwZGF0ZVRhYmxlKGlkLCByZXF1ZXN0KSB7CiAgICByZXR1cm4gdGhpcy50YWJsZU9wcy51cGRhdGVUYWJsZShpZCwgcmVxdWVzdCk7CiAgfQogIC8qKgogICAqIERyb3BzIGEgdGFibGUgZnJvbSB0aGUgY2F0YWxvZy4KICAgKgogICAqIEBwYXJhbSBpZCAtIFRhYmxlIGlkZW50aWZpZXIgdG8gZHJvcAogICAqCiAgICogQGV4YW1wbGUKICAgKiBgYGB0eXBlc2NyaXB0CiAgICogYXdhaXQgY2F0YWxvZy5kcm9wVGFibGUoeyBuYW1lc3BhY2U6IFsnYW5hbHl0aWNzJ10sIG5hbWU6ICdldmVudHMnIH0pOwogICAqIGBgYAogICAqLwogIGFzeW5jIGRyb3BUYWJsZShpZCwgb3B0aW9ucykgewogICAgYXdhaXQgdGhpcy50YWJsZU9wcy5kcm9wVGFibGUoaWQsIG9wdGlvbnMpOwogIH0KICAvKioKICAgKiBMb2FkcyBtZXRhZGF0YSBmb3IgYSB0YWJsZS4KICAgKgogICAqIEBwYXJhbSBpZCAtIFRhYmxlIGlkZW50aWZpZXIgdG8gbG9hZAogICAqIEByZXR1cm5zIFRhYmxlIG1ldGFkYXRhIGluY2x1ZGluZyBzY2hlbWEsIHBhcnRpdGlvbiBzcGVjLCBsb2NhdGlvbiwgZXRjLgogICAqCiAgICogQGV4YW1wbGUKICAgKiBgYGB0eXBlc2NyaXB0CiAgICogY29uc3QgbWV0YWRhdGEgPSBhd2FpdCBjYXRhbG9nLmxvYWRUYWJsZSh7IG5hbWVzcGFjZTogWydhbmFseXRpY3MnXSwgbmFtZTogJ2V2ZW50cycgfSk7CiAgICogY29uc29sZS5sb2cobWV0YWRhdGEuc2NoZW1hKTsKICAgKiBjb25zb2xlLmxvZyhtZXRhZGF0YS5sb2NhdGlvbik7CiAgICogYGBgCiAgICovCiAgYXN5bmMgbG9hZFRhYmxlKGlkKSB7CiAgICByZXR1cm4gdGhpcy50YWJsZU9wcy5sb2FkVGFibGUoaWQpOwogIH0KICAvKioKICAgKiBDaGVja3MgaWYgYSBuYW1lc3BhY2UgZXhpc3RzIGluIHRoZSBjYXRhbG9nLgogICAqCiAgICogQHBhcmFtIGlkIC0gTmFtZXNwYWNlIGlkZW50aWZpZXIgdG8gY2hlY2sKICAgKiBAcmV0dXJucyBUcnVlIGlmIHRoZSBuYW1lc3BhY2UgZXhpc3RzLCBmYWxzZSBvdGhlcndpc2UKICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHlwZXNjcmlwdAogICAqIGNvbnN0IGV4aXN0cyA9IGF3YWl0IGNhdGFsb2cubmFtZXNwYWNlRXhpc3RzKHsgbmFtZXNwYWNlOiBbJ2FuYWx5dGljcyddIH0pOwogICAqIGNvbnNvbGUubG9nKGV4aXN0cyk7IC8vIHRydWUgb3IgZmFsc2UKICAgKiBgYGAKICAgKi8KICBhc3luYyBuYW1lc3BhY2VFeGlzdHMoaWQpIHsKICAgIHJldHVybiB0aGlzLm5hbWVzcGFjZU9wcy5uYW1lc3BhY2VFeGlzdHMoaWQpOwogIH0KICAvKioKICAgKiBDaGVja3MgaWYgYSB0YWJsZSBleGlzdHMgaW4gdGhlIGNhdGFsb2cuCiAgICoKICAgKiBAcGFyYW0gaWQgLSBUYWJsZSBpZGVudGlmaWVyIHRvIGNoZWNrCiAgICogQHJldHVybnMgVHJ1ZSBpZiB0aGUgdGFibGUgZXhpc3RzLCBmYWxzZSBvdGhlcndpc2UKICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHlwZXNjcmlwdAogICAqIGNvbnN0IGV4aXN0cyA9IGF3YWl0IGNhdGFsb2cudGFibGVFeGlzdHMoeyBuYW1lc3BhY2U6IFsnYW5hbHl0aWNzJ10sIG5hbWU6ICdldmVudHMnIH0pOwogICAqIGNvbnNvbGUubG9nKGV4aXN0cyk7IC8vIHRydWUgb3IgZmFsc2UKICAgKiBgYGAKICAgKi8KICBhc3luYyB0YWJsZUV4aXN0cyhpZCkgewogICAgcmV0dXJuIHRoaXMudGFibGVPcHMudGFibGVFeGlzdHMoaWQpOwogIH0KICAvKioKICAgKiBDcmVhdGVzIGEgbmFtZXNwYWNlIGlmIGl0IGRvZXMgbm90IGV4aXN0LgogICAqCiAgICogSWYgdGhlIG5hbWVzcGFjZSBhbHJlYWR5IGV4aXN0cywgcmV0dXJucyB2b2lkLiBJZiBjcmVhdGVkLCByZXR1cm5zIHRoZSByZXNwb25zZS4KICAgKgogICAqIEBwYXJhbSBpZCAtIE5hbWVzcGFjZSBpZGVudGlmaWVyIHRvIGNyZWF0ZQogICAqIEBwYXJhbSBtZXRhZGF0YSAtIE9wdGlvbmFsIG1ldGFkYXRhIHByb3BlcnRpZXMgZm9yIHRoZSBuYW1lc3BhY2UKICAgKiBAcmV0dXJucyBSZXNwb25zZSBjb250YWluaW5nIHRoZSBjcmVhdGVkIG5hbWVzcGFjZSBhbmQgaXRzIHByb3BlcnRpZXMsIG9yIHZvaWQgaWYgaXQgYWxyZWFkeSBleGlzdHMKICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHlwZXNjcmlwdAogICAqIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY2F0YWxvZy5jcmVhdGVOYW1lc3BhY2VJZk5vdEV4aXN0cygKICAgKiAgIHsgbmFtZXNwYWNlOiBbJ2FuYWx5dGljcyddIH0sCiAgICogICB7IHByb3BlcnRpZXM6IHsgb3duZXI6ICdkYXRhLXRlYW0nIH0gfQogICAqICk7CiAgICogaWYgKHJlc3BvbnNlKSB7CiAgICogICBjb25zb2xlLmxvZygnQ3JlYXRlZDonLCByZXNwb25zZS5uYW1lc3BhY2UpOwogICAqIH0gZWxzZSB7CiAgICogICBjb25zb2xlLmxvZygnQWxyZWFkeSBleGlzdHMnKTsKICAgKiB9CiAgICogYGBgCiAgICovCiAgYXN5bmMgY3JlYXRlTmFtZXNwYWNlSWZOb3RFeGlzdHMoaWQsIG1ldGFkYXRhKSB7CiAgICByZXR1cm4gdGhpcy5uYW1lc3BhY2VPcHMuY3JlYXRlTmFtZXNwYWNlSWZOb3RFeGlzdHMoaWQsIG1ldGFkYXRhKTsKICB9CiAgLyoqCiAgICogQ3JlYXRlcyBhIHRhYmxlIGlmIGl0IGRvZXMgbm90IGV4aXN0LgogICAqCiAgICogSWYgdGhlIHRhYmxlIGFscmVhZHkgZXhpc3RzLCByZXR1cm5zIGl0cyBtZXRhZGF0YSBpbnN0ZWFkLgogICAqCiAgICogQHBhcmFtIG5hbWVzcGFjZSAtIE5hbWVzcGFjZSB0byBjcmVhdGUgdGhlIHRhYmxlIGluCiAgICogQHBhcmFtIHJlcXVlc3QgLSBUYWJsZSBjcmVhdGlvbiByZXF1ZXN0IGluY2x1ZGluZyBuYW1lLCBzY2hlbWEsIHBhcnRpdGlvbiBzcGVjLCBldGMuCiAgICogQHJldHVybnMgVGFibGUgbWV0YWRhdGEgZm9yIHRoZSBjcmVhdGVkIG9yIGV4aXN0aW5nIHRhYmxlCiAgICoKICAgKiBAZXhhbXBsZQogICAqIGBgYHR5cGVzY3JpcHQKICAgKiBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IGNhdGFsb2cuY3JlYXRlVGFibGVJZk5vdEV4aXN0cygKICAgKiAgIHsgbmFtZXNwYWNlOiBbJ2FuYWx5dGljcyddIH0sCiAgICogICB7CiAgICogICAgIG5hbWU6ICdldmVudHMnLAogICAqICAgICBzY2hlbWE6IHsKICAgKiAgICAgICB0eXBlOiAnc3RydWN0JywKICAgKiAgICAgICBmaWVsZHM6IFsKICAgKiAgICAgICAgIHsgaWQ6IDEsIG5hbWU6ICdpZCcsIHR5cGU6ICdsb25nJywgcmVxdWlyZWQ6IHRydWUgfSwKICAgKiAgICAgICAgIHsgaWQ6IDIsIG5hbWU6ICd0aW1lc3RhbXAnLCB0eXBlOiAndGltZXN0YW1wJywgcmVxdWlyZWQ6IHRydWUgfQogICAqICAgICAgIF0sCiAgICogICAgICAgJ3NjaGVtYS1pZCc6IDAKICAgKiAgICAgfQogICAqICAgfQogICAqICk7CiAgICogYGBgCiAgICovCiAgYXN5bmMgY3JlYXRlVGFibGVJZk5vdEV4aXN0cyhuYW1lc3BhY2UsIHJlcXVlc3QpIHsKICAgIHJldHVybiB0aGlzLnRhYmxlT3BzLmNyZWF0ZVRhYmxlSWZOb3RFeGlzdHMobmFtZXNwYWNlLCByZXF1ZXN0KTsKICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK3N0b3JhZ2UtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2Uvc3RvcmFnZS1qcy9kaXN0L2luZGV4Lm1qcwp2YXIgU3RvcmFnZUVycm9yID0gY2xhc3MgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSwgbmFtZXNwYWNlID0gInN0b3JhZ2UiLCBzdGF0dXMsIHN0YXR1c0NvZGUpIHsKICAgIHN1cGVyKG1lc3NhZ2UpOwogICAgdGhpcy5fX2lzU3RvcmFnZUVycm9yID0gdHJ1ZTsKICAgIHRoaXMubmFtZXNwYWNlID0gbmFtZXNwYWNlOwogICAgdGhpcy5uYW1lID0gbmFtZXNwYWNlID09PSAidmVjdG9ycyIgPyAiU3RvcmFnZVZlY3RvcnNFcnJvciIgOiAiU3RvcmFnZUVycm9yIjsKICAgIHRoaXMuc3RhdHVzID0gc3RhdHVzOwogICAgdGhpcy5zdGF0dXNDb2RlID0gc3RhdHVzQ29kZTsKICB9Cn07CmZ1bmN0aW9uIGlzU3RvcmFnZUVycm9yKGVycm9yKSB7CiAgcmV0dXJuIHR5cGVvZiBlcnJvciA9PT0gIm9iamVjdCIgJiYgZXJyb3IgIT09IG51bGwgJiYgIl9faXNTdG9yYWdlRXJyb3IiIGluIGVycm9yOwp9CnZhciBTdG9yYWdlQXBpRXJyb3IgPSBjbGFzcyBleHRlbmRzIFN0b3JhZ2VFcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSwgc3RhdHVzLCBzdGF0dXNDb2RlLCBuYW1lc3BhY2UgPSAic3RvcmFnZSIpIHsKICAgIHN1cGVyKG1lc3NhZ2UsIG5hbWVzcGFjZSwgc3RhdHVzLCBzdGF0dXNDb2RlKTsKICAgIHRoaXMubmFtZSA9IG5hbWVzcGFjZSA9PT0gInZlY3RvcnMiID8gIlN0b3JhZ2VWZWN0b3JzQXBpRXJyb3IiIDogIlN0b3JhZ2VBcGlFcnJvciI7CiAgICB0aGlzLnN0YXR1cyA9IHN0YXR1czsKICAgIHRoaXMuc3RhdHVzQ29kZSA9IHN0YXR1c0NvZGU7CiAgfQogIHRvSlNPTigpIHsKICAgIHJldHVybiB7CiAgICAgIG5hbWU6IHRoaXMubmFtZSwKICAgICAgbWVzc2FnZTogdGhpcy5tZXNzYWdlLAogICAgICBzdGF0dXM6IHRoaXMuc3RhdHVzLAogICAgICBzdGF0dXNDb2RlOiB0aGlzLnN0YXR1c0NvZGUKICAgIH07CiAgfQp9Owp2YXIgU3RvcmFnZVVua25vd25FcnJvciA9IGNsYXNzIGV4dGVuZHMgU3RvcmFnZUVycm9yIHsKICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBvcmlnaW5hbEVycm9yLCBuYW1lc3BhY2UgPSAic3RvcmFnZSIpIHsKICAgIHN1cGVyKG1lc3NhZ2UsIG5hbWVzcGFjZSk7CiAgICB0aGlzLm5hbWUgPSBuYW1lc3BhY2UgPT09ICJ2ZWN0b3JzIiA/ICJTdG9yYWdlVmVjdG9yc1Vua25vd25FcnJvciIgOiAiU3RvcmFnZVVua25vd25FcnJvciI7CiAgICB0aGlzLm9yaWdpbmFsRXJyb3IgPSBvcmlnaW5hbEVycm9yOwogIH0KfTsKdmFyIHJlc29sdmVGZXRjaDIgPSAoY3VzdG9tRmV0Y2gpID0+IHsKICBpZiAoY3VzdG9tRmV0Y2gpIHJldHVybiAoLi4uYXJncykgPT4gY3VzdG9tRmV0Y2goLi4uYXJncyk7CiAgcmV0dXJuICguLi5hcmdzKSA9PiBmZXRjaCguLi5hcmdzKTsKfTsKdmFyIGlzUGxhaW5PYmplY3Q0ID0gKHZhbHVlKSA9PiB7CiAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gIm9iamVjdCIgfHwgdmFsdWUgPT09IG51bGwpIHJldHVybiBmYWxzZTsKICBjb25zdCBwcm90b3R5cGUgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodmFsdWUpOwogIHJldHVybiAocHJvdG90eXBlID09PSBudWxsIHx8IHByb3RvdHlwZSA9PT0gT2JqZWN0LnByb3RvdHlwZSB8fCBPYmplY3QuZ2V0UHJvdG90eXBlT2YocHJvdG90eXBlKSA9PT0gbnVsbCkgJiYgIShTeW1ib2wudG9TdHJpbmdUYWcgaW4gdmFsdWUpICYmICEoU3ltYm9sLml0ZXJhdG9yIGluIHZhbHVlKTsKfTsKdmFyIHJlY3Vyc2l2ZVRvQ2FtZWwgPSAoaXRlbSkgPT4gewogIGlmIChBcnJheS5pc0FycmF5KGl0ZW0pKSByZXR1cm4gaXRlbS5tYXAoKGVsKSA9PiByZWN1cnNpdmVUb0NhbWVsKGVsKSk7CiAgZWxzZSBpZiAodHlwZW9mIGl0ZW0gPT09ICJmdW5jdGlvbiIgfHwgaXRlbSAhPT0gT2JqZWN0KGl0ZW0pKSByZXR1cm4gaXRlbTsKICBjb25zdCByZXN1bHQgPSB7fTsKICBPYmplY3QuZW50cmllcyhpdGVtKS5mb3JFYWNoKChba2V5LCB2YWx1ZV0pID0+IHsKICAgIGNvbnN0IG5ld0tleSA9IGtleS5yZXBsYWNlKC8oWy1fXVthLXpdKS9naSwgKGMpID0+IGMudG9VcHBlckNhc2UoKS5yZXBsYWNlKC9bLV9dL2csICIiKSk7CiAgICByZXN1bHRbbmV3S2V5XSA9IHJlY3Vyc2l2ZVRvQ2FtZWwodmFsdWUpOwogIH0pOwogIHJldHVybiByZXN1bHQ7Cn07CnZhciBpc1ZhbGlkQnVja2V0TmFtZSA9IChidWNrZXROYW1lKSA9PiB7CiAgaWYgKCFidWNrZXROYW1lIHx8IHR5cGVvZiBidWNrZXROYW1lICE9PSAic3RyaW5nIikgcmV0dXJuIGZhbHNlOwogIGlmIChidWNrZXROYW1lLmxlbmd0aCA9PT0gMCB8fCBidWNrZXROYW1lLmxlbmd0aCA+IDEwMCkgcmV0dXJuIGZhbHNlOwogIGlmIChidWNrZXROYW1lLnRyaW0oKSAhPT0gYnVja2V0TmFtZSkgcmV0dXJuIGZhbHNlOwogIGlmIChidWNrZXROYW1lLmluY2x1ZGVzKCIvIikgfHwgYnVja2V0TmFtZS5pbmNsdWRlcygiXFwiKSkgcmV0dXJuIGZhbHNlOwogIHJldHVybiAvXltcdyEuXConKCkgJiRAPTs6Kyw/LV0rJC8udGVzdChidWNrZXROYW1lKTsKfTsKZnVuY3Rpb24gX3R5cGVvZjIobykgewogICJAYmFiZWwvaGVscGVycyAtIHR5cGVvZiI7CiAgcmV0dXJuIF90eXBlb2YyID0gImZ1bmN0aW9uIiA9PSB0eXBlb2YgU3ltYm9sICYmICJzeW1ib2wiID09IHR5cGVvZiBTeW1ib2wuaXRlcmF0b3IgPyBmdW5jdGlvbihvJDEpIHsKICAgIHJldHVybiB0eXBlb2YgbyQxOwogIH0gOiBmdW5jdGlvbihvJDEpIHsKICAgIHJldHVybiBvJDEgJiYgImZ1bmN0aW9uIiA9PSB0eXBlb2YgU3ltYm9sICYmIG8kMS5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG8kMSAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogdHlwZW9mIG8kMTsKICB9LCBfdHlwZW9mMihvKTsKfQpmdW5jdGlvbiB0b1ByaW1pdGl2ZTIodCwgcjIpIHsKICBpZiAoIm9iamVjdCIgIT0gX3R5cGVvZjIodCkgfHwgIXQpIHJldHVybiB0OwogIHZhciBlID0gdFtTeW1ib2wudG9QcmltaXRpdmVdOwogIGlmICh2b2lkIDAgIT09IGUpIHsKICAgIHZhciBpID0gZS5jYWxsKHQsIHIyIHx8ICJkZWZhdWx0Iik7CiAgICBpZiAoIm9iamVjdCIgIT0gX3R5cGVvZjIoaSkpIHJldHVybiBpOwogICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiQEB0b1ByaW1pdGl2ZSBtdXN0IHJldHVybiBhIHByaW1pdGl2ZSB2YWx1ZS4iKTsKICB9CiAgcmV0dXJuICgic3RyaW5nIiA9PT0gcjIgPyBTdHJpbmcgOiBOdW1iZXIpKHQpOwp9CmZ1bmN0aW9uIHRvUHJvcGVydHlLZXkyKHQpIHsKICB2YXIgaSA9IHRvUHJpbWl0aXZlMih0LCAic3RyaW5nIik7CiAgcmV0dXJuICJzeW1ib2wiID09IF90eXBlb2YyKGkpID8gaSA6IGkgKyAiIjsKfQpmdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkzNShlLCByMiwgdCkgewogIHJldHVybiAocjIgPSB0b1Byb3BlcnR5S2V5MihyMikpIGluIGUgPyBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgcjIsIHsKICAgIHZhbHVlOiB0LAogICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgIHdyaXRhYmxlOiB0cnVlCiAgfSkgOiBlW3IyXSA9IHQsIGU7Cn0KZnVuY3Rpb24gb3duS2V5czMzKGUsIHIyKSB7CiAgdmFyIHQgPSBPYmplY3Qua2V5cyhlKTsKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIG8gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgcjIgJiYgKG8gPSBvLmZpbHRlcihmdW5jdGlvbihyJDEpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgciQxKS5lbnVtZXJhYmxlOwogICAgfSkpLCB0LnB1c2guYXBwbHkodCwgbyk7CiAgfQogIHJldHVybiB0Owp9CmZ1bmN0aW9uIF9vYmplY3RTcHJlYWQyMTEoZSkgewogIGZvciAodmFyIHIyID0gMTsgcjIgPCBhcmd1bWVudHMubGVuZ3RoOyByMisrKSB7CiAgICB2YXIgdCA9IG51bGwgIT0gYXJndW1lbnRzW3IyXSA/IGFyZ3VtZW50c1tyMl0gOiB7fTsKICAgIHIyICUgMiA/IG93bktleXMzMyhPYmplY3QodCksIHRydWUpLmZvckVhY2goZnVuY3Rpb24ociQxKSB7CiAgICAgIF9kZWZpbmVQcm9wZXJ0eTM1KGUsIHIkMSwgdFtyJDFdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyh0KSkgOiBvd25LZXlzMzMoT2JqZWN0KHQpKS5mb3JFYWNoKGZ1bmN0aW9uKHIkMSkgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgciQxLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHQsIHIkMSkpOwogICAgfSk7CiAgfQogIHJldHVybiBlOwp9CnZhciBfZ2V0RXJyb3JNZXNzYWdlID0gKGVycikgPT4gewogIHZhciBfZXJyJGVycm9yOwogIHJldHVybiBlcnIubXNnIHx8IGVyci5tZXNzYWdlIHx8IGVyci5lcnJvcl9kZXNjcmlwdGlvbiB8fCAodHlwZW9mIGVyci5lcnJvciA9PT0gInN0cmluZyIgPyBlcnIuZXJyb3IgOiAoX2VyciRlcnJvciA9IGVyci5lcnJvcikgPT09IG51bGwgfHwgX2VyciRlcnJvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2VyciRlcnJvci5tZXNzYWdlKSB8fCBKU09OLnN0cmluZ2lmeShlcnIpOwp9Owp2YXIgaGFuZGxlRXJyb3IgPSBhc3luYyAoZXJyb3IsIHJlamVjdCwgb3B0aW9ucywgbmFtZXNwYWNlKSA9PiB7CiAgaWYgKGVycm9yICYmIHR5cGVvZiBlcnJvciA9PT0gIm9iamVjdCIgJiYgInN0YXR1cyIgaW4gZXJyb3IgJiYgIm9rIiBpbiBlcnJvciAmJiB0eXBlb2YgZXJyb3Iuc3RhdHVzID09PSAibnVtYmVyIiAmJiAhKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5ub1Jlc29sdmVKc29uKSkgewogICAgY29uc3QgcmVzcG9uc2VFcnJvciA9IGVycm9yOwogICAgY29uc3Qgc3RhdHVzID0gcmVzcG9uc2VFcnJvci5zdGF0dXMgfHwgNTAwOwogICAgaWYgKHR5cGVvZiByZXNwb25zZUVycm9yLmpzb24gPT09ICJmdW5jdGlvbiIpIHJlc3BvbnNlRXJyb3IuanNvbigpLnRoZW4oKGVycikgPT4gewogICAgICBjb25zdCBzdGF0dXNDb2RlID0gKGVyciA9PT0gbnVsbCB8fCBlcnIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGVyci5zdGF0dXNDb2RlKSB8fCAoZXJyID09PSBudWxsIHx8IGVyciA9PT0gdm9pZCAwID8gdm9pZCAwIDogZXJyLmNvZGUpIHx8IHN0YXR1cyArICIiOwogICAgICByZWplY3QobmV3IFN0b3JhZ2VBcGlFcnJvcihfZ2V0RXJyb3JNZXNzYWdlKGVyciksIHN0YXR1cywgc3RhdHVzQ29kZSwgbmFtZXNwYWNlKSk7CiAgICB9KS5jYXRjaCgoKSA9PiB7CiAgICAgIGlmIChuYW1lc3BhY2UgPT09ICJ2ZWN0b3JzIikgewogICAgICAgIGNvbnN0IHN0YXR1c0NvZGUgPSBzdGF0dXMgKyAiIjsKICAgICAgICByZWplY3QobmV3IFN0b3JhZ2VBcGlFcnJvcihyZXNwb25zZUVycm9yLnN0YXR1c1RleHQgfHwgYEhUVFAgJHtzdGF0dXN9IGVycm9yYCwgc3RhdHVzLCBzdGF0dXNDb2RlLCBuYW1lc3BhY2UpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBzdGF0dXNDb2RlID0gc3RhdHVzICsgIiI7CiAgICAgICAgcmVqZWN0KG5ldyBTdG9yYWdlQXBpRXJyb3IocmVzcG9uc2VFcnJvci5zdGF0dXNUZXh0IHx8IGBIVFRQICR7c3RhdHVzfSBlcnJvcmAsIHN0YXR1cywgc3RhdHVzQ29kZSwgbmFtZXNwYWNlKSk7CiAgICAgIH0KICAgIH0pOwogICAgZWxzZSB7CiAgICAgIGNvbnN0IHN0YXR1c0NvZGUgPSBzdGF0dXMgKyAiIjsKICAgICAgcmVqZWN0KG5ldyBTdG9yYWdlQXBpRXJyb3IocmVzcG9uc2VFcnJvci5zdGF0dXNUZXh0IHx8IGBIVFRQICR7c3RhdHVzfSBlcnJvcmAsIHN0YXR1cywgc3RhdHVzQ29kZSwgbmFtZXNwYWNlKSk7CiAgICB9CiAgfSBlbHNlIHJlamVjdChuZXcgU3RvcmFnZVVua25vd25FcnJvcihfZ2V0RXJyb3JNZXNzYWdlKGVycm9yKSwgZXJyb3IsIG5hbWVzcGFjZSkpOwp9Owp2YXIgX2dldFJlcXVlc3RQYXJhbXMgPSAobWV0aG9kLCBvcHRpb25zLCBwYXJhbWV0ZXJzLCBib2R5KSA9PiB7CiAgY29uc3QgcGFyYW1zID0gewogICAgbWV0aG9kLAogICAgaGVhZGVyczogKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5oZWFkZXJzKSB8fCB7fQogIH07CiAgaWYgKG1ldGhvZCA9PT0gIkdFVCIgfHwgbWV0aG9kID09PSAiSEVBRCIgfHwgIWJvZHkpIHJldHVybiBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIHBhcmFtcyksIHBhcmFtZXRlcnMpOwogIGlmIChpc1BsYWluT2JqZWN0NChib2R5KSkgewogICAgcGFyYW1zLmhlYWRlcnMgPSBfb2JqZWN0U3ByZWFkMjExKHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LCBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuaGVhZGVycyk7CiAgICBwYXJhbXMuYm9keSA9IEpTT04uc3RyaW5naWZ5KGJvZHkpOwogIH0gZWxzZSBwYXJhbXMuYm9keSA9IGJvZHk7CiAgaWYgKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5kdXBsZXgpIHBhcmFtcy5kdXBsZXggPSBvcHRpb25zLmR1cGxleDsKICByZXR1cm4gX29iamVjdFNwcmVhZDIxMShfb2JqZWN0U3ByZWFkMjExKHt9LCBwYXJhbXMpLCBwYXJhbWV0ZXJzKTsKfTsKYXN5bmMgZnVuY3Rpb24gX2hhbmRsZVJlcXVlc3QoZmV0Y2hlciwgbWV0aG9kLCB1cmwsIG9wdGlvbnMsIHBhcmFtZXRlcnMsIGJvZHksIG5hbWVzcGFjZSkgewogIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBmZXRjaGVyKHVybCwgX2dldFJlcXVlc3RQYXJhbXMobWV0aG9kLCBvcHRpb25zLCBwYXJhbWV0ZXJzLCBib2R5KSkudGhlbigocmVzdWx0KSA9PiB7CiAgICAgIGlmICghcmVzdWx0Lm9rKSB0aHJvdyByZXN1bHQ7CiAgICAgIGlmIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMubm9SZXNvbHZlSnNvbikgcmV0dXJuIHJlc3VsdDsKICAgICAgaWYgKG5hbWVzcGFjZSA9PT0gInZlY3RvcnMiKSB7CiAgICAgICAgY29uc3QgY29udGVudFR5cGUgPSByZXN1bHQuaGVhZGVycy5nZXQoImNvbnRlbnQtdHlwZSIpOwogICAgICAgIGlmIChyZXN1bHQuaGVhZGVycy5nZXQoImNvbnRlbnQtbGVuZ3RoIikgPT09ICIwIiB8fCByZXN1bHQuc3RhdHVzID09PSAyMDQpIHJldHVybiB7fTsKICAgICAgICBpZiAoIWNvbnRlbnRUeXBlIHx8ICFjb250ZW50VHlwZS5pbmNsdWRlcygiYXBwbGljYXRpb24vanNvbiIpKSByZXR1cm4ge307CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3VsdC5qc29uKCk7CiAgICB9KS50aGVuKChkYXRhKSA9PiByZXNvbHZlKGRhdGEpKS5jYXRjaCgoZXJyb3IpID0+IGhhbmRsZUVycm9yKGVycm9yLCByZWplY3QsIG9wdGlvbnMsIG5hbWVzcGFjZSkpOwogIH0pOwp9CmZ1bmN0aW9uIGNyZWF0ZUZldGNoQXBpKG5hbWVzcGFjZSA9ICJzdG9yYWdlIikgewogIHJldHVybiB7CiAgICBnZXQ6IGFzeW5jIChmZXRjaGVyLCB1cmwsIG9wdGlvbnMsIHBhcmFtZXRlcnMpID0+IHsKICAgICAgcmV0dXJuIF9oYW5kbGVSZXF1ZXN0KGZldGNoZXIsICJHRVQiLCB1cmwsIG9wdGlvbnMsIHBhcmFtZXRlcnMsIHZvaWQgMCwgbmFtZXNwYWNlKTsKICAgIH0sCiAgICBwb3N0OiBhc3luYyAoZmV0Y2hlciwgdXJsLCBib2R5LCBvcHRpb25zLCBwYXJhbWV0ZXJzKSA9PiB7CiAgICAgIHJldHVybiBfaGFuZGxlUmVxdWVzdChmZXRjaGVyLCAiUE9TVCIsIHVybCwgb3B0aW9ucywgcGFyYW1ldGVycywgYm9keSwgbmFtZXNwYWNlKTsKICAgIH0sCiAgICBwdXQ6IGFzeW5jIChmZXRjaGVyLCB1cmwsIGJvZHksIG9wdGlvbnMsIHBhcmFtZXRlcnMpID0+IHsKICAgICAgcmV0dXJuIF9oYW5kbGVSZXF1ZXN0KGZldGNoZXIsICJQVVQiLCB1cmwsIG9wdGlvbnMsIHBhcmFtZXRlcnMsIGJvZHksIG5hbWVzcGFjZSk7CiAgICB9LAogICAgaGVhZDogYXN5bmMgKGZldGNoZXIsIHVybCwgb3B0aW9ucywgcGFyYW1ldGVycykgPT4gewogICAgICByZXR1cm4gX2hhbmRsZVJlcXVlc3QoZmV0Y2hlciwgIkhFQUQiLCB1cmwsIF9vYmplY3RTcHJlYWQyMTEoX29iamVjdFNwcmVhZDIxMSh7fSwgb3B0aW9ucyksIHt9LCB7IG5vUmVzb2x2ZUpzb246IHRydWUgfSksIHBhcmFtZXRlcnMsIHZvaWQgMCwgbmFtZXNwYWNlKTsKICAgIH0sCiAgICByZW1vdmU6IGFzeW5jIChmZXRjaGVyLCB1cmwsIGJvZHksIG9wdGlvbnMsIHBhcmFtZXRlcnMpID0+IHsKICAgICAgcmV0dXJuIF9oYW5kbGVSZXF1ZXN0KGZldGNoZXIsICJERUxFVEUiLCB1cmwsIG9wdGlvbnMsIHBhcmFtZXRlcnMsIGJvZHksIG5hbWVzcGFjZSk7CiAgICB9CiAgfTsKfQp2YXIgZGVmYXVsdEFwaSA9IGNyZWF0ZUZldGNoQXBpKCJzdG9yYWdlIik7CnZhciB7IGdldDogZ2V0NSwgcG9zdCwgcHV0LCBoZWFkLCByZW1vdmUgfSA9IGRlZmF1bHRBcGk7CnZhciB2ZWN0b3JzQXBpID0gY3JlYXRlRmV0Y2hBcGkoInZlY3RvcnMiKTsKdmFyIEJhc2VBcGlDbGllbnQgPSBjbGFzcyB7CiAgLyoqCiAgKiBDcmVhdGVzIGEgbmV3IEJhc2VBcGlDbGllbnQgaW5zdGFuY2UKICAqIEBwYXJhbSB1cmwgLSBCYXNlIFVSTCBmb3IgQVBJIHJlcXVlc3RzCiAgKiBAcGFyYW0gaGVhZGVycyAtIERlZmF1bHQgaGVhZGVycyBmb3IgQVBJIHJlcXVlc3RzCiAgKiBAcGFyYW0gZmV0Y2ggLSBPcHRpb25hbCBjdXN0b20gZmV0Y2ggaW1wbGVtZW50YXRpb24KICAqIEBwYXJhbSBuYW1lc3BhY2UgLSBFcnJvciBuYW1lc3BhY2UgKCdzdG9yYWdlJyBvciAndmVjdG9ycycpCiAgKi8KICBjb25zdHJ1Y3Rvcih1cmwsIGhlYWRlcnMgPSB7fSwgZmV0Y2gkMSwgbmFtZXNwYWNlID0gInN0b3JhZ2UiKSB7CiAgICB0aGlzLnNob3VsZFRocm93T25FcnJvciA9IGZhbHNlOwogICAgdGhpcy51cmwgPSB1cmw7CiAgICB0aGlzLmhlYWRlcnMgPSBoZWFkZXJzOwogICAgdGhpcy5mZXRjaCA9IHJlc29sdmVGZXRjaDIoZmV0Y2gkMSk7CiAgICB0aGlzLm5hbWVzcGFjZSA9IG5hbWVzcGFjZTsKICB9CiAgLyoqCiAgKiBFbmFibGUgdGhyb3dpbmcgZXJyb3JzIGluc3RlYWQgb2YgcmV0dXJuaW5nIHRoZW0uCiAgKiBXaGVuIGVuYWJsZWQsIGVycm9ycyBhcmUgdGhyb3duIGluc3RlYWQgb2YgcmV0dXJuZWQgaW4geyBkYXRhLCBlcnJvciB9IGZvcm1hdC4KICAqCiAgKiBAcmV0dXJucyB0aGlzIC0gRm9yIG1ldGhvZCBjaGFpbmluZwogICovCiAgdGhyb3dPbkVycm9yKCkgewogICAgdGhpcy5zaG91bGRUaHJvd09uRXJyb3IgPSB0cnVlOwogICAgcmV0dXJuIHRoaXM7CiAgfQogIC8qKgogICogU2V0IGFuIEhUVFAgaGVhZGVyIGZvciB0aGUgcmVxdWVzdC4KICAqIENyZWF0ZXMgYSBzaGFsbG93IGNvcHkgb2YgaGVhZGVycyB0byBhdm9pZCBtdXRhdGluZyBzaGFyZWQgc3RhdGUuCiAgKgogICogQHBhcmFtIG5hbWUgLSBIZWFkZXIgbmFtZQogICogQHBhcmFtIHZhbHVlIC0gSGVhZGVyIHZhbHVlCiAgKiBAcmV0dXJucyB0aGlzIC0gRm9yIG1ldGhvZCBjaGFpbmluZwogICovCiAgc2V0SGVhZGVyKG5hbWUsIHZhbHVlKSB7CiAgICB0aGlzLmhlYWRlcnMgPSBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIHRoaXMuaGVhZGVycyksIHt9LCB7IFtuYW1lXTogdmFsdWUgfSk7CiAgICByZXR1cm4gdGhpczsKICB9CiAgLyoqCiAgKiBIYW5kbGVzIEFQSSBvcGVyYXRpb24gd2l0aCBzdGFuZGFyZGl6ZWQgZXJyb3IgaGFuZGxpbmcKICAqIEVsaW1pbmF0ZXMgcmVwZXRpdGl2ZSB0cnktY2F0Y2ggYmxvY2tzIGFjcm9zcyBhbGwgQVBJIG1ldGhvZHMKICAqCiAgKiBUaGlzIHdyYXBwZXI6CiAgKiAxLiBFeGVjdXRlcyB0aGUgb3BlcmF0aW9uCiAgKiAyLiBSZXR1cm5zIHsgZGF0YSwgZXJyb3I6IG51bGwgfSBvbiBzdWNjZXNzCiAgKiAzLiBSZXR1cm5zIHsgZGF0YTogbnVsbCwgZXJyb3IgfSBvbiBmYWlsdXJlIChpZiBzaG91bGRUaHJvd09uRXJyb3IgaXMgZmFsc2UpCiAgKiA0LiBUaHJvd3MgZXJyb3Igb24gZmFpbHVyZSAoaWYgc2hvdWxkVGhyb3dPbkVycm9yIGlzIHRydWUpCiAgKgogICogQHR5cGVQYXJhbSBUIC0gVGhlIGV4cGVjdGVkIGRhdGEgdHlwZSBmcm9tIHRoZSBvcGVyYXRpb24KICAqIEBwYXJhbSBvcGVyYXRpb24gLSBBc3luYyBmdW5jdGlvbiB0aGF0IHBlcmZvcm1zIHRoZSBBUEkgY2FsbAogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIHsgZGF0YSwgZXJyb3IgfSB0dXBsZQogICoKICAqIEBleGFtcGxlCiAgKiBgYGB0eXBlc2NyaXB0CiAgKiBhc3luYyBsaXN0QnVja2V0cygpIHsKICAqICAgcmV0dXJuIHRoaXMuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAqICAgICByZXR1cm4gYXdhaXQgZ2V0KHRoaXMuZmV0Y2gsIGAke3RoaXMudXJsfS9idWNrZXRgLCB7CiAgKiAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgKiAgICAgfSkKICAqICAgfSkKICAqIH0KICAqIGBgYAogICovCiAgYXN5bmMgaGFuZGxlT3BlcmF0aW9uKG9wZXJhdGlvbikgewogICAgdmFyIF90aGlzID0gdGhpczsKICAgIHRyeSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZGF0YTogYXdhaXQgb3BlcmF0aW9uKCksCiAgICAgICAgZXJyb3I6IG51bGwKICAgICAgfTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChfdGhpcy5zaG91bGRUaHJvd09uRXJyb3IpIHRocm93IGVycm9yOwogICAgICBpZiAoaXNTdG9yYWdlRXJyb3IoZXJyb3IpKSByZXR1cm4gewogICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgZXJyb3IKICAgICAgfTsKICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQp9Owp2YXIgU3RyZWFtRG93bmxvYWRCdWlsZGVyID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGRvd25sb2FkRm4sIHNob3VsZFRocm93T25FcnJvcikgewogICAgdGhpcy5kb3dubG9hZEZuID0gZG93bmxvYWRGbjsKICAgIHRoaXMuc2hvdWxkVGhyb3dPbkVycm9yID0gc2hvdWxkVGhyb3dPbkVycm9yOwogIH0KICB0aGVuKG9uZnVsZmlsbGVkLCBvbnJlamVjdGVkKSB7CiAgICByZXR1cm4gdGhpcy5leGVjdXRlKCkudGhlbihvbmZ1bGZpbGxlZCwgb25yZWplY3RlZCk7CiAgfQogIGFzeW5jIGV4ZWN1dGUoKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgdHJ5IHsKICAgICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiAoYXdhaXQgX3RoaXMuZG93bmxvYWRGbigpKS5ib2R5LAogICAgICAgIGVycm9yOiBudWxsCiAgICAgIH07CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoX3RoaXMuc2hvdWxkVGhyb3dPbkVycm9yKSB0aHJvdyBlcnJvcjsKICAgICAgaWYgKGlzU3RvcmFnZUVycm9yKGVycm9yKSkgcmV0dXJuIHsKICAgICAgICBkYXRhOiBudWxsLAogICAgICAgIGVycm9yCiAgICAgIH07CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KfTsKdmFyIF9TeW1ib2wkdG9TdHJpbmdUYWc7Cl9TeW1ib2wkdG9TdHJpbmdUYWcgPSBTeW1ib2wudG9TdHJpbmdUYWc7CnZhciBCbG9iRG93bmxvYWRCdWlsZGVyID0gY2xhc3MgewogIGNvbnN0cnVjdG9yKGRvd25sb2FkRm4sIHNob3VsZFRocm93T25FcnJvcikgewogICAgdGhpcy5kb3dubG9hZEZuID0gZG93bmxvYWRGbjsKICAgIHRoaXMuc2hvdWxkVGhyb3dPbkVycm9yID0gc2hvdWxkVGhyb3dPbkVycm9yOwogICAgdGhpc1tfU3ltYm9sJHRvU3RyaW5nVGFnXSA9ICJCbG9iRG93bmxvYWRCdWlsZGVyIjsKICAgIHRoaXMucHJvbWlzZSA9IG51bGw7CiAgfQogIGFzU3RyZWFtKCkgewogICAgcmV0dXJuIG5ldyBTdHJlYW1Eb3dubG9hZEJ1aWxkZXIodGhpcy5kb3dubG9hZEZuLCB0aGlzLnNob3VsZFRocm93T25FcnJvcik7CiAgfQogIHRoZW4ob25mdWxmaWxsZWQsIG9ucmVqZWN0ZWQpIHsKICAgIHJldHVybiB0aGlzLmdldFByb21pc2UoKS50aGVuKG9uZnVsZmlsbGVkLCBvbnJlamVjdGVkKTsKICB9CiAgY2F0Y2gob25yZWplY3RlZCkgewogICAgcmV0dXJuIHRoaXMuZ2V0UHJvbWlzZSgpLmNhdGNoKG9ucmVqZWN0ZWQpOwogIH0KICBmaW5hbGx5KG9uZmluYWxseSkgewogICAgcmV0dXJuIHRoaXMuZ2V0UHJvbWlzZSgpLmZpbmFsbHkob25maW5hbGx5KTsKICB9CiAgZ2V0UHJvbWlzZSgpIHsKICAgIGlmICghdGhpcy5wcm9taXNlKSB0aGlzLnByb21pc2UgPSB0aGlzLmV4ZWN1dGUoKTsKICAgIHJldHVybiB0aGlzLnByb21pc2U7CiAgfQogIGFzeW5jIGV4ZWN1dGUoKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgdHJ5IHsKICAgICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiBhd2FpdCAoYXdhaXQgX3RoaXMuZG93bmxvYWRGbigpKS5ibG9iKCksCiAgICAgICAgZXJyb3I6IG51bGwKICAgICAgfTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChfdGhpcy5zaG91bGRUaHJvd09uRXJyb3IpIHRocm93IGVycm9yOwogICAgICBpZiAoaXNTdG9yYWdlRXJyb3IoZXJyb3IpKSByZXR1cm4gewogICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgZXJyb3IKICAgICAgfTsKICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQp9Owp2YXIgREVGQVVMVF9TRUFSQ0hfT1BUSU9OUyA9IHsKICBsaW1pdDogMTAwLAogIG9mZnNldDogMCwKICBzb3J0Qnk6IHsKICAgIGNvbHVtbjogIm5hbWUiLAogICAgb3JkZXI6ICJhc2MiCiAgfQp9Owp2YXIgREVGQVVMVF9GSUxFX09QVElPTlMgPSB7CiAgY2FjaGVDb250cm9sOiAiMzYwMCIsCiAgY29udGVudFR5cGU6ICJ0ZXh0L3BsYWluO2NoYXJzZXQ9VVRGLTgiLAogIHVwc2VydDogZmFsc2UKfTsKdmFyIFN0b3JhZ2VGaWxlQXBpID0gY2xhc3MgZXh0ZW5kcyBCYXNlQXBpQ2xpZW50IHsKICBjb25zdHJ1Y3Rvcih1cmwsIGhlYWRlcnMgPSB7fSwgYnVja2V0SWQsIGZldGNoJDEpIHsKICAgIHN1cGVyKHVybCwgaGVhZGVycywgZmV0Y2gkMSwgInN0b3JhZ2UiKTsKICAgIHRoaXMuYnVja2V0SWQgPSBidWNrZXRJZDsKICB9CiAgLyoqCiAgKiBVcGxvYWRzIGEgZmlsZSB0byBhbiBleGlzdGluZyBidWNrZXQgb3IgcmVwbGFjZXMgYW4gZXhpc3RpbmcgZmlsZSBhdCB0aGUgc3BlY2lmaWVkIHBhdGggd2l0aCBhIG5ldyBvbmUuCiAgKgogICogQHBhcmFtIG1ldGhvZCBIVFRQIG1ldGhvZC4KICAqIEBwYXJhbSBwYXRoIFRoZSByZWxhdGl2ZSBmaWxlIHBhdGguIFNob3VsZCBiZSBvZiB0aGUgZm9ybWF0IGBmb2xkZXIvc3ViZm9sZGVyL2ZpbGVuYW1lLnBuZ2AuIFRoZSBidWNrZXQgbXVzdCBhbHJlYWR5IGV4aXN0IGJlZm9yZSBhdHRlbXB0aW5nIHRvIHVwbG9hZC4KICAqIEBwYXJhbSBmaWxlQm9keSBUaGUgYm9keSBvZiB0aGUgZmlsZSB0byBiZSBzdG9yZWQgaW4gdGhlIGJ1Y2tldC4KICAqLwogIGFzeW5jIHVwbG9hZE9yVXBkYXRlKG1ldGhvZCwgcGF0aDIsIGZpbGVCb2R5LCBmaWxlT3B0aW9ucykgewogICAgdmFyIF90aGlzID0gdGhpczsKICAgIHJldHVybiBfdGhpcy5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICBsZXQgYm9keTsKICAgICAgY29uc3Qgb3B0aW9ucyA9IF9vYmplY3RTcHJlYWQyMTEoX29iamVjdFNwcmVhZDIxMSh7fSwgREVGQVVMVF9GSUxFX09QVElPTlMpLCBmaWxlT3B0aW9ucyk7CiAgICAgIGxldCBoZWFkZXJzID0gX29iamVjdFNwcmVhZDIxMShfb2JqZWN0U3ByZWFkMjExKHt9LCBfdGhpcy5oZWFkZXJzKSwgbWV0aG9kID09PSAiUE9TVCIgJiYgeyAieC11cHNlcnQiOiBTdHJpbmcob3B0aW9ucy51cHNlcnQpIH0pOwogICAgICBjb25zdCBtZXRhZGF0YSA9IG9wdGlvbnMubWV0YWRhdGE7CiAgICAgIGlmICh0eXBlb2YgQmxvYiAhPT0gInVuZGVmaW5lZCIgJiYgZmlsZUJvZHkgaW5zdGFuY2VvZiBCbG9iKSB7CiAgICAgICAgYm9keSA9IG5ldyBGb3JtRGF0YSgpOwogICAgICAgIGJvZHkuYXBwZW5kKCJjYWNoZUNvbnRyb2wiLCBvcHRpb25zLmNhY2hlQ29udHJvbCk7CiAgICAgICAgaWYgKG1ldGFkYXRhKSBib2R5LmFwcGVuZCgibWV0YWRhdGEiLCBfdGhpcy5lbmNvZGVNZXRhZGF0YShtZXRhZGF0YSkpOwogICAgICAgIGJvZHkuYXBwZW5kKCIiLCBmaWxlQm9keSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIEZvcm1EYXRhICE9PSAidW5kZWZpbmVkIiAmJiBmaWxlQm9keSBpbnN0YW5jZW9mIEZvcm1EYXRhKSB7CiAgICAgICAgYm9keSA9IGZpbGVCb2R5OwogICAgICAgIGlmICghYm9keS5oYXMoImNhY2hlQ29udHJvbCIpKSBib2R5LmFwcGVuZCgiY2FjaGVDb250cm9sIiwgb3B0aW9ucy5jYWNoZUNvbnRyb2wpOwogICAgICAgIGlmIChtZXRhZGF0YSAmJiAhYm9keS5oYXMoIm1ldGFkYXRhIikpIGJvZHkuYXBwZW5kKCJtZXRhZGF0YSIsIF90aGlzLmVuY29kZU1ldGFkYXRhKG1ldGFkYXRhKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYm9keSA9IGZpbGVCb2R5OwogICAgICAgIGhlYWRlcnNbImNhY2hlLWNvbnRyb2wiXSA9IGBtYXgtYWdlPSR7b3B0aW9ucy5jYWNoZUNvbnRyb2x9YDsKICAgICAgICBoZWFkZXJzWyJjb250ZW50LXR5cGUiXSA9IG9wdGlvbnMuY29udGVudFR5cGU7CiAgICAgICAgaWYgKG1ldGFkYXRhKSBoZWFkZXJzWyJ4LW1ldGFkYXRhIl0gPSBfdGhpcy50b0Jhc2U2NChfdGhpcy5lbmNvZGVNZXRhZGF0YShtZXRhZGF0YSkpOwogICAgICAgIGlmICgodHlwZW9mIFJlYWRhYmxlU3RyZWFtICE9PSAidW5kZWZpbmVkIiAmJiBib2R5IGluc3RhbmNlb2YgUmVhZGFibGVTdHJlYW0gfHwgYm9keSAmJiB0eXBlb2YgYm9keSA9PT0gIm9iamVjdCIgJiYgInBpcGUiIGluIGJvZHkgJiYgdHlwZW9mIGJvZHkucGlwZSA9PT0gImZ1bmN0aW9uIikgJiYgIW9wdGlvbnMuZHVwbGV4KSBvcHRpb25zLmR1cGxleCA9ICJoYWxmIjsKICAgICAgfQogICAgICBpZiAoZmlsZU9wdGlvbnMgPT09IG51bGwgfHwgZmlsZU9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGZpbGVPcHRpb25zLmhlYWRlcnMpIGhlYWRlcnMgPSBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIGhlYWRlcnMpLCBmaWxlT3B0aW9ucy5oZWFkZXJzKTsKICAgICAgY29uc3QgY2xlYW5QYXRoID0gX3RoaXMuX3JlbW92ZUVtcHR5Rm9sZGVycyhwYXRoMik7CiAgICAgIGNvbnN0IF9wYXRoID0gX3RoaXMuX2dldEZpbmFsUGF0aChjbGVhblBhdGgpOwogICAgICBjb25zdCBkYXRhID0gYXdhaXQgKG1ldGhvZCA9PSAiUFVUIiA/IHB1dCA6IHBvc3QpKF90aGlzLmZldGNoLCBgJHtfdGhpcy51cmx9L29iamVjdC8ke19wYXRofWAsIGJvZHksIF9vYmplY3RTcHJlYWQyMTEoeyBoZWFkZXJzIH0sIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuZHVwbGV4KSA/IHsgZHVwbGV4OiBvcHRpb25zLmR1cGxleCB9IDoge30pKTsKICAgICAgcmV0dXJuIHsKICAgICAgICBwYXRoOiBjbGVhblBhdGgsCiAgICAgICAgaWQ6IGRhdGEuSWQsCiAgICAgICAgZnVsbFBhdGg6IGRhdGEuS2V5CiAgICAgIH07CiAgICB9KTsKICB9CiAgLyoqCiAgKiBVcGxvYWRzIGEgZmlsZSB0byBhbiBleGlzdGluZyBidWNrZXQuCiAgKgogICogQGNhdGVnb3J5IEZpbGUgQnVja2V0cwogICogQHBhcmFtIHBhdGggVGhlIGZpbGUgcGF0aCwgaW5jbHVkaW5nIHRoZSBmaWxlIG5hbWUuIFNob3VsZCBiZSBvZiB0aGUgZm9ybWF0IGBmb2xkZXIvc3ViZm9sZGVyL2ZpbGVuYW1lLnBuZ2AuIFRoZSBidWNrZXQgbXVzdCBhbHJlYWR5IGV4aXN0IGJlZm9yZSBhdHRlbXB0aW5nIHRvIHVwbG9hZC4KICAqIEBwYXJhbSBmaWxlQm9keSBUaGUgYm9keSBvZiB0aGUgZmlsZSB0byBiZSBzdG9yZWQgaW4gdGhlIGJ1Y2tldC4KICAqIEBwYXJhbSBmaWxlT3B0aW9ucyBPcHRpb25hbCBmaWxlIHVwbG9hZCBvcHRpb25zIGluY2x1ZGluZyBjYWNoZUNvbnRyb2wsIGNvbnRlbnRUeXBlLCB1cHNlcnQsIGFuZCBtZXRhZGF0YS4KICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIGZpbGUgcGF0aCwgaWQsIGFuZCBmdWxsUGF0aCBvciBlcnJvcgogICoKICAqIEBleGFtcGxlIFVwbG9hZCBmaWxlCiAgKiBgYGBqcwogICogY29uc3QgYXZhdGFyRmlsZSA9IGV2ZW50LnRhcmdldC5maWxlc1swXQogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmZyb20oJ2F2YXRhcnMnKQogICogICAudXBsb2FkKCdwdWJsaWMvYXZhdGFyMS5wbmcnLCBhdmF0YXJGaWxlLCB7CiAgKiAgICAgY2FjaGVDb250cm9sOiAnMzYwMCcsCiAgKiAgICAgdXBzZXJ0OiBmYWxzZQogICogICB9KQogICogYGBgCiAgKgogICogUmVzcG9uc2U6CiAgKiBgYGBqc29uCiAgKiB7CiAgKiAgICJkYXRhIjogewogICogICAgICJwYXRoIjogInB1YmxpYy9hdmF0YXIxLnBuZyIsCiAgKiAgICAgImZ1bGxQYXRoIjogImF2YXRhcnMvcHVibGljL2F2YXRhcjEucG5nIgogICogICB9LAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqCiAgKiBAZXhhbXBsZSBVcGxvYWQgZmlsZSB1c2luZyBgQXJyYXlCdWZmZXJgIGZyb20gYmFzZTY0IGZpbGUgZGF0YQogICogYGBganMKICAqIGltcG9ydCB7IGRlY29kZSB9IGZyb20gJ2Jhc2U2NC1hcnJheWJ1ZmZlcicKICAqCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZnJvbSgnYXZhdGFycycpCiAgKiAgIC51cGxvYWQoJ3B1YmxpYy9hdmF0YXIxLnBuZycsIGRlY29kZSgnYmFzZTY0RmlsZURhdGEnKSwgewogICogICAgIGNvbnRlbnRUeXBlOiAnaW1hZ2UvcG5nJwogICogICB9KQogICogYGBgCiAgKi8KICBhc3luYyB1cGxvYWQocGF0aDIsIGZpbGVCb2R5LCBmaWxlT3B0aW9ucykgewogICAgcmV0dXJuIHRoaXMudXBsb2FkT3JVcGRhdGUoIlBPU1QiLCBwYXRoMiwgZmlsZUJvZHksIGZpbGVPcHRpb25zKTsKICB9CiAgLyoqCiAgKiBVcGxvYWQgYSBmaWxlIHdpdGggYSB0b2tlbiBnZW5lcmF0ZWQgZnJvbSBgY3JlYXRlU2lnbmVkVXBsb2FkVXJsYC4KICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gcGF0aCBUaGUgZmlsZSBwYXRoLCBpbmNsdWRpbmcgdGhlIGZpbGUgbmFtZS4gU2hvdWxkIGJlIG9mIHRoZSBmb3JtYXQgYGZvbGRlci9zdWJmb2xkZXIvZmlsZW5hbWUucG5nYC4gVGhlIGJ1Y2tldCBtdXN0IGFscmVhZHkgZXhpc3QgYmVmb3JlIGF0dGVtcHRpbmcgdG8gdXBsb2FkLgogICogQHBhcmFtIHRva2VuIFRoZSB0b2tlbiBnZW5lcmF0ZWQgZnJvbSBgY3JlYXRlU2lnbmVkVXBsb2FkVXJsYAogICogQHBhcmFtIGZpbGVCb2R5IFRoZSBib2R5IG9mIHRoZSBmaWxlIHRvIGJlIHN0b3JlZCBpbiB0aGUgYnVja2V0LgogICogQHBhcmFtIGZpbGVPcHRpb25zIEhUVFAgaGVhZGVycyAoY2FjaGVDb250cm9sLCBjb250ZW50VHlwZSwgZXRjLikuCiAgKiAqKk5vdGU6KiogVGhlIGB1cHNlcnRgIG9wdGlvbiBoYXMgbm8gZWZmZWN0IGhlcmUuIFRvIGVuYWJsZSB1cHNlcnQgYmVoYXZpb3IsCiAgKiBwYXNzIGB7IHVwc2VydDogdHJ1ZSB9YCB3aGVuIGNhbGxpbmcgYGNyZWF0ZVNpZ25lZFVwbG9hZFVybCgpYCBpbnN0ZWFkLgogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIHJlc3BvbnNlIGNvbnRhaW5pbmcgZmlsZSBwYXRoIGFuZCBmdWxsUGF0aCBvciBlcnJvcgogICoKICAqIEBleGFtcGxlIFVwbG9hZCB0byBhIHNpZ25lZCBVUkwKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZnJvbSgnYXZhdGFycycpCiAgKiAgIC51cGxvYWRUb1NpZ25lZFVybCgnZm9sZGVyL2NhdC5qcGcnLCAndG9rZW4tZnJvbS1jcmVhdGVTaWduZWRVcGxvYWRVcmwnLCBmaWxlKQogICogYGBgCiAgKgogICogUmVzcG9uc2U6CiAgKiBgYGBqc29uCiAgKiB7CiAgKiAgICJkYXRhIjogewogICogICAgICJwYXRoIjogImZvbGRlci9jYXQuanBnIiwKICAqICAgICAiZnVsbFBhdGgiOiAiYXZhdGFycy9mb2xkZXIvY2F0LmpwZyIKICAqICAgfSwKICAqICAgImVycm9yIjogbnVsbAogICogfQogICogYGBgCiAgKi8KICBhc3luYyB1cGxvYWRUb1NpZ25lZFVybChwYXRoMiwgdG9rZW4sIGZpbGVCb2R5LCBmaWxlT3B0aW9ucykgewogICAgdmFyIF90aGlzMyA9IHRoaXM7CiAgICBjb25zdCBjbGVhblBhdGggPSBfdGhpczMuX3JlbW92ZUVtcHR5Rm9sZGVycyhwYXRoMik7CiAgICBjb25zdCBfcGF0aCA9IF90aGlzMy5fZ2V0RmluYWxQYXRoKGNsZWFuUGF0aCk7CiAgICBjb25zdCB1cmwgPSBuZXcgVVJMKF90aGlzMy51cmwgKyBgL29iamVjdC91cGxvYWQvc2lnbi8ke19wYXRofWApOwogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoInRva2VuIiwgdG9rZW4pOwogICAgcmV0dXJuIF90aGlzMy5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICBsZXQgYm9keTsKICAgICAgY29uc3Qgb3B0aW9ucyA9IF9vYmplY3RTcHJlYWQyMTEoeyB1cHNlcnQ6IERFRkFVTFRfRklMRV9PUFRJT05TLnVwc2VydCB9LCBmaWxlT3B0aW9ucyk7CiAgICAgIGNvbnN0IGhlYWRlcnMgPSBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIF90aGlzMy5oZWFkZXJzKSwgeyAieC11cHNlcnQiOiBTdHJpbmcob3B0aW9ucy51cHNlcnQpIH0pOwogICAgICBpZiAodHlwZW9mIEJsb2IgIT09ICJ1bmRlZmluZWQiICYmIGZpbGVCb2R5IGluc3RhbmNlb2YgQmxvYikgewogICAgICAgIGJvZHkgPSBuZXcgRm9ybURhdGEoKTsKICAgICAgICBib2R5LmFwcGVuZCgiY2FjaGVDb250cm9sIiwgb3B0aW9ucy5jYWNoZUNvbnRyb2wpOwogICAgICAgIGJvZHkuYXBwZW5kKCIiLCBmaWxlQm9keSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIEZvcm1EYXRhICE9PSAidW5kZWZpbmVkIiAmJiBmaWxlQm9keSBpbnN0YW5jZW9mIEZvcm1EYXRhKSB7CiAgICAgICAgYm9keSA9IGZpbGVCb2R5OwogICAgICAgIGJvZHkuYXBwZW5kKCJjYWNoZUNvbnRyb2wiLCBvcHRpb25zLmNhY2hlQ29udHJvbCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYm9keSA9IGZpbGVCb2R5OwogICAgICAgIGhlYWRlcnNbImNhY2hlLWNvbnRyb2wiXSA9IGBtYXgtYWdlPSR7b3B0aW9ucy5jYWNoZUNvbnRyb2x9YDsKICAgICAgICBoZWFkZXJzWyJjb250ZW50LXR5cGUiXSA9IG9wdGlvbnMuY29udGVudFR5cGU7CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBwYXRoOiBjbGVhblBhdGgsCiAgICAgICAgZnVsbFBhdGg6IChhd2FpdCBwdXQoX3RoaXMzLmZldGNoLCB1cmwudG9TdHJpbmcoKSwgYm9keSwgeyBoZWFkZXJzIH0pKS5LZXkKICAgICAgfTsKICAgIH0pOwogIH0KICAvKioKICAqIENyZWF0ZXMgYSBzaWduZWQgdXBsb2FkIFVSTC4KICAqIFNpZ25lZCB1cGxvYWQgVVJMcyBjYW4gYmUgdXNlZCB0byB1cGxvYWQgZmlsZXMgdG8gdGhlIGJ1Y2tldCB3aXRob3V0IGZ1cnRoZXIgYXV0aGVudGljYXRpb24uCiAgKiBUaGV5IGFyZSB2YWxpZCBmb3IgMiBob3Vycy4KICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gcGF0aCBUaGUgZmlsZSBwYXRoLCBpbmNsdWRpbmcgdGhlIGN1cnJlbnQgZmlsZSBuYW1lLiBGb3IgZXhhbXBsZSBgZm9sZGVyL2ltYWdlLnBuZ2AuCiAgKiBAcGFyYW0gb3B0aW9ucy51cHNlcnQgSWYgc2V0IHRvIHRydWUsIGFsbG93cyB0aGUgZmlsZSB0byBiZSBvdmVyd3JpdHRlbiBpZiBpdCBhbHJlYWR5IGV4aXN0cy4KICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIHNpZ25lZCB1cGxvYWQgVVJMLCB0b2tlbiwgYW5kIHBhdGggb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZSBDcmVhdGUgU2lnbmVkIFVwbG9hZCBVUkwKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZnJvbSgnYXZhdGFycycpCiAgKiAgIC5jcmVhdGVTaWduZWRVcGxvYWRVcmwoJ2ZvbGRlci9jYXQuanBnJykKICAqIGBgYAogICoKICAqIFJlc3BvbnNlOgogICogYGBganNvbgogICogewogICogICAiZGF0YSI6IHsKICAqICAgICAic2lnbmVkVXJsIjogImh0dHBzOi8vZXhhbXBsZS5zdXBhYmFzZS5jby9zdG9yYWdlL3YxL29iamVjdC91cGxvYWQvc2lnbi9hdmF0YXJzL2ZvbGRlci9jYXQuanBnP3Rva2VuPTxUT0tFTj4iLAogICogICAgICJwYXRoIjogImZvbGRlci9jYXQuanBnIiwKICAqICAgICAidG9rZW4iOiAiPFRPS0VOPiIKICAqICAgfSwKICAqICAgImVycm9yIjogbnVsbAogICogfQogICogYGBgCiAgKi8KICBhc3luYyBjcmVhdGVTaWduZWRVcGxvYWRVcmwocGF0aDIsIG9wdGlvbnMpIHsKICAgIHZhciBfdGhpczQgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzNC5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICBsZXQgX3BhdGggPSBfdGhpczQuX2dldEZpbmFsUGF0aChwYXRoMik7CiAgICAgIGNvbnN0IGhlYWRlcnMgPSBfb2JqZWN0U3ByZWFkMjExKHt9LCBfdGhpczQuaGVhZGVycyk7CiAgICAgIGlmIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMudXBzZXJ0KSBoZWFkZXJzWyJ4LXVwc2VydCJdID0gInRydWUiOwogICAgICBjb25zdCBkYXRhID0gYXdhaXQgcG9zdChfdGhpczQuZmV0Y2gsIGAke190aGlzNC51cmx9L29iamVjdC91cGxvYWQvc2lnbi8ke19wYXRofWAsIHt9LCB7IGhlYWRlcnMgfSk7CiAgICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoX3RoaXM0LnVybCArIGRhdGEudXJsKTsKICAgICAgY29uc3QgdG9rZW4gPSB1cmwuc2VhcmNoUGFyYW1zLmdldCgidG9rZW4iKTsKICAgICAgaWYgKCF0b2tlbikgdGhyb3cgbmV3IFN0b3JhZ2VFcnJvcigiTm8gdG9rZW4gcmV0dXJuZWQgYnkgQVBJIik7CiAgICAgIHJldHVybiB7CiAgICAgICAgc2lnbmVkVXJsOiB1cmwudG9TdHJpbmcoKSwKICAgICAgICBwYXRoOiBwYXRoMiwKICAgICAgICB0b2tlbgogICAgICB9OwogICAgfSk7CiAgfQogIC8qKgogICogUmVwbGFjZXMgYW4gZXhpc3RpbmcgZmlsZSBhdCB0aGUgc3BlY2lmaWVkIHBhdGggd2l0aCBhIG5ldyBvbmUuCiAgKgogICogQGNhdGVnb3J5IEZpbGUgQnVja2V0cwogICogQHBhcmFtIHBhdGggVGhlIHJlbGF0aXZlIGZpbGUgcGF0aC4gU2hvdWxkIGJlIG9mIHRoZSBmb3JtYXQgYGZvbGRlci9zdWJmb2xkZXIvZmlsZW5hbWUucG5nYC4gVGhlIGJ1Y2tldCBtdXN0IGFscmVhZHkgZXhpc3QgYmVmb3JlIGF0dGVtcHRpbmcgdG8gdXBkYXRlLgogICogQHBhcmFtIGZpbGVCb2R5IFRoZSBib2R5IG9mIHRoZSBmaWxlIHRvIGJlIHN0b3JlZCBpbiB0aGUgYnVja2V0LgogICogQHBhcmFtIGZpbGVPcHRpb25zIE9wdGlvbmFsIGZpbGUgdXBsb2FkIG9wdGlvbnMgaW5jbHVkaW5nIGNhY2hlQ29udHJvbCwgY29udGVudFR5cGUsIHVwc2VydCwgYW5kIG1ldGFkYXRhLgogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIHJlc3BvbnNlIGNvbnRhaW5pbmcgZmlsZSBwYXRoLCBpZCwgYW5kIGZ1bGxQYXRoIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUgVXBkYXRlIGZpbGUKICAqIGBgYGpzCiAgKiBjb25zdCBhdmF0YXJGaWxlID0gZXZlbnQudGFyZ2V0LmZpbGVzWzBdCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZnJvbSgnYXZhdGFycycpCiAgKiAgIC51cGRhdGUoJ3B1YmxpYy9hdmF0YXIxLnBuZycsIGF2YXRhckZpbGUsIHsKICAqICAgICBjYWNoZUNvbnRyb2w6ICczNjAwJywKICAqICAgICB1cHNlcnQ6IHRydWUKICAqICAgfSkKICAqIGBgYAogICoKICAqIFJlc3BvbnNlOgogICogYGBganNvbgogICogewogICogICAiZGF0YSI6IHsKICAqICAgICAicGF0aCI6ICJwdWJsaWMvYXZhdGFyMS5wbmciLAogICogICAgICJmdWxsUGF0aCI6ICJhdmF0YXJzL3B1YmxpYy9hdmF0YXIxLnBuZyIKICAqICAgfSwKICAqICAgImVycm9yIjogbnVsbAogICogfQogICogYGBgCiAgKgogICogQGV4YW1wbGUgVXBkYXRlIGZpbGUgdXNpbmcgYEFycmF5QnVmZmVyYCBmcm9tIGJhc2U2NCBmaWxlIGRhdGEKICAqIGBgYGpzCiAgKiBpbXBvcnQge2RlY29kZX0gZnJvbSAnYmFzZTY0LWFycmF5YnVmZmVyJwogICoKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLnVwZGF0ZSgncHVibGljL2F2YXRhcjEucG5nJywgZGVjb2RlKCdiYXNlNjRGaWxlRGF0YScpLCB7CiAgKiAgICAgY29udGVudFR5cGU6ICdpbWFnZS9wbmcnCiAgKiAgIH0pCiAgKiBgYGAKICAqLwogIGFzeW5jIHVwZGF0ZShwYXRoMiwgZmlsZUJvZHksIGZpbGVPcHRpb25zKSB7CiAgICByZXR1cm4gdGhpcy51cGxvYWRPclVwZGF0ZSgiUFVUIiwgcGF0aDIsIGZpbGVCb2R5LCBmaWxlT3B0aW9ucyk7CiAgfQogIC8qKgogICogTW92ZXMgYW4gZXhpc3RpbmcgZmlsZSB0byBhIG5ldyBwYXRoIGluIHRoZSBzYW1lIGJ1Y2tldC4KICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gZnJvbVBhdGggVGhlIG9yaWdpbmFsIGZpbGUgcGF0aCwgaW5jbHVkaW5nIHRoZSBjdXJyZW50IGZpbGUgbmFtZS4gRm9yIGV4YW1wbGUgYGZvbGRlci9pbWFnZS5wbmdgLgogICogQHBhcmFtIHRvUGF0aCBUaGUgbmV3IGZpbGUgcGF0aCwgaW5jbHVkaW5nIHRoZSBuZXcgZmlsZSBuYW1lLiBGb3IgZXhhbXBsZSBgZm9sZGVyL2ltYWdlLW5ldy5wbmdgLgogICogQHBhcmFtIG9wdGlvbnMgVGhlIGRlc3RpbmF0aW9uIG9wdGlvbnMuCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBzdWNjZXNzIG1lc3NhZ2Ugb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZSBNb3ZlIGZpbGUKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZnJvbSgnYXZhdGFycycpCiAgKiAgIC5tb3ZlKCdwdWJsaWMvYXZhdGFyMS5wbmcnLCAncHJpdmF0ZS9hdmF0YXIyLnBuZycpCiAgKiBgYGAKICAqCiAgKiBSZXNwb25zZToKICAqIGBgYGpzb24KICAqIHsKICAqICAgImRhdGEiOiB7CiAgKiAgICAgIm1lc3NhZ2UiOiAiU3VjY2Vzc2Z1bGx5IG1vdmVkIgogICogICB9LAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqLwogIGFzeW5jIG1vdmUoZnJvbVBhdGgsIHRvUGF0aCwgb3B0aW9ucykgewogICAgdmFyIF90aGlzNiA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXM2LmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCBwb3N0KF90aGlzNi5mZXRjaCwgYCR7X3RoaXM2LnVybH0vb2JqZWN0L21vdmVgLCB7CiAgICAgICAgYnVja2V0SWQ6IF90aGlzNi5idWNrZXRJZCwKICAgICAgICBzb3VyY2VLZXk6IGZyb21QYXRoLAogICAgICAgIGRlc3RpbmF0aW9uS2V5OiB0b1BhdGgsCiAgICAgICAgZGVzdGluYXRpb25CdWNrZXQ6IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5kZXN0aW5hdGlvbkJ1Y2tldAogICAgICB9LCB7IGhlYWRlcnM6IF90aGlzNi5oZWFkZXJzIH0pOwogICAgfSk7CiAgfQogIC8qKgogICogQ29waWVzIGFuIGV4aXN0aW5nIGZpbGUgdG8gYSBuZXcgcGF0aCBpbiB0aGUgc2FtZSBidWNrZXQuCiAgKgogICogQGNhdGVnb3J5IEZpbGUgQnVja2V0cwogICogQHBhcmFtIGZyb21QYXRoIFRoZSBvcmlnaW5hbCBmaWxlIHBhdGgsIGluY2x1ZGluZyB0aGUgY3VycmVudCBmaWxlIG5hbWUuIEZvciBleGFtcGxlIGBmb2xkZXIvaW1hZ2UucG5nYC4KICAqIEBwYXJhbSB0b1BhdGggVGhlIG5ldyBmaWxlIHBhdGgsIGluY2x1ZGluZyB0aGUgbmV3IGZpbGUgbmFtZS4gRm9yIGV4YW1wbGUgYGZvbGRlci9pbWFnZS1jb3B5LnBuZ2AuCiAgKiBAcGFyYW0gb3B0aW9ucyBUaGUgZGVzdGluYXRpb24gb3B0aW9ucy4KICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIGNvcGllZCBmaWxlIHBhdGggb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZSBDb3B5IGZpbGUKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZnJvbSgnYXZhdGFycycpCiAgKiAgIC5jb3B5KCdwdWJsaWMvYXZhdGFyMS5wbmcnLCAncHJpdmF0ZS9hdmF0YXIyLnBuZycpCiAgKiBgYGAKICAqCiAgKiBSZXNwb25zZToKICAqIGBgYGpzb24KICAqIHsKICAqICAgImRhdGEiOiB7CiAgKiAgICAgInBhdGgiOiAiYXZhdGFycy9wcml2YXRlL2F2YXRhcjIucG5nIgogICogICB9LAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqLwogIGFzeW5jIGNvcHkoZnJvbVBhdGgsIHRvUGF0aCwgb3B0aW9ucykgewogICAgdmFyIF90aGlzNyA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXM3LmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiB7IHBhdGg6IChhd2FpdCBwb3N0KF90aGlzNy5mZXRjaCwgYCR7X3RoaXM3LnVybH0vb2JqZWN0L2NvcHlgLCB7CiAgICAgICAgYnVja2V0SWQ6IF90aGlzNy5idWNrZXRJZCwKICAgICAgICBzb3VyY2VLZXk6IGZyb21QYXRoLAogICAgICAgIGRlc3RpbmF0aW9uS2V5OiB0b1BhdGgsCiAgICAgICAgZGVzdGluYXRpb25CdWNrZXQ6IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5kZXN0aW5hdGlvbkJ1Y2tldAogICAgICB9LCB7IGhlYWRlcnM6IF90aGlzNy5oZWFkZXJzIH0pKS5LZXkgfTsKICAgIH0pOwogIH0KICAvKioKICAqIENyZWF0ZXMgYSBzaWduZWQgVVJMLiBVc2UgYSBzaWduZWQgVVJMIHRvIHNoYXJlIGEgZmlsZSBmb3IgYSBmaXhlZCBhbW91bnQgb2YgdGltZS4KICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gcGF0aCBUaGUgZmlsZSBwYXRoLCBpbmNsdWRpbmcgdGhlIGN1cnJlbnQgZmlsZSBuYW1lLiBGb3IgZXhhbXBsZSBgZm9sZGVyL2ltYWdlLnBuZ2AuCiAgKiBAcGFyYW0gZXhwaXJlc0luIFRoZSBudW1iZXIgb2Ygc2Vjb25kcyB1bnRpbCB0aGUgc2lnbmVkIFVSTCBleHBpcmVzLiBGb3IgZXhhbXBsZSwgYDYwYCBmb3IgYSBVUkwgd2hpY2ggaXMgdmFsaWQgZm9yIG9uZSBtaW51dGUuCiAgKiBAcGFyYW0gb3B0aW9ucy5kb3dubG9hZCB0cmlnZ2VycyB0aGUgZmlsZSBhcyBhIGRvd25sb2FkIGlmIHNldCB0byB0cnVlLiBTZXQgdGhpcyBwYXJhbWV0ZXIgYXMgdGhlIG5hbWUgb2YgdGhlIGZpbGUgaWYgeW91IHdhbnQgdG8gdHJpZ2dlciB0aGUgZG93bmxvYWQgd2l0aCBhIGRpZmZlcmVudCBmaWxlbmFtZS4KICAqIEBwYXJhbSBvcHRpb25zLnRyYW5zZm9ybSBUcmFuc2Zvcm0gdGhlIGFzc2V0IGJlZm9yZSBzZXJ2aW5nIGl0IHRvIHRoZSBjbGllbnQuCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBzaWduZWQgVVJMIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUgQ3JlYXRlIFNpZ25lZCBVUkwKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZnJvbSgnYXZhdGFycycpCiAgKiAgIC5jcmVhdGVTaWduZWRVcmwoJ2ZvbGRlci9hdmF0YXIxLnBuZycsIDYwKQogICogYGBgCiAgKgogICogUmVzcG9uc2U6CiAgKiBgYGBqc29uCiAgKiB7CiAgKiAgICJkYXRhIjogewogICogICAgICJzaWduZWRVcmwiOiAiaHR0cHM6Ly9leGFtcGxlLnN1cGFiYXNlLmNvL3N0b3JhZ2UvdjEvb2JqZWN0L3NpZ24vYXZhdGFycy9mb2xkZXIvYXZhdGFyMS5wbmc/dG9rZW49PFRPS0VOPiIKICAqICAgfSwKICAqICAgImVycm9yIjogbnVsbAogICogfQogICogYGBgCiAgKgogICogQGV4YW1wbGUgQ3JlYXRlIGEgc2lnbmVkIFVSTCBmb3IgYW4gYXNzZXQgd2l0aCB0cmFuc2Zvcm1hdGlvbnMKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLmNyZWF0ZVNpZ25lZFVybCgnZm9sZGVyL2F2YXRhcjEucG5nJywgNjAsIHsKICAqICAgICB0cmFuc2Zvcm06IHsKICAqICAgICAgIHdpZHRoOiAxMDAsCiAgKiAgICAgICBoZWlnaHQ6IDEwMCwKICAqICAgICB9CiAgKiAgIH0pCiAgKiBgYGAKICAqCiAgKiBAZXhhbXBsZSBDcmVhdGUgYSBzaWduZWQgVVJMIHdoaWNoIHRyaWdnZXJzIHRoZSBkb3dubG9hZCBvZiB0aGUgYXNzZXQKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLmNyZWF0ZVNpZ25lZFVybCgnZm9sZGVyL2F2YXRhcjEucG5nJywgNjAsIHsKICAqICAgICBkb3dubG9hZDogdHJ1ZSwKICAqICAgfSkKICAqIGBgYAogICovCiAgYXN5bmMgY3JlYXRlU2lnbmVkVXJsKHBhdGgyLCBleHBpcmVzSW4sIG9wdGlvbnMpIHsKICAgIHZhciBfdGhpczggPSB0aGlzOwogICAgcmV0dXJuIF90aGlzOC5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICBsZXQgX3BhdGggPSBfdGhpczguX2dldEZpbmFsUGF0aChwYXRoMik7CiAgICAgIGxldCBkYXRhID0gYXdhaXQgcG9zdChfdGhpczguZmV0Y2gsIGAke190aGlzOC51cmx9L29iamVjdC9zaWduLyR7X3BhdGh9YCwgX29iamVjdFNwcmVhZDIxMSh7IGV4cGlyZXNJbiB9LCAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnRyYW5zZm9ybSkgPyB7IHRyYW5zZm9ybTogb3B0aW9ucy50cmFuc2Zvcm0gfSA6IHt9KSwgeyBoZWFkZXJzOiBfdGhpczguaGVhZGVycyB9KTsKICAgICAgY29uc3QgZG93bmxvYWRRdWVyeVBhcmFtID0gKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5kb3dubG9hZCkgPyBgJmRvd25sb2FkPSR7b3B0aW9ucy5kb3dubG9hZCA9PT0gdHJ1ZSA/ICIiIDogb3B0aW9ucy5kb3dubG9hZH1gIDogIiI7CiAgICAgIHJldHVybiB7IHNpZ25lZFVybDogZW5jb2RlVVJJKGAke190aGlzOC51cmx9JHtkYXRhLnNpZ25lZFVSTH0ke2Rvd25sb2FkUXVlcnlQYXJhbX1gKSB9OwogICAgfSk7CiAgfQogIC8qKgogICogQ3JlYXRlcyBtdWx0aXBsZSBzaWduZWQgVVJMcy4gVXNlIGEgc2lnbmVkIFVSTCB0byBzaGFyZSBhIGZpbGUgZm9yIGEgZml4ZWQgYW1vdW50IG9mIHRpbWUuCiAgKgogICogQGNhdGVnb3J5IEZpbGUgQnVja2V0cwogICogQHBhcmFtIHBhdGhzIFRoZSBmaWxlIHBhdGhzIHRvIGJlIGRvd25sb2FkZWQsIGluY2x1ZGluZyB0aGUgY3VycmVudCBmaWxlIG5hbWVzLiBGb3IgZXhhbXBsZSBgWydmb2xkZXIvaW1hZ2UucG5nJywgJ2ZvbGRlcjIvaW1hZ2UyLnBuZyddYC4KICAqIEBwYXJhbSBleHBpcmVzSW4gVGhlIG51bWJlciBvZiBzZWNvbmRzIHVudGlsIHRoZSBzaWduZWQgVVJMcyBleHBpcmUuIEZvciBleGFtcGxlLCBgNjBgIGZvciBVUkxzIHdoaWNoIGFyZSB2YWxpZCBmb3Igb25lIG1pbnV0ZS4KICAqIEBwYXJhbSBvcHRpb25zLmRvd25sb2FkIHRyaWdnZXJzIHRoZSBmaWxlIGFzIGEgZG93bmxvYWQgaWYgc2V0IHRvIHRydWUuIFNldCB0aGlzIHBhcmFtZXRlciBhcyB0aGUgbmFtZSBvZiB0aGUgZmlsZSBpZiB5b3Ugd2FudCB0byB0cmlnZ2VyIHRoZSBkb3dubG9hZCB3aXRoIGEgZGlmZmVyZW50IGZpbGVuYW1lLgogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIHJlc3BvbnNlIGNvbnRhaW5pbmcgYXJyYXkgb2Ygb2JqZWN0cyB3aXRoIHNpZ25lZFVybCwgcGF0aCwgYW5kIGVycm9yIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUgQ3JlYXRlIFNpZ25lZCBVUkxzCiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmZyb20oJ2F2YXRhcnMnKQogICogICAuY3JlYXRlU2lnbmVkVXJscyhbJ2ZvbGRlci9hdmF0YXIxLnBuZycsICdmb2xkZXIvYXZhdGFyMi5wbmcnXSwgNjApCiAgKiBgYGAKICAqCiAgKiBSZXNwb25zZToKICAqIGBgYGpzb24KICAqIHsKICAqICAgImRhdGEiOiBbCiAgKiAgICAgewogICogICAgICAgImVycm9yIjogbnVsbCwKICAqICAgICAgICJwYXRoIjogImZvbGRlci9hdmF0YXIxLnBuZyIsCiAgKiAgICAgICAic2lnbmVkVVJMIjogIi9vYmplY3Qvc2lnbi9hdmF0YXJzL2ZvbGRlci9hdmF0YXIxLnBuZz90b2tlbj08VE9LRU4+IiwKICAqICAgICAgICJzaWduZWRVcmwiOiAiaHR0cHM6Ly9leGFtcGxlLnN1cGFiYXNlLmNvL3N0b3JhZ2UvdjEvb2JqZWN0L3NpZ24vYXZhdGFycy9mb2xkZXIvYXZhdGFyMS5wbmc/dG9rZW49PFRPS0VOPiIKICAqICAgICB9LAogICogICAgIHsKICAqICAgICAgICJlcnJvciI6IG51bGwsCiAgKiAgICAgICAicGF0aCI6ICJmb2xkZXIvYXZhdGFyMi5wbmciLAogICogICAgICAgInNpZ25lZFVSTCI6ICIvb2JqZWN0L3NpZ24vYXZhdGFycy9mb2xkZXIvYXZhdGFyMi5wbmc/dG9rZW49PFRPS0VOPiIsCiAgKiAgICAgICAic2lnbmVkVXJsIjogImh0dHBzOi8vZXhhbXBsZS5zdXBhYmFzZS5jby9zdG9yYWdlL3YxL29iamVjdC9zaWduL2F2YXRhcnMvZm9sZGVyL2F2YXRhcjIucG5nP3Rva2VuPTxUT0tFTj4iCiAgKiAgICAgfQogICogICBdLAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqLwogIGFzeW5jIGNyZWF0ZVNpZ25lZFVybHMocGF0aHMsIGV4cGlyZXNJbiwgb3B0aW9ucykgewogICAgdmFyIF90aGlzOSA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXM5LmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBwb3N0KF90aGlzOS5mZXRjaCwgYCR7X3RoaXM5LnVybH0vb2JqZWN0L3NpZ24vJHtfdGhpczkuYnVja2V0SWR9YCwgewogICAgICAgIGV4cGlyZXNJbiwKICAgICAgICBwYXRocwogICAgICB9LCB7IGhlYWRlcnM6IF90aGlzOS5oZWFkZXJzIH0pOwogICAgICBjb25zdCBkb3dubG9hZFF1ZXJ5UGFyYW0gPSAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmRvd25sb2FkKSA/IGAmZG93bmxvYWQ9JHtvcHRpb25zLmRvd25sb2FkID09PSB0cnVlID8gIiIgOiBvcHRpb25zLmRvd25sb2FkfWAgOiAiIjsKICAgICAgcmV0dXJuIGRhdGEubWFwKChkYXR1bSkgPT4gX29iamVjdFNwcmVhZDIxMShfb2JqZWN0U3ByZWFkMjExKHt9LCBkYXR1bSksIHt9LCB7IHNpZ25lZFVybDogZGF0dW0uc2lnbmVkVVJMID8gZW5jb2RlVVJJKGAke190aGlzOS51cmx9JHtkYXR1bS5zaWduZWRVUkx9JHtkb3dubG9hZFF1ZXJ5UGFyYW19YCkgOiBudWxsIH0pKTsKICAgIH0pOwogIH0KICAvKioKICAqIERvd25sb2FkcyBhIGZpbGUgZnJvbSBhIHByaXZhdGUgYnVja2V0LiBGb3IgcHVibGljIGJ1Y2tldHMsIG1ha2UgYSByZXF1ZXN0IHRvIHRoZSBVUkwgcmV0dXJuZWQgZnJvbSBgZ2V0UHVibGljVXJsYCBpbnN0ZWFkLgogICoKICAqIEBjYXRlZ29yeSBGaWxlIEJ1Y2tldHMKICAqIEBwYXJhbSBwYXRoIFRoZSBmdWxsIHBhdGggYW5kIGZpbGUgbmFtZSBvZiB0aGUgZmlsZSB0byBiZSBkb3dubG9hZGVkLiBGb3IgZXhhbXBsZSBgZm9sZGVyL2ltYWdlLnBuZ2AuCiAgKiBAcGFyYW0gb3B0aW9ucy50cmFuc2Zvcm0gVHJhbnNmb3JtIHRoZSBhc3NldCBiZWZvcmUgc2VydmluZyBpdCB0byB0aGUgY2xpZW50LgogICogQHBhcmFtIHBhcmFtZXRlcnMgQWRkaXRpb25hbCBmZXRjaCBwYXJhbWV0ZXJzIGxpa2Ugc2lnbmFsIGZvciBjYW5jZWxsYXRpb24uIFN1cHBvcnRzIHN0YW5kYXJkIGZldGNoIG9wdGlvbnMgaW5jbHVkaW5nIGNhY2hlIGNvbnRyb2wuCiAgKiBAcmV0dXJucyBCbG9iRG93bmxvYWRCdWlsZGVyIGluc3RhbmNlIGZvciBkb3dubG9hZGluZyB0aGUgZmlsZQogICoKICAqIEBleGFtcGxlIERvd25sb2FkIGZpbGUKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZnJvbSgnYXZhdGFycycpCiAgKiAgIC5kb3dubG9hZCgnZm9sZGVyL2F2YXRhcjEucG5nJykKICAqIGBgYAogICoKICAqIFJlc3BvbnNlOgogICogYGBganNvbgogICogewogICogICAiZGF0YSI6IDxCTE9CPiwKICAqICAgImVycm9yIjogbnVsbAogICogfQogICogYGBgCiAgKgogICogQGV4YW1wbGUgRG93bmxvYWQgZmlsZSB3aXRoIHRyYW5zZm9ybWF0aW9ucwogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLmRvd25sb2FkKCdmb2xkZXIvYXZhdGFyMS5wbmcnLCB7CiAgKiAgICAgdHJhbnNmb3JtOiB7CiAgKiAgICAgICB3aWR0aDogMTAwLAogICogICAgICAgaGVpZ2h0OiAxMDAsCiAgKiAgICAgICBxdWFsaXR5OiA4MAogICogICAgIH0KICAqICAgfSkKICAqIGBgYAogICoKICAqIEBleGFtcGxlIERvd25sb2FkIHdpdGggY2FjaGUgY29udHJvbCAodXNlZnVsIGluIEVkZ2UgRnVuY3Rpb25zKQogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLmRvd25sb2FkKCdmb2xkZXIvYXZhdGFyMS5wbmcnLCB7fSwgeyBjYWNoZTogJ25vLXN0b3JlJyB9KQogICogYGBgCiAgKgogICogQGV4YW1wbGUgRG93bmxvYWQgd2l0aCBhYm9ydCBzaWduYWwKICAqIGBgYGpzCiAgKiBjb25zdCBjb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpCiAgKiBzZXRUaW1lb3V0KCgpID0+IGNvbnRyb2xsZXIuYWJvcnQoKSwgNTAwMCkKICAqCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZnJvbSgnYXZhdGFycycpCiAgKiAgIC5kb3dubG9hZCgnZm9sZGVyL2F2YXRhcjEucG5nJywge30sIHsgc2lnbmFsOiBjb250cm9sbGVyLnNpZ25hbCB9KQogICogYGBgCiAgKi8KICBkb3dubG9hZChwYXRoMiwgb3B0aW9ucywgcGFyYW1ldGVycykgewogICAgY29uc3QgcmVuZGVyUGF0aCA9IHR5cGVvZiAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnRyYW5zZm9ybSkgIT09ICJ1bmRlZmluZWQiID8gInJlbmRlci9pbWFnZS9hdXRoZW50aWNhdGVkIiA6ICJvYmplY3QiOwogICAgY29uc3QgdHJhbnNmb3JtYXRpb25RdWVyeSA9IHRoaXMudHJhbnNmb3JtT3B0c1RvUXVlcnlTdHJpbmcoKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy50cmFuc2Zvcm0pIHx8IHt9KTsKICAgIGNvbnN0IHF1ZXJ5U3RyaW5nID0gdHJhbnNmb3JtYXRpb25RdWVyeSA/IGA/JHt0cmFuc2Zvcm1hdGlvblF1ZXJ5fWAgOiAiIjsKICAgIGNvbnN0IF9wYXRoID0gdGhpcy5fZ2V0RmluYWxQYXRoKHBhdGgyKTsKICAgIGNvbnN0IGRvd25sb2FkRm4gPSAoKSA9PiBnZXQ1KHRoaXMuZmV0Y2gsIGAke3RoaXMudXJsfS8ke3JlbmRlclBhdGh9LyR7X3BhdGh9JHtxdWVyeVN0cmluZ31gLCB7CiAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgbm9SZXNvbHZlSnNvbjogdHJ1ZQogICAgfSwgcGFyYW1ldGVycyk7CiAgICByZXR1cm4gbmV3IEJsb2JEb3dubG9hZEJ1aWxkZXIoZG93bmxvYWRGbiwgdGhpcy5zaG91bGRUaHJvd09uRXJyb3IpOwogIH0KICAvKioKICAqIFJldHJpZXZlcyB0aGUgZGV0YWlscyBvZiBhbiBleGlzdGluZyBmaWxlLgogICoKICAqIEBjYXRlZ29yeSBGaWxlIEJ1Y2tldHMKICAqIEBwYXJhbSBwYXRoIFRoZSBmaWxlIHBhdGgsIGluY2x1ZGluZyB0aGUgZmlsZSBuYW1lLiBGb3IgZXhhbXBsZSBgZm9sZGVyL2ltYWdlLnBuZ2AuCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBmaWxlIG1ldGFkYXRhIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUgR2V0IGZpbGUgaW5mbwogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLmluZm8oJ2ZvbGRlci9hdmF0YXIxLnBuZycpCiAgKiBgYGAKICAqLwogIGFzeW5jIGluZm8ocGF0aDIpIHsKICAgIHZhciBfdGhpczEwID0gdGhpczsKICAgIGNvbnN0IF9wYXRoID0gX3RoaXMxMC5fZ2V0RmluYWxQYXRoKHBhdGgyKTsKICAgIHJldHVybiBfdGhpczEwLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiByZWN1cnNpdmVUb0NhbWVsKGF3YWl0IGdldDUoX3RoaXMxMC5mZXRjaCwgYCR7X3RoaXMxMC51cmx9L29iamVjdC9pbmZvLyR7X3BhdGh9YCwgeyBoZWFkZXJzOiBfdGhpczEwLmhlYWRlcnMgfSkpOwogICAgfSk7CiAgfQogIC8qKgogICogQ2hlY2tzIHRoZSBleGlzdGVuY2Ugb2YgYSBmaWxlLgogICoKICAqIEBjYXRlZ29yeSBGaWxlIEJ1Y2tldHMKICAqIEBwYXJhbSBwYXRoIFRoZSBmaWxlIHBhdGgsIGluY2x1ZGluZyB0aGUgZmlsZSBuYW1lLiBGb3IgZXhhbXBsZSBgZm9sZGVyL2ltYWdlLnBuZ2AuCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBib29sZWFuIGluZGljYXRpbmcgZmlsZSBleGlzdGVuY2Ugb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZSBDaGVjayBmaWxlIGV4aXN0ZW5jZQogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLmV4aXN0cygnZm9sZGVyL2F2YXRhcjEucG5nJykKICAqIGBgYAogICovCiAgYXN5bmMgZXhpc3RzKHBhdGgyKSB7CiAgICB2YXIgX3RoaXMxMSA9IHRoaXM7CiAgICBjb25zdCBfcGF0aCA9IF90aGlzMTEuX2dldEZpbmFsUGF0aChwYXRoMik7CiAgICB0cnkgewogICAgICBhd2FpdCBoZWFkKF90aGlzMTEuZmV0Y2gsIGAke190aGlzMTEudXJsfS9vYmplY3QvJHtfcGF0aH1gLCB7IGhlYWRlcnM6IF90aGlzMTEuaGVhZGVycyB9KTsKICAgICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiB0cnVlLAogICAgICAgIGVycm9yOiBudWxsCiAgICAgIH07CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoX3RoaXMxMS5zaG91bGRUaHJvd09uRXJyb3IpIHRocm93IGVycm9yOwogICAgICBpZiAoaXNTdG9yYWdlRXJyb3IoZXJyb3IpICYmIGVycm9yIGluc3RhbmNlb2YgU3RvcmFnZVVua25vd25FcnJvcikgewogICAgICAgIGNvbnN0IG9yaWdpbmFsRXJyb3IgPSBlcnJvci5vcmlnaW5hbEVycm9yOwogICAgICAgIGlmIChbNDAwLCA0MDRdLmluY2x1ZGVzKG9yaWdpbmFsRXJyb3IgPT09IG51bGwgfHwgb3JpZ2luYWxFcnJvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3JpZ2luYWxFcnJvci5zdGF0dXMpKSByZXR1cm4gewogICAgICAgICAgZGF0YTogZmFsc2UsCiAgICAgICAgICBlcnJvcgogICAgICAgIH07CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICogQSBzaW1wbGUgY29udmVuaWVuY2UgZnVuY3Rpb24gdG8gZ2V0IHRoZSBVUkwgZm9yIGFuIGFzc2V0IGluIGEgcHVibGljIGJ1Y2tldC4gSWYgeW91IGRvIG5vdCB3YW50IHRvIHVzZSB0aGlzIGZ1bmN0aW9uLCB5b3UgY2FuIGNvbnN0cnVjdCB0aGUgcHVibGljIFVSTCBieSBjb25jYXRlbmF0aW5nIHRoZSBidWNrZXQgVVJMIHdpdGggdGhlIHBhdGggdG8gdGhlIGFzc2V0LgogICogVGhpcyBmdW5jdGlvbiBkb2VzIG5vdCB2ZXJpZnkgaWYgdGhlIGJ1Y2tldCBpcyBwdWJsaWMuIElmIGEgcHVibGljIFVSTCBpcyBjcmVhdGVkIGZvciBhIGJ1Y2tldCB3aGljaCBpcyBub3QgcHVibGljLCB5b3Ugd2lsbCBub3QgYmUgYWJsZSB0byBkb3dubG9hZCB0aGUgYXNzZXQuCiAgKgogICogQGNhdGVnb3J5IEZpbGUgQnVja2V0cwogICogQHBhcmFtIHBhdGggVGhlIHBhdGggYW5kIG5hbWUgb2YgdGhlIGZpbGUgdG8gZ2VuZXJhdGUgdGhlIHB1YmxpYyBVUkwgZm9yLiBGb3IgZXhhbXBsZSBgZm9sZGVyL2ltYWdlLnBuZ2AuCiAgKiBAcGFyYW0gb3B0aW9ucy5kb3dubG9hZCBUcmlnZ2VycyB0aGUgZmlsZSBhcyBhIGRvd25sb2FkIGlmIHNldCB0byB0cnVlLiBTZXQgdGhpcyBwYXJhbWV0ZXIgYXMgdGhlIG5hbWUgb2YgdGhlIGZpbGUgaWYgeW91IHdhbnQgdG8gdHJpZ2dlciB0aGUgZG93bmxvYWQgd2l0aCBhIGRpZmZlcmVudCBmaWxlbmFtZS4KICAqIEBwYXJhbSBvcHRpb25zLnRyYW5zZm9ybSBUcmFuc2Zvcm0gdGhlIGFzc2V0IGJlZm9yZSBzZXJ2aW5nIGl0IHRvIHRoZSBjbGllbnQuCiAgKiBAcmV0dXJucyBPYmplY3Qgd2l0aCBwdWJsaWMgVVJMCiAgKgogICogQGV4YW1wbGUgUmV0dXJucyB0aGUgVVJMIGZvciBhbiBhc3NldCBpbiBhIHB1YmxpYyBidWNrZXQKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEgfSA9IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdwdWJsaWMtYnVja2V0JykKICAqICAgLmdldFB1YmxpY1VybCgnZm9sZGVyL2F2YXRhcjEucG5nJykKICAqIGBgYAogICoKICAqIFJlc3BvbnNlOgogICogYGBganNvbgogICogewogICogICAiZGF0YSI6IHsKICAqICAgICAicHVibGljVXJsIjogImh0dHBzOi8vZXhhbXBsZS5zdXBhYmFzZS5jby9zdG9yYWdlL3YxL29iamVjdC9wdWJsaWMvcHVibGljLWJ1Y2tldC9mb2xkZXIvYXZhdGFyMS5wbmciCiAgKiAgIH0KICAqIH0KICAqIGBgYAogICoKICAqIEBleGFtcGxlIFJldHVybnMgdGhlIFVSTCBmb3IgYW4gYXNzZXQgaW4gYSBwdWJsaWMgYnVja2V0IHdpdGggdHJhbnNmb3JtYXRpb25zCiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhIH0gPSBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZnJvbSgncHVibGljLWJ1Y2tldCcpCiAgKiAgIC5nZXRQdWJsaWNVcmwoJ2ZvbGRlci9hdmF0YXIxLnBuZycsIHsKICAqICAgICB0cmFuc2Zvcm06IHsKICAqICAgICAgIHdpZHRoOiAxMDAsCiAgKiAgICAgICBoZWlnaHQ6IDEwMCwKICAqICAgICB9CiAgKiAgIH0pCiAgKiBgYGAKICAqCiAgKiBAZXhhbXBsZSBSZXR1cm5zIHRoZSBVUkwgd2hpY2ggdHJpZ2dlcnMgdGhlIGRvd25sb2FkIG9mIGFuIGFzc2V0IGluIGEgcHVibGljIGJ1Y2tldAogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSB9ID0gc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmZyb20oJ3B1YmxpYy1idWNrZXQnKQogICogICAuZ2V0UHVibGljVXJsKCdmb2xkZXIvYXZhdGFyMS5wbmcnLCB7CiAgKiAgICAgZG93bmxvYWQ6IHRydWUsCiAgKiAgIH0pCiAgKiBgYGAKICAqLwogIGdldFB1YmxpY1VybChwYXRoMiwgb3B0aW9ucykgewogICAgY29uc3QgX3BhdGggPSB0aGlzLl9nZXRGaW5hbFBhdGgocGF0aDIpOwogICAgY29uc3QgX3F1ZXJ5U3RyaW5nID0gW107CiAgICBjb25zdCBkb3dubG9hZFF1ZXJ5UGFyYW0gPSAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmRvd25sb2FkKSA/IGBkb3dubG9hZD0ke29wdGlvbnMuZG93bmxvYWQgPT09IHRydWUgPyAiIiA6IG9wdGlvbnMuZG93bmxvYWR9YCA6ICIiOwogICAgaWYgKGRvd25sb2FkUXVlcnlQYXJhbSAhPT0gIiIpIF9xdWVyeVN0cmluZy5wdXNoKGRvd25sb2FkUXVlcnlQYXJhbSk7CiAgICBjb25zdCByZW5kZXJQYXRoID0gdHlwZW9mIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMudHJhbnNmb3JtKSAhPT0gInVuZGVmaW5lZCIgPyAicmVuZGVyL2ltYWdlIiA6ICJvYmplY3QiOwogICAgY29uc3QgdHJhbnNmb3JtYXRpb25RdWVyeSA9IHRoaXMudHJhbnNmb3JtT3B0c1RvUXVlcnlTdHJpbmcoKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy50cmFuc2Zvcm0pIHx8IHt9KTsKICAgIGlmICh0cmFuc2Zvcm1hdGlvblF1ZXJ5ICE9PSAiIikgX3F1ZXJ5U3RyaW5nLnB1c2godHJhbnNmb3JtYXRpb25RdWVyeSk7CiAgICBsZXQgcXVlcnlTdHJpbmcgPSBfcXVlcnlTdHJpbmcuam9pbigiJiIpOwogICAgaWYgKHF1ZXJ5U3RyaW5nICE9PSAiIikgcXVlcnlTdHJpbmcgPSBgPyR7cXVlcnlTdHJpbmd9YDsKICAgIHJldHVybiB7IGRhdGE6IHsgcHVibGljVXJsOiBlbmNvZGVVUkkoYCR7dGhpcy51cmx9LyR7cmVuZGVyUGF0aH0vcHVibGljLyR7X3BhdGh9JHtxdWVyeVN0cmluZ31gKSB9IH07CiAgfQogIC8qKgogICogRGVsZXRlcyBmaWxlcyB3aXRoaW4gdGhlIHNhbWUgYnVja2V0CiAgKgogICogQGNhdGVnb3J5IEZpbGUgQnVja2V0cwogICogQHBhcmFtIHBhdGhzIEFuIGFycmF5IG9mIGZpbGVzIHRvIGRlbGV0ZSwgaW5jbHVkaW5nIHRoZSBwYXRoIGFuZCBmaWxlIG5hbWUuIEZvciBleGFtcGxlIFtgJ2ZvbGRlci9pbWFnZS5wbmcnYF0uCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBhcnJheSBvZiBkZWxldGVkIGZpbGUgb2JqZWN0cyBvciBlcnJvcgogICoKICAqIEBleGFtcGxlIERlbGV0ZSBmaWxlCiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmZyb20oJ2F2YXRhcnMnKQogICogICAucmVtb3ZlKFsnZm9sZGVyL2F2YXRhcjEucG5nJ10pCiAgKiBgYGAKICAqCiAgKiBSZXNwb25zZToKICAqIGBgYGpzb24KICAqIHsKICAqICAgImRhdGEiOiBbXSwKICAqICAgImVycm9yIjogbnVsbAogICogfQogICogYGBgCiAgKi8KICBhc3luYyByZW1vdmUocGF0aHMpIHsKICAgIHZhciBfdGhpczEyID0gdGhpczsKICAgIHJldHVybiBfdGhpczEyLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCByZW1vdmUoX3RoaXMxMi5mZXRjaCwgYCR7X3RoaXMxMi51cmx9L29iamVjdC8ke190aGlzMTIuYnVja2V0SWR9YCwgeyBwcmVmaXhlczogcGF0aHMgfSwgeyBoZWFkZXJzOiBfdGhpczEyLmhlYWRlcnMgfSk7CiAgICB9KTsKICB9CiAgLyoqCiAgKiBHZXQgZmlsZSBtZXRhZGF0YQogICogQHBhcmFtIGlkIHRoZSBmaWxlIGlkIHRvIHJldHJpZXZlIG1ldGFkYXRhCiAgKi8KICAvKioKICAqIFVwZGF0ZSBmaWxlIG1ldGFkYXRhCiAgKiBAcGFyYW0gaWQgdGhlIGZpbGUgaWQgdG8gdXBkYXRlIG1ldGFkYXRhCiAgKiBAcGFyYW0gbWV0YSB0aGUgbmV3IGZpbGUgbWV0YWRhdGEKICAqLwogIC8qKgogICogTGlzdHMgYWxsIHRoZSBmaWxlcyBhbmQgZm9sZGVycyB3aXRoaW4gYSBwYXRoIG9mIHRoZSBidWNrZXQuCiAgKgogICogQGNhdGVnb3J5IEZpbGUgQnVja2V0cwogICogQHBhcmFtIHBhdGggVGhlIGZvbGRlciBwYXRoLgogICogQHBhcmFtIG9wdGlvbnMgU2VhcmNoIG9wdGlvbnMgaW5jbHVkaW5nIGxpbWl0IChkZWZhdWx0cyB0byAxMDApLCBvZmZzZXQsIHNvcnRCeSwgYW5kIHNlYXJjaAogICogQHBhcmFtIHBhcmFtZXRlcnMgT3B0aW9uYWwgZmV0Y2ggcGFyYW1ldGVycyBpbmNsdWRpbmcgc2lnbmFsIGZvciBjYW5jZWxsYXRpb24KICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIGFycmF5IG9mIGZpbGVzIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUgTGlzdCBmaWxlcyBpbiBhIGJ1Y2tldAogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5mcm9tKCdhdmF0YXJzJykKICAqICAgLmxpc3QoJ2ZvbGRlcicsIHsKICAqICAgICBsaW1pdDogMTAwLAogICogICAgIG9mZnNldDogMCwKICAqICAgICBzb3J0Qnk6IHsgY29sdW1uOiAnbmFtZScsIG9yZGVyOiAnYXNjJyB9LAogICogICB9KQogICogYGBgCiAgKgogICogUmVzcG9uc2U6CiAgKiBgYGBqc29uCiAgKiB7CiAgKiAgICJkYXRhIjogWwogICogICAgIHsKICAqICAgICAgICJuYW1lIjogImF2YXRhcjEucG5nIiwKICAqICAgICAgICJpZCI6ICJlNjY4Y2Y3Zi04MjFiLTRhMmYtOWRjZS03ZGZhNWRkMWNmZDIiLAogICogICAgICAgInVwZGF0ZWRfYXQiOiAiMjAyNC0wNS0yMlQyMzowNjowNS41ODBaIiwKICAqICAgICAgICJjcmVhdGVkX2F0IjogIjIwMjQtMDUtMjJUMjM6MDQ6MzQuNDQzWiIsCiAgKiAgICAgICAibGFzdF9hY2Nlc3NlZF9hdCI6ICIyMDI0LTA1LTIyVDIzOjA0OjM0LjQ0M1oiLAogICogICAgICAgIm1ldGFkYXRhIjogewogICogICAgICAgICAiZVRhZyI6ICJcImM1ZThjNTUzMjM1ZDlhZjMwZWY0ZjZlMjgwNzkwYjkyXCIiLAogICogICAgICAgICAic2l6ZSI6IDMyMTc1LAogICogICAgICAgICAibWltZXR5cGUiOiAiaW1hZ2UvcG5nIiwKICAqICAgICAgICAgImNhY2hlQ29udHJvbCI6ICJtYXgtYWdlPTM2MDAiLAogICogICAgICAgICAibGFzdE1vZGlmaWVkIjogIjIwMjQtMDUtMjJUMjM6MDY6MDUuNTc0WiIsCiAgKiAgICAgICAgICJjb250ZW50TGVuZ3RoIjogMzIxNzUsCiAgKiAgICAgICAgICJodHRwU3RhdHVzQ29kZSI6IDIwMAogICogICAgICAgfQogICogICAgIH0KICAqICAgXSwKICAqICAgImVycm9yIjogbnVsbAogICogfQogICogYGBgCiAgKgogICogQGV4YW1wbGUgU2VhcmNoIGZpbGVzIGluIGEgYnVja2V0CiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmZyb20oJ2F2YXRhcnMnKQogICogICAubGlzdCgnZm9sZGVyJywgewogICogICAgIGxpbWl0OiAxMDAsCiAgKiAgICAgb2Zmc2V0OiAwLAogICogICAgIHNvcnRCeTogeyBjb2x1bW46ICduYW1lJywgb3JkZXI6ICdhc2MnIH0sCiAgKiAgICAgc2VhcmNoOiAnam9uJwogICogICB9KQogICogYGBgCiAgKi8KICBhc3luYyBsaXN0KHBhdGgyLCBvcHRpb25zLCBwYXJhbWV0ZXJzKSB7CiAgICB2YXIgX3RoaXMxMyA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXMxMy5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICBjb25zdCBib2R5ID0gX29iamVjdFNwcmVhZDIxMShfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIERFRkFVTFRfU0VBUkNIX09QVElPTlMpLCBvcHRpb25zKSwge30sIHsgcHJlZml4OiBwYXRoMiB8fCAiIiB9KTsKICAgICAgcmV0dXJuIGF3YWl0IHBvc3QoX3RoaXMxMy5mZXRjaCwgYCR7X3RoaXMxMy51cmx9L29iamVjdC9saXN0LyR7X3RoaXMxMy5idWNrZXRJZH1gLCBib2R5LCB7IGhlYWRlcnM6IF90aGlzMTMuaGVhZGVycyB9LCBwYXJhbWV0ZXJzKTsKICAgIH0pOwogIH0KICAvKioKICAqIEBleHBlcmltZW50YWwgdGhpcyBtZXRob2Qgc2lnbmF0dXJlIG1pZ2h0IGNoYW5nZSBpbiB0aGUgZnV0dXJlCiAgKgogICogQGNhdGVnb3J5IEZpbGUgQnVja2V0cwogICogQHBhcmFtIG9wdGlvbnMgc2VhcmNoIG9wdGlvbnMKICAqIEBwYXJhbSBwYXJhbWV0ZXJzCiAgKi8KICBhc3luYyBsaXN0VjIob3B0aW9ucywgcGFyYW1ldGVycykgewogICAgdmFyIF90aGlzMTQgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzMTQuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgY29uc3QgYm9keSA9IF9vYmplY3RTcHJlYWQyMTEoe30sIG9wdGlvbnMpOwogICAgICByZXR1cm4gYXdhaXQgcG9zdChfdGhpczE0LmZldGNoLCBgJHtfdGhpczE0LnVybH0vb2JqZWN0L2xpc3QtdjIvJHtfdGhpczE0LmJ1Y2tldElkfWAsIGJvZHksIHsgaGVhZGVyczogX3RoaXMxNC5oZWFkZXJzIH0sIHBhcmFtZXRlcnMpOwogICAgfSk7CiAgfQogIGVuY29kZU1ldGFkYXRhKG1ldGFkYXRhKSB7CiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkobWV0YWRhdGEpOwogIH0KICB0b0Jhc2U2NChkYXRhKSB7CiAgICBpZiAodHlwZW9mIEJ1ZmZlciAhPT0gInVuZGVmaW5lZCIpIHJldHVybiBCdWZmZXIuZnJvbShkYXRhKS50b1N0cmluZygiYmFzZTY0Iik7CiAgICByZXR1cm4gYnRvYShkYXRhKTsKICB9CiAgX2dldEZpbmFsUGF0aChwYXRoMikgewogICAgcmV0dXJuIGAke3RoaXMuYnVja2V0SWR9LyR7cGF0aDIucmVwbGFjZSgvXlwvKy8sICIiKX1gOwogIH0KICBfcmVtb3ZlRW1wdHlGb2xkZXJzKHBhdGgyKSB7CiAgICByZXR1cm4gcGF0aDIucmVwbGFjZSgvXlwvfFwvJC9nLCAiIikucmVwbGFjZSgvXC8rL2csICIvIik7CiAgfQogIHRyYW5zZm9ybU9wdHNUb1F1ZXJ5U3RyaW5nKHRyYW5zZm9ybSkgewogICAgY29uc3QgcGFyYW1zID0gW107CiAgICBpZiAodHJhbnNmb3JtLndpZHRoKSBwYXJhbXMucHVzaChgd2lkdGg9JHt0cmFuc2Zvcm0ud2lkdGh9YCk7CiAgICBpZiAodHJhbnNmb3JtLmhlaWdodCkgcGFyYW1zLnB1c2goYGhlaWdodD0ke3RyYW5zZm9ybS5oZWlnaHR9YCk7CiAgICBpZiAodHJhbnNmb3JtLnJlc2l6ZSkgcGFyYW1zLnB1c2goYHJlc2l6ZT0ke3RyYW5zZm9ybS5yZXNpemV9YCk7CiAgICBpZiAodHJhbnNmb3JtLmZvcm1hdCkgcGFyYW1zLnB1c2goYGZvcm1hdD0ke3RyYW5zZm9ybS5mb3JtYXR9YCk7CiAgICBpZiAodHJhbnNmb3JtLnF1YWxpdHkpIHBhcmFtcy5wdXNoKGBxdWFsaXR5PSR7dHJhbnNmb3JtLnF1YWxpdHl9YCk7CiAgICByZXR1cm4gcGFyYW1zLmpvaW4oIiYiKTsKICB9Cn07CnZhciB2ZXJzaW9uMyA9ICIyLjk3LjAiOwp2YXIgREVGQVVMVF9IRUFERVJTID0geyAiWC1DbGllbnQtSW5mbyI6IGBzdG9yYWdlLWpzLyR7dmVyc2lvbjN9YCB9Owp2YXIgU3RvcmFnZUJ1Y2tldEFwaSA9IGNsYXNzIGV4dGVuZHMgQmFzZUFwaUNsaWVudCB7CiAgY29uc3RydWN0b3IodXJsLCBoZWFkZXJzID0ge30sIGZldGNoJDEsIG9wdHMpIHsKICAgIGNvbnN0IGJhc2VVcmwgPSBuZXcgVVJMKHVybCk7CiAgICBpZiAob3B0cyA9PT0gbnVsbCB8fCBvcHRzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRzLnVzZU5ld0hvc3RuYW1lKSB7CiAgICAgIGlmICgvc3VwYWJhc2VcLihjb3xpbnxyZWQpJC8udGVzdChiYXNlVXJsLmhvc3RuYW1lKSAmJiAhYmFzZVVybC5ob3N0bmFtZS5pbmNsdWRlcygic3RvcmFnZS5zdXBhYmFzZS4iKSkgYmFzZVVybC5ob3N0bmFtZSA9IGJhc2VVcmwuaG9zdG5hbWUucmVwbGFjZSgic3VwYWJhc2UuIiwgInN0b3JhZ2Uuc3VwYWJhc2UuIik7CiAgICB9CiAgICBjb25zdCBmaW5hbFVybCA9IGJhc2VVcmwuaHJlZi5yZXBsYWNlKC9cLyQvLCAiIik7CiAgICBjb25zdCBmaW5hbEhlYWRlcnMgPSBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIERFRkFVTFRfSEVBREVSUyksIGhlYWRlcnMpOwogICAgc3VwZXIoZmluYWxVcmwsIGZpbmFsSGVhZGVycywgZmV0Y2gkMSwgInN0b3JhZ2UiKTsKICB9CiAgLyoqCiAgKiBSZXRyaWV2ZXMgdGhlIGRldGFpbHMgb2YgYWxsIFN0b3JhZ2UgYnVja2V0cyB3aXRoaW4gYW4gZXhpc3RpbmcgcHJvamVjdC4KICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gb3B0aW9ucyBRdWVyeSBwYXJhbWV0ZXJzIGZvciBsaXN0aW5nIGJ1Y2tldHMKICAqIEBwYXJhbSBvcHRpb25zLmxpbWl0IE1heGltdW0gbnVtYmVyIG9mIGJ1Y2tldHMgdG8gcmV0dXJuCiAgKiBAcGFyYW0gb3B0aW9ucy5vZmZzZXQgTnVtYmVyIG9mIGJ1Y2tldHMgdG8gc2tpcAogICogQHBhcmFtIG9wdGlvbnMuc29ydENvbHVtbiBDb2x1bW4gdG8gc29ydCBieSAoJ2lkJywgJ25hbWUnLCAnY3JlYXRlZF9hdCcsICd1cGRhdGVkX2F0JykKICAqIEBwYXJhbSBvcHRpb25zLnNvcnRPcmRlciBTb3J0IG9yZGVyICgnYXNjJyBvciAnZGVzYycpCiAgKiBAcGFyYW0gb3B0aW9ucy5zZWFyY2ggU2VhcmNoIHRlcm0gdG8gZmlsdGVyIGJ1Y2tldCBuYW1lcwogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIHJlc3BvbnNlIGNvbnRhaW5pbmcgYXJyYXkgb2YgYnVja2V0cyBvciBlcnJvcgogICoKICAqIEBleGFtcGxlIExpc3QgYnVja2V0cwogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5saXN0QnVja2V0cygpCiAgKiBgYGAKICAqCiAgKiBAZXhhbXBsZSBMaXN0IGJ1Y2tldHMgd2l0aCBvcHRpb25zCiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmxpc3RCdWNrZXRzKHsKICAqICAgICBsaW1pdDogMTAsCiAgKiAgICAgb2Zmc2V0OiAwLAogICogICAgIHNvcnRDb2x1bW46ICdjcmVhdGVkX2F0JywKICAqICAgICBzb3J0T3JkZXI6ICdkZXNjJywKICAqICAgICBzZWFyY2g6ICdwcm9kJwogICogICB9KQogICogYGBgCiAgKi8KICBhc3luYyBsaXN0QnVja2V0cyhvcHRpb25zKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIGNvbnN0IHF1ZXJ5U3RyaW5nID0gX3RoaXMubGlzdEJ1Y2tldE9wdGlvbnNUb1F1ZXJ5U3RyaW5nKG9wdGlvbnMpOwogICAgICByZXR1cm4gYXdhaXQgZ2V0NShfdGhpcy5mZXRjaCwgYCR7X3RoaXMudXJsfS9idWNrZXQke3F1ZXJ5U3RyaW5nfWAsIHsgaGVhZGVyczogX3RoaXMuaGVhZGVycyB9KTsKICAgIH0pOwogIH0KICAvKioKICAqIFJldHJpZXZlcyB0aGUgZGV0YWlscyBvZiBhbiBleGlzdGluZyBTdG9yYWdlIGJ1Y2tldC4KICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gaWQgVGhlIHVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBidWNrZXQgeW91IHdvdWxkIGxpa2UgdG8gcmV0cmlldmUuCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBidWNrZXQgZGV0YWlscyBvciBlcnJvcgogICoKICAqIEBleGFtcGxlIEdldCBidWNrZXQKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuZ2V0QnVja2V0KCdhdmF0YXJzJykKICAqIGBgYAogICoKICAqIFJlc3BvbnNlOgogICogYGBganNvbgogICogewogICogICAiZGF0YSI6IHsKICAqICAgICAiaWQiOiAiYXZhdGFycyIsCiAgKiAgICAgIm5hbWUiOiAiYXZhdGFycyIsCiAgKiAgICAgIm93bmVyIjogIiIsCiAgKiAgICAgInB1YmxpYyI6IGZhbHNlLAogICogICAgICJmaWxlX3NpemVfbGltaXQiOiAxMDI0LAogICogICAgICJhbGxvd2VkX21pbWVfdHlwZXMiOiBbCiAgKiAgICAgICAiaW1hZ2UvcG5nIgogICogICAgIF0sCiAgKiAgICAgImNyZWF0ZWRfYXQiOiAiMjAyNC0wNS0yMlQyMjoyNjowNS4xMDBaIiwKICAqICAgICAidXBkYXRlZF9hdCI6ICIyMDI0LTA1LTIyVDIyOjI2OjA1LjEwMFoiCiAgKiAgIH0sCiAgKiAgICJlcnJvciI6IG51bGwKICAqIH0KICAqIGBgYAogICovCiAgYXN5bmMgZ2V0QnVja2V0KGlkKSB7CiAgICB2YXIgX3RoaXMyID0gdGhpczsKICAgIHJldHVybiBfdGhpczIuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IGdldDUoX3RoaXMyLmZldGNoLCBgJHtfdGhpczIudXJsfS9idWNrZXQvJHtpZH1gLCB7IGhlYWRlcnM6IF90aGlzMi5oZWFkZXJzIH0pOwogICAgfSk7CiAgfQogIC8qKgogICogQ3JlYXRlcyBhIG5ldyBTdG9yYWdlIGJ1Y2tldAogICoKICAqIEBjYXRlZ29yeSBGaWxlIEJ1Y2tldHMKICAqIEBwYXJhbSBpZCBBIHVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGUgYnVja2V0IHlvdSBhcmUgY3JlYXRpbmcuCiAgKiBAcGFyYW0gb3B0aW9ucy5wdWJsaWMgVGhlIHZpc2liaWxpdHkgb2YgdGhlIGJ1Y2tldC4gUHVibGljIGJ1Y2tldHMgZG9uJ3QgcmVxdWlyZSBhbiBhdXRob3JpemF0aW9uIHRva2VuIHRvIGRvd25sb2FkIG9iamVjdHMsIGJ1dCBzdGlsbCByZXF1aXJlIGEgdmFsaWQgdG9rZW4gZm9yIGFsbCBvdGhlciBvcGVyYXRpb25zLiBCeSBkZWZhdWx0LCBidWNrZXRzIGFyZSBwcml2YXRlLgogICogQHBhcmFtIG9wdGlvbnMuZmlsZVNpemVMaW1pdCBzcGVjaWZpZXMgdGhlIG1heCBmaWxlIHNpemUgaW4gYnl0ZXMgdGhhdCBjYW4gYmUgdXBsb2FkZWQgdG8gdGhpcyBidWNrZXQuCiAgKiBUaGUgZ2xvYmFsIGZpbGUgc2l6ZSBsaW1pdCB0YWtlcyBwcmVjZWRlbmNlIG92ZXIgdGhpcyB2YWx1ZS4KICAqIFRoZSBkZWZhdWx0IHZhbHVlIGlzIG51bGwsIHdoaWNoIGRvZXNuJ3Qgc2V0IGEgcGVyIGJ1Y2tldCBmaWxlIHNpemUgbGltaXQuCiAgKiBAcGFyYW0gb3B0aW9ucy5hbGxvd2VkTWltZVR5cGVzIHNwZWNpZmllcyB0aGUgYWxsb3dlZCBtaW1lIHR5cGVzIHRoYXQgdGhpcyBidWNrZXQgY2FuIGFjY2VwdCBkdXJpbmcgdXBsb2FkLgogICogVGhlIGRlZmF1bHQgdmFsdWUgaXMgbnVsbCwgd2hpY2ggYWxsb3dzIGZpbGVzIHdpdGggYWxsIG1pbWUgdHlwZXMgdG8gYmUgdXBsb2FkZWQuCiAgKiBFYWNoIG1pbWUgdHlwZSBzcGVjaWZpZWQgY2FuIGJlIGEgd2lsZGNhcmQsIGUuZy4gaW1hZ2UvKiwgb3IgYSBzcGVjaWZpYyBtaW1lIHR5cGUsIGUuZy4gaW1hZ2UvcG5nLgogICogQHBhcmFtIG9wdGlvbnMudHlwZSAocHJpdmF0ZS1iZXRhKSBzcGVjaWZpZXMgdGhlIGJ1Y2tldCB0eXBlLiBzZWUgYEJ1Y2tldFR5cGVgIGZvciBtb3JlIGRldGFpbHMuCiAgKiAgIC0gZGVmYXVsdCBidWNrZXQgdHlwZSBpcyBgU1RBTkRBUkRgCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBuZXdseSBjcmVhdGVkIGJ1Y2tldCBuYW1lIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUgQ3JlYXRlIGJ1Y2tldAogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5jcmVhdGVCdWNrZXQoJ2F2YXRhcnMnLCB7CiAgKiAgICAgcHVibGljOiBmYWxzZSwKICAqICAgICBhbGxvd2VkTWltZVR5cGVzOiBbJ2ltYWdlL3BuZyddLAogICogICAgIGZpbGVTaXplTGltaXQ6IDEwMjQKICAqICAgfSkKICAqIGBgYAogICoKICAqIFJlc3BvbnNlOgogICogYGBganNvbgogICogewogICogICAiZGF0YSI6IHsKICAqICAgICAibmFtZSI6ICJhdmF0YXJzIgogICogICB9LAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqLwogIGFzeW5jIGNyZWF0ZUJ1Y2tldChpZCwgb3B0aW9ucyA9IHsgcHVibGljOiBmYWxzZSB9KSB7CiAgICB2YXIgX3RoaXMzID0gdGhpczsKICAgIHJldHVybiBfdGhpczMuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHBvc3QoX3RoaXMzLmZldGNoLCBgJHtfdGhpczMudXJsfS9idWNrZXRgLCB7CiAgICAgICAgaWQsCiAgICAgICAgbmFtZTogaWQsCiAgICAgICAgdHlwZTogb3B0aW9ucy50eXBlLAogICAgICAgIHB1YmxpYzogb3B0aW9ucy5wdWJsaWMsCiAgICAgICAgZmlsZV9zaXplX2xpbWl0OiBvcHRpb25zLmZpbGVTaXplTGltaXQsCiAgICAgICAgYWxsb3dlZF9taW1lX3R5cGVzOiBvcHRpb25zLmFsbG93ZWRNaW1lVHlwZXMKICAgICAgfSwgeyBoZWFkZXJzOiBfdGhpczMuaGVhZGVycyB9KTsKICAgIH0pOwogIH0KICAvKioKICAqIFVwZGF0ZXMgYSBTdG9yYWdlIGJ1Y2tldAogICoKICAqIEBjYXRlZ29yeSBGaWxlIEJ1Y2tldHMKICAqIEBwYXJhbSBpZCBBIHVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGUgYnVja2V0IHlvdSBhcmUgdXBkYXRpbmcuCiAgKiBAcGFyYW0gb3B0aW9ucy5wdWJsaWMgVGhlIHZpc2liaWxpdHkgb2YgdGhlIGJ1Y2tldC4gUHVibGljIGJ1Y2tldHMgZG9uJ3QgcmVxdWlyZSBhbiBhdXRob3JpemF0aW9uIHRva2VuIHRvIGRvd25sb2FkIG9iamVjdHMsIGJ1dCBzdGlsbCByZXF1aXJlIGEgdmFsaWQgdG9rZW4gZm9yIGFsbCBvdGhlciBvcGVyYXRpb25zLgogICogQHBhcmFtIG9wdGlvbnMuZmlsZVNpemVMaW1pdCBzcGVjaWZpZXMgdGhlIG1heCBmaWxlIHNpemUgaW4gYnl0ZXMgdGhhdCBjYW4gYmUgdXBsb2FkZWQgdG8gdGhpcyBidWNrZXQuCiAgKiBUaGUgZ2xvYmFsIGZpbGUgc2l6ZSBsaW1pdCB0YWtlcyBwcmVjZWRlbmNlIG92ZXIgdGhpcyB2YWx1ZS4KICAqIFRoZSBkZWZhdWx0IHZhbHVlIGlzIG51bGwsIHdoaWNoIGRvZXNuJ3Qgc2V0IGEgcGVyIGJ1Y2tldCBmaWxlIHNpemUgbGltaXQuCiAgKiBAcGFyYW0gb3B0aW9ucy5hbGxvd2VkTWltZVR5cGVzIHNwZWNpZmllcyB0aGUgYWxsb3dlZCBtaW1lIHR5cGVzIHRoYXQgdGhpcyBidWNrZXQgY2FuIGFjY2VwdCBkdXJpbmcgdXBsb2FkLgogICogVGhlIGRlZmF1bHQgdmFsdWUgaXMgbnVsbCwgd2hpY2ggYWxsb3dzIGZpbGVzIHdpdGggYWxsIG1pbWUgdHlwZXMgdG8gYmUgdXBsb2FkZWQuCiAgKiBFYWNoIG1pbWUgdHlwZSBzcGVjaWZpZWQgY2FuIGJlIGEgd2lsZGNhcmQsIGUuZy4gaW1hZ2UvKiwgb3IgYSBzcGVjaWZpYyBtaW1lIHR5cGUsIGUuZy4gaW1hZ2UvcG5nLgogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIHJlc3BvbnNlIGNvbnRhaW5pbmcgc3VjY2VzcyBtZXNzYWdlIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUgVXBkYXRlIGJ1Y2tldAogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC51cGRhdGVCdWNrZXQoJ2F2YXRhcnMnLCB7CiAgKiAgICAgcHVibGljOiBmYWxzZSwKICAqICAgICBhbGxvd2VkTWltZVR5cGVzOiBbJ2ltYWdlL3BuZyddLAogICogICAgIGZpbGVTaXplTGltaXQ6IDEwMjQKICAqICAgfSkKICAqIGBgYAogICoKICAqIFJlc3BvbnNlOgogICogYGBganNvbgogICogewogICogICAiZGF0YSI6IHsKICAqICAgICAibWVzc2FnZSI6ICJTdWNjZXNzZnVsbHkgdXBkYXRlZCIKICAqICAgfSwKICAqICAgImVycm9yIjogbnVsbAogICogfQogICogYGBgCiAgKi8KICBhc3luYyB1cGRhdGVCdWNrZXQoaWQsIG9wdGlvbnMpIHsKICAgIHZhciBfdGhpczQgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzNC5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgcHV0KF90aGlzNC5mZXRjaCwgYCR7X3RoaXM0LnVybH0vYnVja2V0LyR7aWR9YCwgewogICAgICAgIGlkLAogICAgICAgIG5hbWU6IGlkLAogICAgICAgIHB1YmxpYzogb3B0aW9ucy5wdWJsaWMsCiAgICAgICAgZmlsZV9zaXplX2xpbWl0OiBvcHRpb25zLmZpbGVTaXplTGltaXQsCiAgICAgICAgYWxsb3dlZF9taW1lX3R5cGVzOiBvcHRpb25zLmFsbG93ZWRNaW1lVHlwZXMKICAgICAgfSwgeyBoZWFkZXJzOiBfdGhpczQuaGVhZGVycyB9KTsKICAgIH0pOwogIH0KICAvKioKICAqIFJlbW92ZXMgYWxsIG9iamVjdHMgaW5zaWRlIGEgc2luZ2xlIGJ1Y2tldC4KICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAcGFyYW0gaWQgVGhlIHVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBidWNrZXQgeW91IHdvdWxkIGxpa2UgdG8gZW1wdHkuCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggc3VjY2VzcyBtZXNzYWdlIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUgRW1wdHkgYnVja2V0CiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmVtcHR5QnVja2V0KCdhdmF0YXJzJykKICAqIGBgYAogICoKICAqIFJlc3BvbnNlOgogICogYGBganNvbgogICogewogICogICAiZGF0YSI6IHsKICAqICAgICAibWVzc2FnZSI6ICJTdWNjZXNzZnVsbHkgZW1wdGllZCIKICAqICAgfSwKICAqICAgImVycm9yIjogbnVsbAogICogfQogICogYGBgCiAgKi8KICBhc3luYyBlbXB0eUJ1Y2tldChpZCkgewogICAgdmFyIF90aGlzNSA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXM1LmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCBwb3N0KF90aGlzNS5mZXRjaCwgYCR7X3RoaXM1LnVybH0vYnVja2V0LyR7aWR9L2VtcHR5YCwge30sIHsgaGVhZGVyczogX3RoaXM1LmhlYWRlcnMgfSk7CiAgICB9KTsKICB9CiAgLyoqCiAgKiBEZWxldGVzIGFuIGV4aXN0aW5nIGJ1Y2tldC4gQSBidWNrZXQgY2FuJ3QgYmUgZGVsZXRlZCB3aXRoIGV4aXN0aW5nIG9iamVjdHMgaW5zaWRlIGl0LgogICogWW91IG11c3QgZmlyc3QgYGVtcHR5KClgIHRoZSBidWNrZXQuCiAgKgogICogQGNhdGVnb3J5IEZpbGUgQnVja2V0cwogICogQHBhcmFtIGlkIFRoZSB1bmlxdWUgaWRlbnRpZmllciBvZiB0aGUgYnVja2V0IHlvdSB3b3VsZCBsaWtlIHRvIGRlbGV0ZS4KICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCBzdWNjZXNzIG1lc3NhZ2Ugb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZSBEZWxldGUgYnVja2V0CiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmRlbGV0ZUJ1Y2tldCgnYXZhdGFycycpCiAgKiBgYGAKICAqCiAgKiBSZXNwb25zZToKICAqIGBgYGpzb24KICAqIHsKICAqICAgImRhdGEiOiB7CiAgKiAgICAgIm1lc3NhZ2UiOiAiU3VjY2Vzc2Z1bGx5IGRlbGV0ZWQiCiAgKiAgIH0sCiAgKiAgICJlcnJvciI6IG51bGwKICAqIH0KICAqIGBgYAogICovCiAgYXN5bmMgZGVsZXRlQnVja2V0KGlkKSB7CiAgICB2YXIgX3RoaXM2ID0gdGhpczsKICAgIHJldHVybiBfdGhpczYuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHJlbW92ZShfdGhpczYuZmV0Y2gsIGAke190aGlzNi51cmx9L2J1Y2tldC8ke2lkfWAsIHt9LCB7IGhlYWRlcnM6IF90aGlzNi5oZWFkZXJzIH0pOwogICAgfSk7CiAgfQogIGxpc3RCdWNrZXRPcHRpb25zVG9RdWVyeVN0cmluZyhvcHRpb25zKSB7CiAgICBjb25zdCBwYXJhbXMgPSB7fTsKICAgIGlmIChvcHRpb25zKSB7CiAgICAgIGlmICgibGltaXQiIGluIG9wdGlvbnMpIHBhcmFtcy5saW1pdCA9IFN0cmluZyhvcHRpb25zLmxpbWl0KTsKICAgICAgaWYgKCJvZmZzZXQiIGluIG9wdGlvbnMpIHBhcmFtcy5vZmZzZXQgPSBTdHJpbmcob3B0aW9ucy5vZmZzZXQpOwogICAgICBpZiAob3B0aW9ucy5zZWFyY2gpIHBhcmFtcy5zZWFyY2ggPSBvcHRpb25zLnNlYXJjaDsKICAgICAgaWYgKG9wdGlvbnMuc29ydENvbHVtbikgcGFyYW1zLnNvcnRDb2x1bW4gPSBvcHRpb25zLnNvcnRDb2x1bW47CiAgICAgIGlmIChvcHRpb25zLnNvcnRPcmRlcikgcGFyYW1zLnNvcnRPcmRlciA9IG9wdGlvbnMuc29ydE9yZGVyOwogICAgfQogICAgcmV0dXJuIE9iamVjdC5rZXlzKHBhcmFtcykubGVuZ3RoID4gMCA/ICI/IiArIG5ldyBVUkxTZWFyY2hQYXJhbXMocGFyYW1zKS50b1N0cmluZygpIDogIiI7CiAgfQp9Owp2YXIgU3RvcmFnZUFuYWx5dGljc0NsaWVudCA9IGNsYXNzIGV4dGVuZHMgQmFzZUFwaUNsaWVudCB7CiAgLyoqCiAgKiBAYWxwaGEKICAqCiAgKiBDcmVhdGVzIGEgbmV3IFN0b3JhZ2VBbmFseXRpY3NDbGllbnQgaW5zdGFuY2UKICAqCiAgKiAqKlB1YmxpYyBhbHBoYToqKiBUaGlzIEFQSSBpcyBwYXJ0IG9mIGEgcHVibGljIGFscGhhIHJlbGVhc2UgYW5kIG1heSBub3QgYmUgYXZhaWxhYmxlIHRvIHlvdXIgYWNjb3VudCB0eXBlLgogICoKICAqIEBjYXRlZ29yeSBBbmFseXRpY3MgQnVja2V0cwogICogQHBhcmFtIHVybCAtIFRoZSBiYXNlIFVSTCBmb3IgdGhlIHN0b3JhZ2UgQVBJCiAgKiBAcGFyYW0gaGVhZGVycyAtIEhUVFAgaGVhZGVycyB0byBpbmNsdWRlIGluIHJlcXVlc3RzCiAgKiBAcGFyYW0gZmV0Y2ggLSBPcHRpb25hbCBjdXN0b20gZmV0Y2ggaW1wbGVtZW50YXRpb24KICAqCiAgKiBAZXhhbXBsZQogICogYGBgdHlwZXNjcmlwdAogICogY29uc3QgY2xpZW50ID0gbmV3IFN0b3JhZ2VBbmFseXRpY3NDbGllbnQodXJsLCBoZWFkZXJzKQogICogYGBgCiAgKi8KICBjb25zdHJ1Y3Rvcih1cmwsIGhlYWRlcnMgPSB7fSwgZmV0Y2gkMSkgewogICAgY29uc3QgZmluYWxVcmwgPSB1cmwucmVwbGFjZSgvXC8kLywgIiIpOwogICAgY29uc3QgZmluYWxIZWFkZXJzID0gX29iamVjdFNwcmVhZDIxMShfb2JqZWN0U3ByZWFkMjExKHt9LCBERUZBVUxUX0hFQURFUlMpLCBoZWFkZXJzKTsKICAgIHN1cGVyKGZpbmFsVXJsLCBmaW5hbEhlYWRlcnMsIGZldGNoJDEsICJzdG9yYWdlIik7CiAgfQogIC8qKgogICogQGFscGhhCiAgKgogICogQ3JlYXRlcyBhIG5ldyBhbmFseXRpY3MgYnVja2V0IHVzaW5nIEljZWJlcmcgdGFibGVzCiAgKiBBbmFseXRpY3MgYnVja2V0cyBhcmUgb3B0aW1pemVkIGZvciBhbmFseXRpY2FsIHF1ZXJpZXMgYW5kIGRhdGEgcHJvY2Vzc2luZwogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IEFuYWx5dGljcyBCdWNrZXRzCiAgKiBAcGFyYW0gbmFtZSBBIHVuaXF1ZSBuYW1lIGZvciB0aGUgYnVja2V0IHlvdSBhcmUgY3JlYXRpbmcKICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIG5ld2x5IGNyZWF0ZWQgYW5hbHl0aWNzIGJ1Y2tldCBvciBlcnJvcgogICoKICAqIEBleGFtcGxlIENyZWF0ZSBhbmFseXRpY3MgYnVja2V0CiAgKiBgYGBqcwogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLmFuYWx5dGljcwogICogICAuY3JlYXRlQnVja2V0KCdhbmFseXRpY3MtZGF0YScpCiAgKiBgYGAKICAqCiAgKiBSZXNwb25zZToKICAqIGBgYGpzb24KICAqIHsKICAqICAgImRhdGEiOiB7CiAgKiAgICAgIm5hbWUiOiAiYW5hbHl0aWNzLWRhdGEiLAogICogICAgICJ0eXBlIjogIkFOQUxZVElDUyIsCiAgKiAgICAgImZvcm1hdCI6ICJpY2ViZXJnIiwKICAqICAgICAiY3JlYXRlZF9hdCI6ICIyMDI0LTA1LTIyVDIyOjI2OjA1LjEwMFoiLAogICogICAgICJ1cGRhdGVkX2F0IjogIjIwMjQtMDUtMjJUMjI6MjY6MDUuMTAwWiIKICAqICAgfSwKICAqICAgImVycm9yIjogbnVsbAogICogfQogICogYGBgCiAgKi8KICBhc3luYyBjcmVhdGVCdWNrZXQobmFtZSkgewogICAgdmFyIF90aGlzID0gdGhpczsKICAgIHJldHVybiBfdGhpcy5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgcG9zdChfdGhpcy5mZXRjaCwgYCR7X3RoaXMudXJsfS9idWNrZXRgLCB7IG5hbWUgfSwgeyBoZWFkZXJzOiBfdGhpcy5oZWFkZXJzIH0pOwogICAgfSk7CiAgfQogIC8qKgogICogQGFscGhhCiAgKgogICogUmV0cmlldmVzIHRoZSBkZXRhaWxzIG9mIGFsbCBBbmFseXRpY3MgU3RvcmFnZSBidWNrZXRzIHdpdGhpbiBhbiBleGlzdGluZyBwcm9qZWN0CiAgKiBPbmx5IHJldHVybnMgYnVja2V0cyBvZiB0eXBlICdBTkFMWVRJQ1MnCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgQW5hbHl0aWNzIEJ1Y2tldHMKICAqIEBwYXJhbSBvcHRpb25zIFF1ZXJ5IHBhcmFtZXRlcnMgZm9yIGxpc3RpbmcgYnVja2V0cwogICogQHBhcmFtIG9wdGlvbnMubGltaXQgTWF4aW11bSBudW1iZXIgb2YgYnVja2V0cyB0byByZXR1cm4KICAqIEBwYXJhbSBvcHRpb25zLm9mZnNldCBOdW1iZXIgb2YgYnVja2V0cyB0byBza2lwCiAgKiBAcGFyYW0gb3B0aW9ucy5zb3J0Q29sdW1uIENvbHVtbiB0byBzb3J0IGJ5ICgnbmFtZScsICdjcmVhdGVkX2F0JywgJ3VwZGF0ZWRfYXQnKQogICogQHBhcmFtIG9wdGlvbnMuc29ydE9yZGVyIFNvcnQgb3JkZXIgKCdhc2MnIG9yICdkZXNjJykKICAqIEBwYXJhbSBvcHRpb25zLnNlYXJjaCBTZWFyY2ggdGVybSB0byBmaWx0ZXIgYnVja2V0IG5hbWVzCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBhcnJheSBvZiBhbmFseXRpY3MgYnVja2V0cyBvciBlcnJvcgogICoKICAqIEBleGFtcGxlIExpc3QgYW5hbHl0aWNzIGJ1Y2tldHMKICAqIGBgYGpzCiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAuYW5hbHl0aWNzCiAgKiAgIC5saXN0QnVja2V0cyh7CiAgKiAgICAgbGltaXQ6IDEwLAogICogICAgIG9mZnNldDogMCwKICAqICAgICBzb3J0Q29sdW1uOiAnY3JlYXRlZF9hdCcsCiAgKiAgICAgc29ydE9yZGVyOiAnZGVzYycKICAqICAgfSkKICAqIGBgYAogICoKICAqIFJlc3BvbnNlOgogICogYGBganNvbgogICogewogICogICAiZGF0YSI6IFsKICAqICAgICB7CiAgKiAgICAgICAibmFtZSI6ICJhbmFseXRpY3MtZGF0YSIsCiAgKiAgICAgICAidHlwZSI6ICJBTkFMWVRJQ1MiLAogICogICAgICAgImZvcm1hdCI6ICJpY2ViZXJnIiwKICAqICAgICAgICJjcmVhdGVkX2F0IjogIjIwMjQtMDUtMjJUMjI6MjY6MDUuMTAwWiIsCiAgKiAgICAgICAidXBkYXRlZF9hdCI6ICIyMDI0LTA1LTIyVDIyOjI2OjA1LjEwMFoiCiAgKiAgICAgfQogICogICBdLAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqLwogIGFzeW5jIGxpc3RCdWNrZXRzKG9wdGlvbnMpIHsKICAgIHZhciBfdGhpczIgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzMi5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICBjb25zdCBxdWVyeVBhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMoKTsKICAgICAgaWYgKChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMubGltaXQpICE9PSB2b2lkIDApIHF1ZXJ5UGFyYW1zLnNldCgibGltaXQiLCBvcHRpb25zLmxpbWl0LnRvU3RyaW5nKCkpOwogICAgICBpZiAoKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5vZmZzZXQpICE9PSB2b2lkIDApIHF1ZXJ5UGFyYW1zLnNldCgib2Zmc2V0Iiwgb3B0aW9ucy5vZmZzZXQudG9TdHJpbmcoKSk7CiAgICAgIGlmIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc29ydENvbHVtbikgcXVlcnlQYXJhbXMuc2V0KCJzb3J0Q29sdW1uIiwgb3B0aW9ucy5zb3J0Q29sdW1uKTsKICAgICAgaWYgKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5zb3J0T3JkZXIpIHF1ZXJ5UGFyYW1zLnNldCgic29ydE9yZGVyIiwgb3B0aW9ucy5zb3J0T3JkZXIpOwogICAgICBpZiAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNlYXJjaCkgcXVlcnlQYXJhbXMuc2V0KCJzZWFyY2giLCBvcHRpb25zLnNlYXJjaCk7CiAgICAgIGNvbnN0IHF1ZXJ5U3RyaW5nID0gcXVlcnlQYXJhbXMudG9TdHJpbmcoKTsKICAgICAgY29uc3QgdXJsID0gcXVlcnlTdHJpbmcgPyBgJHtfdGhpczIudXJsfS9idWNrZXQ/JHtxdWVyeVN0cmluZ31gIDogYCR7X3RoaXMyLnVybH0vYnVja2V0YDsKICAgICAgcmV0dXJuIGF3YWl0IGdldDUoX3RoaXMyLmZldGNoLCB1cmwsIHsgaGVhZGVyczogX3RoaXMyLmhlYWRlcnMgfSk7CiAgICB9KTsKICB9CiAgLyoqCiAgKiBAYWxwaGEKICAqCiAgKiBEZWxldGVzIGFuIGV4aXN0aW5nIGFuYWx5dGljcyBidWNrZXQKICAqIEEgYnVja2V0IGNhbid0IGJlIGRlbGV0ZWQgd2l0aCBleGlzdGluZyBvYmplY3RzIGluc2lkZSBpdAogICogWW91IG11c3QgZmlyc3QgZW1wdHkgdGhlIGJ1Y2tldCBiZWZvcmUgZGVsZXRpb24KICAqCiAgKiAqKlB1YmxpYyBhbHBoYToqKiBUaGlzIEFQSSBpcyBwYXJ0IG9mIGEgcHVibGljIGFscGhhIHJlbGVhc2UgYW5kIG1heSBub3QgYmUgYXZhaWxhYmxlIHRvIHlvdXIgYWNjb3VudCB0eXBlLgogICoKICAqIEBjYXRlZ29yeSBBbmFseXRpY3MgQnVja2V0cwogICogQHBhcmFtIGJ1Y2tldE5hbWUgVGhlIHVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBidWNrZXQgeW91IHdvdWxkIGxpa2UgdG8gZGVsZXRlCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyBzdWNjZXNzIG1lc3NhZ2Ugb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZSBEZWxldGUgYW5hbHl0aWNzIGJ1Y2tldAogICogYGBganMKICAqIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5hbmFseXRpY3MKICAqICAgLmRlbGV0ZUJ1Y2tldCgnYW5hbHl0aWNzLWRhdGEnKQogICogYGBgCiAgKgogICogUmVzcG9uc2U6CiAgKiBgYGBqc29uCiAgKiB7CiAgKiAgICJkYXRhIjogewogICogICAgICJtZXNzYWdlIjogIlN1Y2Nlc3NmdWxseSBkZWxldGVkIgogICogICB9LAogICogICAiZXJyb3IiOiBudWxsCiAgKiB9CiAgKiBgYGAKICAqLwogIGFzeW5jIGRlbGV0ZUJ1Y2tldChidWNrZXROYW1lKSB7CiAgICB2YXIgX3RoaXMzID0gdGhpczsKICAgIHJldHVybiBfdGhpczMuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHJlbW92ZShfdGhpczMuZmV0Y2gsIGAke190aGlzMy51cmx9L2J1Y2tldC8ke2J1Y2tldE5hbWV9YCwge30sIHsgaGVhZGVyczogX3RoaXMzLmhlYWRlcnMgfSk7CiAgICB9KTsKICB9CiAgLyoqCiAgKiBAYWxwaGEKICAqCiAgKiBHZXQgYW4gSWNlYmVyZyBSRVNUIENhdGFsb2cgY2xpZW50IGNvbmZpZ3VyZWQgZm9yIGEgc3BlY2lmaWMgYW5hbHl0aWNzIGJ1Y2tldAogICogVXNlIHRoaXMgdG8gcGVyZm9ybSBhZHZhbmNlZCB0YWJsZSBhbmQgbmFtZXNwYWNlIG9wZXJhdGlvbnMgd2l0aGluIHRoZSBidWNrZXQKICAqIFRoZSByZXR1cm5lZCBjbGllbnQgcHJvdmlkZXMgZnVsbCBhY2Nlc3MgdG8gdGhlIEFwYWNoZSBJY2ViZXJnIFJFU1QgQ2F0YWxvZyBBUEkKICAqIHdpdGggdGhlIFN1cGFiYXNlIGB7IGRhdGEsIGVycm9yIH1gIHBhdHRlcm4gZm9yIGNvbnNpc3RlbnQgZXJyb3IgaGFuZGxpbmcgb24gYWxsIG9wZXJhdGlvbnMuCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgQW5hbHl0aWNzIEJ1Y2tldHMKICAqIEBwYXJhbSBidWNrZXROYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGFuYWx5dGljcyBidWNrZXQgKHdhcmVob3VzZSkgdG8gY29ubmVjdCB0bwogICogQHJldHVybnMgVGhlIHdyYXBwZWQgSWNlYmVyZyBjYXRhbG9nIGNsaWVudAogICogQHRocm93cyB7U3RvcmFnZUVycm9yfSBJZiB0aGUgYnVja2V0IG5hbWUgaXMgaW52YWxpZAogICoKICAqIEBleGFtcGxlIEdldCBjYXRhbG9nIGFuZCBjcmVhdGUgdGFibGUKICAqIGBgYGpzCiAgKiAvLyBGaXJzdCwgY3JlYXRlIGFuIGFuYWx5dGljcyBidWNrZXQKICAqIGNvbnN0IHsgZGF0YTogYnVja2V0LCBlcnJvcjogYnVja2V0RXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlCiAgKiAgIC5zdG9yYWdlCiAgKiAgIC5hbmFseXRpY3MKICAqICAgLmNyZWF0ZUJ1Y2tldCgnYW5hbHl0aWNzLWRhdGEnKQogICoKICAqIC8vIEdldCB0aGUgSWNlYmVyZyBjYXRhbG9nIGZvciB0aGF0IGJ1Y2tldAogICogY29uc3QgY2F0YWxvZyA9IHN1cGFiYXNlLnN0b3JhZ2UuYW5hbHl0aWNzLmZyb20oJ2FuYWx5dGljcy1kYXRhJykKICAqCiAgKiAvLyBDcmVhdGUgYSBuYW1lc3BhY2UKICAqIGNvbnN0IHsgZXJyb3I6IG5zRXJyb3IgfSA9IGF3YWl0IGNhdGFsb2cuY3JlYXRlTmFtZXNwYWNlKHsgbmFtZXNwYWNlOiBbJ2RlZmF1bHQnXSB9KQogICoKICAqIC8vIENyZWF0ZSBhIHRhYmxlIHdpdGggc2NoZW1hCiAgKiBjb25zdCB7IGRhdGE6IHRhYmxlTWV0YWRhdGEsIGVycm9yOiB0YWJsZUVycm9yIH0gPSBhd2FpdCBjYXRhbG9nLmNyZWF0ZVRhYmxlKAogICogICB7IG5hbWVzcGFjZTogWydkZWZhdWx0J10gfSwKICAqICAgewogICogICAgIG5hbWU6ICdldmVudHMnLAogICogICAgIHNjaGVtYTogewogICogICAgICAgdHlwZTogJ3N0cnVjdCcsCiAgKiAgICAgICBmaWVsZHM6IFsKICAqICAgICAgICAgeyBpZDogMSwgbmFtZTogJ2lkJywgdHlwZTogJ2xvbmcnLCByZXF1aXJlZDogdHJ1ZSB9LAogICogICAgICAgICB7IGlkOiAyLCBuYW1lOiAndGltZXN0YW1wJywgdHlwZTogJ3RpbWVzdGFtcCcsIHJlcXVpcmVkOiB0cnVlIH0sCiAgKiAgICAgICAgIHsgaWQ6IDMsIG5hbWU6ICd1c2VyX2lkJywgdHlwZTogJ3N0cmluZycsIHJlcXVpcmVkOiBmYWxzZSB9CiAgKiAgICAgICBdLAogICogICAgICAgJ3NjaGVtYS1pZCc6IDAsCiAgKiAgICAgICAnaWRlbnRpZmllci1maWVsZC1pZHMnOiBbMV0KICAqICAgICB9LAogICogICAgICdwYXJ0aXRpb24tc3BlYyc6IHsKICAqICAgICAgICdzcGVjLWlkJzogMCwKICAqICAgICAgIGZpZWxkczogW10KICAqICAgICB9LAogICogICAgICd3cml0ZS1vcmRlcic6IHsKICAqICAgICAgICdvcmRlci1pZCc6IDAsCiAgKiAgICAgICBmaWVsZHM6IFtdCiAgKiAgICAgfSwKICAqICAgICBwcm9wZXJ0aWVzOiB7CiAgKiAgICAgICAnd3JpdGUuZm9ybWF0LmRlZmF1bHQnOiAncGFycXVldCcKICAqICAgICB9CiAgKiAgIH0KICAqICkKICAqIGBgYAogICoKICAqIEBleGFtcGxlIExpc3QgdGFibGVzIGluIG5hbWVzcGFjZQogICogYGBganMKICAqIGNvbnN0IGNhdGFsb2cgPSBzdXBhYmFzZS5zdG9yYWdlLmFuYWx5dGljcy5mcm9tKCdhbmFseXRpY3MtZGF0YScpCiAgKgogICogLy8gTGlzdCBhbGwgdGFibGVzIGluIHRoZSBkZWZhdWx0IG5hbWVzcGFjZQogICogY29uc3QgeyBkYXRhOiB0YWJsZXMsIGVycm9yOiBsaXN0RXJyb3IgfSA9IGF3YWl0IGNhdGFsb2cubGlzdFRhYmxlcyh7IG5hbWVzcGFjZTogWydkZWZhdWx0J10gfSkKICAqIGlmIChsaXN0RXJyb3IpIHsKICAqICAgaWYgKGxpc3RFcnJvci5pc05vdEZvdW5kKCkpIHsKICAqICAgICBjb25zb2xlLmxvZygnTmFtZXNwYWNlIG5vdCBmb3VuZCcpCiAgKiAgIH0KICAqICAgcmV0dXJuCiAgKiB9CiAgKiBjb25zb2xlLmxvZyh0YWJsZXMpIC8vIFt7IG5hbWVzcGFjZTogWydkZWZhdWx0J10sIG5hbWU6ICdldmVudHMnIH1dCiAgKiBgYGAKICAqCiAgKiBAZXhhbXBsZSBXb3JraW5nIHdpdGggbmFtZXNwYWNlcwogICogYGBganMKICAqIGNvbnN0IGNhdGFsb2cgPSBzdXBhYmFzZS5zdG9yYWdlLmFuYWx5dGljcy5mcm9tKCdhbmFseXRpY3MtZGF0YScpCiAgKgogICogLy8gTGlzdCBhbGwgbmFtZXNwYWNlcwogICogY29uc3QgeyBkYXRhOiBuYW1lc3BhY2VzIH0gPSBhd2FpdCBjYXRhbG9nLmxpc3ROYW1lc3BhY2VzKCkKICAqCiAgKiAvLyBDcmVhdGUgbmFtZXNwYWNlIHdpdGggcHJvcGVydGllcwogICogYXdhaXQgY2F0YWxvZy5jcmVhdGVOYW1lc3BhY2UoCiAgKiAgIHsgbmFtZXNwYWNlOiBbJ3Byb2R1Y3Rpb24nXSB9LAogICogICB7IHByb3BlcnRpZXM6IHsgb3duZXI6ICdkYXRhLXRlYW0nLCBlbnY6ICdwcm9kJyB9IH0KICAqICkKICAqIGBgYAogICoKICAqIEBleGFtcGxlIENsZWFudXAgb3BlcmF0aW9ucwogICogYGBganMKICAqIGNvbnN0IGNhdGFsb2cgPSBzdXBhYmFzZS5zdG9yYWdlLmFuYWx5dGljcy5mcm9tKCdhbmFseXRpY3MtZGF0YScpCiAgKgogICogLy8gRHJvcCB0YWJsZSB3aXRoIHB1cmdlIG9wdGlvbiAocmVtb3ZlcyBhbGwgZGF0YSkKICAqIGNvbnN0IHsgZXJyb3I6IGRyb3BFcnJvciB9ID0gYXdhaXQgY2F0YWxvZy5kcm9wVGFibGUoCiAgKiAgIHsgbmFtZXNwYWNlOiBbJ2RlZmF1bHQnXSwgbmFtZTogJ2V2ZW50cycgfSwKICAqICAgeyBwdXJnZTogdHJ1ZSB9CiAgKiApCiAgKgogICogaWYgKGRyb3BFcnJvcj8uaXNOb3RGb3VuZCgpKSB7CiAgKiAgIGNvbnNvbGUubG9nKCdUYWJsZSBkb2VzIG5vdCBleGlzdCcpCiAgKiB9CiAgKgogICogLy8gRHJvcCBuYW1lc3BhY2UgKG11c3QgYmUgZW1wdHkpCiAgKiBhd2FpdCBjYXRhbG9nLmRyb3BOYW1lc3BhY2UoeyBuYW1lc3BhY2U6IFsnZGVmYXVsdCddIH0pCiAgKiBgYGAKICAqCiAgKiBAcmVtYXJrcwogICogVGhpcyBtZXRob2QgcHJvdmlkZXMgYSBicmlkZ2UgYmV0d2VlbiBTdXBhYmFzZSdzIGJ1Y2tldCBtYW5hZ2VtZW50IGFuZCB0aGUgc3RhbmRhcmQKICAqIEFwYWNoZSBJY2ViZXJnIFJFU1QgQ2F0YWxvZyBBUEkuIFRoZSBidWNrZXQgbmFtZSBtYXBzIHRvIHRoZSBJY2ViZXJnIHdhcmVob3VzZSBwYXJhbWV0ZXIuCiAgKiBBbGwgYXV0aGVudGljYXRpb24gYW5kIGNvbmZpZ3VyYXRpb24gaXMgaGFuZGxlZCBhdXRvbWF0aWNhbGx5IHVzaW5nIHlvdXIgU3VwYWJhc2UgY3JlZGVudGlhbHMuCiAgKgogICogKipFcnJvciBIYW5kbGluZyoqOiBJbnZhbGlkIGJ1Y2tldCBuYW1lcyB0aHJvdyBpbW1lZGlhdGVseS4gQWxsIGNhdGFsb2cKICAqIG9wZXJhdGlvbnMgcmV0dXJuIGB7IGRhdGEsIGVycm9yIH1gIHdoZXJlIGVycm9ycyBhcmUgYEljZWJlcmdFcnJvcmAgaW5zdGFuY2VzIGZyb20gaWNlYmVyZy1qcy4KICAqIFVzZSBoZWxwZXIgbWV0aG9kcyBsaWtlIGBlcnJvci5pc05vdEZvdW5kKClgIG9yIGNoZWNrIGBlcnJvci5zdGF0dXNgIGZvciBzcGVjaWZpYyBlcnJvciBoYW5kbGluZy4KICAqIFVzZSBgLnRocm93T25FcnJvcigpYCBvbiB0aGUgYW5hbHl0aWNzIGNsaWVudCBpZiB5b3UgcHJlZmVyIGV4Y2VwdGlvbnMgZm9yIGNhdGFsb2cgb3BlcmF0aW9ucy4KICAqCiAgKiAqKkNsZWFudXAgT3BlcmF0aW9ucyoqOiBXaGVuIHVzaW5nIGBkcm9wVGFibGVgLCB0aGUgYHB1cmdlOiB0cnVlYCBvcHRpb24gcGVybWFuZW50bHkKICAqIGRlbGV0ZXMgYWxsIHRhYmxlIGRhdGEuIFdpdGhvdXQgaXQsIHRoZSB0YWJsZSBpcyBtYXJrZWQgYXMgZGVsZXRlZCBidXQgZGF0YSByZW1haW5zLgogICoKICAqICoqTGlicmFyeSBEZXBlbmRlbmN5Kio6IFRoZSByZXR1cm5lZCBjYXRhbG9nIHdyYXBzIGBJY2ViZXJnUmVzdENhdGFsb2dgIGZyb20gaWNlYmVyZy1qcy4KICAqIEZvciBjb21wbGV0ZSBBUEkgZG9jdW1lbnRhdGlvbiBhbmQgYWR2YW5jZWQgdXNhZ2UsIHJlZmVyIHRvIHRoZQogICogW2ljZWJlcmctanMgZG9jdW1lbnRhdGlvbl0oaHR0cHM6Ly9zdXBhYmFzZS5naXRodWIuaW8vaWNlYmVyZy1qcy8pLgogICovCiAgZnJvbShidWNrZXROYW1lKSB7CiAgICB2YXIgX3RoaXM0ID0gdGhpczsKICAgIGlmICghaXNWYWxpZEJ1Y2tldE5hbWUoYnVja2V0TmFtZSkpIHRocm93IG5ldyBTdG9yYWdlRXJyb3IoIkludmFsaWQgYnVja2V0IG5hbWU6IEZpbGUsIGZvbGRlciwgYW5kIGJ1Y2tldCBuYW1lcyBtdXN0IGZvbGxvdyBBV1Mgb2JqZWN0IGtleSBuYW1pbmcgZ3VpZGVsaW5lcyBhbmQgc2hvdWxkIGF2b2lkIHRoZSB1c2Ugb2YgYW55IG90aGVyIGNoYXJhY3RlcnMuIik7CiAgICBjb25zdCBjYXRhbG9nID0gbmV3IEljZWJlcmdSZXN0Q2F0YWxvZyh7CiAgICAgIGJhc2VVcmw6IHRoaXMudXJsLAogICAgICBjYXRhbG9nTmFtZTogYnVja2V0TmFtZSwKICAgICAgYXV0aDogewogICAgICAgIHR5cGU6ICJjdXN0b20iLAogICAgICAgIGdldEhlYWRlcnM6IGFzeW5jICgpID0+IF90aGlzNC5oZWFkZXJzCiAgICAgIH0sCiAgICAgIGZldGNoOiB0aGlzLmZldGNoCiAgICB9KTsKICAgIGNvbnN0IHNob3VsZFRocm93T25FcnJvciA9IHRoaXMuc2hvdWxkVGhyb3dPbkVycm9yOwogICAgcmV0dXJuIG5ldyBQcm94eShjYXRhbG9nLCB7IGdldCh0YXJnZXQsIHByb3ApIHsKICAgICAgY29uc3QgdmFsdWUgPSB0YXJnZXRbcHJvcF07CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICJmdW5jdGlvbiIpIHJldHVybiB2YWx1ZTsKICAgICAgcmV0dXJuIGFzeW5jICguLi5hcmdzKSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGRhdGE6IGF3YWl0IHZhbHVlLmFwcGx5KHRhcmdldCwgYXJncyksCiAgICAgICAgICAgIGVycm9yOiBudWxsCiAgICAgICAgICB9OwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICBpZiAoc2hvdWxkVGhyb3dPbkVycm9yKSB0aHJvdyBlcnJvcjsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgICAgIGVycm9yCiAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgfTsKICAgIH0gfSk7CiAgfQp9Owp2YXIgVmVjdG9ySW5kZXhBcGkgPSBjbGFzcyBleHRlbmRzIEJhc2VBcGlDbGllbnQgewogIC8qKiBDcmVhdGVzIGEgbmV3IFZlY3RvckluZGV4QXBpIGluc3RhbmNlICovCiAgY29uc3RydWN0b3IodXJsLCBoZWFkZXJzID0ge30sIGZldGNoJDEpIHsKICAgIGNvbnN0IGZpbmFsVXJsID0gdXJsLnJlcGxhY2UoL1wvJC8sICIiKTsKICAgIGNvbnN0IGZpbmFsSGVhZGVycyA9IF9vYmplY3RTcHJlYWQyMTEoX29iamVjdFNwcmVhZDIxMSh7fSwgREVGQVVMVF9IRUFERVJTKSwge30sIHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LCBoZWFkZXJzKTsKICAgIHN1cGVyKGZpbmFsVXJsLCBmaW5hbEhlYWRlcnMsIGZldGNoJDEsICJ2ZWN0b3JzIik7CiAgfQogIC8qKiBDcmVhdGVzIGEgbmV3IHZlY3RvciBpbmRleCB3aXRoaW4gYSBidWNrZXQgKi8KICBhc3luYyBjcmVhdGVJbmRleChvcHRpb25zKSB7CiAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB2ZWN0b3JzQXBpLnBvc3QoX3RoaXMuZmV0Y2gsIGAke190aGlzLnVybH0vQ3JlYXRlSW5kZXhgLCBvcHRpb25zLCB7IGhlYWRlcnM6IF90aGlzLmhlYWRlcnMgfSkgfHwge307CiAgICB9KTsKICB9CiAgLyoqIFJldHJpZXZlcyBtZXRhZGF0YSBmb3IgYSBzcGVjaWZpYyB2ZWN0b3IgaW5kZXggKi8KICBhc3luYyBnZXRJbmRleCh2ZWN0b3JCdWNrZXROYW1lLCBpbmRleE5hbWUpIHsKICAgIHZhciBfdGhpczIgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzMi5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgdmVjdG9yc0FwaS5wb3N0KF90aGlzMi5mZXRjaCwgYCR7X3RoaXMyLnVybH0vR2V0SW5kZXhgLCB7CiAgICAgICAgdmVjdG9yQnVja2V0TmFtZSwKICAgICAgICBpbmRleE5hbWUKICAgICAgfSwgeyBoZWFkZXJzOiBfdGhpczIuaGVhZGVycyB9KTsKICAgIH0pOwogIH0KICAvKiogTGlzdHMgdmVjdG9yIGluZGV4ZXMgd2l0aGluIGEgYnVja2V0IHdpdGggb3B0aW9uYWwgZmlsdGVyaW5nIGFuZCBwYWdpbmF0aW9uICovCiAgYXN5bmMgbGlzdEluZGV4ZXMob3B0aW9ucykgewogICAgdmFyIF90aGlzMyA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXMzLmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB2ZWN0b3JzQXBpLnBvc3QoX3RoaXMzLmZldGNoLCBgJHtfdGhpczMudXJsfS9MaXN0SW5kZXhlc2AsIG9wdGlvbnMsIHsgaGVhZGVyczogX3RoaXMzLmhlYWRlcnMgfSk7CiAgICB9KTsKICB9CiAgLyoqIERlbGV0ZXMgYSB2ZWN0b3IgaW5kZXggYW5kIGFsbCBpdHMgZGF0YSAqLwogIGFzeW5jIGRlbGV0ZUluZGV4KHZlY3RvckJ1Y2tldE5hbWUsIGluZGV4TmFtZSkgewogICAgdmFyIF90aGlzNCA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXM0LmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB2ZWN0b3JzQXBpLnBvc3QoX3RoaXM0LmZldGNoLCBgJHtfdGhpczQudXJsfS9EZWxldGVJbmRleGAsIHsKICAgICAgICB2ZWN0b3JCdWNrZXROYW1lLAogICAgICAgIGluZGV4TmFtZQogICAgICB9LCB7IGhlYWRlcnM6IF90aGlzNC5oZWFkZXJzIH0pIHx8IHt9OwogICAgfSk7CiAgfQp9Owp2YXIgVmVjdG9yRGF0YUFwaSA9IGNsYXNzIGV4dGVuZHMgQmFzZUFwaUNsaWVudCB7CiAgLyoqIENyZWF0ZXMgYSBuZXcgVmVjdG9yRGF0YUFwaSBpbnN0YW5jZSAqLwogIGNvbnN0cnVjdG9yKHVybCwgaGVhZGVycyA9IHt9LCBmZXRjaCQxKSB7CiAgICBjb25zdCBmaW5hbFVybCA9IHVybC5yZXBsYWNlKC9cLyQvLCAiIik7CiAgICBjb25zdCBmaW5hbEhlYWRlcnMgPSBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIERFRkFVTFRfSEVBREVSUyksIHt9LCB7ICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIgfSwgaGVhZGVycyk7CiAgICBzdXBlcihmaW5hbFVybCwgZmluYWxIZWFkZXJzLCBmZXRjaCQxLCAidmVjdG9ycyIpOwogIH0KICAvKiogSW5zZXJ0cyBvciB1cGRhdGVzIHZlY3RvcnMgaW4gYmF0Y2ggKDEtNTAwIHBlciByZXF1ZXN0KSAqLwogIGFzeW5jIHB1dFZlY3RvcnMob3B0aW9ucykgewogICAgdmFyIF90aGlzID0gdGhpczsKICAgIGlmIChvcHRpb25zLnZlY3RvcnMubGVuZ3RoIDwgMSB8fCBvcHRpb25zLnZlY3RvcnMubGVuZ3RoID4gNTAwKSB0aHJvdyBuZXcgRXJyb3IoIlZlY3RvciBiYXRjaCBzaXplIG11c3QgYmUgYmV0d2VlbiAxIGFuZCA1MDAgaXRlbXMiKTsKICAgIHJldHVybiBfdGhpcy5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgdmVjdG9yc0FwaS5wb3N0KF90aGlzLmZldGNoLCBgJHtfdGhpcy51cmx9L1B1dFZlY3RvcnNgLCBvcHRpb25zLCB7IGhlYWRlcnM6IF90aGlzLmhlYWRlcnMgfSkgfHwge307CiAgICB9KTsKICB9CiAgLyoqIFJldHJpZXZlcyB2ZWN0b3JzIGJ5IHRoZWlyIGtleXMgaW4gYmF0Y2ggKi8KICBhc3luYyBnZXRWZWN0b3JzKG9wdGlvbnMpIHsKICAgIHZhciBfdGhpczIgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzMi5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgdmVjdG9yc0FwaS5wb3N0KF90aGlzMi5mZXRjaCwgYCR7X3RoaXMyLnVybH0vR2V0VmVjdG9yc2AsIG9wdGlvbnMsIHsgaGVhZGVyczogX3RoaXMyLmhlYWRlcnMgfSk7CiAgICB9KTsKICB9CiAgLyoqIExpc3RzIHZlY3RvcnMgaW4gYW4gaW5kZXggd2l0aCBwYWdpbmF0aW9uICovCiAgYXN5bmMgbGlzdFZlY3RvcnMob3B0aW9ucykgewogICAgdmFyIF90aGlzMyA9IHRoaXM7CiAgICBpZiAob3B0aW9ucy5zZWdtZW50Q291bnQgIT09IHZvaWQgMCkgewogICAgICBpZiAob3B0aW9ucy5zZWdtZW50Q291bnQgPCAxIHx8IG9wdGlvbnMuc2VnbWVudENvdW50ID4gMTYpIHRocm93IG5ldyBFcnJvcigic2VnbWVudENvdW50IG11c3QgYmUgYmV0d2VlbiAxIGFuZCAxNiIpOwogICAgICBpZiAob3B0aW9ucy5zZWdtZW50SW5kZXggIT09IHZvaWQgMCkgewogICAgICAgIGlmIChvcHRpb25zLnNlZ21lbnRJbmRleCA8IDAgfHwgb3B0aW9ucy5zZWdtZW50SW5kZXggPj0gb3B0aW9ucy5zZWdtZW50Q291bnQpIHRocm93IG5ldyBFcnJvcihgc2VnbWVudEluZGV4IG11c3QgYmUgYmV0d2VlbiAwIGFuZCAke29wdGlvbnMuc2VnbWVudENvdW50IC0gMX1gKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIF90aGlzMy5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgdmVjdG9yc0FwaS5wb3N0KF90aGlzMy5mZXRjaCwgYCR7X3RoaXMzLnVybH0vTGlzdFZlY3RvcnNgLCBvcHRpb25zLCB7IGhlYWRlcnM6IF90aGlzMy5oZWFkZXJzIH0pOwogICAgfSk7CiAgfQogIC8qKiBRdWVyaWVzIGZvciBzaW1pbGFyIHZlY3RvcnMgdXNpbmcgYXBwcm94aW1hdGUgbmVhcmVzdCBuZWlnaGJvciBzZWFyY2ggKi8KICBhc3luYyBxdWVyeVZlY3RvcnMob3B0aW9ucykgewogICAgdmFyIF90aGlzNCA9IHRoaXM7CiAgICByZXR1cm4gX3RoaXM0LmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB2ZWN0b3JzQXBpLnBvc3QoX3RoaXM0LmZldGNoLCBgJHtfdGhpczQudXJsfS9RdWVyeVZlY3RvcnNgLCBvcHRpb25zLCB7IGhlYWRlcnM6IF90aGlzNC5oZWFkZXJzIH0pOwogICAgfSk7CiAgfQogIC8qKiBEZWxldGVzIHZlY3RvcnMgYnkgdGhlaXIga2V5cyBpbiBiYXRjaCAoMS01MDAgcGVyIHJlcXVlc3QpICovCiAgYXN5bmMgZGVsZXRlVmVjdG9ycyhvcHRpb25zKSB7CiAgICB2YXIgX3RoaXM1ID0gdGhpczsKICAgIGlmIChvcHRpb25zLmtleXMubGVuZ3RoIDwgMSB8fCBvcHRpb25zLmtleXMubGVuZ3RoID4gNTAwKSB0aHJvdyBuZXcgRXJyb3IoIktleXMgYmF0Y2ggc2l6ZSBtdXN0IGJlIGJldHdlZW4gMSBhbmQgNTAwIGl0ZW1zIik7CiAgICByZXR1cm4gX3RoaXM1LmhhbmRsZU9wZXJhdGlvbihhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB2ZWN0b3JzQXBpLnBvc3QoX3RoaXM1LmZldGNoLCBgJHtfdGhpczUudXJsfS9EZWxldGVWZWN0b3JzYCwgb3B0aW9ucywgeyBoZWFkZXJzOiBfdGhpczUuaGVhZGVycyB9KSB8fCB7fTsKICAgIH0pOwogIH0KfTsKdmFyIFZlY3RvckJ1Y2tldEFwaSA9IGNsYXNzIGV4dGVuZHMgQmFzZUFwaUNsaWVudCB7CiAgLyoqIENyZWF0ZXMgYSBuZXcgVmVjdG9yQnVja2V0QXBpIGluc3RhbmNlICovCiAgY29uc3RydWN0b3IodXJsLCBoZWFkZXJzID0ge30sIGZldGNoJDEpIHsKICAgIGNvbnN0IGZpbmFsVXJsID0gdXJsLnJlcGxhY2UoL1wvJC8sICIiKTsKICAgIGNvbnN0IGZpbmFsSGVhZGVycyA9IF9vYmplY3RTcHJlYWQyMTEoX29iamVjdFNwcmVhZDIxMSh7fSwgREVGQVVMVF9IRUFERVJTKSwge30sIHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LCBoZWFkZXJzKTsKICAgIHN1cGVyKGZpbmFsVXJsLCBmaW5hbEhlYWRlcnMsIGZldGNoJDEsICJ2ZWN0b3JzIik7CiAgfQogIC8qKiBDcmVhdGVzIGEgbmV3IHZlY3RvciBidWNrZXQgKi8KICBhc3luYyBjcmVhdGVCdWNrZXQodmVjdG9yQnVja2V0TmFtZSkgewogICAgdmFyIF90aGlzID0gdGhpczsKICAgIHJldHVybiBfdGhpcy5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgdmVjdG9yc0FwaS5wb3N0KF90aGlzLmZldGNoLCBgJHtfdGhpcy51cmx9L0NyZWF0ZVZlY3RvckJ1Y2tldGAsIHsgdmVjdG9yQnVja2V0TmFtZSB9LCB7IGhlYWRlcnM6IF90aGlzLmhlYWRlcnMgfSkgfHwge307CiAgICB9KTsKICB9CiAgLyoqIFJldHJpZXZlcyBtZXRhZGF0YSBmb3IgYSBzcGVjaWZpYyB2ZWN0b3IgYnVja2V0ICovCiAgYXN5bmMgZ2V0QnVja2V0KHZlY3RvckJ1Y2tldE5hbWUpIHsKICAgIHZhciBfdGhpczIgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzMi5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgdmVjdG9yc0FwaS5wb3N0KF90aGlzMi5mZXRjaCwgYCR7X3RoaXMyLnVybH0vR2V0VmVjdG9yQnVja2V0YCwgeyB2ZWN0b3JCdWNrZXROYW1lIH0sIHsgaGVhZGVyczogX3RoaXMyLmhlYWRlcnMgfSk7CiAgICB9KTsKICB9CiAgLyoqIExpc3RzIHZlY3RvciBidWNrZXRzIHdpdGggb3B0aW9uYWwgZmlsdGVyaW5nIGFuZCBwYWdpbmF0aW9uICovCiAgYXN5bmMgbGlzdEJ1Y2tldHMob3B0aW9ucyA9IHt9KSB7CiAgICB2YXIgX3RoaXMzID0gdGhpczsKICAgIHJldHVybiBfdGhpczMuaGFuZGxlT3BlcmF0aW9uKGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHZlY3RvcnNBcGkucG9zdChfdGhpczMuZmV0Y2gsIGAke190aGlzMy51cmx9L0xpc3RWZWN0b3JCdWNrZXRzYCwgb3B0aW9ucywgeyBoZWFkZXJzOiBfdGhpczMuaGVhZGVycyB9KTsKICAgIH0pOwogIH0KICAvKiogRGVsZXRlcyBhIHZlY3RvciBidWNrZXQgKG11c3QgYmUgZW1wdHkgZmlyc3QpICovCiAgYXN5bmMgZGVsZXRlQnVja2V0KHZlY3RvckJ1Y2tldE5hbWUpIHsKICAgIHZhciBfdGhpczQgPSB0aGlzOwogICAgcmV0dXJuIF90aGlzNC5oYW5kbGVPcGVyYXRpb24oYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgdmVjdG9yc0FwaS5wb3N0KF90aGlzNC5mZXRjaCwgYCR7X3RoaXM0LnVybH0vRGVsZXRlVmVjdG9yQnVja2V0YCwgeyB2ZWN0b3JCdWNrZXROYW1lIH0sIHsgaGVhZGVyczogX3RoaXM0LmhlYWRlcnMgfSkgfHwge307CiAgICB9KTsKICB9Cn07CnZhciBTdG9yYWdlVmVjdG9yc0NsaWVudCA9IGNsYXNzIGV4dGVuZHMgVmVjdG9yQnVja2V0QXBpIHsKICAvKioKICAqIEBhbHBoYQogICoKICAqIENyZWF0ZXMgYSBTdG9yYWdlVmVjdG9yc0NsaWVudCB0aGF0IGNhbiBtYW5hZ2UgYnVja2V0cywgaW5kZXhlcywgYW5kIHZlY3RvcnMuCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgVmVjdG9yIEJ1Y2tldHMKICAqIEBwYXJhbSB1cmwgLSBCYXNlIFVSTCBvZiB0aGUgU3RvcmFnZSBWZWN0b3JzIFJFU1QgQVBJLgogICogQHBhcmFtIG9wdGlvbnMuaGVhZGVycyAtIE9wdGlvbmFsIGhlYWRlcnMgKGZvciBleGFtcGxlIGBBdXRob3JpemF0aW9uYCkgYXBwbGllZCB0byBldmVyeSByZXF1ZXN0LgogICogQHBhcmFtIG9wdGlvbnMuZmV0Y2ggLSBPcHRpb25hbCBjdXN0b20gYGZldGNoYCBpbXBsZW1lbnRhdGlvbiBmb3Igbm9uLWJyb3dzZXIgcnVudGltZXMuCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGNvbnN0IGNsaWVudCA9IG5ldyBTdG9yYWdlVmVjdG9yc0NsaWVudCh1cmwsIG9wdGlvbnMpCiAgKiBgYGAKICAqLwogIGNvbnN0cnVjdG9yKHVybCwgb3B0aW9ucyA9IHt9KSB7CiAgICBzdXBlcih1cmwsIG9wdGlvbnMuaGVhZGVycyB8fCB7fSwgb3B0aW9ucy5mZXRjaCk7CiAgfQogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIEFjY2VzcyBvcGVyYXRpb25zIGZvciBhIHNwZWNpZmljIHZlY3RvciBidWNrZXQKICAqIFJldHVybnMgYSBzY29wZWQgY2xpZW50IGZvciBpbmRleCBhbmQgdmVjdG9yIG9wZXJhdGlvbnMgd2l0aGluIHRoZSBidWNrZXQKICAqCiAgKiAqKlB1YmxpYyBhbHBoYToqKiBUaGlzIEFQSSBpcyBwYXJ0IG9mIGEgcHVibGljIGFscGhhIHJlbGVhc2UgYW5kIG1heSBub3QgYmUgYXZhaWxhYmxlIHRvIHlvdXIgYWNjb3VudCB0eXBlLgogICoKICAqIEBjYXRlZ29yeSBWZWN0b3IgQnVja2V0cwogICogQHBhcmFtIHZlY3RvckJ1Y2tldE5hbWUgLSBOYW1lIG9mIHRoZSB2ZWN0b3IgYnVja2V0CiAgKiBAcmV0dXJucyBCdWNrZXQtc2NvcGVkIGNsaWVudCB3aXRoIGluZGV4IGFuZCB2ZWN0b3Igb3BlcmF0aW9ucwogICoKICAqIEBleGFtcGxlCiAgKiBgYGB0eXBlc2NyaXB0CiAgKiBjb25zdCBidWNrZXQgPSBzdXBhYmFzZS5zdG9yYWdlLnZlY3RvcnMuZnJvbSgnZW1iZWRkaW5ncy1wcm9kJykKICAqIGBgYAogICovCiAgZnJvbSh2ZWN0b3JCdWNrZXROYW1lKSB7CiAgICByZXR1cm4gbmV3IFZlY3RvckJ1Y2tldFNjb3BlKHRoaXMudXJsLCB0aGlzLmhlYWRlcnMsIHZlY3RvckJ1Y2tldE5hbWUsIHRoaXMuZmV0Y2gpOwogIH0KICAvKioKICAqCiAgKiBAYWxwaGEKICAqCiAgKiBDcmVhdGVzIGEgbmV3IHZlY3RvciBidWNrZXQKICAqIFZlY3RvciBidWNrZXRzIGFyZSBjb250YWluZXJzIGZvciB2ZWN0b3IgaW5kZXhlcyBhbmQgdGhlaXIgZGF0YQogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IFZlY3RvciBCdWNrZXRzCiAgKiBAcGFyYW0gdmVjdG9yQnVja2V0TmFtZSAtIFVuaXF1ZSBuYW1lIGZvciB0aGUgdmVjdG9yIGJ1Y2tldAogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIGVtcHR5IHJlc3BvbnNlIG9uIHN1Y2Nlc3Mgb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZQogICogYGBgdHlwZXNjcmlwdAogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLnZlY3RvcnMKICAqICAgLmNyZWF0ZUJ1Y2tldCgnZW1iZWRkaW5ncy1wcm9kJykKICAqIGBgYAogICovCiAgYXN5bmMgY3JlYXRlQnVja2V0KHZlY3RvckJ1Y2tldE5hbWUpIHsKICAgIHZhciBfc3VwZXJwcm9wX2dldENyZWF0ZUJ1Y2tldCA9ICgpID0+IHN1cGVyLmNyZWF0ZUJ1Y2tldCwgX3RoaXMgPSB0aGlzOwogICAgcmV0dXJuIF9zdXBlcnByb3BfZ2V0Q3JlYXRlQnVja2V0KCkuY2FsbChfdGhpcywgdmVjdG9yQnVja2V0TmFtZSk7CiAgfQogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIFJldHJpZXZlcyBtZXRhZGF0YSBmb3IgYSBzcGVjaWZpYyB2ZWN0b3IgYnVja2V0CiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgVmVjdG9yIEJ1Y2tldHMKICAqIEBwYXJhbSB2ZWN0b3JCdWNrZXROYW1lIC0gTmFtZSBvZiB0aGUgdmVjdG9yIGJ1Y2tldAogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIGJ1Y2tldCBtZXRhZGF0YSBvciBlcnJvcgogICoKICAqIEBleGFtcGxlCiAgKiBgYGB0eXBlc2NyaXB0CiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAudmVjdG9ycwogICogICAuZ2V0QnVja2V0KCdlbWJlZGRpbmdzLXByb2QnKQogICoKICAqIGNvbnNvbGUubG9nKCdCdWNrZXQgY3JlYXRlZDonLCBkYXRhPy52ZWN0b3JCdWNrZXQuY3JlYXRpb25UaW1lKQogICogYGBgCiAgKi8KICBhc3luYyBnZXRCdWNrZXQodmVjdG9yQnVja2V0TmFtZSkgewogICAgdmFyIF9zdXBlcnByb3BfZ2V0R2V0QnVja2V0ID0gKCkgPT4gc3VwZXIuZ2V0QnVja2V0LCBfdGhpczIgPSB0aGlzOwogICAgcmV0dXJuIF9zdXBlcnByb3BfZ2V0R2V0QnVja2V0KCkuY2FsbChfdGhpczIsIHZlY3RvckJ1Y2tldE5hbWUpOwogIH0KICAvKioKICAqCiAgKiBAYWxwaGEKICAqCiAgKiBMaXN0cyBhbGwgdmVjdG9yIGJ1Y2tldHMgd2l0aCBvcHRpb25hbCBmaWx0ZXJpbmcgYW5kIHBhZ2luYXRpb24KICAqCiAgKiAqKlB1YmxpYyBhbHBoYToqKiBUaGlzIEFQSSBpcyBwYXJ0IG9mIGEgcHVibGljIGFscGhhIHJlbGVhc2UgYW5kIG1heSBub3QgYmUgYXZhaWxhYmxlIHRvIHlvdXIgYWNjb3VudCB0eXBlLgogICoKICAqIEBjYXRlZ29yeSBWZWN0b3IgQnVja2V0cwogICogQHBhcmFtIG9wdGlvbnMgLSBPcHRpb25hbCBmaWx0ZXJzIChwcmVmaXgsIG1heFJlc3VsdHMsIG5leHRUb2tlbikKICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCBsaXN0IG9mIGJ1Y2tldHMgb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZQogICogYGBgdHlwZXNjcmlwdAogICogY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UKICAqICAgLnN0b3JhZ2UKICAqICAgLnZlY3RvcnMKICAqICAgLmxpc3RCdWNrZXRzKHsgcHJlZml4OiAnZW1iZWRkaW5ncy0nIH0pCiAgKgogICogZGF0YT8udmVjdG9yQnVja2V0cy5mb3JFYWNoKGJ1Y2tldCA9PiB7CiAgKiAgIGNvbnNvbGUubG9nKGJ1Y2tldC52ZWN0b3JCdWNrZXROYW1lKQogICogfSkKICAqIGBgYAogICovCiAgYXN5bmMgbGlzdEJ1Y2tldHMob3B0aW9ucyA9IHt9KSB7CiAgICB2YXIgX3N1cGVycHJvcF9nZXRMaXN0QnVja2V0cyA9ICgpID0+IHN1cGVyLmxpc3RCdWNrZXRzLCBfdGhpczMgPSB0aGlzOwogICAgcmV0dXJuIF9zdXBlcnByb3BfZ2V0TGlzdEJ1Y2tldHMoKS5jYWxsKF90aGlzMywgb3B0aW9ucyk7CiAgfQogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIERlbGV0ZXMgYSB2ZWN0b3IgYnVja2V0IChidWNrZXQgbXVzdCBiZSBlbXB0eSkKICAqIEFsbCBpbmRleGVzIG11c3QgYmUgZGVsZXRlZCBiZWZvcmUgZGVsZXRpbmcgdGhlIGJ1Y2tldAogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IFZlY3RvciBCdWNrZXRzCiAgKiBAcGFyYW0gdmVjdG9yQnVja2V0TmFtZSAtIE5hbWUgb2YgdGhlIHZlY3RvciBidWNrZXQgdG8gZGVsZXRlCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggZW1wdHkgcmVzcG9uc2Ugb24gc3VjY2VzcyBvciBlcnJvcgogICoKICAqIEBleGFtcGxlCiAgKiBgYGB0eXBlc2NyaXB0CiAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZQogICogICAuc3RvcmFnZQogICogICAudmVjdG9ycwogICogICAuZGVsZXRlQnVja2V0KCdlbWJlZGRpbmdzLW9sZCcpCiAgKiBgYGAKICAqLwogIGFzeW5jIGRlbGV0ZUJ1Y2tldCh2ZWN0b3JCdWNrZXROYW1lKSB7CiAgICB2YXIgX3N1cGVycHJvcF9nZXREZWxldGVCdWNrZXQgPSAoKSA9PiBzdXBlci5kZWxldGVCdWNrZXQsIF90aGlzNCA9IHRoaXM7CiAgICByZXR1cm4gX3N1cGVycHJvcF9nZXREZWxldGVCdWNrZXQoKS5jYWxsKF90aGlzNCwgdmVjdG9yQnVja2V0TmFtZSk7CiAgfQp9Owp2YXIgVmVjdG9yQnVja2V0U2NvcGUgPSBjbGFzcyBleHRlbmRzIFZlY3RvckluZGV4QXBpIHsKICAvKioKICAqIEBhbHBoYQogICoKICAqIENyZWF0ZXMgYSBoZWxwZXIgdGhhdCBhdXRvbWF0aWNhbGx5IHNjb3BlcyBhbGwgaW5kZXggb3BlcmF0aW9ucyB0byB0aGUgcHJvdmlkZWQgYnVja2V0LgogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IFZlY3RvciBCdWNrZXRzCiAgKiBAZXhhbXBsZQogICogYGBgdHlwZXNjcmlwdAogICogY29uc3QgYnVja2V0ID0gc3VwYWJhc2Uuc3RvcmFnZS52ZWN0b3JzLmZyb20oJ2VtYmVkZGluZ3MtcHJvZCcpCiAgKiBgYGAKICAqLwogIGNvbnN0cnVjdG9yKHVybCwgaGVhZGVycywgdmVjdG9yQnVja2V0TmFtZSwgZmV0Y2gkMSkgewogICAgc3VwZXIodXJsLCBoZWFkZXJzLCBmZXRjaCQxKTsKICAgIHRoaXMudmVjdG9yQnVja2V0TmFtZSA9IHZlY3RvckJ1Y2tldE5hbWU7CiAgfQogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIENyZWF0ZXMgYSBuZXcgdmVjdG9yIGluZGV4IGluIHRoaXMgYnVja2V0CiAgKiBDb252ZW5pZW5jZSBtZXRob2QgdGhhdCBhdXRvbWF0aWNhbGx5IGluY2x1ZGVzIHRoZSBidWNrZXQgbmFtZQogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IFZlY3RvciBCdWNrZXRzCiAgKiBAcGFyYW0gb3B0aW9ucyAtIEluZGV4IGNvbmZpZ3VyYXRpb24gKHZlY3RvckJ1Y2tldE5hbWUgaXMgYXV0b21hdGljYWxseSBzZXQpCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggZW1wdHkgcmVzcG9uc2Ugb24gc3VjY2VzcyBvciBlcnJvcgogICoKICAqIEBleGFtcGxlCiAgKiBgYGB0eXBlc2NyaXB0CiAgKiBjb25zdCBidWNrZXQgPSBzdXBhYmFzZS5zdG9yYWdlLnZlY3RvcnMuZnJvbSgnZW1iZWRkaW5ncy1wcm9kJykKICAqIGF3YWl0IGJ1Y2tldC5jcmVhdGVJbmRleCh7CiAgKiAgIGluZGV4TmFtZTogJ2RvY3VtZW50cy1vcGVuYWknLAogICogICBkYXRhVHlwZTogJ2Zsb2F0MzInLAogICogICBkaW1lbnNpb246IDE1MzYsCiAgKiAgIGRpc3RhbmNlTWV0cmljOiAnY29zaW5lJywKICAqICAgbWV0YWRhdGFDb25maWd1cmF0aW9uOiB7CiAgKiAgICAgbm9uRmlsdGVyYWJsZU1ldGFkYXRhS2V5czogWydyYXdfdGV4dCddCiAgKiAgIH0KICAqIH0pCiAgKiBgYGAKICAqLwogIGFzeW5jIGNyZWF0ZUluZGV4KG9wdGlvbnMpIHsKICAgIHZhciBfc3VwZXJwcm9wX2dldENyZWF0ZUluZGV4ID0gKCkgPT4gc3VwZXIuY3JlYXRlSW5kZXgsIF90aGlzNSA9IHRoaXM7CiAgICByZXR1cm4gX3N1cGVycHJvcF9nZXRDcmVhdGVJbmRleCgpLmNhbGwoX3RoaXM1LCBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIG9wdGlvbnMpLCB7fSwgeyB2ZWN0b3JCdWNrZXROYW1lOiBfdGhpczUudmVjdG9yQnVja2V0TmFtZSB9KSk7CiAgfQogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIExpc3RzIGluZGV4ZXMgaW4gdGhpcyBidWNrZXQKICAqIENvbnZlbmllbmNlIG1ldGhvZCB0aGF0IGF1dG9tYXRpY2FsbHkgaW5jbHVkZXMgdGhlIGJ1Y2tldCBuYW1lCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgVmVjdG9yIEJ1Y2tldHMKICAqIEBwYXJhbSBvcHRpb25zIC0gTGlzdGluZyBvcHRpb25zICh2ZWN0b3JCdWNrZXROYW1lIGlzIGF1dG9tYXRpY2FsbHkgc2V0KQogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIHJlc3BvbnNlIGNvbnRhaW5pbmcgaW5kZXhlcyBhcnJheSBhbmQgcGFnaW5hdGlvbiB0b2tlbiBvciBlcnJvcgogICoKICAqIEBleGFtcGxlCiAgKiBgYGB0eXBlc2NyaXB0CiAgKiBjb25zdCBidWNrZXQgPSBzdXBhYmFzZS5zdG9yYWdlLnZlY3RvcnMuZnJvbSgnZW1iZWRkaW5ncy1wcm9kJykKICAqIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgYnVja2V0Lmxpc3RJbmRleGVzKHsgcHJlZml4OiAnZG9jdW1lbnRzLScgfSkKICAqIGBgYAogICovCiAgYXN5bmMgbGlzdEluZGV4ZXMob3B0aW9ucyA9IHt9KSB7CiAgICB2YXIgX3N1cGVycHJvcF9nZXRMaXN0SW5kZXhlcyA9ICgpID0+IHN1cGVyLmxpc3RJbmRleGVzLCBfdGhpczYgPSB0aGlzOwogICAgcmV0dXJuIF9zdXBlcnByb3BfZ2V0TGlzdEluZGV4ZXMoKS5jYWxsKF90aGlzNiwgX29iamVjdFNwcmVhZDIxMShfb2JqZWN0U3ByZWFkMjExKHt9LCBvcHRpb25zKSwge30sIHsgdmVjdG9yQnVja2V0TmFtZTogX3RoaXM2LnZlY3RvckJ1Y2tldE5hbWUgfSkpOwogIH0KICAvKioKICAqCiAgKiBAYWxwaGEKICAqCiAgKiBSZXRyaWV2ZXMgbWV0YWRhdGEgZm9yIGEgc3BlY2lmaWMgaW5kZXggaW4gdGhpcyBidWNrZXQKICAqIENvbnZlbmllbmNlIG1ldGhvZCB0aGF0IGF1dG9tYXRpY2FsbHkgaW5jbHVkZXMgdGhlIGJ1Y2tldCBuYW1lCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgVmVjdG9yIEJ1Y2tldHMKICAqIEBwYXJhbSBpbmRleE5hbWUgLSBOYW1lIG9mIHRoZSBpbmRleCB0byByZXRyaWV2ZQogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIGluZGV4IG1ldGFkYXRhIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGNvbnN0IGJ1Y2tldCA9IHN1cGFiYXNlLnN0b3JhZ2UudmVjdG9ycy5mcm9tKCdlbWJlZGRpbmdzLXByb2QnKQogICogY29uc3QgeyBkYXRhIH0gPSBhd2FpdCBidWNrZXQuZ2V0SW5kZXgoJ2RvY3VtZW50cy1vcGVuYWknKQogICogY29uc29sZS5sb2coJ0RpbWVuc2lvbjonLCBkYXRhPy5pbmRleC5kaW1lbnNpb24pCiAgKiBgYGAKICAqLwogIGFzeW5jIGdldEluZGV4KGluZGV4TmFtZSkgewogICAgdmFyIF9zdXBlcnByb3BfZ2V0R2V0SW5kZXggPSAoKSA9PiBzdXBlci5nZXRJbmRleCwgX3RoaXM3ID0gdGhpczsKICAgIHJldHVybiBfc3VwZXJwcm9wX2dldEdldEluZGV4KCkuY2FsbChfdGhpczcsIF90aGlzNy52ZWN0b3JCdWNrZXROYW1lLCBpbmRleE5hbWUpOwogIH0KICAvKioKICAqCiAgKiBAYWxwaGEKICAqCiAgKiBEZWxldGVzIGFuIGluZGV4IGZyb20gdGhpcyBidWNrZXQKICAqIENvbnZlbmllbmNlIG1ldGhvZCB0aGF0IGF1dG9tYXRpY2FsbHkgaW5jbHVkZXMgdGhlIGJ1Y2tldCBuYW1lCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgVmVjdG9yIEJ1Y2tldHMKICAqIEBwYXJhbSBpbmRleE5hbWUgLSBOYW1lIG9mIHRoZSBpbmRleCB0byBkZWxldGUKICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCBlbXB0eSByZXNwb25zZSBvbiBzdWNjZXNzIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGNvbnN0IGJ1Y2tldCA9IHN1cGFiYXNlLnN0b3JhZ2UudmVjdG9ycy5mcm9tKCdlbWJlZGRpbmdzLXByb2QnKQogICogYXdhaXQgYnVja2V0LmRlbGV0ZUluZGV4KCdvbGQtaW5kZXgnKQogICogYGBgCiAgKi8KICBhc3luYyBkZWxldGVJbmRleChpbmRleE5hbWUpIHsKICAgIHZhciBfc3VwZXJwcm9wX2dldERlbGV0ZUluZGV4ID0gKCkgPT4gc3VwZXIuZGVsZXRlSW5kZXgsIF90aGlzOCA9IHRoaXM7CiAgICByZXR1cm4gX3N1cGVycHJvcF9nZXREZWxldGVJbmRleCgpLmNhbGwoX3RoaXM4LCBfdGhpczgudmVjdG9yQnVja2V0TmFtZSwgaW5kZXhOYW1lKTsKICB9CiAgLyoqCiAgKgogICogQGFscGhhCiAgKgogICogQWNjZXNzIG9wZXJhdGlvbnMgZm9yIGEgc3BlY2lmaWMgaW5kZXggd2l0aGluIHRoaXMgYnVja2V0CiAgKiBSZXR1cm5zIGEgc2NvcGVkIGNsaWVudCBmb3IgdmVjdG9yIGRhdGEgb3BlcmF0aW9ucwogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IFZlY3RvciBCdWNrZXRzCiAgKiBAcGFyYW0gaW5kZXhOYW1lIC0gTmFtZSBvZiB0aGUgaW5kZXgKICAqIEByZXR1cm5zIEluZGV4LXNjb3BlZCBjbGllbnQgd2l0aCB2ZWN0b3IgZGF0YSBvcGVyYXRpb25zCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGNvbnN0IGluZGV4ID0gc3VwYWJhc2Uuc3RvcmFnZS52ZWN0b3JzLmZyb20oJ2VtYmVkZGluZ3MtcHJvZCcpLmluZGV4KCdkb2N1bWVudHMtb3BlbmFpJykKICAqCiAgKiAvLyBJbnNlcnQgdmVjdG9ycwogICogYXdhaXQgaW5kZXgucHV0VmVjdG9ycyh7CiAgKiAgIHZlY3RvcnM6IFsKICAqICAgICB7IGtleTogJ2RvYy0xJywgZGF0YTogeyBmbG9hdDMyOiBbLi4uXSB9LCBtZXRhZGF0YTogeyB0aXRsZTogJ0ludHJvJyB9IH0KICAqICAgXQogICogfSkKICAqCiAgKiAvLyBRdWVyeSBzaW1pbGFyIHZlY3RvcnMKICAqIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgaW5kZXgucXVlcnlWZWN0b3JzKHsKICAqICAgcXVlcnlWZWN0b3I6IHsgZmxvYXQzMjogWy4uLl0gfSwKICAqICAgdG9wSzogNQogICogfSkKICAqIGBgYAogICovCiAgaW5kZXgoaW5kZXhOYW1lKSB7CiAgICByZXR1cm4gbmV3IFZlY3RvckluZGV4U2NvcGUodGhpcy51cmwsIHRoaXMuaGVhZGVycywgdGhpcy52ZWN0b3JCdWNrZXROYW1lLCBpbmRleE5hbWUsIHRoaXMuZmV0Y2gpOwogIH0KfTsKdmFyIFZlY3RvckluZGV4U2NvcGUgPSBjbGFzcyBleHRlbmRzIFZlY3RvckRhdGFBcGkgewogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIENyZWF0ZXMgYSBoZWxwZXIgdGhhdCBhdXRvbWF0aWNhbGx5IHNjb3BlcyBhbGwgdmVjdG9yIG9wZXJhdGlvbnMgdG8gdGhlIHByb3ZpZGVkIGJ1Y2tldC9pbmRleCBuYW1lcy4KICAqCiAgKiAqKlB1YmxpYyBhbHBoYToqKiBUaGlzIEFQSSBpcyBwYXJ0IG9mIGEgcHVibGljIGFscGhhIHJlbGVhc2UgYW5kIG1heSBub3QgYmUgYXZhaWxhYmxlIHRvIHlvdXIgYWNjb3VudCB0eXBlLgogICoKICAqIEBjYXRlZ29yeSBWZWN0b3IgQnVja2V0cwogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGNvbnN0IGluZGV4ID0gc3VwYWJhc2Uuc3RvcmFnZS52ZWN0b3JzLmZyb20oJ2VtYmVkZGluZ3MtcHJvZCcpLmluZGV4KCdkb2N1bWVudHMtb3BlbmFpJykKICAqIGBgYAogICovCiAgY29uc3RydWN0b3IodXJsLCBoZWFkZXJzLCB2ZWN0b3JCdWNrZXROYW1lLCBpbmRleE5hbWUsIGZldGNoJDEpIHsKICAgIHN1cGVyKHVybCwgaGVhZGVycywgZmV0Y2gkMSk7CiAgICB0aGlzLnZlY3RvckJ1Y2tldE5hbWUgPSB2ZWN0b3JCdWNrZXROYW1lOwogICAgdGhpcy5pbmRleE5hbWUgPSBpbmRleE5hbWU7CiAgfQogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIEluc2VydHMgb3IgdXBkYXRlcyB2ZWN0b3JzIGluIHRoaXMgaW5kZXgKICAqIENvbnZlbmllbmNlIG1ldGhvZCB0aGF0IGF1dG9tYXRpY2FsbHkgaW5jbHVkZXMgYnVja2V0IGFuZCBpbmRleCBuYW1lcwogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IFZlY3RvciBCdWNrZXRzCiAgKiBAcGFyYW0gb3B0aW9ucyAtIFZlY3RvciBpbnNlcnRpb24gb3B0aW9ucyAoYnVja2V0IGFuZCBpbmRleCBuYW1lcyBhdXRvbWF0aWNhbGx5IHNldCkKICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCBlbXB0eSByZXNwb25zZSBvbiBzdWNjZXNzIG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGNvbnN0IGluZGV4ID0gc3VwYWJhc2Uuc3RvcmFnZS52ZWN0b3JzLmZyb20oJ2VtYmVkZGluZ3MtcHJvZCcpLmluZGV4KCdkb2N1bWVudHMtb3BlbmFpJykKICAqIGF3YWl0IGluZGV4LnB1dFZlY3RvcnMoewogICogICB2ZWN0b3JzOiBbCiAgKiAgICAgewogICogICAgICAga2V5OiAnZG9jLTEnLAogICogICAgICAgZGF0YTogeyBmbG9hdDMyOiBbMC4xLCAwLjIsIC4uLl0gfSwKICAqICAgICAgIG1ldGFkYXRhOiB7IHRpdGxlOiAnSW50cm9kdWN0aW9uJywgcGFnZTogMSB9CiAgKiAgICAgfQogICogICBdCiAgKiB9KQogICogYGBgCiAgKi8KICBhc3luYyBwdXRWZWN0b3JzKG9wdGlvbnMpIHsKICAgIHZhciBfc3VwZXJwcm9wX2dldFB1dFZlY3RvcnMgPSAoKSA9PiBzdXBlci5wdXRWZWN0b3JzLCBfdGhpczkgPSB0aGlzOwogICAgcmV0dXJuIF9zdXBlcnByb3BfZ2V0UHV0VmVjdG9ycygpLmNhbGwoX3RoaXM5LCBfb2JqZWN0U3ByZWFkMjExKF9vYmplY3RTcHJlYWQyMTEoe30sIG9wdGlvbnMpLCB7fSwgewogICAgICB2ZWN0b3JCdWNrZXROYW1lOiBfdGhpczkudmVjdG9yQnVja2V0TmFtZSwKICAgICAgaW5kZXhOYW1lOiBfdGhpczkuaW5kZXhOYW1lCiAgICB9KSk7CiAgfQogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIFJldHJpZXZlcyB2ZWN0b3JzIGJ5IGtleXMgZnJvbSB0aGlzIGluZGV4CiAgKiBDb252ZW5pZW5jZSBtZXRob2QgdGhhdCBhdXRvbWF0aWNhbGx5IGluY2x1ZGVzIGJ1Y2tldCBhbmQgaW5kZXggbmFtZXMKICAqCiAgKiAqKlB1YmxpYyBhbHBoYToqKiBUaGlzIEFQSSBpcyBwYXJ0IG9mIGEgcHVibGljIGFscGhhIHJlbGVhc2UgYW5kIG1heSBub3QgYmUgYXZhaWxhYmxlIHRvIHlvdXIgYWNjb3VudCB0eXBlLgogICoKICAqIEBjYXRlZ29yeSBWZWN0b3IgQnVja2V0cwogICogQHBhcmFtIG9wdGlvbnMgLSBWZWN0b3IgcmV0cmlldmFsIG9wdGlvbnMgKGJ1Y2tldCBhbmQgaW5kZXggbmFtZXMgYXV0b21hdGljYWxseSBzZXQpCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggcmVzcG9uc2UgY29udGFpbmluZyB2ZWN0b3JzIGFycmF5IG9yIGVycm9yCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGNvbnN0IGluZGV4ID0gc3VwYWJhc2Uuc3RvcmFnZS52ZWN0b3JzLmZyb20oJ2VtYmVkZGluZ3MtcHJvZCcpLmluZGV4KCdkb2N1bWVudHMtb3BlbmFpJykKICAqIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgaW5kZXguZ2V0VmVjdG9ycyh7CiAgKiAgIGtleXM6IFsnZG9jLTEnLCAnZG9jLTInXSwKICAqICAgcmV0dXJuTWV0YWRhdGE6IHRydWUKICAqIH0pCiAgKiBgYGAKICAqLwogIGFzeW5jIGdldFZlY3RvcnMob3B0aW9ucykgewogICAgdmFyIF9zdXBlcnByb3BfZ2V0R2V0VmVjdG9ycyA9ICgpID0+IHN1cGVyLmdldFZlY3RvcnMsIF90aGlzMTAgPSB0aGlzOwogICAgcmV0dXJuIF9zdXBlcnByb3BfZ2V0R2V0VmVjdG9ycygpLmNhbGwoX3RoaXMxMCwgX29iamVjdFNwcmVhZDIxMShfb2JqZWN0U3ByZWFkMjExKHt9LCBvcHRpb25zKSwge30sIHsKICAgICAgdmVjdG9yQnVja2V0TmFtZTogX3RoaXMxMC52ZWN0b3JCdWNrZXROYW1lLAogICAgICBpbmRleE5hbWU6IF90aGlzMTAuaW5kZXhOYW1lCiAgICB9KSk7CiAgfQogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIExpc3RzIHZlY3RvcnMgaW4gdGhpcyBpbmRleCB3aXRoIHBhZ2luYXRpb24KICAqIENvbnZlbmllbmNlIG1ldGhvZCB0aGF0IGF1dG9tYXRpY2FsbHkgaW5jbHVkZXMgYnVja2V0IGFuZCBpbmRleCBuYW1lcwogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IFZlY3RvciBCdWNrZXRzCiAgKiBAcGFyYW0gb3B0aW9ucyAtIExpc3Rpbmcgb3B0aW9ucyAoYnVja2V0IGFuZCBpbmRleCBuYW1lcyBhdXRvbWF0aWNhbGx5IHNldCkKICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCByZXNwb25zZSBjb250YWluaW5nIHZlY3RvcnMgYXJyYXkgYW5kIHBhZ2luYXRpb24gdG9rZW4gb3IgZXJyb3IKICAqCiAgKiBAZXhhbXBsZQogICogYGBgdHlwZXNjcmlwdAogICogY29uc3QgaW5kZXggPSBzdXBhYmFzZS5zdG9yYWdlLnZlY3RvcnMuZnJvbSgnZW1iZWRkaW5ncy1wcm9kJykuaW5kZXgoJ2RvY3VtZW50cy1vcGVuYWknKQogICogY29uc3QgeyBkYXRhIH0gPSBhd2FpdCBpbmRleC5saXN0VmVjdG9ycyh7CiAgKiAgIG1heFJlc3VsdHM6IDUwMCwKICAqICAgcmV0dXJuTWV0YWRhdGE6IHRydWUKICAqIH0pCiAgKiBgYGAKICAqLwogIGFzeW5jIGxpc3RWZWN0b3JzKG9wdGlvbnMgPSB7fSkgewogICAgdmFyIF9zdXBlcnByb3BfZ2V0TGlzdFZlY3RvcnMgPSAoKSA9PiBzdXBlci5saXN0VmVjdG9ycywgX3RoaXMxMSA9IHRoaXM7CiAgICByZXR1cm4gX3N1cGVycHJvcF9nZXRMaXN0VmVjdG9ycygpLmNhbGwoX3RoaXMxMSwgX29iamVjdFNwcmVhZDIxMShfb2JqZWN0U3ByZWFkMjExKHt9LCBvcHRpb25zKSwge30sIHsKICAgICAgdmVjdG9yQnVja2V0TmFtZTogX3RoaXMxMS52ZWN0b3JCdWNrZXROYW1lLAogICAgICBpbmRleE5hbWU6IF90aGlzMTEuaW5kZXhOYW1lCiAgICB9KSk7CiAgfQogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIFF1ZXJpZXMgZm9yIHNpbWlsYXIgdmVjdG9ycyBpbiB0aGlzIGluZGV4CiAgKiBDb252ZW5pZW5jZSBtZXRob2QgdGhhdCBhdXRvbWF0aWNhbGx5IGluY2x1ZGVzIGJ1Y2tldCBhbmQgaW5kZXggbmFtZXMKICAqCiAgKiAqKlB1YmxpYyBhbHBoYToqKiBUaGlzIEFQSSBpcyBwYXJ0IG9mIGEgcHVibGljIGFscGhhIHJlbGVhc2UgYW5kIG1heSBub3QgYmUgYXZhaWxhYmxlIHRvIHlvdXIgYWNjb3VudCB0eXBlLgogICoKICAqIEBjYXRlZ29yeSBWZWN0b3IgQnVja2V0cwogICogQHBhcmFtIG9wdGlvbnMgLSBRdWVyeSBvcHRpb25zIChidWNrZXQgYW5kIGluZGV4IG5hbWVzIGF1dG9tYXRpY2FsbHkgc2V0KQogICogQHJldHVybnMgUHJvbWlzZSB3aXRoIHJlc3BvbnNlIGNvbnRhaW5pbmcgbWF0Y2hlcyBhcnJheSBvZiBzaW1pbGFyIHZlY3RvcnMgb3JkZXJlZCBieSBkaXN0YW5jZSBvciBlcnJvcgogICoKICAqIEBleGFtcGxlCiAgKiBgYGB0eXBlc2NyaXB0CiAgKiBjb25zdCBpbmRleCA9IHN1cGFiYXNlLnN0b3JhZ2UudmVjdG9ycy5mcm9tKCdlbWJlZGRpbmdzLXByb2QnKS5pbmRleCgnZG9jdW1lbnRzLW9wZW5haScpCiAgKiBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IGluZGV4LnF1ZXJ5VmVjdG9ycyh7CiAgKiAgIHF1ZXJ5VmVjdG9yOiB7IGZsb2F0MzI6IFswLjEsIDAuMiwgLi4uXSB9LAogICogICB0b3BLOiA1LAogICogICBmaWx0ZXI6IHsgY2F0ZWdvcnk6ICd0ZWNobmljYWwnIH0sCiAgKiAgIHJldHVybkRpc3RhbmNlOiB0cnVlLAogICogICByZXR1cm5NZXRhZGF0YTogdHJ1ZQogICogfSkKICAqIGBgYAogICovCiAgYXN5bmMgcXVlcnlWZWN0b3JzKG9wdGlvbnMpIHsKICAgIHZhciBfc3VwZXJwcm9wX2dldFF1ZXJ5VmVjdG9ycyA9ICgpID0+IHN1cGVyLnF1ZXJ5VmVjdG9ycywgX3RoaXMxMiA9IHRoaXM7CiAgICByZXR1cm4gX3N1cGVycHJvcF9nZXRRdWVyeVZlY3RvcnMoKS5jYWxsKF90aGlzMTIsIF9vYmplY3RTcHJlYWQyMTEoX29iamVjdFNwcmVhZDIxMSh7fSwgb3B0aW9ucyksIHt9LCB7CiAgICAgIHZlY3RvckJ1Y2tldE5hbWU6IF90aGlzMTIudmVjdG9yQnVja2V0TmFtZSwKICAgICAgaW5kZXhOYW1lOiBfdGhpczEyLmluZGV4TmFtZQogICAgfSkpOwogIH0KICAvKioKICAqCiAgKiBAYWxwaGEKICAqCiAgKiBEZWxldGVzIHZlY3RvcnMgYnkga2V5cyBmcm9tIHRoaXMgaW5kZXgKICAqIENvbnZlbmllbmNlIG1ldGhvZCB0aGF0IGF1dG9tYXRpY2FsbHkgaW5jbHVkZXMgYnVja2V0IGFuZCBpbmRleCBuYW1lcwogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IFZlY3RvciBCdWNrZXRzCiAgKiBAcGFyYW0gb3B0aW9ucyAtIERlbGV0aW9uIG9wdGlvbnMgKGJ1Y2tldCBhbmQgaW5kZXggbmFtZXMgYXV0b21hdGljYWxseSBzZXQpCiAgKiBAcmV0dXJucyBQcm9taXNlIHdpdGggZW1wdHkgcmVzcG9uc2Ugb24gc3VjY2VzcyBvciBlcnJvcgogICoKICAqIEBleGFtcGxlCiAgKiBgYGB0eXBlc2NyaXB0CiAgKiBjb25zdCBpbmRleCA9IHN1cGFiYXNlLnN0b3JhZ2UudmVjdG9ycy5mcm9tKCdlbWJlZGRpbmdzLXByb2QnKS5pbmRleCgnZG9jdW1lbnRzLW9wZW5haScpCiAgKiBhd2FpdCBpbmRleC5kZWxldGVWZWN0b3JzKHsKICAqICAga2V5czogWydkb2MtMScsICdkb2MtMicsICdkb2MtMyddCiAgKiB9KQogICogYGBgCiAgKi8KICBhc3luYyBkZWxldGVWZWN0b3JzKG9wdGlvbnMpIHsKICAgIHZhciBfc3VwZXJwcm9wX2dldERlbGV0ZVZlY3RvcnMgPSAoKSA9PiBzdXBlci5kZWxldGVWZWN0b3JzLCBfdGhpczEzID0gdGhpczsKICAgIHJldHVybiBfc3VwZXJwcm9wX2dldERlbGV0ZVZlY3RvcnMoKS5jYWxsKF90aGlzMTMsIF9vYmplY3RTcHJlYWQyMTEoX29iamVjdFNwcmVhZDIxMSh7fSwgb3B0aW9ucyksIHt9LCB7CiAgICAgIHZlY3RvckJ1Y2tldE5hbWU6IF90aGlzMTMudmVjdG9yQnVja2V0TmFtZSwKICAgICAgaW5kZXhOYW1lOiBfdGhpczEzLmluZGV4TmFtZQogICAgfSkpOwogIH0KfTsKdmFyIFN0b3JhZ2VDbGllbnQgPSBjbGFzcyBleHRlbmRzIFN0b3JhZ2VCdWNrZXRBcGkgewogIC8qKgogICogQ3JlYXRlcyBhIGNsaWVudCBmb3IgU3RvcmFnZSBidWNrZXRzLCBmaWxlcywgYW5hbHl0aWNzLCBhbmQgdmVjdG9ycy4KICAqCiAgKiBAY2F0ZWdvcnkgRmlsZSBCdWNrZXRzCiAgKiBAZXhhbXBsZQogICogYGBgdHMKICAqIGltcG9ydCB7IFN0b3JhZ2VDbGllbnQgfSBmcm9tICdAc3VwYWJhc2Uvc3RvcmFnZS1qcycKICAqCiAgKiBjb25zdCBzdG9yYWdlID0gbmV3IFN0b3JhZ2VDbGllbnQoJ2h0dHBzOi8veHl6Y29tcGFueS5zdXBhYmFzZS5jby9zdG9yYWdlL3YxJywgewogICogICBhcGlrZXk6ICdwdWJsaWMtYW5vbi1rZXknLAogICogfSkKICAqIGNvbnN0IGF2YXRhcnMgPSBzdG9yYWdlLmZyb20oJ2F2YXRhcnMnKQogICogYGBgCiAgKi8KICBjb25zdHJ1Y3Rvcih1cmwsIGhlYWRlcnMgPSB7fSwgZmV0Y2gkMSwgb3B0cykgewogICAgc3VwZXIodXJsLCBoZWFkZXJzLCBmZXRjaCQxLCBvcHRzKTsKICB9CiAgLyoqCiAgKiBQZXJmb3JtIGZpbGUgb3BlcmF0aW9uIGluIGEgYnVja2V0LgogICoKICAqIEBjYXRlZ29yeSBGaWxlIEJ1Y2tldHMKICAqIEBwYXJhbSBpZCBUaGUgYnVja2V0IGlkIHRvIG9wZXJhdGUgb24uCiAgKgogICogQGV4YW1wbGUKICAqIGBgYHR5cGVzY3JpcHQKICAqIGNvbnN0IGF2YXRhcnMgPSBzdXBhYmFzZS5zdG9yYWdlLmZyb20oJ2F2YXRhcnMnKQogICogYGBgCiAgKi8KICBmcm9tKGlkKSB7CiAgICByZXR1cm4gbmV3IFN0b3JhZ2VGaWxlQXBpKHRoaXMudXJsLCB0aGlzLmhlYWRlcnMsIGlkLCB0aGlzLmZldGNoKTsKICB9CiAgLyoqCiAgKgogICogQGFscGhhCiAgKgogICogQWNjZXNzIHZlY3RvciBzdG9yYWdlIG9wZXJhdGlvbnMuCiAgKgogICogKipQdWJsaWMgYWxwaGE6KiogVGhpcyBBUEkgaXMgcGFydCBvZiBhIHB1YmxpYyBhbHBoYSByZWxlYXNlIGFuZCBtYXkgbm90IGJlIGF2YWlsYWJsZSB0byB5b3VyIGFjY291bnQgdHlwZS4KICAqCiAgKiBAY2F0ZWdvcnkgVmVjdG9yIEJ1Y2tldHMKICAqIEByZXR1cm5zIEEgU3RvcmFnZVZlY3RvcnNDbGllbnQgaW5zdGFuY2UgY29uZmlndXJlZCB3aXRoIHRoZSBjdXJyZW50IHN0b3JhZ2Ugc2V0dGluZ3MuCiAgKi8KICBnZXQgdmVjdG9ycygpIHsKICAgIHJldHVybiBuZXcgU3RvcmFnZVZlY3RvcnNDbGllbnQodGhpcy51cmwgKyAiL3ZlY3RvciIsIHsKICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICBmZXRjaDogdGhpcy5mZXRjaAogICAgfSk7CiAgfQogIC8qKgogICoKICAqIEBhbHBoYQogICoKICAqIEFjY2VzcyBhbmFseXRpY3Mgc3RvcmFnZSBvcGVyYXRpb25zIHVzaW5nIEljZWJlcmcgdGFibGVzLgogICoKICAqICoqUHVibGljIGFscGhhOioqIFRoaXMgQVBJIGlzIHBhcnQgb2YgYSBwdWJsaWMgYWxwaGEgcmVsZWFzZSBhbmQgbWF5IG5vdCBiZSBhdmFpbGFibGUgdG8geW91ciBhY2NvdW50IHR5cGUuCiAgKgogICogQGNhdGVnb3J5IEFuYWx5dGljcyBCdWNrZXRzCiAgKiBAcmV0dXJucyBBIFN0b3JhZ2VBbmFseXRpY3NDbGllbnQgaW5zdGFuY2UgY29uZmlndXJlZCB3aXRoIHRoZSBjdXJyZW50IHN0b3JhZ2Ugc2V0dGluZ3MuCiAgKi8KICBnZXQgYW5hbHl0aWNzKCkgewogICAgcmV0dXJuIG5ldyBTdG9yYWdlQW5hbHl0aWNzQ2xpZW50KHRoaXMudXJsICsgIi9pY2ViZXJnIiwgdGhpcy5oZWFkZXJzLCB0aGlzLmZldGNoKTsKICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK2F1dGgtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvYXV0aC1qcy9kaXN0L21vZHVsZS9saWIvdmVyc2lvbi5qcwp2YXIgdmVyc2lvbjQgPSAiMi45Ny4wIjsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrYXV0aC1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9hdXRoLWpzL2Rpc3QvbW9kdWxlL2xpYi9jb25zdGFudHMuanMKdmFyIEFVVE9fUkVGUkVTSF9USUNLX0RVUkFUSU9OX01TID0gMzAgKiAxZTM7CnZhciBBVVRPX1JFRlJFU0hfVElDS19USFJFU0hPTEQgPSAzOwp2YXIgRVhQSVJZX01BUkdJTl9NUyA9IEFVVE9fUkVGUkVTSF9USUNLX1RIUkVTSE9MRCAqIEFVVE9fUkVGUkVTSF9USUNLX0RVUkFUSU9OX01TOwp2YXIgR09UUlVFX1VSTCA9ICJodHRwOi8vbG9jYWxob3N0Ojk5OTkiOwp2YXIgU1RPUkFHRV9LRVkgPSAic3VwYWJhc2UuYXV0aC50b2tlbiI7CnZhciBERUZBVUxUX0hFQURFUlMyID0geyAiWC1DbGllbnQtSW5mbyI6IGBnb3RydWUtanMvJHt2ZXJzaW9uNH1gIH07CnZhciBBUElfVkVSU0lPTl9IRUFERVJfTkFNRSA9ICJYLVN1cGFiYXNlLUFwaS1WZXJzaW9uIjsKdmFyIEFQSV9WRVJTSU9OUyA9IHsKICAiMjAyNC0wMS0wMSI6IHsKICAgIHRpbWVzdGFtcDogRGF0ZS5wYXJzZSgiMjAyNC0wMS0wMVQwMDowMDowMC4wWiIpLAogICAgbmFtZTogIjIwMjQtMDEtMDEiCiAgfQp9Owp2YXIgQkFTRTY0VVJMX1JFR0VYID0gL14oW2EtejAtOV8tXXs0fSkqKCR8W2EtejAtOV8tXXszfSR8W2EtejAtOV8tXXsyfSQpJC9pOwp2YXIgSldLU19UVEwgPSAxMCAqIDYwICogMWUzOwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZSthdXRoLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL2F1dGgtanMvZGlzdC9tb2R1bGUvbGliL2Vycm9ycy5qcwp2YXIgQXV0aEVycm9yID0gY2xhc3MgZXh0ZW5kcyBFcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSwgc3RhdHVzLCBjb2RlKSB7CiAgICBzdXBlcihtZXNzYWdlKTsKICAgIHRoaXMuX19pc0F1dGhFcnJvciA9IHRydWU7CiAgICB0aGlzLm5hbWUgPSAiQXV0aEVycm9yIjsKICAgIHRoaXMuc3RhdHVzID0gc3RhdHVzOwogICAgdGhpcy5jb2RlID0gY29kZTsKICB9Cn07CmZ1bmN0aW9uIGlzQXV0aEVycm9yKGVycm9yKSB7CiAgcmV0dXJuIHR5cGVvZiBlcnJvciA9PT0gIm9iamVjdCIgJiYgZXJyb3IgIT09IG51bGwgJiYgIl9faXNBdXRoRXJyb3IiIGluIGVycm9yOwp9CnZhciBBdXRoQXBpRXJyb3IgPSBjbGFzcyBleHRlbmRzIEF1dGhFcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSwgc3RhdHVzLCBjb2RlKSB7CiAgICBzdXBlcihtZXNzYWdlLCBzdGF0dXMsIGNvZGUpOwogICAgdGhpcy5uYW1lID0gIkF1dGhBcGlFcnJvciI7CiAgICB0aGlzLnN0YXR1cyA9IHN0YXR1czsKICAgIHRoaXMuY29kZSA9IGNvZGU7CiAgfQp9OwpmdW5jdGlvbiBpc0F1dGhBcGlFcnJvcihlcnJvcikgewogIHJldHVybiBpc0F1dGhFcnJvcihlcnJvcikgJiYgZXJyb3IubmFtZSA9PT0gIkF1dGhBcGlFcnJvciI7Cn0KdmFyIEF1dGhVbmtub3duRXJyb3IgPSBjbGFzcyBleHRlbmRzIEF1dGhFcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSwgb3JpZ2luYWxFcnJvcikgewogICAgc3VwZXIobWVzc2FnZSk7CiAgICB0aGlzLm5hbWUgPSAiQXV0aFVua25vd25FcnJvciI7CiAgICB0aGlzLm9yaWdpbmFsRXJyb3IgPSBvcmlnaW5hbEVycm9yOwogIH0KfTsKdmFyIEN1c3RvbUF1dGhFcnJvciA9IGNsYXNzIGV4dGVuZHMgQXV0aEVycm9yIHsKICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBuYW1lLCBzdGF0dXMsIGNvZGUpIHsKICAgIHN1cGVyKG1lc3NhZ2UsIHN0YXR1cywgY29kZSk7CiAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgdGhpcy5zdGF0dXMgPSBzdGF0dXM7CiAgfQp9Owp2YXIgQXV0aFNlc3Npb25NaXNzaW5nRXJyb3IgPSBjbGFzcyBleHRlbmRzIEN1c3RvbUF1dGhFcnJvciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcigiQXV0aCBzZXNzaW9uIG1pc3NpbmchIiwgIkF1dGhTZXNzaW9uTWlzc2luZ0Vycm9yIiwgNDAwLCB2b2lkIDApOwogIH0KfTsKZnVuY3Rpb24gaXNBdXRoU2Vzc2lvbk1pc3NpbmdFcnJvcihlcnJvcikgewogIHJldHVybiBpc0F1dGhFcnJvcihlcnJvcikgJiYgZXJyb3IubmFtZSA9PT0gIkF1dGhTZXNzaW9uTWlzc2luZ0Vycm9yIjsKfQp2YXIgQXV0aEludmFsaWRUb2tlblJlc3BvbnNlRXJyb3IgPSBjbGFzcyBleHRlbmRzIEN1c3RvbUF1dGhFcnJvciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcigiQXV0aCBzZXNzaW9uIG9yIHVzZXIgbWlzc2luZyIsICJBdXRoSW52YWxpZFRva2VuUmVzcG9uc2VFcnJvciIsIDUwMCwgdm9pZCAwKTsKICB9Cn07CnZhciBBdXRoSW52YWxpZENyZWRlbnRpYWxzRXJyb3IgPSBjbGFzcyBleHRlbmRzIEN1c3RvbUF1dGhFcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSkgewogICAgc3VwZXIobWVzc2FnZSwgIkF1dGhJbnZhbGlkQ3JlZGVudGlhbHNFcnJvciIsIDQwMCwgdm9pZCAwKTsKICB9Cn07CnZhciBBdXRoSW1wbGljaXRHcmFudFJlZGlyZWN0RXJyb3IgPSBjbGFzcyBleHRlbmRzIEN1c3RvbUF1dGhFcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSwgZGV0YWlscyA9IG51bGwpIHsKICAgIHN1cGVyKG1lc3NhZ2UsICJBdXRoSW1wbGljaXRHcmFudFJlZGlyZWN0RXJyb3IiLCA1MDAsIHZvaWQgMCk7CiAgICB0aGlzLmRldGFpbHMgPSBudWxsOwogICAgdGhpcy5kZXRhaWxzID0gZGV0YWlsczsKICB9CiAgdG9KU09OKCkgewogICAgcmV0dXJuIHsKICAgICAgbmFtZTogdGhpcy5uYW1lLAogICAgICBtZXNzYWdlOiB0aGlzLm1lc3NhZ2UsCiAgICAgIHN0YXR1czogdGhpcy5zdGF0dXMsCiAgICAgIGRldGFpbHM6IHRoaXMuZGV0YWlscwogICAgfTsKICB9Cn07CmZ1bmN0aW9uIGlzQXV0aEltcGxpY2l0R3JhbnRSZWRpcmVjdEVycm9yKGVycm9yKSB7CiAgcmV0dXJuIGlzQXV0aEVycm9yKGVycm9yKSAmJiBlcnJvci5uYW1lID09PSAiQXV0aEltcGxpY2l0R3JhbnRSZWRpcmVjdEVycm9yIjsKfQp2YXIgQXV0aFBLQ0VHcmFudENvZGVFeGNoYW5nZUVycm9yID0gY2xhc3MgZXh0ZW5kcyBDdXN0b21BdXRoRXJyb3IgewogIGNvbnN0cnVjdG9yKG1lc3NhZ2UsIGRldGFpbHMgPSBudWxsKSB7CiAgICBzdXBlcihtZXNzYWdlLCAiQXV0aFBLQ0VHcmFudENvZGVFeGNoYW5nZUVycm9yIiwgNTAwLCB2b2lkIDApOwogICAgdGhpcy5kZXRhaWxzID0gbnVsbDsKICAgIHRoaXMuZGV0YWlscyA9IGRldGFpbHM7CiAgfQogIHRvSlNPTigpIHsKICAgIHJldHVybiB7CiAgICAgIG5hbWU6IHRoaXMubmFtZSwKICAgICAgbWVzc2FnZTogdGhpcy5tZXNzYWdlLAogICAgICBzdGF0dXM6IHRoaXMuc3RhdHVzLAogICAgICBkZXRhaWxzOiB0aGlzLmRldGFpbHMKICAgIH07CiAgfQp9Owp2YXIgQXV0aFBLQ0VDb2RlVmVyaWZpZXJNaXNzaW5nRXJyb3IgPSBjbGFzcyBleHRlbmRzIEN1c3RvbUF1dGhFcnJvciB7CiAgY29uc3RydWN0b3IoKSB7CiAgICBzdXBlcigiUEtDRSBjb2RlIHZlcmlmaWVyIG5vdCBmb3VuZCBpbiBzdG9yYWdlLiBUaGlzIGNhbiBoYXBwZW4gaWYgdGhlIGF1dGggZmxvdyB3YXMgaW5pdGlhdGVkIGluIGEgZGlmZmVyZW50IGJyb3dzZXIgb3IgZGV2aWNlLCBvciBpZiB0aGUgc3RvcmFnZSB3YXMgY2xlYXJlZC4gRm9yIFNTUiBmcmFtZXdvcmtzIChOZXh0LmpzLCBTdmVsdGVLaXQsIGV0Yy4pLCB1c2UgQHN1cGFiYXNlL3NzciBvbiBib3RoIHRoZSBzZXJ2ZXIgYW5kIGNsaWVudCB0byBzdG9yZSB0aGUgY29kZSB2ZXJpZmllciBpbiBjb29raWVzLiIsICJBdXRoUEtDRUNvZGVWZXJpZmllck1pc3NpbmdFcnJvciIsIDQwMCwgInBrY2VfY29kZV92ZXJpZmllcl9ub3RfZm91bmQiKTsKICB9Cn07CnZhciBBdXRoUmV0cnlhYmxlRmV0Y2hFcnJvciA9IGNsYXNzIGV4dGVuZHMgQ3VzdG9tQXV0aEVycm9yIHsKICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBzdGF0dXMpIHsKICAgIHN1cGVyKG1lc3NhZ2UsICJBdXRoUmV0cnlhYmxlRmV0Y2hFcnJvciIsIHN0YXR1cywgdm9pZCAwKTsKICB9Cn07CmZ1bmN0aW9uIGlzQXV0aFJldHJ5YWJsZUZldGNoRXJyb3IoZXJyb3IpIHsKICByZXR1cm4gaXNBdXRoRXJyb3IoZXJyb3IpICYmIGVycm9yLm5hbWUgPT09ICJBdXRoUmV0cnlhYmxlRmV0Y2hFcnJvciI7Cn0KdmFyIEF1dGhXZWFrUGFzc3dvcmRFcnJvciA9IGNsYXNzIGV4dGVuZHMgQ3VzdG9tQXV0aEVycm9yIHsKICBjb25zdHJ1Y3RvcihtZXNzYWdlLCBzdGF0dXMsIHJlYXNvbnMpIHsKICAgIHN1cGVyKG1lc3NhZ2UsICJBdXRoV2Vha1Bhc3N3b3JkRXJyb3IiLCBzdGF0dXMsICJ3ZWFrX3Bhc3N3b3JkIik7CiAgICB0aGlzLnJlYXNvbnMgPSByZWFzb25zOwogIH0KfTsKdmFyIEF1dGhJbnZhbGlkSnd0RXJyb3IgPSBjbGFzcyBleHRlbmRzIEN1c3RvbUF1dGhFcnJvciB7CiAgY29uc3RydWN0b3IobWVzc2FnZSkgewogICAgc3VwZXIobWVzc2FnZSwgIkF1dGhJbnZhbGlkSnd0RXJyb3IiLCA0MDAsICJpbnZhbGlkX2p3dCIpOwogIH0KfTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrYXV0aC1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9hdXRoLWpzL2Rpc3QvbW9kdWxlL2xpYi9iYXNlNjR1cmwuanMKdmFyIFRPX0JBU0U2NFVSTCA9ICJBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWmFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6MDEyMzQ1Njc4OS1fIi5zcGxpdCgiIik7CnZhciBJR05PUkVfQkFTRTY0VVJMID0gIiAJXG5ccj0iLnNwbGl0KCIiKTsKdmFyIEZST01fQkFTRTY0VVJMID0gKCgpID0+IHsKICBjb25zdCBjaGFyTWFwID0gbmV3IEFycmF5KDEyOCk7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFyTWFwLmxlbmd0aDsgaSArPSAxKSB7CiAgICBjaGFyTWFwW2ldID0gLTE7CiAgfQogIGZvciAobGV0IGkgPSAwOyBpIDwgSUdOT1JFX0JBU0U2NFVSTC5sZW5ndGg7IGkgKz0gMSkgewogICAgY2hhck1hcFtJR05PUkVfQkFTRTY0VVJMW2ldLmNoYXJDb2RlQXQoMCldID0gLTI7CiAgfQogIGZvciAobGV0IGkgPSAwOyBpIDwgVE9fQkFTRTY0VVJMLmxlbmd0aDsgaSArPSAxKSB7CiAgICBjaGFyTWFwW1RPX0JBU0U2NFVSTFtpXS5jaGFyQ29kZUF0KDApXSA9IGk7CiAgfQogIHJldHVybiBjaGFyTWFwOwp9KSgpOwpmdW5jdGlvbiBieXRlVG9CYXNlNjRVUkwoYnl0ZSwgc3RhdGUsIGVtaXQpIHsKICBpZiAoYnl0ZSAhPT0gbnVsbCkgewogICAgc3RhdGUucXVldWUgPSBzdGF0ZS5xdWV1ZSA8PCA4IHwgYnl0ZTsKICAgIHN0YXRlLnF1ZXVlZEJpdHMgKz0gODsKICAgIHdoaWxlIChzdGF0ZS5xdWV1ZWRCaXRzID49IDYpIHsKICAgICAgY29uc3QgcG9zID0gc3RhdGUucXVldWUgPj4gc3RhdGUucXVldWVkQml0cyAtIDYgJiA2MzsKICAgICAgZW1pdChUT19CQVNFNjRVUkxbcG9zXSk7CiAgICAgIHN0YXRlLnF1ZXVlZEJpdHMgLT0gNjsKICAgIH0KICB9IGVsc2UgaWYgKHN0YXRlLnF1ZXVlZEJpdHMgPiAwKSB7CiAgICBzdGF0ZS5xdWV1ZSA9IHN0YXRlLnF1ZXVlIDw8IDYgLSBzdGF0ZS5xdWV1ZWRCaXRzOwogICAgc3RhdGUucXVldWVkQml0cyA9IDY7CiAgICB3aGlsZSAoc3RhdGUucXVldWVkQml0cyA+PSA2KSB7CiAgICAgIGNvbnN0IHBvcyA9IHN0YXRlLnF1ZXVlID4+IHN0YXRlLnF1ZXVlZEJpdHMgLSA2ICYgNjM7CiAgICAgIGVtaXQoVE9fQkFTRTY0VVJMW3Bvc10pOwogICAgICBzdGF0ZS5xdWV1ZWRCaXRzIC09IDY7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGJ5dGVGcm9tQmFzZTY0VVJMKGNoYXJDb2RlLCBzdGF0ZSwgZW1pdCkgewogIGNvbnN0IGJpdHMgPSBGUk9NX0JBU0U2NFVSTFtjaGFyQ29kZV07CiAgaWYgKGJpdHMgPiAtMSkgewogICAgc3RhdGUucXVldWUgPSBzdGF0ZS5xdWV1ZSA8PCA2IHwgYml0czsKICAgIHN0YXRlLnF1ZXVlZEJpdHMgKz0gNjsKICAgIHdoaWxlIChzdGF0ZS5xdWV1ZWRCaXRzID49IDgpIHsKICAgICAgZW1pdChzdGF0ZS5xdWV1ZSA+PiBzdGF0ZS5xdWV1ZWRCaXRzIC0gOCAmIDI1NSk7CiAgICAgIHN0YXRlLnF1ZXVlZEJpdHMgLT0gODsKICAgIH0KICB9IGVsc2UgaWYgKGJpdHMgPT09IC0yKSB7CiAgICByZXR1cm47CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBCYXNlNjQtVVJMIGNoYXJhY3RlciAiJHtTdHJpbmcuZnJvbUNoYXJDb2RlKGNoYXJDb2RlKX0iYCk7CiAgfQp9CmZ1bmN0aW9uIHN0cmluZ0Zyb21CYXNlNjRVUkwoc3RyKSB7CiAgY29uc3QgY29udiA9IFtdOwogIGNvbnN0IHV0ZjhFbWl0ID0gKGNvZGVwb2ludCkgPT4gewogICAgY29udi5wdXNoKFN0cmluZy5mcm9tQ29kZVBvaW50KGNvZGVwb2ludCkpOwogIH07CiAgY29uc3QgdXRmOFN0YXRlID0gewogICAgdXRmOHNlcTogMCwKICAgIGNvZGVwb2ludDogMAogIH07CiAgY29uc3QgYjY0U3RhdGUgPSB7IHF1ZXVlOiAwLCBxdWV1ZWRCaXRzOiAwIH07CiAgY29uc3QgYnl0ZUVtaXQgPSAoYnl0ZSkgPT4gewogICAgc3RyaW5nRnJvbVVURjgoYnl0ZSwgdXRmOFN0YXRlLCB1dGY4RW1pdCk7CiAgfTsKICBmb3IgKGxldCBpID0gMDsgaSA8IHN0ci5sZW5ndGg7IGkgKz0gMSkgewogICAgYnl0ZUZyb21CYXNlNjRVUkwoc3RyLmNoYXJDb2RlQXQoaSksIGI2NFN0YXRlLCBieXRlRW1pdCk7CiAgfQogIHJldHVybiBjb252LmpvaW4oIiIpOwp9CmZ1bmN0aW9uIGNvZGVwb2ludFRvVVRGOChjb2RlcG9pbnQsIGVtaXQpIHsKICBpZiAoY29kZXBvaW50IDw9IDEyNykgewogICAgZW1pdChjb2RlcG9pbnQpOwogICAgcmV0dXJuOwogIH0gZWxzZSBpZiAoY29kZXBvaW50IDw9IDIwNDcpIHsKICAgIGVtaXQoMTkyIHwgY29kZXBvaW50ID4+IDYpOwogICAgZW1pdCgxMjggfCBjb2RlcG9pbnQgJiA2Myk7CiAgICByZXR1cm47CiAgfSBlbHNlIGlmIChjb2RlcG9pbnQgPD0gNjU1MzUpIHsKICAgIGVtaXQoMjI0IHwgY29kZXBvaW50ID4+IDEyKTsKICAgIGVtaXQoMTI4IHwgY29kZXBvaW50ID4+IDYgJiA2Myk7CiAgICBlbWl0KDEyOCB8IGNvZGVwb2ludCAmIDYzKTsKICAgIHJldHVybjsKICB9IGVsc2UgaWYgKGNvZGVwb2ludCA8PSAxMTE0MTExKSB7CiAgICBlbWl0KDI0MCB8IGNvZGVwb2ludCA+PiAxOCk7CiAgICBlbWl0KDEyOCB8IGNvZGVwb2ludCA+PiAxMiAmIDYzKTsKICAgIGVtaXQoMTI4IHwgY29kZXBvaW50ID4+IDYgJiA2Myk7CiAgICBlbWl0KDEyOCB8IGNvZGVwb2ludCAmIDYzKTsKICAgIHJldHVybjsKICB9CiAgdGhyb3cgbmV3IEVycm9yKGBVbnJlY29nbml6ZWQgVW5pY29kZSBjb2RlcG9pbnQ6ICR7Y29kZXBvaW50LnRvU3RyaW5nKDE2KX1gKTsKfQpmdW5jdGlvbiBzdHJpbmdUb1VURjgoc3RyLCBlbWl0KSB7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyBpICs9IDEpIHsKICAgIGxldCBjb2RlcG9pbnQgPSBzdHIuY2hhckNvZGVBdChpKTsKICAgIGlmIChjb2RlcG9pbnQgPiA1NTI5NSAmJiBjb2RlcG9pbnQgPD0gNTYzMTkpIHsKICAgICAgY29uc3QgaGlnaFN1cnJvZ2F0ZSA9IChjb2RlcG9pbnQgLSA1NTI5NikgKiAxMDI0ICYgNjU1MzU7CiAgICAgIGNvbnN0IGxvd1N1cnJvZ2F0ZSA9IHN0ci5jaGFyQ29kZUF0KGkgKyAxKSAtIDU2MzIwICYgNjU1MzU7CiAgICAgIGNvZGVwb2ludCA9IChsb3dTdXJyb2dhdGUgfCBoaWdoU3Vycm9nYXRlKSArIDY1NTM2OwogICAgICBpICs9IDE7CiAgICB9CiAgICBjb2RlcG9pbnRUb1VURjgoY29kZXBvaW50LCBlbWl0KTsKICB9Cn0KZnVuY3Rpb24gc3RyaW5nRnJvbVVURjgoYnl0ZSwgc3RhdGUsIGVtaXQpIHsKICBpZiAoc3RhdGUudXRmOHNlcSA9PT0gMCkgewogICAgaWYgKGJ5dGUgPD0gMTI3KSB7CiAgICAgIGVtaXQoYnl0ZSk7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGZvciAobGV0IGxlYWRpbmdCaXQgPSAxOyBsZWFkaW5nQml0IDwgNjsgbGVhZGluZ0JpdCArPSAxKSB7CiAgICAgIGlmICgoYnl0ZSA+PiA3IC0gbGVhZGluZ0JpdCAmIDEpID09PSAwKSB7CiAgICAgICAgc3RhdGUudXRmOHNlcSA9IGxlYWRpbmdCaXQ7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIGlmIChzdGF0ZS51dGY4c2VxID09PSAyKSB7CiAgICAgIHN0YXRlLmNvZGVwb2ludCA9IGJ5dGUgJiAzMTsKICAgIH0gZWxzZSBpZiAoc3RhdGUudXRmOHNlcSA9PT0gMykgewogICAgICBzdGF0ZS5jb2RlcG9pbnQgPSBieXRlICYgMTU7CiAgICB9IGVsc2UgaWYgKHN0YXRlLnV0ZjhzZXEgPT09IDQpIHsKICAgICAgc3RhdGUuY29kZXBvaW50ID0gYnl0ZSAmIDc7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgVVRGLTggc2VxdWVuY2UiKTsKICAgIH0KICAgIHN0YXRlLnV0ZjhzZXEgLT0gMTsKICB9IGVsc2UgaWYgKHN0YXRlLnV0ZjhzZXEgPiAwKSB7CiAgICBpZiAoYnl0ZSA8PSAxMjcpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIFVURi04IHNlcXVlbmNlIik7CiAgICB9CiAgICBzdGF0ZS5jb2RlcG9pbnQgPSBzdGF0ZS5jb2RlcG9pbnQgPDwgNiB8IGJ5dGUgJiA2MzsKICAgIHN0YXRlLnV0ZjhzZXEgLT0gMTsKICAgIGlmIChzdGF0ZS51dGY4c2VxID09PSAwKSB7CiAgICAgIGVtaXQoc3RhdGUuY29kZXBvaW50KTsKICAgIH0KICB9Cn0KZnVuY3Rpb24gYmFzZTY0VXJsVG9VaW50OEFycmF5KHN0cikgewogIGNvbnN0IHJlc3VsdCA9IFtdOwogIGNvbnN0IHN0YXRlID0geyBxdWV1ZTogMCwgcXVldWVkQml0czogMCB9OwogIGNvbnN0IG9uQnl0ZSA9IChieXRlKSA9PiB7CiAgICByZXN1bHQucHVzaChieXRlKTsKICB9OwogIGZvciAobGV0IGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgaSArPSAxKSB7CiAgICBieXRlRnJvbUJhc2U2NFVSTChzdHIuY2hhckNvZGVBdChpKSwgc3RhdGUsIG9uQnl0ZSk7CiAgfQogIHJldHVybiBuZXcgVWludDhBcnJheShyZXN1bHQpOwp9CmZ1bmN0aW9uIHN0cmluZ1RvVWludDhBcnJheShzdHIpIHsKICBjb25zdCByZXN1bHQgPSBbXTsKICBzdHJpbmdUb1VURjgoc3RyLCAoYnl0ZSkgPT4gcmVzdWx0LnB1c2goYnl0ZSkpOwogIHJldHVybiBuZXcgVWludDhBcnJheShyZXN1bHQpOwp9CmZ1bmN0aW9uIGJ5dGVzVG9CYXNlNjRVUkwoYnl0ZXMpIHsKICBjb25zdCByZXN1bHQgPSBbXTsKICBjb25zdCBzdGF0ZSA9IHsgcXVldWU6IDAsIHF1ZXVlZEJpdHM6IDAgfTsKICBjb25zdCBvbkNoYXIgPSAoY2hhcikgPT4gewogICAgcmVzdWx0LnB1c2goY2hhcik7CiAgfTsKICBieXRlcy5mb3JFYWNoKChieXRlKSA9PiBieXRlVG9CYXNlNjRVUkwoYnl0ZSwgc3RhdGUsIG9uQ2hhcikpOwogIGJ5dGVUb0Jhc2U2NFVSTChudWxsLCBzdGF0ZSwgb25DaGFyKTsKICByZXR1cm4gcmVzdWx0LmpvaW4oIiIpOwp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK2F1dGgtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvYXV0aC1qcy9kaXN0L21vZHVsZS9saWIvaGVscGVycy5qcwpmdW5jdGlvbiBleHBpcmVzQXQoZXhwaXJlc0luKSB7CiAgY29uc3QgdGltZU5vdyA9IE1hdGgucm91bmQoRGF0ZS5ub3coKSAvIDFlMyk7CiAgcmV0dXJuIHRpbWVOb3cgKyBleHBpcmVzSW47Cn0KZnVuY3Rpb24gZ2VuZXJhdGVDYWxsYmFja0lkKCkgewogIHJldHVybiBTeW1ib2woImF1dGgtY2FsbGJhY2siKTsKfQp2YXIgaXNCcm93c2VyID0gKCkgPT4gdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIjsKdmFyIGxvY2FsU3RvcmFnZVdyaXRlVGVzdHMgPSB7CiAgdGVzdGVkOiBmYWxzZSwKICB3cml0YWJsZTogZmFsc2UKfTsKdmFyIHN1cHBvcnRzTG9jYWxTdG9yYWdlID0gKCkgPT4gewogIGlmICghaXNCcm93c2VyKCkpIHsKICAgIHJldHVybiBmYWxzZTsKICB9CiAgdHJ5IHsKICAgIGlmICh0eXBlb2YgZ2xvYmFsVGhpcy5sb2NhbFN0b3JhZ2UgIT09ICJvYmplY3QiKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9IGNhdGNoIChlKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQogIGlmIChsb2NhbFN0b3JhZ2VXcml0ZVRlc3RzLnRlc3RlZCkgewogICAgcmV0dXJuIGxvY2FsU3RvcmFnZVdyaXRlVGVzdHMud3JpdGFibGU7CiAgfQogIGNvbnN0IHJhbmRvbUtleSA9IGBsc3d0LSR7TWF0aC5yYW5kb20oKX0ke01hdGgucmFuZG9tKCl9YDsKICB0cnkgewogICAgZ2xvYmFsVGhpcy5sb2NhbFN0b3JhZ2Uuc2V0SXRlbShyYW5kb21LZXksIHJhbmRvbUtleSk7CiAgICBnbG9iYWxUaGlzLmxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKHJhbmRvbUtleSk7CiAgICBsb2NhbFN0b3JhZ2VXcml0ZVRlc3RzLnRlc3RlZCA9IHRydWU7CiAgICBsb2NhbFN0b3JhZ2VXcml0ZVRlc3RzLndyaXRhYmxlID0gdHJ1ZTsKICB9IGNhdGNoIChlKSB7CiAgICBsb2NhbFN0b3JhZ2VXcml0ZVRlc3RzLnRlc3RlZCA9IHRydWU7CiAgICBsb2NhbFN0b3JhZ2VXcml0ZVRlc3RzLndyaXRhYmxlID0gZmFsc2U7CiAgfQogIHJldHVybiBsb2NhbFN0b3JhZ2VXcml0ZVRlc3RzLndyaXRhYmxlOwp9OwpmdW5jdGlvbiBwYXJzZVBhcmFtZXRlcnNGcm9tVVJMKGhyZWYpIHsKICBjb25zdCByZXN1bHQgPSB7fTsKICBjb25zdCB1cmwgPSBuZXcgVVJMKGhyZWYpOwogIGlmICh1cmwuaGFzaCAmJiB1cmwuaGFzaFswXSA9PT0gIiMiKSB7CiAgICB0cnkgewogICAgICBjb25zdCBoYXNoU2VhcmNoUGFyYW1zID0gbmV3IFVSTFNlYXJjaFBhcmFtcyh1cmwuaGFzaC5zdWJzdHJpbmcoMSkpOwogICAgICBoYXNoU2VhcmNoUGFyYW1zLmZvckVhY2goKHZhbHVlLCBrZXkpID0+IHsKICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgIH0KICB9CiAgdXJsLnNlYXJjaFBhcmFtcy5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiB7CiAgICByZXN1bHRba2V5XSA9IHZhbHVlOwogIH0pOwogIHJldHVybiByZXN1bHQ7Cn0KdmFyIHJlc29sdmVGZXRjaDMgPSAoY3VzdG9tRmV0Y2gpID0+IHsKICBpZiAoY3VzdG9tRmV0Y2gpIHsKICAgIHJldHVybiAoLi4uYXJncykgPT4gY3VzdG9tRmV0Y2goLi4uYXJncyk7CiAgfQogIHJldHVybiAoLi4uYXJncykgPT4gZmV0Y2goLi4uYXJncyk7Cn07CnZhciBsb29rc0xpa2VGZXRjaFJlc3BvbnNlID0gKG1heWJlUmVzcG9uc2UpID0+IHsKICByZXR1cm4gdHlwZW9mIG1heWJlUmVzcG9uc2UgPT09ICJvYmplY3QiICYmIG1heWJlUmVzcG9uc2UgIT09IG51bGwgJiYgInN0YXR1cyIgaW4gbWF5YmVSZXNwb25zZSAmJiAib2siIGluIG1heWJlUmVzcG9uc2UgJiYgImpzb24iIGluIG1heWJlUmVzcG9uc2UgJiYgdHlwZW9mIG1heWJlUmVzcG9uc2UuanNvbiA9PT0gImZ1bmN0aW9uIjsKfTsKdmFyIHNldEl0ZW1Bc3luYyA9IGFzeW5jIChzdG9yYWdlLCBrZXksIGRhdGEpID0+IHsKICBhd2FpdCBzdG9yYWdlLnNldEl0ZW0oa2V5LCBKU09OLnN0cmluZ2lmeShkYXRhKSk7Cn07CnZhciBnZXRJdGVtQXN5bmMgPSBhc3luYyAoc3RvcmFnZSwga2V5KSA9PiB7CiAgY29uc3QgdmFsdWUgPSBhd2FpdCBzdG9yYWdlLmdldEl0ZW0oa2V5KTsKICBpZiAoIXZhbHVlKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdHJ5IHsKICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKICB9IGNhdGNoIChfYSkgewogICAgcmV0dXJuIHZhbHVlOwogIH0KfTsKdmFyIHJlbW92ZUl0ZW1Bc3luYyA9IGFzeW5jIChzdG9yYWdlLCBrZXkpID0+IHsKICBhd2FpdCBzdG9yYWdlLnJlbW92ZUl0ZW0oa2V5KTsKfTsKdmFyIERlZmVycmVkID0gY2xhc3MgX0RlZmVycmVkIHsKICBjb25zdHJ1Y3RvcigpIHsKICAgIDsKICAgIHRoaXMucHJvbWlzZSA9IG5ldyBfRGVmZXJyZWQucHJvbWlzZUNvbnN0cnVjdG9yKChyZXMsIHJlaikgPT4gewogICAgICA7CiAgICAgIHRoaXMucmVzb2x2ZSA9IHJlczsKICAgICAgdGhpcy5yZWplY3QgPSByZWo7CiAgICB9KTsKICB9Cn07CkRlZmVycmVkLnByb21pc2VDb25zdHJ1Y3RvciA9IFByb21pc2U7CmZ1bmN0aW9uIGRlY29kZUpXVCh0b2tlbikgewogIGNvbnN0IHBhcnRzID0gdG9rZW4uc3BsaXQoIi4iKTsKICBpZiAocGFydHMubGVuZ3RoICE9PSAzKSB7CiAgICB0aHJvdyBuZXcgQXV0aEludmFsaWRKd3RFcnJvcigiSW52YWxpZCBKV1Qgc3RydWN0dXJlIik7CiAgfQogIGZvciAobGV0IGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHsKICAgIGlmICghQkFTRTY0VVJMX1JFR0VYLnRlc3QocGFydHNbaV0pKSB7CiAgICAgIHRocm93IG5ldyBBdXRoSW52YWxpZEp3dEVycm9yKCJKV1Qgbm90IGluIGJhc2U2NHVybCBmb3JtYXQiKTsKICAgIH0KICB9CiAgY29uc3QgZGF0YSA9IHsKICAgIC8vIHVzaW5nIGJhc2U2NHVybCBsaWIKICAgIGhlYWRlcjogSlNPTi5wYXJzZShzdHJpbmdGcm9tQmFzZTY0VVJMKHBhcnRzWzBdKSksCiAgICBwYXlsb2FkOiBKU09OLnBhcnNlKHN0cmluZ0Zyb21CYXNlNjRVUkwocGFydHNbMV0pKSwKICAgIHNpZ25hdHVyZTogYmFzZTY0VXJsVG9VaW50OEFycmF5KHBhcnRzWzJdKSwKICAgIHJhdzogewogICAgICBoZWFkZXI6IHBhcnRzWzBdLAogICAgICBwYXlsb2FkOiBwYXJ0c1sxXQogICAgfQogIH07CiAgcmV0dXJuIGRhdGE7Cn0KYXN5bmMgZnVuY3Rpb24gc2xlZXAodGltZTIpIHsKICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKGFjY2VwdCkgPT4gewogICAgc2V0VGltZW91dCgoKSA9PiBhY2NlcHQobnVsbCksIHRpbWUyKTsKICB9KTsKfQpmdW5jdGlvbiByZXRyeWFibGUoZm4sIGlzUmV0cnlhYmxlKSB7CiAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChhY2NlcHQsIHJlamVjdCkgPT4gewogICAgOwogICAgKGFzeW5jICgpID0+IHsKICAgICAgZm9yIChsZXQgYXR0ZW1wdCA9IDA7IGF0dGVtcHQgPCBJbmZpbml0eTsgYXR0ZW1wdCsrKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGZuKGF0dGVtcHQpOwogICAgICAgICAgaWYgKCFpc1JldHJ5YWJsZShhdHRlbXB0LCBudWxsLCByZXN1bHQpKSB7CiAgICAgICAgICAgIGFjY2VwdChyZXN1bHQpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgaWYgKCFpc1JldHJ5YWJsZShhdHRlbXB0LCBlKSkgewogICAgICAgICAgICByZWplY3QoZSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0pKCk7CiAgfSk7CiAgcmV0dXJuIHByb21pc2U7Cn0KZnVuY3Rpb24gZGVjMmhleChkZWMpIHsKICByZXR1cm4gKCIwIiArIGRlYy50b1N0cmluZygxNikpLnN1YnN0cigtMik7Cn0KZnVuY3Rpb24gZ2VuZXJhdGVQS0NFVmVyaWZpZXIoKSB7CiAgY29uc3QgdmVyaWZpZXJMZW5ndGggPSA1NjsKICBjb25zdCBhcnJheSA9IG5ldyBVaW50MzJBcnJheSh2ZXJpZmllckxlbmd0aCk7CiAgaWYgKHR5cGVvZiBjcnlwdG8gPT09ICJ1bmRlZmluZWQiKSB7CiAgICBjb25zdCBjaGFyU2V0ID0gIkFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5LS5ffiI7CiAgICBjb25zdCBjaGFyU2V0TGVuID0gY2hhclNldC5sZW5ndGg7CiAgICBsZXQgdmVyaWZpZXIgPSAiIjsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVyaWZpZXJMZW5ndGg7IGkrKykgewogICAgICB2ZXJpZmllciArPSBjaGFyU2V0LmNoYXJBdChNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBjaGFyU2V0TGVuKSk7CiAgICB9CiAgICByZXR1cm4gdmVyaWZpZXI7CiAgfQogIGNyeXB0by5nZXRSYW5kb21WYWx1ZXMoYXJyYXkpOwogIHJldHVybiBBcnJheS5mcm9tKGFycmF5LCBkZWMyaGV4KS5qb2luKCIiKTsKfQphc3luYyBmdW5jdGlvbiBzaGEyNTYocmFuZG9tU3RyaW5nMikgewogIGNvbnN0IGVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTsKICBjb25zdCBlbmNvZGVkRGF0YSA9IGVuY29kZXIuZW5jb2RlKHJhbmRvbVN0cmluZzIpOwogIGNvbnN0IGhhc2ggPSBhd2FpdCBjcnlwdG8uc3VidGxlLmRpZ2VzdCgiU0hBLTI1NiIsIGVuY29kZWREYXRhKTsKICBjb25zdCBieXRlcyA9IG5ldyBVaW50OEFycmF5KGhhc2gpOwogIHJldHVybiBBcnJheS5mcm9tKGJ5dGVzKS5tYXAoKGMpID0+IFN0cmluZy5mcm9tQ2hhckNvZGUoYykpLmpvaW4oIiIpOwp9CmFzeW5jIGZ1bmN0aW9uIGdlbmVyYXRlUEtDRUNoYWxsZW5nZSh2ZXJpZmllcikgewogIGNvbnN0IGhhc0NyeXB0b1N1cHBvcnQgPSB0eXBlb2YgY3J5cHRvICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YgY3J5cHRvLnN1YnRsZSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIFRleHRFbmNvZGVyICE9PSAidW5kZWZpbmVkIjsKICBpZiAoIWhhc0NyeXB0b1N1cHBvcnQpIHsKICAgIGNvbnNvbGUud2FybigiV2ViQ3J5cHRvIEFQSSBpcyBub3Qgc3VwcG9ydGVkLiBDb2RlIGNoYWxsZW5nZSBtZXRob2Qgd2lsbCBkZWZhdWx0IHRvIHVzZSBwbGFpbiBpbnN0ZWFkIG9mIHNoYTI1Ni4iKTsKICAgIHJldHVybiB2ZXJpZmllcjsKICB9CiAgY29uc3QgaGFzaGVkID0gYXdhaXQgc2hhMjU2KHZlcmlmaWVyKTsKICByZXR1cm4gYnRvYShoYXNoZWQpLnJlcGxhY2UoL1wrL2csICItIikucmVwbGFjZSgvXC8vZywgIl8iKS5yZXBsYWNlKC89KyQvLCAiIik7Cn0KYXN5bmMgZnVuY3Rpb24gZ2V0Q29kZUNoYWxsZW5nZUFuZE1ldGhvZChzdG9yYWdlLCBzdG9yYWdlS2V5LCBpc1Bhc3N3b3JkUmVjb3ZlcnkgPSBmYWxzZSkgewogIGNvbnN0IGNvZGVWZXJpZmllciA9IGdlbmVyYXRlUEtDRVZlcmlmaWVyKCk7CiAgbGV0IHN0b3JlZENvZGVWZXJpZmllciA9IGNvZGVWZXJpZmllcjsKICBpZiAoaXNQYXNzd29yZFJlY292ZXJ5KSB7CiAgICBzdG9yZWRDb2RlVmVyaWZpZXIgKz0gIi9QQVNTV09SRF9SRUNPVkVSWSI7CiAgfQogIGF3YWl0IHNldEl0ZW1Bc3luYyhzdG9yYWdlLCBgJHtzdG9yYWdlS2V5fS1jb2RlLXZlcmlmaWVyYCwgc3RvcmVkQ29kZVZlcmlmaWVyKTsKICBjb25zdCBjb2RlQ2hhbGxlbmdlID0gYXdhaXQgZ2VuZXJhdGVQS0NFQ2hhbGxlbmdlKGNvZGVWZXJpZmllcik7CiAgY29uc3QgY29kZUNoYWxsZW5nZU1ldGhvZCA9IGNvZGVWZXJpZmllciA9PT0gY29kZUNoYWxsZW5nZSA/ICJwbGFpbiIgOiAiczI1NiI7CiAgcmV0dXJuIFtjb2RlQ2hhbGxlbmdlLCBjb2RlQ2hhbGxlbmdlTWV0aG9kXTsKfQp2YXIgQVBJX1ZFUlNJT05fUkVHRVggPSAvXjJbMC05XXszfS0oMFsxLTldfDFbMC0yXSktKDBbMS05XXwxWzAtOV18MlswLTldfDNbMC0xXSkkL2k7CmZ1bmN0aW9uIHBhcnNlUmVzcG9uc2VBUElWZXJzaW9uKHJlc3BvbnNlKSB7CiAgY29uc3QgYXBpVmVyc2lvbiA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KEFQSV9WRVJTSU9OX0hFQURFUl9OQU1FKTsKICBpZiAoIWFwaVZlcnNpb24pIHsKICAgIHJldHVybiBudWxsOwogIH0KICBpZiAoIWFwaVZlcnNpb24ubWF0Y2goQVBJX1ZFUlNJT05fUkVHRVgpKSB7CiAgICByZXR1cm4gbnVsbDsKICB9CiAgdHJ5IHsKICAgIGNvbnN0IGRhdGUyID0gLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKGAke2FwaVZlcnNpb259VDAwOjAwOjAwLjBaYCk7CiAgICByZXR1cm4gZGF0ZTI7CiAgfSBjYXRjaCAoZSkgewogICAgcmV0dXJuIG51bGw7CiAgfQp9CmZ1bmN0aW9uIHZhbGlkYXRlRXhwKGV4cCkgewogIGlmICghZXhwKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIk1pc3NpbmcgZXhwIGNsYWltIik7CiAgfQogIGNvbnN0IHRpbWVOb3cgPSBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxZTMpOwogIGlmIChleHAgPD0gdGltZU5vdykgewogICAgdGhyb3cgbmV3IEVycm9yKCJKV1QgaGFzIGV4cGlyZWQiKTsKICB9Cn0KZnVuY3Rpb24gZ2V0QWxnb3JpdGhtKGFsZykgewogIHN3aXRjaCAoYWxnKSB7CiAgICBjYXNlICJSUzI1NiI6CiAgICAgIHJldHVybiB7CiAgICAgICAgbmFtZTogIlJTQVNTQS1QS0NTMS12MV81IiwKICAgICAgICBoYXNoOiB7IG5hbWU6ICJTSEEtMjU2IiB9CiAgICAgIH07CiAgICBjYXNlICJFUzI1NiI6CiAgICAgIHJldHVybiB7CiAgICAgICAgbmFtZTogIkVDRFNBIiwKICAgICAgICBuYW1lZEN1cnZlOiAiUC0yNTYiLAogICAgICAgIGhhc2g6IHsgbmFtZTogIlNIQS0yNTYiIH0KICAgICAgfTsKICAgIGRlZmF1bHQ6CiAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBhbGcgY2xhaW0iKTsKICB9Cn0KdmFyIFVVSURfUkVHRVggPSAvXlswLTlhLWZdezh9LVswLTlhLWZdezR9LVswLTlhLWZdezR9LVswLTlhLWZdezR9LVswLTlhLWZdezEyfSQvOwpmdW5jdGlvbiB2YWxpZGF0ZVVVSUQoc3RyKSB7CiAgaWYgKCFVVUlEX1JFR0VYLnRlc3Qoc3RyKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJAc3VwYWJhc2UvYXV0aC1qczogRXhwZWN0ZWQgcGFyYW1ldGVyIHRvIGJlIFVVSUQgYnV0IGlzIG5vdCIpOwogIH0KfQpmdW5jdGlvbiB1c2VyTm90QXZhaWxhYmxlUHJveHkoKSB7CiAgY29uc3QgcHJveHlUYXJnZXQgPSB7fTsKICByZXR1cm4gbmV3IFByb3h5KHByb3h5VGFyZ2V0LCB7CiAgICBnZXQ6ICh0YXJnZXQsIHByb3ApID0+IHsKICAgICAgaWYgKHByb3AgPT09ICJfX2lzVXNlck5vdEF2YWlsYWJsZVByb3h5IikgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgcHJvcCA9PT0gInN5bWJvbCIpIHsKICAgICAgICBjb25zdCBzUHJvcCA9IHByb3AudG9TdHJpbmcoKTsKICAgICAgICBpZiAoc1Byb3AgPT09ICJTeW1ib2woU3ltYm9sLnRvUHJpbWl0aXZlKSIgfHwgc1Byb3AgPT09ICJTeW1ib2woU3ltYm9sLnRvU3RyaW5nVGFnKSIgfHwgc1Byb3AgPT09ICJTeW1ib2wodXRpbC5pbnNwZWN0LmN1c3RvbSkiKSB7CiAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgIH0KICAgICAgfQogICAgICB0aHJvdyBuZXcgRXJyb3IoYEBzdXBhYmFzZS9hdXRoLWpzOiBjbGllbnQgd2FzIGNyZWF0ZWQgd2l0aCB1c2VyU3RvcmFnZSBvcHRpb24gYW5kIHRoZXJlIHdhcyBubyB1c2VyIHN0b3JlZCBpbiB0aGUgdXNlciBzdG9yYWdlLiBBY2Nlc3NpbmcgdGhlICIke3Byb3B9IiBwcm9wZXJ0eSBvZiB0aGUgc2Vzc2lvbiBvYmplY3QgaXMgbm90IHN1cHBvcnRlZC4gUGxlYXNlIHVzZSBnZXRVc2VyKCkgaW5zdGVhZC5gKTsKICAgIH0sCiAgICBzZXQ6IChfdGFyZ2V0LCBwcm9wKSA9PiB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgQHN1cGFiYXNlL2F1dGgtanM6IGNsaWVudCB3YXMgY3JlYXRlZCB3aXRoIHVzZXJTdG9yYWdlIG9wdGlvbiBhbmQgdGhlcmUgd2FzIG5vIHVzZXIgc3RvcmVkIGluIHRoZSB1c2VyIHN0b3JhZ2UuIFNldHRpbmcgdGhlICIke3Byb3B9IiBwcm9wZXJ0eSBvZiB0aGUgc2Vzc2lvbiBvYmplY3QgaXMgbm90IHN1cHBvcnRlZC4gUGxlYXNlIHVzZSBnZXRVc2VyKCkgdG8gZmV0Y2ggYSB1c2VyIG9iamVjdCB5b3UgY2FuIG1hbmlwdWxhdGUuYCk7CiAgICB9LAogICAgZGVsZXRlUHJvcGVydHk6IChfdGFyZ2V0LCBwcm9wKSA9PiB7CiAgICAgIHRocm93IG5ldyBFcnJvcihgQHN1cGFiYXNlL2F1dGgtanM6IGNsaWVudCB3YXMgY3JlYXRlZCB3aXRoIHVzZXJTdG9yYWdlIG9wdGlvbiBhbmQgdGhlcmUgd2FzIG5vIHVzZXIgc3RvcmVkIGluIHRoZSB1c2VyIHN0b3JhZ2UuIERlbGV0aW5nIHRoZSAiJHtwcm9wfSIgcHJvcGVydHkgb2YgdGhlIHNlc3Npb24gb2JqZWN0IGlzIG5vdCBzdXBwb3J0ZWQuIFBsZWFzZSB1c2UgZ2V0VXNlcigpIHRvIGZldGNoIGEgdXNlciBvYmplY3QgeW91IGNhbiBtYW5pcHVsYXRlLmApOwogICAgfQogIH0pOwp9CmZ1bmN0aW9uIGluc2VjdXJlVXNlcldhcm5pbmdQcm94eSh1c2VyLCBzdXBwcmVzc1dhcm5pbmdSZWYpIHsKICByZXR1cm4gbmV3IFByb3h5KHVzZXIsIHsKICAgIGdldDogKHRhcmdldCwgcHJvcCwgcmVjZWl2ZXIpID0+IHsKICAgICAgaWYgKHByb3AgPT09ICJfX2lzSW5zZWN1cmVVc2VyV2FybmluZ1Byb3h5IikgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGlmICh0eXBlb2YgcHJvcCA9PT0gInN5bWJvbCIpIHsKICAgICAgICBjb25zdCBzUHJvcCA9IHByb3AudG9TdHJpbmcoKTsKICAgICAgICBpZiAoc1Byb3AgPT09ICJTeW1ib2woU3ltYm9sLnRvUHJpbWl0aXZlKSIgfHwgc1Byb3AgPT09ICJTeW1ib2woU3ltYm9sLnRvU3RyaW5nVGFnKSIgfHwgc1Byb3AgPT09ICJTeW1ib2wodXRpbC5pbnNwZWN0LmN1c3RvbSkiIHx8IHNQcm9wID09PSAiU3ltYm9sKG5vZGVqcy51dGlsLmluc3BlY3QuY3VzdG9tKSIpIHsKICAgICAgICAgIHJldHVybiBSZWZsZWN0LmdldCh0YXJnZXQsIHByb3AsIHJlY2VpdmVyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFzdXBwcmVzc1dhcm5pbmdSZWYudmFsdWUgJiYgdHlwZW9mIHByb3AgPT09ICJzdHJpbmciKSB7CiAgICAgICAgY29uc29sZS53YXJuKCJVc2luZyB0aGUgdXNlciBvYmplY3QgYXMgcmV0dXJuZWQgZnJvbSBzdXBhYmFzZS5hdXRoLmdldFNlc3Npb24oKSBvciBmcm9tIHNvbWUgc3VwYWJhc2UuYXV0aC5vbkF1dGhTdGF0ZUNoYW5nZSgpIGV2ZW50cyBjb3VsZCBiZSBpbnNlY3VyZSEgVGhpcyB2YWx1ZSBjb21lcyBkaXJlY3RseSBmcm9tIHRoZSBzdG9yYWdlIG1lZGl1bSAodXN1YWxseSBjb29raWVzIG9uIHRoZSBzZXJ2ZXIpIGFuZCBtYXkgbm90IGJlIGF1dGhlbnRpYy4gVXNlIHN1cGFiYXNlLmF1dGguZ2V0VXNlcigpIGluc3RlYWQgd2hpY2ggYXV0aGVudGljYXRlcyB0aGUgZGF0YSBieSBjb250YWN0aW5nIHRoZSBTdXBhYmFzZSBBdXRoIHNlcnZlci4iKTsKICAgICAgICBzdXBwcmVzc1dhcm5pbmdSZWYudmFsdWUgPSB0cnVlOwogICAgICB9CiAgICAgIHJldHVybiBSZWZsZWN0LmdldCh0YXJnZXQsIHByb3AsIHJlY2VpdmVyKTsKICAgIH0KICB9KTsKfQpmdW5jdGlvbiBkZWVwQ2xvbmUob2JqKSB7CiAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrYXV0aC1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9hdXRoLWpzL2Rpc3QvbW9kdWxlL2xpYi9mZXRjaC5qcwp2YXIgX2dldEVycm9yTWVzc2FnZTIgPSAoZXJyKSA9PiBlcnIubXNnIHx8IGVyci5tZXNzYWdlIHx8IGVyci5lcnJvcl9kZXNjcmlwdGlvbiB8fCBlcnIuZXJyb3IgfHwgSlNPTi5zdHJpbmdpZnkoZXJyKTsKdmFyIE5FVFdPUktfRVJST1JfQ09ERVMgPSBbNTAyLCA1MDMsIDUwNF07CmFzeW5jIGZ1bmN0aW9uIGhhbmRsZUVycm9yMihlcnJvcikgewogIHZhciBfYTsKICBpZiAoIWxvb2tzTGlrZUZldGNoUmVzcG9uc2UoZXJyb3IpKSB7CiAgICB0aHJvdyBuZXcgQXV0aFJldHJ5YWJsZUZldGNoRXJyb3IoX2dldEVycm9yTWVzc2FnZTIoZXJyb3IpLCAwKTsKICB9CiAgaWYgKE5FVFdPUktfRVJST1JfQ09ERVMuaW5jbHVkZXMoZXJyb3Iuc3RhdHVzKSkgewogICAgdGhyb3cgbmV3IEF1dGhSZXRyeWFibGVGZXRjaEVycm9yKF9nZXRFcnJvck1lc3NhZ2UyKGVycm9yKSwgZXJyb3Iuc3RhdHVzKTsKICB9CiAgbGV0IGRhdGE7CiAgdHJ5IHsKICAgIGRhdGEgPSBhd2FpdCBlcnJvci5qc29uKCk7CiAgfSBjYXRjaCAoZSkgewogICAgdGhyb3cgbmV3IEF1dGhVbmtub3duRXJyb3IoX2dldEVycm9yTWVzc2FnZTIoZSksIGUpOwogIH0KICBsZXQgZXJyb3JDb2RlID0gdm9pZCAwOwogIGNvbnN0IHJlc3BvbnNlQVBJVmVyc2lvbiA9IHBhcnNlUmVzcG9uc2VBUElWZXJzaW9uKGVycm9yKTsKICBpZiAocmVzcG9uc2VBUElWZXJzaW9uICYmIHJlc3BvbnNlQVBJVmVyc2lvbi5nZXRUaW1lKCkgPj0gQVBJX1ZFUlNJT05TWyIyMDI0LTAxLTAxIl0udGltZXN0YW1wICYmIHR5cGVvZiBkYXRhID09PSAib2JqZWN0IiAmJiBkYXRhICYmIHR5cGVvZiBkYXRhLmNvZGUgPT09ICJzdHJpbmciKSB7CiAgICBlcnJvckNvZGUgPSBkYXRhLmNvZGU7CiAgfSBlbHNlIGlmICh0eXBlb2YgZGF0YSA9PT0gIm9iamVjdCIgJiYgZGF0YSAmJiB0eXBlb2YgZGF0YS5lcnJvcl9jb2RlID09PSAic3RyaW5nIikgewogICAgZXJyb3JDb2RlID0gZGF0YS5lcnJvcl9jb2RlOwogIH0KICBpZiAoIWVycm9yQ29kZSkgewogICAgaWYgKHR5cGVvZiBkYXRhID09PSAib2JqZWN0IiAmJiBkYXRhICYmIHR5cGVvZiBkYXRhLndlYWtfcGFzc3dvcmQgPT09ICJvYmplY3QiICYmIGRhdGEud2Vha19wYXNzd29yZCAmJiBBcnJheS5pc0FycmF5KGRhdGEud2Vha19wYXNzd29yZC5yZWFzb25zKSAmJiBkYXRhLndlYWtfcGFzc3dvcmQucmVhc29ucy5sZW5ndGggJiYgZGF0YS53ZWFrX3Bhc3N3b3JkLnJlYXNvbnMucmVkdWNlKChhLCBpKSA9PiBhICYmIHR5cGVvZiBpID09PSAic3RyaW5nIiwgdHJ1ZSkpIHsKICAgICAgdGhyb3cgbmV3IEF1dGhXZWFrUGFzc3dvcmRFcnJvcihfZ2V0RXJyb3JNZXNzYWdlMihkYXRhKSwgZXJyb3Iuc3RhdHVzLCBkYXRhLndlYWtfcGFzc3dvcmQucmVhc29ucyk7CiAgICB9CiAgfSBlbHNlIGlmIChlcnJvckNvZGUgPT09ICJ3ZWFrX3Bhc3N3b3JkIikgewogICAgdGhyb3cgbmV3IEF1dGhXZWFrUGFzc3dvcmRFcnJvcihfZ2V0RXJyb3JNZXNzYWdlMihkYXRhKSwgZXJyb3Iuc3RhdHVzLCAoKF9hID0gZGF0YS53ZWFrX3Bhc3N3b3JkKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucmVhc29ucykgfHwgW10pOwogIH0gZWxzZSBpZiAoZXJyb3JDb2RlID09PSAic2Vzc2lvbl9ub3RfZm91bmQiKSB7CiAgICB0aHJvdyBuZXcgQXV0aFNlc3Npb25NaXNzaW5nRXJyb3IoKTsKICB9CiAgdGhyb3cgbmV3IEF1dGhBcGlFcnJvcihfZ2V0RXJyb3JNZXNzYWdlMihkYXRhKSwgZXJyb3Iuc3RhdHVzIHx8IDUwMCwgZXJyb3JDb2RlKTsKfQp2YXIgX2dldFJlcXVlc3RQYXJhbXMyID0gKG1ldGhvZCwgb3B0aW9ucywgcGFyYW1ldGVycywgYm9keSkgPT4gewogIGNvbnN0IHBhcmFtcyA9IHsgbWV0aG9kLCBoZWFkZXJzOiAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmhlYWRlcnMpIHx8IHt9IH07CiAgaWYgKG1ldGhvZCA9PT0gIkdFVCIpIHsKICAgIHJldHVybiBwYXJhbXM7CiAgfQogIHBhcmFtcy5oZWFkZXJzID0gT2JqZWN0LmFzc2lnbih7ICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbjtjaGFyc2V0PVVURi04IiB9LCBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuaGVhZGVycyk7CiAgcGFyYW1zLmJvZHkgPSBKU09OLnN0cmluZ2lmeShib2R5KTsKICByZXR1cm4gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBwYXJhbXMpLCBwYXJhbWV0ZXJzKTsKfTsKYXN5bmMgZnVuY3Rpb24gX3JlcXVlc3QoZmV0Y2hlciwgbWV0aG9kLCB1cmwsIG9wdGlvbnMpIHsKICB2YXIgX2E7CiAgY29uc3QgaGVhZGVycyA9IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5oZWFkZXJzKTsKICBpZiAoIWhlYWRlcnNbQVBJX1ZFUlNJT05fSEVBREVSX05BTUVdKSB7CiAgICBoZWFkZXJzW0FQSV9WRVJTSU9OX0hFQURFUl9OQU1FXSA9IEFQSV9WRVJTSU9OU1siMjAyNC0wMS0wMSJdLm5hbWU7CiAgfQogIGlmIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuand0KSB7CiAgICBoZWFkZXJzWyJBdXRob3JpemF0aW9uIl0gPSBgQmVhcmVyICR7b3B0aW9ucy5qd3R9YDsKICB9CiAgY29uc3QgcXMgPSAoX2EgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMucXVlcnkpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IHt9OwogIGlmIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMucmVkaXJlY3RUbykgewogICAgcXNbInJlZGlyZWN0X3RvIl0gPSBvcHRpb25zLnJlZGlyZWN0VG87CiAgfQogIGNvbnN0IHF1ZXJ5U3RyaW5nID0gT2JqZWN0LmtleXMocXMpLmxlbmd0aCA/ICI/IiArIG5ldyBVUkxTZWFyY2hQYXJhbXMocXMpLnRvU3RyaW5nKCkgOiAiIjsKICBjb25zdCBkYXRhID0gYXdhaXQgX2hhbmRsZVJlcXVlc3QyKGZldGNoZXIsIG1ldGhvZCwgdXJsICsgcXVlcnlTdHJpbmcsIHsKICAgIGhlYWRlcnMsCiAgICBub1Jlc29sdmVKc29uOiBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMubm9SZXNvbHZlSnNvbgogIH0sIHt9LCBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuYm9keSk7CiAgcmV0dXJuIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMueGZvcm0pID8gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnhmb3JtKGRhdGEpIDogeyBkYXRhOiBPYmplY3QuYXNzaWduKHt9LCBkYXRhKSwgZXJyb3I6IG51bGwgfTsKfQphc3luYyBmdW5jdGlvbiBfaGFuZGxlUmVxdWVzdDIoZmV0Y2hlciwgbWV0aG9kLCB1cmwsIG9wdGlvbnMsIHBhcmFtZXRlcnMsIGJvZHkpIHsKICBjb25zdCByZXF1ZXN0UGFyYW1zID0gX2dldFJlcXVlc3RQYXJhbXMyKG1ldGhvZCwgb3B0aW9ucywgcGFyYW1ldGVycywgYm9keSk7CiAgbGV0IHJlc3VsdDsKICB0cnkgewogICAgcmVzdWx0ID0gYXdhaXQgZmV0Y2hlcih1cmwsIE9iamVjdC5hc3NpZ24oe30sIHJlcXVlc3RQYXJhbXMpKTsKICB9IGNhdGNoIChlKSB7CiAgICBjb25zb2xlLmVycm9yKGUpOwogICAgdGhyb3cgbmV3IEF1dGhSZXRyeWFibGVGZXRjaEVycm9yKF9nZXRFcnJvck1lc3NhZ2UyKGUpLCAwKTsKICB9CiAgaWYgKCFyZXN1bHQub2spIHsKICAgIGF3YWl0IGhhbmRsZUVycm9yMihyZXN1bHQpOwogIH0KICBpZiAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLm5vUmVzb2x2ZUpzb24pIHsKICAgIHJldHVybiByZXN1bHQ7CiAgfQogIHRyeSB7CiAgICByZXR1cm4gYXdhaXQgcmVzdWx0Lmpzb24oKTsKICB9IGNhdGNoIChlKSB7CiAgICBhd2FpdCBoYW5kbGVFcnJvcjIoZSk7CiAgfQp9CmZ1bmN0aW9uIF9zZXNzaW9uUmVzcG9uc2UoZGF0YSkgewogIHZhciBfYTsKICBsZXQgc2Vzc2lvbiA9IG51bGw7CiAgaWYgKGhhc1Nlc3Npb24oZGF0YSkpIHsKICAgIHNlc3Npb24gPSBPYmplY3QuYXNzaWduKHt9LCBkYXRhKTsKICAgIGlmICghZGF0YS5leHBpcmVzX2F0KSB7CiAgICAgIHNlc3Npb24uZXhwaXJlc19hdCA9IGV4cGlyZXNBdChkYXRhLmV4cGlyZXNfaW4pOwogICAgfQogIH0KICBjb25zdCB1c2VyID0gKF9hID0gZGF0YS51c2VyKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBkYXRhOwogIHJldHVybiB7IGRhdGE6IHsgc2Vzc2lvbiwgdXNlciB9LCBlcnJvcjogbnVsbCB9Owp9CmZ1bmN0aW9uIF9zZXNzaW9uUmVzcG9uc2VQYXNzd29yZChkYXRhKSB7CiAgY29uc3QgcmVzcG9uc2UgPSBfc2Vzc2lvblJlc3BvbnNlKGRhdGEpOwogIGlmICghcmVzcG9uc2UuZXJyb3IgJiYgZGF0YS53ZWFrX3Bhc3N3b3JkICYmIHR5cGVvZiBkYXRhLndlYWtfcGFzc3dvcmQgPT09ICJvYmplY3QiICYmIEFycmF5LmlzQXJyYXkoZGF0YS53ZWFrX3Bhc3N3b3JkLnJlYXNvbnMpICYmIGRhdGEud2Vha19wYXNzd29yZC5yZWFzb25zLmxlbmd0aCAmJiBkYXRhLndlYWtfcGFzc3dvcmQubWVzc2FnZSAmJiB0eXBlb2YgZGF0YS53ZWFrX3Bhc3N3b3JkLm1lc3NhZ2UgPT09ICJzdHJpbmciICYmIGRhdGEud2Vha19wYXNzd29yZC5yZWFzb25zLnJlZHVjZSgoYSwgaSkgPT4gYSAmJiB0eXBlb2YgaSA9PT0gInN0cmluZyIsIHRydWUpKSB7CiAgICByZXNwb25zZS5kYXRhLndlYWtfcGFzc3dvcmQgPSBkYXRhLndlYWtfcGFzc3dvcmQ7CiAgfQogIHJldHVybiByZXNwb25zZTsKfQpmdW5jdGlvbiBfdXNlclJlc3BvbnNlKGRhdGEpIHsKICB2YXIgX2E7CiAgY29uc3QgdXNlciA9IChfYSA9IGRhdGEudXNlcikgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogZGF0YTsKICByZXR1cm4geyBkYXRhOiB7IHVzZXIgfSwgZXJyb3I6IG51bGwgfTsKfQpmdW5jdGlvbiBfc3NvUmVzcG9uc2UoZGF0YSkgewogIHJldHVybiB7IGRhdGEsIGVycm9yOiBudWxsIH07Cn0KZnVuY3Rpb24gX2dlbmVyYXRlTGlua1Jlc3BvbnNlKGRhdGEpIHsKICBjb25zdCB7IGFjdGlvbl9saW5rLCBlbWFpbF9vdHAsIGhhc2hlZF90b2tlbiwgcmVkaXJlY3RfdG8sIHZlcmlmaWNhdGlvbl90eXBlIH0gPSBkYXRhLCByZXN0ID0gX19yZXN0KGRhdGEsIFsiYWN0aW9uX2xpbmsiLCAiZW1haWxfb3RwIiwgImhhc2hlZF90b2tlbiIsICJyZWRpcmVjdF90byIsICJ2ZXJpZmljYXRpb25fdHlwZSJdKTsKICBjb25zdCBwcm9wZXJ0aWVzID0gewogICAgYWN0aW9uX2xpbmssCiAgICBlbWFpbF9vdHAsCiAgICBoYXNoZWRfdG9rZW4sCiAgICByZWRpcmVjdF90bywKICAgIHZlcmlmaWNhdGlvbl90eXBlCiAgfTsKICBjb25zdCB1c2VyID0gT2JqZWN0LmFzc2lnbih7fSwgcmVzdCk7CiAgcmV0dXJuIHsKICAgIGRhdGE6IHsKICAgICAgcHJvcGVydGllcywKICAgICAgdXNlcgogICAgfSwKICAgIGVycm9yOiBudWxsCiAgfTsKfQpmdW5jdGlvbiBfbm9SZXNvbHZlSnNvblJlc3BvbnNlKGRhdGEpIHsKICByZXR1cm4gZGF0YTsKfQpmdW5jdGlvbiBoYXNTZXNzaW9uKGRhdGEpIHsKICByZXR1cm4gZGF0YS5hY2Nlc3NfdG9rZW4gJiYgZGF0YS5yZWZyZXNoX3Rva2VuICYmIGRhdGEuZXhwaXJlc19pbjsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZSthdXRoLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL2F1dGgtanMvZGlzdC9tb2R1bGUvbGliL3R5cGVzLmpzCnZhciBTSUdOX09VVF9TQ09QRVMgPSBbImdsb2JhbCIsICJsb2NhbCIsICJvdGhlcnMiXTsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrYXV0aC1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9hdXRoLWpzL2Rpc3QvbW9kdWxlL0dvVHJ1ZUFkbWluQXBpLmpzCnZhciBHb1RydWVBZG1pbkFwaSA9IGNsYXNzIHsKICAvKioKICAgKiBDcmVhdGVzIGFuIGFkbWluIEFQSSBjbGllbnQgdGhhdCBjYW4gYmUgdXNlZCB0byBtYW5hZ2UgdXNlcnMgYW5kIE9BdXRoIGNsaWVudHMuCiAgICoKICAgKiBAZXhhbXBsZQogICAqIGBgYHRzCiAgICogaW1wb3J0IHsgR29UcnVlQWRtaW5BcGkgfSBmcm9tICdAc3VwYWJhc2UvYXV0aC1qcycKICAgKgogICAqIGNvbnN0IGFkbWluID0gbmV3IEdvVHJ1ZUFkbWluQXBpKHsKICAgKiAgIHVybDogJ2h0dHBzOi8veHl6Y29tcGFueS5zdXBhYmFzZS5jby9hdXRoL3YxJywKICAgKiAgIGhlYWRlcnM6IHsgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3Byb2Nlc3MuZW52LlNVUEFCQVNFX1NFUlZJQ0VfUk9MRV9LRVl9YCB9LAogICAqIH0pCiAgICogYGBgCiAgICovCiAgY29uc3RydWN0b3IoeyB1cmwgPSAiIiwgaGVhZGVycyA9IHt9LCBmZXRjaDogZmV0Y2gyIH0pIHsKICAgIHRoaXMudXJsID0gdXJsOwogICAgdGhpcy5oZWFkZXJzID0gaGVhZGVyczsKICAgIHRoaXMuZmV0Y2ggPSByZXNvbHZlRmV0Y2gzKGZldGNoMik7CiAgICB0aGlzLm1mYSA9IHsKICAgICAgbGlzdEZhY3RvcnM6IHRoaXMuX2xpc3RGYWN0b3JzLmJpbmQodGhpcyksCiAgICAgIGRlbGV0ZUZhY3RvcjogdGhpcy5fZGVsZXRlRmFjdG9yLmJpbmQodGhpcykKICAgIH07CiAgICB0aGlzLm9hdXRoID0gewogICAgICBsaXN0Q2xpZW50czogdGhpcy5fbGlzdE9BdXRoQ2xpZW50cy5iaW5kKHRoaXMpLAogICAgICBjcmVhdGVDbGllbnQ6IHRoaXMuX2NyZWF0ZU9BdXRoQ2xpZW50LmJpbmQodGhpcyksCiAgICAgIGdldENsaWVudDogdGhpcy5fZ2V0T0F1dGhDbGllbnQuYmluZCh0aGlzKSwKICAgICAgdXBkYXRlQ2xpZW50OiB0aGlzLl91cGRhdGVPQXV0aENsaWVudC5iaW5kKHRoaXMpLAogICAgICBkZWxldGVDbGllbnQ6IHRoaXMuX2RlbGV0ZU9BdXRoQ2xpZW50LmJpbmQodGhpcyksCiAgICAgIHJlZ2VuZXJhdGVDbGllbnRTZWNyZXQ6IHRoaXMuX3JlZ2VuZXJhdGVPQXV0aENsaWVudFNlY3JldC5iaW5kKHRoaXMpCiAgICB9OwogIH0KICAvKioKICAgKiBSZW1vdmVzIGEgbG9nZ2VkLWluIHNlc3Npb24uCiAgICogQHBhcmFtIGp3dCBBIHZhbGlkLCBsb2dnZWQtaW4gSldULgogICAqIEBwYXJhbSBzY29wZSBUaGUgbG9nb3V0IHNvcGUuCiAgICovCiAgYXN5bmMgc2lnbk91dChqd3QsIHNjb3BlID0gU0lHTl9PVVRfU0NPUEVTWzBdKSB7CiAgICBpZiAoU0lHTl9PVVRfU0NPUEVTLmluZGV4T2Yoc2NvcGUpIDwgMCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYEBzdXBhYmFzZS9hdXRoLWpzOiBQYXJhbWV0ZXIgc2NvcGUgbXVzdCBiZSBvbmUgb2YgJHtTSUdOX09VVF9TQ09QRVMuam9pbigiLCAiKX1gKTsKICAgIH0KICAgIHRyeSB7CiAgICAgIGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L2xvZ291dD9zY29wZT0ke3Njb3BlfWAsIHsKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgand0LAogICAgICAgIG5vUmVzb2x2ZUpzb246IHRydWUKICAgICAgfSk7CiAgICAgIHJldHVybiB7IGRhdGE6IG51bGwsIGVycm9yOiBudWxsIH07CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3IgfTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogU2VuZHMgYW4gaW52aXRlIGxpbmsgdG8gYW4gZW1haWwgYWRkcmVzcy4KICAgKiBAcGFyYW0gZW1haWwgVGhlIGVtYWlsIGFkZHJlc3Mgb2YgdGhlIHVzZXIuCiAgICogQHBhcmFtIG9wdGlvbnMgQWRkaXRpb25hbCBvcHRpb25zIHRvIGJlIGluY2x1ZGVkIHdoZW4gaW52aXRpbmcuCiAgICovCiAgYXN5bmMgaW52aXRlVXNlckJ5RW1haWwoZW1haWwsIG9wdGlvbnMgPSB7fSkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L2ludml0ZWAsIHsKICAgICAgICBib2R5OiB7IGVtYWlsLCBkYXRhOiBvcHRpb25zLmRhdGEgfSwKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgcmVkaXJlY3RUbzogb3B0aW9ucy5yZWRpcmVjdFRvLAogICAgICAgIHhmb3JtOiBfdXNlclJlc3BvbnNlCiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB7IGRhdGE6IHsgdXNlcjogbnVsbCB9LCBlcnJvciB9OwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBHZW5lcmF0ZXMgZW1haWwgbGlua3MgYW5kIE9UUHMgdG8gYmUgc2VudCB2aWEgYSBjdXN0b20gZW1haWwgcHJvdmlkZXIuCiAgICogQHBhcmFtIGVtYWlsIFRoZSB1c2VyJ3MgZW1haWwuCiAgICogQHBhcmFtIG9wdGlvbnMucGFzc3dvcmQgVXNlciBwYXNzd29yZC4gRm9yIHNpZ251cCBvbmx5LgogICAqIEBwYXJhbSBvcHRpb25zLmRhdGEgT3B0aW9uYWwgdXNlciBtZXRhZGF0YS4gRm9yIHNpZ251cCBvbmx5LgogICAqIEBwYXJhbSBvcHRpb25zLnJlZGlyZWN0VG8gVGhlIHJlZGlyZWN0IHVybCB3aGljaCBzaG91bGQgYmUgYXBwZW5kZWQgdG8gdGhlIGdlbmVyYXRlZCBsaW5rCiAgICovCiAgYXN5bmMgZ2VuZXJhdGVMaW5rKHBhcmFtcykgewogICAgdHJ5IHsKICAgICAgY29uc3QgeyBvcHRpb25zIH0gPSBwYXJhbXMsIHJlc3QgPSBfX3Jlc3QocGFyYW1zLCBbIm9wdGlvbnMiXSk7CiAgICAgIGNvbnN0IGJvZHkgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHJlc3QpLCBvcHRpb25zKTsKICAgICAgaWYgKCJuZXdFbWFpbCIgaW4gcmVzdCkgewogICAgICAgIGJvZHkubmV3X2VtYWlsID0gcmVzdCA9PT0gbnVsbCB8fCByZXN0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiByZXN0Lm5ld0VtYWlsOwogICAgICAgIGRlbGV0ZSBib2R5WyJuZXdFbWFpbCJdOwogICAgICB9CiAgICAgIHJldHVybiBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGAke3RoaXMudXJsfS9hZG1pbi9nZW5lcmF0ZV9saW5rYCwgewogICAgICAgIGJvZHksCiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIHhmb3JtOiBfZ2VuZXJhdGVMaW5rUmVzcG9uc2UsCiAgICAgICAgcmVkaXJlY3RUbzogb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnJlZGlyZWN0VG8KICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgcHJvcGVydGllczogbnVsbCwKICAgICAgICAgICAgdXNlcjogbnVsbAogICAgICAgICAgfSwKICAgICAgICAgIGVycm9yCiAgICAgICAgfTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLy8gVXNlciBBZG1pbiBBUEkKICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IHVzZXIuCiAgICogVGhpcyBmdW5jdGlvbiBzaG91bGQgb25seSBiZSBjYWxsZWQgb24gYSBzZXJ2ZXIuIE5ldmVyIGV4cG9zZSB5b3VyIGBzZXJ2aWNlX3JvbGVgIGtleSBpbiB0aGUgYnJvd3Nlci4KICAgKi8KICBhc3luYyBjcmVhdGVVc2VyKGF0dHJpYnV0ZXMpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGAke3RoaXMudXJsfS9hZG1pbi91c2Vyc2AsIHsKICAgICAgICBib2R5OiBhdHRyaWJ1dGVzLAogICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICB4Zm9ybTogX3VzZXJSZXNwb25zZQogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiB7IHVzZXI6IG51bGwgfSwgZXJyb3IgfTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogR2V0IGEgbGlzdCBvZiB1c2Vycy4KICAgKgogICAqIFRoaXMgZnVuY3Rpb24gc2hvdWxkIG9ubHkgYmUgY2FsbGVkIG9uIGEgc2VydmVyLiBOZXZlciBleHBvc2UgeW91ciBgc2VydmljZV9yb2xlYCBrZXkgaW4gdGhlIGJyb3dzZXIuCiAgICogQHBhcmFtIHBhcmFtcyBBbiBvYmplY3Qgd2hpY2ggc3VwcG9ydHMgYHBhZ2VgIGFuZCBgcGVyUGFnZWAgYXMgbnVtYmVycywgdG8gYWx0ZXIgdGhlIHBhZ2luYXRlZCByZXN1bHRzLgogICAqLwogIGFzeW5jIGxpc3RVc2VycyhwYXJhbXMpIHsKICAgIHZhciBfYSwgX2IsIF9jLCBfZCwgX2UsIF9mLCBfZzsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHBhZ2luYXRpb24gPSB7IG5leHRQYWdlOiBudWxsLCBsYXN0UGFnZTogMCwgdG90YWw6IDAgfTsKICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiR0VUIiwgYCR7dGhpcy51cmx9L2FkbWluL3VzZXJzYCwgewogICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICBub1Jlc29sdmVKc29uOiB0cnVlLAogICAgICAgIHF1ZXJ5OiB7CiAgICAgICAgICBwYWdlOiAoX2IgPSAoX2EgPSBwYXJhbXMgPT09IG51bGwgfHwgcGFyYW1zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwYXJhbXMucGFnZSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnRvU3RyaW5nKCkpICE9PSBudWxsICYmIF9iICE9PSB2b2lkIDAgPyBfYiA6ICIiLAogICAgICAgICAgcGVyX3BhZ2U6IChfZCA9IChfYyA9IHBhcmFtcyA9PT0gbnVsbCB8fCBwYXJhbXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHBhcmFtcy5wZXJQYWdlKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MudG9TdHJpbmcoKSkgIT09IG51bGwgJiYgX2QgIT09IHZvaWQgMCA/IF9kIDogIiIKICAgICAgICB9LAogICAgICAgIHhmb3JtOiBfbm9SZXNvbHZlSnNvblJlc3BvbnNlCiAgICAgIH0pOwogICAgICBpZiAocmVzcG9uc2UuZXJyb3IpCiAgICAgICAgdGhyb3cgcmVzcG9uc2UuZXJyb3I7CiAgICAgIGNvbnN0IHVzZXJzID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwogICAgICBjb25zdCB0b3RhbCA9IChfZSA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCJ4LXRvdGFsLWNvdW50IikpICE9PSBudWxsICYmIF9lICE9PSB2b2lkIDAgPyBfZSA6IDA7CiAgICAgIGNvbnN0IGxpbmtzID0gKF9nID0gKF9mID0gcmVzcG9uc2UuaGVhZGVycy5nZXQoImxpbmsiKSkgPT09IG51bGwgfHwgX2YgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9mLnNwbGl0KCIsIikpICE9PSBudWxsICYmIF9nICE9PSB2b2lkIDAgPyBfZyA6IFtdOwogICAgICBpZiAobGlua3MubGVuZ3RoID4gMCkgewogICAgICAgIGxpbmtzLmZvckVhY2goKGxpbmspID0+IHsKICAgICAgICAgIGNvbnN0IHBhZ2UgPSBwYXJzZUludChsaW5rLnNwbGl0KCI7IilbMF0uc3BsaXQoIj0iKVsxXS5zdWJzdHJpbmcoMCwgMSkpOwogICAgICAgICAgY29uc3QgcmVsID0gSlNPTi5wYXJzZShsaW5rLnNwbGl0KCI7IilbMV0uc3BsaXQoIj0iKVsxXSk7CiAgICAgICAgICBwYWdpbmF0aW9uW2Ake3JlbH1QYWdlYF0gPSBwYWdlOwogICAgICAgIH0pOwogICAgICAgIHBhZ2luYXRpb24udG90YWwgPSBwYXJzZUludCh0b3RhbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHsgZGF0YTogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCB1c2VycyksIHBhZ2luYXRpb24pLCBlcnJvcjogbnVsbCB9OwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB7IGRhdGE6IHsgdXNlcnM6IFtdIH0sIGVycm9yIH07CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIEdldCB1c2VyIGJ5IGlkLgogICAqCiAgICogQHBhcmFtIHVpZCBUaGUgdXNlcidzIHVuaXF1ZSBpZGVudGlmaWVyCiAgICoKICAgKiBUaGlzIGZ1bmN0aW9uIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBvbiBhIHNlcnZlci4gTmV2ZXIgZXhwb3NlIHlvdXIgYHNlcnZpY2Vfcm9sZWAga2V5IGluIHRoZSBicm93c2VyLgogICAqLwogIGFzeW5jIGdldFVzZXJCeUlkKHVpZCkgewogICAgdmFsaWRhdGVVVUlEKHVpZCk7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIkdFVCIsIGAke3RoaXMudXJsfS9hZG1pbi91c2Vycy8ke3VpZH1gLCB7CiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIHhmb3JtOiBfdXNlclJlc3BvbnNlCiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB7IGRhdGE6IHsgdXNlcjogbnVsbCB9LCBlcnJvciB9OwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBVcGRhdGVzIHRoZSB1c2VyIGRhdGEuIENoYW5nZXMgYXJlIGFwcGxpZWQgZGlyZWN0bHkgd2l0aG91dCBjb25maXJtYXRpb24gZmxvd3MuCiAgICoKICAgKiBAcGFyYW0gdWlkIFRoZSB1c2VyJ3MgdW5pcXVlIGlkZW50aWZpZXIKICAgKiBAcGFyYW0gYXR0cmlidXRlcyBUaGUgZGF0YSB5b3Ugd2FudCB0byB1cGRhdGUuCiAgICoKICAgKiBUaGlzIGZ1bmN0aW9uIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBvbiBhIHNlcnZlci4gTmV2ZXIgZXhwb3NlIHlvdXIgYHNlcnZpY2Vfcm9sZWAga2V5IGluIHRoZSBicm93c2VyLgogICAqCiAgICogQHJlbWFya3MKICAgKiAqKkltcG9ydGFudDoqKiBUaGlzIGlzIGEgc2VydmVyLXNpZGUgb3BlcmF0aW9uIGFuZCBkb2VzICoqbm90KiogdHJpZ2dlciBjbGllbnQtc2lkZQogICAqIGBvbkF1dGhTdGF0ZUNoYW5nZWAgbGlzdGVuZXJzLiBUaGUgYWRtaW4gQVBJIGhhcyBubyBjb25uZWN0aW9uIHRvIGNsaWVudCBzdGF0ZS4KICAgKgogICAqIFRvIHN5bmMgY2hhbmdlcyB0byB0aGUgY2xpZW50IGFmdGVyIGNhbGxpbmcgdGhpcyBtZXRob2Q6CiAgICogMS4gT24gdGhlIGNsaWVudCwgY2FsbCBgc3VwYWJhc2UuYXV0aC5yZWZyZXNoU2Vzc2lvbigpYCB0byBmZXRjaCB0aGUgdXBkYXRlZCB1c2VyIGRhdGEKICAgKiAyLiBUaGlzIHdpbGwgdHJpZ2dlciB0aGUgYFRPS0VOX1JFRlJFU0hFRGAgZXZlbnQgYW5kIG5vdGlmeSBhbGwgbGlzdGVuZXJzCiAgICoKICAgKiBAZXhhbXBsZQogICAqIGBgYHR5cGVzY3JpcHQKICAgKiAvLyBTZXJ2ZXItc2lkZSAoRWRnZSBGdW5jdGlvbikKICAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZS5hdXRoLmFkbWluLnVwZGF0ZVVzZXJCeUlkKAogICAqICAgdXNlcklkLAogICAqICAgeyB1c2VyX21ldGFkYXRhOiB7IHByZWZlcmVuY2VzOiB7IHRoZW1lOiAnZGFyaycgfSB9IH0KICAgKiApCiAgICoKICAgKiAvLyBDbGllbnQtc2lkZSAodG8gc3luYyB0aGUgY2hhbmdlcykKICAgKiBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZS5hdXRoLnJlZnJlc2hTZXNzaW9uKCkKICAgKiAvLyBvbkF1dGhTdGF0ZUNoYW5nZSBsaXN0ZW5lcnMgd2lsbCBub3cgYmUgbm90aWZpZWQgd2l0aCB1cGRhdGVkIHVzZXIKICAgKiBgYGAKICAgKgogICAqIEBzZWUge0BsaW5rIEdvVHJ1ZUNsaWVudC5yZWZyZXNoU2Vzc2lvbn0gZm9yIHN5bmNpbmcgYWRtaW4gY2hhbmdlcyB0byB0aGUgY2xpZW50CiAgICogQHNlZSB7QGxpbmsgR29UcnVlQ2xpZW50LnVwZGF0ZVVzZXJ9IGZvciBjbGllbnQtc2lkZSB1c2VyIHVwZGF0ZXMgKHRyaWdnZXJzIGxpc3RlbmVycyBhdXRvbWF0aWNhbGx5KQogICAqLwogIGFzeW5jIHVwZGF0ZVVzZXJCeUlkKHVpZCwgYXR0cmlidXRlcykgewogICAgdmFsaWRhdGVVVUlEKHVpZCk7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBVVCIsIGAke3RoaXMudXJsfS9hZG1pbi91c2Vycy8ke3VpZH1gLCB7CiAgICAgICAgYm9keTogYXR0cmlidXRlcywKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgeGZvcm06IF91c2VyUmVzcG9uc2UKICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogeyB1c2VyOiBudWxsIH0sIGVycm9yIH07CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIERlbGV0ZSBhIHVzZXIuIFJlcXVpcmVzIGEgYHNlcnZpY2Vfcm9sZWAga2V5LgogICAqCiAgICogQHBhcmFtIGlkIFRoZSB1c2VyIGlkIHlvdSB3YW50IHRvIHJlbW92ZS4KICAgKiBAcGFyYW0gc2hvdWxkU29mdERlbGV0ZSBJZiB0cnVlLCB0aGVuIHRoZSB1c2VyIHdpbGwgYmUgc29mdC1kZWxldGVkIGZyb20gdGhlIGF1dGggc2NoZW1hLiBTb2Z0IGRlbGV0aW9uIGFsbG93cyB1c2VyIGlkZW50aWZpY2F0aW9uIGZyb20gdGhlIGhhc2hlZCB1c2VyIElEIGJ1dCBpcyBub3QgcmV2ZXJzaWJsZS4KICAgKiBEZWZhdWx0cyB0byBmYWxzZSBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eS4KICAgKgogICAqIFRoaXMgZnVuY3Rpb24gc2hvdWxkIG9ubHkgYmUgY2FsbGVkIG9uIGEgc2VydmVyLiBOZXZlciBleHBvc2UgeW91ciBgc2VydmljZV9yb2xlYCBrZXkgaW4gdGhlIGJyb3dzZXIuCiAgICovCiAgYXN5bmMgZGVsZXRlVXNlcihpZCwgc2hvdWxkU29mdERlbGV0ZSA9IGZhbHNlKSB7CiAgICB2YWxpZGF0ZVVVSUQoaWQpOwogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJERUxFVEUiLCBgJHt0aGlzLnVybH0vYWRtaW4vdXNlcnMvJHtpZH1gLCB7CiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIGJvZHk6IHsKICAgICAgICAgIHNob3VsZF9zb2Z0X2RlbGV0ZTogc2hvdWxkU29mdERlbGV0ZQogICAgICAgIH0sCiAgICAgICAgeGZvcm06IF91c2VyUmVzcG9uc2UKICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogeyB1c2VyOiBudWxsIH0sIGVycm9yIH07CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIGFzeW5jIF9saXN0RmFjdG9ycyhwYXJhbXMpIHsKICAgIHZhbGlkYXRlVVVJRChwYXJhbXMudXNlcklkKTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJHRVQiLCBgJHt0aGlzLnVybH0vYWRtaW4vdXNlcnMvJHtwYXJhbXMudXNlcklkfS9mYWN0b3JzYCwgewogICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICB4Zm9ybTogKGZhY3RvcnMpID0+IHsKICAgICAgICAgIHJldHVybiB7IGRhdGE6IHsgZmFjdG9ycyB9LCBlcnJvcjogbnVsbCB9OwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHJldHVybiB7IGRhdGEsIGVycm9yIH07CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3IgfTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgYXN5bmMgX2RlbGV0ZUZhY3RvcihwYXJhbXMpIHsKICAgIHZhbGlkYXRlVVVJRChwYXJhbXMudXNlcklkKTsKICAgIHZhbGlkYXRlVVVJRChwYXJhbXMuaWQpOwogICAgdHJ5IHsKICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJERUxFVEUiLCBgJHt0aGlzLnVybH0vYWRtaW4vdXNlcnMvJHtwYXJhbXMudXNlcklkfS9mYWN0b3JzLyR7cGFyYW1zLmlkfWAsIHsKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMKICAgICAgfSk7CiAgICAgIHJldHVybiB7IGRhdGEsIGVycm9yOiBudWxsIH07CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3IgfTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogTGlzdHMgYWxsIE9BdXRoIGNsaWVudHMgd2l0aCBvcHRpb25hbCBwYWdpbmF0aW9uLgogICAqIE9ubHkgcmVsZXZhbnQgd2hlbiB0aGUgT0F1dGggMi4xIHNlcnZlciBpcyBlbmFibGVkIGluIFN1cGFiYXNlIEF1dGguCiAgICoKICAgKiBUaGlzIGZ1bmN0aW9uIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBvbiBhIHNlcnZlci4gTmV2ZXIgZXhwb3NlIHlvdXIgYHNlcnZpY2Vfcm9sZWAga2V5IGluIHRoZSBicm93c2VyLgogICAqLwogIGFzeW5jIF9saXN0T0F1dGhDbGllbnRzKHBhcmFtcykgewogICAgdmFyIF9hLCBfYiwgX2MsIF9kLCBfZSwgX2YsIF9nOwogICAgdHJ5IHsKICAgICAgY29uc3QgcGFnaW5hdGlvbiA9IHsgbmV4dFBhZ2U6IG51bGwsIGxhc3RQYWdlOiAwLCB0b3RhbDogMCB9OwogICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJHRVQiLCBgJHt0aGlzLnVybH0vYWRtaW4vb2F1dGgvY2xpZW50c2AsIHsKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgbm9SZXNvbHZlSnNvbjogdHJ1ZSwKICAgICAgICBxdWVyeTogewogICAgICAgICAgcGFnZTogKF9iID0gKF9hID0gcGFyYW1zID09PSBudWxsIHx8IHBhcmFtcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogcGFyYW1zLnBhZ2UpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS50b1N0cmluZygpKSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiAiIiwKICAgICAgICAgIHBlcl9wYWdlOiAoX2QgPSAoX2MgPSBwYXJhbXMgPT09IG51bGwgfHwgcGFyYW1zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwYXJhbXMucGVyUGFnZSkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLnRvU3RyaW5nKCkpICE9PSBudWxsICYmIF9kICE9PSB2b2lkIDAgPyBfZCA6ICIiCiAgICAgICAgfSwKICAgICAgICB4Zm9ybTogX25vUmVzb2x2ZUpzb25SZXNwb25zZQogICAgICB9KTsKICAgICAgaWYgKHJlc3BvbnNlLmVycm9yKQogICAgICAgIHRocm93IHJlc3BvbnNlLmVycm9yOwogICAgICBjb25zdCBjbGllbnRzID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwogICAgICBjb25zdCB0b3RhbCA9IChfZSA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCJ4LXRvdGFsLWNvdW50IikpICE9PSBudWxsICYmIF9lICE9PSB2b2lkIDAgPyBfZSA6IDA7CiAgICAgIGNvbnN0IGxpbmtzID0gKF9nID0gKF9mID0gcmVzcG9uc2UuaGVhZGVycy5nZXQoImxpbmsiKSkgPT09IG51bGwgfHwgX2YgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9mLnNwbGl0KCIsIikpICE9PSBudWxsICYmIF9nICE9PSB2b2lkIDAgPyBfZyA6IFtdOwogICAgICBpZiAobGlua3MubGVuZ3RoID4gMCkgewogICAgICAgIGxpbmtzLmZvckVhY2goKGxpbmspID0+IHsKICAgICAgICAgIGNvbnN0IHBhZ2UgPSBwYXJzZUludChsaW5rLnNwbGl0KCI7IilbMF0uc3BsaXQoIj0iKVsxXS5zdWJzdHJpbmcoMCwgMSkpOwogICAgICAgICAgY29uc3QgcmVsID0gSlNPTi5wYXJzZShsaW5rLnNwbGl0KCI7IilbMV0uc3BsaXQoIj0iKVsxXSk7CiAgICAgICAgICBwYWdpbmF0aW9uW2Ake3JlbH1QYWdlYF0gPSBwYWdlOwogICAgICAgIH0pOwogICAgICAgIHBhZ2luYXRpb24udG90YWwgPSBwYXJzZUludCh0b3RhbCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHsgZGF0YTogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBjbGllbnRzKSwgcGFnaW5hdGlvbiksIGVycm9yOiBudWxsIH07CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogeyBjbGllbnRzOiBbXSB9LCBlcnJvciB9OwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBDcmVhdGVzIGEgbmV3IE9BdXRoIGNsaWVudC4KICAgKiBPbmx5IHJlbGV2YW50IHdoZW4gdGhlIE9BdXRoIDIuMSBzZXJ2ZXIgaXMgZW5hYmxlZCBpbiBTdXBhYmFzZSBBdXRoLgogICAqCiAgICogVGhpcyBmdW5jdGlvbiBzaG91bGQgb25seSBiZSBjYWxsZWQgb24gYSBzZXJ2ZXIuIE5ldmVyIGV4cG9zZSB5b3VyIGBzZXJ2aWNlX3JvbGVgIGtleSBpbiB0aGUgYnJvd3Nlci4KICAgKi8KICBhc3luYyBfY3JlYXRlT0F1dGhDbGllbnQocGFyYW1zKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vYWRtaW4vb2F1dGgvY2xpZW50c2AsIHsKICAgICAgICBib2R5OiBwYXJhbXMsCiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIHhmb3JtOiAoY2xpZW50KSA9PiB7CiAgICAgICAgICByZXR1cm4geyBkYXRhOiBjbGllbnQsIGVycm9yOiBudWxsIH07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvciB9OwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBHZXRzIGRldGFpbHMgb2YgYSBzcGVjaWZpYyBPQXV0aCBjbGllbnQuCiAgICogT25seSByZWxldmFudCB3aGVuIHRoZSBPQXV0aCAyLjEgc2VydmVyIGlzIGVuYWJsZWQgaW4gU3VwYWJhc2UgQXV0aC4KICAgKgogICAqIFRoaXMgZnVuY3Rpb24gc2hvdWxkIG9ubHkgYmUgY2FsbGVkIG9uIGEgc2VydmVyLiBOZXZlciBleHBvc2UgeW91ciBgc2VydmljZV9yb2xlYCBrZXkgaW4gdGhlIGJyb3dzZXIuCiAgICovCiAgYXN5bmMgX2dldE9BdXRoQ2xpZW50KGNsaWVudElkKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIkdFVCIsIGAke3RoaXMudXJsfS9hZG1pbi9vYXV0aC9jbGllbnRzLyR7Y2xpZW50SWR9YCwgewogICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICB4Zm9ybTogKGNsaWVudCkgPT4gewogICAgICAgICAgcmV0dXJuIHsgZGF0YTogY2xpZW50LCBlcnJvcjogbnVsbCB9OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3IgfTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogVXBkYXRlcyBhbiBleGlzdGluZyBPQXV0aCBjbGllbnQuCiAgICogT25seSByZWxldmFudCB3aGVuIHRoZSBPQXV0aCAyLjEgc2VydmVyIGlzIGVuYWJsZWQgaW4gU3VwYWJhc2UgQXV0aC4KICAgKgogICAqIFRoaXMgZnVuY3Rpb24gc2hvdWxkIG9ubHkgYmUgY2FsbGVkIG9uIGEgc2VydmVyLiBOZXZlciBleHBvc2UgeW91ciBgc2VydmljZV9yb2xlYCBrZXkgaW4gdGhlIGJyb3dzZXIuCiAgICovCiAgYXN5bmMgX3VwZGF0ZU9BdXRoQ2xpZW50KGNsaWVudElkLCBwYXJhbXMpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUFVUIiwgYCR7dGhpcy51cmx9L2FkbWluL29hdXRoL2NsaWVudHMvJHtjbGllbnRJZH1gLCB7CiAgICAgICAgYm9keTogcGFyYW1zLAogICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICB4Zm9ybTogKGNsaWVudCkgPT4gewogICAgICAgICAgcmV0dXJuIHsgZGF0YTogY2xpZW50LCBlcnJvcjogbnVsbCB9OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3IgfTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogRGVsZXRlcyBhbiBPQXV0aCBjbGllbnQuCiAgICogT25seSByZWxldmFudCB3aGVuIHRoZSBPQXV0aCAyLjEgc2VydmVyIGlzIGVuYWJsZWQgaW4gU3VwYWJhc2UgQXV0aC4KICAgKgogICAqIFRoaXMgZnVuY3Rpb24gc2hvdWxkIG9ubHkgYmUgY2FsbGVkIG9uIGEgc2VydmVyLiBOZXZlciBleHBvc2UgeW91ciBgc2VydmljZV9yb2xlYCBrZXkgaW4gdGhlIGJyb3dzZXIuCiAgICovCiAgYXN5bmMgX2RlbGV0ZU9BdXRoQ2xpZW50KGNsaWVudElkKSB7CiAgICB0cnkgewogICAgICBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiREVMRVRFIiwgYCR7dGhpcy51cmx9L2FkbWluL29hdXRoL2NsaWVudHMvJHtjbGllbnRJZH1gLCB7CiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIG5vUmVzb2x2ZUpzb246IHRydWUKICAgICAgfSk7CiAgICAgIHJldHVybiB7IGRhdGE6IG51bGwsIGVycm9yOiBudWxsIH07CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3IgfTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogUmVnZW5lcmF0ZXMgdGhlIHNlY3JldCBmb3IgYW4gT0F1dGggY2xpZW50LgogICAqIE9ubHkgcmVsZXZhbnQgd2hlbiB0aGUgT0F1dGggMi4xIHNlcnZlciBpcyBlbmFibGVkIGluIFN1cGFiYXNlIEF1dGguCiAgICoKICAgKiBUaGlzIGZ1bmN0aW9uIHNob3VsZCBvbmx5IGJlIGNhbGxlZCBvbiBhIHNlcnZlci4gTmV2ZXIgZXhwb3NlIHlvdXIgYHNlcnZpY2Vfcm9sZWAga2V5IGluIHRoZSBicm93c2VyLgogICAqLwogIGFzeW5jIF9yZWdlbmVyYXRlT0F1dGhDbGllbnRTZWNyZXQoY2xpZW50SWQpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGAke3RoaXMudXJsfS9hZG1pbi9vYXV0aC9jbGllbnRzLyR7Y2xpZW50SWR9L3JlZ2VuZXJhdGVfc2VjcmV0YCwgewogICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICB4Zm9ybTogKGNsaWVudCkgPT4gewogICAgICAgICAgcmV0dXJuIHsgZGF0YTogY2xpZW50LCBlcnJvcjogbnVsbCB9OwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3IgfTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9Cn07CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK2F1dGgtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvYXV0aC1qcy9kaXN0L21vZHVsZS9saWIvbG9jYWwtc3RvcmFnZS5qcwpmdW5jdGlvbiBtZW1vcnlMb2NhbFN0b3JhZ2VBZGFwdGVyKHN0b3JlID0ge30pIHsKICByZXR1cm4gewogICAgZ2V0SXRlbTogKGtleSkgPT4gewogICAgICByZXR1cm4gc3RvcmVba2V5XSB8fCBudWxsOwogICAgfSwKICAgIHNldEl0ZW06IChrZXksIHZhbHVlKSA9PiB7CiAgICAgIHN0b3JlW2tleV0gPSB2YWx1ZTsKICAgIH0sCiAgICByZW1vdmVJdGVtOiAoa2V5KSA9PiB7CiAgICAgIGRlbGV0ZSBzdG9yZVtrZXldOwogICAgfQogIH07Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrYXV0aC1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9hdXRoLWpzL2Rpc3QvbW9kdWxlL2xpYi9sb2Nrcy5qcwp2YXIgaW50ZXJuYWxzID0gewogIC8qKgogICAqIEBleHBlcmltZW50YWwKICAgKi8KICBkZWJ1ZzogISEoZ2xvYmFsVGhpcyAmJiBzdXBwb3J0c0xvY2FsU3RvcmFnZSgpICYmIGdsb2JhbFRoaXMubG9jYWxTdG9yYWdlICYmIGdsb2JhbFRoaXMubG9jYWxTdG9yYWdlLmdldEl0ZW0oInN1cGFiYXNlLmdvdHJ1ZS1qcy5sb2Nrcy5kZWJ1ZyIpID09PSAidHJ1ZSIpCn07CnZhciBMb2NrQWNxdWlyZVRpbWVvdXRFcnJvciA9IGNsYXNzIGV4dGVuZHMgRXJyb3IgewogIGNvbnN0cnVjdG9yKG1lc3NhZ2UpIHsKICAgIHN1cGVyKG1lc3NhZ2UpOwogICAgdGhpcy5pc0FjcXVpcmVUaW1lb3V0ID0gdHJ1ZTsKICB9Cn07CnZhciBOYXZpZ2F0b3JMb2NrQWNxdWlyZVRpbWVvdXRFcnJvciA9IGNsYXNzIGV4dGVuZHMgTG9ja0FjcXVpcmVUaW1lb3V0RXJyb3Igewp9Owphc3luYyBmdW5jdGlvbiBuYXZpZ2F0b3JMb2NrKG5hbWUsIGFjcXVpcmVUaW1lb3V0LCBmbikgewogIGlmIChpbnRlcm5hbHMuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKCJAc3VwYWJhc2UvZ290cnVlLWpzOiBuYXZpZ2F0b3JMb2NrOiBhY3F1aXJlIGxvY2siLCBuYW1lLCBhY3F1aXJlVGltZW91dCk7CiAgfQogIGNvbnN0IGFib3J0Q29udHJvbGxlciA9IG5ldyBnbG9iYWxUaGlzLkFib3J0Q29udHJvbGxlcigpOwogIGlmIChhY3F1aXJlVGltZW91dCA+IDApIHsKICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICBhYm9ydENvbnRyb2xsZXIuYWJvcnQoKTsKICAgICAgaWYgKGludGVybmFscy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKCJAc3VwYWJhc2UvZ290cnVlLWpzOiBuYXZpZ2F0b3JMb2NrIGFjcXVpcmUgdGltZWQgb3V0IiwgbmFtZSk7CiAgICAgIH0KICAgIH0sIGFjcXVpcmVUaW1lb3V0KTsKICB9CiAgYXdhaXQgUHJvbWlzZS5yZXNvbHZlKCk7CiAgdHJ5IHsKICAgIHJldHVybiBhd2FpdCBnbG9iYWxUaGlzLm5hdmlnYXRvci5sb2Nrcy5yZXF1ZXN0KG5hbWUsIGFjcXVpcmVUaW1lb3V0ID09PSAwID8gewogICAgICBtb2RlOiAiZXhjbHVzaXZlIiwKICAgICAgaWZBdmFpbGFibGU6IHRydWUKICAgIH0gOiB7CiAgICAgIG1vZGU6ICJleGNsdXNpdmUiLAogICAgICBzaWduYWw6IGFib3J0Q29udHJvbGxlci5zaWduYWwKICAgIH0sIGFzeW5jIChsb2NrKSA9PiB7CiAgICAgIGlmIChsb2NrKSB7CiAgICAgICAgaWYgKGludGVybmFscy5kZWJ1ZykgewogICAgICAgICAgY29uc29sZS5sb2coIkBzdXBhYmFzZS9nb3RydWUtanM6IG5hdmlnYXRvckxvY2s6IGFjcXVpcmVkIiwgbmFtZSwgbG9jay5uYW1lKTsKICAgICAgICB9CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHJldHVybiBhd2FpdCBmbigpOwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICBpZiAoaW50ZXJuYWxzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJAc3VwYWJhc2UvZ290cnVlLWpzOiBuYXZpZ2F0b3JMb2NrOiByZWxlYXNlZCIsIG5hbWUsIGxvY2submFtZSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChhY3F1aXJlVGltZW91dCA9PT0gMCkgewogICAgICAgICAgaWYgKGludGVybmFscy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZygiQHN1cGFiYXNlL2dvdHJ1ZS1qczogbmF2aWdhdG9yTG9jazogbm90IGltbWVkaWF0ZWx5IGF2YWlsYWJsZSIsIG5hbWUpOwogICAgICAgICAgfQogICAgICAgICAgdGhyb3cgbmV3IE5hdmlnYXRvckxvY2tBY3F1aXJlVGltZW91dEVycm9yKGBBY3F1aXJpbmcgYW4gZXhjbHVzaXZlIE5hdmlnYXRvciBMb2NrTWFuYWdlciBsb2NrICIke25hbWV9IiBpbW1lZGlhdGVseSBmYWlsZWRgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGludGVybmFscy5kZWJ1ZykgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdsb2JhbFRoaXMubmF2aWdhdG9yLmxvY2tzLnF1ZXJ5KCk7CiAgICAgICAgICAgICAgY29uc29sZS5sb2coIkBzdXBhYmFzZS9nb3RydWUtanM6IE5hdmlnYXRvciBMb2NrTWFuYWdlciBzdGF0ZSIsIEpTT04uc3RyaW5naWZ5KHJlc3VsdCwgbnVsbCwgIiAgIikpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJAc3VwYWJhc2UvZ290cnVlLWpzOiBFcnJvciB3aGVuIHF1ZXJ5aW5nIE5hdmlnYXRvciBMb2NrTWFuYWdlciBzdGF0ZSIsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBjb25zb2xlLndhcm4oIkBzdXBhYmFzZS9nb3RydWUtanM6IE5hdmlnYXRvciBMb2NrTWFuYWdlciByZXR1cm5lZCBhIG51bGwgbG9jayB3aGVuIHVzaW5nICNyZXF1ZXN0IHdpdGhvdXQgaWZBdmFpbGFibGUgc2V0IHRvIHRydWUsIGl0IGFwcGVhcnMgdGhpcyBicm93c2VyIGlzIG5vdCBmb2xsb3dpbmcgdGhlIExvY2tNYW5hZ2VyIHNwZWMgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0xvY2tNYW5hZ2VyL3JlcXVlc3QiKTsKICAgICAgICAgIHJldHVybiBhd2FpdCBmbigpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfSBjYXRjaCAoZSkgewogICAgaWYgKChlID09PSBudWxsIHx8IGUgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGUubmFtZSkgPT09ICJBYm9ydEVycm9yIikgewogICAgICB0aHJvdyBuZXcgTmF2aWdhdG9yTG9ja0FjcXVpcmVUaW1lb3V0RXJyb3IoYEFjcXVpcmluZyBhbiBleGNsdXNpdmUgTmF2aWdhdG9yIExvY2tNYW5hZ2VyIGxvY2sgIiR7bmFtZX0iIHRpbWVkIG91dCB3YWl0aW5nICR7YWNxdWlyZVRpbWVvdXR9bXNgKTsKICAgIH0KICAgIHRocm93IGU7CiAgfQp9CgovLyBub2RlX21vZHVsZXMvLnBucG0vQHN1cGFiYXNlK2F1dGgtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2UvYXV0aC1qcy9kaXN0L21vZHVsZS9saWIvcG9seWZpbGxzLmpzCmZ1bmN0aW9uIHBvbHlmaWxsR2xvYmFsVGhpcygpIHsKICBpZiAodHlwZW9mIGdsb2JhbFRoaXMgPT09ICJvYmplY3QiKQogICAgcmV0dXJuOwogIHRyeSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoT2JqZWN0LnByb3RvdHlwZSwgIl9fbWFnaWNfXyIsIHsKICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfSwKICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICB9KTsKICAgIF9fbWFnaWNfXy5nbG9iYWxUaGlzID0gX19tYWdpY19fOwogICAgZGVsZXRlIE9iamVjdC5wcm90b3R5cGUuX19tYWdpY19fOwogIH0gY2F0Y2ggKGUpIHsKICAgIGlmICh0eXBlb2Ygc2VsZiAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgc2VsZi5nbG9iYWxUaGlzID0gc2VsZjsKICAgIH0KICB9Cn0KCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2UrYXV0aC1qc0AyLjk3LjAvbm9kZV9tb2R1bGVzL0BzdXBhYmFzZS9hdXRoLWpzL2Rpc3QvbW9kdWxlL2xpYi93ZWIzL2V0aGVyZXVtLmpzCmZ1bmN0aW9uIGdldEFkZHJlc3MoYWRkcmVzcykgewogIGlmICghL14weFthLWZBLUYwLTldezQwfSQvLnRlc3QoYWRkcmVzcykpIHsKICAgIHRocm93IG5ldyBFcnJvcihgQHN1cGFiYXNlL2F1dGgtanM6IEFkZHJlc3MgIiR7YWRkcmVzc30iIGlzIGludmFsaWQuYCk7CiAgfQogIHJldHVybiBhZGRyZXNzLnRvTG93ZXJDYXNlKCk7Cn0KZnVuY3Rpb24gZnJvbUhleChoZXgyKSB7CiAgcmV0dXJuIHBhcnNlSW50KGhleDIsIDE2KTsKfQpmdW5jdGlvbiB0b0hleCh2YWx1ZSkgewogIGNvbnN0IGJ5dGVzID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKHZhbHVlKTsKICBjb25zdCBoZXgyID0gQXJyYXkuZnJvbShieXRlcywgKGJ5dGUpID0+IGJ5dGUudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDIsICIwIikpLmpvaW4oIiIpOwogIHJldHVybiAiMHgiICsgaGV4MjsKfQpmdW5jdGlvbiBjcmVhdGVTaXdlTWVzc2FnZShwYXJhbWV0ZXJzKSB7CiAgdmFyIF9hOwogIGNvbnN0IHsgY2hhaW5JZCwgZG9tYWluLCBleHBpcmF0aW9uVGltZSwgaXNzdWVkQXQgPSAvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSwgbm9uY2UsIG5vdEJlZm9yZSwgcmVxdWVzdElkLCByZXNvdXJjZXMsIHNjaGVtZSwgdXJpLCB2ZXJzaW9uOiB2ZXJzaW9uNiB9ID0gcGFyYW1ldGVyczsKICB7CiAgICBpZiAoIU51bWJlci5pc0ludGVnZXIoY2hhaW5JZCkpCiAgICAgIHRocm93IG5ldyBFcnJvcihgQHN1cGFiYXNlL2F1dGgtanM6IEludmFsaWQgU0lXRSBtZXNzYWdlIGZpZWxkICJjaGFpbklkIi4gQ2hhaW4gSUQgbXVzdCBiZSBhIEVJUC0xNTUgY2hhaW4gSUQuIFByb3ZpZGVkIHZhbHVlOiAke2NoYWluSWR9YCk7CiAgICBpZiAoIWRvbWFpbikKICAgICAgdGhyb3cgbmV3IEVycm9yKGBAc3VwYWJhc2UvYXV0aC1qczogSW52YWxpZCBTSVdFIG1lc3NhZ2UgZmllbGQgImRvbWFpbiIuIERvbWFpbiBtdXN0IGJlIHByb3ZpZGVkLmApOwogICAgaWYgKG5vbmNlICYmIG5vbmNlLmxlbmd0aCA8IDgpCiAgICAgIHRocm93IG5ldyBFcnJvcihgQHN1cGFiYXNlL2F1dGgtanM6IEludmFsaWQgU0lXRSBtZXNzYWdlIGZpZWxkICJub25jZSIuIE5vbmNlIG11c3QgYmUgYXQgbGVhc3QgOCBjaGFyYWN0ZXJzLiBQcm92aWRlZCB2YWx1ZTogJHtub25jZX1gKTsKICAgIGlmICghdXJpKQogICAgICB0aHJvdyBuZXcgRXJyb3IoYEBzdXBhYmFzZS9hdXRoLWpzOiBJbnZhbGlkIFNJV0UgbWVzc2FnZSBmaWVsZCAidXJpIi4gVVJJIG11c3QgYmUgcHJvdmlkZWQuYCk7CiAgICBpZiAodmVyc2lvbjYgIT09ICIxIikKICAgICAgdGhyb3cgbmV3IEVycm9yKGBAc3VwYWJhc2UvYXV0aC1qczogSW52YWxpZCBTSVdFIG1lc3NhZ2UgZmllbGQgInZlcnNpb24iLiBWZXJzaW9uIG11c3QgYmUgJzEnLiBQcm92aWRlZCB2YWx1ZTogJHt2ZXJzaW9uNn1gKTsKICAgIGlmICgoX2EgPSBwYXJhbWV0ZXJzLnN0YXRlbWVudCkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmluY2x1ZGVzKCJcbiIpKQogICAgICB0aHJvdyBuZXcgRXJyb3IoYEBzdXBhYmFzZS9hdXRoLWpzOiBJbnZhbGlkIFNJV0UgbWVzc2FnZSBmaWVsZCAic3RhdGVtZW50Ii4gU3RhdGVtZW50IG11c3Qgbm90IGluY2x1ZGUgJ1xcbicuIFByb3ZpZGVkIHZhbHVlOiAke3BhcmFtZXRlcnMuc3RhdGVtZW50fWApOwogIH0KICBjb25zdCBhZGRyZXNzID0gZ2V0QWRkcmVzcyhwYXJhbWV0ZXJzLmFkZHJlc3MpOwogIGNvbnN0IG9yaWdpbiA9IHNjaGVtZSA/IGAke3NjaGVtZX06Ly8ke2RvbWFpbn1gIDogZG9tYWluOwogIGNvbnN0IHN0YXRlbWVudCA9IHBhcmFtZXRlcnMuc3RhdGVtZW50ID8gYCR7cGFyYW1ldGVycy5zdGF0ZW1lbnR9CmAgOiAiIjsKICBjb25zdCBwcmVmaXggPSBgJHtvcmlnaW59IHdhbnRzIHlvdSB0byBzaWduIGluIHdpdGggeW91ciBFdGhlcmV1bSBhY2NvdW50Ogoke2FkZHJlc3N9Cgoke3N0YXRlbWVudH1gOwogIGxldCBzdWZmaXgyID0gYFVSSTogJHt1cml9ClZlcnNpb246ICR7dmVyc2lvbjZ9CkNoYWluIElEOiAke2NoYWluSWR9JHtub25jZSA/IGAKTm9uY2U6ICR7bm9uY2V9YCA6ICIifQpJc3N1ZWQgQXQ6ICR7aXNzdWVkQXQudG9JU09TdHJpbmcoKX1gOwogIGlmIChleHBpcmF0aW9uVGltZSkKICAgIHN1ZmZpeDIgKz0gYApFeHBpcmF0aW9uIFRpbWU6ICR7ZXhwaXJhdGlvblRpbWUudG9JU09TdHJpbmcoKX1gOwogIGlmIChub3RCZWZvcmUpCiAgICBzdWZmaXgyICs9IGAKTm90IEJlZm9yZTogJHtub3RCZWZvcmUudG9JU09TdHJpbmcoKX1gOwogIGlmIChyZXF1ZXN0SWQpCiAgICBzdWZmaXgyICs9IGAKUmVxdWVzdCBJRDogJHtyZXF1ZXN0SWR9YDsKICBpZiAocmVzb3VyY2VzKSB7CiAgICBsZXQgY29udGVudCA9ICJcblJlc291cmNlczoiOwogICAgZm9yIChjb25zdCByZXNvdXJjZSBvZiByZXNvdXJjZXMpIHsKICAgICAgaWYgKCFyZXNvdXJjZSB8fCB0eXBlb2YgcmVzb3VyY2UgIT09ICJzdHJpbmciKQogICAgICAgIHRocm93IG5ldyBFcnJvcihgQHN1cGFiYXNlL2F1dGgtanM6IEludmFsaWQgU0lXRSBtZXNzYWdlIGZpZWxkICJyZXNvdXJjZXMiLiBFdmVyeSByZXNvdXJjZSBtdXN0IGJlIGEgdmFsaWQgc3RyaW5nLiBQcm92aWRlZCB2YWx1ZTogJHtyZXNvdXJjZX1gKTsKICAgICAgY29udGVudCArPSBgCi0gJHtyZXNvdXJjZX1gOwogICAgfQogICAgc3VmZml4MiArPSBjb250ZW50OwogIH0KICByZXR1cm4gYCR7cHJlZml4fQoke3N1ZmZpeDJ9YDsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZSthdXRoLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL2F1dGgtanMvZGlzdC9tb2R1bGUvbGliL3dlYmF1dGhuLmVycm9ycy5qcwp2YXIgV2ViQXV0aG5FcnJvciA9IGNsYXNzIGV4dGVuZHMgRXJyb3IgewogIGNvbnN0cnVjdG9yKHsgbWVzc2FnZSwgY29kZSwgY2F1c2UsIG5hbWUgfSkgewogICAgdmFyIF9hOwogICAgc3VwZXIobWVzc2FnZSwgeyBjYXVzZSB9KTsKICAgIHRoaXMuX19pc1dlYkF1dGhuRXJyb3IgPSB0cnVlOwogICAgdGhpcy5uYW1lID0gKF9hID0gbmFtZSAhPT0gbnVsbCAmJiBuYW1lICE9PSB2b2lkIDAgPyBuYW1lIDogY2F1c2UgaW5zdGFuY2VvZiBFcnJvciA/IGNhdXNlLm5hbWUgOiB2b2lkIDApICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6ICJVbmtub3duIEVycm9yIjsKICAgIHRoaXMuY29kZSA9IGNvZGU7CiAgfQp9Owp2YXIgV2ViQXV0aG5Vbmtub3duRXJyb3IgPSBjbGFzcyBleHRlbmRzIFdlYkF1dGhuRXJyb3IgewogIGNvbnN0cnVjdG9yKG1lc3NhZ2UsIG9yaWdpbmFsRXJyb3IpIHsKICAgIHN1cGVyKHsKICAgICAgY29kZTogIkVSUk9SX1BBU1NUSFJPVUdIX1NFRV9DQVVTRV9QUk9QRVJUWSIsCiAgICAgIGNhdXNlOiBvcmlnaW5hbEVycm9yLAogICAgICBtZXNzYWdlCiAgICB9KTsKICAgIHRoaXMubmFtZSA9ICJXZWJBdXRoblVua25vd25FcnJvciI7CiAgICB0aGlzLm9yaWdpbmFsRXJyb3IgPSBvcmlnaW5hbEVycm9yOwogIH0KfTsKZnVuY3Rpb24gaWRlbnRpZnlSZWdpc3RyYXRpb25FcnJvcih7IGVycm9yLCBvcHRpb25zIH0pIHsKICB2YXIgX2EsIF9iLCBfYzsKICBjb25zdCB7IHB1YmxpY0tleSB9ID0gb3B0aW9uczsKICBpZiAoIXB1YmxpY0tleSkgewogICAgdGhyb3cgRXJyb3IoIm9wdGlvbnMgd2FzIG1pc3NpbmcgcmVxdWlyZWQgcHVibGljS2V5IHByb3BlcnR5Iik7CiAgfQogIGlmIChlcnJvci5uYW1lID09PSAiQWJvcnRFcnJvciIpIHsKICAgIGlmIChvcHRpb25zLnNpZ25hbCBpbnN0YW5jZW9mIEFib3J0U2lnbmFsKSB7CiAgICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgICAgbWVzc2FnZTogIlJlZ2lzdHJhdGlvbiBjZXJlbW9ueSB3YXMgc2VudCBhbiBhYm9ydCBzaWduYWwiLAogICAgICAgIGNvZGU6ICJFUlJPUl9DRVJFTU9OWV9BQk9SVEVEIiwKICAgICAgICBjYXVzZTogZXJyb3IKICAgICAgfSk7CiAgICB9CiAgfSBlbHNlIGlmIChlcnJvci5uYW1lID09PSAiQ29uc3RyYWludEVycm9yIikgewogICAgaWYgKCgoX2EgPSBwdWJsaWNLZXkuYXV0aGVudGljYXRvclNlbGVjdGlvbikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlcXVpcmVSZXNpZGVudEtleSkgPT09IHRydWUpIHsKICAgICAgcmV0dXJuIG5ldyBXZWJBdXRobkVycm9yKHsKICAgICAgICBtZXNzYWdlOiAiRGlzY292ZXJhYmxlIGNyZWRlbnRpYWxzIHdlcmUgcmVxdWlyZWQgYnV0IG5vIGF2YWlsYWJsZSBhdXRoZW50aWNhdG9yIHN1cHBvcnRlZCBpdCIsCiAgICAgICAgY29kZTogIkVSUk9SX0FVVEhFTlRJQ0FUT1JfTUlTU0lOR19ESVNDT1ZFUkFCTEVfQ1JFREVOVElBTF9TVVBQT1JUIiwKICAgICAgICBjYXVzZTogZXJyb3IKICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKAogICAgICAvLyBAdHMtaWdub3JlOiBgbWVkaWF0aW9uYCBkb2Vzbid0IHlldCBleGlzdCBvbiBDcmVkZW50aWFsQ3JlYXRpb25PcHRpb25zIGJ1dCBpdCdzIHBvc3NpYmxlIGFzIG9mIFNlcHQgMjAyNAogICAgICBvcHRpb25zLm1lZGlhdGlvbiA9PT0gImNvbmRpdGlvbmFsIiAmJiAoKF9iID0gcHVibGljS2V5LmF1dGhlbnRpY2F0b3JTZWxlY3Rpb24pID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi51c2VyVmVyaWZpY2F0aW9uKSA9PT0gInJlcXVpcmVkIgogICAgKSB7CiAgICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgICAgbWVzc2FnZTogIlVzZXIgdmVyaWZpY2F0aW9uIHdhcyByZXF1aXJlZCBkdXJpbmcgYXV0b21hdGljIHJlZ2lzdHJhdGlvbiBidXQgaXQgY291bGQgbm90IGJlIHBlcmZvcm1lZCIsCiAgICAgICAgY29kZTogIkVSUk9SX0FVVE9fUkVHSVNURVJfVVNFUl9WRVJJRklDQVRJT05fRkFJTFVSRSIsCiAgICAgICAgY2F1c2U6IGVycm9yCiAgICAgIH0pOwogICAgfSBlbHNlIGlmICgoKF9jID0gcHVibGljS2V5LmF1dGhlbnRpY2F0b3JTZWxlY3Rpb24pID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy51c2VyVmVyaWZpY2F0aW9uKSA9PT0gInJlcXVpcmVkIikgewogICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgIG1lc3NhZ2U6ICJVc2VyIHZlcmlmaWNhdGlvbiB3YXMgcmVxdWlyZWQgYnV0IG5vIGF2YWlsYWJsZSBhdXRoZW50aWNhdG9yIHN1cHBvcnRlZCBpdCIsCiAgICAgICAgY29kZTogIkVSUk9SX0FVVEhFTlRJQ0FUT1JfTUlTU0lOR19VU0VSX1ZFUklGSUNBVElPTl9TVVBQT1JUIiwKICAgICAgICBjYXVzZTogZXJyb3IKICAgICAgfSk7CiAgICB9CiAgfSBlbHNlIGlmIChlcnJvci5uYW1lID09PSAiSW52YWxpZFN0YXRlRXJyb3IiKSB7CiAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICBtZXNzYWdlOiAiVGhlIGF1dGhlbnRpY2F0b3Igd2FzIHByZXZpb3VzbHkgcmVnaXN0ZXJlZCIsCiAgICAgIGNvZGU6ICJFUlJPUl9BVVRIRU5USUNBVE9SX1BSRVZJT1VTTFlfUkVHSVNURVJFRCIsCiAgICAgIGNhdXNlOiBlcnJvcgogICAgfSk7CiAgfSBlbHNlIGlmIChlcnJvci5uYW1lID09PSAiTm90QWxsb3dlZEVycm9yIikgewogICAgcmV0dXJuIG5ldyBXZWJBdXRobkVycm9yKHsKICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZSwKICAgICAgY29kZTogIkVSUk9SX1BBU1NUSFJPVUdIX1NFRV9DQVVTRV9QUk9QRVJUWSIsCiAgICAgIGNhdXNlOiBlcnJvcgogICAgfSk7CiAgfSBlbHNlIGlmIChlcnJvci5uYW1lID09PSAiTm90U3VwcG9ydGVkRXJyb3IiKSB7CiAgICBjb25zdCB2YWxpZFB1YktleUNyZWRQYXJhbXMgPSBwdWJsaWNLZXkucHViS2V5Q3JlZFBhcmFtcy5maWx0ZXIoKHBhcmFtKSA9PiBwYXJhbS50eXBlID09PSAicHVibGljLWtleSIpOwogICAgaWYgKHZhbGlkUHViS2V5Q3JlZFBhcmFtcy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIG5ldyBXZWJBdXRobkVycm9yKHsKICAgICAgICBtZXNzYWdlOiAnTm8gZW50cnkgaW4gcHViS2V5Q3JlZFBhcmFtcyB3YXMgb2YgdHlwZSAicHVibGljLWtleSInLAogICAgICAgIGNvZGU6ICJFUlJPUl9NQUxGT1JNRURfUFVCS0VZQ1JFRFBBUkFNUyIsCiAgICAgICAgY2F1c2U6IGVycm9yCiAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIG5ldyBXZWJBdXRobkVycm9yKHsKICAgICAgbWVzc2FnZTogIk5vIGF2YWlsYWJsZSBhdXRoZW50aWNhdG9yIHN1cHBvcnRlZCBhbnkgb2YgdGhlIHNwZWNpZmllZCBwdWJLZXlDcmVkUGFyYW1zIGFsZ29yaXRobXMiLAogICAgICBjb2RlOiAiRVJST1JfQVVUSEVOVElDQVRPUl9OT19TVVBQT1JURURfUFVCS0VZQ1JFRFBBUkFNU19BTEciLAogICAgICBjYXVzZTogZXJyb3IKICAgIH0pOwogIH0gZWxzZSBpZiAoZXJyb3IubmFtZSA9PT0gIlNlY3VyaXR5RXJyb3IiKSB7CiAgICBjb25zdCBlZmZlY3RpdmVEb21haW4gPSB3aW5kb3cubG9jYXRpb24uaG9zdG5hbWU7CiAgICBpZiAoIWlzVmFsaWREb21haW4oZWZmZWN0aXZlRG9tYWluKSkgewogICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgIG1lc3NhZ2U6IGAke3dpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZX0gaXMgYW4gaW52YWxpZCBkb21haW5gLAogICAgICAgIGNvZGU6ICJFUlJPUl9JTlZBTElEX0RPTUFJTiIsCiAgICAgICAgY2F1c2U6IGVycm9yCiAgICAgIH0pOwogICAgfSBlbHNlIGlmIChwdWJsaWNLZXkucnAuaWQgIT09IGVmZmVjdGl2ZURvbWFpbikgewogICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgIG1lc3NhZ2U6IGBUaGUgUlAgSUQgIiR7cHVibGljS2V5LnJwLmlkfSIgaXMgaW52YWxpZCBmb3IgdGhpcyBkb21haW5gLAogICAgICAgIGNvZGU6ICJFUlJPUl9JTlZBTElEX1JQX0lEIiwKICAgICAgICBjYXVzZTogZXJyb3IKICAgICAgfSk7CiAgICB9CiAgfSBlbHNlIGlmIChlcnJvci5uYW1lID09PSAiVHlwZUVycm9yIikgewogICAgaWYgKHB1YmxpY0tleS51c2VyLmlkLmJ5dGVMZW5ndGggPCAxIHx8IHB1YmxpY0tleS51c2VyLmlkLmJ5dGVMZW5ndGggPiA2NCkgewogICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgIG1lc3NhZ2U6ICJVc2VyIElEIHdhcyBub3QgYmV0d2VlbiAxIGFuZCA2NCBjaGFyYWN0ZXJzIiwKICAgICAgICBjb2RlOiAiRVJST1JfSU5WQUxJRF9VU0VSX0lEX0xFTkdUSCIsCiAgICAgICAgY2F1c2U6IGVycm9yCiAgICAgIH0pOwogICAgfQogIH0gZWxzZSBpZiAoZXJyb3IubmFtZSA9PT0gIlVua25vd25FcnJvciIpIHsKICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgIG1lc3NhZ2U6ICJUaGUgYXV0aGVudGljYXRvciB3YXMgdW5hYmxlIHRvIHByb2Nlc3MgdGhlIHNwZWNpZmllZCBvcHRpb25zLCBvciBjb3VsZCBub3QgY3JlYXRlIGEgbmV3IGNyZWRlbnRpYWwiLAogICAgICBjb2RlOiAiRVJST1JfQVVUSEVOVElDQVRPUl9HRU5FUkFMX0VSUk9SIiwKICAgICAgY2F1c2U6IGVycm9yCiAgICB9KTsKICB9CiAgcmV0dXJuIG5ldyBXZWJBdXRobkVycm9yKHsKICAgIG1lc3NhZ2U6ICJhIE5vbi1XZWJhdXRobiByZWxhdGVkIGVycm9yIGhhcyBvY2N1cnJlZCIsCiAgICBjb2RlOiAiRVJST1JfUEFTU1RIUk9VR0hfU0VFX0NBVVNFX1BST1BFUlRZIiwKICAgIGNhdXNlOiBlcnJvcgogIH0pOwp9CmZ1bmN0aW9uIGlkZW50aWZ5QXV0aGVudGljYXRpb25FcnJvcih7IGVycm9yLCBvcHRpb25zIH0pIHsKICBjb25zdCB7IHB1YmxpY0tleSB9ID0gb3B0aW9uczsKICBpZiAoIXB1YmxpY0tleSkgewogICAgdGhyb3cgRXJyb3IoIm9wdGlvbnMgd2FzIG1pc3NpbmcgcmVxdWlyZWQgcHVibGljS2V5IHByb3BlcnR5Iik7CiAgfQogIGlmIChlcnJvci5uYW1lID09PSAiQWJvcnRFcnJvciIpIHsKICAgIGlmIChvcHRpb25zLnNpZ25hbCBpbnN0YW5jZW9mIEFib3J0U2lnbmFsKSB7CiAgICAgIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICAgICAgbWVzc2FnZTogIkF1dGhlbnRpY2F0aW9uIGNlcmVtb255IHdhcyBzZW50IGFuIGFib3J0IHNpZ25hbCIsCiAgICAgICAgY29kZTogIkVSUk9SX0NFUkVNT05ZX0FCT1JURUQiLAogICAgICAgIGNhdXNlOiBlcnJvcgogICAgICB9KTsKICAgIH0KICB9IGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICJOb3RBbGxvd2VkRXJyb3IiKSB7CiAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLAogICAgICBjb2RlOiAiRVJST1JfUEFTU1RIUk9VR0hfU0VFX0NBVVNFX1BST1BFUlRZIiwKICAgICAgY2F1c2U6IGVycm9yCiAgICB9KTsKICB9IGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICJTZWN1cml0eUVycm9yIikgewogICAgY29uc3QgZWZmZWN0aXZlRG9tYWluID0gd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lOwogICAgaWYgKCFpc1ZhbGlkRG9tYWluKGVmZmVjdGl2ZURvbWFpbikpIHsKICAgICAgcmV0dXJuIG5ldyBXZWJBdXRobkVycm9yKHsKICAgICAgICBtZXNzYWdlOiBgJHt3aW5kb3cubG9jYXRpb24uaG9zdG5hbWV9IGlzIGFuIGludmFsaWQgZG9tYWluYCwKICAgICAgICBjb2RlOiAiRVJST1JfSU5WQUxJRF9ET01BSU4iLAogICAgICAgIGNhdXNlOiBlcnJvcgogICAgICB9KTsKICAgIH0gZWxzZSBpZiAocHVibGljS2V5LnJwSWQgIT09IGVmZmVjdGl2ZURvbWFpbikgewogICAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICAgIG1lc3NhZ2U6IGBUaGUgUlAgSUQgIiR7cHVibGljS2V5LnJwSWR9IiBpcyBpbnZhbGlkIGZvciB0aGlzIGRvbWFpbmAsCiAgICAgICAgY29kZTogIkVSUk9SX0lOVkFMSURfUlBfSUQiLAogICAgICAgIGNhdXNlOiBlcnJvcgogICAgICB9KTsKICAgIH0KICB9IGVsc2UgaWYgKGVycm9yLm5hbWUgPT09ICJVbmtub3duRXJyb3IiKSB7CiAgICByZXR1cm4gbmV3IFdlYkF1dGhuRXJyb3IoewogICAgICBtZXNzYWdlOiAiVGhlIGF1dGhlbnRpY2F0b3Igd2FzIHVuYWJsZSB0byBwcm9jZXNzIHRoZSBzcGVjaWZpZWQgb3B0aW9ucywgb3IgY291bGQgbm90IGNyZWF0ZSBhIG5ldyBhc3NlcnRpb24gc2lnbmF0dXJlIiwKICAgICAgY29kZTogIkVSUk9SX0FVVEhFTlRJQ0FUT1JfR0VORVJBTF9FUlJPUiIsCiAgICAgIGNhdXNlOiBlcnJvcgogICAgfSk7CiAgfQogIHJldHVybiBuZXcgV2ViQXV0aG5FcnJvcih7CiAgICBtZXNzYWdlOiAiYSBOb24tV2ViYXV0aG4gcmVsYXRlZCBlcnJvciBoYXMgb2NjdXJyZWQiLAogICAgY29kZTogIkVSUk9SX1BBU1NUSFJPVUdIX1NFRV9DQVVTRV9QUk9QRVJUWSIsCiAgICBjYXVzZTogZXJyb3IKICB9KTsKfQoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZSthdXRoLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL2F1dGgtanMvZGlzdC9tb2R1bGUvbGliL3dlYmF1dGhuLmpzCnZhciBXZWJBdXRobkFib3J0U2VydmljZSA9IGNsYXNzIHsKICAvKioKICAgKiBDcmVhdGUgYW4gYWJvcnQgc2lnbmFsIGZvciBhIG5ldyBXZWJBdXRobiBvcGVyYXRpb24uCiAgICogQXV0b21hdGljYWxseSBjYW5jZWxzIGFueSBleGlzdGluZyBvcGVyYXRpb24uCiAgICoKICAgKiBAcmV0dXJucyB7QWJvcnRTaWduYWx9IFNpZ25hbCB0byBwYXNzIHRvIG5hdmlnYXRvci5jcmVkZW50aWFscy5jcmVhdGUoKSBvciAuZ2V0KCkKICAgKiBAc2VlIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvQWJvcnRTaWduYWwgTUROIC0gQWJvcnRTaWduYWx9CiAgICovCiAgY3JlYXRlTmV3QWJvcnRTaWduYWwoKSB7CiAgICBpZiAodGhpcy5jb250cm9sbGVyKSB7CiAgICAgIGNvbnN0IGFib3J0RXJyb3IgPSBuZXcgRXJyb3IoIkNhbmNlbGxpbmcgZXhpc3RpbmcgV2ViQXV0aG4gQVBJIGNhbGwgZm9yIG5ldyBvbmUiKTsKICAgICAgYWJvcnRFcnJvci5uYW1lID0gIkFib3J0RXJyb3IiOwogICAgICB0aGlzLmNvbnRyb2xsZXIuYWJvcnQoYWJvcnRFcnJvcik7CiAgICB9CiAgICBjb25zdCBuZXdDb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpOwogICAgdGhpcy5jb250cm9sbGVyID0gbmV3Q29udHJvbGxlcjsKICAgIHJldHVybiBuZXdDb250cm9sbGVyLnNpZ25hbDsKICB9CiAgLyoqCiAgICogTWFudWFsbHkgY2FuY2VsIHRoZSBjdXJyZW50IFdlYkF1dGhuIG9wZXJhdGlvbi4KICAgKiBVc2VmdWwgZm9yIGNsZWFuaW5nIHVwIHdoZW4gdXNlciBjYW5jZWxzIG9yIG5hdmlnYXRlcyBhd2F5LgogICAqCiAgICogQHNlZSB7QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0Fib3J0Q29udHJvbGxlci9hYm9ydCBNRE4gLSBBYm9ydENvbnRyb2xsZXIuYWJvcnR9CiAgICovCiAgY2FuY2VsQ2VyZW1vbnkoKSB7CiAgICBpZiAodGhpcy5jb250cm9sbGVyKSB7CiAgICAgIGNvbnN0IGFib3J0RXJyb3IgPSBuZXcgRXJyb3IoIk1hbnVhbGx5IGNhbmNlbGxpbmcgZXhpc3RpbmcgV2ViQXV0aG4gQVBJIGNhbGwiKTsKICAgICAgYWJvcnRFcnJvci5uYW1lID0gIkFib3J0RXJyb3IiOwogICAgICB0aGlzLmNvbnRyb2xsZXIuYWJvcnQoYWJvcnRFcnJvcik7CiAgICAgIHRoaXMuY29udHJvbGxlciA9IHZvaWQgMDsKICAgIH0KICB9Cn07CnZhciB3ZWJBdXRobkFib3J0U2VydmljZSA9IG5ldyBXZWJBdXRobkFib3J0U2VydmljZSgpOwpmdW5jdGlvbiBkZXNlcmlhbGl6ZUNyZWRlbnRpYWxDcmVhdGlvbk9wdGlvbnMob3B0aW9ucykgewogIGlmICghb3B0aW9ucykgewogICAgdGhyb3cgbmV3IEVycm9yKCJDcmVkZW50aWFsIGNyZWF0aW9uIG9wdGlvbnMgYXJlIHJlcXVpcmVkIik7CiAgfQogIGlmICh0eXBlb2YgUHVibGljS2V5Q3JlZGVudGlhbCAhPT0gInVuZGVmaW5lZCIgJiYgInBhcnNlQ3JlYXRpb25PcHRpb25zRnJvbUpTT04iIGluIFB1YmxpY0tleUNyZWRlbnRpYWwgJiYgdHlwZW9mIFB1YmxpY0tleUNyZWRlbnRpYWwucGFyc2VDcmVhdGlvbk9wdGlvbnNGcm9tSlNPTiA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIFB1YmxpY0tleUNyZWRlbnRpYWwucGFyc2VDcmVhdGlvbk9wdGlvbnNGcm9tSlNPTigKICAgICAgLyoqIHdlIGFzc2VydCB0aGUgb3B0aW9ucyBoZXJlIGFzIHR5cGVzY3JpcHQgc3RpbGwgZG9lc24ndCBrbm93IGFib3V0IGZ1dHVyZSB3ZWJhdXRobiB0eXBlcyAqLwogICAgICBvcHRpb25zCiAgICApOwogIH0KICBjb25zdCB7IGNoYWxsZW5nZTogY2hhbGxlbmdlU3RyLCB1c2VyOiB1c2VyT3B0cywgZXhjbHVkZUNyZWRlbnRpYWxzIH0gPSBvcHRpb25zLCByZXN0T3B0aW9ucyA9IF9fcmVzdCgKICAgIG9wdGlvbnMsCiAgICBbImNoYWxsZW5nZSIsICJ1c2VyIiwgImV4Y2x1ZGVDcmVkZW50aWFscyJdCiAgKTsKICBjb25zdCBjaGFsbGVuZ2UgPSBiYXNlNjRVcmxUb1VpbnQ4QXJyYXkoY2hhbGxlbmdlU3RyKS5idWZmZXI7CiAgY29uc3QgdXNlciA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgdXNlck9wdHMpLCB7IGlkOiBiYXNlNjRVcmxUb1VpbnQ4QXJyYXkodXNlck9wdHMuaWQpLmJ1ZmZlciB9KTsKICBjb25zdCByZXN1bHQgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHJlc3RPcHRpb25zKSwgewogICAgY2hhbGxlbmdlLAogICAgdXNlcgogIH0pOwogIGlmIChleGNsdWRlQ3JlZGVudGlhbHMgJiYgZXhjbHVkZUNyZWRlbnRpYWxzLmxlbmd0aCA+IDApIHsKICAgIHJlc3VsdC5leGNsdWRlQ3JlZGVudGlhbHMgPSBuZXcgQXJyYXkoZXhjbHVkZUNyZWRlbnRpYWxzLmxlbmd0aCk7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGV4Y2x1ZGVDcmVkZW50aWFscy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBjcmVkID0gZXhjbHVkZUNyZWRlbnRpYWxzW2ldOwogICAgICByZXN1bHQuZXhjbHVkZUNyZWRlbnRpYWxzW2ldID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBjcmVkKSwgewogICAgICAgIGlkOiBiYXNlNjRVcmxUb1VpbnQ4QXJyYXkoY3JlZC5pZCkuYnVmZmVyLAogICAgICAgIHR5cGU6IGNyZWQudHlwZSB8fCAicHVibGljLWtleSIsCiAgICAgICAgLy8gQ2FzdCB0cmFuc3BvcnRzIHRvIGhhbmRsZSBmdXR1cmUgdHJhbnNwb3J0IHR5cGVzIGxpa2UgImNhYmxlIgogICAgICAgIHRyYW5zcG9ydHM6IGNyZWQudHJhbnNwb3J0cwogICAgICB9KTsKICAgIH0KICB9CiAgcmV0dXJuIHJlc3VsdDsKfQpmdW5jdGlvbiBkZXNlcmlhbGl6ZUNyZWRlbnRpYWxSZXF1ZXN0T3B0aW9ucyhvcHRpb25zKSB7CiAgaWYgKCFvcHRpb25zKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkNyZWRlbnRpYWwgcmVxdWVzdCBvcHRpb25zIGFyZSByZXF1aXJlZCIpOwogIH0KICBpZiAodHlwZW9mIFB1YmxpY0tleUNyZWRlbnRpYWwgIT09ICJ1bmRlZmluZWQiICYmICJwYXJzZVJlcXVlc3RPcHRpb25zRnJvbUpTT04iIGluIFB1YmxpY0tleUNyZWRlbnRpYWwgJiYgdHlwZW9mIFB1YmxpY0tleUNyZWRlbnRpYWwucGFyc2VSZXF1ZXN0T3B0aW9uc0Zyb21KU09OID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gUHVibGljS2V5Q3JlZGVudGlhbC5wYXJzZVJlcXVlc3RPcHRpb25zRnJvbUpTT04ob3B0aW9ucyk7CiAgfQogIGNvbnN0IHsgY2hhbGxlbmdlOiBjaGFsbGVuZ2VTdHIsIGFsbG93Q3JlZGVudGlhbHMgfSA9IG9wdGlvbnMsIHJlc3RPcHRpb25zID0gX19yZXN0KAogICAgb3B0aW9ucywKICAgIFsiY2hhbGxlbmdlIiwgImFsbG93Q3JlZGVudGlhbHMiXQogICk7CiAgY29uc3QgY2hhbGxlbmdlID0gYmFzZTY0VXJsVG9VaW50OEFycmF5KGNoYWxsZW5nZVN0cikuYnVmZmVyOwogIGNvbnN0IHJlc3VsdCA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgcmVzdE9wdGlvbnMpLCB7IGNoYWxsZW5nZSB9KTsKICBpZiAoYWxsb3dDcmVkZW50aWFscyAmJiBhbGxvd0NyZWRlbnRpYWxzLmxlbmd0aCA+IDApIHsKICAgIHJlc3VsdC5hbGxvd0NyZWRlbnRpYWxzID0gbmV3IEFycmF5KGFsbG93Q3JlZGVudGlhbHMubGVuZ3RoKTsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYWxsb3dDcmVkZW50aWFscy5sZW5ndGg7IGkrKykgewogICAgICBjb25zdCBjcmVkID0gYWxsb3dDcmVkZW50aWFsc1tpXTsKICAgICAgcmVzdWx0LmFsbG93Q3JlZGVudGlhbHNbaV0gPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIGNyZWQpLCB7CiAgICAgICAgaWQ6IGJhc2U2NFVybFRvVWludDhBcnJheShjcmVkLmlkKS5idWZmZXIsCiAgICAgICAgdHlwZTogY3JlZC50eXBlIHx8ICJwdWJsaWMta2V5IiwKICAgICAgICAvLyBDYXN0IHRyYW5zcG9ydHMgdG8gaGFuZGxlIGZ1dHVyZSB0cmFuc3BvcnQgdHlwZXMgbGlrZSAiY2FibGUiCiAgICAgICAgdHJhbnNwb3J0czogY3JlZC50cmFuc3BvcnRzCiAgICAgIH0pOwogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIHNlcmlhbGl6ZUNyZWRlbnRpYWxDcmVhdGlvblJlc3BvbnNlKGNyZWRlbnRpYWwpIHsKICB2YXIgX2E7CiAgaWYgKCJ0b0pTT04iIGluIGNyZWRlbnRpYWwgJiYgdHlwZW9mIGNyZWRlbnRpYWwudG9KU09OID09PSAiZnVuY3Rpb24iKSB7CiAgICByZXR1cm4gY3JlZGVudGlhbC50b0pTT04oKTsKICB9CiAgY29uc3QgY3JlZGVudGlhbFdpdGhBdHRhY2htZW50ID0gY3JlZGVudGlhbDsKICByZXR1cm4gewogICAgaWQ6IGNyZWRlbnRpYWwuaWQsCiAgICByYXdJZDogY3JlZGVudGlhbC5pZCwKICAgIHJlc3BvbnNlOiB7CiAgICAgIGF0dGVzdGF0aW9uT2JqZWN0OiBieXRlc1RvQmFzZTY0VVJMKG5ldyBVaW50OEFycmF5KGNyZWRlbnRpYWwucmVzcG9uc2UuYXR0ZXN0YXRpb25PYmplY3QpKSwKICAgICAgY2xpZW50RGF0YUpTT046IGJ5dGVzVG9CYXNlNjRVUkwobmV3IFVpbnQ4QXJyYXkoY3JlZGVudGlhbC5yZXNwb25zZS5jbGllbnREYXRhSlNPTikpCiAgICB9LAogICAgdHlwZTogInB1YmxpYy1rZXkiLAogICAgY2xpZW50RXh0ZW5zaW9uUmVzdWx0czogY3JlZGVudGlhbC5nZXRDbGllbnRFeHRlbnNpb25SZXN1bHRzKCksCiAgICAvLyBDb252ZXJ0IG51bGwgdG8gdW5kZWZpbmVkIGFuZCBjYXN0IHRvIEF1dGhlbnRpY2F0b3JBdHRhY2htZW50IHR5cGUKICAgIGF1dGhlbnRpY2F0b3JBdHRhY2htZW50OiAoX2EgPSBjcmVkZW50aWFsV2l0aEF0dGFjaG1lbnQuYXV0aGVudGljYXRvckF0dGFjaG1lbnQpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IHZvaWQgMAogIH07Cn0KZnVuY3Rpb24gc2VyaWFsaXplQ3JlZGVudGlhbFJlcXVlc3RSZXNwb25zZShjcmVkZW50aWFsKSB7CiAgdmFyIF9hOwogIGlmICgidG9KU09OIiBpbiBjcmVkZW50aWFsICYmIHR5cGVvZiBjcmVkZW50aWFsLnRvSlNPTiA9PT0gImZ1bmN0aW9uIikgewogICAgcmV0dXJuIGNyZWRlbnRpYWwudG9KU09OKCk7CiAgfQogIGNvbnN0IGNyZWRlbnRpYWxXaXRoQXR0YWNobWVudCA9IGNyZWRlbnRpYWw7CiAgY29uc3QgY2xpZW50RXh0ZW5zaW9uUmVzdWx0cyA9IGNyZWRlbnRpYWwuZ2V0Q2xpZW50RXh0ZW5zaW9uUmVzdWx0cygpOwogIGNvbnN0IGFzc2VydGlvblJlc3BvbnNlID0gY3JlZGVudGlhbC5yZXNwb25zZTsKICByZXR1cm4gewogICAgaWQ6IGNyZWRlbnRpYWwuaWQsCiAgICByYXdJZDogY3JlZGVudGlhbC5pZCwKICAgIC8vIFczQyBzcGVjIGV4cGVjdHMgcmF3SWQgdG8gbWF0Y2ggaWQgZm9yIEpTT04gZm9ybWF0CiAgICByZXNwb25zZTogewogICAgICBhdXRoZW50aWNhdG9yRGF0YTogYnl0ZXNUb0Jhc2U2NFVSTChuZXcgVWludDhBcnJheShhc3NlcnRpb25SZXNwb25zZS5hdXRoZW50aWNhdG9yRGF0YSkpLAogICAgICBjbGllbnREYXRhSlNPTjogYnl0ZXNUb0Jhc2U2NFVSTChuZXcgVWludDhBcnJheShhc3NlcnRpb25SZXNwb25zZS5jbGllbnREYXRhSlNPTikpLAogICAgICBzaWduYXR1cmU6IGJ5dGVzVG9CYXNlNjRVUkwobmV3IFVpbnQ4QXJyYXkoYXNzZXJ0aW9uUmVzcG9uc2Uuc2lnbmF0dXJlKSksCiAgICAgIHVzZXJIYW5kbGU6IGFzc2VydGlvblJlc3BvbnNlLnVzZXJIYW5kbGUgPyBieXRlc1RvQmFzZTY0VVJMKG5ldyBVaW50OEFycmF5KGFzc2VydGlvblJlc3BvbnNlLnVzZXJIYW5kbGUpKSA6IHZvaWQgMAogICAgfSwKICAgIHR5cGU6ICJwdWJsaWMta2V5IiwKICAgIGNsaWVudEV4dGVuc2lvblJlc3VsdHMsCiAgICAvLyBDb252ZXJ0IG51bGwgdG8gdW5kZWZpbmVkIGFuZCBjYXN0IHRvIEF1dGhlbnRpY2F0b3JBdHRhY2htZW50IHR5cGUKICAgIGF1dGhlbnRpY2F0b3JBdHRhY2htZW50OiAoX2EgPSBjcmVkZW50aWFsV2l0aEF0dGFjaG1lbnQuYXV0aGVudGljYXRvckF0dGFjaG1lbnQpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IHZvaWQgMAogIH07Cn0KZnVuY3Rpb24gaXNWYWxpZERvbWFpbihob3N0bmFtZSkgewogIHJldHVybiAoCiAgICAvLyBDb25zaWRlciBsb2NhbGhvc3QgdmFsaWQgYXMgd2VsbCBzaW5jZSBpdCdzIG9rYXkgd3J0IFNlY3VyZSBDb250ZXh0cwogICAgaG9zdG5hbWUgPT09ICJsb2NhbGhvc3QiIHx8IC9eKFthLXowLTldKygtW2EtejAtOV0rKSpcLikrW2Etel17Mix9JC9pLnRlc3QoaG9zdG5hbWUpCiAgKTsKfQpmdW5jdGlvbiBicm93c2VyU3VwcG9ydHNXZWJBdXRobigpIHsKICB2YXIgX2EsIF9iOwogIHJldHVybiAhIShpc0Jyb3dzZXIoKSAmJiAiUHVibGljS2V5Q3JlZGVudGlhbCIgaW4gd2luZG93ICYmIHdpbmRvdy5QdWJsaWNLZXlDcmVkZW50aWFsICYmICJjcmVkZW50aWFscyIgaW4gbmF2aWdhdG9yICYmIHR5cGVvZiAoKF9hID0gbmF2aWdhdG9yID09PSBudWxsIHx8IG5hdmlnYXRvciA9PT0gdm9pZCAwID8gdm9pZCAwIDogbmF2aWdhdG9yLmNyZWRlbnRpYWxzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY3JlYXRlKSA9PT0gImZ1bmN0aW9uIiAmJiB0eXBlb2YgKChfYiA9IG5hdmlnYXRvciA9PT0gbnVsbCB8fCBuYXZpZ2F0b3IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG5hdmlnYXRvci5jcmVkZW50aWFscykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmdldCkgPT09ICJmdW5jdGlvbiIpOwp9CmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZUNyZWRlbnRpYWwob3B0aW9ucykgewogIHRyeSB7CiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IG5hdmlnYXRvci5jcmVkZW50aWFscy5jcmVhdGUoCiAgICAgIC8qKiB3ZSBhc3NlcnQgdGhlIHR5cGUgaGVyZSB1bnRpbCB0eXBlc2NyaXB0IHR5cGVzIGFyZSB1cGRhdGVkICovCiAgICAgIG9wdGlvbnMKICAgICk7CiAgICBpZiAoIXJlc3BvbnNlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICBlcnJvcjogbmV3IFdlYkF1dGhuVW5rbm93bkVycm9yKCJFbXB0eSBjcmVkZW50aWFsIHJlc3BvbnNlIiwgcmVzcG9uc2UpCiAgICAgIH07CiAgICB9CiAgICBpZiAoIShyZXNwb25zZSBpbnN0YW5jZW9mIFB1YmxpY0tleUNyZWRlbnRpYWwpKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICBlcnJvcjogbmV3IFdlYkF1dGhuVW5rbm93bkVycm9yKCJCcm93c2VyIHJldHVybmVkIHVuZXhwZWN0ZWQgY3JlZGVudGlhbCB0eXBlIiwgcmVzcG9uc2UpCiAgICAgIH07CiAgICB9CiAgICByZXR1cm4geyBkYXRhOiByZXNwb25zZSwgZXJyb3I6IG51bGwgfTsKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiB7CiAgICAgIGRhdGE6IG51bGwsCiAgICAgIGVycm9yOiBpZGVudGlmeVJlZ2lzdHJhdGlvbkVycm9yKHsKICAgICAgICBlcnJvcjogZXJyLAogICAgICAgIG9wdGlvbnMKICAgICAgfSkKICAgIH07CiAgfQp9CmFzeW5jIGZ1bmN0aW9uIGdldENyZWRlbnRpYWwob3B0aW9ucykgewogIHRyeSB7CiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IG5hdmlnYXRvci5jcmVkZW50aWFscy5nZXQoCiAgICAgIC8qKiB3ZSBhc3NlcnQgdGhlIHR5cGUgaGVyZSB1bnRpbCB0eXBlc2NyaXB0IHR5cGVzIGFyZSB1cGRhdGVkICovCiAgICAgIG9wdGlvbnMKICAgICk7CiAgICBpZiAoIXJlc3BvbnNlKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICBlcnJvcjogbmV3IFdlYkF1dGhuVW5rbm93bkVycm9yKCJFbXB0eSBjcmVkZW50aWFsIHJlc3BvbnNlIiwgcmVzcG9uc2UpCiAgICAgIH07CiAgICB9CiAgICBpZiAoIShyZXNwb25zZSBpbnN0YW5jZW9mIFB1YmxpY0tleUNyZWRlbnRpYWwpKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICBlcnJvcjogbmV3IFdlYkF1dGhuVW5rbm93bkVycm9yKCJCcm93c2VyIHJldHVybmVkIHVuZXhwZWN0ZWQgY3JlZGVudGlhbCB0eXBlIiwgcmVzcG9uc2UpCiAgICAgIH07CiAgICB9CiAgICByZXR1cm4geyBkYXRhOiByZXNwb25zZSwgZXJyb3I6IG51bGwgfTsKICB9IGNhdGNoIChlcnIpIHsKICAgIHJldHVybiB7CiAgICAgIGRhdGE6IG51bGwsCiAgICAgIGVycm9yOiBpZGVudGlmeUF1dGhlbnRpY2F0aW9uRXJyb3IoewogICAgICAgIGVycm9yOiBlcnIsCiAgICAgICAgb3B0aW9ucwogICAgICB9KQogICAgfTsKICB9Cn0KdmFyIERFRkFVTFRfQ1JFQVRJT05fT1BUSU9OUyA9IHsKICBoaW50czogWyJzZWN1cml0eS1rZXkiXSwKICBhdXRoZW50aWNhdG9yU2VsZWN0aW9uOiB7CiAgICBhdXRoZW50aWNhdG9yQXR0YWNobWVudDogImNyb3NzLXBsYXRmb3JtIiwKICAgIHJlcXVpcmVSZXNpZGVudEtleTogZmFsc2UsCiAgICAvKiogc2V0IHRvIHByZWZlcnJlZCBiZWNhdXNlIG9sZGVyIHl1YmlrZXlzIGRvbid0IGhhdmUgUElOL0Jpb21ldHJpYyAqLwogICAgdXNlclZlcmlmaWNhdGlvbjogInByZWZlcnJlZCIsCiAgICByZXNpZGVudEtleTogImRpc2NvdXJhZ2VkIgogIH0sCiAgYXR0ZXN0YXRpb246ICJkaXJlY3QiCn07CnZhciBERUZBVUxUX1JFUVVFU1RfT1BUSU9OUyA9IHsKICAvKiogc2V0IHRvIHByZWZlcnJlZCBiZWNhdXNlIG9sZGVyIHl1YmlrZXlzIGRvbid0IGhhdmUgUElOL0Jpb21ldHJpYyAqLwogIHVzZXJWZXJpZmljYXRpb246ICJwcmVmZXJyZWQiLAogIGhpbnRzOiBbInNlY3VyaXR5LWtleSJdLAogIGF0dGVzdGF0aW9uOiAiZGlyZWN0Igp9OwpmdW5jdGlvbiBkZWVwTWVyZ2UoLi4uc291cmNlcykgewogIGNvbnN0IGlzT2JqZWN0ID0gKHZhbCkgPT4gdmFsICE9PSBudWxsICYmIHR5cGVvZiB2YWwgPT09ICJvYmplY3QiICYmICFBcnJheS5pc0FycmF5KHZhbCk7CiAgY29uc3QgaXNBcnJheUJ1ZmZlckxpa2UgPSAodmFsKSA9PiB2YWwgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlciB8fCBBcnJheUJ1ZmZlci5pc1ZpZXcodmFsKTsKICBjb25zdCByZXN1bHQgPSB7fTsKICBmb3IgKGNvbnN0IHNvdXJjZSBvZiBzb3VyY2VzKSB7CiAgICBpZiAoIXNvdXJjZSkKICAgICAgY29udGludWU7CiAgICBmb3IgKGNvbnN0IGtleSBpbiBzb3VyY2UpIHsKICAgICAgY29uc3QgdmFsdWUgPSBzb3VyY2Vba2V5XTsKICAgICAgaWYgKHZhbHVlID09PSB2b2lkIDApCiAgICAgICAgY29udGludWU7CiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7CiAgICAgIH0gZWxzZSBpZiAoaXNBcnJheUJ1ZmZlckxpa2UodmFsdWUpKSB7CiAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICAgICAgfSBlbHNlIGlmIChpc09iamVjdCh2YWx1ZSkpIHsKICAgICAgICBjb25zdCBleGlzdGluZyA9IHJlc3VsdFtrZXldOwogICAgICAgIGlmIChpc09iamVjdChleGlzdGluZykpIHsKICAgICAgICAgIHJlc3VsdFtrZXldID0gZGVlcE1lcmdlKGV4aXN0aW5nLCB2YWx1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlc3VsdFtrZXldID0gZGVlcE1lcmdlKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTsKICAgICAgfQogICAgfQogIH0KICByZXR1cm4gcmVzdWx0Owp9CmZ1bmN0aW9uIG1lcmdlQ3JlZGVudGlhbENyZWF0aW9uT3B0aW9ucyhiYXNlT3B0aW9ucywgb3ZlcnJpZGVzKSB7CiAgcmV0dXJuIGRlZXBNZXJnZShERUZBVUxUX0NSRUFUSU9OX09QVElPTlMsIGJhc2VPcHRpb25zLCBvdmVycmlkZXMgfHwge30pOwp9CmZ1bmN0aW9uIG1lcmdlQ3JlZGVudGlhbFJlcXVlc3RPcHRpb25zKGJhc2VPcHRpb25zLCBvdmVycmlkZXMpIHsKICByZXR1cm4gZGVlcE1lcmdlKERFRkFVTFRfUkVRVUVTVF9PUFRJT05TLCBiYXNlT3B0aW9ucywgb3ZlcnJpZGVzIHx8IHt9KTsKfQp2YXIgV2ViQXV0aG5BcGkgPSBjbGFzcyB7CiAgY29uc3RydWN0b3IoY2xpZW50KSB7CiAgICB0aGlzLmNsaWVudCA9IGNsaWVudDsKICAgIHRoaXMuZW5yb2xsID0gdGhpcy5fZW5yb2xsLmJpbmQodGhpcyk7CiAgICB0aGlzLmNoYWxsZW5nZSA9IHRoaXMuX2NoYWxsZW5nZS5iaW5kKHRoaXMpOwogICAgdGhpcy52ZXJpZnkgPSB0aGlzLl92ZXJpZnkuYmluZCh0aGlzKTsKICAgIHRoaXMuYXV0aGVudGljYXRlID0gdGhpcy5fYXV0aGVudGljYXRlLmJpbmQodGhpcyk7CiAgICB0aGlzLnJlZ2lzdGVyID0gdGhpcy5fcmVnaXN0ZXIuYmluZCh0aGlzKTsKICB9CiAgLyoqCiAgICogRW5yb2xsIGEgbmV3IFdlYkF1dGhuIGZhY3Rvci4KICAgKiBDcmVhdGVzIGFuIHVudmVyaWZpZWQgV2ViQXV0aG4gZmFjdG9yIHRoYXQgbXVzdCBiZSB2ZXJpZmllZCB3aXRoIGEgY3JlZGVudGlhbC4KICAgKgogICAqIEBleHBlcmltZW50YWwgVGhpcyBtZXRob2QgaXMgZXhwZXJpbWVudGFsIGFuZCBtYXkgY2hhbmdlIGluIGZ1dHVyZSByZWxlYXNlcwogICAqIEBwYXJhbSB7T21pdDxNRkFFbnJvbGxXZWJhdXRoblBhcmFtcywgJ2ZhY3RvclR5cGUnPn0gcGFyYW1zIC0gRW5yb2xsbWVudCBwYXJhbWV0ZXJzIChmcmllbmRseU5hbWUgcmVxdWlyZWQpCiAgICogQHJldHVybnMge1Byb21pc2U8QXV0aE1GQUVucm9sbFdlYmF1dGhuUmVzcG9uc2U+fSBFbnJvbGxlZCBmYWN0b3IgZGV0YWlscyBvciBlcnJvcgogICAqIEBzZWUge0BsaW5rIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJhdXRobi8jc2N0bi1yZWdpc3RlcmluZy1hLW5ldy1jcmVkZW50aWFsIFczQyBXZWJBdXRobiBTcGVjIC0gUmVnaXN0ZXJpbmcgYSBOZXcgQ3JlZGVudGlhbH0KICAgKi8KICBhc3luYyBfZW5yb2xsKHBhcmFtcykgewogICAgcmV0dXJuIHRoaXMuY2xpZW50Lm1mYS5lbnJvbGwoT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBwYXJhbXMpLCB7IGZhY3RvclR5cGU6ICJ3ZWJhdXRobiIgfSkpOwogIH0KICAvKioKICAgKiBDaGFsbGVuZ2UgZm9yIFdlYkF1dGhuIGNyZWRlbnRpYWwgY3JlYXRpb24gb3IgYXV0aGVudGljYXRpb24uCiAgICogQ29tYmluZXMgc2VydmVyIGNoYWxsZW5nZSB3aXRoIGJyb3dzZXIgY3JlZGVudGlhbCBvcGVyYXRpb25zLgogICAqIEhhbmRsZXMgYm90aCByZWdpc3RyYXRpb24gKGNyZWF0ZSkgYW5kIGF1dGhlbnRpY2F0aW9uIChyZXF1ZXN0KSBmbG93cy4KICAgKgogICAqIEBleHBlcmltZW50YWwgVGhpcyBtZXRob2QgaXMgZXhwZXJpbWVudGFsIGFuZCBtYXkgY2hhbmdlIGluIGZ1dHVyZSByZWxlYXNlcwogICAqIEBwYXJhbSB7TUZBQ2hhbGxlbmdlV2ViYXV0aG5QYXJhbXMgJiB7IGZyaWVuZGx5TmFtZT86IHN0cmluZzsgc2lnbmFsPzogQWJvcnRTaWduYWwgfX0gcGFyYW1zIC0gQ2hhbGxlbmdlIHBhcmFtZXRlcnMgaW5jbHVkaW5nIGZhY3RvcklkCiAgICogQHBhcmFtIHtPYmplY3R9IG92ZXJyaWRlcyAtIEFsbG93cyB5b3UgdG8gb3ZlcnJpZGUgdGhlIHBhcmFtZXRlcnMgcGFzc2VkIHRvIG5hdmlnYXRvci5jcmVkZW50aWFscwogICAqIEBwYXJhbSB7UHVibGljS2V5Q3JlZGVudGlhbENyZWF0aW9uT3B0aW9uc0Z1dHVyZX0gb3ZlcnJpZGVzLmNyZWF0ZSAtIE92ZXJyaWRlIG9wdGlvbnMgZm9yIGNyZWRlbnRpYWwgY3JlYXRpb24KICAgKiBAcGFyYW0ge1B1YmxpY0tleUNyZWRlbnRpYWxSZXF1ZXN0T3B0aW9uc0Z1dHVyZX0gb3ZlcnJpZGVzLnJlcXVlc3QgLSBPdmVycmlkZSBvcHRpb25zIGZvciBjcmVkZW50aWFsIHJlcXVlc3QKICAgKiBAcmV0dXJucyB7UHJvbWlzZTxSZXF1ZXN0UmVzdWx0Pn0gQ2hhbGxlbmdlIHJlc3BvbnNlIHdpdGggY3JlZGVudGlhbCBvciBlcnJvcgogICAqIEBzZWUge0BsaW5rIGh0dHBzOi8vdzNjLmdpdGh1Yi5pby93ZWJhdXRobi8jc2N0bi1jcmVkZW50aWFsLWNyZWF0aW9uIFczQyBXZWJBdXRobiBTcGVjIC0gQ3JlZGVudGlhbCBDcmVhdGlvbn0KICAgKiBAc2VlIHtAbGluayBodHRwczovL3czYy5naXRodWIuaW8vd2ViYXV0aG4vI3NjdG4tdmVyaWZ5aW5nLWFzc2VydGlvbiBXM0MgV2ViQXV0aG4gU3BlYyAtIFZlcmlmeWluZyBBc3NlcnRpb259CiAgICovCiAgYXN5bmMgX2NoYWxsZW5nZSh7IGZhY3RvcklkLCB3ZWJhdXRobiwgZnJpZW5kbHlOYW1lLCBzaWduYWwgfSwgb3ZlcnJpZGVzKSB7CiAgICB2YXIgX2E7CiAgICB0cnkgewogICAgICBjb25zdCB7IGRhdGE6IGNoYWxsZW5nZVJlc3BvbnNlLCBlcnJvcjogY2hhbGxlbmdlRXJyb3IgfSA9IGF3YWl0IHRoaXMuY2xpZW50Lm1mYS5jaGFsbGVuZ2UoewogICAgICAgIGZhY3RvcklkLAogICAgICAgIHdlYmF1dGhuCiAgICAgIH0pOwogICAgICBpZiAoIWNoYWxsZW5nZVJlc3BvbnNlKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3I6IGNoYWxsZW5nZUVycm9yIH07CiAgICAgIH0KICAgICAgY29uc3QgYWJvcnRTaWduYWwgPSBzaWduYWwgIT09IG51bGwgJiYgc2lnbmFsICE9PSB2b2lkIDAgPyBzaWduYWwgOiB3ZWJBdXRobkFib3J0U2VydmljZS5jcmVhdGVOZXdBYm9ydFNpZ25hbCgpOwogICAgICBpZiAoY2hhbGxlbmdlUmVzcG9uc2Uud2ViYXV0aG4udHlwZSA9PT0gImNyZWF0ZSIpIHsKICAgICAgICBjb25zdCB7IHVzZXIgfSA9IGNoYWxsZW5nZVJlc3BvbnNlLndlYmF1dGhuLmNyZWRlbnRpYWxfb3B0aW9ucy5wdWJsaWNLZXk7CiAgICAgICAgaWYgKCF1c2VyLm5hbWUpIHsKICAgICAgICAgIGNvbnN0IG5hbWVUb1VzZSA9IGZyaWVuZGx5TmFtZTsKICAgICAgICAgIGlmICghbmFtZVRvVXNlKSB7CiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRVc2VyID0gYXdhaXQgdGhpcy5jbGllbnQuZ2V0VXNlcigpOwogICAgICAgICAgICBjb25zdCB1c2VyRGF0YSA9IGN1cnJlbnRVc2VyLmRhdGEudXNlcjsKICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tOYW1lID0gKChfYSA9IHVzZXJEYXRhID09PSBudWxsIHx8IHVzZXJEYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiB1c2VyRGF0YS51c2VyX21ldGFkYXRhKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EubmFtZSkgfHwgKHVzZXJEYXRhID09PSBudWxsIHx8IHVzZXJEYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiB1c2VyRGF0YS5lbWFpbCkgfHwgKHVzZXJEYXRhID09PSBudWxsIHx8IHVzZXJEYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiB1c2VyRGF0YS5pZCkgfHwgIlVzZXIiOwogICAgICAgICAgICB1c2VyLm5hbWUgPSBgJHt1c2VyLmlkfToke2ZhbGxiYWNrTmFtZX1gOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdXNlci5uYW1lID0gYCR7dXNlci5pZH06JHtuYW1lVG9Vc2V9YDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCF1c2VyLmRpc3BsYXlOYW1lKSB7CiAgICAgICAgICB1c2VyLmRpc3BsYXlOYW1lID0gdXNlci5uYW1lOwogICAgICAgIH0KICAgICAgfQogICAgICBzd2l0Y2ggKGNoYWxsZW5nZVJlc3BvbnNlLndlYmF1dGhuLnR5cGUpIHsKICAgICAgICBjYXNlICJjcmVhdGUiOiB7CiAgICAgICAgICBjb25zdCBvcHRpb25zID0gbWVyZ2VDcmVkZW50aWFsQ3JlYXRpb25PcHRpb25zKGNoYWxsZW5nZVJlc3BvbnNlLndlYmF1dGhuLmNyZWRlbnRpYWxfb3B0aW9ucy5wdWJsaWNLZXksIG92ZXJyaWRlcyA9PT0gbnVsbCB8fCBvdmVycmlkZXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG92ZXJyaWRlcy5jcmVhdGUpOwogICAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgY3JlYXRlQ3JlZGVudGlhbCh7CiAgICAgICAgICAgIHB1YmxpY0tleTogb3B0aW9ucywKICAgICAgICAgICAgc2lnbmFsOiBhYm9ydFNpZ25hbAogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAoZGF0YSkgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgICAgIGZhY3RvcklkLAogICAgICAgICAgICAgICAgY2hhbGxlbmdlSWQ6IGNoYWxsZW5nZVJlc3BvbnNlLmlkLAogICAgICAgICAgICAgICAgd2ViYXV0aG46IHsKICAgICAgICAgICAgICAgICAgdHlwZTogY2hhbGxlbmdlUmVzcG9uc2Uud2ViYXV0aG4udHlwZSwKICAgICAgICAgICAgICAgICAgY3JlZGVudGlhbF9yZXNwb25zZTogZGF0YQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgZXJyb3I6IG51bGwKICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7IGRhdGE6IG51bGwsIGVycm9yIH07CiAgICAgICAgfQogICAgICAgIGNhc2UgInJlcXVlc3QiOiB7CiAgICAgICAgICBjb25zdCBvcHRpb25zID0gbWVyZ2VDcmVkZW50aWFsUmVxdWVzdE9wdGlvbnMoY2hhbGxlbmdlUmVzcG9uc2Uud2ViYXV0aG4uY3JlZGVudGlhbF9vcHRpb25zLnB1YmxpY0tleSwgb3ZlcnJpZGVzID09PSBudWxsIHx8IG92ZXJyaWRlcyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3ZlcnJpZGVzLnJlcXVlc3QpOwogICAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgZ2V0Q3JlZGVudGlhbChPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIGNoYWxsZW5nZVJlc3BvbnNlLndlYmF1dGhuLmNyZWRlbnRpYWxfb3B0aW9ucyksIHsgcHVibGljS2V5OiBvcHRpb25zLCBzaWduYWw6IGFib3J0U2lnbmFsIH0pKTsKICAgICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgZGF0YTogewogICAgICAgICAgICAgICAgZmFjdG9ySWQsCiAgICAgICAgICAgICAgICBjaGFsbGVuZ2VJZDogY2hhbGxlbmdlUmVzcG9uc2UuaWQsCiAgICAgICAgICAgICAgICB3ZWJhdXRobjogewogICAgICAgICAgICAgICAgICB0eXBlOiBjaGFsbGVuZ2VSZXNwb25zZS53ZWJhdXRobi50eXBlLAogICAgICAgICAgICAgICAgICBjcmVkZW50aWFsX3Jlc3BvbnNlOiBkYXRhCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBlcnJvcjogbnVsbAogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3IgfTsKICAgICAgICB9CiAgICAgIH0KICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvciB9OwogICAgICB9CiAgICAgIHJldHVybiB7CiAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICBlcnJvcjogbmV3IEF1dGhVbmtub3duRXJyb3IoIlVuZXhwZWN0ZWQgZXJyb3IgaW4gY2hhbGxlbmdlIiwgZXJyb3IpCiAgICAgIH07CiAgICB9CiAgfQogIC8qKgogICAqIFZlcmlmeSBhIFdlYkF1dGhuIGNyZWRlbnRpYWwgd2l0aCB0aGUgc2VydmVyLgogICAqIENvbXBsZXRlcyB0aGUgV2ViQXV0aG4gY2VyZW1vbnkgYnkgc2VuZGluZyB0aGUgY3JlZGVudGlhbCB0byB0aGUgc2VydmVyIGZvciB2ZXJpZmljYXRpb24uCiAgICoKICAgKiBAZXhwZXJpbWVudGFsIFRoaXMgbWV0aG9kIGlzIGV4cGVyaW1lbnRhbCBhbmQgbWF5IGNoYW5nZSBpbiBmdXR1cmUgcmVsZWFzZXMKICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1zIC0gVmVyaWZpY2F0aW9uIHBhcmFtZXRlcnMKICAgKiBAcGFyYW0ge3N0cmluZ30gcGFyYW1zLmNoYWxsZW5nZUlkIC0gSUQgb2YgdGhlIGNoYWxsZW5nZSBiZWluZyB2ZXJpZmllZAogICAqIEBwYXJhbSB7c3RyaW5nfSBwYXJhbXMuZmFjdG9ySWQgLSBJRCBvZiB0aGUgV2ViQXV0aG4gZmFjdG9yCiAgICogQHBhcmFtIHtNRkFWZXJpZnlXZWJhdXRoblBhcmFtczxUPlsnd2ViYXV0aG4nXX0gcGFyYW1zLndlYmF1dGhuIC0gV2ViQXV0aG4gY3JlZGVudGlhbCByZXNwb25zZQogICAqIEByZXR1cm5zIHtQcm9taXNlPEF1dGhNRkFWZXJpZnlSZXNwb25zZT59IFZlcmlmaWNhdGlvbiByZXN1bHQgd2l0aCBzZXNzaW9uIG9yIGVycm9yCiAgICogQHNlZSB7QGxpbmsgaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmF1dGhuLyNzY3RuLXZlcmlmeWluZy1hc3NlcnRpb24gVzNDIFdlYkF1dGhuIFNwZWMgLSBWZXJpZnlpbmcgYW4gQXV0aGVudGljYXRpb24gQXNzZXJ0aW9ufQogICAqICovCiAgYXN5bmMgX3ZlcmlmeSh7IGNoYWxsZW5nZUlkLCBmYWN0b3JJZCwgd2ViYXV0aG4gfSkgewogICAgcmV0dXJuIHRoaXMuY2xpZW50Lm1mYS52ZXJpZnkoewogICAgICBmYWN0b3JJZCwKICAgICAgY2hhbGxlbmdlSWQsCiAgICAgIHdlYmF1dGhuCiAgICB9KTsKICB9CiAgLyoqCiAgICogQ29tcGxldGUgV2ViQXV0aG4gYXV0aGVudGljYXRpb24gZmxvdy4KICAgKiBQZXJmb3JtcyBjaGFsbGVuZ2UgYW5kIHZlcmlmaWNhdGlvbiBpbiBhIHNpbmdsZSBvcGVyYXRpb24gZm9yIGV4aXN0aW5nIGNyZWRlbnRpYWxzLgogICAqCiAgICogQGV4cGVyaW1lbnRhbCBUaGlzIG1ldGhvZCBpcyBleHBlcmltZW50YWwgYW5kIG1heSBjaGFuZ2UgaW4gZnV0dXJlIHJlbGVhc2VzCiAgICogQHBhcmFtIHtPYmplY3R9IHBhcmFtcyAtIEF1dGhlbnRpY2F0aW9uIHBhcmFtZXRlcnMKICAgKiBAcGFyYW0ge3N0cmluZ30gcGFyYW1zLmZhY3RvcklkIC0gSUQgb2YgdGhlIFdlYkF1dGhuIGZhY3RvciB0byBhdXRoZW50aWNhdGUgd2l0aAogICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMud2ViYXV0aG4gLSBXZWJBdXRobiBjb25maWd1cmF0aW9uCiAgICogQHBhcmFtIHtzdHJpbmd9IHBhcmFtcy53ZWJhdXRobi5ycElkIC0gUmVseWluZyBQYXJ0eSBJRCAoZGVmYXVsdHMgdG8gY3VycmVudCBob3N0bmFtZSkKICAgKiBAcGFyYW0ge3N0cmluZ1tdfSBwYXJhbXMud2ViYXV0aG4ucnBPcmlnaW5zIC0gQWxsb3dlZCBvcmlnaW5zIChkZWZhdWx0cyB0byBjdXJyZW50IG9yaWdpbikKICAgKiBAcGFyYW0ge0Fib3J0U2lnbmFsfSBwYXJhbXMud2ViYXV0aG4uc2lnbmFsIC0gT3B0aW9uYWwgYWJvcnQgc2lnbmFsCiAgICogQHBhcmFtIHtQdWJsaWNLZXlDcmVkZW50aWFsUmVxdWVzdE9wdGlvbnNGdXR1cmV9IG92ZXJyaWRlcyAtIE92ZXJyaWRlIG9wdGlvbnMgZm9yIG5hdmlnYXRvci5jcmVkZW50aWFscy5nZXQKICAgKiBAcmV0dXJucyB7UHJvbWlzZTxSZXF1ZXN0UmVzdWx0PEF1dGhNRkFWZXJpZnlSZXNwb25zZURhdGEsIFdlYkF1dGhuRXJyb3IgfCBBdXRoRXJyb3I+Pn0gQXV0aGVudGljYXRpb24gcmVzdWx0CiAgICogQHNlZSB7QGxpbmsgaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmF1dGhuLyNzY3RuLWF1dGhlbnRpY2F0aW9uIFczQyBXZWJBdXRobiBTcGVjIC0gQXV0aGVudGljYXRpb24gQ2VyZW1vbnl9CiAgICogQHNlZSB7QGxpbmsgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1B1YmxpY0tleUNyZWRlbnRpYWxSZXF1ZXN0T3B0aW9ucyBNRE4gLSBQdWJsaWNLZXlDcmVkZW50aWFsUmVxdWVzdE9wdGlvbnN9CiAgICovCiAgYXN5bmMgX2F1dGhlbnRpY2F0ZSh7IGZhY3RvcklkLCB3ZWJhdXRobjogeyBycElkID0gdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cubG9jYXRpb24uaG9zdG5hbWUgOiB2b2lkIDAsIHJwT3JpZ2lucyA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gW3dpbmRvdy5sb2NhdGlvbi5vcmlnaW5dIDogdm9pZCAwLCBzaWduYWwgfSA9IHt9IH0sIG92ZXJyaWRlcykgewogICAgaWYgKCFycElkKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICBlcnJvcjogbmV3IEF1dGhFcnJvcigicnBJZCBpcyByZXF1aXJlZCBmb3IgV2ViQXV0aG4gYXV0aGVudGljYXRpb24iKQogICAgICB9OwogICAgfQogICAgdHJ5IHsKICAgICAgaWYgKCFicm93c2VyU3VwcG9ydHNXZWJBdXRobigpKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgICBlcnJvcjogbmV3IEF1dGhVbmtub3duRXJyb3IoIkJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBXZWJBdXRobiIsIG51bGwpCiAgICAgICAgfTsKICAgICAgfQogICAgICBjb25zdCB7IGRhdGE6IGNoYWxsZW5nZVJlc3BvbnNlLCBlcnJvcjogY2hhbGxlbmdlRXJyb3IgfSA9IGF3YWl0IHRoaXMuY2hhbGxlbmdlKHsKICAgICAgICBmYWN0b3JJZCwKICAgICAgICB3ZWJhdXRobjogeyBycElkLCBycE9yaWdpbnMgfSwKICAgICAgICBzaWduYWwKICAgICAgfSwgeyByZXF1ZXN0OiBvdmVycmlkZXMgfSk7CiAgICAgIGlmICghY2hhbGxlbmdlUmVzcG9uc2UpIHsKICAgICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvcjogY2hhbGxlbmdlRXJyb3IgfTsKICAgICAgfQogICAgICBjb25zdCB7IHdlYmF1dGhuIH0gPSBjaGFsbGVuZ2VSZXNwb25zZTsKICAgICAgcmV0dXJuIHRoaXMuX3ZlcmlmeSh7CiAgICAgICAgZmFjdG9ySWQsCiAgICAgICAgY2hhbGxlbmdlSWQ6IGNoYWxsZW5nZVJlc3BvbnNlLmNoYWxsZW5nZUlkLAogICAgICAgIHdlYmF1dGhuOiB7CiAgICAgICAgICB0eXBlOiB3ZWJhdXRobi50eXBlLAogICAgICAgICAgcnBJZCwKICAgICAgICAgIHJwT3JpZ2lucywKICAgICAgICAgIGNyZWRlbnRpYWxfcmVzcG9uc2U6IHdlYmF1dGhuLmNyZWRlbnRpYWxfcmVzcG9uc2UKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB7IGRhdGE6IG51bGwsIGVycm9yIH07CiAgICAgIH0KICAgICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiBudWxsLAogICAgICAgIGVycm9yOiBuZXcgQXV0aFVua25vd25FcnJvcigiVW5leHBlY3RlZCBlcnJvciBpbiBhdXRoZW50aWNhdGUiLCBlcnJvcikKICAgICAgfTsKICAgIH0KICB9CiAgLyoqCiAgICogQ29tcGxldGUgV2ViQXV0aG4gcmVnaXN0cmF0aW9uIGZsb3cuCiAgICogUGVyZm9ybXMgZW5yb2xsbWVudCwgY2hhbGxlbmdlLCBhbmQgdmVyaWZpY2F0aW9uIGluIGEgc2luZ2xlIG9wZXJhdGlvbiBmb3IgbmV3IGNyZWRlbnRpYWxzLgogICAqCiAgICogQGV4cGVyaW1lbnRhbCBUaGlzIG1ldGhvZCBpcyBleHBlcmltZW50YWwgYW5kIG1heSBjaGFuZ2UgaW4gZnV0dXJlIHJlbGVhc2VzCiAgICogQHBhcmFtIHtPYmplY3R9IHBhcmFtcyAtIFJlZ2lzdHJhdGlvbiBwYXJhbWV0ZXJzCiAgICogQHBhcmFtIHtzdHJpbmd9IHBhcmFtcy5mcmllbmRseU5hbWUgLSBVc2VyLWZyaWVuZGx5IG5hbWUgZm9yIHRoZSBjcmVkZW50aWFsCiAgICogQHBhcmFtIHtzdHJpbmd9IHBhcmFtcy5ycElkIC0gUmVseWluZyBQYXJ0eSBJRCAoZGVmYXVsdHMgdG8gY3VycmVudCBob3N0bmFtZSkKICAgKiBAcGFyYW0ge3N0cmluZ1tdfSBwYXJhbXMucnBPcmlnaW5zIC0gQWxsb3dlZCBvcmlnaW5zIChkZWZhdWx0cyB0byBjdXJyZW50IG9yaWdpbikKICAgKiBAcGFyYW0ge0Fib3J0U2lnbmFsfSBwYXJhbXMuc2lnbmFsIC0gT3B0aW9uYWwgYWJvcnQgc2lnbmFsCiAgICogQHBhcmFtIHtQdWJsaWNLZXlDcmVkZW50aWFsQ3JlYXRpb25PcHRpb25zRnV0dXJlfSBvdmVycmlkZXMgLSBPdmVycmlkZSBvcHRpb25zIGZvciBuYXZpZ2F0b3IuY3JlZGVudGlhbHMuY3JlYXRlCiAgICogQHJldHVybnMge1Byb21pc2U8UmVxdWVzdFJlc3VsdDxBdXRoTUZBVmVyaWZ5UmVzcG9uc2VEYXRhLCBXZWJBdXRobkVycm9yIHwgQXV0aEVycm9yPj59IFJlZ2lzdHJhdGlvbiByZXN1bHQKICAgKiBAc2VlIHtAbGluayBodHRwczovL3czYy5naXRodWIuaW8vd2ViYXV0aG4vI3NjdG4tcmVnaXN0ZXJpbmctYS1uZXctY3JlZGVudGlhbCBXM0MgV2ViQXV0aG4gU3BlYyAtIFJlZ2lzdHJhdGlvbiBDZXJlbW9ueX0KICAgKiBAc2VlIHtAbGluayBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvUHVibGljS2V5Q3JlZGVudGlhbENyZWF0aW9uT3B0aW9ucyBNRE4gLSBQdWJsaWNLZXlDcmVkZW50aWFsQ3JlYXRpb25PcHRpb25zfQogICAqLwogIGFzeW5jIF9yZWdpc3Rlcih7IGZyaWVuZGx5TmFtZSwgd2ViYXV0aG46IHsgcnBJZCA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiID8gd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lIDogdm9pZCAwLCBycE9yaWdpbnMgPSB0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiA/IFt3aW5kb3cubG9jYXRpb24ub3JpZ2luXSA6IHZvaWQgMCwgc2lnbmFsIH0gPSB7fSB9LCBvdmVycmlkZXMpIHsKICAgIGlmICghcnBJZCkgewogICAgICByZXR1cm4gewogICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgZXJyb3I6IG5ldyBBdXRoRXJyb3IoInJwSWQgaXMgcmVxdWlyZWQgZm9yIFdlYkF1dGhuIHJlZ2lzdHJhdGlvbiIpCiAgICAgIH07CiAgICB9CiAgICB0cnkgewogICAgICBpZiAoIWJyb3dzZXJTdXBwb3J0c1dlYkF1dGhuKCkpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgZGF0YTogbnVsbCwKICAgICAgICAgIGVycm9yOiBuZXcgQXV0aFVua25vd25FcnJvcigiQnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IFdlYkF1dGhuIiwgbnVsbCkKICAgICAgICB9OwogICAgICB9CiAgICAgIGNvbnN0IHsgZGF0YTogZmFjdG9yLCBlcnJvcjogZW5yb2xsRXJyb3IgfSA9IGF3YWl0IHRoaXMuX2Vucm9sbCh7CiAgICAgICAgZnJpZW5kbHlOYW1lCiAgICAgIH0pOwogICAgICBpZiAoIWZhY3RvcikgewogICAgICAgIGF3YWl0IHRoaXMuY2xpZW50Lm1mYS5saXN0RmFjdG9ycygpLnRoZW4oKGZhY3RvcnMpID0+IHsKICAgICAgICAgIHZhciBfYTsKICAgICAgICAgIHJldHVybiAoX2EgPSBmYWN0b3JzLmRhdGEpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5hbGwuZmluZCgodikgPT4gdi5mYWN0b3JfdHlwZSA9PT0gIndlYmF1dGhuIiAmJiB2LmZyaWVuZGx5X25hbWUgPT09IGZyaWVuZGx5TmFtZSAmJiB2LnN0YXR1cyAhPT0gInVudmVyaWZpZWQiKTsKICAgICAgICB9KS50aGVuKChmYWN0b3IyKSA9PiBmYWN0b3IyID8gdGhpcy5jbGllbnQubWZhLnVuZW5yb2xsKHsgZmFjdG9ySWQ6IGZhY3RvcjIgPT09IG51bGwgfHwgZmFjdG9yMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogZmFjdG9yMi5pZCB9KSA6IHZvaWQgMCk7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3I6IGVucm9sbEVycm9yIH07CiAgICAgIH0KICAgICAgY29uc3QgeyBkYXRhOiBjaGFsbGVuZ2VSZXNwb25zZSwgZXJyb3I6IGNoYWxsZW5nZUVycm9yIH0gPSBhd2FpdCB0aGlzLl9jaGFsbGVuZ2UoewogICAgICAgIGZhY3RvcklkOiBmYWN0b3IuaWQsCiAgICAgICAgZnJpZW5kbHlOYW1lOiBmYWN0b3IuZnJpZW5kbHlfbmFtZSwKICAgICAgICB3ZWJhdXRobjogeyBycElkLCBycE9yaWdpbnMgfSwKICAgICAgICBzaWduYWwKICAgICAgfSwgewogICAgICAgIGNyZWF0ZTogb3ZlcnJpZGVzCiAgICAgIH0pOwogICAgICBpZiAoIWNoYWxsZW5nZVJlc3BvbnNlKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3I6IGNoYWxsZW5nZUVycm9yIH07CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX3ZlcmlmeSh7CiAgICAgICAgZmFjdG9ySWQ6IGZhY3Rvci5pZCwKICAgICAgICBjaGFsbGVuZ2VJZDogY2hhbGxlbmdlUmVzcG9uc2UuY2hhbGxlbmdlSWQsCiAgICAgICAgd2ViYXV0aG46IHsKICAgICAgICAgIHJwSWQsCiAgICAgICAgICBycE9yaWdpbnMsCiAgICAgICAgICB0eXBlOiBjaGFsbGVuZ2VSZXNwb25zZS53ZWJhdXRobi50eXBlLAogICAgICAgICAgY3JlZGVudGlhbF9yZXNwb25zZTogY2hhbGxlbmdlUmVzcG9uc2Uud2ViYXV0aG4uY3JlZGVudGlhbF9yZXNwb25zZQogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHsgZGF0YTogbnVsbCwgZXJyb3IgfTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGRhdGE6IG51bGwsCiAgICAgICAgZXJyb3I6IG5ldyBBdXRoVW5rbm93bkVycm9yKCJVbmV4cGVjdGVkIGVycm9yIGluIHJlZ2lzdGVyIiwgZXJyb3IpCiAgICAgIH07CiAgICB9CiAgfQp9OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZSthdXRoLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL2F1dGgtanMvZGlzdC9tb2R1bGUvR29UcnVlQ2xpZW50LmpzCnBvbHlmaWxsR2xvYmFsVGhpcygpOwp2YXIgREVGQVVMVF9PUFRJT05TID0gewogIHVybDogR09UUlVFX1VSTCwKICBzdG9yYWdlS2V5OiBTVE9SQUdFX0tFWSwKICBhdXRvUmVmcmVzaFRva2VuOiB0cnVlLAogIHBlcnNpc3RTZXNzaW9uOiB0cnVlLAogIGRldGVjdFNlc3Npb25JblVybDogdHJ1ZSwKICBoZWFkZXJzOiBERUZBVUxUX0hFQURFUlMyLAogIGZsb3dUeXBlOiAiaW1wbGljaXQiLAogIGRlYnVnOiBmYWxzZSwKICBoYXNDdXN0b21BdXRob3JpemF0aW9uSGVhZGVyOiBmYWxzZSwKICB0aHJvd09uRXJyb3I6IGZhbHNlLAogIGxvY2tBY3F1aXJlVGltZW91dDogMWU0LAogIC8vIDEwIHNlY29uZHMKICBza2lwQXV0b0luaXRpYWxpemU6IGZhbHNlCn07CmFzeW5jIGZ1bmN0aW9uIGxvY2tOb09wKG5hbWUsIGFjcXVpcmVUaW1lb3V0LCBmbikgewogIHJldHVybiBhd2FpdCBmbigpOwp9CnZhciBHTE9CQUxfSldLUyA9IHt9Owp2YXIgR29UcnVlQ2xpZW50ID0gY2xhc3MgX0dvVHJ1ZUNsaWVudCB7CiAgLyoqCiAgICogVGhlIEpXS1MgdXNlZCBmb3IgdmVyaWZ5aW5nIGFzeW1tZXRyaWMgSldUcwogICAqLwogIGdldCBqd2tzKCkgewogICAgdmFyIF9hLCBfYjsKICAgIHJldHVybiAoX2IgPSAoX2EgPSBHTE9CQUxfSldLU1t0aGlzLnN0b3JhZ2VLZXldKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuandrcykgIT09IG51bGwgJiYgX2IgIT09IHZvaWQgMCA/IF9iIDogeyBrZXlzOiBbXSB9OwogIH0KICBzZXQgandrcyh2YWx1ZSkgewogICAgR0xPQkFMX0pXS1NbdGhpcy5zdG9yYWdlS2V5XSA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgR0xPQkFMX0pXS1NbdGhpcy5zdG9yYWdlS2V5XSksIHsgandrczogdmFsdWUgfSk7CiAgfQogIGdldCBqd2tzX2NhY2hlZF9hdCgpIHsKICAgIHZhciBfYSwgX2I7CiAgICByZXR1cm4gKF9iID0gKF9hID0gR0xPQkFMX0pXS1NbdGhpcy5zdG9yYWdlS2V5XSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmNhY2hlZEF0KSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiBOdW1iZXIuTUlOX1NBRkVfSU5URUdFUjsKICB9CiAgc2V0IGp3a3NfY2FjaGVkX2F0KHZhbHVlKSB7CiAgICBHTE9CQUxfSldLU1t0aGlzLnN0b3JhZ2VLZXldID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBHTE9CQUxfSldLU1t0aGlzLnN0b3JhZ2VLZXldKSwgeyBjYWNoZWRBdDogdmFsdWUgfSk7CiAgfQogIC8qKgogICAqIENyZWF0ZSBhIG5ldyBjbGllbnQgZm9yIHVzZSBpbiB0aGUgYnJvd3Nlci4KICAgKgogICAqIEBleGFtcGxlCiAgICogYGBgdHMKICAgKiBpbXBvcnQgeyBHb1RydWVDbGllbnQgfSBmcm9tICdAc3VwYWJhc2UvYXV0aC1qcycKICAgKgogICAqIGNvbnN0IGF1dGggPSBuZXcgR29UcnVlQ2xpZW50KHsKICAgKiAgIHVybDogJ2h0dHBzOi8veHl6Y29tcGFueS5zdXBhYmFzZS5jby9hdXRoL3YxJywKICAgKiAgIGhlYWRlcnM6IHsgYXBpa2V5OiAncHVibGljLWFub24ta2V5JyB9LAogICAqICAgc3RvcmFnZUtleTogJ3N1cGFiYXNlLWF1dGgnLAogICAqIH0pCiAgICogYGBgCiAgICovCiAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgdmFyIF9hLCBfYiwgX2M7CiAgICB0aGlzLnVzZXJTdG9yYWdlID0gbnVsbDsKICAgIHRoaXMubWVtb3J5U3RvcmFnZSA9IG51bGw7CiAgICB0aGlzLnN0YXRlQ2hhbmdlRW1pdHRlcnMgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgdGhpcy5hdXRvUmVmcmVzaFRpY2tlciA9IG51bGw7CiAgICB0aGlzLmF1dG9SZWZyZXNoVGlja1RpbWVvdXQgPSBudWxsOwogICAgdGhpcy52aXNpYmlsaXR5Q2hhbmdlZENhbGxiYWNrID0gbnVsbDsKICAgIHRoaXMucmVmcmVzaGluZ0RlZmVycmVkID0gbnVsbDsKICAgIHRoaXMuaW5pdGlhbGl6ZVByb21pc2UgPSBudWxsOwogICAgdGhpcy5kZXRlY3RTZXNzaW9uSW5VcmwgPSB0cnVlOwogICAgdGhpcy5oYXNDdXN0b21BdXRob3JpemF0aW9uSGVhZGVyID0gZmFsc2U7CiAgICB0aGlzLnN1cHByZXNzR2V0U2Vzc2lvbldhcm5pbmcgPSBmYWxzZTsKICAgIHRoaXMubG9ja0FjcXVpcmVkID0gZmFsc2U7CiAgICB0aGlzLnBlbmRpbmdJbkxvY2sgPSBbXTsKICAgIHRoaXMuYnJvYWRjYXN0Q2hhbm5lbCA9IG51bGw7CiAgICB0aGlzLmxvZ2dlciA9IGNvbnNvbGUubG9nOwogICAgY29uc3Qgc2V0dGluZ3MgPSBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIERFRkFVTFRfT1BUSU9OUyksIG9wdGlvbnMpOwogICAgdGhpcy5zdG9yYWdlS2V5ID0gc2V0dGluZ3Muc3RvcmFnZUtleTsKICAgIHRoaXMuaW5zdGFuY2VJRCA9IChfYSA9IF9Hb1RydWVDbGllbnQubmV4dEluc3RhbmNlSURbdGhpcy5zdG9yYWdlS2V5XSkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogMDsKICAgIF9Hb1RydWVDbGllbnQubmV4dEluc3RhbmNlSURbdGhpcy5zdG9yYWdlS2V5XSA9IHRoaXMuaW5zdGFuY2VJRCArIDE7CiAgICB0aGlzLmxvZ0RlYnVnTWVzc2FnZXMgPSAhIXNldHRpbmdzLmRlYnVnOwogICAgaWYgKHR5cGVvZiBzZXR0aW5ncy5kZWJ1ZyA9PT0gImZ1bmN0aW9uIikgewogICAgICB0aGlzLmxvZ2dlciA9IHNldHRpbmdzLmRlYnVnOwogICAgfQogICAgaWYgKHRoaXMuaW5zdGFuY2VJRCA+IDAgJiYgaXNCcm93c2VyKCkpIHsKICAgICAgY29uc3QgbWVzc2FnZSA9IGAke3RoaXMuX2xvZ1ByZWZpeCgpfSBNdWx0aXBsZSBHb1RydWVDbGllbnQgaW5zdGFuY2VzIGRldGVjdGVkIGluIHRoZSBzYW1lIGJyb3dzZXIgY29udGV4dC4gSXQgaXMgbm90IGFuIGVycm9yLCBidXQgdGhpcyBzaG91bGQgYmUgYXZvaWRlZCBhcyBpdCBtYXkgcHJvZHVjZSB1bmRlZmluZWQgYmVoYXZpb3Igd2hlbiB1c2VkIGNvbmN1cnJlbnRseSB1bmRlciB0aGUgc2FtZSBzdG9yYWdlIGtleS5gOwogICAgICBjb25zb2xlLndhcm4obWVzc2FnZSk7CiAgICAgIGlmICh0aGlzLmxvZ0RlYnVnTWVzc2FnZXMpIHsKICAgICAgICBjb25zb2xlLnRyYWNlKG1lc3NhZ2UpOwogICAgICB9CiAgICB9CiAgICB0aGlzLnBlcnNpc3RTZXNzaW9uID0gc2V0dGluZ3MucGVyc2lzdFNlc3Npb247CiAgICB0aGlzLmF1dG9SZWZyZXNoVG9rZW4gPSBzZXR0aW5ncy5hdXRvUmVmcmVzaFRva2VuOwogICAgdGhpcy5hZG1pbiA9IG5ldyBHb1RydWVBZG1pbkFwaSh7CiAgICAgIHVybDogc2V0dGluZ3MudXJsLAogICAgICBoZWFkZXJzOiBzZXR0aW5ncy5oZWFkZXJzLAogICAgICBmZXRjaDogc2V0dGluZ3MuZmV0Y2gKICAgIH0pOwogICAgdGhpcy51cmwgPSBzZXR0aW5ncy51cmw7CiAgICB0aGlzLmhlYWRlcnMgPSBzZXR0aW5ncy5oZWFkZXJzOwogICAgdGhpcy5mZXRjaCA9IHJlc29sdmVGZXRjaDMoc2V0dGluZ3MuZmV0Y2gpOwogICAgdGhpcy5sb2NrID0gc2V0dGluZ3MubG9jayB8fCBsb2NrTm9PcDsKICAgIHRoaXMuZGV0ZWN0U2Vzc2lvbkluVXJsID0gc2V0dGluZ3MuZGV0ZWN0U2Vzc2lvbkluVXJsOwogICAgdGhpcy5mbG93VHlwZSA9IHNldHRpbmdzLmZsb3dUeXBlOwogICAgdGhpcy5oYXNDdXN0b21BdXRob3JpemF0aW9uSGVhZGVyID0gc2V0dGluZ3MuaGFzQ3VzdG9tQXV0aG9yaXphdGlvbkhlYWRlcjsKICAgIHRoaXMudGhyb3dPbkVycm9yID0gc2V0dGluZ3MudGhyb3dPbkVycm9yOwogICAgdGhpcy5sb2NrQWNxdWlyZVRpbWVvdXQgPSBzZXR0aW5ncy5sb2NrQWNxdWlyZVRpbWVvdXQ7CiAgICBpZiAoc2V0dGluZ3MubG9jaykgewogICAgICB0aGlzLmxvY2sgPSBzZXR0aW5ncy5sb2NrOwogICAgfSBlbHNlIGlmICh0aGlzLnBlcnNpc3RTZXNzaW9uICYmIGlzQnJvd3NlcigpICYmICgoX2IgPSBnbG9iYWxUaGlzID09PSBudWxsIHx8IGdsb2JhbFRoaXMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGdsb2JhbFRoaXMubmF2aWdhdG9yKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IubG9ja3MpKSB7CiAgICAgIHRoaXMubG9jayA9IG5hdmlnYXRvckxvY2s7CiAgICB9IGVsc2UgewogICAgICB0aGlzLmxvY2sgPSBsb2NrTm9PcDsKICAgIH0KICAgIGlmICghdGhpcy5qd2tzKSB7CiAgICAgIHRoaXMuandrcyA9IHsga2V5czogW10gfTsKICAgICAgdGhpcy5qd2tzX2NhY2hlZF9hdCA9IE51bWJlci5NSU5fU0FGRV9JTlRFR0VSOwogICAgfQogICAgdGhpcy5tZmEgPSB7CiAgICAgIHZlcmlmeTogdGhpcy5fdmVyaWZ5LmJpbmQodGhpcyksCiAgICAgIGVucm9sbDogdGhpcy5fZW5yb2xsLmJpbmQodGhpcyksCiAgICAgIHVuZW5yb2xsOiB0aGlzLl91bmVucm9sbC5iaW5kKHRoaXMpLAogICAgICBjaGFsbGVuZ2U6IHRoaXMuX2NoYWxsZW5nZS5iaW5kKHRoaXMpLAogICAgICBsaXN0RmFjdG9yczogdGhpcy5fbGlzdEZhY3RvcnMuYmluZCh0aGlzKSwKICAgICAgY2hhbGxlbmdlQW5kVmVyaWZ5OiB0aGlzLl9jaGFsbGVuZ2VBbmRWZXJpZnkuYmluZCh0aGlzKSwKICAgICAgZ2V0QXV0aGVudGljYXRvckFzc3VyYW5jZUxldmVsOiB0aGlzLl9nZXRBdXRoZW50aWNhdG9yQXNzdXJhbmNlTGV2ZWwuYmluZCh0aGlzKSwKICAgICAgd2ViYXV0aG46IG5ldyBXZWJBdXRobkFwaSh0aGlzKQogICAgfTsKICAgIHRoaXMub2F1dGggPSB7CiAgICAgIGdldEF1dGhvcml6YXRpb25EZXRhaWxzOiB0aGlzLl9nZXRBdXRob3JpemF0aW9uRGV0YWlscy5iaW5kKHRoaXMpLAogICAgICBhcHByb3ZlQXV0aG9yaXphdGlvbjogdGhpcy5fYXBwcm92ZUF1dGhvcml6YXRpb24uYmluZCh0aGlzKSwKICAgICAgZGVueUF1dGhvcml6YXRpb246IHRoaXMuX2RlbnlBdXRob3JpemF0aW9uLmJpbmQodGhpcyksCiAgICAgIGxpc3RHcmFudHM6IHRoaXMuX2xpc3RPQXV0aEdyYW50cy5iaW5kKHRoaXMpLAogICAgICByZXZva2VHcmFudDogdGhpcy5fcmV2b2tlT0F1dGhHcmFudC5iaW5kKHRoaXMpCiAgICB9OwogICAgaWYgKHRoaXMucGVyc2lzdFNlc3Npb24pIHsKICAgICAgaWYgKHNldHRpbmdzLnN0b3JhZ2UpIHsKICAgICAgICB0aGlzLnN0b3JhZ2UgPSBzZXR0aW5ncy5zdG9yYWdlOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChzdXBwb3J0c0xvY2FsU3RvcmFnZSgpKSB7CiAgICAgICAgICB0aGlzLnN0b3JhZ2UgPSBnbG9iYWxUaGlzLmxvY2FsU3RvcmFnZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5tZW1vcnlTdG9yYWdlID0ge307CiAgICAgICAgICB0aGlzLnN0b3JhZ2UgPSBtZW1vcnlMb2NhbFN0b3JhZ2VBZGFwdGVyKHRoaXMubWVtb3J5U3RvcmFnZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChzZXR0aW5ncy51c2VyU3RvcmFnZSkgewogICAgICAgIHRoaXMudXNlclN0b3JhZ2UgPSBzZXR0aW5ncy51c2VyU3RvcmFnZTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5tZW1vcnlTdG9yYWdlID0ge307CiAgICAgIHRoaXMuc3RvcmFnZSA9IG1lbW9yeUxvY2FsU3RvcmFnZUFkYXB0ZXIodGhpcy5tZW1vcnlTdG9yYWdlKTsKICAgIH0KICAgIGlmIChpc0Jyb3dzZXIoKSAmJiBnbG9iYWxUaGlzLkJyb2FkY2FzdENoYW5uZWwgJiYgdGhpcy5wZXJzaXN0U2Vzc2lvbiAmJiB0aGlzLnN0b3JhZ2VLZXkpIHsKICAgICAgdHJ5IHsKICAgICAgICB0aGlzLmJyb2FkY2FzdENoYW5uZWwgPSBuZXcgZ2xvYmFsVGhpcy5Ccm9hZGNhc3RDaGFubmVsKHRoaXMuc3RvcmFnZUtleSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCJGYWlsZWQgdG8gY3JlYXRlIGEgbmV3IEJyb2FkY2FzdENoYW5uZWwsIG11bHRpLXRhYiBzdGF0ZSBjaGFuZ2VzIHdpbGwgbm90IGJlIGF2YWlsYWJsZSIsIGUpOwogICAgICB9CiAgICAgIChfYyA9IHRoaXMuYnJvYWRjYXN0Q2hhbm5lbCkgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmFkZEV2ZW50TGlzdGVuZXIoIm1lc3NhZ2UiLCBhc3luYyAoZXZlbnQpID0+IHsKICAgICAgICB0aGlzLl9kZWJ1ZygicmVjZWl2ZWQgYnJvYWRjYXN0IG5vdGlmaWNhdGlvbiBmcm9tIG90aGVyIHRhYiBvciBjbGllbnQiLCBldmVudCk7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGF3YWl0IHRoaXMuX25vdGlmeUFsbFN1YnNjcmliZXJzKGV2ZW50LmRhdGEuZXZlbnQsIGV2ZW50LmRhdGEuc2Vzc2lvbiwgZmFsc2UpOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICB0aGlzLl9kZWJ1ZygiI2Jyb2FkY2FzdENoYW5uZWwiLCAiZXJyb3IiLCBlcnJvcik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIGlmICghc2V0dGluZ3Muc2tpcEF1dG9Jbml0aWFsaXplKSB7CiAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpLmNhdGNoKChlcnJvcikgPT4gewogICAgICAgIHRoaXMuX2RlYnVnKCIjaW5pdGlhbGl6ZSgpIiwgImVycm9yIiwgZXJyb3IpOwogICAgICB9KTsKICAgIH0KICB9CiAgLyoqCiAgICogUmV0dXJucyB3aGV0aGVyIGVycm9yIHRocm93aW5nIG1vZGUgaXMgZW5hYmxlZCBmb3IgdGhpcyBjbGllbnQuCiAgICovCiAgaXNUaHJvd09uRXJyb3JFbmFibGVkKCkgewogICAgcmV0dXJuIHRoaXMudGhyb3dPbkVycm9yOwogIH0KICAvKioKICAgKiBDZW50cmFsaXplcyByZXR1cm4gaGFuZGxpbmcgd2l0aCBvcHRpb25hbCBlcnJvciB0aHJvd2luZy4gV2hlbiBgdGhyb3dPbkVycm9yYCBpcyBlbmFibGVkCiAgICogYW5kIHRoZSBwcm92aWRlZCByZXN1bHQgY29udGFpbnMgYSBub24tbnVsbGlzaCBlcnJvciwgdGhlIGVycm9yIGlzIHRocm93biBpbnN0ZWFkIG9mCiAgICogYmVpbmcgcmV0dXJuZWQuIFRoaXMgZW5zdXJlcyBjb25zaXN0ZW50IGJlaGF2aW9yIGFjcm9zcyBhbGwgcHVibGljIEFQSSBtZXRob2RzLgogICAqLwogIF9yZXR1cm5SZXN1bHQocmVzdWx0KSB7CiAgICBpZiAodGhpcy50aHJvd09uRXJyb3IgJiYgcmVzdWx0ICYmIHJlc3VsdC5lcnJvcikgewogICAgICB0aHJvdyByZXN1bHQuZXJyb3I7CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH0KICBfbG9nUHJlZml4KCkgewogICAgcmV0dXJuIGBHb1RydWVDbGllbnRAJHt0aGlzLnN0b3JhZ2VLZXl9OiR7dGhpcy5pbnN0YW5jZUlEfSAoJHt2ZXJzaW9uNH0pICR7KC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS50b0lTT1N0cmluZygpfWA7CiAgfQogIF9kZWJ1ZyguLi5hcmdzKSB7CiAgICBpZiAodGhpcy5sb2dEZWJ1Z01lc3NhZ2VzKSB7CiAgICAgIHRoaXMubG9nZ2VyKHRoaXMuX2xvZ1ByZWZpeCgpLCAuLi5hcmdzKTsKICAgIH0KICAgIHJldHVybiB0aGlzOwogIH0KICAvKioKICAgKiBJbml0aWFsaXplcyB0aGUgY2xpZW50IHNlc3Npb24gZWl0aGVyIGZyb20gdGhlIHVybCBvciBmcm9tIHN0b3JhZ2UuCiAgICogVGhpcyBtZXRob2QgaXMgYXV0b21hdGljYWxseSBjYWxsZWQgd2hlbiBpbnN0YW50aWF0aW5nIHRoZSBjbGllbnQsIGJ1dCBzaG91bGQgYWxzbyBiZSBjYWxsZWQKICAgKiBtYW51YWxseSB3aGVuIGNoZWNraW5nIGZvciBhbiBlcnJvciBmcm9tIGFuIGF1dGggcmVkaXJlY3QgKG9hdXRoLCBtYWdpY2xpbmssIHBhc3N3b3JkIHJlY292ZXJ5LCBldGMpLgogICAqLwogIGFzeW5jIGluaXRpYWxpemUoKSB7CiAgICBpZiAodGhpcy5pbml0aWFsaXplUHJvbWlzZSkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5pbml0aWFsaXplUHJvbWlzZTsKICAgIH0KICAgIHRoaXMuaW5pdGlhbGl6ZVByb21pc2UgPSAoYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fYWNxdWlyZUxvY2sodGhpcy5sb2NrQWNxdWlyZVRpbWVvdXQsIGFzeW5jICgpID0+IHsKICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5faW5pdGlhbGl6ZSgpOwogICAgICB9KTsKICAgIH0pKCk7CiAgICByZXR1cm4gYXdhaXQgdGhpcy5pbml0aWFsaXplUHJvbWlzZTsKICB9CiAgLyoqCiAgICogSU1QT1JUQU5UOgogICAqIDEuIE5ldmVyIHRocm93IGluIHRoaXMgbWV0aG9kLCBhcyBpdCBpcyBjYWxsZWQgZnJvbSB0aGUgY29uc3RydWN0b3IKICAgKiAyLiBOZXZlciByZXR1cm4gYSBzZXNzaW9uIGZyb20gdGhpcyBtZXRob2QgYXMgaXQgd291bGQgYmUgY2FjaGVkIG92ZXIKICAgKiAgICB0aGUgd2hvbGUgbGlmZXRpbWUgb2YgdGhlIGNsaWVudAogICAqLwogIGFzeW5jIF9pbml0aWFsaXplKCkgewogICAgdmFyIF9hOwogICAgdHJ5IHsKICAgICAgbGV0IHBhcmFtcyA9IHt9OwogICAgICBsZXQgY2FsbGJhY2tVcmxUeXBlID0gIm5vbmUiOwogICAgICBpZiAoaXNCcm93c2VyKCkpIHsKICAgICAgICBwYXJhbXMgPSBwYXJzZVBhcmFtZXRlcnNGcm9tVVJMKHdpbmRvdy5sb2NhdGlvbi5ocmVmKTsKICAgICAgICBpZiAodGhpcy5faXNJbXBsaWNpdEdyYW50Q2FsbGJhY2socGFyYW1zKSkgewogICAgICAgICAgY2FsbGJhY2tVcmxUeXBlID0gImltcGxpY2l0IjsKICAgICAgICB9IGVsc2UgaWYgKGF3YWl0IHRoaXMuX2lzUEtDRUNhbGxiYWNrKHBhcmFtcykpIHsKICAgICAgICAgIGNhbGxiYWNrVXJsVHlwZSA9ICJwa2NlIjsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKGlzQnJvd3NlcigpICYmIHRoaXMuZGV0ZWN0U2Vzc2lvbkluVXJsICYmIGNhbGxiYWNrVXJsVHlwZSAhPT0gIm5vbmUiKSB7CiAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgdGhpcy5fZ2V0U2Vzc2lvbkZyb21VUkwocGFyYW1zLCBjYWxsYmFja1VybFR5cGUpOwogICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgdGhpcy5fZGVidWcoIiNfaW5pdGlhbGl6ZSgpIiwgImVycm9yIGRldGVjdGluZyBzZXNzaW9uIGZyb20gVVJMIiwgZXJyb3IpOwogICAgICAgICAgaWYgKGlzQXV0aEltcGxpY2l0R3JhbnRSZWRpcmVjdEVycm9yKGVycm9yKSkgewogICAgICAgICAgICBjb25zdCBlcnJvckNvZGUgPSAoX2EgPSBlcnJvci5kZXRhaWxzKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuY29kZTsKICAgICAgICAgICAgaWYgKGVycm9yQ29kZSA9PT0gImlkZW50aXR5X2FscmVhZHlfZXhpc3RzIiB8fCBlcnJvckNvZGUgPT09ICJpZGVudGl0eV9ub3RfZm91bmQiIHx8IGVycm9yQ29kZSA9PT0gInNpbmdsZV9pZGVudGl0eV9ub3RfZGVsZXRhYmxlIikgewogICAgICAgICAgICAgIHJldHVybiB7IGVycm9yIH07CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB7IGVycm9yIH07CiAgICAgICAgfQogICAgICAgIGNvbnN0IHsgc2Vzc2lvbiwgcmVkaXJlY3RUeXBlIH0gPSBkYXRhOwogICAgICAgIHRoaXMuX2RlYnVnKCIjX2luaXRpYWxpemUoKSIsICJkZXRlY3RlZCBzZXNzaW9uIGluIFVSTCIsIHNlc3Npb24sICJyZWRpcmVjdCB0eXBlIiwgcmVkaXJlY3RUeXBlKTsKICAgICAgICBhd2FpdCB0aGlzLl9zYXZlU2Vzc2lvbihzZXNzaW9uKTsKICAgICAgICBzZXRUaW1lb3V0KGFzeW5jICgpID0+IHsKICAgICAgICAgIGlmIChyZWRpcmVjdFR5cGUgPT09ICJyZWNvdmVyeSIpIHsKICAgICAgICAgICAgYXdhaXQgdGhpcy5fbm90aWZ5QWxsU3Vic2NyaWJlcnMoIlBBU1NXT1JEX1JFQ09WRVJZIiwgc2Vzc2lvbik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhd2FpdCB0aGlzLl9ub3RpZnlBbGxTdWJzY3JpYmVycygiU0lHTkVEX0lOIiwgc2Vzc2lvbik7CiAgICAgICAgICB9CiAgICAgICAgfSwgMCk7CiAgICAgICAgcmV0dXJuIHsgZXJyb3I6IG51bGwgfTsKICAgICAgfQogICAgICBhd2FpdCB0aGlzLl9yZWNvdmVyQW5kUmVmcmVzaCgpOwogICAgICByZXR1cm4geyBlcnJvcjogbnVsbCB9OwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBlcnJvciB9KTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsKICAgICAgICBlcnJvcjogbmV3IEF1dGhVbmtub3duRXJyb3IoIlVuZXhwZWN0ZWQgZXJyb3IgZHVyaW5nIGluaXRpYWxpemF0aW9uIiwgZXJyb3IpCiAgICAgIH0pOwogICAgfSBmaW5hbGx5IHsKICAgICAgYXdhaXQgdGhpcy5faGFuZGxlVmlzaWJpbGl0eUNoYW5nZSgpOwogICAgICB0aGlzLl9kZWJ1ZygiI19pbml0aWFsaXplKCkiLCAiZW5kIik7CiAgICB9CiAgfQogIC8qKgogICAqIENyZWF0ZXMgYSBuZXcgYW5vbnltb3VzIHVzZXIuCiAgICoKICAgKiBAcmV0dXJucyBBIHNlc3Npb24gd2hlcmUgdGhlIGlzX2Fub255bW91cyBjbGFpbSBpbiB0aGUgYWNjZXNzIHRva2VuIEpXVCBzZXQgdG8gdHJ1ZQogICAqLwogIGFzeW5jIHNpZ25JbkFub255bW91c2x5KGNyZWRlbnRpYWxzKSB7CiAgICB2YXIgX2EsIF9iLCBfYzsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L3NpZ251cGAsIHsKICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgYm9keTogewogICAgICAgICAgZGF0YTogKF9iID0gKF9hID0gY3JlZGVudGlhbHMgPT09IG51bGwgfHwgY3JlZGVudGlhbHMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNyZWRlbnRpYWxzLm9wdGlvbnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5kYXRhKSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiB7fSwKICAgICAgICAgIGdvdHJ1ZV9tZXRhX3NlY3VyaXR5OiB7IGNhcHRjaGFfdG9rZW46IChfYyA9IGNyZWRlbnRpYWxzID09PSBudWxsIHx8IGNyZWRlbnRpYWxzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBjcmVkZW50aWFscy5vcHRpb25zKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MuY2FwdGNoYVRva2VuIH0KICAgICAgICB9LAogICAgICAgIHhmb3JtOiBfc2Vzc2lvblJlc3BvbnNlCiAgICAgIH0pOwogICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSByZXM7CiAgICAgIGlmIChlcnJvciB8fCAhZGF0YSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgY29uc3Qgc2Vzc2lvbiA9IGRhdGEuc2Vzc2lvbjsKICAgICAgY29uc3QgdXNlciA9IGRhdGEudXNlcjsKICAgICAgaWYgKGRhdGEuc2Vzc2lvbikgewogICAgICAgIGF3YWl0IHRoaXMuX3NhdmVTZXNzaW9uKGRhdGEuc2Vzc2lvbik7CiAgICAgICAgYXdhaXQgdGhpcy5fbm90aWZ5QWxsU3Vic2NyaWJlcnMoIlNJR05FRF9JTiIsIHNlc3Npb24pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXIsIHNlc3Npb24gfSwgZXJyb3I6IG51bGwgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogQ3JlYXRlcyBhIG5ldyB1c2VyLgogICAqCiAgICogQmUgYXdhcmUgdGhhdCBpZiBhIHVzZXIgYWNjb3VudCBleGlzdHMgaW4gdGhlIHN5c3RlbSB5b3UgbWF5IGdldCBiYWNrIGFuCiAgICogZXJyb3IgbWVzc2FnZSB0aGF0IGF0dGVtcHRzIHRvIGhpZGUgdGhpcyBpbmZvcm1hdGlvbiBmcm9tIHRoZSB1c2VyLgogICAqIFRoaXMgbWV0aG9kIGhhcyBzdXBwb3J0IGZvciBQS0NFIHZpYSBlbWFpbCBzaWdudXBzLiBUaGUgUEtDRSBmbG93IGNhbm5vdCBiZSB1c2VkIHdoZW4gYXV0b2NvbmZpcm0gaXMgZW5hYmxlZC4KICAgKgogICAqIEByZXR1cm5zIEEgbG9nZ2VkLWluIHNlc3Npb24gaWYgdGhlIHNlcnZlciBoYXMgImF1dG9jb25maXJtIiBPTgogICAqIEByZXR1cm5zIEEgdXNlciBpZiB0aGUgc2VydmVyIGhhcyAiYXV0b2NvbmZpcm0iIE9GRgogICAqLwogIGFzeW5jIHNpZ25VcChjcmVkZW50aWFscykgewogICAgdmFyIF9hLCBfYiwgX2M7CiAgICB0cnkgewogICAgICBsZXQgcmVzOwogICAgICBpZiAoImVtYWlsIiBpbiBjcmVkZW50aWFscykgewogICAgICAgIGNvbnN0IHsgZW1haWwsIHBhc3N3b3JkLCBvcHRpb25zIH0gPSBjcmVkZW50aWFsczsKICAgICAgICBsZXQgY29kZUNoYWxsZW5nZSA9IG51bGw7CiAgICAgICAgbGV0IGNvZGVDaGFsbGVuZ2VNZXRob2QgPSBudWxsOwogICAgICAgIGlmICh0aGlzLmZsb3dUeXBlID09PSAicGtjZSIpIHsKICAgICAgICAgIDsKICAgICAgICAgIFtjb2RlQ2hhbGxlbmdlLCBjb2RlQ2hhbGxlbmdlTWV0aG9kXSA9IGF3YWl0IGdldENvZGVDaGFsbGVuZ2VBbmRNZXRob2QodGhpcy5zdG9yYWdlLCB0aGlzLnN0b3JhZ2VLZXkpOwogICAgICAgIH0KICAgICAgICByZXMgPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGAke3RoaXMudXJsfS9zaWdudXBgLCB7CiAgICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgICByZWRpcmVjdFRvOiBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuZW1haWxSZWRpcmVjdFRvLAogICAgICAgICAgYm9keTogewogICAgICAgICAgICBlbWFpbCwKICAgICAgICAgICAgcGFzc3dvcmQsCiAgICAgICAgICAgIGRhdGE6IChfYSA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5kYXRhKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiB7fSwKICAgICAgICAgICAgZ290cnVlX21ldGFfc2VjdXJpdHk6IHsgY2FwdGNoYV90b2tlbjogb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmNhcHRjaGFUb2tlbiB9LAogICAgICAgICAgICBjb2RlX2NoYWxsZW5nZTogY29kZUNoYWxsZW5nZSwKICAgICAgICAgICAgY29kZV9jaGFsbGVuZ2VfbWV0aG9kOiBjb2RlQ2hhbGxlbmdlTWV0aG9kCiAgICAgICAgICB9LAogICAgICAgICAgeGZvcm06IF9zZXNzaW9uUmVzcG9uc2UKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICgicGhvbmUiIGluIGNyZWRlbnRpYWxzKSB7CiAgICAgICAgY29uc3QgeyBwaG9uZSwgcGFzc3dvcmQsIG9wdGlvbnMgfSA9IGNyZWRlbnRpYWxzOwogICAgICAgIHJlcyA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L3NpZ251cGAsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGJvZHk6IHsKICAgICAgICAgICAgcGhvbmUsCiAgICAgICAgICAgIHBhc3N3b3JkLAogICAgICAgICAgICBkYXRhOiAoX2IgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuZGF0YSkgIT09IG51bGwgJiYgX2IgIT09IHZvaWQgMCA/IF9iIDoge30sCiAgICAgICAgICAgIGNoYW5uZWw6IChfYyA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5jaGFubmVsKSAhPT0gbnVsbCAmJiBfYyAhPT0gdm9pZCAwID8gX2MgOiAic21zIiwKICAgICAgICAgICAgZ290cnVlX21ldGFfc2VjdXJpdHk6IHsgY2FwdGNoYV90b2tlbjogb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmNhcHRjaGFUb2tlbiB9CiAgICAgICAgICB9LAogICAgICAgICAgeGZvcm06IF9zZXNzaW9uUmVzcG9uc2UKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgQXV0aEludmFsaWRDcmVkZW50aWFsc0Vycm9yKCJZb3UgbXVzdCBwcm92aWRlIGVpdGhlciBhbiBlbWFpbCBvciBwaG9uZSBudW1iZXIgYW5kIGEgcGFzc3dvcmQiKTsKICAgICAgfQogICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSByZXM7CiAgICAgIGlmIChlcnJvciB8fCAhZGF0YSkgewogICAgICAgIGF3YWl0IHJlbW92ZUl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIGAke3RoaXMuc3RvcmFnZUtleX0tY29kZS12ZXJpZmllcmApOwogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgY29uc3Qgc2Vzc2lvbiA9IGRhdGEuc2Vzc2lvbjsKICAgICAgY29uc3QgdXNlciA9IGRhdGEudXNlcjsKICAgICAgaWYgKGRhdGEuc2Vzc2lvbikgewogICAgICAgIGF3YWl0IHRoaXMuX3NhdmVTZXNzaW9uKGRhdGEuc2Vzc2lvbik7CiAgICAgICAgYXdhaXQgdGhpcy5fbm90aWZ5QWxsU3Vic2NyaWJlcnMoIlNJR05FRF9JTiIsIHNlc3Npb24pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXIsIHNlc3Npb24gfSwgZXJyb3I6IG51bGwgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBhd2FpdCByZW1vdmVJdGVtQXN5bmModGhpcy5zdG9yYWdlLCBgJHt0aGlzLnN0b3JhZ2VLZXl9LWNvZGUtdmVyaWZpZXJgKTsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIExvZyBpbiBhbiBleGlzdGluZyB1c2VyIHdpdGggYW4gZW1haWwgYW5kIHBhc3N3b3JkIG9yIHBob25lIGFuZCBwYXNzd29yZC4KICAgKgogICAqIEJlIGF3YXJlIHRoYXQgeW91IG1heSBnZXQgYmFjayBhbiBlcnJvciBtZXNzYWdlIHRoYXQgd2lsbCBub3QgZGlzdGluZ3Vpc2gKICAgKiBiZXR3ZWVuIHRoZSBjYXNlcyB3aGVyZSB0aGUgYWNjb3VudCBkb2VzIG5vdCBleGlzdCBvciB0aGF0IHRoZQogICAqIGVtYWlsL3Bob25lIGFuZCBwYXNzd29yZCBjb21iaW5hdGlvbiBpcyB3cm9uZyBvciB0aGF0IHRoZSBhY2NvdW50IGNhbiBvbmx5CiAgICogYmUgYWNjZXNzZWQgdmlhIHNvY2lhbCBsb2dpbi4KICAgKi8KICBhc3luYyBzaWduSW5XaXRoUGFzc3dvcmQoY3JlZGVudGlhbHMpIHsKICAgIHRyeSB7CiAgICAgIGxldCByZXM7CiAgICAgIGlmICgiZW1haWwiIGluIGNyZWRlbnRpYWxzKSB7CiAgICAgICAgY29uc3QgeyBlbWFpbCwgcGFzc3dvcmQsIG9wdGlvbnMgfSA9IGNyZWRlbnRpYWxzOwogICAgICAgIHJlcyA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L3Rva2VuP2dyYW50X3R5cGU9cGFzc3dvcmRgLCB7CiAgICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgICBib2R5OiB7CiAgICAgICAgICAgIGVtYWlsLAogICAgICAgICAgICBwYXNzd29yZCwKICAgICAgICAgICAgZ290cnVlX21ldGFfc2VjdXJpdHk6IHsgY2FwdGNoYV90b2tlbjogb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmNhcHRjaGFUb2tlbiB9CiAgICAgICAgICB9LAogICAgICAgICAgeGZvcm06IF9zZXNzaW9uUmVzcG9uc2VQYXNzd29yZAogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKCJwaG9uZSIgaW4gY3JlZGVudGlhbHMpIHsKICAgICAgICBjb25zdCB7IHBob25lLCBwYXNzd29yZCwgb3B0aW9ucyB9ID0gY3JlZGVudGlhbHM7CiAgICAgICAgcmVzID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vdG9rZW4/Z3JhbnRfdHlwZT1wYXNzd29yZGAsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGJvZHk6IHsKICAgICAgICAgICAgcGhvbmUsCiAgICAgICAgICAgIHBhc3N3b3JkLAogICAgICAgICAgICBnb3RydWVfbWV0YV9zZWN1cml0eTogeyBjYXB0Y2hhX3Rva2VuOiBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuY2FwdGNoYVRva2VuIH0KICAgICAgICAgIH0sCiAgICAgICAgICB4Zm9ybTogX3Nlc3Npb25SZXNwb25zZVBhc3N3b3JkCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEF1dGhJbnZhbGlkQ3JlZGVudGlhbHNFcnJvcigiWW91IG11c3QgcHJvdmlkZSBlaXRoZXIgYW4gZW1haWwgb3IgcGhvbmUgbnVtYmVyIGFuZCBhIHBhc3N3b3JkIik7CiAgICAgIH0KICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gcmVzOwogICAgICBpZiAoZXJyb3IpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9IGVsc2UgaWYgKCFkYXRhIHx8ICFkYXRhLnNlc3Npb24gfHwgIWRhdGEudXNlcikgewogICAgICAgIGNvbnN0IGludmFsaWRUb2tlbkVycm9yID0gbmV3IEF1dGhJbnZhbGlkVG9rZW5SZXNwb25zZUVycm9yKCk7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvcjogaW52YWxpZFRva2VuRXJyb3IgfSk7CiAgICAgIH0KICAgICAgaWYgKGRhdGEuc2Vzc2lvbikgewogICAgICAgIGF3YWl0IHRoaXMuX3NhdmVTZXNzaW9uKGRhdGEuc2Vzc2lvbik7CiAgICAgICAgYXdhaXQgdGhpcy5fbm90aWZ5QWxsU3Vic2NyaWJlcnMoIlNJR05FRF9JTiIsIGRhdGEuc2Vzc2lvbik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7CiAgICAgICAgZGF0YTogT2JqZWN0LmFzc2lnbih7IHVzZXI6IGRhdGEudXNlciwgc2Vzc2lvbjogZGF0YS5zZXNzaW9uIH0sIGRhdGEud2Vha19wYXNzd29yZCA/IHsgd2Vha1Bhc3N3b3JkOiBkYXRhLndlYWtfcGFzc3dvcmQgfSA6IG51bGwpLAogICAgICAgIGVycm9yCiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIExvZyBpbiBhbiBleGlzdGluZyB1c2VyIHZpYSBhIHRoaXJkLXBhcnR5IHByb3ZpZGVyLgogICAqIFRoaXMgbWV0aG9kIHN1cHBvcnRzIHRoZSBQS0NFIGZsb3cuCiAgICovCiAgYXN5bmMgc2lnbkluV2l0aE9BdXRoKGNyZWRlbnRpYWxzKSB7CiAgICB2YXIgX2EsIF9iLCBfYywgX2Q7CiAgICByZXR1cm4gYXdhaXQgdGhpcy5faGFuZGxlUHJvdmlkZXJTaWduSW4oY3JlZGVudGlhbHMucHJvdmlkZXIsIHsKICAgICAgcmVkaXJlY3RUbzogKF9hID0gY3JlZGVudGlhbHMub3B0aW9ucykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLnJlZGlyZWN0VG8sCiAgICAgIHNjb3BlczogKF9iID0gY3JlZGVudGlhbHMub3B0aW9ucykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnNjb3BlcywKICAgICAgcXVlcnlQYXJhbXM6IChfYyA9IGNyZWRlbnRpYWxzLm9wdGlvbnMpID09PSBudWxsIHx8IF9jID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYy5xdWVyeVBhcmFtcywKICAgICAgc2tpcEJyb3dzZXJSZWRpcmVjdDogKF9kID0gY3JlZGVudGlhbHMub3B0aW9ucykgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kLnNraXBCcm93c2VyUmVkaXJlY3QKICAgIH0pOwogIH0KICAvKioKICAgKiBMb2cgaW4gYW4gZXhpc3RpbmcgdXNlciBieSBleGNoYW5naW5nIGFuIEF1dGggQ29kZSBpc3N1ZWQgZHVyaW5nIHRoZSBQS0NFIGZsb3cuCiAgICovCiAgYXN5bmMgZXhjaGFuZ2VDb2RlRm9yU2Vzc2lvbihhdXRoQ29kZSkgewogICAgYXdhaXQgdGhpcy5pbml0aWFsaXplUHJvbWlzZTsKICAgIHJldHVybiB0aGlzLl9hY3F1aXJlTG9jayh0aGlzLmxvY2tBY3F1aXJlVGltZW91dCwgYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gdGhpcy5fZXhjaGFuZ2VDb2RlRm9yU2Vzc2lvbihhdXRoQ29kZSk7CiAgICB9KTsKICB9CiAgLyoqCiAgICogU2lnbnMgaW4gYSB1c2VyIGJ5IHZlcmlmeWluZyBhIG1lc3NhZ2Ugc2lnbmVkIGJ5IHRoZSB1c2VyJ3MgcHJpdmF0ZSBrZXkuCiAgICogU3VwcG9ydHMgRXRoZXJldW0gKHZpYSBTaWduLUluLVdpdGgtRXRoZXJldW0pICYgU29sYW5hIChTaWduLUluLVdpdGgtU29sYW5hKSBzdGFuZGFyZHMsCiAgICogYm90aCBvZiB3aGljaCBkZXJpdmUgZnJvbSB0aGUgRUlQLTQzNjEgc3RhbmRhcmQKICAgKiBXaXRoIHNsaWdodCB2YXJpYXRpb24gb24gU29sYW5hJ3Mgc2lkZS4KICAgKiBAcmVmZXJlbmNlIGh0dHBzOi8vZWlwcy5ldGhlcmV1bS5vcmcvRUlQUy9laXAtNDM2MQogICAqLwogIGFzeW5jIHNpZ25JbldpdGhXZWIzKGNyZWRlbnRpYWxzKSB7CiAgICBjb25zdCB7IGNoYWluIH0gPSBjcmVkZW50aWFsczsKICAgIHN3aXRjaCAoY2hhaW4pIHsKICAgICAgY2FzZSAiZXRoZXJldW0iOgogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnNpZ25JbldpdGhFdGhlcmV1bShjcmVkZW50aWFscyk7CiAgICAgIGNhc2UgInNvbGFuYSI6CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc2lnbkluV2l0aFNvbGFuYShjcmVkZW50aWFscyk7CiAgICAgIGRlZmF1bHQ6CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBAc3VwYWJhc2UvYXV0aC1qczogVW5zdXBwb3J0ZWQgY2hhaW4gIiR7Y2hhaW59ImApOwogICAgfQogIH0KICBhc3luYyBzaWduSW5XaXRoRXRoZXJldW0oY3JlZGVudGlhbHMpIHsKICAgIHZhciBfYSwgX2IsIF9jLCBfZCwgX2UsIF9mLCBfZywgX2gsIF9qLCBfaywgX2w7CiAgICBsZXQgbWVzc2FnZTsKICAgIGxldCBzaWduYXR1cmU7CiAgICBpZiAoIm1lc3NhZ2UiIGluIGNyZWRlbnRpYWxzKSB7CiAgICAgIG1lc3NhZ2UgPSBjcmVkZW50aWFscy5tZXNzYWdlOwogICAgICBzaWduYXR1cmUgPSBjcmVkZW50aWFscy5zaWduYXR1cmU7CiAgICB9IGVsc2UgewogICAgICBjb25zdCB7IGNoYWluLCB3YWxsZXQsIHN0YXRlbWVudCwgb3B0aW9ucyB9ID0gY3JlZGVudGlhbHM7CiAgICAgIGxldCByZXNvbHZlZFdhbGxldDsKICAgICAgaWYgKCFpc0Jyb3dzZXIoKSkgewogICAgICAgIGlmICh0eXBlb2Ygd2FsbGV0ICE9PSAib2JqZWN0IiB8fCAhKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy51cmwpKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkBzdXBhYmFzZS9hdXRoLWpzOiBCb3RoIHdhbGxldCBhbmQgdXJsIG11c3QgYmUgc3BlY2lmaWVkIGluIG5vbi1icm93c2VyIGVudmlyb25tZW50cy4iKTsKICAgICAgICB9CiAgICAgICAgcmVzb2x2ZWRXYWxsZXQgPSB3YWxsZXQ7CiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHdhbGxldCA9PT0gIm9iamVjdCIpIHsKICAgICAgICByZXNvbHZlZFdhbGxldCA9IHdhbGxldDsKICAgICAgfSBlbHNlIHsKICAgICAgICBjb25zdCB3aW5kb3dBbnkgPSB3aW5kb3c7CiAgICAgICAgaWYgKCJldGhlcmV1bSIgaW4gd2luZG93QW55ICYmIHR5cGVvZiB3aW5kb3dBbnkuZXRoZXJldW0gPT09ICJvYmplY3QiICYmICJyZXF1ZXN0IiBpbiB3aW5kb3dBbnkuZXRoZXJldW0gJiYgdHlwZW9mIHdpbmRvd0FueS5ldGhlcmV1bS5yZXF1ZXN0ID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICByZXNvbHZlZFdhbGxldCA9IHdpbmRvd0FueS5ldGhlcmV1bTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBAc3VwYWJhc2UvYXV0aC1qczogTm8gY29tcGF0aWJsZSBFdGhlcmV1bSB3YWxsZXQgaW50ZXJmYWNlIG9uIHRoZSB3aW5kb3cgb2JqZWN0ICh3aW5kb3cuZXRoZXJldW0pIGRldGVjdGVkLiBNYWtlIHN1cmUgdGhlIHVzZXIgYWxyZWFkeSBoYXMgYSB3YWxsZXQgaW5zdGFsbGVkIGFuZCBjb25uZWN0ZWQgZm9yIHRoaXMgYXBwLiBQcmVmZXIgcGFzc2luZyB0aGUgd2FsbGV0IGludGVyZmFjZSBvYmplY3QgZGlyZWN0bHkgdG8gc2lnbkluV2l0aFdlYjMoeyBjaGFpbjogJ2V0aGVyZXVtJywgd2FsbGV0OiByZXNvbHZlZFVzZXJXYWxsZXQgfSkgaW5zdGVhZC5gKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgY29uc3QgdXJsID0gbmV3IFVSTCgoX2EgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMudXJsKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiB3aW5kb3cubG9jYXRpb24uaHJlZik7CiAgICAgIGNvbnN0IGFjY291bnRzID0gYXdhaXQgcmVzb2x2ZWRXYWxsZXQucmVxdWVzdCh7CiAgICAgICAgbWV0aG9kOiAiZXRoX3JlcXVlc3RBY2NvdW50cyIKICAgICAgfSkudGhlbigoYWNjcykgPT4gYWNjcykuY2F0Y2goKCkgPT4gewogICAgICAgIHRocm93IG5ldyBFcnJvcihgQHN1cGFiYXNlL2F1dGgtanM6IFdhbGxldCBtZXRob2QgZXRoX3JlcXVlc3RBY2NvdW50cyBpcyBtaXNzaW5nIG9yIGludmFsaWRgKTsKICAgICAgfSk7CiAgICAgIGlmICghYWNjb3VudHMgfHwgYWNjb3VudHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBAc3VwYWJhc2UvYXV0aC1qczogTm8gYWNjb3VudHMgYXZhaWxhYmxlLiBQbGVhc2UgZW5zdXJlIHRoZSB3YWxsZXQgaXMgY29ubmVjdGVkLmApOwogICAgICB9CiAgICAgIGNvbnN0IGFkZHJlc3MgPSBnZXRBZGRyZXNzKGFjY291bnRzWzBdKTsKICAgICAgbGV0IGNoYWluSWQgPSAoX2IgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc2lnbkluV2l0aEV0aGVyZXVtKSA9PT0gbnVsbCB8fCBfYiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2IuY2hhaW5JZDsKICAgICAgaWYgKCFjaGFpbklkKSB7CiAgICAgICAgY29uc3QgY2hhaW5JZEhleCA9IGF3YWl0IHJlc29sdmVkV2FsbGV0LnJlcXVlc3QoewogICAgICAgICAgbWV0aG9kOiAiZXRoX2NoYWluSWQiCiAgICAgICAgfSk7CiAgICAgICAgY2hhaW5JZCA9IGZyb21IZXgoY2hhaW5JZEhleCk7CiAgICAgIH0KICAgICAgY29uc3Qgc2l3ZU1lc3NhZ2UgPSB7CiAgICAgICAgZG9tYWluOiB1cmwuaG9zdCwKICAgICAgICBhZGRyZXNzLAogICAgICAgIHN0YXRlbWVudCwKICAgICAgICB1cmk6IHVybC5ocmVmLAogICAgICAgIHZlcnNpb246ICIxIiwKICAgICAgICBjaGFpbklkLAogICAgICAgIG5vbmNlOiAoX2MgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc2lnbkluV2l0aEV0aGVyZXVtKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Mubm9uY2UsCiAgICAgICAgaXNzdWVkQXQ6IChfZSA9IChfZCA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5zaWduSW5XaXRoRXRoZXJldW0pID09PSBudWxsIHx8IF9kID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZC5pc3N1ZWRBdCkgIT09IG51bGwgJiYgX2UgIT09IHZvaWQgMCA/IF9lIDogLyogQF9fUFVSRV9fICovIG5ldyBEYXRlKCksCiAgICAgICAgZXhwaXJhdGlvblRpbWU6IChfZiA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5zaWduSW5XaXRoRXRoZXJldW0pID09PSBudWxsIHx8IF9mID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZi5leHBpcmF0aW9uVGltZSwKICAgICAgICBub3RCZWZvcmU6IChfZyA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5zaWduSW5XaXRoRXRoZXJldW0pID09PSBudWxsIHx8IF9nID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZy5ub3RCZWZvcmUsCiAgICAgICAgcmVxdWVzdElkOiAoX2ggPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc2lnbkluV2l0aEV0aGVyZXVtKSA9PT0gbnVsbCB8fCBfaCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2gucmVxdWVzdElkLAogICAgICAgIHJlc291cmNlczogKF9qID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNpZ25JbldpdGhFdGhlcmV1bSkgPT09IG51bGwgfHwgX2ogPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9qLnJlc291cmNlcwogICAgICB9OwogICAgICBtZXNzYWdlID0gY3JlYXRlU2l3ZU1lc3NhZ2Uoc2l3ZU1lc3NhZ2UpOwogICAgICBzaWduYXR1cmUgPSBhd2FpdCByZXNvbHZlZFdhbGxldC5yZXF1ZXN0KHsKICAgICAgICBtZXRob2Q6ICJwZXJzb25hbF9zaWduIiwKICAgICAgICBwYXJhbXM6IFt0b0hleChtZXNzYWdlKSwgYWRkcmVzc10KICAgICAgfSk7CiAgICB9CiAgICB0cnkgewogICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGAke3RoaXMudXJsfS90b2tlbj9ncmFudF90eXBlPXdlYjNgLCB7CiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIGJvZHk6IE9iamVjdC5hc3NpZ24oewogICAgICAgICAgY2hhaW46ICJldGhlcmV1bSIsCiAgICAgICAgICBtZXNzYWdlLAogICAgICAgICAgc2lnbmF0dXJlCiAgICAgICAgfSwgKChfayA9IGNyZWRlbnRpYWxzLm9wdGlvbnMpID09PSBudWxsIHx8IF9rID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfay5jYXB0Y2hhVG9rZW4pID8geyBnb3RydWVfbWV0YV9zZWN1cml0eTogeyBjYXB0Y2hhX3Rva2VuOiAoX2wgPSBjcmVkZW50aWFscy5vcHRpb25zKSA9PT0gbnVsbCB8fCBfbCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2wuY2FwdGNoYVRva2VuIH0gfSA6IG51bGwpLAogICAgICAgIHhmb3JtOiBfc2Vzc2lvblJlc3BvbnNlCiAgICAgIH0pOwogICAgICBpZiAoZXJyb3IpIHsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgICBpZiAoIWRhdGEgfHwgIWRhdGEuc2Vzc2lvbiB8fCAhZGF0YS51c2VyKSB7CiAgICAgICAgY29uc3QgaW52YWxpZFRva2VuRXJyb3IgPSBuZXcgQXV0aEludmFsaWRUb2tlblJlc3BvbnNlRXJyb3IoKTsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yOiBpbnZhbGlkVG9rZW5FcnJvciB9KTsKICAgICAgfQogICAgICBpZiAoZGF0YS5zZXNzaW9uKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fc2F2ZVNlc3Npb24oZGF0YS5zZXNzaW9uKTsKICAgICAgICBhd2FpdCB0aGlzLl9ub3RpZnlBbGxTdWJzY3JpYmVycygiU0lHTkVEX0lOIiwgZGF0YS5zZXNzaW9uKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogT2JqZWN0LmFzc2lnbih7fSwgZGF0YSksIGVycm9yIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIGFzeW5jIHNpZ25JbldpdGhTb2xhbmEoY3JlZGVudGlhbHMpIHsKICAgIHZhciBfYSwgX2IsIF9jLCBfZCwgX2UsIF9mLCBfZywgX2gsIF9qLCBfaywgX2wsIF9tOwogICAgbGV0IG1lc3NhZ2U7CiAgICBsZXQgc2lnbmF0dXJlOwogICAgaWYgKCJtZXNzYWdlIiBpbiBjcmVkZW50aWFscykgewogICAgICBtZXNzYWdlID0gY3JlZGVudGlhbHMubWVzc2FnZTsKICAgICAgc2lnbmF0dXJlID0gY3JlZGVudGlhbHMuc2lnbmF0dXJlOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgeyBjaGFpbiwgd2FsbGV0LCBzdGF0ZW1lbnQsIG9wdGlvbnMgfSA9IGNyZWRlbnRpYWxzOwogICAgICBsZXQgcmVzb2x2ZWRXYWxsZXQ7CiAgICAgIGlmICghaXNCcm93c2VyKCkpIHsKICAgICAgICBpZiAodHlwZW9mIHdhbGxldCAhPT0gIm9iamVjdCIgfHwgIShvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMudXJsKSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJAc3VwYWJhc2UvYXV0aC1qczogQm90aCB3YWxsZXQgYW5kIHVybCBtdXN0IGJlIHNwZWNpZmllZCBpbiBub24tYnJvd3NlciBlbnZpcm9ubWVudHMuIik7CiAgICAgICAgfQogICAgICAgIHJlc29sdmVkV2FsbGV0ID0gd2FsbGV0OwogICAgICB9IGVsc2UgaWYgKHR5cGVvZiB3YWxsZXQgPT09ICJvYmplY3QiKSB7CiAgICAgICAgcmVzb2x2ZWRXYWxsZXQgPSB3YWxsZXQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgd2luZG93QW55ID0gd2luZG93OwogICAgICAgIGlmICgic29sYW5hIiBpbiB3aW5kb3dBbnkgJiYgdHlwZW9mIHdpbmRvd0FueS5zb2xhbmEgPT09ICJvYmplY3QiICYmICgic2lnbkluIiBpbiB3aW5kb3dBbnkuc29sYW5hICYmIHR5cGVvZiB3aW5kb3dBbnkuc29sYW5hLnNpZ25JbiA9PT0gImZ1bmN0aW9uIiB8fCAic2lnbk1lc3NhZ2UiIGluIHdpbmRvd0FueS5zb2xhbmEgJiYgdHlwZW9mIHdpbmRvd0FueS5zb2xhbmEuc2lnbk1lc3NhZ2UgPT09ICJmdW5jdGlvbiIpKSB7CiAgICAgICAgICByZXNvbHZlZFdhbGxldCA9IHdpbmRvd0FueS5zb2xhbmE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQHN1cGFiYXNlL2F1dGgtanM6IE5vIGNvbXBhdGlibGUgU29sYW5hIHdhbGxldCBpbnRlcmZhY2Ugb24gdGhlIHdpbmRvdyBvYmplY3QgKHdpbmRvdy5zb2xhbmEpIGRldGVjdGVkLiBNYWtlIHN1cmUgdGhlIHVzZXIgYWxyZWFkeSBoYXMgYSB3YWxsZXQgaW5zdGFsbGVkIGFuZCBjb25uZWN0ZWQgZm9yIHRoaXMgYXBwLiBQcmVmZXIgcGFzc2luZyB0aGUgd2FsbGV0IGludGVyZmFjZSBvYmplY3QgZGlyZWN0bHkgdG8gc2lnbkluV2l0aFdlYjMoeyBjaGFpbjogJ3NvbGFuYScsIHdhbGxldDogcmVzb2x2ZWRVc2VyV2FsbGV0IH0pIGluc3RlYWQuYCk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoKF9hID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnVybCkgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogd2luZG93LmxvY2F0aW9uLmhyZWYpOwogICAgICBpZiAoInNpZ25JbiIgaW4gcmVzb2x2ZWRXYWxsZXQgJiYgcmVzb2x2ZWRXYWxsZXQuc2lnbkluKSB7CiAgICAgICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgcmVzb2x2ZWRXYWxsZXQuc2lnbkluKE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHsgaXNzdWVkQXQ6ICgvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSkudG9JU09TdHJpbmcoKSB9LCBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc2lnbkluV2l0aFNvbGFuYSksIHsKICAgICAgICAgIC8vIG5vbi1vdmVycmlkYWJsZSBwcm9wZXJ0aWVzCiAgICAgICAgICB2ZXJzaW9uOiAiMSIsCiAgICAgICAgICBkb21haW46IHVybC5ob3N0LAogICAgICAgICAgdXJpOiB1cmwuaHJlZgogICAgICAgIH0pLCBzdGF0ZW1lbnQgPyB7IHN0YXRlbWVudCB9IDogbnVsbCkpOwogICAgICAgIGxldCBvdXRwdXRUb1Byb2Nlc3M7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkob3V0cHV0KSAmJiBvdXRwdXRbMF0gJiYgdHlwZW9mIG91dHB1dFswXSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgIG91dHB1dFRvUHJvY2VzcyA9IG91dHB1dFswXTsKICAgICAgICB9IGVsc2UgaWYgKG91dHB1dCAmJiB0eXBlb2Ygb3V0cHV0ID09PSAib2JqZWN0IiAmJiAic2lnbmVkTWVzc2FnZSIgaW4gb3V0cHV0ICYmICJzaWduYXR1cmUiIGluIG91dHB1dCkgewogICAgICAgICAgb3V0cHV0VG9Qcm9jZXNzID0gb3V0cHV0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkBzdXBhYmFzZS9hdXRoLWpzOiBXYWxsZXQgbWV0aG9kIHNpZ25JbigpIHJldHVybmVkIHVucmVjb2duaXplZCB2YWx1ZSIpOwogICAgICAgIH0KICAgICAgICBpZiAoInNpZ25lZE1lc3NhZ2UiIGluIG91dHB1dFRvUHJvY2VzcyAmJiAic2lnbmF0dXJlIiBpbiBvdXRwdXRUb1Byb2Nlc3MgJiYgKHR5cGVvZiBvdXRwdXRUb1Byb2Nlc3Muc2lnbmVkTWVzc2FnZSA9PT0gInN0cmluZyIgfHwgb3V0cHV0VG9Qcm9jZXNzLnNpZ25lZE1lc3NhZ2UgaW5zdGFuY2VvZiBVaW50OEFycmF5KSAmJiBvdXRwdXRUb1Byb2Nlc3Muc2lnbmF0dXJlIGluc3RhbmNlb2YgVWludDhBcnJheSkgewogICAgICAgICAgbWVzc2FnZSA9IHR5cGVvZiBvdXRwdXRUb1Byb2Nlc3Muc2lnbmVkTWVzc2FnZSA9PT0gInN0cmluZyIgPyBvdXRwdXRUb1Byb2Nlc3Muc2lnbmVkTWVzc2FnZSA6IG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShvdXRwdXRUb1Byb2Nlc3Muc2lnbmVkTWVzc2FnZSk7CiAgICAgICAgICBzaWduYXR1cmUgPSBvdXRwdXRUb1Byb2Nlc3Muc2lnbmF0dXJlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkBzdXBhYmFzZS9hdXRoLWpzOiBXYWxsZXQgbWV0aG9kIHNpZ25JbigpIEFQSSByZXR1cm5lZCBvYmplY3Qgd2l0aG91dCBzaWduZWRNZXNzYWdlIGFuZCBzaWduYXR1cmUgZmllbGRzIik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmICghKCJzaWduTWVzc2FnZSIgaW4gcmVzb2x2ZWRXYWxsZXQpIHx8IHR5cGVvZiByZXNvbHZlZFdhbGxldC5zaWduTWVzc2FnZSAhPT0gImZ1bmN0aW9uIiB8fCAhKCJwdWJsaWNLZXkiIGluIHJlc29sdmVkV2FsbGV0KSB8fCB0eXBlb2YgcmVzb2x2ZWRXYWxsZXQgIT09ICJvYmplY3QiIHx8ICFyZXNvbHZlZFdhbGxldC5wdWJsaWNLZXkgfHwgISgidG9CYXNlNTgiIGluIHJlc29sdmVkV2FsbGV0LnB1YmxpY0tleSkgfHwgdHlwZW9mIHJlc29sdmVkV2FsbGV0LnB1YmxpY0tleS50b0Jhc2U1OCAhPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJAc3VwYWJhc2UvYXV0aC1qczogV2FsbGV0IGRvZXMgbm90IGhhdmUgYSBjb21wYXRpYmxlIHNpZ25NZXNzYWdlKCkgYW5kIHB1YmxpY0tleS50b0Jhc2U1OCgpIEFQSSIpOwogICAgICAgIH0KICAgICAgICBtZXNzYWdlID0gWwogICAgICAgICAgYCR7dXJsLmhvc3R9IHdhbnRzIHlvdSB0byBzaWduIGluIHdpdGggeW91ciBTb2xhbmEgYWNjb3VudDpgLAogICAgICAgICAgcmVzb2x2ZWRXYWxsZXQucHVibGljS2V5LnRvQmFzZTU4KCksCiAgICAgICAgICAuLi5zdGF0ZW1lbnQgPyBbIiIsIHN0YXRlbWVudCwgIiJdIDogWyIiXSwKICAgICAgICAgICJWZXJzaW9uOiAxIiwKICAgICAgICAgIGBVUkk6ICR7dXJsLmhyZWZ9YCwKICAgICAgICAgIGBJc3N1ZWQgQXQ6ICR7KF9jID0gKF9iID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNpZ25JbldpdGhTb2xhbmEpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5pc3N1ZWRBdCkgIT09IG51bGwgJiYgX2MgIT09IHZvaWQgMCA/IF9jIDogKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS50b0lTT1N0cmluZygpfWAsCiAgICAgICAgICAuLi4oKF9kID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNpZ25JbldpdGhTb2xhbmEpID09PSBudWxsIHx8IF9kID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZC5ub3RCZWZvcmUpID8gW2BOb3QgQmVmb3JlOiAke29wdGlvbnMuc2lnbkluV2l0aFNvbGFuYS5ub3RCZWZvcmV9YF0gOiBbXSwKICAgICAgICAgIC4uLigoX2UgPSBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc2lnbkluV2l0aFNvbGFuYSkgPT09IG51bGwgfHwgX2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9lLmV4cGlyYXRpb25UaW1lKSA/IFtgRXhwaXJhdGlvbiBUaW1lOiAke29wdGlvbnMuc2lnbkluV2l0aFNvbGFuYS5leHBpcmF0aW9uVGltZX1gXSA6IFtdLAogICAgICAgICAgLi4uKChfZiA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5zaWduSW5XaXRoU29sYW5hKSA9PT0gbnVsbCB8fCBfZiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2YuY2hhaW5JZCkgPyBbYENoYWluIElEOiAke29wdGlvbnMuc2lnbkluV2l0aFNvbGFuYS5jaGFpbklkfWBdIDogW10sCiAgICAgICAgICAuLi4oKF9nID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNpZ25JbldpdGhTb2xhbmEpID09PSBudWxsIHx8IF9nID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZy5ub25jZSkgPyBbYE5vbmNlOiAke29wdGlvbnMuc2lnbkluV2l0aFNvbGFuYS5ub25jZX1gXSA6IFtdLAogICAgICAgICAgLi4uKChfaCA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5zaWduSW5XaXRoU29sYW5hKSA9PT0gbnVsbCB8fCBfaCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2gucmVxdWVzdElkKSA/IFtgUmVxdWVzdCBJRDogJHtvcHRpb25zLnNpZ25JbldpdGhTb2xhbmEucmVxdWVzdElkfWBdIDogW10sCiAgICAgICAgICAuLi4oKF9rID0gKF9qID0gb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNpZ25JbldpdGhTb2xhbmEpID09PSBudWxsIHx8IF9qID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfai5yZXNvdXJjZXMpID09PSBudWxsIHx8IF9rID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfay5sZW5ndGgpID8gWwogICAgICAgICAgICAiUmVzb3VyY2VzIiwKICAgICAgICAgICAgLi4ub3B0aW9ucy5zaWduSW5XaXRoU29sYW5hLnJlc291cmNlcy5tYXAoKHJlc291cmNlKSA9PiBgLSAke3Jlc291cmNlfWApCiAgICAgICAgICBdIDogW10KICAgICAgICBdLmpvaW4oIlxuIik7CiAgICAgICAgY29uc3QgbWF5YmVTaWduYXR1cmUgPSBhd2FpdCByZXNvbHZlZFdhbGxldC5zaWduTWVzc2FnZShuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUobWVzc2FnZSksICJ1dGY4Iik7CiAgICAgICAgaWYgKCFtYXliZVNpZ25hdHVyZSB8fCAhKG1heWJlU2lnbmF0dXJlIGluc3RhbmNlb2YgVWludDhBcnJheSkpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQHN1cGFiYXNlL2F1dGgtanM6IFdhbGxldCBzaWduTWVzc2FnZSgpIEFQSSByZXR1cm5lZCBhbiByZWNvZ25pemVkIHZhbHVlIik7CiAgICAgICAgfQogICAgICAgIHNpZ25hdHVyZSA9IG1heWJlU2lnbmF0dXJlOwogICAgICB9CiAgICB9CiAgICB0cnkgewogICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGAke3RoaXMudXJsfS90b2tlbj9ncmFudF90eXBlPXdlYjNgLCB7CiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIGJvZHk6IE9iamVjdC5hc3NpZ24oeyBjaGFpbjogInNvbGFuYSIsIG1lc3NhZ2UsIHNpZ25hdHVyZTogYnl0ZXNUb0Jhc2U2NFVSTChzaWduYXR1cmUpIH0sICgoX2wgPSBjcmVkZW50aWFscy5vcHRpb25zKSA9PT0gbnVsbCB8fCBfbCA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2wuY2FwdGNoYVRva2VuKSA/IHsgZ290cnVlX21ldGFfc2VjdXJpdHk6IHsgY2FwdGNoYV90b2tlbjogKF9tID0gY3JlZGVudGlhbHMub3B0aW9ucykgPT09IG51bGwgfHwgX20gPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9tLmNhcHRjaGFUb2tlbiB9IH0gOiBudWxsKSwKICAgICAgICB4Zm9ybTogX3Nlc3Npb25SZXNwb25zZQogICAgICB9KTsKICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0KICAgICAgaWYgKCFkYXRhIHx8ICFkYXRhLnNlc3Npb24gfHwgIWRhdGEudXNlcikgewogICAgICAgIGNvbnN0IGludmFsaWRUb2tlbkVycm9yID0gbmV3IEF1dGhJbnZhbGlkVG9rZW5SZXNwb25zZUVycm9yKCk7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvcjogaW52YWxpZFRva2VuRXJyb3IgfSk7CiAgICAgIH0KICAgICAgaWYgKGRhdGEuc2Vzc2lvbikgewogICAgICAgIGF3YWl0IHRoaXMuX3NhdmVTZXNzaW9uKGRhdGEuc2Vzc2lvbik7CiAgICAgICAgYXdhaXQgdGhpcy5fbm90aWZ5QWxsU3Vic2NyaWJlcnMoIlNJR05FRF9JTiIsIGRhdGEuc2Vzc2lvbik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IE9iamVjdC5hc3NpZ24oe30sIGRhdGEpLCBlcnJvciB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICBhc3luYyBfZXhjaGFuZ2VDb2RlRm9yU2Vzc2lvbihhdXRoQ29kZSkgewogICAgY29uc3Qgc3RvcmFnZUl0ZW0gPSBhd2FpdCBnZXRJdGVtQXN5bmModGhpcy5zdG9yYWdlLCBgJHt0aGlzLnN0b3JhZ2VLZXl9LWNvZGUtdmVyaWZpZXJgKTsKICAgIGNvbnN0IFtjb2RlVmVyaWZpZXIsIHJlZGlyZWN0VHlwZV0gPSAoc3RvcmFnZUl0ZW0gIT09IG51bGwgJiYgc3RvcmFnZUl0ZW0gIT09IHZvaWQgMCA/IHN0b3JhZ2VJdGVtIDogIiIpLnNwbGl0KCIvIik7CiAgICB0cnkgewogICAgICBpZiAoIWNvZGVWZXJpZmllciAmJiB0aGlzLmZsb3dUeXBlID09PSAicGtjZSIpIHsKICAgICAgICB0aHJvdyBuZXcgQXV0aFBLQ0VDb2RlVmVyaWZpZXJNaXNzaW5nRXJyb3IoKTsKICAgICAgfQogICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGAke3RoaXMudXJsfS90b2tlbj9ncmFudF90eXBlPXBrY2VgLCB7CiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIGJvZHk6IHsKICAgICAgICAgIGF1dGhfY29kZTogYXV0aENvZGUsCiAgICAgICAgICBjb2RlX3ZlcmlmaWVyOiBjb2RlVmVyaWZpZXIKICAgICAgICB9LAogICAgICAgIHhmb3JtOiBfc2Vzc2lvblJlc3BvbnNlCiAgICAgIH0pOwogICAgICBhd2FpdCByZW1vdmVJdGVtQXN5bmModGhpcy5zdG9yYWdlLCBgJHt0aGlzLnN0b3JhZ2VLZXl9LWNvZGUtdmVyaWZpZXJgKTsKICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0KICAgICAgaWYgKCFkYXRhIHx8ICFkYXRhLnNlc3Npb24gfHwgIWRhdGEudXNlcikgewogICAgICAgIGNvbnN0IGludmFsaWRUb2tlbkVycm9yID0gbmV3IEF1dGhJbnZhbGlkVG9rZW5SZXNwb25zZUVycm9yKCk7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7CiAgICAgICAgICBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwsIHJlZGlyZWN0VHlwZTogbnVsbCB9LAogICAgICAgICAgZXJyb3I6IGludmFsaWRUb2tlbkVycm9yCiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKGRhdGEuc2Vzc2lvbikgewogICAgICAgIGF3YWl0IHRoaXMuX3NhdmVTZXNzaW9uKGRhdGEuc2Vzc2lvbik7CiAgICAgICAgYXdhaXQgdGhpcy5fbm90aWZ5QWxsU3Vic2NyaWJlcnMoIlNJR05FRF9JTiIsIGRhdGEuc2Vzc2lvbik7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgZGF0YSksIHsgcmVkaXJlY3RUeXBlOiByZWRpcmVjdFR5cGUgIT09IG51bGwgJiYgcmVkaXJlY3RUeXBlICE9PSB2b2lkIDAgPyByZWRpcmVjdFR5cGUgOiBudWxsIH0pLCBlcnJvciB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGF3YWl0IHJlbW92ZUl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIGAke3RoaXMuc3RvcmFnZUtleX0tY29kZS12ZXJpZmllcmApOwogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7CiAgICAgICAgICBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwsIHJlZGlyZWN0VHlwZTogbnVsbCB9LAogICAgICAgICAgZXJyb3IKICAgICAgICB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogQWxsb3dzIHNpZ25pbmcgaW4gd2l0aCBhbiBPSURDIElEIHRva2VuLiBUaGUgYXV0aGVudGljYXRpb24gcHJvdmlkZXIgdXNlZAogICAqIHNob3VsZCBiZSBlbmFibGVkIGFuZCBjb25maWd1cmVkLgogICAqLwogIGFzeW5jIHNpZ25JbldpdGhJZFRva2VuKGNyZWRlbnRpYWxzKSB7CiAgICB0cnkgewogICAgICBjb25zdCB7IG9wdGlvbnMsIHByb3ZpZGVyLCB0b2tlbiwgYWNjZXNzX3Rva2VuLCBub25jZSB9ID0gY3JlZGVudGlhbHM7CiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L3Rva2VuP2dyYW50X3R5cGU9aWRfdG9rZW5gLCB7CiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIGJvZHk6IHsKICAgICAgICAgIHByb3ZpZGVyLAogICAgICAgICAgaWRfdG9rZW46IHRva2VuLAogICAgICAgICAgYWNjZXNzX3Rva2VuLAogICAgICAgICAgbm9uY2UsCiAgICAgICAgICBnb3RydWVfbWV0YV9zZWN1cml0eTogeyBjYXB0Y2hhX3Rva2VuOiBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuY2FwdGNoYVRva2VuIH0KICAgICAgICB9LAogICAgICAgIHhmb3JtOiBfc2Vzc2lvblJlc3BvbnNlCiAgICAgIH0pOwogICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSByZXM7CiAgICAgIGlmIChlcnJvcikgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0gZWxzZSBpZiAoIWRhdGEgfHwgIWRhdGEuc2Vzc2lvbiB8fCAhZGF0YS51c2VyKSB7CiAgICAgICAgY29uc3QgaW52YWxpZFRva2VuRXJyb3IgPSBuZXcgQXV0aEludmFsaWRUb2tlblJlc3BvbnNlRXJyb3IoKTsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yOiBpbnZhbGlkVG9rZW5FcnJvciB9KTsKICAgICAgfQogICAgICBpZiAoZGF0YS5zZXNzaW9uKSB7CiAgICAgICAgYXdhaXQgdGhpcy5fc2F2ZVNlc3Npb24oZGF0YS5zZXNzaW9uKTsKICAgICAgICBhd2FpdCB0aGlzLl9ub3RpZnlBbGxTdWJzY3JpYmVycygiU0lHTkVEX0lOIiwgZGF0YS5zZXNzaW9uKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YSwgZXJyb3IgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogTG9nIGluIGEgdXNlciB1c2luZyBtYWdpY2xpbmsgb3IgYSBvbmUtdGltZSBwYXNzd29yZCAoT1RQKS4KICAgKgogICAqIElmIHRoZSBge3sgLkNvbmZpcm1hdGlvblVSTCB9fWAgdmFyaWFibGUgaXMgc3BlY2lmaWVkIGluIHRoZSBlbWFpbCB0ZW1wbGF0ZSwgYSBtYWdpY2xpbmsgd2lsbCBiZSBzZW50LgogICAqIElmIHRoZSBge3sgLlRva2VuIH19YCB2YXJpYWJsZSBpcyBzcGVjaWZpZWQgaW4gdGhlIGVtYWlsIHRlbXBsYXRlLCBhbiBPVFAgd2lsbCBiZSBzZW50LgogICAqIElmIHlvdSdyZSB1c2luZyBwaG9uZSBzaWduLWlucywgb25seSBhbiBPVFAgd2lsbCBiZSBzZW50LiBZb3Ugd29uJ3QgYmUgYWJsZSB0byBzZW5kIGEgbWFnaWNsaW5rIGZvciBwaG9uZSBzaWduLWlucy4KICAgKgogICAqIEJlIGF3YXJlIHRoYXQgeW91IG1heSBnZXQgYmFjayBhbiBlcnJvciBtZXNzYWdlIHRoYXQgd2lsbCBub3QgZGlzdGluZ3Vpc2gKICAgKiBiZXR3ZWVuIHRoZSBjYXNlcyB3aGVyZSB0aGUgYWNjb3VudCBkb2VzIG5vdCBleGlzdCBvciwgdGhhdCB0aGUgYWNjb3VudAogICAqIGNhbiBvbmx5IGJlIGFjY2Vzc2VkIHZpYSBzb2NpYWwgbG9naW4uCiAgICoKICAgKiBEbyBub3RlIHRoYXQgeW91IHdpbGwgbmVlZCB0byBjb25maWd1cmUgYSBXaGF0c2FwcCBzZW5kZXIgb24gVHdpbGlvCiAgICogaWYgeW91IGFyZSB1c2luZyBwaG9uZSBzaWduIGluIHdpdGggdGhlICd3aGF0c2FwcCcgY2hhbm5lbC4gVGhlIHdoYXRzYXBwCiAgICogY2hhbm5lbCBpcyBub3Qgc3VwcG9ydGVkIG9uIG90aGVyIHByb3ZpZGVycwogICAqIGF0IHRoaXMgdGltZS4KICAgKiBUaGlzIG1ldGhvZCBzdXBwb3J0cyBQS0NFIHdoZW4gYW4gZW1haWwgaXMgcGFzc2VkLgogICAqLwogIGFzeW5jIHNpZ25JbldpdGhPdHAoY3JlZGVudGlhbHMpIHsKICAgIHZhciBfYSwgX2IsIF9jLCBfZCwgX2U7CiAgICB0cnkgewogICAgICBpZiAoImVtYWlsIiBpbiBjcmVkZW50aWFscykgewogICAgICAgIGNvbnN0IHsgZW1haWwsIG9wdGlvbnMgfSA9IGNyZWRlbnRpYWxzOwogICAgICAgIGxldCBjb2RlQ2hhbGxlbmdlID0gbnVsbDsKICAgICAgICBsZXQgY29kZUNoYWxsZW5nZU1ldGhvZCA9IG51bGw7CiAgICAgICAgaWYgKHRoaXMuZmxvd1R5cGUgPT09ICJwa2NlIikgewogICAgICAgICAgOwogICAgICAgICAgW2NvZGVDaGFsbGVuZ2UsIGNvZGVDaGFsbGVuZ2VNZXRob2RdID0gYXdhaXQgZ2V0Q29kZUNoYWxsZW5nZUFuZE1ldGhvZCh0aGlzLnN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L290cGAsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGJvZHk6IHsKICAgICAgICAgICAgZW1haWwsCiAgICAgICAgICAgIGRhdGE6IChfYSA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5kYXRhKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiB7fSwKICAgICAgICAgICAgY3JlYXRlX3VzZXI6IChfYiA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5zaG91bGRDcmVhdGVVc2VyKSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiB0cnVlLAogICAgICAgICAgICBnb3RydWVfbWV0YV9zZWN1cml0eTogeyBjYXB0Y2hhX3Rva2VuOiBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuY2FwdGNoYVRva2VuIH0sCiAgICAgICAgICAgIGNvZGVfY2hhbGxlbmdlOiBjb2RlQ2hhbGxlbmdlLAogICAgICAgICAgICBjb2RlX2NoYWxsZW5nZV9tZXRob2Q6IGNvZGVDaGFsbGVuZ2VNZXRob2QKICAgICAgICAgIH0sCiAgICAgICAgICByZWRpcmVjdFRvOiBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuZW1haWxSZWRpcmVjdFRvCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICBpZiAoInBob25lIiBpbiBjcmVkZW50aWFscykgewogICAgICAgIGNvbnN0IHsgcGhvbmUsIG9wdGlvbnMgfSA9IGNyZWRlbnRpYWxzOwogICAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L290cGAsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGJvZHk6IHsKICAgICAgICAgICAgcGhvbmUsCiAgICAgICAgICAgIGRhdGE6IChfYyA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5kYXRhKSAhPT0gbnVsbCAmJiBfYyAhPT0gdm9pZCAwID8gX2MgOiB7fSwKICAgICAgICAgICAgY3JlYXRlX3VzZXI6IChfZCA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5zaG91bGRDcmVhdGVVc2VyKSAhPT0gbnVsbCAmJiBfZCAhPT0gdm9pZCAwID8gX2QgOiB0cnVlLAogICAgICAgICAgICBnb3RydWVfbWV0YV9zZWN1cml0eTogeyBjYXB0Y2hhX3Rva2VuOiBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuY2FwdGNoYVRva2VuIH0sCiAgICAgICAgICAgIGNoYW5uZWw6IChfZSA9IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5jaGFubmVsKSAhPT0gbnVsbCAmJiBfZSAhPT0gdm9pZCAwID8gX2UgOiAic21zIgogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoewogICAgICAgICAgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsLCBtZXNzYWdlSWQ6IGRhdGEgPT09IG51bGwgfHwgZGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogZGF0YS5tZXNzYWdlX2lkIH0sCiAgICAgICAgICBlcnJvcgogICAgICAgIH0pOwogICAgICB9CiAgICAgIHRocm93IG5ldyBBdXRoSW52YWxpZENyZWRlbnRpYWxzRXJyb3IoIllvdSBtdXN0IHByb3ZpZGUgZWl0aGVyIGFuIGVtYWlsIG9yIHBob25lIG51bWJlci4iKTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGF3YWl0IHJlbW92ZUl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIGAke3RoaXMuc3RvcmFnZUtleX0tY29kZS12ZXJpZmllcmApOwogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogTG9nIGluIGEgdXNlciBnaXZlbiBhIFVzZXIgc3VwcGxpZWQgT1RQIG9yIFRva2VuSGFzaCByZWNlaXZlZCB0aHJvdWdoIG1vYmlsZSBvciBlbWFpbC4KICAgKi8KICBhc3luYyB2ZXJpZnlPdHAocGFyYW1zKSB7CiAgICB2YXIgX2EsIF9iOwogICAgdHJ5IHsKICAgICAgbGV0IHJlZGlyZWN0VG8gPSB2b2lkIDA7CiAgICAgIGxldCBjYXB0Y2hhVG9rZW4gPSB2b2lkIDA7CiAgICAgIGlmICgib3B0aW9ucyIgaW4gcGFyYW1zKSB7CiAgICAgICAgcmVkaXJlY3RUbyA9IChfYSA9IHBhcmFtcy5vcHRpb25zKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucmVkaXJlY3RUbzsKICAgICAgICBjYXB0Y2hhVG9rZW4gPSAoX2IgPSBwYXJhbXMub3B0aW9ucykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmNhcHRjaGFUb2tlbjsKICAgICAgfQogICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGAke3RoaXMudXJsfS92ZXJpZnlgLCB7CiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIGJvZHk6IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgcGFyYW1zKSwgeyBnb3RydWVfbWV0YV9zZWN1cml0eTogeyBjYXB0Y2hhX3Rva2VuOiBjYXB0Y2hhVG9rZW4gfSB9KSwKICAgICAgICByZWRpcmVjdFRvLAogICAgICAgIHhmb3JtOiBfc2Vzc2lvblJlc3BvbnNlCiAgICAgIH0pOwogICAgICBpZiAoZXJyb3IpIHsKICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgfQogICAgICBpZiAoIWRhdGEpIHsKICAgICAgICBjb25zdCB0b2tlblZlcmlmaWNhdGlvbkVycm9yID0gbmV3IEVycm9yKCJBbiBlcnJvciBvY2N1cnJlZCBvbiB0b2tlbiB2ZXJpZmljYXRpb24uIik7CiAgICAgICAgdGhyb3cgdG9rZW5WZXJpZmljYXRpb25FcnJvcjsKICAgICAgfQogICAgICBjb25zdCBzZXNzaW9uID0gZGF0YS5zZXNzaW9uOwogICAgICBjb25zdCB1c2VyID0gZGF0YS51c2VyOwogICAgICBpZiAoc2Vzc2lvbiA9PT0gbnVsbCB8fCBzZXNzaW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXNzaW9uLmFjY2Vzc190b2tlbikgewogICAgICAgIGF3YWl0IHRoaXMuX3NhdmVTZXNzaW9uKHNlc3Npb24pOwogICAgICAgIGF3YWl0IHRoaXMuX25vdGlmeUFsbFN1YnNjcmliZXJzKHBhcmFtcy50eXBlID09ICJyZWNvdmVyeSIgPyAiUEFTU1dPUkRfUkVDT1ZFUlkiIDogIlNJR05FRF9JTiIsIHNlc3Npb24pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXIsIHNlc3Npb24gfSwgZXJyb3I6IG51bGwgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogQXR0ZW1wdHMgYSBzaW5nbGUtc2lnbiBvbiB1c2luZyBhbiBlbnRlcnByaXNlIElkZW50aXR5IFByb3ZpZGVyLiBBCiAgICogc3VjY2Vzc2Z1bCBTU08gYXR0ZW1wdCB3aWxsIHJlZGlyZWN0IHRoZSBjdXJyZW50IHBhZ2UgdG8gdGhlIGlkZW50aXR5CiAgICogcHJvdmlkZXIgYXV0aG9yaXphdGlvbiBwYWdlLiBUaGUgcmVkaXJlY3QgVVJMIGlzIGltcGxlbWVudGF0aW9uIGFuZCBTU08KICAgKiBwcm90b2NvbCBzcGVjaWZpYy4KICAgKgogICAqIFlvdSBjYW4gdXNlIGl0IGJ5IHByb3ZpZGluZyBhIFNTTyBkb21haW4uIFR5cGljYWxseSB5b3UgY2FuIGV4dHJhY3QgdGhpcwogICAqIGRvbWFpbiBieSBhc2tpbmcgdXNlcnMgZm9yIHRoZWlyIGVtYWlsIGFkZHJlc3MuIElmIHRoaXMgZG9tYWluIGlzCiAgICogcmVnaXN0ZXJlZCBvbiB0aGUgQXV0aCBpbnN0YW5jZSB0aGUgcmVkaXJlY3Qgd2lsbCB1c2UgdGhhdCBvcmdhbml6YXRpb24ncwogICAqIGN1cnJlbnRseSBhY3RpdmUgU1NPIElkZW50aXR5IFByb3ZpZGVyIGZvciB0aGUgbG9naW4uCiAgICoKICAgKiBJZiB5b3UgaGF2ZSBidWlsdCBhbiBvcmdhbml6YXRpb24tc3BlY2lmaWMgbG9naW4gcGFnZSwgeW91IGNhbiB1c2UgdGhlCiAgICogb3JnYW5pemF0aW9uJ3MgU1NPIElkZW50aXR5IFByb3ZpZGVyIFVVSUQgZGlyZWN0bHkgaW5zdGVhZC4KICAgKi8KICBhc3luYyBzaWduSW5XaXRoU1NPKHBhcmFtcykgewogICAgdmFyIF9hLCBfYiwgX2MsIF9kLCBfZTsKICAgIHRyeSB7CiAgICAgIGxldCBjb2RlQ2hhbGxlbmdlID0gbnVsbDsKICAgICAgbGV0IGNvZGVDaGFsbGVuZ2VNZXRob2QgPSBudWxsOwogICAgICBpZiAodGhpcy5mbG93VHlwZSA9PT0gInBrY2UiKSB7CiAgICAgICAgOwogICAgICAgIFtjb2RlQ2hhbGxlbmdlLCBjb2RlQ2hhbGxlbmdlTWV0aG9kXSA9IGF3YWl0IGdldENvZGVDaGFsbGVuZ2VBbmRNZXRob2QodGhpcy5zdG9yYWdlLCB0aGlzLnN0b3JhZ2VLZXkpOwogICAgICB9CiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L3Nzb2AsIHsKICAgICAgICBib2R5OiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sICJwcm92aWRlcklkIiBpbiBwYXJhbXMgPyB7IHByb3ZpZGVyX2lkOiBwYXJhbXMucHJvdmlkZXJJZCB9IDogbnVsbCksICJkb21haW4iIGluIHBhcmFtcyA/IHsgZG9tYWluOiBwYXJhbXMuZG9tYWluIH0gOiBudWxsKSwgeyByZWRpcmVjdF90bzogKF9iID0gKF9hID0gcGFyYW1zLm9wdGlvbnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5yZWRpcmVjdFRvKSAhPT0gbnVsbCAmJiBfYiAhPT0gdm9pZCAwID8gX2IgOiB2b2lkIDAgfSksICgoX2MgPSBwYXJhbXMgPT09IG51bGwgfHwgcGFyYW1zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBwYXJhbXMub3B0aW9ucykgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmNhcHRjaGFUb2tlbikgPyB7IGdvdHJ1ZV9tZXRhX3NlY3VyaXR5OiB7IGNhcHRjaGFfdG9rZW46IHBhcmFtcy5vcHRpb25zLmNhcHRjaGFUb2tlbiB9IH0gOiBudWxsKSwgeyBza2lwX2h0dHBfcmVkaXJlY3Q6IHRydWUsIGNvZGVfY2hhbGxlbmdlOiBjb2RlQ2hhbGxlbmdlLCBjb2RlX2NoYWxsZW5nZV9tZXRob2Q6IGNvZGVDaGFsbGVuZ2VNZXRob2QgfSksCiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgIHhmb3JtOiBfc3NvUmVzcG9uc2UKICAgICAgfSk7CiAgICAgIGlmICgoKF9kID0gcmVzdWx0LmRhdGEpID09PSBudWxsIHx8IF9kID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZC51cmwpICYmIGlzQnJvd3NlcigpICYmICEoKF9lID0gcGFyYW1zLm9wdGlvbnMpID09PSBudWxsIHx8IF9lID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfZS5za2lwQnJvd3NlclJlZGlyZWN0KSkgewogICAgICAgIHdpbmRvdy5sb2NhdGlvbi5hc3NpZ24ocmVzdWx0LmRhdGEudXJsKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHJlc3VsdCk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBhd2FpdCByZW1vdmVJdGVtQXN5bmModGhpcy5zdG9yYWdlLCBgJHt0aGlzLnN0b3JhZ2VLZXl9LWNvZGUtdmVyaWZpZXJgKTsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogU2VuZHMgYSByZWF1dGhlbnRpY2F0aW9uIE9UUCB0byB0aGUgdXNlcidzIGVtYWlsIG9yIHBob25lIG51bWJlci4KICAgKiBSZXF1aXJlcyB0aGUgdXNlciB0byBiZSBzaWduZWQtaW4uCiAgICovCiAgYXN5bmMgcmVhdXRoZW50aWNhdGUoKSB7CiAgICBhd2FpdCB0aGlzLmluaXRpYWxpemVQcm9taXNlOwogICAgcmV0dXJuIGF3YWl0IHRoaXMuX2FjcXVpcmVMb2NrKHRoaXMubG9ja0FjcXVpcmVUaW1lb3V0LCBhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9yZWF1dGhlbnRpY2F0ZSgpOwogICAgfSk7CiAgfQogIGFzeW5jIF9yZWF1dGhlbnRpY2F0ZSgpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl91c2VTZXNzaW9uKGFzeW5jIChyZXN1bHQpID0+IHsKICAgICAgICBjb25zdCB7IGRhdGE6IHsgc2Vzc2lvbiB9LCBlcnJvcjogc2Vzc2lvbkVycm9yIH0gPSByZXN1bHQ7CiAgICAgICAgaWYgKHNlc3Npb25FcnJvcikKICAgICAgICAgIHRocm93IHNlc3Npb25FcnJvcjsKICAgICAgICBpZiAoIXNlc3Npb24pCiAgICAgICAgICB0aHJvdyBuZXcgQXV0aFNlc3Npb25NaXNzaW5nRXJyb3IoKTsKICAgICAgICBjb25zdCB7IGVycm9yIH0gPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiR0VUIiwgYCR7dGhpcy51cmx9L3JlYXV0aGVudGljYXRlYCwgewogICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgand0OiBzZXNzaW9uLmFjY2Vzc190b2tlbgogICAgICAgIH0pOwogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIFJlc2VuZHMgYW4gZXhpc3Rpbmcgc2lnbnVwIGNvbmZpcm1hdGlvbiBlbWFpbCwgZW1haWwgY2hhbmdlIGVtYWlsLCBTTVMgT1RQIG9yIHBob25lIGNoYW5nZSBPVFAuCiAgICovCiAgYXN5bmMgcmVzZW5kKGNyZWRlbnRpYWxzKSB7CiAgICB0cnkgewogICAgICBjb25zdCBlbmRwb2ludCA9IGAke3RoaXMudXJsfS9yZXNlbmRgOwogICAgICBpZiAoImVtYWlsIiBpbiBjcmVkZW50aWFscykgewogICAgICAgIGNvbnN0IHsgZW1haWwsIHR5cGUsIG9wdGlvbnMgfSA9IGNyZWRlbnRpYWxzOwogICAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgZW5kcG9pbnQsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGJvZHk6IHsKICAgICAgICAgICAgZW1haWwsCiAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgIGdvdHJ1ZV9tZXRhX3NlY3VyaXR5OiB7IGNhcHRjaGFfdG9rZW46IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5jYXB0Y2hhVG9rZW4gfQogICAgICAgICAgfSwKICAgICAgICAgIHJlZGlyZWN0VG86IG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5lbWFpbFJlZGlyZWN0VG8KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9IGVsc2UgaWYgKCJwaG9uZSIgaW4gY3JlZGVudGlhbHMpIHsKICAgICAgICBjb25zdCB7IHBob25lLCB0eXBlLCBvcHRpb25zIH0gPSBjcmVkZW50aWFsczsKICAgICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGVuZHBvaW50LCB7CiAgICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgICBib2R5OiB7CiAgICAgICAgICAgIHBob25lLAogICAgICAgICAgICB0eXBlLAogICAgICAgICAgICBnb3RydWVfbWV0YV9zZWN1cml0eTogeyBjYXB0Y2hhX3Rva2VuOiBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuY2FwdGNoYVRva2VuIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsKICAgICAgICAgIGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCwgbWVzc2FnZUlkOiBkYXRhID09PSBudWxsIHx8IGRhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGEubWVzc2FnZV9pZCB9LAogICAgICAgICAgZXJyb3IKICAgICAgICB9KTsKICAgICAgfQogICAgICB0aHJvdyBuZXcgQXV0aEludmFsaWRDcmVkZW50aWFsc0Vycm9yKCJZb3UgbXVzdCBwcm92aWRlIGVpdGhlciBhbiBlbWFpbCBvciBwaG9uZSBudW1iZXIgYW5kIGEgdHlwZSIpOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIFJldHVybnMgdGhlIHNlc3Npb24sIHJlZnJlc2hpbmcgaXQgaWYgbmVjZXNzYXJ5LgogICAqCiAgICogVGhlIHNlc3Npb24gcmV0dXJuZWQgY2FuIGJlIG51bGwgaWYgdGhlIHNlc3Npb24gaXMgbm90IGRldGVjdGVkIHdoaWNoIGNhbiBoYXBwZW4gaW4gdGhlIGV2ZW50IGEgdXNlciBpcyBub3Qgc2lnbmVkLWluIG9yIGhhcyBsb2dnZWQgb3V0LgogICAqCiAgICogKipJTVBPUlRBTlQ6KiogVGhpcyBtZXRob2QgbG9hZHMgdmFsdWVzIGRpcmVjdGx5IGZyb20gdGhlIHN0b3JhZ2UgYXR0YWNoZWQKICAgKiB0byB0aGUgY2xpZW50LiBJZiB0aGF0IHN0b3JhZ2UgaXMgYmFzZWQgb24gcmVxdWVzdCBjb29raWVzIGZvciBleGFtcGxlLAogICAqIHRoZSB2YWx1ZXMgaW4gaXQgbWF5IG5vdCBiZSBhdXRoZW50aWMgYW5kIHRoZXJlZm9yZSBpdCdzIHN0cm9uZ2x5IGFkdmlzZWQKICAgKiBhZ2FpbnN0IHVzaW5nIHRoaXMgbWV0aG9kIGFuZCBpdHMgcmVzdWx0cyBpbiBzdWNoIGNpcmN1bXN0YW5jZXMuIEEgd2FybmluZwogICAqIHdpbGwgYmUgZW1pdHRlZCBpZiB0aGlzIGlzIGRldGVjdGVkLiBVc2Uge0BsaW5rICNnZXRVc2VyKCl9IGluc3RlYWQuCiAgICovCiAgYXN5bmMgZ2V0U2Vzc2lvbigpIHsKICAgIGF3YWl0IHRoaXMuaW5pdGlhbGl6ZVByb21pc2U7CiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLl9hY3F1aXJlTG9jayh0aGlzLmxvY2tBY3F1aXJlVGltZW91dCwgYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gdGhpcy5fdXNlU2Vzc2lvbihhc3luYyAocmVzdWx0MikgPT4gewogICAgICAgIHJldHVybiByZXN1bHQyOwogICAgICB9KTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CiAgLyoqCiAgICogQWNxdWlyZXMgYSBnbG9iYWwgbG9jayBiYXNlZCBvbiB0aGUgc3RvcmFnZSBrZXkuCiAgICovCiAgYXN5bmMgX2FjcXVpcmVMb2NrKGFjcXVpcmVUaW1lb3V0LCBmbikgewogICAgdGhpcy5fZGVidWcoIiNfYWNxdWlyZUxvY2siLCAiYmVnaW4iLCBhY3F1aXJlVGltZW91dCk7CiAgICB0cnkgewogICAgICBpZiAodGhpcy5sb2NrQWNxdWlyZWQpIHsKICAgICAgICBjb25zdCBsYXN0MiA9IHRoaXMucGVuZGluZ0luTG9jay5sZW5ndGggPyB0aGlzLnBlbmRpbmdJbkxvY2tbdGhpcy5wZW5kaW5nSW5Mb2NrLmxlbmd0aCAtIDFdIDogUHJvbWlzZS5yZXNvbHZlKCk7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gKGFzeW5jICgpID0+IHsKICAgICAgICAgIGF3YWl0IGxhc3QyOwogICAgICAgICAgcmV0dXJuIGF3YWl0IGZuKCk7CiAgICAgICAgfSkoKTsKICAgICAgICB0aGlzLnBlbmRpbmdJbkxvY2sucHVzaCgoYXN5bmMgKCkgPT4gewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgcmVzdWx0OwogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgfQogICAgICAgIH0pKCkpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGF3YWl0IHRoaXMubG9jayhgbG9jazoke3RoaXMuc3RvcmFnZUtleX1gLCBhY3F1aXJlVGltZW91dCwgYXN5bmMgKCkgPT4gewogICAgICAgIHRoaXMuX2RlYnVnKCIjX2FjcXVpcmVMb2NrIiwgImxvY2sgYWNxdWlyZWQgZm9yIHN0b3JhZ2Uga2V5IiwgdGhpcy5zdG9yYWdlS2V5KTsKICAgICAgICB0cnkgewogICAgICAgICAgdGhpcy5sb2NrQWNxdWlyZWQgPSB0cnVlOwogICAgICAgICAgY29uc3QgcmVzdWx0ID0gZm4oKTsKICAgICAgICAgIHRoaXMucGVuZGluZ0luTG9jay5wdXNoKChhc3luYyAoKSA9PiB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgYXdhaXQgcmVzdWx0OwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pKCkpOwogICAgICAgICAgYXdhaXQgcmVzdWx0OwogICAgICAgICAgd2hpbGUgKHRoaXMucGVuZGluZ0luTG9jay5sZW5ndGgpIHsKICAgICAgICAgICAgY29uc3Qgd2FpdE9uID0gWy4uLnRoaXMucGVuZGluZ0luTG9ja107CiAgICAgICAgICAgIGF3YWl0IFByb21pc2UuYWxsKHdhaXRPbik7CiAgICAgICAgICAgIHRoaXMucGVuZGluZ0luTG9jay5zcGxpY2UoMCwgd2FpdE9uLmxlbmd0aCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gYXdhaXQgcmVzdWx0OwogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICB0aGlzLl9kZWJ1ZygiI19hY3F1aXJlTG9jayIsICJsb2NrIHJlbGVhc2VkIGZvciBzdG9yYWdlIGtleSIsIHRoaXMuc3RvcmFnZUtleSk7CiAgICAgICAgICB0aGlzLmxvY2tBY3F1aXJlZCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGZpbmFsbHkgewogICAgICB0aGlzLl9kZWJ1ZygiI19hY3F1aXJlTG9jayIsICJlbmQiKTsKICAgIH0KICB9CiAgLyoqCiAgICogVXNlIGluc3RlYWQgb2Yge0BsaW5rICNnZXRTZXNzaW9ufSBpbnNpZGUgdGhlIGxpYnJhcnkuIEl0IGlzCiAgICogc2VtYW50aWNhbGx5IHVzdWFsbHkgd2hhdCB5b3Ugd2FudCwgYXMgZ2V0dGluZyBhIHNlc3Npb24gaW52b2x2ZXMgc29tZQogICAqIHByb2Nlc3NpbmcgYWZ0ZXJ3YXJkcyB0aGF0IHJlcXVpcmVzIG9ubHkgb25lIGNsaWVudCBvcGVyYXRpbmcgb24gdGhlCiAgICogc2Vzc2lvbiBhdCBvbmNlIGFjcm9zcyBtdWx0aXBsZSB0YWJzIG9yIHByb2Nlc3Nlcy4KICAgKi8KICBhc3luYyBfdXNlU2Vzc2lvbihmbikgewogICAgdGhpcy5fZGVidWcoIiNfdXNlU2Vzc2lvbiIsICJiZWdpbiIpOwogICAgdHJ5IHsKICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5fX2xvYWRTZXNzaW9uKCk7CiAgICAgIHJldHVybiBhd2FpdCBmbihyZXN1bHQpOwogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fZGVidWcoIiNfdXNlU2Vzc2lvbiIsICJlbmQiKTsKICAgIH0KICB9CiAgLyoqCiAgICogTkVWRVIgVVNFIERJUkVDVExZIQogICAqCiAgICogQWx3YXlzIHVzZSB7QGxpbmsgI191c2VTZXNzaW9ufS4KICAgKi8KICBhc3luYyBfX2xvYWRTZXNzaW9uKCkgewogICAgdGhpcy5fZGVidWcoIiNfX2xvYWRTZXNzaW9uKCkiLCAiYmVnaW4iKTsKICAgIGlmICghdGhpcy5sb2NrQWNxdWlyZWQpIHsKICAgICAgdGhpcy5fZGVidWcoIiNfX2xvYWRTZXNzaW9uKCkiLCAidXNlZCBvdXRzaWRlIG9mIGFuIGFjcXVpcmVkIGxvY2shIiwgbmV3IEVycm9yKCkuc3RhY2spOwogICAgfQogICAgdHJ5IHsKICAgICAgbGV0IGN1cnJlbnRTZXNzaW9uID0gbnVsbDsKICAgICAgY29uc3QgbWF5YmVTZXNzaW9uID0gYXdhaXQgZ2V0SXRlbUFzeW5jKHRoaXMuc3RvcmFnZSwgdGhpcy5zdG9yYWdlS2V5KTsKICAgICAgdGhpcy5fZGVidWcoIiNnZXRTZXNzaW9uKCkiLCAic2Vzc2lvbiBmcm9tIHN0b3JhZ2UiLCBtYXliZVNlc3Npb24pOwogICAgICBpZiAobWF5YmVTZXNzaW9uICE9PSBudWxsKSB7CiAgICAgICAgaWYgKHRoaXMuX2lzVmFsaWRTZXNzaW9uKG1heWJlU2Vzc2lvbikpIHsKICAgICAgICAgIGN1cnJlbnRTZXNzaW9uID0gbWF5YmVTZXNzaW9uOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzLl9kZWJ1ZygiI2dldFNlc3Npb24oKSIsICJzZXNzaW9uIGZyb20gc3RvcmFnZSBpcyBub3QgdmFsaWQiKTsKICAgICAgICAgIGF3YWl0IHRoaXMuX3JlbW92ZVNlc3Npb24oKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKCFjdXJyZW50U2Vzc2lvbikgewogICAgICAgIHJldHVybiB7IGRhdGE6IHsgc2Vzc2lvbjogbnVsbCB9LCBlcnJvcjogbnVsbCB9OwogICAgICB9CiAgICAgIGNvbnN0IGhhc0V4cGlyZWQgPSBjdXJyZW50U2Vzc2lvbi5leHBpcmVzX2F0ID8gY3VycmVudFNlc3Npb24uZXhwaXJlc19hdCAqIDFlMyAtIERhdGUubm93KCkgPCBFWFBJUllfTUFSR0lOX01TIDogZmFsc2U7CiAgICAgIHRoaXMuX2RlYnVnKCIjX19sb2FkU2Vzc2lvbigpIiwgYHNlc3Npb24gaGFzJHtoYXNFeHBpcmVkID8gIiIgOiAiIG5vdCJ9IGV4cGlyZWRgLCAiZXhwaXJlc19hdCIsIGN1cnJlbnRTZXNzaW9uLmV4cGlyZXNfYXQpOwogICAgICBpZiAoIWhhc0V4cGlyZWQpIHsKICAgICAgICBpZiAodGhpcy51c2VyU3RvcmFnZSkgewogICAgICAgICAgY29uc3QgbWF5YmVVc2VyID0gYXdhaXQgZ2V0SXRlbUFzeW5jKHRoaXMudXNlclN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSArICItdXNlciIpOwogICAgICAgICAgaWYgKG1heWJlVXNlciA9PT0gbnVsbCB8fCBtYXliZVVzZXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG1heWJlVXNlci51c2VyKSB7CiAgICAgICAgICAgIGN1cnJlbnRTZXNzaW9uLnVzZXIgPSBtYXliZVVzZXIudXNlcjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGN1cnJlbnRTZXNzaW9uLnVzZXIgPSB1c2VyTm90QXZhaWxhYmxlUHJveHkoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuc3RvcmFnZS5pc1NlcnZlciAmJiBjdXJyZW50U2Vzc2lvbi51c2VyICYmICFjdXJyZW50U2Vzc2lvbi51c2VyLl9faXNVc2VyTm90QXZhaWxhYmxlUHJveHkpIHsKICAgICAgICAgIGNvbnN0IHN1cHByZXNzV2FybmluZ1JlZiA9IHsgdmFsdWU6IHRoaXMuc3VwcHJlc3NHZXRTZXNzaW9uV2FybmluZyB9OwogICAgICAgICAgY3VycmVudFNlc3Npb24udXNlciA9IGluc2VjdXJlVXNlcldhcm5pbmdQcm94eShjdXJyZW50U2Vzc2lvbi51c2VyLCBzdXBwcmVzc1dhcm5pbmdSZWYpOwogICAgICAgICAgaWYgKHN1cHByZXNzV2FybmluZ1JlZi52YWx1ZSkgewogICAgICAgICAgICB0aGlzLnN1cHByZXNzR2V0U2Vzc2lvbldhcm5pbmcgPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4geyBkYXRhOiB7IHNlc3Npb246IGN1cnJlbnRTZXNzaW9uIH0sIGVycm9yOiBudWxsIH07CiAgICAgIH0KICAgICAgY29uc3QgeyBkYXRhOiBzZXNzaW9uLCBlcnJvciB9ID0gYXdhaXQgdGhpcy5fY2FsbFJlZnJlc2hUb2tlbihjdXJyZW50U2Vzc2lvbi5yZWZyZXNoX3Rva2VuKTsKICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyBzZXNzaW9uIH0sIGVycm9yOiBudWxsIH0pOwogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fZGVidWcoIiNfX2xvYWRTZXNzaW9uKCkiLCAiZW5kIik7CiAgICB9CiAgfQogIC8qKgogICAqIEdldHMgdGhlIGN1cnJlbnQgdXNlciBkZXRhaWxzIGlmIHRoZXJlIGlzIGFuIGV4aXN0aW5nIHNlc3Npb24uIFRoaXMgbWV0aG9kCiAgICogcGVyZm9ybXMgYSBuZXR3b3JrIHJlcXVlc3QgdG8gdGhlIFN1cGFiYXNlIEF1dGggc2VydmVyLCBzbyB0aGUgcmV0dXJuZWQKICAgKiB2YWx1ZSBpcyBhdXRoZW50aWMgYW5kIGNhbiBiZSB1c2VkIHRvIGJhc2UgYXV0aG9yaXphdGlvbiBydWxlcyBvbi4KICAgKgogICAqIEBwYXJhbSBqd3QgVGFrZXMgaW4gYW4gb3B0aW9uYWwgYWNjZXNzIHRva2VuIEpXVC4gSWYgbm8gSldUIGlzIHByb3ZpZGVkLCB0aGUgSldUIGZyb20gdGhlIGN1cnJlbnQgc2Vzc2lvbiBpcyB1c2VkLgogICAqLwogIGFzeW5jIGdldFVzZXIoand0KSB7CiAgICBpZiAoand0KSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9nZXRVc2VyKGp3dCk7CiAgICB9CiAgICBhd2FpdCB0aGlzLmluaXRpYWxpemVQcm9taXNlOwogICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5fYWNxdWlyZUxvY2sodGhpcy5sb2NrQWNxdWlyZVRpbWVvdXQsIGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2dldFVzZXIoKTsKICAgIH0pOwogICAgaWYgKHJlc3VsdC5kYXRhLnVzZXIpIHsKICAgICAgdGhpcy5zdXBwcmVzc0dldFNlc3Npb25XYXJuaW5nID0gdHJ1ZTsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7CiAgfQogIGFzeW5jIF9nZXRVc2VyKGp3dCkgewogICAgdHJ5IHsKICAgICAgaWYgKGp3dCkgewogICAgICAgIHJldHVybiBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiR0VUIiwgYCR7dGhpcy51cmx9L3VzZXJgLCB7CiAgICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgICBqd3QsCiAgICAgICAgICB4Zm9ybTogX3VzZXJSZXNwb25zZQogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl91c2VTZXNzaW9uKGFzeW5jIChyZXN1bHQpID0+IHsKICAgICAgICB2YXIgX2EsIF9iLCBfYzsKICAgICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSByZXN1bHQ7CiAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9CiAgICAgICAgaWYgKCEoKF9hID0gZGF0YS5zZXNzaW9uKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuYWNjZXNzX3Rva2VuKSAmJiAhdGhpcy5oYXNDdXN0b21BdXRob3JpemF0aW9uSGVhZGVyKSB7CiAgICAgICAgICByZXR1cm4geyBkYXRhOiB7IHVzZXI6IG51bGwgfSwgZXJyb3I6IG5ldyBBdXRoU2Vzc2lvbk1pc3NpbmdFcnJvcigpIH07CiAgICAgICAgfQogICAgICAgIHJldHVybiBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiR0VUIiwgYCR7dGhpcy51cmx9L3VzZXJgLCB7CiAgICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgICBqd3Q6IChfYyA9IChfYiA9IGRhdGEuc2Vzc2lvbikgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLmFjY2Vzc190b2tlbikgIT09IG51bGwgJiYgX2MgIT09IHZvaWQgMCA/IF9jIDogdm9pZCAwLAogICAgICAgICAgeGZvcm06IF91c2VyUmVzcG9uc2UKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgaWYgKGlzQXV0aFNlc3Npb25NaXNzaW5nRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgICBhd2FpdCB0aGlzLl9yZW1vdmVTZXNzaW9uKCk7CiAgICAgICAgICBhd2FpdCByZW1vdmVJdGVtQXN5bmModGhpcy5zdG9yYWdlLCBgJHt0aGlzLnN0b3JhZ2VLZXl9LWNvZGUtdmVyaWZpZXJgKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogVXBkYXRlcyB1c2VyIGRhdGEgZm9yIGEgbG9nZ2VkIGluIHVzZXIuCiAgICovCiAgYXN5bmMgdXBkYXRlVXNlcihhdHRyaWJ1dGVzLCBvcHRpb25zID0ge30pIHsKICAgIGF3YWl0IHRoaXMuaW5pdGlhbGl6ZVByb21pc2U7CiAgICByZXR1cm4gYXdhaXQgdGhpcy5fYWNxdWlyZUxvY2sodGhpcy5sb2NrQWNxdWlyZVRpbWVvdXQsIGFzeW5jICgpID0+IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3VwZGF0ZVVzZXIoYXR0cmlidXRlcywgb3B0aW9ucyk7CiAgICB9KTsKICB9CiAgYXN5bmMgX3VwZGF0ZVVzZXIoYXR0cmlidXRlcywgb3B0aW9ucyA9IHt9KSB7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fdXNlU2Vzc2lvbihhc3luYyAocmVzdWx0KSA9PiB7CiAgICAgICAgY29uc3QgeyBkYXRhOiBzZXNzaW9uRGF0YSwgZXJyb3I6IHNlc3Npb25FcnJvciB9ID0gcmVzdWx0OwogICAgICAgIGlmIChzZXNzaW9uRXJyb3IpIHsKICAgICAgICAgIHRocm93IHNlc3Npb25FcnJvcjsKICAgICAgICB9CiAgICAgICAgaWYgKCFzZXNzaW9uRGF0YS5zZXNzaW9uKSB7CiAgICAgICAgICB0aHJvdyBuZXcgQXV0aFNlc3Npb25NaXNzaW5nRXJyb3IoKTsKICAgICAgICB9CiAgICAgICAgY29uc3Qgc2Vzc2lvbiA9IHNlc3Npb25EYXRhLnNlc3Npb247CiAgICAgICAgbGV0IGNvZGVDaGFsbGVuZ2UgPSBudWxsOwogICAgICAgIGxldCBjb2RlQ2hhbGxlbmdlTWV0aG9kID0gbnVsbDsKICAgICAgICBpZiAodGhpcy5mbG93VHlwZSA9PT0gInBrY2UiICYmIGF0dHJpYnV0ZXMuZW1haWwgIT0gbnVsbCkgewogICAgICAgICAgOwogICAgICAgICAgW2NvZGVDaGFsbGVuZ2UsIGNvZGVDaGFsbGVuZ2VNZXRob2RdID0gYXdhaXQgZ2V0Q29kZUNoYWxsZW5nZUFuZE1ldGhvZCh0aGlzLnN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3I6IHVzZXJFcnJvciB9ID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBVVCIsIGAke3RoaXMudXJsfS91c2VyYCwgewogICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgcmVkaXJlY3RUbzogb3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmVtYWlsUmVkaXJlY3RUbywKICAgICAgICAgIGJvZHk6IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgYXR0cmlidXRlcyksIHsgY29kZV9jaGFsbGVuZ2U6IGNvZGVDaGFsbGVuZ2UsIGNvZGVfY2hhbGxlbmdlX21ldGhvZDogY29kZUNoYWxsZW5nZU1ldGhvZCB9KSwKICAgICAgICAgIGp3dDogc2Vzc2lvbi5hY2Nlc3NfdG9rZW4sCiAgICAgICAgICB4Zm9ybTogX3VzZXJSZXNwb25zZQogICAgICAgIH0pOwogICAgICAgIGlmICh1c2VyRXJyb3IpIHsKICAgICAgICAgIHRocm93IHVzZXJFcnJvcjsKICAgICAgICB9CiAgICAgICAgc2Vzc2lvbi51c2VyID0gZGF0YS51c2VyOwogICAgICAgIGF3YWl0IHRoaXMuX3NhdmVTZXNzaW9uKHNlc3Npb24pOwogICAgICAgIGF3YWl0IHRoaXMuX25vdGlmeUFsbFN1YnNjcmliZXJzKCJVU0VSX1VQREFURUQiLCBzZXNzaW9uKTsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBzZXNzaW9uLnVzZXIgfSwgZXJyb3I6IG51bGwgfSk7CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgYXdhaXQgcmVtb3ZlSXRlbUFzeW5jKHRoaXMuc3RvcmFnZSwgYCR7dGhpcy5zdG9yYWdlS2V5fS1jb2RlLXZlcmlmaWVyYCk7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBTZXRzIHRoZSBzZXNzaW9uIGRhdGEgZnJvbSB0aGUgY3VycmVudCBzZXNzaW9uLiBJZiB0aGUgY3VycmVudCBzZXNzaW9uIGlzIGV4cGlyZWQsIHNldFNlc3Npb24gd2lsbCB0YWtlIGNhcmUgb2YgcmVmcmVzaGluZyBpdCB0byBvYnRhaW4gYSBuZXcgc2Vzc2lvbi4KICAgKiBJZiB0aGUgcmVmcmVzaCB0b2tlbiBvciBhY2Nlc3MgdG9rZW4gaW4gdGhlIGN1cnJlbnQgc2Vzc2lvbiBpcyBpbnZhbGlkLCBhbiBlcnJvciB3aWxsIGJlIHRocm93bi4KICAgKiBAcGFyYW0gY3VycmVudFNlc3Npb24gVGhlIGN1cnJlbnQgc2Vzc2lvbiB0aGF0IG1pbmltYWxseSBjb250YWlucyBhbiBhY2Nlc3MgdG9rZW4gYW5kIHJlZnJlc2ggdG9rZW4uCiAgICovCiAgYXN5bmMgc2V0U2Vzc2lvbihjdXJyZW50U2Vzc2lvbikgewogICAgYXdhaXQgdGhpcy5pbml0aWFsaXplUHJvbWlzZTsKICAgIHJldHVybiBhd2FpdCB0aGlzLl9hY3F1aXJlTG9jayh0aGlzLmxvY2tBY3F1aXJlVGltZW91dCwgYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fc2V0U2Vzc2lvbihjdXJyZW50U2Vzc2lvbik7CiAgICB9KTsKICB9CiAgYXN5bmMgX3NldFNlc3Npb24oY3VycmVudFNlc3Npb24pIHsKICAgIHRyeSB7CiAgICAgIGlmICghY3VycmVudFNlc3Npb24uYWNjZXNzX3Rva2VuIHx8ICFjdXJyZW50U2Vzc2lvbi5yZWZyZXNoX3Rva2VuKSB7CiAgICAgICAgdGhyb3cgbmV3IEF1dGhTZXNzaW9uTWlzc2luZ0Vycm9yKCk7CiAgICAgIH0KICAgICAgY29uc3QgdGltZU5vdyA9IERhdGUubm93KCkgLyAxZTM7CiAgICAgIGxldCBleHBpcmVzQXQyID0gdGltZU5vdzsKICAgICAgbGV0IGhhc0V4cGlyZWQgPSB0cnVlOwogICAgICBsZXQgc2Vzc2lvbiA9IG51bGw7CiAgICAgIGNvbnN0IHsgcGF5bG9hZCB9ID0gZGVjb2RlSldUKGN1cnJlbnRTZXNzaW9uLmFjY2Vzc190b2tlbik7CiAgICAgIGlmIChwYXlsb2FkLmV4cCkgewogICAgICAgIGV4cGlyZXNBdDIgPSBwYXlsb2FkLmV4cDsKICAgICAgICBoYXNFeHBpcmVkID0gZXhwaXJlc0F0MiA8PSB0aW1lTm93OwogICAgICB9CiAgICAgIGlmIChoYXNFeHBpcmVkKSB7CiAgICAgICAgY29uc3QgeyBkYXRhOiByZWZyZXNoZWRTZXNzaW9uLCBlcnJvciB9ID0gYXdhaXQgdGhpcy5fY2FsbFJlZnJlc2hUb2tlbihjdXJyZW50U2Vzc2lvbi5yZWZyZXNoX3Rva2VuKTsKICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgICAgfQogICAgICAgIGlmICghcmVmcmVzaGVkU2Vzc2lvbikgewogICAgICAgICAgcmV0dXJuIHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yOiBudWxsIH07CiAgICAgICAgfQogICAgICAgIHNlc3Npb24gPSByZWZyZXNoZWRTZXNzaW9uOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHRoaXMuX2dldFVzZXIoY3VycmVudFNlc3Npb24uYWNjZXNzX3Rva2VuKTsKICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgICAgfQogICAgICAgIHNlc3Npb24gPSB7CiAgICAgICAgICBhY2Nlc3NfdG9rZW46IGN1cnJlbnRTZXNzaW9uLmFjY2Vzc190b2tlbiwKICAgICAgICAgIHJlZnJlc2hfdG9rZW46IGN1cnJlbnRTZXNzaW9uLnJlZnJlc2hfdG9rZW4sCiAgICAgICAgICB1c2VyOiBkYXRhLnVzZXIsCiAgICAgICAgICB0b2tlbl90eXBlOiAiYmVhcmVyIiwKICAgICAgICAgIGV4cGlyZXNfaW46IGV4cGlyZXNBdDIgLSB0aW1lTm93LAogICAgICAgICAgZXhwaXJlc19hdDogZXhwaXJlc0F0MgogICAgICAgIH07CiAgICAgICAgYXdhaXQgdGhpcy5fc2F2ZVNlc3Npb24oc2Vzc2lvbik7CiAgICAgICAgYXdhaXQgdGhpcy5fbm90aWZ5QWxsU3Vic2NyaWJlcnMoIlNJR05FRF9JTiIsIHNlc3Npb24pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IHNlc3Npb24udXNlciwgc2Vzc2lvbiB9LCBlcnJvcjogbnVsbCB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyBzZXNzaW9uOiBudWxsLCB1c2VyOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBSZXR1cm5zIGEgbmV3IHNlc3Npb24sIHJlZ2FyZGxlc3Mgb2YgZXhwaXJ5IHN0YXR1cy4KICAgKiBUYWtlcyBpbiBhbiBvcHRpb25hbCBjdXJyZW50IHNlc3Npb24uIElmIG5vdCBwYXNzZWQgaW4sIHRoZW4gcmVmcmVzaFNlc3Npb24oKSB3aWxsIGF0dGVtcHQgdG8gcmV0cmlldmUgaXQgZnJvbSBnZXRTZXNzaW9uKCkuCiAgICogSWYgdGhlIGN1cnJlbnQgc2Vzc2lvbidzIHJlZnJlc2ggdG9rZW4gaXMgaW52YWxpZCwgYW4gZXJyb3Igd2lsbCBiZSB0aHJvd24uCiAgICogQHBhcmFtIGN1cnJlbnRTZXNzaW9uIFRoZSBjdXJyZW50IHNlc3Npb24uIElmIHBhc3NlZCBpbiwgaXQgbXVzdCBjb250YWluIGEgcmVmcmVzaCB0b2tlbi4KICAgKi8KICBhc3luYyByZWZyZXNoU2Vzc2lvbihjdXJyZW50U2Vzc2lvbikgewogICAgYXdhaXQgdGhpcy5pbml0aWFsaXplUHJvbWlzZTsKICAgIHJldHVybiBhd2FpdCB0aGlzLl9hY3F1aXJlTG9jayh0aGlzLmxvY2tBY3F1aXJlVGltZW91dCwgYXN5bmMgKCkgPT4gewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fcmVmcmVzaFNlc3Npb24oY3VycmVudFNlc3Npb24pOwogICAgfSk7CiAgfQogIGFzeW5jIF9yZWZyZXNoU2Vzc2lvbihjdXJyZW50U2Vzc2lvbikgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3VzZVNlc3Npb24oYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICAgIHZhciBfYTsKICAgICAgICBpZiAoIWN1cnJlbnRTZXNzaW9uKSB7CiAgICAgICAgICBjb25zdCB7IGRhdGEsIGVycm9yOiBlcnJvcjIgfSA9IHJlc3VsdDsKICAgICAgICAgIGlmIChlcnJvcjIpIHsKICAgICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgICAgfQogICAgICAgICAgY3VycmVudFNlc3Npb24gPSAoX2EgPSBkYXRhLnNlc3Npb24pICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IHZvaWQgMDsKICAgICAgICB9CiAgICAgICAgaWYgKCEoY3VycmVudFNlc3Npb24gPT09IG51bGwgfHwgY3VycmVudFNlc3Npb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IGN1cnJlbnRTZXNzaW9uLnJlZnJlc2hfdG9rZW4pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgQXV0aFNlc3Npb25NaXNzaW5nRXJyb3IoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgeyBkYXRhOiBzZXNzaW9uLCBlcnJvciB9ID0gYXdhaXQgdGhpcy5fY2FsbFJlZnJlc2hUb2tlbihjdXJyZW50U2Vzc2lvbi5yZWZyZXNoX3Rva2VuKTsKICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgICAgfQogICAgICAgIGlmICghc2Vzc2lvbikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvcjogbnVsbCB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogc2Vzc2lvbi51c2VyLCBzZXNzaW9uIH0sIGVycm9yOiBudWxsIH0pOwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyB1c2VyOiBudWxsLCBzZXNzaW9uOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBHZXRzIHRoZSBzZXNzaW9uIGRhdGEgZnJvbSBhIFVSTCBzdHJpbmcKICAgKi8KICBhc3luYyBfZ2V0U2Vzc2lvbkZyb21VUkwocGFyYW1zLCBjYWxsYmFja1VybFR5cGUpIHsKICAgIHRyeSB7CiAgICAgIGlmICghaXNCcm93c2VyKCkpCiAgICAgICAgdGhyb3cgbmV3IEF1dGhJbXBsaWNpdEdyYW50UmVkaXJlY3RFcnJvcigiTm8gYnJvd3NlciBkZXRlY3RlZC4iKTsKICAgICAgaWYgKHBhcmFtcy5lcnJvciB8fCBwYXJhbXMuZXJyb3JfZGVzY3JpcHRpb24gfHwgcGFyYW1zLmVycm9yX2NvZGUpIHsKICAgICAgICB0aHJvdyBuZXcgQXV0aEltcGxpY2l0R3JhbnRSZWRpcmVjdEVycm9yKHBhcmFtcy5lcnJvcl9kZXNjcmlwdGlvbiB8fCAiRXJyb3IgaW4gVVJMIHdpdGggdW5zcGVjaWZpZWQgZXJyb3JfZGVzY3JpcHRpb24iLCB7CiAgICAgICAgICBlcnJvcjogcGFyYW1zLmVycm9yIHx8ICJ1bnNwZWNpZmllZF9lcnJvciIsCiAgICAgICAgICBjb2RlOiBwYXJhbXMuZXJyb3JfY29kZSB8fCAidW5zcGVjaWZpZWRfY29kZSIKICAgICAgICB9KTsKICAgICAgfQogICAgICBzd2l0Y2ggKGNhbGxiYWNrVXJsVHlwZSkgewogICAgICAgIGNhc2UgImltcGxpY2l0IjoKICAgICAgICAgIGlmICh0aGlzLmZsb3dUeXBlID09PSAicGtjZSIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEF1dGhQS0NFR3JhbnRDb2RlRXhjaGFuZ2VFcnJvcigiTm90IGEgdmFsaWQgUEtDRSBmbG93IHVybC4iKTsKICAgICAgICAgIH0KICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgInBrY2UiOgogICAgICAgICAgaWYgKHRoaXMuZmxvd1R5cGUgPT09ICJpbXBsaWNpdCIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEF1dGhJbXBsaWNpdEdyYW50UmVkaXJlY3RFcnJvcigiTm90IGEgdmFsaWQgaW1wbGljaXQgZ3JhbnQgZmxvdyB1cmwuIik7CiAgICAgICAgICB9CiAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICB9CiAgICAgIGlmIChjYWxsYmFja1VybFR5cGUgPT09ICJwa2NlIikgewogICAgICAgIHRoaXMuX2RlYnVnKCIjX2luaXRpYWxpemUoKSIsICJiZWdpbiIsICJpcyBQS0NFIGZsb3ciLCB0cnVlKTsKICAgICAgICBpZiAoIXBhcmFtcy5jb2RlKQogICAgICAgICAgdGhyb3cgbmV3IEF1dGhQS0NFR3JhbnRDb2RlRXhjaGFuZ2VFcnJvcigiTm8gY29kZSBkZXRlY3RlZC4iKTsKICAgICAgICBjb25zdCB7IGRhdGE6IGRhdGEyLCBlcnJvcjogZXJyb3IyIH0gPSBhd2FpdCB0aGlzLl9leGNoYW5nZUNvZGVGb3JTZXNzaW9uKHBhcmFtcy5jb2RlKTsKICAgICAgICBpZiAoZXJyb3IyKQogICAgICAgICAgdGhyb3cgZXJyb3IyOwogICAgICAgIGNvbnN0IHVybCA9IG5ldyBVUkwod2luZG93LmxvY2F0aW9uLmhyZWYpOwogICAgICAgIHVybC5zZWFyY2hQYXJhbXMuZGVsZXRlKCJjb2RlIik7CiAgICAgICAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKHdpbmRvdy5oaXN0b3J5LnN0YXRlLCAiIiwgdXJsLnRvU3RyaW5nKCkpOwogICAgICAgIHJldHVybiB7IGRhdGE6IHsgc2Vzc2lvbjogZGF0YTIuc2Vzc2lvbiwgcmVkaXJlY3RUeXBlOiBudWxsIH0sIGVycm9yOiBudWxsIH07CiAgICAgIH0KICAgICAgY29uc3QgeyBwcm92aWRlcl90b2tlbiwgcHJvdmlkZXJfcmVmcmVzaF90b2tlbiwgYWNjZXNzX3Rva2VuLCByZWZyZXNoX3Rva2VuLCBleHBpcmVzX2luLCBleHBpcmVzX2F0LCB0b2tlbl90eXBlIH0gPSBwYXJhbXM7CiAgICAgIGlmICghYWNjZXNzX3Rva2VuIHx8ICFleHBpcmVzX2luIHx8ICFyZWZyZXNoX3Rva2VuIHx8ICF0b2tlbl90eXBlKSB7CiAgICAgICAgdGhyb3cgbmV3IEF1dGhJbXBsaWNpdEdyYW50UmVkaXJlY3RFcnJvcigiTm8gc2Vzc2lvbiBkZWZpbmVkIGluIFVSTCIpOwogICAgICB9CiAgICAgIGNvbnN0IHRpbWVOb3cgPSBNYXRoLnJvdW5kKERhdGUubm93KCkgLyAxZTMpOwogICAgICBjb25zdCBleHBpcmVzSW4gPSBwYXJzZUludChleHBpcmVzX2luKTsKICAgICAgbGV0IGV4cGlyZXNBdDIgPSB0aW1lTm93ICsgZXhwaXJlc0luOwogICAgICBpZiAoZXhwaXJlc19hdCkgewogICAgICAgIGV4cGlyZXNBdDIgPSBwYXJzZUludChleHBpcmVzX2F0KTsKICAgICAgfQogICAgICBjb25zdCBhY3R1YWxseUV4cGlyZXNJbiA9IGV4cGlyZXNBdDIgLSB0aW1lTm93OwogICAgICBpZiAoYWN0dWFsbHlFeHBpcmVzSW4gKiAxZTMgPD0gQVVUT19SRUZSRVNIX1RJQ0tfRFVSQVRJT05fTVMpIHsKICAgICAgICBjb25zb2xlLndhcm4oYEBzdXBhYmFzZS9nb3RydWUtanM6IFNlc3Npb24gYXMgcmV0cmlldmVkIGZyb20gVVJMIGV4cGlyZXMgaW4gJHthY3R1YWxseUV4cGlyZXNJbn1zLCBzaG91bGQgaGF2ZSBiZWVuIGNsb3NlciB0byAke2V4cGlyZXNJbn1zYCk7CiAgICAgIH0KICAgICAgY29uc3QgaXNzdWVkQXQgPSBleHBpcmVzQXQyIC0gZXhwaXJlc0luOwogICAgICBpZiAodGltZU5vdyAtIGlzc3VlZEF0ID49IDEyMCkgewogICAgICAgIGNvbnNvbGUud2FybigiQHN1cGFiYXNlL2dvdHJ1ZS1qczogU2Vzc2lvbiBhcyByZXRyaWV2ZWQgZnJvbSBVUkwgd2FzIGlzc3VlZCBvdmVyIDEyMHMgYWdvLCBVUkwgY291bGQgYmUgc3RhbGUiLCBpc3N1ZWRBdCwgZXhwaXJlc0F0MiwgdGltZU5vdyk7CiAgICAgIH0gZWxzZSBpZiAodGltZU5vdyAtIGlzc3VlZEF0IDwgMCkgewogICAgICAgIGNvbnNvbGUud2FybigiQHN1cGFiYXNlL2dvdHJ1ZS1qczogU2Vzc2lvbiBhcyByZXRyaWV2ZWQgZnJvbSBVUkwgd2FzIGlzc3VlZCBpbiB0aGUgZnV0dXJlPyBDaGVjayB0aGUgZGV2aWNlIGNsb2NrIGZvciBza2V3IiwgaXNzdWVkQXQsIGV4cGlyZXNBdDIsIHRpbWVOb3cpOwogICAgICB9CiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHRoaXMuX2dldFVzZXIoYWNjZXNzX3Rva2VuKTsKICAgICAgaWYgKGVycm9yKQogICAgICAgIHRocm93IGVycm9yOwogICAgICBjb25zdCBzZXNzaW9uID0gewogICAgICAgIHByb3ZpZGVyX3Rva2VuLAogICAgICAgIHByb3ZpZGVyX3JlZnJlc2hfdG9rZW4sCiAgICAgICAgYWNjZXNzX3Rva2VuLAogICAgICAgIGV4cGlyZXNfaW46IGV4cGlyZXNJbiwKICAgICAgICBleHBpcmVzX2F0OiBleHBpcmVzQXQyLAogICAgICAgIHJlZnJlc2hfdG9rZW4sCiAgICAgICAgdG9rZW5fdHlwZSwKICAgICAgICB1c2VyOiBkYXRhLnVzZXIKICAgICAgfTsKICAgICAgd2luZG93LmxvY2F0aW9uLmhhc2ggPSAiIjsKICAgICAgdGhpcy5fZGVidWcoIiNfZ2V0U2Vzc2lvbkZyb21VUkwoKSIsICJjbGVhcmluZyB3aW5kb3cubG9jYXRpb24uaGFzaCIpOwogICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogeyBzZXNzaW9uLCByZWRpcmVjdFR5cGU6IHBhcmFtcy50eXBlIH0sIGVycm9yOiBudWxsIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHNlc3Npb246IG51bGwsIHJlZGlyZWN0VHlwZTogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBjdXJyZW50IFVSTCBjb250YWlucyBwYXJhbWV0ZXJzIGdpdmVuIGJ5IGFuIGltcGxpY2l0IG9hdXRoIGdyYW50IGZsb3cgKGh0dHBzOi8vd3d3LnJmYy1lZGl0b3Iub3JnL3JmYy9yZmM2NzQ5Lmh0bWwjc2VjdGlvbi00LjIpCiAgICoKICAgKiBJZiBgZGV0ZWN0U2Vzc2lvbkluVXJsYCBpcyBhIGZ1bmN0aW9uLCBpdCB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoZSBVUkwgYW5kIHBhcmFtcyB0byBkZXRlcm1pbmUKICAgKiBpZiB0aGUgVVJMIHNob3VsZCBiZSBwcm9jZXNzZWQgYXMgYSBTdXBhYmFzZSBhdXRoIGNhbGxiYWNrLiBUaGlzIGFsbG93cyB1c2VycyB0byBleGNsdWRlCiAgICogVVJMcyBmcm9tIG90aGVyIE9BdXRoIHByb3ZpZGVycyAoZS5nLiwgRmFjZWJvb2sgTG9naW4pIHRoYXQgYWxzbyByZXR1cm4gYWNjZXNzX3Rva2VuIGluIHRoZSBmcmFnbWVudC4KICAgKi8KICBfaXNJbXBsaWNpdEdyYW50Q2FsbGJhY2socGFyYW1zKSB7CiAgICBpZiAodHlwZW9mIHRoaXMuZGV0ZWN0U2Vzc2lvbkluVXJsID09PSAiZnVuY3Rpb24iKSB7CiAgICAgIHJldHVybiB0aGlzLmRldGVjdFNlc3Npb25JblVybChuZXcgVVJMKHdpbmRvdy5sb2NhdGlvbi5ocmVmKSwgcGFyYW1zKTsKICAgIH0KICAgIHJldHVybiBCb29sZWFuKHBhcmFtcy5hY2Nlc3NfdG9rZW4gfHwgcGFyYW1zLmVycm9yX2Rlc2NyaXB0aW9uKTsKICB9CiAgLyoqCiAgICogQ2hlY2tzIGlmIHRoZSBjdXJyZW50IFVSTCBhbmQgYmFja2luZyBzdG9yYWdlIGNvbnRhaW4gcGFyYW1ldGVycyBnaXZlbiBieSBhIFBLQ0UgZmxvdwogICAqLwogIGFzeW5jIF9pc1BLQ0VDYWxsYmFjayhwYXJhbXMpIHsKICAgIGNvbnN0IGN1cnJlbnRTdG9yYWdlQ29udGVudCA9IGF3YWl0IGdldEl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIGAke3RoaXMuc3RvcmFnZUtleX0tY29kZS12ZXJpZmllcmApOwogICAgcmV0dXJuICEhKHBhcmFtcy5jb2RlICYmIGN1cnJlbnRTdG9yYWdlQ29udGVudCk7CiAgfQogIC8qKgogICAqIEluc2lkZSBhIGJyb3dzZXIgY29udGV4dCwgYHNpZ25PdXQoKWAgd2lsbCByZW1vdmUgdGhlIGxvZ2dlZCBpbiB1c2VyIGZyb20gdGhlIGJyb3dzZXIgc2Vzc2lvbiBhbmQgbG9nIHRoZW0gb3V0IC0gcmVtb3ZpbmcgYWxsIGl0ZW1zIGZyb20gbG9jYWxzdG9yYWdlIGFuZCB0aGVuIHRyaWdnZXIgYSBgIlNJR05FRF9PVVQiYCBldmVudC4KICAgKgogICAqIEZvciBzZXJ2ZXItc2lkZSBtYW5hZ2VtZW50LCB5b3UgY2FuIHJldm9rZSBhbGwgcmVmcmVzaCB0b2tlbnMgZm9yIGEgdXNlciBieSBwYXNzaW5nIGEgdXNlcidzIEpXVCB0aHJvdWdoIHRvIGBhdXRoLmFwaS5zaWduT3V0KEpXVDogc3RyaW5nKWAuCiAgICogVGhlcmUgaXMgbm8gd2F5IHRvIHJldm9rZSBhIHVzZXIncyBhY2Nlc3MgdG9rZW4gand0IHVudGlsIGl0IGV4cGlyZXMuIEl0IGlzIHJlY29tbWVuZGVkIHRvIHNldCBhIHNob3J0ZXIgZXhwaXJ5IG9uIHRoZSBqd3QgZm9yIHRoaXMgcmVhc29uLgogICAqCiAgICogSWYgdXNpbmcgYG90aGVyc2Agc2NvcGUsIG5vIGBTSUdORURfT1VUYCBldmVudCBpcyBmaXJlZCEKICAgKi8KICBhc3luYyBzaWduT3V0KG9wdGlvbnMgPSB7IHNjb3BlOiAiZ2xvYmFsIiB9KSB7CiAgICBhd2FpdCB0aGlzLmluaXRpYWxpemVQcm9taXNlOwogICAgcmV0dXJuIGF3YWl0IHRoaXMuX2FjcXVpcmVMb2NrKHRoaXMubG9ja0FjcXVpcmVUaW1lb3V0LCBhc3luYyAoKSA9PiB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9zaWduT3V0KG9wdGlvbnMpOwogICAgfSk7CiAgfQogIGFzeW5jIF9zaWduT3V0KHsgc2NvcGUgfSA9IHsgc2NvcGU6ICJnbG9iYWwiIH0pIHsKICAgIHJldHVybiBhd2FpdCB0aGlzLl91c2VTZXNzaW9uKGFzeW5jIChyZXN1bHQpID0+IHsKICAgICAgdmFyIF9hOwogICAgICBjb25zdCB7IGRhdGEsIGVycm9yOiBzZXNzaW9uRXJyb3IgfSA9IHJlc3VsdDsKICAgICAgaWYgKHNlc3Npb25FcnJvciAmJiAhaXNBdXRoU2Vzc2lvbk1pc3NpbmdFcnJvcihzZXNzaW9uRXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGVycm9yOiBzZXNzaW9uRXJyb3IgfSk7CiAgICAgIH0KICAgICAgY29uc3QgYWNjZXNzVG9rZW4gPSAoX2EgPSBkYXRhLnNlc3Npb24pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5hY2Nlc3NfdG9rZW47CiAgICAgIGlmIChhY2Nlc3NUb2tlbikgewogICAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IHRoaXMuYWRtaW4uc2lnbk91dChhY2Nlc3NUb2tlbiwgc2NvcGUpOwogICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgaWYgKCEoaXNBdXRoQXBpRXJyb3IoZXJyb3IpICYmIChlcnJvci5zdGF0dXMgPT09IDQwNCB8fCBlcnJvci5zdGF0dXMgPT09IDQwMSB8fCBlcnJvci5zdGF0dXMgPT09IDQwMykgfHwgaXNBdXRoU2Vzc2lvbk1pc3NpbmdFcnJvcihlcnJvcikpKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBlcnJvciB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHNjb3BlICE9PSAib3RoZXJzIikgewogICAgICAgIGF3YWl0IHRoaXMuX3JlbW92ZVNlc3Npb24oKTsKICAgICAgICBhd2FpdCByZW1vdmVJdGVtQXN5bmModGhpcy5zdG9yYWdlLCBgJHt0aGlzLnN0b3JhZ2VLZXl9LWNvZGUtdmVyaWZpZXJgKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZXJyb3I6IG51bGwgfSk7CiAgICB9KTsKICB9CiAgb25BdXRoU3RhdGVDaGFuZ2UoY2FsbGJhY2spIHsKICAgIGNvbnN0IGlkID0gZ2VuZXJhdGVDYWxsYmFja0lkKCk7CiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB7CiAgICAgIGlkLAogICAgICBjYWxsYmFjaywKICAgICAgdW5zdWJzY3JpYmU6ICgpID0+IHsKICAgICAgICB0aGlzLl9kZWJ1ZygiI3Vuc3Vic2NyaWJlKCkiLCAic3RhdGUgY2hhbmdlIGNhbGxiYWNrIHdpdGggaWQgcmVtb3ZlZCIsIGlkKTsKICAgICAgICB0aGlzLnN0YXRlQ2hhbmdlRW1pdHRlcnMuZGVsZXRlKGlkKTsKICAgICAgfQogICAgfTsKICAgIHRoaXMuX2RlYnVnKCIjb25BdXRoU3RhdGVDaGFuZ2UoKSIsICJyZWdpc3RlcmVkIGNhbGxiYWNrIHdpdGggaWQiLCBpZCk7CiAgICB0aGlzLnN0YXRlQ2hhbmdlRW1pdHRlcnMuc2V0KGlkLCBzdWJzY3JpcHRpb24pOwogICAgKGFzeW5jICgpID0+IHsKICAgICAgYXdhaXQgdGhpcy5pbml0aWFsaXplUHJvbWlzZTsKICAgICAgYXdhaXQgdGhpcy5fYWNxdWlyZUxvY2sodGhpcy5sb2NrQWNxdWlyZVRpbWVvdXQsIGFzeW5jICgpID0+IHsKICAgICAgICB0aGlzLl9lbWl0SW5pdGlhbFNlc3Npb24oaWQpOwogICAgICB9KTsKICAgIH0pKCk7CiAgICByZXR1cm4geyBkYXRhOiB7IHN1YnNjcmlwdGlvbiB9IH07CiAgfQogIGFzeW5jIF9lbWl0SW5pdGlhbFNlc3Npb24oaWQpIHsKICAgIHJldHVybiBhd2FpdCB0aGlzLl91c2VTZXNzaW9uKGFzeW5jIChyZXN1bHQpID0+IHsKICAgICAgdmFyIF9hLCBfYjsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCB7IGRhdGE6IHsgc2Vzc2lvbiB9LCBlcnJvciB9ID0gcmVzdWx0OwogICAgICAgIGlmIChlcnJvcikKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIGF3YWl0ICgoX2EgPSB0aGlzLnN0YXRlQ2hhbmdlRW1pdHRlcnMuZ2V0KGlkKSkgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmNhbGxiYWNrKCJJTklUSUFMX1NFU1NJT04iLCBzZXNzaW9uKSk7CiAgICAgICAgdGhpcy5fZGVidWcoIklOSVRJQUxfU0VTU0lPTiIsICJjYWxsYmFjayBpZCIsIGlkLCAic2Vzc2lvbiIsIHNlc3Npb24pOwogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBhd2FpdCAoKF9iID0gdGhpcy5zdGF0ZUNoYW5nZUVtaXR0ZXJzLmdldChpZCkpID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5jYWxsYmFjaygiSU5JVElBTF9TRVNTSU9OIiwgbnVsbCkpOwogICAgICAgIHRoaXMuX2RlYnVnKCJJTklUSUFMX1NFU1NJT04iLCAiY2FsbGJhY2sgaWQiLCBpZCwgImVycm9yIiwgZXJyKTsKICAgICAgICBjb25zb2xlLmVycm9yKGVycik7CiAgICAgIH0KICAgIH0pOwogIH0KICAvKioKICAgKiBTZW5kcyBhIHBhc3N3b3JkIHJlc2V0IHJlcXVlc3QgdG8gYW4gZW1haWwgYWRkcmVzcy4gVGhpcyBtZXRob2Qgc3VwcG9ydHMgdGhlIFBLQ0UgZmxvdy4KICAgKgogICAqIEBwYXJhbSBlbWFpbCBUaGUgZW1haWwgYWRkcmVzcyBvZiB0aGUgdXNlci4KICAgKiBAcGFyYW0gb3B0aW9ucy5yZWRpcmVjdFRvIFRoZSBVUkwgdG8gc2VuZCB0aGUgdXNlciB0byBhZnRlciB0aGV5IGNsaWNrIHRoZSBwYXNzd29yZCByZXNldCBsaW5rLgogICAqIEBwYXJhbSBvcHRpb25zLmNhcHRjaGFUb2tlbiBWZXJpZmljYXRpb24gdG9rZW4gcmVjZWl2ZWQgd2hlbiB0aGUgdXNlciBjb21wbGV0ZXMgdGhlIGNhcHRjaGEgb24gdGhlIHNpdGUuCiAgICovCiAgYXN5bmMgcmVzZXRQYXNzd29yZEZvckVtYWlsKGVtYWlsLCBvcHRpb25zID0ge30pIHsKICAgIGxldCBjb2RlQ2hhbGxlbmdlID0gbnVsbDsKICAgIGxldCBjb2RlQ2hhbGxlbmdlTWV0aG9kID0gbnVsbDsKICAgIGlmICh0aGlzLmZsb3dUeXBlID09PSAicGtjZSIpIHsKICAgICAgOwogICAgICBbY29kZUNoYWxsZW5nZSwgY29kZUNoYWxsZW5nZU1ldGhvZF0gPSBhd2FpdCBnZXRDb2RlQ2hhbGxlbmdlQW5kTWV0aG9kKAogICAgICAgIHRoaXMuc3RvcmFnZSwKICAgICAgICB0aGlzLnN0b3JhZ2VLZXksCiAgICAgICAgdHJ1ZQogICAgICAgIC8vIGlzUGFzc3dvcmRSZWNvdmVyeQogICAgICApOwogICAgfQogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L3JlY292ZXJgLCB7CiAgICAgICAgYm9keTogewogICAgICAgICAgZW1haWwsCiAgICAgICAgICBjb2RlX2NoYWxsZW5nZTogY29kZUNoYWxsZW5nZSwKICAgICAgICAgIGNvZGVfY2hhbGxlbmdlX21ldGhvZDogY29kZUNoYWxsZW5nZU1ldGhvZCwKICAgICAgICAgIGdvdHJ1ZV9tZXRhX3NlY3VyaXR5OiB7IGNhcHRjaGFfdG9rZW46IG9wdGlvbnMuY2FwdGNoYVRva2VuIH0KICAgICAgICB9LAogICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICByZWRpcmVjdFRvOiBvcHRpb25zLnJlZGlyZWN0VG8KICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBhd2FpdCByZW1vdmVJdGVtQXN5bmModGhpcy5zdG9yYWdlLCBgJHt0aGlzLnN0b3JhZ2VLZXl9LWNvZGUtdmVyaWZpZXJgKTsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgLyoqCiAgICogR2V0cyBhbGwgdGhlIGlkZW50aXRpZXMgbGlua2VkIHRvIGEgdXNlci4KICAgKi8KICBhc3luYyBnZXRVc2VySWRlbnRpdGllcygpIHsKICAgIHZhciBfYTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHRoaXMuZ2V0VXNlcigpOwogICAgICBpZiAoZXJyb3IpCiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IGlkZW50aXRpZXM6IChfYSA9IGRhdGEudXNlci5pZGVudGl0aWVzKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBbXSB9LCBlcnJvcjogbnVsbCB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIGFzeW5jIGxpbmtJZGVudGl0eShjcmVkZW50aWFscykgewogICAgaWYgKCJ0b2tlbiIgaW4gY3JlZGVudGlhbHMpIHsKICAgICAgcmV0dXJuIHRoaXMubGlua0lkZW50aXR5SWRUb2tlbihjcmVkZW50aWFscyk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5saW5rSWRlbnRpdHlPQXV0aChjcmVkZW50aWFscyk7CiAgfQogIGFzeW5jIGxpbmtJZGVudGl0eU9BdXRoKGNyZWRlbnRpYWxzKSB7CiAgICB2YXIgX2E7CiAgICB0cnkgewogICAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCB0aGlzLl91c2VTZXNzaW9uKGFzeW5jIChyZXN1bHQpID0+IHsKICAgICAgICB2YXIgX2EyLCBfYiwgX2MsIF9kLCBfZTsKICAgICAgICBjb25zdCB7IGRhdGE6IGRhdGEyLCBlcnJvcjogZXJyb3IyIH0gPSByZXN1bHQ7CiAgICAgICAgaWYgKGVycm9yMikKICAgICAgICAgIHRocm93IGVycm9yMjsKICAgICAgICBjb25zdCB1cmwgPSBhd2FpdCB0aGlzLl9nZXRVcmxGb3JQcm92aWRlcihgJHt0aGlzLnVybH0vdXNlci9pZGVudGl0aWVzL2F1dGhvcml6ZWAsIGNyZWRlbnRpYWxzLnByb3ZpZGVyLCB7CiAgICAgICAgICByZWRpcmVjdFRvOiAoX2EyID0gY3JlZGVudGlhbHMub3B0aW9ucykgPT09IG51bGwgfHwgX2EyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYTIucmVkaXJlY3RUbywKICAgICAgICAgIHNjb3BlczogKF9iID0gY3JlZGVudGlhbHMub3B0aW9ucykgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnNjb3BlcywKICAgICAgICAgIHF1ZXJ5UGFyYW1zOiAoX2MgPSBjcmVkZW50aWFscy5vcHRpb25zKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MucXVlcnlQYXJhbXMsCiAgICAgICAgICBza2lwQnJvd3NlclJlZGlyZWN0OiB0cnVlCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJHRVQiLCB1cmwsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGp3dDogKF9lID0gKF9kID0gZGF0YTIuc2Vzc2lvbikgPT09IG51bGwgfHwgX2QgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kLmFjY2Vzc190b2tlbikgIT09IG51bGwgJiYgX2UgIT09IHZvaWQgMCA/IF9lIDogdm9pZCAwCiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICBpZiAoZXJyb3IpCiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIGlmIChpc0Jyb3dzZXIoKSAmJiAhKChfYSA9IGNyZWRlbnRpYWxzLm9wdGlvbnMpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5za2lwQnJvd3NlclJlZGlyZWN0KSkgewogICAgICAgIHdpbmRvdy5sb2NhdGlvbi5hc3NpZ24oZGF0YSA9PT0gbnVsbCB8fCBkYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhLnVybCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7CiAgICAgICAgZGF0YTogeyBwcm92aWRlcjogY3JlZGVudGlhbHMucHJvdmlkZXIsIHVybDogZGF0YSA9PT0gbnVsbCB8fCBkYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhLnVybCB9LAogICAgICAgIGVycm9yOiBudWxsCiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHByb3ZpZGVyOiBjcmVkZW50aWFscy5wcm92aWRlciwgdXJsOiBudWxsIH0sIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICBhc3luYyBsaW5rSWRlbnRpdHlJZFRva2VuKGNyZWRlbnRpYWxzKSB7CiAgICByZXR1cm4gYXdhaXQgdGhpcy5fdXNlU2Vzc2lvbihhc3luYyAocmVzdWx0KSA9PiB7CiAgICAgIHZhciBfYTsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCB7IGVycm9yOiBzZXNzaW9uRXJyb3IsIGRhdGE6IHsgc2Vzc2lvbiB9IH0gPSByZXN1bHQ7CiAgICAgICAgaWYgKHNlc3Npb25FcnJvcikKICAgICAgICAgIHRocm93IHNlc3Npb25FcnJvcjsKICAgICAgICBjb25zdCB7IG9wdGlvbnMsIHByb3ZpZGVyLCB0b2tlbiwgYWNjZXNzX3Rva2VuLCBub25jZSB9ID0gY3JlZGVudGlhbHM7CiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vdG9rZW4/Z3JhbnRfdHlwZT1pZF90b2tlbmAsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGp3dDogKF9hID0gc2Vzc2lvbiA9PT0gbnVsbCB8fCBzZXNzaW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXNzaW9uLmFjY2Vzc190b2tlbikgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogdm9pZCAwLAogICAgICAgICAgYm9keTogewogICAgICAgICAgICBwcm92aWRlciwKICAgICAgICAgICAgaWRfdG9rZW46IHRva2VuLAogICAgICAgICAgICBhY2Nlc3NfdG9rZW4sCiAgICAgICAgICAgIG5vbmNlLAogICAgICAgICAgICBsaW5rX2lkZW50aXR5OiB0cnVlLAogICAgICAgICAgICBnb3RydWVfbWV0YV9zZWN1cml0eTogeyBjYXB0Y2hhX3Rva2VuOiBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuY2FwdGNoYVRva2VuIH0KICAgICAgICAgIH0sCiAgICAgICAgICB4Zm9ybTogX3Nlc3Npb25SZXNwb25zZQogICAgICAgIH0pOwogICAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IHJlczsKICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwgZXJyb3IgfSk7CiAgICAgICAgfSBlbHNlIGlmICghZGF0YSB8fCAhZGF0YS5zZXNzaW9uIHx8ICFkYXRhLnVzZXIpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoewogICAgICAgICAgICBkYXRhOiB7IHVzZXI6IG51bGwsIHNlc3Npb246IG51bGwgfSwKICAgICAgICAgICAgZXJyb3I6IG5ldyBBdXRoSW52YWxpZFRva2VuUmVzcG9uc2VFcnJvcigpCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKGRhdGEuc2Vzc2lvbikgewogICAgICAgICAgYXdhaXQgdGhpcy5fc2F2ZVNlc3Npb24oZGF0YS5zZXNzaW9uKTsKICAgICAgICAgIGF3YWl0IHRoaXMuX25vdGlmeUFsbFN1YnNjcmliZXJzKCJVU0VSX1VQREFURUQiLCBkYXRhLnNlc3Npb24pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YSwgZXJyb3IgfSk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgYXdhaXQgcmVtb3ZlSXRlbUFzeW5jKHRoaXMuc3RvcmFnZSwgYCR7dGhpcy5zdG9yYWdlS2V5fS1jb2RlLXZlcmlmaWVyYCk7CiAgICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgdXNlcjogbnVsbCwgc2Vzc2lvbjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0KICAgIH0pOwogIH0KICAvKioKICAgKiBVbmxpbmtzIGFuIGlkZW50aXR5IGZyb20gYSB1c2VyIGJ5IGRlbGV0aW5nIGl0LiBUaGUgdXNlciB3aWxsIG5vIGxvbmdlciBiZSBhYmxlIHRvIHNpZ24gaW4gd2l0aCB0aGF0IGlkZW50aXR5IG9uY2UgaXQncyB1bmxpbmtlZC4KICAgKi8KICBhc3luYyB1bmxpbmtJZGVudGl0eShpZGVudGl0eTQpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl91c2VTZXNzaW9uKGFzeW5jIChyZXN1bHQpID0+IHsKICAgICAgICB2YXIgX2EsIF9iOwogICAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IHJlc3VsdDsKICAgICAgICBpZiAoZXJyb3IpIHsKICAgICAgICAgIHRocm93IGVycm9yOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIkRFTEVURSIsIGAke3RoaXMudXJsfS91c2VyL2lkZW50aXRpZXMvJHtpZGVudGl0eTQuaWRlbnRpdHlfaWR9YCwgewogICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgand0OiAoX2IgPSAoX2EgPSBkYXRhLnNlc3Npb24pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5hY2Nlc3NfdG9rZW4pICE9PSBudWxsICYmIF9iICE9PSB2b2lkIDAgPyBfYiA6IHZvaWQgMAogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIEdlbmVyYXRlcyBhIG5ldyBKV1QuCiAgICogQHBhcmFtIHJlZnJlc2hUb2tlbiBBIHZhbGlkIHJlZnJlc2ggdG9rZW4gdGhhdCB3YXMgcmV0dXJuZWQgb24gbG9naW4uCiAgICovCiAgYXN5bmMgX3JlZnJlc2hBY2Nlc3NUb2tlbihyZWZyZXNoVG9rZW4pIHsKICAgIGNvbnN0IGRlYnVnTmFtZSA9IGAjX3JlZnJlc2hBY2Nlc3NUb2tlbigke3JlZnJlc2hUb2tlbi5zdWJzdHJpbmcoMCwgNSl9Li4uKWA7CiAgICB0aGlzLl9kZWJ1ZyhkZWJ1Z05hbWUsICJiZWdpbiIpOwogICAgdHJ5IHsKICAgICAgY29uc3Qgc3RhcnRlZEF0ID0gRGF0ZS5ub3coKTsKICAgICAgcmV0dXJuIGF3YWl0IHJldHJ5YWJsZShhc3luYyAoYXR0ZW1wdCkgPT4gewogICAgICAgIGlmIChhdHRlbXB0ID4gMCkgewogICAgICAgICAgYXdhaXQgc2xlZXAoMjAwICogTWF0aC5wb3coMiwgYXR0ZW1wdCAtIDEpKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fZGVidWcoZGVidWdOYW1lLCAicmVmcmVzaGluZyBhdHRlbXB0IiwgYXR0ZW1wdCk7CiAgICAgICAgcmV0dXJuIGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L3Rva2VuP2dyYW50X3R5cGU9cmVmcmVzaF90b2tlbmAsIHsKICAgICAgICAgIGJvZHk6IHsgcmVmcmVzaF90b2tlbjogcmVmcmVzaFRva2VuIH0sCiAgICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgICB4Zm9ybTogX3Nlc3Npb25SZXNwb25zZQogICAgICAgIH0pOwogICAgICB9LCAoYXR0ZW1wdCwgZXJyb3IpID0+IHsKICAgICAgICBjb25zdCBuZXh0QmFja09mZkludGVydmFsID0gMjAwICogTWF0aC5wb3coMiwgYXR0ZW1wdCk7CiAgICAgICAgcmV0dXJuIGVycm9yICYmIGlzQXV0aFJldHJ5YWJsZUZldGNoRXJyb3IoZXJyb3IpICYmIC8vIHJldHJ5YWJsZSBvbmx5IGlmIHRoZSByZXF1ZXN0IGNhbiBiZSBzZW50IGJlZm9yZSB0aGUgYmFja29mZiBvdmVyZmxvd3MgdGhlIHRpY2sgZHVyYXRpb24KICAgICAgICBEYXRlLm5vdygpICsgbmV4dEJhY2tPZmZJbnRlcnZhbCAtIHN0YXJ0ZWRBdCA8IEFVVE9fUkVGUkVTSF9USUNLX0RVUkFUSU9OX01TOwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIHRoaXMuX2RlYnVnKGRlYnVnTmFtZSwgImVycm9yIiwgZXJyb3IpOwogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IHsgc2Vzc2lvbjogbnVsbCwgdXNlcjogbnVsbCB9LCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX2RlYnVnKGRlYnVnTmFtZSwgImVuZCIpOwogICAgfQogIH0KICBfaXNWYWxpZFNlc3Npb24obWF5YmVTZXNzaW9uKSB7CiAgICBjb25zdCBpc1ZhbGlkU2Vzc2lvbiA9IHR5cGVvZiBtYXliZVNlc3Npb24gPT09ICJvYmplY3QiICYmIG1heWJlU2Vzc2lvbiAhPT0gbnVsbCAmJiAiYWNjZXNzX3Rva2VuIiBpbiBtYXliZVNlc3Npb24gJiYgInJlZnJlc2hfdG9rZW4iIGluIG1heWJlU2Vzc2lvbiAmJiAiZXhwaXJlc19hdCIgaW4gbWF5YmVTZXNzaW9uOwogICAgcmV0dXJuIGlzVmFsaWRTZXNzaW9uOwogIH0KICBhc3luYyBfaGFuZGxlUHJvdmlkZXJTaWduSW4ocHJvdmlkZXIsIG9wdGlvbnMpIHsKICAgIGNvbnN0IHVybCA9IGF3YWl0IHRoaXMuX2dldFVybEZvclByb3ZpZGVyKGAke3RoaXMudXJsfS9hdXRob3JpemVgLCBwcm92aWRlciwgewogICAgICByZWRpcmVjdFRvOiBvcHRpb25zLnJlZGlyZWN0VG8sCiAgICAgIHNjb3Blczogb3B0aW9ucy5zY29wZXMsCiAgICAgIHF1ZXJ5UGFyYW1zOiBvcHRpb25zLnF1ZXJ5UGFyYW1zCiAgICB9KTsKICAgIHRoaXMuX2RlYnVnKCIjX2hhbmRsZVByb3ZpZGVyU2lnbkluKCkiLCAicHJvdmlkZXIiLCBwcm92aWRlciwgIm9wdGlvbnMiLCBvcHRpb25zLCAidXJsIiwgdXJsKTsKICAgIGlmIChpc0Jyb3dzZXIoKSAmJiAhb3B0aW9ucy5za2lwQnJvd3NlclJlZGlyZWN0KSB7CiAgICAgIHdpbmRvdy5sb2NhdGlvbi5hc3NpZ24odXJsKTsKICAgIH0KICAgIHJldHVybiB7IGRhdGE6IHsgcHJvdmlkZXIsIHVybCB9LCBlcnJvcjogbnVsbCB9OwogIH0KICAvKioKICAgKiBSZWNvdmVycyB0aGUgc2Vzc2lvbiBmcm9tIExvY2FsU3RvcmFnZSBhbmQgcmVmcmVzaGVzIHRoZSB0b2tlbgogICAqIE5vdGU6IHRoaXMgbWV0aG9kIGlzIGFzeW5jIHRvIGFjY29tbW9kYXRlIGZvciBBc3luY1N0b3JhZ2UgZS5nLiBpbiBSZWFjdCBuYXRpdmUuCiAgICovCiAgYXN5bmMgX3JlY292ZXJBbmRSZWZyZXNoKCkgewogICAgdmFyIF9hLCBfYjsKICAgIGNvbnN0IGRlYnVnTmFtZSA9ICIjX3JlY292ZXJBbmRSZWZyZXNoKCkiOwogICAgdGhpcy5fZGVidWcoZGVidWdOYW1lLCAiYmVnaW4iKTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IGN1cnJlbnRTZXNzaW9uID0gYXdhaXQgZ2V0SXRlbUFzeW5jKHRoaXMuc3RvcmFnZSwgdGhpcy5zdG9yYWdlS2V5KTsKICAgICAgaWYgKGN1cnJlbnRTZXNzaW9uICYmIHRoaXMudXNlclN0b3JhZ2UpIHsKICAgICAgICBsZXQgbWF5YmVVc2VyID0gYXdhaXQgZ2V0SXRlbUFzeW5jKHRoaXMudXNlclN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSArICItdXNlciIpOwogICAgICAgIGlmICghdGhpcy5zdG9yYWdlLmlzU2VydmVyICYmIE9iamVjdC5pcyh0aGlzLnN0b3JhZ2UsIHRoaXMudXNlclN0b3JhZ2UpICYmICFtYXliZVVzZXIpIHsKICAgICAgICAgIG1heWJlVXNlciA9IHsgdXNlcjogY3VycmVudFNlc3Npb24udXNlciB9OwogICAgICAgICAgYXdhaXQgc2V0SXRlbUFzeW5jKHRoaXMudXNlclN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSArICItdXNlciIsIG1heWJlVXNlcik7CiAgICAgICAgfQogICAgICAgIGN1cnJlbnRTZXNzaW9uLnVzZXIgPSAoX2EgPSBtYXliZVVzZXIgPT09IG51bGwgfHwgbWF5YmVVc2VyID09PSB2b2lkIDAgPyB2b2lkIDAgOiBtYXliZVVzZXIudXNlcikgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogdXNlck5vdEF2YWlsYWJsZVByb3h5KCk7CiAgICAgIH0gZWxzZSBpZiAoY3VycmVudFNlc3Npb24gJiYgIWN1cnJlbnRTZXNzaW9uLnVzZXIpIHsKICAgICAgICBpZiAoIWN1cnJlbnRTZXNzaW9uLnVzZXIpIHsKICAgICAgICAgIGNvbnN0IHNlcGFyYXRlVXNlciA9IGF3YWl0IGdldEl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSArICItdXNlciIpOwogICAgICAgICAgaWYgKHNlcGFyYXRlVXNlciAmJiAoc2VwYXJhdGVVc2VyID09PSBudWxsIHx8IHNlcGFyYXRlVXNlciA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2VwYXJhdGVVc2VyLnVzZXIpKSB7CiAgICAgICAgICAgIGN1cnJlbnRTZXNzaW9uLnVzZXIgPSBzZXBhcmF0ZVVzZXIudXNlcjsKICAgICAgICAgICAgYXdhaXQgcmVtb3ZlSXRlbUFzeW5jKHRoaXMuc3RvcmFnZSwgdGhpcy5zdG9yYWdlS2V5ICsgIi11c2VyIik7CiAgICAgICAgICAgIGF3YWl0IHNldEl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSwgY3VycmVudFNlc3Npb24pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY3VycmVudFNlc3Npb24udXNlciA9IHVzZXJOb3RBdmFpbGFibGVQcm94eSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICB0aGlzLl9kZWJ1ZyhkZWJ1Z05hbWUsICJzZXNzaW9uIGZyb20gc3RvcmFnZSIsIGN1cnJlbnRTZXNzaW9uKTsKICAgICAgaWYgKCF0aGlzLl9pc1ZhbGlkU2Vzc2lvbihjdXJyZW50U2Vzc2lvbikpIHsKICAgICAgICB0aGlzLl9kZWJ1ZyhkZWJ1Z05hbWUsICJzZXNzaW9uIGlzIG5vdCB2YWxpZCIpOwogICAgICAgIGlmIChjdXJyZW50U2Vzc2lvbiAhPT0gbnVsbCkgewogICAgICAgICAgYXdhaXQgdGhpcy5fcmVtb3ZlU2Vzc2lvbigpOwogICAgICAgIH0KICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgZXhwaXJlc1dpdGhNYXJnaW4gPSAoKF9iID0gY3VycmVudFNlc3Npb24uZXhwaXJlc19hdCkgIT09IG51bGwgJiYgX2IgIT09IHZvaWQgMCA/IF9iIDogSW5maW5pdHkpICogMWUzIC0gRGF0ZS5ub3coKSA8IEVYUElSWV9NQVJHSU5fTVM7CiAgICAgIHRoaXMuX2RlYnVnKGRlYnVnTmFtZSwgYHNlc3Npb24gaGFzJHtleHBpcmVzV2l0aE1hcmdpbiA/ICIiIDogIiBub3QifSBleHBpcmVkIHdpdGggbWFyZ2luIG9mICR7RVhQSVJZX01BUkdJTl9NU31zYCk7CiAgICAgIGlmIChleHBpcmVzV2l0aE1hcmdpbikgewogICAgICAgIGlmICh0aGlzLmF1dG9SZWZyZXNoVG9rZW4gJiYgY3VycmVudFNlc3Npb24ucmVmcmVzaF90b2tlbikgewogICAgICAgICAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgdGhpcy5fY2FsbFJlZnJlc2hUb2tlbihjdXJyZW50U2Vzc2lvbi5yZWZyZXNoX3Rva2VuKTsKICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTsKICAgICAgICAgICAgaWYgKCFpc0F1dGhSZXRyeWFibGVGZXRjaEVycm9yKGVycm9yKSkgewogICAgICAgICAgICAgIHRoaXMuX2RlYnVnKGRlYnVnTmFtZSwgInJlZnJlc2ggZmFpbGVkIHdpdGggYSBub24tcmV0cnlhYmxlIGVycm9yLCByZW1vdmluZyB0aGUgc2Vzc2lvbiIsIGVycm9yKTsKICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9yZW1vdmVTZXNzaW9uKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoY3VycmVudFNlc3Npb24udXNlciAmJiBjdXJyZW50U2Vzc2lvbi51c2VyLl9faXNVc2VyTm90QXZhaWxhYmxlUHJveHkgPT09IHRydWUpIHsKICAgICAgICB0cnkgewogICAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvcjogdXNlckVycm9yIH0gPSBhd2FpdCB0aGlzLl9nZXRVc2VyKGN1cnJlbnRTZXNzaW9uLmFjY2Vzc190b2tlbik7CiAgICAgICAgICBpZiAoIXVzZXJFcnJvciAmJiAoZGF0YSA9PT0gbnVsbCB8fCBkYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBkYXRhLnVzZXIpKSB7CiAgICAgICAgICAgIGN1cnJlbnRTZXNzaW9uLnVzZXIgPSBkYXRhLnVzZXI7CiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3NhdmVTZXNzaW9uKGN1cnJlbnRTZXNzaW9uKTsKICAgICAgICAgICAgYXdhaXQgdGhpcy5fbm90aWZ5QWxsU3Vic2NyaWJlcnMoIlNJR05FRF9JTiIsIGN1cnJlbnRTZXNzaW9uKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX2RlYnVnKGRlYnVnTmFtZSwgImNvdWxkIG5vdCBnZXQgdXNlciBkYXRhLCBza2lwcGluZyBTSUdORURfSU4gbm90aWZpY2F0aW9uIik7CiAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZ2V0VXNlckVycm9yKSB7CiAgICAgICAgICBjb25zb2xlLmVycm9yKCJFcnJvciBnZXR0aW5nIHVzZXIgZGF0YToiLCBnZXRVc2VyRXJyb3IpOwogICAgICAgICAgdGhpcy5fZGVidWcoZGVidWdOYW1lLCAiZXJyb3IgZ2V0dGluZyB1c2VyIGRhdGEsIHNraXBwaW5nIFNJR05FRF9JTiBub3RpZmljYXRpb24iLCBnZXRVc2VyRXJyb3IpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBhd2FpdCB0aGlzLl9ub3RpZnlBbGxTdWJzY3JpYmVycygiU0lHTkVEX0lOIiwgY3VycmVudFNlc3Npb24pOwogICAgICB9CiAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgdGhpcy5fZGVidWcoZGVidWdOYW1lLCAiZXJyb3IiLCBlcnIpOwogICAgICBjb25zb2xlLmVycm9yKGVycik7CiAgICAgIHJldHVybjsKICAgIH0gZmluYWxseSB7CiAgICAgIHRoaXMuX2RlYnVnKGRlYnVnTmFtZSwgImVuZCIpOwogICAgfQogIH0KICBhc3luYyBfY2FsbFJlZnJlc2hUb2tlbihyZWZyZXNoVG9rZW4pIHsKICAgIHZhciBfYSwgX2I7CiAgICBpZiAoIXJlZnJlc2hUb2tlbikgewogICAgICB0aHJvdyBuZXcgQXV0aFNlc3Npb25NaXNzaW5nRXJyb3IoKTsKICAgIH0KICAgIGlmICh0aGlzLnJlZnJlc2hpbmdEZWZlcnJlZCkgewogICAgICByZXR1cm4gdGhpcy5yZWZyZXNoaW5nRGVmZXJyZWQucHJvbWlzZTsKICAgIH0KICAgIGNvbnN0IGRlYnVnTmFtZSA9IGAjX2NhbGxSZWZyZXNoVG9rZW4oJHtyZWZyZXNoVG9rZW4uc3Vic3RyaW5nKDAsIDUpfS4uLilgOwogICAgdGhpcy5fZGVidWcoZGVidWdOYW1lLCAiYmVnaW4iKTsKICAgIHRyeSB7CiAgICAgIHRoaXMucmVmcmVzaGluZ0RlZmVycmVkID0gbmV3IERlZmVycmVkKCk7CiAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHRoaXMuX3JlZnJlc2hBY2Nlc3NUb2tlbihyZWZyZXNoVG9rZW4pOwogICAgICBpZiAoZXJyb3IpCiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIGlmICghZGF0YS5zZXNzaW9uKQogICAgICAgIHRocm93IG5ldyBBdXRoU2Vzc2lvbk1pc3NpbmdFcnJvcigpOwogICAgICBhd2FpdCB0aGlzLl9zYXZlU2Vzc2lvbihkYXRhLnNlc3Npb24pOwogICAgICBhd2FpdCB0aGlzLl9ub3RpZnlBbGxTdWJzY3JpYmVycygiVE9LRU5fUkVGUkVTSEVEIiwgZGF0YS5zZXNzaW9uKTsKICAgICAgY29uc3QgcmVzdWx0ID0geyBkYXRhOiBkYXRhLnNlc3Npb24sIGVycm9yOiBudWxsIH07CiAgICAgIHRoaXMucmVmcmVzaGluZ0RlZmVycmVkLnJlc29sdmUocmVzdWx0KTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIHRoaXMuX2RlYnVnKGRlYnVnTmFtZSwgImVycm9yIiwgZXJyb3IpOwogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0geyBkYXRhOiBudWxsLCBlcnJvciB9OwogICAgICAgIGlmICghaXNBdXRoUmV0cnlhYmxlRmV0Y2hFcnJvcihlcnJvcikpIHsKICAgICAgICAgIGF3YWl0IHRoaXMuX3JlbW92ZVNlc3Npb24oKTsKICAgICAgICB9CiAgICAgICAgKF9hID0gdGhpcy5yZWZyZXNoaW5nRGVmZXJyZWQpID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5yZXNvbHZlKHJlc3VsdCk7CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgICAoX2IgPSB0aGlzLnJlZnJlc2hpbmdEZWZlcnJlZCkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnJlamVjdChlcnJvcik7CiAgICAgIHRocm93IGVycm9yOwogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5yZWZyZXNoaW5nRGVmZXJyZWQgPSBudWxsOwogICAgICB0aGlzLl9kZWJ1ZyhkZWJ1Z05hbWUsICJlbmQiKTsKICAgIH0KICB9CiAgYXN5bmMgX25vdGlmeUFsbFN1YnNjcmliZXJzKGV2ZW50LCBzZXNzaW9uLCBicm9hZGNhc3QgPSB0cnVlKSB7CiAgICBjb25zdCBkZWJ1Z05hbWUgPSBgI19ub3RpZnlBbGxTdWJzY3JpYmVycygke2V2ZW50fSlgOwogICAgdGhpcy5fZGVidWcoZGVidWdOYW1lLCAiYmVnaW4iLCBzZXNzaW9uLCBgYnJvYWRjYXN0ID0gJHticm9hZGNhc3R9YCk7CiAgICB0cnkgewogICAgICBpZiAodGhpcy5icm9hZGNhc3RDaGFubmVsICYmIGJyb2FkY2FzdCkgewogICAgICAgIHRoaXMuYnJvYWRjYXN0Q2hhbm5lbC5wb3N0TWVzc2FnZSh7IGV2ZW50LCBzZXNzaW9uIH0pOwogICAgICB9CiAgICAgIGNvbnN0IGVycm9yczMgPSBbXTsKICAgICAgY29uc3QgcHJvbWlzZXMgPSBBcnJheS5mcm9tKHRoaXMuc3RhdGVDaGFuZ2VFbWl0dGVycy52YWx1ZXMoKSkubWFwKGFzeW5jICh4MikgPT4gewogICAgICAgIHRyeSB7CiAgICAgICAgICBhd2FpdCB4Mi5jYWxsYmFjayhldmVudCwgc2Vzc2lvbik7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgZXJyb3JzMy5wdXNoKGUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTsKICAgICAgaWYgKGVycm9yczMubGVuZ3RoID4gMCkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZXJyb3JzMy5sZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcnMzW2ldKTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgZXJyb3JzM1swXTsKICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgdGhpcy5fZGVidWcoZGVidWdOYW1lLCAiZW5kIik7CiAgICB9CiAgfQogIC8qKgogICAqIHNldCBjdXJyZW50U2Vzc2lvbiBhbmQgY3VycmVudFVzZXIKICAgKiBwcm9jZXNzIHRvIF9zdGFydEF1dG9SZWZyZXNoVG9rZW4gaWYgcG9zc2libGUKICAgKi8KICBhc3luYyBfc2F2ZVNlc3Npb24oc2Vzc2lvbikgewogICAgdGhpcy5fZGVidWcoIiNfc2F2ZVNlc3Npb24oKSIsIHNlc3Npb24pOwogICAgdGhpcy5zdXBwcmVzc0dldFNlc3Npb25XYXJuaW5nID0gdHJ1ZTsKICAgIGF3YWl0IHJlbW92ZUl0ZW1Bc3luYyh0aGlzLnN0b3JhZ2UsIGAke3RoaXMuc3RvcmFnZUtleX0tY29kZS12ZXJpZmllcmApOwogICAgY29uc3Qgc2Vzc2lvblRvUHJvY2VzcyA9IE9iamVjdC5hc3NpZ24oe30sIHNlc3Npb24pOwogICAgY29uc3QgdXNlcklzUHJveHkgPSBzZXNzaW9uVG9Qcm9jZXNzLnVzZXIgJiYgc2Vzc2lvblRvUHJvY2Vzcy51c2VyLl9faXNVc2VyTm90QXZhaWxhYmxlUHJveHkgPT09IHRydWU7CiAgICBpZiAodGhpcy51c2VyU3RvcmFnZSkgewogICAgICBpZiAoIXVzZXJJc1Byb3h5ICYmIHNlc3Npb25Ub1Byb2Nlc3MudXNlcikgewogICAgICAgIGF3YWl0IHNldEl0ZW1Bc3luYyh0aGlzLnVzZXJTdG9yYWdlLCB0aGlzLnN0b3JhZ2VLZXkgKyAiLXVzZXIiLCB7CiAgICAgICAgICB1c2VyOiBzZXNzaW9uVG9Qcm9jZXNzLnVzZXIKICAgICAgICB9KTsKICAgICAgfSBlbHNlIGlmICh1c2VySXNQcm94eSkgewogICAgICB9CiAgICAgIGNvbnN0IG1haW5TZXNzaW9uRGF0YSA9IE9iamVjdC5hc3NpZ24oe30sIHNlc3Npb25Ub1Byb2Nlc3MpOwogICAgICBkZWxldGUgbWFpblNlc3Npb25EYXRhLnVzZXI7CiAgICAgIGNvbnN0IGNsb25lZE1haW5TZXNzaW9uRGF0YSA9IGRlZXBDbG9uZShtYWluU2Vzc2lvbkRhdGEpOwogICAgICBhd2FpdCBzZXRJdGVtQXN5bmModGhpcy5zdG9yYWdlLCB0aGlzLnN0b3JhZ2VLZXksIGNsb25lZE1haW5TZXNzaW9uRGF0YSk7CiAgICB9IGVsc2UgewogICAgICBjb25zdCBjbG9uZWRTZXNzaW9uID0gZGVlcENsb25lKHNlc3Npb25Ub1Byb2Nlc3MpOwogICAgICBhd2FpdCBzZXRJdGVtQXN5bmModGhpcy5zdG9yYWdlLCB0aGlzLnN0b3JhZ2VLZXksIGNsb25lZFNlc3Npb24pOwogICAgfQogIH0KICBhc3luYyBfcmVtb3ZlU2Vzc2lvbigpIHsKICAgIHRoaXMuX2RlYnVnKCIjX3JlbW92ZVNlc3Npb24oKSIpOwogICAgdGhpcy5zdXBwcmVzc0dldFNlc3Npb25XYXJuaW5nID0gZmFsc2U7CiAgICBhd2FpdCByZW1vdmVJdGVtQXN5bmModGhpcy5zdG9yYWdlLCB0aGlzLnN0b3JhZ2VLZXkpOwogICAgYXdhaXQgcmVtb3ZlSXRlbUFzeW5jKHRoaXMuc3RvcmFnZSwgdGhpcy5zdG9yYWdlS2V5ICsgIi1jb2RlLXZlcmlmaWVyIik7CiAgICBhd2FpdCByZW1vdmVJdGVtQXN5bmModGhpcy5zdG9yYWdlLCB0aGlzLnN0b3JhZ2VLZXkgKyAiLXVzZXIiKTsKICAgIGlmICh0aGlzLnVzZXJTdG9yYWdlKSB7CiAgICAgIGF3YWl0IHJlbW92ZUl0ZW1Bc3luYyh0aGlzLnVzZXJTdG9yYWdlLCB0aGlzLnN0b3JhZ2VLZXkgKyAiLXVzZXIiKTsKICAgIH0KICAgIGF3YWl0IHRoaXMuX25vdGlmeUFsbFN1YnNjcmliZXJzKCJTSUdORURfT1VUIiwgbnVsbCk7CiAgfQogIC8qKgogICAqIFJlbW92ZXMgYW55IHJlZ2lzdGVyZWQgdmlzaWJpbGl0eWNoYW5nZSBjYWxsYmFjay4KICAgKgogICAqIHtAc2VlICNzdGFydEF1dG9SZWZyZXNofQogICAqIHtAc2VlICNzdG9wQXV0b1JlZnJlc2h9CiAgICovCiAgX3JlbW92ZVZpc2liaWxpdHlDaGFuZ2VkQ2FsbGJhY2soKSB7CiAgICB0aGlzLl9kZWJ1ZygiI19yZW1vdmVWaXNpYmlsaXR5Q2hhbmdlZENhbGxiYWNrKCkiKTsKICAgIGNvbnN0IGNhbGxiYWNrID0gdGhpcy52aXNpYmlsaXR5Q2hhbmdlZENhbGxiYWNrOwogICAgdGhpcy52aXNpYmlsaXR5Q2hhbmdlZENhbGxiYWNrID0gbnVsbDsKICAgIHRyeSB7CiAgICAgIGlmIChjYWxsYmFjayAmJiBpc0Jyb3dzZXIoKSAmJiAod2luZG93ID09PSBudWxsIHx8IHdpbmRvdyA9PT0gdm9pZCAwID8gdm9pZCAwIDogd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIpKSB7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInZpc2liaWxpdHljaGFuZ2UiLCBjYWxsYmFjayk7CiAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgY29uc29sZS5lcnJvcigicmVtb3ZpbmcgdmlzaWJpbGl0eWNoYW5nZSBjYWxsYmFjayBmYWlsZWQiLCBlKTsKICAgIH0KICB9CiAgLyoqCiAgICogVGhpcyBpcyB0aGUgcHJpdmF0ZSBpbXBsZW1lbnRhdGlvbiBvZiB7QGxpbmsgI3N0YXJ0QXV0b1JlZnJlc2h9LiBVc2UgdGhpcwogICAqIHdpdGhpbiB0aGUgbGlicmFyeS4KICAgKi8KICBhc3luYyBfc3RhcnRBdXRvUmVmcmVzaCgpIHsKICAgIGF3YWl0IHRoaXMuX3N0b3BBdXRvUmVmcmVzaCgpOwogICAgdGhpcy5fZGVidWcoIiNfc3RhcnRBdXRvUmVmcmVzaCgpIik7CiAgICBjb25zdCB0aWNrZXIyID0gc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5fYXV0b1JlZnJlc2hUb2tlblRpY2soKSwgQVVUT19SRUZSRVNIX1RJQ0tfRFVSQVRJT05fTVMpOwogICAgdGhpcy5hdXRvUmVmcmVzaFRpY2tlciA9IHRpY2tlcjI7CiAgICBpZiAodGlja2VyMiAmJiB0eXBlb2YgdGlja2VyMiA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHRpY2tlcjIudW5yZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGlja2VyMi51bnJlZigpOwogICAgfSBlbHNlIGlmICh0eXBlb2YgRGVubyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIERlbm8udW5yZWZUaW1lciA9PT0gImZ1bmN0aW9uIikgewogICAgICBEZW5vLnVucmVmVGltZXIodGlja2VyMik7CiAgICB9CiAgICBjb25zdCB0aW1lb3V0ID0gc2V0VGltZW91dChhc3luYyAoKSA9PiB7CiAgICAgIGF3YWl0IHRoaXMuaW5pdGlhbGl6ZVByb21pc2U7CiAgICAgIGF3YWl0IHRoaXMuX2F1dG9SZWZyZXNoVG9rZW5UaWNrKCk7CiAgICB9LCAwKTsKICAgIHRoaXMuYXV0b1JlZnJlc2hUaWNrVGltZW91dCA9IHRpbWVvdXQ7CiAgICBpZiAodGltZW91dCAmJiB0eXBlb2YgdGltZW91dCA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIHRpbWVvdXQudW5yZWYgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgdGltZW91dC51bnJlZigpOwogICAgfSBlbHNlIGlmICh0eXBlb2YgRGVubyAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIERlbm8udW5yZWZUaW1lciA9PT0gImZ1bmN0aW9uIikgewogICAgICBEZW5vLnVucmVmVGltZXIodGltZW91dCk7CiAgICB9CiAgfQogIC8qKgogICAqIFRoaXMgaXMgdGhlIHByaXZhdGUgaW1wbGVtZW50YXRpb24gb2Yge0BsaW5rICNzdG9wQXV0b1JlZnJlc2h9LiBVc2UgdGhpcwogICAqIHdpdGhpbiB0aGUgbGlicmFyeS4KICAgKi8KICBhc3luYyBfc3RvcEF1dG9SZWZyZXNoKCkgewogICAgdGhpcy5fZGVidWcoIiNfc3RvcEF1dG9SZWZyZXNoKCkiKTsKICAgIGNvbnN0IHRpY2tlcjIgPSB0aGlzLmF1dG9SZWZyZXNoVGlja2VyOwogICAgdGhpcy5hdXRvUmVmcmVzaFRpY2tlciA9IG51bGw7CiAgICBpZiAodGlja2VyMikgewogICAgICBjbGVhckludGVydmFsKHRpY2tlcjIpOwogICAgfQogICAgY29uc3QgdGltZW91dCA9IHRoaXMuYXV0b1JlZnJlc2hUaWNrVGltZW91dDsKICAgIHRoaXMuYXV0b1JlZnJlc2hUaWNrVGltZW91dCA9IG51bGw7CiAgICBpZiAodGltZW91dCkgewogICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7CiAgICB9CiAgfQogIC8qKgogICAqIFN0YXJ0cyBhbiBhdXRvLXJlZnJlc2ggcHJvY2VzcyBpbiB0aGUgYmFja2dyb3VuZC4gVGhlIHNlc3Npb24gaXMgY2hlY2tlZAogICAqIGV2ZXJ5IGZldyBzZWNvbmRzLiBDbG9zZSB0byB0aGUgdGltZSBvZiBleHBpcmF0aW9uIGEgcHJvY2VzcyBpcyBzdGFydGVkIHRvCiAgICogcmVmcmVzaCB0aGUgc2Vzc2lvbi4gSWYgcmVmcmVzaGluZyBmYWlscyBpdCB3aWxsIGJlIHJldHJpZWQgZm9yIGFzIGxvbmcgYXMKICAgKiBuZWNlc3NhcnkuCiAgICoKICAgKiBJZiB5b3Ugc2V0IHRoZSB7QGxpbmsgR29UcnVlQ2xpZW50T3B0aW9ucyNhdXRvUmVmcmVzaFRva2VufSB5b3UgZG9uJ3QgbmVlZAogICAqIHRvIGNhbGwgdGhpcyBmdW5jdGlvbiwgaXQgd2lsbCBiZSBjYWxsZWQgZm9yIHlvdS4KICAgKgogICAqIE9uIGJyb3dzZXJzIHRoZSByZWZyZXNoIHByb2Nlc3Mgd29ya3Mgb25seSB3aGVuIHRoZSB0YWIvd2luZG93IGlzIGluIHRoZQogICAqIGZvcmVncm91bmQgdG8gY29uc2VydmUgcmVzb3VyY2VzIGFzIHdlbGwgYXMgcHJldmVudCByYWNlIGNvbmRpdGlvbnMgYW5kCiAgICogZmxvb2RpbmcgYXV0aCB3aXRoIHJlcXVlc3RzLiBJZiB5b3UgY2FsbCB0aGlzIG1ldGhvZCBhbnkgbWFuYWdlZAogICAqIHZpc2liaWxpdHkgY2hhbmdlIGNhbGxiYWNrIHdpbGwgYmUgcmVtb3ZlZCBhbmQgeW91IG11c3QgbWFuYWdlIHZpc2liaWxpdHkKICAgKiBjaGFuZ2VzIG9uIHlvdXIgb3duLgogICAqCiAgICogT24gbm9uLWJyb3dzZXIgcGxhdGZvcm1zIHRoZSByZWZyZXNoIHByb2Nlc3Mgd29ya3MgKmNvbnRpbnVvdXNseSogaW4gdGhlCiAgICogYmFja2dyb3VuZCwgd2hpY2ggbWF5IG5vdCBiZSBkZXNpcmFibGUuIFlvdSBzaG91bGQgaG9vayBpbnRvIHlvdXIKICAgKiBwbGF0Zm9ybSdzIGZvcmVncm91bmQgaW5kaWNhdGlvbiBtZWNoYW5pc20gYW5kIGNhbGwgdGhlc2UgbWV0aG9kcwogICAqIGFwcHJvcHJpYXRlbHkgdG8gY29uc2VydmUgcmVzb3VyY2VzLgogICAqCiAgICoge0BzZWUgI3N0b3BBdXRvUmVmcmVzaH0KICAgKi8KICBhc3luYyBzdGFydEF1dG9SZWZyZXNoKCkgewogICAgdGhpcy5fcmVtb3ZlVmlzaWJpbGl0eUNoYW5nZWRDYWxsYmFjaygpOwogICAgYXdhaXQgdGhpcy5fc3RhcnRBdXRvUmVmcmVzaCgpOwogIH0KICAvKioKICAgKiBTdG9wcyBhbiBhY3RpdmUgYXV0byByZWZyZXNoIHByb2Nlc3MgcnVubmluZyBpbiB0aGUgYmFja2dyb3VuZCAoaWYgYW55KS4KICAgKgogICAqIElmIHlvdSBjYWxsIHRoaXMgbWV0aG9kIGFueSBtYW5hZ2VkIHZpc2liaWxpdHkgY2hhbmdlIGNhbGxiYWNrIHdpbGwgYmUKICAgKiByZW1vdmVkIGFuZCB5b3UgbXVzdCBtYW5hZ2UgdmlzaWJpbGl0eSBjaGFuZ2VzIG9uIHlvdXIgb3duLgogICAqCiAgICogU2VlIHtAbGluayAjc3RhcnRBdXRvUmVmcmVzaH0gZm9yIG1vcmUgZGV0YWlscy4KICAgKi8KICBhc3luYyBzdG9wQXV0b1JlZnJlc2goKSB7CiAgICB0aGlzLl9yZW1vdmVWaXNpYmlsaXR5Q2hhbmdlZENhbGxiYWNrKCk7CiAgICBhd2FpdCB0aGlzLl9zdG9wQXV0b1JlZnJlc2goKTsKICB9CiAgLyoqCiAgICogUnVucyB0aGUgYXV0byByZWZyZXNoIHRva2VuIHRpY2suCiAgICovCiAgYXN5bmMgX2F1dG9SZWZyZXNoVG9rZW5UaWNrKCkgewogICAgdGhpcy5fZGVidWcoIiNfYXV0b1JlZnJlc2hUb2tlblRpY2soKSIsICJiZWdpbiIpOwogICAgdHJ5IHsKICAgICAgYXdhaXQgdGhpcy5fYWNxdWlyZUxvY2soMCwgYXN5bmMgKCkgPT4gewogICAgICAgIHRyeSB7CiAgICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpOwogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3VzZVNlc3Npb24oYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICAgICAgICAgIGNvbnN0IHsgZGF0YTogeyBzZXNzaW9uIH0gfSA9IHJlc3VsdDsKICAgICAgICAgICAgICBpZiAoIXNlc3Npb24gfHwgIXNlc3Npb24ucmVmcmVzaF90b2tlbiB8fCAhc2Vzc2lvbi5leHBpcmVzX2F0KSB7CiAgICAgICAgICAgICAgICB0aGlzLl9kZWJ1ZygiI19hdXRvUmVmcmVzaFRva2VuVGljaygpIiwgIm5vIHNlc3Npb24iKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29uc3QgZXhwaXJlc0luVGlja3MgPSBNYXRoLmZsb29yKChzZXNzaW9uLmV4cGlyZXNfYXQgKiAxZTMgLSBub3cpIC8gQVVUT19SRUZSRVNIX1RJQ0tfRFVSQVRJT05fTVMpOwogICAgICAgICAgICAgIHRoaXMuX2RlYnVnKCIjX2F1dG9SZWZyZXNoVG9rZW5UaWNrKCkiLCBgYWNjZXNzIHRva2VuIGV4cGlyZXMgaW4gJHtleHBpcmVzSW5UaWNrc30gdGlja3MsIGEgdGljayBsYXN0cyAke0FVVE9fUkVGUkVTSF9USUNLX0RVUkFUSU9OX01TfW1zLCByZWZyZXNoIHRocmVzaG9sZCBpcyAke0FVVE9fUkVGUkVTSF9USUNLX1RIUkVTSE9MRH0gdGlja3NgKTsKICAgICAgICAgICAgICBpZiAoZXhwaXJlc0luVGlja3MgPD0gQVVUT19SRUZSRVNIX1RJQ0tfVEhSRVNIT0xEKSB7CiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl9jYWxsUmVmcmVzaFRva2VuKHNlc3Npb24ucmVmcmVzaF90b2tlbik7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcigiQXV0byByZWZyZXNoIHRpY2sgZmFpbGVkIHdpdGggZXJyb3IuIFRoaXMgaXMgbGlrZWx5IGEgdHJhbnNpZW50IGVycm9yLiIsIGUpOwogICAgICAgICAgfQogICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICB0aGlzLl9kZWJ1ZygiI19hdXRvUmVmcmVzaFRva2VuVGljaygpIiwgImVuZCIpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGlmIChlLmlzQWNxdWlyZVRpbWVvdXQgfHwgZSBpbnN0YW5jZW9mIExvY2tBY3F1aXJlVGltZW91dEVycm9yKSB7CiAgICAgICAgdGhpcy5fZGVidWcoImF1dG8gcmVmcmVzaCB0b2tlbiB0aWNrIGxvY2sgbm90IGF2YWlsYWJsZSIpOwogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IGU7CiAgICAgIH0KICAgIH0KICB9CiAgLyoqCiAgICogUmVnaXN0ZXJzIGNhbGxiYWNrcyBvbiB0aGUgYnJvd3NlciAvIHBsYXRmb3JtLCB3aGljaCBpbi10dXJuIHJ1bgogICAqIGFsZ29yaXRobXMgd2hlbiB0aGUgYnJvd3NlciB3aW5kb3cvdGFiIGFyZSBpbiBmb3JlZ3JvdW5kLiBPbiBub24tYnJvd3NlcgogICAqIHBsYXRmb3JtcyBpdCBhc3N1bWVzIGFsd2F5cyBmb3JlZ3JvdW5kLgogICAqLwogIGFzeW5jIF9oYW5kbGVWaXNpYmlsaXR5Q2hhbmdlKCkgewogICAgdGhpcy5fZGVidWcoIiNfaGFuZGxlVmlzaWJpbGl0eUNoYW5nZSgpIik7CiAgICBpZiAoIWlzQnJvd3NlcigpIHx8ICEod2luZG93ID09PSBudWxsIHx8IHdpbmRvdyA9PT0gdm9pZCAwID8gdm9pZCAwIDogd2luZG93LmFkZEV2ZW50TGlzdGVuZXIpKSB7CiAgICAgIGlmICh0aGlzLmF1dG9SZWZyZXNoVG9rZW4pIHsKICAgICAgICB0aGlzLnN0YXJ0QXV0b1JlZnJlc2goKTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICB0cnkgewogICAgICB0aGlzLnZpc2liaWxpdHlDaGFuZ2VkQ2FsbGJhY2sgPSBhc3luYyAoKSA9PiB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIGF3YWl0IHRoaXMuX29uVmlzaWJpbGl0eUNoYW5nZWQoZmFsc2UpOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICB0aGlzLl9kZWJ1ZygiI3Zpc2liaWxpdHlDaGFuZ2VkQ2FsbGJhY2siLCAiZXJyb3IiLCBlcnJvcik7CiAgICAgICAgfQogICAgICB9OwogICAgICB3aW5kb3cgPT09IG51bGwgfHwgd2luZG93ID09PSB2b2lkIDAgPyB2b2lkIDAgOiB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigidmlzaWJpbGl0eWNoYW5nZSIsIHRoaXMudmlzaWJpbGl0eUNoYW5nZWRDYWxsYmFjayk7CiAgICAgIGF3YWl0IHRoaXMuX29uVmlzaWJpbGl0eUNoYW5nZWQodHJ1ZSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCJfaGFuZGxlVmlzaWJpbGl0eUNoYW5nZSIsIGVycm9yKTsKICAgIH0KICB9CiAgLyoqCiAgICogQ2FsbGJhY2sgcmVnaXN0ZXJlZCB3aXRoIGB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndmlzaWJpbGl0eWNoYW5nZScpYC4KICAgKi8KICBhc3luYyBfb25WaXNpYmlsaXR5Q2hhbmdlZChjYWxsZWRGcm9tSW5pdGlhbGl6ZSkgewogICAgY29uc3QgbWV0aG9kTmFtZSA9IGAjX29uVmlzaWJpbGl0eUNoYW5nZWQoJHtjYWxsZWRGcm9tSW5pdGlhbGl6ZX0pYDsKICAgIHRoaXMuX2RlYnVnKG1ldGhvZE5hbWUsICJ2aXNpYmlsaXR5U3RhdGUiLCBkb2N1bWVudC52aXNpYmlsaXR5U3RhdGUpOwogICAgaWYgKGRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZSA9PT0gInZpc2libGUiKSB7CiAgICAgIGlmICh0aGlzLmF1dG9SZWZyZXNoVG9rZW4pIHsKICAgICAgICB0aGlzLl9zdGFydEF1dG9SZWZyZXNoKCk7CiAgICAgIH0KICAgICAgaWYgKCFjYWxsZWRGcm9tSW5pdGlhbGl6ZSkgewogICAgICAgIGF3YWl0IHRoaXMuaW5pdGlhbGl6ZVByb21pc2U7CiAgICAgICAgYXdhaXQgdGhpcy5fYWNxdWlyZUxvY2sodGhpcy5sb2NrQWNxdWlyZVRpbWVvdXQsIGFzeW5jICgpID0+IHsKICAgICAgICAgIGlmIChkb2N1bWVudC52aXNpYmlsaXR5U3RhdGUgIT09ICJ2aXNpYmxlIikgewogICAgICAgICAgICB0aGlzLl9kZWJ1ZyhtZXRob2ROYW1lLCAiYWNxdWlyZWQgdGhlIGxvY2sgdG8gcmVjb3ZlciB0aGUgc2Vzc2lvbiwgYnV0IHRoZSBicm93c2VyIHZpc2liaWxpdHlTdGF0ZSBpcyBubyBsb25nZXIgdmlzaWJsZSwgYWJvcnRpbmciKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgICAgYXdhaXQgdGhpcy5fcmVjb3ZlckFuZFJlZnJlc2goKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSBlbHNlIGlmIChkb2N1bWVudC52aXNpYmlsaXR5U3RhdGUgPT09ICJoaWRkZW4iKSB7CiAgICAgIGlmICh0aGlzLmF1dG9SZWZyZXNoVG9rZW4pIHsKICAgICAgICB0aGlzLl9zdG9wQXV0b1JlZnJlc2goKTsKICAgICAgfQogICAgfQogIH0KICAvKioKICAgKiBHZW5lcmF0ZXMgdGhlIHJlbGV2YW50IGxvZ2luIFVSTCBmb3IgYSB0aGlyZC1wYXJ0eSBwcm92aWRlci4KICAgKiBAcGFyYW0gb3B0aW9ucy5yZWRpcmVjdFRvIEEgVVJMIG9yIG1vYmlsZSBhZGRyZXNzIHRvIHNlbmQgdGhlIHVzZXIgdG8gYWZ0ZXIgdGhleSBhcmUgY29uZmlybWVkLgogICAqIEBwYXJhbSBvcHRpb25zLnNjb3BlcyBBIHNwYWNlLXNlcGFyYXRlZCBsaXN0IG9mIHNjb3BlcyBncmFudGVkIHRvIHRoZSBPQXV0aCBhcHBsaWNhdGlvbi4KICAgKiBAcGFyYW0gb3B0aW9ucy5xdWVyeVBhcmFtcyBBbiBvYmplY3Qgb2Yga2V5LXZhbHVlIHBhaXJzIGNvbnRhaW5pbmcgcXVlcnkgcGFyYW1ldGVycyBncmFudGVkIHRvIHRoZSBPQXV0aCBhcHBsaWNhdGlvbi4KICAgKi8KICBhc3luYyBfZ2V0VXJsRm9yUHJvdmlkZXIodXJsLCBwcm92aWRlciwgb3B0aW9ucykgewogICAgY29uc3QgdXJsUGFyYW1zID0gW2Bwcm92aWRlcj0ke2VuY29kZVVSSUNvbXBvbmVudChwcm92aWRlcil9YF07CiAgICBpZiAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnJlZGlyZWN0VG8pIHsKICAgICAgdXJsUGFyYW1zLnB1c2goYHJlZGlyZWN0X3RvPSR7ZW5jb2RlVVJJQ29tcG9uZW50KG9wdGlvbnMucmVkaXJlY3RUbyl9YCk7CiAgICB9CiAgICBpZiAob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLnNjb3BlcykgewogICAgICB1cmxQYXJhbXMucHVzaChgc2NvcGVzPSR7ZW5jb2RlVVJJQ29tcG9uZW50KG9wdGlvbnMuc2NvcGVzKX1gKTsKICAgIH0KICAgIGlmICh0aGlzLmZsb3dUeXBlID09PSAicGtjZSIpIHsKICAgICAgY29uc3QgW2NvZGVDaGFsbGVuZ2UsIGNvZGVDaGFsbGVuZ2VNZXRob2RdID0gYXdhaXQgZ2V0Q29kZUNoYWxsZW5nZUFuZE1ldGhvZCh0aGlzLnN0b3JhZ2UsIHRoaXMuc3RvcmFnZUtleSk7CiAgICAgIGNvbnN0IGZsb3dQYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHsKICAgICAgICBjb2RlX2NoYWxsZW5nZTogYCR7ZW5jb2RlVVJJQ29tcG9uZW50KGNvZGVDaGFsbGVuZ2UpfWAsCiAgICAgICAgY29kZV9jaGFsbGVuZ2VfbWV0aG9kOiBgJHtlbmNvZGVVUklDb21wb25lbnQoY29kZUNoYWxsZW5nZU1ldGhvZCl9YAogICAgICB9KTsKICAgICAgdXJsUGFyYW1zLnB1c2goZmxvd1BhcmFtcy50b1N0cmluZygpKTsKICAgIH0KICAgIGlmIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMucXVlcnlQYXJhbXMpIHsKICAgICAgY29uc3QgcXVlcnkgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKG9wdGlvbnMucXVlcnlQYXJhbXMpOwogICAgICB1cmxQYXJhbXMucHVzaChxdWVyeS50b1N0cmluZygpKTsKICAgIH0KICAgIGlmIChvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc2tpcEJyb3dzZXJSZWRpcmVjdCkgewogICAgICB1cmxQYXJhbXMucHVzaChgc2tpcF9odHRwX3JlZGlyZWN0PSR7b3B0aW9ucy5za2lwQnJvd3NlclJlZGlyZWN0fWApOwogICAgfQogICAgcmV0dXJuIGAke3VybH0/JHt1cmxQYXJhbXMuam9pbigiJiIpfWA7CiAgfQogIGFzeW5jIF91bmVucm9sbChwYXJhbXMpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl91c2VTZXNzaW9uKGFzeW5jIChyZXN1bHQpID0+IHsKICAgICAgICB2YXIgX2E7CiAgICAgICAgY29uc3QgeyBkYXRhOiBzZXNzaW9uRGF0YSwgZXJyb3I6IHNlc3Npb25FcnJvciB9ID0gcmVzdWx0OwogICAgICAgIGlmIChzZXNzaW9uRXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvcjogc2Vzc2lvbkVycm9yIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIkRFTEVURSIsIGAke3RoaXMudXJsfS9mYWN0b3JzLyR7cGFyYW1zLmZhY3RvcklkfWAsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGp3dDogKF9hID0gc2Vzc2lvbkRhdGEgPT09IG51bGwgfHwgc2Vzc2lvbkRhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHNlc3Npb25EYXRhLnNlc3Npb24pID09PSBudWxsIHx8IF9hID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYS5hY2Nlc3NfdG9rZW4KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICBhc3luYyBfZW5yb2xsKHBhcmFtcykgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3VzZVNlc3Npb24oYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICAgIHZhciBfYSwgX2I7CiAgICAgICAgY29uc3QgeyBkYXRhOiBzZXNzaW9uRGF0YSwgZXJyb3I6IHNlc3Npb25FcnJvciB9ID0gcmVzdWx0OwogICAgICAgIGlmIChzZXNzaW9uRXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvcjogc2Vzc2lvbkVycm9yIH0pOwogICAgICAgIH0KICAgICAgICBjb25zdCBib2R5ID0gT2JqZWN0LmFzc2lnbih7IGZyaWVuZGx5X25hbWU6IHBhcmFtcy5mcmllbmRseU5hbWUsIGZhY3Rvcl90eXBlOiBwYXJhbXMuZmFjdG9yVHlwZSB9LCBwYXJhbXMuZmFjdG9yVHlwZSA9PT0gInBob25lIiA/IHsgcGhvbmU6IHBhcmFtcy5waG9uZSB9IDogcGFyYW1zLmZhY3RvclR5cGUgPT09ICJ0b3RwIiA/IHsgaXNzdWVyOiBwYXJhbXMuaXNzdWVyIH0gOiB7fSk7CiAgICAgICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vZmFjdG9yc2AsIHsKICAgICAgICAgIGJvZHksCiAgICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgICBqd3Q6IChfYSA9IHNlc3Npb25EYXRhID09PSBudWxsIHx8IHNlc3Npb25EYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXNzaW9uRGF0YS5zZXNzaW9uKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuYWNjZXNzX3Rva2VuCiAgICAgICAgfSk7CiAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3IgfSk7CiAgICAgICAgfQogICAgICAgIGlmIChwYXJhbXMuZmFjdG9yVHlwZSA9PT0gInRvdHAiICYmIGRhdGEudHlwZSA9PT0gInRvdHAiICYmICgoX2IgPSBkYXRhID09PSBudWxsIHx8IGRhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGRhdGEudG90cCkgPT09IG51bGwgfHwgX2IgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9iLnFyX2NvZGUpKSB7CiAgICAgICAgICBkYXRhLnRvdHAucXJfY29kZSA9IGBkYXRhOmltYWdlL3N2Zyt4bWw7dXRmLTgsJHtkYXRhLnRvdHAucXJfY29kZX1gOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YSwgZXJyb3I6IG51bGwgfSk7CiAgICAgIH0pOwogICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgaWYgKGlzQXV0aEVycm9yKGVycm9yKSkgewogICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvciB9KTsKICAgICAgfQogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICB9CiAgYXN5bmMgX3ZlcmlmeShwYXJhbXMpIHsKICAgIHJldHVybiB0aGlzLl9hY3F1aXJlTG9jayh0aGlzLmxvY2tBY3F1aXJlVGltZW91dCwgYXN5bmMgKCkgPT4gewogICAgICB0cnkgewogICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl91c2VTZXNzaW9uKGFzeW5jIChyZXN1bHQpID0+IHsKICAgICAgICAgIHZhciBfYTsKICAgICAgICAgIGNvbnN0IHsgZGF0YTogc2Vzc2lvbkRhdGEsIGVycm9yOiBzZXNzaW9uRXJyb3IgfSA9IHJlc3VsdDsKICAgICAgICAgIGlmIChzZXNzaW9uRXJyb3IpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yOiBzZXNzaW9uRXJyb3IgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBjb25zdCBib2R5ID0gT2JqZWN0LmFzc2lnbih7IGNoYWxsZW5nZV9pZDogcGFyYW1zLmNoYWxsZW5nZUlkIH0sICJ3ZWJhdXRobiIgaW4gcGFyYW1zID8gewogICAgICAgICAgICB3ZWJhdXRobjogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBwYXJhbXMud2ViYXV0aG4pLCB7IGNyZWRlbnRpYWxfcmVzcG9uc2U6IHBhcmFtcy53ZWJhdXRobi50eXBlID09PSAiY3JlYXRlIiA/IHNlcmlhbGl6ZUNyZWRlbnRpYWxDcmVhdGlvblJlc3BvbnNlKHBhcmFtcy53ZWJhdXRobi5jcmVkZW50aWFsX3Jlc3BvbnNlKSA6IHNlcmlhbGl6ZUNyZWRlbnRpYWxSZXF1ZXN0UmVzcG9uc2UocGFyYW1zLndlYmF1dGhuLmNyZWRlbnRpYWxfcmVzcG9uc2UpIH0pCiAgICAgICAgICB9IDogeyBjb2RlOiBwYXJhbXMuY29kZSB9KTsKICAgICAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IF9yZXF1ZXN0KHRoaXMuZmV0Y2gsICJQT1NUIiwgYCR7dGhpcy51cmx9L2ZhY3RvcnMvJHtwYXJhbXMuZmFjdG9ySWR9L3ZlcmlmeWAsIHsKICAgICAgICAgICAgYm9keSwKICAgICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgICBqd3Q6IChfYSA9IHNlc3Npb25EYXRhID09PSBudWxsIHx8IHNlc3Npb25EYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXNzaW9uRGF0YS5zZXNzaW9uKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EuYWNjZXNzX3Rva2VuCiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3IgfSk7CiAgICAgICAgICB9CiAgICAgICAgICBhd2FpdCB0aGlzLl9zYXZlU2Vzc2lvbihPYmplY3QuYXNzaWduKHsgZXhwaXJlc19hdDogTWF0aC5yb3VuZChEYXRlLm5vdygpIC8gMWUzKSArIGRhdGEuZXhwaXJlc19pbiB9LCBkYXRhKSk7CiAgICAgICAgICBhd2FpdCB0aGlzLl9ub3RpZnlBbGxTdWJzY3JpYmVycygiTUZBX0NIQUxMRU5HRV9WRVJJRklFRCIsIGRhdGEpOwogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGEsIGVycm9yIH0pOwogICAgICAgIH0pOwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvciB9KTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgZXJyb3I7CiAgICAgIH0KICAgIH0pOwogIH0KICBhc3luYyBfY2hhbGxlbmdlKHBhcmFtcykgewogICAgcmV0dXJuIHRoaXMuX2FjcXVpcmVMb2NrKHRoaXMubG9ja0FjcXVpcmVUaW1lb3V0LCBhc3luYyAoKSA9PiB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3VzZVNlc3Npb24oYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICAgICAgdmFyIF9hOwogICAgICAgICAgY29uc3QgeyBkYXRhOiBzZXNzaW9uRGF0YSwgZXJyb3I6IHNlc3Npb25FcnJvciB9ID0gcmVzdWx0OwogICAgICAgICAgaWYgKHNlc3Npb25FcnJvcikgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3I6IHNlc3Npb25FcnJvciB9KTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vZmFjdG9ycy8ke3BhcmFtcy5mYWN0b3JJZH0vY2hhbGxlbmdlYCwgewogICAgICAgICAgICBib2R5OiBwYXJhbXMsCiAgICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgICAgand0OiAoX2EgPSBzZXNzaW9uRGF0YSA9PT0gbnVsbCB8fCBzZXNzaW9uRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogc2Vzc2lvbkRhdGEuc2Vzc2lvbikgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmFjY2Vzc190b2tlbgogICAgICAgICAgfSk7CiAgICAgICAgICBpZiAocmVzcG9uc2UuZXJyb3IpIHsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgICAgICAgfQogICAgICAgICAgY29uc3QgeyBkYXRhIH0gPSByZXNwb25zZTsKICAgICAgICAgIGlmIChkYXRhLnR5cGUgIT09ICJ3ZWJhdXRobiIpIHsKICAgICAgICAgICAgcmV0dXJuIHsgZGF0YSwgZXJyb3I6IG51bGwgfTsKICAgICAgICAgIH0KICAgICAgICAgIHN3aXRjaCAoZGF0YS53ZWJhdXRobi50eXBlKSB7CiAgICAgICAgICAgIGNhc2UgImNyZWF0ZSI6CiAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGRhdGE6IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgZGF0YSksIHsgd2ViYXV0aG46IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgZGF0YS53ZWJhdXRobiksIHsgY3JlZGVudGlhbF9vcHRpb25zOiBPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIGRhdGEud2ViYXV0aG4uY3JlZGVudGlhbF9vcHRpb25zKSwgeyBwdWJsaWNLZXk6IGRlc2VyaWFsaXplQ3JlZGVudGlhbENyZWF0aW9uT3B0aW9ucyhkYXRhLndlYmF1dGhuLmNyZWRlbnRpYWxfb3B0aW9ucy5wdWJsaWNLZXkpIH0pIH0pIH0pLAogICAgICAgICAgICAgICAgZXJyb3I6IG51bGwKICAgICAgICAgICAgICB9OwogICAgICAgICAgICBjYXNlICJyZXF1ZXN0IjoKICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgZGF0YTogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBkYXRhKSwgeyB3ZWJhdXRobjogT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBkYXRhLndlYmF1dGhuKSwgeyBjcmVkZW50aWFsX29wdGlvbnM6IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgZGF0YS53ZWJhdXRobi5jcmVkZW50aWFsX29wdGlvbnMpLCB7IHB1YmxpY0tleTogZGVzZXJpYWxpemVDcmVkZW50aWFsUmVxdWVzdE9wdGlvbnMoZGF0YS53ZWJhdXRobi5jcmVkZW50aWFsX29wdGlvbnMucHVibGljS2V5KSB9KSB9KSB9KSwKICAgICAgICAgICAgICAgIGVycm9yOiBudWxsCiAgICAgICAgICAgICAgfTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3IgfSk7CiAgICAgICAgfQogICAgICAgIHRocm93IGVycm9yOwogICAgICB9CiAgICB9KTsKICB9CiAgLyoqCiAgICoge0BzZWUgR29UcnVlTUZBQXBpI2NoYWxsZW5nZUFuZFZlcmlmeX0KICAgKi8KICBhc3luYyBfY2hhbGxlbmdlQW5kVmVyaWZ5KHBhcmFtcykgewogICAgY29uc3QgeyBkYXRhOiBjaGFsbGVuZ2VEYXRhLCBlcnJvcjogY2hhbGxlbmdlRXJyb3IgfSA9IGF3YWl0IHRoaXMuX2NoYWxsZW5nZSh7CiAgICAgIGZhY3RvcklkOiBwYXJhbXMuZmFjdG9ySWQKICAgIH0pOwogICAgaWYgKGNoYWxsZW5nZUVycm9yKSB7CiAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvcjogY2hhbGxlbmdlRXJyb3IgfSk7CiAgICB9CiAgICByZXR1cm4gYXdhaXQgdGhpcy5fdmVyaWZ5KHsKICAgICAgZmFjdG9ySWQ6IHBhcmFtcy5mYWN0b3JJZCwKICAgICAgY2hhbGxlbmdlSWQ6IGNoYWxsZW5nZURhdGEuaWQsCiAgICAgIGNvZGU6IHBhcmFtcy5jb2RlCiAgICB9KTsKICB9CiAgLyoqCiAgICoge0BzZWUgR29UcnVlTUZBQXBpI2xpc3RGYWN0b3JzfQogICAqLwogIGFzeW5jIF9saXN0RmFjdG9ycygpIHsKICAgIHZhciBfYTsKICAgIGNvbnN0IHsgZGF0YTogeyB1c2VyIH0sIGVycm9yOiB1c2VyRXJyb3IgfSA9IGF3YWl0IHRoaXMuZ2V0VXNlcigpOwogICAgaWYgKHVzZXJFcnJvcikgewogICAgICByZXR1cm4geyBkYXRhOiBudWxsLCBlcnJvcjogdXNlckVycm9yIH07CiAgICB9CiAgICBjb25zdCBkYXRhID0gewogICAgICBhbGw6IFtdLAogICAgICBwaG9uZTogW10sCiAgICAgIHRvdHA6IFtdLAogICAgICB3ZWJhdXRobjogW10KICAgIH07CiAgICBmb3IgKGNvbnN0IGZhY3RvciBvZiAoX2EgPSB1c2VyID09PSBudWxsIHx8IHVzZXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHVzZXIuZmFjdG9ycykgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogW10pIHsKICAgICAgZGF0YS5hbGwucHVzaChmYWN0b3IpOwogICAgICBpZiAoZmFjdG9yLnN0YXR1cyA9PT0gInZlcmlmaWVkIikgewogICAgICAgIDsKICAgICAgICBkYXRhW2ZhY3Rvci5mYWN0b3JfdHlwZV0ucHVzaChmYWN0b3IpOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICBkYXRhLAogICAgICBlcnJvcjogbnVsbAogICAgfTsKICB9CiAgLyoqCiAgICoge0BzZWUgR29UcnVlTUZBQXBpI2dldEF1dGhlbnRpY2F0b3JBc3N1cmFuY2VMZXZlbH0KICAgKi8KICBhc3luYyBfZ2V0QXV0aGVudGljYXRvckFzc3VyYW5jZUxldmVsKGp3dCkgewogICAgdmFyIF9hLCBfYiwgX2MsIF9kOwogICAgaWYgKGp3dCkgewogICAgICB0cnkgewogICAgICAgIGNvbnN0IHsgcGF5bG9hZDogcGF5bG9hZDIgfSA9IGRlY29kZUpXVChqd3QpOwogICAgICAgIGxldCBjdXJyZW50TGV2ZWwyID0gbnVsbDsKICAgICAgICBpZiAocGF5bG9hZDIuYWFsKSB7CiAgICAgICAgICBjdXJyZW50TGV2ZWwyID0gcGF5bG9hZDIuYWFsOwogICAgICAgIH0KICAgICAgICBsZXQgbmV4dExldmVsMiA9IGN1cnJlbnRMZXZlbDI7CiAgICAgICAgY29uc3QgeyBkYXRhOiB7IHVzZXIgfSwgZXJyb3I6IHVzZXJFcnJvciB9ID0gYXdhaXQgdGhpcy5nZXRVc2VyKGp3dCk7CiAgICAgICAgaWYgKHVzZXJFcnJvcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yOiB1c2VyRXJyb3IgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZlcmlmaWVkRmFjdG9yczIgPSAoX2IgPSAoX2EgPSB1c2VyID09PSBudWxsIHx8IHVzZXIgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHVzZXIuZmFjdG9ycykgPT09IG51bGwgfHwgX2EgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9hLmZpbHRlcigoZmFjdG9yKSA9PiBmYWN0b3Iuc3RhdHVzID09PSAidmVyaWZpZWQiKSkgIT09IG51bGwgJiYgX2IgIT09IHZvaWQgMCA/IF9iIDogW107CiAgICAgICAgaWYgKHZlcmlmaWVkRmFjdG9yczIubGVuZ3RoID4gMCkgewogICAgICAgICAgbmV4dExldmVsMiA9ICJhYWwyIjsKICAgICAgICB9CiAgICAgICAgY29uc3QgY3VycmVudEF1dGhlbnRpY2F0aW9uTWV0aG9kczIgPSBwYXlsb2FkMi5hbXIgfHwgW107CiAgICAgICAgcmV0dXJuIHsgZGF0YTogeyBjdXJyZW50TGV2ZWw6IGN1cnJlbnRMZXZlbDIsIG5leHRMZXZlbDogbmV4dExldmVsMiwgY3VycmVudEF1dGhlbnRpY2F0aW9uTWV0aG9kczogY3VycmVudEF1dGhlbnRpY2F0aW9uTWV0aG9kczIgfSwgZXJyb3I6IG51bGwgfTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3IgfSk7CiAgICAgICAgfQogICAgICAgIHRocm93IGVycm9yOwogICAgICB9CiAgICB9CiAgICBjb25zdCB7IGRhdGE6IHsgc2Vzc2lvbiB9LCBlcnJvcjogc2Vzc2lvbkVycm9yIH0gPSBhd2FpdCB0aGlzLmdldFNlc3Npb24oKTsKICAgIGlmIChzZXNzaW9uRXJyb3IpIHsKICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yOiBzZXNzaW9uRXJyb3IgfSk7CiAgICB9CiAgICBpZiAoIXNlc3Npb24pIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBkYXRhOiB7IGN1cnJlbnRMZXZlbDogbnVsbCwgbmV4dExldmVsOiBudWxsLCBjdXJyZW50QXV0aGVudGljYXRpb25NZXRob2RzOiBbXSB9LAogICAgICAgIGVycm9yOiBudWxsCiAgICAgIH07CiAgICB9CiAgICBjb25zdCB7IHBheWxvYWQgfSA9IGRlY29kZUpXVChzZXNzaW9uLmFjY2Vzc190b2tlbik7CiAgICBsZXQgY3VycmVudExldmVsID0gbnVsbDsKICAgIGlmIChwYXlsb2FkLmFhbCkgewogICAgICBjdXJyZW50TGV2ZWwgPSBwYXlsb2FkLmFhbDsKICAgIH0KICAgIGxldCBuZXh0TGV2ZWwgPSBjdXJyZW50TGV2ZWw7CiAgICBjb25zdCB2ZXJpZmllZEZhY3RvcnMgPSAoX2QgPSAoX2MgPSBzZXNzaW9uLnVzZXIuZmFjdG9ycykgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmZpbHRlcigoZmFjdG9yKSA9PiBmYWN0b3Iuc3RhdHVzID09PSAidmVyaWZpZWQiKSkgIT09IG51bGwgJiYgX2QgIT09IHZvaWQgMCA/IF9kIDogW107CiAgICBpZiAodmVyaWZpZWRGYWN0b3JzLmxlbmd0aCA+IDApIHsKICAgICAgbmV4dExldmVsID0gImFhbDIiOwogICAgfQogICAgY29uc3QgY3VycmVudEF1dGhlbnRpY2F0aW9uTWV0aG9kcyA9IHBheWxvYWQuYW1yIHx8IFtdOwogICAgcmV0dXJuIHsgZGF0YTogeyBjdXJyZW50TGV2ZWwsIG5leHRMZXZlbCwgY3VycmVudEF1dGhlbnRpY2F0aW9uTWV0aG9kcyB9LCBlcnJvcjogbnVsbCB9OwogIH0KICAvKioKICAgKiBSZXRyaWV2ZXMgZGV0YWlscyBhYm91dCBhbiBPQXV0aCBhdXRob3JpemF0aW9uIHJlcXVlc3QuCiAgICogT25seSByZWxldmFudCB3aGVuIHRoZSBPQXV0aCAyLjEgc2VydmVyIGlzIGVuYWJsZWQgaW4gU3VwYWJhc2UgQXV0aC4KICAgKgogICAqIFJldHVybnMgYXV0aG9yaXphdGlvbiBkZXRhaWxzIGluY2x1ZGluZyBjbGllbnQgaW5mbywgc2NvcGVzLCBhbmQgdXNlciBpbmZvcm1hdGlvbi4KICAgKiBJZiB0aGUgcmVzcG9uc2UgaW5jbHVkZXMgb25seSBhIHJlZGlyZWN0X3VybCBmaWVsZCwgaXQgbWVhbnMgY29uc2VudCB3YXMgYWxyZWFkeSBnaXZlbiAtIHRoZSBjYWxsZXIKICAgKiBzaG91bGQgaGFuZGxlIHRoZSByZWRpcmVjdCBtYW51YWxseSBpZiBuZWVkZWQuCiAgICovCiAgYXN5bmMgX2dldEF1dGhvcml6YXRpb25EZXRhaWxzKGF1dGhvcml6YXRpb25JZCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3VzZVNlc3Npb24oYXN5bmMgKHJlc3VsdCkgPT4gewogICAgICAgIGNvbnN0IHsgZGF0YTogeyBzZXNzaW9uIH0sIGVycm9yOiBzZXNzaW9uRXJyb3IgfSA9IHJlc3VsdDsKICAgICAgICBpZiAoc2Vzc2lvbkVycm9yKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3I6IHNlc3Npb25FcnJvciB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKCFzZXNzaW9uKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3I6IG5ldyBBdXRoU2Vzc2lvbk1pc3NpbmdFcnJvcigpIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIkdFVCIsIGAke3RoaXMudXJsfS9vYXV0aC9hdXRob3JpemF0aW9ucy8ke2F1dGhvcml6YXRpb25JZH1gLCB7CiAgICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgICBqd3Q6IHNlc3Npb24uYWNjZXNzX3Rva2VuLAogICAgICAgICAgeGZvcm06IChkYXRhKSA9PiAoeyBkYXRhLCBlcnJvcjogbnVsbCB9KQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIEFwcHJvdmVzIGFuIE9BdXRoIGF1dGhvcml6YXRpb24gcmVxdWVzdC4KICAgKiBPbmx5IHJlbGV2YW50IHdoZW4gdGhlIE9BdXRoIDIuMSBzZXJ2ZXIgaXMgZW5hYmxlZCBpbiBTdXBhYmFzZSBBdXRoLgogICAqLwogIGFzeW5jIF9hcHByb3ZlQXV0aG9yaXphdGlvbihhdXRob3JpemF0aW9uSWQsIG9wdGlvbnMpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl91c2VTZXNzaW9uKGFzeW5jIChyZXN1bHQpID0+IHsKICAgICAgICBjb25zdCB7IGRhdGE6IHsgc2Vzc2lvbiB9LCBlcnJvcjogc2Vzc2lvbkVycm9yIH0gPSByZXN1bHQ7CiAgICAgICAgaWYgKHNlc3Npb25FcnJvcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yOiBzZXNzaW9uRXJyb3IgfSk7CiAgICAgICAgfQogICAgICAgIGlmICghc2Vzc2lvbikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yOiBuZXcgQXV0aFNlc3Npb25NaXNzaW5nRXJyb3IoKSB9KTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiUE9TVCIsIGAke3RoaXMudXJsfS9vYXV0aC9hdXRob3JpemF0aW9ucy8ke2F1dGhvcml6YXRpb25JZH0vY29uc2VudGAsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGp3dDogc2Vzc2lvbi5hY2Nlc3NfdG9rZW4sCiAgICAgICAgICBib2R5OiB7IGFjdGlvbjogImFwcHJvdmUiIH0sCiAgICAgICAgICB4Zm9ybTogKGRhdGEpID0+ICh7IGRhdGEsIGVycm9yOiBudWxsIH0pCiAgICAgICAgfSk7CiAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEgJiYgcmVzcG9uc2UuZGF0YS5yZWRpcmVjdF91cmwpIHsKICAgICAgICAgIGlmIChpc0Jyb3dzZXIoKSAmJiAhKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5za2lwQnJvd3NlclJlZGlyZWN0KSkgewogICAgICAgICAgICB3aW5kb3cubG9jYXRpb24uYXNzaWduKHJlc3BvbnNlLmRhdGEucmVkaXJlY3RfdXJsKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgICB9KTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQogIC8qKgogICAqIERlbmllcyBhbiBPQXV0aCBhdXRob3JpemF0aW9uIHJlcXVlc3QuCiAgICogT25seSByZWxldmFudCB3aGVuIHRoZSBPQXV0aCAyLjEgc2VydmVyIGlzIGVuYWJsZWQgaW4gU3VwYWJhc2UgQXV0aC4KICAgKi8KICBhc3luYyBfZGVueUF1dGhvcml6YXRpb24oYXV0aG9yaXphdGlvbklkLCBvcHRpb25zKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fdXNlU2Vzc2lvbihhc3luYyAocmVzdWx0KSA9PiB7CiAgICAgICAgY29uc3QgeyBkYXRhOiB7IHNlc3Npb24gfSwgZXJyb3I6IHNlc3Npb25FcnJvciB9ID0gcmVzdWx0OwogICAgICAgIGlmIChzZXNzaW9uRXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvcjogc2Vzc2lvbkVycm9yIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoIXNlc3Npb24pIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvcjogbmV3IEF1dGhTZXNzaW9uTWlzc2luZ0Vycm9yKCkgfSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIlBPU1QiLCBgJHt0aGlzLnVybH0vb2F1dGgvYXV0aG9yaXphdGlvbnMvJHthdXRob3JpemF0aW9uSWR9L2NvbnNlbnRgLCB7CiAgICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgICAgICBqd3Q6IHNlc3Npb24uYWNjZXNzX3Rva2VuLAogICAgICAgICAgYm9keTogeyBhY3Rpb246ICJkZW55IiB9LAogICAgICAgICAgeGZvcm06IChkYXRhKSA9PiAoeyBkYXRhLCBlcnJvcjogbnVsbCB9KQogICAgICAgIH0pOwogICAgICAgIGlmIChyZXNwb25zZS5kYXRhICYmIHJlc3BvbnNlLmRhdGEucmVkaXJlY3RfdXJsKSB7CiAgICAgICAgICBpZiAoaXNCcm93c2VyKCkgJiYgIShvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc2tpcEJyb3dzZXJSZWRpcmVjdCkpIHsKICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLmFzc2lnbihyZXNwb25zZS5kYXRhLnJlZGlyZWN0X3VybCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXNwb25zZTsKICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBMaXN0cyBhbGwgT0F1dGggZ3JhbnRzIHRoYXQgdGhlIGF1dGhlbnRpY2F0ZWQgdXNlciBoYXMgYXV0aG9yaXplZC4KICAgKiBPbmx5IHJlbGV2YW50IHdoZW4gdGhlIE9BdXRoIDIuMSBzZXJ2ZXIgaXMgZW5hYmxlZCBpbiBTdXBhYmFzZSBBdXRoLgogICAqLwogIGFzeW5jIF9saXN0T0F1dGhHcmFudHMoKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gYXdhaXQgdGhpcy5fdXNlU2Vzc2lvbihhc3luYyAocmVzdWx0KSA9PiB7CiAgICAgICAgY29uc3QgeyBkYXRhOiB7IHNlc3Npb24gfSwgZXJyb3I6IHNlc3Npb25FcnJvciB9ID0gcmVzdWx0OwogICAgICAgIGlmIChzZXNzaW9uRXJyb3IpIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvcjogc2Vzc2lvbkVycm9yIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoIXNlc3Npb24pIHsKICAgICAgICAgIHJldHVybiB0aGlzLl9yZXR1cm5SZXN1bHQoeyBkYXRhOiBudWxsLCBlcnJvcjogbmV3IEF1dGhTZXNzaW9uTWlzc2luZ0Vycm9yKCkgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiR0VUIiwgYCR7dGhpcy51cmx9L3VzZXIvb2F1dGgvZ3JhbnRzYCwgewogICAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICAgICAgand0OiBzZXNzaW9uLmFjY2Vzc190b2tlbiwKICAgICAgICAgIHhmb3JtOiAoZGF0YSkgPT4gKHsgZGF0YSwgZXJyb3I6IG51bGwgfSkKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICAvKioKICAgKiBSZXZva2VzIGEgdXNlcidzIE9BdXRoIGdyYW50IGZvciBhIHNwZWNpZmljIGNsaWVudC4KICAgKiBPbmx5IHJlbGV2YW50IHdoZW4gdGhlIE9BdXRoIDIuMSBzZXJ2ZXIgaXMgZW5hYmxlZCBpbiBTdXBhYmFzZSBBdXRoLgogICAqLwogIGFzeW5jIF9yZXZva2VPQXV0aEdyYW50KG9wdGlvbnMpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl91c2VTZXNzaW9uKGFzeW5jIChyZXN1bHQpID0+IHsKICAgICAgICBjb25zdCB7IGRhdGE6IHsgc2Vzc2lvbiB9LCBlcnJvcjogc2Vzc2lvbkVycm9yIH0gPSByZXN1bHQ7CiAgICAgICAgaWYgKHNlc3Npb25FcnJvcikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yOiBzZXNzaW9uRXJyb3IgfSk7CiAgICAgICAgfQogICAgICAgIGlmICghc2Vzc2lvbikgewogICAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yOiBuZXcgQXV0aFNlc3Npb25NaXNzaW5nRXJyb3IoKSB9KTsKICAgICAgICB9CiAgICAgICAgYXdhaXQgX3JlcXVlc3QodGhpcy5mZXRjaCwgIkRFTEVURSIsIGAke3RoaXMudXJsfS91c2VyL29hdXRoL2dyYW50c2AsIHsKICAgICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgICAgIGp3dDogc2Vzc2lvbi5hY2Nlc3NfdG9rZW4sCiAgICAgICAgICBxdWVyeTogeyBjbGllbnRfaWQ6IG9wdGlvbnMuY2xpZW50SWQgfSwKICAgICAgICAgIG5vUmVzb2x2ZUpzb246IHRydWUKICAgICAgICB9KTsKICAgICAgICByZXR1cm4geyBkYXRhOiB7fSwgZXJyb3I6IG51bGwgfTsKICAgICAgfSk7CiAgICB9IGNhdGNoIChlcnJvcikgewogICAgICBpZiAoaXNBdXRoRXJyb3IoZXJyb3IpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JldHVyblJlc3VsdCh7IGRhdGE6IG51bGwsIGVycm9yIH0pOwogICAgICB9CiAgICAgIHRocm93IGVycm9yOwogICAgfQogIH0KICBhc3luYyBmZXRjaEp3ayhraWQsIGp3a3MgPSB7IGtleXM6IFtdIH0pIHsKICAgIGxldCBqd2sgPSBqd2tzLmtleXMuZmluZCgoa2V5KSA9PiBrZXkua2lkID09PSBraWQpOwogICAgaWYgKGp3aykgewogICAgICByZXR1cm4gandrOwogICAgfQogICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICAgIGp3ayA9IHRoaXMuandrcy5rZXlzLmZpbmQoKGtleSkgPT4ga2V5LmtpZCA9PT0ga2lkKTsKICAgIGlmIChqd2sgJiYgdGhpcy5qd2tzX2NhY2hlZF9hdCArIEpXS1NfVFRMID4gbm93KSB7CiAgICAgIHJldHVybiBqd2s7CiAgICB9CiAgICBjb25zdCB7IGRhdGEsIGVycm9yIH0gPSBhd2FpdCBfcmVxdWVzdCh0aGlzLmZldGNoLCAiR0VUIiwgYCR7dGhpcy51cmx9Ly53ZWxsLWtub3duL2p3a3MuanNvbmAsIHsKICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzCiAgICB9KTsKICAgIGlmIChlcnJvcikgewogICAgICB0aHJvdyBlcnJvcjsKICAgIH0KICAgIGlmICghZGF0YS5rZXlzIHx8IGRhdGEua2V5cy5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgICB0aGlzLmp3a3MgPSBkYXRhOwogICAgdGhpcy5qd2tzX2NhY2hlZF9hdCA9IG5vdzsKICAgIGp3ayA9IGRhdGEua2V5cy5maW5kKChrZXkpID0+IGtleS5raWQgPT09IGtpZCk7CiAgICBpZiAoIWp3aykgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0KICAgIHJldHVybiBqd2s7CiAgfQogIC8qKgogICAqIEV4dHJhY3RzIHRoZSBKV1QgY2xhaW1zIHByZXNlbnQgaW4gdGhlIGFjY2VzcyB0b2tlbiBieSBmaXJzdCB2ZXJpZnlpbmcgdGhlCiAgICogSldUIGFnYWluc3QgdGhlIHNlcnZlcidzIEpTT04gV2ViIEtleSBTZXQgZW5kcG9pbnQKICAgKiBgLy53ZWxsLWtub3duL2p3a3MuanNvbmAgd2hpY2ggaXMgb2Z0ZW4gY2FjaGVkLCByZXN1bHRpbmcgaW4gc2lnbmlmaWNhbnRseQogICAqIGZhc3RlciByZXNwb25zZXMuIFByZWZlciB0aGlzIG1ldGhvZCBvdmVyIHtAbGluayAjZ2V0VXNlcn0gd2hpY2ggYWx3YXlzCiAgICogc2VuZHMgYSByZXF1ZXN0IHRvIHRoZSBBdXRoIHNlcnZlciBmb3IgZWFjaCBKV1QuCiAgICoKICAgKiBJZiB0aGUgcHJvamVjdCBpcyBub3QgdXNpbmcgYW4gYXN5bW1ldHJpYyBKV1Qgc2lnbmluZyBrZXkgKGxpa2UgRUNDIG9yCiAgICogUlNBKSBpdCBhbHdheXMgc2VuZHMgYSByZXF1ZXN0IHRvIHRoZSBBdXRoIHNlcnZlciAoc2ltaWxhciB0byB7QGxpbmsKICAgKiAjZ2V0VXNlcn0pIHRvIHZlcmlmeSB0aGUgSldULgogICAqCiAgICogQHBhcmFtIGp3dCBBbiBvcHRpb25hbCBzcGVjaWZpYyBKV1QgeW91IHdpc2ggdG8gdmVyaWZ5LCBub3QgdGhlIG9uZSB5b3UKICAgKiAgICAgICAgICAgIGNhbiBvYnRhaW4gZnJvbSB7QGxpbmsgI2dldFNlc3Npb259LgogICAqIEBwYXJhbSBvcHRpb25zIFZhcmlvdXMgYWRkaXRpb25hbCBvcHRpb25zIHRoYXQgYWxsb3cgeW91IHRvIGN1c3RvbWl6ZSB0aGUKICAgKiAgICAgICAgICAgICAgICBiZWhhdmlvciBvZiB0aGlzIG1ldGhvZC4KICAgKi8KICBhc3luYyBnZXRDbGFpbXMoand0LCBvcHRpb25zID0ge30pIHsKICAgIHRyeSB7CiAgICAgIGxldCB0b2tlbiA9IGp3dDsKICAgICAgaWYgKCF0b2tlbikgewogICAgICAgIGNvbnN0IHsgZGF0YSwgZXJyb3IgfSA9IGF3YWl0IHRoaXMuZ2V0U2Vzc2lvbigpOwogICAgICAgIGlmIChlcnJvciB8fCAhZGF0YS5zZXNzaW9uKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3IgfSk7CiAgICAgICAgfQogICAgICAgIHRva2VuID0gZGF0YS5zZXNzaW9uLmFjY2Vzc190b2tlbjsKICAgICAgfQogICAgICBjb25zdCB7IGhlYWRlciwgcGF5bG9hZCwgc2lnbmF0dXJlLCByYXc6IHsgaGVhZGVyOiByYXdIZWFkZXIsIHBheWxvYWQ6IHJhd1BheWxvYWQgfSB9ID0gZGVjb2RlSldUKHRva2VuKTsKICAgICAgaWYgKCEob3B0aW9ucyA9PT0gbnVsbCB8fCBvcHRpb25zID09PSB2b2lkIDAgPyB2b2lkIDAgOiBvcHRpb25zLmFsbG93RXhwaXJlZCkpIHsKICAgICAgICB2YWxpZGF0ZUV4cChwYXlsb2FkLmV4cCk7CiAgICAgIH0KICAgICAgY29uc3Qgc2lnbmluZ0tleSA9ICFoZWFkZXIuYWxnIHx8IGhlYWRlci5hbGcuc3RhcnRzV2l0aCgiSFMiKSB8fCAhaGVhZGVyLmtpZCB8fCAhKCJjcnlwdG8iIGluIGdsb2JhbFRoaXMgJiYgInN1YnRsZSIgaW4gZ2xvYmFsVGhpcy5jcnlwdG8pID8gbnVsbCA6IGF3YWl0IHRoaXMuZmV0Y2hKd2soaGVhZGVyLmtpZCwgKG9wdGlvbnMgPT09IG51bGwgfHwgb3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogb3B0aW9ucy5rZXlzKSA/IHsga2V5czogb3B0aW9ucy5rZXlzIH0gOiBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuandrcyk7CiAgICAgIGlmICghc2lnbmluZ0tleSkgewogICAgICAgIGNvbnN0IHsgZXJyb3IgfSA9IGF3YWl0IHRoaXMuZ2V0VXNlcih0b2tlbik7CiAgICAgICAgaWYgKGVycm9yKSB7CiAgICAgICAgICB0aHJvdyBlcnJvcjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGRhdGE6IHsKICAgICAgICAgICAgY2xhaW1zOiBwYXlsb2FkLAogICAgICAgICAgICBoZWFkZXIsCiAgICAgICAgICAgIHNpZ25hdHVyZQogICAgICAgICAgfSwKICAgICAgICAgIGVycm9yOiBudWxsCiAgICAgICAgfTsKICAgICAgfQogICAgICBjb25zdCBhbGdvcml0aG0gPSBnZXRBbGdvcml0aG0oaGVhZGVyLmFsZyk7CiAgICAgIGNvbnN0IHB1YmxpY0tleSA9IGF3YWl0IGNyeXB0by5zdWJ0bGUuaW1wb3J0S2V5KCJqd2siLCBzaWduaW5nS2V5LCBhbGdvcml0aG0sIHRydWUsIFsKICAgICAgICAidmVyaWZ5IgogICAgICBdKTsKICAgICAgY29uc3QgaXNWYWxpZCA9IGF3YWl0IGNyeXB0by5zdWJ0bGUudmVyaWZ5KGFsZ29yaXRobSwgcHVibGljS2V5LCBzaWduYXR1cmUsIHN0cmluZ1RvVWludDhBcnJheShgJHtyYXdIZWFkZXJ9LiR7cmF3UGF5bG9hZH1gKSk7CiAgICAgIGlmICghaXNWYWxpZCkgewogICAgICAgIHRocm93IG5ldyBBdXRoSW52YWxpZEp3dEVycm9yKCJJbnZhbGlkIEpXVCBzaWduYXR1cmUiKTsKICAgICAgfQogICAgICByZXR1cm4gewogICAgICAgIGRhdGE6IHsKICAgICAgICAgIGNsYWltczogcGF5bG9hZCwKICAgICAgICAgIGhlYWRlciwKICAgICAgICAgIHNpZ25hdHVyZQogICAgICAgIH0sCiAgICAgICAgZXJyb3I6IG51bGwKICAgICAgfTsKICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgIGlmIChpc0F1dGhFcnJvcihlcnJvcikpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcmV0dXJuUmVzdWx0KHsgZGF0YTogbnVsbCwgZXJyb3IgfSk7CiAgICAgIH0KICAgICAgdGhyb3cgZXJyb3I7CiAgICB9CiAgfQp9OwpHb1RydWVDbGllbnQubmV4dEluc3RhbmNlSUQgPSB7fTsKdmFyIEdvVHJ1ZUNsaWVudF9kZWZhdWx0ID0gR29UcnVlQ2xpZW50OwoKLy8gbm9kZV9tb2R1bGVzLy5wbnBtL0BzdXBhYmFzZSthdXRoLWpzQDIuOTcuMC9ub2RlX21vZHVsZXMvQHN1cGFiYXNlL2F1dGgtanMvZGlzdC9tb2R1bGUvQXV0aENsaWVudC5qcwp2YXIgQXV0aENsaWVudCA9IEdvVHJ1ZUNsaWVudF9kZWZhdWx0Owp2YXIgQXV0aENsaWVudF9kZWZhdWx0ID0gQXV0aENsaWVudDsKCi8vIG5vZGVfbW9kdWxlcy8ucG5wbS9Ac3VwYWJhc2Urc3VwYWJhc2UtanNAMi45Ny4wL25vZGVfbW9kdWxlcy9Ac3VwYWJhc2Uvc3VwYWJhc2UtanMvZGlzdC9pbmRleC5tanMKdmFyIHZlcnNpb241ID0gIjIuOTcuMCI7CnZhciBKU19FTlYgPSAiIjsKaWYgKHR5cGVvZiBEZW5vICE9PSAidW5kZWZpbmVkIikgSlNfRU5WID0gImRlbm8iOwplbHNlIGlmICh0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiKSBKU19FTlYgPSAid2ViIjsKZWxzZSBpZiAodHlwZW9mIG5hdmlnYXRvciAhPT0gInVuZGVmaW5lZCIgJiYgbmF2aWdhdG9yLnByb2R1Y3QgPT09ICJSZWFjdE5hdGl2ZSIpIEpTX0VOViA9ICJyZWFjdC1uYXRpdmUiOwplbHNlIEpTX0VOViA9ICJub2RlIjsKdmFyIERFRkFVTFRfSEVBREVSUzMgPSB7ICJYLUNsaWVudC1JbmZvIjogYHN1cGFiYXNlLWpzLSR7SlNfRU5WfS8ke3ZlcnNpb241fWAgfTsKdmFyIERFRkFVTFRfR0xPQkFMX09QVElPTlMgPSB7IGhlYWRlcnM6IERFRkFVTFRfSEVBREVSUzMgfTsKdmFyIERFRkFVTFRfREJfT1BUSU9OUyA9IHsgc2NoZW1hOiAicHVibGljIiB9Owp2YXIgREVGQVVMVF9BVVRIX09QVElPTlMgPSB7CiAgYXV0b1JlZnJlc2hUb2tlbjogdHJ1ZSwKICBwZXJzaXN0U2Vzc2lvbjogdHJ1ZSwKICBkZXRlY3RTZXNzaW9uSW5Vcmw6IHRydWUsCiAgZmxvd1R5cGU6ICJpbXBsaWNpdCIKfTsKdmFyIERFRkFVTFRfUkVBTFRJTUVfT1BUSU9OUyA9IHt9OwpmdW5jdGlvbiBfdHlwZW9mMyhvKSB7CiAgIkBiYWJlbC9oZWxwZXJzIC0gdHlwZW9mIjsKICByZXR1cm4gX3R5cGVvZjMgPSAiZnVuY3Rpb24iID09IHR5cGVvZiBTeW1ib2wgJiYgInN5bWJvbCIgPT0gdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA/IGZ1bmN0aW9uKG8kMSkgewogICAgcmV0dXJuIHR5cGVvZiBvJDE7CiAgfSA6IGZ1bmN0aW9uKG8kMSkgewogICAgcmV0dXJuIG8kMSAmJiAiZnVuY3Rpb24iID09IHR5cGVvZiBTeW1ib2wgJiYgbyQxLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgbyQxICE9PSBTeW1ib2wucHJvdG90eXBlID8gInN5bWJvbCIgOiB0eXBlb2YgbyQxOwogIH0sIF90eXBlb2YzKG8pOwp9CmZ1bmN0aW9uIHRvUHJpbWl0aXZlMyh0LCByMikgewogIGlmICgib2JqZWN0IiAhPSBfdHlwZW9mMyh0KSB8fCAhdCkgcmV0dXJuIHQ7CiAgdmFyIGUgPSB0W1N5bWJvbC50b1ByaW1pdGl2ZV07CiAgaWYgKHZvaWQgMCAhPT0gZSkgewogICAgdmFyIGkgPSBlLmNhbGwodCwgcjIgfHwgImRlZmF1bHQiKTsKICAgIGlmICgib2JqZWN0IiAhPSBfdHlwZW9mMyhpKSkgcmV0dXJuIGk7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJAQHRvUHJpbWl0aXZlIG11c3QgcmV0dXJuIGEgcHJpbWl0aXZlIHZhbHVlLiIpOwogIH0KICByZXR1cm4gKCJzdHJpbmciID09PSByMiA/IFN0cmluZyA6IE51bWJlcikodCk7Cn0KZnVuY3Rpb24gdG9Qcm9wZXJ0eUtleTModCkgewogIHZhciBpID0gdG9QcmltaXRpdmUzKHQsICJzdHJpbmciKTsKICByZXR1cm4gInN5bWJvbCIgPT0gX3R5cGVvZjMoaSkgPyBpIDogaSArICIiOwp9CmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eTM2KGUsIHIyLCB0KSB7CiAgcmV0dXJuIChyMiA9IHRvUHJvcGVydHlLZXkzKHIyKSkgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByMiwgewogICAgdmFsdWU6IHQsCiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgd3JpdGFibGU6IHRydWUKICB9KSA6IGVbcjJdID0gdCwgZTsKfQpmdW5jdGlvbiBvd25LZXlzMzQoZSwgcjIpIHsKICB2YXIgdCA9IE9iamVjdC5rZXlzKGUpOwogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgbyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICByMiAmJiAobyA9IG8uZmlsdGVyKGZ1bmN0aW9uKHIkMSkgewogICAgICByZXR1cm4gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlLCByJDEpLmVudW1lcmFibGU7CiAgICB9KSksIHQucHVzaC5hcHBseSh0LCBvKTsKICB9CiAgcmV0dXJuIHQ7Cn0KZnVuY3Rpb24gX29iamVjdFNwcmVhZDIxMihlKSB7CiAgZm9yICh2YXIgcjIgPSAxOyByMiA8IGFyZ3VtZW50cy5sZW5ndGg7IHIyKyspIHsKICAgIHZhciB0ID0gbnVsbCAhPSBhcmd1bWVudHNbcjJdID8gYXJndW1lbnRzW3IyXSA6IHt9OwogICAgcjIgJSAyID8gb3duS2V5czM0KE9iamVjdCh0KSwgdHJ1ZSkuZm9yRWFjaChmdW5jdGlvbihyJDEpIHsKICAgICAgX2RlZmluZVByb3BlcnR5MzYoZSwgciQxLCB0W3IkMV0pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKHQpKSA6IG93bktleXMzNChPYmplY3QodCkpLmZvckVhY2goZnVuY3Rpb24ociQxKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCByJDEsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodCwgciQxKSk7CiAgICB9KTsKICB9CiAgcmV0dXJuIGU7Cn0KdmFyIHJlc29sdmVGZXRjaDQgPSAoY3VzdG9tRmV0Y2gpID0+IHsKICBpZiAoY3VzdG9tRmV0Y2gpIHJldHVybiAoLi4uYXJncykgPT4gY3VzdG9tRmV0Y2goLi4uYXJncyk7CiAgcmV0dXJuICguLi5hcmdzKSA9PiBmZXRjaCguLi5hcmdzKTsKfTsKdmFyIHJlc29sdmVIZWFkZXJzQ29uc3RydWN0b3IgPSAoKSA9PiB7CiAgcmV0dXJuIEhlYWRlcnM7Cn07CnZhciBmZXRjaFdpdGhBdXRoID0gKHN1cGFiYXNlS2V5LCBnZXRBY2Nlc3NUb2tlbiwgY3VzdG9tRmV0Y2gpID0+IHsKICBjb25zdCBmZXRjaCQxID0gcmVzb2x2ZUZldGNoNChjdXN0b21GZXRjaCk7CiAgY29uc3QgSGVhZGVyc0NvbnN0cnVjdG9yID0gcmVzb2x2ZUhlYWRlcnNDb25zdHJ1Y3RvcigpOwogIHJldHVybiBhc3luYyAoaW5wdXQsIGluaXQpID0+IHsKICAgIHZhciBfYXdhaXQkZ2V0QWNjZXNzVG9rZW47CiAgICBjb25zdCBhY2Nlc3NUb2tlbiA9IChfYXdhaXQkZ2V0QWNjZXNzVG9rZW4gPSBhd2FpdCBnZXRBY2Nlc3NUb2tlbigpKSAhPT0gbnVsbCAmJiBfYXdhaXQkZ2V0QWNjZXNzVG9rZW4gIT09IHZvaWQgMCA/IF9hd2FpdCRnZXRBY2Nlc3NUb2tlbiA6IHN1cGFiYXNlS2V5OwogICAgbGV0IGhlYWRlcnMgPSBuZXcgSGVhZGVyc0NvbnN0cnVjdG9yKGluaXQgPT09IG51bGwgfHwgaW5pdCA9PT0gdm9pZCAwID8gdm9pZCAwIDogaW5pdC5oZWFkZXJzKTsKICAgIGlmICghaGVhZGVycy5oYXMoImFwaWtleSIpKSBoZWFkZXJzLnNldCgiYXBpa2V5Iiwgc3VwYWJhc2VLZXkpOwogICAgaWYgKCFoZWFkZXJzLmhhcygiQXV0aG9yaXphdGlvbiIpKSBoZWFkZXJzLnNldCgiQXV0aG9yaXphdGlvbiIsIGBCZWFyZXIgJHthY2Nlc3NUb2tlbn1gKTsKICAgIHJldHVybiBmZXRjaCQxKGlucHV0LCBfb2JqZWN0U3ByZWFkMjEyKF9vYmplY3RTcHJlYWQyMTIoe30sIGluaXQpLCB7fSwgeyBoZWFkZXJzIH0pKTsKICB9Owp9OwpmdW5jdGlvbiBlbnN1cmVUcmFpbGluZ1NsYXNoKHVybCkgewogIHJldHVybiB1cmwuZW5kc1dpdGgoIi8iKSA/IHVybCA6IHVybCArICIvIjsKfQpmdW5jdGlvbiBhcHBseVNldHRpbmdEZWZhdWx0cyhvcHRpb25zLCBkZWZhdWx0cykgewogIHZhciBfREVGQVVMVF9HTE9CQUxfT1BUSU8sIF9nbG9iYWxPcHRpb25zJGhlYWRlcjsKICBjb25zdCB7IGRiOiBkYk9wdGlvbnMsIGF1dGg6IGF1dGhPcHRpb25zLCByZWFsdGltZTogcmVhbHRpbWVPcHRpb25zLCBnbG9iYWw6IGdsb2JhbE9wdGlvbnMgfSA9IG9wdGlvbnM7CiAgY29uc3QgeyBkYjogREVGQVVMVF9EQl9PUFRJT05TJDEsIGF1dGg6IERFRkFVTFRfQVVUSF9PUFRJT05TJDEsIHJlYWx0aW1lOiBERUZBVUxUX1JFQUxUSU1FX09QVElPTlMkMSwgZ2xvYmFsOiBERUZBVUxUX0dMT0JBTF9PUFRJT05TJDEgfSA9IGRlZmF1bHRzOwogIGNvbnN0IHJlc3VsdCA9IHsKICAgIGRiOiBfb2JqZWN0U3ByZWFkMjEyKF9vYmplY3RTcHJlYWQyMTIoe30sIERFRkFVTFRfREJfT1BUSU9OUyQxKSwgZGJPcHRpb25zKSwKICAgIGF1dGg6IF9vYmplY3RTcHJlYWQyMTIoX29iamVjdFNwcmVhZDIxMih7fSwgREVGQVVMVF9BVVRIX09QVElPTlMkMSksIGF1dGhPcHRpb25zKSwKICAgIHJlYWx0aW1lOiBfb2JqZWN0U3ByZWFkMjEyKF9vYmplY3RTcHJlYWQyMTIoe30sIERFRkFVTFRfUkVBTFRJTUVfT1BUSU9OUyQxKSwgcmVhbHRpbWVPcHRpb25zKSwKICAgIHN0b3JhZ2U6IHt9LAogICAgZ2xvYmFsOiBfb2JqZWN0U3ByZWFkMjEyKF9vYmplY3RTcHJlYWQyMTIoX29iamVjdFNwcmVhZDIxMih7fSwgREVGQVVMVF9HTE9CQUxfT1BUSU9OUyQxKSwgZ2xvYmFsT3B0aW9ucyksIHt9LCB7IGhlYWRlcnM6IF9vYmplY3RTcHJlYWQyMTIoX29iamVjdFNwcmVhZDIxMih7fSwgKF9ERUZBVUxUX0dMT0JBTF9PUFRJTyA9IERFRkFVTFRfR0xPQkFMX09QVElPTlMkMSA9PT0gbnVsbCB8fCBERUZBVUxUX0dMT0JBTF9PUFRJT05TJDEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IERFRkFVTFRfR0xPQkFMX09QVElPTlMkMS5oZWFkZXJzKSAhPT0gbnVsbCAmJiBfREVGQVVMVF9HTE9CQUxfT1BUSU8gIT09IHZvaWQgMCA/IF9ERUZBVUxUX0dMT0JBTF9PUFRJTyA6IHt9KSwgKF9nbG9iYWxPcHRpb25zJGhlYWRlciA9IGdsb2JhbE9wdGlvbnMgPT09IG51bGwgfHwgZ2xvYmFsT3B0aW9ucyA9PT0gdm9pZCAwID8gdm9pZCAwIDogZ2xvYmFsT3B0aW9ucy5oZWFkZXJzKSAhPT0gbnVsbCAmJiBfZ2xvYmFsT3B0aW9ucyRoZWFkZXIgIT09IHZvaWQgMCA/IF9nbG9iYWxPcHRpb25zJGhlYWRlciA6IHt9KSB9KSwKICAgIGFjY2Vzc1Rva2VuOiBhc3luYyAoKSA9PiAiIgogIH07CiAgaWYgKG9wdGlvbnMuYWNjZXNzVG9rZW4pIHJlc3VsdC5hY2Nlc3NUb2tlbiA9IG9wdGlvbnMuYWNjZXNzVG9rZW47CiAgZWxzZSBkZWxldGUgcmVzdWx0LmFjY2Vzc1Rva2VuOwogIHJldHVybiByZXN1bHQ7Cn0KZnVuY3Rpb24gdmFsaWRhdGVTdXBhYmFzZVVybChzdXBhYmFzZVVybDIpIHsKICBjb25zdCB0cmltbWVkVXJsID0gc3VwYWJhc2VVcmwyID09PSBudWxsIHx8IHN1cGFiYXNlVXJsMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogc3VwYWJhc2VVcmwyLnRyaW0oKTsKICBpZiAoIXRyaW1tZWRVcmwpIHRocm93IG5ldyBFcnJvcigic3VwYWJhc2VVcmwgaXMgcmVxdWlyZWQuIik7CiAgaWYgKCF0cmltbWVkVXJsLm1hdGNoKC9eaHR0cHM/OlwvXC8vaSkpIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBzdXBhYmFzZVVybDogTXVzdCBiZSBhIHZhbGlkIEhUVFAgb3IgSFRUUFMgVVJMLiIpOwogIHRyeSB7CiAgICByZXR1cm4gbmV3IFVSTChlbnN1cmVUcmFpbGluZ1NsYXNoKHRyaW1tZWRVcmwpKTsKICB9IGNhdGNoIChfdW51c2VkKSB7CiAgICB0aHJvdyBFcnJvcigiSW52YWxpZCBzdXBhYmFzZVVybDogUHJvdmlkZWQgVVJMIGlzIG1hbGZvcm1lZC4iKTsKICB9Cn0KdmFyIFN1cGFiYXNlQXV0aENsaWVudCA9IGNsYXNzIGV4dGVuZHMgQXV0aENsaWVudF9kZWZhdWx0IHsKICBjb25zdHJ1Y3RvcihvcHRpb25zKSB7CiAgICBzdXBlcihvcHRpb25zKTsKICB9Cn07CnZhciBTdXBhYmFzZUNsaWVudCA9IGNsYXNzIHsKICAvKioKICAqIENyZWF0ZSBhIG5ldyBjbGllbnQgZm9yIHVzZSBpbiB0aGUgYnJvd3Nlci4KICAqIEBwYXJhbSBzdXBhYmFzZVVybCBUaGUgdW5pcXVlIFN1cGFiYXNlIFVSTCB3aGljaCBpcyBzdXBwbGllZCB3aGVuIHlvdSBjcmVhdGUgYSBuZXcgcHJvamVjdCBpbiB5b3VyIHByb2plY3QgZGFzaGJvYXJkLgogICogQHBhcmFtIHN1cGFiYXNlS2V5IFRoZSB1bmlxdWUgU3VwYWJhc2UgS2V5IHdoaWNoIGlzIHN1cHBsaWVkIHdoZW4geW91IGNyZWF0ZSBhIG5ldyBwcm9qZWN0IGluIHlvdXIgcHJvamVjdCBkYXNoYm9hcmQuCiAgKiBAcGFyYW0gb3B0aW9ucy5kYi5zY2hlbWEgWW91IGNhbiBzd2l0Y2ggaW4gYmV0d2VlbiBzY2hlbWFzLiBUaGUgc2NoZW1hIG5lZWRzIHRvIGJlIG9uIHRoZSBsaXN0IG9mIGV4cG9zZWQgc2NoZW1hcyBpbnNpZGUgU3VwYWJhc2UuCiAgKiBAcGFyYW0gb3B0aW9ucy5hdXRoLmF1dG9SZWZyZXNoVG9rZW4gU2V0IHRvICJ0cnVlIiBpZiB5b3Ugd2FudCB0byBhdXRvbWF0aWNhbGx5IHJlZnJlc2ggdGhlIHRva2VuIGJlZm9yZSBleHBpcmluZy4KICAqIEBwYXJhbSBvcHRpb25zLmF1dGgucGVyc2lzdFNlc3Npb24gU2V0IHRvICJ0cnVlIiBpZiB5b3Ugd2FudCB0byBhdXRvbWF0aWNhbGx5IHNhdmUgdGhlIHVzZXIgc2Vzc2lvbiBpbnRvIGxvY2FsIHN0b3JhZ2UuCiAgKiBAcGFyYW0gb3B0aW9ucy5hdXRoLmRldGVjdFNlc3Npb25JblVybCBTZXQgdG8gInRydWUiIGlmIHlvdSB3YW50IHRvIGF1dG9tYXRpY2FsbHkgZGV0ZWN0cyBPQXV0aCBncmFudHMgaW4gdGhlIFVSTCBhbmQgc2lnbnMgaW4gdGhlIHVzZXIuCiAgKiBAcGFyYW0gb3B0aW9ucy5yZWFsdGltZSBPcHRpb25zIHBhc3NlZCBhbG9uZyB0byByZWFsdGltZS1qcyBjb25zdHJ1Y3Rvci4KICAqIEBwYXJhbSBvcHRpb25zLnN0b3JhZ2UgT3B0aW9ucyBwYXNzZWQgYWxvbmcgdG8gdGhlIHN0b3JhZ2UtanMgY29uc3RydWN0b3IuCiAgKiBAcGFyYW0gb3B0aW9ucy5nbG9iYWwuZmV0Y2ggQSBjdXN0b20gZmV0Y2ggaW1wbGVtZW50YXRpb24uCiAgKiBAcGFyYW0gb3B0aW9ucy5nbG9iYWwuaGVhZGVycyBBbnkgYWRkaXRpb25hbCBoZWFkZXJzIHRvIHNlbmQgd2l0aCBlYWNoIG5ldHdvcmsgcmVxdWVzdC4KICAqIEBleGFtcGxlCiAgKiBgYGB0cwogICogaW1wb3J0IHsgY3JlYXRlQ2xpZW50IH0gZnJvbSAnQHN1cGFiYXNlL3N1cGFiYXNlLWpzJwogICoKICAqIGNvbnN0IHN1cGFiYXNlID0gY3JlYXRlQ2xpZW50KCdodHRwczovL3h5emNvbXBhbnkuc3VwYWJhc2UuY28nLCAncHVibGljLWFub24ta2V5JykKICAqIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgc3VwYWJhc2UuZnJvbSgncHJvZmlsZXMnKS5zZWxlY3QoJyonKQogICogYGBgCiAgKi8KICBjb25zdHJ1Y3RvcihzdXBhYmFzZVVybDIsIHN1cGFiYXNlS2V5LCBvcHRpb25zKSB7CiAgICB2YXIgX3NldHRpbmdzJGF1dGgkc3RvcmFnLCBfc2V0dGluZ3MkZ2xvYmFsJGhlYWQ7CiAgICB0aGlzLnN1cGFiYXNlVXJsID0gc3VwYWJhc2VVcmwyOwogICAgdGhpcy5zdXBhYmFzZUtleSA9IHN1cGFiYXNlS2V5OwogICAgY29uc3QgYmFzZVVybCA9IHZhbGlkYXRlU3VwYWJhc2VVcmwoc3VwYWJhc2VVcmwyKTsKICAgIGlmICghc3VwYWJhc2VLZXkpIHRocm93IG5ldyBFcnJvcigic3VwYWJhc2VLZXkgaXMgcmVxdWlyZWQuIik7CiAgICB0aGlzLnJlYWx0aW1lVXJsID0gbmV3IFVSTCgicmVhbHRpbWUvdjEiLCBiYXNlVXJsKTsKICAgIHRoaXMucmVhbHRpbWVVcmwucHJvdG9jb2wgPSB0aGlzLnJlYWx0aW1lVXJsLnByb3RvY29sLnJlcGxhY2UoImh0dHAiLCAid3MiKTsKICAgIHRoaXMuYXV0aFVybCA9IG5ldyBVUkwoImF1dGgvdjEiLCBiYXNlVXJsKTsKICAgIHRoaXMuc3RvcmFnZVVybCA9IG5ldyBVUkwoInN0b3JhZ2UvdjEiLCBiYXNlVXJsKTsKICAgIHRoaXMuZnVuY3Rpb25zVXJsID0gbmV3IFVSTCgiZnVuY3Rpb25zL3YxIiwgYmFzZVVybCk7CiAgICBjb25zdCBkZWZhdWx0U3RvcmFnZUtleSA9IGBzYi0ke2Jhc2VVcmwuaG9zdG5hbWUuc3BsaXQoIi4iKVswXX0tYXV0aC10b2tlbmA7CiAgICBjb25zdCBERUZBVUxUUyA9IHsKICAgICAgZGI6IERFRkFVTFRfREJfT1BUSU9OUywKICAgICAgcmVhbHRpbWU6IERFRkFVTFRfUkVBTFRJTUVfT1BUSU9OUywKICAgICAgYXV0aDogX29iamVjdFNwcmVhZDIxMihfb2JqZWN0U3ByZWFkMjEyKHt9LCBERUZBVUxUX0FVVEhfT1BUSU9OUyksIHt9LCB7IHN0b3JhZ2VLZXk6IGRlZmF1bHRTdG9yYWdlS2V5IH0pLAogICAgICBnbG9iYWw6IERFRkFVTFRfR0xPQkFMX09QVElPTlMKICAgIH07CiAgICBjb25zdCBzZXR0aW5ncyA9IGFwcGx5U2V0dGluZ0RlZmF1bHRzKG9wdGlvbnMgIT09IG51bGwgJiYgb3B0aW9ucyAhPT0gdm9pZCAwID8gb3B0aW9ucyA6IHt9LCBERUZBVUxUUyk7CiAgICB0aGlzLnN0b3JhZ2VLZXkgPSAoX3NldHRpbmdzJGF1dGgkc3RvcmFnID0gc2V0dGluZ3MuYXV0aC5zdG9yYWdlS2V5KSAhPT0gbnVsbCAmJiBfc2V0dGluZ3MkYXV0aCRzdG9yYWcgIT09IHZvaWQgMCA/IF9zZXR0aW5ncyRhdXRoJHN0b3JhZyA6ICIiOwogICAgdGhpcy5oZWFkZXJzID0gKF9zZXR0aW5ncyRnbG9iYWwkaGVhZCA9IHNldHRpbmdzLmdsb2JhbC5oZWFkZXJzKSAhPT0gbnVsbCAmJiBfc2V0dGluZ3MkZ2xvYmFsJGhlYWQgIT09IHZvaWQgMCA/IF9zZXR0aW5ncyRnbG9iYWwkaGVhZCA6IHt9OwogICAgaWYgKCFzZXR0aW5ncy5hY2Nlc3NUb2tlbikgewogICAgICB2YXIgX3NldHRpbmdzJGF1dGg7CiAgICAgIHRoaXMuYXV0aCA9IHRoaXMuX2luaXRTdXBhYmFzZUF1dGhDbGllbnQoKF9zZXR0aW5ncyRhdXRoID0gc2V0dGluZ3MuYXV0aCkgIT09IG51bGwgJiYgX3NldHRpbmdzJGF1dGggIT09IHZvaWQgMCA/IF9zZXR0aW5ncyRhdXRoIDoge30sIHRoaXMuaGVhZGVycywgc2V0dGluZ3MuZ2xvYmFsLmZldGNoKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMuYWNjZXNzVG9rZW4gPSBzZXR0aW5ncy5hY2Nlc3NUb2tlbjsKICAgICAgdGhpcy5hdXRoID0gbmV3IFByb3h5KHt9LCB7IGdldDogKF8sIHByb3ApID0+IHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEBzdXBhYmFzZS9zdXBhYmFzZS1qczogU3VwYWJhc2UgQ2xpZW50IGlzIGNvbmZpZ3VyZWQgd2l0aCB0aGUgYWNjZXNzVG9rZW4gb3B0aW9uLCBhY2Nlc3Npbmcgc3VwYWJhc2UuYXV0aC4ke1N0cmluZyhwcm9wKX0gaXMgbm90IHBvc3NpYmxlYCk7CiAgICAgIH0gfSk7CiAgICB9CiAgICB0aGlzLmZldGNoID0gZmV0Y2hXaXRoQXV0aChzdXBhYmFzZUtleSwgdGhpcy5fZ2V0QWNjZXNzVG9rZW4uYmluZCh0aGlzKSwgc2V0dGluZ3MuZ2xvYmFsLmZldGNoKTsKICAgIHRoaXMucmVhbHRpbWUgPSB0aGlzLl9pbml0UmVhbHRpbWVDbGllbnQoX29iamVjdFNwcmVhZDIxMih7CiAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVycywKICAgICAgYWNjZXNzVG9rZW46IHRoaXMuX2dldEFjY2Vzc1Rva2VuLmJpbmQodGhpcykKICAgIH0sIHNldHRpbmdzLnJlYWx0aW1lKSk7CiAgICBpZiAodGhpcy5hY2Nlc3NUb2tlbikgUHJvbWlzZS5yZXNvbHZlKHRoaXMuYWNjZXNzVG9rZW4oKSkudGhlbigodG9rZW4pID0+IHRoaXMucmVhbHRpbWUuc2V0QXV0aCh0b2tlbikpLmNhdGNoKChlKSA9PiBjb25zb2xlLndhcm4oIkZhaWxlZCB0byBzZXQgaW5pdGlhbCBSZWFsdGltZSBhdXRoIHRva2VuOiIsIGUpKTsKICAgIHRoaXMucmVzdCA9IG5ldyBQb3N0Z3Jlc3RDbGllbnQobmV3IFVSTCgicmVzdC92MSIsIGJhc2VVcmwpLmhyZWYsIHsKICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJzLAogICAgICBzY2hlbWE6IHNldHRpbmdzLmRiLnNjaGVtYSwKICAgICAgZmV0Y2g6IHRoaXMuZmV0Y2gsCiAgICAgIHRpbWVvdXQ6IHNldHRpbmdzLmRiLnRpbWVvdXQsCiAgICAgIHVybExlbmd0aExpbWl0OiBzZXR0aW5ncy5kYi51cmxMZW5ndGhMaW1pdAogICAgfSk7CiAgICB0aGlzLnN0b3JhZ2UgPSBuZXcgU3RvcmFnZUNsaWVudCh0aGlzLnN0b3JhZ2VVcmwuaHJlZiwgdGhpcy5oZWFkZXJzLCB0aGlzLmZldGNoLCBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMuc3RvcmFnZSk7CiAgICBpZiAoIXNldHRpbmdzLmFjY2Vzc1Rva2VuKSB0aGlzLl9saXN0ZW5Gb3JBdXRoRXZlbnRzKCk7CiAgfQogIC8qKgogICogU3VwYWJhc2UgRnVuY3Rpb25zIGFsbG93cyB5b3UgdG8gZGVwbG95IGFuZCBpbnZva2UgZWRnZSBmdW5jdGlvbnMuCiAgKi8KICBnZXQgZnVuY3Rpb25zKCkgewogICAgcmV0dXJuIG5ldyBGdW5jdGlvbnNDbGllbnQodGhpcy5mdW5jdGlvbnNVcmwuaHJlZiwgewogICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsCiAgICAgIGN1c3RvbUZldGNoOiB0aGlzLmZldGNoCiAgICB9KTsKICB9CiAgLyoqCiAgKiBQZXJmb3JtIGEgcXVlcnkgb24gYSB0YWJsZSBvciBhIHZpZXcuCiAgKgogICogQHBhcmFtIHJlbGF0aW9uIC0gVGhlIHRhYmxlIG9yIHZpZXcgbmFtZSB0byBxdWVyeQogICovCiAgZnJvbShyZWxhdGlvbikgewogICAgcmV0dXJuIHRoaXMucmVzdC5mcm9tKHJlbGF0aW9uKTsKICB9CiAgLyoqCiAgKiBTZWxlY3QgYSBzY2hlbWEgdG8gcXVlcnkgb3IgcGVyZm9ybSBhbiBmdW5jdGlvbiAocnBjKSBjYWxsLgogICoKICAqIFRoZSBzY2hlbWEgbmVlZHMgdG8gYmUgb24gdGhlIGxpc3Qgb2YgZXhwb3NlZCBzY2hlbWFzIGluc2lkZSBTdXBhYmFzZS4KICAqCiAgKiBAcGFyYW0gc2NoZW1hIC0gVGhlIHNjaGVtYSB0byBxdWVyeQogICovCiAgc2NoZW1hKHNjaGVtYSkgewogICAgcmV0dXJuIHRoaXMucmVzdC5zY2hlbWEoc2NoZW1hKTsKICB9CiAgLyoqCiAgKiBQZXJmb3JtIGEgZnVuY3Rpb24gY2FsbC4KICAqCiAgKiBAcGFyYW0gZm4gLSBUaGUgZnVuY3Rpb24gbmFtZSB0byBjYWxsCiAgKiBAcGFyYW0gYXJncyAtIFRoZSBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUgZnVuY3Rpb24gY2FsbAogICogQHBhcmFtIG9wdGlvbnMgLSBOYW1lZCBwYXJhbWV0ZXJzCiAgKiBAcGFyYW0gb3B0aW9ucy5oZWFkIC0gV2hlbiBzZXQgdG8gYHRydWVgLCBgZGF0YWAgd2lsbCBub3QgYmUgcmV0dXJuZWQuCiAgKiBVc2VmdWwgaWYgeW91IG9ubHkgbmVlZCB0aGUgY291bnQuCiAgKiBAcGFyYW0gb3B0aW9ucy5nZXQgLSBXaGVuIHNldCB0byBgdHJ1ZWAsIHRoZSBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCB3aXRoCiAgKiByZWFkLW9ubHkgYWNjZXNzIG1vZGUuCiAgKiBAcGFyYW0gb3B0aW9ucy5jb3VudCAtIENvdW50IGFsZ29yaXRobSB0byB1c2UgdG8gY291bnQgcm93cyByZXR1cm5lZCBieSB0aGUKICAqIGZ1bmN0aW9uLiBPbmx5IGFwcGxpY2FibGUgZm9yIFtzZXQtcmV0dXJuaW5nCiAgKiBmdW5jdGlvbnNdKGh0dHBzOi8vd3d3LnBvc3RncmVzcWwub3JnL2RvY3MvY3VycmVudC9mdW5jdGlvbnMtc3JmLmh0bWwpLgogICoKICAqIGAiZXhhY3QiYDogRXhhY3QgYnV0IHNsb3cgY291bnQgYWxnb3JpdGhtLiBQZXJmb3JtcyBhIGBDT1VOVCgqKWAgdW5kZXIgdGhlCiAgKiBob29kLgogICoKICAqIGAicGxhbm5lZCJgOiBBcHByb3hpbWF0ZWQgYnV0IGZhc3QgY291bnQgYWxnb3JpdGhtLiBVc2VzIHRoZSBQb3N0Z3JlcwogICogc3RhdGlzdGljcyB1bmRlciB0aGUgaG9vZC4KICAqCiAgKiBgImVzdGltYXRlZCJgOiBVc2VzIGV4YWN0IGNvdW50IGZvciBsb3cgbnVtYmVycyBhbmQgcGxhbm5lZCBjb3VudCBmb3IgaGlnaAogICogbnVtYmVycy4KICAqLwogIHJwYyhmbiwgYXJncyA9IHt9LCBvcHRpb25zID0gewogICAgaGVhZDogZmFsc2UsCiAgICBnZXQ6IGZhbHNlLAogICAgY291bnQ6IHZvaWQgMAogIH0pIHsKICAgIHJldHVybiB0aGlzLnJlc3QucnBjKGZuLCBhcmdzLCBvcHRpb25zKTsKICB9CiAgLyoqCiAgKiBDcmVhdGVzIGEgUmVhbHRpbWUgY2hhbm5lbCB3aXRoIEJyb2FkY2FzdCwgUHJlc2VuY2UsIGFuZCBQb3N0Z3JlcyBDaGFuZ2VzLgogICoKICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIFJlYWx0aW1lIGNoYW5uZWwuCiAgKiBAcGFyYW0ge09iamVjdH0gb3B0cyAtIFRoZSBvcHRpb25zIHRvIHBhc3MgdG8gdGhlIFJlYWx0aW1lIGNoYW5uZWwuCiAgKgogICovCiAgY2hhbm5lbChuYW1lLCBvcHRzID0geyBjb25maWc6IHt9IH0pIHsKICAgIHJldHVybiB0aGlzLnJlYWx0aW1lLmNoYW5uZWwobmFtZSwgb3B0cyk7CiAgfQogIC8qKgogICogUmV0dXJucyBhbGwgUmVhbHRpbWUgY2hhbm5lbHMuCiAgKi8KICBnZXRDaGFubmVscygpIHsKICAgIHJldHVybiB0aGlzLnJlYWx0aW1lLmdldENoYW5uZWxzKCk7CiAgfQogIC8qKgogICogVW5zdWJzY3JpYmVzIGFuZCByZW1vdmVzIFJlYWx0aW1lIGNoYW5uZWwgZnJvbSBSZWFsdGltZSBjbGllbnQuCiAgKgogICogQHBhcmFtIHtSZWFsdGltZUNoYW5uZWx9IGNoYW5uZWwgLSBUaGUgbmFtZSBvZiB0aGUgUmVhbHRpbWUgY2hhbm5lbC4KICAqCiAgKi8KICByZW1vdmVDaGFubmVsKGNoYW5uZWwpIHsKICAgIHJldHVybiB0aGlzLnJlYWx0aW1lLnJlbW92ZUNoYW5uZWwoY2hhbm5lbCk7CiAgfQogIC8qKgogICogVW5zdWJzY3JpYmVzIGFuZCByZW1vdmVzIGFsbCBSZWFsdGltZSBjaGFubmVscyBmcm9tIFJlYWx0aW1lIGNsaWVudC4KICAqLwogIHJlbW92ZUFsbENoYW5uZWxzKCkgewogICAgcmV0dXJuIHRoaXMucmVhbHRpbWUucmVtb3ZlQWxsQ2hhbm5lbHMoKTsKICB9CiAgYXN5bmMgX2dldEFjY2Vzc1Rva2VuKCkgewogICAgdmFyIF90aGlzID0gdGhpczsKICAgIHZhciBfZGF0YSRzZXNzaW9uJGFjY2Vzc18sIF9kYXRhJHNlc3Npb247CiAgICBpZiAoX3RoaXMuYWNjZXNzVG9rZW4pIHJldHVybiBhd2FpdCBfdGhpcy5hY2Nlc3NUb2tlbigpOwogICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCBfdGhpcy5hdXRoLmdldFNlc3Npb24oKTsKICAgIHJldHVybiAoX2RhdGEkc2Vzc2lvbiRhY2Nlc3NfID0gKF9kYXRhJHNlc3Npb24gPSBkYXRhLnNlc3Npb24pID09PSBudWxsIHx8IF9kYXRhJHNlc3Npb24gPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9kYXRhJHNlc3Npb24uYWNjZXNzX3Rva2VuKSAhPT0gbnVsbCAmJiBfZGF0YSRzZXNzaW9uJGFjY2Vzc18gIT09IHZvaWQgMCA/IF9kYXRhJHNlc3Npb24kYWNjZXNzXyA6IF90aGlzLnN1cGFiYXNlS2V5OwogIH0KICBfaW5pdFN1cGFiYXNlQXV0aENsaWVudCh7IGF1dG9SZWZyZXNoVG9rZW4sIHBlcnNpc3RTZXNzaW9uLCBkZXRlY3RTZXNzaW9uSW5VcmwsIHN0b3JhZ2UsIHVzZXJTdG9yYWdlLCBzdG9yYWdlS2V5LCBmbG93VHlwZSwgbG9jaywgZGVidWcsIHRocm93T25FcnJvciB9LCBoZWFkZXJzLCBmZXRjaCQxKSB7CiAgICBjb25zdCBhdXRoSGVhZGVycyA9IHsKICAgICAgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3RoaXMuc3VwYWJhc2VLZXl9YCwKICAgICAgYXBpa2V5OiBgJHt0aGlzLnN1cGFiYXNlS2V5fWAKICAgIH07CiAgICByZXR1cm4gbmV3IFN1cGFiYXNlQXV0aENsaWVudCh7CiAgICAgIHVybDogdGhpcy5hdXRoVXJsLmhyZWYsCiAgICAgIGhlYWRlcnM6IF9vYmplY3RTcHJlYWQyMTIoX29iamVjdFNwcmVhZDIxMih7fSwgYXV0aEhlYWRlcnMpLCBoZWFkZXJzKSwKICAgICAgc3RvcmFnZUtleSwKICAgICAgYXV0b1JlZnJlc2hUb2tlbiwKICAgICAgcGVyc2lzdFNlc3Npb24sCiAgICAgIGRldGVjdFNlc3Npb25JblVybCwKICAgICAgc3RvcmFnZSwKICAgICAgdXNlclN0b3JhZ2UsCiAgICAgIGZsb3dUeXBlLAogICAgICBsb2NrLAogICAgICBkZWJ1ZywKICAgICAgdGhyb3dPbkVycm9yLAogICAgICBmZXRjaDogZmV0Y2gkMSwKICAgICAgaGFzQ3VzdG9tQXV0aG9yaXphdGlvbkhlYWRlcjogT2JqZWN0LmtleXModGhpcy5oZWFkZXJzKS5zb21lKChrZXkpID0+IGtleS50b0xvd2VyQ2FzZSgpID09PSAiYXV0aG9yaXphdGlvbiIpCiAgICB9KTsKICB9CiAgX2luaXRSZWFsdGltZUNsaWVudChvcHRpb25zKSB7CiAgICByZXR1cm4gbmV3IFJlYWx0aW1lQ2xpZW50KHRoaXMucmVhbHRpbWVVcmwuaHJlZiwgX29iamVjdFNwcmVhZDIxMihfb2JqZWN0U3ByZWFkMjEyKHt9LCBvcHRpb25zKSwge30sIHsgcGFyYW1zOiBfb2JqZWN0U3ByZWFkMjEyKF9vYmplY3RTcHJlYWQyMTIoe30sIHsgYXBpa2V5OiB0aGlzLnN1cGFiYXNlS2V5IH0pLCBvcHRpb25zID09PSBudWxsIHx8IG9wdGlvbnMgPT09IHZvaWQgMCA/IHZvaWQgMCA6IG9wdGlvbnMucGFyYW1zKSB9KSk7CiAgfQogIF9saXN0ZW5Gb3JBdXRoRXZlbnRzKCkgewogICAgcmV0dXJuIHRoaXMuYXV0aC5vbkF1dGhTdGF0ZUNoYW5nZSgoZXZlbnQsIHNlc3Npb24pID0+IHsKICAgICAgdGhpcy5faGFuZGxlVG9rZW5DaGFuZ2VkKGV2ZW50LCAiQ0xJRU5UIiwgc2Vzc2lvbiA9PT0gbnVsbCB8fCBzZXNzaW9uID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzZXNzaW9uLmFjY2Vzc190b2tlbik7CiAgICB9KTsKICB9CiAgX2hhbmRsZVRva2VuQ2hhbmdlZChldmVudCwgc291cmNlLCB0b2tlbikgewogICAgaWYgKChldmVudCA9PT0gIlRPS0VOX1JFRlJFU0hFRCIgfHwgZXZlbnQgPT09ICJTSUdORURfSU4iKSAmJiB0aGlzLmNoYW5nZWRBY2Nlc3NUb2tlbiAhPT0gdG9rZW4pIHsKICAgICAgdGhpcy5jaGFuZ2VkQWNjZXNzVG9rZW4gPSB0b2tlbjsKICAgICAgdGhpcy5yZWFsdGltZS5zZXRBdXRoKHRva2VuKTsKICAgIH0gZWxzZSBpZiAoZXZlbnQgPT09ICJTSUdORURfT1VUIikgewogICAgICB0aGlzLnJlYWx0aW1lLnNldEF1dGgoKTsKICAgICAgaWYgKHNvdXJjZSA9PSAiU1RPUkFHRSIpIHRoaXMuYXV0aC5zaWduT3V0KCk7CiAgICAgIHRoaXMuY2hhbmdlZEFjY2Vzc1Rva2VuID0gdm9pZCAwOwogICAgfQogIH0KfTsKdmFyIGNyZWF0ZUNsaWVudCA9IChzdXBhYmFzZVVybDIsIHN1cGFiYXNlS2V5LCBvcHRpb25zKSA9PiB7CiAgcmV0dXJuIG5ldyBTdXBhYmFzZUNsaWVudChzdXBhYmFzZVVybDIsIHN1cGFiYXNlS2V5LCBvcHRpb25zKTsKfTsKZnVuY3Rpb24gc2hvdWxkU2hvd0RlcHJlY2F0aW9uV2FybmluZygpIHsKICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIpIHJldHVybiBmYWxzZTsKICBjb25zdCBfcHJvY2VzcyA9IGdsb2JhbFRoaXNbInByb2Nlc3MiXTsKICBpZiAoIV9wcm9jZXNzKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgcHJvY2Vzc1ZlcnNpb24gPSBfcHJvY2Vzc1sidmVyc2lvbiJdOwogIGlmIChwcm9jZXNzVmVyc2lvbiA9PT0gdm9pZCAwIHx8IHByb2Nlc3NWZXJzaW9uID09PSBudWxsKSByZXR1cm4gZmFsc2U7CiAgY29uc3QgdmVyc2lvbk1hdGNoID0gcHJvY2Vzc1ZlcnNpb24ubWF0Y2goL152KFxkKylcLi8pOwogIGlmICghdmVyc2lvbk1hdGNoKSByZXR1cm4gZmFsc2U7CiAgcmV0dXJuIHBhcnNlSW50KHZlcnNpb25NYXRjaFsxXSwgMTApIDw9IDE4Owp9CmlmIChzaG91bGRTaG93RGVwcmVjYXRpb25XYXJuaW5nKCkpIGNvbnNvbGUud2FybigiXHUyNkEwXHVGRTBGICBOb2RlLmpzIDE4IGFuZCBiZWxvdyBhcmUgZGVwcmVjYXRlZCBhbmQgd2lsbCBubyBsb25nZXIgYmUgc3VwcG9ydGVkIGluIGZ1dHVyZSB2ZXJzaW9ucyBvZiBAc3VwYWJhc2Uvc3VwYWJhc2UtanMuIFBsZWFzZSB1cGdyYWRlIHRvIE5vZGUuanMgMjAgb3IgbGF0ZXIuIEZvciBtb3JlIGluZm9ybWF0aW9uLCB2aXNpdDogaHR0cHM6Ly9naXRodWIuY29tL29yZ3Mvc3VwYWJhc2UvZGlzY3Vzc2lvbnMvMzcyMTciKTsKCi8vIHNyYy9zdXBhYmFzZS50cwp2YXIgc3VwYWJhc2VVcmwgPSB3aW5kb3cuU1VQQUJBU0VfRU5WPy51cmwgfHwgaW1wb3J0Lm1ldGEuZW52Py5WSVRFX1NVUEFCQVNFX1VSTCB8fCAiIjsKdmFyIHN1cGFiYXNlQW5vbktleSA9IHdpbmRvdy5TVVBBQkFTRV9FTlY/LmFub25LZXkgfHwgaW1wb3J0Lm1ldGEuZW52Py5WSVRFX1NVUEFCQVNFX0FOT05fS0VZIHx8ICIiOwp2YXIgc3VwYWJhc2UgPSBzdXBhYmFzZVVybCAmJiBzdXBhYmFzZUFub25LZXkgPyBjcmVhdGVDbGllbnQoc3VwYWJhc2VVcmwsIHN1cGFiYXNlQW5vbktleSkgOiBudWxsOwoKLy8gc3JjL2NvbXBvbmVudHMvTG9naW5Nb2RhbC50c3gKdmFyIGltcG9ydF9yZWFjdDUxID0gX190b0VTTShyZXF1aXJlX3JlYWN0KCksIDEpOwp2YXIgaW1wb3J0X2pzeF9ydW50aW1lID0gX190b0VTTShyZXF1aXJlX2pzeF9ydW50aW1lKCksIDEpOwp2YXIgQ09MT1JTID0gewogIHByaW1hcnk6ICIjMUI0MzMyIiwKICBwcmltYXJ5RGFyazogIiMwRjJCMUYiLAogIHByaW1hcnlMaWdodDogIiMyRDZBNEYiLAogIGFjY2VudDogIiM0MDkxNkMiLAogIGFjY2VudExpZ2h0OiAiI0U4RjVFOSIsCiAgYmc6ICIjRjVGNUYwIiwKICBjYXJkOiAiI0ZGRkZGRiIsCiAgYm9yZGVyOiAiI0U1RTdFQiIsCiAgYm9yZGVyTGlnaHQ6ICIjRjBGMEYwIiwKICB0ZXh0TWFpbjogIiMxQTFBMUEiLAogIHRleHRTZWNvbmRhcnk6ICIjNkI3MjgwIiwKICB0ZXh0TXV0ZWQ6ICIjOUNBM0FGIiwKICBlcnJvcjogIiNEQzI2MjYiLAogIGVycm9yQmc6ICIjRkVGMkYyIiwKICBzdWNjZXNzOiAiIzA1OTY2OSIsCiAgc3VjY2Vzc0JnOiAiI0VDRkRGNSIKfTsKdmFyIGlucHV0U3R5bGUgPSAoZm9jdXNlZCkgPT4gKHsKICB3aWR0aDogIjEwMCUiLAogIHBhZGRpbmc6ICIxNnB4IDE2cHggMTZweCA0OHB4IiwKICBiYWNrZ3JvdW5kQ29sb3I6IGZvY3VzZWQgPyAiI0ZGRkZGRiIgOiAiI0Y5RkFGQiIsCiAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Zm9jdXNlZCA/IENPTE9SUy5wcmltYXJ5IDogQ09MT1JTLmJvcmRlcn1gLAogIGJvcmRlclJhZGl1czogMTYsCiAgZm9udFNpemU6IDE1LAogIGNvbG9yOiBDT0xPUlMudGV4dE1haW4sCiAgb3V0bGluZTogIm5vbmUiLAogIHRyYW5zaXRpb246ICJhbGwgMC4ycyIsCiAgYm94U2l6aW5nOiAiYm9yZGVyLWJveCIsCiAgYm94U2hhZG93OiBmb2N1c2VkID8gYDAgMCAwIDRweCAke0NPTE9SUy5hY2NlbnRMaWdodH1gIDogIm5vbmUiCn0pOwp2YXIgTG9naW5Nb2RhbCA9ICh7IG9uQ2xvc2UsIG9uTG9naW5TdWNjZXNzIH0pID0+IHsKICBjb25zdCBbbW9kZSwgc2V0TW9kZV0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKCJMT0dJTiIpOwogIGNvbnN0IFtlbWFpbCwgc2V0RW1haWxdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKSgiIik7CiAgY29uc3QgW3Bhc3N3b3JkLCBzZXRQYXNzd29yZF0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKCIiKTsKICBjb25zdCBbY29uZmlybVBhc3N3b3JkLCBzZXRDb25maXJtUGFzc3dvcmRdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKSgiIik7CiAgY29uc3QgW2xvYWRpbmcsIHNldExvYWRpbmddID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW2Vycm9yLCBzZXRFcnJvcl0gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKCIiKTsKICBjb25zdCBbc3VjY2Vzcywgc2V0U3VjY2Vzc10gPSAoMCwgaW1wb3J0X3JlYWN0NTEudXNlU3RhdGUpKCIiKTsKICBjb25zdCBbZW1haWxGb2N1c2VkLCBzZXRFbWFpbEZvY3VzZWRdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW3Bhc3N3b3JkRm9jdXNlZCwgc2V0UGFzc3dvcmRGb2N1c2VkXSA9ICgwLCBpbXBvcnRfcmVhY3Q1MS51c2VTdGF0ZSkoZmFsc2UpOwogIGNvbnN0IFtjb25maXJtRm9jdXNlZCwgc2V0Q29uZmlybUZvY3VzZWRdID0gKDAsIGltcG9ydF9yZWFjdDUxLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgaGFuZGxlTG9naW4gPSBhc3luYyAoZSkgPT4gewogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgc2V0RXJyb3IoIiIpOwogICAgc2V0U3VjY2VzcygiIik7CiAgICBpZiAoIXN1cGFiYXNlKSB7CiAgICAgIHNldEVycm9yKCJDbG91ZCBzeW5jIGlzIGN1cnJlbnRseSB1bmF2YWlsYWJsZS4gUGxlYXNlIHRyeSBhZ2FpbiBsYXRlci4iKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgc2V0TG9hZGluZyh0cnVlKTsKICAgIGNvbnN0IHsgZXJyb3I6IGVycm9yMiB9ID0gYXdhaXQgc3VwYWJhc2UuYXV0aC5zaWduSW5XaXRoUGFzc3dvcmQoeyBlbWFpbCwgcGFzc3dvcmQgfSk7CiAgICBzZXRMb2FkaW5nKGZhbHNlKTsKICAgIGlmIChlcnJvcjIpIHsKICAgICAgY29uc29sZS5lcnJvcigiTG9naW4gZXJyb3I6IiwgZXJyb3IyKTsKICAgICAgaWYgKGVycm9yMi5tZXNzYWdlPy50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCJpbnZhbGlkIGxvZ2luIGNyZWRlbnRpYWxzIikpIHsKICAgICAgICBzZXRFcnJvcigiSW52YWxpZCBlbWFpbCBvciBwYXNzd29yZC4gUGxlYXNlIHRyeSBhZ2Fpbi4iKTsKICAgICAgfSBlbHNlIGlmIChlcnJvcjIubWVzc2FnZT8udG9Mb3dlckNhc2UoKS5pbmNsdWRlcygiZW1haWwgbm90IGNvbmZpcm1lZCIpKSB7CiAgICAgICAgc2V0RXJyb3IoIlBsZWFzZSBjaGVjayB5b3VyIGluYm94IGFuZCBjb25maXJtIHlvdXIgZW1haWwgYmVmb3JlIGxvZ2dpbmcgaW4uIik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0RXJyb3IoZXJyb3IyLm1lc3NhZ2UgfHwgIkxvZ2luIGZhaWxlZC4gUGxlYXNlIHRyeSBhZ2Fpbi4iKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgb25Mb2dpblN1Y2Nlc3MoKTsKICAgIH0KICB9OwogIGNvbnN0IGhhbmRsZVNpZ25VcCA9IGFzeW5jIChlKSA9PiB7CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICBzZXRFcnJvcigiIik7CiAgICBzZXRTdWNjZXNzKCIiKTsKICAgIGlmICghc3VwYWJhc2UpIHsKICAgICAgc2V0RXJyb3IoIkNsb3VkIHN5bmMgaXMgY3VycmVudGx5IHVuYXZhaWxhYmxlLiBQbGVhc2UgdHJ5IGFnYWluIGxhdGVyLiIpOwogICAgICByZXR1cm47CiAgICB9CiAgICBpZiAocGFzc3dvcmQubGVuZ3RoIDwgNikgewogICAgICBzZXRFcnJvcigiUGFzc3dvcmQgbXVzdCBiZSBhdCBsZWFzdCA2IGNoYXJhY3RlcnMgbG9uZy4iKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgaWYgKHBhc3N3b3JkICE9PSBjb25maXJtUGFzc3dvcmQpIHsKICAgICAgc2V0RXJyb3IoIlBhc3N3b3JkcyBkbyBub3QgbWF0Y2guIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHNldExvYWRpbmcodHJ1ZSk7CiAgICBjb25zdCB7IGRhdGEsIGVycm9yOiBlcnJvcjIgfSA9IGF3YWl0IHN1cGFiYXNlLmF1dGguc2lnblVwKHsgZW1haWwsIHBhc3N3b3JkIH0pOwogICAgc2V0TG9hZGluZyhmYWxzZSk7CiAgICBpZiAoZXJyb3IyKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIlNpZ24gdXAgZXJyb3I6IiwgZXJyb3IyKTsKICAgICAgaWYgKGVycm9yMi5tZXNzYWdlPy50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCJhbHJlYWR5IHJlZ2lzdGVyZWQiKSkgewogICAgICAgIHNldEVycm9yKCJBbiBhY2NvdW50IHdpdGggdGhpcyBlbWFpbCBhbHJlYWR5IGV4aXN0cy4gVHJ5IGxvZ2dpbmcgaW4gaW5zdGVhZC4iKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzZXRFcnJvcihlcnJvcjIubWVzc2FnZSB8fCAiU2lnbiB1cCBmYWlsZWQuIFBsZWFzZSB0cnkgYWdhaW4uIik7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZGF0YS5zZXNzaW9uKSB7CiAgICAgIG9uTG9naW5TdWNjZXNzKCk7CiAgICB9IGVsc2UgewogICAgICBzZXRTdWNjZXNzKCJBY2NvdW50IGNyZWF0ZWQhIFBsZWFzZSBjaGVjayB5b3VyIGVtYWlsIHRvIGNvbmZpcm0geW91ciBhY2NvdW50LCB0aGVuIGxvZyBpbi4iKTsKICAgICAgc2V0TW9kZSgiTE9HSU4iKTsKICAgICAgc2V0UGFzc3dvcmQoIiIpOwogICAgICBzZXRDb25maXJtUGFzc3dvcmQoIiIpOwogICAgfQogIH07CiAgY29uc3Qgc3dpdGNoTW9kZSA9ICgpID0+IHsKICAgIHNldE1vZGUobW9kZSA9PT0gIkxPR0lOIiA/ICJTSUdOVVAiIDogIkxPR0lOIik7CiAgICBzZXRFcnJvcigiIik7CiAgICBzZXRTdWNjZXNzKCIiKTsKICAgIHNldFBhc3N3b3JkKCIiKTsKICAgIHNldENvbmZpcm1QYXNzd29yZCgiIik7CiAgfTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgIHBvc2l0aW9uOiAiZml4ZWQiLAogICAgaW5zZXQ6IDAsCiAgICBiYWNrZ3JvdW5kQ29sb3I6ICJyZ2JhKDAsMCwwLDAuNCkiLAogICAgYmFja2Ryb3BGaWx0ZXI6ICJibHVyKDRweCkiLAogICAgekluZGV4OiA5OTk5LAogICAgZGlzcGxheTogImZsZXgiLAogICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICBwYWRkaW5nOiAyMAogIH0sIGNoaWxkcmVuOiBbCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5jYXJkLAogICAgICBib3JkZXJSYWRpdXM6IDI0LAogICAgICBib3hTaGFkb3c6ICIwIDI1cHggNTBweCAtMTJweCByZ2JhKDAsIDAsIDAsIDAuMjUpIiwKICAgICAgd2lkdGg6ICIxMDAlIiwKICAgICAgbWF4V2lkdGg6IDQ0MCwKICAgICAgb3ZlcmZsb3c6ICJoaWRkZW4iLAogICAgICBhbmltYXRpb246ICJmYWRlSW4gMC4ycyBlYXNlLW91dCIKICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBhZGRpbmc6ICIyNHB4IDMycHggMjBweCIsIGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgYWxpZ25JdGVtczogImZsZXgtc3RhcnQiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImgyIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMjQsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUy50ZXh0TWFpbiwgbWFyZ2luOiAiMCAwIDhweCAwIiwgbGV0dGVyU3BhY2luZzogIi0wLjAyZW0iIH0sIGNoaWxkcmVuOiBtb2RlID09PSAiTE9HSU4iID8gIkxvZ2luIiA6ICJTaWduIFVwIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInAiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgY29sb3I6IENPTE9SUy50ZXh0U2Vjb25kYXJ5LCBtYXJnaW46IDAsIGxpbmVIZWlnaHQ6IDEuNSB9LCBjaGlsZHJlbjogbW9kZSA9PT0gIkxPR0lOIiA/ICJTaWduIGluIHRvIHN5bmMgeW91ciBidWRnZXQgYWNyb3NzIGRldmljZXMuIiA6ICJDcmVhdGUgYW4gYWNjb3VudCB0byBzYXZlIGFuZCBzeW5jIHlvdXIgYnVkZ2V0LiIgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogb25DbG9zZSwgc3R5bGU6IHsKICAgICAgICAgIGJhY2tncm91bmQ6ICJub25lIiwKICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICBwYWRkaW5nOiA4LAogICAgICAgICAgbWFyZ2luOiAiLThweCAtOHB4IDAgMCIsCiAgICAgICAgICBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgICAgYm9yZGVyUmFkaXVzOiAiNTAlIiwKICAgICAgICAgIHRyYW5zaXRpb246ICJiYWNrZ3JvdW5kLWNvbG9yIDAuMnMiCiAgICAgICAgfSwgb25Nb3VzZUVudGVyOiAoZSkgPT4gZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IENPTE9SUy5iZywgb25Nb3VzZUxlYXZlOiAoZSkgPT4gZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICJ0cmFuc3BhcmVudCIsIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKFgsIHsgc2l6ZTogMjAgfSkgfSkKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogIjAgMzJweCAzMnB4IiB9LCBjaGlsZHJlbjogWwogICAgICAgIGVycm9yICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgICAgICBtYXJnaW5Cb3R0b206IDIwLAogICAgICAgICAgcGFkZGluZzogIjEycHggMTZweCIsCiAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5lcnJvckJnLAogICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMiwKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJmbGV4LXN0YXJ0IiwKICAgICAgICAgIGdhcDogMTIsCiAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuZXJyb3J9MjBgCiAgICAgICAgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoQ2lyY2xlQWxlcnQsIHsgc2l6ZTogMTgsIGNvbG9yOiBDT0xPUlMuZXJyb3IsIHN0eWxlOiB7IG1hcmdpblRvcDogMiwgZmxleFNocmluazogMCB9IH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMuZXJyb3IsIGxpbmVIZWlnaHQ6IDEuNSwgZm9udFdlaWdodDogNTAwIH0sIGNoaWxkcmVuOiBlcnJvciB9KQogICAgICAgIF0gfSksCiAgICAgICAgc3VjY2VzcyAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgICAgICAgbWFyZ2luQm90dG9tOiAyMCwKICAgICAgICAgIHBhZGRpbmc6ICIxMnB4IDE2cHgiLAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMuc3VjY2Vzc0JnLAogICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMiwKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJmbGV4LXN0YXJ0IiwKICAgICAgICAgIGdhcDogMTIsCiAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMuc3VjY2Vzc30yMGAKICAgICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShDaXJjbGVDaGVja0JpZywgeyBzaXplOiAxOCwgY29sb3I6IENPTE9SUy5zdWNjZXNzLCBzdHlsZTogeyBtYXJnaW5Ub3A6IDIsIGZsZXhTaHJpbms6IDAgfSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTLnN1Y2Nlc3MsIGxpbmVIZWlnaHQ6IDEuNSwgZm9udFdlaWdodDogNTAwIH0sIGNoaWxkcmVuOiBzdWNjZXNzIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZm9ybSIsIHsgb25TdWJtaXQ6IG1vZGUgPT09ICJMT0dJTiIgPyBoYW5kbGVMb2dpbiA6IGhhbmRsZVNpZ25VcCwgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBmbGV4RGlyZWN0aW9uOiAiY29sdW1uIiwgZ2FwOiAxNiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcG9zaXRpb246ICJyZWxhdGl2ZSIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShNYWlsLCB7IHNpemU6IDE4LCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgc3R5bGU6IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIGxlZnQ6IDE2LCB0b3A6ICI1MCUiLCB0cmFuc2Zvcm06ICJ0cmFuc2xhdGVZKC01MCUpIiB9IH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdHlwZTogImVtYWlsIiwKICAgICAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IGVtYWlsLAogICAgICAgICAgICAgICAgb25DaGFuZ2U6IChlKSA9PiBzZXRFbWFpbChlLnRhcmdldC52YWx1ZSksCiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcjogInlvdUBlbWFpbC5jb20iLAogICAgICAgICAgICAgICAgc3R5bGU6IGlucHV0U3R5bGUoZW1haWxGb2N1c2VkKSwKICAgICAgICAgICAgICAgIG9uRm9jdXM6ICgpID0+IHNldEVtYWlsRm9jdXNlZCh0cnVlKSwKICAgICAgICAgICAgICAgIG9uQmx1cjogKCkgPT4gc2V0RW1haWxGb2N1c2VkKGZhbHNlKSwKICAgICAgICAgICAgICAgIGF1dG9Gb2N1czogdHJ1ZQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBvc2l0aW9uOiAicmVsYXRpdmUiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoTG9jaywgeyBzaXplOiAxOCwgY29sb3I6IENPTE9SUy50ZXh0TXV0ZWQsIHN0eWxlOiB7IHBvc2l0aW9uOiAiYWJzb2x1dGUiLCBsZWZ0OiAxNiwgdG9wOiAiNTAlIiwgdHJhbnNmb3JtOiAidHJhbnNsYXRlWSgtNTAlKSIgfSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHR5cGU6ICJwYXNzd29yZCIsCiAgICAgICAgICAgICAgICByZXF1aXJlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIHZhbHVlOiBwYXNzd29yZCwKICAgICAgICAgICAgICAgIG9uQ2hhbmdlOiAoZSkgPT4gc2V0UGFzc3dvcmQoZS50YXJnZXQudmFsdWUpLAogICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI6ICJQYXNzd29yZCIsCiAgICAgICAgICAgICAgICBzdHlsZTogaW5wdXRTdHlsZShwYXNzd29yZEZvY3VzZWQpLAogICAgICAgICAgICAgICAgb25Gb2N1czogKCkgPT4gc2V0UGFzc3dvcmRGb2N1c2VkKHRydWUpLAogICAgICAgICAgICAgICAgb25CbHVyOiAoKSA9PiBzZXRQYXNzd29yZEZvY3VzZWQoZmFsc2UpCiAgICAgICAgICAgICAgfQogICAgICAgICAgICApCiAgICAgICAgICBdIH0pLAogICAgICAgICAgbW9kZSA9PT0gIlNJR05VUCIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcG9zaXRpb246ICJyZWxhdGl2ZSIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KShMb2NrLCB7IHNpemU6IDE4LCBjb2xvcjogQ09MT1JTLnRleHRNdXRlZCwgc3R5bGU6IHsgcG9zaXRpb246ICJhYnNvbHV0ZSIsIGxlZnQ6IDE2LCB0b3A6ICI1MCUiLCB0cmFuc2Zvcm06ICJ0cmFuc2xhdGVZKC01MCUpIiB9IH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKAogICAgICAgICAgICAgICJpbnB1dCIsCiAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdHlwZTogInBhc3N3b3JkIiwKICAgICAgICAgICAgICAgIHJlcXVpcmVkOiB0cnVlLAogICAgICAgICAgICAgICAgdmFsdWU6IGNvbmZpcm1QYXNzd29yZCwKICAgICAgICAgICAgICAgIG9uQ2hhbmdlOiAoZSkgPT4gc2V0Q29uZmlybVBhc3N3b3JkKGUudGFyZ2V0LnZhbHVlKSwKICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAiQ29uZmlybSBQYXNzd29yZCIsCiAgICAgICAgICAgICAgICBzdHlsZTogaW5wdXRTdHlsZShjb25maXJtRm9jdXNlZCksCiAgICAgICAgICAgICAgICBvbkZvY3VzOiAoKSA9PiBzZXRDb25maXJtRm9jdXNlZCh0cnVlKSwKICAgICAgICAgICAgICAgIG9uQmx1cjogKCkgPT4gc2V0Q29uZmlybUZvY3VzZWQoZmFsc2UpCiAgICAgICAgICAgICAgfQogICAgICAgICAgICApCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB0eXBlOiAic3VibWl0IiwKICAgICAgICAgICAgICBkaXNhYmxlZDogbG9hZGluZyB8fCAhZW1haWwgfHwgIXBhc3N3b3JkIHx8IG1vZGUgPT09ICJTSUdOVVAiICYmICFjb25maXJtUGFzc3dvcmQsCiAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUy5wcmltYXJ5LAogICAgICAgICAgICAgICAgY29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgICAgICAgICBwYWRkaW5nOiAiMTZweCIsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDE2LAogICAgICAgICAgICAgICAgZm9udFNpemU6IDE2LAogICAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgICBjdXJzb3I6IGxvYWRpbmcgPyAibm90LWFsbG93ZWQiIDogInBvaW50ZXIiLAogICAgICAgICAgICAgICAgb3BhY2l0eTogbG9hZGluZyB8fCAhZW1haWwgfHwgIXBhc3N3b3JkID8gMC43IDogMSwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb246ICJhbGwgMC4ycyIsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgIGdhcDogOCwKICAgICAgICAgICAgICAgIG1hcmdpblRvcDogNAogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgb25Nb3VzZUVudGVyOiAoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKCFsb2FkaW5nKSB7CiAgICAgICAgICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS50cmFuc2Zvcm0gPSAidHJhbnNsYXRlWSgtMXB4KSI7CiAgICAgICAgICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBDT0xPUlMucHJpbWFyeURhcms7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBvbk1vdXNlTGVhdmU6IChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQuc3R5bGUudHJhbnNmb3JtID0gInRyYW5zbGF0ZVkoMCkiOwogICAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IENPTE9SUy5wcmltYXJ5OwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgY2hpbGRyZW46IGxvYWRpbmcgPyBtb2RlID09PSAiTE9HSU4iID8gIkxvZ2dpbmcgaW4uLi4iIDogIkNyZWF0aW5nIGFjY291bnQuLi4iIDogbW9kZSA9PT0gIkxPR0lOIiA/ICJMb2dpbiIgOiAiQ3JlYXRlIEFjY291bnQiCiAgICAgICAgICAgIH0KICAgICAgICAgICksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLCBtYXJnaW5Ub3A6IC00IH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZS5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGNvbG9yOiBDT0xPUlMudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICBtb2RlID09PSAiTE9HSU4iID8gIkRvbid0IGhhdmUgYW4gYWNjb3VudD8gIiA6ICJBbHJlYWR5IGhhdmUgYW4gYWNjb3VudD8gIiwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUuanN4KSgKICAgICAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0eXBlOiAiYnV0dG9uIiwKICAgICAgICAgICAgICAgIG9uQ2xpY2s6IHN3aXRjaE1vZGUsCiAgICAgICAgICAgICAgICBzdHlsZTogeyBiYWNrZ3JvdW5kOiAibm9uZSIsIGJvcmRlcjogIm5vbmUiLCBjb2xvcjogQ09MT1JTLnByaW1hcnksIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIsIHBhZGRpbmc6IDAgfSwKICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBtb2RlID09PSAiTE9HSU4iID8gIlNpZ24gVXAiIDogIkxvZ2luIgogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKQogICAgICAgICAgXSB9KSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KQogICAgXSB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lLmpzeCkoInN0eWxlIiwgeyBjaGlsZHJlbjogYAogICAgICAgICAgICAgICAgICAgIEBrZXlmcmFtZXMgZmFkZUluIHsKICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSB7IG9wYWNpdHk6IDA7IHRyYW5zZm9ybTogc2NhbGUoMC45NSkgdHJhbnNsYXRlWSgxMHB4KTsgfQogICAgICAgICAgICAgICAgICAgICAgICB0byB7IG9wYWNpdHk6IDE7IHRyYW5zZm9ybTogc2NhbGUoMSkgdHJhbnNsYXRlWSgwKTsgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGAgfSkKICBdIH0pOwp9OwoKLy8gc3JjL015QnVkZ2V0LnRzeAp2YXIgaW1wb3J0X2pzeF9ydW50aW1lMiA9IF9fdG9FU00ocmVxdWlyZV9qc3hfcnVudGltZSgpLCAxKTsKdmFyIFNUT1JBR0VfS0VZMiA9ICJNWV9CVURHRVRfREFUQSI7CnZhciBCVURHRVRTX0xJU1RfS0VZID0gIk1ZX0JVREdFVF9MSVNUIjsKdmFyIGdlbmVyYXRlSWQgPSAoKSA9PiBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSk7CnZhciBDT0xPUlMyID0gewogIHByaW1hcnk6ICIjMUI0MzMyIiwKICBwcmltYXJ5RGFyazogIiMwRjJCMUYiLAogIHByaW1hcnlMaWdodDogIiMyRDZBNEYiLAogIGFjY2VudDogIiM0MDkxNkMiLAogIGFjY2VudExpZ2h0OiAiI0U4RjVFOSIsCiAgYmc6ICIjRjVGNUYwIiwKICBjYXJkOiAiI0ZGRkZGRiIsCiAgYm9yZGVyOiAiI0U1RTdFQiIsCiAgYm9yZGVyTGlnaHQ6ICIjRjBGMEYwIiwKICB0ZXh0TWFpbjogIiMxQTFBMUEiLAogIHRleHRTZWNvbmRhcnk6ICIjNkI3MjgwIiwKICB0ZXh0TXV0ZWQ6ICIjOUNBM0FGIiwKICBpbmNvbWU6ICIjMDU5NjY5IiwKICBpbmNvbWVCZzogIiNFQ0ZERjUiLAogIGV4cGVuc2U6ICIjREMyNjI2IiwKICBleHBlbnNlQmc6ICIjRkVGMkYyIiwKICBhc3NldDogIiMyNTYzRUIiLAogIGFzc2V0Qmc6ICIjRUZGNkZGIiwKICBub25MaXF1aWQ6ICIjN0MzQUVEIiwKICBub25MaXF1aWRCZzogIiNGNUYzRkYiLAogIHJldGlyZW1lbnQ6ICIjMDg5MUIyIiwKICByZXRpcmVtZW50Qmc6ICIjRUNGRUZGIiwKICBsaWFiaWxpdHk6ICIjRUE1ODBDIiwKICBsaWFiaWxpdHlCZzogIiNGRkY3RUQiLAogIHBvc2l0aXZlOiAiIzA1OTY2OSIsCiAgbmVnYXRpdmU6ICIjREMyNjI2IiwKICB3YXJuaW5nOiAiI0Q5NzcwNiIKfTsKdmFyIGZtdCA9IChuKSA9PiB7CiAgaWYgKE1hdGguYWJzKG4pID49IDFlNikgcmV0dXJuIGAkJHsobiAvIDFlNikudG9GaXhlZCgyKX1NYDsKICByZXR1cm4gbi50b0xvY2FsZVN0cmluZygiZW4tVVMiLCB7IHN0eWxlOiAiY3VycmVuY3kiLCBjdXJyZW5jeTogIlVTRCIsIG1pbmltdW1GcmFjdGlvbkRpZ2l0czogMCwgbWF4aW11bUZyYWN0aW9uRGlnaXRzOiAwIH0pOwp9Owp2YXIgZm10RXhhY3QgPSAobikgPT4gbi50b0xvY2FsZVN0cmluZygiZW4tVVMiLCB7IHN0eWxlOiAiY3VycmVuY3kiLCBjdXJyZW5jeTogIlVTRCIsIG1pbmltdW1GcmFjdGlvbkRpZ2l0czogMCwgbWF4aW11bUZyYWN0aW9uRGlnaXRzOiAwIH0pOwp2YXIgZm10UHJpY2UgPSAobikgPT4gbi50b0xvY2FsZVN0cmluZygiZW4tVVMiLCB7IHN0eWxlOiAiY3VycmVuY3kiLCBjdXJyZW5jeTogIlVTRCIsIG1pbmltdW1GcmFjdGlvbkRpZ2l0czogMiwgbWF4aW11bUZyYWN0aW9uRGlnaXRzOiAyIH0pOwp2YXIgZW1wdHlCdWRnZXQgPSAoKSA9PiAoewogIGlkOiBnZW5lcmF0ZUlkKCksCiAgbmFtZTogIk15IEJ1ZGdldCBQbGFuIiwKICBpbmNvbWU6IFtdLAogIGV4cGVuc2VzOiBbXSwKICBhc3NldHM6IFtdLAogIG5vbkxpcXVpZEFzc2V0czogW10sCiAgcmV0aXJlbWVudDogW10sCiAgbGlhYmlsaXRpZXM6IFtdLAogIG5vbkxpcXVpZERpc2NvdW50OiAyNSwKICBjcmVhdGVkQXQ6IERhdGUubm93KCksCiAgdXBkYXRlZEF0OiBEYXRlLm5vdygpCn0pOwp2YXIgZW1wdHlJdGVtID0gKGZyZXEgPSAibW9udGhseSIpID0+ICh7CiAgaWQ6IGdlbmVyYXRlSWQoKSwKICBuYW1lOiAiIiwKICBhbW91bnQ6IDAsCiAgZnJlcXVlbmN5OiBmcmVxLAogIHRvdGFsVmFsdWU6IDAsCiAgbW9udGhseVZhbHVlOiAwCn0pOwp2YXIgY29tcHV0ZVZhbHVlcyA9IChhbW91bnQsIGZyZXF1ZW5jeSkgPT4gewogIHN3aXRjaCAoZnJlcXVlbmN5KSB7CiAgICBjYXNlICJtb250aGx5IjoKICAgICAgcmV0dXJuIHsgdG90YWxWYWx1ZTogYW1vdW50ICogMTIsIG1vbnRobHlWYWx1ZTogYW1vdW50IH07CiAgICBjYXNlICJ5ZWFybHkiOgogICAgICByZXR1cm4geyB0b3RhbFZhbHVlOiBhbW91bnQsIG1vbnRobHlWYWx1ZTogTWF0aC5yb3VuZChhbW91bnQgLyAxMiAqIDEwMCkgLyAxMDAgfTsKICAgIGNhc2UgIm9uZV90aW1lIjoKICAgICAgcmV0dXJuIHsgdG90YWxWYWx1ZTogYW1vdW50LCBtb250aGx5VmFsdWU6IDAgfTsKICB9Cn07CnZhciBBUElfQkFTRSA9ICgoKSA9PiB7CiAgdHJ5IHsKICAgIGlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIiAmJiB3aW5kb3cubG9jYXRpb24ucHJvdG9jb2wgPT09ICJmaWxlOiIpIHsKICAgICAgcmV0dXJuICJodHRwczovL215LWJ1ZGdldC1wbGFubmVyLm9ucmVuZGVyLmNvbSI7CiAgICB9CiAgICByZXR1cm4gIiI7CiAgfSBjYXRjaCB7CiAgICByZXR1cm4gIiI7CiAgfQp9KSgpOwp2YXIgdHJhY2tFdmVudCA9IChldmVudCwgZGF0YSkgPT4gewogIGZldGNoKGAke0FQSV9CQVNFfS9hcGkvdHJhY2tgLCB7CiAgICBtZXRob2Q6ICJQT1NUIiwKICAgIGhlYWRlcnM6IHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LAogICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBldmVudCwgZGF0YTogZGF0YSB8fCB7fSB9KQogIH0pLmNhdGNoKCgpID0+IHsKICB9KTsKfTsKdmFyIENPSU5HRUNLT19CQVNFID0gImh0dHBzOi8vYXBpLmNvaW5nZWNrby5jb20vYXBpL3YzIjsKdmFyIHNlYXJjaENvaW5zID0gYXN5bmMgKHF1ZXJ5KSA9PiB7CiAgaWYgKCFxdWVyeSB8fCBxdWVyeS5sZW5ndGggPCAyKSByZXR1cm4gW107CiAgdHJ5IHsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKGAke0NPSU5HRUNLT19CQVNFfS9zZWFyY2g/cXVlcnk9JHtlbmNvZGVVUklDb21wb25lbnQocXVlcnkpfWApOwogICAgaWYgKCFyZXMub2spIHJldHVybiBbXTsKICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXMuanNvbigpOwogICAgcmV0dXJuIChkYXRhLmNvaW5zIHx8IFtdKS5zbGljZSgwLCA4KS5tYXAoKGMpID0+ICh7CiAgICAgIGlkOiBjLmlkLAogICAgICBuYW1lOiBjLm5hbWUsCiAgICAgIHN5bWJvbDogYy5zeW1ib2wsCiAgICAgIHRodW1iOiBjLnRodW1iCiAgICB9KSk7CiAgfSBjYXRjaCB7CiAgICByZXR1cm4gW107CiAgfQp9Owp2YXIgZmV0Y2hDcnlwdG9QcmljZXMgPSBhc3luYyAoaWRzKSA9PiB7CiAgaWYgKGlkcy5sZW5ndGggPT09IDApIHJldHVybiB7fTsKICB0cnkgewogICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2goYCR7Q09JTkdFQ0tPX0JBU0V9L3NpbXBsZS9wcmljZT9pZHM9JHtpZHMuam9pbigiLCIpfSZ2c19jdXJyZW5jaWVzPXVzZGApOwogICAgaWYgKCFyZXMub2spIHJldHVybiB7fTsKICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXMuanNvbigpOwogICAgY29uc3QgcHJpY2VzID0ge307CiAgICBmb3IgKGNvbnN0IGlkIG9mIGlkcykgewogICAgICBpZiAoZGF0YVtpZF0/LnVzZCkgcHJpY2VzW2lkXSA9IGRhdGFbaWRdLnVzZDsKICAgIH0KICAgIHJldHVybiBwcmljZXM7CiAgfSBjYXRjaCB7CiAgICByZXR1cm4ge307CiAgfQp9Owp2YXIgRklOTkhVQl9LRVkgPSAiZDY1MmV0aHIwMXFxYmxuNWtqamdkNjUyZXRocjAxcXFibG41a2prMCI7CnZhciBmZXRjaFN0b2NrUHJpY2VzID0gYXN5bmMgKHN5bWJvbHMpID0+IHsKICBpZiAoc3ltYm9scy5sZW5ndGggPT09IDApIHJldHVybiB7fTsKICBjb25zdCByZXN1bHRzID0ge307CiAgYXdhaXQgUHJvbWlzZS5hbGwoc3ltYm9scy5tYXAoYXN5bmMgKHN5bWJvbCkgPT4gewogICAgdHJ5IHsKICAgICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2goYGh0dHBzOi8vZmlubmh1Yi5pby9hcGkvdjEvcXVvdGU/c3ltYm9sPSR7c3ltYm9sfSZ0b2tlbj0ke0ZJTk5IVUJfS0VZfWApOwogICAgICBpZiAoIXJlcy5vaykgcmV0dXJuOwogICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmpzb24oKTsKICAgICAgaWYgKGRhdGEuYyAmJiBkYXRhLmMgPiAwKSByZXN1bHRzW3N5bWJvbF0gPSBkYXRhLmM7CiAgICB9IGNhdGNoIHsKICAgIH0KICB9KSk7CiAgcmV0dXJuIHJlc3VsdHM7Cn07CnZhciBtaSA9IChuYW1lLCBhbW91bnQsIGZyZXEgPSAibW9udGhseSIpID0+ICh7CiAgaWQ6IGdlbmVyYXRlSWQoKSwKICBuYW1lLAogIGFtb3VudCwKICBmcmVxdWVuY3k6IGZyZXEsCiAgdG90YWxWYWx1ZTogZnJlcSA9PT0gIm1vbnRobHkiID8gYW1vdW50ICogMTIgOiBmcmVxID09PSAieWVhcmx5IiA/IGFtb3VudCA6IGFtb3VudCwKICBtb250aGx5VmFsdWU6IGZyZXEgPT09ICJtb250aGx5IiA/IGFtb3VudCA6IGZyZXEgPT09ICJ5ZWFybHkiID8gTWF0aC5yb3VuZChhbW91bnQgLyAxMikgOiAwCn0pOwp2YXIgbWlhID0gKG5hbWUsIGFtb3VudCkgPT4gKHsKICBpZDogZ2VuZXJhdGVJZCgpLAogIG5hbWUsCiAgYW1vdW50LAogIGZyZXF1ZW5jeTogIm9uZV90aW1lIiwKICB0b3RhbFZhbHVlOiBhbW91bnQsCiAgbW9udGhseVZhbHVlOiAwCn0pOwp2YXIgQlVER0VUX1BSRVNFVFMgPSBbCiAgewogICAgLy8gR2VuIFo6IH4yMi0yOCwgbWVkaWFuIHNhbGFyeSB+JDQwaywgfiQyLDgwMC9tbyBhZnRlciB0YXgKICAgIGtleTogImdlbl96IiwKICAgIGxhYmVsOiAiR2VuIFoiLAogICAgZW1vamk6ICJcdXsxRjRGMX0iLAogICAgZGVzYzogIlN0YXJ0aW5nIG91dCwgc2lkZSBodXN0bGVzICYgc3Vic2NyaXB0aW9ucyIsCiAgICBidWRnZXQ6IHsKICAgICAgbmFtZTogIkdlbiBaIEJ1ZGdldCIsCiAgICAgIGluY29tZTogW21pKCJQYXJ0LXRpbWUgLyBGdWxsLXRpbWUgSm9iIiwgMjQwMCksIG1pKCJGcmVlbGFuY2UgLyBTaWRlIEh1c3RsZSIsIDUwMCksIG1pKCJUaXBzIC8gR2lnIFdvcmsiLCAyMDApXSwKICAgICAgZXhwZW5zZXM6IFttaSgiUmVudCAoc2hhcmVkKSIsIDk1MCksIG1pKCJHcm9jZXJpZXMiLCAzNTApLCBtaSgiUGhvbmUgUGxhbiIsIDgwKSwgbWkoIlN0cmVhbWluZyAoTmV0ZmxpeCwgU3BvdGlmeSkiLCAzMCksIG1pKCJEaW5pbmcgT3V0IiwgMjAwKSwgbWkoIlViZXIgLyBUcmFuc2l0IiwgMTIwKSwgbWkoIkd5bSBNZW1iZXJzaGlwIiwgNDApLCBtaSgiU3Vic2NyaXB0aW9ucyAoYXBwcykiLCAyNSksIG1pKCJDbG90aGluZyIsIDc1KSwgbWkoIkVudGVydGFpbm1lbnQiLCAxMDApXSwKICAgICAgYXNzZXRzOiBbbWlhKCJTYXZpbmdzIEFjY291bnQiLCAyNTAwKSwgbWlhKCJWZW5tbyAvIENhc2ggQXBwIEJhbGFuY2UiLCAzMDApLCBtaWEoIkNyeXB0byIsIDUwMCldLAogICAgICBub25MaXF1aWRBc3NldHM6IFttaWEoIkxhcHRvcCIsIDEyMDApLCBtaWEoIlBob25lIiwgODAwKV0sCiAgICAgIHJldGlyZW1lbnQ6IFttaWEoIlJvdGggSVJBIiwgM2UzKV0sCiAgICAgIGxpYWJpbGl0aWVzOiBbbWlhKCJTdHVkZW50IExvYW5zIiwgMjhlMyksIG1pYSgiQ3JlZGl0IENhcmQgQmFsYW5jZSIsIDI1MDApLCBtaSgiQnV5IE5vdyBQYXkgTGF0ZXIiLCA1MCldLAogICAgICBub25MaXF1aWREaXNjb3VudDogNTAKICAgIH0KICB9LAogIHsKICAgIC8vIE1pbGxlbm5pYWw6IH4yOS00MywgbWVkaWFuIHNhbGFyeSB+JDY1aywgfiQ0LDIwMC9tbyBhZnRlciB0YXgKICAgIGtleTogIm1pbGxlbm5pYWwiLAogICAgbGFiZWw6ICJNaWxsZW5uaWFsIiwKICAgIGVtb2ppOiAiXHV7MUY0QkN9IiwKICAgIGRlc2M6ICJDYXJlZXIgZ3Jvd3RoLCBidWlsZGluZyB3ZWFsdGgiLAogICAgYnVkZ2V0OiB7CiAgICAgIG5hbWU6ICJNaWxsZW5uaWFsIEJ1ZGdldCIsCiAgICAgIGluY29tZTogW21pKCJTYWxhcnkiLCA0MjAwKSwgbWkoIkJvbnVzIiwgNWUzLCAieWVhcmx5IiksIG1pKCJTaWRlIFByb2plY3QgLyBGcmVlbGFuY2UiLCA0MDApXSwKICAgICAgZXhwZW5zZXM6IFttaSgiUmVudCAvIE1vcnRnYWdlIiwgMTUwMCksIG1pKCJHcm9jZXJpZXMiLCA0NTApLCBtaSgiQ2FyIFBheW1lbnQiLCA1MDApLCBtaSgiQ2FyIEluc3VyYW5jZSIsIDE1MCksIG1pKCJVdGlsaXRpZXMiLCAyMDApLCBtaSgiUGhvbmUgUGxhbiIsIDg1KSwgbWkoIkludGVybmV0IiwgNzApLCBtaSgiU3RyZWFtaW5nIFNlcnZpY2VzIiwgNDUpLCBtaSgiRGluaW5nIE91dCIsIDI1MCksIG1pKCJHeW0iLCA1MCksIG1pKCJQZXQgRXhwZW5zZXMiLCAxMDApLCBtaSgiVHJhdmVsIEZ1bmQiLCAyMDApXSwKICAgICAgYXNzZXRzOiBbbWlhKCJDaGVja2luZyBBY2NvdW50IiwgNGUzKSwgbWlhKCJTYXZpbmdzIEFjY291bnQiLCAxMmUzKSwgbWlhKCJCcm9rZXJhZ2UgQWNjb3VudCIsIDE1ZTMpLCBtaWEoIkNyeXB0byBQb3J0Zm9saW8iLCAzZTMpXSwKICAgICAgbm9uTGlxdWlkQXNzZXRzOiBbbWlhKCJDYXIiLCAxOGUzKSwgbWlhKCJGdXJuaXR1cmUgJiBFbGVjdHJvbmljcyIsIDVlMyldLAogICAgICByZXRpcmVtZW50OiBbbWlhKCI0MDFrIiwgMzVlMyksIG1pYSgiUm90aCBJUkEiLCAxMmUzKV0sCiAgICAgIGxpYWJpbGl0aWVzOiBbbWlhKCJTdHVkZW50IExvYW5zIiwgMjJlMyksIG1pYSgiQ3JlZGl0IENhcmQgQmFsYW5jZSIsIDQ1MDApLCBtaWEoIkNhciBMb2FuIiwgMTVlMyldLAogICAgICBub25MaXF1aWREaXNjb3VudDogMzAKICAgIH0KICB9LAogIHsKICAgIC8vIEZhbWlseTogZHVhbCBpbmNvbWUsIDM1LTU0LCBjb21iaW5lZCB+JDk0ayBwcmUtdGF4IOKGkiB+JDYsNTAwL21vIGFmdGVyIHRheAogICAga2V5OiAiZmFtaWx5IiwKICAgIGxhYmVsOiAiRmFtaWx5IiwKICAgIGVtb2ppOiAiXHV7MUY0Njh9XHUyMDBEXHV7MUY0Njl9XHUyMDBEXHV7MUY0Njd9XHUyMDBEXHV7MUY0NjZ9IiwKICAgIGRlc2M6ICJEdWFsIGluY29tZSwga2lkcywgaG9tZSBvd25lcnNoaXAiLAogICAgYnVkZ2V0OiB7CiAgICAgIG5hbWU6ICJGYW1pbHkgQnVkZ2V0IiwKICAgICAgaW5jb21lOiBbbWkoIlNhbGFyeSAoUHJpbWFyeSkiLCA0ZTMpLCBtaSgiU2FsYXJ5IChTcG91c2UpIiwgMzIwMCksIG1pKCJDaGlsZCBUYXggQ3JlZGl0IiwgMjUwKV0sCiAgICAgIGV4cGVuc2VzOiBbbWkoIk1vcnRnYWdlIiwgMjEwMCksIG1pKCJQcm9wZXJ0eSBUYXgiLCA0ODAwLCAieWVhcmx5IiksIG1pKCJIb21lb3duZXIncyBJbnN1cmFuY2UiLCAxODAwLCAieWVhcmx5IiksIG1pKCJHcm9jZXJpZXMiLCA3MDApLCBtaSgiVXRpbGl0aWVzIiwgMzgwKSwgbWkoIkNoaWxkY2FyZSAvIERheWNhcmUiLCAxMjAwKSwgbWkoIktpZHMgQWN0aXZpdGllcyIsIDE1MCksIG1pKCJDYXIgUGF5bWVudCIsIDU1MCksIG1pKCJDYXIgSW5zdXJhbmNlIiwgMjAwKSwgbWkoIkdhcyIsIDE4MCksIG1pKCJQaG9uZSBQbGFucyIsIDE0MCksIG1pKCJJbnRlcm5ldCIsIDc1KSwgbWkoIlN0cmVhbWluZyIsIDUwKSwgbWkoIkRpbmluZyBPdXQiLCAyNTApLCBtaSgiQ2xvdGhpbmciLCAxNzApLCBtaSgiTWVkaWNhbCAvIENvcGF5cyIsIDEwMCksIG1pKCJTY2hvb2wgU3VwcGxpZXMiLCA1MCldLAogICAgICBhc3NldHM6IFttaWEoIkNoZWNraW5nIEFjY291bnQiLCA2ZTMpLCBtaWEoIkpvaW50IFNhdmluZ3MiLCAyNWUzKSwgbWlhKCI1MjkgQ29sbGVnZSBGdW5kIiwgMThlMyksIG1pYSgiQnJva2VyYWdlIEFjY291bnQiLCAzZTQpXSwKICAgICAgbm9uTGlxdWlkQXNzZXRzOiBbbWlhKCJIb21lIEVxdWl0eSIsIDEyZTQpLCBtaWEoIkNhciAoUHJpbWFyeSkiLCAyMmUzKSwgbWlhKCJDYXIgKFNwb3VzZSkiLCAxNWUzKV0sCiAgICAgIHJldGlyZW1lbnQ6IFttaWEoIjQwMWsgKFByaW1hcnkpIiwgNjVlMyksIG1pYSgiNDAxayAoU3BvdXNlKSIsIDRlNCksIG1pYSgiUm90aCBJUkEiLCAxNWUzKV0sCiAgICAgIGxpYWJpbGl0aWVzOiBbbWlhKCJNb3J0Z2FnZSBCYWxhbmNlIiwgMjhlNCksIG1pYSgiQ2FyIExvYW4iLCAxOGUzKSwgbWlhKCJDcmVkaXQgQ2FyZCIsIDZlMyksIG1pYSgiTWVkaWNhbCBCaWxscyIsIDJlMyldLAogICAgICBub25MaXF1aWREaXNjb3VudDogMjAKICAgIH0KICB9LAogIHsKICAgIC8vIFJldGlyZWU6IDY1KywgYXZnIFNTIH4kMSw5MDcvbW8sIHNwZW5kaW5nIH4kNCw2MDAvbW8KICAgIGtleTogInJldGlyZWUiLAogICAgbGFiZWw6ICJSZXRpcmVlIiwKICAgIGVtb2ppOiAiXHV7MUYzRDZ9XHVGRTBGIiwKICAgIGRlc2M6ICJGaXhlZCBpbmNvbWUsIGxvdyBkZWJ0LCBlbmpveWluZyBsaWZlIiwKICAgIGJ1ZGdldDogewogICAgICBuYW1lOiAiUmV0aXJlZSBCdWRnZXQiLAogICAgICBpbmNvbWU6IFttaSgiU29jaWFsIFNlY3VyaXR5IiwgMTkwMCksIG1pKCJQZW5zaW9uIiwgMTUwMCksIG1pKCJSZXRpcmVtZW50IFdpdGhkcmF3YWxzIiwgMTIwMCksIG1pKCJSZW50YWwgSW5jb21lIiwgODAwKV0sCiAgICAgIGV4cGVuc2VzOiBbbWkoIk1vcnRnYWdlIC8gUmVudCIsIDEyMDApLCBtaSgiVXRpbGl0aWVzIiwgMzAwKSwgbWkoIkdyb2NlcmllcyIsIDUwMCksIG1pKCJNZWRpY2FyZSAvIEhlYWx0aCBJbnN1cmFuY2UiLCAzNDApLCBtaSgiUHJlc2NyaXB0aW9ucyIsIDE1MCksIG1pKCJDYXIgSW5zdXJhbmNlIiwgMTIwKSwgbWkoIkdhcyIsIDEwMCksIG1pKCJQaG9uZSIsIDYwKSwgbWkoIkludGVybmV0IC8gQ2FibGUiLCA5MCksIG1pKCJEaW5pbmcgT3V0IiwgMjAwKSwgbWkoIlRyYXZlbCAvIFZhY2F0aW9ucyIsIDMwMCksIG1pKCJIb2JiaWVzIiwgMTAwKSwgbWkoIkdpZnRzIC8gRG9uYXRpb25zIiwgMTUwKV0sCiAgICAgIGFzc2V0czogW21pYSgiQ2hlY2tpbmcgQWNjb3VudCIsIDhlMyksIG1pYSgiU2F2aW5ncyBBY2NvdW50IiwgNDVlMyksIG1pYSgiQ0RzIC8gQm9uZHMiLCA1ZTQpLCBtaWEoIkJyb2tlcmFnZSBBY2NvdW50IiwgOGU0KV0sCiAgICAgIG5vbkxpcXVpZEFzc2V0czogW21pYSgiSG9tZSIsIDNlNSksIG1pYSgiQ2FyIiwgMTVlMyksIG1pYSgiSmV3ZWxyeSAvIENvbGxlY3RpYmxlcyIsIDFlNCldLAogICAgICByZXRpcmVtZW50OiBbbWlhKCI0MDFrIC8gSVJBIiwgMjVlNCksIG1pYSgiUGVuc2lvbiBGdW5kIiwgMTVlNCksIG1pYSgiQW5udWl0eSIsIDc1ZTMpXSwKICAgICAgbGlhYmlsaXRpZXM6IFttaWEoIk1vcnRnYWdlIEJhbGFuY2UiLCA4NWUzKSwgbWlhKCJNZWRpY2FsIEJpbGxzIiwgM2UzKV0sCiAgICAgIG5vbkxpcXVpZERpc2NvdW50OiAyMAogICAgfQogIH0KXTsKdmFyIG1pZ3JhdGVJdGVtID0gKGl0ZW0pID0+IHsKICBpZiAoaXRlbS5hbW91bnQgIT09IHZvaWQgMCAmJiBpdGVtLmZyZXF1ZW5jeSAhPT0gdm9pZCAwKSByZXR1cm4gaXRlbTsKICBpZiAoaXRlbS5tb250aGx5VmFsdWUgJiYgaXRlbS5tb250aGx5VmFsdWUgPiAwKSB7CiAgICByZXR1cm4geyAuLi5pdGVtLCBhbW91bnQ6IGl0ZW0ubW9udGhseVZhbHVlLCBmcmVxdWVuY3k6ICJtb250aGx5IiB9OwogIH0KICByZXR1cm4geyAuLi5pdGVtLCBhbW91bnQ6IGl0ZW0udG90YWxWYWx1ZSB8fCAwLCBmcmVxdWVuY3k6ICJvbmVfdGltZSIgfTsKfTsKdmFyIG1pZ3JhdGVCdWRnZXQgPSAoYikgPT4gKHsKICAuLi5iLAogIGluY29tZTogKGIuaW5jb21lIHx8IFtdKS5tYXAobWlncmF0ZUl0ZW0pLAogIGV4cGVuc2VzOiAoYi5leHBlbnNlcyB8fCBbXSkubWFwKG1pZ3JhdGVJdGVtKSwKICBhc3NldHM6IChiLmFzc2V0cyB8fCBbXSkubWFwKG1pZ3JhdGVJdGVtKSwKICBub25MaXF1aWRBc3NldHM6IChiLm5vbkxpcXVpZEFzc2V0cyB8fCBbXSkubWFwKG1pZ3JhdGVJdGVtKSwKICByZXRpcmVtZW50OiAoYi5yZXRpcmVtZW50IHx8IFtdKS5tYXAobWlncmF0ZUl0ZW0pLAogIGxpYWJpbGl0aWVzOiAoYi5saWFiaWxpdGllcyB8fCBbXSkubWFwKG1pZ3JhdGVJdGVtKQp9KTsKdmFyIGxvYWRCdWRnZXRzID0gKCkgPT4gewogIHRyeSB7CiAgICBjb25zdCBkYXRhID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oQlVER0VUU19MSVNUX0tFWSk7CiAgICBpZiAoZGF0YSkgcmV0dXJuIEpTT04ucGFyc2UoZGF0YSkubWFwKG1pZ3JhdGVCdWRnZXQpOwogIH0gY2F0Y2ggewogIH0KICByZXR1cm4gW107Cn07CnZhciBzYXZlQnVkZ2V0cyA9IChidWRnZXRzKSA9PiB7CiAgdHJ5IHsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKEJVREdFVFNfTElTVF9LRVksIEpTT04uc3RyaW5naWZ5KGJ1ZGdldHMpKTsKICB9IGNhdGNoIHsKICB9Cn07CnZhciBsb2FkQ3VycmVudEJ1ZGdldCA9ICgpID0+IHsKICB0cnkgewogICAgY29uc3QgZGF0YSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFNUT1JBR0VfS0VZMik7CiAgICBpZiAoZGF0YSkgcmV0dXJuIG1pZ3JhdGVCdWRnZXQoSlNPTi5wYXJzZShkYXRhKSk7CiAgfSBjYXRjaCB7CiAgfQogIHJldHVybiBudWxsOwp9Owp2YXIgc2F2ZUN1cnJlbnRCdWRnZXQgPSAoYnVkZ2V0KSA9PiB7CiAgdHJ5IHsKICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFNUT1JBR0VfS0VZMiwgSlNPTi5zdHJpbmdpZnkoYnVkZ2V0KSk7CiAgfSBjYXRjaCB7CiAgfQp9Owp2YXIgUFJFU0VUUyA9IHsKICBpbmNvbWU6IFsKICAgIHsgbmFtZTogIldvcmsgU2FsYXJ5IiwgZW1vamk6ICJcdXsxRjRCQ30iIH0sCiAgICB7IG5hbWU6ICJGcmVlbGFuY2UgSW5jb21lIiwgZW1vamk6ICJcdXsxRjRCQn0iIH0sCiAgICB7IG5hbWU6ICJSZW50YWwgSW5jb21lIiwgZW1vamk6ICJcdXsxRjNFMH0iIH0sCiAgICB7IG5hbWU6ICJJbnZlc3RtZW50IERpdmlkZW5kcyIsIGVtb2ppOiAiXHV7MUY0Qzh9IiB9LAogICAgeyBuYW1lOiAiR292ZXJubWVudCBCZW5lZml0cyIsIGVtb2ppOiAiXHV7MUYzREJ9XHVGRTBGIiB9LAogICAgeyBuYW1lOiAiU2lkZSBCdXNpbmVzcyIsIGVtb2ppOiAiXHV7MUYzRUF9IiB9LAogICAgeyBuYW1lOiAiUGVuc2lvbiIsIGVtb2ppOiAiXHV7MUY5RDN9IiB9CiAgXSwKICBleHBlbnNlczogWwogICAgeyBuYW1lOiAiUmVudCIsIGVtb2ppOiAiXHV7MUYzRTB9IiB9LAogICAgeyBuYW1lOiAiTW9ydGdhZ2UgUGF5bWVudCIsIGVtb2ppOiAiXHV7MUYzRTZ9IiB9LAogICAgeyBuYW1lOiAiVXRpbGl0aWVzIiwgZW1vamk6ICJcdXsxRjRBMX0iIH0sCiAgICB7IG5hbWU6ICJHcm9jZXJpZXMiLCBlbW9qaTogIlx1ezFGNkQyfSIgfSwKICAgIHsgbmFtZTogIkNhciBQYXltZW50IiwgZW1vamk6ICJcdXsxRjY5N30iIH0sCiAgICB7IG5hbWU6ICJJbnN1cmFuY2UiLCBlbW9qaTogIlx1ezFGNkUxfVx1RkUwRiIgfSwKICAgIHsgbmFtZTogIlN1YnNjcmlwdGlvbnMiLCBlbW9qaTogIlx1ezFGNEZBfSIgfSwKICAgIHsgbmFtZTogIlBob25lIEJpbGwiLCBlbW9qaTogIlx1ezFGNEYxfSIgfSwKICAgIHsgbmFtZTogIkludGVybmV0IiwgZW1vamk6ICJcdXsxRjMxMH0iIH0sCiAgICB7IG5hbWU6ICJHYXMvVHJhbnNwb3J0YXRpb24iLCBlbW9qaTogIlx1MjZGRCIgfQogIF0sCiAgYXNzZXRzOiBbCiAgICB7IG5hbWU6ICJDaGVja2luZyBBY2NvdW50IiwgZW1vamk6ICJcdXsxRjNFNn0iIH0sCiAgICB7IG5hbWU6ICJTYXZpbmdzIEFjY291bnQiLCBlbW9qaTogIlx1ezFGNEIwfSIgfSwKICAgIHsgbmFtZTogIlN0b2Nrcy9Ccm9rZXJhZ2UiLCBlbW9qaTogIlx1ezFGNENBfSIsIHBlcnNpc3RlbnQ6IHRydWUsIGFzc2V0VHlwZTogInN0b2NrIiB9LAogICAgeyBuYW1lOiAiQ3J5cHRvIiwgZW1vamk6ICJcdTIwQkYiIH0sCiAgICB7IG5hbWU6ICI0MDFrL1JldGlyZW1lbnQiLCBlbW9qaTogIlx1ezFGOUQzfSIgfSwKICAgIHsgbmFtZTogIkVtZXJnZW5jeSBGdW5kIiwgZW1vamk6ICJcdXsxRjE5OH0iIH0sCiAgICB7IG5hbWU6ICJDRC9Cb25kcyIsIGVtb2ppOiAiXHV7MUY0REN9IiB9CiAgXSwKICBub25MaXF1aWRBc3NldHM6IFsKICAgIHsgbmFtZTogIkhvbWUgVmFsdWUiLCBlbW9qaTogIlx1ezFGM0UxfSIgfSwKICAgIHsgbmFtZTogIkNhciBWYWx1ZSIsIGVtb2ppOiAiXHV7MUY2OTd9IiB9LAogICAgeyBuYW1lOiAiSmV3ZWxyeS9XYXRjaGVzIiwgZW1vamk6ICJcdXsxRjQ4RX0iIH0sCiAgICB7IG5hbWU6ICJBcnQvQ29sbGVjdGlibGVzIiwgZW1vamk6ICJcdXsxRjNBOH0iIH0sCiAgICB7IG5hbWU6ICJCdXNpbmVzcyBFcXVpdHkiLCBlbW9qaTogIlx1ezFGM0UyfSIgfSwKICAgIHsgbmFtZTogIkZ1cm5pdHVyZS9FbGVjdHJvbmljcyIsIGVtb2ppOiAiXHV7MUZBOTF9IiB9CiAgXSwKICByZXRpcmVtZW50OiBbCiAgICB7IG5hbWU6ICI0MDFrIiwgZW1vamk6ICJcdXsxRjNFNn0iIH0sCiAgICB7IG5hbWU6ICJSb3RoIElSQSIsIGVtb2ppOiAiXHV7MUY0Q0F9IiB9LAogICAgeyBuYW1lOiAiVHJhZGl0aW9uYWwgSVJBIiwgZW1vamk6ICJcdXsxRjRDOH0iIH0sCiAgICB7IG5hbWU6ICJQZW5zaW9uIEZ1bmQiLCBlbW9qaTogIlx1ezFGOUQzfSIgfSwKICAgIHsgbmFtZTogIlNFUCBJUkEiLCBlbW9qaTogIlx1ezFGNEJDfSIgfSwKICAgIHsgbmFtZTogIjQwM2IiLCBlbW9qaTogIlx1ezFGM0VCfSIgfQogIF0sCiAgbGlhYmlsaXRpZXM6IFsKICAgIHsgbmFtZTogIk1vcnRnYWdlIiwgZW1vamk6ICJcdXsxRjNFNn0iIH0sCiAgICB7IG5hbWU6ICJDYXIgTG9hbiIsIGVtb2ppOiAiXHV7MUY2OTd9IiB9LAogICAgeyBuYW1lOiAiU3R1ZGVudCBMb2FucyIsIGVtb2ppOiAiXHV7MUYzOTN9IiB9LAogICAgeyBuYW1lOiAiQ3JlZGl0IENhcmQgRGVidCIsIGVtb2ppOiAiXHV7MUY0QjN9IiB9LAogICAgeyBuYW1lOiAiUGVyc29uYWwgTG9hbiIsIGVtb2ppOiAiXHV7MUY5MUR9IiB9LAogICAgeyBuYW1lOiAiTWVkaWNhbCBEZWJ0IiwgZW1vamk6ICJcdXsxRjNFNX0iIH0sCiAgICB7IG5hbWU6ICJQZXJzb25hbCBFeHBlbnNlcyIsIGVtb2ppOiAiXHV7MUY2Q0R9XHVGRTBGIiB9CiAgXQp9Owp2YXIgU2VjdGlvbkhlYWRlciA9ICh7IHRpdGxlLCBpY29uLCBjb2xvcjogY29sb3IyLCBiZ0NvbG9yLCB0b3RhbCwgbW9udGhseVRvdGFsLCBjb3VudCwgaXNPcGVuLCBvblRvZ2dsZSB9KSA9PiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImJ1dHRvbiIsIHsgb25DbGljazogb25Ub2dnbGUsIHN0eWxlOiB7CiAgd2lkdGg6ICIxMDAlIiwKICBkaXNwbGF5OiAiZmxleCIsCiAgYWxpZ25JdGVtczogImNlbnRlciIsCiAganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwKICBwYWRkaW5nOiAiMTRweCAxNnB4IiwKICBib3JkZXI6ICJub25lIiwKICBib3JkZXJSYWRpdXM6IDEyLAogIGN1cnNvcjogInBvaW50ZXIiLAogIGJhY2tncm91bmRDb2xvcjogYmdDb2xvciwKICB0cmFuc2l0aW9uOiAiYWxsIDAuMnMiCn0sIGNoaWxkcmVuOiBbCiAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogMTAgfSwgY2hpbGRyZW46IFsKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiAzNiwgaGVpZ2h0OiAzNiwgYm9yZGVyUmFkaXVzOiAxMCwgYmFja2dyb3VuZENvbG9yOiBjb2xvcjIsIGNvbG9yOiAid2hpdGUiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIgfSwgY2hpbGRyZW46IGljb24gfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgdGV4dEFsaWduOiAibGVmdCIgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE1LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNYWluIH0sIGNoaWxkcmVuOiB0aXRsZSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogWwogICAgICAgIGNvdW50LAogICAgICAgICIgaXRlbSIsCiAgICAgICAgY291bnQgIT09IDEgPyAicyIgOiAiIgogICAgICBdIH0pCiAgICBdIH0pCiAgXSB9KSwKICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiAxMiB9LCBjaGlsZHJlbjogWwogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHRleHRBbGlnbjogInJpZ2h0IiB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTYsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IGNvbG9yMiB9LCBjaGlsZHJlbjogZm10KHRvdGFsKSB9KSwKICAgICAgbW9udGhseVRvdGFsICE9PSB2b2lkIDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogWwogICAgICAgIGZtdChtb250aGx5VG90YWwpLAogICAgICAgICIvbW8iCiAgICAgIF0gfSkKICAgIF0gfSksCiAgICBpc09wZW4gPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShDaGV2cm9uVXAsIHsgc2l6ZTogMTgsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnkgfSkgOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShDaGV2cm9uRG93biwgeyBzaXplOiAxOCwgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSB9KQogIF0gfSkKXSB9KTsKdmFyIENvaW5TZWFyY2hEcm9wZG93biA9ICh7IG9uU2VsZWN0LCBpbnB1dFN0eWxlOiBpbnB1dFN0eWxlMiB9KSA9PiB7CiAgY29uc3QgW3F1ZXJ5LCBzZXRRdWVyeV0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKCIiKTsKICBjb25zdCBbcmVzdWx0cywgc2V0UmVzdWx0c10gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKFtdKTsKICBjb25zdCBbbG9hZGluZywgc2V0TG9hZGluZ10gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbc2hvd0Ryb3Bkb3duLCBzZXRTaG93RHJvcGRvd25dID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgdGltZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlUmVmKShudWxsKTsKICBjb25zdCBjb250YWluZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlUmVmKShudWxsKTsKICAoMCwgaW1wb3J0X3JlYWN0NTIudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBjb25zdCBoYW5kbGVDbGlja091dHNpZGUgPSAoZSkgPT4gewogICAgICBpZiAoY29udGFpbmVyUmVmLmN1cnJlbnQgJiYgIWNvbnRhaW5lclJlZi5jdXJyZW50LmNvbnRhaW5zKGUudGFyZ2V0KSkgc2V0U2hvd0Ryb3Bkb3duKGZhbHNlKTsKICAgIH07CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJtb3VzZWRvd24iLCBoYW5kbGVDbGlja091dHNpZGUpOwogICAgcmV0dXJuICgpID0+IGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm1vdXNlZG93biIsIGhhbmRsZUNsaWNrT3V0c2lkZSk7CiAgfSwgW10pOwogIGNvbnN0IGhhbmRsZVNlYXJjaCA9ICh2YWwpID0+IHsKICAgIHNldFF1ZXJ5KHZhbCk7CiAgICBpZiAodGltZXJSZWYuY3VycmVudCkgY2xlYXJUaW1lb3V0KHRpbWVyUmVmLmN1cnJlbnQpOwogICAgaWYgKHZhbC5sZW5ndGggPCAyKSB7CiAgICAgIHNldFJlc3VsdHMoW10pOwogICAgICBzZXRTaG93RHJvcGRvd24oZmFsc2UpOwogICAgICByZXR1cm47CiAgICB9CiAgICBzZXRMb2FkaW5nKHRydWUpOwogICAgdGltZXJSZWYuY3VycmVudCA9IHNldFRpbWVvdXQoYXN5bmMgKCkgPT4gewogICAgICBjb25zdCBjb2lucyA9IGF3YWl0IHNlYXJjaENvaW5zKHZhbCk7CiAgICAgIHNldFJlc3VsdHMoY29pbnMpOwogICAgICBzZXRTaG93RHJvcGRvd24oY29pbnMubGVuZ3RoID4gMCk7CiAgICAgIHNldExvYWRpbmcoZmFsc2UpOwogICAgfSwgMzAwKTsKICB9OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgcmVmOiBjb250YWluZXJSZWYsIHN0eWxlOiB7IHBvc2l0aW9uOiAicmVsYXRpdmUiIH0sIGNoaWxkcmVuOiBbCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcG9zaXRpb246ICJyZWxhdGl2ZSIgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoU2VhcmNoLCB7IHNpemU6IDE0LCBzdHlsZTogeyBwb3NpdGlvbjogImFic29sdXRlIiwgbGVmdDogOCwgdG9wOiAiNTAlIiwgdHJhbnNmb3JtOiAidHJhbnNsYXRlWSgtNTAlKSIsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCB9IH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgICAiaW5wdXQiLAogICAgICAgIHsKICAgICAgICAgIHN0eWxlOiB7IC4uLmlucHV0U3R5bGUyLCBwYWRkaW5nTGVmdDogMjggfSwKICAgICAgICAgIHZhbHVlOiBxdWVyeSwKICAgICAgICAgIG9uQ2hhbmdlOiAoZSkgPT4gaGFuZGxlU2VhcmNoKGUudGFyZ2V0LnZhbHVlKSwKICAgICAgICAgIG9uRm9jdXM6ICgpID0+IHsKICAgICAgICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID4gMCkgc2V0U2hvd0Ryb3Bkb3duKHRydWUpOwogICAgICAgICAgfSwKICAgICAgICAgIHBsYWNlaG9sZGVyOiAiU2VhcmNoIGNyeXB0byAoZS5nLiBiaXRjb2luKSIKICAgICAgICB9CiAgICAgICksCiAgICAgIGxvYWRpbmcgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoTG9hZGVyQ2lyY2xlLCB7IHNpemU6IDE0LCBzdHlsZTogeyBwb3NpdGlvbjogImFic29sdXRlIiwgcmlnaHQ6IDgsIHRvcDogIjUwJSIsIHRyYW5zZm9ybTogInRyYW5zbGF0ZVkoLTUwJSkiLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsIGFuaW1hdGlvbjogInNwaW4gMXMgbGluZWFyIGluZmluaXRlIiB9IH0pCiAgICBdIH0pLAogICAgc2hvd0Ryb3Bkb3duICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgIHBvc2l0aW9uOiAiYWJzb2x1dGUiLAogICAgICB0b3A6ICIxMDAlIiwKICAgICAgbGVmdDogMCwKICAgICAgcmlnaHQ6IDAsCiAgICAgIHpJbmRleDogNTAsCiAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5jYXJkLAogICAgICBib3JkZXJSYWRpdXM6IDgsCiAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsCiAgICAgIGJveFNoYWRvdzogIjAgNHB4IDEycHggcmdiYSgwLDAsMCwwLjEpIiwKICAgICAgbWF4SGVpZ2h0OiAyMDAsCiAgICAgIG92ZXJmbG93WTogImF1dG8iLAogICAgICBtYXJnaW5Ub3A6IDIKICAgIH0sIGNoaWxkcmVuOiByZXN1bHRzLm1hcCgoY29pbikgPT4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKAogICAgICAiYnV0dG9uIiwKICAgICAgewogICAgICAgIG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgIG9uU2VsZWN0KGNvaW4pOwogICAgICAgICAgc2V0UXVlcnkoIiIpOwogICAgICAgICAgc2V0U2hvd0Ryb3Bkb3duKGZhbHNlKTsKICAgICAgICAgIHNldFJlc3VsdHMoW10pOwogICAgICAgIH0sCiAgICAgICAgc3R5bGU6IHsKICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgIGdhcDogOCwKICAgICAgICAgIHBhZGRpbmc6ICI4cHggMTBweCIsCiAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogInRyYW5zcGFyZW50IiwKICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgdGV4dEFsaWduOiAibGVmdCIsCiAgICAgICAgICBmb250U2l6ZTogMTMsCiAgICAgICAgICBjb2xvcjogQ09MT1JTMi50ZXh0TWFpbiwKICAgICAgICAgIGJvcmRlckJvdHRvbTogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyTGlnaHR9YAogICAgICAgIH0sCiAgICAgICAgb25Nb3VzZUVudGVyOiAoZSkgPT4gewogICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IENPTE9SUzIuYXNzZXRCZzsKICAgICAgICB9LAogICAgICAgIG9uTW91c2VMZWF2ZTogKGUpID0+IHsKICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSAidHJhbnNwYXJlbnQiOwogICAgICAgIH0sCiAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJpbWciLCB7IHNyYzogY29pbi50aHVtYiwgYWx0OiAiIiwgc3R5bGU6IHsgd2lkdGg6IDIwLCBoZWlnaHQ6IDIwLCBib3JkZXJSYWRpdXM6IDEwIH0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNjAwIH0sIGNoaWxkcmVuOiBjb2luLm5hbWUgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUzIudGV4dE11dGVkLCBmb250U2l6ZTogMTEsIHRleHRUcmFuc2Zvcm06ICJ1cHBlcmNhc2UiIH0sIGNoaWxkcmVuOiBjb2luLnN5bWJvbCB9KQogICAgICAgIF0KICAgICAgfSwKICAgICAgY29pbi5pZAogICAgKSkgfSkKICBdIH0pOwp9Owp2YXIgU3RvY2tUaWNrZXJJbnB1dCA9ICh7IGRyYWZ0LCBzZXREcmFmdCwgaW5wdXRTdHlsZTogaW5wdXRTdHlsZTIsIGNvbG9yOiBjb2xvcjIgfSkgPT4gewogIGNvbnN0IFtmZXRjaGluZywgc2V0RmV0Y2hpbmddID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW3RpY2tlcklucHV0LCBzZXRUaWNrZXJJbnB1dF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGRyYWZ0LnRpY2tlciB8fCAiIik7CiAgY29uc3QgW3ByaWNlSW5wdXQsIHNldFByaWNlSW5wdXRdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShkcmFmdC5saXZlUHJpY2UgPyBTdHJpbmcoZHJhZnQubGl2ZVByaWNlKSA6ICIiKTsKICBjb25zdCBkZWJvdW5jZVJlZiA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VSZWYpKG51bGwpOwogIGNvbnN0IHJlY2FsY0Ftb3VudCA9IChwcmljZSwgcXR5KSA9PiBNYXRoLnJvdW5kKHByaWNlICogcXR5ICogMTAwKSAvIDEwMDsKICAoMCwgaW1wb3J0X3JlYWN0NTIudXNlRWZmZWN0KSgoKSA9PiB7CiAgICBpZiAoZGVib3VuY2VSZWYuY3VycmVudCkgY2xlYXJUaW1lb3V0KGRlYm91bmNlUmVmLmN1cnJlbnQpOwogICAgY29uc3Qgc3ltYm9sID0gdGlja2VySW5wdXQudHJpbSgpOwogICAgaWYgKHN5bWJvbC5sZW5ndGggPCAxKSB7CiAgICAgIHNldERyYWZ0KChkKSA9PiAoeyAuLi5kLCB0aWNrZXI6IHZvaWQgMCwgbGl2ZVByaWNlOiB2b2lkIDAsIG5hbWU6ICIiIH0pKTsKICAgICAgcmV0dXJuOwogICAgfQogICAgc2V0RHJhZnQoKGQpID0+ICh7IC4uLmQsIHRpY2tlcjogc3ltYm9sLCBuYW1lOiBzeW1ib2wgfSkpOwogICAgaWYgKHN5bWJvbC5sZW5ndGggPCAyKSByZXR1cm47CiAgICBkZWJvdW5jZVJlZi5jdXJyZW50ID0gc2V0VGltZW91dChhc3luYyAoKSA9PiB7CiAgICAgIHNldEZldGNoaW5nKHRydWUpOwogICAgICB0cnkgewogICAgICAgIGNvbnN0IHByaWNlcyA9IGF3YWl0IGZldGNoU3RvY2tQcmljZXMoW3N5bWJvbF0pOwogICAgICAgIGlmIChwcmljZXNbc3ltYm9sXSkgewogICAgICAgICAgY29uc3QgcHJpY2UgPSBwcmljZXNbc3ltYm9sXTsKICAgICAgICAgIHNldFByaWNlSW5wdXQoU3RyaW5nKHByaWNlKSk7CiAgICAgICAgICBzZXREcmFmdCgoZCkgPT4gewogICAgICAgICAgICBjb25zdCBuZXdBbW91bnQgPSBkLnF1YW50aXR5ID8gcmVjYWxjQW1vdW50KHByaWNlLCBkLnF1YW50aXR5KSA6IHByaWNlOwogICAgICAgICAgICByZXR1cm4geyAuLi5kLCBsaXZlUHJpY2U6IHByaWNlLCBhbW91bnQ6IG5ld0Ftb3VudCB9OwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9IGNhdGNoIHsKICAgICAgfQogICAgICBzZXRGZXRjaGluZyhmYWxzZSk7CiAgICB9LCA2MDApOwogICAgcmV0dXJuICgpID0+IHsKICAgICAgaWYgKGRlYm91bmNlUmVmLmN1cnJlbnQpIGNsZWFyVGltZW91dChkZWJvdW5jZVJlZi5jdXJyZW50KTsKICAgIH07CiAgfSwgW3RpY2tlcklucHV0XSk7CiAgY29uc3QgaGFzVGlja2VyID0gdGlja2VySW5wdXQudHJpbSgpLmxlbmd0aCA+PSAxOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMiwgZGlzcGxheTogImJsb2NrIiB9LCBjaGlsZHJlbjogIlRpY2tlciBTeW1ib2wiIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICJpbnB1dCIsCiAgICAgIHsKICAgICAgICBzdHlsZTogeyAuLi5pbnB1dFN0eWxlMiwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIgfSwKICAgICAgICB2YWx1ZTogdGlja2VySW5wdXQsCiAgICAgICAgb25DaGFuZ2U6IChlKSA9PiBzZXRUaWNrZXJJbnB1dChlLnRhcmdldC52YWx1ZS50b1VwcGVyQ2FzZSgpLnJlcGxhY2UoL1teQS1aLl0vZywgIiIpKSwKICAgICAgICBwbGFjZWhvbGRlcjogImUuZy4gQUFQTCwgVFNMQSwgVk9PIiwKICAgICAgICBhdXRvRm9jdXM6IHRydWUKICAgICAgfQogICAgKSwKICAgIGZldGNoaW5nICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGNvbG9yOiAiIzI1NjNFQiIsIG1hcmdpblRvcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAiTG9va2luZyB1cCAiLAogICAgICB0aWNrZXJJbnB1dCwKICAgICAgIi4uLiIKICAgIF0gfSksCiAgICBoYXNUaWNrZXIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJncmlkIiwgZ3JpZFRlbXBsYXRlQ29sdW1uczogIjFmciAxZnIiLCBnYXA6IDgsIG1hcmdpblRvcDogOCB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMiwgZGlzcGxheTogImJsb2NrIiB9LCBjaGlsZHJlbjogIlByaWNlIC8gU2hhcmUiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKAogICAgICAgICAgImlucHV0IiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IGlucHV0U3R5bGUyLAogICAgICAgICAgICB0eXBlOiAibnVtYmVyIiwKICAgICAgICAgICAgc3RlcDogImFueSIsCiAgICAgICAgICAgIHZhbHVlOiBwcmljZUlucHV0LAogICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHsKICAgICAgICAgICAgICBzZXRQcmljZUlucHV0KGUudGFyZ2V0LnZhbHVlKTsKICAgICAgICAgICAgICBjb25zdCBwcmljZSA9IHBhcnNlRmxvYXQoZS50YXJnZXQudmFsdWUpIHx8IDA7CiAgICAgICAgICAgICAgY29uc3QgcXR5ID0gZHJhZnQucXVhbnRpdHkgfHwgMDsKICAgICAgICAgICAgICBzZXREcmFmdCgoZCkgPT4gKHsgLi4uZCwgbGl2ZVByaWNlOiBwcmljZSB8fCB2b2lkIDAsIGFtb3VudDogcXR5ID4gMCAmJiBwcmljZSA+IDAgPyByZWNhbGNBbW91bnQocHJpY2UsIHF0eSkgOiBwcmljZSB9KSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAiJDAuMDAiCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMiwgZGlzcGxheTogImJsb2NrIiB9LCBjaGlsZHJlbjogIlNoYXJlcyIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogaW5wdXRTdHlsZTIsCiAgICAgICAgICAgIHR5cGU6ICJudW1iZXIiLAogICAgICAgICAgICBzdGVwOiAiYW55IiwKICAgICAgICAgICAgdmFsdWU6IGRyYWZ0LnF1YW50aXR5IHx8ICIiLAogICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHsKICAgICAgICAgICAgICBjb25zdCBxdHkgPSBwYXJzZUZsb2F0KGUudGFyZ2V0LnZhbHVlKSB8fCAwOwogICAgICAgICAgICAgIGNvbnN0IHByaWNlID0gcGFyc2VGbG9hdChwcmljZUlucHV0KSB8fCAwOwogICAgICAgICAgICAgIGNvbnN0IG5ld0Ftb3VudCA9IHF0eSA+IDAgJiYgcHJpY2UgPiAwID8gcmVjYWxjQW1vdW50KHByaWNlLCBxdHkpIDogZHJhZnQuYW1vdW50OwogICAgICAgICAgICAgIHNldERyYWZ0KChkKSA9PiAoeyAuLi5kLCBxdWFudGl0eTogcXR5IHx8IHZvaWQgMCwgYW1vdW50OiBuZXdBbW91bnQgfSkpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBwbGFjZWhvbGRlcjogIlF0eSIKICAgICAgICAgIH0KICAgICAgICApCiAgICAgIF0gfSkKICAgIF0gfSksCiAgICBoYXNUaWNrZXIgJiYgZHJhZnQubGl2ZVByaWNlICYmIGRyYWZ0LnF1YW50aXR5ICYmIGRyYWZ0LnF1YW50aXR5ID4gMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LCBtYXJnaW5Ub3A6IDYsIGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgcGFkZGluZzogIjZweCAxMHB4IiwgYmFja2dyb3VuZENvbG9yOiAiIzI1NjNFQjEwIiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6ICIxcHggc29saWQgIzI1NjNFQjMwIiB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoInNwYW4iLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgIlx1ezFGNEM4fSAiLAogICAgICAgIGRyYWZ0LnRpY2tlciwKICAgICAgICAiIFx4RDcgIiwKICAgICAgICBkcmFmdC5xdWFudGl0eQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzdHJvbmciLCB7IHN0eWxlOiB7IGNvbG9yOiBjb2xvcjIgfSwgY2hpbGRyZW46IGZtdChkcmFmdC5hbW91bnQpIH0pIH0pCiAgICBdIH0pCiAgXSB9KTsKfTsKdmFyIEl0ZW1Sb3cgPSAoeyBpdGVtLCBvblVwZGF0ZSwgb25EZWxldGUsIGlucHV0TW9kZSwgY29sb3I6IGNvbG9yMiB9KSA9PiB7CiAgY29uc3QgaXNOZXcgPSAhaXRlbS5hbW91bnQ7CiAgY29uc3QgW2VkaXRpbmcsIHNldEVkaXRpbmddID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShpc05ldyk7CiAgY29uc3QgW2RyYWZ0LCBzZXREcmFmdF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGl0ZW0pOwogICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VFZmZlY3QpKCgpID0+IHsKICAgIHNldERyYWZ0KGl0ZW0pOwogIH0sIFtpdGVtXSk7CiAgY29uc3Qgc2F2ZSA9ICgpID0+IHsKICAgIGNvbnN0IGZyZXEgPSBkcmFmdC5mcmVxdWVuY3kgfHwgKGlucHV0TW9kZSA9PT0gInJlY3VycmluZyIgPyAibW9udGhseSIgOiAib25lX3RpbWUiKTsKICAgIGxldCBhbW91bnQgPSBkcmFmdC5hbW91bnQ7CiAgICBpZiAoKGRyYWZ0LmFzc2V0VHlwZSA9PT0gImNyeXB0byIgfHwgZHJhZnQuYXNzZXRUeXBlID09PSAic3RvY2siKSAmJiBkcmFmdC50aWNrZXIgJiYgZHJhZnQubGl2ZVByaWNlICYmIGRyYWZ0LnF1YW50aXR5KSB7CiAgICAgIGFtb3VudCA9IE1hdGgucm91bmQoZHJhZnQubGl2ZVByaWNlICogZHJhZnQucXVhbnRpdHkgKiAxMDApIC8gMTAwOwogICAgfQogICAgY29uc3QgY29tcHV0ZWQgPSBjb21wdXRlVmFsdWVzKGFtb3VudCwgZnJlcSk7CiAgICBvblVwZGF0ZSh7IC4uLmRyYWZ0LCBhbW91bnQsIGZyZXF1ZW5jeTogZnJlcSwgLi4uY29tcHV0ZWQgfSk7CiAgICBzZXRFZGl0aW5nKGZhbHNlKTsKICB9OwogIGNvbnN0IGlucHV0U3R5bGUyID0gewogICAgcGFkZGluZzogIjhweCAxMHB4IiwKICAgIGJvcmRlclJhZGl1czogOCwKICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsCiAgICBmb250U2l6ZTogMTMsCiAgICB3aWR0aDogIjEwMCUiLAogICAgYm94U2l6aW5nOiAiYm9yZGVyLWJveCIsCiAgICBmb250RmFtaWx5OiAiaW5oZXJpdCIsCiAgICBvdXRsaW5lOiAibm9uZSIKICB9OwogIGNvbnN0IHNlbGVjdFN0eWxlID0gewogICAgLi4uaW5wdXRTdHlsZTIsCiAgICBhcHBlYXJhbmNlOiAibm9uZSIsCiAgICBiYWNrZ3JvdW5kSW1hZ2U6IGB1cmwoImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB3aWR0aD0nMTInIGhlaWdodD0nMTInIHZpZXdCb3g9JzAgMCAyNCAyNCcgZmlsbD0nbm9uZScgc3Ryb2tlPSclMjM5Q0EzQUYnIHN0cm9rZS13aWR0aD0nMiclM0UlM0NwYXRoIGQ9J002IDlsNiA2IDYtNicvJTNFJTNDL3N2ZyUzRSIpYCwKICAgIGJhY2tncm91bmRSZXBlYXQ6ICJuby1yZXBlYXQiLAogICAgYmFja2dyb3VuZFBvc2l0aW9uOiAicmlnaHQgOHB4IGNlbnRlciIsCiAgICBwYWRkaW5nUmlnaHQ6IDI0CiAgfTsKICBjb25zdCBmcmVxTGFiZWwgPSAoZikgPT4gZiA9PT0gIm1vbnRobHkiID8gIi9tbyIgOiBmID09PSAieWVhcmx5IiA/ICIveXIiIDogIiI7CiAgY29uc3QgaGFuZGxlQ29pblNlbGVjdCA9IGFzeW5jIChjb2luKSA9PiB7CiAgICBzZXREcmFmdCgoZCkgPT4gKHsgLi4uZCwgbmFtZTogY29pbi5uYW1lLCBhc3NldFR5cGU6ICJjcnlwdG8iLCB0aWNrZXI6IGNvaW4uaWQgfSkpOwogICAgdHJ5IHsKICAgICAgY29uc3QgcHJpY2VzID0gYXdhaXQgZmV0Y2hDcnlwdG9QcmljZXMoW2NvaW4uaWRdKTsKICAgICAgaWYgKHByaWNlc1tjb2luLmlkXSkgewogICAgICAgIHNldERyYWZ0KChkKSA9PiB7CiAgICAgICAgICBjb25zdCBwcmljZSA9IHByaWNlc1tjb2luLmlkXTsKICAgICAgICAgIGNvbnN0IG5ld0Ftb3VudCA9IGQucXVhbnRpdHkgPyBNYXRoLnJvdW5kKHByaWNlICogZC5xdWFudGl0eSAqIDEwMCkgLyAxMDAgOiBkLmFtb3VudDsKICAgICAgICAgIHJldHVybiB7IC4uLmQsIGxpdmVQcmljZTogcHJpY2UsIGFtb3VudDogbmV3QW1vdW50IH07CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0gY2F0Y2ggewogICAgfQogIH07CiAgaWYgKGVkaXRpbmcpIHsKICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogIjEwcHggMTJweCIsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5jYXJkLCBib3JkZXJSYWRpdXM6IDEwLCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLCBtYXJnaW5Cb3R0b206IDYgfSwgY2hpbGRyZW46IFsKICAgICAgaW5wdXRNb2RlID09PSAiYXNzZXQiICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogNiwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgb25DbGljazogKCkgPT4gc2V0RHJhZnQoKGQpID0+ICh7IC4uLmQsIGFzc2V0VHlwZTogImNyeXB0byIgfSkpLAogICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgIHBhZGRpbmc6ICI0cHggMTBweCIsCiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA2LAogICAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke2RyYWZ0LmFzc2V0VHlwZSA9PT0gImNyeXB0byIgPyAiI0Y3OTMxQSIgOiBDT0xPUlMyLmJvcmRlcn1gLAogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogZHJhZnQuYXNzZXRUeXBlID09PSAiY3J5cHRvIiA/ICIjRjc5MzFBMTUiIDogInRyYW5zcGFyZW50IiwKICAgICAgICAgICAgICBjb2xvcjogZHJhZnQuYXNzZXRUeXBlID09PSAiY3J5cHRvIiA/ICIjRjc5MzFBIiA6IENPTE9SUzIudGV4dFNlY29uZGFyeSwKICAgICAgICAgICAgICBmb250U2l6ZTogMTEsCiAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiAiXHUyMEJGIENyeXB0byIKICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHNldERyYWZ0KChkKSA9PiAoeyAuLi5kLCBhc3NldFR5cGU6ICJzdG9jayIsIHRpY2tlcjogdm9pZCAwLCBsaXZlUHJpY2U6IHZvaWQgMCB9KSksCiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgcGFkZGluZzogIjRweCAxMHB4IiwKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDYsCiAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7ZHJhZnQuYXNzZXRUeXBlID09PSAic3RvY2siID8gIiMyNTYzRUIiIDogQ09MT1JTMi5ib3JkZXJ9YCwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGRyYWZ0LmFzc2V0VHlwZSA9PT0gInN0b2NrIiA/ICIjMjU2M0VCMTUiIDogInRyYW5zcGFyZW50IiwKICAgICAgICAgICAgICBjb2xvcjogZHJhZnQuYXNzZXRUeXBlID09PSAic3RvY2siID8gIiMyNTYzRUIiIDogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LAogICAgICAgICAgICAgIGZvbnRTaXplOiAxMSwKICAgICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2hpbGRyZW46ICJcdXsxRjRDOH0gU3RvY2siCiAgICAgICAgICB9CiAgICAgICAgKSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXREcmFmdCgoZCkgPT4gKHsgLi4uZCwgYXNzZXRUeXBlOiB2b2lkIDAsIHRpY2tlcjogdm9pZCAwLCBsaXZlUHJpY2U6IHZvaWQgMCB9KSksCiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgcGFkZGluZzogIjRweCAxMHB4IiwKICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDYsCiAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7IWRyYWZ0LmFzc2V0VHlwZSB8fCBkcmFmdC5hc3NldFR5cGUgPT09ICJtYW51YWwiID8gY29sb3IyIDogQ09MT1JTMi5ib3JkZXJ9YCwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICFkcmFmdC5hc3NldFR5cGUgfHwgZHJhZnQuYXNzZXRUeXBlID09PSAibWFudWFsIiA/IGAke2NvbG9yMn0xNWAgOiAidHJhbnNwYXJlbnQiLAogICAgICAgICAgICAgIGNvbG9yOiAhZHJhZnQuYXNzZXRUeXBlIHx8IGRyYWZ0LmFzc2V0VHlwZSA9PT0gIm1hbnVhbCIgPyBjb2xvcjIgOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksCiAgICAgICAgICAgICAgZm9udFNpemU6IDExLAogICAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIgogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGlsZHJlbjogIk1hbnVhbCIKICAgICAgICAgIH0KICAgICAgICApCiAgICAgIF0gfSksCiAgICAgIGlucHV0TW9kZSA9PT0gImFzc2V0IiAmJiBkcmFmdC5hc3NldFR5cGUgPT09ICJjcnlwdG8iICYmICFkcmFmdC50aWNrZXIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiU2VhcmNoIENyeXB0b2N1cnJlbmN5IiB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShDb2luU2VhcmNoRHJvcGRvd24sIHsgb25TZWxlY3Q6IGhhbmRsZUNvaW5TZWxlY3QsIGlucHV0U3R5bGU6IGlucHV0U3R5bGUyIH0pCiAgICAgIF0gfSksCiAgICAgIGlucHV0TW9kZSA9PT0gImFzc2V0IiAmJiBkcmFmdC5hc3NldFR5cGUgPT09ICJjcnlwdG8iICYmIGRyYWZ0LnRpY2tlciAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNiwgcGFkZGluZzogIjZweCAxMHB4IiwgYmFja2dyb3VuZENvbG9yOiAiI0Y3OTMxQTEwIiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6ICIxcHggc29saWQgI0Y3OTMxQTMwIiwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNjAwLCBjb2xvcjogIiNGNzkzMUEiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJcdTIwQkYgIiwKICAgICAgICAgICAgZHJhZnQubmFtZQogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgIigiLAogICAgICAgICAgICBkcmFmdC50aWNrZXIsCiAgICAgICAgICAgICIpIgogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHNldERyYWZ0KChkKSA9PiAoeyAuLi5kLCB0aWNrZXI6IHZvaWQgMCwgbmFtZTogIiIsIGxpdmVQcmljZTogdm9pZCAwIH0pKSwgc3R5bGU6IHsgbWFyZ2luTGVmdDogImF1dG8iLCBwYWRkaW5nOiAyLCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZDogIm5vbmUiLCBjdXJzb3I6ICJwb2ludGVyIiwgY29sb3I6IENPTE9SUzIudGV4dE11dGVkLCBkaXNwbGF5OiAiZmxleCIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFgsIHsgc2l6ZTogMTQgfSkgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiUXVhbnRpdHkiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImlucHV0IiwgeyBzdHlsZTogaW5wdXRTdHlsZTIsIHR5cGU6ICJudW1iZXIiLCBzdGVwOiAiYW55IiwgdmFsdWU6IGRyYWZ0LnF1YW50aXR5IHx8ICIiLCBvbkNoYW5nZTogKGUpID0+IHsKICAgICAgICAgICAgY29uc3QgcXR5ID0gcGFyc2VGbG9hdChlLnRhcmdldC52YWx1ZSkgfHwgMDsKICAgICAgICAgICAgY29uc3QgbmV3QW1vdW50ID0gZHJhZnQubGl2ZVByaWNlID8gTWF0aC5yb3VuZChkcmFmdC5saXZlUHJpY2UgKiBxdHkgKiAxMDApIC8gMTAwIDogZHJhZnQuYW1vdW50OwogICAgICAgICAgICBzZXREcmFmdCgoZCkgPT4gKHsgLi4uZCwgcXVhbnRpdHk6IHF0eSB8fCB2b2lkIDAsIGFtb3VudDogbmV3QW1vdW50IH0pKTsKICAgICAgICAgIH0sIHBsYWNlaG9sZGVyOiAiSG93IG1hbnk/IiwgYXV0b0ZvY3VzOiB0cnVlIH0pCiAgICAgICAgXSB9KSwKICAgICAgICBkcmFmdC5saXZlUHJpY2UgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LCBtYXJnaW5Ub3A6IDQsIGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJzcGFuIiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAiUHJpY2U6ICIsCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzdHJvbmciLCB7IGNoaWxkcmVuOiBmbXRQcmljZShkcmFmdC5saXZlUHJpY2UpIH0pLAogICAgICAgICAgICAiL3VuaXQiCiAgICAgICAgICBdIH0pLAogICAgICAgICAgZHJhZnQucXVhbnRpdHkgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoInNwYW4iLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJUb3RhbDogIiwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInN0cm9uZyIsIHsgc3R5bGU6IHsgY29sb3I6IGNvbG9yMiB9LCBjaGlsZHJlbjogZm10KGRyYWZ0LmxpdmVQcmljZSAqIGRyYWZ0LnF1YW50aXR5KSB9KQogICAgICAgICAgXSB9KSA6IG51bGwKICAgICAgICBdIH0pIDogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsIG1hcmdpblRvcDogNCB9LCBjaGlsZHJlbjogIkZldGNoaW5nIHByaWNlLi4uIiB9KQogICAgICBdIH0pLAogICAgICBpbnB1dE1vZGUgPT09ICJhc3NldCIgJiYgZHJhZnQuYXNzZXRUeXBlID09PSAic3RvY2siICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFN0b2NrVGlja2VySW5wdXQsIHsgZHJhZnQsIHNldERyYWZ0LCBpbnB1dFN0eWxlOiBpbnB1dFN0eWxlMiwgY29sb3I6IGNvbG9yMiB9KSwKICAgICAgKGlucHV0TW9kZSAhPT0gImFzc2V0IiB8fCAhZHJhZnQuYXNzZXRUeXBlIHx8IGRyYWZ0LmFzc2V0VHlwZSA9PT0gIm1hbnVhbCIpICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMiwgZGlzcGxheTogImJsb2NrIiB9LCBjaGlsZHJlbjogIk5hbWUiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJpbnB1dCIsIHsgYXV0b0ZvY3VzOiAhZHJhZnQubmFtZSwgc3R5bGU6IGlucHV0U3R5bGUyLCB2YWx1ZTogZHJhZnQubmFtZSwgb25DaGFuZ2U6IChlKSA9PiBzZXREcmFmdCh7IC4uLmRyYWZ0LCBuYW1lOiBlLnRhcmdldC52YWx1ZSB9KSwgcGxhY2Vob2xkZXI6ICJEZXNjcmlwdGlvbiIgfSkKICAgICAgXSB9KSwKICAgICAgaW5wdXRNb2RlID09PSAicmVjdXJyaW5nIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImdyaWQiLCBncmlkVGVtcGxhdGVDb2x1bW5zOiAiMWZyIDFmciIsIGdhcDogOCwgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgibGFiZWwiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMiwgZGlzcGxheTogImJsb2NrIiB9LCBjaGlsZHJlbjogIkFtb3VudCIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiaW5wdXQiLCB7IGF1dG9Gb2N1czogISFkcmFmdC5uYW1lLCBzdHlsZTogaW5wdXRTdHlsZTIsIHR5cGU6ICJudW1iZXIiLCB2YWx1ZTogZHJhZnQuYW1vdW50IHx8ICIiLCBvbkNoYW5nZTogKGUpID0+IHNldERyYWZ0KHsgLi4uZHJhZnQsIGFtb3VudDogcGFyc2VGbG9hdChlLnRhcmdldC52YWx1ZSkgfHwgMCB9KSwgcGxhY2Vob2xkZXI6ICIkMCIgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUzIudGV4dE11dGVkLCBtYXJnaW5Cb3R0b206IDIsIGRpc3BsYXk6ICJibG9jayIgfSwgY2hpbGRyZW46ICJGcmVxdWVuY3kiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJzZWxlY3QiLCB7IHN0eWxlOiBzZWxlY3RTdHlsZSwgdmFsdWU6IGRyYWZ0LmZyZXF1ZW5jeSB8fCAibW9udGhseSIsIG9uQ2hhbmdlOiAoZSkgPT4gc2V0RHJhZnQoeyAuLi5kcmFmdCwgZnJlcXVlbmN5OiBlLnRhcmdldC52YWx1ZSB9KSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoIm9wdGlvbiIsIHsgdmFsdWU6ICJtb250aGx5IiwgY2hpbGRyZW46ICJNb250aGx5IiB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoIm9wdGlvbiIsIHsgdmFsdWU6ICJ5ZWFybHkiLCBjaGlsZHJlbjogIlllYXJseSIgfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJvcHRpb24iLCB7IHZhbHVlOiAib25lX3RpbWUiLCBjaGlsZHJlbjogIk9uZS10aW1lIiB9KQogICAgICAgICAgXSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KSwKICAgICAgaW5wdXRNb2RlID09PSAiYXNzZXQiICYmICghZHJhZnQuYXNzZXRUeXBlIHx8IGRyYWZ0LmFzc2V0VHlwZSA9PT0gIm1hbnVhbCIpICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZ3JpZCIsIGdyaWRUZW1wbGF0ZUNvbHVtbnM6ICIxZnIgMWZyIiwgZ2FwOiA4LCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiVmFsdWUiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImlucHV0IiwgeyBhdXRvRm9jdXM6ICEhZHJhZnQubmFtZSwgc3R5bGU6IGlucHV0U3R5bGUyLCB0eXBlOiAibnVtYmVyIiwgdmFsdWU6IGRyYWZ0LmFtb3VudCB8fCAiIiwgb25DaGFuZ2U6IChlKSA9PiBzZXREcmFmdCh7IC4uLmRyYWZ0LCBhbW91bnQ6IHBhcnNlRmxvYXQoZS50YXJnZXQudmFsdWUpIHx8IDAgfSksIHBsYWNlaG9sZGVyOiAiJDAiIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJsYWJlbCIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiAyLCBkaXNwbGF5OiAiYmxvY2siIH0sIGNoaWxkcmVuOiAiUXVhbnRpdHkgKG9wdGlvbmFsKSIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiaW5wdXQiLCB7IHN0eWxlOiBpbnB1dFN0eWxlMiwgdHlwZTogIm51bWJlciIsIHN0ZXA6ICJhbnkiLCB2YWx1ZTogZHJhZnQucXVhbnRpdHkgfHwgIiIsIG9uQ2hhbmdlOiAoZSkgPT4gc2V0RHJhZnQoeyAuLi5kcmFmdCwgcXVhbnRpdHk6IHBhcnNlRmxvYXQoZS50YXJnZXQudmFsdWUpIHx8IHZvaWQgMCB9KSwgcGxhY2Vob2xkZXI6ICJRdHkiIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICBpbnB1dE1vZGUgPT09ICJ2YWx1ZV9vbmx5IiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImxhYmVsIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUzIudGV4dE11dGVkLCBtYXJnaW5Cb3R0b206IDIsIGRpc3BsYXk6ICJibG9jayIgfSwgY2hpbGRyZW46ICJWYWx1ZSIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImlucHV0IiwgeyBhdXRvRm9jdXM6ICEhZHJhZnQubmFtZSwgc3R5bGU6IGlucHV0U3R5bGUyLCB0eXBlOiAibnVtYmVyIiwgdmFsdWU6IGRyYWZ0LmFtb3VudCB8fCAiIiwgb25DaGFuZ2U6IChlKSA9PiBzZXREcmFmdCh7IC4uLmRyYWZ0LCBhbW91bnQ6IHBhcnNlRmxvYXQoZS50YXJnZXQudmFsdWUpIHx8IDAgfSksIHBsYWNlaG9sZGVyOiAiJDAiIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogNiwganVzdGlmeUNvbnRlbnQ6ICJmbGV4LWVuZCIgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICBpZiAoIWl0ZW0ubmFtZSAmJiAhaXRlbS5hbW91bnQpIHsKICAgICAgICAgICAgb25EZWxldGUoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNldERyYWZ0KGl0ZW0pOwogICAgICAgICAgICBzZXRFZGl0aW5nKGZhbHNlKTsKICAgICAgICAgIH0KICAgICAgICB9LCBzdHlsZTogeyBwYWRkaW5nOiAiNnB4IDEycHgiLCBib3JkZXJSYWRpdXM6IDYsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwgZm9udFNpemU6IDEyLCBjdXJzb3I6ICJwb2ludGVyIiwgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSB9LCBjaGlsZHJlbjogIkNhbmNlbCIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogc2F2ZSwgc3R5bGU6IHsgcGFkZGluZzogIjZweCAxMnB4IiwgYm9yZGVyUmFkaXVzOiA2LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiBjb2xvcjIsIGNvbG9yOiAid2hpdGUiLCBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIgfSwgY2hpbGRyZW46ICJTYXZlIiB9KQogICAgICBdIH0pCiAgICBdIH0pOwogIH0KICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICBkaXNwbGF5OiAiZmxleCIsCiAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsCiAgICBwYWRkaW5nOiAiMTBweCA2cHggMTBweCA0cHgiLAogICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLmNhcmQsCiAgICBib3JkZXJSYWRpdXM6IDEwLAogICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJMaWdodH1gLAogICAgbWFyZ2luQm90dG9tOiA0LAogICAgdHJhbnNpdGlvbjogImFsbCAwLjE1cyIKICB9LCBjaGlsZHJlbjogWwogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgY2xhc3NOYW1lOiAiZHJhZy1oYW5kbGUiLCBzdHlsZTogeyBwYWRkaW5nOiAiNHB4IDRweCIsIGN1cnNvcjogImdyYWIiLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsIGRpc3BsYXk6ICJmbGV4IiwgZmxleFNocmluazogMCB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoR3JpcFZlcnRpY2FsLCB7IHNpemU6IDE2IH0pIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZsZXg6IDEsIG1pbldpZHRoOiAwLCBwYWRkaW5nTGVmdDogNCB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBmb250V2VpZ2h0OiA1MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNYWluLCBvdmVyZmxvdzogImhpZGRlbiIsIHRleHRPdmVyZmxvdzogImVsbGlwc2lzIiwgd2hpdGVTcGFjZTogIm5vd3JhcCIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAgIGl0ZW0uYXNzZXRUeXBlID09PSAiY3J5cHRvIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBjb2xvcjogIiNGNzkzMUEiLCBmb250V2VpZ2h0OiA3MDAgfSwgY2hpbGRyZW46ICJcdTIwQkYiIH0pLAogICAgICAgIGl0ZW0uYXNzZXRUeXBlID09PSAic3RvY2siICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGNvbG9yOiAiIzI1NjNFQiIsIGZvbnRXZWlnaHQ6IDcwMCB9LCBjaGlsZHJlbjogIlx1ezFGNEM4fSIgfSksCiAgICAgICAgaXRlbS5uYW1lIHx8ICJVbm5hbWVkIgogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LCBkaXNwbGF5OiAiZmxleCIsIGdhcDogOCwgbWFyZ2luVG9wOiAyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgaXRlbS5xdWFudGl0eSAhPT0gdm9pZCAwICYmIGl0ZW0ucXVhbnRpdHkgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgic3BhbiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICJRdHk6ICIsCiAgICAgICAgICBpdGVtLnF1YW50aXR5CiAgICAgICAgXSB9KSwKICAgICAgICAoaXRlbS5hc3NldFR5cGUgPT09ICJjcnlwdG8iIHx8IGl0ZW0uYXNzZXRUeXBlID09PSAic3RvY2siKSAmJiBpdGVtLmxpdmVQcmljZSAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoInNwYW4iLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAiQCAiLAogICAgICAgICAgZm10UHJpY2UoaXRlbS5saXZlUHJpY2UpCiAgICAgICAgXSB9KSwKICAgICAgICBpbnB1dE1vZGUgPT09ICJyZWN1cnJpbmciICYmIGl0ZW0uZnJlcXVlbmN5ICE9PSAib25lX3RpbWUiICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgic3BhbiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgIGZtdChpdGVtLmFtb3VudCksCiAgICAgICAgICBmcmVxTGFiZWwoaXRlbS5mcmVxdWVuY3kpCiAgICAgICAgXSB9KSwKICAgICAgICBpbnB1dE1vZGUgPT09ICJyZWN1cnJpbmciICYmIGl0ZW0uZnJlcXVlbmN5ID09PSAieWVhcmx5IiAmJiBpdGVtLm1vbnRobHlWYWx1ZSA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJzcGFuIiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgIigiLAogICAgICAgICAgZm10KGl0ZW0ubW9udGhseVZhbHVlKSwKICAgICAgICAgICIvbW8pIgogICAgICAgIF0gfSksCiAgICAgICAgaW5wdXRNb2RlID09PSAicmVjdXJyaW5nIiAmJiBpdGVtLmZyZXF1ZW5jeSA9PT0gIm1vbnRobHkiICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgic3BhbiIsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICIoIiwKICAgICAgICAgIGZtdChpdGVtLnRvdGFsVmFsdWUpLAogICAgICAgICAgIi95cikiCiAgICAgICAgXSB9KQogICAgICBdIH0pCiAgICBdIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogOCB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTUsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IGNvbG9yMiwgd2hpdGVTcGFjZTogIm5vd3JhcCIgfSwgY2hpbGRyZW46IGZtdEV4YWN0KGl0ZW0udG90YWxWYWx1ZSkgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHNldEVkaXRpbmcodHJ1ZSksIHN0eWxlOiB7IHBhZGRpbmc6IDQsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kOiAibm9uZSIsIGN1cnNvcjogInBvaW50ZXIiLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsIGRpc3BsYXk6ICJmbGV4IiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoUGVuLCB7IHNpemU6IDE0IH0pIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBvbkRlbGV0ZSwgc3R5bGU6IHsgcGFkZGluZzogNCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmQ6ICJub25lIiwgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgZGlzcGxheTogImZsZXgiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShUcmFzaDIsIHsgc2l6ZTogMTQgfSkgfSkKICAgIF0gfSkKICBdIH0pOwp9Owp2YXIgQnVkZ2V0U2VjdGlvbiA9ICh7IHRpdGxlLCBpY29uLCBjb2xvcjogY29sb3IyLCBiZ0NvbG9yLCBpdGVtcywgb25VcGRhdGUsIG9uQWRkLCBvbkFkZFByZXNldCwgb25EZWxldGUsIG9uUmVvcmRlciwgaW5wdXRNb2RlLCBwcmVzZXRzLCBmb290ZXIgfSkgPT4gewogIGNvbnN0IFtpc09wZW4sIHNldElzT3Blbl0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbZHJhZ0lkeCwgc2V0RHJhZ0lkeF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKG51bGwpOwogIGNvbnN0IFtvdmVySWR4LCBzZXRPdmVySWR4XSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkobnVsbCk7CiAgY29uc3QgdG90YWwgPSBpdGVtcy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLnRvdGFsVmFsdWUsIDApOwogIGNvbnN0IHNob3dNb250aGx5ID0gaW5wdXRNb2RlID09PSAicmVjdXJyaW5nIjsKICBjb25zdCBtb250aGx5VG90YWwgPSBzaG93TW9udGhseSA/IGl0ZW1zLnJlZHVjZSgocywgaSkgPT4gcyArIGkubW9udGhseVZhbHVlLCAwKSA6IHZvaWQgMDsKICBjb25zdCBleGlzdGluZ05hbWVzID0gbmV3IFNldChpdGVtcy5tYXAoKGkpID0+IGkubmFtZS50b0xvd2VyQ2FzZSgpKSk7CiAgY29uc3QgYXZhaWxhYmxlUHJlc2V0cyA9IChwcmVzZXRzIHx8IFtdKS5maWx0ZXIoKHApID0+IHAucGVyc2lzdGVudCB8fCAhZXhpc3RpbmdOYW1lcy5oYXMocC5uYW1lLnRvTG93ZXJDYXNlKCkpKTsKICBjb25zdCBoYW5kbGVEcmFnU3RhcnQgPSAoZSwgaWR4KSA9PiB7CiAgICBzZXREcmFnSWR4KGlkeCk7CiAgICBlLmRhdGFUcmFuc2Zlci5lZmZlY3RBbGxvd2VkID0gIm1vdmUiOwogIH07CiAgY29uc3QgaGFuZGxlRHJhZ092ZXIgPSAoZSwgaWR4KSA9PiB7CiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICBlLmRhdGFUcmFuc2Zlci5kcm9wRWZmZWN0ID0gIm1vdmUiOwogICAgc2V0T3ZlcklkeChpZHgpOwogIH07CiAgY29uc3QgaGFuZGxlRHJvcCA9IChlLCBpZHgpID0+IHsKICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgIGlmIChkcmFnSWR4ICE9PSBudWxsICYmIGRyYWdJZHggIT09IGlkeCkgb25SZW9yZGVyKGRyYWdJZHgsIGlkeCk7CiAgICBzZXREcmFnSWR4KG51bGwpOwogICAgc2V0T3ZlcklkeChudWxsKTsKICB9OwogIGNvbnN0IGhhbmRsZURyYWdFbmQgPSAoKSA9PiB7CiAgICBzZXREcmFnSWR4KG51bGwpOwogICAgc2V0T3ZlcklkeChudWxsKTsKICB9OwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiAxMiB9LCBjaGlsZHJlbjogWwogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgIFNlY3Rpb25IZWFkZXIsCiAgICAgIHsKICAgICAgICB0aXRsZSwKICAgICAgICBpY29uLAogICAgICAgIGNvbG9yOiBjb2xvcjIsCiAgICAgICAgYmdDb2xvciwKICAgICAgICB0b3RhbCwKICAgICAgICBtb250aGx5VG90YWwsCiAgICAgICAgY291bnQ6IGl0ZW1zLmxlbmd0aCwKICAgICAgICBpc09wZW4sCiAgICAgICAgb25Ub2dnbGU6ICgpID0+IHNldElzT3BlbighaXNPcGVuKQogICAgICB9CiAgICApLAogICAgaXNPcGVuICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAiMTBweCAxMnB4IDEycHgiLCBib3JkZXI6IGAxcHggc29saWQgJHtjb2xvcjJ9MjBgLCBib3JkZXJSYWRpdXM6ICIwIDAgMTJweCAxMnB4IiwgbWFyZ2luVG9wOiAtMiB9LCBjaGlsZHJlbjogWwogICAgICBpdGVtcy5tYXAoKGl0ZW0sIGlkeCkgPT4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgImRpdiIsCiAgICAgICAgewogICAgICAgICAgZHJhZ2dhYmxlOiB0cnVlLAogICAgICAgICAgb25EcmFnU3RhcnQ6IChlKSA9PiBoYW5kbGVEcmFnU3RhcnQoZSwgaWR4KSwKICAgICAgICAgIG9uRHJhZ092ZXI6IChlKSA9PiBoYW5kbGVEcmFnT3ZlcihlLCBpZHgpLAogICAgICAgICAgb25Ecm9wOiAoZSkgPT4gaGFuZGxlRHJvcChlLCBpZHgpLAogICAgICAgICAgb25EcmFnRW5kOiBoYW5kbGVEcmFnRW5kLAogICAgICAgICAgc3R5bGU6IHsgb3BhY2l0eTogZHJhZ0lkeCA9PT0gaWR4ID8gMC40IDogMSwgYm9yZGVyVG9wOiBvdmVySWR4ID09PSBpZHggJiYgZHJhZ0lkeCAhPT0gbnVsbCAmJiBkcmFnSWR4ICE9PSBpZHggPyBgMnB4IHNvbGlkICR7Y29sb3IyfWAgOiAiMnB4IHNvbGlkIHRyYW5zcGFyZW50IiwgdHJhbnNpdGlvbjogIm9wYWNpdHkgMC4xNXMiIH0sCiAgICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgICAgIEl0ZW1Sb3csCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBpdGVtLAogICAgICAgICAgICAgIGNvbG9yOiBjb2xvcjIsCiAgICAgICAgICAgICAgb25VcGRhdGU6ICh1KSA9PiBvblVwZGF0ZShpdGVtLmlkLCB1KSwKICAgICAgICAgICAgICBvbkRlbGV0ZTogKCkgPT4gb25EZWxldGUoaXRlbS5pZCksCiAgICAgICAgICAgICAgaW5wdXRNb2RlCiAgICAgICAgICAgIH0KICAgICAgICAgICkKICAgICAgICB9LAogICAgICAgIGl0ZW0uaWQKICAgICAgKSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDEyLCBtYXJnaW5Cb3R0b206IDYgfSwgY2hpbGRyZW46IFsKICAgICAgICBhdmFpbGFibGVQcmVzZXRzLmxlbmd0aCA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgbWFyZ2luQm90dG9tOiA2LCBwYWRkaW5nTGVmdDogMiB9LCBjaGlsZHJlbjogIlF1aWNrIGFkZDoiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGZsZXhXcmFwOiAid3JhcCIsIGdhcDogNiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgYXZhaWxhYmxlUHJlc2V0cy5tYXAoKHApID0+IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgKICAgICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiBvbkFkZFByZXNldChwLm5hbWUsIHAuYXNzZXRUeXBlKSwKICAgICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgICAgcGFkZGluZzogIjZweCAxMnB4IiwKICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMjAsCiAgICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtjb2xvcjJ9MzBgLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBgJHtiZ0NvbG9yfWAsCiAgICAgICAgICAgICAgICBjb2xvcjogY29sb3IyLAogICAgICAgICAgICAgICAgZm9udFNpemU6IDEyLAogICAgICAgICAgICAgICAgZm9udFdlaWdodDogNTAwLAogICAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgIGdhcDogNCwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb246ICJhbGwgMC4xNXMiCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBvbk1vdXNlRW50ZXI6IChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnRhcmdldC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBgJHtjb2xvcjJ9MTVgOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgb25Nb3VzZUxlYXZlOiAoZSkgPT4gewogICAgICAgICAgICAgICAgZS50YXJnZXQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gYmdDb2xvcjsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgY2hpbGRyZW46IHAuZW1vamkgfSksCiAgICAgICAgICAgICAgICAiICIsCiAgICAgICAgICAgICAgICBwLm5hbWUKICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHAubmFtZQogICAgICAgICAgKSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoCiAgICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgb25DbGljazogb25BZGQsCiAgICAgICAgICAgICAgc3R5bGU6IHsKICAgICAgICAgICAgICAgIHBhZGRpbmc6ICI2cHggMTJweCIsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDIwLAogICAgICAgICAgICAgICAgYm9yZGVyOiBgMXB4IGRhc2hlZCAke2NvbG9yMn01MGAsCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ0cmFuc3BhcmVudCIsCiAgICAgICAgICAgICAgICBjb2xvcjogY29sb3IyLAogICAgICAgICAgICAgICAgZm9udFNpemU6IDEyLAogICAgICAgICAgICAgICAgZm9udFdlaWdodDogNTAwLAogICAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICAgIGdhcDogNCwKICAgICAgICAgICAgICAgIHRyYW5zaXRpb246ICJhbGwgMC4xNXMiCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBvbk1vdXNlRW50ZXI6IChlKSA9PiB7CiAgICAgICAgICAgICAgICBlLnRhcmdldC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBgJHtjb2xvcjJ9MTBgOwogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgb25Nb3VzZUxlYXZlOiAoZSkgPT4gewogICAgICAgICAgICAgICAgZS50YXJnZXQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gInRyYW5zcGFyZW50IjsKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShQbHVzLCB7IHNpemU6IDE0IH0pLAogICAgICAgICAgICAgICAgIiBDdXN0b20iCiAgICAgICAgICAgICAgXQogICAgICAgICAgICB9CiAgICAgICAgICApCiAgICAgICAgXSB9KQogICAgICBdIH0pLAogICAgICBmb290ZXIKICAgIF0gfSkKICBdIH0pOwp9Owp2YXIgU3VtbWFyeVNlY3Rpb24gPSAoeyBidWRnZXQgfSkgPT4gewogIGNvbnN0IHRvdGFsTW9udGhseUluY29tZSA9IGJ1ZGdldC5pbmNvbWUucmVkdWNlKChzLCBpKSA9PiBzICsgaS5tb250aGx5VmFsdWUsIDApOwogIGNvbnN0IHRvdGFsTW9udGhseUV4cGVuc2VzID0gYnVkZ2V0LmV4cGVuc2VzLnJlZHVjZSgocywgaSkgPT4gcyArIGkubW9udGhseVZhbHVlLCAwKTsKICBjb25zdCB0b3RhbE1vbnRobHlMaWFiaWxpdHlQYXltZW50cyA9IGJ1ZGdldC5saWFiaWxpdGllcy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLm1vbnRobHlWYWx1ZSwgMCk7CiAgY29uc3QgbW9udGhseU5ldCA9IHRvdGFsTW9udGhseUluY29tZSAtIHRvdGFsTW9udGhseUV4cGVuc2VzIC0gdG90YWxNb250aGx5TGlhYmlsaXR5UGF5bWVudHM7CiAgY29uc3QgYW5udWFsTmV0ID0gbW9udGhseU5ldCAqIDEyOwogIGNvbnN0IHRvdGFsTGlxdWlkQXNzZXRzID0gYnVkZ2V0LmFzc2V0cy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLnRvdGFsVmFsdWUsIDApOwogIGNvbnN0IHRvdGFsTm9uTGlxdWlkQXNzZXRzID0gYnVkZ2V0Lm5vbkxpcXVpZEFzc2V0cy5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLnRvdGFsVmFsdWUsIDApOwogIGNvbnN0IHRvdGFsUmV0aXJlbWVudCA9IGJ1ZGdldC5yZXRpcmVtZW50LnJlZHVjZSgocywgaSkgPT4gcyArIGkudG90YWxWYWx1ZSwgMCk7CiAgY29uc3Qgbm9uTGlxdWlkQXREaXNjb3VudCA9IHRvdGFsTm9uTGlxdWlkQXNzZXRzICogKDEgLSBidWRnZXQubm9uTGlxdWlkRGlzY291bnQgLyAxMDApOwogIGNvbnN0IG9uZVRpbWVMaWFiaWxpdGllcyA9IGJ1ZGdldC5saWFiaWxpdGllcy5maWx0ZXIoKGkpID0+IGkuZnJlcXVlbmN5ID09PSAib25lX3RpbWUiKS5yZWR1Y2UoKHMsIGkpID0+IHMgKyBpLnRvdGFsVmFsdWUsIDApOwogIGNvbnN0IHRvdGFsTGlhYmlsaXRpZXMgPSBidWRnZXQubGlhYmlsaXRpZXMucmVkdWNlKChzLCBpKSA9PiBzICsgaS50b3RhbFZhbHVlLCAwKTsKICBjb25zdCBsaXF1aWRBZnRlckxpYWJpbGl0aWVzID0gdG90YWxMaXF1aWRBc3NldHMgLSBvbmVUaW1lTGlhYmlsaXRpZXM7CiAgY29uc3QgbmV0V29ydGggPSBsaXF1aWRBZnRlckxpYWJpbGl0aWVzICsgbm9uTGlxdWlkQXREaXNjb3VudCArIHRvdGFsUmV0aXJlbWVudDsKICBjb25zdCBtb250aGx5QnVybiA9IHRvdGFsTW9udGhseUV4cGVuc2VzICsgdG90YWxNb250aGx5TGlhYmlsaXR5UGF5bWVudHMgLSB0b3RhbE1vbnRobHlJbmNvbWU7CiAgY29uc3QgbGlxdWlkRm9yUnVud2F5ID0gTWF0aC5tYXgoMCwgbGlxdWlkQWZ0ZXJMaWFiaWxpdGllcyk7CiAgY29uc3QgcnVud2F5TW9udGhzID0gbW9udGhseUJ1cm4gPiAwICYmIGxpcXVpZEZvclJ1bndheSA+IDAgPyBsaXF1aWRGb3JSdW53YXkgLyBtb250aGx5QnVybiA6IG51bGw7CiAgY29uc3QgcnVud2F5WWVhcnMgPSBydW53YXlNb250aHMgPyBydW53YXlNb250aHMgLyAxMiA6IG51bGw7CiAgY29uc3QgZXh0ZW5kZWRGb3JSdW53YXkgPSBsaXF1aWRGb3JSdW53YXkgKyBub25MaXF1aWRBdERpc2NvdW50OwogIGNvbnN0IGV4dFJ1bndheU1vbnRocyA9IG1vbnRobHlCdXJuID4gMCAmJiBleHRlbmRlZEZvclJ1bndheSA+IDAgPyBleHRlbmRlZEZvclJ1bndheSAvIG1vbnRobHlCdXJuIDogbnVsbDsKICBjb25zdCBleHRSdW53YXlZZWFycyA9IGV4dFJ1bndheU1vbnRocyA/IGV4dFJ1bndheU1vbnRocyAvIDEyIDogbnVsbDsKICBjb25zdCBzYXZpbmdzUmF0ZSA9IHRvdGFsTW9udGhseUluY29tZSA+IDAgPyBtb250aGx5TmV0IC8gdG90YWxNb250aGx5SW5jb21lICogMTAwIDogMDsKICBjb25zdCBpc1Bvc2l0aXZlID0gbW9udGhseU5ldCA+PSAwOwogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luVG9wOiAxNiB9LCBjaGlsZHJlbjogWwogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgYmFja2dyb3VuZENvbG9yOiBpc1Bvc2l0aXZlID8gQ09MT1JTMi5pbmNvbWVCZyA6IENPTE9SUzIuZXhwZW5zZUJnLAogICAgICBib3JkZXJSYWRpdXM6IDE2LAogICAgICBwYWRkaW5nOiAiMjBweCAxNnB4IiwKICAgICAgbWFyZ2luQm90dG9tOiAxMiwKICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7aXNQb3NpdGl2ZSA/IENPTE9SUzIuaW5jb21lIDogQ09MT1JTMi5leHBlbnNlfTIwYAogICAgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGdhcDogMTYsIGFsaWduSXRlbXM6ICJmbGV4LXN0YXJ0IiB9LCBjaGlsZHJlbjogWwogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZmxleDogMSB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LCB0ZXh0VHJhbnNmb3JtOiAidXBwZXJjYXNlIiwgbGV0dGVyU3BhY2luZzogMC41LCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46ICJNb250aGx5IENhc2ggRmxvdyIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImJhc2VsaW5lIiwgZ2FwOiA2LCBtYXJnaW5Cb3R0b206IDIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDI4LCBmb250V2VpZ2h0OiA4MDAsIGNvbG9yOiBpc1Bvc2l0aXZlID8gQ09MT1JTMi5wb3NpdGl2ZSA6IENPTE9SUzIubmVnYXRpdmUgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgbW9udGhseU5ldCA+PSAwID8gIisiIDogIiIsCiAgICAgICAgICAgIGZtdChtb250aGx5TmV0KQogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICIvbW8iIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LCBtYXJnaW5Cb3R0b206IDEwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICBhbm51YWxOZXQgPj0gMCA/ICIrIiA6ICIiLAogICAgICAgICAgZm10KGFubnVhbE5ldCksCiAgICAgICAgICAiIC95ZWFyIgogICAgICAgIF0gfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiAxMiwgZmxleFdyYXA6ICJ3cmFwIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgY29sb3I6IENPTE9SUzIudGV4dE11dGVkIH0sIGNoaWxkcmVuOiAiSW5jb21lIiB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTMi5pbmNvbWUgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICBmbXQodG90YWxNb250aGx5SW5jb21lKSwKICAgICAgICAgICAgICAiL21vIgogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgY29sb3I6IENPTE9SUzIudGV4dE11dGVkIH0sIGNoaWxkcmVuOiAiRXhwZW5zZXMiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLmV4cGVuc2UgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICBmbXQodG90YWxNb250aGx5RXhwZW5zZXMpLAogICAgICAgICAgICAgICIvbW8iCiAgICAgICAgICAgIF0gfSkKICAgICAgICAgIF0gfSksCiAgICAgICAgICB0b3RhbE1vbnRobHlMaWFiaWxpdHlQYXltZW50cyA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgY29sb3I6IENPTE9SUzIudGV4dE11dGVkIH0sIGNoaWxkcmVuOiAiTGlhYmlsaXRpZXMiIH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLmxpYWJpbGl0eSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIGZtdCh0b3RhbE1vbnRobHlMaWFiaWxpdHlQYXltZW50cyksCiAgICAgICAgICAgICAgIi9tbyIKICAgICAgICAgICAgXSB9KQogICAgICAgICAgXSB9KQogICAgICAgIF0gfSkKICAgICAgXSB9KSwKICAgICAgcnVud2F5TW9udGhzICE9PSBudWxsID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGJvcmRlckxlZnQ6IGAxcHggc29saWQgJHtpc1Bvc2l0aXZlID8gQ09MT1JTMi5pbmNvbWUgOiBDT0xPUlMyLmV4cGVuc2V9MjBgLCBwYWRkaW5nTGVmdDogMTYsIG1pbldpZHRoOiAxMjAgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA0LCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKENsb2NrLCB7IHNpemU6IDE0LCBjb2xvcjogQ09MT1JTMi5leHBlbnNlIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMSwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTMi5leHBlbnNlLCB0ZXh0VHJhbnNmb3JtOiAidXBwZXJjYXNlIiB9LCBjaGlsZHJlbjogIlJ1bndheSIgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMSB9LCBjaGlsZHJlbjogIkxpcXVpZCBvbmx5IiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAyMCwgZm9udFdlaWdodDogODAwLCBjb2xvcjogQ09MT1JTMi5leHBlbnNlIH0sIGNoaWxkcmVuOiBydW53YXlZZWFycyA+PSAxID8gYCR7cnVud2F5WWVhcnMudG9GaXhlZCgxKX0geXJzYCA6IGAke01hdGgucm91bmQocnVud2F5TW9udGhzKX0gbW9gIH0pCiAgICAgICAgXSB9KSwKICAgICAgICBleHRSdW53YXlNb250aHMgIT09IG51bGwgJiYgbm9uTGlxdWlkQXREaXNjb3VudCA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IG1hcmdpblRvcDogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsIG1hcmdpbkJvdHRvbTogMSB9LCBjaGlsZHJlbjogIisgTm9uLWxpcXVpZCBzb2xkIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAyMCwgZm9udFdlaWdodDogODAwLCBjb2xvcjogQ09MT1JTMi5ub25MaXF1aWQgfSwgY2hpbGRyZW46IGV4dFJ1bndheVllYXJzID49IDEgPyBgJHtleHRSdW53YXlZZWFycy50b0ZpeGVkKDEpfSB5cnNgIDogYCR7TWF0aC5yb3VuZChleHRSdW53YXlNb250aHMpfSBtb2AgfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSkgOiBpc1Bvc2l0aXZlICYmIG1vbnRobHlOZXQgPiAwID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGJvcmRlckxlZnQ6IGAxcHggc29saWQgJHtDT0xPUlMyLmluY29tZX0yMGAsIHBhZGRpbmdMZWZ0OiAxNiwgbWluV2lkdGg6IDEyMCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDQsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoQXJyb3dVcFJpZ2h0LCB7IHNpemU6IDE0LCBjb2xvcjogQ09MT1JTMi5pbmNvbWUgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDExLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLmluY29tZSwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIgfSwgY2hpbGRyZW46ICJHcm93dGgiIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTMi50ZXh0TWFpbiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInN0cm9uZyIsIHsgY2hpbGRyZW46IGZtdChhbm51YWxOZXQpIH0pLAogICAgICAgICAgIi95ciIKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTAsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksIG1hcmdpblRvcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgIjJ5cjogKyIsCiAgICAgICAgICBmbXQoYW5udWFsTmV0ICogMiksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnIiLCB7fSksCiAgICAgICAgICAiNXlyOiArIiwKICAgICAgICAgIGZtdChhbm51YWxOZXQgKiA1KQogICAgICAgIF0gfSkKICAgICAgXSB9KSA6IG51bGwKICAgIF0gfSkgfSksCiAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLmNhcmQsCiAgICAgIGJvcmRlclJhZGl1czogMTIsCiAgICAgIHBhZGRpbmc6ICIxNnB4IiwKICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJ9YCwKICAgICAgbWFyZ2luQm90dG9tOiAxMgogICAgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksIHRleHRUcmFuc2Zvcm06ICJ1cHBlcmNhc2UiLCBsZXR0ZXJTcGFjaW5nOiAwLjUsIG1hcmdpbkJvdHRvbTogMTIgfSwgY2hpbGRyZW46ICJBc3NldCBCcmVha2Rvd24iIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBmbGV4RGlyZWN0aW9uOiAiY29sdW1uIiwgZ2FwOiA2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgYWxpZ25JdGVtczogImNlbnRlciIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICJMaXF1aWQgYXNzZXRzIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUzIuYXNzZXQgfSwgY2hpbGRyZW46IGZtdEV4YWN0KHRvdGFsTGlxdWlkQXNzZXRzKSB9KQogICAgICAgIF0gfSksCiAgICAgICAgb25lVGltZUxpYWJpbGl0aWVzID4gMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgcGFkZGluZ0xlZnQ6IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQgfSwgY2hpbGRyZW46ICJcdTIyMTIgT25lLXRpbWUgZGVidHMiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUzIubGlhYmlsaXR5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJcdTIyMTIiLAogICAgICAgICAgICBmbXRFeGFjdChvbmVUaW1lTGlhYmlsaXRpZXMpCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgcGFkZGluZ0xlZnQ6IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICI9IExpcXVpZCBhdmFpbGFibGUiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNCwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogbGlxdWlkQWZ0ZXJMaWFiaWxpdGllcyA+PSAwID8gQ09MT1JTMi5wb3NpdGl2ZSA6IENPTE9SUzIubmVnYXRpdmUgfSwgY2hpbGRyZW46IGZtdEV4YWN0KGxpcXVpZEFmdGVyTGlhYmlsaXRpZXMpIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgYm9yZGVyVG9wOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJMaWdodH1gLCBtYXJnaW5Ub3A6IDQsIHBhZGRpbmdUb3A6IDYsIGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgYWxpZ25JdGVtczogImNlbnRlciIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICJOb24tbGlxdWlkIChhdCAiLAogICAgICAgICAgICBidWRnZXQubm9uTGlxdWlkRGlzY291bnQsCiAgICAgICAgICAgICIlIGRpc2NvdW50KSIKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLm5vbkxpcXVpZCB9LCBjaGlsZHJlbjogZm10RXhhY3Qobm9uTGlxdWlkQXREaXNjb3VudCkgfSkKICAgICAgICBdIH0pLAogICAgICAgIHRvdGFsUmV0aXJlbWVudCA+IDAgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgYWxpZ25JdGVtczogImNlbnRlciIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICI0MDFrIC8gUmV0aXJlbWVudCIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE0LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLnJldGlyZW1lbnQgfSwgY2hpbGRyZW46IGZtdEV4YWN0KHRvdGFsUmV0aXJlbWVudCkgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBib3JkZXJUb3A6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLCBtYXJnaW5Ub3A6IDQsIHBhZGRpbmdUb3A6IDgsIGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgYWxpZ25JdGVtczogImNlbnRlciIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTQsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUzIudGV4dE1haW4gfSwgY2hpbGRyZW46ICJOZXQgV29ydGgiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxOCwgZm9udFdlaWdodDogODAwLCBjb2xvcjogbmV0V29ydGggPj0gMCA/IENPTE9SUzIucG9zaXRpdmUgOiBDT0xPUlMyLm5lZ2F0aXZlIH0sIGNoaWxkcmVuOiBmbXRFeGFjdChuZXRXb3J0aCkgfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSkKICAgIF0gfSksCiAgICAoKCkgPT4gewogICAgICBjb25zdCBwcm9qZWN0aW9uWWVhcnMgPSAyMDsKICAgICAgY29uc3Qgc3RhcnRMaXF1aWQgPSBNYXRoLm1heCgwLCBsaXF1aWRBZnRlckxpYWJpbGl0aWVzKTsKICAgICAgY29uc3Qgc3RhcnRFeHQgPSBNYXRoLm1heCgwLCBuZXRXb3J0aCk7CiAgICAgIGNvbnN0IGRhdGEgPSBbXTsKICAgICAgY29uc3QgYW5udWFsQnVybiA9IG1vbnRobHlCdXJuICogMTI7CiAgICAgIGxldCBiYWxMaXF1aWQgPSBzdGFydExpcXVpZDsKICAgICAgbGV0IGJhbEV4dGVuZGVkID0gc3RhcnRFeHQ7CiAgICAgIGxldCBsaXF1aWRIaXRaZXJvID0gZmFsc2U7CiAgICAgIGxldCBleHRIaXRaZXJvID0gZmFsc2U7CiAgICAgIGZvciAobGV0IHlyID0gMDsgeXIgPD0gcHJvamVjdGlvblllYXJzOyB5cisrKSB7CiAgICAgICAgZGF0YS5wdXNoKHsKICAgICAgICAgIHllYXI6IHlyLAogICAgICAgICAgbGlxdWlkOiBNYXRoLnJvdW5kKE1hdGgubWF4KDAsIGJhbExpcXVpZCkpLAogICAgICAgICAgZXh0ZW5kZWQ6IG5vbkxpcXVpZEF0RGlzY291bnQgPiAwIHx8IHRvdGFsUmV0aXJlbWVudCA+IDAgPyBNYXRoLnJvdW5kKE1hdGgubWF4KDAsIGJhbEV4dGVuZGVkKSkgOiAwCiAgICAgICAgfSk7CiAgICAgICAgaWYgKG1vbnRobHlCdXJuID4gMCkgewogICAgICAgICAgYmFsTGlxdWlkIC09IGFubnVhbEJ1cm47CiAgICAgICAgICBiYWxFeHRlbmRlZCAtPSBhbm51YWxCdXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBiYWxMaXF1aWQgKz0gYW5udWFsTmV0OwogICAgICAgICAgYmFsRXh0ZW5kZWQgKz0gYW5udWFsTmV0OwogICAgICAgIH0KICAgICAgICBpZiAoYmFsTGlxdWlkIDw9IDApIGxpcXVpZEhpdFplcm8gPSB0cnVlOwogICAgICAgIGlmIChiYWxFeHRlbmRlZCA8PSAwKSBleHRIaXRaZXJvID0gdHJ1ZTsKICAgICAgICBpZiAobGlxdWlkSGl0WmVybyAmJiBleHRIaXRaZXJvKSBicmVhazsKICAgICAgfQogICAgICBjb25zdCBsaXF1aWRaZXJvWWVhciA9IG1vbnRobHlCdXJuID4gMCA/IGRhdGEuZmluZCgoZCwgaSkgPT4gaSA+IDAgJiYgZC5saXF1aWQgPT09IDApPy55ZWFyIDogbnVsbDsKICAgICAgY29uc3QgZXh0WmVyb1llYXIgPSBtb250aGx5QnVybiA+IDAgPyBkYXRhLmZpbmQoKGQsIGkpID0+IGkgPiAwICYmIGQuZXh0ZW5kZWQgPT09IDApPy55ZWFyIDogbnVsbDsKICAgICAgY29uc3QgbWF4VmFsID0gTWF0aC5tYXgoLi4uZGF0YS5tYXAoKGQpID0+IE1hdGgubWF4KGQubGlxdWlkLCBkLmV4dGVuZGVkKSkpOwogICAgICBjb25zdCBtaW5WYWwgPSBNYXRoLm1pbiguLi5kYXRhLm1hcCgoZCkgPT4gTWF0aC5taW4oZC5saXF1aWQsIGQuZXh0ZW5kZWQpKSk7CiAgICAgIGNvbnN0IGZvcm1hdFlBeGlzID0gKHZhbCkgPT4gewogICAgICAgIGlmIChNYXRoLmFicyh2YWwpID49IDFlNikgcmV0dXJuIGAkJHsodmFsIC8gMWU2KS50b0ZpeGVkKDEpfU1gOwogICAgICAgIGlmIChNYXRoLmFicyh2YWwpID49IDFlMykgcmV0dXJuIGAkJHsodmFsIC8gMWUzKS50b0ZpeGVkKDApfUtgOwogICAgICAgIHJldHVybiBgJCR7dmFsfWA7CiAgICAgIH07CiAgICAgIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuY2FyZCwKICAgICAgICBib3JkZXJSYWRpdXM6IDEyLAogICAgICAgIHBhZGRpbmc6ICIxNnB4IiwKICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLAogICAgICAgIG1hcmdpbkJvdHRvbTogMTIKICAgICAgfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksIHRleHRUcmFuc2Zvcm06ICJ1cHBlcmNhc2UiLCBsZXR0ZXJTcGFjaW5nOiAwLjUsIG1hcmdpbkJvdHRvbTogMTIgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIG1vbnRobHlCdXJuID4gMCA/ICJSdW53YXkgUHJvamVjdGlvbiIgOiAiV2VhbHRoIFByb2plY3Rpb24iLAogICAgICAgICAgIiBcdTIwMTQgIiwKICAgICAgICAgIHByb2plY3Rpb25ZZWFycywKICAgICAgICAgICIgWWVhcnMiCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBoZWlnaHQ6IDI0MCwgd2lkdGg6ICIxMDAlIiwgZm9udFNpemU6IDExIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShSZXNwb25zaXZlQ29udGFpbmVyLCB7IGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoQXJlYUNoYXJ0LCB7IGRhdGEsIG1hcmdpbjogeyB0b3A6IDEwLCByaWdodDogMTAsIGxlZnQ6IC0xMCwgYm90dG9tOiAwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRlZnMiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgibGluZWFyR3JhZGllbnQiLCB7IGlkOiAiZ3JhZExpcXVpZCIsIHgxOiAiMCIsIHkxOiAiMCIsIHgyOiAiMCIsIHkyOiAiMSIsIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInN0b3AiLCB7IG9mZnNldDogIjUlIiwgc3RvcENvbG9yOiBtb250aGx5QnVybiA+IDAgPyBDT0xPUlMyLmV4cGVuc2UgOiBDT0xPUlMyLmluY29tZSwgc3RvcE9wYWNpdHk6IDAuMTUgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInN0b3AiLCB7IG9mZnNldDogIjk1JSIsIHN0b3BDb2xvcjogbW9udGhseUJ1cm4gPiAwID8gQ09MT1JTMi5leHBlbnNlIDogQ09MT1JTMi5pbmNvbWUsIHN0b3BPcGFjaXR5OiAwIH0pCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgibGluZWFyR3JhZGllbnQiLCB7IGlkOiAiZ3JhZEV4dGVuZGVkIiwgeDE6ICIwIiwgeTE6ICIwIiwgeDI6ICIwIiwgeTI6ICIxIiwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3RvcCIsIHsgb2Zmc2V0OiAiNSUiLCBzdG9wQ29sb3I6IENPTE9SUzIubm9uTGlxdWlkLCBzdG9wT3BhY2l0eTogMC4xIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzdG9wIiwgeyBvZmZzZXQ6ICI5NSUiLCBzdG9wQ29sb3I6IENPTE9SUzIubm9uTGlxdWlkLCBzdG9wT3BhY2l0eTogMCB9KQogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoQ2FydGVzaWFuR3JpZCwgeyBzdHJva2VEYXNoYXJyYXk6ICIzIDMiLCB2ZXJ0aWNhbDogZmFsc2UsIHN0cm9rZTogQ09MT1JTMi5ib3JkZXJMaWdodCB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKAogICAgICAgICAgICBYQXhpcywKICAgICAgICAgICAgewogICAgICAgICAgICAgIGRhdGFLZXk6ICJ5ZWFyIiwKICAgICAgICAgICAgICB0aWNrOiB7IGZpbGw6IENPTE9SUzIudGV4dFNlY29uZGFyeSwgZm9udFNpemU6IDExIH0sCiAgICAgICAgICAgICAgdGlja0xpbmU6IGZhbHNlLAogICAgICAgICAgICAgIGF4aXNMaW5lOiB7IHN0cm9rZTogQ09MT1JTMi5ib3JkZXIgfSwKICAgICAgICAgICAgICB0aWNrRm9ybWF0dGVyOiAodikgPT4gYFlyICR7dn1gCiAgICAgICAgICAgIH0KICAgICAgICAgICksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgICAgICAgWUF4aXMsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICB0aWNrOiB7IGZpbGw6IENPTE9SUzIudGV4dFNlY29uZGFyeSwgZm9udFNpemU6IDExIH0sCiAgICAgICAgICAgICAgdGlja0Zvcm1hdHRlcjogZm9ybWF0WUF4aXMsCiAgICAgICAgICAgICAgdGlja0xpbmU6IGZhbHNlLAogICAgICAgICAgICAgIGF4aXNMaW5lOiBmYWxzZQogICAgICAgICAgICB9CiAgICAgICAgICApLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgICAgIFRvb2x0aXAsCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICBjb250ZW50OiAoeyBhY3RpdmUsIHBheWxvYWQsIGxhYmVsIH0pID0+IHsKICAgICAgICAgICAgICAgIGlmIChhY3RpdmUgJiYgcGF5bG9hZCAmJiBwYXlsb2FkLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICBjb25zdCBsaXEgPSBwYXlsb2FkLmZpbmQoKHApID0+IHAuZGF0YUtleSA9PT0gImxpcXVpZCIpPy52YWx1ZTsKICAgICAgICAgICAgICAgICAgY29uc3QgZXh0ID0gcGF5bG9hZC5maW5kKChwKSA9PiBwLmRhdGFLZXkgPT09ICJleHRlbmRlZCIpPy52YWx1ZTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIHBhZGRpbmc6IDEyLCBib3JkZXJSYWRpdXM6IDgsIGJveFNoYWRvdzogIjAgNHB4IDEycHggcmdiYSgwLDAsMCwwLjEpIiwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJ9YCwgZm9udFNpemU6IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRXZWlnaHQ6IDcwMCwgbWFyZ2luQm90dG9tOiA2LCBjb2xvcjogQ09MT1JTMi50ZXh0TWFpbiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgICAgICAgIlllYXIgIiwKICAgICAgICAgICAgICAgICAgICAgIGxhYmVsCiAgICAgICAgICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBnYXA6IDE2LCBtYXJnaW5Cb3R0b206IDMgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogbW9udGhseUJ1cm4gPiAwID8gQ09MT1JTMi5leHBlbnNlIDogQ09MT1JTMi5pbmNvbWUsIGZvbnRXZWlnaHQ6IDYwMCB9LCBjaGlsZHJlbjogIkxpcXVpZCIgfSksCiAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNzAwLCBjb2xvcjogbGlxID49IDAgPyBDT0xPUlMyLnBvc2l0aXZlIDogQ09MT1JTMi5uZWdhdGl2ZSB9LCBjaGlsZHJlbjogZm10KGxpcSkgfSkKICAgICAgICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgICAgICAgIG5vbkxpcXVpZEF0RGlzY291bnQgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGdhcDogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBjb2xvcjogQ09MT1JTMi5ub25MaXF1aWQsIGZvbnRXZWlnaHQ6IDYwMCB9LCBjaGlsZHJlbjogIisgTm9uLWxpcXVpZCIgfSksCiAgICAgICAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFdlaWdodDogNzAwLCBjb2xvcjogZXh0ID49IDAgPyBDT0xPUlMyLnBvc2l0aXZlIDogQ09MT1JTMi5uZWdhdGl2ZSB9LCBjaGlsZHJlbjogZm10KGV4dCkgfSkKICAgICAgICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgICAgICAgIF0gfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICksCiAgICAgICAgICBub25MaXF1aWRBdERpc2NvdW50ID4gMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShBcmVhLCB7IHR5cGU6ICJtb25vdG9uZSIsIGRhdGFLZXk6ICJleHRlbmRlZCIsIHN0cm9rZTogQ09MT1JTMi5ub25MaXF1aWQsIGZpbGw6ICJ1cmwoI2dyYWRFeHRlbmRlZCkiLCBzdHJva2VXaWR0aDogMiwgc3Ryb2tlRGFzaGFycmF5OiAiNSA1IiwgbmFtZTogIkV4dGVuZGVkIiB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKEFyZWEsIHsgdHlwZTogIm1vbm90b25lIiwgZGF0YUtleTogImxpcXVpZCIsIHN0cm9rZTogbW9udGhseUJ1cm4gPiAwID8gQ09MT1JTMi5leHBlbnNlIDogQ09MT1JTMi5pbmNvbWUsIGZpbGw6ICJ1cmwoI2dyYWRMaXF1aWQpIiwgc3Ryb2tlV2lkdGg6IDIsIG5hbWU6ICJMaXF1aWQiIH0pCiAgICAgICAgXSB9KSB9KSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIGdhcDogMTYsIG1hcmdpblRvcDogOCwgZm9udFNpemU6IDExIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHdpZHRoOiAxNiwgaGVpZ2h0OiAzLCBiYWNrZ3JvdW5kQ29sb3I6IG1vbnRobHlCdXJuID4gMCA/IENPTE9SUzIuZXhwZW5zZSA6IENPTE9SUzIuaW5jb21lLCBib3JkZXJSYWRpdXM6IDIgfSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICJMaXF1aWQgYXNzZXRzIiB9KQogICAgICAgICAgXSB9KSwKICAgICAgICAgIG5vbkxpcXVpZEF0RGlzY291bnQgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgd2lkdGg6IDE2LCBoZWlnaHQ6IDMsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5ub25MaXF1aWQsIGJvcmRlclJhZGl1czogMiwgYm9yZGVyVG9wOiAiMXB4IGRhc2hlZCIgfSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICIrIE5vbi1saXF1aWQgc29sZCIgfSkKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pLAogICAgICAgIG1vbnRobHlCdXJuID4gMCAmJiAobGlxdWlkWmVyb1llYXIgfHwgZXh0WmVyb1llYXIpICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDgsIHBhZGRpbmc6ICI4cHggMTJweCIsIGJvcmRlclJhZGl1czogOCwgYmFja2dyb3VuZENvbG9yOiBgJHtDT0xPUlMyLmV4cGVuc2V9MDhgLCBmb250U2l6ZTogMTEsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIGxpcXVpZFplcm9ZZWFyICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAiTGlxdWlkIGFzc2V0cyBkZXBsZXRlZCBhdCAiLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoInN0cm9uZyIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUzIuZXhwZW5zZSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICJ5ZWFyICIsCiAgICAgICAgICAgICAgbGlxdWlkWmVyb1llYXIKICAgICAgICAgICAgXSB9KQogICAgICAgICAgXSB9KSwKICAgICAgICAgIGV4dFplcm9ZZWFyICYmIG5vbkxpcXVpZEF0RGlzY291bnQgPiAwICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAiQWxsIGFzc2V0cyBkZXBsZXRlZCBhdCAiLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoInN0cm9uZyIsIHsgc3R5bGU6IHsgY29sb3I6IENPTE9SUzIubm9uTGlxdWlkIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgInllYXIgIiwKICAgICAgICAgICAgICBleHRaZXJvWWVhcgogICAgICAgICAgICBdIH0pCiAgICAgICAgICBdIH0pCiAgICAgICAgXSB9KQogICAgICBdIH0pOwogICAgfSkoKQogIF0gfSk7Cn07CnZhciBoeWRyYXRlRnJvbUluaXRpYWxEYXRhID0gKGRhdGEpID0+IHsKICBpZiAoIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICJvYmplY3QiKSByZXR1cm4gbnVsbDsKICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZGF0YSkuZmlsdGVyKChrKSA9PiBrICE9PSAicmVhZHkiICYmIGsgIT09ICJ0aW1lc3RhbXAiICYmIGsgIT09ICJpbnB1dF9zb3VyY2UiICYmIGsgIT09ICJzdW1tYXJ5IiAmJiBrICE9PSAic3VnZ2VzdGVkX2ZvbGxvd3VwcyIpOwogIGlmIChrZXlzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGw7CiAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIEFwcGx5aW5nIGluaXRpYWxEYXRhOiIsIGRhdGEpOwogIGNvbnN0IGZpbmRPckFkZCA9IChhcnIsIG5hbWUsIGFtb3VudCwgZnJlcSA9ICJvbmVfdGltZSIpID0+IHsKICAgIGNvbnN0IGV4aXN0aW5nID0gYXJyLmZpbmQoKGkpID0+IGkubmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG93ZXJDYXNlKCkpOwogICAgaWYgKGV4aXN0aW5nKSB7CiAgICAgIGV4aXN0aW5nLmFtb3VudCA9IGFtb3VudDsKICAgICAgT2JqZWN0LmFzc2lnbihleGlzdGluZywgY29tcHV0ZVZhbHVlcyhhbW91bnQsIGV4aXN0aW5nLmZyZXF1ZW5jeSkpOwogICAgICByZXR1cm4gYXJyOwogICAgfQogICAgY29uc3QgaXRlbSA9IGZyZXEgPT09ICJvbmVfdGltZSIgPyBtaWEobmFtZSwgYW1vdW50KSA6IG1pKG5hbWUsIGFtb3VudCwgZnJlcSk7CiAgICByZXR1cm4gWy4uLmFyciwgaXRlbV07CiAgfTsKICBjb25zdCB1cHNlcnQgPSAoYXJyLCBuYW1lLCBhbW91bnQsIGZyZXEgPSAib25lX3RpbWUiKSA9PiB7CiAgICBjb25zdCBsYyA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgIGNvbnN0IGlkeCA9IGFyci5maW5kSW5kZXgoKGkpID0+IGkubmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKGxjKSB8fCBsYy5pbmNsdWRlcyhpLm5hbWUudG9Mb3dlckNhc2UoKSkpOwogICAgaWYgKGlkeCA+PSAwKSB7CiAgICAgIGNvbnN0IGl0ZW0yID0gYXJyW2lkeF07CiAgICAgIGFycltpZHhdID0geyAuLi5pdGVtMiwgYW1vdW50LCAuLi5jb21wdXRlVmFsdWVzKGFtb3VudCwgaXRlbTIuZnJlcXVlbmN5KSB9OwogICAgICByZXR1cm4gYXJyOwogICAgfQogICAgY29uc3QgaXRlbSA9IGZyZXEgPT09ICJvbmVfdGltZSIgPyBtaWEobmFtZSwgYW1vdW50KSA6IG1pKG5hbWUsIGFtb3VudCwgZnJlcSk7CiAgICByZXR1cm4gWy4uLmFyciwgaXRlbV07CiAgfTsKICBsZXQgYmFzZTsKICBpZiAoZGF0YS5wcmVzZXQpIHsKICAgIGNvbnN0IHByZXNldCA9IEJVREdFVF9QUkVTRVRTLmZpbmQoKHApID0+IHAua2V5ID09PSBkYXRhLnByZXNldCk7CiAgICBpZiAocHJlc2V0KSB7CiAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7CiAgICAgIGJhc2UgPSB7IC4uLmVtcHR5QnVkZ2V0KCksIC4uLnByZXNldC5idWRnZXQsIGlkOiBnZW5lcmF0ZUlkKCksIGNyZWF0ZWRBdDogbm93LCB1cGRhdGVkQXQ6IG5vdyB9OwogICAgfSBlbHNlIHsKICAgICAgYmFzZSA9IGVtcHR5QnVkZ2V0KCk7CiAgICB9CiAgfSBlbHNlIHsKICAgIGJhc2UgPSBlbXB0eUJ1ZGdldCgpOwogIH0KICBpZiAoZGF0YS5idWRnZXRfbmFtZSkgYmFzZS5uYW1lID0gZGF0YS5idWRnZXRfbmFtZTsKICBpZiAoZGF0YS5pc191bmVtcGxveWVkKSB7CiAgICBpZiAoYmFzZS5pbmNvbWUubGVuZ3RoID4gMCkgewogICAgICBiYXNlLmluY29tZSA9IGJhc2UuaW5jb21lLm1hcCgoaSkgPT4gKHsgLi4uaSwgYW1vdW50OiAwLCAuLi5jb21wdXRlVmFsdWVzKDAsIGkuZnJlcXVlbmN5KSB9KSk7CiAgICB9CiAgICBpZiAoIWJhc2UuYXNzZXRzLnNvbWUoKGEpID0+IC9lbWVyZ2VuY3kvaS50ZXN0KGEubmFtZSkpKSB7CiAgICAgIGJhc2UuYXNzZXRzID0gZmluZE9yQWRkKGJhc2UuYXNzZXRzLCAiRW1lcmdlbmN5IEZ1bmQiLCAwKTsKICAgIH0KICB9CiAgaWYgKGRhdGEuaXNfaG9tZW93bmVyKSB7CiAgICBiYXNlLmV4cGVuc2VzID0gYmFzZS5leHBlbnNlcy5tYXAoKGkpID0+IHsKICAgICAgaWYgKC9cYnJlbnRcYi9pLnRlc3QoaS5uYW1lKSAmJiAhL21vcnRnYWdlL2kudGVzdChpLm5hbWUpKSB7CiAgICAgICAgcmV0dXJuIHsgLi4uaSwgbmFtZTogIk1vcnRnYWdlIFBheW1lbnQiIH07CiAgICAgIH0KICAgICAgcmV0dXJuIGk7CiAgICB9KTsKICB9CiAgaWYgKGRhdGEubnVtX2NoaWxkcmVuICYmIGRhdGEubnVtX2NoaWxkcmVuID4gMCkgewogICAgaWYgKCFiYXNlLmV4cGVuc2VzLnNvbWUoKGUpID0+IC9jaGlsZHxkYXljYXJlfGtpZHMvaS50ZXN0KGUubmFtZSkpKSB7CiAgICAgIGJhc2UuZXhwZW5zZXMgPSBmaW5kT3JBZGQoYmFzZS5leHBlbnNlcywgIkNoaWxkY2FyZSAvIERheWNhcmUiLCBkYXRhLm51bV9jaGlsZHJlbiAqIDgwMCwgIm1vbnRobHkiKTsKICAgIH0KICB9CiAgY29uc3QgZWZmZWN0aXZlTW9udGhseUluY29tZSA9IGRhdGEubW9udGhseV9pbmNvbWUgfHwgKGRhdGEuYW5udWFsX2luY29tZSA/IE1hdGgucm91bmQoZGF0YS5hbm51YWxfaW5jb21lIC8gMTIpIDogdm9pZCAwKTsKICBpZiAoZGF0YS5zYWxhcnkpIGJhc2UuaW5jb21lID0gdXBzZXJ0KGJhc2UuaW5jb21lLCAiU2FsYXJ5IiwgZGF0YS5zYWxhcnksICJtb250aGx5Iik7CiAgaWYgKGRhdGEuc2lkZV9pbmNvbWUpIGJhc2UuaW5jb21lID0gdXBzZXJ0KGJhc2UuaW5jb21lLCAiRnJlZWxhbmNlIC8gU2lkZSBIdXN0bGUiLCBkYXRhLnNpZGVfaW5jb21lLCAibW9udGhseSIpOwogIGlmIChkYXRhLnJlbnRhbF9pbmNvbWUpIGJhc2UuaW5jb21lID0gdXBzZXJ0KGJhc2UuaW5jb21lLCAiUmVudGFsIEluY29tZSIsIGRhdGEucmVudGFsX2luY29tZSwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5zb2NpYWxfc2VjdXJpdHkpIGJhc2UuaW5jb21lID0gdXBzZXJ0KGJhc2UuaW5jb21lLCAiU29jaWFsIFNlY3VyaXR5IiwgZGF0YS5zb2NpYWxfc2VjdXJpdHksICJtb250aGx5Iik7CiAgaWYgKGRhdGEucGVuc2lvbl9pbmNvbWUpIGJhc2UuaW5jb21lID0gdXBzZXJ0KGJhc2UuaW5jb21lLCAiUGVuc2lvbiIsIGRhdGEucGVuc2lvbl9pbmNvbWUsICJtb250aGx5Iik7CiAgaWYgKGRhdGEuaW52ZXN0bWVudF9pbmNvbWUpIGJhc2UuaW5jb21lID0gdXBzZXJ0KGJhc2UuaW5jb21lLCAiSW52ZXN0bWVudCBJbmNvbWUiLCBkYXRhLmludmVzdG1lbnRfaW5jb21lLCAibW9udGhseSIpOwogIGlmIChlZmZlY3RpdmVNb250aGx5SW5jb21lICYmICFkYXRhLnNhbGFyeSAmJiAhZGF0YS5zaWRlX2luY29tZSAmJiAhZGF0YS5yZW50YWxfaW5jb21lICYmICFkYXRhLnNvY2lhbF9zZWN1cml0eSAmJiAhZGF0YS5wZW5zaW9uX2luY29tZSkgewogICAgY29uc3QgY3VycmVudFRvdGFsID0gYmFzZS5pbmNvbWUucmVkdWNlKChzLCBpKSA9PiBzICsgaS5tb250aGx5VmFsdWUsIDApOwogICAgaWYgKGN1cnJlbnRUb3RhbCA+IDApIHsKICAgICAgY29uc3QgcmF0aW8gPSBlZmZlY3RpdmVNb250aGx5SW5jb21lIC8gY3VycmVudFRvdGFsOwogICAgICBiYXNlLmluY29tZSA9IGJhc2UuaW5jb21lLm1hcCgoaSkgPT4gewogICAgICAgIGNvbnN0IG5ld0FtdCA9IE1hdGgucm91bmQoaS5hbW91bnQgKiByYXRpbyk7CiAgICAgICAgcmV0dXJuIHsgLi4uaSwgYW1vdW50OiBuZXdBbXQsIC4uLmNvbXB1dGVWYWx1ZXMobmV3QW10LCBpLmZyZXF1ZW5jeSkgfTsKICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKGJhc2UuaW5jb21lLmxlbmd0aCA9PT0gMCkgewogICAgICBiYXNlLmluY29tZSA9IFttaSgiSW5jb21lIiwgZWZmZWN0aXZlTW9udGhseUluY29tZSldOwogICAgfQogIH0KICBpZiAoZGF0YS5yZW50KSBiYXNlLmV4cGVuc2VzID0gdXBzZXJ0KGJhc2UuZXhwZW5zZXMsICJSZW50IiwgZGF0YS5yZW50LCAibW9udGhseSIpOwogIGlmIChkYXRhLm1vcnRnYWdlX3BheW1lbnQpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIk1vcnRnYWdlIFBheW1lbnQiLCBkYXRhLm1vcnRnYWdlX3BheW1lbnQsICJtb250aGx5Iik7CiAgaWYgKGRhdGEudXRpbGl0aWVzKSBiYXNlLmV4cGVuc2VzID0gdXBzZXJ0KGJhc2UuZXhwZW5zZXMsICJVdGlsaXRpZXMiLCBkYXRhLnV0aWxpdGllcywgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5ncm9jZXJpZXMpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIkdyb2NlcmllcyIsIGRhdGEuZ3JvY2VyaWVzLCAibW9udGhseSIpOwogIGlmIChkYXRhLmNhcl9wYXltZW50KSBiYXNlLmV4cGVuc2VzID0gdXBzZXJ0KGJhc2UuZXhwZW5zZXMsICJDYXIgUGF5bWVudCIsIGRhdGEuY2FyX3BheW1lbnQsICJtb250aGx5Iik7CiAgaWYgKGRhdGEuY2FyX2luc3VyYW5jZSkgYmFzZS5leHBlbnNlcyA9IHVwc2VydChiYXNlLmV4cGVuc2VzLCAiQ2FyIEluc3VyYW5jZSIsIGRhdGEuY2FyX2luc3VyYW5jZSwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5oZWFsdGhfaW5zdXJhbmNlKSBiYXNlLmV4cGVuc2VzID0gdXBzZXJ0KGJhc2UuZXhwZW5zZXMsICJIZWFsdGggSW5zdXJhbmNlIiwgZGF0YS5oZWFsdGhfaW5zdXJhbmNlLCAibW9udGhseSIpOwogIGlmIChkYXRhLnBob25lX2JpbGwpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIlBob25lIEJpbGwiLCBkYXRhLnBob25lX2JpbGwsICJtb250aGx5Iik7CiAgaWYgKGRhdGEuaW50ZXJuZXQpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIkludGVybmV0IiwgZGF0YS5pbnRlcm5ldCwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5jaGlsZGNhcmUpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIkNoaWxkY2FyZSAvIERheWNhcmUiLCBkYXRhLmNoaWxkY2FyZSwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5zdWJzY3JpcHRpb25zKSBiYXNlLmV4cGVuc2VzID0gdXBzZXJ0KGJhc2UuZXhwZW5zZXMsICJTdWJzY3JpcHRpb25zIiwgZGF0YS5zdWJzY3JpcHRpb25zLCAibW9udGhseSIpOwogIGlmIChkYXRhLmRpbmluZ19vdXQpIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIkRpbmluZyBPdXQiLCBkYXRhLmRpbmluZ19vdXQsICJtb250aGx5Iik7CiAgaWYgKGRhdGEudHJhbnNwb3J0YXRpb24pIGJhc2UuZXhwZW5zZXMgPSB1cHNlcnQoYmFzZS5leHBlbnNlcywgIkdhcyAvIFRyYW5zcG9ydGF0aW9uIiwgZGF0YS50cmFuc3BvcnRhdGlvbiwgIm1vbnRobHkiKTsKICBpZiAoZGF0YS5tb250aGx5X2V4cGVuc2VzICYmICFkYXRhLnJlbnQgJiYgIWRhdGEubW9ydGdhZ2VfcGF5bWVudCAmJiAhZGF0YS5ncm9jZXJpZXMpIHsKICAgIGNvbnN0IGN1cnJlbnRUb3RhbCA9IGJhc2UuZXhwZW5zZXMucmVkdWNlKChzLCBpKSA9PiBzICsgaS5tb250aGx5VmFsdWUsIDApOwogICAgaWYgKGN1cnJlbnRUb3RhbCA+IDApIHsKICAgICAgY29uc3QgcmF0aW8gPSBkYXRhLm1vbnRobHlfZXhwZW5zZXMgLyBjdXJyZW50VG90YWw7CiAgICAgIGJhc2UuZXhwZW5zZXMgPSBiYXNlLmV4cGVuc2VzLm1hcCgoaSkgPT4gewogICAgICAgIGNvbnN0IG5ld0FtdCA9IE1hdGgucm91bmQoaS5hbW91bnQgKiByYXRpbyk7CiAgICAgICAgcmV0dXJuIHsgLi4uaSwgYW1vdW50OiBuZXdBbXQsIC4uLmNvbXB1dGVWYWx1ZXMobmV3QW10LCBpLmZyZXF1ZW5jeSkgfTsKICAgICAgfSk7CiAgICB9CiAgfQogIGlmIChkYXRhLmNoZWNraW5nX2JhbGFuY2UpIGJhc2UuYXNzZXRzID0gdXBzZXJ0KGJhc2UuYXNzZXRzLCAiQ2hlY2tpbmcgQWNjb3VudCIsIGRhdGEuY2hlY2tpbmdfYmFsYW5jZSk7CiAgaWYgKGRhdGEuc2F2aW5nc19iYWxhbmNlKSBiYXNlLmFzc2V0cyA9IHVwc2VydChiYXNlLmFzc2V0cywgIlNhdmluZ3MgQWNjb3VudCIsIGRhdGEuc2F2aW5nc19iYWxhbmNlKTsKICBpZiAoZGF0YS5lbWVyZ2VuY3lfZnVuZCkgYmFzZS5hc3NldHMgPSB1cHNlcnQoYmFzZS5hc3NldHMsICJFbWVyZ2VuY3kgRnVuZCIsIGRhdGEuZW1lcmdlbmN5X2Z1bmQpOwogIGlmIChkYXRhLmludmVzdG1lbnRfYmFsYW5jZSkgYmFzZS5hc3NldHMgPSB1cHNlcnQoYmFzZS5hc3NldHMsICJCcm9rZXJhZ2UgQWNjb3VudCIsIGRhdGEuaW52ZXN0bWVudF9iYWxhbmNlKTsKICBpZiAoZGF0YS5jcnlwdG9fdGlja2VycykgewogICAgY29uc3QgdGlja2VycyA9IGRhdGEuY3J5cHRvX3RpY2tlcnMuc3BsaXQoIiwiKS5tYXAoKHQpID0+IHQudHJpbSgpLnRvTG93ZXJDYXNlKCkpLmZpbHRlcihCb29sZWFuKTsKICAgIGZvciAoY29uc3QgdGlja2VyMiBvZiB0aWNrZXJzKSB7CiAgICAgIGNvbnN0IG5hbWUgPSB0aWNrZXIyLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgdGlja2VyMi5zbGljZSgxKTsKICAgICAgaWYgKCFiYXNlLmFzc2V0cy5zb21lKChhKSA9PiBhLnRpY2tlciA9PT0gdGlja2VyMikpIHsKICAgICAgICBiYXNlLmFzc2V0cy5wdXNoKHsgLi4ubWlhKG5hbWUsIDApLCBhc3NldFR5cGU6ICJjcnlwdG8iLCB0aWNrZXI6IHRpY2tlcjIsIHF1YW50aXR5OiB2b2lkIDAgfSk7CiAgICAgIH0KICAgIH0KICB9IGVsc2UgaWYgKGRhdGEuaGFzX2NyeXB0byB8fCBkYXRhLmNyeXB0b19iYWxhbmNlKSB7CiAgICBpZiAoIWJhc2UuYXNzZXRzLnNvbWUoKGEpID0+IGEuYXNzZXRUeXBlID09PSAiY3J5cHRvIiB8fCAvY3J5cHRvL2kudGVzdChhLm5hbWUpKSkgewogICAgICBiYXNlLmFzc2V0cy5wdXNoKHsgLi4ubWlhKCJDcnlwdG8gUG9ydGZvbGlvIiwgZGF0YS5jcnlwdG9fYmFsYW5jZSB8fCAwKSwgYXNzZXRUeXBlOiAiY3J5cHRvIiwgdGlja2VyOiAiYml0Y29pbiIgfSk7CiAgICB9IGVsc2UgaWYgKGRhdGEuY3J5cHRvX2JhbGFuY2UpIHsKICAgICAgYmFzZS5hc3NldHMgPSBiYXNlLmFzc2V0cy5tYXAoKGEpID0+IGEuYXNzZXRUeXBlID09PSAiY3J5cHRvIiB8fCAvY3J5cHRvL2kudGVzdChhLm5hbWUpID8geyAuLi5hLCBhbW91bnQ6IGRhdGEuY3J5cHRvX2JhbGFuY2UsIHRvdGFsVmFsdWU6IGRhdGEuY3J5cHRvX2JhbGFuY2UgfSA6IGEpOwogICAgfQogIH0KICBpZiAoZGF0YS5zdG9ja190aWNrZXJzKSB7CiAgICBjb25zdCB0aWNrZXJzID0gZGF0YS5zdG9ja190aWNrZXJzLnNwbGl0KCIsIikubWFwKCh0KSA9PiB0LnRyaW0oKS50b1VwcGVyQ2FzZSgpKS5maWx0ZXIoQm9vbGVhbik7CiAgICBmb3IgKGNvbnN0IHRpY2tlcjIgb2YgdGlja2VycykgewogICAgICBpZiAoIWJhc2UuYXNzZXRzLnNvbWUoKGEpID0+IGEudGlja2VyID09PSB0aWNrZXIyICYmIGEuYXNzZXRUeXBlID09PSAic3RvY2siKSkgewogICAgICAgIGJhc2UuYXNzZXRzLnB1c2goeyAuLi5taWEodGlja2VyMiwgMCksIGFzc2V0VHlwZTogInN0b2NrIiwgdGlja2VyOiB0aWNrZXIyLCBxdWFudGl0eTogdm9pZCAwIH0pOwogICAgICB9CiAgICB9CiAgfSBlbHNlIGlmIChkYXRhLmhhc19zdG9ja3MpIHsKICAgIGlmICghYmFzZS5hc3NldHMuc29tZSgoYSkgPT4gYS5hc3NldFR5cGUgPT09ICJzdG9jayIgfHwgL3N0b2NrfGJyb2tlcmFnZS9pLnRlc3QoYS5uYW1lKSkpIHsKICAgICAgYmFzZS5hc3NldHMucHVzaCh7IC4uLm1pYSgiU3RvY2tzL0Jyb2tlcmFnZSIsIDApLCBhc3NldFR5cGU6ICJzdG9jayIgfSk7CiAgICB9CiAgfQogIGlmIChkYXRhLmxpcXVpZF9hc3NldHMgJiYgIWRhdGEuY2hlY2tpbmdfYmFsYW5jZSAmJiAhZGF0YS5zYXZpbmdzX2JhbGFuY2UgJiYgIWRhdGEuZW1lcmdlbmN5X2Z1bmQpIHsKICAgIGNvbnN0IGxpcXVpZEl0ZW1zID0gYmFzZS5hc3NldHMuZmlsdGVyKChhKSA9PiAhYS5hc3NldFR5cGUgfHwgYS5hc3NldFR5cGUgPT09ICJtYW51YWwiKTsKICAgIGNvbnN0IGN1cnJlbnRUb3RhbCA9IGxpcXVpZEl0ZW1zLnJlZHVjZSgocywgaSkgPT4gcyArIGkudG90YWxWYWx1ZSwgMCk7CiAgICBpZiAoY3VycmVudFRvdGFsID4gMCkgewogICAgICBjb25zdCByYXRpbyA9IGRhdGEubGlxdWlkX2Fzc2V0cyAvIGN1cnJlbnRUb3RhbDsKICAgICAgYmFzZS5hc3NldHMgPSBiYXNlLmFzc2V0cy5tYXAoKGkpID0+IHsKICAgICAgICBpZiAoaS5hc3NldFR5cGUgJiYgaS5hc3NldFR5cGUgIT09ICJtYW51YWwiKSByZXR1cm4gaTsKICAgICAgICBjb25zdCBuZXdBbXQgPSBNYXRoLnJvdW5kKGkuYW1vdW50ICogcmF0aW8pOwogICAgICAgIHJldHVybiB7IC4uLmksIGFtb3VudDogbmV3QW10LCB0b3RhbFZhbHVlOiBuZXdBbXQsIG1vbnRobHlWYWx1ZTogMCB9OwogICAgICB9KTsKICAgIH0KICB9CiAgaWYgKGRhdGEuaG9tZV92YWx1ZSkgYmFzZS5ub25MaXF1aWRBc3NldHMgPSB1cHNlcnQoYmFzZS5ub25MaXF1aWRBc3NldHMsICJIb21lIFZhbHVlIiwgZGF0YS5ob21lX3ZhbHVlKTsKICBpZiAoZGF0YS5jYXJfdmFsdWUpIGJhc2Uubm9uTGlxdWlkQXNzZXRzID0gdXBzZXJ0KGJhc2Uubm9uTGlxdWlkQXNzZXRzLCAiQ2FyIFZhbHVlIiwgZGF0YS5jYXJfdmFsdWUpOwogIGlmIChkYXRhLmpld2VscnlfY29sbGVjdGlibGVzKSBiYXNlLm5vbkxpcXVpZEFzc2V0cyA9IHVwc2VydChiYXNlLm5vbkxpcXVpZEFzc2V0cywgIkpld2VscnkgLyBDb2xsZWN0aWJsZXMiLCBkYXRhLmpld2VscnlfY29sbGVjdGlibGVzKTsKICBpZiAoZGF0YS5idXNpbmVzc19lcXVpdHkpIGJhc2Uubm9uTGlxdWlkQXNzZXRzID0gdXBzZXJ0KGJhc2Uubm9uTGlxdWlkQXNzZXRzLCAiQnVzaW5lc3MgRXF1aXR5IiwgZGF0YS5idXNpbmVzc19lcXVpdHkpOwogIGlmIChkYXRhLm5vbmxpcXVpZF9hc3NldHMgJiYgIWRhdGEuaG9tZV92YWx1ZSAmJiAhZGF0YS5jYXJfdmFsdWUpIHsKICAgIGNvbnN0IGN1cnJlbnRUb3RhbCA9IGJhc2Uubm9uTGlxdWlkQXNzZXRzLnJlZHVjZSgocywgaSkgPT4gcyArIGkudG90YWxWYWx1ZSwgMCk7CiAgICBpZiAoY3VycmVudFRvdGFsID4gMCkgewogICAgICBjb25zdCByYXRpbyA9IGRhdGEubm9ubGlxdWlkX2Fzc2V0cyAvIGN1cnJlbnRUb3RhbDsKICAgICAgYmFzZS5ub25MaXF1aWRBc3NldHMgPSBiYXNlLm5vbkxpcXVpZEFzc2V0cy5tYXAoKGkpID0+IHsKICAgICAgICBjb25zdCBuZXdBbXQgPSBNYXRoLnJvdW5kKGkuYW1vdW50ICogcmF0aW8pOwogICAgICAgIHJldHVybiB7IC4uLmksIGFtb3VudDogbmV3QW10LCB0b3RhbFZhbHVlOiBuZXdBbXQsIG1vbnRobHlWYWx1ZTogMCB9OwogICAgICB9KTsKICAgIH0KICB9CiAgaWYgKGRhdGEubm9ubGlxdWlkX2Rpc2NvdW50ICE9PSB2b2lkIDApIGJhc2Uubm9uTGlxdWlkRGlzY291bnQgPSBkYXRhLm5vbmxpcXVpZF9kaXNjb3VudDsKICBpZiAoZGF0YS5iYWxhbmNlXzQwMWspIGJhc2UucmV0aXJlbWVudCA9IHVwc2VydChiYXNlLnJldGlyZW1lbnQsICI0MDFrIiwgZGF0YS5iYWxhbmNlXzQwMWspOwogIGlmIChkYXRhLnJvdGhfaXJhKSBiYXNlLnJldGlyZW1lbnQgPSB1cHNlcnQoYmFzZS5yZXRpcmVtZW50LCAiUm90aCBJUkEiLCBkYXRhLnJvdGhfaXJhKTsKICBpZiAoZGF0YS50cmFkaXRpb25hbF9pcmEpIGJhc2UucmV0aXJlbWVudCA9IHVwc2VydChiYXNlLnJldGlyZW1lbnQsICJUcmFkaXRpb25hbCBJUkEiLCBkYXRhLnRyYWRpdGlvbmFsX2lyYSk7CiAgaWYgKGRhdGEucGVuc2lvbl9mdW5kKSBiYXNlLnJldGlyZW1lbnQgPSB1cHNlcnQoYmFzZS5yZXRpcmVtZW50LCAiUGVuc2lvbiBGdW5kIiwgZGF0YS5wZW5zaW9uX2Z1bmQpOwogIGlmIChkYXRhLmJhbGFuY2VfNDAzYikgYmFzZS5yZXRpcmVtZW50ID0gdXBzZXJ0KGJhc2UucmV0aXJlbWVudCwgIjQwM2IiLCBkYXRhLmJhbGFuY2VfNDAzYik7CiAgaWYgKGRhdGEuc2VwX2lyYSkgYmFzZS5yZXRpcmVtZW50ID0gdXBzZXJ0KGJhc2UucmV0aXJlbWVudCwgIlNFUCBJUkEiLCBkYXRhLnNlcF9pcmEpOwogIGlmIChkYXRhLnJldGlyZW1lbnRfc2F2aW5ncyAmJiAhZGF0YS5iYWxhbmNlXzQwMWsgJiYgIWRhdGEucm90aF9pcmEgJiYgIWRhdGEudHJhZGl0aW9uYWxfaXJhKSB7CiAgICBjb25zdCBjdXJyZW50VG90YWwgPSBiYXNlLnJldGlyZW1lbnQucmVkdWNlKChzLCBpKSA9PiBzICsgaS50b3RhbFZhbHVlLCAwKTsKICAgIGlmIChjdXJyZW50VG90YWwgPiAwKSB7CiAgICAgIGNvbnN0IHJhdGlvID0gZGF0YS5yZXRpcmVtZW50X3NhdmluZ3MgLyBjdXJyZW50VG90YWw7CiAgICAgIGJhc2UucmV0aXJlbWVudCA9IGJhc2UucmV0aXJlbWVudC5tYXAoKGkpID0+IHsKICAgICAgICBjb25zdCBuZXdBbXQgPSBNYXRoLnJvdW5kKGkuYW1vdW50ICogcmF0aW8pOwogICAgICAgIHJldHVybiB7IC4uLmksIGFtb3VudDogbmV3QW10LCB0b3RhbFZhbHVlOiBuZXdBbXQsIG1vbnRobHlWYWx1ZTogMCB9OwogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoYmFzZS5yZXRpcmVtZW50Lmxlbmd0aCA9PT0gMCkgewogICAgICBiYXNlLnJldGlyZW1lbnQgPSBbbWlhKCJSZXRpcmVtZW50IFNhdmluZ3MiLCBkYXRhLnJldGlyZW1lbnRfc2F2aW5ncyldOwogICAgfQogIH0KICBpZiAoZGF0YS5tb3J0Z2FnZV9iYWxhbmNlKSBiYXNlLmxpYWJpbGl0aWVzID0gdXBzZXJ0KGJhc2UubGlhYmlsaXRpZXMsICJNb3J0Z2FnZSIsIGRhdGEubW9ydGdhZ2VfYmFsYW5jZSk7CiAgaWYgKGRhdGEuc3R1ZGVudF9sb2FucykgYmFzZS5saWFiaWxpdGllcyA9IHVwc2VydChiYXNlLmxpYWJpbGl0aWVzLCAiU3R1ZGVudCBMb2FucyIsIGRhdGEuc3R1ZGVudF9sb2Fucyk7CiAgaWYgKGRhdGEuY2FyX2xvYW4pIGJhc2UubGlhYmlsaXRpZXMgPSB1cHNlcnQoYmFzZS5saWFiaWxpdGllcywgIkNhciBMb2FuIiwgZGF0YS5jYXJfbG9hbik7CiAgaWYgKGRhdGEuY3JlZGl0X2NhcmRfZGVidCkgYmFzZS5saWFiaWxpdGllcyA9IHVwc2VydChiYXNlLmxpYWJpbGl0aWVzLCAiQ3JlZGl0IENhcmQgRGVidCIsIGRhdGEuY3JlZGl0X2NhcmRfZGVidCk7CiAgaWYgKGRhdGEucGVyc29uYWxfbG9hbikgYmFzZS5saWFiaWxpdGllcyA9IHVwc2VydChiYXNlLmxpYWJpbGl0aWVzLCAiUGVyc29uYWwgTG9hbiIsIGRhdGEucGVyc29uYWxfbG9hbik7CiAgaWYgKGRhdGEubWVkaWNhbF9kZWJ0KSBiYXNlLmxpYWJpbGl0aWVzID0gdXBzZXJ0KGJhc2UubGlhYmlsaXRpZXMsICJNZWRpY2FsIEJpbGxzIiwgZGF0YS5tZWRpY2FsX2RlYnQpOwogIGlmIChkYXRhLmxpYWJpbGl0aWVzICYmICFkYXRhLm1vcnRnYWdlX2JhbGFuY2UgJiYgIWRhdGEuc3R1ZGVudF9sb2FucyAmJiAhZGF0YS5jYXJfbG9hbiAmJiAhZGF0YS5jcmVkaXRfY2FyZF9kZWJ0KSB7CiAgICBjb25zdCBjdXJyZW50VG90YWwgPSBiYXNlLmxpYWJpbGl0aWVzLnJlZHVjZSgocywgaSkgPT4gcyArIGkudG90YWxWYWx1ZSwgMCk7CiAgICBpZiAoY3VycmVudFRvdGFsID4gMCkgewogICAgICBjb25zdCByYXRpbyA9IGRhdGEubGlhYmlsaXRpZXMgLyBjdXJyZW50VG90YWw7CiAgICAgIGJhc2UubGlhYmlsaXRpZXMgPSBiYXNlLmxpYWJpbGl0aWVzLm1hcCgoaSkgPT4gewogICAgICAgIGNvbnN0IG5ld0FtdCA9IE1hdGgucm91bmQoaS5hbW91bnQgKiByYXRpbyk7CiAgICAgICAgcmV0dXJuIHsgLi4uaSwgYW1vdW50OiBuZXdBbXQsIC4uLmNvbXB1dGVWYWx1ZXMobmV3QW10LCBpLmZyZXF1ZW5jeSkgfTsKICAgICAgfSk7CiAgICB9IGVsc2UgaWYgKGJhc2UubGlhYmlsaXRpZXMubGVuZ3RoID09PSAwKSB7CiAgICAgIGJhc2UubGlhYmlsaXRpZXMgPSBbbWlhKCJUb3RhbCBEZWJ0IiwgZGF0YS5saWFiaWxpdGllcyldOwogICAgfQogIH0KICByZXR1cm4gYmFzZTsKfTsKZnVuY3Rpb24gTXlCdWRnZXQoeyBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyIH0pIHsKICBjb25zdCBbc2Vzc2lvbiwgc2V0U2Vzc2lvbl0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKG51bGwpOwogIGNvbnN0IFtzaG93TG9naW5Nb2RhbCwgc2V0U2hvd0xvZ2luTW9kYWxdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW3NhdmVkQnVkZ2V0cywgc2V0U2F2ZWRCdWRnZXRzXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoKCkgPT4gbG9hZEJ1ZGdldHMoKSk7CiAgY29uc3QgW2N1cnJlbnRWaWV3LCBzZXRDdXJyZW50Vmlld10gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKCJidWRnZXQiKTsKICBjb25zdCBbYnVkZ2V0LCBzZXRCdWRnZXRdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSgoKSA9PiB7CiAgICBjb25zdCBoeWRyYXRlZCA9IGh5ZHJhdGVGcm9tSW5pdGlhbERhdGEoaW5pdGlhbERhdGEyKTsKICAgIGlmIChoeWRyYXRlZCkgcmV0dXJuIGh5ZHJhdGVkOwogICAgcmV0dXJuIGxvYWRDdXJyZW50QnVkZ2V0KCkgfHwgZW1wdHlCdWRnZXQoKTsKICB9KTsKICBjb25zdCBbZWRpdGluZ05hbWUsIHNldEVkaXRpbmdOYW1lXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoZmFsc2UpOwogIGNvbnN0IFtuYW1lSW5wdXQsIHNldE5hbWVJbnB1dF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGJ1ZGdldC5uYW1lKTsKICBjb25zdCBbcmVmcmVzaGluZywgc2V0UmVmcmVzaGluZ10gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBbc2hvd1N1YnNjcmliZU1vZGFsLCBzZXRTaG93U3Vic2NyaWJlTW9kYWxdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW3N1YnNjcmliZUVtYWlsLCBzZXRTdWJzY3JpYmVFbWFpbF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKCIiKTsKICBjb25zdCBbc3Vic2NyaWJlU3RhdHVzLCBzZXRTdWJzY3JpYmVTdGF0dXNdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSgiaWRsZSIpOwogIGNvbnN0IFtzdWJzY3JpYmVNZXNzYWdlLCBzZXRTdWJzY3JpYmVNZXNzYWdlXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFtzaG93RmVlZGJhY2tNb2RhbCwgc2V0U2hvd0ZlZWRiYWNrTW9kYWxdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW2ZlZWRiYWNrVGV4dCwgc2V0RmVlZGJhY2tUZXh0XSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFtmZWVkYmFja1N0YXR1cywgc2V0RmVlZGJhY2tTdGF0dXNdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSgiaWRsZSIpOwogIGNvbnN0IFtjb25maXJtRGlhbG9nLCBzZXRDb25maXJtRGlhbG9nXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkobnVsbCk7CiAgY29uc3QgW2Vuam95Vm90ZSwgc2V0RW5qb3lWb3RlXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkobnVsbCk7CiAgY29uc3QgW3Nob3dOYW1lQnVkZ2V0TW9kYWwsIHNldFNob3dOYW1lQnVkZ2V0TW9kYWxdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKShmYWxzZSk7CiAgY29uc3QgW25hbWVCdWRnZXRWYWx1ZSwgc2V0TmFtZUJ1ZGdldFZhbHVlXSA9ICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VTdGF0ZSkoIiIpOwogIGNvbnN0IFtzYXZlVG9hc3QsIHNldFNhdmVUb2FzdF0gPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlU3RhdGUpKGZhbHNlKTsKICBjb25zdCBjb250YWluZXJSZWYgPSAoMCwgaW1wb3J0X3JlYWN0NTIudXNlUmVmKShudWxsKTsKICBjb25zdCBbcGlsbFJpZ2h0LCBzZXRQaWxsUmlnaHRdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSgxNik7CiAgY29uc3QgW3N5bmNTdGF0dXMsIHNldFN5bmNTdGF0dXNdID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZVN0YXRlKSgiaWRsZSIpOwogICgwLCBpbXBvcnRfcmVhY3Q1Mi51c2VFZmZlY3QpKCgpID0+IHsKICAgIHNhdmVDdXJyZW50QnVkZ2V0KGJ1ZGdldCk7CiAgICBpZiAoc2Vzc2lvbiAmJiBzdXBhYmFzZSAmJiBidWRnZXQuaWQpIHsKICAgICAgc2V0U3luY1N0YXR1cygic3luY2luZyIpOwogICAgICBjb25zdCBzeW5jVG9DbG91ZCA9IGFzeW5jICgpID0+IHsKICAgICAgICB0cnkgewogICAgICAgICAgY29uc3QgeyBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2UuZnJvbSgiYnVkZ2V0cyIpLnVwc2VydCh7CiAgICAgICAgICAgIGlkOiBidWRnZXQuaWQsCiAgICAgICAgICAgIHVzZXJfaWQ6IHNlc3Npb24udXNlci5pZCwKICAgICAgICAgICAgYnVkZ2V0X2RhdGE6IGJ1ZGdldCwKICAgICAgICAgICAgdXBkYXRlZF9hdDogKC8qIEBfX1BVUkVfXyAqLyBuZXcgRGF0ZSgpKS50b0lTT1N0cmluZygpCiAgICAgICAgICB9KTsKICAgICAgICAgIGlmIChlcnJvcikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKCJTdXBhYmFzZSB1cHNlcnQgZXJyb3I6IiwgZXJyb3IubWVzc2FnZSwgZXJyb3IuZGV0YWlscywgZXJyb3IuaGludCk7CiAgICAgICAgICAgIHNldFN5bmNTdGF0dXMoImlkbGUiKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJCdWRnZXQgc3luY2VkIHRvIGNsb3VkOiIsIGJ1ZGdldC5pZCk7CiAgICAgICAgICAgIHNldFN5bmNTdGF0dXMoInN5bmNlZCIpOwogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byBzeW5jIGJ1ZGdldCB0byBjbG91ZCIsIGUpOwogICAgICAgICAgc2V0U3luY1N0YXR1cygiaWRsZSIpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgc3luY1RvQ2xvdWQoKTsKICAgIH0KICB9LCBbYnVkZ2V0LCBzZXNzaW9uXSk7CiAgKDAsIGltcG9ydF9yZWFjdDUyLnVzZUVmZmVjdCkoKCkgPT4gewogICAgaWYgKCFzdXBhYmFzZSkgcmV0dXJuOwogICAgY29uc3Qgc3luY1dpdGhDbG91ZCA9IGFzeW5jICh1c2VySWQpID0+IHsKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCB7IGRhdGE6IGNsb3VkUm93cywgZXJyb3I6IGZldGNoRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlLmZyb20oImJ1ZGdldHMiKS5zZWxlY3QoImlkLCBidWRnZXRfZGF0YSIpLmVxKCJ1c2VyX2lkIiwgdXNlcklkKTsKICAgICAgICBpZiAoZmV0Y2hFcnJvcikgewogICAgICAgICAgY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIGZldGNoIGNsb3VkIGJ1ZGdldHM6IiwgZmV0Y2hFcnJvci5tZXNzYWdlKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2xvdWRCdWRnZXRNYXAgPSAvKiBAX19QVVJFX18gKi8gbmV3IE1hcCgpOwogICAgICAgIGlmIChjbG91ZFJvd3MpIHsKICAgICAgICAgIGZvciAoY29uc3Qgcm93IG9mIGNsb3VkUm93cykgewogICAgICAgICAgICBjb25zdCBiID0gcm93LmJ1ZGdldF9kYXRhOwogICAgICAgICAgICBpZiAoIWIudXBkYXRlZEF0KSBiLnVwZGF0ZWRBdCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIGNsb3VkQnVkZ2V0TWFwLnNldChyb3cuaWQsIGIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBsb2NhbEJ1ZGdldHMgPSBsb2FkQnVkZ2V0cygpOwogICAgICAgIGNvbnN0IG1lcmdlZE1hcCA9IC8qIEBfX1BVUkVfXyAqLyBuZXcgTWFwKCk7CiAgICAgICAgZm9yIChjb25zdCBbaWQsIGJdIG9mIGNsb3VkQnVkZ2V0TWFwKSB7CiAgICAgICAgICBtZXJnZWRNYXAuc2V0KGlkLCBiKTsKICAgICAgICB9CiAgICAgICAgZm9yIChjb25zdCBsYiBvZiBsb2NhbEJ1ZGdldHMpIHsKICAgICAgICAgIGlmICghbGIuaWQpIGNvbnRpbnVlOwogICAgICAgICAgY29uc3QgZXhpc3RpbmcgPSBtZXJnZWRNYXAuZ2V0KGxiLmlkKTsKICAgICAgICAgIGlmICghZXhpc3RpbmcgfHwgbGIudXBkYXRlZEF0ICYmIGV4aXN0aW5nLnVwZGF0ZWRBdCAmJiBsYi51cGRhdGVkQXQgPiBleGlzdGluZy51cGRhdGVkQXQpIHsKICAgICAgICAgICAgbWVyZ2VkTWFwLnNldChsYi5pZCwgbGIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjb25zdCBtZXJnZWRCdWRnZXRzID0gQXJyYXkuZnJvbShtZXJnZWRNYXAudmFsdWVzKCkpOwogICAgICAgIGlmIChtZXJnZWRCdWRnZXRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGNvbnN0IHJvd3MgPSBtZXJnZWRCdWRnZXRzLm1hcCgoYikgPT4gKHsKICAgICAgICAgICAgaWQ6IGIuaWQsCiAgICAgICAgICAgIHVzZXJfaWQ6IHVzZXJJZCwKICAgICAgICAgICAgYnVkZ2V0X2RhdGE6IGIsCiAgICAgICAgICAgIHVwZGF0ZWRfYXQ6ICgvKiBAX19QVVJFX18gKi8gbmV3IERhdGUoKSkudG9JU09TdHJpbmcoKQogICAgICAgICAgfSkpOwogICAgICAgICAgY29uc3QgeyBlcnJvcjogdXBzZXJ0RXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlLmZyb20oImJ1ZGdldHMiKS51cHNlcnQocm93cyk7CiAgICAgICAgICBpZiAodXBzZXJ0RXJyb3IpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcigiRmFpbGVkIHRvIHN5bmMgYnVkZ2V0cyB0byBjbG91ZDoiLCB1cHNlcnRFcnJvci5tZXNzYWdlLCB1cHNlcnRFcnJvci5kZXRhaWxzKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBTeW5jZWQgJHtyb3dzLmxlbmd0aH0gYnVkZ2V0KHMpIHRvIGNsb3VkYCk7CiAgICAgICAgICB9CiAgICAgICAgICBzZXRTYXZlZEJ1ZGdldHMobWVyZ2VkQnVkZ2V0cyk7CiAgICAgICAgICBzYXZlQnVkZ2V0cyhtZXJnZWRCdWRnZXRzKTsKICAgICAgICAgIGNvbnN0IG1vc3RSZWNlbnQgPSBbLi4ubWVyZ2VkQnVkZ2V0c10uc29ydCgoYSwgYikgPT4gKGIudXBkYXRlZEF0IHx8IDApIC0gKGEudXBkYXRlZEF0IHx8IDApKVswXTsKICAgICAgICAgIGlmIChtb3N0UmVjZW50KSB7CiAgICAgICAgICAgIHNldEJ1ZGdldChtb3N0UmVjZW50KTsKICAgICAgICAgICAgc2F2ZUN1cnJlbnRCdWRnZXQobW9zdFJlY2VudCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcigiQ2xvdWQgc3luYyBmYWlsZWQ6IiwgZSk7CiAgICAgIH0KICAgIH07CiAgICBzdXBhYmFzZS5hdXRoLmdldFNlc3Npb24oKS50aGVuKCh7IGRhdGE6IHsgc2Vzc2lvbjogc2Vzc2lvbjIgfSB9KSA9PiB7CiAgICAgIHNldFNlc3Npb24oc2Vzc2lvbjIpOwogICAgICBpZiAoc2Vzc2lvbjIpIHN5bmNXaXRoQ2xvdWQoc2Vzc2lvbjIudXNlci5pZCk7CiAgICB9KTsKICAgIGNvbnN0IHsKICAgICAgZGF0YTogeyBzdWJzY3JpcHRpb24gfQogICAgfSA9IHN1cGFiYXNlLmF1dGgub25BdXRoU3RhdGVDaGFuZ2UoKF9ldmVudCwgc2Vzc2lvbjIpID0+IHsKICAgICAgc2V0U2Vzc2lvbihzZXNzaW9uMik7CiAgICAgIGlmIChzZXNzaW9uMikgc3luY1dpdGhDbG91ZChzZXNzaW9uMi51c2VyLmlkKTsKICAgIH0pOwogICAgcmV0dXJuICgpID0+IHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpOwogIH0sIFtdKTsKICAoMCwgaW1wb3J0X3JlYWN0NTIudXNlRWZmZWN0KSgoKSA9PiB7CiAgICB0cnkgewogICAgICBjb25zdCB2ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oImVuam95Vm90ZV9idWRnZXQiKTsKICAgICAgaWYgKHYgPT09ICJ1cCIgfHwgdiA9PT0gImRvd24iKSBzZXRFbmpveVZvdGUodik7CiAgICB9IGNhdGNoIHsKICAgIH0KICB9LCBbXSk7CiAgKDAsIGltcG9ydF9yZWFjdDUyLnVzZUVmZmVjdCkoKCkgPT4gewogICAgY29uc3QgdXBkYXRlID0gKCkgPT4gewogICAgICBpZiAoY29udGFpbmVyUmVmLmN1cnJlbnQpIHsKICAgICAgICBjb25zdCByZWN0ID0gY29udGFpbmVyUmVmLmN1cnJlbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgICAgc2V0UGlsbFJpZ2h0KE1hdGgubWF4KDE2LCB3aW5kb3cuaW5uZXJXaWR0aCAtIHJlY3QucmlnaHQgKyAxNikpOwogICAgICB9CiAgICB9OwogICAgdXBkYXRlKCk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicmVzaXplIiwgdXBkYXRlKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJzY3JvbGwiLCB1cGRhdGUpOwogICAgY29uc3Qgcm8gPSB0eXBlb2YgUmVzaXplT2JzZXJ2ZXIgIT09ICJ1bmRlZmluZWQiID8gbmV3IFJlc2l6ZU9ic2VydmVyKHVwZGF0ZSkgOiBudWxsOwogICAgaWYgKHJvICYmIGNvbnRhaW5lclJlZi5jdXJyZW50KSByby5vYnNlcnZlKGNvbnRhaW5lclJlZi5jdXJyZW50KTsKICAgIHJldHVybiAoKSA9PiB7CiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJyZXNpemUiLCB1cGRhdGUpOwogICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigic2Nyb2xsIiwgdXBkYXRlKTsKICAgICAgcm8/LmRpc2Nvbm5lY3QoKTsKICAgIH07CiAgfSwgW10pOwogIGNvbnN0IGhhbmRsZUVuam95Vm90ZSA9ICh2b3RlKSA9PiB7CiAgICBpZiAoZW5qb3lWb3RlKSByZXR1cm47CiAgICBzZXRFbmpveVZvdGUodm90ZSk7CiAgICB0cnkgewogICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgiZW5qb3lWb3RlX2J1ZGdldCIsIHZvdGUpOwogICAgfSBjYXRjaCB7CiAgICB9CiAgICB0cmFja0V2ZW50KCJlbmpveV92b3RlIiwgeyB2b3RlLCBidWRnZXROYW1lOiBidWRnZXQubmFtZSB8fCBudWxsIH0pOwogICAgc2V0U2hvd0ZlZWRiYWNrTW9kYWwodHJ1ZSk7CiAgfTsKICBjb25zdCByZWZyZXNoUHJpY2VzID0gKDAsIGltcG9ydF9yZWFjdDUyLnVzZUNhbGxiYWNrKShhc3luYyAoKSA9PiB7CiAgICB0cmFja0V2ZW50KCJyZWZyZXNoX3ByaWNlcyIsIHsgYnVkZ2V0TmFtZTogYnVkZ2V0Lm5hbWUgfHwgbnVsbCB9KTsKICAgIGNvbnN0IGFsbEl0ZW1zID0gWy4uLmJ1ZGdldC5hc3NldHMsIC4uLmJ1ZGdldC5ub25MaXF1aWRBc3NldHMsIC4uLmJ1ZGdldC5yZXRpcmVtZW50XTsKICAgIGNvbnN0IGNyeXB0b0l0ZW1zID0gYWxsSXRlbXMuZmlsdGVyKChpKSA9PiBpLmFzc2V0VHlwZSA9PT0gImNyeXB0byIgJiYgaS50aWNrZXIpOwogICAgY29uc3Qgc3RvY2tJdGVtcyA9IGFsbEl0ZW1zLmZpbHRlcigoaSkgPT4gaS5hc3NldFR5cGUgPT09ICJzdG9jayIgJiYgaS50aWNrZXIpOwogICAgaWYgKGNyeXB0b0l0ZW1zLmxlbmd0aCA9PT0gMCAmJiBzdG9ja0l0ZW1zLmxlbmd0aCA9PT0gMCkgcmV0dXJuOwogICAgc2V0UmVmcmVzaGluZyh0cnVlKTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IFtjcnlwdG9QcmljZXMsIHN0b2NrUHJpY2VzXSA9IGF3YWl0IFByb21pc2UuYWxsKFsKICAgICAgICBjcnlwdG9JdGVtcy5sZW5ndGggPiAwID8gZmV0Y2hDcnlwdG9QcmljZXMoWy4uLm5ldyBTZXQoY3J5cHRvSXRlbXMubWFwKChpKSA9PiBpLnRpY2tlcikpXSkgOiB7fSwKICAgICAgICBzdG9ja0l0ZW1zLmxlbmd0aCA+IDAgPyBmZXRjaFN0b2NrUHJpY2VzKFsuLi5uZXcgU2V0KHN0b2NrSXRlbXMubWFwKChpKSA9PiBpLnRpY2tlcikpXSkgOiB7fQogICAgICBdKTsKICAgICAgY29uc3QgYWxsUHJpY2VzID0geyAuLi5jcnlwdG9QcmljZXMsIC4uLnN0b2NrUHJpY2VzIH07CiAgICAgIHNldEJ1ZGdldCgoYikgPT4gewogICAgICAgIGNvbnN0IHVwZGF0ZVNlY3Rpb24gPSAoaXRlbXMpID0+IGl0ZW1zLm1hcCgoaXRlbSkgPT4gewogICAgICAgICAgaWYgKCFpdGVtLmFzc2V0VHlwZSB8fCBpdGVtLmFzc2V0VHlwZSA9PT0gIm1hbnVhbCIgfHwgIWl0ZW0udGlja2VyIHx8ICFhbGxQcmljZXNbaXRlbS50aWNrZXJdKSByZXR1cm4gaXRlbTsKICAgICAgICAgIGNvbnN0IG5ld1ByaWNlID0gYWxsUHJpY2VzW2l0ZW0udGlja2VyXTsKICAgICAgICAgIGNvbnN0IG5ld0Ftb3VudCA9IGl0ZW0ucXVhbnRpdHkgPyBNYXRoLnJvdW5kKG5ld1ByaWNlICogaXRlbS5xdWFudGl0eSAqIDEwMCkgLyAxMDAgOiBpdGVtLmFtb3VudDsKICAgICAgICAgIGNvbnN0IGNvbXB1dGVkID0gY29tcHV0ZVZhbHVlcyhuZXdBbW91bnQsIGl0ZW0uZnJlcXVlbmN5KTsKICAgICAgICAgIHJldHVybiB7IC4uLml0ZW0sIGxpdmVQcmljZTogbmV3UHJpY2UsIGFtb3VudDogbmV3QW1vdW50LCAuLi5jb21wdXRlZCB9OwogICAgICAgIH0pOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAuLi5iLAogICAgICAgICAgYXNzZXRzOiB1cGRhdGVTZWN0aW9uKGIuYXNzZXRzKSwKICAgICAgICAgIG5vbkxpcXVpZEFzc2V0czogdXBkYXRlU2VjdGlvbihiLm5vbkxpcXVpZEFzc2V0cyksCiAgICAgICAgICByZXRpcmVtZW50OiB1cGRhdGVTZWN0aW9uKGIucmV0aXJlbWVudCksCiAgICAgICAgICBsYXN0UHJpY2VSZWZyZXNoOiBEYXRlLm5vdygpLAogICAgICAgICAgdXBkYXRlZEF0OiBEYXRlLm5vdygpCiAgICAgICAgfTsKICAgICAgfSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIkZhaWxlZCB0byByZWZyZXNoIHByaWNlcyIsIGUpOwogICAgfSBmaW5hbGx5IHsKICAgICAgc2V0UmVmcmVzaGluZyhmYWxzZSk7CiAgICB9CiAgfSwgW2J1ZGdldC5hc3NldHMsIGJ1ZGdldC5ub25MaXF1aWRBc3NldHMsIGJ1ZGdldC5yZXRpcmVtZW50XSk7CiAgY29uc3QgdXBkYXRlSXRlbSA9IChzZWN0aW9uLCBpZCwgdXBkYXRlcykgPT4gewogICAgc2V0QnVkZ2V0KChiKSA9PiAoewogICAgICAuLi5iLAogICAgICBbc2VjdGlvbl06IGJbc2VjdGlvbl0ubWFwKChpdGVtKSA9PiBpdGVtLmlkID09PSBpZCA/IHsgLi4uaXRlbSwgLi4udXBkYXRlcyB9IDogaXRlbSksCiAgICAgIHVwZGF0ZWRBdDogRGF0ZS5ub3coKQogICAgfSkpOwogIH07CiAgY29uc3QgYWRkSXRlbSA9IChzZWN0aW9uLCBmcmVxID0gIm1vbnRobHkiKSA9PiB7CiAgICB0cmFja0V2ZW50KCJhZGRfaXRlbSIsIHsgc2VjdGlvbiwgZnJlcXVlbmN5OiBmcmVxLCBidWRnZXROYW1lOiBidWRnZXQubmFtZSB8fCBudWxsIH0pOwogICAgc2V0QnVkZ2V0KChiKSA9PiAoewogICAgICAuLi5iLAogICAgICBbc2VjdGlvbl06IFsuLi5iW3NlY3Rpb25dLCBlbXB0eUl0ZW0oZnJlcSldLAogICAgICB1cGRhdGVkQXQ6IERhdGUubm93KCkKICAgIH0pKTsKICB9OwogIGNvbnN0IGFkZFByZXNldEl0ZW0gPSAoc2VjdGlvbiwgbmFtZSwgZnJlcSA9ICJtb250aGx5IiwgYXNzZXRUeXBlKSA9PiB7CiAgICB0cmFja0V2ZW50KCJhZGRfcHJlc2V0X2l0ZW0iLCB7IHNlY3Rpb24sIHByZXNldE5hbWU6IG5hbWUsIGZyZXF1ZW5jeTogZnJlcSwgYXNzZXRUeXBlIH0pOwogICAgc2V0QnVkZ2V0KChiKSA9PiAoewogICAgICAuLi5iLAogICAgICBbc2VjdGlvbl06IFsuLi5iW3NlY3Rpb25dLCB7IC4uLmVtcHR5SXRlbShmcmVxKSwgbmFtZSwgLi4uYXNzZXRUeXBlID8geyBhc3NldFR5cGUgfSA6IHt9IH1dLAogICAgICB1cGRhdGVkQXQ6IERhdGUubm93KCkKICAgIH0pKTsKICB9OwogIGNvbnN0IHJlb3JkZXJJdGVtcyA9IChzZWN0aW9uLCBmcm9tSW5kZXgsIHRvSW5kZXgpID0+IHsKICAgIHNldEJ1ZGdldCgoYikgPT4gewogICAgICBjb25zdCBhcnIgPSBbLi4uYltzZWN0aW9uXV07CiAgICAgIGNvbnN0IFttb3ZlZF0gPSBhcnIuc3BsaWNlKGZyb21JbmRleCwgMSk7CiAgICAgIGFyci5zcGxpY2UodG9JbmRleCwgMCwgbW92ZWQpOwogICAgICByZXR1cm4geyAuLi5iLCBbc2VjdGlvbl06IGFyciwgdXBkYXRlZEF0OiBEYXRlLm5vdygpIH07CiAgICB9KTsKICB9OwogIGNvbnN0IGRlbGV0ZUl0ZW0gPSAoc2VjdGlvbiwgaWQpID0+IHsKICAgIHRyYWNrRXZlbnQoImRlbGV0ZV9pdGVtIiwgeyBzZWN0aW9uLCBidWRnZXROYW1lOiBidWRnZXQubmFtZSB8fCBudWxsIH0pOwogICAgc2V0QnVkZ2V0KChiKSA9PiAoewogICAgICAuLi5iLAogICAgICBbc2VjdGlvbl06IGJbc2VjdGlvbl0uZmlsdGVyKChpdGVtKSA9PiBpdGVtLmlkICE9PSBpZCksCiAgICAgIHVwZGF0ZWRBdDogRGF0ZS5ub3coKQogICAgfSkpOwogIH07CiAgY29uc3QgZG9TYXZlQnVkZ2V0ID0gKGJ1ZGdldFRvU2F2ZSkgPT4gewogICAgY29uc3QgdXBkYXRlZEJ1ZGdldCA9IHsgLi4uYnVkZ2V0VG9TYXZlLCB1cGRhdGVkQXQ6IERhdGUubm93KCkgfTsKICAgIGNvbnN0IGV4aXN0aW5nID0gbG9hZEJ1ZGdldHMoKTsKICAgIGNvbnN0IGlkeCA9IGV4aXN0aW5nLmZpbmRJbmRleCgoYikgPT4gYi5pZCA9PT0gdXBkYXRlZEJ1ZGdldC5pZCk7CiAgICBjb25zdCBpc05ldyA9IGlkeCA8IDA7CiAgICBpZiAoaWR4ID49IDApIHsKICAgICAgZXhpc3RpbmdbaWR4XSA9IHVwZGF0ZWRCdWRnZXQ7CiAgICB9IGVsc2UgewogICAgICBleGlzdGluZy5wdXNoKHVwZGF0ZWRCdWRnZXQpOwogICAgfQogICAgc2F2ZUJ1ZGdldHMoZXhpc3RpbmcpOwogICAgc2V0U2F2ZWRCdWRnZXRzKGV4aXN0aW5nKTsKICAgIHNldEJ1ZGdldCh1cGRhdGVkQnVkZ2V0KTsKICAgIHRyYWNrRXZlbnQoInNhdmVfYnVkZ2V0IiwgeyBidWRnZXROYW1lOiB1cGRhdGVkQnVkZ2V0Lm5hbWUsIGlzTmV3IH0pOwogICAgc2V0U2F2ZVRvYXN0KHRydWUpOwogICAgc2V0VGltZW91dCgoKSA9PiBzZXRTYXZlVG9hc3QoZmFsc2UpLCAxNTAwKTsKICB9OwogIGNvbnN0IGhhbmRsZVNhdmVCdWRnZXQgPSAoKSA9PiB7CiAgICBjb25zdCBpc0ZpcnN0U2F2ZSA9ICFzYXZlZEJ1ZGdldHMuc29tZSgoYikgPT4gYi5pZCA9PT0gYnVkZ2V0LmlkKTsKICAgIGlmIChpc0ZpcnN0U2F2ZSkgewogICAgICBjb25zdCBzdWdnZXN0ZWQgPSBidWRnZXQubmFtZSAhPT0gIk15IEJ1ZGdldCBQbGFuIiA/IGJ1ZGdldC5uYW1lIDogIiI7CiAgICAgIHNldE5hbWVCdWRnZXRWYWx1ZShzdWdnZXN0ZWQpOwogICAgICBzZXRTaG93TmFtZUJ1ZGdldE1vZGFsKHRydWUpOwogICAgfSBlbHNlIHsKICAgICAgZG9TYXZlQnVkZ2V0KGJ1ZGdldCk7CiAgICB9CiAgfTsKICBjb25zdCBzYXZlQnVkZ2V0VG9MaXN0ID0gKCkgPT4gewogICAgY29uc3QgZXhpc3RpbmcgPSBsb2FkQnVkZ2V0cygpOwogICAgY29uc3QgaWR4ID0gZXhpc3RpbmcuZmluZEluZGV4KChiKSA9PiBiLmlkID09PSBidWRnZXQuaWQpOwogICAgaWYgKGlkeCA+PSAwKSB7CiAgICAgIGV4aXN0aW5nW2lkeF0gPSB7IC4uLmJ1ZGdldCwgdXBkYXRlZEF0OiBEYXRlLm5vdygpIH07CiAgICB9IGVsc2UgewogICAgICBleGlzdGluZy5wdXNoKHsgLi4uYnVkZ2V0LCB1cGRhdGVkQXQ6IERhdGUubm93KCkgfSk7CiAgICB9CiAgICBzYXZlQnVkZ2V0cyhleGlzdGluZyk7CiAgICBzZXRTYXZlZEJ1ZGdldHMoZXhpc3RpbmcpOwogIH07CiAgY29uc3QgaGFuZGxlTmV3QnVkZ2V0ID0gKCkgPT4gewogICAgdHJhY2tFdmVudCgibmV3X2J1ZGdldCIpOwogICAgaWYgKGJ1ZGdldC5pbmNvbWUubGVuZ3RoID4gMCB8fCBidWRnZXQuZXhwZW5zZXMubGVuZ3RoID4gMCB8fCBidWRnZXQuYXNzZXRzLmxlbmd0aCA+IDApIHsKICAgICAgc2F2ZUJ1ZGdldFRvTGlzdCgpOwogICAgfQogICAgY29uc3QgbmV3QiA9IGVtcHR5QnVkZ2V0KCk7CiAgICBzZXRCdWRnZXQobmV3Qik7CiAgICBzZXROYW1lSW5wdXQobmV3Qi5uYW1lKTsKICAgIHNldEN1cnJlbnRWaWV3KCJidWRnZXQiKTsKICB9OwogIGNvbnN0IGhhbmRsZU9wZW5CdWRnZXQgPSAoYikgPT4gewogICAgdHJhY2tFdmVudCgib3Blbl9idWRnZXQiLCB7IGJ1ZGdldE5hbWU6IGIubmFtZSB8fCBudWxsIH0pOwogICAgaWYgKGJ1ZGdldC5pbmNvbWUubGVuZ3RoID4gMCB8fCBidWRnZXQuZXhwZW5zZXMubGVuZ3RoID4gMCB8fCBidWRnZXQuYXNzZXRzLmxlbmd0aCA+IDApIHsKICAgICAgc2F2ZUJ1ZGdldFRvTGlzdCgpOwogICAgfQogICAgc2V0QnVkZ2V0KGIpOwogICAgc2V0TmFtZUlucHV0KGIubmFtZSk7CiAgICBzYXZlQ3VycmVudEJ1ZGdldChiKTsKICAgIHNldEN1cnJlbnRWaWV3KCJidWRnZXQiKTsKICB9OwogIGNvbnN0IGhhbmRsZURlbGV0ZUJ1ZGdldCA9IChpZCkgPT4gewogICAgdHJhY2tFdmVudCgiZGVsZXRlX2J1ZGdldCIsIHsgYnVkZ2V0SWQ6IGlkIH0pOwogICAgY29uc3QgdXBkYXRlZCA9IHNhdmVkQnVkZ2V0cy5maWx0ZXIoKGIpID0+IGIuaWQgIT09IGlkKTsKICAgIHNhdmVCdWRnZXRzKHVwZGF0ZWQpOwogICAgc2V0U2F2ZWRCdWRnZXRzKHVwZGF0ZWQpOwogIH07CiAgY29uc3QgaGFuZGxlUmVzZXQgPSAoKSA9PiB7CiAgICBzZXRDb25maXJtRGlhbG9nKHsKICAgICAgbWVzc2FnZTogIkNsZWFyIGFsbCBidWRnZXQgZGF0YSBvbiB0aGUgY3VycmVudCBzY3JlZW4/IiwKICAgICAgb25Db25maXJtOiAoKSA9PiB7CiAgICAgICAgdHJhY2tFdmVudCgicmVzZXQiLCB7IGJ1ZGdldE5hbWU6IGJ1ZGdldC5uYW1lLCBpdGVtQ291bnQ6IGJ1ZGdldC5pbmNvbWUubGVuZ3RoICsgYnVkZ2V0LmV4cGVuc2VzLmxlbmd0aCArIGJ1ZGdldC5hc3NldHMubGVuZ3RoIH0pOwogICAgICAgIGNvbnN0IG5ld0IgPSBlbXB0eUJ1ZGdldCgpOwogICAgICAgIHNldEJ1ZGdldChuZXdCKTsKICAgICAgICBzZXROYW1lSW5wdXQobmV3Qi5uYW1lKTsKICAgICAgfQogICAgfSk7CiAgfTsKICBjb25zdCBoYW5kbGVTdWJzY3JpYmUgPSBhc3luYyAoKSA9PiB7CiAgICBpZiAoIXN1YnNjcmliZUVtYWlsIHx8ICFzdWJzY3JpYmVFbWFpbC5pbmNsdWRlcygiQCIpKSB7CiAgICAgIHNldFN1YnNjcmliZU1lc3NhZ2UoIlBsZWFzZSBlbnRlciBhIHZhbGlkIGVtYWlsLiIpOwogICAgICBzZXRTdWJzY3JpYmVTdGF0dXMoImVycm9yIik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHNldFN1YnNjcmliZVN0YXR1cygibG9hZGluZyIpOwogICAgdHJ5IHsKICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHtBUElfQkFTRX0vYXBpL3N1YnNjcmliZWAsIHsKICAgICAgICBtZXRob2Q6ICJQT1NUIiwKICAgICAgICBoZWFkZXJzOiB7ICJDb250ZW50LVR5cGUiOiAiYXBwbGljYXRpb24vanNvbiIgfSwKICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVtYWlsOiBzdWJzY3JpYmVFbWFpbCwgdG9waWNJZDogImJ1ZGdldC1wbGFubmVyLW5ld3MiLCB0b3BpY05hbWU6ICJCdWRnZXQgUGxhbm5lciBVcGRhdGVzIiB9KQogICAgICB9KTsKICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTsKICAgICAgaWYgKHJlc3BvbnNlLm9rICYmIGRhdGEuc3VjY2VzcykgewogICAgICAgIHNldFN1YnNjcmliZVN0YXR1cygic3VjY2VzcyIpOwogICAgICAgIHNldFN1YnNjcmliZU1lc3NhZ2UoZGF0YS5tZXNzYWdlKTsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgIHNldFNob3dTdWJzY3JpYmVNb2RhbChmYWxzZSk7CiAgICAgICAgICBzZXRTdWJzY3JpYmVFbWFpbCgiIik7CiAgICAgICAgICBzZXRTdWJzY3JpYmVTdGF0dXMoImlkbGUiKTsKICAgICAgICAgIHNldFN1YnNjcmliZU1lc3NhZ2UoIiIpOwogICAgICAgIH0sIDNlMyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJlcnJvciIpOwogICAgICAgIHNldFN1YnNjcmliZU1lc3NhZ2UoZGF0YS5lcnJvciB8fCAiRmFpbGVkIHRvIHN1YnNjcmliZS4iKTsKICAgICAgfQogICAgfSBjYXRjaCB7CiAgICAgIHNldFN1YnNjcmliZVN0YXR1cygiZXJyb3IiKTsKICAgICAgc2V0U3Vic2NyaWJlTWVzc2FnZSgiTmV0d29yayBlcnJvci4gUGxlYXNlIHRyeSBhZ2Fpbi4iKTsKICAgIH0KICB9OwogIGNvbnN0IGhhbmRsZUZlZWRiYWNrU3VibWl0ID0gYXN5bmMgKCkgPT4gewogICAgaWYgKCFmZWVkYmFja1RleHQudHJpbSgpKSByZXR1cm47CiAgICBzZXRGZWVkYmFja1N0YXR1cygic3VibWl0dGluZyIpOwogICAgdHJ5IHsKICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHtBUElfQkFTRX0vYXBpL3RyYWNrYCwgewogICAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICAgIGhlYWRlcnM6IHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXZlbnQ6ICJ1c2VyX2ZlZWRiYWNrIiwgZGF0YTogeyBmZWVkYmFjazogZmVlZGJhY2tUZXh0LCB0b29sOiAiYnVkZ2V0LXBsYW5uZXIiLCBidWRnZXROYW1lOiBidWRnZXQubmFtZSB8fCBudWxsIH0gfSkKICAgICAgfSk7CiAgICAgIGlmIChyZXNwb25zZS5vaykgewogICAgICAgIHNldEZlZWRiYWNrU3RhdHVzKCJzdWNjZXNzIik7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBzZXRTaG93RmVlZGJhY2tNb2RhbChmYWxzZSk7CiAgICAgICAgICBzZXRGZWVkYmFja1RleHQoIiIpOwogICAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoImlkbGUiKTsKICAgICAgICB9LCAyZTMpOwogICAgICB9IGVsc2UgewogICAgICAgIHNldEZlZWRiYWNrU3RhdHVzKCJlcnJvciIpOwogICAgICB9CiAgICB9IGNhdGNoIHsKICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoImVycm9yIik7CiAgICB9CiAgfTsKICBjb25zdCBoYW5kbGVCYWNrVG9Ib21lID0gKCkgPT4gewogICAgdHJhY2tFdmVudCgiYmFja190b19ob21lIik7CiAgICBzYXZlQnVkZ2V0VG9MaXN0KCk7CiAgICBzZXRDdXJyZW50VmlldygiaG9tZSIpOwogIH07CiAgY29uc3QgaGFuZGxlUHJpbnQgPSAoKSA9PiB7CiAgICB3aW5kb3cucHJpbnQoKTsKICB9OwogIGlmIChjdXJyZW50VmlldyA9PT0gImhvbWUiKSB7CiAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHJlZjogY29udGFpbmVyUmVmLCBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuYmcsIGZvbnRGYW1pbHk6ICInSW50ZXInLCAtYXBwbGUtc3lzdGVtLCBCbGlua01hY1N5c3RlbUZvbnQsICdTZWdvZSBVSScsIFJvYm90bywgc2Fucy1zZXJpZiIsIG1heFdpZHRoOiA2MDAsIG1hcmdpbjogIjAgYXV0byIsIG92ZXJmbG93OiAiaGlkZGVuIiwgYm94U2l6aW5nOiAiYm9yZGVyLWJveCIsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsIGJvcmRlclJhZGl1czogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLnByaW1hcnksIHBhZGRpbmc6ICIyNHB4IDIwcHgiLCBjb2xvcjogIndoaXRlIiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgYWxpZ25JdGVtczogImZsZXgtc3RhcnQiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImgxIiwgeyBzdHlsZTogeyBtYXJnaW46IDAsIGZvbnRTaXplOiAyMiwgZm9udFdlaWdodDogNzAwLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDEwIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKERvbGxhclNpZ24sIHsgc2l6ZTogMjggfSksCiAgICAgICAgICAgICIgVGhlIFBlcnNvbmFsIEJ1ZGdldCBQbGFubmVyIgogICAgICAgICAgXSB9KSwKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJwIiwgeyBzdHlsZTogeyBtYXJnaW46ICI2cHggMCAwIiwgZm9udFNpemU6IDEyLCBvcGFjaXR5OiAwLjg1LCBsZXR0ZXJTcGFjaW5nOiAwLjIgfSwgY2hpbGRyZW46ICJCdWlsdCBvbiB0aGUgNTAvMzAvMjAgcnVsZSB1c2VkIGJ5IGZpbmFuY2lhbCBhZHZpc29ycyIgfSkKICAgICAgICBdIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNiB9LCBjaGlsZHJlbjogc2Vzc2lvbiA/IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKShpbXBvcnRfanN4X3J1bnRpbWUyLkZyYWdtZW50LCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICAgICAgcGFkZGluZzogIjRweCA4cHgiLAogICAgICAgICAgICBib3JkZXJSYWRpdXM6IDYsCiAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogInJnYmEoNSwxNTAsMTA1LDAuMjUpIiwKICAgICAgICAgICAgY29sb3I6ICIjNkVFN0I3IiwKICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgZ2FwOiA0LAogICAgICAgICAgICBmb250U2l6ZTogMTAsCiAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMCwKICAgICAgICAgICAgbGV0dGVyU3BhY2luZzogMC4zCiAgICAgICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShDbG91ZFVwbG9hZCwgeyBzaXplOiAxMiB9KSwKICAgICAgICAgICAgc3luY1N0YXR1cyA9PT0gInN5bmNpbmciID8gIlN5bmNpbmcuLi4iIDogIkJhY2tlZCBVcCIKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBzdXBhYmFzZT8uYXV0aC5zaWduT3V0KCksIHRpdGxlOiAiTG9nIE91dCIsIHN0eWxlOiB7CiAgICAgICAgICAgIHBhZGRpbmc6IDYsCiAgICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogInJnYmEoMjU1LDI1NSwyNTUsMC4yKSIsCiAgICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIgogICAgICAgICAgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKExvZ091dCwgeyBzaXplOiAxNCB9KSB9KQogICAgICAgIF0gfSkgOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRTaG93TG9naW5Nb2RhbCh0cnVlKSwgc3R5bGU6IHsKICAgICAgICAgIHBhZGRpbmc6ICI2cHggMTBweCIsCiAgICAgICAgICBib3JkZXJSYWRpdXM6IDYsCiAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogIndoaXRlIiwKICAgICAgICAgIGNvbG9yOiBDT0xPUlMyLnByaW1hcnksCiAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgZ2FwOiA0LAogICAgICAgICAgZm9udFNpemU6IDExLAogICAgICAgICAgZm9udFdlaWdodDogNjAwCiAgICAgICAgfSwgY2hpbGRyZW46ICJMb2cgSW4iIH0pIH0pCiAgICAgIF0gfSkgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAyMCB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBoYW5kbGVOZXdCdWRnZXQsIHN0eWxlOiB7CiAgICAgICAgICB3aWR0aDogIjEwMCUiLAogICAgICAgICAgcGFkZGluZzogMTYsCiAgICAgICAgICBib3JkZXJSYWRpdXM6IDEyLAogICAgICAgICAgYm9yZGVyOiBgMnB4IGRhc2hlZCAke0NPTE9SUzIucHJpbWFyeX1gLAogICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLmFjY2VudExpZ2h0LAogICAgICAgICAgY29sb3I6IENPTE9SUzIucHJpbWFyeURhcmssCiAgICAgICAgICBmb250U2l6ZTogMTUsCiAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAganVzdGlmeUNvbnRlbnQ6ICJjZW50ZXIiLAogICAgICAgICAgZ2FwOiA4LAogICAgICAgICAgbWFyZ2luQm90dG9tOiAyMAogICAgICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShQbHVzLCB7IHNpemU6IDIwIH0pLAogICAgICAgICAgIiBDcmVhdGUgTmV3IEJ1ZGdldCIKICAgICAgICBdIH0pLAogICAgICAgIHNhdmVkQnVkZ2V0cy5sZW5ndGggPT09IDAgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgdGV4dEFsaWduOiAiY2VudGVyIiwgcGFkZGluZzogNDAsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46IFsKICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFBpZ2d5QmFuaywgeyBzaXplOiA0OCwgc3R5bGU6IHsgb3BhY2l0eTogMC4zLCBtYXJnaW5Cb3R0b206IDE2IH0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgicCIsIHsgc3R5bGU6IHsgbWFyZ2luOiAwIH0sIGNoaWxkcmVuOiAiTm8gc2F2ZWQgYnVkZ2V0cyB5ZXQiIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInAiLCB7IHN0eWxlOiB7IG1hcmdpbjogIjRweCAwIDAiLCBmb250U2l6ZTogMTMgfSwgY2hpbGRyZW46ICJDcmVhdGUgeW91ciBmaXJzdCBidWRnZXQgdG8gZ2V0IHN0YXJ0ZWQiIH0pCiAgICAgICAgXSB9KSA6IHNhdmVkQnVkZ2V0cy5tYXAoKGIpID0+IHsKICAgICAgICAgIGNvbnN0IHRvdGFsSW5jb21lID0gYi5pbmNvbWUucmVkdWNlKChzLCBpKSA9PiBzICsgaS5tb250aGx5VmFsdWUsIDApOwogICAgICAgICAgY29uc3QgdG90YWxFeHBlbnNlcyA9IGIuZXhwZW5zZXMucmVkdWNlKChzLCBpKSA9PiBzICsgaS5tb250aGx5VmFsdWUsIDApOwogICAgICAgICAgY29uc3QgbmV0ID0gdG90YWxJbmNvbWUgLSB0b3RhbEV4cGVuc2VzOwogICAgICAgICAgcmV0dXJuIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogewogICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuY2FyZCwKICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxMiwKICAgICAgICAgICAgcGFkZGluZzogIjE0cHggMTZweCIsCiAgICAgICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsCiAgICAgICAgICAgIG1hcmdpbkJvdHRvbTogOCwKICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIKICAgICAgICAgIH0sIG9uQ2xpY2s6ICgpID0+IGhhbmRsZU9wZW5CdWRnZXQoYiksIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNSwgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTMi50ZXh0TWFpbiB9LCBjaGlsZHJlbjogYi5uYW1lIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgYi5pbmNvbWUubGVuZ3RoICsgYi5leHBlbnNlcy5sZW5ndGggKyBiLmFzc2V0cy5sZW5ndGggKyBiLm5vbkxpcXVpZEFzc2V0cy5sZW5ndGggKyAoYi5yZXRpcmVtZW50IHx8IFtdKS5sZW5ndGggKyBiLmxpYWJpbGl0aWVzLmxlbmd0aCwKICAgICAgICAgICAgICAgICIgaXRlbXMgXHhCNyBVcGRhdGVkICIsCiAgICAgICAgICAgICAgICBuZXcgRGF0ZShiLnVwZGF0ZWRBdCkudG9Mb2NhbGVEYXRlU3RyaW5nKCkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IHRleHRBbGlnbjogInJpZ2h0IiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxNSwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogbmV0ID49IDAgPyBDT0xPUlMyLnBvc2l0aXZlIDogQ09MT1JTMi5uZWdhdGl2ZSB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgIG5ldCA+PSAwID8gIisiIDogIiIsCiAgICAgICAgICAgICAgZm10KG5ldCksCiAgICAgICAgICAgICAgIi9tbyIKICAgICAgICAgICAgXSB9KSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKGUpID0+IHsKICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpOwogICAgICAgICAgICAgIGhhbmRsZURlbGV0ZUJ1ZGdldChiLmlkKTsKICAgICAgICAgICAgfSwgc3R5bGU6IHsKICAgICAgICAgICAgICBwYWRkaW5nOiA2LAogICAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICAgIGJhY2tncm91bmQ6ICJub25lIiwKICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQsCiAgICAgICAgICAgICAgbWFyZ2luTGVmdDogOAogICAgICAgICAgICB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoVHJhc2gyLCB7IHNpemU6IDE2IH0pIH0pCiAgICAgICAgICBdIH0sIGIuaWQpOwogICAgICAgIH0pCiAgICAgIF0gfSkKICAgIF0gfSk7CiAgfQogIGNvbnN0IGhhc0J1ZGdldENvbnRlbnQgPSBidWRnZXQuaW5jb21lLmxlbmd0aCA+IDAgfHwgYnVkZ2V0LmV4cGVuc2VzLmxlbmd0aCA+IDAgfHwgYnVkZ2V0LmFzc2V0cy5sZW5ndGggPiAwIHx8IGJ1ZGdldC5ub25MaXF1aWRBc3NldHMubGVuZ3RoID4gMCB8fCBidWRnZXQucmV0aXJlbWVudC5sZW5ndGggPiAwIHx8IGJ1ZGdldC5saWFiaWxpdGllcy5sZW5ndGggPiAwOwogIGNvbnN0IGhhc0xpdmVBc3NldHMgPSBbLi4uYnVkZ2V0LmFzc2V0cywgLi4uYnVkZ2V0Lm5vbkxpcXVpZEFzc2V0cywgLi4uYnVkZ2V0LnJldGlyZW1lbnRdLnNvbWUoKGkpID0+IChpLmFzc2V0VHlwZSA9PT0gImNyeXB0byIgfHwgaS5hc3NldFR5cGUgPT09ICJzdG9jayIpICYmIGkudGlja2VyKTsKICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHJlZjogY29udGFpbmVyUmVmLCBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuYmcsIGZvbnRGYW1pbHk6ICInSW50ZXInLCAtYXBwbGUtc3lzdGVtLCBCbGlua01hY1N5c3RlbUZvbnQsICdTZWdvZSBVSScsIFJvYm90bywgc2Fucy1zZXJpZiIsIG1heFdpZHRoOiA2MDAsIG1hcmdpbjogIjAgYXV0byIsIGJveFNpemluZzogImJvcmRlci1ib3giLCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLCBib3JkZXJSYWRpdXM6IDE2LCBvdmVyZmxvdzogImhpZGRlbiIgfSwgY2hpbGRyZW46IFsKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzdHlsZSIsIHsgY2hpbGRyZW46IGBAa2V5ZnJhbWVzIHNwaW4geyBmcm9tIHsgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKC01MCUpIHJvdGF0ZSgwZGVnKTsgfSB0byB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtNTAlKSByb3RhdGUoMzYwZGVnKTsgfSB9IEBrZXlmcmFtZXMgc3BpbkJ0biB7IGZyb20geyB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsgfSB0byB7IHRyYW5zZm9ybTogcm90YXRlKDM2MGRlZyk7IH0gfSBAa2V5ZnJhbWVzIGZhZGVJbk91dCB7IDAlIHsgb3BhY2l0eTogMDsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpIHRyYW5zbGF0ZVkoLThweCk7IH0gMTUlIHsgb3BhY2l0eTogMTsgdHJhbnNmb3JtOiB0cmFuc2xhdGVYKC01MCUpIHRyYW5zbGF0ZVkoMCk7IH0gODAlIHsgb3BhY2l0eTogMTsgfSAxMDAlIHsgb3BhY2l0eTogMDsgfSB9YCB9KSwKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIucHJpbWFyeSwgcGFkZGluZzogIjIwcHggMTZweCIsIGNvbG9yOiAid2hpdGUiIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogInNwYWNlLWJldHdlZW4iLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IFsKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA4IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShEb2xsYXJTaWduLCB7IHNpemU6IDI0IH0pLAogICAgICAgICAgZWRpdGluZ05hbWUgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJpbnB1dCIsIHsgdmFsdWU6IG5hbWVJbnB1dCwgb25DaGFuZ2U6IChlKSA9PiBzZXROYW1lSW5wdXQoZS50YXJnZXQudmFsdWUpLCBzdHlsZTogewogICAgICAgICAgICAgIGJhY2tncm91bmQ6ICJyZ2JhKDI1NSwyNTUsMjU1LDAuMikiLAogICAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgICAgIGZvbnRTaXplOiAyMCwKICAgICAgICAgICAgICBmb250V2VpZ2h0OiA3MDAsCiAgICAgICAgICAgICAgcGFkZGluZzogIjJweCA4cHgiLAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgICAgICBvdXRsaW5lOiAibm9uZSIsCiAgICAgICAgICAgICAgd2lkdGg6IDE4MCwKICAgICAgICAgICAgICBmb250RmFtaWx5OiAiaW5oZXJpdCIKICAgICAgICAgICAgfSwgYXV0b0ZvY3VzOiB0cnVlLCBvbktleURvd246IChlKSA9PiB7CiAgICAgICAgICAgICAgaWYgKGUua2V5ID09PSAiRW50ZXIiKSB7CiAgICAgICAgICAgICAgICBzZXRCdWRnZXQoKGIpID0+ICh7IC4uLmIsIG5hbWU6IG5hbWVJbnB1dCB9KSk7CiAgICAgICAgICAgICAgICBzZXRFZGl0aW5nTmFtZShmYWxzZSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IH0pLAogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgc2V0QnVkZ2V0KChiKSA9PiAoeyAuLi5iLCBuYW1lOiBuYW1lSW5wdXQgfSkpOwogICAgICAgICAgICAgIHNldEVkaXRpbmdOYW1lKGZhbHNlKTsKICAgICAgICAgICAgfSwgc3R5bGU6IHsgcGFkZGluZzogNCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmQ6ICJub25lIiwgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiAid2hpdGUiLCBkaXNwbGF5OiAiZmxleCIgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKENoZWNrLCB7IHNpemU6IDE4IH0pIH0pCiAgICAgICAgICBdIH0pIDogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImgxIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRFZGl0aW5nTmFtZSh0cnVlKSwgc3R5bGU6IHsgbWFyZ2luOiAwLCBmb250U2l6ZTogMjAsIGZvbnRXZWlnaHQ6IDcwMCwgY3Vyc29yOiAicG9pbnRlciIgfSwgY2hpbGRyZW46IGJ1ZGdldC5uYW1lIH0pCiAgICAgICAgXSB9KSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICBzZXNzaW9uID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKGltcG9ydF9qc3hfcnVudGltZTIuRnJhZ21lbnQsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgICAgICAgICAgcGFkZGluZzogIjRweCA4cHgiLAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJyZ2JhKDUsMTUwLDEwNSwwLjI1KSIsCiAgICAgICAgICAgICAgY29sb3I6ICIjNkVFN0I3IiwKICAgICAgICAgICAgICBkaXNwbGF5OiAiZmxleCIsCiAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgZ2FwOiA0LAogICAgICAgICAgICAgIGZvbnRTaXplOiAxMCwKICAgICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgICAgbGV0dGVyU3BhY2luZzogMC4zCiAgICAgICAgICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoQ2xvdWRVcGxvYWQsIHsgc2l6ZTogMTIgfSksCiAgICAgICAgICAgICAgc3luY1N0YXR1cyA9PT0gInN5bmNpbmciID8gIlN5bmNpbmcuLi4iIDogIkJhY2tlZCBVcCIKICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gc3VwYWJhc2U/LmF1dGguc2lnbk91dCgpLCB0aXRsZTogIkxvZyBPdXQiLCBzdHlsZTogewogICAgICAgICAgICAgIHBhZGRpbmc6IDYsCiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA2LAogICAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogInJnYmEoMjU1LDI1NSwyNTUsMC4yKSIsCiAgICAgICAgICAgICAgY29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiCiAgICAgICAgICAgIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShMb2dPdXQsIHsgc2l6ZTogMTQgfSkgfSkKICAgICAgICAgIF0gfSkgOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRTaG93TG9naW5Nb2RhbCh0cnVlKSwgc3R5bGU6IHsKICAgICAgICAgICAgcGFkZGluZzogIjZweCAxMHB4IiwKICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiA2LAogICAgICAgICAgICBib3JkZXI6ICJub25lIiwKICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLAogICAgICAgICAgICBjb2xvcjogQ09MT1JTMi5wcmltYXJ5LAogICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgZ2FwOiA0LAogICAgICAgICAgICBmb250U2l6ZTogMTEsCiAgICAgICAgICAgIGZvbnRXZWlnaHQ6IDYwMAogICAgICAgICAgfSwgY2hpbGRyZW46ICJMb2cgSW4iIH0pLAogICAgICAgICAgaGFzTGl2ZUFzc2V0cyAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImJ1dHRvbiIsIHsgb25DbGljazogcmVmcmVzaFByaWNlcywgZGlzYWJsZWQ6IHJlZnJlc2hpbmcsIHN0eWxlOiB7CiAgICAgICAgICAgIHBhZGRpbmc6ICI2cHggMTBweCIsCiAgICAgICAgICAgIGJvcmRlclJhZGl1czogNiwKICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogcmVmcmVzaGluZyA/ICJyZ2JhKDI1NSwyNTUsMjU1LDAuMSkiIDogInJnYmEoMjU1LDI1NSwyNTUsMC4yKSIsCiAgICAgICAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICAgICAgICBjdXJzb3I6IHJlZnJlc2hpbmcgPyAiZGVmYXVsdCIgOiAicG9pbnRlciIsCiAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgIGdhcDogNCwKICAgICAgICAgICAgZm9udFNpemU6IDExLAogICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgIG9wYWNpdHk6IHJlZnJlc2hpbmcgPyAwLjcgOiAxCiAgICAgICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShSZWZyZXNoQ3csIHsgc2l6ZTogMTQsIHN0eWxlOiByZWZyZXNoaW5nID8geyBhbmltYXRpb246ICJzcGluQnRuIDFzIGxpbmVhciBpbmZpbml0ZSIgfSA6IHZvaWQgMCB9KSwKICAgICAgICAgICAgcmVmcmVzaGluZyA/ICJVcGRhdGluZy4uLiIgOiAiUmVmcmVzaCIKICAgICAgICAgIF0gfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBoYW5kbGVCYWNrVG9Ib21lLCBzdHlsZTogeyBwYWRkaW5nOiA2LCBib3JkZXJSYWRpdXM6IDYsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kQ29sb3I6ICJyZ2JhKDI1NSwyNTUsMjU1LDAuMikiLCBjb2xvcjogIndoaXRlIiwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoSG91c2UsIHsgc2l6ZTogMTYgfSkgfSksCiAgICAgICAgICBoYXNCdWRnZXRDb250ZW50ICYmIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6IGhhbmRsZVNhdmVCdWRnZXQsIHN0eWxlOiB7IHBhZGRpbmc6IDYsIGJvcmRlclJhZGl1czogNiwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmRDb2xvcjogInJnYmEoMjU1LDI1NSwyNTUsMC4yKSIsIGNvbG9yOiAid2hpdGUiLCBjdXJzb3I6ICJwb2ludGVyIiwgZGlzcGxheTogImZsZXgiIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShTYXZlLCB7IHNpemU6IDE2IH0pIH0pLAogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJidXR0b24iLCB7IG9uQ2xpY2s6IGhhbmRsZU5ld0J1ZGdldCwgc3R5bGU6IHsgcGFkZGluZzogIjZweCAxMHB4IiwgYm9yZGVyUmFkaXVzOiA2LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBjb2xvcjogQ09MT1JTMi5wcmltYXJ5LCBmb250U2l6ZTogMTIsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNCB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShQbHVzLCB7IHNpemU6IDE0IH0pLAogICAgICAgICAgICAiIE5ldyIKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInAiLCB7IHN0eWxlOiB7IG1hcmdpbjogMCwgZm9udFNpemU6IDExLCBvcGFjaXR5OiAwLjgsIGxldHRlclNwYWNpbmc6IDAuMiB9LCBjaGlsZHJlbjogIkJ1aWx0IG9uIHRoZSA1MC8zMC8yMCBydWxlIHVzZWQgYnkgZmluYW5jaWFsIGFkdmlzb3JzIiB9KSwKICAgICAgICBidWRnZXQubGFzdFByaWNlUmVmcmVzaCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMCwgb3BhY2l0eTogMC42IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAiUHJpY2VzOiAiLAogICAgICAgICAgbmV3IERhdGUoYnVkZ2V0Lmxhc3RQcmljZVJlZnJlc2gpLnRvTG9jYWxlVGltZVN0cmluZygpCiAgICAgICAgXSB9KQogICAgICBdIH0pCiAgICBdIH0pLAogICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBhZGRpbmc6ICIxNnB4IDE2cHggNDBweCIgfSwgY2hpbGRyZW46IFsKICAgICAgYnVkZ2V0LmluY29tZS5sZW5ndGggPT09IDAgJiYgYnVkZ2V0LmV4cGVuc2VzLmxlbmd0aCA9PT0gMCAmJiBidWRnZXQuYXNzZXRzLmxlbmd0aCA9PT0gMCAmJiBidWRnZXQubm9uTGlxdWlkQXNzZXRzLmxlbmd0aCA9PT0gMCAmJiBidWRnZXQucmV0aXJlbWVudC5sZW5ndGggPT09IDAgJiYgYnVkZ2V0LmxpYWJpbGl0aWVzLmxlbmd0aCA9PT0gMCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgbWFyZ2luQm90dG9tOiAxNiB9LCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNjAwLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LCBtYXJnaW5Cb3R0b206IDgsIHRleHRBbGlnbjogImNlbnRlciIgfSwgY2hpbGRyZW46ICJTdGFydCB3aXRoIGEgdGVtcGxhdGUiIH0pLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA2IH0sIGNoaWxkcmVuOiBCVURHRVRfUFJFU0VUUy5tYXAoKHApID0+IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICBjb25zdCBwcmVzZXQgPSBwLmJ1ZGdldDsKICAgICAgICAgICAgICBjb25zdCByZWdlbmVyYXRlZCA9IHsKICAgICAgICAgICAgICAgIC4uLnByZXNldCwKICAgICAgICAgICAgICAgIGlkOiBidWRnZXQuaWQsCiAgICAgICAgICAgICAgICBpbmNvbWU6IHByZXNldC5pbmNvbWUubWFwKChpKSA9PiAoeyAuLi5pLCBpZDogZ2VuZXJhdGVJZCgpIH0pKSwKICAgICAgICAgICAgICAgIGV4cGVuc2VzOiBwcmVzZXQuZXhwZW5zZXMubWFwKChpKSA9PiAoeyAuLi5pLCBpZDogZ2VuZXJhdGVJZCgpIH0pKSwKICAgICAgICAgICAgICAgIGFzc2V0czogcHJlc2V0LmFzc2V0cy5tYXAoKGkpID0+ICh7IC4uLmksIGlkOiBnZW5lcmF0ZUlkKCkgfSkpLAogICAgICAgICAgICAgICAgbm9uTGlxdWlkQXNzZXRzOiBwcmVzZXQubm9uTGlxdWlkQXNzZXRzLm1hcCgoaSkgPT4gKHsgLi4uaSwgaWQ6IGdlbmVyYXRlSWQoKSB9KSksCiAgICAgICAgICAgICAgICByZXRpcmVtZW50OiBwcmVzZXQucmV0aXJlbWVudC5tYXAoKGkpID0+ICh7IC4uLmksIGlkOiBnZW5lcmF0ZUlkKCkgfSkpLAogICAgICAgICAgICAgICAgbGlhYmlsaXRpZXM6IHByZXNldC5saWFiaWxpdGllcy5tYXAoKGkpID0+ICh7IC4uLmksIGlkOiBnZW5lcmF0ZUlkKCkgfSkpLAogICAgICAgICAgICAgICAgY3JlYXRlZEF0OiBub3csCiAgICAgICAgICAgICAgICB1cGRhdGVkQXQ6IG5vdwogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgc2V0QnVkZ2V0KHJlZ2VuZXJhdGVkKTsKICAgICAgICAgICAgICBzZXROYW1lSW5wdXQocHJlc2V0Lm5hbWUpOwogICAgICAgICAgICAgIHRyYWNrRXZlbnQoImxvYWRfcHJlc2V0IiwgeyBwcmVzZXQ6IHAua2V5IH0pOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzdHlsZTogewogICAgICAgICAgICAgIGZsZXg6IDEsCiAgICAgICAgICAgICAgcGFkZGluZzogIjhweCA0cHgiLAogICAgICAgICAgICAgIGJvcmRlclJhZGl1czogMTAsCiAgICAgICAgICAgICAgYm9yZGVyOiBgMS41cHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLAogICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5jYXJkLAogICAgICAgICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgICAgICAgIHRleHRBbGlnbjogImNlbnRlciIsCiAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgIGZsZXhEaXJlY3Rpb246ICJjb2x1bW4iLAogICAgICAgICAgICAgIGFsaWduSXRlbXM6ICJjZW50ZXIiLAogICAgICAgICAgICAgIGdhcDogMiwKICAgICAgICAgICAgICB0cmFuc2l0aW9uOiAiYm9yZGVyLWNvbG9yIDAuMTVzLCBib3gtc2hhZG93IDAuMTVzIgogICAgICAgICAgICB9LAogICAgICAgICAgICBvbk1vdXNlRW50ZXI6IChlKSA9PiB7CiAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJvcmRlckNvbG9yID0gQ09MT1JTMi5hY2NlbnQ7CiAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLmJveFNoYWRvdyA9IGAwIDJweCA4cHggJHtDT0xPUlMyLmFjY2VudH0yMGA7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uTW91c2VMZWF2ZTogKGUpID0+IHsKICAgICAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQuc3R5bGUuYm9yZGVyQ29sb3IgPSBDT0xPUlMyLmJvcmRlcjsKICAgICAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQuc3R5bGUuYm94U2hhZG93ID0gIm5vbmUiOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTYgfSwgY2hpbGRyZW46IHAuZW1vamkgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMiwgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTMi50ZXh0TWFpbiB9LCBjaGlsZHJlbjogcC5sYWJlbCB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEwLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LCBsaW5lSGVpZ2h0OiAxLjIgfSwgY2hpbGRyZW46IHAuZGVzYyB9KQogICAgICAgICAgICBdCiAgICAgICAgICB9LAogICAgICAgICAgcC5rZXkKICAgICAgICApKSB9KQogICAgICBdIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgICBCdWRnZXRTZWN0aW9uLAogICAgICAgIHsKICAgICAgICAgIHRpdGxlOiAiSW5jb21lIiwKICAgICAgICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFRyZW5kaW5nVXAsIHsgc2l6ZTogMTggfSksCiAgICAgICAgICBjb2xvcjogQ09MT1JTMi5pbmNvbWUsCiAgICAgICAgICBiZ0NvbG9yOiBDT0xPUlMyLmluY29tZUJnLAogICAgICAgICAgaXRlbXM6IGJ1ZGdldC5pbmNvbWUsCiAgICAgICAgICBpbnB1dE1vZGU6ICJyZWN1cnJpbmciLAogICAgICAgICAgcHJlc2V0czogUFJFU0VUUy5pbmNvbWUsCiAgICAgICAgICBvblVwZGF0ZTogKGlkLCB1KSA9PiB1cGRhdGVJdGVtKCJpbmNvbWUiLCBpZCwgdSksCiAgICAgICAgICBvbkFkZDogKCkgPT4gYWRkSXRlbSgiaW5jb21lIiwgIm1vbnRobHkiKSwKICAgICAgICAgIG9uQWRkUHJlc2V0OiAobmFtZSwgYXQpID0+IGFkZFByZXNldEl0ZW0oImluY29tZSIsIG5hbWUsICJtb250aGx5IiwgYXQpLAogICAgICAgICAgb25EZWxldGU6IChpZCkgPT4gZGVsZXRlSXRlbSgiaW5jb21lIiwgaWQpLAogICAgICAgICAgb25SZW9yZGVyOiAoZnJvbTIsIHRvMikgPT4gcmVvcmRlckl0ZW1zKCJpbmNvbWUiLCBmcm9tMiwgdG8yKQogICAgICAgIH0KICAgICAgKSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgQnVkZ2V0U2VjdGlvbiwKICAgICAgICB7CiAgICAgICAgICB0aXRsZTogIkV4cGVuc2VzIiwKICAgICAgICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFRyZW5kaW5nRG93biwgeyBzaXplOiAxOCB9KSwKICAgICAgICAgIGNvbG9yOiBDT0xPUlMyLmV4cGVuc2UsCiAgICAgICAgICBiZ0NvbG9yOiBDT0xPUlMyLmV4cGVuc2VCZywKICAgICAgICAgIGl0ZW1zOiBidWRnZXQuZXhwZW5zZXMsCiAgICAgICAgICBpbnB1dE1vZGU6ICJyZWN1cnJpbmciLAogICAgICAgICAgcHJlc2V0czogUFJFU0VUUy5leHBlbnNlcywKICAgICAgICAgIG9uVXBkYXRlOiAoaWQsIHUpID0+IHVwZGF0ZUl0ZW0oImV4cGVuc2VzIiwgaWQsIHUpLAogICAgICAgICAgb25BZGQ6ICgpID0+IGFkZEl0ZW0oImV4cGVuc2VzIiwgIm1vbnRobHkiKSwKICAgICAgICAgIG9uQWRkUHJlc2V0OiAobmFtZSwgYXQpID0+IGFkZFByZXNldEl0ZW0oImV4cGVuc2VzIiwgbmFtZSwgIm1vbnRobHkiLCBhdCksCiAgICAgICAgICBvbkRlbGV0ZTogKGlkKSA9PiBkZWxldGVJdGVtKCJleHBlbnNlcyIsIGlkKSwKICAgICAgICAgIG9uUmVvcmRlcjogKGZyb20yLCB0bzIpID0+IHJlb3JkZXJJdGVtcygiZXhwZW5zZXMiLCBmcm9tMiwgdG8yKQogICAgICAgIH0KICAgICAgKSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgQnVkZ2V0U2VjdGlvbiwKICAgICAgICB7CiAgICAgICAgICB0aXRsZTogIkFzc2V0cyIsCiAgICAgICAgICBpY29uOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShXYWxsZXQsIHsgc2l6ZTogMTggfSksCiAgICAgICAgICBjb2xvcjogQ09MT1JTMi5hc3NldCwKICAgICAgICAgIGJnQ29sb3I6IENPTE9SUzIuYXNzZXRCZywKICAgICAgICAgIGl0ZW1zOiBidWRnZXQuYXNzZXRzLAogICAgICAgICAgaW5wdXRNb2RlOiAiYXNzZXQiLAogICAgICAgICAgcHJlc2V0czogUFJFU0VUUy5hc3NldHMsCiAgICAgICAgICBvblVwZGF0ZTogKGlkLCB1KSA9PiB1cGRhdGVJdGVtKCJhc3NldHMiLCBpZCwgdSksCiAgICAgICAgICBvbkFkZDogKCkgPT4gYWRkSXRlbSgiYXNzZXRzIiwgIm9uZV90aW1lIiksCiAgICAgICAgICBvbkFkZFByZXNldDogKG5hbWUsIGF0KSA9PiBhZGRQcmVzZXRJdGVtKCJhc3NldHMiLCBuYW1lLCAib25lX3RpbWUiLCBhdCksCiAgICAgICAgICBvbkRlbGV0ZTogKGlkKSA9PiBkZWxldGVJdGVtKCJhc3NldHMiLCBpZCksCiAgICAgICAgICBvblJlb3JkZXI6IChmcm9tMiwgdG8yKSA9PiByZW9yZGVySXRlbXMoImFzc2V0cyIsIGZyb20yLCB0bzIpCiAgICAgICAgfQogICAgICApLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgICBCdWRnZXRTZWN0aW9uLAogICAgICAgIHsKICAgICAgICAgIHRpdGxlOiAiTm9uLUxpcXVpZCBBc3NldHMiLAogICAgICAgICAgaWNvbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoQnVpbGRpbmcyLCB7IHNpemU6IDE4IH0pLAogICAgICAgICAgY29sb3I6IENPTE9SUzIubm9uTGlxdWlkLAogICAgICAgICAgYmdDb2xvcjogQ09MT1JTMi5ub25MaXF1aWRCZywKICAgICAgICAgIGl0ZW1zOiBidWRnZXQubm9uTGlxdWlkQXNzZXRzLAogICAgICAgICAgaW5wdXRNb2RlOiAidmFsdWVfb25seSIsCiAgICAgICAgICBwcmVzZXRzOiBQUkVTRVRTLm5vbkxpcXVpZEFzc2V0cywKICAgICAgICAgIG9uVXBkYXRlOiAoaWQsIHUpID0+IHVwZGF0ZUl0ZW0oIm5vbkxpcXVpZEFzc2V0cyIsIGlkLCB1KSwKICAgICAgICAgIG9uQWRkOiAoKSA9PiBhZGRJdGVtKCJub25MaXF1aWRBc3NldHMiLCAib25lX3RpbWUiKSwKICAgICAgICAgIG9uQWRkUHJlc2V0OiAobmFtZSwgYXQpID0+IGFkZFByZXNldEl0ZW0oIm5vbkxpcXVpZEFzc2V0cyIsIG5hbWUsICJvbmVfdGltZSIsIGF0KSwKICAgICAgICAgIG9uRGVsZXRlOiAoaWQpID0+IGRlbGV0ZUl0ZW0oIm5vbkxpcXVpZEFzc2V0cyIsIGlkKSwKICAgICAgICAgIG9uUmVvcmRlcjogKGZyb20yLCB0bzIpID0+IHJlb3JkZXJJdGVtcygibm9uTGlxdWlkQXNzZXRzIiwgZnJvbTIsIHRvMiksCiAgICAgICAgICBmb290ZXI6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuY2FyZCwgYm9yZGVyUmFkaXVzOiAxMCwgcGFkZGluZzogIjEwcHggMTJweCIsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyTGlnaHR9YCwgbWFyZ2luVG9wOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBtYXJnaW5Cb3R0b206IDYgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICJEaXNjb3VudCBSYXRlIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoInNwYW4iLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNzAwLCBjb2xvcjogQ09MT1JTMi5ub25MaXF1aWQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIGJ1ZGdldC5ub25MaXF1aWREaXNjb3VudCwKICAgICAgICAgICAgICAgICIlIgogICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgXSB9KSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgICAgICAgImlucHV0IiwKICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0eXBlOiAicmFuZ2UiLAogICAgICAgICAgICAgICAgbWluOiAwLAogICAgICAgICAgICAgICAgbWF4OiA3NSwKICAgICAgICAgICAgICAgIHZhbHVlOiBidWRnZXQubm9uTGlxdWlkRGlzY291bnQsCiAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldEJ1ZGdldCgoYikgPT4gKHsgLi4uYiwgbm9uTGlxdWlkRGlzY291bnQ6IHBhcnNlSW50KGUudGFyZ2V0LnZhbHVlKSB9KSksCiAgICAgICAgICAgICAgICBzdHlsZTogeyB3aWR0aDogIjEwMCUiLCBhY2NlbnRDb2xvcjogQ09MT1JTMi5ub25MaXF1aWQgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgKSwKICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgZm9udFNpemU6IDEwLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgY2hpbGRyZW46ICIwJSIgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInNwYW4iLCB7IGNoaWxkcmVuOiAiMjUlIiB9KSwKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgic3BhbiIsIHsgY2hpbGRyZW46ICI1MCUiIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBjaGlsZHJlbjogIjc1JSIgfSkKICAgICAgICAgICAgXSB9KQogICAgICAgICAgXSB9KQogICAgICAgIH0KICAgICAgKSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgQnVkZ2V0U2VjdGlvbiwKICAgICAgICB7CiAgICAgICAgICB0aXRsZTogIjQwMWsgLyBSZXRpcmVtZW50IiwKICAgICAgICAgIGljb246IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKExhbmRtYXJrLCB7IHNpemU6IDE4IH0pLAogICAgICAgICAgY29sb3I6IENPTE9SUzIucmV0aXJlbWVudCwKICAgICAgICAgIGJnQ29sb3I6IENPTE9SUzIucmV0aXJlbWVudEJnLAogICAgICAgICAgaXRlbXM6IGJ1ZGdldC5yZXRpcmVtZW50LAogICAgICAgICAgaW5wdXRNb2RlOiAidmFsdWVfb25seSIsCiAgICAgICAgICBwcmVzZXRzOiBQUkVTRVRTLnJldGlyZW1lbnQsCiAgICAgICAgICBvblVwZGF0ZTogKGlkLCB1KSA9PiB1cGRhdGVJdGVtKCJyZXRpcmVtZW50IiwgaWQsIHUpLAogICAgICAgICAgb25BZGQ6ICgpID0+IGFkZEl0ZW0oInJldGlyZW1lbnQiLCAib25lX3RpbWUiKSwKICAgICAgICAgIG9uQWRkUHJlc2V0OiAobmFtZSwgYXQpID0+IGFkZFByZXNldEl0ZW0oInJldGlyZW1lbnQiLCBuYW1lLCAib25lX3RpbWUiLCBhdCksCiAgICAgICAgICBvbkRlbGV0ZTogKGlkKSA9PiBkZWxldGVJdGVtKCJyZXRpcmVtZW50IiwgaWQpLAogICAgICAgICAgb25SZW9yZGVyOiAoZnJvbTIsIHRvMikgPT4gcmVvcmRlckl0ZW1zKCJyZXRpcmVtZW50IiwgZnJvbTIsIHRvMikKICAgICAgICB9CiAgICAgICksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKAogICAgICAgIEJ1ZGdldFNlY3Rpb24sCiAgICAgICAgewogICAgICAgICAgdGl0bGU6ICJMaWFiaWxpdGllcyIsCiAgICAgICAgICBpY29uOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShUcmlhbmdsZUFsZXJ0LCB7IHNpemU6IDE4IH0pLAogICAgICAgICAgY29sb3I6IENPTE9SUzIubGlhYmlsaXR5LAogICAgICAgICAgYmdDb2xvcjogQ09MT1JTMi5saWFiaWxpdHlCZywKICAgICAgICAgIGl0ZW1zOiBidWRnZXQubGlhYmlsaXRpZXMsCiAgICAgICAgICBpbnB1dE1vZGU6ICJyZWN1cnJpbmciLAogICAgICAgICAgcHJlc2V0czogUFJFU0VUUy5saWFiaWxpdGllcywKICAgICAgICAgIG9uVXBkYXRlOiAoaWQsIHUpID0+IHVwZGF0ZUl0ZW0oImxpYWJpbGl0aWVzIiwgaWQsIHUpLAogICAgICAgICAgb25BZGQ6ICgpID0+IGFkZEl0ZW0oImxpYWJpbGl0aWVzIiwgIm9uZV90aW1lIiksCiAgICAgICAgICBvbkFkZFByZXNldDogKG5hbWUsIGF0KSA9PiBhZGRQcmVzZXRJdGVtKCJsaWFiaWxpdGllcyIsIG5hbWUsICJvbmVfdGltZSIsIGF0KSwKICAgICAgICAgIG9uRGVsZXRlOiAoaWQpID0+IGRlbGV0ZUl0ZW0oImxpYWJpbGl0aWVzIiwgaWQpLAogICAgICAgICAgb25SZW9yZGVyOiAoZnJvbTIsIHRvMikgPT4gcmVvcmRlckl0ZW1zKCJsaWFiaWxpdGllcyIsIGZyb20yLCB0bzIpCiAgICAgICAgfQogICAgICApLAogICAgICAoYnVkZ2V0LmluY29tZS5sZW5ndGggPiAwIHx8IGJ1ZGdldC5leHBlbnNlcy5sZW5ndGggPiAwIHx8IGJ1ZGdldC5hc3NldHMubGVuZ3RoID4gMCB8fCBidWRnZXQubGlhYmlsaXRpZXMubGVuZ3RoID4gMCkgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoU3VtbWFyeVNlY3Rpb24sIHsgYnVkZ2V0IH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogIjE2cHggMCIsIGJvcmRlclRvcDogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyTGlnaHR9YCB9LCBjbGFzc05hbWU6ICJuby1wcmludCIsIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCwgdGV4dFRyYW5zZm9ybTogInVwcGVyY2FzZSIsIGxldHRlclNwYWNpbmc6IDAuNSwgbWFyZ2luQm90dG9tOiAxMCB9LCBjaGlsZHJlbjogIlJlbGF0ZWQgQXBwcyIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZGlzcGxheTogImZsZXgiLCBnYXA6IDEwLCBmbGV4V3JhcDogIndyYXAiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICB7IGVtb2ppOiAiXHUyNzAyXHVGRTBGIiwgYWNjZW50OiAiI0VGNDQ0NCIsIGFjY2VudEJnOiAiI0ZFRjJGMiIsIGxhYmVsOiAiSnVzdCBDYW5jZWwgSXQiLCBkZXNjOiAiQ2FuY2VsIHlvdXIgc3Vic2NyaXB0aW9ucyBmb3IgZnJlZSIgfSwKICAgICAgICAgIHsgZW1vamk6ICJcdXsxRjNENn1cdUZFMEYiLCBhY2NlbnQ6ICIjRjU5RTBCIiwgYWNjZW50Qmc6ICIjRkZGQkVCIiwgbGFiZWw6ICJSZXRpcmVtZW50IENhbGN1bGF0b3IiLCBkZXNjOiAiUGxhbiB5b3VyIHJldGlyZW1lbnQgd2l0aCBjb25maWRlbmNlIiB9LAogICAgICAgICAgeyBlbW9qaTogIlx1ezFGNENBfSIsIGFjY2VudDogIiM2MzY2RjEiLCBhY2NlbnRCZzogIiNFRUYyRkYiLCBsYWJlbDogIlBvcnRmb2xpbyBPcHRpbWl6ZXIiLCBkZXNjOiAiT3B0aW1pemUgeW91ciBpbnZlc3RtZW50IHBvcnRmb2xpbyIgfQogICAgICAgIF0ubWFwKChhcHAsIGkpID0+IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB0cmFja0V2ZW50KCJyZWxhdGVkX2FwcF9jbGljayIsIHsgYXBwOiBhcHAubGFiZWwgfSksCiAgICAgICAgICAgIHN0eWxlOiB7CiAgICAgICAgICAgICAgZmxleDogIjEgMSAwIiwKICAgICAgICAgICAgICBtaW5XaWR0aDogMTQwLAogICAgICAgICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICAgICAgICBmbGV4RGlyZWN0aW9uOiAiY29sdW1uIiwKICAgICAgICAgICAgICBhbGlnbkl0ZW1zOiAiY2VudGVyIiwKICAgICAgICAgICAgICBnYXA6IDgsCiAgICAgICAgICAgICAgcGFkZGluZzogIjE2cHggMTJweCIsCiAgICAgICAgICAgICAgYm9yZGVyUmFkaXVzOiAxNCwKICAgICAgICAgICAgICBib3JkZXI6IGAxcHggc29saWQgJHthcHAuYWNjZW50fTIwYCwKICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGFwcC5hY2NlbnRCZywKICAgICAgICAgICAgICBjdXJzb3I6ICJwb2ludGVyIiwKICAgICAgICAgICAgICB0ZXh0QWxpZ246ICJjZW50ZXIiLAogICAgICAgICAgICAgIHRyYW5zaXRpb246ICJ0cmFuc2Zvcm0gMC4xNXMsIGJveC1zaGFkb3cgMC4xNXMiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9uTW91c2VFbnRlcjogKGUpID0+IHsKICAgICAgICAgICAgICBlLmN1cnJlbnRUYXJnZXQuc3R5bGUudHJhbnNmb3JtID0gInRyYW5zbGF0ZVkoLTJweCkiOwogICAgICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS5ib3hTaGFkb3cgPSBgMCA0cHggMTJweCAke2FwcC5hY2NlbnR9MjBgOwogICAgICAgICAgICB9LAogICAgICAgICAgICBvbk1vdXNlTGVhdmU6IChlKSA9PiB7CiAgICAgICAgICAgICAgZS5jdXJyZW50VGFyZ2V0LnN0eWxlLnRyYW5zZm9ybSA9ICIiOwogICAgICAgICAgICAgIGUuY3VycmVudFRhcmdldC5zdHlsZS5ib3hTaGFkb3cgPSAiIjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyB3aWR0aDogNDQsIGhlaWdodDogNDQsIGJvcmRlclJhZGl1czogMTIsIGJhY2tncm91bmQ6IGBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAke2FwcC5hY2NlbnR9MjAsICR7YXBwLmFjY2VudH0wOClgLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIGZvbnRTaXplOiAyMiB9LCBjaGlsZHJlbjogYXBwLmVtb2ppIH0pLAogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNYWluIH0sIGNoaWxkcmVuOiBhcHAubGFiZWwgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTEsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksIG1hcmdpblRvcDogMiB9LCBjaGlsZHJlbjogYXBwLmRlc2MgfSkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0KICAgICAgICAgIH0sCiAgICAgICAgICBpCiAgICAgICAgKSkgfSkKICAgICAgXSB9KSwKICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgICAgbWFyZ2luVG9wOiAxNiwKICAgICAgICBwYWRkaW5nOiAiMTZweCAwIiwKICAgICAgICBib3JkZXJUb3A6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLAogICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsCiAgICAgICAgZ2FwOiA4LAogICAgICAgIGZsZXhXcmFwOiAid3JhcCIKICAgICAgfSwgY2xhc3NOYW1lOiAibm8tcHJpbnQiLCBjaGlsZHJlbjogWwogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogeyBwYWRkaW5nOiAiOHB4IDE0cHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5jYXJkLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNiB9LAogICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgdHJhY2tFdmVudCgic3Vic2NyaWJlX2NsaWNrIik7CiAgICAgICAgICAgICAgc2V0U2hvd1N1YnNjcmliZU1vZGFsKHRydWUpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKE1haWwsIHsgc2l6ZTogMTUgfSksCiAgICAgICAgICAgICAgIiBTdWJzY3JpYmUiCiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICApLAogICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgKICAgICAgICAgICJidXR0b24iLAogICAgICAgICAgewogICAgICAgICAgICBzdHlsZTogeyBwYWRkaW5nOiAiOHB4IDE0cHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5jYXJkLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5LCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGdhcDogNiB9LAogICAgICAgICAgICBvbkNsaWNrOiBoYW5kbGVSZXNldCwKICAgICAgICAgICAgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShSb3RhdGVDY3csIHsgc2l6ZTogMTUgfSksCiAgICAgICAgICAgICAgIiBSZXNldCIKICAgICAgICAgICAgXQogICAgICAgICAgfQogICAgICAgICksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKAogICAgICAgICAgImJ1dHRvbiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTRweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJ9YCwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLmNhcmQsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnksIGZvbnRTaXplOiAxMywgZm9udFdlaWdodDogNjAwLCBjdXJzb3I6ICJwb2ludGVyIiwgZGlzcGxheTogImZsZXgiLCBhbGlnbkl0ZW1zOiAiY2VudGVyIiwgZ2FwOiA2IH0sCiAgICAgICAgICAgIG9uQ2xpY2s6ICgpID0+IHRyYWNrRXZlbnQoImRvbmF0ZV9jbGljayIpLAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKEhlYXJ0LCB7IHNpemU6IDE1IH0pLAogICAgICAgICAgICAgICIgRG9uYXRlIgogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNHB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuY2FyZCwgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSwgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIGN1cnNvcjogInBvaW50ZXIiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDYgfSwKICAgICAgICAgICAgb25DbGljazogKCkgPT4gewogICAgICAgICAgICAgIHRyYWNrRXZlbnQoImZlZWRiYWNrX2NsaWNrIik7CiAgICAgICAgICAgICAgc2V0U2hvd0ZlZWRiYWNrTW9kYWwodHJ1ZSk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoTWVzc2FnZVNxdWFyZSwgeyBzaXplOiAxNSB9KSwKICAgICAgICAgICAgICAiIEZlZWRiYWNrIgogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKSwKICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoCiAgICAgICAgICAiYnV0dG9uIiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNHB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLCBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuY2FyZCwgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSwgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIGN1cnNvcjogInBvaW50ZXIiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBnYXA6IDYgfSwKICAgICAgICAgICAgb25DbGljazogKCkgPT4gewogICAgICAgICAgICAgIHRyYWNrRXZlbnQoInByaW50X2NsaWNrIik7CiAgICAgICAgICAgICAgd2luZG93LnByaW50KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoUHJpbnRlciwgeyBzaXplOiAxNSB9KSwKICAgICAgICAgICAgICAiIFByaW50IgogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICBdIH0pCiAgICBdIH0pLAogICAgY29uZmlybURpYWxvZyAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgImRpdiIsCiAgICAgIHsKICAgICAgICBzdHlsZTogeyBwb3NpdGlvbjogImZpeGVkIiwgaW5zZXQ6IDAsIGJhY2tncm91bmRDb2xvcjogInJnYmEoMCwwLDAsMC40KSIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgekluZGV4OiAxZTMgfSwKICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXRDb25maXJtRGlhbG9nKG51bGwpLAogICAgICAgIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoCiAgICAgICAgICAiZGl2IiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLmNhcmQsIGJvcmRlclJhZGl1czogMTYsIHBhZGRpbmc6IDI0LCBtYXhXaWR0aDogMzQwLCB3aWR0aDogIjkwJSIsIGJveFNoYWRvdzogIjAgOHB4IDMwcHggcmdiYSgwLDAsMCwwLjE1KSIgfSwKICAgICAgICAgICAgb25DbGljazogKGUpID0+IGUuc3RvcFByb3BhZ2F0aW9uKCksCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDE1LCBmb250V2VpZ2h0OiA2MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNYWluLCBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiBjb25maXJtRGlhbG9nLm1lc3NhZ2UgfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4LCBqdXN0aWZ5Q29udGVudDogImZsZXgtZW5kIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gc2V0Q29uZmlybURpYWxvZyhudWxsKSwgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNnB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6IGAxcHggc29saWQgJHtDT0xPUlMyLmJvcmRlcn1gLCBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsIGZvbnRTaXplOiAxMywgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiBDT0xPUlMyLnRleHRTZWNvbmRhcnkgfSwgY2hpbGRyZW46ICJDYW5jZWwiIH0pLAogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gewogICAgICAgICAgICAgICAgICBjb25maXJtRGlhbG9nLm9uQ29uZmlybSgpOwogICAgICAgICAgICAgICAgICBzZXRDb25maXJtRGlhbG9nKG51bGwpOwogICAgICAgICAgICAgICAgfSwgc3R5bGU6IHsgcGFkZGluZzogIjhweCAxNnB4IiwgYm9yZGVyUmFkaXVzOiA4LCBib3JkZXI6ICJub25lIiwgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLmV4cGVuc2UsIGNvbG9yOiAid2hpdGUiLCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY3Vyc29yOiAicG9pbnRlciIgfSwgY2hpbGRyZW46ICJDb25maXJtIiB9KQogICAgICAgICAgICAgIF0gfSkKICAgICAgICAgICAgXQogICAgICAgICAgfQogICAgICAgICkKICAgICAgfQogICAgKSwKICAgIHNob3dTdWJzY3JpYmVNb2RhbCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgImRpdiIsCiAgICAgIHsKICAgICAgICBzdHlsZTogeyBwb3NpdGlvbjogImZpeGVkIiwgaW5zZXQ6IDAsIGJhY2tncm91bmRDb2xvcjogInJnYmEoMCwwLDAsMC40KSIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgekluZGV4OiAxZTMgfSwKICAgICAgICBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICBzZXRTaG93U3Vic2NyaWJlTW9kYWwoZmFsc2UpOwogICAgICAgICAgc2V0U3Vic2NyaWJlRW1haWwoIiIpOwogICAgICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJpZGxlIik7CiAgICAgICAgICBzZXRTdWJzY3JpYmVNZXNzYWdlKCIiKTsKICAgICAgICB9LAogICAgICAgIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoCiAgICAgICAgICAiZGl2IiwKICAgICAgICAgIHsKICAgICAgICAgICAgc3R5bGU6IHsgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLmNhcmQsIGJvcmRlclJhZGl1czogMTYsIHBhZGRpbmc6IDI0LCBtYXhXaWR0aDogMzgwLCB3aWR0aDogIjkwJSIsIGJveFNoYWRvdzogIjAgOHB4IDMwcHggcmdiYSgwLDAsMCwwLjE1KSIgfSwKICAgICAgICAgICAgb25DbGljazogKGUpID0+IGUuc3RvcFByb3BhZ2F0aW9uKCksCiAgICAgICAgICAgIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwganVzdGlmeUNvbnRlbnQ6ICJzcGFjZS1iZXR3ZWVuIiwgYWxpZ25JdGVtczogImNlbnRlciIsIG1hcmdpbkJvdHRvbTogMTYgfSwgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJoMyIsIHsgc3R5bGU6IHsgbWFyZ2luOiAwLCBmb250U2l6ZTogMTcsIGZvbnRXZWlnaHQ6IDcwMCwgY29sb3I6IENPTE9SUzIudGV4dE1haW4gfSwgY2hpbGRyZW46ICJTdWJzY3JpYmUgdG8gVXBkYXRlcyIgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgIHNldFNob3dTdWJzY3JpYmVNb2RhbChmYWxzZSk7CiAgICAgICAgICAgICAgICAgIHNldFN1YnNjcmliZUVtYWlsKCIiKTsKICAgICAgICAgICAgICAgICAgc2V0U3Vic2NyaWJlU3RhdHVzKCJpZGxlIik7CiAgICAgICAgICAgICAgICAgIHNldFN1YnNjcmliZU1lc3NhZ2UoIiIpOwogICAgICAgICAgICAgICAgfSwgc3R5bGU6IHsgcGFkZGluZzogNCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmQ6ICJub25lIiwgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoWCwgeyBzaXplOiAxOCB9KSB9KQogICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoInAiLCB7IHN0eWxlOiB7IGZvbnRTaXplOiAxMywgY29sb3I6IENPTE9SUzIudGV4dFNlY29uZGFyeSwgbWFyZ2luOiAiMCAwIDEycHgiIH0sIGNoaWxkcmVuOiAiR2V0IG5vdGlmaWVkIGFib3V0IG5ldyBmZWF0dXJlcyBhbmQgdXBkYXRlcy4iIH0pLAogICAgICAgICAgICAgIHN1YnNjcmliZVN0YXR1cyA9PT0gInN1Y2Nlc3MiID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgcGFkZGluZzogMTIsIGJvcmRlclJhZGl1czogOCwgYmFja2dyb3VuZENvbG9yOiBgJHtDT0xPUlMyLmluY29tZX0xMGAsIGNvbG9yOiBDT0xPUlMyLmluY29tZSwgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIHRleHRBbGlnbjogImNlbnRlciIgfSwgY2hpbGRyZW46IHN1YnNjcmliZU1lc3NhZ2UgfHwgIlN1YnNjcmliZWQhIiB9KSA6IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKShpbXBvcnRfanN4X3J1bnRpbWUyLkZyYWdtZW50LCB7IGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgICAgICAgICAgICAgImlucHV0IiwKICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBzdWJzY3JpYmVFbWFpbCwKICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldFN1YnNjcmliZUVtYWlsKGUudGFyZ2V0LnZhbHVlKSwKICAgICAgICAgICAgICAgICAgICBvbktleURvd246IChlKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICBpZiAoZS5rZXkgPT09ICJFbnRlciIpIGhhbmRsZVN1YnNjcmliZSgpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI6ICJ5b3VyQGVtYWlsLmNvbSIsCiAgICAgICAgICAgICAgICAgICAgYXV0b0ZvY3VzOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7IHdpZHRoOiAiMTAwJSIsIHBhZGRpbmc6ICIxMHB4IDEycHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsIGZvbnRTaXplOiAxNCwgZm9udEZhbWlseTogImluaGVyaXQiLCBvdXRsaW5lOiAibm9uZSIsIGJveFNpemluZzogImJvcmRlci1ib3giLCBtYXJnaW5Cb3R0b206IDggfQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgc3Vic2NyaWJlTWVzc2FnZSAmJiBzdWJzY3JpYmVTdGF0dXMgPT09ICJlcnJvciIgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImRpdiIsIHsgc3R5bGU6IHsgZm9udFNpemU6IDEyLCBjb2xvcjogQ09MT1JTMi5leHBlbnNlLCBtYXJnaW5Cb3R0b206IDggfSwgY2hpbGRyZW46IHN1YnNjcmliZU1lc3NhZ2UgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBoYW5kbGVTdWJzY3JpYmUsIGRpc2FibGVkOiBzdWJzY3JpYmVTdGF0dXMgPT09ICJsb2FkaW5nIiwgc3R5bGU6IHsKICAgICAgICAgICAgICAgICAgd2lkdGg6ICIxMDAlIiwKICAgICAgICAgICAgICAgICAgcGFkZGluZzogIjEwcHggMTZweCIsCiAgICAgICAgICAgICAgICAgIGJvcmRlclJhZGl1czogOCwKICAgICAgICAgICAgICAgICAgYm9yZGVyOiAibm9uZSIsCiAgICAgICAgICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5wcmltYXJ5LAogICAgICAgICAgICAgICAgICBjb2xvcjogIndoaXRlIiwKICAgICAgICAgICAgICAgICAgZm9udFNpemU6IDE0LAogICAgICAgICAgICAgICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgICAgICAgICAgICAgIGN1cnNvcjogc3Vic2NyaWJlU3RhdHVzID09PSAibG9hZGluZyIgPyAiZGVmYXVsdCIgOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHN1YnNjcmliZVN0YXR1cyA9PT0gImxvYWRpbmciID8gMC43IDogMQogICAgICAgICAgICAgICAgfSwgY2hpbGRyZW46IHN1YnNjcmliZVN0YXR1cyA9PT0gImxvYWRpbmciID8gIlN1YnNjcmliaW5nLi4uIiA6ICJTdWJzY3JpYmUiIH0pCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICB9CiAgICApLAogICAgc2hvd0ZlZWRiYWNrTW9kYWwgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICJkaXYiLAogICAgICB7CiAgICAgICAgc3R5bGU6IHsgcG9zaXRpb246ICJmaXhlZCIsIGluc2V0OiAwLCBiYWNrZ3JvdW5kQ29sb3I6ICJyZ2JhKDAsMCwwLDAuNCkiLCBkaXNwbGF5OiAiZmxleCIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBqdXN0aWZ5Q29udGVudDogImNlbnRlciIsIHpJbmRleDogMWUzIH0sCiAgICAgICAgb25DbGljazogKCkgPT4gewogICAgICAgICAgc2V0U2hvd0ZlZWRiYWNrTW9kYWwoZmFsc2UpOwogICAgICAgICAgc2V0RmVlZGJhY2tUZXh0KCIiKTsKICAgICAgICAgIHNldEZlZWRiYWNrU3RhdHVzKCJpZGxlIik7CiAgICAgICAgfSwKICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKAogICAgICAgICAgImRpdiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5jYXJkLCBib3JkZXJSYWRpdXM6IDE2LCBwYWRkaW5nOiAyNCwgbWF4V2lkdGg6IDM4MCwgd2lkdGg6ICI5MCUiLCBib3hTaGFkb3c6ICIwIDhweCAzMHB4IHJnYmEoMCwwLDAsMC4xNSkiIH0sCiAgICAgICAgICAgIG9uQ2xpY2s6IChlKSA9PiBlLnN0b3BQcm9wYWdhdGlvbigpLAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBtYXJnaW5Cb3R0b206IDEyIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiaDMiLCB7IHN0eWxlOiB7IG1hcmdpbjogMCwgZm9udFNpemU6IDE3LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNYWluIH0sIGNoaWxkcmVuOiAiU2VuZCBGZWVkYmFjayIgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiB7CiAgICAgICAgICAgICAgICAgIHNldFNob3dGZWVkYmFja01vZGFsKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgc2V0RmVlZGJhY2tUZXh0KCIiKTsKICAgICAgICAgICAgICAgICAgc2V0RmVlZGJhY2tTdGF0dXMoImlkbGUiKTsKICAgICAgICAgICAgICAgIH0sIHN0eWxlOiB7IHBhZGRpbmc6IDQsIGJvcmRlcjogIm5vbmUiLCBiYWNrZ3JvdW5kOiAibm9uZSIsIGN1cnNvcjogInBvaW50ZXIiLCBjb2xvcjogQ09MT1JTMi50ZXh0TXV0ZWQgfSwgY2hpbGRyZW46IC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKFgsIHsgc2l6ZTogMTggfSkgfSkKICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgIGVuam95Vm90ZSAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgICAgICAgICAgIHBhZGRpbmc6ICI4cHggMTJweCIsCiAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDgsCiAgICAgICAgICAgICAgICBtYXJnaW5Cb3R0b206IDEyLAogICAgICAgICAgICAgICAgYmFja2dyb3VuZENvbG9yOiBlbmpveVZvdGUgPT09ICJ1cCIgPyBgJHtDT0xPUlMyLmluY29tZX0xMGAgOiBgJHtDT0xPUlMyLmV4cGVuc2V9MTBgLAogICAgICAgICAgICAgICAgY29sb3I6IGVuam95Vm90ZSA9PT0gInVwIiA/IENPTE9SUzIuaW5jb21lIDogQ09MT1JTMi5leHBlbnNlLAogICAgICAgICAgICAgICAgZm9udFNpemU6IDEzLAogICAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgICAgICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgICAgICAgICAgICBnYXA6IDYKICAgICAgICAgICAgICB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgZW5qb3lWb3RlID09PSAidXAiID8gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoVGh1bWJzVXAsIHsgc2l6ZTogMTQgfSkgOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShUaHVtYnNEb3duLCB7IHNpemU6IDE0IH0pLAogICAgICAgICAgICAgICAgZW5qb3lWb3RlID09PSAidXAiID8gIkdsYWQgeW91J3JlIGVuam95aW5nIGl0ISIgOiAiU29ycnkgdG8gaGVhciB0aGF0LiIKICAgICAgICAgICAgICBdIH0pLAogICAgICAgICAgICAgIGZlZWRiYWNrU3RhdHVzID09PSAic3VjY2VzcyIgPyAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBwYWRkaW5nOiAxMiwgYm9yZGVyUmFkaXVzOiA4LCBiYWNrZ3JvdW5kQ29sb3I6IGAke0NPTE9SUzIuaW5jb21lfTEwYCwgY29sb3I6IENPTE9SUzIuaW5jb21lLCBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgdGV4dEFsaWduOiAiY2VudGVyIiB9LCBjaGlsZHJlbjogIlRoYW5rIHlvdSBmb3IgeW91ciBmZWVkYmFjayEiIH0pIDogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKGltcG9ydF9qc3hfcnVudGltZTIuRnJhZ21lbnQsIHsgY2hpbGRyZW46IFsKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKAogICAgICAgICAgICAgICAgICAidGV4dGFyZWEiLAogICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZlZWRiYWNrVGV4dCwKICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldEZlZWRiYWNrVGV4dChlLnRhcmdldC52YWx1ZSksCiAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI6IGVuam95Vm90ZSA9PT0gInVwIiA/ICJXaGF0IGRvIHlvdSBsaWtlIG1vc3Q/IEFueSBmZWF0dXJlcyB5b3UnZCBsb3ZlIHRvIHNlZT8iIDogZW5qb3lWb3RlID09PSAiZG93biIgPyAiV2hhdCB3ZW50IHdyb25nPyBIb3cgY2FuIHdlIGltcHJvdmU/IiA6ICJXaGF0IGNhbiB3ZSBpbXByb3ZlPyBCdWcgcmVwb3J0cywgZmVhdHVyZSByZXF1ZXN0cywgYW55dGhpbmcuLi4iLAogICAgICAgICAgICAgICAgICAgIGF1dG9Gb2N1czogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICByb3dzOiA0LAogICAgICAgICAgICAgICAgICAgIHN0eWxlOiB7IHdpZHRoOiAiMTAwJSIsIHBhZGRpbmc6ICIxMHB4IDEycHgiLCBib3JkZXJSYWRpdXM6IDgsIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsIGZvbnRTaXplOiAxNCwgZm9udEZhbWlseTogImluaGVyaXQiLCBvdXRsaW5lOiAibm9uZSIsIGJveFNpemluZzogImJvcmRlci1ib3giLCBtYXJnaW5Cb3R0b206IDgsIHJlc2l6ZTogInZlcnRpY2FsIiB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICBmZWVkYmFja1N0YXR1cyA9PT0gImVycm9yIiAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTIsIGNvbG9yOiBDT0xPUlMyLmV4cGVuc2UsIG1hcmdpbkJvdHRvbTogOCB9LCBjaGlsZHJlbjogIkZhaWxlZCB0byBzZW5kLiBQbGVhc2UgdHJ5IGFnYWluLiIgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiBoYW5kbGVGZWVkYmFja1N1Ym1pdCwgZGlzYWJsZWQ6IGZlZWRiYWNrU3RhdHVzID09PSAic3VibWl0dGluZyIgfHwgIWZlZWRiYWNrVGV4dC50cmltKCksIHN0eWxlOiB7CiAgICAgICAgICAgICAgICAgIHdpZHRoOiAiMTAwJSIsCiAgICAgICAgICAgICAgICAgIHBhZGRpbmc6ICIxMHB4IDE2cHgiLAogICAgICAgICAgICAgICAgICBib3JkZXJSYWRpdXM6IDgsCiAgICAgICAgICAgICAgICAgIGJvcmRlcjogIm5vbmUiLAogICAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIucHJpbWFyeSwKICAgICAgICAgICAgICAgICAgY29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgICAgICAgICAgIGZvbnRTaXplOiAxNCwKICAgICAgICAgICAgICAgICAgZm9udFdlaWdodDogNjAwLAogICAgICAgICAgICAgICAgICBjdXJzb3I6IGZlZWRiYWNrU3RhdHVzID09PSAic3VibWl0dGluZyIgfHwgIWZlZWRiYWNrVGV4dC50cmltKCkgPyAiZGVmYXVsdCIgOiAicG9pbnRlciIsCiAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IGZlZWRiYWNrU3RhdHVzID09PSAic3VibWl0dGluZyIgfHwgIWZlZWRiYWNrVGV4dC50cmltKCkgPyAwLjcgOiAxCiAgICAgICAgICAgICAgICB9LCBjaGlsZHJlbjogZmVlZGJhY2tTdGF0dXMgPT09ICJzdWJtaXR0aW5nIiA/ICJTZW5kaW5nLi4uIiA6ICJTdWJtaXQgRmVlZGJhY2siIH0pCiAgICAgICAgICAgICAgXSB9KQogICAgICAgICAgICBdCiAgICAgICAgICB9CiAgICAgICAgKQogICAgICB9CiAgICApLAogICAgc2hvd05hbWVCdWRnZXRNb2RhbCAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgKICAgICAgImRpdiIsCiAgICAgIHsKICAgICAgICBzdHlsZTogeyBwb3NpdGlvbjogImZpeGVkIiwgaW5zZXQ6IDAsIGJhY2tncm91bmRDb2xvcjogInJnYmEoMCwwLDAsMC40KSIsIGRpc3BsYXk6ICJmbGV4IiwgYWxpZ25JdGVtczogImNlbnRlciIsIGp1c3RpZnlDb250ZW50OiAiY2VudGVyIiwgekluZGV4OiAxZTMgfSwKICAgICAgICBvbkNsaWNrOiAoKSA9PiBzZXRTaG93TmFtZUJ1ZGdldE1vZGFsKGZhbHNlKSwKICAgICAgICBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKAogICAgICAgICAgImRpdiIsCiAgICAgICAgICB7CiAgICAgICAgICAgIHN0eWxlOiB7IGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5jYXJkLCBib3JkZXJSYWRpdXM6IDE2LCBwYWRkaW5nOiAyNCwgbWF4V2lkdGg6IDM4MCwgd2lkdGg6ICI5MCUiLCBib3hTaGFkb3c6ICIwIDhweCAzMHB4IHJnYmEoMCwwLDAsMC4xNSkiIH0sCiAgICAgICAgICAgIG9uQ2xpY2s6IChlKSA9PiBlLnN0b3BQcm9wYWdhdGlvbigpLAogICAgICAgICAgICBjaGlsZHJlbjogWwogICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3hzKSgiZGl2IiwgeyBzdHlsZTogeyBkaXNwbGF5OiAiZmxleCIsIGp1c3RpZnlDb250ZW50OiAic3BhY2UtYmV0d2VlbiIsIGFsaWduSXRlbXM6ICJjZW50ZXIiLCBtYXJnaW5Cb3R0b206IDE2IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiaDMiLCB7IHN0eWxlOiB7IG1hcmdpbjogMCwgZm9udFNpemU6IDE3LCBmb250V2VpZ2h0OiA3MDAsIGNvbG9yOiBDT0xPUlMyLnRleHRNYWluIH0sIGNoaWxkcmVuOiAiTmFtZSBZb3VyIEJ1ZGdldCIgfSksCiAgICAgICAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBzZXRTaG93TmFtZUJ1ZGdldE1vZGFsKGZhbHNlKSwgc3R5bGU6IHsgcGFkZGluZzogNCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmQ6ICJub25lIiwgY3Vyc29yOiAicG9pbnRlciIsIGNvbG9yOiBDT0xPUlMyLnRleHRNdXRlZCB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoWCwgeyBzaXplOiAxOCB9KSB9KQogICAgICAgICAgICAgIF0gfSksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgICAgICAgICAgICAiaW5wdXQiLAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICB2YWx1ZTogbmFtZUJ1ZGdldFZhbHVlLAogICAgICAgICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IHNldE5hbWVCdWRnZXRWYWx1ZShlLnRhcmdldC52YWx1ZSksCiAgICAgICAgICAgICAgICAgIG9uS2V5RG93bjogKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoZS5rZXkgPT09ICJFbnRlciIgJiYgbmFtZUJ1ZGdldFZhbHVlLnRyaW0oKSkgewogICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmFtZWQyID0geyAuLi5idWRnZXQsIG5hbWU6IG5hbWVCdWRnZXRWYWx1ZS50cmltKCkgfTsKICAgICAgICAgICAgICAgICAgICAgIHNldEJ1ZGdldChuYW1lZDIpOwogICAgICAgICAgICAgICAgICAgICAgc2V0TmFtZUlucHV0KG5hbWVCdWRnZXRWYWx1ZS50cmltKCkpOwogICAgICAgICAgICAgICAgICAgICAgZG9TYXZlQnVkZ2V0KG5hbWVkMik7CiAgICAgICAgICAgICAgICAgICAgICBzZXRTaG93TmFtZUJ1ZGdldE1vZGFsKGZhbHNlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyOiAiZS5nLiBNb250aGx5IEJ1ZGdldCwgSG91c2Vob2xkLCBTaWRlIEh1c3RsZSIsCiAgICAgICAgICAgICAgICAgIGF1dG9Gb2N1czogdHJ1ZSwKICAgICAgICAgICAgICAgICAgc3R5bGU6IHsgd2lkdGg6ICIxMDAlIiwgcGFkZGluZzogIjEwcHggMTJweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJ9YCwgZm9udFNpemU6IDE0LCBmb250RmFtaWx5OiAiaW5oZXJpdCIsIG91dGxpbmU6ICJub25lIiwgYm94U2l6aW5nOiAiYm9yZGVyLWJveCIsIG1hcmdpbkJvdHRvbTogMTIgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IGRpc3BsYXk6ICJmbGV4IiwgZ2FwOiA4LCBqdXN0aWZ5Q29udGVudDogImZsZXgtZW5kIiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoImJ1dHRvbiIsIHsgb25DbGljazogKCkgPT4gc2V0U2hvd05hbWVCdWRnZXRNb2RhbChmYWxzZSksIHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTZweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJ9YCwgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLCBmb250U2l6ZTogMTMsIGN1cnNvcjogInBvaW50ZXIiLCBjb2xvcjogQ09MT1JTMi50ZXh0U2Vjb25kYXJ5IH0sIGNoaWxkcmVuOiAiQ2FuY2VsIiB9KSwKICAgICAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IHsKICAgICAgICAgICAgICAgICAgY29uc3QgbmFtZSA9IG5hbWVCdWRnZXRWYWx1ZS50cmltKCkgfHwgIk15IEJ1ZGdldCI7CiAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWVkMiA9IHsgLi4uYnVkZ2V0LCBuYW1lIH07CiAgICAgICAgICAgICAgICAgIHNldEJ1ZGdldChuYW1lZDIpOwogICAgICAgICAgICAgICAgICBzZXROYW1lSW5wdXQobmFtZSk7CiAgICAgICAgICAgICAgICAgIGRvU2F2ZUJ1ZGdldChuYW1lZDIpOwogICAgICAgICAgICAgICAgICBzZXRTaG93TmFtZUJ1ZGdldE1vZGFsKGZhbHNlKTsKICAgICAgICAgICAgICAgIH0sIHN0eWxlOiB7IHBhZGRpbmc6ICI4cHggMTZweCIsIGJvcmRlclJhZGl1czogOCwgYm9yZGVyOiAibm9uZSIsIGJhY2tncm91bmRDb2xvcjogQ09MT1JTMi5wcmltYXJ5LCBjb2xvcjogIndoaXRlIiwgZm9udFNpemU6IDEzLCBmb250V2VpZ2h0OiA2MDAsIGN1cnNvcjogInBvaW50ZXIiIH0sIGNoaWxkcmVuOiAiU2F2ZSIgfSkKICAgICAgICAgICAgICBdIH0pCiAgICAgICAgICAgIF0KICAgICAgICAgIH0KICAgICAgICApCiAgICAgIH0KICAgICksCiAgICBzYXZlVG9hc3QgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7CiAgICAgIHBvc2l0aW9uOiAiZml4ZWQiLAogICAgICB0b3A6IDIwLAogICAgICBsZWZ0OiAiNTAlIiwKICAgICAgdHJhbnNmb3JtOiAidHJhbnNsYXRlWCgtNTAlKSIsCiAgICAgIHpJbmRleDogMTEwMCwKICAgICAgYmFja2dyb3VuZENvbG9yOiBDT0xPUlMyLnByaW1hcnksCiAgICAgIGNvbG9yOiAid2hpdGUiLAogICAgICBwYWRkaW5nOiAiMTBweCAyMHB4IiwKICAgICAgYm9yZGVyUmFkaXVzOiAxMiwKICAgICAgZm9udFNpemU6IDEzLAogICAgICBmb250V2VpZ2h0OiA2MDAsCiAgICAgIGJveFNoYWRvdzogIjAgNHB4IDE2cHggcmdiYSgwLDAsMCwwLjE1KSIsCiAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgIGdhcDogOCwKICAgICAgYW5pbWF0aW9uOiAiZmFkZUluT3V0IDEuNXMgZWFzZSIKICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKENoZWNrLCB7IHNpemU6IDE2IH0pLAogICAgICAiIEJ1ZGdldCBzYXZlZCEiCiAgICBdIH0pLAogICAgIWVuam95Vm90ZSAmJiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiZGl2IiwgeyBzdHlsZTogeyBwb3NpdGlvbjogImZpeGVkIiwgYm90dG9tOiAyMCwgcmlnaHQ6IHBpbGxSaWdodCwgekluZGV4OiA5MDAsIHBvaW50ZXJFdmVudHM6ICJub25lIiB9LCBjbGFzc05hbWU6ICJuby1wcmludCIsIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4cykoImRpdiIsIHsgc3R5bGU6IHsKICAgICAgcG9pbnRlckV2ZW50czogImF1dG8iLAogICAgICBiYWNrZ3JvdW5kQ29sb3I6IENPTE9SUzIuY2FyZCwKICAgICAgYm9yZGVyUmFkaXVzOiAyNCwKICAgICAgcGFkZGluZzogIjEwcHggMTZweCIsCiAgICAgIGJveFNoYWRvdzogIjAgNHB4IDIwcHggcmdiYSgwLDAsMCwwLjEyKSIsCiAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsCiAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgYWxpZ25JdGVtczogImNlbnRlciIsCiAgICAgIGdhcDogMTAKICAgIH0sIGNoaWxkcmVuOiBbCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJzcGFuIiwgeyBzdHlsZTogeyBmb250U2l6ZTogMTMsIGZvbnRXZWlnaHQ6IDYwMCwgY29sb3I6IENPTE9SUzIudGV4dE1haW4gfSwgY2hpbGRyZW46ICJFbmpveWluZyB0aGlzIGFwcD8iIH0pLAogICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KSgiYnV0dG9uIiwgeyBvbkNsaWNrOiAoKSA9PiBoYW5kbGVFbmpveVZvdGUoInVwIiksIHN0eWxlOiB7CiAgICAgICAgcGFkZGluZzogNiwKICAgICAgICBib3JkZXJSYWRpdXM6IDgsCiAgICAgICAgYm9yZGVyOiBgMXB4IHNvbGlkICR7Q09MT1JTMi5ib3JkZXJ9YCwKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6ICJ3aGl0ZSIsCiAgICAgICAgY3Vyc29yOiAicG9pbnRlciIsCiAgICAgICAgZGlzcGxheTogImZsZXgiLAogICAgICAgIGNvbG9yOiBDT0xPUlMyLmluY29tZQogICAgICB9LCBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoVGh1bWJzVXAsIHsgc2l6ZTogMTYgfSkgfSksCiAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMi5qc3gpKCJidXR0b24iLCB7IG9uQ2xpY2s6ICgpID0+IGhhbmRsZUVuam95Vm90ZSgiZG93biIpLCBzdHlsZTogewogICAgICAgIHBhZGRpbmc6IDYsCiAgICAgICAgYm9yZGVyUmFkaXVzOiA4LAogICAgICAgIGJvcmRlcjogYDFweCBzb2xpZCAke0NPTE9SUzIuYm9yZGVyfWAsCiAgICAgICAgYmFja2dyb3VuZENvbG9yOiAid2hpdGUiLAogICAgICAgIGN1cnNvcjogInBvaW50ZXIiLAogICAgICAgIGRpc3BsYXk6ICJmbGV4IiwKICAgICAgICBjb2xvcjogQ09MT1JTMi5leHBlbnNlCiAgICAgIH0sIGNoaWxkcmVuOiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTIuanN4KShUaHVtYnNEb3duLCB7IHNpemU6IDE2IH0pIH0pCiAgICBdIH0pIH0pLAogICAgc2hvd0xvZ2luTW9kYWwgJiYgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUyLmpzeCkoCiAgICAgIExvZ2luTW9kYWwsCiAgICAgIHsKICAgICAgICBvbkNsb3NlOiAoKSA9PiBzZXRTaG93TG9naW5Nb2RhbChmYWxzZSksCiAgICAgICAgb25Mb2dpblN1Y2Nlc3M6ICgpID0+IHsKICAgICAgICAgIHNldFNob3dMb2dpbk1vZGFsKGZhbHNlKTsKICAgICAgICB9CiAgICAgIH0KICAgICkKICBdIH0pOwp9CgovLyBzcmMvbWFpbi50c3gKdmFyIGltcG9ydF9qc3hfcnVudGltZTMgPSBfX3RvRVNNKHJlcXVpcmVfanN4X3J1bnRpbWUoKSwgMSk7CnZhciBFcnJvckJvdW5kYXJ5ID0gY2xhc3MgZXh0ZW5kcyBpbXBvcnRfcmVhY3Q1My5kZWZhdWx0LkNvbXBvbmVudCB7CiAgY29uc3RydWN0b3IocHJvcHMpIHsKICAgIHN1cGVyKHByb3BzKTsKICAgIHRoaXMuc3RhdGUgPSB7IGhhc0Vycm9yOiBmYWxzZSB9OwogIH0KICBzdGF0aWMgZ2V0RGVyaXZlZFN0YXRlRnJvbUVycm9yKGVycm9yKSB7CiAgICByZXR1cm4geyBoYXNFcnJvcjogdHJ1ZSwgZXJyb3IgfTsKICB9CiAgY29tcG9uZW50RGlkQ2F0Y2goZXJyb3IsIGVycm9ySW5mbykgewogICAgY29uc29sZS5lcnJvcigiV2lkZ2V0IEVycm9yIEJvdW5kYXJ5IGNhdWdodCBlcnJvcjoiLCBlcnJvciwgZXJyb3JJbmZvKTsKICAgIHRyeSB7CiAgICAgIGZldGNoKCIvYXBpL3RyYWNrIiwgewogICAgICAgIG1ldGhvZDogIlBPU1QiLAogICAgICAgIGhlYWRlcnM6IHsgIkNvbnRlbnQtVHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiB9LAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgIGV2ZW50OiAiY3Jhc2giLAogICAgICAgICAgZGF0YTogewogICAgICAgICAgICBlcnJvcjogZXJyb3I/Lm1lc3NhZ2UgfHwgIlVua25vd24gZXJyb3IiLAogICAgICAgICAgICBzdGFjazogZXJyb3I/LnN0YWNrLAogICAgICAgICAgICBjb21wb25lbnRTdGFjazogZXJyb3JJbmZvPy5jb21wb25lbnRTdGFjawogICAgICAgICAgfQogICAgICAgIH0pCiAgICAgIH0pLmNhdGNoKChlKSA9PiBjb25zb2xlLmVycm9yKCJGYWlsZWQgdG8gcmVwb3J0IGNyYXNoIiwgZSkpOwogICAgfSBjYXRjaCAoZSkgewogICAgfQogIH0KICByZW5kZXIoKSB7CiAgICBpZiAodGhpcy5zdGF0ZS5oYXNFcnJvcikgewogICAgICByZXR1cm4gLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUzLmpzeHMpKCJkaXYiLCB7IHN0eWxlOiB7IHBhZGRpbmc6IDIwLCB0ZXh0QWxpZ246ICJjZW50ZXIiLCBmb250RmFtaWx5OiAic2Fucy1zZXJpZiIsIGNvbG9yOiAiI0RDMjYyNiIsIHdvcmRCcmVhazogImJyZWFrLXdvcmQiIH0sIGNoaWxkcmVuOiBbCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUzLmpzeCkoImgzIiwgeyBjaGlsZHJlbjogIlNvbWV0aGluZyB3ZW50IHdyb25nLiIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUzLmpzeCkoInAiLCB7IGNoaWxkcmVuOiAiUGxlYXNlIHRyeSByZWZyZXNoaW5nIHRoZSBwYWdlLiIgfSksCiAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUzLmpzeHMpKCJkZXRhaWxzIiwgeyBzdHlsZTogeyBtYXJnaW5Ub3A6IDEwLCB0ZXh0QWxpZ246ICJsZWZ0IiwgZm9udFNpemU6ICIxMnB4IiwgY29sb3I6ICIjNjY2IiB9LCBjaGlsZHJlbjogWwogICAgICAgICAgLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUzLmpzeCkoInN1bW1hcnkiLCB7IGNoaWxkcmVuOiAiRGVidWcgRXJyb3IgRGV0YWlscyIgfSksCiAgICAgICAgICAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTMuanN4cykoInByZSIsIHsgc3R5bGU6IHsgd2hpdGVTcGFjZTogInByZS13cmFwIiwgYmFja2dyb3VuZDogIiNmNWY1ZjUiLCBwYWRkaW5nOiAxMCwgYm9yZGVyUmFkaXVzOiA0IH0sIGNoaWxkcmVuOiBbCiAgICAgICAgICAgIHRoaXMuc3RhdGUuZXJyb3I/LnRvU3RyaW5nKCksCiAgICAgICAgICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMy5qc3gpKCJiciIsIHt9KSwKICAgICAgICAgICAgdGhpcy5zdGF0ZS5lcnJvcj8uc3RhY2sKICAgICAgICAgIF0gfSkKICAgICAgICBdIH0pCiAgICAgIF0gfSk7CiAgICB9CiAgICByZXR1cm4gdGhpcy5wcm9wcy5jaGlsZHJlbjsKICB9Cn07CnZhciBnZXRIeWRyYXRpb25EYXRhID0gKCkgPT4gewogIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBTdGFydGluZyBoeWRyYXRpb24gY2hlY2suLi4iKTsKICBpZiAodHlwZW9mIHdpbmRvdyA9PT0gInVuZGVmaW5lZCIpIHsKICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBXaW5kb3cgaXMgdW5kZWZpbmVkIik7CiAgICByZXR1cm4ge307CiAgfQogIGNvbnN0IG9hID0gd2luZG93Lm9wZW5haTsKICBpZiAoIW9hKSB7CiAgICBjb25zb2xlLmxvZygiW0h5ZHJhdGlvbl0gd2luZG93Lm9wZW5haSBub3QgZm91bmQsIHJlbmRlcmluZyB3aXRoIGRlZmF1bHRzIik7CiAgICByZXR1cm4ge307CiAgfQogIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSB3aW5kb3cub3BlbmFpIGZvdW5kOiIsIE9iamVjdC5rZXlzKG9hKSk7CiAgY29uc3QgY2FuZGlkYXRlcyA9IFsKICAgIG9hLnRvb2xPdXRwdXQsCiAgICBvYS5zdHJ1Y3R1cmVkQ29udGVudCwKICAgIG9hLnJlc3VsdD8uc3RydWN0dXJlZENvbnRlbnQsCiAgICBvYS50b29sSW5wdXQKICBdOwogIGZvciAoY29uc3QgY2FuZGlkYXRlIG9mIGNhbmRpZGF0ZXMpIHsKICAgIGlmIChjYW5kaWRhdGUgJiYgdHlwZW9mIGNhbmRpZGF0ZSA9PT0gIm9iamVjdCIgJiYgT2JqZWN0LmtleXMoY2FuZGlkYXRlKS5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBGb3VuZCBkYXRhOiIsIGNhbmRpZGF0ZSk7CiAgICAgIHJldHVybiBjYW5kaWRhdGU7CiAgICB9CiAgfQogIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBObyBkYXRhIGZvdW5kIGluIGFueSBjYW5kaWRhdGUgc291cmNlIik7CiAgcmV0dXJuIHt9Owp9Owpjb25zb2xlLmxvZygiW01haW5dIE15IEJ1ZGdldCBtYWluLnRzeCBsb2FkaW5nLi4uIik7CmZ1bmN0aW9uIEFwcCh7IGluaXRpYWxEYXRhOiBpbml0aWFsRGF0YTIgfSkgewogIHJldHVybiAvKiBAX19QVVJFX18gKi8gKDAsIGltcG9ydF9qc3hfcnVudGltZTMuanN4KShNeUJ1ZGdldCwgeyBpbml0aWFsRGF0YTogaW5pdGlhbERhdGEyIH0pOwp9CnZhciBjb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibXktYnVkZ2V0LXJvb3QiKTsKaWYgKCFjb250YWluZXIpIHsKICB0aHJvdyBuZXcgRXJyb3IoIm15LWJ1ZGdldC1yb290IGVsZW1lbnQgbm90IGZvdW5kIik7Cn0KdmFyIHJvb3QgPSAoMCwgaW1wb3J0X2NsaWVudC5jcmVhdGVSb290KShjb250YWluZXIpOwp2YXIgcmVuZGVyQXBwID0gKGRhdGEpID0+IHsKICByb290LnJlbmRlcigKICAgIC8qIEBfX1BVUkVfXyAqLyAoMCwgaW1wb3J0X2pzeF9ydW50aW1lMy5qc3gpKGltcG9ydF9yZWFjdDUzLmRlZmF1bHQuU3RyaWN0TW9kZSwgeyBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUzLmpzeCkoRXJyb3JCb3VuZGFyeSwgeyBjaGlsZHJlbjogLyogQF9fUFVSRV9fICovICgwLCBpbXBvcnRfanN4X3J1bnRpbWUzLmpzeCkoQXBwLCB7IGluaXRpYWxEYXRhOiBkYXRhIH0sIERhdGUubm93KCkpIH0pIH0pCiAgKTsKfTsKdmFyIGluaXRpYWxEYXRhID0gZ2V0SHlkcmF0aW9uRGF0YSgpOwpyZW5kZXJBcHAoaW5pdGlhbERhdGEpOwp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigib3BlbmFpOnNldF9nbG9iYWxzIiwgKGV2KSA9PiB7CiAgY29uc3QgZ2xvYmFscyA9IGV2Py5kZXRhaWw/Lmdsb2JhbHM7CiAgaWYgKGdsb2JhbHMpIHsKICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBMYXRlIGV2ZW50IHJlY2VpdmVkOiIsIGdsb2JhbHMpOwogICAgY29uc3QgY2FuZGlkYXRlcyA9IFsKICAgICAgZ2xvYmFscy50b29sT3V0cHV0LAogICAgICBnbG9iYWxzLnN0cnVjdHVyZWRDb250ZW50LAogICAgICBnbG9iYWxzLnJlc3VsdD8uc3RydWN0dXJlZENvbnRlbnQsCiAgICAgIGdsb2JhbHMudG9vbElucHV0CiAgICBdOwogICAgZm9yIChjb25zdCBjYW5kaWRhdGUgb2YgY2FuZGlkYXRlcykgewogICAgICBpZiAoY2FuZGlkYXRlICYmIHR5cGVvZiBjYW5kaWRhdGUgPT09ICJvYmplY3QiICYmIE9iamVjdC5rZXlzKGNhbmRpZGF0ZSkubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBSZS1yZW5kZXJpbmcgd2l0aCBsYXRlIGRhdGE6IiwgY2FuZGlkYXRlKTsKICAgICAgICByZW5kZXJBcHAoY2FuZGlkYXRlKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICB9Cn0pOwp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigKICAibWVzc2FnZSIsCiAgKGV2ZW50KSA9PiB7CiAgICBpZiAoZXZlbnQuc291cmNlICE9PSB3aW5kb3cucGFyZW50KSByZXR1cm47CiAgICBjb25zdCBtZXNzYWdlID0gZXZlbnQuZGF0YTsKICAgIGlmICghbWVzc2FnZSB8fCBtZXNzYWdlLmpzb25ycGMgIT09ICIyLjAiKSByZXR1cm47CiAgICBpZiAobWVzc2FnZS5tZXRob2QgIT09ICJ1aS9ub3RpZmljYXRpb25zL3Rvb2wtcmVzdWx0IikgcmV0dXJuOwogICAgY29uc29sZS5sb2coIltIeWRyYXRpb25dIE1DUCBBcHBzIGJyaWRnZSB0b29sLXJlc3VsdCByZWNlaXZlZDoiLCBtZXNzYWdlLnBhcmFtcyk7CiAgICBjb25zdCB0b29sUmVzdWx0ID0gbWVzc2FnZS5wYXJhbXM7CiAgICBjb25zdCBkYXRhID0gdG9vbFJlc3VsdD8uc3RydWN0dXJlZENvbnRlbnQgPz8gdG9vbFJlc3VsdD8ucmVzdWx0Py5zdHJ1Y3R1cmVkQ29udGVudCA/PyB7fTsKICAgIGlmIChkYXRhICYmIHR5cGVvZiBkYXRhID09PSAib2JqZWN0IiAmJiBPYmplY3Qua2V5cyhkYXRhKS5sZW5ndGggPiAwKSB7CiAgICAgIGNvbnNvbGUubG9nKCJbSHlkcmF0aW9uXSBSZS1yZW5kZXJpbmcgd2l0aCBNQ1AgQXBwcyBicmlkZ2UgZGF0YToiLCBkYXRhKTsKICAgICAgcmVuZGVyQXBwKGRhdGEpOwogICAgfQogIH0sCiAgeyBwYXNzaXZlOiB0cnVlIH0KKTsKLyohIEJ1bmRsZWQgbGljZW5zZSBpbmZvcm1hdGlvbjoKCnJlYWN0L2Nqcy9yZWFjdC5kZXZlbG9wbWVudC5qczoKICAoKioKICAgKiBAbGljZW5zZSBSZWFjdAogICAqIHJlYWN0LmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnNjaGVkdWxlci9janMvc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogc2NoZWR1bGVyLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnJlYWN0LWRvbS9janMvcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogcmVhY3QtZG9tLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKICAoKioKICAgKiBDaGVja3MgaWYgYW4gZXZlbnQgaXMgc3VwcG9ydGVkIGluIHRoZSBjdXJyZW50IGV4ZWN1dGlvbiBlbnZpcm9ubWVudC4KICAgKgogICAqIE5PVEU6IFRoaXMgd2lsbCBub3Qgd29yayBjb3JyZWN0bHkgZm9yIG5vbi1nZW5lcmljIGV2ZW50cyBzdWNoIGFzIGBjaGFuZ2VgLAogICAqIGByZXNldGAsIGBsb2FkYCwgYGVycm9yYCwgYW5kIGBzZWxlY3RgLgogICAqCiAgICogQm9ycm93cyBmcm9tIE1vZGVybml6ci4KICAgKgogICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudE5hbWVTdWZmaXggRXZlbnQgbmFtZSwgZS5nLiAiY2xpY2siLgogICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGV2ZW50IGlzIHN1cHBvcnRlZC4KICAgKiBAaW50ZXJuYWwKICAgKiBAbGljZW5zZSBNb2Rlcm5penIgMy4wLjBwcmUgKEN1c3RvbSBCdWlsZCkgfCBNSVQKICAgKikKCnVzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUtc2hpbS5kZXZlbG9wbWVudC5qcwogICAqCiAgICogQ29weXJpZ2h0IChjKSBNZXRhIFBsYXRmb3JtcywgSW5jLiBhbmQgYWZmaWxpYXRlcy4KICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogICAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCnVzZS1zeW5jLWV4dGVybmFsLXN0b3JlL2Nqcy91c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltL3dpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiB1c2Utc3luYy1leHRlcm5hbC1zdG9yZS1zaGltL3dpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanMKICAgKgogICAqIENvcHlyaWdodCAoYykgTWV0YSBQbGF0Zm9ybXMsIEluYy4gYW5kIGFmZmlsaWF0ZXMuCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGUKICAgKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpkZWNpbWFsLmpzLWxpZ2h0L2RlY2ltYWwuanM6CiAgKCohIGRlY2ltYWwuanMtbGlnaHQgdjIuNS4xIGh0dHBzOi8vZ2l0aHViLmNvbS9NaWtlTWNsL2RlY2ltYWwuanMtbGlnaHQvTElDRU5DRSAqKQoKdXNlLXN5bmMtZXh0ZXJuYWwtc3RvcmUvY2pzL3VzZS1zeW5jLWV4dGVybmFsLXN0b3JlLXdpdGgtc2VsZWN0b3IuZGV2ZWxvcG1lbnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgUmVhY3QKICAgKiB1c2Utc3luYy1leHRlcm5hbC1zdG9yZS13aXRoLXNlbGVjdG9yLmRldmVsb3BtZW50LmpzCiAgICoKICAgKiBDb3B5cmlnaHQgKGMpIE1ldGEgUGxhdGZvcm1zLCBJbmMuIGFuZCBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKcmVhY3QvY2pzL3JlYWN0LWpzeC1ydW50aW1lLmRldmVsb3BtZW50LmpzOgogICgqKgogICAqIEBsaWNlbnNlIFJlYWN0CiAgICogcmVhY3QtanN4LXJ1bnRpbWUuZGV2ZWxvcG1lbnQuanMKICAgKgogICAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLgogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlCiAgICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL3NoYXJlZC9zcmMvdXRpbHMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9kZWZhdWx0QXR0cmlidXRlcy5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL0ljb24uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9jcmVhdGVMdWNpZGVJY29uLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvYXJyb3ctdXAtcmlnaHQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9idWlsZGluZy0yLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2hlY2suanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGV2cm9uLWRvd24uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9jaGV2cm9uLXVwLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2lyY2xlLWFsZXJ0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2lyY2xlLWNoZWNrLWJpZy5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2Nsb2NrLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvY2xvdWQtdXBsb2FkLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvZG9sbGFyLXNpZ24uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9ncmlwLXZlcnRpY2FsLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvaGVhcnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9ob3VzZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2xhbmRtYXJrLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbG9hZGVyLWNpcmNsZS5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL2xvY2suanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9sb2ctb3V0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvbWFpbC5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL21lc3NhZ2Utc3F1YXJlLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcGVuLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcGlnZ3ktYmFuay5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3BsdXMuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9wcmludGVyLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvcmVmcmVzaC1jdy5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3JvdGF0ZS1jY3cuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy9zYXZlLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvc2VhcmNoLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdGh1bWJzLWRvd24uanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90aHVtYnMtdXAuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy90cmFzaC0yLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdHJlbmRpbmctZG93bi5qczoKICAoKioKICAgKiBAbGljZW5zZSBsdWNpZGUtcmVhY3QgdjAuNTU0LjAgLSBJU0MKICAgKgogICAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIElTQyBsaWNlbnNlLgogICAqIFNlZSB0aGUgTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLgogICAqKQoKbHVjaWRlLXJlYWN0L2Rpc3QvZXNtL2ljb25zL3RyZW5kaW5nLXVwLmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vaWNvbnMvdHJpYW5nbGUtYWxlcnQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy93YWxsZXQuanM6CiAgKCoqCiAgICogQGxpY2Vuc2UgbHVjaWRlLXJlYWN0IHYwLjU1NC4wIC0gSVNDCiAgICoKICAgKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBJU0MgbGljZW5zZS4KICAgKiBTZWUgdGhlIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4KICAgKikKCmx1Y2lkZS1yZWFjdC9kaXN0L2VzbS9pY29ucy94LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCgpsdWNpZGUtcmVhY3QvZGlzdC9lc20vbHVjaWRlLXJlYWN0LmpzOgogICgqKgogICAqIEBsaWNlbnNlIGx1Y2lkZS1yZWFjdCB2MC41NTQuMCAtIElTQwogICAqCiAgICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgSVNDIGxpY2Vuc2UuCiAgICogU2VlIHRoZSBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuCiAgICopCiovCg==";
      const decodedScript = atob(encodedScript);
      const blob = new Blob([decodedScript], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      import(url)
        .catch(err => {
          console.error('[My Budget] Failed to load:', err);
          const root = document.getElementById('my-budget-root');
          if (root) {
            root.innerHTML = '<div style="padding:20px;text-align:center;font-family:sans-serif;color:#DC2626"><h3>Failed to load budget</h3><p>Please refresh the page.</p></div>';
          }
        });
    </script>
  </body>
</html>
